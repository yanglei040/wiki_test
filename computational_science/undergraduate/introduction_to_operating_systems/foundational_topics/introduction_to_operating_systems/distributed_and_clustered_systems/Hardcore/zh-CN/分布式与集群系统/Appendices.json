{
    "hands_on_practices": [
        {
            "introduction": "在构建分布式系统时，高效的数据序列化是决定整体性能的关键一环，尽管它常被忽视。此练习将引导你量化分析两种常见编码方式——人类可读的JSON和高效的二进制格式Protocol Buffers——之间的性能权衡。通过为CPU成本建立一个简单的数学模型，你将学会如何计算性能盈亏平衡点，从而理解在不同场景下选择合适数据格式的重要性。",
            "id": "3636323",
            "problem": "在一个分布式键值存储集群中，一个微服务必须对传入的远程过程调用（RPC）负载进行序列化和反序列化，每个负载包含 $n$ 个简单类型的标量字段。正在考虑两种备选编码方案：JavaScript 对象表示法（JSON）和 Protocol Buffers（Protobuf）。该服务运行在中央处理器（CPU）的单个专用核心上，时钟频率为 $3.2\\,\\text{GHz}$。假设工作负载是稳态的，系统是受 CPU 限制的（即网络和存储不是瓶颈），并且序列化过程中的计算和 I/O 没有并发重叠。\n\n将每条消息的 CPU 工作量建模为序列化和反序列化负载所需的 CPU 总周期数。假设每条消息的总周期数与 $n$ 呈仿射关系：\n- 对于 JavaScript 对象表示法（JSON）：$C_{\\mathrm{J}}(n) = \\alpha_{\\mathrm{J}} + \\gamma_{\\mathrm{J}}\\,n$。\n- 对于 Protocol Buffers（Protobuf）：$C_{\\mathrm{P}}(n) = \\alpha_{\\mathrm{P}} + \\gamma_{\\mathrm{P}}\\,n$。\n\n其中，$\\alpha_{\\mathrm{J}}$ 和 $\\alpha_{\\mathrm{P}}$ 是每条消息的固定周期成本（如模式处理、分配开销等），而 $\\gamma_{\\mathrm{J}}$ 和 $\\gamma_{\\mathrm{P}}$ 是反映编码和解码工作的每个字段的周期成本。假设在目标平台上的测量得出\n$\\alpha_{\\mathrm{J}} = 1.2 \\times 10^{5}$，$\\gamma_{\\mathrm{J}} = 1.6 \\times 10^{4}$，$\\alpha_{\\mathrm{P}} = 1.8 \\times 10^{5}$，以及 $\\gamma_{\\mathrm{P}} = 3.2 \\times 10^{3}$，单位均为 CPU 周期。\n\n仅使用关于吞吐量（单位时间内完成的工作量）和 CPU 时钟频率（单位时间内可用的周期数）的第一性原理，推导出两种编码方案下，以 $n$ 为函数的单核稳态吞吐量（单位：消息数/秒），然后确定两种吞吐量相等时的性能持平字段数 $n^{\\ast}$。请将最终的 $n^{\\ast}$ 表示为一个精确的简化分数；无需四舍五入。最终答案中不要包含任何单位。",
            "solution": "设 $f$ 为 CPU 时钟频率。在本例中，$f = 3.2\\,\\text{GHz} = 3.2 \\times 10^{9}$ 周期/秒。\n设 $C(n)$ 为处理一条包含 $n$ 个字段的消息所需的 CPU 周期数。\n吞吐量 $T(n)$（单位为消息数/秒）是每秒可用的总周期数除以每条消息所需的周期数。这个基本关系是：\n$$ T(n) = \\frac{f}{C(n)} $$\n此原理适用于任何受 CPU 限制的任务。\n\n我们现在可以推导每种编码的吞吐量函数。\n\n**1. JSON 的吞吐量**\n\nJSON 每条消息的成本由以下仿射函数给出：\n$$ C_{\\mathrm{J}}(n) = \\alpha_{\\mathrm{J}} + \\gamma_{\\mathrm{J}}\\,n $$\n将此代入通用吞吐量公式，得到 JSON 的吞吐量 $T_{\\mathrm{J}}(n)$：\n$$ T_{\\mathrm{J}}(n) = \\frac{f}{\\alpha_{\\mathrm{J}} + \\gamma_{\\mathrm{J}}\\,n} $$\n\n**2. Protobuf 的吞吐量**\n\n类似地，Protobuf 每条消息的成本是：\n$$ C_{\\mathrm{P}}(n) = \\alpha_{\\mathrm{P}} + \\gamma_{\\mathrm{P}}\\,n $$\nProtobuf 相应的吞吐量 $T_{\\mathrm{P}}(n)$ 是：\n$$ T_{\\mathrm{P}}(n) = \\frac{f}{\\alpha_{\\mathrm{P}} + \\gamma_{\\mathrm{P}}\\,n} $$\n\n**3. 性能持平点计算**\n\n性能持平字段数，记为 $n^{\\ast}$，是两种编码的吞吐量相等时的 $n$ 值：\n$$ T_{\\mathrm{J}}(n^{\\ast}) = T_{\\mathrm{P}}(n^{\\ast}) $$\n代入推导出的吞吐量表达式：\n$$ \\frac{f}{\\alpha_{\\mathrm{J}} + \\gamma_{\\mathrm{J}}\\,n^{\\ast}} = \\frac{f}{\\alpha_{\\mathrm{P}} + \\gamma_{\\mathrm{P}}\\,n^{\\ast}} $$\n由于时钟频率 $f$ 是一个正常数，我们可以令分母相等。这表明性能持平点出现在两种方法的每消息 CPU 周期成本相同时。\n$$ \\alpha_{\\mathrm{J}} + \\gamma_{\\mathrm{J}}\\,n^{\\ast} = \\alpha_{\\mathrm{P}} + \\gamma_{\\mathrm{P}}\\,n^{\\ast} $$\n现在，我们求解 $n^{\\ast}$。我们将包含 $n^{\\ast}$ 的项移到一边，常数项移到另一边：\n$$ \\gamma_{\\mathrm{J}}\\,n^{\\ast} - \\gamma_{\\mathrm{P}}\\,n^{\\ast} = \\alpha_{\\mathrm{P}} - \\alpha_{\\mathrm{J}} $$\n提出因子 $n^{\\ast}$：\n$$ (\\gamma_{\\mathrm{J}} - \\gamma_{\\mathrm{P}})\\,n^{\\ast} = \\alpha_{\\mathrm{P}} - \\alpha_{\\mathrm{J}} $$\n最后，分离出 $n^{\\ast}$ 得到符号解：\n$$ n^{\\ast} = \\frac{\\alpha_{\\mathrm{P}} - \\alpha_{\\mathrm{J}}}{\\gamma_{\\mathrm{J}} - \\gamma_{\\mathrm{P}}} $$\n该方程在 $\\gamma_{\\mathrm{J}} \\neq \\gamma_{\\mathrm{P}}$ 时有效，本例中该条件成立。\n\n**4. 数值计算**\n\n现在我们将给定的数值代入 $n^{\\ast}$ 的公式中：\n- $\\alpha_{\\mathrm{J}} = 1.2 \\times 10^{5}$\n- $\\gamma_{\\mathrm{J}} = 1.6 \\times 10^{4}$\n- $\\alpha_{\\mathrm{P}} = 1.8 \\times 10^{5}$\n- $\\gamma_{\\mathrm{P}} = 3.2 \\times 10^{3}$\n\n$$ n^{\\ast} = \\frac{(1.8 \\times 10^{5}) - (1.2 \\times 10^{5})}{(1.6 \\times 10^{4}) - (3.2 \\times 10^{3})} $$\n分别计算分子和分母：\n- 分子：$1.8 \\times 10^{5} - 1.2 \\times 10^{5} = (1.8 - 1.2) \\times 10^{5} = 0.6 \\times 10^{5} = 60,000$。\n- 分母：为了进行减法，我们使指数相同。$1.6 \\times 10^{4} = 16 \\times 10^{3}$。所以，$16 \\times 10^{3} - 3.2 \\times 10^{3} = (16 - 3.2) \\times 10^{3} = 12.8 \\times 10^{3} = 12,800$。\n\n现在，计算该分数：\n$$ n^{\\ast} = \\frac{60,000}{12,800} = \\frac{600}{128} $$\n为了得到简化分数，我们求 600 和 128 的最大公约数。\n- 两边同除以 4：$\\frac{150}{32}$\n- 两边同除以 2：$\\frac{75}{16}$\n数字 75 的质因数是 $3 \\times 5^2$，16 的质因数是 $2^4$。它们没有公因数，所以该分数已完全简化。\n$$ n^{\\ast} = \\frac{75}{16} $$\n性能持平点位于 $n^{\\ast} = 4.6875$。由于 JSON 的每字段成本较高（$\\gamma_{\\mathrm{J}} > \\gamma_{\\mathrm{P}}$）但固定成本较低（$\\alpha_{\\mathrm{J}}  \\alpha_{\\mathrm{P}}$），因此对于较小的 $n$（具体而言，当 $n  n^{\\ast}$ 时），JSON 会更快；而对于较大的 $n$（当 $n > n^{\\ast}$ 时），Protobuf 会更快。在 $n=5$ 时，Protobuf 将是更好的选择。问题要求的是精确的简化分数。",
            "answer": "$$\n\\boxed{\\frac{75}{16}}\n$$"
        },
        {
            "introduction": "当消息在网络中传输时，分布式系统必须能够优雅地处理不可预测的延迟和潜在的故障。本练习将向你展示一种构建健壮通信机制的核心技术：自适应超时。你将运用指数加权移动平均（EWMA）方法来动态估算网络往返时间（$RTT$），并计算出一个能在系统响应速度和避免不必要重传之间取得平衡的超时阈值。",
            "id": "3636314",
            "problem": "一个分布式集群中的服务使用远程过程调用（RPC）来协调任务。如果响应在超时之前未到达，系统将重新发送请求。为避免不必要的重试和过长的等待，系统会根据当前对网络往返时间（RTT）的估计自适应地设置超时。系统使用指数加权移动平均（EWMA）来估计 RTT 的均值和变异性，并将瞬时 RTT 建模为由排队、序列化和传播引起的许多独立延迟分量的总和。根据中心极限定理，瞬时 RTT 被建模为近似正态分布。\n\n在离散时间 $t$，设观测到的 RTT 样本为 $r_t$。EWMA 均值估计 $\\hat{r}_t$ 由核心递归平滑规则定义\n$$\n\\hat{r}_t = (1-\\alpha)\\,\\hat{r}_{t-1} + \\alpha\\, r_t,\n$$\n其中 $\\alpha \\in (0,1)$ 是平滑参数。为了估计离散程度，定义平方偏差的 EWMA $v_t$ 为\n$$\nv_t = (1-\\alpha)\\,v_{t-1} + \\alpha\\,\\big(r_t - \\hat{r}_{t-1}\\big)^{2},\n$$\n并将估计的标准差取为 $\\hat{\\sigma}_t = \\sqrt{v_t}$。\n\n假设在时间 $t=0$ 时，系统有初始均值估计 $\\hat{r}_0 = 18\\,\\mathrm{ms}$ 和初始方差估计 $v_0 = 9\\,\\mathrm{ms}^{2}$，并使用平滑参数 $\\alpha = 0.3$。在接下来的四次 RPC 中，它观测到 RTT 样本为\n$$\nr_1 = 21\\,\\mathrm{ms},\\quad r_2 = 15\\,\\mathrm{ms},\\quad r_3 = 24\\,\\mathrm{ms},\\quad r_4 = 18\\,\\mathrm{ms}.\n$$\n\n集群操作员要求，在使用当前 EWMA 估计值作为参数的正态模型下，单个 RTT 样本仅因随机变异而超过超时的概率（“错误超时”）必须为每次尝试 $\\beta = 0.01$。超时被设置为在当前时间 $t=4$ 满足此要求的最小值。\n\n仅使用这些基础，计算在 $t=4$ 时的超时数值。您的最终答案以毫秒表示，并四舍五入到四位有效数字。",
            "solution": "该问题要求基于对网络往返时间（RTT）的统计估计，计算远程过程调用（RPC）的自适应超时。该问题提法明确，具有科学依据，并包含得出唯一解所需的所有信息。我们将首先迭代计算 RTT 均值和方差的指数加权移动平均（EWMA），然后使用这些估计值来确定满足指定错误超时概率的超时值。\n\n在时间 $t=0$ 给定的初始条件是：\n- 初始均值估计：$\\hat{r}_0 = 18\\,\\mathrm{ms}$\n- 初始方差估计：$v_0 = 9\\,\\mathrm{ms}^{2}$\n- 平滑参数：$\\alpha = 0.3$\n\n在时间 $t$ 更新估计值的递归规则是：\n- 均值估计：$\\hat{r}_t = (1-\\alpha)\\,\\hat{r}_{t-1} + \\alpha\\, r_t$\n- 方差估计：$v_t = (1-\\alpha)\\,v_{t-1} + \\alpha\\,\\big(r_t - \\hat{r}_{t-1}\\big)^{2}$\n- 标准差估计：$\\hat{\\sigma}_t = \\sqrt{v_t}$\n\n观测到的 RTT 样本为 $r_1 = 21\\,\\mathrm{ms}$，$r_2 = 15\\,\\mathrm{ms}$，$r_3 = 24\\,\\mathrm{ms}$ 和 $r_4 = 18\\,\\mathrm{ms}$。我们计算 $t=1, 2, 3, 4$ 时的估计值。为清晰起见，我们注意到 $1-\\alpha = 1 - 0.3 = 0.7$。所有时间单位均为毫秒（$\\mathrm{ms}$），方差单位为 $\\mathrm{ms}^2$。\n\n**步骤 1：计算 $t=1$ 时的估计值**\n使用样本 $r_1 = 21$：\n$$\n\\hat{r}_1 = (1-\\alpha)\\hat{r}_0 + \\alpha r_1 = (0.7)(18) + (0.3)(21) = 12.6 + 6.3 = 18.9\n$$\n$$\nv_1 = (1-\\alpha)v_0 + \\alpha(r_1 - \\hat{r}_0)^2 = (0.7)(9) + (0.3)(21 - 18)^2 = 6.3 + 0.3(3^2) = 6.3 + 2.7 = 9.0\n$$\n\n**步骤 2：计算 $t=2$ 时的估计值**\n使用样本 $r_2 = 15$ 和 $t=1$ 时的估计值：\n$$\n\\hat{r}_2 = (1-\\alpha)\\hat{r}_1 + \\alpha r_2 = (0.7)(18.9) + (0.3)(15) = 13.23 + 4.5 = 17.73\n$$\n$$\nv_2 = (1-\\alpha)v_1 + \\alpha(r_2 - \\hat{r}_1)^2 = (0.7)(9.0) + (0.3)(15 - 18.9)^2 = 6.3 + 0.3(-3.9)^2 = 6.3 + 0.3(15.21) = 6.3 + 4.563 = 10.863\n$$\n\n**步骤 3：计算 $t=3$ 时的估计值**\n使用样本 $r_3 = 24$ 和 $t=2$ 时的估计值：\n$$\n\\hat{r}_3 = (1-\\alpha)\\hat{r}_2 + \\alpha r_3 = (0.7)(17.73) + (0.3)(24) = 12.411 + 7.2 = 19.611\n$$\n$$\nv_3 = (1-\\alpha)v_2 + \\alpha(r_3 - \\hat{r}_2)^2 = (0.7)(10.863) + (0.3)(24 - 17.73)^2 = 7.6041 + 0.3(6.27)^2 = 7.6041 + 0.3(39.3129) \\approx 7.6041 + 11.7939 = 19.398\n$$\n为获得更高精度，我们保留更多位数：$v_3 = 7.6041 + 11.79387 = 19.39797$。\n\n**步骤 4：计算 $t=4$ 时的估计值**\n使用样本 $r_4 = 18$ 和 $t=3$ 时的估计值：\n$$\n\\hat{r}_4 = (1-\\alpha)\\hat{r}_3 + \\alpha r_4 = (0.7)(19.611) + (0.3)(18) = 13.7277 + 5.4 = 19.1277\n$$\n$$\nv_4 = (1-\\alpha)v_3 + \\alpha(r_4 - \\hat{r}_3)^2 = (0.7)(19.39797) + (0.3)(18 - 19.611)^2 = 13.578579 + 0.3(-1.611)^2 = 13.578579 + 0.3(2.595321) \\approx 13.578579 + 0.778596 = 14.357175\n$$\n在时间 $t=4$ 时，最终估计的均值和方差为：\n$$\n\\hat{r}_4 = 19.1277\\,\\mathrm{ms}\n$$\n$$\nv_4 = 14.357175\\,\\mathrm{ms}^2\n$$\n相应的标准差为：\n$$\n\\hat{\\sigma}_4 = \\sqrt{v_4} = \\sqrt{14.357175} \\approx 3.789086\\,\\mathrm{ms}\n$$\n\n**步骤 5：计算超时**\n瞬时 RTT，我们称之为随机变量 $R$，被建模为以 $t=4$ 时估计的参数为参数的正态分布。因此，$R \\sim \\mathcal{N}(\\mu, \\sigma^2)$，其中 $\\mu = \\hat{r}_4$ 且 $\\sigma = \\hat{\\sigma}_4$。\n超时 $T_o$ 的设置必须使错误超时的概率为 $\\beta = 0.01$。这意味着观测到的 RTT $R$ 超过 $T_o$ 的概率为 $0.01$：\n$$\nP(R  T_o) = \\beta = 0.01\n$$\n为了找到 $T_o$，我们将变量 $R$ 标准化。令 $Z = \\frac{R-\\mu}{\\sigma}$ 为一个标准正态随机变量，$Z \\sim \\mathcal{N}(0, 1)$。\n$$\nP\\left(\\frac{R-\\mu}{\\sigma}  \\frac{T_o-\\mu}{\\sigma}\\right) = P\\left(Z  \\frac{T_o-\\mu}{\\sigma}\\right) = 0.01\n$$\n我们需要从标准正态分布中找到临界值 $z_{0.01}$，使得 $P(Z  z_{0.01}) = 0.01$。这个值对应于分布的第 $99$ 百分位数，因为 $P(Z \\le z_{0.01}) = 1 - 0.01 = 0.99$。查阅标准正态分布表或使用计算工具，我们发现：\n$$\nz_{0.01} \\approx 2.3263\n$$\n超时 $T_o$ 由以下方程确定：\n$$\n\\frac{T_o - \\mu}{\\sigma} = z_{0.01}\n$$\n$$\nT_o = \\mu + z_{0.01} \\sigma = \\hat{r}_4 + z_{0.01} \\hat{\\sigma}_4\n$$\n代入计算出的 $\\hat{r}_4$ 和 $\\hat{\\sigma}_4$ 的值：\n$$\nT_o = 19.1277 + (2.3263) \\times (\\sqrt{14.357175})\n$$\n$$\nT_o \\approx 19.1277 + (2.3263) \\times (3.789086)\n$$\n$$\nT_o \\approx 19.1277 + 8.8150\n$$\n$$\nT_o \\approx 27.9427\\,\\mathrm{ms}\n$$\n问题要求结果四舍五入到四位有效数字。数值 $27.9427$ 四舍五入到四位有效数字是 $27.94$。",
            "answer": "$$\\boxed{27.94}$$"
        },
        {
            "introduction": "在解决了单点通信的性能与可靠性问题后，我们将视野扩展到整个集群范围内的信息传播。Gossip协议（或称“闲聊协议”）为大规模系统提供了一种极具弹性和可扩展性的信息同步方式。通过这个练习，你将从第一性原理出发，分析Gossip协议在稳态下的网络带宽消耗，从而深入理解其在大型集群中的可扩展性特征。",
            "id": "3636305",
            "problem": "考虑一个运行“流言”反熵协议的 $N$ 个节点的集群。时间被划分为长度为 $P$ 秒的周期。在每个周期内，每个节点独立地与从其他 $N-1$ 个节点中均匀随机选择的一个对等节点发起一次反熵会话（不允许选择自身）。每次反熵会话包含一次大小为 $g$ 字节的摘要的双向交换：每个参与者发送一个大小为 $g$ 字节的摘要，并从其对等节点接收一个大小为 $g$ 字节的摘要。假设除了摘要有效载荷外，头部和控制流量可以忽略不计，没有重试，并且两个节点在同一周期内互相选择会导致两次独立的会话。假设会话在它们被发起的同一周期内完成，并且节点间的发起是相互独立的。\n\n仅使用带宽作为单位时间字节数的基本定义以及独立伯努利试验的期望线性性质，从第一性原理推导预期的稳态：\n\n- 单节点聚合带宽（每秒发送和接收的字节总和），以及\n- 集群范围的网络吞吐量（每秒在网络链路上发送的总字节数，每次摘要在网络中传输时只计算一次），\n\n用 $N$、$g$ 和 $P$ 表示。答案以字节/秒为单位表示。将最终结果表示为一个单行向量，其中第一个条目是单节点聚合带宽，第二个条目是集群范围的吞吐量。无需进行数值代入；请以符号形式表示最终答案。",
            "solution": "目标是根据协议行为导致字节传输的速率来计算预期带宽。\n\n带宽定义为单位时间的字节数。因此，如果一个实体在每个长度为 $P$ 的周期内传输的预期字节数为 $B_{\\text{period}}$，则其预期带宽为 $B_{\\text{period}}/P$。\n\n我们分析两个量：\n\n1. 预期的单节点聚合带宽，即单个节点发送和接收的字节总和。\n2. 预期的集群范围吞吐量，即所有节点在网络链路上发送的字节总和（每次摘要传输只计算一次）。\n\n我们从单节点分析开始。在每个周期内，每个节点都恰好发起一次会话。此外，其他节点可能会发起以该节点为目标的会话。\n\n让我们固定一个节点，并用随机变量 $X$ 表示在一个周期内传入会话（由其他以该节点为目标的节点发起）的数量。对于其他每个节点（共有 $N-1$ 个这样的节点），定义指示随机变量 $I_{i}$，$i \\in \\{1,2,\\ldots,N-1\\}$，其中如果该节点选择我们固定的节点作为其对等节点，则 $I_{i} = 1$，否则 $I_{i} = 0$。因为每个节点都从 $N-1$ 个可能的对等节点中均匀选择，并且选择是相互独立的，\n$$\n\\Pr(I_{i} = 1) = \\frac{1}{N-1}.\n$$\n因此，$X = \\sum_{i=1}^{N-1} I_{i}$，并且根据期望的线性性质，\n$$\n\\mathbb{E}[X] = \\sum_{i=1}^{N-1} \\mathbb{E}[I_{i}] = \\sum_{i=1}^{N-1} \\frac{1}{N-1} = 1.\n$$\n因此，在期望中，一个节点除了自己发起的 $1$ 次会话外，每个周期还会接收 $1$ 次传入会话，所以每个周期它预期总共参与 $1 + 1 = 2$ 次会话。\n\n每次会话都是双向的：该节点发送一个大小为 $g$ 字节的摘要，并接收一个大小为 $g$ 字节的摘要。因此，每次会话中计入该节点的聚合字节数（发送加接收）为 $2g$。由于每个周期预期有 $2$ 次会话，因此每个周期内单节点的预期聚合字节数为\n$$\nB_{\\text{node, period}} = 2 \\times 2g = 4g.\n$$\n除以周期长度 $P$ 以获得速率，即可得到预期的单节点聚合带宽：\n$$\nB_{\\text{node}} = \\frac{4g}{P}.\n$$\n\n接下来，我们计算集群范围的网络吞吐量，每次摘要在网络中传输时只计算一次。每个周期内恰好有 $N$ 次发起的会话，因为每个节点都会发起一次会话。每次会话在网络上产生两次摘要传输，每个方向一次，因此每次会话总共传输 $2g$ 字节。因此，在一个周期内网络上传输的预期总字节数为\n$$\nB_{\\text{cluster, period}} = N \\times 2g = 2gN.\n$$\n除以 $P$ 得到集群范围的吞吐量：\n$$\nB_{\\text{cluster}} = \\frac{2gN}{P}.\n$$\n\n综合这两个表达式，单节点聚合带宽为 $\\frac{4g}{P}$，集群范围的吞吐量为 $\\frac{2gN}{P}$，单位均为字节/秒。",
            "answer": "$$\\boxed{\\begin{pmatrix}\\frac{4g}{P}  \\frac{2gN}{P}\\end{pmatrix}}$$"
        }
    ]
}