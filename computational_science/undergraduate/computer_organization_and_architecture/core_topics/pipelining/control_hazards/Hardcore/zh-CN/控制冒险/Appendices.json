{
    "hands_on_practices": [
        {
            "introduction": "要掌握控制冒险，第一步是能够量化其影响。这个练习提供了一个经典的场景：在一个标准的五级 RISC 流水线中，使用一个简单的静态分支预测器来执行一个循环。通过这个练习，你将亲手计算一次分支误预测所带来的确切惩罚周期，从而深刻理解当处理器走错路径时，时间是如何被浪费的，以及流水线冲刷（pipeline flush）的底层机制。",
            "id": "3630214",
            "problem": "一个单发射的五级精简指令集计算机 (RISC) 流水线在取指令 (IF)、指令译码 (ID)、执行 (EX)、访存 (MEM) 和写回 (WB) 阶段执行指令。控制相关通过一个静态分支预测器来处理，该预测器总是预测分支为“taken”（发生跳转）。一个分支目标缓冲器 (BTB) 在 IF 阶段提供预测为“taken”的目标地址，因此当预测正确时，指令获取会从目标地址继续进行，不会产生停顿。分支条件在 EX 阶段被解析。一旦发生预测错误，流水线中所有较新的指令都会被清空，并且在下一个周期，取指操作将被重定向到正确的路径。系统中沒有架构级的分支延迟槽，没有在 EX 阶段之前的提前目标地址或条件解析，也没有其他结构性冒险或数据冒险。\n\n考虑一个紧凑循环，其循环体以一个构成循环返回边的单一条件后向分支结束。该循环执行 $n \\geq 1$ 次迭代，其中前 $n-1$ 次迭代中分支结果为“taken”（跳转），而在第 $n$ 次迭代时为“not taken”（不跳转）以退出循环。在上述总是预测跳转的预测器下，唯一的预测错误发生在最后一次迭代中，即当分支实际不跳转时。假設循环体内沒有其他分支。\n\n仅使用上述关于流水线分段和分支处理的基本原理，确定每个完整循环（即横跨全部 $n$ 次迭代）所付出的总控制冒险惩罚（以周期为单位）。请将你的答案表示为单个精确的整数周期数，并使用“周期”作为解释单位（最终的方框答案中不要包含单位）。无需四舍五入。",
            "solution": "首先验证问题以确保其是自洽的、有科学依据且定义良好的。\n\n### 步骤1：提取已知条件\n- **流水线结构**：一个单发射、五级 RISC 流水线，包含以下阶段：取指令 (IF)、指令译码 (ID)、执行 (EX)、访存 (MEM) 和写回 (WB)。\n- **分支处理**：\n    - **预测器**：静态分支预测器，总是预测分支为“taken”（跳转）。\n    - **分支目标缓冲器 (BTB)**：在 IF 阶段提供预测为“taken”的目标地址。\n    - **正确预测**：当“taken”预测正确时，没有停顿。\n    - **解析**：分支条件在 EX 阶段被解析。\n    - **预测错误**：发生预测错误时，所有较新的指令被清空，取指在下一个周期被重定向。\n- **排除项**：没有架构级的分支延迟槽，没有在 EX 阶段之前的提前解析，也没有其他结构性或数据冒险。\n- **场景**：一个执行 $n \\geq 1$ 次迭代的紧凑循环。\n- **循环分支**：循环体末尾的一个单一条件后向分支。\n- **分支结果**：\n    - 在前 $n-1$ 次迭代中，分支为“taken”（跳转）。\n    - 在第 $n$ 次（最后一次）迭代中，分支为“not taken”（不跳转）。\n- **目标**：确定一次完整循环执行（即横跨所有 $n$ 次迭代）的总控制冒险惩罚（以周期为单位）。\n\n### 步骤2：使用提取的已知条件进行验证\n- **科学依据**：问题描述了一个经典的五级 RISC 流水线，这是计算机组成与体系结构中的一个标准教学模型。静态分支预测、BTB 功能、流水线清空以及在 EX 阶段进行分支解析等概念都是基本且符合事实的原理。\n- **良定性**：问题定义清晰。它提供了流水线和分支处理机制的所有必要参数，以计算一个特定的、唯一的惩罚数值。\n- **客观性**：问题使用了计算机体系结构领域的精确、标准术语陈述，没有任何主观性或模糊性。\n\n### 步骤3：结论与行动\n该问题是有效的，因为它具有科学性、良定性、客观性和自洽性。可以根据给定的信息推导出确定的解。\n\n### 解题推导\n\n整个循环的总控制冒险惩罚是每次分支执行所产生的惩罚之和。该循环包含一个分支，执行 $n$ 次。我们必须分析这 $n$ 次执行中每一次的惩罚。\n\n该分支预测器是一个静态的“总是预测跳转”预测器。我们针对两种分支结果来评估其性能。\n\n1.  **前 $n-1$ 次迭代（正确预测的分支）**\n    对于前 $n-1$ 次迭代，后向分支发生跳转以继续循环。\n    - **预测**：总是跳转 (Always-Taken)。\n    - **实际结果**：跳转 (Taken)。\n    - **结果**：预测正确。\n    问题陈述指明“当预测正确时，指令获取会从目标地址继续进行，不会产生停顿。”这意味着每次正确预测的惩罚是 $0$ 个周期。\n    前 $n-1$ 次迭代的总惩罚是 $(n-1) \\times 0 = 0$ 个周期。\n\n2.  **第 $n$ 次迭代（预测错误的分支）**\n    在最后一次迭代中，分支不发生跳转，以退出循环。\n    - **预测**：总是跳转 (Always-Taken)。\n    - **实际结果**：不跳转 (Not-Taken)。\n    - **结果**：预测不正确，导致一次预测错误。产生了一次惩罚。\n\n为了计算预测错误的惩罚，我们必须分析流水线的状态。分支指令的结果在 EX 阶段确定。EX 阶段是5级流水线中的第3个阶段。\n\n设分支指令为 $B$。\n- **周期 $t$**：$B$ 处于 IF 阶段。预测器将其识别为分支并预测为“taken”。分支目标缓冲器 (BTB) 提供目标地址，程序计数器 (PC) 更新为此目标地址。\n- **周期 $t+1$**：$B$ 进入 ID 阶段。来自（错误）预测的目标路径的第一条指令，我们称之为 $I_1$，进入 IF 阶段。\n- **周期 $t+2$**：$B$ 进入 EX 阶段。$I_1$ 进入 ID 阶段。来自错误路径的第二条指令 $I_2$ 进入 IF 阶段。在此周期结束时，EX 单元解析该分支，发现它实际未跳转。预测错误。\n\n在检测到预测错误的那一刻（周期 $t+2$ 结束时），以下位于流水线中的、较新的推测执行指令必须被清空：\n- 处于 ID 阶段的指令 $I_1$。\n- 处于 IF 阶段的指令 $I_2$。\n\n这两条指令被丢弃。用于获取和译码它们所花费的 CPU 时间被浪费了。问题指出，取指操作在下一个周期（即周期 $t+3$）被重定向到正确的路径。在周期 $t+3$ 中，流水线将获取分支指令之后正确的顺序指令 $B+1$。\n\n惩罚是指因在错误路径上获取和处理指令而损失的周期数。这类指令的数量对应于分支解析阶段之前的流水线阶段数量。\n- 分支解析阶段：EX（第3阶段）。\n- 前面的阶段：IF（第1阶段）和 ID（第2阶段）。\n在 EX 阶段之前有 $2$ 个阶段。因此，有 $2$ 条指令被错误地获取且必须被清空。这导致了一个 $2$ 个周期的流水线气泡。\n\n单次预测错误的惩罚是 $2$ 个周期。\n\n**总惩罚计算**\n\n整个循环执行的总惩罚是所有 $n$ 次分支执行的惩罚之和。\n$$ \\text{Total Penalty} = \\left( (n-1) \\times \\text{Penalty}_{\\text{correct prediction}} \\right) + \\left( 1 \\times \\text{Penalty}_{\\text{misprediction}} \\right) $$\n代入计算出的值：\n$$ \\text{Total Penalty} = \\left( (n-1) \\times 0 \\right) + \\left( 1 \\times 2 \\right) $$\n$$ \\text{Total Penalty} = 0 + 2 = 2 $$\n每个完整循环所付出的总控制冒险惩罚是 $2$ 个周期，与迭代次数 $n$ (对于 $n \\geq 1$) 无关。",
            "answer": "$$\\boxed{2}$$"
        },
        {
            "introduction": "静态预测过于简单，现代处理器依赖于更智能的动态分支预测器。本练习将带你分析一种最常见的动态预测器——2位饱和计数器。与计算单次误预测的固定惩罚不同，此题要求你分析预测器在面对一个重复出现的分支结果序列时的长期行为和稳态误预测率。这对于理解和评估不同预测器设计的有效性至关重要。",
            "id": "3630181",
            "problem": "一台流水线处理器采用一个双模 $2$-位饱和计数器分支预测器，该预测器只有一个预测条目，专用于单个静态分支。该预测器有 $4$ 个状态，标记为 $0$、$1$、$2$ 和 $3$。对于状态 $2$ 和 $3$，它预测为“跳转”（taken）；对于状态 $0$ 和 $1$，它预测为“不跳转”（not-taken）。对于每个分支结果，如果结果为“跳转”，状态加 $1$；如果结果为“不跳转”，状态减 $1$，分别在 $3$ 和 $0$ 处饱和。预测器的初始状态是任意的。考虑该分支的一个重复结果模式，该模式由 $(k-2)$ 个连续的“跳转”结果和紧随其后的 $2$ 个连续的“不跳转”结果组成，周期为 $k$（其中 $k \\ge 2$）。令 $m(k)$ 表示稳态误预测率，其定义为：在预测器针对此重复序列达到其周期性行为后，一个周期内的误预测总数除以周期长度 $k$。推导 $m(k)$ 作为 $k$ 的函数，并将最终答案表示为单个封闭形式的解析表达式。无需四舍五入。答案是无量纲的。",
            "solution": "题目要求计算对于一个重复的分支结果模式，一个特定的 $2$-位双模分支预测器的稳态误预测率 $m(k)$。分析过程需要确定预测器状态的周期性行为，并计算该周期内的误预测次数。\n\n首先，我们来形式化地描述这个 $2$-位饱和计数器的模型。\n预测器的状态 $S$ 可以是四个值之一：$S \\in \\{0, 1, 2, 3\\}$。\n预测规则如下：\n- 如果 $S \\in \\{0, 1\\}$，预测“不跳转”（NT）。\n- 如果 $S \\in \\{2, 3\\}$，预测“跳转”（T）。\n\n状态转换规则如下：给定当前状态 $S$ 和分支结果 $O$，新的状态为 $S'$：\n- 如果结果 $O$ 为“跳转”（T），新状态为 $S' = \\min(S+1, 3)$。\n- 如果结果 $O$ 为“不跳转”（NT），新状态为 $S' = \\max(S-1, 0)$。\n\n当预测结果与实际结果 $O$ 不匹配时，发生误预测。\n\n分支结果模式是一个周期为 $k \\ge 2$ 的序列，由 $(k-2)$ 个连续的“跳转”结果和其后 $2$ 个连续的“不跳转”结果组成。模式为 $(\\underbrace{\\text{T}, \\text{T}, \\dots, \\text{T}}_{k-2 \\text{ 次}}, \\text{NT}, \\text{NT})$。\n\n我们关心的是稳态误预测率 $m(k)$，即稳定周期中一个周期内的误预测次数除以周期长度 $k$。为了找到这个值，我们必须首先确定预测器进入的状态重复周期。设 $S_0$ 为稳态下一个周期开始时的状态。经过 $k$ 个分支后，状态必须返回到 $S_0$。我们将周期内第 $i$ 个分支后的状态记为 $S_i$。稳态条件是 $S_k = S_0$。我们通过考虑 $k$ 的不同取值情况来分析这个问题。\n\n### 情况 1：$k=2$\n模式周期为 $k=2$。它由 $(2-2)=0$ 个“跳转”结果和 $2$ 个“不跳转”结果组成。模式为 (NT, NT)。\n这个结果序列会使计数器状态趋向于 $0$。让我们假设系统已达到稳态，此时必然有 $S_0=0$。\n- 从 $S_0=0$ 开始。预测为 NT。第一个结果是 NT。这是一个**正确**的预测。新状态为 $S_1 = \\max(0-1, 0) = 0$。\n- 状态为 $S_1=0$。预测为 NT。第二个结果是 NT。这是一个**正确**的预测。新状态为 $S_2 = \\max(0-1, 0) = 0$。\n最终状态为 $S_2=0$，与起始状态 $S_0=0$ 相等。因此，稳态周期是一个恒定状态 $S=0$。\n此周期内的误预测次数为 $0$。\n误预测率为 $m(2) = \\frac{0}{2} = 0$。\n\n### 情况 2：$k=3$\n模式周期为 $k=3$。它由 $(3-2)=1$ 个“跳转”结果和 $2$ 个“不跳转”结果组成。模式为 (T, NT, NT)。\n该模式中 NT 的数量多于 T，这表明稳态将处于一个低值的状态。让我们测试从 $S_0=0$ 开始的稳态周期。\n- 从 $S_0=0$ 开始。预测为 NT。第一个结果是 T。这是一个**误预测**。新状态为 $S_1 = \\min(0+1, 3) = 1$。\n- 状态为 $S_1=1$。预测为 NT。第二个结果是 NT。这是一个**正确**的预测。新状态为 $S_2 = \\max(1-1, 0) = 0$。\n- 状态为 $S_2=0$。预测为 NT。第三个结果是 NT。这是一个**正确**的预测。新状态为 $S_3 = \\max(0-1, 0) = 0$。\n最终状态 $S_3=0$，与起始状态 $S_0=0$ 相等。这是一个稳定周期。\n此周期内的误预测次数为 $1$。\n误预测率为 $m(3) = \\frac{1}{3}$。\n\n### 情况 3：$k \\ge 4$\n模式周期为 $k$，由 $(k-2)$ 个“跳转”结果和 $2$ 个“不跳转”结果组成。\n让我们找到稳态的起始状态 $S_0$。一个周期后的状态 $S_k$ 是 $S_0$ 和 $k$ 的函数。经过 $(k-2)$ 个“跳转”分支后，状态变为 $S' = \\min(S_0 + k - 2, 3)$。再经过随后的 $2$ 个“不跳转”分支后，最终状态为 $S_k = \\max(S' - 2, 0) = \\max(\\min(S_0 + k - 2, 3) - 2, 0)$。\n对于稳态，必须有 $S_k = S_0$。\n让我们假设计数器在“跳转”序列期间达到饱和，即 $S_0 + k - 2 \\ge 3$，这意味着 $S_0 \\ge 5-k$。如果这个条件成立，那么 $S' = 3$。关于 $S_0$ 的方程变为 $S_0 = \\max(3-2, 0) = 1$。\n这个解 $S_0=1$ 是自洽的，前提是它满足假设 $S_0 \\ge 5-k$。代入 $S_0=1$，我们得到 $1 \\ge 5-k$，可简化为 $k \\ge 4$。\n因此，对于所有 $k \\ge 4$，存在一个从状态 $S_0=1$ 开始的稳态周期。（对于 $k=4$，也存在另一个从 $S_0=0$ 开始的周期，但两者都产生相同的误预测数 $3$）。\n让我们对 $k \\ge 4$ 的情况，从 $S_0=1$ 开始追踪一个周期的执行过程：\n- 第一个结果是 T。状态为 $S_0=1$（预测 NT）。这是一个**误预测**。新状态为 $S_1 = \\min(1+1, 3) = 2$。\n- 第二个结果是 T。状态为 $S_1=2$（预测 T）。这是一个**正确**的预测。新状态为 $S_2 = \\min(2+1, 3) = 3$。\n- 对于随后的 $(k-2)-2 = k-4$ 个“跳转”结果，状态保持为 $S=3$（预测 T）。这些都是**正确**的预测。在所有 $(k-2)$ 个“跳转”结果之后，状态为 $S_{k-2}=3$。\n- 第 $(k-1)$ 个结果是 NT。状态为 $S_{k-2}=3$（预测 T）。这是一个**误预测**。新状态为 $S_{k-1} = \\max(3-1, 0) = 2$。\n- 第 $k$ 个结果是 NT。状态为 $S_{k-1}=2$（预测 T）。这是一个**误预测**。新状态为 $S_k = \\max(2-1, 0) = 1$。\n最终状态为 $S_k=1$，与起始状态 $S_0=1$ 相等。这证实了稳定周期的存在。\n一个周期内的总误预测次数是每一步误预测次数的总和：$1 + 0 + 1 + 1 = 3$。\n对于 $k \\ge 4$，误预测率为 $m(k) = \\frac{3}{k}$。\n\n### 结果总结\n结合所有情况的结果，稳态误预测率 $m(k)$ 是一个关于 $k$ 的分段函数：\n$$\nm(k) = \\begin{cases} 0  \\text{如果 } k=2 \\\\ \\frac{1}{k}  \\text{如果 } k=3 \\\\ \\frac{3}{k}  \\text{如果 } k \\ge 4 \\end{cases}\n$$\n注意，对于 $k=3$，表达式 $1/k$ 的值为 $1/3$，符合要求。",
            "answer": "$$\n\\boxed{\n\\begin{cases} 0  k=2 \\\\ \\frac{1}{k}  k=3 \\\\ \\frac{3}{k}  k \\ge 4 \\end{cases}\n}\n$$"
        },
        {
            "introduction": "除了硬件预测，我们能否从根本上消除分支，从而彻底避免控制冒险？这个高级练习探讨了一种强大的编译器技术——条件执行（predication）。它将一个 `if-else` 分支结构转化为一条无分支的指令序列，通过执行两条路径上的所有指令，来换取控制流的完全可预测性。通过计算动态预测和条件执行两种策略的性能“盈亏平衡点”，你将学会如何在不同的设计选择之间进行权衡，甚至考虑到像寄存器压力增加这样的二级效应。",
            "id": "3630253",
            "problem": "一个标量、顺序执行的五级流水线，包含取指、译码、执行、访存和写回五个阶段，用于运行一个if-else代码块。条件分支在执行阶段进行解析，当预测错误时，会产生 $b$ 个周期的流水线冲刷惩罚。动态分支预测器的稳态准确率为 $a$，因此预测错误的概率为 $1-a$。假设为单发射执行，无结构性冒险，且在没有停顿的情况下，每条非访存指令需要 $1$ 个周期。\n\n考虑一个简短的if-else代码块，其“then”路径包含 $L_{t}$ 条算术或逻辑指令，“else”路径包含 $L_{f}$ 条算术或逻辑指令。条件评估本身需要一条比较指令。在动态分支预测下，还会执行一条分支指令。在谓词执行（if-conversion）下，比较指令设置一个谓词，分支指令被消除；谓词执行形式会执行“then”和“else”两条路径中的所有指令。\n\nIf-conversion增加了活跃范围（live ranges），需要比基准寄存器分配器容量多 $r$ 个额外寄存器。在谓词执行版本中，这 $r$ 个寄存器会被溢出（spill），每次溢出导致在代码块前有一次存储（store）操作，在代码块后有一次加载（load）操作。假设每次溢出访存操作都在一级数据缓存（L1）中命中，并产生 $c$ 个周期的有效成本，该成本包含任何停顿和流水线效应。基准的分支版本不需要这额外的 $r$ 个寄存器，因此没有溢出成本。\n\n使用动态预测和谓词执行下控制流的期望执行时间的第一性原理，以及上述架构模型，推导出一个解析表达式，表示分支采纳概率阈值 $p^{\\star}$。在此阈值下，谓词执行版本的期望周期数与动态预测分支版本的期望周期数相等。你的表达式必须是关于 $L_{t}$、$L_{f}$、$a$、$b$、$c$ 和 $r$ 的封闭形式函数。你可以假设 $L_{t} \\neq L_{f}$。将你的最终答案表示为单个无单位的解析表达式。不要对答案进行四舍五入。",
            "solution": "问题陈述经评估有效。它在科学上基于计算机体系结构的原理，特别是控制流机制的性能分析。问题定义明确、客观、自洽，没有矛盾或模糊之处。推导所需的所有必要参数均以符号形式给出。\n\n目标是推导出一个分支采纳概率阈值 $p^{\\star}$ 的解析表达式，在该阈值下，动态预测分支实现的期望执行周期数等于谓词执行（if-conversion）实现的期望执行周期数。\n\n设 $E_B$ 为分支版本的期望周期数，$E_P$ 为谓词执行版本的周期数。阈值 $p^{\\star}$ 是当 $E_B = E_P$ 时，分支采纳概率 $p$ 的值。\n\n首先，我们确定谓词执行版本的周期数 $E_P$。\n在谓词执行版本中，分支指令被消除。“then”和“else”两条路径的所有指令都会被取指和执行，其结果根据谓词的值被提交或取消。\n该代码块内执行的总指令数为：\n- $1$ 条比较指令。\n- 来自“then”路径的 $L_t$ 条指令。\n- 来自“else”路径的 $L_f$ 条指令。\n由于每条非访存指令需要 $1$ 个周期，这些指令的周期数为 $1 + L_t + L_f$。\n\n此外，谓词执行版本需要 $r$ 个额外的寄存器，这些寄存器会被溢出到内存中。每次溢出包含代码块前的一次存储指令和代码块后的一次加载指令。因溢出而产生的总访存操作数为 $2r$。每次访存操作产生 $c$ 个周期的有效成本。\n因此，寄存器溢出的总成本为 $2rc$。\n\n谓词执行版本的总周期数是指令执行周期数和溢出成本之和：\n$$E_P = (1 + L_t + L_f) + 2rc$$\n\n接下来，我们确定动态预测分支版本的期望周期数 $E_B$。该成本取决于分支采纳概率 $p$ 和分支预测器的准确率 $a$。\n此版本中的代码块包含：\n- $1$ 条比较指令。\n- 来自“then”或“else”路径的指令。\n- $1$ 条分支指令。\n\n如果分支被采纳（概率为 $p$），则执行 $L_t$ 条指令。此路径的总指令数为 $1 + L_t + 1 = L_t + 2$。\n如果分支未被采纳（概率为 $1-p$），则执行 $L_f$ 条指令。此路径的总指令数为 $1 + L_f + 1 = L_f + 2$。\n\n执行指令数的期望值是这两个结果的加权平均值：\n$$E[\\text{instructions}] = p(L_t + 2) + (1-p)(L_f + 2)$$\n展开并简化此表达式：\n$$E[\\text{instructions}] = pL_t + 2p + L_f + 2 - pL_f - 2p = p(L_t - L_f) + L_f + 2$$\n\n除了指令执行外，我们还必须考虑分支预测错误导致的流水线停顿惩罚。问题陈述指出预测器的准确率为 $a$，因此预测错误概率为 $1-a$。一次预测错误会产生 $b$ 个周期的惩罚。只要预测不正确，无论分支是否被采纳，都会施加此惩罚。\n预测错误的期望周期惩罚是预测错误概率乘以惩罚值：\n$$E[\\text{penalty}] = (1-a)b$$\n\n分支版本的总期望周期数是期望指令周期数和期望惩罚之和：\n$$E_B = E[\\text{instructions}] + E[\\text{penalty}] = p(L_t - L_f) + L_f + 2 + b(1-a)$$\n\n为了找到阈值概率 $p^{\\star}$，我们令成本相等：当 $p = p^{\\star}$ 时，$E_B = E_P$。\n$$p^{\\star}(L_t - L_f) + L_f + 2 + b(1-a) = 1 + L_t + L_f + 2rc$$\n\n现在，我们求解 $p^{\\star}$。我们首先分离包含 $p^{\\star}$ 的项。\n$$p^{\\star}(L_t - L_f) = (1 + L_t + L_f + 2rc) - (L_f + 2 + b(1-a))$$\n我们可以消去括号内容两侧的 $L_f$ 项：\n$$p^{\\star}(L_t - L_f) = 1 + L_t + 2rc - 2 - b(1-a)$$\n$$p^{\\star}(L_t - L_f) = L_t - 1 + 2rc - b(1-a)$$\n\n问题陈述 $L_t \\neq L_f$，这保证了 $(L_t - L_f) \\neq 0$。因此，我们可以除以 $(L_t - L_f)$ 来得到 $p^{\\star}$ 的最终表达式：\n$$p^{\\star} = \\frac{L_t - 1 + 2rc - b(1-a)}{L_t - L_f}$$\n\n这就是在两种控制流策略性能相同时，分支采纳概率阈值的解析表达式。",
            "answer": "$$\\boxed{\\frac{L_t - 1 + 2rc - b(1-a)}{L_t - L_f}}$$"
        }
    ]
}