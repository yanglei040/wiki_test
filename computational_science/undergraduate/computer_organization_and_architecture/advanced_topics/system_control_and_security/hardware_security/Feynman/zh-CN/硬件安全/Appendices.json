{
    "hands_on_practices": [
        {
            "introduction": "硬件操作的执行时间本身就可能成为一个安全漏洞。此实践探讨了时间侧信道攻击的基本原理，攻击者通过精确测量计算所需时间来推断敏感数据。为了抵御此类攻击，一个核心对策是采用“恒定时间”设计，确保操作的执行时间与处理的秘密数据无关。通过这个练习 ，你将亲手计算为实现恒定时间设计所需付出的性能开销，从而将抽象的安全概念与具体的硬件成本联系起来。",
            "id": "3645417",
            "problem": "您正在设计一个恒定时间整数除法器，以消除通过时序侧信道（TSC）产生的时序泄漏。现有的除法器实现了一种微架构优化：对于任何非零的 $w$ 位除数 $d$，可写作 $d = 2^{t} m$，其中 $m$ 为奇数，而 $t \\in \\{0,1,\\dots,w-1\\}$ 是 $d$ 的二进制表示中尾随零的数量。经优化的除法器为每个尾随零节省固定的 $\\delta$ 个周期，因此其完成时间为 $C_{\\text{gen}} - \\delta t$ 个周期，其中 $C_{\\text{gen}}$ 是没有优化时的基准通用路径的周期数。为强制实现恒定时间操作，您需要对优化的情况填充 $\\delta t$ 个周期，以使每次除法都花费 $C_{\\text{gen}}$ 个周期，从而确保没有关于 $t$ 的信息通过时序泄漏。\n\n假设秘密除数 $d$ 在非零 $w$ 位整数集合 $\\{1,2,\\dots,2^{w}-1\\}$ 上均匀分布，并且永远不会发生除以零的情况。请从第一性原理出发（基于非零 $w$ 位整数集合的计数论证，以及除以 $2^{t}$ 对应于右移 $t$ 位的算术性质），推导在这种均衡方案下每次除法所需填充周期的期望值的精确闭式表达式，该表达式应以 $w$ 和 $\\delta$ 表示。然后，对 $w = 32$ 和 $\\delta = 1$ 的情况计算该表达式的值。请将最终答案表示为单个精确的有理数（单位为周期）。请勿进行近似或四舍五入。",
            "solution": "问题要求计算使优化的整数除法器以恒定时间运行所需的填充周期的期望值。对于一个给定的非零 $w$ 位除数 $d$，填充周期数为 $\\delta t$，其中 $\\delta$ 是一个常数，$t$ 是 $d$ 的二进制表示中尾随零的数量。假设除数 $d$ 在非零 $w$ 位整数集合 $\\{1, 2, \\dots, 2^w-1\\}$ 上均匀分布。\n\n首先，我们将问题形式化。设 $D$ 是表示除数的随机变量，它在样本空间 $\\Omega = \\{1, 2, \\dots, 2^w - 1\\}$ 上均匀分布。样本空间的大小为 $|\\Omega| = 2^w - 1$。任何特定除数 $d \\in \\Omega$ 的概率为 $\\mathbb{P}(D=d) = \\frac{1}{2^w - 1}$。\n\n设 $t(d)$ 是将除数 $d$ 映射到其尾随零数量的函数。除数 $d$ 的填充周期数是一个随机变量 $P(d) = \\delta \\cdot t(d)$。我们需要求这些填充周期的期望值 $E[P]$。\n\n根据离散随机变量期望值的定义，我们有：\n$$E[P] = \\sum_{d \\in \\Omega} P(d) \\cdot \\mathbb{P}(D=d)$$\n代入给定值：\n$$E[P] = \\sum_{d=1}^{2^w-1} \\delta \\cdot t(d) \\cdot \\frac{1}{2^w - 1}$$\n我们可以提出常数项 $\\delta$ 和 $\\frac{1}{2^w-1}$：\n$$E[P] = \\frac{\\delta}{2^w - 1} \\sum_{d=1}^{2^w-1} t(d)$$\n问题的核心是计算从 $1$ 到 $2^w-1$ 的所有整数的尾随零总和 $S = \\sum_{d=1}^{2^w-1} t(d)$。\n\n整数 $d$ 的尾随零数量 $t(d)$ 是能整除 $d$ 的 $2$ 的最高次幂。也就是说，$d$ 可被 $2^{t(d)}$ 整除，但不能被 $2^{t(d)+1}$ 整除。另一种表述是 $t(d) = \\sum_{k=1}^{\\infty} [2^k | d]$，其中 $[2^k|d]$ 是一个指示函数，如果 $2^k$ 整除 $d$ 则为 $1$，否则为 $0$。一个有 $t$ 个尾随零的整数 $d$ 对 $2^1$ 的倍数计数贡献 $1$，对 $2^2$ 的倍数计数贡献 $1$，...，一直到对 $2^t$ 的倍数计数贡献 $1$。\n\n利用这一见解，我们可以通过改变求和顺序来重新表示和 $S$。我们可以不对每个 $d$ 的尾随零数量求和，而是对 $2$ 的幂次求和，并对每个幂次 $2^k$ 计算集合 $\\Omega$ 中有多少个数能被它整除。\n$$S = \\sum_{d=1}^{2^w-1} t(d) = \\sum_{d=1}^{2^w-1} \\sum_{k=1}^{w-1} [2^k | d]$$\n在 $\\Omega$ 中能整除一个数的 $2$ 的最大幂次是 $2^{w-1}$（它能整除 $2^{w-1}$ 本身），因此对 $k$ 的求和可以在 $w-1$ 处终止。\n交换求和顺序后：\n$$S = \\sum_{k=1}^{w-1} \\sum_{d=1}^{2^w-1} [2^k | d]$$\n内层和 $\\sum_{d=1}^{2^w-1} [2^k|d]$ 就是集合 $\\{1, 2, \\dots, 2^w-1\\}$ 中 $2^k$ 的倍数的数量。这个数量由 $\\lfloor \\frac{2^w-1}{2^k} \\rfloor$ 给出。\n\n让我们分析这一项。对于任何整数 $k \\ge 1$，我们可以写出：\n$$\\lfloor \\frac{2^w-1}{2^k} \\rfloor = \\lfloor \\frac{2^w}{2^k} - \\frac{1}{2^k} \\rfloor = \\lfloor 2^{w-k} - 2^{-k} \\rfloor$$\n由于 $k \\ge 1$，所以 $0  < 2^{-k} \\le \\frac{1}{2}$。因此，$2^{w-k} - 2^{-k}$ 不是一个整数，其向下取整为 $2^{w-k} - 1$。\n所以，集合中 $2^k$ 的倍数的数量是 $2^{w-k}-1$。\n\n现在我们可以计算和 $S$：\n$$S = \\sum_{k=1}^{w-1} (2^{w-k}-1) = \\left(\\sum_{k=1}^{w-1} 2^{w-k}\\right) - \\left(\\sum_{k=1}^{w-1} 1\\right)$$\n第二项就是 $w-1$。\n对于第一项，我们可以进行换元。设 $j = w-k$。当 $k$ 从 $1$ 变化到 $w-1$ 时，$j$ 从 $w-1$ 变化到 $1$。\n$$\\sum_{k=1}^{w-1} 2^{w-k} = \\sum_{j=1}^{w-1} 2^j = (2^1 + 2^2 + \\dots + 2^{w-1})$$\n这是一个首项 $a=2$，公比 $r=2$，共有 $n=w-1$ 项的等比数列。其和为 $a\\frac{r^n-1}{r-1} = 2\\frac{2^{w-1}-1}{2-1} = 2(2^{w-1}-1) = 2^w - 2$。\n\n将这些结果代回 $S$ 的表达式中：\n$$S = (2^w-2) - (w-1) = 2^w - 2 - w + 1 = 2^w - w - 1$$\n\n现在我们将这个和代回到填充周期期望值的公式中：\n$$E[P] = \\frac{\\delta}{2^w - 1} (2^w - w - 1)$$\n这就是所求的、以 $w$ 和 $\\delta$ 表示的填充周期期望值的精确闭式表达式。\n\n题目接着要求计算当 $w=32$ 和 $\\delta=1$ 时该表达式的值。\n代入这些值：\n$$E[P] = \\frac{1 \\cdot (2^{32} - 32 - 1)}{2^{32} - 1} = \\frac{2^{32} - 33}{2^{32} - 1}$$\n这是一个符合要求的精确有理数。我们也可以将其写作：\n$$E[P] = \\frac{(2^{32} - 1) - 32}{2^{32} - 1} = 1 - \\frac{32}{2^{32} - 1}$$\n这种形式表明，填充周期的期望值略小于 $1$ 个周期。$\\frac{2^{32}-33}{2^{32}-1}$ 的形式是一个单个的有理数。",
            "answer": "$$\\boxed{\\frac{2^{32}-33}{2^{32}-1}}$$"
        },
        {
            "introduction": "除了时间维度，共享的微架构状态是另一类主要的硬件安全隐患。此练习将焦点转向分支预测器，这是一个现代处理器中常见的性能优化单元，但其共享状态也可能在不同安全域之间泄漏信息。为了解决这个问题，关键的防御措施是“隔离”，即为每个安全域提供独立的硬件资源副本。这个实践  要求你量化实现这种隔离机制所需的额外存储开销，让你深入理解在硬件层面实现安全隔离所涉及的成本权衡。",
            "id": "3645422",
            "problem": "现代乱序处理器使用由分支预测引导的推测执行。在基线设计中，预测器维护一个单一的分支历史表（BHT），该表定义为一个由程序计数器的低位比特索引的数组，其中每个条目是一个用于预测分支方向的饱和计数器。跨域交互可能产生微架构侧信道，其中在一个安全域中学到的预测器状态会影响另一个安全域中的预测行为，这可能违反信息流安全中的非干涉原则。硬件安全中一种广泛使用的缓解措施是跨域隔离预测器状态，从而使预测器行为不会将信息从一个域携带到另一个域。\n\n考虑以下隔离机制：处理器为每个安全域维护一个独立的BHT（即每个安全域一个BHT），并在操作系统更改安全域时，根据域标识符切换活动的BHT。假设如下：\n- 基线预测器使用一个包含 $H$ 个条目的单一BHT。\n- 每个BHT条目存储一个 $2$ 比特的饱和计数器（这是分支预测中一个经过充分测试的标准）。\n- 在隔离设计中，有 $D$ 个安全域，每个域都有自己的BHT，包含 $H$ 个条目，每个条目同样使用 $2$ 比特的饱和计数器。\n- 处理器还维护一个域标识符寄存器，该寄存器使用足够的比特来编码当前域，以表示所有 $D$ 个域。\n- 忽略所有非存储开销（例如，组合选择逻辑、导线以及除域标识符寄存器之外的控制触发器）。只将存储阵列和域标识符寄存器中存储的比特计为存储空间。\n\n基于以上定义和非干涉的安全目标，推导并以 $H$ 和 $D$ 的单闭式解析表达式形式，表示隔离设计相对于基线设计的总存储开销。请用比特表示您的最终答案。不要进行任何数值代入。不要四舍五入；返回精确的符号表达式。",
            "solution": "问题陈述是连贯且有效的。它在科学上基于计算机体系结构和信息流安全的原理，特别解决了分支预测器中的侧信道攻击问题。该问题设定良好，提供了推导唯一解析解所需的所有必要定义和变量。它是客观的，没有歧义或矛盾。\n\n目标是推导出一个隔离分支预测器设计相对于基线设计的总存储开销的表达式。开销定义为隔离设计所需的额外存储空间，以比特为单位。\n\n设 $S_{baseline}$ 为基线设计的总存储空间（以比特为单位）。\n设 $S_{isolated}$ 为隔离设计的总存储空间（以比特为单位）。\n存储开销 $S_{overhead}$ 则定义为：\n$$S_{overhead} = S_{isolated} - S_{baseline}$$\n\n首先，我们计算基线设计的存储空间 $S_{baseline}$。基线设计包含一个单一的分支历史表（BHT）。\n- BHT 有 $H$ 个条目。\n- 每个条目是一个 $2$ 比特的饱和计数器。\n基线BHT的总存储空间是条目数与每个条目大小（以比特计）的乘积。\n$$S_{baseline} = H \\times 2$$\n\n接下来，我们计算隔离设计的存储空间 $S_{isolated}$。问题指明该设计包括两个必须计算存储空间的组件：每个域的BHT和一个域标识符寄存器。\n1.  **BHT的存储空间：**\n    - 有 $D$ 个安全域。\n    - 每个域都有一个专用的BHT，包含 $H$ 个条目。\n    - 每个BHT中的每个条目都是一个 $2$ 比特的饱和计数器。\n    所有 $D$ 个BHT的总存储空间是域的数量、每个BHT的条目数以及每个条目大小的乘积。\n    $$S_{BHTs\\_isolated} = D \\times H \\times 2 = 2DH$$\n\n2.  **域标识符寄存器的存储空间：**\n    - 该寄存器必须编码当前的安全域，共有 $D$ 个。\n    - 为了表示 $D$ 个不同的状态，所需的最小比特数（记为 $k$）必须满足不等式 $2^k \\ge D$。\n    - 解出 $k$ 可得 $k \\ge \\log_2(D)$。由于比特数必须是整数，我们取该值的向上取整。\n    - 因此，域标识符寄存器的存储空间为：\n    $$S_{register} = \\lceil \\log_2(D) \\rceil$$\n\n隔离设计的总存储空间 $S_{isolated}$ 是BHT的存储空间和域标识符寄存器的存储空间之和。\n$$S_{isolated} = S_{BHTs\\_isolated} + S_{register} = 2DH + \\lceil \\log_2(D) \\rceil$$\n\n最后，我们通过从隔离设计的存储空间中减去基线设计的存储空间来计算存储开销 $S_{overhead}$。\n$$S_{overhead} = S_{isolated} - S_{baseline}$$\n$$S_{overhead} = \\left( 2DH + \\lceil \\log_2(D) \\rceil \\right) - (2H)$$\n重新整理各项并提取公因式 $2H$，得到最终的开销闭式表达式：\n$$S_{overhead} = 2DH - 2H + \\lceil \\log_2(D) \\rceil$$\n$$S_{overhead} = 2H(D-1) + \\lceil \\log_2(D) \\rceil$$\n该表达式表示隔离设计所需的总额外存储空间（以比特为单位），用BHT条目数 $H$ 和安全域数 $D$ 表示。",
            "answer": "$$\\boxed{2H(D-1) + \\lceil \\log_{2}(D) \\rceil}$$"
        },
        {
            "introduction": "安全决策的影响往往超越单个硬件单元，并体现在整个系统层面。本实践探讨了操作系统和硬件协同实施的安全策略，例如为了防止翻译后备缓冲器（TLB）的跨域信息泄漏而限制大页（huge pages）的使用。虽然这类策略能增强安全性，但通常会带来性能上的代价。通过完成这个练习 ，你将模拟评估一个安全策略对系统性能的具体影响，通过计算TLB未命中数量的变化，学习如何分析安全决策在真实世界中的性能后果。",
            "id": "3645354",
            "problem": "一位系统设计师正在加固一个多道程序、64位系统，以防止在使用巨页时通过共享的转换检测缓冲区（TLB）条目发生跨域泄露。考虑一个单个乱序核心，它对两个安全域（域A和域B）进行时间切分，其中域A以1毫秒的时间量运行。为实现隔离，操作系统强制执行以下安全策略：禁用1GB页面，仅允许每个域的私有区域使用2MB页面，使用4KB页面映射任何在多个域中可见的区域，并且由于未使用进程上下文标识符（PCID），在每次域切换时刷新所有TLB结构。\n\n假设域A在运行时具有以下硬件配置和工作负载属性：\n- 数据转换检测缓冲区（DTLB）按页面大小分区，并且在每个分区中都是全相联的，采用理想的最近最少使用（LRU）替换策略。它有$E_{4\\mathrm{K}} = 256$个用于4KB页面的条目，$E_{2\\mathrm{M}} = 64$个用于2MB页面的条目，以及$E_{1\\mathrm{G}} = 8$个用于1GB页面的条目。根据安全策略，1GB页面被禁用。\n- 域A在其时间片内的数据足迹包括一个大小为$S_{2\\mathrm{M}} = 256$兆字节的私有热点区域（根据安全策略，有资格使用2MB页面），以及一个大小为$S_{4\\mathrm{K}} = 4$兆字节的共享只读热点区域（必须用4KB页面映射）。每个区域内的访问是均匀随机的。针对私有区域的数据引用比例为$p = 0.8$，针对共享区域的比例为$1 - p$。\n- 该核心以$f = 3.0$吉赫兹的频率运行，平均每个周期退役$r = 2.5$条指令，并且每条退役指令执行$\\alpha = 0.4$次数据内存引用。每次数据内存引用都需要一次DTLB转换。\n\n采用所述的安全策略，通过计算域A在每1毫秒时间片内产生的DTLB未命中预期数量，来评估避免使用共享巨页对TLB行为的影响。假设在每个时间片的开始会发生一次TLB刷新。陈述您使用的任何与文献中经过充分测试的模型一致的建模假设，并将您的推导建立在第一性原理之上，例如工作集基数、页面数量以及针对均匀随机引用的简单概率。\n\n以“每毫秒未命中数”为单位表示最终答案，并将答案四舍五入到4位有效数字。",
            "solution": "所述问题是有效的、自洽的，并与计算机体系结构和性能分析的既定原则一致。我们可以着手计算域A在其时间片内的数据转换检测缓冲区（DTLB）的预期未命中数。\n\nDTLB的总预期未命中数是访问私有区域产生的未命中数与访问共享区域产生的未命中数之和。计算过程如下：\n\n首先，我们确定域A在其时间片内进行的数据内存引用的总数。每次数据内存引用都需要一次DTLB查找。\n设$T$为时间片持续时间，$f$为核心频率，$r$为平均每个周期的退役指令数（IPC），$\\alpha$为每条指令的平均数据内存引用次数。\n给定值为：\n时间片，$T = 1 \\text{ ms} = 1 \\times 10^{-3} \\text{ s}$\n频率，$f = 3.0 \\text{ GHz} = 3.0 \\times 10^9 \\text{ cycles/s}$\nIPC，$r = 2.5 \\text{ instructions/cycle}$\n每指令数据引用数，$\\alpha = 0.4 \\text{ references/instruction}$\n\n该时间片内的总周期数为：\n$$C = T \\times f = (1 \\times 10^{-3} \\text{ s}) \\times (3.0 \\times 10^9 \\text{ cycles/s}) = 3.0 \\times 10^6 \\text{ cycles}$$\n退役的总指令数为：\n$$I = C \\times r = (3.0 \\times 10^6 \\text{ cycles}) \\times (2.5 \\text{ instructions/cycle}) = 7.5 \\times 10^6 \\text{ instructions}$$\n数据内存引用的总数，也就是DTLB访问的总数，为：\n$$N_{ref} = I \\times \\alpha = (7.5 \\times 10^6 \\text{ instructions}) \\times (0.4 \\text{ references/instruction}) = 3.0 \\times 10^6 \\text{ references}$$\n\n接下来，我们分别分析私有区域和共享区域的DTLB未命中。DTLB是按页面大小分区的，因此对不同区域的访问不会相互干扰对方的TLB条目。\n\n对私有区域（使用$2$ MB页面）的分析：\n对私有区域的引用比例为$p = 0.8$。对该区域的引用次数为：\n$$N_{ref, 2\\mathrm{M}} = N_{ref} \\times p = (3.0 \\times 10^6) \\times 0.8 = 2.4 \\times 10^6$$\n私有区域的大小为$S_{2\\mathrm{M}} = 256 \\text{ MB}$。根据安全策略，该区域使用2MB页面进行映射，因此页面大小$P_{2\\mathrm{M}} = 2 \\text{ MB}$。该区域工作集中的独立页面数量为：\n$$W_{2\\mathrm{M}} = \\frac{S_{2\\mathrm{M}}}{P_{2\\mathrm{M}}} = \\frac{256 \\text{ MB}}{2 \\text{ MB}} = 128 \\text{ pages}$$\nDTLB为2MB页面提供了$E_{2\\mathrm{M}} = 64$个条目。由于工作集大小（$W_{2\\mathrm{M}} = 128$）大于DTLB容量（$E_{2\\mathrm{M}} = 64$），在最初的强制性未命中之后，容量未命中是不可避免的。\n\n我们采用一个适用于带有LRU替换策略的全相联缓存和均匀随机访问模式的标准模型。对于大量的访问，一个拥有$W$个页面的工作集和一个容量为$E$个页面的缓存（其中$W > E$），其稳态未命中率$m$是工作集中无法容纳在缓存中的部分所占的比例。\n$$m = \\frac{W - E}{W} = 1 - \\frac{E}{W}$$\n鉴于访问是均匀随机的，且引用次数远大于工作集大小，该模型在此处是适用的，这证明了使用一个从长远来看同时考虑了强制性未命中和容量未命中的稳态近似是合理的。\n\n私有区域的未命中率为：\n$$m_{2\\mathrm{M}} = \\frac{W_{2\\mathrm{M}} - E_{2\\mathrm{M}}}{W_{2\\mathrm{M}}} = \\frac{128 - 64}{128} = \\frac{64}{128} = 0.5$$\n私有区域的预期未命中数为：\n$$N_{miss, 2\\mathrm{M}} = N_{ref, 2\\mathrm{M}} \\times m_{2\\mathrm{M}} = (2.4 \\times 10^6) \\times 0.5 = 1,200,000$$\n\n对共享区域（使用$4$ KB页面）的分析：\n对共享区域的引用比例为$1 - p = 0.2$。引用次数为：\n$$N_{ref, 4\\mathrm{K}} = N_{ref} \\times (1 - p) = (3.0 \\times 10^6) \\times 0.2 = 600,000$$\n共享区域的大小为$S_{4\\mathrm{K}} = 4 \\text{ MB}$。根据安全策略，该区域使用4KB页面进行映射，因此页面大小$P_{4\\mathrm{K}} = 4 \\text{ KB}$。该区域工作集中的独立页面数量为：\n$$W_{4\\mathrm{K}} = \\frac{S_{4\\mathrm{K}}}{P_{4\\mathrm{K}}} = \\frac{4 \\text{ MB}}{4 \\text{ KB}} = \\frac{4 \\times 1024 \\text{ KB}}{4 \\text{ KB}} = 1024 \\text{ pages}$$\nDTLB为4KB页面提供了$E_{4\\mathrm{K}} = 256$个条目。同样，这里的工作集大小（$W_{4\\mathrm{K}} = 1024$）超过了DTLB容量（$E_{4\\mathrm{K}} = 256$）。\n使用相同的未命中率模型，共享区域的未命中率为：\n$$m_{4\\mathrm{K}} = \\frac{W_{4\\mathrm{K}} - E_{4\\mathrm{K}}}{W_{4\\mathrm{K}}} = \\frac{1024 - 256}{1024} = \\frac{768}{1024} = 0.75$$\n共享区域的预期未命中数为：\n$$N_{miss, 4\\mathrm{K}} = N_{ref, 4\\mathrm{K}} \\times m_{4\\mathrm{K}} = 600,000 \\times 0.75 = 450,000$$\n\n最后，每1ms时间片内DTLB的总预期未命中数是两个区域未命中数的总和：\n$$N_{miss} = N_{miss, 2\\mathrm{M}} + N_{miss, 4\\mathrm{K}} = 1,200,000 + 450,000 = 1,650,000$$\n问题要求答案四舍五入到4位有效数字。结果是1,650,000，可以用科学记数法写成$1.650 \\times 10^6$。",
            "answer": "$$\\boxed{1.650 \\times 10^{6}}$$"
        }
    ]
}