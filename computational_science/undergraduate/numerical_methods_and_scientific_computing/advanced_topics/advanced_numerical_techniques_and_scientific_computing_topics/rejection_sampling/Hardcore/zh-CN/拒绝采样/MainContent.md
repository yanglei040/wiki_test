## 引言
在科学计算和[统计推断](@entry_id:172747)的众多任务中，从复杂的[概率分布](@entry_id:146404)中生成随机样本是一项基础且关键的挑战。当[目标分布](@entry_id:634522)的形式奇特，无法通过直接的反演或变换方法进行采样时，我们需要更通用的策略。拒绝采样（Rejection Sampling），作为一种优雅的蒙特卡洛方法，为解决这一难题提供了强大的理论框架和实用的计算工具。它巧妙地将一个困难的采样问题，转化为在一系列更简单的步骤中做出决策的过程。

本文将系统性地引导你深入探索拒绝采样的世界。你将学习到：

- 在“原理与机制”一章中，我们将从直观的几何解释出发，建立拒绝采样的形式化算法，并用数学方法证明其正确性。我们还将探讨决定算法性能的关键因素——接受率，以及如何通过优化提议分布和包络常数来提升效率。

- 在“应用与跨学科联系”一章中，我们将展示拒绝采样如何在[数值积分](@entry_id:136578)、计算物理、金融工程和贝叶斯统计等不同领域中发挥作用。通过具体的案例，你将理解这一方法如何被用于估计复杂面积、模拟物理系统以及作为更高级[MCMC算法](@entry_id:751788)的基石。

- 最后，在“动手实践”部分，你将有机会通过解决一系列精心设计的问题，将理论知识应用于实践，从而巩固和深化对核心概念的理解。

通过学习本文，你将不仅掌握一种强大的采样技术，更能体会到概率论与计算科学之间深刻而优美的联系。

## 原理与机制

在上一章引言中，我们介绍了从复杂[概率分布](@entry_id:146404)中生成随机样本的挑战。本章将深入探讨一种优雅且强大的[蒙特卡洛方法](@entry_id:136978)——**拒绝采样**（Rejection Sampling），也称为接受-拒绝方法（Acceptance-Rejection Method）。我们将从其直观的几何解释入手，建立其严谨的数学框架，并探讨其效率、局限性以及在实践中需要注意的关键问题。

### 核心思想：高维空间下的面积采样

想象一个几何问题：如何在一个单位半径的圆形区域内均匀地随机抽取一个点？直接生成满足 $x^2 + y^2 \leq 1$ 的坐标 $(x, y)$ 并不直观。然而，在一个恰好包围该圆的正方形（例如，顶点为 $(\pm 1, \pm 1)$ 的正方形）内均匀采样则非常简单：我们只需独立地从区间 $[-1, 1]$ 中抽取两个[均匀分布](@entry_id:194597)的随机数 $U$ 和 $V$ 即可得到候选点 $(U, V)$ 。

拒绝采样的思想精髓便在于此。我们在易于采样的正方形区域内生成候选点，然后通过一个简单的测试来决定是“接受”还是“拒绝”该点。在这个例子中，测试条件就是检查该点是否落在目标区域——圆的内部，即 $U^2 + V^2 \leq 1$。如果满足条件，我们就接受这个点；如果不满足，我们就拒绝它，然后重新生成下一个候选点，直到成功接受一个为止。所有被接受的点集合，将在圆形区域内构成一个[均匀分布](@entry_id:194597)。

从概率的角度看，任何一个候选点被接受的概率，等于目标区域（圆）的面积与候选区域（正方形）的面积之比。圆的面积为 $\pi R^2$（此处 $R=1$），正方形的面积为 $(2R)^2 = 4R^2$。因此，接受概率为 $\frac{\pi R^2}{4R^2} = \frac{\pi}{4}$ 。这个过程巧妙地将一个复杂的采样问题，转化为了在一个更简单、更大的集合中进行采样，并辅以一个简单的判定规则。

现在，让我们将这个几何直觉推广到对任意一维概率密度函数（PDF）$f(x)$ 进行采样。我们可以将从 $f(x)$ 采样，想象成在由 $x$ 轴、函数曲线 $y=f(x)$ 以及 $f(x)$ 的支撑集边界所围成的二维区域内均匀采样，然后取其 $x$ 坐标。直接在该不规则区域内均匀采样同样困难。

拒绝采样提供了一个变通方案：我们找到一个更简单的**[提议分布](@entry_id:144814)**（proposal distribution）$g(x)$，并乘以一个常数 $M$，使其形成的“[包络函数](@entry_id:749028)”（envelope function）$M g(x)$ 在整个定义域上都大于等于我们的**目标分布**（target distribution）$f(x)$。即满足**包络条件**：$f(x) \leq M g(x)$ 对所有 $x$ 成立。这个[包络函数](@entry_id:749028) $M g(x)$ 就扮演了前例中正方形的角色，而[目标函数](@entry_id:267263) $f(x)$ 则扮演了内切圆的角色。

采样过程如下：
1. 从[提议分布](@entry_id:144814) $g(x)$ 中抽取一个候选值 $Y$。这相当于在[包络函数](@entry_id:749028)下方的广阔区域内选择一个横坐标。
2. 在竖直方向上，从 $[0, M g(Y)]$ 区间内均匀抽取一个值 $V$。这等价于抽取一个标准均匀随机数 $U \sim \text{Uniform}(0, 1)$，然后计算 $V = U \cdot M g(Y)$。
3. 如果这个二维点 $(Y, V)$ 落在目标函数 $f(x)$ 的曲线下方，即 $V \leq f(Y)$，我们就接受这个候选值 $Y$。否则，拒绝它。

这个过程等价于我们接下来要介绍的形式化算法，它通过一次比较完成了上述二维采样和判断的过程。

### 形式化算法及其正确性

拒绝采样的标准算法流程如下：

1.  选择一个易于采样的提议PDF $g(x)$ 和一个常数 $M$，确保对所有 $x$ 都满足**包络条件** $f(x) \leq M g(x)$。
2.  从提议分布中生成一个候选样本 $Y \sim g$。
3.  独立地生成一个标准[均匀分布](@entry_id:194597)的随机数 $U \sim \text{Uniform}(0, 1)$。
4.  如果 $U \leq \frac{f(Y)}{M g(Y)}$，则接受样本 $X=Y$。否则，拒绝 $Y$，并返回步骤 2。

这个算法为何能确保最终接受的样本 $X$ 精确地服从[目标分布](@entry_id:634522) $f(x)$ 呢？我们可以通过[条件概率](@entry_id:151013)来证明其正确性 。

令 $A$ 表示候选样本 $Y$ 被接受的事件。我们想要求解的是在给定事件 $A$ 发生的条件下，$Y$ 的累积分布函数（CDF）$P(Y \leq x | A)$。根据[条件概率](@entry_id:151013)的定义：
$$ P(Y \leq x | A) = \frac{P(Y \leq x \text{ and } A)}{P(A)} $$

分子 $P(Y \leq x \text{ and } A)$ 表示生成一个值不大于 $x$ 且被接受的[联合概率](@entry_id:266356)。我们可以通过对所有可能的候选值 $y$ 进行积分得到。对于一个给定的候选值 $y$，它被接受的概率是 $\alpha(y) = P(\text{accept}|Y=y) = \frac{f(y)}{M g(y)}$。因此：
$$ P(Y \leq x \text{ and } A) = \int_{-\infty}^{x} P(\text{accept}|Y=y) g(y) \, dy = \int_{-\infty}^{x} \frac{f(y)}{M g(y)} g(y) \, dy = \frac{1}{M} \int_{-\infty}^{x} f(y) \, dy $$

分母 $P(A)$ 是任意一个候选样本被接受的总概率。我们可以通过对上式积分到无穷来得到：
$$ P(A) = \int_{-\infty}^{\infty} \frac{f(y)}{M} \, dy = \frac{1}{M} \int_{-\infty}^{\infty} f(y) \, dy $$
由于 $f(x)$ 是一个合法的PDF，其总积分为 1，所以 $P(A) = \frac{1}{M}$。

将分子和分母代回原式，我们得到接受样本的CDF：
$$ P(Y \leq x | A) = \frac{\frac{1}{M} \int_{-\infty}^{x} f(y) \, dy}{\frac{1}{M}} = \int_{-\infty}^{x} f(y) \, dy $$
这正是[目标分布](@entry_id:634522) $f(x)$ 的CDF。对其求导，我们就得到了接受样本的PDF，它恰好等于 $f(x)$。这从数学上证明了拒绝采样的正确性。

### 算法效率与提议分布的选择

拒绝采样的效率直接取决于接受率。如上所述，单次尝试的[接受概率](@entry_id:138494)为 $P(A) = 1/M$。这意味着，平均需要进行 $M$ 次尝试才能成功获得一个样本 。获得第一个接受样本所需的尝试次数 $K$ 服从成功概率为 $p=1/M$ 的[几何分布](@entry_id:154371)。

为了使算法尽可能高效，我们必须选择尽可能小的常数 $M$。根据包络条件 $f(x) \leq M g(x)$，我们有 $M \geq \frac{f(x)}{g(x)}$ 对所有 $x$ 成立。因此，能够满足该条件的最小 $M$ 值（即**最优** $M$）为：
$$ M^* = \sup_{x} \frac{f(x)}{g(x)} $$
选择这个最优的 $M^*$ 将使得[包络函数](@entry_id:749028) $M^*g(x)$ 尽可能紧密地“包裹”住目标函数 $f(x)$，从而最大化接受区域的相对面积，提高[采样效率](@entry_id:754496) 。

例如，若目标PDF为 $f(x) = 6(x-x^2)$，提议分布为 $[0, 1]$ 上的[均匀分布](@entry_id:194597) $g(x)=1$，那么寻找最优 $M$ 就等价于寻找 $f(x)$ 在 $[0, 1]$ 上的最大值。通过求导我们发现 $f(x)$ 在 $x=1/2$ 处取得最大值 $f(1/2) = 3/2$。因此最优 $M^* = 3/2$ 。此时，接受一个样本的平均尝试次数为 $1.5$ 次。

在更复杂的情况下，我们不仅可以选择最优的 $M$，甚至可以优化[提议分布](@entry_id:144814) $g(x)$ 本身的参数，以找到一个最优的包络。例如，假设我们想从标准正态分布 $p(x) \propto \exp(-x^2)$ 中采样，并使用[拉普拉斯分布](@entry_id:266437) $q_b(x) = \frac{1}{2b}\exp(-|x|/b)$ 作为[提议分布](@entry_id:144814) 。这里的[尺度参数](@entry_id:268705) $b$ 是可以调整的。我们可以首先计算出最优包络常数 $M(b)$ 作为 $b$ 的函数，然后通过微积分找到使 $M(b)$ 最小化的最优 $b$ 值。这代表了设计高效拒绝采样器的一种更高级的策略：即通过调整[提议分布](@entry_id:144814)的“形状”来使其与[目标分布](@entry_id:634522)更加匹配。

### 实践考量与常见陷阱

尽管拒绝采样的原理简单明了，但在实际应用中必须注意几个关键的理论假设和实践问题。

#### 未归一化的目标密度

拒绝采样的一个巨大优势是，即使我们只知道[目标分布](@entry_id:634522)的形式，而不知道其归一化常数，它依然能够工作。这在贝叶斯统计等领域非常常见，其中[后验分布](@entry_id:145605)通常只知道其与先验和似然的乘积成正比。

假设我们的目标 $f(x) = h(x)/Z$，其中 $h(x)$ 是已知的非负函数，而[归一化常数](@entry_id:752675) $Z = \int h(x) dx$ 未知或难以计算。我们可以选择一个常数 $M'$ 使得 $h(x) \leq M' g(x)$。此时，接受条件变为：
$$ U \leq \frac{f(Y)}{M g(Y)} = \frac{h(Y)/Z}{M g(Y)} $$
由于 $Z$ 和 $M$ 都是常数，我们可以定义一个新的包络常数 $M' = M Z$，从而 $h(Y) \leq M' g(Y)$。接受条件则可以写成不依赖于 $Z$ 的形式 ：
$$ U \leq \frac{h(Y)}{M' g(Y)} $$
这样，我们无需计算 $Z$ 就可以进行采样。此时，总的[接受概率](@entry_id:138494)变为 $P(A) = \int \frac{h(x)}{M'g(x)} g(x) dx = \frac{1}{M'} \int h(x) dx = Z/M'$。

#### 支撑集不匹配

拒绝采样的一个基本前提是：**[提议分布](@entry_id:144814)的支撑集必须覆盖[目标分布](@entry_id:634522)的支撑集**。换言之，任何使得 $f(x) > 0$ 的点 $x$，其提议密度 $g(x)$ 也必须大于零。

如果违反了这个条件，例如，[提议分布](@entry_id:144814) $g(x)$ 在[目标分布](@entry_id:634522) $f(x)$ 不为零的某个区域内为零，那么采样器将永远无法生成该区域内的样本。这会导致生成的样本[分布](@entry_id:182848)产生系统性偏差，不再是原始的 $f(x)$，而是 $f(x)$ 在[提议分布](@entry_id:144814)支撑集上的条件分布 。例如，若目标分布在 $[0, 2]$ 上有定义，而我们错误地使用了在 $[1, 2]$ 上均匀的提议分布，那么我们将永远无法得到 $[0, 1)$ 区间内的样本，所有关于该区间的[统计估计](@entry_id:270031)都将是错误的。

#### [提议分布](@entry_id:144814)的尾部行为

另一个至关重要的条件与[分布](@entry_id:182848)的“尾部”有关。**[提议分布](@entry_id:144814)的尾部必须至少与[目标分布](@entry_id:634522)的尾部同样“重”（heavy-tailed），甚至更重**。这意味着当 $|x| \to \infty$ 时，比值 $f(x)/g(x)$ 必须是有界的。

如果提议分布的尾部比[目标分布](@entry_id:634522)衰减得更快（例如，用正态分布作为提议来采样柯西分布），那么在远离中心的地方，$f(x)$ 会比 $g(x)$ 大得多，导致它们的比值 $f(x)/g(x)$ 趋向于无穷大 。在这种情况下，不存在一个有限的常数 $M$ 能满足包络条件 $f(x) \leq M g(x)$。因此，这样的[提议分布](@entry_id:144814)是无效的。在选择提议分布时，检查其尾部行为是至关重要的一步。

#### 包络常数 $M$ 的低估

包络条件 $f(x) \leq M g(x)$ 是算法正确性的基石。如果在实践中，我们选择的 $M$ 值被低估了（即 $M  M^*$），那么在某些 $x$ 值处，[接受概率](@entry_id:138494)的计算公式 $\frac{f(x)}{Mg(x)}$ 就会大于 1，这在概率上是无意义的。

如果一个算法实现简单地将大于 1 的“概率”截断为 1，那么在 $f(x) > M g(x)$ 的区域，样本的[接受概率](@entry_id:138494)将被人为地提高，从而扭曲了输出的[分布](@entry_id:182848)，使其不再是 $f(x)$。

我们可以分析这种“违规事件” $V = \{ \frac{f(X)}{M g(X)} > 1 \}$ 发生的概率 。对于一个给定的低估因子 $\epsilon$，即 $M = (1-\epsilon)M^*$，这个概率 $\mathbb{P}(V)$ 可以被精确计算出来，它量化了由于 $M$ 选择不当而导致算法失效的风险。

在实际操作中，检测和处理 $M$ 值低估问题至关重要。
*   **诊断方法**：可以在一个试运行（pilot run）阶段，监控比值 $R_i = f(X_i)/g(X_i)$ 的最大值。如果在任何时候发现 $R_i > M$，就证明了 $M$ 被低估。
*   **修正措施**：唯一正确的做法是，一旦检测到 $M$ 被低估，就必须立即停止采样，将所有已生成的样本全部丢弃（因为它们来自一个有偏的[分布](@entry_id:182848)），然后用一个更新后的、更大的 $M$ 值（例如，观察到的最大比值）重新开始整个采样过程。

综上所述，拒绝采样是一个理论优美且应用广泛的工具。然而，它的成功实施依赖于对提议分布和包络常数的审慎选择，以及对算法基本假设的严格遵守。