## 引言
在分析从事件起始到终点发生的时间（即“生存时间”）时，我们常常面临数据不完整的挑战。研究对象可能中途失访或在研究结束时仍未发生我们关注的事件，这些不完整的观测数据被称为“删失”。若简单忽略这些数据，将导致对生存概率的严重偏误。[Kaplan-Meier](@entry_id:169317) 估计正是一种强大而直观的[非参数方法](@entry_id:138925)，旨在有效利用这些删失信息，提供对生存函数的精确估计。本文旨在全面解析 [Kaplan-Meier](@entry_id:169317) 估计。在“原理与机制”一章中，我们将深入探讨其数学构造、计算步骤和关键假设。接着，“应用与跨学科联系”一章将展示其在医学、工程、商业等多个领域的广泛应用。最后，“动手实践”部分将通过具体练习，巩固你的分析技能。让我们首先从 [Kaplan-Meier](@entry_id:169317) 估计的核心原理与机制开始。

## 原理与机制

在上一章中，我们介绍了[生存分析](@entry_id:163785)的基本目标：分析从起始事件到目标事件发生所经过的时间。然而，在几乎所有的实际研究中，我们都面临一个核心挑战：数据不完整。例如，在临床试验中，一些患者可能在研究结束时仍未经历我们关注的事件（如疾病复发），或者因为搬家等与研究无关的原因而失联。这些不完整的观测数据被称为 **删失 (censoring)**。简单地忽略这些数据会严重偏离我们对生存概率的估计。[Kaplan-Meier](@entry_id:169317) 估计量是一种强大而优雅的[非参数方法](@entry_id:138925)，它能够有效地利用这些[删失数据](@entry_id:173222)，为我们提供对生存函数的精确估计。本章将深入探讨 [Kaplan-Meier](@entry_id:169317) 估计量的基本原理、计算机制、关键假设及其在复杂数据场景下的扩展。

### [生存数据](@entry_id:165675)的基础：时间和状态

为了构建 [Kaplan-Meier](@entry_id:169317) 估计，我们必须为研究中的每一个体收集两个关键信息：首先是观测时长，其次是该观测结束时的状态。具体来说，对于每个个体 $i$，我们需要记录一对数据 $(T_i, \delta_i)$。

- $T_i$ 是 **观测时间 (observation time)**。这是从研究开始到[个体发生](@entry_id:164036)事件或被删失的时间长度。
- $\delta_i$ 是 **事件指示符 (event indicator)**。这是一个[二元变量](@entry_id:162761)，通常定义为：
  - $\delta_i = 1$，如果个体在时间 $T_i$ 经历了我们感兴趣的事件（例如，患者疾病复发，机器发生故障）。
  - $\delta_i = 0$，如果个体在时间 $T_i$ 被删失（例如，研究结束时患者仍然健康，或因无关原因失访）。

这里的观测时间 $T_i$ 实际上是两个潜在时间中的较小者：真正的事件时间 $X_i$ 和删失时间 $C_i$。即 $T_i = \min(X_i, C_i)$。事件指示符 $\delta_i$ 则告诉我们观测到的时间 $T_i$ 究竟是真实的事件时间（$X_i \le C_i$）还是删失时间（$X_i > C_i$）。

### [右删失](@entry_id:164686)：[Kaplan-Meier](@entry_id:169317) 方法的核心应用场景

虽然存在多种类型的[删失数据](@entry_id:173222)，但标准的 [Kaplan-Meier](@entry_id:169317) 方法专门用于处理 **[右删失](@entry_id:164686) (right censoring)** 数据。当一个观测值是[右删失](@entry_id:164686)时，我们只知道其真实的事件时间大于我们最后观察到它的时间。换言之，事件发生在其观测时间的“右侧”。

[右删失](@entry_id:164686)主要有以下几种常见来源：

1.  **研究结束 (Administrative Censoring)**：研究有预设的结束日期。所有在研究结束时仍未发生事件的个体都被删失。例如，一项为期五年的临床试验结束时，所有仍存活的患者都被记录为在第五年被[右删失](@entry_id:164686)。
2.  **失访 (Loss to Follow-up)**：个体因与研究结果无关的原因（如搬家、更换联系方式）而中断联系。
3.  **退出研究 (Withdrawal)**：个体因个人原因主动选择退出研究。

这三种情况的共同点是，在删失发生的那一刻，我们知道该个体仍然“存活”（即未发生事件）。这一信息虽然不完整，但对于准确估计生存概率至关重要，而 [Kaplan-Meier](@entry_id:169317) 方法的核心优势就在于能够将这些信息整合到分析中。

### [Kaplan-Meier](@entry_id:169317) 估计量的构建

[Kaplan-Meier](@entry_id:169317) 估计量背后的核心思想是，将生存函数 $S(t) = P(T > t)$ 分解为一系列[条件概率](@entry_id:151013)的乘积。在没有事件发生的时间段内，生存概率保持不变。只有在观测到事件的时刻，生存概率才会下降。

假设研究中观测到的[独立事件](@entry_id:275822)时间点按顺序[排列](@entry_id:136432)为 $t_{(1)}  t_{(2)}  \dots  t_{(k)}$。那么，在时间 $t$ 的生存概率 $\hat{S}(t)$ 可以通过以下公式估计：

$$
\hat{S}(t) = \prod_{j: t_{(j)} \le t} \left(1 - \frac{d_j}{n_j}\right)
$$

这个公式是 [Kaplan-Meier](@entry_id:169317) 估计的核心，理解其每个组成部分至关重要：

- $t_{(j)}$：第 $j$ 个发生事件的 **唯一时间点**。请注意，即使有多个个体在同一时间发生事件，它们也只构成一个事件时间点。
- $d_j$：在时间点 $t_{(j)}$ **发生事件的个体数量**。
- $n_j$：在时间点 $t_{(j)}$ **之前瞬间的风险集 (risk set) 大小**。

**风险集** $n_j$ 是一个至关重要的概念。它指的是在时间点 $t_{(j)}$ 即将到来之前，所有“处于风险中”的个体总数。一个个体要被包含在风险集 $n_j$ 中，必须满足两个条件：(1) 他/她到该时间点为止尚未经历事件；(2) 他/她到该时间点为止尚未被删失。换句话说，风险集包含了所有在 $t_{(j)}$ 时刻有可能经历事件的个体。

让我们通过一个具体的例子来理解这个计算过程。假设我们有以下8名患者的数据（时间单位：月，* 表示删失）：10, 15*, 9, 12, 15, 9*, 18, 20*。
我们的目标是计算 $\hat{S}(16)$，即在16个月时的估计生存概率。

1.  **整理数据**：
    - 事件时间：9, 10, 12, 15, 18
    - 删失时间：9*, 15*, 20*
    - 唯一事件时间点 $t_{(j)} \le 16$ 有：9, 10, 12, 15。

2.  **逐步计算**：
    - **初始状态**：在时间 $t=0$ 时，所有8名患者都处于风险中，$\hat{S}(0) = 1$。
    - **事件点 $t_{(1)}=9$**：
        - 风险集 $n_1$：在9个月之前，所有8名患者都在研究中。所以 $n_1 = 8$。
        - 事件数 $d_1$：在9个月时，有1名患者发生事件。所以 $d_1 = 1$。
        - 生存概率更新：$\hat{S}(9) = \hat{S}(0) \times (1 - \frac{d_1}{n_1}) = 1 \times (1 - \frac{1}{8}) = \frac{7}{8}$。
        - 注意：在9个月时，还有一名患者被删失。这名患者从下一个时间点开始将不再计入风险集。
    - **事件点 $t_{(2)}=10$**：
        - 风险集 $n_2$：在10个月之前，原有8人，1人在9个月发生事件，1人在9个月被删失。因此风险集中还剩 $8-1-1=6$ 人。所以 $n_2 = 6$。
        - 事件数 $d_2$：在10个月时，有1名患者发生事件。所以 $d_2 = 1$。
        - 生存概率更新：$\hat{S}(10) = \hat{S}(9) \times (1 - \frac{d_2}{n_2}) = \frac{7}{8} \times (1 - \frac{1}{6}) = \frac{7}{8} \times \frac{5}{6} = \frac{35}{48}$。
    - **事件点 $t_{(3)}=12$**：
        - 风险集 $n_3$：在12个月之前，风险集中有6人，1人在10个月发生事件。剩下5人。所以 $n_3 = 5$。
        - 事件数 $d_3$：在12个月时，有1名患者发生事件。所以 $d_3 = 1$。
        - 生存概率更新：$\hat{S}(12) = \hat{S}(10) \times (1 - \frac{d_3}{n_3}) = \frac{35}{48} \times (1 - \frac{1}{5}) = \frac{35}{48} \times \frac{4}{5} = \frac{7}{12}$。
    - **事件点 $t_{(4)}=15$**：
        - 风险集 $n_4$：在15个月之前，风险集中有5人，1人在12个月发生事件。剩下4人。所以 $n_4 = 4$。
        - 事件数 $d_4$：在15个月时，有1名患者发生事件。所以 $d_4 = 1$。
        - 生存概率更新：$\hat{S}(15) = \hat{S}(12) \times (1 - \frac{d_4}{n_4}) = \frac{7}{12} \times (1 - \frac{1}{4}) = \frac{7}{12} \times \frac{3}{4} = \frac{7}{16}$。
        - 注意：在15个月时，还有一名患者被删失。

3.  **最终结果**：
    由于在时间点15和16之间没有其他事件发生，生存概率保持不变。因此，$\hat{S}(16) = \hat{S}(15) = \frac{7}{16} = 0.4375$。

这个例子清晰地展示了，删失的个体在被删失之前为风险集贡献了信息，但在被删失之后就不再计入风险集。这就是 [Kaplan-Meier](@entry_id:169317) 方法巧妙利用不完整数据的方式。

### [Kaplan-Meier](@entry_id:169317) 曲线的特性

将 [Kaplan-Meier](@entry_id:169317) 估计的生存概率 $\hat{S}(t)$ 随时间 $t$ 绘制出来，我们就得到了 **[Kaplan-Meier](@entry_id:169317) 曲线**。这条曲线具有非常鲜明的特征：

- 它是一条 **[阶梯函数](@entry_id:159192) (step function)**。
- 曲线的 **下降仅发生在观测到事件的时间点**。下降的幅度为 $\hat{S}(t_{j-1}) \times \frac{d_j}{n_j}$。
- 在两个连续的事件时间点之间，曲线保持水平，表示在这段时间内估计的生存概率没有变化。
- **删失时间点不会导致曲线下降**。删失只会影响后续事件时间点的风险集大小 $n_j$，从而影响后续曲线下降的幅度。
- 按照惯例，[Kaplan-Meier](@entry_id:169317) 曲线是 **右连续的**。这意味着在事件时间点 $t_j$ 处，函数的值等于下降后的值，即 $\hat{S}(t_j) = \lim_{\epsilon \to 0^+} \hat{S}(t_j + \epsilon)$。

一个有趣的特例是，当数据中 **没有任何删失** 时，[Kaplan-Meier](@entry_id:169317) 估计量会简化为我们更熟悉的 **经验生存函数 (empirical survival function)**。经验生存函数在时间 $t$ 的值就是简单地用在时间 $t$ 仍然存活的个体数量除以初始个体总数。这表明，[Kaplan-Meier](@entry_id:169317) 方法是经验生存函数在处理[删失数据](@entry_id:173222)时的一个自然推广。

### 关键假设与局限性

[Kaplan-Meier](@entry_id:169317) 估计的有效性依赖于一个至关重要的假设：**非信息性删失 (non-informative censoring)**。

这个假设意味着，删失机制必须独立于事件发生的风险。换句话说，一个被删失的个体，其未来的生存前景应该与仍在研究中、具有相同特征的个体没有系统性差异。

- **非信息性删失的例子**：
    - 研究按计划在第10年结束（行政删失）。
    - 患者因找到新工作而搬到另一个城市，导致失访。
    - 汽车车主因为想换新款车而卖掉旧车，而该研究在追踪旧车的机械故障时间。

- **信息性删失的例子（违反假设）**：
    - 在一项评估新疗法的研究中，病情迅速恶化的患者选择退出研究以寻求临终关怀。这些患者被当作删失处理。这是一个典型的 **信息性删失**，因为退出研究（删失）这个行为本身就提供了关于其生存预后（更可能较早发生事件）的信息。如果将他们按非信息性删失处理，会导致风险集在后期人为地包含了更多健康状况较好的个体，从而 **高估** 实际的生存概率。

当存在信息性删失时，[Kaplan-Meier](@entry_id:169317) 估计会产生偏差，其结果不再可靠。

另一个实际问题是如何概括生存曲线。虽然 **平均生存时间** 是一个吸引人的指标，但直接通过对 [Kaplan-Meier](@entry_id:169317) 曲线积分 $\int_0^\infty \hat{S}(t) dt$ 来估计它可能会遇到困难。特别是当最大的观测时间点是一个[删失数据](@entry_id:173222)时，$\hat{S}(t)$ 曲线在最后不会降至0，导致积分无法收敛。

为了解决这个问题，一个更稳健且常用的替代指标是 **限制性平均生存时间 (Restricted Mean Survival Time, RMST)**。RMST 定义为在某个预先设定的时间点 $L$ 之前的平均生存时间，其计算方法就是计算 [Kaplan-Meier](@entry_id:169317) 曲线下方从 0 到 $L$ 的面积。例如，$\text{RMST}(L) = \int_{0}^{L}\hat{S}(t)dt$。由于积分区间是有限的，RMST 总能被计算出来，并且提供了在特定时间窗内生存获益的直观解释。

### 高级主题：[竞争风险](@entry_id:173277)与左截断

标准的 [Kaplan-Meier](@entry_id:169317) 方法在更复杂的[数据结构](@entry_id:262134)中会遇到挑战。

#### [竞争风险](@entry_id:173277) (Competing Risks)

在许多研究中，个体可能经历多种不同类型、且相互排斥的事件。例如，在对一种硬盘的可靠性研究中，硬盘可能因“内存单元退化”（A类故障）或“控制器故障”（B类故障）而失效。这两种故障就是 **[竞争风险](@entry_id:173277)**。

一个常见的错误做法是，在研究A类故障时，将B类故障的发生当作删失来处理，然后应用标准的 [Kaplan-Meier](@entry_id:169317) 方法。这种方法得到的“生存曲线” $S_A^*(t)$ 的解释是模糊且具有误导性的。它估计的不是“未发生A类故障的概率”，而是在一个假设的世界里——一个B类故障永远不会发生的世界里——未发生A类故障的概率。这在现实中并不存在。

正确的处理方法是使用 **累积发生函数 (Cumulative Incidence Function, CIF)**，记为 $I_A(t)$。CIF 估计的是到时间 $t$ 为止，因A类故障而失败的真实概率，它同时考虑了所有其他[竞争风险](@entry_id:173277)的存在。$I_A(t)$ 的估计量为 $\hat{I}_A(t) = \sum_{t_i \le t} \frac{d_{iA}}{n_i} \hat{S}(t_{i-1})$，其中 $d_{iA}$ 是在时间 $t_i$ 发生A类事件的数量，$n_i$ 是总风险集，而 $\hat{S}(t_{i-1})$ 是考虑所有类型事件的 **总生存概率** 的 [Kaplan-Meier](@entry_id:169317) 估计。因此，在存在[竞争风险](@entry_id:173277)时，我们应该关注 $1 - \hat{I}_A(t)$ 而非 naive 的 [Kaplan-Meier](@entry_id:169317) 估计。

#### 左截断 (Left Truncation)

除了[右删失](@entry_id:164686)，数据还可能存在 **左截断 (left truncation)**，也称为 **延迟进入 (delayed entry)**。这种情况发生于个体并非从时间零点（$t=0$）开始就被观察，而是从某个进入时间 $L_i > 0$ 才开始被纳入研究。例如，一项研究分析某项手术后患者的长期存活率，时间零点可能是患者出生日期，但他们只有在接受手术时才进入研究队列。

在处理左[截断数据](@entry_id:163004)时，风险集的定义必须修正。在时间 $t$，一个个体要被计入风险集，他/她必须已经进入了研究（$L_i \le t$），并且到该时间点为止仍然存活（$T_i \ge t$）。因此，正确的风险集 $Y(t)$ 的定义为 $Y(t) = \sum_{i=1}^n \mathbf{1}\{L_i \le t \le T_i\}$。

如果忽略左截断，使用朴素的风险集定义 $\tilde Y(t) = \sum_{i=1}^n \mathbf{1}\{t \le T_i\}$，就会错误地将那些在时间 $t$ 尚未进入研究的个体也包含在分母中。这会人为地夸大风险集的大小，系统性地低估[风险率](@entry_id:266388)，从而导致对生存概率的偏高估计。因此，在存在延迟进入的情况下，使用为左截断调整过的 [Kaplan-Meier](@entry_id:169317) 估计是至关重要的。

总之，[Kaplan-Meier](@entry_id:169317) 估计量是[生存分析](@entry_id:163785)的基石。掌握其计算机制、理解其核心假设，并认识到其在[竞争风险](@entry_id:173277)和左截断等复杂场景下的局限性和相应扩展，是进行严谨、可靠的[生存数据分析](@entry_id:190868)的关键。