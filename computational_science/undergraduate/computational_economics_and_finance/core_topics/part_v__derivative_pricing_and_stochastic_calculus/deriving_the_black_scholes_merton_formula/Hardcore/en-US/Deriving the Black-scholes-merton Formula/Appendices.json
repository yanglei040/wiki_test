{
    "hands_on_practices": [
        {
            "introduction": "Before tackling the full Black-Scholes-Merton derivation, it is crucial to build an intuition for the dynamic, stochastic relationship between an option's value and the price of its underlying asset. This exercise guides you through the application of Itô's Lemma, a cornerstone of stochastic calculus, to quantify the instantaneous co-movement of an option's return and the stock's return. By deriving the option's instantaneous \"beta\" with respect to the stock, you will uncover its price elasticity, $\\Omega$, and gain hands-on experience with the mathematical tools essential for modeling derivative dynamics. ",
            "id": "2390329",
            "problem": "Consider a frictionless market with a continuously traded underlying stock whose price process is modeled as Geometric Brownian Motion (GBM), that is, $dS_t = \\mu S_t \\, dt + \\sigma S_t \\, dW_t$ for constants $\\,\\mu \\in \\mathbb{R}\\,$ and $\\,\\sigma > 0\\,$, where $W_t$ is a standard Brownian motion. Let $C(S,t)$ denote the time-$t$ price of a European call option with strike $K$ and maturity $T$, written on the stock with continuous dividend yield $q$ and a continuously compounded risk-free rate $r$. The option is the unique no-arbitrage price under the Black-Scholes-Merton framework.\n\nDefine the arithmetic return of the stock over an infinitesimal time interval as $r_S = dS_t / S_t$ and the arithmetic return of the option as $r_C = dC_t / C_t$. Define the instantaneous beta of the option’s return with respect to the stock’s return as\n$$\\beta = \\lim_{\\Delta t \\to 0^+} \\frac{\\operatorname{Cov}\\!\\left(r_C, r_S\\right)}{\\operatorname{Var}\\!\\left(r_S\\right)}.$$\nYour task is to compute, for each parameter set in the test suite below, the instantaneous beta $\\beta$ implied by the model, using exact analytical values for the option price and its sensitivity consistent with the model assumptions. All outputs must be real numbers without any unit conversions or percentage symbols.\n\nTest suite (each case is a tuple $(S, K, r, q, \\sigma, T)$):\n- Case 1 (general, at-the-money): $(100.0, 100.0, 0.01, 0.02, 0.2, 1.0)$.\n- Case 2 (deep in-the-money): $(150.0, 100.0, 0.03, 0.0, 0.25, 2.0)$.\n- Case 3 (deep out-of-the-money): $(50.0, 100.0, 0.01, 0.0, 0.2, 1.0)$.\n- Case 4 (short time-to-maturity, at-the-money): $(100.0, 100.0, 0.0, 0.0, 0.2, 1.0/365.0)$.\n- Case 5 (out-of-the-money with dividends, long maturity): $(100.0, 110.0, 0.05, 0.02, 0.3, 3.0)$.\n\nRequirements:\n- For each case, compute the instantaneous beta $\\beta$ under the stated model and parameters, using the arithmetic return definition above.\n- Express each result as a float rounded to six decimal places.\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the same order as the test suite (for example, $[x_1,x_2,x_3,x_4,x_5]$). Do not include any additional text or spaces.\n\nNote: Angles are not involved; there are no physical units to report. All numerical answers must be provided as real numbers (for example, use $0.123456$ rather than $12.3456\\%$).",
            "solution": "The problem requires the computation of the instantaneous beta of a European call option's return with respect to its underlying stock's return. We begin by rigorously deriving the analytical expression for this beta within the Black-Scholes-Merton framework.\n\nThe problem defines the instantaneous beta as:\n$$ \\beta = \\lim_{\\Delta t \\to 0^+} \\frac{\\operatorname{Cov}\\!\\left(r_C, r_S\\right)}{\\operatorname{Var}\\!\\left(r_S\\right)} $$\nwhere $r_S = dS_t / S_t$ and $r_C = dC_t / C_t$ are the arithmetic returns of the stock and option, respectively. This formulation is equivalent to the ratio of the instantaneous rates of covariance and variance.\n\nFirst, we analyze the denominator, which involves the stock's return dynamics. The stock price $S_t$ follows a Geometric Brownian Motion (GBM):\n$$ dS_t = \\mu S_t \\, dt + \\sigma S_t \\, dW_t $$\nThe arithmetic return is therefore:\n$$ r_S = \\frac{dS_t}{S_t} = \\mu \\, dt + \\sigma \\, dW_t $$\nThe variance of this process over an infinitesimal time interval $dt$ is driven solely by the stochastic term. The increment of a standard Brownian motion $dW_t$ is normally distributed with mean $0$ and variance $dt$.\n$$ \\operatorname{Var}(r_S) = \\operatorname{Var}(\\mu \\, dt + \\sigma \\, dW_t) = \\sigma^2 \\operatorname{Var}(dW_t) = \\sigma^2 dt $$\nThe instantaneous variance rate is the coefficient of $dt$, which is $\\sigma^2$. This is the denominator of the expression for $\\beta$.\n\nNext, we analyze the numerator, which involves the option's return dynamics. The option price $C(S,t)$ is a function of the stock price $S$ and time $t$. We apply Itô's Lemma to find the dynamics of $C(S,t)$:\n$$ dC_t = \\frac{\\partial C}{\\partial t} dt + \\frac{\\partial C}{\\partial S} dS_t + \\frac{1}{2} \\frac{\\partial^2 C}{\\partial S^2} (dS_t)^2 $$\nThe quadratic variation term $(dS_t)^2$ is calculated as:\n$$ (dS_t)^2 = (\\mu S_t \\, dt + \\sigma S_t \\, dW_t)^2 = \\sigma^2 S_t^2 (dW_t)^2 = \\sigma^2 S_t^2 dt $$\nHere, we neglect terms of order $dt^{3/2}$ and $dt^2$. Substituting the expressions for $dS_t$ and $(dS_t)^2$ into the Itô expansion for $dC_t$:\n$$ dC_t = \\frac{\\partial C}{\\partial t} dt + \\frac{\\partial C}{\\partial S} (\\mu S_t \\, dt + \\sigma S_t \\, dW_t) + \\frac{1}{2} \\frac{\\partial^2 C}{\\partial S^2} \\sigma^2 S_t^2 dt $$\nGrouping the $dt$ and $dW_t$ terms gives:\n$$ dC_t = \\left( \\frac{\\partial C}{\\partial t} + \\mu S_t \\frac{\\partial C}{\\partial S} + \\frac{1}{2} \\sigma^2 S_t^2 \\frac{\\partial^2 C}{\\partial S^2} \\right) dt + \\left( \\sigma S_t \\frac{\\partial C}{\\partial S} \\right) dW_t $$\nThe arithmetic return of the option is $r_C = dC_t / C_t$:\n$$ r_C = \\frac{1}{C_t} \\left( \\frac{\\partial C}{\\partial t} + \\mu S_t \\frac{\\partial C}{\\partial S} + \\frac{1}{2} \\sigma^2 S_t^2 \\frac{\\partial^2 C}{\\partial S^2} \\right) dt + \\frac{1}{C_t} \\left( \\sigma S_t \\frac{\\partial C}{\\partial S} \\right) dW_t $$\nNow, we compute the covariance between $r_C$ and $r_S$ over the interval $dt$:\n$$ \\operatorname{Cov}(r_C, r_S) = \\operatorname{Cov}\\left( \\frac{1}{C_t} \\sigma S_t \\frac{\\partial C}{\\partial S} dW_t, \\sigma dW_t \\right) $$\nOnly the stochastic components contribute to the covariance.\n$$ \\operatorname{Cov}(r_C, r_S) = \\left( \\frac{1}{C_t} \\sigma S_t \\frac{\\partial C}{\\partial S} \\right) \\cdot \\sigma \\cdot \\operatorname{Var}(dW_t) = \\frac{\\sigma^2 S_t}{C_t} \\frac{\\partial C}{\\partial S} dt $$\nThe instantaneous covariance rate is the coefficient of $dt$: $\\frac{\\sigma^2 S_t}{C_t} \\frac{\\partial C}{\\partial S}$.\n\nWe can now assemble the expression for beta:\n$$ \\beta = \\frac{\\text{Instantaneous Covariance Rate}}{\\text{Instantaneous Variance Rate}} = \\frac{\\frac{\\sigma^2 S_t}{C_t} \\frac{\\partial C}{\\partial S}}{\\sigma^2} $$\nThe $\\sigma^2$ terms cancel, yielding a remarkably simple and elegant result:\n$$ \\beta = \\frac{S_t}{C_t} \\frac{\\partial C}{\\partial S} $$\nThis quantity is also known as the elasticity of the option price with respect to the stock price, often denoted by $\\Omega$. It is the product of the option's delta ($\\Delta_C = \\frac{\\partial C}{\\partial S}$) and the ratio of the stock price to the option price.\n\nTo compute $\\beta$ numerically, we must use the analytical formulas for the Black-Scholes-Merton model, as specified. Let $\\tau = T-t$ be the time to maturity. At time $t=0$, $\\tau=T$. The price of a European call option with a continuous dividend yield $q$ is:\n$$ C(S, t) = S e^{-q \\tau} N(d_1) - K e^{-r \\tau} N(d_2) $$\nThe option's delta is:\n$$ \\Delta_C = \\frac{\\partial C}{\\partial S} = e^{-q \\tau} N(d_1) $$\nwhere $N(\\cdot)$ is the cumulative distribution function (CDF) of the standard normal distribution, and $d_1, d_2$ are given by:\n$$ d_1 = \\frac{\\ln(S/K) + (r - q + \\frac{1}{2}\\sigma^2)\\tau}{\\sigma \\sqrt{\\tau}} $$\n$$ d_2 = d_1 - \\sigma \\sqrt{\\tau} $$\nSubstituting the expressions for $C$ and $\\Delta_C$ into our formula for $\\beta$:\n$$ \\beta = \\frac{S \\cdot \\left( e^{-q \\tau} N(d_1) \\right)}{S e^{-q \\tau} N(d_1) - K e^{-r \\tau} N(d_2)} $$\nThis is the final analytical formula to be implemented. For each test case, we will substitute the given parameters $(S, K, r, q, \\sigma, T)$ (with $\\tau=T$) into this equation, using a standard numerical library to evaluate the normal CDF $N(\\cdot)$. The procedure is as follows:\n$1$. For each set of parameters, calculate $\\tau=T$.\n$2$. Compute $d_1$ and $d_2$.\n$3$. Evaluate $N(d_1)$ and $N(d_2)$.\n$4$. Calculate the numerator term $S e^{-q \\tau} N(d_1)$.\n$5$. Calculate the denominator term (the call price $C$) which is $S e^{-q \\tau} N(d_1) - K e^{-r \\tau} N(d_2)$.\n$6$. The value of $\\beta$ is the ratio of the result from step $4$ to the result from step $5$.\nThis procedure will be applied to all test cases provided.",
            "answer": "```python\nimport numpy as np\nfrom scipy.stats import norm\n\ndef solve():\n    \"\"\"\n    Computes the instantaneous beta of a European call option for a set of test cases.\n    \"\"\"\n    # Test suite: (S, K, r, q, sigma, T)\n    test_cases = [\n        (100.0, 100.0, 0.01, 0.02, 0.2, 1.0),\n        (150.0, 100.0, 0.03, 0.0, 0.25, 2.0),\n        (50.0, 100.0, 0.01, 0.0, 0.2, 1.0),\n        (100.0, 100.0, 0.0, 0.0, 0.2, 1.0 / 365.0),\n        (100.0, 110.0, 0.05, 0.02, 0.3, 3.0),\n    ]\n\n    def calculate_beta(S, K, r, q, sigma, T):\n        \"\"\"\n        Calculates the instantaneous beta of a European call option.\n        Beta = (S * Delta) / C\n        \"\"\"\n        # Ensure time to maturity is not zero to avoid division by zero in d1/d2.\n        # If maturity is extremely small, the result will be large but finite.\n        if T <= 1e-12:\n            return float('inf')\n\n        # Time to maturity\n        tau = T\n\n        # Calculate d1 and d2\n        sigma_sqrt_tau = sigma * np.sqrt(tau)\n        d1 = (np.log(S / K) + (r - q + 0.5 * sigma**2) * tau) / sigma_sqrt_tau\n        d2 = d1 - sigma_sqrt_tau\n\n        # Evaluate the standard normal CDF\n        N_d1 = norm.cdf(d1)\n        N_d2 = norm.cdf(d2)\n        \n        # Calculate Delta, the first partial derivative of the option price\n        # with respect to the stock price. This is the hedging ratio.\n        # Delta = exp(-q*tau) * N(d1)\n        \n        # We compute beta using the derived analytical formula:\n        # beta = (S * exp(-q*tau) * N(d1)) / (S * exp(-q*tau) * N(d1) - K * exp(-r*tau) * N(d2))\n        \n        numerator = S * np.exp(-q * tau) * N_d1\n        \n        # Denominator is the Black-Scholes call price C\n        denominator = numerator - K * np.exp(-r * tau) * N_d2\n\n        # To avoid division by zero for deep out-of-the-money options where C might be numerically zero\n        if np.abs(denominator) < 1e-12:\n            # If the call price is effectively zero, the beta is theoretically infinite.\n            # In practice, we return a very large number or inf.\n            return float('inf')\n\n        beta = numerator / denominator\n        \n        return beta\n\n    results = []\n    for case in test_cases:\n        beta_value = calculate_beta(*case)\n        # Round the result to six decimal places as required.\n        results.append(f\"{beta_value:.6f}\")\n\n    # Format the final output string\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "The Black-Scholes-Merton model can be expressed as a partial differential equation (PDE) that governs the evolution of an option's price over time and space, derived from a no-arbitrage, delta-hedging argument. This practice moves beyond the well-known analytical formula to explore the structure of the PDE itself. You will implement the Crank-Nicolson finite difference method, a robust numerical technique, to solve the BSM equation as an initial-boundary value problem.  This computational approach provides a deeper understanding of how the drift, diffusion, and discounting terms interact to determine the option's value and demonstrates the stability of the numerical solution.",
            "id": "2387926",
            "problem": "Consider a frictionless market with a risky asset whose price process is denoted by $S_t$ and a money market account earning a continuously compounded risk-free rate $r$. Assume that, under the risk-neutral probability measure, the risky asset follows a geometric Brownian motion $dS_t = r S_t \\, dt + \\sigma S_t \\, dW_t$, where $\\sigma > 0$ is constant volatility and $W_t$ is a standard Brownian motion. Let $V(S,t)$ denote the time-$t$ value of a European call option with strike $K$ and maturity $T$. By no-arbitrage and replication, $V(S,t)$ satisfies the Black-Scholes-Merton partial differential equation $V_t + \\tfrac{1}{2} \\sigma^2 S^2 V_{SS} + r S V_S - r V = 0$ for $S \\in (0,\\infty)$ and $t \\in [0,T)$. The terminal condition is $V(S,T) = \\max(S-K,0)$. On a truncated spatial domain $S \\in [0,S_{\\max}]$ with $S_{\\max} \\gg K$, impose boundary conditions $V(0,t) = 0$ and $V(S_{\\max},t) \\approx S_{\\max} - K e^{-r (T-t)}$ for $t \\in [0,T]$.\n\nYour task is to write a complete and runnable program that, starting from the fundamental no-arbitrage principle and the Black-Scholes-Merton partial differential equation, computes a numerical solution on a uniform space-time grid and demonstrates unconditional stability empirically by using very large time steps. The program must:\n\n- Construct a consistent finite-difference approximation that is second order accurate in both time and space on the domain $S \\in [0,S_{\\max}]$ and $\\tau \\in [0,T]$, where $\\tau = T - t$ is the time-to-maturity variable. The initial condition at $\\tau = 0$ is $V(S,0) = \\max(S-K,0)$. The boundary conditions are $V(0,\\tau) = 0$ and $V(S_{\\max},\\tau) = S_{\\max} - K e^{-r \\tau}$ for $\\tau \\in [0,T]$.\n- Price a European call at a given initial underlying value $S_0$ by linearly interpolating the grid solution $V(S,\\tau)$ at $\\tau = T$. All rates must be expressed as decimals, not with a percentage sign. All prices must be reported in the same arbitrary monetary unit as $S$ and $K$.\n- Quantitatively assess the numerical error by comparing the numerical price to the analytical Black-Scholes-Merton value $C_{\\text{BSM}}(S_0,K,r,\\sigma,T)$ and reporting the absolute error as a floating-point number.\n- Empirically demonstrate unconditional stability by running the scheme with very large time steps (very small numbers of time levels) while keeping the spatial grid fixed and verifying that the numerical solution remains bounded between $0$ and $S_{\\max}$ at all time levels and nodes.\n\nUse the following common parameter values: $S_0 = 100$, $K = 100$, $r = 0.05$, $\\sigma = 0.2$, $T = 1$, $S_{\\max} = 500$. Use a uniform spatial grid with $M$ subintervals (so $M+1$ spatial nodes), and a uniform temporal grid in $\\tau$ with $N$ subintervals (so $N+1$ time levels including $\\tau=0$ and $\\tau=T$).\n\nTest suite. Your program must run the following four test cases and aggregate the results as specified:\n- Test case $1$ (happy path accuracy): $(M,N) = (400,400)$. Output the absolute error $|C_{\\text{num}} - C_{\\text{BSM}}|$ as a floating-point number.\n- Test case $2$ (extremely large time step): $(M,N) = (400,4)$. Output the absolute error $|C_{\\text{num}} - C_{\\text{BSM}}|$ as a floating-point number.\n- Test case $3$ (coarser space-time grid): $(M,N) = (100,100)$. Output the absolute error $|C_{\\text{num}} - C_{\\text{BSM}}|$ as a floating-point number.\n- Test case $4$ (empirical unconditional stability check): Fix $M = 400$ and run with $N \\in \\{1,2,4,8,16,32,64\\}$. Let the stability indicator be the boolean that is true if and only if for every $N$ in this set, at every time level and every spatial node, all computed values are finite and lie within $[0,S_{\\max}]$ up to a tolerance of $10^{-8}$, and false otherwise. Output this boolean.\n\nFinal output format. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the exact order: test case $1$ absolute error, test case $2$ absolute error, test case $3$ absolute error, and test case $4$ stability boolean. For example, a syntactically correct output line is of the form $[0.001234,0.056789,0.012345,True]$.",
            "solution": "The problem statement constitutes a well-posed initial-boundary value problem from computational finance. It is scientifically grounded in the Black-Scholes-Merton no-arbitrage framework and provides a complete and consistent set of parameters, initial conditions, and boundary conditions for a numerical solution. The problem is therefore valid, and we proceed to construct the required numerical method and program.\n\nThe fundamental equation is the Black-Scholes-Merton partial differential equation (PDE) for the value of a European option, $V(S,t)$:\n$$\n\\frac{\\partial V}{\\partial t} + \\frac{1}{2}\\sigma^2 S^2 \\frac{\\partial^2 V}{\\partial S^2} + r S \\frac{\\partial V}{\\partial S} - r V = 0\n$$\nThis is a final value problem with the terminal condition at time $t=T$ given by the option's payoff function, $V(S,T) = \\max(S-K, 0)$. To transform this into a standard initial value problem, we introduce the time-to-maturity variable $\\tau = T - t$. The derivatives transform as $\\frac{\\partial}{\\partial t} = \\frac{\\partial \\tau}{\\partial t} \\frac{\\partial}{\\partial \\tau} = - \\frac{\\partial}{\\partial \\tau}$. Substituting this into the PDE yields:\n$$\n\\frac{\\partial V}{\\partial \\tau} = \\frac{1}{2}\\sigma^2 S^2 \\frac{\\partial^2 V}{\\partial S^2} + r S \\frac{\\partial V}{\\partial S} - r V\n$$\nThis is a forward diffusion-convection-reaction equation in $\\tau$, which we must solve from $\\tau=0$ to $\\tau=T$. The initial condition at $\\tau=0$ is $V(S,0) = \\max(S-K,0)$.\n\nThe problem requires a numerical scheme that is second-order accurate in both space and time and is unconditionally stable. The Crank-Nicolson finite difference method possesses these properties. We discretize the domain $(S, \\tau) \\in [0, S_{\\max}] \\times [0, T]$ on a uniform grid. Let $S_j = j \\Delta S$ for $j=0, 1, \\dots, M$, where $\\Delta S = S_{\\max}/M$. Let $\\tau_i = i \\Delta \\tau$ for $i=0, 1, \\dots, N$, where $\\Delta \\tau = T/N$. Let $V_j^i$ be the numerical approximation of $V(S_j, \\tau_i)$.\n\nWe approximate the spatial derivatives using second-order central differences:\n$$\n\\frac{\\partial V}{\\partial S} \\bigg|_{S_j,\\tau_i} \\approx \\frac{V_{j+1}^i - V_{j-1}^i}{2 \\Delta S}\n$$\n$$\n\\frac{\\partial^2 V}{\\partial S^2} \\bigg|_{S_j,\\tau_i} \\approx \\frac{V_{j+1}^i - 2V_j^i + V_{j-1}^i}{(\\Delta S)^2}\n$$\nLet $\\mathcal{L}$ be the spatial differential operator on the right-hand side of the transformed PDE. The Crank-Nicolson scheme approximates the PDE as:\n$$\n\\frac{V_j^{i+1} - V_j^i}{\\Delta \\tau} = \\frac{1}{2} \\left[ (\\mathcal{L} V^i)_j + (\\mathcal{L} V^{i+1})_j \\right]\n$$\nRearranging terms separates the unknowns at time level $i+1$ from the knowns at level $i$:\n$$\n\\left(I - \\frac{\\Delta \\tau}{2} \\mathcal{L}_d\\right) V^{i+1} = \\left(I + \\frac{\\Delta \\tau}{2} \\mathcal{L}_d\\right) V^i\n$$\nwhere $\\mathcal{L}_d$ is the discretized spatial operator. This equation represents a system of linear equations for the vector of option values $V^{i+1}$ at the interior spatial nodes $j=1, \\dots, M-1$. The system is tridiagonal. The general equation for an interior node $j$ is:\n$$\nl_j V_{j-1}^{i+1} + d_j V_j^{i+1} + u_j V_{j+1}^{i+1} = l'_j V_{j-1}^i + d'_j V_j^i + u'_j V_{j+1}^i\n$$\nwhere the coefficients are derived by substituting the finite difference approximations into the operator $\\mathcal{L}$. For $S_j=j\\Delta S$, they simplify to:\n$$\nl_j = -\\frac{\\Delta \\tau}{4}(\\sigma^2 j^2 - rj)\n$$\n$$\nd_j = 1 + \\frac{\\Delta \\tau}{2}(\\sigma^2 j^2 + r)\n$$\n$$\nu_j = -\\frac{\\Delta \\tau}{4}(\\sigma^2 j^2 + rj)\n$$\nThe coefficients on the right-hand side are $l'_j = -l_j$, $d'_j = 2 - d_j$, and $u'_j = -u_j$.\n\nAt each time step $i \\to i+1$, we solve the tridiagonal system $A V^{i+1} = \\mathbf{b}$, where $A$ is the matrix with diagonals $(l_j, d_j, u_j)$ and $\\mathbf{b}$ is the vector computed from the right-hand side.\nThe boundary conditions must be incorporated.\nThe condition $V(0, \\tau) = 0$ implies $V_0^i = 0$ for all $i$. This means the first equation of the system (for $j=1$) involves no unknown boundary terms.\nThe condition $V(S_{\\max}, \\tau) = S_{\\max} - Ke^{-r\\tau}$ provides known values for $V_M^i$ at each time step. The term $u_{M-1} V_M^{i+1}$ from the last equation of the system (for $j=M-1$) is known and moved to the right-hand side. The right-hand-side vector $\\mathbf{b}$ is thus modified accordingly before solving the system.\n\nThe procedure is as follows:\n1. Initialize the grid solution at $\\tau=0$ with $V_j^0 = \\max(j\\Delta S - K, 0)$.\n2. For each time step $i$ from $0$ to $N-1$:\n    a. Construct the right-hand-side vector $\\mathbf{b}$ using values from $V^i$.\n    b. Adjust the last element of $\\mathbf{b}$ to account for the boundary condition at $S_{\\max}$.\n    c. Solve the tridiagonal system $A V_{\\text{interior}}^{i+1} = \\mathbf{b}$ for the interior node values $V_1^{i+1}, \\dots, V_{M-1}^{i+1}$. A banded matrix solver is efficient for this.\n    d. Update the full solution vector $V^{i+1}$ with the computed interior values and the boundary values for $\\tau_{i+1}$.\n3. After completing all time steps, the vector $V^N$ contains the option prices at $\\tau=T$ (i.e., time $t=0$).\n4. Linearly interpolate the values in $V^N$ at the specified initial stock price $S_0$ to obtain the final numerical price $C_{\\text{num}}$.\n5. Compute the absolute error $|C_{\\text{num}} - C_{\\text{BSM}}|$, where $C_{\\text{BSM}}$ is the analytical price from the Black-Scholes-Merton formula:\n$$C(S_0, K, r, \\sigma, T) = S_0 N(d_1) - K e^{-rT} N(d_2)$$\n$$d_1 = \\frac{\\ln(S_0/K) + (r + \\frac{1}{2}\\sigma^2)T}{\\sigma\\sqrt{T}}, \\quad d_2 = d_1 - \\sigma\\sqrt{T}$$\nwhere $N(\\cdot)$ is the cumulative distribution function of the standard normal distribution.\n6. For the stability test, the values of $V_j^i$ at all nodes and time steps are checked to ensure they remain finite and within the no-arbitrage bounds $[0, S_{\\max}]$. The unconditional stability of the Crank-Nicolson scheme ensures this holds even for large $\\Delta \\tau$ (small $N$).\n\nThis systematic procedure is implemented in the provided program to solve the given test cases.",
            "answer": "```python\nimport numpy as np\nfrom scipy.stats import norm\nfrom scipy.linalg import solve_banded\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the final result.\n    \"\"\"\n    # Common parameters as specified in the problem\n    S0 = 100.0\n    K = 100.0\n    r = 0.05\n    SIGMA = 0.2\n    T = 1.0\n    S_MAX = 500.0\n\n    def bsm_analytical_price(s, k, rate, sigma, time):\n        \"\"\"Calculates the analytical Black-Scholes-Merton price for a European call.\"\"\"\n        if time == 0:\n            return np.maximum(s - k, 0)\n        d1 = (np.log(s / k) + (rate + 0.5 * sigma**2) * time) / (sigma * np.sqrt(time))\n        d2 = d1 - sigma * np.sqrt(time)\n        price = s * norm.cdf(d1) - k * np.exp(-rate * time) * norm.cdf(d2)\n        return price\n\n    def solve_crank_nicolson(s0, k, rate, sigma, time, s_max, M, N, stability_check=False, tol=1e-8):\n        \"\"\"\n        Solves the Black-Scholes PDE using the Crank-Nicolson finite difference method.\n\n        If stability_check is True, it returns a boolean indicating if the solution\n        remained within bounds [0, s_max] throughout the simulation. Otherwise, it\n        returns the interpolated option price at s0.\n        \"\"\"\n        # Grid setup\n        dS = s_max / M\n        dTau = time / N\n        S_grid = np.linspace(0, s_max, M + 1)\n\n        # Initial condition at tau=0 (which is maturity t=T)\n        V = np.maximum(S_grid - k, 0)\n        \n        if stability_check:\n            if not(np.all(np.isfinite(V)) and np.all((V >= 0 - tol) & (V <= s_max + tol))):\n                return False\n\n        # Coefficients for the tridiagonal system. These are time-independent.\n        j = np.arange(1, M, dtype=np.float64)  # Interior nodes j = 1, ..., M-1\n        \n        # Coefficients for LHS matrix A in A * V_new = b\n        l_j = -0.25 * dTau * (sigma**2 * j**2 - rate * j)\n        d_j = 1.0 + 0.5 * dTau * (sigma**2 * j**2 + rate)\n        u_j = -0.25 * dTau * (sigma**2 * j**2 + rate * j)\n        \n        # LHS matrix A, in banded form for scipy.linalg.solve_banded\n        A = np.zeros((3, M - 1))\n        A[0, 1:] = u_j[:-1]   # Upper diagonal\n        A[1, :] = d_j         # Main diagonal\n        A[2, :-1] = l_j[1:]   # Lower diagonal\n        \n        # Coefficients for RHS matrix B where b = B * V_old\n        l_prime_j = -l_j\n        d_prime_j = 2.0 - d_j\n        u_prime_j = -u_j\n        \n        # Time-stepping loop from tau=0 to tau=T\n        for i in range(N):\n            tau_i_plus_1 = (i + 1) * dTau\n            \n            # Construct RHS vector b = B * V_old\n            rhs_vector = (l_prime_j * V[:-2] + \n                          d_prime_j * V[1:-1] +\n                          u_prime_j * V[2:])\n\n            # Boundary condition adjustments for the RHS vector b\n            bc_upper_i_plus_1 = s_max - k * np.exp(-rate * tau_i_plus_1)\n            rhs_vector[-1] -= u_j[-1] * bc_upper_i_plus_1\n            \n            # Solve the linear system A * V_new = b for interior nodes\n            V_interior_new = solve_banded((1, 1), A, rhs_vector)\n            \n            # Update full solution vector V for the next time step\n            V[1:-1] = V_interior_new\n            V[0] = 0.0  # Lower boundary V(0, t)=0\n            V[-1] = bc_upper_i_plus_1\n            \n            if stability_check:\n                if not (np.all(np.isfinite(V)) and np.all((V >= 0 - tol) & (V <= s_max + tol))):\n                    return False\n                    \n        if stability_check:\n            return True\n\n        # Interpolate to find price at S0 after all time steps\n        numerical_price = np.interp(s0, S_grid, V)\n        return numerical_price\n\n    results = []\n    \n    # Calculate the analytical price once for all comparisons\n    analytical_price = bsm_analytical_price(S0, K, r, SIGMA, T)\n\n    # Test Case 1: (M,N) = (400,400)\n    M1, N1 = 400, 400\n    num_price1 = solve_crank_nicolson(S0, K, r, SIGMA, T, S_MAX, M1, N1)\n    results.append(abs(num_price1 - analytical_price))\n\n    # Test Case 2: (M,N) = (400,4)\n    M2, N2 = 400, 4\n    num_price2 = solve_crank_nicolson(S0, K, r, SIGMA, T, S_MAX, M2, N2)\n    results.append(abs(num_price2 - analytical_price))\n\n    # Test Case 3: (M,N) = (100,100)\n    M3, N3 = 100, 100\n    num_price3 = solve_crank_nicolson(S0, K, r, SIGMA, T, S_MAX, M3, N3)\n    results.append(abs(num_price3 - analytical_price))\n\n    # Test Case 4: Stability Check\n    M4 = 400\n    N_values = [1, 2, 4, 8, 16, 32, 64]\n    overall_stability = True\n    for N_val in N_values:\n        is_stable = solve_crank_nicolson(S0, K, r, SIGMA, T, S_MAX, M4, N_val, stability_check=True)\n        if not is_stable:\n            overall_stability = False\n            break\n    results.append(overall_stability)\n\n    # Print results in the required format\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "An alternative and equally powerful path to the BSM formula is the principle of risk-neutral valuation, which states that a derivative's fair value is the discounted expectation of its future payoffs under a specific risk-neutral probability measure. This exercise solidifies this fundamental concept by tasking you with pricing a non-standard contract: a contingent premium option, where the premium is only paid if the option expires profitably. By applying the core tenet that the initial value of this contract must be zero, you will solve for the fair contingent premium, reinforcing how the elegant framework of risk-neutral expectation allows for the pricing and engineering of novel financial instruments. ",
            "id": "2420974",
            "problem": "Consider a European call written on a dividend-paying stock under the Black-Scholes-Merton (BSM) framework. The stock price process under the risk-neutral measure follows a geometric Brownian motion with constant parameters: spot price $S_0$, volatility $\\sigma$, continuously compounded risk-free rate $r$, and continuous dividend yield $q$. The call has strike $K$ and maturity $T$. You are asked to price a Contingent Premium Option, defined as follows: the buyer pays no premium at initiation; instead, a single premium amount $p$ is paid by the buyer at expiration $T$ only if the option finishes in-the-money. If the option expires out-of-the-money, the buyer pays nothing ever. The option’s payoff to the buyer at time $T$ is therefore $(S_T - K)^{+} - p \\,\\mathbf{1}_{\\{S_T > K\\}}$, where $\\mathbf{1}_{\\{\\cdot\\}}$ is the indicator function.\n\nUsing no-arbitrage and risk-neutral valuation principles, derive the fair premium $p$ that makes the time-$0$ value of the buyer’s cash flows equal to zero. Then evaluate $p$ numerically under the following parameters:\n- $S_0 = 100$,\n- $K = 105$,\n- $r = 0.05$ (continuously compounded, per annum),\n- $q = 0.02$ (per annum),\n- $\\sigma = 0.20$ (per annum),\n- $T = 1$ (year).\n\nAssume the cumulative distribution function of the standard normal distribution is denoted by $N(\\cdot)$. Express your final numerical answer for $p$ in dollars and round your answer to four significant figures.",
            "solution": "The problem as stated is scientifically grounded, well-posed, objective, and contains all necessary information for a unique solution. It is a standard problem in computational finance, specifically the pricing of an exotic option. Therefore, I will proceed with the derivation and calculation.\n\nThe problem asks for the fair premium $p$ of a Contingent Premium Option. The defining characteristic of this contract is that the net value at initiation (time $t=0$) is zero. The buyer's total cash flow occurs at expiration $T$, and is given by the payoff function $V_T = (S_T - K)^{+} - p \\cdot \\mathbf{1}_{\\{S_T > K\\}}$, where $S_T$ is the stock price at time $T$, $K$ is the strike price, and $\\mathbf{1}_{\\{\\cdot\\}}$ is the indicator function. The term $(S_T - K)^{+}$ represents the payoff of a standard European call option, while $p \\cdot \\mathbf{1}_{\\{S_T > K\\}}$ is the contingent premium paid by the buyer to the seller if and only if the option expires in-the-money ($S_T > K$).\n\nAccording to the principle of no-arbitrage, the value of this contract at time $t=0$, denoted $V_0$, must be the risk-neutral expected value of its future cash flows, discounted at the risk-free rate $r$. The problem specifies that this initial value is zero.\n$$V_0 = \\mathbb{E}^{\\mathbb{Q}}\\left[\\exp(-rT) V_T\\right] = 0$$\nwhere $\\mathbb{E}^{\\mathbb{Q}}[\\cdot]$ is the expectation taken under the risk-neutral measure.\n\nSubstituting the payoff $V_T$:\n$$\\mathbb{E}^{\\mathbb{Q}}\\left[\\exp(-rT) \\left( (S_T - K)^{+} - p \\cdot \\mathbf{1}_{\\{S_T > K\\}} \\right) \\right] = 0$$\nBy linearity of expectation, we can separate the terms:\n$$\\mathbb{E}^{\\mathbb{Q}}\\left[\\exp(-rT) (S_T - K)^{+}\\right] - \\mathbb{E}^{\\mathbb{Q}}\\left[\\exp(-rT) p \\cdot \\mathbf{1}_{\\{S_T > K\\}}\\right] = 0$$\nThe first term is, by definition, the price of a standard European call option on a dividend-paying stock in the Black-Scholes-Merton (BSM) framework, which we denote as $C(S_0, K, T, r, q, \\sigma)$. The constant premium $p$ can be taken out of the expectation in the second term.\n$$C(S_0, K, T, r, q, \\sigma) - p \\cdot \\mathbb{E}^{\\mathbb{Q}}\\left[\\exp(-rT) \\mathbf{1}_{\\{S_T > K\\}}\\right] = 0$$\nThe expectation $\\mathbb{E}^{\\mathbb{Q}}\\left[\\exp(-rT) \\mathbf{1}_{\\{S_T > K\\}}\\right]$ is the price of a cash-or-nothing call option that pays a dividend of $1$ dollar at time $T$ if $S_T>K$. Its value is $\\exp(-rT) \\mathbb{Q}(S_T > K)$, where $\\mathbb{Q}(S_T > K)$ is the risk-neutral probability of the option expiring in-the-money.\n\nIn the BSM model, this probability is given by $N(d_2)$, where $N(\\cdot)$ is the cumulative distribution function of the standard normal distribution, and $d_2$ is defined as:\n$$d_2 = \\frac{\\ln(S_0/K) + (r - q - \\sigma^2/2)T}{\\sigma\\sqrt{T}}$$\nThe equation for $p$ thus becomes:\n$$C(S_0, K, T, r, q, \\sigma) = p \\cdot \\exp(-rT) N(d_2)$$\nSolving for $p$:\n$$p = \\frac{C(S_0, K, T, r, q, \\sigma)}{\\exp(-rT) N(d_2)}$$\nThe BSM formula for the price of a European call on a stock with a continuous dividend yield $q$ is:\n$$C(S_0, K, T, r, q, \\sigma) = S_0 \\exp(-qT) N(d_1) - K \\exp(-rT) N(d_2)$$\nwhere\n$$d_1 = \\frac{\\ln(S_0/K) + (r - q + \\sigma^2/2)T}{\\sigma\\sqrt{T}} = d_2 + \\sigma\\sqrt{T}$$\nSubstituting the expression for $C$ into the equation for $p$:\n$$p = \\frac{S_0 \\exp(-qT) N(d_1) - K \\exp(-rT) N(d_2)}{\\exp(-rT) N(d_2)}$$\n$$p = \\frac{S_0 \\exp(-qT) N(d_1)}{\\exp(-rT) N(d_2)} - K$$\n$$p = S_0 \\exp((r-q)T) \\frac{N(d_1)}{N(d_2)} - K$$\nThis expression gives the fair value of the contingent premium $p$. An alternative interpretation is that $p = \\mathbb{E}^{\\mathbb{Q}}[S_T - K | S_T > K]$, which is the expected value of the call payoff, conditional on the call finishing in-the-money.\n\nWe now evaluate $p$ for the given numerical parameters:\n$S_0 = 100$, $K = 105$, $r = 0.05$, $q = 0.02$, $\\sigma = 0.20$, $T = 1$.\n\nFirst, we calculate $d_1$ and $d_2$:\n$$d_1 = \\frac{\\ln(100/105) + (0.05 - 0.02 + 0.20^2/2) \\cdot 1}{0.20 \\cdot \\sqrt{1}}$$\n$$d_1 = \\frac{\\ln(100/105) + (0.03 + 0.04/2)}{0.20} = \\frac{\\ln(100/105) + 0.05}{0.20}$$\n$$d_1 \\approx \\frac{-0.04879016 + 0.05}{0.20} = \\frac{0.00120984}{0.20} \\approx 0.0060492$$\n$$d_2 = d_1 - \\sigma\\sqrt{T} \\approx 0.0060492 - 0.20 \\cdot 1 = -0.1939508$$\nNext, we find the values of the standard normal CDF:\n$$N(d_1) \\approx N(0.0060492) \\approx 0.5024128$$\n$$N(d_2) \\approx N(-0.1939508) \\approx 0.4231365$$\nNow, we can calculate $p$:\n$$p = S_0 \\exp((r-q)T) \\frac{N(d_1)}{N(d_2)} - K$$\n$$p = 100 \\cdot \\exp((0.05-0.02) \\cdot 1) \\cdot \\frac{0.5024128}{0.4231365} - 105$$\n$$p = 100 \\cdot \\exp(0.03) \\cdot (1.187342) - 105$$\n$$p \\approx 100 \\cdot (1.0304545) \\cdot (1.187342) - 105$$\n$$p \\approx 122.3483 - 105 = 17.3483$$\nRounding to four significant figures, we obtain $p = 17.35$.",
            "answer": "$$\\boxed{17.35}$$"
        }
    ]
}