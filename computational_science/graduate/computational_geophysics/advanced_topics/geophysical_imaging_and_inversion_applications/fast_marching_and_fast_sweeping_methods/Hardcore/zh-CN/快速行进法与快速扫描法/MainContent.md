## 引言
在众多科学与工程领域，从预测地震波如何穿透地壳，到规划机器人在复杂环境中的最优路径，一个共同的核心挑战是高效地计算“首达时间”或“最短路径”。解决这一挑战的关键工具之一是程函方程（Eikonal Equation），一个描述波前传播的[非线性偏微分方程](@entry_id:169481)。然而，其[非线性](@entry_id:637147)特性使得求解颇具难度。[快速行进法](@entry_id:749232)（Fast Marching Method, FMM）和[快速扫描法](@entry_id:749242)（Fast Sweeping Method, FSM）作为两种开创性的数值方法，为高效、准确地求解程函方程提供了强大的计算框架，已成为计算地球物理及其他多个领域的基石。

本文旨在为读者提供对FMM和FSM全面而深入的理解。我们不仅将剖析它们共同的理论基础和各自独特的算法逻辑，还将展示它们在不同学科中的广泛应用，弥合理论与实践之间的鸿沟。

在第一章“原理与机制”中，我们将追溯到程函方程的物理起源，探讨其数学解的性质，并详细解释保证[数值稳定性](@entry_id:146550)和准确性的[迎风](@entry_id:756372)离散格式。随后，我们将拆解FMM和FSM的算法步骤，并对它们的计算性能进行比较。在第二章“应用与跨学科连接”中，我们将通过一系列实例，展示这些方法如何解决地球物理、计算几何、[机器人学](@entry_id:150623)和[流体力学](@entry_id:136788)等领域的实际问题。最后，在第三章“动手实践”中，我们提供了一系列精心设计的编程练习，旨在帮助读者将理论知识转化为解决实际问题的能力。通过这一结构化的学习路径，读者将能够掌握这两种强大的计算工具，并有能力将它们应用于自己的研究和工作中。

## 原理与机制

本章旨在深入剖析用于计算地震波走时的两大核心算法——[快速行进法](@entry_id:749232)（Fast Marching Method, FMM）和[快速扫描法](@entry_id:749242)（Fast Sweeping Method, FSM）的根本原理与内在机制。我们将从其物理和数学基础，即程函方程（Eikonal Equation）出发，探讨其解的性质，进而阐明保证数值计算收敛于物理真实解的离散化方案。最后，我们将详细拆解FMM和FSM各自的算法逻辑，并对它们的性能进行比较，为在具体地球物理问题中选择合适的方法提供理论依据。

### 程函方程：控制原理

FMM和FSM的核心目标都是求解一个[非线性偏微分方程](@entry_id:169481)——程函方程。该方程精确地描述了在[高频近似](@entry_id:750288)下[波前](@entry_id:197956)传播的[运动学](@entry_id:173318)行为。理解此方程的来源和性质，是掌握这两种算法的关键。

#### 物理推导：[费马原理](@entry_id:175608)与[高频近似](@entry_id:750288)

程函方程可以通过两种等价的物理视角导出：变分原理和[波动方程](@entry_id:139839)的[渐近分析](@entry_id:160416)。

首先，从**[费马原理](@entry_id:175608)（Fermat's Principle）**出发，该原理指出，波在两点之间传播的路径是走时最短的路径。在一个[非均匀介质](@entry_id:750241)中，声波速度 $c(\mathbf{x})$ 在空间上变化，我们通常使用其倒数，即**慢度（slowness）** $s(\mathbf{x}) = 1/c(\mathbf{x})$ 来描述介质。波从源点集合 $\Gamma$ 传播到空间中任意一点 $\mathbf{x}$ 的首次到达走时 $T(\mathbf{x})$，可以表示为沿所有可能的传播路径 $\gamma$ 的走时积分的[下确界](@entry_id:140118)：
$$
T(\mathbf{x}) = \inf_{\gamma: \Gamma \to \mathbf{x}} \int_{\gamma} s(\mathbf{y}) \, d\ell
$$
其中 $d\ell$ 是路径的[弧长](@entry_id:191173)微元。这个[变分问题](@entry_id:756445)可以通过哈密顿-雅可比（Hamilton-Jacobi）理论转化为一个[偏微分方程](@entry_id:141332)。其核心思想是，最优路径的任何子路径也必然是最优的。这导致了一个局部关系，即走时场 $T(\mathbf{x})$ 的梯度模量等于该点的慢度。这便是**程函方程**：
$$
|\nabla T(\mathbf{x})| = s(\mathbf{x})
$$
方程的边界条件是在源点处走时为零，即 $T(\mathbf{x}) = 0, \forall \mathbf{x} \in \Gamma$。这个方程直观地解释了[波前](@entry_id:197956)的局部传播速度：波前在某点的法向传播速度等于该点的声波速度 $c(\mathbf{x})$。

其次，程函方程也可以从更基本的**标量声波[波动方程](@entry_id:139839)**中推导出来。在一个无密度变化的非均匀[声学](@entry_id:265335)介质中，压[力场](@entry_id:147325) $u(\mathbf{x}, t)$ 满足：
$$
s^2(\mathbf{x}) \frac{\partial^2 u}{\partial t^2} - \nabla^2 u = 0
$$
在**高频（或[几何光学](@entry_id:175509)）近似**下，我们寻找一个形式为 $u(\mathbf{x}, t) \approx A(\mathbf{x}, \omega) \exp(i\omega(T(\mathbf{x}) - t))$ 的解，其中[角频率](@entry_id:261565) $\omega \to \infty$。这里，$T(\mathbf{x})$ 是相位函数，我们将其诠释为走时。将此解代入波动方程，并保留 $\omega$ 的最高阶（$\mathcal{O}(\omega^2)$）项，我们发现为了使方程成立，必须满足：
$$
\omega^2 |\nabla T(\mathbf{x})|^2 - \omega^2 s^2(\mathbf{x}) = 0
$$
这直接导出了 $| \nabla T(\mathbf{x}) |^2 = s^2(\mathbf{x})$，即程函方程。这个推导明确指出，程函方程是[几何光学](@entry_id:175509)领域的控制方程，它在波长远小于介质不[均匀性](@entry_id:152612)尺度时成立。

值得注意的是，程函方程是一个近似模型。通过更精细的WKB[渐近分析](@entry_id:160416)可以发现，由程函方程计算得到的走时 $T(\mathbf{x})$ 与真实波动方程的[群延迟](@entry_id:267197)（group delay）之间存在一个**[建模误差](@entry_id:167549)**。在远离焦散区（caustics）的光滑介质中，这个误差的主阶项为 $\mathcal{O}(\omega^{-2})$。这意味着频率越高，程函方程的解就越接近真实的物理走时。

#### 数学性质与[粘性解](@entry_id:177596)的必要性

程函方程是一个一阶、[非线性](@entry_id:637147)的[哈密顿-雅可比方程](@entry_id:145701)。这类方程的解，即使在慢度场 $s(\mathbf{x})$ 非常光滑的情况下，也可能出现导数不连续的现象，例如[波前](@entry_id:197956)的汇聚会形成激波或焦散。

一个简单的一维例子可以很好地说明这一点。考虑一个一维空间，源点在 $x_s = -L$，慢度函数在 $x=0$ 处发生阶跃：$s(x) = s_-$（当 $x < 0$）和 $s(x) = s_+$（当 $x \ge 0$），其中 $s_- \neq s_+$。根据[费马原理](@entry_id:175608)，走时是慢度沿直线路径的积分 $T(x) = \int_{-L}^{x} s(\xi) d\xi$。这给出了一个[分段线性](@entry_id:201467)的走时场：
$$
T(x) = \begin{cases} s_{-}(x+L)  & \text{if } -L \le x < 0 \\ s_{-}L + s_{+}x  & \text{if } x \ge 0 \end{cases}
$$
这个函数 $T(x)$ 在 $x=0$ 处是连续的，但其导数 $T'(x)$ 在该点发生跳跃，从 $s_-$ 变为 $s_+$。除非 $s_- = s_+$，否则 $T(x)$ 在 $x=0$ 处存在一个“尖角”（corner），是不可导的。这意味着，我们无法找到一个在整个定义域上都可微的**经典解**（classical solution）。然而，这个从[费马原理](@entry_id:175608)直接导出的走时场无疑是物理上正确的解。

为了解决这个问题，数学家们引入了**[粘性解](@entry_id:177596)（viscosity solution）**的概念。[粘性解](@entry_id:177596)是一种弱解，它不要求处处可微，但能唯一地确定物理相关的解，即使在解出现尖角或激波时也是如此。其基本思想是通过给原方程添加一个微小的“粘性项”（如 $\varepsilon \Delta T$），将一阶方程变为一个光滑的二阶方程，然后取粘性系数 $\varepsilon \to 0$ 的极限。这个极限解就是唯一的、稳定的[粘性解](@entry_id:177596)。所有现代的程函方程数值解法，包括FMM和FSM，其目标都是收敛到这个[粘性解](@entry_id:177596)。

[粘性解](@entry_id:177596)理论为程函方程的求解提供了坚实的数学基础。它保证了在相当宽松的条件下解的存在性和唯一性。具体而言，如果在一个有界、开、路径连通的区域 $\Omega$ 上，慢度场 $s(\mathbf{x})$ 是连续的，并且存在一个严格为正的下界（即 $0 < s_{\min} \le s(\mathbf{x})$），那么从源点 $\mathbf{x}_s \in \Omega$ 出发的程函方程存在唯一的连续[粘性解](@entry_id:177596)。

$s(\mathbf{x})$ 必须有严格为正的下界这一条件至关重要。如果 $s(\mathbf{x})$ 在某些区域趋于零（即速度 $c(\mathbf{x})$ 趋于无穷大），这不是问题。但如果速度 $c(\mathbf{x})$ 在某个区域趋于零，即慢度 $s(\mathbf{x})$ 趋于无穷大，则可能导致走时无限。更严重的是，如果速度 $c(\mathbf{x})$ 等于零（慢度无穷大），该点将成为不可逾越的障碍，走时场会在此处产生不连续，破坏解的[适定性](@entry_id:148590)。在实际计算中，若存在 $c(\mathbf{x})=0$ 的区域，[哈密顿量](@entry_id:172864) $H(\mathbf{p},\mathbf{x}) = |\mathbf{p}| - s(\mathbf{x})$ 会失去对其梯度 $\mathbf{p}$ 的严格单调性，导致[数值格式](@entry_id:752822)失效。一种常见的处理方法是进行**正则化**，例如，强制设定一个速度下限 $c_{\varepsilon}(\mathbf{x}) = \max\{c(\mathbf{x}), \varepsilon\}$，其中 $\varepsilon$ 是一个很小的正数，从而保证慢度的有界性，恢复算法的稳定性和收敛性。

### [数值离散化](@entry_id:752782)：[迎风](@entry_id:756372)[戈杜诺夫格式](@entry_id:749949)

为了在计算机上求解程函方程，我们首先需要将其离散化。程函方程描述的是一个信息[单向传播](@entry_id:174820)的过程——[波前](@entry_id:197956)总是从走时小的区域向走时大的区域扩展。这种固有的**因果性（causality）**要求[数值格式](@entry_id:752822)必须能够捕捉信息的传播方向。因此，**[迎风格式](@entry_id:756374)（upwind scheme）**成为必然选择。

在二维均匀网格上，点 $(i,j)$ 处的程函方程 $| \nabla T |^2 = s^2$ 可以离散为：
$$
(\partial_x T)^2 + (\partial_y T)^2 = s_{i,j}^2
$$
其中，偏导数项 $\partial_x T$ 和 $\partial_y T$ 使用单边差分来近似，并且差分方向的选择取决于信息的来源，即“[迎风](@entry_id:756372)”方向。例如，$\partial_x T$ 的近似可以写成：
$$
\partial_x T \approx \max\left(\frac{T_{i,j}-T_{i-1,j}}{h}, 0\right) - \min\left(\frac{T_{i+1,j}-T_{i,j}}{h}, 0\right)
$$
这个式子保证了在计算 $T_{i,j}$ 时，只会用到那些走时比 $T_{i,j}$ 小的邻居节点的值。一个经典的戈杜诺夫型（Godunov-type）迎风格式将离散方程写为：
$$
\left[ \max\left(D_x^{-}T, -D_x^{+}T, 0\right) \right]^2 + \left[ \max\left(D_y^{-}T, -D_y^{+}T, 0\right) \right]^2 = s_{i,j}^2
$$
其中 $D_x^{-}T = (T_{i,j} - T_{i-1,j})/h$ 等是向前或[向后差分](@entry_id:637618)。当求解 $T_{i,j}$ 时，我们会假设 $T_{i,j}$ 大于其所有[迎风](@entry_id:756372)邻居，从而将上式简化为一个关于 $T_{i,j}$ 的二次方程。

然而，一个关键的细节是，[波前](@entry_id:197956)并非总是从对角线方向（同时受 $x$ 和 $y$ 方向邻居影响）到达。它也可能主要沿一个坐标轴方向传播。一个正确的迎风格式必须包含一个**离散[熵条件](@entry_id:166346)（discrete entropy condition）**或**因果性开关**，来决定是使用二维更新还是更简单的一维更新。

假设我们[正根](@entry_id:199264)据已知的左邻居 $T_{i-1,j}=a$ 和下邻居 $T_{i,j-1}=b$ 的值来更新 $T_{i,j}$。该离散[熵条件](@entry_id:166346)如下：
1.  如果 $|a-b| \ge sh$（其中 $s$ 是慢度，$h$ 是网格间距），这意味着一个邻居的波前远远领先于另一个。此时，传播被认为是**一维的**。走时更新公式为：
    $$
    T_{i,j} = \min(a,b) + sh
    $$
2.  如果 $|a-b| < sh$，这意味着两个邻居的[波前](@entry_id:197956)足够接近，它们会共同影响 $T_{i,j}$。此时，传播被认为是**二维的**，需要求解二次方程：
    $$
    \left(\frac{T_{i,j}-a}{h}\right)^2 + \left(\frac{T_{i,j}-b}{h}\right)^2 = s^2
    $$
    解这个关于 $T_{i,j}$ 的方程（并取较大根以保证 $T_{i,j} > \max(a,b)$），得到：
    $$
    T_{i,j} = \frac{a+b + \sqrt{2(sh)^2 - (a-b)^2}}{2}
    $$

让我们通过一个具体例子来理解这个机制。假设 $h=1, s=1$，并且两个相邻的源点使得 $a=0, b=0$。我们来计算它们共同的邻居 $(i,j)$ 的走时。首先检查[熵条件](@entry_id:166346)：$|a-b|=|0-0|=0$，而 $sh=1$。因为 $0 < 1$，我们使用二维更新公式：
$$
T_{i,j} = \frac{0+0 + \sqrt{2(1)^2 - (0)^2}}{2} = \frac{\sqrt{2}}{2} \approx 0.707
$$
这个结果符合直觉：从 $(0,0)$ 处以单位速度传播到 $(1,1)$ 的对角线一半位置，走时为 $\sqrt{2}/2$。如果错误地使用一维更新，会得到 $T_{i,j}=1$，这对应于一个正方形的波前，而非物理上正确的圆形[波前](@entry_id:197956)。这个迎风格式及其[熵条件](@entry_id:166346)是FMM和FSM能够收敛到正确[粘性解](@entry_id:177596)的基石。

### 算法机制：[快速行进法](@entry_id:749232)与[快速扫描法](@entry_id:749242)

基于上述的[迎风](@entry_id:756372)离散格式，FMM和FSM采用不同的全局策略来系统地求解整个计算域上的走时场。

#### [快速行进法](@entry_id:749232)（FMM）：一种标签设置方法

[快速行进法](@entry_id:749232)是一种**标签设置（label-setting）**算法，其思想与图论中的[Dijkstra算法](@entry_id:273943)如出一辙。它将网格节点分为三个集合：
- **已接受（Accepted）**：走时已确定为最终值的节点。
- **窄带（Narrow Band）**：已接受节点的邻居，拥有一个临时的、可能会被更新的走时值。
- **[远区](@entry_id:185115)（Far Away）**：尚未被触及的节点。

FMM的算法流程如下：
1.  将所有源点节点的走时设为0，并放入“已接受”集合。将其所有邻居节点加入“窄带”集合，并计算它们的临时走时。
2.  使用一个**[最小优先队列](@entry_id:636722)（min-priority queue）**，通常是[二叉堆](@entry_id:636601)（binary heap），来存储所有“窄带”节点，并按其临时走时值排序。
3.  循环执行以下操作，直到所有节点都被接受：
    a. 从[优先队列](@entry_id:263183)中提取拥有全局最小临时走时值的节点，记为 $P_{min}$。
    b. 将 $P_{min}$ 从“窄带”移至“已接受”集合。此后，它的走时值将被“冻结”，不再改变。
    c. 对于 $P_{min}$ 的每一个非“已接受”的邻居，使用迎风格式更新其走时。如果新计算的走时更小，则更新该邻居在[优先队列](@entry_id:263183)中的值。

FMM的核心优势在于其**正确性无需回溯**。一旦一个节点被接受，其走时就是最终解。这得益于程函方程的因果性和[迎风格式](@entry_id:756374)的**单调性（monotonicity）**。单调性意味着，一个节点的走时是其[迎风](@entry_id:756372)邻居走时的非减函数。因此，当算法选择全局走时最小的节点 $P_{min}$ 时，它保证了不可能再有另一条通过尚未接受的（因此走时值更大的）节点的路径，能以更短的时间到达 $P_{min}$。

这个特性使得FMM在处理[复杂介质](@entry_id:164088)时表现得非常稳健。例如，当波前遇到一个低速异常体（速度慢，慢度高）时，波会选择绕行。FMM的机制能够自然地处理这种情况：直接穿过低速区的路径因为慢度高而累积了较大的走时，而绕行路径的走时则相对较小。[优先队列](@entry_id:263183)会自动地优先扩展绕行路径上的节点，从而正确地计算出低速区后方“阴影区”的绕射波走时，而无需任何特殊的几何判断或逻辑。

然而，FMM的这种严格依赖全局最小值的特性也带来了其主要缺点：**难以[并行化](@entry_id:753104)**。每一步计算都依赖于前一步在整个窄带上找到的[全局最小值](@entry_id:165977)，这构成了一个固有的串行瓶颈。在现代计算架构上，这限制了其处理大规模问题的效率。其[串行计算](@entry_id:273887)复杂度通常为 $\mathcal{O}(N \log N)$，其中 $N$ 是网格点总数，$\log N$ 来自于[优先队列](@entry_id:263183)的操作。为了实现并行，研究者们提出了一些近似FMM算法，例如使用**桶式队列（bucket queue）**。这种方法将窄带节点按走时值放入宽度为 $\delta$ 的桶中，并并行处理一个桶内的所有节点。这种做法牺牲了严格的顺序，但引入的误差可以被有效控制，通常误差上界与桶宽 $\delta$ 成正比。

#### [快速扫描法](@entry_id:749242)（FSM）：一种标签校正方法

与FMM不同，[快速扫描法](@entry_id:749242)是一种**标签校正（label-correcting）**算法，其思想更接近于迭代法，如高斯-赛德尔（Gauss-Seidel）迭代。FSM不使用[优先队列](@entry_id:263183)，而是通过在整个计算域上反复进行有序的**扫描（sweeping）**来更新走时值，直到收敛。

FSM的算法机制如下：
1.  初始化源点走时为0，其他所有点的走时为无穷大。
2.  循环执行一系列固定方向的扫描，直到所有节点的走时值不再变化。
3.  一次完整的迭代包含覆盖所有“象限”或“卦限”的扫描。在二维情况下，这通常是**4次扫描**：
    - $i$ 从 $1$ 到 $N_x$, $j$ 从 $1$ 到 $N_y$ （右下方向）
    - $i$ 从 $N_x$ 到 $1$, $j$ 从 $1$ 到 $N_y$ （左下方向）
    - $i$ 从 $N_x$ 到 $1$, $j$ 从 $N_y$ 到 $1$ （左上方向）
    - $i$ 从 $1$ 到 $N_x$, $j$ 从 $N_y$ 到 $1$ （右上方向）
    在三维情况下，则需要覆盖8个卦限的**8次扫描**。
4.  在每次扫描中，按特定顺序遍历所有网格点。在访问每个点时，使用迎风格式（与FMM中使用的完全相同），并利用其邻居节点**当前最新**的走时值来计算并更新该点的走时。

FSM的巧妙之处在于，通过高斯-赛德尔式的即时更新和覆盖所有方向的扫描顺序，信息可以在单次扫描中沿特征线（即射线路径）方向快速传播。例如，第一次扫描（$i\uparrow, j\uparrow$）可以有效地计算出所有从左下方传播而来的[波前](@entry_id:197956)的走时。通过完整的一轮（4次或8次）扫描，算法确保了所有可能的传播方向都得到了有效处理。当介质复杂导致射线弯曲时，可能需要多轮扫描迭代才能使信息沿着弯曲的路径传播到整个区域并最终收敛。

FSM的主要优点是实现简单，不需要复杂的[数据结构](@entry_id:262134)（如[优先队列](@entry_id:263183)），并且由于其迭代和局部计算的性质，它**更易于并行化**。

### 对比分析与应用准则

FMM和FSM虽然都求解同一个离散方程，但其算法策略的差异导致了性能上的不同，使得它们在不同场景下各有优劣。

从计算复杂度的角度看：
- **FMM**的复杂度为 $\mathcal{O}(N \log N)$，其中 $N$ 是网格点总数。这个复杂度主要由对数项决定，与介质的物理性质（如速度变化）无关。
- **FSM**的复杂度为 $\mathcal{O}(K \cdot N)$，其中 $K$ 是收敛所需的总扫描次数。与FMM不同，FSM的性能**强烈依赖于介质的复杂性**。

决定FSM收敛速度的关键因素是**射线路径的弯曲程度**。在均匀介质中，射线是直线，FSM仅需一轮迭代（即2D中4次扫描，3D中8次扫描）即可收敛，此时其复杂度为 $\mathcal{O}(N)$，优于FMM。然而，当介质[速度场](@entry_id:271461)变化剧烈，导致射线路径显著弯曲甚至掉头时，信息需要通过多轮迭代才能沿着曲折的路径传播，这会导致 $K$ 值增大。

我们可以用一个无量纲的**曲率数** $C = \kappa_{\max} D$ 来量化介质的复杂性，其中 $\kappa_{\max}$ 是射线的最大曲率， $D$ 是计算[域的特征](@entry_id:154386)尺度。理论和实践表明，FSM的收敛扫描次数 $K$ 与 $C$ 近似成正比。这就为[选择算法](@entry_id:637237)提供了一个清晰的准则：
- 当介质相对简单，射线路径平直或弯曲不大时（即**$C$ 较小**），FSM收敛快，其 $\mathcal{O}(C \cdot N)$ 的复杂度通常优于FMM的 $\mathcal{O}(N \log N)$。
- 当介质极其复杂，射线路径高度弯曲时（即**$C$ 较大**），FSM可能需要大量迭代才能收敛，此时FMM的 $\mathcal{O}(N \log N)$ 复杂度可能反而更具优势。

一个简单的判据是比较 $C$ 和 $\log N$ 的大小：若 **$C \ll \log N$**，倾向于使用FSM；若 **$C \gtrsim \log N$**，则FMM可能是更好的选择。

综上所述，FMM和FSM都是求解程函方程的强大工具。FMM是一种精确的、单遍的、但本质上串行的方法；而FSM是一种迭代的、易于实现和并行、且在许多实际地球物理场景中（其中射线路径不过于曲折）表现更高效的方法。对它们背后共同的物理原理、数学基础和各自独特的算法机制的深刻理解，是进行高效准确的[地震波](@entry_id:164985)[走时计算](@entry_id:756149)和反演的前提。