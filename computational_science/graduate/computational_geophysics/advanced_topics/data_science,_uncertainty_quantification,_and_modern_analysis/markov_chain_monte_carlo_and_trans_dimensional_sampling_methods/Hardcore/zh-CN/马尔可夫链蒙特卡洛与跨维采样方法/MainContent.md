## 引言
在现代计算科学，尤其是在地球物理学中，[贝叶斯反演](@entry_id:746720)为我们提供了一个强大的框架，用于从不完整的、含噪声的观测数据中推断复杂的物理模型，并严格量化其不确定性。然而，当物理模型是[非线性](@entry_id:637147)的，或先验知识与[噪声模型](@entry_id:752540)并非简单的高斯分布时，描述模型参数的[后验概率](@entry_id:153467)[分布](@entry_id:182848)往往没有解析解，这使得直接进行推断变得异常困难。更进一步，我们常常连模型本身的复杂度（例如，地下介质应包含多少个地层）都无法确定，这构成了科学探索中的一个核心知识缺口。

为了应对这些挑战，马尔可夫链蒙特卡洛（MCMC）及其跨维扩展方法应运而生，它们提供了一套通用的数值计算工具箱，能够从任意复杂甚至维度可变的[后验分布](@entry_id:145605)中进行采样，从而近似地重构出完整的解。本文旨在系统性地介绍这些前沿的计算方法，为研究生及相关领域的研究人员提供一份深入的理论与实践指南。

在接下来的内容中，我们将分三步展开：
- **第一章：原理与机制** 将深入剖析[MCMC方法](@entry_id:137183)得以成立的数学基石，包括细致平衡、遍历性等，并介绍Metropolis-Hastings、[吉布斯采样](@entry_id:139152)等核心算法。本章还将重点讲解用于解决多模态问题的并行[回火](@entry_id:182408)技术，以及实现模型选择的[可逆跳转MCMC](@entry_id:754338)（[RJMCMC](@entry_id:754374)）框架。
- **第二章：应用与跨学科连接** 将展示这些方法在解决实际问题中的威力，从优化[高维采样](@entry_id:137316)效率的先进技术，到跨越[地球物理学](@entry_id:147342)、演化生物学、[材料科学](@entry_id:152226)等多个领域的具体案例，揭示其作为科学发现引擎的通用性。
- **第三章：动手实践** 将通过一系列精心设计的问题，引导读者将理论知识应用于实践，从计算[雅可比行列式](@entry_id:137120)到构建一个完整的[跨维采样](@entry_id:756096)器，巩固对核心概念的理解。

通过学习本文，读者将能够理解MCMC和[跨维采样](@entry_id:756096)的核心思想，并掌握在自己的研究领域中应用这些强大工具解决复杂反演和模型选择问题的能力。

## 原理与机制

本章旨在深入探讨支撑现代[计算地球物理学](@entry_id:747618)中[贝叶斯反演](@entry_id:746720)的[马尔可夫链蒙特卡洛](@entry_id:138779)（MCMC）方法及其跨维扩展的核心原理与机制。在前一章介绍贝叶斯思想的基础上，我们将从基本概念出发，逐步构建起一套能够处理复杂、高维乃至维度可变模型的强大工具。

### [贝叶斯反演](@entry_id:746720)的基石

[贝叶斯反演](@entry_id:746720)的核心任务是根据观测数据 $d$、物理模型（或称正演算子）$G$ 以及关于模型参数 $m$ 和噪声 $e$ 的先验知识，来推断模型参数的[后验概率](@entry_id:153467)[分布](@entry_id:182848) $p(m \mid d)$。这个[后验分布](@entry_id:145605)不仅给出了模型参数的最可能取值，更重要的是，它完整地刻画了在给定数据和[先验信念](@entry_id:264565)下，我们对模型参数认知的不确定性。

为了理解[采样方法](@entry_id:141232)的必要性，我们首先考察一个理想化的线性高斯问题 。假设一个线性地球物理正演模型可以表示为 $d = Gm + e$，其中数据向量 $d \in \mathbb{R}^{n_d}$，模型参数向量 $m \in \mathbb{R}^{n_m}$，正演算子 $G$ 是一个已知的 $n_d \times n_m$ 矩阵。我们进一步假设噪声 $e$ 服从均值为零、协方差矩阵为 $C_e$ 的高斯分布，即 $e \sim \mathcal{N}(0, C_e)$；同时，对模型参数的先验知识也由一个高斯分布描述，即 $m \sim \mathcal{N}(m_0, C_m)$。

在这种特定情况下，似然函数 $p(d \mid m)$ 和先验分布 $p(m)$ 均为高斯形式：
$$
p(d \mid m) \propto \exp\left( -\frac{1}{2} (d - Gm)^\top C_e^{-1} (d - Gm) \right)
$$
$$
p(m) \propto \exp\left( -\frac{1}{2} (m - m_0)^\top C_m^{-1} (m - m_0) \right)
$$

根据贝叶斯定理 $p(m \mid d) \propto p(d \mid m) p(m)$，两个高斯分布的乘积仍然是[高斯分布](@entry_id:154414)。经过推导，后验分布 $p(m \mid d)$ 是一个均值为 $m_{\text{post}}$、协方差矩阵为 $C_{\text{post}}$ 的多维[高斯分布](@entry_id:154414) $\mathcal{N}(m_{\text{post}}, C_{\text{post}})$，其参数具有解析形式：
$$
C_{\text{post}} = \left(G^{\top} C_e^{-1} G + C_m^{-1}\right)^{-1}
$$
$$
m_{\text{post}} = C_{\text{post}}\left(G^{\top} C_e^{-1} d + C_m^{-1} m_0\right)
$$

这个解析解是[贝叶斯反演](@entry_id:746720)的典范。[后验均值](@entry_id:173826) $m_{\text{post}}$ 代表了由数据和先验共同决定的最优模型估计，而后验协[方差](@entry_id:200758) $C_{\text{post}}$ 则定量地描述了该估计的不确定性。$C_{\text{post}}$ 的对角线元素给出了每个模型参数的后验[方差](@entry_id:200758)，而非对角线元素则揭示了参数间的相关性。$C_{\text{post}}$ 的特征结构（[特征值](@entry_id:154894)和[特征向量](@entry_id:151813)）可以告诉我们模型[参数空间](@entry_id:178581)中哪些方向被数据和先验约束得很好，哪些方向仍然存在较大的不确定性。

对于这类线性高斯问题，由于后验分布具有封闭的解析形式，我们无需借助MCMC等[采样方法](@entry_id:141232)就能完整地刻画解。此外，由于模型维度 $n_m$ 是固定的，诸如可逆跳跃MCMC（[RJMCMC](@entry_id:754374)）等跨维方法在此也无用武之地。然而，在绝大多数真实的[地球物理反演](@entry_id:749866)问题中，正演模型 $G$ 是[非线性](@entry_id:637147)的，或者[先验分布](@entry_id:141376)和[噪声模型](@entry_id:752540)并非[高斯分布](@entry_id:154414)。在这些情况下，[后验分布](@entry_id:145605) $p(m \mid d)$ 不再具有简单的解析形式，我们无法直接写出其均值和协[方差](@entry_id:200758)。这正是[MCMC方法](@entry_id:137183)发挥关键作用的领域：它们提供了一种从任意复杂的[目标分布](@entry_id:634522)中生成样本的通用框架，从而让我们能够近似地探索和描述后验分布。

### [马尔可夫链蒙特卡洛](@entry_id:138779)（MCMC）的核心原理

[MCMC方法](@entry_id:137183)的核心思想是构造一个特殊的马尔可夫链，使其状态在参数空间中游走，并最终收敛到一个平稳分布，而这个平稳分布恰好就是我们想要采样的目标[后验分布](@entry_id:145605) $p(m \mid d)$。一旦链达到平稳状态，其后续生成的样本就可以被看作是来自[后验分布](@entry_id:145605)的（相关的）抽样，我们可以利用这些样本来计算各种统计量（如均值、[方差](@entry_id:200758)、可信区间等）。

为了确保[MCMC采样](@entry_id:751801)器的正确性和有效性，其构造的[马尔可夫链](@entry_id:150828)必须满足一系列理论性质。对于定义在通用[状态空间](@entry_id:177074) $(\mathcal{X}, \mathcal{B})$ 上的[马尔可夫链](@entry_id:150828)，其转移由一个转移核 $K(x, dy)$ 描述，表示从状态 $x$ 转移到集合 $A \in \mathcal{B}$ 的概率为 $K(x, A) = \int_A K(x, dy)$。以下是保证[MCMC方法](@entry_id:137183)收敛的四个关键属性 ：

**[平稳性](@entry_id:143776) (Stationarity)**
一个[概率测度](@entry_id:190821) $\pi$ 被称为转移核 $K$ 的**[平稳分布](@entry_id:194199)**（或[不变分布](@entry_id:750794)），如果从 $\pi$ [分布](@entry_id:182848)中抽取一个状态，经过一次马尔可夫转移后，新状态的[分布](@entry_id:182848)仍然是 $\pi$。用数学语言表达为：
$$
\int_{\mathcal{X}} \pi(dx) K(x, A) = \pi(A), \quad \forall A \in \mathcal{B}
$$
在MCMC中，我们的目标就是设计一个转移核 $K$，使其[平稳分布](@entry_id:194199)是我们想要采样的[后验分布](@entry_id:145605) $\pi(m) = p(m \mid d)$。

**细致平衡 (Detailed Balance)**
[细致平衡](@entry_id:145988)是比[平稳性](@entry_id:143776)更强的条件，它为构造满足[平稳性](@entry_id:143776)的转移核提供了极大的便利。它要求在平稳状态下，任意两个状态（或状态微元）之间的“流量”是双向平衡的。对于状态 $x$ 和 $y$，[细致平衡条件](@entry_id:265158)写作：
$$
\pi(dx) K(x, dy) = \pi(dy) K(y, dx)
$$
这意味着从一个微小区域 $dx$ 转移到另一个微小区域 $dy$ 的概率通量，等于从 $dy$ 反向转移到 $dx$ 的概率通量。满足[细致平衡条件](@entry_id:265158)的链自动满足[平稳性](@entry_id:143776)，因为对上式两边关于 $y$ 积分即可得到[平稳性条件](@entry_id:191085)。几乎所有[MCMC算法](@entry_id:751788)（如Metropolis-Hastings）都是通过构造满足细致平衡的转移来实现的。

**不可约性 (Irreducibility)**
不可约性，或称遍历性，确保马尔可夫链有能力从任何初始状态出发，最终访问到参数空间中所有“重要”的区域。在通用状态空间中，这意味着对于某个参照测度 $\psi$（通常取目标分布 $\pi$），从任意点 $x \in \mathcal{X}$ 出发，到达任何测度 $\psi(A) > 0$ 的集合 $A$ 的概率在有限步数内都大于零。形式上，存在一个 $\sigma$-[有限测度](@entry_id:183212) $\psi$，使得对任意 $x \in \mathcal{X}$ 和任意 $\psi(A) > 0$ 的集合 $A \in \mathcal{B}$，都存在一个整数 $n \ge 1$ 使得 $n$ 步转移概率 $K^n(x, A) > 0$。

**非周期性 (Aperiodicity)**
[非周期性](@entry_id:275873)确保链不会陷入确定的循环中。一个不可约的链如果是周期的（周期为 $d > 1$），则状态空间可以被划分为 $d$ 个[子集](@entry_id:261956) $D_0, \dots, D_{d-1}$，链会确定性地从 $D_i$ 转移到 $D_{(i+1) \pmod d}$。非周期性排除了这种情况，保证了链的混合行为，使其能够收敛到平稳分布，而不是在几个[子集](@entry_id:261956)之间[振荡](@entry_id:267781)。

当一个[MCMC采样](@entry_id:751801)器所构造的马尔可夫链满足不可约性和非周期性，并且以目标后验分布为平稳分布时，[遍历定理](@entry_id:261967)保证了链的样本均值会收敛到真实的[期望值](@entry_id:153208)。

### [MCMC算法](@entry_id:751788)的构建模块

#### Metropolis-Hastings 算法

Metropolis-Hastings (MH) 算法是构造[MCMC采样](@entry_id:751801)器的通用“秘方”。它通过一个“提议-接受/拒绝”机制来确保[细致平衡条件](@entry_id:265158)得以满足。其步骤如下：
1.  给定当前状态 $m^{(t)}$。
2.  从一个**提议分布 (proposal distribution)** $q(m' \mid m^{(t)})$ 中随机抽取一个候选状态 $m'$。
3.  计算**接受概率 (acceptance probability)** $\alpha(m^{(t)}, m')$：
    $$
    \alpha(m^{(t)}, m') = \min \left( 1, \frac{\pi(m') q(m^{(t)} \mid m')}{\pi(m^{(t)}) q(m' \mid m^{(t)})} \right)
    $$
    其中 $\pi(m)$ 是我们希望采样的[目标分布](@entry_id:634522)（例如，[后验分布](@entry_id:145605) $p(m \mid d)$），我们通常只需要知道它正比于什么，因为归一化常数会在比率中被抵消。
4.  以概率 $\alpha$ 接受该提议，令 $m^{(t+1)} = m'$；否则，以概率 $1-\alpha$ 拒绝该提议，并令 $m^{(t+1)} = m^{(t)}$。

一个特别直观的MH算法变体是**独立采样器 (Independence Sampler)** 。在这种算法中，提议分布 $q(m')$ 不依赖于当前状态 $m^{(t)}$，即 $q(m' \mid m^{(t)}) = q(m')$。此时，[接受概率](@entry_id:138494)简化为：
$$
\alpha(m, m') = \min \left( 1, \frac{\pi(m') q(m)}{\pi(m) q(m')} \right)
$$
理论上，如果能够选择一个与目标分布 $\pi$ 非常接近的[提议分布](@entry_id:144814) $q$，独立采样器的效率会非常高。我们可以证明，当$q$与$\pi$之间的**Kullback–Leibler (KL) 散度** $D_{\mathrm{KL}}(\pi \,\|\, q)$ 趋近于零时，平均接受率将趋近于1。然而，在实践中，尤其是在[地球物理反演](@entry_id:749866)这类高维、复杂问题中，构造一个与未知的、复杂的[后验分布](@entry_id:145605) $\pi$ 近似的提议分布 $q$ 是一个“鸡生蛋，蛋生鸡”的难题。如果已经知道了 $\pi$ 的近似形式，我们或许已经不需要MCMC了。因此，独立采样器在实际的复杂反演中应用较少，更常用的是依赖于当前状态的局部提议（如[随机游走](@entry_id:142620) Metropolis）。

#### [吉布斯采样](@entry_id:139152)

**[吉布斯采样](@entry_id:139152) (Gibbs Sampling)** 是另一种强大的[MCMC算法](@entry_id:751788)，可以看作是[Metropolis-Hastings算法](@entry_id:146870)的一个特例 。它适用于多维参数空间，其核心思想是并非一次性更新整个参数向量 $m$，而是将其分解为多个块（或单个分量），然后依次从每个分量的**[全条件分布](@entry_id:266952) (full conditional distribution)** 中进行抽样。

例如，对于一个由两部分参数 $(\theta, \phi)$ 构成的模型，一个两块[吉布斯采样器](@entry_id:265671)的迭代过程如下：
1.  从[全条件分布](@entry_id:266952) $p(\theta \mid \phi^{(t)}, d)$ 中抽取一个新的 $\theta^{(t+1)}$。
2.  从[全条件分布](@entry_id:266952) $p(\phi \mid \theta^{(t+1)}, d)$ 中抽取一个新的 $\phi^{(t+1)}$。

由于每次抽样都是从真实的[全条件分布](@entry_id:266952)中进行的，可以证明其[接受概率](@entry_id:138494)恒为1。只要整个链是不可约和非周期的，它就会收敛到正确的联合[后验分布](@entry_id:145605) $p(\theta, \phi \mid d)$。

[吉布斯采样](@entry_id:139152)的巨大优势在于，如果[全条件分布](@entry_id:266952)是已知的标准[分布](@entry_id:182848)（如高斯、伽马、逆威沙特等），抽样就可以非常高效和精确。这种情况通常发生在模型具有**共轭性 (conjugacy)** 的结构时。例如，在一个线性的高斯反演问题中，如果我们将模型参数 $\theta$ 的先验设为[高斯分布](@entry_id:154414)，而其精度参数 $\phi$（即[方差](@entry_id:200758)的倒数）的先验（称为[超先验](@entry_id:750480)）设为伽马[分布](@entry_id:182848)，那么可以推导出，给定$\phi$时$\theta$的[全条件分布](@entry_id:266952)是[高斯分布](@entry_id:154414)，而给定$\theta$时$\phi$的[全条件分布](@entry_id:266952)是伽马[分布](@entry_id:182848) 。由于我们可以直接从[高斯和](@entry_id:196588)伽马[分布](@entry_id:182848)中抽样，[吉布斯采样](@entry_id:139152)在这种共轭模型中实现起来非常简单。

值得注意的是，共轭性并非使用[吉布斯采样](@entry_id:139152)的必要条件。即使[全条件分布](@entry_id:266952)不是[标准形式](@entry_id:153058)，只要它是一维且其对数是[凹函数](@entry_id:274100)（即对数[凹性](@entry_id:139843)），我们就可以使用**[自适应拒绝采样](@entry_id:746261) (Adaptive Rejection Sampling, ARS)** 等技术进行[精确抽样](@entry_id:749141)，而无需知道其归一化常数 。如果连[精确抽样](@entry_id:749141)也无法实现，我们还可以在[吉布斯采样](@entry_id:139152)的某个步骤中嵌入一个Metropolis-Hastings步骤（称为[Metropolis-within-Gibbs](@entry_id:751940)），从而保持算法的灵活性和广泛适用性。

### 应对复杂[后验分布](@entry_id:145605)的挑战

在许多[地球物理反演](@entry_id:749866)问题中，[后验分布](@entry_id:145605)呈现出**多模态 (multimodal)** 的特性，即存在多个互不相连的高概率区域（模式），它们被低概率的“山谷”隔开。标准的[MCMC采样](@entry_id:751801)器（如[随机游走Metropolis](@entry_id:754036)）在探索这种崎岖的后验地貌时会遇到巨大困难。采样链可能会长时间被困在一个模式中，无法“翻越”低概率的山谷去探索其他模式，导致采样结果严重偏离真实的后验分布。

**并行[回火](@entry_id:182408) (Parallel Tempering, PT)**，又称Metropolis耦合MCMC（MC³），是解决多模态问题的一种非常有效的先进算法 。其思想源于物理学中的[模拟退火](@entry_id:144939)。它同时运行 $N$ 条[马尔可夫链](@entry_id:150828)，每条链对应一个不同的[逆温](@entry_id:140086)度 $\beta \in [0, 1]$。温度阶梯通常设置为 $1 = \beta_1 > \beta_2 > \dots > \beta_N = 0$。

每条链 $i$ 采样的[目标分布](@entry_id:634522)是经过“加热”的**温度[分布](@entry_id:182848) (tempered distribution)**：
$$
p_{\beta_i}(m) \propto p(d \mid m)^{\beta_i} p(m)
$$
其中，$\beta_1 = 1$ 的链（“冷链”）采样自我们真正关心的目标[后验分布](@entry_id:145605)。而对于 $\beta_i  1$ 的链（“热链”），[似然](@entry_id:167119)项 $p(d \mid m)$ 被“削平”了。当 $\beta_i \to 0$ 时，似然的影响消失，链采样自[先验分布](@entry_id:141376) $p(m)$。

这种温度调节的效应是，热链看到的概率地貌非常平坦，模式之间的“能量壁垒”大大降低，因此它可以自由地在整个[参数空间](@entry_id:178581)中游走，轻松地跨越不同模式。并行[回火](@entry_id:182408)算法的关键在于，它会周期性地提议交换相邻两条链（例如，链 $i$ 和链 $j$）的状态（$m_i$ 和 $m_j$）。这个交换提议同样基于[Metropolis-Hastings准则](@entry_id:164679)进行接受或拒绝，其接受概率为：
$$
a_{\text{swap}} = \min\left(1, \left[p(d \mid m_i)\right]^{\beta_j - \beta_i} \left[p(d \mid m_j)\right]^{\beta_i - \beta_j}\right)
$$
通过这些交换，热链发现的新模式有机会被“传递”给较冷的链，并最终被目标冷链所接受。这极大地增强了采样器的全局探索能力和混合效率，确保了对多模态[后验分布](@entry_id:145605)的全面采样。

### 超越固定维度：[跨维采样](@entry_id:756096)

传统[MCMC方法](@entry_id:137183)假设模型参数的维度是固定的。然而，在许多地球物理问题中，模型本身的复杂度是未知的。例如，在反演一维地球分层结构时，地层的数量 $k$ 本身就是一个需要从数据中推断的参数。这类问题被称为**跨维 (trans-dimensional)** 反演。

**可逆跳跃MCMC (Reversible Jump MCMC, [RJMCMC](@entry_id:754374))** 是由Peter Green提出的一个 brilliant 的框架，它将[Metropolis-Hastings算法](@entry_id:146870)推广到维度可变的状态空间 。其核心思想是在不同维度的[模型空间](@entry_id:635763)之间构造满足[细致平衡条件](@entry_id:265158)的“跳跃”。

假设我们想从模型 $k$（参数为 $\theta_k \in \mathbb{R}^{d_k}$）跳跃到模型 $k'$（参数为 $\theta_{k'} \in \mathbb{R}^{d_{k'}}$）。为了使跳跃可逆，[RJMCMC](@entry_id:754374)引入了辅助变量 $u$ 和 $u'$。从模型 $k$ 到 $k'$ 的“前向”跳跃通过一个确定性的、可逆的映射 $T$ 来实现：$(\theta_{k'}, u') = T(\theta_k, u)$。这里的 $u$ 是从一个提议分布 $g(u)$ 中抽取的。反向跳跃 $(\theta_k, u) = T^{-1}(\theta_{k'}, u')$ 必须是唯一确定的。

为了让这个映射成为一个[双射](@entry_id:138092)，它必须满足**维度匹配条件 (dimension matching condition)**：
$$
d_k + \dim(u) = d_{k'} + \dim(u')
$$
这个条件确保了前向和反向跳跃所处的增广空间的维度是相同的。

考虑一个简单的“诞生”步骤：我们从一个 $k$ 层的模型移动到一个 $k+1$ 层的模型，即 $k' = k+1$。这通常通过引入一个代表新层属性的辅助变量 $u$（维度为1）来实现。一个简单的构造是将新参数直接设为 $u$，即通过拼接构成新的参数向量：$\theta_{k'} = (\theta_k, u)$。在这种情况下，没有为反向移动生成辅助变量，即 $\dim(u')=0$。维度匹配条件 $d_k + 1 = d_{k'} + 0$ 在 $d_{k'} = d_k+1$ 时成立。

跨维跳跃的[接受概率](@entry_id:138494)除了包含后验比和提议比之外，还必须包含一个**雅可比行列式 (Jacobian determinant)** 的[绝对值](@entry_id:147688)，以修正由于变量变换引起体积变化的效应。接受概率为：
$$
\alpha = \min \left( 1, \frac{p(k', \theta_{k'} \mid d)}{p(k, \theta_k \mid d)} \frac{j(k' \to k) g_{k' \to k}(u')}{j(k \to k) g_{k \to k}(u)} \left| \det\left(\frac{\partial(\theta_{k'}, u')}{\partial(\theta_k, u)}\right) \right| \right)
$$
其中 $j$ 是提议跳跃到某个模型类型的概率。对于上述简单的拼接诞生步骤 $T(\theta_k, u) = (\theta_k, u)$，变换是线性的，其雅可比矩阵是一个[单位矩阵](@entry_id:156724)，因此其[行列式](@entry_id:142978)为1 。

[RJMCMC](@entry_id:754374)与并行[回火](@entry_id:182408)经常结合使用，因为跨维跳跃本质上是大胆的全局移动，往往接受率很低。在并行[回火](@entry_id:182408)的热链中，后验地貌更平坦，使得这些跨维提议更容易被接受，从而显著改善了对模型维度的探索。

### MCMC输出的分析与诊断

成功运行[MCMC采样](@entry_id:751801)器后，我们得到的是一系列相关的样本，而不是完美的独立抽样。因此，在使用这些样本进行推断之前，必须进行仔细的分析和诊断。

#### 收敛性诊断

如何判断MCMC链是否已经“忘记”其初始状态并收敛到了平稳分布？这是一个核心问题。虽然无法绝对证明收敛，但我们可以使用一系列诊断工具来检测未收敛的迹象。**[Gelman-Rubin诊断](@entry_id:749773)**（或称 $\hat{R}$ 统计量）是其中最流行和最可靠的方法之一 。

[Gelman-Rubin诊断](@entry_id:749773)的思想是同时运行多条（$m \ge 2$）从不同、过度分散的初始点开始的[马尔可夫链](@entry_id:150828)。如果所有链都已收敛到同一个平稳分布，那么链间的[方差](@entry_id:200758)应该与链内的[方差](@entry_id:200758)基本一致。反之，如果链尚未收敛，它们可能在探索参数空间的不同区域，导致链间[方差](@entry_id:200758)远大于链内[方差](@entry_id:200758)。

具体计算步骤如下（对于某个标量参数或模型输出的标量函数 $Y$）：
1.  计算每条链 $i$ 的内部[方差](@entry_id:200758) $s_i^2$。将它们平均得到**链内[方差](@entry_id:200758) (within-chain variance)** $W = \frac{1}{m} \sum_{i=1}^m s_i^2$。$W$ 是对目标[方差](@entry_id:200758)的一个可能偏小的估计。
2.  计算各链均值 $\bar{Y}_i$ 之间的[方差](@entry_id:200758)，并乘以链长 $n$，得到**链间[方差](@entry_id:200758) (between-chain variance)** $B = \frac{n}{m-1} \sum_{i=1}^m (\bar{Y}_i - \bar{Y})^2$。如果链未收敛，$B$ 会是对目标[方差](@entry_id:200758)的一个偏大的估计。
3.  构造一个混合[方差估计](@entry_id:268607) $\hat{V} = \frac{n-1}{n}W + \frac{1}{n}B$，它旨在即使链未收敛时也能近似无偏地估计目标[方差](@entry_id:200758)。
4.  计算**[潜在尺度缩减因子](@entry_id:753645) (potential scale reduction factor)** $\hat{R} = \sqrt{\frac{\hat{V}}{W}}$。

当链收敛时，$W$ 和 $B$ 都将趋于真实[方差](@entry_id:200758)，$\hat{V}$ 也将趋于 $W$，因此 $\hat{R}$ 趋近于1。通常，$\hat{R}$ 值小于1.1被认为是链已收敛的可接受证据。对于[RJMCMC](@entry_id:754374)这类[跨维采样](@entry_id:756096)，我们可以对任何维度无关的标量总结函数（例如特定深度的地震波速，或莫霍面深度）计算$\hat{R}$值来评估收敛性。

#### 样本效率

MCMC生成的样本是[自相关](@entry_id:138991)的，这意味着相邻样本之间并非相互独立。这种相关性降低了样本集的信息含量。为了量化这种效应，我们引入**[有效样本量](@entry_id:271661) (Effective Sample Size, ESS)** 的概念 。

MCMC样本链 $\{f_t\}$ 的样本均值 $\bar{f}_N$ 的[方差](@entry_id:200758)为：
$$
\text{Var}(\bar{f}_N) \approx \frac{\gamma_0}{N} \left( 1 + 2 \sum_{k=1}^{\infty} \rho_k \right)
$$
其中 $\gamma_0$ 是样本的真实[方差](@entry_id:200758)，$\rho_k$ 是滞后 $k$ 步的自相关系数。相比之下，一个包含 $N_{\text{eff}}$ 个独立同分布样本的均值[方差](@entry_id:200758)为 $\frac{\gamma_0}{N_{\text{eff}}}$。

通过比较这两个表达式，我们可以定义**[积分自相关时间](@entry_id:637326) (Integrated Autocorrelation Time, IAT)** $\tau_{\text{int}}$：
$$
\tau_{\text{int}} = 1 + 2 \sum_{k=1}^{\infty} \rho_k
$$
它衡量了链中一个样本需要多少步才能“忘记”前一个样本。于是，[有效样本量](@entry_id:271661) ESS 可以表示为：
$$
\text{ESS} = \frac{N}{\tau_{\text{int}}}
$$
ESS告诉我们，一个长度为 $N$ 的相关样本链，其在估计均值方面的统计能力，等价于多少个独立的样本。例如，如果一个[RJMCMC](@entry_id:754374)采样器产生的某个标量输出的[自相关](@entry_id:138991)性可以用一个自回归参数 $\phi=0.92$ 的[AR(1)过程](@entry_id:746502)来近似，即 $\rho_k = 0.92^k$，那么其[积分自相关时间](@entry_id:637326)为 $\tau_{\text{int}} = \frac{1+\phi}{1-\phi} = \frac{1.92}{0.08} = 24$。这意味着，一条包含 $N=40000$ 个样本的链，其[有效样本量](@entry_id:271661)仅为 $\text{ESS} = 40000 / 24 \approx 1667$。高[自相关](@entry_id:138991)（$\tau_{\text{int}}$大）意味着低ESS，表明[采样效率](@entry_id:754496)低下，需要更长的链才能获得可靠的后验估计。

### 模型选择：证据估计

贝叶斯框架不仅能进行[参数推断](@entry_id:753157)，还能进行**模型选择 (model selection)**。在比较一系列竞争模型 $\mathcal{M}_i$ 时，贝叶斯方法通过计算每个模型的**证据 (evidence)** 或**[边际似然](@entry_id:636856) (marginal likelihood)** $p(d \mid \mathcal{M}_i)$ 来实现。证据是[似然函数](@entry_id:141927)在整个先验参数空间上的积分：
$$
p(d) = \int p(d \mid m) p(m) dm
$$
证据值高的模型能够更好地以符合先验的方式解释数据，因此更受青睐。然而，这个积分通常维度很高且形式复杂，难以解析计算。MCMC为我们提供了多种数值估计证据的方法。

#### [热力学积分](@entry_id:156321)

**[热力学积分](@entry_id:156321) (Thermodynamic Integration, TI)** 是一种优雅且强大的证据估计算法，它与并行[回火](@entry_id:182408)方法紧密相连 。该方法的核心恒等式为：
$$
\log p(d) = \int_{0}^{1} \mathbb{E}_{\beta}[\log p(d \mid m)] d\beta
$$
其中 $\mathbb{E}_{\beta}[\cdot]$ 表示在温度为 $\beta$ 的后验分布 $p_\beta(m) \propto p(d \mid m)^{\beta} p(m)$下的期望。这个公式将高维的证据积分问题转化为了一个关于温度 $\beta$ 的一维积分问题。

在实践中，我们可以利用并行[回火](@entry_id:182408)运行时在每个温度 $\beta_i$ 下生成的样本，来计算[期望值](@entry_id:153208) $\mathbb{E}_{\beta_i}[\log p(d \mid m)]$ 的[蒙特卡洛估计](@entry_id:637986)。然后，我们可以使用标准的[数值积分方法](@entry_id:141406)（如梯形法则或辛普森法则）来近似计算上述一维积分，从而得到对数证据 $\log p(d)$ 的估计值。

为了获得精确的TI估计，温度阶梯 $\beta_i$ 的设置至关重要。积分的[数值误差](@entry_id:635587)取决于被积函数 $\mathbb{E}_{\beta}[\log p(d \mid m)]$ 的光滑度。可以证明，这个函数对 $\beta$ 的导数等于[对数似然](@entry_id:273783)在温度[分布](@entry_id:182848)下的[方差](@entry_id:200758)：$\frac{d}{d\beta}\mathbb{E}_{\beta}[\log p(d \mid m)] = \text{Var}_{\beta}(\log p(d \mid m))$。因此，在[对数似然](@entry_id:273783)[方差](@entry_id:200758)大的区域（通常是 $\beta$ 较小处），被积函数变化剧烈，我们需要设置更密集的温度点以减小[数值积分误差](@entry_id:137490)。巧合的是，这也是为了保证并行[回火](@entry_id:182408)中相邻链之间有足够高的交换接受率所需要的。因此，一个优化的温度阶梯不仅能提高[采样效率](@entry_id:754496)，还能提高证据估计的精度。

#### 踏脚石采样与[桥式采样](@entry_id:746983)

**踏脚石采样 (Stepping-Stone Sampling)** 是另一种基于温度路径的证据估计方法 。它将证据表示为一系列[归一化常数](@entry_id:752675)比率的**伸缩乘积 (telescoping product)**：
$$
p(d) = Z_1 = \frac{Z_1}{Z_{\beta_{K-1}}} \frac{Z_{\beta_{K-1}}}{Z_{\beta_{K-2}}} \cdots \frac{Z_{\beta_1}}{Z_0} Z_0
$$
由于 $Z_0=1$，每个比率 $r_k = Z_{\beta_k}/Z_{\beta_{k-1}}$ 都可以表示为在前一个温度[分布](@entry_id:182848)下的期望：$r_k = \mathbb{E}_{p_{\beta_{k-1}}}[p(d \mid m)^{\beta_k - \beta_{k-1}}]$。通过在每个温度下运行MCMC并计算这些期望，最后将它们相乘即可得到证据的估计。对于先验和后验重叠很差的典型地球物理问题，踏脚石采样通过密集的中间“踏脚石”确保了每一步估计的[方差](@entry_id:200758)都很小，从而获得稳定且偏差较低的证据估计。

**[桥式采样](@entry_id:746983) (Bridge Sampling)** 是一个更广义的框架，它通过一个“桥接”函数 $\alpha(m)$ 来估计两个[分布](@entry_id:182848)（如先验和后验）的[归一化常数](@entry_id:752675)之比。在理想条件下（例如，先验与后验重叠良好，且选择了最优的桥接函数），[桥式采样](@entry_id:746983)在计算成本固定的情况下，可以比踏脚石采样具有更低的[方差](@entry_id:200758)。然而，在先验和后验相距甚远时，单步[桥式采样](@entry_id:746983)的[方差](@entry_id:200758)会爆炸，使其变得不可靠 。

对于跨维问题，这些证据估计方法在形式上仍然有效，因为所有的积分都隐式地包含了对模型维度 $k$ 的求和。然而，它们都依赖于[MCMC采样](@entry_id:751801)器能够有效地探索整个（跨维）后验空间。如果[RJMCMC](@entry_id:754374)的维度混合很差（尤其是在接近 $\beta=1$ 的冷链中），那么样本将无法代表真实的后验分布，从而导致所有这些证据估计方法产生显著的[偏差和方差](@entry_id:170697) 。这再次凸显了将先进[采样策略](@entry_id:188482)（如并行[回火](@entry_id:182408)）与跨维方法相结合的重要性。