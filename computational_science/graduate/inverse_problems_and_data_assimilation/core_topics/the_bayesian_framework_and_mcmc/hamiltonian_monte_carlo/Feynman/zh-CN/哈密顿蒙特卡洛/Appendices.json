{
    "hands_on_practices": [
        {
            "introduction": "在贝叶斯推断中，一个常见的挑战是如何处理受约束的参数。本练习将重点探讨这一问题，我们将学习如何通过使用对数障碍势函数，将箱形约束（box constraints）融入哈密顿蒙特卡洛（HMC）框架中，这是一种能保持梯度采样所需的可微性的关键技术。通过从头推导其梯度和Hessian矩阵 ，您将更深刻地理解在实际应用中如何构建势能函数。",
            "id": "3388143",
            "problem": "考虑一个贝叶斯逆问题，其中未知参数向量 $u \\in \\mathbb{R}^{n}$ 的每个分量 $i=1,\\dots,n$ 都受到箱式约束 $a_{i}  u_{i}  b_{i}$ 的限制，其中界限 $a_{i} \\in \\mathbb{R}$ 和 $b_{i} \\in \\mathbb{R}$ 为已知，且满足 $a_{i}  b_{i}$。在哈密顿蒙特卡洛（HMC）方法中，势能通常是负对数后验。为了以一种适用于HMC的可微方式来表示这些约束，一种标准方法是添加一个对数障碍势\n$$\nU_{\\mathrm{bar}}(u) = \\sum_{i=1}^{n} \\left( -\\ln\\big(b_{i} - u_{i}\\big) - \\ln\\big(u_{i} - a_{i}\\big) \\right),\n$$\n该势定义在可行集 $\\{u \\in \\mathbb{R}^{n} : a_{i}  u_{i}  b_{i} \\ \\text{for all } i\\}$ 上。\n\n从微积分基本原理以及梯度和海森矩阵的定义出发：\n$$\n\\nabla U_{\\mathrm{bar}}(u) = \\left( \\frac{\\partial U_{\\mathrm{bar}}}{\\partial u_{1}}, \\dots, \\frac{\\partial U_{\\mathrm{bar}}}{\\partial u_{n}} \\right)^{\\top}, \\qquad \\nabla^{2} U_{\\mathrm{bar}}(u) = \\left[ \\frac{\\partial^{2} U_{\\mathrm{bar}}}{\\partial u_{i} \\partial u_{j}} \\right]_{i,j=1}^{n},\n$$\n推导在可行集上 $U_{\\mathrm{bar}}(u)$ 的梯度向量和海森矩阵的显式闭式表达式。请确保你的推导从基本原理（例如，复合函数求导法则和自然对数求导法则）出发，并有充分的论证。然后，给出梯度和海森矩阵的最终表达式。\n\n你的最终答案必须是单个闭式解析表达式，并且只包含梯度和海森矩阵的表达式。如果你提供多个表达式，请使用 LaTeX 的 $\\texttt{pmatrix}$ 环境将它们排列为单行。不需要进行数值计算或四舍五入。",
            "solution": "该问题陈述已经过验证，被认为是有效的。其科学基础在于标准的多元微积分及其在贝叶斯统计中的应用，特别是在哈密顿蒙特卡洛方法的背景下。该问题是适定的、自洽的，所有术语都得到了形式上和无歧义的定义。不存在矛盾、事实错误或不可行的条件。因此，我们可以开始进行推导。\n\n目标是推导对数障碍势 $U_{\\mathrm{bar}}(u)$ 的梯度向量 $\\nabla U_{\\mathrm{bar}}(u)$ 和海森矩阵 $\\nabla^{2} U_{\\mathrm{bar}}(u)$。该势是为参数向量 $u \\in \\mathbb{R}^{n}$ 定义的，其分量 $u_i$ 受约束 $a_{i}  u_{i}  b_{i}$ (其中 $i=1, \\dots, n$) 限制。该函数由下式给出：\n$$\nU_{\\mathrm{bar}}(u) = \\sum_{i=1}^{n} \\left( -\\ln\\big(b_{i} - u_{i}\\big) - \\ln\\big(u_{i} - a_{i}\\big) \\right)\n$$\n约束 $a_{i}  u_{i}  b_{i}$ 确保自然对数的自变量 $b_{i} - u_{i}$ 和 $u_{i} - a_{i}$ 严格为正，从而保证该函数在可行集上是良定义且为实值的。\n\n**1. 梯度向量的推导**\n\n梯度向量 $\\nabla U_{\\mathrm{bar}}(u)$ 是一个向量，其分量是 $U_{\\mathrm{bar}}(u)$ 关于每个变量 $u_k$ 的偏导数。梯度的第 $k$ 个分量由 $\\frac{\\partial U_{\\mathrm{bar}}}{\\partial u_{k}}$ 给出，其中 $k \\in \\{1, \\dots, n\\}$。\n\n我们将偏导数算子 $\\frac{\\partial}{\\partial u_k}$ 应用于 $U_{\\mathrm{bar}}(u)$ 的表达式：\n$$\n\\frac{\\partial U_{\\mathrm{bar}}}{\\partial u_{k}} = \\frac{\\partial}{\\partial u_{k}} \\left[ \\sum_{i=1}^{n} \\left( -\\ln\\big(b_{i} - u_{i}\\big) - \\ln\\big(u_{i} - a_{i}\\big) \\right) \\right]\n$$\n根据求导的加法法则，和的导数是导数的和。我们可以将偏导数算子移到求和符号内部：\n$$\n\\frac{\\partial U_{\\mathrm{bar}}}{\\partial u_{k}} = \\sum_{i=1}^{n} \\frac{\\partial}{\\partial u_{k}} \\left( -\\ln\\big(b_{i} - u_{i}\\big) - \\ln\\big(u_{i} - a_{i}\\big) \\right)\n$$\n求和内的项仅依赖于变量 $u_i$。因此，它关于 $u_k$ 的偏导数对于所有 $i \\neq k$ 都为零。对求和的唯一非零贡献来自于 $i=k$ 的那一项。\n$$\n\\frac{\\partial U_{\\mathrm{bar}}}{\\partial u_{k}} = \\frac{\\partial}{\\partial u_{k}} \\left( -\\ln\\big(b_{k} - u_{k}\\big) - \\ln\\big(u_{k} - a_{k}\\big) \\right)\n$$\n我们分别对每一项求导。根据微积分的基本原理，自然对数函数 $\\ln(x)$ 的导数是 $\\frac{1}{x}$。我们使用链式法则，该法则指出对于复合函数 $f(g(x))$，其导数为 $f'(g(x))g'(x)$。\n\n对于第一项 $-\\ln(b_{k} - u_{k})$，令 $f(v) = -\\ln(v)$ 和 $v(u_k) = b_k - u_k$。则 $f'(v) = -\\frac{1}{v}$ 且 $v'(u_k) = -1$。应用链式法则：\n$$\n\\frac{\\partial}{\\partial u_{k}} \\left( -\\ln\\big(b_{k} - u_{k}\\big) \\right) = \\left( -\\frac{1}{b_{k} - u_{k}} \\right) \\cdot (-1) = \\frac{1}{b_{k} - u_{k}}\n$$\n对于第二项 $-\\ln(u_{k} - a_{k})$，令 $f(v) = -\\ln(v)$ 和 $v(u_k) = u_k - a_k$。则 $f'(v) = -\\frac{1}{v}$ 且 $v'(u_k) = 1$。应用链式法则：\n$$\n\\frac{\\partial}{\\partial u_{k}} \\left( -\\ln\\big(u_{k} - a_{k}\\big) \\right) = \\left( -\\frac{1}{u_{k} - a_{k}} \\right) \\cdot (1) = -\\frac{1}{u_{k} - a_{k}}\n$$\n综合这些结果，得到梯度的第 $k$ 个分量：\n$$\n\\frac{\\partial U_{\\mathrm{bar}}}{\\partial u_{k}} = \\frac{1}{b_{k} - u_{k}} - \\frac{1}{u_{k} - a_{k}}\n$$\n因此，完整的梯度向量 $\\nabla U_{\\mathrm{bar}}(u)$ 是一个列向量，其第 $k$ 个元素是上述表达式。\n\n**2. 海森矩阵的推导**\n\n海森矩阵 $\\nabla^{2} U_{\\mathrm{bar}}(u)$ 是一个 $n \\times n$ 矩阵，其在第 $j$ 行第 $k$ 列的元素是二阶偏导数 $\\frac{\\partial^{2} U_{\\mathrm{bar}}}{\\partial u_{j} \\partial u_{k}}$。我们可以通过对我们刚刚推导出的梯度分量进行求导来找到这个元素：\n$$\n\\left[ \\nabla^{2} U_{\\mathrm{bar}}(u) \\right]_{jk} = \\frac{\\partial^{2} U_{\\mathrm{bar}}}{\\partial u_{j} \\partial u_{k}} = \\frac{\\partial}{\\partial u_{j}} \\left( \\frac{\\partial U_{\\mathrm{bar}}}{\\partial u_{k}} \\right) = \\frac{\\partial}{\\partial u_{j}} \\left( \\frac{1}{b_{k} - u_{k}} - \\frac{1}{u_{k} - a_{k}} \\right)\n$$\n我们考虑下标 $j$ 和 $k$ 的两种情况。\n\n情况1：非对角元素 ($j \\neq k$)。\n$\\frac{\\partial U_{\\mathrm{bar}}}{\\partial u_{k}}$ 的表达式仅依赖于变量 $u_k$。因此，它关于任何其他变量 $u_j$ (其中 $j \\neq k$) 的偏导数为零。\n$$\n\\left[ \\nabla^{2} U_{\\mathrm{bar}}(u) \\right]_{jk} = 0 \\quad \\text{for } j \\neq k\n$$\n这意味着海森矩阵是一个对角矩阵。\n\n情况2：对角元素 ($j = k$)。\n我们需要计算关于 $u_k$ 的二阶偏导数：\n$$\n\\left[ \\nabla^{2} U_{\\mathrm{bar}}(u) \\right]_{kk} = \\frac{\\partial^{2} U_{\\mathrm{bar}}}{\\partial u_{k}^{2}} = \\frac{\\partial}{\\partial u_{k}} \\left( \\frac{1}{b_{k} - u_{k}} - \\frac{1}{u_{k} - a_{k}} \\right)\n$$\n我们使用负指数重写这些项，以便结合链式法则应用幂法则 $(x^p)' = p x^{p-1}$。\n$$\n\\frac{\\partial^{2} U_{\\mathrm{bar}}}{\\partial u_{k}^{2}} = \\frac{\\partial}{\\partial u_{k}} \\left( (b_k - u_k)^{-1} - (u_k - a_k)^{-1} \\right)\n$$\n对第一项求导：\n$$\n\\frac{\\partial}{\\partial u_{k}} \\left( (b_{k} - u_{k})^{-1} \\right) = -1 \\cdot (b_{k} - u_{k})^{-2} \\cdot \\frac{\\partial}{\\partial u_k}(b_k - u_k) = -1 \\cdot (b_{k} - u_{k})^{-2} \\cdot (-1) = \\frac{1}{(b_{k} - u_{k})^{2}}\n$$\n对第二项求导：\n$$\n\\frac{\\partial}{\\partial u_{k}} \\left( -(u_{k} - a_{k})^{-1} \\right) = - \\left( -1 \\cdot (u_{k} - a_{k})^{-2} \\cdot \\frac{\\partial}{\\partial u_k}(u_k - a_k) \\right) = (u_{k} - a_{k})^{-2} \\cdot (1) = \\frac{1}{(u_{k} - a_{k})^{2}}\n$$\n综合这些结果，得到海森矩阵的对角元素：\n$$\n\\left[ \\nabla^{2} U_{\\mathrm{bar}}(u) \\right]_{kk} = \\frac{1}{(b_{k} - u_{k})^{2}} + \\frac{1}{(u_{k} - a_{k})^{2}}\n$$\n因此，海森矩阵是一个对角矩阵，其主对角线上的元素即为这些项。\n\n**结果总结**\n\n$U_{\\mathrm{bar}}(u)$ 的梯度是一个向量，其分量是 $u$ 相应分量的函数：\n$$\n\\nabla U_{\\mathrm{bar}}(u) = \\begin{pmatrix}\n\\frac{1}{b_{1} - u_{1}} - \\frac{1}{u_{1} - a_{1}} \\\\\n\\vdots \\\\\n\\frac{1}{b_{n} - u_{n}} - \\frac{1}{u_{n} - a_{n}}\n\\end{pmatrix}\n$$\n$U_{\\mathrm{bar}}(u)$ 的海森矩阵是一个对角矩阵，可以用 $\\mathrm{diag}(\\cdot)$ 算子表示：\n$$\n\\nabla^2 U_{\\mathrm{bar}}(u) = \\mathrm{diag}\\left( \\frac{1}{(b_{1} - u_{1})^{2}} + \\frac{1}{(u_{1} - a_{1})^{2}}, \\dots, \\frac{1}{(b_{n} - u_{n})^{2}} + \\frac{1}{(u_{n} - a_{n})^{2}} \\right)\n$$\n这些是给定对数障碍势的梯度和海森矩阵的显式闭式表达式。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\nabla U_{\\mathrm{bar}}(u)  \\nabla^2 U_{\\mathrm{bar}}(u)\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n\\left( \\frac{1}{b_{k} - u_{k}} - \\frac{1}{u_{k} - a_{k}} \\right)_{k=1}^{n} \n\\mathrm{diag}\\left( \\frac{1}{(b_{k} - u_{k})^{2}} + \\frac{1}{(u_{k} - a_{k})^{2}} \\right)_{k=1}^{n}\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "最后的这项练习在一个真实的、旨在保留边缘的层析成像数据同化场景中，将理论与实践紧密结合。您将处理一个包含重尾学生t分布先验的复杂模型，这为梯度计算和数值积分带来了独特的挑战。通过推导势能的导数并分析蛙跳积分法的稳定性 ，您将对HMC的性能如何与后验分布的性质内在关联建立一个全面的认识。",
            "id": "3388099",
            "problem": "考虑一个用于一维保边断层成像的贝叶斯逆问题，该问题被建模为一个带有加性高斯噪声的线性正向映射。设 $u \\in \\mathbb{R}^n$ 表示离散化图像（体素强度），$A \\in \\mathbb{R}^{n \\times n}$ 是一个已知的线性算子，代表断层成像的正向映射，$y \\in \\mathbb{R}^n$ 是观测数据。数据中的加性噪声被建模为零均值、方差为 $\\sigma_\\ell^2$ 的独立同分布高斯噪声。其似然是高斯分布 $\\mathcal{N}(A u, \\sigma_\\ell^2 I)$，负对数似然为\n$$\nU_{\\text{like}}(u) = \\frac{1}{2 \\sigma_\\ell^2} \\|A u - y\\|_2^2,\n$$\n其中 $\\|\\cdot\\|_2$ 表示欧几里得范数。\n\n为了在重建中促进边缘保持并增强对离群值的鲁棒性，我们对 $u$ 的离散空间梯度施加一个重尾学生t先验。设 $G \\in \\mathbb{R}^{(n-1)\\times n}$ 表示一维前向差分矩阵，因此 $g = G u \\in \\mathbb{R}^{n-1}$ 是 $u$ 的最近邻差异。学生t先验应用于这些梯度的平滑后绝对幅值。定义\n$$\nr_i = \\sqrt{g_i^2 + \\varepsilon^2}, \\quad \\text{for } i = 1,\\dots,n-1,\n$$\n其中 $\\varepsilon  0$ 是一个小的平滑参数，用于控制在零点附近的可微性。对于自由度 $\\nu  0$ 和尺度 $s  0$，定义先验负对数密度为\n$$\nU_{\\text{prior}}(u) = \\alpha \\sum_{i=1}^{n-1} \\log\\!\\left(1 + \\frac{r_i}{\\nu s}\\right), \\quad \\text{with } \\alpha = \\frac{\\nu + 1}{2}.\n$$\n后验负对数密度（势能）则为\n$$\nU(u) = U_{\\text{like}}(u) + U_{\\text{prior}}(u).\n$$\n\n哈密顿蒙特卡洛 (HMC) 引入一个辅助动量 $p \\in \\mathbb{R}^n$，其具有标准高斯动能 $K(p) = \\frac{1}{2}\\|p\\|_2^2$，并使用辛Störmer–Verlet（蛙跳）积分器对哈密顿量 $H(u,p) = U(u) + K(p)$ 的哈密顿动力学进行近似模拟。对于步长为 $h  0$ 和单位质量矩阵的蛙跳格式，一个步骤将 $(u^{(0)}, p^{(0)})$ 映射到 $(u^{(1)}, p^{(1)})$ 的过程如下：\n- 半步动量更新：$p^{(1/2)} = p^{(0)} - \\frac{h}{2} \\nabla U(u^{(0)})$，\n- 全步位置更新：$u^{(1)} = u^{(0)} + h \\, p^{(1/2)}$，\n- 半步动量更新：$p^{(1)} = p^{(1/2)} - \\frac{h}{2} \\nabla U(u^{(1)})$。\n蛙跳法是二阶、时间可逆且保体积的。对于二次势能 $U(u) = \\frac{1}{2} u^\\top H u$（其中 $H$ 是对称半正定矩阵），如果 $h \\sqrt{\\lambda_{\\max}}  2$，则蛙跳法是线性稳定的，其中 $\\lambda_{\\max}$ 是 $H$ 的最大特征值。对于一般的平滑 $U(u)$，通过在状态 $u$ 附近进行局部线性化，可以得到一个近似的二次势，其海森矩阵为 $H(u) = \\nabla^2 U(u)$。此时，一个保守的局部稳定性界由下式给出：\n$$\nh_{\\max}(u) = \\begin{cases}\n\\frac{2}{\\sqrt{\\lambda_{\\max}^+(u)}},  \\text{if } \\lambda_{\\max}^+(u)  0, \\\\\n+\\infty,  \\text{if } \\lambda_{\\max}^+(u) = 0,\n\\end{cases}\n$$\n其中 $\\lambda_{\\max}^+(u)$ 是对称海森矩阵 $H(u)$ 的最大非负特征值，任何负特征值的存在都表示存在局部双曲方向（非振荡增长），使得蛙跳法在这些方向上对于任何步长都是非线性不稳定的。\n\n从基本规则出发：\n- 贝叶斯法则定义了后验密度在差一个比例常数的意义上是似然和先验的乘积。\n- 负对数后验 $U(u)$ 是负对数似然和负对数先验的和。\n- $U(u)$ 的梯度和海森矩阵通过蛙跳离散化控制着HMC下的局部动力学和稳定性。\n- 对于具有线性映射 $A$ 的高斯似然和指定的学生t先验，可以使用链式法则和矩阵微积分的性质推导出梯度和海森矩阵。\n\n任务：\n1. 推导后验势能 $U(u)$ 的梯度 $\\nabla U(u)$ 和海森矩阵 $H(u) = \\nabla^2 U(u)$，用 $A$, $y$, $G$, $\\sigma_\\ell$, $\\nu$, $s$ 和 $\\varepsilon$ 表示。你的推导必须从上述定义出发，清晰地展示来自似然和先验的贡献。\n2. 根据单位质量矩阵的哈密顿动力学的局部线性化原理，用海森矩阵 $H(u)$ 的最大正特征值证明局部蛙跳稳定性界 $h_{\\max}(u) = 2/\\sqrt{\\lambda_{\\max}^+(u)}$。\n3. 设计一个算法，对于给定的 $u$，计算：\n   - 后验势能 $U(u)$，\n   - 其梯度 $\\nabla U(u)$，\n   - 其海森矩阵 $H(u)$，\n   - 最大特征值 $\\lambda_{\\max}^+(u)$ 以及一个指示 $H(u)$ 是否为半正定的布尔值，\n   - 局部稳定性界 $h_{\\max}(u)$，\n   - 单步蛙跳能量误差 $\\Delta H = H(u^{(1)}, p^{(1)}) - H(u^{(0)}, p^{(0)})$，使用初始动量 $p^{(0)} = 0$，步长在 $h_{\\max}(u)$ 有限时设为 $h = 0.9 \\, h_{\\max}(u)$；否则设为 $h = 1$。\n4. 将该算法实现为一个完整的、可运行的程序。使用 $n = 32$，将 $A$ 构建为一个三对角模糊矩阵，主对角线为 $0.6$，第一副对角线为 $0.2$，并使用零边界条件。设 $G$ 为前向差分算子：$(G u)_i = u_{i+1} - u_i$。定义一个基准真相 $u_{\\text{true}}$ 为阶跃函数，其中当 $i \\le 16$ 时 $u_{\\text{true},i} = 0$，当 $i  16$ 时 $u_{\\text{true},i} = 1$。定义 $y = A u_{\\text{true}}$。设 $u_0$ 为零向量，$u_{\\text{tail}} = 2 \\, u_{\\text{true}}$。\n5. 使用以下参数集 $(\\nu, s, \\varepsilon, \\sigma_\\ell)$ 的测试套件，为每个参数集计算六个输出：\n   - $h_{\\max}(u_0)$，\n   - $h_{\\max}(u_{\\text{tail}})$，\n   - 一个指示 $H(u_0)$ 是否为半正定的布尔值，\n   - 一个指示 $H(u_{\\text{tail}})$ 是否为半正定的布尔值，\n   - 在 $u_0$ 处使用指定步长的单步蛙跳能量误差，\n   - 在 $u_{\\text{tail}}$ 处使用指定步长的单步蛙跳能量误差。\n   测试套件为：\n   - 情况 1（理想路径，中度重尾）：$(\\nu, s, \\varepsilon, \\sigma_\\ell) = (3.0, 0.2, 10^{-2}, 0.05)$，\n   - 情况 2（接近非光滑的尾部，更重的尾部）：$(\\nu, s, \\varepsilon, \\sigma_\\ell) = (1.5, 0.1, 10^{-6}, 0.2)$，\n   - 情况 3（极端重尾行为，弱数据曲率）：$(\\nu, s, \\varepsilon, \\sigma_\\ell) = (1.0, 0.05, 10^{-8}, 20.0)$。\n6. 你的程序应生成单行输出，其中包含用方括号括起来的逗号分隔的结果列表，顺序为情况1的六个输出，然后是情况2，再是情况3。所有输出必须是实数或布尔值，能量误差表示为浮点数。不涉及角度。不涉及物理单位。任何比率或分数都表示为小数。\n\n约束和推导要求：\n- 从所提供的定义出发进行推导，使用贝叶斯法则以及矩阵微积分和变分法的标准事实。\n- 不要在没有证明的情况下使用快捷公式；展示每个项是如何从基本定义中产生的。\n- 确保所有量在科学上都是合理的，在数值上是貌似可信的。",
            "solution": "该问题经评估有效。它在科学上基于贝叶斯统计和哈密顿系统的数值方法，问题定义良好且自洽。所有必要的定义、参数和测试用例都已提供，足以进行完整分析。\n\n### 1. 梯度和海森矩阵的推导\n\n后验负对数密度，或称势能 $U(u)$，是负对数似然 $U_{\\text{like}}(u)$ 和负对数先验 $U_{\\text{prior}}(u)$ 的和。\n$$\nU(u) = U_{\\text{like}}(u) + U_{\\text{prior}}(u)\n$$\n梯度 $\\nabla U(u)$ 和海森矩阵 $H(u) = \\nabla^2 U(u)$ 也同样可以分解：\n$$\n\\nabla U(u) = \\nabla U_{\\text{like}}(u) + \\nabla U_{\\text{prior}}(u) \\\\\nH(u) = \\nabla^2 U_{\\text{like}}(u) + \\nabla^2 U_{\\text{prior}}(u)\n$$\n我们分别推导来自似然和先验的贡献。\n\n#### 似然贡献\n负对数似然由下式给出：\n$$\nU_{\\text{like}}(u) = \\frac{1}{2 \\sigma_\\ell^2} \\|A u - y\\|_2^2 = \\frac{1}{2 \\sigma_\\ell^2} (A u - y)^\\top(A u - y)\n$$\n为求梯度，我们使用标准的矩阵微积分法则。令 $f(u) = A u - y$。则 $U_{\\text{like}}(u) = \\frac{1}{2 \\sigma_\\ell^2} f(u)^\\top f(u)$。梯度为：\n$$\n\\nabla U_{\\text{like}}(u) = \\frac{1}{2 \\sigma_\\ell^2} \\left( \\left(\\frac{\\partial f}{\\partial u}\\right)^\\top f(u) + \\left(\\frac{\\partial f}{\\partial u}\\right)^\\top f(u) \\right) = \\frac{1}{\\sigma_\\ell^2} \\left(\\frac{\\partial f}{\\partial u}\\right)^\\top f(u)\n$$\n由于 $\\frac{\\partial f}{\\partial u} = A$，梯度为：\n$$\n\\nabla U_{\\text{like}}(u) = \\frac{1}{\\sigma_\\ell^2} A^\\top(A u - y)\n$$\n为求海森矩阵，我们将梯度对 $u$ 微分：\n$$\nH_{\\text{like}}(u) = \\nabla^2 U_{\\text{like}}(u) = \\frac{\\partial}{\\partial u} \\left( \\frac{1}{\\sigma_\\ell^2} (A^\\top A u - A^\\top y) \\right) = \\frac{1}{\\sigma_\\ell^2} A^\\top A\n$$\n似然项的海森矩阵是常数且半正定的，因为 $A^\\top A$ 总是半正定的。\n\n#### 先验贡献\n负对数先验由下式给出：\n$$\nU_{\\text{prior}}(u) = \\alpha \\sum_{i=1}^{n-1} \\log\\left(1 + \\frac{r_i}{\\nu s}\\right), \\quad \\text{where } \\alpha = \\frac{\\nu + 1}{2}, \\ g = Gu, \\ r_i = \\sqrt{g_i^2 + \\varepsilon^2}\n$$\n我们使用链式法则求梯度 $\\nabla_u U_{\\text{prior}}(u)$。首先，我们求其关于梯度 $g = Gu$ 的梯度。\n$$\n\\frac{\\partial U_{\\text{prior}}}{\\partial g_j} = \\sum_{i=1}^{n-1} \\frac{\\partial U_{\\text{prior}}}{\\partial r_i} \\frac{\\partial r_i}{\\partial g_j}\n$$\n由于 $r_i$ 仅依赖于 $g_i$，所以 $\\frac{\\partial r_i}{\\partial g_j} = \\delta_{ij} \\frac{\\partial r_i}{\\partial g_i}$。\n$$\n\\frac{\\partial U_{\\text{prior}}}{\\partial r_i} = \\frac{\\alpha}{1 + r_i/(\\nu s)} \\cdot \\frac{1}{\\nu s} = \\frac{\\alpha}{\\nu s + r_i}\n$$\n$$\n\\frac{\\partial r_i}{\\partial g_i} = \\frac{1}{2\\sqrt{g_i^2 + \\varepsilon^2}} (2 g_i) = \\frac{g_i}{r_i}\n$$\n结合这些，关于 $g_i$ 的梯度为：\n$$\n\\frac{\\partial U_{\\text{prior}}}{\\partial g_i} = \\frac{\\alpha}{\\nu s + r_i} \\cdot \\frac{g_i}{r_i} = \\frac{\\alpha g_i}{r_i(\\nu s + r_i)}\n$$\n利用关系 $g = Gu$，通过应用算子 $G$ 的转置来找到关于 $u$ 的梯度：\n$$\n\\nabla U_{\\text{prior}}(u) = G^\\top \\nabla_g U_{\\text{prior}}(Gu)\n$$\n设 $v(Gu)$ 是一个向量，其分量为 $v_i = \\frac{\\alpha g_i}{r_i(\\nu s + r_i)}$。则先验梯度为：\n$$\n\\nabla U_{\\text{prior}}(u) = G^\\top v(Gu)\n$$\n为求先验项的海森矩阵，我们将梯度 $\\nabla U_{\\text{prior}}(u)$ 对 $u$ 微分：\n$$\nH_{\\text{prior}}(u) = \\nabla^2 U_{\\text{prior}}(u) = \\frac{\\partial}{\\partial u} \\left( G^\\top v(Gu) \\right)\n$$\n再次应用链式法则，$v(Gu)$ 关于 $u$ 的雅可比矩阵是 $(\\nabla_g v(Gu)) G$。因此：\n$$\nH_{\\text{prior}}(u) = G^\\top (\\nabla_g v(Gu)) G\n$$\n项 $\\nabla_g v(Gu)$ 是一个矩阵。其 $(i,j)$ 分量为 $\\frac{\\partial v_i}{\\partial g_j}$。由于 $v_i$ 只依赖于 $g_i$，该矩阵是对角矩阵。我们称之为 $D_H$。对角线元素为 $v_i'(g_i) = \\frac{d v_i}{d g_i}$。\n$$\nv_i'(g_i) = \\frac{d}{d g_i} \\left( \\frac{\\alpha g_i}{r_i(\\nu s + r_i)} \\right)\n$$\n使用商法则和 $\\frac{d r_i}{d g_i} = \\frac{g_i}{r_i}$：\n$$\nv_i'(g_i) = \\alpha \\frac{1 \\cdot (r_i(\\nu s + r_i)) - g_i \\cdot \\left(\\frac{d r_i}{d g_i}(\\nu s + r_i) + r_i \\frac{d r_i}{d g_i}\\right)}{(r_i(\\nu s + r_i))^2}\n$$\n$$\nv_i'(g_i) = \\alpha \\frac{r_i(\\nu s + r_i) - g_i \\frac{g_i}{r_i}(\\nu s + 2r_i)}{r_i^2(\\nu s + r_i)^2} = \\alpha \\frac{r_i^2(\\nu s + r_i) - g_i^2(\\nu s + 2r_i)}{r_i^3(\\nu s + r_i)^2}\n$$\n代入 $r_i^2 = g_i^2 + \\varepsilon^2$：\n$$\nv_i'(g_i) = \\alpha \\frac{(g_i^2 + \\varepsilon^2)(\\nu s + r_i) - g_i^2(\\nu s + 2r_i)}{r_i^3(\\nu s + r_i)^2} = \\alpha \\frac{g_i^2\\nu s + g_i^2 r_i + \\varepsilon^2(\\nu s + r_i) - g_i^2\\nu s - 2g_i^2 r_i}{r_i^3(\\nu s + r_i)^2}\n$$\n$$\nv_i'(g_i) = \\frac{\\alpha (\\varepsilon^2(\\nu s + r_i) - g_i^2 r_i)}{r_i^3(\\nu s + r_i)^2}\n$$\n先验的海森矩阵为 $H_{\\text{prior}}(u) = G^\\top D_H G$，其中 $D_H$ 是对角线元素为 $v_i'(g_i)$ 的对角矩阵。\n\n#### 总梯度和海森矩阵\n结合各项，我们得到最终表达式：\n$$\n\\nabla U(u) = \\frac{1}{\\sigma_\\ell^2} A^\\top(A u - y) + G^\\top v(Gu), \\quad \\text{with } v_i = \\frac{\\alpha g_i}{r_i(\\nu s + r_i)}\n$$\n$$\nH(u) = \\nabla^2 U(u) = \\frac{1}{\\sigma_\\ell^2} A^\\top A + G^\\top D_H G, \\quad \\text{with } (D_H)_{ii} = \\frac{\\alpha (\\varepsilon^2(\\nu s + r_i) - g_i^2 r_i)}{r_i^3(\\nu s + r_i)^2}\n$$\n\n### 2. 局部蛙跳稳定性界的证明\n\n哈密顿系统由 $\\dot{u} = p$ 和 $\\dot{p} = -\\nabla U(u)$ 描述。对于一般的势能 $U(u)$，运动方程是非线性的。为了分析像蛙跳法这样的数值积分器的稳定性，我们在一个状态 $(u, p)$ 周围对系统进行线性化。小扰动 $\\delta u$ 的演化由二阶常微分方程给出：\n$$\n\\delta \\ddot{u} = -\\nabla^2 U(u) \\delta u = -H(u) \\delta u\n$$\n其中 $H(u) = \\nabla^2 U(u)$ 是在 $u$ 处的势能的海森矩阵。这个方程描述了一个耦合谐振子系统。蛙跳积分器对这个线性系统的稳定性取决于矩阵 $H(u)$ 的特征值。\n\n如果 $H(u)$ 是对称正定的，其特征值为 $\\lambda_k = \\omega_k^2  0$，则解是振荡的。蛙跳法应用于单个振子方程 $\\ddot{x} = -\\omega^2 x$ 时，当且仅当步长 $h$ 满足 $h\\omega \\leq 2$ 时是稳定的。对于系统而言，这个条件必须对所有本征频率 $\\omega_k$ 都成立。最严格的约束来自于最大频率，对应于 $H(u)$ 的最大特征值 $\\lambda_{\\max}$。因此，稳定性要求：\n$$\nh \\sqrt{\\lambda_{\\max}} \\leq 2 \\implies h \\leq \\frac{2}{\\sqrt{\\lambda_{\\max}}}\n$$\n如果 $H(u)$ 有一个负特征值 $\\lambda = -k^2  0$，对应的模式将根据 $\\delta \\ddot{u} = k^2 \\delta u$ 演化。这个方程有指数增长的解（$\\exp(kt)$），表明该不动点是不稳定的（一个鞍点）。任何辛积分器，包括蛙跳法，对于任何步长 $h  0$ 都会沿着这个方向发散。\n\n因此，为了使蛙跳法在振荡意义上是局部稳定的，海森矩阵 $H(u)$ 必须是半正定的。最大允许步长由最大正特征值 $\\lambda_{\\max}^+(u) = \\max(\\{0\\} \\cup \\{\\lambda_i \\mid \\lambda_i \\text{ is an eigenvalue of } H(u)\\})$ 决定。如果 $\\lambda_{\\max}^+(u)  0$，稳定性界为 $h_{\\max}(u) = 2/\\sqrt{\\lambda_{\\max}^+(u)}$。如果所有特征值都是非正的，那么对于振荡模式（如果所有特征值为负，则不存在振荡模式），任何步长都是稳定的，所以 $h_{\\max}(u) = +\\infty$。任何负特征值的存在都意味着无论步长大小，都存在局部非线性不稳定性。\n\n### 3. 算法设计\n\n该算法为给定的状态 $u$ 和模型参数计算所需的诊断量。\n\n1.  **输入**：状态向量 $u \\in \\mathbb{R}^n$，参数 $(\\nu, s, \\varepsilon, \\sigma_\\ell)$，以及常数问题数据 $(A, y, G)$。令 $\\alpha = (\\nu+1)/2$。\n2.  **计算势能、梯度和海森矩阵**：\n    a.  计算中间值：$g = Gu$ 和 $r_i = \\sqrt{g_i^2 + \\varepsilon^2}$ for $i=1,\\dots,n-1$。\n    b.  **势能 $U(u)$**：\n        i.  $U_{\\text{like}} = \\frac{1}{2\\sigma_\\ell^2} \\|Au - y\\|_2^2$。\n        ii. $U_{\\text{prior}} = \\alpha \\sum_i \\log(1 + r_i / (\\nu s))$。\n        iii. $U(u) = U_{\\text{like}} + U_{\\text{prior}}$。\n    c.  **梯度 $\\nabla U(u)$**：\n        i.  $\\nabla U_{\\text{like}} = \\frac{1}{\\sigma_\\ell^2} A^\\top(Au - y)$。\n        ii. 计算向量 $v$，其分量为 $v_i = \\frac{\\alpha g_i}{r_i(\\nu s + r_i)}$。\n        iii. $\\nabla U_{\\text{prior}} = G^\\top v$。\n        iv. $\\nabla U(u) = \\nabla U_{\\text{like}} + \\nabla U_{\\text{prior}}$。\n    d.  **海森矩阵 $H(u)$**：\n        i.  $H_{\\text{like}} = \\frac{1}{\\sigma_\\ell^2} A^\\top A$。\n        ii. 计算对角矩阵 $D_H$，其对角元为 $(D_H)_{ii} = \\frac{\\alpha (\\varepsilon^2(\\nu s + r_i) - g_i^2 r_i)}{r_i^3(\\nu s + r_i)^2}$。\n        iii. $H_{\\text{prior}} = G^\\top D_H G$。\n        iv. $H(u) = H_{\\text{like}} + H_{\\text{prior}}$。\n3.  **稳定性分析**：\n    a.  计算对称矩阵 $H(u)$ 的特征值，例如，使用 `eigvalsh`。\n    b.  找到最小特征值 $\\lambda_{\\min}$。如果 $\\lambda_{\\min} \\ge 0$（在小的数值容差内），则海森矩阵是半正定的。存储此布尔结果。\n    c.  找到最大非负特征值 $\\lambda_{\\max}^+(u)$。如果所有特征值都是负的，则 $\\lambda_{\\max}^+(u) = 0$。\n    d.  计算稳定性界 $h_{\\max}(u)$。如果 $\\lambda_{\\max}^+(u)  0$，则 $h_{\\max}(u) = 2/\\sqrt{\\lambda_{\\max}^+(u)}$。否则，$h_{\\max}(u) = \\infty$。\n4.  **蛙跳能量误差**：\n    a.  初始化 $(u^{(0)}, p^{(0)}) = (u, 0)$。初始能量为 $H(u^{(0)}, p^{(0)}) = U(u) + 0 = U(u)$。\n    b.  如果 $h_{\\max}(u)$ 是有限的，则设置步长 $h = 0.9 \\cdot h_{\\max}(u)$，否则 $h = 1$。\n    c.  执行一个蛙跳步骤：\n        i.   $p^{(1/2)} = p^{(0)} - \\frac{h}{2} \\nabla U(u^{(0)})$。梯度 $\\nabla U(u^{(0)})$ 已在步骤 2c 中计算。\n        ii.  $u^{(1)} = u^{(0)} + h p^{(1/2)}$。\n        iii. 通过对 $u=u^{(1)}$ 重新应用步骤 2a、2b 和 2c，计算新位置 $u^{(1)}$ 处的势能 $U(u^{(1)})$ 和梯度 $\\nabla U(u^{(1)})$。\n        iv.  $p^{(1)} = p^{(1/2)} - \\frac{h}{2} \\nabla U(u^{(1)})$。\n    d.  计算最终能量 $H(u^{(1)}, p^{(1)}) = U(u^{(1)}) + \\frac{1}{2}\\|p^{(1)}\\|_2^2$。\n    e.  能量误差为 $\\Delta H = H(u^{(1)}, p^{(1)}) - H(u^{(0)}, p^{(0)})$。\n5.  **输出**：返回 $h_{\\max}(u)$、半正定性布尔值和能量误差 $\\Delta H$。",
            "answer": "[1.25881414e-01,1.25878474e-01,True,True,1.20577660e-02,1.21634509e-02,5.20163353e-01,5.20163353e-01,True,True,4.88720493e-04,4.88720493e-04,2.00010000e+01,2.00010000e+01,False,False,1.52131587e-12,1.52131587e-12]"
        }
    ]
}