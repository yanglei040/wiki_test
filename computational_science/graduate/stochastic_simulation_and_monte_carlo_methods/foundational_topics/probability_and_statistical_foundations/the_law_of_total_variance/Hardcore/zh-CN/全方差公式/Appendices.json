{
    "hands_on_practices": [
        {
            "introduction": "我们从一个直接的计算开始，以建立直观的理解。在此练习中，我们将为一个从两个正态分布的混合中抽取的变量手动分解其方差。通过这个过程，我们可以清晰地看到总方差如何等于各组内部平均方差与各组均值之间方差的总和。",
            "id": "3354738",
            "problem": "考虑以下两点混合模型，该模型通常用于形式化蒙特卡洛（MC）模拟中的分层抽样。令 $Y \\in \\{0,1\\}$ 是一个伯努利随机变量，其中 $\\mathbb{P}(Y=1)=p$，且 $p=\\frac{2}{5}$。以 $Y$ 为条件，令 $X \\mid (Y=0) \\sim \\mathcal{N}(\\mu_{0},\\sigma_{0}^{2})$ 且 $X \\mid (Y=1) \\sim \\mathcal{N}(\\mu_{1},\\sigma_{1}^{2})$，其参数为 $\\mu_{0}=0$、$\\sigma_{0}^{2}=1$、$\\mu_{1}=3$ 和 $\\sigma_{1}^{2}=4$。\n\n仅使用期望和方差的定义以及条件期望的塔性质（即，对于任何可积随机变量 $Z$，有 $\\mathbb{E}[\\mathbb{E}[Z \\mid Y]]=\\mathbb{E}[Z]$），完成以下任务：\n\n1. 通过展开 $\\operatorname{Var}(X)=\\mathbb{E}[X^{2}] - (\\mathbb{E}[X])^{2}$ 并在适当的地方以 $Y$ 为条件，直接计算 $\\mathbb{E}[X]$ 和 $\\operatorname{Var}(X)$。\n2. 仅使用条件均值和条件方差，分别计算 $\\mathbb{E}[\\operatorname{Var}(X \\mid Y)]$ 和 $\\operatorname{Var}(\\mathbb{E}[X \\mid Y])$。\n3. 通过显式计算验证求 $\\operatorname{Var}(X)$ 的两种途径结果一致，并将 $\\operatorname{Var}(X)$ 的共同值以一个数字报告。\n\n将你最终报告的值四舍五入到四位有效数字。不需要单位。",
            "solution": "该问题提供了一个关于随机变量 $X$ 的两点混合模型。混合变量为 $Y \\sim \\text{Bernoulli}(p)$，其中 $\\mathbb{P}(Y=1)=p=\\frac{2}{5}$，因此 $\\mathbb{P}(Y=0)=1-p=\\frac{3}{5}$。给定 $Y$ 时 $X$ 的条件分布被指定为 $X \\mid (Y=0) \\sim \\mathcal{N}(\\mu_{0},\\sigma_{0}^{2})$ 和 $X \\mid (Y=1) \\sim \\mathcal{N}(\\mu_{1},\\sigma_{1}^{2})$。给定的参数为 $\\mu_{0}=0$、$\\sigma_{0}^{2}=1$、$\\mu_{1}=3$ 和 $\\sigma_{1}^{2}=4$。我们的任务是通过两种不同的方法计算 $X$ 的方差 $\\operatorname{Var}(X)$，并验证它们的结果一致。\n\n首先，我们建立必要的条件矩。对于一个正态分布 $\\mathcal{N}(\\mu, \\sigma^2)$，其均值为 $\\mu$，方差为 $\\sigma^2$。其二阶矩为 $\\mathbb{E}[X^2] = \\operatorname{Var}(X) + (\\mathbb{E}[X])^2 = \\sigma^2 + \\mu^2$。\n因此，我们有以下条件矩：\n$\\mathbb{E}[X \\mid Y=0] = \\mu_{0} = 0$。\n$\\operatorname{Var}(X \\mid Y=0) = \\sigma_{0}^{2} = 1$。\n$\\mathbb{E}[X^2 \\mid Y=0] = \\sigma_{0}^{2} + \\mu_{0}^2 = 1 + 0^2 = 1$。\n\n$\\mathbb{E}[X \\mid Y=1] = \\mu_{1} = 3$。\n$\\operatorname{Var}(X \\mid Y=1) = \\sigma_{1}^{2} = 4$。\n$\\mathbb{E}[X^2 \\mid Y=1] = \\sigma_{1}^{2} + \\mu_{1}^2 = 4 + 3^2 = 4 + 9 = 13$。\n\n我们依次解决问题的三个部分。\n\n1. 直接计算 $\\mathbb{E}[X]$ 和 $\\operatorname{Var}(X)$。\n\n为了计算无条件期望 $\\mathbb{E}[X]$，我们使用全期望定律（或塔性质）：$\\mathbb{E}[X] = \\mathbb{E}[\\mathbb{E}[X \\mid Y]]$。内部的期望 $\\mathbb{E}[X \\mid Y]$ 是一个依赖于 $Y$ 的随机变量。\n$$\n\\mathbb{E}[X \\mid Y] = \\begin{cases} \\mu_0  \\text{若 } Y=0 \\\\ \\mu_1  \\text{若 } Y=1 \\end{cases}\n$$\n对 $Y$ 取期望：\n$$\n\\mathbb{E}[X] = \\mathbb{E}[\\mathbb{E}[X \\mid Y]] = \\mathbb{E}[X \\mid Y=0] \\cdot \\mathbb{P}(Y=0) + \\mathbb{E}[X \\mid Y=1] \\cdot \\mathbb{P}(Y=1)\n$$\n$$\n\\mathbb{E}[X] = \\mu_{0}(1-p) + \\mu_{1}p = (0)\\left(\\frac{3}{5}\\right) + (3)\\left(\\frac{2}{5}\\right) = 0 + \\frac{6}{5} = \\frac{6}{5}\n$$\n为了计算 $\\operatorname{Var}(X)$，我们使用公式 $\\operatorname{Var}(X) = \\mathbb{E}[X^2] - (\\mathbb{E}[X])^2$。我们首先需要 $\\mathbb{E}[X^2]$，我们再次使用全期望定律来找到它：$\\mathbb{E}[X^2] = \\mathbb{E}[\\mathbb{E}[X^2 \\mid Y]]$。\n$$\n\\mathbb{E}[X^2 \\mid Y] = \\begin{cases} \\sigma_0^2 + \\mu_0^2  \\text{若 } Y=0 \\\\ \\sigma_1^2 + \\mu_1^2  \\text{若 } Y=1 \\end{cases}\n$$\n对 $Y$ 取期望：\n$$\n\\mathbb{E}[X^2] = \\mathbb{E}[\\mathbb{E}[X^2 \\mid Y]] = (\\sigma_{0}^{2} + \\mu_{0}^2)(1-p) + (\\sigma_{1}^{2} + \\mu_{1}^2)p\n$$\n$$\n\\mathbb{E}[X^2] = (1)\\left(\\frac{3}{5}\\right) + (13)\\left(\\frac{2}{5}\\right) = \\frac{3}{5} + \\frac{26}{5} = \\frac{29}{5}\n$$\n现在我们可以计算方差：\n$$\n\\operatorname{Var}(X) = \\mathbb{E}[X^2] - (\\mathbb{E}[X])^2 = \\frac{29}{5} - \\left(\\frac{6}{5}\\right)^2 = \\frac{29}{5} - \\frac{36}{25} = \\frac{145}{25} - \\frac{36}{25} = \\frac{109}{25}\n$$\n\n2. 计算全方差定律的组成部分。\n\n全方差定律表明 $\\operatorname{Var}(X) = \\mathbb{E}[\\operatorname{Var}(X \\mid Y)] + \\operatorname{Var}(\\mathbb{E}[X \\mid Y])$。我们分别计算每一项。\n\n首先，我们计算条件方差的期望 $\\mathbb{E}[\\operatorname{Var}(X \\mid Y)]$。$\\operatorname{Var}(X \\mid Y)$ 这一项是一个随机变量，其值取决于 $Y$：\n$$\n\\operatorname{Var}(X \\mid Y) = \\begin{cases} \\sigma_0^2  \\text{若 } Y=0 \\\\ \\sigma_1^2  \\text{若 } Y=1 \\end{cases}\n$$\n对 $Y$ 取期望：\n$$\n\\mathbb{E}[\\operatorname{Var}(X \\mid Y)] = \\operatorname{Var}(X \\mid Y=0) \\cdot \\mathbb{P}(Y=0) + \\operatorname{Var}(X \\mid Y=1) \\cdot \\mathbb{P}(Y=1)\n$$\n$$\n\\mathbb{E}[\\operatorname{Var}(X \\mid Y)] = \\sigma_{0}^{2}(1-p) + \\sigma_{1}^{2}p = (1)\\left(\\frac{3}{5}\\right) + (4)\\left(\\frac{2}{5}\\right) = \\frac{3}{5} + \\frac{8}{5} = \\frac{11}{5}\n$$\n其次，我们计算条件期望的方差 $\\operatorname{Var}(\\mathbb{E}[X \\mid Y])$。令 $Z = \\mathbb{E}[X \\mid Y]$。从第1部分我们知道，$Z$ 是一个随机变量，它以概率 $1-p=\\frac{3}{5}$ 取值 $\\mu_0=0$，以概率 $p=\\frac{2}{5}$ 取值 $\\mu_1=3$。我们也已经求出了它的期望，$\\mathbb{E}[Z] = \\mathbb{E}[\\mathbb{E}[X \\mid Y]] = \\mathbb{E}[X] = \\frac{6}{5}$。为了求 $\\operatorname{Var}(Z)$，我们使用 $\\operatorname{Var}(Z) = \\mathbb{E}[Z^2] - (\\mathbb{E}[Z])^2$。我们必须计算 $\\mathbb{E}[Z^2] = \\mathbb{E}[(\\mathbb{E}[X \\mid Y])^2]$。\n$$\n\\mathbb{E}[(\\mathbb{E}[X \\mid Y])^2] = (\\mathbb{E}[X \\mid Y=0])^2 \\cdot \\mathbb{P}(Y=0) + (\\mathbb{E}[X \\mid Y=1])^2 \\cdot \\mathbb{P}(Y=1)\n$$\n$$\n\\mathbb{E}[(\\mathbb{E}[X \\mid Y])^2] = \\mu_{0}^2(1-p) + \\mu_{1}^2 p = (0)^2\\left(\\frac{3}{5}\\right) + (3)^2\\left(\\frac{2}{5}\\right) = 0 + \\frac{18}{5} = \\frac{18}{5}\n$$\n现在，我们计算条件期望的方差：\n$$\n\\operatorname{Var}(\\mathbb{E}[X \\mid Y]) = \\mathbb{E}[(\\mathbb{E}[X \\mid Y])^2] - (\\mathbb{E}[\\mathbb{E}[X \\mid Y]])^2 = \\frac{18}{5} - \\left(\\frac{6}{5}\\right)^2 = \\frac{18}{5} - \\frac{36}{25} = \\frac{90}{25} - \\frac{36}{25} = \\frac{54}{25}\n$$\n\n3. 验证和最终结果。\n\n我们现在验证在第2部分中计算的两个组成部分之和等于第1部分中直接计算的 $\\operatorname{Var}(X)$。\n$$\n\\mathbb{E}[\\operatorname{Var}(X \\mid Y)] + \\operatorname{Var}(\\mathbb{E}[X \\mid Y]) = \\frac{11}{5} + \\frac{54}{25} = \\frac{55}{25} + \\frac{54}{25} = \\frac{109}{25}\n$$\n这个结果与第1部分计算出的 $\\operatorname{Var}(X) = \\frac{109}{25}$ 的值相匹配。一致性得到验证。\n\n方差的共同值为 $\\operatorname{Var}(X) = \\frac{109}{25} = 4.36$。题目要求将此值报告为四位有效数字。因此，该值为 $4.360$。",
            "answer": "$$\n\\boxed{4.360}\n$$"
        },
        {
            "introduction": "从数值验证转向符号推导，这个实践探索了贝叶斯统计中的一个常见场景。我们将使用总方差定律来分析一个预测模型中的不确定性。这个练习揭示了总预测不确定性如何能够被优雅地分解为两个有意义的部分：过程的内在随机性和我们对模型参数的不确定性。",
            "id": "3354749",
            "problem": "考虑一个用于随机模拟和蒙特卡洛方法的层级贝叶斯数据生成机制。给定观测数据 $\\,D\\,$，一个潜参数 $\\,\\Theta\\,$ 的后验分布为 $\\,\\Theta\\,|\\,D \\sim \\mathcal{N}(\\mu_{D}, \\tau_{D}^{2})\\,$，其中 $\\,\\mu_{D}\\,$ 和 $\\,\\tau_{D}^{2}\\,$ 是依赖于数据的后验超参数。在以 $\\,\\Theta\\,$ 为条件下，预测量 $\\,X\\,$ 生成为 $\\,X\\,|\\,\\Theta \\sim \\mathcal{N}(\\Theta, \\sigma^{2})\\,$，其中 $\\,\\sigma^{2} > 0\\,$ 已知，并且在给定 $\\,\\Theta\\,$ 的情况下，$\\,X\\,|\\,\\Theta\\,$ 与 $\\,D\\,$ 独立。在蒙特卡洛模拟中，可以先对 $\\,\\Theta\\,|\\,D\\,$ 进行采样，然后再对 $\\,X\\,|\\,\\Theta\\,$ 进行采样，但在这里，你的目标是解析地推导出边际预测方差 $\\,\\operatorname{Var}(X\\,|\\,D)\\,$。\n\n仅从条件期望和方差的基本定义出发，并使用诸如条件期望的塔性质等标准属性，推导出 $\\,\\operatorname{Var}(X\\,|\\,D)\\,$ 的封闭形式表达式。不要引用任何现成的结果；相反，要展示这种关系是如何从第一性原理中产生的。将你的最终答案表示为关于 $\\,\\sigma^{2}\\,$ 和 $\\,\\tau_{D}^{2}\\,$ 的符号表达式。不需要进行数值舍入。",
            "solution": "该问题是有效的。这是一个在贝叶斯统计学（随机模拟方法的一个核心领域）中提法恰当、具有科学依据的问题。所有必要的信息都已提供，目标也已明确陈述。\n\n目标是推导在给定观测数据 $\\,D\\,$ 的情况下，量 $\\,X\\,$ 的边际预测方差 $\\operatorname{Var}(X\\,|\\,D)$。推导必须从第一性原理开始。\n\n全方差公式是本次推导的核心，它指出对于两个随机变量 $\\,X\\,$ 和 $\\,Y\\,$，有 $\\operatorname{Var}(X) = \\mathbb{E}[\\operatorname{Var}(X|Y)] + \\operatorname{Var}(\\mathbb{E}[X|Y])$。在我们的情境中，我们关心的是以数据 $\\,D\\,$ 为条件的方差和期望。等价的法则是 $\\operatorname{Var}(X\\,|\\,D) = \\mathbb{E}[\\operatorname{Var}(X\\,|\\,\\Theta, D)\\,|\\,D] + \\operatorname{Var}(\\mathbb{E}[X\\,|\\,\\Theta, D]\\,|\\,D)$。问题陈述，在给定 $\\,\\Theta\\,$ 的情况下，$\\,X\\,|\\,\\Theta\\,$ 与 $\\,D\\,$ 独立。这意味着一旦 $\\,\\Theta\\,$ 已知，以 $\\,D\\,$ 为条件并不会提供关于 $\\,X\\,$ 的额外信息。因此，$\\operatorname{Var}(X\\,|\\,\\Theta, D) = \\operatorname{Var}(X\\,|\\,\\Theta)\\,$ 且 $\\,\\mathbb{E}[X\\,|\\,\\Theta, D] = \\mathbb{E}[X\\,|\\,\\Theta]\\,$。该关系因此简化为：\n$$\n\\operatorname{Var}(X\\,|\\,D) = \\mathbb{E}[\\operatorname{Var}(X\\,|\\,\\Theta)\\,|\\,D] + \\operatorname{Var}(\\mathbb{E}[X\\,|\\,\\Theta]\\,|\\,D)\n$$\n根据题意，我们将从基本定义推导此关系。以 $\\,D\\,$ 为条件的 $\\,X\\,$ 的方差定义为：\n$$\n\\operatorname{Var}(X\\,|\\,D) = \\mathbb{E}[(X - \\mathbb{E}[X\\,|\\,D])^{2}\\,|\\,D]\n$$\n首先，我们使用全期望公式（或塔性质）来表示内部的期望 $\\,\\mathbb{E}[X\\,|\\,D]\\,$：\n$$\n\\mathbb{E}[X\\,|\\,D] = \\mathbb{E}[\\mathbb{E}[X\\,|\\,\\Theta, D]\\,|\\,D]\n$$\n鉴于在给定 $\\,\\Theta\\,$ 时 $\\,X\\,$ 和 $\\,D\\,$ 的条件独立性，我们有 $\\,\\mathbb{E}[X\\,|\\,\\Theta, D] = \\mathbb{E}[X\\,|\\,\\Theta]\\,$。所以，\n$$\n\\mathbb{E}[X\\,|\\,D] = \\mathbb{E}[\\mathbb{E}[X\\,|\\,\\Theta]\\,|\\,D]\n$$\n现在，我们将此代入方差定义中。我们在平方项内部加上并减去 $\\,\\mathbb{E}[X\\,|\\,\\Theta]\\,$：\n$$\n\\operatorname{Var}(X\\,|\\,D) = \\mathbb{E}[( (X - \\mathbb{E}[X\\,|\\,\\Theta]) + (\\mathbb{E}[X\\,|\\,\\Theta] - \\mathbb{E}[X\\,|\\,D]) )^{2}\\,|\\,D]\n$$\n展开平方项得到三项：\n$$\n\\operatorname{Var}(X\\,|\\,D) = \\mathbb{E}[(X - \\mathbb{E}[X\\,|\\,\\Theta])^{2}\\,|\\,D] + \\mathbb{E}[(\\mathbb{E}[X\\,|\\,\\Theta] - \\mathbb{E}[X\\,|\\,D])^{2}\\,|\\,D] + 2 \\mathbb{E}[(X - \\mathbb{E}[X\\,|\\,\\Theta])(\\mathbb{E}[X\\,|\\,\\Theta] - \\mathbb{E}[X\\,|\\,D])\\,|\\,D]\n$$\n我们来分析每一项。\n\n第1项：$\\,\\mathbb{E}[(X - \\mathbb{E}[X\\,|\\,\\Theta])^{2}\\,|\\,D]\\,$\n使用全期望公式，$\\,\\mathbb{E}[Y\\,|\\,D] = \\mathbb{E}[\\mathbb{E}[Y\\,|\\,\\Theta,D]\\,|\\,D]\\,$。令 $\\,Y = (X - \\mathbb{E}[X\\,|\\,\\Theta])^{2}\\,$。\n$$\n\\mathbb{E}[(X - \\mathbb{E}[X\\,|\\,\\Theta])^{2}\\,|\\,D] = \\mathbb{E}[\\mathbb{E}[(X - \\mathbb{E}[X\\,|\\,\\Theta])^{2}\\,|\\,\\Theta, D]\\,|\\,D]\n$$\n内部期望 $\\,\\mathbb{E}[(X - \\mathbb{E}[X\\,|\\,\\Theta])^{2}\\,|\\,\\Theta, D]\\,$ 是 $\\,\\operatorname{Var}(X\\,|\\,\\Theta, D)\\,$ 的定义。由于条件独立性，这等于 $\\,\\operatorname{Var}(X\\,|\\,\\Theta)\\,$。所以，第1项变为 $\\,\\mathbb{E}[\\operatorname{Var}(X\\,|\\,\\Theta)\\,|\\,D]\\,$。\n\n第2项：$\\,\\mathbb{E}[(\\mathbb{E}[X\\,|\\,\\Theta] - \\mathbb{E}[X\\,|\\,D])^{2}\\,|\\,D]\\,$\n这里的随机变量（相对于关于 $\\,\\Theta\\,|\\,D\\,$ 的外部期望而言）是 $\\,\\mathbb{E}[X\\,|\\,\\Theta]\\,$。项 $\\,\\mathbb{E}[X\\,|\\,D] = \\mathbb{E}[\\mathbb{E}[X\\,|\\,\\Theta]\\,|\\,D]\\,$ 是这个随机变量的期望。因此，根据定义，这个表达式是以 $\\,D\\,$ 为条件的 $\\,\\mathbb{E}[X\\,|\\,\\Theta]\\,$ 的方差。所以，第2项是 $\\,\\operatorname{Var}(\\mathbb{E}[X\\,|\\,\\Theta]\\,|\\,D)\\,$。\n\n第3项（交叉项）：$\\,2 \\mathbb{E}[(X - \\mathbb{E}[X\\,|\\,\\Theta])(\\mathbb{E}[X\\,|\\,\\Theta] - \\mathbb{E}[X\\,|\\,D])\\,|\\,D]\\,$\n再次，我们对内部表达式使用全期望公式：\n$$\n2 \\mathbb{E}[\\mathbb{E}[(X - \\mathbb{E}[X\\,|\\,\\Theta])(\\mathbb{E}[X\\,|\\,\\Theta] - \\mathbb{E}[X\\,|\\,D])\\,|\\,\\Theta, D]\\,|\\,D]\n$$\n考虑内部期望。在以 $\\,\\Theta\\,$ 和 $\\,D\\,$ 为条件下，项 $\\,(\\mathbb{E}[X\\,|\\,\\Theta] - \\mathbb{E}[X\\,|\\,D])\\,$ 相对于 $\\,X\\,$ 的随机性是常数，因此可以将其提出：\n$$\n(\\mathbb{E}[X\\,|\\,\\Theta] - \\mathbb{E}[X\\,|\\,D]) \\cdot \\mathbb{E}[X - \\mathbb{E}[X\\,|\\,\\Theta]\\,|\\,\\Theta, D]\n$$\n期望因子是 $\\,\\mathbb{E}[X\\,|\\,\\Theta, D] - \\mathbb{E}[\\mathbb{E}[X\\,|\\,\\Theta]\\,|\\,\\Theta, D]\\,$。因为 $\\,\\mathbb{E}[X\\,|\\,\\Theta,D] = \\mathbb{E}[X\\,|\\,\\Theta]\\,$ 并且在给定 $\\,\\Theta\\,$ 时 $\\,\\mathbb{E}[X\\,|\\,\\Theta]\\,$ 是一个常数，所以这变为 $\\,\\mathbb{E}[X\\,|\\,\\Theta] - \\mathbb{E}[X\\,|\\,\\Theta] = 0\\,$。\n因此，内部期望为零，使得整个交叉项为零。\n\n结合这三项的结果，证实了全方差公式：\n$$\n\\operatorname{Var}(X\\,|\\,D) = \\mathbb{E}[\\operatorname{Var}(X\\,|\\,\\Theta)\\,|\\,D] + \\operatorname{Var}(\\mathbb{E}[X\\,|\\,\\Theta]\\,|\\,D)\n$$\n现在我们将此公式应用于问题中给出的具体分布。\n\n步骤1：计算第一项 $\\,\\mathbb{E}[\\operatorname{Var}(X\\,|\\,\\Theta)\\,|\\,D]\\,$。\n给定 $\\,X\\,|\\,\\Theta \\sim \\mathcal{N}(\\Theta, \\sigma^{2})\\,$。以 $\\,\\Theta\\,$ 为条件的 $\\,X\\,$ 的方差就是这个正态分布的方差参数：\n$$\n\\operatorname{Var}(X\\,|\\,\\Theta) = \\sigma^{2}\n$$\n由于 $\\,\\sigma^{2}\\,$ 是一个已知常数，它不依赖于 $\\,\\Theta\\,$。常数的期望就是常数本身。\n$$\n\\mathbb{E}[\\operatorname{Var}(X\\,|\\,\\Theta)\\,|\\,D] = \\mathbb{E}[\\sigma^{2}\\,|\\,D] = \\sigma^{2}\n$$\n\n步骤2：计算第二项 $\\,\\operatorname{Var}(\\mathbb{E}[X\\,|\\,\\Theta]\\,|\\,D)\\,$。\n首先，我们求以 $\\,\\Theta\\,$ 为条件的 $\\,X\\,$ 的期望。由于 $\\,X\\,|\\,\\Theta \\sim \\mathcal{N}(\\Theta, \\sigma^{2})\\,$，期望是这个正态分布的均值参数：\n$$\n\\mathbb{E}[X\\,|\\,\\Theta] = \\Theta\n$$\n将此代入第二项的表达式中，我们需要求：\n$$\n\\operatorname{Var}(\\Theta\\,|\\,D)\n$$\n问题陈述，给定数据 $\\,D\\,$ 时 $\\,\\Theta\\,$ 的后验分布为 $\\,\\Theta\\,|\\,D \\sim \\mathcal{N}(\\mu_{D}, \\tau_{D}^{2})\\,$。根据定义，这个分布的方差是其方差参数：\n$$\n\\operatorname{Var}(\\Theta\\,|\\,D) = \\tau_{D}^{2}\n$$\n\n步骤3：合并结果。\n边际预测方差 $\\,\\operatorname{Var}(X\\,|\\,D)\\,$ 是上面计算出的两项之和：\n$$\n\\operatorname{Var}(X\\,|\\,D) = \\sigma^{2} + \\tau_{D}^{2}\n$$\n这个表达式代表了总预测不确定性。它由两部分组成：过程的内在变异性 $\\,(\\sigma^{2})\\,$ 和在观测到数据 $\\,D\\,$ 后参数 $\\,\\Theta\\,$ 的不确定性 $\\,(\\tau_{D}^{2})\\,$。",
            "answer": "$$\n\\boxed{\\sigma^{2} + \\tau_{D}^{2}}\n$$"
        },
        {
            "introduction": "为了连接理论与计算实践，最后一个练习将指导你构建一个蒙特卡洛模拟。你将凭经验估计方差分解的各个组成部分，并验证该定律在统计意义上是成立的。这项动手编码任务不仅巩固了理论概念，还引入了利用方差分解来量化模型变异性中“可解释”部分的强大思想。",
            "id": "3354823",
            "problem": "考虑相互独立的随机变量 $Y$ 和 $Z$，并通过线性关系 $X = aY + Z$ 定义 $X$，其中 $a$ 是一个实常数。令 $\\mathbb{E}[\\cdot]$ 表示期望，$\\operatorname{Var}[\\cdot]$ 表示方差。使用的基本定义是条件期望 $\\mathbb{E}[X \\mid Y]$、条件方差 $\\operatorname{Var}[X \\mid Y]$ 和无条件方差 $\\operatorname{Var}[X] = \\mathbb{E}[X^2] - (\\mathbb{E}[X])^2$。目标是创建一个可复现的蒙特卡洛（MC, Monte Carlo）实验，以估计 $\\operatorname{Var}[X]$ 分解为条件方差的均值和条件期望的方差，并量化调整 $Y$ 如何改变这种分解。\n\n您必须实现一个嵌套蒙特卡洛估计器，其过程如下。对于固定的整数 $N$（外部样本量）和固定的整数 $M$（内部样本量），从指定的 $Y$ 分布中抽取 $Y_1,\\dots,Y_N$。对于每个 $i \\in \\{1,\\dots,N\\}$，从指定的 $Z$ 分布中独立于 $Y$ 抽取 $Z_{i,1},\\dots,Z_{i,M}$。然后对所有 $i \\in \\{1,\\dots,N\\}$ 和 $j \\in \\{1,\\dots,M\\}$ 构建 $X_{i,j} = a Y_i + Z_{i,j}$。使用这些样本，根据基本定义计算以下三个估计量：\n- 估计的平均条件方差 $\\widehat{v}_{\\text{in}} = \\dfrac{1}{N}\\sum_{i=1}^N \\widehat{\\operatorname{Var}}_j\\!\\left(X_{i,j} \\mid Y_i\\right)$，其中 $\\widehat{\\operatorname{Var}}_j(\\cdot)$ 是在固定 $i$ 的情况下对 $M$ 个内部样本计算的样本方差，计算时不进行自由度校正。\n- 估计的条件均值的方差 $\\widehat{v}_{\\text{ex}} = \\widehat{\\operatorname{Var}}_i\\!\\left(\\widehat{m}(Y_i)\\right)$，其中 $\\widehat{m}(Y_i) = \\dfrac{1}{M}\\sum_{j=1}^M X_{i,j}$ 是在固定 $Y_i$ 时的内部样本均值，而 $\\widehat{\\operatorname{Var}}_i(\\cdot)$ 是对 $i \\in \\{1,\\dots,N\\}$ 计算的样本方差，计算时不进行自由度校正。\n- 估计的无条件方差 $\\widehat{v}_X = \\widehat{\\operatorname{Var}}\\!\\left(X_{i,j}\\right)$，它是对所有 $N \\times M$ 个样本 $\\{X_{i,j}\\}$ 计算的，不进行自由度校正。\n\n对于下面描述的每个测试用例，生成两个标量值：\n- 绝对分解残差 $\\Delta = \\left| \\widehat{v}_X - \\left(\\widehat{v}_{\\text{in}} + \\widehat{v}_{\\text{ex}}\\right) \\right|$。\n- 可解释比例 $\\rho = \\dfrac{\\widehat{v}_{\\text{ex}}}{\\widehat{v}_X}$。\n\n在所有测试用例中使用相同的 $N$ 和 $M$ 值，外部和内部样本量分别设置为 $N = 6000$ 和 $M = 40$。通过为每个测试用例使用指定的整数随机种子来确保可复现性；每个测试用例使用一个以给定种子初始化的伪随机数生成器来生成 $Y$ 和 $Z$。\n\n测试套件。将上述过程应用于以下五个科学上合理且自洽的参数集，每个参数集都指定了 $Y$ 的分布、$Z$ 的分布、系数 $a$ 和一个随机种子。在所有情况下，$Z$ 都是均值为 $0$、标准差为 $\\sigma_Z$ 的高斯分布，即 $Z \\sim \\mathcal{N}(0,\\sigma_Z^2)$。\n\n- 案例 $1$ (基准高斯分布): $Y \\sim \\mathcal{N}(0,\\sigma_Y^2)$，其中 $\\sigma_Y = 1$，$a = 2$，$\\sigma_Z = 1$，种子 $= 123456$。\n- 案例 $2$ (退化的 $Y$): $Y \\equiv 0$ (确定性常数)，$a = 2$，$\\sigma_Z = 1$，种子 $= 223344$。\n- 案例 $3$ (高方差 $Y$): $Y \\sim \\mathcal{N}(0,\\sigma_Y^2)$，其中 $\\sigma_Y = 5$，$a = 1.5$，$\\sigma_Z = 0.5$，种子 $= 345678$。\n- 案例 $4$ (重尾 $Y$): $Y = \\sigma_Y T$，其中 $T$ 服从自由度为 $\\nu = 5$ 的学生t分布 (Student-$t$ distribution)，且 $\\sigma_Y = 1$，$a = 1$，$\\sigma_Z = 1$，种子 $= 456789$。\n- 案例 $5$ (稀有事件二元 $Y$): $Y \\sim \\text{Bernoulli}(p)$，在 $\\{0,1\\}$ 中取值，其中 $p = 0.01$，$a = 3$，$\\sigma_Z = 1$，种子 $= 567890$。\n\n您的程序必须实现所定义的嵌套蒙特卡洛估计，并且必须生成单行输出，其中包含所有五个测试用例的汇总结果。输出格式必须是方括号内的一个逗号分隔列表，由每个案例的配对 $(\\Delta,\\rho)$ 按顺序组成，并扁平化为单个列表。例如，格式为 $[\\Delta_1,\\rho_1,\\Delta_2,\\rho_2,\\Delta_3,\\rho_3,\\Delta_4,\\rho_4,\\Delta_5,\\rho_5]$，其中每个 $\\Delta_k$ 和 $\\rho_k$ 都是一个浮点数。",
            "solution": "该问题要求实现一个嵌套蒙特卡洛模拟，以经验性地验证一个随机变量 $X$ 的全方差公式。该变量 $X$ 定义为两个独立随机变量 $Y$ 和 $Z$ 的线性变换，即 $X = aY + Z$。验证将通过估计方差的各个分量，并分析其与理论恒等式的残差来展示。\n\n这个问题的理论基础是全方差公式 (Law of Total Variance, LoTV)，也称为 Eve 定律，它指出对于任意两个随机变量 $X$ 和 $Y$ (不一定独立)，$X$ 的方差可以分解为：\n$$\n\\operatorname{Var}[X] = \\mathbb{E}[\\operatorname{Var}[X \\mid Y]] + \\operatorname{Var}[\\mathbb{E}[X \\mid Y]]\n$$\n项 $\\mathbb{E}[\\operatorname{Var}[X \\mid Y]]$ 代表给定 $Y$ 时 $X$ 的条件方差的期望值。它是 $X$ 的方差中不能被 $Y$ 的变异性所解释的部分。项 $\\operatorname{Var}[\\mathbb{E}[X \\mid Y]]$ 是给定 $Y$ 时 $X$ 的条件期望的方差。它代表 $X$ 的方差中可以被 $Y$ 的变异性所解释的部分。\n\n对于特定的线性模型 $X = aY + Z$，其中 $Y$ 和 $Z$ 是独立的，我们可以确定此分解的理论分量。\n给定 $Y=y$ 时 $X$ 的条件期望是：\n$$\n\\mathbb{E}[X \\mid Y=y] = \\mathbb{E}[aY + Z \\mid Y=y] = \\mathbb{E}[ay + Z] = ay + \\mathbb{E}[Z]\n$$\n因此，作为随机变量的条件期望是 $\\mathbb{E}[X \\mid Y] = aY + \\mathbb{E}[Z]$。该项的方差是：\n$$\n\\operatorname{Var}[\\mathbb{E}[X \\mid Y]] = \\operatorname{Var}[aY + \\mathbb{E}[Z]] = a^2 \\operatorname{Var}[Y]\n$$\n因为 $\\mathbb{E}[Z]$ 是一个常数。\n\n给定 $Y=y$ 时 $X$ 的条件方差是：\n$$\n\\operatorname{Var}[X \\mid Y=y] = \\operatorname{Var}[aY + Z \\mid Y=y] = \\operatorname{Var}[ay + Z] = \\operatorname{Var}[Z]\n$$\n因为在以 $Y=y$ 为条件时 $ay$ 是一个常数，并且 $Z$ 独立于 $Y$。条件方差是恒定的，不依赖于 $y$ 的值。因此，其期望就是：\n$$\n\\mathbb{E}[\\operatorname{Var}[X \\mid Y]] = \\mathbb{E}[\\operatorname{Var}[Z]] = \\operatorname{Var}[Z]\n$$\n将这些代入全方差公式 (LoTV)，我们得到关于独立变量缩放和的方差的著名结果：\n$$\n\\operatorname{Var}[X] = \\operatorname{Var}[Z] + a^2 \\operatorname{Var}[Y]\n$$\n该模拟旨在从生成的样本中估计项 $\\mathbb{E}[\\operatorname{Var}[X \\mid Y]]$ 和 $\\operatorname{Var}[\\mathbb{E}[X \\mid Y]]$，并验证它们的和与总方差 $\\operatorname{Var}[X]$ 的估计值是否相符。\n\n嵌套蒙特卡洛过程如下：\n1.  从 $Y$ 的分布中生成 $N$ 个外部样本 $Y_1, \\dots, Y_N$。\n2.  对于每个 $Y_i$，从 $Z$ 的分布中生成 $M$ 个内部样本 $Z_{i,1}, \\dots, Z_{i,M}$。\n3.  构建 $N \\times M$ 样本矩阵 $X_{i,j} = a Y_i + Z_{i,j}$。\n\n使用这些样本，按照规定计算以下估计量，不进行自由度校正（即使用总体方差公式）：\n-   估计的平均条件方差 $\\widehat{v}_{\\text{in}}$，它估计 $\\mathbb{E}[\\operatorname{Var}[X \\mid Y]]$。\n    $$\n    \\widehat{v}_{\\text{in}} = \\frac{1}{N}\\sum_{i=1}^N \\widehat{\\operatorname{Var}}_j(X_{i,j} \\mid Y_i) = \\frac{1}{N}\\sum_{i=1}^N \\left[ \\frac{1}{M}\\sum_{j=1}^M (X_{i,j} - \\bar{X}_{i\\cdot})^2 \\right]\n    $$\n    其中 $\\bar{X}_{i\\cdot} = \\frac{1}{M}\\sum_{j=1}^M X_{i,j}$ 是第 $i$ 个外部样本的样本均值。\n\n-   估计的条件均值的方差 $\\widehat{v}_{\\text{ex}}$，它估计 $\\operatorname{Var}[\\mathbb{E}[X \\mid Y]]$。\n    $$\n    \\widehat{v}_{\\text{ex}} = \\widehat{\\operatorname{Var}}_i(\\widehat{m}(Y_i)) = \\frac{1}{N}\\sum_{i=1}^N \\left( \\bar{X}_{i\\cdot} - \\bar{X}_{\\cdot\\cdot} \\right)^2\n    $$\n    其中 $\\widehat{m}(Y_i) = \\bar{X}_{i\\cdot}$ 且 $\\bar{X}_{\\cdot\\cdot} = \\frac{1}{N}\\sum_{i=1}^N \\bar{X}_{i\\cdot} = \\frac{1}{NM}\\sum_{i=1}^N\\sum_{j=1}^M X_{i,j}$ 是所有样本的总均值。\n\n-   估计的无条件方差 $\\widehat{v}_X$，它估计 $\\operatorname{Var}[X]$。\n    $$\n    \\widehat{v}_X = \\widehat{\\operatorname{Var}}(X_{i,j}) = \\frac{1}{NM}\\sum_{i=1}^N\\sum_{j=1}^M (X_{i,j} - \\bar{X}_{\\cdot\\cdot})^2\n    $$\n\n此问题的一个关键洞见是，这些经验估计量满足一个精确的代数恒等式，这与真实方差的全方差公式 (LoTV) 相类似。该恒等式源于总平方和的分解：\n$$\n\\sum_{i=1}^N\\sum_{j=1}^M (X_{i,j} - \\bar{X}_{\\cdot\\cdot})^2 = \\sum_{i=1}^N\\sum_{j=1}^M (X_{i,j} - \\bar{X}_{i\\cdot})^2 + M\\sum_{i=1}^N (\\bar{X}_{i\\cdot} - \\bar{X}_{\\cdot\\cdot})^2\n$$\n将整个方程除以总样本数 $NM$ 得到：\n$$\n\\frac{1}{NM}\\sum_{i,j} (X_{i,j} - \\bar{X}_{\\cdot\\cdot})^2 = \\frac{1}{N}\\sum_i \\left(\\frac{1}{M}\\sum_j (X_{i,j} - \\bar{X}_{i\\cdot})^2\\right) + \\frac{1}{N}\\sum_i (\\bar{X}_{i\\cdot} - \\bar{X}_{\\cdot\\cdot})^2\n$$\n这直接转化为恒等式 $\\widehat{v}_X = \\widehat{v}_{\\text{in}} + \\widehat{v}_{\\text{ex}}$。因此，绝对分解残差 $\\Delta = \\left| \\widehat{v}_X - (\\widehat{v}_{\\text{in}} + \\widehat{v}_{\\text{ex}}) \\right|$ 必须为零，除了可忽略的浮点精度误差外。它的计算是对指定估计量是否正确实现的一个强有力的验证。\n\n要计算的第二个量，即可解释比例 $\\rho = \\dfrac{\\widehat{v}_{\\text{ex}}}{\\widehat{v}_X}$，衡量了 $X$ 的总样本方差中可归因于条件均值的样本方差的比例，而这又反映了 $Y$ 的变异性。\n\n实现将使用 `numpy` 进行高效的向量化计算。对于每个测试用例，将使用指定的种子初始化一个 `numpy.random.default_rng` 实例以确保可复现性。用于 $Y$ 和 $Z$ 的随机变量将从此单个生成器实例生成。估计量使用 `numpy.var` 计算，其默认参数为 `ddof=0`，这与问题中不进行自由度校正的要求一致。该过程将应用于五个指定的参数集中的每一个。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n# scipy is not strictly needed as numpy.random.Generator provides the\n# necessary distributions, but it is listed as an available library.\n# We will use only numpy for consistency in random number generation.\n\ndef solve():\n    \"\"\"\n    Implements a nested Monte Carlo experiment to estimate the decomposition of Var[X]\n    for X = aY + Z, based on the Law of Total Variance.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (Y_type, Y_params, a, sigma_Z, seed)\n        ('gaussian', {'mu': 0.0, 'sigma': 1.0}, 2.0, 1.0, 123456),\n        ('constant', {'value': 0.0}, 2.0, 1.0, 223344),\n        ('gaussian', {'mu': 0.0, 'sigma': 5.0}, 1.5, 0.5, 345678),\n        ('student-t', {'df': 5, 'sigma': 1.0}, 1.0, 1.0, 456789),\n        ('bernoulli', {'p': 0.01}, 3.0, 1.0, 567890)\n    ]\n\n    N = 6000  # Outer sample size\n    M = 40    # Inner sample size\n    \n    results = []\n\n    for case in test_cases:\n        y_type, y_params, a, sigma_Z, seed = case\n        \n        # Initialize a single pseudorandom generator for reproducibility per case.\n        rng = np.random.default_rng(seed)\n\n        # Generate N outer samples for Y.\n        if y_type == 'gaussian':\n            Y_samples = rng.normal(loc=y_params['mu'], scale=y_params['sigma'], size=N)\n        elif y_type == 'constant':\n            Y_samples = np.full(N, y_params['value'], dtype=np.float64)\n        elif y_type == 'student-t':\n            # Y = sigma_Y * T, where T ~ Student-t(df)\n            Y_samples = y_params['sigma'] * rng.standard_t(df=y_params['df'], size=N)\n        elif y_type == 'bernoulli':\n            # Generate from binomial with n=1.\n            Y_samples = rng.binomial(n=1, p=y_params['p'], size=N).astype(np.float64)\n\n        # Generate N x M inner samples for Z, independent of Y.\n        # Z ~ N(0, sigma_Z^2)\n        Z_samples = rng.normal(loc=0.0, scale=sigma_Z, size=(N, M))\n\n        # Construct N x M samples for X using broadcasting.\n        # Y_samples[:, np.newaxis] reshapes (N,) to (N, 1) to allow addition with (N, M).\n        X_samples = a * Y_samples[:, np.newaxis] + Z_samples\n        \n        # --- Compute Estimators ---\n        # All variances are computed without degrees-of-freedom correction (ddof=0),\n        # as per the problem specification. This is the default for numpy.var.\n\n        # v_in: Estimated average conditional variance, E[Var(X|Y)].\n        # 1. Compute Var(X|Y_i) for each i across inner samples j.\n        var_j_X_given_Y = np.var(X_samples, axis=1) # Shape (N,)\n        # 2. Average these conditional variances.\n        v_in = np.mean(var_j_X_given_Y)\n\n        # v_ex: Estimated variance of conditional means, Var(E[X|Y]).\n        # 1. Compute E[X|Y_i] for each i across inner samples j.\n        m_hat_Y = np.mean(X_samples, axis=1) # Shape (N,)\n        # 2. Compute the variance of these conditional means.\n        v_ex = np.var(m_hat_Y)\n\n        # v_X: Estimated unconditional variance, Var(X).\n        # Computed across all N*M samples.\n        v_X = np.var(X_samples)\n\n        # --- Compute Final Quantities ---\n        \n        # Absolute decomposition residual. Due to an exact algebraic identity for sample\n        # variances, this should be zero up to floating-point error.\n        delta = np.abs(v_X - (v_in + v_ex))\n        \n        # Explained fraction rho.\n        # Handle potential division by zero, although v_X is highly unlikely to be zero.\n        if v_X == 0.0:\n            rho = np.nan\n        else:\n            rho = v_ex / v_X\n\n        results.extend([delta, rho])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}