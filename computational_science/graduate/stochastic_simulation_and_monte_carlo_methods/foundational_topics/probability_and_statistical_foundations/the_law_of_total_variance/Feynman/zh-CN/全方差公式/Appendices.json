{
    "hands_on_practices": [
        {
            "introduction": "理论的生命力在于其在具体实例中的体现。本练习旨在通过一个清晰定义的正态混合模型，从头开始验证全方差公式。通过分别计算总方差以及方差的两个分量——条件方差的期望和条件期望的方差，您将亲手确认这个重要恒等式的两边是相等的 ，从而加深对该定律结构的理解。",
            "id": "3354738",
            "problem": "考虑以下两点混合模型，该模型通常用于形式化蒙特卡洛（MC）模拟中的分层抽样。设 $Y \\in \\{0,1\\}$ 是一个伯努利随机变量，其 $\\mathbb{P}(Y=1)=p$，其中 $p=\\frac{2}{5}$。以 $Y$ 为条件，设 $X \\mid (Y=0) \\sim \\mathcal{N}(\\mu_{0},\\sigma_{0}^{2})$ 和 $X \\mid (Y=1) \\sim \\mathcal{N}(\\mu_{1},\\sigma_{1}^{2})$，参数为 $\\mu_{0}=0$、$\\sigma_{0}^{2}=1$、$\\mu_{1}=3$ 和 $\\sigma_{1}^{2}=4$。\n\n仅使用期望和方差的定义以及条件期望的塔式性质（即，对于任意可积随机变量 $Z$，有 $\\mathbb{E}[\\mathbb{E}[Z \\mid Y]]=\\mathbb{E}[Z]$），完成以下操作：\n\n1. 通过展开 $\\operatorname{Var}(X)=\\mathbb{E}[X^{2}] - (\\mathbb{E}[X])^{2}$ 并酌情以 $Y$ 为条件，直接计算 $\\mathbb{E}[X]$ 和 $\\operatorname{Var}(X)$。\n2. 仅使用条件均值和条件方差，分别计算 $\\mathbb{E}[\\operatorname{Var}(X \\mid Y)]$ 和 $\\operatorname{Var}(\\mathbb{E}[X \\mid Y])$。\n3. 通过显式计算验证求 $\\operatorname{Var}(X)$ 的两种途径结果一致，并以单个数字报告 $\\operatorname{Var}(X)$ 的共同值。\n\n将您最终报告的值四舍五入到四位有效数字。不需要单位。",
            "solution": "该问题提供了一个关于随机变量 $X$ 的两点混合模型。混合变量为 $Y \\sim \\text{Bernoulli}(p)$，其中 $\\mathbb{P}(Y=1)=p=\\frac{2}{5}$，因此 $\\mathbb{P}(Y=0)=1-p=\\frac{3}{5}$。给定 $Y$ 时 $X$ 的条件分布被指定为 $X \\mid (Y=0) \\sim \\mathcal{N}(\\mu_{0},\\sigma_{0}^{2})$ 和 $X \\mid (Y=1) \\sim \\mathcal{N}(\\mu_{1},\\sigma_{1}^{2})$。给定的参数为 $\\mu_{0}=0$、$\\sigma_{0}^{2}=1$、$\\mu_{1}=3$ 和 $\\sigma_{1}^{2}=4$。我们的任务是通过两种不同的方法计算 $X$ 的方差 $\\operatorname{Var}(X)$，并验证它们的一致性。\n\n首先，我们确定必要的条件矩。对于正态分布 $\\mathcal{N}(\\mu, \\sigma^2)$，均值为 $\\mu$，方差为 $\\sigma^2$。二阶矩为 $\\mathbb{E}[X^2] = \\operatorname{Var}(X) + (\\mathbb{E}[X])^2 = \\sigma^2 + \\mu^2$。\n因此，我们有以下条件矩：\n$\\mathbb{E}[X \\mid Y=0] = \\mu_{0} = 0$。\n$\\operatorname{Var}(X \\mid Y=0) = \\sigma_{0}^{2} = 1$。\n$\\mathbb{E}[X^2 \\mid Y=0] = \\sigma_{0}^{2} + \\mu_{0}^2 = 1 + 0^2 = 1$。\n\n$\\mathbb{E}[X \\mid Y=1] = \\mu_{1} = 3$。\n$\\operatorname{Var}(X \\mid Y=1) = \\sigma_{1}^{2} = 4$。\n$\\mathbb{E}[X^2 \\mid Y=1] = \\sigma_{1}^{2} + \\mu_{1}^2 = 4 + 3^2 = 4 + 9 = 13$。\n\n我们按顺序处理问题的三个部分。\n\n1. 直接计算 $\\mathbb{E}[X]$ 和 $\\operatorname{Var}(X)$。\n\n为了计算无条件期望 $\\mathbb{E}[X]$，我们使用全期望定律（或塔式性质）：$\\mathbb{E}[X] = \\mathbb{E}[\\mathbb{E}[X \\mid Y]]$。内层期望 $\\mathbb{E}[X \\mid Y]$ 是一个依赖于 $Y$ 的随机变量。\n$$\n\\mathbb{E}[X \\mid Y] = \\begin{cases} \\mu_0  \\text{ if } Y=0 \\\\ \\mu_1  \\text{ if } Y=1 \\end{cases}\n$$\n对 $Y$ 取期望：\n$$\n\\mathbb{E}[X] = \\mathbb{E}[\\mathbb{E}[X \\mid Y]] = \\mathbb{E}[X \\mid Y=0] \\cdot \\mathbb{P}(Y=0) + \\mathbb{E}[X \\mid Y=1] \\cdot \\mathbb{P}(Y=1)\n$$\n$$\n\\mathbb{E}[X] = \\mu_{0}(1-p) + \\mu_{1}p = (0)\\left(\\frac{3}{5}\\right) + (3)\\left(\\frac{2}{5}\\right) = 0 + \\frac{6}{5} = \\frac{6}{5}\n$$\n为了计算 $\\operatorname{Var}(X)$，我们使用公式 $\\operatorname{Var}(X) = \\mathbb{E}[X^2] - (\\mathbb{E}[X])^2$。我们首先需要 $\\mathbb{E}[X^2]$，我们再次使用全期望定律来求得：$\\mathbb{E}[X^2] = \\mathbb{E}[\\mathbb{E}[X^2 \\mid Y]]$。\n$$\n\\mathbb{E}[X^2 \\mid Y] = \\begin{cases} \\sigma_0^2 + \\mu_0^2  \\text{ if } Y=0 \\\\ \\sigma_1^2 + \\mu_1^2  \\text{ if } Y=1 \\end{cases}\n$$\n对 $Y$ 取期望：\n$$\n\\mathbb{E}[X^2] = \\mathbb{E}[\\mathbb{E}[X^2 \\mid Y]] = (\\sigma_{0}^{2} + \\mu_{0}^2)(1-p) + (\\sigma_{1}^{2} + \\mu_{1}^2)p\n$$\n$$\n\\mathbb{E}[X^2] = (1)\\left(\\frac{3}{5}\\right) + (13)\\left(\\frac{2}{5}\\right) = \\frac{3}{5} + \\frac{26}{5} = \\frac{29}{5}\n$$\n现在我们可以计算方差：\n$$\n\\operatorname{Var}(X) = \\mathbb{E}[X^2] - (\\mathbb{E}[X])^2 = \\frac{29}{5} - \\left(\\frac{6}{5}\\right)^2 = \\frac{29}{5} - \\frac{36}{25} = \\frac{145}{25} - \\frac{36}{25} = \\frac{109}{25}\n$$\n\n2. 计算全方差定律的组成部分。\n\n全方差定律指出 $\\operatorname{Var}(X) = \\mathbb{E}[\\operatorname{Var}(X \\mid Y)] + \\operatorname{Var}(\\mathbb{E}[X \\mid Y])$。我们分别计算每一项。\n\n首先，我们计算期望条件方差 $\\mathbb{E}[\\operatorname{Var}(X \\mid Y)]$。项 $\\operatorname{Var}(X \\mid Y)$ 是一个其值依赖于 $Y$ 的随机变量：\n$$\n\\operatorname{Var}(X \\mid Y) = \\begin{cases} \\sigma_0^2  \\text{ if } Y=0 \\\\ \\sigma_1^2  \\text{ if } Y=1 \\end{cases}\n$$\n对 $Y$ 取期望：\n$$\n\\mathbb{E}[\\operatorname{Var}(X \\mid Y)] = \\operatorname{Var}(X \\mid Y=0) \\cdot \\mathbb{P}(Y=0) + \\operatorname{Var}(X \\mid Y=1) \\cdot \\mathbb{P}(Y=1)\n$$\n$$\n\\mathbb{E}[\\operatorname{Var}(X \\mid Y)] = \\sigma_{0}^{2}(1-p) + \\sigma_{1}^{2}p = (1)\\left(\\frac{3}{5}\\right) + (4)\\left(\\frac{2}{5}\\right) = \\frac{3}{5} + \\frac{8}{5} = \\frac{11}{5}\n$$\n其次，我们计算条件期望的方差 $\\operatorname{Var}(\\mathbb{E}[X \\mid Y])$。设 $Z = \\mathbb{E}[X \\mid Y]$。从第1部分我们知道，$Z$ 是一个随机变量，它以概率 $1-p=\\frac{3}{5}$ 取值 $\\mu_0=0$，以概率 $p=\\frac{2}{5}$ 取值 $\\mu_1=3$。我们还求出了它的期望，$\\mathbb{E}[Z] = \\mathbb{E}[\\mathbb{E}[X \\mid Y]] = \\mathbb{E}[X] = \\frac{6}{5}$。为了求 $\\operatorname{Var}(Z)$，我们使用 $\\operatorname{Var}(Z) = \\mathbb{E}[Z^2] - (\\mathbb{E}[Z])^2$。我们必须计算 $\\mathbb{E}[Z^2] = \\mathbb{E}[(\\mathbb{E}[X \\mid Y])^2]$。\n$$\n\\mathbb{E}[(\\mathbb{E}[X \\mid Y])^2] = (\\mathbb{E}[X \\mid Y=0])^2 \\cdot \\mathbb{P}(Y=0) + (\\mathbb{E}[X \\mid Y=1])^2 \\cdot \\mathbb{P}(Y=1)\n$$\n$$\n\\mathbb{E}[(\\mathbb{E}[X \\mid Y])^2] = \\mu_{0}^2(1-p) + \\mu_{1}^2 p = (0)^2\\left(\\frac{3}{5}\\right) + (3)^2\\left(\\frac{2}{5}\\right) = 0 + \\frac{18}{5} = \\frac{18}{5}\n$$\n现在，我们计算条件期望的方差：\n$$\n\\operatorname{Var}(\\mathbb{E}[X \\mid Y]) = \\mathbb{E}[(\\mathbb{E}[X \\mid Y])^2] - (\\mathbb{E}[\\mathbb{E}[X \\mid Y]])^2 = \\frac{18}{5} - \\left(\\frac{6}{5}\\right)^2 = \\frac{18}{5} - \\frac{36}{25} = \\frac{90}{25} - \\frac{36}{25} = \\frac{54}{25}\n$$\n\n3. 验证与最终结果。\n\n我们现在验证第2部分计算的两个分量之和等于第1部分对 $\\operatorname{Var}(X)$ 的直接计算结果。\n$$\n\\mathbb{E}[\\operatorname{Var}(X \\mid Y)] + \\operatorname{Var}(\\mathbb{E}[X \\mid Y]) = \\frac{11}{5} + \\frac{54}{25} = \\frac{55}{25} + \\frac{54}{25} = \\frac{109}{25}\n$$\n这个结果与第1部分计算出的 $\\operatorname{Var}(X) = \\frac{109}{25}$ 的值相匹配。一致性得到验证。\n\n方差的共同值为 $\\operatorname{Var}(X) = \\frac{109}{25} = 4.36$。问题要求将此值报告为四位有效数字。因此，该值为 $4.360$。",
            "answer": "$$\n\\boxed{4.360}\n$$"
        },
        {
            "introduction": "从纸笔计算到计算机模拟是理解随机过程的关键一步。这个动手实践要求您编写一个嵌套蒙特卡洛实验，以经验性地探索全方差定律 。通过模拟数据并计算样本方差分量，您不仅能验证理论在有限样本下的表现，还能直观地量化不同输入变量对总方差的贡献，即所谓的“可解释方差”部分。",
            "id": "3354823",
            "problem": "考虑相互独立的随机变量 $Y$ 和 $Z$，通过线性关系 $X = aY + Z$ 定义 $X$，其中 $a$ 是一个实常数。令 $\\operatorname{E}[\\cdot]$ 表示期望，$\\operatorname{Var}[\\cdot]$ 表示方差。需要使用的基本定义是条件期望 $\\operatorname{E}[X \\mid Y]$、条件方差 $\\operatorname{Var}[X \\mid Y]$ 以及无条件方差 $\\operatorname{Var}[X] = \\operatorname{E}[X^2] - (\\operatorname{E}[X])^2$。目标是创建一个可复现的蒙特卡洛（MC, Monte Carlo）实验，以估计 $\\operatorname{Var}[X]$ 分解为一个条件方差的均值和一个条件期望的方差，并量化调整 $Y$ 如何改变此分解。\n\n您必须实现一个嵌套蒙特卡洛估计量，其过程如下。对于固定的整数 $N$（外层样本量）和固定的整数 $M$（内层样本量），从指定的 $Y$ 分布中抽取 $Y_1,\\dots,Y_N$。对于每个 $i \\in \\{1,\\dots,N\\}$，从指定的 $Z$ 分布中抽取与 $Y$ 独立的 $Z_{i,1},\\dots,Z_{i,M}$。然后，为所有 $i \\in \\{1,\\dots,N\\}$ 和 $j \\in \\{1,\\dots,M\\}$ 构建 $X_{i,j} = a Y_i + Z_{i,j}$。使用这些样本，根据基本定义计算以下三个估计量：\n- 估计的平均条件方差 $\\widehat{v}_{\\text{in}} = \\dfrac{1}{N}\\sum_{i=1}^N \\widehat{\\operatorname{Var}}_j\\!\\left(X_{i,j} \\mid Y_i\\right)$，其中 $\\widehat{\\operatorname{Var}}_j(\\cdot)$ 是针对固定 $i$ 在 $M$ 个内层样本上计算的样本方差，不进行自由度校正。\n- 估计的条件均值的方差 $\\widehat{v}_{\\text{ex}} = \\widehat{\\operatorname{Var}}_i\\!\\left(\\widehat{m}(Y_i)\\right)$，其中 $\\widehat{m}(Y_i) = \\dfrac{1}{M}\\sum_{j=1}^M X_{i,j}$ 是固定 $Y_i$ 处的内层样本均值，而 $\\widehat{\\operatorname{Var}}_i(\\cdot)$ 是在 $i \\in \\{1,\\dots,N\\}$ 上计算的样本方差，不进行自由度校正。\n- 估计的无条件方差 $\\widehat{v}_X = \\widehat{\\operatorname{Var}}\\!\\left(X_{i,j}\\right)$，在所有 $N \\times M$ 个样本 $\\{X_{i,j}\\}$ 上计算，不进行自由度校正。\n\n对于下述每个测试用例，生成两个标量值：\n- 绝对分解残差 $\\Delta = \\left| \\widehat{v}_X - \\left(\\widehat{v}_{\\text{in}} + \\widehat{v}_{\\text{ex}}\\right) \\right|$。\n- 已解释比例 $\\rho = \\dfrac{\\widehat{v}_{\\text{ex}}}{\\widehat{v}_X}$。\n\n在所有测试用例中使用相同的 $N$ 和 $M$ 值，外层和内层樣本量分别设为 $N = 6000$ 和 $M = 40$。通过为每个测试用例使用指定的整数随机种子来确保可复现性；每个测试用例使用一个以给定种子初始化的伪随机数生成器来生成 $Y$ 和 $Z$。\n\n测试套件。将上述程序应用于以下五个科学上合理且自洽的参数集，每个参数集都指定了 $Y$ 的分布、$Z$ 的分布、系数 $a$ 和一个随机种子。在所有情况下，$Z$ 均为均值为 $0$、标准差为 $\\sigma_Z$ 的高斯分布，即 $Z \\sim \\mathcal{N}(0,\\sigma_Z^2)$。\n\n- 案例 1（基准高斯）：$Y \\sim \\mathcal{N}(0,\\sigma_Y^2)$，其中 $\\sigma_Y = 1$，$a = 2$，$\\sigma_Z = 1$，种子 $= 123456$。\n- 案例 2（退化 $Y$）：$Y \\equiv 0$（确定性常数），$a = 2$，$\\sigma_Z = 1$，种子 $= 223344$。\n- 案例 3（高方差 $Y$）：$Y \\sim \\mathcal{N}(0,\\sigma_Y^2)$，其中 $\\sigma_Y = 5$，$a = 1.5$，$\\sigma_Z = 0.5$，种子 $= 345678$。\n- 案例 4（重尾 $Y$）：$Y = \\sigma_Y T$，其中 $T$ 服从自由度为 $\\nu = 5$ 的 Student-$t$ 分布，且 $\\sigma_Y = 1$，$a = 1$，$\\sigma_Z = 1$，种子 $= 456789$。\n- 案例 5（稀有事件二元 $Y$）：$Y \\sim \\text{Bernoulli}(p)$，在 $\\{0,1\\}$ 中取值，其中 $p = 0.01$，$a = 3$，$\\sigma_Z = 1$，种子 $= 567890$。\n\n您的程序必须实现所定义的嵌套蒙特卡洛估计，并且必须生成单行输出，其中包含所有五个测试用例的汇总结果。输出格式必须是方括号内的一个逗号分隔列表，由每个案例的有序对 $(\\Delta,\\rho)$ 组成，并展开成一个单一列表。例如，格式为 $[\\Delta_1,\\rho_1,\\Delta_2,\\rho_2,\\Delta_3,\\rho_3,\\Delta_4,\\rho_4,\\Delta_5,\\rho_5]$，其中每个 $\\Delta_k$ 和 $\\rho_k$ 都是浮点数。",
            "solution": "该问题要求实现一个嵌套蒙特卡洛模拟，以经验性地验证一个随机变量 $X$ 的全方差定律。该变量 $X$ 定义为两个独立随机变量 $Y$ 和 $Z$ 的线性变换，即 $X = aY + Z$。验证将通过估计方差的各分量并分析与理论恒等式之间的残差来展示。\n\n该问题的理论基础是全方差定律（Law of Total Variance, LoTV），也称为 Eve 定律，它指出对于任意两个随机变量 $X$ 和 $Y$（不一定独立），$X$ 的方差可以分解为：\n$$\n\\operatorname{Var}[X] = \\operatorname{E}[\\operatorname{Var}[X \\mid Y]] + \\operatorname{Var}[\\operatorname{E}[X \\mid Y]]\n$$\n项 $\\operatorname{E}[\\operatorname{Var}[X \\mid Y]]$ 代表给定 $Y$ 时 $X$ 的条件方差的期望值。它是 $X$ 的方差中不能被 $Y$ 的变异性解释的部分。项 $\\operatorname{Var}[\\operatorname{E}[X \\mid Y]]$ 是给定 $Y$ 时 $X$ 的条件期望的方差。它代表了 $X$ 的方差中可以被 $Y$ 的变异性解释的部分。\n\n对于特定的线性模型 $X = aY + Z$，其中 $Y$ 和 $Z$ 独立，我们可以确定此分解的理论分量。\n给定 $Y=y$ 时 $X$ 的条件期望是：\n$$\n\\operatorname{E}[X \\mid Y=y] = \\operatorname{E}[aY + Z \\mid Y=y] = \\operatorname{E}[ay + Z] = ay + \\operatorname{E}[Z]\n$$\n因此，作为随机变量的条件期望是 $\\operatorname{E}[X \\mid Y] = aY + \\operatorname{E}[Z]$。此项的方差是：\n$$\n\\operatorname{Var}[\\operatorname{E}[X \\mid Y]] = \\operatorname{Var}[aY + \\operatorname{E}[Z]] = a^2 \\operatorname{Var}[Y]\n$$\n因为 $\\operatorname{E}[Z]$ 是一个常数。\n\n给定 $Y=y$ 时 $X$ 的条件方差是：\n$$\n\\operatorname{Var}[X \\mid Y=y] = \\operatorname{Var}[aY + Z \\mid Y=y] = \\operatorname{Var}[ay + Z] = \\operatorname{Var}[Z]\n$$\n因为当以 $Y=y$为条件时，$ay$ 是一个常数，且 $Z$ 与 $Y$ 无关。条件方差是一个常数，不依赖于 $y$ 的值。因此，其期望就是：\n$$\n\\operatorname{E}[\\operatorname{Var}[X \\mid Y]] = \\operatorname{E}[\\operatorname{Var}[Z]] = \\operatorname{Var}[Z]\n$$\n将这些代入全方差定律，我们得到独立变量缩放和的方差的著名结果：\n$$\n\\operatorname{Var}[X] = \\operatorname{Var}[Z] + a^2 \\operatorname{Var}[Y]\n$$\n该模拟旨在估计项 $\\operatorname{E}[\\operatorname{Var}[X \\mid Y]]$ 和 $\\operatorname{Var}[\\operatorname{E}[X \\mid Y]]$，并将其总和与总方差 $\\operatorname{Var}[X]$ 的估计值进行核对。\n\n嵌套蒙特卡洛程序如下：\n1.  从 $Y$ 的分布中生成 $N$ 个外层样本 $Y_1, \\dots, Y_N$。\n2.  对于每个 $Y_i$，从 $Z$ 的分布中生成 $M$ 个内层样本 $Z_{i,1}, \\dots, Z_{i,M}$。\n3.  构建 $N \\times M$ 个样本矩阵 $X_{i,j} = a Y_i + Z_{i,j}$。\n\n使用这些样本，按规定计算以下估计量，不进行自由度校正（即使用总体方差公式）：\n-   估计的平均条件方差 $\\widehat{v}_{\\text{in}}$，用于估计 $\\operatorname{E}[\\operatorname{Var}[X \\mid Y]]$。\n    $$\n    \\widehat{v}_{\\text{in}} = \\frac{1}{N}\\sum_{i=1}^N \\widehat{\\operatorname{Var}}_j(X_{i,j} \\mid Y_i) = \\frac{1}{N}\\sum_{i=1}^N \\left[ \\frac{1}{M}\\sum_{j=1}^M (X_{i,j} - \\bar{X}_{i\\cdot})^2 \\right]\n    $$\n    其中 $\\bar{X}_{i\\cdot} = \\frac{1}{M}\\sum_{j=1}^M X_{i,j}$ 是第 $i$ 个外层样本的样本均值。\n\n-   估计的条件均值的方差 $\\widehat{v}_{\\text{ex}}$，用于估计 $\\operatorname{Var}[\\operatorname{E}[X \\mid Y]]$。\n    $$\n    \\widehat{v}_{\\text{ex}} = \\widehat{\\operatorname{Var}}_i(\\widehat{m}(Y_i)) = \\frac{1}{N}\\sum_{i=1}^N \\left( \\bar{X}_{i\\cdot} - \\bar{X}_{\\cdot\\cdot} \\right)^2\n    $$\n    其中 $\\widehat{m}(Y_i) = \\bar{X}_{i\\cdot}$ 且 $\\bar{X}_{\\cdot\\cdot} = \\frac{1}{N}\\sum_{i=1}^N \\bar{X}_{i\\cdot} = \\frac{1}{NM}\\sum_{i=1}^N\\sum_{j=1}^M X_{i,j}$ 是所有样本的总均值。\n\n-   估计的无条件方差 $\\widehat{v}_X$，用于估计 $\\operatorname{Var}[X]$。\n    $$\n    \\widehat{v}_X = \\widehat{\\operatorname{Var}}(X_{i,j}) = \\frac{1}{NM}\\sum_{i=1}^N\\sum_{j=1}^M (X_{i,j} - \\bar{X}_{\\cdot\\cdot})^2\n    $$\n\n此问题的一个关键洞见是，这些经验估计量满足一个精确的代数恒等式，这类似于真方差的全方差定律。该恒等式源于总平方和的分解：\n$$\n\\sum_{i=1}^N\\sum_{j=1}^M (X_{i,j} - \\bar{X}_{\\cdot\\cdot})^2 = \\sum_{i=1}^N\\sum_{j=1}^M (X_{i,j} - \\bar{X}_{i\\cdot})^2 + M\\sum_{i=1}^N (\\bar{X}_{i\\cdot} - \\bar{X}_{\\cdot\\cdot})^2\n$$\n将整个方程除以样本总数 $NM$，得到：\n$$\n\\frac{1}{NM}\\sum_{i,j} (X_{i,j} - \\bar{X}_{\\cdot\\cdot})^2 = \\frac{1}{N}\\sum_i \\left(\\frac{1}{M}\\sum_j (X_{i,j} - \\bar{X}_{i\\cdot})^2\\right) + \\frac{1}{N}\\sum_i (\\bar{X}_{i\\cdot} - \\bar{X}_{\\cdot\\cdot})^2\n$$\n这直接转化为恒等式 $\\widehat{v}_X = \\widehat{v}_{\\text{in}} + \\widehat{v}_{\\text{ex}}$。因此，绝对分解残差 $\\Delta = \\left| \\widehat{v}_X - (\\widehat{v}_{\\text{in}} + \\widehat{v}_{\\text{ex}}) \\right|$ 必须为零，除了可忽略的浮点精度误差外。其计算是对指定估计量正确实现的有力验证。\n\n要计算的第二个量是已解释比例 $\\rho = \\dfrac{\\widehat{v}_{\\text{ex}}}{\\widehat{v}_X}$，它衡量 $X$ 的总样本方差中可归因于条件均值样本方差的比例，而这又反映了 $Y$ 的变异性。\n\n实现将使用 `numpy` 进行高效的向量化计算。对于每个测试用例，使用指定的种子初始化一个 `numpy.random.default_rng` 实例以确保可复现性。$Y$ 和 $Z$ 的随机变量均从此单个生成器实例生成。估计量使用 `numpy.var` 及其默认参数 `ddof=0` 进行计算，这与问题要求的不进行自由度校正相符。该程序应用于五个指定的参数集中的每一个。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n# scipy is not strictly needed as numpy.random.Generator provides the\n# necessary distributions, but it is listed as an available library.\n# We will use only numpy for consistency in random number generation.\n\ndef solve():\n    \"\"\"\n    Implements a nested Monte Carlo experiment to estimate the decomposition of Var[X]\n    for X = aY + Z, based on the Law of Total Variance.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (Y_type, Y_params, a, sigma_Z, seed)\n        ('gaussian', {'mu': 0.0, 'sigma': 1.0}, 2.0, 1.0, 123456),\n        ('constant', {'value': 0.0}, 2.0, 1.0, 223344),\n        ('gaussian', {'mu': 0.0, 'sigma': 5.0}, 1.5, 0.5, 345678),\n        ('student-t', {'df': 5, 'sigma': 1.0}, 1.0, 1.0, 456789),\n        ('bernoulli', {'p': 0.01}, 3.0, 1.0, 567890)\n    ]\n\n    N = 6000  # Outer sample size\n    M = 40    # Inner sample size\n    \n    results = []\n\n    for case in test_cases:\n        y_type, y_params, a, sigma_Z, seed = case\n        \n        # Initialize a single pseudorandom generator for reproducibility per case.\n        rng = np.random.default_rng(seed)\n\n        # Generate N outer samples for Y.\n        if y_type == 'gaussian':\n            Y_samples = rng.normal(loc=y_params['mu'], scale=y_params['sigma'], size=N)\n        elif y_type == 'constant':\n            Y_samples = np.full(N, y_params['value'], dtype=np.float64)\n        elif y_type == 'student-t':\n            # Y = sigma_Y * T, where T ~ Student-t(df)\n            Y_samples = y_params['sigma'] * rng.standard_t(df=y_params['df'], size=N)\n        elif y_type == 'bernoulli':\n            # Generate from binomial with n=1.\n            Y_samples = rng.binomial(n=1, p=y_params['p'], size=N).astype(np.float64)\n\n        # Generate N x M inner samples for Z, independent of Y.\n        # Z ~ N(0, sigma_Z^2)\n        Z_samples = rng.normal(loc=0.0, scale=sigma_Z, size=(N, M))\n\n        # Construct N x M samples for X using broadcasting.\n        # Y_samples[:, np.newaxis] reshapes (N,) to (N, 1) to allow addition with (N, M).\n        X_samples = a * Y_samples[:, np.newaxis] + Z_samples\n        \n        # --- Compute Estimators ---\n        # All variances are computed without degrees-of-freedom correction (ddof=0),\n        # as per the problem specification. This is the default for numpy.var.\n\n        # v_in: Estimated average conditional variance, E[Var(X|Y)].\n        # 1. Compute Var(X|Y_i) for each i across inner samples j.\n        var_j_X_given_Y = np.var(X_samples, axis=1) # Shape (N,)\n        # 2. Average these conditional variances.\n        v_in = np.mean(var_j_X_given_Y)\n\n        # v_ex: Estimated variance of conditional means, Var(E[X|Y]).\n        # 1. Compute E[X|Y_i] for each i across inner samples j.\n        m_hat_Y = np.mean(X_samples, axis=1) # Shape (N,)\n        # 2. Compute the variance of these conditional means.\n        v_ex = np.var(m_hat_Y)\n\n        # v_X: Estimated unconditional variance, Var(X).\n        # Computed across all N*M samples.\n        v_X = np.var(X_samples)\n\n        # --- Compute Final Quantities ---\n        \n        # Absolute decomposition residual. Due to an exact algebraic identity for sample\n        # variances, this should be zero up to floating-point error.\n        delta = np.abs(v_X - (v_in + v_ex))\n        \n        # Explained fraction rho.\n        # Handle potential division by zero, although v_X is highly unlikely to be zero.\n        if v_X == 0.0:\n            rho = np.nan\n        else:\n            rho = v_ex / v_X\n\n        results.extend([delta, rho])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "全方差定律不仅是一个分析工具，更是一个用于设计高效算法的强大武器。本练习将引导您应用该定律来解决蒙特卡洛积分中的一个核心问题：如何最优地设置分层抽样的边界以最小化估计量的方差 。通过推导最优边界所满足的必要条件，您将体会到如何利用方差分解的洞察力来指导实际的方差缩减策略。",
            "id": "3354809",
            "problem": "考虑一个单变量随机输入的分层抽样设计，其中 $U$ 在单位区间上均匀分布，即 $U \\sim \\mathrm{Uniform}(0,1)$。设 $f:[0,1]\\to\\mathbb{R}$ 是一个连续可微的严格单调函数，表示蒙特卡洛（MC）计算中我们关心的标量输出。通过选择边界 $0=b_{0}  b_1  \\dots  b_{K-1}  b_K = 1$，我们将定义一个离散随机变量 $Y$ 来表示 $U$ 所在的层：如果 $U \\in [b_{k-1}, b_k)$，则 $Y=k$。我们的目标是最小化期望条件方差 $\\mathbb{E}[\\mathrm{Var}(f(U)\\mid Y)]$。\n\n首先，推导最优边界 $\\{b_j\\}_{j=1}^{K-1}$ 所需满足的一般必要条件。\n其次，将此条件应用于 $K=2$ 和 $f(u)=u^2$ 的特定情况，以找到唯一的内部最优边界 $b_1 \\in (0,1)$。",
            "solution": "目标是为分层边界 $\\{b_k\\}_{k=1}^{K-1}$ 找到一个必要的最优性准则，以最小化目标函数 $\\mathbb{E}\\big[\\mathrm{Var}(f(U)\\mid Y)\\big]$。该目标表示期望条件方差，即全方差公式 $\\mathrm{Var}(f(U)) = \\mathbb{E}[\\mathrm{Var}(f(U)\\mid Y)] + \\mathrm{Var}(\\mathbb{E}[f(U)\\mid Y)]$ 中的“层内方差”部分。\n\n设目标函数为 $L$。根据离散随机变量 $Y$ 的期望定义，目标函数可以写成对 $K$ 个层的求和：\n$$ L = \\mathbb{E}\\big[\\mathrm{Var}(f(U)\\mid Y)\\big] = \\sum_{k=1}^{K} \\mathrm{Var}(f(U)\\mid Y=k) \\cdot \\mathbb{P}(Y=k) $$\n使用题目中提供的符号，可得：\n$$ L(b_1, \\dots, b_{K-1}) = \\sum_{k=1}^{K} \\sigma_k^2 w_k $$\n题目定义了 $w_k = \\mathbb{P}(Y=k) = \\mathbb{P}(U \\in [b_{k-1}, b_k)) = b_k - b_{k-1}$，因为 $U \\sim \\mathrm{Uniform}(0,1)$。条件方差为 $\\sigma_k^2 = \\mathbb{E}[f(U)^2 \\mid Y=k] - (\\mathbb{E}[f(U) \\mid Y=k])^2$。\n\n为了将这些条件期望表示为积分，我们需要给定 $Y=k$ 时 $U$ 的条件概率密度。这是一个在区间 $[b_{k-1}, b_k)$ 上的均匀分布：\n$$ p(u \\mid Y=k) = \\begin{cases} \\frac{1}{b_k - b_{k-1}}  \\text{if } u \\in [b_{k-1}, b_k) \\\\ 0  \\text{otherwise} \\end{cases} $$\n条件矩是关于此密度的积分。具体来说，条件均值 $m_k$ 和 $f(U)^2$ 的条件期望为：\n$$ m_k = \\mathbb{E}[f(U) \\mid Y=k] = \\int_{b_{k-1}}^{b_k} f(u) \\frac{1}{b_k - b_{k-1}} du = \\frac{1}{w_k} \\int_{b_{k-1}}^{b_k} f(u) du $$\n$$ \\mathbb{E}[f(U)^2 \\mid Y=k] = \\int_{b_{k-1}}^{b_k} f(u)^2 \\frac{1}{b_k - b_{k-1}} du = \\frac{1}{w_k} \\int_{b_{k-1}}^{b_k} f(u)^2 du $$\n将这些代入 $\\sigma_k^2$ 的表达式中：\n$$ \\sigma_k^2 = \\frac{1}{w_k} \\int_{b_{k-1}}^{b_k} f(u)^2 du - m_k^2 = \\frac{1}{w_k} \\int_{b_{k-1}}^{b_k} f(u)^2 du - \\left(\\frac{1}{w_k} \\int_{b_{k-1}}^{b_k} f(u) du\\right)^2 $$\n目标函数 $L = \\sum w_k \\sigma_k^2$ 变为：\n$$ L = \\sum_{k=1}^{K} w_k \\left[ \\frac{1}{w_k} \\int_{b_{k-1}}^{b_k} f(u)^2 du - \\frac{1}{w_k^2} \\left(\\int_{b_{k-1}}^{b_k} f(u) du\\right)^2 \\right] $$\n$$ L = \\sum_{k=1}^{K} \\left[ \\int_{b_{k-1}}^{b_k} f(u)^2 du - \\frac{1}{b_k - b_{k-1}} \\left(\\int_{b_{k-1}}^{b_k} f(u) du\\right)^2 \\right] $$\n为了找到必要的最优性准则，我们将 $L$ 对任意内部边界 $b_j$（其中 $j \\in \\{1, \\dots, K-1\\}$）求导，并令导数等于零。边界 $b_j$ 仅出现在第 $j$ 层（作为上界）和第 $j+1$ 层（作为下界）的项中。设 $T_k$ 表示 $L$ 求和式中的第 $k$ 项。\n$$ \\frac{\\partial L}{\\partial b_j} = \\frac{\\partial T_j}{\\partial b_j} + \\frac{\\partial T_{j+1}}{\\partial b_j} $$\n我们使用莱布尼茨积分法则计算每个偏导数。\n对于项 $T_j(b_{j-1}, b_j) = \\int_{b_{j-1}}^{b_j} f(u)^2 du - \\frac{1}{b_j - b_{j-1}} (\\int_{b_{j-1}}^{b_j} f(u) du)^2$：\n$$ \\frac{\\partial T_j}{\\partial b_j} = f(b_j)^2 - \\frac{2\\left(\\int_{b_{j-1}}^{b_j} f(u) du\\right)f(b_j)(b_j - b_{j-1}) - \\left(\\int_{b_{j-1}}^{b_j} f(u) du\\right)^2(1)}{(b_j - b_{j-1})^2} $$\n将分子和分母同除以 $(b_j - b_{j-1})^2$ 并注意到 $m_j = \\frac{1}{b_j-b_{j-1}}\\int_{b_{j-1}}^{b_j} f(u) du$，我们得到：\n$$ \\frac{\\partial T_j}{\\partial b_j} = f(b_j)^2 - \\left[2 m_j f(b_j) - m_j^2\\right] = (f(b_j) - m_j)^2 $$\n对于项 $T_{j+1}(b_j, b_{j+1}) = \\int_{b_j}^{b_{j+1}} f(u)^2 du - \\frac{1}{b_{j+1} - b_j} (\\int_{b_j}^{b_{j+1}} f(u) du)^2$：\n$$ \\frac{\\partial T_{j+1}}{\\partial b_j} = -f(b_j)^2 - \\frac{2\\left(\\int_{b_j}^{b_{j+1}} f(u) du\\right)(-f(b_j))(b_{j+1} - b_j) - \\left(\\int_{b_j}^{b_{j+1}} f(u) du\\right)^2(-1)}{(b_{j+1} - b_j)^2} $$\n类似地，注意到 $m_{j+1} = \\frac{1}{b_{j+1}-b_j}\\int_{b_j}^{b_{j+1}} f(u) du$，我们有：\n$$ \\frac{\\partial T_{j+1}}{\\partial b_j} = -f(b_j)^2 - \\left[-2 m_{j+1} f(b_j) + m_{j+1}^2\\right] = - (f(b_j)^2 - 2m_{j+1}f(b_j) + m_{j+1}^2) = -(f(b_j) - m_{j+1})^2 $$\n对于最优配置，将总导数 $\\frac{\\partial L}{\\partial b_j}$ 设为零，可得：\n$$ (f(b_j) - m_j)^2 - (f(b_j) - m_{j+1})^2 = 0 $$\n这意味着 $|f(b_j) - m_j| = |f(b_j) - m_{j+1}|$，这导致两种可能性：\n1. $f(b_j) - m_j = f(b_j) - m_{j+1}$，简化为 $m_j = m_{j+1}$。\n2. $f(b_j) - m_j = -(f(b_j) - m_{j+1}) = m_{j+1} - f(b_j)$。\n\n函数 $f$ 被给定为严格单调。不失一般性，我们假设它是严格递增的。对于任何 $u_1 \\in [b_{j-1}, b_j)$ 和 $u_2 \\in [b_j, b_{j+1})$，我们有 $u_1  b_j \\leq u_2$，因此 $f(u_1)  f(u_2)$。条件均值 $m_j$ 是 $f(u)$ 在第一个区间上的平均值，而 $m_{j+1}$ 是在第二个区间上的平均值。因此，$m_j  m_{j+1}$。对于非退化区间，等式 $m_j = m_{j+1}$ 是不可能的，因此第一种情况被排除。\n\n因此，必要的最优性准则必须是第二种情况：\n$$ 2f(b_j) = m_j + m_{j+1} \\implies f(b_j) = \\frac{m_j + m_{j+1}}{2} $$\n该准则表明，在最优边界 $b_j$ 处，函数值 $f(b_j)$ 必须是 $f(U)$ 在两个相邻层中的条件期望的算术平均值。\n\n现在，我们特化到 $K=2$ 和 $f(u)=u^2$ 的情况。存在一个单一的内部边界 $b \\in (0,1)$。各层为 $[0, b)$ 和 $[b, 1)$。最优性准则变为：\n$$ f(b) = \\frac{m_1 + m_2}{2} $$\n其中 $m_1 = \\mathbb{E}[f(U) \\mid U \\in [0, b)]$ 和 $m_2 = \\mathbb{E}[f(U) \\mid U \\in [b, 1)]$。当 $f(u)=u^2$ 时，我们有 $f(b)=b^2$。我们计算条件均值：\n$$ m_1 = \\mathbb{E}[U^2 \\mid U \\in [0, b)] = \\int_0^b u^2 \\frac{1}{b} du = \\frac{1}{b} \\left[ \\frac{u^3}{3} \\right]_0^b = \\frac{b^3}{3b} = \\frac{b^2}{3} $$\n$$ m_2 = \\mathbb{E}[U^2 \\mid U \\in [b, 1)] = \\int_b^1 u^2 \\frac{1}{1-b} du = \\frac{1}{1-b} \\left[ \\frac{u^3}{3} \\right]_b^1 = \\frac{1-b^3}{3(1-b)} $$\n使用恒等式 $1-b^3 = (1-b)(1+b+b^2)$，我们简化 $m_2$：\n$$ m_2 = \\frac{(1-b)(1+b+b^2)}{3(1-b)} = \\frac{1+b+b^2}{3} $$\n将这些表达式代入最优性准则：\n$$ b^2 = \\frac{1}{2} \\left(\\frac{b^2}{3} + \\frac{1+b+b^2}{3}\\right) $$\n$$ b^2 = \\frac{1}{6} (b^2 + 1 + b + b^2) $$\n$$ 6b^2 = 2b^2 + b + 1 $$\n$$ 4b^2 - b - 1 = 0 $$\n这是一个关于最优边界 $b$ 的二次方程。我们使用二次公式求解 $b$：\n$$ b = \\frac{-(-1) \\pm \\sqrt{(-1)^2 - 4(4)(-1)}}{2(4)} = \\frac{1 \\pm \\sqrt{1 + 16}}{8} = \\frac{1 \\pm \\sqrt{17}}{8} $$\n我们有两个解：$b_1 = \\frac{1+\\sqrt{17}}{8}$ 和 $b_2 = \\frac{1-\\sqrt{17}}{8}$。\n边界 $b$ 必须位于区间 $(0,1)$ 内。我们知道 $4  \\sqrt{17}  5$。\n对于第一个根：$\\frac{1+4}{8}  b_1  \\frac{1+5}{8}$，所以 $0.625  b_1  0.75$。此根在有效区间 $(0,1)$ 内。\n对于第二个根：$\\frac{1-5}{8}  b_2  \\frac{1-4}{8}$，所以 $-0.5  b_2  -0.375$。此根为负，因此不是一个有效的边界。\n因此，最优边界的唯一有效解是 $b = \\frac{1+\\sqrt{17}}{8}$。",
            "answer": "$$\\boxed{\\frac{1+\\sqrt{17}}{8}}$$"
        }
    ]
}