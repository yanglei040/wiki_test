{
    "hands_on_practices": [
        {
            "introduction": "Gillespie算法的精髓在于它精确地模拟了下一个化学反应何时发生以及哪个反应会发生。这个练习将带我们回到第一性原理，通过分析一个简单的可逆反应系统，来推导第一个反应事件发生时间的概率分布。这有助于我们深入理解倾向性（propensity）$a_j$ 如何直接转化为可测量的、遵循指数分布的等待时间 。",
            "id": "3353349",
            "problem": "考虑一个充分混合、热平衡的系统，其中包含两种化学物种 $A$ 和 $B$，发生可逆反应网络 $A \\xrightarrow{c_1} B$ 和 $B \\xrightarrow{c_2} A$。该过程遵循质量作用动力学，并基于连续时间马尔可夫跳跃过程的标准假设。设初始分子数为 $(x_A,x_B)=(1,0)$，反应速率常数为 $c_1>0$ 和 $c_2>0$。随机模拟算法（SSA），特别是第一反应方法（FRM），通过将每个反应通道与一个等待时间相关联来概念化下一个反应事件，该等待时间由在当前状态下评估的相应风险（倾向）驱动。\n\n从以下基本原理出发：对于一个具有分段常数风险率的连续时间马尔可夫跳跃过程，(i) 一个反应通道的瞬时风险等于其在当前状态下的倾向，以及 (ii) 到下一个事件的等待时间由这些风险生成。请基于这些原理，为该反应网络在给定的初始条件下构建概念上的FRM。严格依据这些原理，推导首次反应事件发生时间 $t \\geq 0$ 的概率密度函数 $p(t)$，并（用文字而非作为最终数值表达式的一部分）确定在该初始状态下，哪个反应通道被选为首个事件。\n\n请以 $c_1$、$c_2$ 和 $t$ 的单个闭式解析表达式形式给出最终的 $p(t)$。最终答案中不应给出任何中间公式。无需进行数值计算。答案表示无需单位。",
            "solution": "在尝试任何解答之前，需对问题陈述进行验证。\n\n**步骤1：提取已知条件**\n- 系统：一个充分混合、热平衡的系统，包含两种化学物种 $A$ 和 $B$。\n- 反应网络：$A \\xrightarrow{c_1} B$（反应 $R_1$）和 $B \\xrightarrow{c_2} A$（反应 $R_2$）。\n- 模型：由质量作用动力学支配的连续时间马尔可夫跳跃过程。\n- 初始条件：时间 $t=0$ 时的分子数为 $(x_A, x_B) = (1, 0)$。\n- 速率常数：$c_1 > 0$ 和 $c_2 > 0$。\n- 算法背景：随机模拟算法（SSA），特别是第一反应方法（FRM）。\n- 基本原理：(i) 一个反应通道的瞬时风险等于其在当前状态下的倾向。(ii) 到下一个事件的等待时间由这些风险生成。\n- 要求输出：\n    1. 首次反应事件发生时间 $t \\geq 0$ 的概率密度函数 $p(t)$。\n    2. 用文字说明哪个反应通道被选为首个事件。\n\n**步骤2：验证**\n该问题具有科学依据，提法明确且客观。它描述了随机化学动力学中一个标准的、基本的情景。其假设（马尔可夫过程、质量作用动力学）是该领域的标准假设。初始条件和参数清晰明确且一致，可以得出唯一且有意义的解。该问题没有科学缺陷、歧义或信息缺失。\n\n**步骤3：结论**\n问题有效。将构建解答。\n\n**推导**\n\n系统在任意时间 $t$ 的状态由分子数向量 $\\mathbf{X}(t) = (x_A(t), x_B(t))$ 给出。初始状态指定为 $\\mathbf{X}(0) = (1, 0)$。系统通过两个可能的反应通道演化：\n$R_1: A \\xrightarrow{c_1} B$\n$R_2: B \\xrightarrow{c_2} A$\n\n根据质量作用动力学原理，反应通道 $R_j$ 的倾向函数或瞬时风险 $a_j(\\mathbf{x})$ 与状态 $\\mathbf{x}$ 下反应物分子的不同组合数量成正比。对于给定的一级反应，倾向函数为：\n- 对于 $R_1$：$a_1(\\mathbf{x}) = c_1 x_A$\n- 对于 $R_2$：$a_2(\\mathbf{x}) = c_2 x_B$\n\n问题要求从初始状态 $\\mathbf{X}(0) = (1, 0)$ 开始构建第一反应方法（FRM）的概念。在FRM中，我们将一个假定等待时间 $\\tau_j$ 与每个反应通道 $R_j$ 相关联。这个 $\\tau_j$ 是一个随机变量，表示如果反应 $R_j$ 是唯一可能发生的反应，它发生所需的时间。\n\n基于基本原理(ii)——等待时间由风险生成——以及已建立的泊松过程理论，具有恒定风险率 $\\lambda$ 的事件的等待时间服从速率参数为 $\\lambda$ 的指数分布。由于在连续时间马尔可夫跳跃过程中，倾向函数在两次反应事件之间是恒定的，因此我们可以应用此原理。\n\n首先，我们在初始状态 $\\mathbf{x} = (1, 0)$ 处评估倾向函数：\n$a_1(\\mathbf{X}(0)) = c_1 \\cdot 1 = c_1$\n$a_2(\\mathbf{X}(0)) = c_2 \\cdot 0 = 0$\n\n反应 $R_1$ 的风险为 $a_1 = c_1 > 0$。因此，我们可以为该反应生成一个假定等待时间 $\\tau_1$。$\\tau_1$ 是从速率参数为 $c_1$ 的指数分布中抽取的随机变量。$\\tau_1$ 的概率密度函数（PDF）为 $p_1(t) = c_1 \\exp(-c_1 t)$，其中 $t \\ge 0$。\n\n反应 $R_2$ 的风险为 $a_2 = 0$。风险为零意味着此事件在任何有限时间间隔内发生的概率为零。因此，该反应的等待时间 $\\tau_2$ 为无穷大。当系统处于状态 $(1, 0)$ 时，反应 $R_2$ 不可能发生。\n\n到*第一个*反应事件的时间，我们记为 $t$，是所有可能反应的假定等待时间的最小值：\n$t = \\min(\\tau_1, \\tau_2)$\n\n根据我们计算出的倾向函数，这变为：\n$t = \\min(\\tau_1, \\infty) = \\tau_1$\n\n该结果直接引出两个结论。首先，被选为第一个事件的反应通道是对应于最小等待时间的那个。由于 $\\tau_1$ 是有限的而 $\\tau_2$ 是无限的，因此明确无误地，第一个发生的反应是反应通道 $R_1: A \\xrightarrow{c_1} B$。\n\n其次，到这个首次反应事件发生时间的概率密度函数 $p(t)$ 必须与 $\\tau_1$ 的PDF相同。由于 $\\tau_1$ 服从速率参数为 $c_1$ 的指数分布，因此首次反应时间的PDF为：\n$p(t) = c_1 \\exp(-c_1 t)$，其中 $t \\ge 0$。\n\n这个 $p(t)$ 的表达式是用给定的参数 $c_1$ 和 $t$ 来表述的。参数 $c_2$ 没有出现，因为物种 $B$ 的初始缺失使得逆向反应不可能作为第一个事件发生，从而使其速率常数与第一个事件发生的时间无关。此推导严格遵守了问题中指定的基本原理。",
            "answer": "$$\n\\boxed{c_1 \\exp(-c_1 t)}\n$$"
        },
        {
            "introduction": "任何Gillespie算法实现的核心都是倾向性函数（propensity function）的计算。这个实践任务要求我们设计并实现一个通用的算法，该算法能够基于随机质量作用定律（stochastic mass-action kinetics）的组合学基础，为任意反应阶数的反应网络计算倾向性。通过这个练习，你将掌握处理从零阶到高阶，包括涉及多个相同反应物的同源反应（homogeneous reactions）的复杂情况，这是构建任何稳健的随机模拟器的关键一步 。",
            "id": "3353359",
            "problem": "考虑一个在随机质量作用动力学下的化学反应网络的充分混合、连续时间马尔可夫链模型，该模型被随机模拟算法（SSA），也称为 Gillespie 算法所使用。假设有 $d$ 个物种和 $R$ 个反应通道。系统状态是一个向量 $X \\in \\mathbb{N}^d$，其中 $X_i$ 是物种 $i$ 的分子数。每个反应通道 $r$ 由一个非负速率常数 $c_r$ 和一个反应物化学计量向量 $\\nu_r^- \\in \\mathbb{N}^d$ 来表征，该向量指示了当反应发生时每个物种被消耗的分子数量。反应级数是 $\\sum_{i=1}^d \\nu_{r,i}^-$。在随机质量作用动力学下，瞬时倾向 $a_r(X)$ 是内在速率常数 $c_r$ 与可从当前状态 $X$ 中提取的、与 $\\nu_r^-$ 给出的所需多重性一致的反应物分子的不同无序选择数量的乘积。如果对于任何物种 $i$ 都有 $X_i < \\nu_{r,i}^-$，那么 $a_r(X)$ 必须为零。\n\n任务。设计并实现一个鲁棒的通用算法，该算法在给定任意非负整数状态向量 $X \\in \\mathbb{N}^d$ 和一个反应列表 $\\{(c_r,\\nu_r^-)\\}_{r=1}^R$（其中反应级数范围从 0 到 3，包括 0 和 3）的情况下，返回根据上述原理计算出的所有倾向 $\\{a_r(X)\\}_{r=1}^R$。您的算法不得对单个反应模式进行特殊处理；它必须通过上述计数原理进行推导，为所有 0 到 3 级的反应正确计算反应物选择的数量。该算法必须在零级反应、分子数不足和重复的相同反应物等边界情况下保持正确。\n\n实现约束。程序必须是自包含的，并且不得读取任何输入。它必须为以下测试套件计算倾向。对于每个测试用例，物种按其在向量中的位置进行索引。每个反应被指定为一个对 $(c_r,\\nu_r^-)$，其中 $\\nu_r^-$ 按物种顺序列出。\n\n测试用例 A:\n- 物种数 $d = 4$，状态 $X = [6,5,3,0]$。\n- 反应（速率常数，反应物化学计量向量）：\n  - $(0.75,[0,0,0,0])$\n  - $(0.1,[1,0,0,0])$\n  - $(0.02,[1,1,0,0])$\n  - $(0.03,[0,2,0,0])$\n  - $(0.001,[1,1,1,0])$\n  - $(0.004,[2,1,0,0])$\n  - $(0.005,[3,0,0,0])$\n  - $(0.07,[0,0,2,0])$\n  - $(1.0,[0,0,0,1])$\n  - $(0.11,[0,1,1,0])$\n\n测试用例 B:\n- 物种数 $d = 3$，状态 $X = [2,1,0]$。\n- 反应：\n  - $(0.5,[3,0,0])$\n  - $(0.5,[2,1,0])$\n  - $(0.5,[1,1,1])$\n  - $(0.5,[0,2,0])$\n  - $(2.0,[0,0,0])$\n  - $(1.25,[1,0,0])$\n  - $(0.2,[1,1,0])$\n\n测试用例 C:\n- 物种数 $d = 2$，状态 $X = [50,40]$。\n- 反应：\n  - $(10^{-3},[2,0])$\n  - $(10^{-6},[3,0])$\n  - $(2\\times 10^{-4},[1,1])$\n  - $(10^{-6},[2,1])$\n  - $(10^{-7},[0,3])$\n  - $(3.14,[0,0])$\n  - $(0.01,[1,0])$\n\n输出规范。您的程序必须为每个测试用例计算所有倾向的列表，顺序与反应指定的顺序相同。然后，它必须生成单行输出，其中包含这三个列表，形式为用方括号括起来的逗号分隔列表，不含任何空白字符。具体而言，输出格式必须为 $[[\\cdot],[\\cdot],[\\cdot]]$，其中每个内部括号按顺序包含该测试用例的浮点数倾向值，以小数或标准科学记数法表示。在此任务中，输出是无量纲的。最后打印的行必须只包含此聚合列表，不含其他任何内容。",
            "solution": "我们从随机质量作用动力学下充分混合的反应网络的连续时间马尔可夫链描述开始。状态是 $X \\in \\mathbb{N}^d$，其中 $X_i$ 计算物种 $i$ 的分子数。一个反应通道 $r$ 由一个速率常数 $c_r \\ge 0$ 和一个反应物化学计量向量 $\\nu_r^- \\in \\mathbb{N}^d$ 定义。反应级数是 $\\sum_{i=1}^d \\nu_{r,i}^-$。在随机质量作用下，倾向 $a_r(X)$ 的基本定义是，$a_r(X)$ 等于 $c_r$ 与存在于 $X$ 中、且与 $\\nu_r^-$ 所需的多重性相匹配的反应物分子的不同无序选择数量的乘积。如果任何所需的多重性超过了可用的分子数，则不存在有效的选择，倾向必须为零。\n\n我们推导一个明确的计数规则。对于一个固定的反应通道 $r$，考虑有 $X_i$ 个不可区分的可用分子的物种 $i$。我们必须选择 $\\nu_{r,i}^-$ 个物种 $i$ 的分子参与反应（如果 $\\nu_{r,i}^- = 0$，则不从该物种中选择任何分子）。因为同一物种的分子是不可区分的，只有多重性有意义，所以从 $X_i$ 个分子中选择 $\\nu_{r,i}^-$ 个分子的方法数是二项式系数\n$$\n\\binom{X_i}{\\nu_{r,i}^-} =\n\\begin{cases}\n\\dfrac{X_i!}{\\nu_{r,i}!\\,(X_i-\\nu_{r,i}^-)!},  & \\text{if } 0 \\le \\nu_{r,i}^- \\le X_i,\\\\[6pt]\n0,  & \\text{if } \\nu_{r,i}^- > X_i.\n\\end{cases}\n$$\n跨物种的选择是独立的选择，因此与 $\\nu_r^-$ 一致的不同无序选择的总数是所有物种上的乘积：\n$$\nN_r(X) \\;=\\; \\prod_{i=1}^d \\binom{X_i}{\\nu_{r,i}^-}.\n$$\n因此，根据随机质量作用动力学的定义原则，倾向是\n$$\na_r(X) \\;=\\; c_r \\, N_r(X) \\;=\\; c_r \\prod_{i=1}^d \\binom{X_i}{\\nu_{r,i}^-}.\n$$\n这条单一规则同时处理所有情况：\n- 零级反应的 $\\nu_r^-$ 逐分量为 0，因此每个因子都是 $\\binom{X_i}{0} = 1$，且 $a_r(X) = c_r$。\n- 一级反应恰好有一个分量 $\\nu_{r,i}^- = 1$，得到 $a_r(X) = c_r X_i$。\n- 二级异构反应有两个不同物种的 $\\nu_{r,i}^- = 1$，给出 $a_r(X) = c_r X_i X_j$；二级同构反应对于单个物种有 $\\nu_{r,i}^- = 2$，给出 $a_r(X) = c_r \\binom{X_i}{2} = c_r X_i (X_i - 1)/2$。\n- 三级反应涵盖了跨物种的模式 $\\nu_{r,i}^- \\in \\{(3,0,\\dots),(2,1,0,\\dots),(1,1,1,0,\\dots)\\}$，当相关的多重性可用时，该公式分别特化为 $a_r(X) = c_r \\binom{X_i}{3}$、$a_r(X) = c_r \\binom{X_i}{2} X_j$ 和 $a_r(X) = c_r X_i X_j X_k$。如果任何所需的多重性超过了可用的 $X_i$，则相应的二项式系数为零，因此 $a_r(X) = 0$。\n\n算法设计。算法遍历反应 $r = 1,\\dots,R$。对于每个反应，它使用整数安全的二项式系数计算乘积 $\\prod_{i=1}^d \\binom{X_i}{\\nu_{r,i}^-}$。具体来说，对于每个物种 $i$：\n- 如果 $\\nu_{r,i}^- = 0$，因子为 1。\n- 否则，如果 $\\nu_{r,i}^- > X_i$，乘积变为 0，我们可以进行短路计算。\n- 否则，将累积乘积乘以精确的整数值 $\\binom{X_i}{\\nu_{r,i}^-}$。\n最后，将整数乘积与浮点速率常数 $c_r$ 相乘以获得 $a_r(X)$。这对于高达 3 级的反应在数值上是鲁棒的，因为所有二项式系数的大小都适中，并且可以精确地表示为整数，唯一的浮点舍入来源是最后乘以 $c_r$ 的缩放操作。\n\n复杂度。对于每个反应，计算成本为 $O(d)$ 时间，并使用 $O(1)$ 额外空间。对于给定的测试套件，这在计算上是微不足道的。\n\n现在我们评估指定的测试用例。\n\n测试用例 A：$X = [6,5,3,0]$ 及所列反应。应用 $a_r(X) = c_r \\prod_i \\binom{X_i}{\\nu_{r,i}^-}$：\n- $(0.75,[0,0,0,0])$: $0.75 \\times 1 = 0.75$.\n- $(0.1,[1,0,0,0])$: $0.1 \\times \\binom{6}{1} = 0.6$.\n- $(0.02,[1,1,0,0])$: $0.02 \\times \\binom{6}{1}\\binom{5}{1} = 0.6$.\n- $(0.03,[0,2,0,0])$: $0.03 \\times \\binom{5}{2} = 0.3$.\n- $(0.001,[1,1,1,0])$: $0.001 \\times \\binom{6}{1}\\binom{5}{1}\\binom{3}{1} = 0.09$.\n- $(0.004,[2,1,0,0])$: $0.004 \\times \\binom{6}{2}\\binom{5}{1} = 0.3$.\n- $(0.005,[3,0,0,0])$: $0.005 \\times \\binom{6}{3} = 0.1$.\n- $(0.07,[0,0,2,0])$: $0.07 \\times \\binom{3}{2} = 0.21$.\n- $(1.0,[0,0,0,1])$: $1.0 \\times \\binom{0}{1} = 0$.\n- $(0.11,[0,1,1,0])$: $0.11 \\times \\binom{5}{1}\\binom{3}{1} = 1.65$.\n因此，倾向列表是 $[0.75,0.6,0.6,0.3,0.09,0.3,0.1,0.21,0.0,1.65]$。\n\n测试用例 B：$X = [2,1,0]$：\n- $(0.5,[3,0,0])$: $0.5 \\times \\binom{2}{3} = 0$.\n- $(0.5,[2,1,0])$: $0.5 \\times \\binom{2}{2}\\binom{1}{1} = 0.5$.\n- $(0.5,[1,1,1])$: $0.5 \\times \\binom{0}{1} = 0$.\n- $(0.5,[0,2,0])$: $0.5 \\times \\binom{1}{2} = 0$.\n- $(2.0,[0,0,0])$: $2.0 \\times 1 = 2.0$.\n- $(1.25,[1,0,0])$: $1.25 \\times \\binom{2}{1} = 2.5$.\n- $(0.2,[1,1,0])$: $0.2 \\times \\binom{2}{1}\\binom{1}{1} = 0.4$.\n因此，倾向列表是 $[0.0,0.5,0.0,0.0,2.0,2.5,0.4]$。\n\n测试用例 C：$X = [50,40]$：\n- $(10^{-3},[2,0])$: $10^{-3} \\times \\binom{50}{2} = 1.225$.\n- $(10^{-6},[3,0])$: $10^{-6} \\times \\binom{50}{3} = 0.0196$.\n- $(2\\times 10^{-4},[1,1])$: $(2\\times 10^{-4}) \\times \\binom{50}{1}\\binom{40}{1} = 0.4$.\n- $(10^{-6},[2,1])$: $10^{-6} \\times \\binom{50}{2}\\binom{40}{1} = 0.049$.\n- $(10^{-7},[0,3])$: $10^{-7} \\times \\binom{40}{3} = 0.000988$.\n- $(3.14,[0,0])$: $3.14 \\times 1 = 3.14$.\n- $(0.01,[1,0])$: $0.01 \\times \\binom{50}{1} = 0.5$.\n因此，倾向列表是 $[1.225,0.0196,0.4,0.049,0.000988,3.14,0.5]$。\n\n下面的程序实现了所述的通用算法，将其应用于测试套件，并按照要求以单行、无空白的格式打印三个列表。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport math\nimport numpy as np  # numpy is available; not strictly needed but permitted.\n\ndef comb_nonneg(n: int, k: int) -> int:\n    \"\"\"Return C(n,k) for integers n,k with the convention C(n,k)=0 if k>n or k0.\"\"\"\n    if k  0:\n        return 0\n    if k  n:\n        return 0\n    # For k==0 or k==n, math.comb handles correctly as 1\n    return math.comb(n, k)\n\ndef propensity_for_reaction(state, reactant_stoich, rate_constant) - float:\n    \"\"\"\n    Compute propensity a = c * product_i C(state[i], reactant_stoich[i]).\n    If any required multiplicity exceeds availability, propensity is zero.\n    \"\"\"\n    product = 1\n    for xi, si in zip(state, reactant_stoich):\n        c = comb_nonneg(int(xi), int(si))\n        if c == 0:\n            return 0.0\n        product *= c\n    return float(rate_constant) * float(product)\n\ndef compute_propensities(state, reactions):\n    \"\"\"\n    state: list[int] of species counts\n    reactions: list of tuples (rate_constant: float, reactant_stoich: list[int])\n    returns: list[float] propensities\n    \"\"\"\n    props = []\n    for rate, stoich in reactions:\n        props.append(propensity_for_reaction(state, stoich, rate))\n    return props\n\ndef format_float(x: float) - str:\n    \"\"\"\n    Format a float into a concise string without unnecessary whitespace,\n    using up to 12 significant digits, avoiding long binary tails.\n    \"\"\"\n    # Use general format; this trims trailing zeros and uses scientific notation when appropriate.\n    s = format(x, \".12g\")\n    return s\n\ndef format_list_no_spaces(lst):\n    \"\"\"Format a list of floats as [v1,v2,...] with no spaces.\"\"\"\n    return \"[\" + \",\".join(format_float(x) for x in lst) + \"]\"\n\ndef solve():\n    # Define the test cases from the problem statement.\n\n    # Test case A\n    state_A = [6, 5, 3, 0]\n    reactions_A = [\n        (0.75, [0, 0, 0, 0]),\n        (0.1, [1, 0, 0, 0]),\n        (0.02, [1, 1, 0, 0]),\n        (0.03, [0, 2, 0, 0]),\n        (0.001, [1, 1, 1, 0]),\n        (0.004, [2, 1, 0, 0]),\n        (0.005, [3, 0, 0, 0]),\n        (0.07, [0, 0, 2, 0]),\n        (1.0, [0, 0, 0, 1]),\n        (0.11, [0, 1, 1, 0]),\n    ]\n\n    # Test case B\n    state_B = [2, 1, 0]\n    reactions_B = [\n        (0.5, [3, 0, 0]),\n        (0.5, [2, 1, 0]),\n        (0.5, [1, 1, 1]),\n        (0.5, [0, 2, 0]),\n        (2.0, [0, 0, 0]),\n        (1.25, [1, 0, 0]),\n        (0.2, [1, 1, 0]),\n    ]\n\n    # Test case C\n    state_C = [50, 40]\n    reactions_C = [\n        (1e-3, [2, 0]),\n        (1e-6, [3, 0]),\n        (2e-4, [1, 1]),\n        (1e-6, [2, 1]),\n        (1e-7, [0, 3]),\n        (3.14, [0, 0]),\n        (0.01, [1, 0]),\n    ]\n\n    test_cases = [\n        (state_A, reactions_A),\n        (state_B, reactions_B),\n        (state_C, reactions_C),\n    ]\n\n    results = []\n    for state, reactions in test_cases:\n        props = compute_propensities(state, reactions)\n        results.append(props)\n\n    # Prepare nested list formatting without spaces\n    inner = \",\".join(format_list_no_spaces(r) for r in results)\n    print(f\"[{inner}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "编写随机模拟算法只是第一步；验证其实现的正确性同样至关重要，甚至更具挑战性。这个练习将指导你如何设计一套全面的测试方案，以确保你的Gillespie算法实现不仅在算法逻辑上无误，而且在统计意义上也能精确地再现化学主方程（Chemical Master Equation）所描述的随机过程。通过辨别有效和无效的测试方法，你将学会如何从根本上验证一个随机模拟器的正确性，这是计算科学研究中一项必不可少的技能 。",
            "id": "3353365",
            "problem": "考虑为一个均匀混合的反应网络实现随机模拟算法（SSA），该网络被建模为一个连续时间马尔可夫链，其状态为 $\\mathbf{X}(t) \\in \\mathbb{Z}_{\\ge 0}^n$，化学计量变化向量为 $\\boldsymbol{\\nu}_j \\in \\mathbb{Z}^n$，倾向函数为 $a_j(\\mathbf{x})$，且满足化学主方程（CME）。一个团队提出了几种测试来验证他们SSA实现的正确性。您的任务是根据CME的基本原理以及作为SSA基础的连续时间马尔可夫链的构造，确定哪些提议的测试在理论上是合理的。在适当时，假设倾向函数是标准的质量作用类型，并且SSA使用的随机数是独立同分布于Uniform($0,1$)的。请选择所有有效的测试。\n\nA. 守恒定律和非负不变性测试：对于可逆单分子网络 $S_1 \\xrightleftharpoons[c_2]{c_1} S_2$，其倾向函数为 $a_1(\\mathbf{x}) = c_1 X_1$ 和 $a_2(\\mathbf{x}) = c_2 X_2$，在多条SSA轨迹上验证，对于所有 $t \\ge 0$，都有 $X_1(t) + X_2(t) = X_1(0) + X_2(0)$，并且对于所有 $t \\ge 0$，都有 $X_1(t) \\ge 0$ 和 $X_2(t) \\ge 0$。\n\nB. 零倾向边界情况测试：在一个包含选项A中可逆单分子反应的网络中，加入一个双分子反应 $2 S_1 \\to S_2$，其质量作用倾向为 $a_3(\\mathbf{x}) = c_3 \\binom{X_1}{2}$。以 $X_1(0) = 1$, $X_2(0) = 0$ 进行初始化。验证反应3永远不会发生，直到某个其他反应改变状态使得 $X_1 \\ge 2$，此时反应3的发生才成为可能。\n\nC. 单反应拟合优度测试：考虑单反应的生灭过程 $\\varnothing \\to S_1$，其倾向函数为常数 $a(\\mathbf{x}) = c$，与 $\\mathbf{x}$ 无关。使用多条独立的SSA路径，对事件间等待时间进行柯尔莫哥洛夫-斯米尔诺夫（KS）拟合优度检验，检验其是否服从速率为 $c$ 的指数分布；并进行卡方检验，检验在长度为 $T$ 的固定窗口内的事件计数是否服从均值为 $c T$ 的泊松分布。\n\nD. 首事件选择概率测试：对于一个具有由 $j \\in \\{1, \\dots, m\\}$ 索引的反应和倾向函数 $a_j(\\mathbf{x})$ 的通用网络，固定初始状态 $\\mathbf{X}(0) = \\mathbf{x}_0$。在多次独立运行中，在第一个反应发生后停止每个轨迹，并估计反应 $j$ 是第一个发生的概率。验证该经验概率与 $a_j(\\mathbf{x}_0) / a_0(\\mathbf{x}_0)$ 一致，其中 $a_0(\\mathbf{x}) = \\sum_{i=1}^m a_i(\\mathbf{x})$。\n\nE. 通用网络中的原始时间指数拟合：对于一个具有状态依赖倾向的通用多反应网络，汇集沿完整SSA轨迹观察到的所有事件间等待时间 $\\tau_k$，并执行KS检验，以确定 $\\tau_k$ 是否为速率为 $a_0(\\mathbf{X}(0))$ 的独立同分布指数随机变量。\n\nF. 时间重标度拟合优度测试：对于一个通用多反应网络，计算变换后的事件间时间 $Z_k = \\int_{t_k}^{t_{k+1}} a_0(\\mathbf{X}(s)) \\, ds$，其中 $t_k$ 和 $t_{k+1}$ 是连续的反应时间，且 $a_0(\\mathbf{x}) = \\sum_{j=1}^m a_j(\\mathbf{x})$。执行KS检验，以确定 $Z_k$ 是否为速率为 $1$ 的独立同分布指数随机变量，并辅以与速率为 $1$ 的指数分布的分位数-分位数图进行对比。\n\nG. 最大倾向启发式检查：在每个反应步骤中，验证发生的反应是所有反应中倾向 $a_j(\\mathbf{X})$ 最大的那个；标记任何倾向较小的反应发生的轨迹。\n\n选择所有理论上可用于验证SSA实现正确性的测试。",
            "solution": "该问题陈述在随机模拟领域内构成了一个有效且适定的查询。它要求评估几种为验证随机模拟算法（SSA，亦称Gillespie算法）实现的提议测试的理论合理性。该问题在科学上植根于连续时间马尔可夫链和化学主方程的理论，这些是SSA的基础。它是客观、明确的，并包含足够的信息以进行严谨的分析。\n\nSSA是一种精确的模拟方法，用于模拟均匀混合反应系统的随机时间演化。在每一步，对于处于状态 $\\mathbf{x}$ 的系统，该算法执行两个任务：\n1.  从速率为 $a_0(\\mathbf{x}) = \\sum_{j=1}^m a_j(\\mathbf{x})$ 的指数分布中抽取下一个事件发生的时间 $\\tau$。\n2.  从一个离散分布中抽取下一个反应的索引 $j$，其中选择反应 $j$ 的概率为 $a_j(\\mathbf{x}) / a_0(\\mathbf{x})$。\n\n然后，新状态在时间 $t + \\tau$ 变为 $\\mathbf{x} + \\boldsymbol{\\nu}_j$。所有提议的测试都将根据这些基本原理进行评估。\n\n**A. 守恒定律和非负不变性测试**\n\n此测试提议验证可逆反应 $S_1 \\xrightleftharpoons[c_2]{c_1} S_2$ 的两个属性。\n1.  **守恒定律**：反应是 $S_1 \\to S_2$ 和 $S_2 \\to S_1$。化学计量变化向量是 $\\boldsymbol{\\nu}_1 = (-1, 1)^T$ 和 $\\boldsymbol{\\nu}_2 = (1, -1)^T$，其中状态是 $(X_1, X_2)^T$。对于任何发生的反应，分子总数 $X_1 + X_2$ 的变化是 $\\Delta(X_1 + X_2) = \\nu_{j,1} + \\nu_{j,2}$。对于 $j=1$ 和 $j=2$，这个和都是 $0$。因此，$X_1(t) + X_2(t)$ 是系统的一个运动不变量，或称守恒定律。一个正确的SSA实现必须保留所有这样的线性守恒定律。验证 $X_1(t) + X_2(t) = X_1(0) + X_2(0)$ 是对状态更新步骤的有效测试。\n2.  **非负性**：状态变量 $X_1(t)$ 和 $X_2(t)$ 代表分子数量，必须是非负整数。质量作用倾向 $a_1(\\mathbf{x}) = c_1 X_1$ 和 $a_2(\\mathbf{x}) = c_2 X_2$ 的定义方式是，如果一个物种的数量为零（例如 $X_1 = 0$），那么消耗该物种的任何反应的倾向也为零（$a_1 = 0$）。根据SSA，倾向为零的反应被选择的概率为零。因此，一个正确的实现绝不允许会产生负布居数的反应发生。检查 $X_1(t) \\ge 0$ 和 $X_2(t) \\ge 0$ 是一个基础且有效的测试。\n\n此选项的结论是 **正确**。\n\n**B. 零倾向边界情况测试**\n\n此测试检验当一个反应倾向恰好为零时算法的行为。反应 $2S_1 \\to S_2$ 的质量作用倾向为 $a_3(\\mathbf{x}) = c_3 \\binom{X_1}{2} = c_3 \\frac{X_1(X_1-1)}{2}$。如果系统以 $X_1(0) = 1$ 初始化，初始倾向为 $a_3 = c_3 \\frac{1(1-1)}{2} = 0$。由于选择反应 $j$ 的概率是 $a_j(\\mathbf{x})/a_0(\\mathbf{x})$，选择反应3的概率是 $0/a_0(\\mathbf{x}) = 0$。反应3不能发生。只有当网络中的另一个反应首先将 $S_1$ 的布居数增加到至少为2时，它才可能发生。这是一个关键的边界情况。一个有缺陷的实现（例如，一个对浮点运算或索引处理不当的实现）可能会错误地选择一个倾向为零的反应。此测试旨在捕捉此类缺陷。\n\n此选项的结论是 **正确**。\n\n**C. 单反应拟合优度测试**\n\n此测试考虑一个简单的生灭过程 $\\varnothing \\to S_1$，其倾向为常数 $a(\\mathbf{x}) = c$。\n1.  **事件间时间**：总倾向为 $a_0(\\mathbf{x}) = c$，这是一个常数。根据SSA，连续事件之间的时间 $\\tau$ 必须从速率为 $a_0(\\mathbf{x}) = c$ 的指数分布中抽取。由于速率是恒定的，所有事件间时间都是来自 $\\text{Exponential}(c)$ 的独立同分布（i.i.d.）随机变量。柯尔莫哥洛夫-斯米尔诺夫（KS）检验是一种标准的统计程序，用于检验数据样本是否来自指定的连续分布。因此，这是检验SSA“何时”部分的有效方法。\n2.  **事件计数**：事件以恒定速率 $c$ 发生的过程是一个齐次泊松过程。对于这样的过程，在长度为 $T$ 的固定时间间隔内发生的事件数服从均值为 $\\lambda = cT$ 的泊松分布。卡方拟合优度检验是检验计数数据是否遵循特定离散分布（如泊松分布）的标准方法。这也是一种有效的验证方法。\n\n此选项的结论是 **正确**。\n\n**D. 首事件选择概率测试**\n\n此测试关注反应选择规则。对于一个固定的初始状态 $\\mathbf{X}(0) = \\mathbf{x}_0$，总倾向固定为 $a_0(\\mathbf{x}_0) = \\sum_{j=1}^m a_j(\\mathbf{x}_0)$。根据SSA的选择规则，第一个发生的反应是反应 $j$ 的理论概率为：$P(j|\\mathbf{x}_0) = a_j(\\mathbf{x}_0) / a_0(\\mathbf{x}_0)$。通过运行许多独立的模拟并记录哪个反应首先发生，可以生成一个经验频率分布。将此经验分布与理论概率 $\\{P(j|\\mathbf{x}_0)\\}_{j=1}^m$ 进行比较（例如，使用卡方检验），为SSA实现的“哪个”部分提供了直接而有力的验证。\n\n此选项的结论是 **正确**。\n\n**E. 通用网络中的原始时间指数拟合**\n\n此测试提议汇集通用网络轨迹中的所有事件间时间 $\\tau_k$，并检验它们是否服从速率为 $a_0(\\mathbf{X}(0))$ 的指数分布。这在理论上是不正确的。事件间时间 $\\tau_k$ 是从速率为 $a_0(\\mathbf{X}(t_{k-1}))$ 的指数分布中抽取的，其中 $\\mathbf{X}(t_{k-1})$ 是*那个时刻*的状态。在通用网络中，状态 $\\mathbf{X}$ 会改变，因此总倾向 $a_0$ 是时间的函数，$a_0(t) \\equiv a_0(\\mathbf{X}(t))$。因此，等待时间 $\\tau_k$ 是从具有*不同*速率的指数分布中抽取的。它们是独立的但不同分布的。将它们汇集起来会产生一个混合分布，而这个混合分布通常不是一个指数分布。将此混合分布与一个特定的指数分布（尤其是使用从初始时间任意选择的速率的分布）进行检验，在统计学和理论上都是没有根据的。\n\n此选项的结论是 **不正确**。\n\n**F. 时间重标度拟合优度测试**\n\n此测试是E的一个复杂而正确的替代方案。它使用了时间重标度定理。事件间时间 $\\tau_k = t_{k+1} - t_k$ 是一个从 $\\text{Exponential}(\\lambda_k)$ 中抽取的随机变量，其中速率为 $\\lambda_k = a_0(\\mathbf{X}(t_k))$。状态 $\\mathbf{X}(s)$ 在 $s \\in [t_k, t_{k+1})$ 区间内是恒定的，所以在此区间内 $\\mathbf{X}(s) = \\mathbf{X}(t_k)$。提议的变换变量是 $Z_k = \\int_{t_k}^{t_{k+1}} a_0(\\mathbf{X}(s)) \\, ds$。由于被积函数是常数，这变为 $Z_k = a_0(\\mathbf{X}(t_k)) \\cdot (t_{k+1} - t_k) = \\lambda_k \\tau_k$。如果一个随机变量 $\\tau_k \\sim \\text{Exponential}(\\lambda_k)$，那么缩放后的随机变量 $Z_k = \\lambda_k \\tau_k$ 服从速率为 $1$ 的指数分布。这对每一步 $k$ 都成立。因此，变换后的时间序列 $\\{Z_k\\}$ 应该是一个来自标准 $\\text{Exponential}(1)$ 分布的独立同分布随机变量样本。使用KS检验或Q-Q图来验证这一点，是在具有状态依赖倾向的通用情况下验证SSA时间方面的有效且理论上合理的方法。\n\n此选项的结论是 **正确**。\n\n**G. 最大倾向启发式检查**\n\n此测试提议验证发生的反应总是倾向最大的那个。这是对SSA的根本误解。SSA是一个随机算法，而不是确定性算法。倾向决定的是反应的*概率*，而不是确定性的选择。反应 $j$ 以概率 $a_j(\\mathbf{x}) / a_0(\\mathbf{x})$ 被选择。虽然倾向较大的反应更有可能被选择，但任何倾向非零的反应都有非零的发生几率。例如，如果 $a_1(\\mathbf{x}) = 100$ 而 $a_2(\\mathbf{x}) = 1$，反应2有大约 $1/101$ 的微小但非零的概率被选中。一个正确的SSA实现必须能够选择反应2。将发生这种情况的轨迹标记为错误是错误的。这个测试描述的是一种贪心算法，而不是SSA。\n\n此选项的结论是 **不正确**。\n\n总而言之，理论上有效的测试是A、B、C、D和F。",
            "answer": "$$\\boxed{ABCDF}$$"
        }
    ]
}