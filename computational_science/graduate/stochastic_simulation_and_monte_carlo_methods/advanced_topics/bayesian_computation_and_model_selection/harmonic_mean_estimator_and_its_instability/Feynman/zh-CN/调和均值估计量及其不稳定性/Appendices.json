{
    "hands_on_practices": [
        {
            "introduction": "要深刻理解谐波平均估计量（Harmonic Mean Estimator, HME）的不稳定性，从一个简化的“玩具模型”入手会非常有启发性。本练习将引导你通过一个特例来揭示不稳定的核心机制，通过对比有界支撑和无界支撑的似然函数，你将亲手推导出估计量的方差如何从稳定（零方差）变为不稳定（无限方差），从而从第一性原理建立直观认识。",
            "id": "3311537",
            "problem": "考虑一个贝叶斯模型，其参数空间为 $\\Theta \\subset \\mathbb{R}^{d}$，配备有勒贝格测度，并有一个固定的观测数据值 $y$。边缘似然（也称为证据）由积分 $Z = \\int_{\\Theta} p(y \\mid \\theta)\\,\\pi(\\theta)\\,d\\theta$ 定义，后验密度由 $p(\\theta \\mid y) \\propto p(y \\mid \\theta)\\,\\pi(\\theta)$ 定义，其中 $\\pi(\\theta)$ 是一个正常先验密度。调和平均（HM）估计量是通过从后验 $p(\\theta \\mid y)$ 中抽取独立样本 $\\theta^{(1)},\\dots,\\theta^{(M)}$ 并设置 $\\widehat{Z}_{\\mathrm{HM}} = \\left\\{\\frac{1}{M}\\sum_{m=1}^{M} U(\\theta^{(m)})\\right\\}^{-1}$ 得到的，其中 $U(\\theta) = \\frac{1}{p(y \\mid \\theta)}$。HM 估计量稳定性的一个充分条件是 $U(\\theta)$ 在后验分布下几乎必然有界。在本练习中，你将使用一个有界支撑集的玩具似然来证明这种稳定性，然后将其与一个无界支撑集的情况进行对比，以分离出不稳定的机制，整个过程仅需使用核心定义和标准积分事实。\n\n首先假设存在一个可测集 $A \\subset \\Theta$，其勒贝格测度 $|A| \\in (0,\\infty)$ 有限且严格为正，使得似然为 $p(y \\mid \\theta) = \\mathbf{1}\\{\\theta \\in A\\}/|A|$，先验为同一集合 $A$ 上的均匀密度 $\\pi(\\theta) = \\mathbf{1}\\{\\theta \\in A\\}/|A|$。\n\n1. 在这个有界支撑集模型中，仅使用 $Z$ 和 $p(\\theta \\mid y)$ 的定义，计算 $Z$ 和 $p(\\theta \\mid y)$。然后定义 $U(\\theta) = \\frac{1}{p(y \\mid \\theta)}$ 并确定其在 $p(\\theta \\mid y)$ 下的分布，包括其期望和方差。\n\n2. 使用 $\\widehat{Z}_{\\mathrm{HM}}$ 的定义和第 1 部分中 $U(\\theta)$ 的分布性质，计算对于任意样本量 $M \\geq 1$ 的精确方差 $\\mathrm{Var}\\!\\left(\\widehat{Z}_{\\mathrm{HM}}\\right)$。你的答案必须是一个实数或一个单一的闭式解析表达式。无需四舍五入。\n\n3. 现在用一个无界支撑集的例子替换有界支撑集的设置，以分离出不稳定的机制。令 $\\pi(\\theta)$ 为 $\\mathbb{R}$ 上的高斯先验 $\\pi(\\theta) = \\varphi(\\theta; 0, \\tau_{0}^{2})$，其中 $\\varphi(\\,\\cdot\\,; \\mu, \\sigma^{2})$ 表示均值为 $\\mu$、方差为 $\\sigma^{2}$ 的正态密度，并令似然为作为 $\\theta \\in \\mathbb{R}$ 函数的 $p(y \\mid \\theta) = \\varphi(y; \\theta, \\sigma^{2})$。推导一个关于常数 $c > 0$ 的充要条件，使得 $\\mathbb{E}_{p(\\theta \\mid y)}\\!\\left[\\exp\\!\\big(c\\,(\\theta - y)^{2}\\big)\\right]$ 是有限的，并用后验方差表示该条件。然后在 $c = \\frac{1}{2\\sigma^{2}}$ 和 $c = \\frac{1}{\\sigma^{2}}$ 处评估此条件，以分别对 $\\mathbb{E}_{p(\\theta \\mid y)}[U(\\theta)]$ 和 $\\mathrm{Var}_{p(\\theta \\mid y)}(U(\\theta))$ 的有限性得出结论，并简要解释这种对比如何揭示 HM 估计量在无界支撑集设置中变得不稳定的机制。\n\n仅报告第 2 部分中 $\\mathrm{Var}\\!\\left(\\widehat{Z}_{\\mathrm{HM}}\\right)$ 的值作为你的最终答案。",
            "solution": "该问题要求在两种不同设置下对边缘似然 $Z$ 的调和平均（HM）估计量进行分析：一个稳定的有界支撑集情况和一个潜在不稳定的无界支撑集情况。我们必须首先验证问题陈述。该问题是贝叶斯统计和蒙特卡洛方法中一个定义明确的理论练习。它提供了所有必要的定义，并使用了标准的数学模型（均匀分布和正态分布）。该问题是自洽的、逻辑一致的、有科学依据且客观的。没有会使其无效的缺陷。我们可以继续进行解答。\n\n问题分为三个部分。我们将按顺序解决它们，以提供一个完整、有理有据的解答，尽管最终答案只需要第 2 部分的结果。\n\n**第 1 部分：有界支撑集模型分析**\n\n首先，我们计算有界支撑集模型的边缘似然 $Z$ 和后验密度 $p(\\theta \\mid y)$。\n边缘似然，或称证据，定义为 $Z = \\int_{\\Theta} p(y \\mid \\theta)\\,\\pi(\\theta)\\,d\\theta$。\n给定的似然为 $p(y \\mid \\theta) = \\frac{\\mathbf{1}\\{\\theta \\in A\\}}{|A|}$，先验为 $\\pi(\\theta) = \\frac{\\mathbf{1}\\{\\theta \\in A\\}}{|A|}$，其中 $|A|$ 是集合 $A$ 的有限非零勒贝格测度。\n将这些代入 $Z$ 的定义中：\n$$ Z = \\int_{\\Theta} \\left(\\frac{\\mathbf{1}\\{\\theta \\in A\\}}{|A|}\\right) \\left(\\frac{\\mathbf{1}\\{\\theta \\in A\\}}{|A|}\\right) \\,d\\theta = \\int_{\\Theta} \\frac{\\mathbf{1}\\{\\theta \\in A\\}}{|A|^2} \\,d\\theta $$\n由于被积函数在集合 $A$ 之外为零，我们可以将积分域更改为 $A$：\n$$ Z = \\frac{1}{|A|^2} \\int_{A} 1 \\,d\\theta = \\frac{1}{|A|^2} |A| = \\frac{1}{|A|} $$\n后验密度由贝叶斯定理给出，$p(\\theta \\mid y) = \\frac{p(y \\mid \\theta)\\pi(\\theta)}{Z}$。使用我们刚刚计算的分子表达式和 $Z$ 的值：\n$$ p(\\theta \\mid y) = \\frac{\\frac{\\mathbf{1}\\{\\theta \\in A\\}}{|A|^2}}{\\frac{1}{|A|}} = \\frac{\\mathbf{1}\\{\\theta \\in A\\}}{|A|} $$\n这个结果表明 $\\theta$ 的后验分布是集合 $A$ 上的均匀分布。\n\n接下来，我们分析函数 $U(\\theta) = \\frac{1}{p(y \\mid \\theta)}$。调和平均估计量是使用从后验分布 $p(\\theta \\mid y)$ 中抽取的样本 $\\theta^{(m)}$ 构建的。由于 $p(\\theta \\mid y)$ 的支撑集是集合 $A$，因此从该分布中抽取的任何样本 $\\theta$ 将几乎必然地位于 $A$ 中。对于任何 $\\theta \\in A$，似然是一个常数：$p(y \\mid \\theta) = \\frac{1}{|A|}$。\n因此，对于任何后验样本 $\\theta$，$U(\\theta)$ 的值为：\n$$ U(\\theta) = \\frac{1}{p(y \\mid \\theta)} = \\frac{1}{1/|A|} = |A| $$\n这意味着随机变量 $U(\\theta)$（其中 $\\theta \\sim p(\\theta \\mid y)$）是一个值为 $|A|$ 的常数。其概率分布是在 $|A|$ 处的一个点质量。\n这个常数随机变量的期望和方差很容易确定：\n$$ \\mathbb{E}_{p(\\theta \\mid y)}[U(\\theta)] = \\mathbb{E}[|A|] = |A| $$\n$$ \\mathrm{Var}_{p(\\theta \\mid y)}(U(\\theta)) = \\mathrm{Var}(|A|) = 0 $$\n这就完成了第 1 部分所要求的分析。函数 $U(\\theta)$ 在后验分布下几乎必然有界（实际上是常数），这满足了 HM 估计量稳定性的充分条件。\n\n**第 2 部分：调和平均估计量的方差**\n\n调和平均估计量 $\\widehat{Z}_{\\mathrm{HM}}$ 定义为：\n$$ \\widehat{Z}_{\\mathrm{HM}} = \\left\\{\\frac{1}{M}\\sum_{m=1}^{M} U(\\theta^{(m)})\\right\\}^{-1} $$\n其中 $\\theta^{(1)}, \\dots, \\theta^{(M)}$ 是从后验 $p(\\theta \\mid y)$ 中抽取的独立样本。\n从第 1 部分可知，对于任何这样的样本 $\\theta^{(m)}$，$U(\\theta^{(m)})$ 的值确定性地等于 $|A|$。\n将此代入估计量的公式中：\n$$ \\widehat{Z}_{\\mathrm{HM}} = \\left\\{\\frac{1}{M}\\sum_{m=1}^{M} |A|\\right\\}^{-1} = \\left\\{\\frac{1}{M} (M \\cdot |A|)\\right\\}^{-1} = \\left\\{|A|\\right\\}^{-1} = \\frac{1}{|A|} $$\n估计量 $\\widehat{Z}_{\\mathrm{HM}}$ 是一个随机变量，因为它依赖于随机样本 $\\{\\theta^{(m)}\\}$。然而，在这个特定模型中，对于任何后验样本集和任何样本量 $M \\geq 1$，它的值都是常数，等于 $\\frac{1}{|A|}$。它总是精确地等于真实的边缘似然 $Z$。\n任何常数随机变量的方差都为零。因此，该模型中 HM 估计量的方差为：\n$$ \\mathrm{Var}\\!\\left(\\widehat{Z}_{\\mathrm{HM}}\\right) = \\mathrm{Var}\\!\\left(\\frac{1}{|A|}\\right) = 0 $$\n这就是问题所要求的最终答案。\n\n**第 3 部分：无界支撑集情况和不稳定性机制**\n\n为求完整并实现问题对比两种情况的目标，我们简要分析无界支撑集的例子。\n由高斯先验 $\\pi(\\theta) = \\varphi(\\theta; 0, \\tau_{0}^{2})$ 和高斯似然 $p(y \\mid \\theta) = \\varphi(y; \\theta, \\sigma^{2})$ 产生的后验 $p(\\theta \\mid y)$ 也是一个高斯分布 $\\varphi(\\theta; \\mu_p, \\sigma_p^2)$，其后验方差为 $\\sigma_p^2 = \\left(\\frac{1}{\\sigma^2} + \\frac{1}{\\tau_0^2}\\right)^{-1}$。\n问题要求我们找出使 $\\mathbb{E}_{p(\\theta \\mid y)}\\!\\left[\\exp\\!\\big(c\\,(\\theta - y)^{2}\\big)\\right]$ 有限的关于 $c > 0$ 的条件。该期望对应于形式为 $\\int \\exp(Q(\\theta))d\\theta$ 的积分，其中 $Q(\\theta)$ 是关于 $\\theta$ 的二次式。该积分收敛当且仅当 $\\theta^2$ 项的系数为负。指数部分为 $c(\\theta - y)^2 - \\frac{(\\theta - \\mu_p)^2}{2\\sigma_p^2}$。$\\theta^2$ 的系数是 $c - \\frac{1}{2\\sigma_p^2}$。因此，期望是有限的当且仅当 $c  \\frac{1}{2\\sigma_p^2}$。\n\n现在我们将此应用于 $U(\\theta) = \\frac{1}{p(y \\mid \\theta)} = \\sqrt{2\\pi\\sigma^2}\\exp\\left(\\frac{(\\theta-y)^2}{2\\sigma^2}\\right)$ 的矩。\n1.  期望 $\\mathbb{E}_{p(\\theta \\mid y)}[U(\\theta)]$ 要求在 $c = \\frac{1}{2\\sigma^2}$ 时是有限的。条件是 $\\frac{1}{2\\sigma^2}  \\frac{1}{2\\sigma_p^2}$，即 $\\sigma_p^2  \\sigma^2$。这个条件总是成立的，因为 $\\sigma_p^2 = \\frac{\\sigma^2\\tau_0^2}{\\sigma^2+\\tau_0^2}$ 并且 $\\frac{\\tau_0^2}{\\sigma^2+\\tau_0^2}  1$。所以 $U(\\theta)$ 的期望是有限的。\n2.  方差 $\\mathrm{Var}_{p(\\theta \\mid y)}(U(\\theta))$ 存在，如果 $\\mathbb{E}_{p(\\theta \\mid y)}[U(\\theta)^2]$ 是有限的。由于 $U(\\theta)^2 \\propto \\exp\\left(\\frac{(\\theta-y)^2}{\\sigma^2}\\right)$，这对应于 $c = \\frac{1}{\\sigma^2}$。条件变为 $\\frac{1}{\\sigma^2}  \\frac{1}{2\\sigma_p^2}$，即 $2\\sigma_p^2  \\sigma^2$。代入 $\\sigma_p^2$ 的表达式，我们得到 $2\\frac{\\sigma^2\\tau_0^2}{\\sigma^2+\\tau_0^2}  \\sigma^2$，化简后为 $\\tau_0^2  \\sigma^2$。\n\n这揭示了不稳定的机制。$U(\\theta)$ 的方差是无限的，除非先验相对于似然具有足够的信息量（即 $\\tau_0^2  \\sigma^2$）。如果先验是弥散的，后验的尾部将不够细，无法抑制当 $\\theta$ 值远离 $y$ 时 $U(\\theta)^2 = 1/p(y \\mid \\theta)^2$ 的爆炸性增长。这导致 $U(\\theta)$ 的方差为无穷大，进而导致 HM 估计量高度不稳定，因为其抽样分布未能适当地收敛。这与有界支撑集的情况形成鲜明对比，在那种情况下 $U(\\theta)$ 是有界的，从而导致估计量的方差为零。",
            "answer": "$$\n\\boxed{0}\n$$"
        },
        {
            "introduction": "即便在理论上谐波平均估计量可行（或者当我们决定冒险使用它时），其直接计算也会面临严重的数值挑战。本练习聚焦于在实际编程中如何避免灾难性的数值溢出问题，通过实践一种被称为“log-sum-exp”的技巧，你将学会如何基于对数似然值来稳健地计算谐波平均估计量，这是将理论应用于实践的关键一步。",
            "id": "3311572",
            "problem": "考虑一个贝叶斯模型，其数据为 $y$，先验密度为 $p(\\theta)$，似然为 $L(\\theta) = p(y \\mid \\theta)$，后验密度为 $p(\\theta \\mid y) \\propto L(\\theta)p(\\theta)$。边缘似然（模型证据）是 $Z = p(y)$。调和平均估计量 $\\hat Z_{\\mathrm{HM}}$ 使用从 $p(\\theta \\mid y)$ 中抽取的样本 $\\{\\theta_i\\}_{i=1}^n$，并根据调和平均的定义构成\n$$\n\\hat Z_{\\mathrm{HM}} \\;=\\; \\left( \\frac{1}{n} \\sum_{i=1}^n \\frac{1}{L(\\theta_i)} \\right)^{-1}.\n$$\n假设您只能访问对数似然 $\\ell_i = \\log L(\\theta_i)$，并且必须在双精度浮点运算中计算 $\\hat Z_{\\mathrm{HM}}$，同时要避免除了该估计量内在不稳定性所导致的不可避免情况之外的数值上溢或下溢。您的目标是基于对数似然提出一种数值稳定的计算方法，该方法利用一种通常被称为“log-sum-exp 技巧”的常数移位累加策略，并分析由此产生的上溢/下溢风险。\n\n选择一个选项，该选项能根据 $\\{\\ell_i\\}_{i=1}^n$ 正确指定一个稳定算法，并正确描述在双精度运算中（其中当 $x \\gtrsim 709$ 时 $\\exp(x)$ 会上溢，当 $x \\lesssim -745$ 时会下溢为零）的关键上溢/下溢风险。\n\nA. 令 $x_i = -\\ell_i$ 且 $m = \\max_{1 \\le i \\le n} x_i$。以浮点数计算 $s = \\sum_{i=1}^n \\exp(x_i - m)$。然后计算 $\\log \\hat Z_{\\mathrm{HM}} = \\log n - \\big(m + \\log s\\big)$，并且如果需要，仅在 $|\\log \\hat Z_{\\mathrm{HM}}| \\lesssim 709$ 时设置 $\\hat Z_{\\mathrm{HM}} = \\exp(\\log \\hat Z_{\\mathrm{HM}})$；否则报告 $\\log \\hat Z_{\\mathrm{HM}}$ 以避免上溢/下溢。这可以防止在累加 $\\sum_{i=1}^n \\exp(-\\ell_i)$ 时发生上溢，因为所有指数 $x_i - m \\le 0$，并且任何下溢的指数项都对应于可忽略的贡献。该估计量在统计上仍然不稳定，因为最大的 $x_i$（最小的似然）可能占主导地位，但计算本身在数值上是良态的。\n\nB. 令 $x_i = -\\ell_i$ 且 $m = \\min_{1 \\le i \\le n} x_i$。计算 $s = \\sum_{i=1}^n \\exp(x_i - m)$，然后设置 $\\hat Z_{\\mathrm{HM}} = \\frac{n}{\\exp(m)\\, s}$。因为移位使用了最小值，所以最大的项被降低了权重，从而避免了上溢；下溢不是问题，因为至少有一项是 $1$。\n\nC. 用 $\\hat Z_{\\mathrm{HM}} \\approx \\exp\\!\\left(\\log n - \\frac{1}{n}\\sum_{i=1}^n \\ell_i\\right)$ 来近似 $\\hat Z_{\\mathrm{HM}}$，这种方法在数值上是稳定的，因为它只使用了 $\\ell_i$ 的平均值。其理由是，对于大的 $n$，调和平均接近于几何平均。\n\nD. 计算 $t_i = \\exp(-\\ell_i)$ 并使用成对求和或 Kahan 补偿求和来评估 $\\sum_{i=1}^n t_i$ 以避免灾难性抵消，然后设置 $\\hat Z_{\\mathrm{HM}} = n/\\sum_{i=1}^n t_i$。由于补偿求和减少了舍入误差，因此在实践中可以避免上溢和下溢，结果是稳定的。\n\nE. 通过将每个 $\\ell_i$ 替换为 $\\tilde \\ell_i = \\max(\\ell_i, c)$（其中 $c$ 为某个固定常数）来裁剪对数似然，然后根据原始定义从 $\\{\\tilde \\ell_i\\}$ 计算 $\\hat Z_{\\mathrm{HM}}$。这可以防止最小的似然值占主导地位，从而在不引入显著偏差的情况下提高数值和统计稳定性。\n\n选择所有适用的选项。",
            "solution": "用户希望我验证并解决一个关于在贝叶斯背景下，为边缘似然的调和平均估计量进行数值稳定计算的问题。\n\n### 第 1 步：提取已知条件\n\n-   **模型背景**：贝叶斯模型，数据为 $y$，先验为 $p(\\theta)$，似然为 $L(\\theta) = p(y \\mid \\theta)$，后验为 $p(\\theta \\mid y) \\propto L(\\theta)p(\\theta)$。\n-   **待估量**：边缘似然（模型证据），$Z = p(y)$。\n-   **估计量定义**：调和平均估计量 $\\hat Z_{\\mathrm{HM}}$ 定义为：\n    $$ \\hat Z_{\\mathrm{HM}} \\;=\\; \\left( \\frac{1}{n} \\sum_{i=1}^n \\frac{1}{L(\\theta_i)} \\right)^{-1} $$\n    其中 $\\{\\theta_i\\}_{i=1}^n$ 是从后验分布 $p(\\theta \\mid y)$ 中抽取的样本。\n-   **输入数据**：一组对数似然，$\\{\\ell_i\\}_{i=1}^n$，其中 $\\ell_i = \\log L(\\theta_i)$。\n-   **计算环境**：双精度浮点运算。\n-   **数值约束**：当 $x \\gtrsim 709$ 时 $\\exp(x)$ 上溢，当 $x \\lesssim -745$ 时下溢为零。\n-   **目标**：提出一种基于 $\\{\\ell_i\\}$ 的数值稳定的计算方法，使用常数移位的“log-sum-exp 技巧”，并分析相关的上溢/下溢风险。\n\n### 第 2 步：使用提取的已知条件进行验证\n\n1.  **科学或事实上的不健全性**：无。问题陈述准确地描述了调和平均估计量，这是贝叶斯模型比较中一种已知（尽管常受批评）的方法。浮点运算中的上溢和下溢等数值问题是真实存在的，且描述准确。“log-sum-exp 技巧”是数值计算中一种标准且有效的方法。\n2.  **不可形式化或不相关**：无。该问题是计算统计学中一个明确定义的任务。\n3.  **不完整或矛盾的设置**：无。问题提供了推导和评估计算策略所需的所有定义、输入和约束。\n4.  **不切实际或不可行**：无。该场景是实现贝叶斯推断软件时会遇到的一个实际问题。浮点数限制代表了双精度数的 IEEE 754 标准。\n5.  **不适定或结构不良**：无。问题要求一种特定类型的解决方案（使用特定技巧的稳定算法）并对其进行分析，这是一个适定的任务。\n6.  **伪深刻、琐碎或同义反复**：无。该问题要求对统计估计量和数值稳定性原理都有扎实的理解，并能区分两者。解决方案并非微不足道。\n7.  **超出科学可验证性范围**：无。所提出的算法可以被实现，其数值属性可以被验证。\n\n### 第 3 步：结论和行动\n\n问题陈述是有效的。我将继续进行解法推导和选项分析。\n\n### 稳定计算的推导\n\n调和平均估计量由下式给出：\n$$ \\hat Z_{\\mathrm{HM}} = \\left( \\frac{1}{n} \\sum_{i=1}^n \\frac{1}{L(\\theta_i)} \\right)^{-1} = \\frac{n}{\\sum_{i=1}^n L(\\theta_i)^{-1}} $$\n我们已知对数似然 $\\ell_i = \\log L(\\theta_i)$。因此，$L(\\theta_i)^{-1} = (\\exp(\\ell_i))^{-1} = \\exp(-\\ell_i)$。\n该估计量可以用对数似然表示为：\n$$ \\hat Z_{\\mathrm{HM}} = \\frac{n}{\\sum_{i=1}^n \\exp(-\\ell_i)} $$\n主要的数值挑战在于计算总和 $S = \\sum_{i=1}^n \\exp(-\\ell_i)$。令 $x_i = -\\ell_i$。$\\ell_i$ 的值可以是大的正数或负数，对应于 $x_i$ 的小值或大值。如果任何 $x_i$ 是一个大的正数（例如 $x_i > 709$），$\\exp(x_i)$ 项将会上溢。这种情况发生在似然 $L(\\theta_i)$ 非常小的时候，而这正是调和平均估计量在统计上不稳定的已知情况。\n\n为了在计算中防止这种上溢，我们使用“log-sum-exp”稳定化技巧。令 $m = \\max_{1 \\le i \\le n} x_i$。我们可以将总和 $S$ 重写为：\n$$ S = \\sum_{i=1}^n \\exp(x_i) = \\sum_{i=1}^n \\exp(x_i - m + m) = \\exp(m) \\sum_{i=1}^n \\exp(x_i - m) $$\n让我们分析新的总和，$s = \\sum_{i=1}^n \\exp(x_i - m)$。\n-   每一项的指数是 $x_i - m$。因为 $m$ 是所有 $x_i$ 的最大值，所以对所有 $i$ 都有 $x_i - m \\le 0$。\n-   因此，$\\exp(x_i - m) \\le \\exp(0) = 1$。和中任何一项可能的最大值是 $1$（当 $x_i=m$ 时发生）。这有效地防止了在计算单个项时发生上溢。\n-   如果 $x_i - m$ 是一个大的负数（例如 $x_i - m \\lesssim -745$），$\\exp(x_i - m)$ 项将下溢为 $0$。这在数值上是安全且可取的。这样的项对应于一个远小于最大值 $m$ 的 $x_i$ 值。原始项 $\\exp(x_i)$ 与最大项 $\\exp(m)$ 相比本可以忽略不计，因此其对总和的贡献可以被忽略，而不会造成显著的数值精度损失。\n\n整个计算最好在对数域中进行，以管理最终结果可能出现的全部数值范围。\n估计量的对数为：\n$$ \\log \\hat Z_{\\mathrm{HM}} = \\log(n) - \\log(S) $$\n使用我们对 $S$ 的稳定化表达式：\n$$ \\log S = \\log\\left(\\exp(m) \\sum_{i=1}^n \\exp(x_i - m)\\right) = \\log(\\exp(m)) + \\log\\left(\\sum_{i=1}^n \\exp(x_i - m)\\right) = m + \\log(s) $$\n所以，计算该估计量对数的稳定算法是：\n$$ \\log \\hat Z_{\\mathrm{HM}} = \\log(n) - (m + \\log s) = \\log n - m - \\log \\left(\\sum_{i=1}^n \\exp(x_i - m)\\right) $$\n其中 $x_i = -\\ell_i$ 且 $m = \\max_i x_i$。这个 $\\log \\hat Z_{\\mathrm{HM}}$ 的公式在数值上是鲁棒的。最终值 $\\hat Z_{\\mathrm{HM}} = \\exp(\\log \\hat Z_{\\mathrm{HM}})$ 随后可以计算，但如果 $\\log \\hat Z_{\\mathrm{HM}}$ 超出范围 $[-745, 709]$，最好报告其对数值以避免最终的上溢或下溢。\n\n至关重要的是要区分这种计算稳定性与估计量的统计不稳定性。上述方法为给定的样本 $\\{\\theta_i\\}$ 精确地计算了 $\\hat Z_{\\mathrm{HM}}$ 的值。然而，该估计量本身具有无限方差，因为它被后验分布尾部中似然非常小（即 $x_i = -\\ell_i$ 非常大）的稀有样本所主导。选择 $m = \\max_i x_i$ 清楚地表明，计算取决于具有最小似然的单个样本，这是统计不稳定性的根本原因。log-sum-exp 技巧修正的是算术问题，而不是统计问题。\n\n### 逐项分析\n\n**A. 令 $x_i = -\\ell_i$ 且 $m = \\max_{1 \\le i \\le n} x_i$。以浮点数计算 $s = \\sum_{i=1}^n \\exp(x_i - m)$。然后计算 $\\log \\hat Z_{\\mathrm{HM}} = \\log n - \\big(m + \\log s\\big)$，并且如果需要，仅在 $|\\log \\hat Z_{\\mathrm{HM}}| \\lesssim 709$ 时设置 $\\hat Z_{\\mathrm{HM}} = \\exp(\\log \\hat Z_{\\mathrm{HM}})$；否则报告 $\\log \\hat Z_{\\mathrm{HM}}$ 以避免上溢/下溢。这可以防止在累加 $\\sum_{i=1}^n \\exp(-\\ell_i)$ 时发生上溢，因为所有指数 $x_i - m \\le 0$，并且任何下溢的指数项都对应于可忽略的贡献。该估计量在统计上仍然不稳定，因为最大的 $x_i$（最小的似然）可能占主导地位，但计算本身在数值上是良态的。**\n\n该选项与推导出的稳定算法完全匹配。\n1.  它正确地确定了变换 $x_i = -\\ell_i$。\n2.  它正确地使用最大值 $m$ 作为 log-sum-exp 技巧的移位常数。\n3.  它为估计量的对数提供了正确的公式：$\\log \\hat Z_{\\mathrm{HM}} = \\log n - (m + \\log s)$。\n4.  它正确地描述了处理最终指数运算的标准程序。\n5.  它给出了一个精确且正确的解释，说明为什么这个程序可以避免上溢并安全地处理下溢。\n6.  至关重要的是，它正确地区分了计算所实现的数值稳定性与估计量本身仍然存在的统计不稳定性。\n**结论：正确。**\n\n**B. 令 $x_i = -\\ell_i$ 且 $m = \\min_{1 \\le i \\le n} x_i$。计算 $s = \\sum_{i=1}^n \\exp(x_i - m)$，然后设置 $\\hat Z_{\\mathrm{HM}} = \\frac{n}{\\exp(m)\\, s}$。因为移位使用了最小值，所以最大的项被降低了权重，从而避免了上溢；下溢不是问题，因为至少有一项是 $1$。**\n\n该选项建议使用指数的最小值，$m = \\min_i x_i$。在和 $\\sum_i \\exp(x_i - m)$ 中，指数 $x_i - m$ 现在都是非负的。对应于 $\\max_i x_i$ 的项的指数将是 $\\max_i x_i - \\min_i x_i$，这可能是一个非常大的正数，直接导致上溢。理由“最大的项被降低了权重”是错误的；减去最小值会*放大*最大项与最小值之间的差异，从而加剧上溢。\n**结论：不正确。**\n\n**C. 用 $\\hat Z_{\\mathrm{HM}} \\approx \\exp\\!\\left(\\log n - \\frac{1}{n}\\sum_{i=1}^n \\ell_i\\right)$ 来近似 $\\hat Z_{\\mathrm{HM}}$，这种方法在数值上是稳定的，因为它只使用了 $\\ell_i$ 的平均值。其理由是，对于大的 $n$，调和平均接近于几何平均。**\n\n所提出的近似是 $\\hat Z_{\\mathrm{HM}} \\approx n \\cdot \\exp(-\\bar{\\ell})$，其中 $\\bar{\\ell}$ 是对数似然的算术平均值。真正的估计量是似然的调和平均，$\\hat Z_{\\mathrm{HM}} = \\text{HM}(L_i)$。量 $\\exp(\\bar{\\ell})$ 是似然的几何平均，$\\text{GM}(L_i)$。因此，这个近似是 $\\text{HM}(L_i) \\approx n / \\text{GM}(L_i)$。没有普遍的数学原理支持这种近似。此外，其理由“对于大的 n，调和平均接近几何平均”通常是错误的。HM-GM-AM 不等式指出，只有当所有值都相同时它们才相等；如果值的方差很大（这是 HME 中使用的似然的特征），它们可能相差很远。此选项提出了一个不同的、数学上不合理的估计量，而不是对原始估计量的稳定计算。\n**结论：不正确。**\n\n**D. 计算 $t_i = \\exp(-\\ell_i)$ 并使用成对求和或 Kahan 补偿求和来评估 $\\sum_{i=1}^n t_i$ 以避免灾难性抵消，然后设置 $\\hat Z_{\\mathrm{HM}} = n/\\sum_{i=1}^n t_i$。由于补偿求和减少了舍入误差，因此在实践中可以避免上溢和下溢，结果是稳定的。**\n\n此选项未能解决主要的数值问题。第一步 `计算 $t_i = \\exp(-\\ell_i)$` 正是如果任何 $-\\ell_i$ 很大时会发生上溢的地方。Kahan 求和和其他类似技术旨在减轻因加法许多浮点数而造成的精度损失；它们对于防止各项本身计算中的上溢或下溢毫无作用。该和由正数组成，因此灾难性抵消（减去几乎相等的数）在这里不是问题。声称补偿求和可以避免上溢的说法是错误的。\n**结论：不正确。**\n\n**E. 通过将每个 $\\ell_i$ 替换为 $\\tilde \\ell_i = \\max(\\ell_i, c)$（其中 $c$ 为某个固定常数）来裁剪对数似然，然后根据原始定义从 $\\{\\tilde \\ell_i\\}$ 计算 $\\hat Z_{\\mathrm{HM}}$。这可以防止最小的似然值占主导地位，从而在不引入显著偏差的情况下提高数值和统计稳定性。**\n\n此选项建议修改数据来解决问题。通过用一个裁剪值 $\\tilde \\ell_i = \\max(\\ell_i, c)$ 替换 $\\ell_i$，任何小于 $c$ 的对数似然都被提升到 $c$。这为似然 $L(\\theta_i) \\ge \\exp(c)$ 设置了一个下界，从而为其倒数 $1/L(\\theta_i) \\le \\exp(-c)$ 设置了一个上界。这确实可以防止 $\\exp(-\\ell_i)$ 项变得任意大并导致上溢。然而，这不是对*原始*估计量的稳定计算；而是对一个*不同的、被修改过的*估计量的精确计算。声称这样做“不会引入显著偏差”是毫无根据的，而且通常是错误的。此过程引入了难以量化的系统偏差。目标是计算 $\\hat Z_{\\mathrm{HM}}$，而不是它的一个有偏版本。\n**结论：不正确。**",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "在理解了理论缺陷和数值计算的挑战之后，最关键的是观察这些问题如何在真实的数据分析场景中表现出来。这个编程练习将模拟一个完整的模型选择任务，让你能够通过代码亲眼见证不稳定的谐波平均估计量如何导致错误的模型选择结论，并将其与更可靠的替代方法及“标准答案”进行对比。",
            "id": "3311539",
            "problem": "您的任务是，在一个具有弱可识别性的嵌套模型设置中，对用于贝叶斯模型证据的调和均值估计量和广义贝叶斯信息准则 (WBIC) 进行一次基于原则的、基于模拟的比较。重点是展示调和均值估计量的不稳定性如何扭曲模型选择。上下文是随机模拟和蒙特卡洛方法，使用正态似然与共轭正态先验。模拟必须完全自包含且可复现。\n\n使用的基本基础是贝叶斯定理和边缘似然（模型证据）的定义：对于数据 $y = (y_1,\\dots,y_n)$、似然 $p(y \\mid \\theta)$ 和先验 $p(\\theta)$，边缘似然为 $Z = \\int p(y \\mid \\theta)\\, p(\\theta)\\, d\\theta$。后验分布为 $p(\\theta \\mid y) \\propto p(y \\mid \\theta)\\, p(\\theta)$。调和均值估计量依赖于后验样本，并通过在 $p(\\theta \\mid y)$ 下对 $p(y \\mid \\theta)$ 的函数进行平均来形成 $Z$ 的估计。广义贝叶斯信息准则 (WBIC) 通过在逆温度 $t = 1/\\log n$ 的调和后验分布 $p_t(\\theta \\mid y) \\propto p(y \\mid \\theta)^t p(\\theta)$ 下对负对数似然的期望来近似负对数边缘似然。\n\n为标量参数 $\\mu$、已知方差 $\\sigma^2$ 以及数据 $y_i \\sim \\mathcal{N}(\\mu_{\\text{true}}, \\sigma^2)$（对于 $i = 1,\\dots,n$ 独立）建立以下嵌套模型：\n\n- 模型 $\\mathcal{M}_0$：均值固定为 $\\mu = 0$（无自由参数）。\n- 模型 $\\mathcal{M}_1$：均值未知，其先验为 $\\mu \\sim \\mathcal{N}(0, \\tau^2)$。\n\n在 $\\mathcal{M}_1$ 下，后验分布是共轭正态的。在 WBIC 下，逆温度为 $t$ 的调和后验分布也是正态的。在 $\\mathcal{M}_1$ 下，$Z$ 的调和均值估计量使用来自 $\\mu$ 后验分布的样本。因为调和均值估计量在常见设置中可能具有无限方差，所以它以不稳定且可能对模型选择产生误导而著称。您的程序必须在精心选择的测试用例中展示这种效应。\n\n为每个测试用例实现以下步骤：\n\n1. 使用固定的伪随机数种子 $314159$ 从 $\\mathcal{N}(\\mu_{\\text{true}}, \\sigma^2)$ 生成数据 $y_1, \\dots, y_n$，以确保可复现性。\n2. 使用当 $\\mu = 0$ 时 $Z$ 的定义，计算 $\\mathcal{M}_0$ 的精确对数边缘似然 $\\log Z_0$。\n3. 通过解析地对 $\\mu$ 进行积分，使用正态-正态共轭性计算 $\\mathcal{M}_1$ 的精确对数边缘似然 $\\log Z_1$。不要假设任何快捷公式；在您的解决方案中从第一性原理推导，并在程序中实现推导出的表达式。\n4. 使用从 $\\mathcal{M}_1$ 下的精确后验分布 $p(\\mu \\mid y)$ 中抽取的 $M$ 个独立 $\\mu$ 样本，通过调和均值估计量估计 $\\log Z_1$，其中 $M = 30000$。对 $1/p(y \\mid \\mu)$ 的调和均值使用数值稳定的实现，以避免在评估极端 $\\mu$ 的似然时出现上溢或下溢。\n5. 使用从逆温度 $t = 1/\\log n$ 的调和后验分布 $p_t(\\mu \\mid y)$ 中抽取的 $M$ 个样本，通过WBIC近似 $-\\log Z_1$；在 $p_t(\\mu \\mid y)$ 下计算 $-\\log p(y \\mid \\mu)$ 的蒙特卡洛期望。对于 $\\mathcal{M}_0$，请注意没有参数，因此 $-\\log Z_0$ 精确等于 $-\\log p(y \\mid \\mu=0)$。\n6. 通过三个准则决定所选模型：\n   - 调和均值选择：如果 $\\log Z_0 > \\widehat{\\log Z_1}^{\\text{HM}}$，选择 $\\mathcal{M}_0$，否则选择 $\\mathcal{M}_1$。\n   - WBIC选择：如果 $-\\log Z_0  \\widehat{-\\log Z_1}^{\\text{WBIC}}$，选择 $\\mathcal{M}_0$，否则选择 $\\mathcal{M}_1$。\n   - 基准真相选择：如果 $\\log Z_0 > \\log Z_1$，选择 $\\mathcal{M}_0$，否则选择 $\\mathcal{M}_1$。\n7. 此外，为每个测试用例计算正态-正态共轭下调和均值估计量的不稳定性指标：当且仅当 $\\tau^2 > \\sigma^2 / n$ 时，调和均值估计量的方差为无穷大。如果 $\\tau^2 > \\sigma^2 / n$，则输出此指标为 $1$，否则为 $0$。\n\n测试套件：\n\n- 情况A（不稳定，弱可识别性）：$n = 20$，$\\sigma^2 = 1$，$\\tau^2 = 100$，$\\mu_{\\text{true}} = 0$。\n- 情况B（更不稳定，更弱的可识别性）：$n = 5$，$\\sigma^2 = 1$，$\\tau^2 = 1$，$\\mu_{\\text{true}} = 0$。\n- 情况C（稳定状态，更强可识别性）：$n = 100$，$\\sigma^2 = 1$，$\\tau^2 = 0.005$，$\\mu_{\\text{true}} = 0.3$。\n\n您的程序应为每种情况生成列表 $[\\text{HM\\_sel}, \\text{WBIC\\_sel}, \\text{Truth\\_sel}, \\text{HM\\_unstable}]$，其中每个元素是 $\\{0,1\\}$ 中的整数，模型选择编码为：$\\mathcal{M}_0$ 为 $0$，$\\mathcal{M}_1$ 为 $1$。最终输出应将所有三个测试用例的结果汇总为单行，形式为方括号括起来的逗号分隔列表，例如 $[[0,1,0,1],[0,0,0,1],[1,1,1,0]]$。\n\n最终输出格式：\n\n- 您的程序必须精确打印一行，其中包含一个包含三个列表的Python列表，分别对应情况A、情况B和情况C。每个内部列表必须是 $[\\text{HM\\_sel}, \\text{WBIC\\_sel}, \\text{Truth\\_sel}, \\text{HM\\_unstable}]$ 的形式。",
            "solution": "用户要求进行一次基于模拟的比较，旨在比较调和均值估计量（HME）和广义贝叶斯信息准则（WBIC）在计算贝叶斯模型证据方面的表现。其目的是在以弱可识别性为特征的嵌套模型设置中，展示HME的不稳定性。该问题定义明确，具有科学依据，并为可复现的模拟提供了所有必要的信息。\n\n模拟设置涉及两个嵌套模型，用于从正态分布 $y_i \\sim \\mathcal{N}(\\mu_{\\text{true}}, \\sigma^2)$ 中抽取的数据 $y = (y_1, \\dots, y_n)$。这两个模型是：\n- 模型 $\\mathcal{M}_0$：均值固定为 $\\mu=0$。\n- 模型 $\\mathcal{M}_1$：均值为一个随机变量，具有共轭正态先验 $\\mu \\sim \\mathcal{N}(0, \\tau^2)$。\n\n我们将为两个模型推导精确的边缘似然，为模型选择建立基准真相。然后，我们将构建HME和WBIC估计量，并使用它们进行模型选择，将其结果与基准真相进行比较。\n\n**1. 解析边缘似然（基准真相）**\n\n给定参数 $\\mu$ 和已知方差 $\\sigma^2$ 时，数据 $y$ 的似然为：\n$$ p(y \\mid \\mu, \\sigma^2) = \\prod_{i=1}^n \\frac{1}{\\sqrt{2\\pi\\sigma^2}} \\exp\\left(-\\frac{(y_i - \\mu)^2}{2\\sigma^2}\\right) = (2\\pi\\sigma^2)^{-n/2} \\exp\\left(-\\frac{1}{2\\sigma^2}\\sum_{i=1}^n (y_i - \\mu)^2\\right) $$\n平方和可以根据样本均值 $\\bar{y} = \\frac{1}{n}\\sum_{i=1}^n y_i$ 改写为：\n$$ \\sum_{i=1}^n (y_i - \\mu)^2 = \\sum_{i=1}^n (y_i - \\bar{y})^2 + n(\\bar{y} - \\mu)^2 $$\n因此，似然为：\n$$ p(y \\mid \\mu, \\sigma^2) = (2\\pi\\sigma^2)^{-n/2} \\exp\\left(-\\frac{\\sum_{i=1}^n (y_i - \\bar{y})^2}{2\\sigma^2}\\right) \\exp\\left(-\\frac{n(\\bar{y} - \\mu)^2}{2\\sigma^2}\\right) $$\n\n**模型 $\\mathcal{M}_0$：**\n对于 $\\mathcal{M}_0$，参数 $\\mu$ 固定为 $0$。边缘似然 $Z_0$ 就是在 $\\mu=0$ 处评估的似然：\n$$ Z_0 = p(y \\mid \\mu=0, \\sigma^2) = (2\\pi\\sigma^2)^{-n/2} \\exp\\left(-\\frac{1}{2\\sigma^2}\\sum_{i=1}^n y_i^2\\right) $$\n对数边缘似然为：\n$$ \\log Z_0 = -\\frac{n}{2}\\log(2\\pi\\sigma^2) - \\frac{1}{2\\sigma^2}\\sum_{i=1}^n y_i^2 $$\n\n**模型 $\\mathcal{M}_1$：**\n对于 $\\mathcal{M}_1$，我们对 $\\mu$ 有一个先验，$p(\\mu) = \\mathcal{N}(\\mu \\mid 0, \\tau^2)$。边缘似然 $Z_1$ 是通过对似然与先验的乘积在所有可能的 $\\mu$ 值上积分得到的：\n$$ Z_1 = \\int_{-\\infty}^{\\infty} p(y \\mid \\mu, \\sigma^2) p(\\mu) \\,d\\mu $$\n来自似然和先验的指数项中涉及 $\\mu$ 的部分是：\n$$ -\\frac{n(\\mu - \\bar{y})^2}{2\\sigma^2} - \\frac{\\mu^2}{2\\tau^2} = -\\frac{1}{2}\\left[ \\left(\\frac{n}{\\sigma^2} + \\frac{1}{\\tau^2}\\right)\\mu^2 - \\frac{2n\\bar{y}}{\\sigma^2}\\mu + \\frac{n\\bar{y}^2}{\\sigma^2} \\right] $$\n我们对 $\\mu$ 进行配方。这个表达式是一个二次型，对应于正态分布的指数部分。$\\mu$ 的后验分布为 $p(\\mu \\mid y) = \\mathcal{N}(\\mu \\mid \\mu_p, \\sigma_p^2)$，其后验方差为 $\\sigma_p^2 = \\left(\\frac{n}{\\sigma^2} + \\frac{1}{\\tau^2}\\right)^{-1}$，后验均值为 $\\mu_p = \\sigma_p^2 \\left(\\frac{n\\bar{y}}{\\sigma^2}\\right)$。配方后，指数变为：\n$$ -\\frac{(\\mu - \\mu_p)^2}{2\\sigma_p^2} - \\frac{n\\bar{y}^2}{2(\\sigma^2+n\\tau^2)} $$\n$Z_1$ 的积分为：\n$$ Z_1 = C \\cdot \\int_{-\\infty}^{\\infty} \\exp\\left(-\\frac{(\\mu - \\mu_p)^2}{2\\sigma_p^2}\\right) \\,d\\mu $$\n其中 $C$ 收集了所有不依赖于 $\\mu$ 的项。该积分的计算结果为 $\\sqrt{2\\pi\\sigma_p^2}$。合并所有常数，我们得到边缘似然 $Z_1$ 的解析表达式：\n$$ Z_1 = (2\\pi)^{-n/2} (\\sigma^2)^{-(n-1)/2} (n\\tau^2+\\sigma^2)^{-1/2} \\exp\\left(-\\frac{\\sum(y_i-\\bar{y})^2}{2\\sigma^2} - \\frac{n\\bar{y}^2}{2(n\\tau^2+\\sigma^2)}\\right) $$\n对数边缘似然为：\n$$ \\log Z_1 = -\\frac{n}{2}\\log(2\\pi) -\\frac{n-1}{2}\\log(\\sigma^2) - \\frac{1}{2}\\log(n\\tau^2+\\sigma^2) - \\frac{\\sum(y_i-\\bar{y})^2}{2\\sigma^2} - \\frac{n\\bar{y}^2}{2(n\\tau^2+\\sigma^2)} $$\n$\\log Z_0$ 和 $\\log Z_1$ 的这些解析形式构成了我们模型比较的基准真相。\n\n**2. 调和均值估计量 (HME)**\n\nHME基于恒等式 $Z^{-1} = E_{p(\\theta \\mid y)}[p(y \\mid \\theta)^{-1}]$。对于模型 $\\mathcal{M}_1$，给定来自后验 $p(\\mu \\mid y)$ 的 $M$ 个样本 $\\mu^{(j)}$， $Z_1$ 的HME为：\n$$ \\widehat{Z_1}^{\\text{HM}} = \\left( \\frac{1}{M}\\sum_{j=1}^M \\frac{1}{p(y \\mid \\mu^{(j)})} \\right)^{-1} $$\n样本从我们之前推导出的后验分布中抽取：$\\mu \\sim \\mathcal{N}(\\mu_p, \\sigma_p^2)$。在数值上，使用log-sum-exp技巧在对数域中计算此值更为稳定，以防止上溢/下溢：\n$$ \\widehat{\\log Z_1}^{\\text{HM}} = -\\log\\left(\\frac{1}{M}\\sum_{j=1}^M \\exp(-\\log p(y \\mid \\mu^{(j)}))\\right) $$\nHME的方差可能是无限的。对于正态-正态模型，这种情况发生当且仅当 $\\tau^2 > \\sigma^2/n$。这个条件表示不稳定性，这是需要展示的一个关键方面。\n\n**3. 广义贝叶斯信息准则 (WBIC)**\n\nWBIC提供了对数边缘似然的一个近似。它定义为：\n$$ \\widehat{-\\log Z_1}^{\\text{WBIC}} = E_{p_t(\\mu \\mid y)}[-\\log p(y \\mid \\mu)] $$\n期望是在一个“调和”后验分布 $p_t(\\mu \\mid y) \\propto p(y \\mid \\mu)^t p(\\mu)$ 上计算的，其中逆温度 $t$ 设置为 $1/\\log n$。对于我们的模型 $\\mathcal{M}_1$，调和后验分布也是一个正态分布，$p_t(\\mu \\mid y) = \\mathcal{N}(\\mu \\mid \\mu_{p,t}, \\sigma_{p,t}^2)$，其参数为：\n$$ \\sigma_{p,t}^2 = \\left(\\frac{tn}{\\sigma^2} + \\frac{1}{\\tau^2}\\right)^{-1} \\quad \\text{和} \\quad \\mu_{p,t} = \\sigma_{p,t}^2 \\left(\\frac{tn\\bar{y}}{\\sigma^2}\\right) $$\n我们通过从这个调和后验中抽取 $M$ 个样本 $\\mu^{(j)}$ 并平均 $-\\log p(y \\mid \\mu^{(j)})$ 的值，使用蒙特卡洛积分来估计这个期望。对于模型 $\\mathcal{M}_0$，没有参数，因此 $-\\log Z_0$ 是精确计算的。\n\n**4. 模型选择**\n\n模型选择决策是通过比较 $\\mathcal{M}_0$ 和 $\\mathcal{M}_1$ 的证据做出的。如果一个模型有更高的边缘似然，它就是更优选的。\n- **基准真相选择**：如果 $\\log Z_1 > \\log Z_0$，选择 $\\mathcal{M}_1$；否则，选择 $\\mathcal{M}_0$。\n- **HME选择**：如果 $\\widehat{\\log Z_1}^{\\text{HM}} > \\log Z_0$，选择 $\\mathcal{M}_1$；否则，选择 $\\mathcal{M}_0$。\n- **WBIC选择**：如果 $\\widehat{-\\log Z_1}^{\\text{WBIC}}  -\\log Z_0$，选择 $\\mathcal{M}_1$；否则，选择 $\\mathcal{M}_0$。\n\n模拟将为三个指定的测试用例实现这些计算，以比较HME和WBIC相对于基准真相的表现，并特别强调在不稳定条件下HME的失效模式。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Performs a simulation to compare the Harmonic Mean Estimator (HME) and\n    the Widely Applicable Bayesian Information Criterion (WBIC) for Bayesian\n    model selection.\n    \"\"\"\n\n    # Define the test cases as per the problem statement.\n    test_cases = [\n        # (n, sigma^2, tau^2, mu_true)\n        (20, 1.0, 100.0, 0.0),  # Case A: Unstable HME, weak identifiability\n        (5, 1.0, 1.0, 0.0),      # Case B: Unstable HME, weaker identifiability\n        (100, 1.0, 0.005, 0.3),  # Case C: Stable HME, strong identifiability\n    ]\n\n    M = 30000  # Number of Monte Carlo samples\n    seed = 314159\n    rng = np.random.default_rng(seed)\n\n    results = []\n    \n    for n, sigma2, tau2, mu_true in test_cases:\n        # Step 1: Generate data\n        sigma = np.sqrt(sigma2)\n        y = rng.normal(loc=mu_true, scale=sigma, size=n)\n        \n        # Pre-compute summary statistics\n        y_bar = np.mean(y)\n        sum_y_sq = np.sum(y**2)\n        sum_sq_dev = np.sum((y - y_bar)**2)\n        \n        # Step 2: Compute exact log marginal likelihood for M0\n        log_Z0 = -0.5 * n * np.log(2 * np.pi * sigma2) - sum_y_sq / (2 * sigma2)\n        neg_log_Z0 = -log_Z0\n\n        # Step 3: Compute exact log marginal likelihood for M1\n        log_Z1 = (-0.5 * n * np.log(2 * np.pi) \n                  - 0.5 * (n - 1) * np.log(sigma2) \n                  - 0.5 * np.log(n * tau2 + sigma2) \n                  - sum_sq_dev / (2 * sigma2) \n                  - n * y_bar**2 / (2 * (n * tau2 + sigma2)))\n\n        # Step 4: Estimate log Z1 via Harmonic Mean Estimator (HME)\n        post_var = 1.0 / (n / sigma2 + 1.0 / tau2)\n        post_mean = post_var * (n * y_bar / sigma2)\n        mu_samples_post = rng.normal(loc=post_mean, scale=np.sqrt(post_var), size=M)\n        \n        # Calculate -log p(y | mu) for HME samples, needed for stable calculation\n        # -log p(y|mu) = 0.5*n*log(2*pi*sigma2) + sum(y_i - mu)^2/(2*sigma2)\n        # sum(y_i - mu)^2 = sum_sq_dev + n*(y_bar-mu)^2\n        neg_log_likelihoods_for_hme = (0.5 * n * np.log(2 * np.pi * sigma2)\n                                       + (sum_sq_dev + n * (y_bar - mu_samples_post)**2) / (2 * sigma2))\n        \n        # Numerically stable calculation of log HME\n        c_hme = np.max(neg_log_likelihoods_for_hme)\n        log_mean_inv_likelihood = c_hme + np.log(np.sum(np.exp(neg_log_likelihoods_for_hme - c_hme))) - np.log(M)\n        log_Z1_hme = -log_mean_inv_likelihood\n\n        # Step 5: Approximate -log Z1 via WBIC\n        t = 1.0 / np.log(n)\n        temp_post_var = 1.0 / (t * n / sigma2 + 1.0 / tau2)\n        temp_post_mean = temp_post_var * (t * n * y_bar / sigma2)\n        mu_samples_temp = rng.normal(loc=temp_post_mean, scale=np.sqrt(temp_post_var), size=M)\n\n        # Calculate -log p(y | mu) for WBIC samples\n        neg_log_likelihoods_for_wbic = (0.5 * n * np.log(2 * np.pi * sigma2)\n                                        + (sum_sq_dev + n * (y_bar - mu_samples_temp)**2) / (2 * sigma2))\n\n        neg_log_Z1_wbic = np.mean(neg_log_likelihoods_for_wbic)\n\n        # Step 6: Decide model selections\n        hm_sel = 1 if log_Z1_hme > log_Z0 else 0\n        wbic_sel = 1 if neg_log_Z1_wbic  neg_log_Z0 else 0\n        truth_sel = 1 if log_Z1 > log_Z0 else 0\n\n        # Step 7: Compute HME instability indicator\n        hm_unstable = 1 if tau2 > sigma2 / n else 0\n\n        results.append([hm_sel, wbic_sel, truth_sel, hm_unstable])\n    \n    # Format the final output string exactly as required\n    inner_strs = [f\"[{','.join(map(str, sublist))}]\" for sublist in results]\n    final_output = f\"[{','.join(inner_strs)}]\"\n    print(final_output)\n\nsolve()\n```"
        }
    ]
}