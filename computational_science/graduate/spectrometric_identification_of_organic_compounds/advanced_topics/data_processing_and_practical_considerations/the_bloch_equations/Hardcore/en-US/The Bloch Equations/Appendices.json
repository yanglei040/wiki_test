{
    "hands_on_practices": [
        {
            "introduction": "The ability to manipulate nuclear spins with radiofrequency (RF) pulses is the foundation of NMR. While on-resonance pulses are simplest to visualize, most real-world applications involve \"off-resonance\" effects where the RF frequency does not perfectly match the Larmor frequency. This exercise explores how to calculate the effective magnetic field in the rotating frame, which determines the axis and angle of spin rotation during such a pulse, a critical skill for understanding selective excitation and pulse sequence design. ",
            "id": "3726671",
            "problem": "In Nuclear Magnetic Resonance (NMR) spectrometry applied to the identification of organic compounds, the dynamics of the bulk magnetization during a Radiofrequency (RF) pulse are governed by the Bloch equations. Starting from the fundamental precession law for a magnetic moment in a magnetic field, $\\frac{d\\mathbf{M}}{dt} = \\gamma\\,\\mathbf{M} \\times \\mathbf{B}(t)$, where $\\gamma$ is the gyromagnetic ratio and $\\mathbf{B}(t)$ is the total magnetic field, consider a proton spin system subject to a strong static field $\\mathbf{B}_0 = B_0\\,\\hat{\\mathbf{z}}$ and a circularly polarized RF field of amplitude $B_1$ with carrier angular frequency $\\omega_{\\mathrm{rf}}$ and phase aligned such that its effective transverse component is along $\\hat{\\mathbf{x}}$ in the rotating frame. Work in the frame rotating at $\\omega_{\\mathrm{rf}}$ and invoke the Rotating-Wave Approximation (RWA), neglecting relaxation during the pulse.\n\nDefine the angular frequency offset as $\\Delta\\omega \\equiv \\omega_0 - \\omega_{\\mathrm{rf}}$, where $\\omega_0$ is the Larmor angular frequency. Explain, from first principles, the distinction between on-resonance rotations ($\\Delta\\omega = 0$) and off-resonance rotations ($\\Delta\\omega \\neq 0$) in terms of the effective field seen by the magnetization in the rotating frame, and derive the expressions for the effective rotation axis (as a unit vector) and the rotation angle for a rectangular RF pulse of duration $\\tau$.\n\nThen, for a selective excitation scenario relevant to spectrometric identification of an organic compound, compute the effective rotation axis and the rotation angle for a proton with gyromagnetic ratio $\\gamma = 2.675 \\times 10^{8}\\ \\text{rad s}^{-1}\\ \\text{T}^{-1}$ under an RF pulse with amplitude $B_1 = 12\\ \\mu\\text{T}$, frequency offset $\\Delta\\omega = 2\\pi \\times 400\\ \\text{s}^{-1}$, and duration $\\tau = 150\\ \\mu\\text{s}$. Express the rotation angle in radians. Round each component of the unit vector and the angle to four significant figures.",
            "solution": "The precessional dynamics of the macroscopic magnetization vector $\\mathbf{M}(t)$ under a time-dependent magnetic field $\\mathbf{B}(t)$ are governed by the equation $\\frac{d\\mathbf{M}}{dt} = \\gamma\\,\\mathbf{M} \\times \\mathbf{B}(t)$, which follows from the torque on a magnetic dipole in a magnetic field. In Nuclear Magnetic Resonance (NMR), one considers a strong static field $\\mathbf{B}_0 = B_0\\,\\hat{\\mathbf{z}}$ that sets the Larmor angular frequency $\\omega_0 = \\gamma B_0$, and a transverse Radiofrequency (RF) field oscillating near $\\omega_0$.\n\nTo analyze pulse-induced rotations, it is convenient to enter a frame that rotates about $\\hat{\\mathbf{z}}$ at the RF angular frequency $\\omega_{\\mathrm{rf}}$. In that rotating frame, under the Rotating-Wave Approximation (RWA), the rapidly oscillating counter-rotating component of the RF field is neglected, and the co-rotating component appears as a static transverse field. If the RF field is taken to be circularly polarized such that its effective transverse component lies along $\\hat{\\mathbf{x}}$, then in the rotating frame the magnetization obeys\n$$\n\\frac{d\\mathbf{M}_{\\mathrm{rot}}}{dt} = \\gamma\\,\\mathbf{M}_{\\mathrm{rot}} \\times \\mathbf{B}_{\\mathrm{eff}},\n$$\nwhere the effective field is\n$$\n\\mathbf{B}_{\\mathrm{eff}} = B_1\\,\\hat{\\mathbf{x}} + \\frac{\\Delta\\omega}{\\gamma}\\,\\hat{\\mathbf{z}},\n$$\nwith $\\Delta\\omega \\equiv \\omega_0 - \\omega_{\\mathrm{rf}}$ the angular frequency offset. The $\\hat{\\mathbf{z}}$ component arises in the rotating frame because the static field appears reduced by the rotation frequency, leaving an effective detuning $\\Delta\\omega/\\gamma$.\n\nOn-resonance rotations correspond to $\\Delta\\omega = 0$, in which case $\\mathbf{B}_{\\mathrm{eff}} = B_1\\,\\hat{\\mathbf{x}}$ and the magnetization simply nutates about the $\\hat{\\mathbf{x}}$-axis at the angular nutation rate $\\omega_1 = \\gamma B_1$. Off-resonance rotations correspond to $\\Delta\\omega \\neq 0$, for which the effective field is tilted away from the transverse plane, and the magnetization precesses about the tilted axis. The rotation axis is the direction of $\\mathbf{B}_{\\mathrm{eff}}$, and the angular nutation rate is the magnitude of the effective angular frequency vector $\\boldsymbol{\\omega}_{\\mathrm{eff}} = \\gamma \\mathbf{B}_{\\mathrm{eff}} = (\\gamma B_1)\\,\\hat{\\mathbf{x}} + \\Delta\\omega\\,\\hat{\\mathbf{z}}$. Therefore, the unit vector along the rotation axis is\n$$\n\\hat{\\mathbf{n}} = \\frac{\\boldsymbol{\\omega}_{\\mathrm{eff}}}{\\|\\boldsymbol{\\omega}_{\\mathrm{eff}}\\|} = \\frac{(\\gamma B_1)\\,\\hat{\\mathbf{x}} + \\Delta\\omega\\,\\hat{\\mathbf{z}}}{\\sqrt{(\\gamma B_1)^{2} + (\\Delta\\omega)^{2}}},\n$$\nand the rotation angle effected by a rectangular pulse of duration $\\tau$ is\n$$\n\\theta = \\|\\boldsymbol{\\omega}_{\\mathrm{eff}}\\|\\,\\tau = \\sqrt{(\\gamma B_1)^{2} + (\\Delta\\omega)^{2}}\\;\\tau.\n$$\n\nWe now evaluate these expressions for the given parameters. Keep symbols until the final step, then substitute the numerical values. With $\\gamma = 2.675 \\times 10^{8}\\ \\text{rad s}^{-1}\\ \\text{T}^{-1}$, $B_1 = 12 \\times 10^{-6}\\ \\text{T}$, $\\Delta\\omega = 2\\pi \\times 400\\ \\text{s}^{-1}$, and $\\tau = 150 \\times 10^{-6}\\ \\text{s}$, we first compute\n$$\n\\gamma B_1 = \\left(2.675 \\times 10^{8}\\right)\\left(12 \\times 10^{-6}\\right) = 3210\\ \\text{rad s}^{-1},\n$$\nand\n$$\n\\Delta\\omega = 2\\pi \\times 400 \\approx 2513.27\\ \\text{rad s}^{-1}.\n$$\nThe effective angular frequency magnitude is\n$$\n\\|\\boldsymbol{\\omega}_{\\mathrm{eff}}\\| = \\sqrt{(\\gamma B_1)^{2} + (\\Delta\\omega)^{2}} = \\sqrt{(3210)^{2} + (2513.27)^{2}} \\approx 4076.84\\ \\text{rad s}^{-1}.\n$$\nThus the unit rotation axis components are\n$$\nn_x = \\frac{\\gamma B_1}{\\|\\boldsymbol{\\omega}_{\\mathrm{eff}}\\|} \\approx \\frac{3210}{4076.84} \\approx 0.7874,\n\\quad\nn_y = 0,\n\\quad\nn_z = \\frac{\\Delta\\omega}{\\|\\boldsymbol{\\omega}_{\\mathrm{eff}}\\|} \\approx \\frac{2513.27}{4076.84} \\approx 0.6165.\n$$\nThe rotation angle is\n$$\n\\theta = \\|\\boldsymbol{\\omega}_{\\mathrm{eff}}\\|\\,\\tau \\approx (4076.84)\\,(150 \\times 10^{-6}) \\approx 0.6115\\ \\text{rad}.\n$$\nRounded to four significant figures, the effective rotation axis is approximately $(0.7874, 0, 0.6165)$ and the angle is $0.6115$ radians.",
            "answer": "$$\\boxed{\\begin{pmatrix}0.7874 & 0 & 0.6165 & 0.6115\\end{pmatrix}}$$"
        },
        {
            "introduction": "The Bloch equations not only describe spin behavior in uniform magnetic fields but also in the presence of spatial gradients, which are the basis of Magnetic Resonance Imaging (MRI). This practice delves into the formation of a gradient echo, where carefully timed magnetic field gradients first dephase and then rephase transverse magnetization to generate a signal echo. By working through this problem, you will gain insight into the crucial distinction between reversible dephasing, which can be manipulated, and irreversible $T_{2}^{*}$ decay. ",
            "id": "3726645",
            "problem": "An organic solute is dissolved in a deuterated solvent and studied by Nuclear Magnetic Resonance (NMR) spectroscopy in a high-field magnet. Immediately after a nonselective radiofrequency excitation, the transverse magnetization is created uniformly along the sample axis. Consider the magnetization dynamics described by the Bloch equations for the magnetization vector $\\mathbf{M}(t)$ in the presence of a static main field aligned along $\\hat{z}$ and a time-dependent linear field gradient $G(t)$ applied along the sample axis $\\hat{x}$. Assume that diffusion is negligible and that static field inhomogeneities and microscopic susceptibility effects are represented phenomenologically by a finite effective transverse relaxation time $T_{2}^{*}$, such that the irreversible decay of the complex transverse magnetization $M_{+}(x,t) = M_{x}(x,t) + i M_{y}(x,t)$ is governed by $T_{2}^{*}$.\n\nA bipolar gradient echo sequence is applied along $\\hat{x}$ without any refocusing $\\pi$ pulse: a positive gradient lobe of constant amplitude $G$ is applied for duration $\\tau_{1}$ starting at $t=0$, followed immediately by a negative gradient lobe of amplitude $-G$ for duration $\\tau_{2}$. Let the gyromagnetic ratio be $\\gamma$, and define the accumulated $k$-space trajectory $k(t) = \\gamma \\int_{0}^{t} G(t') \\,\\mathrm{d}t'$. The detected NMR signal is proportional to the spatial integral of $M_{+}(x,t)$ over the sample.\n\nUsing the Bloch equations and first principles of precession and relaxation, derive the condition under which reversible dephasing is refocused to form a gradient echo without a $\\pi$ pulse, and use it to determine the echo time $t_{e}$ measured from $t=0$. Then, under the finite $T_{2}^{*}$ assumption, determine the echo amplitude as a fraction of the initial transverse signal amplitude at $t=0$. In your derivation, explicitly justify why the gradient-induced phase can be refocused while the $T_{2}^{*}$ decay cannot be reversed by gradients.\n\nFor the numerical evaluation, use $G = 0.020\\ \\text{T}\\,\\text{m}^{-1}$, $\\tau_{1} = 5.00\\ \\text{ms}$, $\\tau_{2} = 15.00\\ \\text{ms}$, and $T_{2}^{*} = 28.0\\ \\text{ms}$. Express the echo time in milliseconds and the echo amplitude as a dimensionless fraction. Round both numerical results to four significant figures.",
            "solution": "The evolution of the complex transverse magnetization $M_{+}(x,t)$ at a position $x$ in the rotating frame is governed by the Bloch equation, which includes terms for precession due to the gradient and for irreversible relaxation:\n$$\n\\frac{\\mathrm{d}M_{+}(x,t)}{\\mathrm{d}t} = -i \\Delta\\omega(x,t) M_{+}(x,t) - \\frac{M_{+}(x,t)}{T_{2}^{*}}\n$$\nThe frequency offset $\\Delta\\omega(x,t)$ is caused by the position-dependent field from the gradient along the $\\hat{x}$ axis: $\\Delta\\omega(x,t) = \\gamma x G(t)$. Substituting this gives:\n$$\n\\frac{\\mathrm{d}M_{+}(x,t)}{\\mathrm{d}t} = \\left(-i \\gamma x G(t) - \\frac{1}{T_{2}^{*}}\\right) M_{+}(x,t)\n$$\nThis is a first-order linear ordinary differential equation. With the initial condition $M_{+}(x,0) = M_0$ (uniform transverse magnetization), the solution is found by integration:\n$$\nM_{+}(x,t) = M_0 \\exp\\left( -i \\gamma x \\int_{0}^{t} G(t') \\mathrm{d}t' \\right) \\exp\\left(-\\frac{t}{T_{2}^{*}}\\right)\n$$\nUsing the definition of the k-space trajectory, $k(t) = \\gamma \\int_{0}^{t} G(t') \\mathrm{d}t'$, this simplifies to:\n$$\nM_{+}(x,t) = M_0 \\exp(-i x k(t)) \\exp\\left(-\\frac{t}{T_{2}^{*}}\\right)\n$$\nThe total detected signal $S(t)$ is the integral of the magnetization over the entire sample. For the signal to be maximal (i.e., for an echo to form), the position-dependent phase term $\\exp(-i x k(t))$ must be unity for all $x$. This requires the k-space trajectory to be zero: $k(t_e) = 0$. This is the condition for echo formation at the echo time $t_e$.\n\nThe term $\\exp(-i x k(t))$ describes a deterministic phase accumulation that depends on the externally applied gradient waveform $G(t)$. This phase can be reversed by applying gradients of opposite polarity, making it a reversible dephasing mechanism. In contrast, the term $\\exp(-t/T_2^*)$ represents signal decay due to stochastic molecular processes and static field imperfections. This is a monotonic decay with time and cannot be reversed by the gradient sequence, making it an irreversible process in the context of this experiment.\n\nWe apply the condition $k(t_e)=0$ to the given bipolar gradient sequence. The echo must occur during the second lobe, so we evaluate the integral for a time $t_e$ where $\\tau_{1} < t_e \\le \\tau_{1} + \\tau_{2}$:\n$$\nk(t_e) = \\gamma \\left( \\int_{0}^{\\tau_{1}} G \\, \\mathrm{d}t' + \\int_{\\tau_{1}}^{t_e} (-G) \\, \\mathrm{d}t' \\right) = \\gamma \\left( G\\tau_{1} - G(t_e - \\tau_{1}) \\right)\n$$\nSetting $k(t_e)=0$ (and assuming $G \\neq 0, \\gamma \\neq 0$) yields:\n$$\nG\\tau_{1} = G(t_e - \\tau_{1}) \\implies t_e = 2\\tau_{1}\n$$\nThe signal amplitude at the echo time $t_e$ is proportional to $|M_0 \\exp(-t_e/T_2^*)|$. The initial signal amplitude is proportional to $|M_0|$. The echo amplitude as a fraction of the initial amplitude is therefore:\n$$\n\\frac{|S(t_e)|}{|S(0)|} = \\exp\\left(-\\frac{t_e}{T_{2}^{*}}\\right)\n$$\n\nNow, we substitute the numerical values:\n- Echo time: $t_e = 2\\tau_{1} = 2 \\times 5.00\\ \\text{ms} = 10.00\\ \\text{ms}$. (This is valid as $5.00 \\ \\text{ms} < 10.00 \\ \\text{ms} \\le 20.00 \\ \\text{ms}$.)\n- Echo amplitude fraction:\n$$\n\\text{Fraction} = \\exp\\left(-\\frac{10.00\\ \\text{ms}}{28.0\\ \\text{ms}}\\right) = \\exp\\left(-\\frac{10}{28}\\right) \\approx 0.699668\n$$\nRounding to four significant figures, the echo time is $10.00\\ \\text{ms}$ and the fractional amplitude is $0.6997$.",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 10.00 & 0.6997 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "Many molecules are not static but exist in a dynamic equilibrium, exchanging between different chemical forms. The Bloch equations can be extended into the Bloch-McConnell formalism to model these dynamic processes and predict their significant impact on NMR spectra. This computational exercise challenges you to implement this formalism, allowing you to simulate and visualize how exchange rates transform separate sharp peaks into broadened lines and eventually a single coalesced peak, providing a powerful tool for studying chemical kinetics. ",
            "id": "3726619",
            "problem": "Design and implement a program that computes, for a three-component Nuclear Magnetic Resonance (NMR) system relevant to spectrometric identification of organic compounds, the time-domain Free Induction Decay (FID) and its frequency-domain spectrum using the Bloch equations with chemical exchange (the Bloch–McConnell formalism). One of the components participates in intermediate chemical exchange with another component, and the goal is to quantify how this exchange modifies the composite spectral lineshape.\n\nStart from the following fundamental base:\n- The Bloch equations for transverse magnetization in the rotating frame, augmented by first-order chemical exchange between sites. Let the complex transverse magnetization for site $i$ be $m_i(t)$, with $i \\in \\{1,2,3\\}$. The free precession of each site under a static magnetic field with resonance offset and transverse relaxation, together with chemical exchange, is assumed first order and memoryless.\n- The rotating-frame offset frequency for site $i$ is $\\Delta \\nu_i$ in $\\mathrm{Hz}$, and its angular frequency is $\\omega_i = 2\\pi \\Delta \\nu_i$ in $\\mathrm{rad/s}$. The transverse relaxation rate is $R_{2,i}$ in $\\mathrm{s^{-1}}$. The exchange rate from site $i$ to site $j$ is $k_{i\\to j}$ in $\\mathrm{s^{-1}}$.\n- The transverse component dynamics are linear and can be written in matrix form $\\frac{d}{dt}\\mathbf{m}(t) = \\mathbf{A}\\,\\mathbf{m}(t)$, where $\\mathbf{m}(t) = [m_1(t), m_2(t), m_3(t)]^\\top$ and $\\mathbf{A}\\in\\mathbb{C}^{3\\times 3}$ collects relaxation, precession, and exchange. The observed complex FID is $s(t)=\\mathbf{1}^\\top \\mathbf{m}(t)$.\n- Immediately after a non-selective hard pulse of flip angle $\\pi/2$ radians (ninety degrees), assume small-tip, on-resonance, ideal excitation such that the initial transverse magnetizations are proportional to the site populations: $m_i(0)=p_i M_0$, with $M_0$ an arbitrary positive scale that may be set to $M_0=1$ without loss of generality. Use radians for all angles.\n\nConstruct $\\mathbf{A}$ explicitly from first principles:\n- For each site $i$, the diagonal element is $A_{ii} = -(R_{2,i} + \\mathrm{i}\\,\\omega_i) - \\sum_{j\\neq i} k_{i\\to j}$, where $\\mathrm{i}$ is the imaginary unit.\n- For $i\\neq j$, the off-diagonal element is $A_{ij} = k_{j\\to i}$.\n- The FID is then $s(t) = \\mathbf{1}^\\top \\exp(\\mathbf{A} t)\\, \\mathbf{m}(0)$, where $\\exp$ denotes the matrix exponential.\n\nNumerical specification and required computations:\n- Sampling:\n  - Number of acquired points $N = 2048$.\n  - Dwell time $\\Delta t = 1/2000$ $\\mathrm{s}$ (spectral width $= 2000$ $\\mathrm{Hz}$).\n  - Sample $s_n = s(n\\Delta t)$ for $n=0,1,\\dots,N-1$.\n- Frequency-domain spectrum:\n  - Compute the Discrete Fourier Transform (DFT) of the complex FID using the Fast Fourier Transform (FFT), produce the frequency axis in $\\mathrm{Hz}$ via the standard FFT frequency convention, and center it using a shift so that frequencies span approximately $[-1000,1000)$ $\\mathrm{Hz}$. Denote the complex spectrum by $S(\\nu)$ on this grid. Report and use only the real part $\\mathrm{Re}\\{S(\\nu)\\}$.\n  - Normalize each spectrum by dividing its real part by its maximum value over frequency so that its maximum real value equals $1$.\n- Exchange model:\n  - Exactly one pair of sites, sites $2$ and $3$, exchange with each other: $k_{2\\to 3}>0$ and $k_{3\\to 2}>0$; all other exchange rates are zero.\n  - Site $1$ does not exchange with other sites.\n- Comparison to no-exchange:\n  - For each parameter set, compute two spectra: one with the specified exchange rates and one with all exchange rates set to zero. Normalize both as above.\n  - Quantify how Bloch–McConnell modifies the composite lineshape by computing the root-mean-square (RMS) difference between the two normalized real spectra over the full frequency grid:\n    $$D = \\sqrt{\\frac{1}{N}\\sum_{n=0}^{N-1} \\left(S_{\\mathrm{ex}}^{\\mathrm{real}}(\\nu_n) - S_{\\mathrm{noex}}^{\\mathrm{real}}(\\nu_n)\\right)^2}.$$\n- Probe intensities:\n  - For each parameter set, also report the normalized real spectral values at five probe frequencies (in $\\mathrm{Hz}$): $\\{-150,-25,0,25,150\\}$. For each probe frequency, use the nearest frequency bin on the computed frequency grid.\n\nTest suite (all frequencies in $\\mathrm{Hz}$, all rates in $\\mathrm{s^{-1}}$, populations dimensionless and summing to $1$):\n- Common sampling parameters for all cases: $N=2048$, $\\Delta t = 1/2000$ $\\mathrm{s}$, flip angle $\\pi/2$ radians.\n- Case 1 (slow exchange):\n  - Populations: $(p_1,p_2,p_3) = (0.4, 0.3, 0.3)$.\n  - Offsets: $(\\Delta \\nu_1,\\Delta \\nu_2,\\Delta \\nu_3) = (-150,-25,25)$.\n  - Transverse relaxation rates: $(R_{2,1},R_{2,2},R_{2,3}) = (3,5,5)$.\n  - Exchange: $k_{2\\to 3}=1$, $k_{3\\to 2}=1$.\n- Case 2 (intermediate exchange):\n  - Populations: $(0.4,0.3,0.3)$.\n  - Offsets: $(-150,-25,25)$.\n  - Relaxation: $(3,5,5)$.\n  - Exchange: $k_{2\\to 3}=40$, $k_{3\\to 2}=40$.\n- Case 3 (fast exchange):\n  - Populations: $(0.4,0.3,0.3)$.\n  - Offsets: $(-150,-25,25)$.\n  - Relaxation: $(3,5,5)$.\n  - Exchange: $k_{2\\to 3}=500$, $k_{3\\to 2}=500$.\n- Case 4 (edge case, no exchange):\n  - Populations: $(0.4,0.3,0.3)$.\n  - Offsets: $(-150,-25,25)$.\n  - Relaxation: $(3,5,5)$.\n  - Exchange: $k_{2\\to 3}=0$, $k_{3\\to 2}=0$.\n\nProgram requirements:\n- Implement the FID generation by iterating the discrete-time propagator $\\mathbf{P}=\\exp(\\mathbf{A}\\Delta t)$ so that $\\mathbf{m}_{n+1}=\\mathbf{P}\\,\\mathbf{m}_n$, with $\\mathbf{m}_0=\\mathbf{m}(0)$ and $s_n=\\mathbf{1}^\\top \\mathbf{m}_n$.\n- For each case, compute:\n  - The RMS difference $D$ between the normalized real spectra with and without exchange.\n  - The five normalized real spectral values at probe frequencies $\\{-150,-25,0,25,150\\}$ as specified.\n- Final output format:\n  - Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each element corresponds to one case and is itself a list of six floats in the order $[D, I_{-150}, I_{-25}, I_{0}, I_{25}, I_{150}]$, with each float rounded to exactly six decimal places. There must be no whitespace characters in the printed line. For example: \"[[0.012345,0.9,0.8,0.7,0.6,0.5],[...],...]\" (values shown here are illustrative placeholders; your program must compute the actual values).\n- Angle units:\n  - The flip angle is $\\pi/2$ radians.\n- Frequency units:\n  - All frequencies must be expressed and probed in $\\mathrm{Hz}$.\n- Percentages:\n  - If any fraction is reported, present it as a decimal number.\n\nYour program must be self-contained, accept no input, and use only the specified libraries. Its single-line output must aggregate the results for the four test cases as described above.",
            "solution": "We begin from the Bloch equations for transverse magnetization in the rotating frame, extended to include first-order chemical exchange, known as the Bloch–McConnell equations. Let $\\mathbf{m}(t) = [m_1(t), m_2(t), m_3(t)]^\\top \\in \\mathbb{C}^3$ denote the complex transverse magnetizations of three distinct sites. The fundamental contributions are:\n- Free precession for site $i$ at angular offset $\\omega_i = 2\\pi \\Delta \\nu_i$ adds a term $-\\mathrm{i}\\,\\omega_i m_i$.\n- Transverse relaxation at rate $R_{2,i}$ adds a term $-R_{2,i} m_i$.\n- Chemical exchange from site $i$ to $j$ with rate $k_{i\\to j}$ reduces $m_i$ at rate $k_{i\\to j} m_i$, while exchange from $j$ to $i$ increases $m_i$ at rate $k_{j\\to i} m_j$.\n\nSumming these contributions yields, for each site $i$,\n$$\n\\frac{d}{dt} m_i(t) = -\\left(R_{2,i} + \\mathrm{i}\\,\\omega_i\\right) m_i(t) - \\sum_{j\\neq i} k_{i\\to j} m_i(t) + \\sum_{j\\neq i} k_{j\\to i} m_j(t).\n$$\nIn matrix form, $\\frac{d}{dt}\\mathbf{m}(t) = \\mathbf{A}\\,\\mathbf{m}(t)$, where the elements of $\\mathbf{A}$ are\n$$\nA_{ii} = -\\left(R_{2,i} + \\mathrm{i}\\,\\omega_i\\right) - \\sum_{j\\neq i} k_{i\\to j}, \\quad\nA_{ij} = k_{j\\to i}\\quad (i\\neq j).\n$$\nThe observed complex Free Induction Decay (FID) under ideal non-selective $\\pi/2$ excitation is the sum of transverse components:\n$$\ns(t) = \\mathbf{1}^\\top \\mathbf{m}(t) = \\mathbf{1}^\\top \\exp(\\mathbf{A} t)\\,\\mathbf{m}(0),\n$$\nwith initial condition $\\mathbf{m}(0) = M_0 [p_1,p_2,p_3]^\\top$ and $M_0$ set to $1$ without loss of generality.\n\nTo compute the FID numerically, we sample at $N$ uniform time points with dwell time $\\Delta t$. Let $\\mathbf{P}=\\exp(\\mathbf{A}\\Delta t)$, so that the discrete evolution satisfies\n$$\n\\mathbf{m}_{n+1} = \\mathbf{P} \\mathbf{m}_n,\\quad \\mathbf{m}_0 = \\mathbf{m}(0), \\quad s_n = \\mathbf{1}^\\top \\mathbf{m}_n,\\quad n=0,1,\\dots,N-1.\n$$\nThis iteration is stable and efficient for small matrices and provides the sampled FID $\\{s_n\\}$.\n\nThe frequency-domain spectrum is computed by the Discrete Fourier Transform (DFT), implemented via the Fast Fourier Transform (FFT). Let the complex spectrum be $S(\\nu_n)$, where the frequencies $\\{\\nu_n\\}$ in $\\mathrm{Hz}$ are generated by the standard FFT frequency mapping for sampling interval $\\Delta t$ and then shifted to center zero frequency:\n$$\n\\nu_n = \\mathrm{fftshift}\\left(\\mathrm{fftfreq}(N,\\Delta t)\\right), \\quad S(\\nu) = \\mathrm{fftshift}\\left(\\mathrm{FFT}(\\{s_n\\})\\right).\n$$\nFor ideal exponential decays starting at $t=0$, the real part $\\mathrm{Re}\\{S(\\nu)\\}$ corresponds to the absorptive Lorentzian lineshape for each non-exchanging site; under exchange, the Bloch–McConnell dynamics mix sites and split or coalesce peaks depending on the regime (slow, intermediate, fast).\n\nWe normalize the real part of each spectrum to have unit maximum:\n$$\n\\tilde{S}_{\\mathrm{real}}(\\nu) = \\frac{\\mathrm{Re}\\{S(\\nu)\\}}{\\max_{\\nu} \\mathrm{Re}\\{S(\\nu)\\}}.\n$$\nTo quantify how exchange modifies the composite lineshape, we compute the root-mean-square (RMS) difference between the normalized real spectrum with exchange, $\\tilde{S}_{\\mathrm{ex}}(\\nu)$, and that without exchange, $\\tilde{S}_{\\mathrm{noex}}(\\nu)$:\n$$\nD = \\sqrt{\\frac{1}{N} \\sum_{n=0}^{N-1} \\left(\\tilde{S}_{\\mathrm{ex}}(\\nu_n) - \\tilde{S}_{\\mathrm{noex}}(\\nu_n)\\right)^2 }.\n$$\nThis dimensionless measure captures broadening, coalescence, and dispersion changes introduced by exchange.\n\nThe algorithm proceeds as follows:\n- Construct $\\mathbf{A}$ with given $(R_{2,i})$, $(\\Delta \\nu_i)$ converted to $(\\omega_i = 2\\pi \\Delta \\nu_i)$, and exchange rates $(k_{i\\to j})$, with only $k_{2\\to 3}$ and $k_{3\\to 2}$ nonzero for the exchanging pair; site $1$ has no exchange.\n- Compute $\\mathbf{P}=\\exp(\\mathbf{A}\\Delta t)$, for example via eigen-decomposition $\\mathbf{A}=\\mathbf{V}\\mathbf{\\Lambda}\\mathbf{V}^{-1}$ so that $\\exp(\\mathbf{A}\\Delta t)=\\mathbf{V}\\exp(\\mathbf{\\Lambda}\\Delta t)\\mathbf{V}^{-1}$ with diagonal exponentials.\n- Iterate $\\mathbf{m}_{n+1}=\\mathbf{P}\\mathbf{m}_n$ to generate the FID $\\{s_n\\}$ for $n=0,\\dots,N-1$.\n- Compute and center the FFT to obtain $S(\\nu)$ and its real part; normalize as above.\n- Repeat for the no-exchange case by setting $k_{2\\to 3}=k_{3\\to 2}=0$ (all exchange rates zero), keeping all other parameters identical.\n- Compute $D$ and probe the normalized real spectrum at $\\{-150,-25,0,25,150\\}$ $\\mathrm{Hz}$ via nearest-bin selection.\n\nExpected qualitative behavior across the test suite:\n- Case $1$ (slow exchange, $k_{2\\to 3}=k_{3\\to 2}=1$) should yield three resolved Lorentzian-like peaks near $-150$ $\\mathrm{Hz}$, $-25$ $\\mathrm{Hz}$, and $25$ $\\mathrm{Hz}$ with minimal distortion from no-exchange, giving a small $D$.\n- Case $2$ (intermediate exchange, $k_{2\\to 3}=k_{3\\to 2}=40$) should broaden and partially coalesce the two exchanging-site peaks, increasing $D$ noticeably; probe intensities near $-25$ $\\mathrm{Hz}$ and $25$ $\\mathrm{Hz}$ change substantially.\n- Case $3$ (fast exchange, $k_{2\\to 3}=k_{3\\to 2}=500$) should produce an averaged single line for sites $2$ and $3$ near their population-weighted mean offset (here approximately $0$ $\\mathrm{Hz}$), further modifying the composite lineshape and yielding a larger $D$ compared to case $1$.\n- Case $4$ (no exchange) must produce $D=0$ by construction, since the exchange and no-exchange spectra coincide exactly; this is a boundary check.\n\nThe program implements these steps numerically with $N=2048$ and $\\Delta t = 1/2000$ $\\mathrm{s}$, and outputs a single line containing, for each case, the RMS difference $D$ and the five probe intensities in the order $[D, I_{-150}, I_{-25}, I_{0}, I_{25}, I_{150}]$, each rounded to six decimal places, concatenated as a comma-separated list within brackets and without whitespace. This demonstrates quantitatively how the Bloch–McConnell formalism modifies the composite NMR lineshape due to exchange, a critical consideration in spectrometric identification of organic compounds where line-broadening and coalescence can encode dynamic chemical processes.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef build_A_matrix(dnu_hz, R2, k23, k32):\n    \"\"\"\n    Construct the 3x3 complex Bloch-McConnell A matrix for transverse magnetization.\n    dnu_hz: list or array of length 3 with offsets in Hz [Δν1, Δν2, Δν3]\n    R2: list or array of length 3 with transverse relaxation rates in s^-1\n    k23, k32: exchange rates between site 2 and 3 in s^-1\n    Site 1 is non-exchanging; only 2<->3 exchange is present.\n    \"\"\"\n    omega = 2 * np.pi * np.array(dnu_hz, dtype=float)  # rad/s\n    R2 = np.array(R2, dtype=float)\n    # Initialize A\n    A = np.zeros((3,3), dtype=complex)\n    # Diagonal terms: -(R2_i + i*omega_i) - sum_outgoing_k\n    # Off-diagonal terms: k_{j->i}\n    # Site 1: no exchange\n    A[0,0] = -(R2[0] + 1j*omega[0])\n    # Sites 2 and 3: include exchange\n    # Outgoing from 2 to 3: k23; from 3 to 2: k32\n    A[1,1] = -(R2[1] + 1j*omega[1]) - k23\n    A[2,2] = -(R2[2] + 1j*omega[2]) - k32\n    # Off-diagonals for exchange pair\n    A[1,2] = k32  # from 3 to 2\n    A[2,1] = k23  # from 2 to 3\n    return A\n\ndef propagator_from_A(A, dt):\n    \"\"\"\n    Compute the discrete-time propagator P = expm(A*dt) using eigendecomposition.\n    \"\"\"\n    vals, vecs = np.linalg.eig(A)\n    vecs_inv = np.linalg.inv(vecs)\n    exp_diag = np.exp(vals * dt)\n    P = (vecs @ np.diag(exp_diag) @ vecs_inv).astype(complex)\n    return P\n\ndef simulate_fid(P, m0, N):\n    \"\"\"\n    Iterate m_{n+1} = P m_n to generate s_n = sum(m_n) for n=0..N-1.\n    \"\"\"\n    m = m0.astype(complex)\n    s = np.empty(N, dtype=complex)\n    one = np.array([1.0, 1.0, 1.0], dtype=complex)\n    for n in range(N):\n        s[n] = one @ m\n        m = P @ m\n    return s\n\ndef spectrum_from_fid(s, dt):\n    \"\"\"\n    Compute centered FFT spectrum and frequency axis in Hz.\n    Return (freqs, S_centered).\n    \"\"\"\n    N = s.size\n    S = np.fft.fft(s) * dt  # scale by dt to approximate continuous-time FT units\n    S_shift = np.fft.fftshift(S)\n    freqs = np.fft.fftshift(np.fft.fftfreq(N, d=dt))\n    return freqs, S_shift\n\ndef nearest_bin_indices(freqs, probe_freqs):\n    \"\"\"\n    For each probe frequency, find the index of the nearest frequency bin.\n    \"\"\"\n    idxs = []\n    for f in probe_freqs:\n        idx = int(np.argmin(np.abs(freqs - f)))\n        idxs.append(idx)\n    return idxs\n\ndef normalize_real_spectrum(S_real):\n    \"\"\"\n    Normalize the real part of spectrum to have max value 1.\n    \"\"\"\n    max_val = np.max(S_real)\n    # Avoid division by zero; if all zero (shouldn't happen), return zeros\n    if max_val == 0.0:\n        return S_real\n    return S_real / max_val\n\ndef run_case(pops, dnu_hz, R2, k23, k32, N, dt, probe_freqs):\n    \"\"\"\n    Run a single test case and return (D, [I_probe...]) according to spec.\n    \"\"\"\n    # Initial magnetizations after 90-degree pulse (π/2 radians): m0 = pops (M0=1)\n    m0 = np.array(pops, dtype=float)\n    # With exchange\n    A_ex = build_A_matrix(dnu_hz, R2, k23, k32)\n    P_ex = propagator_from_A(A_ex, dt)\n    s_ex = simulate_fid(P_ex, m0, N)\n    freqs, S_ex = spectrum_from_fid(s_ex, dt)\n    S_ex_real_norm = normalize_real_spectrum(S_ex.real)\n    # Without exchange (all k=0)\n    A_no = build_A_matrix(dnu_hz, R2, 0.0, 0.0)\n    P_no = propagator_from_A(A_no, dt)\n    s_no = simulate_fid(P_no, m0, N)\n    _, S_no = spectrum_from_fid(s_no, dt)\n    S_no_real_norm = normalize_real_spectrum(S_no.real)\n    # RMS difference\n    D = float(np.sqrt(np.mean((S_ex_real_norm - S_no_real_norm) ** 2)))\n    # Probe intensities at specified frequencies\n    idxs = nearest_bin_indices(freqs, probe_freqs)\n    I_probes = [float(S_ex_real_norm[i]) for i in idxs]\n    return D, I_probes\n\ndef solve():\n    # Define sampling parameters\n    N = 2048\n    dt = 1.0 / 2000.0  # seconds\n    probe_freqs = [-150.0, -25.0, 0.0, 25.0, 150.0]  # Hz\n    # Define test cases as specified\n    test_cases = [\n        # (pops, dnu_hz, R2, k23, k32)\n        ((0.4, 0.3, 0.3), (-150.0, -25.0, 25.0), (3.0, 5.0, 5.0), 1.0, 1.0),    # Case 1: slow exchange\n        ((0.4, 0.3, 0.3), (-150.0, -25.0, 25.0), (3.0, 5.0, 5.0), 40.0, 40.0),  # Case 2: intermediate exchange\n        ((0.4, 0.3, 0.3), (-150.0, -25.0, 25.0), (3.0, 5.0, 5.0), 500.0, 500.0),# Case 3: fast exchange\n        ((0.4, 0.3, 0.3), (-150.0, -25.0, 25.0), (3.0, 5.0, 5.0), 0.0, 0.0),    # Case 4: no exchange\n    ]\n    results = []\n    for pops, dnu_hz, R2, k23, k32 in test_cases:\n        D, I_probes = run_case(pops, dnu_hz, R2, k23, k32, N, dt, probe_freqs)\n        # Round to six decimal places as required\n        out = [round(D, 6)] + [round(val, 6) for val in I_probes]\n        results.append(out)\n    # Format output with no spaces, each float with exactly six decimals\n    def format_float(x):\n        return f\"{x:.6f}\"\n    formatted_cases = []\n    for case in results:\n        formatted_cases.append(\"[\" + \",\".join(format_float(x) for x in case) + \"]\")\n    print(\"[\" + \",\".join(formatted_cases) + \"]\")\n\nif __name__ == \"__main__\":\n    solve()\n```"
        }
    ]
}