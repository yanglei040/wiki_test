{
    "hands_on_practices": [
        {
            "introduction": "At the heart of any well-balanced scheme lies the exact cancellation of discrete numerical operators that represent balancing physical forces. This foundational exercise guides you through the analytical derivation of a gravitational source term that precisely balances a discrete pressure gradient . By constructing the appropriate quadrature weights for a finite-volume discretization in spherical symmetry, you will see firsthand how to enforce hydrostatic equilibrium at the discrete level, a critical skill for developing robust numerical methods.",
            "id": "3529805",
            "problem": "Consider the spherically symmetric compressible Euler equations for a self-gravitating gas with gravitational potential $\\Phi(r)$ and sound speed $c_s$, assuming an isothermal equation of state (EOS) $p = c_s^2 \\rho$. In spherical symmetry, the radial momentum equation can be written in conservative form as\n$$\n\\partial_t\\!\\left(\\rho u\\right) + \\frac{1}{r^2}\\,\\partial_r\\!\\left(r^2 p\\right) \\;=\\; -\\,\\rho\\,\\partial_r \\Phi,\n$$\nwhich, when multiplied by $r^2$, becomes\n$$\n\\partial_t\\!\\left(\\rho u\\right) r^2 + \\partial_r\\!\\left(r^2 p\\right) \\;=\\; -\\,\\rho\\,r^2\\,\\partial_r \\Phi.\n$$\nAt hydrostatic equilibrium, $u \\equiv 0$, and the equation reduces to\n$$\n\\partial_r\\!\\left(r^2 p\\right) \\;=\\; -\\,\\rho\\,r^2\\,\\partial_r \\Phi.\n$$\nConsider a finite-volume discretization on a strictly monotone nonuniform radial grid with cell $i$ spanning $[r_{i-\\frac{1}{2}},\\,r_{i+\\frac{1}{2}}]$ and cell volume\n$$\nV_i \\;=\\; \\int_{r_{i-\\frac{1}{2}}}^{r_{i+\\frac{1}{2}}} r^2 \\, dr \\;=\\; \\frac{1}{3}\\left(r_{i+\\frac{1}{2}}^3 - r_{i-\\frac{1}{2}}^3\\right).\n$$\nLet the discrete flux contribution in cell $i$ be evaluated with face pressures,\n$$\n\\frac{1}{V_i}\\left(r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}} - r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}\\right),\n$$\nand define a hydrostatic reconstruction for face pressures (to ensure positivity) by mapping each cell-center state $(\\rho_i, p_i)$ to faces via the enthalpy relation implied by the isothermal EOS:\n$$\np_{i\\pm\\frac{1}{2}}^{\\mathrm{eq}} \\;=\\; c_s^2\\,\\rho_i\\,\\exp\\!\\left(-\\,\\frac{\\Phi_{i\\pm\\frac{1}{2}} - \\Phi_i}{c_s^2}\\right),\n$$\nwhich guarantees $p_{i\\pm\\frac{1}{2}}^{\\mathrm{eq}} > 0$ for any real potential differences. In equilibrium, consistent cell-center states across the domain produce identical left and right reconstructions at each face. The gravitational source in the finite-volume update is\n$$\nS_i^{g} \\;=\\; -\\,\\frac{1}{V_i}\\int_{r_{i-\\frac{1}{2}}}^{r_{i+\\frac{1}{2}}} \\rho(r)\\,r^2\\,\\partial_r \\Phi(r) \\, dr,\n$$\nwhich we wish to replace by a two-point, edge-based quadrature of the form\n$$\nS_i^{g,\\mathrm{quad}} \\;=\\; -\\,\\frac{1}{V_i}\\,\\Big[w_{i-\\frac{1}{2}}\\,r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}} \\;+\\; w_{i+\\frac{1}{2}}\\,r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}}\\Big],\n$$\nwith fixed weights $w_{i-\\frac{1}{2}}$ and $w_{i+\\frac{1}{2}}$ independent of the grid spacing, such that the discrete momentum balance is exactly satisfied at hydrostatic equilibrium for any nonuniform grid:\n$$\n\\frac{1}{V_i}\\left(r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}} - r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}}\\right) \\;+\\; S_i^{g,\\mathrm{quad}} \\;=\\; 0.\n$$\nDerive the values of the two quadrature weights $w_{i-\\frac{1}{2}}$ and $w_{i+\\frac{1}{2}}$ that ensure the above discrete well-balance holds exactly when the face pressures are reconstructed hydrostatically as specified. Express your final answer as the ordered pair $\\left(w_{i-\\frac{1}{2}},\\,w_{i+\\frac{1}{2}}\\right)$ in a single closed-form analytic expression. No rounding is required.",
            "solution": "The user wants to find the quadrature weights $w_{i-\\frac{1}{2}}$ and $w_{i+\\frac{1}{2}}$ for a well-balanced numerical scheme.\n\n### Step 1: Extract Givens\n\n-   **Discrete Balance Equation**: In hydrostatic equilibrium ($u=0$), the finite-volume update for the momentum in cell $i$ must be zero. This is expressed as:\n    $$\n    \\frac{1}{V_i}\\left(r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}} - r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}}\\right) \\;+\\; S_i^{g,\\mathrm{quad}} \\;=\\; 0\n    $$\n-   **Quadrature Source Term**: The gravitational source term $S_i^{g,\\mathrm{quad}}$ is approximated using a two-point quadrature at the cell faces:\n    $$\n    S_i^{g,\\mathrm{quad}} \\;=\\; -\\,\\frac{1}{V_i}\\,\\Big[w_{i-\\frac{1}{2}}\\,r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}} \\;+\\; w_{i+\\frac{1}{2}}\\,r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}}\\Big]\n    $$\n-   **Hydrostatic Face Pressures**: The pressures at the cell faces, $p_{i\\pm\\frac{1}{2}}^{\\mathrm{eq}}$, are derived from a hydrostatic reconstruction based on the isothermal equation of state. Their specific form is given but not directly required for the algebraic manipulation, only that they are positive and determined by the equilibrium state.\n-   **Constraint**: The weights $w_{i-\\frac{1}{2}}$ and $w_{i+\\frac{1}{2}}$ must be constants, independent of the grid, ensuring the balance holds for any nonuniform grid and any valid hydrostatic equilibrium state.\n\n### Step 2: Validate Using Extracted Givens\n\n-   **Scientifically Grounded (Critical)**: The problem is set within the established framework of computational astrophysics and numerical methods for hyperbolic conservation laws. It addresses a fundamental issue: designing numerical schemes that exactly preserve known steady-state solutions (well-balanced schemes). The equations and methods described are standard in the field. The problem is scientifically sound.\n-   **Well-Posed**: The problem provides a clear objective (find the weights) and a specific algebraic condition that must be satisfied. The number of constraints matches the number of unknowns, suggesting a unique solution exists.\n-   **Objective (Critical)**: The problem is formulated in precise mathematical language, free of ambiguity or subjective statements.\n-   **Other Flaws**: The problem is self-contained, logically consistent, and its setup is not contradictory or incomplete for the task at hand. It is a standard derivation and not trivial.\n\n### Step 3: Verdict and Action\n\nThe problem is **valid**. I will proceed to derive the solution.\n\n### Derivation\n\nThe core of the problem is to solve for the weights $w_{i-\\frac{1}{2}}$ and $w_{i+\\frac{1}{2}}$ by enforcing the discrete balance condition. The condition states that the sum of the discrete pressure gradient term and the discrete gravitational source term must be zero.\n\nLet's begin with the discrete balance equation:\n$$\n\\frac{1}{V_i}\\left(r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}} - r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}}\\right) \\;+\\; S_i^{g,\\mathrm{quad}} \\;=\\; 0\n$$\nNow, substitute the provided expression for the quadrature source term, $S_i^{g,\\mathrm{quad}}$:\n$$\n\\frac{1}{V_i}\\left(r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}} - r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}}\\right) - \\frac{1}{V_i}\\,\\Big[w_{i-\\frac{1}{2}}\\,r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}} \\;+\\; w_{i+\\frac{1}{2}}\\,r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}}\\Big] \\;=\\; 0\n$$\nWe can simplify this equation by multiplying both sides by the cell volume $V_i$, which is always non-zero:\n$$\n\\left(r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}} - r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}}\\right) - \\Big[w_{i-\\frac{1}{2}}\\,r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}} \\;+\\; w_{i+\\frac{1}{2}}\\,r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}}\\Big] \\;=\\; 0\n$$\nTo solve for the weights, we rearrange the equation by grouping terms associated with the left face ($i-\\frac{1}{2}$) and the right face ($i+\\frac{1}{2}$):\n$$\n\\left(r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}} - w_{i+\\frac{1}{2}}\\,r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}}\\right) - \\left(r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}} + w_{i-\\frac{1}{2}}\\,r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}}\\right) \\;=\\; 0\n$$\nFactor out the common terms $r_{i\\pm\\frac{1}{2}}^2\\,p_{i\\pm\\frac{1}{2}}^{\\mathrm{eq}}$:\n$$\n(1 - w_{i+\\frac{1}{2}})\\left(r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}}\\right) - (1 + w_{i-\\frac{1}{2}})\\left(r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}}\\right) \\;=\\; 0\n$$\nThis equation must hold true for *any* nonuniform grid (i.e., any valid $r_{i\\pm\\frac{1}{2}}$) and for *any* hydrostatic equilibrium configuration (i.e., any valid set of positive pressures $p_{i\\pm\\frac{1}{2}}^{\\mathrm{eq}}$ consistent with some potential $\\Phi(r)$). The terms $r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}}$ and $r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}}$ are generally non-zero and are not guaranteed to be equal or have a fixed ratio. For the linear combination of these two terms to be zero under all such conditions, their respective coefficients must be identically zero.\n\nThis gives us two independent equations:\n1.  The coefficient of the term for the right face ($i+\\frac{1}{2}$) must be zero:\n    $$\n    1 - w_{i+\\frac{1}{2}} \\;=\\; 0\n    $$\n2.  The coefficient of the term for the left face ($i-\\frac{1}{2}$) must be zero:\n    $$\n    1 + w_{i-\\frac{1}{2}} \\;=\\; 0\n    $$\nSolving these two simple equations for the weights yields:\n1.  From the first equation:\n    $$\n    w_{i+\\frac{1}{2}} \\;=\\; 1\n    $$\n2.  From the second equation:\n    $$\n    w_{i-\\frac{1}{2}} \\;=\\; -1\n    $$\nThese values are constants, satisfying the problem's constraint that they be independent of the grid spacing.\n\nThe desired result is the ordered pair $\\left(w_{i-\\frac{1}{2}},\\,w_{i+\\frac{1}{2}}\\right)$.\nThe derived values are $w_{i-\\frac{1}{2}} = -1$ and $w_{i+\\frac{1}{2}} = 1$.\nTherefore, the ordered pair is $(-1, 1)$.",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix} -1 & 1 \\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "Theory provides the blueprint, but implementation reveals the practical impact. This exercise moves from derivation to demonstration by tasking you with a comparative study of two different source term discretizations for a polytropic atmosphere . By coding and running a simulation with both a naive and a well-balanced source term, you will quantitatively measure the spurious velocities that arise from truncation error and appreciate the necessity of well-balanced methods for accurately modeling stratified systems.",
            "id": "3529798",
            "problem": "Consider the one-dimensional compressible Euler equations with a constant gravitational acceleration $g$ acting in the negative $z$-direction. Let the conservative state be $U = [\\rho, \\rho u, E]^{\\top}$, where $\\rho$ is the mass density, $u$ is the velocity, and $E$ is the total energy density. The flux is $F(U) = [\\rho u, \\rho u^{2} + P, u(E + P)]^{\\top}$ and the source is $S(U) = [0, -\\rho g, -\\rho g u]^{\\top}$. The equation of state is polytropic with $P = K \\rho^{\\gamma}$, where $K$ is a positive constant and $\\gamma = 1 + 1/n$ is the adiabatic index for polytropic index $n$. In hydrostatic equilibrium, $u \\equiv 0$ and $dP/dz = - \\rho g$. Assume nondimensional units.\n\nStarting from these fundamental definitions, do the following:\n\n1. Derive the hydrostatic stratification for a polytropic atmosphere with constant $g$, polytropic constant $K$, adiabatic index $\\gamma > 1$, and base density $\\rho(0) = \\rho_{0}$. Show that the unique smooth hydrostatic solution with $u \\equiv 0$ in $z \\in [0, z_{s})$ satisfies\n   $$\n   \\frac{1}{\\gamma - 1}\\,\\rho(z)^{\\gamma - 1} = \\frac{1}{\\gamma - 1}\\,\\rho_{0}^{\\gamma - 1} - \\frac{g}{K \\gamma}\\,z,\n   $$\n   and hence\n   $$\n   \\rho(z) = \\left[\\rho_{0}^{\\gamma - 1} - \\frac{(\\gamma - 1) g}{K \\gamma}\\,z\\right]^{\\frac{1}{\\gamma - 1}}, \\qquad P(z) = K\\,\\rho(z)^{\\gamma},\n   $$\n   with the finite “surface” height\n   $$\n   z_{s} = \\frac{K \\gamma}{g(\\gamma - 1)}\\,\\rho_{0}^{\\gamma - 1}.\n   $$\n   You must provide this derivation in your program’s internal logic comments or documentation of the implemented formulas.\n\n2. Implement a first-order, finite-volume, explicit Euler time update for the Euler equations on a uniform grid with $N$ cells covering $z \\in [0, H]$, where $H = \\alpha\\, z_{s}$ and $\\alpha \\in (0, 1)$ is fixed. Use the local Lax–Friedrichs (Rusanov) flux. Let the time step $\\Delta t$ satisfy a Courant–Friedrichs–Lewy (CFL) condition with a given CFL number, based on the maximum signal speed $|u| + c$, where $c = \\sqrt{\\gamma P / \\rho}$ is the speed of sound. Initialize the cell averages from the hydrostatic polytropic profile at cell centers. Use ghost cells filled from the same hydrostatic profile. Assume nondimensional units throughout.\n\n3. Compare two source discretizations (source splittings) for the momentum equation, while using the energy source $-\\rho g u$ and zero mass source in both cases:\n   - Splitting A (naive): $S_{m,i} = -\\rho_{i} g$ at the cell center $z_{i}$.\n   - Splitting B (discrete well-balanced via exact hydrostatic pressure at centers): $S_{m,i} = -\\left(P^{\\mathrm{eq}}_{i+1} - P^{\\mathrm{eq}}_{i-1}\\right)/(2 \\Delta z)$, where $P^{\\mathrm{eq}}_{j}$ is the exact hydrostatic pressure evaluated at the center of cell $j$ (including ghost cells) and $\\Delta z$ is the uniform grid spacing. This choice is constructed so that, for $u \\equiv 0$ and the exact hydrostatic state, the discrete pressure gradient from the Rusanov momentum flux cancels the source term to machine precision.\n\n   The time update to be implemented is\n   $$\n   U_{i}^{n+1} = U_{i}^{n} - \\frac{\\Delta t}{\\Delta z}\\left(F_{i+\\frac{1}{2}}^{n} - F_{i-\\frac{1}{2}}^{n}\\right) + \\Delta t\\,S_{i}^{n},\n   $$\n   using first-order piecewise-constant reconstruction.\n\n4. Design the test cases to probe near-surface behavior (small density and pressure) and the effect of mesh refinement. Use the following fixed nondimensional parameters:\n   - $\\gamma = 5/3$,\n   - $n = 3/2$ (implied by $\\gamma$),\n   - $K = 1$,\n   - $g = 1$,\n   - $\\rho_{0} = 1$,\n   - $\\alpha = 0.9$ so that $H = 0.9\\, z_{s}$,\n   - CFL number equal to $0.4$,\n   - one explicit Euler time step for each run.\n\n   With these, the surface height is $z_{s} = \\dfrac{K \\gamma}{g(\\gamma - 1)} \\rho_{0}^{\\gamma - 1}$, and $H = 0.9\\,z_{s}$ ensures strictly positive $\\rho$ and $P$ in the computational domain including a one-cell ghost layer.\n\n5. Implement two grid resolutions corresponding to a simple Adaptive Mesh Refinement (AMR) refinement study by uniform refinement:\n   - Coarse grid with $N = 64$ cells,\n   - Refined grid with $N = 128$ cells.\n\n   For each $N$, run Splitting A and Splitting B separately. In total, this yields four runs.\n\n6. For each run, compute the following two quantitative diagnostics after the single time step:\n   - The minimum pressure across all real (non-ghost) cells, denoted $P_{\\min}$.\n   - The maximum absolute cell-centered velocity across all real cells, denoted $\\|u\\|_{\\infty}$.\n\n   These two metrics serve as a positivity indicator (through $P_{\\min}$) and a discrete well-balance indicator (through $\\|u\\|_{\\infty}$).\n\n7. Your program must produce a single line of output containing the results as a comma-separated list enclosed in square brackets in the following fixed order, with each floating-point number formatted to $8$ digits after the decimal point in scientific notation:\n   - $P_{\\min}$ for Splitting A with $N = 64$,\n   - $\\|u\\|_{\\infty}$ for Splitting A with $N = 64$,\n   - $P_{\\min}$ for Splitting A with $N = 128$,\n   - $\\|u\\|_{\\infty}$ for Splitting A with $N = 128$,\n   - $P_{\\min}$ for Splitting B with $N = 64$,\n   - $\\|u\\|_{\\infty}$ for Splitting B with $N = 64$,\n   - $P_{\\min}$ for Splitting B with $N = 128$,\n   - $\\|u\\|_{\\infty}$ for Splitting B with $N = 128$.\n\n   For example, the output must have the form\n   $$\n   [x_{1},x_{2},x_{3},x_{4},x_{5},x_{6},x_{7},x_{8}],\n   $$\n   where each $x_{k}$ is a floating-point number formatted with $8$ digits after the decimal point in scientific notation.\n\nYour implementation must be self-contained, rely only on the specified libraries, and not require any user input. All quantities are nondimensional, so no physical units are to be included in the output. The numerical method and formulas must be derived only from the fundamental laws and core definitions stated at the beginning of this problem, ensuring scientific realism and internal consistency. The test suite above covers a representative near-surface polytropic equilibrium, a naive versus a well-balanced source splitting, and a two-level refinement study to assess both positivity behavior and discrete hydrostatic balance under refinement. The expected behavior is that the well-balanced splitting will significantly reduce $\\|u\\|_{\\infty}$ relative to the naive splitting and that refinement will reduce spurious velocities for the naive splitting. Positivity is assessed by the magnitude of $P_{\\min}$ across cases.",
            "solution": "The problem requires the implementation and comparison of two numerical schemes for the one-dimensional compressible Euler equations with a constant gravitational field. The goal is to evaluate the schemes' ability to preserve positivity of pressure and maintain a state of hydrostatic equilibrium.\n\nThe governing equations for mass, momentum, and total energy conservation are:\n$$\n\\frac{\\partial}{\\partial t}\n\\begin{pmatrix} \\rho \\\\ \\rho u \\\\ E \\end{pmatrix}\n+\n\\frac{\\partial}{\\partial z}\n\\begin{pmatrix} \\rho u \\\\ \\rho u^2 + P \\\\ u(E+P) \\end{pmatrix}\n=\n\\begin{pmatrix} 0 \\\\ -\\rho g \\\\ -\\rho g u \\end{pmatrix}\n$$\nThis can be written in compact form as $\\partial_t U + \\partial_z F(U) = S(U,z)$. The system is closed by a polytropic equation of state, $P = K \\rho^{\\gamma}$, where $P$ is the pressure, $\\rho$ is the mass density, $u$ is the velocity, $E = P/(\\gamma-1) + \\rho u^2/2$ is the total energy density, $g$ is the gravitational acceleration, $K$ is the polytropic constant, and $\\gamma$ is the adiabatic index.\n\nFirst, we establish the analytical solution for hydrostatic equilibrium, which serves as the initial condition for our numerical tests. In equilibrium, the velocity $u$ is identically zero, and time derivatives vanish. The momentum equation simplifies to the hydrostatic balance equation:\n$$\n\\frac{dP}{dz} = -\\rho g\n$$\nSubstituting the polytropic equation of state $P = K\\rho^{\\gamma}$, we obtain a first-order ordinary differential equation for the density $\\rho(z)$:\n$$\n\\frac{d}{dz}(K\\rho^{\\gamma}) = K\\gamma \\rho^{\\gamma-1}\\frac{d\\rho}{dz} = -\\rho g\n$$\nFor $\\rho > 0$, we can separate variables and integrate:\n$$\nK\\gamma \\int_{\\rho_0}^{\\rho(z)} \\rho'^{\\gamma-2} d\\rho' = -g \\int_0^z dz'\n$$\nwhere $\\rho(0) = \\rho_0$ is the density at the base of the atmosphere ($z=0$). The integration yields:\n$$\n\\frac{K\\gamma}{\\gamma-1} \\left( \\rho(z)^{\\gamma-1} - \\rho_0^{\\gamma-1} \\right) = -gz\n$$\nRearranging gives the solution for the density profile, as specified in the problem statement:\n$$\n\\rho(z) = \\left[\\rho_{0}^{\\gamma - 1} - \\frac{(\\gamma - 1) g}{K \\gamma}\\,z\\right]^{\\frac{1}{\\gamma - 1}}\n$$\nThis solution defines a stratified atmosphere with a finite height, $z_s$, where the density and pressure fall to zero. This \"surface\" height is found by setting the term in brackets to zero:\n$$\nz_{s} = \\frac{K \\gamma}{g(\\gamma - 1)}\\,\\rho_{0}^{\\gamma - 1}\n$$\nThe pressure profile is then given by $P(z) = K\\rho(z)^{\\gamma}$. This analytical solution provides the ground truth against which we test our numerical schemes.\n\nThe numerical method employed is a first-order finite-volume scheme on a uniform grid with cell spacing $\\Delta z$. The state variables are represented by their cell averages, $U_i^n \\approx \\frac{1}{\\Delta z}\\int_{z_{i-1/2}}^{z_{i+1/2}} U(z, t_n) dz$. The time evolution of these cell averages is governed by an explicit Euler update:\n$$\nU_i^{n+1} = U_i^n - \\frac{\\Delta t}{\\Delta z}\\left(F_{i+1/2}^n - F_{i-1/2}^n\\right) + \\Delta t\\,S_i^n\n$$\nwhere $\\Delta t$ is the time step, $F_{i+1/2}$ is the numerical flux at the interface between cells $i$ and $i+1$, and $S_i$ is the discretized source term in cell $i$.\n\nThe numerical flux is computed using the local Lax-Friedrichs (Rusanov) scheme. For a first-order reconstruction (piecewise constant data), the state in cell $i$ is $U_i$. The flux between cells $i$ and $i+1$ is:\n$$\nF_{i+1/2} = \\frac{1}{2}\\left(F(U_i) + F(U_{i+1})\\right) - \\frac{\\lambda_{i+1/2}}{2}\\left(U_{i+1} - U_i\\right)\n$$\nHere, $\\lambda_{i+1/2}$ is the maximum local signal speed at the interface, given by $\\lambda_{i+1/2} = \\max(|u_i|+c_i, |u_{i+1}|+c_{i+1})$, where $c = \\sqrt{\\gamma P/\\rho}$ is the sound speed. This flux provides the necessary dissipation to ensure stability.\n\nA crucial aspect of this problem is the discretization of the gravitational source term, $S_i$. We compare two approaches:\n1.  **Splitting A (Naive):** The momentum source term is discretized by a simple cell-centered evaluation: $S_{m,i} = - \\rho_i g$. This approach is simple but fails to respect the discrete balance between the flux gradient and the source term. In hydrostatic equilibrium, small numerical imbalances can generate spurious velocities.\n2.  **Splitting B (Well-Balanced):** The momentum source is discretized to mimic the discrete pressure gradient. For the Rusanov flux in the hydrostatic limit ($u=0$), the momentum flux divergence simplifies to $(P_{i+1}-P_{i-1})/(2\\Delta z)$. A well-balanced source term is designed to exactly cancel this term when the solution is in hydrostatic equilibrium. The chosen discretization is $S_{m,i} = -(P^{\\mathrm{eq}}_{i+1} - P^{\\mathrm{eq}}_{i-1})/(2\\Delta z)$, where $P^{\\mathrm{eq}}$ is the exact analytical pressure at cell centers. When initialized with the exact hydrostatic solution, this ensures that the numerical flux divergence and source term cancel to machine precision, thus preserving the static equilibrium.\n\nThe simulation protocol is as follows:\n- The computational domain is set to $[0, H]$ with $H = 0.9 z_s$, ensuring that density and pressure are strictly positive throughout.\n- The domain is discretized into $N$ cells, with one ghost cell on each boundary to handle boundary conditions.\n- The initial state in all cells (including ghost cells) is set by evaluating the analytical hydrostatic solution at the respective cell centers.\n- The time step $\\Delta t$ is determined by the Courant-Friedrichs-Lewy (CFL) condition, $\\Delta t = \\text{CFL} \\cdot \\Delta z / \\lambda_{\\max}$, where $\\lambda_{\\max}$ is the maximum signal speed over the entire grid.\n- A single time step is performed for each test case.\n- Two diagnostics are computed: the minimum pressure $P_{\\min}$ across the real cells (to check for positivity preservation) and the maximum absolute velocity $\\|u\\|_{\\infty}$ (to measure how well the static equilibrium is maintained).\n\nThe comparison is performed for both splitting methods (A and B) on two different grid resolutions ($N=64$ and $N=128$). This allows us to assess the impact of the source term discretization and mesh refinement on the stability and accuracy of the simulation. We expect Splitting B to yield significantly smaller spurious velocities ($\\|u\\|_{\\infty}$) compared to Splitting A, demonstrating the effectiveness of the well-balanced approach. We also monitor $P_{\\min}$ to ensure that neither scheme violates the physical constraint of positive pressure, especially near the low-density top of the atmosphere.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main solver function that orchestrates the simulation runs and result formatting.\n    \"\"\"\n    \n    # --- Physical and Numerical Constants ---\n    GAMMA = 5.0 / 3.0\n    K = 1.0\n    G = 1.0\n    RHO0 = 1.0\n    ALPHA = 0.9\n    CFL = 0.4\n    \n    # --- Hydrostatic Equilibrium Calculations ---\n    # Surface height zs where rho and P go to zero.\n    zs = (K * GAMMA / (G * (GAMMA - 1))) * RHO0**(GAMMA - 1)\n    # Computational domain height.\n    H = ALPHA * zs\n\n    # --- Test Case Definitions ---\n    # The order is defined by the problem statement.\n    test_cases = [\n        ('A', 64),\n        ('A', 128),\n        ('B', 64),\n        ('B', 128),\n    ]\n\n    results = []\n    for split_type, N in test_cases:\n        p_min, u_max_abs = run_simulation(N, H, split_type, GAMMA, K, G, RHO0, CFL)\n        results.extend([p_min, u_max_abs])\n\n    # --- Final Output Formatting ---\n    formatted_results = [f\"{res:.8e}\" for res in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\ndef hydro_rho(z, rho0, g, K, gamma):\n    \"\"\"\n    Computes the hydrostatic equilibrium density profile rho(z).\n    \n    Derivation:\n    The hydrostatic equilibrium equation is dP/dz = -rho*g.\n    Using the polytropic equation of state P = K*rho^gamma, this becomes:\n    d/dz(K*rho^gamma) = -rho*g\n    K*gamma*rho^(gamma-1) * d(rho)/dz = -rho*g\n    Assuming rho > 0, we separate variables: K*gamma*rho^(gamma-2) * d(rho) = -g*dz.\n    Integrating from z=0 (where rho=rho0) to z gives:\n    K*gamma * [rho^(gamma-1)/(gamma-1)]_rho0^rho = -g * [z']_0^z\n    (K*gamma/(gamma-1))*(rho(z)^(gamma-1) - rho0^(gamma-1)) = -g*z\n    Rearranging for rho(z) gives the formula below.\n    \"\"\"\n    term = rho0**(gamma - 1) - (gamma - 1) * g * z / (K * gamma)\n    # Ensure non-negativity before taking the root, for robustness.\n    return np.maximum(term, 0.0)**(1.0 / (gamma - 1))\n\ndef hydro_P(rho, K, gamma):\n    \"\"\"Computes pressure from density using the polytropic EoS.\"\"\"\n    return K * rho**gamma\n\ndef conservatives_to_primitives(U, gamma):\n    \"\"\"Converts conservative variables [rho, rho*u, E] to primitives [rho, u, P].\"\"\"\n    rho = U[0, :]\n    rho_u = U[1, :]\n    E = U[2, :]\n    \n    # Avoid division by zero, though problem setup should prevent rho=0.\n    u = np.divide(rho_u, rho, out=np.zeros_like(rho), where=rho!=0)\n    \n    P = (gamma - 1) * (E - 0.5 * rho * u**2)\n    return rho, u, P\n\ndef get_flux(U, gamma):\n    \"\"\"Computes the flux vector F(U).\"\"\"\n    rho, u, P = conservatives_to_primitives(U, gamma)\n    E = U[2, :]\n    F = np.zeros_like(U)\n    F[0, :] = rho * u\n    F[1, :] = rho * u**2 + P\n    F[2, :] = u * (E + P)\n    return F\n\ndef run_simulation(N, H, split_type, gamma, K, g, rho0, cfl):\n    \"\"\"\n    Runs a single simulation for a given grid size and source term splitting.\n    \"\"\"\n    # --- Grid Setup ---\n    ng = 1  # Number of ghost cells on each side\n    dz = H / N\n    N_tot = N + 2 * ng\n    \n    # Cell centers, including ghost cells\n    # Indices 1 to N are real cells. 0 and N+1 are ghosts.\n    z_centers = (np.arange(N_tot) - 0.5) * dz\n    \n    # --- Initial Conditions ---\n    U0 = np.zeros((3, N_tot))\n    \n    rho_init = hydro_rho(z_centers, rho0, g, K, gamma)\n    P_init = hydro_P(rho_init, K, gamma)\n    u_init = np.zeros(N_tot)\n    \n    U0[0, :] = rho_init\n    U0[1, :] = rho_init * u_init\n    U0[2, :] = P_init / (gamma - 1) + 0.5 * rho_init * u_init**2\n    \n    # --- Time Step Calculation ---\n    rho, u, P = conservatives_to_primitives(U0, gamma)\n    c = np.sqrt(gamma * P / rho)\n    s_max = np.max(np.abs(u[ng:-ng]) + c[ng:-ng])\n    dt = cfl * dz / s_max\n    \n    # --- Numerical Flux Calculation (Rusanov) ---\n    UL = U0[:, :-1]\n    UR = U0[:, 1:]\n    \n    rho_L, u_L, P_L = conservatives_to_primitives(UL, gamma)\n    rho_R, u_R, P_R = conservatives_to_primitives(UR, gamma)\n    \n    c_L = np.sqrt(gamma * P_L / rho_L)\n    c_R = np.sqrt(gamma * P_R / rho_R)\n    \n    lambda_half = np.maximum(np.abs(u_L) + c_L, np.abs(u_R) + c_R)\n    \n    F_L = get_flux(UL, gamma)\n    F_R = get_flux(UR, gamma)\n    \n    F_half = 0.5 * (F_L + F_R) - 0.5 * lambda_half[np.newaxis, :] * (UR - UL)\n\n    # --- Source Term Discretization ---\n    S = np.zeros_like(U0)\n    rho, u, _ = conservatives_to_primitives(U0, gamma)\n    \n    # Energy source term is common to both splittings\n    S[2, :] = -rho * g * u\n\n    # Momentum source term\n    if split_type == 'A': # Naive splitting\n        S[1, ng:-ng] = -rho[ng:-ng] * g\n    elif split_type == 'B': # Well-balanced splitting\n        P_eq = P_init\n        S[1, ng:-ng] = -(P_eq[ng+1:] - P_eq[:-ng-1]) / (2 * dz)\n\n    # --- State Update (Explicit Euler) ---\n    U1 = np.copy(U0)\n    flux_diff = F_half[:, ng:] - F_half[:, :-ng]\n    \n    U1[:, ng:-ng] = U0[:, ng:-ng] - (dt / dz) * flux_diff + dt * S[:, ng:-ng]\n    \n    # --- Compute Diagnostics ---\n    U_final_real = U1[:, ng:-ng]\n    rho_f, u_f, P_f = conservatives_to_primitives(U_final_real, gamma)\n    \n    p_min = np.min(P_f)\n    u_max_abs = np.max(np.abs(u_f))\n    \n    return p_min, u_max_abs\n\nif __name__ == \"__main__\":\n    solve()\n```"
        },
        {
            "introduction": "Building on the core principles, this final practice addresses a critical and often complex component of hydrodynamic simulations: the boundary conditions. This task involves designing and implementing a boundary treatment for a stratified atmosphere that is simultaneously well-balanced and positivity-preserving . You will handle the distinct cases of inflow and outflow, ensuring that the ghost cell state both maintains hydrostatic equilibrium and prevents the emergence of non-physical negative densities or pressures.",
            "id": "3529762",
            "problem": "You are to design and implement a positivity-preserving and hydrostatic well-balanced boundary condition for the one-dimensional compressible Euler equations with a constant gravitational acceleration in the vertical direction. Consider a uniform grid with spacing $\\Delta x$ and denote by the first interior cell the index $i=1$ (center at $z=\\Delta x/2$) and by the single ghost cell outside the left boundary the index $i=0$ (center at $z=-\\Delta x/2$). Gravity points downward and has magnitude $g>0$. All quantities are non-dimensionalized; no physical units are required.\n\nThe governing equations are the compressible Euler equations with a gravitational source, closed by the ideal-gas Equation of State (EOS),\n- mass: $\\partial_t \\rho + \\partial_z (\\rho u) = 0$,\n- momentum: $\\partial_t (\\rho u) + \\partial_z (\\rho u^2 + p) = -\\rho g$,\n- energy: $\\partial_t E + \\partial_z \\left((E+p)u\\right) = -\\rho g u$,\n- EOS: $p = (\\gamma - 1)\\left(E - \\tfrac{1}{2}\\rho u^2\\right)$,\n\nwhere $\\rho$ is the density, $u$ the vertical velocity, $p$ the pressure, $E$ the total energy density, and $\\gamma>1$ the ratio of specific heats.\n\nHydrostatic equilibrium is defined by $\\partial_z p = -\\rho g$. A locally isothermal hydrostatic continuation over a small distance $\\Delta x$ can be represented using the local scale height $H = p/(\\rho g)$, which is treated as locally constant over that distance. Under this approximation, over a displacement $\\pm \\Delta x$ from the center of cell $i=1$, the hydrostatic continuation satisfies $p \\propto \\exp(-z/H)$ and $\\rho \\propto \\exp(-z/H)$, so both $p$ and $\\rho$ change by the same exponential factor.\n\nYou must construct a left boundary condition that is:\n- positivity-preserving: the ghost-cell state satisfies $\\rho_{0} > 0$, $p_{0} > 0$, and $E_{0} > 0$; and\n- hydrostatic well-balanced at the discrete level when the interior and boundary reservoirs are hydrostatically consistent.\n\nThe construction uses the following principles:\n- Outflow case (flow exits the domain at the left boundary): if the interior velocity is nonnegative, $u_{1} \\ge 0$, use hydrostatic extrapolation from cell $i=1$ into the ghost cell with the interior local scale height $H_{1} = p_{1}/(\\rho_{1} g)$:\n  - $\\rho_{0} = \\rho_{1}\\,\\exp(\\Delta x/H_{1})$,\n  - $p_{0} = p_{1}\\,\\exp(\\Delta x/H_{1})$,\n  - $u_{0} = u_{1}$,\n  and set $E_{0} = p_{0}/(\\gamma-1) + \\tfrac{1}{2}\\rho_{0} u_{0}^2$.\n- Inflow case (flow enters the domain at the left boundary): if $u_{1} < 0$, impose a hydrostatic continuation from a boundary reservoir state specified at the boundary interface $z=0$. Let $(\\rho_{\\mathrm{ref}}, u_{\\mathrm{ref}}, p_{\\mathrm{ref}})$ be the reservoir values at $z=0$ and define $H_{\\mathrm{ref}} = p_{\\mathrm{ref}}/(\\rho_{\\mathrm{ref}} g)$. The ghost-cell center is at $z=-\\Delta x/2$, so set\n  - $\\rho_{0} = \\rho_{\\mathrm{ref}}\\,\\exp(\\Delta x/(2 H_{\\mathrm{ref}}))$,\n  - $p_{0} = p_{\\mathrm{ref}}\\,\\exp(\\Delta x/(2 H_{\\mathrm{ref}}))$,\n  - $u_{0} = u_{\\mathrm{ref}}$,\n  and $E_{0} = p_{0}/(\\gamma-1) + \\tfrac{1}{2}\\rho_{0} u_{0}^2$.\n\nTo test discrete hydrostatic well-balance, use the log-mean discretization of the pressure-gradient/source balance across the interface between cells $i=0$ and $i=1$. Define the log-mean of two positive numbers $a$ and $b$ by\n$$\nL(a,b) = \\begin{cases}\na, & a=b, \\\\[4pt]\n\\dfrac{a-b}{\\ln a - \\ln b}, & a \\ne b.\n\\end{cases}\n$$\nThe discrete residual of hydrostatic balance is\n$$\n\\mathcal{R} = (p_{1} - p_{0}) + g\\,\\Delta x\\,L(\\rho_{1}, \\rho_{0}).\n$$\nFor a locally exponential hydrostatic continuation (constant $H$ over $\\Delta x$), $\\mathcal{R} = 0$ exactly in exact arithmetic.\n\nYour program must, for each test case listed below, construct $(\\rho_{0}, u_{0}, p_{0}, E_{0})$ using the above rule, verify positivity, compute the residual $\\mathcal{R}$, and output two items per test in the following order:\n- a boolean indicating whether all of $\\rho_{0}$, $p_{0}$, and $E_{0}$ are strictly positive; and\n- the absolute value $|\\mathcal{R}|$ as a floating-point number.\n\nThe final output for all tests must be a single line containing a flat list with entries in the order $[\\text{pos}_{1}, |\\mathcal{R}_{1}|, \\text{pos}_{2}, |\\mathcal{R}_{2}|, \\dots]$.\n\nUse the following test suite. In each test, the input data are $(\\gamma, g, \\Delta x, \\rho_{1}, u_{1}, p_{1}, \\rho_{\\mathrm{ref}}, u_{\\mathrm{ref}}, p_{\\mathrm{ref}})$; the reservoir values are used only if $u_{1} < 0$.\n\n- Test $1$ (outflow, hydrostatic extrapolation):\n  - $\\gamma = 1.4$, $g = 0.5$, $\\Delta x = 0.1$,\n  - $\\rho_{1} = 2.0$, $u_{1} = 0.0$, $p_{1} = 1.0$,\n  - $\\rho_{\\mathrm{ref}} = 1.0$, $u_{\\mathrm{ref}} = 0.0$, $p_{\\mathrm{ref}} = 1.0$.\n- Test $2$ (inflow, reservoir consistent with interior hydrostatic):\n  - $\\gamma = 1.4$, $g = 0.5$, $\\Delta x = 0.1$,\n  - $\\rho_{1} = 1.409119593$, $u_{1} = -0.2$, $p_{1} = 0.563647837$,\n  - $\\rho_{\\mathrm{ref}} = 1.5$, $u_{\\mathrm{ref}} = -0.1$, $p_{\\mathrm{ref}} = 0.6$.\n- Test $3$ (inflow, strong mismatch between interior and reservoir):\n  - $\\gamma = 1.4$, $g = 1.0$, $\\Delta x = 0.2$,\n  - $\\rho_{1} = 1.0$, $u_{1} = -1.0$, $p_{1} = 1.0$,\n  - $\\rho_{\\mathrm{ref}} = 0.3$, $u_{\\mathrm{ref}} = -2.0$, $p_{\\mathrm{ref}} = 0.05$.\n- Test $4$ (outflow, small scale height and tiny densities/pressures):\n  - $\\gamma = 1.4$, $g = 1000.0$, $\\Delta x = 0.05$,\n  - $\\rho_{1} = 1.0\\times 10^{-8}$, $u_{1} = 0.1$, $p_{1} = 1.0\\times 10^{-6}$,\n  - $\\rho_{\\mathrm{ref}} = 1.0\\times 10^{-8}$, $u_{\\mathrm{ref}} = 0.0$, $p_{\\mathrm{ref}} = 1.0\\times 10^{-6}$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order $[\\text{pos}_{1}, |\\mathcal{R}_{1}|, \\text{pos}_{2}, |\\mathcal{R}_{2}|, \\text{pos}_{3}, |\\mathcal{R}_{3}|, \\text{pos}_{4}, |\\mathcal{R}_{4}|]$.",
            "solution": "The problem requires the design, implementation, and verification of a positivity-preserving and hydrostatic well-balanced boundary condition for the one-dimensional compressible Euler equations with a constant gravitational acceleration. The context is a finite-volume numerical scheme. We will first articulate the principles behind the specified boundary condition algorithm, then apply it to the four provided test cases to compute the required outputs.\n\nThe governing equations are the Euler equations for a compressible, ideal gas in a gravitational field of constant acceleration $g>0$. The state in a computational cell $i$ is described by the primitive variables of density $\\rho_i$, vertical velocity $u_i$, and pressure $p_i$. The corresponding total energy density is given by the ideal gas equation of state as $E_i = p_i/(\\gamma-1) + \\frac{1}{2}\\rho_i u_i^2$, where $\\gamma>1$ is the ratio of specific heats. The boundary condition's purpose is to define the state $(\\rho_0, u_0, p_0, E_0)$ in a \"ghost\" cell, indexed $i=0$, based on the state of the first interior cell, $i=1$.\n\nThe algorithmic procedure splits into two mutually exclusive cases, determined by the direction of fluid-flow at the boundary, which is indicated by the sign of the velocity $u_1$ in the first interior cell.\n\nCase 1: Outflow ($u_1 \\ge 0$)\nThis case models fluid leaving the computational domain. The ghost cell state is determined by a hydrostatic extrapolation from the interior cell $i=1$. This assumes that the state just outside the domain is a continuous, hydrostatic extension of the state just inside. A local scale height, assumed to be constant over the distance $\\Delta x$ separating the centers of cell $i=1$ and cell $i=0$, is computed as:\n$$ H_1 = \\frac{p_1}{\\rho_1 g} $$\nThe density and pressure in the ghost cell, located at a vertical distance of $-\\Delta x$ relative to cell $1$, are found by following an exponential profile upward (against gravity):\n$$ \\rho_0 = \\rho_1 \\exp\\left(\\frac{\\Delta x}{H_1}\\right) $$\n$$ p_0 = p_1 \\exp\\left(\\frac{\\Delta x}{H_1}\\right) $$\nThe velocity is copied from the interior, consistent with an open or \"zero-gradient\" outflow condition: $u_0 = u_1$. Given that the input states must have $p_1 > 0$ and $\\rho_1 > 0$ for physical relevance, and the exponential function is always positive, the resulting $\\rho_0$ and $p_0$ will also be strictly positive. The ghost cell's total energy is then computed from a rearrangement of the equation of state:\n$$ E_0 = \\frac{p_0}{\\gamma-1} + \\frac{1}{2}\\rho_0 u_0^2 $$\nSince $\\gamma>1$, $p_0 > 0$, and $\\rho_0 > 0$, it is guaranteed that $E_0 > 0$. Therefore, this construction is inherently positivity-preserving.\n\nCase 2: Inflow ($u_1 < 0$)\nThis case models fluid entering the domain. The state of the incoming fluid must be specified. The ghost cell state is determined by a hydrostatic continuation from a given reservoir state $(\\rho_{\\mathrm{ref}}, u_{\\mathrm{ref}}, p_{\\mathrm{ref}})$ defined at the boundary interface, $z=0$. The reservoir's hydrostatic scale height is:\n$$ H_{\\mathrm{ref}} = \\frac{p_{\\mathrm{ref}}}{\\rho_{\\mathrm{ref}} g} $$\nThe ghost cell center is located at $z_0 = -\\Delta x/2$. The density and pressure are extrapolated from the reservoir at $z=0$ to this location:\n$$ \\rho_0 = \\rho_{\\mathrm{ref}} \\exp\\left(\\frac{-\\Delta z}{H_{\\mathrm{ref}}}\\right) = \\rho_{\\mathrm{ref}} \\exp\\left(\\frac{-(- \\Delta x / 2)}{H_{\\mathrm{ref}}}\\right) = \\rho_{\\mathrm{ref}} \\exp\\left(\\frac{\\Delta x}{2 H_{\\mathrm{ref}}}\\right) $$\n$$ p_0 = p_{\\mathrm{ref}} \\exp\\left(\\frac{\\Delta x}{2 H_{\\mathrm{ref}}}\\right) $$\nThe velocity is set to the specified inflow velocity: $u_0 = u_{\\mathrm{ref}}$. The energy $E_0$ is then calculated as in the outflow case. Positivity of $(\\rho_0, p_0, E_0)$ is guaranteed if the specified reservoir state has $\\rho_{\\mathrm{ref}} > 0$ and $p_{\\mathrm{ref}} > 0$.\n\nFor each test case, after computing $(\\rho_0, u_0, p_0, E_0)$, we verify positivity and calculate the discrete hydrostatic balance residual $\\mathcal{R}$. The residual is defined using a specific spatial discretization of the hydrostatic balance equation $\\partial_z p = -\\rho g$ across the interface between cells $0$ and $1$:\n$$ \\mathcal{R} = (p_1 - p_0) + g\\,\\Delta x\\,L(\\rho_1, \\rho_0) $$\nwhere $L(a,b)$ is the logarithmic mean. A \"well-balanced\" numerical scheme is one that can exactly maintain a known steady-state solution of the governing equations. Here, we test if the boundary condition is constructed such that the discrete pressure gradient and gravitational source term cancel each other perfectly when a hydrostatic state is present. This specific form of $\\mathcal{R}$ using the log-mean is designed to be exactly zero for a locally isothermal atmosphere, which is the assumption used in the hydrostatic extrapolation.\n\nWe now apply this procedure to each test case.\n\nTest 1: Outflow. Given $\\gamma = 1.4$, $g = 0.5$, $\\Delta x = 0.1$, $\\rho_1 = 2.0$, $u_1 = 0.0$, $p_1 = 1.0$.\nSince $u_1=0.0 \\ge 0$, we use the outflow rule.\nScale height: $H_1 = p_1 / (\\rho_1 g) = 1.0 / (2.0 \\times 0.5) = 1.0$.\nGhost cell state:\n$\\rho_0 = 2.0 \\exp(0.1 / 1.0) \\approx 2.21034$.\n$p_0 = 1.0 \\exp(0.1 / 1.0) \\approx 1.10517$.\n$u_0 = u_1 = 0.0$.\n$E_0 = p_0/(1.4 - 1.0) + 0.5 \\rho_0 u_0^2 = p_0/0.4 \\approx 2.76293$.\nPositivity: $\\rho_0 > 0$, $p_0 > 0$, $E_0 > 0$. All are true.\nResidual: As shown by direct substitution, the construction of $(\\rho_0, p_0)$ from $(\\rho_1, p_1)$ via the exponential formula and the definition of the residual $\\mathcal{R}$ using the logarithmic mean are designed to yield $\\mathcal{R}=0$ exactly in this situation.\n\nTest 2: Inflow. Given $u_1 = -0.2 < 0$, we use the inflow rule with reservoir values $\\rho_{\\mathrm{ref}} = 1.5$, $u_{\\mathrm{ref}} = -0.1$, $p_{\\mathrm{ref}} = 0.6$. Also $g=0.5$, $\\Delta x=0.1$.\nReservoir scale height: $H_{\\mathrm{ref}} = p_{\\mathrm{ref}} / (\\rho_{\\mathrm{ref}} g) = 0.6 / (1.5 \\times 0.5) = 0.8$.\nGhost cell state:\n$\\rho_0 = 1.5 \\exp(0.1 / (2 \\times 0.8)) = 1.5 \\exp(0.0625) \\approx 1.59604$.\n$p_0 = 0.6 \\exp(0.1 / (2 \\times 0.8)) = 0.6 \\exp(0.0625) \\approx 0.63842$.\n$u_0 = u_{\\mathrm{ref}} = -0.1$.\n$E_0 = p_0/0.4 + 0.5 \\rho_0 u_0^2 \\approx 0.63842/0.4 + 0.5 \\times 1.59604 \\times (-0.1)^2 \\approx 1.60403$.\nPositivity holds. The interior state $(\\rho_1, p_1)$ is given as $(1.409119593, 0.563647837)$. These values correspond to a hydrostatic state consistent with the reservoir, as $p_{\\mathrm{ref}} \\exp(-\\Delta x / (2 H_{\\mathrm{ref}})) = 0.6 \\exp(-0.0625) \\approx 0.563647837 = p_1$, and similarly for the density. Therefore, the states at cell $0$ and cell $1$ lie on the same exponential hydrostatic profile. The residual $\\mathcal{R}$ must, by construction, be zero.\n\nTest 3: Inflow. Given $u_1 = -1.0 < 0$, we use the inflow rule.\nThe interior state $(\\rho_1=1.0, p_1=1.0)$ is not hydrostatically consistent with the reservoir state $(\\rho_{\\mathrm{ref}}=0.3, p_{\\mathrm{ref}}=0.05)$. We expect a non-zero residual $\\mathcal{R}$, as the finite volume at the boundary will see a net force. The ghost cell state is calculated from the reservoir, and since the reservoir values are positive, positivity holds.\n\nTest 4: Outflow. Given $u_1 = 0.1 > 0$, we use the outflow rule. The atmospheric parameters are more extreme, with a large gravity $g=1000.0$ and small pressure, leading to a small scale height, $H_1 = 1.0\\times 10^{-6} / (1.0\\times 10^{-8} \\times 1000.0) = 0.1$. This indicates a strongly stratified atmosphere.\n$\\rho_0 = 10^{-8} \\exp(0.05 / 0.1) = 10^{-8} \\exp(0.5) \\approx 1.6487 \\times 10^{-8}$.\n$p_0 = 10^{-6} \\exp(0.5) \\approx 1.6487 \\times 10^{-6}$.\n$u_0 = 0.1$.\n$E_0$ will be positive. As this is an outflow case using the hydrostatic extrapolation, the construction guarantees that discrete hydrostatic balance is satisfied, and so $\\mathcal{R}$ should be zero (within machine precision).\n\nThe implementation in the final answer will follow these calculations for each test case.",
            "answer": "```python\nimport numpy as np\n\ndef log_mean(a, b):\n    \"\"\"\n    Computes the logarithmic mean of two positive numbers a and b.\n    L(a,b) = (a - b) / (ln(a) - ln(b)) for a != b\n    L(a,a) = a\n    \"\"\"\n    # Use np.isclose for robust floating-point comparison to handle the a == b case.\n    if np.isclose(a, b):\n        return a\n    else:\n        return (a - b) / (np.log(a) - np.log(b))\n\ndef solve():\n    \"\"\"\n    Solves the problem for the given test cases.\n    \"\"\"\n    # Test cases as tuples:\n    # (gamma, g, dx, rho_1, u_1, p_1, rho_ref, u_ref, p_ref)\n    test_cases = [\n        (1.4, 0.5, 0.1, 2.0, 0.0, 1.0, 1.0, 0.0, 1.0),\n        (1.4, 0.5, 0.1, 1.409119593, -0.2, 0.563647837, 1.5, -0.1, 0.6),\n        (1.4, 1.0, 0.2, 1.0, -1.0, 1.0, 0.3, -2.0, 0.05),\n        (1.4, 1000.0, 0.05, 1.0e-8, 0.1, 1.0e-6, 1.0e-8, 0.0, 1.0e-6)\n    ]\n\n    results = []\n\n    for case in test_cases:\n        gamma, g, dx, rho_1, u_1, p_1, rho_ref, u_ref, p_ref = case\n        \n        rho_0, u_0, p_0, E_0 = 0.0, 0.0, 0.0, 0.0\n\n        if u_1 >= 0:  # Outflow case\n            # Hydrostatic extrapolation from cell i=1\n            H_1 = p_1 / (rho_1 * g)\n            exp_factor = np.exp(dx / H_1)\n            rho_0 = rho_1 * exp_factor\n            p_0 = p_1 * exp_factor\n            u_0 = u_1\n            \n        else:  # Inflow case (u_1 < 0)\n            # Hydrostatic continuation from reservoir state at z=0\n            H_ref = p_ref / (rho_ref * g)\n            exp_factor = np.exp(dx / (2.0 * H_ref))\n            rho_0 = rho_ref * exp_factor\n            p_0 = p_ref * exp_factor\n            u_0 = u_ref\n\n        # Calculate energy density for the ghost cell\n        E_0 = p_0 / (gamma - 1.0) + 0.5 * rho_0 * u_0**2\n\n        # 1. Verify positivity of the constructed ghost cell state\n        is_positive = rho_0 > 0 and p_0 > 0 and E_0 > 0\n        results.append(is_positive)\n\n        # 2. Compute the discrete hydrostatic balance residual\n        residual = (p_1 - p_0) + g * dx * log_mean(rho_1, rho_0)\n        results.append(abs(residual))\n\n    # Format the final output as a single string.\n    # str(True) becomes 'True', str(False) becomes 'False'.\n    # This matches the implicit format requirements.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}