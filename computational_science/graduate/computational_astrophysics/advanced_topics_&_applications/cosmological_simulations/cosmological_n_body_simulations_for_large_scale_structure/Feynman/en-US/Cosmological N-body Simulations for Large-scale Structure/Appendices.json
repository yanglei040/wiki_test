{
    "hands_on_practices": [
        {
            "introduction": "Cosmological simulations must start from a state that accurately represents the early universe's small density fluctuations. We use Lagrangian Perturbation Theory (LPT) to generate initial conditions by displacing particles from a uniform grid. This exercise demonstrates how the choice of LPT order and the initial redshift, $z_{\\mathrm{init}}$, is critical for suppressing unphysical \"transient\" modes, ensuring the simulation's subsequent evolution is physically correct. ",
            "id": "3507115",
            "problem": "Consider an irrotational, pressureless cold dark matter fluid evolving under Newtonian gravity in a spatially flat Friedmann–Lemaître–Robertson–Walker (FLRW) background. In Lagrangian Perturbation Theory (LPT), the Eulerian position is written as $\\boldsymbol{x}(\\boldsymbol{q},t) = \\boldsymbol{q} + \\boldsymbol{\\psi}(\\boldsymbol{q},t)$ with $\\boldsymbol{q}$ the Lagrangian coordinate and $\\boldsymbol{\\psi}$ the displacement field. Assume an Einstein–de Sitter (EdS) cosmology with $\\Omega_{\\mathrm{m}} = 1$, $\\Omega_{\\Lambda} = 0$, and scale factor $a(t)$ normalized such that $a(t_0) = 1$ at $z=0$. The first-order LPT (Zel'dovich approximation, ZA) displacement is $\\boldsymbol{\\psi}^{(1)} = - D_{1}(a) \\boldsymbol{\\nabla}\\phi^{(1)}$ where $D_{1}(a)$ is the linear growth factor and $\\phi^{(1)}$ satisfies a Poisson equation with the linear density contrast. The second-order LPT (2LPT) displacement is $\\boldsymbol{\\psi}^{(2)} = D_{2}(a) \\boldsymbol{\\nabla}\\phi^{(2)}$ for a scalar potential $\\phi^{(2)}$.\n\nTask A (derivation): Starting from Newton's second law for a self-gravitating fluid in comoving coordinates, mass conservation, and the assumption of irrotational displacements, derive the governing equation for the second-order LPT scalar potential $\\phi^{(2)}$ in terms of spatial derivatives of the first-order potential $\\phi^{(1)}$. Your derivation must begin with the fundamental laws (continuity and Euler equations in an expanding background and the Poisson equation for the gravitational potential) and produce a Poisson-type equation whose source is quadratic in the Hessian of $\\phi^{(1)}$. You must present the equation for $\\boldsymbol{\\nabla}^{2}\\phi^{(2)}$ explicitly, expressed in terms of second derivatives of $\\phi^{(1)}$, with all mathematical entities in LaTeX.\n\nTask B (time evolution and transients): In the EdS limit, the second-order growth function satisfies a second-order ordinary differential equation driven by the quadratic source from first order. Using only first principles, derive the general solution structure for $D_{2}(a)$ in EdS, showing that it consists of a particular solution proportional to $a^{2}$ plus homogeneous modes proportional to $a$ and $a^{-3/2}$. Impose the following initial-condition prescriptions at an initial redshift $z_{\\mathrm{init}}$ (with $a_{\\mathrm{init}} = 1/(1+z_{\\mathrm{init}})$):\n- For first-order LPT (ZA) initial conditions: set $D_{2}(a_{\\mathrm{init}}) = 0$ and $\\mathrm{d}D_{2}/\\mathrm{d}a\\big|_{a_{\\mathrm{init}}} = 0$.\n- For second-order LPT (2LPT) initial conditions: set $D_{2}(a_{\\mathrm{init}})$ and $\\mathrm{d}D_{2}/\\mathrm{d}a\\big|_{a_{\\mathrm{init}}}$ to their growing-mode values consistent with the EdS particular solution.\n\nSolve for the coefficients of the homogeneous contributions in each case and write down $D_{2}(a)$ evaluated at $a=1$ for both initial-condition choices, explicitly in terms of $a_{\\mathrm{init}}$.\n\nTask C (quantifying transient suppression in the matter power): Define the transient suppression measure $s$ at $z=0$ for a given initial condition prescription as the fractional reduction in the squared second-order growth amplitude relative to the true growing-mode value,\n$$\ns \\equiv 1 - \\left(\\frac{D_{2}^{\\mathrm{IC}}(a=1)}{D_{2}^{\\mathrm{true}}(a=1)}\\right)^{2},\n$$\nwhich is a dimensionless decimal number. Here $D_{2}^{\\mathrm{true}}(a)$ denotes the EdS growing-mode particular solution and $D_{2}^{\\mathrm{IC}}(a)$ is the actual $D_{2}$ produced by the chosen initial conditions when evaluated at $a=1$. This $s$ serves as a proxy for the fractional suppression of the leading one-loop matter power correction that scales as the square of the second-order growth.\n\nCompute $s$ at $z=0$ for both first-order LPT (ZA) and second-order LPT (2LPT) initial conditions, for the following test suite of initial redshifts:\n- Typical case: $z_{\\mathrm{init}} = 99$,\n- Intermediate case: $z_{\\mathrm{init}} = 49$,\n- Boundary low-redshift case: $z_{\\mathrm{init}} = 9$,\n- High-redshift edge case: $z_{\\mathrm{init}} = 199$.\n\nAll outputs are unitless decimal numbers. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. For each test case in the order listed above, output two numbers: first the $s$ for first-order LPT (ZA), then the $s$ for second-order LPT (2LPT). For example, the final output must have the form $\\left[\\ldots\\right]$ containing exactly $8$ floats in the order $\\left[s_{\\mathrm{ZA}}(99), s_{\\mathrm{2LPT}}(99), s_{\\mathrm{ZA}}(49), s_{\\mathrm{2LPT}}(49), s_{\\mathrm{ZA}}(9), s_{\\mathrm{2LPT}}(9), s_{\\mathrm{ZA}}(199), s_{\\mathrm{2LPT}}(199)\\right]$.",
            "solution": "We consider a pressureless, irrotational cold dark matter fluid in a spatially flat Friedmann–Lemaître–Robertson–Walker (FLRW) background described by Newtonian cosmology. The Eulerian position is $\\boldsymbol{x}(\\boldsymbol{q},t) = \\boldsymbol{q} + \\boldsymbol{\\psi}(\\boldsymbol{q},t)$, with Lagrangian coordinate $\\boldsymbol{q}$ and displacement field $\\boldsymbol{\\psi}$. The governing equations are Newton's second law in comoving coordinates, mass conservation, and the Poisson equation for the gravitational potential $\\Phi$:\n$$\n\\frac{\\mathrm{d}^{2}\\boldsymbol{x}}{\\mathrm{d}t^{2}} + 2 H \\frac{\\mathrm{d}\\boldsymbol{x}}{\\mathrm{d}t} = - \\frac{1}{a^{2}} \\boldsymbol{\\nabla}_{x} \\Phi,\n$$\n$$\n\\boldsymbol{\\nabla}_{x}^{2} \\Phi = 4 \\pi G a^{2} \\bar{\\rho} \\, \\delta,\n$$\n$$\n1 + \\delta = \\frac{1}{J}, \\quad J \\equiv \\det\\left(\\frac{\\partial x_{i}}{\\partial q_{j}}\\right) = \\det\\left(\\delta_{ij} + \\frac{\\partial \\psi_{i}}{\\partial q_{j}}\\right),\n$$\nwith $H \\equiv \\dot{a}/a$, $\\bar{\\rho}$ the mean matter density, and $\\delta$ the density contrast.\n\nWe assume irrotationality so that to each order the displacement is potential:\n$$\n\\boldsymbol{\\psi}^{(1)} = - D_{1}(a) \\boldsymbol{\\nabla}\\phi^{(1)}, \\quad \\boldsymbol{\\psi}^{(2)} = D_{2}(a) \\boldsymbol{\\nabla}\\phi^{(2)},\n$$\nwhere $\\phi^{(1)}$ and $\\phi^{(2)}$ are scalar potentials in Lagrangian space, and $D_{1}$, $D_{2}$ are time-dependent growth functions. In Einstein–de Sitter (EdS), the linear growth factor is $D_{1}(a) = a$.\n\nTask A: Derivation of the second-order LPT potential equation. We expand the Jacobian $J$ to second order in the displacement gradient $\\Psi_{ij} \\equiv \\partial \\psi_{i}/\\partial q_{j}$. Using the identity for the determinant,\n$$\nJ = 1 + \\mathrm{Tr}(\\Psi) + \\frac{1}{2}\\left[\\left(\\mathrm{Tr}(\\Psi)\\right)^{2} - \\mathrm{Tr}\\left(\\Psi^{2}\\right)\\right] + \\mathcal{O}(\\Psi^{3}),\n$$\nthe density contrast to second order is\n$$\n\\delta^{(1)} = - \\mathrm{Tr}\\left(\\Psi^{(1)}\\right), \\quad \\delta^{(2)} = - \\mathrm{Tr}\\left(\\Psi^{(2)}\\right) + \\frac{1}{2}\\left[\\left(\\mathrm{Tr}\\left(\\Psi^{(1)}\\right)\\right)^{2} - \\mathrm{Tr}\\left(\\left(\\Psi^{(1)}\\right)^{2}\\right)\\right].\n$$\nWith $\\boldsymbol{\\psi}^{(1)} = - D_{1} \\boldsymbol{\\nabla}\\phi^{(1)}$ and $\\boldsymbol{\\psi}^{(2)} = D_{2} \\boldsymbol{\\nabla}\\phi^{(2)}$, we have\n$$\n\\Psi^{(1)}_{ij} = - D_{1} \\partial_{i}\\partial_{j}\\phi^{(1)}, \\quad \\Psi^{(2)}_{ij} = D_{2} \\partial_{i}\\partial_{j}\\phi^{(2)},\n$$\nso that\n$$\n\\delta^{(1)} = D_{1} \\nabla^{2} \\phi^{(1)}, \\quad \\delta^{(2)} = - D_{2} \\nabla^{2} \\phi^{(2)} + \\frac{D_{1}^{2}}{2}\\left[\\left(\\nabla^{2}\\phi^{(1)}\\right)^{2} - \\sum_{i,j} \\left(\\partial_{i}\\partial_{j}\\phi^{(1)}\\right)^{2}\\right].\n$$\nAt second order, the Euler-Poisson system induces a source term for $\\delta^{(2)}$ that is quadratic in first-order fields. Enforcing mass conservation and consistency with the Euler equation and Poisson equation, the second-order potential $\\phi^{(2)}$ must satisfy a Poisson-type equation whose source cancels the purely quadratic Jacobian terms at the appropriate time dependence. Requiring $\\delta^{(2)}$ to align with the growing mode and matching the spatial dependence yields the standard 2LPT potential equation:\n$$\n\\nabla^{2} \\phi^{(2)} = \\sum_{i>j} \\left[ \\left(\\partial_{i}\\partial_{i} \\phi^{(1)}\\right)\\left(\\partial_{j}\\partial_{j} \\phi^{(1)}\\right) - \\left(\\partial_{i}\\partial_{j} \\phi^{(1)}\\right)^{2} \\right].\n$$\nEquivalently, writing with full indices,\n$$\n\\nabla^{2} \\phi^{(2)} = \\frac{1}{2}\\left[\\left(\\nabla^{2}\\phi^{(1)}\\right)^{2} - \\sum_{i,j} \\left(\\partial_{i}\\partial_{j}\\phi^{(1)}\\right)^{2}\\right],\n$$\nwhich is the well-tested expression used to construct 2LPT initial displacements on a grid.\n\nTask B: Time evolution of $D_{2}(a)$ and transient modes. In EdS, the second-order growth obeys a linear inhomogeneous ordinary differential equation sourced by the quadratic combination of first-order growth. One convenient form in terms of the scale factor is\n$$\n\\frac{\\mathrm{d}^{2} D_{2}}{\\mathrm{d} a^{2}} + \\frac{3}{2a} \\frac{\\mathrm{d} D_{2}}{\\mathrm{d} a} - \\frac{3}{2a^{2}} D_{2} = - \\frac{3}{2a^{2}} D_{1}^{2},\n$$\nwhere the right-hand side comes from the quadratic source term in the Euler-Poisson system and in EdS $D_{1}(a) = a$. The homogeneous equation\n$$\n\\frac{\\mathrm{d}^{2}y}{\\mathrm{d} a^{2}} + \\frac{3}{2a} \\frac{\\mathrm{d} y}{\\mathrm{d} a} - \\frac{3}{2a^{2}} y = 0\n$$\nhas two independent solutions $y_{1}(a) \\propto a$ and $y_{2}(a) \\propto a^{-3/2}$. A particular solution of the inhomogeneous equation is\n$$\nD_{2}^{\\mathrm{part}}(a) = - \\frac{3}{7} a^{2}.\n$$\nThe general solution is therefore\n$$\nD_{2}(a) = - \\frac{3}{7} a^{2} + A a + B a^{-3/2},\n$$\nwith constants $A$ and $B$ set by initial conditions.\n\nFor first-order LPT (ZA) initial conditions, the second-order component is absent initially, which implies\n$$\nD_{2}(a_{\\mathrm{init}}) = 0, \\quad \\left.\\frac{\\mathrm{d}D_{2}}{\\mathrm{d}a}\\right|_{a_{\\mathrm{init}}} = 0.\n$$\nImposing these two conditions gives a linear system for $A$ and $B$:\n$$\n0 = - \\frac{3}{7} a_{\\mathrm{init}}^{2} + A a_{\\mathrm{init}} + B a_{\\mathrm{init}}^{-3/2},\n$$\n$$\n0 = - \\frac{6}{7} a_{\\mathrm{init}} + A - \\frac{3}{2} B a_{\\mathrm{init}}^{-5/2}.\n$$\nSolving,\n$$\nB = - \\frac{6}{35} a_{\\mathrm{init}}^{7/2}, \\quad A = \\frac{3}{5} a_{\\mathrm{init}}.\n$$\nEvaluated at $a=1$,\n$$\nD_{2}^{\\mathrm{ZA}}(1) = - \\frac{3}{7} + \\frac{3}{5} a_{\\mathrm{init}} - \\frac{6}{35} a_{\\mathrm{init}}^{7/2}.\n$$\n\nFor second-order LPT (2LPT) initial conditions, we set the initial second-order displacement and its time derivative to the growing-mode values to eliminate transients:\n$$\nD_{2}(a_{\\mathrm{init}}) = - \\frac{3}{7} a_{\\mathrm{init}}^{2}, \\quad \\left.\\frac{\\mathrm{d}D_{2}}{\\mathrm{d}a}\\right|_{a_{\\mathrm{init}}} = - \\frac{6}{7} a_{\\mathrm{init}}.\n$$\nImposing these yields $A = 0$ and $B = 0$, so\n$$\nD_{2}^{\\mathrm{2LPT}}(a) = - \\frac{3}{7} a^{2}, \\quad D_{2}^{\\mathrm{2LPT}}(1) = - \\frac{3}{7}.\n$$\n\nTask C: Transient suppression measure. We define\n$$\ns \\equiv 1 - \\left(\\frac{D_{2}^{\\mathrm{IC}}(1)}{D_{2}^{\\mathrm{true}}(1)}\\right)^{2},\n$$\nwith $D_{2}^{\\mathrm{true}}(1) = - 3/7$ the EdS growing-mode value at $a=1$. For first-order LPT initial conditions,\n$$\ns_{\\mathrm{ZA}}(z_{\\mathrm{init}}) = 1 - \\left( \\frac{ - \\frac{3}{7} + \\frac{3}{5} a_{\\mathrm{init}} - \\frac{6}{35} a_{\\mathrm{init}}^{7/2} }{ - \\frac{3}{7} } \\right)^{2} = 1 - \\left( 1 - \\frac{ \\frac{3}{5} a_{\\mathrm{init}} - \\frac{6}{35} a_{\\mathrm{init}}^{7/2} }{ \\frac{3}{7} } \\right)^{2}.\n$$\nThis scales as $s_{\\mathrm{ZA}} \\approx \\frac{14}{5} a_{\\mathrm{init}}$ to leading order in $a_{\\mathrm{init}}$ for small $a_{\\mathrm{init}}$, reflecting the well-known $a_{\\mathrm{init}}$ transient scaling in the Zel'dovich approximation. For second-order LPT initial conditions,\n$$\ns_{\\mathrm{2LPT}}(z_{\\mathrm{init}}) = 1 - \\left( \\frac{ - \\frac{3}{7} }{ - \\frac{3}{7} } \\right)^{2} = 0,\n$$\nshowing complete suppression of second-order transients when the growing mode is matched at initialization.\n\nAlgorithmic implementation. The program computes $a_{\\mathrm{init}} = 1/(1+z_{\\mathrm{init}})$ for each test case, evaluates $D_{2}^{\\mathrm{ZA}}(1)$ via the exact expression above, divides by $D_{2}^{\\mathrm{true}}(1) = - 3/7$, squares, and subtracts from $1$ to form $s_{\\mathrm{ZA}}$. For $s_{\\mathrm{2LPT}}$, the value is identically $0$ for all $z_{\\mathrm{init}}$ in the EdS growing-mode matching. The final output aggregates the results in the specified order and format, yielding a single bracketed list of floats without units.\n\nTest suite coverage. The cases $z_{\\mathrm{init}} = 99$ and $z_{\\mathrm{init}} = 49$ test typical initialization choices; $z_{\\mathrm{init}} = 9$ is a boundary low-redshift case with appreciable transients; $z_{\\mathrm{init}} = 199$ is a high-redshift edge case with strongly suppressed transients. All outputs are dimensionless decimals, printed in the order $\\left[s_{\\mathrm{ZA}}(99), s_{\\mathrm{2LPT}}(99), s_{\\mathrm{ZA}}(49), s_{\\mathrm{2LPT}}(49), s_{\\mathrm{ZA}}(9), s_{\\mathrm{2LPT}}(9), s_{\\mathrm{ZA}}(199), s_{\\mathrm{2LPT}}(199)\\right]$ as required.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef suppression_ZA(z_init: float) -> float:\n    \"\"\"\n    Compute the transient suppression measure s for Zel'dovich (1LPT) initial conditions\n    at z=0 in an Einstein–de Sitter universe, given z_init.\n    s = 1 - (D2_wrong(1)/D2_true(1))^2\n    where D2_true(1) = -3/7 and\n    D2_wrong(1) = -3/7 + (3/5)*a_i - (6/35)*a_i^(7/2).\n    \"\"\"\n    a_i = 1.0 / (1.0 + z_init)\n    D2_true = -3.0 / 7.0\n    D2_wrong = (-3.0 / 7.0) + (3.0 / 5.0) * a_i - (6.0 / 35.0) * (a_i ** 3.5)\n    ratio_sq = (D2_wrong / D2_true) ** 2\n    s = 1.0 - ratio_sq\n    return s\n\ndef suppression_2LPT(z_init: float) -> float:\n    \"\"\"\n    Compute the transient suppression measure s for 2LPT initial conditions.\n    In EdS with correct matching, D2_wrong(1) = D2_true(1), hence s = 0.\n    \"\"\"\n    return 0.0\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Order: z_init = 99 (typical), 49 (intermediate), 9 (boundary low), 199 (high edge).\n    test_cases = [99.0, 49.0, 9.0, 199.0]\n\n    results = []\n    for z in test_cases:\n        s_ZA = suppression_ZA(z)\n        s_2LPT = suppression_2LPT(z)\n        # Append in the specified order: ZA then 2LPT for each z_init.\n        results.append(s_ZA)\n        results.append(s_2LPT)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "The computational core of an $N$-body simulation is the gravitational force calculation, a task that naively scales as $O(N^2)$. This practice explores the Barnes-Hut algorithm, an essential method that makes large simulations feasible by approximating the pull of distant particle groups as a single monopole. You will investigate the algorithm's \"opening criterion,\" the rule that balances computational speed against force accuracy, and quantify the errors this vital approximation introduces. ",
            "id": "3507136",
            "problem": "Consider a distant node in a hierarchical tree used by the Barnes–Hut (BH) algorithm, where Barnes–Hut (BH) refers to an approximation technique that replaces a group of particles by a truncated multipole expansion. In Newtonian gravity, an $N$-body system’s gravitational potential at a field point with position vector $\\mathbf{r}$ due to particles at positions $\\mathbf{x}_i$ with masses $m_i$ is computed by summing contributions. For computational stability in cosmological $N$-body simulations, Plummer softening uses a softened potential kernel. Let the gravitational constant be $G=1$ in dimensionless units. Define the Plummer-softened gravitational potential of a point mass $m$ at separation $\\mathbf{y}=\\mathbf{r}-\\mathbf{x}$ as\n$$\n\\Phi(\\mathbf{y}) = -\\frac{m}{\\sqrt{|\\mathbf{y}|^2+\\epsilon^2}},\n$$\nand the corresponding force\n$$\n\\mathbf{F}(\\mathbf{y}) = -m\\,\\frac{\\mathbf{y}}{\\left(|\\mathbf{y}|^2+\\epsilon^2\\right)^{3/2}},\n$$\nwhere $\\epsilon>0$ is the Plummer softening length. In a BH tree, a node containing many particles is approximated by a monopole located at the node’s center-of-mass, with total mass $M=\\sum_i m_i$, and the node is accepted without opening if the opening criterion $s/d\\leq\\theta$ holds, where $s$ is a linear node size, $d$ is the distance from the field point to the node’s center-of-mass, and $\\theta$ is an opening angle parameter.\n\nTask A (derivation): Starting from the multipole expansion for a distant distribution with center-of-mass at the origin, assume the dipole term vanishes and use the leading nonzero quadrupole term to estimate the relative force error incurred when truncating at the monopole for the Plummer-softened kernel. Let the quadrupole tensor be the traceless symmetric tensor\n$$\nQ_{jk}=\\sum_i m_i\\left(3 x_{i,j} x_{i,k} - r_i^2 \\delta_{jk}\\right),\n$$\nwhere $\\mathbf{x}_i=(x_{i,1},x_{i,2},x_{i,3})$, $r_i=|\\mathbf{x}_i|$, and $\\delta_{jk}$ is the Kronecker delta. Let $\\mathbf{n}=\\mathbf{r}/|\\mathbf{r}|$ be the direction from the node to the field point, and define an orientation factor $q_n=\\mathbf{n}^\\top Q\\,\\mathbf{n}$. Derive a bound on the relative force error $|\\Delta \\mathbf{F}|/|\\mathbf{F}|$ of the monopole approximation in terms of $q_n$, $M$, $s$, and the softened effective radius $r_{\\mathrm{eff}}=\\sqrt{d^2+\\epsilon^2}$. Use this bound to obtain a criterion of the form\n$$\n\\frac{s}{r_{\\mathrm{eff}}} \\le \\theta,\n$$\nthat ensures the relative error is below a specified tolerance $0<\\delta<1$. Express the resulting $\\theta$ in terms of $\\delta$ and a dimensionless geometry factor $g$, where $g$ encodes the shape-dependent quadrupole strength relative to $M s^2$. Do not use pre-stated shortcut formulas for multipole error scalings; rather, start from the definitions above and reason to the final bound.\n\nTask B (quantification): Implement a program that, for a given node with specified particle positions and masses, Plummer softening length $\\epsilon$, node size $s$, and field point position $\\mathbf{r}$, computes:\n- The exact Plummer-softened force $\\mathbf{F}_{\\mathrm{exact}}$ by direct summation over particles.\n- The monopole Plummer-softened force $\\mathbf{F}_{\\mathrm{mono}}$ using the node’s center-of-mass and total mass.\n- The dimensionless relative force error $E=\\left|\\mathbf{F}_{\\mathrm{exact}}-\\mathbf{F}_{\\mathrm{mono}}\\right|/\\left|\\mathbf{F}_{\\mathrm{exact}}\\right|$.\n- The acceptance decision $A$ as a boolean using the opening criterion $s/r_{\\mathrm{eff}}\\le\\theta$.\n\nAll outputs must be dimensionless floats or booleans. Angles are not used, so no angle units are required. Use $G=1$ and dimensionless units throughout.\n\nTest suite specification: Your program must evaluate the following five test cases, each defined by a list of particle positions $\\{\\mathbf{x}_i\\}$, equal particle masses $m_i=M/N$ with $M=1$ unless specified otherwise, node size $s$, softening $\\epsilon$, field point $\\mathbf{r}$, and opening angle parameter $\\theta$.\n\n- Case $1$ (happy path, approximately isotropic cube):\n  - Particles at the eight corners of a cube of side $s=1$: $(\\pm 0.5,\\pm 0.5,\\pm 0.5)$ with total mass $M=1$ split equally.\n  - Field point $\\mathbf{r}=(0,0,5)$, softening $\\epsilon=0.1$, node size $s=1$, opening parameter $\\theta=0.5$.\n\n- Case $2$ (boundary case, planar anisotropy aligned with field direction):\n  - Particles along the $x$-axis at $(-0.5,0,0)$, $(-0.33,0,0)$, $(0.33,0,0)$, $(0.5,0,0)$ with $M=1$ split equally.\n  - Field point $\\mathbf{r}=(2,0,0)$, softening $\\epsilon=0.01$, node size $s=1$, opening parameter $\\theta=0.5$.\n\n- Case $3$ (edge case, approximate spherical symmetry reduces quadrupole):\n  - Particles at the six axis points $(\\pm 0.5,0,0)$, $(0,\\pm 0.5,0)$, $(0,0,\\pm 0.5)$ with $M=1$ split equally.\n  - Field point $\\mathbf{r}=(0,0,1.5)$, softening $\\epsilon=0$, node size $s=1$, opening parameter $\\theta=0.5$.\n\n- Case $4$ (large softening reduces error despite large size-to-distance ratio):\n  - Particles at $(0.5,0.25,0)$, $(-0.5,-0.25,0)$, $(0.25,-0.5,0.25)$, $(-0.25,0.5,-0.25)$, $(0,0.5,0.5)$, $(0,-0.5,-0.5)$ with $M=1$ split equally.\n  - Field point $\\mathbf{r}=(0,0,1)$, softening $\\epsilon=1.0$, node size $s=1$, opening parameter $\\theta=0.5$.\n\n- Case $5$ (near-threshold, anisotropic slab orthogonal to field direction):\n  - Particles at $(0,0.5,0.5)$, $(0,-0.5,0.5)$, $(0,0.5,-0.5)$, $(0,-0.5,-0.5)$ with $M=1$ split equally.\n  - Field point $\\mathbf{r}=(0,0,1.2)$, softening $\\epsilon=0$, node size $s=1$, opening parameter $\\theta=0.5$.\n\nFinal output format: Your program should produce a single line of output containing the results for the five test cases as a comma-separated list enclosed in square brackets. Each test case’s result must itself be a two-element list of the form $[E,A]$, where $E$ is the relative force error as a float and $A$ is the acceptance boolean. For example, the program should print a line of the form $[[e_1,a_1],[e_2,a_2],[e_3,a_3],[e_4,a_4],[e_5,a_5]]$, where each $e_k$ is a float and each $a_k$ a boolean.",
            "solution": "The problem is assessed to be valid. It is scientifically grounded in the principles of Newtonian gravity and multipole expansions, specifically as applied to the Barnes-Hut algorithm with Plummer softening in computational astrophysics. The problem is well-posed, providing all necessary definitions, constants, and data for both the theoretical derivation (Task A) and the numerical implementation (Task B). The setup is internally consistent and the tasks are clearly defined.\n\n### Task A: Derivation of the Relative Force Error Bound and Opening Criterion\n\nThe goal is to derive a bound on the relative force error incurred by the monopole approximation in the Barnes-Hut algorithm for a Plummer-softened potential and to use this bound to formulate an opening criterion.\n\nLet the field point be at position $\\mathbf{r}$ and a distribution of particles have masses $m_i$ at positions $\\mathbf{x}_i$. We work in a coordinate system where the origin is the center of mass (CoM) of the particle distribution, so $\\sum_i m_i \\mathbf{x}_i = \\mathbf{0}$. The total mass is $M = \\sum_i m_i$. The force on a test particle of unit mass at $\\mathbf{r}$ due to particle $i$ is given by the Plummer-softened law, with $G=1$:\n$$\n\\mathbf{F}_i(\\mathbf{r}) = -m_i \\frac{\\mathbf{r} - \\mathbf{x}_i}{\\left(|\\mathbf{r} - \\mathbf{x}_i|^2 + \\epsilon^2\\right)^{3/2}}\n$$\nThe exact total force is the sum over all particles: $\\mathbf{F}_{\\mathrm{exact}}(\\mathbf{r}) = \\sum_i \\mathbf{F}_i(\\mathbf{r})$.\nThe monopole approximation replaces the entire distribution with a single particle of mass $M$ at the CoM ($\\mathbf{x}=\\mathbf{0}$). The monopole force is:\n$$\n\\mathbf{F}_{\\mathrm{mono}}(\\mathbf{r}) = -M \\frac{\\mathbf{r}}{\\left(|\\mathbf{r}|^2 + \\epsilon^2\\right)^{3/2}} = -M \\frac{\\mathbf{r}}{r_{\\mathrm{eff}}^3}\n$$\nwhere $d = |\\mathbf{r}|$ is the distance from the CoM to the field point, and $r_{\\mathrm{eff}} = \\sqrt{d^2 + \\epsilon^2}$ is the softened effective distance.\n\nThe error in the force is $\\Delta\\mathbf{F} = \\mathbf{F}_{\\mathrm{exact}} - \\mathbf{F}_{\\mathrm{mono}}$. To estimate this, we perform a Taylor expansion of the force contribution from a single particle, $\\mathbf{F}(\\mathbf{y}) = -m \\mathbf{y} / (|\\mathbf{y}|^2 + \\epsilon^2)^{3/2}$, where $\\mathbf{y} = \\mathbf{r}-\\mathbf{x}_i$. We expand for small $|\\mathbf{x}_i|$ compared to $|\\mathbf{r}|$. Let $\\mathbf{G}(\\mathbf{y}) = -\\mathbf{y}/(|\\mathbf{y}|^2+\\epsilon^2)^{3/2}$ be the force for a unit mass.\n$$\n\\mathbf{F}_{\\mathrm{exact}}(\\mathbf{r}) = \\sum_i m_i \\mathbf{G}(\\mathbf{r}-\\mathbf{x}_i)\n$$\nExpanding $\\mathbf{G}(\\mathbf{r}-\\mathbf{x}_i)$ about $\\mathbf{x}_i=\\mathbf{0}$:\n$$\n\\mathbf{G}(\\mathbf{r}-\\mathbf{x}_i) \\approx \\mathbf{G}(\\mathbf{r}) - \\sum_{j=1}^3 (\\mathbf{x}_i)_j \\frac{\\partial\\mathbf{G}}{\\partial r_j}(\\mathbf{r}) + \\frac{1}{2} \\sum_{j,k=1}^3 (\\mathbf{x}_i)_j (\\mathbf{x}_i)_k \\frac{\\partial^2\\mathbf{G}}{\\partial r_j \\partial r_k}(\\mathbf{r}) + \\mathcal{O}(|\\mathbf{x}_i|^3)\n$$\nSumming over all particles:\n$$\n\\mathbf{F}_{\\mathrm{exact}}(\\mathbf{r}) \\approx \\left(\\sum_i m_i\\right) \\mathbf{G}(\\mathbf{r}) - \\sum_{j=1}^3 \\left(\\sum_i m_i (\\mathbf{x}_i)_j\\right) \\frac{\\partial\\mathbf{G}}{\\partial r_j} + \\frac{1}{2} \\sum_{j,k=1}^3 \\left(\\sum_i m_i (\\mathbf{x}_i)_j (\\mathbf{x}_i)_k\\right) \\frac{\\partial^2\\mathbf{G}}{\\partial r_j \\partial r_k}\n$$\nThe first term is $M\\mathbf{G}(\\mathbf{r}) = \\mathbf{F}_{\\mathrm{mono}}(\\mathbf{r})$. The second term vanishes because the expansion is around the CoM, $\\sum_i m_i \\mathbf{x}_i = \\mathbf{0}$. The leading error term is therefore the quadrupole term:\n$$\n\\Delta\\mathbf{F} \\approx \\frac{1}{2} \\sum_{j,k=1}^3 T_{jk} \\frac{\\partial^2\\mathbf{G}}{\\partial r_j \\partial r_k}\n$$\nwhere $T_{jk} = \\sum_i m_i (\\mathbf{x}_i)_j (\\mathbf{x}_i)_k$ is the moment of inertia tensor. The components of the second derivative of $\\mathbf{G}$ are needed. For a component $p$:\n$$\nG_p(\\mathbf{r}) = -r_p (r_1^2+r_2^2+r_3^2+\\epsilon^2)^{-3/2} = -r_p r_{\\mathrm{eff}}^{-3}\n$$\nThe second partial derivatives are:\n$$\n\\frac{\\partial^2 G_p}{\\partial r_j \\partial r_k} = 3\\frac{\\delta_{pj}r_k + \\delta_{pk}r_j + \\delta_{jk}r_p}{r_{\\mathrm{eff}}^5} - 15\\frac{r_p r_j r_k}{r_{\\mathrm{eff}}^7}\n$$\nSubstituting this into the expression for $\\Delta\\mathbf{F}$:\n$$\n(\\Delta\\mathbf{F})_p \\approx \\frac{1}{2} \\sum_{j,k} T_{jk} \\left( 3\\frac{\\delta_{pj}r_k + \\delta_{pk}r_j + \\delta_{jk}r_p}{r_{\\mathrm{eff}}^5} - 15\\frac{r_p r_j r_k}{r_{\\mathrm{eff}}^7} \\right)\n$$\nUsing the symmetry of $T_{jk}$ and summing over indices, we get:\n$$\n(\\Delta\\mathbf{F})_p \\approx \\frac{3}{r_{\\mathrm{eff}}^5} (T\\mathbf{r})_p + \\frac{3 r_p}{2 r_{\\mathrm{eff}}^5} \\mathrm{Tr}(T) - \\frac{15 r_p}{2 r_{\\mathrm{eff}}^7} (\\mathbf{r}^\\top T \\mathbf{r})\n$$\nwhere $\\mathrm{Tr}(T) = \\sum_k T_{kk} = \\sum_i m_i r_i^2$. In vector form:\n$$\n\\Delta\\mathbf{F} \\approx \\frac{3}{r_{\\mathrm{eff}}^5} T\\mathbf{r} + \\frac{3 (\\mathrm{Tr}(T))}{2 r_{\\mathrm{eff}}^5} \\mathbf{r} - \\frac{15 (\\mathbf{r}^\\top T \\mathbf{r})}{2 r_{\\mathrm{eff}}^7} \\mathbf{r}\n$$\nWe introduce the traceless quadrupole tensor $Q_{jk} = \\sum_i m_i (3(\\mathbf{x}_i)_j (\\mathbf{x}_i)_k - r_i^2 \\delta_{jk})$. It is related to $T_{jk}$ by $T_{jk} = \\frac{1}{3}Q_{jk} + \\frac{1}{3}\\mathrm{Tr}(T)\\delta_{jk}$. Substituting this into the expression for $\\Delta\\mathbf{F}$ and simplifying yields:\n$$\n\\Delta\\mathbf{F} \\approx \\frac{1}{r_{\\mathrm{eff}}^5} Q\\mathbf{r} - \\frac{5}{2r_{\\mathrm{eff}}^7} (\\mathbf{r}^\\top Q \\mathbf{r}) \\mathbf{r} + \\frac{5\\epsilon^2}{2r_{\\mathrm{eff}}^7} \\mathrm{Tr}(T) \\mathbf{r}\n$$\nTo obtain a bound, we use the triangle inequality on $|\\Delta\\mathbf{F}|$ and introduce a dimensionless geometry factor $g$. Let the node size $s$ be a measure of the maximum extent of the particle distribution from the CoM, e.g., $s = \\max_i |\\mathbf{x}_i|$. We can then bound the quadrupole tensor and moment of inertia. Let's define $g$ such that the operator norm of the quadrupole tensor is bounded by $||Q|| \\le g M s^2$. Similarly, $\\mathrm{Tr}(T) = \\sum_i m_i r_i^2 \\le M s^2$. The problem defines $q_n = \\mathbf{n}^\\top Q \\mathbf{n}$ where $\\mathbf{n}=\\mathbf{r}/d$. Then $\\mathbf{r}^\\top Q \\mathbf{r} = d^2 q_n$. The magnitude of $q_n$ is also bounded: $|q_n| \\le ||Q|| \\le gMs^2$.\n$$\n|\\Delta\\mathbf{F}| \\le \\frac{1}{r_{\\mathrm{eff}}^5} |Q\\mathbf{r}| + \\frac{5}{2r_{\\mathrm{eff}}^7} |\\mathbf{r}^\\top Q \\mathbf{r}| |\\mathbf{r}| + \\frac{5\\epsilon^2}{2r_{\\mathrm{eff}}^7} \\mathrm{Tr}(T) |\\mathbf{r}|\n$$\n$$\n|\\Delta\\mathbf{F}| \\lesssim \\frac{g M s^2 d}{r_{\\mathrm{eff}}^5} + \\frac{5(g M s^2 d^2)}{2r_{\\mathrm{eff}}^7} d + \\frac{5\\epsilon^2(M s^2)}{2r_{\\mathrm{eff}}^7} d = g M s^2 \\frac{d}{r_{\\mathrm{eff}}^5} \\left(1 + \\frac{5d^2}{2r_{\\mathrm{eff}}^2} + \\frac{5\\epsilon^2}{2r_{\\mathrm{eff}}^2} \\right)\n$$\nUsing $r_{\\mathrm{eff}}^2 = d^2+\\epsilon^2$:\n$$\n|\\Delta\\mathbf{F}| \\lesssim g M s^2 \\frac{d}{r_{\\mathrm{eff}}^5} \\left(1 + \\frac{5(d^2+\\epsilon^2)}{2r_{\\mathrm{eff}}^2} \\right) = g M s^2 \\frac{d}{r_{\\mathrm{eff}}^5} \\left(1 + \\frac{5}{2} \\right) = \\frac{7}{2} g M s^2 \\frac{d}{r_{\\mathrm{eff}}^5}\n$$\nThe magnitude of the monopole force is $|\\mathbf{F}_{\\mathrm{mono}}| = M d / r_{\\mathrm{eff}}^3$. The relative force error is therefore bounded by:\n$$\n\\frac{|\\Delta\\mathbf{F}|}{|\\mathbf{F}_{\\mathrm{mono}}|} \\lesssim \\frac{\\frac{7}{2} g M s^2 d / r_{\\mathrm{eff}}^5}{M d / r_{\\mathrm{eff}}^3} = \\frac{7}{2} g \\frac{s^2}{r_{\\mathrm{eff}}^2}\n$$\nTo ensure the error is below a tolerance $\\delta$, we require:\n$$\n\\frac{7}{2} g \\left(\\frac{s}{r_{\\mathrm{eff}}}\\right)^2 \\le \\delta \\implies \\frac{s}{r_{\\mathrm{eff}}} \\le \\sqrt{\\frac{2\\delta}{7g}}\n$$\nThis is the desired criterion of the form $s/r_{\\mathrm{eff}} \\le \\theta$, with the opening angle parameter $\\theta$ given by:\n$$\n\\theta(\\delta, g) = \\sqrt{\\frac{2\\delta}{7g}}\n$$\nThis expression relates the opening angle $\\theta$ to the desired accuracy $\\delta$ and the shape of the mass distribution, which is encoded in the dimensionless factor $g$.\n\n### Task B: Numerical Quantification\n\nThe Python program below implements the required calculations for the five test cases. It computes the exact force via direct summation, the monopole force using the center of mass, the relative force error, and the acceptance decision based on the derived criterion $s/r_{\\mathrm{eff}} \\le \\theta$.\n\nFor each test case, the program defines the particle configuration and simulation parameters. It then calculates:\n1.  **Center of Mass**: For a system of $N$ equal-mass particles, $\\mathbf{x}_{\\mathrm{CM}} = \\frac{1}{N}\\sum_i \\mathbf{x}_i$. All provided test cases have distributions where the CoM is at the origin, $\\mathbf{0}$.\n2.  **Exact Force**: $\\mathbf{F}_{\\mathrm{exact}} = \\sum_{i=1}^N -m_i \\frac{\\mathbf{r} - \\mathbf{x}_i}{(|\\mathbf{r} - \\mathbf{x}_i|^2 + \\epsilon^2)^{3/2}}$, where $m_i=M/N$.\n3.  **Monopole Force**: $\\mathbf{F}_{\\mathrm{mono}} = -M \\frac{\\mathbf{r} - \\mathbf{x}_{\\mathrm{CM}}}{(|\\mathbf{r} - \\mathbf{x}_{\\mathrm{CM}}|^2 + \\epsilon^2)^{3/2}}$.\n4.  **Relative Error**: $E = |\\mathbf{F}_{\\mathrm{exact}} - \\mathbf{F}_{\\mathrm{mono}}| / |\\mathbf{F}_{\\mathrm{exact}}|$.\n5.  **Acceptance**: The boolean value $A$ is `True` if $s / \\sqrt{|\\mathbf{r} - \\mathbf{x}_{\\mathrm{CM}}|^2 + \\epsilon^2} \\le \\theta$, and `False` otherwise.\n\nThe results for all five cases are collected and printed in the specified format `[[e1,a1],[e2,a2],...]`.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the computational astrophysics problem for five test cases.\n\n    For each case, it computes:\n    - The exact Plummer-softened gravitational force by direct summation.\n    - The monopole approximation of the force.\n    - The relative error between the exact and monopole forces.\n    - The Barnes-Hut acceptance criterion based on a softened effective radius.\n    \"\"\"\n\n    test_cases = [\n        # Case 1: Happy path, approximately isotropic cube\n        {\n            \"particles\": np.array([\n                [ 0.5,  0.5,  0.5], [-0.5,  0.5,  0.5], [ 0.5, -0.5,  0.5], [-0.5, -0.5,  0.5],\n                [ 0.5,  0.5, -0.5], [-0.5,  0.5, -0.5], [ 0.5, -0.5, -0.5], [-0.5, -0.5, -0.5]\n            ]),\n            \"M\": 1.0, \"s\": 1.0, \"epsilon\": 0.1, \"r_field\": np.array([0.0, 0.0, 5.0]), \"theta\": 0.5\n        },\n        # Case 2: Boundary case, planar anisotropy aligned with field direction\n        {\n            \"particles\": np.array([\n                [-0.5, 0.0, 0.0], [-0.33, 0.0, 0.0], [0.33, 0.0, 0.0], [0.5, 0.0, 0.0]\n            ]),\n            \"M\": 1.0, \"s\": 1.0, \"epsilon\": 0.01, \"r_field\": np.array([2.0, 0.0, 0.0]), \"theta\": 0.5\n        },\n        # Case 3: Edge case, approximate spherical symmetry reduces quadrupole\n        {\n            \"particles\": np.array([\n                [ 0.5,  0.0,  0.0], [-0.5,  0.0,  0.0], [ 0.0,  0.5,  0.0],\n                [ 0.0, -0.5,  0.0], [ 0.0,  0.0,  0.5], [ 0.0,  0.0, -0.5]\n            ]),\n            \"M\": 1.0, \"s\": 1.0, \"epsilon\": 0.0, \"r_field\": np.array([0.0, 0.0, 1.5]), \"theta\": 0.5\n        },\n        # Case 4: Large softening reduces error despite large size-to-distance ratio\n        {\n            \"particles\": np.array([\n                [ 0.5,   0.25,  0.0 ], [-0.5,  -0.25,  0.0 ], [ 0.25, -0.5,   0.25],\n                [-0.25,  0.5,  -0.25], [ 0.0,   0.5,   0.5 ], [ 0.0,  -0.5,  -0.5 ]\n            ]),\n            \"M\": 1.0, \"s\": 1.0, \"epsilon\": 1.0, \"r_field\": np.array([0.0, 0.0, 1.0]), \"theta\": 0.5\n        },\n        # Case 5: Near-threshold, anisotropic slab orthogonal to field direction\n        {\n            \"particles\": np.array([\n                [0.0,  0.5,  0.5], [0.0, -0.5,  0.5], [0.0,  0.5, -0.5], [0.0, -0.5, -0.5]\n            ]),\n            \"M\": 1.0, \"s\": 1.0, \"epsilon\": 0.0, \"r_field\": np.array([0.0, 0.0, 1.2]), \"theta\": 0.5\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        particles = case[\"particles\"]\n        M = case[\"M\"]\n        s = case[\"s\"]\n        epsilon = case[\"epsilon\"]\n        r_field = case[\"r_field\"]\n        theta = case[\"theta\"]\n\n        N = len(particles)\n        m_i = M / N\n\n        # Calculate Center of Mass (CoM)\n        # For equal masses, CoM is the mean of particle positions.\n        x_cm = np.mean(particles, axis=0)\n\n        # Calculate exact force by direct summation\n        F_exact = np.zeros(3)\n        for x_i in particles:\n            y_i = r_field - x_i\n            mag_y_sq = np.dot(y_i, y_i)\n            # F_i = -m_i * y_i / (mag_y_sq + epsilon^2)^(3/2)\n            denominator = (mag_y_sq + epsilon**2)**1.5\n            if denominator > 0:\n                F_exact += -m_i * y_i / denominator\n\n        # Calculate monopole force\n        d_vec = r_field - x_cm\n        d_sq = np.dot(d_vec, d_vec)\n        # F_mono = -M * d_vec / (d_sq + epsilon^2)^(3/2)\n        F_mono_denominator = (d_sq + epsilon**2)**1.5\n        F_mono = -M * d_vec / F_mono_denominator if F_mono_denominator > 0 else np.zeros(3)\n\n        # Calculate relative force error E\n        delta_F = F_exact - F_mono\n        mag_delta_F = np.linalg.norm(delta_F)\n        mag_F_exact = np.linalg.norm(F_exact)\n        \n        # Handle case where exact force is zero to avoid division by zero\n        E = mag_delta_F / mag_F_exact if mag_F_exact != 0 else 0.0\n\n        # Calculate acceptance decision A\n        d = np.sqrt(d_sq)\n        r_eff = np.sqrt(d**2 + epsilon**2)\n        A = (s / r_eff) <= theta if r_eff > 0 else False\n        \n        results.append([E, A])\n\n    # Format the results into the required string format\n    result_str = \"[\" + \",\".join([f\"[{e:.6g},{a}]\" for e, a in results]) + \"]\"\n    print(result_str)\n\nsolve()\n```"
        },
        {
            "introduction": "Although dark matter is considered collisionless, our use of discrete particles in simulations introduces artificial two-body encounters. This numerical artifact, known as two-body relaxation, can spuriously heat the dense centers of halos and disrupt fragile subhalos, compromising the physical realism of the results. By estimating the relaxation timescale for a realistic halo, this exercise provides a critical tool for simulation design, guiding the choice of parameters like particle mass $m_p$ and softening length $\\epsilon$ to ensure the simulation is physically trustworthy. ",
            "id": "3507095",
            "problem": "You are given a directive to quantify spurious two-body relaxation in cosmological $N$-body simulations by measuring halo core heating as a function of particle mass $m_p$ and gravitational softening length $\\epsilon$, estimate the relaxation time $t_r$, and calibrate a safe regime for subhalo survival statistics. Construct a complete, runnable program that implements a physically principled estimator of $t_r$ for a spherically symmetric halo modeled by the Navarro–Frenk–White (NFW) profile (Navarro–Frenk–White (NFW)), starting from fundamental laws and core definitions, without relying on any precomputed data.\n\nThe fundamental base to use is:\n- Newtonian gravity: acceleration follows from the gravitational potential, and the two-body deflection angle in the small-angle regime scales as $\\theta \\propto G m_p / (b v^2)$ for impact parameter $b$ and relative speed $v$, where $G$ is the gravitational constant.\n- The virial theorem for a relaxed halo: kinetic energy and potential energy satisfy $2K + U = 0$, and an order-of-magnitude estimate for the one-dimensional velocity dispersion at radius $r$ may be related to the circular velocity by $\\sigma^2 \\approx V_c^2 / 2$ with $V_c^2(r) = G M(r) / r$.\n- The critical density of the Universe at redshift $z=0$ for a flat $\\Lambda$ cold dark matter cosmology is $\\rho_{\\mathrm{crit}} = 3 H_0^2 / (8\\pi G)$, where $H_0$ is the Hubble constant.\n- The NFW halo profile is defined by $\\rho(r) = \\rho_s \\left[(r/r_s)\\left(1+r/r_s\\right)^2\\right]^{-1}$, with scale radius $r_s = r_{200}/c$, virial radius $r_{200} = \\left(3 M_{200}/[4\\pi \\cdot 200 \\cdot \\rho_{\\mathrm{crit}}]\\right)^{1/3}$, and scale density $\\rho_s$ fixed by $M_{200} = 4\\pi \\rho_s r_s^3 \\left[\\ln(1+c) - c/(1+c)\\right]$.\n\nYour program must:\n1. For each test case, compute the core properties at a specified core radius $r_c$: the local density $\\rho(r_c)$ and the velocity dispersion $\\sigma(r_c)$ using the above definitions and the virial relation $\\sigma^2 \\approx V_c^2/2$.\n2. Estimate the two-body relaxation time $t_r$ using a small-angle scattering diffusion picture. Treat the Coulomb logarithm as $\\ln \\Lambda = \\ln\\left(b_{\\max}/b_{\\min}\\right)$, with $b_{\\max} = r_c$ and $b_{\\min} = \\max\\left(\\epsilon, b_{90}\\right)$, where $b_{90} = G m_p / \\sigma^2$ is the impact parameter for a $90^\\circ$ deflection. If $b_{\\min} \\ge b_{\\max}$, set $\\ln \\Lambda$ to a small positive floor value $10^{-3}$ to avoid singular behavior, and interpret that regime as effectively collisionless at $r_c$. Use a well-tested estimator for the relaxation time in an approximately Maxwellian system, $t_r \\approx C \\, \\sigma^3 / \\left(G^2 \\, m_p \\, \\rho \\, \\ln \\Lambda\\right)$, where $C$ is an order-unity constant from diffusion theory.\n3. Compute the local mean inter-particle spacing $l = \\left(m_p/\\rho\\right)^{1/3}$ at $r_c$, and calibrate a simple “safe regime” criterion for subhalo survival statistics that flags a case as safe if both $t_r \\ge \\alpha \\, t_H$ and $\\beta_1 \\, l \\le \\epsilon \\le \\beta_2 \\, l$, where $t_H = 1/H_0$ is the Hubble time, and $\\alpha$, $\\beta_1$, $\\beta_2$ are fixed numerical thresholds you choose to reflect conservative practice.\n4. Express the relaxation time $t_r$ in gigayears (Gyr), rounded as floating-point values, and the safe regime indicator as a boolean.\n\nAdopt the following constants and units within the program:\n- $G = 6.67430 \\times 10^{-11}\\,\\mathrm{m^3\\,kg^{-1}\\,s^{-2}}$,\n- $H_0 = 70\\,\\mathrm{km\\,s^{-1}\\,Mpc^{-1}}$,\n- Solar mass $M_\\odot = 1.98847 \\times 10^{30}\\,\\mathrm{kg}$,\n- $1\\,\\mathrm{kpc} = 3.085677581491367 \\times 10^{19}\\,\\mathrm{m}$,\n- $1\\,\\mathrm{Mpc} = 3.085677581491367 \\times 10^{22}\\,\\mathrm{m}$.\n\nUse the coefficient $C = 0.34$ in the relaxation time estimator as a widely accepted value for an isotropic Maxwellian distribution. Set conservative thresholds $\\alpha = 3$, $\\beta_1 = 0.2$, and $\\beta_2 = 1.0$.\n\nTest suite:\nProvide results for the following five test cases, all at $z=0$, with the indicated parameters. Masses should be interpreted in $M_\\odot$, radii and softening in $\\mathrm{kpc}$.\n- Case $1$: $M_{200} = 10^{12}\\,M_\\odot$, $c = 10$, $r_c = 1.0\\,\\mathrm{kpc}$, $m_p = 10^{6}\\,M_\\odot$, $\\epsilon = 0.2\\,\\mathrm{kpc}$.\n- Case $2$: $M_{200} = 10^{12}\\,M_\\odot$, $c = 10$, $r_c = 1.0\\,\\mathrm{kpc}$, $m_p = 10^{8}\\,M_\\odot$, $\\epsilon = 0.5\\,\\mathrm{kpc}$.\n- Case $3$: $M_{200} = 10^{12}\\,M_\\odot$, $c = 10$, $r_c = 1.0\\,\\mathrm{kpc}$, $m_p = 10^{6}\\,M_\\odot$, $\\epsilon = 5.0\\,\\mathrm{kpc}$.\n- Case $4$: $M_{200} = 10^{10}\\,M_\\odot$, $c = 15$, $r_c = 0.5\\,\\mathrm{kpc}$, $m_p = 10^{6}\\,M_\\odot$, $\\epsilon = 0.05\\,\\mathrm{kpc}$.\n- Case $5$: $M_{200} = 10^{12}\\,M_\\odot$, $c = 8$, $r_c = 2.0\\,\\mathrm{kpc}$, $m_p = 10^{4}\\,M_\\odot$, $\\epsilon = 0.05\\,\\mathrm{kpc}$.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each element corresponds to one test case and is itself a two-element list $[t_r, \\mathrm{safe}]$ with $t_r$ in $\\mathrm{Gyr}$ and $\\mathrm{safe}$ a boolean. For example, the output must look like $[[t_{r,1},safe_1],[t_{r,2},safe_2],\\dots]$, with no extra text.",
            "solution": "The problem statement is valid. It is scientifically grounded in the established principles of cosmology and stellar dynamics, specifically concerning the modeling of dark matter halos with the Navarro–Frenk–White (NFW) profile and the analysis of two-body relaxation, a known numerical artifact in $N$-body simulations. The problem provides a complete set of equations, constants, and parameters, making it well-posed and self-contained. The language is objective and the task is computationally feasible. Therefore, a complete solution is warranted.\n\nThe solution is constructed by following a sequence of physically-motivated steps, starting from the fundamental cosmological parameters and halo definitions to derive the desired quantities: the two-body relaxation time $t_r$ and a boolean indicator for a \"safe\" simulation regime. All calculations are performed in SI units for internal consistency, with inputs and outputs converted as specified.\n\nFirst, we establish the necessary physical constants and conversion factors. The gravitational constant is $G$. The Hubble constant is $H_0 = 70\\,\\mathrm{km\\,s^{-1}\\,Mpc^{-1}}$. The critical density of the Universe at redshift $z=0$ is given by $\\rho_{\\mathrm{crit}} = 3 H_0^2 / (8\\pi G)$. All input parameters provided in cosmological units (e.g., solar mass $M_\\odot$, kiloparsec $\\mathrm{kpc}$) are converted to their SI equivalents (kilogram $\\mathrm{kg}$, meter $\\mathrm{m}$) for calculations. The Hubble time, which sets the cosmological timescale for evolution, is $t_H = 1/H_0$.\n\nThe core of the model is the NFW profile for a dark matter halo, which describes its density distribution $\\rho(r)$ as a function of radius $r$:\n$$\n\\rho(r) = \\frac{\\rho_s}{\\left(\\frac{r}{r_s}\\right)\\left(1+\\frac{r}{r_s}\\right)^2}\n$$\nHere, $r_s$ is the scale radius and $\\rho_s$ is the scale density. These two parameters are determined by the halo's total mass $M_{200}$ and concentration $c$. $M_{200}$ is the mass enclosed within the virial radius $r_{200}$, inside which the mean density is $200$ times the critical density $\\rho_{\\mathrm{crit}}$. The virial radius is thus calculated as:\n$$\nr_{200} = \\left(\\frac{3 M_{200}}{4\\pi \\cdot 200 \\cdot \\rho_{\\mathrm{crit}}}\\right)^{1/3}\n$$\nThe scale radius is related to the virial radius by the concentration parameter, $r_s = r_{200}/c$. The scale density $\\rho_s$ is then found by integrating the density profile to obtain the total mass $M_{200}$:\n$$\nM_{200} = \\int_0^{r_{200}} 4\\pi r^2 \\rho(r) dr = 4\\pi \\rho_s r_s^3 \\left[\\ln(1+c) - \\frac{c}{1+c}\\right]\n$$\nThis equation is rearranged to solve for $\\rho_s$ for each test case.\n\nWith the NFW profile fully specified, we proceed to calculate the local physical conditions at the designated core radius, $r_c$. The local density $\\rho(r_c)$ is computed by directly evaluating the NFW density formula at $r=r_c$. To find the local velocity dispersion $\\sigma(r_c)$, we first need the mass enclosed within $r_c$, denoted $M(r_c)$. This is obtained by integrating the density profile from $r=0$ to $r_c$:\n$$\nM(r_c) = 4\\pi \\rho_s r_s^3 \\left[\\ln\\left(1+\\frac{r_c}{r_s}\\right) - \\frac{r_c/r_s}{1+r_c/r_s}\\right]\n$$\nThe circular velocity at this radius is $V_c^2(r_c) = G M(r_c) / r_c$. Using the virial theorem-based approximation for a relaxed, isotropic system, the one-dimensional velocity dispersion $\\sigma(r_c)$ is estimated as $\\sigma^2(r_c) \\approx V_c^2(r_c) / 2$. This gives:\n$$\n\\sigma(r_c) = \\sqrt{\\frac{G M(r_c)}{2 r_c}}\n$$\n\nThe central calculation is that of the two-body relaxation time, $t_r$. This time scale characterizes the rate at which a particle's trajectory is significantly deflected by cumulative small-angle gravitational scatterings from other particles. For a system of particles with mass $m_p$ in a region with local density $\\rho(r_c)$ and velocity dispersion $\\sigma(r_c)$, the relaxation time is given by the standard formula:\n$$\nt_r \\approx \\frac{C \\, \\sigma(r_c)^3}{G^2 \\, m_p \\, \\rho(r_c) \\, \\ln \\Lambda}\n$$\nwhere $C=0.34$ is a coefficient appropriate for a Maxwellian distribution of velocities. The term $\\ln \\Lambda$ is the Coulomb logarithm, which accounts for the range of impact parameters contributing to relaxation. It is defined as $\\ln \\Lambda = \\ln(b_{\\max}/b_{\\min})$. For this problem, the maximum impact parameter, $b_{\\max}$, is taken to be the characteristic scale of the region, so $b_{\\max} = r_c$. The minimum impact parameter, $b_{\\min}$, is the larger of the simulation's gravitational softening length $\\epsilon$ and the impact parameter $b_{90}$ that would cause a $90^\\circ$ deflection in a single two-body encounter. This is given by $b_{90} = G m_p / \\sigma^2(r_c)$. Thus, $b_{\\min} = \\max(\\epsilon, b_{90})$. The use of $\\epsilon$ reflects that gravitational forces are artificially softened at small separations in simulations. If $b_{\\min} \\ge b_{\\max}$, it implies that strong deflections are suppressed over the entire scale of interest, rendering the system effectively collisionless. In this case, $\\ln \\Lambda$ is set to a small positive floor value, $10^{-3}$, to prevent a singularity and reflect a very long relaxation time.\n\nFinally, we assess whether the simulation setup is in a \"safe regime\" for preserving fragile structures like subhalos, which can be artificially destroyed by spurious relaxation. This is judged by two criteria:\n1.  The relaxation time $t_r$ must be significantly longer than the age of the Universe, $t_H$. A conservative threshold is chosen: $t_r \\ge \\alpha \\, t_H$, with $\\alpha=3$.\n2.  The gravitational softening length $\\epsilon$ must be appropriately chosen relative to the mean inter-particle spacing at the core, $l = (m_p/\\rho(r_c))^{1/3}$. If $\\epsilon$ is too small, large-angle scatterings become frequent, enhancing relaxation. If $\\epsilon$ is too large, it smooths over real physical structures. A practical compromise is to require $\\beta_1 \\, l \\le \\epsilon \\le \\beta_2 \\, l$, with thresholds $\\beta_1 = 0.2$ and $\\beta_2 = 1.0$.\n\nA simulation is flagged as \"safe\" (boolean `True`) only if both of these conditions are met. The calculated relaxation time $t_r$ is converted into gigayears (Gyr) for the final output. This entire procedure is encapsulated in a Python program that processes each test case and formats the results as specified.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the relaxation time calculation for all test cases.\n    \"\"\"\n\n    # Physical constants in SI units\n    G_SI = 6.67430e-11  # m^3 kg^-1 s^-2\n    M_SUN_KG = 1.98847e30  # kg\n    KPC_M = 3.085677581491367e19  # m\n    MPC_M = 3.085677581491367e22  # m\n    H0_RAW = 70.0  # km s^-1 Mpc^-1\n    H0_SI = H0_RAW * 1000.0 / MPC_M  # s^-1\n    GYR_S = 1e9 * 365.25 * 24 * 3600  # seconds in a gigayear\n\n    # Problem-specific parameters\n    C_RELAX = 0.34\n    ALPHA_T = 3.0\n    BETA1_EPS = 0.2\n    BETA2_EPS = 1.0\n    LN_LAMBDA_FLOOR = 1e-3\n\n    # Test suite from the problem statement\n    # Format: (M200 [M_sun], c, r_c [kpc], m_p [M_sun], epsilon [kpc])\n    test_cases = [\n        (1e12, 10, 1.0, 1e6, 0.2),\n        (1e12, 10, 1.0, 1e8, 0.5),\n        (1e12, 10, 1.0, 1e6, 5.0),\n        (1e10, 15, 0.5, 1e6, 0.05),\n        (1e12, 8, 2.0, 1e4, 0.05),\n    ]\n\n    results = []\n    for case in test_cases:\n        m200_msun, c, rc_kpc, mp_msun, eps_kpc = case\n        result = calculate_relaxation_properties(\n            m200_msun, c, rc_kpc, mp_msun, eps_kpc,\n            G_SI, M_SUN_KG, KPC_M, H0_SI, GYR_S,\n            C_RELAX, ALPHA_T, BETA1_EPS, BETA2_EPS, LN_LAMBDA_FLOOR\n        )\n        results.append(result)\n\n    # Format the output string to match the required format precisely\n    formatted_results = [f\"[{res[0]},{str(res[1]).lower()}]\" for res in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\ndef calculate_relaxation_properties(m200_msun, c, rc_kpc, mp_msun, eps_kpc,\n                                    g_si, m_sun_kg, kpc_m, h0_si, gyr_s,\n                                    c_relax, alpha_t, beta1_eps, beta2_eps,\n                                    ln_lambda_floor):\n    \"\"\"\n    Calculates the relaxation time and safe regime status for a single case.\n    \"\"\"\n    # 1. Convert all inputs to SI units\n    m200 = m200_msun * m_sun_kg\n    rc = rc_kpc * kpc_m\n    mp = mp_msun * m_sun_kg\n    epsilon = eps_kpc * kpc_m\n\n    # 2. Calculate NFW halo structural parameters\n    rho_crit = (3.0 * h0_si**2) / (8.0 * np.pi * g_si)\n    r200 = ((3.0 * m200) / (4.0 * np.pi * 200.0 * rho_crit))**(1.0/3.0)\n    rs = r200 / c\n\n    def nfw_mass_function(x):\n        return np.log(1.0 + x) - x / (1.0 + x)\n\n    m200_integrated_term = nfw_mass_function(c)\n    rho_s = m200 / (4.0 * np.pi * rs**3 * m200_integrated_term)\n\n    # 3. Calculate local properties at the core radius r_c\n    x_c = rc / rs\n    rho_rc = rho_s / (x_c * (1.0 + x_c)**2)\n    \n    m_rc = 4.0 * np.pi * rho_s * rs**3 * nfw_mass_function(x_c)\n    \n    sigma_sq = (g_si * m_rc) / (2.0 * rc)\n    if sigma_sq <= 0: # a safety check, though physically unlikely for r_c > 0\n        return [float('inf'), False]\n    sigma = np.sqrt(sigma_sq)\n\n    # 4. Estimate the two-body relaxation time t_r\n    b90 = (g_si * mp) / sigma_sq\n    b_min = max(epsilon, b90)\n    b_max = rc\n\n    if b_min >= b_max:\n        ln_Lambda = ln_lambda_floor\n    else:\n        ln_Lambda = np.log(b_max / b_min)\n\n    # Avoid division by zero if ln_Lambda is non-positive\n    if ln_Lambda <= 0:\n        tr_s = float('inf')\n    else:\n        tr_s = (c_relax * sigma**3) / (g_si**2 * mp * rho_rc * ln_Lambda)\n    \n    tr_gyr = tr_s / gyr_s\n\n    # 5. Calibrate the \"safe regime\"\n    tH_s = 1.0 / h0_si\n    \n    # Condition 1: Relaxation time vs Hubble time\n    cond1_safe = tr_s >= alpha_t * tH_s\n\n    # Condition 2: Softening vs inter-particle spacing\n    l = (mp / rho_rc)**(1.0/3.0)\n    cond2_safe = (beta1_eps * l <= epsilon) and (epsilon <= beta2_eps * l)\n\n    is_safe = cond1_safe and cond2_safe\n\n    return [tr_gyr, is_safe]\n\nsolve()\n```"
        }
    ]
}