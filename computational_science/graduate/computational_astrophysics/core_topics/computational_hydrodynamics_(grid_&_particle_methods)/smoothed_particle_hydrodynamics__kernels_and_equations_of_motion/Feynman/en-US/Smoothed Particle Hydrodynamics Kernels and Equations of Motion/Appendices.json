{
    "hands_on_practices": [
        {
            "introduction": "The smoothing kernel is the heart of the SPH method, acting as a weighted interpolation function. For the SPH formalism to be mathematically consistent and conserve quantities like mass, the kernel must integrate to unity over all space, forming a \"partition of unity.\" This foundational exercise  provides direct, hands-on practice in verifying this property by deriving the normalization constant for the widely-used cubic spline kernel from first principles.",
            "id": "3534778",
            "problem": "In three-dimensional smoothed particle hydrodynamics (SPH), the smoothing kernel $W(\\mathbf{r},h)$ is required to be non-negative, compactly supported, radially symmetric, and normalized so that the volume integral over all space satisfies $\\int W(\\mathbf{r},h)\\,d^{3}\\mathbf{r}=1$. Consider the widely used cubic spline (also called $M_{4}$) kernel with support radius $2h$, which is defined in terms of the dimensionless radius $q=r/h$ as\n$$\nW(r,h)=\\sigma\\,h^{-3}\\,f(q),\\quad q=\\frac{r}{h},\n$$\nwith the piecewise function\n$$\nf(q)=\\begin{cases}\n1-\\frac{3}{2}q^{2}+\\frac{3}{4}q^{3},  0\\le q1,\\\\[6pt]\n\\frac{1}{4}(2-q)^{3},  1\\le q2,\\\\[6pt]\n0,  q\\ge 2.\n\\end{cases}\n$$\nStarting from the normalization requirement and appropriate three-dimensional volume integration, derive the normalization constant $\\sigma$ that ensures $\\int W(\\mathbf{r},h)\\,d^{3}\\mathbf{r}=1$. Your derivation should use only fundamental principles (radial symmetry, change of variables, and the normalization condition) and must explicitly carry out all necessary integrals. Verify explicitly that the resulting kernel satisfies the normalization condition for arbitrary smoothing length $h$. Provide your final answer for $\\sigma$ as a closed-form analytic expression. No numerical approximation is required, and no rounding is needed.",
            "solution": "The normalization condition for a spherically symmetric kernel in three dimensions is\n$$\n\\int_{\\mathbb{R}^{3}} W(\\mathbf{r},h)\\,d^{3}\\mathbf{r} \\;=\\; 4\\pi\\int_{0}^{\\infty} W(r,h)\\,r^{2}\\,dr \\;=\\; 1.\n$$\nGiven that $W(r,h)=\\sigma\\,h^{-3}\\,f(q)$ with $q=r/h$ and that $f(q)=0$ for $q\\ge 2$, the radial integral has compact support and becomes\n$$\n4\\pi\\int_{0}^{2h} \\sigma\\,h^{-3}\\,f\\!\\left(\\frac{r}{h}\\right)\\,r^{2}\\,dr.\n$$\nIntroduce the change of variables $q=r/h$, so that $r=hq$ and $dr=h\\,dq$. Then $r^{2}=h^{2}q^{2}$, and the integral transforms to\n$$\n4\\pi\\int_{0}^{2} \\sigma\\,h^{-3}\\,f(q)\\,(h^{2}q^{2})\\,(h\\,dq)\n\\;=\\;\n4\\pi\\,\\sigma\\int_{0}^{2} f(q)\\,q^{2}\\,dq.\n$$\nHence the normalization condition reduces to\n$$\n4\\pi\\,\\sigma\\int_{0}^{2} f(q)\\,q^{2}\\,dq \\;=\\; 1,\n$$\nso that\n$$\n\\sigma \\;=\\; \\frac{1}{4\\pi}\\left[\\int_{0}^{2} f(q)\\,q^{2}\\,dq\\right]^{-1}.\n$$\nWe now compute the integral $I=\\int_{0}^{2} f(q)\\,q^{2}\\,dq$ by splitting it at $q=1$:\n$$\nI \\;=\\; \\int_{0}^{1} \\left(1-\\frac{3}{2}q^{2}+\\frac{3}{4}q^{3}\\right)q^{2}\\,dq\n\\;+\\;\n\\int_{1}^{2} \\frac{1}{4}(2-q)^{3} q^{2}\\,dq.\n$$\nCompute the first integral $I_{1}$:\n$$\nI_{1} \\;=\\; \\int_{0}^{1}\\left(q^{2}-\\frac{3}{2}q^{4}+\\frac{3}{4}q^{5}\\right)\\,dq\n\\;=\\;\n\\left[\\frac{q^{3}}{3}-\\frac{3}{2}\\cdot\\frac{q^{5}}{5}+\\frac{3}{4}\\cdot\\frac{q^{6}}{6}\\right]_{0}^{1}\n\\;=\\;\n\\frac{1}{3}-\\frac{3}{10}+\\frac{1}{8}.\n$$\nWith a common denominator, this yields\n$$\nI_{1} \\;=\\; \\frac{40}{120}-\\frac{36}{120}+\\frac{15}{120} \\;=\\; \\frac{19}{120}.\n$$\nCompute the second integral $I_{2}$ by expanding the integrand:\n$$\n(2-q)^{3}=8-12q+6q^{2}-q^{3},\\quad\n\\frac{1}{4}(2-q)^{3}q^{2}\n=2q^{2}-3q^{3}+\\frac{3}{2}q^{4}-\\frac{1}{4}q^{5}.\n$$\nThus\n$$\nI_{2} \\;=\\; \\int_{1}^{2} \\left(2q^{2}-3q^{3}+\\frac{3}{2}q^{4}-\\frac{1}{4}q^{5}\\right)\\,dq\n\\;=\\;\n\\left[\\frac{2}{3}q^{3}-\\frac{3}{4}q^{4}+\\frac{3}{10}q^{5}-\\frac{1}{24}q^{6}\\right]_{1}^{2}.\n$$\nEvaluate at $q=2$:\n$$\n\\frac{2}{3}\\cdot 8 - \\frac{3}{4}\\cdot 16 + \\frac{3}{10}\\cdot 32 - \\frac{1}{24}\\cdot 64\n\\;=\\;\n\\frac{16}{3} - 12 + \\frac{48}{5} - \\frac{8}{3}\n\\;=\\;\n\\frac{4}{15}.\n$$\nEvaluate at $q=1$:\n$$\n\\frac{2}{3} - \\frac{3}{4} + \\frac{3}{10} - \\frac{1}{24}\n\\;=\\;\n\\frac{80}{120}-\\frac{90}{120}+\\frac{36}{120}-\\frac{5}{120}\n\\;=\\;\n\\frac{21}{120} \\;=\\; \\frac{7}{40}.\n$$\nTherefore\n$$\nI_{2} \\;=\\; \\frac{4}{15} - \\frac{7}{40}\n\\;=\\;\n\\frac{32}{120}-\\frac{21}{120}\n\\;=\\;\n\\frac{11}{120}.\n$$\nCombine $I_{1}$ and $I_{2}$:\n$$\nI \\;=\\; \\frac{19}{120}+\\frac{11}{120} \\;=\\; \\frac{30}{120} \\;=\\; \\frac{1}{4}.\n$$\nSubstitute $I=\\frac{1}{4}$ into the expression for $\\sigma$:\n$$\n\\sigma \\;=\\; \\frac{1}{4\\pi}\\left(\\frac{1}{4}\\right)^{-1}\n\\;=\\;\n\\frac{1}{\\pi}.\n$$\nFinally, verify the normalization explicitly:\n$$\n\\int W(\\mathbf{r},h)\\,d^{3}\\mathbf{r}\n\\;=\\;\n4\\pi\\,\\sigma\\int_{0}^{2} f(q)\\,q^{2}\\,dq\n\\;=\\;\n4\\pi\\cdot \\frac{1}{\\pi}\\cdot \\frac{1}{4}\n\\;=\\;\n1,\n$$\nindependent of the smoothing length $h$. Thus the required normalization constant is $\\sigma=\\frac{1}{\\pi}$.",
            "answer": "$$\\boxed{\\frac{1}{\\pi}}$$"
        },
        {
            "introduction": "Beyond satisfying the normalization condition, a kernel's properties can have profound implications for the stability of an SPH simulation. A common numerical issue is the \"pairing instability,\" where particles tend to clump artificially. This advanced exercise  connects the theoretical Fourier-space properties of a kernel to its practical performance, guiding you to quantitatively assess whether a given kernel is susceptible to this instability under typical simulation conditions.",
            "id": "3534793",
            "problem": "In Smoothed Particle Hydrodynamics (SPH), the pairing (or clumping) instability is linked to the presence of negative spectral power in the smoothing kernel at wavenumbers that are representable on the discrete particle lattice. Consider a uniform, equal-mass particle distribution on a simple-cubic lattice with spacing $\\Delta x$ in three spatial dimensions. The smoothing length is $h$, and both the cubic spline kernel (the $M_{4}$ B-spline) and the Wendland $C^{4}$ kernel have compact support radius $\\kappa h$ with $\\kappa=2$. The neighbor number is defined as $N_{\\rm ngb} \\equiv n V_{\\rm supp}$ with number density $n$ and support volume $V_{\\rm supp}=\\frac{4}{3}\\pi (\\kappa h)^{3}$. For a simple-cubic lattice, the Nyquist wavenumber is $k_{N}=\\pi/\\Delta x$. A sufficient spectral stability criterion against pairing for an equal-mass, uniformly sampled configuration is that the radial Fourier transform of the kernel be non-negative for all wavenumbers $k$ represented on the lattice. Equivalently, if the first sign change to negative values of the kernelâ€™s radial Fourier transform occurs at $k h = x_{c}$, then stability requires $k_{N} h  x_{c}$. It is a well-established property that the three-dimensional radial Fourier transform of the cubic spline kernel first becomes negative at $k h = x_{c}=3.8317$ (numerically determined), while the Wendland $C^{4}$ kernel has a non-negative radial Fourier transform for all $k \\ge 0$ in three dimensions.\n\nGiven a target neighbor number $N_{\\rm ngb}=64$, use only the fundamental definitions above to derive the dimensionless spectral coverage parameter $k_{N} h$ as a function of $N_{\\rm ngb}$ and $\\kappa$, evaluate it for $\\kappa=2$ and $N_{\\rm ngb}=64$, and then determine, by quantitative comparison to $x_{c}$, whether each kernel is stable against pairing on the given lattice.\n\nReport your final result as a row matrix $\\bigl[s_{\\rm M4}\\;\\;s_{\\rm WC4}\\bigr]$, where $s_{\\rm M4}$ corresponds to the cubic spline $M_{4}$ kernel and $s_{\\rm WC4}$ corresponds to the Wendland $C^{4}$ kernel, using the convention $s=1$ if stable and $s=0$ if unstable. No units are required. Provide a single final answer. There is no rounding requirement; if you choose to provide an intermediate numerical estimate, round it to four significant figures, but the final matrix entries must be exact integers.",
            "solution": "The task is to determine the stability of the cubic spline and Wendland $C^4$ kernels for a given configuration by first deriving and evaluating the dimensionless spectral coverage parameter $k_{N} h$.\n\nThe neighbor number $N_{\\rm ngb}$ is defined as the product of the number density $n$ and the kernel's support volume $V_{\\rm supp}$:\n$$N_{\\rm ngb} = n V_{\\rm supp}$$\nFor a simple-cubic lattice with inter-particle spacing $\\Delta x$, the number density is the inverse of the volume per particle, $V_{\\rm particle} = (\\Delta x)^3$. Thus,\n$$n = \\frac{1}{(\\Delta x)^3}$$\nThe support volume for a spherical kernel with compact support radius $\\kappa h$ is:\n$$V_{\\rm supp} = \\frac{4}{3}\\pi (\\kappa h)^3$$\nSubstituting these expressions into the definition of $N_{\\rm ngb}$ yields:\n$$N_{\\rm ngb} = \\frac{1}{(\\Delta x)^3} \\left( \\frac{4}{3}\\pi (\\kappa h)^3 \\right) = \\frac{4\\pi\\kappa^3}{3} \\left( \\frac{h}{\\Delta x} \\right)^3$$\nWe wish to find the dimensionless spectral coverage parameter $k_N h$. The Nyquist wavenumber for the lattice is given as $k_N = \\pi / \\Delta x$. Therefore, the parameter is:\n$$k_N h = \\left( \\frac{\\pi}{\\Delta x} \\right) h = \\pi \\left( \\frac{h}{\\Delta x} \\right)$$\nTo express this in terms of $N_{\\rm ngb}$ and $\\kappa$, we first rearrange the equation for $N_{\\rm ngb}$ to solve for the ratio $h/\\Delta x$:\n$$\\left( \\frac{h}{\\Delta x} \\right)^3 = \\frac{3 N_{\\rm ngb}}{4\\pi\\kappa^3}$$\n$$\\frac{h}{\\Delta x} = \\left( \\frac{3 N_{\\rm ngb}}{4\\pi\\kappa^3} \\right)^{1/3}$$\nNow, we substitute this expression into the equation for $k_N h$:\n$$k_N h = \\pi \\left( \\frac{3 N_{\\rm ngb}}{4\\pi\\kappa^3} \\right)^{1/3}$$\nThis can be simplified by bringing the factor of $\\pi$ inside the cubic root:\n$$k_N h = \\left( \\pi^3 \\frac{3 N_{\\rm ngb}}{4\\pi\\kappa^3} \\right)^{1/3} = \\left( \\frac{3\\pi^2 N_{\\rm ngb}}{4\\kappa^3} \\right)^{1/3}$$\nThis is the general expression for the spectral coverage parameter $k_N h$ as a function of the neighbor number $N_{\\rm ngb}$ and the support radius parameter $\\kappa$.\n\nWe now evaluate this expression for the given parameters $N_{\\rm ngb}=64$ and $\\kappa=2$:\n$$k_N h = \\left( \\frac{3\\pi^2 (64)}{4(2)^3} \\right)^{1/3} = \\left( \\frac{192\\pi^2}{4(8)} \\right)^{1/3} = \\left( \\frac{192\\pi^2}{32} \\right)^{1/3} = \\left( 6\\pi^2 \\right)^{1/3}$$\nTo perform the stability analysis, we need a numerical estimate of this value.\nUsing $\\pi \\approx 3.14159$, we have $\\pi^2 \\approx 9.86960$.\n$$k_N h \\approx (6 \\times 9.86960)^{1/3} = (59.2176)^{1/3} \\approx 3.8978$$\nThe problem states to round any intermediate numerical estimate to four significant figures, so we use $k_N h \\approx 3.8978$.\n\nThe stability criterion is $k_N h  x_c$, where $x_c$ is the value of $k h$ at which the kernel's Fourier transform first becomes negative. We analyze each kernel separately.\n\n1.  **Cubic Spline ($M_4$) Kernel:**\n    The problem provides the critical value $x_{c, M4} = 3.8317$.\n    We must compare our calculated $k_N h$ to this value.\n    $$3.8978 \\not 3.8317$$\n    Since $k_N h  x_{c, M4}$, the stability criterion is violated. This means that wavenumbers that can be represented on the particle lattice (specifically, those close to the Nyquist limit) fall into the region where the cubic spline kernel's Fourier transform is negative, leading to the pairing instability.\n    Therefore, the cubic spline kernel is unstable for this configuration. We assign it the stability code $s_{\\rm M4}=0$.\n\n2.  **Wendland $C^4$ Kernel:**\n    The problem states that the radial Fourier transform of the Wendland $C^4$ kernel is non-negative for all wavenumbers $k \\ge 0$. This implies that there is no finite $k$ at which the transform becomes negative. We can thus consider its critical value to be infinite, $x_{c, WC4} = \\infty$.\n    The stability criterion is:\n    $$k_N h  \\infty$$\n    Our calculated value $k_N h \\approx 3.8978$ is a finite number, so this condition is satisfied.\n    Therefore, the Wendland $C^4$ kernel is stable for this configuration. We assign it the stability code $s_{\\rm WC4}=1$.\n\nThe final result is a row matrix containing the stability codes for the cubic spline ($s_{\\rm M4}$) and Wendland $C^4$ ($s_{\\rm WC4}$) kernels, respectively.",
            "answer": "$$\\boxed{\\begin{pmatrix} 0  1 \\end{pmatrix}}$$"
        },
        {
            "introduction": "The ultimate test of a numerical method is its implementation and verification against known solutions. This comprehensive practice  challenges you to write a small SPH code to compute the gradient of an analytic field, a core operation in solving the hydrodynamics equations. By measuring the error of your SPH approximation as a function of particle number, you will perform a convergence study, a critical skill for validating any numerical code and understanding its accuracy and limitations in practice.",
            "id": "3534781",
            "problem": "Design and implement a convergence study for Smoothed Particle Hydrodynamics (SPH), focusing on the accuracy of the SPH gradient operator applied to a smooth analytic scalar field in two spatial dimensions. The study must be based on first principles and evaluate how the mass-weighted root-mean-square error of the SPH gradient approximation scales with the particle count $N$ and with the choice of kernel $W(r,h)$. The study must be cast in purely mathematical terms and use dimensionless quantities defined on a unit domain.\n\nYou must begin from the continuum kernel representation and the particle approximation definitions customary in SPH. Consider a scalar field $f(\\mathbf{x})$ defined on the periodic square domain $[0,1]^2$ with particle positions $\\{\\mathbf{x}_i\\}_{i=1}^N$, equal particle masses $m_i = \\frac{1}{N}$, and smoothing length $h$ defined as $h = \\eta \\sqrt{\\frac{1}{N}}$ with a dimensionless parameter $\\eta  0$. The particle number density is $n = \\frac{N}{1} = N$, and the periodic boundary conditions must be enforced using the minimum image convention on the unit torus. The analytic field to be sampled is\n$$\nf(x,y) = \\sin(2\\pi x)\\cos(2\\pi y),\n$$\nwith exact gradient\n$$\n\\nabla f(x,y) = \\left(2\\pi \\cos(2\\pi x)\\cos(2\\pi y),\\; -2\\pi \\sin(2\\pi x)\\sin(2\\pi y)\\right).\n$$\n\nUse the following two isotropic, radially symmetric, compactly supported SPH kernels in two dimensions, each normalized such that\n$$\n\\int_{\\mathbb{R}^2} W(r,h)\\,d^2\\mathbf{r} = 1,\n$$\nwith support radius $r \\leq 2h$ and $q \\equiv \\frac{r}{h}$:\n\n- Cubic spline (Monaghan-M4) kernel in $2$D:\n$$\nW(r,h) = \\frac{\\sigma}{h^2}\\times\n\\begin{cases}\n1 - \\frac{3}{2}q^2 + \\frac{3}{4}q^3,  0 \\le q  1,\\\\[6pt]\n\\frac{1}{4}(2 - q)^3,  1 \\le q  2,\\\\[6pt]\n0,  q \\ge 2,\n\\end{cases}\n\\quad \\text{with} \\quad \\sigma = \\frac{10}{7\\pi}.\n$$\n\n- Wendland $C^2$ kernel in $2$D:\n$$\nW(r,h) = \\frac{\\sigma}{h^2}\\times\n\\begin{cases}\n\\left(1 - \\frac{q}{2}\\right)^4(1 + 2q),  0 \\le q \\le 2,\\\\[6pt]\n0,  q  2,\n\\end{cases}\n\\quad \\text{with} \\quad \\sigma = \\frac{7}{4\\pi}.\n$$\n\nThe gradient of a radially symmetric kernel $W(r,h)$ must be implemented as\n$$\n\\nabla W(\\mathbf{r},h) = \\frac{\\sigma}{h^3}\\,\\frac{dw}{dq}\\,\\frac{\\mathbf{r}}{r},\n$$\nfor $r  0$, where $w(q)$ is the dimensionless core of the kernel so that $W(r,h) = \\frac{\\sigma}{h^2}w(q)$, and $\\frac{dw}{dq}$ is its derivative with respect to $q$. Handle the $r=0$ case by taking $\\nabla W(\\mathbf{0},h) = \\mathbf{0}$.\n\nDefine the SPH density at each particle using the particle approximation\n$$\n\\rho_i = \\sum_{j=1}^N m_j\\, W(|\\mathbf{x}_i - \\mathbf{x}_j|,h),\n$$\nand define the SPH gradient estimator for the scalar field at each particle as\n$$\n\\left(\\nabla f\\right)_i^{\\text{SPH}} = \\sum_{j=1}^N m_j\\,\\frac{f_j}{\\rho_j}\\,\\nabla W(\\mathbf{x}_i - \\mathbf{x}_j,h).\n$$\nThe error measure to report for each test case is the mass-weighted root-mean-square $L^2$ error across all particles,\n$$\nE = \\left[ \\sum_{i=1}^N m_i\\,\\left\\|\\left(\\nabla f\\right)_i^{\\text{SPH}} - \\nabla f(\\mathbf{x}_i)\\right\\|_2^2 \\right]^{1/2}.\n$$\n\nAlgorithmic requirements:\n- Sample particle positions $\\mathbf{x}_i$ on a uniform Cartesian lattice covering $[0,1]^2$ using $N = n_x \\times n_y$ with $n_x = n_y = \\sqrt{N}$ (choose $N$ values that are perfect squares). Enforce periodic boundary conditions via the minimum image convention on the unit square.\n- Implement a cell-linked list neighbor search with cell size equal to the kernel support radius $2h$, and only accumulate contributions from pairs with $r \\le 2h$.\n- Use constant $h$ for all particles in a given test case, set by $h = \\eta \\sqrt{1/N}$.\n- Compute $\\rho_j$ for all $j$, then compute $\\left(\\nabla f\\right)_i^{\\text{SPH}}$ for all $i$ using the specified estimator.\n\nTest suite:\nProvide results for the following test cases, each specified by a kernel type, particle count, and smoothing parameter $\\eta$:\n- Case $1$: cubic spline kernel, $N = 625$ (i.e., $25 \\times 25$ grid), $\\eta = 1.5$.\n- Case $2$: cubic spline kernel, $N = 2500$ (i.e., $50 \\times 50$ grid), $\\eta = 1.5$.\n- Case $3$: Wendland $C^2$ kernel, $N = 625$, $\\eta = 1.5$.\n- Case $4$: Wendland $C^2$ kernel, $N = 2500$, $\\eta = 1.5$.\n- Case $5$ (edge case with fewer neighbors): cubic spline kernel, $N = 100$ (i.e., $10 \\times 10$ grid), $\\eta = 0.8$.\n\nFinal output format:\nYour program should produce a single line of output containing the five computed error values $E$ for the test suite in the order above, as a comma-separated list enclosed in square brackets (e.g., $[e_1,e_2,e_3,e_4,e_5]$), where each $e_k$ is a floating-point number with no units. No other text should be printed.",
            "solution": "This problem requires the implementation of a numerical algorithm to approximate the gradient of a known scalar field, $f(\\mathbf{x})$, using Smoothed Particle Hydrodynamics (SPH) and to quantify the error of this approximation. The solution is based on the first principles of SPH.\n\n**1. SPH Principles and Formulation**\n\nSmoothed Particle Hydrodynamics is a Lagrangian method where a fluid or a continuous field is represented by a set of discrete particles. The value of any field $A(\\mathbf{x})$ at a position $\\mathbf{x}$ is approximated by a weighted average over nearby particles, using a smoothing kernel $W$.\n\nThe SPH representation of a field $A$ is given by the convolution integral:\n$$\n\\langle A(\\mathbf{x}) \\rangle = \\int A(\\mathbf{x'}) W(\\mathbf{x} - \\mathbf{x'}, h) \\,d\\mathbf{x'}\n$$\nwhere $h$ is the smoothing length which defines the extent of the spatial averaging. In the particle approximation, this integral is discretized into a sum over particles:\n$$\nA_i = \\sum_{j=1}^N \\frac{m_j}{\\rho_j} A_j W(|\\mathbf{x}_i - \\mathbf{x}_j|, h)\n$$\nHere, $m_j$ and $\\rho_j$ are the mass and density of particle $j$, and the term $m_j/\\rho_j$ approximates the volume element $d\\mathbf{x'}$ associated with particle $j$. The SPH density $\\rho_i$ at particle $i$ is itself computed via a summation:\n$$\n\\rho_i = \\sum_{j=1}^N m_j W(|\\mathbf{x}_i - \\mathbf{x}_j|, h)\n$$\nFor this problem, all particles have equal mass $m_i = m = \\frac{1}{N}$.\n\nThe gradient of the field $f(\\mathbf{x})$ is approximated by taking the gradient of the convolution integral, which moves the derivative onto the kernel function:\n$$\n\\langle \\nabla f(\\mathbf{x}) \\rangle = \\int f(\\mathbf{x'}) \\nabla W(\\mathbf{x} - \\mathbf{x'}, h) \\,d\\mathbf{x'}\n$$\nThe corresponding particle approximation, as specified in the problem, is:\n$$\n\\left(\\nabla f\\right)_i^{\\text{SPH}} = \\sum_{j=1}^N m_j\\,\\frac{f_j}{\\rho_j}\\,\\nabla_i W(\\mathbf{x}_i - \\mathbf{x}_j,h)\n$$\nwhere $\\nabla_i W$ denotes the gradient of the kernel with respect to the coordinates of particle $i$. This requires a two-pass approach: first, compute all particle densities $\\rho_j$, and second, use these densities to compute the gradient at each particle $i$.\n\n**2. Kernel Functions and Their Gradients**\n\nThe problem specifies two compactly supported kernels defined for $q = r/h \\le 2$, where $r = |\\mathbf{x}_i - \\mathbf{x}_j|$. The gradient of a radially symmetric kernel $W(r,h) = \\frac{\\sigma}{h^d}w(q)$ (where $d=2$ is the dimension) is given by:\n$$\n\\nabla_i W(\\mathbf{x}_i - \\mathbf{x}_j,h) = \\frac{d W}{dr} \\frac{\\mathbf{x}_i - \\mathbf{x}_j}{r} = \\left(\\frac{d W}{dq}\\frac{dq}{dr}\\right) \\frac{\\mathbf{r}_{ij}}{r} = \\left(\\frac{\\sigma}{h^d}\\frac{dw}{dq}\\frac{1}{h}\\right) \\frac{\\mathbf{r}_{ij}}{r} = \\frac{\\sigma}{h^{d+1}}\\frac{dw}{dq}\\frac{\\mathbf{r}_{ij}}{r}\n$$\nwhere $\\mathbf{r}_{ij} = \\mathbf{x}_i - \\mathbf{x}_j$. For $d=2$, this matches the provided formula $\\nabla W = \\frac{\\sigma}{h^3}\\frac{dw}{dq}\\frac{\\mathbf{r}}{r}$.\n\n- **Cubic Spline (M4) Kernel:**\n  - $w(q) = 1 - \\frac{3}{2}q^2 + \\frac{3}{4}q^3$ for $0 \\le q  1$.\n  - $w(q) = \\frac{1}{4}(2 - q)^3$ for $1 \\le q  2$.\n  - The derivative $\\frac{dw}{dq}$ is:\n    - $\\frac{dw}{dq} = -3q + \\frac{9}{4}q^2$ for $0 \\le q  1$.\n    - $\\frac{dw}{dq} = -\\frac{3}{4}(2 - q)^2$ for $1 \\le q  2$.\n\n- **Wendland $C^2$ Kernel:**\n  - $w(q) = (1 - \\frac{q}{2})^4(1 + 2q)$ for $0 \\le q \\le 2$.\n  - The derivative $\\frac{dw}{dq}$ is found using the product rule:\n    - $\\frac{dw}{dq} = 4(1-\\frac{q}{2})^3(-\\frac{1}{2})(1+2q) + (1-\\frac{q}{2})^4(2) = 2(1-\\frac{q}{2})^3 \\left[ -(1+2q) + (1-\\frac{q}{2}) \\right] = -5q(1 - \\frac{q}{2})^3$ for $0 \\le q \\le 2$.\n\n**3. Algorithmic Implementation**\n\nThe simulation proceeds as follows for each test case defined by the kernel type, particle count $N$, and smoothing parameter $\\eta$.\n\n- **Particle Setup:** Particles are placed on a uniform $n_x \\times n_y$ grid, where $n_x = n_y = \\sqrt{N}$. The positions are cell-centered on the $[0,1]^2$ domain to avoid boundary effects. The smoothing length is set to $h = \\eta / \\sqrt{N}$.\n\n- **Neighbor Search:** A direct summation over all $N$ particles for each particle $i$ would be an $O(N^2)$ operation. Since the kernels have compact support (radius $2h$), only particles within this distance contribute. A cell-linked list algorithm is used to achieve $O(N)$ complexity. The domain is divided into a grid of cells of size $2h \\times 2h$. Each particle is assigned to a cell. For a given particle, neighbors are found by searching only its own cell and the adjacent $8$ cells. Periodic boundary conditions are applied to the cell indices to handle particles near the domain edges.\n\n- **Periodic Boundary Conditions:** The periodic domain is a $2$-torus. The shortest separation vector $\\mathbf{r}_{ij}$ between particles $\\mathbf{x}_i$ and $\\mathbf{x}_j$ is found using the minimum image convention. For a domain of size $1$, each component of the vector difference, e.g., $dx = x_i - x_j$, is mapped to the interval $[-0.5, 0.5]$ by computing $dx' = dx - \\text{round}(dx)$.\n\n- **Computation Passes:**\n  1.  **Density Calculation:** Loop through all particles $i$. For each $i$, use the cell-linked list to find neighbors $j$. Compute $\\mathbf{r}_{ij}$, its magnitude $r$, and the kernel value $W(r, h)$. Sum the contributions to find $\\rho_i$.\n  2.  **Gradient Calculation:** Loop through all particles $i$ again. For each neighbor $j$, compute the kernel gradient vector $\\nabla_i W(\\mathbf{r}_{ij}, h)$ using the analytic derivatives $\\frac{dw}{dq}$. Sum the contributions according to the SPH gradient formula, using the pre-computed densities $\\rho_j$ and field values $f_j$.\n\n- **Error Evaluation:** The analytic gradient $\\nabla f(\\mathbf{x}_i)$ is calculated at each particle position. The squared Euclidean distance between the SPH approximation and the exact gradient is computed: $\\|\\left(\\nabla f\\right)_i^{\\text{SPH}} - \\nabla f(\\mathbf{x}_i)\\|_2^2$. The final error $E$ is the square root of the mass-weighted average of these squared errors over all particles.\n\nThis rigorous procedure allows for a precise evaluation of the SPH gradient operator's accuracy as a function of particle resolution and kernel choice.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nimport itertools\n\ndef solve():\n    \"\"\"\n    Main function to run the SPH convergence study for the specified test cases.\n    \"\"\"\n\n    def get_kernel_functions(kernel_type):\n        \"\"\"Returns the kernel value function, its derivative, and sigma.\"\"\"\n        if kernel_type == 'cubic_spline':\n            sigma = 10.0 / (7.0 * np.pi)\n\n            def W_func(q):\n                if 0 = q  1:\n                    return 1.0 - 1.5 * q**2 + 0.75 * q**3\n                elif 1 = q  2:\n                    return 0.25 * (2.0 - q)**3\n                return 0.0\n\n            def dWdq_func(q):\n                if 0 = q  1:\n                    return -3.0 * q + 2.25 * q**2\n                elif 1 = q  2:\n                    return -0.75 * (2.0 - q)**2\n                return 0.0\n\n        elif kernel_type == 'wendland_c2':\n            sigma = 7.0 / (4.0 * np.pi)\n\n            def W_func(q):\n                if 0 = q = 2:\n                    return (1.0 - 0.5 * q)**4 * (1.0 + 2.0 * q)\n                return 0.0\n\n            def dWdq_func(q):\n                if 0 = q = 2:\n                    return -5.0 * q * (1.0 - 0.5 * q)**3\n                return 0.0\n        else:\n            raise ValueError(\"Unknown kernel type\")\n            \n        return W_func, dWdq_func, sigma\n\n    def run_simulation(kernel_type, N, eta):\n        \"\"\"\n        Runs a single SPH simulation case.\n        \"\"\"\n        # 1. Setup\n        nx = int(np.sqrt(N))\n        ny = nx\n        \n        # Create particle positions on a uniform lattice (cell-centered)\n        x = np.linspace(0.5 / nx, 1.0 - 0.5 / nx, nx)\n        y = np.linspace(0.5 / ny, 1.0 - 0.5 / ny, ny)\n        xv, yv = np.meshgrid(x, y)\n        positions = np.vstack([xv.ravel(), yv.ravel()]).T\n\n        mass = 1.0 / N\n        h = eta / np.sqrt(N)\n        support_radius = 2.0 * h\n        support_radius_sq = support_radius**2\n\n        W_func, dWdq_func, sigma = get_kernel_functions(kernel_type)\n\n        # 2. Build Cell-linked List\n        cell_size = support_radius\n        n_cells_dim = int(np.ceil(1.0 / cell_size))\n        \n        grid = [[] for _ in range(n_cells_dim * n_cells_dim)]\n        particle_cell_indices = np.floor(positions / cell_size).astype(int)\n\n        for i in range(N):\n            cx, cy = particle_cell_indices[i]\n            cell_idx = cx * n_cells_dim + cy\n            grid[cell_idx].append(i)\n\n        # 3. Compute Densities\n        rho = np.zeros(N)\n        h_sq = h**2\n        \n        for i in range(N):\n            pos_i = positions[i]\n            cx, cy = particle_cell_indices[i]\n            rho_i = 0.0\n            \n            for dx, dy in itertools.product([-1, 0, 1], repeat=2):\n                ncx = (cx + dx) % n_cells_dim\n                ncy = (cy + dy) % n_cells_dim\n                cell_idx = ncx * n_cells_dim + ncy\n                \n                for j in grid[cell_idx]:\n                    rij_vec = pos_i - positions[j]\n                    rij_vec -= np.round(rij_vec) # Minimum Image Convention\n                    r_sq = np.sum(rij_vec**2)\n\n                    if r_sq  support_radius_sq:\n                        r = np.sqrt(r_sq)\n                        q = r / h\n                        W_val = (sigma / h_sq) * W_func(q)\n                        rho_i += mass * W_val\n            rho[i] = rho_i\n\n        # 4. Compute SPH Gradient\n        f_values = np.sin(2 * np.pi * positions[:, 0]) * np.cos(2 * np.pi * positions[:, 1])\n        grad_sph = np.zeros((N, 2))\n        h_cubed = h**3\n\n        for i in range(N):\n            pos_i = positions[i]\n            cx, cy = particle_cell_indices[i]\n            grad_i = np.zeros(2)\n\n            for dx, dy in itertools.product([-1, 0, 1], repeat=2):\n                ncx = (cx + dx) % n_cells_dim\n                ncy = (cy + dy) % n_cells_dim\n                cell_idx = ncx * n_cells_dim + ncy\n                \n                for j in grid[cell_idx]:\n                    rij_vec = pos_i - positions[j]\n                    rij_vec -= np.round(rij_vec)\n                    r_sq = np.sum(rij_vec**2)\n\n                    if 1e-12  r_sq  support_radius_sq: # r  0 check\n                        r = np.sqrt(r_sq)\n                        q = r / h\n                        dWdq_val = dWdq_func(q)\n                        grad_W_vec = (sigma / h_cubed) * dWdq_val * (rij_vec / r)\n                        grad_i += mass * (f_values[j] / rho[j]) * grad_W_vec\n            grad_sph[i, :] = grad_i\n\n        # 5. Compute Error\n        grad_exact_x = 2 * np.pi * np.cos(2 * np.pi * positions[:, 0]) * np.cos(2 * np.pi * positions[:, 1])\n        grad_exact_y = -2 * np.pi * np.sin(2 * np.pi * positions[:, 0]) * np.sin(2 * np.pi * positions[:, 1])\n        grad_exact = np.vstack([grad_exact_x, grad_exact_y]).T\n\n        diff_vecs = grad_sph - grad_exact\n        sq_errors = np.sum(diff_vecs**2, axis=1)\n        l2_error = np.sqrt(np.sum(mass * sq_errors))\n        \n        return l2_error\n\n    test_cases = [\n        ('cubic_spline', 625, 1.5),\n        ('cubic_spline', 2500, 1.5),\n        ('wendland_c2', 625, 1.5),\n        ('wendland_c2', 2500, 1.5),\n        ('cubic_spline', 100, 0.8),\n    ]\n\n    results = []\n    for kernel, N_particles, eta_param in test_cases:\n        error = run_simulation(kernel, N_particles, eta_param)\n        results.append(error)\n\n    print(f\"[{','.join(f'{r:.10f}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}