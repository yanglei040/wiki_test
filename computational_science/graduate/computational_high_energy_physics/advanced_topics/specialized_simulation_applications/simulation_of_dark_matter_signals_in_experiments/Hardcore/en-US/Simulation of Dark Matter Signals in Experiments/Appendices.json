{
    "hands_on_practices": [
        {
            "introduction": "The predicted rate of dark matter annihilation in a distant galaxy or halo is proportional to the line-of-sight integral of the dark matter density squared, a quantity known as the astrophysical $J$-factor. This exercise provides a foundational link between a theoretical density distribution, the Navarro-Frenk-White (NFW) profile, and this crucial observable quantity. By deriving the $J$-factor analytically, you will gain a concrete understanding of how the structural properties of dark matter halos, such as their central density and inner slope, directly impact the expected signal strength in indirect detection experiments. ",
            "id": "3534035",
            "problem": "A spherically symmetric dark matter halo is modeled with the Navarro-Frenk-White (NFW) density profile, defined by the characteristic density $\\rho_{s}$ and scale radius $r_{s}$ as $\\rho(r) = \\rho_{s} \\left[ \\left( \\frac{r}{r_{s}} \\right) \\left( 1 + \\frac{r}{r_{s}} \\right)^{2} \\right]^{-1}$. For indirect detection through particle annihilation, the astrophysical line-of-sight (l.o.s.) $J$-factor is defined by the path integral $J = \\int_{\\text{l.o.s.}} \\rho^{2}(s) \\, ds$, where $s$ is the coordinate along the line of sight.\n\nAssume an observer located at distance $D \\gg r_{s}$ from the halo center and consider the central line of sight corresponding to angular separation $\\psi = 0$ so that the impact parameter is zero. For physical realism, assume the density profile is truncated to a constant core inside a small radius $r_{\\min}$ (for instance due to annihilation saturation or baryonic feedback), so that the integral effectively begins at $r = r_{\\min} > 0$. Take the l.o.s. to extend to infinity.\n\nStarting only from the above definitions and geometric relations between the l.o.s. coordinate and the radial coordinate in a spherically symmetric system, derive a closed-form analytical expression for the central $J$-factor $J_{\\text{NFW}}(\\psi=0; r_{\\min})$ in terms of $\\rho_{s}$, $r_{s}$, and the dimensionless inner cutoff $y_{\\min} \\equiv r_{\\min}/r_{s}$. Express your final answer as a single analytic expression and do not include any numerical values or physical units.\n\nThen, using the generalized NFW profile $\\rho(r) = \\rho_{s} \\left[ \\left( \\frac{r}{r_{s}} \\right)^{\\gamma} \\left( 1 + \\frac{r}{r_{s}} \\right)^{3-\\gamma} \\right]^{-1}$ with inner slope parameter $\\gamma$, explain qualitatively how varying $\\gamma$ changes the scaling of $J_{\\text{NFW}}(\\psi=0; r_{\\min})$ with $r_{\\min}$. Finally, explain how unresolved substructure modifies signal predictions through the relationship between $\\langle \\rho^{2} \\rangle$ and $\\langle \\rho \\rangle^{2}$, and define a boost factor that quantifies this effect.\n\nYour final answer must be a single closed-form analytic expression for $J_{\\text{NFW}}(\\psi=0; r_{\\min})$ written in terms of $\\rho_{s}$, $r_{s}$, and $y_{\\min}$, without any units. No rounding is required.",
            "solution": "The astrophysical $J$-factor for annihilation is defined by the line-of-sight integral $J = \\int_{\\text{l.o.s.}} \\rho^{2}(s)\\, ds$, where the line-of-sight coordinate $s$ traverses the density field along a given direction. For a spherically symmetric halo, the radial coordinate $r$ is related to the impact parameter $b$ and line-of-sight coordinate $s$ by $r = \\sqrt{b^{2} + s^{2}}$. For the central line of sight, $\\psi = 0$ implies $b = D \\sin \\psi = 0$, so $r = |s|$. Introducing a physically motivated inner cutoff radius $r_{\\min} > 0$, the integral begins at $r_{\\min}$ to avoid the divergence associated with the NFW cusp.\n\nWith the Navarro-Frenk-White profile $\\rho(r) = \\rho_{s}\\left[ \\left( \\frac{r}{r_{s}} \\right) \\left( 1 + \\frac{r}{r_{s}} \\right)^{2} \\right]^{-1}$, the squared density is\n$$\n\\rho^{2}(r) = \\rho_{s}^{2} \\left[ \\left( \\frac{r}{r_{s}} \\right)^{2} \\left( 1 + \\frac{r}{r_{s}} \\right)^{4} \\right]^{-1}.\n$$\nOn the central line of sight, the integral becomes\n$$\nJ_{\\text{NFW}}(\\psi=0; r_{\\min}) = \\int_{-\\infty}^{\\infty} \\rho^{2}(|s|)\\, ds = 2 \\int_{r_{\\min}}^{\\infty} \\rho^{2}(r)\\, dr,\n$$\nwhere the factor of $2$ accounts for the two symmetric halves of the line of sight ($s>0$ and $s<0$). Changing variables to a dimensionless radial coordinate $y \\equiv r/r_{s}$, so $r = r_{s} y$ and $dr = r_{s}\\, dy$, and defining $y_{\\min} \\equiv r_{\\min}/r_{s}$, we obtain\n$$\nJ_{\\text{NFW}}(\\psi=0; r_{\\min}) = 2 \\rho_{s}^{2} r_{s} \\int_{y_{\\min}}^{\\infty} \\frac{1}{y^{2} (1+y)^{4}}\\, dy.\n$$\n\nWe now compute the integral $I(y) \\equiv \\int \\frac{dy}{y^{2} (1+y)^{4}}$. A convenient substitution is $t \\equiv \\frac{1}{1+y}$, which implies $y = \\frac{1-t}{t}$ and $dy = -\\frac{dt}{t^{2}}$. The integrand simplifies as\n$$\n\\frac{1}{y^{2} (1+y)^{4}} = \\frac{t^{6}}{(1-t)^{2}},\n$$\nand the measure transforms to\n$$\n\\frac{t^{6}}{(1-t)^{2}} \\left(-\\frac{dt}{t^{2}}\\right) = - \\frac{t^{4}}{(1-t)^{2}}\\, dt.\n$$\nLetting $w \\equiv 1 - t$, we have $dt = -dw$ and $- \\frac{t^{4}}{(1-t)^{2}}\\, dt = \\frac{(1-w)^{4}}{w^{2}}\\, dw$. Expanding the numerator yields\n$$\n\\frac{(1-w)^{4}}{w^{2}} = w^{-2} - 4 w^{-1} + 6 - 4 w + w^{2}.\n$$\nIntegrating term by term,\n$$\nI(y) = \\int \\frac{dy}{y^{2} (1+y)^{4}} = - \\frac{1}{w} - 4 \\ln w + 6 w - 2 w^{2} + \\frac{1}{3} w^{3} + C,\n$$\nwhere $w \\equiv \\frac{y}{1+y}$ and $C$ is a constant of integration. Thus,\n$$\nI(y) = - \\frac{1+y}{y} - 4 \\ln\\!\\left( \\frac{y}{1+y} \\right) + \\frac{6y}{1+y} - \\frac{2 y^{2}}{(1+y)^{2}} + \\frac{1}{3} \\frac{y^{3}}{(1+y)^{3}} + C.\n$$\n\nWe need the definite integral from $y_{\\min}$ to $\\infty$. First evaluate the limit at infinity. As $y \\to \\infty$, $w \\to 1$, and we find\n$$\nI(\\infty) = -1 - 4 \\ln(1) + 6 \\cdot 1 - 2 \\cdot 1 + \\frac{1}{3} \\cdot 1 = \\frac{10}{3}.\n$$\nTherefore,\n$$\n\\int_{y_{\\min}}^{\\infty} \\frac{dy}{y^{2} (1+y)^{4}} = I(\\infty) - I(y_{\\min}) = \\frac{10}{3} + \\frac{1+y_{\\min}}{y_{\\min}} + 4 \\ln\\!\\left( \\frac{y_{\\min}}{1+y_{\\min}} \\right) - \\frac{6 y_{\\min}}{1+y_{\\min}} + \\frac{2 y_{\\min}^{2}}{(1+y_{\\min})^{2}} - \\frac{1}{3} \\frac{y_{\\min}^{3}}{(1+y_{\\min})^{3}}.\n$$\nMultiplying by $2 \\rho_{s}^{2} r_{s}$ gives the desired central $J$-factor:\n$$\nJ_{\\text{NFW}}(\\psi=0; r_{\\min}) = 2 \\rho_{s}^{2} r_{s} \\left[ \\frac{10}{3} + \\frac{1+y_{\\min}}{y_{\\min}} + 4 \\ln\\!\\left( \\frac{y_{\\min}}{1+y_{\\min}} \\right) - \\frac{6 y_{\\min}}{1+y_{\\min}} + \\frac{2 y_{\\min}^{2}}{(1+y_{\\min})^{2}} - \\frac{1}{3} \\frac{y_{\\min}^{3}}{(1+y_{\\min})^{3}} \\right].\n$$\n\nWe now discuss the impact of the inner slope and substructure. Consider the generalized NFW profile with inner slope parameter $\\gamma$,\n$$\n\\rho(r) = \\rho_{s} \\left[ \\left( \\frac{r}{r_{s}} \\right)^{\\gamma} \\left( 1 + \\frac{r}{r_{s}} \\right)^{3-\\gamma} \\right]^{-1}.\n$$\nNear the center ($r \\ll r_{s}$), this behaves as $\\rho(r) \\propto r^{-\\gamma}$, so $\\rho^{2}(r) \\propto r^{-2\\gamma}$. On the central line of sight with a cutoff at $r_{\\min}$, the leading scaling is\n$$\nJ(\\psi=0; r_{\\min}) \\sim \\int_{r_{\\min}}^{\\infty} r^{-2\\gamma} \\, dr \\propto\n\\begin{cases}\nr_{\\min}^{1 - 2\\gamma} & \\text{if } \\gamma \\neq \\frac{1}{2}, \\\\\n\\ln\\!\\left( \\frac{r_{\\text{max}}}{r_{\\min}} \\right) & \\text{if } \\gamma = \\frac{1}{2},\n\\end{cases}\n$$\nwhere $r_{\\text{max}}$ is an outer scale entering the logarithm for the marginal case $\\gamma = \\frac{1}{2}$. Thus, steeper inner slopes ($\\gamma$ larger) enhance the sensitivity of $J$ to the inner cutoff, increasing the central $J$ as $r_{\\min}$ decreases. For the classic NFW case $\\gamma = 1$, $J(\\psi=0; r_{\\min}) \\propto r_{\\min}^{-1}$ in the central limit, consistent with the explicit expression derived above.\n\nUnresolved substructure modifies signal predictions because annihilation depends on $\\langle \\rho^{2} \\rangle$, not $\\langle \\rho \\rangle^{2}$. For a volume element with density fluctuations, define the boost factor\n$$\nB \\equiv \\frac{\\langle \\rho^{2} \\rangle}{\\langle \\rho \\rangle^{2}} - 1,\n$$\nso that the total $J$-factor including substructure can be written schematically as\n$$\nJ_{\\text{tot}} \\simeq J_{\\text{smooth}} \\left( 1 + B \\right).\n$$\nHere $B$ depends on the subhalo mass function (for example $dN/dM \\propto M^{-\\alpha}$), the concentration-mass relation $c(M)$, the minimal clump mass and spatial distribution, and tidal evolution. In general, $B$ enhances the annihilation signal, often more strongly at large radii where subhalos are less tidally disrupted, thereby altering both the normalization and morphology of the predicted signal compared to a smooth-halo model.\n\nThe requested final answer is the closed-form expression for $J_{\\text{NFW}}(\\psi=0; r_{\\min})$ in terms of $\\rho_{s}$, $r_{s}$, and $y_{\\min}$ as derived above.",
            "answer": "$$\\boxed{2 \\rho_{s}^{2} r_{s} \\left[ \\frac{10}{3} + \\frac{1+y_{\\min}}{y_{\\min}} + 4 \\ln\\!\\left( \\frac{y_{\\min}}{1+y_{\\min}} \\right) - \\frac{6 y_{\\min}}{1+y_{\\min}} + \\frac{2 y_{\\min}^{2}}{(1+y_{\\min})^{2}} - \\frac{1}{3} \\frac{y_{\\min}^{3}}{(1+y_{\\min})^{3}} \\right]}$$"
        },
        {
            "introduction": "Beyond the initial annihilation, any resulting charged particles, such as antiprotons, must traverse the galaxy to reach our detectors, a journey shaped by magnetic fields, galactic winds, and interactions with interstellar gas. This practice guides you through building a complete simulation pipeline, from the source production of antiprotons to their final modulated flux at the top of Earth's atmosphere. You will implement a simplified but physically motivated cosmic-ray transport model and use it to compare your dark matter signal predictions against real data from the AMS-02 experiment. ",
            "id": "3534007",
            "problem": "Consider a simplified, yet scientifically consistent, simulation of the antiproton differential flux from Dark Matter (DM) annihilation into bottom quarks in the Galaxy, and its comparison with constraints from the Alpha Magnetic Spectrometer (AMS-02). The objective is to implement a program that, for a small test suite of parameter points, computes the top-of-atmosphere antiproton flux prediction under a parameterized propagation model and evaluates model consistency with the AMS-02 measurements using a covariance that includes correlated systematic uncertainties.\n\nFundamental base and definitions to use:\n- Begin from the steady-state form of the cosmic-ray transport (diffusion-convection-loss) equation, which follows from particle number continuity. In the thin-disk, one-dimensional slab approximation, assume a uniform source in a halo of half-height $L$ and adopt an effective-time approximation for the antiproton phase-space density $N(T)$ at kinetic energy $T$: the number density is the source term $q(T)$ times an effective residence time $\\tau_{\\mathrm{eff}}(T)$ that combines diffusion, convection, and catastrophic loss timescales.\n- The source term per unit energy per unit volume per unit time is $q(T) = \\tfrac{1}{2}\\langle \\sigma v \\rangle \\left(\\rho_0/m_\\chi\\right)^2 \\, \\tfrac{dN_{\\bar{p}}}{dT}$, with the following definitions: $\\langle \\sigma v \\rangle$ is the DM annihilation rate, $m_\\chi$ is the DM mass, $\\rho_0$ is the local DM density, and $dN_{\\bar{p}}/dT$ is the antiproton yield per annihilation per unit kinetic energy. The antiproton yield is to be modeled as a dimensionless shape in terms of $x = T/m_\\chi$ using a Beta-function form $dN_{\\bar{p}}/dx \\propto x^{p}(1-x)^{q}$ on $x \\in [0,1]$, normalized to a total antiproton multiplicity $N_{\\bar{p}}$; convert it to $dN_{\\bar{p}}/dT$ using $dT = m_\\chi dx$.\n- The parameterized diffusion coefficient as a function of kinetic energy follows the empirical rigidity dependence $K(T) = K_0\\,\\beta(T)\\left(\\tfrac{R(T)}{1\\,\\mathrm{GV}}\\right)^{\\delta}$, with $\\beta(T) = v(T)/c$, and rigidity $R(T)$ computed from the antiproton momentum $p(T)$ and charge magnitude $\\lvert Z \\rvert = 1$. Use $p(T) = \\sqrt{T\\left(T+2m_p\\right)}$ in $\\mathrm{GeV}$ and $R(T)$ in $\\mathrm{GV}$.\n- Combine timescales using the harmonic sum: $\\tau_{\\mathrm{eff}}(T)^{-1} = \\tau_{\\mathrm{diff}}(T)^{-1} + \\tau_{\\mathrm{conv}}^{-1} + \\tau_{\\mathrm{ann}}(T)^{-1}$, with $\\tau_{\\mathrm{diff}}(T) = L^2/K(T)$, $\\tau_{\\mathrm{conv}} = L/V_c$, and antiproton destruction in gas $\\tau_{\\mathrm{ann}}(T) = \\left(n_{\\mathrm{gas}}\\,\\sigma_{\\mathrm{ann}}\\,v(T)\\right)^{-1}$.\n- The interstellar (IS) differential flux is $\\Phi_{\\mathrm{IS}}(T) = \\tfrac{v(T)}{4\\pi}\\,N(T)$, expressed in $\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}\\,\\mathrm{sr}^{-1}\\,\\mathrm{GeV}^{-1}$ when units are consistently converted to the International System of Units (SI).\n- Apply the force-field solar modulation (top-of-atmosphere, TOA) for charge magnitude $\\lvert Z \\rvert = 1$ and modulation potential $\\phi$ (in $\\mathrm{GV}$): for a TOA kinetic energy $T$, relate to the IS energy $T_{\\mathrm{IS}} = T + \\lvert Z \\rvert \\phi$, and map the flux via $\\Phi_{\\mathrm{TOA}}(T) = \\Phi_{\\mathrm{IS}}(T_{\\mathrm{IS}})\\times \\dfrac{T\\left(T+2m_p\\right)}{T_{\\mathrm{IS}}\\left(T_{\\mathrm{IS}}+2m_p\\right)}$. If $T_{\\mathrm{IS}} > m_\\chi$, set $\\Phi_{\\mathrm{IS}}(T_{\\mathrm{IS}})=0$.\n- Compare model predictions to AMS-02 binned measurements by constructing the residual vector $\\mathbf{r} = \\boldsymbol{\\Phi}_{\\mathrm{model}} - \\boldsymbol{\\Phi}_{\\mathrm{obs}}$ and evaluating the chi-squared with a covariance matrix $\\mathbf{C}$ that includes statistical uncertainties and a correlated systematic uncertainty: $\\chi^2 = \\mathbf{r}^\\top \\mathbf{C}^{-1}\\mathbf{r}$, with $\\mathbf{C} = \\mathrm{diag}(\\boldsymbol{\\sigma}_{\\mathrm{stat}}^2) + \\rho\\,\\boldsymbol{\\sigma}_{\\mathrm{sys}}\\,\\boldsymbol{\\sigma}_{\\mathrm{sys}}^\\top$. Compute the $p$-value using the chi-squared survival function with degrees of freedom equal to the number of bins.\n\nConstants and units to use:\n- Speed of light $c = 2.99792458\\times 10^8\\,\\mathrm{m/s}$.\n- Proton mass $m_p = 0.938\\,\\mathrm{GeV}$.\n- Local DM density $\\rho_0 = 0.4\\,\\mathrm{GeV/cm}^3$.\n- Convert $\\langle \\sigma v \\rangle$ in $\\mathrm{cm}^3/\\mathrm{s}$ to $\\mathrm{m}^3/\\mathrm{s}$ using $1\\,\\mathrm{cm}^3 = 10^{-6}\\,\\mathrm{m}^3$.\n- Convert $K_0$ in $\\mathrm{kpc}^2/\\mathrm{Myr}$ to $\\mathrm{m}^2/\\mathrm{s}$ using $1\\,\\mathrm{kpc} = 3.086\\times 10^{19}\\,\\mathrm{m}$ and $1\\,\\mathrm{Myr} = 3.15576\\times 10^{13}\\,\\mathrm{s}$.\n- Halo half-height $L$ in $\\mathrm{kpc}$ to meters via the same conversion.\n- Gas number density $n_{\\mathrm{gas}}$ in $\\mathrm{cm}^{-3}$ to $\\mathrm{m}^{-3}$ using $1\\,\\mathrm{cm}^{-3} = 10^6\\,\\mathrm{m}^{-3}$.\n- Antiproton inelastic cross section $\\sigma_{\\mathrm{ann}}$ in millibarn to $\\mathrm{m}^2$ using $1\\,\\mathrm{mb} = 10^{-31}\\,\\mathrm{m}^2$.\n- The angular unit for any solid-angle-related quantity is implicitly steradians; no angle computations are required.\n\nAntiproton yield model:\n- Use $dN_{\\bar{p}}/dx = A\\,x^{p}(1-x)^{q}$ for $x\\in[0,1]$, with $p = 1.5$, $q = 4$, and $N_{\\bar{p}} = 1$ antiproton per annihilation. Normalize $A$ using the Beta function $B(\\alpha,\\beta)$: $\\int_0^1 x^{p}(1-x)^{q}\\,dx = B(p+1,q+1)$, so $A = N_{\\bar{p}}/B(p+1,q+1)$. Then $dN_{\\bar{p}}/dT = \\left(N_{\\bar{p}}/\\left[m_\\chi\\,B(p+1,q+1)\\right]\\right)\\,x^{p}(1-x)^{q}$ for $T\\le m_\\chi$ and $0$ otherwise.\n\nAMS-02 binned measurements and uncertainties:\n- Kinetic energy bins at top-of-atmosphere in $\\mathrm{GeV}$: $\\left[1,\\,2,\\,5,\\,10,\\,20,\\,50,\\,100\\right]$.\n- Observed antiproton differential flux in $\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}\\,\\mathrm{sr}^{-1}\\,\\mathrm{GeV}^{-1}$:\n$\\left[2.0\\times 10^{-2},\\,1.5\\times 10^{-2},\\,8.0\\times 10^{-3},\\,3.5\\times 10^{-3},\\,1.5\\times 10^{-3},\\,4.0\\times 10^{-4},\\,1.5\\times 10^{-4}\\right]$.\n- Statistical uncertainties (absolute, same units as flux):\n$\\left[1.0\\times 10^{-3},\\,7.5\\times 10^{-4},\\,4.0\\times 10^{-4},\\,2.0\\times 10^{-4},\\,1.0\\times 10^{-4},\\,5.0\\times 10^{-5},\\,3.0\\times 10^{-5}\\right]$.\n- Systematic fractional uncertainty $f_{\\mathrm{sys}} = 0.10$, so the systematic absolute uncertainty vector is $f_{\\mathrm{sys}}\\times$ the observed flux. Use a correlated systematic with correlation coefficient $\\rho = 0.5$ across bins.\n\nTest suite (each case is a tuple of parameters in the order $\\left(m_\\chi,\\,\\langle \\sigma v \\rangle,\\,K_0,\\,\\delta,\\,L,\\,V_c,\\,\\phi\\right)$):\n- Case $1$ (benchmark, moderate modulation): $\\left(100\\,\\mathrm{GeV},\\,3.0\\times 10^{-26}\\,\\mathrm{cm}^3/\\mathrm{s},\\,0.05\\,\\mathrm{kpc}^2/\\mathrm{Myr},\\,0.4,\\,5\\,\\mathrm{kpc},\\,10\\,\\mathrm{km/s},\\,0.5\\,\\mathrm{GV}\\right)$.\n- Case $2$ (stronger annihilation, potentially excluded): $\\left(50\\,\\mathrm{GeV},\\,3.0\\times 10^{-25}\\,\\mathrm{cm}^3/\\mathrm{s},\\,0.05\\,\\mathrm{kpc}^2/\\mathrm{Myr},\\,0.4,\\,5\\,\\mathrm{kpc},\\,10\\,\\mathrm{km/s},\\,0.5\\,\\mathrm{GV}\\right)$.\n- Case $3$ (heavy DM, stronger convection, weaker modulation): $\\left(500\\,\\mathrm{GeV},\\,3.0\\times 10^{-26}\\,\\mathrm{cm}^3/\\mathrm{s},\\,0.05\\,\\mathrm{kpc}^2/\\mathrm{Myr},\\,0.4,\\,5\\,\\mathrm{kpc},\\,20\\,\\mathrm{km/s},\\,0.2\\,\\mathrm{GV}\\right)$.\n- Case $4$ (smaller halo, no convection, no modulation, smaller annihilation): $\\left(80\\,\\mathrm{GeV},\\,1.0\\times 10^{-26}\\,\\mathrm{cm}^3/\\mathrm{s},\\,0.03\\,\\mathrm{kpc}^2/\\mathrm{Myr},\\,0.33,\\,3\\,\\mathrm{kpc},\\,0\\,\\mathrm{km/s},\\,0.0\\,\\mathrm{GV}\\right)$.\n\nAdditional fixed inputs:\n- Gas number density $n_{\\mathrm{gas}} = 1.0\\,\\mathrm{cm}^{-3}$.\n- Antiproton inelastic cross section $\\sigma_{\\mathrm{ann}} = 50\\,\\mathrm{mb}$.\n\nComputational tasks:\n- Implement the physically consistent unit conversions to ensure the predicted flux is expressed in $\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}\\,\\mathrm{sr}^{-1}\\,\\mathrm{GeV}^{-1}$.\n- For each test case, compute the predicted $\\boldsymbol{\\Phi}_{\\mathrm{TOA}}$ across the specified energy bins, build the covariance matrix $\\mathbf{C}$ using the statistical and systematic uncertainties with correlation coefficient $\\rho$, compute $\\chi^2$, and return the chi-squared survival function $p$-value using the chi-squared distribution with degrees of freedom equal to the number of bins.\n- The final result for each test case is the $p$-value, a float; aggregate the $p$-values for all cases.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of the test cases, with each $p$-value rounded to six decimal places (e.g., $\\left[0.123456,0.654321,0.000001,1.000000\\right]$).\n\nAngle specification:\n- No angle inputs are required; solid angle appears only implicitly in $\\mathrm{sr}$ within the flux units.\n\nYou must ensure every computed flux is reported internally in $\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}\\,\\mathrm{sr}^{-1}\\,\\mathrm{GeV}^{-1}$. All kinetic energies must be in $\\mathrm{GeV}$, and the solar modulation potential must be in $\\mathrm{GV}$. The antiproton yield model must enforce $dN_{\\bar{p}}/dT = 0$ for $T > m_\\chi$.",
            "solution": "The user has provided a scientifically sound and well-posed problem in computational astroparticle physics. The task is to simulate the antiproton flux from dark matter annihilation, considering galactic transport and solar modulation, and to compare the resulting predictions against experimental data from the AMS-02 experiment using a chi-squared statistical test. The problem is validated as it contains all necessary physical formulae, parameters, constants, and experimental data to perform the calculation. The models chosen are standard simplified representations used in the field, and the parameter values are within physically plausible ranges.\n\nThe solution proceeds by first establishing the theoretical and statistical framework, and then outlining the computational implementation. All mathematical quantities are expressed in LaTeX as required.\n\n### Theoretical and Statistical Framework\n\nThe core of the problem is to compute the predicted top-of-atmosphere (TOA) antiproton flux, $\\Phi_{\\mathrm{TOA}}(T)$, for a given set of model parameters and compare it to observed data at specific kinetic energies $T$.\n\n**1. Antiproton Production and Transport**\n\nThe steady-state number density of antiprotons per unit kinetic energy, $N(T)$, is determined by the balance between production and loss mechanisms. In the simplified effective-time approximation, this is given by:\n$$\nN(T) = q(T) \\cdot \\tau_{\\mathrm{eff}}(T)\n$$\nwhere $q(T)$ is the source term (production rate per unit volume, per unit energy) and $\\tau_{\\mathrm{eff}}(T)$ is the effective residence time of antiprotons in the galactic disk.\n\nThe source term, $q(T)$, from dark matter (DM) annihilation is:\n$$\nq(T) = \\frac{1}{2} \\langle \\sigma v \\rangle \\left(\\frac{\\rho_0}{m_\\chi}\\right)^2 \\frac{dN_{\\bar{p}}}{dT}(T)\n$$\nHere, $\\langle \\sigma v \\rangle$ is the velocity-averaged DM annihilation cross-section, $m_\\chi$ is the DM particle mass, and $\\rho_0$ is the local DM density. The factor of $\\frac{1}{2}$ applies for self-conjugate DM particles. The term $\\frac{dN_{\\bar{p}}}{dT}(T)$ is the differential antiproton yield per annihilation. This yield is modeled by a normalized Beta-function distribution in the variable $x = T/m_\\chi$:\n$$\n\\frac{dN_{\\bar{p}}}{dT}(T) = \\frac{N_{\\bar{p}}}{m_\\chi B(p+1, q+1)} x^p (1-x)^q, \\quad \\text{for } T \\le m_\\chi\n$$\nwhere $p=1.5$, $q=4$, the total multiplicity is $N_{\\bar{p}}=1$, and $B(p+1, q+1)$ is the Euler Beta function ensuring normalization, i.e., $\\int_0^{m_\\chi} \\frac{dN_{\\bar{p}}}{dT} dT = N_{\\bar{p}}$. For $T > m_\\chi$, the yield is zero.\n\nThe effective residence time $\\tau_{\\mathrm{eff}}(T)$ combines timescales for diffusion, convection, and annihilation via a harmonic sum:\n$$\n\\tau_{\\mathrm{eff}}(T)^{-1} = \\tau_{\\mathrm{diff}}(T)^{-1} + \\tau_{\\mathrm{conv}}^{-1} + \\tau_{\\mathrm{ann}}(T)^{-1}\n$$\nThe individual timescales are defined as:\n- **Diffusion time:** $\\tau_{\\mathrm{diff}}(T) = L^2 / K(T)$, where $L$ is the half-height of the diffusion halo. The diffusion coefficient $K(T)$ depends on the antiproton's velocity $v(T) = \\beta(T)c$ and rigidity $R(T)$:\n$$\nK(T) = K_0\\,\\beta(T)\\left(\\frac{R(T)}{1\\,\\mathrm{GV}}\\right)^{\\delta}\n$$\nThe antiproton's rigidity (for charge magnitude $|Z|=1$) is numerically equal to its momentum in $\\mathrm{GeV/c}$, $R(T)[\\mathrm{GV}] = p(T)[\\mathrm{GeV/c}]$, given by $p(T) = \\sqrt{T(T+2m_p)}$. The velocity factor is $\\beta(T) = v(T)/c = p(T)/E(T) = \\sqrt{T(T+2m_p)}/(T+m_p)$.\n- **Convection time:** $\\tau_{\\mathrm{conv}} = L/V_c$, where $V_c$ is the constant convection wind velocity. If $V_c=0$, this timescale is infinite and its inverse is zero.\n- **Annihilation time:** $\\tau_{\\mathrm{ann}}(T) = (n_{\\mathrm{gas}}\\sigma_{\\mathrm{ann}}v(T))^{-1}$, representing the catastrophic loss of antiprotons through inelastic interactions with interstellar gas of number density $n_{\\mathrm{gas}}$. $\\sigma_{\\mathrm{ann}}$ is the corresponding cross-section.\n\n**2. Interstellar and Top-of-Atmosphere Flux**\n\nThe differential interstellar (IS) flux, for an isotropic distribution, is related to the number density by:\n$$\n\\Phi_{\\mathrm{IS}}(T) = \\frac{v(T)}{4\\pi} N(T)\n$$\nTo reach detectors near Earth, these cosmic rays must propagate through the solar system's heliosphere, which modulates their energy and flux. Using the force-field approximation, the TOA flux $\\Phi_{\\mathrm{TOA}}$ at kinetic energy $T$ is related to the IS flux at a higher energy $T_{\\mathrm{IS}}$:\n$$\nT_{\\mathrm{IS}} = T + |Z| \\phi\n$$\n$$\n\\Phi_{\\mathrm{TOA}}(T) = \\Phi_{\\mathrm{IS}}(T_{\\mathrm{IS}}) \\times \\frac{T(T+2m_p)}{T_{\\mathrm{IS}}(T_{\\mathrm{IS}}+2m_p)}\n$$\nwhere $\\phi$ is the solar modulation potential in $\\mathrm{GV}$ and $|Z|=1$ for antiprotons. If the required $T_{\\mathrm{IS}}$ exceeds the kinematic limit $m_\\chi$, the source flux $\\Phi_{\\mathrm{IS}}(T_{\\mathrm{IS}})$ is zero.\n\n**3. Statistical Comparison with AMS-02 Data**\n\nThe model is tested against $N_{bins}$ binned measurements from the AMS-02 experiment. The goodness of fit is quantified using the chi-squared ($\\chi^2$) statistic. First, the residual vector $\\mathbf{r}$ is constructed:\n$$\n\\mathbf{r} = \\boldsymbol{\\Phi}_{\\mathrm{model}} - \\boldsymbol{\\Phi}_{\\mathrm{obs}}\n$$\nwhere $\\boldsymbol{\\Phi}_{\\mathrm{model}}$ and $\\boldsymbol{\\Phi}_{\\mathrm{obs}}$ are vectors of the predicted and observed fluxes at the specified bin energies.\n\nThe $\\chi^2$ is calculated as:\n$$\n\\chi^2 = \\mathbf{r}^\\top \\mathbf{C}^{-1} \\mathbf{r}\n$$\nThe covariance matrix $\\mathbf{C}$ incorporates both uncorrelated statistical uncertainties and correlated systematic uncertainties:\n$$\n\\mathbf{C} = \\mathrm{diag}(\\boldsymbol{\\sigma}_{\\mathrm{stat}}^2) + \\rho\\,\\boldsymbol{\\sigma}_{\\mathrm{sys}}\\,\\boldsymbol{\\sigma}_{\\mathrm{sys}}^\\top\n$$\nHere, $\\boldsymbol{\\sigma}_{\\mathrm{stat}}$ is the vector of absolute statistical uncertainties, $\\boldsymbol{\\sigma}_{\\mathrm{sys}}$ is the vector of absolute systematic uncertainties (calculated as $f_{\\mathrm{sys}} \\times \\boldsymbol{\\Phi}_{\\mathrm{obs}}$), and $\\rho$ is the correlation coefficient for systematic effects across all energy bins. The term $\\boldsymbol{\\sigma}_{\\mathrm{sys}}\\,\\boldsymbol{\\sigma}_{\\mathrm{sys}}^\\top$ represents the outer product.\n\nFinally, the model's consistency with the data is expressed as a $p$-value, derived from the $\\chi^2$ survival function (upper tail probability) for a $\\chi^2$ distribution with degrees of freedom (dof) equal to the number of bins, $N_{bins}$.\n$$\np = \\int_{\\chi^2}^{\\infty} f(x; \\text{dof}) \\, dx\n$$\n\n### Computational Implementation\n\nThe algorithm is implemented in a Python script. All input parameters are first converted into a consistent set of SI units ($\\mathrm{m}$, $\\mathrm{kg}$, $\\mathrm{s}$) internally, with energy maintained in $\\mathrm{GeV}$, to ensure correctness.\n\nThe main calculation proceeds as follows:\n1.  **Initialization**: Define all physical constants, AMS-02 data (energy bins, observed fluxes, statistical uncertainties), and test-case parameters.\n2.  **Unit Conversion**: For each test case, convert the input parameters ($\\langle \\sigma v \\rangle, K_0, L, V_c$) and fixed inputs ($n_{\\mathrm{gas}}, \\sigma_{\\mathrm{ann}}, \\rho_0$) into the base unit system.\n3.  **Model Flux Calculation**: For each energy bin $T_{\\mathrm{TOA}, i}$ in the AMS-02 data:\n    a.  Calculate the corresponding interstellar energy $T_{\\mathrm{IS}, i} = T_{\\mathrm{TOA}, i} + \\phi$.\n    b.  If $T_{\\mathrm{IS}, i} > m_\\chi$, the flux $\\Phi_{\\mathrm{TOA}, i}$ is $0$.\n    c.  Otherwise, compute all energy-dependent quantities ($\\beta, R, K, dN_{\\bar{p}}/dT, \\tau_{\\mathrm{eff}}$) at $T_{\\mathrm{IS}, i}$.\n    d.  Assemble these components to calculate $\\Phi_{\\mathrm{IS}}(T_{\\mathrm{IS}, i})$.\n    e.  Apply the solar modulation transformation to get $\\Phi_{\\mathrm{TOA}}(T_{\\mathrm{TOA}, i})$.\n    This populates the model flux vector $\\boldsymbol{\\Phi}_{\\mathrm{model}}$.\n4.  **Statistical Test**:\n    a.  Construct the systematic uncertainty vector $\\boldsymbol{\\sigma}_{\\mathrm{sys}}$.\n    b.  Build the covariance matrix $\\mathbf{C}$ from $\\boldsymbol{\\sigma}_{\\mathrm{stat}}$, $\\boldsymbol{\\sigma}_{\\mathrm{sys}}$, and $\\rho$.\n    c.  Compute the inverse covariance matrix $\\mathbf{C}^{-1}$.\n    d.  Calculate the residual vector $\\mathbf{r}$ and the $\\chi^2$ value.\n    e.  Compute the $p$-value using the chi-squared survival function with dof equal to the number of bins ($7$).\n5.  **Output**: The calculated $p$-values for all test cases are collected and formatted into a single string as specified.\n\nThe `scipy` library is utilized for the Beta function (`scipy.special.beta`) and the chi-squared survival function (`scipy.stats.chi2.sf`), while `numpy` is used for efficient array operations, linear algebra (matrix inversion), and outer products.",
            "answer": "```python\nimport numpy as np\nfrom scipy.special import beta as beta_func\nfrom scipy.stats import chi2\n\ndef solve():\n    \"\"\"\n    Main function to run the simulation and statistical analysis for all test cases.\n    \"\"\"\n    # Physical Constants\n    C_LIGHT = 2.99792458e8  # m/s\n    M_P = 0.938  # GeV\n    RHO_DM_LOCAL = 0.4  # GeV/cm^3\n\n    # Unit Conversion Factors\n    CM3_TO_M3 = 1e-6\n    CM_MIN3_TO_M_MIN3 = 1e6\n    KPC_TO_M = 3.086e19\n    MYR_TO_S = 3.15576e13\n    KPC2_PER_MYR_TO_M2_PER_S = KPC_TO_M**2 / MYR_TO_S\n    KM_TO_M = 1e3\n    MB_TO_M2 = 1e-31\n\n    # Fixed Input Parameters in SI units or standard astro-ph units\n    RHO_DM_LOCAL_SI = RHO_DM_LOCAL * CM_MIN3_TO_M_MIN3  # GeV/m^3\n    N_GAS_CM3 = 1.0  # cm^-3\n    SIGMA_ANN_MB = 50.0  # mb\n    N_GAS_SI = N_GAS_CM3 * CM_MIN3_TO_M_MIN3  # m^-3\n    SIGMA_ANN_SI = SIGMA_ANN_MB * MB_TO_M2  # m^2\n\n    # Antiproton Yield Model Parameters\n    YIELD_P = 1.5\n    YIELD_Q = 4.0\n    N_PBAR = 1.0\n    YIELD_NORM_BETA = beta_func(YIELD_P + 1, YIELD_Q + 1)\n    \n    # AMS-02 Data\n    T_BINS = np.array([1., 2., 5., 10., 20., 50., 100.])  # GeV\n    PHI_OBS = np.array([2.0e-2, 1.5e-2, 8.0e-3, 3.5e-3, 1.5e-3, 4.0e-4, 1.5e-4]) # m^-2 s^-1 sr^-1 GeV^-1\n    SIGMA_STAT = np.array([1.0e-3, 7.5e-4, 4.0e-4, 2.0e-4, 1.0e-4, 5.0e-5, 3.0e-5])\n    F_SYS = 0.10\n    RHO_SYS = 0.5\n    \n    # Covariance Matrix calculation\n    sigma_sys = F_SYS * PHI_OBS\n    cov_stat = np.diag(SIGMA_STAT**2)\n    cov_sys = RHO_SYS * np.outer(sigma_sys, sigma_sys)\n    cov_matrix = cov_stat + cov_sys\n    cov_matrix_inv = np.linalg.inv(cov_matrix)\n    dof = len(T_BINS)\n\n    # Test Suite\n    test_cases = [\n        (100, 3.0e-26, 0.05, 0.4, 5, 10, 0.5),\n        (50, 3.0e-25, 0.05, 0.4, 5, 10, 0.5),\n        (500, 3.0e-26, 0.05, 0.4, 5, 20, 0.2),\n        (80, 1.0e-26, 0.03, 0.33, 3, 0, 0.0),\n    ]\n    \n    results = []\n\n    def calculate_model_flux(T, m_chi, sigmav, K0, delta, L, Vc):\n        \"\"\"Calculates interstellar antiproton flux at kinetic energy T.\"\"\"\n        \n        # Calculate velocity and related quantities\n        p = np.sqrt(T * (T + 2 * M_P)) # Momentum in GeV/c\n        E_total = T + M_P\n        beta_val = p / E_total\n        v = beta_val * C_LIGHT\n        \n        # Rigidity in GV\n        R = p\n        \n        # Diffusion coefficient K(T) in m^2/s\n        K_t = K0 * beta_val * (R / 1.0)**delta\n        \n        # Timescales\n        tau_diff = L**2 / K_t\n        tau_conv = L / Vc if Vc > 0 else np.inf\n        tau_ann = 1.0 / (N_GAS_SI * SIGMA_ANN_SI * v)\n        \n        tau_eff_inv = 1.0/tau_diff + 1.0/tau_conv + 1.0/tau_ann\n        tau_eff = 1.0 / tau_eff_inv\n        \n        # Source term q(T)\n        x = T / m_chi\n        if x > 1.0:\n            return 0.0\n            \n        dNdT_val = (N_PBAR / (m_chi * YIELD_NORM_BETA)) * (x**YIELD_P * (1 - x)**YIELD_Q)\n        \n        source_term_q = 0.5 * sigmav * (RHO_DM_LOCAL_SI / m_chi)**2 * dNdT_val\n        \n        # Number density N(T)\n        N_t = source_term_q * tau_eff\n        \n        # Interstellar flux Phi_IS(T)\n        phi_is = (v / (4 * np.pi)) * N_t\n        return phi_is\n\n    for case in test_cases:\n        m_chi, sigmav_cm3s, K0_kpc, delta, L_kpc, Vc_kms, phi_gv = case\n        \n        # Convert parameters to SI units\n        sigmav_si = sigmav_cm3s * CM3_TO_M3\n        K0_si = K0_kpc * KPC2_PER_MYR_TO_M2_PER_S\n        L_si = L_kpc * KPC_TO_M\n        Vc_si = Vc_kms * KM_TO_M\n\n        phi_model = np.zeros_like(T_BINS)\n        \n        for i, T_toa in enumerate(T_BINS):\n            T_is = T_toa + phi_gv # |Z|=1\n            \n            if T_is > m_chi:\n                phi_model[i] = 0.0\n                continue\n            \n            phi_is_val = calculate_model_flux(T_is, m_chi, sigmav_si, K0_si, delta, L_si, Vc_si)\n            \n            # Solar modulation factor\n            p_toa_sq = T_toa * (T_toa + 2 * M_P)\n            p_is_sq = T_is * (T_is + 2 * M_P)\n            mod_factor = p_toa_sq / p_is_sq\n            \n            phi_model[i] = phi_is_val * mod_factor\n\n        # Statistical analysis\n        residuals = phi_model - PHI_OBS\n        chi_sq_val = residuals.T @ cov_matrix_inv @ residuals\n        p_value = chi2.sf(chi_sq_val, df=dof)\n        \n        results.append(f\"{p_value:.6f}\")\n\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "A realistic search for a dark matter signal must contend with numerous uncertainties, particularly in the astrophysical factors that govern signal strength. This advanced practice simulates a search for a monochromatic gamma-ray line, a \"smoking-gun\" signature of dark matter annihilation, while rigorously accounting for uncertainties in the $J$-factor. You will generate synthetic data and perform a Maximum A Posteriori (MAP) fit, a powerful statistical technique that incorporates prior knowledge on uncertain parameters, to test the robustness of your signal extraction. ",
            "id": "3534024",
            "problem": "You are tasked with building a self-contained program to simulate and fit indirect detection gamma-ray line signals from dark matter annihilation into two photons for the process $\\chi \\chi \\to \\gamma \\gamma$, incorporating subhalo boost distributions, extragalactic attenuation, and template-fitting robustness to astrophysical $J$-factor uncertainties modeled with lognormal priors. The derivation and implementation must start from fundamental definitions and well-tested formulas.\n\nBegin with the following base principles for annihilation fluxes and likelihoods:\n\n1. Dark matter annihilation differential photon flux from a single line-of-sight region of interest (ROI) with astrophysical $J$-factor $J$ is given by\n$$\n\\frac{d\\Phi_{\\mathrm{gal}}}{dE} = \\frac{\\langle \\sigma v \\rangle}{8 \\pi \\, m_\\chi^2} \\, 2 \\, \\delta(E - m_\\chi) \\, J,\n$$\nwhere $m_\\chi$ is the dark matter particle mass, $\\langle \\sigma v \\rangle$ is the velocity-averaged annihilation cross section, and the factor $2$ accounts for two photons per annihilation.\n\n2. The extragalactic annihilation intensity per unit observed energy $E$ for a monochromatic line at emission energy $E_{\\mathrm{em}} = m_\\chi$ under a flat $\\Lambda$ Cold Dark Matter cosmology can be expressed as an integral over redshift $z$,\n$$\n\\frac{d\\Phi_{\\mathrm{ex}}}{dE}(E) = \\frac{c}{8 \\pi} \\frac{\\langle \\sigma v \\rangle}{m_\\chi^2} \\rho_c^2 \\, \\Omega_{\\mathrm{DM}}^2 \\int_0^{z_{\\max}} \\frac{(1+z)^3}{H(z)} e^{-\\tau(E,z)} \\, \\delta\\!\\big(E(1+z) - m_\\chi\\big) \\, dz,\n$$\nwhere $c$ is the speed of light, $\\rho_c$ is the critical density, $\\Omega_{\\mathrm{DM}}$ is the dark matter density parameter, $H(z)$ is the Hubble expansion rate, $\\tau(E,z)$ is the extragalactic background light optical depth, and $\\delta$ is the Dirac delta. Use $H(z) = H_0 \\sqrt{\\Omega_m (1+z)^3 + \\Omega_\\Lambda}$ with $\\Omega_m + \\Omega_\\Lambda = 1$.\n\n3. Model the instrument energy response for the Galactic line by a Gaussian energy dispersion with fractional resolution $r$, such that the line at $E = m_\\chi$ is reconstructed with a Gaussian kernel $G(E; m_\\chi, \\sigma_E)$ of width $\\sigma_E = r \\, m_\\chi$ and unit area. Thus the observed Galactic line intensity is\n$$\n\\frac{d\\Phi_{\\mathrm{gal,obs}}}{dE}(E) = \\left(\\frac{\\langle \\sigma v \\rangle}{4 \\pi \\, m_\\chi^2} J\\right) G\\!\\left(E; m_\\chi, \\sigma_E\\right).\n$$\n\n4. For the optical depth, use the simple parametric form\n$$\n\\tau(E,z) = \\tau_0 \\left(\\frac{E}{E_{\\ast}}\\right)^{\\alpha} z,\n$$\nwith $E_{\\ast} = 100 \\, \\mathrm{GeV}$ and $\\alpha = 1.2$.\n\n5. For each ROI $i$, the expected observed counts in energy bin $j$ with bin center $E_j$ and bin width $\\Delta E$ are given by\n$$\n\\mu_{ij} = \\mathcal{E}_i \\, \\Delta E \\left[ \\frac{d\\Phi_{\\mathrm{gal,obs}}}{dE}(E_j; J_i, \\langle \\sigma v \\rangle) + \\Omega_i \\, \\frac{d\\Phi_{\\mathrm{ex}}}{dE}(E_j; \\langle \\sigma v \\rangle) + \\frac{d\\Phi_{\\mathrm{bkg},i}}{dE}(E_j; k_i) \\right],\n$$\nwhere $\\mathcal{E}_i$ is the exposure (effective area times live time), $\\Omega_i$ is the solid angle of the ROI, and the background spectrum per ROI is modeled as a power law with fixed slope,\n$$\n\\frac{d\\Phi_{\\mathrm{bkg},i}}{dE}(E) = k_i \\left( \\frac{E}{E_0} \\right)^{-\\gamma}.\n$$\n\n6. Observed counts $n_{ij}$ are modeled as independent Poisson random variables with means $\\mu_{ij}$. The joint likelihood is\n$$\n\\mathcal{L} = \\prod_{i,j} \\mathrm{Poisson}(n_{ij} \\mid \\mu_{ij}).\n$$\n\n7. The astrophysical $J$-factors are uncertain. Assume independent lognormal priors per ROI,\n$$\n\\ln J_i \\sim \\mathcal{N}(\\ln \\bar{J}_i, \\sigma_{J,\\mathrm{prior}}^2),\n$$\nwhere $\\bar{J}_i$ is the nominal estimate and $\\sigma_{J,\\mathrm{prior}}$ is the prior width on $\\ln J$. The prior density is\n$$\np(J_i) = \\frac{1}{J_i \\, \\sigma_{J,\\mathrm{prior}} \\sqrt{2\\pi}} \\exp\\!\\left[-\\frac{(\\ln J_i - \\ln \\bar{J}_i)^2}{2 \\sigma_{J,\\mathrm{prior}}^2}\\right].\n$$\n\n8. For robustness testing, generate the true $J$-factors by applying a subhalo boost factor $B_i$ as $J^{\\mathrm{true}}_i = \\bar{J}_i \\, B_i$, where $B_i$ are independent draws from a lognormal distribution with median $1$, that is, $\\ln B_i \\sim \\mathcal{N}(0, \\sigma_{B}^2)$.\n\n9. Adopt flat (improper) priors on the nonnegative parameters $\\langle \\sigma v \\rangle \\ge 0$ and $k_i \\ge 0$.\n\n10. Fit by maximum a posteriori (MAP) estimation, maximizing the posterior\n$$\n\\mathcal{P}(\\langle \\sigma v \\rangle, \\{k_i\\}, \\{J_i\\} \\mid \\{n_{ij}\\}) \\propto \\mathcal{L} \\times \\prod_i p(J_i).\n$$\n\nYour program must:\n\n- Implement the physics exactly as stated above, with all constants and units carefully handled.\n\n- Use the following fixed instrument, cosmology, and analysis settings:\n  - Dark matter mass $m_\\chi = 100 \\, \\mathrm{GeV}$.\n  - Energy range $E \\in [50 \\, \\mathrm{GeV}, 150 \\, \\mathrm{GeV}]$ with $N_{\\mathrm{bins}} = 30$ equal-width bins of width $\\Delta E = (150 - 50)/30 \\, \\mathrm{GeV}$ and centers at bin midpoints.\n  - Fractional energy resolution $r = 0.10$ (that is, $\\sigma_E = 0.10 \\, m_\\chi$).\n  - Fixed background spectral index $\\gamma = 2.3$, pivot $E_0 = 100 \\, \\mathrm{GeV}$.\n  - Exposures $\\mathcal{E}_i = 10^{11} \\, \\mathrm{cm}^2 \\, \\mathrm{s}$ for every ROI $i$.\n  - Solid angles $\\Omega_i = 10^{-4} \\, \\mathrm{sr}$ for every ROI $i$.\n  - Nominal $J$-factors per ROI: $\\bar{J} = [10^{19}, 3 \\times 10^{19}, 10^{20}, 3 \\times 10^{20}, 10^{21}] \\, \\mathrm{GeV}^2 \\, \\mathrm{cm}^{-5}$.\n  - True background normalizations $k^{\\mathrm{true}} = [10^{-12}, 1.5 \\times 10^{-12}, 2 \\times 10^{-12}, 10^{-12}, 3 \\times 10^{-12}] \\, \\mathrm{cm}^{-2} \\, \\mathrm{s}^{-1} \\, \\mathrm{GeV}^{-1}$ for ROIs $i = 1,\\dots,5$.\n  - Cosmology: $H_0 = 70 \\, \\mathrm{km} \\, \\mathrm{s}^{-1} \\, \\mathrm{Mpc}^{-1}$, $\\Omega_m = 0.3$, $\\Omega_\\Lambda = 0.7$, $\\Omega_{\\mathrm{DM}} = 0.26$, speed of light $c = 2.99792458 \\times 10^{10} \\, \\mathrm{cm} \\, \\mathrm{s}^{-1}$, and critical density $\\rho_c = 1.05375 \\times 10^{-5} h^2 \\, \\mathrm{GeV} \\, \\mathrm{cm}^{-3}$ with $h = 0.7$.\n  - Extragalactic attenuation parametrization with $E_\\ast = 100 \\, \\mathrm{GeV}$ and $\\alpha = 1.2$.\n\n- Generate synthetic data by:\n  - Drawing $B_i \\sim \\mathrm{LogNormal}(\\mu=0, \\sigma=\\sigma_B)$ independently and setting $J_i^{\\mathrm{true}} = \\bar{J}_i \\, B_i$.\n  - Computing the expected counts $\\mu_{ij}$ using $\\langle \\sigma v \\rangle_{\\mathrm{true}}$, $J_i^{\\mathrm{true}}$, and $k_i^{\\mathrm{true}}$, then drawing $n_{ij} \\sim \\mathrm{Poisson}(\\mu_{ij})$.\n  - Use a pseudorandom generator with the fixed seed $12345$ to ensure reproducibility.\n\n- Perform a MAP fit over $\\langle \\sigma v \\rangle \\ge 0$, $k_i \\ge 0$, and $J_i > 0$, given the lognormal priors for $J_i$ with width $\\sigma_{J,\\mathrm{prior}}$ and the Poisson likelihood, holding the background spectral index and all other constants fixed. Treat the extragalactic component as an isotropic template whose normalization is tied to $\\langle \\sigma v \\rangle$ via the cosmological formula above. Use $z_{\\max} = 5$ but note that the delta-function support enforces $z^\\star = m_\\chi/E - 1$.\n\n- Compute the extragalactic line intensity by analytically evaluating the redshift integral using the delta function:\n  - For each observed energy $E$, define $z^\\star = m_\\chi/E - 1$; if $z^\\star < 0$ or $z^\\star > z_{\\max}$, set the extragalactic contribution to zero.\n  - Otherwise,\n  $$\n  \\frac{d\\Phi_{\\mathrm{ex}}}{dE}(E) = \\frac{c}{8 \\pi} \\frac{\\langle \\sigma v \\rangle}{m_\\chi^2} \\rho_c^2 \\, \\Omega_{\\mathrm{DM}}^2 \\, \\frac{(1+z^\\star)^3}{H(z^\\star)} \\frac{e^{-\\tau(E, z^\\star)}}{E}.\n  $$\n\n- Fit objective: maximize the logarithm of the posterior (equivalently, minimize the negative log-posterior). Impose positivity bounds and use a suitable numerical optimizer.\n\nTest suite and outputs:\n\nRun the above end-to-end simulation-and-fit for the following three cases, which probe different robustness regimes:\n\n- Case A (happy path): $\\langle \\sigma v \\rangle_{\\mathrm{true}} = 3 \\times 10^{-26} \\, \\mathrm{cm}^3 \\, \\mathrm{s}^{-1}$, $\\tau_0 = 0.5$, $\\sigma_{J,\\mathrm{prior}} = 0.5$, and $\\sigma_B = 0.5$.\n\n- Case B (boundary low-signal, underestimated $J$ prior width): $\\langle \\sigma v \\rangle_{\\mathrm{true}} = 1 \\times 10^{-27} \\, \\mathrm{cm}^3 \\, \\mathrm{s}^{-1}$, $\\tau_0 = 0.0$, $\\sigma_{J,\\mathrm{prior}} = 0.2$, and $\\sigma_B = 0.5$.\n\n- Case C (edge high attenuation, overestimated $J$ prior width): $\\langle \\sigma v \\rangle_{\\mathrm{true}} = 3 \\times 10^{-26} \\, \\mathrm{cm}^3 \\, \\mathrm{s}^{-1}$, $\\tau_0 = 2.0$, $\\sigma_{J,\\mathrm{prior}} = 0.8$, and $\\sigma_B = 0.5$.\n\nFor each case, compute the ratio\n$$\nR = \\frac{\\langle \\sigma v \\rangle_{\\mathrm{MAP}}}{\\langle \\sigma v \\rangle_{\\mathrm{true}}}.\n$$\n\nFinal output format:\n\nYour program should produce a single line of output containing the results for the three cases as a comma-separated list of three floating-point numbers enclosed in square brackets, specifically $[R_A, R_B, R_C]$, with no additional text.\n\nAll physical units in inputs are as specified above. Report only the dimensionless ratios $R$ as floats.",
            "solution": "The problem is deemed valid as it is scientifically grounded, well-posed, and objective. It provides a complete and self-contained specification for a simulation and fitting exercise in the context of indirect dark matter detection, a standard topic in computational high-energy physics. All physical formulas, parameters, and numerical procedures are clearly defined and consistent with established literature.\n\nThe solution will be implemented by following these steps:\n1.  **Setup and Constants**: All physical constants and analysis parameters are defined in a consistent system of units (GeV, cm, s).\n2.  **Physical Modeling**: Implement functions for the a) Galactic signal component, b) extragalactic signal component, and c) astrophysical background component, according to the provided formulas.\n3.  **Data Simulation**: A routine is developed to generate synthetic count data. This involves setting the true physical parameters, calculating expected counts in each energy bin for each Region of Interest (ROI), and drawing pseudo-random numbers from a Poisson distribution. True $J$-factors are generated by applying a lognormally distributed boost factor to the nominal values.\n4.  **Statistical Fitting**: A Maximum A Posteriori (MAP) fit is performed to recover the model parameters from the synthetic data. The objective function to be minimized is the negative log-posterior, defined as:\n    $$\n    f(\\vec{\\theta}) = -\\ln\\mathcal{P}(\\vec{\\theta} \\mid \\{n_{ij}\\}) = -\\ln\\mathcal{L}(\\{n_{ij}\\} \\mid \\vec{\\theta}) - \\ln p(\\vec{\\theta})\n    $$\n    where the parameter vector is $\\vec{\\theta} = (\\langle \\sigma v \\rangle, \\{k_i\\}, \\{J_i\\})$.\n\nThe log-likelihood, derived from the product of Poisson probabilities, and neglecting constant terms, is:\n$$\n-\\ln\\mathcal{L} = \\sum_{i,j} \\left( \\mu_{ij}(\\vec{\\theta}) - n_{ij} \\ln(\\mu_{ij}(\\vec{\\theta})) \\right)\n$$\nThe log-prior, combining flat priors for $\\langle \\sigma v \\rangle$ and $\\{k_i\\}$ with lognormal priors for $\\{J_i\\}$, contributes:\n$$\n-\\ln p(\\vec{\\theta}) = \\sum_i \\left( \\frac{(\\ln J_i - \\ln \\bar{J}_i)^2}{2\\sigma_{J,\\mathrm{prior}}^2} + \\ln J_i \\right) + \\text{const.}\n$$\nThe sum of these two terms forms the objective function for minimization. The fit is performed over $11$ parameters: the global annihilation cross-section $\\langle \\sigma v \\rangle$ and the per-ROI background normalizations $\\{k_i\\}_{i=1..5}$ and $J$-factors $\\{J_i\\}_{i=1..5}$.\n\nThe key components of the physical model are implemented as follows:\n\n-   **Energy Bins**: The energy range from $E_{\\min} = 50 \\, \\mathrm{GeV}$ to $E_{\\max} = 150 \\, \\mathrm{GeV}$ is divided into $N_{\\mathrm{bins}} = 30$ bins. The bin width is $\\Delta E = (E_{\\max} - E_{\\min})/N_{\\mathrm{bins}}$, and bin centers $E_j$ are at the midpoints.\n\n-   **Galactic Signal**: The observed Galactic signal flux, after accounting for energy dispersion, is:\n    $$\n    \\frac{d\\Phi_{\\mathrm{gal,obs}}}{dE}(E; J_i, \\langle \\sigma v \\rangle) = \\frac{\\langle \\sigma v \\rangle}{4 \\pi m_\\chi^2} J_i \\cdot G(E; m_\\chi, \\sigma_E)\n    $$\n    where $G(E; m_\\chi, \\sigma_E)$ is the probability density function of a Normal distribution with mean $m_\\chi = 100 \\, \\mathrm{GeV}$ and standard deviation $\\sigma_E = r \\cdot m_\\chi = 0.1 \\cdot 100 \\, \\mathrm{GeV} = 10 \\, \\mathrm{GeV}$.\n\n-   **Extragalactic Signal**: The extragalactic signal intensity is calculated by analytically solving the redshift integral using the Dirac delta property:\n    $$\n    \\frac{d\\Phi_{\\mathrm{ex}}}{dE}(E) = \\frac{c}{8 \\pi} \\frac{\\langle \\sigma v \\rangle}{m_\\chi^2} (\\rho_c \\Omega_{\\mathrm{DM}})^2 \\frac{(1+z^\\star)^3}{H(z^\\star)} \\frac{e^{-\\tau(E, z^\\star)}}{E}\n    $$\n    This is valid for $z^\\star = m_\\chi/E - 1$ in the range $[0, z_{\\max}]$, and zero otherwise. The Hubble rate is $H(z) = H_0 \\sqrt{\\Omega_m(1+z)^3 + \\Omega_\\Lambda}$, and the optical depth is $\\tau(E, z) = \\tau_0 (E/E_\\ast)^\\alpha z$.\n\n-   **Background**: The astrophysical background is a simple power law:\n    $$\n    \\frac{d\\Phi_{\\mathrm{bkg},i}}{dE}(E) = k_i \\left( \\frac{E}{E_0} \\right)^{-\\gamma}\n    $$\n    with $\\gamma = 2.3$ and $E_0 = 100 \\, \\mathrm{GeV}$.\n\n-   **Expected Counts**: The expected number of counts $\\mu_{ij}$ for ROI $i$ in energy bin $j$ is the sum of these flux components multiplied by the exposure $\\mathcal{E}_i$ and the bin width $\\Delta E$. The extragalactic intensity is also multiplied by the ROI solid angle $\\Omega_i$.\n\nA numerical optimization algorithm, specifically L-BFGS-B as implemented in `scipy.optimize.minimize`, is used to find the parameter values that minimize the negative log-posterior, subject to the positivity constraints $\\langle \\sigma v \\rangle \\ge 0$, $k_i \\ge 0$, and $J_i > 0$.\n\nThe entire process is executed for three test cases, each with different true parameters and prior assumptions, to test the robustness of the fitting procedure. The final output is the ratio of the MAP-fitted cross-section to its true value, $R = \\langle \\sigma v \\rangle_{\\mathrm{MAP}} / \\langle \\sigma v \\rangle_{\\mathrm{true}}$, for each case.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import minimize\nfrom scipy.stats import norm\n\n#\n# Execution Environment:\n# language: Python\n# version: 3.12\n# libraries:\n#   - name: numpy, version: 1.23.5\n#   - name: scipy, version: 1.11.4\n#\n\ndef solve():\n    \"\"\"\n    Main function to run the simulation and fitting for all test cases.\n    \"\"\"\n\n    # --- Physical Constants ---\n    C_LIGHT = 2.99792458e10  # cm/s\n    H0_KM_S_MPC = 70.0  # km/s/Mpc\n    KM_PER_MPC = 3.08567758e19\n    H0_S_INV = H0_KM_S_MPC / KM_PER_MPC  # s^-1\n    H_val = 0.7  # H0 / 100\n    RHO_C_PREFACTOR = 1.05375e-5  # h^2 GeV/cm^3\n    RHO_C = RHO_C_PREFACTOR * H_val**2  # GeV/cm^3\n\n    # --- Cosmological Parameters ---\n    OMEGA_M = 0.3\n    OMEGA_L = 0.7\n    OMEGA_DM = 0.26\n    \n    # --- Analysis Settings ---\n    M_CHI = 100.0  # GeV\n    E_MIN, E_MAX, N_BINS = 50.0, 150.0, 30\n    E_BINS = np.linspace(E_MIN, E_MAX, N_BINS + 1)\n    E_CENTERS = (E_BINS[:-1] + E_BINS[1:]) / 2.0\n    DELTA_E = (E_MAX - E_MIN) / N_BINS\n    E_RES = 0.10\n    SIGMA_E = E_RES * M_CHI\n    BKG_GAMMA = 2.3\n    BKG_E0 = 100.0  # GeV\n    Z_MAX = 5.0\n\n    # --- Attenuation Parameters ---\n    ALPHA_TAU = 1.2\n    E_STAR_TAU = 100.0  # GeV\n\n    # --- ROI-specific Settings ---\n    N_ROIS = 5\n    EXPOSURE = 1.0e11  # cm^2 s, same for all ROIs\n    SOLID_ANGLE = 1.0e-4  # sr, same for all ROIs\n    J_BAR = np.array([1e19, 3e19, 1e20, 3e20, 1e21])  # GeV^2 cm^-5\n    K_TRUE = np.array([1e-12, 1.5e-12, 2e-12, 1e-12, 3e-12])  # cm^-2 s^-1 GeV^-1\n\n    # --- Pre-calculate templates ---\n    GAL_TEMPLATE = norm.pdf(E_CENTERS, loc=M_CHI, scale=SIGMA_E)\n    BKG_TEMPLATE = (E_CENTERS / BKG_E0)**(-BKG_GAMMA)\n\n    def hubble_rate(z):\n        return H0_S_INV * np.sqrt(OMEGA_M * (1 + z)**3 + OMEGA_L)\n\n    def optical_depth(E, z, tau_0):\n        return tau_0 * (E / E_STAR_TAU)**ALPHA_TAU * z\n\n    def extragalactic_flux_template(e_array, tau_0):\n        z_star = M_CHI / e_array - 1\n        flux = np.zeros_like(e_array)\n        \n        valid_mask = (z_star >= 0)  (z_star = Z_MAX)\n        if np.any(valid_mask):\n            z_s_valid = z_star[valid_mask]\n            e_valid = e_array[valid_mask]\n            \n            prefactor = (C_LIGHT / (8 * np.pi * M_CHI**2)) * (RHO_C * OMEGA_DM)**2\n            \n            integrand = ((1 + z_s_valid)**3 / hubble_rate(z_s_valid)) \\\n                        * np.exp(-optical_depth(e_valid, z_s_valid, tau_0)) / e_valid\n            \n            flux[valid_mask] = prefactor * integrand\n        return flux\n\n    # --- Main Calculation Functions ---\n    def get_expected_counts(params, tau_0):\n        sv, k_vals, j_vals = params[0], params[1:1+N_ROIS], params[1+N_ROIS:]\n        \n        # Extragalactic flux is common for all ROIs (up to solid angle)\n        exgal_flux_template = extragalactic_flux_template(E_CENTERS, tau_0)\n        exgal_flux_total = sv * exgal_flux_template\n        \n        mu = np.zeros((N_ROIS, N_BINS))\n        for i in range(N_ROIS):\n            gal_flux = (sv / (4 * np.pi * M_CHI**2)) * j_vals[i] * GAL_TEMPLATE\n            bkg_flux = k_vals[i] * BKG_TEMPLATE\n            \n            total_flux = gal_flux + SOLID_ANGLE * exgal_flux_total + bkg_flux\n            mu[i, :] = total_flux * EXPOSURE * DELTA_E\n        \n        return mu\n\n    def neg_log_posterior(params, n_obs, tau_0, sigma_j_prior):\n        # Unpack parameters: sv, k_i, J_i\n        sv, k_vals, j_vals = params[0], params[1:1+N_ROIS], params[1+N_ROIS:]\n        \n        # Ensure parameters are positive\n        if sv  0 or np.any(k_vals  0) or np.any(j_vals = 0):\n            return np.inf\n\n        mu = get_expected_counts(params, tau_0)\n        \n        # Add a small epsilon to avoid log(0)\n        mu[mu = 0] = 1e-30\n        \n        # Poisson log-likelihood part\n        log_likelihood = np.sum(mu - n_obs * np.log(mu))\n        \n        # Lognormal prior on J-factors part\n        log_prior_j = np.sum(\n            (np.log(j_vals) - np.log(J_BAR))**2 / (2 * sigma_j_prior**2) + np.log(j_vals)\n        )\n        \n        return log_likelihood + log_prior_j\n\n    def run_case(sv_true, tau_0, sigma_j_prior, sigma_b):\n        # --- 1. Generate Data ---\n        rng = np.random.default_rng(12345)\n        \n        # Generate true J-factors with boost\n        ln_b_vals = rng.normal(loc=0.0, scale=sigma_b, size=N_ROIS)\n        b_vals = np.exp(ln_b_vals)\n        j_true = J_BAR * b_vals\n        \n        # Calculate true expected counts\n        true_params = np.concatenate(([sv_true], K_TRUE, j_true))\n        mu_true = get_expected_counts(true_params, tau_0)\n        \n        # Generate observed counts\n        n_obs = rng.poisson(lam=mu_true)\n\n        # --- 2. Perform MAP Fit ---\n        # Initial guess for optimization\n        x0 = np.concatenate(([1e-27], K_TRUE, J_BAR))\n        \n        # Parameter bounds\n        bounds = [(1e-30, None)]  # sv >= 0 (small positive num to avoid issues)\n        bounds += [(1e-20, None)] * N_ROIS  # k_i >= 0\n        bounds += [(1e-20, None)] * N_ROIS  # J_i > 0\n\n        # Run optimizer\n        result = minimize(\n            neg_log_posterior,\n            x0,\n            args=(n_obs, tau_0, sigma_j_prior),\n            method='L-BFGS-B',\n            bounds=bounds,\n            options={'ftol': 1e-12, 'gtol': 1e-8}\n        )\n        \n        sv_map = result.x[0]\n        \n        return sv_map / sv_true\n\n    # --- Test Cases Definition ---\n    test_cases = [\n        # Case A: happy path\n        {'sv_true': 3e-26, 'tau_0': 0.5, 'sigma_j_prior': 0.5, 'sigma_b': 0.5},\n        # Case B: low-signal, underestimated J prior\n        {'sv_true': 1e-27, 'tau_0': 0.0, 'sigma_j_prior': 0.2, 'sigma_b': 0.5},\n        # Case C: high attenuation, overestimated J prior\n        {'sv_true': 3e-26, 'tau_0': 2.0, 'sigma_j_prior': 0.8, 'sigma_b': 0.5},\n    ]\n\n    results = []\n    for case in test_cases:\n        ratio = run_case(\n            sv_true=case['sv_true'],\n            tau_0=case['tau_0'],\n            sigma_j_prior=case['sigma_j_prior'],\n            sigma_b=case['sigma_b']\n        )\n        results.append(ratio)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == '__main__':\n    solve()\n```"
        }
    ]
}