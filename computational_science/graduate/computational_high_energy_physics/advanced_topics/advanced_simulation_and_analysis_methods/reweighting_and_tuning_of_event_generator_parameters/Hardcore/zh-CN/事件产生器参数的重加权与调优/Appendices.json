{
    "hands_on_practices": [
        {
            "introduction": "重加权（reweighting）是高能物理模拟中的一项基石技术，它允许我们在不重新运行整个耗时巨大的模拟过程的情况下，评估在不同模型假设（例如不同的理论参数）下的物理预测。这个练习将带您回到基本原理，利用量子色动力学（QCD）的因子化定理，推导因部分子分布函数（PDF）集改变而产生的重加权因子。通过这个实践，您将为后续更复杂的应用打下坚实的理论基础，并理解如何量化对撞机物理中一个常见系统不确定性的来源。",
            "id": "3532078",
            "problem": "一个事件生成器产生了一个质子-质子事件，其硬过程由一个上夸克和一个反上夸克引发，即入射味为 $(u,\\bar{u})$。第一个部分子携带了来自束流1的纵向动量分数 $x_1=0.1$，第二个部分子携带了来自束流2的 $x_2=0.02$。该事件是在因子化标度 $\\mu_F=100\\ \\mathrm{GeV}$ 下生成的，并且重整化标度被设定为等于因子化标度，即 $\\mu_R=\\mu_F$。假设 $(u,\\bar{u})$ 的领头阶部分子子过程在重加权下保持不变，并且在两个部分子分布函数（PDF）集之间切换时，唯一的修改在于PDF本身。此处，PDF指的是部分子分布函数（Parton Distribution Function, PDF），$f_i(x,\\mu_F)$，它给出了在标度 $\\mu_F$ 下找到一个携带动量分数 $x$ 的味为 $i$ 的部分子的概率密度。\n\n给你两个不同PDF集的中心成员值，分别记为 $S_A$（用于生成事件的原始集）和 $S_B$（事件将被重加权到的目标集）。数值（无量纲）如下：\n- 对于 $S_A$：$f_u^{A}(x_1=0.1,\\mu_F=100\\ \\mathrm{GeV})=2.70$ 和 $f_{\\bar{u}}^{A}(x_2=0.02,\\mu_F=100\\ \\mathrm{GeV})=0.25$。\n- 对于 $S_B$：$f_u^{B}(x_1=0.1,\\mu_F=100\\ \\mathrm{GeV})=2.35$ 和 $f_{\\bar{u}}^{B}(x_2=0.02,\\mu_F=100\\ \\mathrm{GeV})=0.27$。\n\n从强子截面的因子化定理以及因子化蒙特卡洛事件生成中事件权重的基本性质出发，推导将此事件的权重从 $S_A$ 重新标度到 $S_B$ 的重加权因子 $R$，并计算其值。将最终比率 $R$ 表示为一个无量纲数，并将答案四舍五入到四位有效数字。\n\n此外，请使用第一性原理，并且不使用任何预先提供的快捷公式，解释Hessian PDF集 $\\{(k,+),(k,-)\\}_{k=1}^{N}$ 中的不确定性本征矢量如何通过逐事件PDF重加权传播到任意可观测量。你的解释应清晰地阐述特定于本征矢量的事件权重的构建方式，以及它们如何组合以产生加权可观测量的不确定性，但你最终的数值答案必须仅为重加权因子 $R$。",
            "solution": "该问题要求在更换底层部分子分布函数（PDF）集时，推导并计算单个高能物理事件的重加权因子。它还要求对Hessian集中的PDF不确定性如何传播到可观测量进行概念性解释。我们将依次处理这两个部分。\n\n首先，我们验证问题陈述的有效性。\n已知条件如下：\n- 入射部分子味：$(u,\\bar{u})$\n- 部分子动量分数：来自束流1的 $x_1=0.1$ 和来自束流2的 $x_2=0.02$。\n- 因子化标度：$\\mu_F=100\\ \\mathrm{GeV}$。\n- 重整化标度：$\\mu_R=\\mu_F$。\n- 原始PDF集 $S_A$ 的值：$f_u^{A}(x_1=0.1,\\mu_F=100\\ \\mathrm{GeV})=2.70$ 和 $f_{\\bar{u}}^{A}(x_2=0.02,\\mu_F=100\\ \\mathrm{GeV})=0.25$。\n- 目标PDF集 $S_B$ 的值：$f_u^{B}(x_1=0.1,\\mu_F=100\\ \\mathrm{GeV})=2.35$ 和 $f_{\\bar{u}}^{B}(x_2=0.02,\\mu_F=100\\ \\mathrm{GeV})=0.27$。\n- 关键假设：领头阶部分子子过程不变，且集与集之间仅修改PDF本身。\n\n该问题在科学上基于微扰量子色动力学（QCD）理论及其在蒙特卡洛事件生成中的应用。PDF重加权的框架是高能物理学的标准实践。所提供的值是符合实际的，问题提法得当、内容自洽且客观。它不违反任何基本原理，并与指定主题直接相关。因此，该问题被认为是有效的。\n\n我们现在开始求解。\n\n第一部分：重加权因子 $R$ 的推导与计算。\n\n计算强子对撞中截面的基础是QCD因子化定理。该定理指出，一个过程 $pp \\to X$ 的微分截面 $d\\sigma$ 可以通过对所有可能的初态部分子味 $i$ 和 $j$ 求和，对所有可能的动量分数 $x_1$ 和 $x_2$ 积分，并将PDF与部分子硬散射截面 $d\\hat{\\sigma}_{ij}$ 进行卷积来计算：\n$$\nd\\sigma = \\sum_{i,j} \\int dx_1 \\int dx_2 f_i(x_1, \\mu_F) f_j(x_2, \\mu_F) d\\hat{\\sigma}_{ij}(x_1, x_2, \\mu_F, \\mu_R)\n$$\n此处，$f_i(x, \\mu_F)$ 是在因子化标度 $\\mu_F$ 下，携带质子动量分数 $x$ 的部分子味 $i$ 的PDF。项 $d\\hat{\\sigma}_{ij}$ 是部分子子过程 $i+j \\to F$ 的微分截面，其中 $F$ 是硬散射的末态。\n\n蒙特卡洛事件生成器产生的事件对应于可用相空间中的特定点。对于为特定硬过程生成的单个事件，其初态部分子和动量分数是固定的。这样一个非加权事件（在喷注、强子化和探测器模拟之前）的权重 $w$ 与截面公式在该特定运动学点处的被积函数的值成正比。\n\n对于给定事件，入射部分子是来自质子1的上夸克（$u$）和来自质子2的反上夸克（$\\bar{u}$）。它们各自的动量分数是 $x_1=0.1$ 和 $x_2=0.02$。该事件是使用PDF集 $S_A$ 生成的。因此，其原始权重 $w_A$ 与来自集 $S_A$ 的相关PDF和部分子截面 $\\hat{\\sigma}_{u\\bar{u}}$ 的乘积成正比：\n$$\nw_A \\propto f_u^A(x_1, \\mu_F) f_{\\bar{u}}^A(x_2, \\mu_F) \\hat{\\sigma}_{u\\bar{u}}\n$$\n我们希望确定如果使用PDF集 $S_B$ 生成，这同一个事件的权重会是多少。设这个新权重为 $w_B$。根据问题陈述，部分子截面 $\\hat{\\sigma}_{u\\bar{u}}$ 和事件运动学的所有其他方面都保持不变。唯一的变化是PDF集。因此，新权重 $w_B$ 为：\n$$\nw_B \\propto f_u^B(x_1, \\mu_F) f_{\\bar{u}}^B(x_2, \\mu_F) \\hat{\\sigma}_{u\\bar{u}}\n$$\n重加权因子 $R$ 定义为新权重与旧权重的比值，即 $R = w_B / w_A$。比例常数和部分子截面 $\\hat{\\sigma}_{u\\bar{u}}$ 在该比值中被消去：\n$$\nR = \\frac{f_u^B(x_1, \\mu_F) f_{\\bar{u}}^B(x_2, \\mu_F)}{f_u^A(x_1, \\mu_F) f_{\\bar{u}}^A(x_2, \\mu_F)}\n$$\n现在我们可以将提供的数值代入此表达式。\n已知：\n- $x_1 = 0.1$, $x_2 = 0.02$, $\\mu_F = 100\\ \\mathrm{GeV}$\n- $f_u^A(x_1, \\mu_F) = 2.70$\n- $f_{\\bar{u}}^A(x_2, \\mu_F) = 0.25$\n- $f_u^B(x_1, \\mu_F) = 2.35$\n- $f_{\\bar{u}}^B(x_2, \\mu_F) = 0.27$\n\n重加权因子 $R$ 为：\n$$\nR = \\frac{(2.35) \\times (0.27)}{(2.70) \\times (0.25)} = \\frac{0.6345}{0.675}\n$$\n计算此值得：\n$$\nR = 0.94\n$$\n问题要求答案四舍五入到四位有效数字。因此，$R = 0.9400$。\n\n第二部分：Hessian PDF不确定性传播的解释。\n\n任务的第二部分是从第一性原理出发，解释如何使用Hessian本征矢量集来传播PDF不确定性。\n\n一个现代的PDF集，例如遵循Hessian方法的PDF集，不仅提供一个中心（最佳拟合）PDF，记为 $S_0$，还提供 $N$ 对“本征矢量”集 $\\{(S_k^+, S_k^-)\\}_{k=1}^N$ 的集合。这些本征矢量集代表了在用于PDF确定的多维参数空间中，沿着 $N$ 个正交方向偏离中心拟合的系统性偏移。每一对 $(S_k^+, S_k^-)$ 对应于沿着第 $k$ 个本征矢量的 $\\pm 1\\sigma$ 偏差。\n\n将这些不确定性传播到一个预测的可观测量 $\\mathcal{O}$ 的过程依赖于逐事件重加权，其遵循在第一部分中推导出的相同原理。让我们假设已经使用中心PDF集 $S_0$ 生成了一个包含 $M$ 个蒙特卡洛事件的大样本。每个事件 $e$（对于 $e=1, \\dots, M$）都有一个权重 $w_{0,e}$ 和所讨论的可观测量的值 $\\mathcal{O}_e$。使用中心PDF集对该可观测量的预测是加权平均值：\n$$\n\\langle \\mathcal{O} \\rangle_0 = \\frac{\\sum_{e=1}^M w_{0,e} \\mathcal{O}_e}{\\sum_{e=1}^M w_{0,e}}\n$$\n为了确定PDF不确定性的影响，不需要为 $2N$ 个本征矢量集中的每一个都生成新的事件样本。相反，可以为每个事件计算 $2N$ 个新权重。对于具有动量分数 $(x_{1,e}, x_{2,e})$ 的初态部分子 $i,j$ 的单个事件 $e$，从中心集 $S_0$ 到本征矢量集 $S_k^\\pm$ 的重加权因子是：\n$$\nR_{k,e}^\\pm = \\frac{f_i^{(k,\\pm)}(x_{1,e}, \\mu_F) f_j^{(k,\\pm)}(x_{2,e}, \\mu_F)}{f_i^{(0)}(x_{1,e}, \\mu_F) f_j^{(0)}(x_{2,e}, \\mu_F)}\n$$\n对应于PDF集 $S_k^\\pm$ 的事件 $e$ 的新权重是 $w_{k,e}^\\pm = w_{0,e} \\times R_{k,e}^\\pm$。使用这些新权重，可以计算每个本征矢量集预测的可观测量 $\\mathcal{O}$ 的值：\n$$\n\\langle \\mathcal{O} \\rangle_k^\\pm = \\frac{\\sum_{e=1}^M w_{k,e}^\\pm \\mathcal{O}_e}{\\sum_{e=1}^M w_{k,e}^\\pm}\n$$\n这个过程产生一个中心值 $\\langle \\mathcal{O} \\rangle_0$ 和 $2N$ 个系统性变化量，即 $\\langle \\mathcal{O} \\rangle_k^+$ 和 $\\langle \\mathcal{O} \\rangle_k^-$，其中 $k=1, \\dots, N$。\n\n最后一步是将这些变化组合成一个单一的总不确定度。Hessian形式体系为此提供了一个主公式。因为本征矢量在PDF拟合的参数空间中是正交构建的，所以它们对总不确定度的贡献可以进行正交相加（即平方和求根）。总PDF不确定度 $\\Delta \\mathcal{O}$ 的对称公式是：\n$$\n(\\Delta\\mathcal{O})^2 = \\sum_{k=1}^N \\left( \\frac{\\langle \\mathcal{O} \\rangle_k^+ - \\langle \\mathcal{O} \\rangle_k^-}{2} \\right)^2\n$$\n项 $(\\langle \\mathcal{O} \\rangle_k^+ - \\langle \\mathcal{O} \\rangle_k^-)/2$ 代表了可观测量 $\\mathcal{O}$ 沿着第 $k$ 个本征矢量方向作 $+1\\sigma$ 移动时的变化。将这些变化量进行正交相加，就得到了由所有PDF参数的不确定性引起的总方差。也存在非对称公式来处理向上和向下变化不对称的情况，但组合正交贡献的原理保持不变。这种重加权技术计算效率很高，因为它允许从单个中心生成的事件样本中估算PDF不确定性。",
            "answer": "$$\n\\boxed{0.9400}\n$$"
        },
        {
            "introduction": "在掌握了重加权的基本原理之后，本实践将引导您应对现代高精度模拟中的一个关键挑战。在次领头阶（NLO）计算中，为了精确描述物理过程，不可避免地会引入带有负权重的事例，这可能导致预测结果的统计方差急剧增大。本练习将深入探讨有效样本量（$N_{\\text{eff}}$）的概念，这是一个诊断和量化此问题的核心指标。通过一个具体的计算案例，您将亲身体验如何评估权重变化对统计精度的影响，并学习在实际分析中保持统计稳定性的系统性策略。",
            "id": "3532093",
            "problem": "您正在对一个带有部分子簇射的次领头阶 (NLO) 事件生成器进行参数重加权和调优。在参考参数值 $\\theta_{0}$ 下生成了一个包含 $N$ 个事件的蒙特卡洛 (MC) 样本，其带符号的基础事件权重为 $\\{w_{i}^{(0)}\\}_{i=1}^{N}$，其中包含了来自相减项的负权重。您考虑进行一次微小的重新调优，将其调整到一个邻近值 $\\theta$，并使用一阶线性响应模型 $r_{i}(\\theta)=1+a_{i}(\\theta-\\theta_{0})$ 来近似每个事件的重加权因子，其中敏感度 $a_{i}$ 是依赖于事件且已知的。重加权后的事件权重为 $w_{i}=w_{i}^{(0)}\\,r_{i}(\\theta)$，在 $\\theta$ 处的总截面估计量是加权和 $\\hat{\\sigma}=\\sum_{i=1}^{N} w_{i}$。假设事件是独立的，并且加权和的标准 MC 方差估计方法适用。\n\n仅从以下基本原理出发：\n- 对于独立事件，加权和估计量的定义为 $\\hat{\\sigma}=\\sum_{i=1}^{N} w_{i}$。\n- 在标准 MC 抽样假设下，独立加权和估计量的方差为 $\\mathrm{Var}(\\hat{\\sigma})=\\sum_{i=1}^{N} w_{i}^{2}$，这是一个经过充分检验的事实。\n- 有效样本量 $N_{\\text{eff}}$ 的定义为：一个等效的、能产生相同相对统计不确定度的未加权样本的大小，这意味着 $N_{\\text{eff}}=(\\sum_{i=1}^{N} w_{i})^{2}/\\sum_{i=1}^{N} w_{i}^{2}$，且相对统计不确定度为 $u_{\\text{rel}}=\\sqrt{\\mathrm{Var}(\\hat{\\sigma})}/|\\hat{\\sigma}|$。\n\n考虑一个具体样本，其中 $N=10$，参数偏移 $\\theta-\\theta_{0}=0.1$，以及以下每个事件的数据：\n- 事件 $1$：$w_{1}^{(0)}=1.2$, $a_{1}=0.05$。\n- 事件 $2$：$w_{2}^{(0)}=0.8$, $a_{2}=0.10$。\n- 事件 $3$：$w_{3}^{(0)}=-0.6$, $a_{3}=0.20$。\n- 事件 $4$：$w_{4}^{(0)}=0.5$, $a_{4}=-0.15$。\n- 事件 $5$：$w_{5}^{(0)}=-1.0$, $a_{5}=0.05$。\n- 事件 $6$：$w_{6}^{(0)}=2.0$, $a_{6}=0.00$。\n- 事件 $7$：$w_{7}^{(0)}=1.1$, $a_{7}=-0.10$。\n- 事件 $8$：$w_{8}^{(0)}=-0.9$, $a_{8}=0.15$。\n- 事件 $9$：$w_{9}^{(0)}=0.7$, $a_{9}=0.05$。\n- 事件 $10$：$w_{10}^{(0)}=-0.4$, $a_{10}=-0.20$。\n\n任务：\n1. 对所有 $i$ 计算重加权后的权重 $w_{i}=w_{i}^{(0)}\\,[1+a_{i}(\\theta-\\theta_{0})]$，然后计算在 $\\theta$ 处 $\\hat{\\sigma}$ 的有效样本量 $N_{\\text{eff}}$ 和相对统计不确定度 $u_{\\text{rel}}=\\sqrt{\\sum_{i=1}^{N} w_{i}^{2}}/\\left|\\sum_{i=1}^{N} w_{i}\\right|$。将 $N_{\\text{eff}}$ 报告为纯数，将 $u_{\\text{rel}}$ 报告为小数。\n2. 根据上述定义，简要证明为什么 $N_{\\text{eff}}=(\\sum_{i} w_{i})^{2}/\\sum_{i} w_{i}^{2}$，以及为什么在 $\\sum_{i} w_{i}^{2}$ 固定的情况下，负权重倾向于减小 $N_{\\text{eff}}$。\n3. 识别并解释至少三种有原则的策略，这些策略可以在存在带符号权重的情况下，在重加权和调优时缓解方差爆炸问题，并确保每种策略都与保持目标可观测量的无偏性兼容。\n\n将 $N_{\\text{eff}}$ 和 $u_{\\text{rel}}$ 均四舍五入至四位有效数字。将最终答案表示为行向量 $\\big(N_{\\text{eff}},\\,u_{\\text{rel}}\\big)$，无单位，其中 $u_{\\text{rel}}$ 是一个纯数（小数）。",
            "solution": "该问题要求进行与次领头阶 (NLO) 蒙特卡洛事件生成器中的参数重加权相关的计算和概念性解释。该问题被确认为自洽的、有科学依据且定义明确的。我们将按顺序处理这三个任务。\n\n首先，我们处理任务1：计算重加权后的权重 $w_i$、有效样本量 $N_{\\text{eff}}$ 和相对统计不确定度 $u_{\\text{rel}}$。\n\n给定的参数偏移为 $\\theta - \\theta_0 = 0.1$。每个事件 $i$ 的重加权因子使用提供的一阶线性响应模型计算：$r_i(\\theta) = 1 + a_i(\\theta - \\theta_0) = 1 + a_i \\times 0.1$。然后，重加权后的权重为 $w_i = w_i^{(0)} r_i(\\theta)$。\n\n我们为 $N=10$ 个事件中的每一个计算重加权后的权重 $w_i$：\n- 事件 $1$：$r_1 = 1 + 0.05 \\times 0.1 = 1.005$。$w_1 = 1.2 \\times 1.005 = 1.206$。\n- 事件 $2$：$r_2 = 1 + 0.10 \\times 0.1 = 1.01$。$w_2 = 0.8 \\times 1.01 = 0.808$。\n- 事件 $3$：$r_3 = 1 + 0.20 \\times 0.1 = 1.02$。$w_3 = -0.6 \\times 1.02 = -0.612$。\n- 事件 $4$：$r_4 = 1 - 0.15 \\times 0.1 = 0.985$。$w_4 = 0.5 \\times 0.985 = 0.4925$。\n- 事件 $5$：$r_5 = 1 + 0.05 \\times 0.1 = 1.005$。$w_5 = -1.0 \\times 1.005 = -1.005$。\n- 事件 $6$：$r_6 = 1 + 0.00 \\times 0.1 = 1.00$。$w_6 = 2.0 \\times 1.00 = 2.0$。\n- 事件 $7$：$r_7 = 1 - 0.10 \\times 0.1 = 0.99$。$w_7 = 1.1 \\times 0.99 = 1.089$。\n- 事件 $8$：$r_8 = 1 + 0.15 \\times 0.1 = 1.015$。$w_8 = -0.9 \\times 1.015 = -0.9135$。\n- 事件 $9$：$r_9 = 1 + 0.05 \\times 0.1 = 1.005$。$w_9 = 0.7 \\times 1.005 = 0.7035$。\n- 事件 $10$：$r_{10} = 1 - 0.20 \\times 0.1 = 0.98$。$w_{10} = -0.4 \\times 0.98 = -0.392$。\n\n接下来，我们计算重加权后权重的和 $\\sum_{i=1}^{N} w_i$ 以及它们平方的和 $\\sum_{i=1}^{N} w_i^2$。\n权重的和为：\n$$ \\hat{\\sigma} = \\sum_{i=1}^{10} w_i = 1.206 + 0.808 - 0.612 + 0.4925 - 1.005 + 2.0 + 1.089 - 0.9135 + 0.7035 - 0.392 = 3.3765 $$\n权重平方的和为：\n$$ \\sum_{i=1}^{10} w_i^2 = (1.206)^2 + (0.808)^2 + (-0.612)^2 + (0.4925)^2 + (-1.005)^2 + (2.0)^2 + (1.089)^2 + (-0.9135)^2 + (0.7035)^2 + (-0.392)^2 $$\n$$ \\sum_{i=1}^{10} w_i^2 = 1.454436 + 0.652864 + 0.374544 + 0.24255625 + 1.010025 + 4.0 + 1.185921 + 0.83448225 + 0.49491225 + 0.153664 \\approx 10.403405 $$\n\n现在我们可以计算 $N_{\\text{eff}}$ 和 $u_{\\text{rel}}$。\n使用提供的有效样本量公式：\n$$ N_{\\text{eff}} = \\frac{(\\sum_{i=1}^{N} w_i)^2}{\\sum_{i=1}^{N} w_i^2} = \\frac{(3.3765)^2}{10.403405} = \\frac{11.40073225}{10.403405} \\approx 1.095866 $$\n四舍五入到四位有效数字，$N_{\\text{eff}} = 1.096$。\n\n相对统计不确定度由下式给出：\n$$ u_{\\text{rel}} = \\frac{\\sqrt{\\sum_{i=1}^{N} w_i^2}}{\\left|\\sum_{i=1}^{N} w_i\\right|} = \\frac{\\sqrt{10.403405}}{|3.3765|} \\approx \\frac{3.225431}{3.3765} \\approx 0.955255 $$\n四舍五入到四位有效数字，$u_{\\text{rel}} = 0.9553$。\n作为一致性检验，我们可以验证 $u_{\\text{rel}} \\approx 1/\\sqrt{N_{\\text{eff}}}$。确实，$1/\\sqrt{1.095866} \\approx 0.955255$，这与我们计算出的 $u_{\\text{rel}}$ 结果相符。\n\n其次，我们处理任务2：证明 $N_{\\text{eff}}$ 的公式以及负权重的影响。\n\n对 $N_{\\text{eff}} = (\\sum w_i)^2 / \\sum w_i^2$ 的证明始于其定义：$N_{\\text{eff}}$ 是一个等效的、能产生相同相对统计不确定度的未加权样本的大小。\n让我们考虑一个大小为 $N_{\\text{eff}}$ 的未加权样本。未加权样本意味着所有事件具有相同的权重。设总截面估计量为 $\\hat{\\sigma}$。那么 $N_{\\text{eff}}$ 个事件中的每一个都具有权重 $w' = \\hat{\\sigma}/N_{\\text{eff}}$。其估计量为 $\\sum_{i=1}^{N_{\\text{eff}}} w' = N_{\\text{eff}} \\times (\\hat{\\sigma}/N_{\\text{eff}}) = \\hat{\\sigma}$。该估计量的方差为 $\\sum_{i=1}^{N_{\\text{eff}}} (w')^2 = N_{\\text{eff}} \\times (\\hat{\\sigma}/N_{\\text{eff}})^2 = \\hat{\\sigma}^2/N_{\\text{eff}}$。因此，这个未加权样本的相对不确定度为 $u'_{\\text{rel}} = \\sqrt{\\text{Var}} / |\\hat{\\sigma}| = \\sqrt{\\hat{\\sigma}^2/N_{\\text{eff}}} / |\\hat{\\sigma}| = 1/\\sqrt{N_{\\text{eff}}}$。\n对于原始的加权样本，相对不确定度由 $u_{\\text{rel}} = \\sqrt{\\sum w_i^2} / |\\sum w_i|$ 给出。\n令相对不确定度相等，$u'_{\\text{rel}} = u_{\\text{rel}}$，我们得到 $1/\\sqrt{N_{\\text{eff}}} = \\sqrt{\\sum w_i^2} / |\\sum w_i|$。两边平方得到 $1/N_{\\text{eff}} = (\\sum w_i^2) / (\\sum w_i)^2$。对此表达式求倒数，即可得到所需的公式：$N_{\\text{eff}} = (\\sum w_i)^2 / \\sum w_i^2$。\n\n在权重平方和 $\\sum w_i^2$ 固定的情况下，负权重倾向于减小 $N_{\\text{eff}}$。$N_{\\text{eff}}$ 的公式中，分母是平方和 $\\sum w_i^2$，分子是和的平方 $(\\sum w_i)^2$。项 $\\sum w_i^2$ 始终是非负的。对于固定的分母值，$N_{\\text{eff}}$ 通过最大化分子 $(\\sum w_i)^2$ 来实现最大化。\n当一些权重 $w_i$ 为正而另一些为负时，在求和 $\\sum w_i$ 时会发生抵消。根据三角不等式，有 $|\\sum w_i| \\leq \\sum |w_i|$。对于一个符号混合的权重集合，这个不等式通常是严格的，即 $|\\sum w_i|  \\sum |w_i|$。\n如果我们考虑一个权重为 $w'_i = |w_i|$ 的假设样本，它的权重平方和是相同的，即 $\\sum (w'_i)^2 = \\sum |w_i|^2 = \\sum w_i^2$。然而，它的权重和是 $\\sum w'_i = \\sum |w_i|$。\n由于 $|\\sum w_i|  \\sum |w_i|$，因此 $(\\sum w_i)^2  (\\sum |w_i|)^2$。\n因此，与一个所有权重都取正值的样本相比，含有负权重的样本的分子 $(\\sum w_i)^2$ 会更小，而分母 $\\sum w_i^2$ 保持不变。这导致了更小的 $N_{\\text{eff}}$。更小的 $N_{\\text{eff}}$ 意味着更大的相对统计不确定度 $u_{\\text{rel}} \\approx 1/\\sqrt{N_{\\text{eff}}}$。\n\n第三，我们处理任务3：识别三种在保持无偏性的同时缓解方差爆炸的有原则的策略。\n\n1.  **优化匹配和簇射参数**：在带部分子簇射的NLO (NLO+PS) 生成器中，大的正权重和负权重通常源于固定阶实发射矩阵元与部分子簇射对其近似之间的失配。通过调整控制硬过程与软/共线区域分离的参数（例如，簇射起始标度，在POWHEG中常称为 `hdamp`），可以实现更平滑的过渡。这会减小相减项的大小，从而从一开始就减小所得带符号权重 $|w_i^{(0)}|$ 的绝对值。对于给定的总截面 $\\sum w_i$，这直接减小了平方和 $\\sum w_i^2$，从而增加了 $N_{\\text{eff}}$。此过程与无偏性兼容，因为这些参数是匹配执行方式定义的一部分；更改它们对应于一种不同但形式上同等有效的方案，用于将NLO计算与簇射结合起来。积分截面保持无偏。\n\n2.  **定义基准相空间**：大权重经常在相空间的极端区域产生，在这些区域，理论模型可能不太可靠（例如，非常高的横向动量），或者这些区域位于实验分析的接受度之外。一个标准策略是通过对末态粒子的运动学（例如，对动量和赝快度）施加截断来定义一个基准体积。落在此体积之外的事件将被丢弃。这从物理上移除了用于分析和调优的样本中产生最大权重的来源。因此，方差得到了控制。这对*基准截面*保持了无偏性，而基准截面几乎是所有理论与实验比较中都关注的量。基准截面的估计量保持无偏。\n\n3.  **增大蒙特卡洛样本的大小**：有效样本量 $N_{\\text{eff}}$ 与生成的总事件数 $N$ 成正比。具体而言，$N_{\\text{eff}} \\approx N \\cdot (\\langle w \\rangle^2 / \\langle w^2 \\rangle)$，其中 $\\langle w \\rangle$ 和 $\\langle w^2 \\rangle$ 是权重和权重平方的样本平均值。对于给定的权重分布，将生成的事件数 $N$ 加倍，平均而言会使 $N_{\\text{eff}}$ 加倍。这反过来又将相对统计不确定度 $u_{\\text{rel}} \\approx 1/\\sqrt{N_{\\text{eff}}}$ 减小一个因子 $1/\\sqrt{2}$。虽然计算成本高昂，但这种“暴力”方法是提高统计精度的最基本方式。它内在地是无偏的，并且当其他改善权重分布的方法不足时，可作为最终手段。",
            "answer": "$$\\boxed{\\begin{pmatrix} 1.096  0.9553 \\end{pmatrix}}$$"
        },
        {
            "introduction": "本章的最后一个实践将带您探索事件产生器参数调优的前沿领域，在这里，传统的重加权方法正被机器学习领域的技术所补充和革新。我们将构建一个部分子簇射（parton shower）的可微代理模型，这使我们能够利用自动微分（autodiff）直接计算参数梯度。通过将这种“路径梯度”（pathwise gradient）与依赖于重加权的经典有限差分方法进行基准比较，您将深入理解如何将基于梯度的优化方法应用于复杂的物理模拟中，这是一个正在为参数调优和不确定性量化带来革命性变化的强大范式。",
            "id": "3532058",
            "problem": "考虑一个单次辐射部分子簇射可观测量的可微代理，该代理将可调参数 $\\theta$ 映射到关于辐射动量分数 $x \\in (0,1)$ 的软分箱直方图的箱产额 $y_b(\\theta)$。使用以下纯数学构造和定义。\n\n1. 基础噪声与重参数化：设 $\\xi_i \\sim \\mathcal{N}(0,s^2)$ 对于 $i = 1,\\dots,N$ 是独立同分布的。通过重参数化定义辐射变量\n$$\nx_i(\\theta) = \\sigma\\big(\\theta + \\xi_i\\big), \\quad \\text{其中 } \\sigma(t) = \\frac{1}{1 + e^{-t}}。\n$$\n这将在 $x \\in (0,1)$ 上产生一个依赖于 $\\theta$ 的分布，该分布对于 $\\theta$ 是可微的。\n\n2. 代理权重与软分箱：定义一个类似于夸克到夸克胶子分裂核的正则化代理权重，\n$$\nw(x) = \\frac{1 + (1 - x)^2}{x + \\varepsilon},\n$$\n其中正则化子 $\\varepsilon  0$。对于区间 $b = [\\ell_b,u_b] \\subset [0,1]$ 上的软分箱，使用一个可微指示函数\n$$\nK_b(x) = \\sigma\\big(k(x - \\ell_b)\\big) - \\sigma\\big(k(x - u_b)\\big),\n$$\n其中锐度参数 $k  0$。\n\n3. 分箱产额：将参数 $\\theta$ 处的箱产额定义为蒙特卡洛（MC; Monte Carlo）估计量\n$$\ny_b(\\theta) = \\frac{1}{N} \\sum_{i=1}^N w\\big(x_i(\\theta)\\big)\\,K_b\\big(x_i(\\theta)\\big).\n$$\n\n任务：\nA. 使用由重参数化 $x_i(\\theta) = \\sigma(\\theta+\\xi_i)$ 导出的路径梯度，构建 $\\frac{\\partial y_b}{\\partial \\theta}$ 的自动微分 (autodiff) 计算，在对 $\\theta$ 求导时保持相同的基础噪声样本 $\\{\\xi_i\\}_{i=1}^N$ 固定。\n\nB. 构建一个基于事件重加权的有限差分梯度估计。在基线参数 $\\theta_0$ 处抽取单个事件样本 $\\{x_i(\\theta_0)\\}_{i=1}^N$。对于任何 $\\theta$，通过一个重加权估计量来表示 $y_b(\\theta)$\n$$\ny_b(\\theta) \\approx \\frac{1}{N} \\sum_{i=1}^N r_i(\\theta;\\theta_0)\\,w\\big(x_i(\\theta_0)\\big)\\,K_b\\big(x_i(\\theta_0)\\big),\n$$\n其中 $r_i(\\theta;\\theta_0)$ 是从变量替换关系 $t = \\mathrm{logit}(x)$（其中 $t \\sim \\mathcal{N}(\\theta,s^2)$）推导出的似然比 $p(x_i|\\theta)/p(x_i|\\theta_0)$。在 $\\theta_0$ 处使用步长为 $\\Delta$ 的中心有限差分：\n$$\n\\left.\\frac{\\partial y_b}{\\partial \\theta}\\right|_{\\theta=\\theta_0} \\approx \\frac{y_b(\\theta_0+\\Delta) - y_b(\\theta_0-\\Delta)}{2\\Delta},\n$$\n其中 $y_b(\\theta_0 \\pm \\Delta)$ 都是通过对同一个固定样本 $\\{x_i(\\theta_0)\\}_{i=1}^N$ 进行重加权来计算的。\n\nC. 通过计算每个测试用例中所有分箱上的最大绝对差异，对自动微分梯度与有限差分重加权梯度进行基准比较：\n$$\nD = \\max_{b} \\left| \\left.\\frac{\\partial y_b}{\\partial \\theta}\\right|_{\\text{autodiff},\\,\\theta_0} - \\left.\\frac{\\partial y_b}{\\partial \\theta}\\right|_{\\text{FD-reweight},\\,\\theta_0} \\right|.\n$$\n\n实现说明：\n- 所有计算必须通过固定随机种子来确保其确定性。\n- 必须正确处理在 $t = \\mathrm{logit}(x)$ 变换下密度 $p(x|\\theta)$ 的雅可比因子；从第一性原理推导出显式比率 $r_i(\\theta;\\theta_0)$。\n\n测试套件：\n使用一个在 $[0,1]$ 区间上具有 $5$ 个分箱 $b$ 的直方图，其边界为 $[0.0,0.2,0.4,0.6,0.8,1.0]$，并采用以下测试用例，每个用例指定 $(N,s,\\theta_0,\\Delta,k,\\varepsilon,$ seed$)$：\n1. $(N = 5000, s = 1.0, \\theta_0 = 0.5, \\Delta = 0.05, k = 20.0, \\varepsilon = 10^{-3}, \\text{seed} = 1234)$\n2. $(N = 5000, s = 1.0, \\theta_0 = -3.0, \\Delta = 0.05, k = 25.0, \\varepsilon = 10^{-3}, \\text{seed} = 5678)$\n3. $(N = 5000, s = 1.0, \\theta_0 = 3.0, \\Delta = 0.05, k = 25.0, \\varepsilon = 10^{-3}, \\text{seed} = 9012)$\n4. $(N = 5000, s = 0.2, \\theta_0 = 0.0, \\Delta = 0.02, k = 15.0, \\varepsilon = 10^{-3}, \\text{seed} = 3456)$\n5. $(N = 5000, s = 2.0, \\theta_0 = 0.0, \\Delta = 0.02, k = 10.0, \\varepsilon = 10^{-3}, \\text{seed} = 7890)$\n\n要求的最终输出格式：\n您的程序应生成单行输出，其中包含一个由方括号括起来的逗号分隔列表（例如，“$[r_1,r_2,\\dots,r_5]$”），$r_i$ 是测试用例 $i$ 的 $D$ 值的浮点数，顺序与上面列出的完全一致。所有值都是无量纲实数。",
            "solution": "用户提供了一个来自计算高能物理领域的问题，内容是关于比较计算分箱可观测量的蒙特卡洛估计量梯度的两种方法。这两种方法，一种基于自动微分（autodiff），另一种基于事件重加权的有限差分，都是物理模拟可微编程领域的标准技术。\n\n### 第一步：提取给定条件\n\n- **基础噪声与重参数化**：\n    - 噪声变量：$\\xi_i \\sim \\mathcal{N}(0,s^2)$ 对于 $i = 1,\\dots,N$，独立同分布。\n    - 辐射变量：$x_i(\\theta) = \\sigma(\\theta + \\xi_i)$\n    - Sigmoid 函数：$\\sigma(t) = \\frac{1}{1 + e^{-t}}$\n\n- **代理权重与软分箱**：\n    - 正则化权重函数：$w(x) = \\frac{1 + (1 - x)^2}{x + \\varepsilon}$，其中 $\\varepsilon  0$。\n    - 可微分箱指示函数：$K_b(x) = \\sigma(k(x - \\ell_b)) - \\sigma(k(x - u_b))$ 对于分箱 $b = [\\ell_b, u_b]$，其中锐度 $k  0$。\n\n- **分箱产额**：\n    - 分箱产额的蒙特卡洛估计量：$y_b(\\theta) = \\frac{1}{N} \\sum_{i=1}^N w(x_i(\\theta))\\,K_b(x_i(\\theta))$。\n\n- **任务 A：自动微分（路径）梯度**：\n    - 使用路径梯度计算 $\\frac{\\partial y_b}{\\partial \\theta}$，保持基础噪声样本 $\\{\\xi_i\\}_{i=1}^N$ 固定。\n\n- **任务 B：有限差分重加权梯度**：\n    - 在基线参数 $\\theta_0$ 处生成一个样本 $\\{x_i(\\theta_0)\\}_{i=1}^N$。\n    - 使用重加权估计量表示 $y_b(\\theta)$：$y_b(\\theta) \\approx \\frac{1}{N} \\sum_{i=1}^N r_i(\\theta;\\theta_0)\\,w(x_i(\\theta_0))\\,K_b(x_i(\\theta_0))$。\n    - 重加权因子 $r_i(\\theta;\\theta_0)$ 是似然比 $p(x_i|\\theta)/p(x_i|\\theta_0)$，从关系 $t = \\mathrm{logit}(x)$（其中 $t \\sim \\mathcal{N}(\\theta,s^2)$）推导。\n    - 使用步长为 $\\Delta$ 的中心有限差分在 $\\theta_0$ 处估计梯度：$\\left.\\frac{\\partial y_b}{\\partial \\theta}\\right|_{\\theta=\\theta_0} \\approx \\frac{y_b(\\theta_0+\\Delta) - y_b(\\theta_0-\\Delta)}{2\\Delta}$。\n\n- **任务 C：基准测试**：\n    - 计算最大绝对差异：$D = \\max_{b} \\left| \\left.\\frac{\\partial y_b}{\\partial \\theta}\\right|_{\\text{autodiff},\\,\\theta_0} - \\left.\\frac{\\partial y_b}{\\partial \\theta}\\right|_{\\text{FD-reweight},\\,\\theta_0} \\right|$。\n\n- **数值参数**：\n    - 直方图分箱：在 $[0,1]$ 上有 5 个分箱，边界为 $[0.0,0.2,0.4,0.6,0.8,1.0]$。\n    - 测试用例 $(N,s,\\theta_0,\\Delta,k,\\varepsilon, \\text{seed})$：\n        1. $(5000, 1.0, 0.5, 0.05, 20.0, 10^{-3}, 1234)$\n        2. $(5000, 1.0, -3.0, 0.05, 25.0, 10^{-3}, 5678)$\n        3. $(5000, 1.0, 3.0, 0.05, 25.0, 10^{-3}, 9012)$\n        4. $(5000, 0.2, 0.0, 0.02, 15.0, 10^{-3}, 3456)$\n        5. $(5000, 2.0, 0.0, 0.02, 10.0, 10^{-3}, 7890)$\n\n### 第二步：使用提取的给定条件进行验证\n\n- **科学依据充分**：该问题是一个定义明确的数学练习，基于计算高能物理中使用的概念，特别是蒙特卡洛事件生成、重加权技术和可微编程。函数和分布是真实物理过程（如部分子分裂）和统计方法的抽象。它在科学上是合理的。\n- **适定性**：所有函数、变量、常数和目标都已明确定义。对于每个测试用例，给定固定的随机种子，任务将导向唯一的数值结果。该设置是确定性和可解的。\n- **客观性**：语言精确且数学化。所有指令都清晰明确。\n- 该问题是自洽的，不包含任何矛盾、不完整或不切实际的信息。所提供的参数都在合理的数值范围内。该任务是两种数值微分技术之间的标准基准测试。\n\n### 第三步：结论与行动\n\n问题陈述是**有效的**。将提供一个解决方案。\n\n### 基于原理的解决方案设计\n\n该解决方案需要实现并比较两种梯度估计方法。\n\n**A. 自动微分（路径）梯度计算**\n\n路径梯度估计器通过样本的生成过程来传播导数。分箱产额为 $y_b(\\theta) = \\frac{1}{N} \\sum_{i=1}^N f_b(x_i(\\theta))$，其中 $f_b(x) = w(x)K_b(x)$。关于 $\\theta$ 的导数可以通过应用链式法则找到：\n$$\n\\frac{\\partial y_b}{\\partial \\theta} = \\frac{1}{N} \\sum_{i=1}^N \\frac{\\partial f_b(x)}{\\partial x}\\bigg|_{x=x_i(\\theta)} \\frac{\\partial x_i(\\theta)}{\\partial \\theta}\n$$\n各分量导数如下：\n1.  **可观测量项 $f_b(x)$ 的导数**：使用乘法法则，\n    $$\n    \\frac{\\partial f_b(x)}{\\partial x} = \\frac{\\partial w(x)}{\\partial x} K_b(x) + w(x) \\frac{\\partial K_b(x)}{\\partial x}\n    $$\n    $w(x)$ 和 $K_b(x)$ 的导数是：\n    $$\n    \\frac{\\partial w}{\\partial x} = \\frac{ \\frac{d}{dx}\\left(1+(1-x)^2\\right) (x+\\varepsilon) - \\left(1+(1-x)^2\\right) \\frac{d}{dx}(x+\\varepsilon) }{ (x+\\varepsilon)^2 } = \\frac{ -2(1-x)(x+\\varepsilon) - \\left(1+(1-x)^2\\right) }{ (x+\\varepsilon)^2 }\n    $$\n    $$\n    \\frac{\\partial K_b}{\\partial x} = k \\sigma'\\left(k(x - \\ell_b)\\right) - k \\sigma'\\left(k(x - u_b)\\right)\n    $$\n    其中 $\\sigma'(t) = \\sigma(t)(1-\\sigma(t))$ 是 sigmoid 函数的导数。\n\n2.  **重参数化 $x_i(\\theta)$ 的导数**：\n    $$\n    \\frac{\\partial x_i(\\theta)}{\\partial \\theta} = \\frac{\\partial}{\\partial \\theta} \\sigma(\\theta + \\xi_i) = \\sigma'(\\theta + \\xi_i) \\cdot \\frac{\\partial}{\\partial \\theta}(\\theta + \\xi_i) = \\sigma'(\\theta + \\xi_i) = \\sigma(\\theta+\\xi_i)(1-\\sigma(\\theta+\\xi_i))\n    $$\n    注意到 $x_i(\\theta) = \\sigma(\\theta+\\xi_i)$，这可以简化为 $\\frac{\\partial x_i(\\theta)}{\\partial \\theta} = x_i(\\theta)(1-x_i(\\theta))$。\n\n然后，通过在 $\\theta = \\theta_0$ 处对样本 $\\{\\xi_i\\}_{i=1}^N$ 进行平均，来数值计算自动微分梯度。\n\n**B. 有限差分重加权梯度计算**\n\n此方法依赖于在固定参数 $\\theta_0$ 处生成单个样本，然后通过重加权来估计在不同参数 $\\theta$ 处的期望值。在 $\\theta$ 处的产额估计为：\n$$\ny_b(\\theta) = \\mathbb{E}_{p(x|\\theta)}[f_b(x)] = \\int f_b(x) p(x|\\theta) dx = \\int f_b(x) \\frac{p(x|\\theta)}{p(x|\\theta_0)} p(x|\\theta_0) dx = \\mathbb{E}_{p(x|\\theta_0)}\\left[f_b(x) \\frac{p(x|\\theta)}{p(x|\\theta_0)}\\right]\n$$\n对此的蒙特卡洛估计量就是给定的重加权公式，其中 $r_i(\\theta;\\theta_0) = \\frac{p(x_i|\\theta)}{p(x_i|\\theta_0)}$ 是似然比。\n\n为了找到 $r_i$，我们首先需要概率密度函数 $p(x|\\theta)$。问题陈述 $t = \\mathrm{logit}(x)$ 从正态分布 $t \\sim \\mathcal{N}(\\theta, s^2)$ 中抽取，其概率密度函数 (PDF) 为 $p_t(t|\\theta) = \\frac{1}{\\sqrt{2\\pi s^2}} \\exp\\left(-\\frac{(t-\\theta)^2}{2s^2}\\right)$。使用 PDF 的变量替换公式，$p_x(x|\\theta) = p_t(t(x)|\\theta) |\\frac{dt}{dx}|$。\n变换为 $t(x) = \\mathrm{logit}(x) = \\ln(\\frac{x}{1-x})$。其导数为 $\\frac{dt}{dx} = \\frac{1}{x} + \\frac{1}{1-x} = \\frac{1}{x(1-x)}$。\n$x$ 的 PDF 因此为：\n$$\np(x|\\theta) = \\frac{1}{\\sqrt{2\\pi s^2}} \\exp\\left(-\\frac{(\\mathrm{logit}(x)-\\theta)^2}{2s^2}\\right) \\frac{1}{x(1-x)}\n$$\n对于一个事件 $x_i$（从 $p(x|\\theta_0)$ 中抽样得到），其似然比为：\n$$\nr_i(\\theta;\\theta_0) = \\frac{p(x_i|\\theta)}{p(x_i|\\theta_0)} = \\frac{\\exp\\left(-\\frac{(\\mathrm{logit}(x_i)-\\theta)^2}{2s^2}\\right)}{\\exp\\left(-\\frac{(\\mathrm{logit}(x_i)-\\theta_0)^2}{2s^2}\\right)} = \\exp\\left( \\frac{(\\mathrm{logit}(x_i)-\\theta_0)^2 - (\\mathrm{logit}(x_i)-\\theta)^2}{2s^2} \\right)\n$$\n简化指数部分可得：\n$$\nr_i(\\theta; \\theta_0) = \\exp\\left( \\frac{2(\\theta - \\theta_0)\\mathrm{logit}(x_i) - (\\theta^2 - \\theta_0^2)}{2s^2} \\right)\n$$\n然后使用中心有限差分公式估计梯度，其中在 $\\theta_0 \\pm \\Delta$ 处的产额是通过对在 $\\theta_0$ 处生成的固定事件样本进行重加权来计算的。\n\n**C. 基准测试**\n\n最后一步是计算梯度向量（每种方法一个向量，其分量对应于各个分箱）之间的逐元素绝对差，并找到最大值。这对给定的测试用例，量化了两种梯度估计方法在所有分箱上的最大不一致性。\n\n实现将遵循此逻辑，为提高效率使用向量化的 `numpy` 操作。为确保确定性，随机种子是固定的。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import expit, logit\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for all test cases.\n    \"\"\"\n\n    test_cases = [\n        # (N, s, theta_0, delta, k, epsilon, seed)\n        (5000, 1.0, 0.5, 0.05, 20.0, 1e-3, 1234),\n        (5000, 1.0, -3.0, 0.05, 25.0, 1e-3, 5678),\n        (5000, 1.0, 3.0, 0.05, 25.0, 1e-3, 9012),\n        (5000, 0.2, 0.0, 0.02, 15.0, 1e-3, 3456),\n        (5000, 2.0, 0.0, 0.02, 10.0, 1e-3, 7890),\n    ]\n\n    results = []\n    for case in test_cases:\n        discrepancy = _solve_case(*case)\n        results.append(discrepancy)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef _solve_case(N, s, theta_0, delta, k, epsilon, seed):\n    \"\"\"\n    Solves for a single test case and returns the maximum discrepancy D.\n    \"\"\"\n    \n    # Use scipy.special.expit for the sigmoid function for numerical stability.\n    sigmoid = expit\n    \n    def sigmoid_prime(t):\n        \"\"\"Derivative of the sigmoid function.\"\"\"\n        s_t = sigmoid(t)\n        return s_t * (1.0 - s_t)\n\n    def w_func(x, eps):\n        \"\"\"Regulated surrogate weight.\"\"\"\n        return (1.0 + (1.0 - x)**2) / (x + eps)\n\n    def w_prime_func(x, eps):\n        \"\"\"Derivative of the weight function w.r.t. x.\"\"\"\n        term1 = -2.0 * (1.0 - x) * (x + eps)\n        term2 = -(1.0 + (1.0 - x)**2)\n        return (term1 + term2) / (x + eps)**2\n\n    def k_b_func(x, lb, ub, sharpness):\n        \"\"\"Differentiable bin indicator.\"\"\"\n        return sigmoid(sharpness * (x - lb)) - sigmoid(sharpness * (x - ub))\n\n    def k_b_prime_func(x, lb, ub, sharpness):\n        \"\"\"Derivative of the bin indicator w.r.t. x.\"\"\"\n        term1 = sharpness * sigmoid_prime(sharpness * (x - lb))\n        term2 = -sharpness * sigmoid_prime(sharpness * (x - ub))\n        return term1 + term2\n\n    # Set random seed for determinism.\n    rng = np.random.default_rng(seed)\n\n    # Histogram bin edges.\n    bin_edges = np.array([0.0, 0.2, 0.4, 0.6, 0.8, 1.0])\n    bins = list(zip(bin_edges[:-1], bin_edges[1:]))\n\n    # Generate the base noise sample.\n    xi = rng.normal(loc=0.0, scale=s, size=N)\n\n    # --- Task A: Autodiff (Pathwise) Gradient ---\n    \n    # Compute x_i at theta_0 and its derivative w.r.t. theta.\n    t_at_theta_0 = theta_0 + xi\n    x_at_theta_0 = sigmoid(t_at_theta_0)\n    dx_dtheta_at_theta_0 = sigmoid_prime(t_at_theta_0)\n\n    autodiff_grads = []\n    for lb, ub in bins:\n        # Evaluate function components at x_i(theta_0).\n        w_val = w_func(x_at_theta_0, epsilon)\n        k_val = k_b_func(x_at_theta_0, lb, ub, k)\n        \n        # Evaluate derivative components.\n        w_prime_val = w_prime_func(x_at_theta_0, epsilon)\n        k_prime_val = k_b_prime_func(x_at_theta_0, lb, ub, k)\n\n        # Apply product rule for d/dx of the observable.\n        d_obs_dx = w_prime_val * k_val + w_val * k_prime_val\n        \n        # Apply chain rule for the full derivative w.r.t. theta for each event.\n        d_y_dtheta_i = d_obs_dx * dx_dtheta_at_theta_0\n        \n        # The gradient is the MC estimator (mean) of event-wise gradients.\n        grad = np.mean(d_y_dtheta_i)\n        autodiff_grads.append(grad)\n\n    autodiff_grads = np.array(autodiff_grads)\n\n    # --- Task B: Finite-Difference Reweighting Gradient ---\n    \n    # The base sample x_at_theta_0 is reused. Use a clip to avoid inf/nan in logit\n    # for values extremely close to 0 or 1.\n    x_clipped = np.clip(x_at_theta_0, 1e-15, 1 - 1e-15)\n    logit_x = logit(x_clipped) \n\n    # Helper for reweighting factor calculation.\n    def reweight_factor(theta, theta_ref, s_val, logit_x_val):\n        exp_arg = (2.0 * (theta - theta_ref) * logit_x_val - (theta**2 - theta_ref**2)) / (2.0 * s_val**2)\n        return np.exp(exp_arg)\n\n    # Calculate reweighting factors for theta_0 +/- delta.\n    weights_plus = reweight_factor(theta_0 + delta, theta_0, s, logit_x)\n    weights_minus = reweight_factor(theta_0 - delta, theta_0, s, logit_x)\n    \n    fd_reweight_grads = []\n    for lb, ub in bins:\n        # Pre-compute the observable at theta_0 for each event.\n        base_observable = w_func(x_at_theta_0, epsilon) * k_b_func(x_at_theta_0, lb, ub, k)\n        \n        # Calculate reweighted yields at theta_0 +/- delta.\n        y_b_plus = np.mean(weights_plus * base_observable)\n        y_b_minus = np.mean(weights_minus * base_observable)\n        \n        # Central finite difference formula.\n        grad = (y_b_plus - y_b_minus) / (2.0 * delta)\n        fd_reweight_grads.append(grad)\n\n    fd_reweight_grads = np.array(fd_reweight_grads)\n\n    # --- Task C: Benchmark ---\n    \n    # Compute the maximum absolute discrepancy across all bins.\n    discrepancy = np.max(np.abs(autodiff_grads - fd_reweight_grads))\n    \n    return discrepancy\n\nsolve()\n```"
        }
    ]
}