## 引言
间断Galerkin（DG）方法作为一种强大而灵活的数值工具，已在科学与工程计算的众多领域中得到广泛应用，尤其擅长求解由[偏微分方程](@entry_id:141332)（PDE）描述的复杂问题。该方法的成功关键在于其独特的离散化策略，它在保持[高阶精度](@entry_id:750325)的同时，又能优雅地处理复杂几何、不连续解以及并行计算。然而，要真正掌握并高效应用[DG方法](@entry_id:748369)，必须深入理解其计算流程的核心：算子组装与残差计算。这不仅是实现任何DG求解器的基础，也是进行算法优化和解决[非线性](@entry_id:637147)稳定性等高级问题的关键所在。

本文旨在系统性地揭示DG方法中算子组装与残差计算的完整图景，填补理论公式与高效代码实现之间的知识鸿沟。通过本文的学习，您将掌握从基本原理到前沿应用的全方位知识。

- 在“**原理与机制**”一章中，我们将从最基本的弱形式与强形式残差出发，详细剖析[数值通量](@entry_id:752791)的作用、[基函数](@entry_id:170178)的选择、坐标变换的细节，并探讨[质量集中](@entry_id:175432)、离散守恒性以及[和因子分解](@entry_id:755628)等关键技术，为您构建坚实的理论基础。

- 随后的“**应用与跨学科连接**”一章将展示这些原理如何在实际问题中发挥作用。我们将探讨如何应用DG方法处理复杂的物理模型，如[可压缩流体](@entry_id:164617)动力学中的[欧拉方程](@entry_id:177914)和考虑地形效应的浅水波方程，并介绍如何通过DG框架实现[网格自适应](@entry_id:751899)和[局部时](@entry_id:194383)间步长等高级算法。

- 最后，“**动手实践**”部分将提供一系列精心设计的编程练习，帮助您将理论知识转化为实践能力，通过亲手实现来巩固对守恒性、数值积分精度等核心概念的理解。

本文将引导您逐步深入[DG方法](@entry_id:748369)的核心，为您在计算科学领域的研究和开发工作提供坚实的支撑。

## 原理与机制

本章在前一章介绍的基础上，深入探讨间断 Galerkin (DG) 方法的核心操作——算子组装和残差计算的原理与机制。我们将从[偏微分方程](@entry_id:141332)出发，系统地构建 DG 方法的离散形式，并探讨其在实际计算中所涉及的关键概念，包括弱形式与强形式的残差、[数值通量](@entry_id:752791)、[基函数](@entry_id:170178)的选择、坐标变换、[非线性](@entry_id:637147)问题带来的挑战以及高效的计算策略。

### 单元残差：弱形式与强形式

DG 方法的出发点是将控制方程应用于计算域中的每个独立单元（或元素）$K$。考虑一个[标量守恒律](@entry_id:754532)：
$$
\partial_t u + \nabla \cdot f(u) = 0
$$
其中 $u$ 是[守恒量](@entry_id:150267)，$f(u)$ 是其通量。DG 方法的第一步是将此方程乘以一个**[检验函数](@entry_id:166589)** (test function) $v_h$，并在单元 $K$上积分。设 $u_h$ 为 $u$ 的多项式近似解，且 $u_h$ 与 $v_h$ 均属于单元 $K$ 上的某个多项式函数空间 $V^N(K)$。我们要求对于所有 $v_h \in V^N(K)$，以下积分方程都成立：
$$
\int_K (\partial_t u_h + \nabla \cdot f(u_h)) v_h \, d\boldsymbol{x} = 0
$$
这个方程的左侧，即在要求其为零之前的部分，定义了单元的**残差** (residual)。残差的表达形式并非唯一，其中最主要的是**弱形式** (weak form) 和**强形式** (strong form)。

**[弱形式](@entry_id:142897)残差**是通过对通量散度项 $\nabla \cdot f(u_h)$ 应用分部积分（即[高斯散度定理](@entry_id:188065)）得到的。这一操作将[微分算子](@entry_id:140145)从可能不光滑的解通量 $f(u_h)$ 转移到光滑的[检验函数](@entry_id:166589) $v_h$ 上：
$$
\int_K (\nabla \cdot f(u_h)) v_h \, d\boldsymbol{x} = \int_{\partial K} (f(u_h^-) \cdot \boldsymbol{n}_K) v_h \, d\boldsymbol{s} - \int_K f(u_h) \cdot \nabla v_h \, d\boldsymbol{x}
$$
其中 $\partial K$ 是单元 $K$ 的边界，$\boldsymbol{n}_K$ 是其单位外法向向量，$u_h^-$ 表示从单元内部逼近边界的解的迹。在 DG 方法中，边界上的物理通量 $f(u_h^-) \cdot \boldsymbol{n}_K$ 被一个**数值通量** (numerical flux) $\hat{f}$ 所取代，该[数值通量](@entry_id:752791)考虑了单元内部和外部的解状态。由此，我们得到弱形式的半离散方程，其左侧即为[弱形式](@entry_id:142897)残差 $R_K^{\mathrm{weak}}$ ：
$$
R_K^{\mathrm{weak}}(u_h; v_h) := \int_K u_{h,t} v_h \, d\boldsymbol{x} - \int_K f(u_h) \cdot \nabla v_h \, d\boldsymbol{x} + \int_{\partial K} \hat{f}(u_h^-, u_h^+, \boldsymbol{n}_K) v_h \, d\boldsymbol{s}
$$
其中 $u_{h,t}$ 是 $\partial_t u_h$ 的简写，$u_h^+$ 是从相邻单元逼近边界的解的迹。

**强形式残差**在代数上与弱形式等价（当积分精确计算时），但其结构不同。我们可以通过对[弱形式](@entry_id:142897)的[体积分](@entry_id:171119)项进行逆向[分部积分](@entry_id:136350)来得到它。它保留了在[体积分](@entry_id:171119)中作用于解通量的[散度算子](@entry_id:265975)，其形式如下 ：
$$
R_K^{\mathrm{strong}}(u_h; v_h) := \int_K (u_{h,t} + \nabla \cdot f(u_h)) v_h \, d\boldsymbol{x} + \int_{\partial K} \left(\hat{f}(u_h^-, u_h^+, \boldsymbol{n}_K) - f(u_h^-) \cdot \boldsymbol{n}_K\right) v_h \, d\boldsymbol{s}
$$
强形式的边界积分项可以被看作是对物理通量 $f(u_h^-) \cdot \boldsymbol{n}_K$ 和[数值通量](@entry_id:752791) $\hat{f}$ 之间差异的修正。虽然在理论上等价，但在[非线性](@entry_id:637147)问题和非精确积分的实际计算中，弱形式和强形式表现出不同的性质，尤其是在离散守恒性方面，我们将在后续章节中详细探讨。

### 单元间耦合：[数值通量](@entry_id:752791)

由于 DG 方法允许解在单元边界上存在间断，因此单元边界处的通量 $f(u_h)$ 是不明确的。它同时有两个值：来自单元内部的迹 $u_h^-$ 和来自相邻单元的迹 $u_h^+$。**数值通量** $\hat{f}(u_h^-, u_h^+, \boldsymbol{n})$ 的作用正是为了解决这种模糊性，并为相邻单元提供物理上和数学上都合理的耦合机制。一个设计良好的数值通量必须满足两个基本属性 ：

1.  **相容性 (Consistency)**：当边界两侧的状态一致时，即 $u^- = u^+ = u$，数值通量必须退化为物理通量沿法向的投影：$\hat{f}(u, u, \boldsymbol{n}) = f(u) \cdot \boldsymbol{n}$。这个性质确保了对于光滑解，我们的离散格式能够正确地逼近原始的[偏微分方程](@entry_id:141332)。

2.  **守恒性 (Conservativity)**：对于任意一个内部界面，其两侧单元的法向量方向相反，即 $\boldsymbol{n}^+ = -\boldsymbol{n}^-$。守恒性要求[数值通量](@entry_id:752791)满足[反对称关系](@entry_id:261979)：$\hat{f}(u^-, u^+, \boldsymbol{n}^-) = -\hat{f}(u^+, u^-, \boldsymbol{n}^+)$。这保证了离开一个单元的通量恰好是进入相邻单元的通量，从而确保了全局质量守恒。

一个广泛应用的[数值通量](@entry_id:752791)是**局部 Lax-Friedrichs 通量**（或称为 **Rusanov 通量**）。它由一个中心平均项和一个数值耗散项组成：
$$
\hat{f}(u^-, u^+, \boldsymbol{n}) = \frac{1}{2}\left(f(u^-) + f(u^+)\right) \cdot \boldsymbol{n} - \frac{1}{2} \alpha(u^+, u^-) (u^+ - u^-)
$$
其中耗散系数 $\alpha$ 必须足够大以保证[数值格式](@entry_id:752822)的稳定性。通常，$\alpha$ 的取值大于等于界面两侧法向特征速度的[绝对值](@entry_id:147688)的最大值，即 $\alpha \ge \max(|a_n(u^-)|, |a_n(u^+)|)$，其中 $a_n(u) = f'(u) \cdot \boldsymbol{n}$。这个耗散项有效地惩罚了边界上的间断，并引入了必要的稳定性，以抑制非物理[振荡](@entry_id:267781)。

### 参考单元上的离散化实践

为了简化计算和实现，所有单元上的积分和[微分](@entry_id:158718)操作通常通过一个仿射或[等参映射](@entry_id:173239)转换到**[参考单元](@entry_id:168425)** (reference element) $\hat{K}$ 上进行，例如一维的 $[-1,1]$ 或二维的 $[-1,1]^2$。在这个标准化的几何上，我们需要为解的近似 $u_h$ 选择一组[基函数](@entry_id:170178)。

#### [基函数](@entry_id:170178)的选择：[模态基](@entry_id:752055)与[节点基](@entry_id:752522)

两种最主流的[基函数](@entry_id:170178)选择是**[模态基](@entry_id:752055)** (modal basis) 和**[节点基](@entry_id:752522)** (nodal basis)。

-   **[模态基](@entry_id:752055)**通常由一组[正交多项式](@entry_id:146918)构成，例如勒让德多项式 (Legendre polynomials)。一个关键优势是，如果使用[标准化](@entry_id:637219)的正交勒让德基底，在精确积分下，[参考单元](@entry_id:168425)上的**[质量矩阵](@entry_id:177093)** (mass matrix) $\mathbf{M}$（其元素为 $M_{ij} = \int_{\hat{K}} \phi_i \phi_j d\boldsymbol{x}$）会成为一个单位矩阵 $\mathbf{I}$。对于常 Jacobian 的[仿射映射](@entry_id:746332)，物理单元上的质量矩阵也是一个对角阵 $J\mathbf{I}$。这在代数上极为方便。

-   **[节点基](@entry_id:752522)**则由一组[拉格朗日多项式](@entry_id:142463) (Lagrange polynomials) 构成，这些多项式定义在一组预先选择的节点上（例如 [Legendre-Gauss-Lobatto](@entry_id:751235) (LGL) 节点）。使用[节点基](@entry_id:752522)时，解的自由度就是其在这些节点上的物理值，这非常直观。

#### [质量集中](@entry_id:175432)与[计算效率](@entry_id:270255)

对于[节点基](@entry_id:752522)，如果精确地计算质量矩阵，它通常是一个[稠密矩阵](@entry_id:174457)。然而，一个被称为**[质量集中](@entry_id:175432)** (mass lumping) 的技巧极大地提升了计算效率。该技巧使用一个特殊的[数值积分](@entry_id:136578)规则——其积分节点与[拉格朗日基](@entry_id:751105)函数的定义节点完全重合。例如，对于建立在 LGL 节点上的[拉格朗日基](@entry_id:751105)，我们使用 LGL 积分规则。在这种情况下，离散[质量矩阵](@entry_id:177093)的元素 $M_{ij}^{\mathrm{Q}}$ 变为：
$$
M_{ij}^{\mathrm{Q}} = \sum_{k} w_k l_i(\xi_k) l_j(\xi_k)
$$
由于[拉格朗日多项式](@entry_id:142463)的性质 $l_i(\xi_j) = \delta_{ij}$，上式简化为 $M_{ij}^{\mathrm{Q}} = w_i \delta_{ij}$。这意味着离散[质量矩阵](@entry_id:177093) $\mathbf{M}^{\mathrm{Q}}$ 是一个[对角矩阵](@entry_id:637782)，其对角元就是积分权重 $w_i$  。

这个[对角质量矩阵](@entry_id:173002)对于使用[显式时间积分](@entry_id:165797)格式（如[龙格-库塔法](@entry_id:140014)）至关重要。半离散的 DG 方程形式为 $\mathbf{M} \frac{d\mathbf{U}}{dt} = \mathbf{R}(\mathbf{U})$，其中 $\mathbf{U}$ 是自由度向量，$\mathbf{R}$ 是空间残差向量。在每一步时间推进中，我们需要计算时间导数 $\frac{d\mathbf{U}}{dt} = \mathbf{M}^{-1} \mathbf{R}(\mathbf{U})$。如果 $\mathbf{M}$ 是对角的，其[逆矩阵](@entry_id:140380) $\mathbf{M}^{-1}$ 的计算是平凡的（即对角元的倒数），整个过程简化为向量的逐元素相除，避免了[求解线性方程组](@entry_id:169069)的巨大开销。对于 LGL 节点，其积分权重 $w_i$ 和[逆矩阵](@entry_id:140380)对角元 $(M^{\mathrm{Q}})_{ii}^{-1}$ 有明确的解析表达式 ：
$$
(M^{\mathrm{Q}})_{ii}^{-1} = \frac{1}{w_i} = \frac{N(N+1)(P_N(\xi_i))^2}{2}
$$
其中 $P_N$ 是 $N$ 阶[勒让德多项式](@entry_id:141510)。

此外，基于 LGL 节点的节点 DG 方法（常被称为 DG [谱元法](@entry_id:755171)，DGSEM）还具有**[分部求和](@entry_id:185335)** (Summation-By-Parts, SBP) 的性质。这是一种离散模拟分部积分的特性，它确保了离散算子具有良好的稳定性和守恒性，并使得[弱形式](@entry_id:142897)和强形式在离散层面完全等价  。

在算子应用效率方面，[节点基](@entry_id:752522)也显示出优势。例如，在计算边界上的数值通量时，我们需要解在边界积分点上的值。对于 LGL [节点基](@entry_id:752522)，由于其节点包含了单元的端点，边界上的值可以直接从自由度向量中读取，无需任何计算。而对于[模态基](@entry_id:752055)，则需要通过一个（通常是昂贵的）[基函数](@entry_id:170178)求和变换，才能得到任意点的函数值。

### 处理复杂几何：[等参映射](@entry_id:173239)

为了处理不规则或弯曲的物理单元 $K$，我们引入一个从[参考单元](@entry_id:168425) $\hat{K}$ 到 $K$ 的**[等参映射](@entry_id:173239)** (isoparametric mapping) $\boldsymbol{x}(\boldsymbol{\xi})$。这个映射允许我们将所有计算都在结构规则的[参考单元](@entry_id:168425)上进行。该过程需要考虑由映射引入的几何因子 。

关键的变换关系如下：
-   **[雅可比矩阵](@entry_id:264467) (Jacobian Matrix)** $A = \frac{\partial \boldsymbol{x}}{\partial \boldsymbol{\xi}}$ 及其[行列式](@entry_id:142978) $J = \det(A)$。
-   物理空间和参考空间中的[梯度算子](@entry_id:275922)关系：$\nabla_{\boldsymbol{x}} (\cdot) = A^{-T} \nabla_{\boldsymbol{\xi}} (\cdot)$。
-   [体积元](@entry_id:267802)和[面积元](@entry_id:263205)的变换：$d\boldsymbol{x} = J d\boldsymbol{\xi}$ 以及 $\boldsymbol{n}_{\boldsymbol{x}} ds = J A^{-T} \boldsymbol{n}_{\boldsymbol{\xi}} d\sigma$ (Piola 变换)。

将这些变换关系代入[弱形式](@entry_id:142897)残差的表达式中，我们可以得到完全在参考单元上定义的残差。例如，[弱形式](@entry_id:142897)中的体积项会变为：
$$
\int_K f(u_h) \cdot \nabla_{\boldsymbol{x}} v_h \, d\boldsymbol{x} = \int_{\hat{K}} f(u_h(\boldsymbol{\xi})) \cdot (A^{-T} \nabla_{\boldsymbol{\xi}} v_h(\boldsymbol{\xi})) \, J \, d\boldsymbol{\xi} = \int_{\hat{K}} \big( J A^{-1} f(u_h(\boldsymbol{\xi})) \big) \cdot \nabla_{\boldsymbol{\xi}} v_h(\boldsymbol{\xi}) \, d\boldsymbol{\xi}
$$
这里，组合项 $J A^{-1} f$ 被称为**逆变通量** (contravariant flux)，它是在参考[坐标系](@entry_id:156346)下表示的物理通量。类似地，边界积分中的[法向量](@entry_id:264185)也需要通过几何因子进行变换。最终，整个残差计算都可以在[参考单元](@entry_id:168425) $\hat{K}$ 上完成，只需在积分前将几何因子 $J$ 和 $A^{-1}$ 等计算出来并乘到被积函数中即可。

### 残差计算中的高级课题

在求解[非线性](@entry_id:637147)问题或使用弯曲单元时，残差的计算会面临一些微妙但重要的问题。

#### 混淆误差与[过积分](@entry_id:753033)

当处理[非线性](@entry_id:637147)通量 $f(u)$ 时，即使 $u_h$ 是一个 $N$ 阶多项式， $f(u_h)$ 通常也是一个更高阶的多项式（或非多项式）。例如，若 $f(u) = u^p$ 且 $u_h$ 是一个在每个坐标方向上最高为 $N$ 阶的[张量积](@entry_id:140694)多项式（属于 $\mathbb{Q}_N$ 空间），则[弱形式](@entry_id:142897)中的被积函数 $f(u_h) \cdot \nabla v_h$ 在某个坐标方向上的最高阶数可以达到 $(p+1)N$  。

标准的积分规则（例如，为精确积分 $2N$ 阶多项式而设计的规则）可能无法精确计算这个更高阶的被积函数。使用不精确的积分规则会导致**混淆误差** (aliasing error)，即无法被积分规则分辨的高频分量被错误地“混淆”或投影到低频模式上，这常常是导致[非线性](@entry_id:637147)不稳定的根源。

为保证精确积分，我们需要一个单方向上具有 $Q$ 个积分点的张量积高斯积分规则，使其满足：
$$
2Q - 1 \ge (p+1)N
$$
一种常见的减轻混淆误差的策略是**[过积分](@entry_id:753033)** (over-integration)，即在不改变解的多项式阶数 $N$ 的前提下，有意识地增加积分点的数量 $Q$，以更精确地计算[非线性](@entry_id:637147)项，从而提升数值格式的稳定性和精度。

#### 离散守恒性

如前所述，[弱形式](@entry_id:142897)和强形式在精确积分下是等价的，但在使用不精确积[分时](@entry_id:274419)则不然。一个关键的区别在于它们对单元平均质量的**离散守恒性**。

-   对于**弱形式**，当我们[选择检验](@entry_id:182706)函数为 $v_h=1$（这总是多项式空间的一个元素）来考察单元平均质量的变化率时，其体积项 $\int_K f(u_h) \cdot \nabla(1) d\boldsymbol{x}$ 在积分前就解析地为零。因此，单元平均质量的变化完全由边界上的[数值通量](@entry_id:752791)决定。这意味着即使体积积分不精确，[弱形式](@entry_id:142897)仍然是“天生”守恒的。

-   对于**强形式**，其体积项为 $\int_K (\nabla \cdot f(u_h)) \cdot 1 d\boldsymbol{x}$。在离散层面，[高斯散度定理](@entry_id:188065)的离散版本 $\left(\int_K \nabla \cdot f(u_h) d\boldsymbol{x}\right)_{\mathcal{Q}} = \left(\int_{\partial K} f(u_h^-) \cdot \boldsymbol{n} d\boldsymbol{s}\right)_{\mathcal{Q}}$ 通常不成立。这导致了一个虚假的内部质量源或汇，破坏了单元平均质量的守恒性。只有当离散算子满足前述的 SBP 性质时，强形式才能恢复守恒性。

#### [几何守恒律 (GCL)](@entry_id:749845)

守恒性不仅与方程的离散形式有关，还与几何信息的处理方式有关。**[几何守恒律](@entry_id:170384)** (Geometric Conservation Law, GCL) 指出，[数值格式](@entry_id:752822)必须能够精确地保持一个[均匀流](@entry_id:272775)场。在弯曲[坐标系](@entry_id:156346)或动网格问题中，这意味着即使物理量为常数，几何因子（如[雅可比行列式](@entry_id:137120) $J$）的变化也必须被精确地计算，以保证没有虚假的质量产生或消失。

如果数值格式在残差计算中使用了近似的[雅可比行列式](@entry_id:137120) $J_N$（例如，对真实的 $J$ 进行多项式投影），而用于衡量物理质量的积分却使用了真实的 $J$，这种不一致性就会破坏守恒性。即使格式本身（如[弱形式](@entry_id:142897)）是守恒的，这种几何误差也会导致质量不守恒，即 $\frac{dM}{dt} \neq 0$。这是一个微妙但至关重要的概念，它要求在算子组装中对几何项的处理必须与格式的守恒属性相兼容。

### 高效实现：[和因子分解](@entry_id:755628)

在多维问题中，尤其是在高阶 DG 方法中，算子组装和残差计算的成本可能非常高。对于张量积单元（如四边形或六面体），一个名为**[和因子分解](@entry_id:755628)** (sum-factorization) 的技术可以极大地降低计算复杂度。

考虑在三维[六面体单元](@entry_id:174602)上，一个基于 $n \times n \times n$ (其中 $n=N+1$) 节点场的[微分](@entry_id:158718)操作，例如计算 $x$ 方向的导数，可以形式化地写作一个[克罗内克积](@entry_id:182766) (Kronecker product) 算子作用于自由度张量上：$\partial_x U \sim (D \otimes I \otimes I) U$，其中 $D$ 是一维[微分矩阵](@entry_id:149870)，$I$ 是[单位矩阵](@entry_id:156724)。

如果直接构建并存储这个 $n^3 \times n^3$ 的巨大矩阵，其成本是无法接受的。[和因子分解](@entry_id:755628)算法通过将这个多维操作分解为一系列一维操作来避免这种情况。例如，计算 $(D \otimes I \otimes I) U$ 的过程如下：
1.  首先沿 $z$ 轴（第3维）对 $U$ 的每一条“柱”应用 $I$ 矩阵。
2.  然后沿 $y$ 轴（第2维）对新张量的每一条“行”应用 $I$ 矩阵。
3.  最后沿 $x$ 轴（第1维）对最终张量的每一条“行”应用 $D$ 矩阵。

这种分解将一个复杂度为 $O(n^6)$ 的操作降为三个复杂度为 $O(n^4)$ 的操作，总成本为 $O(n^4)$。更进一步，在计算梯度 $(\partial_x U, \partial_y U, \partial_z U)$ 时，可以通过优化[计算顺序](@entry_id:749112)和重用中间结果，将计算全部三个分量的总成本最小化。通过巧妙的调度，可以在 $8(N+1)^4$ 次乘加运算内完成此任务，这使得高阶 DG 方法在[张量积](@entry_id:140694)单元上的计算效率得以保证，并具有高度的可并行性。