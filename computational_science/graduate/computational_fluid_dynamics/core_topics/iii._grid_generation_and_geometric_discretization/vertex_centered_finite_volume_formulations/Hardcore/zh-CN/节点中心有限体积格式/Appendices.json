{
    "hands_on_practices": [
        {
            "introduction": "任何以顶点为中心的有限体积法的起点都是围绕每个顶点定义控制体积，这通常通过构建对偶网格来实现。本练习旨在通过一个具体的几何计算，巩固您对这一基本概念的理解。您将为一对共享公共边的相邻三角形计算其外心对偶边的几何属性，这是理解原始网格与对偶网格之间空间关系的关键一步。",
            "id": "3387918",
            "problem": "考虑平面中共享边 $e$ 的两个相邻三角形，边的端点为 $\\boldsymbol{A}=(0,0)$ 和 $\\boldsymbol{B}=(3,1)$。第一个三角形是 $T_1=\\triangle(\\boldsymbol{A},\\boldsymbol{B},\\boldsymbol{V}_1)$，其中 $\\boldsymbol{V}_1=(1,-2)$；第二个三角形是 $T_2=\\triangle(\\boldsymbol{A},\\boldsymbol{B},\\boldsymbol{V}_2)$，其中 $\\boldsymbol{V}_2=(2,3)$。在一个基于单纯网格的外心对偶（Voronoi对偶）构建的以顶点为中心的有限体积法中，与主边 $e$ 相关联的控制体界面是连接 $T_1$ 和 $T_2$ 外心的直线段，且该界面与 $e$ 正交。在二维空间中，任何矢量场穿过此界面的通量是通过将通量投影到选定的 $e$ 的单位法线上，并乘以界面测度来计算的。\n\n仅使用与守恒定律和通量投影一致的基本几何构造和定义，完成以下任务：\n- 计算与 $e$ 正交的对偶线段的长度（即 $T_1$ 和 $T_2$ 外心之间的距离）。\n- 首先通过构建从 $\\boldsymbol{A}$ 到 $\\boldsymbol{B}$ 方向的单位切向量 $\\hat{\\boldsymbol{t}}$，然后将其在平面内旋转 $+90^\\circ$ 得到 $\\boldsymbol{n}_e$，来定义 $e$ 的单位法线。根据此约定，计算用于评估穿过顶点中心界面的通量的标量投影面积，其定义为对偶线段在 $\\boldsymbol{n}_e$ 上的标量投影。\n\n将这两个量以精确的简化表达式形式给出。长度以米为单位。将最终答案以行矩阵的形式报告，矩阵中首先是对偶线段的长度，然后是标量投影面积，按此顺序排列。无需四舍五入，最终方框答案中不应包含单位。",
            "solution": "该问题要求计算与两个相邻三角形 $T_1$ 和 $T_2$ 的顶点中心有限体积对偶网格构建相关的两个量。第一个量是连接 $T_1$ 和 $T_2$ 外心的对偶边的长度。第二个量是此对偶边向量在与共享主边 $e$ 相关的特定法向量上的标量投影。\n\n三角形的顶点为 $\\boldsymbol{A}=(0,0)$、$\\boldsymbol{B}=(3,1)$、$\\boldsymbol{V}_1=(1,-2)$ 和 $\\boldsymbol{V}_2=(2,3)$。这两个三角形是 $T_1=\\triangle(\\boldsymbol{A},\\boldsymbol{B},\\boldsymbol{V}_1)$ 和 $T_2=\\triangle(\\boldsymbol{A},\\boldsymbol{B},\\boldsymbol{V}_2)$。\n\n首先，我们计算 $T_1$ 和 $T_2$ 的外心。三角形的外心是其各边垂直平分线的交点。\n\n设 $\\boldsymbol{C}_1=(x,y)$ 为 $T_1$ 的外心。$\\boldsymbol{C}_1$ 必须到 $\\boldsymbol{A}$、$\\boldsymbol{B}$ 和 $\\boldsymbol{V}_1$ 的距离相等。\n线段 $\\boldsymbol{AB}$ 的垂直平分线方程可由其上任意点到 $\\boldsymbol{A}$ 和 $\\boldsymbol{B}$ 距离相等的条件导出。\n$|\\boldsymbol{C}_1 - \\boldsymbol{A}|^2 = |\\boldsymbol{C}_1 - \\boldsymbol{B}|^2$\n$x^2 + y^2 = (x-3)^2 + (y-1)^2$\n$x^2 + y^2 = x^2 - 6x + 9 + y^2 - 2y + 1$\n$0 = -6x - 2y + 10$，简化为 $3x + y = 5$。\n\n线段 $\\boldsymbol{AV}_1$ 的垂直平分线方程的推导类似。\n$|\\boldsymbol{C}_1 - \\boldsymbol{A}|^2 = |\\boldsymbol{C}_1 - \\boldsymbol{V}_1|^2$\n$x^2 + y^2 = (x-1)^2 + (y-(-2))^2$\n$x^2 + y^2 = x^2 - 2x + 1 + y^2 + 4y + 4$\n$0 = -2x + 4y + 5$，可写作 $2x - 4y = 5$。\n\n现在我们求解关于 $(x,y)$ 的线性方程组：\n1. $y = 5 - 3x$\n2. $2x - 4y = 5$\n\n将第一个方程代入第二个方程：\n$2x - 4(5 - 3x) = 5$\n$2x - 20 + 12x = 5$\n$14x = 25 \\implies x = \\frac{25}{14}$\n然后，$y = 5 - 3\\left(\\frac{25}{14}\\right) = \\frac{70}{14} - \\frac{75}{14} = -\\frac{5}{14}$。\n因此，$T_1$ 的外心是 $\\boldsymbol{C}_1 = \\left(\\frac{25}{14}, -\\frac{5}{14}\\right)$。\n\n接下来，设 $\\boldsymbol{C}_2=(x,y)$ 为 $T_2$ 的外心。它位于 $\\boldsymbol{AB}$ 的垂直平分线 $3x+y=5$ 上。我们还需要 $\\boldsymbol{AV}_2$ 的垂直平分线。\n$|\\boldsymbol{C}_2 - \\boldsymbol{A}|^2 = |\\boldsymbol{C}_2 - \\boldsymbol{V}_2|^2$\n$x^2 + y^2 = (x-2)^2 + (y-3)^2$\n$x^2 + y^2 = x^2 - 4x + 4 + y^2 - 6y + 9$\n$0 = -4x - 6y + 13$，得到 $4x + 6y = 13$。\n\n现在我们求解关于 $\\boldsymbol{C}_2$ 的方程组：\n1. $y = 5 - 3x$\n2. $4x + 6y = 13$\n\n将第一个方程代入第二个方程：\n$4x + 6(5 - 3x) = 13$\n$4x + 30 - 18x = 13$\n$-14x = -17 \\implies x = \\frac{17}{14}$\n然后，$y = 5 - 3\\left(\\frac{17}{14}\\right) = \\frac{70}{14} - \\frac{51}{14} = \\frac{19}{14}$。\n因此，$T_2$ 的外心是 $\\boldsymbol{C}_2 = \\left(\\frac{17}{14}, \\frac{19}{14}\\right)$。\n\n要计算的第一个量是连接 $\\boldsymbol{C}_1$ 和 $\\boldsymbol{C}_2$ 的对偶线段的长度。首先，我们求出该线段的向量：\n$\\vec{\\boldsymbol{S}}_{dual} = \\boldsymbol{C}_2 - \\boldsymbol{C}_1 = \\left(\\frac{17}{14} - \\frac{25}{14}, \\frac{19}{14} - \\left(-\\frac{5}{14}\\right)\\right) = \\left(-\\frac{8}{14}, \\frac{24}{14}\\right) = \\left(-\\frac{4}{7}, \\frac{12}{7}\\right)$。\n\n此对偶线段的长度是其模长：\n$L_{dual} = |\\vec{\\boldsymbol{S}}_{dual}| = \\sqrt{\\left(-\\frac{4}{7}\\right)^2 + \\left(\\frac{12}{7}\\right)^2} = \\sqrt{\\frac{16}{49} + \\frac{144}{49}} = \\sqrt{\\frac{160}{49}} = \\frac{\\sqrt{16 \\times 10}}{\\sqrt{49}} = \\frac{4\\sqrt{10}}{7}$。\n问题说明长度以米为单位，所以长度为 $\\frac{4\\sqrt{10}}{7}$ 米。\n\n第二个量是标量投影面积，定义为对偶线段向量 $\\vec{\\boldsymbol{S}}_{dual}$ 在单位法向量 $\\boldsymbol{n}_e$ 上的标量投影。我们必须先构造 $\\boldsymbol{n}_e$。\n主边向量为 $\\vec{\\boldsymbol{e}} = \\boldsymbol{B} - \\boldsymbol{A} = (3,1) - (0,0) = (3,1)$。\n从 $\\boldsymbol{A}$ 到 $\\boldsymbol{B}$ 方向的单位切向量 $\\hat{\\boldsymbol{t}}$ 为：\n$\\hat{\\boldsymbol{t}} = \\frac{\\vec{\\boldsymbol{e}}}{|\\vec{\\boldsymbol{e}}|} = \\frac{(3,1)}{\\sqrt{3^2 + 1^2}} = \\frac{(3,1)}{\\sqrt{10}} = \\left(\\frac{3}{\\sqrt{10}}, \\frac{1}{\\sqrt{10}}\\right)$。\n\n单位法向量 $\\boldsymbol{n}_e$ 是通过将 $\\hat{\\boldsymbol{t}}$ 旋转 $+90^\\circ$ 得到的。一个点 $(x,y)$ 旋转 $+90^\\circ$ 后变为 $(-y,x)$。\n$\\boldsymbol{n}_e = \\left(-\\frac{1}{\\sqrt{10}}, \\frac{3}{\\sqrt{10}}\\right)$。\n\n标量投影面积是 $\\vec{\\boldsymbol{S}}_{dual}$ 和 $\\boldsymbol{n}_e$ 的点积：\n$A_{proj} = \\vec{\\boldsymbol{S}}_{dual} \\cdot \\boldsymbol{n}_e = \\left(-\\frac{4}{7}, \\frac{12}{7}\\right) \\cdot \\left(-\\frac{1}{\\sqrt{10}}, \\frac{3}{\\sqrt{10}}\\right)$\n$A_{proj} = \\left(-\\frac{4}{7}\\right)\\left(-\\frac{1}{\\sqrt{10}}\\right) + \\left(\\frac{12}{7}\\right)\\left(\\frac{3}{\\sqrt{10}}\\right) = \\frac{4}{7\\sqrt{10}} + \\frac{36}{7\\sqrt{10}} = \\frac{40}{7\\sqrt{10}}$。\n\n为了简化，我们将分母有理化：\n$A_{proj} = \\frac{40\\sqrt{10}}{7(\\sqrt{10})^2} = \\frac{40\\sqrt{10}}{70} = \\frac{4\\sqrt{10}}{7}$。\n标量投影面积为 $\\frac{4\\sqrt{10}}{7}$ 平方米。\n\n这个结果与对偶线段的长度相同。这是预料之中的，因为连接外心的对偶线段与共享的主边 $e$ 正交，而向量 $\\boldsymbol{n}_e$ 的构造也是与 $e$ 正交。在二维平面中，两个与同一直线正交的向量必定相互平行（或反平行）。在本例中，$\\vec{\\boldsymbol{S}}_{dual} = \\left(-\\frac{4}{7}, \\frac{12}{7}\\right) = \\frac{4\\sqrt{10}}{7} \\left(-\\frac{1}{\\sqrt{10}}, \\frac{3}{\\sqrt{10}}\\right) = \\frac{4\\sqrt{10}}{7} \\boldsymbol{n}_e$。由于 $\\vec{\\boldsymbol{S}}_{dual}$ 与单位向量 $\\boldsymbol{n}_e$ 平行，其在 $\\boldsymbol{n}_e$ 上的标量投影就是它自身的长度。\n\n要求的两个量是对偶线段长度和标量投影面积。\n长度 = $\\frac{4\\sqrt{10}}{7}$。\n标量投影面积 = $\\frac{4\\sqrt{10}}{7}$。",
            "answer": "$$\\boxed{\\begin{pmatrix} \\frac{4\\sqrt{10}}{7}  \\frac{4\\sqrt{10}}{7} \\end{pmatrix}}$$"
        },
        {
            "introduction": "在建立了控制体积的几何概念之后，下一步是应用它来离散化并求解一个偏微分方程。本练习将引导您将理论转化为一个可运行的程序，通过为二维线性平流方程编写一个简单的显式求解器来实践。通过实施一阶迎风格式，您将获得关于显式有限体积方法的数据流和算法的实践经验，并理解 Courant–Friedrichs–Lewy (CFL) 条件对稳定性的重要性。",
            "id": "3387973",
            "problem": "考虑一个标量场 $u$ 的守恒形式线性平流方程，\n$$\n\\partial_t u + \\nabla \\cdot (\\boldsymbol{a}\\,u) = 0,\n$$\n在二维周期性域 $\\Omega = [0,L_x)\\times[0,L_y)$ 上，平流速度为常数 $\\boldsymbol{a} = (1,0)$。在 $x$ 方向有 $N_x$ 个顶点、$y$ 方向有 $N_y$ 个顶点的均匀笛卡尔网格上，使用以顶点为中心的有限体积法 (FVM)。围绕每个内部顶点的对偶控制体积是一个矩形，其角点是周围四个原始单元的中心。将均匀间距表示为 $h_x = L_x/N_x$ 和 $h_y = L_y/N_y$，因此对偶体积的面积为 $V_P = h_x h_y$，东、西面的对偶面长度为 $h_y$，南、北面的对偶面长度为 $h_x$。由于 $\\boldsymbol{a}=(1,0)$，只有东面和西面对通量有贡献。\n\n从对偶控制体积上的积分守恒律出发，使用显式向前欧拉时间积分和一阶迎风数值通量，在以顶点为中心的对偶网格上，实现 $u$ 从时间层 $t^n$ 到 $t^{n+1} = t^n + \\Delta t$ 的一个显式时间步长。在两个方向上均使用周期性边界条件。初始分布为\n$$\nu_0(x,y) = \\exp\\!\\Bigg(-\\frac{(x - x_c)^2 + (y - y_c)^2}{\\sigma^2}\\Bigg) + \\beta\\,\\sin(2\\pi x)\\,\\cos(2\\pi y),\n$$\n参数为 $x_c = 0.25$, $y_c = 0.5$, $\\sigma = 0.15$ 以及 $\\beta = 0.25$。三角函数中的角度必须以弧度为单位进行解释。所有量均为无量纲。\n\n您的程序必须：\n- 构建均匀的顶点网格，其坐标为 $x_i = i\\,h_x$（$i = 0,1,\\dots,N_x-1$）和 $y_j = j\\,h_y$（$j = 0,1,\\dots,N_y-1$）。\n- 初始化 $u^n_{i,j} = u_0(x_i,y_j)$。\n- 使用以顶点为中心的 FVM 和一阶迎风通量（$\\boldsymbol{a}=(1,0)$）执行一个显式时间步：\n  - 对于每个顶点 $(i,j)$，定义其西邻居索引 $i_W = (i-1) \\bmod N_x$ 并计算\n    $$\n    u^{n+1}_{i,j} = u^n_{i,j} - \\frac{\\Delta t}{h_x}\\big(u^n_{i,j} - u^n_{i_W,j}\\big).\n    $$\n- 确定此格式和速度下的 Courant–Friedrichs–Lewy (CFL) 稳定性条件。推导出确保稳定性的关于 $h_x$ 的 $\\Delta t$ 要求，并返回给定的 $\\Delta t$ 是否满足该条件。\n\n对于每个测试用例，在推进一个时间步后，报告最接近评估点 $(x^\\star,y^\\star)$ 的顶点处的更新值，以及一个布尔值，指示 CFL 约束是否被满足。给定 $(x^\\star,y^\\star)$，通过四舍五入选择最近的顶点索引：$i^\\star = \\operatorname{round}(x^\\star/h_x)$ 和 $j^\\star = \\operatorname{round}(y^\\star/h_y)$，两者分别对 $N_x$ 和 $N_y$ 取模，然后使用 $(x_{i^\\star}, y_{j^\\star})$。\n\n测试套件：\n- 用例 1：$N_x=20$, $N_y=20$, $L_x=1$, $L_y=1$, $\\Delta t=0.02$, $(x^\\star,y^\\star)=(0.6,0.3)$。\n- 用例 2：$N_x=50$, $N_y=10$, $L_x=1$, $L_y=1$, $\\Delta t=0.02$, $(x^\\star,y^\\star)=(0.6,0.3)$。\n- 用例 3：$N_x=30$, $N_y=30$, $L_x=1$, $L_y=1$, $\\Delta t=0.06$, $(x^\\star,y^\\star)=(0.6,0.3)$。\n- 用例 4：$N_x=16$, $N_y=16$, $L_x=1$, $L_y=1$, $\\Delta t=0.0$, $(x^\\star,y^\\star)=(0.6,0.3)$。\n\n您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果。每个结果必须是一个二元列表 $[u^{n+1}(x_{i^\\star},y_{j^\\star}), \\text{cfl\\_ok}]$，其中 $u^{n+1}(x_{i^\\star},y_{j^\\star})$ 是一个四舍五入到 $8$ 位小数的浮点数，而 $\\text{cfl\\_ok}$ 是一个布尔值。例如，整体输出格式应如下所示\n$$\n\\big[ [\\text{float},\\text{boolean}], [\\text{float},\\text{boolean}], [\\text{float},\\text{boolean}], [\\text{float},\\text{boolean}] \\big].\n$$",
            "solution": "问题陈述已经过验证，被认为是可靠、适定且客观的。它基于既有的科学和数学原理，提出了一个计算流体力学中的明确任务。\n\n该问题要求使用以顶点为中心的有限体积法 (FVM) 来实现线性平流方程的单步时间推进。下面概述了数值格式的推导、稳定性分析和实现细节。\n\n控制方程是二维线性平流方程，其守恒形式为：\n$$\n\\partial_t u + \\nabla \\cdot (\\boldsymbol{a}\\,u) = 0\n$$\n其中 $u(x,y,t)$ 是一个标量场，$\\boldsymbol{a}$ 是恒定的平流速度。对于本问题，速度指定为 $\\boldsymbol{a} = (1,0)$，这可将方程简化为：\n$$\n\\partial_t u + \\partial_x u = 0\n$$\n该方程描述了量 $u$ 以单位速度在 $x$ 正方向上的输运。\n\nFVM 依赖于守恒律的积分形式。我们将方程在一个固定的空间控制体积 $V_P$ 上进行积分：\n$$\n\\int_{V_P} \\partial_t u \\, dV + \\int_{V_P} \\nabla \\cdot (\\boldsymbol{a}\\,u) \\, dV = 0\n$$\n对第二项应用散度定理（也称为 Gauss 定理），将散度的体积分转换为了边界 $\\partial V_P$ 上的通量面积分：\n$$\n\\frac{d}{dt} \\int_{V_P} u \\, dV + \\oint_{\\partial V_P} (\\boldsymbol{a}\\,u) \\cdot \\boldsymbol{n} \\, dS = 0\n$$\n其中 $\\boldsymbol{n}$ 是表面元 $dS$ 上的向外单位法向量。\n\n在以顶点为中心的 FVM 中，首先将区域离散化为顶点网格，然后围绕每个顶点构建一个由控制体积组成的对偶网格。对于指定的均匀笛卡尔网格，其顶点为 $(x_i, y_j)$，其中 $x_i = i h_x$ 且 $y_j = j h_y$，围绕顶点 $(i,j)$ 的对偶控制体积 $V_{i,j}$ 是一个矩形。其角点位于周围四个原始单元的中心，这意味着它在 $x$ 方向上从 $x_i - h_x/2$ 延伸到 $x_i + h_x/2$，在 $y$ 方向上从 $y_j - h_y/2$ 延伸到 $y_j + h_y/2$。该控制体积的体积（在二维中为面积）是 $V_{i,j} = h_x h_y$。\n\n我们定义单元平均量 $\\bar{u}_{i,j}(t) = \\frac{1}{V_{i,j}} \\int_{V_{i,j}} u(x,y,t) \\, dV$。积分守恒律变为：\n$$\nV_{i,j} \\frac{d\\bar{u}_{i,j}}{dt} + \\oint_{\\partial V_{i,j}} (\\boldsymbol{a}\\,u) \\cdot \\boldsymbol{n} \\, dS = 0\n$$\n在以顶点为中心的格式中，单元平均值 $\\bar{u}_{i,j}$ 由顶点本身的值来近似，即 $\\bar{u}_{i,j} \\approx u_{i,j}$。\n\n通量积分通过对矩形控制体积的四个面——东 (e)、西 (w)、北 (n) 和南 (s)——上的通量求和来计算。速度向量为 $\\boldsymbol{a} = (1, 0)$。向外法向量分别为 $\\boldsymbol{n}_e = (1,0)$、$\\boldsymbol{n}_w = (-1,0)$、$\\boldsymbol{n}_n = (0,1)$ 和 $\\boldsymbol{n}_s = (0,-1)$。点积为：\n- $\\boldsymbol{a} \\cdot \\boldsymbol{n}_e = 1$\n- $\\boldsymbol{a} \\cdot \\boldsymbol{n}_w = -1$\n- $\\boldsymbol{a} \\cdot \\boldsymbol{n}_n = 0$\n- $\\boldsymbol{a} \\cdot \\boldsymbol{n}_s = 0$\n\n因此，通过北面和南面的通量为零。通量积分简化为通过东面和西面的通量之和：\n$$\n\\oint_{\\partial V_{i,j}} (\\boldsymbol{a}\\,u) \\cdot \\boldsymbol{n} \\, dS = \\int_e u \\, dS - \\int_w u \\, dS\n$$\n东面和西面的长度均为 $h_y$。使用中点法则近似每个面上的积分，得到数值通量：\n$$\n\\int_e u \\, dS - \\int_w u \\, dS \\approx (F_e - F_w)\n$$\n其中 $F_e = u_e h_y$ 和 $F_w = u_w h_y$。这里，$u_e$ 和 $u_w$ 分别是东面和西面中心处 $u$ 的值。\n\n问题指定了一阶迎风格式。由于 $x$ 方向的平流速度为正 ($a_x = 1 > 0$)，因此“迎风”方向是来自左侧（来自较小的 $x$）。因此，面上 $u$ 的值取自该面迎风侧的顶点。\n- 对于 $V_{i,j}$ 的东面（位于 $x=x_i+h_x/2$），迎风顶点是 $(i,j)$。因此，$u_e = u_{i,j}$。离开东面的通量是 $u_{i,j} h_y$。\n- 对于 $V_{i,j}$ 的西面（位于 $x=x_i-h_x/2$），迎风顶点是西邻居 $(i_W, j)$，其中 $i_W = (i-1) \\pmod{N_x}$ 用于处理周期性边界条件。因此，$u_w = u_{i_W,j}$。进入西面的通量是 $u_{i_W,j} h_y$。\n\n流出控制体积 $V_{i,j}$ 的净通量是流出东面的通量减去流入西面的通量：\n$$\n\\text{Net Flux} = (u_{i,j} h_y) - (u_{i_W,j} h_y) = (u_{i,j} - u_{i_W,j})h_y\n$$\n将其代入半离散的守恒律中，得到：\n$$\nh_x h_y \\frac{d u_{i,j}}{dt} + (u_{i,j} - u_{i_W,j})h_y = 0\n$$\n除以体积 $h_x h_y$ 得到半离散的常微分方程组 (ODEs)：\n$$\n\\frac{d u_{i,j}}{dt} = - \\frac{1}{h_x} (u_{i,j} - u_{i_W,j})\n$$\n问题指定使用显式向前欧拉法进行时间积分。将时间导数近似为 $\\frac{d u_{i,j}}{dt} \\approx \\frac{u_{i,j}^{n+1} - u_{i,j}^{n}}{\\Delta t}$，其中 $u_{i,j}^n = u(x_i, y_j, t^n)$，我们得到全离散格式：\n$$\n\\frac{u_{i,j}^{n+1} - u_{i,j}^{n}}{\\Delta t} = - \\frac{1}{h_x} (u_{i,j}^n - u_{i_W,j}^n)\n$$\n对 $u_{i,j}^{n+1}$ 进行整理，得到问题陈述中提供的更新公式：\n$$\nu^{n+1}_{i,j} = u^n_{i,j} - \\frac{\\Delta t}{h_x}\\big(u^n_{i,j} - u^n_{i_W,j}\\big)\n$$\n\n这种显式格式的稳定性由 Courant–Friedrichs–Lewy (CFL) 条件决定。对于一维平流方程 $u_t + a_x u_x = 0$，当 $a_x > 0$ 时，一阶迎风格式（即向前时间、向后空间格式）是稳定的，条件是库朗数 $C = |a_x| \\frac{\\Delta t}{h_x}$ 满足 $C \\le 1$。在我们的例子中，$a_x = 1$，所以条件变为：\n$$\n\\frac{\\Delta t}{h_x} \\le 1 \\quad \\text{或} \\quad \\Delta t \\le h_x\n$$\n实现将验证每个测试用例中的给定参数是否满足此条件。\n\n实现将按以下步骤进行：\n1. 对每个测试用例，定义网格参数 $N_x, N_y, L_x, L_y, h_x, h_y$ 和时间步长 $\\Delta t$。\n2. 构建一个二维顶点坐标网格 $(x_i, y_j)$，其中 $i \\in [0, N_x-1]$ 且 $j \\in [0, N_y-1]$。\n3. 使用提供的初始条件函数 $u_0(x,y)$ 在此网格上初始化解场 $u^n$。\n4. 使用更新方程的向量化形式计算更新后的场 $u^{n+1}$。周期性移位 $u_{i_W,j}$ 将使用 `numpy.roll` 高效实现。\n5. 通过检查 $\\Delta t \\le h_x$ 来确定 CFL 稳定性的布尔标志。\n6. 使用指定的四舍五入和模运算，确定最接近评估点 $(x^\\star, y^\\star)$ 的网格索引 $(i^\\star, j^\\star)$。\n7. 提取 $(i^\\star, j^\\star)$ 处的 $u^{n+1}$ 值，将其四舍五入到 8 位小数，并与 CFL 布尔标志一起打包到最终结果列表中。",
            "answer": "```python\nimport numpy as np\nimport math\n\ndef solve():\n    \"\"\"\n    Solves the 2D linear advection problem for one time step using a\n    vertex-centered FVM with first-order upwind fluxes.\n    \"\"\"\n    # Parameters for the initial condition\n    x_c = 0.25\n    y_c = 0.5\n    sigma = 0.15\n    beta = 0.25\n\n    # Test cases from the problem statement\n    test_cases = [\n        {'Nx': 20, 'Ny': 20, 'Lx': 1.0, 'Ly': 1.0, 'dt': 0.02, 'x_star': 0.6, 'y_star': 0.3},\n        {'Nx': 50, 'Ny': 10, 'Lx': 1.0, 'Ly': 1.0, 'dt': 0.02, 'x_star': 0.6, 'y_star': 0.3},\n        {'Nx': 30, 'Ny': 30, 'Lx': 1.0, 'Ly': 1.0, 'dt': 0.06, 'x_star': 0.6, 'y_star': 0.3},\n        {'Nx': 16, 'Ny': 16, 'Lx': 1.0, 'Ly': 1.0, 'dt': 0.0, 'x_star': 0.6, 'y_star': 0.3},\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        # Unpack parameters for the current case\n        Nx, Ny = case['Nx'], case['Ny']\n        Lx, Ly = case['Lx'], case['Ly']\n        dt = case['dt']\n        x_star, y_star = case['x_star'], case['y_star']\n\n        # Calculate grid spacings\n        hx = Lx / Nx\n        hy = Ly / Ny\n\n        # Create grid coordinates\n        x_coords = np.arange(Nx) * hx\n        y_coords = np.arange(Ny) * hy\n        X, Y = np.meshgrid(x_coords, y_coords, indexing='ij')\n\n        # Initialize the scalar field u at time t^n\n        # u_n(x,y) = exp(-((x-xc)^2 + (y-yc)^2)/sigma^2) + beta*sin(2*pi*x)*cos(2*pi*y)\n        u_n = np.exp(-((X - x_c)**2 + (Y - y_c)**2) / sigma**2) + \\\n              beta * np.sin(2 * np.pi * X) * np.cos(2 * np.pi * Y)\n\n        # Perform one explicit time step using first-order upwind scheme\n        # u^{n+1}_{i,j} = u^n_{i,j} - dt/hx * (u^n_{i,j} - u^n_{i_W,j})\n        # i_W corresponds to a circular shift in the i-direction (axis 0)\n        u_W = np.roll(u_n, shift=1, axis=0)\n        u_np1 = u_n - (dt / hx) * (u_n - u_W)\n\n        # Determine if the CFL stability condition is satisfied\n        # For a=1, the condition is dt = hx.\n        cfl_ok = (dt = hx)\n\n        # Find the indices of the vertex closest to the evaluation point (x_star, y_star)\n        # i_star = round(x_star / hx) mod Nx\n        # j_star = round(y_star / hy) mod Ny\n        i_star = int(np.round(x_star / hx)) % Nx\n        j_star = int(np.round(y_star / hy)) % Ny\n        \n        # Get the updated value at the evaluation vertex\n        u_eval = u_np1[i_star, j_star]\n        \n        # Append the result for this case\n        results.append([round(u_eval, 8), cfl_ok])\n\n    # Format the final output as a string representing a list of lists\n    # e.g., [[0.12345678, True], [0.98765432, False]]\n    # Python's str() on a boolean gives 'True' or 'False', which is acceptable.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "在现代计算流体动力学中，为了处理复杂的非线性问题并获得更好的稳定性，通常采用隐式方法求解。这些方法的核心在于反复组装残差向量 $R$ 和雅可比矩阵 $J$。本高级练习将带您深入了解一个典型 CFD 代码的核心部分，您需要为一个非线性平流-扩散方程实现一个基于边的循环来组装这些关键组件，并处理各种边界条件。",
            "id": "3387966",
            "problem": "考虑一个标量场 $q$ 的无量纲、稳态、非线性对流扩散方程，该方程建立在二维以顶点为中心的有限体积网格上。每个控制体与一个顶点 $i$ 相关联，通量通过与网格边对齐的对偶面进行交换。顶点 $i$ 处的残差，记为 $R_i$，是穿过从 $i$ 指向外部的对偶控制体各面的数值通量之和。离散雅可比矩阵 $J$ 是由偏导数 $\\partial R_i / \\partial q_j$ 构成的矩阵。\n\n您必须设计并实现一个基于边的循环，为以下非线性模型和数值通量组装残差向量 $R$ 和雅可比矩阵 $J$。在本问题中，所有量均为无量纲。\n\n基本基础和模型：\n- 在对偶控制体 $\\mathcal{V}_i$ 上的积分形式守恒：\n$$\\sum_{f \\subset \\partial \\mathcal{V}_i} F_f(q) = 0,$$\n其中 $F_f(q)$ 表示通过面 $f$ 的总数值通量。\n- 对流速度依赖于场，表达式为\n$$\\mathbf{u}(q) = \\left(u_0 + \\alpha q^2\\right)\\,\\mathbf{v}_{\\mathrm{dir}},$$\n其中 $u_0  0$ 是一个基准速度，$\\alpha \\ge 0$ 控制非线性程度，$\\mathbf{v}_{\\mathrm{dir}}$ 是一个固定的单位方向向量。\n- 扩散系数线性依赖于场：\n$$k(q) = k_0 + \\beta q,$$\n其中 $k_0  0$ 且 $\\beta \\ge 0$。\n\n几何与方向：\n- 对于连接顶点 $i$ 和 $j$ 的每条内部边，对偶面具有面积因子 $A_e  0$，单位法向量 $\\mathbf{n}_{ij}$ 从 $i$ 的控制体指向 $j$，以及用于梯度近似的度量距离 $d_{ij}  0$。\n\n内部边 $\\{i,j\\}$ 的数值通量：\n- 定义平均状态 $q_{\\mathrm{avg}} = \\frac{q_i + q_j}{2}$，平均速度 $s = \\mathbf{u}(q_{\\mathrm{avg}}) \\cdot \\mathbf{n}_{ij}$，以及算术平均值 $k_{\\mathrm{avg}} = \\frac{k(q_i) + k(q_j)}{2}$。\n- 对流数值通量使用 Rusanov (Lax-Friedrichs) 分裂：\n$$F_{\\mathrm{adv}}^{ij} = A_e\\left[s\\,\\frac{q_i + q_j}{2} + \\frac{1}{2}\\,\\lvert s \\rvert\\,(q_i - q_j)\\right].$$\n- 扩散数值通量使用两点近似：\n$$F_{\\mathrm{diff}}^{ij} = -A_e\\,k_{\\mathrm{avg}}\\,\\frac{q_j - q_i}{d_{ij}}.$$\n- 总通量为 $F^{ij} = F_{\\mathrm{adv}}^{ij} + F_{\\mathrm{diff}}^{ij}$。组装约定：将 $+F^{ij}$ 加到 $R_i$ 上，将 $-F^{ij}$ 加到 $R_j$ 上，以确保守恒。\n\n内部边 $\\{i,j\\}$ 的雅可比矩阵：\n- 设 $\\sigma = \\mathrm{sign}(s)$（当 $s \\ne 0$）且 $v_n = \\mathbf{v}_{\\mathrm{dir}} \\cdot \\mathbf{n}_{ij}$。使用 $\\frac{d}{dq}\\mathbf{u}(q) = 2\\alpha q\\,\\mathbf{v}_{\\mathrm{dir}}$， $s$ 关于 $q_i$ 和 $q_j$ 的导数为\n$$\\frac{\\partial s}{\\partial q_i} = \\alpha\\,q_{\\mathrm{avg}}\\,v_n,\\qquad \\frac{\\partial s}{\\partial q_j} = \\alpha\\,q_{\\mathrm{avg}}\\,v_n.$$\n- 设 $q_{\\mathrm{bar}} = \\frac{q_i + q_j}{2}$，并注意 $\\frac{d}{dq_i}q_{\\mathrm{bar}} = \\frac{1}{2}$，$\\frac{d}{dq_j}q_{\\mathrm{bar}} = \\frac{1}{2}$。则\n$$\\frac{\\partial F_{\\mathrm{adv}}^{ij}}{\\partial q_i} = A_e\\left[\\left(\\frac{\\partial s}{\\partial q_i}\\right) q_{\\mathrm{bar}} + s\\cdot\\frac{1}{2} + \\frac{1}{2}\\,\\sigma\\,\\left(\\frac{\\partial s}{\\partial q_i}\\right)(q_i - q_j) + \\frac{1}{2}\\,\\lvert s \\rvert\\right],$$\n$$\\frac{\\partial F_{\\mathrm{adv}}^{ij}}{\\partial q_j} = A_e\\left[\\left(\\frac{\\partial s}{\\partial q_j}\\right) q_{\\mathrm{bar}} + s\\cdot\\frac{1}{2} + \\frac{1}{2}\\,\\sigma\\,\\left(\\frac{\\partial s}{\\partial q_j}\\right)(q_i - q_j) - \\frac{1}{2}\\,\\lvert s \\rvert\\right].$$\n- 已知 $k'(q) = \\beta$ 且 $k_{\\mathrm{avg}} = \\frac{k(q_i) + k(q_j)}{2}$，\n$$\\frac{\\partial F_{\\mathrm{diff}}^{ij}}{\\partial q_i} = -A_e\\left[\\frac{1}{2}\\beta\\,\\frac{q_j - q_i}{d_{ij}} - \\frac{k_{\\mathrm{avg}}}{d_{ij}}\\right],\\qquad \\frac{\\partial F_{\\mathrm{diff}}^{ij}}{\\partial q_j} = -A_e\\left[\\frac{1}{2}\\beta\\,\\frac{q_j - q_i}{d_{ij}} + \\frac{k_{\\mathrm{avg}}}{d_{ij}}\\right].$$\n- 总导数通过求和得到：\n$$\\frac{\\partial F^{ij}}{\\partial q_i} = \\frac{\\partial F_{\\mathrm{adv}}^{ij}}{\\partial q_i} + \\frac{\\partial F_{\\mathrm{diff}}^{ij}}{\\partial q_i},\\qquad \\frac{\\partial F^{ij}}{\\partial q_j} = \\frac{\\partial F_{\\mathrm{adv}}^{ij}}{\\partial q_j} + \\frac{\\partial F_{\\mathrm{diff}}^{ij}}{\\partial q_j}.$$\n- 组装到 $J$：将 $\\frac{\\partial F^{ij}}{\\partial q_i}$ 加到 $J_{ii}$，将 $\\frac{\\partial F^{ij}}{\\partial q_j}$ 加到 $J_{ij}$，并由于 $R_j$ 中的 $-F^{ij}$ 贡献，从 $J_{ji}$ 和 $J_{jj}$ 中减去相同的值。\n\n边界边：\n- 顶点 $i$ 处的狄利克雷边界：一个给定的状态 $q_{\\mathrm{bc}}$ 通过一个边界对偶面进行相互作用，该面对偶面面积为 $A_b$，单位法向量为 $\\mathbf{n}_b$（从 $i$ 的控制体向外），距离为 $d_{iB}$。设 $q_{\\mathrm{avg}} = \\frac{q_i + q_{\\mathrm{bc}}}{2}$，$q_{\\mathrm{bar}} = \\frac{q_i + q_{\\mathrm{bc}}}{2}$，$s = \\mathbf{u}(q_{\\mathrm{avg}})\\cdot \\mathbf{n}_b$ 和 $v_n = \\mathbf{v}_{\\mathrm{dir}}\\cdot\\mathbf{n}_b$，则通量为\n$$F_{\\mathrm{adv}}^{iB} = A_b\\left[s\\,q_{\\mathrm{bar}} + \\frac{1}{2}\\lvert s \\rvert (q_i - q_{\\mathrm{bc}})\\right],\\qquad F_{\\mathrm{diff}}^{iB} = -A_b\\,\\frac{k_{\\mathrm{avg}}(q_i,q_{\\mathrm{bc}})}{d_{iB}}\\,(q_{\\mathrm{bc}} - q_i).$$\n它们关于 $q_i$ 的导数为\n$$\\frac{\\partial s}{\\partial q_i} = \\alpha\\,q_{\\mathrm{avg}}\\,v_n,$$\n$$\\frac{\\partial F_{\\mathrm{adv}}^{iB}}{\\partial q_i} = A_b\\left[\\left(\\frac{\\partial s}{\\partial q_i}\\right) q_{\\mathrm{bar}} + s\\cdot\\frac{1}{2} + \\frac{1}{2}\\sigma\\left(\\frac{\\partial s}{\\partial q_i}\\right)(q_i - q_{\\mathrm{bc}}) + \\frac{1}{2}\\lvert s \\rvert\\right],$$\n$$\\frac{\\partial F_{\\mathrm{diff}}^{iB}}{\\partial q_i} = -A_b\\left[\\frac{1}{2}\\beta\\,\\frac{q_{\\mathrm{bc}} - q_i}{d_{iB}} - \\frac{k_{\\mathrm{avg}}(q_i,q_{\\mathrm{bc}})}{d_{iB}}\\right].$$\n边界贡献将 $+F^{iB}$ 加到 $R_i$ 上，并且只将关于 $q_i$ 的导数加到 $J_{ii}$ 上，因为 $q_{\\mathrm{bc}}$ 是给定的。\n\n- 顶点 $i$ 处的诺伊曼边界：施加一个给定的法向扩散通量 $h$。定义 $s = \\mathbf{u}(q_i)\\cdot \\mathbf{n}_b$，并设 $q_{\\mathrm{in}}$ 为用于入流对流的边界状态。对流通量使用迎风分裂：\n$$F_{\\mathrm{adv}}^{iN} = A_b\\left[\\max(s,0)\\,q_i + \\min(s,0)\\,q_{\\mathrm{in}}\\right].$$\n扩散通量为 $F_{\\mathrm{diff}}^{iN} = A_b\\,h$。$F_{\\mathrm{adv}}^{iN}$ 关于 $q_i$ 的导数是分段的：\n$$\\frac{d s}{d q_i} = 2\\alpha q_i\\,(\\mathbf{v}_{\\mathrm{dir}}\\cdot\\mathbf{n}_b),$$\n$$\\frac{\\partial F_{\\mathrm{adv}}^{iN}}{\\partial q_i} = \\begin{cases}\nA_b\\left(\\frac{d s}{d q_i}\\,q_i + s\\right),  s  0,\\\\\nA_b\\left(\\frac{d s}{d q_i}\\,q_{\\mathrm{in}}\\right),  s  0,\n\\end{cases}$$\n且 $\\frac{\\partial F_{\\mathrm{diff}}^{iN}}{\\partial q_i} = 0$。边界贡献将 $+F^{iN}$ 加到 $R_i$ 上，并且只将关于 $q_i$ 的导数加到 $J_{ii}$ 上。\n\n边循环所需的数据依赖：\n- 顶点处的状态向量条目 $q_i$。\n- 对于每条内部边：索引 $(i,j)$，面积因子 $A_e$，从 $i$ 指向 $j$ 的单位法向量 $\\mathbf{n}_{ij}$，以及度量距离 $d_{ij}$。\n- 对于连接到顶点 $i$ 的每个狄利克雷边界边：$A_b$，$\\mathbf{n}_b$，$d_{iB}$ 和 $q_{\\mathrm{bc}}$。\n- 对于连接到顶点 $i$ 的每个诺伊曼边界边：$A_b$，$\\mathbf{n}_b$，给定的通量 $h$ 和入流状态 $q_{\\mathrm{in}}$。\n\n您的程序必须实现此组装过程，并为每个测试用例计算以下两个浮点度量：\n- 残差的二范数平方，$\\lVert R \\rVert_2^2 = \\sum_i R_i^2$。\n- 雅可比矩阵的谱半径，定义为 $\\rho(J) = \\max_\\lambda \\lvert \\lambda \\rvert$，其中 $\\lambda$ 遍历 $J$ 的所有特征值。\n\n测试套件：\n- 测试用例 1 (仅内部边对)：\n    - 顶点数：$N = 2$。\n    - 状态：$q = [0.3, 0.7]$。\n    - 内部边：一条从 $i=0$ 到 $j=1$ 的边，其 $A_e = 1$，$d_{ij} = 1$，且 $\\mathbf{n}_{01} = (1, 0)$。\n    - 参数：$u_0 = 0.5$, $\\alpha = 0.2$, $\\mathbf{v}_{\\mathrm{dir}} = (1, 0)$, $k_0 = 0.05$, $\\beta = 0.1$。\n- 测试用例 2 (带狄利克雷边界的一维链)：\n    - 顶点数：$N = 3$。\n    - 状态：$q = [0.4, 0.6, 0.9]$。\n    - 内部边：$(0,1)$ 和 $(1,2)$，其 $A_e = 1$，$d_{ij} = 1$，且 $\\mathbf{n}_{ij} = (1, 0)$，方向从较低索引指向较高索引。\n    - 狄利克雷边界：在顶点 $0$ 处，$A_b = 1$，$d_{0B} = 0.5$，$\\mathbf{n}_b = (-1, 0)$，$q_{\\mathrm{bc}} = 0.2$；在顶点 $2$ 处，$A_b = 1$，$d_{2B} = 0.5$，$\\mathbf{n}_b = (1, 0)$，$q_{\\mathrm{bc}} = 1.0$。\n    - 参数：$u_0 = 0.3$, $\\alpha = 0.15$, $\\mathbf{v}_{\\mathrm{dir}} = (1, 0)$, $k_0 = 0.03$, $\\beta = 0.05$。\n- 测试用例 3 (带混合边界的二维十字形)：\n    - 顶点数：$N = 4$，其位置隐含地定义了方向，如下所示。\n    - 状态：顶点 $[0,1,2,3]$ 对应的状态为 $q = [0.6, 0.9, 0.5, 0.7]$，位置为 $[(0,0),(1,0),(0,1),(1,1)]$。\n    - 内部边：$(0,1)$ 和 $(2,3)$ 的 $\\mathbf{n}_{ij} = (1,0)$，$(0,2)$ 和 $(1,3)$ 的 $\\mathbf{n}_{ij} = (0,1)$。所有边均有 $A_e = 1$，$d_{ij} = 1$，法向量方向从较低索引指向较高索引。\n    - 诺伊曼边界：在顶点 $2$ 处，$A_b = 1$，$\\mathbf{n}_b = (0,1)$，给定的扩散通量 $h = 0.02$，入流状态 $q_{\\mathrm{in}} = 0.5$；在顶点 $3$ 处，$A_b = 1$，$\\mathbf{n}_b = (0,1)$，$h = 0.02$，$q_{\\mathrm{in}} = 0.5$；在顶点 $0$ 处，$A_b = 1$，$\\mathbf{n}_b = (0,-1)$，$h = 0.02$，$q_{\\mathrm{in}} = 0.8$；在顶点 $1$ 处，$A_b = 1$，$\\mathbf{n}_b = (0,-1)$，$h = 0.02$，$q_{\\mathrm{in}} = 0.8$。\n    - 参数：$u_0 = 0.4$, $\\alpha = 0.1$, $\\mathbf{v}_{\\mathrm{dir}} = \\left(\\frac{1}{\\sqrt{2}}, \\frac{1}{\\sqrt{2}}\\right)$, $k_0 = 0.04$, $\\beta = 0.08$。\n\n最终输出格式：\n- 您的程序应生成一行输出，其中包含六个结果，以逗号分隔的列表形式包含在方括号中，顺序为测试用例 1 的 $[\\lVert R \\rVert_2^2,\\rho(J)]$，然后是测试用例 2，然后是测试用例 3。例如，输出行应如下所示\n$$[\\text{r1},\\text{rho1},\\text{r2},\\text{rho2},\\text{r3},\\text{rho3}].$$\n每个条目必须是一个浮点数。",
            "solution": "为给定的非线性对流扩散问题组装残差向量 $R$ 和雅可比矩阵 $J$ 的方法基于标准的以顶点为中心的有限体积公式。组装过程迭代遍历所有网格边和边界面，累积对 $R$ 和 $J$ 的贡献。所有量均为无量纲。\n\n每个测试用例的总体算法如下：\n1. 给定 $N$ 个顶点，将残差向量 $R$ 初始化为大小为 $N$ 的零向量，将雅可比矩阵 $J$ 初始化为大小为 $N \\times N$ 的零矩阵。\n2. 对于连接顶点 $i$ 和 $j$ 的每条内部边，计算数值通量 $F^{ij}$ 及其导数 $\\frac{\\partial F^{ij}}{\\partial q_i}$ 和 $\\frac{\\partial F^{ij}}{\\partial q_j}$。更新 $R_i, R_j$ 以及 $J$ 在索引 $(i,i), (i,j), (j,i), (j,j)$ 处的 $2 \\times 2$ 子矩阵。\n3. 对于顶点 $i$ 处的每个边界面，计算边界通量 $F_b$ 及其导数 $\\frac{\\partial F_b}{\\partial q_i}$。更新 $R_i$ 和对角线元素 $J_{ii}$。\n4. 在所有贡献被求和后，计算最终度量：残差的 $L_2$ 范数平方 $\\lVert R \\rVert_2^2$，以及雅可比矩阵的谱半径 $\\rho(J) = \\max_k |\\lambda_k|$，其中 $\\lambda_k$ 是 $J$ 的特征值。\n\n对流速度和扩散系数的本构关系是依赖于 $q$ 的：\n- 对流速度：$\\mathbf{u}(q) = (u_0 + \\alpha q^2)\\mathbf{v}_{\\mathrm{dir}}$\n- 扩散系数：$k(q) = k_0 + \\beta q$\n\n**1. 内部边贡献**\n\n对于连接状态为 $q_i$ 和 $q_j$ 的顶点 $i$ 和 $j$ 的每条内部边，执行以下步骤：\n\n- **计算平均量**：\n  - 用于非线性速度的状态：$q_{\\mathrm{avg}} = \\frac{q_i + q_j}{2}$。\n  - 法向速度分量：$s = \\mathbf{u}(q_{\\mathrm{avg}}) \\cdot \\mathbf{n}_{ij}$，其中 $\\mathbf{n}_{ij}$ 是从控制体 $i$ 指向 $j$ 的单位法向量。\n  - 平均扩散系数：$k_{\\mathrm{avg}} = \\frac{k(q_i) + k(q_j)}{2} = k_0 + \\beta q_{\\mathrm{avg}}$。\n\n- **计算数值通量 $F^{ij}$**：\n  - 对流部分 (Rusanov)：$F_{\\mathrm{adv}}^{ij} = A_e\\left[s\\,q_{\\mathrm{avg}} + \\frac{1}{2}\\,\\lvert s \\rvert\\,(q_i - q_j)\\right]$。\n  - 扩散部分 (两点)：$F_{\\mathrm{diff}}^{ij} = -A_e\\,k_{\\mathrm{avg}}\\,\\frac{q_j - q_i}{d_{ij}}$。\n  - 从控制体 $i$ 流向 $j$ 的总通量：$F^{ij} = F_{\\mathrm{adv}}^{ij} + F_{\\mathrm{diff}}^{ij}$。\n\n- **组装残差向量 $R$**：\n  通量 $F^{ij}$ 加到 $R_i$ 上，并为确保守恒，从 $R_j$ 中减去：\n  $$R_i \\leftarrow R_i + F^{ij}$$\n  $$R_j \\leftarrow R_j - F^{ij}$$\n\n- **组装雅可比矩阵 $J$**：\n  总通量的导数 $\\frac{\\partial F^{ij}}{\\partial q_i}$ 和 $\\frac{\\partial F^{ij}}{\\partial q_j}$ 使用所提供的公式计算，这些公式是通过链式法则推导出来的。这涉及到中间项（如 $s$ 和 $k_{\\mathrm{avg}}$）的导数。例如，一个关键项是 $\\frac{\\partial s}{\\partial q_k} = \\alpha q_{\\mathrm{avg}} (\\mathbf{v}_{\\mathrm{dir}} \\cdot \\mathbf{n}_{ij})$，其中 $k \\in \\{i,j\\}$。项 $\\sigma = \\mathrm{sign}(s)$ 用于 Rusanov 人工耗散的导数；对于 $s=0$，我们取 $\\sigma=0$。\n  然后按如下方式更新雅可比矩阵：\n  $$J_{ii} \\leftarrow J_{ii} + \\frac{\\partial F^{ij}}{\\partial q_i}, \\quad J_{ij} \\leftarrow J_{ij} + \\frac{\\partial F^{ij}}{\\partial q_j}$$\n  $$J_{ji} \\leftarrow J_{ji} - \\frac{\\partial F^{ij}}{\\partial q_i}, \\quad J_{jj} \\leftarrow J_{jj} - \\frac{\\partial F^{ij}}{\\partial q_j}$$\n\n**2. 边界面贡献**\n\n- **顶点 $i$ 处的狄利克雷边界**：\n  给定一个状态 $q_{\\mathrm{bc}}$。通量 $F^{iB}$ 使用与内部边相同的通量函数计算，但用 $q_{\\mathrm{bc}}$ 替换 $q_j$，并使用几何因子 $A_b$、$\\mathbf{n}_b$、$d_{iB}$。\n  - 残差更新：$R_i \\leftarrow R_i + F^{iB}$。\n  - 雅可比矩阵更新：计算导数 $\\frac{\\partial F^{iB}}{\\partial q_i}$ 并将其加到一个雅可比矩阵条目上，因为 $q_{\\mathrm{bc}}$ 是一个常数参数：$J_{ii} \\leftarrow J_{ii} + \\frac{\\partial F^{iB}}{\\partial q_i}$。\n\n- **顶点 $i$ 处的诺伊曼边界**：\n  给定法向扩散通量 $h$，因此 $F_{\\mathrm{diff}}^{iN} = A_b h$。对流通量 $F_{\\mathrm{adv}}^{iN}$ 根据局部速度 $s = \\mathbf{u}(q_i) \\cdot \\mathbf{n}_b$ 的符号进行迎风处理：$F_{\\mathrm{adv}}^{iN} = A_b[\\max(s,0) q_i + \\min(s,0) q_{\\mathrm{in}}]$。\n  - 总通量：$F^{iN} = F_{\\mathrm{adv}}^{iN} + F_{\\mathrm{diff}}^{iN}$。\n  - 残差更新：$R_i \\leftarrow R_i + F^{iN}$。\n  - 雅可比矩阵更新：导数 $\\frac{\\partial F^{iN}}{\\partial q_i} = \\frac{\\partial F_{\\mathrm{adv}}^{iN}}{\\partial q_i}$ 使用分段公式计算。在 $s=0$ 处，导数取为 $0$。更新为：$J_{ii} \\leftarrow J_{ii} + \\frac{\\partial F^{iN}}{\\partial q_i}$。\n\n**3. 最终度量**\n\n一旦 $R$ 和 $J$ 完全组装完毕，计算最终度量：\n- 残差的 $L_2$ 范数平方：$\\lVert R \\rVert_2^2 = \\sum_{k=0}^{N-1} R_k^2$。\n- 雅可比矩阵的谱半径：$\\rho(J) = \\max_k |\\lambda_k|$，其中 $J$ 的特征值 $\\lambda_k$ 是通过数值方法找到的。\n\n为每个测试用例实施这一综合程序，以获得所需结果。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to orchestrate the solution for all test cases.\n    \"\"\"\n\n    test_cases = [\n        # Test case 1 (interior-only pair)\n        {\n            'N': 2,\n            'q': np.array([0.3, 0.7]),\n            'params': {'u0': 0.5, 'alpha': 0.2, 'v_dir': np.array([1.0, 0.0]), 'k0': 0.05, 'beta': 0.1},\n            'interior_edges': [\n                {'verts': (0, 1), 'Ae': 1.0, 'd': 1.0, 'n': np.array([1.0, 0.0])}\n            ],\n            'dirichlet_bcs': [],\n            'neumann_bcs': []\n        },\n        # Test case 2 (one-dimensional chain with Dirichlet boundaries)\n        {\n            'N': 3,\n            'q': np.array([0.4, 0.6, 0.9]),\n            'params': {'u0': 0.3, 'alpha': 0.15, 'v_dir': np.array([1.0, 0.0]), 'k0': 0.03, 'beta': 0.05},\n            'interior_edges': [\n                {'verts': (0, 1), 'Ae': 1.0, 'd': 1.0, 'n': np.array([1.0, 0.0])},\n                {'verts': (1, 2), 'Ae': 1.0, 'd': 1.0, 'n': np.array([1.0, 0.0])}\n            ],\n            'dirichlet_bcs': [\n                {'vert': 0, 'Ab': 1.0, 'd': 0.5, 'n': np.array([-1.0, 0.0]), 'q_bc': 0.2},\n                {'vert': 2, 'Ab': 1.0, 'd': 0.5, 'n': np.array([1.0, 0.0]), 'q_bc': 1.0}\n            ],\n            'neumann_bcs': []\n        },\n        # Test case 3 (2D cross with mixed boundaries)\n        {\n            'N': 4,\n            'q': np.array([0.6, 0.9, 0.5, 0.7]),\n            'params': {'u0': 0.4, 'alpha': 0.1, 'v_dir': np.array([1/np.sqrt(2), 1/np.sqrt(2)]), 'k0': 0.04, 'beta': 0.08},\n            'interior_edges': [\n                {'verts': (0, 1), 'Ae': 1.0, 'd': 1.0, 'n': np.array([1.0, 0.0])},\n                {'verts': (2, 3), 'Ae': 1.0, 'd': 1.0, 'n': np.array([1.0, 0.0])},\n                {'verts': (0, 2), 'Ae': 1.0, 'd': 1.0, 'n': np.array([0.0, 1.0])},\n                {'verts': (1, 3), 'Ae': 1.0, 'd': 1.0, 'n': np.array([0.0, 1.0])}\n            ],\n            'dirichlet_bcs': [],\n            'neumann_bcs': [\n                {'vert': 2, 'Ab': 1.0, 'n': np.array([0.0, 1.0]), 'h': 0.02, 'q_in': 0.5},\n                {'vert': 3, 'Ab': 1.0, 'n': np.array([0.0, 1.0]), 'h': 0.02, 'q_in': 0.5},\n                {'vert': 0, 'Ab': 1.0, 'n': np.array([0.0, -1.0]), 'h': 0.02, 'q_in': 0.8},\n                {'vert': 1, 'Ab': 1.0, 'n': np.array([0.0, -1.0]), 'h': 0.02, 'q_in': 0.8}\n            ]\n        }\n    ]\n    \n    results = []\n    \n    for case in test_cases:\n        N = case['N']\n        q_vec = case['q']\n        params = case['params']\n        \n        R = np.zeros(N)\n        J = np.zeros((N, N))\n        \n        u0, alpha, v_dir, k0, beta = params['u0'], params['alpha'], params['v_dir'], params['k0'], params['beta']\n        \n        # Helper functions for the model\n        def u_vec(q_scalar):\n            return (u0 + alpha * q_scalar**2) * v_dir\n        \n        def k_scal(q_scalar):\n            return k0 + beta * q_scalar\n\n        # Interior Edges\n        for edge in case['interior_edges']:\n            i, j = edge['verts']\n            Ae, d_ij, n_ij = edge['Ae'], edge['d'], edge['n']\n            q_i, q_j = q_vec[i], q_vec[j]\n            \n            q_avg = 0.5 * (q_i + q_j)\n            s = np.dot(u_vec(q_avg), n_ij)\n            s_abs = np.abs(s)\n            sigma = np.sign(s)\n            \n            k_avg = 0.5 * (k_scal(q_i) + k_scal(q_j))\n\n            # Flux calculation\n            F_adv_ij = Ae * (s * q_avg + 0.5 * s_abs * (q_i - q_j))\n            F_diff_ij = -Ae * k_avg * (q_j - q_i) / d_ij\n            F_ij = F_adv_ij + F_diff_ij\n            \n            R[i] += F_ij\n            R[j] -= F_ij\n            \n            # Jacobian calculation\n            v_n = np.dot(v_dir, n_ij)\n            ds_dqi = alpha * q_avg * v_n\n            ds_dqj = ds_dqi\n            \n            dF_adv_dqi = Ae * (ds_dqi * q_avg + 0.5 * s + 0.5 * sigma * ds_dqi * (q_i - q_j) + 0.5 * s_abs)\n            dF_adv_dqj = Ae * (ds_dqj * q_avg + 0.5 * s + 0.5 * sigma * ds_dqj * (q_i - q_j) - 0.5 * s_abs)\n\n            dF_diff_dqi = -Ae * (0.5 * beta * (q_j - q_i) / d_ij - k_avg / d_ij)\n            dF_diff_dqj = -Ae * (0.5 * beta * (q_j - q_i) / d_ij + k_avg / d_ij)\n            \n            dF_dqi = dF_adv_dqi + dF_diff_dqi\n            dF_dqj = dF_adv_dqj + dF_diff_dqj\n\n            J[i, i] += dF_dqi\n            J[i, j] += dF_dqj\n            J[j, i] -= dF_dqi\n            J[j, j] -= dF_dqj\n\n        # Dirichlet BCs\n        for bc in case['dirichlet_bcs']:\n            i = bc['vert']\n            Ab, d_iB, n_b, q_bc = bc['Ab'], bc['d'], bc['n'], bc['q_bc']\n            q_i = q_vec[i]\n            \n            q_avg = 0.5 * (q_i + q_bc)\n            s = np.dot(u_vec(q_avg), n_b)\n            s_abs = np.abs(s)\n            sigma = np.sign(s)\n            k_avg = 0.5 * (k_scal(q_i) + k_scal(q_bc))\n            \n            F_adv_iB = Ab * (s * q_avg + 0.5 * s_abs * (q_i - q_bc))\n            F_diff_iB = -Ab * k_avg * (q_bc - q_i) / d_iB\n            F_iB = F_adv_iB + F_diff_iB\n            \n            R[i] += F_iB\n            \n            v_n = np.dot(v_dir, n_b)\n            ds_dqi = alpha * q_avg * v_n\n            \n            dF_adv_dqi = Ab * (ds_dqi * q_avg + 0.5 * s + 0.5 * sigma * ds_dqi * (q_i - q_bc) + 0.5 * s_abs)\n            dF_diff_dqi = -Ab * (0.5 * beta * (q_bc - q_i) / d_iB - k_avg / d_iB)\n            \n            J[i, i] += dF_adv_dqi + dF_diff_dqi\n\n        # Neumann BCs\n        for bc in case['neumann_bcs']:\n            i = bc['vert']\n            Ab, n_b, h, q_in = bc['Ab'], bc['n'], bc['h'], bc['q_in']\n            q_i = q_vec[i]\n            \n            s = np.dot(u_vec(q_i), n_b)\n            \n            F_adv_iN = Ab * (max(s, 0) * q_i + min(s, 0) * q_in)\n            F_diff_iN = Ab * h\n            F_iN = F_adv_iN + F_diff_iN\n\n            R[i] += F_iN\n            \n            v_n = np.dot(v_dir, n_b)\n            ds_dqi = 2 * alpha * q_i * v_n\n            dF_adv_dqi = 0.0\n            if s > 0:\n                dF_adv_dqi = Ab * (ds_dqi * q_i + s)\n            elif s  0:\n                dF_adv_dqi = Ab * (ds_dqi * q_in)\n\n            J[i, i] += dF_adv_dqi\n            \n        # Compute metrics\n        r_norm_sq = np.dot(R, R)\n        if N > 0:\n            eigenvalues = np.linalg.eigvals(J)\n            rho_J = np.max(np.abs(eigenvalues))\n        else: # Should not happen with given cases\n            rho_J = 0.0\n            \n        results.extend([r_norm_sq, rho_J])\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}