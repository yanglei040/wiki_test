{
    "hands_on_practices": [
        {
            "introduction": "高效的内存管理是高性能计算的基石，尤其是在计算流体动力学（CFD）中，网格可能包含数十亿个单元。本练习将通过分析压缩稀疏行（Compressed Sparse Row, CSR）数据结构，来提供估算网格内存占用的实践经验。CSR 是一种表示稀疏单元-顶点连接关系的标准方法，理解其内存成本对于规划和执行大规模模拟至关重要 。",
            "id": "3306188",
            "problem": "考虑一个由混合单元类型组成的非结构化三维网格，其中网格连接性由单元到顶点的邻接关系表示。单元到顶点数组为每个单元存储其关联顶点的标识符。连接性采用压缩稀疏行（CSR）格式进行布局。CSR定义如下：存在两个数组，一个行指针数组，用于存储每个单元的顶点列表的起始偏移量，其最后一个条目是末尾的专属结束偏移；以及一个列索引数组，用于存储串联起来的顶点标识符。CSR布局不使用任何辅助填充或每单元的头部信息。\n\n假设以下被广泛接受的事实和定义：\n- 单元数量表示为 $N_{c}$，顶点数量表示为 $N_{v}$，连接性条目数量表示为 $N_{e}$，其中 $N_{e} = \\sum_{i=1}^{N_{c}} k_{i}$，$k_{i}$ 是与单元 $i$ 相关联的顶点数。\n- 在CSR中，行指针数组的长度为 $N_{c}+1$，列索引数组的长度为 $N_{e}$。行指针的值是列索引数组的偏移量。\n- 一个 Mebibyte (MiB) 是 $2^{20}$ 字节。\n\n您的任务是完成以下两项：\n1. 导出CSR单元到顶点连接性的渐进内存成本，将其表示为 $N_{c}$ 和逐单元顶点数的函数，假设使用最小宽度的整数类型来安全地寻址所需范围，并明确说明在固定单元类型混合下随 $N_{c}$ 的缩放关系。\n2. 计算以下混合单元网格的实际内存占用，设计决策为行指针数组使用64位有符号整数存储，列索引数组使用32位有符号整数存储。使用给定的网格统计数据确定所需的数组长度：\n- 四面体：$13{,}500{,}000$ 个单元，每个单元4个顶点。\n- 棱锥体：$420{,}000$ 个单元，每个单元5个顶点。\n- 棱柱体：$720{,}000$ 个单元，每个单元6个顶点。\n- 六面体：$360{,}000$ 个单元，每个单元8个顶点。\n- 总顶点数：$N_{v} = 190{,}000{,}000$。\n\n假设使用从零开始的索引、连续存储，并且除了两个CSR数组外没有额外的元数据。对于整数宽度，64位值使用8字节，32位值使用4字节。以MiB为单位表示最终内存占用，并将答案四舍五入到四位有效数字。最终答案必须是单个实数值。",
            "solution": "我们从单元到顶点的连接性和压缩稀疏行（CSR）数据结构的定义开始。在CSR中，连接性由两个数组表示：\n- 一个长度为 $N_{c}+1$ 的行指针数组，用于存储指向列索引数组的偏移量，指示每个单元顶点列表的起始位置，并在末尾有一个专属的终止指针。\n- 一个长度为 $N_{e}$ 的列索引数组，用于存储串联起来的顶点标识符。\n\n根据定义，如果单元 $i$ 有 $k_{i}$ 个关联顶点，则连接性条目的总数为\n$$\nN_{e} = \\sum_{i=1}^{N_{c}} k_{i}.\n$$\n因此，CSR连接性的总内存（以字节为单位）为\n$$\nM_{\\text{bytes}} = b_{\\mathrm{rp}}(N_{c}+1) + b_{\\mathrm{ci}} N_{e},\n$$\n其中 $b_{\\mathrm{rp}}$ 是行指针数组中每个条目的字节数，$b_{\\mathrm{ci}}$ 是列索引数组中每个条目的字节数。\n\n渐进内存成本：在固定的单元类型混合下，定义每个单元的平均顶点数为\n$$\n\\bar{k} = \\frac{1}{N_{c}} \\sum_{i=1}^{N_{c}} k_{i}.\n$$\n那么 $N_{e} = \\bar{k} N_{c}$，所以总内存变为\n$$\nM_{\\text{bytes}} = b_{\\mathrm{rp}}(N_{c}+1) + b_{\\mathrm{ci}} \\bar{k} N_{c} = \\left(b_{\\mathrm{ci}} \\bar{k} + b_{\\mathrm{rp}}\\right) N_{c} + b_{\\mathrm{rp}}.\n$$\n对于大的 $N_{c}$ 和固定的混合类型（因此 $\\bar{k}$ 和 $b_{\\mathrm{rp}}, b_{\\mathrm{ci}}$ 是固定的），渐进缩放关系为\n$$\nM_{\\text{bytes}} = \\mathcal{O}(N_{c}).\n$$\n\n现在我们计算特定网格和整数宽度下的实际内存占用。网格统计数据如下：\n- 四面体：$13{,}500{,}000$ 个单元，每个4个顶点。\n- 棱锥体：$420{,}000$ 个单元，每个5个顶点。\n- 棱柱体：$720{,}000$ 个单元，每个6个顶点。\n- 六面体：$360{,}000$ 个单元，每个8个顶点。\n因此，\n$$\nN_{c} = 13{,}500{,}000 + 420{,}000 + 720{,}000 + 360{,}000 = 15{,}000{,}000.\n$$\n连接性条目的总数为\n\\begin{align*}\nN_{e} = 4 \\cdot 13{,}500{,}000 + 5 \\cdot 420{,}000 + 6 \\cdot 720{,}000 + 8 \\cdot 360{,}000 \\\\\n= 54{,}000{,}000 + 2{,}100{,}000 + 4{,}320{,}000 + 2{,}880{,}000 \\\\\n= 63{,}300{,}000.\n\\end{align*}\n总顶点数 $N_{v} = 190{,}000{,}000$ 在32位有符号整数范围内（因为 $190{,}000{,}000  2{,}147{,}483{,}647$），所以32位列索引是足够的。根据设计决策，对行指针使用64位有符号整数。因此\n$$\nb_{\\mathrm{rp}} = 8, \\quad b_{\\mathrm{ci}} = 4.\n$$\n我们计算总内存（以字节为单位）：\n\\begin{align*}\nM_{\\text{bytes}} = b_{\\mathrm{rp}}(N_{c}+1) + b_{\\mathrm{ci}} N_{e} \\\\\n= 8 \\cdot (15{,}000{,}000 + 1) + 4 \\cdot 63{,}300{,}000 \\\\\n= 8 \\cdot 15{,}000{,}001 + 253{,}200{,}000 \\\\\n= 120{,}000{,}008 + 253{,}200{,}000 \\\\\n= 373{,}200{,}008 \\text{ bytes}.\n\\end{align*}\n使用 $1 \\text{ MiB} = 2^{20} = 1{,}048{,}576$ 字节将字节转换为 Mebibyte (MiB)：\n$$\nM_{\\text{MiB}} = \\frac{373{,}200{,}008}{1{,}048{,}576}.\n$$\n现在我们计算这个商。分解计算，\n\\begin{align*}\n\\frac{120{,}000{,}008}{1{,}048{,}576} = 114 + \\frac{462{,}344}{1{,}048{,}576} \\approx 114.44097, \\\\\n\\frac{253{,}200{,}000}{1{,}048{,}576} = 241 + \\frac{493{,}184}{1{,}048{,}576} \\approx 241.47050,\n\\end{align*}\n所以\n$$\nM_{\\text{MiB}} \\approx 114.44097 + 241.47050 = 355.91147.\n$$\n四舍五入到四位有效数字得到\n$$\nM_{\\text{MiB}} \\approx 355.9.\n$$\n这就是所要求的以MiB为单位的内存占用。",
            "answer": "$$\\boxed{355.9}$$"
        },
        {
            "introduction": "数据结构的设计常常需要在内存效率和计算速度等相互竞争的目标之间取得平衡。在本练习中 ，我们将分析混合网格的一个关键设计选择：是使用单一、统一的数据结构，还是采用专门的、按单元类型划分的数据块。这个分析将揭示数据布局对存储开销以及更重要的性能关键方面（如缓存局部性和向量化）的深远影响。",
            "id": "3306212",
            "problem": "在非结构化网格的计算流体动力学中，混合网格的单元到顶点邻接关系（表示为 $C2V$）可以使用不同的数据结构来存储。考虑一个由四面体、六面体、三棱柱（也称为楔形体）和金字塔体组成的三维混合非结构化网格。设单元数量分别为：四面体 $N_{\\mathrm{tet}} = 2800000$，六面体 $N_{\\mathrm{hex}} = 200000$，楔形体 $N_{\\mathrm{wedge}} = 120000$，金字塔体 $N_{\\mathrm{pyr}} = 80000$。每个单元的顶点数分别为：四面体为 $4$ 个，六面体为 $8$ 个，楔形体为 $6$ 个，金字塔体为 $5$ 个。\n\n考虑以下两种 $C2V$ 的存储方案：\n\n- 统一压缩稀疏行（Compressed Sparse Row, CSR）方案：存储一个整数数组 $idx$，其长度等于所有单元的顶点引用总数；以及一个整数数组 $off$，其长度为 $N_c + 1$（其中 $N_c$ 是单元总数），使得单元 $i$ 的顶点列表位于 $idx[off[i] \\dots off[i+1]-1]$ 中。\n\n- 按单元类型分块的方案：对于每种具有固定元数 $k_t$ 的单元类型 $t \\in \\{\\mathrm{tet, hex, wedge, pyr}\\}$，存储一个单独的扁平整数数组 $idx_t$，其长度为 $k_t N_t$，该数组按固定顺序串联了该类型所有单元的顶点索引；为了支持通过原始全局单元标识符进行随机访问，假设全局单元标识符是不可变的，并要求为每个单元存储一个辅助映射，该映射包含两个整数：一个类型标识符和该单元在其类型特定块内的局部索引。忽略任何其他元数据或填充；仅计算本段和统一压缩稀疏行方案段落中明确描述的整数。\n\n从 $C2V$ 的定义、单元类型的元数以及上述数据结构的描述出发，推导每种方案所需的整数总数的表达式，针对给定的网格进行求值，然后计算按单元类型分块方案与统一压缩稀疏行方案之间整数数量的精确差值 $D$，定义为 $D = I_{\\mathrm{blocked}} - I_{\\mathrm{CSR}}$。\n\n此外，请解释这两种方案在存储开销、随机访问和数据局部性方面的基本权衡，并根据数组如何被索引和使用的第一性原理来证明你的表达式。你最终报告的量必须是单个整数 $D$。不需要四舍五入，也无需报告 $D$ 的物理单位。",
            "solution": "该问题要求分析混合非结构化网格上单元到顶点（$C2V$）邻接信息的两种数据存储方案，并计算它们的存储成本差异。\n\n首先，正式定义给定的参数：\n- 四面体数量：$N_{\\mathrm{tet}} = 2800000$\n- 六面体数量：$N_{\\mathrm{hex}} = 200000$\n- 楔形体数量：$N_{\\mathrm{wedge}} = 120000$\n- 金字塔体数量：$N_{\\mathrm{pyr}} = 80000$\n\n每种单元类型的元数（每个单元的顶点数）为：\n- 对于四面体：$k_{\\mathrm{tet}} = 4$\n- 对于六面体：$k_{\\mathrm{hex}} = 8$\n- 对于楔形体：$k_{\\mathrm{wedge}} = 6$\n- 对于金字塔体：$k_{\\mathrm{pyr}} = 5$\n\n网格中的单元总数 $N_c$ 是每种单元类型数量的总和：\n$$N_c = N_{\\mathrm{tet}} + N_{\\mathrm{hex}} + N_{\\mathrm{wedge}} + N_{\\mathrm{pyr}}$$\n\n顶点引用的总数，即所有单元的元数之和，为：\n$$V_{\\mathrm{refs}} = N_{\\mathrm{tet}} k_{\\mathrm{tet}} + N_{\\mathrm{hex}} k_{\\mathrm{hex}} + N_{\\mathrm{wedge}} k_{\\mathrm{wedge}} + N_{\\mathrm{pyr}} k_{\\mathrm{pyr}}$$\n\n接下来，我们推导每种方案所需的整数总存储量的表达式。\n\n**方案1：统一压缩稀疏行（CSR）方案**\n该方案由两个整数数组组成：`idx` 和 `off`。\n1.  `idx` 数组存储所有单元串联起来的顶点索引。其长度等于顶点引用的总数 $V_{\\mathrm{refs}}$。\n    $$ \\text{Length}(\\text{idx}) = V_{\\mathrm{refs}} $$\n2.  `off` 数组存储每个单元的顶点列表在 `idx` 数组中的起始位置。对于 $N_c$ 个单元，这需要 $N_c + 1$ 个整数来定义 $N_c$ 个连续的区间。\n    $$ \\text{Length}(\\text{off}) = N_c + 1 $$\n\nCSR 方案所需的整数总数 $I_{\\mathrm{CSR}}$ 是这两个数组长度的总和：\n$$ I_{\\mathrm{CSR}} = \\text{Length}(\\text{idx}) + \\text{Length}(\\text{off}) = V_{\\mathrm{refs}} + (N_c + 1) $$\n代入 $V_{\\mathrm{refs}}$ 和 $N_c$ 的表达式：\n$$ I_{\\mathrm{CSR}} = (N_{\\mathrm{tet}} k_{\\mathrm{tet}} + N_{\\mathrm{hex}} k_{\\mathrm{hex}} + N_{\\mathrm{wedge}} k_{\\mathrm{wedge}} + N_{\\mathrm{pyr}} k_{\\mathrm{pyr}}) + (N_{\\mathrm{tet}} + N_{\\mathrm{hex}} + N_{\\mathrm{wedge}} + N_{\\mathrm{pyr}} + 1) $$\n\n**方案2：按单元类型分块的方案**\n该方案将每种单元类型的顶点索引存储在单独的数组中，并使用辅助映射进行随机访问。\n1.  对于每种单元类型 $t \\in \\{\\mathrm{tet, hex, wedge, pyr}\\}$，都有一个长度为 $k_t N_t$ 的扁平整数数组 $idx_t$。这些数组的整数总数是其长度之和，恰好等于 $V_{\\mathrm{refs}}$。\n    $$ \\sum_{t} \\text{Length}(\\text{idx}_t) = N_{\\mathrm{tet}} k_{\\mathrm{tet}} + N_{\\mathrm{hex}} k_{\\mathrm{hex}} + N_{\\mathrm{wedge}} k_{\\mathrm{wedge}} + N_{\\mathrm{pyr}} k_{\\mathrm{pyr}} = V_{\\mathrm{refs}} $$\n2.  需要一个辅助映射来通过单元的全局标识符查找其数据。问题描述指出，该映射需要为“每个单元存储一个包含两个整数的辅助映射”。对于 $N_c$ 个单元总数，此映射的存储成本为 $2 N_c$。\n    $$ \\text{Storage}(\\text{mapping}) = 2 N_c $$\n\n分块方案所需的整数总数 $I_{\\mathrm{blocked}}$ 是这些部分的总和：\n$$ I_{\\mathrm{blocked}} = V_{\\mathrm{refs}} + 2 N_c $$\n代入 $N_c$ 的表达式：\n$$ I_{\\mathrm{blocked}} = (N_{\\mathrm{tet}} k_{\\mathrm{tet}} + \\ldots) + 2(N_{\\mathrm{tet}} + N_{\\mathrm{hex}} + N_{\\mathrm{wedge}} + N_{\\mathrm{pyr}}) $$\n\n**差值 $D$ 的计算**\n问题要求计算差值 $D = I_{\\mathrm{blocked}} - I_{\\mathrm{CSR}}$。\n$$ D = (V_{\\mathrm{refs}} + 2 N_c) - (V_{\\mathrm{refs}} + N_c + 1) $$\n$$ D = V_{\\mathrm{refs}} + 2 N_c - V_{\\mathrm{refs}} - N_c - 1 $$\n$$ D = N_c - 1 $$\n这个简洁的结果表明，存储成本的差异仅取决于单元的总数，而与网格的构成或单元的元数无关。\n\n现在，我们使用给定的单元数量来评估此表达式。\n首先，计算单元总数 $N_c$：\n$$ N_c = 2800000 + 200000 + 120000 + 80000 $$\n$$ N_c = 3000000 + 120000 + 80000 = 3120000 + 80000 = 3200000 $$\n现在，计算差值 $D$：\n$$ D = 3200000 - 1 = 3199999 $$\n\n**方案之间的权衡**\n推导出的表达式 $I_{\\mathrm{CSR}} = V_{\\mathrm{refs}} + N_c + 1$ 和 $I_{\\mathrm{blocked}} = V_{\\mathrm{refs}} + 2 N_c$ 是分析权衡的基础。\n\n1.  **存储开销**：两种方案中用于顶点索引的主要存储量 $V_{\\mathrm{refs}}$ 是相同的。差异在于元数据。CSR方案使用一个偏移数组，成本为 $N_c+1$ 个整数。分块方案使用一个辅助查找映射，成本为 $2 N_c$ 个整数。正如所计算的，$D = N_c - 1  0$，这意味着分块方案比CSR方案多需要 $N_c - 1$ 个整数。CSR方案的每个单元开销约为1个整数，而分块方案为2个整数。\n\n2.  **随机访问**：给定任意单元 $i$ 的全局索引，访问其顶点：\n    -   在CSR方案中，需要从 `off` 数组中读取两次内存（`off[i]` 和 `off[i+1]`）来确定包含顶点数据的 `idx` 数组的切片。这非常高效。\n    -   在分块方案中，必须首先读取单元 $i$ 的双整数辅助映射，以获取其类型 $t$ 和在该类型块内的局部索引 $j$。然后，根据类型 $t$ 选择正确的数组 $idx_t$，并通过 $j$ 计算出顶点的位置（例如，从 $j \\times k_t$ 开始）。这涉及一个额外的间接层级，并且通常需要一个条件分支（或函数指针）来处理不同的类型，这可能比直接的CSR查找稍慢。\n\n3.  **数据局部性与遍历**：这是分块方案提供显著优势的地方。\n    -   在CSR方案中，如果单元未按类型排序，遍历网格意味着对大型、统一的 `idx` 数组的访问可能是非顺序的，从而导致缓存局部性差。例如，处理一个四面体后紧接着处理一个六面体，会导致在 `idx` 内的内存访问发生跳跃。\n    -   在分块方案中，处理通常是按单元类型逐一进行的（例如，在有限元求解器中，一个积分核函数先对所有四面体运行，然后另一个核函数对所有六面体运行）。在这种常见用例中，代码会遍历像 `idx_tet` 这样的类型特定数组。该数组是一个密集的、连续的内存块，仅包含四面体的数据。这种访问模式是高度顺序的，可以带来出色的缓存性能和预取效果。此外，由于块中的所有单元都具有相同的固定元数 $k_t$，循环结构简单且规则，这非常有利于编译器优化和单指令多数据（SIMD）矢量化。而CSR方案中，单元之间的元数可变，这会使此类矢量化变得复杂或无法实现。\n\n总而言之，CSR方案内存效率更高，并提供稍快的通用随机访问。分块方案会产生存储惩罚，但为基于类型的遍历提供了卓越的数据局部性和性能，而这在许多计算求解器中是一种关键的访问模式。\n最终需要的数值答案是 $D$ 的值。",
            "answer": "$$\\boxed{3199999}$$"
        },
        {
            "introduction": "归根结底，网格数据结构是为了支持数值求解器而存在的。本练习将抽象的数据存储与有限体积法核心的具体几何计算联系起来 。通过计算有向面面积向量和单元体积，您将执行组装通量和确保守恒所需的基础步骤，这些都是 CFD 中的基本原则。",
            "id": "3306181",
            "problem": "考虑一个用于计算流体动力学 (CFD) 的非结构化网格。一个四面体单元 $\\mathcal{T}_0$ 的顶点排序为 $(v_0, v_1, v_2, v_3)$，其坐标分别为 $\\mathbf{x}_{v_0} = (0,0,0)$、$\\mathbf{x}_{v_1} = (1,0,0)$、$\\mathbf{x}_{v_2} = (0,2,0)$ 和 $\\mathbf{x}_{v_3} = (0,0,3)$，单位均为米。在此背景下，一个局部顶点顺序为 $(a,b,c)$ 的三角形面的有向面矢量 $\\mathbf{A}_f$ 由右手定则定义为\n$$\n\\mathbf{A}_f = \\frac{1}{2}\\left((\\mathbf{x}_b - \\mathbf{x}_a) \\times (\\mathbf{x}_c - \\mathbf{x}_a)\\right),\n$$\n当顺序正确时，该矢量指向单元外部。$\\mathcal{T}_0$ 的四个面在本地存储时，其顶点顺序如下：\n- 面 $f_0$ (相对 $v_0$): $(v_1, v_2, v_3)$,\n- 面 $f_1$ (相对 $v_1$): $(v_0, v_2, v_3)$,\n- 面 $f_2$ (相对 $v_2$): $(v_0, v_1, v_3)$,\n- 面 $f_3$ (相对 $v_3$): $(v_0, v_2, v_1)$.\n\n一个相邻的四面体单元 $\\mathcal{T}_1$ 与之共享面 $f_0$，其顶点为 $(v_1, v_2, v_3, v_4)$，其中 $\\mathbf{x}_{v_4} = (1,2,3)$ 米。在 $\\mathcal{T}_1$ 中，共享面 $f_0$ 以局部顶点顺序 $(v_3, v_2, v_1)$ 存储。在跨内部面的有限体积组装中，为保证一致性，每个单元的面通量贡献需要与一个符号 $s \\in \\{+1,-1\\}$ 相结合，该符号将每个单元的局部面方向映射到一个唯一的全局面方向。\n\n任务：\n1. 计算 $\\mathcal{T}_0$ 的外向有向面矢量 $\\mathbf{A}_{f_0}, \\mathbf{A}_{f_1}, \\mathbf{A}_{f_2}, \\mathbf{A}_{f_3}$，并通过与相对顶点进行测试，修正任何局部存储的、方向指向内部的面的符号。\n2. 当 $f_0$ 的唯一全局方向选定为 $(v_1, v_2, v_3)$ 时，确定为了在共享面 $f_0$ 上一致地组装来自 $\\mathcal{T}_0$ 和 $\\mathcal{T}_1$ 的通量所需的符号修正 $s_0$ 和 $s_1$。\n3. 使用散度定理和一个合适的矢量场，将 $\\mathcal{T}_0$ 的体积表示为该场在有向面上的通量，并使用有向面矢量和面心精确地计算它。\n\n以立方米 (m$^3$) 为单位表示最终体积。无需四舍五入；以单个实数形式提供精确值。",
            "solution": "该问题要求执行与非结构化网格中的一个四面体单元相关的三项任务：计算其外向面矢量，确定在共享面上进行通量组装的符号修正，以及使用散度定理计算该单元的体积。\n\n四面体 $\\mathcal{T}_0$ 的顶点由其坐标矢量给出：\n$\\mathbf{x}_{v_0} = (0,0,0)$\n$\\mathbf{x}_{v_1} = (1,0,0)$\n$\\mathbf{x}_{v_2} = (0,2,0)$\n$\\mathbf{x}_{v_3} = (0,0,3)$\n\n对于一个局部顶点顺序为 $(a,b,c)$ 的面，其有向面矢量 $\\mathbf{A}_f$ 定义为 $\\mathbf{A}_f = \\frac{1}{2}((\\mathbf{x}_b - \\mathbf{x}_a) \\times (\\mathbf{x}_c - \\mathbf{x}_a))$。\n\n### 任务 1：$\\mathcal{T}_0$ 的外向有向面矢量\n\n对于每个面，我们首先根据给定的局部顶点顺序计算一个临时面矢量 $\\mathbf{A}'_f$。然后我们判断该矢量是指向外部还是内部。要求矢量必须指向外部。为了检查方向，我们构建一个从面上的一个顶点指向该面相对顶点的矢量 $\\mathbf{d}$ (例如, $\\mathbf{d} = \\mathbf{x}_{v_{opp}} - \\mathbf{x}_a$)。这个矢量 $\\mathbf{d}$ 从该面指向单元内部。一个外向法矢量 $\\mathbf{A}_{f}$ 必须与 $\\mathbf{d}$ 形成大于 $90^\\circ$ 的夹角，这意味着它们的点积必须为负 ($\\mathbf{A}_{f} \\cdot \\mathbf{d}  0$)。\n- 如果 $\\mathbf{A}'_f \\cdot \\mathbf{d}  0$，$\\mathbf{A}'_f$ 已经指向外部，因此 $\\mathbf{A}_f = \\mathbf{A}'_f$。\n- 如果 $\\mathbf{A}'_f \\cdot \\mathbf{d} > 0$，$\\mathbf{A}'_f$ 指向内部，因此我们必须反转其方向：$\\mathbf{A}_f = -\\mathbf{A}'_f$。\n\n**面 $f_0$**：顺序 $(v_1, v_2, v_3)$，相对顶点 $v_0$。\n- $\\mathbf{x}_{v_2} - \\mathbf{x}_{v_1} = (0-1, 2-0, 0-0) = (-1, 2, 0)$。\n- $\\mathbf{x}_{v_3} - \\mathbf{x}_{v_1} = (0-1, 0-0, 3-0) = (-1, 0, 3)$。\n- $\\mathbf{A}'_{f_0} = \\frac{1}{2} \\left( (-1, 2, 0) \\times (-1, 0, 3) \\right) = \\frac{1}{2}(6, 3, 2) = (3, \\frac{3}{2}, 1)$。\n- 使用 $\\mathbf{d} = \\mathbf{x}_{v_0} - \\mathbf{x}_{v_1} = (-1, 0, 0)$ 进行方向检查。\n- $\\mathbf{A}'_{f_0} \\cdot \\mathbf{d} = (3, \\frac{3}{2}, 1) \\cdot (-1, 0, 0) = -3$。由于点积为负，$\\mathbf{A}'_{f_0}$ 指向外部。\n- $\\mathbf{A}_{f_0} = (3, \\frac{3}{2}, 1)$。\n\n**面 $f_1$**：顺序 $(v_0, v_2, v_3)$，相对顶点 $v_1$。\n- $\\mathbf{x}_{v_2} - \\mathbf{x}_{v_0} = (0, 2, 0)$。\n- $\\mathbf{x}_{v_3} - \\mathbf{x}_{v_0} = (0, 0, 3)$。\n- $\\mathbf{A}'_{f_1} = \\frac{1}{2} \\left( (0, 2, 0) \\times (0, 0, 3) \\right) = \\frac{1}{2}(6, 0, 0) = (3, 0, 0)$。\n- 使用 $\\mathbf{d} = \\mathbf{x}_{v_1} - \\mathbf{x}_{v_0} = (1, 0, 0)$ 进行方向检查。\n- $\\mathbf{A}'_{f_1} \\cdot \\mathbf{d} = (3, 0, 0) \\cdot (1, 0, 0) = 3$。由于点积为正，$\\mathbf{A}'_{f_1}$ 指向内部。\n- $\\mathbf{A}_{f_1} = -(3, 0, 0) = (-3, 0, 0)$。\n\n**面 $f_2$**：顺序 $(v_0, v_1, v_3)$，相对顶点 $v_2$。\n- $\\mathbf{x}_{v_1} - \\mathbf{x}_{v_0} = (1, 0, 0)$。\n- $\\mathbf{x}_{v_3} - \\mathbf{x}_{v_0} = (0, 0, 3)$。\n- $\\mathbf{A}'_{f_2} = \\frac{1}{2} \\left( (1, 0, 0) \\times (0, 0, 3) \\right) = \\frac{1}{2}(0, -3, 0) = (0, -\\frac{3}{2}, 0)$。\n- 使用 $\\mathbf{d} = \\mathbf{x}_{v_2} - \\mathbf{x}_{v_0} = (0, 2, 0)$ 进行方向检查。\n- $\\mathbf{A}'_{f_2} \\cdot \\mathbf{d} = (0, -\\frac{3}{2}, 0) \\cdot (0, 2, 0) = -3$。由于点积为负，$\\mathbf{A}'_{f_2}$ 指向外部。\n- $\\mathbf{A}_{f_2} = (0, -\\frac{3}{2}, 0)$。\n\n**面 $f_3$**：顺序 $(v_0, v_2, v_1)$，相对顶点 $v_3$。\n- $\\mathbf{x}_{v_2} - \\mathbf{x}_{v_0} = (0, 2, 0)$。\n- $\\mathbf{x}_{v_1} - \\mathbf{x}_{v_0} = (1, 0, 0)$。\n- $\\mathbf{A}'_{f_3} = \\frac{1}{2} \\left( (0, 2, 0) \\times (1, 0, 0) \\right) = \\frac{1}{2}(0, 0, -2) = (0, 0, -1)$。\n- 使用 $\\mathbf{d} = \\mathbf{x}_{v_3} - \\mathbf{x}_{v_0} = (0, 0, 3)$ 进行方向检查。\n- $\\mathbf{A}'_{f_3} \\cdot \\mathbf{d} = (0, 0, -1) \\cdot (0, 0, 3) = -3$。由于点积为负，$\\mathbf{A}'_{f_3}$ 指向外部。\n- $\\mathbf{A}_{f_3} = (0, 0, -1)$。\n\n对于一个封闭单元，所有外向面矢量的总和必须为零：\n$\\sum_{i=0}^3 \\mathbf{A}_{f_i} = (3, \\frac{3}{2}, 1) + (-3, 0, 0) + (0, -\\frac{3}{2}, 0) + (0, 0, -1) = (0, 0, 0)$。这验证了这些矢量的正确性。\n\n### 任务 2：通量组装的符号修正\n面 $f_0$ 的全局方向由顶点顺序 $(v_1, v_2, v_3)$ 给出。相应的全局面矢量为：\n$\\mathbf{A}_{f_0, \\text{global}} = \\frac{1}{2}((\\mathbf{x}_{v_2}-\\mathbf{x}_{v_1})\\times(\\mathbf{x}_{v_3}-\\mathbf{x}_{v_1})) = (3, \\frac{3}{2}, 1)$。\n\n单元 $\\mathcal{T}_0$ 的符号 $s_0$ 将全局方向映射到该单元的局部外向方向：$s_0 \\mathbf{A}_{f_0, \\text{global}} = \\mathbf{A}_{f_0}$。\n- 对于 $\\mathcal{T}_0$，外向矢量为 $\\mathbf{A}_{f_0} = (3, \\frac{3}{2}, 1)$。\n- $s_0 (3, \\frac{3}{2}, 1) = (3, \\frac{3}{2}, 1) \\implies s_0 = 1$。\n\n单元 $\\mathcal{T}_1$ 的符号 $s_1$ 将全局方向映射到单元 $\\mathcal{T}_1$ 在共享面上的局部外向方向 $\\mathbf{A}_{f_0, \\mathcal{T}_1}$。\n- 在 $\\mathcal{T}_1$ 中，面 $f_0$ 的顺序为 $(v_3, v_2, v_1)$。临时矢量为 $\\mathbf{A}'_{f_0, \\mathcal{T}_1} = \\frac{1}{2}((\\mathbf{x}_{v_2}-\\mathbf{x}_{v_3})\\times(\\mathbf{x}_{v_1}-\\mathbf{x}_{v_3})) = \\frac{1}{2}((0,2,-3)\\times(1,0,-3)) = \\frac{1}{2}(-6, -3, -2) = (-3, -\\frac{3}{2}, -1)$。\n- 在 $\\mathcal{T}_1$ 中，相对顶点是 $v_4$，其坐标为 $\\mathbf{x}_{v_4}=(1,2,3)$。方向检查矢量是 $\\mathbf{d}_1=\\mathbf{x}_{v_4}-\\mathbf{x}_{v_3}=(1,2,0)$。\n- $\\mathbf{A}'_{f_0, \\mathcal{T}_1} \\cdot \\mathbf{d}_1 = (-3, -\\frac{3}{2}, -1) \\cdot (1,2,0) = -3 - 3 = -6$。点积为负，所以 $\\mathbf{A}'_{f_0, \\mathcal{T}_1}$ 对于 $\\mathcal{T}_1$ 是外向的。\n- 在 $\\mathcal{T}_1$ 上，面 $f_0$ 的外向矢量是 $\\mathbf{A}_{f_0, \\mathcal{T}_1} = (-3, -\\frac{3}{2}, -1)$。\n- 符号 $s_1$ 由 $s_1 \\mathbf{A}_{f_0, \\text{global}} = \\mathbf{A}_{f_0, \\mathcal{T}_1}$ 得出。\n- $s_1 (3, \\frac{3}{2}, 1) = (-3, -\\frac{3}{2}, -1) \\implies s_1 = -1$。\n\n因此，符号修正为 $s_0 = 1$ 和 $s_1 = -1$。\n\n### 任务 3：使用散度定理计算 $\\mathcal{T}_0$ 的体积\n散度定理指出 $\\int_V (\\nabla \\cdot \\mathbf{F}) dV = \\oint_{\\partial V} \\mathbf{F} \\cdot d\\mathbf{S}$。为了计算体积 $V = \\int_V 1\\,dV$，我们选择一个矢量场 $\\mathbf{F}$，使其散度为 1，即 $\\nabla \\cdot \\mathbf{F} = 1$。一个方便的选择是 $\\mathbf{F}(\\mathbf{x}) = \\frac{1}{3}\\mathbf{x} = \\frac{1}{3}(x, y, z)$，对于该场，$\\nabla \\cdot \\mathbf{F} = \\frac{1}{3} + \\frac{1}{3} + \\frac{1}{3} = 1$。\n\n体积则由边界 $\\partial\\mathcal{T}_0$ 上的面积分给出：\n$$V_{\\mathcal{T}_0} = \\oint_{\\partial\\mathcal{T}_0} \\mathbf{F} \\cdot d\\mathbf{S} = \\sum_{i=0}^{3} \\int_{f_i} \\mathbf{F} \\cdot d\\mathbf{S}_i$$\n由于 $\\mathbf{F}$ 是一个线性函数且每个面都是平面的，该面积分可以通过取 $\\mathbf{F}$ 在面心 $\\mathbf{x}_{c,i}$ 处的值与总面矢量 $\\mathbf{A}_{f_i}$ 进行点乘来精确计算：\n$$V_{\\mathcal{T}_0} = \\sum_{i=0}^{3} \\mathbf{F}(\\mathbf{x}_{c,i}) \\cdot \\mathbf{A}_{f_i} = \\sum_{i=0}^{3} \\left(\\frac{1}{3}\\mathbf{x}_{c,i}\\right) \\cdot \\mathbf{A}_{f_i} = \\frac{1}{3} \\sum_{i=0}^{3} (\\mathbf{x}_{c,i} \\cdot \\mathbf{A}_{f_i})$$\n顶点为 $v_a, v_b, v_c$ 的三角形面的面心是 $\\mathbf{x}_c = \\frac{1}{3}(\\mathbf{x}_{v_a} + \\mathbf{x}_{v_b} + \\mathbf{x}_{v_c})$。\n\n- **面 $f_0$** (顶点 $v_1, v_2, v_3$)：\n  $\\mathbf{x}_{c,0} = \\frac{1}{3}(\\mathbf{x}_{v_1} + \\mathbf{x}_{v_2} + \\mathbf{x}_{v_3}) = \\frac{1}{3}((1,0,0) + (0,2,0) + (0,0,3)) = \\frac{1}{3}(1,2,3)$。\n  $\\mathbf{x}_{c,0} \\cdot \\mathbf{A}_{f_0} = \\frac{1}{3}(1,2,3) \\cdot (3, \\frac{3}{2}, 1) = \\frac{1}{3}(3 + 3 + 3) = \\frac{9}{3} = 3$。\n\n- **面 $f_1$** (顶点 $v_0, v_2, v_3$)：此面位于 $x=0$ 平面上。\n  $\\mathbf{x}_{c,1} = \\frac{1}{3}(\\mathbf{x}_{v_0} + \\mathbf{x}_{v_2} + \\mathbf{x}_{v_3}) = \\frac{1}{3}(0,2,3)$。\n  $\\mathbf{x}_{c,1} \\cdot \\mathbf{A}_{f_1} = \\frac{1}{3}(0,2,3) \\cdot (-3,0,0) = 0$。\n\n- **面 $f_2$** (顶点 $v_0, v_1, v_3$)：此面位于 $y=0$ 平面上。\n  $\\mathbf{x}_{c,2} = \\frac{1}{3}(\\mathbf{x}_{v_0} + \\mathbf{x}_{v_1} + \\mathbf{x}_{v_3}) = \\frac{1}{3}(1,0,3)$。\n  $\\mathbf{x}_{c,2} \\cdot \\mathbf{A}_{f_2} = \\frac{1}{3}(1,0,3) \\cdot (0, -\\frac{3}{2}, 0) = 0$。\n\n- **面 $f_3$** (顶点 $v_0, v_2, v_1$)：此面位于 $z=0$ 平面上。\n  $\\mathbf{x}_{c,3} = \\frac{1}{3}(\\mathbf{x}_{v_0} + \\mathbf{x}_{v_2} + \\mathbf{x}_{v_1}) = \\frac{1}{3}(1,2,0)$。\n  $\\mathbf{x}_{c,3} \\cdot \\mathbf{A}_{f_3} = \\frac{1}{3}(1,2,0) \\cdot (0,0,-1) = 0$。\n\n点积之和为 $\\sum_{i=0}^{3} (\\mathbf{x}_{c,i} \\cdot \\mathbf{A}_{f_i}) = 3 + 0 + 0 + 0 = 3$。\n最后，四面体的体积为：\n$$V_{\\mathcal{T}_0} = \\frac{1}{3}(3) = 1$$\n体积为 $1$ 立方米。该值可以通过一个顶点在原点的四面体体积的标准公式得到验证：$V = \\frac{1}{6}|(\\mathbf{x}_{v_1}-\\mathbf{x}_{v_0}) \\cdot ((\\mathbf{x}_{v_2}-\\mathbf{x}_{v_0})\\times(\\mathbf{x}_{v_3}-\\mathbf{x}_{v_0}))| = \\frac{1}{6}|(1,0,0) \\cdot ((0,2,0)\\times(0,0,3))| = \\frac{1}{6}|(1,0,0)\\cdot(6,0,0)| = \\frac{6}{6} = 1$。",
            "answer": "$$\\boxed{1}$$"
        }
    ]
}