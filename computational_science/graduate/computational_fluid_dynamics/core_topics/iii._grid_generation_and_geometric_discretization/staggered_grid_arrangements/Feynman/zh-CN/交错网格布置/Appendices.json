{
    "hands_on_practices": [
        {
            "introduction": "交错网格设计的主要动机是防止在简单的同位网格（collocated grid）上出现的非物理性压力振荡。本练习将指导您通过数值方法来验证这一核心概念。您将激发一个“棋盘格”压力模式，并比较同位网格的压力梯度算子如何“看不见”这种模式，而 MAC 交错网格的算子如何正确地耦合压力与动量。",
            "id": "3365597",
            "problem": "考虑二维周期性域上的稳态不可压缩斯托克斯方程，每个方向上的长度为 $L=1$，空间坐标为 $(x,y)$，速度场为 $\\mathbf{u}(x,y) = (u(x,y), v(x,y))$：\n$$\n-\\nabla p + \\nu \\nabla^2 \\mathbf{u} = \\mathbf{f}, \\quad \\nabla \\cdot \\mathbf{u} = 0,\n$$\n其中 $p(x,y)$ 是压力，$\\nu$ 是运动粘度，$\\mathbf{f}(x,y)$ 是给定的体积力。在分步投影法中，压力场 $p$ 是通过求解以下与施加离散不可压缩性约束相关的压力泊松方程来恢复的：\n$$\n\\nabla^2 p = s,\n$$\n其中源项 $s$ 是一个由中间速度场的散度构造的离散源项。在间距为 $\\Delta x = \\Delta y$ 的均匀笛卡尔网格上，不同的网格布置会导致不同的离散梯度和散度算子。具体来说：\n- 同位（单元中心）网格布置将 $u$、$v$ 和 $p$ 全部置于单元中心。一种常见的朴素中心差分实现使用每个坐标方向上的最近邻点来计算单元中心的离散压力梯度：\n$$\n\\left(\\frac{\\partial p}{\\partial x}\\right)_{i,j}^{\\text{col}} = \\frac{p_{i+1,j} - p_{i-1,j}}{2 \\Delta x}, \\quad\n\\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j}^{\\text{col}} = \\frac{p_{i,j+1} - p_{i,j-1}}{2 \\Delta x}.\n$$\n- 标记网格法（Marker-And-Cell, MAC）交错网格布置将 $u$ 置于 $(i+\\tfrac{1}{2}, j)$ 的垂直面上，$v$ 置于 $(i, j+\\tfrac{1}{2})$ 的水平面上，$p$ 置于单元中心 $(i,j)$。离散压力梯度自然地出现在面上：\n$$\n\\left(\\frac{\\partial p}{\\partial x}\\right)_{i+\\frac{1}{2},j}^{\\text{MAC}} = \\frac{p_{i+1,j} - p_{i,j}}{\\Delta x}, \\quad\n\\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j+\\frac{1}{2}}^{\\text{MAC}} = \\frac{p_{i,j+1} - p_{i,j}}{\\Delta x}.\n$$\n\n众所周知，同位中心差分容许一种虚假的压力模式，通常称为棋盘格模式，它在一个 $N_x \\times N_y$ 均匀周期性网格上定义为\n$$\np_{i,j}^{\\text{chk}} = (-1)^{i+j}, \\quad i = 0,1,\\dots,N_x-1, \\quad j = 0,1,\\dots,N_y-1,\n$$\n并对应于最高可分辨空间频率（奈奎斯特模式）。这种模式可以被某些离散强迫项激发，并且在同位网格上，当采用从中心到面的朴素插值时，它会与动量方程解耦，导致 $p$ 中出现不驱动动量的非物理振荡。相比之下，MAC交错网格抑制了这种解耦，因为面中心的离散梯度直接对相邻单元中心的压力进行采样，棋盘格差分在面上不为零。\n\n您的任务是：\n1. 使用人工源项 $s_{i,j} = (-1)^{i+j}$ 来激发离散压力泊松方程中的棋盘格模式，该方程具有周期性边界条件，并用标准五点拉普拉斯算子进行离散化。在间距为 $\\Delta x$ 的均匀网格上，五点拉普拉斯算子的离散傅里叶符号为\n$$\n\\lambda(k_x,k_y) = \\frac{2}{\\Delta x^2}\\left(\\cos(k_x \\Delta x)-1\\right) + \\frac{2}{\\Delta x^2}\\left(\\cos(k_y \\Delta x)-1\\right)，\n$$\n其中离散波数 $k_x = \\frac{2\\pi m}{L}$，$k_y = \\frac{2\\pi n}{L}$，$m = 0,1,\\dots,N_x-1$ 且 $n = 0,1,\\dots,N_y-1$。当 $N_x$ 和 $N_y$ 为偶数时，棋盘格模式对应于 $(m,n) = (N_x/2, N_y/2)$，这使得 $\\cos(\\pi) = -1$，因此\n$$\n\\lambda_{\\text{chk}} = -\\frac{4}{\\Delta x^2} - \\frac{4}{\\Delta x^2} = -\\frac{8}{\\Delta x^2}。\n$$\n由此可知，与棋盘格强迫项相关的压力振幅的标度为\n$$\nA_p(\\Delta x) = \\frac{1}{|\\lambda_{\\text{chk}}|} = \\frac{\\Delta x^2}{8}.\n$$\n2. 在傅里叶域中，对一系列均匀网格，使用上述离散拉普拉斯符号数值求解离散周期性泊松方程 $\\nabla^2 p = s$，并通过将计算出的 $p$ 投影到 $p^{\\text{chk}}$ 上来提取棋盘格分量的数值振幅 $A_p(\\Delta x)$。\n3. 计算并比较在以下两种情况下，将会进入动量方程的面中心压力梯度的均方根（RMS）大小：\n   - 一种同位朴素面梯度，通过将相邻单元的中心梯度平均到面上获得：\n   $$\n   \\left(\\frac{\\partial p}{\\partial x}\\right)_{i+\\frac{1}{2},j}^{\\text{col-face}} = \\frac{1}{2}\\left[\\left(\\frac{\\partial p}{\\partial x}\\right)_{i,j}^{\\text{col}} + \\left(\\frac{\\partial p}{\\partial x}\\right)_{i+1,j}^{\\text{col}}\\right], \\quad\n   \\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j+\\frac{1}{2}}^{\\text{col-face}} = \\frac{1}{2}\\left[\\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j}^{\\text{col}} + \\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j+1}^{\\text{col}}\\right].\n   $$\n   - 如上定义的MAC面梯度。RMS大小定义为\n   $$\n   G_{\\text{RMS}} = \\sqrt{\\frac{1}{N_f}\\sum_{f} g_f^2},\n   $$\n   其中 $g_f$ 遍历两个方向上所有的面梯度分量，$N_f$ 是面的总数。\n4. 数值上证明：\n   - 同位朴素面梯度无法感知棋盘格分量，因此对于该人工源项，其RMS大小在数值上为零，这解释了解耦现象。\n   - MAC面梯度与棋盘格模式耦合，并且对于该人工源项，其RMS大小的标度为 $\\mathcal{O}(\\Delta x)$，因为 $A_p(\\Delta x) \\sim \\Delta x^2$ 且面梯度的标度为 $A_p(\\Delta x)/\\Delta x$。\n\n实现一个程序，该程序：\n- 在长度为 $L=1$ 的周期性域上构建人工源项 $s_{i,j} = (-1)^{i+j}$。\n- 在傅里叶空间中，使用离散拉普拉斯符号求解离散泊松方程以获得 $p_{i,j}$。\n- 通过投影到 $(-1)^{i+j}$ 上计算数值棋盘格振幅 $A_p(\\Delta x)$。\n- 对得到的 $p_{i,j}$ 计算 $G_{\\text{RMS}}^{\\text{col-face}}$ 和 $G_{\\text{RMS}}^{\\text{MAC}}$。\n- 为每个网格报告元组 $(A_p(\\Delta x), G_{\\text{RMS}}^{\\text{col-face}}, G_{\\text{RMS}}^{\\text{MAC}})$。\n\n测试套件：\n- 对以下情况使用 $N_x=N_y$ 且 $L=1$ 的方形网格：\n  1. $N_x=N_y=8$（粗网格，$\\Delta x = 1/8$）。\n  2. $N_x=N_y=16$（中等网格，$\\Delta x = 1/16$）。\n  3. $N_x=N_y=32$（细网格，$\\Delta x = 1/32$）。\n  4. $N_x=N_y=64$（极细网格，$\\Delta x = 1/64$）。\n所有报告的量均为无量纲。您的程序应生成单行输出，其中包含一个由四个括号括起来的元组组成的逗号分隔列表，每个元组按 $(A_p(\\Delta x), G_{\\text{RMS}}^{\\text{col-face}}, G_{\\text{RMS}}^{\\text{MAC}})$ 的顺序排列，且与测试用例的顺序相同，例如：\n\"[(a1,b1,c1),(a2,b2,c2),(a3,b3,c3),(a4,b4,c4)]\"。",
            "solution": "我们从稳态不可压缩斯托克斯方程开始\n$$\n-\\nabla p + \\nu \\nabla^2 \\mathbf{u} = \\mathbf{f}, \\quad \\nabla \\cdot \\mathbf{u} = 0,\n$$\n在分步投影法下，该方程通过一个压力泊松方程来施加离散不可压缩性约束\n$$\n\\nabla^2 p = s，\n$$\n其中源项 $s$ 由一个中间速度的散度得到。在均匀周期性网格上，很自然地可以在离散傅里叶空间中求解这个泊松方程，这揭示了特定的空间模式如何传播到压力中。我们关注棋盘格（奈奎斯特）模式，\n$$\np_{i,j}^{\\text{chk}} = (-1)^{i+j}，\n$$\n它在相邻的单元中心之间符号交替。\n\n对于间距为 $\\Delta x$ 的均匀网格和周期性边界条件，标准的五点离散拉普拉斯算子具有傅里叶符号\n$$\n\\lambda(k_x,k_y) = \\frac{2}{\\Delta x^2}\\left(\\cos(k_x \\Delta x)-1\\right) + \\frac{2}{\\Delta x^2}\\left(\\cos(k_y \\Delta x)-1\\right)，\n$$\n其中离散波数为 $k_x = \\frac{2\\pi m}{L}$ 和 $k_y = \\frac{2\\pi n}{L}$，$m=0,\\dots,N_x-1$，$n=0,\\dots,N_y-1$，且 $L=1$。对于棋盘格模式，$(m,n)=(N_x/2, N_y/2)$ 且 $k_x \\Delta x = \\pi$，$k_y \\Delta x = \\pi$，得到\n$$\n\\lambda_{\\text{chk}} = \\frac{2}{\\Delta x^2}\\left(\\cos \\pi - 1\\right) + \\frac{2}{\\Delta x^2}\\left(\\cos \\pi - 1\\right) = \\frac{2}{\\Delta x^2}\\left(-1 - 1\\right) + \\frac{2}{\\Delta x^2}\\left(-1 - 1\\right) = -\\frac{8}{\\Delta x^2}。\n$$\n用 $s_{i,j}=(-1)^{i+j}$ 来强迫泊松方程意味着右端项仅包含此模式。因此，解与该模式成正比：\n$$\np_{i,j} = A_p(\\Delta x)\\, (-1)^{i+j}。\n$$\n将其代入傅里叶空间中的离散泊松方程可得\n$$\n\\lambda_{\\text{chk}} A_p(\\Delta x) = 1 \\quad \\Rightarrow \\quad A_p(\\Delta x) = -\\frac{1}{\\lambda_{\\text{chk}}} = \\frac{\\Delta x^2}{8}。\n$$\n因此，计算出的压力中棋盘格分量的振幅按 $\\Delta x^2$ 标度。\n\n同位网格和标记网格法（MAC）交错网格之间的区别在于压力梯度在动量方程中是如何表示的：\n- 在同位（单元中心）格式中，一种常见的朴素实现使用中心差分来估计单元中心的 $\\left(\\frac{\\partial p}{\\partial x}\\right)_{i,j}^{\\text{col}}$ 和 $\\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j}^{\\text{col}}$。对于棋盘格压力 $p_{i,j} = A_p(\\Delta x)\\,(-1)^{i+j}$，\n$$\n\\left(\\frac{\\partial p}{\\partial x}\\right)_{i,j}^{\\text{col}} = \\frac{p_{i+1,j} - p_{i-1,j}}{2 \\Delta x}\n= \\frac{A_p(\\Delta x)\\left[(-1)^{i+1+j} - (-1)^{i-1+j}\\right]}{2\\Delta x}\n= \\frac{A_p(\\Delta x)\\,(-1)^{i+j}\\left[-1 - (-1)\\right]}{2\\Delta x} = 0，\n$$\n类似的计算表明 $\\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j}^{\\text{col}}=0$。如果接着通过平均相邻中心梯度来朴素地构造面梯度，那么驱动动量方程所得到的面压力梯度仍然为零。这证明了解耦现象：在同位朴素格式中，棋盘格压力不会产生面中心的压力。\n- 在MAC交错网格布置中，面中心的离散梯度直接取相邻中心压力的差值：\n$$\n\\left(\\frac{\\partial p}{\\partial x}\\right)_{i+\\frac{1}{2},j}^{\\text{MAC}} = \\frac{p_{i+1,j} - p_{i,j}}{\\Delta x}\n= \\frac{A_p(\\Delta x)\\left[(-1)^{i+1+j} - (-1)^{i+j}\\right]}{\\Delta x}\n= \\frac{A_p(\\Delta x)\\,(-1)^{i+j}(-1 - 1)}{\\Delta x}\n= -\\frac{2\\,A_p(\\Delta x)}{\\Delta x}\\,(-1)^{i+j}。\n$$\n$\\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j+\\frac{1}{2}}^{\\text{MAC}}$ 也存在类似的表达式。因此，MAC面梯度与棋盘格模式强耦合，并驱动动量修正以抑制此类振荡。对于该人工源项，MAC面梯度的大小标度为 $\\frac{A_p(\\Delta x)}{\\Delta x} \\sim \\frac{\\Delta x^2}{\\Delta x} = \\mathcal{O}(\\Delta x)$。\n\n程序的算法设计：\n1. 对于每个具有 $N_x=N_y$ 和 $\\Delta x = 1/N_x$ 的测试网格，构造人工源项 $s_{i,j} = (-1)^{i+j}$。\n2. 计算 $s$ 的二维离散傅里叶变换以获得 $\\hat{s}(m,n)$。\n3. 对每个傅里叶模式 $(m,n)$，使用下式计算离散拉普拉斯符号 $\\lambda(m,n)$\n$$\n\\lambda(m,n) = \\frac{2}{\\Delta x^2}\\left(\\cos\\left(\\frac{2\\pi m}{N_x}\\right)-1\\right) + \\frac{2}{\\Delta x^2}\\left(\\cos\\left(\\frac{2\\pi n}{N_y}\\right)-1\\right).\n$$\n4. 对所有满足 $\\lambda(m,n) \\neq 0$ 的 $(m,n)$，计算 $\\hat{p}(m,n) = \\hat{s}(m,n) / \\lambda(m,n)$。由于交替模式，零模式 $(m,n)=(0,0)$ 在 $\\hat{s}$ 中不存在，因此不会发生除以零的情况。\n5. 进行逆变换以在物理空间中获得 $p_{i,j}$。\n6. 将 $p$ 投影到棋盘格模式上以提取振幅，\n$$\nA_p(\\Delta x) = \\frac{1}{N_x N_y} \\sum_{i=0}^{N_x-1}\\sum_{j=0}^{N_y-1} p_{i,j}(-1)^{i+j}.\n$$\n7. 使用中心差分计算同位中心梯度，然后通过将相邻中心梯度平均到面上来获得同位面梯度。计算所有面上的均方根大小：\n$$\nG_{\\text{RMS}}^{\\text{col-face}} = \\sqrt{\\frac{1}{N_f}\\sum_{f}\\left(g_{f}^{\\text{col-face}}\\right)^2}.\n$$\n8. 从相邻中心压力计算MAC面梯度及其对应的均方根大小：\n$$\nG_{\\text{RMS}}^{\\text{MAC}} = \\sqrt{\\frac{1}{N_f}\\sum_{f}\\left(g_{f}^{\\text{MAC}}\\right)^2}.\n$$\n9. 为测试套件中的每个网格输出 $(A_p(\\Delta x), G_{\\text{RMS}}^{\\text{col-face}}, G_{\\text{RMS}}^{\\text{MAC}})$，并按规定汇集成单行。\n\n预期行为：\n- 数值 $A_p(\\Delta x)$ 应与 $\\Delta x^2/8$ 近似成比例（在浮点和离散变换归一化的精度范围内）。\n- $G_{\\text{RMS}}^{\\text{col-face}}$ 应在数值上为零（达到机器精度），这表明同位朴素梯度无法感知棋盘格压力。\n- 对于该人工源项，$G_{\\text{RMS}}^{\\text{MAC}}$ 应与 $\\Delta x$ 呈线性标度关系，因为面梯度大小的行为类似于 $2 A_p(\\Delta x)/\\Delta x$。\n\n这直接展示了标记网格法（MAC）交错网格抑制棋盘格压力模式的机制：通过将速度放置在面上，离散压力梯度被评估为相邻压力的差值，对于交替模式，该差值不为零，从而将虚假模式耦合到动量中，并在其中被耗散。相比之下，用于中心压力梯度的同位朴素中心差分会消除交替分量，使得虚假压力模式得以持续存在而不影响速度场。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef discrete_laplacian_symbol(nx, ny, dx):\n    \"\"\"\n    Build the discrete Laplacian symbol lambda(m,n) for a periodic grid\n    using the five-point stencil central differences on a uniform grid.\n    \"\"\"\n    # Wavenumber indices m, n\n    m = np.arange(nx)\n    n = np.arange(ny)\n    # Cosine terms for each axis\n    cos_m = np.cos(2.0 * np.pi * m / nx)\n    cos_n = np.cos(2.0 * np.pi * n / ny)\n    # Broadcast to 2D grid of (m,n)\n    lam = (2.0 / dx**2) * (cos_m[:, None] - 1.0) + (2.0 / dx**2) * (cos_n[None, :] - 1.0)\n    return lam\n\ndef solve_poisson_checkerboard(nx, ny, L=1.0):\n    \"\"\"\n    Solve the discrete periodic Poisson equation for s_{i,j} = (-1)^{i+j}\n    using the discrete Laplacian symbol in Fourier space.\n\n    Returns:\n        p: computed pressure field (nx x ny)\n        Ap: numerical checkerboard amplitude via projection onto (-1)^{i+j}\n    \"\"\"\n    dx = L / nx\n    # Manufactured source s = (-1)^{i+j}\n    i = np.arange(nx)[:, None]\n    j = np.arange(ny)[None, :]\n    s = ((-1.0) ** (i + j)).astype(np.float64)\n\n    # FFT of source\n    s_hat = np.fft.fft2(s)\n\n    # Discrete Laplacian symbol\n    lam = discrete_laplacian_symbol(nx, ny, dx)\n\n    # Avoid division by zero: source has zero mean, so lam[0,0] won't be used\n    # Construct p_hat = s_hat / lam\n    # Use where to handle potential zeros robustly (though s_hat[0,0]==0)\n    p_hat = np.zeros_like(s_hat, dtype=np.complex128)\n    mask = lam != 0.0\n    p_hat[mask] = s_hat[mask] / lam[mask]\n\n    # Inverse FFT to get p\n    p = np.real(np.fft.ifft2(p_hat))\n\n    # Compute checkerboard amplitude Ap = mean(p * (-1)^{i+j})\n    pattern = ((-1.0) ** (i + j)).astype(np.float64)\n    Ap = np.sum(p * pattern) / (nx * ny)\n\n    return p, Ap, dx\n\ndef colocated_face_gradient_rms(p, dx):\n    \"\"\"\n    Compute colocated center gradients via central differences and then\n    naive face gradients by averaging adjacent center gradients.\n    Return RMS magnitude over all faces.\n    \"\"\"\n    nx, ny = p.shape\n\n    # Periodic shifts\n    p_ip = np.roll(p, -1, axis=0)\n    p_im = np.roll(p,  1, axis=0)\n    p_jp = np.roll(p, -1, axis=1)\n    p_jm = np.roll(p,  1, axis=1)\n\n    # Center gradients (central difference)\n    gx_c = (p_ip - p_im) / (2.0 * dx)\n    gy_c = (p_jp - p_jm) / (2.0 * dx)  # dx == dy\n\n    # Face gradients: average adjacent center gradients to faces\n    # x-faces at (i+1/2, j): average gx_c[i,j] and gx_c[i+1,j]\n    gx_face = 0.5 * (gx_c + np.roll(gx_c, -1, axis=0))\n    # y-faces at (i, j+1/2): average gy_c[i,j] and gy_c[i,j+1]\n    gy_face = 0.5 * (gy_c + np.roll(gy_c, -1, axis=1))\n\n    # RMS over all faces (both directions)\n    # Number of faces: 2 * nx * ny\n    rms = np.sqrt((np.sum(gx_face**2) + np.sum(gy_face**2)) / (2.0 * nx * ny))\n    return rms\n\ndef mac_face_gradient_rms(p, dx):\n    \"\"\"\n    Compute MAC face gradients directly from adjacent center pressures.\n    Return RMS magnitude over all faces.\n    \"\"\"\n    nx, ny = p.shape\n\n    # x-face gradient: (p_{i+1,j} - p_{i,j}) / dx\n    p_ip = np.roll(p, -1, axis=0)\n    gx_face = (p_ip - p) / dx\n\n    # y-face gradient: (p_{i,j+1} - p_{i,j}) / dx\n    p_jp = np.roll(p, -1, axis=1)\n    gy_face = (p_jp - p) / dx\n\n    rms = np.sqrt((np.sum(gx_face**2) + np.sum(gy_face**2)) / (2.0 * nx * ny))\n    return rms\n\ndef run_test_case(nx):\n    ny = nx\n    p, Ap, dx = solve_poisson_checkerboard(nx, ny, L=1.0)\n    rms_col = colocated_face_gradient_rms(p, dx)\n    rms_mac = mac_face_gradient_rms(p, dx)\n    return (Ap, rms_col, rms_mac)\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [8, 16, 32, 64]\n\n    results = []\n    for nx in test_cases:\n        Ap, rms_col, rms_mac = run_test_case(nx)\n        # Format each tuple with reasonable precision\n        results.append(f\"({Ap:.10f},{rms_col:.10e},{rms_mac:.10e})\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "一个精心设计的离散格式不仅要能避免数值伪影，还应能精确地表示基本的物理平衡。本练习将展示 MAC 网格的一个强大特性：在旋转参考系中，它能够精确地维持静水力学平衡，即离散的压力梯度可以完全抵消离心力。这项验证性练习将增强您对该格式处理体积力和曲线流动时不会引入虚假误差的信心。",
            "id": "3365551",
            "problem": "构造一个程序，在 Marker-and-Cell (MAC) 交错网格排列上验证对于刚体旋转速度场，离散压力梯度是否能完全抵消离心力。物理背景是一个密度恒定的流体，以角速度矢量 $\\boldsymbol{\\Omega}$ 进行稳态、无粘性的刚体旋转，其速度由 $\\mathbf{u} = \\boldsymbol{\\Omega} \\times \\mathbf{r}$ 给出，其中 $\\mathbf{r}$ 是位置矢量。验证必须在旋转坐标系中进行，其中离心加速度被建模为体积力，对于恒定密度 $\\rho$，静水平衡为 $-\\nabla p + \\rho \\mathbf{a}_{\\mathrm{cf}} = \\mathbf{0}$，其中 $\\mathbf{a}_{\\mathrm{cf}}$ 是离心加速度。使用经过充分检验的公式 $\\mathbf{a}_{\\mathrm{cf}} = -\\boldsymbol{\\Omega}\\times(\\boldsymbol{\\Omega}\\times \\mathbf{r})$。所有量必须以国际单位制 (SI) 处理：位置以米为单位，时间以秒为单位，质量以千克为单位，角速度以弧度/秒为单位。最终残差必须以 $\\mathrm{N/m^3}$ 表示。\n\n在嵌入平面 $z = z_0$ 的均匀、正交的二维网格上使用以下 MAC 网格定义：\n- 压力 $p$ 存储在单元中心，坐标为 $(x_{i+\\frac{1}{2}}, y_{j+\\frac{1}{2}})$，其中 $x_{i+\\frac{1}{2}} = x_{\\min} + (i+\\frac{1}{2})\\Delta x$ 和 $y_{j+\\frac{1}{2}} = y_{\\min} + (j+\\frac{1}{2})\\Delta y$，对于整数 $i \\in \\{0,\\dots,N_x-1\\}$ 和 $j \\in \\{0,\\dots,N_y-1\\}$。\n- $x$-动量（$u$-速度位置）位于 $x$-面的中心，坐标为 $(x_{i+1}, y_{j+\\frac{1}{2}})$，其中 $x_{i+1} = x_{\\min} + (i+1)\\Delta x$，对于 $i \\in \\{0,\\dots,N_x-2\\}$ 和 $j \\in \\{0,\\dots,N_y-1\\}$。在 $(i+\\frac{1}{2},j+\\frac{1}{2})$ 处，$x$-动量方程中的 MAC 离散压力梯度定义为 $-\\partial p/\\partial x \\approx -\\left(p_{i+1,j} - p_{i,j}\\right)/\\Delta x$。\n- $y$-动量（$v$-速度位置）位于 $y$-面的中心，坐标为 $(x_{i+\\frac{1}{2}}, y_{j+1})$，其中 $y_{j+1} = y_{\\min} + (j+1)\\Delta y$，对于 $i \\in \\{0,\\dots,N_x-1\\}$ 和 $j \\in \\{0,\\dots,N_y-2\\}$。在 $(i+\\frac{1}{2},j+\\frac{1}{2})$ 处，$y$-动量方程中的 MAC 离散压力梯度定义为 $-\\partial p/\\partial y \\approx -\\left(p_{i,j+1} - p_{i,j}\\right)/\\Delta y$。\n\n你必须：\n- 从第一性原理推导出一个在刚体旋转下、恒定密度为 $\\rho$ 的流体压力场 $p(\\mathbf{r})$，使得连续静水平衡 $-\\nabla p + \\rho \\mathbf{a}_{\\mathrm{cf}} = \\mathbf{0}$ 成立。\n- 使用该 $p(\\mathbf{r})$，在所有单元中心计算 $p$，在面中心计算 MAC 离散压力梯度，在相同的面中心计算 $\\rho \\mathbf{a}_{\\mathrm{cf}}$，然后计算 $x$- 和 $y$-动量方程中的逐点残差：在 $x$-面上为 $R_x = -\\left(p_{i+1,j}-p_{i,j}\\right)/\\Delta x + \\rho \\, a_{\\mathrm{cf},x}$，在 $y$-面上为 $R_y = -\\left(p_{i,j+1}-p_{i,j}\\right)/\\Delta y + \\rho \\, a_{\\mathrm{cf},y}$。\n- 通过报告所有内面和两个分量上的最大绝对残差来汇总结果，即 $\\max\\left(\\max_{i,j} |R_x|, \\max_{i,j} |R_y|\\right)$，单位为 $\\mathrm{N/m^3}$。\n\n角度单位：$\\boldsymbol{\\Omega} = (\\Omega_x,\\Omega_y,\\Omega_z)$ 中的角速度矢量分量单位是弧度/秒。距离单位是米。密度单位是 $\\mathrm{kg/m^3}$。残差必须以 $\\mathrm{N/m^3}$ 报告。\n\n测试套件：\n对于以下每一组参数，计算上述的单个标量输出。\n\n- 测试 1（正常路径，方形单元，轴对齐角速度）：\n  - $\\rho = 1000$，\n  - $\\boldsymbol{\\Omega} = (0,0,10)$，\n  - 域：$x \\in [0,1]$, $y \\in [0,1]$, $z_0 = 0$，\n  - 网格：$N_x = 64$, $N_y = 64$。\n- 测试 2（矩形单元，轴对齐角速度，偏心域）：\n  - $\\rho = 1$，\n  - $\\boldsymbol{\\Omega} = (0,0,2.5)$，\n  - 域：$x \\in [-2,3]$, $y \\in [-1,1]$, $z_0 = 0$，\n  - 网格：$N_x = 50$, $N_y = 20$。\n- 测试 3（非轴对齐角速度，非零平面偏移）：\n  - $\\rho = 1.2$，\n  - $\\boldsymbol{\\Omega} = (3,4,5)$，\n  - 域：$x \\in [1,2]$, $y \\in [-0.3,0.7]$, $z_0 = 0.2$，\n  - 网格：$N_x = 37$, $N_y = 29$。\n- 测试 4（最少内面）：\n  - $\\rho = 850$，\n  - $\\boldsymbol{\\Omega} = (0,0,0.1)$，\n  - 域：$x \\in [-1,1]$, $y \\in [-1,1]$, $z_0 = 0$，\n  - 网格：$N_x = 2$, $N_y = 2$。\n- 测试 5（更大角速度，小域）：\n  - $\\rho = 997$，\n  - $\\boldsymbol{\\Omega} = (0,0,1000)$，\n  - 域：$x \\in [0.1,0.2]$, $y \\in [-0.05,0.05]$, $z_0 = 0$，\n  - 网格：$N_x = 16$, $N_y = 16$。\n\n你的程序必须为每个测试计算单个标量 $\\max\\left(\\max_{i,j} |R_x|, \\max_{i,j} |R_y|\\right)$，并最后打印单行，其中包含以逗号分隔的列表形式的测试结果，并用方括号括起来，例如 $[r_1,r_2,r_3,r_4,r_5]$，其中每个 $r_k$ 是一个单位为 $\\mathrm{N/m^3}$ 的浮点值。",
            "solution": "用户提供的问题是计算流体动力学中一个适定的验证练习。它在科学上是合理的，并且提供了所有必需的信息。\n\n该问题要求针对一个特定情况，验证 Marker-and-Cell (MAC) 交错网格离散化的一个性质。物理场景是流体处于稳定、无粘性的刚体旋转状态。在随流体旋转的参考系中，静止流体的控制方程是压力梯度和体积力之间的静水平衡。除了可以被吸收到修正压力中的均匀重力场外，唯一考虑的体积力是离心力。平衡方程给出如下：\n$$-\\nabla p + \\rho \\mathbf{a}_{\\mathrm{cf}} = \\mathbf{0}$$\n其中 $p$ 是压力，$\\rho$ 是恒定的流体密度，$\\mathbf{a}_{\\mathrm{cf}}$ 是离心加速度。问题是要证明，当使用精确的解析压力场时，这个方程的标准 MAC 网格离散化会产生一个在机器精度范围内的零残差。这是对离散化能够精确表示某一类解析解的能力的验证。\n\n## 基于原理的设计与推导\n\n### 1. 解析压力场推导\n首先，我们推导满足连续静水平衡方程的解析压力场 $p(\\mathbf{r})$。该方程可以写成：\n$$\\nabla p = \\rho \\mathbf{a}_{\\mathrm{cf}}$$\n离心加速度由公式 $\\mathbf{a}_{\\mathrm{cf}} = -\\boldsymbol{\\Omega} \\times (\\boldsymbol{\\Omega} \\times \\mathbf{r})$ 给出，其中 $\\boldsymbol{\\Omega}$ 是恒定角速度矢量，$\\mathbf{r}$ 是位置矢量。\n\n使用矢量三重积恒等式 $\\mathbf{A} \\times (\\mathbf{B} \\times \\mathbf{C}) = \\mathbf{B}(\\mathbf{A} \\cdot \\mathbf{C}) - \\mathbf{C}(\\mathbf{A} \\cdot \\mathbf{B})$，我们展开 $\\mathbf{a}_{\\mathrm{cf}}$ 的表达式：\n$$\\mathbf{a}_{\\mathrm{cf}} = -[\\boldsymbol{\\Omega}(\\boldsymbol{\\Omega} \\cdot \\mathbf{r}) - \\mathbf{r}(\\boldsymbol{\\Omega} \\cdot \\boldsymbol{\\Omega})]$$\n$$\\mathbf{a}_{\\mathrm{cf}} = (\\boldsymbol{\\Omega} \\cdot \\boldsymbol{\\Omega})\\mathbf{r} - (\\boldsymbol{\\Omega} \\cdot \\mathbf{r})\\boldsymbol{\\Omega}$$\n令 $\\Omega^2 = |\\boldsymbol{\\Omega}|^2 = \\boldsymbol{\\Omega} \\cdot \\boldsymbol{\\Omega}$。因此，压力梯度为：\n$$\\nabla p = \\rho [ \\Omega^2 \\mathbf{r} - (\\boldsymbol{\\Omega} \\cdot \\mathbf{r})\\boldsymbol{\\Omega} ]$$\n这个矢量场是一个标量势的梯度。我们可以通过积分找到 $p(\\mathbf{r})$。我们将表达式的部分识别为标量场的梯度：\n$$\\nabla(\\frac{1}{2} r^2) = \\nabla(\\frac{1}{2} \\mathbf{r} \\cdot \\mathbf{r}) = \\mathbf{r}$$\n$$\\nabla(\\frac{1}{2}(\\boldsymbol{\\Omega} \\cdot \\mathbf{r})^2) = (\\boldsymbol{\\Omega} \\cdot \\mathbf{r}) \\nabla(\\boldsymbol{\\Omega} \\cdot \\mathbf{r}) = (\\boldsymbol{\\Omega} \\cdot \\mathbf{r})\\boldsymbol{\\Omega}$$\n将这些代入 $\\nabla p$ 的表达式中：\n$$\\nabla p = \\rho [ \\Omega^2 \\nabla(\\frac{1}{2} r^2) - \\nabla(\\frac{1}{2}(\\boldsymbol{\\Omega} \\cdot \\mathbf{r})^2) ] = \\nabla \\left[ \\frac{1}{2}\\rho ( \\Omega^2 r^2 - (\\boldsymbol{\\Omega} \\cdot \\mathbf{r})^2 ) \\right]$$\n对 $\\mathbf{r}$ 进行积分，得到压力场，其与任意常数 $p_0$ 相差一个该常数：\n$$p(\\mathbf{r}) = \\frac{1}{2}\\rho (\\Omega^2 r^2 - (\\boldsymbol{\\Omega} \\cdot \\mathbf{r})^2) + p_0$$\n这可以使用恒等式 $|\\mathbf{A} \\times \\mathbf{B}|^2 = |\\mathbf{A}|^2 |\\mathbf{B}|^2 - (\\mathbf{A} \\cdot \\mathbf{B})^2$ 更紧凑地表示：\n$$p(\\mathbf{r}) = \\frac{1}{2}\\rho |\\boldsymbol{\\Omega} \\times \\mathbf{r}|^2 + p_0$$\n由于只有压力差有意义，我们可以将参考压力 $p_0$ 设为 0。\n\n### 2. 离散化与残差分析\n问题指定了一个在平面 $z=z_0$ 中的二维 MAC 网格。压力 $p$ 位于单元中心 $(x_{i+1/2}, y_{j+1/2})$，而速度分量（以及动量方程残差）位于面中心。\n$x$-动量方程的残差 $R_x$ 在垂直面的中心，即位置 $(x_{i+1}, y_{j+1/2})$ 进行计算。残差定义为：\n$$R_x = -\\frac{p_{i+1,j} - p_{i,j}}{\\Delta x} + \\rho \\, a_{\\mathrm{cf},x}|_{(x_{i+1}, y_{j+1/2})}$$\n其中 $p_{i,j}$ 表示单元 $(i,j)$ 中心的压力，即 $p(x_{i+1/2}, y_{j+1/2}, z_0)$。\n\n一个关键的观察是，解析压力场 $p(x,y,z_0)$ 是关于空间坐标 $x$ 和 $y$ 的二次多项式。让我们展开 $p$ 的表达式，其中 $\\mathbf{r}=(x,y,z_0)$ 且 $\\boldsymbol{\\Omega}=(\\Omega_x, \\Omega_y, \\Omega_z)$：\n$$p(x,y) = \\frac{1}{2}\\rho [(\\Omega_x^2+\\Omega_y^2+\\Omega_z^2)(x^2+y^2+z_0^2) - (\\Omega_x x + \\Omega_y y + \\Omega_z z_0)^2]$$\n$$p(x,y) = A x^2 + B y^2 + C xy + D x + E y + F$$\n其中 $A, B, C, D, E, F$ 是依赖于 $\\rho, \\boldsymbol{\\Omega},$ 和 $z_0$ 的常数。\n\n离散压力梯度项 $-\\frac{p_{i+1,j} - p_{i,j}}{\\Delta x}$ 是 $-\\frac{\\partial p}{\\partial x}$ 的中心差分近似。压力值取自单元中心 $(x_{i+1/2}, y_{j+1/2})$ 和 $(x_{i+3/2}, y_{j+1/2})$。这两个位置之间的中点是 $(x_{i+1}, y_{j+1/2})$，这正是计算残差 $R_x$ 的位置。\n\n对于任意二次多项式 $f(x) = ax^2 + bx + c$，中心差分是精确的，意味着它等于中点处的解析导数：\n$$\\frac{f(x_0 + h/2) - f(x_0 - h/2)}{h} = \\frac{[a(x_0+h/2)^2 + b(x_0+h/2)+c] - [a(x_0-h/2)^2 + b(x_0-h/2)+c]}{h} = 2ax_0 + b = f'(x_0)$$\n由于我们的压力场 $p(x,y)$ 关于 $x$ 是二次的（对于固定的 $y$），离散梯度完全等于面中心处的连续梯度：\n$$\\frac{p_{i+1,j} - p_{i,j}}{\\Delta x} = \\left. \\frac{\\partial p}{\\partial x} \\right|_{(x_{i+1}, y_{j+1/2})}$$\n从我们最初的推导中，我们知道连续压力场完全平衡离心力，即 $\\nabla p = \\rho \\mathbf{a}_{\\mathrm{cf}}$。这意味着在空间中的每一点都成立 $\\frac{\\partial p}{\\partial x} = \\rho a_{\\mathrm{cf},x}$。\n因此，在面中心 $(x_{i+1}, y_{j+1/2})$ 处：\n$$\\frac{p_{i+1,j} - p_{i,j}}{\\Delta x} = \\left. \\rho a_{\\mathrm{cf},x} \\right|_{(x_{i+1}, y_{j+1/2})}$$\n将此代入残差 $R_x$ 的定义中：\n$$R_x = -\\left(\\rho a_{\\mathrm{cf},x}\\right) + \\rho a_{\\mathrm{cf},x} = 0$$\n同样的逻辑适用于 $y$-分量残差 $R_y$。因此，离散残差在解析上为零。数值实现应该产生在浮点精度范围内为零的结果。\n\n### 3. 算法实现\n程序将通过以下步骤为每个测试用例实现验证：\n1.  解析测试用例参数：$\\rho$、$\\boldsymbol{\\Omega}$、域边界、$z_0$ 以及网格分辨率 $N_x, N_y$。\n2.  计算网格间距 $\\Delta x$ 和 $\\Delta y$。\n3.  使用 NumPy 广播为压力单元中心生成坐标数组以提高效率。\n4.  在所有单元中心计算解析压力场 $p(\\mathbf{r})$，以填充一个二维压力数组 `p_grid`。\n5.  对于 $x$-动量残差：\n    a. 为内部垂直面的中心生成坐标数组。\n    b. 为所有相关面计算离散压力梯度 $-\\left(p_{i+1,j}-p_{i,j}\\right)/\\Delta x$。\n    c. 在相同的面中心计算离心力项 $\\rho a_{\\mathrm{cf},x}$。\n    d. 计算残差 $R_x$ 作为两项之和。\n6.  对内部水平面上的 $y$-动量残差 $R_y$ 重复此过程。\n7.  在所有计算出的 $R_x$ 和 $R_y$ 值中确定最大绝对值。这是该测试用例的最终结果。\n8.  收集所有测试用例的结果，并按规定格式化它们。\n\n该算法直接实现了问题陈述中的公式和定义，并利用上面推导的解析解来测试数值方案的性质。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the verification for all test cases and print the results.\n    \"\"\"\n\n    def calculate_max_residual(params):\n        \"\"\"\n        Calculates the maximum absolute residual for a single test case.\n\n        Args:\n            params (tuple): A tuple containing all parameters for the test case:\n                (rho, Omega_vec, domain_x, domain_y, z0, Nx, Ny).\n\n        Returns:\n            float: The maximum absolute residual found on the grid.\n        \"\"\"\n        rho, Omega_vec, domain_x, domain_y, z0, Nx, Ny = params\n        Omega_vec = np.array(Omega_vec, dtype=float)\n        x_min, x_max = domain_x\n        y_min, y_max = domain_y\n\n        dx = (x_max - x_min) / Nx\n        dy = (y_max - y_min) / Ny\n\n        # --- 1. Calculate pressure at cell centers ---\n        # Use broadcasting to create coordinate grids implicitly\n        i_p = np.arange(Nx, dtype=float).reshape(-1, 1)\n        j_p = np.arange(Ny, dtype=float).reshape(1, -1)\n        x_p = x_min + (i_p + 0.5) * dx\n        y_p = y_min + (j_p + 0.5) * dy\n\n        # Evaluate analytical pressure field p(r) = 0.5 * rho * |Omega x r|^2\n        omega_sq = np.dot(Omega_vec, Omega_vec)\n        r_sq = x_p**2 + y_p**2 + z0**2\n        omega_dot_r = Omega_vec[0] * x_p + Omega_vec[1] * y_p + Omega_vec[2] * z0\n        p_grid = 0.5 * rho * (omega_sq * r_sq - omega_dot_r**2)\n\n        max_res = 0.0\n\n        # --- 2. Calculate x-momentum residual Rx ---\n        if Nx > 1:\n            # Coordinates of x-face centers (where Rx is evaluated)\n            i_rx = np.arange(Nx - 1, dtype=float).reshape(-1, 1)\n            j_rx = np.arange(Ny, dtype=float).reshape(1, -1)\n            x_fx = x_min + (i_rx + 1.0) * dx\n            y_fx = y_min + (j_rx + 0.5) * dy\n\n            # Discrete pressure gradient component in x\n            grad_p_x = (p_grid[1:, :] - p_grid[:-1, :]) / dx\n\n            # Centrifugal force component at x-faces: rho * a_cf,x\n            # a_cf = Omega^2 * r - (Omega . r) * Omega\n            omega_dot_r_fx = Omega_vec[0] * x_fx + Omega_vec[1] * y_fx + Omega_vec[2] * z0\n            a_cf_x = omega_sq * x_fx - omega_dot_r_fx * Omega_vec[0]\n            force_x = rho * a_cf_x\n\n            # Calculate residual\n            Rx = -grad_p_x + force_x\n            max_res = max(max_res, np.max(np.abs(Rx)))\n\n        # --- 3. Calculate y-momentum residual Ry ---\n        if Ny > 1:\n            # Coordinates of y-face centers (where Ry is evaluated)\n            i_ry = np.arange(Nx, dtype=float).reshape(-1, 1)\n            j_ry = np.arange(Ny - 1, dtype=float).reshape(1, -1)\n            x_fy = x_min + (i_ry + 0.5) * dx\n            y_fy = y_min + (j_ry + 1.0) * dy\n\n            # Discrete pressure gradient component in y\n            grad_p_y = (p_grid[:, 1:] - p_grid[:, :-1]) / dy\n\n            # Centrifugal force component at y-faces: rho * a_cf,y\n            omega_dot_r_fy = Omega_vec[0] * x_fy + Omega_vec[1] * y_fy + Omega_vec[2] * z0\n            a_cf_y = omega_sq * y_fy - omega_dot_r_fy * Omega_vec[1]\n            force_y = rho * a_cf_y\n\n            # Calculate residual\n            Ry = -grad_p_y + force_y\n            max_res = max(max_res, np.max(np.abs(Ry)))\n\n        return max_res\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Test 1: rho, Omega, domain_x, domain_y, z0, Nx, Ny\n        (1000.0, (0.0, 0.0, 10.0), (0.0, 1.0), (0.0, 1.0), 0.0, 64, 64),\n        # Test 2\n        (1.0, (0.0, 0.0, 2.5), (-2.0, 3.0), (-1.0, 1.0), 0.0, 50, 20),\n        # Test 3\n        (1.2, (3.0, 4.0, 5.0), (1.0, 2.0), (-0.3, 0.7), 0.2, 37, 29),\n        # Test 4\n        (850.0, (0.0, 0.0, 0.1), (-1.0, 1.0), (-1.0, 1.0), 0.0, 2, 2),\n        # Test 5\n        (997.0, (0.0, 0.0, 1000.0), (0.1, 0.2), (-0.05, 0.05), 0.0, 16, 16),\n    ]\n\n    results = []\n    for case in test_cases:\n        result = calculate_max_residual(case)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "应用数值格式不仅仅是离散化计算域的内部；边界条件和守恒律对于有效的模拟至关重要。这项动手实践任务涉及在 MAC 网格上为一个涡旋建立一个时间相关的平流求解器，重点是实现物理上恰当的入流和出流边界条件。通过追踪离散散度的积分，您将验证该格式的全局质量守恒性，这是不可压缩流求解器有效性的一个关键指标。",
            "id": "3365595",
            "problem": "考虑一个在Marker-And-Cell (MAC)网格上离散化的二维不可压缩流。MAC网格将$x$方向速度分量$u$存储在垂直单元面上（索引$i+\\tfrac{1}{2}, j$），$y$方向速度分量$v$存储在水平单元面上（索引$i, j+\\tfrac{1}{2}$），压力$p$存储在单元中心（索引$i, j$）。令计算域为$\\Omega = [0,L_x]\\times[0,L_y]$，其中$x$方向有$N_x$个单元，$y$方向有$N_y$个单元。因此，面心数组的形状为$u\\in\\mathbb{R}^{(N_x+1)\\times N_y}$和$v\\in\\mathbb{R}^{N_x\\times (N_y+1)}$，而单元中心网格的形状为$\\mathbb{R}^{N_x\\times N_y}$。均匀网格间距为$ \\Delta x = L_x/N_x $和$ \\Delta y = L_y/N_y$。\n\n你需要为一个涡旋在右边界（$x=L_x$）流出域实现一个一阶显式对流出流边界条件，并通过跟踪离散散度的域积分来数值上验证全局质量守恒。流场包含一个均匀的背景平流和一个由流函数定义的局部涡旋。\n\n基本原理：\n- 对于常密度流体，不可压缩连续性方程为$ \\nabla\\cdot \\mathbf{u} = 0 $，其中$\\mathbf{u}=(u,v)$。\n- 涡旋由流函数$\\psi$指定，使得$ u = \\partial \\psi/\\partial y $和$ v = -\\partial \\psi/\\partial x $，这确保了在连续设定下$ \\nabla\\cdot \\mathbf{u}=0 $。\n- 我们考虑速度分量由$+x$方向的均匀背景速度$U_0$输运。每个速度分量都遵循一个线性平流方程$ \\partial \\phi / \\partial t + U_0 \\, \\partial \\phi / \\partial x = 0 $，其中$\\phi$代表$u$或$v$。尽管这种解耦的输运在离散层面不强制满足不可压缩性，但连续散度仍然为零，并且散度的数值积分可用于衡量由离散化和边界处理引入的质量守恒误差。\n\n初始条件：\n- 令时间$t=0$时的流函数为\n$$\n\\psi(x,y,0) = A \\exp\\!\\left( -\\frac{(x-x_0)^2 + (y-y_0)^2}{R^2}\\right)，\n$$\n其中振幅$A>0$，核心半径$R>0$。相应的涡旋速度为\n$$\nu_{\\text{vtx}}(x,y,0) = \\frac{2A}{R^2}\\,(y-y_0)\\,\\exp\\!\\left( -\\frac{(x-x_0)^2 + (y-y_0)^2}{R^2}\\right),\n\\qquad\nv_{\\text{vtx}}(x,y,0) = -\\frac{2A}{R^2}\\,(x-x_0)\\,\\exp\\!\\left( -\\frac{(x-x_0)^2 + (y-y_0)^2}{R^2}\\right).\n$$\n叠加一个均匀的背景$x$方向速度$U_0$，因此初始总速度为$ u(x,y,0) = U_0 + u_{\\text{vtx}}(x,y,0) $和$ v(x,y,0) = v_{\\text{vtx}}(x,y,0) $。\n\n时间推进与边界条件：\n- 每个速度分量通过$x$方向线性平流方程的显式迎风离散格式进行时间推进，库朗数（Courant number）为$\\text{CFL}= U_0 \\Delta t / \\Delta x$：\n  - $u$的内部$x$方向面：\n    $$\n    u_{i,j}^{n+1} = u_{i,j}^{n} - \\text{CFL}\\,\\left(u_{i,j}^{n} - u_{i-1,j}^{n}\\right), \\quad i=1,\\dots,N_x，\n    $$\n    其中$u_{i,j}$表示在面索引$i$处（对应物理位置$x=i\\Delta x$, $y=(j+\\tfrac{1}{2})\\Delta y$）的值。\n  - $v$的内部$x$方向索引：\n    $$\n    v_{i,j}^{n+1} = v_{i,j}^{n} - \\text{CFL}\\,\\left(v_{i,j}^{n} - v_{i-1,j}^{n}\\right), \\quad i=1,\\dots,N_x-1，\n    $$\n    其中$v_{i,j}$表示在面索引$i$处（位置$x=(i+\\tfrac{1}{2})\\Delta x$, $y=j\\Delta y$）的值。\n- 西侧入流边界（$x=0$）由解析对流的涡旋和背景流设定。涡旋中心平流轨迹为$x_c(t)=x_0+U_0 t$, $y_c(t)=y_0$。对于$x=0$处的$u$，使用面位置$x=0$, $y=(j+\\tfrac{1}{2})\\Delta y$；对于第一个面索引$i=0$处的$v$，使用$x=\\tfrac{1}{2}\\Delta x$, $y=j\\Delta y$。入流值由下式给出：\n  $$\n  u_{\\text{in}}(y,t)=U_0 + \\frac{2A}{R^2}\\,(y-y_0)\\,\\exp\\!\\left( -\\frac{(0-x_c(t))^2 + (y-y_0)^2}{R^2}\\right)，\n  $$\n  $$\n  v_{\\text{in}}(y,t)=-\\frac{2A}{R^2}\\,\\left(\\tfrac{1}{2}\\Delta x - x_c(t)\\right)\\,\\exp\\!\\left( -\\frac{\\left(\\tfrac{1}{2}\\Delta x - x_c(t)\\right)^2 + (y-y_0)^2}{R^2}\\right)。\n  $$\n  西侧边界索引的一阶边界更新为\n  $$\n  u_{0,j}^{n+1} = u_{0,j}^{n} - \\text{CFL}\\,\\left(u_{0,j}^{n} - u_{\\text{in}}(y_{j+\\frac{1}{2}},t^n)\\right),\n  \\qquad\n  v_{0,j}^{n+1} = v_{0,j}^{n} - \\text{CFL}\\,\\left(v_{0,j}^{n} - v_{\\text{in}}(y_{j},t^n)\\right)。\n  $$\n- 东侧对流出流边界（$x=L_x$）应用与内部迎风格式一致的单侧对流更新：\n  $$\n  u_{N_x,j}^{n+1} = u_{N_x,j}^{n} - \\text{CFL}\\,\\left(u_{N_x,j}^{n} - u_{N_x-1,j}^{n}\\right),\n  \\qquad\n  v_{N_x-1,j}^{n+1} = v_{N_x-1,j}^{n} - \\text{CFL}\\,\\left(v_{N_x-1,j}^{n} - v_{N_x-2,j}^{n}\\right)。\n  $$\n- 顶部和底部边界对于$v$在$y$方向上是周期的：\n  $$\n  v_{i,N_y}^{n} \\equiv v_{i,0}^{n} \\quad \\text{for all } i \\text{ and } n。\n  $$\n  $u$数组已在$y=(j+\\tfrac{1}{2})\\Delta y$, $j=0,\\dots,N_y-1$处定义，因此不需要为$u$进行显式的$y$方向边界更新。\n\n离散散度及其积分：\n- 将时间$t^n$时单元中心的离散散度定义为\n  $$\n  (\\nabla\\cdot \\mathbf{u})_{i,j}^{n} = \\frac{u_{i+1,j}^{n} - u_{i,j}^{n}}{\\Delta x} + \\frac{v_{i,j+1}^{n} - v_{i,j}^{n}}{\\Delta y},\n  \\quad i=0,\\dots,N_x-1,\\quad j=0,\\dots,N_y-1。\n  $$\n- 域积分为\n  $$\n  I^n = \\int_{\\Omega} \\nabla\\cdot\\mathbf{u}\\,d\\Omega \\approx \\sum_{i=0}^{N_x-1}\\sum_{j=0}^{N_y-1} \\left( \\frac{u_{i+1,j}^{n} - u_{i,j}^{n}}{\\Delta x} + \\frac{v_{i,j+1}^{n} - v_{i,j}^{n}}{\\Delta y} \\right)\\,\\Delta x\\,\\Delta y。\n  $$\n- 在连续不可压缩情况下，对于所有$t$，该积分恒为零。在数值上，$I^n$可诊断归因于离散化和边界处理的质量守恒误差。你必须在涡旋离开域之前跟踪所有$n$的$I^n$，并报告其最大绝对值$\\max_n |I^n|$。\n\n单位：\n- 使用单位：$L_x$和$L_y$为米（$\\mathrm{m}$），$U_0$为米每秒（$\\mathrm{m/s}$），$A$为平方米每秒（$\\mathrm{m}^2/\\mathrm{s}$），$R$、$x_0$、$y_0$为米（$\\mathrm{m}$），时间为秒（$\\mathrm{s}$）。以$\\mathrm{m}^2/\\mathrm{s}$为单位报告最终输出。\n\n测试组：\n- 对于每个测试用例，使用时间步长$\\Delta t = \\text{CFL}\\cdot \\Delta x / U_0$进行计算，并推进到最终时间$T$，该时间足以让涡旋中心越过右边界并额外超出$m R$的距离，其中$m=1.5$：\n  $$\n  T = \\frac{L_x - x_0 + m R}{U_0}。\n  $$\n- 测试用例：\n  1. $N_x=64$, $N_y=64$, $L_x=1.0$, $L_y=1.0$, $U_0=1.0$, $A=0.05$, $R=0.10$, $x_0=0.20$, $y_0=0.50$, $\\text{CFL}=0.60$.\n  2. $N_x=32$, $N_y=32$, $L_x=1.0$, $L_y=1.0$, $U_0=1.0$, $A=0.08$, $R=0.08$, $x_0=0.20$, $y_0=0.30$, $\\text{CFL}=0.95$.\n  3. $N_x=48$, $N_y=48$, $L_x=1.0$, $L_y=1.0$, $U_0=0.50$, $A=0.04$, $R=0.06$, $x_0=0.40$, $y_0=0.90$, $\\text{CFL}=0.70$.\n\n你的任务：\n- 在MAC网格上为$u$和$v$实现显式迎风平流更新，并应用指定的入流、对流出流边界条件以及$v$的$y$方向周期性。\n- 按照规定使用流函数涡旋和背景场初始化流场。\n- 在每个时间步，计算$I^n$并跟踪$\\max_n |I^n|$。\n- 对于每个测试用例，返回单个浮点数$\\max_n |I^n|$，单位为$\\mathrm{m}^2/\\mathrm{s}$。\n\n最终输出格式：\n- 你的程序应生成单行输出，其中包含三个测试用例的结果，格式为方括号内以逗号分隔的列表，例如$[r_1,r_2,r_3]$，其中每个$r_k$是单位为$\\mathrm{m}^2/\\mathrm{s}$的浮点数。",
            "solution": "用户提供了一个计算流体动力学问题，在尝试求解之前需要进行验证。\n\n### 步骤1：提取给定条件\n\n- **问题域**：一个二维域 $\\Omega = [0,L_x]\\times[0,L_y]$。\n- **网格类型**：Marker-And-Cell (MAC) 交错网格，包含 $N_x \\times N_y$ 个单元。\n- **网格间距**：均匀间距 $\\Delta x = L_x/N_x$ 和 $\\Delta y = L_y/N_y$。\n- **变量位置**：\n  - $x$-速度 $u$：位于垂直单元面，索引 $(i+\\tfrac{1}{2}, j)$。数组形状 $u\\in\\mathbb{R}^{(N_x+1)\\times N_y}$。\n  - $y$-速度 $v$：位于水平单元面，索引 $(i, j+\\tfrac{1}{2})$。数组形状 $v\\in\\mathbb{R}^{N_x\\times (N_y+1)}$。\n  - 压力 $p$：位于单元中心，索引 $(i, j)$。数组形状 $\\mathbb{R}^{N_x\\times N_y}$。\n- **控制方程**：\n  - 不可压缩性：$\\nabla\\cdot \\mathbf{u} = 0$。\n  - 每个速度分量的线性平流方程：$\\partial \\phi / \\partial t + U_0 \\, \\partial \\phi / \\partial x = 0$，其中 $\\phi$ 是 $u$ 或 $v$。\n- **初始条件 ($t=0$)**：\n  - 流函数：$\\psi(x,y,0) = A \\exp\\!\\left( -\\frac{(x-x_0)^2 + (y-y_0)^2}{R^2}\\right)$。\n  - 总速度：$u(x,y,0) = U_0 + u_{\\text{vtx}}(x,y,0)$ 和 $v(x,y,0) = v_{\\text{vtx}}(x,y,0)$。\n  - 涡旋速度分量：\n    $u_{\\text{vtx}}(x,y,0) = \\frac{2A}{R^2}\\,(y-y_0)\\,\\exp\\!\\left( -\\frac{(x-x_0)^2 + (y-y_0)^2}{R^2}\\right)$。\n    $v_{\\text{vtx}}(x,y,0) = -\\frac{2A}{R^2}\\,(x-x_0)\\,\\exp\\!\\left( -\\frac{(x-x_0)^2 + (y-y_0)^2}{R^2}\\right)$。\n- **时间推进（显式迎风）**：\n  - 库朗数：$\\text{CFL}= U_0 \\Delta t / \\Delta x$。\n  - 内部 $u$：$u_{i,j}^{n+1} = u_{i,j}^{n} - \\text{CFL}\\,\\left(u_{i,j}^{n} - u_{i-1,j}^{n}\\right)$，对于 $i=1,\\dots,N_x$。\n  - 内部 $v$：$v_{i,j}^{n+1} = v_{i,j}^{n} - \\text{CFL}\\,\\left(v_{i,j}^{n} - v_{i-1,j}^{n}\\right)$，对于 $i=1,\\dots,N_x-1$。\n- **边界条件**：\n  - **西侧入流 ($x=0$)**：基于涡旋的解析平流。中心位于 $x_c(t)=x_0+U_0 t$。\n    - 入流剖面：\n      $u_{\\text{in}}(y,t)=U_0 + \\frac{2A}{R^2}\\,(y-y_0)\\,\\exp\\!\\left( -\\frac{(-x_c(t))^2 + (y-y_0)^2}{R^2}\\right)$。\n      $v_{\\text{in}}(y,t)=-\\frac{2A}{R^2}\\,\\left(\\tfrac{1}{2}\\Delta x - x_c(t)\\right)\\,\\exp\\!\\left( -\\frac{\\left(\\tfrac{1}{2}\\Delta x - x_c(t)\\right)^2 + (y-y_0)^2}{R^2}\\right)$。\n    - 更新规则：\n      $u_{0,j}^{n+1} = u_{0,j}^{n} - \\text{CFL}\\,\\left(u_{0,j}^{n} - u_{\\text{in}}(y_{j+\\frac{1}{2}},t^n)\\right)$。\n      $v_{0,j}^{n+1} = v_{0,j}^{n} - \\text{CFL}\\,\\left(v_{0,j}^{n} - v_{\\text{in}}(y_{j},t^n)\\right)$。\n  - **东侧出流 ($x=L_x$)**：对流（单侧迎风）。\n    - $u_{N_x,j}^{n+1} = u_{N_x,j}^{n} - \\text{CFL}\\,\\left(u_{N_x,j}^{n} - u_{N_x-1,j}^{n}\\right)$。\n    - $v_{N_x-1,j}^{n+1} = v_{N_x-1,j}^{n} - \\text{CFL}\\,\\left(v_{N_x-1,j}^{n} - v_{N_x-2,j}^{n}\\right)$。\n  - **顶部/底部 ($y$)**：对$v$为周期性。\n    - $v_{i,N_y}^{n} \\equiv v_{i,0}^{n}$，对所有 $i$ 和 $n$。\n    - $u$ 无需显式的$y$方向边界更新。\n- **分析任务**：\n  - 离散散度：$(\\nabla\\cdot \\mathbf{u})_{i,j}^{n} = \\frac{u_{i+1,j}^{n} - u_{i,j}^{n}}{\\Delta x} + \\frac{v_{i,j+1}^{n} - v_{i,j}^{n}}{\\Delta y}$。\n  - 散度的域积分：$I^n = \\sum_{i=0}^{N_x-1}\\sum_{j=0}^{N_y-1} (\\nabla\\cdot \\mathbf{u})_{i,j}^{n}\\,\\Delta x\\,\\Delta y$。\n  - 要求输出：对每个测试用例，报告 $\\max_n |I^n|$。\n- **模拟时间**：在 $T = \\frac{L_x - x_0 + m R}{U_0}$（其中 $m=1.5$）停止。\n- **测试用例**：\n  1. $N_x=64$, $N_y=64$, $L_x=1.0$, $L_y=1.0$, $U_0=1.0$, $A=0.05$, $R=0.10$, $x_0=0.20$, $y_0=0.50$, $\\text{CFL}=0.60$。\n  2. $N_x=32$, $N_y=32$, $L_x=1.0$, $L_y=1.0$, $U_0=1.0$, $A=0.08$, $R=0.08$, $x_0=0.20$, $y_0=0.30$, $\\text{CFL}=0.95$。\n  3. $N_x=48$, $N_y=48$, $L_x=1.0$, $L_y=1.0$, $U_0=0.50$, $A=0.04$, $R=0.06$, $x_0=0.40$, $y_0=0.90$, $\\text{CFL}=0.70$。\n\n### 步骤2：使用提取的给定条件进行验证\n\n- **科学基础**：该问题是计算流体动力学（CFD）中的一个标准练习。它涉及线性平流方程、MAC网格离散化、显式迎风格式和标准边界条件。使用流函数导出的涡旋是生成初始无散流场的常用技术。分析离散散度积分是评估质量守恒误差的标准方法。该问题牢固地植根于已建立的科学原理。\n- **适定的**：该问题是适定的。速度场的初始条件已完全指定。演化由显式数值格式控制。为计算域的所有外边界都定义了边界条件。给定的库朗数（$\\text{CFL} \\le 0.95$）在一阶显式迎风格式的稳定性极限 $\\text{CFL} \\le 1$ 之内，确保了数值解的稳定性。任务是找到模拟时间内某个计算量的最大值，这是一个唯一定义的值。\n- **客观的**：问题以精确、客观、数学化和算法化的术语陈述。没有主观或模糊的语言。\n- **缺陷检查表**：\n  1.  **科学/事实不健全**：无。物理和数学都是标准的。\n  2.  **非形式化/不相关**：无。该问题是与CFD和MAC网格直接相关的形式化数值方法任务。\n  3.  **不完整/矛盾的设置**：问题是详细且自洽的。数组维度、索引约定和更新规则彼此一致。例如，$u_{N_x,j}$ 的出流条件与应用于 $i=N_x$ 处的通用内部更新规则相同；$v_{N_x-1,j}$ 也是如此。这代表了在边界上一致地应用迎风模板，而不是矛盾。$v$ 的周期性条件对于顶行单元的离散散度计算是必要的。所有必需的参数都已提供。\n  4.  **不切实际/不可行**：无。参数定义了一个标准的“对流涡旋”测试案例。\n  5.  **不适定/结构不良**：无。存在唯一解且可以计算得出。\n  6.  **伪深刻/琐碎**：无。该问题需要正确实现一个非平凡的数值算法。\n  7.  **超出科学可验证性**：无。结果是数值上可验证的。\n\n### 步骤3：结论与行动\n\n问题有效。我将继续进行求解。\n\n### 基于原理的求解设计\n\n该解决方案涉及模拟涡旋在一个二维域上的平流，该域在Marker-And-Cell (MAC)网格上离散化。实现的核心是一个时间步进循环，它将一阶显式迎风格式应用于速度分量 $u$ 和 $v$。\n\n**1. 网格与初始化：**\n首先，我们根据给定的参数（$N_x, N_y, L_x, L_y$）建立计算网格。MAC网格的一个关键特征是变量的交错放置。$u$-速度分量位于垂直单元面上，$v$-速度分量位于水平单元面上。这需要创建两组不同的坐标网格。我们将使用NumPy的 `meshgrid` 并设置 `indexing='ij'` 来生成坐标数组 `(X_u, Y_u)` 和 `(X_v, Y_v)`，它们对应于$u$和$v$变量的物理位置。速度场$u$和$v$在$t=0$时通过在这些交错网格位置上评估其解析公式来初始化，这些公式描述了一个叠加在均匀流上的高斯涡旋。初始化后，将对$v$场强制施加$y$方向的周期性边界条件，$v_{i,N_y} = v_{i,0}$。\n\n**2. 时间积分与离散化：**\n速度场的演化由线性平流方程控制，该方程使用一阶显式迎风格式进行离散化。由于平流速度$U_0$是正的，任何网格变量$\\phi_i$的格式为$\\phi_i^{n+1} = \\phi_i^n - \\text{CFL}(\\phi_i^n - \\phi_{i-1}^n)$，其中$\\text{CFL} = U_0 \\Delta t / \\Delta x$。此更新独立地应用于$u$和$v$场。我们将以矢量化的方式实现这些更新以提高效率，将它们应用于表示速度场的NumPy数组的适当切片。\n\n**3. 边界条件：**\n- **入流（西侧, $x=0$）：** 问题指定了一种松弛型边界条件，其中边界值根据其先前值和解析规定的入流值进行更新。该入流值代表了平流涡旋穿过边界的精确解。这将在每个时间步计算。\n- **出流（东侧, $x=L_x$）：** 使用一个简单的对流出流条件，这等同于在边界处应用与内部相同的迎风有限差分模板。这允许信息传播出域。我们的矢量化内部更新自然地处理了这种情况。\n- **周期性（顶部/底部, $y$）：** 在每个时间步结束时，通过将顶部边界（$j=N_y$）的值设置为等于底部边界（$j=0$）的值来强制执行$v$场的周期性。这是必要的，因为初始涡旋剖面和入流条件在$y$方向上不是固有的周期性。\n\n**4. 质量守恒分析：**\n问题要求通过跟踪离散散度的域积分$I^n$来监测全局质量守恒。在MAC网格上，对于$v$具有周期性顶部/底部边界的离散散度定理显著简化了积分计算。积分$\\int \\nabla \\cdot \\mathbf{u} \\, d\\Omega$ 变为穿过域的东、西边界的总通量：\n$$I^n = \\sum_{j=0}^{N_y-1} (u_{N_x,j}^n - u_{0,j}^n) \\, \\Delta y$$\n这个简化的公式避免了在每个单元计算散度，使得分析步骤非常高效。在每个时间步，我们计算$I^n$并更新其绝对值的运行最大值$\\max_n|I^n|$。\n\n模拟运行总时间$T$，该时间的计算确保了涡旋完全离开域。每个测试用例的最终结果是计算出的$\\max_n|I^n|$的值。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main solver function to run test cases and print results.\n    \"\"\"\n    test_cases = [\n        # (Nx, Ny, Lx, Ly, U0, A, R, x0, y0, CFL)\n        (64, 64, 1.0, 1.0, 1.0, 0.05, 0.10, 0.20, 0.50, 0.60),\n        (32, 32, 1.0, 1.0, 1.0, 0.08, 0.08, 0.20, 0.30, 0.95),\n        (48, 48, 1.0, 1.0, 0.50, 0.04, 0.06, 0.40, 0.90, 0.70),\n    ]\n\n    results = []\n    for params in test_cases:\n        result = run_simulation(*params)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\n\ndef run_simulation(Nx, Ny, Lx, Ly, U0, A, R, x0, y0, CFL):\n    \"\"\"\n    Executes a single simulation case for the vortex advection problem.\n    \"\"\"\n    # Grid and time parameters\n    dx = Lx / Nx\n    dy = Ly / Ny\n    dt = CFL * dx / U0\n    m = 1.5\n    T_final = (Lx - x0 + m * R) / U0\n    num_steps = int(np.ceil(T_final / dt))\n\n    # --- Grid coordinates ---\n    # U-velocity component grid\n    # u is at (i*dx, (j+0.5)*dy) for i in [0,Nx], j in [0,Ny-1]\n    # Array shape: (Nx+1, Ny) -> u[i, j]\n    x_u_pts = np.arange(Nx + 1) * dx\n    y_u_pts = (np.arange(Ny) + 0.5) * dy\n    X_u, Y_u = np.meshgrid(x_u_pts, y_u_pts, indexing='ij')\n\n    # V-velocity component grid\n    # v is at ((i+0.5)*dx, j*dy) for i in [0,Nx-1], j in [0,Ny]\n    # Array shape: (Nx, Ny+1) -> v[i, j]\n    x_v_pts = (np.arange(Nx) + 0.5) * dx\n    y_v_pts = np.arange(Ny + 1) * dy\n    X_v, Y_v = np.meshgrid(x_v_pts, y_v_pts, indexing='ij')\n\n    # --- Initial Conditions ---\n    # u(x,y,0) = U0 + u_vtx(x,y,0)\n    u_vortex_term = (2 * A / R**2) * (Y_u - y0) * np.exp(-((X_u - x0)**2 + (Y_u - y0)**2) / R**2)\n    u = U0 + u_vortex_term\n\n    # v(x,y,0) = v_vtx(x,y,0)\n    v_vortex_term = -(2 * A / R**2) * (X_v - x0) * np.exp(-((X_v - x0)**2 + (Y_v - y0)**2) / R**2)\n    v = v_vortex_term\n    \n    # Enforce periodic boundary condition for v at t=0\n    v[:, Ny] = v[:, 0]\n\n    max_abs_I = 0.0\n\n    # --- Time-stepping loop ---\n    for n in range(num_steps):\n        # 1. Calculate integral of divergence at time t^n\n        # I^n = Integral(div(u)) dOmega = Sum_j (u_{Nx,j} - u_{0,j}) dy\n        # This uses the discrete divergence theorem and y-periodicity of v.\n        I_n = dy * np.sum(u[Nx, :] - u[0, :])\n        max_abs_I = max(max_abs_I, abs(I_n))\n\n        # 2. Store fields at time t^n for update calculation\n        u_n = u.copy()\n        v_n = v.copy()\n        \n        # 3. Time at current step for analytic BC evaluation\n        current_time = n * dt\n        \n        # 4. Update interior and east boundary (i > 0)\n        # u update for i=1..Nx. Includes east outflow BC at i=Nx.\n        u[1:Nx+1, :] = u_n[1:Nx+1, :] - CFL * (u_n[1:Nx+1, :] - u_n[0:Nx, :])\n        # v update for i=1..Nx-1. Includes east outflow BC at i=Nx-1.\n        v[1:Nx, :]   = v_n[1:Nx, :]   - CFL * (v_n[1:Nx, :]   - v_n[0:Nx-1, :])\n        \n        # 5. Update west inflow boundary (i = 0)\n        x_c_n = x0 + U0 * current_time\n\n        # Calculate u_in at x=0\n        # y_u_pts are the y-coordinates for the u-grid\n        u_in_val = U0 + (2 * A / R**2) * (y_u_pts - y0) * np.exp(-((0.0 - x_c_n)**2 + (y_u_pts - y0)**2) / R**2)\n        u[0, :] = u_n[0, :] - CFL * (u_n[0, :] - u_in_val)\n        \n        # Calculate v_in for v[0,:] at x = 0.5*dx\n        # y_v_pts are the y-coordinates for the v-grid\n        v_in_x_coord = 0.5 * dx\n        v_in_val = -(2 * A / R**2) * (v_in_x_coord - x_c_n) * np.exp(-((v_in_x_coord - x_c_n)**2 + (y_v_pts - y0)**2) / R**2)\n        v[0, :] = v_n[0, :] - CFL * (v_n[0, :] - v_in_val)\n\n        # 6. Enforce y-periodicity for v\n        v[:, Ny] = v[:, 0]\n        \n    return max_abs_I\n\nif __name__ == '__main__':\n    solve()\n\n```"
        }
    ]
}