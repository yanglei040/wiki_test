{
    "hands_on_practices": [
        {
            "introduction": "理解一个数值格式真实行为的有力工具是推导其“修正方程”（modified equation），它揭示了离散格式实际求解的偏微分方程。本练习将引导你通过泰勒级数分析，为一阶迎风格式推导修正方程。此举旨在揭示其主导截断误差项，并将其识别为一个非物理的“数值扩散”项，从而从理论上深刻理解该格式的耗散特性。",
            "id": "3386735",
            "problem": "考虑具有恒定速度的线性一维（$1$D）平流方程，\n$$\n\\partial_{t} \\phi + a \\,\\partial_{x} \\phi = 0,\n$$\n其中 $a0$ 是常数。使用有限体积法在间距为 $\\Delta x$ 的均匀网格上对此方程进行离散化，界面值采用一阶迎风插值，并使用时间步长为 $\\Delta t$ 的向前（显式）欧拉法进行时间推进。设 Courant–Friedrichs–Lewy (CFL) 数定义为 $\\mathrm{CFL} \\equiv a\\,\\Delta t/\\Delta x$。\n\n从积分守恒形式以及由迎风界面值构造的数值通量的定义出发，推导该完全离散格式在 $\\Delta x$ 和 $\\Delta t$ 的主导非平凡阶上所满足的修正方程。特别地，请识别可被解释为有效扩散的主阶截断项，并因此将修正方程写成如下形式\n$$\n\\partial_{t} \\phi + a\\,\\partial_{x} \\phi = D_{\\text{num}}\\,\\partial_{xx} \\phi + \\text{更高阶项}。\n$$\n您的推导必须从有限体积平衡和显式欧拉更新开始，使用关于空间和时间上某个通用单元中心的泰勒展开，并在适当之处使用连续方程将时间导数替换为空间导数。\n\n请以 $a$、$\\Delta x$ 和 $\\mathrm{CFL}$ 表示的单一闭式解析表达式的形式，报告有效数值扩散系数 $D_{\\text{num}}$。最终答案只需提供 $D_{\\text{num}}$ 的解析表达式。无需进行数值计算或四舍五入。",
            "solution": "该问题已经过验证，被认为是有效的。它是偏微分方程数值方法分析中的一个标准的、适定的问题，基于成熟的数学和计算原理。所有必要的信息都已提供，术语精确且无歧义。\n\n我们首先陈述一维线性平流方程在一个控制体积（或单元）$C_i = [x_{i-1/2}, x_{i+1/2}]$ 上的积分守恒形式，其中 $x_i$ 是单元中心，$\\Delta x = x_{i+1/2} - x_{i-1/2}$ 是均匀的单元宽度。\n$$\n\\int_{x_{i-1/2}}^{x_{i+1/2}} \\frac{\\partial \\phi}{\\partial t} \\,dx + \\int_{x_{i-1/2}}^{x_{i+1/2}} \\frac{\\partial (a\\phi)}{\\partial x} \\,dx = 0\n$$\n设 $\\phi_i(t)$ 为守恒量 $\\phi$ 在时间 $t$ 位于单元 $C_i$ 内的单元平均值，定义为：\n$$\n\\phi_i(t) \\equiv \\frac{1}{\\Delta x} \\int_{x_{i-1/2}}^{x_{i+1/2}} \\phi(x,t) \\,dx\n$$\n将此定义和微积分基本定理应用于积分守恒律，我们得到半离散的有限体积公式：\n$$\n\\frac{d\\phi_i}{dt} + \\frac{1}{\\Delta x} \\left[ (a\\phi)_{i+1/2} - (a\\phi)_{i-1/2} \\right] = 0\n$$\n此处，$(a\\phi)_{i \\pm 1/2}$ 代表在单元界面 $x_{i \\pm 1/2}$ 处的数值通量。\n\n问题指定了使用向前（显式）欧拉法进行时间积分。将此方法应用于时间步长为 $\\Delta t$ 的半离散方程，得到完全离散形式：\n$$\n\\frac{\\phi_i^{n+1} - \\phi_i^n}{\\Delta t} + \\frac{1}{\\Delta x} \\left[ F_{i+1/2}^n - F_{i-1/2}^n \\right] = 0\n$$\n其中上标 $n$ 表示时间层 $t_n = n\\Delta t$，数值通量为 $F = a\\phi$。\n\n空间离散采用一阶迎风插值。由于速度 $a$ 给定为正 ($a0$)，因此“迎风”方向是向左。所以，单元界面上的 $\\phi$ 值取自其紧邻左侧的单元。\n对于界面 $x_{i+1/2}$，迎风单元是 $C_i$，因此 $\\phi_{i+1/2}^n = \\phi_i^n$。\n对于界面 $x_{i-1/2}$，迎风单元是 $C_{i-1}$，因此 $\\phi_{i-1/2}^n = \\phi_{i-1}^n$。\n因此，数值通量为：\n$$\nF_{i+1/2}^n = a \\phi_i^n \\quad \\text{和} \\quad F_{i-1/2}^n = a \\phi_{i-1}^n\n$$\n将这些通量代入完全离散方程，得到：\n$$\n\\frac{\\phi_i^{n+1} - \\phi_i^n}{\\Delta t} + \\frac{a}{\\Delta x} \\left( \\phi_i^n - \\phi_{i-1}^n \\right) = 0\n$$\n为了推导修正方程，我们对离散方程中的每一项围绕中心点 $(x_i, t_n)$ 进行泰勒级数展开。我们将 $\\phi_i^n$ 视为精确解在该点的值 $\\phi(x_i, t_n)$，并将其他项与之关联。\n$\\phi_i^{n+1}$ 在时间上的展开为：\n$$\n\\phi_i^{n+1} = \\phi(x_i, t_n + \\Delta t) = \\phi(x_i, t_n) + \\Delta t \\, \\partial_t\\phi + \\frac{(\\Delta t)^2}{2} \\, \\partial_{tt}\\phi + \\mathcal{O}((\\Delta t)^3)\n$$\n$\\phi_{i-1}^n$ 在空间上的展开为：\n$$\n\\phi_{i-1}^n = \\phi(x_i - \\Delta x, t_n) = \\phi(x_i, t_n) - \\Delta x \\, \\partial_x\\phi + \\frac{(\\Delta x)^2}{2} \\, \\partial_{xx}\\phi - \\frac{(\\Delta x)^3}{6} \\, \\partial_{xxx}\\phi + \\mathcal{O}((\\Delta x)^4)\n$$\n在这些展开式中，$\\phi$ 及其偏导数均在点 $(x_i, t_n)$ 处求值。\n\n我们将这些展开式代入离散方程的左手边：\n$$\n\\frac{\\phi_i^{n+1} - \\phi_i^n}{\\Delta t} = \\frac{1}{\\Delta t} \\left( \\left[ \\phi + \\Delta t \\, \\partial_t\\phi + \\frac{(\\Delta t)^2}{2} \\, \\partial_{tt}\\phi + \\dots \\right] - \\phi \\right) = \\partial_t\\phi + \\frac{\\Delta t}{2} \\, \\partial_{tt}\\phi + \\mathcal{O}((\\Delta t)^2)\n$$\n并代入右手边：\n$$\n-\\frac{a}{\\Delta x} (\\phi_i^n - \\phi_{i-1}^n) = -\\frac{a}{\\Delta x} \\left( \\phi - \\left[ \\phi - \\Delta x \\, \\partial_x\\phi + \\frac{(\\Delta x)^2}{2} \\, \\partial_{xx}\\phi - \\dots \\right] \\right)\n$$\n$$\n= -\\frac{a}{\\Delta x} \\left( \\Delta x \\, \\partial_x\\phi - \\frac{(\\Delta x)^2}{2} \\, \\partial_{xx}\\phi + \\dots \\right) = -a\\,\\partial_x\\phi + \\frac{a\\Delta x}{2} \\, \\partial_{xx}\\phi - \\mathcal{O}((\\Delta x)^2)\n$$\n令展开后的左手边和右手边相等，得到离散格式实际求解的偏微分方程，保留到主阶误差项：\n$$\n\\partial_t\\phi + \\frac{\\Delta t}{2} \\, \\partial_{tt}\\phi = -a\\,\\partial_x\\phi + \\frac{a\\Delta x}{2} \\, \\partial_{xx}\\phi + \\text{高阶项}\n$$\n其中 H.O.T. 代表高阶项。整理后，我们得到：\n$$\n\\partial_t\\phi + a\\,\\partial_x\\phi = \\frac{a\\Delta x}{2} \\, \\partial_{xx}\\phi - \\frac{\\Delta t}{2} \\, \\partial_{tt}\\phi + \\text{高阶项}\n$$\n这还不是期望的形式，因为它在截断误差中包含了时间导数 $\\partial_{tt}\\phi$。为了得到修正方程，我们必须将这个时间导数用空间导数来表示。我们使用原始的偏微分方程 $\\partial_t\\phi = -a\\,\\partial_x\\phi$，它在最低阶上是满足的。我们可以对这个方程求导，以找到高阶导数的关系。\n$$\n\\partial_{t} (\\partial_t \\phi) = \\partial_{t} (-a\\,\\partial_x \\phi) = -a\\,\\partial_{tx}\\phi\n$$\n假设解 $\\phi$ 足够光滑，我们有 $\\partial_{tx}\\phi = \\partial_{xt}\\phi$。那么：\n$$\n\\partial_{tt}\\phi = -a\\,\\partial_{x}(\\partial_t \\phi) = -a\\,\\partial_{x}(-a\\,\\partial_x \\phi) = a^2\\,\\partial_{xx}\\phi\n$$\n我们也可以从修正方程本身 $\\partial_t \\phi = -a \\partial_x \\phi + \\mathcal{O}(\\Delta x, \\Delta t)$ 推导 $\\partial_{tt}\\phi$ 的表达式。对此求导得到 $\\partial_{tt}\\phi = a^2 \\partial_{xx}\\phi + \\mathcal{O}(\\Delta x, \\Delta t)$。将此代回截断误差项不会改变主阶行为。\n\n将 $\\partial_{tt}\\phi = a^2\\,\\partial_{xx}\\phi$ 代入我们整理后的方程：\n$$\n\\partial_t\\phi + a\\,\\partial_x\\phi = \\frac{a\\Delta x}{2} \\, \\partial_{xx}\\phi - \\frac{\\Delta t}{2} (a^2\\,\\partial_{xx}\\phi) + \\text{高阶项}\n$$\n现在我们可以将乘以二阶空间导数 $\\partial_{xx}\\phi$ 的项组合起来：\n$$\n\\partial_t\\phi + a\\,\\partial_x\\phi = \\left( \\frac{a\\Delta x}{2} - \\frac{a^2\\Delta t}{2} \\right) \\partial_{xx}\\phi + \\text{高阶项}\n$$\n这就是主导非平凡阶的修正方程。乘以 $\\partial_{xx}\\phi$ 的项是有效数值扩散系数 $D_{\\text{num}}$。\n$$\nD_{\\text{num}} = \\frac{a\\Delta x}{2} - \\frac{a^2\\Delta t}{2}\n$$\n问题要求用 $a$、$\\Delta x$ 和 Courant–Friedrichs–Lewy (CFL) 数（定义为 $\\mathrm{CFL} \\equiv a\\,\\Delta t/\\Delta x$）来表示这个表达式。我们可以从 $D_{\\text{num}}$ 的表达式中提出因子 $\\frac{a\\Delta x}{2}$：\n$$\nD_{\\text{num}} = \\frac{a\\Delta x}{2} \\left( 1 - \\frac{a^2\\Delta t}{a\\Delta x} \\right) = \\frac{a\\Delta x}{2} \\left( 1 - \\frac{a\\Delta t}{\\Delta x} \\right)\n$$\n代入 CFL 数的定义，我们得到数值扩散系数的最终表达式：\n$$\nD_{\\text{num}} = \\frac{a\\Delta x}{2} (1 - \\mathrm{CFL})\n$$\n这个具有扩散项形式的主阶截断误差项，是一阶迎风格式具有耗散性的原因。",
            "answer": "$$\n\\boxed{\\frac{a \\Delta x}{2} (1 - \\mathrm{CFL})}\n$$"
        },
        {
            "introduction": "基于迎风格式会引入人工扩散的理论认知，本练习旨在在一个实际场景中量化这一误差。我们将分析存在精确解析解的一维稳态对流-扩散问题。通过将迎风格式所用的上游单元中心值与真实的界面精确解进行比较，我们可以直接度量插值误差，并观察其如何受物理佩克莱数（Peclet number）和网格分辨率的影响。",
            "id": "3386667",
            "problem": "考虑在无量纲域 $x \\in [0,1]$ 上的一个一维稳态对流扩散边值问题，其材料属性和速度均为常数，由被动标量 $\\phi(x)$ 的守恒方程控制：\n$$\n\\frac{d}{dx}\\left(\\Gamma \\frac{d \\phi}{dx}\\right) - \\rho u \\frac{d \\phi}{dx} = 0,\n$$\n服从狄利克雷边界条件 $\\phi(0) = \\phi_0$ 和 $\\phi(1) = \\phi_1$。假设 $\\Gamma  0$、$\\rho  0$ 和 $u  0$ 均为常数。定义无量纲全局佩克莱数为\n$$\nP = \\frac{\\rho u L}{\\Gamma},\n$$\n其中 $L = 1$。均匀网格由 $N$ 个有限体积组成，间距为 $\\Delta x = \\frac{1}{N}$。设内部面位置为 $x_f = j \\Delta x$（对于 $j = 1,2,\\dots,N-1$），单元中心位置为 $x_j = \\left(j - \\frac{1}{2}\\right)\\Delta x$（对于 $j = 1,2,\\dots,N$）。定义局部单元佩克莱数为\n$$\nPe = \\frac{P}{N}.\n$$\n\n使用有限体积法 (FVM)，通过一个面的对流通量需要对该面上的值 $\\phi_f$ 进行近似。对于正速度 $u  0$，迎风插值法规定，位于单元 $j$ 和 $j+1$ 之间的内部面上的值为\n$$\n\\phi_f^{\\text{up}} = \\phi(x_j),\n$$\n其中 $\\phi(x_j)$ 表示单元中心的值。精确的面值为 $\\phi(x_f)$，其中 $\\phi(x)$ 是该边值问题的精确连续解。\n\n你的任务是：\n- 使用控制方程和边界条件，推导精确连续解 $\\phi(x)$。\n- 对于下面指定的每个测试用例，计算迎风插值在所有内部面上产生的误差，其定义为\n$$\ne_j = \\phi_f^{\\text{up}} - \\phi(x_f) = \\phi(x_j) - \\phi(x_f),\n$$\n并报告两个标量指标：\n    1. 所有内部面上的最大绝对误差，\n    $$\n    E_{\\infty} = \\max_{1 \\le j \\le N-1} |e_j|.\n    $$\n    2. 所有内部面上的平均绝对误差，\n    $$\n    E_{\\text{mean}} = \\frac{1}{N-1} \\sum_{j=1}^{N-1} |e_j|.\n    $$\n- 使用边界值 $\\phi_0 = 0$ 和 $\\phi_1 = 1$。\n\n所有量均为无量纲。最终输出必须是测试套件的汇总结果，打印为单行，其中包含一个由双元素列表组成的列表，每个内部列表为对应测试用例的 $[E_{\\infty}, E_{\\text{mean}}]$，顺序如下所列。\n\n测试套件：\n1. $P = 0.0$, $N = 4$。\n2. $P = 0.1$, $N = 10$。\n3. $P = 2.0$, $N = 10$。\n4. $P = 2.0$, $N = 40$。\n5. $P = 10.0$, $N = 10$。\n6. $P = 10.0$, $N = 100$。\n\n你的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果，例如 $[[r_{11}, r_{12}], [r_{21}, r_{22}], \\dots]$，其中每个 $r_{ij}$ 是一个浮点数，表示相应测试用例的 $E_{\\infty}$ 或 $E_{\\text{mean}}$。",
            "solution": "该问题被验证为具有科学依据、适定、客观且完整。所有必要信息均已提供，且相关概念在输运现象和计算流体动力学领域中是标准的。任务是推导一维稳态对流扩散方程的精确解，然后计算在一组给定参数下一阶迎风插值格式的误差。\n\n### 第1步：推导精确解析解\n\n被动标量 $\\phi(x)$ 的稳态一维对流扩散控制方程如下：\n$$\n\\frac{d}{dx}\\left(\\Gamma \\frac{d \\phi}{dx}\\right) - \\rho u \\frac{d \\phi}{dx} = 0\n$$\n假设扩散系数 $\\Gamma$、密度 $\\rho$ 和速度 $u$ 为常数，该方程可简化为具有常系数的二阶线性常微分方程 (ODE)：\n$$\n\\Gamma \\frac{d^2 \\phi}{dx^2} - \\rho u \\frac{d \\phi}{dx} = 0\n$$\n除以 $\\Gamma$（因为 $\\Gamma  0$）：\n$$\n\\frac{d^2 \\phi}{dx^2} - \\frac{\\rho u}{\\Gamma} \\frac{d \\phi}{dx} = 0\n$$\n问题将全局佩克莱数定义为 $P = \\frac{\\rho u L}{\\Gamma}$，其中域长度 $L=1$。将其代入 ODE 得到：\n$$\n\\frac{d^2 \\phi}{dx^2} - P \\frac{d \\phi}{dx} = 0\n$$\n该 ODE 的特征方程为 $r^2 - Pr = 0$，它有两个不同的根：$r_1 = 0$ 和 $r_2 = P$。\n\n**情况1：$P \\neq 0$**\n通解的形式为 $\\phi(x) = C_1 e^{r_1 x} + C_2 e^{r_2 x}$，即：\n$$\n\\phi(x) = C_1 + C_2 e^{Px}\n$$\n积分常数 $C_1$ 和 $C_2$ 由狄利克雷边界条件 $\\phi(0) = \\phi_0$ 和 $\\phi(1) = \\phi_1$ 确定。\n在 $x=0$ 处：\n$$\n\\phi(0) = C_1 + C_2 e^0 = C_1 + C_2 = \\phi_0\n$$\n在 $x=1$ 处：\n$$\n\\phi(1) = C_1 + C_2 e^P = \\phi_1\n$$\n解这个关于 $C_1$ 和 $C_2$ 的线性方程组：\n由第一个方程可得 $C_1 = \\phi_0 - C_2$。代入第二个方程：\n$$\n(\\phi_0 - C_2) + C_2 e^P = \\phi_1 \\implies C_2(e^P - 1) = \\phi_1 - \\phi_0 \\implies C_2 = \\frac{\\phi_1 - \\phi_0}{e^P - 1}\n$$\n然后，求得 $C_1$：\n$$\nC_1 = \\phi_0 - \\frac{\\phi_1 - \\phi_0}{e^P - 1} = \\frac{\\phi_0(e^P - 1) - (\\phi_1 - \\phi_0)}{e^P - 1} = \\frac{\\phi_0 e^P - \\phi_1}{e^P - 1}\n$$\n将 $C_1$ 和 $C_2$ 代回通解，得到：\n$$\n\\phi(x) = \\frac{\\phi_0 e^P - \\phi_1}{e^P - 1} + \\left(\\frac{\\phi_1 - \\phi_0}{e^P - 1}\\right) e^{Px} = \\phi_0 + (\\phi_1 - \\phi_0) \\frac{e^{Px} - 1}{e^P - 1}\n$$\n对于特定的边界条件 $\\phi_0 = 0$ 和 $\\phi_1 = 1$，精确解简化为：\n$$\n\\phi(x) = \\frac{e^{Px} - 1}{e^P - 1}\n$$\n\n**情况2：$P = 0$**\n当 $P=0$ 时，控制方程简化为纯扩散方程：\n$$\n\\frac{d^2 \\phi}{dx^2} = 0\n$$\n积分两次得到一个线性解：$\\phi(x) = C_1 x + C_2$。\n应用边界条件 $\\phi(0) = \\phi_0 = 0$ 和 $\\phi(1) = \\phi_1 = 1$：\n在 $x=0$ 处：$\\phi(0) = C_2 = 0$。\n在 $x=1$ 处：$\\phi(1) = C_1 + C_2 = C_1 = 1$。\n因此，对于 $P=0$，精确解为：\n$$\n\\phi(x) = x\n$$\n这个结果与 $P \\to 0$ 时 $P \\neq 0$ 解的极限是一致的，这可以使用 L'Hôpital 法则进行验证。\n\n### 第2步：误差计算方法\n\n问题要求计算一阶迎风插值格式在每个内部控制体面上产生的误差。网格有 $N$ 个宽度为 $\\Delta x = 1/N$ 的均匀体积。\n\n- 内部面位于 $x_f = j \\Delta x$ (对于 $j = 1, 2, \\ldots, N-1$)。\n- 单元中心位于 $x_j = (j - 1/2) \\Delta x$ (对于 $j = 1, 2, \\ldots, N$)。\n\n问题指出，对于正速度 ($u>0$)，对流是从左向右流动的。位于单元 $j$ 和单元 $j+1$ 之间的面（位置在 $x_f = j\\Delta x$）上的迎风值取自上游单元（即迎风单元）中心的值，这里是单元 $j$。单元 $j$ 的中心在 $x_j = (j - 1/2)\\Delta x$。因此，面值的迎风近似为：\n$$\n\\phi_f^{\\text{up}} = \\phi(x_j) = \\phi\\left(\\left(j - \\frac{1}{2}\\right)\\Delta x\\right)\n$$\n同一个面上的精确值为 $\\phi(x_f) = \\phi(j\\Delta x)$。\n\n第 $j$ 个内部面上的插值误差 $e_j$ 定义为迎风近似值与精确面值之差：\n$$\ne_j = \\phi_f^{\\text{up}} - \\phi(x_f) = \\phi\\left(\\left(j - \\frac{1}{2}\\right)\\Delta x\\right) - \\phi(j\\Delta x)\n$$\n此计算针对所有内部面进行，即对于 $j = 1, 2, \\ldots, N-1$。\n\n### 第3步：数值步骤与误差指标\n\n对于由一对值 $(P, N)$ 定义的每个测试用例，执行以下步骤：\n1.  根据 $P$ 的值，确定精确解 $\\phi(x)$ 的适当形式。\n2.  计算网格间距 $\\Delta x = 1/N$。\n3.  对于从 $1$ 到 $N-1$ 的每个内部面索引 $j$：\n    a. 确定迎风单元中心坐标：$x_{\\text{cell}} = (j - 1/2)\\Delta x$。\n    b. 确定面坐标：$x_{\\text{face}} = j\\Delta x$。\n    c. 在这两个点上计算精确解：$\\phi(x_{\\text{cell}})$ 和 $\\phi(x_{\\text{face}})$。\n    d. 计算误差：$e_j = \\phi(x_{\\text{cell}}) - \\phi(x_{\\text{face}})$。\n4.  计算出误差数组 $\\{e_1, e_2, \\ldots, e_{N-1}\\}$ 后，计算两个所需的指标：\n    a. 最大绝对误差（无穷范数）：\n       $$\n       E_{\\infty} = \\max_{1 \\le j \\le N-1} |e_j|\n       $$\n    b. 平均绝对误差：\n       $$\n       E_{\\text{mean}} = \\frac{1}{N-1} \\sum_{j=1}^{N-1} |e_j|\n       $$\n5.  数对 $[E_{\\infty}, E_{\\text{mean}}]$ 构成一个测试用例的结果。对所有提供的测试用例重复此过程。为保证数值鲁棒性，表达式 $\\frac{e^A-1}{e^B-1}$ 实现为 `np.expm1(A) / np.expm1(B)`，以便在参数较小时保持精度。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the 1D steady convection-diffusion problem to find the error\n    of the upwind interpolation scheme for a series of test cases.\n    \"\"\"\n    \n    # Test cases as a list of tuples (P, N).\n    # P: global Peclet number, N: number of finite volumes.\n    test_cases = [\n        (0.0, 4),\n        (0.1, 10),\n        (2.0, 10),\n        (2.0, 40),\n        (10.0, 10),\n        (10.0, 100),\n    ]\n\n    results = []\n    \n    def exact_solution(x, P):\n        \"\"\"\n        Computes the exact solution phi(x) for the given Peclet number P.\n        \n        Args:\n            x (float or np.ndarray): The spatial coordinate(s).\n            P (float): The global Peclet number.\n            \n        Returns:\n            float or np.ndarray: The value(s) of the scalar phi.\n        \"\"\"\n        # A small tolerance to handle the P=0 case numerically.\n        if np.abs(P)  1e-9:\n            # Linear solution for pure diffusion (P=0).\n            # The .copy() is important if x is an array to avoid modifying it.\n            return x.copy() if isinstance(x, np.ndarray) else x\n        else:\n            # Exponential solution for convection-diffusion (P!=0).\n            # np.expm1(z) computes exp(z) - 1 with high precision for small z.\n            return np.expm1(P * x) / np.expm1(P)\n\n    for P, N in test_cases:\n        # Calculate mesh spacing.\n        dx = 1.0 / N\n\n        # Define indices for interior faces.\n        # j runs from 1 to N-1 for the N-1 interior faces.\n        j_indices = np.arange(1, N)\n\n        # Calculate coordinates of upwind cell centers and face centers.\n        # For a face at j*dx, the upwind cell center (for u > 0) is at (j-0.5)*dx.\n        x_cells = (j_indices - 0.5) * dx\n        x_faces = j_indices * dx\n        \n        # Evaluate the exact solution at these locations.\n        phi_cells = exact_solution(x_cells, P)\n        phi_faces = exact_solution(x_faces, P)\n\n        # The upwind interpolation error at each face.\n        errors = phi_cells - phi_faces\n        \n        # Calculate the absolute errors.\n        abs_errors = np.abs(errors)\n        \n        # Compute the required error metrics.\n        if N > 1:\n            E_infinity = np.max(abs_errors)\n            E_mean = np.mean(abs_errors)\n        else: # Handle the edge case of N=1 where there are no interior faces.\n            E_infinity = 0.0\n            E_mean = 0.0\n\n        results.append([E_infinity, E_mean])\n\n    # Format the final output string as specified.\n    # The str() representation of a list is '[val1, val2, ...]'\n    # Joining these with commas gives the desired format '[...],[...]'\n    # The outer f-string adds the final enclosing brackets.\n    output_str = f\"[{','.join(map(str, results))}]\"\n    print(output_str)\n\nsolve()\n```"
        },
        {
            "introduction": "程序代码的规范性验证是计算科学中的一个关键实践，旨在确保程序正确地求解其所描述的数学模型。本练习将介绍“制造解方法”（Method of Manufactured Solutions, MMS），这是一种强大且广泛用于验证数值格式精度阶的技术。你将把MMS应用于纯对流问题，以通过数值实验验证一阶迎风有限体积法的实现确实展现出一阶收敛性，从而巩固从修正方程分析中得到的理论结论。",
            "id": "3386714",
            "problem": "考虑在空间域 $[0,1]$ 上，标量场 $\\phi(x)$ 的稳态一维纯平流问题，其速度为常数 $a \\in \\mathbb{R}$，并包含源项 $s(x)$。其微分形式的控制守恒律为\n$$\n\\frac{d}{dx}\\big(a\\,\\phi(x)\\big) = s(x),\n$$\n并在相应的上游边界施加入流边界条件。为了验证一阶迎风有限体积离散的网格收敛性，使用制造解方法（Method of Manufactured Solutions）：给定一个光滑的精确解\n$$\n\\phi_{\\text{exact}}(x) = \\sin(2\\pi x),\n$$\n其中角度以弧度为单位，并选择 $s(x)$，使得对于任意常数 $a$，$\\phi_{\\text{exact}}(x)$ 都能恒等地满足控制方程。即，根据上述定义确定 $s(x)$。\n\n将域 $[0,1]$ 离散为 $N$ 个宽度为 $\\Delta x = 1/N$ 的均匀有限体积（单元），单元中心为 $x_i = \\big(i+\\frac{1}{2}\\big)\\Delta x$，其中 $i = 0,1,\\dots,N-1$。从守恒律出发，推导单元积分平衡方程\n$$\n\\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} \\frac{d}{dx}\\big(a\\,\\phi(x)\\big)\\,dx = \\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} s(x)\\,dx,\n$$\n并使用迎风插值计算面值，从而得到相应的离散通量差：\n- 对于 $a0$，与 $a$ 的符号一致，$x_{i+\\frac{1}{2}}$ 处的面值取自上游（左侧），$x_{i-\\frac{1}{2}}$ 处的面值也取自上游（左侧）（包括左边界）。\n- 对于 $a0$，$x_{i+\\frac{1}{2}}$ 处的面值取自上游（右侧），$x_{i-\\frac{1}{2}}$ 处的面值也取自上游（右侧）（包括右边界）。\n\n使用中点法则近似每个单元中的源项积分，即使用 $s(x_i)\\,\\Delta x$。通过从入流边界向出流边界推进的方法（当 $a0$ 时为前向替换，当 $a0$ 时为反向替换），求解得到的稳态离散系统，并在相应边界上使用由 $\\phi_{\\text{exact}}(x)$ 设定的入流边界值。计算离散 $L^1$ 误差\n$$\nE_{L^1}(N,a) = \\sum_{i=0}^{N-1}\\left|\\phi_i - \\phi_{\\text{exact}}(x_i)\\right|\\,\\Delta x,\n$$\n其中 $\\phi_i$ 表示单元 $i$ 中的离散有限体积解，$\\phi_{\\text{exact}}(x_i)$ 是单元中心的精确解。通过计算连续细化之间的观测阶来验证网格收敛性，\n$$\np = \\frac{\\ln\\big(E_{L^1}(N_{\\text{coarse}},a)/E_{L^1}(N_{\\text{fine}},a)\\big)}{\\ln\\big(\\Delta x_{\\text{coarse}}/\\Delta x_{\\text{fine}}\\big)},\n$$\n并验证对于光滑的制造解，$p$ 约等于 $1$。\n\n使用以下 $(a,N)$ 参数对的测试套件：\n- $(a,N) = (1.3,20)$,\n- $(a,N) = (1.3,40)$,\n- $(a,N) = (1.3,80)$,\n- $(a,N) = (1.3,160)$,\n- $(a,N) = (-1.7,40)$,\n- $(a,N) = (-1.7,80)$.\n\n角度以弧度为单位。所有物理量均为无量纲。对于观测阶的计算，当 $a=1.3$ 时，组成 $(N_{\\text{coarse}},N_{\\text{fine}}) = (20,40)$, $(40,80)$, $(80,160)$ 对；当 $a=-1.7$ 时，组成 $(40,80)$ 对。除了误差外，还需计算布尔值，以指示每个观测阶 $p$ 是否在 $1$ 的 $\\pm 0.1$ 容差范围内，即是否满足 $\\left|p-1\\right|\\le 0.1$。\n\n您的程序应产生单行输出，其中包含一个用方括号括起来的逗号分隔列表。该列表必须按顺序包含：\n- 上述测试用例的 $6$ 个 $L^1$ 误差，\n- 上述细化对的 $4$ 个观测阶 $p$，\n- 上述阶数检查的 $4$ 个布尔值。\n\n例如，输出应具有以下形式\n$$\n[\\text{E}_{1},\\text{E}_{2},\\text{E}_{3},\\text{E}_{4},\\text{E}_{5},\\text{E}_{6},\\;p_{1},p_{2},p_{3},p_{4},\\;\\text{b}_{1},\\text{b}_{2},\\text{b}_{3},\\text{b}_{4}],\n$$\n其中每个 $\\text{E}_{k}$ 是一个浮点数，每个 $p_{j}$ 是一个浮点数，每个 $\\text{b}_{j}$ 是一个布尔值。",
            "solution": "用户希望使用一阶迎风有限体积法求解一个稳态一维平流-源项问题，并使用制造解方法验证其网格收敛性。\n\n首先，我们验证问题陈述。该问题提供了一个定义明确的偏微分方程、一个制造解、对数值方法（一阶迎风有限体积）的清晰描述、一个域、边界条件、误差度量以及具体的测试用例。该问题在科学上是合理的、适定的、客观的和完整的。它代表了计算流体动力学中的一个标准验证练习。因此，该问题被视为**有效的**。\n\n解题过程分为以下几个步骤：\n\n**1. 制造源项的推导**\n控制方程是稳态一维守恒律：\n$$\n\\frac{d}{dx}\\big(a\\,\\phi(x)\\big) = s(x)\n$$\n其中 `$a$` 是一个恒定速度。这可以简化为 `$a \\frac{d\\phi}{dx} = s(x)$`。给定的制造解是：\n$$\n\\phi_{\\text{exact}}(x) = \\sin(2\\pi x)\n$$\n为确保 `$\\phi_{\\text{exact}}(x)$` 是一个解，我们必须相应地选择源项 `$s(x)$`。我们对 `$\\phi_{\\text{exact}}(x)$` 求导，并将其代入控制方程中：\n$$\n\\frac{d\\phi_{\\text{exact}}}{dx} = \\frac{d}{dx}\\big(\\sin(2\\pi x)\\big) = 2\\pi \\cos(2\\pi x)\n$$\n因此，源项必须是：\n$$\ns(x) = a \\frac{d\\phi_{\\text{exact}}}{dx} = 2\\pi a \\cos(2\\pi x)\n$$\n\n**2. 有限体积离散**\n我们将域 `$[0,1]$` 离散为 `$N$` 个宽度为 `$\\Delta x = 1/N$` 的均匀单元。第 `$i$` 个单元跨越区间 `$[x_{i-\\frac{1}{2}}, x_{i+\\frac{1}{2}}]$`，其中心位于 `$x_i = (i+\\frac{1}{2})\\Delta x$`，其中 `$i = 0, \\dots, N-1$`。\n\n我们对控制方程在第 `$i$` 个单元上进行积分：\n$$\n\\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} \\frac{d}{dx}\\big(a\\,\\phi(x)\\big)\\,dx = \\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} s(x)\\,dx\n$$\n对左侧应用微积分基本定理，得到单元面上的通量差：\n$$\n\\big[a\\,\\phi(x)\\big]_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} = (a\\phi)_{i+\\frac{1}{2}} - (a\\phi)_{i-\\frac{1}{2}}\n$$\n其中 `$(a\\phi)_{i \\pm \\frac{1}{2}}$` 表示在面 `$x_{i \\pm \\frac{1}{2}}$` 处的通量。右侧的源项积分使用中点法则进行近似：\n$$\n\\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} s(x)\\,dx \\approx s(x_i)\\Delta x\n$$\n将这些结合起来，得到单元 `$i$` 的离散平衡方程：\n$$\n(a\\phi)_{i+\\frac{1}{2}} - (a\\phi)_{i-\\frac{1}{2}} = s(x_i)\\Delta x\n$$\n设 `$\\phi_i$` 表示单元 `$i$` 中单元平均值的数值近似。我们现在应用一阶迎风格式来近似面通量。\n\n**3. 迎风格式和求解推进**\n迎风格式将面上的 `$\\phi$` 值设为该面上游单元的值。上游方向由速度 `$a$` 的符号决定。\n\n**情况1：`$a  0$`（从左向右流动）**\n上游方向是左侧。\n-   在面 `$x_{i+\\frac{1}{2}}$` 处的通量：值取自单元 `$i$`。 `$ (a\\phi)_{i+\\frac{1}{2}} \\approx a\\phi_i $`。\n-   在面 `$x_{i-\\frac{1}{2}}$` 处的通量：值取自单元 `$i-1$`。 `$ (a\\phi)_{i-\\frac{1}{2}} \\approx a\\phi_{i-1} $`。\n\n离散方程变为：\n$$\na\\phi_i - a\\phi_{i-1} = s(x_i)\\Delta x\n$$\n求解 `$\\phi_i$`，我们得到一个递推关系：\n$$\n\\phi_i = \\phi_{i-1} + \\frac{s(x_i)\\Delta x}{a}\n$$\n入流边界位于 `$x=0$`。对于第一个单元（`$i=0$`），`$\\phi_{i-1}$` 项成为边界值，`$\\phi_{-1} \\equiv \\phi_{\\text{exact}}(0) = \\sin(0) = 0$`。因此，我们可以顺序求解 `$\\phi_0, \\phi_1, \\dots, \\phi_{N-1}$`（前向替换）。\n\n**情况2：`$a  0$`（从右向左流动）**\n上游方向是右侧。\n-   在面 `$x_{i+\\frac{1}{2}}$` 处的通量：值取自单元 `$i+1$`。 `$ (a\\phi)_{i+\\frac{1}{2}} \\approx a\\phi_{i+1} $`。\n-   在面 `$x_{i-\\frac{1}{2}}$` 处的通量：值取自单元 `$i$`。 `$ (a\\phi)_{i-\\frac{1}{2}} \\approx a\\phi_i $`。\n\n离散方程变为：\n$$\na\\phi_{i+1} - a\\phi_i = s(x_i)\\Delta x\n$$\n求解 `$\\phi_i$`，我们得到一个不同的递推关系：\n$$\n\\phi_i = \\phi_{i+1} - \\frac{s(x_i)\\Delta x}{a}\n$$\n入流边界位于 `$x=1$`。对于最后一个单元（`$i=N-1$`），`$\\phi_{i+1}$` 项成为边界值，`$\\phi_{N} \\equiv \\phi_{\\text{exact}}(1) = \\sin(2\\pi) = 0$`。我们顺序求解 `$\\phi_{N-1}, \\phi_{N-2}, \\dots, \\phi_0}$`（反向替换）。\n\n**4. 误差与收敛性分析**\n在计算出 `$i=0, \\dots, N-1$` 的数值解 `$\\phi_i$` 之后，我们使用提供的公式计算离散 `$L^1$` 误差：\n$$\nE_{L^1}(N,a) = \\sum_{i=0}^{N-1}\\left|\\phi_i - \\phi_{\\text{exact}}(x_i)\\right|\\,\\Delta x\n$$\n对于连续细化的网格对，计算收敛的观测阶 `$p$`：\n$$\np = \\frac{\\ln\\big(E_{L^1}(N_{\\text{coarse}},a)/E_{L^1}(N_{\\text{fine}},a)\\big)}{\\ln\\big(\\Delta x_{\\text{coarse}}/\\Delta x_{\\text{fine}}\\big)}\n$$\n对于细化因子 `$2$`，`$\\Delta x_{\\text{coarse}}/\\Delta x_{\\text{fine}} = 2$`，因此分母为 `$\\ln(2)$`。这种一阶格式的理论收敛阶是 `$p=1$`。我们通过检查是否满足 `$\\left|p-1\\right|\\le 0.1$` 来验证这一点。\n\n实现将遵循此逻辑，为每个指定的 `$(a,N)` 对计算并报告误差、阶数和布尔检查的序列。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the 1D steady advection problem using a first-order upwind FVM,\n    computes L1 errors and convergence orders for specified test cases.\n    \"\"\"\n    # Define test cases_\n    test_cases = [\n        (1.3, 20),\n        (1.3, 40),\n        (1.3, 80),\n        (1.3, 160),\n        (-1.7, 40),\n        (-1.7, 80),\n    ]\n\n    def compute_l1_error(a, N):\n        \"\"\"\n        Computes the L1 error for a given advection velocity 'a' and grid size 'N'.\n        \"\"\"\n        # Domain and grid setup\n        dx = 1.0 / N\n        # Cell centers\n        x_centers = (np.arange(N) + 0.5) * dx\n\n        # Manufactured solution and source term functions\n        def phi_exact(x):\n            return np.sin(2 * np.pi * x)\n\n        def s_func(x, vel):\n            # s(x) = d/dx(a*phi) = a * d/dx(phi)\n            return vel * 2 * np.pi * np.cos(2 * np.pi * x)\n\n        # Numerical solution array\n        phi_num = np.zeros(N)\n        \n        # Pre-compute source term values at cell centers\n        s_vals = s_func(x_centers, a)\n\n        # Solve the discrete system by marching from the inflow boundary\n        if a > 0:\n            # Inflow from x = 0.\n            # Upwind scheme: a*phi_i - a*phi_{i-1} = s(x_i)*dx\n            # For i=0, phi_{i-1} is the boundary value phi_exact(0)=0.\n            phi_boundary = phi_exact(0.0)\n            \n            # Recurrence relation: phi_i = phi_{i-1} + s(x_i)*dx/a\n            \n            # Solve for phi_0\n            phi_num[0] = phi_boundary + s_vals[0] * dx / a\n            # March forward for i=1, ..., N-1\n            for i in range(1, N):\n                phi_num[i] = phi_num[i-1] + s_vals[i] * dx / a\n\n        elif a  0:\n            # Inflow from x = 1.\n            # Upwind scheme: a*phi_{i+1} - a*phi_i = s(x_i)*dx\n            # For i=N-1, phi_{i+1} is the boundary value phi_exact(1)=0.\n            phi_boundary = phi_exact(1.0)\n            \n            # Recurrence relation: phi_i = phi_{i+1} - s(x_i)*dx/a\n            \n            # Solve for phi_{N-1}\n            phi_num[N-1] = phi_boundary - s_vals[N-1] * dx / a\n            # March backward for i=N-2, ..., 0\n            for i in range(N - 2, -1, -1):\n                phi_num[i] = phi_num[i+1] - s_vals[i] * dx / a\n\n        # Evaluate exact solution at cell centers for error calculation\n        phi_ex_centers = phi_exact(x_centers)\n\n        # Compute the discrete L1 error\n        l1_error = np.sum(np.abs(phi_num - phi_ex_centers)) * dx\n        return l1_error\n\n    # Calculate L1 errors for all test cases\n    errors = [compute_l1_error(a, N) for a, N in test_cases]\n    \n    # Define pairs for order calculation based on the indices of `test_cases`\n    order_pairs_indices = [\n        (0, 1),  # a=1.3, (N=20, N=40)\n        (1, 2),  # a=1.3, (N=40, N=80)\n        (2, 3),  # a=1.3, (N=80, N=160)\n        (4, 5),  # a=-1.7, (N=40, N=80)\n    ]\n\n    orders = []\n    for idx_coarse, idx_fine in order_pairs_indices:\n        E_coarse = errors[idx_coarse]\n        E_fine = errors[idx_fine]\n        \n        N_coarse = test_cases[idx_coarse][1]\n        N_fine = test_cases[idx_fine][1]\n\n        # dx_coarse / dx_fine = (1/N_coarse) / (1/N_fine) = N_fine / N_coarse\n        refinement_ratio = float(N_fine) / N_coarse\n        \n        # p = log(E_coarse/E_fine) / log(dx_coarse/dx_fine)\n        p = np.log(E_coarse / E_fine) / np.log(refinement_ratio)\n        orders.append(p)\n\n    # Check if an order p is within tolerance |p - 1| = 0.1\n    order_checks = [abs(p - 1.0) = 0.1 for p in orders]\n\n    # Combine all results into a single list for output\n    all_results = errors + orders + order_checks\n    \n    # Format the final output string as specified\n    print(f\"[{','.join(map(str, all_results))}]\")\n\nsolve()\n```"
        }
    ]
}