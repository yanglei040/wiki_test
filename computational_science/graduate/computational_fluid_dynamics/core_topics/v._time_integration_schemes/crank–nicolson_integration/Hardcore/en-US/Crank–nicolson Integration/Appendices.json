{
    "hands_on_practices": [
        {
            "introduction": "The theoretical second-order accuracy of the Crank-Nicolson method is one of its most celebrated features. This exercise provides a concrete method for verifying this property and estimating the magnitude of the temporal error in a simulation. By applying Richardson extrapolation, a powerful technique in numerical analysis, you will use results from two different time step sizes to estimate the error and confirm its scaling, moving from abstract theory to practical error quantification .",
            "id": "3305869",
            "problem": "Consider the one-dimensional transient diffusion of a passive, non-dimensional scalar whose single Fourier mode amplitude evolves according to the linear ordinary differential equation $\\,\\frac{d u}{d t} = \\lambda\\, u\\,$ with constant $\\lambda = -3$. Assume that space is sufficiently resolved so that the temporal integration error dominates, and that time is advanced using the Crank–Nicolson integration (CN) method. Let the initial condition be $\\,u(0) = 1\\,$ and consider the target time $\\,T = 2\\,\\Delta t\\,$ with $\\Delta t = 0.1$.\n\nA production computational fluid dynamics (CFD) code reports the following two CN approximations at time $\\,T\\,$:\n- Two CN steps of size $\\,\\Delta t\\,$ yield $\\,u_{\\Delta t}^{(2)} = \\frac{289}{529}\\,$.\n- One CN step of size $\\,2\\,\\Delta t\\,$ yields $\\,u_{2\\Delta t}^{(1)} = \\frac{7}{13}\\,$.\n\nDefine the temporal discretization error magnitude of the two-step CN approximation at time $\\,T\\,$ as $\\,|E_{\\Delta t}| = |u_{\\Delta t}^{(2)} - u(T)|\\,$. Using Richardson extrapolation based on the second-order global accuracy of CN, estimate $\\,|E_{\\Delta t}|\\,$ from the two approximations above, and then specify the second-order scaling law by determining the proportionality constant $\\,K  0\\,$ in $\\,|E(\\Delta t)| \\approx K\\,\\Delta t^{2}\\,$. Express the final answer as a row matrix $\\,(|E_{\\Delta t}| \\text{ and } K)\\,$, both as exact values (do not round), and note that all quantities are dimensionless.",
            "solution": "The problem requires the estimation of the temporal discretization error for a Crank-Nicolson (CN) scheme and the determination of the error scaling constant using Richardson extrapolation.\n\nThe governing ordinary differential equation (ODE) is given by:\n$$\n\\frac{d u}{d t} = \\lambda u\n$$\nwith a constant coefficient $\\lambda = -3$ and an initial condition $u(0) = 1$.\n\nThe Crank-Nicolson method is an implicit, second-order accurate time integration scheme. Applying it to the given ODE, the update from time step $n$ to $n+1$ over a time interval $\\Delta t$ is:\n$$\n\\frac{u^{n+1} - u^n}{\\Delta t} = \\frac{\\lambda}{2} (u^{n+1} + u^n)\n$$\nThis is a single-step method. The problem provides two numerical approximations for the solution at a target time $T = 2 \\Delta t = 2(0.1) = 0.2$.\n\nLet $u_h$ denote the numerical solution at time $T$ obtained using a uniform step size $h$. Since the CN method has a global error of order $2$, the numerical solution can be related to the exact solution $u(T)$ through an error expansion:\n$$\nu_h = u(T) + C h^2 + \\mathcal{O}(h^4)\n$$\nwhere $C$ is a constant that depends on the ODE and the solution derivatives, but is independent of the step size $h$.\n\nWe are given two approximations at $T = 0.2$:\n1.  A coarse approximation, $u_{2\\Delta t}^{(1)}$, obtained using one step of size $h_1 = 2 \\Delta t = 0.2$.\n2.  A fine approximation, $u_{\\Delta t}^{(2)}$, obtained using two steps of size $h_2 = \\Delta t = 0.1$.\n\nUsing the error expansion for each case:\nFor the coarse step ($h_1 = 2 \\Delta t$):\n$$\nu_{2\\Delta t}^{(1)} = u(T) + C (2 \\Delta t)^2 + \\mathcal{O}(\\Delta t^4) = u(T) + 4C (\\Delta t)^2 + \\mathcal{O}(\\Delta t^4) \\quad (1)\n$$\nFor the fine steps ($h_2 = \\Delta t$):\n$$\nu_{\\Delta t}^{(2)} = u(T) + C (\\Delta t)^2 + \\mathcal{O}(\\Delta t^4) \\quad (2)\n$$\n\nThe temporal discretization error of the two-step (fine) approximation is defined as $E_{\\Delta t} = u_{\\Delta t}^{(2)} - u(T)$. From equation $(2)$, we see that the leading-order term of this error is $C (\\Delta t)^2$. Richardson extrapolation allows us to estimate this error term using the two available numerical solutions.\n\nSubtracting equation $(1)$ from equation $(2)$:\n$$\nu_{\\Delta t}^{(2)} - u_{2\\Delta t}^{(1)} = \\left(u(T) + C(\\Delta t)^2\\right) - \\left(u(T) + 4C(\\Delta t)^2\\right) + \\mathcal{O}(\\Delta t^4)\n$$\n$$\nu_{\\Delta t}^{(2)} - u_{2\\Delta t}^{(1)} = -3C(\\Delta t)^2 + \\mathcal{O}(\\Delta t^4)\n$$\nBy neglecting the higher-order terms $\\mathcal{O}(\\Delta t^4)$, we can solve for an estimate of the leading error term $C(\\Delta t)^2$:\n$$\nC(\\Delta t)^2 \\approx -\\frac{1}{3} \\left( u_{\\Delta t}^{(2)} - u_{2\\Delta t}^{(1)} \\right) = \\frac{1}{3} \\left( u_{2\\Delta t}^{(1)} - u_{\\Delta t}^{(2)} \\right)\n$$\nThis expression is the Richardson estimate for the error of the fine-grid solution, $E_{\\Delta t, \\text{est}}$.\n$$\nE_{\\Delta t, \\text{est}} = \\frac{1}{3} \\left( u_{2\\Delta t}^{(1)} - u_{\\Delta t}^{(2)} \\right)\n$$\nThe problem asks for an estimate of the error magnitude, $|E_{\\Delta t}| = |u_{\\Delta t}^{(2)} - u(T)|$. We will use $|E_{\\Delta t, \\text{est}}|$ for this estimate.\n\nLet's substitute the given numerical values:\n$u_{\\Delta t}^{(2)} = \\frac{289}{529}$\n$u_{2\\Delta t}^{(1)} = \\frac{7}{13}$\n\nThe difference is:\n$$\nu_{2\\Delta t}^{(1)} - u_{\\Delta t}^{(2)} = \\frac{7}{13} - \\frac{289}{529}\n$$\nThe common denominator is $13 \\times 529$. Note that $529 = 23^2$.\n$$\nu_{2\\Delta t}^{(1)} - u_{\\Delta t}^{(2)} = \\frac{7 \\times 529 - 289 \\times 13}{13 \\times 529} = \\frac{3703 - 3757}{6877} = -\\frac{54}{6877}\n$$\nNow, we calculate the estimated error $E_{\\Delta t, \\text{est}}$:\n$$\nE_{\\Delta t, \\text{est}} = \\frac{1}{3} \\left( -\\frac{54}{6877} \\right) = -\\frac{18}{6877}\n$$\nThe estimated error magnitude is therefore:\n$$\n|E_{\\Delta t}| = |E_{\\Delta t, \\text{est}}| = \\left|-\\frac{18}{6877}\\right| = \\frac{18}{6877}\n$$\nThis is the first part of the answer.\n\nNext, we must determine the proportionality constant $K  0$ in the second-order scaling law $|E(\\Delta t)| \\approx K (\\Delta t)^2$. We use our estimated error magnitude for $|E(\\Delta t)|$ at the specific step size $\\Delta t = 0.1$:\n$$\n|E(\\Delta t = 0.1)| \\approx \\frac{18}{6877}\n$$\nSubstituting this into the scaling law:\n$$\n\\frac{18}{6877} = K (\\Delta t)^2 = K (0.1)^2 = K \\left(\\frac{1}{10}\\right)^2 = K \\left(\\frac{1}{100}\\right)\n$$\nSolving for $K$:\n$$\nK = 100 \\times \\frac{18}{6877} = \\frac{1800}{6877}\n$$\nThis is the second part of the answer.\n\nThe final answer is the row matrix $(|E_{\\Delta t}|, K)$.",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{18}{6877}  \\frac{1800}{6877}\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "While Crank-Nicolson is unconditionally stable for linear problems, stability does not guarantee physically correct behavior, especially for advection-dominated flows. This practice explores the method's non-monotonic nature when paired with a standard centered-difference spatial scheme, a combination known to be dispersive. By simulating the advection of a sharp discontinuity, you will numerically generate and quantify the non-physical Gibbs oscillations, gaining crucial insight into the limitations of using CN for hyperbolic problems .",
            "id": "3305885",
            "problem": "Consider the one-dimensional linear advection equation, a prototypical conservation law in computational fluid dynamics, given by $u_t + a\\,u_x = 0$ on a periodic domain of length $L$ with constant advection speed $a$. The task is to investigate the monotonicity of the Crank–Nicolson (CN) time integration when combined with a centered spatial discretization for pure advection. Starting from the conservation law and constructing a semi-discrete system via centered differences, derive the Crank–Nicolson time-stepping from first principles and implement it in a way that is faithful to the underlying operators on a uniform grid with periodic boundary conditions. Then, using a discontinuous step initial condition, numerically demonstrate Gibbs-like oscillations and quantify the violation of monotonicity.\n\nYou must adhere to the following specifications:\n\n- Domain and units:\n  - Use a periodic spatial domain $[0,L)$ with $L = 1$ measured in meters (m).\n  - Use $a = 1$ measured in meters per second (m/s).\n  - The spatial grid consists of $N$ uniformly spaced points, so the grid spacing is $\\Delta x = L/N$ measured in meters (m).\n  - The time step is $\\Delta t$ measured in seconds (s), chosen via the Courant–Friedrichs–Lewy (CFL) number as $\\Delta t = (\\text{CFL})\\,\\Delta x/a$.\n- Discretization requirements:\n  - Discretize $u_x$ by the second-order centered difference on the uniform grid with periodic boundary conditions.\n  - Derive and implement the Crank–Nicolson (CN) method in time for the resulting semi-discrete system. Do not rely on any upwinding or artificial diffusion.\n- Initial condition:\n  - Use the discontinuous step function $u(x,0)$ defined on the grid by $u_j(0) = 1$ for indices $j$ such that $x_j \\in [0,L/2)$ and $u_j(0) = 0$ otherwise, with periodic boundary conditions. This choice yields a single discontinuity at $x=0$ and another at $x=L/2$.\n- Quantities to compute after advancing the solution for a specified number of time steps:\n  - The overshoot amplitude above the upper bound $1$, defined as $\\max\\{0, \\max_j u_j - 1\\}$ (dimensionless).\n  - The undershoot amplitude below the lower bound $0$, defined as $\\max\\{0, 0 - \\min_j u_j\\}$ (dimensionless).\n  - The discrete total variation $TV(u)$, defined as $TV(u) = \\sum_{j=0}^{N-1} |u_{j+1} - u_j|$ with periodic wrap so that $u_N \\equiv u_0$ (dimensionless).\n- Scientific realism:\n  - The centered scheme for pure advection is non-dissipative and the Crank–Nicolson time integrator is energy-conserving for linear skew-adjoint operators, which together can generate dispersive oscillations near discontinuities. Your program must quantify these oscillations using the metrics above.\n- Test suite:\n  - Use the following four parameter sets to test different regimes:\n    - Case $1$: $(N, \\text{CFL}, \\text{steps}) = (128, 0.5, 64)$.\n    - Case $2$: $(N, \\text{CFL}, \\text{steps}) = (128, 0.9, 64)$.\n    - Case $3$: $(N, \\text{CFL}, \\text{steps}) = (32, 0.5, 32)$.\n    - Case $4$: $(N, \\text{CFL}, \\text{steps}) = (128, 0.1, 320)$.\n- Output specification:\n  - For each test case, compute the list $[\\text{overshoot}, \\text{undershoot}, TV]$ of three floating-point numbers (dimensionless).\n  - Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. The results for the four cases should be aggregated in order into a list of lists, for example, $[[r_{11},r_{12},r_{13}],[r_{21},r_{22},r_{23}],[r_{31},r_{32},r_{33}],[r_{41},r_{42},r_{43}]]$, where each $r_{ij}$ is a floating-point number. Express all outputs as decimals without any unit symbols or percentage signs.\n\nYour implementation must be self-contained and should not accept any user input. All calculations must be performed in the specified units, with the output being dimensionless as described. The goal is to explicitly demonstrate and quantify the non-monotonic behavior of Crank–Nicolson with centered differences for pure advection via the step initial condition and the metrics defined above.",
            "solution": "The user has provided a valid, well-posed problem statement from the field of computational fluid dynamics. The task is to analyze the non-monotonic nature of the Crank–Nicolson (CN) time integration scheme combined with centered spatial differencing for the linear advection equation. We will first derive the numerical scheme from fundamental principles and then implement it to quantify the expected Gibbs-like oscillations.\n\nThe governing equation is the one-dimensional linear advection equation:\n$$\n\\frac{\\partial u}{\\partial t} + a \\frac{\\partial u}{\\partial x} = 0\n$$\nThis equation is defined on a periodic spatial domain $[0, L)$, with a constant advection speed $a$. The problem specifies $L=1\\,\\text{m}$ and $a=1\\,\\text{m/s}$.\n\nFirst, we perform a semi-discretization in space. The domain is discretized into $N$ uniformly spaced points $x_j = j \\Delta x$ for $j=0, 1, \\dots, N-1$, where the grid spacing is $\\Delta x = L/N$. The solution at these points is denoted by the vector $\\mathbf{u}(t) = [u_0(t), u_1(t), \\dots, u_{N-1}(t)]^T$, where $u_j(t) \\approx u(x_j, t)$. The spatial derivative $\\partial u/\\partial x$ at grid point $x_j$ is approximated using a second-order accurate centered difference scheme:\n$$\n\\left. \\frac{\\partial u}{\\partial x} \\right|_{x_j} \\approx \\frac{u_{j+1}(t) - u_{j-1}(t)}{2 \\Delta x}\n$$\nDue to the periodic boundary conditions, we have $u_N \\equiv u_0$ and $u_{-1} \\equiv u_{N-1}$. Substituting this approximation into the advection equation yields a system of ordinary differential equations (ODEs):\n$$\n\\frac{d u_j}{dt} = -a \\frac{u_{j+1} - u_{j-1}}{2 \\Delta x}\n$$\nThis can be expressed in matrix form as $\\frac{d\\mathbf{u}}{dt} = \\mathbf{A}\\mathbf{u}$. The matrix $\\mathbf{A}$ represents the discrete spatial operator $-a (\\cdot)_x$. It is an $N \\times N$ circulant and skew-symmetric matrix:\n$$\n\\mathbf{A} = -\\frac{a}{2 \\Delta x}\n\\begin{pmatrix}\n0  1  0  \\dots  0  -1 \\\\\n-1  0  1  \\dots  0  0 \\\\\n0  -1  0  \\dots  0  0 \\\\\n\\vdots  \\vdots  \\ddots  \\ddots  \\ddots  \\vdots \\\\\n0  0  0  \\dots  0  1 \\\\\n1  0  0  \\dots  -1  0\n\\end{pmatrix}\n$$\nThe skew-symmetry ($\\mathbf{A}^T = -\\mathbf{A}$) is a discrete analogue of the skew-adjoint property of the continuous derivative operator $\\partial/\\partial x$ on a periodic domain. This property ensures that the semi-discrete system conserves the discrete $L_2$ norm, i.e., $\\frac{d}{dt} ||\\mathbf{u}||_2^2 = 0$.\n\nNext, we discretize the time derivative using the Crank–Nicolson method. This method is implicit and second-order accurate in time. Applying it to the semi-discrete system $\\frac{d\\mathbf{u}}{dt} = \\mathbf{A}\\mathbf{u}$ from time $t^n$ to $t^{n+1} = t^n + \\Delta t$, we get:\n$$\n\\frac{\\mathbf{u}^{n+1} - \\mathbf{u}^n}{\\Delta t} = \\frac{1}{2} \\left( \\mathbf{A}\\mathbf{u}^n + \\mathbf{A}\\mathbf{u}^{n+1} \\right)\n$$\nwhere $\\mathbf{u}^n$ is the numerical solution at time step $n$. To solve for $\\mathbf{u}^{n+1}$, we rearrange the terms:\n$$\n\\mathbf{u}^{n+1} - \\frac{\\Delta t}{2} \\mathbf{A}\\mathbf{u}^{n+1} = \\mathbf{u}^n + \\frac{\\Delta t}{2} \\mathbf{A}\\mathbf{u}^n\n$$\nThis yields the linear system to be solved at each time step:\n$$\n\\left( \\mathbf{I} - \\frac{\\Delta t}{2} \\mathbf{A} \\right) \\mathbf{u}^{n+1} = \\left( \\mathbf{I} + \\frac{\\Delta t}{2} \\mathbf{A} \\right) \\mathbf{u}^n\n$$\nwhere $\\mathbf{I}$ is the identity matrix. Solving this system directly by matrix inversion would be computationally expensive. However, since $\\mathbf{A}$ is a circulant matrix, the matrices on the left and right hand sides are also circulant. Circulant matrices are diagonalized by the Discrete Fourier Transform (DFT), which allows for a highly efficient solution in Fourier space.\n\nLet $\\hat{\\mathbf{u}} = \\mathcal{F}(\\mathbf{u})$ be the DFT of $\\mathbf{u}$. Applying the DFT to the time-stepping equation transforms the matrix-vector products into element-wise products of the transformed vector and the eigenvalues of the matrices. The eigenvalues of the spatial operator matrix $\\mathbf{A}$ corresponding to the discrete wavenumber $k_m = 2\\pi m / L$ (where $m$ is an integer identifying the Fourier mode) are purely imaginary:\n$$\n\\lambda_m(\\mathbf{A}) = -i \\frac{a}{\\Delta x} \\sin(k_m \\Delta x)\n$$\nThe time-stepping equation in Fourier space becomes:\n$$\n\\left( 1 - \\frac{\\Delta t}{2} \\lambda_m(\\mathbf{A}) \\right) \\hat{u}_m^{n+1} = \\left( 1 + \\frac{\\Delta t}{2} \\lambda_m(\\mathbf{A}) \\right) \\hat{u}_m^{n}\n$$\nThus, the update for each Fourier mode is $\\hat{u}_m^{n+1} = G(k_m) \\hat{u}_m^{n}$, where $G(k_m)$ is the amplification factor:\n$$\nG(k_m) = \\frac{1 + \\frac{\\Delta t}{2} \\lambda_m(\\mathbf{A})}{1 - \\frac{\\Delta t}{2} \\lambda_m(\\mathbf{A})} = \\frac{1 - i \\frac{a \\Delta t}{2 \\Delta x} \\sin(k_m \\Delta x)}{1 + i \\frac{a \\Delta t}{2 \\Delta x} \\sin(k_m \\Delta x)}\n$$\nDefining the Courant number (CFL) as $\\nu = \\frac{a \\Delta t}{\\Delta x}$, the amplification factor is:\n$$\nG(k_m) = \\frac{1 - i \\frac{\\nu}{2} \\sin(k_m \\Delta x)}{1 + i \\frac{\\nu}{2} \\sin(k_m \\Delta x)}\n$$\nThe magnitude of this complex number is $|G(k_m)| = 1$ for all wavenumbers $k_m$ and all real $\\nu$. This means the scheme is unconditionally stable in the von Neumann sense, and it conserves the energy of each Fourier mode individually. However, this property does not guarantee monotonicity. A scheme is monotone if it does not introduce new local extrema. The provided initial condition is a step function with values $0$ and $1$. A monotone scheme would ensure that the solution remains bounded between $0$ and $1$ for all time. The centered-difference Crank-Nicolson scheme is known to be dispersive, meaning different wavenumbers propagate at different phase speeds, which differ from the true advection speed $a$. This dispersion causes sharp gradients, such as the discontinuity in the initial condition, to develop spurious oscillations known as Gibbs phenomena. These oscillations violate monotonicity, leading to values greater than $1$ (overshoot) and less than $0$ (undershoot).\n\nThe total variation, $TV(u) = \\sum_{j=0}^{N-1} |u_{j+1} - u_j|$ (with $u_N=u_0$), is a measure of the total oscillation in the solution. For the initial step function, the only non-zero differences occur at the two discontinuities (at $x=0$ and $x=L/2$), yielding an initial $TV(u^0) = |0-1| + |1-0| = 2$. For a monotone scheme solving the linear advection equation, the total variation must not increase over time ($TV(u^{n+1}) \\le TV(u^n)$). The generation of oscillations by the CN scheme will cause the total variation to increase, providing a quantitative measure of its non-monotonicity.\n\nThe algorithm to be implemented is as follows:\n1.  Initialize the grid and the step-function initial condition vector $\\mathbf{u}^0$.\n2.  Compute the discrete wavenumbers $k_m$ corresponding to the grid.\n3.  Calculate the amplification factor array $G(k_m)$ based on the given CFL number.\n4.  Compute the DFT of the initial condition: $\\hat{\\mathbf{u}}^0 = \\text{FFT}(\\mathbf{u}^0)$.\n5.  To advance the solution by a total number of `steps`, compute the final state in Fourier space: $\\hat{\\mathbf{u}}^{\\text{final}} = \\hat{\\mathbf{u}}^0 \\cdot G^{\\text{steps}}$.\n6.  Compute the inverse DFT to obtain the final solution in physical space: $\\mathbf{u}^{\\text{final}} = \\text{IFFT}(\\hat{\\mathbf{u}}^{\\text{final}})$.\n7.  Using $\\mathbf{u}^{\\text{final}}$, calculate the overshoot $\\max\\{0, \\max_j u_j - 1\\}$, the undershoot $\\max\\{0, -\\min_j u_j\\}$, and the total variation $TV(u)$.\nThis procedure is performed for each of the four specified test cases.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the 1D linear advection equation using Crank-Nicolson\n    with centered differences and quantifies non-monotonicity.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (N, CFL, steps)\n        (128, 0.5, 64),\n        (128, 0.9, 64),\n        (32, 0.5, 32),\n        (128, 0.1, 320),\n    ]\n\n    results = []\n    \n    # Constants from the problem statement\n    L = 1.0  # Domain length in meters\n    a = 1.0  # Advection speed in m/s\n\n    for N, cfl, steps in test_cases:\n        # 1. Setup grid and parameters\n        dx = L / N\n        # dt is not explicitly needed for the Fourier method, as CFL is used directly.\n        # dt = cfl * dx / a\n\n        # Create spatial grid\n        x = np.linspace(0, L, N, endpoint=False)\n\n        # 2. Set up initial condition\n        u0 = np.zeros(N)\n        # u(x,0) = 1 for x in [0, L/2)\n        u0[x  L / 2.0] = 1.0\n\n        # 3. Time-stepping in Fourier space\n        \n        # Calculate angular wavenumbers\n        # k = 2 * pi * f, where f are frequencies from fftfreq\n        # fftfreq(n, d) gives sample frequencies in cycles/unit_of_d\n        # Here d=dx, so frequencies are in 1/m.\n        k = 2 * np.pi * np.fft.fftfreq(N, d=dx)\n\n        # Calculate the amplification factor G for Crank-Nicolson\n        # G = (1 - 0.5j * cfl * sin(k*dx)) / (1 + 0.5j * cfl * sin(k*dx))\n        sin_term = np.sin(k * dx)\n        numerator = 1.0 - 0.5j * cfl * sin_term\n        denominator = 1.0 + 0.5j * cfl * sin_term\n        G = numerator / denominator\n\n        # Evolve the solution in Fourier space\n        u0_hat = np.fft.fft(u0)\n        # Evolve for 'steps' time steps\n        u_final_hat = u0_hat * (G ** steps)\n\n        # Transform back to physical space\n        u_final = np.fft.ifft(u_final_hat).real\n\n        # 4. Quantify oscillations and TV\n        \n        # Overshoot amplitude above 1\n        overshoot = max(0.0, np.max(u_final) - 1.0)\n        \n        # Undershoot amplitude below 0\n        undershoot = max(0.0, 0.0 - np.min(u_final))\n        \n        # Discrete total variation TV(u) = sum(|u_{j+1} - u_j|)\n        # np.roll handles the periodic boundary condition u_N = u_0\n        tv = np.sum(np.abs(np.roll(u_final, -1) - u_final))\n        \n        results.append([overshoot, undershoot, tv])\n\n    # Format the output string precisely as required\n    # e.g., [[r11,r12,r13],[r21,r22,r23]] with no spaces\n    inner_results_str = [f\"[{r[0]},{r[1]},{r[2]}]\" for r in results]\n    final_output_str = f\"[{','.join(inner_results_str)}]\"\n    \n    # Final print statement in the exact required format.\n    print(final_output_str)\n\nsolve()\n```"
        },
        {
            "introduction": "In many physical systems, such as those involving chemical reactions, the solution represents a concentration that must remain non-negative. This exercise addresses a critical challenge where the Crank-Nicolson scheme, despite its A-stability, can produce unphysical negative values when applied to stiff reaction-diffusion systems. You will not only analyze the conditions that lead to this failure of positivity but also implement and test a positivity-preserving limiter, a practical technique to enforce physical constraints in your numerical solution .",
            "id": "3305901",
            "problem": "Consider the one-dimensional reaction–diffusion Partial Differential Equation (PDE) for a scalar concentration field $c(x,t)$ on a finite interval $x \\in [0,\\ell]$ with homogeneous Dirichlet boundary conditions $c(0,t)=0$ and $c(\\ell,t)=0$, and a positive initial condition $c(x,0)0$ for $x \\in (0,\\ell)$. The governing PDE is\n$$\n\\frac{\\partial c}{\\partial t} = D \\frac{\\partial^2 c}{\\partial x^2} - k c,\n$$\nwhere $D0$ is the diffusion coefficient (in $\\mathrm{m}^2/\\mathrm{s}$) and $k0$ is the reaction rate (in $\\mathrm{s}^{-1}$). Discretize space using $N$ interior points with uniform grid spacing $\\Delta x = \\ell/(N+1)$, and approximate the Laplacian using the standard second-order central difference. Denote the resulting semi-discrete system by\n$$\n\\frac{d \\mathbf{c}}{dt} = L \\mathbf{c}, \\quad L = \\frac{D}{\\Delta x^2} A - k I,\n$$\nwhere $I$ is the identity matrix of size $N \\times N$ and $A$ is the tridiagonal matrix with diagonal entries $-2$ and off-diagonal entries $1$.\n\nTime integration is to be performed from time $t=0$ to $t=\\Delta t$ using three schemes:\n- Crank–Nicolson (CN), defined as the special case of the $\\theta$-method with $\\theta = 1/2$, which is the trapezoidal rule applied to the semi-discrete system. Crank–Nicolson (CN) is A-stable but not L-stable.\n- A generic $\\theta$-scheme with $\\theta1/2$, specifically choose $\\theta=0.7$ for implementation.\n- A positivity-preserving variant obtained by convex limiting: blend the CN update with the Backward Euler (BE) update (which corresponds to the $\\theta$-scheme with $\\theta=1$) using a convex combination that enforces nonnegativity in all components.\n\nYour tasks are:\n1. Starting from the semi-discrete linear Ordinary Differential Equation (ODE) $\\frac{d \\mathbf{c}}{dt} = L \\mathbf{c}$ with $L$ as above, analyze the modal amplification of the CN scheme by considering the action on an eigenvector of $L$. Derive conditions, in terms of the most negative eigenvalue of $L$ and the timestep $\\Delta t$, under which the CN scheme can produce negative concentrations after a single time step even when $\\mathbf{c}(0)$ is nonnegative. Your analysis must begin from the semi-discrete linear system and legitimate mode analysis; do not assume any target formulas.\n2. Construct a positivity-preserving variant via convex limiting as follows: compute $\\mathbf{c}_{\\mathrm{CN}}^{1}$ by CN and $\\mathbf{c}_{\\mathrm{BE}}^{1}$ by BE, then choose a scalar $\\alpha \\in [0,1]$ to define the limited update $\\mathbf{c}_{\\mathrm{lim}}^{1} = \\alpha \\mathbf{c}_{\\mathrm{CN}}^{1} + (1-\\alpha)\\mathbf{c}_{\\mathrm{BE}}^{1}$ such that all components of $\\mathbf{c}_{\\mathrm{lim}}^{1}$ are nonnegative. Describe how to select $\\alpha$ purely from the two candidate updates to enforce nonnegativity componentwise.\n3. Implement the three schemes and the convex limiting in a complete, runnable program. Use the following scientifically consistent parameters and initial condition:\n   - Domain length $\\ell = 1$ $\\mathrm{m}$.\n   - Number of interior points $N=50$.\n   - Diffusion coefficient $D=10^{-3}$ $\\mathrm{m}^2/\\mathrm{s}$.\n   - Reaction rate $k=10^{4}$ $\\mathrm{s}^{-1}$.\n   - Initial condition $c(x,0)=\\sin(\\pi x)$ in $\\mathrm{mol}/\\mathrm{m}^3$ sampled at the interior grid points $x_i = i \\Delta x$ for $i=1,\\dots,N$.\n   - Timestep values $\\Delta t \\in \\{10^{-6}, 1.5\\times 10^{-4}, 1.998\\times 10^{-4}, 3.0\\times 10^{-4}\\}$ $\\mathrm{s}$.\n   - The $\\theta$-scheme parameter is fixed at $\\theta=0.7$.\n4. For each test case (each value of $\\Delta t$), compute a single step from $t=0$ to $t=\\Delta t$ using CN, the $\\theta$-scheme with $\\theta=0.7$, and the convex-limited variant. For each, determine whether any component of the updated concentration is negative. Also compute a theoretical indicator of CN negativity using your mode analysis from Task $1$: evaluate the sign of the CN amplification factor for the most negative eigenvalue of $L$ and report whether that factor is negative.\n5. Physical units: the concentration is in $\\mathrm{mol}/\\mathrm{m}^3$, space in $\\mathrm{m}$, time in $\\mathrm{s}$. Results to be reported are booleans, which are unitless.\n6. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each test case result must be a list of four booleans in the order $[\\text{CN\\_negative}, \\text{$\\theta$-negative}, \\text{limited\\_negative}, \\text{CN\\_predicted\\_negative}]$. For example, the output format is $[[b_{11},b_{12},b_{13},b_{14}], [b_{21},b_{22},b_{23},b_{24}], [b_{31},b_{32},b_{33},b_{34}], [b_{41},b_{42},b_{43},b_{44}]]$, where each $b_{ij}$ is either $\\mathrm{True}$ or $\\mathrm{False}$.\n\nThe test suite is the set of timesteps $\\Delta t \\in \\{10^{-6}, 1.5\\times 10^{-4}, 1.998\\times 10^{-4}, 3.0\\times 10^{-4}\\}$ $\\mathrm{s}$ with the fixed parameters above. The final output must be a single printed line exactly matching the specified format.",
            "solution": "The user-provided problem is assessed as valid. It is scientifically grounded in the principles of numerical analysis for partial differential equations, is well-posed with a complete and consistent set of data and constraints, and is expressed in objective, formal language. The tasks are substantive and address a core issue in computational methods: the loss of physical properties like positivity in numerical schemes. We now proceed with the solution.\n\nThe problem requires the analysis and implementation of numerical schemes for the one-dimensional reaction–diffusion equation:\n$$\n\\frac{\\partial c}{\\partial t} = D \\frac{\\partial^2 c}{\\partial x^2} - k c\n$$\non a domain $x \\in [0, \\ell]$ with homogeneous Dirichlet boundary conditions. Spatial discretization with a standard second-order central difference on a uniform grid of $N$ interior points leads to the semi-discrete system of ordinary differential equations (ODEs):\n$$\n\\frac{d \\mathbf{c}}{dt} = L \\mathbf{c}, \\quad \\text{where} \\quad L = \\frac{D}{\\Delta x^2} A - k I\n$$\nHere, $\\mathbf{c}(t)$ is the vector of concentrations at the interior grid points, $I$ is the $N \\times N$ identity matrix, and $A$ is the $N \\times N$ tridiagonal matrix with entries of $-2$ on the main diagonal and $1$ on the sub- and super-diagonals.\n\n### Task 1: Analysis of Crank–Nicolson Negativity\n\nWe analyze the behavior of time-stepping schemes by applying them to the linear system $\\frac{d\\mathbf{c}}{dt} = L\\mathbf{c}$. A general one-step $\\theta$-scheme is given by:\n$$\n\\frac{\\mathbf{c}^{n+1} - \\mathbf{c}^n}{\\Delta t} = (1-\\theta) L \\mathbf{c}^n + \\theta L \\mathbf{c}^{n+1}\n$$\nwhere $\\mathbf{c}^n$ is the numerical solution at time $t_n = n \\Delta t$. Rearranging to solve for the solution at the next time step, $\\mathbf{c}^{n+1}$, yields:\n$$\n(I - \\theta \\Delta t L) \\mathbf{c}^{n+1} = (I + (1-\\theta) \\Delta t L) \\mathbf{c}^n\n$$\n$$\n\\mathbf{c}^{n+1} = (I - \\theta \\Delta t L)^{-1} (I + (1-\\theta) \\Delta t L) \\mathbf{c}^n\n$$\nThe Crank–Nicolson (CN) scheme is the specific case where $\\theta = 1/2$.\n\nTo analyze the stability and positivity of the scheme, we consider its action on the eigenvectors of the system matrix $L$. Let $\\mathbf{v}_j$ be an eigenvector of $L$ with corresponding eigenvalue $\\lambda_j$. Since $L$ is a real symmetric matrix, its eigenvalues are real. The eigenvalues of the matrix $A$ are known to be $\\mu_j = -4 \\sin^2\\left(\\frac{j\\pi}{2(N+1)}\\right)$ for $j=1, \\dots, N$. The eigenvalues of $L$ are therefore:\n$$\n\\lambda_j = \\frac{D}{\\Delta x^2} \\mu_j - k = -\\frac{4D}{\\Delta x^2} \\sin^2\\left(\\frac{j\\pi}{2(N+1)}\\right) - k\n$$\nSince $D0$ and $k0$, all eigenvalues $\\lambda_j$ are real and strictly negative. If we consider an initial condition that is a single mode, $\\mathbf{c}^0 = \\mathbf{v}_j$, the solution after one time step is:\n$$\n\\mathbf{c}^1 = (I - \\theta \\Delta t L)^{-1} (I + (1-\\theta) \\Delta t L) \\mathbf{v}_j = \\frac{1 + (1-\\theta) \\lambda_j \\Delta t}{1 - \\theta \\lambda_j \\Delta t} \\mathbf{v}_j\n$$\nThe scalar term is the modal amplification factor, $g(\\lambda_j, \\Delta t, \\theta)$. For the CN scheme ($\\theta = 1/2$), this becomes:\n$$\ng_{\\mathrm{CN}}(\\lambda_j, \\Delta t) = \\frac{1 + \\lambda_j \\Delta t / 2}{1 - \\lambda_j \\Delta t / 2}\n$$\nFor A-stability, we require $|g| \\le 1$ for all $\\text{Re}(\\lambda_j) \\le 0$. Since our $\\lambda_j$ are real and negative, $|g_{\\mathrm{CN}}|=1$, so the scheme is A-stable. However, positivity is not guaranteed. If the initial condition $\\mathbf{c}^0$ is a non-negative vector, the solution $\\mathbf{c}^1$ can have negative components if any of the amplification factors for the modes present in $\\mathbf{c}^0$ are negative. The amplification factor $g_{\\mathrm{CN}}(\\lambda_j, \\Delta t)$ becomes negative when its numerator is negative (as the denominator is always positive for $\\lambda_j  0$):\n$$\n1 + \\frac{\\lambda_j \\Delta t}{2}  0 \\implies \\lambda_j \\Delta t  -2\n$$\nUnphysical oscillations and negativity are most often triggered by the mode corresponding to the most negative eigenvalue, $\\lambda_{\\min}$. This occurs for $j=N$:\n$$\n\\lambda_{\\min} = \\lambda_N = -\\frac{4D}{\\Delta x^2} \\sin^2\\left(\\frac{N\\pi}{2(N+1)}\\right) - k\n$$\nTherefore, the theoretical condition under which the CN scheme is expected to produce negativity for a general non-negative initial condition is when the timestep $\\Delta t$ is large enough such that $\\lambda_{\\min} \\Delta t  -2$.\n\n### Task 2: Positivity-Preserving Convex Limiting\n\nThe goal is to construct a positivity-preserving scheme by blending the CN solution with a known positive scheme. The Backward Euler (BE) method, which corresponds to $\\theta=1$, is such a scheme. Its amplification factor is $g_{\\mathrm{BE}}(\\lambda_j, \\Delta t) = (1 - \\lambda_j \\Delta t)^{-1}$, which is always between $0$ and $1$ for any $\\lambda_j  0$. Thus, if the initial state $\\mathbf{c}^0$ is non-negative, the BE update, $\\mathbf{c}_{\\mathrm{BE}}^{1} = (I - \\Delta t L)^{-1} \\mathbf{c}^0$, is also guaranteed to be non-negative.\n\nWe define a limited solution $\\mathbf{c}_{\\mathrm{lim}}^{1}$ as a convex combination of the CN and BE solutions:\n$$\n\\mathbf{c}_{\\mathrm{lim}}^{1} = \\alpha \\mathbf{c}_{\\mathrm{CN}}^{1} + (1-\\alpha) \\mathbf{c}_{\\mathrm{BE}}^{1}\n$$\nwith a scalar limiter $\\alpha \\in [0, 1]$. We must select $\\alpha$ to ensure that every component $(\\mathbf{c}_{\\mathrm{lim}}^{1})_i$ is non-negative. For each component $i$, we require:\n$$\n\\alpha (\\mathbf{c}_{\\mathrm{CN}}^{1})_i + (1-\\alpha) (\\mathbf{c}_{\\mathrm{BE}}^{1})_i \\ge 0\n$$\nIf $(\\mathbf{c}_{\\mathrm{CN}}^{1})_i \\ge 0$, this inequality holds for any $\\alpha \\in [0, 1]$ since $(\\mathbf{c}_{\\mathrm{BE}}^{1})_i \\ge 0$. The constraint is only active for components where the CN solution is negative, i.e., $(\\mathbf{c}_{\\mathrm{CN}}^{1})_i  0$. For these components, we rearrange the inequality to solve for an upper bound on $\\alpha$:\n$$\n\\alpha [(\\mathbf{c}_{\\mathrm{CN}}^{1})_i - (\\mathbf{c}_{\\mathrm{BE}}^{1})_i] \\ge -(\\mathbf{c}_{\\mathrm{BE}}^{1})_i\n$$\nSince $(\\mathbf{c}_{\\mathrm{CN}}^{1})_i  0$ and $(\\mathbf{c}_{\\mathrm{BE}}^{1})_i \\ge 0$, the term in brackets is negative. Dividing by it reverses the inequality sign:\n$$\n\\alpha \\le \\frac{-(\\mathbf{c}_{\\mathrm{BE}}^{1})_i}{(\\mathbf{c}_{\\mathrm{CN}}^{1})_i - (\\mathbf{c}_{\\mathrm{BE}}^{1})_i} = \\frac{(\\mathbf{c}_{\\mathrm{BE}}^{1})_i}{(\\mathbf{c}_{\\mathrm{BE}}^{1})_i - (\\mathbf{c}_{\\mathrm{CN}}^{1})_i}\n$$\nTo ensure positivity for all components simultaneously, $\\alpha$ must be less than or equal to the minimum of these ratios over all components $i$ where $(\\mathbf{c}_{\\mathrm{CN}}^{1})_i  0$. Thus, the optimal (largest) $\\alpha$ that guarantees positivity is:\n$$\n\\alpha = \\min \\left(1, \\min_{i \\text{ s.t. } (\\mathbf{c}_{\\mathrm{CN}}^{1})_i  0} \\left\\{ \\frac{(\\mathbf{c}_{\\mathrm{BE}}^{1})_i}{(\\mathbf{c}_{\\mathrm{BE}}^{1})_i - (\\mathbf{c}_{\\mathrm{CN}}^{1})_i} \\right\\} \\right)\n$$\nIf the CN solution is already non-negative, the set of indices is empty, the inner minimum is effectively infinite, and $\\alpha$ becomes $\\min(1, \\infty) = 1$, correctly recovering the pure CN solution.\n\n### Task 3  4: Implementation and Computation\n\nThe three schemes (CN, $\\theta=0.7$, and convex-limited) are implemented using the provided parameters: $\\ell = 1 \\, \\mathrm{m}$, $N=50$, $D=10^{-3} \\, \\mathrm{m}^2/\\mathrm{s}$, $k=10^4 \\, \\mathrm{s}^{-1}$. The initial condition is $\\mathbf{c}(0)_i = \\sin(\\pi x_i)$. For each time step $\\Delta t$ in the test suite, we compute one step of each scheme. Each update requires solving a linear system of the form $(I - \\theta \\Delta t L)\\mathbf{c}^{1} = \\mathbf{b}$. Since the matrix on the left-hand side is tridiagonal, an efficient banded solver is used. The theoretical prediction for CN negativity is evaluated by calculating $\\lambda_{\\min}$ and checking if the condition $\\lambda_{\\min} \\Delta t  -2$ is met. The negativity of the computed solutions is found by checking if any vector component is less than zero. These boolean results are then compiled for the final output.",
            "answer": "```python\nimport numpy as np\nfrom scipy.linalg import solve_banded\n\ndef solve():\n    \"\"\"\n    Solves the reaction-diffusion problem with three numerical schemes\n    and reports on their positivity for a range of timesteps.\n    \"\"\"\n    \n    # Task 3: Define parameters and initial condition\n    l_domain = 1.0  # m\n    N = 50          # Number of interior points\n    D = 1e-3        # m^2/s\n    k = 1e4         # s^-1\n    theta_generic = 0.7\n    \n    delta_x = l_domain / (N + 1)\n    \n    # Construct the semi-discrete system matrix L\n    # L = (D/dx^2)A - kI\n    # A is tridiagonal with [-2, 1, 1]\n    diag_A = -2.0 * np.ones(N)\n    off_diag_A = np.ones(N - 1)\n    \n    A_mat = np.diag(diag_A) + np.diag(off_diag_A, k=1) + np.diag(off_diag_A, k=-1)\n    L_mat = (D / delta_x**2) * A_mat - k * np.identity(N)\n    \n    # Initial condition c(x,0) = sin(pi*x)\n    x = np.linspace(delta_x, l_domain - delta_x, N)\n    c0 = np.sin(np.pi * x)\n\n    # Timestep values for the test cases\n    test_cases_dt = [1.0e-6, 1.5e-4, 1.998e-4, 3.0e-4]\n    \n    # Task 4: Compute results for each test case\n    results = []\n\n    # Theoretical prediction: CN negativity condition\n    # lambda_min * dt  -2\n    # lambda_min corresponds to j=N for the eigenvalues of L\n    lambda_min = (-4 * D / delta_x**2) * np.sin(N * np.pi / (2 * (N + 1)))**2 - k\n\n    for dt in test_cases_dt:\n        # Theoretical prediction for CN negativity\n        cn_predicted_negative = bool(lambda_min * dt  -2.0)\n\n        # --- Numerical schemes ---\n        \n        def solve_theta_scheme(theta, current_dt, L, c_initial):\n            \"\"\"\n            Solves one step of the theta-scheme.\n            (I - theta*dt*L) c_next = (I + (1-theta)*dt*L) c_initial\n            \"\"\"\n            # Construct the RHS vector\n            rhs_matrix = np.identity(N) + (1.0 - theta) * current_dt * L\n            rhs_vector = rhs_matrix @ c_initial\n            \n            # Construct the LHS matrix in banded form for solve_banded\n            # LHS = I - theta*dt*L\n            # L = (D/dx^2)A - kI  = LHS = (1+theta*dt*k)I - theta*dt*(D/dx^2)A\n            f = D / delta_x**2\n            \n            # Main diagonal of LHS matrix\n            diag_LHS = 1.0 + theta * current_dt * k + 2.0 * theta * current_dt * f\n            \n            # Off-diagonals of LHS matrix\n            off_diag_LHS = -theta * current_dt * f\n            \n            # Scipy solve_banded expects matrix `ab` where rows are diagonals\n            # ab[0,:] = super-diagonal (u)\n            # ab[1,:] = main-diagonal (d)\n            # ab[2,:] = sub-diagonal (l)\n            ab = np.zeros((3, N))\n            ab[0, 1:] = off_diag_LHS\n            ab[1, :] = diag_LHS\n            ab[2, :-1] = off_diag_LHS\n            \n            return solve_banded((1, 1), ab, rhs_vector)\n\n        # Crank-Nicolson solution (theta=0.5)\n        c_cn = solve_theta_scheme(0.5, dt, L_mat, c0)\n        cn_negative = bool(np.any(c_cn  0))\n\n        # Generic theta-scheme solution (theta=0.7)\n        c_theta = solve_theta_scheme(theta_generic, dt, L_mat, c0)\n        theta_negative = bool(np.any(c_theta  0))\n        \n        # Convex-limited solution\n        # First, get the Backward Euler solution (theta=1.0)\n        c_be = solve_theta_scheme(1.0, dt, L_mat, c0)\n\n        # Find indices where CN solution is negative\n        neg_indices = np.where(c_cn  0)[0]\n        \n        if neg_indices.size > 0:\n            c_cn_neg = c_cn[neg_indices]\n            c_be_neg = c_be[neg_indices]\n            \n            # Calculate alpha limiter\n            # Note: c_cn_neg is negative, c_be_neg is non-negative\n            alpha_candidates = c_be_neg / (c_be_neg - c_cn_neg)\n            alpha = np.min(alpha_candidates)\n        else:\n            alpha = 1.0\n\n        # Form the limited solution\n        c_lim = alpha * c_cn + (1.0 - alpha) * c_be\n        # By construction, this should be non-negative. Check for small numerical errors.\n        limited_negative = bool(np.any(c_lim  -1e-15))\n        \n        results.append([cn_negative, theta_negative, limited_negative, cn_predicted_negative])\n\n    # Final print statement in the exact required format.\n    print(str(results).replace(\" \", \"\"))\n\nsolve()\n```"
        }
    ]
}