{
    "hands_on_practices": [
        {
            "introduction": "Crank-Nicolson方法因其二阶时间精度而备受推崇。在计算科学中，一项基本技能不仅是应用一种方法，还要能够验证其理论属性并量化其误差。本练习将通过理查森外推法（Richardson extrapolation）提供动手实践，这是一种强大的技术，可以利用不同时间步长得到的数值结果来估计离散误差。",
            "id": "3305869",
            "problem": "考虑一个无源无量纲标量的一维瞬态扩散，其单个傅里叶模态幅值根据线性常微分方程 $\\,\\frac{d u}{d t} = \\lambda\\, u\\,$ 演化，其中常数 $\\lambda = -3$。假设空间已被充分解析，因此时间积分误差占主导地位，并且时间推进采用 Crank-Nicolson (CN) 积分方法。设初始条件为 $\\,u(0) = 1\\,$，目标时间为 $\\,T = 2\\,\\Delta t\\,$，其中 $\\Delta t = 0.1$。\n\n一个生产级别的计算流体力学 (CFD) 代码报告了在时间 $\\,T\\,$ 时的以下两个 CN 近似值：\n- 两个大小为 $\\,\\Delta t\\,$ 的 CN 步长得到 $\\,u_{\\Delta t}^{(2)} = \\frac{289}{529}\\,$。\n- 一个大小为 $\\,2\\,\\Delta t\\,$ 的 CN 步长得到 $\\,u_{2\\Delta t}^{(1)} = \\frac{7}{13}\\,$。\n\n将在时间 $\\,T\\,$ 处，两步 CN 近似的时间离散误差大小定义为 $\\,|E_{\\Delta t}| = |u_{\\Delta t}^{(2)} - u(T)|\\,$。基于 CN 的全局二阶精度，使用理查森外推法，从上述两个近似值中估计 $\\,|E_{\\Delta t}|\\,$，然后通过确定 $\\,|E(\\Delta t)| \\approx K\\,\\Delta t^{2}\\,$ 中的比例常数 $\\,K > 0\\,$ 来指定二阶标度律。将最终答案表示为一个行矩阵 $\\,(|E_{\\Delta t}| \\text{ and } K)\\,$，两者均使用精确值（不要四舍五入），并注意所有量均为无量纲。",
            "solution": "该问题要求估计 Crank-Nicolson (CN) 格式的时间离散误差，并使用理查森外推法确定误差标度常数。\n\n控制常微分方程 (ODE) 由下式给出：\n$$\n\\frac{d u}{d t} = \\lambda u\n$$\n其中系数为常数 $\\lambda = -3$，初始条件为 $u(0) = 1$。\n\nCrank-Nicolson 方法是一种隐式的二阶精度时间积分格式。将其应用于给定的 ODE，在时间间隔 $\\Delta t$ 内从时间步 $n$ 到 $n+1$ 的更新为：\n$$\n\\frac{u^{n+1} - u^n}{\\Delta t} = \\frac{\\lambda}{2} (u^{n+1} + u^n)\n$$\n这是一种单步法。问题提供了在目标时间 $T = 2 \\Delta t = 2(0.1) = 0.2$ 处解的两个数值近似。\n\n令 $u_h$ 表示使用均匀步长 $h$ 在时间 $T$ 得到的数值解。由于 CN 方法具有 2 阶全局误差，数值解可以通过误差展开与精确解 $u(T)$ 相关联：\n$$\nu_h = u(T) + C h^2 + \\mathcal{O}(h^4)\n$$\n其中 $C$ 是一个取决于 ODE 和解的导数的常数，但与步长 $h$ 无关。\n\n我们得到了在 $T = 0.2$ 时的两个近似值：\n1.  一个粗略近似值 $u_{2\\Delta t}^{(1)}$，使用一步大小为 $h_1 = 2 \\Delta t = 0.2$ 的步长获得。\n2.  一个精细近似值 $u_{\\Delta t}^{(2)}$，使用两步大小为 $h_2 = \\Delta t = 0.1$ 的步长获得。\n\n对每种情况使用误差展开：\n对于粗略步长 ($h_1 = 2 \\Delta t$)：\n$$\nu_{2\\Delta t}^{(1)} = u(T) + C (2 \\Delta t)^2 + \\mathcal{O}(\\Delta t^4) = u(T) + 4C (\\Delta t)^2 + \\mathcal{O}(\\Delta t^4) \\quad (1)\n$$\n对于精细步长 ($h_2 = \\Delta t$)：\n$$\nu_{\\Delta t}^{(2)} = u(T) + C (\\Delta t)^2 + \\mathcal{O}(\\Delta t^4) \\quad (2)\n$$\n\n两步（精细）近似的时间离散误差定义为 $E_{\\Delta t} = u_{\\Delta t}^{(2)} - u(T)$。从方程 $(2)$ 中，我们看到该误差的主阶项是 $C (\\Delta t)^2$。理查森外推法允许我们使用两个可用的数值解来估计这个误差项。\n\n从方程 $(2)$ 中减去方程 $(1)$：\n$$\nu_{\\Delta t}^{(2)} - u_{2\\Delta t}^{(1)} = \\left(u(T) + C(\\Delta t)^2\\right) - \\left(u(T) + 4C(\\Delta t)^2\\right) + \\mathcal{O}(\\Delta t^4)\n$$\n$$\nu_{\\Delta t}^{(2)} - u_{2\\Delta t}^{(1)} = -3C(\\Delta t)^2 + \\mathcal{O}(\\Delta t^4)\n$$\n通过忽略高阶项 $\\mathcal{O}(\\Delta t^4)$，我们可以求解主误差项 $C(\\Delta t)^2$ 的估计值：\n$$\nC(\\Delta t)^2 \\approx -\\frac{1}{3} \\left( u_{\\Delta t}^{(2)} - u_{2\\Delta t}^{(1)} \\right) = \\frac{1}{3} \\left( u_{2\\Delta t}^{(1)} - u_{\\Delta t}^{(2)} \\right)\n$$\n该表达式是精细网格解误差的理查森估计值，$E_{\\Delta t, \\text{est}}$。\n$$\nE_{\\Delta t, \\text{est}} = \\frac{1}{3} \\left( u_{2\\Delta t}^{(1)} - u_{\\Delta t}^{(2)} \\right)\n$$\n问题要求估计误差大小 $|E_{\\Delta t}| = |u_{\\Delta t}^{(2)} - u(T)|$。我们将使用 $|E_{\\Delta t, \\text{est}}|$ 作为该估计值。\n\n让我们代入给定的数值：\n$u_{\\Delta t}^{(2)} = \\frac{289}{529}$\n$u_{2\\Delta t}^{(1)} = \\frac{7}{13}$\n\n差值为：\n$$\nu_{2\\Delta t}^{(1)} - u_{\\Delta t}^{(2)} = \\frac{7}{13} - \\frac{289}{529}\n$$\n公分母是 $13 \\times 529$。注意 $529 = 23^2$。\n$$\nu_{2\\Delta t}^{(1)} - u_{\\Delta t}^{(2)} = \\frac{7 \\times 529 - 289 \\times 13}{13 \\times 529} = \\frac{3703 - 3757}{6877} = -\\frac{54}{6877}\n$$\n现在，我们计算估计误差 $E_{\\Delta t, \\text{est}}$：\n$$\nE_{\\Delta t, \\text{est}} = \\frac{1}{3} \\left( -\\frac{54}{6877} \\right) = -\\frac{18}{6877}\n$$\n因此，估计的误差大小为：\n$$\n|E_{\\Delta t}| = |E_{\\Delta t, \\text{est}}| = \\left|-\\frac{18}{6877}\\right| = \\frac{18}{6877}\n$$\n这是答案的第一部分。\n\n接下来，我们必须确定二阶标度律 $|E(\\Delta t)| \\approx K (\\Delta t)^2$ 中的比例常数 $K  0$。我们使用在特定步长 $\\Delta t = 0.1$ 处我们估计的误差大小 $|E(\\Delta t)|$：\n$$\n|E(\\Delta t = 0.1)| \\approx \\frac{18}{6877}\n$$\n将此代入标度律：\n$$\n\\frac{18}{6877} = K (\\Delta t)^2 = K (0.1)^2 = K \\left(\\frac{1}{10}\\right)^2 = K \\left(\\frac{1}{100}\\right)\n$$\n求解 $K$：\n$$\nK = 100 \\times \\frac{18}{6877} = \\frac{1800}{6877}\n$$\n这是答案的第二部分。\n\n最终答案是行矩阵 $(|E_{\\Delta t}|, K)$。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{18}{6877}  \\frac{1800}{6877}\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "尽管Crank-Nicolson格式对于线性问题是无条件稳定的，但这种稳定性并不能保证物理行为的正确性，尤其是在以对流为主的流动中。本实践旨在探究CN格式与中心差分空间离散相结合时的非单调性，这是在陡峭梯度附近产生非物理振荡的常见原因。通过这个编程练习，您将以数值方式生成并量化这些吉布斯（Gibbs）类现象，从而对该方法的色散误差有重要的理解。",
            "id": "3305885",
            "problem": "考虑一维线性平流方程，它是计算流体力学中一个典型的守恒律，其形式为 $u_t + a\\,u_x = 0$，定义在长度为 $L$ 的周期性域上，具有恒定的平流速度 $a$。任务是研究 Crank-Nicolson (CN) 时间积分方法与中心空间离散化相结合用于纯平流问题时的单调性。从守恒律出发，通过中心差分构建一个半离散系统，从第一性原理推导 Crank-Nicolson 时间步进格式，并以忠实于均匀网格上周期性边界条件下底层算子的方式实现它。然后，使用一个不连续的阶跃初始条件，数值上展示类吉布斯振荡并量化对单调性的破坏。\n\n您必须遵守以下规范：\n\n- 域和单位：\n  - 使用周期性空间域 $[0,L)$，其中 $L = 1$，单位为米 (m)。\n  - 使用 $a = 1$，单位为米/秒 (m/s)。\n  - 空间网格由 $N$ 个均匀分布的点组成，因此网格间距为 $\\Delta x = L/N$，单位为米 (m)。\n  - 时间步长为 $\\Delta t$，单位为秒 (s)，通过 Courant–Friedrichs–Lewy (CFL) 数选择，即 $\\Delta t = (\\text{CFL})\\,\\Delta x/a$。\n- 离散化要求：\n  - 在具有周期性边界条件的均匀网格上，使用二阶中心差分来离散化 $u_x$。\n  - 为得到的半离散系统推导并实现 Crank-Nicolson (CN) 时间积分方法。不要依赖任何迎风格式或人工耗散。\n- 初始条件：\n  - 使用在网格上定义的不连续阶跃函数 $u(x,0)$，对于索引 $j$ 使得 $x_j \\in [0,L/2)$，有 $u_j(0) = 1$，否则 $u_j(0) = 0$，并采用周期性边界条件。这个选择在 $x=0$ 和 $x=L/2$ 处各产生一个间断点。\n- 在将解推进指定数量的时间步后，需要计算的量：\n  - 超出上界 $1$ 的过冲幅度，定义为 $\\max\\{0, \\max_j u_j - 1\\}$ (无量纲)。\n  - 低于下界 $0$ 的下冲幅度，定义为 $\\max\\{0, 0 - \\min_j u_j\\}$ (无量纲)。\n  - 离散全变分 $TV(u)$，定义为 $TV(u) = \\sum_{j=0}^{N-1} |u_{j+1} - u_j|$，其中采用周期性环绕，使得 $u_N \\equiv u_0$ (无量纲)。\n- 科学真实性：\n  - 用于纯平流的中心格式是非耗散的，而 Crank-Nicolson 时间积分器对于线性斜伴随算子是能量守恒的，这两者结合在一起会在间断点附近产生色散振荡。你的程序必须使用上述指标来量化这些振荡。\n- 测试套件：\n  - 使用以下四个参数集来测试不同情况：\n    - 情况 $1$: $(N, \\text{CFL}, \\text{steps}) = (128, 0.5, 64)$。\n    - 情况 $2$: $(N, \\text{CFL}, \\text{steps}) = (128, 0.9, 64)$。\n    - 情况 $3$: $(N, \\text{CFL}, \\text{steps}) = (32, 0.5, 32)$。\n    - 情况 $4$: $(N, \\text{CFL}, \\text{steps}) = (128, 0.1, 320)$。\n- 输出规格：\n  - 对每个测试用例，计算包含三个浮点数 $[\\text{过冲}, \\text{下冲}, TV]$ 的列表 (无量纲)。\n  - 你的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表。四个测试用例的结果应按顺序汇总成一个列表的列表，例如 $[[r_{11},r_{12},r_{13}],[r_{21},r_{22},r_{23}],[r_{31},r_{32},r_{33}],[r_{41},r_{42},r_{43}]]$，其中每个 $r_{ij}$ 都是一个浮点数。所有输出都以小数形式表示，不带任何单位符号或百分号。\n\n你的实现必须是自包含的，并且不应接受任何用户输入。所有计算必须使用指定的单位进行，输出如前述为无量纲。目标是通过阶跃初始条件和上面定义的指标，明确地展示和量化 Crank-Nicolson 方法与中心差分结合用于纯平流时的非单调行为。",
            "solution": "用户提供了一个来自计算流体力学领域的有效且适定的问题陈述。任务是分析 Crank-Nicolson (CN) 时间积分格式与中心空间差分相结合用于线性平流方程时的非单调性质。我们将首先从基本原理推导数值格式，然后实现它以量化预期的类吉布斯振荡。\n\n控制方程是一维线性平流方程：\n$$\n\\frac{\\partial u}{\\partial t} + a \\frac{\\partial u}{\\partial x} = 0\n$$\n该方程定义在一个周期性空间域 $[0, L)$ 上，具有恒定的平流速度 $a$。问题指定了 $L=1\\,\\text{m}$ 和 $a=1\\,\\text{m/s}$。\n\n首先，我们在空间上进行半离散化。区域被离散化为 $N$ 个均匀分布的点 $x_j = j \\Delta x$，其中 $j=0, 1, \\dots, N-1$，网格间距为 $\\Delta x = L/N$。在这些点上的解用向量 $\\mathbf{u}(t) = [u_0(t), u_1(t), \\dots, u_{N-1}(t)]^T$ 表示，其中 $u_j(t) \\approx u(x_j, t)$。在网格点 $x_j$ 处的空间导数 $\\partial u/\\partial x$ 使用二阶精度的中心差分格式来近似：\n$$\n\\left. \\frac{\\partial u}{\\partial x} \\right|_{x_j} \\approx \\frac{u_{j+1}(t) - u_{j-1}(t)}{2 \\Delta x}\n$$\n由于周期性边界条件，我们有 $u_N \\equiv u_0$ 和 $u_{-1} \\equiv u_{N-1}$。将此近似代入平流方程，得到一个常微分方程组 (ODEs)：\n$$\n\\frac{d u_j}{dt} = -a \\frac{u_{j+1} - u_{j-1}}{2 \\Delta x}\n$$\n这可以表示为矩阵形式 $\\frac{d\\mathbf{u}}{dt} = \\mathbf{A}\\mathbf{u}$。矩阵 $\\mathbf{A}$ 代表离散空间算子 $-a (\\cdot)_x$。它是一个 $N \\times N$ 的循环和斜对称矩阵：\n$$\n\\mathbf{A} = -\\frac{a}{2 \\Delta x}\n\\begin{pmatrix}\n0  1  0  \\dots  0  -1 \\\\\n-1  0  1  \\dots  0  0 \\\\\n0  -1  0  \\dots  0  0 \\\\\n\\vdots  \\vdots  \\ddots  \\ddots  \\ddots  \\vdots \\\\\n0  0  0  \\dots  0  1 \\\\\n1  0  0  \\dots  -1  0\n\\end{pmatrix}\n$$\n斜对称性 ($\\mathbf{A}^T = -\\mathbf{A}$) 是周期域上连续导数算子 $\\partial/\\partial x$ 的斜伴随性质的离散模拟。这个性质确保了半离散系统守恒离散 $L_2$ 范数，即 $\\frac{d}{dt} ||\\mathbf{u}||_2^2 = 0$。\n\n接下来，我们使用 Crank-Nicolson 方法离散化时间导数。这个方法是隐式的，并且在时间上是二阶精度的。将其应用于半离散系统 $\\frac{d\\mathbf{u}}{dt} = \\mathbf{A}\\mathbf{u}$，从时间 $t^n$ 到 $t^{n+1} = t^n + \\Delta t$，我们得到：\n$$\n\\frac{\\mathbf{u}^{n+1} - \\mathbf{u}^n}{\\Delta t} = \\frac{1}{2} \\left( \\mathbf{A}\\mathbf{u}^n + \\mathbf{A}\\mathbf{u}^{n+1} \\right)\n$$\n其中 $\\mathbf{u}^n$ 是在时间步 $n$ 的数值解。为了求解 $\\mathbf{u}^{n+1}$，我们重新整理各项：\n$$\n\\mathbf{u}^{n+1} - \\frac{\\Delta t}{2} \\mathbf{A}\\mathbf{u}^{n+1} = \\mathbf{u}^n + \\frac{\\Delta t}{2} \\mathbf{A}\\mathbf{u}^n\n$$\n这就得到了在每个时间步需要求解的线性系统：\n$$\n\\left( \\mathbf{I} - \\frac{\\Delta t}{2} \\mathbf{A} \\right) \\mathbf{u}^{n+1} = \\left( \\mathbf{I} + \\frac{\\Delta t}{2} \\mathbf{A} \\right) \\mathbf{u}^n\n$$\n其中 $\\mathbf{I}$ 是单位矩阵。通过矩阵求逆直接求解该系统计算成本会很高。然而，由于 $\\mathbf{A}$ 是一个循环矩阵，左右两边的矩阵也是循环矩阵。循环矩阵可被离散傅里叶变换 (DFT) 对角化，这使得在傅里叶空间中可以进行高效求解。\n\n设 $\\hat{\\mathbf{u}} = \\mathcal{F}(\\mathbf{u})$ 是 $\\mathbf{u}$ 的 DFT。对时间步进方程应用 DFT，将矩阵-向量乘积转换为变换后向量与矩阵特征值的逐元素乘积。对应于离散波数 $k_m = 2\\pi m / L$ (其中 $m$ 是标识傅里叶模式的整数) 的空间算子矩阵 $\\mathbf{A}$ 的特征值是纯虚数：\n$$\n\\lambda_m(\\mathbf{A}) = -i \\frac{a}{\\Delta x} \\sin(k_m \\Delta x)\n$$\n在傅里叶空间中的时间步进方程变为：\n$$\n\\left( 1 - \\frac{\\Delta t}{2} \\lambda_m(\\mathbf{A}) \\right) \\hat{u}_m^{n+1} = \\left( 1 + \\frac{\\Delta t}{2} \\lambda_m(\\mathbf{A}) \\right) \\hat{u}_m^{n}\n$$\n因此，每个傅里叶模式的更新为 $\\hat{u}_m^{n+1} = G(k_m) \\hat{u}_m^{n}$，其中 $G(k_m)$ 是放大因子：\n$$\nG(k_m) = \\frac{1 + \\frac{\\Delta t}{2} \\lambda_m(\\mathbf{A})}{1 - \\frac{\\Delta t}{2} \\lambda_m(\\mathbf{A})} = \\frac{1 - i \\frac{a \\Delta t}{2 \\Delta x} \\sin(k_m \\Delta x)}{1 + i \\frac{a \\Delta t}{2 \\Delta x} \\sin(k_m \\Delta x)}\n$$\n将 Courant 数 (CFL) 定义为 $\\nu = \\frac{a \\Delta t}{\\Delta x}$，放大因子为：\n$$\nG(k_m) = \\frac{1 - i \\frac{\\nu}{2} \\sin(k_m \\Delta x)}{1 + i \\frac{\\nu}{2} \\sin(k_m \\Delta x)}\n$$\n对于所有波数 $k_m$ 和所有实数 $\\nu$，这个复数的模 $|G(k_m)| = 1$。这意味着该格式在 von Neumann 意义下是无条件稳定的，并且它对每个傅里叶模式的能量都是守恒的。然而，这个性质不保证单调性。如果一个格式不引入新的局部极值，那么它是单调的。提供的初始条件是一个值为 $0$ 和 $1$ 的阶跃函数。一个单调格式将确保解在任何时候都保持在 $0$ 和 $1$ 之间。中心差分 Crank-Nicolson 格式是已知的色散格式，这意味着不同的波数以不同的相速度传播，这些相速度不同于真实的平流速度 $a$。这种色散导致尖锐的梯度（例如初始条件中的间断点）产生被称为吉布斯现象的虚假振荡。这些振荡破坏了单调性，导致值大于 $1$ (过冲) 和小于 $0$ (下冲)。\n\n全变分 $TV(u) = \\sum_{j=0}^{N-1} |u_{j+1} - u_j|$ (其中 $u_N=u_0$) 是衡量解中总振荡的一个指标。对于初始阶跃函数，唯一非零的差值出现在两个间断点处 (在 $x=0$ 和 $x=L/2$)，得到初始全变分 $TV(u^0) = |0-1| + |1-0| = 2$。对于求解线性平流方程的单调格式，全变分必须不随时间增加 ($TV(u^{n+1}) \\le TV(u^n)$)。CN 格式产生的振荡将导致全变分增加，从而为其非单调性提供一个定量的度量。\n\n要实现的算法如下：\n1.  初始化网格和阶跃函数初始条件向量 $\\mathbf{u}^0$。\n2.  计算与网格对应的离散波数 $k_m$。\n3.  基于给定的 CFL 数计算放大因子数组 $G(k_m)$。\n4.  计算初始条件的 DFT：$\\hat{\\mathbf{u}}^0 = \\text{FFT}(\\mathbf{u}^0)$。\n5.  为了将解推进总共 `steps` 步，在傅里叶空间中计算最终状态：$\\hat{\\mathbf{u}}^{\\text{final}} = \\hat{\\mathbf{u}}^0 \\cdot G^{\\text{steps}}$。\n6.  计算逆 DFT 以获得物理空间中的最终解：$\\mathbf{u}^{\\text{final}} = \\text{IFFT}(\\hat{\\mathbf{u}}^{\\text{final}})$。\n7.  使用 $\\mathbf{u}^{\\text{final}}$，计算过冲 $\\max\\{0, \\max_j u_j - 1\\}$、下冲 $\\max\\{0, -\\min_j u_j\\}$ 和全变分 $TV(u)$。\n对四个指定的测试用例中的每一个都执行此过程。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the 1D linear advection equation using Crank-Nicolson\n    with centered differences and quantifies non-monotonicity.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (N, CFL, steps)\n        (128, 0.5, 64),\n        (128, 0.9, 64),\n        (32, 0.5, 32),\n        (128, 0.1, 320),\n    ]\n\n    results = []\n    \n    # Constants from the problem statement\n    L = 1.0  # Domain length in meters\n    a = 1.0  # Advection speed in m/s\n\n    for N, cfl, steps in test_cases:\n        # 1. Setup grid and parameters\n        dx = L / N\n        # dt is not explicitly needed for the Fourier method, as CFL is used directly.\n        # dt = cfl * dx / a\n\n        # Create spatial grid\n        x = np.linspace(0, L, N, endpoint=False)\n\n        # 2. Set up initial condition\n        u0 = np.zeros(N)\n        # u(x,0) = 1 for x in [0, L/2)\n        u0[x  L / 2.0] = 1.0\n\n        # 3. Time-stepping in Fourier space\n        \n        # Calculate angular wavenumbers\n        # k = 2 * pi * f, where f are frequencies from fftfreq\n        # fftfreq(n, d) gives sample frequencies in cycles/unit_of_d\n        # Here d=dx, so frequencies are in 1/m.\n        k = 2 * np.pi * np.fft.fftfreq(N, d=dx)\n\n        # Calculate the amplification factor G for Crank-Nicolson\n        # G = (1 - 0.5j * cfl * sin(k*dx)) / (1 + 0.5j * cfl * sin(k*dx))\n        sin_term = np.sin(k * dx)\n        numerator = 1.0 - 0.5j * cfl * sin_term\n        denominator = 1.0 + 0.5j * cfl * sin_term\n        G = numerator / denominator\n\n        # Evolve the solution in Fourier space\n        u0_hat = np.fft.fft(u0)\n        # Evolve for 'steps' time steps\n        u_final_hat = u0_hat * (G ** steps)\n\n        # Transform back to physical space\n        u_final = np.fft.ifft(u_final_hat).real\n\n        # 4. Quantify oscillations and TV\n        \n        # Overshoot amplitude above 1\n        overshoot = max(0.0, np.max(u_final) - 1.0)\n        \n        # Undershoot amplitude below 0\n        undershoot = max(0.0, 0.0 - np.min(u_final))\n        \n        # Discrete total variation TV(u) = sum(|u_{j+1} - u_j|)\n        # np.roll handles the periodic boundary condition u_N = u_0\n        tv = np.sum(np.abs(np.roll(u_final, -1) - u_final))\n        \n        results.append([overshoot, undershoot, tv])\n\n    # Format the output string precisely as required\n    # e.g., [[r11,r12,r13],[r21,r22,r23]] with no spaces\n    inner_results_str = [f\"[{r[0]},{r[1]},{r[2]}]\" for r in results]\n    final_output_str = f\"[{','.join(inner_results_str)}]\"\n    \n    # Final print statement in the exact required format.\n    print(final_output_str)\n\nsolve()\n```"
        },
        {
            "introduction": "对于刚性系统，例如反应-扩散问题，Crank-Nicolson方法的A-稳定性往往不足以防止非物理振荡和负值的出现。这个高级实践深入探讨了L-稳定性的概念及其对保持解的正性（positivity）的重要性。您将首先分析CN格式在何种条件下会失效，然后实现一个保正限制器（positivity-preserving limiter），这是一种在模拟中强制实现物理真实性的实用技术。",
            "id": "3305901",
            "problem": "考虑一维反应扩散偏微分方程（PDE），用于描述在有限区间 $x \\in [0,\\ell]$ 上的标量浓度场 $c(x,t)$。该方程具有齐次狄利克雷边界条件 $c(0,t)=0$ 和 $c(\\ell,t)=0$，以及在 $x \\in (0,\\ell)$ 上的正初始条件 $c(x,0)0$。其控制偏微分方程为\n$$\n\\frac{\\partial c}{\\partial t} = D \\frac{\\partial^2 c}{\\partial x^2} - k c,\n$$\n其中 $D0$ 是扩散系数（单位为 $\\mathrm{m}^2/\\mathrm{s}$），$k0$ 是反应速率（单位为 $\\mathrm{s}^{-1}$）。使用 $N$ 个内部点对空间进行离散化，网格间距均匀，为 $\\Delta x = \\ell/(N+1)$，并使用标准的二阶中心差分来近似拉普拉斯算子。将得到的半离散系统记为\n$$\n\\frac{d \\mathbf{c}}{dt} = L \\mathbf{c}, \\quad L = \\frac{D}{\\Delta x^2} A - k I,\n$$\n其中 $I$ 是大小为 $N \\times N$ 的单位矩阵，$A$ 是主对角线元素为 $-2$、次对角线元素为 $1$ 的三对角矩阵。\n\n时间积分将从时间 $t=0$ 到 $t=\\Delta t$ 进行，使用以下三种格式：\n- 克兰克-尼科尔森（Crank–Nicolson, CN）格式，定义为 $\\theta$ 方法在 $\\theta = 1/2$ 时的特例，也即对半离散系统应用梯形法则。克兰克-尼科尔森（CN）格式是A-稳定的，但不是L-稳定的。\n- 一个通用的 $\\theta$ 格式，其中 $\\theta1/2$，具体实现时选择 $\\theta=0.7$。\n- 通过凸限制获得的保正变体：将CN更新与后向欧拉（Backward Euler, BE）更新（对应于 $\\theta=1$ 的 $\\theta$ 格式）通过凸组合进行混合，以强制所有分量非负。\n\n你的任务是：\n1. 从半离散线性常微分方程（ODE）$\\frac{d \\mathbf{c}}{dt} = L \\mathbf{c}$（其中 $L$如上文所定义）出发，通过考虑其在 $L$ 的特征向量上的作用，分析CN格式的模态放大特性。推导在何种条件下（用 $L$ 的最负特征值和时间步长 $\\Delta t$ 表示），即使 $\\mathbf{c}(0)$ 是非负的，CN格式在单个时间步后也可能产生负浓度。你的分析必须从半离散线性系统和合法的模态分析开始；不要假设任何目标公式。\n2. 通过凸限制构造一个保正变体，具体如下：通过CN计算 $\\mathbf{c}_{\\mathrm{CN}}^{1}$，通过BE计算 $\\mathbf{c}_{\\mathrm{BE}}^{1}$，然后选择一个标量 $\\alpha \\in [0,1]$ 来定义限制后的更新 $\\mathbf{c}_{\\mathrm{lim}}^{1} = \\alpha \\mathbf{c}_{\\mathrm{CN}}^{1} + (1-\\alpha)\\mathbf{c}_{\\mathrm{BE}}^{1}$，使得 $\\mathbf{c}_{\\mathrm{lim}}^{1}$ 的所有分量都是非负的。描述如何仅从两个候选更新中选择 $\\alpha$，以强制逐分量非负。\n3. 在一个完整的、可运行的程序中实现这三种格式和凸限制方法。使用以下科学上一致的参数和初始条件：\n   - 区域长度 $\\ell = 1$ $\\mathrm{m}$。\n   - 内部点数量 $N=50$。\n   - 扩散系数 $D=10^{-3}$ $\\mathrm{m}^2/\\mathrm{s}$。\n   - 反应速率 $k=10^{4}$ $\\mathrm{s}^{-1}$。\n   - 初始条件 $c(x,0)=\\sin(\\pi x)$（单位为 $\\mathrm{mol}/\\mathrm{m}^3$），在内部网格点 $x_i = i \\Delta x$（其中 $i=1,\\dots,N$）上采样。\n   - 时间步长值 $\\Delta t \\in \\{10^{-6}, 1.5\\times 10^{-4}, 1.998\\times 10^{-4}, 3.0\\times 10^{-4}\\}$ $\\mathrm{s}$。\n   - $\\theta$ 格式的参数固定为 $\\theta=0.7$。\n4. 对于每个测试用例（每个 $\\Delta t$ 值），使用CN、$\\theta=0.7$ 的 $\\theta$ 格式以及凸限制变体计算从 $t=0$ 到 $t=\\Delta t$ 的单个步骤。对于每种方法，确定更新后的浓度是否有任何分量为负。同时，使用你在任务1中的模态分析，计算一个CN负值的理论指标：评估 $L$ 最负特征值对应的CN放大因子的符号，并报告该因子是否为负。\n5. 物理单位：浓度单位为 $\\mathrm{mol}/\\mathrm{m}^3$，空间单位为 $\\mathrm{m}$，时间单位为 $\\mathrm{s}$。要报告的结果是布尔值，无单位。\n6. 你的程序应产生单行输出，其中包含用方括号括起来的、以逗号分隔的结果列表。每个测试用例的结果必须是包含四个布尔值的列表，顺序为 $[\\text{CN\\_negative}, \\text{$\\theta$-negative}, \\text{limited\\_negative}, \\text{CN\\_predicted\\_negative}]$。例如，输出格式为 $[[b_{11},b_{12},b_{13},b_{14}], [b_{21},b_{22},b_{23},b_{24}], [b_{31},b_{32},b_{33},b_{34}], [b_{41},b_{42},b_{43},b_{44}]]$，其中每个 $b_{ij}$ 是 $\\mathrm{True}$ 或 $\\mathrm{False}$。\n\n测试套件是时间步长集合 $\\Delta t \\in \\{10^{-6}, 1.5\\times 10^{-4}, 1.998\\times 10^{-4}, 3.0\\times 10^{-4}\\}$ $\\mathrm{s}$，以及上述固定参数。最终输出必须是与指定格式完全匹配的单行打印内容。",
            "solution": "用户提供的问题经评估有效。它在科学上基于偏微分方程数值分析的原理，问题陈述清晰，具有一套完整且一致的数据和约束，并以客观、正式的语言表达。这些任务具有实质性，并解决了计算方法中的一个核心问题：数值格式中物理性质（如正性）的丧失。我们现在开始进行解答。\n\n该问题要求分析和实现一维反应扩散方程的数值格式：\n$$\n\\frac{\\partial c}{\\partial t} = D \\frac{\\partial^2 c}{\\partial x^2} - k c\n$$\n该方程定义在区域 $x \\in [0, \\ell]$ 上，并具有齐次狄利克雷边界条件。在具有 $N$ 个内部点的均匀网格上使用标准的二阶中心差分进行空间离散化，得到常微分方程（ODEs）的半离散系统：\n$$\n\\frac{d \\mathbf{c}}{dt} = L \\mathbf{c}, \\quad \\text{其中} \\quad L = \\frac{D}{\\Delta x^2} A - k I\n$$\n这里，$\\mathbf{c}(t)$ 是内部网格点上的浓度向量，$I$ 是 $N \\times N$ 单位矩阵，$A$ 是主对角线元素为 $-2$、次对角线和超对角线元素为 $1$ 的 $N \\times N$ 三对角矩阵。\n\n### 任务1：克兰克-尼科尔森格式负值分析\n\n我们通过将时间步进格式应用于线性系统 $\\frac{d\\mathbf{c}}{dt} = L\\mathbf{c}$ 来分析其行为。一个通用的一步 $\\theta$ 格式由下式给出：\n$$\n\\frac{\\mathbf{c}^{n+1} - \\mathbf{c}^n}{\\Delta t} = (1-\\theta) L \\mathbf{c}^n + \\theta L \\mathbf{c}^{n+1}\n$$\n其中 $\\mathbf{c}^n$ 是在时间 $t_n = n \\Delta t$ 处的数值解。重新整理以求解下一个时间步的解 $\\mathbf{c}^{n+1}$，得到：\n$$\n(I - \\theta \\Delta t L) \\mathbf{c}^{n+1} = (I + (1-\\theta) \\Delta t L) \\mathbf{c}^n\n$$\n$$\n\\mathbf{c}^{n+1} = (I - \\theta \\Delta t L)^{-1} (I + (1-\\theta) \\Delta t L) \\mathbf{c}^n\n$$\n克兰克-尼科尔森（CN）格式是 $\\theta = 1/2$ 的特例。\n\n为了分析该格式的稳定性和正性，我们考虑它在系统矩阵 $L$ 的特征向量上的作用。设 $\\mathbf{v}_j$ 是 $L$ 的一个特征向量，其对应的特征值为 $\\lambda_j$。由于 $L$ 是一个实对称矩阵，其特征值均为实数。矩阵 $A$ 的特征值已知为 $\\mu_j = -4 \\sin^2\\left(\\frac{j\\pi}{2(N+1)}\\right)$，其中 $j=1, \\dots, N$。因此，$L$ 的特征值为：\n$$\n\\lambda_j = \\frac{D}{\\Delta x^2} \\mu_j - k = -\\frac{4D}{\\Delta x^2} \\sin^2\\left(\\frac{j\\pi}{2(N+1)}\\right) - k\n$$\n由于 $D0$ 且 $k0$，所有特征值 $\\lambda_j$ 都是实数且严格为负。如果我们考虑一个初始条件为单一模态 $\\mathbf{c}^0 = \\mathbf{v}_j$，则一个时间步后的解为：\n$$\n\\mathbf{c}^1 = (I - \\theta \\Delta t L)^{-1} (I + (1-\\theta) \\Delta t L) \\mathbf{v}_j = \\frac{1 + (1-\\theta) \\lambda_j \\Delta t}{1 - \\theta \\lambda_j \\Delta t} \\mathbf{v}_j\n$$\n该标量项是模态放大因子，记为 $g(\\lambda_j, \\Delta t, \\theta)$。对于CN格式（$\\theta = 1/2$），该因子变为：\n$$\ng_{\\mathrm{CN}}(\\lambda_j, \\Delta t) = \\frac{1 + \\lambda_j \\Delta t / 2}{1 - \\lambda_j \\Delta t / 2}\n$$\n对于A-稳定性，我们需要对所有 $\\text{Re}(\\lambda_j) \\le 0$ 满足 $|g| \\le 1$。由于我们的 $\\lambda_j$ 是实数且为负，所以 $|g_{\\mathrm{CN}}|=1$，因此该格式是A-稳定的。然而，正性无法保证。如果初始条件 $\\mathbf{c}^0$ 是一个非负向量，但如果 $\\mathbf{c}^0$ 中存在的任何模态的放大因子为负，解 $\\mathbf{c}^1$ 就可能包含负分量。放大因子 $g_{\\mathrm{CN}}(\\lambda_j, \\Delta t)$ 在其分子为负时变为负值（因为对于 $\\lambda_j  0$，分母总是正的）：\n$$\n1 + \\frac{\\lambda_j \\Delta t}{2}  0 \\implies \\lambda_j \\Delta t  -2\n$$\n非物理振荡和负值通常由对应于最负特征值 $\\lambda_{\\min}$ 的模态触发。这发生在 $j=N$ 时：\n$$\n\\lambda_{\\min} = \\lambda_N = -\\frac{4D}{\\Delta x^2} \\sin^2\\left(\\frac{N\\pi}{2(N+1)}\\right) - k\n$$\n因此，在一般非负初始条件下，CN格式预计会产生负值的理论条件是当时间步长 $\\Delta t$ 足够大，以至于满足 $\\lambda_{\\min} \\Delta t  -2$。\n\n### 任务2：保正凸限制\n\n目标是通过将CN解与一个已知的保正格式相混合，来构造一个保正格式。后向欧拉（BE）方法，对应于 $\\theta=1$，就是这样一种格式。其放大因子为 $g_{\\mathrm{BE}}(\\lambda_j, \\Delta t) = (1 - \\lambda_j \\Delta t)^{-1}$，对于任何 $\\lambda_j  0$ 和 $\\Delta t > 0$，该值总是在 $0$ 和 $1$ 之间。因此，如果初始状态 $\\mathbf{c}^0$ 是非负的，那么BE更新 $\\mathbf{c}_{\\mathrm{BE}}^{1} = (I - \\Delta t L)^{-1} \\mathbf{c}^0$ 也保证是非负的。\n\n我们将限制后的解 $\\mathbf{c}_{\\mathrm{lim}}^{1}$ 定义为CN解和BE解的凸组合：\n$$\n\\mathbf{c}_{\\mathrm{lim}}^{1} = \\alpha \\mathbf{c}_{\\mathrm{CN}}^{1} + (1-\\alpha) \\mathbf{c}_{\\mathrm{BE}}^{1}\n$$\n其中标量限制器 $\\alpha \\in [0, 1]$。我们必须选择 $\\alpha$ 以确保每个分量 $(\\mathbf{c}_{\\mathrm{lim}}^{1})_i$ 都是非负的。对于每个分量 $i$，我们需要满足：\n$$\n\\alpha (\\mathbf{c}_{\\mathrm{CN}}^{1})_i + (1-\\alpha) (\\mathbf{c}_{\\mathrm{BE}}^{1})_i \\ge 0\n$$\n如果 $(\\mathbf{c}_{\\mathrm{CN}}^{1})_i \\ge 0$，由于 $(\\mathbf{c}_{\\mathrm{BE}}^{1})_i \\ge 0$，该不等式对任何 $\\alpha \\in [0, 1]$ 都成立。该约束仅在CN解为负的分量上起作用，即 $(\\mathbf{c}_{\\mathrm{CN}}^{1})_i  0$。对于这些分量，我们重新整理不等式以求解 $\\alpha$ 的上界：\n$$\n\\alpha [(\\mathbf{c}_{\\mathrm{CN}}^{1})_i - (\\mathbf{c}_{\\mathrm{BE}}^{1})_i] \\ge -(\\mathbf{c}_{\\mathrm{BE}}^{1})_i\n$$\n由于 $(\\mathbf{c}_{\\mathrm{CN}}^{1})_i  0$ 且 $(\\mathbf{c}_{\\mathrm{BE}}^{1})_i \\ge 0$，方括号中的项为负。用它相除会使不等号反向：\n$$\n\\alpha \\le \\frac{-(\\mathbf{c}_{\\mathrm{BE}}^{1})_i}{(\\mathbf{c}_{\\mathrm{CN}}^{1})_i - (\\mathbf{c}_{\\mathrm{BE}}^{1})_i} = \\frac{(\\mathbf{c}_{\\mathrm{BE}}^{1})_i}{(\\mathbf{c}_{\\mathrm{BE}}^{1})_i - (\\mathbf{c}_{\\mathrm{CN}}^{1})_i}\n$$\n为了同时确保所有分量的正性，$\\alpha$ 必须小于或等于在所有 $(\\mathbf{c}_{\\mathrm{CN}}^{1})_i  0$ 的分量 $i$ 上这些比率的最小值。因此，保证正性的最优（最大）$\\alpha$ 是：\n$$\n\\alpha = \\min \\left(1, \\min_{i \\text{ s.t. } (\\mathbf{c}_{\\mathrm{CN}}^{1})_i  0} \\left\\{ \\frac{(\\mathbf{c}_{\\mathrm{BE}}^{1})_i}{(\\mathbf{c}_{\\mathrm{BE}}^{1})_i - (\\mathbf{c}_{\\mathrm{CN}}^{1})_i} \\right\\} \\right)\n$$\n如果CN解已经是非负的，则该索引集合为空，内部的最小值实际上是无穷大，$\\alpha$ 变为 $\\min(1, \\infty) = 1$，这正确地恢复为纯CN解。\n\n### 任务3和4：实现与计算\n\n使用提供的参数实现这三种格式（CN、$\\theta=0.7$ 和凸限制）：$\\ell = 1 \\, \\mathrm{m}$，$N=50$，$D=10^{-3} \\, \\mathrm{m}^2/\\mathrm{s}$，$k=10^4 \\, \\mathrm{s}^{-1}$。初始条件为 $\\mathbf{c}(0)_i = \\sin(\\pi x_i)$。对于测试套件中的每个时间步 $\\Delta t$，我们计算每种格式的一个步长。每次更新都需要求解形如 $(I - \\theta \\Delta t L)\\mathbf{c}^{1} = \\mathbf{b}$ 的线性系统。由于左侧的矩阵是三对角的，因此使用高效的带状求解器。通过计算 $\\lambda_{\\min}$ 并检查条件 $\\lambda_{\\min} \\Delta t  -2$ 是否满足，来评估CN负值的理论预测。通过检查是否有任何向量分量小于零来确定计算解的负值情况。然后将这些布尔结果汇编成最终输出。",
            "answer": "```python\nimport numpy as np\nfrom scipy.linalg import solve_banded\n\ndef solve():\n    \"\"\"\n    Solves the reaction-diffusion problem with three numerical schemes\n    and reports on their positivity for a range of timesteps.\n    \"\"\"\n    \n    # Task 3: Define parameters and initial condition\n    l_domain = 1.0  # m\n    N = 50          # Number of interior points\n    D = 1e-3        # m^2/s\n    k = 1e4         # s^-1\n    theta_generic = 0.7\n    \n    delta_x = l_domain / (N + 1)\n    \n    # Construct the semi-discrete system matrix L\n    # L = (D/dx^2)A - kI\n    # A is tridiagonal with [-2, 1, 1]\n    diag_A = -2.0 * np.ones(N)\n    off_diag_A = np.ones(N - 1)\n    \n    A_mat = np.diag(diag_A) + np.diag(off_diag_A, k=1) + np.diag(off_diag_A, k=-1)\n    L_mat = (D / delta_x**2) * A_mat - k * np.identity(N)\n    \n    # Initial condition c(x,0) = sin(pi*x)\n    x = np.linspace(delta_x, l_domain - delta_x, N)\n    c0 = np.sin(np.pi * x)\n\n    # Timestep values for the test cases\n    test_cases_dt = [1.0e-6, 1.5e-4, 1.998e-4, 3.0e-4]\n    \n    # Task 4: Compute results for each test case\n    results = []\n\n    # Theoretical prediction: CN negativity condition\n    # lambda_min * dt  -2\n    # lambda_min corresponds to j=N for the eigenvalues of L\n    lambda_min = (-4 * D / delta_x**2) * np.sin(N * np.pi / (2 * (N + 1)))**2 - k\n\n    for dt in test_cases_dt:\n        # Theoretical prediction for CN negativity\n        cn_predicted_negative = bool(lambda_min * dt  -2.0)\n\n        # --- Numerical schemes ---\n        \n        def solve_theta_scheme(theta, current_dt, L, c_initial):\n            \"\"\"\n            Solves one step of the theta-scheme.\n            (I - theta*dt*L) c_next = (I + (1-theta)*dt*L) c_initial\n            \"\"\"\n            # Construct the RHS vector\n            rhs_matrix = np.identity(N) + (1.0 - theta) * current_dt * L\n            rhs_vector = rhs_matrix @ c_initial\n            \n            # Construct the LHS matrix in banded form for solve_banded\n            # LHS = I - theta*dt*L\n            # L = (D/dx^2)A - kI  = LHS = (1+theta*dt*k)I - theta*dt*(D/dx^2)A\n            f = D / delta_x**2\n            \n            # Main diagonal of LHS matrix\n            diag_LHS = 1.0 + theta * current_dt * k + 2.0 * theta * current_dt * f\n            \n            # Off-diagonals of LHS matrix\n            off_diag_LHS = -theta * current_dt * f\n            \n            # Scipy solve_banded expects matrix `ab` where rows are diagonals\n            # ab[0,:] = super-diagonal (u)\n            # ab[1,:] = main-diagonal (d)\n            # ab[2,:] = sub-diagonal (l)\n            ab = np.zeros((3, N))\n            ab[0, 1:] = off_diag_LHS\n            ab[1, :] = diag_LHS\n            ab[2, :-1] = off_diag_LHS\n            \n            return solve_banded((1, 1), ab, rhs_vector)\n\n        # Crank-Nicolson solution (theta=0.5)\n        c_cn = solve_theta_scheme(0.5, dt, L_mat, c0)\n        cn_negative = bool(np.any(c_cn  0))\n\n        # Generic theta-scheme solution (theta=0.7)\n        c_theta = solve_theta_scheme(theta_generic, dt, L_mat, c0)\n        theta_negative = bool(np.any(c_theta  0))\n        \n        # Convex-limited solution\n        # First, get the Backward Euler solution (theta=1.0)\n        c_be = solve_theta_scheme(1.0, dt, L_mat, c0)\n\n        # Find indices where CN solution is negative\n        neg_indices = np.where(c_cn  0)[0]\n        \n        if neg_indices.size > 0:\n            c_cn_neg = c_cn[neg_indices]\n            c_be_neg = c_be[neg_indices]\n            \n            # Calculate alpha limiter\n            # Note: c_cn_neg is negative, c_be_neg is non-negative\n            alpha_candidates = c_be_neg / (c_be_neg - c_cn_neg)\n            alpha = np.min(alpha_candidates)\n        else:\n            alpha = 1.0\n\n        # Form the limited solution\n        c_lim = alpha * c_cn + (1.0 - alpha) * c_be\n        # By construction, this should be non-negative. Check for small numerical errors.\n        limited_negative = bool(np.any(c_lim  -1e-15))\n        \n        results.append([cn_negative, theta_negative, limited_negative, cn_predicted_negative])\n\n    # Final print statement in the exact required format.\n    print(str(results).replace(\" \", \"\"))\n\nsolve()\n```"
        }
    ]
}