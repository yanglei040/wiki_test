{
    "hands_on_practices": [
        {
            "introduction": "In practical molecular simulations, intermolecular potentials are truncated at a finite cutoff distance to reduce computational cost. This practice, however, introduces systematic errors in calculated thermodynamic properties. This exercise explores the crucial concept of long-range corrections (LRCs), which are analytical terms added to compensate for the neglected part of the potential, ensuring the accuracy of the simulation results. By deriving and implementing these corrections for a Lennard-Jones fluid, you will quantify the bias that arises in a Gibbs Ensemble Monte Carlo simulation when LRCs are omitted, providing a clear illustration of their importance for reliable phase equilibria calculations .",
            "id": "3454569",
            "problem": "Consider a two-phase Gibbs Ensemble Monte Carlo (GEMC) simulation of a single-component fluid interacting via the Lennard–Jones pair potential. The Lennard–Jones potential is defined by $u(r) = 4\\epsilon\\left[\\left(\\dfrac{\\sigma}{r}\\right)^{12} - \\left(\\dfrac{\\sigma}{r}\\right)^6\\right]$, where $\\epsilon$ sets the energy scale and $\\sigma$ sets the length scale. In practical simulations, the potential is truncated at a cutoff $r_c$, and long-range corrections are often added to compensate for the neglected contributions from $r>r_c$. In this problem, you will quantify the bias in coexistence properties when long-range corrections are omitted, by deriving and implementing tail corrections for two boxes with number densities $\\rho_1$ and $\\rho_2$.\n\nStarting from the following well-tested, fundamental formulas for a uniform fluid with radial distribution function $g(r)=1$ beyond the cutoff distance $r_c$:\n- The potential energy per unit volume is given by $U/V = \\dfrac{1}{2}\\rho^2 \\int u(r)\\, 4\\pi r^2\\,dr$.\n- The virial contribution to pressure is given by $P_{\\text{vir}} = -\\dfrac{2\\pi}{3}\\rho^2 \\int r^3\\dfrac{du}{dr}\\,dr$.\n- The excess chemical potential in the Widom insertion picture is given by $\\mu_{\\text{ex}} = -k_B T\\ln\\left\\langle e^{-\\Delta U/k_B T}\\right\\rangle$; in a mean-field approximation for the tail beyond $r_c$, the insertion energy contribution simplifies to the uniform integral of $u(r)$ against $4\\pi r^2$ weighted by $\\rho$.\n\nYour tasks:\n1. Derive the tail correction to the potential energy per unit volume, $U_{\\text{tail}}/V$, as the contribution from $r\\in[r_c,\\infty)$ assuming $g(r)=1$ in that range. Express it in terms of $\\rho$, $\\epsilon$, $\\sigma$, and $r_c$.\n2. Derive the tail correction to the pressure, $P_{\\text{tail}}$, from the virial expression for $r\\in[r_c,\\infty)$ assuming $g(r)=1$.\n3. Derive the tail correction to the excess chemical potential, $\\mu_{\\text{tail}}$, by considering the mean-field insertion energy of a test particle with particles beyond $r_c$ in a uniform fluid of density $\\rho$.\n4. Explain how, in GEMC, equalization of truncated (uncorrected) pressure and truncated (uncorrected) chemical potential across boxes implies that the true pressure and true chemical potential will differ by the difference in tail corrections. Define the coexistence biases as $\\Delta P_{\\text{bias}} = P_{\\text{tail}}(\\rho_1) - P_{\\text{tail}}(\\rho_2)$ and $\\Delta \\mu_{\\text{bias}} = \\mu_{\\text{tail}}(\\rho_1) - \\mu_{\\text{tail}}(\\rho_2)$.\n5. Implement a program that, for each test case, computes the tail energy per unit volume in each box and the coexistence biases $\\Delta P_{\\text{bias}}$ and $\\Delta \\mu_{\\text{bias}}$ using your derived formulas. All quantities must be reported in reduced Lennard–Jones units based on the provided $\\epsilon$ and $\\sigma$ values (i.e., energies in units of $\\epsilon$, lengths in units of $\\sigma$, densities in units of $\\sigma^{-3}$). No angles or percentages are involved.\n\nTest suite (each case specifies $(\\epsilon,\\sigma,r_c,\\rho_1,\\rho_2)$):\n- Case A: $(\\epsilon, \\sigma, r_c, \\rho_1, \\rho_2) = (1, 1, 2.5, 0.8, 0.02)$.\n- Case B: $(\\epsilon, \\sigma, r_c, \\rho_1, \\rho_2) = (1, 1, 5.0, 0.7, 0.02)$.\n- Case C (boundary, equal densities): $(\\epsilon, \\sigma, r_c, \\rho_1, \\rho_2) = (1, 1, 2.5, 0.5, 0.5)$.\n- Case D (short cutoff, stronger bias): $(\\epsilon, \\sigma, r_c, \\rho_1, \\rho_2) = (1, 1, 1.5, 0.85, 0.01)$.\n\nFor each test case, your program must output a list of four floats:\n- $U_{\\text{tail}}(\\rho_1)/V$,\n- $U_{\\text{tail}}(\\rho_2)/V$,\n- $\\Delta P_{\\text{bias}}$,\n- $\\Delta \\mu_{\\text{bias}}$.\n\nFinal output format: Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each element corresponds to one test case and is itself a list of the four floats specified above (e.g., $[[x_{A1},x_{A2},x_{A3},x_{A4}],[x_{B1},x_{B2},x_{B3},x_{B4}],\\dots]$).",
            "solution": "The problem statement is subjected to validation before a solution is attempted.\n\n### Step 1: Extract Givens\n- **System**: A two-phase Gibbs Ensemble Monte Carlo (GEMC) simulation of a single-component fluid.\n- **Interaction Potential**: Lennard–Jones potential, $u(r) = 4\\epsilon\\left[\\left(\\dfrac{\\sigma}{r}\\right)^{12} - \\left(\\dfrac{\\sigma}{r}\\right)^6\\right]$.\n- **Parameters**: $\\epsilon$ (energy scale), $\\sigma$ (length scale).\n- **Simulation Protocol**: The potential is truncated at a cutoff distance $r_c$.\n- **Objective**: Quantify the bias in coexistence properties when long-range corrections are omitted for two boxes with number densities $\\rho_1$ and $\\rho_2$.\n- **Approximation**: The radial distribution function $g(r)=1$ for distances $r > r_c$.\n- **Fundamental Formulas**:\n    - Potential energy per unit volume: $U/V = \\dfrac{1}{2}\\rho^2 \\int u(r)\\, 4\\pi r^2\\,dr$.\n    - Virial contribution to pressure: $P_{\\text{vir}} = -\\dfrac{2\\pi}{3}\\rho^2 \\int r^3\\dfrac{du}{dr}\\,dr$.\n    - Excess chemical potential (mean-field tail): The insertion energy contribution is the uniform integral of $u(r)$ against $4\\pi r^2$ weighted by the density $\\rho$.\n- **Tasks**:\n    1. Derive the tail correction to the potential energy per unit volume, $U_{\\text{tail}}/V$.\n    2. Derive the tail correction to the pressure, $P_{\\text{tail}}$.\n    3. Derive the tail correction to the excess chemical potential, $\\mu_{\\text{tail}}$.\n    4. Explain the origin of coexistence biases $\\Delta P_{\\text{bias}}$ and $\\Delta \\mu_{\\text{bias}}$ in GEMC.\n    5. Implement a program to compute $U_{\\text{tail}}(\\rho_1)/V$, $U_{\\text{tail}}(\\rho_2)/V$, $\\Delta P_{\\text{bias}}$, and $\\Delta \\mu_{\\text{bias}}$.\n- **Units**: All quantities are to be in reduced Lennard–Jones units based on $\\epsilon$ and $\\sigma$.\n- **Test Cases**:\n    - Case A: $(\\epsilon, \\sigma, r_c, \\rho_1, \\rho_2) = (1, 1, 2.5, 0.8, 0.02)$.\n    - Case B: $(\\epsilon, \\sigma, r_c, \\rho_1, \\rho_2) = (1, 1, 5.0, 0.7, 0.02)$.\n    - Case C: $(\\epsilon, \\sigma, r_c, \\rho_1, \\rho_2) = (1, 1, 2.5, 0.5, 0.5)$.\n    - Case D: $(\\epsilon, \\sigma, r_c, \\rho_1, \\rho_2) = (1, 1, 1.5, 0.85, 0.01)$.\n- **Output Format**: A single line containing a list of lists of four floats for each test case: $[[U_{\\text{tail}}(\\rho_1)/V, U_{\\text{tail}}(\\rho_2)/V, \\Delta P_{\\text{bias}}, \\Delta \\mu_{\\text{bias}}]_{\\text{A}}, \\dots]$.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is evaluated against the validation criteria:\n- **Scientifically Grounded**: The problem is a standard exercise in statistical mechanics and computational physics. It deals with Lennard-Jones fluids, Gibbs ensemble simulations, and the derivation of long-range corrections, all of which are fundamental and well-established concepts. The assumption $g(r)=1$ for $r > r_c$ is the standard mean-field approximation for these derivations.\n- **Well-Posed**: The problem is clearly specified. It asks for derivations of specific physical quantities and their subsequent numerical calculation for a given set of parameters. The tasks are unambiguous and lead to a unique solution.\n- **Objective**: The language is technical and precise, free from any subjective or biased statements.\n- **Flaw Check**: The problem does not violate any of the invalidity criteria. It is scientifically sound, formalizable, complete, and poses a non-trivial but solvable challenge in computational science.\n\n### Step 3: Verdict and Action\nThe problem is **valid**. A step-by-step solution will be provided.\n\n---\n\nThe derivations will be performed using reduced Lennard-Jones units, where energy is expressed in units of $\\epsilon$, length in units of $\\sigma$, density $\\rho^*$ in units of $\\sigma^{-3}$, and so on. The test cases provide $\\epsilon=1$ and $\\sigma=1$, so the given numerical values for $r_c$ and $\\rho$ are already in the appropriate reduced units. For conciseness, the asterisk symbol on reduced quantities will be omitted. The reduced Lennard-Jones potential is:\n$$\nu(r) = 4\\left(r^{-12} - r^{-6}\\right)\n$$\n\n**1. Derivation of the Tail Correction to Potential Energy, $U_{\\text{tail}}/V$**\n\nThe tail correction to the potential energy per unit volume is the contribution from interactions at distances $r \\in [r_c, \\infty)$. Using the provided formula and the assumption that $g(r)=1$ in this range:\n$$\n\\frac{U_{\\text{tail}}}{V} = \\frac{1}{2}\\rho^2 \\int_{r_c}^{\\infty} u(r) \\, 4\\pi r^2 \\, dr\n$$\nSubstituting the Lennard-Jones potential:\n$$\n\\frac{U_{\\text{tail}}}{V} = \\frac{1}{2}\\rho^2 \\int_{r_c}^{\\infty} 4\\left(r^{-12} - r^{-6}\\right) \\, 4\\pi r^2 \\, dr = 8\\pi\\rho^2 \\int_{r_c}^{\\infty} \\left(r^{-10} - r^{-4}\\right) \\, dr\n$$\nPerforming the integration:\n$$\n\\int \\left(r^{-10} - r^{-4}\\right) \\, dr = \\frac{r^{-9}}{-9} - \\frac{r^{-3}}{-3} = -\\frac{1}{9}r^{-9} + \\frac{1}{3}r^{-3}\n$$\nEvaluating the definite integral from $r_c$ to $\\infty$:\n$$\n\\left[-\\frac{1}{9}r^{-9} + \\frac{1}{3}r^{-3}\\right]_{r_c}^{\\infty} = (0 - 0) - \\left(-\\frac{1}{9}r_c^{-9} + \\frac{1}{3}r_c^{-3}\\right) = \\frac{1}{9}r_c^{-9} - \\frac{1}{3}r_c^{-3}\n$$\nThus, the final expression for the tail correction to the potential energy per unit volume is:\n$$\n\\frac{U_{\\text{tail}}}{V}(\\rho, r_c) = 8\\pi\\rho^2 \\left(\\frac{1}{9r_c^9} - \\frac{1}{3r_c^3}\\right)\n$$\n\n**2. Derivation of the Tail Correction to Pressure, $P_{\\text{tail}}$**\n\nThe tail correction to the pressure arises from the virial contribution for $r \\in [r_c, \\infty)$. First, we find the derivative of the potential:\n$$\n\\frac{du}{dr} = 4\\left(-12r^{-13} + 6r^{-7}\\right)\n$$\nThe tail contribution to the pressure is then:\n$$\nP_{\\text{tail}} = -\\frac{2\\pi}{3}\\rho^2 \\int_{r_c}^{\\infty} r^3 \\frac{du}{dr} \\, dr = -\\frac{2\\pi}{3}\\rho^2 \\int_{r_c}^{\\infty} r^3 \\cdot 4\\left(-12r^{-13} + 6r^{-7}\\right) \\, dr\n$$\n$$\nP_{\\text{tail}} = -\\frac{8\\pi}{3}\\rho^2 \\int_{r_c}^{\\infty} \\left(-12r^{-10} + 6r^{-4}\\right) \\, dr\n$$\nIntegrating the expression:\n$$\n\\int \\left(-12r^{-10} + 6r^{-4}\\right) \\, dr = -12\\frac{r^{-9}}{-9} + 6\\frac{r^{-3}}{-3} = \\frac{4}{3}r^{-9} - 2r^{-3}\n$$\nEvaluating the definite integral:\n$$\n\\left[\\frac{4}{3}r^{-9} - 2r^{-3}\\right]_{r_c}^{\\infty} = (0 - 0) - \\left(\\frac{4}{3}r_c^{-9} - 2r_c^{-3}\\right) = 2r_c^{-3} - \\frac{4}{3}r_c^{-9}\n$$\nSubstituting this back, the tail correction to pressure is:\n$$\nP_{\\text{tail}}(\\rho, r_c) = -\\frac{8\\pi}{3}\\rho^2 \\left(2r_c^{-3} - \\frac{4}{3}r_c^{-9}\\right) = \\frac{32\\pi}{9}\\rho^2 r_c^{-9} - \\frac{16\\pi}{3}\\rho^2 r_c^{-3}\n$$\n\n**3. Derivation of the Tail Correction to Chemical Potential, $\\mu_{\\text{tail}}$**\n\nThe tail correction to the excess chemical potential corresponds to the interaction energy of a single test particle with all other particles in the system beyond $r_c$, assuming a uniform density $\\rho$.\n$$\n\\mu_{\\text{tail}} = \\int_{r_c}^{\\infty} u(r) \\rho g(r) \\, 4\\pi r^2 \\, dr\n$$\nWith $g(r)=1$:\n$$\n\\mu_{\\text{tail}} = \\rho \\int_{r_c}^{\\infty} u(r) \\, 4\\pi r^2 \\, dr\n$$\nThis integral is related to the one performed for the energy correction. Specifically, $\\mu_{\\text{tail}} = \\frac{2}{\\rho} \\left( \\frac{U_{\\text{tail}}}{V} \\right)$. Using the result from Task 1:\n$$\n\\int_{r_c}^{\\infty} u(r) \\, 4\\pi r^2 \\, dr = 8\\pi \\left(\\frac{1}{9r_c^9} - \\frac{1}{3r_c^3}\\right)\n$$\nTherefore, the tail correction to the excess chemical potential is:\n$$\n\\mu_{\\text{tail}}(\\rho, r_c) = 8\\pi\\rho \\left(\\frac{1}{9r_c^9} - \\frac{1}{3r_c^3}\\right)\n$$\nNote that the problem asks for $\\mu_{tail}$ for the insertion energy, which, as derived from the Widom test particle method in the mean-field approximation, is $2 \\times (U_{excess}/N)$. The derived formula is actually for $U_{excess}/N$ as the statement refers to the \"insertion energy contribution (...) simplified to the uniform integral\". The standard definition of the tail contribution to the excess chemical potential is actually twice the tail contribution to the excess energy per particle.\n$$\n\\mu_{\\text{tail}} = \\rho \\int_{r_c}^\\infty u(r) 4 \\pi r^2 dr = 2 \\left( \\frac{1}{2} \\rho \\int_{r_c}^\\infty u(r) 4 \\pi r^2 dr \\right) = 2 \\frac{U_{\\text{tail, per particle}}}{1}\n$$\nThe integral expression from the problem implies a tail energy, and in the context of chemical potential a factor of $2$ is standard.\nSo, $\\mu_{\\text{tail}}$ is $2 \\times$ (the interaction energy of one particle). The interaction of one particle with the mean-field fluid is $\\rho \\int u(r) 4\\pi r^2 dr$.\n$$\n\\mu_{\\text{tail}}(\\rho, r_c) = \\rho \\int_{r_c}^{\\infty} 4\\left(r^{-12} - r^{-6}\\right) 4\\pi r^2 dr = 16\\pi\\rho \\int_{r_c}^{\\infty} \\left(r^{-10} - r^{-4}\\right) dr\n$$\nUsing the previous integral result:\n$$\n\\mu_{\\text{tail}}(\\rho, r_c) = 16\\pi\\rho \\left(\\frac{1}{9r_c^9} - \\frac{1}{3r_c^3}\\right)\n$$\n\n**4. Coexistence Biases in GEMC**\n\nIn a GEMC simulation, equilibrium between two phases (e.g., liquid in box $1$, vapor in box $2$) requires equality of temperature, pressure, and chemical potential: $T_1=T_2$, $P_1=P_2$, and $\\mu_1=\\mu_2$. The simulation algorithm enforces these conditions.\nWhen using a truncated potential without long-range corrections, the algorithm actually equalizes the *truncated* properties, which are the properties calculated from the potential only for $r \\le r_c$. Let these be $P_{\\text{trunc}}$ and $\\mu_{\\text{trunc}}$. So, at convergence, the simulation establishes:\n$$\nP_{1, \\text{trunc}} = P_{2, \\text{trunc}} \\quad \\text{and} \\quad \\mu_{1, \\text{trunc}} = \\mu_{2, \\text{trunc}}\n$$\nThe true physical properties are the sum of the truncated part and the tail correction:\n$$\nP_{\\text{true}}(\\rho) = P_{\\text{trunc}}(\\rho) + P_{\\text{tail}}(\\rho)\n$$\n$$\n\\mu_{\\text{true}}(\\rho) = \\mu_{\\text{trunc}}(\\rho) + \\mu_{\\text{tail}}(\\rho)\n$$\nThe difference in the *true* pressures between the two boxes is therefore:\n$$\n\\Delta P = P_{1, \\text{true}} - P_{2, \\text{true}} = \\left(P_{1, \\text{trunc}} + P_{\\text{tail}}(\\rho_1)\\right) - \\left(P_{2, \\text{trunc}} + P_{\\text{tail}}(\\rho_2)\\right)\n$$\nSince $P_{1, \\text{trunc}} = P_{2, \\text{trunc}}$, this simplifies to the pressure bias:\n$$\n\\Delta P_{\\text{bias}} = P_{\\text{tail}}(\\rho_1) - P_{\\text{tail}}(\\rho_2)\n$$\nSimilarly, the difference in the *true* chemical potentials is:\n$$\n\\Delta \\mu = \\mu_{1, \\text{true}} - \\mu_{2, \\text{true}} = \\left(\\mu_{1, \\text{trunc}} + \\mu_{\\text{tail}}(\\rho_1)\\right) - \\left(\\mu_{2, \\text{trunc}} + \\mu_{\\text{tail}}(\\rho_2)\\right)\n$$\nSince $\\mu_{1, \\text{trunc}} = \\mu_{2, \\text{trunc}}$, this simplifies to the chemical potential bias:\n$$\n\\Delta \\mu_{\\text{bias}} = \\mu_{\\text{tail}}(\\rho_1) - \\mu_{\\text{tail}}(\\rho_2)\n$$\nBecause the tail corrections $P_{\\text{tail}}$ and $\\mu_{\\text{tail}}$ are functions of density ($\\rho^2$ and $\\rho$, respectively), and the coexisting phases have different densities ($\\rho_1 \\neq \\rho_2$), the tail corrections are unequal. This results in a systematic error, or bias, where the simulated system does not achieve true mechanical and chemical equilibrium.\n\n**5. Implementation**\nThe following Python code implements the derived formulas and computes the required quantities for the given test cases.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef u_tail_per_v(rho, rc):\n    \"\"\"\n    Calculates the tail correction to the potential energy per unit volume\n    in reduced Lennard-Jones units.\n    Formula: U_tail/V = 8 * pi * rho^2 * (1/9 * rc^-9 - 1/3 * rc^-3)\n    \"\"\"\n    rc_inv3 = 1.0 / (rc**3)\n    rc_inv9 = 1.0 / (rc**9)\n    return 8.0 * np.pi * rho**2 * (rc_inv9 / 9.0 - rc_inv3 / 3.0)\n\ndef p_tail(rho, rc):\n    \"\"\"\n    Calculates the tail correction to the pressure in reduced\n    Lennard-Jones units.\n    Formula: P_tail = (32*pi/9 * rc^-9 - 16*pi/3 * rc^-3) * rho^2\n    \"\"\"\n    rc_inv3 = 1.0 / (rc**3)\n    rc_inv9 = 1.0 / (rc**9)\n    term1 = (32.0 * np.pi / 9.0) * rc_inv9\n    term2 = -(16.0 * np.pi / 3.0) * rc_inv3\n    return (term1 + term2) * rho**2\n\ndef mu_tail(rho, rc):\n    \"\"\"\n    Calculates the tail correction to the excess chemical potential in\n    reduced Lennard-Jones units.\n    Formula: mu_tail = 16 * pi * rho * (1/9 * rc^-9 - 1/3 * rc^-3)\n    \"\"\"\n    rc_inv3 = 1.0 / (rc**3)\n    rc_inv9 = 1.0 / (rc**9)\n    return 16.0 * np.pi * rho * (rc_inv9 / 9.0 - rc_inv3 / 3.0)\n\ndef solve():\n    \"\"\"\n    Solves the problem for all test cases and prints the results in the\n    specified format.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    # Each case is a tuple: (epsilon, sigma, r_c, rho_1, rho_2)\n    # Since epsilon and sigma are 1, parameters are already in reduced units.\n    test_cases = [\n        (1, 1, 2.5, 0.8, 0.02),\n        (1, 1, 5.0, 0.7, 0.02),\n        (1, 1, 2.5, 0.5, 0.5),\n        (1, 1, 1.5, 0.85, 0.01),\n    ]\n\n    results = []\n    for case in test_cases:\n        epsilon, sigma, rc, rho1, rho2 = case\n\n        # Calculate the tail energy per unit volume for each box\n        U_tail_V1 = u_tail_per_v(rho1, rc)\n        U_tail_V2 = u_tail_per_v(rho2, rc)\n\n        # Calculate the tail pressure for each box\n        P_tail1 = p_tail(rho1, rc)\n        P_tail2 = p_tail(rho2, rc)\n        # The pressure bias is the difference in tail corrections\n        delta_P_bias = P_tail1 - P_tail2\n\n        # Calculate the tail chemical potential for each box\n        mu_tail1 = mu_tail(rho1, rc)\n        mu_tail2 = mu_tail(rho2, rc)\n        # The chemical potential bias is the difference in tail corrections\n        delta_mu_bias = mu_tail1 - mu_tail2\n\n        case_results = [U_tail_V1, U_tail_V2, delta_P_bias, delta_mu_bias]\n        results.append(case_results)\n\n    # Final print statement in the exact required format.\n    # [[val_A1, val_A2, ...], [val_B1, val_B2, ...], ...]\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Beyond correctly calculating energies, a deep understanding of the Gibbs Ensemble method requires grasping the mechanics of its core Monte Carlo moves. This practice delves into the volume exchange move, which ensures that the two simulation boxes reach mechanical equilibrium. You will explore the connection between the microscopic virial and the macroscopic pressure, and analyze how constraints on the simulation box geometry—specifically, isotropic versus anisotropic rescaling—alter the effective driving force for volume changes. This exercise illuminates the physical basis of the barostatting action within GEMC and reveals how algorithmic choices can be tailored to the symmetry of the system being studied .",
            "id": "3454522",
            "problem": "You are to implement a small, self-contained computational experiment that analyzes how constraints on simulation box geometry affect volume exchange moves in the Gibbs Ensemble Monte Carlo (GEMC) method for phase equilibria, and that derives and applies corrections when rescaling is anisotropic. The implementation must compute first-order acceptance behavior for coupled volume exchange moves under both cubic (isotropic) and orthorhombic (anisotropic) constraints, using axis-resolved virial information.\n\nStart from the fundamental statistical mechanical formulation that the probability weight of a configuration in the canonical ensemble is proportional to $\\exp(-\\beta U)$, where $\\beta = 1/(k_B T)$, $k_B$ is Boltzmann’s constant, $T$ is the temperature, and $U$ is the potential energy. In Gibbs Ensemble Monte Carlo (GEMC), two boxes, indexed by $k \\in \\{1,2\\}$, exchange volume and particles; for a volume exchange move that rescales coordinates affinely, the Metropolis acceptance ratio is determined by the product of the Boltzmann factor for the energy change and the Jacobian resulting from coordinate rescaling. For an affine deformation with small strain components $\\delta_{k,\\alpha}$ along Cartesian axes $\\alpha \\in \\{x,y,z\\}$, the first-order change of the potential energy of box $k$ is\n$$\n\\Delta U_k \\approx -\\sum_{\\alpha \\in \\{x,y,z\\}} W_{k,\\alpha} \\,\\delta_{k,\\alpha},\n$$\nwhere $W_{k,\\alpha}$ are the axis-resolved virial components $W_{k,\\alpha} = \\sum_i r_{i,\\alpha} f_{i,\\alpha}$, and the Jacobian of a diagonal rescaling with scale factors $s_{k,\\alpha}$ is $\\prod_{\\alpha} s_{k,\\alpha}^{N_k} = \\left(\\prod_{\\alpha} s_{k,\\alpha} \\right)^{N_k} = (V_k'/V_k)^{N_k}$, with $N_k$ the number of particles in box $k$ and $V_k$ its volume.\n\nConsider a coupled volume exchange proposal with small total volume increment $\\Delta$ applied to the two boxes, with $V_1' = V_1 + \\Delta$ and $V_2' = V_2 - \\Delta$, and coordinate rescalings applied in each box. Parameterize the small axis strains for box $k$ as\n$$\n\\delta_{k,\\alpha} = g_{k,\\alpha} \\frac{\\Delta}{V_k},\n$$\nsubject to the constraint\n$$\n\\sum_{\\alpha \\in \\{x,y,z\\}} g_{k,\\alpha} = 1,\n$$\nwhich ensures that the total fractional volume change of box $k$ is $\\Delta/V_k$. The case $g_{k,\\alpha} = 1/3$ for all axes corresponds to an isotropic (cubic) rescaling, while general nonuniform $g_{k,\\alpha}$ corresponds to orthorhombic anisotropic rescaling.\n\nUsing the above, the first-order logarithm of the Metropolis acceptance ratio for the coupled volume exchange move is\n$$\n\\ln a \\approx -\\beta(\\Delta U_1 + \\Delta U_2) + N_1 \\ln\\left(\\frac{V_1'}{V_1}\\right) + N_2 \\ln\\left(\\frac{V_2'}{V_2}\\right),\n$$\nand for small $\\Delta$ one may approximate $\\ln(V_k'/V_k) \\approx \\Delta/V_k$. Substituting the virial-based linearization of $\\Delta U_k$ yields\n$$\n\\ln a \\approx \\Delta \\left[ \\frac{N_1}{V_1} - \\frac{N_2}{V_2} + \\beta\\left(\\frac{1}{V_1}\\sum_{\\alpha} g_{1,\\alpha} W_{1,\\alpha} - \\frac{1}{V_2}\\sum_{\\alpha} g_{2,\\alpha} W_{2,\\alpha} \\right) \\right].\n$$\nDefine the scalar pressure of box $k$ under isotropic conditions as\n$$\nP_k = \\frac{N_k k_B T}{V_k} + \\frac{1}{3 V_k} \\sum_{\\alpha} W_{k,\\alpha},\n$$\nand define the effective pressure under anisotropic rescaling weights $g_{k,\\alpha}$ as\n$$\nP_k^{\\text{eff}} = \\frac{N_k k_B T}{V_k} + \\frac{1}{V_k} \\sum_{\\alpha} g_{k,\\alpha} W_{k,\\alpha}.\n$$\nThen the above first-order acceptance simplifies to\n$$\n\\ln a \\approx \\beta \\Delta \\left( P_1^{\\text{eff}} - P_2^{\\text{eff}} \\right),\n$$\nand for isotropic rescaling $g_{k,\\alpha} = 1/3$ one has $P_k^{\\text{eff}} = P_k$, proving that cubic constraints drive equality of scalar pressure. For orthorhombic constraints, the virial anisotropy shifts the effective driving term to $P_k^{\\text{eff}}$, and acceptance depends linearly on the anisotropic virial projection $\\sum_{\\alpha} g_{k,\\alpha} W_{k,\\alpha}$. This provides a barostat-like correction: choosing $g_{k,\\alpha}$ to emphasize axes with larger compressive virial reduces $\\Delta U_k$ at fixed $\\Delta$, thereby modifying $\\ln a$ and the effective equalization condition.\n\nYour task is to implement, for a small set of test cases, the following computations in reduced units (set $k_B = 1$ so that temperature $T$ is in energy units, pressure is in energy per volume, and virials are in energy units):\n\n1. Compute the scalar pressures $P_1$ and $P_2$ for isotropic rescaling, and report the difference $P_1 - P_2$ as a float.\n2. Compute the effective pressures $P_1^{\\text{eff}}$ and $P_2^{\\text{eff}}$ for a specified anisotropic choice of weights $g_{k,\\alpha}$, and report the difference $P_1^{\\text{eff}} - P_2^{\\text{eff}}$ as a float.\n3. Compute the first-order logarithm of the acceptance ratio $\\ln a$ for a specified small $\\Delta$ under isotropic rescaling (use $g_{k,\\alpha} = 1/3$), and report it as a float.\n4. Compute the first-order logarithm of the acceptance ratio $\\ln a$ for the same $\\Delta$ under the specified anisotropic rescaling, and report it as a float.\n\nUse the following test suite, with all quantities in reduced units:\n- Test Case $1$ (baseline cubic symmetry):\n  - $T = 1.5$, $N_1 = 500$, $V_1 = 500$, $(W_{1,x}, W_{1,y}, W_{1,z}) = (300, 300, 300)$.\n  - $N_2 = 500$, $V_2 = 500$, $(W_{2,x}, W_{2,y}, W_{2,z}) = (300, 300, 300)$.\n  - $\\Delta = 10$.\n  - Anisotropic weights: $g_{1,\\alpha} = g_{2,\\alpha} = 1/3$ for all axes.\n- Test Case $2$ (moderate anisotropy in box $1$):\n  - $T = 1.2$, $N_1 = 400$, $V_1 = 400$, $(W_{1,x}, W_{1,y}, W_{1,z}) = (600, 150, 90)$.\n  - $N_2 = 600$, $V_2 = 600$, $(W_{2,x}, W_{2,y}, W_{2,z}) = (450, 450, 450)$.\n  - $\\Delta = 10$.\n  - Anisotropic weights: choose $g_{1,\\alpha}$ proportional to the positive parts of the virial components, $g_{1,\\alpha} \\propto \\max(W_{1,\\alpha}, 0)$, normalized so that $\\sum_{\\alpha} g_{1,\\alpha} = 1$; choose $g_{2,\\alpha} = 1/3$ for all axes.\n- Test Case $3$ (strong anisotropy with a tensile axis in box $1$):\n  - $T = 1.0$, $N_1 = 300$, $V_1 = 300$, $(W_{1,x}, W_{1,y}, W_{1,z}) = (-300, 200, 100)$.\n  - $N_2 = 700$, $V_2 = 700$, $(W_{2,x}, W_{2,y}, W_{2,z}) = (200, 200, 200)$.\n  - $\\Delta = 10$.\n  - Anisotropic weights: choose $g_{1,\\alpha}$ proportional to the positive parts of the virial components, $g_{1,\\alpha} \\propto \\max(W_{1,\\alpha}, 0)$, normalized so that $\\sum_{\\alpha} g_{1,\\alpha} = 1$; choose $g_{2,\\alpha} = 1/3$ for all axes.\n\nYour program should compute, for each test case, the list\n$$\n\\left[\\, P_1 - P_2,\\; P_1^{\\text{eff}} - P_2^{\\text{eff}},\\; \\ln a\\ \\text{(isotropic)},\\; \\ln a\\ \\text{(anisotropic)} \\,\\right],\n$$\nand then aggregate the three per-case lists into a single line of output as a comma-separated list enclosed in square brackets, for example\n$$\n\\left[ [r_{1,1}, r_{1,2}, r_{1,3}, r_{1,4}], [r_{2,1}, r_{2,2}, r_{2,3}, r_{2,4}], [r_{3,1}, r_{3,2}, r_{3,3}, r_{3,4}] \\right].\n$$\nAll reported values must be floats in reduced units (energy per volume for pressure, dimensionless for $\\ln a$). There is no angle unit involved. The final program must produce precisely one line in the specified output format and require no user input.\n\nDesign your implementation so that it strictly follows the above derivation, starts from the canonical Boltzmann weight, uses the virial linearization and Jacobian factor to build the first-order acceptance formula, and cleanly separates isotropic versus anisotropic rescaling through the weights $g_{k,\\alpha}$.",
            "solution": "The problem at hand is a valid and well-posed exercise in computational statistical mechanics, specifically concerning the Gibbs Ensemble Monte Carlo (GEMC) method. It requires the calculation of pressure differences and Monte Carlo move acceptance probabilities under different geometric constraints for volume exchanges. The analysis is grounded in the fundamental principles of statistical mechanics and provides a clear, quantitative exploration of how anisotropic rescaling affects phase equilibrium simulations. All provided data and definitions are self-contained, consistent, and scientifically sound. We shall proceed with a complete solution.\n\nThe core of the problem lies in the Metropolis acceptance criterion for a volume exchange move between two simulation boxes, labeled $k=1$ and $k=2$. The probability of a state in the canonical ensemble is proportional to the Boltzmann factor, $\\exp(-\\beta U)$, where $\\beta = 1/(k_B T)$ is the inverse temperature and $U$ is the potential energy. For a move from a state with total energy $U=U_1 + U_2$ to a new state with energy $U' = U_1' + U_2'$, the acceptance probability is $a = \\min(1, \\exp(-\\beta(U' - U)) \\times J)$, where $J$ is the Jacobian factor from the coordinate transformation.\n\nFor a volume change move where box $1$ changes by a small amount $\\Delta$ (from $V_1$ to $V_1' = V_1 + \\Delta$) and box $2$ changes by $-\\Delta$ (from $V_2$ to $V_2' = V_2 - \\Delta$), the Jacobian factor for affine rescaling of the $N_k$ particle coordinates in box $k$ is $J_k = (V_k' / V_k)^{N_k}$. The total Jacobian is $J = J_1 J_2$. The logarithm of the acceptance ratio for such a move is given by:\n$$\n\\ln a = -\\beta(\\Delta U_1 + \\Delta U_2) + N_1 \\ln\\left(\\frac{V_1'}{V_1}\\right) + N_2 \\ln\\left(\\frac{V_2'}{V_2}\\right)\n$$\nFor a small volume change $\\Delta$, we can use the first-order Taylor expansions $\\ln(1+x) \\approx x$ and $\\Delta U_k \\approx -\\sum_{\\alpha} W_{k,\\alpha} \\delta_{k,\\alpha}$, where $\\delta_{k,\\alpha}$ are the small strain components along each Cartesian axis $\\alpha \\in \\{x,y,z\\}$ and $W_{k,\\alpha}$ are the axis-resolved virial components. The strains are parameterized as $\\delta_{k,\\alpha} = g_{k,\\alpha} \\frac{\\Delta_k}{V_k}$, where $\\Delta_1 = \\Delta$, $\\Delta_2 = -\\Delta$, and the weights $g_{k,\\alpha}$ sum to $1$. This parameterization ensures $\\sum_\\alpha \\delta_{k,\\alpha} = \\Delta_k/V_k$, consistent with the total volume change.\n\nSubstituting these approximations, the log-acceptance ratio becomes:\n$$\n\\ln a \\approx -\\beta \\left( -\\frac{\\Delta}{V_1}\\sum_{\\alpha} g_{1,\\alpha}W_{1,\\alpha} + \\frac{\\Delta}{V_2}\\sum_{\\alpha} g_{2,\\alpha}W_{2,\\alpha} \\right) + N_1\\frac{\\Delta}{V_1} - N_2\\frac{\\Delta}{V_2}\n$$\n$$\n\\ln a \\approx \\Delta \\left[ \\left(\\frac{N_1}{V_1} + \\frac{\\beta}{V_1}\\sum_{\\alpha} g_{1,\\alpha}W_{1,\\alpha}\\right) - \\left(\\frac{N_2}{V_2} + \\frac{\\beta}{V_2}\\sum_{\\alpha} g_{2,\\alpha}W_{2,\\alpha}\\right) \\right]\n$$\nUsing the reduced unit convention where Boltzmann's constant $k_B = 1$, so $\\beta=1/T$, we can identify the terms in parentheses with the effective pressures, $P_k^{\\text{eff}}$:\n$$\nP_k^{\\text{eff}} = \\frac{N_k T}{V_k} + \\frac{1}{V_k}\\sum_{\\alpha} g_{k,\\alpha}W_{k,\\alpha}\n$$\nThis allows the log-acceptance ratio to be expressed compactly as:\n$$\n\\ln a \\approx \\beta \\Delta (P_1^{\\text{eff}} - P_2^{\\text{eff}})\n$$\nFor the specific case of isotropic (cubic) rescaling, the weights are uniform: $g_{k,\\alpha} = 1/3$. This leads to the standard scalar pressure:\n$$\nP_k = P_k^{\\text{eff}}|_{g_{k,\\alpha}=1/3} = \\frac{N_k T}{V_k} + \\frac{1}{3V_k}\\sum_{\\alpha} W_{k,\\alpha}\n$$\nThe problem requires computing four quantities for each test case:\n1. The scalar pressure difference for isotropic rescaling, $P_1 - P_2$.\n2. The effective pressure difference for a specified anisotropic rescaling, $P_1^{\\text{eff}} - P_2^{\\text{eff}}$.\n3. The log-acceptance ratio for isotropic rescaling, $\\ln a_{\\text{iso}} = \\beta \\Delta(P_1 - P_2)$.\n4. The log-acceptance ratio for anisotropic rescaling, $\\ln a_{\\text{aniso}} = \\beta \\Delta(P_1^{\\text{eff}} - P_2^{\\text{eff}})$.\n\nWe now apply these formulas to the three test cases provided. All calculations are performed in reduced units ($k_B=1$).\n\n**Test Case 1: Baseline Cubic Symmetry**\n- Box 1: $T = 1.5, N_1 = 500, V_1 = 500, W_1 = (300, 300, 300)$.\n- Box 2: $T = 1.5, N_2 = 500, V_2 = 500, W_2 = (300, 300, 300)$.\n- $\\Delta = 10$.\n- Anisotropic weights specified as $g_{1,\\alpha} = g_{2,\\alpha} = 1/3$.\nThe system is symmetric, and the \"anisotropic\" weights are identical to the isotropic ones.\n- $P_1 = \\frac{500 \\cdot 1.5}{500} + \\frac{1}{3 \\cdot 500}(300+300+300) = 1.5 + \\frac{900}{1500} = 1.5 + 0.6 = 2.1$.\n- $P_2 = \\frac{500 \\cdot 1.5}{500} + \\frac{1}{3 \\cdot 500}(300+300+300) = 1.5 + 0.6 = 2.1$.\n1. $P_1 - P_2 = 2.1 - 2.1 = 0.0$.\n2. Since $g_{k,\\alpha} = 1/3$, $P_k^{\\text{eff}} = P_k$. Thus, $P_1^{\\text{eff}} - P_2^{\\text{eff}} = 0.0$.\n3. $\\ln a_{\\text{iso}} = \\frac{10}{1.5}(0.0) = 0.0$.\n4. $\\ln a_{\\text{aniso}} = \\frac{10}{1.5}(0.0) = 0.0$.\nThe results for Case 1 are $[0.0, 0.0, 0.0, 0.0]$.\n\n**Test Case 2: Moderate Anisotropy**\n- Box 1: $T = 1.2, N_1 = 400, V_1 = 400, W_1 = (600, 150, 90)$.\n- Box 2: $T = 1.2, N_2 = 600, V_2 = 600, W_2 = (450, 450, 450)$.\n- $\\Delta = 10$.\n- Anisotropic weights: $g_{2,\\alpha} = 1/3$. For box 1, $g_{1,\\alpha} \\propto \\max(W_{1,\\alpha}, 0)$. Since all $W_{1,\\alpha}$ are positive, the normalization constant is $\\sum W_{1,\\alpha} = 600+150+90 = 840$. So, $g_1 = (\\frac{600}{840}, \\frac{150}{840}, \\frac{90}{840}) = (\\frac{5}{7}, \\frac{5}{28}, \\frac{3}{28})$.\n- $P_1 = \\frac{400 \\cdot 1.2}{400} + \\frac{1}{3 \\cdot 400}(840) = 1.2 + 0.7 = 1.9$.\n- $P_2 = \\frac{600 \\cdot 1.2}{600} + \\frac{1}{3 \\cdot 600}(450+450+450) = 1.2 + \\frac{1350}{1800} = 1.2 + 0.75 = 1.95$.\n1. $P_1 - P_2 = 1.9 - 1.95 = -0.05$.\n2. For the anisotropic case:\n   - $\\sum_{\\alpha} g_{1,\\alpha}W_{1,\\alpha} = \\frac{5}{7}(600) + \\frac{5}{28}(150) + \\frac{3}{28}(90) = \\frac{3000}{7} + \\frac{750}{28} + \\frac{270}{28} = \\frac{12000+750+270}{28} = \\frac{13020}{28} = \\frac{3255}{7}$.\n   - $P_1^{\\text{eff}} = 1.2 + \\frac{1}{400}(\\frac{3255}{7}) = 1.2 + \\frac{3255}{2800} = 1.2 + 1.1625 = 2.3625$.\n   - For box 2, $g_{2,\\alpha}=1/3$, so $P_2^{\\text{eff}} = P_2 = 1.95$.\n   - $P_1^{\\text{eff}} - P_2^{\\text{eff}} = 2.3625 - 1.95 = 0.4125$.\n3. $\\ln a_{\\text{iso}} = \\frac{10}{1.2}(-0.05) = -\\frac{0.5}{1.2} = -\\frac{5}{12} \\approx -0.416667$.\n4. $\\ln a_{\\text{aniso}} = \\frac{10}{1.2}(0.4125) = \\frac{4.125}{1.2} = \\frac{41.25}{12} = \\frac{137.5}{40} = 3.4375$.\nThe results for Case 2 are $[-0.05, 0.4125, -0.4166666666666667, 3.4375]$.\n\n**Test Case 3: Strong Anisotropy with Tensile Axis**\n- Box 1: $T = 1.0, N_1 = 300, V_1 = 300, W_1 = (-300, 200, 100)$.\n- Box 2: $T = 1.0, N_2 = 700, V_2 = 700, W_2 = (200, 200, 200)$.\n- $\\Delta = 10$.\n- Anisotropic weights: $g_{2,\\alpha} = 1/3$. For box 1, $g_{1,\\alpha} \\propto \\max(W_{1,\\alpha}, 0)$. The positive parts are $(0, 200, 100)$, which sum to $300$. So, $g_1 = (\\frac{0}{300}, \\frac{200}{300}, \\frac{100}{300}) = (0, \\frac{2}{3}, \\frac{1}{3})$.\n- $\\sum W_{1,\\alpha} = -300+200+100=0$.\n- $P_1 = \\frac{300 \\cdot 1.0}{300} + \\frac{1}{3 \\cdot 300}(0) = 1.0$.\n- $P_2 = \\frac{700 \\cdot 1.0}{700} + \\frac{1}{3 \\cdot 700}(200+200+200) = 1.0 + \\frac{600}{2100} = 1.0 + \\frac{2}{7} = \\frac{9}{7}$.\n1. $P_1 - P_2 = 1.0 - \\frac{9}{7} = -\\frac{2}{7} \\approx -0.285714$.\n2. For the anisotropic case:\n   - $\\sum_{\\alpha} g_{1,\\alpha}W_{1,\\alpha} = 0(-300) + \\frac{2}{3}(200) + \\frac{1}{3}(100) = \\frac{400}{3} + \\frac{100}{3} = \\frac{500}{3}$.\n   - $P_1^{\\text{eff}} = 1.0 + \\frac{1}{300}(\\frac{500}{3}) = 1.0 + \\frac{5}{9} = \\frac{14}{9}$.\n   - For box 2, $g_{2,\\alpha}=1/3$, so $P_2^{\\text{eff}} = P_2 = \\frac{9}{7}$.\n   - $P_1^{\\text{eff}} - P_2^{\\text{eff}} = \\frac{14}{9} - \\frac{9}{7} = \\frac{98 - 81}{63} = \\frac{17}{63} \\approx 0.269841$.\n3. $\\ln a_{\\text{iso}} = \\frac{10}{1.0}(-\\frac{2}{7}) = -\\frac{20}{7} \\approx -2.857143$.\n4. $\\ln a_{\\text{aniso}} = \\frac{10}{1.0}(\\frac{17}{63}) = \\frac{170}{63} \\approx 2.698413$.\nThe results for Case 3 are $[-0.2857142857142857, 0.2698412698412698, -2.857142857142857, 2.698412698412698]$.\n\nThese results demonstrate that an anisotropic rescaling choice, which prioritizes deformation along axes with higher virial components, can significantly alter the effective pressure driving force and thus the acceptance probability of volume moves in a GEMC simulation.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes GEMC volume move acceptance properties for several test cases.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            'id': 1, 'T': 1.5, 'delta': 10,\n            'box1': {'N': 500, 'V': 500, 'W': (300, 300, 300)},\n            'box2': {'N': 500, 'V': 500, 'W': (300, 300, 300)}\n        },\n        {\n            'id': 2, 'T': 1.2, 'delta': 10,\n            'box1': {'N': 400, 'V': 400, 'W': (600, 150, 90)},\n            'box2': {'N': 600, 'V': 600, 'W': (450, 450, 450)}\n        },\n        {\n            'id': 3, 'T': 1.0, 'delta': 10,\n            'box1': {'N': 300, 'V': 300, 'W': (-300, 200, 100)},\n            'box2': {'N': 700, 'V': 700, 'W': (200, 200, 200)}\n        }\n    ]\n\n    all_results = []\n    \n    for case in test_cases:\n        T = case['T']\n        delta = case['delta']\n        beta = 1.0 / T\n\n        # Unpack box data\n        N1, V1, W1 = case['box1']['N'], case['box1']['V'], np.array(case['box1']['W'])\n        N2, V2, W2 = case['box2']['N'], case['box2']['V'], np.array(case['box2']['W'])\n\n        # --- Isotropic Calculations ---\n        P1_iso = (N1 * T / V1) + (1 / (3 * V1)) * np.sum(W1)\n        P2_iso = (N2 * T / V2) + (1 / (3 * V2)) * np.sum(W2)\n        P_diff_iso = P1_iso - P2_iso\n        ln_a_iso = beta * delta * P_diff_iso\n\n        # --- Anisotropic Calculations ---\n        # Determine anisotropic weights g1_aniso and g2_aniso based on case id\n        g1_aniso = np.array([1/3, 1/3, 1/3]) # Default\n        g2_aniso = np.array([1/3, 1/3, 1/3]) # Always isotropic for box 2 in these cases\n\n        if case['id'] == 1:\n            # Anisotropic weights are specified as isotropic\n            pass\n        elif case['id'] == 2 or case['id'] == 3:\n            # g1_alpha is proportional to the positive part of W1_alpha\n            W1_pos = np.maximum(W1, 0)\n            sum_W1_pos = np.sum(W1_pos)\n            if sum_W1_pos > 0:\n                g1_aniso = W1_pos / sum_W1_pos\n            # If sum_W1_pos is 0, g1_aniso remains isotropic as a fallback.\n        \n        # Calculate effective pressures and log-acceptance\n        P1_eff = (N1 * T / V1) + (1 / V1) * np.sum(g1_aniso * W1)\n        P2_eff = (N2 * T / V2) + (1 / V2) * np.sum(g2_aniso * W2)\n        P_diff_aniso = P1_eff - P2_eff\n        ln_a_aniso = beta * delta * P_diff_aniso\n\n        case_results = [P_diff_iso, P_diff_aniso, ln_a_iso, ln_a_aniso]\n        all_results.append(case_results)\n\n    # Format the final output string exactly as required, e.g., [[r1,r2],[r3,r4]]\n    # Each list of results is converted to a string representation \"[r1,r2,...]\"\n    # These strings are then joined by commas and enclosed in a final pair of brackets.\n    result_strings = []\n    for res_list in all_results:\n        # Convert each float in the list to its string representation\n        # and join with a comma, without space.\n        inner_str = ','.join(map(str, res_list))\n        result_strings.append(f\"[{inner_str}]\")\n    \n    final_output_str = f\"[{','.join(result_strings)}]\"\n    \n    # Final print statement in the exact required format.\n    print(final_output_str)\n\nsolve()\n```"
        },
        {
            "introduction": "While standard GEMC is highly effective for bulk phase equilibria, its efficiency can degrade in complex, heterogeneous systems such as fluids confined in nanopores. This advanced practice introduces the powerful strategy of designing hybrid Monte Carlo algorithms to enhance sampling in such scenarios. You will combine moves from the Gibbs and Grand Canonical ensembles to construct a custom simulation scheme and, most importantly, derive the acceptance criteria from the fundamental principle of detailed balance. This exercise transitions from using a standard method to designing a new one, a core skill for tackling cutting-edge research problems in computational materials science .",
            "id": "3454523",
            "problem": "You are asked to design and test a hybrid Markov Chain Monte Carlo (MC) scheme that couples Gibbs Ensemble Monte Carlo (GEMC) particle swaps with Grand Canonical Monte Carlo (GCMC) insertions and deletions restricted to the porous box, for a simplified model of methane coexistence in nanopores. The target of the computation is to ensure that the hybrid move set satisfies detailed balance with respect to an intended stationary distribution and that mixing different move types does not break microscopic reversibility.\n\nConsider two simulation boxes at fixed temperature: a porous box (box $1$) and a bulk box (box $2$). Treat methane as non-interacting point particles (ideal gas) for both boxes. The porous box experiences a spatially uniform external potential such that each particle in box $1$ contributes an energy penalty $+\\epsilon$ (with $\\epsilon \\ge 0$), while the bulk box has no external contribution. Use reduced units with $k_B T = 1$ so that $\\beta = 1$, and let all energies be expressed in the same reduced energy unit and all volumes be expressed in the same reduced volume unit. In these units, write all numerical values as pure numbers. Let the chemical potential be the scalar $\\mu$, also in these reduced units.\n\nDefine the following hybrid move types:\n- Move type S (Gibbs-like swap): select a particle in box $2$ and propose moving it into box $1$ at a uniformly random position in box $1$ (the reverse moves a particle from box $1$ to box $2$ analogously). This move changes the pair $(N_1,N_2)$ by $(+1,-1)$ in the forward direction (box $2 \\to 1$), where $N_1$ and $N_2$ are the current particle counts.\n- Move type G (Grand canonical in porous box): propose an insertion into box $1$ at a uniformly random position (the reverse is a deletion from box $1$ chosen uniformly among its particles). This move changes $(N_1,N_2)$ by $(+1,0)$ in the forward direction (insertion).\n\nAssume move types are chosen independently from the state, with fixed probabilities $p_{\\mathrm S}$ for type S and $p_{\\mathrm G}$ for type G, with $p_{\\mathrm S} + p_{\\mathrm G} = 1$. Within each type, assume a fixed direction selection probability equal to $1/2$ between a move and its reverse (for type S, box $2 \\to 1$ versus box $1 \\to 2$; for type G, insertion versus deletion). Within a specific direction, the proposal probabilities are:\n- For type S, box $2 \\to 1$: select one particle uniformly from $N_2$ and a new position uniformly in box $1$, giving a proposal density proportional to $(1/N_2)\\,(1/V_1)$; the reverse uses $(1/(N_1+1))\\,(1/V_2)$.\n- For type G, insertion into box $1$: select a position uniformly in $V_1$, proposal density $(1/V_1)$; the reverse deletion uses $(1/(N_1+1))$.\n\nLet the unnormalized stationary weight for a configuration with counts $(N_1,N_2)$ be proportional to\n$$\n\\pi(N_1,N_2) \\propto \\exp\\!\\big(-\\beta\\,U_1(N_1) - \\beta\\,U_2(N_2) + \\beta\\,\\mu\\,(N_1 + N_2)\\big),\n$$\nwith $U_1(N_1) = \\epsilon\\,N_1$ and $U_2(N_2) = 0$. The positions are integrated out, consistent with the ideal-gas and uniform external-field assumptions; your acceptance formula must arise from first-principles detailed balance in the Metropolis–Hastings construction using the stated proposal mechanisms.\n\nTask 1. Starting from the principle of detailed balance and the Metropolis–Hastings acceptance rule, derive acceptance probabilities for:\n- Type S forward swap (box $2 \\to 1$) and its reverse (box $1 \\to 2$) that ensure detailed balance for the stated $\\pi(N_1,N_2)$.\n- Type G forward insertion (into box $1$) and its reverse deletion (from box $1$) that ensure detailed balance for the stated $\\pi(N_1,N_2)$.\n\nYour derivation must start from the definition of detailed balance and the given proposal densities, and it must arrive at explicit acceptance functions in terms of $(N_1,N_2,V_1,V_2,\\beta,\\epsilon,\\mu)$.\n\nTask 2. Implement a program that:\n- Computes, for given parameters and a specified forward direction, the forward and reverse one-step transition probabilities $K(x \\to y)$ and $K(y \\to x)$, where $K$ includes the type selection probability, the direction selection probability, the proposal probability for that move, and the derived Metropolis–Hastings acceptance probability.\n- Verifies that the ratio $K(x \\to y)/K(y \\to x)$ equals the ratio $\\pi(y)/\\pi(x)$ implied by the given $\\pi(N_1,N_2)$ and the changes in $(N_1,N_2)$ incurred by the move type and direction. For move type S (box $2 \\to 1$), the ratio must be $\\exp(-\\beta\\,\\epsilon)$; for move type G insertion into box $1$, the ratio must be $\\exp(\\beta\\,\\mu - \\beta\\,\\epsilon)$.\n- Returns a boolean indicating whether the absolute difference between the two sides is less than a tolerance of $10^{-12}$.\n\nTest suite. Use reduced units with $\\beta = 1$. For each case below, compute the boolean described above. Use $p_{\\mathrm S} = 0.7$ and $p_{\\mathrm G} = 0.3$ in all cases.\n- Case 1 (type S forward, box $2 \\to 1$): $N_1 = 10$, $N_2 = 90$, $V_1 = 5.0$, $V_2 = 95.0$, $\\epsilon = 1.5$.\n- Case 2 (type S forward, box $2 \\to 1$): $N_1 = 0$, $N_2 = 5$, $V_1 = 12.0$, $V_2 = 8.0$, $\\epsilon = 2.3$.\n- Case 3 (type G forward, insertion into box $1$): $N_1 = 10$, $V_1 = 5.0$, $\\epsilon = 1.5$, $\\mu = -2.0$.\n- Case 4 (type G forward, insertion into box $1$): $N_1 = 0$, $V_1 = 2.0$, $\\epsilon = 0.2$, $\\mu = 3.0$.\n- Case 5 (type G forward, insertion into box $1$): $N_1 = 50$, $V_1 = 100.0$, $\\epsilon = 4.0$, $\\mu = 1.0$.\n\nFinal output format. Your program should produce a single line of output containing the five booleans corresponding to Cases $1$ through $5$, as a comma-separated list enclosed in square brackets, for example, \"[True,True,True,True,True]\". No other output is permitted.",
            "solution": "The problem requires the derivation of acceptance probabilities for a hybrid Gibbs Ensemble Monte Carlo (GEMC) and Grand Canonical Monte Carlo (GCMC) scheme and subsequent numerical verification that the resulting transition probabilities satisfy the principle of detailed balance. The system consists of two boxes containing non-interacting particles, where particles in box $1$ have an additional energy penalty of $\\epsilon$. All calculations are performed in reduced units where $\\beta = (k_B T)^{-1} = 1$.\n\nThe foundation of this analysis is the detailed balance condition, which states that for any two states $x$ and $y$ in the configuration space, the transition rates in equilibrium must satisfy:\n$$\n\\pi(x) K(x \\to y) = \\pi(y) K(y \\to x)\n$$\nHere, $\\pi(x)$ is the equilibrium probability of state $x$, and $K(x \\to y)$ is the total transition probability from state $x$ to $y$. The transition probability can be decomposed into the probability of proposing a move, $p_{select}(x \\to y)$, and the probability of accepting it, $A(x \\to y)$:\n$$\nK(x \\to y) = p_{select}(x \\to y) A(x \\to y)\n$$\nThe Metropolis-Hastings algorithm provides a choice for the acceptance probability that guarantees detailed balance:\n$$\nA(x \\to y) = \\min\\left(1, \\frac{\\pi(y) p_{select}(y \\to x)}{\\pi(x) p_{select}(x \\to y)}\\right)\n$$\nThe problem specifies that the selection of a move type (S or G) and its direction (e.g., forward or reverse) are independent of the current state and symmetric for a move and its reverse. That is, $p_{type}(x \\to y) = p_{type}(y \\to x)$ and $p_{dir}(x \\to y) = p_{dir}(y \\to x)$. The full proposal probability $p_{select}(x \\to y)$ includes these probabilities as well as a term $T_{prob}(x \\to y)$ related to generating the specific final configuration from the initial one.\n$$\np_{select}(x \\to y) = p_{type} \\cdot p_{dir} \\cdot T_{prob}(x \\to y)\n$$\nDue to the symmetry of $p_{type}$ and $p_{dir}$, the acceptance criterion simplifies to:\n$$\nA(x \\to y) = \\min\\left(1, \\frac{\\pi(y) T_{prob}(y \\to x)}{\\pi(x) T_{prob}(x \\to y)}\\right)\n$$\nThe problem provides an unnormalized stationary weight for a macrostate $(N_1, N_2)$:\n$$\n\\pi(N_1, N_2) \\propto \\exp(-\\beta \\epsilon N_1 + \\beta \\mu (N_1 + N_2))\n$$\nWe use this expression along with the given proposal terms $T_{prob}$ to derive the acceptance rules.\n\n**Task 1: Derivation of Acceptance Probabilities**\n\n**Move Type S (Gibbs-like swap)**\nThis move transfers a particle between box $1$ and box $2$.\n- Forward move ($2 \\to 1$): The state changes from $x = (N_1, N_2)$ to $y = (N_1+1, N_2-1)$.\n- Reverse move ($1 \\to 2$): The state changes from $y = (N_1+1, N_2-1)$ to $x = (N_1, N_2)$.\nThe proposal terms are given as $T_{prob}(x \\to y) \\propto \\frac{1}{N_2 V_1}$ and $T_{prob}(y \\to x) \\propto \\frac{1}{(N_1+1) V_2}$. The ratio of stationary weights is:\n$$\n\\frac{\\pi(y)}{\\pi(x)} = \\frac{\\pi(N_1+1, N_2-1)}{\\pi(N_1, N_2)} = \\frac{\\exp(-\\beta\\epsilon(N_1+1) + \\beta\\mu(N_1+1+N_2-1))}{\\exp(-\\beta\\epsilon N_1 + \\beta\\mu(N_1+N_2))} = \\exp(-\\beta\\epsilon)\n$$\nThe argument of the acceptance function, $R_S$, is:\n$$\nR_S = \\frac{\\pi(y)}{\\pi(x)} \\frac{T_{prob}(y \\to x)}{T_{prob}(x \\to y)} = \\exp(-\\beta\\epsilon) \\frac{1/((N_1+1)V_2)}{1/(N_2 V_1)} = \\frac{N_2 V_1}{(N_1+1)V_2} \\exp(-\\beta\\epsilon)\n$$\nThe acceptance probability for the forward swap ($2 \\to 1$) is:\n$$\nA_{S, 2 \\to 1} = \\min(1, R_S) = \\min\\left(1, \\frac{N_2 V_1}{(N_1+1)V_2} \\exp(-\\beta\\epsilon)\\right)\n$$\nThe acceptance probability for the reverse swap ($1 \\to 2$) is:\n$$\nA_{S, 1 \\to 2} = \\min(1, 1/R_S) = \\min\\left(1, \\frac{(N_1+1)V_2}{N_2 V_1} \\exp(\\beta\\epsilon)\\right)\n$$\n\n**Move Type G (Grand canonical in porous box)**\nThis move inserts or deletes a particle in box $1$.\n- Forward move (insertion): The state changes from $x = (N_1, N_2)$ to $y = (N_1+1, N_2)$.\n- Reverse move (deletion): The state changes from $y = (N_1+1, N_2)$ to $x = (N_1, N_2)$.\nThe proposal terms are given as $T_{prob}(x \\to y) \\propto \\frac{1}{V_1}$ and $T_{prob}(y \\to x) \\propto \\frac{1}{N_1+1}$. The ratio of stationary weights is:\n$$\n\\frac{\\pi(y)}{\\pi(x)} = \\frac{\\pi(N_1+1, N_2)}{\\pi(N_1, N_2)} = \\frac{\\exp(-\\beta\\epsilon(N_1+1) + \\beta\\mu(N_1+1+N_2))}{\\exp(-\\beta\\epsilon N_1 + \\beta\\mu(N_1+N_2))} = \\exp(\\beta\\mu - \\beta\\epsilon)\n$$\nThe argument of the acceptance function, $R_G$, is:\n$$\nR_G = \\frac{\\pi(y)}{\\pi(x)} \\frac{T_{prob}(y \\to x)}{T_{prob}(x \\to y)} = \\exp(\\beta\\mu - \\beta\\epsilon) \\frac{1/(N_1+1)}{1/V_1} = \\frac{V_1}{N_1+1} \\exp(\\beta\\mu - \\beta\\epsilon)\n$$\nThe acceptance probability for the forward insertion is:\n$$\nA_{G, \\text{ins}} = \\min(1, R_G) = \\min\\left(1, \\frac{V_1}{N_1+1} \\exp(\\beta\\mu - \\beta\\epsilon)\\right)\n$$\nThe acceptance probability for the reverse deletion is:\n$$\nA_{G, \\text{del}} = \\min(1, 1/R_G) = \\min\\left(1, \\frac{N_1+1}{V_1} \\exp(-\\beta\\mu + \\beta\\epsilon)\\right)\n$$\n\n**Task 2: Numerical Verification**\nThe task is to verify that the ratio of the total transition probabilities, $\\frac{K(x \\to y)}{K(y \\to x)}$, equals the ratio of the stationary probabilities, $\\frac{\\pi(y)}{\\pi(x)}$. By construction, this equality must hold. The identity $$ \\frac{A(x \\to y)}{A(y \\to x)} = \\frac{\\pi(y) T_{prob}(y \\to x)}{\\pi(x) T_{prob}(x \\to y)} $$ guarantees this:\n$$\n\\frac{K(x \\to y)}{K(y \\to x)} = \\frac{p_{type} p_{dir} T_{prob}(x \\to y) A(x \\to y)}{p_{type} p_{dir} T_{prob}(y \\to x) A(y \\to x)} = \\frac{T_{prob}(x \\to y)}{T_{prob}(y \\to x)} \\frac{\\pi(y) T_{prob}(y \\to x)}{\\pi(x) T_{prob}(x \\to y)} = \\frac{\\pi(y)}{\\pi(x)}\n$$\nThe program will compute both sides of this equation numerically, using the derived formulas for acceptance probabilities, for each test case and verify their agreement within a specified tolerance. For a forward move from an initial state $x$ to a final state $y$, the left side is the ratio of $K(x \\to y)$ to $K(y \\to x)$, and the right side is the analytically known target ratio, either $\\exp(-\\beta\\epsilon)$ for type S or $\\exp(\\beta\\mu - \\beta\\epsilon)$ for type G.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes and verifies detailed balance for a hybrid MC scheme.\n    \n    The function tests two types of Monte Carlo moves (S: swap, G: grand canonical)\n    for a simplified model of gas coexistence in nanopores. For each test case,\n    it calculates the forward and reverse transition probabilities K(x->y) and K(y->x).\n    It then verifies that their ratio K(x->y)/K(y->x) equals the ratio of the\n    stationary probabilities pi(y)/pi(x), as required by detailed balance.\n    \"\"\"\n    \n    # Parameters given in the problem\n    p_S = 0.7\n    p_G = 0.3\n    beta = 1.0\n    tolerance = 1e-12\n\n    # Test suite from the problem statement.\n    # Each case: (type, N1_initial, N2_initial, V1, V2, epsilon, mu)\n    # V2 or mu might be None if not used by the move type.\n    test_cases = [\n        ('S', 10, 90, 5.0, 95.0, 1.5, None),\n        ('S', 0, 5, 12.0, 8.0, 2.3, None),\n        ('G', 10, None, 5.0, None, 1.5, -2.0),\n        ('G', 0, None, 2.0, None, 0.2, 3.0),\n        ('G', 50, None, 100.0, None, 4.0, 1.0),\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        move_type, N1, N2, V1, V2, epsilon, mu = case\n        \n        computed_ratio = 0.0\n        target_ratio = 0.0\n\n        if move_type == 'S':\n            # Type S forward move: box 2 -> 1\n            # Initial state x: (N1, N2), Final state y: (N1+1, N2-1)\n            \n            # The problem's test cases ensure N2 > 0 for this move.\n            \n            # Target ratio from stationary distribution: pi(y)/pi(x) = exp(-beta*epsilon)\n            target_ratio = np.exp(-beta * epsilon)\n\n            # Proposal factors T_prob from the problem statement\n            T_forward = 1.0 / (N2 * V1)\n            T_reverse = 1.0 / ((N1 + 1) * V2)\n\n            # Argument R for the Metropolis-Hastings acceptance rule\n            # R = (pi(y)/pi(x)) * (T_reverse / T_forward)\n            R = target_ratio * (T_reverse / T_forward) if T_forward != 0 else float('inf')\n\n            # Acceptance probabilities A(x->y) and A(y->x)\n            A_forward = min(1.0, R)\n            A_reverse = min(1.0, 1.0 / R) if R != 0 else 1.0\n\n            # Total transition probabilities K = p_type * p_direction * T_prob * A\n            # p_direction is 1/2 for both forward and reverse moves.\n            K_forward = p_S * 0.5 * T_forward * A_forward\n            K_reverse = p_S * 0.5 * T_reverse * A_reverse\n            \n            # Ratio of transition probabilities K(x->y)/K(y->x)\n            if K_reverse == 0:\n                # This should not happen with the given test cases.\n                computed_ratio = float('inf') if K_forward != 0 else 1.0\n            else:\n                computed_ratio = K_forward / K_reverse\n\n        elif move_type == 'G':\n            # Type G forward move: insertion into box 1\n            # Initial state x: (N1, N_any), Final state y: (N1+1, N_any)\n\n            # Target ratio from analytical derivation: pi(y)/pi(x) = exp(beta*mu - beta*epsilon)\n            target_ratio = np.exp(beta * mu - beta * epsilon)\n\n            # Proposal factors T_prob\n            T_forward = 1.0 / V1          # Insertion\n            T_reverse = 1.0 / (N1 + 1)    # Deletion\n            \n            # Argument R for the Metropolis-Hastings acceptance rule\n            R = target_ratio * (T_reverse / T_forward) if T_forward != 0 else float('inf')\n            \n            # Acceptance probabilities\n            A_forward = min(1.0, R)\n            A_reverse = min(1.0, 1.0 / R) if R != 0 else 1.0\n            \n            # Total transition probabilities K\n            K_forward = p_G * 0.5 * T_forward * A_forward\n            K_reverse = p_G * 0.5 * T_reverse * A_reverse\n            \n            # Ratio K(x->y)/K(y->x)\n            if K_reverse == 0:\n                computed_ratio = float('inf') if K_forward != 0 else 1.0\n            else:\n                computed_ratio = K_forward / K_reverse\n        \n        # Verify if computed ratio matches the target ratio within tolerance\n        is_balanced = np.abs(computed_ratio - target_ratio) < tolerance\n        results.append(is_balanced)\n        \n    # Format and print the final output as specified.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}