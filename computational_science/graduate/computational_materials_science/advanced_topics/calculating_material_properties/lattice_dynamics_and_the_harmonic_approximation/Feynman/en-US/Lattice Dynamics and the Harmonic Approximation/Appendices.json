{
    "hands_on_practices": [
        {
            "introduction": "A cornerstone of computational lattice dynamics is the supercell approach, which approximates an infinite crystal with a finite, periodically-repeated unit. This practice delves into the two primary systematic errors inherent in this approximation: real-space truncation of force constants and reciprocal-space aliasing due to the discrete sampling of wavevectors. By deriving the dispersion for a simple 1D chain and then modeling these errors explicitly, you will gain a crucial, first-principles understanding of convergence and develop practical strategies for choosing simulation parameters that ensure accuracy in real-world calculations .",
            "id": "3460323",
            "problem": "Consider a one-dimensional monoatomic Bravais lattice with lattice constant $a$ and identical masses $m$. Let $u_n(t)$ denote the scalar displacement of the atom at lattice site $n \\in \\mathbb{Z}$ along the chain. In the harmonic approximation, assume that the force on any atom is linear in the displacements and arises from pairwise central interactions that depend only on the integer separation $|n|$, consistent with lattice translational invariance. Let the off-site harmonic force-constant sequence be $\\{\\Phi(n)\\}_{n\\ge 1}$ with $\\Phi(n) \\ge 0$ for all $n \\ge 1$. The on-site element must enforce the acoustic sum rule so that the net force vanishes for any uniform translation.\n\nYou are to work from first principles (Newton’s second law, Hooke’s law for small oscillations, and lattice translational symmetry) to derive the lattice dynamical equation of motion for normal modes with wavevector $q$ and angular frequency $\\omega(q)$. The derivation should begin from the discrete equations of motion in real space, introduce plane-wave solutions consistent with the Born-von Kármán periodic boundary conditions, and arrive at a reciprocal-space representation of the normal-mode problem without assuming any specific decay law for $\\Phi(n)$ a priori. From this representation, identify a computationally implementable expression for $\\omega(q)$ in terms of the real-space force constants.\n\nFor the purposes of this computational task, specialize to a model in reduced units with $a = 1$, $m = 1$, and a force constant scale of unity. Let the off-site force constants be given by the physically plausible, short-ranged, strictly positive sequence\n$$\n\\Phi(n) = \\exp\\!\\left(-\\frac{n}{\\xi}\\right), \\quad n \\in \\mathbb{N},\n$$\nwhere $\\xi > 0$ is a range parameter. All angles must be treated in radians. All frequencies must be reported as angular frequencies in $\\mathrm{rad/s}$. Use $a = 1$ as the unit of length and report any wavenumber $q$ in units of $\\mathrm{rad}$.\n\nIn practice, finite-displacement supercell calculations with $N$ primitive cells along the chain return an approximation to the infinite-crystal phonons. Two sources of systematic error must be evaluated:\n\n- Real-space truncation error: The finite supercell effectively truncates interatomic force constants beyond a real-space cutoff $R_c$, which for a one-dimensional supercell of length $N$ is $R_c = \\left\\lfloor \\frac{N-1}{2} \\right\\rfloor$ in units of $a$.\n\n- Reciprocal-space aliasing (from $q$-grid truncation): Sampling any reciprocal-space quantity on a discrete grid of $N$ equally spaced wavevectors and then transforming back to real space corresponds to wrapping the infinite-range real-space sequence into a periodic image sum with period $N$, which folds long-range contributions back into the $[1,\\ldots,\\lfloor N/2 \\rfloor]$ range. This produces an aliased approximation to the true lattice Green’s function and hence to the phonon frequency at a target $q$.\n\nYour program must implement the following, starting from the fundamental real-space harmonic equations and your derived reciprocal-space representation:\n\n1. Define the “reference” angular frequency $\\omega_{\\mathrm{ref}}(q;\\xi)$ for a given $q$ and $\\xi$ by evaluating the exact infinite-crystal expression implied by your derivation to a numerically converged tolerance via summation over $n \\in \\mathbb{N}$.\n\n2. Define the “supercell-truncated” angular frequency $\\omega_{\\mathrm{cut}}(q;\\xi,N)$ by evaluating the same expression but truncating the real-space sum at $n = R_c = \\left\\lfloor \\frac{N-1}{2} \\right\\rfloor$.\n\n3. Define the “$q$-aliasing” angular frequency $\\omega_{\\mathrm{alias}}(q;\\xi,N)$ by constructing an effective aliased force-constant sequence for distances $n \\in \\{1,\\ldots,\\lfloor N/2 \\rfloor\\}$ equal to the periodic image sum of the true $\\Phi(n)$ with period $N$, and then evaluating the same reciprocal-space expression using this aliased sequence.\n\n4. For a prescribed frequency tolerance $\\varepsilon_\\omega > 0$ (in $\\mathrm{rad/s}$), compute an “optimal” real-space cutoff recommendation $R_\\star(\\xi,\\varepsilon_\\omega)$ that is the smallest nonnegative integer $R_c$ such that a rigorous, $q$-independent upper bound on the contribution of the neglected force constants $\\{ \\Phi(n) : n > R_c \\}$ to the squared angular frequency is less than or equal to $\\varepsilon_\\omega^2$. Your derivation should start from the fundamental representation you obtained for the exact frequency and must use only inequalities valid for all $q$ to bound the effect of the neglected tail.\n\nNumerical details and units:\n\n- Use $a = 1$, $m = 1$, and unit force-constant scale, so that angular frequencies are in $\\mathrm{rad/s}$.\n\n- Treat all wavevectors $q$ in radians.\n\n- When reporting floating-point outputs, round to exactly $8$ decimal places.\n\nTest suite:\n\nFor each of the following parameter sets $(\\xi, N, q, \\varepsilon_\\omega)$, compute:\n\n- The absolute error $|\\omega_{\\mathrm{cut}}(q;\\xi,N) - \\omega_{\\mathrm{ref}}(q;\\xi)|$ in $\\mathrm{rad/s}$.\n\n- The absolute error $|\\omega_{\\mathrm{alias}}(q;\\xi,N) - \\omega_{\\mathrm{ref}}(q;\\xi)|$ in $\\mathrm{rad/s}$.\n\n- The recommended cutoff $R_\\star(\\xi,\\varepsilon_\\omega)$ as a nonnegative integer.\n\nUse the test suite:\n- $(\\xi, N, q, \\varepsilon_\\omega) = (3.0, 5, \\frac{\\pi}{3}, 0.02)$\n- $(\\xi, N, q, \\varepsilon_\\omega) = (3.0, 31, \\frac{\\pi}{3}, 0.02)$\n- $(\\xi, N, q, \\varepsilon_\\omega) = (0.5, 5, \\frac{\\pi}{3}, 0.02)$\n- $(\\xi, N, q, \\varepsilon_\\omega) = (3.0, 31, \\frac{\\pi}{50}, 0.005)$\n- $(\\xi, N, q, \\varepsilon_\\omega) = (3.0, 7, \\pi, 0.02)$\n- $(\\xi, N, q, \\varepsilon_\\omega) = (1.5, 9, \\frac{2\\pi}{3}, 0.02)$\n\nFinal output format:\n\nYour program should produce a single line of output containing the results as a comma-separated list of lists enclosed in square brackets. Each inner list corresponds to one test case and must be of the form $[\\mathrm{err\\_cut}, \\mathrm{err\\_alias}, R_\\star]$, where the first two entries are floating-point numbers rounded to $8$ decimal places (in $\\mathrm{rad/s}$) and the third is an integer. For example:\n$[[x_1,y_1,z_1],[x_2,y_2,z_2],\\ldots]$.",
            "solution": "The problem is found to be valid as it is scientifically grounded in the principles of solid-state physics, is well-posed, objective, and internally consistent. We can therefore proceed with a full derivation and solution.\n\nThe core of this problem is to derive the dispersion relation for a one-dimensional monoatomic lattice and then use it to analyze two common sources of error in computational phonon calculations: real-space truncation and reciprocal-space aliasing. Finally, a practical cutoff recommendation is derived.\n\n**Part 1: Derivation of the Dispersion Relation**\n\nWe consider a one-dimensional Bravais lattice of atoms with mass $m$ and lattice constant $a$. Let $u_n(t)$ be the displacement of the atom at site $n$ from its equilibrium position $na$. We work in the harmonic approximation, where the force on each atom is linear in the atomic displacements. The problem specifies pairwise central interactions, so the force on atom $n$ depends on the relative displacements $(u_k - u_n)$ for all other atoms $k$. Given lattice translational invariance, the force constant between atoms at sites $n$ and $n+k$ depends only on the separation $k$.\n\nLet $\\Phi(k)$ for $k \\in \\mathbb{N}$ (i.e., $k \\ge 1$) be the harmonic force constant (spring constant) for the interaction between atoms separated by a distance $ka$. The force exerted on atom $n$ by atom $n+k$ is $\\Phi(k)(u_{n+k} - u_n)$, and by atom $n-k$ is $\\Phi(k)(u_{n-k} - u_n)$. The total force $F_n$ on atom $n$ is the sum of forces from all other atoms:\n$$ F_n = \\sum_{k=1}^{\\infty} \\Phi(k)(u_{n+k} - u_n) + \\sum_{k=1}^{\\infty} \\Phi(k)(u_{n-k} - u_n) $$\n$$ F_n = \\sum_{k=1}^{\\infty} \\Phi(k) \\left( u_{n+k} + u_{n-k} - 2u_n \\right) $$\nThis formulation inherently satisfies the acoustic sum rule, as a uniform translation ($u_n = c$ for all $n$) results in zero net force on every atom.\n\nApplying Newton's second law, $m\\ddot{u}_n = F_n$, we obtain the equation of motion for atom $n$:\n$$ m \\frac{d^2 u_n}{dt^2} = \\sum_{k=1}^{\\infty} \\Phi(k) \\left( u_{n+k} + u_{n-k} - 2u_n \\right) $$\nWe seek normal mode solutions, which are collective oscillations where all atoms move with the same frequency $\\omega$ and a well-defined wavevector $q$. These are described by plane waves. We make the ansatz for the displacement of atom $n$:\n$$ u_n(t) = A e^{i(q(na) - \\omega t)} $$\nwhere $A$ is the amplitude. The displacements of the neighbors are:\n$$ u_{n\\pm k}(t) = A e^{i(q(n\\pm k)a - \\omega t)} = u_n(t) e^{\\pm iqka} $$\nThe second time derivative is $\\ddot{u}_n(t) = -\\omega^2 u_n(t)$. Substituting these into the equation of motion yields:\n$$ -m\\omega^2 u_n(t) = \\sum_{k=1}^{\\infty} \\Phi(k) \\left( u_n(t)e^{iqka} + u_n(t)e^{-iqka} - 2u_n(t) \\right) $$\nDividing by $u_n(t)$ (which is non-zero), we get:\n$$ -m\\omega^2 = \\sum_{k=1}^{\\infty} \\Phi(k) (e^{iqka} + e^{-iqka} - 2) $$\nUsing the Euler identity $e^{i\\theta} + e^{-i\\theta} = 2\\cos(\\theta)$, this simplifies to:\n$$ -m\\omega^2 = \\sum_{k=1}^{\\infty} 2\\Phi(k) (\\cos(qka) - 1) $$\n$$ m\\omega^2(q) = 2 \\sum_{k=1}^{\\infty} \\Phi(k) (1 - \\cos(qka)) $$\nThis equation is the dispersion relation, connecting the frequency $\\omega$ to the wavevector $q$. Using the half-angle identity $1 - \\cos(\\theta) = 2\\sin^2(\\theta/2)$, we arrive at an equivalent and often-used form:\n$$ m\\omega^2(q) = 4 \\sum_{k=1}^{\\infty} \\Phi(k) \\sin^2\\left(\\frac{qka}{2}\\right) $$\nThis is the desired reciprocal-space representation for the normal-mode problem.\n\n**Part 2: Computational Implementations**\n\nWe now specialize to the model with reduced units $m=1$, $a=1$, and force constants $\\Phi(n) = \\exp(-n/\\xi)$ for $n \\in \\mathbb{N}$. The dispersion relation becomes:\n$$ \\omega^2(q;\\xi) = 4 \\sum_{n=1}^{\\infty} e^{-n/\\xi} \\sin^2\\left(\\frac{qn}{2}\\right) $$\n\n1.  **Reference Frequency, $\\omega_{\\mathrm{ref}}(q;\\xi)$**:\n    This is the exact frequency from the infinite sum. For the given exponential form of $\\Phi(n)$, the infinite series can be summed analytically. We use the form $\\omega^2(q) = 2 \\sum_{n=1}^{\\infty} e^{-n/\\xi} (1 - \\cos(qn))$.\n    This separates into two geometric series:\n    $$ \\omega_{\\mathrm{ref}}^2(q;\\xi) = 2 \\left( \\sum_{n=1}^{\\infty} (e^{-1/\\xi})^n - \\Re\\left[\\sum_{n=1}^{\\infty} (e^{-1/\\xi}e^{iq})^n\\right] \\right) $$\n    Using the formula for the sum of a geometric series, $\\sum_{n=1}^{\\infty} z^n = z/(1-z)$ for $|z|<1$:\n    $$ \\sum_{n=1}^{\\infty} (e^{-1/\\xi})^n = \\frac{e^{-1/\\xi}}{1 - e^{-1/\\xi}} = \\frac{1}{e^{1/\\xi} - 1} $$\n    $$ \\sum_{n=1}^{\\infty} (e^{-1/\\xi}e^{iq})^n = \\frac{e^{-1/\\xi}e^{iq}}{1 - e^{-1/\\xi}e^{iq}} $$\n    Taking the real part of the second sum and combining gives the final analytical expression for implementation:\n    $$ \\omega_{\\mathrm{ref}}^2(q;\\xi) = 2 \\left( \\frac{1}{e^{1/\\xi}-1} - \\frac{e^{-1/\\xi}\\cos q - e^{-2/\\xi}}{1 - 2e^{-1/\\xi}\\cos q + e^{-2/\\xi}} \\right) $$\n\n2.  **Supercell-Truncated Frequency, $\\omega_{\\mathrm{cut}}(q;\\xi,N)$**:\n    This approximation corresponds to truncating the real-space interactions beyond a cutoff radius $R_c = \\lfloor (N-1)/2 \\rfloor$. The sum is evaluated only up to $n=R_c$:\n    $$ \\omega_{\\mathrm{cut}}^2(q;\\xi,N) = 4 \\sum_{n=1}^{R_c} e^{-n/\\xi} \\sin^2\\left(\\frac{qn}{2}\\right) $$\n    This is a finite sum computed directly.\n\n3.  **$q$-Aliasing Frequency, $\\omega_{\\mathrm{alias}}(q;\\xi,N)$**:\n    This approximation arises from modeling the system with a finite supercell of size $N$ with periodic boundary conditions. This effectively \"folds\" the long-range interactions back into the supercell. The aliased force constant $\\Phi_{\\mathrm{alias}}(n)$ for an interaction over distance $n < N/2$ is the sum of true force constants for all distances related by periodicity, i.e., $n, N-n, N+n, 2N-n, \\ldots$.\n    For $n \\in \\{1, \\ldots, \\lfloor (N-1)/2 \\rfloor\\}$:\n    $$ \\Phi_{\\mathrm{alias}}(n) = \\sum_{j=-\\infty}^{\\infty} \\Phi(|n+jN|) = \\sum_{j=0}^{\\infty} \\Phi(n+jN) + \\sum_{j=1}^{\\infty} \\Phi(jN-n) $$\n    For $\\Phi(k) = e^{-k/\\xi}$, these sums are geometric series:\n    $$ \\Phi_{\\mathrm{alias}}(n) = e^{-n/\\xi}\\sum_{j=0}^{\\infty}(e^{-N/\\xi})^j + e^{n/\\xi}\\sum_{j=1}^{\\infty}(e^{-N/\\xi})^j = \\frac{e^{-n/\\xi}}{1-e^{-N/\\xi}} + \\frac{e^{n/\\xi}e^{-N/\\xi}}{1-e^{-N/\\xi}} $$\n    $$ \\Phi_{\\mathrm{alias}}(n) = \\frac{e^{-n/\\xi} + e^{-(N-n)/\\xi}}{1 - e^{-N/\\xi}} $$\n    The aliased frequency is then computed using these effective force constants over the range of the first Brillouin zone of the supercell lattice:\n    $$ \\omega_{\\mathrm{alias}}^2(q;\\xi,N) = 4 \\sum_{n=1}^{\\lfloor(N-1)/2\\rfloor} \\Phi_{\\mathrm{alias}}(n) \\sin^2\\left(\\frac{qn}{2}\\right) $$\n\n**Part 3: Optimal Real-Space Cutoff Recommendation, $R_\\star(\\xi,\\varepsilon_\\omega)$**\n\nWe seek the smallest non-negative integer cutoff $R_c$ such that the contribution to $\\omega^2$ from all neglected terms $\\Phi(n)$ for $n > R_c$ is bounded by $\\varepsilon_\\omega^2$, regardless of the wavevector $q$.\nThe error contribution to $\\omega^2$ is:\n$$ \\Delta\\omega^2(q, R_c) = \\omega_{\\mathrm{ref}}^2 - \\omega_{\\mathrm{cut}}^2 = 4 \\sum_{n=R_c+1}^{\\infty} e^{-n/\\xi} \\sin^2\\left(\\frac{qn}{2}\\right) $$\nTo find a $q$-independent upper bound, we use the inequality $\\sin^2(\\theta) \\le 1$:\n$$ \\Delta\\omega^2(q, R_c) \\le 4 \\sum_{n=R_c+1}^{\\infty} e^{-n/\\xi} $$\nThe sum is a geometric series: $\\sum_{n=R_c+1}^{\\infty} (e^{-1/\\xi})^n = \\frac{(e^{-1/\\xi})^{R_c+1}}{1-e^{-1/\\xi}} = \\frac{e^{-(R_c+1)/\\xi}}{1-e^{-1/\\xi}}$.\nWe impose the condition that this upper bound is less than or equal to $\\varepsilon_\\omega^2$:\n$$ 4 \\frac{e^{-(R_c+1)/\\xi}}{1-e^{-1/\\xi}} \\le \\varepsilon_\\omega^2 $$\nSolving for $R_c$:\n$$ e^{-(R_c+1)/\\xi} \\le \\frac{\\varepsilon_\\omega^2(1-e^{-1/\\xi})}{4} $$\n$$ -(R_c+1)/\\xi \\le \\ln\\left( \\frac{\\varepsilon_\\omega^2(1-e^{-1/\\xi})}{4} \\right) $$\n$$ R_c + 1 \\ge -\\xi \\ln\\left( \\frac{\\varepsilon_\\omega^2(1-e^{-1/\\xi})}{4} \\right) $$\n$$ R_c \\ge -\\xi \\ln\\left( \\frac{\\varepsilon_\\omega^2(1-e^{-1/\\xi})}{4} \\right) - 1 $$\nThe smallest non-negative integer $R_c$ satisfying this is $R_\\star$. The result is obtained by taking the ceiling of the right-hand side and ensuring it is not negative.\n$$ R_\\star(\\xi, \\varepsilon_\\omega) = \\max\\left(0, \\left\\lceil -\\xi \\ln\\left( \\frac{\\varepsilon_\\omega^2(1-e^{-1/\\xi})}{4} \\right) - 1 \\right\\rceil\\right) $$\nThis provides a rigorous and computationally cheap way to determine a sufficient real-space cutoff for a desired frequency accuracy.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nimport math\n\ndef solve():\n    \"\"\"\n    Solves the lattice dynamics problem for the given test cases.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (3.0, 5, np.pi/3, 0.02),\n        (3.0, 31, np.pi/3, 0.02),\n        (0.5, 5, np.pi/3, 0.02),\n        (3.0, 31, np.pi/50, 0.005),\n        (3.0, 7, np.pi, 0.02),\n        (1.5, 9, 2*np.pi/3, 0.02)\n    ]\n\n    results = []\n    for xi, N, q, eps_omega in test_cases:\n        # 1. Reference frequency omega_ref\n        # An exact analytical expression is used for the infinite sum.\n        # This is equivalent to summing to convergence.\n        # Formula used: omega_ref^2 = 2 * (sum(r^n) - Re[sum((r*e^iq)^n)])\n        # where r = exp(-1/xi).\n        r = np.exp(-1.0 / xi)\n        \n        # Sum of r^n from n=1 to inf\n        sum_r_n = r / (1.0 - r)\n        \n        # Sum of r^n * cos(n*q) from n=1 to inf\n        sum_r_n_cos_nq = (r * np.cos(q) - r**2) / (1.0 - 2.0 * r * np.cos(q) + r**2)\n\n        # omega_ref^2 with m=1\n        omega_ref_sq = 2.0 * (sum_r_n - sum_r_n_cos_nq)\n        omega_ref = np.sqrt(omega_ref_sq)\n\n        # 2. Supercell-truncated frequency omega_cut\n        # The sum for force constants is truncated at Rc.\n        Rc = (N - 1) // 2\n        omega_cut_sq = 0.0\n        # Sum is performed using the 4*sin^2 form for numerical stability at q=0 although not strictly needed here.\n        for n in range(1, Rc + 1):\n            phi_n = np.exp(-n / xi)\n            omega_cut_sq += 4.0 * phi_n * (np.sin(q * n / 2.0))**2\n        omega_cut = np.sqrt(omega_cut_sq)\n        err_cut = abs(omega_cut - omega_ref)\n\n        # 3. q-aliasing frequency omega_alias\n        # Uses aliased force constants due to periodic image summation.\n        Rc_alias = (N - 1) // 2\n        omega_alias_sq = 0.0\n        denom_phi_alias = 1.0 - np.exp(-N / xi)\n        \n        # Since all test N are odd, the sum is straightforward.\n        for n in range(1, Rc_alias + 1):\n            # Aliased force constant Phi_alias(n)\n            phi_alias_n = (np.exp(-n / xi) + np.exp(-(N - n) / xi)) / denom_phi_alias\n            omega_alias_sq += 4.0 * phi_alias_n * (np.sin(q * n / 2.0))**2\n        omega_alias = np.sqrt(omega_alias_sq)\n        err_alias = abs(omega_alias - omega_ref)\n\n        # 4. Optimal cutoff R_star\n        # Derived from bounding the tail of the force constant sum.\n        # Condition: 4 * (e^-(Rc+1)/xi / (1-e^-1/xi)) <= eps_omega^2\n        log_argument = (eps_omega**2 * (1.0 - r)) / 4.0\n        \n        if log_argument >= 1.0:\n            # The bound is satisfied even for Rc = -1, so the smallest\n            # non-negative integer cutoff is 0.\n            R_star = 0\n        else:\n            # Rc >= -xi * log(log_argument) - 1\n            R_star_float = -xi * np.log(log_argument) - 1.0\n            # R_star is the smallest non-negative integer satisfying the condition.\n            R_star = max(0, math.ceil(R_star_float))\n            \n        # Append results, rounding floats to 8 decimal places.\n        results.append([round(err_cut, 8), round(err_alias, 8), R_star])\n\n    # Final print statement in the exact required format.\n    # The format string ensures that floats are printed with 8 decimal places.\n    output_str = \"[\" + \",\".join([f\"[{r[0]:.8f},{r[1]:.8f},{r[2]}]\" for r in results]) + \"]\"\n\n    print(output_str)\n\nsolve()\n```"
        },
        {
            "introduction": "Beyond numerical convergence, a computed phonon spectrum must obey the fundamental physical symmetries of the crystal. This exercise focuses on translational invariance, which manifests as the Acoustic Sum Rule (ASR) and requires the three acoustic phonon branches to have zero frequency at the Brillouin zone center ($\\Gamma$ point). You will implement a diagnostic to quantify violations of the ASR, which cause unphysical \"spurious gaps,\" and then apply the standard correction procedure, a critical step for ensuring the physical validity of any practical phonon calculation .",
            "id": "3460360",
            "problem": "You are tasked with designing and implementing a diagnostic for detecting and quantifying spurious gaps in the acoustic phonon branches at the Brillouin zone center (the $\\Gamma$ point) arising from violations of translational invariance (also called the Acoustic Sum Rule (ASR)) in the harmonic interatomic force-constant matrix $\\Phi(R)$.\n\nBegin from the following fundamental base:\n- In the harmonic approximation, the equations of motion for lattice vibrations are given by Newton's second law applied to small displacements, which leads to a mass-weighted eigenvalue problem for the dynamical matrix at wavevector $q$:\n$$\nD(q)\\,e_\\nu(q) \\;=\\; \\omega_\\nu(q)^2\\, e_\\nu(q),\n$$\nwhere $D(q)$ is the mass-weighted dynamical matrix and $\\omega_\\nu(q)$ are the angular frequencies.\n- At the Brillouin zone center $q = \\Gamma$, rigid translation of the entire crystal must produce no restoring force due to translational invariance, which implies the Acoustic Sum Rule: the three acoustic branches must satisfy $\\omega_\\nu(\\Gamma)=0$ for $\\nu\\in\\{1,2,3\\}$.\n\nThe diagnostic must quantify the size of any spurious gaps at $\\Gamma$ in the three acoustic branches when translational invariance is relaxed (not enforced) in the $\\Gamma$-summed interatomic force-constant matrix. You will then enforce translational invariance by adjusting only the on-site $3\\times 3$ blocks so that each atom's block-row sum becomes the $3\\times 3$ zero matrix, and recompute the diagnostic. The diagnostic should be larger when the spurious gaps are larger, and it should vanish when the three acoustic branches at $\\Gamma$ are exactly zero in a numerically stable system.\n\nYour program must:\n- Implement the mass-weighted dynamical matrix at $\\Gamma$:\n$$\nD(\\Gamma) \\;=\\; M^{-\\frac{1}{2}}\\; \\Phi_\\Gamma\\; M^{-\\frac{1}{2}},\n$$\nwhere $M$ is a block-diagonal mass matrix with $3\\times 3$ diagonal blocks $m_i I_3$ for atom index $i$, and $\\Phi_\\Gamma$ is the $\\Gamma$-summed interatomic force-constant matrix over the periodic images.\n- Compute all eigenvalues $\\lambda_k$ of $D(\\Gamma)$, which correspond to $\\omega_k^2$.\n- Define a penalty diagnostic that targets spurious acoustic gaps at $\\Gamma$ by taking the mean absolute value of the three eigenvalues with the smallest absolute magnitude:\n$$\np \\;=\\; \\frac{1}{3}\\sum_{k=1}^{3} \\left| \\lambda_{(k)} \\right|,\n$$\nwhere $\\lambda_{(k)}$ are the three eigenvalues of $D(\\Gamma)$ with the smallest absolute values. This diagnostic penalizes any nonzero $\\omega$ in the three acoustic branches and treats small imaginary frequencies symmetrically because $\\lambda=\\omega^2$.\n- Evaluate $p$ for the provided test suite both without enforcing translational invariance (relaxed) and after enforcing translational invariance (enforced), where enforcement is achieved by minimally modifying only the on-site $3\\times 3$ blocks so that, for each atom $i$, the block-row sum $\\sum_j \\Phi_{ij}$ becomes the $3\\times 3$ zero matrix.\n\nUnits and numerical requirements:\n- All data are provided in reduced units. Let the reduced time unit be $\\tau$. The eigenvalues $\\lambda_k$ have units of $\\tau^{-2}$, and the diagnostic $p$ must be reported in $\\tau^{-2}$. Express all outputs as floating-point numbers in $\\tau^{-2}$ with standard decimal notation.\n- Angles do not appear in this problem, so no angle units are required.\n- No percentages appear in this problem.\n\nTest suite:\nFor each test case, you are given the number of atoms $N$, the mass vector $m \\in \\mathbb{R}^N$, and the $\\Gamma$-summed interatomic force-constant matrix $\\Phi_\\Gamma \\in \\mathbb{R}^{3N\\times 3N}$ in reduced units. In all cases below, the matrix $\\Phi_\\Gamma$ is symmetric. The $3\\times 3$ identity is denoted $I_3$.\n\n- Test case $1$ (single atom, deliberately broken ASR):\n  - $N = 1$.\n  - $m = [\\,1.0\\,]$.\n  - $\\Phi_\\Gamma$ is the $3\\times 3$ matrix:\n    $$\n    \\Phi_\\Gamma^{(1)} \\;=\\;\n    \\begin{bmatrix}\n    0.02 & 0.001 & -0.002\\\\\n    0.001 & -0.01 & 0.0005\\\\\n    -0.002 & 0.0005 & 0.005\n    \\end{bmatrix}.\n    $$\n\n- Test case $2$ (two atoms, isotropic spring with small on-site perturbation on atom $1$):\n  - $N = 2$.\n  - $m = [\\,1.0,\\;2.0\\,]$.\n  - Define $K=0.5$ and $I_3$ the identity. Let\n    $$\n    A \\;=\\; K\\,I_3,\\quad\n    B \\;=\\; -K\\,I_3,\\quad\n    C \\;=\\; K\\,I_3,\\quad\n    \\Delta \\;=\\; \\mathrm{diag}(0.01,\\,-0.02,\\;0.005).\n    $$\n    Then\n    $$\n    \\Phi_\\Gamma^{(2)} \\;=\\;\n    \\begin{bmatrix}\n      A + \\Delta & B\\\\\n      B & C\n    \\end{bmatrix},\n    $$\n    a $6\\times 6$ matrix with $3\\times 3$ blocks.\n\n- Test case $3$ (two atoms, anisotropic coupling with distinct masses and on-site perturbations on both atoms):\n  - $N = 2$.\n  - $m = [\\,1.5,\\;1.0\\,]$.\n  - Define\n    $$\n    K_{\\mathrm{diag}} \\;=\\; \\mathrm{diag}(0.8,\\;0.6,\\;0.4),\n    $$\n    and symmetric on-site perturbations\n    $$\n    E \\;=\\; \\begin{bmatrix}\n      0.05 & 0.01 & 0.0\\\\\n      0.01 & -0.03 & 0.005\\\\\n      0.0 & 0.005 & 0.02\n    \\end{bmatrix},\\quad\n    F \\;=\\; \\begin{bmatrix}\n      -0.02 & -0.005 & 0.0\\\\\n      -0.005 & 0.015 & -0.004\\\\\n      0.0 & -0.004 & -0.01\n    \\end{bmatrix}.\n    $$\n    Construct\n    $$\n    A \\;=\\; K_{\\mathrm{diag}} + E,\\quad\n    B \\;=\\; -K_{\\mathrm{diag}},\\quad\n    C \\;=\\; K_{\\mathrm{diag}} + F,\n    $$\n    and assemble\n    $$\n    \\Phi_\\Gamma^{(3)} \\;=\\;\n    \\begin{bmatrix}\n      A & B\\\\\n      B & C\n    \\end{bmatrix},\n    $$\n    a $6\\times 6$ matrix with $3\\times 3$ blocks.\n\nEnforcement of translational invariance (ASR) to be applied between the two evaluations for each test case:\n- For each atom index $i \\in \\{1,\\dots,N\\}$, compute the $3\\times 3$ block-row sum $S_i = \\sum_{j=1}^N \\Phi_{ij}$, where $\\Phi_{ij}$ denotes the $3\\times 3$ block of $\\Phi_\\Gamma$ in block row $i$ and block column $j$.\n- Modify only the on-site block for each atom as $\\Phi_{ii} \\leftarrow \\Phi_{ii} - S_i$ to ensure that the new block-row sum becomes the $3\\times 3$ zero matrix for each atom $i$.\n\nYour program must compute the penalty $p$ for each test case in two modes: without enforcing ASR (relaxed) and with ASR enforced (enforced). The final output must be a single line containing a comma-separated list of floating-point numbers in square brackets. The sequence must list, for each test case in order, first the relaxed diagnostic and then the enforced diagnostic. For the three test cases above, the output format must be:\n\"[p1_relaxed,p1_enforced,p2_relaxed,p2_enforced,p3_relaxed,p3_enforced]\"\nwhere each $p$ is expressed in $\\tau^{-2}$ as a floating-point number.",
            "solution": "The problem requires the design and implementation of a diagnostic to quantify spurious energy gaps in the acoustic phonon branches at the Brillouin zone center ($\\Gamma$ point). These gaps arise from violations of translational invariance, also known as the Acoustic Sum Rule (ASR), in the interatomic force-constant matrix. The solution involves calculating a defined penalty diagnostic $p$ for a given force-constant matrix, and then recalculating it after applying a correction that enforces the ASR.\n\nThe theoretical foundation lies in lattice dynamics within the harmonic approximation. The equations of motion for atoms in a crystal lattice are described by a mass-weighted eigenvalue problem:\n$$\nD(q)\\,e_\\nu(q) = \\omega_\\nu(q)^2\\, e_\\nu(q)\n$$\nHere, $q$ is a wavevector in the first Brillouin zone, $\\omega_\\nu(q)$ is the angular frequency of the $\\nu$-th phonon mode, $e_\\nu(q)$ is the corresponding polarization vector (eigenvector), and $D(q)$ is the $3N \\times 3N$ mass-weighted dynamical matrix, where $N$ is the number of atoms in the unit cell.\n\nAt the Brillouin zone center ($q=\\Gamma$, which corresponds to $(0,0,0)$), the dynamical matrix is defined as:\n$$\nD(\\Gamma) = M^{-\\frac{1}{2}}\\; \\Phi_\\Gamma\\; M^{-\\frac{1}{2}}\n$$\n$\\Phi_\\Gamma$ is the $3N \\times 3N$ real, symmetric interatomic force-constant matrix summed over all periodic images of the unit cell. $M$ is a $3N \\times 3N$ block-diagonal mass matrix, where the $i$-th $3 \\times 3$ block on the diagonal is $m_i I_3$, with $m_i$ being the mass of the $i$-th atom and $I_3$ being the $3 \\times 3$ identity matrix. Consequently, $M^{-\\frac{1}{2}}$ is a diagonal matrix whose $k$-th diagonal element is $1/\\sqrt{m_i}$, where atom $i$ is associated with the Cartesian coordinate $k$. The eigenvalues $\\lambda_k$ of $D(\\Gamma)$ are the squared frequencies, $\\lambda_k = \\omega_k^2$.\n\nA fundamental principle of crystal physics is translational invariance: a rigid translation of the entire crystal cannot create any restoring forces. At the $\\Gamma$ point, this principle manifests as the Acoustic Sum Rule (ASR). It dictates that the three phonon branches corresponding to uniform translation of the crystal along three orthogonal directions (the acoustic branches) must have zero frequency. Mathematically, for a system satisfying the ASR:\n$$\n\\omega_\\nu(\\Gamma) = 0 \\quad \\text{for } \\nu \\in \\{1, 2, 3\\}\n$$\nThis implies that exactly three eigenvalues of $D(\\Gamma)$ must be zero. The ASR is satisfied if and only if the sum of interatomic force constants over all atoms for any given atom is zero, which for the $\\Gamma$-summed matrix $\\Phi_\\Gamma$ translates to a condition on its block-row sums:\n$$\n\\sum_{j=1}^N \\Phi_{ij} = \\mathbf{0}_{3\\times3} \\quad \\text{for all } i \\in \\{1, \\dots, N\\}\n$$\nwhere $\\Phi_{ij}$ is the $3 \\times 3$ block coupling atoms $i$ and $j$, and $\\mathbf{0}_{3\\times3}$ is the $3 \\times 3$ zero matrix.\n\nIn computational practice, $\\Phi_\\Gamma$ may not perfectly satisfy this condition due to numerical approximations (e.g., finite cutoffs for interactions). This violation leads to non-zero frequencies for the acoustic modes at $\\Gamma$, creating a spurious, unphysical energy gap.\n\nThe proposed diagnostic, $p$, quantifies the magnitude of this violation. It is defined as the mean absolute value of the three eigenvalues of $D(\\Gamma)$ with the smallest absolute magnitudes:\n$$\np = \\frac{1}{3}\\sum_{k=1}^{3} \\left| \\lambda_{(k)} \\right|\n$$\nwhere $\\lambda_{(k)}$ are the three eigenvalues with the smallest $|\\lambda|$. This choice correctly targets the acoustic modes, which should have eigenvalues of $0$. Using the absolute value ensures that small negative eigenvalues (corresponding to imaginary frequencies and indicating structural instability), which can arise from numerical noise, are treated symmetrically to small positive ones. A larger value of $p$ indicates a more severe violation of the ASR.\n\nThe computational procedure is as follows:\n1.  **Relaxed Calculation**:\n    a. For a given test case ($N$, $m$, $\\Phi_\\Gamma$), construct the $3N \\times 3N$ matrix $M^{-\\frac{1}{2}}$. This is a diagonal matrix with diagonal elements $(m_0^{-1/2}, m_0^{-1/2}, m_0^{-1/2}, m_1^{-1/2}, \\dots)$.\n    b. Construct the dynamical matrix $D(\\Gamma) = M^{-\\frac{1}{2}} \\Phi_\\Gamma M^{-\\frac{1}{2}}$. Since $\\Phi_\\Gamma$ is symmetric and $M^{-\\frac{1}{2}}$ is diagonal, $D(\\Gamma)$ is also symmetric.\n    c. Compute all $3N$ eigenvalues of $D(\\Gamma)$.\n    d. Identify the three eigenvalues with the smallest absolute values.\n    e. Calculate $p_{\\text{relaxed}}$ using the defined formula.\n\n2.  **ASR Enforcement and Enforced Calculation**:\n    a. To enforce the ASR, the $\\Phi_\\Gamma$ matrix is modified. For each atom $i$, the block-row sum $S_i = \\sum_{j=1}^N \\Phi_{ij}$ is computed.\n    b. The on-site block $\\Phi_{ii}$ is then corrected: $\\Phi_{ii}^{\\text{enforced}} = \\Phi_{ii} - S_i$. This minimal adjustment ensures the new block-row sum $\\sum_{j=1}^N \\Phi_{ij}^{\\text{enforced}}$ is the $3 \\times 3$ zero matrix, thereby satisfying the ASR. All other blocks $\\Phi_{ij}$ ($i \\neq j$) remain unchanged.\n    c. A new dynamical matrix $D(\\Gamma)^{\\text{enforced}}$ is constructed using the corrected force-constant matrix $\\Phi_\\Gamma^{\\text{enforced}}$.\n    d. The penalty $p_{\\text{enforced}}$ is calculated from the eigenvalues of this new dynamical matrix. For a correctly implemented enforcement, $p_{\\text{enforced}}$ is expected to be zero (or numerically indistinguishable from zero).\n\nBy comparing $p_{\\text{relaxed}}$ and $p_{\\text{enforced}}$, one can quantify the initial ASR violation and confirm its correction.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the diagnostic calculations for all test cases.\n    \"\"\"\n\n    def calculate_penalty(N, m, Phi_Gamma):\n        \"\"\"\n        Calculates the diagnostic penalty p for a given system.\n\n        Args:\n            N (int): Number of atoms.\n            m (np.ndarray): Array of atomic masses of shape (N,).\n            Phi_Gamma (np.ndarray): Gamma-summed force-constant matrix of shape (3N, 3N).\n\n        Returns:\n            float: The penalty diagnostic p.\n        \"\"\"\n        if N == 0:\n            return 0.0\n\n        # Construct the inverse square root of the mass matrix M.\n        # This is a diagonal matrix.\n        m_inv_sqrt_diag = np.repeat(1.0 / np.sqrt(m), 3)\n        M_inv_sqrt = np.diag(m_inv_sqrt_diag)\n\n        # Construct the dynamical matrix D(Gamma).\n        # D = M_inv_sqrt @ Phi_Gamma @ M_inv_sqrt\n        # Since M_inv_sqrt is diagonal, this is equivalent to element-wise multiplication\n        # of rows and columns.\n        D_Gamma = Phi_Gamma * np.outer(m_inv_sqrt_diag, m_inv_sqrt_diag)\n        \n        # D_Gamma is real and symmetric, so we can use eigh for numerical stability.\n        eigenvalues = np.linalg.eigh(D_Gamma)[0]\n\n        # The problem asks for the three eigenvalues with the smallest absolute magnitude.\n        # Find the indices that would sort the eigenvalues by their absolute value.\n        sorted_indices = np.argsort(np.abs(eigenvalues))\n        \n        # Select the three smallest magnitude eigenvalues.\n        smallest_three_eigs = eigenvalues[sorted_indices[:3]]\n\n        # Calculate the penalty diagnostic p.\n        p = (1.0 / 3.0) * np.sum(np.abs(smallest_three_eigs))\n        \n        return p\n\n    def enforce_asr(N, Phi_Gamma):\n        \"\"\"\n        Enforces the Acoustic Sum Rule (ASR) on the Phi_Gamma matrix.\n\n        Args:\n            N (int): Number of atoms.\n            Phi_Gamma (np.ndarray): The force-constant matrix to be corrected.\n\n        Returns:\n            np.ndarray: The ASR-enforced force-constant matrix.\n        \"\"\"\n        Phi_enforced = Phi_Gamma.copy()\n        dim = 3 * N\n        \n        # Loop over each atom i to calculate the block-row sum\n        for i in range(N):\n            row_start = 3 * i\n            row_end = 3 * (i + 1)\n            \n            # The block-row sum S_i = sum_j Phi_{ij}\n            block_row_sum = np.sum(Phi_enforced[row_start:row_end, :], axis=1)\n            # Reshape it to 3x3 block sum\n            # We are summing up all columns, so we get a 3-element vector.\n            # To get a 3x3 block-row sum, we must sum blocks.\n            S_i = np.zeros((3, 3))\n            for j in range(N):\n                col_start = 3 * j\n                col_end = 3 * (j + 1)\n                S_i += Phi_enforced[row_start:row_end, col_start:col_end]\n            \n            # Modify the on-site block Phi_ii\n            # Phi_{ii} <- Phi_{ii} - S_i\n            Phi_enforced[row_start:row_end, row_start:row_end] -= S_i\n            \n        return Phi_enforced\n\n    # --- Test Case Definitions ---\n\n    # Test Case 1\n    N1 = 1\n    m1 = np.array([1.0])\n    Phi_Gamma_1 = np.array([\n        [0.02, 0.001, -0.002],\n        [0.001, -0.01, 0.0005],\n        [-0.002, 0.0005, 0.005]\n    ])\n\n    # Test Case 2\n    N2 = 2\n    m2 = np.array([1.0, 2.0])\n    K2 = 0.5\n    I3 = np.identity(3)\n    A2 = K2 * I3\n    B2 = -K2 * I3\n    C2 = K2 * I3\n    Delta2 = np.diag([0.01, -0.02, 0.005])\n    Phi_Gamma_2 = np.block([\n        [A2 + Delta2, B2],\n        [B2, C2]\n    ])\n\n    # Test Case 3\n    N3 = 2\n    m3 = np.array([1.5, 1.0])\n    K_diag3 = np.diag([0.8, 0.6, 0.4])\n    E3 = np.array([\n        [0.05, 0.01, 0.0],\n        [0.01, -0.03, 0.005],\n        [0.0, 0.005, 0.02]\n    ])\n    F3 = np.array([\n        [-0.02, -0.005, 0.0],\n        [-0.005, 0.015, -0.004],\n        [0.0, -0.004, -0.01]\n    ])\n    A3 = K_diag3 + E3\n    B3 = -K_diag3\n    C3 = K_diag3 + F3\n    Phi_Gamma_3 = np.block([\n        [A3, B3],\n        [B3, C3]\n    ])\n\n    test_cases = [\n        (N1, m1, Phi_Gamma_1),\n        (N2, m2, Phi_Gamma_2),\n        (N3, m3, Phi_Gamma_3),\n    ]\n\n    results = []\n    for N, m, Phi_relaxed in test_cases:\n        # Calculate penalty for the relaxed (original) matrix\n        p_relaxed = calculate_penalty(N, m, Phi_relaxed)\n        results.append(p_relaxed)\n        \n        # Enforce ASR\n        Phi_enforced = enforce_asr(N, Phi_relaxed)\n        \n        # Calculate penalty for the ASR-enforced matrix\n        p_enforced = calculate_penalty(N, m, Phi_enforced)\n        results.append(p_enforced)\n\n    # Format and print the final results\n    print(f\"[{','.join(f'{r:.15f}' for r in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "A physically valid harmonic model must not only respect symmetries but also describe a dynamically stable lattice, meaning all squared phonon frequencies $\\omega^2(k)$ must be non-negative. This advanced practice addresses the common problem of \"imaginary modes\" ($\\omega^2(k) \\lt 0$), which signal an instability in the underlying force constant model. You will learn to diagnose the specific interatomic interactions responsible for the instability and, by formulating the fix as a convex optimization problem, determine the minimal correction required to restore lattice stability while preserving physical constraints .",
            "id": "3460382",
            "problem": "Consider a one-dimensional Bravais lattice with a single atom per primitive cell and scalar displacements along the chain. Under the harmonic approximation and periodic boundary conditions, the equations of motion follow from Newton's Second Law and the linear force-displacement relation. The real-space interatomic force constants are specified by a set of pair interactions $\\,\\{\\Phi(R)\\}\\,$ coupling an atom at position $\\,0\\,$ to atoms at positions $\\,\\pm R\\,$, with $\\,R \\in \\{a,2a,3a,\\dots\\}\\,$. Assume $\\,\\Phi(R)=\\Phi(-R)\\,$ due to inversion symmetry and that the on-site term satisfies translational invariance (the acoustic sum rule) implied by the pairwise representation.\n\nUsing the Bloch ansatz for normal modes and the definition of the dynamical matrix in reciprocal space, it follows that the squared angular frequency $\\,\\omega^2(k)\\,$ is the scalar eigenvalue of the one-dimensional dynamical matrix $\\,D(k)\\,$ divided by the mass. You must:\n- derive the scalar $\\,D(k)\\,$ for a one-dimensional monatomic chain with symmetric pair interactions $\\,\\{\\Phi(R)\\}\\,$, expressed in terms of $\\,\\{\\Phi(R)\\}\\,$ and the wavevector $\\,k\\,$,\n- identify the condition on $\\,D(k)\\,$ that characterizes imaginary modes,\n- and frame a minimal correction problem that perturbs the given $\\,\\{\\Phi(R)\\}\\,$ by $\\,\\{\\delta \\Phi(R)\\}\\,$ to eliminate imaginary modes on a prescribed $\\,k\\,$-grid while respecting the symmetry $\\,\\Phi(R)=\\Phi(-R)\\,$ and ensuring physical nonnegativity of pair interaction strengths $\\,\\Phi(R) \\ge 0\\,$ for $\\,R>0\\,$.\n\nYour program must implement the following for each provided test case:\n1) Given a list of neighbor distances $\\,\\{R_i\\}\\,$ and initial pair force constants $\\,\\{\\Phi_i\\}\\,$ for $\\,i=1,\\dots,N\\,$, compute $\\,D(k)\\,$ on the specified $\\,k\\,$-grid (angles in radians). Use dimensionless units with mass $\\,m=1\\,$ and lattice constant $\\,a=1\\,$.\n2) Diagnose imaginary modes: collect all grid points where $\\,D(k) < 0\\,$. For diagnosis, compute the sensitivity $\\,\\partial D(k)/\\partial \\Phi_i\\,$ at each unstable $\\,k\\,$ and build a nonnegative least squares estimate $\\,\\delta \\Phi^{\\mathrm{diag}}\\,$ that approximately satisfies the per-point stabilization requirements. Define the diagnosed culprit neighbor index as the $\\,i\\,$ (zero-based) with the largest component of $\\,\\delta \\Phi^{\\mathrm{diag}}\\,$. If no imaginary modes are present, the culprit index must be $-1$.\n3) Compute the minimal edit $\\,\\{\\delta \\Phi_i\\}\\,$ that restores stability by solving the following convex optimization problem: minimize the Euclidean norm $\\,\\sqrt{\\sum_i (\\delta \\Phi_i)^2}\\,$ subject to linear inequality constraints that enforce $\\,D(k) \\ge 0\\,$ for all $\\,k\\,$ in the grid, and the physical constraints $\\,\\Phi_i + \\delta \\Phi_i \\ge 0\\,$ for all $\\,i\\,$. The corrected force constants are $\\,\\Phi_i' = \\Phi_i + \\delta \\Phi_i\\,$. Angles are in radians. All quantities are dimensionless.\n4) For each test case, output a result list containing the culprit index followed by the corrected force constants $\\,\\{\\Phi_i'\\}\\,$, each rounded to $\\,6\\,$ decimal places.\n\nDefinitions and requirements to use as the fundamental base:\n- Newton’s Second Law: $\\,m \\,\\ddot{u}_n = F_n\\,$, where $\\,u_n\\,$ is the displacement of atom $\\,n\\,$.\n- Linear force-response in the harmonic approximation: forces are linear in displacements through the interatomic force constants $\\,\\Phi(R)\\,$.\n- Bloch’s theorem for lattice vibrations: trial solutions of the form $\\,u_n \\propto e^{i(kn a - \\omega t)}\\,$.\n- Imaginary modes correspond to $\\,\\omega^2(k)  0\\,$, equivalently a negative scalar $\\,D(k)\\,$ when $\\,m=1\\,$.\n\nYour program must use the following test suite. For each case, the neighbor set $\\,\\{R_i\\}\\,$, the initial force constants $\\,\\{\\Phi_i\\}\\,$, and the $\\,k\\,$-grid are provided. Use angles in radians. No physical units are involved; treat all quantities as dimensionless.\n\n- Test Case $\\,1\\,$ (general instability driven by second neighbor):\n  - $\\,\\{R_i\\} = [1, 2]\\,$\n  - $\\,\\{\\Phi_i\\} = [1.0, -1.2]\\,$\n  - $\\,k\\,$-grid $\\,\\mathcal{K} = [\\pi/6, \\pi/3, \\pi/2, 2\\pi/3, 5\\pi/6, \\pi]\\,$\n- Test Case $\\,2\\,$ (third neighbor softening):\n  - $\\,\\{R_i\\} = [1, 2, 3]\\,$\n  - $\\,\\{\\Phi_i\\} = [0.2, 0.05, -0.1]\\,$\n  - $\\,k\\,$-grid $\\,\\mathcal{K} = [\\pi/6, \\pi/3, \\pi/2, 2\\pi/3, 5\\pi/6, \\pi]\\,$\n- Test Case $\\,3\\,$ (edge case with near-zero stiffness except a weak unstable third neighbor):\n  - $\\,\\{R_i\\} = [1, 2, 3]\\,$\n  - $\\,\\{\\Phi_i\\} = [0.0, 0.0, -0.01]\\,$\n  - $\\,k\\,$-grid $\\,\\mathcal{K} = [\\pi/6, \\pi/3, \\pi/2, 2\\pi/3, 5\\pi/6, \\pi]\\,$\n- Test Case $\\,4\\,$ (already stable reference):\n  - $\\,\\{R_i\\} = [1, 2]\\,$\n  - $\\,\\{\\Phi_i\\} = [0.8, 0.2]\\,$\n  - $\\,k\\,$-grid $\\,\\mathcal{K} = [\\pi/6, \\pi/3, \\pi/2, 2\\pi/3, 5\\pi/6, \\pi]\\,$\n\nFinal output format:\n- Your program should produce a single line of output containing a list of results for the four test cases. Each test case result must be a list of the form `[culprit,$\\Phi_1'$,$\\Phi_2'$,...]` with all floating-point numbers rounded to $\\,6\\,$ decimal places. Aggregate them in a single bracketed list with comma-separated test case results and no spaces. For example: `[[i_1,$\\phi_{1,1}'$,...],[i_2,$\\phi_{2,1}'$,...],[i_3,...],[i_4,...]]`.",
            "solution": "The problem statement has been critically examined and is determined to be valid. It is scientifically sound, self-contained, and well-posed. It presents a standard problem in computational materials science concerning lattice stability, framed as a convex optimization problem, which is a recognized and appropriate methodology. All necessary data and definitions are provided.\n\nThe solution proceeds in three stages as delineated by the problem: first, the derivation of the dynamical matrix for the one-dimensional chain; second, the formulation of a diagnostic procedure to identify sources of instability; and third, the specification of a minimal correction algorithm based on convex optimization.\n\n**1. Derivation of the Dynamical Matrix $\\,D(k)\\,$**\n\nWe consider a one-dimensional monatomic Bravais lattice with lattice constant $\\,a=1\\,$ and atomic mass $\\,m=1\\,$. Let $\\,u_n\\,$ be the scalar displacement of the atom at lattice site $\\,n\\,$. The equation of motion for this atom, under the harmonic approximation, is given by Newton's Second Law: $\\,m \\ddot{u}_n = F_n\\,$.\n\nThe force $\\,F_n\\,$ on atom $\\,n\\,$ arises from its interaction with other atoms. For symmetric pairwise interactions characterized by force constants $\\,\\Phi(R_i)\\,$, where $\\,R_i\\,$ is the distance to the $\\,i\\,$'th neighbor shell, the force is:\n$$\nF_n = \\sum_i \\Phi(R_i) \\left[ (u_{n+R_i} - u_n) + (u_{n-R_i} - u_n) \\right]\n$$\nHere, we use the fact that the problem is in dimensionless units with $\\,a=1\\,$, so the position of the atom in cell $\\,p\\,$ is simply $\\,p\\,$. The interaction with an atom at distance $\\,R_i\\,$ corresponds to an interaction with atoms at sites $\\,n \\pm R_i\\,$. The equation of motion becomes:\n$$\nm \\ddot{u}_n = \\sum_i \\Phi(R_i) \\left( u_{n+R_i} + u_{n-R_i} - 2u_n \\right)\n$$\nWe seek normal mode solutions of the form given by Bloch's theorem:\n$$\nu_n(t) = A e^{i(kna - \\omega t)} = A e^{i(kn - \\omega t)}\n$$\nsince $\\,a=1\\,$. The displacement of a neighbor atom at site $\\,n \\pm R_i\\,$ is:\n$$\nu_{n \\pm R_i}(t) = A e^{i(k(n \\pm R_i) - \\omega t)} = u_n(t) e^{\\pm ikR_i}\n$$\nSubstituting these into the equation of motion yields:\n$$\nm (-\\omega^2) u_n = \\sum_i \\Phi(R_i) \\left( u_n e^{ikR_i} + u_n e^{-ikR_i} - 2u_n \\right)\n$$\nDividing by $\\,u_n\\,$ (which is non-zero) gives:\n$$\n-m \\omega^2 = \\sum_i \\Phi(R_i) (e^{ikR_i} + e^{-ikR_i} - 2)\n$$\nUsing the identity $\\,2\\cos(\\theta) = e^{i\\theta} + e^{-i\\theta}\\,$, we have:\n$$\n-m \\omega^2 = \\sum_i \\Phi(R_i) (2\\cos(kR_i) - 2)\n$$\nRearranging the terms, we find the dispersion relation $\\,\\omega^2(k)\\,$:\n$$\n\\omega^2(k) = \\frac{1}{m} \\sum_i 2\\Phi(R_i) (1 - \\cos(kR_i))\n$$\nThe problem defines the scalar dynamical matrix $\\,D(k)\\,$ such that $\\,\\omega^2(k) = D(k)/m\\,$. With the provided list of neighbor distances $\\,\\{R_i\\}\\,$ and force constants $\\,\\{\\Phi_i\\}\\,$, and setting $\\,m=1\\,$, we arrive at the expression for $\\,D(k)\\,$:\n$$\nD(k) = \\sum_i 2\\Phi_i (1 - \\cos(kR_i))\n$$\nThis expression inherently satisfies the acoustic sum rule, ensuring that $\\,D(k) \\to 0\\,$ as $\\,k \\to 0\\,$, which corresponds to the translational invariance of the crystal.\n\n**2. Condition for Imaginary Modes and Diagnostic Procedure**\n\nLattice instability is indicated by the presence of imaginary frequencies, $\\,\\omega \\in i\\mathbb{R}\\,$. This occurs when $\\,\\omega^2(k)  0\\,$. Since the mass $\\,m\\,$ is positive, this condition is equivalent to a negative eigenvalue of the dynamical matrix:\n$$\nD(k)  0\n$$\nTo diagnose the cause of such an instability, we analyze how changes in the force constants $\\,\\{\\Phi_i\\}\\,$ affect $\\,D(k)\\,$. The sensitivity of $\\,D(k)\\,$ with respect to $\\,\\Phi_i\\,$ is the partial derivative:\n$$\n\\frac{\\partial D(k)}{\\partial \\Phi_i} = 2(1 - \\cos(kR_i))\n$$\nLet $\\,\\mathcal{K}_{unstable} = \\{k_j \\mid D(k_j)  0\\}\\,$ be the set of wavevectors on the grid where the system is unstable. For each $\\,k_j \\in \\mathcal{K}_{unstable}\\,$, we seek a correction $\\,\\delta\\Phi \\ge 0\\,$ that restores stability, i.e., $\\,D'(k_j) \\ge 0\\,$. To first order, this is $\\,D(k_j) + \\sum_i \\frac{\\partial D(k_j)}{\\partial \\Phi_i} \\delta\\Phi_i \\approx 0\\,$. This leads to a system of linear equations $\\,A \\delta\\Phi \\approx b\\,$, where $\\,A_{ji} = \\frac{\\partial D(k_j)}{\\partial \\Phi_i}\\,$ and $\\,b_j = -D(k_j)\\,$, with $\\,b_j > 0\\,$.\nThe problem specifies a diagnostic procedure using a nonnegative least squares (NNLS) estimate, $\\,\\delta\\Phi^{\\mathrm{diag}}\\,$. We solve the problem:\n$$\n\\min_{\\delta\\Phi \\ge 0} \\| A \\delta\\Phi - b \\|_2^2\n$$\nThe \"culprit\" interaction is identified as the one corresponding to the largest component of the resulting vector $\\,\\delta\\Phi^{\\mathrm{diag}}\\,$. If no instabilities exist, the culprit index is designated as $-1$.\n\n**3. Minimal Correction via Convex Optimization**\n\nThe full correction requires finding the minimal perturbation $\\,\\delta\\Phi\\,$ that ensures stability across the entire $\\,k\\,$-grid, while also satisfying physical constraints. This is formulated as a convex optimization problem.\n\nThe objective is to minimize the magnitude of the correction, measured by the Euclidean norm of $\\,\\delta\\Phi\\,$. Minimizing $\\,\\|\\delta\\Phi\\|_2\\,$ is equivalent to minimizing its square, $\\,\\|\\delta\\Phi\\|_2^2 = \\sum_i (\\delta\\Phi_i)^2\\,$, which is a quadratic objective function.\n\nThe solution must satisfy two sets of constraints:\n1.  **Stability Constraints**: The corrected dynamical matrix, $\\,D'(k) = D(k) + \\sum_i \\delta\\Phi_i \\frac{\\partial D(k)}{\\partial \\Phi_i}\\,$, must be non-negative for all $\\,k\\,$ on the provided grid $\\,\\mathcal{K}\\,$. This gives a set of linear inequality constraints:\n    $$\n    \\sum_i \\delta\\Phi_i \\cdot 2(1 - \\cos(kR_i)) \\ge -D(k) \\quad \\forall k \\in \\mathcal{K}\n    $$\n2.  **Physicality Constraints**: The corrected force constants, $\\,\\Phi_i' = \\Phi_i + \\delta\\Phi_i\\,$, must be non-negative for all interactions $\\,i\\,$. This is another set of linear inequality constraints:\n    $$\n    \\delta\\Phi_i \\ge -\\Phi_i \\quad \\forall i\n    $$\nThe problem is thus a Quadratic Program (QP):\n$$\n\\begin{align*}\n\\text{minimize} \\quad  \\sum_i (\\delta\\Phi_i)^2 \\\\\n\\text{subject to} \\quad  \\sum_i \\delta\\Phi_i \\cdot 2(1 - \\cos(kR_i)) + D(k) \\ge 0, \\quad \\forall k \\in \\mathcal{K} \\\\\n \\Phi_i + \\delta\\Phi_i \\ge 0, \\quad \\forall i\n\\end{align*}\n$$\nThis QP problem can be solved numerically using standard algorithms, such as Sequential Least Squares Programming (SLSQP), to find the optimal correction vector $\\,\\delta\\Phi^*\\,$. The final, stable force constants are then $\\,\\Phi' = \\Phi + \\delta\\Phi^*\\,$.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import nnls, minimize\n\ndef solve():\n    \"\"\"\n    Main function to solve the lattice stability problem for all test cases.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Test Case 1\n        (np.array([1.0, 2.0]), np.array([1.0, -1.2]), np.array([np.pi/6, np.pi/3, np.pi/2, 2*np.pi/3, 5*np.pi/6, np.pi])),\n        # Test Case 2\n        (np.array([1.0, 2.0, 3.0]), np.array([0.2, 0.05, -0.1]), np.array([np.pi/6, np.pi/3, np.pi/2, 2*np.pi/3, 5*np.pi/6, np.pi])),\n        # Test Case 3\n        (np.array([1.0, 2.0, 3.0]), np.array([0.0, 0.0, -0.01]), np.array([np.pi/6, np.pi/3, np.pi/2, 2*np.pi/3, 5*np.pi/6, np.pi])),\n        # Test Case 4\n        (np.array([1.0, 2.0]), np.array([0.8, 0.2]), np.array([np.pi/6, np.pi/3, np.pi/2, 2*np.pi/3, 5*np.pi/6, np.pi])),\n    ]\n\n    results = []\n    for R, Phi, k_grid in test_cases:\n        result = process_case(R, Phi, k_grid)\n        results.append(result)\n\n    # Format the final output string as specified\n    output_str = \"[\"\n    for i, res in enumerate(results):\n        culprit = res[0]\n        phis_prime = res[1:]\n        phi_str = ','.join(f\"{x:.6f}\" for x in phis_prime)\n        output_str += f\"[{culprit},{phi_str}]\"\n        if i  len(results) - 1:\n            output_str += \",\"\n    output_str += \"]\"\n    \n    print(output_str)\n\ndef process_case(R, Phi, k_grid):\n    \"\"\"\n    Processes a single test case: diagnoses instability and computes the minimal correction.\n    \"\"\"\n    N = len(Phi)\n\n    # Helper function to compute D(k)\n    def compute_D_values(phi_vec, k_vec, R_vec):\n        # S_matrix[j, i] = 2 * (1 - cos(k_j * R_i))\n        S_matrix = 2.0 * (1.0 - np.cos(np.outer(k_vec, R_vec)))\n        # D_values[j] = sum_i(phi_i * S_ji)\n        return np.dot(S_matrix, phi_vec)\n\n    # 1. Initial Stability Check and Diagnosis\n    D_initial = compute_D_values(Phi, k_grid, R)\n    unstable_indices = np.where(D_initial  0)[0]\n\n    if len(unstable_indices) == 0:\n        # System is already stable\n        culprit_index = -1\n        Phi_prime = Phi\n    else:\n        # System is unstable, proceed with diagnosis and correction\n        \n        # 2. Diagnosis\n        k_unstable = k_grid[unstable_indices]\n        # Sensitivity matrix A for unstable k-points\n        A = 2.0 * (1.0 - np.cos(np.outer(k_unstable, R)))\n        # Target vector b\n        b = -D_initial[unstable_indices]\n        \n        # Nonnegative least squares to find diagnostic correction\n        delta_phi_diag, _ = nnls(A, b)\n        culprit_index = int(np.argmax(delta_phi_diag))\n\n        # 3. Correction via Convex Optimization\n        # Objective function: minimize ||delta_Phi||^2\n        objective_fun = lambda delta_phi: np.sum(delta_phi**2)\n\n        # Initial guess for the correction\n        delta_phi_0 = np.zeros(N)\n\n        # Build constraints for the optimizer\n        # The use of default arguments in lambda (e.g., k=k_val) is crucial\n        # to capture the value from the loop iteration correctly.\n        constraints = []\n        \n        # Stability constraints: D'(k) = 0 for all k in the grid\n        for i in range(len(k_grid)):\n            k_val = k_grid[i]\n            D_k_val = D_initial[i]\n            S_k_vec = 2.0 * (1.0 - np.cos(k_val * R))\n            constraints.append({\n                'type': 'ineq',\n                'fun': lambda x, d=D_k_val, s=S_k_vec: d + np.dot(s, x)\n            })\n\n        # Physicality constraints: Phi'_i = Phi_i + delta_Phi_i = 0\n        for i in range(N):\n            phi_val = Phi[i]\n            constraints.append({\n                'type': 'ineq',\n                'fun': lambda x, idx=i, p_val=phi_val: p_val + x[idx]\n            })\n\n        # Solve the Quadratic Programming problem\n        opt_result = minimize(\n            objective_fun,\n            delta_phi_0,\n            method='SLSQP',\n            constraints=constraints,\n            options={'ftol': 1e-9, 'maxiter': 200}\n        )\n\n        delta_phi_optimal = opt_result.x\n        Phi_prime = Phi + delta_phi_optimal\n\n    return [culprit_index] + list(Phi_prime)\n\nif __name__ == \"__main__\":\n    solve()\n```"
        }
    ]
}