{
    "hands_on_practices": [
        {
            "introduction": "配分函数 $Z$ 是统计力学的核心量，但直接计算它在数值上可能充满挑战。由于指数项 $\\exp(-\\beta E_i)$ 可能跨越许多数量级，在有限精度计算中，这很容易导致上溢或下溢。此练习将介绍一种关键的数值稳定技术——提出基态能量，这是“log-sum-exp”技巧的一种形式——这对于几乎所有涉及配分函数的实际计算都至关重要。",
            "id": "3260986",
            "problem": "在统计力学的正则系综中，配分函数定义为 $Z = \\sum_{i} g_{i} \\exp\\!\\big(-E_{i}/(k_{B} T)\\big)$，其中 $g_{i}$ 是能级 $i$ 的简并度，$E_{i}$ 是其能量，$T$ 是绝对温度，$k_{B}$ 是玻尔兹曼常数 ($k_{B}$)。在有限精度浮点运算中，当某些 $\\exp\\!\\big(-E_{i}/(k_{B} T)\\big)$ 的量级极大或极小时，直接对该和式求值可能会遭遇上溢或下溢问题。\n\n从 $Z$ 的定义和指数函数的基本性质出发，通过提出基态能量 $E_{0}$ 来推导 $Z$ 的一个重构形式，使得剩余的和式由量级至多为1的项组成。解释为什么这种重构形式在计算 $\\ln Z$ 时能缓解上溢和下溢问题。\n\n然后，将你的重构形式应用于一个温度为 $T$ 的三能级系统，其简并度和能量以下列无量纲形式给出，使用 $\\beta \\equiv 1/(k_{B} T)$：\n- $\\beta E_{0} = -1000$, $g_{0} = 1$,\n- $\\beta E_{1} = \\beta E_{0} + 500 \\ln 10$, $g_{1} = 10^{500}$,\n- $\\beta E_{2} = \\beta E_{0} + 1200 \\ln 10$, $g_{2} = 10^{900}$。\n\n使用你的稳定化表达式计算该系统的 $\\ln Z$。将你得到的 $\\ln Z$ 最终数值结果保留到6位有效数字。答案是无量纲的；仅报告该数值。",
            "solution": "该问题陈述具有科学依据，提法恰当，并且需要应用一种标准的数值稳定化技术。因此，将提供解答。\n\n正则配分函数 $Z$ 由下式给出\n$$\nZ = \\sum_{i} g_{i} \\exp\\left(-\\frac{E_{i}}{k_{B} T}\\right)\n$$\n使用定义 $\\beta \\equiv 1/(k_{B} T)$，上式变为\n$$\nZ = \\sum_{i} g_{i} \\exp(-\\beta E_{i})\n$$\n\n**第一部分：Z的重构**\n\n为使计算稳定，我们确定系统的基态能量 $E_{0}$，即系统中的最低能量（对所有 $i$ 都有 $E_{0} \\le E_{i}$）。我们可以从和式中提出与该能量对应的项。我们通过加上再减去 $E_0$ 来重写指数部分：\n$$\n-\\beta E_{i} = -\\beta (E_{i} - E_{0} + E_{0}) = -\\beta(E_{i} - E_{0}) - \\beta E_{0}\n$$\n将此代入 $Z$ 的表达式中：\n$$\nZ = \\sum_{i} g_{i} \\exp\\big(-\\beta(E_{i} - E_{0}) - \\beta E_{0}\\big)\n$$\n利用指数函数的性质 $\\exp(a+b) = \\exp(a)\\exp(b)$，我们可以分离这些项：\n$$\nZ = \\sum_{i} g_{i} \\exp\\big(-\\beta(E_{i} - E_{0})\\big) \\exp(-\\beta E_{0})\n$$\n由于项 $\\exp(-\\beta E_{0})$ 是对指标 $i$ 求和的每一项的公因子，因此可以将其从和式中提出来：\n$$\nZ = \\exp(-\\beta E_{0}) \\sum_{i} g_{i} \\exp\\big(-\\beta(E_{i} - E_{0})\\big)\n$$\n这就是所求的配分函数的重构形式。令 $\\Delta E_{i} = E_{i} - E_{0}$ 为能级 $i$ 相对于基态的能量。则表达式为：\n$$\nZ = \\exp(-\\beta E_{0}) \\sum_{i} g_{i} \\exp(-\\beta \\Delta E_{i})\n$$\n\n**第二部分：在计算 $\\ln Z$ 时缓解上溢和下溢**\n\n为了计算 $\\ln Z$，我们对重构后的表达式取自然对数：\n$$\n\\ln Z = \\ln \\left( \\exp(-\\beta E_{0}) \\sum_{i} g_{i} \\exp\\big(-\\beta(E_{i} - E_{0})\\big) \\right)\n$$\n利用性质 $\\ln(ab) = \\ln(a) + \\ln(b)$：\n$$\n\\ln Z = \\ln\\big(\\exp(-\\beta E_{0})\\big) + \\ln\\left( \\sum_{i} g_{i} \\exp\\big(-\\beta(E_{i} - E_{0})\\big) \\right)\n$$\n$$\n\\ln Z = -\\beta E_{0} + \\ln\\left( \\sum_{i} g_{i} \\exp\\big(-\\beta(E_{i} - E_{0})\\big) \\right)\n$$\n这种形式由于以下原因避免了数值上溢和下溢：\n1.  **防止上溢**：$Z$ 的原始表达式包含 $\\exp(-\\beta E_i)$ 这样的项。如果某个能级 $E_i$ 是很大的负数，其参数 $-\\beta E_i$ 就会成为一个大的正数，导致 $\\exp(-\\beta E_i)$ 超出标准浮点表示的上限而上溢。在重构后的表达式中，和式内部指数函数的参数是 $-\\beta (E_{i} - E_{0})$。由于 $E_{0}$ 是基态能量，我们有对所有 $i$ 成立的 $E_{i} \\ge E_{0}$，这意味着 $(E_{i} - E_{0}) \\ge 0$。又因为 $\\beta = 1/(k_B T) > 0$，所以参数总是非正的：$-\\beta(E_{i} - E_{0}) \\le 0$。因此，指数项 $\\exp(-\\beta(E_i-E_0))$ 的值总是在范围 $(0, 1]$ 内。这防止了任何单个指数项发生上溢。\n2.  **防止下溢**：在原始表达式中，如果所有能量 $E_i$ 都是大的正数，所有项 $\\exp(-\\beta E_i)$ 都可能极小，并在有限精度下下溢为 $0$。这可能导致计算出错误的 $Z=0$ 和 $\\ln Z = -\\infty$。在重构后的和式中，基态（$i=0$）对应的项是 $g_{0} \\exp(-\\beta(E_{0} - E_{0})) = g_{0}\\exp(0) = g_{0}$。由于简并度 $g_0$ 通常是正整数（本题中 $g_0=1$），所以该和式保证至少为 $g_0$。这防止了整个和式下溢为零，从而确保了对数函数有一个有效的参数。\n\n该技术将计算指数和的对数（即“log-sum-exp”运算）这一数值不稳定的任务，转化为一个大项 ($-\\beta E_0$) 与一个良态和的对数之和，从而保证了数值稳定性。\n\n**第三部分：应用于三能级系统**\n\n我们将 $\\ln Z$ 的稳定化公式应用于给定的系统：\n$$\n\\ln Z = -\\beta E_{0} + \\ln\\Big(g_{0} \\exp\\big(-\\beta(E_{0}-E_{0})\\big) + g_{1} \\exp\\big(-\\beta(E_{1}-E_{0})\\big) + g_{2} \\exp\\big(-\\beta(E_{2}-E_{0})\\big)\\Big)\n$$\n给定值为：\n- $-\\beta E_{0} = 1000$\n- $g_{0} = 1$\n- $g_{1} = 10^{500}$ 且 $\\beta(E_{1} - E_{0}) = 500 \\ln 10$\n- $g_{2} = 10^{900}$ 且 $\\beta(E_{2} - E_{0}) = 1200 \\ln 10$\n\n让我们计算对数内部的各项：\n- 第0项: $g_{0} \\exp(0) = 1 \\cdot 1 = 1$。\n- 第1项: $g_{1} \\exp(-\\beta(E_{1}-E_{0})) = 10^{500} \\exp(-500 \\ln 10)$。使用恒等式 $a \\exp(b \\ln c) = a \\exp(\\ln(c^b)) = a c^b$，我们有：\n  $$\n  10^{500} \\exp(-500 \\ln 10) = 10^{500} \\exp\\big(\\ln(10^{-500})\\big) = 10^{500} \\cdot 10^{-500} = 10^{0} = 1\n  $$\n- 第2项: $g_{2} \\exp(-\\beta(E_{2}-E_{0})) = 10^{900} \\exp(-1200 \\ln 10)$。类似地：\n  $$\n  10^{900} \\exp(-1200 \\ln 10) = 10^{900} \\exp\\big(\\ln(10^{-1200})\\big) = 10^{900} \\cdot 10^{-1200} = 10^{-300}\n  $$\n\n因此，对数内的和为：\n$$\n\\text{Sum} = 1 + 1 + 10^{-300} = 2 + 10^{-300}\n$$\n现在，我们计算 $\\ln Z$：\n$$\n\\ln Z = 1000 + \\ln(2 + 10^{-300})\n$$\n项 $10^{-300}$ 是一个极小的正数。对于任意小的 $x$，$\\ln(a+x)$ 在 $a$ 点的泰勒展开为 $\\ln(a) + x/a + O(x^2)$。这里，$a=2$ 且 $x=10^{-300}$。\n$$\n\\ln(2 + 10^{-300}) \\approx \\ln(2) + \\frac{10^{-300}}{2}\n$$\n$\\ln(2)$ 的值约为 $0.69314718$。修正项 $0.5 \\times 10^{-300}$ 远小于最终答案所需的精度。因此，为了保留到6位有效数字，我们可以将 $\\ln(2 + 10^{-300})$ 近似为 $\\ln(2)$。\n$$\n\\ln Z \\approx 1000 + \\ln(2) \\approx 1000 + 0.6931471805... = 1000.6931471805...\n$$\n问题要求将最终结果保留到6位有效数字。$1000.693147...$ 的前六位有效数字是 $1, 0, 0, 0, 6, 9$。第七位有效数字是 $3$，小于 $5$，所以我们向下舍入（即截断）。\n$$\n\\ln Z \\approx 1000.69\n$$",
            "answer": "$$\n\\boxed{1000.69}\n$$"
        },
        {
            "introduction": "配分函数理论的一个关键预测是无相互作用系统的尺寸一致性概念。对于一个由无相互作用的片段A和B组成的系统，总配分函数是各个配分函数的乘积（$Z_{A \\cdot B} = Z_A Z_B$），这意味着亥姆霍兹自由能是可加的（$F_{A \\cdot B} = F_A + F_B$）。此练习提供了一个对这一基本原理的动手数值验证。通过显式构建复合系统的配分函数，并将其结果与各片段自由能之和进行比较，您将从计算上证实该理论关系，并加深对统计力学中如何处理系统组成的理解。",
            "id": "2805747",
            "problem": "要求您在正则系综中，为有限温度下无相互作用的片段构建尺寸一致性和尺寸广延性的数值验证。完全使用无量纲亥姆霍兹自由能进行计算，其定义为 $\\phi \\equiv \\beta F = -\\ln Z$，其中 $F$ 是亥姆霍兹自由能，$Z$ 是正则配分函数，$\\beta \\equiv 1/(k_{\\mathrm{B}} T)$，$k_{\\mathrm{B}}$ 是玻尔兹曼常数，$T$ 是绝对温度。对于一个具有离散能级 $\\{E_i\\}$ 和简并度 $\\{g_i\\}$ 的系统，其配分函数为 $Z = \\sum_i g_i \\exp(-\\beta E_i)$。对于两个无相互作用的片段 A 和 B，其哈密顿算符可对易且可加，复合系统 $A \\cdot B$ 的配分函数呈乘积形式 $Z_{A \\cdot B} = Z_A Z_B$，这意味着通过 $\\phi_{A \\cdot B} = \\phi_A + \\phi_B$ 实现了尺寸一致性。\n\n您的任务是实现一个程序，对每个提供的测试用例执行以下操作：\n- 给定片段 A 的能量 $\\{E_i^A\\}$ 和简并度 $\\{g_i^A\\}$、片段 B 的能量 $\\{E_j^B\\}$ 和简并度 $\\{g_j^B\\}$ 以及逆温度 $\\beta$，计算：\n  1. 通过对求和 $\\sum_i g_i^A \\exp(-\\beta E_i^A)$ 和 $\\sum_j g_j^B \\exp(-\\beta E_j^B)$ 进行数值稳定化，分别计算 $\\ln Z_A$ 和 $\\ln Z_B$。\n  2. 通过显式地枚举具有能量 $\\{E_i^A + E_j^B\\}$ 和简并度 $\\{g_i^A g_j^B\\}$ 的复合能谱并对相应的求和进行稳定化，计算 $\\ln Z_{A \\cdot B}$。\n  3. 无量纲自由能 $\\phi_A = -\\ln Z_A$、$\\phi_B = -\\ln Z_B$ 和 $\\phi_{A \\cdot B} = -\\ln Z_{A \\cdot B}$。\n  4. 一个布尔值，表示尺寸一致性条件是否在数值容差内成立：$\\lvert \\phi_{A \\cdot B} - (\\phi_A + \\phi_B) \\rvert \\le \\epsilon$，其中 $\\epsilon = 10^{-12}$。\n- 所有能量均以任意一致的单位处理，输出为无量纲自由能。不涉及角度。由于 $\\phi$ 是无量纲的，输出中不需要物理单位。\n\n使用以下测试套件。每个测试用例是一个元组 $(\\beta, \\{E_i^A\\}, \\{g_i^A\\}, \\{E_j^B\\}, \\{g_j^B\\})$：\n- 情况 1：$\\beta = 0.7$, $\\{E_i^A\\} = [0.0, 1.0, 2.0]$, $\\{g_i^A\\} = [1, 2, 1]$, $\\{E_j^B\\} = [0.0, 0.5]$, $\\{g_j^B\\} = [1, 3]$。\n- 情况 2 (高温极限)：$\\beta = 10^{-6}$, $\\{E_i^A\\} = [0.0, 10.0, 20.0]$, $\\{g_i^A\\} = [1, 1, 1]$, $\\{E_j^B\\} = [0.0, 30.0]$, $\\{g_j^B\\} = [2, 1]$。\n- 情况 3 (低温极限，基态简并)：$\\beta = 100.0$, $\\{E_i^A\\} = [0.0, 0.01]$, $\\{g_i^A\\} = [2, 1]$, $\\{E_j^B\\} = [0.0, 0.02]$, $\\{g_j^B\\} = [3, 5]$。\n- 情况 4 (正负能级，单能级伙伴)：$\\beta = 2.3$, $\\{E_i^A\\} = [-0.5, 0.0, 0.5]$, $\\{g_i^A\\} = [1, 3, 2]$, $\\{E_j^B\\} = [1.23456]$, $\\{g_j^B\\} = [7]$。\n- 情况 5 (大能量偏移以测试数值稳定性)：$\\beta = 0.4$, $\\{E_i^A\\} = [50.2, 51.9]$, $\\{g_i^A\\} = [4, 1]$, $\\{E_j^B\\} = [0.3, 0.9, 2.1]$, $\\{g_j^B\\} = [1, 2, 1]$。\n\n算法要求：\n- 使用 log-sum-exp 变换实现 $\\ln Z$ 的数值稳定计算：如果 $a_k = \\ln g_k - \\beta E_k$，则 $\\ln Z = m + \\ln \\sum_k \\exp(a_k - m)$，其中 $m = \\max_k a_k$。\n- 显式地使用 $A \\cdot B$ 的复合能量-简并度枚举，即枚举所有对 $(i,j)$ 以形成能量 $E_i^A + E_j^B$ 和简并度 $g_i^A g_j^B$。不要通过简单地将 $\\ln Z_A$ 和 $\\ln Z_B$ 相加来计算 $\\ln Z_{A \\cdot B}$，因为目的是数值验证这个等式。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，例如 $[ \\text{result1}, \\text{result2}, \\text{result3}, \\ldots ]$。\n- 每个结果都是一个布尔值，表示相应测试用例是否满足 $\\lvert \\phi_{A \\cdot B} - (\\phi_A + \\phi_B) \\rvert \\le 10^{-12}$。",
            "solution": "我们从具有简并度的离散能谱的正则系综定义开始。对于一个在逆温度 $\\beta \\equiv 1/(k_{\\mathrm{B}} T)$ 下具有能级 $\\{E_i\\}$ 和简并度 $\\{g_i\\}$ 的系统，其正则配分函数为\n$$\nZ = \\sum_{i} g_i \\exp(-\\beta E_i).\n$$\n亥姆霍兹自由能为 $F = -k_{\\mathrm{B}} T \\ln Z$。无量纲亥姆霍兹自由能定义为 $\\phi \\equiv \\beta F = - \\ln Z$。因此，如果我们能以数值稳定的方式计算 $\\ln Z$，那么就能直接得到 $\\phi = -\\ln Z$。\n\n对于两个无相互作用的片段 A 和 B，其哈密顿算符 $\\hat{H}_A$ 和 $\\hat{H}_B$ 对于复合系统是可对易且可加的，复合系统 $A \\cdot B$ 的能级是所有成对之和 $E_{ij}^{A \\cdot B} = E_i^A + E_j^B$，相应的简并度是乘积 $g_{ij}^{A \\cdot B} = g_i^A g_j^B$。那么，复合系统的配分函数为\n$$\nZ_{A \\cdot B} = \\sum_{i,j} g_i^A g_j^B \\exp\\!\\left(-\\beta (E_i^A + E_j^B)\\right) \n= \\left(\\sum_i g_i^A \\exp(-\\beta E_i^A)\\right)\\left(\\sum_j g_j^B \\exp(-\\beta E_j^B)\\right) = Z_A Z_B.\n$$\n取对数并使用 $\\phi$ 的定义，我们得到\n$$\n\\phi_{A \\cdot B} = -\\ln Z_{A \\cdot B} = -\\ln(Z_A Z_B) = -\\ln Z_A - \\ln Z_B = \\phi_A + \\phi_B.\n$$\n在热力学、有限温度的背景下，这种可加性体现了尺寸一致性和尺寸广延性：对于无相互作用的片段，总系统的自由能是各片段自由能之和。\n\n算法设计：\n- 直接对 $\\sum_i g_i \\exp(-\\beta E_i)$ 求和可能会导致下溢或上溢，尤其是在 $\\beta$ 较大或能量偏移较大时。为确保数值稳定性，我们使用 log-sum-exp 变换。定义 $a_i \\equiv \\ln g_i - \\beta E_i$。那么\n$$\n\\ln Z = \\ln \\sum_i \\exp(a_i) = m + \\ln \\sum_i \\exp(a_i - m),\n$$\n其中 $m \\equiv \\max_i a_i$。这将指数进行平移，使得最大的指数为零，从而将求和保持在数值安全的范围内。\n- 对于复合系统 $A \\cdot B$，我们显式地枚举所有对 $(i,j)$ 以形成复合能量 $E_{ij} = E_i^A + E_j^B$ 和简并度 $g_{ij} = g_i^A g_j^B$，然后应用相同的 log-sum-exp 方法计算 $\\ln Z_{A \\cdot B}$。这避免了通过 $\\ln Z_{A \\cdot B} = \\ln Z_A + \\ln Z_B$ 来简单地强制等式成立，而是对其进行数值验证。\n- 计算出 $\\ln Z_A$、$\\ln Z_B$ 和 $\\ln Z_{A \\cdot B}$ 后，我们计算 $\\phi_A = -\\ln Z_A$、$\\phi_B = -\\ln Z_B$ 和 $\\phi_{A \\cdot B} = -\\ln Z_{A \\cdot B}$，并检验是否满足 $\\lvert \\phi_{A \\cdot B} - (\\phi_A + \\phi_B) \\rvert \\le \\epsilon$，其中 $\\epsilon = 10^{-12}$。\n\n测试覆盖理由：\n- 情况 1 提供了在中等 $\\beta$ 下能量和简并度的通用混合，以测试一般情况。\n- 情况 2 使用非常小的 $\\beta$ (高温)，因此许多态的贡献几乎相等；这测试了当指数接近 1 时的稳定性。\n- 情况 3 使用非常大的 $\\beta$ (低温)，以确保基态占主导地位，并测试简并度在低温极限下的作用。\n- 情况 4 包括负能量和一个单能级伙伴，以测试能量平移和能谱大小不对称时的行为。\n- 情况 5 包括大的正能量偏移，以对 log-sum-exp 稳定化进行压力测试，并避免朴素求和中的下溢。\n\n该程序实现了一个函数来稳健地计算 $\\ln Z$，然后将其应用于片段 A 和 B 以及通过显式枚举构建的复合系统。对于每种情况，它输出一个布尔值，指示尺寸一致性条件是否在规定的数值容差内成立。最终输出是包含指定格式的布尔值列表的单行文本。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef log_partition(energies, degeneracies, beta):\n    \"\"\"\n    Compute ln Z for a discrete spectrum using a numerically stable log-sum-exp.\n    energies: 1D array-like of energy levels E_i\n    degeneracies: 1D array-like of positive degeneracies g_i (integers)\n    beta: float inverse temperature\n    \"\"\"\n    E = np.array(energies, dtype=float).ravel()\n    g = np.array(degeneracies, dtype=float).ravel()\n    if E.size != g.size:\n        raise ValueError(\"Energies and degeneracies must have the same length.\")\n    if np.any(g == 0):\n        raise ValueError(\"Degeneracies must be positive.\")\n    a = np.log(g) - beta * E\n    m = np.max(a)\n    # log-sum-exp\n    logZ = m + np.log(np.sum(np.exp(a - m)))\n    return logZ\n\ndef composite_spectrum(energies_A, degeneracies_A, energies_B, degeneracies_B):\n    \"\"\"\n    Enumerate composite spectrum energies and degeneracies for noninteracting A and B.\n    Returns flattened arrays of composite energies and degeneracies.\n    \"\"\"\n    E_A = np.array(energies_A, dtype=float).ravel()\n    g_A = np.array(degeneracies_A, dtype=float).ravel()\n    E_B = np.array(energies_B, dtype=float).ravel()\n    g_B = np.array(degeneracies_B, dtype=float).ravel()\n    # Pairwise sums via broadcasting\n    E_AB = (E_A[:, None] + E_B[None, :]).reshape(-1)\n    # Pairwise degeneracy products via outer product\n    g_AB = (g_A[:, None] * g_B[None, :]).reshape(-1)\n    return E_AB, g_AB\n\ndef dimensionless_free_energy_logZ(logZ):\n    \"\"\"\n    Convert ln Z to the dimensionless Helmholtz free energy phi = - ln Z.\n    \"\"\"\n    return -logZ\n\ndef validate_case(beta, E_A, g_A, E_B, g_B, tol=1e-12):\n    \"\"\"\n    For a single test case, compute phi_A, phi_B, phi_AB and check size consistency:\n    |phi_AB - (phi_A + phi_B)| = tol\n    \"\"\"\n    # ln Z for A and B\n    lnZ_A = log_partition(E_A, g_A, beta)\n    lnZ_B = log_partition(E_B, g_B, beta)\n\n    # Composite by explicit enumeration\n    E_AB, g_AB = composite_spectrum(E_A, g_A, E_B, g_B)\n    lnZ_AB = log_partition(E_AB, g_AB, beta)\n\n    # Dimensionless Helmholtz free energies\n    phi_A = dimensionless_free_energy_logZ(lnZ_A)\n    phi_B = dimensionless_free_energy_logZ(lnZ_B)\n    phi_AB = dimensionless_free_energy_logZ(lnZ_AB)\n\n    diff = abs(phi_AB - (phi_A + phi_B))\n    return diff = tol\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each case: (beta, energies_A, degeneracies_A, energies_B, degeneracies_B)\n    test_cases = [\n        (0.7, [0.0, 1.0, 2.0], [1, 2, 1], [0.0, 0.5], [1, 3]),\n        (1e-6, [0.0, 10.0, 20.0], [1, 1, 1], [0.0, 30.0], [2, 1]),\n        (100.0, [0.0, 0.01], [2, 1], [0.0, 0.02], [3, 5]),\n        (2.3, [-0.5, 0.0, 0.5], [1, 3, 2], [1.23456], [7]),\n        (0.4, [50.2, 51.9], [4, 1], [0.3, 0.9, 2.1], [1, 2, 1]),\n    ]\n\n    results = []\n    for case in test_cases:\n        beta, E_A, g_A, E_B, g_B = case\n        result = validate_case(beta, E_A, g_A, E_B, g_B, tol=1e-12)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```"
        },
        {
            "introduction": "统计力学使用不同的系综（例如，正则系综、巨正则系综）来描述不同物理条件下的系统。该理论的一个基石是，对于大系统，这些系综会得出等价的热力学预测。此高级练习旨在让您为一种点缺陷模型推导两种系综中的热力学势。通过数值比较，您将展示系综等价性原理，并观察它们的差异如何在热力学极限下消失，从而为统计物理学的基础提供深刻的见解。",
            "id": "3489860",
            "problem": "考虑一个晶体固体的非相互作用点缺陷模型，其中可用晶格位置的数量是固定的。假设有 $D$ 个等价且独立的位点，每个位点最多只能容纳一个点缺陷（例如一个空位）。创建一个缺陷需要消耗能量 $ \\epsilon_f $（形成能），单位为电子伏特 (eV)。该系统与一个大热库接触，该热库在绝对温度 $T$（单位为开尔文）下，将与缺陷数共轭的有效化学势 $ \\mu $（单位为 eV）固定。假设位点之间不相互作用，并且除了提供 $D$ 个可用位点外，主体自由度对缺陷统计没有贡献。\n\n你的任务如下，仅从统计系综的第一性原理定义出发：\n\n1) 从巨正则 (GC) 系综的巨配分函数定义 $ \\Xi = \\sum_{\\text{microstates}} \\exp\\left[-\\beta \\left(E - \\mu N\\right)\\right] $ 出发（其中 $ \\beta = 1/(k_B T) $，$ k_B $ 为玻尔兹曼常数），推导该缺陷系统巨势 $ \\Omega(T,V,\\mu) = - k_B T \\ln \\Xi $ 的显式闭合形式表达式，其中 $ V $ 是系统体积。清晰地陈述达到最终形式所使用的任何因子分解步骤和假设，并用 $ T $ 和无量纲活度 $ z \\equiv \\exp\\left(\\beta(\\mu - \\epsilon_f)\\right) $ 表示每位点巨势 $ \\omega = \\Omega/D $。\n\n2) 在缺陷数 $ n $（$ 0 \\le n \\le D $）固定的正则 (C) 系综中，从正则配分函数 $ Z_n = \\sum_{\\text{microstates at fixed }n} \\exp(-\\beta E) $ 的定义出发。通过组合方法计算微观态，推导此模型 $ Z_n $ 的精确表达式。然后写出每位点亥姆霍兹自由能 $ f(n,D,T) = F/D = - (k_B T/D) \\ln Z_n $，并以适合在有限 $ D $ 下进行数值计算的形式表示。\n\n3) 利用系综之间的勒让德结构，定义在固定 $ \\mu $ 下的正则-巨正则比较量 $ \\phi_D(n; T, \\mu) = f(n,D,T) - \\mu \\, (n/D) $，并通过在最接近巨正则系综平均缺陷数 $ \\langle n \\rangle = D \\, \\frac{z}{1+z} $ 的整数 $ n^\\star $ 处计算 $ \\phi_D $，将其与每位点巨正则势 $ \\omega(T,\\mu) $ 进行比较。从第一性原理出发，讨论为什么在 $ D \\to \\infty $（热力学极限）时，$ \\phi_D(n^\\star; T,\\mu) \\to \\omega(T,\\mu) $，并量化巨正则系综中的粒子数涨落随 $ D $ 的标度关系。\n\n4) 编写一个程序，对于给定的参数集 $ (D, T, \\epsilon_f, \\mu) $，计算以下四个量：\n   - 每位点巨势 $ \\omega(T,\\mu) $，单位为 eV。\n   - 在 $ n^\\star $ 处计算的每位点正则勒让德量 $ \\phi_D(n^\\star; T,\\mu) $，单位为 eV，使用具有数值稳定对数的 $ Z_n $ 的精确有限 $ D $ 组合表达式。\n   - 每位点绝对差异 $ \\delta = \\left| \\omega(T,\\mu) - \\phi_D(n^\\star; T,\\mu) \\right| $，单位为 eV。\n   - 巨正则系综中缺陷分数（每位点缺陷数）的标准差 $ \\delta x = \\sqrt{\\mathrm{Var}(n)}/D = \\sqrt{ \\frac{z}{1+z} \\left(1 - \\frac{z}{1+z}\\right) \\frac{1}{D} } $，此为无量纲量。\n\n使用 $ k_B = 8.617333262145 \\times 10^{-5} $ eV/K，所有能量以 eV 表示，所有温度以 K 表示。程序不得读取任何输入，并且必须为以下五个测试用例（测试套件）计算输出：\n\n-   用例 1：$ D = 1000 $，$ T = 1000 $ K，$ \\epsilon_f = 1.0 $ eV，$ \\mu = 0.2 $ eV。\n-   用例 2：$ D = 1000 $，$ T = 600 $ K，$ \\epsilon_f = 0.5 $ eV，$ \\mu = 0.3 $ eV。\n-   用例 3：$ D = 1000 $，$ T = 800 $ K，$ \\epsilon_f = 0.6 $ eV，$ \\mu = 0.6 $ eV。\n-   用例 4：$ D = 100000 $，$ T = 800 $ K，$ \\epsilon_f = 0.8 $ eV，$ \\mu = 0.3 $ eV。\n-   用例 5：$ D = 50 $，$ T = 400 $ K，$ \\epsilon_f = 0.2 $ eV，$ \\mu = 0.35 $ eV。\n\n数值要求：\n-   对组合因子使用稳定的对数计算，例如通过伽马函数的对数来计算 $ \\ln \\binom{D}{n} $。\n-   选择 $ n^\\star $ 时，使用 $ n^\\star = \\mathrm{round}\\!\\left(D \\, \\frac{z}{1+z}\\right) $ 并将其限制在区间 $ [0, D] $ 内。\n\n最终输出格式：\n-   您的程序应生成单行输出，包含一个含五个元素的列表，每个测试用例一个元素，其中每个元素本身是按 $ [\\omega, \\phi_D(n^\\star), \\delta, \\delta x] $ 顺序排列的四个浮点数的列表。该列表必须以逗号分隔，并用方括号括起来，例如 $ [[a_1,b_1,c_1,d_1],[a_2,b_2,c_2,d_2],\\dots] $。",
            "solution": "首先根据指定标准对问题进行验证。\n\n### 问题验证\n\n**步骤1：提取给定条件**\n\n-   系统：一个晶体固体的非相互作用点缺陷模型。\n-   等价且独立的位点数：$D$。\n-   位点占据：每个位点最多只能容纳一个缺陷。\n-   缺陷形成能：$\\epsilon_f$（单位 eV）。\n-   任务1的热力学系综：巨正则 (GC) 系综，与一个热库接触，该热库固定绝对温度 $T$（单位开尔文）和有效化学势 $\\mu$（单位 eV）。\n-   巨配分函数定义：$\\Xi = \\sum_{\\text{microstates}} \\exp\\left[-\\beta \\left(E - \\mu N\\right)\\right]$。\n-   逆温度：$\\beta = 1/(k_B T)$。\n-   玻尔兹曼常数：$k_B = 8.617333262145 \\times 10^{-5}$ eV/K。\n-   巨势定义：$\\Omega(T,V,\\mu) = -k_B T \\ln \\Xi$。\n-   每位点巨势：$\\omega = \\Omega/D$。\n-   活度定义：$z \\equiv \\exp\\left(\\beta(\\mu - \\epsilon_f)\\right)$。\n-   任务2的热力学系综：正则 (C) 系综，具有固定的缺陷数 $n$，其中 $0 \\le n \\le D$。\n-   正则配分函数定义：$Z_n = \\sum_{\\text{microstates at fixed }n} \\exp(-\\beta E)$。\n-   每位点亥姆霍兹自由能：$f(n,D,T) = F/D = - (k_B T/D) \\ln Z_n$。\n-   比较量：$\\phi_D(n; T, \\mu) = f(n,D,T) - \\mu \\, (n/D)$。\n-   用于比较的计算点：$n^\\star$，最接近巨正则系综平均缺陷数 $\\langle n \\rangle = D \\, \\frac{z}{1+z}$ 的整数。具体来说，$n^\\star = \\mathrm{round}\\!\\left(D \\, \\frac{z}{1+z}\\right)$，并限制在 $[0, D]$ 区间内。\n-   缺陷分数涨落：$\\delta x = \\sqrt{\\mathrm{Var}(n)}/D = \\sqrt{ \\frac{z}{1+z} \\left(1 - \\frac{z}{1+z}\\right) \\frac{1}{D} }$。\n-   测试用例：\n    1.  $D = 1000$, $T = 1000$ K, $\\epsilon_f = 1.0$ eV, $\\mu = 0.2$ eV。\n    2.  $D = 1000$, $T = 600$ K, $\\epsilon_f = 0.5$ eV, $\\mu = 0.3$ eV。\n    3.  $D = 1000$, $T = 800$ K, $\\epsilon_f = 0.6$ eV, $\\mu = 0.6$ eV。\n    4.  $D = 100000$, $T = 800$ K, $\\epsilon_f = 0.8$ eV, $\\mu = 0.3$ eV。\n    5.  $D = 50$, $T = 400$ K, $\\epsilon_f = 0.2$ eV, $\\mu = 0.35$ eV。\n-   数值要求：对组合因子使用稳定的对数计算（例如通过对数伽马函数）。\n\n**步骤2：使用提取的给定条件进行验证**\n\n-   **科学上成立**：该问题描述了一个标准的格点气体模型，这是凝聚态物理中统计力学的基石。所有引用的定义和原理（$\\Xi, Z, \\Omega, F$，系综理论）都是基础且公认的。\n-   **问题定义良好**：问题定义清晰，提供了所有必要的参数和方程。它要求进行具体的推导和计算，从而得到一个唯一且有意义的结果。\n-   **客观性**：问题以精确、定量的术语陈述，没有任何主观或含糊的语言。\n\n问题陈述在科学上是合理的、自洽的且定义良好的。它没有违反任何无效标准。\n\n**步骤3：结论与行动**\n\n此问题**有效**。将提供完整的解决方案。\n\n---\n\n### 解题推导与说明\n\n本问题使用一个非相互作用点缺陷模型，探讨了巨正则 (GC) 系综和正则 (C) 系综之间的关系。我们将为每个系综推导热力学势，然后证明它们在热力学极限下的等价性。\n\n**1) 巨正则系综和巨势 ($\\omega$)**\n\n巨配分函数定义为 $\\Xi = \\sum_{\\text{all microstates}} \\exp\\left[-\\beta \\left(E - \\mu N\\right)\\right]$。系统的微观态由 $D$ 个可用位点中每个位点的占据情况指定。设位点 $i$ 的状态由变量 $s_i$ 表示，如果位点被缺陷占据，则 $s_i=1$，如果为空，则 $s_i=0$。\n\n对于给定的微观态 $\\{s_1, s_2, ..., s_D\\}$，缺陷总数为 $N = \\sum_{i=1}^D s_i$，总能量为 $E = \\sum_{i=1}^D s_i \\epsilon_f = N \\epsilon_f$，因为缺陷之间不相互作用。\n\n配分函数指数中单个微观态的项为：\n$$ E - \\mu N = N \\epsilon_f - \\mu N = N (\\epsilon_f - \\mu) = (\\sum_{i=1}^D s_i)(\\epsilon_f - \\mu) = \\sum_{i=1}^D s_i (\\epsilon_f - \\mu) $$\n对所有微观态求和就是对 $\\{s_1, ..., s_D\\}$ 的所有可能值求和，其中每个 $s_i$ 可以是 $0$ 或 $1$。\n$$ \\Xi = \\sum_{s_1=0}^1 \\sum_{s_2=0}^1 \\dots \\sum_{s_D=0}^1 \\exp\\left[ -\\beta \\sum_{i=1}^D s_i (\\epsilon_f - \\mu) \\right] $$\n利用性质 $\\exp(\\sum x_i) = \\prod \\exp(x_i)$，我们可以写出：\n$$ \\Xi = \\sum_{s_1=0}^1 \\dots \\sum_{s_D=0}^1 \\prod_{i=1}^D \\exp\\left[ -\\beta s_i (\\epsilon_f - \\mu) \\right] $$\n由于位点是独立的，乘积的求和可以分解为求和的乘积：\n$$ \\Xi = \\prod_{i=1}^D \\left( \\sum_{s_i=0}^1 \\exp\\left[ -\\beta s_i (\\epsilon_f - \\mu) \\right] \\right) $$\n让我们计算单个位点 $i$ 的和：\n$$ \\sum_{s_i=0}^1 \\exp\\left[ -\\beta s_i (\\epsilon_f - \\mu) \\right] = \\exp(0) + \\exp\\left[ -\\beta(\\epsilon_f - \\mu) \\right] = 1 + \\exp\\left[ \\beta(\\mu - \\epsilon_f) \\right] $$\n因为所有 $D$ 个位点都是等价的，所以这个单位点配分函数（我们称之为 $\\xi_1$）对所有位点都是相同的。\n$$ \\xi_1 = 1 + \\exp\\left[ \\beta(\\mu - \\epsilon_f) \\right] $$\n总的巨配分函数则为 $\\Xi = (\\xi_1)^D$。\n$$ \\Xi = \\left( 1 + \\exp\\left[ \\beta(\\mu - \\epsilon_f) \\right] \\right)^D $$\n巨势 $\\Omega$ 由 $\\Omega = -k_B T \\ln \\Xi$ 给出。\n$$ \\Omega(T, \\mu) = -k_B T \\ln \\left[ \\left( 1 + \\exp\\left[ \\beta(\\mu - \\epsilon_f) \\right] \\right)^D \\right] = -D k_B T \\ln \\left( 1 + \\exp\\left[ \\beta(\\mu - \\epsilon_f) \\right] \\right) $$\n每位点巨势 $\\omega = \\Omega/D$ 是：\n$$ \\omega(T, \\mu) = -k_B T \\ln \\left( 1 + \\exp\\left[ \\beta(\\mu - \\epsilon_f) \\right] \\right) $$\n使用给定的活度定义 $z = \\exp\\left( \\beta(\\mu - \\epsilon_f) \\right)$，表达式简化为：\n$$ \\omega(T, \\mu) = -k_B T \\ln(1+z) $$\n\n**2) 正则系综和亥姆霍兹自由能 ($f$)**\n\n在正则系综中，缺陷数 $n$ 是固定的（$0 \\le n \\le D$）。正则配分函数是 $Z_n = \\sum_{\\text{microstates at fixed }n} \\exp(-\\beta E)$。\n对于固定的缺陷数 $n$，任何微观态的能量都是 $E = n \\epsilon_f$，这对于该子系综中的所有微观态都是恒定的。\n因此，我们可以将能量项从求和中提出来：\n$$ Z_n = \\exp(-\\beta n \\epsilon_f) \\sum_{\\text{microstates at fixed }n} 1 $$\n求和项只是计算将 $n$ 个不可区分的缺陷排列在 $D$ 个可区分的位点上的方式数量。这由二项式系数 $\\binom{D}{n}$ 给出。\n$$ Z_n = \\binom{D}{n} \\exp(-\\beta n \\epsilon_f) $$\n亥姆霍兹自由能是 $F_n = -k_B T \\ln Z_n$。\n$$ F_n = -k_B T \\ln\\left[ \\binom{D}{n} \\exp(-\\beta n \\epsilon_f) \\right] = -k_B T \\left[ \\ln\\binom{D}{n} - \\beta n \\epsilon_f \\right] = n \\epsilon_f - k_B T \\ln\\binom{D}{n} $$\n每位点亥姆霍兹自由能 $f(n,D,T) = F_n/D$ 是：\n$$ f(n,D,T) = \\frac{n \\epsilon_f}{D} - \\frac{k_B T}{D} \\ln\\binom{D}{n} $$\n为了进行数值稳定的计算，特别是对于大的 $D$ 和 $n$，项 $\\ln\\binom{D}{n}$ 使用伽马函数的对数来计算，即 $\\ln(k!) = \\ln(\\Gamma(k+1))$。\n$$ \\ln\\binom{D}{n} = \\ln(D!) - \\ln(n!) - \\ln((D-n)!) = \\ln(\\Gamma(D+1)) - \\ln(\\Gamma(n+1)) - \\ln(\\Gamma(D-n+1)) $$\n\n**3) 系综等价性与涨落**\n\n正则系综和巨正则系综之间的联系通过勒让德变换建立。巨势 $\\Omega$ 是勒让德变换后的亥姆霍兹自由能的最小值：$\\Omega(T, \\mu) = \\min_n (F_n - \\mu n)$。对于宏观系统（大 $D$），这个最小值非常尖锐，意味着热力学性质由具有平均粒子数 $\\langle n \\rangle$ 的状态主导。这就是系综等价性原理。\n\n我们被要求比较 $\\omega = \\Omega/D$ 与在 $n^\\star$（最接近 $\\langle n \\rangle$ 的整数）处计算的量 $\\phi_D(n; T, \\mu) = f(n,D,T) - \\mu (n/D)$。\n$$ \\phi_D(n; T, \\mu) = \\frac{F_n - \\mu n}{D} $$\n在热力学极限（$D \\to \\infty$）下，我们期望 $\\phi_D(\\langle n \\rangle; T, \\mu) \\to \\omega(T,\\mu)$。为了证明这一点，我们对大的 $D$ 和 $n$ 使用斯特林近似来处理 $\\ln\\binom{D}{n}$。令 $x = n/D$ 为缺陷分数：\n$$ \\frac{1}{D}\\ln\\binom{D}{n} \\approx -[x \\ln x + (1-x)\\ln(1-x)] $$\n此项代表每位点的组态熵（除以 $k_B$）。将其代入 $f$ 的表达式中：\n$$ f(x,T) \\approx x \\epsilon_f + k_B T [x \\ln x + (1-x)\\ln(1-x)] $$\n需要最小化的函数是 $\\phi(x; T, \\mu) = f(x,T) - \\mu x$。通过将其对 $x$ 的导数设为零来找到平衡浓度 $x_{eq}$：\n$$ \\frac{\\partial \\phi}{\\partial x} = \\epsilon_f + k_B T[\\ln x + 1 - \\ln(1-x) - 1] - \\mu = 0 $$\n$$ \\epsilon_f - \\mu + k_B T \\ln\\left(\\frac{x}{1-x}\\right) = 0 \\implies \\frac{x}{1-x} = \\exp\\left(-\\beta(\\epsilon_f - \\mu)\\right) = \\exp\\left(\\beta(\\mu - \\epsilon_f)\\right) = z $$\n解出 $x$ 得到 $x_{eq} = \\frac{z}{1+z}$，这恰好是巨正则系综中的平均缺陷分数 $\\langle n \\rangle / D$。\n\n将 $x_{eq}$ 代回 $\\phi(x; T, \\mu)$ 得到：\n$$ \\phi_{min} = x_{eq}(\\epsilon_f - \\mu) + k_B T [x_{eq} \\ln x_{eq} + (1-x_{eq})\\ln(1-x_{eq})] $$\n使用 $\\ln(\\frac{x_{eq}}{1-x_{eq}}) = \\beta(\\mu - \\epsilon_f)$，代入并进行代数简化后表明，该表达式可化简为：\n$$ \\phi_{min} = -k_B T \\ln(1+z) = \\omega(T,\\mu) $$\n这证实了在热力学极限下系综的等价性。对于有限 $D$ 的 $\\phi_D(n^\\star; T,\\mu)$ 是对此最小值的近似，并且随着 $D \\to \\infty$ 而收敛到 $\\omega$。\n\n巨正则系综中粒子数 $n$ 的涨落量化了围绕 $\\langle n \\rangle$ 的分布“宽度”。方差为 $\\mathrm{Var}(n) = k_B T (\\partial \\langle n \\rangle / \\partial \\mu)_T$。\n$$ \\mathrm{Var}(n) = D \\frac{z}{(1+z)^2} = D \\left(\\frac{z}{1+z}\\right) \\left(1 - \\frac{z}{1+z}\\right) $$\n*缺陷分数* $x=n/D$ 的涨落由其标准差给出：\n$$ \\delta x = \\frac{\\sqrt{\\mathrm{Var}(n)}}{D} = \\frac{\\sqrt{D z/(1+z)^2}}{D} = \\frac{1}{\\sqrt{D}} \\frac{\\sqrt{z}}{1+z} $$\n这表明强度量 $x$ 的涨落与 $1/\\sqrt{D}$ 成标度关系，并在热力学极限（$D \\to \\infty$）中消失，这是系综等价性的一个关键原因。\n\n**4) 程序实现**\n\n提供的程序实现了这些推导出的公式，为每个测试用例计算四个所要求的量。它使用 `numpy`进行数值运算，并使用`scipy.special.gammaln`进行正则自由能中组合项的数值稳定计算。其逻辑遵循上述步骤：计算巨正则系综的量，确定 $n^\\star$，计算相应的正则系综量 $\\phi_D$，最后计算差异 $\\delta$ 和涨落 $\\delta x$。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import gammaln\n\ndef solve():\n    \"\"\"\n    Solves the statistical mechanics problem for point defects in a crystal\n    for a given set of test cases.\n    \"\"\"\n    \n    # Constants\n    k_B = 8.617333262145e-5  # Boltzmann constant in eV/K\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: D=1000, T=1000 K, eps_f=1.0 eV, mu=0.2 eV\n        (1000, 1000.0, 1.0, 0.2),\n        # Case 2: D=1000, T=600 K, eps_f=0.5 eV, mu=0.3 eV\n        (1000, 600.0, 0.5, 0.3),\n        # Case 3: D=1000, T=800 K, eps_f=0.6 eV, mu=0.6 eV\n        (1000, 800.0, 0.6, 0.6),\n        # Case 4: D=100000, T=800 K, eps_f=0.8 eV, mu=0.3 eV\n        (100000, 800.0, 0.8, 0.3),\n        # Case 5: D=50, T=400 K, eps_f=0.2 eV, mu=0.35 eV\n        (50, 400.0, 0.2, 0.35),\n    ]\n\n    results = []\n    for D, T, eps_f, mu in test_cases:\n        # Part 1: Grand Canonical (GC) calculations\n        beta = 1.0 / (k_B * T)\n        z = np.exp(beta * (mu - eps_f))\n        \n        # omega: grand potential per site\n        omega = -k_B * T * np.log(1 + z)\n\n        # Part 3/4: Determine n_star for canonical calculation\n        n_mean = D * z / (1.0 + z)\n        # n_star: integer closest to the mean defect number, clamped to [0, D]\n        n_star = int(np.round(n_mean))\n        n_star = max(0, min(D, n_star))\n\n        # Part 2: Canonical (C) calculations at n_star\n        # f_per_site: Helmholtz free energy per site\n        if n_star == 0 or n_star == D:\n            ln_comb = 0.0\n        else:\n            # Numerically stable log of binomial coefficient using log-gamma\n            ln_comb = gammaln(D + 1) - gammaln(n_star + 1) - gammaln(D - n_star + 1)\n        \n        f_per_site = (n_star * eps_f / D) - (k_B * T / D) * ln_comb\n        \n        # phi_D_n_star: Legendre-transformed canonical quantity\n        phi_D_n_star = f_per_site - mu * (n_star / D)\n        \n        # Part 4: Final quantities\n        # delta: absolute discrepancy per site\n        delta = np.abs(omega - phi_D_n_star)\n        \n        # delta_x: standard deviation of defect fraction in GC ensemble\n        x_mean = z / (1.0 + z)\n        var_n_over_D_sq = (x_mean * (1.0 - x_mean)) / D\n        delta_x = np.sqrt(var_n_over_D_sq)\n\n        results.append([omega, phi_D_n_star, delta, delta_x])\n\n    # Format the final output string as specified\n    inner_strings = [f\"[{r[0]},{r[1]},{r[2]},{r[3]}]\" for r in results]\n    final_output = f\"[{','.join(inner_strings)}]\"\n    \n    print(final_output)\n\nif __name__ == \"__main__\":\n    solve()\n```"
        }
    ]
}