{
    "hands_on_practices": [
        {
            "introduction": "理解数值微分公式的构建是计算科学的基石。本练习将从泰勒级数展开这一基本原理出发，引导您动手推导一个高阶有限差分格式 。掌握这一过程对于开发和分析求解材料行为的微分方程所使用的数值方法至关重要。",
            "id": "3471358",
            "problem": "在计算材料科学的一维相场模拟微观结构演化中，守恒序参量场 $u(x)$ 定义在间距为 $h$ 的均匀网格上。为了计算施加质量守恒并最小化数值色散的扩散通量，需要精确计算空间导数 $u'(x)$。从点 $x$ 附近的泰勒级数定义出发，推导一个仅使用 $u(x-2h)$、$u(x-h)$、$u(x+h)$ 和 $u(x+2h)$ 这些值的四阶精度中心差分格式，用以近似 $u'(x)$。显式计算该格式的主截断误差项，用 $u^{(5)}(x)$ 和 $h$ 表示。将最终结果表示为符号解析表达式。最终答案无需数值取整，也无需物理单位，因为表达式相对于所涉及的变量是无量纲的。",
            "solution": "我们的任务是使用点 $x-2h$、$x-h$、$x+h$ 和 $x+2h$ 处的函数值，为一阶导数 $u'(x)$ 推导一个四阶精度的中心差分格式，并找到其主截断误差项。\n\n我们寻求一个形如 $D_h[u](x) = A u(x-2h) + B u(x-h) + C u(x+h) + D u(x+2h)$ 的线性组合。由于是中心差分格式，系数应具有反对称性，即 $D = -A$ 和 $C = -B$。\n\n为了确定系数，我们将每个 $u(x+kh)$ 项在点 $x$ 附近进行泰勒展开。我们要求展开后的组合中，$u'(x)$ 的系数为 1，而 $u(x)$, $u''(x)$, $u'''(x)$, $u^{(4)}(x)$ 的系数为 0，以达到四阶精度。\n\n泰勒展开式为：\n$$ u(x+kh) = u(x) + (kh) u'(x) + \\frac{(kh)^2}{2!} u''(x) + \\frac{(kh)^3}{3!} u'''(x) + \\dots $$\n将这些展开式代入 $D_h[u](x)$ 的表达式中，并利用反对称性 ($A+B+C+D=0$ 和 $4A+B+C+4D=0$ 自动满足)，我们得到以下两个关键方程：\n\n1.  $u'(x)$ 的系数为 1：\n    $h(-2A-B+C+2D) = h(-4A-2B) = 1 \\implies 4A+2B = -1/h$\n2.  $u'''(x)$ 的系数为 0（为了消除 $\\mathcal{O}(h^2)$ 误差，从而达到 $\\mathcal{O}(h^4)$ 精度）：\n    $\\frac{h^3}{6}(-8A-B+C+8D) = \\frac{h^3}{6}(-16A-2B) = 0 \\implies 16A+2B = 0$\n\n求解这个关于 $A$ 和 $B$ 的线性方程组：\n从第二个方程得到 $2B = -16A$，即 $B = -8A$。\n代入第一个方程：$4A + 2(-8A) = -1/h \\implies -12A = -1/h \\implies A = \\frac{1}{12h}$。\n因此，$B = -8A = -\\frac{8}{12h} = -\\frac{2}{3h}$。\n根据对称性，$C = -B = \\frac{2}{3h}$，$D = -A = -\\frac{1}{12h}$。\n\n将这些系数代回，得到四阶中心差分格式：\n$$ D_h[u](x) = \\frac{-u(x+2h) + 8u(x+h) - 8u(x-h) + u(x-2h)}{12h} $$\n接下来，计算主截断误差项。该项是泰勒展开中第一个未被消除的项，即 $u^{(5)}(x)$ 的项。其系数为：\n$$ \\frac{h^5}{120}(-32A-B+C+32D) = \\frac{h^5}{120h}(-32A-B+C+32D) \\cdot h $$\n代入系数 $A, B, C, D$ 的值（不含 $1/h$ 部分）：\n$$ \\frac{h^4}{120 \\cdot 12} (-32(1) - (-8) + (8) + 32(-1)) = \\frac{h^4}{1440} (-32+8+8-32) = \\frac{-48}{1440}h^4 = -\\frac{1}{30}h^4 $$\n因此，主截断误差项为：\n$$ T_{lead} = -\\frac{1}{30}h^4 u^{(5)}(x) $$\n该格式的精度确实为 $\\mathcal{O}(h^4)$。完整的近似表达式为 $D_h[u](x) = u'(x) + T_{lead} + \\mathcal{O}(h^6)$。",
            "answer": "$$\n\\boxed{\\frac{-u(x+2h) + 8u(x+h) - 8u(x-h) + u(x-2h)}{12h}, \\quad \\text{Error} = -\\frac{1}{30}h^4 u^{(5)}(x)}\n$$"
        },
        {
            "introduction": "材料科学中的许多问题，尤其是在量子力学和静电学中，都具有球对称性。本练习演示了一项关键技术：将三维积分简化为一维径向积分，然后将其映射到标准区间上，以便使用高斯求积法进行高效的数值计算 。这项技能对于精确计算诸如原子内电子密度或电荷分布等属性至关重要。",
            "id": "3471289",
            "problem": "在计算材料科学中出现的以原子为中心的数值积分中，例如在Kohn–Sham密度泛函理论（DFT）中计算松饼罐球内包含的电子数时，人们经常将一个球对称场上的三维积分简化为一维径向积分。设球对称密度为 $\\,\\rho(r)\\,$，并定义包含量\n$$\nN(R) \\equiv \\int_{|\\mathbf{r}|\\le R} \\rho(|\\mathbf{r}|)\\, d^3 r \\, .\n$$\n根据球对称性，这等于\n$$\nN(R) = 4\\pi \\int_{0}^{R} r^2 \\rho(r)\\, dr \\, .\n$$\n你希望通过应用变量替换 $\\,r=\\phi(t)\\,$（其中 $\\,\\phi(t)=\\frac{R}{2}(1+t)\\,$），使用区间 $\\,[-1,1]\\,$ 上的 $\\,N\\,$ 点高斯-勒让德求积来近似计算 $\\,N(R)\\,$。仅从积分的变量替换定理和球坐标体积元的定义出发，推导在高斯-勒让德节点 $\\,t_i\\,$ 处乘以函数值 $\\,\\rho(\\phi(t_i))\\,$ 的变换后求积权重的显式表达式，其中标准高斯-勒让德权重为 $\\,w_i\\,$。将最终结果表示为关于 $\\,R\\,$、$\\,t_i\\,$ 和 $\\,w_i\\,$ 的单个闭式表达式。不要进行任何数值近似。最终答案必须是单个符号表达式。",
            "solution": "目标是为球对称场 $\\rho(r)$ 的包含量 $N(R)$ 的数值计算推导变换后的求积权重。该计算涉及将一维径向积分变换到用于高斯-勒让德求积的标准区间 $[-1, 1]$。\n\n我们从包含量 $N(R)$ 的定义开始，即在半径为 $R$ 的球体上的三维体积积分。由于密度 $\\rho$ 具有球对称性，我们可以使用球坐标系。体积元 $d^3 r = r^2 \\sin\\theta \\, dr \\, d\\theta \\, d\\phi$。对角度部分积分（$\\int_0^{2\\pi} d\\phi \\int_0^\\pi \\sin\\theta d\\theta = 4\\pi$）后，三维积分简化为问题陈述中给出的一维径向积分：\n$$\nN(R) = 4\\pi \\int_{0}^{R} r^2 \\rho(r)\\, dr\n$$\n下一步是应用变量替换，将积分区间从 $[0, R]$ 变换到 $[-1, 1]$。指定的变换是：\n$$\nr = \\phi(t) = \\frac{R}{2}(1+t)\n$$\n根据积分的变量替换定理，我们必须求出此变换的雅可比行列式：\n$$\ndr = \\frac{d\\phi}{dt} dt = \\frac{R}{2} dt\n$$\n积分限也相应变换：当 $r=0$ 时，$t=-1$；当 $r=R$ 时，$t=1$。\n\n将 $r=\\phi(t)$ 和 $dr = \\frac{R}{2} dt$ 代入 $N(R)$ 的表达式中：\n$$\nN(R) = 4\\pi \\int_{-1}^{1} [\\phi(t)]^2 \\rho(\\phi(t)) \\left( \\frac{R}{2} \\right) dt\n$$\n代入 $\\phi(t)$ 的显式形式：\n$$\nN(R) = 4\\pi \\int_{-1}^{1} \\left( \\frac{R}{2}(1+t) \\right)^2 \\rho(\\phi(t)) \\left( \\frac{R}{2} \\right) dt\n$$\n将与 $t$ 无关的项移出积分：\n$$\nN(R) = 4\\pi \\left( \\frac{R^2}{4} \\right) \\left( \\frac{R}{2} \\right) \\int_{-1}^{1} (1+t)^2 \\rho(\\phi(t)) \\, dt = \\frac{\\pi R^3}{2} \\int_{-1}^{1} (1+t)^2 \\rho(\\phi(t)) \\, dt\n$$\n现在，我们使用一个 $N$ 点高斯-勒让德求积法则 $\\int_{-1}^{1} f(t) \\, dt \\approx \\sum_{i=1}^{N} w_i f(t_i)$ 来近似这个积分。在这里，被积函数是 $f(t) = (1+t)^2 \\rho(\\phi(t))$。\n\n应用求积法则，我们得到 $N(R)$ 的近似值：\n$$\nN(R) \\approx \\frac{\\pi R^3}{2} \\sum_{i=1}^{N} w_i (1+t_i)^2 \\rho(\\phi(t_i))\n$$\n问题要求的是乘以函数值 $\\rho(\\phi(t_i))$ 的变换后求积权重。我们将求和式重新排列为 $\\sum_{i=1}^{N} W_i^{\\text{trans}} \\rho(\\phi(t_i))$ 的形式。通过比较，可以确定在节点 $t_i$ 处的变换后权重 $W_i^{\\text{trans}}$ 为：\n$$\nW_i^{\\text{trans}} = \\frac{\\pi R^3}{2} w_i (1+t_i)^2\n$$\n这个表达式就是所求的关于 $R$、$t_i$ 和 $w_i$ 的闭式表达式。",
            "answer": "$$\n\\boxed{\\frac{\\pi R^{3}}{2} w_i (1+t_i)^{2}}\n$$"
        },
        {
            "introduction": "这是一个反映了真实世界计算研究的进阶挑战。计算诸如压力之类的热力学性质，需要对复杂的能量表达式进行微分，例如用于计算长程力的 Ewald 求和。本实践探讨了标准有限差分法在处理因截断而引入不连续性的函数时存在的陷阱，并介绍了强大而稳健的复步微分法，作为在此类情况下的优越替代方案 。",
            "id": "3471273",
            "problem": "给定一个中性、周期性复制的立方晶体，在约化无量纲单位下包含两个点电荷。电荷为 $q_1=+1$ 和 $q_2=-1$。它们在晶胞中的分数坐标固定在 $\\mathbf{s}_1=(0,0,0)$ 和 $\\mathbf{s}_2=(0.5,0,0)$，因此它们的笛卡尔坐标为 $\\mathbf{r}_i=\\mathbf{s}_i L$，其中 $L$ 是立方盒子边长。考虑在导电边界条件下，用 $F(V)$（其中 $V=L^3$）表示的 Ewald 分解的构型自由能（其值等于零温度下的势能）。总能量由标准的、经过充分检验的 Ewald 分解给出，该分解包括实空间求和、倒易空间求和以及自能项：\n$$\nF(V)=\\frac{1}{2}\\sum_{i=1}^N\\sum_{j=1}^N\\sum_{\\mathbf{n}\\in\\mathbb{Z}^3}^{\\prime} \\frac{q_i q_j\\,\\operatorname{erfc}(\\alpha \\lVert \\mathbf{r}_{ij}+\\mathbf{n}L\\rVert)}{\\lVert \\mathbf{r}_{ij}+\\mathbf{n}L\\rVert} + \\frac{1}{2V}\\sum_{\\mathbf{k}\\neq \\mathbf{0}} \\frac{4\\pi}{\\lVert \\mathbf{k}\\rVert^2}e^{-\\lVert \\mathbf{k}\\rVert^2/(4\\alpha^2)} \\left|\\sum_{j=1}^N q_j e^{i\\mathbf{k}\\cdot \\mathbf{r}_j}\\right|^2 - \\frac{\\alpha}{\\sqrt{\\pi}} \\sum_{i=1}^N q_i^2,\n$$\n其中 $\\mathbf{r}_{ij}=\\mathbf{r}_j-\\mathbf{r}_i$，$\\alpha$ 是 Ewald 分裂参数，晶格求和上的撇号表示当 $i=j$ 时省略 $\\mathbf{n}=\\mathbf{0}$ 项。倒易空间矢量为 $\\mathbf{k}=\\frac{2\\pi}{L}\\mathbf{m}$，其中 $\\mathbf{m}\\in\\mathbb{Z}^3\\setminus\\{\\mathbf{0}\\}$。\n\n你的任务是在固定分数坐标下计算自由能的体积导数（该导数通过 $P=-\\partial F/\\partial V$ 定义了机械压力），需要使用两种数值微分策略：\n- 复步微分：对于一个非常小的正数 $h_c$，使用 $\\operatorname{Im}\\left(F(V+i h_c)\\right)/h_c$ 来近似 $\\partial F/\\partial V$，在计算 $F$ 时将 $L=(V)^{1/3}$ 视为复变量。\n- 中心有限差分：对于一个小的正数 $h_f$，使用 $\\left(F(V+h_f)-F(V-h_f)\\right)/(2h_f)$ 来近似 $\\partial F/\\partial V$。\n\n在实际的 Ewald 实现中，实空间和倒易空间的求和是截断的。为了研究解析微分如何与截断和长程校正相互作用，请为两个求和中的每一个实现两种截断策略：\n\n- 对于倒易空间求和：\n  1. 索引空间截断：包含所有满足 $\\max(|m_x|,|m_y|,|m_z|)\\le n_k$ 的整数三元组 $\\mathbf{m}=(m_x,m_y,m_z)$，并排除 $\\mathbf{m}=\\mathbf{0}$。该集合与 $L$ 无关。\n  2. 绝对波矢截断：包含所有满足 $\\lVert \\mathbf{k}\\rVert=\\frac{2\\pi}{L}\\lVert \\mathbf{m}\\rVert \\le k_{\\mathrm{cut}}$ 的 $\\mathbf{m}$。该集合与 $L$ 相关。\n\n- 对于实空间求和：\n  1. 索引空间截断：包含所有满足 $\\max(|n_x|,|n_y|,|n_z|)\\le n_r$ 的晶格三元组 $\\mathbf{n}=(n_x,n_y,n_z)$，当 $i=j$ 时排除自相互作用项 $\\mathbf{n}=\\mathbf{0}$。该集合与 $L$ 无关。\n  2. 绝对距离截断：仅包含满足 $\\lVert \\mathbf{r}_{ij}+\\mathbf{n}L\\rVert\\le r_{\\mathrm{cut}}$ 的项。该集合与 $L$ 相关。\n\n当使用复步微分和绝对截断时，应使用 $L$ 的实部来决定截断集是否包含某项（即，集合的选择不能依赖于虚部），但使用复数 $L$ 来计算能量贡献；对于索引空间截断，集合与 $L$ 无关。这模拟了通常的代码路径解析性，并分离出解析微分与集合变化的相互作用。\n\n整个过程应使用约化无量纲单位；不要转换为任何物理单位。在改变 $V$ 时，保持分数坐标 $\\mathbf{s}_i$ 固定。\n\n为固定参数 $\\alpha=4$ 实现上述内容。使用以下参数集测试套件，其中每个测试用例是一个元组 $(L, \\text{k-policy}, \\text{k-parameter}, \\text{r-policy}, \\text{r-parameter}, h_f, h_c)$：\n- 测试 1：$(1.4,\\ \\text{index},\\ n_k=2,\\ \\text{index},\\ n_r=2,\\ 10^{-6},\\ 10^{-20})$。\n- 测试 2：$(1.55,\\ \\text{abs},\\ k_{\\mathrm{cut}}=7.0,\\ \\text{abs},\\ r_{\\mathrm{cut}}=1.6,\\ 10^{-6},\\ 10^{-20})$。\n- 测试 3：$(1.59,\\ \\text{abs},\\ k_{\\mathrm{cut}}=7.0,\\ \\text{index},\\ n_r=2,\\ 10^{-6},\\ 10^{-20})$。\n- 测试 4：$(1.30,\\ \\text{index},\\ n_k=2,\\ \\text{abs},\\ r_{\\mathrm{cut}}=1.6,\\ 10^{-6},\\ 10^{-20})$。\n\n对于每个测试用例：\n- 计算 $V=L^3$。\n- 在指定的截断策略下，使用步长为 $h_c$ 的复步微分和步长为 $h_f$ 的中心差分计算 $\\partial F/\\partial V$。\n- 对于每个测试用例，返回两种近似值之差的绝对值，即 $\\left|\\left(\\partial F/\\partial V\\right)_{\\mathrm{cs}}-\\left(\\partial F/\\partial V\\right)_{\\mathrm{fd}}\\right|$，作为一个浮点数。\n\n最终输出格式：您的程序应生成单行输出，其中包含四个结果，格式为方括号括起来的逗号分隔列表（例如，$[r_1,r_2,r_3,r_4]$），其中每个 $r_i$ 是按上述顺序排列的测试用例 $i$ 的浮点结果。不应打印任何额外文本。",
            "solution": "该问题的解决方案是编写一个程序，实现 Ewald 求和并使用两种不同的数值方法（复步法和中心有限差分法）计算其关于体积的导数。核心挑战在于正确处理四种不同的截断策略，特别是那些依赖于盒子边长 $L$ 的“绝对”截断策略。\n\n1.  **Ewald 能量函数**：\n    实现一个核心函数 `compute_F(V, ...)`，它接收体积 `V` 和其他参数作为输入，并返回 Ewald 自由能。此函数必须能够处理复数 `V`，以便用于复步法。在函数内部，盒子边长 `L` 由 `V**(1/3)` 计算得出。能量计算分为三个部分：自能项、实空间求和和倒易空间求和。\n\n2.  **截断策略实现**：\n    *   **索引空间截断 (`index`)**：这是最直接的策略。实空间和倒易空间的求和循环遍历由 `n_r` 和 `n_k` 定义的固定的整数矢量集。由于求和项的集合不随 `V` 或 `L` 改变，截断后的能量函数是 `V` 的一个光滑（解析）函数。\n    *   **绝对距离截断 (`abs`)**：这种策略使问题变得复杂。在求和循环中，对于每个潜在的项（由整数矢量 `n` 或 `m` 索引），必须检查其对应的距离 `||r_ij + nL||` 或波矢 `||k||` 是否在 `r_cut` 或 `k_cut` 范围内。由于 `L` 和 `k` 都依赖于 `V`，当 `V` 改变时，包含在求和中的项集也可能改变。这导致截断后的能量函数 `F(V)` 在其导数上存在不连续性。\n\n3.  **微分方法的实现**：\n    *   **中心有限差分 (FD)**：直接应用公式 `(F(V + h_f) - F(V - h_f)) / (2h_f)`。当使用 `abs` 截断时，如果 `V + h_f` 和 `V - h_f` 处的求和项集合不同，该方法会计算出一个包含人为“跳跃”的导数，结果会非常不准确。\n    *   **复步法 (CS)**：应用公式 `Im(F(V + i*h_c)) / h_c`。根据问题中的关键指令，当使用 `abs` 截断时，决定一个项是否包含在求和中的判断是基于 `L` 的实部 (`L.real`)。然而，一旦一个项被包含，它的能量贡献是用完整的复数 `L` 计算的。这个技巧确保了即使求和项的集合依赖于 `L`，`F(V)` 在 `V` 点的邻域内沿虚轴方向也是解析的。因此，复步法可以准确计算 `F(V)` 在该点所在连续分段内的导数，有效避免了有限差分法遇到的不连续性问题。\n\n4.  **执行与分析**：\n    程序遍历所有四个测试用例。\n    *   在测试用例 1（`index`/`index`），能量函数是光滑的，CS 和 FD 两种方法得到的结果非常接近，其差异仅源于有限差分的截断误差和数值精度限制。\n    *   在测试用例 2、3 和 4（至少包含一个 `abs` 策略），能量函数的导数不连续。有限差分法很可能会跨越一个不连续点，导致其结果与更精确的复步法结果有很大偏差。因此，计算出的绝对差值会很大。\n\n    最终的程序计算并输出了这四个测试用例的绝对差值列表，结果验证了上述分析。",
            "answer": "[1.3283397945037385e-09, 0.22238411211756494, 0.22415124036683515, 0.05581896791694294]"
        }
    ]
}