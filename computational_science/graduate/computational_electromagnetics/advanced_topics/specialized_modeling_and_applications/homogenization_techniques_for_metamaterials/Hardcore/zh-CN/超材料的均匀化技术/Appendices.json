{
    "hands_on_practices": [
        {
            "introduction": "均质化理论的核心思想在于用一个简单的均匀介质来替代复杂的周期性结构。本实践提供了一个直接实现这一思想的动手练习。你将通过数值方法求解一个经典的棋盘格几何结构的静电学“元胞问题”，以计算其等效介电常数张量 。这项练习旨在培养建立和求解均质化理论控制性偏微分方程的基本技能。",
            "id": "3314289",
            "problem": "考虑一个二维周期性超材料，其方形单元晶胞的边长为 $a$，由两种标量正介电常数 $\\epsilon_1$ 和 $\\epsilon_2$ 以棋盘格排列方式填充在交替的象限中。在长波极限下，宏观等效介电常数张量 $\\bar{\\bar{\\epsilon}}_{\\text{eff}}$ 通过均匀化关系 $\\langle \\mathbf{D} \\rangle = \\bar{\\bar{\\epsilon}}_{\\text{eff}} \\langle \\mathbf{E} \\rangle$ 定义，其中 $\\mathbf{D} = \\epsilon(\\mathbf{x}) \\mathbf{E}$ 且 $\\mathbf{E} = -\\nabla u$， $u$ 为标量电势。在均匀化设置中，针对规范宏观单位矢量 $\\mathbf{e}_x = (1,0)$ 和 $\\mathbf{e}_y = (0,1)$ 的修正问题是在具有周期性边界条件和零均值修正子的单元晶胞上提出的。\n\n从麦克斯韦方程组及其静电极限出发，可以根据本构关系和无电荷条件推导出晶胞问题，如下所示。设 $u_j(\\mathbf{x}) = -\\mathbf{e}_j \\cdot \\mathbf{x} + w_j(\\mathbf{x})$，其中 $j \\in \\{x,y\\}$，$w_j$ 是单元晶胞上的一个周期性函数，其均值为零。局部电场为 $\\mathbf{E}_j(\\mathbf{x}) = \\mathbf{e}_j - \\nabla w_j(\\mathbf{x})$，电位移场为 $\\mathbf{D}_j(\\mathbf{x}) = \\epsilon(\\mathbf{x}) \\mathbf{E}_j(\\mathbf{x})$。修正子 $w_j$ 满足晶胞问题\n$$\n\\nabla \\cdot \\left( \\epsilon(\\mathbf{x}) \\left( \\mathbf{e}_j - \\nabla w_j(\\mathbf{x}) \\right) \\right) = 0\n$$\n该问题在周期性单元晶胞上求解，并对 $w_j$ 施加零均值约束。等效介电常数张量按列计算如下\n$$\n\\bar{\\bar{\\epsilon}}_{\\text{eff}} \\, \\mathbf{e}_j = \\langle \\mathbf{D}_j \\rangle = \\frac{1}{a^2} \\int_{\\text{cell}} \\epsilon(\\mathbf{x}) \\left( \\mathbf{e}_j - \\nabla w_j(\\mathbf{x}) \\right) \\, d\\mathbf{x}.\n$$\n\n您必须在均匀网格上实现一个有限体积或有限差分格式，以近似求解 $j \\in \\{x,y\\}$ 的晶胞问题，然后计算 $\\bar{\\bar{\\epsilon}}_{\\text{eff}}$。在单元面上使用 $\\epsilon$ 的调和平均，以确保跨材料界面的通量一致。施加周期性边界条件，并通过强制单个节点上的 $w_j$ 值为 $0$ 来固定规范，以满足（在常数范围内）零均值约束。\n\n定义单元晶胞边长 $a = 1$，棋盘格图案为四个象限：\n- 左下和右上象限的介电常数为 $\\epsilon_1$。\n- 左上和右下象限的介电常数为 $\\epsilon_2$。\n也就是说，对于坐标 $x \\in [0,1)$ 和 $y \\in [0,1)$，根据象限分配 $\\epsilon_1$ 或 $\\epsilon_2$，面积分数相等。\n\n用一个均匀的 $N \\times N$ 网格对单元晶胞进行离散化，其中网格点数 $N$ 被选为尺度分离参数 $\\eta = a/\\lambda$ 的函数，即 $N(\\eta) = \\lceil N_0 / \\eta \\rceil$，其中基础分辨率 $N_0 = 12$ 为固定值。这里的 $\\lambda$ 是一个名义上的自由空间波长，仅用于参数化 $\\eta$；修正问题是静态的，不直接依赖于 $\\lambda$，但 $N(\\eta)$ 用于研究随着尺度分离增加（即 $\\eta$ 变小）时的数值收敛性。使用网格间距 $h = a/N$。\n\n通过求解以下方程来计算离散修正子 $w_x$ 和 $w_y$\n$$\n\\nabla \\cdot \\left( \\epsilon(\\mathbf{x}) \\nabla w_j(\\mathbf{x}) \\right) = \\nabla \\cdot \\left( \\epsilon(\\mathbf{x}) \\mathbf{e}_j \\right)\n$$\n并采用周期性边界条件和规范固定。右侧应离散化为与 $\\epsilon(\\mathbf{x}) \\mathbf{e}_j$ 对应的面通量的离散散度（即，当 $j=x$ 时为 $\\partial_x \\epsilon$ 或当 $j=y$ 时为 $\\partial_y \\epsilon$），并使用与左侧相同的调和面平均法。求解出 $w_j$ 后，计算局部场并对位移场进行平均，以获得等效张量项。\n\n所有介电常数和等效张量项均以法拉每米 (F/m) 表示。数值输出必须是浮点数。\n\n测试套件：\n使用以下参数集，每个由 $(\\epsilon_1, \\epsilon_2, \\eta)$ 指定，其中 $\\epsilon_1$ 和 $\\epsilon_2$ 的单位为 F/m，$\\eta$ 为无量纲：\n1. $(2.0, 8.0, 0.5)$\n2. $(2.0, 8.0, 0.25)$\n3. $(2.0, 8.0, 0.125)$\n4. $(5.0, 5.0, 0.25)$\n此外，对于 $(2.0, 8.0, 0.25)$，计算两个标量诊断量：\n- 各向异性度量，定义为 $|\\bar{\\bar{\\epsilon}}_{\\text{eff}}(1,1) - \\bar{\\bar{\\epsilon}}_{\\text{eff}}(2,2)|$ 与对角线平均值 $\\frac{1}{2}(\\bar{\\bar{\\epsilon}}_{\\text{eff}}(1,1) + \\bar{\\bar{\\epsilon}}_{\\text{eff}}(2,2))$ 的比值。\n- 非对角线幅值，定义为 $\\max\\{|\\bar{\\bar{\\epsilon}}_{\\text{eff}}(1,2)|, |\\bar{\\bar{\\epsilon}}_{\\text{eff}}(2,1)|\\}$ 与相同的对角线平均值的比值。\n\n对于前三种情况，返回定义为对角项平均值 $\\frac{1}{2}(\\bar{\\bar{\\epsilon}}_{\\text{eff}}(1,1) + \\bar{\\bar{\\epsilon}}_{\\text{eff}}(2,2))$ 的标量各向同性估计值（单位为 F/m）。对于第四种情况，返回各向同性估计值与 $\\epsilon_1$（等于 $\\epsilon_2$）的绝对偏差（单位为 F/m）。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，结果按以下顺序排列：\n- 情况1、2和3的各向同性估计值（单位：F/m）。\n- 收敛比，定义为 $\\frac{|I_1 - I_2|}{|I_2 - I_3|}$，其中 $I_k$ 是情况 $k$ 的各向同性估计值，无量纲。\n- 情况4的绝对偏差（单位：F/m）。\n- 情况 $(2.0, 8.0, 0.25)$ 的各向异性度量（无量纲）。\n- 情况 $(2.0, 8.0, 0.25)$ 的归一化非对角线幅值（无量纲）。\n\n例如，输出应如下所示：\n$[I_1,I_2,I_3,R,\\Delta,I_{\\text{aniso}},I_{\\text{off}}]$\n所有条目均以标准 Python 浮点数形式打印。",
            "solution": "该问题要求计算具有棋盘格结构的二维周期性超材料的等效介电常数张量 $\\bar{\\bar{\\epsilon}}_{\\text{eff}}$。这是均匀化理论中的一个经典问题，我们将使用以单元为中心的有限体积法 (FVM) 进行数值求解。\n\n### 1. 理论公式\n\n在长波极限下，平均电位移场 $\\langle \\mathbf{D} \\rangle$ 与平均电场 $\\langle \\mathbf{E} \\rangle$ 之间的关系由 $\\langle \\mathbf{D} \\rangle = \\bar{\\bar{\\epsilon}}_{\\text{eff}} \\langle \\mathbf{E} \\rangle$ 给出。等效介电常数张量 $\\bar{\\bar{\\epsilon}}_{\\text{eff}}$ 可以通过在材料的单元晶胞上求解一组所谓的“晶胞问题”来确定。\n\n对于宏观恒定电场 $\\mathbf{E}_0$，局部场为 $\\mathbf{E}(\\mathbf{x}) = \\mathbf{E}_0 - \\nabla w(\\mathbf{x})$，其中 $w(\\mathbf{x})$ 是一个周期性的“修正”势。修正子的控制方程源于无电荷条件 $\\nabla \\cdot \\mathbf{D} = 0$，为\n$$\n\\nabla \\cdot \\left( \\epsilon(\\mathbf{x}) (\\mathbf{E}_0 - \\nabla w(\\mathbf{x})) \\right) = 0\n$$\n为了求得 $\\bar{\\bar{\\epsilon}}_{\\text{eff}}$ 的分量，我们针对两种特定情况求解此方程：$\\mathbf{E}_0 = \\mathbf{e}_x = (1,0)$ 和 $\\mathbf{E}_0 = \\mathbf{e}_y = (0,1)$。这给出了两个修正势 $w_x$ 和 $w_y$。相应的晶胞问题为：\n$$\n\\nabla \\cdot \\left( \\epsilon(\\mathbf{x}) \\nabla w_j(\\mathbf{x}) \\right) = \\nabla \\cdot \\left( \\epsilon(\\mathbf{x}) \\mathbf{e}_j \\right) \\quad \\text{for } j \\in \\{x, y\\}\n$$\n这些是泊松型方程，需要在具有周期性边界条件的单元晶胞上求解。修正子 $w_j$ 在相差一个加性常数的情况下是唯一的，该常数通过一个规范条件来固定。\n\n一旦求得 $w_j$，等效介电常数张量的第 $j$ 列由局部电位移场 $\\mathbf{D}_j(\\mathbf{x}) = \\epsilon(\\mathbf{x})(\\mathbf{e}_j - \\nabla w_j(\\mathbf{x}))$ 的平均值给出：\n$$\n\\bar{\\bar{\\epsilon}}_{\\text{eff}} \\mathbf{e}_j = \\langle \\mathbf{D}_j \\rangle = \\frac{1}{|\\Omega|} \\int_{\\Omega} \\epsilon(\\mathbf{x}) (\\mathbf{e}_j - \\nabla w_j(\\mathbf{x})) \\, d\\mathbf{x}\n$$\n其中 $\\Omega$ 是单元晶胞区域，而 $|\\Omega|$ 是其面积。\n\n### 2. 使用有限体积法的数值离散化\n\n我们将单元晶胞（边长 $a=1$）离散化为一个均匀的 $N \\times N$ 单元网格，网格间距为 $h=1/N$。修正势 $w$ 定义在每个单元 $(i,j)$ 的中心，记为 $w_{i,j}$。介电常数 $\\epsilon$ 在每个单元内被视为分段常数，其值 $\\epsilon_{i,j}$ 由单元的中心坐标确定。\n\n晶胞问题在每个控制体（单元）$V_{i,j}$上积分，并应用散度定理，得到一个通量平衡方程：\n$$\n\\int_{\\partial V_{i,j}} \\epsilon(\\mathbf{x}) \\nabla w_j \\cdot \\hat{\\mathbf{n}} \\, dS = \\int_{\\partial V_{i,j}} \\epsilon(\\mathbf{x}) \\mathbf{e}_j \\cdot \\hat{\\mathbf{n}} \\, dS\n$$\n通量在每个单元的四个面（东、西、南、北）上进行评估。对于左侧 (LHS)，穿过单元 $(i,j)$ 与其东边邻居 $(i+1, j)$ 之间界面的通量近似为：\n$$\nF_{\\text{LHS, E}} = h \\cdot \\epsilon_{i+1/2, j} \\frac{w_{i+1,j} - w_{i,j}}{h} = \\epsilon_{i+1/2, j} (w_{i+1,j} - w_{i,j})\n$$\n其中 $\\epsilon_{i+1/2, j}$ 是界面处的介电常数。为确保跨材料界面的通量连续性，我们按规定使用调和平均：\n$$\n\\epsilon_{i+1/2, j} = \\frac{2 \\epsilon_{i,j} \\epsilon_{i+1,j}}{\\epsilon_{i,j} + \\epsilon_{i+1,j}}\n$$\n对所有四个面的流出通量求和，得到单元 $(i,j)$ 的离散方程：\n$$\n\\epsilon_{i+1/2,j}(w_{i,j}-w_{i+1,j}) + \\epsilon_{i-1/2,j}(w_{i,j}-w_{i-1,j}) + \\epsilon_{i,j+1/2}(w_{i,j}-w_{i,j+1}) + \\epsilon_{i,j-1/2}(w_{i,j}-w_{i,j-1}) = \\text{RHS}_{i,j}\n$$\n右侧 (RHS) 是 $\\epsilon \\mathbf{e}_j$ 的净通量。对于 $j=x$，这只涉及穿过东面和西面的通量：\n$$\n\\text{RHS}_{i,j}^{(x)} = (h \\cdot \\epsilon_{i+1/2,j} \\cdot 1) - (h \\cdot \\epsilon_{i-1/2,j} \\cdot 1) = h(\\epsilon_{i+1/2, j} - \\epsilon_{i-1/2, j})\n$$\n类似地，对于 $j=y$，RHS 涉及穿过北面和南面的通量：\n$$\n\\text{RHS}_{i,j}^{(y)} = h(\\epsilon_{i, j+1/2} - \\epsilon_{i, j-1/2})\n$$\n通过环绕索引来施加周期性边界条件，例如，$w_{N,j} = w_{0,j}$，$w_{i,-1} = w_{i,N-1}$。\n这个公式产生了一个稀疏线性方程组 $A \\mathbf{w} = \\mathbf{b}$，用于求解 $N^2$ 个未知的修正子值，其中 $\\mathbf{w}$ 是 $w_{i,j}$ 的扁平化向量。由于周期性边界条件，矩阵 $A$ 是奇异的（其零空间包含常数向量）。为了获得唯一解，我们通过将一个节点的势设置为零来固定规范，例如，$w_{0,0}=0$。这是通过修改线性系统的第一行和右侧来实现的，以强制执行此约束，从而使系统非奇异。\n\n### 3. 等效介电常数的计算\n\n求解出修正势 $w_x$ 和 $w_y$ 的线性系统后，我们计算 $\\bar{\\bar{\\epsilon}}_{\\text{eff}}$ 的分量。这需要对所有单元上的局部电位移场 $\\mathbf{D}_j = \\epsilon(\\mathbf{e}_j-\\nabla w_j)$ 进行平均。单元 $(i,j)$ 中心的梯度 $\\nabla w_j$ 使用带周期性索引的中心差分来近似：\n$$\n(\\nabla w_j)_{i,j} \\approx \\left( \\frac{w_j(i+1,j) - w_j(i-1,j)}{2h}, \\frac{w_j(i,j+1) - w_j(i,j-1)}{2h} \\right)\n$$\n然后通过对所有 $N^2$ 个单元进行平均来计算等效张量的分量：\n$$\n\\epsilon_{xx} = \\langle D_{x,x} \\rangle = \\frac{1}{N^2} \\sum_{i,j} \\epsilon_{i,j} \\left(1 - (\\partial_x w_x)_{i,j}\\right)\n$$\n$$\n\\epsilon_{yx} = \\langle D_{x,y} \\rangle = \\frac{1}{N^2} \\sum_{i,j} \\epsilon_{i,j} \\left(- (\\partial_y w_x)_{i,j}\\right)\n$$\n$$\n\\epsilon_{xy} = \\langle D_{y,x} \\rangle = \\frac{1}{N^2} \\sum_{i,j} \\epsilon_{i,j} \\left(- (\\partial_x w_y)_{i,j}\\right)\n$$\n$$\n\\epsilon_{yy} = \\langle D_{y,y} \\rangle = \\frac{1}{N^2} \\sum_{i,j} \\epsilon_{i,j} \\left(1 - (\\partial_y w_y)_{i,j}\\right)\n$$\n\n### 4. 实现步骤\n\n提供的测试用例由一个脚本解决，该脚本会：\n1. 对于每个测试用例 $(\\epsilon_1, \\epsilon_2, \\eta)$，使用 $N_0 = 12$ 计算所需的网格尺寸 $N = \\lceil N_0 / \\eta \\rceil$。\n2. 构建与棋盘格图案对应的介电常数网格 $\\epsilon_{i,j}$。\n3. 对于每个修正子 ($w_x, w_y$)，组装稀疏矩阵 $A$ 和右侧向量 $\\mathbf{b}$。\n4. 修改系统以强制执行规范条件 $w_{0,0}=0$，并使用稀疏线性求解器求解修正势。\n5. 通过对修正子进行数值微分并平均得到的位移场来计算 $\\bar{\\bar{\\epsilon}}_{\\text{eff}}$ 的分量。\n6. 根据四个测试用例的等效介电常数张量，计算最终所需的输出量（各向同性估计、收敛比、偏差和诊断度量）。\n系统地应用此过程以生成最终的输出向量。对于均匀情况 ($\\epsilon_1=\\epsilon_2$)，修正子应为零，等效介电常数张量应为对角矩阵，其对角项等于常数介电常数，这为数值方法提供了一个有价值的验证。数值结果将显示出与此解析解的微小偏差，这代表了模拟的离散化和浮点误差。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.sparse import lil_matrix\nfrom scipy.sparse.linalg import spsolve\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test cases and print the results.\n    \"\"\"\n    \n    def compute_eff_eps(eps1, eps2, N):\n        \"\"\"\n        Computes the effective permittivity tensor for a checkerboard metamaterial.\n\n        Args:\n            eps1 (float): Permittivity of first material.\n            eps2 (float): Permittivity of second material.\n            N (int): Number of grid points along one dimension.\n\n        Returns:\n            numpy.ndarray: The 2x2 effective permittivity tensor.\n        \"\"\"\n        a = 1.0\n        h = a / N\n\n        # 1. Setup Grid and Permittivity\n        eps_grid = np.zeros((N, N))\n        for i in range(N):\n            for j in range(N):\n                is_ll = (i  N / 2) and (j  N / 2)  # Lower-left\n                is_ur = (i >= N / 2) and (j >= N / 2) # Upper-right\n                if is_ll or is_ur:\n                    eps_grid[i, j] = eps1\n                else:\n                    eps_grid[i, j] = eps2\n\n        # 2. Solve for correctors w_x and w_y\n        correctors = {}\n        for dim_idx, j_dim in enumerate(['x', 'y']):\n            # 3. Build linear system A*w = b\n            A = lil_matrix((N * N, N * N), dtype=np.float64)\n            b = np.zeros(N * N, dtype=np.float64)\n\n            for i in range(N):\n                for j in range(N):\n                    k = i * N + j\n\n                    # Get periodic neighbor indices\n                    ip1, im1 = (i + 1) % N, (i - 1 + N) % N\n                    jp1, jm1 = (j + 1) % N, (j - 1 + N) % N\n\n                    # Harmonic mean for face permittivities\n                    eps_E = 2 * eps_grid[i, j] * eps_grid[ip1, j] / (eps_grid[i, j] + eps_grid[ip1, j])\n                    eps_W = 2 * eps_grid[i, j] * eps_grid[im1, j] / (eps_grid[i, j] + eps_grid[im1, j])\n                    eps_N = 2 * eps_grid[i, j] * eps_grid[i, jp1] / (eps_grid[i, j] + eps_grid[i, jp1])\n                    eps_S = 2 * eps_grid[i, j] * eps_grid[i, jm1] / (eps_grid[i, j] + eps_grid[i, jm1])\n\n                    # Assemble stiffness matrix A (5-point stencil)\n                    # The equation for node k is sum_faces(eps_face * (w_k - w_neighbor)) = RHS\n                    A[k, k] = eps_E + eps_W + eps_N + eps_S\n                    A[k, ip1 * N + j] -= eps_E\n                    A[k, im1 * N + j] -= eps_W\n                    A[k, i * N + jp1] -= eps_N\n                    A[k, i * N + jm1] -= eps_S\n                    \n                    # Assemble RHS vector b = h * div(eps * e_j)\n                    if j_dim == 'x':\n                        b[k] = h * (eps_E - eps_W)\n                    else:  # j_dim == 'y'\n                        b[k] = h * (eps_N - eps_S)\n\n            # 4. Apply gauge condition (fix w[0,0] = 0)\n            k_fix = 0\n            A_csr = A.tocsr() # Convert for efficient row slicing\n            A_csr[k_fix, :] = 0.0\n            A_csr[k_fix, k_fix] = 1.0\n            b[k_fix] = 0.0\n            \n            # 5. Solve for w\n            w_flat = spsolve(A_csr.tocsc(), b) # CSC is good for spsolve\n            correctors[j_dim] = w_flat.reshape((N, N))\n\n        w_x, w_y = correctors['x'], correctors['y']\n\n        # 6. Compute effective permittivity tensor\n        grad_wx_x, grad_wx_y = np.zeros_like(w_x), np.zeros_like(w_x)\n        grad_wy_x, grad_wy_y = np.zeros_like(w_y), np.zeros_like(w_y)\n\n        # Central difference for gradients with periodic BCs\n        for i in range(N):\n            for j in range(N):\n                ip1, im1 = (i + 1) % N, (i - 1 + N) % N\n                jp1, jm1 = (j + 1) % N, (j - 1 + N) % N\n                grad_wx_x[i, j] = (w_x[ip1, j] - w_x[im1, j]) / (2 * h)\n                grad_wx_y[i, j] = (w_x[i, jp1] - w_x[i, jm1]) / (2 * h)\n                grad_wy_x[i, j] = (w_y[ip1, j] - w_y[im1, j]) / (2 * h)\n                grad_wy_y[i, j] = (w_y[i, jp1] - w_y[i, jm1]) / (2 * h)\n\n        # Local E fields\n        Ex_x, Ex_y = 1 - grad_wx_x, -grad_wx_y\n        Ey_x, Ey_y = -grad_wy_x, 1 - grad_wy_y\n\n        # Average D fields\n        eps_xx = np.mean(eps_grid * Ex_x)\n        eps_yx = np.mean(eps_grid * Ex_y)\n        eps_xy = np.mean(eps_grid * Ey_x)\n        eps_yy = np.mean(eps_grid * Ey_y)\n        \n        return np.array([[eps_xx, eps_xy], [eps_yx, eps_yy]])\n\n    N0 = 12.0\n    test_cases_params = [\n        (2.0, 8.0, 0.5),\n        (2.0, 8.0, 0.25),\n        (2.0, 8.0, 0.125),\n        (5.0, 5.0, 0.25)\n    ]\n    \n    # Calculate grid sizes\n    Ns = [int(np.ceil(N0 / eta)) for _, _, eta in test_cases_params]\n\n    # Run simulations\n    eps_eff_1 = compute_eff_eps(test_cases_params[0][0], test_cases_params[0][1], Ns[0])\n    eps_eff_2 = compute_eff_eps(test_cases_params[1][0], test_cases_params[1][1], Ns[1])\n    eps_eff_3 = compute_eff_eps(test_cases_params[2][0], test_cases_params[2][1], Ns[2])\n    eps_eff_4 = compute_eff_eps(test_cases_params[3][0], test_cases_params[3][1], Ns[3])\n\n    # Compute required outputs\n    I1 = 0.5 * (eps_eff_1[0, 0] + eps_eff_1[1, 1])\n    I2 = 0.5 * (eps_eff_2[0, 0] + eps_eff_2[1, 1])\n    I3 = 0.5 * (eps_eff_3[0, 0] + eps_eff_3[1, 1])\n    \n    # Convergence ratio\n    # Add a small epsilon to denominator to avoid division by zero if convergence is perfect\n    R = abs(I1 - I2) / (abs(I2 - I3) + 1e-18)\n    \n    # Absolute deviation for homogeneous case\n    I4_iso = 0.5 * (eps_eff_4[0, 0] + eps_eff_4[1, 1])\n    Delta = abs(I4_iso - test_cases_params[3][0])\n    \n    # Diagnostics for case 2\n    avg_diag_2 = I2\n    Aniso = abs(eps_eff_2[0, 0] - eps_eff_2[1, 1]) / avg_diag_2\n    OffDiag = max(abs(eps_eff_2[0, 1]), abs(eps_eff_2[1, 0])) / avg_diag_2\n    \n    results = [I1, I2, I3, R, Delta, Aniso, OffDiag]\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "虽然从微观结构出发直接计算等效参数是基础，但在实际应用中，我们常常通过测量材料的波散射特性来对其进行表征。本实践聚焦于逆向问题：如何从测量的散射参数（$S$参数）中提取等效折射率 。通过分析提取出的折射率随入射角度的变化，你将学会如何判断材料是否具有各向异性或空间色散等复杂电磁行为，从而在理论模型与实验可观测量之间建立桥梁。",
            "id": "3314219",
            "problem": "给定一个厚度为 $d=5a$ 的超材料平板，在真空中受到平面波斜入射，其晶格常数 $a$ 和厚度 $d$ 被指定为物理长度。目标是根据复散射参数（S参数）$S_{11}(\\theta)$ 和 $S_{21}(\\theta)$，反演出作为入射角 $\\theta$ 函数的标量等效折射率 $n_{\\mathrm{eff}}(\\theta)$，并利用 $n_{\\mathrm{eff}}(\\theta)$ 的实部随角度的变化来评估其各向同性与空间色散特性。您的推导和算法必须从宏观麦克斯韦方程组、均匀介质中平面波传播的定义以及界面处切向电磁场的连续性出发，并利用这些原理建立一种反演平板内部纵向波数的方法。不得假定任何简化公式；反演过程必须遵循第一性原理和经过充分检验的定义。\n\n基本原理：\n- 从无源宏观麦克斯韦方程组开始，在频域中使用时谐场 $e^{-i\\omega t}$：$\\nabla \\times \\mathbf{E} = i\\omega \\mathbf{B}$ 和 $\\nabla \\times \\mathbf{H} = - i\\omega \\mathbf{D}$，以及本构关系 $\\mathbf{D} = \\bar{\\bar{\\varepsilon}} \\mathbf{E}$ 和 $\\mathbf{B} = \\mu \\mathbf{H}$。\n- 对于真空，使用 $\\varepsilon_0$ 和 $\\mu_0$ 以及光速 $c$，其中 $k_0 = \\omega/c$。\n- 定义一个以角度 $\\theta$ 入射到平板法线（取为 $\\hat{z}$）的真空中的平面波：守恒的切向波数为 $k_x = k_0 \\sin\\theta$，真空中的纵向分量为 $k_{z0} = k_0 \\cos\\theta$。\n- 对于均匀平板，将材料内部的纵向波数定义为 $k_z$，并根据切向场的比值定义相应的偏振相关波阻抗 $Z$ 或导纳。考虑横磁（TM）偏振，其中切向电场和磁场满足 $Z = E_t/H_t$。\n- 使用厚度为 $d$、波阻抗为 $Z$ 的均匀平板的传输（ABCD）矩阵来关联输入和输出界面处的场。将其与真空的相等端口阻抗 $Z_0$ 相结合，用平板参数表示 $S_{11}$ 和 $S_{21}$。根据这些关系，通过基于原理的反演方法反演出 $k_z d$，然后通过强制施行各向同性色散关系拟设 $k_z^2 + k_x^2 = n_{\\mathrm{eff}}^2 k_0^2$ 将其映射到 $n_{\\mathrm{eff}}(\\theta)$。\n\n各向异性与空间色散的评估：\n- 对于具有标量 $\\varepsilon$ 和 $\\mu$ 的各向同性局域介质，反演出的 $n_{\\mathrm{eff}}(\\theta)$ 应与 $\\theta$ 无关。随 $\\theta$ 的变化表明标量、局域描述的失效，这可能源于各向异性（张量 $\\bar{\\bar{\\varepsilon}}$）或非局域性（空间色散，其中 $\\varepsilon$ 依赖于波矢量）。\n- 通过计算多个角度下 $\\Re\\{n_{\\mathrm{eff}}(\\theta)\\}$ 的标准差来量化此特性；较小的值表示角度不变性，与各向同性局域介质一致，而较大的值则表示各向异性或非局域性。\n\n物理与数值单位和约定：\n- 使用米作为 $a$ 和 $d$ 的单位。频率 $f$ 必须以赫兹为单位。角度 $\\theta$ 必须以度为单位提供，并在内部解释为弧度。所有反演出的 $n_{\\mathrm{eff}}(\\theta)$ 都是无量纲的。\n- 最终的度量指标必须使用反演出的 $n_{\\mathrm{eff}}(\\theta)$ 的实部进行计算。\n\n测试套件与参数：\n- 使用 $a = 1\\times 10^{-3}$ 米，$d = 5 a$ 米，以及 $f = 1\\times 10^{10}$ 赫兹。平板周围环境为真空。\n- 在入射角集合 $\\{\\theta\\} = \\{0, 30, 60\\}$ 度处进行评估。\n- 考虑 TM 偏振下的三种超材料模型：\n  1. 各向同性局域模型：标量相对介电常数 $\\varepsilon_r = 2.25$ 和标量相对磁导率 $\\mu_r = 1.0$。\n  2. 单轴各向异性局域模型，光轴垂直于平板（$\\hat{z}$）：横向相对介电常数 $\\varepsilon_t = 2.25$，法向相对介电常数 $\\varepsilon_z = 4.0$，以及标量相对磁导率 $\\mu_r = 1.0$。\n  3. 各向同性空间色散模型：标量相对磁导率 $\\mu_r = 1.0$ 和标量相对介电常数 $\\varepsilon_r(k_x) = \\varepsilon_{r0} + \\alpha (k_x/k_0)^2$，其中 $\\varepsilon_{r0} = 2.25$ 和 $\\alpha = 0.3$。\n\n您的程序必须：\n- 为每个模型和角度，使用基于TM偏振的边界条件和模式阻抗的传输矩阵公式，生成复数 $S_{11}(\\theta)$ 和 $S_{21}(\\theta)$。\n- 通过反演传输关系，从生成的S参数中反演出 $k_z d$，期间不使用简化假设，并选择在不同角度间物理上连续的分支。\n- 对于每个模型，使用 $n_{\\mathrm{eff}}(\\theta) = \\sqrt{(k_z/k_0)^2 + \\sin^2\\theta}$ 从 $k_z$ 计算 $n_{\\mathrm{eff}}(\\theta)$，并取其实部。\n- 对于每个模型，计算三个角度下 $\\Re\\{n_{\\mathrm{eff}}(\\theta)\\}$ 的标准差，结果为一个无量纲浮点数。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，列表中的结果按上面列出的模型顺序排列，例如 $[\\text{iso},\\text{uniaxial},\\text{nonlocal}]$，其中每个条目是按规定计算的标准差。浮点数必须是无量纲的。\n\n程序不需要用户输入；程序必须能直接运行，并在内部使用指定的参数和测试套件。",
            "solution": "用户提供了一个定义明确的计算电磁学问题，涉及从超材料平板的散射参数（S参数）反演其等效折射率。该问题在科学上是合理的，没有矛盾，并包含了获得唯一解所需的所有信息。验证通过。\n\n问题的核心是，首先建立一个正向模型，将平板的材料属性与其在横磁（TM）平面波入射下的S参数（$S_{11}, S_{21}$）联系起来；然后，推导并实现一个稳健的反演方法，从S参数中反演出等效折射率 $n_{\\mathrm{eff}}(\\theta)$。\n\n推导和求解将分三个主要步骤进行：\n1.  **正向模型**：基于麦克斯韦方程组和边界条件，使用传输矩阵法从平板属性推导 $S_{11}(\\theta)$ 和 $S_{21}(\\theta)$。\n2.  **反向模型**：推导一种从计算出的S参数中反演纵向波数 $k_z$ 以及随后反演等效折射率 $n_{\\mathrm{eff}}$ 的方法。这必须按要求从第一性原理出发。\n3.  **数值实现**：将推导出的正向和反向模型应用于三种指定的超材料情况，计算 $\\Re\\{n_{\\mathrm{eff}}(\\theta)\\}$ 的标准差，以此作为各向异性和空间色散的度量。\n\n在整个推导过程中，所有数学实体均按要求使用LaTeX渲染。时谐约定为 $e^{-i\\omega t}$。平板位于 $0 \\le z \\le d$ 区域。\n\n**1. 正向模型：从材料属性到S参数**\n\n对于TM（p偏振）平面波，磁场沿y轴方向，$\\mathbf{H} = H_y(x,z) \\hat{y}$，电场位于x-z平面内。场的空间依赖关系为 $e^{i k_x x}$，其中切向波数 $k_x = k_0 \\sin\\theta$ 在所有界面上都是守恒的。这里，$k_0 = \\omega/c = 2\\pi f/c$ 是自由空间波数，$\\theta$ 是相对于法线（$\\hat{z}$轴）的入射角。\n\n对于前向传播的TM波，切向电场 $E_x$ 和切向磁场 $H_y$ 之间的关系定义了特征波阻抗，$Z_{\\text{TM}} = E_x / H_y$。\n\n**A. 各介质中的波传播与阻抗**\n\n*   **真空（区域 $z0$ 和 $z>d$）**：色散关系为 $k_x^2 + k_{z0}^2 = k_0^2$。纵向波数为 $k_{z0} = \\sqrt{k_0^2 - k_x^2} = k_0 \\cos\\theta$。真空中的TM波阻抗为 $Z_{c0}^{\\text{TM}} = \\frac{k_{z0}}{\\omega\\varepsilon_0} = \\frac{k_0 \\cos\\theta}{\\omega\\varepsilon_0} = Z_0 \\cos\\theta$，其中 $Z_0 = \\sqrt{\\mu_0/\\varepsilon_0}$ 是自由空间的阻抗。\n\n*   **平板材料（区域 $0 \\le z \\le d$）**：其属性取决于具体模型。\n    1.  **各向同性局域模型**：对于标量 $\\varepsilon = \\varepsilon_r \\varepsilon_0$ 和 $\\mu = \\mu_r \\mu_0$，色散关系为 $k_x^2 + k_z^2 = k_0^2 \\varepsilon_r \\mu_r$。纵向波数为 $k_z = \\sqrt{k_0^2 \\varepsilon_r \\mu_r - k_x^2} = k_0\\sqrt{\\varepsilon_r \\mu_r - \\sin^2\\theta}$。TM阻抗为 $Z_c^{\\text{TM}} = \\frac{k_z}{\\omega\\varepsilon} = \\frac{k_z}{\\omega\\varepsilon_r\\varepsilon_0}$。\n    2.  **单轴各向异性模型**：对于 $\\bar{\\bar{\\varepsilon}} = \\varepsilon_0 \\mathrm{diag}(\\varepsilon_t, \\varepsilon_t, \\varepsilon_z)$ 和标量 $\\mu=\\mu_r\\mu_0$，TM模式的色散关系为 $\\frac{k_x^2}{\\varepsilon_z} + \\frac{k_z^2}{\\varepsilon_t} = k_0^2 \\mu_r$。纵向波数为 $k_z = k_0\\sqrt{\\varepsilon_t(\\mu_r - \\sin^2\\theta/\\varepsilon_z)}$。TM阻抗为 $Z_c^{\\text{TM}} = \\frac{k_z}{\\omega\\varepsilon_t\\varepsilon_0}$。\n    3.  **各向同性空间色散模型**：对于 $\\varepsilon(k_x) = \\varepsilon_0(\\varepsilon_{r0} + \\alpha(k_x/k_0)^2)$ 和 $\\mu=\\mu_r\\mu_0$，色散关系为 $k_x^2 + k_z^2 = k_0^2 \\mu_r \\varepsilon_r(k_x)$。当 $\\mu_r=1$ 时，这得到 $k_z = k_0\\sqrt{\\varepsilon_{r0} + (\\alpha-1)\\sin^2\\theta}$。TM阻抗为 $Z_c^{\\text{TM}} = \\frac{k_z}{\\omega\\varepsilon(k_x)} = \\frac{k_z}{\\omega\\varepsilon_0\\varepsilon_r(k_x)}$。\n\n**B. 传输矩阵与S参数**\n\n平板输入端（$z=0$）和输出端（$z=d$）的场由一个传输（ABCD）矩阵关联。对于一个厚度为 $d$、传播常数为 $k_z$、特征阻抗为 $Z_c^{\\text{TM}}$ 的均匀平板，该矩阵为：\n$$\n\\begin{pmatrix} A  B \\\\ C  D \\end{pmatrix} = \\begin{pmatrix} \\cos(k_z d)  i Z_c^{\\text{TM}} \\sin(k_z d) \\\\ i (Z_c^{\\text{TM}})^{-1} \\sin(k_z d)  \\cos(k_z d) \\end{pmatrix}\n$$\n对于这个具有相同端口阻抗 $Z_{c0}^{\\text{TM}}$ 的双端口网络，其S参数由ABCD矩阵导出：\n$$\nS_{11} = \\frac{A + B/Z_{c0}^{\\text{TM}} - C Z_{c0}^{\\text{TM}} - D}{A + B/Z_{c0}^{\\text{TM}} + C Z_{c0}^{\\text{TM}} + D} \\quad , \\quad S_{21} = \\frac{2}{A + B/Z_{c0}^{\\text{TM}} + C Z_{c0}^{\\text{TM}} + D}\n$$\n代入矩阵元素并定义归一化阻抗 $z = Z_c^{\\text{TM}} / Z_{c0}^{\\text{TM}}$，我们得到：\n$$\nS_{11} = \\frac{i(z^2 - 1) \\sin(k_z d)}{2z\\cos(k_z d) + i(z^2+1)\\sin(k_z d)} = \\frac{\\frac{i}{2}(z - 1/z) \\sin(k_z d)}{\\cos(k_z d) + \\frac{i}{2}(z+1/z)\\sin(k_z d)}\n$$\n$$\nS_{21} = \\frac{2z}{2z\\cos(k_z d) + i(z^2+1)\\sin(k_z d)} = \\frac{1}{\\cos(k_z d) + \\frac{i}{2}(z+1/z)\\sin(k_z d)}\n$$\n这些方程构成了用于为给定材料模型生成合成S参数数据的正向模型。\n\n**2. 反向模型：从S参数到材料属性**\n\n问题要求对上述系统进行基于原理的反演，以从 $S_{11}$ 和 $S_{21}$ 中求出 $k_z$ 和 $z$。让我们操纵S参数的表达式。从正向模型方程中，我们可以分离出两个关键关系：\n$$\n\\frac{1}{S_{21}} = \\cos(k_z d) + \\frac{i}{2}(z+1/z)\\sin(k_z d)\n$$\n$$\n\\frac{S_{11}}{S_{21}} = \\frac{i}{2}(z-1/z)\\sin(k_z d)\n$$\n通过将这两个方程相加和相减，我们可以用 $S_{11}$、$S_{21}$ 和 $z$ 来表示 $e^{ik_z d}$ 和 $e^{-ik_z d}$。\n令 $r = (z-1)/(z+1)$ 为第一个界面处的反射系数。那么 $z=(1+r)/(1-r)$。代数运算并不简洁。\n一个更稳健的代数路径是分别寻找 $r$ 和 $e^{-ik_z d}$ 的关系。通过将从S参数推导出的 $e^{ik_z d}$ 和 $e^{-ik_z d}$ 的表达式相乘，可以证明：\n$$\n(1 - S_{11} r)(1 - S_{11}/r) = S_{21}^2\n$$\n其中 $r = (z-1)/(z+1)$ 是界面反射系数。展开后得到一个关于 $r + 1/r$ 的二次方程：\n$$\n1 - S_{11}(r+1/r) + S_{11}^2 = S_{21}^2 \\implies r + 1/r = \\frac{1 + S_{11}^2 - S_{21}^2}{S_{11}}\n$$\n令 $K = \\frac{1 + S_{11}^2 - S_{21}^2}{2S_{11}}$。方程变为 $r^2 - 2Kr + 1 = 0$，其解为 $r = K \\pm \\sqrt{K^2-1}$。对于无源材料，反射系数必须满足 $|r| \\le 1$。此条件用于选择正确的物理根。\n\n一旦确定了 $r$，归一化阻抗通过 $z = (1+r)/(1-r)$ 求得。无源介质要求 $\\Re\\{z\\} \\ge 0$。\n\n接下来，我们建立传播因子 $e^{-ik_z d}$ 的关系式。可以证明：\n$$\ne^{-ik_z d} = \\frac{1 - S_{11} r}{S_{21}}\n$$\n由此，使用复对数求得复数乘积 $k_z d$：\n$$\nk_z d = i \\log\\left(\\frac{1 - S_{11} r}{S_{21}}\\right)\n$$\n复对数是多值的：$\\log(w) = \\ln|w| + i(\\arg(w) + 2\\pi m)$，其中 $m$ 是一个整数。这导致 $k_z d$ 的实部存在模糊性。\n$$\nk_z d = (\\arg(w) + 2\\pi m) + i \\ln|w|\n$$\n对于 $e^{-i\\omega t}$ 约定，衰减波要求 $\\Im\\{k_z\\} \\ge 0$，这意味着 $\\Im\\{k_z d\\} = \\ln|w| \\ge 0$，即 $|w| \\ge 1$。这为选择 $r$ 提供了另一个约束。实部的模糊性通过为第一个入射角（$\\theta=0^{\\circ}$）设置 $m=0$，然后为后续角度选择 $m$ 以确保 $\\Re\\{k_z(\\theta)\\}$ 是一个连续函数来解决。\n\n**3. 等效折射率的反演**\n\n反演出的 $k_z$ 通过各向同性色散关系拟设与等效折射率 $n_{\\mathrm{eff}}$ 相关联，该拟设定义了 $n_{\\mathrm{eff}}$：\n$$\nk_x^2 + k_z^2 = (n_{\\mathrm{eff}} k_0)^2\n$$\n代入 $k_x = k_0 \\sin\\theta$ 并求解 $n_{\\mathrm{eff}}$ 得到：\n$$\nn_{\\mathrm{eff}}(\\theta) = \\sqrt{\\left(\\frac{k_z}{k_0}\\right)^2 + \\sin^2\\theta}\n$$\n选择主根（$\\Re\\{n_{\\mathrm{eff}}\\} \\ge 0$）。\n\n对于一个真正的各向同性局域介质，反演出的 $n_{\\mathrm{eff}}(\\theta)$ 将是一个常数，等于材料的真实折射率。对于各向异性和空间色散模型，$n_{\\mathrm{eff}}(\\theta)$ 将随入射角 $\\theta$ 而变化。在指定角度范围内 $\\Re\\{n_{\\mathrm{eff}}(\\theta)\\}$ 的标准差可作为这种角度依赖性的定量度量。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.constants import c as C0, mu_0, epsilon_0\n\ndef solve():\n    \"\"\"\n    Main function to perform the metamaterial analysis.\n    It calculates S-parameters for three different slab models, retrieves\n    the effective refractive index n_eff(theta), and computes the standard\n    deviation of Re(n_eff) across incidence angles as a measure of\n    anisotropy or spatial dispersion.\n    \"\"\"\n\n    # --- Problem Parameters ---\n    a = 1e-3  # meters\n    d = 5 * a  # meters\n    f = 1e10  # Hertz\n    angles_deg = [0, 30, 60]\n\n    # --- Physical Constants and Derived Parameters ---\n    Z0 = np.sqrt(mu_0 / epsilon_0)  # Impedance of free space\n    omega = 2 * np.pi * f\n    k0 = omega / C0\n\n    # --- Test Case Models ---\n    models = [\n        {\n            \"name\": \"Isotropic\",\n            \"type\": \"isotropic\",\n            \"params\": {\"eps_r\": 2.25, \"mu_r\": 1.0}\n        },\n        {\n            \"name\": \"Uniaxial\",\n            \"type\": \"uniaxial\",\n            \"params\": {\"eps_t\": 2.25, \"eps_z\": 4.0, \"mu_r\": 1.0}\n        },\n        {\n            \"name\": \"Spatially Dispersive\",\n            \"type\": \"spatially_dispersive\",\n            \"params\": {\"eps_r0\": 2.25, \"alpha\": 0.3, \"mu_r\": 1.0}\n        }\n    ]\n\n    final_results = []\n\n    for model in models:\n        n_eff_real_parts = []\n        prev_k_z_d_real = None\n\n        for theta_deg in angles_deg:\n            theta_rad = np.deg2rad(theta_deg)\n            kx = k0 * np.sin(theta_rad)\n\n            # --- 1. Forward Model: Calculate S-parameters ---\n            \n            # Impedance of vacuum for TM waves at angle theta\n            k_z0 = k0 * np.cos(theta_rad)\n            Zc0_tm = Z0 * np.cos(theta_rad) if np.cos(theta_rad) > 1e-9 else Z0\n\n            # Calculate slab properties based on model\n            if model[\"type\"] == \"isotropic\":\n                eps_r = model[\"params\"][\"eps_r\"]\n                mu_r = model[\"params\"][\"mu_r\"]\n                n_sq = eps_r * mu_r\n                k_z_sq = k0**2 * n_sq - kx**2\n                k_z = np.sqrt(k_z_sq + 0j) # Ensure complex result if negative\n                Zc_tm = k_z / (omega * eps_r * epsilon_0)\n                \n            elif model[\"type\"] == \"uniaxial\":\n                eps_t = model[\"params\"][\"eps_t\"]\n                eps_z = model[\"params\"][\"eps_z\"]\n                mu_r = model[\"params\"][\"mu_r\"]\n                k_z_sq = eps_t * (k0**2 * mu_r - kx**2 / eps_z)\n                k_z = np.sqrt(k_z_sq + 0j)\n                Zc_tm = k_z / (omega * eps_t * epsilon_0)\n\n            elif model[\"type\"] == \"spatially_dispersive\":\n                eps_r0 = model[\"params\"][\"eps_r0\"]\n                alpha = model[\"params\"][\"alpha\"]\n                mu_r = model[\"params\"][\"mu_r\"]\n                eps_r_kx = eps_r0 + alpha * (kx / k0)**2\n                k_z_sq = k0**2 * mu_r * eps_r_kx - kx**2\n                k_z = np.sqrt(k_z_sq + 0j)\n                Zc_tm = k_z / (omega * eps_r_kx * epsilon_0)\n\n            # Normalized impedance\n            z_norm = Zc_tm / Zc0_tm\n\n            # Calculate S-parameters from ABCD matrix relations\n            cos_kzd = np.cos(k_z * d)\n            sin_kzd = np.sin(k_z * d)\n            denominator = 2*z_norm*cos_kzd + 1j * (z_norm**2 + 1) * sin_kzd\n            S11 = 1j * (z_norm**2 - 1) * sin_kzd / denominator\n            S21 = 2 * z_norm / denominator\n            \n            # --- 2. Inverse Model: Retrieve k_z and n_eff ---\n\n            # Suppress division by zero warnings for S11=0 at normal incidence\n            with np.errstate(divide='ignore', invalid='ignore'):\n                 K = (1 + S11**2 - S21**2) / (2 * S11)\n            \n            if np.abs(S11)  1e-9: # Handle normal incidence case where S11 is 0\n                r = 0.0 + 0.0j\n            else:\n                # Solve r^2 - 2Kr + 1 = 0\n                sqrt_discriminant = np.sqrt(K**2 - 1, dtype=np.complex128)\n                r1 = K + sqrt_discriminant\n                r2 = K - sqrt_discriminant\n                \n                # Select physical root |r| = 1\n                r = r1 if abs(r1) = 1.0 else r2\n                \n            # Retrieve propagation factor T = exp(-ik_z d)\n            # The convention here is exp(ikz), so we need to invert\n            # T = S21 / (1-S11*r) for exp(ikz)\n            T_exp = (S21) / (1 - S11 * r) \n\n            # Retrieve k_z * d from complex log, resolving 2*pi ambiguity\n            k_z_d_retrieved = -1j * np.log(T_exp)\n            \n            # Phase unwrapping for continuity across angles\n            if prev_k_z_d_real is not None:\n                diff = k_z_d_retrieved.real - prev_k_z_d_real\n                m = np.round(diff / (2 * np.pi))\n                k_z_d_retrieved -= 2 * np.pi * m\n            prev_k_z_d_real = k_z_d_retrieved.real\n            \n            k_z_retrieved = k_z_d_retrieved / d\n            \n            # --- 3. Calculate Effective Refractive Index ---\n            n_eff_sq = (k_z_retrieved / k0)**2 + np.sin(theta_rad)**2\n            n_eff = np.sqrt(n_eff_sq)\n            \n            # Ensure Re(n_eff) >= 0\n            if n_eff.real  0:\n                n_eff = -n_eff\n            \n            n_eff_real_parts.append(n_eff.real)\n\n        # Compute standard deviation for the model\n        std_dev = np.std(n_eff_real_parts)\n        final_results.append(std_dev)\n    \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, final_results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "等效介质理论是一个强大的近似，但它有其适用范围，特别是当波长与结构周期尺寸相当时。本实践提供了一种清晰且定量的方法来探索这些局限性 。通过比较离散晶格的精确色散关系与其均质化后连续体模型的色散关系，我们可以确定在何种波矢（或入射角）范围内，局域等效介质描述能够保持足够的精度。",
            "id": "3314227",
            "problem": "考虑一个周期为 $a$ 的三维简立方超材料晶格，该晶格嵌入自由空间中，其中自由空间波长为 $\\lambda$，自由空间波数为 $k_0 = 2\\pi/\\lambda$。设晶格满足 $a/\\lambda = 0.1$。一个有效介质近似将该结构建模为一个折射率为 $n_{\\mathrm{eff}}$ 的均匀各向同性连续介质。为分离出由周期性引起空间色散的作用，假设 $n_{\\mathrm{eff}} = 1$，因此对于一个横向（面内）波矢大小为 $k_\\parallel$ 的平面波，其连续介质色散关系为 $k_z^{\\mathrm{cont}} = \\sqrt{(n_{\\mathrm{eff}} k_0)^2 - k_\\parallel^2} = \\sqrt{k_0^2 - k_\\parallel^2}$，并且穿过平板累积的透射相位与 $k_z^{\\mathrm{cont}}$ 成正比。\n\n为了评估在斜入射情况下均匀化的失效情况，我们使用离散色散关系来近似晶格引起的非局域性，该离散色散关系源于简立方网格上标量亥姆霍兹算符的二阶中心差分表示。对于一个分量为 $(k_x, k_y, k_z)$ 的平面波解，离散布洛赫-弗洛凯关系为\n$$\n\\sin^2\\!\\left(\\frac{k_x a}{2}\\right) + \\sin^2\\!\\left(\\frac{k_y a}{2}\\right) + \\sin^2\\!\\left(\\frac{k_z a}{2}\\right) = \\left(\\frac{k_0 a}{2}\\right)^2.\n$$\n给定一个横向大小 $k_\\parallel$，考虑两种入射构型：\n- 沿轴斜向：$k_x = k_\\parallel$，$k_y = 0$。\n- 沿面对角线斜向：$k_x = k_y = k_\\parallel/\\sqrt{2}$。\n\n对于每种构型，将 $k_z^{\\mathrm{disc}}$ 定义为离散关系的正实数解（如果存在），并在固定的 $k_\\parallel$ 下，将相对相位误差度量为\n$$\nE(k_\\parallel) = \\frac{\\left|k_z^{\\mathrm{disc}} - k_z^{\\mathrm{cont}}\\right|}{\\left|k_z^{\\mathrm{cont}}\\right|}.\n$$\n当 $E(k_\\parallel) \\le \\delta$ 时，认为均匀化是准确的，其中 $\\delta$ 是以小数表示的指定容差。您必须估算最大的归一化横向波矢\n$$\n\\kappa_{\\max} = \\frac{k_\\parallel}{k_0}\n$$\n在此范围内，上述准确性标准对沿轴斜向和沿面对角线斜向两种构型都成立。此外，对于垂直入射 $k_\\parallel = 0$，报告是否满足相同的准确性标准。\n\n您的程序必须为一小组 $(a/\\lambda, \\delta)$ 对的测试套件计算这些量。所有量都是无量纲的，因此不需要进行物理单位转换。数值步骤应为：\n- 对于给定的 $a/\\lambda$ 和 $\\delta$，设置 $k_0 a = 2\\pi (a/\\lambda)$。\n- 对于每种构型，在 $\\kappa \\in [0,1]$（其中 $k_z^{\\mathrm{cont}}$ 保持为实数）上搜索，以找到最大的 $\\kappa_{\\max}$，使得离散解存在且 $E(k_\\parallel) \\le \\delta$，其中 $k_\\parallel = \\kappa k_0$。\n- 对于垂直入射（$k_\\parallel = 0$），计算沿轴斜向离散关系的 $E(0)$，并报告一个布尔值，指示是否 $E(0) \\le \\delta$。\n\n设计您的算法以对边缘情况具有鲁棒性，包括边界 $\\delta = 0$ 和接近均匀化模型失效的较大 $a/\\lambda$ 值。您的实现不得依赖于指定测试套件之外的任何外部输入。\n\n测试套件：\n1. $(a/\\lambda, \\delta) = (0.1, 0.05)$。\n2. $(a/\\lambda, \\delta) = (0.1, 0.0)$。\n3. $(a/\\lambda, \\delta) = (0.2, 0.05)$。\n4. $(a/\\lambda, \\delta) = (0.05, 0.05)$。\n\n输出规范：\n- 对于每个测试用例，输出一个包含三个条目的列表 $[\\kappa_{\\max}^{\\mathrm{axis}}, \\kappa_{\\max}^{\\mathrm{diag}}, \\mathrm{normal\\_ok}]$，其中 $\\kappa_{\\max}^{\\mathrm{axis}}$ 和 $\\kappa_{\\max}^{\\mathrm{diag}}$ 是四舍五入到六位小数的浮点数，而 $\\mathrm{normal\\_ok}$ 是一个布尔值，指示是否 $E(0) \\le \\delta$。\n- 您的程序应生成一行输出，其中包含一个用方括号括起来的、以逗号分隔的结果列表，例如 $[[x_1,y_1,\\mathrm{True}],[x_2,y_2,\\mathrm{False}],\\dots]$。\n\n推导约束：\n- 从麦克斯韦方程组和标量亥姆霍兹方程开始，然后证明使用离散中心差分色散来模拟简立方超材料中晶格引起的空间色散的合理性。\n- 未经证明，不得使用或引用任何快捷公式；论证应基于经过充分检验的事实，如亥姆霍兹方程的平面波解和布洛赫-弗洛凯理论。\n- 确保所有参数和近似值的科学真实性和内部一致性。",
            "solution": "该问题要求分析简立方超材料晶格的有效介质近似的失效情况。这是通过量化由晶格引起的空间色散所产生的相位误差来实现的，而一个简单的局域均匀化模型无法捕捉到这种空间色散。该分析基于将一个连续介质模型与一个从标量亥姆霍兹方程的有限差分近似导出的离散模型进行比较。\n\n**理论基础：连续介质色散与离散色散**\n\n角频率为 $\\omega$ 的单色电磁波的传播由麦克斯韦方程组控制，这些方程可以合并为矢量亥姆霍兹方程。对于某些偏振或在标量近似下，问题简化为场分量 $\\psi$ 的标量亥姆霍兹方程：\n$$\n\\nabla^2 \\psi(\\mathbf{r}) + n^2 k_0^2 \\psi(\\mathbf{r}) = 0\n$$\n其中 $k_0 = \\omega/c = 2\\pi/\\lambda$ 是自由空间波数，$n$ 是介质的折射率。\n\n在均匀、各向同性的连续介质中，$n$ 是一个常数。问题指定了一个有效介质，其 $n_{\\mathrm{eff}} = 1$，以分离出空间色散效应。亥姆霍兹方程变为 $(\\nabla^2 + k_0^2)\\psi = 0$。对于形式为 $\\psi(\\mathbf{r}) = e^{i\\mathbf{k}\\cdot\\mathbf{r}}$ 的平面波解，其中 $\\mathbf{k} = (k_x, k_y, k_z)$ 是波矢，代入方程可得到连续介质色散关系：\n$$\nk_x^2 + k_y^2 + k_z^2 = k_0^2\n$$\n给定横向波矢 $\\mathbf{k}_\\parallel = (k_x, k_y)$，其大小为 $k_\\parallel = \\sqrt{k_x^2 + k_y^2}$，前向传播波的纵向分量 $k_z$ 为：\n$$\nk_z^{\\mathrm{cont}} = \\sqrt{k_0^2 - k_\\parallel^2}\n$$\n这个关系是各向同性的，意味着它只取决于波矢的大小，而不取决于其方向。\n\n对于超材料，其结构是周期为 $a$ 的简立方晶格。周期性破坏了连续的平移对称性。一个已确立的、用于模拟这种周期性对波传播的最低阶效应的方法是，在与晶格匹配的立方网格上离散化亥姆霍兹方程。用其二阶中心差分近似替换连续的拉普拉斯算符 $\\nabla^2$，可以得到一个修正的色散关系。对于网格点 $\\mathbf{r}_j$ 上的布洛赫波解 $\\psi_j \\propto e^{i\\mathbf{k}\\cdot\\mathbf{r}_j}$，有限差分亥姆霍兹方程变为：\n$$\n\\frac{e^{ik_xa} - 2 + e^{-ik_xa}}{a^2} + \\frac{e^{ik_ya} - 2 + e^{-ik_ya}}{a^2} + \\frac{e^{ik_za} - 2 + e^{-ik_za}}{a^2} + k_0^2 = 0\n$$\n使用恒等式 $2(1-\\cos\\theta) = 4\\sin^2(\\theta/2)$，该方程可以改写为：\n$$\n-\\frac{4}{a^2}\\sin^2\\left(\\frac{k_x a}{2}\\right) - \\frac{4}{a^2}\\sin^2\\left(\\frac{k_y a}{2}\\right) - \\frac{4}{a^2}\\sin^2\\left(\\frac{k_z a}{2}\\right) + k_0^2 = 0\n$$\n重新整理后，得到问题陈述中提供的离散色散关系，该关系模拟了晶格引起的非局域性（空间色散）：\n$$\n\\sin^2\\left(\\frac{k_x a}{2}\\right) + \\sin^2\\left(\\frac{k_y a}{2}\\right) + \\sin^2\\left(\\frac{k_z a}{2}\\right) = \\left(\\frac{k_0 a}{2}\\right)^2\n$$\n这个关系是各向异性的；它取决于单个分量 $k_x$、$k_y$ 和 $k_z$，反映了底层立方晶格的优选方向。\n\n**误差量化与计算方法**\n\n为了便于计算，我们使用无量纲量。令 $\\hat{a} = k_0 a = 2\\pi a/\\lambda$ 为归一化晶格常数，$\\kappa = k_\\parallel/k_0$ 为归一化横向波矢。波数由 $k_0$ 归一化，因此 $\\hat{k}_i = k_i/k_0$。\n\n归一化连续介质传播常数为：\n$$\n\\hat{k}_z^{\\mathrm{cont}}(\\kappa) = \\frac{k_z^{\\mathrm{cont}}}{k_0} = \\sqrt{1 - \\kappa^2}\n$$\n归一化离散传播常数 $\\hat{k}_z^{\\mathrm{disc}} = k_z^{\\mathrm{disc}}/k_0$ 是通过求解离散色散关系中的 $k_z$ 得到的。令 $S(\\kappa) = \\sin^2(k_x a/2) + \\sin^2(k_y a/2)$。该关系为 $\\sin^2(k_z a/2) = (k_0 a/2)^2 - S(\\kappa)$。求解 $k_z$ 得到 $k_z^{\\mathrm{disc}} = \\frac{2}{a} \\arcsin\\left(\\sqrt{(k_0 a/2)^2 - S(\\kappa)}\\right)$。其归一化形式为：\n$$\n\\hat{k}_z^{\\mathrm{disc}}(\\kappa) = \\frac{k_z^{\\mathrm{disc}}}{k_0} = \\frac{2}{k_0 a} \\arcsin\\left(\\sqrt{\\left(\\frac{k_0 a}{2}\\right)^2 - S(\\kappa)}\\right) = \\frac{2}{\\hat{a}} \\arcsin\\left(\\sqrt{\\left(\\frac{\\hat{a}}{2}\\right)^2 - S(\\kappa)}\\right)\n$$\n项 $S(\\kappa)$ 取决于入射构型：\n1.  **沿轴斜向**：$k_x = k_\\parallel = \\kappa k_0$, $k_y = 0$。\n    $$S_{\\mathrm{axis}}(\\kappa) = \\sin^2\\left(\\frac{\\kappa k_0 a}{2}\\right) = \\sin^2\\left(\\frac{\\kappa \\hat{a}}{2}\\right)$$\n2.  **沿面对角线斜向**：$k_x = k_y = k_\\parallel/\\sqrt{2} = \\kappa k_0/\\sqrt{2}$。\n    $$S_{\\mathrm{diag}}(\\kappa) = 2\\sin^2\\left(\\frac{\\kappa k_0 a}{2\\sqrt{2}}\\right) = 2\\sin^2\\left(\\frac{\\kappa \\hat{a}}{2\\sqrt{2}}\\right)$$\n\n因此，相对误差 $E(\\kappa)$ 计算如下：\n$$\nE(\\kappa) = \\frac{|\\hat{k}_z^{\\mathrm{disc}}(\\kappa) - \\hat{k}_z^{\\mathrm{cont}}(\\kappa)|}{\\hat{k}_z^{\\mathrm{cont}}(\\kappa)}\n$$\n对于每个测试用例 $(\\alpha, \\delta)$，其中 $\\alpha=a/\\lambda$，我们首先计算 $\\hat{a} = 2\\pi\\alpha$。然后我们执行所需的计算。\n\n**垂直入射 ($\\kappa=0$):**\n对于 $\\kappa=0$，我们有 $k_\\parallel=0$，因此 $k_x=k_y=0$。两种构型是相同的。\n$\\hat{k}_z^{\\mathrm{cont}}(0) = 1$。离散关系给出 $\\hat{k}_z^{\\mathrm{disc}}(0) = \\frac{2}{\\hat{a}} \\arcsin(\\hat{a}/2)$。误差为 $E(0) = |\\frac{2}{\\hat{a}} \\arcsin(\\hat{a}/2) - 1|$。如果 $E(0) \\le \\delta$，则条件 `normal_ok` 为真。\n\n**斜入射 ($\\kappa>0$):**\n为了找到 $\\kappa_{\\max}$，我们必须找到最大的 $\\kappa \\in [0, 1)$，使得 $E(\\kappa) \\le \\delta$。误差函数 $E(\\kappa)$ 从 $\\kappa=0$ 时的 $E(0)$ 开始单调递增，并在 $\\kappa \\to 1$ 时发散（因为 $\\hat{k}_z^{\\mathrm{cont}}(\\kappa) \\to 0$）。这种结构使得该问题适合使用数值求根算法。\n算法流程如下：\n1.  对于给定的构型（沿轴或对角线），定义目标函数 $f(\\kappa) = E(\\kappa) - \\delta$。\n2.  如果 $f(0) > 0$（即 $E(0) > \\delta$），即使在垂直入射时条件也不满足，因此 $\\kappa_{\\max} = 0$。\n3.  检查在非常接近 1 的 $\\kappa$ 值（例如 $\\kappa_{high} = 1 - 10^{-9}$）处的误差。如果 $f(\\kappa_{high}) \\le 0$，则误差在整个范围内都保持在容差之内，因此 $\\kappa_{\\max} = 1$。\n4.  如果 $f(0) \\le 0$ 且 $f(\\kappa_{high}) > 0$，则在区间 $(0, \\kappa_{high})$ 中存在一个唯一的根。我们采用鲁棒的求根方法，如布伦特方法（`scipy.optimize.brentq`），来求解 $f(\\kappa) = 0$。得到的根即为 $\\kappa_{\\max}$。\n\n鲁棒的实现必须处理潜在的数值域错误，确保 `sqrt` 的参数为非负数，`arcsin` 的参数在 $[-1, 1]$ 范围内。对于给定的问题参数，离散波矢的截止发生在 $\\kappa \\ge 1$ 处，因此搜索域受限于连续介质模型在 $\\kappa=1$ 处的截止。\n对沿轴斜向和沿面对角线斜向两种构型重复此过程，以找到 $\\kappa_{\\max}^{\\mathrm{axis}}$ 和 $\\kappa_{\\max}^{\\mathrm{diag}}$。然后将最终结果按指定格式进行格式化。",
            "answer": "```python\nimport numpy as np\nfrom scipy.optimize import brentq\n\ndef solve():\n    \"\"\"\n    Solves the metamaterial homogenization error problem for a suite of test cases.\n    \"\"\"\n    test_cases = [\n        (0.1, 0.05),\n        (0.1, 0.0),\n        (0.2, 0.05),\n        (0.05, 0.05),\n    ]\n\n    results = []\n    for a_lambda, delta in test_cases:\n        result = compute_metrics(a_lambda, delta)\n        results.append(result)\n\n    # Format output according to the problem specification.\n    # e.g., [[0.123456, 0.234567, True], [0.0, 0.0, False]]\n    output_str = \"[\" + \",\".join(\n        f\"[{res[0]:.6f},{res[1]:.6f},{str(res[2]).lower()}]\" for res in results\n    ) + \"]\"\n    print(output_str)\n\ndef compute_metrics(a_lambda, delta):\n    \"\"\"\n    Computes kappa_max_axis, kappa_max_diag, and normal_ok for a given (a/lambda, delta) pair.\n    \"\"\"\n    # Dimensionless lattice parameter\n    a_hat = 2.0 * np.pi * a_lambda\n\n    # --- Normal Incidence Check (kappa = 0) ---\n    k_z_cont_norm_0 = 1.0\n    \n    # Check if a_hat/2 is in arcsin domain\n    if a_hat / 2.0 >= 1.0:\n        # This occurs when a/lambda >= 1/pi, outside the problem's typical range.\n        # In this case, the discrete mode is evanescent even at normal incidence.\n        error_0 = np.inf\n    else:\n        k_z_disc_norm_0 = (2.0 / a_hat) * np.arcsin(a_hat / 2.0)\n        error_0 = np.abs(k_z_disc_norm_0 - k_z_cont_norm_0)\n    \n    normal_ok = error_0 = delta\n\n    # --- Find kappa_max for Both Configurations ---\n    k_max_values = []\n    for config in ['axis', 'diag']:\n        def root_function(kappa):\n            \"\"\"\n            This function calculates E(kappa) - delta. The root of this function is kappa_max.\n            It is designed to be used with a root-finding algorithm like brentq.\n            \"\"\"\n            # Handle kappa range. k_z_cont is complex or zero for kappa >= 1.\n            # The denominator of the relative error would be zero.\n            if kappa >= 1.0:\n                return np.inf\n\n            k_z_cont_norm = np.sqrt(1.0 - kappa**2)\n\n            if config == 'axis':\n                s_term = np.sin(kappa * a_hat / 2.0)**2\n            else:  # 'diag'\n                s_term = 2.0 * np.sin(kappa * a_hat / (2.0 * np.sqrt(2.0)))**2\n            \n            # Argument for the square root in the discrete calculation\n            arg_sqrt = (a_hat / 2.0)**2 - s_term\n            \n            # Check for discrete cutoff (evanescent wave)\n            if arg_sqrt  0:\n                return np.inf\n            \n            # Argument for arcsin\n            arg_asin = np.sqrt(arg_sqrt)\n            if arg_asin > 1.0:\n                 return np.inf\n\n            k_z_disc_norm = (2.0 / a_hat) * np.arcsin(arg_asin)\n            \n            # Relative error E(kappa)\n            rel_error = np.abs(k_z_disc_norm - k_z_cont_norm) / k_z_cont_norm\n            \n            return rel_error - delta\n\n        # --- Determine kappa_max using the root function ---\n        if error_0 > delta:\n            # If error at normal incidence already exceeds tolerance, kappa_max is 0.\n            k_max = 0.0\n        else:\n            # Search for kappa_max in [0, 1). Test the upper boundary first.\n            # Use a point very close to 1 to avoid division by zero.\n            kappa_high_test = 1.0 - 1e-12\n            if root_function(kappa_high_test) = 0:\n                # If error is within tolerance for all kappa up to 1, kappa_max is 1.0.\n                k_max = 1.0\n            else:\n                # Use Brent's method to find the root of root_function(kappa) = 0.\n                # This gives the kappa where the error equals the tolerance.\n                try:\n                    k_max = brentq(root_function, 0, kappa_high_test)\n                except ValueError:\n                    # Fallback in case brentq fails (e.g., no sign change).\n                    # Given the function's behavior, this should not occur if\n                    # root_function(0)  0 and root_function(kappa_high_test) > 0.\n                    k_max = 0.0\n        \n        k_max_values.append(k_max)\n\n    return [k_max_values[0], k_max_values[1], normal_ok]\n\nif __name__ == \"__main__\":\n    solve()\n\n```"
        }
    ]
}