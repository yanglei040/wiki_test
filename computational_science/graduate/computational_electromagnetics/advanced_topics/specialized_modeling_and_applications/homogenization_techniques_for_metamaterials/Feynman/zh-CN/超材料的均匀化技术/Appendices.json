{
    "hands_on_practices": [
        {
            "introduction": "本实践是静态均匀化理论的基石。我们将学习如何通过在一个基本单元上数值求解“元胞问题”，来计算周期性超材料的宏观等效介电常数。这项练习旨在培养应用有限体积法或有限差分法等数值方法，从微观结构推导宏观材料属性的基本技能。",
            "id": "3314289",
            "problem": "考虑一个二维周期性超材料，其方形晶胞边长为 $a$，由两种标量正介电常数 $\\epsilon_1$ 和 $\\epsilon_2$ 以棋盘格形式填充在交替的象限中。宏观有效介电常数张量 $\\bar{\\bar{\\epsilon}}_{\\text{eff}}$ 在长波极限下由均匀化关系 $\\langle \\mathbf{D} \\rangle = \\bar{\\bar{\\epsilon}}_{\\text{eff}} \\langle \\mathbf{E} \\rangle$ 定义，其中 $\\mathbf{D} = \\epsilon(\\mathbf{x}) \\mathbf{E}$ 且 $\\mathbf{E} = -\\nabla u$，$u$ 为标量电势。在均匀化设定中，针对典范宏观单位矢量 $\\mathbf{e}_x = (1,0)$ 和 $\\mathbf{e}_y = (0,1)$ 的修正问题是在具有周期性边界条件和零均值修正子的晶胞上提出的。\n\n从Maxwell方程组及其静电极限出发，可以根据本构关系和无电荷条件推导出晶胞问题，如下所示。令 $u_j(\\mathbf{x}) = -\\mathbf{e}_j \\cdot \\mathbf{x} + w_j(\\mathbf{x})$，其中 $j \\in \\{x,y\\}$，$w_j$ 是晶胞上的零均值周期函数。局部电场为 $\\mathbf{E}_j(\\mathbf{x}) = \\mathbf{e}_j - \\nabla w_j(\\mathbf{x})$，位移场为 $\\mathbf{D}_j(\\mathbf{x}) = \\epsilon(\\mathbf{x}) \\mathbf{E}_j(\\mathbf{x})$。修正子 $w_j$ 满足晶胞问题\n$$\n\\nabla \\cdot \\left( \\epsilon(\\mathbf{x}) \\left( \\mathbf{e}_j - \\nabla w_j(\\mathbf{x}) \\right) \\right) = 0\n$$\n该问题在周期性晶胞上求解，并对 $w_j$ 施加零均值约束。有效介电常数张量按列计算，公式为\n$$\n\\bar{\\bar{\\epsilon}}_{\\text{eff}} \\, \\mathbf{e}_j = \\langle \\mathbf{D}_j \\rangle = \\frac{1}{a^2} \\int_{\\text{cell}} \\epsilon(\\mathbf{x}) \\left( \\mathbf{e}_j - \\nabla w_j(\\mathbf{x}) \\right) \\, d\\mathbf{x}.\n$$\n\n您必须在均匀网格上实现有限体积或有限差分格式，以近似求解 $j \\in \\{x,y\\}$ 的晶胞问题，然后计算 $\\bar{\\bar{\\epsilon}}_{\\text{eff}}$。在单元交界面处使用 $\\epsilon$ 的调和平均，以确保跨材料界面的通量一致。施加周期性边界条件，并通过强制将 $w_j$ 的单个节点值设为 $0$ 来固定规范，以满足（在相差一个常数的情况下）零均值约束。\n\n定义晶胞边长 $a = 1$，棋盘格图案为四个象限：\n- 左下象限和右上象限的介电常数为 $\\epsilon_1$。\n- 左上象限和右下象限的介电常数为 $\\epsilon_2$。\n也就是说，对于坐标 $x \\in [0,1)$ 和 $y \\in [0,1)$，根据象限分配 $\\epsilon_1$ 或 $\\epsilon_2$，面积分数相等。\n\n使用均匀的 $N \\times N$ 网格对晶胞进行离散化，其中网格点数 $N$ 是尺度分离参数 $\\eta = a/\\lambda$ 的函数，由 $N(\\eta) = \\lceil N_0 / \\eta \\rceil$ 给出，其中固定基础分辨率 $N_0 = 12$。此处 $\\lambda$ 是一个名义上的自由空间波长，仅用于参数化 $\\eta$；修正问题是静态的，不直接依赖于 $\\lambda$，但 $N(\\eta)$ 用于研究当尺度分离增加（即 $\\eta$ 变小）时的数值收敛性。使用网格间距 $h = a/N$。\n\n通过求解\n$$\n\\nabla \\cdot \\left( \\epsilon(\\mathbf{x}) \\nabla w_j(\\mathbf{x}) \\right) = \\nabla \\cdot \\left( \\epsilon(\\mathbf{x}) \\mathbf{e}_j \\right)\n$$\n来计算离散修正子 $w_x$ 和 $w_y$，并施加周期性边界条件和规范固定。右侧项应离散化为对应于 $\\epsilon(\\mathbf{x}) \\mathbf{e}_j$ 的面通量的离散散度（即，对于 $j=x$ 是 $\\partial_x \\epsilon$，对于 $j=y$ 是 $\\partial_y \\epsilon$），并使用与左侧项相同的调和面平均法。在求解出 $w_j$ 后，计算局部场并对位移场进行平均，以获得有效张量的分量。\n\n所有介电常数和有效张量分量均以法拉每米 (F/m) 表示。数值输出必须为浮点数。\n\n测试套件：\n使用以下参数集，每个参数集由 $(\\epsilon_1, \\epsilon_2, \\eta)$ 指定，其中 $\\epsilon_1$ 和 $\\epsilon_2$ 的单位为 F/m，$\\eta$ 为无量纲：\n1. $(2.0, 8.0, 0.5)$\n2. $(2.0, 8.0, 0.25)$\n3. $(2.0, 8.0, 0.125)$\n4. $(5.0, 5.0, 0.25)$\n此外，对于 $(2.0, 8.0, 0.25)$，计算两个标量诊断量：\n- 各向异性度量，定义为 $|\\bar{\\bar{\\epsilon}}_{\\text{eff}}(1,1) - \\bar{\\bar{\\epsilon}}_{\\text{eff}}(2,2)|$ 除以对角线平均值 $\\frac{1}{2}(\\bar{\\bar{\\epsilon}}_{\\text{eff}}(1,1) + \\bar{\\bar{\\epsilon}}_{\\text{eff}}(2,2))$ 进行归一化。\n- 非对角量级，定义为 $\\max\\{|\\bar{\\bar{\\epsilon}}_{\\text{eff}}(1,2)|, |\\bar{\\bar{\\epsilon}}_{\\text{eff}}(2,1)|\\}$ 除以相同的对角线平均值进行归一化。\n\n对于前三种情况，返回标量各向同性估计值，定义为对角线项的平均值 $\\frac{1}{2}(\\bar{\\bar{\\epsilon}}_{\\text{eff}}(1,1) + \\bar{\\bar{\\epsilon}}_{\\text{eff}}(2,2))$，单位为 F/m。对于第四种情况，返回各向同性估计值与 $\\epsilon_1$（等于 $\\epsilon_2$）的绝对偏差，单位为 F/m。\n\n最终输出格式：\n您的程序应生成一行输出，其中包含一个逗号分隔的列表，用方括号括起来，结果按以下顺序排列：\n- 情况1、2和3的各向同性估计值（单位：F/m）。\n- 收敛比，定义为 $\\frac{|I_1 - I_2|}{|I_2 - I_3|}$，其中 $I_k$ 是情况 $k$ 的各向同性估计值，无量纲。\n- 情况4的绝对偏差（单位：F/m）。\n- 情况 $(2.0, 8.0, 0.25)$ 的各向异性度量（无量纲）。\n- 情况 $(2.0, 8.0, 0.25)$ 的归一化非对角量级（无量纲）。\n\n例如，输出应如下所示：\n$[I_1,I_2,I_3,R,\\Delta,I_{\\text{aniso}},I_{\\text{off}}]$\n所有条目均以标准Python浮点数打印。",
            "solution": "该问题要求计算具有棋盘格结构的二维周期性超材料的有效介电常数张量 $\\bar{\\bar{\\epsilon}}_{\\text{eff}}$。这是均匀化理论中的一个经典问题，我们将使用以单元为中心的有限体积法 (FVM) 进行数值求解。\n\n### 1. 理论公式\n\n在长波极限下，平均电位移场 $\\langle \\mathbf{D} \\rangle$ 与平均电场 $\\langle \\mathbf{E} \\rangle$ 之间的关系由 $\\langle \\mathbf{D} \\rangle = \\bar{\\bar{\\epsilon}}_{\\text{eff}} \\langle \\mathbf{E} \\rangle$ 给出。有效介电常数张量 $\\bar{\\bar{\\epsilon}}_{\\text{eff}}$ 可以通过在材料的晶胞上求解一组所谓的“晶胞问题”来确定。\n\n对于一个宏观恒定电场 $\\mathbf{E}_0$，局部场为 $\\mathbf{E}(\\mathbf{x}) = \\mathbf{E}_0 - \\nabla w(\\mathbf{x})$，其中 $w(\\mathbf{x})$ 是一个周期性的“修正”势。从无电荷条件 $\\nabla \\cdot \\mathbf{D} = 0$ 推导出的修正子控制方程为\n$$\n\\nabla \\cdot \\left( \\epsilon(\\mathbf{x}) (\\mathbf{E}_0 - \\nabla w(\\mathbf{x})) \\right) = 0\n$$\n为了找到 $\\bar{\\bar{\\epsilon}}_{\\text{eff}}$ 的分量，我们针对两种特定情况求解此方程：$\\mathbf{E}_0 = \\mathbf{e}_x = (1,0)$ 和 $\\mathbf{E}_0 = \\mathbf{e}_y = (0,1)$。这会得到两个修正势 $w_x$ 和 $w_y$。相应的晶胞问题是：\n$$\n\\nabla \\cdot \\left( \\epsilon(\\mathbf{x}) \\nabla w_j(\\mathbf{x}) \\right) = \\nabla \\cdot \\left( \\epsilon(\\mathbf{x}) \\mathbf{e}_j \\right) \\quad \\text{for } j \\in \\{x, y\\}\n$$\n这些是需要在具有周期性边界条件的晶胞上求解的类泊松方程。修正子 $w_j$ 在相差一个加性常数的意义下是唯一的，该常数通过规范条件固定。\n\n一旦找到 $w_j$，有效介电常数张量的第 $j$ 列由局部电位移场 $\\mathbf{D}_j(\\mathbf{x}) = \\epsilon(\\mathbf{x})(\\mathbf{e}_j - \\nabla w_j(\\mathbf{x}))$ 的平均值给出：\n$$\n\\bar{\\bar{\\epsilon}}_{\\text{eff}} \\mathbf{e}_j = \\langle \\mathbf{D}_j \\rangle = \\frac{1}{|\\Omega|} \\int_{\\Omega} \\epsilon(\\mathbf{x}) (\\mathbf{e}_j - \\nabla w_j(\\mathbf{x})) \\, d\\mathbf{x}\n$$\n其中 $\\Omega$ 是晶胞区域， $|\\Omega|$ 是其面积。\n\n### 2. 使用有限体积法的数值离散化\n\n我们将晶胞（边长 $a=1$）离散化为一个均匀的 $N \\times N$ 网格单元，网格间距为 $h=1/N$。修正势 $w$ 定义在每个单元 $(i,j)$ 的中心，记为 $w_{i,j}$。介电常数 $\\epsilon$ 在每个单元内被视为分段常数，其值 $\\epsilon_{i,j}$ 由单元的中心坐标确定。\n\n对每个控制体积（单元） $V_{i,j}$ 积分晶胞问题并应用散度定理，得到一个通量平衡方程：\n$$\n\\int_{\\partial V_{i,j}} \\epsilon(\\mathbf{x}) \\nabla w_j \\cdot \\hat{\\mathbf{n}} \\, dS = \\int_{\\partial V_{i,j}} \\epsilon(\\mathbf{x}) \\mathbf{e}_j \\cdot \\hat{\\mathbf{n}} \\, dS\n$$\n通量在每个单元的四个面（东、西、南、北）上进行评估。对于左侧项 (LHS)，穿过单元 $(i,j)$ 与其东侧邻居 $(i+1, j)$ 之间界面的通量近似为：\n$$\nF_{\\text{LHS, E}} = h \\cdot \\epsilon_{i+1/2, j} \\frac{w_{i+1,j} - w_{i,j}}{h} = \\epsilon_{i+1/2, j} (w_{i+1,j} - w_{i,j})\n$$\n其中 $\\epsilon_{i+1/2, j}$ 是界面上的介电常数。为确保跨材料界面的通量连续性，我们按规定使用调和平均：\n$$\n\\epsilon_{i+1/2, j} = \\frac{2 \\epsilon_{i,j} \\epsilon_{i+1,j}}{\\epsilon_{i,j} + \\epsilon_{i+1,j}}\n$$\n对所有四个面的出射通量求和，得到单元 $(i,j)$ 的离散方程：\n$$\n\\epsilon_{i+1/2,j}(w_{i,j}-w_{i+1,j}) + \\epsilon_{i-1/2,j}(w_{i,j}-w_{i-1,j}) + \\epsilon_{i,j+1/2}(w_{i,j}-w_{i,j+1}) + \\epsilon_{i,j-1/2}(w_{i,j}-w_{i,j-1}) = \\text{RHS}_{i,j}\n$$\n右侧项 (RHS) 是 $\\epsilon \\mathbf{e}_j$ 的净通量。对于 $j=x$，这只涉及穿过东、西面的通量：\n$$\n\\text{RHS}_{i,j}^{(x)} = (h \\cdot \\epsilon_{i+1/2,j} \\cdot 1) - (h \\cdot \\epsilon_{i-1/2,j} \\cdot 1) = h(\\epsilon_{i+1/2, j} - \\epsilon_{i-1/2, j})\n$$\n类似地，对于 $j=y$，RHS 涉及穿过南、北面的通量：\n$$\n\\text{RHS}_{i,j}^{(y)} = h(\\epsilon_{i, j+1/2} - \\epsilon_{i, j-1/2})\n$$\n通过环绕索引来施加周期性边界条件，例如，$w_{N,j} = w_{0,j}$，$w_{i,-1} = w_{i,N-1}$。\n这种公式化产生一个关于 $N^2$ 个未知修正子值的稀疏线性方程组 $A \\mathbf{w} = \\mathbf{b}$，其中 $\\mathbf{w}$ 是 $w_{i,j}$ 的扁平化向量。由于周期性边界条件，矩阵 $A$ 是奇异的（其零空间包含常数向量）。为了获得唯一解，我们通过将一个节点的电势设为零来固定规范，例如，$w_{0,0}=0$。这是通过修改线性系统的第一行和右侧项来实现的，以强制执行此约束，从而使系统非奇异。\n\n### 3. 有效介电常数的计算\n\n求解修正势 $w_x$ 和 $w_y$ 的线性系统后，我们计算 $\\bar{\\bar{\\epsilon}}_{\\text{eff}}$ 的分量。这需要对所有单元上的局部电位移场 $\\mathbf{D}_j = \\epsilon(\\mathbf{e}_j-\\nabla w_j)$ 进行平均。单元 $(i,j)$ 中心的梯度 $\\nabla w_j$ 使用带周期性索引的中心差分进行近似：\n$$\n(\\nabla w_j)_{i,j} \\approx \\left( \\frac{w_j(i+1,j) - w_j(i-1,j)}{2h}, \\frac{w_j(i,j+1) - w_j(i,j-1)}{2h} \\right)\n$$\n然后通过对所有 $N^2$ 个单元进行平均来计算有效张量的分量：\n$$\n\\epsilon_{xx} = \\langle D_{x,x} \\rangle = \\frac{1}{N^2} \\sum_{i,j} \\epsilon_{i,j} \\left(1 - (\\partial_x w_x)_{i,j}\\right)\n$$\n$$\n\\epsilon_{yx} = \\langle D_{x,y} \\rangle = \\frac{1}{N^2} \\sum_{i,j} \\epsilon_{i,j} \\left(- (\\partial_y w_x)_{i,j}\\right)\n$$\n$$\n\\epsilon_{xy} = \\langle D_{y,x} \\rangle = \\frac{1}{N^2} \\sum_{i,j} \\epsilon_{i,j} \\left(- (\\partial_x w_y)_{i,j}\\right)\n$$\n$$\n\\epsilon_{yy} = \\langle D_{y,y} \\rangle = \\frac{1}{N^2} \\sum_{i,j} \\epsilon_{i,j} \\left(1 - (\\partial_y w_y)_{i,j}\\right)\n$$\n\n### 4. 实现步骤\n\n所提供的测试用例通过一个脚本解决，该脚本执行以下操作：\n1.  对于每个测试用例 $(\\epsilon_1, \\epsilon_2, \\eta)$，计算所需的网格大小 $N = \\lceil N_0 / \\eta \\rceil$，其中 $N_0 = 12$。\n2.  构建与棋盘格图案对应的介电常数网格 $\\epsilon_{i,j}$。\n3.  对于每个修正子 ($w_x, w_y$)，构建稀疏矩阵 $A$ 和右侧向量 $\\mathbf{b}$。\n4.  修改系统以强制执行规范条件 $w_{0,0}=0$，并使用稀疏线性求解器求解修正势。\n5.  通过对修正子进行数值微分并对得到的位移场进行平均，计算 $\\bar{\\bar{\\epsilon}}_{\\text{eff}}$ 的分量。\n6.  根据四个测试用例的有效介电常数张量，计算最终所需的输出量（各向同性估计值、收敛比、偏差和诊断度量）。\n此过程被系统地应用以生成最终输出向量。对于均匀情况（$\\epsilon_1=\\epsilon_2$），修正子应为零，有效介电常数张量应为对角矩阵，其对角元等于常数介电常数，这为数值方法提供了有价值的验证。数值结果将显示与此解析解的微小偏差，这代表了模拟的离散化误差和浮点误差。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.sparse import lil_matrix\nfrom scipy.sparse.linalg import spsolve\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test cases and print the results.\n    \"\"\"\n    \n    def compute_eff_eps(eps1, eps2, N):\n        \"\"\"\n        Computes the effective permittivity tensor for a checkerboard metamaterial.\n\n        Args:\n            eps1 (float): Permittivity of first material.\n            eps2 (float): Permittivity of second material.\n            N (int): Number of grid points along one dimension.\n\n        Returns:\n            numpy.ndarray: The 2x2 effective permittivity tensor.\n        \"\"\"\n        a = 1.0\n        h = a / N\n\n        # 1. Setup Grid and Permittivity\n        eps_grid = np.zeros((N, N))\n        for i in range(N):\n            for j in range(N):\n                is_ll = (i  N / 2) and (j  N / 2)  # Lower-left\n                is_ur = (i >= N / 2) and (j >= N / 2) # Upper-right\n                if is_ll or is_ur:\n                    eps_grid[i, j] = eps1\n                else:\n                    eps_grid[i, j] = eps2\n\n        # 2. Solve for correctors w_x and w_y\n        correctors = {}\n        for dim_idx, j_dim in enumerate(['x', 'y']):\n            # 3. Build linear system A*w = b\n            A = lil_matrix((N * N, N * N), dtype=np.float64)\n            b = np.zeros(N * N, dtype=np.float64)\n\n            for i in range(N):\n                for j in range(N):\n                    k = i * N + j\n\n                    # Get periodic neighbor indices\n                    ip1, im1 = (i + 1) % N, (i - 1 + N) % N\n                    jp1, jm1 = (j + 1) % N, (j - 1 + N) % N\n\n                    # Harmonic mean for face permittivities\n                    eps_E = 2 * eps_grid[i, j] * eps_grid[ip1, j] / (eps_grid[i, j] + eps_grid[ip1, j])\n                    eps_W = 2 * eps_grid[i, j] * eps_grid[im1, j] / (eps_grid[i, j] + eps_grid[im1, j])\n                    eps_N = 2 * eps_grid[i, j] * eps_grid[i, jp1] / (eps_grid[i, j] + eps_grid[i, jp1])\n                    eps_S = 2 * eps_grid[i, j] * eps_grid[i, jm1] / (eps_grid[i, j] + eps_grid[i, jm1])\n\n                    # Assemble stiffness matrix A (5-point stencil)\n                    # The equation for node k is sum_faces(eps_face * (w_k - w_neighbor)) = RHS\n                    A[k, k] = eps_E + eps_W + eps_N + eps_S\n                    A[k, ip1 * N + j] -= eps_E\n                    A[k, im1 * N + j] -= eps_W\n                    A[k, i * N + jp1] -= eps_N\n                    A[k, i * N + jm1] -= eps_S\n                    \n                    # Assemble RHS vector b = h * div(eps * e_j)\n                    if j_dim == 'x':\n                        b[k] = h * (eps_E - eps_W)\n                    else:  # j_dim == 'y'\n                        b[k] = h * (eps_N - eps_S)\n\n            # 4. Apply gauge condition (fix w[0,0] = 0)\n            k_fix = 0\n            A_csr = A.tocsr() # Convert for efficient row slicing\n            A_csr[k_fix, :] = 0.0\n            A_csr[k_fix, k_fix] = 1.0\n            b[k_fix] = 0.0\n            \n            # 5. Solve for w\n            w_flat = spsolve(A_csr.tocsc(), b) # CSC is good for spsolve\n            correctors[j_dim] = w_flat.reshape((N, N))\n\n        w_x, w_y = correctors['x'], correctors['y']\n\n        # 6. Compute effective permittivity tensor\n        grad_wx_x, grad_wx_y = np.zeros_like(w_x), np.zeros_like(w_x)\n        grad_wy_x, grad_wy_y = np.zeros_like(w_y), np.zeros_like(w_y)\n\n        # Central difference for gradients with periodic BCs\n        for i in range(N):\n            for j in range(N):\n                ip1, im1 = (i + 1) % N, (i - 1 + N) % N\n                jp1, jm1 = (j + 1) % N, (j - 1 + N) % N\n                grad_wx_x[i, j] = (w_x[ip1, j] - w_x[im1, j]) / (2 * h)\n                grad_wx_y[i, j] = (w_x[i, jp1] - w_x[i, jm1]) / (2 * h)\n                grad_wy_x[i, j] = (w_y[ip1, j] - w_y[im1, j]) / (2 * h)\n                grad_wy_y[i, j] = (w_y[i, jp1] - w_y[i, jm1]) / (2 * h)\n\n        # Local E fields\n        Ex_x, Ex_y = 1 - grad_wx_x, -grad_wx_y\n        Ey_x, Ey_y = -grad_wy_x, 1 - grad_wy_y\n\n        # Average D fields\n        eps_xx = np.mean(eps_grid * Ex_x)\n        eps_yx = np.mean(eps_grid * Ex_y)\n        eps_xy = np.mean(eps_grid * Ey_x)\n        eps_yy = np.mean(eps_grid * Ey_y)\n        \n        return np.array([[eps_xx, eps_xy], [eps_yx, eps_yy]])\n\n    N0 = 12.0\n    test_cases_params = [\n        (2.0, 8.0, 0.5),\n        (2.0, 8.0, 0.25),\n        (2.0, 8.0, 0.125),\n        (5.0, 5.0, 0.25)\n    ]\n    \n    # Calculate grid sizes\n    Ns = [int(np.ceil(N0 / eta)) for _, _, eta in test_cases_params]\n\n    # Run simulations\n    eps_eff_1 = compute_eff_eps(test_cases_params[0][0], test_cases_params[0][1], Ns[0])\n    eps_eff_2 = compute_eff_eps(test_cases_params[1][0], test_cases_params[1][1], Ns[1])\n    eps_eff_3 = compute_eff_eps(test_cases_params[2][0], test_cases_params[2][1], Ns[2])\n    eps_eff_4 = compute_eff_eps(test_cases_params[3][0], test_cases_params[3][1], Ns[3])\n\n    # Compute required outputs\n    I1 = 0.5 * (eps_eff_1[0, 0] + eps_eff_1[1, 1])\n    I2 = 0.5 * (eps_eff_2[0, 0] + eps_eff_2[1, 1])\n    I3 = 0.5 * (eps_eff_3[0, 0] + eps_eff_3[1, 1])\n    \n    # Convergence ratio\n    # Add a small epsilon to denominator to avoid division by zero if convergence is perfect\n    R = abs(I1 - I2) / (abs(I2 - I3) + 1e-18)\n    \n    # Absolute deviation for homogeneous case\n    I4_iso = 0.5 * (eps_eff_4[0, 0] + eps_eff_4[1, 1])\n    Delta = abs(I4_iso - test_cases_params[3][0])\n    \n    # Diagnostics for case 2\n    avg_diag_2 = I2\n    Aniso = abs(eps_eff_2[0, 0] - eps_eff_2[1, 1]) / avg_diag_2\n    OffDiag = max(abs(eps_eff_2[0, 1]), abs(eps_eff_2[1, 0])) / avg_diag_2\n    \n    results = [I1, I2, I3, R, Delta, Aniso, OffDiag]\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "从直接计算转向特性表征，本练习模拟了超材料在实践中是如何被分析的。我们将推导并实现一种从可测量的散射参数（$S$参数）中反演材料等效折射率的方法。这项实践有助于深入理解各向异性、空间色散等现象如何体现为所反演参数的角度依赖性。",
            "id": "3314219",
            "problem": "给定一块厚度为 $d=5a$ 的超材料平板，置于真空中并受到平面波斜入射，其中晶格常数 $a$ 和厚度 $d$ 均以物理长度给出。目标是从复散射参数（S参数）$S_{11}(\\theta)$ 和 $S_{21}(\\theta)$ 中提取作为入射角 $\\theta$ 函数的标量有效折射率 $n_{\\mathrm{eff}}(\\theta)$，并利用 $n_{\\mathrm{eff}}(\\theta)$ 实部随角度的变化来评估其各向同性与空间色散特性。您的推导和算法必须从宏观麦克斯韦方程组、均匀介质中平面波传播的定义以及界面处切向电磁场的连续性出发，并利用这些原理建立一种反演平板内部纵向波数的方法。不得假定任何捷径公式；反演过程必须遵循第一性原理和经过充分检验的定义。\n\n基本原理：\n- 从频域中无源的宏观麦克斯韦方程组开始，时谐场为 $e^{i\\omega t}$：$\\nabla \\times \\mathbf{E} = i\\omega \\mathbf{B}$ 和 $\\nabla \\times \\mathbf{H} = - i\\omega \\mathbf{D}$，本构关系为 $\\mathbf{D} = \\underline{\\underline{\\varepsilon}} \\mathbf{E}$ 和 $\\mathbf{B} = \\mu \\mathbf{H}$。\n- 对于真空，使用 $\\varepsilon_0$ 和 $\\mu_0$ 以及光速 $c$，其中 $k_0 = \\omega/c$。\n- 定义一个在真空中以角度 $\\theta$ 入射到平板法线（取为 $\\hat{z}$）的平面波：守恒的切向波数为 $k_x = k_0 \\sin\\theta$，真空中的纵向分量为 $k_{z0} = k_0 \\cos\\theta$。\n- 对于均匀平板，将材料内部的纵向波数定义为 $k_z$，并根据切向场之比定义与极化相关的适当波阻抗 $Z$ 或导纳。考虑横磁（TM）极化，其中切向电场和磁场满足 $Z = E_t/H_t$。\n- 使用厚度为 $d$、波阻抗为 $Z$ 的均匀平板的传输（ABCD）矩阵，将输入和输出界面处的场联系起来。将其与真空中相等的端口阻抗 $Z_0$ 结合，以平板参数表示 $S_{11}$ 和 $S_{21}$。根据这些关系，通过有原则的反演来提取 $k_z d$，然后通过强制执行各向同性色散拟设 $k_z^2 + k_x^2 = n_{\\mathrm{eff}}^2 k_0^2$ 将其映射到 $n_{\\mathrm{eff}}(\\theta)$。\n\n各向异性与空间色散的评估：\n- 对于具有标量 $\\varepsilon$ 和 $\\mu$ 的各向同性局域介质，反演得到的 $n_{\\mathrm{eff}}(\\theta)$ 应与 $\\theta$ 无关。随 $\\theta$ 的变化表明标量、局域描述的失效，这可能源于各向异性（张量 $\\underline{\\underline{\\varepsilon}}$）或非局域性（空间色散，其中 $\\varepsilon$ 依赖于波矢量）。\n- 通过计算 $\\Re\\{n_{\\mathrm{eff}}(\\theta)\\}$ 在几个角度上的标准差来量化这一点；较小的值表示角度不变性，与各向同性局域介质一致，而较大的值则表示各向异性或非局域性。\n\n物理和数值单位及约定：\n- 使用 $a$ 和 $d$ 的单位为米。频率 $f$ 的单位必须为赫兹。角度 $\\theta$ 必须以度为单位提供，并在内部以弧度进行解释。所有反演得到的 $n_{\\mathrm{eff}}(\\theta)$ 均为无量纲。\n- 最终的度量指标必须使用反演得到的 $n_{\\mathrm{eff}}(\\theta)$ 的实部进行计算。\n\n测试套件与参数：\n- 使用 $a = 1\\times 10^{-3}$ 米， $d = 5 a$ 米，以及 $f = 1\\times 10^{10}$ 赫兹。平板周围环境为真空。\n- 在入射角集合 $\\{\\theta\\} = \\{0, 30, 60\\}$（单位为度）下进行评估。\n- 考虑TM极化下的三种超材料模型：\n  1. 各向同性局域模型：标量相对介电常数 $\\varepsilon_r = 2.25$ 和标量相对磁导率 $\\mu_r = 1.0$。\n  2. 光轴垂直于平板（$\\hat{z}$）的单轴各向异性局域模型：横向相对介电常数 $\\varepsilon_t = 2.25$，法向相对介电常数 $\\varepsilon_z = 4.0$，以及标量相对磁导率 $\\mu_r = 1.0$。\n  3. 各向同性空间色散模型：标量相对磁导率 $\\mu_r = 1.0$ 和标量相对介电常数 $\\varepsilon_r(k_x) = \\varepsilon_{r0} + \\alpha (k_x/k_0)^2$，其中 $\\varepsilon_{r0} = 2.25$ 且 $\\alpha = 0.3$。\n\n您的程序必须：\n- 基于边界条件和适用于TM极化的模式阻抗，使用传输矩阵公式为每个模型和角度生成复数 $S_{11}(\\theta)$ 和 $S_{21}(\\theta)$。\n- 通过在不使用捷径假设的情况下反演传输关系，从生成的S参数中反演 $k_z d$，并跨角度选择物理上连续的分支。\n- 对于每个模型，使用 $n_{\\mathrm{eff}}(\\theta) = \\sqrt{(k_z/k_0)^2 + \\sin^2\\theta}$ 从 $k_z$ 计算 $n_{\\mathrm{eff}}(\\theta)$，并取其实部。\n- 对于每个模型，计算 $\\Re\\{n_{\\mathrm{eff}}(\\theta)\\}$ 在三个角度上的标准差，结果为一个无量纲的浮点数。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的、以逗号分隔的结果列表，顺序与上面列出的模型顺序相同，例如 $[\\text{iso},\\text{uniaxial},\\text{nonlocal}]$，其中每个条目都是按规定计算的标准差。浮点数必须是无量纲的。\n\n无需用户输入；程序必须按原样运行，并在内部使用指定的参数和测试套件。",
            "solution": "用户提供了一个在计算电磁学领域中定义明确的良态问题，该问题涉及从超材料平板的散射参数（S参数）反演其有效折射率。该问题具有科学依据、无矛盾，并包含所有进行唯一求解所需的信息。验证通过。\n\n问题的核心是，首先建立一个正向模型，将平板的材料属性与其在横磁（TM）平面波入射下的S参数（$S_{11}, S_{21}$）联系起来；然后，推导并实现一个稳健的反演方法，从S参数中反演有效折射率 $n_{\\mathrm{eff}}(\\theta)$。\n\n推导和求解将分三个主要步骤进行：\n1.  **正向模型**：基于麦克斯韦方程组和边界条件，使用传输矩阵法从平板属性推导 $S_{11}(\\theta)$ 和 $S_{21}(\\theta)$。\n2.  **反演模型**：推导一种从计算出的S参数中反演纵向波数 $k_z$ 以及随后反演有效折射率 $n_{\\mathrm{eff}}$ 的方法。这必须按要求从第一性原理出发。\n3.  **数值实现**：将推导出的正向和反演模型应用于三种指定的超材料情况，计算 $\\Re\\{n_{\\mathrm{eff}}(\\theta)\\}$ 的标准差，该标准差可作为各向异性和空间色散的度量。\n\n在整个推导过程中，所有数学实体均按要求以 LaTeX 格式呈现。时谐约定为 $e^{-i\\omega t}$。平板位于区域 $0 \\le z \\le d$。\n\n**1. 正向模型：从材料属性到S参数**\n\n对于TM（p极化）平面波，磁场沿y轴方向，$\\mathbf{H} = H_y(x,z) \\hat{y}$，电场位于x-z平面内。场的空间依赖性为 $e^{i k_x x}$，其中切向波数 $k_x = k_0 \\sin\\theta$ 在所有界面上守恒。这里，$k_0 = \\omega/c = 2\\pi f/c$ 是自由空间波数，$\\theta$ 是相对于法线（$\\hat{z}$-轴）的入射角。\n\n对于前向传播的TM波，切向电场 $E_x$ 和切向磁场 $H_y$ 之间的关系定义了特性波阻抗，$Z_{\\text{TM}} = E_x / H_y$。\n\n**A. 各介质中的波传播与阻抗**\n\n*   **真空（区域 $z  0$ 和 $z > d$）**：色散关系为 $k_x^2 + k_{z0}^2 = k_0^2$。纵向波数为 $k_{z0} = \\sqrt{k_0^2 - k_x^2} = k_0 \\cos\\theta$。真空中的TM波阻抗为 $Z_{c0}^{\\text{TM}} = \\frac{k_{z0}}{\\omega\\varepsilon_0} = \\frac{k_0 \\cos\\theta}{\\omega\\varepsilon_0} = Z_0 \\cos\\theta$，其中 $Z_0 = \\sqrt{\\mu_0/\\varepsilon_0}$ 是自由空间的阻抗。\n\n*   **平板材料（区域 $0 \\le z \\le d$）**：属性取决于模型。\n    1.  **各向同性局域模型**：对于标量 $\\varepsilon = \\varepsilon_r \\varepsilon_0$ 和 $\\mu = \\mu_r \\mu_0$，色散关系为 $k_x^2 + k_z^2 = k_0^2 \\varepsilon_r \\mu_r$。纵向波数为 $k_z = \\sqrt{k_0^2 \\varepsilon_r \\mu_r - k_x^2} = k_0\\sqrt{\\varepsilon_r \\mu_r - \\sin^2\\theta}$。TM阻抗为 $Z_c^{\\text{TM}} = \\frac{k_z}{\\omega\\varepsilon} = \\frac{k_z}{\\omega\\varepsilon_r\\varepsilon_0}$。\n    2.  **单轴各向异性模型**：对于 $\\underline{\\underline{\\varepsilon}} = \\varepsilon_0 \\mathrm{diag}(\\varepsilon_t, \\varepsilon_t, \\varepsilon_z)$ 和标量 $\\mu=\\mu_r\\mu_0$，TM模式的色散关系为 $\\frac{k_x^2}{\\varepsilon_z} + \\frac{k_z^2}{\\varepsilon_t} = k_0^2 \\mu_r$。纵向波数为 $k_z = k_0\\sqrt{\\varepsilon_t(\\mu_r - \\sin^2\\theta/\\varepsilon_z)}$。TM阻抗为 $Z_c^{\\text{TM}} = \\frac{k_z}{\\omega\\varepsilon_t\\varepsilon_0}$。\n    3.  **各向同性空间色散模型**：对于 $\\varepsilon(k_x) = \\varepsilon_0(\\varepsilon_{r0} + \\alpha(k_x/k_0)^2)$ 和 $\\mu=\\mu_r\\mu_0$，色散关系为 $k_x^2 + k_z^2 = k_0^2 \\mu_r \\varepsilon_r(k_x)$。当 $\\mu_r=1$ 时，这给出 $k_z = k_0\\sqrt{\\varepsilon_{r0} + (\\alpha-1)\\sin^2\\theta}$。TM阻抗为 $Z_c^{\\text{TM}} = \\frac{k_z}{\\omega\\varepsilon(k_x)} = \\frac{k_z}{\\omega\\varepsilon_0\\varepsilon_r(k_x)}$。\n\n**B. 传输矩阵和S参数**\n\n平板的输入端（$z=0$）和输出端（$z=d$）的场通过一个传输（ABCD）矩阵相关联。对于厚度为 $d$、传播常数为 $k_z$、特性阻抗为 $Z_c^{\\text{TM}}$ 的均匀平板，该矩阵为：\n$$\n\\begin{pmatrix} A  B \\\\ C  D \\end{pmatrix} = \\begin{pmatrix} \\cos(k_z d)  i Z_c^{\\text{TM}} \\sin(k_z d) \\\\ i (Z_c^{\\text{TM}})^{-1} \\sin(k_z d)  \\cos(k_z d) \\end{pmatrix}\n$$\n对于这个具有相同端口阻抗 $Z_{c0}^{\\text{TM}}$ 的二端口网络，其S参数由ABCD矩阵导出：\n$$\nS_{11} = \\frac{A + B/Z_{c0}^{\\text{TM}} - C Z_{c0}^{\\text{TM}} - D}{A + B/Z_{c0}^{\\text{TM}} + C Z_{c0}^{\\text{TM}} + D} \\quad , \\quad S_{21} = \\frac{2}{A + B/Z_{c0}^{\\text{TM}} + C Z_{c0}^{\\text{TM}} + D}\n$$\n代入矩阵元素并定义归一化阻抗 $z = Z_c^{\\text{TM}} / Z_{c0}^{\\text{TM}}$，我们得到：\n$$\nS_{11} = \\frac{i(z^2 - 1) \\sin(k_z d)}{2z\\cos(k_z d) + i(z^2+1)\\sin(k_z d)} = \\frac{\\frac{i}{2}(z - 1/z) \\sin(k_z d)}{\\cos(k_z d) + \\frac{i}{2}(z+1/z)\\sin(k_z d)}\n$$\n$$\nS_{21} = \\frac{2z}{2z\\cos(k_z d) + i(z^2+1)\\sin(k_z d)} = \\frac{1}{\\cos(k_z d) + \\frac{i}{2}(z+1/z)\\sin(k_z d)}\n$$\n这些方程构成了正向模型，用于为给定的材料模型生成合成的S参数数据。\n\n**2. 反演模型：从S参数到材料属性**\n\n问题要求对上述系统进行有原则的反演，以从 $S_{11}$ 和 $S_{21}$ 中求出 $k_z$ 和 $z$。让我们处理S参数的表达式。从正向模型方程中，我们可以分离出两个关键关系：\n$$\n\\frac{1}{S_{21}} = \\cos(k_z d) + \\frac{i}{2}(z+1/z)\\sin(k_z d)\n$$\n$$\n\\frac{S_{11}}{S_{21}} = \\frac{i}{2}(z-1/z)\\sin(k_z d)\n$$\n通过将这两个方程相加和相减，我们可以用 $S_{11}$、$S_{21}$ 和 $z$ 来表示 $e^{ik_z d}$ 和 $e^{-ik_z d}$。\n令 $r = (z-1)/(z+1)$ 为第一个界面处的反射系数。则 $z=(1+r)/(1-r)$，$z-1/z = 2(r+1/r)/( (1-r)^2/((1+r)(1-r)) ) ...$ 代数运算并不简洁。\n一个更稳健的代数路径是分别为 $r$ 和 $e^{-ik_z d}$ 找到关系。通过将从S参数推导出的 $e^{ik_z d}$ 和 $e^{-ik_z d}$ 的表达式相乘，可以证明：\n$$\n(1 - S_{11} r)(1 - S_{11}/r) = S_{21}^2\n$$\n其中 $r = (z-1)/(z+1)$ 是界面反射系数。展开此式可得到一个关于 $r + 1/r$ 的二次方程：\n$$\n1 - S_{11}(r+1/r) + S_{11}^2 = S_{21}^2 \\implies r + 1/r = \\frac{1 + S_{11}^2 - S_{21}^2}{S_{11}}\n$$\n令 $K = \\frac{1 + S_{11}^2 - S_{21}^2}{2S_{11}}$。方程变为 $r^2 - 2Kr + 1 = 0$，其解为 $r = K \\pm \\sqrt{K^2-1}$。对于无源材料，反射系数必须满足 $|r| \\le 1$。此条件用于选择正确的物理根。\n\n一旦确定了 $r$，归一化阻抗可通过 $z = (1+r)/(1-r)$ 求得。无源介质要求 $\\Re\\{z\\} \\ge 0$。\n\n接下来，我们为传播因子 $e^{-ik_z d}$ 建立一个关系。可以证明：\n$$\ne^{-ik_z d} = \\frac{1 - S_{11} r}{S_{21}}\n$$\n由此，使用复对数反演出复数乘积 $k_z d$：\n$$\nk_z d = i \\log\\left(\\frac{1 - S_{11} r}{S_{21}}\\right)\n$$\n复对数是多值的：$\\log(w) = \\ln|w| + i(\\arg(w) + 2\\pi m)$，其中 $m$ 是一个整数。这导致 $k_z d$ 的实部存在模糊性。\n$$\nk_z d = -(\\arg(w) + 2\\pi m) + i \\ln|w|\n$$\n其中 $w = (1-S_{11}r)/S_{21}$。对于无源介质，波必须衰减，这意味着 $\\Im\\{k_z\\} \\ge 0$（在使用 $e^{i k_z z}$ 约定时）。这要求 $\\Im\\{k_z d\\} = \\ln|w| \\ge 0$，或 $|w| \\ge 1$。这为 $r$ 的选择提供了另一个约束。实部的模糊性通过为第一个入射角（$\\theta=0^{\\circ}$）设置 $m=0$，然后为后续角度选择 $m$ 以确保 $\\Re\\{k_z(\\theta)\\}$ 是一个连续函数来解决。\n\n**3. 有效折射率的反演**\n\n反演得到的 $k_z$ 通过各向同性色散关系拟设与有效折射率 $n_{\\mathrm{eff}}$ 相关联，该拟设定义了 $n_{\\mathrm{eff}}$：\n$$\nk_x^2 + k_z^2 = (n_{\\mathrm{eff}} k_0)^2\n$$\n代入 $k_x = k_0 \\sin\\theta$ 并求解 $n_{\\mathrm{eff}}$ 得：\n$$\nn_{\\mathrm{eff}}(\\theta) = \\sqrt{\\left(\\frac{k_z}{k_0}\\right)^2 + \\sin^2\\theta}\n$$\n选择主根（$\\Re\\{n_{\\mathrm{eff}}\\} \\ge 0$）。\n\n对于一个真正的各向同性局域介质，反演得到的 $n_{\\mathrm{eff}}(\\theta)$ 将是一个常数，等于该材料的真实折射率。对于各向异性和空间色散模型，$n_{\\mathrm{eff}}(\\theta)$ 将随入射角 $\\theta$ 变化。$\\Re\\{n_{\\mathrm{eff}}(\\theta)\\}$ 在指定角度上的标准差可作为此角度依赖性的定量度量。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.constants import c as C0, mu_0, epsilon_0\n\ndef solve():\n    \"\"\"\n    Main function to perform the metamaterial analysis.\n    It calculates S-parameters for three different slab models, retrieves\n    the effective refractive index n_eff(theta), and computes the standard\n    deviation of Re(n_eff) across incidence angles as a measure of\n    anisotropy or spatial dispersion.\n    \"\"\"\n\n    # --- Problem Parameters ---\n    a = 1e-3  # meters\n    d = 5 * a  # meters\n    f = 1e10  # Hertz\n    angles_deg = [0, 30, 60]\n\n    # --- Physical Constants and Derived Parameters ---\n    Z0 = np.sqrt(mu_0 / epsilon_0)  # Impedance of free space\n    omega = 2 * np.pi * f\n    k0 = omega / C0\n\n    # --- Test Case Models ---\n    models = [\n        {\n            \"name\": \"Isotropic\",\n            \"type\": \"isotropic\",\n            \"params\": {\"eps_r\": 2.25, \"mu_r\": 1.0}\n        },\n        {\n            \"name\": \"Uniaxial\",\n            \"type\": \"uniaxial\",\n            \"params\": {\"eps_t\": 2.25, \"eps_z\": 4.0, \"mu_r\": 1.0}\n        },\n        {\n            \"name\": \"Spatially Dispersive\",\n            \"type\": \"spatially_dispersive\",\n            \"params\": {\"eps_r0\": 2.25, \"alpha\": 0.3, \"mu_r\": 1.0}\n        }\n    ]\n\n    final_results = []\n\n    for model in models:\n        n_eff_real_parts = []\n        prev_k_z_d_real = None\n\n        for theta_deg in angles_deg:\n            theta_rad = np.deg2rad(theta_deg)\n            kx = k0 * np.sin(theta_rad)\n\n            # --- 1. Forward Model: Calculate S-parameters ---\n            \n            # Impedance of vacuum for TM waves at angle theta\n            k_z0 = k0 * np.cos(theta_rad)\n            Zc0_tm = Z0 * np.cos(theta_rad) if np.cos(theta_rad) > 1e-9 else Z0\n\n            # Calculate slab properties based on model\n            if model[\"type\"] == \"isotropic\":\n                eps_r = model[\"params\"][\"eps_r\"]\n                mu_r = model[\"params\"][\"mu_r\"]\n                n_sq = eps_r * mu_r\n                k_z_sq = k0**2 * n_sq - kx**2\n                k_z = np.sqrt(k_z_sq)\n                Zc_tm = k_z / (omega * eps_r * epsilon_0)\n                \n            elif model[\"type\"] == \"uniaxial\":\n                eps_t = model[\"params\"][\"eps_t\"]\n                eps_z = model[\"params\"][\"eps_z\"]\n                mu_r = model[\"params\"][\"mu_r\"]\n                k_z_sq = eps_t * (k0**2 * mu_r - kx**2 / eps_z)\n                k_z = np.sqrt(k_z_sq)\n                Zc_tm = k_z / (omega * eps_t * epsilon_0)\n\n            elif model[\"type\"] == \"spatially_dispersive\":\n                eps_r0 = model[\"params\"][\"eps_r0\"]\n                alpha = model[\"params\"][\"alpha\"]\n                mu_r = model[\"params\"][\"mu_r\"]\n                eps_r_kx = eps_r0 + alpha * (kx / k0)**2\n                k_z_sq = k0**2 * mu_r * eps_r_kx - kx**2\n                k_z = np.sqrt(k_z_sq)\n                Zc_tm = k_z / (omega * eps_r_kx * epsilon_0)\n\n            # Normalized impedance\n            z_norm = Zc_tm / Zc0_tm\n\n            # Calculate S-parameters from ABCD matrix relations\n            cos_kzd = np.cos(k_z * d)\n            sin_kzd = np.sin(k_z * d)\n            denominator = 2 * cos_kzd + 1j * (z_norm + 1/z_norm) * sin_kzd\n            S11 = 1j * (z_norm - 1/z_norm) * sin_kzd / denominator\n            S21 = 2 / denominator\n            \n            # --- 2. Inverse Model: Retrieve k_z and n_eff ---\n\n            # Suppress division by zero warnings for S11=0 at normal incidence\n            with np.errstate(divide='ignore', invalid='ignore'):\n                 K = (1 + S11**2 - S21**2) / (2 * S11)\n            \n            if np.abs(S11)  1e-9: # Handle normal incidence case where S11 might be 0\n                # When S11=0, r=0, z=1. k_z d from S21\n                # 1/S21 = cos(kzd), so kzd = arccos(1/S21)\n                k_z_d_retrieved = np.arccos(1/S21)\n            else:\n                # Solve r^2 - 2Kr + 1 = 0\n                sqrt_discriminant = np.sqrt(K**2 - 1, dtype=np.complex128)\n                r1 = K + sqrt_discriminant\n                r2 = K - sqrt_discriminant\n                \n                # Select physical root |r| = 1, which has smaller magnitude\n                r = r1 if abs(r1) = abs(r2) else r2\n                \n                # Retrieve propagation factor T = exp(-ik_z d)\n                T_exp = (1 - S11 * r) / S21\n                \n                # Retrieve k_z * d from complex log, resolving 2*pi ambiguity\n                k_z_d_retrieved = 1j * np.log(T_exp)\n                \n            # Phase unwrapping for continuity across angles\n            if prev_k_z_d_real is not None:\n                diff = k_z_d_retrieved.real - prev_k_z_d_real\n                m = np.round(diff / (2 * np.pi))\n                k_z_d_retrieved -= 2 * np.pi * m\n            prev_k_z_d_real = k_z_d_retrieved.real\n            \n            k_z_retrieved = k_z_d_retrieved / d\n            \n            # --- 3. Calculate Effective Refractive Index ---\n            n_eff_sq = (k_z_retrieved / k0)**2 + np.sin(theta_rad)**2\n            n_eff = np.sqrt(n_eff_sq)\n            \n            # Ensure Re(n_eff) >= 0\n            if n_eff.real  0:\n                n_eff = -n_eff\n            \n            n_eff_real_parts.append(n_eff.real)\n\n        # Compute standard deviation for the model\n        std_dev = np.std(n_eff_real_parts)\n        final_results.append(std_dev)\n    \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, final_results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "为了超越简单均匀化理论的局限，我们必须考虑空间色散效应，即材料的响应依赖于波的传播方向和波长。这项高级实践将引入平面波展开法来计算超材料的完整能带结构。然后，我们会将这些计算结果拟合到一个与波矢量相关的介电常数模型中，从而直接量化材料的非局域性。",
            "id": "3314241",
            "problem": "您需要为三维周期性超材料设计一个 Bloch–Floquet 本征问题，并用它从计算出的能带结构中提取非局域本构关系。从以下基本依据出发：频域中的麦克斯韦方程组、空间色散介质中电位移场与电场之间的本构关系，以及周期性介质中场的布洛赫定理。您必须推导并实现一个平面波展开本征问题，该问题用于计算一组波矢的能带结构，然后将一个依赖于波矢的有效介电常数模型与这些能带进行拟合，以表示空间色散。\n\n基本依据：\n- 频域中的麦克斯韦方程组，\n$$\n\\nabla \\times \\mathbf{E} = i \\omega \\mu \\mathbf{H}, \\quad \\nabla \\times \\mathbf{H} = -i \\omega \\mathbf{D},\n$$\n以及非局域介质的本构关系，\n$$\n\\mathbf{D}(\\mathbf{r}) = \\int \\overline{\\overline{\\epsilon}}(\\mathbf{r} - \\mathbf{r}', \\omega) \\mathbf{E}(\\mathbf{r}') \\, d\\mathbf{r}',\n$$\n和布洛赫定理，\n$$\n\\mathbf{H}(\\mathbf{r}) = e^{i \\mathbf{k} \\cdot \\mathbf{r}} \\sum_{\\mathbf{G}} \\mathbf{H}_{\\mathbf{G}} e^{i \\mathbf{G} \\cdot \\mathbf{r}},\n$$\n其中 $\\mathbf{k}$ 是布洛赫波矢，$\\mathbf{G}$ 是倒格矢。\n- 在无量纲单位下进行计算，设置 $c=1$，$\\mu=1$，晶格常数 $a=1$；所有量均为无量纲。\n\n任务：\n1. 使用一组截断的倒格矢，为磁场构建 Bloch–Floquet 平面波展开本征问题。考虑一个各向同性超材料，其逆介电常数是周期性的，并由下式给出\n$$\n\\epsilon^{-1}(\\mathbf{r}) = \\frac{1}{\\epsilon_{\\text{avg}}} + \\delta_x \\cos(2\\pi x) + \\delta_y \\cos(2\\pi y) + \\delta_z \\cos(2\\pi z).\n$$\n使用截断的倒格矢集合\n$$\n\\mathcal{G} = \\{(0,0,0), (\\pm 2\\pi,0,0), (0,\\pm 2\\pi,0), (0,0,\\pm 2\\pi)\\}.\n$$\n2. 利用旋度算子作用于平面波的恒等式，在傅里叶空间中推导平面波本征问题。在磁场表述中，组装算子\n$$\n\\mathsf{M}_{\\mathbf{G},\\mathbf{G}'}(\\mathbf{k}) = - \\epsilon^{-1}_{\\mathbf{G}-\\mathbf{G}'} \\, \\mathsf{C}(\\mathbf{k}+\\mathbf{G}) \\, \\mathsf{C}(\\mathbf{k}+\\mathbf{G}'),\n$$\n其中 $\\mathsf{C}(\\mathbf{q})$ 是与 $\\mathbf{q}$ 的叉积的 $3 \\times 3$ 矩阵表示，定义为 $\\mathsf{C}(\\mathbf{q}) \\mathbf{v} = \\mathbf{q} \\times \\mathbf{v}$。求解本征问题\n$$\n\\sum_{\\mathbf{G}'} \\mathsf{M}_{\\mathbf{G},\\mathbf{G}'}(\\mathbf{k}) \\, \\mathbf{H}_{\\mathbf{G}'} = \\omega^2(\\mathbf{k}) \\, \\mathbf{H}_{\\mathbf{G}},\n$$\n以求得每个 $\\mathbf{k}$ 对应的最小正本征值 $\\omega^2(\\mathbf{k})$。\n3. 对于每个计算出的能带点，通过均匀介质的标量色散关系定义一个有效各向同性非局域介电常数，\n$$\n|\\mathbf{k}|^2 = \\omega^2(\\mathbf{k}) \\, \\epsilon_{\\mathrm{eff}}(\\omega,\\mathbf{k}),\n$$\n由此得出\n$$\n\\epsilon_{\\mathrm{eff}}(\\omega,\\mathbf{k}) = \\frac{|\\mathbf{k}|^2}{\\omega^2(\\mathbf{k})}.\n$$\n在 $\\mathbf{k}=\\mathbf{0}$ 的一个小邻域内，假设在采样的点上对 $\\omega$ 的依赖性较弱，并通过对采样波矢进行最小二乘法拟合非局域模型\n$$\n\\epsilon_{\\mathrm{eff}}(\\omega,\\mathbf{k}) \\approx \\epsilon_0(\\omega) + \\alpha(\\omega) |\\mathbf{k}|^2 + \\beta(\\omega) |\\mathbf{k}|^4。\n$$\n\n实现细节：\n- 使用上面给出的倒格矢集合 $\\mathcal{G}$，并从 $\\epsilon^{-1}(\\mathbf{r})$ 构建 $\\epsilon^{-1}_{\\mathbf{G}}$ 系数。具体来说，非零傅里叶系数位于 $\\mathbf{G}=\\mathbf{0}$ 处，其值为 $\\frac{1}{\\epsilon_{\\text{avg}}}$；位于 $\\mathbf{G}=(\\pm 2\\pi,0,0)$ 处，其值为 $\\frac{\\delta_x}{2}$；位于 $\\mathbf{G}=(0,\\pm 2\\pi,0)$ 处，其值为 $\\frac{\\delta_y}{2}$；位于 $\\mathbf{G}=(0,0,\\pm 2\\pi)$ 处，其值为 $\\frac{\\delta_z}{2}$。\n- 为保证数值稳定性，通过取 $\\frac{1}{2}(\\mathsf{M} + \\mathsf{M}^\\top)$ 来对称化组装的算子，然后计算其本征值。从本征值集合中，选择最小的严格正本征值作为 $\\omega^2(\\mathbf{k})$。\n- 使用沿 $\\Gamma \\rightarrow X$ 线上的一组波矢，即 $\\mathbf{k}=(\\kappa,0,0)$，其中 $\\kappa$ 在一个小范围内。使用 $\\kappa \\in \\{0.1\\pi, 0.12\\pi, 0.14\\pi, 0.16\\pi, 0.18\\pi, 0.2\\pi\\}$。\n\n测试套件：\n为以下三个材料参数集中的每一个计算拟合系数 $\\epsilon_0$、$\\alpha$ 和 $\\beta$：\n- 情况 1（均匀极限，边界情况）：$\\epsilon_{\\text{avg}}=4.0$, $\\delta_x=0.0$, $\\delta_y=0.0$, $\\delta_z=0.0$。\n- 情况 2（中等各向同性调制）：$\\epsilon_{\\text{avg}}=5.0$, $\\delta_x=0.03$, $\\delta_y=0.03$, $\\delta_z=0.03$。\n- 情况 3（各向异性调制）：$\\epsilon_{\\text{avg}}=4.0$, $\\delta_x=0.05$, $\\delta_y=0.01$, $\\delta_z=0.03$。\n\n要求输出：\n- 您的程序应生成一行输出，其中包含用方括号括起来的逗号分隔列表形式的结果。每个测试用例的结果必须是按顺序 $[\\epsilon_0, \\alpha, \\beta]$ 排列的三个浮点数列表。例如，打印 $[[e0_1,\\alpha_1,\\beta_1],[e0_2,\\alpha_2,\\beta_2],[e0_3,\\alpha_3,\\beta_3]]$。所有量均为无量纲。",
            "solution": "目标是确定三维周期性超材料的非局域有效介电常数模型的系数。这是通过首先使用平面波展开（PWE）方法计算电磁能带结构，然后将计算出的色散关系拟合到空间色散模型来实现的。整个过程基于麦克斯韦方程组和布洛赫定理。\n\n### 1. Bloch-Floquet 本征问题的推导\n\n我们从频域中的麦克斯韦方程组开始，假设时谐依赖性为 $e^{-i\\omega t}$：\n$$\n\\nabla \\times \\mathbf{E} = i \\omega \\mu \\mathbf{H} \\\\\n\\nabla \\times \\mathbf{H} = -i \\omega \\mathbf{D}\n$$\n问题在微观层面上指定了电场 $\\mathbf{E}$ 和电位移场 $\\mathbf{D}$ 之间的周期性、局域关系：$\\mathbf{E}(\\mathbf{r}) = \\epsilon^{-1}(\\mathbf{r}) \\mathbf{D}(\\mathbf{r})$，其中逆介电常数张量是一个标量函数 $\\epsilon^{-1}(\\mathbf{r})$。在指定的无量纲单位（$c=1$）中，我们有 $\\mu=1$。\n\n为了推导一个仅含磁场 $\\mathbf{H}$ 的波动方程，我们对方程进行处理。从第二个旋度方程，我们表示 $\\mathbf{D}$ 为 $\\mathbf{D} = \\frac{i}{\\omega} \\nabla \\times \\mathbf{H}$。将此代入本构关系得到 $\\mathbf{E} = \\epsilon^{-1}(\\mathbf{r}) \\frac{i}{\\omega} \\nabla \\times \\mathbf{H}$。然后我们将这个 $\\mathbf{E}$ 的表达式代入第一个旋度方程：\n$$\n\\nabla \\times \\left( \\epsilon^{-1}(\\mathbf{r}) \\frac{i}{\\omega} \\nabla \\times \\mathbf{H} \\right) = i \\omega \\mathbf{H}\n$$\n两边乘以 $\\omega/i$ 并重新整理，得到磁场的主本征问题：\n$$\n\\nabla \\times \\left( \\epsilon^{-1}(\\mathbf{r}) \\nabla \\times \\mathbf{H} \\right) = \\omega^2 \\mathbf{H}\n$$\n这是一个广义厄米本征问题，形式为 $\\mathcal{L}\\mathbf{H} = \\omega^2 \\mathbf{H}$，其中算子 $\\mathcal{L}$ 是 $\\nabla \\times \\epsilon^{-1}(\\mathbf{r}) \\nabla \\times$。\n\n由于介质的周期性，$\\epsilon^{-1}(\\mathbf{r}) = \\epsilon^{-1}(\\mathbf{r}+\\mathbf{R})$（对于任意格矢 $\\mathbf{R}$），$\\mathbf{H}$ 的解必须遵循布洛赫定理。一个波矢为 $\\mathbf{k}$ 的布洛赫波可以表示为平面波展开：\n$$\n\\mathbf{H}(\\mathbf{r}) = e^{i \\mathbf{k} \\cdot \\mathbf{r}} \\mathbf{u}(\\mathbf{r}) = e^{i \\mathbf{k} \\cdot \\mathbf{r}} \\sum_{\\mathbf{G}'} \\mathbf{H}_{\\mathbf{G}'} e^{i \\mathbf{G}' \\cdot \\mathbf{r}} = \\sum_{\\mathbf{G}'} \\mathbf{H}_{\\mathbf{G}'} e^{i (\\mathbf{k} + \\mathbf{G}') \\cdot \\mathbf{r}}\n$$\n其中 $\\mathbf{G}'$ 是倒格矢，$\\mathbf{H}_{\\mathbf{G}'}$ 是矢量傅里叶系数。周期性逆介电常数函数 $\\epsilon^{-1}(\\mathbf{r})$ 也有一个傅里叶级数表示：\n$$\n\\epsilon^{-1}(\\mathbf{r}) = \\sum_{\\mathbf{G}''} \\epsilon^{-1}_{\\mathbf{G}''} e^{i \\mathbf{G}'' \\cdot \\mathbf{r}}\n$$\n将这些展开式代入波动方程，将微分算子问题转化为代数问题。旋度算子 $\\nabla \\times$ 作用于平面波 $e^{i\\mathbf{q}\\cdot\\mathbf{r}}$ 变为乘以 $i\\mathbf{q} \\times$。算子 $\\mathcal{L}$ 作用于单个平面波分量 $e^{i(\\mathbf{k}+\\mathbf{G}')\\cdot\\mathbf{r}}$ 的过程是：\n$$\n\\nabla \\times \\left( \\left(\\sum_{\\mathbf{G}''} \\epsilon^{-1}_{\\mathbf{G}''} e^{i \\mathbf{G}'' \\cdot \\mathbf{r}}\\right) \\nabla \\times \\left( \\mathbf{H}_{\\mathbf{G}'} e^{i (\\mathbf{k} + \\mathbf{G}') \\cdot \\mathbf{r}} \\right) \\right) \\\\\n= \\nabla \\times \\left( \\left(\\sum_{\\mathbf{G}''} \\epsilon^{-1}_{\\mathbf{G}''} e^{i \\mathbf{G}'' \\cdot \\mathbf{r}}\\right) i(\\mathbf{k}+\\mathbf{G}') \\times \\mathbf{H}_{\\mathbf{G}'} e^{i (\\mathbf{k} + \\mathbf{G}') \\cdot \\mathbf{r}} \\right) \\\\\n= \\nabla \\times \\left( \\sum_{\\mathbf{G}''} \\epsilon^{-1}_{\\mathbf{G}''} [i(\\mathbf{k}+\\mathbf{G}') \\times \\mathbf{H}_{\\mathbf{G}'}] e^{i (\\mathbf{k} + \\mathbf{G}' + \\mathbf{G}'') \\cdot \\mathbf{r}} \\right)\n$$\n将此投影到平面波基 $e^{-i(\\mathbf{k}+\\mathbf{G})\\cdot\\mathbf{r}}$ 上并在一个晶胞上积分，可以分离出系数。这等同于令 $e^{i(\\mathbf{k}+\\mathbf{G})\\cdot\\mathbf{r}}$ 的系数相等。两个级数乘积中 $e^{i\\mathbf{q}\\cdot\\mathbf{r}}$ 的系数是它们系数的卷积。这个过程产生了傅里叶系数 $\\mathbf{H}_{\\mathbf{G}}$ 的代数本征问题：\n$$\n\\sum_{\\mathbf{G}'} \\left[ -(\\mathbf{k}+\\mathbf{G}) \\times \\left( (\\mathbf{k}+\\mathbf{G}') \\times \\mathbf{H}_{\\mathbf{G}'} \\right) \\right] \\epsilon^{-1}_{\\mathbf{G}-\\mathbf{G}'} = \\omega^2(\\mathbf{k}) \\mathbf{H}_{\\mathbf{G}}\n$$\n使用叉积算子的矩阵表示 $\\mathsf{C}(\\mathbf{q})$（$\\mathsf{C}(\\mathbf{q})\\mathbf{v} = \\mathbf{q} \\times \\mathbf{v}$），我们可以将括号中的项写为 $\\mathsf{C}(\\mathbf{k}+\\mathbf{G})\\mathsf{C}(\\mathbf{k}+\\mathbf{G}')\\mathbf{H}_{\\mathbf{G}'}$。这导出了问题陈述中给出的最终矩阵形式：\n$$\n\\sum_{\\mathbf{G}'} \\mathsf{M}_{\\mathbf{G},\\mathbf{G}'}(\\mathbf{k}) \\, \\mathbf{H}_{\\mathbf{G}'} = \\omega^2(\\mathbf{k}) \\, \\mathbf{H}_{\\mathbf{G}}\n$$\n其中矩阵块为 $\\mathsf{M}_{\\mathbf{G},\\mathbf{G}'}(\\mathbf{k}) = - \\epsilon^{-1}_{\\mathbf{G}-\\mathbf{G}'} \\, \\mathsf{C}(\\mathbf{k}+\\mathbf{G}) \\, \\mathsf{C}(\\mathbf{k}+\\mathbf{G}')$。\n\n### 2. 数值解与参数提取\n\n该过程涉及三个主要的计算步骤：\n\n**步骤 1：构建本征问题矩阵**\n该问题使用一个包含 $N=7$ 个倒格矢的截断集合 $\\mathcal{G}$。由于每个傅里叶系数 $\\mathbf{H}_{\\mathbf{G}}$ 是一个3维向量，总矩阵 $\\mathsf{M}$ 的维度为 $3N \\times 3N = 21 \\times 21$。该矩阵是逐块构建的，其中每个 $(\\mathbf{G}, \\mathbf{G}')$ 块是一个 $3 \\times 3$ 矩阵。\n傅里叶系数 $\\epsilon^{-1}_{\\mathbf{G}}$ 由给定的 $\\epsilon^{-1}(\\mathbf{r})$ 形式确定。使用欧拉公式 $\\cos(\\theta) = (e^{i\\theta} + e^{-i\\theta})/2$，我们识别出问题中指定的系数。对于向量 $\\mathbf{q}=(q_x, q_y, q_z)$，叉积矩阵 $\\mathsf{C}(\\mathbf{q})$ 是：\n$$\n\\mathsf{C}(\\mathbf{q}) = \\begin{pmatrix} 0  -q_z  q_y \\\\ q_z  0  -q_x \\\\ -q_y  q_x  0 \\end{pmatrix}\n$$\n通过遍历集合 $\\mathcal{G}$ 中的所有 $(\\mathbf{G}, \\mathbf{G}')$ 对来组装完整的矩阵 $\\mathsf{M}$。为了数值稳定性，在求解前将矩阵对称化为 $\\frac{1}{2}(\\mathsf{M} + \\mathsf{M}^\\top)$。\n\n**步骤 2：求解本征频率**\n对于沿 $\\Gamma \\rightarrow X$ 方向的每个采样波矢 $\\mathbf{k}$，即 $\\mathbf{k}=(\\kappa,0,0)$，其中 $\\kappa \\in \\{0.1\\pi, ..., 0.2\\pi\\}$，求解对称矩阵本征问题。为此使用标准的数值库（例如，`scipy.linalg.eigh`）。得到的本征值对应于 $\\omega^2(\\mathbf{k})$。该公式固有地会产生零频解（纵向模式），这对于光传播而言是非物理的。我们选择最小的严格正本征值，它对应于最低能量的横向光子能带。\n\n**步骤 3：拟合有效介电常数模型**\n计算出的色散关系 $(\\mathbf{k}, \\omega(\\mathbf{k}))$ 用于寻找有效介电常数。对于均匀、各向同性的介质，色散关系为 $|\\mathbf{k}|^2 = \\omega^2 \\epsilon_{\\text{eff}}$。我们用此为我们的超材料定义一个依赖于 $\\mathbf{k}$ 的有效介电常数：\n$$\n\\epsilon_{\\mathrm{eff}}(\\mathbf{k}) = \\frac{|\\mathbf{k}|^2}{\\omega^2(\\mathbf{k})}\n$$\n然后，我们为每个采样的 $\\kappa$ 收集数据点 $(|\\mathbf{k}|^2, \\epsilon_{\\mathrm{eff}}(\\mathbf{k}))$。最后一步是将这些数据拟合到表示空间色散的多项式模型中：\n$$\n\\epsilon_{\\mathrm{eff}}(|\\mathbf{k}|^2) \\approx \\epsilon_0 + \\alpha |\\mathbf{k}|^2 + \\beta |\\mathbf{k}|^4\n$$\n这是一个线性最小二乘问题。我们寻求最小化平方误差的系数 $(\\epsilon_0, \\alpha, \\beta)$。令 $x_i = |\\mathbf{k}_i|^2$ 和 $y_i = \\epsilon_{\\mathrm{eff}}(\\mathbf{k}_i)$。我们构建系统 $\\mathbf{A}\\mathbf{c}=\\mathbf{y}$，其中 $\\mathbf{c} = [\\epsilon_0, \\alpha, \\beta]^\\top$，$\\mathbf{y} = [y_1, y_2, ...]^\\top$，设计矩阵 $\\mathbf{A}$ 的行为 $[1, x_i, x_i^2]$。使用标准的线性最小二乘求解器（如 `numpy.linalg.lstsq`）找到解。对三个测试用例中的每一个重复此过程。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import eigh\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test cases.\n    It computes the nonlocal effective permittivity coefficients for three\n    metamaterial configurations.\n    \"\"\"\n\n    test_cases = [\n        # (eps_avg, delta_x, delta_y, delta_z)\n        (4.0, 0.0, 0.0, 0.0),\n        (5.0, 0.03, 0.03, 0.03),\n        (4.0, 0.05, 0.01, 0.03),\n    ]\n\n    results = []\n    for case in test_cases:\n        eps_avg, delta_x, delta_y, delta_z = case\n        coeffs = compute_nonlocal_params(eps_avg, delta_x, delta_y, delta_z)\n        results.append(coeffs)\n\n    # Format the final output string as per requirements\n    inner_strs = [f\"[{r[0]},{r[1]},{r[2]}]\" for r in results]\n    print(f\"[{','.join(inner_strs)}]\")\n\ndef compute_nonlocal_params(eps_avg, delta_x, delta_y, delta_z):\n    \"\"\"\n    Computes the band structure and fits the nonlocal permittivity model\n    for a single set of material parameters.\n    \n    Args:\n        eps_avg (float): Average permittivity.\n        delta_x (float): Modulation strength in x.\n        delta_y (float): Modulation strength in y.\n        delta_z (float): Modulation strength in z.\n        \n    Returns:\n        list: A list of the fitted coefficients [epsilon_0, alpha, beta].\n    \"\"\"\n    pi = np.pi\n    \n    # 1. Define reciprocal lattice vectors G and their Fourier coefficients\n    # The set G = {(0,0,0), (±2π,0,0), (0,±2π,0), (0,0,±2π)}\n    G_vecs_tuples = [\n        (0.0, 0.0, 0.0),\n        (2.0*pi, 0.0, 0.0), (-2.0*pi, 0.0, 0.0),\n        (0.0, 2.0*pi, 0.0), (0.0, -2.0*pi, 0.0),\n        (0.0, 0.0, 2.0*pi), (0.0, 0.0, -2.0*pi)\n    ]\n    G_vecs = np.array(G_vecs_tuples, dtype=np.float64)\n    num_G = len(G_vecs)\n\n    # Fourier coefficients of the inverse permittivity epsilon_inv(r)\n    eps_inv_coeffs = {\n        (0.0, 0.0, 0.0): 1.0 / eps_avg,\n        (2.0*pi, 0.0, 0.0): delta_x / 2.0, (-2.0*pi, 0.0, 0.0): delta_x / 2.0,\n        (0.0, 2.0*pi, 0.0): delta_y / 2.0, (0.0, -2.0*pi, 0.0): delta_y / 2.0,\n        (0.0, 0.0, 2.0*pi): delta_z / 2.0, (0.0, 0.0, -2.0*pi): delta_z / 2.0,\n    }\n\n    def get_eps_inv_coeff(g_diff_vec):\n        g_diff_tuple = tuple(np.round(g_diff_vec, 8)) # Round to avoid float precision issues\n        return eps_inv_coeffs.get(g_diff_tuple, 0.0)\n\n    # 2. Define sampling wavevectors k\n    kappas = np.array([0.1, 0.12, 0.14, 0.16, 0.18, 0.2], dtype=np.float64) * pi\n    k_vecs = np.array([[k_val, 0.0, 0.0] for k_val in kappas], dtype=np.float64)\n\n    # 3. Helper function for cross-product matrix C(q)\n    def C_matrix(q):\n        return np.array([\n            [0.0,    -q[2],  q[1]],\n            [q[2],   0.0,   -q[0]],\n            [-q[1],  q[0],   0.0]\n        ], dtype=np.float64)\n\n    # 4. Compute omega^2 for each k\n    omega_sq_vals = []\n    \n    mat_size = 3 * num_G\n    M = np.zeros((mat_size, mat_size), dtype=np.float64)\n\n    for k in k_vecs:\n        M.fill(0) # Reset matrix for each k\n        for i in range(num_G):\n            for j in range(num_G):\n                G_i = G_vecs[i]\n                G_j = G_vecs[j]\n                \n                G_diff = G_i - G_j\n                eps_inv_val = get_eps_inv_coeff(G_diff)\n                \n                if abs(eps_inv_val)  1e-15:\n                    continue\n                \n                q_i = k + G_i\n                q_j = k + G_j\n                \n                C_i = C_matrix(q_i)\n                C_j = C_matrix(q_j)\n                \n                block = -eps_inv_val * (C_i @ C_j)\n                M[3*i:3*i+3, 3*j:3*j+3] = block\n        \n        # Symmetrize the matrix for numerical stability\n        M_sym = 0.5 * (M + M.T)\n        \n        # Solve the eigenvalue problem\n        eigenvalues = eigh(M_sym, eigvals_only=True)\n        \n        # Find the smallest strictly positive eigenvalue for omega^2\n        positive_eigs = eigenvalues[eigenvalues > 1e-9]\n        min_omega_sq = np.min(positive_eigs)\n        omega_sq_vals.append(min_omega_sq)\n\n    omega_sq_vals = np.array(omega_sq_vals)\n\n    # 5. Perform least-squares fit for nonlocal parameters\n    k_sq_vals = kappas**2\n    eps_eff_vals = k_sq_vals / omega_sq_vals\n\n    # Model: eps_eff = eps0 + alpha * k^2 + beta * (k^2)^2\n    # This is a linear system Ac = y\n    A = np.vstack([np.ones_like(k_sq_vals), k_sq_vals, k_sq_vals**2]).T\n    y = eps_eff_vals\n\n    # Solve the least-squares problem\n    coeffs, _, _, _ = np.linalg.lstsq(A, y, rcond=None)\n    \n    return coeffs.tolist()\n\n\nsolve()\n```"
        }
    ]
}