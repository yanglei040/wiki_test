{
    "hands_on_practices": [
        {
            "introduction": "在深入研究伴随态方法的数学细节之前，首先理解其为何在众多设计优化问题中成为首选工具至关重要。计算设计敏感度主要有两种途径：直接法和伴随法，它们的计算成本与设计变量的数量 $m$ 和目标函数的数量 $p$ 有着不同的依赖关系。此练习  旨在从计算成本的角度，通过第一性原理对比这两种方法的效率，帮助您掌握在 $m \\gg p$ （多数优化问题的典型特征）时伴随法为何更优越。理解这一核心权衡，是掌握伴随法的关键第一步。",
            "id": "3543010",
            "problem": "考虑一个静态小变形线性弹性有限元模型，其位移向量 $u(\\theta) \\in \\mathbb{R}^{n_u}$ 由离散化平衡方程 $K(\\theta)\\,u(\\theta)=f(\\theta)$ 控制，其中 $K(\\theta) \\in \\mathbb{R}^{n_u \\times n_u}$ 是对称正定刚度矩阵，$f(\\theta)\\in \\mathbb{R}^{n_u}$ 是载荷向量。设计向量为 $\\theta \\in \\mathbb{R}^{m}$，其分量为 $\\theta_j$，其中 $j=1,\\dots,m$。假设我们对 $p$ 个标量响应泛函 $J_i(u(\\theta),\\theta)$ 感兴趣，其中 $i=1,\\dots,p$，每个泛函都对 $u$ 和 $\\theta$ 可微。我们希望计算完整的灵敏度矩阵，其条目为 $G_{ij} = \\partial J_i/\\partial \\theta_j$，适用于所有的 $i=1,\\dots,p$ 和 $j=1,\\dots,m$。\n\n您可以假设以下基本事实：\n- 平衡条件 $K(\\theta)u(\\theta)=f(\\theta)$ 对所有允许的 $\\theta$ 成立。\n- 可微函数乘积的微分遵循链式法则和乘积法则。\n- 对给定 $\\theta$ 的 $K(\\theta)$ 的单次分解可以被重用于求解具有不同右端项的多个线性系统，其边际成本低于重新分解。\n- 在基于伴随的灵敏度分析中，伴随变量 $\\lambda_i$ 通过线性系统 $K(\\theta)^{\\top}\\lambda_i=\\partial J_i/\\partial u$ 引入。\n\n不应作出任何额外假设。特别地，除了可微性之外，不要假设 $J_i$ 有任何特殊结构，也不要假设 $\\partial J_i/\\partial \\theta$ 为零。\n\n从第一性原理出发，并根据必须求解的以 $K(\\theta)$ (或其转置) 为系数矩阵的线性系统数量，在计算大量响应分量或大量设计变量的 $G_{ij}$ 时，哪种说法最能描述直接灵敏度方法与伴随方法的计算成本缩放？假设形成右端项和组装灵敏度缩并的成本非零，但在 $n_u$ 很大时，该成本远小于求解线性系统的成本。\n\nA. 对于计算所有 $i=1,\\dots,p$ 和 $j=1,\\dots,m$ 的 $G_{ij}$，直接法需要大约 $m$ 次以 $K(\\theta)$ 为系数矩阵的线性求解（每个设计变量一次），因为每次求解得到的 $u_{\\theta_j}$ 可用于所有 $i$；而伴随法需要大约 $p$ 次以 $K(\\theta)^{\\top}$ 为系数矩阵的求解（每个响应分量一次），因为每次求解得到的 $\\lambda_i$ 可用于所有 $j$。因此，当 $m \\gg p$ 时，伴随法更优；当 $p \\gg m$ 时，直接法更优。\n\nB. 直接法需要大约 $m\\,p$ 次线性求解，因为它必须对每个响应和每个设计变量重复；而伴随法无论 $m$ 和 $p$ 的大小都只需要 $1$ 次线性求解，因为伴随法消除了对两者的依赖。\n\nC. 当 $K(\\theta)$ 是对称的时，直接法和伴随法在线性求解方面的计算成本相同，因为两种情况都可以使用相同的分解，所以选择只影响内存使用。\n\nD. 对于单个标量目标（$p=1$）和大量设计变量（$m \\gg 1$），直接法更优，因为组装右端项 $-K_{\\theta_j}(\\theta)u(\\theta)+f_{\\theta_j}(\\theta)$ 的成本很低，使得 $m$ 次求解的成本与伴随法相比可以忽略不计。",
            "solution": "该问题要求描述在静态线性弹性问题背景下，直接和伴随灵敏度分析方法的计算成本缩放特性。成本将通过必须求解的线性系统数量来衡量。\n\n首先，我们验证问题陈述。\n**第1步：提取已知条件**\n-   控制方程：$K(\\theta)\\,u(\\theta)=f(\\theta)$，其中 $u(\\theta) \\in \\mathbb{R}^{n_u}$ 是位移向量，$K(\\theta) \\in \\mathbb{R}^{n_u \\times n_u}$ 是对称正定刚度矩阵，$f(\\theta)\\in \\mathbb{R}^{n_u}$ 是载荷向量。\n-   设计向量：$\\theta \\in \\mathbb{R}^{m}$，其分量为 $\\theta_j$，其中 $j=1,\\dots,m$。\n-   响应泛函：$p$ 个标量函数 $J_i(u(\\theta),\\theta)$，其中 $i=1,\\dots,p$。\n-   目标：计算灵敏度矩阵 $G$，其条目为 $G_{ij} = \\frac{d J_i}{d \\theta_j}$，适用于所有 $i$ 和 $j$。\n-   关键假设：\n    -   $K(\\theta)$ 是对称正定的。\n    -   求解线性系统的成本主导其他计算成本。\n    -   伴随方程由 $K(\\theta)^{\\top}\\lambda_i=\\frac{\\partial J_i}{\\partial u}$ 给出。\n\n**第2步：使用提取的已知条件进行验证**\n问题陈述在科学上是合理的、适定的和客观的。它为计算力学中的灵敏度分析提供了一个标准的、形式化的设置。所有术语都定义清晰，假设是标准的且自洽的。这个问题是该领域的一个基本问题。\n\n**第3步：判断和行动**\n问题有效。我们继续推导解答。\n\n**灵敏度表达式的推导**\n\n目标是计算每个响应泛函 $J_i$ 对每个设计变量 $\\theta_j$ 的全导数。使用链式法则，该导数为：\n$$\nG_{ij} = \\frac{d J_i}{d \\theta_j} = \\frac{\\partial J_i}{\\partial u} \\frac{d u}{d \\theta_j} + \\frac{\\partial J_i}{\\partial \\theta_j}\n$$\n在这里，$\\frac{\\partial J_i}{\\partial u}$ 是 $J_i$ 对 $u$ 的显式依赖的偏导数，$\\frac{\\partial J_i}{\\partial \\theta_j}$ 是对 $\\theta_j$ 的显式依赖的偏导数。项 $\\frac{d u}{d \\theta_j}$ 是状态向量 $u$ 对 $\\theta_j$ 的灵敏度，必须从控制平衡方程中确定。\n\n为了找到 $\\frac{d u}{d \\theta_j}$ 的方程，我们对平衡方程 $K(\\theta)u(\\theta) = f(\\theta)$ 关于 $\\theta_j$ 使用乘积法则进行微分：\n$$\n\\frac{d}{d \\theta_j} [K(\\theta) u(\\theta)] = \\frac{d}{d \\theta_j} [f(\\theta)]\n$$\n$$\n\\frac{\\partial K}{\\partial \\theta_j} u + K \\frac{d u}{d \\theta_j} = \\frac{\\partial f}{\\partial \\theta_j}\n$$\n整理后得到状态灵敏度向量 $\\frac{d u}{d \\theta_j}$ 的线性系统：\n$$\nK \\frac{d u}{d \\theta_j} = \\frac{\\partial f}{\\partial \\theta_j} - \\frac{\\partial K}{\\partial \\theta_j} u\n$$\n该方程是直接法和伴随法的核心。\n\n**直接灵敏度法**\n\n直接法通过显式计算每个状态灵敏度向量 $\\frac{d u}{d \\theta_j}$ 来进行。其算法是：\n1.  求解一次主平衡方程 $K u = f$ 以找到状态 $u$。\n2.  对每个设计变量 $\\theta_j$（其中 $j = 1, \\dots, m$）：\n    a. 组装右端项向量 $b_j = \\frac{\\partial f}{\\partial \\theta_j} - \\frac{\\partial K}{\\partial \\theta_j} u$。\n    b. 求解线性系统 $K \\frac{d u}{d \\theta_j} = b_j$ 以找到状态灵敏度向量 $\\frac{d u}{d \\theta_j}$。\n3.  一旦所有 $m$ 个灵敏度向量 $\\frac{d u}{d \\theta_j}$ 都被计算出来，使用以下公式计算完整的 $p \\times m$ 灵敏度矩阵 $G$：\n    $$\n    G_{ij} = \\left(\\frac{\\partial J_i}{\\partial u}\\right)^{\\top} \\frac{d u}{d \\theta_j} + \\frac{\\partial J_i}{\\partial \\theta_j} \\quad \\text{对于 } i=1,\\dots,p \\text{ 和 } j=1,\\dots,m\n    $$\n\n**成本分析（直接法）：**\n根据问题陈述，主要的计算成本由涉及矩阵 $K$ 的线性系统求解次数驱动。在为 $u$ 进行初始求解后，直接法需要为每个设计变量 $\\theta_j$ 求解一个线性系统。因此，它需要 $m$ 次线性求解。由于所有这些求解的矩阵 $K$ 都相同，其分解可以重用，使得每次后续求解（一次前向/后向代换）比第一次更便宜。总的主导成本与 $m$ 次线性求解成正比。\n\n**伴随灵敏度法**\n\n伴随法避免了显式计算状态灵敏度向量 $\\frac{d u}{d \\theta_j}$。相反，它引入伴随变量来重构计算。\n从灵敏度表达式开始：\n$$\nG_{ij} = \\left(\\frac{\\partial J_i}{\\partial u}\\right)^{\\top} \\frac{d u}{d \\theta_j} + \\frac{\\partial J_i}{\\partial \\theta_j}\n$$\n我们代入 $\\frac{d u}{d \\theta_j} = K^{-1} \\left( \\frac{\\partial f}{\\partial \\theta_j} - \\frac{\\partial K}{\\partial \\theta_j} u \\right)$:\n$$\nG_{ij} = \\left(\\frac{\\partial J_i}{\\partial u}\\right)^{\\top} K^{-1} \\left( \\frac{\\partial f}{\\partial \\theta_j} - \\frac{\\partial K}{\\partial \\theta_j} u \\right) + \\frac{\\partial J_i}{\\partial \\theta_j}\n$$\n使用性质 $(A B)^{\\top} = B^{\\top} A^{\\top}$，我们可以写出 $(K^{-1})^{\\top} = (K^{\\top})^{-1}$。表达式变为：\n$$\nG_{ij} = \\left( (K^{\\top})^{-1} \\frac{\\partial J_i}{\\partial u} \\right)^{\\top} \\left( \\frac{\\partial f}{\\partial \\theta_j} - \\frac{\\partial K}{\\partial \\theta_j} u \\right) + \\frac{\\partial J_i}{\\partial \\theta_j}\n$$\n现在，我们为每个响应泛函 $J_i$ 定义伴随向量 $\\lambda_i$，作为伴随方程的解：\n$$\n\\lambda_i = (K^{\\top})^{-1} \\frac{\\partial J_i}{\\partial u} \\quad \\implies \\quad K^{\\top} \\lambda_i = \\frac{\\partial J_i}{\\partial u}\n$$\n这与问题陈述中给出的定义相符。灵敏度表达式简化为：\n$$\nG_{ij} = \\lambda_i^{\\top} \\left( \\frac{\\partial f}{\\partial \\theta_j} - \\frac{\\partial K}{\\partial \\theta_j} u \\right) + \\frac{\\partial J_i}{\\partial \\theta_j}\n$$\n其算法是：\n1.  求解一次主平衡方程 $K u = f$ 以找到状态 $u$。\n2.  对每个响应泛函 $J_i$（其中 $i = 1, \\dots, p$）：\n    a. 组装右端项向量 $c_i = \\frac{\\partial J_i}{\\partial u}$。\n    b. 求解线性系统 $K^{\\top} \\lambda_i = c_i$ 以找到伴随向量 $\\lambda_i$。\n3.  一旦所有 $p$ 个伴随向量 $\\lambda_i$ 都被计算出来，使用上面的简化公式计算完整的 $p \\times m$ 灵敏度矩阵 $G$。\n\n**成本分析（伴随法）：**\n主导成本由求解伴随变量的线性系统驱动。这必须为每个响应泛函 $J_i$ 进行。因此，伴随法需要 $p$ 次线性求解。由于给定 $K$ 是对称的，所以 $K^{\\top} = K$，因此系数矩阵与直接法中的相同，其分解可以重用。总的主导成本与 $p$ 次线性求解成正比。\n\n**比较与结论**\n-   **直接法成本：** 与 $m$（设计变量的数量）成正比。\n-   **伴随法成本：** 与 $p$（响应泛函的数量）成正比。\n\n因此，方法的选择取决于 $m$ 和 $p$ 的相对大小。\n-   如果 $m \\ll p$（响应多，设计变量少），直接法更有效。\n-   如果 $m \\gg p$（设计变量多，响应少），伴随法更有效。一个常见的例子是优化问题，其中 $p=1$。\n\n现在，我们基于此推导来评估给定的选项。\n\n**A. 对于计算所有 $i=1,\\dots,p$ 和 $j=1,\\dots,m$ 的 $G_{ij}$，直接法需要大约 $m$ 次以 $K(\\theta)$ 为系数矩阵的线性求解（每个设计变量一次），因为每次求解得到的 $u_{\\theta_j}$ 可用于所有 $i$；而伴随法需要大约 $p$ 次以 $K(\\theta)^{\\top}$ 为系数矩阵的求解（每个响应分量一次），因为每次求解得到的 $\\lambda_i$ 可用于所有 $j$。因此，当 $m \\gg p$ 时，伴随法更优；当 $p \\gg m$ 时，直接法更优。**\n该陈述准确地反映了我们的推导。直接法为每个设计变量求解一个状态灵敏度向量 $\\frac{du}{d\\theta_j}$，需要 $m$ 次求解。每个这样的向量允许计算灵敏度矩阵的第 $j$ 列。伴随法为每个响应求解一个伴随向量 $\\lambda_i$，需要 $p$ 次求解。每个这样的向量允许计算灵敏度矩阵的第 $i$ 行。关于基于 $m$ 和 $p$ 相对大小的偏好选择的最终结论也是正确的。\n**结论：正确。**\n\n**B. 直接法需要大约 $m\\,p$ 次线性求解，因为它必须对每个响应和每个设计变量重复；而伴随法无论 $m$ 和 $p$ 的大小都只需要 $1$ 次线性求解，因为伴随法消除了对两者的依赖。**\n该陈述不正确。直接法的成本与 $m$ 成比例，而不是 $m \\times p$，因为状态灵敏度 $\\frac{du}{d\\theta_j}$ 不依赖于响应泛函 $J_i$。伴随法的成本与 $p$ 成比例，而不是 $1$（除非 $p=1$），因为必须为每个响应泛函求解一个独立的伴随问题。\n**结论：不正确。**\n\n**C. 当 $K(\\theta)$ 是对称的时，直接法和伴随法在线性求解方面的计算成本相同，因为两种情况都可以使用相同的分解，所以选择只影响内存使用。**\n该陈述不正确。虽然*每次求解*的成本是相同的，因为 $K^{\\top} = K$ 允许重用相同的矩阵分解，但*总求解次数*是不同的（直接法为 $m$ 次，伴随法为 $p$ 次）。如果 $m \\neq p$，总成本就不相同。这种选择是一个根本性的计算效率问题，而不仅仅是内存问题。\n**结论：不正确。**\n\n**D. 对于单个标量目标（$p=1$）和大量设计变量（$m \\gg 1$），直接法更优，因为组装右端项 $-K_{\\theta_j}(\\theta)u(\\theta)+f_{\\theta_j}(\\theta)$ 的成本很低，使得 $m$ 次求解的成本与伴随法相比可以忽略不计。**\n该陈述不正确。所描述的情景，$p=1$ 和 $m \\gg 1$，正是伴随法具有巨大优势的地方。伴随法需要 $p=1$ 次线性求解，而直接法需要 $m$ 次线性求解。对于大的 $m$，这种差异是显著的。关于 $m$ 次求解的成本变得可以忽略不计的前提，直接与问题中线性求解主导成本的假设相矛盾。\n**结论：不正确。**",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "掌握了伴随法的“为何用”之后，下一步是学习“如何用”，即如何针对一个具体的物理系统推导出敏感度表达式。本练习  将指导您完成一个经典的“纸笔”推导，针对在电磁学中广泛使用的频率相关的Debye色散介质模型，从连续域的麦克斯韦方程出发，应用伴随法得到目标函数对材料参数的解析梯度。通过这个过程，您将熟悉如何构建拉格朗日函数、定义伴随问题，并最终得到简洁的敏感度积分表达式，为分析更复杂的物理模型打下坚实的理论基础。",
            "id": "3288658",
            "problem": "考虑一个有界域 $\\Omega \\subset \\mathbb{R}^{3}$ 中的线性、各向同性、源驱动的时谐电磁场，其边界 $\\partial \\Omega$ 上具有单位外法线和阻抗边界条件。假设时间约定为 $\\exp(i \\omega t)$。在每个角频率 $\\omega$ 下，电场 $\\mathbf{E}(\\mathbf{r},\\omega)$ 满足从麦克斯韦方程组推导出的频域旋度-旋度方程：\n$$\n\\nabla \\times \\mu^{-1}(\\mathbf{r}) \\nabla \\times \\mathbf{E}(\\mathbf{r},\\omega) - \\omega^{2} \\epsilon(\\mathbf{r},\\omega) \\mathbf{E}(\\mathbf{r},\\omega) = i \\omega \\mathbf{J}_{\\mathrm{s}}(\\mathbf{r},\\omega),\n$$\n其中 $\\mu(\\mathbf{r})$ 是磁导率，$\\epsilon(\\mathbf{r},\\omega)$ 是电容率，$\\mathbf{J}_{\\mathrm{s}}(\\mathbf{r},\\omega)$ 是给定的源电流密度。假设在一个与 $\\Omega$ 重合的子区域内，材料的电容率遵循单极点德拜（Debye）色散模型，由下式给出：\n$$\n\\epsilon(\\mathbf{r},\\omega) = \\epsilon_{\\infty}(\\mathbf{r}) + \\frac{\\Delta \\epsilon(\\mathbf{r})}{1 + i \\omega \\tau(\\mathbf{r})},\n$$\n其中 $\\epsilon_{\\infty}(\\mathbf{r}) > 0$，$\\Delta \\epsilon(\\mathbf{r}) \\ge 0$ 且 $\\tau(\\mathbf{r}) > 0$。对于本问题，假设 $\\Delta \\epsilon(\\mathbf{r})$ 和 $\\tau(\\mathbf{r})$ 在 $\\Omega$ 内是空间均匀的（即与 $\\mathbf{r}$ 无关），但为待通过优化确定的未知标量，而 $\\epsilon_{\\infty}(\\mathbf{r})$ 和 $\\mu(\\mathbf{r})$ 是已知的、实的且严格为正的函数。\n\n令 $\\{\\omega_{k}\\}_{k=1}^{K}$ 为一个有限的正角频率集合。电场 $\\mathbf{E}(\\mathbf{r},\\omega_{k})$ 是在每个 $\\omega_{k}$ 处的正问题的解。定义目标泛函\n$$\nJ(\\Delta \\epsilon,\\tau) = \\frac{1}{2} \\sum_{k=1}^{K} \\int_{\\Omega} w(\\mathbf{r},\\omega_{k}) \\left| \\mathbf{E}(\\mathbf{r},\\omega_{k}) - \\mathbf{E}_{\\mathrm{t}}(\\mathbf{r},\\omega_{k}) \\right|^{2} \\, d\\mathbf{r},\n$$\n其中 $w(\\mathbf{r},\\omega_{k}) \\ge 0$ 是一个实值权重函数，$\\mathbf{E}_{\\mathrm{t}}(\\mathbf{r},\\omega_{k})$ 是一个给定的实数或复数目标场分布。$J$ 对 $(\\Delta \\epsilon,\\tau)$ 的依赖性是通过状态量 $\\mathbf{E}$ 并经由正向约束产生的。\n\n使用频域中的伴随状态法，推导灵敏度 $\\partial J / \\partial \\Delta \\epsilon$ 和 $\\partial J / \\partial \\tau$ 的解析表达式，用正向场 $\\mathbf{E}(\\mathbf{r},\\omega_{k})$、伴随场 $\\boldsymbol{\\lambda}(\\mathbf{r},\\omega_{k})$ 和材料参数来表示。你的推导必须从上述基本定律出发，并且必须明确地说明 $\\partial \\epsilon / \\partial p$（其中 $p \\in \\{\\Delta \\epsilon,\\tau\\}$）对将场映射到源的频域算子的影响。假设在每个 $\\omega_{k}$ 处的伴随场满足与 $\\Omega$ 上向量场的标准 $L^{2}$ 厄米（Hermitian）内积一致的适当的复共轭转置伴随方程。\n\n将你的最终结果表示为双分量梯度向量 $\\left( \\partial J / \\partial \\Delta \\epsilon, \\, \\partial J / \\partial \\tau \\right)$ 的单个闭式解析表达式，使用在 $\\Omega$ 上的积分形式和对离散频率集 $\\{\\omega_{k}\\}_{k=1}^{K}$ 的求和。不需要进行数值计算。不需要进行四舍五入。最终表达式中不要包含物理单位。",
            "solution": "在 $\\exp(i \\omega t)$ 时间约定下，由麦克斯韦方程组得到的频域旋度-旋度方程为\n$$\n\\nabla \\times \\mu^{-1}(\\mathbf{r}) \\nabla \\times \\mathbf{E}(\\mathbf{r},\\omega) - \\omega^{2} \\epsilon(\\mathbf{r},\\omega) \\mathbf{E}(\\mathbf{r},\\omega) = i \\omega \\mathbf{J}_{\\mathrm{s}}(\\mathbf{r},\\omega).\n$$\n我们记线性算子为\n$$\n\\mathcal{A}(\\omega; \\Delta \\epsilon,\\tau)\\mathbf{E} := \\nabla \\times \\mu^{-1}(\\mathbf{r}) \\nabla \\times \\mathbf{E}(\\mathbf{r},\\omega) - \\omega^{2} \\epsilon(\\mathbf{r},\\omega) \\mathbf{E}(\\mathbf{r},\\omega),\n$$\n因此正向约束为\n$$\n\\mathcal{A}(\\omega; \\Delta \\epsilon,\\tau)\\mathbf{E}(\\mathbf{r},\\omega) = i \\omega \\mathbf{J}_{\\mathrm{s}}(\\mathbf{r},\\omega).\n$$\n目标泛函为\n$$\nJ(\\Delta \\epsilon,\\tau) = \\frac{1}{2} \\sum_{k=1}^{K} \\int_{\\Omega} w(\\mathbf{r},\\omega_{k}) \\left| \\mathbf{E}(\\mathbf{r},\\omega_{k}) - \\mathbf{E}_{\\mathrm{t}}(\\mathbf{r},\\omega_{k}) \\right|^{2} \\, d\\mathbf{r}.\n$$\n我们对复向量场采用标准的 $L^{2}$ 厄米（Hermitian）内积，\n$$\n\\langle \\mathbf{u}, \\mathbf{v} \\rangle := \\int_{\\Omega} \\mathbf{u}^{*}(\\mathbf{r}) \\cdot \\mathbf{v}(\\mathbf{r}) \\, d\\mathbf{r},\n$$\n其中上标 $^{*}$ 表示复共轭，$\\,\\cdot\\,$ 表示 $\\mathbb{C}^{3}$ 上的欧几里得点积。\n\n我们求解灵敏度 $\\partial J / \\partial p$，其中 $p \\in \\{\\Delta \\epsilon,\\tau\\}$。$J$ 对 $p$ 的依赖性是隐式的，通过状态量 $\\mathbf{E}$ 体现，该状态量满足 $\\mathcal{A}(\\omega;p)\\mathbf{E}(\\omega) = i\\omega \\mathbf{J}_{\\mathrm{s}}(\\omega)$，为简洁起见，我们在记法中省略了 $\\mathbf{r}$。对正向约束关于 $p$ 求导，得到一阶变分\n$$\n\\mathcal{A}(\\omega;p)\\,\\delta \\mathbf{E}(\\omega) + \\left( \\frac{\\partial \\mathcal{A}(\\omega;p)}{\\partial p} \\right) \\mathbf{E}(\\omega) \\, \\delta p = \\mathbf{0}.\n$$\n我们也计算 $J$ 的一阶变分，\n$$\n\\delta J = \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} w(\\mathbf{r},\\omega_{k}) \\left( \\mathbf{E}(\\mathbf{r},\\omega_{k}) - \\mathbf{E}_{\\mathrm{t}}(\\mathbf{r},\\omega_{k}) \\right) \\cdot \\delta \\mathbf{E}^{*}(\\mathbf{r},\\omega_{k}) \\, d\\mathbf{r} \\right\\},\n$$\n其中 $\\Re\\{\\cdot\\}$ 表示实部，我们利用了 $J$ 是实值且是场失配的二次函数这一事实。\n\n为消除对 $\\delta \\mathbf{E}$ 的依赖，我们在每个 $\\omega$ 引入伴随场 $\\boldsymbol{\\lambda}(\\mathbf{r},\\omega)$，要求它满足伴随方程\n$$\n\\mathcal{A}^{\\dagger}(\\omega;p)\\,\\boldsymbol{\\lambda}(\\mathbf{r},\\omega) = w(\\mathbf{r},\\omega) \\left( \\mathbf{E}(\\mathbf{r},\\omega) - \\mathbf{E}_{\\mathrm{t}}(\\mathbf{r},\\omega) \\right),\n$$\n其中 $\\mathcal{A}^{\\dagger}$ 表示在所选厄米内积下的伴随算子。对于算子\n$$\n\\mathcal{A}(\\omega;p) = \\nabla \\times \\mu^{-1}(\\mathbf{r}) \\nabla \\times \\,\\cdot\\, - \\omega^{2} \\epsilon(\\mathbf{r},\\omega;p)\\, \\mathrm{Id},\n$$\n其中 $\\mu(\\mathbf{r})$ 和 $\\epsilon_{\\infty}(\\mathbf{r})$ 为实数，而德拜（Debye）电容率 $\\epsilon(\\mathbf{r},\\omega;p)$ 可能为复数值，其在 $L^{2}$ 厄米内积下的伴随算子形式为\n$$\n\\mathcal{A}^{\\dagger}(\\omega;p) = \\nabla \\times \\mu^{-1}(\\mathbf{r}) \\nabla \\times \\,\\cdot\\, - \\omega^{2} \\epsilon^{*}(\\mathbf{r},\\omega;p)\\, \\mathrm{Id},\n$$\n并服从相同的边界条件，因为在假定的边界条件下，对于实数 $\\mu(\\mathbf{r})$，旋度-旋度算子是自伴的。\n\n根据对偶性，我们在内积中将线性化约束乘以 $\\boldsymbol{\\lambda}^{*}$，并利用伴随方程写出\n$$\n0 = \\langle \\boldsymbol{\\lambda}, \\mathcal{A}(\\omega;p)\\,\\delta \\mathbf{E} \\rangle + \\left\\langle \\boldsymbol{\\lambda}, \\left( \\frac{\\partial \\mathcal{A}(\\omega;p)}{\\partial p} \\right) \\mathbf{E} \\right\\rangle \\delta p\n= \\langle \\mathcal{A}^{\\dagger}(\\omega;p)\\,\\boldsymbol{\\lambda}, \\delta \\mathbf{E} \\rangle + \\left\\langle \\boldsymbol{\\lambda}, \\left( \\frac{\\partial \\mathcal{A}(\\omega;p)}{\\partial p} \\right) \\mathbf{E} \\right\\rangle \\delta p.\n$$\n使用伴随定义 $\\mathcal{A}^{\\dagger}(\\omega;p)\\,\\boldsymbol{\\lambda} = w(\\mathbf{r},\\omega) \\left( \\mathbf{E} - \\mathbf{E}_{\\mathrm{t}} \\right)$ 并与 $\\delta J$ 比较，我们得到\n$$\n\\delta J = \\sum_{k=1}^{K} \\Re \\left\\{ \\langle w(\\mathbf{r},\\omega_{k})(\\mathbf{E} - \\mathbf{E}_{\\mathrm{t}}), \\delta \\mathbf{E} \\rangle \\right\\}\n= \\sum_{k=1}^{K} \\Re \\left\\{ \\langle \\mathcal{A}^{\\dagger}(\\omega_{k};p)\\,\\boldsymbol{\\lambda}(\\omega_{k}), \\delta \\mathbf{E}(\\omega_{k}) \\rangle \\right\\}.\n$$\n因此，\n$$\n\\delta J = - \\sum_{k=1}^{K} \\Re \\left\\{ \\left\\langle \\boldsymbol{\\lambda}(\\omega_{k}), \\left( \\frac{\\partial \\mathcal{A}(\\omega_{k};p)}{\\partial p} \\right) \\mathbf{E}(\\omega_{k}) \\right\\rangle \\right\\} \\delta p,\n$$\n这便得到伴随状态灵敏度公式\n$$\n\\frac{\\partial J}{\\partial p} = - \\sum_{k=1}^{K} \\Re \\left\\{ \\left\\langle \\boldsymbol{\\lambda}(\\omega_{k}), \\left( \\frac{\\partial \\mathcal{A}(\\omega_{k};p)}{\\partial p} \\right) \\mathbf{E}(\\omega_{k}) \\right\\rangle \\right\\}.\n$$\n现在我们显式计算 $\\partial \\mathcal{A} / \\partial p$。算子仅通过 $-\\omega^{2} \\epsilon(\\mathbf{r},\\omega;p)\\,\\mathrm{Id}$ 项依赖于 $\\epsilon(\\mathbf{r},\\omega;p)$。因此，\n$$\n\\frac{\\partial \\mathcal{A}(\\omega;p)}{\\partial p} = - \\omega^{2} \\left( \\frac{\\partial \\epsilon(\\mathbf{r},\\omega;p)}{\\partial p} \\right) \\mathrm{Id}.\n$$\n对于德拜模型\n$$\n\\epsilon(\\mathbf{r},\\omega;p) = \\epsilon_{\\infty}(\\mathbf{r}) + \\frac{\\Delta \\epsilon}{1 + i \\omega \\tau},\n$$\n其中 $\\Delta \\epsilon$ 和 $\\tau$ 在 $\\Omega$ 内是均匀的，我们有参数导数\n$$\n\\frac{\\partial \\epsilon(\\mathbf{r},\\omega;p)}{\\partial \\Delta \\epsilon} = \\frac{1}{1 + i \\omega \\tau}, \\qquad\n\\frac{\\partial \\epsilon(\\mathbf{r},\\omega;p)}{\\partial \\tau} = \\Delta \\epsilon \\frac{\\partial}{\\partial \\tau} \\left( \\frac{1}{1 + i \\omega \\tau} \\right) = - \\frac{i \\omega \\Delta \\epsilon}{(1 + i \\omega \\tau)^{2}}.\n$$\n因此，\n$$\n\\frac{\\partial \\mathcal{A}(\\omega;\\Delta \\epsilon,\\tau)}{\\partial \\Delta \\epsilon} = - \\omega^{2} \\frac{1}{1 + i \\omega \\tau}\\, \\mathrm{Id}, \\qquad\n\\frac{\\partial \\mathcal{A}(\\omega;\\Delta \\epsilon,\\tau)}{\\partial \\tau} = - \\omega^{2} \\left( - \\frac{i \\omega \\Delta \\epsilon}{(1 + i \\omega \\tau)^{2}} \\right) \\mathrm{Id}\n= \\frac{i \\omega^{3} \\Delta \\epsilon}{(1 + i \\omega \\tau)^{2}}\\, \\mathrm{Id}.\n$$\n将这些代入灵敏度公式，并明确写出内积，我们得到\n$$\n\\frac{\\partial J}{\\partial \\Delta \\epsilon}\n= - \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\left[ - \\omega_{k}^{2} \\frac{1}{1 + i \\omega_{k} \\tau} \\mathbf{E}(\\mathbf{r},\\omega_{k}) \\right] \\, d\\mathbf{r} \\right\\}\n= \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\omega_{k}^{2} \\frac{1}{1 + i \\omega_{k} \\tau} \\, \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\mathbf{E}(\\mathbf{r},\\omega_{k}) \\, d\\mathbf{r} \\right\\},\n$$\n以及\n$$\n\\frac{\\partial J}{\\partial \\tau}\n= - \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\left[ \\frac{i \\omega_{k}^{3} \\Delta \\epsilon}{(1 + i \\omega_{k} \\tau)^{2}} \\mathbf{E}(\\mathbf{r},\\omega_{k}) \\right] \\, d\\mathbf{r} \\right\\}\n= - \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\frac{i \\omega_{k}^{3} \\Delta \\epsilon}{(1 + i \\omega_{k} \\tau)^{2}} \\, \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\mathbf{E}(\\mathbf{r},\\omega_{k}) \\, d\\mathbf{r} \\right\\}.\n$$\n我们也可以将 $\\partial J / \\partial \\tau$ 表示为\n$$\n\\frac{\\partial J}{\\partial \\tau}\n= \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\omega_{k}^{2} \\left( - \\frac{\\partial \\epsilon(\\omega_{k})}{\\partial \\tau} \\right) \\boldsymbol{\\lambda}^{*} \\cdot \\mathbf{E} \\, d\\mathbf{r} \\right\\}\n= \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\frac{i \\omega_{k}^{3} \\Delta \\epsilon}{(1 + i \\omega_{k} \\tau)^{2}} \\, \\boldsymbol{\\lambda}^{*} \\cdot \\mathbf{E} \\, d\\mathbf{r} \\right\\},\n$$\n这与之前的表达式一致，只是算子导数中明确写出了负号。伴随场 $\\boldsymbol{\\lambda}(\\mathbf{r},\\omega_{k})$ 通过求解以下方程确定\n$$\n\\nabla \\times \\mu^{-1}(\\mathbf{r}) \\nabla \\times \\boldsymbol{\\lambda}(\\mathbf{r},\\omega_{k}) - \\omega_{k}^{2} \\epsilon^{*}(\\mathbf{r},\\omega_{k}) \\boldsymbol{\\lambda}(\\mathbf{r},\\omega_{k})\n= w(\\mathbf{r},\\omega_{k}) \\left( \\mathbf{E}(\\mathbf{r},\\omega_{k}) - \\mathbf{E}_{\\mathrm{t}}(\\mathbf{r},\\omega_{k}) \\right),\n$$\n其边界条件与正问题相同，确保了伴随状态法一致地考虑了算子对色散电容率的依赖性。\n\n将两个灵敏度收集到一个行向量中，梯度为\n$$\n\\left( \\frac{\\partial J}{\\partial \\Delta \\epsilon}, \\, \\frac{\\partial J}{\\partial \\tau} \\right)\n= \\left( \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\omega_{k}^{2} \\frac{ \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\mathbf{E}(\\mathbf{r},\\omega_{k}) }{1 + i \\omega_{k} \\tau} \\, d\\mathbf{r} \\right\\}, \\;\n- \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\frac{i \\omega_{k}^{3} \\Delta \\epsilon}{(1 + i \\omega_{k} \\tau)^{2}} \\, \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\mathbf{E}(\\mathbf{r},\\omega_{k}) \\, d\\mathbf{r} \\right\\} \\right).\n$$\n该表达式明确地包含了 $\\partial \\epsilon / \\partial p$ 对算子 $\\mathcal{A}$ 的影响，并给出了德拜色散参数所需的频域伴随灵敏度。",
            "answer": "$$\\boxed{\\begin{pmatrix}\n\\displaystyle \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\omega_{k}^{2} \\frac{ \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\mathbf{E}(\\mathbf{r},\\omega_{k}) }{1 + i \\omega_{k} \\tau} \\, d\\mathbf{r} \\right\\} \\\\\n\\displaystyle - \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\frac{i \\omega_{k}^{3} \\Delta \\epsilon}{(1 + i \\omega_{k} \\tau)^{2}} \\, \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\mathbf{E}(\\mathbf{r},\\omega_{k}) \\, d\\mathbf{r} \\right\\}\n\\end{pmatrix}}$$"
        },
        {
            "introduction": "从理论推导到实际应用，一个关键的步骤是确保我们计算出的梯度是正确的，否则任何基于梯度的优化算法都将走向错误的方向。本练习  将理论与实践相结合，要求您为一个离散化的标量波动方程实现伴随态方法，并编写代码来执行“梯度检验”。您需要将伴随法计算出的梯度与高精度的有限差分结果进行对比，通过观察误差随步长减小的收敛阶，来验证您推导和实现的正确性。这项技能对于任何从事计算优化的研究者或工程师来说都是必不可少的，是确保数值代码可靠性的黄金标准。",
            "id": "3288672",
            "problem": "考虑一个二维标量频域波动模型，该模型通过将横磁极化下的麦克斯韦方程组简化为方形域上的标量亥姆霍兹型方程而得到，并采用均匀狄利克雷边界条件。设计算域被离散化为一个包含 $N \\times N$ 个内部节点的网格，网格间距为 $\\Delta x$，因此 $n = N^2$ 的离散负拉普拉斯算子 $L \\in \\mathbb{R}^{n \\times n}$ 由标准的五点差分格式给出。定义与参数相关的系统矩阵为\n$$\nA(\\varepsilon) \\;=\\; L \\;+\\; \\omega^2 \\operatorname{diag}(\\varepsilon),\n$$\n其中 $\\varepsilon \\in \\mathbb{R}^n$ 是网格节点上空间变化的介电常数，$\\omega$ 是角频率。对于一个固定的实值源向量 $b \\in \\mathbb{R}^n$，状态 $u(\\varepsilon) \\in \\mathbb{R}^n$ 满足线性系统\n$$\nA(\\varepsilon)\\, u(\\varepsilon) \\;=\\; b.\n$$\n考虑标量目标泛函\n$$\nJ(u) \\;=\\; \\tfrac{1}{2}\\,\\lVert B\\,u \\rVert_2^2,\n$$\n其中 $B \\in \\mathbb{R}^{m \\times n}$ 是一个线性测量算子，用于选择指定的网格节点（例如，单个“传感器”节点）。\n\n您将需要验证目标函数 $J$ 相对于对应于单个体素（网格节点）索引 $i_0$ 的局部介电常数参数 $p$ 的伴随态梯度。该验证使用有限差分检验来展示渐近一致性。\n\n您的任务：\n\n- 从离散正演模型 $A(\\varepsilon)\\,u = b$ 和 $J(u)$ 的定义出发，基于第一性原理推导灵敏度 $\\partial J/\\partial p$ 的伴随态方法，其中 $p$ 是体素 $i_0$ 处的 $\\varepsilon$ 值。仅使用链式法则、线性系统性质和内积对偶性；不要假定任何预先推导的梯度公式。\n- 指定一个误差度量，用于比较 $J$ 的一阶变分的伴随预测与对称有限差分评估。该度量必须是无量纲的，并且必须能揭示随着步长 $h$ 减小时的渐近一致性。\n- 选择一个具体的、完全指定的检验如下：\n  - 使用 $N = 30$ 和 $\\Delta x = 1$，因此 $n = N^2 = 900$。\n  - 使用由五点差分格式形成的离散负拉普拉斯算子 $L$：每个内部节点的主对角线元素为 $4/\\Delta x^2$，四个最近邻的非对角线元素为 $-1/\\Delta x^2$。\n  - 设置 $\\omega = 4$（单位：弧度/秒）。由于最终要求的输出是无量纲的误差度量，因此输出中不需要进行单位转换。\n  - 使用均匀的背景介电常数 $\\varepsilon_{\\mathrm{bg}} = 1$，即 $\\varepsilon = \\varepsilon_{\\mathrm{bg}} \\mathbf{1}$，除了用于有限差分扰动的体素 $i_0$。\n  - 在网格索引 $(i_s, j_s) = (\\lfloor N/3 \\rfloor, \\lfloor N/3 \\rfloor)$ 处放置一个单位振幅点源，方法是将其对应的 $b$ 的分量设置为 $1$，所有其他分量设置为 $0$。\n  - 定义测量算子 $B$ 以在 $(i_r, j_r) = (2\\lfloor N/3 \\rfloor, 2\\lfloor N/3 \\rfloor)$ 处选取单个传感器节点，因此 $m = 1$ 且 $J(u) = \\tfrac{1}{2} \\, |u_{i_r,j_r}|^2$。\n  - 选择参数体素索引 $i_0$ 为中心网格节点 $(\\lfloor N/2 \\rfloor, \\lfloor N/2 \\rfloor)$。\n- 实现一个程序，该程序：\n  - 构建 $L$，并对于每个所需的介电常数，构建 $A(\\varepsilon)$ 并求解 $u$。\n  - 构建并求解您的推导所隐含的伴随系统，以获得伴随态和在体素 $i_0$ 处的梯度分量 $\\partial J/\\partial p$。\n  - 对于检验套件 $h \\in \\{10^{-1}, 10^{-2}, 10^{-3}, 10^{-4}, 10^{-5}\\}$ 中的每个有限差分步长 $h$（其中 $h$ 被解释为对体素介电常数的绝对扰动，在此设置中是无量纲的），计算对称差分\n    $$\n    \\Delta J_{\\mathrm{fd}}(h) \\;=\\; J\\big(u(\\varepsilon + h\\,e_{i_0})\\big) \\;-\\; J\\big(u(\\varepsilon - h\\,e_{i_0})\\big),\n    $$\n    其中 $e_{i_0}$ 是索引 $i_0$ 处的标准基向量，并将其与伴随一阶预测 $2h\\,(\\partial J/\\partial p)$ 进行比较。\n  - 对每个 $h$ 使用以下误差度量：\n    $$\n    r(h) \\;=\\; \\frac{\\big|\\Delta J_{\\mathrm{fd}}(h) \\;-\\; 2h\\,(\\partial J/\\partial p)\\big|}{\\max\\!\\big(10^{-14}, \\, \\big|\\Delta J_{\\mathrm{fd}}(h)\\big|\\big)}.\n    $$\n    此度量是无量纲的，并且在舍入误差占主导地位之前，应在渐近区域内随 $h$ 减小而衰减。\n- 输出规范：您的程序应生成单行输出，其中包含结果，以方括号括起来的逗号分隔列表形式，顺序与所提供的检验套件步长 $[10^{-1},10^{-2},10^{-3},10^{-4},10^{-5}]$ 一致。每个条目必须是对应 $h$ 的 $r(h)$ 的浮点值，无单位。\n\n您提交的必须是一个完整、可运行的程序，该程序构建线性系统，计算正演和伴随解，为指定的步长评估梯度和有限差分检验，并以上述确切格式打印结果列表。不允许用户输入。结果值为纯数字（无量纲）。设计必须确保指定配置的科学真实性和数值合理性，并且推导必须从所述的离散模型和目标函数开始，而不使用预先推导的灵敏度公式。",
            "solution": "用户提供了一个在计算电磁学领域中定义明确的问题，具体涉及离散标量亥姆霍兹方程的伴随态梯度的验证。该问题具有科学依据、自成体系且算法上已明确指定。我将首先按照要求从第一性原理推导伴随态梯度，然后指定验证程序和误差度量，最后实现数值解。\n\n### 第1部分：伴随态梯度的第一性原理推导\n\n该问题由以下方程定义：\n1.  状态方程：$A(\\varepsilon) u(\\varepsilon) = b$，其中 $A(\\varepsilon) = L + \\omega^2 \\operatorname{diag}(\\varepsilon)$。\n2.  目标泛函：$J(u) = \\frac{1}{2} \\|Bu\\|_2^2$。\n\n令我们关注的参数 $p$ 为单个网格节点 $i_0$ 处的介电常数，即 $p = \\varepsilon_{i_0}$。我们寻求 $J$ 关于 $p$ 的全导数，记为 $\\frac{dJ}{dp}$。\n\n应用链式法则，$J$ 关于 $p$ 的导数为：\n$$\n\\frac{dJ}{dp} = \\left(\\nabla_u J\\right)^T \\frac{du}{dp}\n$$\n其中 $\\nabla_u J \\in \\mathbb{R}^n$ 是 $J$ 关于状态向量 $u$ 的梯度，而 $\\frac{du}{dp} \\in \\mathbb{R}^n$ 是状态关于参数 $p$ 的灵敏度。\n\n为了找到 $\\frac{du}{dp}$ 的表达式，我们对状态方程关于 $p$ 求导。由于源项 $b$ 与 $p$ 无关，其导数为零：\n$$\n\\frac{d}{dp} \\left( A(\\varepsilon(p)) u(\\varepsilon(p)) \\right) = \\frac{db}{dp} = 0\n$$\n$$\n\\frac{dA}{dp} u + A \\frac{du}{dp} = 0\n$$\n求解状态灵敏度 $\\frac{du}{dp}$ 得到：\n$$\n\\frac{du}{dp} = -A^{-1} \\frac{dA}{dp} u\n$$\n将此代入 $\\frac{dJ}{dp}$ 的表达式中：\n$$\n\\frac{dJ}{dp} = -(\\nabla_u J)^T A^{-1} \\frac{dA}{dp} u\n$$\n项 $(\\nabla_u J)^T A^{-1}$ 的计算量可能很大。伴随方法重新排列了计算顺序。利用对于可逆矩阵 $A$，有 $(A^{-1})^T=(A^T)^{-1}$ 的性质，我们可以将表达式重写为：\n$$\n\\frac{dJ}{dp} = - \\left( (A^T)^{-1} \\nabla_u J \\right)^T \\frac{dA}{dp} u\n$$\n我们现在将伴随态向量 $\\lambda \\in \\mathbb{R}^n$ 定义为伴随方程的解：\n$$\nA^T \\lambda = \\nabla_u J\n$$\n将 $\\lambda = (A^T)^{-1} \\nabla_u J$ 代入梯度表达式，我们得到梯度的伴随表示法：\n$$\n\\frac{dJ}{dp} = -\\lambda^T \\frac{dA}{dp} u\n$$\n这种表示法在计算上是高效的。它需要求解一个正演线性系统以获得 $u$，一个伴随线性系统以获得 $\\lambda$，然后通过向量积为每个关注的参数计算梯度。\n\n现在我们将这个通用结果具体化到给定的问题：\n-   **目标梯度 $\\nabla_u J$**：目标函数为 $J(u) = \\frac{1}{2} u^T B^T B u$。其关于 $u$ 的梯度为 $\\nabla_u J = B^T B u$。在我们的具体案例中，$B$ 选择单个节点 $i_r$，因此 $B = e_{i_r}^T$。从而，$B^T B = e_{i_r}e_{i_r}^T$，这是一个除了在 $(i_r, i_r)$ 对角线位置为 $1$ 之外全为零的矩阵。乘积 $B^T B u$ 是一个向量，除了在索引 $i_r$ 处的值为 $u_{i_r}$ 外，其他地方均为零。所以，$\\nabla_u J = u_{i_r} e_{i_r}$。\n-   **系统矩阵对称性**：矩阵 $A(\\varepsilon) = L + \\omega^2 \\operatorname{diag}(\\varepsilon)$ 是对称的。用于标准五点差分格式的离散负拉普拉斯算子 $L$ 是对称的，而 $\\operatorname{diag}(\\varepsilon)$ 是一个对角矩阵，因此也是对称的。因此 $A^T = A$。\n-   **伴随方程**：伴随方程 $A^T \\lambda = \\nabla_u J$ 简化为 $A \\lambda = u_{i_r} e_{i_r}$。\n-   **矩阵导数 $\\frac{dA}{dp}$**：参数是 $p = \\varepsilon_{i_0}$。介电常数向量 $\\varepsilon$ 仅在索引 $i_0$ 处依赖于 $p$，因此 $\\frac{\\partial \\varepsilon}{\\partial p} = e_{i_0}$。系统矩阵的导数为：\n$$\n\\frac{dA}{dp} = \\frac{d}{dp}\\left(L + \\omega^2 \\operatorname{diag}(\\varepsilon)\\right) = \\omega^2 \\operatorname{diag}\\left(\\frac{d\\varepsilon}{dp}\\right) = \\omega^2 \\operatorname{diag}(e_{i_0})\n$$\n矩阵 $\\operatorname{diag}(e_{i_0})$ 是一个只有一个非零元素的矩阵，在位置 $(i_0, i_0)$ 处为 $1$。\n-   **最终梯度表达式**：将这些分量代入伴随梯度公式中：\n$$\n\\frac{dJ}{dp} = -\\lambda^T \\left( \\omega^2 \\operatorname{diag}(e_{i_0}) \\right) u\n$$\n乘积 $\\left( \\operatorname{diag}(e_{i_0}) \\right) u$ 产生一个向量，其唯一的非零分量是在索引 $i_0$ 处的 $u_{i_0}$。随后的与 $\\lambda^T$ 的内积会提取出第 $i_0$ 个分量，结果为：\n$$\n\\frac{\\partial J}{\\partial p} = -\\omega^2 \\lambda_{i_0} u_{i_0}\n$$\n\n### 第2部分：误差度量和验证程序\n\n为了验证推导出的梯度，我们将其对 $J$ 变化的预测与通过对称有限差分方案计算出的结果进行比较。泰勒级数展开表明，对于一个小的步长 $h$：\n$$\nJ(p+h) - J(p-h) = 2h \\frac{\\partial J}{\\partial p} + O(h^3)\n$$\n左侧项是​​对称有限差分变分 $\\Delta J_{\\mathrm{fd}}(h)$。右侧第一项是基于伴随态梯度的一阶预测。它们之间的差异是截断误差，其阶数为 $O(h^3)$。\n\n提供的误差度量为：\n$$\nr(h) = \\frac{\\big|\\Delta J_{\\mathrm{fd}}(h) - 2h\\,(\\partial J/\\partial p)\\big|}{\\max\\!\\big(10^{-14}, \\, \\big|\\Delta J_{\\mathrm{fd}}(h)\\big|\\big)}\n$$\n分子是绝对截断误差，预计为 $O(h^3)$。分母主要由 $|\\Delta J_{\\mathrm{fd}}(h)|$ 决定，其近似为 $|2h (\\partial J/\\partial p)| = O(h)$。因此，相对误差度量 $r(h)$ 的阶数应为 $O(h^2)$。随着 $h$ 减小，这种二阶收敛是梯度计算正确的一个有力指标。分母中的 $10^{-14}$ 项作为一个下限，以防止当 $h$ 变得极小时出现除以零或除以数值上无意义的值的情况。\n\n### 第3部分：数值实现计划\n\n1.  **设置**：定义常量：$N=30$， $n=N^2=900$， $\\Delta x=1$， $\\omega=4$， $\\varepsilon_{\\mathrm{bg}}=1$。确定源 $(k_s)$、接收器 $(k_r)$ 和参数 $(k_p)$ 的一维索引。\n2.  **矩阵构建**：为 $N \\times N$ 网格构建具有狄利克雷边界条件的离散负拉普拉斯算子 $L$ 作为稀疏矩阵。\n3.  **伴随梯度计算**：\n    a.  设置 $\\varepsilon = \\varepsilon_{\\mathrm{bg}}\\mathbf{1}$。\n    b.  构建标称矩阵 $A = L + \\omega^2 \\operatorname{diag}(\\varepsilon)$。\n    c.  构建源向量 $b = e_{k_s}$。\n    d.  求解正演系统 $Au = b$ 以获得状态 $u$。\n    e.  构建伴随源 $f_{adj} = u_{k_r} e_{k_r}$。\n    f.  求解伴随系统 $A\\lambda = f_{adj}$ 以获得伴随态 $\\lambda$。\n    g.  计算梯度 $\\frac{\\partial J}{\\partial p} = -\\omega^2 \\lambda_{k_p} u_{k_p}$。\n4.  **有限差分循环**：对于 $\\{10^{-1}, 10^{-2}, 10^{-3}, 10^{-4}, 10^{-5}\\}$ 中的每个步长 $h$：\n    a.  创建扰动后的介电常数向量 $\\varepsilon_{\\pm} = \\varepsilon_{\\mathrm{bg}}\\mathbf{1} \\pm h e_{k_p}$。\n    b.  构建扰动后的矩阵 $A_{\\pm} = L + \\omega^2 \\operatorname{diag}(\\varepsilon_{\\pm})$。\n    c.  求解系统 $A_{\\pm}u_{\\pm} = b$ 以获得状态 $u_{\\pm}$。\n    d.  计算目标函数值 $J_{\\pm} = \\frac{1}{2} (u_{\\pm})_{k_r}^2$。\n    e.  计算有限差分变分 $\\Delta J_{\\mathrm{fd}}(h) = J_+ - J_-$。\n    f.  按规定计算误差度量 $r(h)$。\n5.  **输出**：收集 $r(h)$ 的值，并以要求的格式打印。为提高效率，将使用 `scipy.sparse` 和 `scipy.sparse.linalg` 中的稀疏线性代数例程。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nimport scipy.sparse as sp\nimport scipy.sparse.linalg as spla\n\ndef solve():\n    \"\"\"\n    Performs adjoint-state sensitivity analysis for a 2D scalar wave equation\n    and validates the gradient using a finite-difference test.\n    \"\"\"\n\n    # 1. Setup: Define problem parameters\n    N = 30\n    n = N * N\n    dx = 1.0\n    omega = 4.0\n    omega2 = omega**2\n    eps_bg_val = 1.0\n\n    # Grid locations and their 1D indices\n    is_src, js_src = N // 3, N // 3\n    k_src = is_src * N + js_src\n\n    is_rcv, js_rcv = 2 * (N // 3), 2 * (N // 3)\n    k_rcv = is_rcv * N + js_rcv\n\n    is_param, js_param = N // 2, N // 2\n    k_param = is_param * N + js_param\n    \n    # Finite-difference step sizes\n    h_steps = [10**(-i) for i in range(1, 6)]\n\n    # 2. Matrix Construction: Build the discrete Laplacian L\n    # Using LIL format for easy construction, then CSR for efficient computation\n    L = sp.lil_matrix((n, n), dtype=np.float64)\n    laplacian_coeff = 1.0 / (dx**2)\n\n    for i in range(N):\n        for j in range(N):\n            k = i * N + j\n            \n            # Main diagonal\n            L[k, k] = 4.0 * laplacian_coeff\n            \n            # Off-diagonals for neighbors\n            if i > 0:   # Neighbor above\n                L[k, k - N] = -1.0 * laplacian_coeff\n            if i  N - 1: # Neighbor below\n                L[k, k + N] = -1.0 * laplacian_coeff\n            if j > 0:   # Neighbor left\n                L[k, k - 1] = -1.0 * laplacian_coeff\n            if j  N - 1: # Neighbor right\n                L[k, k + 1] = -1.0 * laplacian_coeff\n    \n    # Convert to CSR (Compressed Sparse Row) format for fast arithmetic and solving\n    L = L.tocsr()\n\n    # 3. Adjoint Gradient Calculation\n    \n    # Background permittivity vector\n    eps_bg = np.full(n, eps_bg_val, dtype=np.float64)\n    \n    # System matrix A for the background medium\n    A_bg = L + sp.diags(omega2 * eps_bg, 0, format='csr')\n\n    # Source vector b (point source)\n    b = np.zeros(n, dtype=np.float64)\n    b[k_src] = 1.0\n\n    # a. Solve forward problem for state u\n    u = spla.spsolve(A_bg, b)\n\n    # b. Solve adjoint problem for lambda\n    # Adjoint source f_adj = B^T * B * u. For B = e_{k_rcv}^T, this is u[k_rcv] * e_{k_rcv}\n    adj_rhs = np.zeros(n, dtype=np.float64)\n    adj_rhs[k_rcv] = u[k_rcv]\n    \n    # The adjoint system matrix is A^T. Since A is symmetric, A^T = A.\n    adjoint_state = spla.spsolve(A_bg, adj_rhs)\n\n    # c. Compute the gradient dJ/dp\n    # dJ/dp = -omega^2 * lambda[k_param] * u[k_param]\n    grad_adj = -omega2 * adjoint_state[k_param] * u[k_param]\n    \n    # 4. Finite-Difference Validation Loop\n    results = []\n    \n    for h in h_steps:\n        # Perturb permittivity up and down\n        eps_plus = eps_bg.copy()\n        eps_plus[k_param] += h\n        \n        eps_minus = eps_bg.copy()\n        eps_minus[k_param] -= h\n        \n        # Form perturbed system matrices\n        A_plus = L + sp.diags(omega2 * eps_plus, 0, format='csr')\n        A_minus = L + sp.diags(omega2 * eps_minus, 0, format='csr')\n        \n        # Solve for perturbed states\n        u_plus = spla.spsolve(A_plus, b)\n        u_minus = spla.spsolve(A_minus, b)\n        \n        # Calculate objective function for each state\n        # J(u) = 0.5 * u[k_rcv]^2\n        J_plus = 0.5 * u_plus[k_rcv]**2\n        J_minus = 0.5 * u_minus[k_rcv]**2\n        \n        # Symmetric finite-difference variation\n        delta_J_fd = J_plus - J_minus\n        \n        # Adjoint first-order prediction of the variation\n        delta_J_adj = 2.0 * h * grad_adj\n        \n        # Compute the relative error metric\n        denominator = max(1e-14, abs(delta_J_fd))\n        error_metric = abs(delta_J_fd - delta_J_adj) / denominator\n        \n        results.append(error_metric)\n\n    # 5. Output\n    # The problem asks for the floating point values in a list format\n    print(f\"[{','.join(f'{r:.15g}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}