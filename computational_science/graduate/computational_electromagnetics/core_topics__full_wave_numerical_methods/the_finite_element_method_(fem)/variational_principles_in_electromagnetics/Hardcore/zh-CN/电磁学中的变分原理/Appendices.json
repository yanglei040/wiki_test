{
    "hands_on_practices": [
        {
            "introduction": "在对麦克斯韦方程组进行数值离散化时，一个常见的陷阱是产生非物理的“伪解”。本练习将引导你从变分原理出发，通过在一个能量泛函中引入一个惩罚项来弱形式地施加高斯定律约束，从而巧妙地消除这些伪模式。这个实践将加深你对如何构建稳定且物理上正确的电磁学数值格式的理解。",
            "id": "3359367",
            "problem": "考虑一个单连通域中电场 $\\mathbf{E}$ 的无源时谐 Maxwell 本征问题。该域中的相对介电常数为 $\\epsilon(\\mathbf{x})$，相对磁导率为 $\\mu(\\mathbf{x})$，其中 $\\mu(\\mathbf{x})$ 严格为正且有界远离零。其连续形式旨在求解非平凡的电场 $\\mathbf{E}$ 和角频率 $\\omega$，使得旋度-旋度方程和 Gauss 定律在分布意义下成立：\n$$\n\\nabla \\times \\left(\\mu^{-1} \\nabla \\times \\mathbf{E}\\right) \\;=\\; \\omega^2 \\, \\epsilon \\, \\mathbf{E}, \n\\qquad\n\\nabla\\cdot\\left(\\epsilon \\, \\mathbf{E}\\right) \\;=\\; 0,\n$$\n并满足适当的边界条件。在 Hilbert 空间 $H(\\mathrm{curl})$ 中，物理上正确的本征模通过散度约束 $\\nabla\\cdot(\\epsilon \\mathbf{E})=0$ 来施加。然而，当使用不属于 $H(\\mathrm{curl})$ 空间的节点（标量）单元进行离散化时，伪旋度自由模会污染离散谱。\n\n您的任务是推导并计算研究一种源于变分原理的稳定化方法，该方法弱施加 Gauss 定律。随后，您必须实现一个自包含程序，该程序构建一个离散的周期性二维模型，组装稳定化算子，并对一个小规模测试套件分析该稳定化方法的谱影响。\n\n1) 出发点和推导目标：\n- 从约束变分表述出发：寻找一个非零电场 $\\mathbf{E}\\neq \\mathbf{0}$，使其在归一化条件下是场能量泛函的驻点，\n$$\n\\mathcal{J}[\\mathbf{E}] \\;=\\; \\int_{\\Omega} \\mu^{-1} \\, \\lVert \\nabla \\times \\mathbf{E} \\rVert^2 \\, \\mathrm{d}\\mathbf{x},\n\\quad \\text{约束条件为} \\quad \n\\int_{\\Omega} \\epsilon \\, \\lVert \\mathbf{E} \\rVert^2 \\, \\mathrm{d}\\mathbf{x} \\;=\\; 1\n\\quad \\text{且} \\quad \n\\nabla\\cdot(\\epsilon \\mathbf{E}) \\;=\\; 0.\n$$\n- 将 $\\nabla\\cdot(\\epsilon \\mathbf{E})=0$ 的强施加替换为一个带有标量稳定化参数 $\\alpha \\ge 0$ 的二次惩罚项，并从第一性原理出发，为增广泛函推导其 Euler–Lagrange 方程。您的推导必须从驻定作用量原理开始，并清晰地展示附加算子是如何从惩罚项中产生的。避免任何绕过变分法的假设；从泛函定义开始，通过取变分和分部积分来获得强形式。\n- 您的推导必须对空间变化的 $\\epsilon(\\mathbf{x})$ 和常数 $\\mu(\\mathbf{x})=\\mu_0$（为归一化可设 $\\mu_0=1$）保持通用性。将最终算子用分别作用于 $\\mathbf{E}$ 和 $\\epsilon \\mathbf{E}$ 的旋度算子和散度算子表示，并说明为何附加项会改变无旋子空间。\n\n2) 待实现的离散化模型：\n- 在二维空间中的周期性单位环面 $\\Omega = [0,1]^2$ 上进行计算，两个方向均采用周期性边界条件。采用二维模型，其中电场为平面内电场 $\\mathbf{E} = (E_x,E_y)$；对于旋度能量，在被积函数中使用平面外标量旋度 $\\left(\\nabla \\times \\mathbf{E}\\right)_z = \\partial_x E_y - \\partial_y E_x$ 及其平方。\n- 使用一个均匀的 $n \\times n$ 节点网格来离散化 $\\Omega$，网格间距为 $h = 1/n$，其中 $n$ 为正整数。在相同的网格点上用节点自由度来表示 $E_x$ 和 $E_y$（即，一个针对 $H(\\mathrm{curl})$ 的节点、非协调离散化）。\n- 对一阶导数使用中心周期性有限差分。在一维中，离散导数算子必须是一个循环矩阵，用模板系数 $(-\\tfrac{1}{2h}, 0, \\tfrac{1}{2h})$ 来近似 $\\partial/\\partial x$，并具有周期性环绕作用。在二维中，通过一维算子和单位矩阵的 Kronecker 积来构造 $\\partial_x$ 和 $\\partial_y$。令 $D_x$ 和 $D_y$ 表示这些作用于节点标量场的二维离散导数矩阵。\n- 定义离散标量旋度算子 $S$ 和离散散度算子 $D$ 如下：\n  - $S [E_x;E_y] = D_x E_y - D_y E_x$，\n  - $D [E_x;E_y] = D_x E_x + D_y E_y$，\n  其中，堆叠 $[E_x;E_y]$ 表示将 $E_x$ 和 $E_y$ 的节点值垂直串联成一个单一向量。\n- 在节点上定义节点介电常数数组 $\\epsilon$，并令 $E_\\epsilon$ 为块对角矩阵，其作用是将 $E_x$ 和 $E_y$ 在各节点上乘以 $\\epsilon$（即，其块形式为 $E_\\epsilon = \\mathrm{diag}(\\epsilon,\\epsilon)$）。\n- 组装以下离散化能量和质量的对称半正定矩阵：\n  - 旋度能量矩阵 $A_{\\mathrm{curl}} = S^\\top S \\, h^2$，\n  - 稳定化矩阵 $A_{\\mathrm{stab}}(\\alpha) = \\alpha \\, E_\\epsilon^\\top D^\\top D \\, E_\\epsilon \\, h^2$，\n  - 质量矩阵 $M = \\mathrm{diag}(\\epsilon,\\epsilon) \\, h^2$。\n- 待求解的广义稳定化本征问题是\n$$\n\\left(A_{\\mathrm{curl}} + A_{\\mathrm{stab}}(\\alpha)\\right) \\mathbf{u} \\;=\\; \\lambda \\, M \\, \\mathbf{u},\n$$\n其中，在所述归一化条件下，$\\lambda$ 近似于 $\\omega^2$。为稳健地计算谱，构建缩放后的对称矩阵 $K = M^{-1/2} \\left(A_{\\mathrm{curl}} + A_{\\mathrm{stab}}(\\alpha)\\right) M^{-1/2}$，并使用稠密对称本征求解器来获得所有本征值。\n\n3) 待报告的谱度量：\n- 设全套本征值按非递减顺序排序。定义一个小阈值 $\\tau$，将满足 $\\lambda  \\tau$ 的本征值 $\\lambda$ 计为数值上为零的本征值。\n- 对于下面的每个测试用例，计算：\n  - 严格小于 $\\tau$ 的本征值的整数数量 $c$，\n  - 最小严格正本征值 $\\lambda_{\\min}^+$，定义为满足 $\\lambda \\ge \\tau'$ 的最小本征值 $\\lambda$。其中 $\\tau'$ 是一个略大的阈值，满足 $\\tau' > \\tau$，以避免报告数值零点。如果不存在这样的本征值，则返回 $\\lambda_{\\min}^+ = 0.0$。\n\n4) 测试套件：\n使用以下三个测试用例，均在周期域上，每个方向均有 $n = 8$ 个节点（因此 $h = 1/8$），阈值为 $\\tau = 10^{-10}$ 和 $\\tau' = 10^{-8}$。\n- 用例 A（无稳定化，均匀介质）：$\\alpha = 0$，且对所有 $(x,y)$，$\\epsilon(x,y) \\equiv 1$。\n- 用例 B（稳定化，均匀介质）：$\\alpha = 1$，且对所有 $(x,y)$，$\\epsilon(x,y) \\equiv 1$。\n- 用例 C（稳定化，非均匀介质）：$\\alpha = 1$，且\n  $$\n  \\epsilon(x,y) \\;=\\; \\begin{cases}\n  2,  \\text{若 } x > 0.5,\\\\\n  1,  \\text{其他情况。}\n  \\end{cases}\n  $$\n  在节点坐标 $(x_i,y_j)$ 处计算 $\\epsilon$ 的值，其中 $x_i = (i+\\tfrac{1}{2})h$，$y_j = (j+\\tfrac{1}{2})h$，整数 $i,j \\in \\{0,1,\\dots,n-1\\}$，这样不连续性就与列之间的界面 $x=0.5$ 对齐。\n\n5) 要求的最终输出格式：\n- 您的程序应生成一行输出，其中包含一个用方括号括起来的逗号分隔列表。该列表必须按以下顺序包含六个值：\n  - $c_A$, $\\lambda_{\\min,A}^+$, $c_B$, $\\lambda_{\\min,B}^+$, $c_C$, $\\lambda_{\\min,C}^+$,\n  其中 $c_\\cdot$ 是整数，$\\lambda_{\\min,\\cdot}^+$ 是保留小数点后十位的小数。\n- 本问题不涉及角度。没有需要报告的物理单位；所有报告值均为无量纲。\n- 您的实现必须是一个完整的、可运行的程序，该程序精确地按规定构建矩阵，求解三个用例的本征问题，并以确切要求的格式打印汇总结果。",
            "solution": "该问题要求推导 Maxwell 本征问题的稳定化形式，并通过数值实现来研究稳定化的谱效应。核心问题在于，使用节点有限元或有限差分离散化时，会出现非物理的伪模，因为这些方法没有正确施加电场的无散度约束。\n\n### 1. 变分原理与稳定化\n\n在由相对介电常数 $\\epsilon(\\mathbf{x})$ 和磁导率 $\\mu(\\mathbf{x})$ 描述的介质中，无源时谐 Maxwell 方程组由以下公式给出：\n$$\n\\nabla \\times \\mathbf{H} = -i \\omega \\epsilon_0 \\epsilon \\mathbf{E}\n$$\n$$\n\\nabla \\times \\mathbf{E} = i \\omega \\mu_0 \\mu \\mathbf{H}\n$$\n$$\n\\nabla \\cdot (\\epsilon \\mathbf{E}) = 0\n$$\n$$\n\\nabla \\cdot (\\mu \\mathbf{H}) = 0\n$$\n结合两个旋度方程以消去磁场 $\\mathbf{H}$，并将自由空间常数 $\\epsilon_0, \\mu_0$ 设为1进行归一化，我们得到电场 $\\mathbf{E}$ 的旋度-旋度本征问题：\n$$\n\\nabla \\times \\left(\\mu^{-1} \\nabla \\times \\mathbf{E}\\right) = \\omega^2 \\epsilon \\mathbf{E}\n$$\n该方程必须在 Gauss 定律约束 $\\nabla \\cdot (\\epsilon \\mathbf{E}) = 0$ 下求解。该本征问题可以变分形式表述。本征值 $\\omega^2$ 对应于 Rayleigh 商的驻值，该商比较了磁场能量与电场能量。磁场能量正比于 $\\int \\mu^{-1} \\lVert \\nabla \\times \\mathbf{E} \\rVert^2 d\\mathbf{x}$，电场能量正比于 $\\int \\epsilon \\lVert \\mathbf{E} \\rVert^2 d\\mathbf{x}$。\n\n问题陈述我们应从一个约束变分问题开始。我们寻求泛函 $\\mathcal{J}[\\mathbf{E}] = \\int_{\\Omega} \\mu^{-1} \\lVert \\nabla \\times \\mathbf{E} \\rVert^2 d\\mathbf{x}$ 在约束条件 $\\int_{\\Omega} \\epsilon \\lVert \\mathbf{E} \\rVert^2 d\\mathbf{x} = 1$ 和 $\\nabla\\cdot(\\epsilon \\mathbf{E}) = 0$ 下的驻点。本征值 $\\omega^2$ 是归一化约束的 Lagrange 乘子。\n\n为了弱施加散度约束，我们在能量泛函中加入一个二次惩罚项。根据问题要求，我们设置 $\\mu(\\mathbf{x})=1$。本征值 $\\lambda = \\omega^2$ 的增广 Rayleigh 商为：\n$$\n\\lambda = \\frac{\\int_{\\Omega} \\left( \\lVert \\nabla \\times \\mathbf{E} \\rVert^2 + \\alpha \\lVert \\nabla \\cdot (\\epsilon \\mathbf{E}) \\rVert^2 \\right) d\\mathbf{x}}{\\int_{\\Omega} \\epsilon \\lVert \\mathbf{E} \\rVert^2 d\\mathbf{x}}\n$$\n其中 $\\alpha \\ge 0$ 是一个无量纲稳定化参数。为求得 Euler-Lagrange 方程，我们寻找使该商为驻值的场 $\\mathbf{E}$。这等价于寻找分子泛函（我们称之为 $\\mathcal{F}_{\\alpha}[\\mathbf{E}]$）在分母的归一化约束下的驻点。\n\n让我们求解 $\\mathcal{F}_{\\alpha}[\\mathbf{E}]$ 相对于一个微小扰动 $\\delta\\mathbf{E}$ 的变分，并使边界项消失（周期性边界条件满足此要求）。\n$$\n\\mathcal{F}_{\\alpha}[\\mathbf{E}] = \\int_{\\Omega} \\left( (\\nabla \\times \\mathbf{E}) \\cdot (\\nabla \\times \\mathbf{E}) + \\alpha (\\nabla \\cdot (\\epsilon \\mathbf{E}))^2 \\right) d\\mathbf{x}\n$$\n变分 $\\delta \\mathcal{F}_{\\alpha}$ 有两部分：\n1.  旋度项的变分：\n    $\\delta \\int (\\nabla \\times \\mathbf{E}) \\cdot (\\nabla \\times \\mathbf{E}) \\,d\\mathbf{x} = 2 \\int (\\nabla \\times \\mathbf{E}) \\cdot (\\nabla \\times \\delta\\mathbf{E}) \\,d\\mathbf{x}$。\n    使用向量恒等式 $(\\nabla \\times \\mathbf{A}) \\cdot \\mathbf{B} = (\\nabla \\times \\mathbf{B}) \\cdot \\mathbf{A} - \\nabla \\cdot (\\mathbf{A} \\times \\mathbf{B})$ 和分部积分（散度定理），上式变为：\n    $2 \\int (\\nabla \\times (\\nabla \\times \\mathbf{E})) \\cdot \\delta\\mathbf{E} \\,d\\mathbf{x}$。\n\n2.  惩罚项的变分：\n    $\\delta \\int \\alpha (\\nabla \\cdot (\\epsilon \\mathbf{E}))^2 \\,d\\mathbf{x} = 2 \\alpha \\int (\\nabla \\cdot (\\epsilon \\mathbf{E})) (\\nabla \\cdot (\\epsilon \\delta\\mathbf{E})) \\,d\\mathbf{x}$。\n    令 $f = \\nabla \\cdot (\\epsilon \\mathbf{E})$。使用恒等式 $\\nabla \\cdot (g \\mathbf{F}) = g(\\nabla \\cdot \\mathbf{F}) + (\\nabla g) \\cdot \\mathbf{F}$ 和分部积分：\n    $2 \\alpha \\int f (\\nabla \\cdot (\\epsilon \\delta\\mathbf{E})) \\,d\\mathbf{x} = 2 \\alpha \\int \\left( \\nabla \\cdot (f \\epsilon \\delta\\mathbf{E}) - (\\nabla f) \\cdot (\\epsilon \\delta\\mathbf{E}) \\right) d\\mathbf{x} = -2\\alpha \\int \\epsilon (\\nabla (\\nabla \\cdot (\\epsilon \\mathbf{E}))) \\cdot \\delta\\mathbf{E} \\,d\\mathbf{x}$。\n\n结合这些项，分子的总变分为：\n$$\n\\delta \\mathcal{F}_{\\alpha}[\\mathbf{E}] = \\int 2 \\left( \\nabla \\times (\\nabla \\times \\mathbf{E}) - \\alpha \\epsilon \\nabla(\\nabla \\cdot (\\epsilon \\mathbf{E})) \\right) \\cdot \\delta\\mathbf{E} \\,d\\mathbf{x}\n$$\n分母的变分为 $\\delta \\int \\epsilon \\lVert \\mathbf{E} \\rVert^2 d\\mathbf{x} = \\int 2 \\epsilon \\mathbf{E} \\cdot \\delta\\mathbf{E} \\,d\\mathbf{x}$。\n驻值条件 $\\delta(\\lambda)=0$ 导出了 Euler-Lagrange 方程的弱形式。对于任意测试函数 $\\mathbf{V}$，我们有：\n$$\n\\int \\left( \\left( \\nabla \\times \\mathbf{E} \\right) \\cdot (\\nabla \\times \\mathbf{V}) + \\alpha \\left( \\nabla \\cdot (\\epsilon \\mathbf{E}) \\right) (\\nabla \\cdot (\\epsilon \\mathbf{V})) \\right) d\\mathbf{x} = \\lambda \\int \\epsilon \\mathbf{E} \\cdot \\mathbf{V} \\, d\\mathbf{x}\n$$\nEuler-Lagrange 方程的强形式是通过要求相对于 $\\delta\\mathbf{E}$ 的变分的被积函数为零得到的，这给出了：\n$$\n\\nabla \\times (\\nabla \\times \\mathbf{E}) - \\alpha \\epsilon \\nabla(\\nabla \\cdot (\\epsilon \\mathbf{E})) = \\lambda \\epsilon \\mathbf{E}\n$$\n附加项 $-\\alpha \\epsilon \\nabla(\\nabla \\cdot (\\epsilon \\mathbf{E}))$ 即为稳定化算子。其目的是惩罚具有非零散度的场。在非稳定化情况（$\\alpha=0$）下，任何无旋（旋度自由）场 $\\mathbf{E}_{\\mathrm{irr}} = \\nabla \\phi$ 都是对应于本征值 $\\lambda=0$ 的本征向量，因为 $\\nabla \\times (\\nabla \\phi) = \\mathbf{0}$。节点离散化支持大量此类伪零本征值模，它们会污染物理谱。\n\n当 $\\alpha > 0$ 时，稳定化算子作用于这些模。对于一个无旋场 $\\mathbf{E}_{\\mathrm{irr}} = \\nabla \\phi$，本征问题变为：\n$$\n-\\alpha \\epsilon \\nabla(\\nabla \\cdot (\\epsilon \\nabla\\phi)) = \\lambda \\epsilon \\nabla\\phi\n$$\n这是一个非平凡方程，通常意味着对于非零场，$\\lambda > 0$。因此，惩罚项将伪模的本征值从零“提升”到正值，从而有效地将它们与谱的物理上有意义的部分分离开来。\n\n### 2. 离散化与数值模型\n\n我们在二维周期性单位环面 $\\Omega = [0,1]^2$ 上实现有限差分离散化。网格是均匀的，有 $n \\times n$ 个节点，间距为 $h=1/n$。电场为 $\\mathbf{E}=(E_x, E_y)$。$E_x$ 和 $E_y$ 的节点值由长度为 $N = n^2$ 的向量 $\\mathbf{u}_x$ 和 $\\mathbf{u}_y$ 表示。完整的状态向量是 $\\mathbf{u} = [\\mathbf{u}_x; \\mathbf{u}_y]$，一个长度为 $2N$ 的列向量。\n\n一阶偏导数 $\\partial_x$ 和 $\\partial_y$ 由矩阵 $D_x$ 和 $D_y$ 近似，这些矩阵是使用周期性网格上的中心有限差分构建的。在 $n$ 点网格上的一维导数矩阵 $d_{1D}$ 是一个循环矩阵，其模板为 $(1/2h, 0, -1/2h)$ 并为周期性进行了修改。二维算子使用 Kronecker 积构建。采用行主序对网格点 $(x_j, y_i)$ 进行排序，其中 $i,j \\in \\{0, \\dots, n-1\\}$，离散导数为 $D_x = I_n \\otimes d_{1D}$ 和 $D_y = d_{1D} \\otimes I_n$。\n\n作用于状态向量 $\\mathbf{u}$ 的离散标量旋度和散度算子定义为块矩阵：\n- 离散标量旋度：$S = [-D_y, D_x]$，使得 $S\\mathbf{u}$ 近似于 $\\partial_x E_y - \\partial_y E_x$。\n- 离散散度：$D = [D_x, D_y]$，使得 $D\\mathbf{u}$ 近似于 $\\partial_x E_x + \\partial_y E_y$。\n\n在每个节点上计算介电常数 $\\epsilon(x,y)$，形成一个长度为 $N$ 的向量 $\\boldsymbol{\\epsilon}$。按节点乘以 $\\epsilon$ 的操作由对角矩阵 $E_{\\epsilon} = \\mathrm{diag}(\\boldsymbol{\\epsilon}, \\boldsymbol{\\epsilon})$ 表示。\n\n在此框架下，离散化稳定化本征问题的弱形式会得到一个广义矩阵本征值问题。积分变为在网格单元上的求和，并按单元面积 $h^2$ 进行缩放。\n- 旋度项 $\\int (\\nabla \\times \\mathbf{E}) \\cdot (\\nabla \\times \\mathbf{V}) d\\mathbf{x}$ 变为 $\\mathbf{v}^\\top (S^\\top S h^2) \\mathbf{u}$。因此，$A_{\\mathrm{curl}} = S^\\top S h^2$。\n- 稳定化项 $\\int \\alpha (\\nabla \\cdot \\epsilon \\mathbf{E})(\\nabla \\cdot \\epsilon \\mathbf{V})d\\mathbf{x}$ 变为 $\\mathbf{v}^\\top (\\alpha E_{\\epsilon}^\\top D^\\top D E_{\\epsilon} h^2) \\mathbf{u}$。因此，$A_{\\mathrm{stab}}(\\alpha) = \\alpha E_{\\epsilon}^\\top D^\\top D E_{\\epsilon} h^2$。\n- 质量项 $\\int \\epsilon \\mathbf{E} \\cdot \\mathbf{V} d\\mathbf{x}$ 变为 $\\mathbf{v}^\\top (\\mathrm{diag}(\\boldsymbol{\\epsilon}, \\boldsymbol{\\epsilon}) h^2) \\mathbf{u}$。我们定义质量矩阵 $M = \\mathrm{diag}(\\boldsymbol{\\epsilon}, \\boldsymbol{\\epsilon}) h^2$。\n\n得到的广义对称本征值问题是：\n$$\n(A_{\\mathrm{curl}} + A_{\\mathrm{stab}}(\\alpha)) \\mathbf{u} = \\lambda M \\mathbf{u}\n$$\n为了数值求解，我们将其转换为一个标准对称本征值问题。由于 $M$ 是对角且正定的，我们可以计算其逆平方根 $M^{-1/2}$ 并构造矩阵 $K = M^{-1/2} (A_{\\mathrm{curl}} + A_{\\mathrm{stab}}(\\alpha)) M^{-1/2}$。标准本征问题 $K\\mathbf{w} = \\lambda \\mathbf{w}$ 产生相同的本征值 $\\lambda$，而原始本征向量可以通过 $\\mathbf{u} = M^{-1/2}\\mathbf{w}$ 恢复。\n\n### 3. 谱分析\n\n通过计算三个测试用例的谱来分析稳定化的效果。我们计算数值上为零（即小于小阈值 $\\tau = 10^{-10}$）的本征值数量 $c$，并找到最小严格正本征值 $\\lambda_{\\min}^+$，定义为大于或等于阈值 $\\tau' = 10^{-8}$ 的最小本征值。\n\n- **用例 A ($\\alpha=0$，均匀 $\\epsilon=1$)**：无稳定化时，算子为 $A_{\\mathrm{curl}}$，其零空间由所有离散无旋场组成。这个空间很大，我们预计会有大量的零本征值，计数为 $c_A$，代表伪模。\n- **用例 B ($\\alpha=1$，均匀 $\\epsilon=1$)**：有稳定化时，算子会惩罚散度。零空间中仅存的模是那些既无旋又无散度的模。在二维环面上，这是两个常数向量场，因此我们预计 $c_B=2$。\n- **用例 C ($\\alpha=1$，非均匀 $\\epsilon$)**：稳定化项惩罚 $\\nabla \\cdot (\\epsilon \\mathbf{E})$。一个沿 y 方向的常数向量场 $\\mathbf{E}=(0, C)$ 保持无旋，并且满足 $\\nabla\\cdot(\\epsilon \\mathbf{E}) = \\partial_y (C \\epsilon) = 0$，因为 $\\epsilon$ 只随 $x$ 变化。一个沿 x 方向的常数场 $\\mathbf{E}=(C, 0)$ 会得到 $\\nabla\\cdot(\\epsilon \\mathbf{E}) = \\partial_x (C \\epsilon) \\neq 0$，因此会受到惩罚。我们预计 $c_C=1$。\n\n最小正本征值 $\\lambda_{\\min}^+$ 代表了离散化系统的最低频率物理模。通过移除零点附近的伪模干扰，稳定化使得 $\\lambda_{\\min}^+$ 更容易被准确地识别和计算。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Derives and computationally studies a stabilized formulation for the 2D Maxwell eigenproblem\n    on a periodic domain, discretized with finite differences.\n    \"\"\"\n\n    # --- Problem Parameters ---\n    n = 8\n    h = 1.0 / n\n    tau = 1e-10\n    tau_prime = 1e-8\n    \n    # --- Test Case Definitions ---\n    # Case A: No stabilization, uniform medium\n    # Case B: Stabilization, uniform medium\n    # Case C: Stabilization, heterogeneous medium\n    test_cases = [\n        {'alpha': 0.0, 'eps_func': lambda x, y: 1.0},\n        {'alpha': 1.0, 'eps_func': lambda x, y: 1.0},\n        {'alpha': 1.0, 'eps_func': lambda x, y: 2.0 if x > 0.5 else 1.0}\n    ]\n    \n    results = []\n\n    # --- Construct 1D and 2D Derivative Operators ---\n    N = n * n\n    \n    # 1D centered derivative matrix with periodic BCs\n    d1 = np.zeros((n, n))\n    for i in range(n):\n        d1[i, (i + 1) % n] = 1.0 / (2 * h)\n        d1[i, (i - 1 + n) % n] = -1.0 / (2 * h)\n\n    # 2D derivative matrices via Kronecker products (for row-major mapping)\n    # Dx acts along columns (changes j in (i,j)), Dy acts along rows (changes i)\n    I_n = np.identity(n)\n    Dx = np.kron(I_n, d1)\n    Dy = np.kron(d1, I_n)\n    \n    # --- Discrete curl and divergence operators ---\n    # S: R^(2N) -> R^N, D: R^(2N) -> R^N\n    # u = [u_x; u_y]\n    # S maps [Ex; Ey] to (dx Ey - dy Ex)\n    # D maps [Ex; Ey] to (dx Ex + dy Ey)\n    S = np.block([[-Dy, Dx]])\n    D = np.block([[Dx, Dy]])\n\n    for case in test_cases:\n        alpha = case['alpha']\n        eps_func = case['eps_func']\n\n        # --- Construct Permittivity Vector ---\n        # Grid coordinates are cell-centered as specified for Case C\n        x_coords = (np.arange(n) + 0.5) * h\n        y_coords = (np.arange(n) + 0.5) * h\n        xx, yy = np.meshgrid(x_coords, y_coords)\n        \n        eps_grid = np.zeros_like(xx)\n        for i in range(n):\n            for j in range(n):\n                eps_grid[i, j] = eps_func(xx[i, j], yy[i, j])\n\n        # Flatten in row-major order\n        eps_vec = eps_grid.flatten()\n        \n        # --- Assemble System Matrices ---\n        # A_curl: curl energy matrix, (2N, 2N)\n        A_curl = S.T @ S * (h**2)\n        \n        # E_eps: Nodal permittivity matrix, (2N, 2N)\n        eps_full_vec = np.concatenate([eps_vec, eps_vec])\n        E_eps_mat = np.diag(eps_full_vec)\n        \n        # A_stab: stabilization matrix, (2N, 2N)\n        A_stab = alpha * (E_eps_mat.T @ D.T @ D @ E_eps_mat) * (h**2)\n        \n        # M: Mass matrix, (2N, 2N)\n        M = np.diag(eps_full_vec) * (h**2)\n\n        # --- Solve the Generalized Eigenproblem ---\n        # A_total u = lambda M u\n        # Transform to standard form: K w = lambda w, where K is symmetric\n        A_total = A_curl + A_stab\n        \n        diag_M = np.diag(M)\n        # Add a small epsilon to avoid division by zero if any epsilon is zero\n        # although problem constraints imply epsilon is positive.\n        M_inv_sqrt = np.diag(1.0 / np.sqrt(diag_M + 1e-20))\n        \n        K = M_inv_sqrt @ A_total @ M_inv_sqrt\n        \n        # Use eigh for symmetric matrices; it returns sorted eigenvalues\n        eigenvalues = np.linalg.eigh(K)[0]\n        \n        # --- Compute Spectral Metrics ---\n        # Count of numerically zero eigenvalues\n        c = np.sum(eigenvalues  tau)\n        \n        # Smallest strictly positive eigenvalue\n        positive_eigs = eigenvalues[eigenvalues >= tau_prime]\n        lambda_min_plus = positive_eigs.min() if len(positive_eigs) > 0 else 0.0\n        \n        results.extend([c, lambda_min_plus])\n\n    # --- Format and Print Final Output ---\n    output_str = \",\".join(\n        [f\"{x:.10f}\" if isinstance(x, float) else str(x) for x in results]\n    )\n    print(f\"[{output_str}]\")\n\nsolve()\n\n```"
        },
        {
            "introduction": "开放或有损耗的电磁谐振器的特性可以通过复数本征值问题来描述，其中本征值的虚部代表了能量的辐射或吸收损耗。本练习应用了变分原理中的瑞利商方法，并结合完美匹配层（PML）技术，来计算谐振腔的复数谐振频率。你将从中学会如何将一个物理问题转化为一个变分本征值问题，并从中提取出像品质因数 $Q$ 這樣的關鍵工程參數。",
            "id": "3359395",
            "problem": "考虑在一维设置下横电（TE）偏振的时谐麦克斯韦方程组，其中电场标量振幅 $E(x)$ 满足一个从分层介质中的旋度-旋度算子导出的亥姆霍兹型方程。设计算域为区间 $[0,L]$，其内部包含一个物理子域，该子域含有一块相对介电常数为 $\\varepsilon_r(x)$ 的介质板和两个通过完美匹配层（PML）实现的外部吸收层。PML通过一个复坐标拉伸因子 $s(x)$ 实现，该因子在物理区域内为 $1$，在靠近边界的PML区域内等于 $1 + i\\alpha$。假设磁导率 $\\mu(x) = \\mu_0$ 是均匀的，电容率 $\\varepsilon(x) = \\varepsilon_0 \\varepsilon_r(x)$，其中 $\\varepsilon_0$ 是真空介电常数，$\\mu_0$ 是真空磁导率。\n\n从时谐麦克斯韦方程组和电场的弱（变分）形式出发，考虑以下双线性形式\n$$\na(E,F) = \\int_{0}^{L} \\frac{1}{\\mu_0} \\frac{1}{s(x)} \\frac{dE}{dx}(x) \\frac{dF}{dx}(x)\\,dx,\n\\qquad\nm(E,F) = \\int_{0}^{L} \\varepsilon_0\\,\\varepsilon_r(x)\\,s(x)\\,E(x)\\,F(x)\\,dx,\n$$\n并定义复值瑞利商\n$$\n\\lambda(E) = \\frac{a(E,E)}{m(E,E)}.\n$$\n此商在满足齐次狄利克雷边界条件 $E(0)=E(L)=0$ 的PML增强算子的本征函数处取值，近似于与散射共振相关的复本征值。该本征值可解释为 $\\lambda \\approx \\omega^2$，其中 $\\omega$ 是一个复角频率，其虚部代表辐射和吸收损耗。\n\n你的任务是：\n1. 严格地从上述变分设置和时谐麦克斯韦方程组出发，阐述为什么瑞利商的驻值对应于算子对 $(a(\\cdot,\\cdot), m(\\cdot,\\cdot))$ 的广义本征值，并说明当存在完美匹配层（PML）时，它们的复数性质是如何产生的。不要假设任何非由基本定律所蕴含的预先推导出的公式。\n2. 从电磁学中阻尼振荡的能量衰减第一性原理出发，解释一个复角频率 $ \\omega = \\omega_{\\mathrm{r}} + i \\omega_{\\mathrm{i}} $（其中 $ \\omega_{\\mathrm{i}}  0 $）如何导出一个可以从变分本征值计算出的无量纲品质因数 $Q$。该关系必须被推导出来，而非直接假定。\n3. 实现一个完整的程序，该程序使用二阶有限差分格式在具有 $N$ 个点的均匀网格上离散化一维弱形式。对刚度贡献使用中点通量，并使用对角（集总）质量近似。构建广义本征问题\n$$\n\\mathbf{K}\\,\\mathbf{v} = \\lambda\\,\\mathbf{M}\\,\\mathbf{v},\n$$\n其中 $\\mathbf{K}$ 和 $\\mathbf{M}$ 分别是 $a(\\cdot,\\cdot)$ 和 $m(\\cdot,\\cdot)$ 的离散模拟，$\\mathbf{v}$ 是在施加齐次狄利克雷边界条件下的内部自由度的本征向量。\n4. 计算复谱 $\\{\\lambda_j\\}$，通过 $\\omega_j = \\sqrt{\\lambda_j}$ 使用复主平方根将每个本征值映射到其复角频率 $\\omega_j$。对于每个测试案例，在虚部 $\\omega_{\\mathrm{i}}  0$ 的模式中，选择具有最小正实部 $\\omega_{\\mathrm{r}} > 0$ 的模式作为基共振模式。根据你在第2项中的推导，从此选定模式计算品质因数 $Q$。\n\n物理常数必须使用 $\\varepsilon_0 = 8.854187817 \\times 10^{-12}$ 法拉/米 和 $\\mu_0 = 4\\pi \\times 10^{-7}$ 亨利/米。所有长度必须以米表示。最终报告的量 $Q$ 是无量纲的。在复指数分析中涉及的角度，必须以弧度为单位。\n\n离散化细节：\n- 使用一个包含 $N$ 个节点的均匀网格，间距为 $h = L/(N-1)$，内部未知量索引为 $i=1,\\dots,N-2$，并强制 $E(0)=E(L)=0$。\n- 在物理区域定义 $s(x)=1$，在PML层 $[0,t_{\\mathrm{pml}}]$ 和 $[L-t_{\\mathrm{pml}},L]$ 中定义 $s(x)=1+i\\alpha$。\n- 在区间 $[x_0-d/2,x_0+d/2]$ 中定义板的介电常数为 $\\varepsilon_r(x) = \\varepsilon_{\\mathrm{slab}}$，在其他地方定义为 $\\varepsilon_r(x)=1$；允许 $\\varepsilon_{\\mathrm{slab}}$ 为复数以模拟材料损耗。\n- 离散刚度使用 $c(x) = \\frac{1}{\\mu_0}\\frac{1}{s(x)}$，中点值 $c_{i+1/2} = \\frac{1}{2}\\left(c_i + c_{i+1}\\right)$，以及标准三点模板\n$$\nK_{ii} = \\frac{c_{i+1/2} + c_{i-1/2}}{h^2},\\quad\nK_{i,i+1} = -\\frac{c_{i+1/2}}{h^2},\\quad\nK_{i,i-1} = -\\frac{c_{i-1/2}}{h^2}.\n$$\n- 离散质量在对角线上集总为\n$$\nM_{ii} = \\varepsilon_0\\,\\varepsilon_r(x_i)\\,s(x_i)\\,h.\n$$\n\n测试套件：\n在你的程序中提供并使用以下三组参数来计算三个品质因数 $Q$：\n- 案例 A (基准谐振器，良好吸收的PML): $L=1.0$, $N=200$, $x_0=0.5$, $d=0.4$, $\\varepsilon_{\\mathrm{slab}}=4.0$, $t_{\\mathrm{pml}}=0.2$, $\\alpha=1.0$。\n- 案例 B (基准谐振器，弱PML): $L=1.0$, $N=180$, $x_0=0.5$, $d=0.4$, $\\varepsilon_{\\mathrm{slab}}=4.0$, $t_{\\mathrm{pml}}=0.2$, $\\alpha=0.2$。\n- 案例 C (有损介质板，良好吸收的PML): $L=1.0$, $N=200$, $x_0=0.5$, $d=0.4$, $\\varepsilon_{\\mathrm{slab}}=4.0 - 0.5 i$, $t_{\\mathrm{pml}}=0.2$, $\\alpha=1.0$。\n\n实现与输出规范：\n- 你的程序必须为每个案例构建 $\\mathbf{K}$ 和 $\\mathbf{M}$，求解广义本征问题，根据上述规则选择基共振，并计算相应的 $Q$。\n- 如果找不到合适的共振（即没有本征值满足 $\\omega_{\\mathrm{r}}>0$ 和 $\\omega_{\\mathrm{i}}0$），则对该案例输出一个非数值（Not-a-Number）。\n- 你的程序应生成单行输出，其中包含用方括号括起来的逗号分隔的结果列表（例如，“$[Q_A,Q_B,Q_C]$”）。\n- 所有计算都必须使用双精度复数算术进行。\n\n你的最终答案必须是一个完整的、可运行的程序，它能执行这些计算而无需任何用户输入或外部文件，并以指定格式打印最终结果。",
            "solution": "该问题已经过验证，被认为是适定的、科学上合理的且内部一致的。它提出了一个电磁学中的标准计算任务，涉及计算带完美匹配层（PML）的一维腔体中的共振模式。理论推导和数值实现步骤都得到了清晰的概述，并基于既定原则。因此，我们可以着手提供一个完整的解决方案。\n\n根据要求，解决方案分两部分呈现：首先，对变分原理和品质因数推导的理论讨论；其次，数值实现。\n\n### 1. 变分本征问题与复本征值\n\n问题的核心在于寻找开放电磁结构的共振模式。这些模式是在没有任何外部源的情况下，满足边界条件的时谐麦克斯韦方程组的解。在一维横电（TE）情况下，电场为 $\\mathbf{E} = E(x)\\hat{\\mathbf{y}}$，无源区域中的麦克斯韦方程组简化为亥姆霍兹方程。使用复坐标拉伸 $s(x)$ 来模拟PML，其控制方程为：\n$$\n-\\frac{d}{dx}\\left(\\frac{1}{\\mu_0 s(x)}\\frac{dE}{dx}\\right) = \\omega^2 \\varepsilon_0 \\varepsilon_r(x) s(x) E(x)\n$$\n其中 $\\omega$ 是角频率。解 $E(x)$ 是共振模式，对应的 $\\omega$ 值是复共振频率。给定齐次狄利克雷边界条件 $E(0)=E(L)=0$。\n\n为了找到解，我们使用弱（变分）形式。将方程乘以一个测试函数 $F(x)$（该函数与 $E(x)$ 属于同一函数空间，并满足相同的边界条件），然后在域 $[0,L]$ 上积分，得到：\n$$\n-\\int_0^L F(x) \\frac{d}{dx}\\left(\\frac{1}{\\mu_0 s(x)}\\frac{dE}{dx}\\right) dx = \\omega^2 \\int_0^L F(x) \\varepsilon_0 \\varepsilon_r(x) s(x) E(x) dx\n$$\n对左侧应用分部积分：\n$$\n\\int_0^L \\frac{dF}{dx} \\frac{1}{\\mu_0 s(x)} \\frac{dE}{dx} dx - \\left[ F(x) \\frac{1}{\\mu_0 s(x)} \\frac{dE}{dx} \\right]_0^L = \\omega^2 \\int_0^L F(x) \\varepsilon_0 \\varepsilon_r(x) s(x) E(x) dx\n$$\n由于测试函数 $F(x)$ 必须满足相同的齐次狄利克雷边界条件，即 $F(0)=F(L)=0$，边界项消失。这给出了本征问题的弱形式：寻找 $E(x)$，使得对于所有有效的测试函数 $F(x)$，\n$$\n\\int_0^L \\frac{1}{\\mu_0 s(x)} \\frac{dE}{dx}\\frac{dF}{dx} dx - \\omega^2 \\int_0^L \\varepsilon_0 \\varepsilon_r(x) s(x) E(x) F(x) dx = 0\n$$\n通过定义双线性形式\n$$\na(E,F) = \\int_{0}^{L} \\frac{1}{\\mu_0 s(x)} \\frac{dE}{dx} \\frac{dF}{dx}\\,dx, \\qquad m(E,F) = \\int_{0}^{L} \\varepsilon_0\\,\\varepsilon_r(x)\\,s(x)\\,E(x)\\,F(x)\\,dx\n$$\n和本征值 $\\lambda = \\omega^2$，弱形式变为：\n$$\na(E,F) - \\lambda m(E,F) = 0\n$$\n这就是其连续变分形式的广义本征值问题。\n\n瑞利商定义为 $\\lambda(E) = \\frac{a(E,E)}{m(E,E)}$。该商的驻值对应于系统的本征值。为了证明这一点，我们寻找使 $\\lambda(E)$ 的变分为零（即 $\\delta\\lambda=0$）的函数 $E(x)$。相对于扰动 $\\delta E$ 的变分为：\n$$\n\\delta\\lambda = \\frac{\\delta a(E,E) m(E,E) - a(E,E) \\delta m(E,E)}{[m(E,E)]^2} = 0\n$$\n这要求 $\\delta a(E,E) = \\frac{a(E,E)}{m(E,E)} \\delta m(E,E) = \\lambda(E) \\delta m(E,E)$。对于给定的对称双线性形式，一阶变分为 $\\delta a(E,E) = 2a(E,\\delta E)$ 和 $\\delta m(E,E) = 2m(E,\\delta E)$。代入这些可得：\n$$\n2a(E,\\delta E) = \\lambda(E) \\cdot 2m(E,\\delta E) \\implies a(E,\\delta E) - \\lambda(E) m(E,\\delta E) = 0\n$$\n此方程必须对任何任意的容许扰动 $\\delta E$ 都成立。这恰好是本征问题的弱形式，其中 $\\delta E$ 扮演了测试函数 $F$ 的角色。因此，使瑞利商取驻值的函数 $E$ 是算子对 $(a, m)$ 的本征函数，而驻值则是相应的本征值 $\\lambda$。\n\n本征值的复数性质源于材料属性是复数。在此问题中，PML在吸收层中引入了复坐标拉伸因子 $s(x) = 1 + i\\alpha$（其中 $\\alpha>0$）。这使得 $a(E,F)$ 和 $m(E,F)$ 中的被积函数都变为复值。因此，它们所代表的算子是非厄米（non-Hermitian）的（具体来说，是复对称的）。非厄米算子通常具有复本征值。复本征值 $\\lambda = \\omega^2$ 的物理解释是一个复共振频率 $\\omega$，它表示一个由于能量损失而随时间衰减的模式。PML被设计用来通过吸收出射波来模拟开放的无限空间，因此代表了辐射损耗。如果介电常数 $\\varepsilon_r(x)$ 也是复数，其虚部则代表材料吸收损耗。\n\n### 2. 品质因数 $Q$ 的推导\n\n谐振器的品质因数（或称 $Q$ 值）量化了其存储能量与能量损失速率的比值。对于一个具有复角频率 $\\omega = \\omega_r + i\\omega_i$ 的电磁共振，场的时域演化遵循 $e^{-i\\omega t}$。问题指出，一个物理上有意义的共振具有 $\\omega_r > 0$ 和 $\\omega_i  0$。随时间变化的场由 $\\mathcal{E}(x,t) = \\text{Re}\\{E(x)e^{-i\\omega t}\\}$ 给出，其中 $E(x)$ 是复本征函数。\n场的时变部分为：\n$$\ne^{-i\\omega t} = e^{-i(\\omega_r + i\\omega_i)t} = e^{-i\\omega_r t}e^{\\omega_i t}\n$$\n存储在共振模式中的总能量 $U(t)$ 与场振幅的平方成正比。其时域演化遵循场平方的包络：\n$$\nU(t) \\propto |e^{-i\\omega t}|^2 = |e^{-i\\omega_r t}e^{\\omega_i t}|^2 = e^{2\\omega_i t}\n$$\n因此，我们可以将存储的能量写为 $U(t) = U_0 e^{2\\omega_i t}$，其中 $U_0$ 是 $t=0$ 时的能量。由于 $\\omega_i  0$，能量呈指数衰减，这与有损耗系统的预期一致。\n\n耗散功率 $P_{\\text{loss}}(t)$ 是存储能量的减少率：\n$$\nP_{\\text{loss}}(t) = -\\frac{dU(t)}{dt} = -\\frac{d}{dt}(U_0 e^{2\\omega_i t}) = -2\\omega_i U_0 e^{2\\omega_i t} = -2\\omega_i U(t)\n$$\n品质因数的一个标准定义是谐振频率乘以存储能量与损耗功率之比：\n$$\nQ = \\omega_r \\frac{\\text{Energy Stored}}{\\text{Power Loss}}\n$$\n使用上面推导的表达式：\n$$\nQ = \\omega_r \\frac{U(t)}{P_{\\text{loss}}(t)} = \\omega_r \\frac{U(t)}{-2\\omega_i U(t)} = -\\frac{\\omega_r}{2\\omega_i}\n$$\n这个公式直接将无量纲品质因数 $Q$ 与复共振频率 $\\omega$ 的实部和虚部联系起来。由于 $\\omega_r > 0$ 且 $\\omega_i  0$，$Q$ 是一个正实数，这与其物理意义一致。\n\n### 3. 数值离散化与实现\n\n连续问题 $a(E,F) = \\lambda m(E,F)$ 通过有限差分法在具有 $N$ 个点且间距为 $h=L/(N-1)$ 的均匀网格上进行离散化。边界处的场值由 $E(x_0)=E(x_{N-1})=0$ 固定。我们求解 $N-2$ 个内部场值，$\\mathbf{v} = [E(x_1), \\dots, E(x_{N-2})]^T$。这导出一个矩阵广义本征值问题 $\\mathbf{K}\\mathbf{v} = \\lambda\\mathbf{M}\\mathbf{v}$。\n\n矩阵 $\\mathbf{K}$ 和 $\\mathbf{M}$ 是双线性形式 $a(\\cdot,\\cdot)$ 和 $m(\\cdot,\\cdot)$ 的离散表示。刚度矩阵 $\\mathbf{K}$ 离散了项 $\\int \\frac{1}{\\mu_0 s(x)} |E'|^2 dx$。使用给定的二阶中心差分格式，并对系数 $c(x) = \\frac{1}{\\mu_0 s(x)}$ 进行中点平均，我们得到一个大小为 $(N-2) \\times (N-2)$ 的三对角复对称矩阵 $\\mathbf{K}$。其第 $j$ 行（对应于网格点 $x_{j+1}$）的非零元素为：\n$$\nK_{j,j-1} = -\\frac{c_{j+1/2}}{h^2}, \\quad K_{j,j} = \\frac{c_{j+1/2} + c_{j-1/2}}{h^2}, \\quad K_{j,j+1} = -\\frac{c_{j+1/2}}{h^2}\n$$\n其中 $c_{i+1/2} = \\frac{1}{2}(c(x_i) + c(x_{i+1}))$。\n\n质量矩阵 $\\mathbf{M}$ 离散了项 $\\int \\varepsilon_0 \\varepsilon_r(x) s(x) |E|^2 dx$。使用指定的集总质量近似，我们得到一个大小为 $(N-2) \\times (N-2)$ 的对角矩阵 $\\mathbf{M}$，其元素为：\n$$\nM_{j,j} = \\varepsilon_0 \\varepsilon_r(x_{j+1}) s(x_{j+1}) h\n$$\n构建 $\\mathbf{K}$ 和 $\\mathbf{M}$ 后，数值求解广义本征值问题。得到的本征值 $\\lambda_j$ 用于计算复频率 $\\omega_j = \\sqrt{\\lambda_j}$（使用主平方根）。在所有虚部 $\\omega_i  0$ 的模式中，将具有最小正实部 $\\omega_r$ 的模式识别为基共振模式。最后，使用推导出的公式 $Q = -\\omega_r/(2\\omega_i)$ 计算品质因数 $Q$。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import eig\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for all test cases and print the results.\n    \"\"\"\n    # Physical constants\n    EPS0 = 8.854187817e-12  # Vacuum permittivity in F/m\n    MU0 = 4 * np.pi * 1e-7   # Vacuum permeability in H/m\n\n    # Test suite parameters\n    test_cases = [\n        # Case A (baseline resonator, well-absorbing PML)\n        {'L': 1.0, 'N': 200, 'x0': 0.5, 'd': 0.4, 'eps_slab': 4.0, 't_pml': 0.2, 'alpha': 1.0},\n        # Case B (baseline resonator, weak PML)\n        {'L': 1.0, 'N': 180, 'x0': 0.5, 'd': 0.4, 'eps_slab': 4.0, 't_pml': 0.2, 'alpha': 0.2},\n        # Case C (lossy slab, well-absorbing PML)\n        {'L': 1.0, 'N': 200, 'x0': 0.5, 'd': 0.4, 'eps_slab': 4.0 - 0.5j, 't_pml': 0.2, 'alpha': 1.0}\n    ]\n\n    results = []\n    for params in test_cases:\n        q_factor = calculate_q_factor(params, EPS0, MU0)\n        results.append(q_factor)\n\n    # Format and print the final output\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef calculate_q_factor(params, eps0, mu0):\n    \"\"\"\n    Calculates the quality factor for a single set of parameters.\n    \"\"\"\n    L = params['L']\n    N = params['N']\n    x0 = params['x0']\n    d = params['d']\n    eps_slab = params['eps_slab']\n    t_pml = params['t_pml']\n    alpha = params['alpha']\n\n    # 1. Discretization and Grid Setup\n    h = L / (N - 1)\n    x = np.linspace(0, L, N, dtype=np.float64)\n\n    # 2. Define Material and PML Profiles\n    # Relative permittivity profile eps_r(x)\n    eps_r_vec = np.ones(N, dtype=np.complex128)\n    slab_mask = (x >= x0 - d / 2)  (x = x0 + d / 2)\n    eps_r_vec[slab_mask] = eps_slab\n\n    # PML stretch factor profile s(x)\n    s_vec = np.ones(N, dtype=np.complex128)\n    pml_mask1 = x = t_pml\n    pml_mask2 = x >= L - t_pml\n    s_vec[pml_mask1] = 1 + 1j * alpha\n    s_vec[pml_mask2] = 1 + 1j * alpha\n    \n    # 3. Assemble Stiffness (K) and Mass (M) Matrices\n    dim = N - 2  # Number of interior nodes\n    \n    # Stiffness Matrix K\n    c_vec = 1.0 / (mu0 * s_vec)\n    c_mid = 0.5 * (c_vec[:-1] + c_vec[1:])\n    \n    diag_vals = (c_mid[:-1] + c_mid[1:]) / (h**2)\n    offdiag_vals = -c_mid[1:-1] / (h**2)\n    \n    K = np.diag(diag_vals) + np.diag(offdiag_vals, k=1) + np.diag(offdiag_vals, k=-1)\n    K = K.astype(np.complex128)\n\n    # Mass Matrix M (lumped)\n    M_diag = eps0 * eps_r_vec[1:-1] * s_vec[1:-1] * h\n    M = np.diag(M_diag)\n    M = M.astype(np.complex128)\n\n    # 4. Solve the Generalized Eigenvalue Problem\n    try:\n        lambdas, _ = eig(K, M)\n    except np.linalg.LinAlgError:\n        return np.nan\n\n    # 5. Compute Complex Frequencies and Select Fundamental Resonance\n    \n    # Filter out non-physical or unstable eigenvalues\n    valid_lambdas = lambdas[np.isfinite(lambdas)]\n    \n    # Map eigenvalues to complex angular frequencies: omega = sqrt(lambda)\n    omegas = np.sqrt(valid_lambdas)\n    \n    # Filter for resonant modes: Re(omega) > 0 and Im(omega)  0\n    res_mask = (omegas.real > 1e-6)  (omegas.imag  -1e-9) # Use small tolerance\n    resonant_omegas = omegas[res_mask]\n\n    if resonant_omegas.size == 0:\n        return np.nan\n\n    # Select the fundamental mode (smallest positive real part)\n    fundamental_omega = resonant_omegas[np.argmin(resonant_omegas.real)]\n    \n    # 6. Compute the Quality Factor Q\n    omega_r = fundamental_omega.real\n    omega_i = fundamental_omega.imag\n    \n    if omega_i == 0:\n        return np.inf\n\n    q_factor = -omega_r / (2 * omega_i)\n    \n    return q_factor\n\nif __name__ == '__main__':\n    solve()\n```"
        },
        {
            "introduction": "变分原理的威力远不止于分析现有系统，它更是电磁学设计与优化的基石。这个练习将介绍一种强大的技术——伴随方法，它源于变分演算。你将通过求解一个约束优化问题，学习如何设计一个最优的驱动电流，使其在满足特定远场辐射目标的同时，最小化系统中的能量耗散。",
            "id": "3359382",
            "problem": "考虑一个线性、各向同性、由源驱动的电磁系统，该系统处于均匀背景介质中，其介电常数为 $\\varepsilon$、磁导率为 $\\mu$、电导率为 $\\sigma$。设外加源电流密度为 $\\mathbf{J}(\\mathbf{x},t)$，总电场和磁场分别为 $\\mathbf{E}(\\mathbf{x},t)$ 和 $\\mathbf{H}(\\mathbf{x},t)$。时域中的宏观麦克斯韦方程组是基本依据：\n- $\\nabla \\times \\mathbf{E}(\\mathbf{x},t) = -\\dfrac{\\partial \\mathbf{B}(\\mathbf{x},t)}{\\partial t}$,\n- $\\nabla \\times \\mathbf{H}(\\mathbf{x},t) = \\dfrac{\\partial \\mathbf{D}(\\mathbf{x},t)}{\\partial t} + \\sigma \\mathbf{E}(\\mathbf{x},t) + \\mathbf{J}(\\mathbf{x},t)$,\n其本构关系为 $\\mathbf{D}(\\mathbf{x},t) = \\varepsilon \\mathbf{E}(\\mathbf{x},t)$ 和 $\\mathbf{B}(\\mathbf{x},t) = \\mu \\mathbf{H}(\\mathbf{x},t)$。假设一个在 $t \\in [0,T]$ 上的有限时长实验，在 $[0,T]$ 之外场为零。设计变量是驱动电流密度 $\\mathbf{J}(\\mathbf{x},t)$。\n\n要求您设计 $\\mathbf{J}(\\mathbf{x},t)$ 以最小化时间积分的焦耳耗散密度 $\\int_{0}^{T} \\int_{\\Omega} \\sigma \\lVert \\mathbf{E}(\\mathbf{x},t) \\rVert^{2} \\, d\\mathbf{x}\\, dt$，并满足一个线性远场约束。具体来说，假设一个线性泛函 $\\mathcal{F}$ 将源映射到一个标量远场数据，其要求为 $\\mathcal{F}[\\mathbf{J}] = d$，其中 $d$ 是一个给定的标量。假设所有量都已无量纲化（最终答案中不需要物理单位）。\n\nA部分：推导任务（连续时间和空间）：仅从上述麦克斯韦方程组、本构关系以及使用拉格朗日乘子的标准变分法出发，推导以下约束优化问题的欧拉-拉格朗日最优性条件\n$$\n\\min_{\\mathbf{J}} \\int_{0}^{T} \\int_{\\Omega} \\sigma \\lVert \\mathbf{E}(\\mathbf{x},t) \\rVert^{2} \\, d\\mathbf{x} \\, dt \\quad \\text{subject to} \\quad \n\\text{Maxwell's equations and } \\mathcal{F}[\\mathbf{J}] = d.\n$$\n引入用于实施麦克斯韦动力学约束的拉格朗日乘子场和一个用于实施远场约束的标量拉格朗日乘子。除线性外，不要对 $\\mathcal{F}$ 的具体形式做任何假设。请清晰地表达：\n- 原（正向）方程，\n- 伴随（反向）方程，\n- 关于 $\\mathbf{J}$ 的驻定性条件，以及\n- 互补远场约束。\n\nB部分：用于计算的简化一维模型和离散时间公式：为使计算具体且自洽，采用单端口、单模简化，其中空间电流密度可分离为 $\\mathbf{J}(\\mathbf{x},t) = \\mathbf{s}(\\mathbf{x}) J(t)$，其中 $\\mathbf{s}(\\mathbf{x})$ 是固定的空间分布。在此设定下，耗散区代表性位置的电场被建模为标量源电流 $J(t)$ 与因果脉冲响应 $g(t)$ 的线性时不变卷积：\n$$\nE(t) = (g * J)(t) = \\int_{0}^{t} g(t-\\tau) J(\\tau)\\, d\\tau.\n$$\n引入一个系数为 $\\eta  0$ 的小的二次吉洪诺夫正则化项，以保证在离散设定下有唯一的极小值点。简化的目标函数和约束变为\n$$\n\\min_{J} \\; \\mathcal{J}[J] = \\int_{0}^{T} \\gamma\\, |(g * J)(t)|^{2} \\, dt + \\eta \\int_{0}^{T} |J(t)|^{2}\\, dt\n\\quad \\text{subject to} \\quad \\int_{0}^{T} w(t) J(t)\\, dt = d,\n$$\n其中 $\\gamma  0$ 是一个权重常数，而 $w(t)$ 定义了远场线性泛函 $\\mathcal{F}[J] = \\int_{0}^{T} w(t) J(t)\\, dt$。推导此简化模型中 $J(t)$ 的欧拉-拉格朗日正规方程。\n\nC部分：离散化与算法：将 $t \\in [0,T]$ 用 $N$ 个样本进行均匀离散，间距为 $\\Delta t = T/N$。令 $J_{n} \\approx J(n \\Delta t)$，$g_{n} \\approx g(n \\Delta t)$ 且当 $n  0$ 时 $g_{n} = 0$，$E_{n} = \\sum_{k=0}^{n} g_{n-k} J_{k}$，以及 $w_{n} \\approx w(n \\Delta t)$。离散的目标函数和约束为\n$$\n\\mathcal{J}_{d}(\\mathbf{J}) = \\Delta t \\left( \\gamma \\lVert \\mathbf{K}\\mathbf{J} \\rVert_{2}^{2} + \\eta \\lVert \\mathbf{J} \\rVert_{2}^{2} \\right), \n\\quad \\Delta t \\, \\mathbf{w}^{\\top} \\mathbf{J} = d,\n$$\n其中 $\\mathbf{K}$ 是由 $\\{g_{n}\\}_{n\\ge 0}$ 导出的严格下三角托普利茨卷积矩阵。证明对于最优解 $\\mathbf{J}^{\\star}$ 和标量拉格朗日乘子 $\\lambda$，其离散 Karush–Kuhn–Tucker (KKT) 系统为\n$$\n\\begin{bmatrix}\n2 \\Delta t \\, \\mathbf{Q}  \\Delta t \\, \\mathbf{w} \\\\\n\\Delta t \\, \\mathbf{w}^{\\top}  0\n\\end{bmatrix}\n\\begin{bmatrix}\n\\mathbf{J}^{\\star} \\\\\n\\lambda\n\\end{bmatrix}\n=\n\\begin{bmatrix}\n\\mathbf{0} \\\\\nd\n\\end{bmatrix},\n\\quad \\text{with} \\quad \\mathbf{Q} = \\gamma \\, \\mathbf{K}^{\\top} \\mathbf{K} + \\eta \\, \\mathbf{I}.\n$$\n\n编程任务：实现一个程序，该程序构建 $\\mathbf{K}$，形成上述 KKT 系统，求解 $\\mathbf{J}^{\\star}$ 和 $\\lambda$，并报告以下测试套件所要求的量。所有量都已无量纲化。如适用，角度以弧度为单位。\n\n使用以下必须硬编码的测试套件：\n- 测试 $1$（正常路径）：$N = 128$，$\\Delta t = 0.01$，$T = N \\Delta t$。令当 $n \\ge 0$ 时 $g_{n} = \\exp(-\\alpha \\, n \\Delta t)$，当 $n0$ 时 $g_{n}=0$，其中 $\\alpha = 4.0$。令当 $n \\Delta t \\in [0, 0.5]$ 时 $w_{n} = \\sin(2 \\pi f \\, n \\Delta t)$，否则 $w_{n} = 0$，其中 $f = 2.0$。令 $\\gamma = 1.0$，$\\eta = 1.0 \\times 10^{-4}$，且 $d = 1.0$。以浮点数形式报告最小化的离散目标值 $\\mathcal{J}_{d}(\\mathbf{J}^{\\star})$。\n- 测试 $2$（带解析检验的单位核边界情况）：$N = 64$，$\\Delta t = 0.02$，$T = N \\Delta t$。令 $g_{0} = 1.0$ 且当 $n \\ge 1$ 时 $g_{n} = 0$（因此 $E_{n} = J_{n}$）。令当 $n = 0,1,\\dots,M-1$ 时 $w_{n} = 1.0$，当 $n \\ge M$ 时 $w_{n} = 0$，其中 $M = 20$。令 $\\gamma = 1.0$，$\\eta = 10^{-8}$，且 $d = 2.0$。在这种情况下，解析极小值点满足 $\\mathbf{J}^{\\star} = c \\, \\mathbf{w}$，其中 $c = d / (\\Delta t \\lVert \\mathbf{w} \\rVert_{2}^{2})$。报告一个布尔值，指示数值解 $\\mathbf{J}^{\\star}$ 是否在 $10^{-6}$ 的 $\\ell_2$-范数容差内与解析解匹配。\n- 测试 $3$（带正则化的近奇异核边缘情况）：$N = 100$，$\\Delta t = 0.01$，$T = N \\Delta t$。令基础核为 $\\tilde{g}_{n} = \\exp(-\\beta \\, n \\Delta t)$（当 $n \\ge 0$），其中 $\\beta = 3.0$，然后定义 $g_{n} = \\epsilon \\, \\tilde{g}_{n}$，其中 $\\epsilon = 10^{-4}$。令当 $n \\Delta t \\in [0, 0.4]$ 时 $w_{n} = \\cos(2 \\pi f \\, n \\Delta t)$，否则 $w_{n} = 0$，其中 $f = 1.5$。令 $\\gamma = 1.0$，$\\eta = 10^{-2}$，且 $d = 0.3$。以浮点数形式报告绝对约束违反量 $|\\Delta t \\, \\mathbf{w}^{\\top} \\mathbf{J}^{\\star} - d|$。\n\n最终输出规范：您的程序应生成单行输出，其中包含测试 $1$–$3$ 的结果，格式为方括号内以逗号分隔的列表，顺序如下：[来自测试 $1$ 的 $\\mathcal{J}_{d}(\\mathbf{J}^{\\star})$, 来自测试 $2$ 的布尔值, 来自测试 $3$ 的绝对约束违反量]。例如，一个有效的输出行看起来像 $[0.123456,True,1e-09]$。",
            "solution": "该问题要求进行与电磁优化问题相关的推导，并对其简化的离散形式进行数值实现。验证证实了该问题在科学上是合理的、适定的和自洽的。\n\n### A部分：连续最优性条件的推导\n\n该优化问题是在麦克斯韦方程组和线性远场约束下，最小化时间积分的焦耳耗散。\n$$\n\\min_{\\mathbf{J}} \\int_{0}^{T} \\int_{\\Omega} \\sigma \\lVert \\mathbf{E}(\\mathbf{x},t) \\rVert^{2} \\, d\\mathbf{x} \\, dt \\quad \\text{subject to} \\quad \n\\begin{cases}\n\\nabla \\times \\mathbf{E} + \\mu \\frac{\\partial \\mathbf{H}}{\\partial t} = \\mathbf{0} \\\\\n\\nabla \\times \\mathbf{H} - \\varepsilon \\frac{\\partial \\mathbf{E}}{\\partial t} - \\sigma \\mathbf{E} = \\mathbf{J} \\\\\n\\mathcal{F}[\\mathbf{J}] = d\n\\end{cases}\n$$\n我们为两个麦克斯韦方程组引入拉格朗日乘子：矢量场 $\\mathbf{E}_a(\\mathbf{x},t)$ 和 $\\mathbf{H}_a(\\mathbf{x},t)$，并为远场约束引入标量 $\\lambda$。增广拉格朗日泛函 $\\mathcal{L}$ 为：\n$$\n\\mathcal{L}[\\mathbf{E}, \\mathbf{H}, \\mathbf{J}, \\mathbf{E}_a, \\mathbf{H}_a, \\lambda] = \\int_{0}^{T}\\int_{\\Omega} \\sigma \\mathbf{E} \\cdot \\mathbf{E} \\, d\\mathbf{x}dt + \\lambda(\\mathcal{F}[\\mathbf{J}] - d) \\\\\n+ \\int_{0}^{T}\\int_{\\Omega} \\mathbf{E}_a \\cdot \\left(\\nabla \\times \\mathbf{H} - \\varepsilon \\frac{\\partial \\mathbf{E}}{\\partial t} - \\sigma \\mathbf{E} - \\mathbf{J}\\right) d\\mathbf{x}dt \\\\\n+ \\int_{0}^{T}\\int_{\\Omega} \\mathbf{H}_a \\cdot \\left(\\nabla \\times \\mathbf{E} + \\mu \\frac{\\partial \\mathbf{H}}{\\partial t}\\right) d\\mathbf{x}dt\n$$\n通过将关于所有变量的一阶变分 $\\delta\\mathcal{L}$ 置为零来找到最优性条件。\n\n对拉格朗日乘子 $\\mathbf{E}_a, \\mathbf{H}_a, \\lambda$ 取变分，可恢复原方程和约束。\n\n对状态场 $\\mathbf{E}$ 和 $\\mathbf{H}$ 的变分产生伴随方程。我们在时间和空间上使用分部积分，假设在 $\\partial\\Omega$ 和 $t=0,T$ 处的边界项为零。\n对 $\\mathbf{E}$ 的变分给出：\n$$\n\\delta_{\\mathbf{E}} \\mathcal{L} = \\int_{0}^{T}\\int_{\\Omega} \\left( 2\\sigma\\mathbf{E} - \\sigma\\mathbf{E}_a + \\varepsilon \\frac{\\partial \\mathbf{E}_a}{\\partial t} + \\nabla \\times \\mathbf{H}_a \\right) \\cdot \\delta\\mathbf{E} \\,d\\mathbf{x}dt = 0\n$$\n由于这对任意 $\\delta\\mathbf{E}$ 都成立，括号中的项必须为零，这给出了其中一个伴随麦克斯韦方程。\n对 $\\mathbf{H}$ 的变分给出：\n$$\n\\delta_{\\mathbf{H}} \\mathcal{L} = \\int_{0}^{T}\\int_{\\Omega} \\left( \\nabla \\times \\mathbf{E}_a - \\mu \\frac{\\partial \\mathbf{H}_a}{\\partial t} \\right) \\cdot \\delta\\mathbf{H} \\,d\\mathbf{x}dt = 0\n$$\n这给出了另一个伴随麦克斯韦方程。\n\n对控制变量 $\\mathbf{J}$ 的变分给出了驻定性条件。鉴于 $\\mathcal{F}$ 的线性，我们可以写出 $\\mathcal{F}[\\delta\\mathbf{J}] = \\langle \\nabla_{\\mathbf{J}}\\mathcal{F}, \\delta\\mathbf{J} \\rangle$，其中 $\\nabla_{\\mathbf{J}}\\mathcal{F}$ 是泛函导数的 Riesz 表示子。\n$$\n\\delta_{\\mathbf{J}} \\mathcal{L} = \\int_{0}^{T}\\int_{\\Omega} (-\\mathbf{E}_a) \\cdot \\delta\\mathbf{J} \\,d\\mathbf{x}dt + \\lambda \\mathcal{F}[\\delta\\mathbf{J}] = 0 \\implies \\langle -\\mathbf{E}_a + \\lambda \\nabla_{\\mathbf{J}}\\mathcal{F}, \\delta\\mathbf{J} \\rangle = 0\n$$\n这对所有容许的变分 $\\delta\\mathbf{J}$ 都必须成立，从而导出驻定性条件。\n\n完整的的最优性系统如下：\n\n**原（正向）方程** ($t \\in [0,T]$):\n- $\\nabla \\times \\mathbf{E}(\\mathbf{x},t) + \\mu \\dfrac{\\partial \\mathbf{H}(\\mathbf{x},t)}{\\partial t} = \\mathbf{0}$\n- $\\nabla \\times \\mathbf{H}(\\mathbf{x},t) - \\varepsilon \\dfrac{\\partial \\mathbf{E}(\\mathbf{x},t)}{\\partial t} - \\sigma \\mathbf{E}(\\mathbf{x},t) = \\mathbf{J}(\\mathbf{x},t)$\n- 初始条件为 $\\mathbf{E}(\\mathbf{x},0) = \\mathbf{0}$，$\\mathbf{H}(\\mathbf{x},0) = \\mathbf{0}$。\n\n**伴随（反向）方程** ($t \\in [0,T]$):\n- $\\nabla \\times \\mathbf{E}_a(\\mathbf{x},t) - \\mu \\dfrac{\\partial \\mathbf{H}_a(\\mathbf{x},t)}{\\partial t} = \\mathbf{0}$\n- $\\nabla \\times \\mathbf{H}_a(\\mathbf{x},t) + \\varepsilon \\dfrac{\\partial \\mathbf{E}_a(\\mathbf{x},t)}{\\partial t} - \\sigma \\mathbf{E}_a(\\mathbf{x},t) = -2\\sigma \\mathbf{E}(\\mathbf{x},t)$\n- 终端条件为 $\\mathbf{E}_a(\\mathbf{x},T) = \\mathbf{0}$，$\\mathbf{H}_a(\\mathbf{x},T) = \\mathbf{0}$。注意 $\\mathbf{H}_a$ 的时间导数项上的负号，表示时间反演。\n\n**驻定性条件：**\n- $\\mathbf{E}_a(\\mathbf{x},t) = \\lambda \\left( \\nabla_{\\mathbf{J}} \\mathcal{F} \\right)(\\mathbf{x},t)$，其中 $\\nabla_{\\mathbf{J}} \\mathcal{F}$ 是 $\\mathcal{F}$ 的泛函导数的表示子。\n\n**互补远场约束：**\n- $\\mathcal{F}[\\mathbf{J}] = d$。\n\n### B部分：简化一维模型的欧拉-拉格朗日方程\n\n简化后的问题是：\n$$\n\\min_{J} \\; \\mathcal{J}[J] = \\int_{0}^{T} \\gamma\\, |(g * J)(t)|^{2} \\, dt + \\eta \\int_{0}^{T} |J(t)|^{2}\\, dt\n\\quad \\text{subject to} \\quad \\int_{0}^{T} w(t) J(t)\\, dt = d.\n$$\n拉格朗日函数为：\n$$\n\\mathcal{L}[J, \\lambda] = \\int_{0}^{T} \\left( \\gamma |(g * J)(t)|^{2} + \\eta |J(t)|^{2} \\right) dt + \\lambda \\left( \\int_{0}^{T} w(t) J(t) dt - d \\right).\n$$\n对 $J$ 取变分并将其设为零，得到 $\\delta_J \\mathcal{L} = 0$：\n$$\n\\int_{0}^{T} 2\\gamma (g*J)(t) \\cdot (g*\\delta J)(t) \\,dt + \\int_{0}^{T} 2\\eta J(t) \\cdot \\delta J(t) \\,dt + \\lambda \\int_{0}^{T} w(t) \\cdot \\delta J(t) \\,dt = 0.\n$$\n在内积中使用卷积的性质 $\\langle u, v*z \\rangle = \\langle v^{rev}*u, z \\rangle$（其中 $v^{rev}(t) = v(-t)$），第一项变为：\n$$\n\\int_{0}^{T} 2\\gamma (g^{rev} * (g*J))(t) \\cdot \\delta J(t) \\,dt.\n$$\n合并各项，我们得到：\n$$\n\\int_{0}^{T} \\left( 2\\gamma (g^{rev} * g * J)(t) + 2\\eta J(t) + \\lambda w(t) \\right) \\delta J(t) \\,dt = 0.\n$$\n由于这对任意变分 $\\delta J(t)$ 都成立，被积函数必须为零。这得出了 $J(t)$ 的欧拉-拉格朗日正规方程：\n$$\n2\\gamma (g^{rev} * g * J)(t) + 2\\eta J(t) + \\lambda w(t) = 0.\n$$\n\n### C部分：离散 KKT 系统的推导\n\n离散问题的目标函数为 $\\mathcal{J}_{d}(\\mathbf{J}) = \\Delta t \\left( \\gamma \\lVert \\mathbf{K}\\mathbf{J} \\rVert_{2}^{2} + \\eta \\lVert \\mathbf{J} \\rVert_{2}^{2} \\right)$，约束为 $\\Delta t \\, \\mathbf{w}^{\\top} \\mathbf{J} = d$。\n我们可以使用 $\\mathbf{Q} = \\gamma \\, \\mathbf{K}^{\\top} \\mathbf{K} + \\eta \\, \\mathbf{I}$ 的定义重写目标函数：\n$$\n\\mathcal{J}_{d}(\\mathbf{J}) = \\Delta t \\left( \\gamma \\mathbf{J}^{\\top}\\mathbf{K}^{\\top}\\mathbf{K}\\mathbf{J} + \\eta \\mathbf{J}^{\\top}\\mathbf{I}\\mathbf{J} \\right) = \\Delta t \\, \\mathbf{J}^{\\top} (\\gamma \\mathbf{K}^{\\top}\\mathbf{K} + \\eta \\mathbf{I}) \\mathbf{J} = \\Delta t \\, \\mathbf{J}^{\\top} \\mathbf{Q} \\mathbf{J}.\n$$\n这个约束优化问题的离散拉格朗日函数 $\\mathcal{L}_d$ 是：\n$$\n\\mathcal{L}_d(\\mathbf{J}, \\lambda) = \\Delta t \\, \\mathbf{J}^{\\top} \\mathbf{Q} \\mathbf{J} + \\lambda (\\Delta t \\, \\mathbf{w}^{\\top} \\mathbf{J} - d).\n$$\n通过将关于 $\\mathbf{J}$ 和 $\\lambda$ 的梯度设为零，可以找到 Karush-Kuhn-Tucker (KKT) 条件。\n1. 关于 $\\mathbf{J}$ 的梯度：\n使用矩阵微积分恒等式 $\\nabla_{\\mathbf{x}} (\\mathbf{x}^{\\top}\\mathbf{A}\\mathbf{x}) = 2\\mathbf{A}\\mathbf{x}$（对于对称矩阵 $\\mathbf{A}$，注意 $\\mathbf{Q}$ 是对称的）和 $\\nabla_{\\mathbf{x}} (\\mathbf{b}^{\\top}\\mathbf{x}) = \\mathbf{b}$，我们得到：\n$$\n\\nabla_{\\mathbf{J}} \\mathcal{L}_d = 2 \\Delta t \\, \\mathbf{Q} \\mathbf{J} + \\lambda \\Delta t \\, \\mathbf{w} = \\mathbf{0}.\n$$\n2. 关于 $\\lambda$ 的梯度：\n这只是恢复了约束方程：\n$$\n\\nabla_{\\lambda} \\mathcal{L}_d = \\Delta t \\, \\mathbf{w}^{\\top} \\mathbf{J} - d = 0 \\implies \\Delta t \\, \\mathbf{w}^{\\top} \\mathbf{J} = d.\n$$\n这两个方程可以写成一个单一的分块矩阵系统。令 $\\mathbf{J}^{\\star}$ 为最优解。\n$$\n(2 \\Delta t \\, \\mathbf{Q}) \\mathbf{J}^{\\star} + (\\Delta t \\, \\mathbf{w}) \\lambda = \\mathbf{0} \\\\\n(\\Delta t \\, \\mathbf{w}^{\\top}) \\mathbf{J}^{\\star} + (0) \\lambda = d\n$$\n这完全对应于指定的 KKT 系统：\n$$\n\\begin{bmatrix}\n2 \\Delta t \\, \\mathbf{Q}  \\Delta t \\, \\mathbf{w} \\\\\n\\Delta t \\, \\mathbf{w}^{\\top}  0\n\\end{bmatrix}\n\\begin{bmatrix}\n\\mathbf{J}^{\\star} \\\\\n\\lambda\n\\end{bmatrix}\n=\n\\begin{bmatrix}\n\\mathbf{0} \\\\\nd\n\\end{bmatrix}.\n$$\n这样就完成了所要求的推导。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import linalg\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the final results.\n    \"\"\"\n    results = []\n\n    # --- Test 1 ---\n    N1 = 128\n    dt1 = 0.01\n    alpha1 = 4.0\n    f1 = 2.0\n    gamma1 = 1.0\n    eta1 = 1.0e-4\n    d1 = 1.0\n    t1 = np.arange(N1) * dt1\n    \n    # Define g1 and w1\n    g1 = np.exp(-alpha1 * t1)\n    w1 = np.zeros(N1)\n    w1_end_idx = int(0.5 / dt1) + 1\n    w1[:w1_end_idx] = np.sin(2 * np.pi * f1 * t1[:w1_end_idx])\n\n    # Construct K1 matrix\n    # K is a lower triangular Toeplitz matrix for causal convolution\n    K1 = linalg.toeplitz(c=g1, r=np.zeros_like(g1))\n    \n    # Construct Q1 matrix\n    Q1 = gamma1 * (K1.T @ K1) + eta1 * np.eye(N1)\n    \n    # Construct and solve KKT system\n    A_kkt1 = np.zeros((N1 + 1, N1 + 1))\n    A_kkt1[:N1, :N1] = 2 * dt1 * Q1\n    A_kkt1[:N1, N1] = dt1 * w1\n    A_kkt1[N1, :N1] = dt1 * w1.T\n    b_kkt1 = np.zeros(N1 + 1)\n    b_kkt1[N1] = d1\n    \n    sol1 = np.linalg.solve(A_kkt1, b_kkt1)\n    J_star1 = sol1[:N1]\n    \n    # Calculate objective value\n    obj1 = dt1 * (gamma1 * np.linalg.norm(K1 @ J_star1)**2 + eta1 * np.linalg.norm(J_star1)**2)\n    results.append(obj1)\n\n    # --- Test 2 ---\n    N2 = 64\n    dt2 = 0.02\n    M2 = 20\n    gamma2 = 1.0\n    eta2 = 1.0e-8\n    d2 = 2.0\n\n    # Define g2 and w2\n    g2 = np.zeros(N2)\n    g2[0] = 1.0\n    w2 = np.zeros(N2)\n    w2[:M2] = 1.0\n\n    # Construct K2 matrix\n    K2 = linalg.toeplitz(c=g2, r=np.zeros_like(g2))\n    \n    # Construct Q2 matrix\n    Q2 = gamma2 * (K2.T @ K2) + eta2 * np.eye(N2)\n\n    # Construct and solve KKT system\n    A_kkt2 = np.zeros((N2 + 1, N2 + 1))\n    A_kkt2[:N2, :N2] = 2 * dt2 * Q2\n    A_kkt2[:N2, N2] = dt2 * w2\n    A_kkt2[N2, :N2] = dt2 * w2.T\n    b_kkt2 = np.zeros(N2 + 1)\n    b_kkt2[N2] = d2\n\n    sol2 = np.linalg.solve(A_kkt2, b_kkt2)\n    J_star_num2 = sol2[:N2]\n\n    # Analytic check\n    c2 = d2 / (dt2 * np.linalg.norm(w2)**2)\n    J_star_analyt2 = c2 * w2\n    \n    is_close = np.linalg.norm(J_star_num2 - J_star_analyt2)  1e-6\n    results.append(is_close)\n    \n    # --- Test 3 ---\n    N3 = 100\n    dt3 = 0.01\n    beta3 = 3.0\n    epsilon3 = 1.0e-4\n    f3 = 1.5\n    gamma3 = 1.0\n    eta3 = 1.0e-2\n    d3 = 0.3\n    t3 = np.arange(N3) * dt3\n\n    # Define g3 and w3\n    g3 = epsilon3 * np.exp(-beta3 * t3)\n    w3 = np.zeros(N3)\n    w3_end_idx = int(0.4 / dt3) + 1\n    w3[:w3_end_idx] = np.cos(2 * np.pi * f3 * t3[:w3_end_idx])\n\n    # Construct K3 matrix\n    K3 = linalg.toeplitz(c=g3, r=np.zeros_like(g3))\n\n    # Construct Q3 matrix\n    Q3 = gamma3 * (K3.T @ K3) + eta3 * np.eye(N3)\n\n    # Construct and solve KKT system\n    A_kkt3 = np.zeros((N3 + 1, N3 + 1))\n    A_kkt3[:N3, :N3] = 2 * dt3 * Q3\n    A_kkt3[:N3, N3] = dt3 * w3\n    A_kkt3[N3, :N3] = dt3 * w3.T\n    b_kkt3 = np.zeros(N3 + 1)\n    b_kkt3[N3] = d3\n\n    sol3 = np.linalg.solve(A_kkt3, b_kkt3)\n    J_star3 = sol3[:N3]\n\n    # Calculate constraint violation\n    violation = np.abs(dt3 * w3.T @ J_star3 - d3)\n    results.append(violation)\n\n    # Final print statement\n    print(f\"[{results[0]},{results[1]},{results[2]}]\")\n\nsolve()\n```"
        }
    ]
}