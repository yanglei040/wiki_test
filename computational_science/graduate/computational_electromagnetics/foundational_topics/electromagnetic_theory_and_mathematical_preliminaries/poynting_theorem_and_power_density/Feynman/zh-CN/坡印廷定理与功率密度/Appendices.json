{
    "hands_on_practices": [
        {
            "introduction": "在开发和验证数值求解器时，检验基本守恒定律是一个至关重要的步骤。本练习提供了一个动手实践的机会，让您为一个简单的二维平面波场景实现坡印廷定理的离散版本。通过将计算出的功率通量和损耗与输入功率进行比较，您可以直观地理解连续的物理定律如何被转换到离散的计算框架中 。",
            "id": "3342602",
            "problem": "要求您通过构建非端口边界上的离散时间平均坡印廷通量，并验证离散的向外功率平衡等于输入端口功率减去体积欧姆损耗，来演示计算电磁学频域设置中的能量守恒。您必须在一个二维轴向横电场（transverse electric to the axis）场景下，使用已知的解析场，在一个自包含的程序中完成此任务，并采用模拟一阶有限元法的简单求积方法。\n\n考虑一个矩形域 $\\Omega = [0,L_x]\\times[0,L_y]$，其中填充有均匀、各向同性的介质，其磁导率为 $\\mu=\\mu_0$，介电常数为 $\\varepsilon=\\varepsilon_0 \\varepsilon_r$，电导率为 $\\sigma$。采用时谐约定 $\\exp(+j\\omega t)$，其中 $\\omega=2\\pi f$。设标量电场分量 $E_z(x,y)$ 非零（轴向横电场），磁场分量 $H_x(x,y)$ 和 $H_y(x,y)$ 非零。使用以下内容作为基本依据：\n\n- 频域中麦克斯韦方程组的旋度方程：$\\nabla\\times \\mathbf{E} = -j\\omega \\mu \\mathbf{H}$ 和 $\\nabla\\times \\mathbf{H} = (\\sigma + j\\omega \\varepsilon)\\mathbf{E}$。\n- 时间平均坡印廷矢量定义：$\\langle \\mathbf{S} \\rangle = \\tfrac{1}{2}\\operatorname{Re}\\{\\mathbf{E}\\times \\mathbf{H}^*\\}$。\n- 时间平均欧姆功率耗散密度：$\\tfrac{1}{2}\\sigma|\\mathbf{E}|^2$。\n\n使用对应于在 $+x$ 方向传播并带衰减的均匀平面波的解析场，限制在具有 $E_z$ 极化的二维设置中：\n- 传播常数 $\\gamma = \\sqrt{j\\omega \\mu (\\sigma + j\\omega \\varepsilon)}$。\n- 本征阻抗 $\\eta_c = \\sqrt{\\dfrac{j\\omega \\mu}{\\sigma + j\\omega \\varepsilon}}$。\n- 场相量 $E_z(x,y) = E_0 \\exp(-\\gamma x)$，$H_x(x,y)=0$，$H_y(x,y) = -E_z(x,y)/\\eta_c$。\n\n按如下方式构建离散的向外功率平衡，使用结构化网格和模拟最低阶有限元离散化的中点求积法：\n\n- 将域划分为 $N_x\\times N_y$ 个大小均匀的矩形单元，尺寸为 $\\Delta x = L_x/N_x$ 和 $\\Delta y = L_y/N_y$。\n- 定义离散边界通量 $\\int_{\\partial\\Omega\\setminus\\Gamma_{\\text{port}}}\\mathbf{S}_h\\cdot \\hat{n}\\, dA$，方法是累加所有非端口边界边上的中点贡献，其中 $\\Gamma_{\\text{port}}$ 是位于 $x=0$ 处的驱动端口。在此几何结构和给定场的情况下，只有 $x=L_x$ 处的边界有非零通量贡献。通过中点法则对 $N_y$ 个边界边上的积分进行近似：对于每个位于 $(x=L_x, y=(j+\\tfrac{1}{2})\\Delta y)$ 的边中点，计算 $\\mathbf{S}_h = \\tfrac{1}{2}\\operatorname{Re}\\{\\mathbf{E}\\times \\mathbf{H}^*\\}$ 并累加 $\\mathbf{S}_h\\cdot \\hat{n}$ 乘以 $\\Delta y$ 的结果。\n- 将输入端口功率 $P_{\\text{port}}$ 定义为穿过 $x=0$ 的输入功率，即 $P_{\\text{port}} = -\\int_{\\Gamma_{\\text{port}}}\\langle \\mathbf{S}\\rangle \\cdot \\hat{n}\\, dA$。通过对 $x=0$ 处的 $N_y$ 个边使用中点法则进行近似。\n- 定义离散体积损耗 $\\int_{\\Omega} \\tfrac{1}{2}\\sigma|\\mathbf{E}|^2\\, dV$，通过对 $N_x\\times N_y$ 个单元的中点求积：在每个单元中心 $(x=(i+\\tfrac{1}{2})\\Delta x, y=(j+\\tfrac{1}{2})\\Delta y)$，累加 $\\tfrac{1}{2}\\sigma|E_z|^2 \\Delta x \\Delta y$。\n\n您的程序必须为每个测试用例计算标量残差\n$$R = \\left(\\int_{\\partial\\Omega\\setminus\\Gamma_{\\text{port}}}\\mathbf{S}_h\\cdot \\hat{n}\\, dA\\right) - \\left(P_{\\text{port}} - \\int_{\\Omega} \\tfrac{1}{2}\\sigma|\\mathbf{E}|^2\\, dV\\right),$$\n对于正确的构建，该残差预期近似为零，误差源于求积和浮点计算。所有功率必须以瓦特表示，并且您最终的残差 $R$ 必须以瓦特报告。\n\n不使用角度单位。所有物理常量必须采用国际单位制（SI）。使用 $\\mu_0 = 4\\pi\\times 10^{-7}$ 和 $\\varepsilon_0 \\approx 8.854187817\\times 10^{-12}$。\n\n测试套件：\n- 情况1：$f=3.0\\times 10^{9}$ (赫兹)，$\\varepsilon_r=1.0$，$\\sigma=2.0\\times 10^{-2}$ (西门子/米)，$L_x=5.0\\times 10^{-1}$ (米)，$L_y=3.0\\times 10^{-1}$ (米)，$E_0=1.0$ (伏特/米)，$N_x=300$，$N_y=60$。\n- 情况2：$f=5.0\\times 10^{9}$ (赫兹)，$\\varepsilon_r=2.5$，$\\sigma=0.0$ (西门子/米)，$L_x=2.5\\times 10^{-1}$ (米)，$L_y=1.0\\times 10^{-1}$ (米)，$E_0=2.0$ (伏特/米)，$N_x=240$，$N_y=40$。\n- 情况3：$f=1.0\\times 10^{9}$ (赫兹)，$\\varepsilon_r=4.0$，$\\sigma=5.0$ (西门子/米)，$L_x=5.0\\times 10^{-2}$ (米)，$L_y=5.0\\times 10^{-2}$ (米)，$E_0=1.0$ (伏特/米)，$N_x=200$，$N_y=40$。\n\n您的程序应生成单行输出，其中包含三个测试用例的残差，格式为逗号分隔的列表并用方括号括起，例如 $[r_1,r_2,r_3]$，其中每个 $r_k$ 是一个浮点数，表示第 $k$ 个测试用例的残差 $R$（单位为瓦特）。数值方法必须遵循上述构建方式，并且仅使用给定的解析场和中点求积法。",
            "solution": "我们从时谐场的频域麦克斯韦旋度方程开始，采用 $\\exp(+j\\omega t)$ 约定：\n$$\\nabla\\times \\mathbf{E} = -j\\omega \\mu \\mathbf{H}, \\quad \\nabla\\times \\mathbf{H} = (\\sigma + j\\omega \\varepsilon)\\mathbf{E}。$$\n复坡印廷矢量为 $\\mathbf{S}_c = \\tfrac{1}{2}\\mathbf{E}\\times \\mathbf{H}^*$，时间平均的实功率通量密度为 $\\langle \\mathbf{S} \\rangle = \\operatorname{Re}\\{\\mathbf{S}_c\\} = \\tfrac{1}{2}\\operatorname{Re}\\{\\mathbf{E}\\times \\mathbf{H}^*\\}$。根据这些以及矢量恒等式 $\\nabla\\cdot(\\mathbf{E}\\times \\mathbf{H}^*) = \\mathbf{H}^*\\cdot (\\nabla\\times \\mathbf{E}) - \\mathbf{E}\\cdot (\\nabla\\times \\mathbf{H}^*)$，我们得到频域坡印廷定理：\n$$\\nabla \\cdot \\langle \\mathbf{S} \\rangle = -\\tfrac{1}{2}\\sigma |\\mathbf{E}|^2,$$\n在取实部并使用线性时不变介质的本构关系后；对于稳态场，在时间平均后，无功项消失。对一个域 $\\Omega$ 进行积分并应用散度定理可得\n$$\\int_{\\partial \\Omega} \\langle \\mathbf{S} \\rangle \\cdot \\hat{n}\\, dA = - \\int_{\\Omega} \\tfrac{1}{2}\\sigma |\\mathbf{E}|^2\\, dV。$$\n在具有预设端口（位于边界的一部分 $\\Gamma_{\\text{port}}\\subset \\partial \\Omega$）的驱动有限元公式中，通常将来自端口的功率注入视为外部输入 $P_{\\text{port}}$，并且仅在剩余边界 $\\partial \\Omega \\setminus \\Gamma_{\\text{port}}$ 上计算向外通量。此时平衡关系为\n$$\\int_{\\partial \\Omega \\setminus \\Gamma_{\\text{port}}} \\langle \\mathbf{S} \\rangle \\cdot \\hat{n}\\, dA = P_{\\text{port}} - \\int_{\\Omega} \\tfrac{1}{2}\\sigma |\\mathbf{E}|^2\\, dV。$$\n这就是需要通过离散构建进行数值验证的陈述。\n\n我们选择一个二维轴向横电场设置，其中 $\\mathbf{E} = \\hat{z} E_z(x,y)$，$\\mathbf{H} = \\hat{x} H_x(x,y) + \\hat{y} H_y(x,y)$。对于均匀各向同性介质中沿 $+x$ 方向传播且带衰减的均匀平面波，\n$$\\gamma = \\sqrt{j\\omega \\mu (\\sigma + j\\omega \\varepsilon)}, \\quad \\eta_c = \\sqrt{\\frac{j\\omega \\mu}{\\sigma + j\\omega \\varepsilon}},$$\n$$E_z(x,y) = E_0 e^{-\\gamma x}, \\quad H_x(x,y)=0, \\quad H_y(x,y) = -\\frac{E_z(x,y)}{\\eta_c}。$$\n时间平均坡印廷矢量为\n$$\\langle \\mathbf{S} \\rangle = \\tfrac{1}{2}\\operatorname{Re}\\{\\mathbf{E}\\times \\mathbf{H}^*\\} = \\tfrac{1}{2}\\operatorname{Re}\\{ E_z \\hat{z} \\times (H_x^* \\hat{x} + H_y^* \\hat{y})\\} = \\tfrac{1}{2}\\operatorname{Re}\\{-E_z H_y^* \\hat{x} + E_z H_x^* \\hat{y}\\}。$$\n当 $H_x=0$ 时，唯一的非零分量是\n$$\\langle S_x \\rangle = -\\tfrac{1}{2}\\operatorname{Re}\\{E_z H_y^*\\} = \\tfrac{1}{2}\\operatorname{Re}\\left\\{\\frac{|E_z|^2}{\\eta_c^*}\\right\\}, \\quad \\langle S_y \\rangle = 0。$$\n因此，在边界 $x=L_x$ 上，外法线为 $+\\hat{x}$，向外功率通量密度等于 $\\langle S_x(L_x)\\rangle$。在 $x=0$ 的驱动端口边界上，外法线为 $-\\hat{x}$，输入端口功率为\n$$P_{\\text{port}} = -\\int_{\\Gamma_{\\text{port}}} \\langle \\mathbf{S} \\rangle \\cdot \\hat{n}\\, dA = \\int_{0}^{L_y} \\langle S_x(0)\\rangle \\, dy。$$\n体积欧姆损耗密度为 $\\tfrac{1}{2}\\sigma |E_z|^2$，因此\n$$\\int_{\\Omega} \\tfrac{1}{2}\\sigma |E_z|^2\\, dV = \\int_{0}^{L_y}\\int_{0}^{L_x} \\tfrac{1}{2}\\sigma |E_0|^2 e^{-2\\operatorname{Re}(\\gamma) x}\\, dx\\, dy。$$\n解析地，可以验证\n$$\\int_{x=L_x} \\langle \\mathbf{S} \\rangle \\cdot \\hat{n}\\, dA = \\int_{0}^{L_y} \\langle S_x(L_x)\\rangle \\, dy = \\int_{0}^{L_y} \\tfrac{1}{2}\\operatorname{Re}\\left\\{\\frac{|E_0|^2 e^{-2\\operatorname{Re}(\\gamma) L_x}}{\\eta_c^*}\\right\\}\\, dy,$$\n并且平衡关系\n$$\\int_{x=L_x} \\langle \\mathbf{S} \\rangle \\cdot \\hat{n}\\, dA = P_{\\text{port}} - \\int_{\\Omega} \\tfrac{1}{2}\\sigma |E_z|^2\\, dV$$\n在没有反射的情况下，对于连续场是精确成立的。数值任务是通过构建这些积分的中点求积近似来模拟离散有限元计算，并使用给定的解析场在所需的中点处计算被积函数。\n\n离散构建：\n- 将域划分为 $N_x\\times N_y$ 个均匀单元，尺寸为 $\\Delta x = L_x/N_x$，$\\Delta y = L_y/N_y$，并定义单元中心在 $x_i = (i+\\tfrac{1}{2})\\Delta x$，$y_j = (j+\\tfrac{1}{2})\\Delta y$，其中 $i \\in \\{0,\\dots,N_x-1\\}$，$j \\in \\{0,\\dots,N_y-1\\}$。\n- 对于垂直边上的边界积分，边中点位于 $x=0$ 或 $x=L_x$，$y_{j+\\tfrac{1}{2}}=(j+\\tfrac{1}{2})\\Delta y$，其中 $j \\in \\{0,\\dots,N_y-1\\}$。在每个中点处，根据解析表达式计算 $E_z$ 和 $H_y$，然后计算 $\\langle S_x\\rangle = -\\tfrac{1}{2}\\operatorname{Re}\\{E_z H_y^*\\}$。在 $x=L_x$ 上的离散向外通量是 $\\langle S_x(L_x,y_{j+\\tfrac{1}{2}})\\rangle \\Delta y$ 对 $j$ 的总和。端口功率是 $\\langle S_x(0,y_{j+\\tfrac{1}{2}})\\rangle \\Delta y$ 对 $j$ 的总和。\n- 对于体积损耗，在每个单元中心 $(x_i,y_j)$ 处，计算 $\\tfrac{1}{2}\\sigma |E_z(x_i,y_j)|^2$，并对所有单元求和，再乘以单元面积 $\\Delta x \\Delta y$。\n\n定义残差\n$$R = \\left(\\sum_{j=0}^{N_y-1} \\langle S_x(L_x,y_{j+\\tfrac{1}{2}})\\rangle \\Delta y\\right) - \\left(\\sum_{j=0}^{N_y-1} \\langle S_x(0,y_{j+\\tfrac{1}{2}})\\rangle \\Delta y - \\sum_{i=0}^{N_x-1}\\sum_{j=0}^{N_y-1} \\tfrac{1}{2}\\sigma |E_z(x_i,y_j)|^2 \\Delta x \\Delta y\\right)。$$\n因为场在 $y$ 方向上是均匀的，所以中点求积在 $y$ 方向上是精确的，并将求和简化为 $L_y$ 的因子。$x$ 积分由中点法则近似，对于像 $|E_z|^2$ 这样的光滑被积函数，该法则是二阶精确的。因此，随着网格细化，离散残差 $R$ 以 $\\mathcal{O}(\\Delta x^2)$ 的速度收敛到 $0$，并且在实践中主要受浮点舍入和求积误差的影响。\n\n对于指定的测试套件：\n- 情况1具有非零的 $\\sigma$ 和中等衰减；出射通量小于入射端口功率，其差值等于欧姆损耗（在求积误差范围内），因此 $R\\approx 0$。\n- 情况2是无损的，$\\sigma=0$，因此体积损耗为零，出射通量等于端口功率，因此 $R\\approx 0$。\n- 情况3是高损耗的，域很短；出射通量远小于端口功率，几乎所有输入功率都被耗散掉了；尽管如此，平衡关系应在求积误差范围内成立，并得出 $R\\approx 0$。\n\n程序实现了这些步骤，为每种情况计算以瓦特为单位的 $R$，并以 $[r_1,r_2,r_3]$ 的格式打印单行结果。",
            "answer": "```python\nimport numpy as np\n\n# Physical constants (SI)\nmu0 = 4.0e-7 * np.pi\neps0 = 8.854187817e-12\n\ndef propagation_constant(mu, eps, sigma, omega):\n    # gamma = sqrt(j*omega*mu*(sigma + j*omega*eps))\n    return np.sqrt(1j * omega * mu * (sigma + 1j * omega * eps))\n\ndef intrinsic_impedance(mu, eps, sigma, omega):\n    # eta_c = sqrt((j*omega*mu)/(sigma + j*omega*eps))\n    return np.sqrt((1j * omega * mu) / (sigma + 1j * omega * eps))\n\ndef discrete_power_balance_residual(f, eps_r, sigma, Lx, Ly, E0, Nx, Ny):\n    # Material parameters\n    mu = mu0\n    eps = eps0 * eps_r\n    omega = 2.0 * np.pi * f\n\n    # Wave parameters\n    gamma = propagation_constant(mu, eps, sigma, omega)\n    eta_c = intrinsic_impedance(mu, eps, sigma, omega)\n\n    # Grid spacing\n    dx = Lx / Nx\n    dy = Ly / Ny\n\n    # Helper to compute E_z at a given x\n    def Ez(x):\n        return E0 * np.exp(-gamma * x)\n\n    # Poynting Sx via E and H relation: H_y = -E/eta_c, Sx = -(1/2) Re(E * conj(H_y))\n    def Sx_from_E(E):\n        # Using Sx = 0.5 * Re(|E|^2 / conj(eta_c))\n        return 0.5 * np.real((np.abs(E) ** 2) / np.conj(eta_c))\n\n    # Boundary flux at x = Lx (non-port boundary), outward normal +x\n    E_L = Ez(Lx)\n    Sx_L = Sx_from_E(E_L)\n    # Midpoint quadrature along y is exact here (uniform in y)\n    boundary_flux_nonport = Sx_L * Ly\n\n    # Port power at x = 0 (incoming power)\n    E_0 = Ez(0.0)\n    Sx_0 = Sx_from_E(E_0)\n    P_port = Sx_0 * Ly\n\n    # Volumetric loss integral using midpoint rule over x (uniform in y)\n    # Loss density q(x) = 0.5 * sigma * |E(x)|^2\n    # Midpoints in x\n    x_mid = (np.arange(Nx) + 0.5) * dx\n    E_mid = Ez(x_mid)\n    q_mid = 0.5 * sigma * (np.abs(E_mid) ** 2)  # W/m^3\n    # Integrate over volume: sum q_mid * dx * Ly\n    loss = np.sum(q_mid) * dx * Ly\n\n    # Residual R = boundary_flux_nonport - (P_port - loss)\n    R = boundary_flux_nonport - (P_port - loss)\n    # Return as a float\n    return float(np.real(R))\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each tuple: (f, eps_r, sigma, Lx, Ly, E0, Nx, Ny)\n    test_cases = [\n        (3.0e9, 1.0, 2.0e-2, 5.0e-1, 3.0e-1, 1.0, 300, 60),   # Case 1\n        (5.0e9, 2.5, 0.0,     2.5e-1, 1.0e-1, 2.0, 240, 40),   # Case 2\n        (1.0e9, 4.0, 5.0,     5.0e-2, 5.0e-2, 1.0, 200, 40),   # Case 3\n    ]\n\n    results = []\n    for case in test_cases:\n        f, eps_r, sigma, Lx, Ly, E0, Nx, Ny = case\n        R = discrete_power_balance_residual(f, eps_r, sigma, Lx, Ly, E0, Nx, Ny)\n        results.append(R)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```"
        },
        {
            "introduction": "本练习在功率平衡验证的基础上，指导您开发一个实用的诊断工具。这类工具对于确保时域仿真的稳定性和物理合理性至关重要，尤其是在无源介质中，伪能量增长是一种常见的数值伪影。本练习演示了如何系统地量化能量守恒的违背程度，将一个理论原理转变为验证代码的有力工具 。",
            "id": "3342626",
            "problem": "您需要设计并实现一个程序化诊断工具，通过对频域等效结果进行后处理，来检测无源、均匀、各向同性介质的时域模拟中出现的非物理（伪）能量增长。该诊断工具必须基于Poynting定理的要求，在单音稳态条件下，通过对复Poynting矢量的实部在计算边界上进行积分，并将此边界功率平衡与体耗散进行比较。您的任务是仅使用边界通量和材料损耗，推导、实现并评估一个用于量化能量守恒违背程度的归一化残差。目标是得到一个标量指示器，其值接近零表示与无源性一致，而显著偏离零的值则表示可能存在伪增长或数值不平衡。\n\n出发点和物理设置：\n\n- 严格从无源、均匀、各向同性介质（电导率为$\\sigma$、介电常数为$\\varepsilon$、磁导率为$\\mu$）中的宏观麦克斯韦旋度方程出发，并结合电磁能量密度和Poynting矢量的标准定义。使用时谐（相量）表示法来定义复Poynting矢量及其时间平均的实功率流解释。\n\n- 考虑一个尺寸为 $L_x \\times L_y \\times L_z$ 的矩形三维域 $V$，其中充满了均匀介质。一个角频率为 $\\omega = 2\\pi f$ 的入射、垂直入射、线性极化的一维平面波沿 $+x$ 方向传播，其电场振幅为 $E_0$（在 $y$ 和 $z$ 方向上是均匀的）。总场是均匀有损介质中的均匀平面波场。除了介质本身，没有内部无功元件，也没有磁传导。\n\n- 输入是在输入边界 $x=0$ 上指定的一个入射波，因此净时间平均源功率等于通过输入边界的净向内实功率通量，所有其他的功率交换都通过剩余的边界和 $V$ 内部的欧姆耗散进行。\n\n要实现的诊断工具：\n\n- 使用介质在频率 $f$ 下的复传播常数 $\\gamma$ 和本征阻抗 $\\eta$ 来模拟在有损介质中沿 $x$ 方向衰减的垂直入射平面波的稳态场。假设采用主平方根分支，并强制使用物理上允许的符号，以确保衰减常数 $\\alpha = \\Re\\{\\gamma\\}$ 为非负，且导纳的实部 $\\Re\\{1/\\eta\\}$ 为非负。\n\n- 将实、时间平均、净输入功率 $P_{\\mathrm{in}}$ 定义为通过输入边界 $x=0$ 的向内实功率通量。将实、时间平均、净输出功率 $P_{\\mathrm{out}}$ 定义为通过其余边界的向外功率（在此一维设置中，只有 $x=L_x$ 处的边界有贡献）。将体 $V$ 上的实、时间平均、体欧姆耗散功率定义为 $P_{\\mathrm{diss}}$。\n\n- 从第一性原理推导能量平衡残差 $R = P_{\\mathrm{in}} - (P_{\\mathrm{out}} + P_{\\mathrm{diss}})$，并实现归一化诊断工具\n$$\nr = \\frac{R}{P_{\\mathrm{in}}}.\n$$\n在一个物理上正确、无源、稳态的设置中，$r$ 的值应在数值精度允许的范围内尽可能接近 $0$。$r$ 显著偏离 $0$ 表示违背了无源性或存在数值不平衡。您必须仅使用边界实功率通量和介质属性所隐含的体欧姆损耗来计算 $P_{\\mathrm{in}}$、$P_{\\mathrm{out}}$ 和 $P_{\\mathrm{diss}}$。\n\n您必须明确使用的数值建模假设：\n\n- 介质是均匀的，其参数为 $\\mu = \\mu_0$、$\\varepsilon = \\varepsilon_r \\varepsilon_0$ 和 $\\sigma$，其中 $\\mu_0$ 和 $\\varepsilon_0$ 分别是自由空间的磁导率和介电常数。\n\n- 复传播常数和本征阻抗满足\n$$\n\\gamma = \\sqrt{j \\omega \\mu \\left(\\sigma + j \\omega \\varepsilon\\right)}, \n\\quad \n\\eta = \\sqrt{\\frac{j \\omega \\mu}{\\sigma + j \\omega \\varepsilon}},\n$$\n并采用如上所述的物理上允许的分支选择。\n\n- 对于一个沿 $+x$ 方向传播、电场振幅为 $E_0$ 且相量场在 $y$ 和 $z$ 方向上均匀的均匀平面波，在平面 $x=\\text{const}$ 上，复Poynting矢量的实部仅有 $x$ 分量，并沿 $x$ 方向随场幅值的平方而衰减。使用此结构来计算 $x=0$ 和 $x=L_x$ 上的边界通量。\n\n- 体、时间平均欧姆耗散由标准的相量域损耗密度在整个体积上积分计算得出。\n\n测试套件：\n\n为以下四种情况实现您的程序以计算 $r$。在每种情况下，所有量均采用国际单位制（SI units），$r$ 是无量纲的。\n\n- 案例A（标称有损介质）：\n  - $E_0 = 1.0$, $f = 1.0 \\times 10^9$, $\\varepsilon_r = 4.0$, $\\sigma = 2.0 \\times 10^{-2}$, $L_x = 0.5$, $L_y = 0.4$, $L_z = 1.0$.\n  - 使用物理上正确的边界通量（无人工缩放）。\n\n- 案例B（近无损介质）：\n  - $E_0 = 1.2$, $f = 2.0 \\times 10^9$, $\\varepsilon_r = 2.5$, $\\sigma = 1.0 \\times 10^{-6}$, $L_x = 1.0$, $L_y = 0.3$, $L_z = 1.0$.\n  - 使用物理上正确的边界通量（无人工缩放）。\n\n- 案例C（高损耗介质）：\n  - $E_0 = 0.8$, $f = 1.0 \\times 10^8$, $\\varepsilon_r = 4.0$, $\\sigma = 5.0 \\times 10^{-1}$, $L_x = 0.2$, $L_y = 0.5$, $L_z = 1.0$.\n  - 使用物理上正确的边界通量（无人工缩放）。\n\n- 案例D（由于边界低估导致的模拟诊断失败）：\n  - 与案例A相同，但在计算 $x=L_x$ 处的向外通量时，人为地将边界通量乘以一个因子 $s = 0.9$，以模拟输出边界处磁场的系统性低估（模仿数值色散或边界截断误差）。所有其他量的计算与物理上正确的模型相同。\n\n要求的输出和单位：\n\n- 为每个案例计算诊断残差 $r$，结果为浮点数（无单位）。您的程序应生成单行输出，其中包含四个结果，以逗号分隔的列表形式，并用方括号括起来，顺序为[案例A, 案例B, 案例C, 案例D]，例如：“[rA,rB,rC,rD]”。\n\n- 您程序内部使用的所有中间物理量（功率）必须与瓦特（watts）单位一致，但只需打印最终的 $r$ 值，且无单位。\n\n不涉及角度单位。\n\n约束和覆盖范围：\n\n- 在低损耗极限 $\\alpha \\to 0$（其中 $\\alpha = \\Re\\{\\gamma\\}$）下，您的实现必须是鲁棒的。在此极限下，通过取适当的极限来一致地处理沿 $x$ 的场幅值平方的积分。\n\n- 所选的测试套件涵盖了典型的情形：标称损耗、近无损、高损耗，以及注入的边界低估，以测试诊断工具的灵敏度。\n\n- 您的程序必须是自包含的，且不得读取输入。\n\n您的推导必须从宏观麦克斯韦旋度方程以及电磁功率和能量密度的标准定义开始，并且必须证明为何所提出的残差 $r$ 是一个对伪非无源行为的灵敏探测器，同时还要讨论其在近无损情形和不完美的边界表征下的局限性。在您的推导中，不要使用任何未经解释的快捷公式；每一步都必须基于基本定律和标准定义。请清楚地陈述您所做的所有假设。最终的数值答案必须是四个案例的四个浮点残差 $r$，并按上文指定的方式以单行列表形式打印。",
            "solution": "该问题要求基于Poynting定理，推导并实现一个数值诊断工具，以验证无源介质时域模拟中的能量守恒。该诊断工具是一个归一化残差 $r$，它是根据均匀、各向同性、有损介质中单频稳态平面波的功率通量平衡和体耗散推导出来的。\n\n推导从无源区的宏观麦克斯韦旋度方程开始：\n$$\n\\nabla \\times \\mathbf{E}(\\mathbf{r}, t) = -\\frac{\\partial \\mathbf{B}(\\mathbf{r}, t)}{\\partial t}\n$$\n$$\n\\nabla \\times \\mathbf{H}(\\mathbf{r}, t) = \\mathbf{J}(\\mathbf{r}, t) + \\frac{\\partial \\mathbf{D}(\\mathbf{r}, t)}{\\partial t}\n$$\n对于角频率为 $\\omega$ 的时谐稳态，场可以用相量形式表示，例如 $\\mathbf{E}(\\mathbf{r}, t) = \\Re\\{\\vec{E}(\\mathbf{r}) e^{j\\omega t}\\}$。麦克斯韦方程组变为：\n$$\n\\nabla \\times \\vec{E} = -j\\omega \\vec{B}\n$$\n$$\n\\nabla \\times \\vec{H} = \\vec{J} + j\\omega \\vec{D}\n$$\n介质是线性的、均匀的、各向同性的，其本构关系为 $\\vec{D} = \\varepsilon \\vec{E}$、$\\vec{B} = \\mu \\vec{H}$，以及电导率的欧姆定律 $\\vec{J} = \\sigma \\vec{E}$。代入这些关系可得：\n$$\n\\nabla \\times \\vec{E} = -j\\omega \\mu \\vec{H}\n$$\n$$\n\\nabla \\times \\vec{H} = (\\sigma + j\\omega \\varepsilon) \\vec{E}\n$$\n为了推导功率平衡，我们遵循Poynting定理的标准流程。我们将第一个方程与磁场的复共轭 $\\vec{H}^*$ 做点积，然后减去第二个方程的复共轭与电场 $\\vec{E}$ 的点积：\n$$\n\\vec{H}^* \\cdot (\\nabla \\times \\vec{E}) - \\vec{E} \\cdot (\\nabla \\times \\vec{H}^*) = -j\\omega \\mu \\vec{H} \\cdot \\vec{H}^* - \\vec{E} \\cdot ((\\sigma - j\\omega \\varepsilon) \\vec{E}^*)\n$$\n使用矢量恒等式 $\\nabla \\cdot (\\vec{A} \\times \\vec{B}) = \\vec{B} \\cdot (\\nabla \\times \\vec{A}) - \\vec{A} \\cdot (\\nabla \\times \\vec{B})$，我们可以将左边识别为 $\\nabla \\cdot (\\vec{E} \\times \\vec{H}^*)$。方程变为：\n$$\n\\nabla \\cdot (\\vec{E} \\times \\vec{H}^*) = -j\\omega \\mu |\\vec{H}|^2 - \\sigma |\\vec{E}|^2 + j\\omega \\varepsilon |\\vec{E}|^2\n$$\n我们定义复Poynting矢量为 $\\vec{S}_c = \\vec{E} \\times \\vec{H}^*$。整理各项，我们得到复Poynting定理的微分形式：\n$$\n-\\nabla \\cdot \\vec{S}_c = \\sigma |\\vec{E}|^2 + j\\omega (\\mu |\\vec{H}|^2 - \\varepsilon |\\vec{E}|^2)\n$$\n将此方程在一个由表面 $S$ 包围的有限体积 $V$ 上积分，并应用散度定理，得到积分形式：\n$$\n-\\oint_S \\vec{S}_c \\cdot d\\mathbf{S} = \\int_V \\sigma |\\vec{E}|^2 dV + j\\omega \\int_V (\\mu |\\vec{H}|^2 - \\varepsilon |\\vec{E}|^2) dV\n$$\n物理释义来自取该方程的实部。时间平均功率流密度由 $\\langle \\mathbf{S} \\rangle = \\frac{1}{2}\\Re\\{\\vec{S}_c\\}$ 给出，单位体积内的时间平均耗散功率（欧姆损耗）为 $p_d = \\frac{1}{2}\\sigma |\\vec{E}|^2$，而项 $\\frac{1}{4}\\mu|\\vec{H}|^2$ 和 $\\frac{1}{4}\\varepsilon|\\vec{E}|^2$ 分别代表时间平均的储能磁场能量密度和储能电场能量密度。取该积分方程实部的 $\\frac{1}{2}$ 可得：\n$$\n-\\oint_S \\frac{1}{2}\\Re\\{\\vec{S}_c\\} \\cdot d\\mathbf{S} = \\int_V \\frac{1}{2}\\sigma |\\vec{E}|^2 dV\n$$\n该方程是稳态下能量守恒的表述：流入体积 $V$ 的净时间平均功率（左侧）完全等于在体积内以热量形式耗散的总时间平均功率（右侧）。\n\n让我们为我们的特定问题定义这些量：\n1. $P_{\\mathrm{in}}$: 通过输入边界 $x=0$ 流入 $V$ 的时间平均功率。\n2. $P_{\\mathrm{out}}$: 通过所有其他边界流出 $V$ 的时间平均功率。\n3. $P_{\\mathrm{diss}}$: 在 $V$ 内部耗散的总时间平均功率。\n\n因此，功率平衡方程可以写成 $P_{\\mathrm{in}} - P_{\\mathrm{out}} = P_{\\mathrm{diss}}$，或者 $P_{\\mathrm{in}} = P_{\\mathrm{out}} + P_{\\mathrm{diss}}$。诊断残差定义为 $R = P_{\\mathrm{in}} - (P_{\\mathrm{out}} + P_{\\mathrm{diss}})$。对于一个物理上正确的无源系统，$R$ 必须恒等于零。归一化残差 $r = R / P_{\\mathrm{in}}$ 提供了一个无量纲的度量，其中 $r=0$ 表示完美的能量平衡。\n\n接下来，我们将此应用于在尺寸为 $L_x \\times L_y \\times L_z$ 的域中沿 $+x$ 方向传播的指定一维平面波。电场是线性极化的（例如，沿 $\\hat{y}$ 方向），在输入面 $x=0$ 处的振幅为 $E_0$。相量场为：\n$$\n\\vec{E}(x) = \\hat{y} E_0 e^{-\\gamma x}\n$$\n$$\n\\vec{H}(x) = \\hat{z} \\frac{E_0}{\\eta} e^{-\\gamma x}\n$$\n此处，$\\gamma = \\sqrt{j\\omega\\mu(\\sigma + j\\omega\\varepsilon)}$ 是复传播常数，$\\eta = \\sqrt{j\\omega\\mu / (\\sigma + j\\omega\\varepsilon)}$ 是复本征阻抗。我们记 $\\gamma = \\alpha + j\\beta$，其中 $\\alpha = \\Re\\{\\gamma\\}$ 是衰减常数，对于无源介质必须为非负值。\n\n时间平均的Poynting矢量为：\n$$\n\\langle \\mathbf{S}(x) \\rangle = \\frac{1}{2}\\Re\\{\\vec{E}(x) \\times \\vec{H}^*(x)\\} = \\frac{1}{2}\\Re\\{(\\hat{y} E_0 e^{-\\gamma x}) \\times (\\hat{z} \\frac{E_0}{\\eta^*} e^{-\\gamma^* x})\\}\n$$\n$$\n\\langle \\mathbf{S}(x) \\rangle = \\hat{x} \\frac{E_0^2}{2} e^{-(\\gamma+\\gamma^*)x} \\Re\\{\\frac{1}{\\eta^*}\\} = \\hat{x} \\frac{E_0^2}{2} e^{-2\\alpha x} \\Re\\{\\frac{1}{\\eta}\\}\n$$\n功率流仅在 $x$ 方向，因此只有 $x=0$ 和 $x=L_x$ 处的边界对功率平衡有贡献。\n通过输入边界 $x=0$（面积 $A = L_y L_z$）的净向内功率通量为：\n$$\nP_{\\mathrm{in}} = |\\langle \\mathbf{S}(0) \\rangle| A = \\frac{A E_0^2}{2} \\Re\\{\\frac{1}{\\eta}\\}\n$$\n通过输出边界 $x=L_x$ 的净向外功率通量为：\n$$\nP_{\\mathrm{out}} = |\\langle \\mathbf{S}(L_x) \\rangle| A = \\left(\\frac{A E_0^2}{2} \\Re\\{\\frac{1}{\\eta}\\}\\right) e^{-2\\alpha L_x} = P_{\\mathrm{in}} e^{-2\\alpha L_x}\n$$\n总的体功率耗散是损耗密度 $p_d(x) = \\frac{1}{2}\\sigma |\\vec{E}(x)|^2$ 的积分：\n$$\nP_{\\mathrm{diss}} = \\int_V p_d dV = \\int_0^{L_x} \\int_0^{L_y} \\int_0^{L_z} \\frac{1}{2}\\sigma |E_0 e^{-\\gamma x}|^2 dz dy dx\n$$\n$$\nP_{\\mathrm{diss}} = \\frac{A \\sigma E_0^2}{2} \\int_0^{L_x} e^{-2\\alpha x} dx = \\frac{A \\sigma E_0^2}{2} \\left[\\frac{e^{-2\\alpha x}}{-2\\alpha}\\right]_0^{L_x} = \\frac{A \\sigma E_0^2}{4\\alpha} (1 - e^{-2\\alpha L_x})\n$$\n当 $\\alpha \\to 0$ 时，这个 $P_{\\mathrm{diss}}$ 的公式会变成不定式 ($0/0$)。在此极限下，积分 $\\int_0^{L_x} e^{-2\\alpha x}dx \\to L_x$，因此 $P_{\\mathrm{diss}} \\to \\frac{1}{2}A \\sigma E_0^2 L_x$。为了数值实现的鲁棒性，可以将该积分计算为 $-\\text{expm1}(-2\\alpha L_x)/(2\\alpha)$，这个表达式有一个稳定的极限。\n\n对于案例A、B和C，我们计算 $r = (P_{\\mathrm{in}} - (P_{\\mathrm{out}} + P_{\\mathrm{diss}})) / P_{\\mathrm{in}}$。可以解析地证明 $\\Re\\{1/\\eta\\} = \\sigma/(2\\alpha)$，这意味着 $P_{\\mathrm{out}} + P_{\\mathrm{diss}} = P_{\\mathrm{in}}$，因此 $R=0$ 且 $r=0$。数值计算将得到一个非常接近零的值，受限于浮点精度。\n\n对于案例D，我们通过将真实的向外通量乘以一个因子 $s=0.9$ 来模拟一个数值误差。计算出的向外功率为 $P'_{\\mathrm{out}} = s \\cdot P_{\\mathrm{out}}$。残差变为：\n$$\nR_D = P_{\\mathrm{in}} - (s \\cdot P_{\\mathrm{out}} + P_{\\mathrm{diss}}) = P_{\\mathrm{in}} - (s \\cdot P_{\\mathrm{in}}e^{-2\\alpha L_x} + P_{\\mathrm{in}}(1-e^{-2\\alpha L_x}))\n$$\n$$\nR_D = P_{\\mathrm{in}} - P_{\\mathrm{in}}(s \\cdot e^{-2\\alpha L_x} + 1 - e^{-2\\alpha L_x}) = P_{\\mathrm{in}}(1 - s)e^{-2\\alpha L_x} = 0.1 \\cdot P_{\\mathrm{in}} e^{-2\\alpha L_x}\n$$\n因此，归一化残差为 $r_D = R_D/P_{\\mathrm{in}} = 0.1 \\cdot e^{-2\\alpha L_x}$。这表明诊断工具 $r$ 是边界通量不平衡的一个灵敏指示器。\n\n该诊断工具的主要局限性出现在近无损介质中，即 $\\sigma \\to 0$。在这种情况下，$P_{\\mathrm{in}}$、$P_{\\mathrm{out}}$ 和 $P_{\\mathrm{diss}}$ 都趋近于零。用 $P_{\\mathrm{in}}$ 进行归一化可能会放大微小的浮点误差，从而可能导致 $r$ 值带有噪声或产生误导。然而，绝对残差 $R$ 仍应趋近于零。在数值模拟中对边界的不完美表征（例如，由于数值色散或不准确的边界条件）将导致计算出的通量值与物理实际不符，使得 $r$ 偏离零，正如在案例D中明确演示的那样。这使得 $r$ 成为验证和确认电磁模拟代码的一个有价值的工具。",
            "answer": "```python\nimport numpy as np\nfrom scipy import constants\n\ndef solve():\n    \"\"\"\n    Solves for the energy balance residual for four test cases of a plane wave\n    propagating in a lossy medium.\n    \"\"\"\n\n    # Define physical constants\n    MU_0 = constants.mu_0\n    EPSILON_0 = constants.epsilon_0\n\n    # Define test cases as specified in the problem statement\n    # Each tuple is (E0, f, eps_r, sigma, Lx, Ly, Lz, name, optional_scale)\n    test_cases = [\n        (1.0, 1.0e9, 4.0, 2.0e-2, 0.5, 0.4, 1.0, 'A', 1.0),\n        (1.2, 2.0e9, 2.5, 1.0e-6, 1.0, 0.3, 1.0, 'B', 1.0),\n        (0.8, 1.0e8, 4.0, 5.0e-1, 0.2, 0.5, 1.0, 'C', 1.0),\n        (1.0, 1.0e9, 4.0, 2.0e-2, 0.5, 0.4, 1.0, 'D', 0.9) # Case D is Case A with s=0.9\n    ]\n\n    results = []\n\n    for case in test_cases:\n        E0, f, eps_r, sigma, Lx, Ly, Lz, name, s = case\n\n        # Step 1: Calculate medium and wave parameters\n        omega = 2.0 * np.pi * f\n        mu = MU_0\n        eps_complex = eps_r * EPSILON_0 - 1j * (sigma / omega) # Using complex permittivity\n        \n        # In the provided formulas, we have (sigma + j*omega*epsilon).\n        # We can also write this as j*omega * (epsilon - j*sigma/omega) = j*omega*eps_complex\n        \n        # Calculate complex propagation constant gamma\n        # gamma = sqrt(j*omega*mu * (sigma + j*omega*eps_r*EPSILON_0))\n        # The principal square root from np.sqrt ensures Re{gamma} >= 0\n        gamma = np.sqrt(1j * omega * mu * (sigma + 1j * omega * eps_r * EPSILON_0))\n        alpha = gamma.real\n        \n        # Calculate complex intrinsic impedance eta\n        # eta = sqrt( (j*omega*mu) / (sigma + j*omega*eps_r*EPSILON_0) )\n        # The principal square root ensures Re{eta} >= 0, which implies Re{1/eta} >= 0\n        eta = np.sqrt((1j * omega * mu) / (sigma + 1j * omega * eps_r * EPSILON_0))\n\n        # Step 2: Calculate power terms based on derived formulas\n        area = Ly * Lz\n        \n        # Calculate inward power at x=0\n        # P_in = (Area * E0^2 / 2) * Re(1/eta)\n        P_in = (area * E0**2 / 2.0) * np.real(1.0 / eta)\n        \n        # Calculate outward power at x=Lx\n        # P_out = P_in * exp(-2*alpha*Lx)\n        # For Case D, this is scaled by s\n        P_out = P_in * np.exp(-2.0 * alpha * Lx)\n        if name == 'D':\n            P_out *= s\n            \n        # Calculate total dissipated power in the volume V\n        # P_diss = (Area * sigma * E0^2 / 2) * Integral_0^Lx(exp(-2*alpha*x) dx)\n        # The integral is (1 - exp(-2*alpha*Lx)) / (2*alpha)\n        # To handle the alpha -> 0 case robustly, we use a conditional expression.\n        if np.isclose(alpha, 0.0):\n            integral_val = Lx\n        else:\n            # Use of np.expm1 is more numerically stable than 1 - np.exp for small arguments\n            integral_val = -np.expm1(-2.0 * alpha * Lx) / (2.0 * alpha)\n\n        P_diss = (area * sigma * E0**2 / 2.0) * integral_val\n\n        # Step 3: Calculate the normalized residual r\n        # r = (P_in - (P_out + P_diss)) / P_in\n        # Handle the case where P_in might be zero (lossless medium)\n        if np.isclose(P_in, 0.0):\n            # If P_in is zero, R should also be zero in the ideal case. r is ill-defined.\n            # For this problem, sigma > 0, so P_in > 0.\n            # If R is also zero, r is 0. If R is non-zero, r would be inf.\n            residual_R = P_in - (P_out + P_diss)\n            if np.isclose(residual_R, 0.0):\n                r = 0.0\n            else:\n                r = np.inf # Signifies an issue\n        else:\n            r = (P_in - (P_out + P_diss)) / P_in\n        \n        results.append(r)\n\n    # Print results in the specified format\n    print(f\"[{','.join(f'{res:.6e}' for res in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "这项高级练习旨在解决计算天线和散射分析中的一个基石问题：近场到远场变换 (near-to-far-field transformation, NTFF)。通过实践等效原理，您将学习如何根据一个封闭表面上的近场数据计算远场辐射方向图。本练习的核心是验证坡印廷定理最优美的推论之一：流过任何包围源的封闭曲面的总功率等于辐射到无穷远的总功率，从而确保能量从近场到远场是守恒的 。",
            "id": "3342672",
            "problem": "在真空中给定一个时谐电磁源：一个长度为$\\ell$、相量电流幅值为$I_0$的$z$向Hertzian电流元（短偶极子）。相量的时间依赖约定为$e^{j \\omega t}$。一个半径为$a$的闭合球形Huygens面包围着该源。环境为自由空间，其介电常数为$\\varepsilon_0$，磁导率为$\\mu_0$，光速为$c = 1/\\sqrt{\\mu_0 \\varepsilon_0}$，波阻抗为$\\eta_0 = \\sqrt{\\mu_0 / \\varepsilon_0}$，波数为$k = \\omega / c = 2 \\pi f / c$。\n\n从基本定律和核心定义（频域中的Maxwell方程组、电磁场等效原理以及关于时间平均功率的Poynting定理）出发，实现一个数值近场到远场的变换。该变换利用Huygens面上的等效表面电流来获得辐射场的远场Poynting功率密度。请使用纯粹基于数学和逻辑的方法，不要依赖任何简化公式。所有角度必须以弧度为单位。所有功率必须以瓦特（watts）表示，所有功率密度必须以$\\mathrm{W/m^2}$表示。\n\n您必须：\n\n1. 使用半径为$a$的球面上的切向电场和磁场相量，记为$E_\\theta(a,\\theta',\\phi')$和$H_\\phi(a,\\theta',\\phi')$（撇号表示表面角变量）。对于$z$向Hertzian偶极子，在自由空间中，这些是仅有的非零切向分量。为了计算上的易处理性和科学上的真实性，您可以从当$k a \\gg 1$时有效的、经过充分测试的远区表达式生成表面场数据。您的解决方案必须从第一性原理推导任何所需的表达式，不能在本问题陈述中写下或依赖任何简化公式。\n\n2. 利用向外的单位法向量$\\mathbf{n}(\\theta',\\phi')$，在球形Huygens面上形成等效电表面电流密度和磁表面电流密度：\n   $$\\mathbf{J}_s(\\theta',\\phi') = \\mathbf{n}(\\theta',\\phi') \\times \\mathbf{H}(a,\\theta',\\phi'),\\qquad \\mathbf{M}_s(\\theta',\\phi') = -\\,\\mathbf{n}(\\theta',\\phi') \\times \\mathbf{E}(a,\\theta',\\phi').$$\n\n3. 对于一组观测极角$\\theta \\in [0,\\pi]$和固定的方位角$\\phi = 0$，计算在半径为$R$的观测球面上的辐射远场电场$\\mathbf{E}_\\infty(\\hat{\\mathbf{r}})$。使用与等效原理一致的适当辐射积分，将闭合表面上的$\\mathbf{J}_s$和$\\mathbf{M}_s$映射到$\\mathbf{E}_\\infty(\\hat{\\mathbf{r}})$，包括正确的远场振荡相位因子和$1/R$幅度缩放。您的推导必须从Maxwell方程组和Green函数表示法开始，而不是从记忆的目标公式开始。最终计算出的$\\mathbf{E}_\\infty$必须以$\\mathrm{V/m}$表示。\n\n4. 从$\\mathbf{E}_\\infty(\\hat{\\mathbf{r}})$出发，使用自由空间关系计算远场磁场$\\mathbf{H}_\\infty(\\hat{\\mathbf{r}})$，然后计算远区的时间平均Poynting功率密度：\n   $$S_\\infty(\\theta) = \\frac{1}{2} \\operatorname{Re}\\!\\left[\\hat{\\mathbf{r}} \\cdot \\left(\\mathbf{E}_\\infty(\\hat{\\mathbf{r}}) \\times \\mathbf{H}_\\infty^*(\\hat{\\mathbf{r}})\\right)\\right],$$\n   单位为$\\mathrm{W/m^2}$，其中$\\hat{\\mathbf{r}}$是观测单位向量，而$^*$表示复共轭。\n\n5. 将$S_\\infty(\\theta)$在观测球面上进行数值积分，以获得总辐射功率$P_{\\mathrm{ff}}$，单位为瓦特：\n   $$P_{\\mathrm{ff}} = \\int_0^{2\\pi} \\int_0^\\pi S_\\infty(\\theta)\\, R^2 \\sin\\theta \\, d\\theta \\, d\\phi.$$\n   对于给定的源，根据对称性，$S_\\infty$与$\\phi$无关，因此您可以将积分简化为乘以$2\\pi$的一维极坐标积分。\n\n6. 通过对从表面场数据导出的时间平均Poynting矢量的径向分量进行数值积分，独立计算穿过Huygens面的输入功率$P_{\\mathrm{in}}$：\n   $$P_{\\mathrm{in}} = \\int_0^{2\\pi} \\int_0^\\pi \\frac{1}{2} \\operatorname{Re}\\!\\left[\\mathbf{n}(\\theta',\\phi') \\cdot \\left(\\mathbf{E}(a,\\theta',\\phi') \\times \\mathbf{H}^*(a,\\theta',\\phi')\\right)\\right] a^2 \\sin\\theta' \\, d\\theta' \\, d\\phi'.$$\n   使用相同的单位法向量$\\mathbf{n}(\\theta',\\phi')$，并以瓦特表示$P_{\\mathrm{in}}$。对于给定的源和自由空间环境，在稳态下，$P_{\\mathrm{in}}$等于总辐射功率。\n\n7. 通过计算相对误差来验证能量守恒：\n   $$\\delta = \\frac{|P_{\\mathrm{ff}} - P_{\\mathrm{in}}|}{P_{\\mathrm{in}}},$$\n   对于每个测试用例。结果必须是无量纲的十进制值。\n\n测试套件：\n- Case A: $f = 600 \\times 10^6$ Hz, $I_0 = 1.0$ A, $\\ell = \\lambda / 50$, $a = 1.5 \\lambda$, $R = 10 \\lambda$.\n- Case B: $f = 3.0 \\times 10^9$ Hz, $I_0 = 0.75$ A, $\\ell = \\lambda / 80$, $a = 0.8 \\lambda$, $R = 8 \\lambda$.\n- Case C: $f = 1.0 \\times 10^9$ Hz, $I_0 = 0.2$ A, $\\ell = \\lambda / 30$, $a = 2.0 \\lambda$, $R = 12 \\lambda$.\n\n所有出现的$\\lambda$表示自由空间波长$\\lambda = 2\\pi / k$。角度以弧度为单位。数值积分必须在$\\theta$和$\\phi$上进行，使用在具有明确步长的均匀角度网格上的适当求积法。您的程序必须计算每种情况下的$\\delta$。\n\n最终输出格式：\n您的程序应生成一行输出，其中包含三个相对误差，形式为用方括号括起来的逗号分隔列表，顺序为[Case A, Case B, Case C]。例如：“[0.00123,0.00098,0.00175]”。",
            "solution": "用户提供了一个计算电磁学问题，该问题需要验证，如果有效，则需要一个完整的解决方案。\n\n### 步骤1：问题验证\n\n该问题是计算电磁学中一个适定且科学上合理的练习。它要求基于电磁等效原理实现并验证一个近场到远场变换（NTFF）。\n\n- **已知条件**：问题提供了所有必要的信息：一个特定的源（Hertzian偶极子）、一个Huygens面的定义、物理常数（通过自由空间隐式给出）、一组包含所有定义参数（$f$、$I_0$、$\\ell$、$a$、$R$）的三个不同测试用例，以及对要计算的量和最终验证指标（$\\delta$）的精确定义。\n- **科学基础**：该问题基于电磁学的基本原理：Maxwell方程组、等效原理（由Stratton-Chu积分形式化）和关于功率流的Poynting定理。这些是任何高等电动力学课程中的经典主题。\n- **适定且客观**：该任务被构造为一个自洽性检查，这是数值代码的标准验证程序。它要求验证流经一个闭合曲面的功率等于辐射到远场的功率，而远场是由该同一曲面上的数据计算得出的。对于$ka \\gg 1$使用远区近似来生成表面场的指令是一个标准的简化，用以创建一个自包含的、可处理的问题。它没有引入矛盾，而是为NTFF算法定义了输入数据。所要求的计算是客观的，并会得出一个唯一的数值结果。\n- **无缺陷**：该问题不违反任何无效标准。它不是基于错误前提，是直接可形式化的，是完整的，并提出了一个非平凡但可行的计算挑战。\n\n**结论**：该问题有效。\n\n### 步骤2：基于原理的解决方案推导\n\n解决方案依赖于电磁等效原理和Poynting定理。我们将首先从基本定律出发，推导必要的理论表达式，然后概述数值实现。\n\n**1. 控制方程与等效原理**\n在真空的无源区域中，时间依赖关系为$e^{j\\omega t}$的时谐电磁场遵循Maxwell的旋度方程：\n$$ \\nabla \\times \\mathbf{E} = -j\\omega\\mu_0 \\mathbf{H} $$\n$$ \\nabla \\times \\mathbf{H} = j\\omega\\varepsilon_0 \\mathbf{E} $$\n等效原理指出，无源体积$V$中的场可以通过将$V$外部的源替换为$V$的边界$S$上的一组等效电表面电流和磁表面电流来找到。这些电流由以下公式给出：\n$$ \\mathbf{J}_s = \\mathbf{n} \\times \\mathbf{H} $$\n$$ \\mathbf{M}_s = -\\mathbf{n} \\times \\mathbf{E} $$\n其中$\\mathbf{n}$是指向$V$外部的单位法向量，$(\\mathbf{E}, \\mathbf{H})$是$S$上的原始场。这些电流辐射到无源空间中，在$S$内部产生零场，在$S$外部产生原始场。\n\n**2. 远场的辐射积分**\n由这些表面电流辐射的电场可以使用自由空间Green函数$G(\\mathbf{r}, \\mathbf{r}') = \\frac{e^{-jk|\\mathbf{r}-\\mathbf{r}'|}}{4\\pi|\\mathbf{r}-\\mathbf{r}'|}$来表示。在远场中，观测距离$r = |\\mathbf{r}|$远大于源尺寸$r' = |\\mathbf{r}'|$（即$r \\gg a$），我们使用近似$|\\mathbf{r}-\\mathbf{r}'| \\approx r - \\hat{\\mathbf{r}}\\cdot\\mathbf{r}'$。远场电场$\\mathbf{E}_\\infty$与传播方向$\\hat{\\mathbf{r}}$横向。在球坐标中，其横向场分量由辐射矢量$\\mathbf{N}$和$\\mathbf{L}$决定：\n$$ E_{\\infty,\\theta} \\approx -\\frac{jke^{-jkr}}{4\\pi r}(L_\\phi + \\eta_0 N_\\theta) $$\n$$ E_{\\infty,\\phi} \\approx \\frac{jke^{-jkr}}{4\\pi r}(L_\\theta - \\eta_0 N_\\phi) $$\n其中辐射矢量定义为表面电流的傅里叶变换：\n$$ \\mathbf{N} = \\int_S \\mathbf{J}_s(\\mathbf{r}') e^{jk\\hat{\\mathbf{r}}\\cdot\\mathbf{r}'} dS' $$\n$$ \\mathbf{L} = \\int_S \\mathbf{M}_s(\\mathbf{r}') e^{jk\\hat{\\mathbf{r}}\\cdot\\mathbf{r}'} dS' $$\n而$(N_\\theta, N_\\phi)$和$(L_\\theta, L_\\phi)$是在观测坐标系中$\\mathbf{N}$和$\\mathbf{L}$的球坐标分量。\n\n**3. 在Hertzian偶极子问题中的应用**\n源是在原点处长度为$\\ell$、电流为$I_0$的$z$向Hertzian偶极子。Huygens面是一个半径为$a$的球面。问题指定使用此表面上场的远区表达式（$ka \\gg 1$）：\n$$ \\mathbf{E}(a, \\theta', \\phi') \\approx E_\\theta \\hat{\\boldsymbol{\\theta}}' = \\frac{j k \\eta_0 I_0 \\ell}{4\\pi a} \\sin\\theta' e^{-jka} \\hat{\\boldsymbol{\\theta}}' $$\n$$ \\mathbf{H}(a, \\theta', \\phi') \\approx H_\\phi \\hat{\\boldsymbol{\\phi}}' = \\frac{j k I_0 \\ell}{4\\pi a} \\sin\\theta' e^{-jka} \\hat{\\boldsymbol{\\phi}}' $$\n向外法向量为$\\mathbf{n} = \\hat{\\mathbf{r}}'$。在表面$r'=a$上的等效电流为：\n$$ \\mathbf{J}_s = \\hat{\\mathbf{r}}' \\times (H_\\phi \\hat{\\boldsymbol{\\phi}}') = -H_\\phi \\hat{\\boldsymbol{\\theta}}' $$\n$$ \\mathbf{M}_s = - \\hat{\\mathbf{r}}' \\times (E_\\theta \\hat{\\boldsymbol{\\theta}}') = -E_\\theta \\hat{\\boldsymbol{\\phi}}' $$\n辐射矢量是在球面积分$dS' = a^2 \\sin\\theta' d\\theta' d\\phi'$。相位项为$e^{jk\\hat{\\mathbf{r}}\\cdot\\mathbf{r}'} = e^{jka(\\sin\\theta\\sin\\theta'\\cos(\\phi-\\phi') + \\cos\\theta\\cos\\theta')}$。不失一般性，我们可以设置观测方位角$\\phi=0$。\n由于源和几何形状的方位对称性，用于$\\mathbf{N}$和$\\mathbf{L}$的笛卡尔积分的许多分量都为零。对$\\phi'$的积分可以解析地进行，得到Bessel函数：\n$$ \\int_0^{2\\pi} e^{jz\\cos\\phi'}d\\phi' = 2\\pi J_0(z), \\quad \\int_0^{2\\pi} \\cos\\phi' e^{jz\\cos\\phi'}d\\phi' = 2\\pi j J_1(z) $$\n这将二维面积分简化为对$\\theta'$的一维积分。辐射矢量的非零笛卡尔分量（对于$\\phi=0$）为：\n$$ L_y(\\theta) = - \\int_0^\\pi E_\\theta(a, \\theta') \\left( \\int_0^{2\\pi} (\\cos\\phi') e^{jk\\hat{\\mathbf{r}}\\cdot\\mathbf{r}'} d\\phi' \\right) a^2 \\sin\\theta'd\\theta' $$\n$$ N_x(\\theta) = - \\int_0^\\pi H_\\phi(a, \\theta') \\left( \\int_0^{2\\pi} (\\cos\\theta'\\cos\\phi') e^{jk\\hat{\\mathbf{r}}\\cdot\\mathbf{r}'} d\\phi' \\right) a^2 \\sin\\theta'd\\theta' $$\n$$ N_z(\\theta) = - \\int_0^\\pi H_\\phi(a, \\theta') \\left( \\int_0^{2\\pi} (-\\sin\\theta') e^{jk\\hat{\\mathbf{r}}\\cdot\\mathbf{r}'} d\\phi' \\right) a^2 \\sin\\theta'd\\theta' $$\n对于一个$z$向源，远场只有一个$E_\\theta$分量，因此我们预期$E_{\\infty,\\phi}=0$。根据对称性，$L_\\theta=0$和$N_\\phi=0$，这证实了这一点。所需的分量是$L_\\phi = L_y$和$N_\\theta = N_x \\cos\\theta - N_z \\sin\\theta$。这些涉及Bessel函数的对$\\theta'$的一维积分将进行数值计算。\n\n**4. 功率计算与验证**\n问题的核心是验证能量守恒。\n- **输入功率（$P_{\\mathrm{in}}$）**：这是穿过Huygens面的总功率，通过将时间平均Poynting矢量$\\mathbf{S} = \\frac{1}{2}\\operatorname{Re}(\\mathbf{E} \\times \\mathbf{H}^*)$的径向分量在整个表面上积分来计算：\n$$ P_{\\mathrm{in}} = \\oint_S \\mathbf{S} \\cdot d\\mathbf{S} = \\int_0^{2\\pi}\\int_0^\\pi \\frac{1}{2}\\operatorname{Re}[E_\\theta(a,\\theta') H_\\phi^*(a,\\theta')] a^2 \\sin\\theta' d\\theta' d\\phi' $$\n在我们的模型中，$E_\\theta = \\eta_0 H_\\phi$，因此被积函数是方位对称的，积分简化为对$\\theta'$的一维数值积分。\n\n- **远场功率（$P_{\\mathrm{ff}}$）**：通过将远场功率密度在一个半径为$R$的大球面上积分来计算：\n$$ S_\\infty(\\theta) = \\frac{1}{2}\\operatorname{Re}[\\hat{\\mathbf{r}}\\cdot(\\mathbf{E}_\\infty \\times \\mathbf{H}_\\infty^*)] = \\frac{1}{2\\eta_0}|E_{\\infty,\\theta}|^2 $$\n$$ P_{\\mathrm{ff}} = \\int_0^{2\\pi}\\int_0^\\pi S_\\infty(\\theta) R^2 \\sin\\theta d\\theta d\\phi = 2\\pi R^2 \\int_0^\\pi S_\\infty(\\theta) \\sin\\theta d\\theta $$\n注意，面元中的$R^2$依赖性抵消了$S_\\infty$中的$1/R^2$依赖性，使得$P_{\\mathrm{ff}}$与观测半径$R$无关，正如预期的那样。\n\n- **相对误差**：通过计算相对误差来验证数值模型的自洽性：\n$$ \\delta = \\frac{|P_{\\mathrm{ff}} - P_{\\mathrm{in}}|}{P_{\\mathrm{in}}} $$\n一个小的$\\delta$值证实了近场到远场变换的数值实现是能量守恒的。\n\n**5. 数值实现**\n该过程实现如下：\n1. 对于每个测试用例，计算所有的物理和几何参数。\n2. 通过在其定义表达式上使用梯形法则，对$\\theta'$的均匀网格进行数值积分，来计算$P_{\\mathrm{in}}$。\n3. 为了找到$P_{\\mathrm{ff}}$，一个外层循环在$\\theta$的观测网格上迭代。对于每个观测角$\\theta_i$：\n    a. 对$L_y, N_x, N_z$的一维积分在一个精细的$\\theta'$均匀网格上进行数值计算。这些被积函数涉及Bessel函数$J_0$和$J_1$。\n    b. 从这些分量组装远场$E_{\\infty,\\theta}(\\theta_i)$。\n    c. 计算功率密度$S_\\infty(\\theta_i)$。\n4. 将得到的$S_\\infty(\\theta_i)$值数组在观测网格$\\theta$上进行数值积分，得到$P_{\\mathrm{ff}}$。\n5. 计算相对误差$\\delta$。\n对所有测试用例重复此过程。",
            "answer": "```python\nimport numpy as np\nfrom scipy import special\n\ndef solve():\n    \"\"\"\n    Main function to run test cases and print results.\n    \"\"\"\n    # Physical constants\n    C0 = 299792458.0  # Speed of light in vacuum (m/s)\n    MU0 = 4.0 * np.pi * 1e-7  # Permeability of vacuum (H/m)\n    EPS0 = 1.0 / (MU0 * C0**2)  # Permittivity of vacuum (F/m)\n    ETA0 = np.sqrt(MU0 / EPS0)  # Impedance of free space (Ohms)\n\n    # Test cases from the problem statement\n    test_cases = [\n        # (f, I0, l_lambda_ratio, a_lambda_ratio, R_lambda_ratio)\n        (600e6, 1.0, 1.0/50.0, 1.5, 10.0),  # Case A\n        (3.0e9, 0.75, 1.0/80.0, 0.8, 8.0),   # Case B\n        (1.0e9, 0.2, 1.0/30.0, 2.0, 12.0),  # Case C\n    ]\n    \n    # Numerical integration parameters\n    # Grid for radiation integrals (Huygens surface source points)\n    N_theta_prime = 2001\n    theta_prime_grid = np.linspace(0, np.pi, N_theta_prime)\n\n    # Grid for far-field power integration (observer points)\n    N_theta_obs = 1001\n    theta_obs_grid = np.linspace(0, np.pi, N_theta_obs)\n    \n    results = []\n    \n    for case in test_cases:\n        f, I0, l_ratio, a_ratio, R_ratio = case\n        \n        # Calculate derived parameters\n        lambda_ = C0 / f\n        k = 2.0 * np.pi / lambda_\n        omega = 2.0 * np.pi * f\n        dipole_length = l_ratio * lambda_\n        huygens_radius = a_ratio * lambda_\n        obs_radius = R_ratio * lambda_\n\n        # --- 1. Compute Input Power (P_in) ---\n        # Power is integrated over the Huygens surface at r = a.\n        # E_theta = eta0 * H_phi for the assumed far-zone fields on the surface.\n        # S_r = 0.5 * Re(E_theta * H_phi*) = 0.5 * eta0 * |H_phi|^2\n        # H_phi(a, theta') = (j*k*I0*l / (4*pi*a)) * sin(theta') * exp(-jka)\n        H_phi_amp = (k * I0 * dipole_length) / (4.0 * np.pi * huygens_radius)\n        \n        # Integrand for P_in\n        integrand_Pin = (0.5 * ETA0 * (H_phi_amp * np.sin(theta_prime_grid))**2 * \n                         huygens_radius**2 * np.sin(theta_prime_grid))\n        \n        # P_in is integral over theta' from 0 to pi, and over phi' from 0 to 2pi.\n        # The phi' integral gives 2pi.\n        P_in = 2.0 * np.pi * np.trapz(integrand_Pin, theta_prime_grid)\n\n        # --- 2. Compute Far-Field Power (P_ff) ---\n        E_far_theta = np.zeros(N_theta_obs, dtype=np.complex128)\n\n        # Pre-calculate source field amplitudes on the Huygens surface\n        H_phi_complex_amp = (1j * k * I0 * dipole_length / (4.0 * np.pi * huygens_radius) *\n                             np.exp(-1j * k * huygens_radius))\n        E_theta_complex_amp = ETA0 * H_phi_complex_amp\n\n        # Pre-calculate radiation vector coefficients\n        coeff_N = -H_phi_complex_amp * huygens_radius**2\n        coeff_M = -E_theta_complex_amp * huygens_radius**2\n        \n        # Vectorized grid calculations for the integration over theta'\n        sin_theta_p = np.sin(theta_prime_grid)\n        cos_theta_p = np.cos(theta_prime_grid)\n\n        for i, theta_obs in enumerate(theta_obs_grid):\n            # Phase term depends on observer angle theta_obs and source angle theta_p\n            sin_theta_o = np.sin(theta_obs)\n            cos_theta_o = np.cos(theta_obs)\n            \n            # Argument for Bessel functions\n            z_bessel = k * huygens_radius * sin_theta_o * sin_theta_p\n            \n            # Phase term from the exponent\n            exp_term = np.exp(1j * k * huygens_radius * cos_theta_o * cos_theta_p)\n            \n            # Evaluate Bessel functions on the grid points\n            j0_vals = special.j0(z_bessel)\n            j1_vals = special.j1(z_bessel)\n            \n            # Integrands for N_x, N_z, and L_y (others are zero by symmetry)\n            # These are evaluated on the theta_prime_grid\n            integrand_Nx = cos_theta_p * sin_theta_p * (2.0 * np.pi * 1j * j1_vals) * exp_term\n            integrand_Nz = -sin_theta_p**2 * (2.0 * np.pi * j0_vals) * exp_term\n            integrand_Ly = sin_theta_p * (2.0 * np.pi * 1j * j1_vals) * exp_term\n                                            \n            # Numerical integration over theta'\n            integral_Nx = np.trapz(integrand_Nx * sin_theta_p, theta_prime_grid)\n            integral_Nz = np.trapz(integrand_Nz * sin_theta_p, theta_prime_grid)\n            integral_Ly = np.trapz(integrand_Ly * sin_theta_p, theta_prime_grid)\n\n            # Compute radiation vector components\n            Nx = coeff_N * integral_Nx\n            Nz = coeff_N * integral_Nz\n            Ly = coeff_M * integral_Ly\n\n            # Spherical components in observer frame\n            N_theta = Nx * cos_theta_o - Nz * sin_theta_o\n            L_phi = Ly\n            \n            # Far-field E_theta component\n            E_far_theta[i] = (-1j * k * np.exp(-1j * k * obs_radius) / (4.0 * np.pi * obs_radius) *\n                              (L_phi + ETA0 * N_theta))\n        \n        # Far-field power density\n        S_far_density = (1.0 / (2.0 * ETA0)) * np.abs(E_far_theta)**2\n        \n        # Total far-field power by integrating density over the large sphere\n        integrand_Pff = S_far_density * obs_radius**2 * np.sin(theta_obs_grid)\n        P_ff = 2.0 * np.pi * np.trapz(integrand_Pff, theta_obs_grid)\n        \n        # --- 3. Compute Relative Error ---\n        if P_in == 0:\n            relative_error = np.inf if P_ff != 0 else 0\n        else:\n            relative_error = np.abs(P_ff - P_in) / P_in\n            \n        results.append(relative_error)\n    \n    # Print the final result in the specified format\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```"
        }
    ]
}