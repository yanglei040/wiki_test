{
    "hands_on_practices": [
        {
            "introduction": "Before applying any numerical method, it is crucial to understand how to structure the core computation. This first practice focuses on the algebraic backbone of the implicit Newmark methods. By rearranging the fundamental update rules for a general linear system, you will derive the \"effective system\" that must be solved at each time step, a foundational skill for any implementation .",
            "id": "3424180",
            "problem": "Consider the semi-discrete form of a linear elastodynamic Partial Differential Equation (PDE), obtained after spatial discretization, which yields the second-order Ordinary Differential Equation (ODE)\n$$\nM \\ddot{q}(t) + C \\dot{q}(t) + K q(t) = f(t),\n$$\nwhere $M$, $C$, and $K$ are the mass, damping, and stiffness matrices, respectively, and $q(t)$ is the generalized displacement vector. Assume $M$ is symmetric positive definite, $C$ is symmetric positive semidefinite, $K$ is symmetric positive semidefinite, and $f(t)$ is sufficiently smooth. Let the time grid be $t_{n} = t_{0} + n\\,\\Delta t$ with time step $\\Delta t  0$. The Newmark family of time integration methods defines updates through parameters $\\beta$ and $\\gamma$ by the relations\n$$\nq_{n+1} = q_{n} + \\Delta t\\,\\dot{q}_{n} + \\Delta t^{2}\\left(\\tfrac{1}{2} - \\beta\\right)\\ddot{q}_{n} + \\Delta t^{2}\\beta\\,\\ddot{q}_{n+1},\n$$\n$$\n\\dot{q}_{n+1} = \\dot{q}_{n} + \\Delta t\\,(1 - \\gamma)\\,\\ddot{q}_{n} + \\Delta t\\,\\gamma\\,\\ddot{q}_{n+1}.\n$$\nAt time $t_{n+1}$, the semi-discrete balance reads\n$$\nM \\ddot{q}_{n+1} + C \\dot{q}_{n+1} + K q_{n+1} = f_{n+1},\n$$\nwhere $f_{n+1} := f(t_{n+1})$. Starting from the above fundamental relations and without assuming any additional shortcut formulas, derive the effective linear system for the unknown acceleration $\\ddot{q}_{n+1}$ in the form\n$$\nM_{\\text{eff}}\\,\\ddot{q}_{n+1} = f_{\\text{eff}},\n$$\nand explicitly identify the effective mass $M_{\\text{eff}}$, the effective damping contribution associated with the Newmark parameter $\\gamma$ and time step $\\Delta t$, and the effective right-hand side $f_{\\text{eff}}$ in terms of $\\beta$, $\\gamma$, and $\\Delta t$, as functions of known quantities $q_{n}$, $\\dot{q}_{n}$, $\\ddot{q}_{n}$, and $f_{n+1}$. Provide these expressions in closed form. Your final answer must be a calculation expressed as analytic expressions. No rounding is required, and no numerical values should be substituted. Present the three requested expressions as a single row using the LaTeX $pmatrix$ environment.",
            "solution": "The problem is valid as it is scientifically grounded in the principles of computational mechanics, well-posed, objective, and self-contained. The task is to derive the effective linear system for the Newmark family of time integration methods.\n\nThe starting point for the derivation consists of three fundamental equations. First, the semi-discrete equation of motion evaluated at time $t_{n+1}$:\n$$\nM \\ddot{q}_{n+1} + C \\dot{q}_{n+1} + K q_{n+1} = f_{n+1}\n$$\nSecond and third, the Newmark update rules for displacement and velocity, which connect the states at time $t_{n+1}$ to the known states at time $t_n$ and the unknown acceleration $\\ddot{q}_{n+1}$:\n$$\nq_{n+1} = q_{n} + \\Delta t\\,\\dot{q}_{n} + \\Delta t^{2}\\left(\\frac{1}{2} - \\beta\\right)\\ddot{q}_{n} + \\Delta t^{2}\\beta\\,\\ddot{q}_{n+1}\n$$\n$$\n\\dot{q}_{n+1} = \\dot{q}_{n} + \\Delta t\\,(1 - \\gamma)\\,\\ddot{q}_{n} + \\Delta t\\,\\gamma\\,\\ddot{q}_{n+1}\n$$\nHere, $q_n, \\dot{q}_n, \\ddot{q}_n$ are the known displacement, velocity, and acceleration vectors at time $t_n$, while $q_{n+1}, \\dot{q}_{n+1}, \\ddot{q}_{n+1}$ are the corresponding vectors at time $t_{n+1}$. The parameters $\\beta$ and $\\gamma$ define the specific method within the Newmark family. The goal is to obtain an equation of the form $M_{\\text{eff}}\\,\\ddot{q}_{n+1} = f_{\\text{eff}}$, which involves only the unknown $\\ddot{q}_{n+1}$ and known quantities.\n\nTo achieve this, we substitute the Newmark update rules into the equation of motion at $t_{n+1}$. We can isolate the terms dependent on the unknown $\\ddot{q}_{n+1}$ from the terms that are explicitly known from the previous time step. Let us rewrite the update rules as:\n$$\nq_{n+1} = \\tilde{q}_{n+1} + \\Delta t^{2}\\beta\\,\\ddot{q}_{n+1}\n$$\n$$\n\\dot{q}_{n+1} = \\tilde{\\dot{q}}_{n+1} + \\Delta t\\,\\gamma\\,\\ddot{q}_{n+1}\n$$\nwhere $\\tilde{q}_{n+1}$ and $\\tilde{\\dot{q}}_{n+1}$ are predictor quantities that depend only on the state at $t_n$:\n$$\n\\tilde{q}_{n+1} := q_{n} + \\Delta t\\,\\dot{q}_{n} + \\Delta t^{2}\\left(\\frac{1}{2} - \\beta\\right)\\ddot{q}_{n}\n$$\n$$\n\\tilde{\\dot{q}}_{n+1} := \\dot{q}_{n} + \\Delta t\\,(1 - \\gamma)\\,\\ddot{q}_{n}\n$$\nNow, substitute the expressions for $q_{n+1}$ and $\\dot{q}_{n+1}$ into the equation of motion:\n$$\nM \\ddot{q}_{n+1} + C \\left( \\tilde{\\dot{q}}_{n+1} + \\Delta t\\,\\gamma\\,\\ddot{q}_{n+1} \\right) + K \\left( \\tilde{q}_{n+1} + \\Delta t^{2}\\beta\\,\\ddot{q}_{n+1} \\right) = f_{n+1}\n$$\nDistributing the matrices $C$ and $K$:\n$$\nM \\ddot{q}_{n+1} + C \\tilde{\\dot{q}}_{n+1} + \\Delta t\\,\\gamma\\,C \\ddot{q}_{n+1} + K \\tilde{q}_{n+1} + \\Delta t^{2}\\beta\\,K \\ddot{q}_{n+1} = f_{n+1}\n$$\nNext, we rearrange this equation by gathering all terms containing the unknown vector $\\ddot{q}_{n+1}$ on the left-hand side and moving all other terms, which are known, to the right-hand side.\n$$\nM \\ddot{q}_{n+1} + \\Delta t\\,\\gamma\\,C \\ddot{q}_{n+1} + \\Delta t^{2}\\beta\\,K \\ddot{q}_{n+1} = f_{n+1} - C \\tilde{\\dot{q}}_{n+1} - K \\tilde{q}_{n+1}\n$$\nFactoring out $\\ddot{q}_{n+1}$ on the left-hand side yields:\n$$\n\\left( M + \\gamma \\Delta t C + \\beta \\Delta t^{2} K \\right) \\ddot{q}_{n+1} = f_{n+1} - C \\tilde{\\dot{q}}_{n+1} - K \\tilde{q}_{n+1}\n$$\nThis equation is in the desired form $M_{\\text{eff}}\\,\\ddot{q}_{n+1} = f_{\\text{eff}}$. From this, we can explicitly identify the requested expressions.\n\nThe effective mass matrix, $M_{\\text{eff}}$, is the matrix coefficient of $\\ddot{q}_{n+1}$:\n$$\nM_{\\text{eff}} = M + \\gamma \\Delta t C + \\beta \\Delta t^{2} K\n$$\nThe problem asks specifically for the \"effective damping contribution associated with the Newmark parameter $\\gamma$ and time step $\\Delta t$\". This corresponds to the term in $M_{\\text{eff}}$ that involves the damping matrix $C$ and the parameter $\\gamma$. This term is:\n$$\n\\gamma \\Delta t C\n$$\nThe effective right-hand side, $f_{\\text{eff}}$, is the entire right-hand side of the rearranged equation. Substituting back the full expressions for the predictor quantities $\\tilde{q}_{n+1}$ and $\\tilde{\\dot{q}}_{n+1}$:\n$$\nf_{\\text{eff}} = f_{n+1} - C \\left( \\dot{q}_{n} + \\Delta t\\,(1 - \\gamma)\\,\\ddot{q}_{n} \\right) - K \\left( q_{n} + \\Delta t\\,\\dot{q}_{n} + \\Delta t^{2}\\left(\\frac{1}{2} - \\beta\\right)\\ddot{q}_{n} \\right)\n$$\nThese three expressions are the required results, derived directly from the fundamental relations of the Newmark method.",
            "answer": "$$\n\\boxed{\\begin{pmatrix} M + \\gamma \\Delta t C + \\beta \\Delta t^{2} K  \\gamma \\Delta t C  f_{n+1} - C \\left( \\dot{q}_{n} + (1 - \\gamma) \\Delta t \\ddot{q}_{n} \\right) - K \\left( q_{n} + \\Delta t \\dot{q}_{n} + \\left(\\frac{1}{2} - \\beta\\right) \\Delta t^{2} \\ddot{q}_{n} \\right) \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "Numerical integrators do not just approximate the continuous world; they create their own discrete one with specific conservation properties. This exercise invites you to think like a designer, working backwards from a desired energy behavior to find the method parameters $(\\gamma, \\beta)$ that can achieve it . This \"inverse problem\" provides profound insight into why certain members of the Newmark family are revered for their excellent long-term stability and energy conservation.",
            "id": "3424131",
            "problem": "Consider the semi-discrete form of the undamped linear elastodynamic Partial Differential Equation (PDE), obtained after spatial discretization, given by $M \\ddot{u}(t) + K u(t) = 0$, where $M \\in \\mathbb{R}^{n \\times n}$ and $K \\in \\mathbb{R}^{n \\times n}$ are symmetric positive definite matrices, $u(t) \\in \\mathbb{R}^{n}$ is the displacement vector, and $\\ddot{u}(t)$ denotes the second time derivative. Denote the velocity by $v(t) = \\dot{u}(t)$. Let the discrete energy at time step $n$ be $E_n = \\tfrac{1}{2} v_n^{\\top} M v_n + \\tfrac{1}{2} u_n^{\\top} K u_n$, and the $M$-norm by $\\|v\\|_{M}^{2} = v^{\\top} M v$. Assume time integration is performed by the Newmark family with parameters $(\\gamma, \\beta)$ and a uniform time step $\\Delta t  0$.\n\nFocus on one invariant modal subspace associated to a generalized eigenpair of $(K, M)$ so that the dynamics reduce to a single degree of freedom $m \\ddot{q}(t) + k q(t) = 0$ with $m  0$, $k  0$, velocity $v(t) = \\dot{q}(t)$, and angular frequency $\\omega^{2} = k/m$. In this subspace, let $E_n = \\tfrac{1}{2} m v_n^{2} + \\tfrac{1}{2} k q_n^{2}$.\n\nStarting from the fundamental laws and definitions above, derive the discrete energy increment $E_{n+1} - E_n$ implied by the Newmark updates and pose the following inverse design: enforce a target stepwise energy law $E_{n+1} - E_n = - \\eta \\|v_{n+1}\\|_{M}^{2}$ for all initial states in the chosen modal subspace and for all time steps $\\Delta t$ in a nonempty interval containing $\\Delta t = 0$. Determine whether there exist parameters $(\\gamma, \\beta)$ and a constant $\\eta$ (independent of the state and $\\Delta t$) that realize this law. If a realization is possible, compute the unique scalar $\\eta$ that can be attained; if the only possible realization forces a specific $\\eta$, report that value. Express your final answer as a single real number, without units. No rounding is required.",
            "solution": "The user wants to determine if there exists a set of parameters $(\\gamma, \\beta)$ for the Newmark time integration family and a constant $\\eta$ such that a specific energy dissipation law is satisfied for a linear, undamped single-degree-of-freedom (SDOF) oscillator.\n\n### Step 1: Problem Validation\n\nThe problem statement has been validated and is found to be scientifically grounded, well-posed, objective, and self-contained. It addresses a standard topic in numerical analysis for partial differential equations (specifically, the time integration of semi-discretized systems) and uses established definitions and formalisms. No flaws were detected. The problem is valid for solution.\n\n### Step 2: Formal Derivation\n\nThe analysis is performed on the single-degree-of-freedom (SDOF) system resulting from modal decomposition. The equation of motion is:\n$$m \\ddot{q}(t) + k q(t) = 0$$\nwhere $m  0$, $k  0$, and the natural angular frequency is $\\omega = \\sqrt{k/m}$. We denote the state at time step $t_n$ by $(q_n, v_n)$, where $v_n = \\dot{q}(t_n)$. The acceleration is $a_n = \\ddot{q}(t_n) = - (k/m) q_n = -\\omega^2 q_n$.\n\nThe Newmark family of methods provides the following update rules for displacement $q$ and velocity $v$ over a time step $\\Delta t$:\n$$q_{n+1} = q_n + \\Delta t v_n + \\Delta t^2 \\left[ \\left(\\frac{1}{2} - \\beta\\right) a_n + \\beta a_{n+1} \\right] \\quad (1)$$\n$$v_{n+1} = v_n + \\Delta t \\left[ (1 - \\gamma) a_n + \\gamma a_{n+1} \\right] \\quad (2)$$\nThe equation of motion must also hold at time step $t_{n+1}$, so $a_{n+1} = -\\omega^2 q_{n+1}$.\n\nThe discrete energy at time step $n$ is given by $E_n = \\frac{1}{2} m v_n^2 + \\frac{1}{2} k q_n^2$. The problem posits a target stepwise energy law:\n$$E_{n+1} - E_n = - \\eta \\|v_{n+1}\\|_{M}^{2}$$\nFor the SDOF system, the mass matrix $M$ corresponds to the scalar mass $m$, so $\\|v_{n+1}\\|_{M}^{2} = m v_{n+1}^2$. The target law becomes:\n$$E_{n+1} - E_n = - \\eta m v_{n+1}^2$$\nSubstituting the definition of energy, we have:\n$$\\left(\\frac{1}{2} m v_{n+1}^2 + \\frac{1}{2} k q_{n+1}^2\\right) - \\left(\\frac{1}{2} m v_n^2 + \\frac{1}{2} k q_n^2\\right) = - \\eta m v_{n+1}^2$$\nThis equation can be rearranged to define a modified energy-like quantity that should be conserved at each step:\n$$\\left(\\frac{1}{2} + \\eta\\right) m v_{n+1}^2 + \\frac{1}{2} k q_{n+1}^2 = \\frac{1}{2} m v_n^2 + \\frac{1}{2} k q_n^2 \\quad (3)$$\nThis relation must hold for all initial states $(q_n, v_n)$ and for all time steps $\\Delta t$ in a non-empty interval containing $\\Delta t = 0$.\n\nTo analyze equation $(3)$, we first express $q_{n+1}$ and $v_{n+1}$ as functions of $q_n$ and $v_n$.\nSubstitute $a_n = -\\omega^2 q_n$ and $a_{n+1} = -\\omega^2 q_{n+1}$ into equations $(1)$ and $(2)$. Let $\\Omega = \\omega \\Delta t$.\nFrom $(1)$:\n$q_{n+1} = q_n + \\Delta t v_n + \\Delta t^2 \\left[ -\\left(\\frac{1}{2} - \\beta\\right) \\omega^2 q_n - \\beta \\omega^2 q_{n+1} \\right]$\n$q_{n+1} (1 + \\beta \\Omega^2) = q_n (1 - (\\frac{1}{2} - \\beta) \\Omega^2) + v_n \\Delta t$\n$$q_{n+1} = \\frac{1}{1 + \\beta \\Omega^2} \\left[ \\left(1 - \\left(\\frac{1}{2} - \\beta\\right) \\Omega^2\\right) q_n + \\Delta t v_n \\right] \\quad (4)$$\nFrom $(2)$:\n$v_{n+1} = v_n + \\Delta t \\left[ -(1-\\gamma)\\omega^2 q_n - \\gamma \\omega^2 q_{n+1} \\right]$\n$$v_{n+1} = v_n - \\frac{\\Omega^2}{\\Delta t} \\left( (1-\\gamma)q_n + \\gamma q_{n+1} \\right) \\quad (5)$$\n\nSubstituting equations $(4)$ and $(5)$ into the target law $(3)$ yields a quadratic form in $q_n$ and $v_n$ that must be an identity.\n$A q_n^2 + B v_n^2 + C q_n v_n = \\frac{1}{2} k q_n^2 + \\frac{1}{2} m v_n^2$\nFor this to hold for all $q_n, v_n$, the coefficients of $q_n^2$, $v_n^2$, and $q_n v_n$ on both sides must be equal. In particular, the coefficient of the cross-term $q_n v_n$ must be zero. Let's analyze this specific constraint.\nThe left-hand side of $(3)$ gives rise to a cross term:\n$$(1+2\\eta) m v_{n+1} v_{n+1} \\text{'s cross-term} + k q_{n+1} q_{n+1} \\text{'s cross-term} = 0$$\nwhere we only consider the parts of the products that contribute to the $q_n v_n$ term.\nLet $q_{n+1} = D_q q_n + D_v v_n$ and $v_{n+1} = C_q q_n + C_v v_n$. The cross-term coefficient equation is:\n$$(1+2\\eta) m (2 C_q C_v) + k (2 D_q D_v) = 0 \\implies (1+2\\eta) m C_q C_v + k D_q D_v = 0 \\quad (6)$$\nFrom $(4)$, we identify:\n$D_q = \\frac{1 - (\\frac{1}{2} - \\beta) \\Omega^2}{1 + \\beta \\Omega^2}$\n$D_v = \\frac{\\Delta t}{1 + \\beta \\Omega^2}$\nAfter substituting $(4)$ into $(5)$ and collecting terms, we find:\n$C_v = \\frac{1 + (\\beta - \\gamma) \\Omega^2}{1 + \\beta \\Omega^2}$\n$C_q = -\\frac{\\Omega^2}{\\Delta t} \\frac{1 + (\\beta - \\frac{\\gamma}{2})\\Omega^2}{1 + \\beta \\Omega^2} = -\\frac{k}{m} \\frac{\\Delta t (1 + (\\beta - \\frac{\\gamma}{2})\\Omega^2)}{1 + \\beta \\Omega^2}$\n\nSubstituting these into equation $(6)$:\n$$ (1+2\\eta) m \\left(-\\frac{k}{m} \\frac{\\Delta t (1 + (\\beta - \\frac{\\gamma}{2})\\Omega^2)}{1 + \\beta \\Omega^2}\\right) \\left(\\frac{1 + (\\beta - \\gamma) \\Omega^2}{1 + \\beta \\Omega^2}\\right) + k \\left(\\frac{1 - (\\frac{1}{2} - \\beta) \\Omega^2}{1 + \\beta \\Omega^2}\\right) \\left(\\frac{\\Delta t}{1 + \\beta \\Omega^2}\\right) = 0 $$\nWe can divide by $k \\Delta t$ and multiply by $(1 + \\beta \\Omega^2)^2$, assuming $\\Delta t \\neq 0$:\n$$ -(1+2\\eta) \\left(1 + \\left(\\beta - \\frac{\\gamma}{2}\\right)\\Omega^2\\right) \\left(1 + (\\beta - \\gamma) \\Omega^2\\right) + \\left(1 - \\left(\\frac{1}{2} - \\beta\\right) \\Omega^2\\right) = 0 \\quad (7)$$\nThis equation is a polynomial in $\\Omega^2$ and must hold for all $\\Omega$ in a neighborhood of $0$. By continuity, it must hold for $\\Omega = 0$ (i.e., $\\Delta t = 0$). Setting $\\Omega=0$ in equation $(7)$:\n$$ -(1+2\\eta) (1)(1) + (1) = 0 $$\n$$ -(1+2\\eta) + 1 = 0 $$\n$$ -2\\eta = 0 $$\nThis implies $\\eta = 0$.\n\nThe condition that the law must hold for all $\\Delta t$ in an interval containing $\\Delta t = 0$ is a powerful constraint. The evaluation at the limit point $\\Delta t = 0$ forces $\\eta$ to be zero. Therefore, if a realization of the proposed energy law is possible under the given conditions, the constant $\\eta$ must uniquely be $0$.\n\nFor completeness, one can verify that a choice of $(\\gamma, \\beta)$ exists. If we set $\\eta=0$ in equation $(7)$, it becomes a polynomial in $\\Omega^2$ that must be identically zero. This means all of its coefficients must be zero. Expanding the polynomial gives conditions on $\\gamma$ and $\\beta$. The only solution that satisfies all coefficient equations is $(\\gamma, \\beta) = (1/2, 1/4)$, which corresponds to the average acceleration method. This method is known to be energy-conserving for linear systems, meaning $E_{n+1} - E_n = 0$. This is consistent with our target law $E_{n+1} - E_n = -\\eta m v_{n+1}^2$ if and only if $\\eta = 0$ (for non-trivial motion where $v_{n+1} \\neq 0$).\n\nThus, a realization is possible, and the unique value for $\\eta$ is $0$.",
            "answer": "$$\\boxed{0}$$"
        },
        {
            "introduction": "The final step in mastering a numerical method is learning how to make it work smarter, not just harder. Instead of using a fixed time step, advanced algorithms adapt the step size to meet a prescribed error tolerance, ensuring both efficiency and reliability. This practice challenges you to derive an a priori estimate for the one-step energy error and use it to build an adaptive time-stepping controller, a powerful technique that brings together theoretical analysis and practical algorithm design .",
            "id": "3424134",
            "problem": "Consider the semi-discrete second-order linear system obtained from a Partial Differential Equation (PDE) by spatial discretization, modeling undamped linear elastodynamics with no external loading: $$\\mathbf{M}\\,\\ddot{\\mathbf{u}}(t)+\\mathbf{K}\\,\\mathbf{u}(t)=\\mathbf{0},$$ where $\\mathbf{M}\\in\\mathbb{R}^{d\\times d}$ is a symmetric positive definite mass matrix and $\\mathbf{K}\\in\\mathbb{R}^{d\\times d}$ is a symmetric positive semidefinite stiffness matrix. The discrete mechanical energy is $$E(t)=\\tfrac{1}{2}\\,\\dot{\\mathbf{u}}(t)^{\\top}\\mathbf{M}\\,\\dot{\\mathbf{u}}(t)+\\tfrac{1}{2}\\,\\mathbf{u}(t)^{\\top}\\mathbf{K}\\,\\mathbf{u}(t).$$ For the exact solution of the undamped, unforced system, energy is conserved, i.e., $E(t)$ is constant in time.\n\nTime integration is performed using the Newmark family of methods with parameters $\\beta\\in\\mathbb{R}$ and $\\gamma\\in\\mathbb{R}$, applied to the second-order system. For a given time step $\\Delta t_n0$, the internal algorithmic state at time $t_n$ is $\\mathbf{u}_n:=\\mathbf{u}(t_n)$, $\\mathbf{v}_n:=\\dot{\\mathbf{u}}(t_n)$, and $\\mathbf{a}_n:=\\ddot{\\mathbf{u}}(t_n)$. The method constructs $\\mathbf{u}_{n+1}$, $\\mathbf{v}_{n+1}$, and $\\mathbf{a}_{n+1}$ at time $t_{n+1}:=t_n+\\Delta t_n$ via the Newmark update rules, and in the undamped, unforced case the equilibrium relation $\\mathbf{M}\\,\\mathbf{a}_{n+1}+\\mathbf{K}\\,\\mathbf{u}_{n+1}=\\mathbf{0}$.\n\nYour task is to design an energy-based adaptive step size control that, prior to computing $\\mathbf{u}_{n+1}$ and $\\mathbf{v}_{n+1}$, produces a choice of $\\Delta t_n$ using only the current state $(\\mathbf{u}_n,\\mathbf{v}_n,\\mathbf{a}_n)$, the system matrices $(\\mathbf{M},\\mathbf{K})$, and the Newmark parameters $(\\beta,\\gamma)$, such that a prescribed bound on the one-step numerical energy variation is maintained. Specifically, you must:\n\n- Starting from the Newmark update definitions and Taylor expansions of $\\mathbf{u}(t)$, $\\dot{\\mathbf{u}}(t)$, and $\\ddot{\\mathbf{u}}(t)$ about $t_n$, and using only the governing equation $\\mathbf{M}\\,\\ddot{\\mathbf{u}}+\\mathbf{K}\\,\\mathbf{u}=\\mathbf{0}$ and definitions of higher time derivatives (jerk and snap), derive a leading-order a priori estimate for the magnitude of the one-step energy change $|E_{n+1}-E_n|$ as a function of $\\Delta t_n$, expressed in terms of $\\mathbf{u}_n$, $\\mathbf{v}_n$, $\\mathbf{a}_n$, $\\mathbf{M}$, $\\mathbf{K}$, and $(\\beta,\\gamma)$. The derivation must begin from the fundamental definitions and equations stated, without introducing any shortcut formulas.\n- Based on this leading-order estimate, propose a step selection rule of the form $$\\Delta t_n=\\min\\Big(\\Delta t_{\\max},\\max\\big(\\Delta t_{\\min},\\; \\Phi(\\text{tolerance},\\mathbf{u}_n,\\mathbf{v}_n,\\mathbf{a}_n,\\mathbf{M},\\mathbf{K},\\beta,\\gamma)\\big)\\Big),$$ where $\\Phi$ is a continuous function ensuring that the estimated $|E_{n+1}-E_n|$ does not exceed a given energy tolerance. The rule must be fully explicit in terms of the current state and parameters, and must remain well-defined even when the current state is identically zero.\n\nAssume the commonly used parameter $\\gamma=\\tfrac{1}{2}$, and use the undamped, unforced model $\\mathbf{M}\\,\\ddot{\\mathbf{u}}+\\mathbf{K}\\,\\mathbf{u}=\\mathbf{0}$ throughout. The step size $\\Delta t_n$ must be expressed in seconds.\n\nYour program must implement the derived a priori estimator and the adaptive step selection rule for the following test suite. Each test case provides $\\mathbf{M}$, $\\mathbf{K}$, $(\\mathbf{u}_n,\\mathbf{v}_n,\\mathbf{a}_n)$, $\\beta$, the prescribed energy tolerance, and bounds $(\\Delta t_{\\min},\\Delta t_{\\max})$. For scalar entries, use the units: mass in kilograms, stiffness in Newtons per meter, displacement in meters, velocity in meters per second, acceleration in meters per second squared, energy tolerance in Joules, and step bounds in seconds.\n\nTest suite:\n1. Dimension $d=1$ with $\\mathbf{M}=[1]$ and $\\mathbf{K}=[100]$, state $\\mathbf{u}_n=[0.01]$, $\\mathbf{v}_n=[0.2]$, $\\mathbf{a}_n=[-1]$, parameter $\\beta=\\tfrac{1}{6}$, tolerance $10^{-5}$, $\\Delta t_{\\min}=10^{-5}$, $\\Delta t_{\\max}=10^{-1}$.\n2. Dimension $d=1$ with $\\mathbf{M}=[1]$ and $\\mathbf{K}=[100]$, state $\\mathbf{u}_n=[10^{-6}]$, $\\mathbf{v}_n=[10^{-6}]$, $\\mathbf{a}_n=[-10^{-4}]$, parameter $\\beta=0$, tolerance $10^{-6}$, $\\Delta t_{\\min}=10^{-6}$, $\\Delta t_{\\max}=5\\times 10^{-1}$.\n3. Dimension $d=2$ with $\\mathbf{M}=\\operatorname{diag}(1,2)$ and $$\\mathbf{K}=\\begin{bmatrix}100+50  -50\\\\ -50  50+150\\end{bmatrix}=\\begin{bmatrix}150  -50\\\\ -50  200\\end{bmatrix},$$ state $\\mathbf{u}_n=[0.02,\\,-0.01]^{\\top}$, $\\mathbf{v}_n=[0.1,\\,0.05]^{\\top}$, $\\mathbf{a}_n=-\\mathbf{M}^{-1}\\mathbf{K}\\,\\mathbf{u}_n$, parameter $\\beta=0$, tolerance $10^{-4}$, $\\Delta t_{\\min}=10^{-6}$, $\\Delta t_{\\max}=5\\times 10^{-2}$.\n4. Dimension $d=1$ with $\\mathbf{M}=[1]$ and $\\mathbf{K}=[100]$, state $\\mathbf{u}_n=[0]$, $\\mathbf{v}_n=[0]$, $\\mathbf{a}_n=[0]$, parameter $\\beta=0.2$, tolerance $10^{-8}$, $\\Delta t_{\\min}=10^{-6}$, $\\Delta t_{\\max}=10^{-1}$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, listing the chosen $\\Delta t_n$ (in seconds) for the four test cases in the order given, for example, $[\\Delta t_1,\\Delta t_2,\\Delta t_3,\\Delta t_4]$. All entries must be floating-point numbers.",
            "solution": "The task is to derive an a priori adaptive time step selection rule for the Newmark family of methods applied to the undamped, unforced linear elastodynamics equation, $\\mathbf{M}\\,\\ddot{\\mathbf{u}}(t)+\\mathbf{K}\\,\\mathbf{u}(t)=\\mathbf{0}$. The selection rule must aim to keep the one-step numerical energy change, $|E_{n+1}-E_n|$, below a prescribed tolerance. The derivation must use first principles and the problem specifies the Newmark parameter $\\gamma=\\tfrac{1}{2}$.\n\nFirst, we define the discrete mechanical energy at time step $n$ as\n$$E_n = \\tfrac{1}{2}\\,\\mathbf{v}_n^{\\top}\\mathbf{M}\\,\\mathbf{v}_n+\\tfrac{1}{2}\\,\\mathbf{u}_n^{\\top}\\mathbf{K}\\,\\mathbf{u}_n$$\nwhere $\\mathbf{u}_n$, $\\mathbf{v}_n$ are the numerical approximations of displacement and velocity at time $t_n$. The one-step change in energy is $\\Delta E_n = E_{n+1} - E_n$. Using the identity $b^{\\top}A b - a^{\\top}A a = (b-a)^{\\top}A(b+a)$ for a symmetric matrix $A$, we can write\n$$2\\Delta E_n = (\\mathbf{v}_{n+1}-\\mathbf{v}_n)^{\\top}\\mathbf{M}(\\mathbf{v}_{n+1}+\\mathbf{v}_n) + (\\mathbf{u}_{n+1}-\\mathbf{u}_n)^{\\top}\\mathbf{K}(\\mathbf{u}_{n+1}+\\mathbf{u}_n)$$\nThe numerical solution is assumed to satisfy the discrete equation of motion at time steps $t_n$ and $t_{n+1}$:\n$$\\mathbf{M}\\,\\mathbf{a}_n + \\mathbf{K}\\,\\mathbf{u}_n = \\mathbf{0}$$\n$$\\mathbf{M}\\,\\mathbf{a}_{n+1} + \\mathbf{K}\\,\\mathbf{u}_{n+1} = \\mathbf{0}$$\nUsing these relations, we can substitute $\\mathbf{K}\\mathbf{u}_n = -\\mathbf{M}\\mathbf{a}_n$ and $\\mathbf{K}\\mathbf{u}_{n+1} = -\\mathbf{M}\\mathbf{a}_{n+1}$ into the expression for $2\\Delta E_n$. Since $\\mathbf{M}$ is symmetric, $\\mathbf{u}^{\\top}\\mathbf{K}\\mathbf{u} = \\mathbf{u}^{\\top}(-\\mathbf{M}\\mathbf{a}) = -(\\mathbf{M}\\mathbf{u})^{\\top}\\mathbf{a}$. This seems to lead to complications. A more direct path is to substitute into the second term of the $2\\Delta E_n$ equation:\n$$(\\mathbf{u}_{n+1}-\\mathbf{u}_n)^{\\top}\\mathbf{K}(\\mathbf{u}_{n+1}+\\mathbf{u}_n) = (\\mathbf{u}_{n+1}-\\mathbf{u}_n)^{\\top}(-\\mathbf{M}\\mathbf{a}_{n+1} - \\mathbf{M}\\mathbf{a}_n) = -(\\mathbf{u}_{n+1}-\\mathbf{u}_n)^{\\top}\\mathbf{M}(\\mathbf{a}_{n+1}+\\mathbf{a}_n)$$\nBy symmetry of $\\mathbf{M}$, this is $-(\\mathbf{a}_{n+1}+\\mathbf{a}_n)^{\\top}\\mathbf{M}(\\mathbf{u}_{n+1}-\\mathbf{u}_n)$. Thus,\n$$2\\Delta E_n = (\\mathbf{v}_{n+1}-\\mathbf{v}_n)^{\\top}\\mathbf{M}(\\mathbf{v}_{n+1}+\\mathbf{v}_n) - (\\mathbf{a}_{n+1}+\\mathbf{a}_n)^{\\top}\\mathbf{M}(\\mathbf{u}_{n+1}-\\mathbf{u}_n)$$\n\nThe Newmark update rules for a time step $\\Delta t_n$ with parameters $\\beta$ and $\\gamma$ are:\n$$ \\mathbf{u}_{n+1} = \\mathbf{u}_n + \\Delta t_n \\mathbf{v}_n + \\Delta t_n^2 \\left[ (\\tfrac{1}{2}-\\beta)\\mathbf{a}_n + \\beta\\mathbf{a}_{n+1} \\right] $$\n$$ \\mathbf{v}_{n+1} = \\mathbf{v}_n + \\Delta t_n \\left[ (1-\\gamma)\\mathbf{a}_n + \\gamma\\mathbf{a}_{n+1} \\right] $$\nThe problem specifies $\\gamma=\\tfrac{1}{2}$. The velocity update simplifies to:\n$$ \\mathbf{v}_{n+1} = \\mathbf{v}_n + \\tfrac{\\Delta t_n}{2}(\\mathbf{a}_n + \\mathbf{a}_{n+1}) \\implies \\mathbf{v}_{n+1}-\\mathbf{v}_n = \\tfrac{\\Delta t_n}{2}(\\mathbf{a}_n + \\mathbf{a}_{n+1}) $$\nSubstituting this into the energy change equation and rearranging terms:\n$$2\\Delta E_n = (\\tfrac{\\Delta t_n}{2}(\\mathbf{a}_n + \\mathbf{a}_{n+1}))^{\\top}\\mathbf{M}(\\mathbf{v}_{n+1}+\\mathbf{v}_n) - (\\mathbf{a}_{n+1}+\\mathbf{a}_n)^{\\top}\\mathbf{M}(\\mathbf{u}_{n+1}-\\mathbf{u}_n)$$\n$$2\\Delta E_n = (\\mathbf{a}_n + \\mathbf{a}_{n+1})^{\\top}\\mathbf{M} \\left[ \\tfrac{\\Delta t_n}{2}(\\mathbf{v}_{n+1}+\\mathbf{v}_n) - (\\mathbf{u}_{n+1}-\\mathbf{u}_n) \\right]$$\nLet's analyze the term in the square brackets. We express everything in terms of the state at $t_n$ and acceleration at $t_{n+1}$.\nFrom the velocity update with $\\gamma=\\tfrac{1}{2}$:\n$$ \\mathbf{v}_{n+1}+\\mathbf{v}_n = 2\\mathbf{v}_n + \\tfrac{\\Delta t_n}{2}(\\mathbf{a}_n + \\mathbf{a}_{n+1}) $$\n$$ \\tfrac{\\Delta t_n}{2}(\\mathbf{v}_{n+1}+\\mathbf{v}_n) = \\Delta t_n\\mathbf{v}_n + \\tfrac{\\Delta t_n^2}{4}(\\mathbf{a}_n + \\mathbf{a}_{n+1}) $$\nFrom the displacement update:\n$$ \\mathbf{u}_{n+1}-\\mathbf{u}_n = \\Delta t_n \\mathbf{v}_n + \\Delta t_n^2 \\left[ (\\tfrac{1}{2}-\\beta)\\mathbf{a}_n + \\beta\\mathbf{a}_{n+1} \\right] $$\nSubtracting the two expressions, the term $\\Delta t_n\\mathbf{v}_n$ cancels:\n$$ \\tfrac{\\Delta t_n}{2}(\\mathbf{v}_{n+1}+\\mathbf{v}_n) - (\\mathbf{u}_{n+1}-\\mathbf{u}_n) = \\Delta t_n^2 \\left[ \\tfrac{1}{4}(\\mathbf{a}_n + \\mathbf{a}_{n+1}) - ((\\tfrac{1}{2}-\\beta)\\mathbf{a}_n + \\beta\\mathbf{a}_{n+1}) \\right] $$\n$$ = \\Delta t_n^2 \\left[ (\\tfrac{1}{4} - \\tfrac{1}{2} + \\beta)\\mathbf{a}_n + (\\tfrac{1}{4} - \\beta)\\mathbf{a}_{n+1} \\right] = \\Delta t_n^2 (\\beta - \\tfrac{1}{4}) (\\mathbf{a}_n - \\mathbf{a}_{n+1}) $$\nSubstituting this back into the expression for $2\\Delta E_n$:\n$$ 2\\Delta E_n = (\\mathbf{a}_n + \\mathbf{a}_{n+1})^{\\top}\\mathbf{M} \\left[ \\Delta t_n^2 (\\beta - \\tfrac{1}{4}) (\\mathbf{a}_n - \\mathbf{a}_{n+1}) \\right] $$\n$$ 2\\Delta E_n = \\Delta t_n^2 (\\beta - \\tfrac{1}{4}) (\\mathbf{a}_n^{\\top} + \\mathbf{a}_{n+1}^{\\top})\\mathbf{M}(\\mathbf{a}_n - \\mathbf{a}_{n+1}) = \\Delta t_n^2 (\\beta - \\tfrac{1}{4}) (\\mathbf{a}_n^{\\top}\\mathbf{M}\\mathbf{a}_n - \\mathbf{a}_{n+1}^{\\top}\\mathbf{M}\\mathbf{a}_{n+1}) $$\nThis gives an exact expression for the algorithmic energy change. However, it depends on $\\mathbf{a}_{n+1}$, making it an a posteriori quantity. For an a priori estimate, we approximate $\\mathbf{a}_{n+1}$ using a Taylor series expansion around $t_n$: $\\mathbf{a}_{n+1} \\approx \\mathbf{a}_n + \\Delta t_n \\mathbf{j}_n$, where $\\mathbf{j}_n = \\dddot{\\mathbf{u}}(t_n)$ is the jerk at $t_n$.\nThe governing equation $\\mathbf{M}\\ddot{\\mathbf{u}}+\\mathbf{K}\\mathbf{u}=\\mathbf{0}$ can be differentiated with respect to time to find an expression for the jerk:\n$$ \\mathbf{M}\\dddot{\\mathbf{u}} + \\mathbf{K}\\dot{\\mathbf{u}} = \\mathbf{0} \\implies \\mathbf{M}\\mathbf{j}_n = -\\mathbf{K}\\mathbf{v}_n $$\nUsing the approximation $\\mathbf{a}_{n+1} \\approx \\mathbf{a}_n + \\Delta t_n \\mathbf{j}_n$ in the bracketed term $(\\mathbf{a}_n - \\mathbf{a}_{n+1}) \\approx -\\Delta t_n \\mathbf{j}_n$ and $(\\mathbf{a}_n + \\mathbf{a}_{n+1}) \\approx 2\\mathbf{a}_n$.\n$$ 2\\Delta E_n \\approx \\Delta t_n^2 (\\beta - \\tfrac{1}{4}) (2\\mathbf{a}_n^{\\top})\\mathbf{M}(-\\Delta t_n \\mathbf{j}_n) = -2\\Delta t_n^3 (\\beta - \\tfrac{1}{4}) \\mathbf{a}_n^{\\top}\\mathbf{M}\\mathbf{j}_n $$\n$$ \\Delta E_n \\approx -\\Delta t_n^3 (\\beta - \\tfrac{1}{4}) \\mathbf{a}_n^{\\top}\\mathbf{M}\\mathbf{j}_n $$\nSubstituting $\\mathbf{M}\\mathbf{j}_n = -\\mathbf{K}\\mathbf{v}_n$:\n$$ \\Delta E_n \\approx -\\Delta t_n^3 (\\beta - \\tfrac{1}{4}) \\mathbf{a}_n^{\\top}(-\\mathbf{K}\\mathbf{v}_n) = \\Delta t_n^3 (\\beta - \\tfrac{1}{4}) \\mathbf{a}_n^{\\top}\\mathbf{K}\\mathbf{v}_n $$\nThis is the desired leading-order a priori estimate for the one-step energy change.\n\nTo control the step size, we enforce the condition that the magnitude of the estimated energy change does not exceed a tolerance, denoted `tol`:\n$$ |\\Delta E_n| \\approx \\Delta t_n^3 |\\beta - \\tfrac{1}{4}| |\\mathbf{a}_n^{\\top}\\mathbf{K}\\mathbf{v}_n| \\le \\text{tol} $$\nSolving for $\\Delta t_n$:\n$$ \\Delta t_n \\le \\left( \\frac{\\text{tol}}{|\\beta - \\tfrac{1}{4}| |\\mathbf{a}_n^{\\top}\\mathbf{K}\\mathbf{v}_n|} \\right)^{1/3} $$\nThis forms the basis for our step selection function $\\Phi$. We define the candidate step size as:\n$$ \\Delta t_{\\text{cand}} = \\left( \\frac{\\text{tol}}{|\\beta - \\frac{1}{4}| |\\mathbf{a}_n^{\\top}\\mathbf{K}\\mathbf{v}_n|} \\right)^{1/3} $$\nThis expression requires special handling for two cases:\n1.  If $\\beta = \\tfrac{1}{4}$ (the average acceleration method), the denominator is zero. In this case, the method is energy-conserving for linear systems, so the estimate for $\\Delta E_n$ is zero. A large time step is permissible, so we can choose $\\Delta t_{\\text{cand}} = \\Delta t_{\\max}$.\n2.  If the scalar term $|\\mathbf{a}_n^{\\top}\\mathbf{K}\\mathbf{v}_n|$ is zero (e.g., if the system is at rest, $\\mathbf{v}_n=\\mathbf{0}$ and $\\mathbf{a}_n=\\mathbf{0}$), the denominator is also zero. In this state, the energy is constant, so again we can choose $\\Delta t_{\\text{cand}} = \\Delta t_{\\max}$.\n\nCombining these, we define a factor $C = |\\beta - \\frac{1}{4}| |\\mathbf{a}_n^{\\top}\\mathbf{K}\\mathbf{v}_n|$. If $C$ is close to zero, we set $\\Delta t_{\\text{cand}} = \\Delta t_{\\max}$. Otherwise, we use the formula above. The final step size $\\Delta t_n$ is obtained by clamping this candidate step within the prescribed bounds $[\\Delta t_{\\min}, \\Delta t_{\\max}]$:\n$$ \\Delta t_n = \\min\\big(\\Delta t_{\\max}, \\max(\\Delta t_{\\min}, \\Delta t_{\\text{cand}})\\big) $$\nThis is equivalent to $\\Delta t_n = \\max(\\Delta t_{\\min}, \\min(\\Delta t_{\\text{cand}}, \\Delta t_{\\max}))$, which is implemented below.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main solver function that processes all test cases.\n    \"\"\"\n\n    # Test cases defined in the problem statement.\n    test_cases = [\n        {\n            \"M\": np.array([[1.0]]),\n            \"K\": np.array([[100.0]]),\n            \"u_n\": np.array([0.01]),\n            \"v_n\": np.array([0.2]),\n            \"a_n\": np.array([-1.0]),\n            \"beta\": 1.0/6.0,\n            \"tol\": 1e-5,\n            \"dt_min\": 1e-5,\n            \"dt_max\": 1e-1\n        },\n        {\n            \"M\": np.array([[1.0]]),\n            \"K\": np.array([[100.0]]),\n            \"u_n\": np.array([1e-6]),\n            \"v_n\": np.array([1e-6]),\n            \"a_n\": np.array([-1e-4]),\n            \"beta\": 0.0,\n            \"tol\": 1e-6,\n            \"dt_min\": 1e-6,\n            \"dt_max\": 0.5\n        },\n        {\n            \"M\": np.diag([1.0, 2.0]),\n            \"K\": np.array([[150.0, -50.0], [-50.0, 200.0]]),\n            \"u_n\": np.array([0.02, -0.01]),\n            \"v_n\": np.array([0.1, 0.05]),\n            \"a_n\": None,  # To be computed\n            \"beta\": 0.0,\n            \"tol\": 1e-4,\n            \"dt_min\": 1e-6,\n            \"dt_max\": 0.05\n        },\n        {\n            \"M\": np.array([[1.0]]),\n            \"K\": np.array([[100.0]]),\n            \"u_n\": np.array([0.0]),\n            \"v_n\": np.array([0.0]),\n            \"a_n\": np.array([0.0]),\n            \"beta\": 0.2,\n            \"tol\": 1e-8,\n            \"dt_min\": 1e-6,\n            \"dt_max\": 1e-1\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        dt = calculate_dt(case)\n        results.append(dt)\n\n    print(f\"[{','.join(f'{r:.17f}' for r in results)}]\")\n\n\ndef calculate_dt(case):\n    \"\"\"\n    Implements the derived adaptive step selection rule for a single test case.\n    \n    The rule is based on the a priori estimate of the one-step energy change:\n    ΔE_n ≈ Δt_n³ * (β - 1/4) * a_nᵀ * K * v_n\n    \n    The step size Δt_n is chosen to keep |ΔE_n| ≤ tol, subject to min/max bounds.\n    \"\"\"\n    M = case[\"M\"]\n    K = case[\"K\"]\n    u_n = case[\"u_n\"]\n    v_n = case[\"v_n\"]\n    a_n = case[\"a_n\"]\n    beta = case[\"beta\"]\n    gamma = 0.5  # As specified in the problem\n    tol = case[\"tol\"]\n    dt_min = case[\"dt_min\"]\n    dt_max = case[\"dt_max\"]\n\n    # For Case 3, a_n must be computed from the discrete equilibrium equation.\n    if a_n is None:\n        # Since M is diagonal, its inverse is simple to compute.\n        M_inv = np.linalg.inv(M)\n        a_n = -M_inv @ K @ u_n\n    \n    # The term a_nᵀ * K * v_n is central to the energy change estimate.\n    # Using np.dot for scalar product in 1D and matrix product in 1D.\n    a_n_T_K_v_n = a_n.T @ K @ v_n\n    \n    # Coefficient for the Δt³ term in the energy change estimate\n    beta_coeff = beta - 0.25 # β - 1/4\n    \n    # The denominator of the step size formula\n    # C = |β - 1/4| * |a_nᵀ * K * v_n|\n    denominator = abs(beta_coeff) * abs(a_n_T_K_v_n)\n    \n    # Handle special cases where the denominator is zero or near-zero.\n    # This occurs if β = 1/4 or if a_nᵀ*K*v_n = 0 (e.g., at rest).\n    # In such cases, the estimated energy change is zero (to this order),\n    # so the largest permissible time step is chosen.\n    if denominator  np.finfo(float).eps:\n        dt_cand = dt_max\n    else:\n        # Calculate the candidate step size based on the tolerance constraint.\n        # dt_cand³ = tol / denominator\n        dt_cand = (tol / denominator)**(1.0/3.0)\n        \n    # Apply the bounds [Δt_min, Δt_max] to the candidate step size.\n    # This is done by clamping dt_cand within the specified interval.\n    dt_final = max(dt_min, min(dt_cand, dt_max))\n    \n    return dt_final\n\n\nsolve()\n```"
        }
    ]
}