{
    "hands_on_practices": [
        {
            "introduction": "To solve partial differential equations on non-Cartesian grids, we must first understand how the coordinate transformation affects our fundamental measures of distance and orientation. This is captured by the metric tensor, $g_{ij}$. This first practice grounds these abstract concepts by asking you to derive the metric tensor components for the familiar polar coordinate system directly from their fundamental definitions, reinforcing the connection between the mapping and the geometry .",
            "id": "3375279",
            "problem": "Consider a two-dimensional curvilinear coordinate mapping from polar coordinates $(r,\\theta)$ to Cartesian coordinates $(x,y)$ given by $(x,y)=(r\\cos\\theta,r\\sin\\theta)$ on the punctured plane $r>0$. In the context of transforming partial differential equations (PDE) between coordinate systems for numerical solution on curvilinear grids, start from the following fundamental base:\n\n- The covariant basis vectors are defined by $\\boldsymbol{a}_{i}=\\partial\\boldsymbol{x}/\\partial\\xi^{i}$, where $\\boldsymbol{x}=(x,y)$ and $\\xi^{1}=r$, $\\xi^{2}=\\theta$.\n- The covariant metric tensor components are defined by $g_{ij}=\\boldsymbol{a}_{i}\\cdot\\boldsymbol{a}_{j}$.\n- The contravariant metric tensor components are defined by $g^{ij}$ such that $g^{ik}g_{kj}=\\delta^{i}_{\\;j}$, where $\\delta^{i}_{\\;j}$ is the Kronecker delta.\n- For orthogonal coordinates, the scale factors are $h_{i}=\\sqrt{g_{ii}}$.\n\nUsing only these definitions, derive the covariant metric tensor $g_{ij}(r,\\theta)$ and its inverse $g^{ij}(r,\\theta)$ for the given mapping, and recover the scale factors $h_{r}$ and $h_{\\theta}$. Assume $\\theta$ is measured in radians. Express your final answer as a single row matrix listing, in order,\n$g_{rr}$, $g_{r\\theta}$, $g_{\\theta r}$, $g_{\\theta\\theta}$, $g^{rr}$, $g^{r\\theta}$, $g^{\\theta r}$, $g^{\\theta\\theta}$, $h_{r}$, $h_{\\theta}$.\nNo rounding is required.",
            "solution": "The problem is validated as self-contained, scientifically grounded, and well-posed. The task is to derive the covariant and contravariant metric tensors, along with the scale factors, for a polar coordinate system based on fundamental definitions.\n\nThe Cartesian coordinates $(x,y)$ are given as functions of the curvilinear coordinates $(\\xi^{1}, \\xi^{2}) = (r, \\theta)$ by the mapping:\n$$x(r,\\theta) = r\\cos\\theta$$\n$$y(r,\\theta) = r\\sin\\theta$$\nThe position vector $\\boldsymbol{x}$ in the Cartesian basis $(\\boldsymbol{i}, \\boldsymbol{j})$ is therefore:\n$$\\boldsymbol{x}(r, \\theta) = (r\\cos\\theta)\\boldsymbol{i} + (r\\sin\\theta)\\boldsymbol{j}$$\n\nThe covariant basis vectors, $\\boldsymbol{a}_{i} = \\frac{\\partial\\boldsymbol{x}}{\\partial\\xi^{i}}$, are calculated by taking partial derivatives of the position vector with respect to each curvilinear coordinate.\n\nFor $\\xi^{1} = r$:\n$$\\boldsymbol{a}_{1} = \\boldsymbol{a}_{r} = \\frac{\\partial\\boldsymbol{x}}{\\partial r} = \\frac{\\partial}{\\partial r}\\left((r\\cos\\theta)\\boldsymbol{i} + (r\\sin\\theta)\\boldsymbol{j}\\right) = (\\cos\\theta)\\boldsymbol{i} + (\\sin\\theta)\\boldsymbol{j}$$\n\nFor $\\xi^{2} = \\theta$:\n$$\\boldsymbol{a}_{2} = \\boldsymbol{a}_{\\theta} = \\frac{\\partial\\boldsymbol{x}}{\\partial \\theta} = \\frac{\\partial}{\\partial \\theta}\\left((r\\cos\\theta)\\boldsymbol{i} + (r\\sin\\theta)\\boldsymbol{j}\\right) = (-r\\sin\\theta)\\boldsymbol{i} + (r\\cos\\theta)\\boldsymbol{j}$$\n\nThe components of the covariant metric tensor, $g_{ij} = \\boldsymbol{a}_{i} \\cdot \\boldsymbol{a}_{j}$, are found by computing the dot products of these basis vectors.\n\nComponent $g_{11} = g_{rr}$:\n$$g_{rr} = \\boldsymbol{a}_{r} \\cdot \\boldsymbol{a}_{r} = ((\\cos\\theta)\\boldsymbol{i} + (\\sin\\theta)\\boldsymbol{j}) \\cdot ((\\cos\\theta)\\boldsymbol{i} + (\\sin\\theta)\\boldsymbol{j})$$\n$$g_{rr} = \\cos^{2}\\theta + \\sin^{2}\\theta = 1$$\n\nComponent $g_{12} = g_{r\\theta}$:\n$$g_{r\\theta} = \\boldsymbol{a}_{r} \\cdot \\boldsymbol{a}_{\\theta} = ((\\cos\\theta)\\boldsymbol{i} + (\\sin\\theta)\\boldsymbol{j}) \\cdot ((-r\\sin\\theta)\\boldsymbol{i} + (r\\cos\\theta)\\boldsymbol{j})$$\n$$g_{r\\theta} = (\\cos\\theta)(-r\\sin\\theta) + (\\sin\\theta)(r\\cos\\theta) = -r\\cos\\theta\\sin\\theta + r\\sin\\theta\\cos\\theta = 0$$\n\nComponent $g_{21} = g_{\\theta r}$:\nThe metric tensor is symmetric, so $g_{\\theta r} = g_{r\\theta}$.\n$$g_{\\theta r} = 0$$\n\nComponent $g_{22} = g_{\\theta\\theta}$:\n$$g_{\\theta\\theta} = \\boldsymbol{a}_{\\theta} \\cdot \\boldsymbol{a}_{\\theta} = ((-r\\sin\\theta)\\boldsymbol{i} + (r\\cos\\theta)\\boldsymbol{j}) \\cdot ((-r\\sin\\theta)\\boldsymbol{i} + (r\\cos\\theta)\\boldsymbol{j})$$\n$$g_{\\theta\\theta} = (-r\\sin\\theta)^{2} + (r\\cos\\theta)^{2} = r^{2}\\sin^{2}\\theta + r^{2}\\cos^{2}\\theta = r^{2}(\\sin^{2}\\theta + \\cos^{2}\\theta) = r^{2}$$\n\nThe covariant metric tensor, represented as a matrix, is:\n$$[g_{ij}] = \\begin{pmatrix} g_{rr} & g_{r\\theta} \\\\ g_{\\theta r} & g_{\\theta\\theta} \\end{pmatrix} = \\begin{pmatrix} 1 & 0 \\\\ 0 & r^{2} \\end{pmatrix}$$\nSince the off-diagonal components ($g_{r\\theta}$, $g_{\\theta r}$) are zero, the coordinate system is orthogonal.\n\nThe contravariant metric tensor, $[g^{ij}]$, is the inverse of the covariant metric tensor, $[g_{ij}]$. For a $2 \\times 2$ diagonal matrix, the inverse is found by taking the reciprocal of each diagonal element.\n$$[g^{ij}] = [g_{ij}]^{-1} = \\begin{pmatrix} 1 & 0 \\\\ 0 & r^{2} \\end{pmatrix}^{-1} = \\begin{pmatrix} 1^{-1} & 0 \\\\ 0 & (r^{2})^{-1} \\end{pmatrix} = \\begin{pmatrix} 1 & 0 \\\\ 0 & \\frac{1}{r^{2}} \\end{pmatrix}$$\nThe components of the contravariant metric tensor are:\n$$g^{rr} = 1$$\n$$g^{r\\theta} = 0$$\n$$g^{\\theta r} = 0$$\n$$g^{\\theta\\theta} = \\frac{1}{r^{2}}$$\n\nFinally, for orthogonal coordinates, the scale factors $h_{i}$ are defined as $h_{i} = \\sqrt{g_{ii}}$.\nThe scale factor for the $r$-coordinate is:\n$$h_{r} = \\sqrt{g_{rr}} = \\sqrt{1} = 1$$\nThe scale factor for the $\\theta$-coordinate is:\n$$h_{\\theta} = \\sqrt{g_{\\theta\\theta}} = \\sqrt{r^{2}}$$\nGiven the problem statement specifies $r>0$, we have $|r|=r$.\n$$h_{\\theta} = r$$\n\nThe required quantities in the specified order are:\n$g_{rr} = 1$\n$g_{r\\theta} = 0$\n$g_{\\theta r} = 0$\n$g_{\\theta\\theta} = r^{2}$\n$g^{rr} = 1$\n$g^{r\\theta} = 0$\n$g^{\\theta r} = 0$\n$g^{\\theta\\theta} = \\frac{1}{r^{2}}$\n$h_{r} = 1$\n$h_{\\theta} = r$",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n1 & 0 & 0 & r^2 & 1 & 0 & 0 & \\frac{1}{r^2} & 1 & r\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "A coordinate transformation is only useful for numerical simulation if it produces a valid, non-overlapping grid. A mapping that is not one-to-one, or \"injective,\" leads to grid lines crossing and cells turning inside-out, rendering any subsequent calculation meaningless. This exercise explores the critical role of the Jacobian determinant in guaranteeing injectivity, challenging you to determine the limits of grid distortion before a mapping becomes invalid .",
            "id": "3375241",
            "problem": "In the numerical solution of partial differential equations (PDEs), structured curvilinear grids are often constructed via smooth coordinate mappings from a simple reference domain. Consider the mapping from computational coordinates $(\\xi,\\eta) \\in [0,1]^2$ to physical coordinates $(x,y)$ defined by $x=\\xi$ and $y=\\eta+\\epsilon \\sin(\\pi \\xi)\\sin(\\pi \\eta)$, where $\\epsilon \\in \\mathbb{R}$ is a scalar control parameter. Using only the definitions of a Jacobian determinant and the Inverse Function Theorem, and standard facts about trigonometric functions, determine the largest admissible amplitude $\\epsilon_{\\max} > 0$ such that for all $\\epsilon$ with $|\\epsilon| < \\epsilon_{\\max}$, the mapping is injective on the closed unit square and boundary-conformal in the sense that it restricts to a bijection on the boundary that preserves edge correspondence and corner locations. Provide your answer as a single exact expression. No rounding is required.",
            "solution": "The problem requires finding the largest admissible amplitude $\\epsilon_{\\max} > 0$ for a given coordinate mapping to be valid. A mapping is defined as valid if it is injective on the closed unit square and satisfies specific boundary conditions.\n\nThe mapping from computational coordinates $(\\xi, \\eta) \\in [0, 1]^2$ to physical coordinates $(x, y)$ is given by:\n$$x(\\xi, \\eta) = \\xi$$\n$$y(\\xi, \\eta) = \\eta + \\epsilon \\sin(\\pi \\xi) \\sin(\\pi \\eta)$$\nwhere $\\epsilon \\in \\mathbb{R}$ is a control parameter.\n\nFirst, we validate the boundary condition. The problem states that the mapping must be \"boundary-conformal,\" which is defined as restricting to a bijection on the boundary that preserves edge correspondence and corner locations. Let's examine the mapping of the four edges of the computational domain's boundary, $\\partial([0, 1]^2)$.\n\n1.  Bottom edge: $\\eta = 0$, $\\xi \\in [0, 1]$.\n    The mapping gives $x = \\xi$ and $y = 0 + \\epsilon \\sin(\\pi \\xi) \\sin(0) = 0$. The image is the line segment from $(0, 0)$ to $(1, 0)$.\n2.  Right edge: $\\xi = 1$, $\\eta \\in [0, 1]$.\n    The mapping gives $x = 1$ and $y = \\eta + \\epsilon \\sin(\\pi) \\sin(\\pi \\eta) = \\eta$. The image is the line segment from $(1, 0)$ to $(1, 1)$.\n3.  Top edge: $\\eta = 1$, $\\xi \\in [0, 1]$.\n    The mapping gives $x = \\xi$ and $y = 1 + \\epsilon \\sin(\\pi \\xi) \\sin(\\pi) = 1$. The image is the line segment from $(1, 1)$ to $(0, 1)$.\n4.  Left edge: $\\xi = 0$, $\\eta \\in [0, 1]$.\n    The mapping gives $x = 0$ and $y = \\eta + \\epsilon \\sin(0) \\sin(\\pi \\eta) = \\eta$. The image is the line segment from $(0, 1)$ to $(0, 0)$.\n\nThe four corners of the computational square map as follows:\n- $(0, 0) \\mapsto (0, 0)$\n- $(1, 0) \\mapsto (1, 0)$\n- $(1, 1) \\mapsto (1, 1)$\n- $(0, 1) \\mapsto (0, 1)$\n\nThe mapping is the identity transformation on the entire boundary of the unit square. This trivially satisfies the condition of being a bijection that preserves edge correspondence and corner locations. Therefore, the boundary condition imposes no restriction on the value of $\\epsilon$.\n\nNext, we address the condition that the mapping must be injective on the closed unit square $[0, 1]^2$. The mapping is continuously differentiable. According to a result related to the Inverse Function Theorem (often known as a global univalence theorem or Hadamard's theorem), a $C^1$ map on a compact, simply connected domain is globally injective if it is injective on the boundary and its Jacobian determinant does not change sign (and is non-zero) in the interior of the domain.\n\nWe have already established injectivity on the boundary. The next step is to compute the Jacobian determinant of the transformation. The Jacobian matrix $\\mathbf{J}$ is given by:\n$$\n\\mathbf{J} = \\begin{pmatrix} \\frac{\\partial x}{\\partial \\xi} & \\frac{\\partial x}{\\partial \\eta} \\\\ \\frac{\\partial y}{\\partial \\xi} & \\frac{\\partial y}{\\partial \\eta} \\end{pmatrix}\n$$\nThe partial derivatives are:\n$\\frac{\\partial x}{\\partial \\xi} = 1$\n$\\frac{\\partial x}{\\partial \\eta} = 0$\n$\\frac{\\partial y}{\\partial \\xi} = \\frac{\\partial}{\\partial \\xi} \\left( \\eta + \\epsilon \\sin(\\pi \\xi) \\sin(\\pi \\eta) \\right) = \\epsilon \\pi \\cos(\\pi \\xi) \\sin(\\pi \\eta)$\n$\\frac{\\partial y}{\\partial \\eta} = \\frac{\\partial}{\\partial \\eta} \\left( \\eta + \\epsilon \\sin(\\pi \\xi) \\sin(\\pi \\eta) \\right) = 1 + \\epsilon \\pi \\sin(\\pi \\xi) \\cos(\\pi \\eta)$\n\nThe Jacobian matrix is:\n$$\n\\mathbf{J} = \\begin{pmatrix} 1 & 0 \\\\ \\epsilon \\pi \\cos(\\pi \\xi) \\sin(\\pi \\eta) & 1 + \\epsilon \\pi \\sin(\\pi \\xi) \\cos(\\pi \\eta) \\end{pmatrix}\n$$\nThe Jacobian determinant, $J$, is:\n$$\nJ(\\xi, \\eta) = \\det(\\mathbf{J}) = (1) \\left( 1 + \\epsilon \\pi \\sin(\\pi \\xi) \\cos(\\pi \\eta) \\right) - (0) \\left( \\epsilon \\pi \\cos(\\pi \\xi) \\sin(\\pi \\eta) \\right)\n$$\n$$\nJ(\\xi, \\eta) = 1 + \\epsilon \\pi \\sin(\\pi \\xi) \\cos(\\pi \\eta)\n$$\nAt any point on the boundary where $\\xi \\in \\{0, 1\\}$, we have $\\sin(\\pi \\xi) = 0$, which makes $J(\\xi, \\eta) = 1$. To ensure the Jacobian determinant does not change sign and is non-vanishing in the interior, we require $J(\\xi, \\eta) > 0$ for all $(\\xi, \\eta) \\in [0, 1]^2$. This gives the inequality:\n$$\n1 + \\epsilon \\pi \\sin(\\pi \\xi) \\cos(\\pi \\eta) > 0\n$$\nTo find the condition on $\\epsilon$ that guarantees this inequality holds everywhere in the domain, we must find the minimum and maximum values of the term $f(\\xi, \\eta) = \\sin(\\pi \\xi) \\cos(\\pi \\eta)$ for $(\\xi, \\eta) \\in [0, 1]^2$.\n\nFor $\\xi \\in [0, 1]$, the term $\\sin(\\pi \\xi)$ ranges from $0$ to $1$.\nFor $\\eta \\in [0, 1]$, the term $\\cos(\\pi \\eta)$ ranges from $-1$ to $1$.\n\nThe maximum value of $f(\\xi, \\eta)$ occurs when $\\sin(\\pi \\xi)$ is at its maximum ($1$) and $\\cos(\\pi \\eta)$ is at its maximum ($1$). This happens at $(\\xi, \\eta) = (\\frac{1}{2}, 0)$, where $f(\\frac{1}{2}, 0) = \\sin(\\frac{\\pi}{2}) \\cos(0) = 1 \\cdot 1 = 1$.\nThe minimum value of $f(\\xi, \\eta)$ occurs when $\\sin(\\pi \\xi)$ is at its maximum ($1$) and $\\cos(\\pi \\eta)$ is at its minimum ($-1$). This happens at $(\\xi, \\eta) = (\\frac{1}{2}, 1)$, where $f(\\frac{1}{2}, 1) = \\sin(\\frac{\\pi}{2}) \\cos(\\pi) = 1 \\cdot (-1) = -1$.\nSo, the range of $f(\\xi, \\eta)$ is $[-1, 1]$.\n\nThe inequality we must satisfy is $\\epsilon \\pi f(\\xi, \\eta) > -1$. We must consider both positive and negative $\\epsilon$.\n\nCase 1: $\\epsilon > 0$.\nThe inequality can be rewritten as $f(\\xi, \\eta) > -\\frac{1}{\\epsilon \\pi}$. This must hold for all values of $f(\\xi, \\eta)$, including its minimum value of $-1$. So we require:\n$$\n-1 > -\\frac{1}{\\epsilon \\pi} \\implies 1 < \\frac{1}{\\epsilon \\pi} \\implies \\epsilon \\pi < 1 \\implies \\epsilon < \\frac{1}{\\pi}\n$$\n\nCase 2: $\\epsilon < 0$.\nLet $\\epsilon = -|\\epsilon|$. The inequality is $1 - |\\epsilon| \\pi f(\\xi, \\eta) > 0$, or $1 > |\\epsilon| \\pi f(\\xi, \\eta)$. This must hold for all values of $f(\\xi, \\eta)$, so it must hold for its maximum value of $1$. We require:\n$$\n1 > |\\epsilon| \\pi (1) \\implies |\\epsilon| < \\frac{1}{\\pi}\n$$\nSince $\\epsilon < 0$, this means $\\epsilon > -\\frac{1}{\\pi}$.\n\nCombining both cases, the condition on $\\epsilon$ for the mapping to be injective is $-\\frac{1}{\\pi} < \\epsilon < \\frac{1}{\\pi}$, which is equivalent to $|\\epsilon| < \\frac{1}{\\pi}$.\n\nThe problem asks for the largest admissible amplitude $\\epsilon_{\\max} > 0$ such that for all $\\epsilon$ with $|\\epsilon| < \\epsilon_{\\max}$, the mapping is valid. Our derived condition is $|\\epsilon| < \\frac{1}{\\pi}$. By direct comparison, we can identify $\\epsilon_{\\max}$ as $\\frac{1}{\\pi}$. If $|\\epsilon| = \\frac{1}{\\pi}$, the Jacobian determinant becomes zero at some point on the boundary, and the condition for injectivity is violated.\n\nTherefore, the largest such amplitude is $\\epsilon_{\\max} = \\frac{1}{\\pi}$.",
            "answer": "$$\\boxed{\\frac{1}{\\pi}}$$"
        },
        {
            "introduction": "Merely having a valid grid is not enough; our numerical scheme must also be consistent with the grid's geometry to avoid introducing artificial sources or sinks. This principle, known as Free-Stream Preservation or the Geometric Conservation Law (GCL), is essential for accuracy, especially in high-order schemes. This advanced practice guides you through a numerical investigation of how inconsistencies between the discretization of metric terms and flux divergences can violate the GCL, and how to implement a crucial correction .",
            "id": "3375264",
            "problem": "Consider the two-dimensional conservative transport of a passive scalar on a smooth curvilinear grid. Let the computational coordinates be $(\\xi,\\eta)\\in[0,1)\\times[0,1)$ with periodic boundaries, and let the mapping to physical space be given by\n$$\nx(\\xi,\\eta) = \\xi + \\alpha \\sin(2\\pi \\xi)\\sin(2\\pi \\eta),\\qquad\ny(\\xi,\\eta) = \\eta + \\alpha \\cos(2\\pi \\xi)\\sin(2\\pi \\eta),\n$$\nfor a prescribed distortion amplitude $\\alpha\\in\\mathbb{R}$. The Jacobian is\n$$\nJ(\\xi,\\eta) = x_\\xi y_\\eta - x_\\eta y_\\xi.\n$$\nFor a constant physical advection velocity $(u,v)\\in\\mathbb{R}^2$ and a conservative formulation in computational space, the equation for a scalar field $q(\\xi,\\eta,t)$ is\n$$\n\\frac{\\partial q}{\\partial t} + \\frac{1}{J}\\left(\\frac{\\partial}{\\partial \\xi}\\big(\\tilde U\\,q\\big)+\\frac{\\partial}{\\partial \\eta}\\big(\\tilde V\\,q\\big)\\right)=0,\n$$\nwhere the contravariant metric-weighted velocity components are\n$$\n\\tilde U = u\\,y_\\eta - v\\,x_\\eta,\\qquad \\tilde V = -u\\,y_\\xi + v\\,x_\\xi.\n$$\nA uniform solution $q(\\xi,\\eta,t)\\equiv q_0$ should be preserved exactly by a consistent discrete scheme; this is known as Free-Stream Preservation (FSP). On a nodal grid with uniform spacing $h_\\xi=h_\\eta=1/N$, let $D_\\xi^{(p)}$ and $D_\\eta^{(p)}$ be periodic central-difference derivative operators of order $p\\in\\{2,4,6\\}$ in $\\xi$ and $\\eta$, respectively. Consider the semi-discrete residual for the uniform state $q\\equiv 1$,\n$$\n\\mathcal{R}=\\frac{1}{J}\\left(D_\\xi^{(p_{\\rm flux})}\\,\\tilde U_m + D_\\eta^{(p_{\\rm flux})}\\,\\tilde V_m\\right),\n$$\nwhere the divergence is computed with order $p_{\\rm flux}$ but the metric terms used to build $\\tilde U_m,\\tilde V_m$ are obtained from discrete derivatives of order $p_{\\rm metric}$, i.e.,\n$$\n\\tilde U_m = u\\,\\big(D_\\eta^{(p_{\\rm metric})}y\\big) - v\\,\\big(D_\\eta^{(p_{\\rm metric})}x\\big),\\qquad\n\\tilde V_m = -u\\,\\big(D_\\xi^{(p_{\\rm metric})}y\\big)+ v\\,\\big(D_\\xi^{(p_{\\rm metric})}x\\big).\n$$\nStarting from the core definitions of coordinate transformations and the conservative transport law, and using only the properties of periodic central-difference operators, you must:\n\n- Derive the discrete FSP condition in terms of the discrete metric identity that must hold to ensure $\\mathcal{R}\\equiv 0$ for $q\\equiv 1$.\n- Explain why a mismatch $p_{\\rm metric}\\neq p_{\\rm flux}$ generically violates this condition.\n- Propose a correction that restores discrete FSP without changing $p_{\\rm flux}$ for the flux divergence.\n\nThen, implement a program that:\n\n- Constructs a uniform periodic grid with $N\\times N$ nodes in $(\\xi,\\eta)$ for specified $N$.\n- Implements $D^{(p)}$ as periodic central differences of order $p\\in\\{2,4,6\\}$ using standard nodal stencils and uniform spacing $h=1/N$.\n- Computes $x(\\xi,\\eta)$ and $y(\\xi,\\eta)$ from the given mapping for a specified $\\alpha$.\n- Forms $\\tilde U_m,\\tilde V_m$ using $p_{\\rm metric}$ and computes the residual $\\mathcal{R}$ using $p_{\\rm flux}$.\n- Quantifies the violation of FSP by returning the maximum absolute value $\\|\\mathcal{R}\\|_\\infty$ over the grid as a floating-point number.\n- Implements your proposed correction and computes the corrected residual $\\mathcal{R}_{\\rm corr}$ and its $\\|\\mathcal{R}_{\\rm corr}\\|_\\infty$.\n\nFor normalization, evaluate $J(\\xi,\\eta)$ analytically from the mapping by differentiating $x(\\xi,\\eta)$ and $y(\\xi,\\eta)$ exactly:\n$$\nx_\\xi=1+\\alpha(2\\pi)\\cos(2\\pi\\xi)\\sin(2\\pi\\eta),\\quad\nx_\\eta=\\alpha(2\\pi)\\sin(2\\pi\\xi)\\cos(2\\pi\\eta),\n$$\n$$\ny_\\xi=-\\alpha(2\\pi)\\sin(2\\pi\\xi)\\sin(2\\pi\\eta),\\quad\ny_\\eta=1+\\alpha(2\\pi)\\cos(2\\pi\\xi)\\cos(2\\pi\\eta),\n$$\nand then $J=x_\\xi y_\\eta - x_\\eta y_\\xi$. All trigonometric functions use angles in radians.\n\nTest Suite. Your program must compute and aggregate the following five cases, reporting each result as a floating-point number:\n\n- Case $1$ (mismatch, happy path): $N=64$, $\\alpha=0.2$, $u=1.0$, $v=0.5$, $p_{\\rm flux}=4$, $p_{\\rm metric}=2$. Report $\\|\\mathcal{R}\\|_\\infty$.\n- Case $2$ (matched orders): $N=64$, $\\alpha=0.2$, $u=1.0$, $v=0.5$, $p_{\\rm flux}=4$, $p_{\\rm metric}=4$. Report $\\|\\mathcal{R}\\|_\\infty$.\n- Case $3$ (stronger mismatch on odd grid): $N=63$, $\\alpha=0.3$, $u=-0.8$, $v=0.3$, $p_{\\rm flux}=6$, $p_{\\rm metric}=2$. Report $\\|\\mathcal{R}\\|_\\infty$.\n- Case $4$ (apply your correction to Case $1$): use $N=64$, $\\alpha=0.2$, $u=1.0$, $v=0.5$, $p_{\\rm flux}=4$, and construct $\\tilde U,\\tilde V$ by your correction. Report $\\|\\mathcal{R}_{\\rm corr}\\|_\\infty$.\n- Case $5$ (edge case, straight grid): $N=32$, $\\alpha=0.0$, $u=1.2$, $v=-0.7$, $p_{\\rm flux}=6$, $p_{\\rm metric}=2$. Report $\\|\\mathcal{R}\\|_\\infty$.\n\nFinal Output Format. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $[{\\rm result}_1,{\\rm result}_2,{\\rm result}_3,{\\rm result}_4,{\\rm result}_5]$). All angles must be interpreted in radians. No physical unit conversion is required, and all results must be printed as floating-point numbers.",
            "solution": "The problem requires a derivation of the condition for Free-Stream Preservation (FSP) for a finite difference scheme on a curvilinear grid, an explanation for its failure when metric and flux derivative operators are inconsistent, and a proposal for a correction. This is to be followed by a numerical implementation to verify the analysis.\n\n### Part 1: Derivation of the Discrete Free-Stream Preservation Condition\n\nThe conservative transport equation for a scalar $q$ in the computational domain $(\\xi,\\eta)$ is given by:\n$$\n\\frac{\\partial q}{\\partial t} + \\frac{1}{J}\\left(\\frac{\\partial}{\\partial \\xi}\\big(\\tilde U\\,q\\big)+\\frac{\\partial}{\\partial \\eta}\\big(\\tilde V\\,q\\big)\\right)=0\n$$\nwhere $\\tilde U = u\\,y_\\eta - v\\,x_\\eta$ and $\\tilde V = -u\\,y_\\xi + v\\,x_\\xi$ are the contravariant metric-weighted velocity components for a constant physical velocity $(u,v)$.\n\nThe principle of Free-Stream Preservation (FSP) requires that a uniform flow field, $q(\\xi,\\eta,t) \\equiv q_0$ (where $q_0$ is a constant), must be an exact steady-state solution to the governing equations. Without loss of generality, we set $q_0=1$. For a steady state, $\\frac{\\partial q}{\\partial t} = 0$. Substituting $q=1$ into the equation yields the continuous FSP condition, often termed the Geometric Conservation Law (GCL):\n$$\n\\frac{1}{J}\\left(\\frac{\\partial \\tilde U}{\\partial \\xi} + \\frac{\\partial \\tilde V}{\\partial \\eta}\\right) = 0 \\implies \\frac{\\partial \\tilde U}{\\partial \\xi} + \\frac{\\partial \\tilde V}{\\partial \\eta} = 0\n$$\nSubstituting the definitions of $\\tilde U$ and $\\tilde V$, and noting that $u$ and $v$ are constants:\n$$\n\\frac{\\partial}{\\partial \\xi}(u\\,y_\\eta - v\\,x_\\eta) + \\frac{\\partial}{\\partial \\eta}(-u\\,y_\\xi + v\\,x_\\xi) = 0\n$$\n$$\nu\\left(\\frac{\\partial y_\\eta}{\\partial \\xi} - \\frac{\\partial y_\\xi}{\\partial \\eta}\\right) - v\\left(\\frac{\\partial x_\\eta}{\\partial \\xi} - \\frac{\\partial x_\\xi}{\\partial \\eta}\\right) = 0\n$$\nBy Clairaut's theorem for smooth mappings $x(\\xi,\\eta)$ and $y(\\xi,\\eta)$, the mixed partial derivatives are equal (e.g., $\\frac{\\partial^2 y}{\\partial \\xi \\partial \\eta} = \\frac{\\partial^2 y}{\\partial \\eta \\partial \\xi}$). This means $\\frac{\\partial y_\\eta}{\\partial \\xi} = \\frac{\\partial y_\\xi}{\\partial \\eta}$ and $\\frac{\\partial x_\\eta}{\\partial \\xi} = \\frac{\\partial x_\\xi}{\\partial \\eta}$. The expression above thus simplifies to $u(0) - v(0) = 0$, which holds true, confirming the continuous GCL.\n\nNow, we analyze the semi-discrete form. The residual for the uniform state $q=1$ is:\n$$\n\\mathcal{R}=\\frac{1}{J}\\left(D_\\xi^{(p_{\\rm flux})}\\,\\tilde U_m + D_\\eta^{(p_{\\rm flux})}\\,\\tilde V_m\\right)\n$$\nwhere $D_\\xi^{(p)}$ and $D_\\eta^{(p)}$ are discrete derivative operators of order $p$, and the discrete metric-weighted velocities are:\n$$\n\\tilde U_m = u\\,\\big(D_\\eta^{(p_{\\rm metric})}y\\big) - v\\,\\big(D_\\eta^{(p_{\\rm metric})}x\\big), \\qquad \\tilde V_m = -u\\,\\big(D_\\xi^{(p_{\\rm metric})}y\\big)+ v\\,\\big(D_\\xi^{(p_{\\rm metric})}x\\big)\n$$\nFor discrete FSP, the residual $\\mathcal{R}$ must be identically zero. This requires the discrete divergence to be zero:\n$$\nD_\\xi^{(p_{\\rm flux})}\\,\\tilde U_m + D_\\eta^{(p_{\\rm flux})}\\,\\tilde V_m = 0\n$$\nSubstituting the expressions for $\\tilde U_m$ and $\\tilde V_m$ and using the linearity of the discrete operators:\n$$\nD_\\xi^{(p_{\\rm flux})}\\left(u(D_\\eta^{(p_{\\rm metric})}y) - v(D_\\eta^{(p_{\\rm metric})}x)\\right) + D_\\eta^{(p_{\\rm flux})}\\left(-u(D_\\xi^{(p_{\\rm metric})}y) + v(D_\\xi^{(p_{\\rm metric})}x)\\right) = 0\n$$\n$$\nu\\left(D_\\xi^{(p_{\\rm flux})}D_\\eta^{(p_{\\rm metric})}y - D_\\eta^{(p_{\\rm flux})}D_\\xi^{(p_{\\rm metric})}y\\right) - v\\left(D_\\xi^{(p_{\\rm flux})}D_\\eta^{(p_{\\rm metric})}x - D_ \\eta^{(p_{\\rm flux})}D_\\xi^{(p_{\\rm metric})}x\\right) = 0\n$$\nSince this relation must hold for any constant velocity $(u,v)$, the coefficients of $u$ and $v$ must be independently zero. This yields the discrete metric identities required for FSP:\n$$\nD_\\xi^{(p_{\\rm flux})}D_\\eta^{(p_{\\rm metric})}y = D_\\eta^{(p_{\\rm flux})}D_\\xi^{(p_{\\rm metric})}y\n$$\n$$\nD_\\xi^{(p_{\\rm flux})}D_\\eta^{(p_{\\rm metric})}x = D_\\eta^{(p_{\\rm flux})}D_\\xi^{(p_{\\rm metric})}x\n$$\nThese equations state that the application of the mixed discrete derivative operators must commute when applied to the grid coordinate functions.\n\n### Part 2: Violation of FSP due to Operator Mismatch\n\nThe discrete metric identities are satisfied if the discrete derivative operators commute. Let's analyze this property. The operators $D_\\xi^{(p)}$ and $D_\\eta^{(p)}$ are linear and act on a periodic grid, so they can be analyzed in Fourier space. A derivative operator $D^{(p)}$ has a Fourier symbol $\\widehat{D^{(p)}}(k,h)$ such that the discrete Fourier transform of $D^{(p)}f$ is $\\widehat{D^{(p)}}(k,h)\\hat{f}(k)$. The symbol for an operator acting along $\\xi$ depends on wavenumber $k_\\xi$, and for an operator along $\\eta$, on $k_\\eta$.\n\nThe operator commutation condition $D_\\xi^{(p_{\\rm flux})}D_\\eta^{(p_{\\rm metric})} = D_\\eta^{(p_{\\rm flux})}D_\\xi^{(p_{\\rm metric})}$ translates in Fourier space to:\n$$\n\\widehat{D^{(p_{\\rm flux})}}(k_\\xi, h)\\widehat{D^{(p_{\\rm metric})}}(k_\\eta, h) = \\widehat{D^{(p_{\\rm flux})}}(k_\\eta, h)\\widehat{D^{(p_{\\rm metric})}}(k_\\xi, h)\n$$\nfor all discrete wavenumbers $k_\\xi, k_\\eta$. Let $F_1(k) = \\widehat{D^{(p_{\\rm flux})}}(k, h)$ and $F_2(k) = \\widehat{D^{(p_{\\rm metric})}}(k, h)$. The condition is $F_1(k_\\xi) F_2(k_\\eta) = F_1(k_\\eta) F_2(k_\\xi)$. This can be rearranged to:\n$$\n\\frac{F_1(k_\\xi)}{F_2(k_\\xi)} = \\frac{F_1(k_\\eta)}{F_2(k_\\eta)}\n$$\nThis equation must hold for all $k_\\xi$ and $k_\\eta$. This is only possible if the ratio $F_1(k)/F_2(k)$ is a constant, independent of the wavenumber $k$.\n\nLet's examine the symbols for the central difference operators of order $p=2, 4$:\n- $p=2$: $\\widehat{D^{(2)}}(k, h) = \\frac{i}{h}\\sin(kh)$\n- $p=4$: $\\widehat{D^{(4)}}(k, h) = \\frac{i}{h}\\left(\\frac{4}{3}\\sin(kh) - \\frac{1}{6}\\sin(2kh)\\right)$\n\nIf $p_{\\rm flux} \\neq p_{\\rm metric}$, say $p_{\\rm flux}=4$ and $p_{\\rm metric}=2$, the ratio is:\n$$\n\\frac{\\widehat{D^{(4)}}(k, h)}{\\widehat{D^{(2)}}(k, h)} = \\frac{\\frac{i}{h}\\left(\\frac{4}{3}\\sin(kh) - \\frac{1}{6}\\sin(2kh)\\right)}{\\frac{i}{h}\\sin(kh)} = \\frac{4}{3} - \\frac{1}{6}\\frac{2\\sin(kh)\\cos(kh)}{\\sin(kh)} = \\frac{4}{3} - \\frac{1}{3}\\cos(kh)\n$$\nThis ratio is a function of the wavenumber $k$ and is not constant. Therefore, the commutation property does not hold, the discrete metric identities are violated, and FSP is lost. A non-zero residual $\\mathcal{R}$ appears, introducing numerical error that can corrupt the solution. FSP is only guaranteed if $p_{\\rm flux} = p_{\\rm metric}$, in which case the ratio is $1$, a constant, and the operators commute trivially.\n\n### Part 3: Correction to Restore FSP\n\nThe issue stems from the fact that the discrete operators used to compute the metrics ($D^{(p_{\\rm metric})}$) and the divergence ($D^{(p_{\\rm flux})}$) are inconsistent, leading to a violation of the discrete GCL. The problem asks for a correction that restores FSP without changing the order of the flux divergence operator, $p_{\\rm flux}$.\n\nThe most direct way to restore FSP is to ensure the discrete metric identities are satisfied. This is achieved by making the operators compatible. My proposed correction is to re-calculate the metric terms using the *same* discrete operator as the one used for the flux divergence. Specifically, we set $p_{\\rm metric} = p_{\\rm flux}$ when constructing the metric-weighted velocities.\n\nThe corrected metric-weighted velocity components, $\\tilde U_{\\rm corr}$ and $\\tilde V_{\\rm corr}$, are thus defined as:\n$$\n\\tilde U_{\\rm corr} = u\\,\\big(D_\\eta^{(p_{\\rm flux})}y\\big) - v\\,\\big(D_\\eta^{(p_{\\rm flux})}x\\big)\n$$\n$$\n\\tilde V_{\\rm corr} = -u\\,\\big(D_\\xi^{(p_{\\rm flux})}y\\big)+ v\\,\\big(D_\\xi^{(p_{\\rm flux})}x\\big)\n$$\nThe residual for the uniform state $q=1$ is then computed as:\n$$\n\\mathcal{R}_{\\rm corr} = \\frac{1}{J}\\left(D_\\xi^{(p_{\\rm flux})}\\,\\tilde U_{\\rm corr} + D_\\eta^{(p_{\\rm flux})}\\,\\tilde V_{\\rm corr}\\right)\n$$\nSubstituting the definitions of the corrected fluxes into the divergence term, we get:\n$$\nu\\left(D_\\xi^{(p_{\\rm flux})}D_\\eta^{(p_{\\rm flux})}y - D_\\eta^{(p_{\\rm flux})}D_\\xi^{(p_{\\rm flux})}y\\right) - v\\left(D_\\xi^{(p_{\\rm flux})}D_\\eta^{(p_{\\rm flux})}x - D_\\eta^{(p_{\\rm flux})}D_\\xi^{(p_{\\rm flux})}x\\right)\n$$\nSince $D_\\xi^{(p_{\\rm flux})}$ and $D_\\eta^{(p_{\\rm flux})}$ are operators of the same type applied along different Cartesian axes of the computational grid, their application commutes: $D_\\xi^{(p)}D_\\eta^{(p)} = D_\\eta^{(p)}D_\\xi^{(p)}$. Therefore, the terms in parentheses are identically zero. The corrected residual $\\mathcal{R}_{\\rm corr}$ will be zero to machine precision, and FSP is restored. This correction does not alter the flux divergence operator $D^{(p_{\\rm flux})}$, but rather modifies its arguments to be consistent with it.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite for Free-Stream Preservation analysis.\n    \"\"\"\n\n    def periodic_central_difference(F, p, axis, h):\n        \"\"\"\n        Computes the periodic central difference of order p on a 2D array F.\n\n        Args:\n            F (np.ndarray): The 2D input field.\n            p (int): The order of accuracy {2, 4, 6}.\n            axis (int): The axis along which to differentiate (0 for xi, 1 for eta).\n            h (float): The uniform grid spacing.\n\n        Returns:\n            np.ndarray: The derivative field.\n        \"\"\"\n        if p == 2:\n            # Stencil weights: [-1/2, 0, 1/2] / h\n            return (np.roll(F, -1, axis=axis) - np.roll(F, 1, axis=axis)) / (2.0 * h)\n        elif p == 4:\n            # Stencil weights: [1/12, -8/12, 0, 8/12, -1/12] / h\n            return (\n                -np.roll(F, -2, axis=axis) + 8 * np.roll(F, -1, axis=axis)\n                - 8 * np.roll(F, 1, axis=axis) + np.roll(F, 2, axis=axis)\n            ) / (12.0 * h)\n        elif p == 6:\n            # Stencil weights: [-1/60, 9/60, -45/60, 0, 45/60, -9/60, 1/60] / h\n            return (\n                np.roll(F, -3, axis=axis)\n                - 9 * np.roll(F, -2, axis=axis)\n                + 45 * np.roll(F, -1, axis=axis)\n                - 45 * np.roll(F, 1, axis=axis)\n                + 9 * np.roll(F, 2, axis=axis)\n                - np.roll(F, 3, axis=axis)\n            ) / (-60.0 * h)\n        else:\n            raise ValueError(f\"Unsupported order p={p}\")\n\n    def compute_fsp_error(N, alpha, u, v, p_flux, p_metric):\n        \"\"\"\n        Computes the maximum absolute FSP residual ||R||_infinity for given parameters.\n        \"\"\"\n        h = 1.0 / N\n        xi_1d = np.arange(N) * h\n        eta_1d = np.arange(N) * h\n        xi, eta = np.meshgrid(xi_1d, eta_1d, indexing='ij')\n\n        # Compute physical coordinates from the mapping\n        x = xi + alpha * np.sin(2 * np.pi * xi) * np.sin(2 * np.pi * eta)\n        y = eta + alpha * np.cos(2 * np.pi * xi) * np.sin(2 * np.pi * eta)\n\n        # Compute analytical Jacobian for normalization\n        x_xi_ana = 1 + alpha * 2 * np.pi * np.cos(2 * np.pi * xi) * np.sin(2 * np.pi * eta)\n        x_eta_ana = alpha * 2 * np.pi * np.sin(2 * np.pi * xi) * np.cos(2 * np.pi * eta)\n        y_xi_ana = -alpha * 2 * np.pi * np.sin(2 * np.pi * xi) * np.sin(2 * np.pi * eta)\n        y_eta_ana = 1 + alpha * 2 * np.pi * np.cos(2 * np.pi * xi) * np.cos(2 * np.pi * eta)\n        J_ana = x_xi_ana * y_eta_ana - x_eta_ana * y_xi_ana\n\n        # Compute discrete metric terms using the specified p_metric operator\n        y_eta_m = periodic_central_difference(y, p_metric, 1, h)\n        x_eta_m = periodic_central_difference(x, p_metric, 1, h)\n        y_xi_m = periodic_central_difference(y, p_metric, 0, h)\n        x_xi_m = periodic_central_difference(x, p_metric, 0, h)\n\n        # Compute discrete contravariant metric-weighted velocity components\n        U_tilde_m = u * y_eta_m - v * x_eta_m\n        V_tilde_m = -u * y_xi_m + v * x_xi_m\n\n        # Compute the divergence term using the specified p_flux operator\n        div_term = (\n            periodic_central_difference(U_tilde_m, p_flux, 0, h) +\n            periodic_central_difference(V_tilde_m, p_flux, 1, h)\n        )\n\n        # Compute the final residual R\n        R = div_term / J_ana\n\n        # Return the infinity norm of the residual\n        return np.max(np.abs(R))\n\n    # Define the test cases from the problem statement.\n    test_cases = {\n        1: {'N': 64, 'alpha': 0.2, 'u': 1.0, 'v': 0.5, 'p_flux': 4, 'p_metric': 2},\n        2: {'N': 64, 'alpha': 0.2, 'u': 1.0, 'v': 0.5, 'p_flux': 4, 'p_metric': 4},\n        3: {'N': 63, 'alpha': 0.3, 'u': -0.8, 'v': 0.3, 'p_flux': 6, 'p_metric': 2},\n        4: {'N': 64, 'alpha': 0.2, 'u': 1.0, 'v': 0.5, 'p_flux': 4}, # Correction Case\n        5: {'N': 32, 'alpha': 0.0, 'u': 1.2, 'v': -0.7, 'p_flux': 6, 'p_metric': 2},\n    }\n\n    results = []\n\n    # Case 1: Mismatch p_flux=4, p_metric=2\n    params = test_cases[1]\n    res1 = compute_fsp_error(**params)\n    results.append(res1)\n\n    # Case 2: Matched orders p_flux=4, p_metric=4\n    params = test_cases[2]\n    res2 = compute_fsp_error(**params)\n    results.append(res2)\n\n    # Case 3: Stronger mismatch p_flux=6, p_metric=2\n    params = test_cases[3]\n    res3 = compute_fsp_error(**params)\n    results.append(res3)\n\n    # Case 4: Corrected version of Case 1.\n    # The proposed correction is to use the same order for metrics as for the flux.\n    # So, we use Case 1's parameters but set p_metric = p_flux.\n    params_case1 = test_cases[1]\n    res4 = compute_fsp_error(\n        N=params_case1['N'],\n        alpha=params_case1['alpha'],\n        u=params_case1['u'],\n        v=params_case1['v'],\n        p_flux=params_case1['p_flux'],\n        p_metric=params_case1['p_flux']  # The correction is applied here\n    )\n    results.append(res4)\n\n    # Case 5: Edge case with a straight grid (alpha=0.0)\n    params = test_cases[5]\n    res5 = compute_fsp_error(**params)\n    results.append(res5)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.15e}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}