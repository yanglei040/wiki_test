{
    "hands_on_practices": [
        {
            "introduction": "The rotational transform, $\\iota$, is a cornerstone of magnetic confinement, dictating the twist of field lines that is essential for establishing nested flux surfaces. This foundational exercise has you derive the expression for $\\iota$ from the fundamental representations of the magnetic field in Boozer coordinates. By manipulating the relationships between the contravariant and covariant forms of $\\mathbf{B}$, you will gain a deeper appreciation for how the geometric properties of the coordinate system (via the metric tensor) and the current distributions (via flux functions) together define the magnetic topology .",
            "id": "3719637",
            "problem": "Consider an idealized stellarator described in Boozer straight-field-line coordinates, with coordinates $(\\psi,\\theta,\\phi)$, where $\\psi$ labels nested toroidal magnetic flux surfaces, $\\theta$ is a poloidal angle, and $\\phi$ is a toroidal angle. Assume a right-handed coordinate system such that the Levi-Civita symbol satisfies $\\varepsilon^{\\psi\\theta\\phi}=+1$. The rotational transform $\\iota(\\psi)$ is defined by the field-line slope $d\\theta/d\\phi$ along a magnetic field line on a surface $\\psi=\\text{const}$.\n\nYou are given the following foundational elements:\n- The magnetic field is tangent to flux surfaces, so $\\,\\mathbf{B}\\cdot\\nabla\\psi=0$.\n- In Boozer coordinates, the magnetic field has a contravariant (curl-like) representation\n$$\n\\mathbf{B} \\;=\\; \\nabla\\psi \\times \\nabla\\theta \\;+\\; \\iota(\\psi)\\,\\nabla\\phi \\times \\nabla\\psi \\, ,\n$$\nand a covariant representation\n$$\n\\mathbf{B} \\;=\\; I(\\psi)\\,\\nabla\\theta \\;+\\; G(\\psi)\\,\\nabla\\phi \\, ,\n$$\nwhere $I(\\psi)$ and $G(\\psi)$ are flux functions.\n- The covariant metric coefficients are $g_{ij}=\\partial_{\\!i}\\mathbf{r}\\cdot\\partial_{\\!j}\\mathbf{r}$, where $\\partial_{\\!i}\\mathbf{r}=\\partial\\mathbf{r}/\\partial x^{i}$ with $x^{1}=\\psi$, $x^{2}=\\theta$, $x^{3}=\\phi$. The Jacobian is $\\sqrt{g}=\\partial_{\\!\\psi}\\mathbf{r}\\cdot(\\partial_{\\!\\theta}\\mathbf{r}\\times\\partial_{\\!\\phi}\\mathbf{r})$.\n\nStarting only from these definitions and identities, derive a closed-form expression for the rotational transform $\\iota(\\psi)$ in terms of $I(\\psi)$, $G(\\psi)$, and the Boozer covariant metric coefficients $g_{\\theta\\theta}$, $g_{\\theta\\phi}$, and $g_{\\phi\\phi}$. Your final answer must be a single analytic expression for $\\iota(\\psi)$ and must not contain the Jacobian $\\sqrt{g}$. Do not introduce any additional assumptions beyond those stated. No numerical evaluation is required, and no rounding is needed. Express your final answer as a dimensionless quantity (no units are to be provided in the final expression).",
            "solution": "The problem requires the derivation of an expression for the rotational transform, $\\iota(\\psi)$, in terms of the flux functions $I(\\psi)$ and $G(\\psi)$, and the covariant metric coefficients $g_{\\theta\\theta}$, $g_{\\theta\\phi}$, and $g_{\\phi\\phi}$. The derivation will proceed by establishing a relationship between the two provided representations of the magnetic field, $\\mathbf{B}$, in Boozer coordinates $(\\psi, \\theta, \\phi)$.\n\nThe first representation is the covariant form:\n$$\n\\mathbf{B} = I(\\psi)\\,\\nabla\\theta + G(\\psi)\\,\\nabla\\phi\n$$\nIn a general curvilinear coordinate system $x^i$, a vector $\\mathbf{B}$ can be expressed in terms of its covariant components $B_i$ and the reciprocal basis vectors $\\nabla x^i$ as $\\mathbf{B} = \\sum_i B_i \\nabla x^i$. By comparing this general form with the given covariant representation, we can identify the covariant components of $\\mathbf{B}$ in the $(\\psi, \\theta, \\phi)$ system:\n$B_\\psi = 0$\n$B_\\theta = I(\\psi)$\n$B_\\phi = G(\\psi)$\nThe condition $B_\\psi = 0$ is consistent with the fact that magnetic field lines lie on flux surfaces, so $\\mathbf{B} \\cdot \\nabla\\psi = 0$.\n\nThe second representation is the contravariant (curl-like) form:\n$$\n\\mathbf{B} = \\nabla\\psi \\times \\nabla\\theta + \\iota(\\psi)\\,\\nabla\\phi \\times \\nabla\\psi\n$$\nIn a general curvilinear coordinate system, a vector $\\mathbf{B}$ can also be expressed in terms of its contravariant components $B^i$ and the tangent basis vectors $\\partial_i\\mathbf{r}$ (where $\\mathbf{r}$ is the position vector and $\\partial_i \\equiv \\partial/\\partial x^i$) as $\\mathbf{B} = \\sum_i B^i \\partial_i\\mathbf{r}$. To find the contravariant components, we must express the cross products of gradients in terms of the tangent basis vectors. The general identity is:\n$$\n\\nabla x^i \\times \\nabla x^j = \\frac{1}{\\sqrt{g}} \\varepsilon^{ijk} \\partial_k\\mathbf{r}\n$$\nwhere $\\sqrt{g}$ is the Jacobian of the coordinate transformation and $\\varepsilon^{ijk}$ is the Levi-Civita permutation symbol. The problem specifies a right-handed system with $x^1 = \\psi$, $x^2 = \\theta$, $x^3 = \\phi$, and $\\varepsilon^{\\psi\\theta\\phi} = +1$. Applying this identity to the terms in the contravariant representation of $\\mathbf{B}$:\nFor the first term:\n$$\n\\nabla\\psi \\times \\nabla\\theta = \\frac{1}{\\sqrt{g}} \\varepsilon^{\\psi\\theta\\phi} \\partial_\\phi\\mathbf{r} = \\frac{1}{\\sqrt{g}} \\partial_\\phi\\mathbf{r}\n$$\nFor the second term:\n$$\n\\nabla\\phi \\times \\nabla\\psi = \\frac{1}{\\sqrt{g}} \\varepsilon^{\\phi\\psi\\theta} \\partial_\\theta\\mathbf{r} = \\frac{1}{\\sqrt{g}} \\partial_\\theta\\mathbf{r}\n$$\nThis uses the cyclic property of the Levi-Civita symbol, $\\varepsilon^{\\phi\\psi\\theta} = \\varepsilon^{\\psi\\theta\\phi} = +1$.\nSubstituting these expressions back into the second representation for $\\mathbf{B}$:\n$$\n\\mathbf{B} = \\frac{1}{\\sqrt{g}} \\partial_\\phi\\mathbf{r} + \\iota(\\psi) \\left( \\frac{1}{\\sqrt{g}} \\partial_\\theta\\mathbf{r} \\right) = \\frac{\\iota(\\psi)}{\\sqrt{g}}\\partial_\\theta\\mathbf{r} + \\frac{1}{\\sqrt{g}}\\partial_\\phi\\mathbf{r}\n$$\nBy comparing this with the general form $\\mathbf{B} = B^\\psi \\partial_\\psi\\mathbf{r} + B^\\theta \\partial_\\theta\\mathbf{r} + B^\\phi \\partial_\\phi\\mathbf{r}$, we can identify the contravariant components of $\\mathbf{B}$:\n$B^\\psi = 0$\n$B^\\theta = \\frac{\\iota(\\psi)}{\\sqrt{g}}$\n$B^\\phi = \\frac{1}{\\sqrt{g}}$\n\nThe covariant and contravariant components of a vector are related through the covariant metric tensor $g_{ij}$ via the operation of lowering the index:\n$$\nB_i = \\sum_j g_{ij} B^j\n$$\nWe can write this relationship for the $\\theta$ and $\\phi$ components:\n$$\nB_\\theta = g_{\\theta\\psi}B^\\psi + g_{\\theta\\theta}B^\\theta + g_{\\theta\\phi}B^\\phi\n$$\n$$\nB_\\phi = g_{\\phi\\psi}B^\\psi + g_{\\phi\\theta}B^\\theta + g_{\\phi\\phi}B^\\phi\n$$\nNow, we substitute the expressions for the covariant and contravariant components that we found from the two representations of $\\mathbf{B}$. Using $B^\\psi=0$ and the symmetry of the metric tensor, $g_{\\phi\\theta} = g_{\\theta\\phi}$:\n$$\nI(\\psi) = g_{\\theta\\theta}\\left(\\frac{\\iota(\\psi)}{\\sqrt{g}}\\right) + g_{\\theta\\phi}\\left(\\frac{1}{\\sqrt{g}}\\right)\n$$\n$$\nG(\\psi) = g_{\\theta\\phi}\\left(\\frac{\\iota(\\psi)}{\\sqrt{g}}\\right) + g_{\\phi\\phi}\\left(\\frac{1}{\\sqrt{g}}\\right)\n$$\nThese two equations form a linear system for the unknowns $\\iota(\\psi)$ and $1/\\sqrt{g}$. To eliminate $\\sqrt{g}$, we can first multiply both equations by $\\sqrt{g}$:\n1. $\\quad I(\\psi)\\sqrt{g} = g_{\\theta\\theta}\\iota(\\psi) + g_{\\theta\\phi}$\n2. $\\quad G(\\psi)\\sqrt{g} = g_{\\theta\\phi}\\iota(\\psi) + g_{\\phi\\phi}$\n\nTo solve for $\\iota(\\psi)$, we can eliminate $\\sqrt{g}$. One way is to solve for $\\sqrt{g}$ in each equation and set them equal. A more direct method is to multiply equation (1) by $G(\\psi)$ and equation (2) by $I(\\psi)$:\n$$\nI(\\psi)G(\\psi)\\sqrt{g} = G(\\psi)(g_{\\theta\\theta}\\iota(\\psi) + g_{\\theta\\phi})\n$$\n$$\nG(\\psi)I(\\psi)\\sqrt{g} = I(\\psi)(g_{\\theta\\phi}\\iota(\\psi) + g_{\\phi\\phi})\n$$\nThe left-hand sides are identical, so we can equate the right-hand sides:\n$$\nG(\\psi)(g_{\\theta\\theta}\\iota(\\psi) + g_{\\theta\\phi}) = I(\\psi)(g_{\\theta\\phi}\\iota(\\psi) + g_{\\phi\\phi})\n$$\nExpanding both sides gives:\n$$\nG(\\psi)g_{\\theta\\theta}\\iota(\\psi) + G(\\psi)g_{\\theta\\phi} = I(\\psi)g_{\\theta\\phi}\\iota(\\psi) + I(\\psi)g_{\\phi\\phi}\n$$\nTo solve for $\\iota(\\psi)$, we group all terms containing $\\iota(\\psi)$ on one side of the equation and all other terms on the other side:\n$$\nG(\\psi)g_{\\theta\\theta}\\iota(\\psi) - I(\\psi)g_{\\theta\\phi}\\iota(\\psi) = I(\\psi)g_{\\phi\\phi} - G(\\psi)g_{\\theta\\phi}\n$$\nFactoring out $\\iota(\\psi)$:\n$$\n\\iota(\\psi) \\left(G(\\psi)g_{\\theta\\theta} - I(\\psi)g_{\\theta\\phi}\\right) = I(\\psi)g_{\\phi\\phi} - G(\\psi)g_{\\theta\\phi}\n$$\nFinally, isolating $\\iota(\\psi)$ by dividing by the term in the parentheses (which can be shown to be non-zero for a physical magnetic field) yields the closed-form expression:\n$$\n\\iota(\\psi) = \\frac{I(\\psi)g_{\\phi\\phi} - G(\\psi)g_{\\theta\\phi}}{G(\\psi)g_{\\theta\\theta} - I(\\psi)g_{\\theta\\phi}}\n$$\nThis expression gives the rotational transform $\\iota(\\psi)$ in terms of the specified flux functions and metric coefficients, and it does not contain the Jacobian $\\sqrt{g}$, fulfilling all requirements of the problem.",
            "answer": "$$\n\\boxed{\\iota(\\psi) = \\frac{I(\\psi)g_{\\phi\\phi} - G(\\psi)g_{\\theta\\phi}}{G(\\psi)g_{\\theta\\theta} - I(\\psi)g_{\\theta\\phi}}}\n$$"
        },
        {
            "introduction": "The performance of a modern stellarator critically depends on achieving a high degree of quasi-symmetry to ensure good neoclassical confinement of plasma particles. This computational practice challenges you to translate this physical principle into a quantitative analysis by evaluating the Fourier spectrum of the magnetic field strength on a flux surface. By implementing metrics that quantify departures from ideal quasi-symmetry and a proxy for the resulting neoclassical transport, you will gain hands-on experience with the essential tools used to diagnose and optimize stellarator magnetic configurations .",
            "id": "3719689",
            "problem": "You are given a representation of the magnetic field strength in Boozer angles, modeled as a Fourier series on a single magnetic surface, $B(\\theta,\\zeta) = B_{00} + \\sum_{(m,n)\\neq(0,0)} B_{mn} \\cos(m \\theta - n \\zeta)$, where $\\theta$ is the poloidal angle and $\\zeta$ is the toroidal angle. Angles must be treated in radians. Consider a candidate quasisymmetric configuration characterized by a helical symmetry $\\alpha = M \\theta - N \\zeta$, with fixed integers $M$ and $N$. In a perfectly quasisymmetric configuration, the field strength $B$ depends only on $\\alpha$, so the non-zero Fourier amplitudes $B_{mn}$ occur only for indices in the set $S_{\\mathrm{QS}} = \\{(m,n): \\exists k \\in \\mathbb{Z}_{>0} \\text{ such that } m = k M, n = k N\\}$.\n\nUsing first principles of guiding-center motion in strong magnetic fields, departures from quasisymmetry can be quantified by the power in Fourier modes that lie outside $S_{\\mathrm{QS}}$, normalized by the total power in $B$ variations on the surface. Further, a simple neoclassical transport proxy in the low-collisionality regime can be constructed by weighting each non-quasisymmetric mode by the square of its parallel variation frequency along a field line. For a rotational transform $\\iota$ (dimensionless), the field-line follows $\\theta(s) = \\theta_0 + s$, $\\zeta(s) = \\zeta_0 + \\iota s$, where $s$ is an arclength-like coordinate along the field line. The phase of a given Fourier mode varies as $\\phi_{mn}(s) = m \\theta(s) - n \\zeta(s)$, so the frequency of variation along the field line is $\\omega_{mn} = m - \\iota n$. The bounce-averaged contribution of a mode to the radial drift scales inversely with $\\omega_{mn}$, motivating a transport proxy that weights the power in non-quasisymmetric modes by $1/(\\omega_{mn}^2 + \\delta^2)$, where $\\delta$ is a small regularization parameter representing finite collisionality or non-ideal averaging effects.\n\nYour task is to implement a program that, for each test case, computes two quantities:\n\n1. The normalized departure-from-quasisymmetry metric\n$$\nD = \\begin{cases}\n\\displaystyle \\frac{\\sqrt{\\sum\\limits_{(m,n)\\notin S_{\\mathrm{QS}}} \\left(\\frac{B_{mn}}{B_{00}}\\right)^2}}{\\sqrt{\\sum\\limits_{(m,n)\\neq(0,0)} \\left(\\frac{B_{mn}}{B_{00}}\\right)^2}}, & \\text{if } \\displaystyle \\sum\\limits_{(m,n)\\neq(0,0)} \\left(\\frac{B_{mn}}{B_{00}}\\right)^2 > 0, \\\\\n0, & \\text{otherwise}.\n\\end{cases}\n$$\n\n2. The neoclassical transport proxy\n$$\nT = \\sum_{(m,n)\\notin S_{\\mathrm{QS}}} \\frac{\\left(\\frac{B_{mn}}{B_{00}}\\right)^2}{\\left(m - \\iota n\\right)^2 + \\delta^2}.\n$$\n\nIn both definitions, the constant mode $B_{00}$ is excluded from the sums over $(m,n)$, and all results must be expressed as dimensionless floats. Angles are in radians. The regularization parameter $\\delta$ must be strictly positive to avoid singularities. The set $S_{\\mathrm{QS}}$ must be recognized from the given $(M,N)$: $(m,n)$ lies in $S_{\\mathrm{QS}}$ if and only if there exists an integer $k \\geq 1$ with $m = k M$ and $n = k N$. For axisymmetry, use $M = 1$, $N = 0$, so that $S_{\\mathrm{QS}} = \\{(m,n): n = 0, m \\in \\mathbb{Z}_{>0}\\}$.\n\nBase your reasoning on fundamental laws and well-tested principles: guiding-center theory derived from the Lorentz force $m \\, d\\mathbf{v}/dt = q (\\mathbf{v} \\times \\mathbf{B} + \\mathbf{E})$, magnetic moment invariance $\\mu = m v_\\perp^2/(2B)$ in strong fields, and field-line geometry in a torus parameterized by rotational transform $\\iota$. Do not use any shortcut formulas beyond these principles.\n\nImplement the program to evaluate the following test suite. Each test case is specified by $(B_{00}, M, N, \\iota, \\delta, \\mathcal{C})$, where $\\mathcal{C}$ is a list of triples $(m,n,B_{mn})$ of non-constant Fourier modes with amplitudes in Tesla:\n\n- Test case $1$ (happy path, mixed quasisymmetric and non-quasisymmetric content):\n  - $B_{00} = 5.0$, $M = 1$, $N = 3$, $\\iota = 0.93$, $\\delta = 0.01$,\n  - $\\mathcal{C} = \\{(1,3,0.10), (2,6,0.05), (1,2,0.012), (3,0,0.018), (2,5,0.008), (4,12,0.03)\\}$.\n\n- Test case $2$ (boundary case, perfectly quasisymmetric spectrum with non-zero variation):\n  - $B_{00} = 4.0$, $M = 2$, $N = 5$, $\\iota = 0.53$, $\\delta = 0.01$,\n  - $\\mathcal{C} = \\{(2,5,0.08), (4,10,0.03)\\}$.\n\n- Test case $3$ (edge case, near-resonant non-quasisymmetric mode leading to large transport proxy):\n  - $B_{00} = 3.0$, $M = 1$, $N = 2$, $\\iota = 2.99$, $\\delta = 0.001$,\n  - $\\mathcal{C} = \\{(3,1,0.02), (1,2,0.05), (2,4,0.02), (5,2,0.015)\\}$.\n\n- Test case $4$ (boundary case, no variation beyond the constant mode):\n  - $B_{00} = 5.5$, $M = 1$, $N = 0$, $\\iota = 0.34$, $\\delta = 0.01$,\n  - $\\mathcal{C} = \\{\\}$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order $[D_1, T_1, D_2, T_2, D_3, T_3, D_4, T_4]$, where $D_i$ and $T_i$ are the computed values for test case $i$, each expressed as a float in dimensionless units.",
            "solution": "The problem statement has been critically examined and is determined to be valid. It is scientifically grounded in the principles of plasma physics and magnetic confinement fusion, specifically concerning stellarator optimization. The problem is well-posed, with all parameters, definitions, and objective functions defined unambiguously. The provided data are physically reasonable. We may therefore proceed with a solution.\n\nThe task is to compute two metrics for a given stellarator magnetic field configuration: the normalized departure from quasisymmetry, $D$, and a neoclassical transport proxy, $T$. This requires a correct interpretation of the underlying physics of particle motion in toroidal magnetic systems.\n\nThe fundamental principle governing the motion of a charged particle with mass $m_p$ and charge $q$ is the Lorentz force law, $\\mathbf{F} = q(\\mathbf{v} \\times \\mathbf{B})$, assuming a negligible electric field. In the strong magnetic fields typical of fusion devices, the particle executes rapid gyration around a magnetic field line. The center of this gyration, known as the guiding center, moves with a velocity $\\mathbf{v}_g$. For magnetic fields that vary slowly in space and time compared to the gyration, the magnetic moment of the particle, $\\mu = m_p v_\\perp^2 / (2B)$, where $v_\\perp$ is the velocity component perpendicular to $\\mathbf{B}$, is an adiabatic invariant.\n\nConservation of energy, $E = \\frac{1}{2}m_p(v_\\parallel^2 + v_\\perp^2)$, combined with the invariance of $\\mu$, implies that the parallel velocity is $v_\\parallel = \\sqrt{2(E - \\mu B)/m_p}$. As a particle travels along a field line, it experiences variations in the magnetic field strength $B$. These variations can cause the particle to be reflected (trapped) in regions of low $B$ (\"magnetic wells\"). Furthermore, gradients in the magnetic field strength cause the guiding center to drift across field lines, with the dominant component being the grad-B drift, $\\mathbf{v}_{\\nabla B} \\propto (\\mathbf{B} \\times \\nabla B) / B^2$. In a standard torus, this drift leads to a net radial displacement, which is a primary mechanism for particle and energy loss.\n\nIn an ideal axisymmetric system like a tokamak, the toroidal symmetry ensures that the canonical angular momentum is conserved, which constrains particle orbits to lie close to their initial magnetic flux surface. Stellarators lack this continuous symmetry, which historically led to poor confinement. The principle of quasisymmetry (QS) is a sophisticated design concept to recover good confinement. A magnetic configuration is quasisymmetric if the magnetic field strength $B$ on a flux surface, when expressed in Boozer coordinates $(\\theta, \\zeta)$, depends only on a single helical angle, $\\alpha = M\\theta - N\\zeta$, for some fixed integers $M$ and $N$. In such a field, a particle's guiding center moves as if it were in a symmetric system, and its long-term radial drift averages to nearly zero, restoring good confinement.\n\nThe problem formalizes this concept using a Fourier series representation for the magnetic field strength on a flux surface:\n$$B(\\theta,\\zeta) = B_{00} + \\sum_{(m,n)\\neq(0,0)} B_{mn} \\cos(m \\theta - n \\zeta)$$\nFor $B$ to be a function only of $\\alpha = M\\theta - N\\zeta$, any Fourier mode $(m,n)$ with a non-zero amplitude $B_{mn}$ must have a phase $m\\theta - n\\zeta$ that is a multiple of $\\alpha$. This requires $m\\theta - n\\zeta = k(M\\theta - N\\zeta)$ for some integer $k$. By comparing the coefficients of $\\theta$ and $\\zeta$, we must have $m=kM$ and $n=kN$. The set of these \"quasisymmetric\" mode numbers is denoted $S_{\\mathrm{QS}} = \\{(m,n): \\exists k \\in \\mathbb{Z}_{>0} \\text{ such that } m = k M, n = k N\\}$. Any mode $(m,n)$ not in this set breaks the quasisymmetry and contributes to neoclassical transport.\n\nThe first metric, $D$, quantifies the degree of this symmetry breaking. It is defined as the ratio of the root-mean-square amplitude of the non-quasisymmetric modes to that of all varying modes. The power in a mode can be taken as proportional to $(B_{mn})^2$. Normalizing by the average field $B_{00}$ creates a dimensionless quantity. Thus, the definition follows:\n$$D = \\begin{cases} \\displaystyle \\frac{\\sqrt{\\sum\\limits_{(m,n)\\notin S_{\\mathrm{QS}}} \\left(\\frac{B_{mn}}{B_{00}}\\right)^2}}{\\sqrt{\\sum\\limits_{(m,n)\\neq(0,0)} \\left(\\frac{B_{mn}}{B_{00}}\\right)^2}}, & \\text{if } \\displaystyle \\sum\\limits_{(m,n)\\neq(0,0)} \\left(\\frac{B_{mn}}{B_{00}}\\right)^2 > 0, \\\\ 0, & \\text{otherwise}. \\end{cases}$$\nA value of $D=0$ indicates a perfectly quasisymmetric field, while $D=1$ indicates that all field variations break the symmetry.\n\nThe second metric, $T$, is a proxy for the magnitude of neoclassical transport in the low-collisionality regime. The transport is driven by particle drifts, which are particularly large for trapped particles that resonate with the magnetic field structure. A particle moving along a field line perceives the phase of a mode $(m,n)$ to change as $\\phi_{mn}(s) = m\\theta(s) - n\\zeta(s)$, where $s$ is an arclength-like coordinate. With a rotational transform $\\iota$, the field line path is approximately $\\theta(s) \\approx s$ and $\\zeta(s) \\approx \\iota s$ (ignoring constants). The rate of change of the phase along the field line is the parallel wave-number, $\\omega_{mn} = d\\phi_{mn}/ds = m - \\iota n$.\nThe efficiency of a mode in driving transport is largest when the particle \"resonates\" with it, meaning the mode's structure varies slowly as seen by the particle. This occurs when $|\\omega_{mn}|$ is small. The resulting transport contribution from a mode is inversely proportional to the square of this frequency. The transport proxy $T$ sums the power of each non-quasisymmetric mode, weighted by this resonant denominator:\n$$T = \\sum_{(m,n)\\notin S_{\\mathrm{QS}}} \\frac{\\left(\\frac{B_{mn}}{B_{00}}\\right)^2}{\\left(m - \\iota n\\right)^2 + \\delta^2}$$\nThe parameter $\\delta^2$ is a small regularization term. Physically, it accounts for effects like finite collisionality or orbit averaging which prevent the transport from becoming infinite at a perfect resonance ($\\omega_{mn}=0$), thus ensuring the model is well-behaved.\n\nThe computational procedure for each test case is as follows:\n$1$. For a given test case with parameters $(B_{00}, M, N, \\iota, \\delta)$ and a set of Fourier coefficients $\\mathcal{C}$, initialize accumulators for the total squared variation, the non-quasisymmetric squared variation, and the transport proxy $T$.\n$2$. Iterate through each mode $(m, n, B_{mn})$ in $\\mathcal{C}$.\n$3$. For each mode $(m,n)$, determine if it belongs to the quasisymmetric set $S_{\\mathrm{QS}}$ by checking if there exists an integer $k \\ge 1$ such that $m = kM$ and $n = kN$. This can be implemented by checking for collinearity ($mN=nM$) and then finding $k$ to verify it is an integer greater than or equal to $1$.\n$4$. Calculate the normalized squared amplitude $b_{mn}^2 = (B_{mn}/B_{00})^2$. Add this value to the accumulator for the total squared variation.\n$5$. If the mode $(m,n)$ is not in $S_{\\mathrm{QS}}$, add $b_{mn}^2$ to the non-quasisymmetric variation accumulator. Then, calculate its transport contribution $\\frac{b_{mn}^2}{(m-\\iota n)^2 + \\delta^2}$ and add it to the accumulator for $T$.\n$6$. After iterating through all modes, calculate the final metrics. If the total variation is zero, $D=0$. Otherwise, $D$ is the square root of the ratio of the non-quasisymmetric variation to the total variation. $T$ is the final accumulated sum. This process is repeated for all test cases.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes quasisymmetry metrics for a set of stellarator configurations.\n    \"\"\"\n    test_cases = [\n        (5.0, 1, 3, 0.93, 0.01, [(1, 3, 0.10), (2, 6, 0.05), (1, 2, 0.012), (3, 0, 0.018), (2, 5, 0.008), (4, 12, 0.03)]),\n        (4.0, 2, 5, 0.53, 0.01, [(2, 5, 0.08), (4, 10, 0.03)]),\n        (3.0, 1, 2, 2.99, 0.001, [(3, 1, 0.02), (1, 2, 0.05), (2, 4, 0.02), (5, 2, 0.015)]),\n        (5.5, 1, 0, 0.34, 0.01, []),\n    ]\n\n    results = []\n\n    def is_quasisymmetric(m, n, M, N):\n        \"\"\"\n        Checks if a mode (m, n) belongs to the quasisymmetric set S_QS\n        defined by the symmetry vector (M, N).\n        S_QS = {(m,n): exists k in Z_{>0} s.t. m=kM, n=kN}.\n        \"\"\"\n        if m == 0 and n == 0:\n            return False\n        \n        # If the symmetry vector is (0,0), S_QS is empty.\n        if M == 0 and N == 0:\n            return False\n\n        # Check for collinearity. If not collinear, not QS.\n        if m * N != n * M:\n            return False\n            \n        # If collinear, find the proportionality constant k and check its properties.\n        if M != 0:\n            # k = m / M. Check if m is a multiple of M and k is a positive integer.\n            if m % M == 0:\n                k = m // M\n                if k >= 1:\n                    return True\n        elif N != 0: # This case is when M=0, so m must be 0 for collinearity.\n            # k = n / N. Check if n is a multiple of N and k is a positive integer.\n            if n % N == 0:\n                k = n // N\n                if k >= 1:\n                    return True\n        \n        return False\n\n    for case in test_cases:\n        B00, M, N, iota, delta, C = case\n        \n        sum_nqs_sq_norm = 0.0\n        sum_total_sq_norm = 0.0\n        transport_proxy_T = 0.0\n\n        if not C: # Handle case with no varying modes\n            results.extend([0.0, 0.0])\n            continue\n\n        for m, n, Bmn in C:\n            b_mn_norm_sq = (Bmn / B00)**2\n            sum_total_sq_norm += b_mn_norm_sq\n\n            if not is_quasisymmetric(m, n, M, N):\n                sum_nqs_sq_norm += b_mn_norm_sq\n                \n                omega_mn = m - iota * n\n                transport_proxy_T += b_mn_norm_sq / (omega_mn**2 + delta**2)\n\n        if sum_total_sq_norm > 0:\n            departure_D = np.sqrt(sum_nqs_sq_norm / sum_total_sq_norm)\n        else:\n            departure_D = 0.0\n\n        results.extend([departure_D, transport_proxy_T])\n\n    # Format the final output as a comma-separated list in brackets.\n    output_str = \"[\" + \",\".join(f\"{res:.8f}\" for res in results) + \"]\"\n    print(output_str)\n\nsolve()\n```"
        },
        {
            "introduction": "A theoretically optimized magnetic configuration must ultimately be realized by a set of physical electromagnetic coils. This practice delves into the crucial inverse problem of stellarator coil design, where the goal is to find a current distribution on a winding surface that generates the desired magnetic field at the plasma boundary. By applying the Biot-Savart law within a regularized least-squares framework, you will tackle the core engineering challenge of translating an ideal plasma shape into a feasible coil geometry, bridging the gap between physics theory and practical machine construction .",
            "id": "3719714",
            "problem": "You are given a nested pair of toroidal surfaces representing a plasma boundary and a winding surface for a stellarator. The goal is to compute a surface current on the winding surface, represented by a scalar streamfunction expanded in selected Fourier harmonics, such that the normal component of the magnetic field on the plasma boundary, due to this winding surface current, best cancels a prescribed target normal field. You must provide the root-mean-square residual normal field on the plasma boundary for a small test suite of cases. All angles are to be treated in radians, and all physical quantities are in International System of Units (SI).\n\nStart from the following fundamental base:\n\n- Magnetostatics with no displacement current, with magnetic field computed from the Biot–Savart law. For a surface current density $\\mathbf{K}(\\mathbf{r})$ on a smooth surface $\\mathcal{S}$, the magnetic field at a field point $\\mathbf{r}_p$ is\n$$\n\\mathbf{B}(\\mathbf{r}_p) = \\frac{\\mu_0}{4\\pi} \\iint_{\\mathcal{S}} \\frac{\\mathbf{K}(\\mathbf{r}) \\times \\left(\\mathbf{r}_p - \\mathbf{r}\\right)}{\\lVert \\mathbf{r}_p - \\mathbf{r} \\rVert^3} \\, \\mathrm{d}S,\n$$\nwhere $\\mu_0$ is the permeability of free space.\n\n- On a winding surface parameterized by poloidal angle $\\theta \\in [0,2\\pi)$ and toroidal angle $\\zeta \\in [0,2\\pi)$, and embedded via $\\mathbf{r}_\\mathrm{w}(\\theta,\\zeta)$ with tangent vectors $\\mathbf{e}_\\theta = \\partial \\mathbf{r}_\\mathrm{w}/\\partial \\theta$ and $\\mathbf{e}_\\zeta = \\partial \\mathbf{r}_\\mathrm{w}/\\partial \\zeta$, define a scalar streamfunction $\\lambda(\\theta,\\zeta)$. The surface current density is\n$$\n\\mathbf{K} = \\hat{\\mathbf{n}}_\\mathrm{w} \\times \\nabla_\\mathrm{s} \\lambda = \\frac{1}{J} \\left( \\frac{\\partial \\lambda}{\\partial \\theta} \\mathbf{e}_\\zeta - \\frac{\\partial \\lambda}{\\partial \\zeta} \\mathbf{e}_\\theta \\right),\n$$\nwhere $J = \\lVert \\mathbf{e}_\\theta \\times \\mathbf{e}_\\zeta \\rVert$ and $\\hat{\\mathbf{n}}_\\mathrm{w}$ is the unit normal on the winding surface. Using $\\mathrm{d}S = J \\,\\mathrm{d}\\theta \\,\\mathrm{d}\\zeta$, the Biot–Savart integral simplifies to a parameter-space integral over $(\\theta,\\zeta)$ without explicit $J$.\n\n- The condition for the plasma boundary to be a magnetic surface is that the total normal component $B_n = \\hat{\\mathbf{n}}_\\mathrm{p} \\cdot \\mathbf{B}$ vanishes on the plasma boundary. In this exercise, a prescribed target field $B_n^\\mathrm{target}(\\theta,\\zeta)$ is given, representing the normal field to be canceled by the winding surface current.\n\nGeometry. The winding surface and the plasma boundary are both given as perturbed circular tori in cylindrical coordinates. With major radius $R_0$, winding minor radius $a_\\mathrm{w}$, plasma minor radius $a_\\mathrm{p}$, and small three-dimensional perturbations of amplitude $\\varepsilon_\\mathrm{w}$ and $\\varepsilon_\\mathrm{p}$ with helicity $(m_\\mathrm{w},n_\\mathrm{w})$ and $(m_\\mathrm{p},n_\\mathrm{p})$ respectively, define their embeddings as\n$$\n\\mathbf{r}_\\mathrm{surf}(\\theta,\\zeta; R_0,a,\\varepsilon,m,n) =\n\\begin{bmatrix}\n\\left(R_0 + a \\cos \\theta + \\varepsilon \\cos(m\\theta - n\\zeta)\\right) \\cos \\zeta \\\\\n\\left(R_0 + a \\cos \\theta + \\varepsilon \\cos(m\\theta - n\\zeta)\\right) \\sin \\zeta \\\\\na \\sin \\theta + \\varepsilon \\sin(m\\theta - n\\zeta)\n\\end{bmatrix}.\n$$\nFor the plasma boundary, use parameters $(R_0,a_\\mathrm{p},\\varepsilon_\\mathrm{p},m_\\mathrm{p},n_\\mathrm{p})$, and for the winding surface use $(R_0,a_\\mathrm{w},\\varepsilon_\\mathrm{w},m_\\mathrm{w},n_\\mathrm{w})$. The unit normal on the plasma boundary at $(\\theta,\\zeta)$ is\n$$\n\\hat{\\mathbf{n}}_\\mathrm{p}(\\theta,\\zeta) = \\frac{\\frac{\\partial \\mathbf{r}_\\mathrm{p}}{\\partial \\theta} \\times \\frac{\\partial \\mathbf{r}_\\mathrm{p}}{\\partial \\zeta}}{\\left\\lVert \\frac{\\partial \\mathbf{r}_\\mathrm{p}}{\\partial \\theta} \\times \\frac{\\partial \\mathbf{r}_\\mathrm{p}}{\\partial \\zeta} \\right\\rVert }.\n$$\n\nStreamfunction basis. The winding streamfunction is expanded in a real Fourier basis over a chosen set $\\mathcal{H}$ of integer pairs $(m,n)$:\n$$\n\\lambda(\\theta,\\zeta) = \\sum_{(m,n)\\in \\mathcal{H}} \\left[c_{c}^{(m,n)} \\cos(m\\theta - n\\zeta) + c_{s}^{(m,n)} \\sin(m\\theta - n\\zeta)\\right].\n$$\nThus each pair $(m,n)$ contributes two coefficients, $c_{c}^{(m,n)}$ and $c_{s}^{(m,n)}$, with partial derivatives\n$$\n\\frac{\\partial}{\\partial \\theta}\\cos(m\\theta - n\\zeta) = -m \\sin(m\\theta - n\\zeta), \\quad\n\\frac{\\partial}{\\partial \\zeta}\\cos(m\\theta - n\\zeta) = n \\sin(m\\theta - n\\zeta),\n$$\n$$\n\\frac{\\partial}{\\partial \\theta}\\sin(m\\theta - n\\zeta) = m \\cos(m\\theta - n\\zeta), \\quad\n\\frac{\\partial}{\\partial \\zeta}\\sin(m\\theta - n\\zeta) = -n \\cos(m\\theta - n\\zeta).\n$$\n\nDiscretization. Use a uniform tensor grid for numerical quadrature:\n\n- Winding surface quadrature grid with $N_\\theta^\\mathrm{w}$ points in $\\theta$ and $N_\\zeta^\\mathrm{w}$ points in $\\zeta$ using the rectangle rule with weights $\\Delta \\theta^\\mathrm{w} = 2\\pi/N_\\theta^\\mathrm{w}$ and $\\Delta \\zeta^\\mathrm{w} = 2\\pi/N_\\zeta^\\mathrm{w}$.\n\n- Plasma boundary collocation grid with $N_\\theta^\\mathrm{p}$ points in $\\theta$ and $N_\\zeta^\\mathrm{p}$ points in $\\zeta$.\n\nFor each collocation point $(\\theta_i^\\mathrm{p},\\zeta_j^\\mathrm{p})$ on the plasma boundary, compute the normal field contribution from each basis function by numerically integrating the Biot–Savart kernel over the winding surface parameter space using the above expression for $\\mathbf{K}$. Assemble a matrix $\\mathbf{A} \\in \\mathbb{R}^{N \\times K}$ mapping the vector of coefficients $\\mathbf{c} \\in \\mathbb{R}^K$ to the normal field at the $N = N_\\theta^\\mathrm{p} N_\\zeta^\\mathrm{p}$ plasma points.\n\nTarget normal field. Use a prescribed target normal field on the plasma boundary,\n$$\nB_n^\\mathrm{target}(\\theta,\\zeta) = B_0 \\left[\\cos(2\\theta - \\zeta) + 0.3\\,\\sin(\\theta - 2\\zeta)\\right],\n$$\nwith amplitude $B_0$. This target represents a synthetic normal field that should be canceled by the winding surface current.\n\nOptimization. Compute $\\mathbf{c}$ by minimizing the Tikhonov-regularized quadratic functional\n$$\n\\min_{\\mathbf{c} \\in \\mathbb{R}^K} \\left\\lVert \\mathbf{A}\\mathbf{c} - \\mathbf{b} \\right\\rVert_2^2 + \\alpha \\left\\lVert \\mathbf{W}\\mathbf{c} \\right\\rVert_2^2,\n$$\nwhere $\\mathbf{b} \\in \\mathbb{R}^N$ is the collocated vector of $B_n^\\mathrm{target}$ values, $\\alpha &gt; 0$ is a regularization parameter, and $\\mathbf{W}$ is a diagonal roughness penalty with entries $w_k = \\sqrt{m_k^2 + n_k^2}$ corresponding to each basis coefficient from $(m_k,n_k)$. Solve the normal equations $(\\mathbf{A}^\\top \\mathbf{A} + \\alpha \\mathbf{W}^\\top \\mathbf{W}) \\mathbf{c} = \\mathbf{A}^\\top \\mathbf{b}$. Then compute the residual $\\mathbf{r} = \\mathbf{A}\\mathbf{c} - \\mathbf{b}$ and quantify the error by the root-mean-square residual\n$$\n\\mathrm{RMS} = \\sqrt{\\frac{1}{N} \\sum_{i=1}^N r_i^2}.\n$$\nExpress the final root-mean-square residual value in Tesla (T) for each test case.\n\nTest suite. Use the following parameter values, which are scientifically plausible, with all dimensional quantities in meters (m) or Tesla (T):\n\n- Shared geometry and discretization for all cases:\n  - Major radius $R_0 = 3.0$.\n  - Plasma: $a_\\mathrm{p} = 0.5$, $\\varepsilon_\\mathrm{p} = 0.03$, $m_\\mathrm{p} = 2$, $n_\\mathrm{p} = 1$.\n  - Winding: $a_\\mathrm{w} = 0.9$, $\\varepsilon_\\mathrm{w} = 0.05$, $m_\\mathrm{w} = 2$, $n_\\mathrm{w} = 1$.\n  - Target amplitude $B_0 = 3.0 \\times 10^{-4}$.\n  - Plasma grid: $N_\\theta^\\mathrm{p} = 12$, $N_\\zeta^\\mathrm{p} = 12$.\n  - Winding quadrature: $N_\\theta^\\mathrm{w} = 20$, $N_\\zeta^\\mathrm{w} = 20$.\n\n- Case A (happy path with sufficient harmonics and weak regularization):\n  - Basis set $\\mathcal{H} = \\{(2,1),(1,2),(1,1)\\}$, using both cosine and sine for each pair.\n  - Regularization $\\alpha = 10^{-6}$.\n\n- Case B (strong regularization limiting current complexity):\n  - Basis set $\\mathcal{H} = \\{(2,1),(1,2),(1,1)\\}$, using both cosine and sine for each pair.\n  - Regularization $\\alpha = 10^{-2}$.\n\n- Case C (limited harmonics; model misspecification):\n  - Basis set $\\mathcal{H} = \\{(2,1)\\}$, using both cosine and sine.\n  - Regularization $\\alpha = 10^{-6}$.\n\nYour task is to implement a program that:\n\n1. Constructs the geometry, grids, basis functions, and transfer matrix $\\mathbf{A}$ for each case.\n2. Solves for the coefficient vector $\\mathbf{c}$ using the specified $\\alpha$ and $\\mathbf{W}$.\n3. Computes the residual root-mean-square normal field on the plasma boundary in Tesla.\n\nFinal output format. Your program should produce a single line of output containing the three residuals for Cases A, B, and C, in the stated order, as a comma-separated list enclosed in square brackets and formatted in scientific notation with six significant digits, for example, \"[1.234560e-04,7.890120e-05,3.456780e-04]\". No other text should be printed.",
            "solution": "The problem requires the computation of a surface current density on a toroidal winding surface, such that the magnetic field produced by this current cancels a prescribed target normal magnetic field on an interior plasma boundary. This is a classic inverse problem in stellarator design, often referred to as a boundary-value problem for the magnetic field. The solution will be found by discretizing the problem and solving a regularized linear least-squares system. We will then calculate the root-mean-square (RMS) residual normal field for three distinct test cases.\n\nThe methodological approach consists of several sequential steps:\n1. Define the geometry of the plasma and winding surfaces and compute necessary geometric quantities.\n2. Formulate the relationship between the unknown coefficients of the current streamfunction and the resulting normal magnetic field on the plasma boundary as a linear system.\n3. Solve this linear system using Tikhonov regularization to find the optimal coefficients.\n4. Calculate the residual error to quantify the performance of the designed current distribution.\n\n**1. Governing Equations and Physical Model**\n\nThe magnetic field $\\mathbf{B}$ at a field point $\\mathbf{r}_p$ generated by a surface current density $\\mathbf{K}$ distributed over a surface $\\mathcal{S}_\\mathrm{w}$ is given by the Biot-Savart law:\n$$\n\\mathbf{B}(\\mathbf{r}_p) = \\frac{\\mu_0}{4\\pi} \\iint_{\\mathcal{S}_\\mathrm{w}} \\frac{\\mathbf{K}(\\mathbf{r}_\\mathrm{w}) \\times \\left(\\mathbf{r}_p - \\mathbf{r}_\\mathrm{w}\\right)}{\\lVert \\mathbf{r}_p - \\mathbf{r}_\\mathrm{w} \\rVert^3} \\, \\mathrm{d}S\n$$\nwhere $\\mu_0$ is the permeability of free space, $\\mathbf{r}_\\mathrm{w}$ is a source point on the winding surface $\\mathcal{S}_\\mathrm{w}$, and $\\mathrm{d}S$ is the surface area element.\n\nThe surface current $\\mathbf{K}$ is defined via a scalar streamfunction $\\lambda(\\theta, \\zeta)$ to ensure it is divergence-free. On a surface parameterized by $\\mathbf{r}_\\mathrm{w}(\\theta, \\zeta)$ with tangent vectors $\\mathbf{e}_\\theta = \\partial \\mathbf{r}_\\mathrm{w}/\\partial \\theta$ and $\\mathbf{e}_\\zeta = \\partial \\mathbf{r}_\\mathrm{w}/\\partial \\zeta$, the current density is:\n$$\n\\mathbf{K} = \\frac{1}{J_\\mathrm{w}} \\left( \\frac{\\partial \\lambda}{\\partial \\theta} \\mathbf{e}_\\zeta - \\frac{\\partial \\lambda}{\\partial \\zeta} \\mathbf{e}_\\theta \\right)\n$$\nwhere $J_\\mathrm{w} = \\lVert \\mathbf{e}_\\theta \\times \\mathbf{e}_\\zeta \\rVert$ is the Jacobian of the surface transformation. The surface element is $\\mathrm{d}S = J_\\mathrm{w} \\, \\mathrm{d}\\theta \\, \\mathrm{d}\\zeta$. Substituting this into the Biot-Savart law, the Jacobian $J_\\mathrm{w}$ conveniently cancels:\n$$\n\\mathbf{B}(\\mathbf{r}_p) = \\frac{\\mu_0}{4\\pi} \\int_0^{2\\pi} \\int_0^{2\\pi} \\frac{\\left( \\frac{\\partial \\lambda}{\\partial \\theta} \\mathbf{e}_\\zeta - \\frac{\\partial \\lambda}{\\partial \\zeta} \\mathbf{e}_\\theta \\right) \\times (\\mathbf{r}_p - \\mathbf{r}_\\mathrm{w})}{\\lVert \\mathbf{r}_p - \\mathbf{r}_\\mathrm{w} \\rVert^3} \\, \\mathrm{d}\\theta \\, \\mathrm{d}\\zeta\n$$\nThe problem objective is to make the normal component of the total magnetic field on the plasma boundary, $\\hat{\\mathbf{n}}_\\mathrm{p} \\cdot \\mathbf{B}$, equal to a target normal field, $B_n^\\mathrm{target}$. The normal vector $\\hat{\\mathbf{n}}_\\mathrm{p}$ is computed at each point on the plasma surface $\\mathcal{S}_\\mathrm{p}$.\n\nThe streamfunction $\\lambda$ is expanded in a finite set $\\mathcal{H}$ of Fourier harmonics:\n$$\n\\lambda(\\theta,\\zeta) = \\sum_{(m_k,n_k)\\in \\mathcal{H}} \\left[c_{c,k} \\cos(m_k\\theta - n_k\\zeta) + c_{s,k} \\sin(m_k\\theta - n_k\\zeta)\\right]\n$$\nThis expansion is a linear combination of basis functions with unknown coefficients $\\mathbf{c} = \\{c_{c,k}, c_{s,k}\\}$. Since the Biot-Savart law is linear in $\\mathbf{K}$, and $\\mathbf{K}$ is linear in $\\lambda$ and its derivatives, the resulting normal field $B_n$ on the plasma boundary is a linear function of the coefficients $\\mathbf{c}$.\n\n**2. Discretization and Linear System Assembly**\n\nTo solve the problem numerically, we discretize both surfaces. The plasma boundary $\\mathcal{S}_\\mathrm{p}$ is discretized into a set of $N = N_\\theta^\\mathrm{p} N_\\zeta^\\mathrm{p}$ collocation points $\\{\\mathbf{r}_{\\mathrm{p},i}\\}_{i=1}^N$. The winding surface $\\mathcal{S}_\\mathrm{w}$ is discretized into a grid of $N_\\theta^\\mathrm{w} \\times N_\\zeta^\\mathrm{w}$ quadrature points for numerical integration.\n\nThe linear relationship between the coefficients $\\mathbf{c} \\in \\mathbb{R}^K$ (where $K$ is the total number of basis functions, $K = 2|\\mathcal{H}|$) and the normal field vector $\\mathbf{b}_\\mathrm{calc} \\in \\mathbb{R}^N$ at the collocation points is expressed by a matrix equation $\\mathbf{A}\\mathbf{c} = \\mathbf{b}_\\mathrm{calc}$. The matrix $\\mathbf{A}$ is the response matrix, where the entry $A_{ij}$ is the normal magnetic field at plasma point $i$ produced by the $j$-th basis function with its coefficient set to $1$.\n\nA column of $\\mathbf{A}$ corresponding to a single basis function $\\lambda_j$ is computed by evaluating the Biot-Savart integral numerically. For each plasma point $\\mathbf{r}_{\\mathrm{p},i}$ with normal $\\hat{\\mathbf{n}}_{\\mathrm{p},i}$, the matrix element is:\n$$\nA_{ij} = \\hat{\\mathbf{n}}_{\\mathrm{p},i} \\cdot \\left( \\frac{\\mu_0}{4\\pi} \\sum_{q=1}^{N_\\theta^\\mathrm{w} N_\\zeta^\\mathrm{w}} \\frac{\\mathbf{K}_j(\\mathbf{r}_{\\mathrm{w},q}) \\times (\\mathbf{r}_{\\mathrm{p},i} - \\mathbf{r}_{\\mathrm{w},q})}{\\lVert \\mathbf{r}_{\\mathrm{p},i} - \\mathbf{r}_{\\mathrm{w},q} \\rVert^3} J_{\\mathrm{w},q} \\Delta\\theta_\\mathrm{w} \\Delta\\zeta_\\mathrm{w} \\right)\n$$\nwhere the sum is over the quadrature points on the winding surface, and $\\mathbf{K}_j$ is the surface current derived from the basis function $\\lambda_j$. Using the simplified integral, this becomes:\n$$\nA_{ij} = \\hat{\\mathbf{n}}_{\\mathrm{p},i} \\cdot \\left( \\frac{\\mu_0}{4\\pi} \\sum_{q} \\frac{\\left( \\frac{\\partial \\lambda_j}{\\partial \\theta} \\mathbf{e}_{\\zeta,q} - \\frac{\\partial \\lambda_j}{\\partial \\zeta} \\mathbf{e}_{\\theta,q} \\right) \\times (\\mathbf{r}_{\\mathrm{p},i} - \\mathbf{r}_{\\mathrm{w},q})}{\\lVert \\mathbf{r}_{\\mathrm{p},i} - \\mathbf{r}_{\\mathrm{w},q} \\rVert^3} \\Delta\\theta_\\mathrm{w} \\Delta\\zeta_\\mathrm{w} \\right)\n$$\nwhere $\\Delta\\theta_\\mathrm{w} = 2\\pi/N_\\theta^\\mathrm{w}$ and $\\Delta\\zeta_\\mathrm{w} = 2\\pi/N_\\zeta^\\mathrm{w}$ are the quadrature weights for the rectangle rule.\n\n**3. Geometric Quantities**\n\nThe geometric definitions for the surfaces must be implemented first. For a surface given by $\\mathbf{r}_\\mathrm{surf}(\\theta,\\zeta; R_0,a,\\varepsilon,m,n)$, the Cartesian components are:\n$$\n\\begin{align*}\nx &= (R_0 + a \\cos \\theta + \\varepsilon \\cos(m\\theta - n\\zeta)) \\cos \\zeta \\\\\ny &= (R_0 + a \\cos \\theta + \\varepsilon \\cos(m\\theta - n\\zeta)) \\sin \\zeta \\\\\nz &= a \\sin \\theta + \\varepsilon \\sin(m\\theta - n\\zeta)\n\\end{align*}\n$$\nAnalytical partial derivatives with respect to $\\theta$ and $\\zeta$ are computed to find the tangent vectors $\\mathbf{e}_\\theta = \\partial \\mathbf{r}/\\partial \\theta$ and $\\mathbf{e}_\\zeta = \\partial \\mathbf{r}/\\partial \\zeta$. The unnormalized normal vector on the plasma boundary is then $\\mathbf{n}_\\mathrm{p} = \\mathbf{e}_{\\theta,\\mathrm{p}} \\times \\mathbf{e}_{\\zeta,\\mathrm{p}}$, and the unit normal is $\\hat{\\mathbf{n}}_\\mathrm{p} = \\mathbf{n}_\\mathrm{p} / \\lVert \\mathbf{n}_\\mathrm{p} \\rVert$. These quantities are evaluated on their respective grids.\n\n**4. Optimization**\n\nThe goal is to find the coefficient vector $\\mathbf{c}$ that minimizes the squared difference between the calculated normal field $\\mathbf{A}\\mathbf{c}$ and the target normal field vector $\\mathbf{b}$, where $\\mathbf{b}$ is formed by evaluating $B_n^\\mathrm{target}$ at the plasma collocation points. To handle potential ill-conditioning and to favor physically smoother currents, a Tikhonov regularization term is added. The optimization problem is:\n$$\n\\min_{\\mathbf{c} \\in \\mathbb{R}^K} \\left\\lVert \\mathbf{A}\\mathbf{c} - \\mathbf{b} \\right\\rVert_2^2 + \\alpha \\left\\lVert \\mathbf{W}\\mathbf{c} \\right\\rVert_2^2\n$$\nHere, $\\alpha > 0$ is the regularization parameter. $\\mathbf{W}$ is a diagonal weighting matrix where the entry for a basis function with mode numbers $(m_k, n_k)$ is $w_k = \\sqrt{m_k^2 + n_k^2}$. This penalizes harmonics with higher mode numbers (i.e., more spatial oscillations), promoting a smoother current distribution. This minimization problem is equivalent to solving the following system of linear normal equations for $\\mathbf{c}$:\n$$\n(\\mathbf{A}^\\top \\mathbf{A} + \\alpha \\mathbf{W}^\\top \\mathbf{W}) \\mathbf{c} = \\mathbf{A}^\\top \\mathbf{b}\n$$\nThis system is solved using standard linear algebra routines.\n\n**5. Error Evaluation**\n\nOnce the optimal coefficient vector $\\mathbf{c}$ is found, the residual vector $\\mathbf{r} = \\mathbf{A}\\mathbf{c} - \\mathbf{b}$ is computed. The overall quality of the solution is quantified by the root-mean-square (RMS) of this residual:\n$$\n\\mathrm{RMS} = \\sqrt{\\frac{1}{N} \\sum_{i=1}^N r_i^2}\n$$\nThis value, in units of Tesla, represents the average magnitude of the uncancelled normal magnetic field on the plasma boundary.\n\n**6. Analysis of Test Cases**\n\n- **Case A** uses a basis set $\\mathcal{H} = \\{(2,1),(1,2),(1,1)\\}$, which includes the harmonics present in the target field $B_n^\\mathrm{target} = B_0 [\\cos(2\\theta - \\zeta) + 0.3\\,\\sin(\\theta - 2\\zeta)]$, plus an additional harmonic $(1,1)$. With a small regularization parameter $\\alpha = 10^{-6}$, the solution should be able to accurately approximate the target, resulting in a low RMS error.\n- **Case B** uses the same comprehensive basis set as Case A but with a much larger regularization parameter $\\alpha = 10^{-2}$. This strong penalty on the magnitude of the coefficients (weighted by mode number) will restrict the complexity of the current, leading to a poorer cancellation of the target field and a significantly higher RMS error.\n- **Case C** involves model misspecification. The basis set $\\mathcal{H} = \\{(2,1)\\}$ is incomplete, as it lacks the $(1,2)$ harmonic required to cancel the second term in $B_n^\\mathrm{target}$. Even with weak regularization ($\\alpha = 10^{-6}$), the model cannot represent the target field completely, which will result in a substantial RMS error, likely dominated by the uncancelled $\\sin(\\theta - 2\\zeta)$ component.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the stellarator coil design problem for three test cases.\n    \"\"\"\n    # Physical and geometrical constants\n    MU0 = 4 * np.pi * 1e-7  # Permeability of free space (T*m/A)\n    R0 = 3.0  # Major radius (m)\n\n    # Plasma surface parameters\n    a_p = 0.5\n    eps_p = 0.03\n    m_p = 2\n    n_p = 1\n    N_theta_p = 12\n    N_zeta_p = 12\n\n    # Winding surface parameters\n    a_w = 0.9\n    eps_w = 0.05\n    m_w = 2\n    n_w = 1\n    N_theta_w = 20\n    N_zeta_w = 20\n\n    # Target field parameters\n    B0 = 3.0e-4\n\n    # Test cases\n    cases = [\n        {'name': 'A', 'H': [(2, 1), (1, 2), (1, 1)], 'alpha': 1e-6},\n        {'name': 'B', 'H': [(2, 1), (1, 2), (1, 1)], 'alpha': 1e-2},\n        {'name': 'C', 'H': [(2, 1)], 'alpha': 1e-6}\n    ]\n\n    def get_surface_geometry(theta, zeta, R0_val, a, eps, m, n):\n        \"\"\"\n        Computes surface position vector and its derivatives.\n        theta and zeta can be 1D or 2D arrays.\n        \"\"\"\n        R = R0_val + a * np.cos(theta) + eps * np.cos(m * theta - n * zeta)\n        R_d_theta = -a * np.sin(theta) - m * eps * np.sin(m * theta - n * zeta)\n        R_d_zeta = n * eps * np.sin(m * theta - n * zeta)\n\n        cos_zeta = np.cos(zeta)\n        sin_zeta = np.sin(zeta)\n\n        r = np.stack([\n            R * cos_zeta,\n            R * sin_zeta,\n            a * np.sin(theta) + eps * np.sin(m * theta - n * zeta)], axis=-1)\n\n        e_theta = np.stack([\n            R_d_theta * cos_zeta,\n            R_d_theta * sin_zeta,\n            a * np.cos(theta) + m * eps * np.cos(m * theta - n * zeta)], axis=-1)\n        \n        e_zeta = np.stack([\n            R_d_zeta * cos_zeta - R * sin_zeta,\n            R_d_zeta * sin_zeta + R * cos_zeta,\n            -n * eps * np.cos(m * theta - n * zeta)], axis=-1)\n        \n        return r, e_theta, e_zeta\n\n    # --- Pre-computation for Plasma Surface ---\n    theta_p_1d = np.linspace(0, 2 * np.pi, N_theta_p, endpoint=False)\n    zeta_p_1d = np.linspace(0, 2 * np.pi, N_zeta_p, endpoint=False)\n    theta_p_grid, zeta_p_grid = np.meshgrid(theta_p_1d, zeta_p_1d, indexing='ij')\n\n    r_p_grid, e_theta_p, e_zeta_p = get_surface_geometry(\n        theta_p_grid, zeta_p_grid, R0, a_p, eps_p, m_p, n_p)\n    \n    n_p_vec_grid = np.cross(e_theta_p, e_zeta_p, axis=-1)\n    norm_n_p = np.linalg.norm(n_p_vec_grid, axis=-1, keepdims=True)\n    n_p_unit_grid = n_p_vec_grid / norm_n_p\n\n    N_p = N_theta_p * N_zeta_p\n    r_p_flat = r_p_grid.reshape(N_p, 3)\n    n_p_unit_flat = n_p_unit_grid.reshape(N_p, 3)\n\n    # --- Pre-computation for Winding Surface ---\n    d_theta_w = 2 * np.pi / N_theta_w\n    d_zeta_w = 2 * np.pi / N_zeta_w\n    theta_w_1d = np.linspace(0, 2 * np.pi, N_theta_w, endpoint=False)\n    zeta_w_1d = np.linspace(0, 2 * np.pi, N_zeta_w, endpoint=False)\n    theta_w_grid, zeta_w_grid = np.meshgrid(theta_w_1d, zeta_w_1d, indexing='ij')\n\n    r_w_grid, e_theta_w, e_zeta_w = get_surface_geometry(\n        theta_w_grid, zeta_w_grid, R0, a_w, eps_w, m_w, n_w)\n\n    # --- Target Field Vector b ---\n    b_target = B0 * (np.cos(2 * theta_p_grid - zeta_p_grid) + 0.3 * np.sin(theta_p_grid - 2 * zeta_p_grid))\n    b = b_target.flatten()\n\n    results = []\n    for case in cases:\n        harmonics = case['H']\n        alpha = case['alpha']\n        \n        basis_functions = []\n        for m, n in harmonics:\n            basis_functions.append({'m': m, 'n': n, 'type': 'cos'})\n            basis_functions.append({'m': m, 'n': n, 'type': 'sin'})\n        \n        K = len(basis_functions)\n        A = np.zeros((N_p, K))\n        W = np.zeros((K, K))\n\n        for k, basis in enumerate(basis_functions):\n            m, n, f_type = basis['m'], basis['n'], basis['type']\n            W[k, k] = np.sqrt(m**2 + n**2)\n            \n            # Derivatives of the basis stream function lambda_k\n            if f_type == 'cos':\n                # lambda = cos(m*theta - n*zeta)\n                dlambda_dtheta = -m * np.sin(m * theta_w_grid - n * zeta_w_grid)\n                dlambda_dzeta = n * np.sin(m * theta_w_grid - n * zeta_w_grid)\n            else: # sin\n                # lambda = sin(m*theta - n*zeta)\n                dlambda_dtheta = m * np.cos(m * theta_w_grid - n * zeta_w_grid)\n                dlambda_dzeta = -n * np.cos(m * theta_w_grid - n * zeta_w_grid)\n\n            # Surface current density * Jacobian: K*J\n            K_J = (dlambda_dtheta[..., np.newaxis] * e_zeta_w - \n                   dlambda_dzeta[..., np.newaxis] * e_theta_w)\n\n            # Build column k of matrix A\n            for i in range(N_p):\n                r_p = r_p_flat[i]\n                n_p = n_p_unit_flat[i]\n                \n                # Vector from source to field point\n                diff = r_p - r_w_grid\n                dist_cubed = np.linalg.norm(diff, axis=-1)**3\n                \n                # Biot-Savart integrand vector (K*J x diff / |diff|^3)\n                integrand_vec = np.cross(K_J, diff) / dist_cubed[..., np.newaxis]\n\n                # Numerical integration (sum over winding grid)\n                B_vec = np.sum(integrand_vec, axis=(0, 1)) * d_theta_w * d_zeta_w\n                B_vec *= (MU0 / (4 * np.pi))\n\n                # Normal component of the B-field at plasma point i\n                A[i, k] = np.dot(n_p, B_vec)\n\n        # Solve the normal equations\n        AtA = A.T @ A\n        WtW = W.T @ W\n        Atb = A.T @ b\n        \n        # System: (AtA + alpha * WtW) c = Atb\n        # SciPy's linalg.solve is more robust, but numpy's is sufficient here.\n        c = np.linalg.solve(AtA + alpha * WtW, Atb)\n        \n        # Compute residual and RMS error\n        residual = A @ c - b\n        rms_error = np.sqrt(np.mean(residual**2))\n        results.append(rms_error)\n\n    # Format output as specified\n    formatted_results = [f\"{r:.6e}\" for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}