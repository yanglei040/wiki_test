{
    "hands_on_practices": [
        {
            "introduction": "在计算物理学中，验证模拟算法是否忠实地生成了预期的统计系综是至关重要的一步。本实践将指导您通过分析系统动能的分布来检验一个恒温（NVT）模拟是否真正处于正则系综。这个练习的核心是，对于一个处于正则系综的系统，其动能应遵循一个由自由度决定的特定$\\chi^2$分布，任何偏离都可能意味着模拟存在问题 。通过编写代码来执行这种验证，您将掌握一种连接抽象统计力学理论与具体模拟数据分析的关键技能。",
            "id": "3410952",
            "problem": "你需要编写一个完整、可运行的程序，用于交叉验证来自三个假设的分子动力学 (MD) 软件包在定粒子数、定体积、定温度 (NVT) 系综（也即正则系综）中采样的动能分布。该验证基于统计力学的基本原理：对于一个在温度 $T$ 下，由 $N$ 个相同粒子组成的正则系综 (NVT) 系统，其瞬时动能 $K$ 的分布由动量的麦克斯韦-玻尔兹曼分布所决定。具体而言，当移除质心 (COM) 动量后，平动自由度 (DOF) 的数量为 $f = 3N - 3$，标度化动能 $Y = 2K/(k_B T)$ 服从自由度为 $f$ 的卡方分布。你的任务是实现一个交叉验证程序，检验每个软件包生成的合成动能样本是否与正确自由度计算下的预期卡方分布一致，并检测出由非正则采样或自由度处理不当引起的偏差。\n\n请从以下基本原理出发：正则相空间分布的概率密度与 $\\exp(-\\beta H)$ 成正比，其中 $\\beta = 1/(k_B T)$，哈密顿量 $H = K + U$。在该系综中，对于无约束的自由度，动量分量是独立的高斯变量。基于此，推导出 $K$ 和标度化变量 $Y$ 的分布，并据此设计检验方法。\n\n你必须为一系列测试用例，生成来自三个假设的 MD 软件包的合成动能样本。使用约化单位，其中玻尔兹曼常数 $k_B = 1$，因此能量和温度均为无量纲。无需进行物理单位转换。对每个测试用例，定义 $N$、$T$ 和样本数量 $n_s$，并生成以下三个数据集：\n- 软件包 A (正则，正确自由度)：从 $Y \\sim \\chi^2_f$ (其中 $f = 3N - 3$) 中抽样，并设置 $K = (k_B T/2) Y$。\n- 软件包 B (自由度计算错误)：从 $Y \\sim \\chi^2_{3N}$ (即未移除质心运动) 中抽样，并设置 $K = (k_B T/2) Y$；此数据集将与预期的 $f = 3N - 3$ 进行检验。\n- 软件包 C (方差受抑制的非正则采样)：如同软件包 A 一样从 $Y \\sim \\chi^2_f$ 中抽样，然后构造 $Y' = f + \\alpha_v (Y - f)$ (其中方差收缩因子 $\\alpha_v = 0.6$)，并设置 $K = (k_B T/2) Y'$。\n\n为了保证可复现性，请使用固定的随机种子。对于索引为 $i$ 的测试用例（从 $i = 1$ 开始），软件包 A 使用种子 $s_A = 12345 + i$，软件包 B 使用种子 $s_B = 22345 + i$，软件包 C 使用种子 $s_C = 32345 + i$。\n\n对于每个数据集，执行以下验证步骤：\n1. 计算 $f = 3N - 3$。如果 $f \\le 0$，则该测试用例中所有三个软件包均返回失败（布尔值 $False$），因为 $Y$ 的正则分布是简并的，检验是不适定的。\n2. 计算标度化动能 $Y_i = 2K_i/(k_B T)$，其中 $i = 1, \\ldots, n_s$。\n3. 对 $Y$ 进行柯尔莫哥洛夫-斯米尔诺夫 (KS) 拟合优度检验，以检验其是否符合自由度为 $f$ 的卡方分布，并获得一个 p 值。使用显著性水平 $\\alpha = 0.01$。如果 $p \\ge \\alpha$，则 KS 检验通过。\n4. 独立地检查样本均值与卡方分布期望均值的一致性。$Y$ 的期望均值为 $f$，其方差为 $2f$。$n_s$ 个样本的样本均值的方差为 $2f/n_s$。计算 z 分数 $z = | \\overline{Y} - f | / \\sqrt{2f/n_s}$，并根据标准正态分布定义临界值 $z_{\\mathrm{crit}} = \\Phi^{-1}(1 - \\alpha/2)$，其中 $\\Phi^{-1}$ 是逆累积分布函数。如果 $z \\le z_{\\mathrm{crit}}$，则均值一致性检验通过。\n5. 只有当 KS 检验和均值一致性检验都通过时，数据集才被视为一致（布尔值 $True$）。\n\n为以下测试套件实现上述过程：\n- 测试用例 $1$：$N = 64$, $T = 2.0$, $n_s = 20000$。\n- 测试用例 $2$：$N = 8$, $T = 1.5$, $n_s = 20000$。\n- 测试用例 $3$：$N = 1$, $T = 1.0$, $n_s = 10000$。\n- 测试用例 $4$：$N = 256$, $T = 0.7$, $n_s = 30000$。\n\n你的程序应产生单行输出，其中包含一个用方括号括起来的逗号分隔列表，布尔值按 $[A_1,B_1,C_1,A_2,B_2,C_2,A_3,B_3,C_3,A_4,B_4,C_4]$ 的顺序列出，其中 $A_i$ 对应于测试用例 $i$ 的软件包 A，$B_i$ 对应于软件包 B，$C_i$ 对应于软件包 C。\n\n请确保你的实现精确而严谨。不涉及角度。能量和温度均使用约化无量纲单位，且 $k_B = 1$。不允许外部输入或文件；所有数据必须根据上述规则在内部生成。",
            "solution": "目标是开发一个计算程序，用以根据正则系综理论的预测来验证模拟分子动力学轨迹中的动能分布。这包括推导动能的理论分布，并实施统计检验以检查其一致性。\n\n该问题建立在正则系综的统计力学原理之上。正则系综描述了一个具有固定粒子数 $N$、体积 $V$ 和温度 $T$ 的系统。系统处于具有相空间坐标 $(\\mathbf{q}, \\mathbf{p})$ 和哈密顿量 $H(\\mathbf{q}, \\mathbf{p})$ 的特定微观态的概率由概率密度函数 $p(\\mathbf{q}, \\mathbf{p}) \\propto \\exp(-\\beta H(\\mathbf{q}, \\mathbf{p}))$ 给出，其中 $\\beta = 1/(k_B T)$，$k_B$ 是玻尔兹曼常数。哈密顿量是动能 $K(\\mathbf{p})$ 和势能 $U(\\mathbf{q})$ 的和，即 $H = K + U$。\n\n通过对完整的相空间概率密度在所有位置坐标 $\\mathbf{q}$ 上积分，可以得到动能的分布。由于 $K$ 仅依赖于动量 $\\mathbf{p}$，得到的动量分布为 $p(\\mathbf{p}) \\propto \\exp(-\\beta K(\\mathbf{p}))$。对于一个由 $N$ 个质量为 $m$ 的相同粒子组成的系统，其动能是所有 $3N$ 个笛卡尔动量分量 $p_j$ 贡献的总和：\n$$K = \\sum_{j=1}^{3N} \\frac{p_j^2}{2m}$$\n这意味着每个动量分量 $p_j$ 都是一个独立的随机变量，服从均值为 $0$、方差为 $m/\\beta = m k_B T$ 的高斯分布。因此，标度化动量分量 $p_j / \\sqrt{m k_B T}$ 是一个标准正态变量，即 $p_j / \\sqrt{m k_B T} \\sim \\mathcal{N}(0, 1)$。\n\n标度化瞬时动能，记作 $Y$，定义为：\n$$Y = \\frac{2K}{k_B T} = \\frac{2}{k_B T} \\sum_{j=1}^{3N} \\frac{p_j^2}{2m} = \\sum_{j=1}^{3N} \\left(\\frac{p_j}{\\sqrt{m k_B T}}\\right)^2$$\n根据定义，自由度为 $f$ 的卡方 ($\\chi^2$) 分布是 $f$ 个独立标准正态随机变量平方和的分布。如果所有 $3N$ 个动量分量都是独立的，那么 $Y$ 将服从自由度为 $3N$ 的卡方分布，即 $Y \\sim \\chi^2_{3N}$。\n\n然而，在 NVT 系综中对孤立系统进行的典型分子动力学模拟中，系统的总线性动量是守恒的，并且通常固定为零以保持质心静止。这给动量分量施加了 $3$ 个约束：\n$$\\sum_{i=1}^{N} \\mathbf{p}_i = \\mathbf{0} \\quad \\implies \\quad \\sum_{i=1}^{N} p_{ix} = 0, \\quad \\sum_{i=1}^{N} p_{iy} = 0, \\quad \\sum_{i=1}^{N} p_{iz} = 0$$\n这些约束使动能总和中独立二次项的数量减少了 $3$。因此，正确的平动自由度数量为 $f = 3N - 3$。对于这样的系统，标度化动能 $Y$ 应由自由度为 $f = 3N - 3$ 的卡方分布正确描述，即 $Y \\sim \\chi^2_{f}$。该分布的期望均值为 $\\mathbb{E}[Y] = f$，方差为 $\\mathrm{Var}[Y] = 2f$。\n\n验证程序旨在检验来自给定模拟的动能样本 $\\{K_i\\}$ 是否符合这一理论预期。对于由 $N$、$T$ 和样本量 $n_s$ 定义的每个测试用例，以及三个假设的软件包中的每一个，执行以下步骤：\n\n1.  **自由度计算与合理性检查**：计算自由度数 $f = 3N - 3$。如果 $N \\le 1$，则 $f \\le 0$。$\\chi^2_0$ 分布是在 $0$ 处的一个简并点质量，标准的统计检验对其是不适定的。根据问题规定，这种情况自动被视为无效，三个软件包的验证均返回失败（布尔值 $False$）。\n\n2.  **数据生成与标度化**：为每个软件包生成合成动能样本。\n    - **软件包 A**：通过从自由度为 $f = 3N-3$ 的 $\\chi^2_f$ 分布中抽取标度化能量 $Y$ 来模拟正确的正则采样。\n    - **软件包 B**：通过从 $\\chi^2_{3N}$ 分布中抽取 $Y$ 来模拟错误的自由度计算。\n    - **软件包 C**：模拟能量涨落受抑制的非正则采样。它从 $\\chi^2_f$ 分布中生成样本 $Y$，然后通过 $Y' = f + \\alpha_v (Y - f)$ 进行变换，其中方差收缩因子 $\\alpha_v = 0.6$。\n    对于每个软件包，根据问题中使用的约化单位，玻尔兹曼常数 $k_B=1$，动能样本计算为 $K = (k_B T/2) Y$（或 $Y'$）。为了后续检验，这些 $K$ 样本被重新标度化为 $Y_i = 2K_i/T$。\n\n3.  **柯尔莫哥洛夫-斯米尔诺夫 (KS) 检验**：这是一种非参数拟合优度检验，它将样本数据 $\\{Y_i\\}$ 的累积分布函数 (CDF) 与目标分布（即 $\\chi^2_f$）的理论 CDF 进行比较。该检验得出一个 p 值，即在原假设（数据来自目标分布）成立的情况下，观测到至少与实测样本一样极端的样本的概率。如果 p 值大于或等于所选的显著性水平 $\\alpha = 0.01$，则认为检验通过。一个低的 p 值 ($p  \\alpha$) 表示分布的形状存在显著偏差。\n\n4.  **均值一致性检验**：此检验检查标度化动能的样本均值是否与其理论期望一致。计算样本均值 $\\overline{Y} = \\frac{1}{n_s}\\sum_{i=1}^{n_s} Y_i$。根据中心极限定理，对于大量样本 $n_s$，$\\overline{Y}$ 近似服从正态分布，其均值为 $\\mathbb{E}[\\overline{Y}] = f$，方差为 $\\mathrm{Var}[\\overline{Y}] = \\mathrm{Var}[Y]/n_s = 2f/n_s$。计算一个 z 分数，以标准误差为单位来衡量样本均值与期望均值的偏差：\n    $$z = \\frac{|\\overline{Y} - f|}{\\sqrt{2f/n_s}}$$\n    将该 z 分数与在显著性水平 $\\alpha$ 下，进行双尾检验的标准正态分布的临界值 $z_{\\mathrm{crit}}$ 进行比较。临界值为 $z_{\\mathrm{crit}} = \\Phi^{-1}(1 - \\alpha/2)$，其中 $\\Phi^{-1}$ 是标准正态分布的逆累积分布函数。对于 $\\alpha = 0.01$，$z_{\\mathrm{crit}} \\approx 2.576$。如果 $z \\le z_{\\mathrm{crit}}$，则检验通过。\n\n5.  **最终判定**：只有当一个数据集同时通过了 KS 检验和均值一致性检验时，才被认为与正则系综理论一致。\n\n这种严谨的由两部分组成的验证是稳健的。均值检验对平均能量的系统误差（例如，不正确的自由度）很敏感，而 KS 检验对分布的整体形状（包括其方差和更高阶矩）很敏感，使其能够检测到更细微的偏离正则采样的情况，例如软件包 C 中受抑制的涨落。软件包 A 应该通过，而软件包 B（错误的均值）和软件包 C（错误的方差）预计会失败。",
            "answer": "```python\nimport numpy as np\nfrom scipy.stats import kstest, chi2, norm\n\ndef solve():\n    \"\"\"\n    Main function to run the cross-validation for all test cases and print results.\n    \"\"\"\n    test_cases = [\n        # (N, T, n_s)\n        (64, 2.0, 20000),\n        (8, 1.5, 20000),\n        (1, 1.0, 10000),\n        (256, 0.7, 30000),\n    ]\n    \n    # Constants from the problem statement\n    k_B = 1.0\n    alpha_v = 0.6\n    alpha_sig = 0.01\n\n    results = []\n    \n    for i, (N, T, n_s) in enumerate(test_cases, 1):\n        # Step 1: Compute DOF and handle the degenerate case\n        f = 3 * N - 3\n        if f = 0:\n            results.extend([False, False, False])\n            continue\n            \n        # Define random seeds for reproducibility\n        seed_A = 12345 + i\n        seed_B = 22345 + i\n        seed_C = 32345 + i\n        \n        # --- Data Generation ---\n\n        # Package A: Correct canonical sampling\n        rng_A = np.random.default_rng(seed_A)\n        Y_samples_A = rng_A.chisquare(f, n_s)\n        K_samples_A = (k_B * T / 2.0) * Y_samples_A\n        \n        # Package B: Incorrect DOF accounting\n        rng_B = np.random.default_rng(seed_B)\n        Y_samples_B = rng_B.chisquare(3 * N, n_s)\n        K_samples_B = (k_B * T / 2.0) * Y_samples_B\n        \n        # Package C: Non-canonical sampling with suppressed variance\n        rng_C = np.random.default_rng(seed_C)\n        Y_base_samples_C = rng_C.chisquare(f, n_s)\n        Y_samples_C = f + alpha_v * (Y_base_samples_C - f)\n        K_samples_C = (k_B * T / 2.0) * Y_samples_C\n        \n        # --- Validation ---\n        \n        result_A = validate_dataset(K_samples_A, N, T, n_s, alpha_sig)\n        result_B = validate_dataset(K_samples_B, N, T, n_s, alpha_sig)\n        result_C = validate_dataset(K_samples_C, N, T, n_s, alpha_sig)\n        \n        results.extend([result_A, result_B, result_C])\n\n    # Final print statement in the exact required format\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef validate_dataset(K_samples: np.ndarray, N: int, T: float, n_s: int, alpha: float) -> bool:\n    \"\"\"\n    Performs the validation procedure for a single dataset.\n    \n    Args:\n        K_samples: Array of kinetic energy samples.\n        N: Number of particles.\n        T: Temperature.\n        n_s: Number of samples.\n        alpha: Significance level.\n\n    Returns:\n        True if the dataset passes both validation tests, False otherwise.\n    \"\"\"\n    f = 3 * N - 3\n    k_B = 1.0\n\n    # Step 2: Compute scaled kinetic energies\n    Y_samples = 2 * K_samples / (k_B * T)\n    \n    # Step 3: Kolmogorov-Smirnov goodness-of-fit test\n    # The 'args' parameter provides the degrees of freedom for the chi2 distribution.\n    ks_statistic, p_value = kstest(Y_samples, 'chi2', args=(f,))\n    ks_pass = p_value >= alpha\n\n    # Step 4: Mean consistency test\n    sample_mean_Y = np.mean(Y_samples)\n    expected_mean_Y = f\n    \n    # Variance of the theoretical chi-square distribution with f DOFs.\n    expected_var_Y = 2 * f\n    \n    # The standard error is the standard deviation of the sample mean's distribution.\n    # The denominator can't be zero due to the f > 0 check in the main loop.\n    std_error_of_mean = np.sqrt(expected_var_Y / n_s)\n    \n    z_score = np.abs(sample_mean_Y - expected_mean_Y) / std_error_of_mean\n    \n    # Critical value for a two-tailed test.\n    z_crit = norm.ppf(1 - alpha / 2.0)\n    \n    mean_pass = z_score = z_crit\n    \n    # Step 5: A dataset is consistent only if both tests pass.\n    return ks_pass and mean_pass\n\n# Execute the main function\nsolve()\n```"
        },
        {
            "introduction": "恒温器是分子动力学模拟中维持系统温度的常用工具，但它们是否总能精确地生成正则系综的相空间分布呢？这个练习引导我们从第一性原理出发，去审视一个确定性恒温器——高斯等动能（Gaussian isokinetic）动力学。通过推导这些动力学方程下的不变相空间测度，我们可以直接将其与正则系综的玻尔兹曼分布进行比较 。这项理论实践揭示了在有限尺寸系统中，即使是为特定系综设计的算法，也可能存在微妙的局限性，从而加深了我们对系综等价性条件的理解。",
            "id": "3410998",
            "problem": "考虑一个由$N$个经典粒子组成的三维空间系统，其演化遵循确定性的高斯等动能动力学。这是一种分子动力学(MD)形式，其中瞬时动能被约束为保持恒定。设位置为 $\\mathbf{q} \\in \\mathbb{R}^{3N}$，动量为 $\\mathbf{p} \\in \\mathbb{R}^{3N}$，质量为 $\\{m_i\\}_{i=1}^{3N}$，势能为 $U(\\mathbf{q})$，其产生的力为 $\\mathbf{F}(\\mathbf{q}) = -\\nabla_{\\mathbf{q}} U(\\mathbf{q})$。动能为 $K(\\mathbf{p}) = \\sum_{i=1}^{3N} \\frac{p_i^2}{2 m_i}$，施加的约束条件为 $K(\\mathbf{p}) = \\frac{3N}{2} k_B T$，其中 $T$ 为目标温度，$k_B$ 为玻尔兹曼常数。动力学由 $\\dot{\\mathbf{q}} = \\mathbf{p}/\\mathbf{m}$ 和 $\\dot{\\mathbf{p}} = \\mathbf{F}(\\mathbf{q}) - \\alpha(\\mathbf{q},\\mathbf{p}) \\mathbf{p}$ 定义，其中 $\\alpha(\\mathbf{q},\\mathbf{p})$ 是一个标量，其选择是为了在任何时刻都维持等动能约束。\n\n从确定性流的相空间连续性方程出发，推导与此高斯等动能动力学相关联的不变相空间测度 $\\rho(\\mathbf{q},\\mathbf{p})$。然后，求出由此测度诱导的构型边际分布，并用 $N$、$T$ 和 $k_B$ 表示构型分布的有效逆温度 $\\beta_{\\mathrm{eff}}$。将 $\\beta_{\\mathrm{eff}}$ 与目标逆温度 $\\beta = 1/(k_B T)$ 进行比较，并断定在动能约束为 $K(\\mathbf{p}) = \\frac{3N}{2} k_B T$ 的情况下，高斯等动能动力学对于有限的 $N$ 是否能再现逆温度为 $\\beta$ 的正则构型抽样。\n\n你的最终答案必须是比率 $\\beta_{\\mathrm{eff}}/\\beta$ 的闭式表达式。不需要进行数值计算或四舍五入。",
            "solution": "问题要求推导一个在高斯等动能动力学下演化系统的不变相空间测度，并确定由此产生的构型分布的有效逆温度。\n\n首先，我们验证问题陈述的有效性。\n步骤1：提取已知条件。\n- $N$个经典粒子组成的三维空间系统。\n- 相空间坐标：位置 $\\mathbf{q} \\in \\mathbb{R}^{3N}$ 和动量 $\\mathbf{p} \\in \\mathbb{R}^{3N}$。\n- 质量：$\\{m_i\\}_{i=1}^{3N}$。\n- 势能：$U(\\mathbf{q})$。\n- 力：$\\mathbf{F}(\\mathbf{q}) = -\\nabla_{\\mathbf{q}} U(\\mathbf{q})$。\n- 动能：$K(\\mathbf{p}) = \\sum_{i=1}^{3N} \\frac{p_i^2}{2 m_i}$。\n- 等动能约束：$K(\\mathbf{p}) = K_0 = \\frac{3N}{2} k_B T$，其中 $T$ 是目标温度，$k_B$ 是玻尔兹曼常数。\n- 运动方程：$\\dot{\\mathbf{q}} = \\mathbf{p}/\\mathbf{m}$ (其中 $(\\mathbf{p}/\\mathbf{m})_i = p_i/m_i$) 和 $\\dot{\\mathbf{p}} = \\mathbf{F}(\\mathbf{q}) - \\alpha(\\mathbf{q},\\mathbf{p}) \\mathbf{p}$。\n- 标量函数 $\\alpha(\\mathbf{q},\\mathbf{p})$ 是一个约束乘子，确保 $\\dot{K}(\\mathbf{p}) = 0$。\n\n步骤2：使用提取的已知条件进行验证。\n- 该问题具有科学依据。高斯等动能学是统计力学中一种成熟的模拟方法。\n- 该问题提法严谨，要求进行特定的推导并得出唯一的结果。\n- 该问题是客观的，并使用了精确的数学语言。\n- 该问题是自洽的，提供了所有必要的定义和方程。没有矛盾之处。\n- 该设置是计算物理学中的一个标准理论模型。\n- 结构逻辑清晰，可以导出一个有意义的解。\n\n步骤3：结论与行动。\n问题有效。我们继续求解。\n\n解题过程构建如下：\n1. 确定恒温器乘子 $\\alpha(\\mathbf{q},\\mathbf{p})$ 的表达式。\n2. 计算相空间压缩率 $\\Lambda$。\n3. 推导不变相空间测度 $\\rho(\\mathbf{q},\\mathbf{p})$。\n4. 获得边际构型分布 $P(\\mathbf{q})$。\n5. 确定有效逆温度 $\\beta_{\\mathrm{eff}}$ 并计算比率 $\\beta_{\\mathrm{eff}}/\\beta$。\n\n首先，我们通过施加等动能约束 $\\frac{dK}{dt} = 0$ 来求出 $\\alpha$。\n动能的时间导数为：\n$$ \\dot{K} = \\frac{d}{dt} \\left( \\sum_{i=1}^{3N} \\frac{p_i^2}{2 m_i} \\right) = \\sum_{i=1}^{3N} \\frac{p_i \\dot{p}_i}{m_i} $$\n使用矢量表示法，其中暗示按分量除以质量，这可以写作 $\\dot{K} = (\\mathbf{p}/\\mathbf{m}) \\cdot \\dot{\\mathbf{p}}$。代入 $\\dot{\\mathbf{p}}$ 的运动方程：\n$$ \\dot{K} = (\\mathbf{p}/\\mathbf{m}) \\cdot (\\mathbf{F} - \\alpha \\mathbf{p}) = (\\mathbf{p}/\\mathbf{m}) \\cdot \\mathbf{F} - \\alpha (\\mathbf{p}/\\mathbf{m}) \\cdot \\mathbf{p} $$\n注意到 $(\\mathbf{p}/\\mathbf{m}) \\cdot \\mathbf{p} = \\sum_{i=1}^{3N} \\frac{p_i^2}{m_i} = 2 \\sum_{i=1}^{3N} \\frac{p_i^2}{2m_i} = 2K$，我们有：\n$$ \\dot{K} = (\\mathbf{p}/\\mathbf{m}) \\cdot \\mathbf{F} - 2\\alpha K $$\n令 $\\dot{K}=0$ 并解出 $\\alpha$ 可得：\n$$ \\alpha = \\frac{(\\mathbf{p}/\\mathbf{m}) \\cdot \\mathbf{F}}{2K} = \\frac{\\sum_{i=1}^{3N} p_i F_i / m_i}{2K} $$\n\n接下来，我们确定相空间压缩率 $\\Lambda = \\nabla_{\\mathbf{\\Gamma}} \\cdot \\dot{\\mathbf{\\Gamma}}$，其中 $\\mathbf{\\Gamma} = (\\mathbf{q}, \\mathbf{p})$ 且 $\\dot{\\mathbf{\\Gamma}}=(\\dot{\\mathbf{q}}, \\dot{\\mathbf{p}})$。\n$$ \\Lambda = \\nabla_{\\mathbf{q}} \\cdot \\dot{\\mathbf{q}} + \\nabla_{\\mathbf{p}} \\cdot \\dot{\\mathbf{p}} $$\n第一项是 $\\nabla_{\\mathbf{q}} \\cdot (\\mathbf{p}/\\mathbf{m}) = \\sum_{i=1}^{3N} \\frac{\\partial}{\\partial q_i} (\\frac{p_i}{m_i}) = 0$。\n第二项是：\n$$ \\nabla_{\\mathbf{p}} \\cdot \\dot{\\mathbf{p}} = \\nabla_{\\mathbf{p}} \\cdot (\\mathbf{F} - \\alpha \\mathbf{p}) = \\nabla_{\\mathbf{p}} \\cdot \\mathbf{F} - \\nabla_{\\mathbf{p}} \\cdot (\\alpha \\mathbf{p}) $$\n由于 $\\mathbf{F}$ 仅依赖于 $\\mathbf{q}$，所以 $\\nabla_{\\mathbf{p}} \\cdot \\mathbf{F} = 0$。因此，$\\Lambda = - \\nabla_{\\mathbf{p}} \\cdot (\\alpha \\mathbf{p})$。\n使用散度的乘积法则：$\\nabla_{\\mathbf{p}} \\cdot (\\alpha \\mathbf{p}) = (\\nabla_{\\mathbf{p}} \\alpha) \\cdot \\mathbf{p} + \\alpha (\\nabla_{\\mathbf{p}} \\cdot \\mathbf{p})$。\n由于 $\\mathbf{p} \\in \\mathbb{R}^{3N}$，$\\nabla_{\\mathbf{p}} \\cdot \\mathbf{p} = \\sum_{i=1}^{3N} \\frac{\\partial p_i}{\\partial p_i} = 3N$。\n我们需要计算 $(\\nabla_{\\mathbf{p}} \\alpha) \\cdot \\mathbf{p} = \\sum_{j=1}^{3N} p_j \\frac{\\partial \\alpha}{\\partial p_j}$。\n$$ \\frac{\\partial \\alpha}{\\partial p_j} = \\frac{\\partial}{\\partial p_j} \\left( \\frac{\\sum_k p_k F_k/m_k}{2K} \\right) = \\frac{F_j/m_j}{2K} - \\frac{\\sum_k p_k F_k/m_k}{(2K)^2} \\frac{\\partial(2K)}{\\partial p_j} $$\n由于 $\\frac{\\partial(2K)}{\\partial p_j} = \\frac{\\partial}{\\partial p_j} \\sum_k \\frac{p_k^2}{m_k} = \\frac{2p_j}{m_j}$，我们得到：\n$$ \\frac{\\partial \\alpha}{\\partial p_j} = \\frac{F_j/m_j}{2K} - \\alpha \\frac{2p_j/m_j}{2K} = \\frac{F_j}{2Km_j} - \\frac{\\alpha p_j}{Km_j} $$\n然后，对 $j$ 求和：\n$$ (\\nabla_{\\mathbf{p}} \\alpha) \\cdot \\mathbf{p} = \\sum_{j=1}^{3N} p_j \\left( \\frac{F_j}{2Km_j} - \\frac{\\alpha p_j}{Km_j} \\right) = \\frac{\\sum_j p_j F_j/m_j}{2K} - \\frac{\\alpha}{K} \\sum_j \\frac{p_j^2}{m_j} = \\alpha - \\frac{\\alpha}{K}(2K) = -\\alpha $$\n因此，$\\nabla_{\\mathbf{p}} \\cdot (\\alpha \\mathbf{p}) = -\\alpha + 3N\\alpha = (3N-1)\\alpha$。\n相空间压缩率为 $\\Lambda = -(3N-1)\\alpha$。\n\n分布 $\\rho(\\mathbf{q}, \\mathbf{p}, t)$ 的相空间连续性方程为 $\\frac{\\partial \\rho}{\\partial t} + \\nabla_{\\mathbf{\\Gamma}} \\cdot (\\rho \\dot{\\mathbf{\\Gamma}}) = 0$。对于一个不变（稳态）测度，$\\frac{\\partial \\rho}{\\partial t} = 0$，因此 $\\nabla_{\\mathbf{\\Gamma}} \\cdot (\\rho \\dot{\\mathbf{\\Gamma}}) = 0$。\n将其展开可得 $\\dot{\\mathbf{\\Gamma}} \\cdot \\nabla_{\\mathbf{\\Gamma}} \\rho + \\rho (\\nabla_{\\mathbf{\\Gamma}} \\cdot \\dot{\\mathbf{\\Gamma}}) = 0$。\n第一项是沿轨道的全时间导数，所以 $\\frac{d\\rho}{dt} = -\\rho\\Lambda$。\n代入 $\\Lambda$：\n$$ \\frac{1}{\\rho}\\frac{d\\rho}{dt} = \\frac{d}{dt} \\ln \\rho = -\\Lambda = (3N-1)\\alpha $$\n代入 $\\alpha$ 的表达式，并使用 $\\dot{\\mathbf{q}} = \\mathbf{p}/\\mathbf{m}$ 和 $\\mathbf{F} = -\\nabla_{\\mathbf{q}}U$：\n$$ \\frac{d}{dt} \\ln \\rho = (3N-1) \\frac{(\\mathbf{p}/\\mathbf{m})\\cdot \\mathbf{F}}{2K} = -(3N-1) \\frac{\\dot{\\mathbf{q}}\\cdot \\nabla_{\\mathbf{q}}U}{2K_0} $$\n其中我们已将瞬时动能 $K$ 替换为其恒定值 $K_0$。\n由于 $\\frac{dU}{dt} = (\\nabla_{\\mathbf{q}} U) \\cdot \\dot{\\mathbf{q}}$，我们有：\n$$ \\frac{d}{dt} \\ln \\rho = -\\frac{3N-1}{2K_0} \\frac{dU}{dt} $$\n沿轨道积分此微分方程，可得出不变测度对 $U(\\mathbf{q})$ 依赖的函数形式：\n$$ \\ln \\rho = -\\frac{3N-1}{2K_0} U(\\mathbf{q}) + C' $$\n完整的不变相空间测度还必须包含等动能约束，这通过使用狄拉克δ函数来实现：\n$$ \\rho(\\mathbf{q},\\mathbf{p}) = C \\delta(K(\\mathbf{p}) - K_0) \\exp\\left( -\\frac{3N-1}{2K_0} U(\\mathbf{q}) \\right) $$\n其中 $C$ 是一个归一化常数。\n\n为求构型边际分布 $P(\\mathbf{q})$，我们将 $\\rho(\\mathbf{q},\\mathbf{p})$ 对所有动量 $\\mathbf{p}$ 进行积分：\n$$ P(\\mathbf{q}) = \\int d^{3N}p \\, \\rho(\\mathbf{q},\\mathbf{p}) = C \\exp\\left( -\\frac{3N-1}{2K_0} U(\\mathbf{q}) \\right) \\int d^{3N}p \\, \\delta(K(\\mathbf{p}) - K_0) $$\n对动量的积分是动能为常数 $K_0$ 的超球壳的表面积。该值是一个常数，与构型 $\\mathbf{q}$ 无关。因此，构型概率分布正比于指数项：\n$$ P(\\mathbf{q}) \\propto \\exp\\left( -\\frac{3N-1}{2K_0} U(\\mathbf{q}) \\right) $$\n在逆温度为 $\\beta$ 时的正则构型分布由 $P_{\\mathrm{can}}(\\mathbf{q}) \\propto \\exp(-\\beta U(\\mathbf{q}))$ 给出。通过将其与我们推导的分布进行比较，我们可以确定有效逆温度 $\\beta_{\\mathrm{eff}}$：\n$$ \\beta_{\\mathrm{eff}} = \\frac{3N-1}{2K_0} $$\n问题指明了约束值 $K_0 = \\frac{3N}{2} k_B T$ 和目标逆温度 $\\beta = \\frac{1}{k_B T}$。代入 $K_0$：\n$$ \\beta_{\\mathrm{eff}} = \\frac{3N-1}{2 \\left( \\frac{3N}{2} k_B T \\right)} = \\frac{3N-1}{3N k_B T} $$\n最后，我们计算有效逆温度与目标逆温度的比率：\n$$ \\frac{\\beta_{\\mathrm{eff}}}{\\beta} = \\frac{\\frac{3N-1}{3N k_B T}}{\\frac{1}{k_B T}} = \\frac{3N-1}{3N} = 1 - \\frac{1}{3N} $$\n对于任意有限的粒子数 $N$，该比率都小于 $1$，这意味着 $\\beta_{\\mathrm{eff}} \\neq \\beta$。因此，对于有限尺寸的系统，具有指定动能约束的高斯等动能动力学*不能*再现正则构型分布。等价性仅在热力学极限下才能实现，即 $N \\rightarrow \\infty$ 且 $\\frac{\\beta_{\\mathrm{eff}}}{\\beta} \\rightarrow 1$。",
            "answer": "$$\n\\boxed{1 - \\frac{1}{3N}}\n$$"
        },
        {
            "introduction": "系综之间的等价性是统计力学的基石之一，但它在某些条件下，如相变点附近，会失效。本实践将带您探索连接微正则系综与正则系综的数学桥梁——拉普拉斯变换，并通过数值计算来直观地理解系综等价性及其失效的情景。您将从给定的微正则态密度 $\\Omega(E)$ 出发，计算正则配分函数 $Z(\\beta)$ 及相关热力学量 。特别是，通过处理一个双峰形态的态密度函数（这通常是相变或相共存的标志），您将亲眼见证鞍点近似的失效，从而深刻理解系综不等价的物理根源。",
            "id": "3410951",
            "problem": "给定在离散能量格点上定义的微正则态密度函数 $\\Omega(E)$，这通常通过 Wang–Landau (WL) 抽样获得。您的任务是通过拉普拉斯变换重构正则热力学，并评估计算的数值稳定性以及鞍点近似的准确性，该近似代表了热力学极限中的系综等价性。所有量均为无量纲单位，玻尔兹曼常数 $k_{\\mathrm B}=1$，因此能量 $E$、逆温度 $\\beta$ 和熵 $S(E)=\\ln \\Omega(E)$ 都是无量纲的。不使用也不需要其他物理单位。\n\n使用的基本定义：\n- 正则配分函数由拉普拉斯变换定义 $Z(\\beta)=\\int_{0}^{\\infty}\\Omega(E)\\,\\mathrm{e}^{-\\beta E}\\,\\mathrm{d}E$。\n- 正则平均能量为 $U(\\beta)=\\int_{0}^{\\infty} E \\, \\pi_{\\beta}(E) \\,\\mathrm{d}E$，其中 $\\pi_{\\beta}(E)=\\Omega(E)\\,\\mathrm{e}^{-\\beta E}/Z(\\beta)$ 是归一化正则能量分布。\n- 微正则熵为 $S(E)=\\ln \\Omega(E)$，而主导能量的鞍点近似解出了勒让德变换的平稳性条件，在离散格点上，您应将其计算为 $F_{\\beta}(E)=S(E)-\\beta E$ 的最大化者。\n\n离散化要求：\n- 每个输入 $\\Omega(E)$ 都通过在均匀格点 $E_i=E_{\\min}+i\\,\\Delta E$（对于 $i=0,1,\\dots,N-1$）上的参数化形式隐式给出，该格点具有恒定间距 $\\Delta E=(E_{\\max}-E_{\\min})/(N-1)$。\n- 您必须使用梯形法则来近似拉普拉斯积分。为确保数值稳定性，您必须使用 log-sum-exp 变换来实现 $\\ln Z(\\beta)$ 的计算。具体来说，如果 $w_i$ 是梯形权重（$w_0=w_{N-1}=\\tfrac{1}{2}$，其他为 $w_i=1$），则定义 $f_i=\\ln \\Omega(E_i)-\\beta E_i+\\ln w_i+\\ln \\Delta E$，并使用最大值减法计算 $\\ln Z(\\beta)=\\ln \\sum_i \\exp(f_i)$，即 $\\ln Z(\\beta)=m+\\ln \\sum_i \\exp(f_i-m)$，其中 $m=\\max_i f_i$。\n- 正则平均能量必须使用与 $\\ln Z(\\beta)$ 相同的稳定化权重来计算，即 $U(\\beta)=\\sum_i E_i \\, \\exp(f_i-\\ln Z(\\beta))$。\n- 鞍点能量 $E_{\\ast}(\\beta)$ 必须通过在格点上最大化 $F_{\\beta}(E_i)=S(E_i)-\\beta E_i$ 来获得。\n\n数值稳定性评估：\n- 除了稳定化计算外，还需使用直接指数 $g_i=\\exp(\\ln \\Omega(E_i)-\\beta E_i)$ 进行朴素梯形求值，无需最大值减法。如果任何 $g_i$ 不是有限的，或者朴素配分和是非有限或非正的，则声明朴素求值为“不稳定”。如果它是有限且正的，则计算朴素正则平均能量 $U_{\\mathrm{naive}}(\\beta)$ 并与稳定化的 $U(\\beta)$ 进行比较。如果相对差异超过容差 $\\tau=10^{-6}$，则声明其不稳定；否则声明其稳定。\n- 对于每个测试用例，报告两个结果：(i) 平均能量的鞍点近似的相对绝对误差 $\\varepsilon=\\lvert E_{\\ast}(\\beta)-U(\\beta)\\rvert/\\max(U(\\beta),\\epsilon)$，其中 $\\epsilon=10^{-300}$ 以避免除以零；以及 (ii) 一个稳定性指标 $s$，如果朴素求值根据上述标准不稳定，则等于 $1.0$，否则等于 $0.0$。\n\n测试套件：\n实现以下三个案例，每个案例都由参数化的 $\\ln \\Omega(E)$ 和 $(E_{\\min},E_{\\max},N,\\beta)$ 完全指定：\n\n- 案例 1 (单峰，理想路径)：\n  - $\\ln \\Omega(E)=(a-1)\\ln E$，其中 $a=50$。这对应于一个理想化的多自由度动能态密度。\n  - 定义域：$E_{\\min}=10^{-9}$，$E_{\\max}=500$，$N=20001$。\n  - 逆温度：$\\beta=0.5$。\n\n- 案例 2 (双峰，系综非等价区)：\n  - $\\ln \\Omega(E)=\\ln\\left(\\exp\\left(A_1+s_1 E-\\dfrac{(E-m_1)^2}{2 w_1^2}\\right)+\\exp\\left(A_2+s_2 E-\\dfrac{(E-m_2)^2}{2 w_2^2}\\right)\\right)$，参数为 $A_1=0$, $s_1=0.06$, $m_1=40$, $w_1=8$, $A_2=2.0$, $s_2=0.015$, $m_2=140$, $w_2=8$。\n  - 定义域：$E_{\\min}=0$，$E_{\\max}=220$，$N=40001$。\n  - 逆温度：$\\beta=0.03$。\n\n- 案例 3 (极端尺度，数值稳定性压力测试)：\n  - $\\ln \\Omega(E)=(a-1)\\ln E$，其中 $a=200$。\n  - 定义域：$E_{\\min}=10^{-9}$，$E_{\\max}=50000$，$N=80001$。\n  - 逆温度：$\\beta=0.01$。\n\n计算与报告要求：\n- 全程使用自然对数。\n- 不使用角度；无需角度单位。\n- 对于每个案例，按上述规定计算并返回浮点数对 $(\\varepsilon,s)$。\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，格式为 $[\\varepsilon_1,s_1,\\varepsilon_2,s_2,\\varepsilon_3,s_3]$。",
            "solution": "该问题要求根据给定的、在离散能量格点上定义的微正则态密度 $\\Omega(E)$ 计算正则热力学性质。这涉及数值计算拉普拉斯变换。任务的一个关键部分是评估此过程的数值稳定性，并量化鞍点近似的准确性，这是热力学极限下系综等价性的一种体现。\n\n微正则熵 $S(E) = \\ln \\Omega(E)$ 与在逆温度 $\\beta$ 下的正则配分函数 $Z(\\beta)$ 之间的基本关系由拉普拉斯变换给出：\n$$\nZ(\\beta) = \\int_{0}^{\\infty} \\Omega(E) e^{-\\beta E} \\,\\mathrm{d}E = \\int_{0}^{\\infty} e^{S(E) - \\beta E} \\,\\mathrm{d}E\n$$\n正则平均能量 $U(\\beta)$ 是能量分布 $\\pi_{\\beta}(E) = e^{S(E)-\\beta E}/Z(\\beta)$ 的一阶矩：\n$$\nU(\\beta) = \\langle E \\rangle_{\\beta} = \\frac{\\int_{0}^{\\infty} E e^{S(E) - \\beta E} \\,\\mathrm{d}E}{\\int_{0}^{\\infty} e^{S(E) - \\beta E} \\,\\mathrm{d}E}\n$$\n在热力学极限下（对于大系统），被积函数 $e^{S(E)-\\beta E}$ 在其最大值周围形成一个尖锐的峰。使指数 $S(E)-\\beta E$ 最大化的能量 $E_{\\ast}(\\beta)$ 称为鞍点能量。这个条件等价于找到一个能量 $E$，使得微正则温度 $T(E) = (\\partial S/\\partial E)^{-1}$ 等于正则温度 $T = 1/\\beta$。对于大系统，系综等价性意味着正则平均能量 $U(\\beta)$ 应收敛于此鞍点能量 $E_{\\ast}(\\beta)$。\n\n定义的任务是为三个特定的测试用例数值实现这些计算，并报告 (i) 鞍点近似的相对误差 $\\varepsilon = \\lvert E_{\\ast}(\\beta)-U(\\beta)\\rvert/\\max(U(\\beta),\\epsilon)$ 和 (ii) 一个指示数值稳定性的标志 $s$，该稳定性是与稳定化方法相比，朴素计算方法的稳定性。\n\n算法流程如下：\n\n1.  **格点离散化**：对于每个案例，定义一个均匀能量格点 $E_i = E_{\\min} + i \\Delta E$（$i=0, \\dots, N-1$），其间距为 $\\Delta E = (E_{\\max}-E_{\\min})/(N-1)$。在此格点上计算微正则熵 $S(E_i) = \\ln \\Omega(E_i)$。\n\n2.  **鞍点能量计算**：通过识别使函数 $F_{\\beta}(E_i) = S(E_i) - \\beta E_i$ 最大化的格点 $E_i$ 来找到鞍点能量 $E_{\\ast}(\\beta)$。\n    $$\n    E_{\\ast}(\\beta) = \\underset{E_i}{\\mathrm{argmax}} \\left( S(E_i) - \\beta E_i \\right)\n    $$\n\n3.  **稳定化的正则计算**：使用梯形法则近似 $Z(\\beta)$ 和 $U(\\beta)$ 的积分。为了处理指数项中可能导致数值上溢或下溢的大范围数值，强制要求使用 log-sum-exp 稳定化技术。\n    配分函数积分近似为 $Z(\\beta) \\approx \\sum_{i=0}^{N-1} w_i \\Delta E \\, e^{S(E_i) - \\beta E_i}$，其中 $w_i$ 是梯形权重（$w_0=w_{N-1}=\\frac{1}{2}$，其他为 $w_i=1$）。\n    为了计算其对数，我们定义项 $f_i = S(E_i) - \\beta E_i + \\ln(w_i) + \\ln(\\Delta E)$，使得 $Z(\\beta) \\approx \\sum_i e^{f_i}$。\n    $\\ln Z(\\beta)$ 的稳定化计算为：\n    $$\n    m = \\max_i(f_i) \\\\\n    \\ln Z(\\beta) = m + \\ln\\left(\\sum_{i=0}^{N-1} e^{f_i - m}\\right)\n    $$\n    正则平均能量 $U(\\beta)$ 使用从此稳定化计算中导出的权重进行计算：\n    $$\n    U(\\beta) = \\frac{\\sum_i E_i w_i \\Delta E e^{S(E_i) - \\beta E_i}}{\\sum_i w_i \\Delta E e^{S(E_i) - \\beta E_i}} = \\frac{\\sum_i E_i e^{f_i}}{\\sum_i e^{f_i}} = \\sum_{i=0}^{N-1} E_i e^{f_i - \\ln Z(\\beta)}\n    $$\n\n4.  **数值稳定性评估**：同时也会执行一个朴素计算。设 $g_i = e^{S(E_i) - \\beta E_i}$。\n    朴素配分函数为 $Z_{\\mathrm{naive}} = \\sum_i w_i g_i \\Delta E$。\n    如果任何 $g_i$ 不是有限的，如果 $Z_{\\mathrm{naive}}$ 不是有限的或非正的，或者如果朴素平均能量 $U_{\\mathrm{naive}} = (\\sum_i E_i w_i g_i \\Delta E)/Z_{\\mathrm{naive}}$ 与稳定化的 $U(\\beta)$ 的相对差异超过 $\\tau=10^{-6}$，则该计算被视为不稳定（且稳定性标志 $s$ 设为 $1.0$）。否则，计算是稳定的（$s=0.0$）。\n\n5.  **报告**：对于每个测试用例，计算并报告数对 $(\\varepsilon, s)$。这三个案例旨在测试不同的物理和数值状况：一个标准的单峰系统（案例1），一个表现出系综非等价性的双峰系统（案例2），以及一个旨在导致朴素实现中数值上溢的大尺度系统（案例3）。对于双峰情况，函数 $\\ln \\Omega(E)$ 本身是一个对数-指数和，需要进行嵌套的稳定评估。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite for microcanonical to canonical ensemble calculations.\n    \"\"\"\n\n    def log_omega_power_law(E, a):\n        \"\"\"Computes ln(Omega(E)) for a power-law density of states.\"\"\"\n        # This handles vector input E, taking care of log(0) if E_min=0, although here E_min > 0.\n        return (a - 1) * np.log(E)\n\n    def log_omega_bimodal(E, **params):\n        \"\"\"Computes ln(Omega(E)) for a bimodal density of states using log-sum-exp.\"\"\"\n        p = params\n        term1 = p['A1'] + p['s1'] * E - ((E - p['m1'])**2) / (2 * p['w1']**2)\n        term2 = p['A2'] + p['s2'] * E - ((E - p['m2'])**2) / (2 * p['w2']**2)\n        \n        # Use log-sum-exp for numerical stability\n        max_term = np.maximum(term1, term2)\n        return max_term + np.log(np.exp(term1 - max_term) + np.exp(term2 - max_term))\n\n    def process_case(log_omega_func, E_min, E_max, N, beta, func_params):\n        \"\"\"\n        Processes a single test case to compute the saddle-point error and stability indicator.\n        \n        Returns:\n            A tuple (epsilon, s) containing the relative error and stability flag.\n        \"\"\"\n        # --- 1. Grid and Function Setup ---\n        E = np.linspace(E_min, E_max, N)\n        delta_E = (E_max - E_min) / (N - 1)\n        \n        # Handle E=0 in log for power law case (though not strictly necessary for problems as given)\n        if E_min == 0 and log_omega_func == log_omega_power_law:\n            log_omega_E = np.full_like(E, -np.inf)\n            log_omega_E[1:] = log_omega_func(E[1:], **func_params)\n        else:\n            log_omega_E = log_omega_func(E, **func_params)\n\n        # --- 2. Saddle-Point Energy Calculation ---\n        F_beta = log_omega_E - beta * E\n        E_star = E[np.argmax(F_beta)]\n\n        # --- 3. Stabilized Canonical Calculation ---\n        trapezoidal_weights = np.ones(N)\n        trapezoidal_weights[0] = 0.5\n        trapezoidal_weights[-1] = 0.5\n        \n        f = log_omega_E - beta * E + np.log(trapezoidal_weights) + np.log(delta_E)\n\n        # Log-sum-exp for ln(Z)\n        m = np.max(f[np.isfinite(f)]) # Avoid -inf from log(0) if any\n        log_Z = m + np.log(np.sum(np.exp(f - m)))\n        \n        # Stabilized mean energy U\n        U = np.sum(E * np.exp(f - log_Z))\n\n        # --- 4. Numerical Stability Assessment ---\n        s = 0.0\n        \n        # Naive calculation\n        with np.errstate(over='ignore'):\n            g = np.exp(log_omega_E - beta * E)\n        \n        if not np.all(np.isfinite(g)):\n            s = 1.0\n        else:\n            Z_naive = np.sum(trapezoidal_weights * g * delta_E)\n            if not np.isfinite(Z_naive) or Z_naive = 0:\n                s = 1.0\n            else:\n                U_naive = np.sum(trapezoidal_weights * E * g * delta_E) / Z_naive\n                \n                # Check relative difference\n                tau = 1e-6\n                if U == 0:\n                    if np.abs(U_naive) > tau:\n                        s = 1.0\n                elif np.abs(U_naive - U) / np.abs(U) > tau:\n                    s = 1.0\n\n        # --- 5. Error Calculation ---\n        epsilon_small = 1e-300\n        epsilon_rel_error = np.abs(E_star - U) / np.max([np.abs(U), epsilon_small])\n        \n        return epsilon_rel_error, s\n\n    # Define test cases\n    test_cases = [\n        {\n            \"log_omega_func\": log_omega_power_law,\n            \"E_min\": 1e-9, \"E_max\": 500, \"N\": 20001, \"beta\": 0.5,\n            \"func_params\": {\"a\": 50}\n        },\n        {\n            \"log_omega_func\": log_omega_bimodal,\n            \"E_min\": 0, \"E_max\": 220, \"N\": 40001, \"beta\": 0.03,\n            \"func_params\": {\n                'A1': 0, 's1': 0.06, 'm1': 40, 'w1': 8,\n                'A2': 2.0, 's2': 0.015, 'm2': 140, 'w2': 8\n            }\n        },\n        {\n            \"log_omega_func\": log_omega_power_law,\n            \"E_min\": 1e-9, \"E_max\": 50000, \"N\": 80001, \"beta\": 0.01,\n            \"func_params\": {\"a\": 200}\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        eps, s = process_case(**case)\n        results.extend([eps, s])\n\n    # Final print statement in the exact required format\n    print(f\"[{','.join(f'{r:.7e}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}