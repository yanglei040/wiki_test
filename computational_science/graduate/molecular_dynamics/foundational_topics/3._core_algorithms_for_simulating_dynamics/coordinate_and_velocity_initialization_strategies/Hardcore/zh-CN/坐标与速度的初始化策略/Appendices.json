{
    "hands_on_practices": [
        {
            "introduction": "在分子动力学模拟中，一个常见的步骤是移除系统的整体质心运动，以确保总线性动量为零。然而，执行此操作的顺序和方式可能会引入微妙的系统性误差。这项练习  探讨了一个常见的陷阱：在将速度调整到目标温度后才移除质心运动，并使用不正确的自由度数计算温度。通过这个实践，您将量化这种“朴素”操作对系统温度的预期影响，并推导出一个修正因子，这对于加深您对自由度和能量均分定理在施加约束时的理解至关重要。",
            "id": "3405734",
            "problem": "考虑一个包含 $N$ 个粒子的系统，其质量为 $\\{m_i\\}_{i=1}^{N}$，处于三维空间中，为分子动力学 (MD) 模拟进行初始化，其每个笛卡尔速度分量均独立地从目标温度为 $T_0$ 的 Maxwell–Boltzmann 分布中抽取。定义玻尔兹曼常数为 $k_B$，动能为 $K = \\sum_{i=1}^{N} \\frac{1}{2} m_i |\\mathbf{v}_i|^2$。一位实践者执行了一种朴素的初始化方法：首先对采样得到的速度 $\\{\\mathbf{v}_i\\}$ 进行重新标度，使得动能 $K$ 满足 $f = 3N$ 个自由度的能量均分预测值，然后通过从每个粒子的速度中减去质心速度 $\\mathbf{V}_{\\mathrm{CM}} = \\left(\\sum_{i=1}^{N} m_i \\mathbf{v}_i\\right)/\\left(\\sum_{i=1}^{N} m_i\\right)$ 来移除系统的净质心 (COM) 运动。在移除质心运动后，该实践者使用定义 $T_{\\mathrm{naive}} = \\frac{2K'}{3N k_B}$ 计算“朴素”温度 $T_{\\mathrm{naive}}$，其中 $K' = \\sum_{i=1}^{N} \\frac{1}{2} m_i |\\mathbf{v}_i - \\mathbf{V}_{\\mathrm{CM}}|^2$ 是新的动能。\n\n从 Maxwell–Boltzmann 统计和能量均分定理出发，量化这种朴素的质心移除方法对温度的期望影响，然后推导一个单一的乘法重标度因子 $s$。当该因子被统一应用于移除质心运动后的速度 $\\{\\mathbf{v}_i - \\mathbf{V}_{\\mathrm{CM}}\\}$ 时，能够在同样的朴素 $f = 3N$ 温度计算方法下将温度恢复到目标温度 $T_0$。以封闭形式的解析表达式给出 $s$ 的最终答案。无需进行数值计算。",
            "solution": "该问题要求分析分子动力学中一种特定但朴素的速度初始化流程，并求出实现所需目标温度的修正因子。求解过程将首先验证问题陈述的有效性，然后运用统计力学原理推导所需的物理量。\n\n### 问题验证\n\n**第一步：提取已知条件**\n- 粒子数：$N$\n- 粒子质量：$\\{m_i\\}_{i=1}^{N}$\n- 空间维度：$3$\n- 初始速度采样：每个笛卡尔速度分量独立地从目标温度为 $T_0$ 的 Maxwell-Boltzmann 分布中抽取。\n- 玻尔兹曼常数：$k_B$\n- 动能定义：$K = \\sum_{i=1}^{N} \\frac{1}{2} m_i |\\mathbf{v}_i|^2$\n- 质心 (COM) 速度：$\\mathbf{V}_{\\mathrm{CM}} = \\left(\\sum_{i=1}^{N} m_i \\mathbf{v}_i\\right)/\\left(\\sum_{i=1}^{N} m_i\\right)$\n- 实践者的初始化流程：\n    1. 从温度为 $T_0$ 的 Maxwell-Boltzmann 分布中采样速度 $\\{\\mathbf{v}_i^{(0)}\\}$。\n    2. 对这些速度进行重标度，得到 $\\{\\mathbf{v}_i^{(1)}\\}$，使得总动能 $K^{(1)}$ 精确等于 $f=3N$ 个自由度的能量均分预测值，即 $K^{(1)} = \\frac{3N}{2} k_B T_0$。\n    3. 通过定义新速度 $\\{\\mathbf{v}_i^{(2)}\\} = \\{\\mathbf{v}_i^{(1)} - \\mathbf{V}_{\\mathrm{CM}}^{(1)}\\}$ 来移除质心运动。\n- 朴素的温度计算：温度通过 $T_{\\mathrm{naive}} = \\frac{2K'}{3N k_B}$ 计算，其中 $K' = \\sum_{i=1}^{N} \\frac{1}{2} m_i |\\mathbf{v}_i^{(2)}|^2$ 是移除质心运动后的动能。\n- 目标：\n    1. 量化移除质心运动对温度的期望影响。\n    2. 推导一个乘法重标度因子 $s$，当其应用于移除质心运动后的速度 $\\{\\mathbf{v}_i^{(2)}\\}$ 时，在同样的朴素 $f=3N$ 计算方法下，能将期望温度恢复到 $T_0$。\n\n**第二步：使用提取的已知条件进行验证**\n- **科学依据**：该问题在经典统计力学及其在分子动力学模拟中的应用方面有坚实的理论基础。它涉及了 Maxwell-Boltzmann 分布、能量均分定理、动能和自由度等标准概念。\n- **问题适定性**：该问题定义清晰，提供了所有必要的变量、常数和程序步骤。目标明确，可以导出一个唯一的解析解。\n- **目标**：问题以精确、定量且无偏见的方式陈述。\n\n**第三步：结论与行动**\n问题有效。将提供详细的解答。\n\n### 解题推导\n\n问题的核心在于理解动能如何在系统的自由度之间分配。一个在 $3$ 维空间中的 $N$ 粒子系统共有 $3N$ 个平动自由度。这些自由度可以分解为对应于质心 (COM) 平移运动的 $3$ 个自由度和对应于粒子相对于质心运动的 $3N-3$ 个自由度。\n\n设初始 Maxwell-Boltzmann 采样后的速度为 $\\{\\mathbf{v}_i^{(0)}\\}$。实践者的第一步是重标度这些速度，以获得一个新的速度集合 $\\{\\mathbf{v}_i^{(1)}\\}$，使得总动能 $K^{(1)}$ 不再是一个统计变量，而是一个固定量：\n$$K^{(1)} = \\sum_{i=1}^{N} \\frac{1}{2} m_i |\\mathbf{v}_i^{(1)}|^2 = \\frac{3N}{2} k_B T_0$$\n这一步对系统的动能施加了一个类似微正则系综的约束。\n\n根据 Koenig 定理，总动能可以分解为：\n$$K^{(1)} = K' + K_{\\mathrm{CM}}^{(1)}$$\n其中 $K' = \\sum_{i=1}^{N} \\frac{1}{2} m_i |\\mathbf{v}_i^{(1)} - \\mathbf{V}_{\\mathrm{CM}}^{(1)}|^2$ 是相对于质心的动能（用于计算 $T_{\\mathrm{naive}}$ 的量），而 $K_{\\mathrm{CM}}^{(1)} = \\frac{1}{2} M |\\mathbf{V}_{\\mathrm{CM}}^{(1)}|^2$ 是质心的动能，其中 $M = \\sum_{i=1}^{N} m_i$ 是总质量。\n\n从 Maxwell-Boltzmann 分布的初始采样确保了能量在平均意义上被均等地分配到所有二次型自由度上（能量均分）。第二步中的统一重标度不改变这种相对分布。因此，固定的总动能 $K^{(1)}$ 在平均意义上被均等地分配到 $3N$ 个可用自由度上。\n\n每个自由度的期望能量为：\n$$\\langle E_{\\mathrm{dof}} \\rangle = \\frac{K^{(1)}}{3N} = \\frac{1}{3N} \\left(\\frac{3N}{2} k_B T_0\\right) = \\frac{1}{2} k_B T_0$$\n\n质心运动占有 $3$ 个自由度。与质心相关的期望动能为：\n$$\\langle K_{\\mathrm{CM}}^{(1)} \\rangle = 3 \\times \\langle E_{\\mathrm{dof}} \\rangle = \\frac{3}{2} k_B T_0$$\n\n剩余的动能 $K'$ 与相对于质心的内部运动相关，该运动具有 $3N-3$ 个自由度。其期望值为：\n$$\\langle K' \\rangle = (3N-3) \\times \\langle E_{\\mathrm{dof}} \\rangle = \\frac{3(N-1)}{2} k_B T_0$$\n我们可以验证这一点：$\\langle K^{(1)} \\rangle = \\langle K' \\rangle + \\langle K_{\\mathrm{CM}}^{(1)} \\rangle = \\frac{3(N-1)}{2} k_B T_0 + \\frac{3}{2} k_B T_0 = \\frac{3N}{2} k_B T_0$，这与固定的总能量是一致的。\n\n现在，我们来量化朴素的质心移除对温度的影响。实践者使用 $K'$ 计算“朴素”温度，但错误地假设了有 $3N$ 个自由度：\n$$T_{\\mathrm{naive}} = \\frac{2K'}{3N k_B}$$\n这个朴素温度的期望值为：\n$$\\langle T_{\\mathrm{naive}} \\rangle = \\frac{2 \\langle K' \\rangle}{3N k_B} = \\frac{2}{3N k_B} \\left(\\frac{3(N-1)}{2} k_B T_0\\right) = \\frac{N-1}{N} T_0$$\n这表明该流程系统性地导致温度低于目标温度 $T_0$，期望温度被一个因子 $(N-1)/N$ 减小了。\n\n问题的最后一部分是找到一个单一的乘法因子 $s$ 来修正这个问题。移除质心运动后的速度 $\\{\\mathbf{v}_i^{(2)}\\}$ (其中 $\\mathbf{v}_i^{(2)} = \\mathbf{v}_i^{(1)} - \\mathbf{V}_{\\mathrm{CM}}^{(1)}$) 需要被重标度为 $\\{\\mathbf{v}_i^{(3)}\\} = \\{s \\mathbf{v}_i^{(2)}\\}$。新的总动能将是 $K''$：\n$$K'' = \\sum_{i=1}^{N} \\frac{1}{2} m_i |s \\mathbf{v}_i^{(2)}|^2 = s^2 \\sum_{i=1}^{N} \\frac{1}{2} m_i |\\mathbf{v}_i^{(2)}|^2 = s^2 K'$$\n然后，实践者将使用相同的朴素公式计算最终温度 $T_{final}$：\n$$T_{final} = \\frac{2 K''}{3N k_B} = \\frac{2 s^2 K'}{3N k_B}$$\n我们要求这个最终温度的*期望*值等于目标温度 $T_0$：\n$$\\langle T_{final} \\rangle = T_0$$\n代入 $T_{final}$ 和 $\\langle K' \\rangle$ 的表达式：\n$$\\left\\langle \\frac{2 s^2 K'}{3N k_B} \\right\\rangle = s^2 \\frac{2 \\langle K' \\rangle}{3N k_B} = T_0$$\n$$s^2 \\frac{2}{3N k_B} \\left(\\frac{3(N-1)}{2} k_B T_0\\right) = T_0$$\n简化表达式：\n$$s^2 \\left(\\frac{N-1}{N}\\right) T_0 = T_0$$\n假设 $T_0 \\neq 0$，我们可以除以 $T_0$：\n$$s^2 = \\frac{N}{N-1}$$\n由于标度因子 $s$ 必须为正，我们取正平方根：\n$$s = \\sqrt{\\frac{N}{N-1}}$$\n这就是所求的重标度因子的封闭形式解析表达式。",
            "answer": "$$\\boxed{\\sqrt{\\frac{N}{N-1}}}$$"
        },
        {
            "introduction": "在处理包含多种不同质量粒子的混合体系时，初始化策略需要更加谨慎。虽然移除质心运动会降低系统的总动能，但这种能量的减少并不会在不同类型的粒子间均匀分配。这项练习  引导您从理论上分析，在移除质心平动后，动能的损失是如何根据各组分的质量分数进行分配的。理解这种与质量相关的效应，对于精确设置多组分体系（如溶液或界面）的初始状态，避免初始阶段的瞬态不平衡至关重要。",
            "id": "3405738",
            "problem": "考虑一个由两种组分（标记为组分 $A$ 和组分 $B$）组成的三维分子动力学系统。组分 $A$ 由 $N_A$ 个质量为 $m_A$ 的相同粒子组成，组分 $B$ 由 $N_B$ 个质量为 $m_B$ 的相同粒子组成。定义组分质量 $M_A = N_A m_A$ 和 $M_B = N_B m_B$，以及总质量 $M = M_A + M_B$。坐标在力学平衡位置进行初始化（因此在时间 $t = 0$ 时的瞬时势能为零），并且动力学过程是围绕此平衡位置的谐振，允许存在一组完备的质量加权简正模。\n\n您将比较在温度 $T$ 下的两种速度初始化策略：\n\n- 策略 $\\mathrm{S1}$ （麦克斯韦-玻尔兹曼（MB）笛卡尔坐标抽样）：对每个粒子，从高斯分布中独立抽取其每个笛卡尔速度分量，使得粒子速度的分布符合温度 $T$ 下的平衡态麦克斯韦-玻尔兹曼速度分布。不施加额外的约束。\n\n- 策略 $\\mathrm{S2}$ （质量加权简正模（NM）初始化）：在通过对质量加权坐标下的谐振Hessian矩阵进行对角化而获得的质量加权简正模基中，从高斯分布中独立抽取所有非平移简正模的动量，使得每个模的平均动能等于 $\\frac{1}{2} k_B T$，其中 $k_B$ 是玻尔兹曼常数。三个平移模被恒定地设置为零。然后将这些模动量反变换回笛卡尔速度。\n\n定义在时间 $t = 0$ 时每个组分的动能为\n$$\nK_i = \\sum_{a \\in \\text{species } i} \\frac{1}{2} m_i \\left\\|\\mathbf v_a\\right\\|^2,\n$$\n对于 $i \\in \\{A,B\\}$，以及每个组分的瞬时均分违背量为\n$$\n\\Delta_i = \\left\\langle K_i \\right\\rangle - \\frac{f_i}{2} k_B T,\n$$\n其中 $f_i = 3 N_i$ 是与组分 $i$ 相关联的笛卡尔二次自由度数，$\\langle \\cdot \\rangle$ 表示对速度初始化方案的系综平均。\n\n以下哪个陈述正确地给出了在策略 $\\mathrm{S1}$ 和 $\\mathrm{S2}$ 下的 $\\Delta_A$ 和 $\\Delta_B$？\n\nA. 在 $\\mathrm{S1}$ 下，$\\Delta_A = 0$ 且 $\\Delta_B = 0$。在 $\\mathrm{S2}$ 下，$\\Delta_i = - \\frac{3}{2} \\frac{M_i}{M} k_B T$ 对于 $i \\in \\{A,B\\}$。\n\nB. 在 $\\mathrm{S1}$ 下，$\\Delta_i = - \\frac{3}{2} \\frac{M_i}{M} k_B T$ 对于 $i \\in \\{A,B\\}$。在 $\\mathrm{S2}$ 下，$\\Delta_A = 0$ 且 $\\Delta_B = 0$。\n\nC. 在 $\\mathrm{S1}$ 下，$\\Delta_A = 0$ 且 $\\Delta_B = 0$。在 $\\mathrm{S2}$ 下，$\\Delta_i = - \\frac{3}{2} \\frac{N_i}{N} k_B T$ 对于 $i \\in \\{A,B\\}$，其中 $N = N_A + N_B$。\n\nD. 在 $\\mathrm{S1}$ 下，$\\Delta_i = - \\frac{3}{2} \\frac{N_i}{N} k_B T$ 对于 $i \\in \\{A,B\\}$。在 $\\mathrm{S2}$ 下，$\\Delta_i = - \\frac{3}{2} \\frac{M_i}{M} k_B T$ 对于 $i \\in \\{A,B\\}$。",
            "solution": "必须首先验证问题陈述的正确性、完整性和科学依据。\n\n### 步骤1：提取已知条件\n- **系统**：一个三维分子动力学系统。\n- **组分**：\n    - 组分 $A$：$N_A$ 个质量为 $m_A$ 的粒子。\n    - 组分 $B$：$N_B$ 个质量为 $m_B$ 的粒子。\n- **质量定义**：\n    - 组分质量：$M_A = N_A m_A$，$M_B = N_B m_B$。\n    - 总质量：$M = M_A + M_B$。\n- **初始状态**：\n    - 坐标处于力学平衡位置，其中势能 $U(t=0) = 0$。\n    - 动力学过程是谐振的。\n- **温度**：$T$。\n- **策略 S1 (麦克斯韦-玻尔兹曼笛卡尔坐标抽样)**：\n    - 每个粒子的每个笛卡尔速度分量均从高斯分布中独立抽取。\n    - 产生的粒子速度分布符合温度 $T$ 下的平衡态麦克斯韦-玻尔兹曼分布。\n    - 不施加额外约束。\n- **策略 S2 (质量加权简正模初始化)**：\n    - 在质量加权简正模基中，从高斯分布中独立抽取 $3(N_A+N_B)-3$ 个非平移简正模的动量。\n    - 每个非平移模的平均动能为 $\\frac{1}{2} k_B T$。\n    - 3个平移模的动量被设置为零。\n    - 通过从简正模动量进行反变换获得笛卡尔速度。\n- **待计算量**：\n    - $t=0$ 时每个组分的动能：$K_i = \\sum_{a \\in \\text{species } i} \\frac{1}{2} m_i \\left\\|\\mathbf v_a\\right\\|^2$，对于 $i \\in \\{A,B\\}$。\n    - 每个组分的瞬时均分违背量：$\\Delta_i = \\left\\langle K_i \\right\\rangle - \\frac{f_i}{2} k_B T$，其中 $f_i = 3 N_i$ 是组分 $i$ 的笛卡尔自由度数，$\\langle \\cdot \\rangle$ 表示系综平均。\n\n### 步骤2：使用提取的已知条件进行验证\n1.  **科学依据**：该问题坚实地基于经典统计力学和分子动力学模拟的原理。麦克斯韦-玻尔兹曼统计、能量均分定理、简正模分析和质心运动都是标准概念。\n2.  **适定性**：问题是适定的。两种初始化策略的描述足够清晰。要计算的量 $\\Delta_i$ 定义明确。可以从给定信息中推导出唯一解。\n3.  **客观性**：语言是客观和正式的，没有主观陈述。\n4.  **不完整或矛盾的设置**：问题是自洽的，提供了所有必要的定义和条件。没有矛盾之处。谐振近似是这种背景下的标准简化假设。\n5.  **不现实或不可行**：所描述的初始化策略是计算物理和化学中的标准（或概念上标准）程序。这些条件在物理上是合理的。\n6.  **不适定或结构不良**：问题结构清晰，要求进行特定的计算。\n7.  **伪深刻、琐碎或同义反复**：该问题需要对统计力学原理进行非平凡的应用，特别是在理解约束质心运动的后果方面。\n8.  **超出科学可验证性**：这些论断可以通过标准的数学物理方法推导和验证。\n\n### 步骤3：结论与行动\n问题陈述是**有效的**。现在推导解答。\n\n### 推导\n\n**策略 S1 (MB 笛卡尔坐标抽样) 的分析**\n\n在策略S1下，速度分量 $v_{a,\\alpha}$（对于粒子 $a$ 和笛卡尔分量 $\\alpha \\in \\{x,y,z\\}$）是从均值为 $0$、方差为 $\\sigma_a^2 = k_B T / m_a$ 的高斯分布中独立抽取的，其中 $m_a$ 是粒子 $a$ 的质量。这确保了速度分布是麦克斯韦分布的。\n\n与粒子 $a$ 的每个笛卡尔自由度相关联的平均动能是：\n$$\n\\left\\langle \\frac{1}{2} m_a v_{a,\\alpha}^2 \\right\\rangle = \\frac{1}{2} m_a \\langle v_{a,\\alpha}^2 \\rangle = \\frac{1}{2} m_a \\sigma_a^2 = \\frac{1}{2} m_a \\left(\\frac{k_B T}{m_a}\\right) = \\frac{1}{2} k_B T\n$$\n单个粒子 $a$ 的平均动能是其三个笛卡尔自由度上的总和：\n$$\n\\left\\langle \\frac{1}{2} m_a \\|\\mathbf{v}_a\\|^2 \\right\\rangle = \\sum_{\\alpha \\in \\{x,y,z\\}} \\left\\langle \\frac{1}{2} m_a v_{a,\\alpha}^2 \\right\\rangle = 3 \\times \\frac{1}{2} k_B T = \\frac{3}{2} k_B T\n$$\n组分 $i \\in \\{A, B\\}$ 的平均动能 $K_i$ 是其 $N_i$ 个组成粒子的平均动能之和。\n$$\n\\langle K_i \\rangle = \\left\\langle \\sum_{a \\in \\text{species } i} \\frac{1}{2} m_i \\|\\mathbf{v}_a\\|^2 \\right\\rangle = \\sum_{a \\in \\text{species } i} \\left\\langle \\frac{1}{2} m_i \\|\\mathbf{v}_a\\|^2 \\right\\rangle = N_i \\left( \\frac{3}{2} k_B T \\right) = \\frac{3N_i}{2} k_B T\n$$\n瞬时均分违背量 $\\Delta_i$ 定义为 $\\Delta_i = \\langle K_i \\rangle - \\frac{f_i}{2} k_B T$。由于 $f_i = 3N_i$，参考能量为 $\\frac{3N_i}{2} k_B T$。\n$$\n\\Delta_i = \\frac{3N_i}{2} k_B T - \\frac{3N_i}{2} k_B T = 0\n$$\n因此，对于策略 S1，$\\Delta_A = 0$ 且 $\\Delta_B = 0$。\n\n**策略 S2 (NM 初始化) 的分析**\n\n策略 S2 将三个平移简正模设置为零。这等价于将系统的总动量设置为零，即质心（COM）速度为零。\n$$\n\\mathbf{P}_{total} = \\sum_a m_a \\mathbf{v}_a = \\mathbf{0} \\implies \\mathbf{V}_{COM} = \\frac{\\mathbf{P}_{total}}{M} = \\mathbf{0}\n$$\n实现这一点的一个标准程序是：首先根据策略S1生成速度 $\\mathbf{v}'_a$，计算产生的质心速度 $\\mathbf{V}'_{COM} = \\frac{1}{M} \\sum_a m_a \\mathbf{v}'_a$，然后将新速度定义为 $\\mathbf{v}_a = \\mathbf{v}'_a - \\mathbf{V}'_{COM}$。这个投影消除了质心运动。\n\n在此方案下，组分 $i$ 的平均动能为：\n$$\n\\langle K_i \\rangle = \\left\\langle \\sum_{a \\in \\text{species } i} \\frac{1}{2} m_i \\|\\mathbf{v}_a\\|^2 \\right\\rangle = \\sum_{a \\in \\text{species } i} \\frac{1}{2} m_i \\left\\langle \\|\\mathbf{v}'_a - \\mathbf{V}'_{COM}\\|^2 \\right\\rangle\n$$\n展开平方范数：\n$$\n\\left\\langle \\|\\mathbf{v}'_a - \\mathbf{V}'_{COM}\\|^2 \\right\\rangle = \\left\\langle \\|\\mathbf{v}'_a\\|^2 \\right\\rangle - 2\\left\\langle \\mathbf{v}'_a \\cdot \\mathbf{V}'_{COM} \\right\\rangle + \\left\\langle \\|\\mathbf{V}'_{COM}\\|^2 \\right\\rangle\n$$\n我们计算每一项。速度 $\\mathbf{v}'_a$ 来自 S1 类型的初始化。\n1.  从S1的分析可知，对于任何粒子 $a$（质量为 $m_a$），我们有 $\\left\\langle \\frac{1}{2} m_a \\|\\mathbf{v}'_a\\|^2 \\right\\rangle = \\frac{3}{2} k_B T$，这意味着 $\\left\\langle \\|\\mathbf{v}'_a\\|^2 \\right\\rangle = \\frac{3k_B T}{m_a}$。\n\n2.  接下来，我们计算 $\\left\\langle \\mathbf{v}'_a \\cdot \\mathbf{V}'_{COM} \\right\\rangle$：\n    $$\n    \\left\\langle \\mathbf{v}'_a \\cdot \\mathbf{V}'_{COM} \\right\\rangle = \\left\\langle \\mathbf{v}'_a \\cdot \\left(\\frac{1}{M} \\sum_b m_b \\mathbf{v}'_b \\right) \\right\\rangle = \\frac{1}{M} \\sum_b m_b \\left\\langle \\mathbf{v}'_a \\cdot \\mathbf{v}'_b \\right\\rangle\n    $$\n    由于不同粒子的速度是独立抽取的，$\\left\\langle \\mathbf{v}'_a \\cdot \\mathbf{v}'_b \\right\\rangle = \\delta_{ab} \\left\\langle \\|\\mathbf{v}'_a\\|^2 \\right\\rangle$。\n    $$\n    \\left\\langle \\mathbf{v}'_a \\cdot \\mathbf{V}'_{COM} \\right\\rangle = \\frac{1}{M} m_a \\left\\langle \\|\\mathbf{v}'_a\\|^2 \\right\\rangle = \\frac{m_a}{M} \\left( \\frac{3k_B T}{m_a} \\right) = \\frac{3k_B T}{M}\n    $$\n\n3.  最后，我们计算 $\\left\\langle \\|\\mathbf{V}'_{COM}\\|^2 \\right\\rangle$：\n    $$\n    \\left\\langle \\|\\mathbf{V}'_{COM}\\|^2 \\right\\rangle = \\left\\langle \\left(\\frac{1}{M} \\sum_a m_a \\mathbf{v}'_a\\right) \\cdot \\left(\\frac{1}{M} \\sum_b m_b \\mathbf{v}'_b\\right) \\right\\rangle = \\frac{1}{M^2} \\sum_{a,b} m_a m_b \\left\\langle \\mathbf{v}'_a \\cdot \\mathbf{v}'_b \\right\\rangle\n    $$\n    再次利用独立性，$\\left\\langle \\mathbf{v}'_a \\cdot \\mathbf{v}'_b \\right\\rangle = \\delta_{ab} \\left\\langle \\|\\mathbf{v}'_a\\|^2 \\right\\rangle = \\delta_{ab} \\frac{3k_B T}{m_a}$。\n    $$\n    \\left\\langle \\|\\mathbf{V}'_{COM}\\|^2 \\right\\rangle = \\frac{1}{M^2} \\sum_a m_a^2 \\left( \\frac{3k_B T}{m_a} \\right) = \\frac{3k_B T}{M^2} \\sum_a m_a = \\frac{3k_B T}{M^2} M = \\frac{3k_B T}{M}\n    $$\n\n结合这些项，得到组分 $i$ 中单个粒子 $a$ 的平均动能：\n$$\n\\frac{1}{2}m_i \\left\\langle \\|\\mathbf{v}_a\\|^2 \\right\\rangle = \\frac{1}{2}m_i \\left( \\frac{3k_B T}{m_i} - 2\\frac{3k_B T}{M} + \\frac{3k_B T}{M} \\right) = \\frac{1}{2}m_i \\left( \\frac{3k_B T}{m_i} - \\frac{3k_B T}{M} \\right) = \\frac{3}{2}k_B T - \\frac{3}{2}\\frac{m_i}{M}k_B T\n$$\n现在，我们通过对组分 $i$ 的 $N_i$ 个粒子求和来找到其平均总动能：\n$$\n\\langle K_i \\rangle = \\sum_{a \\in \\text{species } i} \\left( \\frac{3}{2}k_B T - \\frac{3}{2}\\frac{m_i}{M}k_B T \\right) = N_i \\left( \\frac{3}{2}k_B T - \\frac{3}{2}\\frac{m_i}{M}k_B T \\right)\n$$\n$$\n\\langle K_i \\rangle = \\frac{3N_i}{2}k_B T - \\frac{3N_i m_i}{2M}k_B T\n$$\n使用定义 $M_i = N_i m_i$：\n$$\n\\langle K_i \\rangle = \\frac{3N_i}{2}k_B T - \\frac{3M_i}{2M}k_B T\n$$\n最后，我们计算策略 S2 的均分违背量 $\\Delta_i$：\n$$\n\\Delta_i = \\langle K_i \\rangle - \\frac{f_i}{2}k_B T = \\left( \\frac{3N_i}{2}k_B T - \\frac{3M_i}{2M}k_B T \\right) - \\frac{3N_i}{2}k_B T\n$$\n$$\n\\Delta_i = - \\frac{3M_i}{2M}k_B T\n$$\n此结果适用于两种组分 $i \\in \\{A, B\\}$。\n\n### 结果总结\n- **策略 S1**：$\\Delta_A = 0$ 且 $\\Delta_B = 0$。\n- **策略 S2**：$\\Delta_i = - \\frac{3}{2} \\frac{M_i}{M} k_B T$，对于 $i \\in \\{A,B\\}$。\n\n### 逐项分析\n\n- **A. 在 $\\mathrm{S1}$ 下，$\\Delta_A = 0$ 且 $\\Delta_B = 0$。在 $\\mathrm{S2}$ 下，$\\Delta_i = - \\frac{3}{2} \\frac{M_i}{M} k_B T$ 对于 $i \\in \\{A,B\\}$。**\n  - 此陈述与我们对策略 S1 和策略 S2 推导出的结果相符。\n  - **结论：正确。**\n\n- **B. 在 $\\mathrm{S1}$ 下，$\\Delta_i = - \\frac{3}{2} \\frac{M_i}{M} k_B T$ 对于 $i \\in \\{A,B\\}$。在 $\\mathrm{S2}$ 下，$\\Delta_A = 0$ 且 $\\Delta_B = 0$。**\n  - 此陈述错误地交换了 S1 和 S2 的结果。在 S1 中，没有约束，因此没有违背。在 S2 中，对质心运动的约束引入了违背。\n  - **结论：错误。**\n\n- **C. 在 $\\mathrm{S1}$ 下，$\\Delta_A = 0$ 且 $\\Delta_B = 0$。在 $\\mathrm{S2}$ 下，$\\Delta_i = - \\frac{3}{2} \\frac{N_i}{N} k_B T$ 对于 $i \\in \\{A,B\\}$，其中 $N = N_A + N_B$。**\n  - S1 部分正确。S2 部分错误。动能亏损与组分质量分数 $M_i/M$ 成正比，而不是数量分数 $N_i/N$，因为质心是一个质量加权的量。\n  - **结论：错误。**\n\n- **D. 在 $\\mathrm{S1}$ 下，$\\Delta_i = - \\frac{3}{2} \\frac{N_i}{N} k_B T$ 对于 $i \\in \\{A,B\\}$。在 $\\mathrm{S2}$ 下，$\\Delta_i = - \\frac{3}{2} \\frac{M_i}{M} k_B T$ 对于 $i \\in \\{A,B\\}$。**\n  - S1 部分是错误的。S2 部分是正确的。由于 S1 部分是错误的，整个陈述是错误的。\n  - **结论：错误。**\n\n只有选项A是完全正确的。",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "理论的正确性最终需要在稳健的计算实现中得到体现，尤其是在现代高性能并行计算环境中。这项综合性练习  将理论与实践相结合，要求您设计并编码一个“并行安全”的速度初始化方案。您需要解决在分布式内存模型（如 MPI）中确保随机数流独立性与可复现性的实际问题，并实现一个正确的全局质心速度移除步骤。这个练习不仅巩固了您对麦克斯韦-玻尔兹曼分布和动量守恒的物理理解，更为您在真实的、大规模模拟中编写可靠代码打下了坚实的基础。",
            "id": "3405774",
            "problem": "要求您构建并分析一种适用于分子动力学的并行安全速度初始化策略，该策略可推广到消息传递接口 (MPI) 环境。该任务必须根据与牛顿力学、能量均分定理和麦克斯韦-玻尔兹曼分布一致的第一性原理来解决，并且必须通过单个、完整、可运行的程序进行数值验证。核心要求是：(i) 设计一种确定性的、基于进程号索引的随机数种子设定方法，该方法能为分配给不同进程号的非重叠粒子子集生成统计上独立的速度样本；(ii) 证明在执行质心速度移除后，能够满足精确的全局线性动量约束。该程序必须通过将粒子划分为由进程号标签索引的不相交子集，在单个进程中模拟多个 MPI 进程号；它不能实际使用 MPI，但必须模拟在消息传递接口 (MPI) 进程号之间会发生的独立性和数据收集步骤。\n\n使用的基本原理：速度的定义 $v = dx/dt$、用于解释线性动量的牛顿第二定律 $F = m a$、能量均分定理（即在温度 $T$ 下，每个二次自由度对平均能量的贡献为 $\\frac{1}{2} k_{\\mathrm{B}} T$），以及质量为 $m$ 的经典粒子的麦克斯韦-玻尔兹曼速度分布。不得假定任何简便公式；您必须仅从这些基本原理出发，在您的解决方案中推导出任何采样方差和质心移除变换。\n\n设计约束和目标：\n- 定义一个种子设定方案，该方案接收一个基础整数种子 $S$ 和一个进程号索引 $r \\in \\{0,1,\\dots,R-1\\}$，并为每个进程号生成一个独立的伪随机数流，其方式应是并行安全且可复现的。此处的独立性意味着在给定固定的 $S$ 和不相交的进程号标签的情况下，不同进程号之间没有共享的内部状态，且生成的子序列没有重叠。\n- 根据能量均分定理，从麦克斯韦-玻尔兹曼分布中为质量为 $m_i$、温度为 $T$ 的粒子 $i$ 采样初始速度。您必须严格依据上述指定的基本原理进行推理，以确定各分量上的分布及其方差。\n- 采样后，执行一次全局质心 (COM) 速度移除步骤，以强制施加总线性动量为零的物理约束。在您的解决方案中，您必须推导为什么从每个粒子的速度中减去适当的恒定向量可以实现总动量为零。\n- 单位：质量必须以千克 ($\\mathrm{kg}$) 为单位，温度以开尔文 ($\\mathrm{K}$) 为单位，速度以米/秒 ($\\mathrm{m/s}$) 为单位，动量以千克·米/秒 ($\\mathrm{kg\\cdot m/s}$) 为单位。玻尔兹曼常数 $k_{\\mathrm{B}}$ 必须使用焦耳/开尔文，其中 $1\\,\\mathrm{J} = 1\\,\\mathrm{kg\\cdot m^2/s^2}$。\n- 您的程序必须验证进程号本地速度流的独立性以及质心移除后动量约束的满足情况。独立性验证必须是确定性的：对于每个进程号，计算原始的、未进行质心移除的速度的摘要，并确认对于所有非空的进程号分配，所有进程号摘要都是不同的。动量验证必须计算质心移除后的全局总动量，并检查其分量是否在指定的绝对容差 $\\epsilon$ 范围内。\n\n测试套件和参数：\n使用以下物理上一致的常数和源自原子质量单位的质量。设原子质量单位为 $u = 1.66053906660 \\times 10^{-27}\\,\\mathrm{kg}$，玻尔兹曼常数为 $k_{\\mathrm{B}} = 1.380649 \\times 10^{-23}\\,\\mathrm{J/K}$。定义物种质量\n- 氩 (Argon): $m_{\\mathrm{Ar}} = 39.948\\,u$,\n- 氢 (Hydrogen): $m_{\\mathrm{H}} = 1.00784\\,u$,\n- 氙 (Xenon): $m_{\\mathrm{Xe}} = 131.293\\,u$.\n\n实现三个测试用例：\n1. 正常路径：$N = 1000$ 个粒子，$R = 4$ 个进程号，所有粒子质量均一 $m_i = m_{\\mathrm{Ar}}$，温度 $T = 300\\,\\mathrm{K}$，基础种子 $S = 123456789$，容差 $\\epsilon = 1\\times 10^{-25}\\,\\mathrm{kg\\cdot m/s}$。\n2. 边界情况：$N = 1$ 个粒子，$R = 1$ 个进程号，质量 $m_1 = m_{\\mathrm{Ar}}$，温度 $T = 500\\,\\mathrm{K}$，基础种子 $S = 987654321$，容差 $\\epsilon = 1\\times 10^{-25}\\,\\mathrm{kg\\cdot m/s}$。\n3. 异构质量：$N = 100$ 个粒子，$R = 3$ 个进程号，温度 $T = 1000\\,\\mathrm{K}$，基础种子 $S = 192837465$，容差 $\\epsilon = 1\\times 10^{-25}\\,\\mathrm{kg\\cdot m/s}$。质量分配：$m_i = m_{\\mathrm{H}}$ 对于 $i \\in \\{1,2,\\dots,50\\}$，$m_i = m_{\\mathrm{Xe}}$ 对于 $i \\in \\{51,52,\\dots,100\\}$。\n\n程序要求：\n- 将 $N$ 个粒子划分为 $R$ 个连续子集（尽可能大小均匀）以表示进程号本地的所有权；对于每个进程号 $r$，从其独立的伪随机数流中采样其本地速度。\n- 对所有进程号拼接起来的速度场执行一次全局质心移除步骤。\n- 针对每个测试用例，验证并返回：(a) 一个布尔值，指示每个进程号的原始速度摘要是否都不同；(b) 一个布尔值，指示质心移除后的总动量是否满足容差 $\\epsilon$；(c) 质心移除后总动量向量的最大绝对值分量，以 $\\mathrm{kg\\cdot m/s}$ 为单位的浮点数。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，每个测试用例对应一个形式为 $[b_1,b_2,x]$ 的嵌套列表，其中 $b_1$ 和 $b_2$ 是布尔值，$x$ 是一个以 $\\mathrm{kg\\cdot m/s}$ 为单位的浮点数。具体而言，输出必须是 $[[b_{1}^{(1)},b_{2}^{(1)},x^{(1)}],[b_{1}^{(2)},b_{2}^{(2)},x^{(2)}],[b_{1}^{(3)},b_{2}^{(3)},x^{(3)}]]$ 的形式，打印在单行上，无任何附加文本。",
            "solution": "该问题要求为分子动力学模拟设计并实现一种并行安全的速度初始化策略。该解决方案必须从第一性原理推导得出，特别是能量均分定理和线性动量的定义，并且必须在一个模拟多进程号 MPI 环境的单进程程序中得到验证。\n\n解决方案分为三部分：\n1.  从能量均分定理推导单粒子速度采样分布。\n2.  设计一个确定性且并行安全的随机数生成方案。\n3.  推导用于强制实现总线性动量为零的质心 (COM) 速度移除变换。\n\n**1. 速度采样分布的推导**\n\n能量均分定理是经典统计力学的基石之一。它指出，对于一个处于温度 $T$ 的热平衡系统，哈密顿量中的每个二次自由度对平均能量的贡献为 $\\frac{1}{2} k_{\\mathrm{B}} T$，其中 $k_{\\mathrm{B}}$ 是玻尔兹曼常数。\n\n对于一个质量为 $m_i$、速度向量为 $\\vec{v}_i = (v_{ix}, v_{iy}, v_{iz})$ 的三维空间中的单个粒子，其动能由下式给出：\n$$ E_{k,i} = \\frac{1}{2} m_i v_i^2 = \\frac{1}{2} m_i (v_{ix}^2 + v_{iy}^2 + v_{iz}^2) $$\n该表达式可以分解为三个独立的项，每个空间维度一项：\n$$ E_{k,i} = \\frac{1}{2} m_i v_{ix}^2 + \\frac{1}{2} m_i v_{iy}^2 + \\frac{1}{2} m_i v_{iz}^2 $$\n这些项（$ \\frac{1}{2} m_i v_{i\\alpha}^2 $，其中 $\\alpha \\in \\{x, y, z\\}$）中的每一项都是一个二次自由度。应用能量均分定理，每个分量的平均能量为：\n$$ \\left\\langle \\frac{1}{2} m_i v_{i\\alpha}^2 \\right\\rangle = \\frac{1}{2} k_{\\mathrm{B}} T $$\n其中 $\\langle \\cdot \\rangle$ 表示系综平均值。这可以简化为：\n$$ m_i \\langle v_{i\\alpha}^2 \\rangle = k_{\\mathrm{B}} T \\implies \\langle v_{i\\alpha}^2 \\rangle = \\frac{k_{\\mathrm{B}} T}{m_i} $$\n热化系统中粒子的速度由麦克斯韦-玻尔兹曼分布描述。对于单个速度分量（例如 $v_{ix}$），该分布呈高斯（正态）分布形式 $f(v_{ix})$，均值为零，即 $\\langle v_{ix} \\rangle = 0$，因为没有优选的运动方向。该分布的方差 $\\sigma_{i\\alpha}^2$ 由下式给出：\n$$ \\sigma_{i\\alpha}^2 = \\langle (v_{i\\alpha} - \\langle v_{i\\alpha} \\rangle)^2 \\rangle = \\langle v_{i\\alpha}^2 \\rangle - \\langle v_{i\\alpha} \\rangle^2 $$\n由于 $\\langle v_{i\\alpha} \\rangle = 0$，方差即为 $\\sigma_{i\\alpha}^2 = \\langle v_{i\\alpha}^2 \\rangle$。根据我们从能量均分定理得到的结果，有：\n$$ \\sigma_{i\\alpha}^2 = \\frac{k_{\\mathrm{B}} T}{m_i} $$\n这对每个分量 $\\alpha \\in \\{x, y, z\\}$ 都成立。因此，要初始化粒子 $i$ 的速度，我们必须从均值为 $\\mu=0$、标准差为 $\\sigma_i = \\sqrt{k_{\\mathrm{B}} T / m_i}$ 的正态分布中独立地采样其三个速度分量（$v_{ix}$、$v_{iy}$、$v_{iz}$）。\n\n**2. 并行安全的随机数生成**\n\n在并行 MPI 环境中，每个进程（进程号）必须在初始设置后独立生成随机数，无需与其他进程号协作。这需要一种种子设定机制，以保证不同进程号生成的随机数序列在统计上是独立的且不重叠。\n\n实现此目标的一种可靠方法是使用一个主种子为每个进程号派生出独立的种子序列。给定一个基础整数种子 $S$ 和总进程号数 $R$，我们可以初始化一个主 `SeedSequence` 对象。然后，该对象可以 `spawn`（派生）出 $R$ 个新的、独立的 `SeedSequence` 对象。进程号 $r$（其中 $r \\in \\{0, 1, \\dots, R-1\\}$）接着使用第 $r$ 个派生出的种子序列来初始化其自己的私有伪随机数生成器 (PRNG)。这种方法确保了可复现性（相同的 $S$ 和 $R$ 总是产生相同的流集合）和跨进程号的统计独立性。这就是随附代码中使用 `numpy.random.SeedSequence` 实现的策略。\n\n为了确定性地验证这种独立性，我们可以在执行任何全局操作之前，为每个进程号生成的原始速度集计算一个摘要。对每个进程号的原始速度数据进行安全哈希计算，可以提供一个可靠的摘要。如果种子设定机制正确，每个进程号将生成一个唯一的速度序列，从而为每个非空进程号分区生成一个唯一的摘要。\n\n**3. 质心速度移除的推导**\n\n在许多分子动力学模拟中，特别是对于孤立系统（NVE 系综），系统的总线性动量应该是一个守恒量。通常的做法是将系统初始化为总线性动量为零。从麦克斯韦-玻尔兹曼分布进行的初始采样生成的速度平均值为零，但对于任何有限的 $N$ 个粒子的样本，由于统计涨落，净动量将不为零。\n\n系统的总线性动量 $\\vec{P}_{\\text{total}}$ 是各个动量的矢量和：\n$$ \\vec{P}_{\\text{total}} = \\sum_{i=1}^{N} \\vec{p}_i = \\sum_{i=1}^{N} m_i \\vec{v}_i $$\n质心 (COM) 速度 $\\vec{V}_{\\text{COM}}$ 定义为总动量除以总质量 $M_{\\text{total}} = \\sum_{i=1}^{N} m_i$：\n$$ \\vec{V}_{\\text{COM}} = \\frac{\\vec{P}_{\\text{total}}}{M_{\\text{total}}} = \\frac{\\sum_{i=1}^{N} m_i \\vec{v}_i}{\\sum_{i=1}^{N} m_i} $$\n我们的目标是找到一组修正后的速度 $\\vec{v}'_i$，使得新的总动量 $\\vec{P}'_{\\text{total}}$ 为零向量 $\\vec{0}$。标准流程是通过从每个粒子的速度中减去 $\\vec{V}_{\\text{COM}}$，将系统转换到质心参考系：\n$$ \\vec{v}'_i = \\vec{v}_i - \\vec{V}_{\\text{COM}} $$\n我们现在证明这个变换能正确地使总动量为零。新的总动量是：\n$$ \\vec{P}'_{\\text{total}} = \\sum_{i=1}^{N} m_i \\vec{v}'_i = \\sum_{i=1}^{N} m_i (\\vec{v}_i - \\vec{V}_{\\text{COM}}) $$\n分配求和符号：\n$$ \\vec{P}'_{\\text{total}} = \\sum_{i=1}^{N} m_i \\vec{v}_i - \\sum_{i=1}^{N} m_i \\vec{V}_{\\text{COM}} $$\n第一项是原始的总动量 $\\vec{P}_{\\text{total}}$。在第二项中，$\\vec{V}_{\\text{COM}}$ 是一个相对于粒子求和而言的恒定向量，因此可以提取出来：\n$$ \\vec{P}'_{\\text{total}} = \\vec{P}_{\\text{total}} - \\vec{V}_{\\text{COM}} \\left(\\sum_{i=1}^{N} m_i\\right) = \\vec{P}_{\\text{total}} - \\vec{V}_{\\text{COM}} M_{\\text{total}} $$\n代入定义 $\\vec{P}_{\\text{total}} = \\vec{V}_{\\text{COM}} M_{\\text{total}}$：\n$$ \\vec{P}'_{\\text{total}} = (\\vec{V}_{\\text{COM}} M_{\\text{total}}) - \\vec{V}_{\\text{COM}} M_{\\text{total}} = \\vec{0} $$\n这证实了从每个粒子的速度中减去质心速度会将系统的总线性动量设置为零。在模拟的 MPI 环境中，这需要一个全局通信步骤：每个进程号计算其对总动量（$ \\sum_{i \\in \\text{rank}} m_i \\vec{v}_i $）和总质量的本地贡献。然后将这些值在所有进程号上求和（全局归约）以计算全局的 $\\vec{V}_{\\text{COM}}$，再将该值广播回所有进程号以执行减法操作。所提供的程序通过在拼接起来的全局速度数组上执行此计算来模拟这一过程。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nimport hashlib\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite for parallel-safe velocity initialization.\n    \"\"\"\n\n    # Define physical constants and masses\n    u = 1.66053906660e-27  # Atomic mass unit in kg\n    k_B = 1.380649e-23     # Boltzmann constant in J/K\n\n    mass_species = {\n        'Ar': 39.948 * u,\n        'H': 1.00784 * u,\n        'Xe': 131.293 * u,\n    }\n\n    # Define test cases\n    test_cases = [\n        # Case 1: Happy path\n        {\n            \"N\": 1000, \"R\": 4, \"T\": 300.0, \"S\": 123456789,\n            \"masses\": np.full(1000, mass_species['Ar']),\n            \"epsilon\": 1e-25\n        },\n        # Case 2: Boundary case\n        {\n            \"N\": 1, \"R\": 1, \"T\": 500.0, \"S\": 987654321,\n            \"masses\": np.full(1, mass_species['Ar']),\n            \"epsilon\": 1e-25\n        },\n        # Case 3: Heterogeneous masses\n        {\n            \"N\": 100, \"R\": 3, \"T\": 1000.0, \"S\": 192837465,\n            \"masses\": np.concatenate([\n                np.full(50, mass_species['H']),\n                np.full(50, mass_species['Xe'])\n            ]),\n            \"epsilon\": 1e-25\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        result = run_simulation(\n            N=case[\"N\"], R=case[\"R\"], T=case[\"T\"], S=case[\"S\"],\n            masses=case[\"masses\"], epsilon=case[\"epsilon\"], k_B=k_B\n        )\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\n\ndef run_simulation(N, R, T, S, masses, epsilon, k_B):\n    \"\"\"\n    Simulates the velocity initialization for a single test case.\n    \n    This function models an MPI environment by partitioning particles and using\n    independent random streams per partition (rank).\n    \"\"\"\n\n    # 1. Partition particles into R contiguous, evenly-sized subsets for each rank\n    base_size = N // R\n    remainder = N % R\n    counts = [base_size + 1] * remainder + [base_size] * (R - remainder)\n    \n    # Handle case where there are more ranks than particles\n    if N > 0 and R > 0 and N  R:\n        counts = [1] * N + [0] * (R-N)\n\n    indices = np.cumsum([0] + counts)\n    # particle_indices_per_rank is a list of Python range objects\n    particle_indices_per_rank = [range(indices[r], indices[r+1]) for r in range(R)]\n\n    # 2. Create independent, deterministic random number generators for each rank\n    master_ss = np.random.SeedSequence(S)\n    child_sgs = master_ss.spawn(R)\n    rngs = [np.random.default_rng(sg) for sg in child_sgs]\n\n    # 3. Sample velocities for each rank from its independent stream\n    # This loop simulates each rank working on its local data\n    velocities = np.zeros((N, 3))\n    rank_digests = []\n\n    for r in range(R):\n        rank_indices = particle_indices_per_rank[r]\n        num_particles_in_rank = len(rank_indices)\n        \n        if num_particles_in_rank == 0:\n            continue\n\n        rng = rngs[r]\n        \n        # Get masses for particles owned by this rank\n        rank_masses = masses[rank_indices]\n\n        # Calculate standard deviation for velocity components from equipartition\n        # sigma = sqrt(k_B * T / m)\n        # We compute it per-particle for heterogeneous systems\n        sigma_per_particle = np.sqrt(k_B * T / rank_masses)\n        \n        # Sample velocities from N(0, sigma^2)\n        # Broadcasting sigma_per_particle to (num_particles_in_rank, 3)\n        local_velocities = rng.normal(0.0, sigma_per_particle[:, np.newaxis], size=(num_particles_in_rank, 3))\n        \n        # Store in global velocity array\n        velocities[rank_indices, :] = local_velocities\n\n        # Compute a digest of the raw (pre-COM-removal) velocities for this rank\n        digest = hashlib.sha256(local_velocities.tobytes()).hexdigest()\n        rank_digests.append(digest)\n\n    # 4. Validate independence of random streams via digests\n    # All non-empty ranks should have generated unique velocity blocks\n    are_digests_distinct = (len(set(rank_digests)) == len(rank_digests))\n\n    # 5. Perform global COM velocity removal\n    total_mass = np.sum(masses)\n    \n    # Check for division by zero\n    if total_mass > 0:\n        # Calculate initial total momentum (sum over all ranks)\n        # In a real MPI code, this would be a sum-reduction\n        total_momentum = np.sum(velocities * masses[:, np.newaxis], axis=0)\n\n        # Calculate center-of-mass velocity\n        com_velocity = total_momentum / total_mass\n\n        # Subtract COM velocity from all particles\n        # In a real MPI code, V_com would be broadcast to all ranks\n        velocities_prime = velocities - com_velocity\n    else: # Handle case of zero total mass if N=0\n        velocities_prime = velocities\n\n    # 6. Validate momentum constraint\n    # Calculate final total momentum\n    final_total_momentum = np.sum(velocities_prime * masses[:, np.newaxis], axis=0)\n    \n    # Check if max absolute component is within tolerance\n    max_abs_momentum_component = np.max(np.abs(final_total_momentum))\n    is_momentum_zero = max_abs_momentum_component = epsilon\n\n    return [are_digests_distinct, is_momentum_zero, float(max_abs_momentum_component)]\n\nif __name__ == \"__main__\":\n    solve()\n```"
        }
    ]
}