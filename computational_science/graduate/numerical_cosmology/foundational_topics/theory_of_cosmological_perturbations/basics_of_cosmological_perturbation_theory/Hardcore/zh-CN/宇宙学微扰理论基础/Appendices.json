{
    "hands_on_practices": [
        {
            "introduction": "玻尔兹曼方程的级数展开是宇宙学微扰理论的核心，它描述了不同粒子种类分布函数的演化。然而，这个级数是无限的，任何数值求解器都必须在某个最大多极矩 $\\ell_{\\max}$ 处对其进行截断。这个实践练习将引导您直接探究这种截断所带来的后果，通过对无碰撞、自由传播的光子进行演化，您将量化截断误差如何依赖于物理尺度（由波数 $k$ 表示）和截断水平（$\\ell_{\\max}$），这是验证任何玻尔兹曼求解器精度的基本技能。",
            "id": "3465991",
            "problem": "你的任务是设计并实现一个数值实验，以诊断在没有碰撞和度规扰动的情况下，自由流光子温度玻尔兹曼等级结构的截断误差。实验在空间平坦、未扰动的背景下，采用共形牛顿规范，并考虑具有共动波数 $k$ 的傅里叶模式。假设使用自然单位制，其中光速 $c=1$，共动共形时间 $\\eta$ 以百万秒差距（megaparsecs）为单位，波数 $k$ 以百万秒差距的倒数为单位，因此 $k \\eta$ 是无量纲的。本问题中的所有输出都是无量纲的，无需报告物理单位。\n\n起点和范围：\n- 使用无质量粒子的无碰撞玻尔兹曼方程（刘维方程）及其勒让德多极展开作为基本基础。从中，确定在自由流条件下光子温度多极矩 $\\Theta_{\\ell}(k,\\eta)$ 的矩等级结构。\n- 采用截断策略，即在最大多极矩 $\\ell_{\\max}$ 处截断等级结构，并设置 $\\Theta_{\\ell_{\\max}+1} = 0$ 作为闭合条件。\n- 在 $\\eta=0$ 时施加描述纯单极扰动的初始条件：$\\Theta_{0}(k,0)=1$ 以及对于所有 $\\ell \\ge 1$，$\\Theta_{\\ell}(k,0)=0$。\n- 对每个测试案例，将等级结构演化到最终时间 $\\eta_{\\mathrm{f}} = 300$。\n- 将光子密度衬度定义为 $\\delta_{\\gamma}(k,\\eta) = 4 \\Theta_{0}(k,\\eta)$。\n\n用于误差测量的代理基准真相：\n- 对于给定的 $k$，通过使用一个更大的截断值 $\\ell_{\\max}^{\\mathrm{ref}} = 120$（使用相同的闭合条件 $\\Theta_{\\ell_{\\max}^{\\mathrm{ref}}+1}=0$）演化相同的等级结构，来定义一个高分辨率的代理基准真相，以获得参考多极矩 $\\Theta_{\\ell}^{\\mathrm{ref}}(k,\\eta_{\\mathrm{f}})$ 和参考密度衬度 $\\delta_{\\gamma}^{\\mathrm{ref}}(k,\\eta_{\\mathrm{f}})$。\n\n量化截断误差：\n- 对于一个具有参数 $(k,\\ell_{\\max})$ 的测试案例，演化到 $\\eta_{\\mathrm{f}}$ 后，计算：\n  1. 在 $\\eta_{\\mathrm{f}}$ 时的密度衬度相对误差，\n     $$\\varepsilon_{\\delta}(k,\\ell_{\\max}) = \\frac{\\left|\\delta_{\\gamma}(k,\\eta_{\\mathrm{f}})-\\delta_{\\gamma}^{\\mathrm{ref}}(k,\\eta_{\\mathrm{f}})\\right|}{\\max\\left(\\left|\\delta_{\\gamma}^{\\mathrm{ref}}(k,\\eta_{\\mathrm{f}})\\right|,\\tau\\right)},$$\n     其中 $\\tau=10^{-10}$ 是一个用于正则化分母的小阈值。\n  2. 低阶多极矩 $\\ell \\in \\{1,2,3\\}$ 中的最大相对误差，\n     $$\\varepsilon_{\\Theta}(k,\\ell_{\\max}) = \\max_{\\ell \\in \\{1,2,3\\}} \\frac{\\left|\\Theta_{\\ell}(k,\\eta_{\\mathrm{f}})-\\Theta_{\\ell}^{\\mathrm{ref}}(k,\\eta_{\\mathrm{f}})\\right|}{\\max\\left(\\left|\\Theta_{\\ell}^{\\mathrm{ref}}(k,\\eta_{\\mathrm{f}})\\right|,\\tau\\right)}.$$\n\n测试套件：\n- 使用以下波数和截断水平集合：\n  - $k \\in \\{10^{-3}, 10^{-2}, 10^{-1}\\}$，\n  - $\\ell_{\\max} \\in \\{6, 10, 20\\}$。\n- 九个测试案例是这些集合的笛卡尔积，按 $k$ 递增、对于每个固定的 $k$ 按 $\\ell_{\\max}$ 递增的字典序排列：\n  1. $(k=10^{-3},\\ell_{\\max}=6)$，\n  2. $(k=10^{-3},\\ell_{\\max}=10)$，\n  3. $(k=10^{-3},\\ell_{\\max}=20)$，\n  4. $(k=10^{-2},\\ell_{\\max}=6)$，\n  5. $(k=10^{-2},\\ell_{\\max}=10)$，\n  6. $(k=10^{-2},\\ell_{\\max}=20)$，\n  7. $(k=10^{-1},\\ell_{\\max}=6)$，\n  8. $(k=10^{-1},\\ell_{\\max}=10)$，\n  9. $(k=10^{-1},\\ell_{\\max}=20)$。\n\n算法要求：\n- 对于每个 $(k,\\ell_{\\max})$，使用数值稳定且精确的方法将截断的等级结构从 $\\eta=0$ 演化到 $\\eta=\\eta_{\\mathrm{f}}$。你可以实现一个显式时间积分器，或者等效地，将系统表述为一个线性常微分方程 $\\mathrm{d}\\boldsymbol{\\Theta}/\\mathrm{d}\\eta = \\mathbf{A}(k,\\ell_{\\max}) \\boldsymbol{\\Theta}$，并通过在 $\\eta_{\\mathrm{f}}$ 处的矩阵指数精确地推进它。\n- 对每个 $k$，应用相同的演化方法计算在 $\\ell_{\\max}^{\\mathrm{ref}}=120$ 时的代理基准真相。\n\n最终输出格式：\n- 你的程序应产生单行输出，包含一个由 $18$ 个浮点数组成的扁平列表，以十进制表示法。对于上述有序列表中的九个测试案例中的每一个，输出对 $\\left[\\varepsilon_{\\delta}(k,\\ell_{\\max}), \\varepsilon_{\\Theta}(k,\\ell_{\\max})\\right]$，并将所有九个对拼接成一个单一列表。要求的格式是单行：\n  “[e_delta_1,e_theta_1,e_delta_2,e_theta_2,...,e_delta_9,e_theta_9]”。",
            "solution": "我们从空间平坦的 Friedmann–Lemaître–Robertson–Walker (FLRW) 宇宙中无质量粒子的无碰撞玻尔兹曼方程（刘维方程）开始，该方程是为共形时间 $\\eta$ 中具有共动波数 $k$ 的傅里叶模式编写的。在共形牛顿规范下，且在没有引力势源和碰撞（退耦后的自由流）的情况下，比强度扰动纯粹通过自由流演化。将光子温度扰动展开为勒让德多极矩，\n$$\n\\Theta(\\mu, k, \\eta) = \\sum_{\\ell=0}^{\\infty} ( - i)^{\\ell} (2\\ell+1) \\Theta_{\\ell}(k,\\eta) \\, P_{\\ell}(\\mu),\n$$\n其中 $\\mu$ 是光子动量与波矢量之间夹角的余弦，$P_{\\ell}(\\mu)$ 是勒让德多项式，可以得到众所周知的自由流常微分方程线性等级结构：\n$$\n\\frac{\\mathrm{d}\\Theta_{0}}{\\mathrm{d}\\eta} = - k \\Theta_{1},\n$$\n$$\n\\frac{\\mathrm{d}\\Theta_{\\ell}}{\\mathrm{d}\\eta} = \\frac{k}{2\\ell+1}\\left[\\ell \\, \\Theta_{\\ell-1} - (\\ell+1) \\, \\Theta_{\\ell+1}\\right] \\quad \\text{for } \\ell \\ge 1.\n$$\n这些方程直接源于刘维算符在没有源的情况下作用于光子分布的角矩，这是宇宙学微扰理论中关于无质量自由流粒子的一个标准结果。\n\n截断与闭合：为了使系统在数值计算中是有限维的，我们在最大多极矩 $\\ell_{\\max}$ 处截断等级结构，并施加闭合条件 $\\Theta_{\\ell_{\\max}+1}=0$。这产生了一个由 $\\ell_{\\max}+1$ 个耦合线性常微分方程（ODEs）组成的系统：\n- 对于 $\\ell=0$，$\\mathrm{d}\\Theta_{0}/\\mathrm{d}\\eta = -k \\Theta_{1}$。\n- 对于 $1 \\le \\ell \\le \\ell_{\\max}-1$，$\\mathrm{d}\\Theta_{\\ell}/\\mathrm{d}\\eta = \\frac{k}{2\\ell+1}\\left[\\ell \\Theta_{\\ell-1} - (\\ell+1) \\Theta_{\\ell+1}\\right]$。\n- 对于 $\\ell=\\ell_{\\max}$，$\\mathrm{d}\\Theta_{\\ell_{\\max}}/\\mathrm{d}\\eta = \\frac{k}{2\\ell_{\\max}+1}\\left[\\ell_{\\max} \\Theta_{\\ell_{\\max}-1} - (\\ell_{\\max}+1) \\cdot 0\\right]$。\n\n初始条件：在 $\\eta=0$ 时，纯单极扰动由以下条件指定：\n$$\n\\Theta_{0}(k,0)=1, \\quad \\Theta_{\\ell}(k,0)=0 \\quad \\text{for all } \\ell \\ge 1.\n$$\n这个初始状态与一个初始各向同性的扰动相一致，随着时间的演化，该扰动通过自由流填充到更高阶的多极矩。\n\n矩阵表述与传播：截断后的系统可以表示为矩阵形式，\n$$\n\\frac{\\mathrm{d}}{\\mathrm{d}\\eta} \\boldsymbol{\\Theta}(k,\\eta) = \\mathbf{A}(k,\\ell_{\\max}) \\, \\boldsymbol{\\Theta}(k,\\eta),\n$$\n其中 $\\boldsymbol{\\Theta} = \\left(\\Theta_{0}, \\Theta_{1}, \\ldots, \\Theta_{\\ell_{\\max}} \\right)^{\\mathsf{T}}$，$\\mathbf{A}(k,\\ell_{\\max})$ 是一个三对角矩阵，其非零项编码了相邻多极矩之间的耦合：\n- $A_{0,1} = -k$,\n- 对于 $1 \\le \\ell \\le \\ell_{\\max}-1$, $A_{\\ell, \\ell-1} = \\frac{k \\ell}{2\\ell+1}$ 且 $A_{\\ell,\\ell+1} = -\\frac{k (\\ell+1)}{2\\ell+1}$,\n- 对于 $\\ell=\\ell_{\\max}$, $A_{\\ell_{\\max}, \\ell_{\\max}-1} = \\frac{k \\ell_{\\max}}{2\\ell_{\\max}+1}$，由于闭合条件，$A_{\\ell_{\\max}, \\ell_{\\max}+1}$ 不存在。\n\n由于 $\\mathbf{A}$ 不随时间变化，在最终时间 $\\eta_{\\mathrm{f}}$ 的解由矩阵指数精确给出，\n$$\n\\boldsymbol{\\Theta}(k,\\eta_{\\mathrm{f}}) = \\exp\\left[\\mathbf{A}(k,\\ell_{\\max}) \\, \\eta_{\\mathrm{f}}\\right] \\, \\boldsymbol{\\Theta}(k,0).\n$$\n这种方法得到了截断线性系统的精确解，并消除了时间步进误差，从而分离出我们希望诊断的等级结构截断误差。\n\n光子密度衬度：光子密度衬度与单极矩的关系为\n$$\n\\delta_{\\gamma}(k,\\eta) = 4 \\, \\Theta_{0}(k,\\eta).\n$$\n\n代理基准真相：为了量化截断误差，对于每个 $k$，我们使用 $\\ell_{\\max}^{\\mathrm{ref}}=120$ 和相同的闭合条件计算一个高分辨率的代理基准真相。将得到的在 $\\eta_{\\mathrm{f}}$ 时的多极矩和密度衬度记为 $\\Theta_{\\ell}^{\\mathrm{ref}}(k,\\eta_{\\mathrm{f}})$ 和 $\\delta_{\\gamma}^{\\mathrm{ref}}(k,\\eta_{\\mathrm{f}})$。\n\n误差度量：对于一个测试案例 $(k,\\ell_{\\max})$，我们在 $\\eta_{\\mathrm{f}}=300$ 定义两个度量：\n1. 密度衬度的相对误差，\n$$\n\\varepsilon_{\\delta}(k,\\ell_{\\max}) = \\frac{\\left|\\delta_{\\gamma}(k,\\eta_{\\mathrm{f}})-\\delta_{\\gamma}^{\\mathrm{ref}}(k,\\eta_{\\mathrm{f}})\\right|}{\\max\\left(\\left|\\delta_{\\gamma}^{\\mathrm{ref}}(k,\\eta_{\\mathrm{f}})\\right|,\\tau\\right)},\n$$\n正则化阈值 $\\tau=10^{-10}$ 用于避免除以非常接近零的数。\n2. 低阶多极矩 $\\ell \\in \\{1,2,3\\}$ 中的最大相对误差，\n$$\n\\varepsilon_{\\Theta}(k,\\ell_{\\max}) = \\max_{\\ell \\in \\{1,2,3\\}} \\frac{\\left|\\Theta_{\\ell}(k,\\eta_{\\mathrm{f}})-\\Theta_{\\ell}^{\\mathrm{ref}}(k,\\eta_{\\mathrm{f}})\\right|}{\\max\\left(\\left|\\Theta_{\\ell}^{\\mathrm{ref}}(k,\\eta_{\\mathrm{f}})\\right|,\\tau\\right)}.\n$$\n选择监测 $\\ell \\in \\{1,2,3\\}$ 是为了针对最低阶的角矩（从偶极到八极），这些角矩直接关系到大尺度可观测量，并对由截断引起的反弹敏感。\n\n测试套件与覆盖范围：我们考虑由 $k \\in \\{10^{-3}, 10^{-2}, 10^{-1}\\}$ 和 $\\ell_{\\max} \\in \\{6, 10, 20\\}$ 的笛卡尔积形成的九个测试案例。这些案例覆盖了：\n- 一个 $k \\eta_{\\mathrm{f}} \\ll 1$ ($k=10^{-3}$) 的区域，此时自由流较弱，对于任何 $\\ell_{\\max}$，截断误差预计都很小。\n- 一个中间区域 ($k=10^{-2}$)，用于探测中等程度的角向耦合。\n- 一个 $k \\eta_{\\mathrm{f}} \\gg 1$ ($k=10^{-1}$，因此 $k \\eta_{\\mathrm{f}}=30$) 的区域，此时许多多极矩被填充，不足的 $\\ell_{\\max}$ 会导致显著的截断误差，预计随着 $\\ell_{\\max}$ 的提高而减小。\n\n算法设计：对于每个 $(k,\\ell_{\\max})$，\n- 构建矩阵 $\\mathbf{A}(k,\\ell_{\\max})$。\n- 通过矩阵指数作用于初始向量 $(1,0,\\ldots,0)^{\\mathsf{T}}$ 来计算 $\\boldsymbol{\\Theta}(k,\\eta_{\\mathrm{f}})$。\n- 计算 $\\delta_{\\gamma}(k,\\eta_{\\mathrm{f}})=4 \\Theta_{0}(k,\\eta_{\\mathrm{f}})$。\n- 类似地，使用 $\\ell_{\\max}^{\\mathrm{ref}}=120$ 计算参考 $\\boldsymbol{\\Theta}^{\\mathrm{ref}}(k,\\eta_{\\mathrm{f}})$ 并提取参考量。\n- 使用上述公式和 $\\tau=10^{-10}$ 评估 $\\varepsilon_{\\delta}$ 和 $\\varepsilon_{\\Theta}$。\n- 按 $k$ 然后按 $\\ell_{\\max}$ 的字典序汇总所有测试案例的结果。\n\n最终输出：程序必须打印单行，包含一个由 $18$ 个浮点数组成的扁平列表，\n$$\n\\left[\\varepsilon_{\\delta}^{(1)}, \\varepsilon_{\\Theta}^{(1)}, \\varepsilon_{\\delta}^{(2)}, \\varepsilon_{\\Theta}^{(2)}, \\ldots, \\varepsilon_{\\delta}^{(9)}, \\varepsilon_{\\Theta}^{(9)}\\right],\n$$\n对应于上述指定顺序的九个测试案例。此格式便于自动验证。相对误差是无量纲的，必须以十进制表示法打印。\n\n预期行为：对于固定的 $k$，随着 $\\ell_{\\max}$ 的增加，$\\varepsilon_{\\delta}$ 和 $\\varepsilon_{\\Theta}$ 都应减小，反映出截断等级结构改善的收敛性。对于固定的 $\\ell_{\\max}$，增加 $k$ 应会增加误差，因为当 $k \\eta_{\\mathrm{f}}$ 增长时，更多数量的多极矩被显著激发，使得低 $\\ell_{\\max}$ 截断的准确性降低。使用矩阵指数确保了任何观测到的差异都主要由截断误差而非时间积分误差引起。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import expm\n\ndef build_boltzmann_matrix(k: float, lmax: int) -> np.ndarray:\n    \"\"\"\n    Build the (lmax+1) x (lmax+1) matrix A(k, lmax) for the free-streaming photon hierarchy\n    with closure Theta_{lmax+1} = 0.\n    \"\"\"\n    n = lmax + 1\n    A = np.zeros((n, n), dtype=float)\n    if n >= 2:\n        A[0, 1] = -k  # dTheta_0/deta = -k Theta_1\n    # Interior multipoles\n    for ell in range(1, lmax):\n        A[ell, ell - 1] = k * ell / (2.0 * ell + 1.0)\n        A[ell, ell + 1] = -k * (ell + 1.0) / (2.0 * ell + 1.0)\n    # Last multipole uses closure Theta_{lmax+1} = 0\n    if lmax >= 1:\n        A[lmax, lmax - 1] = k * lmax / (2.0 * lmax + 1.0)\n    return A\n\ndef propagate_to_eta_f(k: float, lmax: int, eta_f: float) -> np.ndarray:\n    \"\"\"\n    Propagate the truncated hierarchy from eta=0 to eta=eta_f using the matrix exponential.\n    Initial condition: Theta_0 = 1, Theta_l = 0 for l >= 1.\n    Returns the multipole vector Theta_l at eta_f for l=0..lmax.\n    \"\"\"\n    A = build_boltzmann_matrix(k, lmax)\n    # Initial condition vector\n    n = lmax + 1\n    theta0 = np.zeros(n, dtype=float)\n    theta0[0] = 1.0\n    # Exact solution of linear system at eta_f\n    M = expm(A * eta_f)\n    theta_f = M @ theta0\n    return theta_f\n\ndef robust_relative_error(approx: float, reference: float, tau: float = 1e-10) -> float:\n    \"\"\"\n    Compute robust relative error |approx - reference| / max(|reference|, tau).\n    \"\"\"\n    denom = max(abs(reference), tau)\n    return abs(approx - reference) / denom\n\ndef solve():\n    # Define problem parameters\n    eta_f = 300.0  # final conformal time (dimensionless in natural units, c=1)\n    k_values = [1e-3, 1e-2, 1e-1]\n    lmax_values = [6, 10, 20]\n    lmax_ref = 120\n    tau = 1e-10\n    # Indices of multipoles to assess for epsilon_Theta\n    l_eval = [1, 2, 3]\n\n    # Precompute reference solutions for each k\n    reference_map = {}\n    for k in k_values:\n        theta_ref = propagate_to_eta_f(k, lmax_ref, eta_f)\n        # Store both theta_ref and delta_gamma_ref = 4 * theta_ref[0]\n        delta_gamma_ref = 4.0 * theta_ref[0]\n        reference_map[k] = (theta_ref, delta_gamma_ref)\n\n    # Construct test cases in lexicographic order by k then lmax\n    test_cases = []\n    for k in k_values:\n        for lmax in lmax_values:\n            test_cases.append((k, lmax))\n\n    results = []\n    for (k, lmax) in test_cases:\n        # Compute approximate solution\n        theta_approx = propagate_to_eta_f(k, lmax, eta_f)\n        delta_gamma_approx = 4.0 * theta_approx[0]\n\n        # Extract reference\n        theta_ref, delta_gamma_ref = reference_map[k]\n\n        # Compute epsilon_delta\n        eps_delta = robust_relative_error(delta_gamma_approx, delta_gamma_ref, tau=tau)\n\n        # Compute epsilon_Theta as max relative error over l in {1,2,3}\n        eps_theta_list = []\n        for ell in l_eval:\n            # If ell exceeds available size in approx or ref (shouldn't for our choices), handle gracefully\n            if ell >= len(theta_approx) or ell >= len(theta_ref):\n                # If missing, treat approx as 0 for higher ell beyond truncation\n                approx_val = theta_approx[ell] if ell  len(theta_approx) else 0.0\n                ref_val = theta_ref[ell] if ell  len(theta_ref) else 0.0\n            else:\n                approx_val = theta_approx[ell]\n                ref_val = theta_ref[ell]\n            eps_l = robust_relative_error(approx_val, ref_val, tau=tau)\n            eps_theta_list.append(eps_l)\n        eps_theta = max(eps_theta_list) if eps_theta_list else 0.0\n\n        results.append(eps_delta)\n        results.append(eps_theta)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```"
        },
        {
            "introduction": "在早期宇宙中，光子和重子通过汤姆逊散射紧密耦合在一起。在这个时期直接对完整的玻尔兹曼方程进行积分，在数值上是“刚性”的，计算成本极高。本练习将展示所有现代宇宙学代码中使用的一项关键技术：紧耦合近似（TCA）。您将实现并比较完整演化、纯紧耦合近似以及一个混合方案，从而深入理解该近似的有效性范围，并体会到在数值精度和计算效率之间进行权衡的实践艺术。",
            "id": "3466029",
            "problem": "您的任务是实现并比较两种用于线性宇宙学微扰理论中耦合光子-重子流体的数值方案，并量化在光子退耦时，从紧耦合近似切换到截断的玻尔兹曼级联所引入的误差。在共形牛顿规范下，针对波数为 $k$ 的单个傅里叶模式进行研究，并以共形时间 $\\eta$ 作为自变量。此问题中的所有变量都是无量纲的，不需要进行物理单位转换。\n\n请从以下经过充分检验且被广泛接受的傅里叶空间中线性宇宙学微扰理论基础出发：\n- 光子流体由单极密度微扰 $\\delta_\\gamma$、偶极速度散度 $\\theta_\\gamma$ 和四极各向异性应力 $\\sigma_\\gamma$ 描述。\n- 重子流体由单极密度微扰 $\\delta_b$ 和偶极速度散度 $\\theta_b$ 描述。\n- 汤姆逊散射通过一个与共形时间相关的散射率 $\\tau'(\\eta)$ 将光子和重子耦合起来。在早期宇宙的辐射主导时期，该散射率近似地按 $\\tau'(\\eta) \\propto a(\\eta) n_e(\\eta) \\sim \\eta^{-2}$ 比例变化，其中 $a(\\eta)$ 是标度因子，$n_e(\\eta)$ 是自由电子数密度。我们用 $\\tau'(\\eta) = \\tau_0 \\left(\\eta_0 / \\eta\\right)^2$ 来对此建模，其中 $\\tau_0$ 是某个正常数，$\\eta_0$ 是参考时间。为方便数值计算，您将设置 $\\eta_0 = 1$ 并改变 $\\tau_0$；因此 $\\tau'(\\eta) = \\tau_0 \\eta^{-2}$。\n- 重子与光子的动量密度比为 $R \\equiv 3\\rho_b/(4\\rho_\\gamma)$，在测试套件所用的短时间间隔内，可将其视为一个常数参数。\n- 忽略宇宙膨胀的拖曳项（哈勃摩擦）和引力势，以孤立声学动力学和耦合效应。将重子压力视为可忽略，即 $c_b^2 = 0$。\n\n在这些假设下，光子和重子的傅里叶空间连续性方程和欧拉方程，以及光子的最低阶非平凡多极矩，在光子四极矩处截断时，构成一个封闭系统：\n1. 光子连续性方程：$\\delta_\\gamma' = -\\tfrac{4}{3}\\,\\theta_\\gamma$。\n2. 光子欧拉方程（压力与耦合，无引力）：$\\theta_\\gamma' = k^2\\left(\\tfrac{1}{4}\\delta_\\gamma - \\sigma_\\gamma\\right) - \\tau'(\\eta)\\left(\\theta_\\gamma - \\theta_b\\right)$。\n3. 光子四极矩方程（在 $\\ell=2$ 处带碰撞阻尼的闭合）：$\\sigma_\\gamma' = \\tfrac{4}{15}\\,\\theta_\\gamma - \\tau'(\\eta)\\,\\sigma_\\gamma$。\n4. 重子连续性方程：$\\delta_b' = -\\,\\theta_b$。\n5. 重子欧拉方程（仅有拖曳力）：$\\theta_b' = \\tfrac{\\tau'(\\eta)}{R}\\left(\\theta_\\gamma - \\theta_b\\right)$。\n\n此处，撇号表示对共形时间 $\\eta$ 的导数。该系统定义了您将要进行数值积分的“完整截断玻尔兹曼级联”。\n\n在紧耦合近似（TCA）中，当 $\\tau'(\\eta)$ 非常大时有效，汤姆逊散射强制 $\\theta_\\gamma \\approx \\theta_b$，并在领头阶上抑制光子各向异性应力 $\\sigma_\\gamma \\approx 0$。紧耦合的光子-重子流体随后表现为具有共同速度散度 $\\theta$ 的单一流体，遵循由光子压力驱动的声学动力学。从组合流体的能量和动量守恒出发，并使用 $R$ 的定义，证明在 $1/\\tau'$ 的领头阶上，封闭的 TCA 系统可写为：\n- $\\delta_\\gamma' = -\\tfrac{4}{3}\\,\\theta$，\n- $\\delta_b' = -\\,\\theta$，\n- $\\theta' = \\dfrac{k^2}{4(1+R)}\\,\\delta_\\gamma$。\n\n在实践中，TCA 仅在 $\\tau'(\\eta)$ 超过某个退耦阈值时使用。\n\n您的任务：\n1. 为单个模式 $k$ 实现一个针对完整截断玻尔兹曼级联（方程 1-5）的数值积分器，参数为 $R$ 和 $\\tau_0$，使用 $\\tau'(\\eta) = \\tau_0 \\eta^{-2}$。在起始时间 $\\eta_{\\mathrm{ini}}$ 处使用绝热初始条件：$\\delta_\\gamma(\\eta_{\\mathrm{ini}}) = A$, $\\delta_b(\\eta_{\\mathrm{ini}}) = \\tfrac{3}{4}A$, $\\theta_\\gamma(\\eta_{\\mathrm{ini}}) = 0$, $\\theta_b(\\eta_{\\mathrm{ini}}) = 0$, $\\sigma_\\gamma(\\eta_{\\mathrm{ini}}) = 0$，其中 $A$ 是一个小振幅。对于所有测试用例，设置 $A = 10^{-5}$。\n2. 为上述指定的领头阶紧耦合系统实现一个数值积分器，演化 $(\\delta_\\gamma,\\delta_b,\\theta)$。\n3. 实现一个“切换”方案，该方案从 $\\eta_{\\mathrm{ini}}$ 开始演化 TCA 系统，直到由 $\\tau'(\\eta_{\\mathrm{dec}}) = \\tau_{\\mathrm{dec}}$ 隐式定义的退耦时间 $\\eta_{\\mathrm{dec}}$，其中 $\\tau_{\\mathrm{dec}}$ 是一个给定的正阈值。在 $\\eta_{\\mathrm{dec}}$ 时，为完整截断玻尔兹曼级联构建初始条件如下：将 $\\delta_\\gamma, \\delta_b$ 设置为其在 $\\eta_{\\mathrm{dec}}$ 时的 TCA 值；将 $\\theta_\\gamma=\\theta_b=\\theta$ 设置为在 $\\eta_{\\mathrm{dec}}$ 时的 TCA 值；设置 $\\sigma_\\gamma(\\eta_{\\mathrm{dec}})=0$。然后从 $\\eta_{\\mathrm{dec}}$ 到 $\\eta_{\\mathrm{end}}$ 积分完整级联。\n4. 对于每个测试用例，量化在 $\\eta_{\\mathrm{end}}$ 时 $\\theta_\\gamma$ 和 $\\delta_b$ 的绝对误差：\n   - 切换方案相对于从 $\\eta_{\\mathrm{ini}}$ 到 $\\eta_{\\mathrm{end}}$ 未使用任何 TCA 的完整截断玻尔兹曼级联积分的误差。\n   - 纯 TCA 解相对于相同的完整积分基准的误差，通过在 $\\eta_{\\mathrm{end}}$ 将 TCA 的 $\\theta_\\gamma \\approx \\theta$ 和 $\\delta_b$ 与完整解进行比较。\n   使用绝对差值，而非归一化比率。\n\n为以下参数集测试套件实施上述方案，每个测试用例以 $(k, R, \\tau_0, \\eta_{\\mathrm{ini}}, \\eta_{\\mathrm{end}}, \\tau_{\\mathrm{dec}})$ 的形式给出：\n- 用例 1（一般声学，典型重子载荷）：$(0.1,\\,0.6,\\,10^6,\\,1.0,\\,1000.0,\\,10.0)$。\n- 用例 2（边界条件 $k=0$）：$(0.0,\\,0.6,\\,10^6,\\,1.0,\\,1000.0,\\,10.0)$。\n- 用例 3（重型重子载荷）：$(0.05,\\,3.0,\\,5\\times 10^5,\\,1.0,\\,800.0,\\,5.0)$。\n- 用例 4（因较低 $\\tau_0$ 导致的早期退耦）：$(0.2,\\,0.3,\\,10^4,\\,1.0,\\,500.0,\\,5.0)$。\n\n您的程序应生成单行输出，其中包含一个由方括号括起来的逗号分隔列表的结果。每个测试用例贡献一个包含四个浮点数的列表，顺序为 $[\\lvert\\theta_{\\gamma,\\mathrm{sw}}-\\theta_{\\gamma,\\mathrm{full}}\\rvert,\\lvert\\delta_{b,\\mathrm{sw}}-\\delta_{b,\\mathrm{full}}\\rvert,\\lvert\\theta_{\\gamma,\\mathrm{tca}}-\\theta_{\\gamma,\\mathrm{full}}\\rvert,\\lvert\\delta_{b,\\mathrm{tca}}-\\delta_{b,\\mathrm{full}}\\rvert]$，均在 $\\eta_{\\mathrm{end}}$ 处计算。将四个测试用例的列表聚合到一个单一的外部列表中并打印。例如，一个包含两个假设用例的输出将如下所示：“[[e11,e12,e13,e14],[e21,e22,e23,e24]]”。",
            "solution": "该问题是有效的。它提出了一个在计算宇宙学领域中适定的、有科学依据的任务，要求实现和比较演化光子-重子微扰的数值方案。所有必要的方程、参数和条件都已提供，并且设定是内部一致和客观的。从完整截断玻尔兹曼级联推导紧耦合近似（TCA）系统的过程是标准的，并且陈述正确。\n\n目标是量化在耦合光子-重子流体演化的早期阶段使用紧耦合近似所引入的误差。我们将针对波数为 $k$ 的单个傅里叶模式，比较三种不同的数值积分方案。所有计算都在共形牛顿规范下进行，使用共形时间 $\\eta$。\n\n系统状态由五个变量描述：光子密度微扰 $\\delta_\\gamma$、光子速度散度 $\\theta_\\gamma$、光子各向异性应力四极矩 $\\sigma_\\gamma$、重子密度微扰 $\\delta_b$ 和重子速度散度 $\\theta_b$。光子与重子之间的耦合由汤姆逊散射介导，其速率为 $\\tau'(\\eta) = \\tau_0 \\eta^{-2}$。重子惯性由常数比率 $R = 3\\rho_b/(4\\rho_\\gamma)$ 参数化。\n\n待实现的三种数值方案是：\n1.  **完整截断玻尔兹曼级联**：直接对由五个耦合常微分方程（ODE）组成的完整系统进行数值积分，作为我们的基准或“真实解”。\n2.  **纯紧耦合近似（TCA）**：在整个时间区间内，对一个简化的三变量系统进行数值积分，该系统在散射率极高（$\\tau' \\to \\infty$）的极限下有效。\n3.  **切换方案**：一种混合方法，在早期的紧耦合时期使用计算成本较低的TCA，然后在特定的退耦时间 $\\eta_{\\mathrm{dec}}$ 之后切换到完整级联积分。\n\n两个系统的控制方程如下。\n\n**1. 完整截断玻尔兹曼级联**\n该系统由状态向量 $y(\\eta) = [\\delta_\\gamma, \\theta_\\gamma, \\sigma_\\gamma, \\delta_b, \\theta_b]^T$ 的五个一阶常微分方程组成：\n$$\n\\begin{align*}\n\\frac{d\\delta_\\gamma}{d\\eta} = -\\frac{4}{3}\\theta_\\gamma \\\\\n\\frac{d\\theta_\\gamma}{d\\eta} = k^2\\left(\\frac{1}{4}\\delta_\\gamma - \\sigma_\\gamma\\right) - \\tau'(\\eta)\\left(\\theta_\\gamma - \\theta_b\\right) \\\\\n\\frac{d\\sigma_\\gamma}{d\\eta} = \\frac{4}{15}\\theta_\\gamma - \\tau'(\\eta)\\sigma_\\gamma \\\\\n\\frac{d\\delta_b}{d\\eta} = -\\theta_b \\\\\n\\frac{d\\theta_b}{d\\eta} = \\frac{\\tau'(\\eta)}{R}\\left(\\theta_\\gamma - \\theta_b\\right)\n\\end{align*}\n$$\n\n**2. 紧耦合近似（TCA）系统**\n在极限 $\\tau' \\gg k$ 下，散射非常有效，迫使 $\\theta_\\gamma \\approx \\theta_b \\equiv \\theta$ 并抑制各向异性应力 $\\sigma_\\gamma \\approx 0$。动力学简化为状态向量 $y_{\\mathrm{TCA}}(\\eta) = [\\delta_\\gamma, \\delta_b, \\theta]^T$ 的三个常微分方程组：\n$$\n\\begin{align*}\n\\frac{d\\delta_\\gamma}{d\\eta} = -\\frac{4}{3}\\theta \\\\\n\\frac{d\\delta_b}{d\\eta} = -\\theta \\\\\n\\frac{d\\theta}{d\\eta} = \\frac{k^2}{4(1+R)}\\delta_\\gamma\n\\end{align*}\n$$\n该系统描述了一个具有共同速度 $\\theta$ 的单一流体，其动力学由作用于光子和重子组合惯量 $(1+R)$ 上的光子压力驱动。\n\n**数值积分与比较策略**\n我们将使用一个高精度的自适应步长常微分方程求解器（`scipy.integrate.solve_ivp`，使用 `RK45` 方法和严格的容差 `rtol=1e-8, atol=1e-12`）来求解每个测试用例的这些系统。在 $\\eta = \\eta_{\\mathrm{ini}}$ 处施加绝热初始条件：$\\delta_\\gamma = A$, $\\delta_b = \\frac{3}{4}A$，所有其他变量为零，振幅 $A = 10^{-5}$。\n\n-   **完整积分（基准）**：我们从 $\\eta_{\\mathrm{ini}}$ 到 $\\eta_{\\mathrm{end}}$ 积分 5 变量系统，以获得在 $\\eta_{\\mathrm{end}}$ 处的参考解 $[\\delta_{\\gamma,\\mathrm{full}}, \\theta_{\\gamma,\\mathrm{full}}, \\dots]$。\n\n-   **纯 TCA 积分**：我们从 $\\eta_{\\mathrm{ini}}$ 到 $\\eta_{\\mathrm{end}}$ 积分 3 变量 TCA 系统，以获得在 $\\eta_{\\mathrm{end}}$ 处的解 $[\\delta_{\\gamma,\\mathrm{tca}}, \\delta_{b,\\mathrm{tca}}, \\theta_{\\mathrm{tca}}]$。\n\n-   **切换方案积分**：这是一个两步过程：\n    1.  退耦时间 $\\eta_{\\mathrm{dec}}$ 由条件 $\\tau'(\\eta_{\\mathrm{dec}}) = \\tau_{\\mathrm{dec}}$ 计算得出，即 $\\eta_{\\mathrm{dec}} = \\sqrt{\\tau_0 / \\tau_{\\mathrm{dec}}}$。\n    2.  TCA 系统从 $\\eta_{\\mathrm{ini}}$ 积分到 $\\eta_{\\mathrm{dec}}$，得到状态 $[\\delta_\\gamma(\\eta_{\\mathrm{dec}}), \\delta_b(\\eta_{\\mathrm{dec}}), \\theta(\\eta_{\\mathrm{dec}})]$。\n    3.  这些值用于在 $\\eta_{\\mathrm{dec}}$ 处构建完整系统的初始条件：$\\delta_\\gamma$ 和 $\\delta_b$ 直接继承，$\\theta_\\gamma = \\theta_b = \\theta$，并且 $\\sigma_\\gamma$ 设置为 0。\n    4.  然后，完整的 5 变量系统从 $\\eta_{\\mathrm{dec}}$ 积分到 $\\eta_{\\mathrm{end}}$，以获得在 $\\eta_{\\mathrm{end}}$ 处的切换方案解 $[\\delta_{\\gamma,\\mathrm{sw}}, \\theta_{\\gamma,\\mathrm{sw}}, \\dots]$。\n\n**误差量化**\n对于每个测试用例，我们在最终时间 $\\eta_{\\mathrm{end}}$ 计算四个绝对误差度量：\n1.  切换方案中 $\\theta_\\gamma$ 的误差：$|\\theta_{\\gamma,\\mathrm{sw}}(\\eta_{\\mathrm{end}}) - \\theta_{\\gamma,\\mathrm{full}}(\\eta_{\\mathrm{end}})|$。\n2.  切换方案中 $\\delta_b$ 的误差：$|\\delta_{b,\\mathrm{sw}}(\\eta_{\\mathrm{end}}) - \\delta_{b,\\mathrm{full}}(\\eta_{\\mathrm{end}})|$。\n3.  纯 TCA 方案中 $\\theta_\\gamma$ 的误差：$|\\theta_{\\mathrm{tca}}(\\eta_{\\mathrm{end}}) - \\theta_{\\gamma,\\mathrm{full}}(\\eta_{\\mathrm{end}})|$。\n4.  纯 TCA 方案中 $\\delta_b$ 的误差：$|\\delta_{b,\\mathrm{tca}}(\\eta_{\\mathrm{end}}) - \\delta_{b,\\mathrm{full}}(\\eta_{\\mathrm{end}})|$。\n\n实现将遍历所提供的测试用例，为每个用例执行这三种积分，计算四个误差度量，并按指定格式输出结果。",
            "answer": "```python\nimport numpy as np\nfrom scipy.integrate import solve_ivp\n\ndef solve():\n    \"\"\"\n    Implements and compares numerical schemes for coupled photon-baryon fluid\n    dynamics in linear cosmological perturbation theory.\n    \"\"\"\n    A = 1e-5  # Initial amplitude\n\n    # Test cases: (k, R, tau_0, eta_ini, eta_end, tau_dec)\n    test_cases = [\n        (0.1, 0.6, 1e6, 1.0, 1000.0, 10.0),\n        (0.0, 0.6, 1e6, 1.0, 1000.0, 10.0),\n        (0.05, 3.0, 5e5, 1.0, 800.0, 5.0),\n        (0.2, 0.3, 1e4, 1.0, 500.0, 5.0),\n    ]\n\n    all_results = []\n\n    # Set stringent tolerances for the ODE solver to minimize its own error\n    rtol = 1e-8\n    atol = 1e-12\n\n    for k, R, tau_0, eta_ini, eta_end, tau_dec in test_cases:\n\n        # --- Define ODE systems ---\n\n        def tau_prime(eta):\n            # Scattering rate as a function of conformal time eta\n            return tau_0 / (eta**2)\n\n        def full_system(eta, y):\n            \"\"\"Full truncated Boltzmann hierarchy (5 variables).\"\"\"\n            delta_gamma, theta_gamma, sigma_gamma, delta_b, theta_b = y\n            tau_p = tau_prime(eta)\n            \n            d_delta_gamma = -4.0/3.0 * theta_gamma\n            d_theta_gamma = k**2 * (0.25 * delta_gamma - sigma_gamma) - tau_p * (theta_gamma - theta_b)\n            d_sigma_gamma = 4.0/15.0 * theta_gamma - tau_p * sigma_gamma\n            d_delta_b = -theta_b\n            d_theta_b = (tau_p / R) * (theta_gamma - theta_b)\n            \n            return [d_delta_gamma, d_theta_gamma, d_sigma_gamma, d_delta_b, d_theta_b]\n\n        def tca_system(eta, y):\n            \"\"\"Tight-Coupling Approximation (TCA) system (3 variables).\"\"\"\n            delta_gamma, delta_b, theta = y\n\n            d_delta_gamma = -4.0/3.0 * theta\n            d_delta_b = -theta\n            d_theta = (k**2 / (4.0 * (1.0 + R))) * delta_gamma\n            \n            return [d_delta_gamma, d_delta_b, d_theta]\n\n        # --- Initial Conditions ---\n        # State vector: [delta_gamma, theta_gamma, sigma_gamma, delta_b, theta_b]\n        y_ini_full = np.array([A, 0.0, 0.0, 0.75 * A, 0.0])\n        # State vector: [delta_gamma, delta_b, theta]\n        y_ini_tca = np.array([A, 0.75 * A, 0.0])\n\n        # --- Scheme 1: Full Boltzmann Hierarchy Integration (Baseline) ---\n        sol_full = solve_ivp(\n            full_system, (eta_ini, eta_end), y_ini_full,\n            rtol=rtol, atol=atol, dense_output=True\n        )\n        y_full_end = sol_full.y[:, -1]\n\n        # --- Scheme 2: Pure TCA Integration ---\n        sol_tca = solve_ivp(\n            tca_system, (eta_ini, eta_end), y_ini_tca,\n            rtol=rtol, atol=atol, dense_output=True\n        )\n        y_tca_end = sol_tca.y[:, -1]\n\n        # --- Scheme 3: Switched Scheme (TCA -> Full) ---\n        eta_dec = np.sqrt(tau_0 / tau_dec) if tau_dec > 0 else eta_end\n        \n        # Part 1: Integrate TCA until eta_dec\n        sol_tca_part1 = solve_ivp(\n            tca_system, (eta_ini, eta_dec), y_ini_tca,\n            rtol=rtol, atol=atol, dense_output=True\n        )\n        y_tca_at_dec = sol_tca_part1.y[:, -1]\n\n        # Construct initial conditions for the full system at eta_dec\n        delta_gamma_dec, delta_b_dec, theta_dec = y_tca_at_dec\n        y_ini_switched = np.array([\n            delta_gamma_dec,  # delta_gamma\n            theta_dec,        # theta_gamma\n            0.0,              # sigma_gamma\n            delta_b_dec,      # delta_b\n            theta_dec         # theta_b\n        ])\n        \n        # Part 2: Integrate full system from eta_dec to eta_end\n        sol_switched_part2 = solve_ivp(\n            full_system, (eta_dec, eta_end), y_ini_switched,\n            rtol=rtol, atol=atol, dense_output=True\n        )\n        y_sw_end = sol_switched_part2.y[:, -1]\n\n        # --- Error Quantification at eta_end ---\n        theta_gamma_full = y_full_end[1]\n        delta_b_full = y_full_end[3]\n\n        theta_gamma_sw = y_sw_end[1]\n        delta_b_sw = y_sw_end[3]\n        \n        delta_b_tca = y_tca_end[1]\n        theta_tca = y_tca_end[2]\n\n        err_theta_sw = abs(theta_gamma_sw - theta_gamma_full)\n        err_delta_b_sw = abs(delta_b_sw - delta_b_full)\n        \n        err_theta_tca = abs(theta_tca - theta_gamma_full)\n        err_delta_b_tca = abs(delta_b_tca - delta_b_full)\n        \n        case_results = [err_theta_sw, err_delta_b_sw, err_theta_tca, err_delta_b_tca]\n        all_results.append(case_results)\n\n    # --- Format and Print Final Output ---\n    # Convert each inner list of floats to a string representation\n    result_strings = [f\"[{','.join(map(str, res))}]\" for res in all_results]\n    \n    # Join the string representations of inner lists with commas and enclose in brackets\n    final_output = f\"[{','.join(result_strings)}]\"\n    print(final_output)\n\nsolve()\n```"
        },
        {
            "introduction": "宇宙学微扰理论可以在不同的坐标系或“规范”中进行表述。虽然度规和流体的微扰量本身是依赖于规范选择的，但物理可观测量必须是规范不变的。最后的这个实践练习将通过在同步规范和牛顿规范之间进行显式变换，来巩固您对规范问题的理解。通过构建规范不变的巴丁势 $\\Phi_B$ 和 $\\Psi_B$，您将在数值上验证它们如理论所预言的那样保持相等且不随时间变化，从而展示如何从依赖于规范的量中提取出真正的物理信息。",
            "id": "3466020",
            "problem": "考虑一个空间平坦的 Friedmann–Lemaître–Robertson–Walker (FLRW) 宇宙，该宇宙充满了单一的无压强理想流体（冷暗物质），其状态方程参数 $w=0$ 且各向异性应力为零，时间坐标为共形时间 $\\eta$。采用光速 $c=1$ 的单位制，且引力耦合归一化，使得在物质主导时期，$4\\pi G a^2 \\rho = \\tfrac{3}{2}\\,\\mathcal{H}^2$，其中 $a(\\eta)$ 是尺度因子，$\\rho(\\eta)$ 是背景密度，而 $\\mathcal{H}(\\eta) \\equiv a'(\\eta)/a(\\eta)$ 是共形哈勃率。对于 Einstein–de Sitter 背景，假设 $a(\\eta)\\propto \\eta^2$，因此 $\\mathcal{H}(\\eta) = 2/\\eta$。\n\n关注线性标量微扰和具有共动波数 $k$ 的单一傅里叶模式。在与冷暗物质共动的同步规范下，设增长模式的密度衬度由 $\\delta_s(\\eta)$ 指定，同步度规微扰在标准的迹/无迹分解下为 $(h(\\eta),\\eta_s(\\eta))$。使用基本线性化的 Einstein 方程和冷暗物质能量-动量守恒定律作为出发点，即：\n- 物质主导的背景关系 $4\\pi G a^2 \\rho = \\tfrac{3}{2}\\,\\mathcal{H}^2$。\n- 同步规范下的冷暗物质连续性方程 $\\delta_s'(\\eta) = -\\tfrac{1}{2}\\,h'(\\eta)$。\n- 同步规范下用于标量微扰的哈密顿约束 $k^2 \\eta_s(\\eta) - \\tfrac{1}{2}\\,\\mathcal{H}(\\eta)\\,h'(\\eta) = \\tfrac{3}{2}\\,\\mathcal{H}(\\eta)^2 \\delta_s(\\eta)$。\n- 由标量时间平移生成元 $\\alpha(\\eta)$ 决定的同步规范到牛顿（纵向）规范的规范变换，其中 $\\alpha(\\eta) \\equiv \\tfrac{h'(\\eta) + 6\\,\\eta_s'(\\eta)}{2 k^2}$。\n- 通过规范变换定义的 Bardeen 势 $\\Psi_B(\\eta) \\equiv -\\alpha'(\\eta) - \\mathcal{H}(\\eta)\\,\\alpha(\\eta)$ 和 $\\Phi_B(\\eta) \\equiv \\eta_s(\\eta) - \\mathcal{H}(\\eta)\\,\\alpha(\\eta)$，在没有各向异性应力的情况下，它们分别与牛顿规范中的 lapse 势和曲率势一致。\n\n你的任务是编写一个程序，该程序：\n- 通过取 $\\delta_s(\\eta) = A\\,\\eta^2$（这与物质主导时期 $\\delta_s \\propto a$ 一致）来为选定的振幅参数 $A$ 构建同步规范的增长模式，并使用上述基本关系来确定 $h'(\\eta)$ 和 $\\eta_s(\\eta)$。\n- 计算生成元 $\\alpha(\\eta)$ 以及在指定的共形时间间隔内相应的规范不变 Bardeen 势 $\\Phi_B(\\eta)$ 和 $\\Psi_B(\\eta)$。\n- 验证对于单一无压强且无各向异性应力的流体必须成立的两个性质：（i）Bardeen 势 $\\Phi_B(\\eta)$ 和 $\\Psi_B(\\eta)$ 在所有时间都相等，以及（ii）在物质主导时期，这些势对于增长模式不随时间变化。\n- 通过为每个测试案例计算一个标量诊断值来量化此验证，该诊断值等于在采样时间间隔内三个绝对差值的最大值：$|\\Phi_B(\\eta) - \\Psi_B(\\eta)|$、 $|\\Phi_B(\\eta) - \\Phi_{\\mathrm{const}}|$ 和 $|\\Psi_B(\\eta) - \\Phi_{\\mathrm{const}}|$，其中 $\\Phi_{\\mathrm{const}} \\equiv \\tfrac{6A}{k^2}$ 是增长模式下 Bardeen 势的恒定期望值。\n\n在这些单位中，所有量都是无量纲的。角度没有出现；因此，不需要角度单位。最终输出应为浮点数。\n\n实现该程序，以评估以下参数值测试套件的诊断值，每个测试套件指定为一个元组 $(k,A,\\eta_{\\min},\\eta_{\\max},N)$：\n- 测试案例 1：$(k=\\;0.01,\\;A=\\;10^{-6},\\;\\eta_{\\min}=\\;0.1,\\;\\eta_{\\max}=\\;10,\\;N=\\;100)$。\n- 测试案例 2：$(k=\\;2.0,\\;A=\\;10^{-6},\\;\\eta_{\\min}=\\;0.1,\\;\\eta_{\\max}=\\;10,\\;N=\\;100)$。\n- 测试案例 3：$(k=\\;50.0,\\;A=\\;10^{-6},\\;\\eta_{\\min}=\\;0.1,\\;\\eta_{\\max}=\\;10,\\;N=\\;100)$。\n- 测试案例 4：$(k=\\;1.0,\\;A=\\;5\\times 10^{-7},\\;\\eta_{\\min}=\\;10^{-3},\\;\\eta_{\\max}=\\;10^{-2},\\;N=\\;50)$。\n\n你的程序应产生单行输出，其中包含四个诊断值，格式为方括号内以逗号分隔的列表，并按上述顺序列出（例如 $[\\mathrm{d}_1,\\mathrm{d}_2,\\mathrm{d}_3,\\mathrm{d}_4]$）。每个诊断值必须是从相应测试案例计算出的浮点数。",
            "solution": "在进行求解之前，对问题陈述进行了严格验证。\n\n### 第1步：提取已知条件\n- **宇宙学模型**：空间平坦的 FLRW 宇宙，含单一无压强理想流体（冷暗物质，$w=0$，各向异性应力为零）。\n- **时间坐标**：共形时间 $\\eta$。\n- **背景演化**：Einstein–de Sitter，尺度因子 $a(\\eta) \\propto \\eta^2$，共形哈勃率 $\\mathcal{H}(\\eta) \\equiv a'(\\eta)/a(\\eta) = 2/\\eta$。\n- **归一化**：单位制选择为 $c=1$ 且 $4\\pi G a^2 \\rho = \\tfrac{3}{2}\\,\\mathcal{H}^2$。\n- **微扰**：与冷暗物质共动的同步规范下的线性标量微扰，针对波数为 $k$ 的单一傅里叶模式。\n- **微扰变量**：同步密度衬度 $\\delta_s(\\eta)$，度规微扰 $(h(\\eta), \\eta_s(\\eta))$。\n- **控制方程**：\n    1.  连续性方程：$\\delta_s'(\\eta) = -\\tfrac{1}{2}\\,h'(\\eta)$。\n    2.  哈密顿约束：$k^2 \\eta_s(\\eta) - \\tfrac{1}{2}\\,\\mathcal{H}(\\eta)\\,h'(\\eta) = \\tfrac{3}{2}\\,\\mathcal{H}(\\eta)^2 \\delta_s(\\eta)$。\n- **规范变换与不变量**：\n    1.  到牛顿规范的规范生成元：$\\alpha(\\eta) \\equiv \\tfrac{h'(\\eta) + 6\\,\\eta_s'(\\eta)}{2 k^2}$。\n    2.  Bardeen 势：$\\Psi_B(\\eta) \\equiv -\\alpha'(\\eta) - \\mathcal{H}(\\eta)\\,\\alpha(\\eta)$ 和 $\\Phi_B(\\eta) \\equiv \\eta_s(\\eta) - \\mathcal{H}(\\eta)\\,\\alpha(\\eta)$。\n- **增长模式拟设**：$\\delta_s(\\eta) = A\\,\\eta^2$。\n- **期望的常数势**：$\\Phi_{\\mathrm{const}} \\equiv \\tfrac{6A}{k^2}$。\n- **任务**：对于给定的参数，计算同步微扰、规范生成元 $\\alpha(\\eta)$、Bardeen 势 $\\Phi_B(\\eta)$ 和 $\\Psi_B(\\eta)$，并计算一个诊断值。\n- **诊断值定义**：$D = \\max_{\\eta \\in [\\eta_{\\min}, \\eta_{\\max}]} \\left( |\\Phi_B(\\eta) - \\Psi_B(\\eta)|, |\\Phi_B(\\eta) - \\Phi_{\\mathrm{const}}|, |\\Psi_B(\\eta) - \\Phi_{\\mathrm{const}}| \\right)$。\n- **测试案例**：\n    - 案例 1：$(k=0.01, A=10^{-6}, \\eta_{\\min}=0.1, \\eta_{\\max}=10, N=100)$\n    - 案例 2：$(k=2.0, A=10^{-6}, \\eta_{\\min}=0.1, \\eta_{\\max}=10, N=100)$\n    - 案例 3：$(k=50.0, A=10^{-6}, \\eta_{\\min}=0.1, \\eta_{\\max}=10, N=100)$\n    - 案例 4：$(k=1.0, A=5\\times 10^{-7}, \\eta_{\\min}=10^{-3}, \\eta_{\\max}=10^{-2}, N=50)$\n\n### 第2步：使用提取的已知条件进行验证\n- **科学上成立**：该问题基于简化的 FLRW 宇宙中标准且成熟的宇宙学微扰理论。所有方程和定义均为标准教科书内容。\n- **良构**：问题陈述清晰，提供了所有必要的方程、初始条件（增长模式拟设）和参数，以推导出唯一解并计算所需的诊断值。\n- **客观性**：问题使用精确、客观的科学语言，不含主观论断。\n- **缺陷检查**：\n    1.  **科学/事实上不成立**：无。对于指定的模型，其物理和数学是正确的。\n    2.  **非形式化/不相关**：无。该问题是数值宇宙学中的一个形式化练习。\n    3.  **不完整/矛盾的设置**：无。方程组对于此任务是完备且一致的。\n    4.  **不切实际/不可行**：无。该模型是一个标准的简化，参数对于此类分析在物理上是合理的。\n    5.  **病态/结构不良**：无。可以推导出唯一、稳定的解。\n    6.  **伪深刻/琐碎**：无。该问题是一个非琐碎但标准的练习，用于测试基本概念。\n    7.  **超出科学可验证性**：无。结果可通过直接计算进行验证。\n\n### 第3步：结论与行动\n问题有效。将提供完整解答。\n\n### 解答推导与算法设计\n目标是计算一个诊断值，以数值方式验证物质主导宇宙中宇宙学微扰的基本性质。这需要首先推导出所涉及量的解析表达式，然后进行数值实现。\n\n**1. 解析推导**\n\n给定物质主导时期的增长模式密度衬度 $\\delta_s(\\eta) = A\\,\\eta^2$ 和共形哈勃率 $\\mathcal{H}(\\eta) = 2/\\eta$，我们推导其他微扰变量。\n\n- **同步度规微扰 $h'(\\eta)$**：\n根据连续性方程，$\\delta_s'(\\eta) = -\\tfrac{1}{2}\\,h'(\\eta)$。密度衬度的导数为 $\\delta_s'(\\eta) = \\frac{d}{d\\eta}(A\\,\\eta^2) = 2A\\eta$。\n因此，$h'(\\eta) = -2\\,\\delta_s'(\\eta) = -4A\\eta$。\n\n- **同步度规微扰 $\\eta_s(\\eta)$**：\n哈密顿约束为 $k^2 \\eta_s(\\eta) - \\tfrac{1}{2}\\,\\mathcal{H}(\\eta)\\,h'(\\eta) = \\tfrac{3}{2}\\,\\mathcal{H}(\\eta)^2 \\delta_s(\\eta)$。\n代入已知表达式：\n$k^2 \\eta_s(\\eta) - \\tfrac{1}{2}\\,(2/\\eta)\\,(-4A\\eta) = \\tfrac{3}{2}\\,(2/\\eta)^2 (A\\,\\eta^2)$\n$k^2 \\eta_s(\\eta) + 4A = \\tfrac{3}{2}\\,(4/\\eta^2) (A\\eta^2) = 6A$\n解出 $\\eta_s(\\eta)$，得到 $k^2 \\eta_s(\\eta) = 2A$，所以 $\\eta_s(\\eta) = \\frac{2A}{k^2}$。这是一个常数。\n\n- **规范变换生成元 $\\alpha(\\eta)$**：\n生成元定义为 $\\alpha(\\eta) = \\tfrac{h'(\\eta) + 6\\,\\eta_s'(\\eta)}{2 k^2}$。\n由于 $\\eta_s(\\eta)$ 是常数，其导数 $\\eta_s'(\\eta) = 0$。\n代入此结果和 $h'(\\eta)$ 的表达式：\n$\\alpha(\\eta) = \\frac{-4A\\eta + 6(0)}{2k^2} = -\\frac{2A\\eta}{k^2}$。\n\n- **Bardeen 势 $\\Phi_B(\\eta)$ 和 $\\Psi_B(\\eta)$**：\n为求 $\\Psi_B(\\eta)$，我们首先需要 $\\alpha(\\eta)$ 的导数：$\\alpha'(\\eta) = \\frac{d}{d\\eta}\\left(-\\frac{2A\\eta}{k^2}\\right) = -\\frac{2A}{k^2}$。\n现在我们使用它们的定义来计算势：\n$\\Phi_B(\\eta) = \\eta_s(\\eta) - \\mathcal{H}(\\eta)\\,\\alpha(\\eta) = \\frac{2A}{k^2} - (\\frac{2}{\\eta})\\left(-\\frac{2A\\eta}{k^2}\\right) = \\frac{2A}{k^2} + \\frac{4A}{k^2} = \\frac{6A}{k^2}$。\n$\\Psi_B(\\eta) = -\\alpha'(\\eta) - \\mathcal{H}(\\eta)\\,\\alpha(\\eta) = -\\left(-\\frac{2A}{k^2}\\right) - (\\frac{2}{\\eta})\\left(-\\frac{2A\\eta}{k^2}\\right) = \\frac{2A}{k^2} + \\frac{4A}{k^2} = \\frac{6A}{k^2}$。\n\n**2. 验证与数值策略**\n\n解析推导证实了，对于物质主导时期无各向异性应力的增长模式：\n(i) Bardeen 势相等：$\\Phi_B(\\eta) = \\Psi_B(\\eta)$。\n(ii) 势不随时间变化：$\\Phi_B(\\eta) = \\Psi_B(\\eta) = \\frac{6A}{k^2}$，这与给定的 $\\Phi_{\\mathrm{const}}$ 相符。\n\n在解析上，诊断值计算中的所有三个差值都恒等于零。数值任务的目的是按定义实现计算序列，并测量这些恒等式在有限精度算术下的保持程度。计算出的诊断值将是一个小的非零数，量化累积的浮点误差。\n\n算法如下：\n1.  对于每个测试案例，在 $\\eta$ 从 $\\eta_{\\min}$ 到 $\\eta_{\\max}$ 的范围内创建 $N$ 个点的网格。\n2.  使用它们的解析形式计算 $h'(\\eta)$ 和 $\\eta_s(\\eta)$ 的数组。\n3.  数值微分 $\\eta_s(\\eta)$ 数组以获得 $\\eta_s'(\\eta)$。\n4.  使用给定公式计算生成元 $\\alpha(\\eta)$ 的数组。\n5.  数值微分 $\\alpha(\\eta)$ 数组以获得 $\\alpha'(\\eta)$。\n6.  使用它们的定义计算 Bardeen 势 $\\Phi_B(\\eta)$ 和 $\\Psi_B(\\eta)$ 的数组。\n7.  计算三个绝对差值数组：$|\\Phi_B - \\Psi_B|$、 $|\\Phi_B - \\Phi_{\\mathrm{const}}|$ 和 $|\\Psi_B - \\Phi_{\\mathrm{const}}|$。\n8.  最终的诊断值是这三个数组中所有元素的最大值。使用 `numpy.gradient` 适合进行数值微分。由于被微分的函数是常数或线性的，该方法在机器精度范围内是数值精确的。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef calculate_diagnostic(k, A, eta_min, eta_max, N):\n    \"\"\"\n    Calculates the diagnostic for a given set of cosmological parameters.\n\n    The function follows the derivation steps outlined in the problem:\n    1. Define the time grid and constant potential.\n    2. Compute the synchronous gauge perturbations h' and eta_s.\n    3. Compute the gauge generator alpha, requiring a numerical derivative of eta_s.\n    4. Compute the Bardeen potentials, requiring a numerical derivative of alpha.\n    5. Calculate the maximum absolute difference between the computed potentials\n       and the expected constant value.\n\n    Args:\n        k (float): Comoving wavenumber.\n        A (float): Amplitude of the density contrast.\n        eta_min (float): Minimum conformal time.\n        eta_max (float): Maximum conformal time.\n        N (int): Number of time steps.\n\n    Returns:\n        float: The computed diagnostic value.\n    \"\"\"\n    # 1. Create a linearly spaced array for conformal time eta.\n    eta = np.linspace(eta_min, eta_max, N)\n\n    # The expected constant value for the Bardeen potentials.\n    Phi_const = 6.0 * A / k**2\n\n    # 2. Analytically determine the synchronous gauge perturbation quantities.\n    # h'(eta) = -4 * A * eta\n    h_prime = -4.0 * A * eta\n\n    # eta_s is constant for the growing mode: eta_s = 2 * A / k^2\n    eta_s_val = 2.0 * A / k**2\n    eta_s = np.full_like(eta, eta_s_val)\n\n    # 3. Compute the gauge generator alpha(eta). This requires eta_s'(eta).\n    # We compute eta_s' by numerically differentiating the eta_s array.\n    # For a constant array, the result should be numerically zero.\n    eta_s_prime = np.gradient(eta_s, eta)\n    alpha = (h_prime + 6.0 * eta_s_prime) / (2.0 * k**2)\n\n    # 4. Compute the Bardeen potentials. This requires alpha'(eta) and H(eta).\n    # Conformal Hubble rate: H(eta) = 2 / eta\n    H_conformal = 2.0 / eta\n\n    # Compute alpha' by numerically differentiating the alpha array.\n    # a(eta) is linear, so the derivative should be a numerically constant array.\n    alpha_prime = np.gradient(alpha, eta)\n\n    # Gauge-invariant Bardeen potentials from their definitions.\n    Phi_B = eta_s - H_conformal * alpha\n    Psi_B = -alpha_prime - H_conformal * alpha\n\n    # 5. Compute the differences to be checked for the diagnostic.\n    diff_Phi_Psi = np.abs(Phi_B - Psi_B)\n    diff_Phi_const = np.abs(Phi_B - Phi_const)\n    diff_Psi_const = np.abs(Psi_B - Phi_const)\n\n    # 6. The diagnostic is the maximum of all computed differences over the time interval.\n    max_diff = np.max([np.max(diff_Phi_Psi), np.max(diff_Phi_const), np.max(diff_Psi_const)])\n    \n    return max_diff\n\ndef solve():\n    \"\"\"\n    Main function to run the test cases and print the results.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (0.01, 1e-6, 0.1, 10.0, 100),\n        (2.0, 1e-6, 0.1, 10.0, 100),\n        (50.0, 1e-6, 0.1, 10.0, 100),\n        (1.0, 5e-7, 1e-3, 1e-2, 50),\n    ]\n\n    results = []\n    for case in test_cases:\n        k, A, eta_min, eta_max, N = case\n        diagnostic = calculate_diagnostic(k, A, eta_min, eta_max, N)\n        results.append(diagnostic)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}