{
    "hands_on_practices": [
        {
            "introduction": "This practice bridges the gap between theoretical definitions and computational cosmology. You will implement a numerical routine to calculate the Thomson optical depth $\\tau(z)$ and the visibility function $g(z)$ from first principles for a standard $\\Lambda$CDM universe. By locating the peaks of both $d\\tau/dz$ and $g(z)$, this exercise  sharpens your understanding of the last scattering surface and the physical factors that shape it.",
            "id": "3483730",
            "problem": "You are given a spatially flat Lambda Cold Dark Matter (ΛCDM) cosmology and a smooth model for the free-electron fraction as a function of redshift, denoted by $x_e(z)$. Your task is to construct, from first principles, a numerical method to compute the line-of-sight Thomson optical depth to redshift $z$, denoted by $\\tau(z)$, using the fundamental definitions of radiative transfer in an expanding universe. You will then determine the location $z_\\star$ where the derivative $d\\tau/dz$ attains its maximum within a specified redshift interval, and compare it to the location of the peak of the visibility function, which you must define in terms of $\\tau(z)$ and $d\\tau/dz$.\n\nStart from the following physical bases:\n- The differential optical depth is defined as $d\\tau = n_e \\sigma_T c \\, dt$, where $n_e$ is the free-electron number density, $\\sigma_T$ is the Thomson cross section, and $c$ is the speed of light.\n- The redshift-time relation in an expanding universe is $dt/dz = -\\big[(1+z) H(z)\\big]^{-1}$, where $H(z)$ is the Hubble expansion rate.\n- The Hubble expansion rate in a flat $\\Lambda$ Cold Dark Matter (ΛCDM) cosmology is given by $H(z) = H_0 \\sqrt{\\Omega_r (1+z)^4 + \\Omega_m (1+z)^3 + \\Omega_\\Lambda}$, where $H_0$ is the Hubble constant today, $\\Omega_r$ is the present-day radiation density parameter, $\\Omega_m$ is the present-day matter density parameter, and $\\Omega_\\Lambda$ is the present-day cosmological constant density parameter. Assume spatial flatness so that $\\Omega_r + \\Omega_m + \\Omega_\\Lambda = 1$ need not be enforced numerically in your implementation but is physically the case.\n- The present-day critical density is $\\rho_{c,0} = 3 H_0^2 / (8 \\pi G)$, and the present-day baryon mass density is $\\rho_{b,0} = \\Omega_b \\rho_{c,0}$, where $\\Omega_b$ is the present-day baryon density parameter and $G$ is the gravitational constant.\n- Denote the primordial helium mass fraction by $Y_p$. The hydrogen mass fraction is $X_p = 1 - Y_p$. Assume that helium does not contribute free electrons in the recombination window for this problem, so that $n_e(z) = x_e(z) \\, n_H(z)$ with $n_H(z) = X_p \\rho_b(z) / m_p$ and $\\rho_b(z) = \\rho_{b,0} (1+z)^3$, where $m_p$ is the proton mass.\n\nThe free-electron fraction $x_e(z)$ is modeled as a smooth transition between a fully ionized plasma at high redshift and a small residual ionization at low redshift using a hyperbolic tangent profile centered on a recombination redshift $z_\\mathrm{rec}$ with width $\\Delta_z$ and residual ionization $x_\\mathrm{res}$:\n$$\nx_e(z) = x_\\mathrm{res} + \\frac{1 - x_\\mathrm{res}}{2} \\left[ 1 + \\tanh\\left( \\frac{z - z_\\mathrm{rec}}{\\Delta_z} \\right) \\right].\n$$\n\nDefine the visibility function in redshift space for this problem as\n$$\ng(z) = e^{-\\tau(z)} \\, \\frac{d\\tau}{dz},\n$$\nand interpret the location of its maximum, $z_g$, as the redshift of the last scattering surface.\n\nImplementation requirements:\n- Work entirely in the International System of Units (SI) internally for physical constants. Redshift is dimensionless and must be reported as such.\n- Construct a uniform redshift grid $z_i$ for $i=0,\\dots,N$ spanning $z \\in [0, z_{\\max}]$ for each test case. Compute $\\tau(z)$ on this grid by numerically integrating $d\\tau/dz$ from $z=0$ using a stable cumulative trapezoidal rule. Then compute $g(z)$ on the grid, and locate the maxima of $d\\tau/dz$ and $g(z)$ on the closed interval $[0, z_{\\max}]$ using a simple argmax over the grid values.\n- Report, for each test case, two floating-point redshifts: $z_\\star$ (the location where $d\\tau/dz$ attains its maximum on $[0, z_{\\max}]$) and $z_g$ (the location where $g(z)$ attains its maximum on $[0, z_{\\max}]$). Round each reported redshift to one decimal place. Redshift is dimensionless; no physical unit should be printed.\n\nPhysical constants to use (SI values):\n- $c = 299{,}792{,}458$ meters per second.\n- $\\sigma_T = 6.652\\,458\\,7321 \\times 10^{-29}$ square meters.\n- $G = 6.674\\,30 \\times 10^{-11}$ cubic meters per kilogram per square second.\n- $m_p = 1.672\\,621\\,923\\,69 \\times 10^{-27}$ kilograms.\n- $1$ megaparsec $= 3.085\\,677\\,581 \\times 10^{22}$ meters.\n\nTest suite:\nImplement your program to run the following three test cases. For each case, build the grid size $N$ and upper limit $z_{\\max}$ as specified, and compute the requested outputs.\n\n- Case A (happy path):\n  - $H_0 = 67.66$ kilometers per second per megaparsec.\n  - $\\Omega_m = 0.3111$.\n  - $\\Omega_b = 0.0490$.\n  - $\\Omega_r = 9.236 \\times 10^{-5}$.\n  - $\\Omega_\\Lambda = 0.6888064$.\n  - $Y_p = 0.24$.\n  - $z_\\mathrm{rec} = 1090$.\n  - $\\Delta_z = 80$.\n  - $x_\\mathrm{res} = 2 \\times 10^{-4}$.\n  - $z_{\\max} = 1800$.\n  - $N = 20000$.\n\n- Case B (narrow recombination width):\n  - $H_0 = 70.0$ kilometers per second per megaparsec.\n  - $\\Omega_m = 0.3000$.\n  - $\\Omega_b = 0.0480$.\n  - $\\Omega_r = 9.000 \\times 10^{-5}$.\n  - $\\Omega_\\Lambda = 0.69991$.\n  - $Y_p = 0.24$.\n  - $z_\\mathrm{rec} = 1080$.\n  - $\\Delta_z = 15$.\n  - $x_\\mathrm{res} = 1 \\times 10^{-4}$.\n  - $z_{\\max} = 1600$.\n  - $N = 30000$.\n\n- Case C (lower baryon fraction, different expansion):\n  - $H_0 = 73.0$ kilometers per second per megaparsec.\n  - $\\Omega_m = 0.2700$.\n  - $\\Omega_b = 0.0300$.\n  - $\\Omega_r = 9.000 \\times 10^{-5}$.\n  - $\\Omega_\\Lambda = 0.72991$.\n  - $Y_p = 0.24$.\n  - $z_\\mathrm{rec} = 1050$.\n  - $\\Delta_z = 50$.\n  - $x_\\mathrm{res} = 5 \\times 10^{-4}$.\n  - $z_{\\max} = 1700$.\n  - $N = 20000$.\n\nAnswer specification:\n- For each test case, output a list containing $z_\\star$ and $z_g$, both rounded to one decimal place.\n- Your program should produce a single line of output containing the results as a comma-separated list of the three test-case lists, enclosed in square brackets. For example, the output format must be of the form\n  \"[[zstar_A,zg_A],[zstar_B,zg_B],[zstar_C,zg_C]]\"\nwith the actual numerical values substituted. Redshifts are dimensionless and must be printed without any unit.",
            "solution": "The problem requires the numerical computation of the Thomson scattering optical depth, $\\tau(z)$, and the associated visibility function, $g(z)$, within a flat $\\Lambda$CDM cosmological model. The goal is to determine the redshifts $z_\\star$ and $z_g$ corresponding to the maxima of the derivative of the optical depth, $d\\tau/dz$, and the visibility function, respectively. This will be performed for three distinct sets of cosmological parameters.\n\n### Step 1: Theoretical Formulation\n\nThe fundamental quantity is the differential optical depth, $d\\tau$, experienced by a photon traveling a path length $dl$:\n$$d\\tau = n_e \\sigma_T dl$$\nwhere $n_e$ is the number density of free electrons and $\\sigma_T$ is the Thomson scattering cross-section. For a photon traveling along the line of sight in an expanding universe, the path length element $dl$ is related to the time interval $dt$ by $dl = c \\, dt$. Therefore,\n$$d\\tau = n_e \\sigma_T c \\, dt$$\nIn cosmology, it is more convenient to work with redshift $z$ as the independent variable. The relationship between the differential time interval $dt$ and the differential redshift interval $dz$ is given by:\n$$\\frac{dt}{dz} = -\\frac{1}{(1+z)H(z)}$$\nwhere $H(z)$ is the Hubble expansion rate at redshift $z$. The negative sign indicates that time increases as redshift decreases.\n\nThe total optical depth to a redshift $z$ is the integral of $d\\tau$ from the present day (time $t_0$, redshift $z=0$) to the earlier time $t(z)$ corresponding to that redshift:\n$$\\tau(z) = \\int_{t(z)}^{t_0} n_e(t') \\sigma_T c \\, dt'$$\nBy changing the integration variable from $t'$ to $z'$, we get:\n$$\\tau(z) = \\int_{z}^{0} n_e(z') \\sigma_T c \\left( \\frac{dt}{dz'} \\right) dz' = \\int_{z}^{0} n_e(z') \\sigma_T c \\left( -\\frac{1}{(1+z')H(z')} \\right) dz'$$\nReversing the limits of integration to eliminate the negative sign, we obtain the expression for $\\tau(z)$ as an integral from $z'=0$ to $z'=z$:\n$$\\tau(z) = \\int_{0}^{z} \\frac{n_e(z') \\sigma_T c}{(1+z')H(z')} dz'$$\nFrom this integral form, we can identify the derivative of the optical depth with respect to redshift:\n$$\\frac{d\\tau}{dz} = \\frac{n_e(z) \\sigma_T c}{(1+z)H(z)}$$\n\n### Step 2: Derivation of Quantities in the $\\Lambda$CDM Model\n\nTo evaluate $d\\tau/dz$, we need explicit expressions for $n_e(z)$ and $H(z)$ in the specified cosmological model.\n\nThe Hubble rate in a spatially flat $\\Lambda$CDM universe is:\n$$H(z) = H_0 \\sqrt{\\Omega_r (1+z)^4 + \\Omega_m (1+z)^3 + \\Omega_\\Lambda}$$\nwhere $H_0$ is the Hubble constant, and $\\Omega_r$, $\\Omega_m$, and $\\Omega_\\Lambda$ are the present-day density parameters for radiation, matter, and the cosmological constant, respectively. We can write $H(z) = H_0 E(z)$, where $E(z)$ is the dimensionless evolution function under the square root.\n\nThe free-electron number density $n_e(z)$ is given as a product of the free-electron fraction $x_e(z)$ and the hydrogen number density $n_H(z)$, assuming helium does not contribute significantly to the free electron population during the epoch of hydrogen recombination.\n$$n_e(z) = x_e(z) n_H(z)$$\nThe hydrogen number density $n_H(z)$ is related to the baryon mass density $\\rho_b(z)$. Given a primordial helium mass fraction $Y_p$, the hydrogen mass fraction is $X_p = 1 - Y_p$.\n$$n_H(z) = \\frac{X_p \\rho_b(z)}{m_p}$$\nwhere $m_p$ is the proton mass. The baryon density scales with redshift as $\\rho_b(z) = \\rho_{b,0}(1+z)^3$, where $\\rho_{b,0}$ is the present-day baryon density. This, in turn, is related to the present-day critical density $\\rho_{c,0}$ and the baryon density parameter $\\Omega_b$:\n$$\\rho_{b,0} = \\Omega_b \\rho_{c,0} = \\Omega_b \\frac{3 H_0^2}{8 \\pi G}$$\nwhere $G$ is Newton's gravitational constant.\n\nCombining these expressions for $n_e(z)$:\n$$n_e(z) = x_e(z) \\frac{(1-Y_p)}{m_p} \\left(\\Omega_b \\frac{3 H_0^2}{8 \\pi G}\\right) (1+z)^3$$\nSubstituting $n_e(z)$ and $H(z)$ into the equation for $d\\tau/dz$:\n$$\\frac{d\\tau}{dz} = \\frac{x_e(z) \\left[ \\frac{(1-Y_p)\\Omega_b}{m_p} \\frac{3 H_0^2}{8 \\pi G} (1+z)^3 \\right] \\sigma_T c}{(1+z)H_0 E(z)}$$\nSimplifying this expression by collecting constants gives:\n$$\\frac{d\\tau}{dz} = \\left[ \\frac{3 H_0 \\sigma_T c (1-Y_p) \\Omega_b}{8 \\pi G m_p} \\right] x_e(z) \\frac{(1+z)^2}{E(z)}$$\nThe term in square brackets is a constant for a given cosmology, which we can pre-calculate to simplify the numerical computation. Let us denote this constant by $\\mathcal{C}$. The free-electron fraction $x_e(z)$ is given by the specified hyperbolic tangent model.\n\n### Step 3: Visibility Function and Peak Locations\n\nThe visibility function $g(z)$ is defined as:\n$$g(z) = e^{-\\tau(z)} \\frac{d\\tau}{dz}$$\nThis function can be interpreted as the probability density function for the redshift of last scattering. That is, $g(z)dz$ is the probability that a CMB photon observed today last scattered between redshift $z$ and $z+dz$. The peak of this function, $z_g$, is therefore a crucial observable, representing the most probable redshift of the last scattering surface.\n\nWe are asked to find the redshifts $z_\\star$ and $z_g$ which maximize $d\\tau/dz$ and $g(z)$, respectively.\n- $z_\\star$ is the redshift where the interaction rate per unit redshift is maximal.\n- $z_g$ is the redshift where the probability of last scattering is maximal.\n\nTo find the maximum of $g(z)$, we set its derivative to zero. Let $f(z) = d\\tau/dz$. Then $g(z) = f(z)e^{-\\tau(z)}$.\n$$g'(z) = f'(z)e^{-\\tau(z)} - f(z)\\tau'(z)e^{-\\tau(z)} = e^{-\\tau(z)}[f'(z) - (f(z))^2] = 0$$\nThis implies $f'(z_g) = (f(z_g))^2$.\nThe peak of $f(z) = d\\tau/dz$ occurs at $z_\\star$, where $f'(z_\\star) = 0$. At this redshift, the derivative of the visibility function is $g'(z_\\star) = -e^{-\\tau(z_\\star)}(f(z_\\star))^2 < 0$. Since the derivative of $g(z)$ is negative at $z=z_\\star$, it means $g(z)$ is a decreasing function at that point. Consequently, the peak of the visibility function must occur at a lower redshift, i.e., $z_g < z_\\star$. The factor $e^{-\\tau(z)}$, which represents the probability of a photon reaching the observer without further scattering, is a monotonically decreasing function of $z$ and thus shifts the peak of the product $g(z)$ to lower redshifts compared to the peak of $d\\tau/dz$.\n\n### Step 4: Numerical Algorithm\n\nThe problem is solved numerically following these steps for each test case:\n1.  **Setup and Unit Conversion**: All physical constants ($c, \\sigma_T, G, m_p$) are defined in SI units. The Hubble constant $H_0$, given in km s$^{-1}$ Mpc$^{-1}$, is converted to s$^{-1}$ using the provided conversion factor for megaparsecs to meters.\n2.  **Redshift Grid**: A uniform redshift grid $z_i$ is created from $z=0$ to $z=z_{\\max}$ with $N+1$ points.\n3.  **Compute $d\\tau/dz$**: The constant factor $\\mathcal{C}$ is calculated. Then, for each point $z_i$ on the grid, the functions $E(z_i)$ and $x_e(z_i)$ are evaluated, and the array for $d\\tau/dz$ is computed using the derived formula.\n4.  **Compute $\\tau(z)$**: The optical depth $\\tau(z_i)$ is computed by numerically integrating the $d\\tau/dz$ array from $z=0$ up to each $z_i$. The `scipy.integrate.cumulative_trapezoid` function is well-suited for this, as it efficiently implements the cumulative trapezoidal rule. We ensure $\\tau(0)=0$.\n5.  **Compute $g(z)$**: Using the computed arrays for $\\tau(z)$ and $d\\tau/dz$, the visibility function $g(z_i)$ is evaluated at each grid point.\n6.  **Find Maxima**: The `numpy.argmax` function is used to find the indices of the maximum values in the $d\\tau/dz$ and $g(z)$ arrays. These indices correspond to the grid locations of $z_\\star$ and $z_g$.\n7.  **Report Results**: The resulting redshift values $z_\\star$ and $z_g$ are rounded to one decimal place and stored. The final output is formatted as a list of lists.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.integrate import cumulative_trapezoid\n\ndef solve():\n    \"\"\"\n    Computes the redshifts of maximum interaction rate (z_star) and maximum\n    visibility (z_g) for given cosmological models.\n    \"\"\"\n    # Physical constants in SI units\n    C_LIGHT = 299792458.0          # Speed of light (m/s)\n    SIGMA_T = 6.6524587321e-29     # Thomson cross-section (m^2)\n    G_NEWTON = 6.67430e-11         # Gravitational constant (m^3 kg^-1 s^-2)\n    M_P = 1.67262192369e-27        # Proton mass (kg)\n    MPC_TO_M = 3.085677581e22      # Megaparsec to meters conversion\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"H0_km_s_Mpc\": 67.66, \"Omega_m\": 0.3111, \"Omega_b\": 0.0490,\n            \"Omega_r\": 9.236e-5, \"Omega_L\": 0.6888064, \"Yp\": 0.24,\n            \"z_rec\": 1090.0, \"Delta_z\": 80.0, \"x_res\": 2e-4,\n            \"z_max\": 1800, \"N\": 20000\n        },\n        {\n            \"H0_km_s_Mpc\": 70.0, \"Omega_m\": 0.3000, \"Omega_b\": 0.0480,\n            \"Omega_r\": 9.000e-5, \"Omega_L\": 0.69991, \"Yp\": 0.24,\n            \"z_rec\": 1080.0, \"Delta_z\": 15.0, \"x_res\": 1e-4,\n            \"z_max\": 1600, \"N\": 30000\n        },\n        {\n            \"H0_km_s_Mpc\": 73.0, \"Omega_m\": 0.2700, \"Omega_b\": 0.0300,\n            \"Omega_r\": 9.000e-5, \"Omega_L\": 0.72991, \"Yp\": 0.24,\n            \"z_rec\": 1050.0, \"Delta_z\": 50.0, \"x_res\": 5e-4,\n            \"z_max\": 1700, \"N\": 20000\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        # Convert H0 to SI units (s^-1)\n        H0_si = case[\"H0_km_s_Mpc\"] * 1000.0 / MPC_TO_M\n        \n        # Pre-compute the constant factor for d(tau)/dz\n        # C = (3 * H0 * sigma_T * c * (1 - Yp) * Omega_b) / (8 * pi * G * m_p)\n        prefactor = (3 * H0_si * SIGMA_T * C_LIGHT * (1 - case[\"Yp\"]) * case[\"Omega_b\"]) / \\\n                    (8 * np.pi * G_NEWTON * M_P)\n\n        # Create a uniform redshift grid\n        z_grid = np.linspace(0, case[\"z_max\"], case[\"N\"] + 1)\n        one_plus_z = 1 + z_grid\n        \n        # Dimensionless Hubble parameter evolution E(z) = H(z)/H0\n        E_z = np.sqrt(case[\"Omega_r\"] * one_plus_z**4 + \n                      case[\"Omega_m\"] * one_plus_z**3 + \n                      case[\"Omega_L\"])\n        \n        # Free-electron fraction x_e(z) using the tanh model\n        x_e_z = case[\"x_res\"] + (1 - case[\"x_res\"]) / 2.0 * \\\n              (1 + np.tanh((z_grid - case[\"z_rec\"]) / case[\"Delta_z\"]))\n        \n        # Differential optical depth d(tau)/dz\n        dtau_dz = prefactor * x_e_z * (one_plus_z**2) / E_z\n        \n        # Total optical depth tau(z) by cumulative trapezoidal integration\n        # tau(z) is the integral of d(tau)/dz' from z'=0 to z.\n        # cumulative_trapezoid with initial=0 gives an array of the same size as input.\n        tau_z = cumulative_trapezoid(dtau_dz, z_grid, initial=0)\n        \n        # Visibility function g(z) = exp(-tau(z)) * d(tau)/dz\n        g_z = np.exp(-tau_z) * dtau_dz\n        \n        # Find redshift of maximum d(tau)/dz\n        idx_star = np.argmax(dtau_dz)\n        z_star = z_grid[idx_star]\n        \n        # Find redshift of maximum g(z)\n        idx_g = np.argmax(g_z)\n        z_g = z_grid[idx_g]\n        \n        # Store the rounded results for this case\n        results.append([round(z_star, 1), round(z_g, 1)])\n\n    # Final print statement in the exact required format.\n    print(f\"{results}\".replace(\" \", \"\"))\n\nsolve()\n```"
        },
        {
            "introduction": "The sharply-peaked nature of the visibility function, which you may have computed numerically, is a cornerstone of CMB physics that enables powerful approximations. This analytical exercise  will guide you through quantifying the accuracy of the instantaneous recombination approximation. By modeling the visibility function as a Gaussian and the source term as an oscillation, you will derive the exact error and understand the conditions under which this crucial simplification is valid.",
            "id": "3483675",
            "problem": "Consider the line-of-sight formulation for Cosmic Microwave Background (CMB) anisotropies in conformal time $\\eta$, in which a source term $s(\\eta)$ is weighted by the photon visibility function $g(\\eta)$ and integrated over $\\eta$ to give the observed contribution $I \\equiv \\int_{-\\infty}^{\\infty} g(\\eta)\\,s(\\eta)\\,d\\eta$. The visibility function $g(\\eta)$ is nonnegative, sharply peaked at the recombination time $\\eta_{\\star}$, and normalized so that $\\int_{-\\infty}^{\\infty} g(\\eta)\\,d\\eta = 1$. In the instantaneous recombination approximation, one assumes $g(\\eta)$ is infinitely narrow about $\\eta_{\\star}$, effectively $g(\\eta)\\to \\delta(\\eta-\\eta_{\\star})$, so that the integral is replaced by $I_{\\mathrm{IA}} \\equiv s(\\eta_{\\star})$.\n\nTo quantify how the narrowness of $g(\\eta)$ justifies the instantaneous recombination approximation and to estimate the resulting error, adopt the following controlled, physically motivated model:\n- Model the visibility function as a normalized Gaussian,\n$$\ng(\\eta) \\equiv \\frac{1}{\\sqrt{2\\pi}\\,\\sigma}\\,\\exp\\!\\left[-\\frac{(\\eta-\\eta_{\\star})^{2}}{2\\sigma^{2}}\\right],\n$$\nwith width parameter $\\sigma \\ll \\eta_{\\star}$.\n- Model the local time dependence of the source term near last scattering by a smooth oscillatory form,\n$$\ns(\\eta) \\equiv \\cos\\!\\big(\\omega\\,(\\eta-\\eta_{\\star})\\big),\n$$\nwhich captures the acoustic oscillation behavior with angular frequency $\\omega$.\n\nTasks:\n1. Starting from the central-moment expansion of a smooth function against a narrow, normalized kernel, derive the first nontrivial correction to $I$ in powers of $\\sigma$ and state the condition on $\\sigma$ and $\\omega$ under which $I \\approx I_{\\mathrm{IA}}$ is accurate.\n2. Compute the exact integral $I_{\\mathrm{exact}} \\equiv \\int_{-\\infty}^{\\infty} g(\\eta)\\,s(\\eta)\\,d\\eta$ for the given $g(\\eta)$ and $s(\\eta)$.\n3. Define the fractional error of the instantaneous recombination approximation relative to the exact integral by\n$$\nE(\\omega,\\sigma) \\equiv \\frac{I_{\\mathrm{IA}} - I_{\\mathrm{exact}}}{I_{\\mathrm{IA}}}.\n$$\nDerive a single closed-form analytic expression for $E(\\omega,\\sigma)$.\n\nYour final answer must be a single closed-form analytic expression for $E(\\omega,\\sigma)$ with no units. If you choose to present any intermediate numerical estimates, do not include them in the final answer. If you present a numerical approximation for illustration, round it to four significant figures and clearly identify it as an illustration only, not the final answer.",
            "solution": "The problem statement is first validated against the criteria of scientific soundness, well-posedness, and objectivity.\n\n### Step 1: Extract Givens\n- The observed contribution to CMB anisotropies is given by the integral $I \\equiv \\int_{-\\infty}^{\\infty} g(\\eta)\\,s(\\eta)\\,d\\eta$.\n- The visibility function $g(\\eta)$ is nonnegative, sharply peaked at $\\eta_{\\star}$, and normalized such that $\\int_{-\\infty}^{\\infty} g(\\eta)\\,d\\eta = 1$.\n- The instantaneous recombination approximation (IA) is defined by replacing $g(\\eta)$ with a Dirac delta function, $g(\\eta) \\to \\delta(\\eta-\\eta_{\\star})$, yielding $I_{\\mathrm{IA}} \\equiv s(\\eta_{\\star})$.\n- The model for the visibility function is a normalized Gaussian: $g(\\eta) \\equiv \\frac{1}{\\sqrt{2\\pi}\\,\\sigma}\\,\\exp\\!\\left[-\\frac{(\\eta-\\eta_{\\star})^{2}}{2\\sigma^{2}}\\right]$, with width $\\sigma \\ll \\eta_{\\star}$.\n- The model for the source term is a smooth oscillatory function: $s(\\eta) \\equiv \\cos\\!\\big(\\omega\\,(\\eta-\\eta_{\\star})\\big)$.\n- The exact integral is denoted $I_{\\mathrm{exact}} \\equiv \\int_{-\\infty}^{\\infty} g(\\eta)\\,s(\\eta)\\,d\\eta$.\n- The fractional error is defined as $E(\\omega,\\sigma) \\equiv \\frac{I_{\\mathrm{IA}} - I_{\\mathrm{exact}}}{I_{\\mathrm{IA}}}$.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is a well-structured exercise in theoretical physics, specifically in the context of numerical cosmology.\n- **Scientifically Grounded**: The premise is sound. The line-of-sight integral is the fundamental formalism for computing CMB anisotropies. The visibility function describes the probability density of last scattering, and its finite width is a key physical feature. The instantaneous recombination approximation is a standard, widely used simplification. The use of a Gaussian for the visibility function and a cosine for the source term are physically motivated and common simplifying models for pedagogical and analytical purposes. The problem does not violate any scientific principles.\n- **Well-Posed**: The problem is mathematically well-posed. The functions $g(\\eta)$ and $s(\\eta)$ are well-defined, and the integral $I$ is convergent. The tasks are specified clearly, leading to a unique and meaningful solution.\n- **Objective**: The language is precise and free of subjectivity. All terms are defined analytically.\n- **Completeness**: The problem is self-contained and provides all necessary information to perform the requested derivations and calculations.\n\n### Step 3: Verdict and Action\nThe problem is **valid**. The solution process will now proceed.\n\n### Solution Derivation\n\nThe problem is addressed in three parts as requested.\n\n#### 1. First Nontrivial Correction and Accuracy Condition\n\nWe begin with the integral $I = \\int_{-\\infty}^{\\infty} g(\\eta) s(\\eta) d\\eta$. The function $s(\\eta)$ is smooth, and the kernel $g(\\eta)$ is sharply peaked at $\\eta = \\eta_{\\star}$. We can Taylor expand $s(\\eta)$ about $\\eta_{\\star}$:\n$$\ns(\\eta) = s(\\eta_{\\star}) + (\\eta - \\eta_{\\star}) s'(\\eta_{\\star}) + \\frac{1}{2!} (\\eta - \\eta_{\\star})^2 s''(\\eta_{\\star}) + \\mathcal{O}((\\eta - \\eta_{\\star})^3)\n$$\nSubstituting this expansion into the integral for $I$:\n$$\nI = \\int_{-\\infty}^{\\infty} g(\\eta) \\left[ s(\\eta_{\\star}) + (\\eta - \\eta_{\\star}) s'(\\eta_{\\star}) + \\frac{1}{2} (\\eta - \\eta_{\\star})^2 s''(\\eta_{\\star}) + \\dots \\right] d\\eta\n$$\nBy linearity of integration, we can write this as a sum of moments of the distribution $g(\\eta)$:\n$$\nI = s(\\eta_{\\star}) \\int_{-\\infty}^{\\infty} g(\\eta) d\\eta + s'(\\eta_{\\star}) \\int_{-\\infty}^{\\infty} (\\eta - \\eta_{\\star}) g(\\eta) d\\eta + \\frac{1}{2} s''(\\eta_{\\star}) \\int_{-\\infty}^{\\infty} (\\eta - \\eta_{\\star})^2 g(\\eta) d\\eta + \\dots\n$$\nThe integrals correspond to the moments of $g(\\eta)$ about its mean $\\eta_{\\star}$.\n- The zeroth moment is the normalization of the probability density: $\\int_{-\\infty}^{\\infty} g(\\eta) d\\eta = 1$.\n- The first central moment is the mean deviation, which is zero for a symmetric distribution centered at $\\eta_{\\star}$: $\\int_{-\\infty}^{\\infty} (\\eta - \\eta_{\\star}) g(\\eta) d\\eta = 0$.\n- The second central moment is the variance, which for the given Gaussian model is $\\sigma^2$: $\\int_{-\\infty}^{\\infty} (\\eta - \\eta_{\\star})^2 g(\\eta) d\\eta = \\sigma^2$.\n\nSubstituting these moment values, the expansion for $I$ becomes:\n$$\nI = s(\\eta_{\\star}) + \\frac{\\sigma^2}{2} s''(\\eta_{\\star}) + \\mathcal{O}(\\sigma^4)\n$$\nThe instantaneous recombination approximation is $I_{\\mathrm{IA}} = s(\\eta_{\\star})$. The first nontrivial correction to this approximation is the term of order $\\sigma^2$, which is $\\frac{\\sigma^2}{2} s''(\\eta_{\\star})$.\n\nFor the given source term $s(\\eta) = \\cos(\\omega(\\eta - \\eta_{\\star}))$, we compute its derivatives at $\\eta_{\\star}$:\n- $s(\\eta_{\\star}) = \\cos(0) = 1$.\n- $s'(\\eta) = -\\omega \\sin(\\omega(\\eta - \\eta_{\\star})) \\implies s'(\\eta_{\\star}) = 0$.\n- $s''(\\eta) = -\\omega^2 \\cos(\\omega(\\eta - \\eta_{\\star})) \\implies s''(\\eta_{\\star}) = -\\omega^2$.\n\nThus, the approximation for $I$ is:\n$$\nI \\approx 1 - \\frac{\\omega^2 \\sigma^2}{2}\n$$\nThe approximation $I \\approx I_{\\mathrm{IA}} = 1$ is accurate when the magnitude of the correction term is much smaller than the leading term. This gives the condition:\n$$\n\\left| -\\frac{\\omega^2 \\sigma^2}{2} \\right| \\ll 1 \\implies \\frac{\\omega^2 \\sigma^2}{2} \\ll 1\n$$\nThis is equivalent to $\\omega \\sigma \\ll \\sqrt{2}$, or more generally stated as a condition on the scales, $\\omega \\sigma \\ll 1$. This means the oscillation period of the source ($2\\pi/\\omega$) is much larger than the duration of recombination ($\\sim \\sigma$).\n\n#### 2. Exact Integral Calculation\n\nWe compute the exact integral $I_{\\mathrm{exact}}$:\n$$\nI_{\\mathrm{exact}} = \\int_{-\\infty}^{\\infty} g(\\eta) s(\\eta) d\\eta = \\int_{-\\infty}^{\\infty} \\frac{1}{\\sqrt{2\\pi}\\,\\sigma} \\exp\\left[-\\frac{(\\eta-\\eta_{\\star})^{2}}{2\\sigma^{2}}\\right] \\cos(\\omega(\\eta-\\eta_{\\star})) d\\eta\n$$\nLet's introduce the substitution $x = \\eta - \\eta_{\\star}$, so $dx = d\\eta$. The integration limits remain $(-\\infty, \\infty)$:\n$$\nI_{\\mathrm{exact}} = \\frac{1}{\\sqrt{2\\pi}\\,\\sigma} \\int_{-\\infty}^{\\infty} \\exp\\left[-\\frac{x^2}{2\\sigma^2}\\right] \\cos(\\omega x) dx\n$$\nThis integral can be solved by recognizing that $\\cos(\\omega x) = \\Re\\{\\exp(i\\omega x)\\}$. The integral is the real part of the Fourier transform of a Gaussian function.\n$$\nI_{\\mathrm{exact}} = \\frac{1}{\\sqrt{2\\pi}\\,\\sigma} \\Re\\left\\{ \\int_{-\\infty}^{\\infty} \\exp\\left[-\\frac{x^2}{2\\sigma^2}\\right] \\exp(i\\omega x) dx \\right\\}\n$$\nThe inner integral is of the form $\\int_{-\\infty}^{\\infty} \\exp(-ax^2 + bx) dx$ with $a = 1/(2\\sigma^2)$ and $b = i\\omega$. This standard Gaussian integral evaluates to $\\sqrt{\\pi/a} \\exp(b^2/(4a))$.\n- $a = \\frac{1}{2\\sigma^2}$\n- $b^2/(4a) = (i\\omega)^2 / (4 \\cdot \\frac{1}{2\\sigma^2}) = -\\omega^2 / (\\frac{2}{\\sigma^2}) = -\\frac{\\omega^2\\sigma^2}{2}$.\n- $\\sqrt{\\pi/a} = \\sqrt{\\pi \\cdot 2\\sigma^2} = \\sqrt{2\\pi}\\sigma$.\n\nSo the complex integral is:\n$$\n\\int_{-\\infty}^{\\infty} \\exp\\left[-\\frac{x^2}{2\\sigma^2}\\right] \\exp(i\\omega x) dx = \\sqrt{2\\pi}\\sigma \\exp\\left(-\\frac{\\omega^2\\sigma^2}{2}\\right)\n$$\nSubstituting this back into the expression for $I_{\\mathrm{exact}}$:\n$$\nI_{\\mathrm{exact}} = \\frac{1}{\\sqrt{2\\pi}\\,\\sigma} \\Re\\left\\{ \\sqrt{2\\pi}\\sigma \\exp\\left(-\\frac{\\omega^2\\sigma^2}{2}\\right) \\right\\}\n$$\nSince the expression inside the real part operator is already real, we get:\n$$\nI_{\\mathrm{exact}} = \\exp\\left(-\\frac{\\omega^2\\sigma^2}{2}\\right)\n$$\n\nAlternatively, the integral represents the value of the characteristic function of a normal distribution with mean $0$ and variance $\\sigma^2$ evaluated at $\\omega$. The characteristic function $\\phi_X(t) = \\mathbb{E}[\\exp(itX)] = \\exp(i\\mu t - \\frac{1}{2}\\sigma^2 t^2)$. For $\\mu=0$, $\\phi_X(t) = \\exp(-\\frac{1}{2}\\sigma^2 t^2)$. The integral $\\int P(x)\\cos(\\omega x) dx = \\Re\\{\\mathbb{E}[\\exp(i\\omega X)]\\} = \\Re\\{\\phi_X(\\omega)\\} = \\exp(-\\frac{1}{2}\\sigma^2 \\omega^2)$.\n\n#### 3. Fractional Error Calculation\n\nThe fractional error is defined as $E(\\omega,\\sigma) = \\frac{I_{\\mathrm{IA}} - I_{\\mathrm{exact}}}{I_{\\mathrm{IA}}}$.\nWe have the necessary components:\n- $I_{\\mathrm{IA}} = s(\\eta_{\\star}) = \\cos(\\omega(\\eta_{\\star}-\\eta_{\\star})) = \\cos(0) = 1$.\n- $I_{\\mathrm{exact}} = \\exp\\left(-\\frac{\\omega^2\\sigma^2}{2}\\right)$.\n\nSubstituting these into the definition of the error:\n$$\nE(\\omega,\\sigma) = \\frac{1 - \\exp\\left(-\\frac{\\omega^2\\sigma^2}{2}\\right)}{1}\n$$\nThis simplifies to the final closed-form analytic expression for the fractional error:\n$$\nE(\\omega,\\sigma) = 1 - \\exp\\left(-\\frac{\\omega^2\\sigma^2}{2}\\right)\n$$\nAs a consistency check, we can expand this for small $\\omega\\sigma$. Using the Taylor series $\\exp(-x) \\approx 1 - x + x^2/2 - \\dots$ with $x = \\omega^2\\sigma^2/2$:\n$$\nE(\\omega,\\sigma) \\approx 1 - \\left(1 - \\frac{\\omega^2\\sigma^2}{2}\\right) = \\frac{\\omega^2\\sigma^2}{2}\n$$\nThis matches the relative error derived from the first-order correction in Part 1, $\\frac{I_{\\mathrm{IA}} - I}{I_{\\mathrm{IA}}} = \\frac{1 - (1 - \\omega^2\\sigma^2/2)}{1} = \\frac{\\omega^2\\sigma^2}{2}$, confirming the consistency of our results.",
            "answer": "$$\n\\boxed{1 - \\exp\\left(-\\frac{\\omega^2\\sigma^2}{2}\\right)}\n$$"
        },
        {
            "introduction": "Having constructed the visibility function and analyzed its properties, we now connect it to the ultimate goal of constraining cosmological parameters. This exercise  challenges you to compute a key ingredient of the Fisher matrix, the derivative of the angular power spectrum $\\partial C_{\\ell}/\\partial p$, using a simplified but illustrative model. By comparing two different numerical pathways for the derivative, you will not only see how recombination physics influences our measurement of parameters like $\\Omega_b h^2$ but also gain practical insight into the numerical stability of such calculations.",
            "id": "3483740",
            "problem": "You are asked to implement, test, and assess the numerical stability of a Fisher-element ingredient, namely the parameter derivative $\\,\\partial C_{\\ell}/\\partial p\\,$, evaluated by differentiating the visibility function $\\,g(\\eta;p)\\,$ with respect to a cosmological parameter $\\,p \\in \\{\\Omega_b h^2, Y_p, N_{\\rm eff}\\}\\,$. Work in a simplified yet scientifically plausible line-of-sight toy model for the Cosmic Microwave Background (CMB) temperature anisotropy, where the angular power spectrum multipole $\\,C_{\\ell}\\,$ is modeled as a visibility-weighted projection of a parameter-independent source function.\n\nFundamental base and setup:\n- The line-of-sight solution for CMB temperature anisotropies motivates expressing the angular power spectra as integrals over conformal time $\\,\\eta\\,$ weighted by the visibility function $\\,g(\\eta)\\,$. In the exact theory, the visibility function is $\\,g(\\eta) = \\dot{\\tau}(\\eta) \\exp(-\\tau(\\eta))\\,$, where $\\,\\tau(\\eta)\\,$ is the Thomson optical depth. It satisfies the normalization $\\,\\int g(\\eta)\\,d\\eta = 1\\,$.\n- In this problem, you will use a normalized Gaussian proxy for the visibility function to capture the recombination surface as a sharp, localized feature:\n$$\ng(\\eta;p) \\propto \\exp\\!\\left(-\\frac{(\\eta-\\mu(p))^2}{2\\,\\sigma^2(p)}\\right),\n$$\nnormalized numerically so that $\\,\\int_0^{\\eta_0} g(\\eta;p)\\,d\\eta = 1\\,$. Take $\\,\\eta_0 = 1\\,$ (dimensionless).\n- The mean $\\,\\mu(p)\\,$ and width $\\,\\sigma(p)\\,$ encode parameter dependence in a simplified, physically motivated manner:\n  - Increasing $\\,\\Omega_b h^2\\,$ or $\\,N_{\\rm eff}\\,$ tends to make recombination occur earlier, shifting $\\,\\mu\\,$ to smaller conformal time.\n  - Increasing $\\,Y_p\\,$ reduces free electrons per baryon after helium recombination and is modeled here as narrowing the last-scattering surface.\n- The parameter-independent source term is modeled as\n$$\nS_{\\ell}(\\eta) = \\cos\\!\\big(k\\,(\\eta_0-\\eta)\\big)\\,\\exp\\!\\left(-\\frac{(\\eta_0-\\eta)^2}{2\\,\\eta_d^2}\\right)\\times \\frac{1}{1+(\\ell/\\ell_D)^2},\n$$\nwith fixed constants $\\,k>0\\,$, $\\,\\eta_d>0\\,$, and $\\,\\ell_D>0\\,$. All quantities are treated as dimensionless for this exercise.\n\nTarget quantity and derivative pathways:\n- Define the toy angular power spectrum multipole as\n$$\nC_{\\ell}(p)=\\int_{0}^{\\eta_0} g(\\eta;p)\\,S_{\\ell}(\\eta)\\,d\\eta.\n$$\n- The Fisher-element ingredient (derivative of $\\,C_{\\ell}\\,$ with respect to a parameter $\\,p\\,$) is\n$$\n\\frac{\\partial C_{\\ell}}{\\partial p}=\\int_{0}^{\\eta_0} \\frac{\\partial g(\\eta;p)}{\\partial p}\\,S_{\\ell}(\\eta)\\,d\\eta,\n$$\nwhich follows by differentiating under the integral sign when $\\,S_{\\ell}\\,$ has no $\\,p\\,$-dependence.\n\nYour program must:\n1. Discretize $\\,\\eta\\in[0,\\eta_0]\\,$ on a uniform grid and evaluate all integrals using the trapezoidal rule.\n2. Implement two independent numerical estimators of $\\,\\partial C_{\\ell}/\\partial p\\,$ at a baseline parameter vector $\\,\\theta_0=(\\Omega_b h^2, Y_p, N_{\\rm eff})\\,$:\n   - Path A (through the visibility function): form the central finite-difference approximation to $\\,\\partial g/\\partial p\\,$ pointwise,\n     $$\n     \\left.\\frac{\\partial g}{\\partial p}\\right|_{\\theta_0} \\approx \\frac{g(\\eta;\\theta_0+\\Delta p\\,\\hat{e}_p)-g(\\eta;\\theta_0-\\Delta p\\,\\hat{e}_p)}{2\\,\\Delta p},\n     $$\n     and then integrate $\\,\\int (\\partial g/\\partial p)\\,S_{\\ell}\\,d\\eta\\,$ to get $\\,\\partial C_{\\ell}/\\partial p\\,$.\n   - Path B (direct difference of $\\,C_{\\ell}\\,$): compute\n     $$\n     \\left.\\frac{\\partial C_{\\ell}}{\\partial p}\\right|_{\\theta_0} \\approx \\frac{C_{\\ell}(\\theta_0+\\Delta p\\,\\hat{e}_p)-C_{\\ell}(\\theta_0-\\Delta p\\,\\hat{e}_p)}{2\\,\\Delta p}.\n     $$\n3. For each test case, report the relative discrepancy between the two estimates as a single float,\n$$\n\\mathrm{rel\\_err}=\\frac{\\left|\\left(\\partial C_{\\ell}/\\partial p\\right)_{\\text{Path A}}-\\left(\\partial C_{\\ell}/\\partial p\\right)_{\\text{Path B}}\\right|}{\\max\\!\\left(\\left|\\left(\\partial C_{\\ell}/\\partial p\\right)_{\\text{Path B}}\\right|,\\,10^{-15}\\right)}.\n$$\n\nModel specifications and constants:\n- Work with baseline parameters $\\,p \\in \\{\\Omega_b h^2, Y_p, N_{\\rm eff}\\}\\,$:\n- Work with baseline parameters $\\,\\Omega_b h^2=0.02237\\,, \\,Y_p=0.245\\,, \\,N_{\\rm eff}=3.046\\,$.\n- Use $\\,\\eta_0=1\\,$, and a uniform grid of $\\,4096\\,$ points in $[0,1]$.\n- Define the visibility mean and width as\n$$\n\\mu(p)=\\mu_0 + \\alpha_b \\left(\\Omega_b h^2 - 0.02237\\right) + \\alpha_Y \\left(Y_p - 0.245\\right) + \\alpha_N \\left(N_{\\rm eff} - 3.046\\right),\n$$\n$$\n\\sigma(p)=\\sigma_0\\left[1 + \\beta_b \\frac{\\Omega_b h^2 - 0.02237}{0.02237} + \\beta_Y \\frac{Y_p - 0.245}{0.245} + \\beta_N \\frac{N_{\\rm eff} - 3.046}{3.046}\\right],\n$$\nwith fixed constants $\\,\\mu_0=0.9\\,, \\,\\sigma_0=0.03\\,, \\,\\alpha_b=-0.50\\,, \\,\\alpha_Y=+0.02\\,, \\,\\alpha_N=-0.02\\,, \\,\\beta_b=+0.5\\,, \\,\\beta_Y=-0.3\\,, \\,\\beta_N=+0.2\\,$. Enforce a floor $\\,\\sigma\\ge 0.005\\,$.\n- Define the source with constants $\\,k=120\\,, \\,\\eta_d=0.08\\,,$ and $\\,\\ell_D=1200\\,$:\n$$\nS_{\\ell}(\\eta)=\\cos\\!\\big(120\\,(1-\\eta)\\big)\\,\\exp\\!\\left(-\\frac{(1-\\eta)^2}{2\\cdot 0.08^2}\\right)\\times \\frac{1}{1+(\\ell/1200)^2}.\n$$\n- All quantities are treated as dimensionless.\n\nTest suite and output format:\n- Use the following set of test cases, each specified by a parameter choice $\\,p\\,$, a multipole $\\,\\ell\\,$, and a finite-difference step $\\,\\Delta p\\,$:\n  - Case 1: $p=\\Omega_b h^2$, $\\ell=200$, $\\Delta p=10^{-5}$.\n  - Case 2: $p=\\Omega_b h^2$, $\\ell=800$, $\\Delta p=10^{-7}$.\n  - Case 3: $p=\\Omega_b h^2$, $\\ell=1000$, $\\Delta p=10^{-9}$.\n  - Case 4: $p=Y_p$, $\\ell=100$, $\\Delta p=10^{-5}$.\n  - Case 5: $p=Y_p$, $\\ell=500$, $\\Delta p=10^{-7}$.\n  - Case 6: $p=N_{\\rm eff}$, $\\ell=50$, $\\Delta p=10^{-4}$.\n  - Case 7: $p=N_{\\rm eff}$, $\\ell=300$, $\\Delta p=10^{-6}$.\n  - Case 8: $p=N_{\\rm eff}$, $\\ell=1200$, $\\Delta p=10^{-8}$.\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (for example, $[r_1,r_2,\\dots,r_8]$), where $\\,r_i\\,$ is the relative discrepancy for case $\\,i\\,$ as defined above.\n\nScientific realism and constraints:\n- This is a controlled, dimensionless toy model designed to focus on the numerical aspects of differentiating through the visibility function and assessing stability. The Gaussian proxy is a standard technique for capturing the sharp last-scattering surface while maintaining analytical simplicity. Ensure all computations are self-contained and numerically stable for the specified test suite.",
            "solution": "The problem statement has been meticulously validated and is determined to be valid. It constitutes a well-posed numerical exercise within a simplified, yet scientifically plausible, physical model. All constants, functional forms, and numerical procedures are explicitly defined, creating a self-contained and solvable problem. The task is to compare two numerical methods for calculating the derivative of a model Cosmic Microwave Background (CMB) angular power spectrum with respect to a cosmological parameter, which is a standard procedure in sensitivity analysis and Fisher matrix forecasting.\n\nThe core of the problem lies in computing the derivative $\\,\\partial C_{\\ell}/\\partial p\\,$ for a toy model of the CMB angular power spectrum multipole $C_{\\ell}$. The model is defined by the integral:\n$$\nC_{\\ell}(p)=\\int_{0}^{\\eta_0} g(\\eta;p)\\,S_{\\ell}(\\eta)\\,d\\eta\n$$\nHere, all quantities are dimensionless. The integration is performed over a uniform grid of $\\,N_{\\rm grid}=4096\\,$ points for conformal time $\\,\\eta \\in [0, \\eta_0]\\,$ with $\\,\\eta_0=1\\,$, using the trapezoidal rule for numerical integration.\n\nThe components of the model are as follows:\n\n1.  **Visibility Function, $\\,g(\\eta;p)\\,$**: This function models the probability density for a photon's last scattering event at conformal time $\\,\\eta\\,$. It is given by a Gaussian form, which is a common simplification for the sharp recombination epoch.\n    $$\n    g(\\eta;p) = \\mathcal{N}(p) \\exp\\!\\left(-\\frac{(\\eta-\\mu(p))^2}{2\\,\\sigma^2(p)}\\right)\n    $$\n    The normalization factor $\\,\\mathcal{N}(p)\\,$ is determined numerically for each parameter set $\\,p\\,$ to enforce the condition $\\,\\int_0^{\\eta_0} g(\\eta;p)\\,d\\eta = 1\\,$. The dependence on a cosmological parameter vector $\\,p = (\\Omega_b h^2, Y_p, N_{\\rm eff})\\,$ is encoded in the mean $\\,\\mu(p)\\,$ and width $\\,\\sigma(p)\\,$. The baseline parameter vector is $\\,p_0 = (0.02237, 0.245, 3.046)\\,$.\n    \n    The mean is defined as a linear function of the parameters:\n    $$\n    \\mu(p) = \\mu_0 + \\alpha_b (\\Omega_b h^2 - 0.02237) + \\alpha_Y (Y_p - 0.245) + \\alpha_N (N_{\\rm eff} - 3.046)\n    $$\n    with $\\,\\mu_0=0.9\\,$, $\\,\\alpha_b=-0.50\\,$, $\\,\\alpha_Y=+0.02\\,$, and $\\,\\alpha_N=-0.02\\,$.\n    \n    The width is defined in terms of fractional changes from the baseline values:\n    $$\n    \\sigma(p)=\\sigma_0\\left[1 + \\beta_b \\frac{\\Omega_b h^2 - 0.02237}{0.02237} + \\beta_Y \\frac{Y_p - 0.245}{0.245} + \\beta_N \\frac{N_{\\rm eff} - 3.046}{3.046}\\right]\n    $$\n    with $\\,\\sigma_0=0.03\\,$, $\\,\\beta_b=+0.5\\,$, $\\,\\beta_Y=-0.3\\,$, and $\\,\\beta_N=+0.2\\,$. A floor is imposed such that $\\,\\sigma(p) \\ge 0.005\\,$.\n\n2.  **Source Function, $\\,S_{\\ell}(\\eta)\\,$**: This parameter-independent term represents the intrinsic anisotropies (e.g., from acoustic oscillations) being projected. It is modeled as:\n    $$\n    S_{\\ell}(\\eta) = \\cos\\!\\big(k\\,(\\eta_0-\\eta)\\big)\\,\\exp\\!\\left(-\\frac{(\\eta_0-\\eta)^2}{2\\,\\eta_d^2}\\right)\\times \\frac{1}{1+(\\ell/\\ell_D)^2}\n    $$\n    with fixed constants $\\,k=120\\,$, $\\,\\eta_d=0.08\\,$, and $\\,\\ell_D=1200\\,$.\n\nThe central task is to compute the derivative $\\,\\partial C_{\\ell}/\\partial p\\,$ via two distinct numerical pathways and compare their results.\n\n**Path A: Differentiate-then-Integrate**\nThis path follows from differentiating under the integral sign. The derivative of the visibility function, $\\,\\partial g/\\partial p\\,$, is first approximated using a central finite difference:\n$$\n\\left.\\frac{\\partial g(\\eta;p)}{\\partial p}\\right|_{p_0} \\approx \\frac{g(\\eta;p_0+\\Delta p\\,\\hat{e}_p)-g(\\eta;p_0-\\Delta p\\,\\hat{e}_p)}{2\\,\\Delta p}\n$$\nwhere $\\,\\hat{e}_p\\,$ is a unit vector in the direction of the parameter $\\,p\\,$ being varied. This discretized derivative is then used to compute the full derivative of $\\,C_\\ell\\,$ by numerical integration:\n$$\n\\left(\\frac{\\partial C_{\\ell}}{\\partial p}\\right)_{\\text{Path A}} = \\int_{0}^{\\eta_0} \\left(\\frac{\\partial g}{\\partial p}\\right) S_{\\ell}(\\eta)\\,d\\eta\n$$\n\n**Path B: Integrate-then-Differentiate**\nThis path involves first calculating the integral $\\,C_\\ell\\,$ at two perturbed parameter values, $\\,p_0+\\Delta p\\,\\hat{e}_p\\,$ and $\\,p_0-\\Delta p\\,\\hat{e}_p\\,$. The derivative is then approximated by a central finite difference of the resulting $\\,C_\\ell\\,$ values:\n$$\n\\left(\\frac{\\partial C_{\\ell}}{\\partial p}\\right)_{\\text{Path B}} \\approx \\frac{C_{\\ell}(p_0+\\Delta p\\,\\hat{e}_p)-C_{\\ell}(p_0-\\Delta p\\,\\hat{e}_p)}{2\\,\\Delta p}\n$$\n\n**Numerical Equivalence and Stability Analysis**\nThe numerical integration is performed using the trapezoidal rule, which is a linear operator. Let $\\,I[\\cdot]\\,$ represent the trapezoidal integration operator.\nPath A computes: $\\,I\\left[ \\frac{g(+)-g(-)}{2\\Delta p} S_\\ell \\right]\\,$.\nPath B computes: $\\,\\frac{I[g(+)S_\\ell] - I[g(-)S_\\ell]}{2\\Delta p}\\,$.\n\nDue to the linearity of the operator $\\,I\\,$, we have $\\,I[ a f_1 + b f_2 ] = a I[f_1] + b I[f_2]\\,$. Applying this to Path A:\n$$\nI\\left[ \\frac{g(+)S_\\ell - g(-)S_\\ell}{2\\Delta p} \\right] = \\frac{1}{2\\Delta p} \\left( I[g(+)S_\\ell] - I[g(-)S_\\ell] \\right)\n$$\nThis demonstrates that the expressions for Path A and Path B are algebraically identical. Any observed discrepancy between their computed results will arise purely from floating-point round-off errors accumulated differently due to the order of operations. Path A performs many subtractions of nearly equal numbers (in $\\,g(+)-g(-)\\,$) before integrating, which can introduce noise from catastrophic cancellation, especially for small $\\,\\Delta p\\,$. Path B performs two high-precision integrations first and then a single subtraction at the end. Comparing the two paths thus provides a quantitative assessment of the numerical stability of the derivative calculation.\n\nThe final implementation will compute the specified relative error for each test case:\n$$\n\\mathrm{rel\\_err}=\\frac{\\left|\\left(\\partial C_{\\ell}/\\partial p\\right)_{\\text{Path A}}-\\left(\\partial C_{\\ell}/\\partial p\\right)_{\\text{Path B}}\\right|}{\\max\\!\\left(\\left|\\left(\\partial C_{\\ell}/\\partial p\\right)_{\\text{Path B}}\\right|,\\,10^{-15}\\right)}\n$$\n\nThe provided Python code implements this logic self-containedly, using `numpy` for efficient array-based computations and `numpy.trapz` for integration.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the relative discrepancy between two numerical methods for calculating\n    the derivative of a toy CMB power spectrum, dC_l/dp.\n    \"\"\"\n\n    # --- Problem Constants and Baseline Parameters ---\n    P_BASE = {'Ombh2': 0.02237, 'Yp': 0.245, 'Neff': 3.046}\n    ETA0 = 1.0\n    N_GRID = 4096\n    \n    # Visibility function parameters\n    MU0 = 0.9\n    SIGMA0 = 0.03\n    ALPHA_COEFFS = {'Ombh2': -0.50, 'Yp': 0.02, 'Neff': -0.02}\n    BETA_COEFFS = {'Ombh2': 0.5, 'Yp': -0.3, 'Neff': 0.2}\n    SIGMA_FLOOR = 0.005\n\n    # Source function parameters\n    K_S = 120.0\n    ETA_D = 0.08\n    L_D = 1200.0\n    \n    # --- Discretized Conformal Time Grid ---\n    eta_grid = np.linspace(0, ETA0, N_GRID)\n\n    def get_mu(params):\n        \"\"\"Calculates the mean mu of the visibility function.\"\"\"\n        d_ombh2 = params['Ombh2'] - P_BASE['Ombh2']\n        d_yp = params['Yp'] - P_BASE['Yp']\n        d_neff = params['Neff'] - P_BASE['Neff']\n        \n        mu = MU0 + ALPHA_COEFFS['Ombh2'] * d_ombh2 \\\n                 + ALPHA_COEFFS['Yp'] * d_yp \\\n                 + ALPHA_COEFFS['Neff'] * d_neff\n        return mu\n\n    def get_sigma(params):\n        \"\"\"Calculates the width sigma of the visibility function.\"\"\"\n        rel_d_ombh2 = (params['Ombh2'] - P_BASE['Ombh2']) / P_BASE['Ombh2']\n        rel_d_yp = (params['Yp'] - P_BASE['Yp']) / P_BASE['Yp']\n        rel_d_neff = (params['Neff'] - P_BASE['Neff']) / P_BASE['Neff']\n        \n        sigma_mult = (1.0 + BETA_COEFFS['Ombh2'] * rel_d_ombh2\n                          + BETA_COEFFS['Yp'] * rel_d_yp\n                          + BETA_COEFFS['Neff'] * rel_d_neff)\n        sigma = SIGMA0 * sigma_mult\n        return np.maximum(sigma, SIGMA_FLOOR)\n\n    def get_visibility_function(params):\n        \"\"\"\n        Calculates the normalized visibility function g(eta; p) for a given\n        set of parameters.\n        \"\"\"\n        mu = get_mu(params)\n        sigma = get_sigma(params)\n        \n        g_unnormalized = np.exp(-((eta_grid - mu)**2) / (2.0 * sigma**2))\n        \n        # Numerically normalize using the trapezoidal rule\n        norm_factor = np.trapz(g_unnormalized, eta_grid)\n        \n        return g_unnormalized / norm_factor\n\n    def get_source_function(l_val):\n        \"\"\"Calculates the parameter-independent source function S_l(eta).\"\"\"\n        eta_term = ETA0 - eta_grid\n        cos_term = np.cos(K_S * eta_term)\n        exp_term = np.exp(-(eta_term**2) / (2.0 * ETA_D**2))\n        l_term = 1.0 / (1.0 + (l_val / L_D)**2)\n        \n        return cos_term * exp_term * l_term\n\n    # --- Test Cases ---\n    test_cases = [\n        # p_name, l, delta_p\n        ('Ombh2', 200, 1e-5),\n        ('Ombh2', 800, 1e-7),\n        ('Ombh2', 1000, 1e-9),\n        ('Yp', 100, 1e-5),\n        ('Yp', 500, 1e-7),\n        ('Neff', 50, 1e-4),\n        ('Neff', 300, 1e-6),\n        ('Neff', 1200, 1e-8),\n    ]\n\n    results = []\n    \n    # Map from problem statement strings to code keys\n    param_map = {'Omega_b h^2': 'Ombh2', 'Y_p': 'Yp', 'N_{\\rm eff}': 'Neff'}\n    \n    # Remap test cases to use code keys to avoid confusion\n    proc_test_cases = []\n    for p_str, l, dp in test_cases:\n        p_key = next((key for tex, key in param_map.items() if tex in p_str), p_str)\n        proc_test_cases.append((p_key, l, dp))\n\n    for p_name, l_val, delta_p in proc_test_cases:\n        # --- Setup perturbed parameter vectors ---\n        p_plus_params = P_BASE.copy()\n        p_plus_params[p_name] += delta_p\n        \n        p_minus_params = P_BASE.copy()\n        p_minus_params[p_name] -= delta_p\n\n        # --- Common Calculations ---\n        # Visibility functions at p+dp and p-dp\n        g_plus = get_visibility_function(p_plus_params)\n        g_minus = get_visibility_function(p_minus_params)\n        \n        # Source function\n        s_l = get_source_function(l_val)\n\n        # --- Path A: Differentiate g, then integrate ---\n        dg_dp = (g_plus - g_minus) / (2.0 * delta_p)\n        dC_dp_A = np.trapz(dg_dp * s_l, eta_grid)\n        \n        # --- Path B: Integrate to get C_l, then differentiate ---\n        c_l_plus = np.trapz(g_plus * s_l, eta_grid)\n        c_l_minus = np.trapz(g_minus * s_l, eta_grid)\n        dC_dp_B = (c_l_plus - c_l_minus) / (2.0 * delta_p)\n\n        # --- Calculate Relative Discrepancy ---\n        denominator = np.maximum(np.abs(dC_dp_B), 1e-15)\n        rel_err = np.abs(dC_dp_A - dC_dp_B) / denominator\n        results.append(rel_err)\n\n    # --- Final Output ---\n    print(f\"[{','.join(f'{r:.15e}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}