{
    "hands_on_practices": [
        {
            "introduction": "The Fast Fourier Transform provides a set of discrete complex amplitudes. To be useful for physical analysis, these numbers must be correctly mapped to continuous quantities like the cosmological power spectrum, $P(k)$. This foundational exercise guides you through the essential derivation of the normalization factor that connects the squared amplitudes of FFT modes in a finite volume to the underlying power spectrum, a crucial step for correctly interpreting simulation data .",
            "id": "3495401",
            "problem": "Consider a statistically homogeneous and isotropic cosmological mass-density contrast field $\\delta(\\mathbf{x})$, defined in a periodic cubic domain of side length $L$ and volume $V=L^{3}$. The field is sampled on an $N^{3}$ uniform grid for application of the fast Fourier transform (FFT). Let $\\mathbf{k}$ denote the discrete wavevectors permitted by periodicity, $\\mathbf{k} = \\frac{2\\pi}{L}\\mathbf{n}$ with $\\mathbf{n}\\in\\mathbb{Z}^{3}$. The ensemble statistics of the Fourier modes are assumed to be characterized by the power spectrum $P(k)$ of the continuous field, where $k=|\\mathbf{k}|$.\n\nStarting from the fundamental definition of the power spectrum for a homogeneous and isotropic field in the continuum, and the requirement that the discrete Fourier amplitudes produced by the FFT consistently estimate the continuum modes in the large-volume limit, perform the following:\n\n- Choose a normalization for the Fourier transform of $\\delta(\\mathbf{x})$ into $\\delta(\\mathbf{k})$ such that, for the discrete modes in the periodic box, the ensemble average of the squared Fourier amplitude equals the power spectrum. Your choice must be derived from first principles beginning with the continuum definition of the power spectrum and the periodic-box discretization.\n- Verify the physical units of $P(k)$ given that $\\delta(\\mathbf{x})$ is dimensionless, and your chosen normalization is consistent with the FFT on the volume $V$.\n- Define the dimensionless power per logarithmic interval in $k$, denoted $\\Delta^{2}(k)$, by requiring that the variance of $\\delta(\\mathbf{x})$ can be written as an integral over $\\ln k$ of $\\Delta^{2}(k)$, and derive $\\Delta^{2}(k)$ explicitly in terms of $P(k)$.\n\nExpress your final answer as a single closed-form analytic expression for $\\Delta^{2}(k)$ in terms of $P(k)$. No numerical evaluation is required. Do not include units in the final boxed expression.",
            "solution": "The problem statement will first be validated for scientific soundness, clarity, and completeness.\n\n### Step 1: Extract Givens\n-   **Field**: $\\delta(\\mathbf{x})$, a statistically homogeneous and isotropic cosmological mass-density contrast field.\n-   **Domain**: A periodic cubic domain of side length $L$ and volume $V=L^{3}$.\n-   **Discretization**: The field is sampled on an $N^{3}$ uniform grid.\n-   **Fourier Transform**: The Fast Fourier Transform (FFT) is used to compute the discrete Fourier transform.\n-   **Wavevectors**: The discrete wavevectors are $\\mathbf{k} = \\frac{2\\pi}{L}\\mathbf{n}$ for $\\mathbf{n}\\in\\mathbb{Z}^{3}$.\n-   **Statistical Property**: The ensemble statistics are described by the power spectrum $P(k)$ of the continuous field, where $k=|\\mathbf{k}|$.\n-   **Task 1**: Choose a normalization for the Fourier transform of $\\delta(\\mathbf{x})$ into $\\delta(\\mathbf{k})$ such that the ensemble average of the squared Fourier amplitude equals the power spectrum, $\\langle |\\delta(\\mathbf{k})|^2 \\rangle = P(k)$.\n-   **Task 2**: Verify the physical units of $P(k)$ given that $\\delta(\\mathbf{x})$ is dimensionless.\n-   **Task 3**: Define the dimensionless power per logarithmic interval, $\\Delta^{2}(k)$, by the relation that the variance of $\\delta(\\mathbf{x})$ is $\\sigma^2 = \\int \\Delta^{2}(k) d(\\ln k)$, and derive an explicit expression for $\\Delta^{2}(k)$ in terms of $P(k)$.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is scientifically grounded, well-posed, and objective.\n\n-   **Scientific Grounding**: The problem deals with standard concepts in modern cosmology, specifically the statistical description of large-scale structure. The density contrast field $\\delta(\\mathbf{x})$, the power spectrum $P(k)$, and the use of FFTs on periodic simulation boxes are fundamental tools in numerical cosmology. All premises and definitions are factually correct and based on established physical and mathematical principles.\n-   **Well-Posedness**: The problem is clearly stated and contains all necessary information to perform the requested derivations. It asks for the derivation of fundamental relationships between standard cosmological quantities. A unique, meaningful solution exists for each of the tasks.\n-   **Objectivity**: The language is precise and free from any subjective or ambiguous terminology.\n\nThe problem does not violate any of the invalidity criteria. It is a standard, formalizable problem in theoretical and computational cosmology.\n\n### Step 3: Verdict and Action\nThe problem is **valid**. A full solution will be provided.\n\n### Solution Derivation\nThe solution proceeds by addressing the three tasks in order.\n\n**1. Normalization of the Fourier Transform**\n\nWe start from the definition of the two-point correlation function of the continuous random field $\\delta(\\mathbf{x})$ in Fourier space. Let the continuum Fourier transform be defined as $\\delta_C(\\mathbf{k}) = \\int d^3x \\, \\delta(\\mathbf{x}) e^{-i\\mathbf{k}\\cdot\\mathbf{x}}$. For a statistically homogeneous and isotropic field, the ensemble average of the product of two Fourier modes is given by:\n$$\n\\langle \\delta_C(\\mathbf{k}) \\delta_C^*(\\mathbf{k'}) \\rangle = (2\\pi)^3 P(k) \\delta_D(\\mathbf{k} - \\mathbf{k'})\n$$\nwhere $\\delta_D(\\mathbf{k} - \\mathbf{k'})$ is the three-dimensional Dirac delta function and $P(k)$ is the power spectrum, dependent only on the magnitude $k=|\\mathbf{k}|$.\n\nWhen the field is restricted to a finite periodic box of volume $V=L^3$, the wavevectors $\\mathbf{k}$ become discrete, and the Fourier transform is defined as an integral over this volume:\n$$\n\\delta_V(\\mathbf{k}) = \\int_V d^3x \\, \\delta(\\mathbf{x}) e^{-i\\mathbf{k}\\cdot\\mathbf{x}}\n$$\nThe relationship involving the Dirac delta function is replaced by its finite-volume analog, which involves the Kronecker delta $\\delta^K_{\\mathbf{k},\\mathbf{k'}}$. For discrete modes in the box, the relation becomes:\n$$\n\\langle \\delta_V(\\mathbf{k}) \\delta_V^*(\\mathbf{k'}) \\rangle = V P(k) \\delta^K_{\\mathbf{k},\\mathbf{k'}}\n$$\nThis means that for $\\mathbf{k}=\\mathbf{k'}$, the ensemble average of the squared amplitude is $\\langle |\\delta_V(\\mathbf{k})|^2 \\rangle = V P(k)$.\n\nThe problem requires us to choose a normalization for the Fourier transform, which we denote $\\delta(\\mathbf{k})$, such that its squared amplitude has an ensemble average equal to the power spectrum itself:\n$$\n\\langle |\\delta(\\mathbf{k})|^2 \\rangle = P(k)\n$$\nComparing this requirement with the result for $\\delta_V(\\mathbf{k})$, we can define our normalized Fourier amplitude $\\delta(\\mathbf{k})$ as:\n$$\n\\delta(\\mathbf{k}) = \\frac{\\delta_V(\\mathbf{k})}{\\sqrt{V}}\n$$\nSubstituting the integral definition for $\\delta_V(\\mathbf{k})$, the chosen normalization for the Fourier transform is:\n$$\n\\delta(\\mathbf{k}) = \\frac{1}{\\sqrt{V}} \\int_V d^3x \\, \\delta(\\mathbf{x}) e^{-i\\mathbf{k}\\cdot\\mathbf{x}}\n$$\nThis normalization is consistent with the use of the FFT. The discrete approximation of the integral using field values $\\delta_j$ on an $N^3$ grid is $\\int_V d^3x \\to \\sum_j (V/N^3)$. The raw output of an FFT algorithm, $C_{\\mathbf{k}} = \\sum_j \\delta_j e^{-i\\mathbf{k}\\cdot\\mathbf{x}_j}$, is related to our defined $\\delta(\\mathbf{k})$ by $\\delta(\\mathbf{k}) = \\frac{\\sqrt{V}}{N^3} C_{\\mathbf{k}}$.\n\n**2. Physical Units of the Power Spectrum $P(k)$**\n\nThe mass-density contrast field $\\delta(\\mathbf{x}) = (\\rho(\\mathbf{x}) - \\bar{\\rho})/\\bar{\\rho}$ is a ratio of densities, making it a dimensionless quantity. The wavevector $\\mathbf{k}$ has units of inverse length, which we denote as $[L]^{-1}$. The volume $V$ has units of length cubed, $[L]^3$.\n\nFrom the chosen normalization in Part 1, we have:\n$$\n\\delta(\\mathbf{k}) = \\frac{1}{\\sqrt{V}} \\int_V d^3x \\, \\delta(\\mathbf{x}) e^{-i\\mathbf{k}\\cdot\\mathbf{x}}\n$$\nLet's analyze the physical units. We denote the unit of a quantity $Q$ as $[Q]$.\n$$\n[\\delta(\\mathbf{x})] = 1 \\quad (\\text{dimensionless})\n$$\n$$\n[d^3x] = [L]^3\n$$\n$$\n[\\sqrt{V}] = ([L]^3)^{1/2} = [L]^{3/2}\n$$\nThe units of the Fourier amplitude $\\delta(\\mathbf{k})$ are therefore:\n$$\n[\\delta(\\mathbf{k})] = \\frac{1}{[\\sqrt{V}]} [\\int_V d^3x] [\\delta(\\mathbf{x})] = \\frac{1}{[L]^{3/2}} [L]^3 \\cdot 1 = [L]^{3/2}\n$$\nThe power spectrum $P(k)$ is defined by the relation $\\langle |\\delta(\\mathbf{k})|^2 \\rangle = P(k)$. Thus, its units must be the square of the units of $\\delta(\\mathbf{k})$:\n$$\n[P(k)] = [\\delta(\\mathbf{k})]^2 = ([L]^{3/2})^2 = [L]^3\n$$\nThe power spectrum $P(k)$ has units of volume.\n\n**3. Derivation of the Dimensionless Power Spectrum $\\Delta^2(k)$**\n\nThe variance of the field $\\delta(\\mathbf{x})$ is defined as $\\sigma^2 = \\langle \\delta^2(\\mathbf{x}) \\rangle$. Due to statistical homogeneity, this value is independent of the position $\\mathbf{x}$. The variance can be expressed as the two-point correlation function $\\xi(\\mathbf{r}) = \\langle \\delta(\\mathbf{x}+\\mathbf{r})\\delta(\\mathbf{x}) \\rangle$ evaluated at zero separation, $\\mathbf{r}=0$. The correlation function is the Fourier transform of the power spectrum:\n$$\n\\xi(\\mathbf{r}) = \\int \\frac{d^3k}{(2\\pi)^3} P(k) e^{i\\mathbf{k}\\cdot\\mathbf{r}}\n$$\nSetting $\\mathbf{r}=0$ gives the variance:\n$$\n\\sigma^2 = \\xi(0) = \\int \\frac{d^3k}{(2\\pi)^3} P(k)\n$$\nDue to statistical isotropy, the power spectrum $P(k)$ depends only on the magnitude $k=|\\mathbf{k}|$. We can therefore switch to spherical coordinates in k-space, where the volume element is $d^3k = k^2 dk d\\Omega_k$, with $d\\Omega_k$ being the solid angle element.\n$$\n\\sigma^2 = \\int_0^\\infty \\left( \\int_{S^2} d\\Omega_k \\right) \\frac{k^2}{(2\\pi)^3} P(k) dk\n$$\nThe integral over the solid angle yields $4\\pi$.\n$$\n\\sigma^2 = \\int_0^\\infty \\frac{4\\pi k^2}{(2\\pi)^3} P(k) dk = \\int_0^\\infty \\frac{k^2}{2\\pi^2} P(k) dk\n$$\nThe problem defines the dimensionless power spectrum $\\Delta^2(k)$ via the relation $\\sigma^2 = \\int \\Delta^2(k) d(\\ln k)$. To find $\\Delta^2(k)$, we change the integration variable in our expression for $\\sigma^2$ from $k$ to $\\ln k$.\nLet $u = \\ln k$. This implies $k = \\exp(u)$ and thus $dk = \\exp(u) du = k du = k d(\\ln k)$. Substituting $dk = k d(\\ln k)$ into the integral for $\\sigma^2$:\n$$\n\\sigma^2 = \\int_0^\\infty \\frac{k^2}{2\\pi^2} P(k) \\cdot (k \\, d(\\ln k)) = \\int_{-\\infty}^\\infty \\frac{k^3 P(k)}{2\\pi^2} d(\\ln k)\n$$\n(The integration limits for $\\ln k$ are from $-\\infty$ to $\\infty$, corresponding to $k$ from $0$ to $\\infty$).\n\nBy comparing this expression with the defining relation $\\sigma^2 = \\int \\Delta^2(k) d(\\ln k)$, we can directly identify the integrand:\n$$\n\\Delta^2(k) = \\frac{k^3 P(k)}{2\\pi^2}\n$$\nThis expression defines the dimensionless power per logarithmic interval in wavenumber, $\\Delta^2(k)$, in terms of the power spectrum $P(k)$.",
            "answer": "$$\\boxed{\\frac{k^3 P(k)}{2\\pi^2}}$$"
        },
        {
            "introduction": "Cosmological fields, such as the density contrast, are real-valued. This property imposes a fundamental constraint known as Hermitian symmetry on their Fourier transforms, making nearly half of the complex Fourier coefficients redundant. This hands-on coding practice challenges you to implement an efficient storage layout for a real-to-complex FFT, a vital skill for managing memory and computational resources in large-scale simulations .",
            "id": "3495399",
            "problem": "You are implementing a three-dimensional discrete Fourier transform for a real scalar field in a periodic cosmological volume. Let the real field be sampled on a uniform Cartesian grid of size $N_x \\times N_y \\times N_z$, with periodic boundary conditions in each dimension. Consider the discrete Fourier transform that maps the real-space samples $f[n_x, n_y, n_z]$ to complex Fourier coefficients $F[k_x, k_y, k_z]$. The fundamental base for this task is as follows: (i) the standard definition of the discrete Fourier transform on a finite periodic grid, (ii) the property that the Fourier transform of a real-valued field satisfies Hermitian symmetry, namely $F(-\\boldsymbol{k}) = F(\\boldsymbol{k})^\\ast$, and (iii) the standard index wrapping induced by periodicity, where discrete wave indices are defined modulo $N_d$ along dimension $d \\in \\{x,y,z\\}$.\n\nYour task is to specify a storage layout and an index mapping for a real-to-complex three-dimensional fast Fourier transform (FFT) that excludes redundant negative frequencies while preserving Hermitian symmetry, using the following precise requirements derived from the above fundamentals:\n\n- Storage layout: Use a compact half-spectrum along the $z$-axis that stores only the nonnegative $z$-frequencies. The stored complex array must have shape $(N_x, N_y, \\lfloor N_z/2 \\rfloor + 1)$, where the indices $(i,j,k)$ correspond to wrapped discrete wave indices $(\\tilde{k}_x, \\tilde{k}_y, \\tilde{k}_z)$ defined by\n  $$\\tilde{k}_x(i) = \\begin{cases}\n  i, & 0 \\le i \\le \\lfloor N_x/2 \\rfloor \\\\\n  i - N_x, & \\lfloor N_x/2 \\rfloor < i \\le N_x - 1\n  \\end{cases},\\quad\n  \\tilde{k}_y(j) = \\begin{cases}\n  j, & 0 \\le j \\le \\lfloor N_y/2 \\rfloor \\\\\n  j - N_y, & \\lfloor N_y/2 \\rfloor < j \\le N_y - 1\n  \\end{cases},\\quad\n  \\tilde{k}_z(k) = k,$$\n  with $i \\in \\{0,\\dots,N_x-1\\}$, $j \\in \\{0,\\dots,N_y-1\\}$, and $k \\in \\{0,\\dots,\\lfloor N_z/2 \\rfloor\\}$. The excluded coefficients correspond to negative $z$-frequencies $k_z \\in \\{-\\lfloor N_z/2 \\rfloor,\\dots,-1\\}$, which are redundant by Hermitian symmetry.\n\n- Index mapping: You must implement the bidirectional mapping between storage indices $(i,j,k)$ and wrapped wave indices $(\\tilde{k}_x,\\tilde{k}_y,\\tilde{k}_z)$ as above, together with the conjugate-partner relation implied by Hermitian symmetry. Specifically, given a stored index $(i,j,k)$ representing the mode $(\\tilde{k}_x,\\tilde{k}_y,\\tilde{k}_z)$, its Hermitian-conjugate partner corresponds to the mode $(-\\tilde{k}_x,-\\tilde{k}_y,-\\tilde{k}_z)$, which would map to the storage index\n  $$(i',j',k') = \\left(({-\\tilde{k}_x}) \\bmod N_x,\\ ({-\\tilde{k}_y}) \\bmod N_y,\\ ({-\\tilde{k}_z}) \\bmod N_z\\right).$$\n  This conjugate partner is stored in the compact layout if and only if $k' \\in \\{0,\\dots,\\lfloor N_z/2 \\rfloor\\}$. Modes with $k \\in \\{0\\}$ and, when $N_z$ is even, $k \\in \\{N_z/2\\}$ have their conjugate partner within the stored set; for other $k$, the conjugate partner is not stored. A mode is self-conjugate if its stored index equals that of its conjugate partner; this occurs exactly when each component equals its own negative modulo its size, namely when $i \\in \\{0\\}$ and, if $N_x$ is even, possibly $i \\in \\{N_x/2\\}$; similarly for $j$; and for $k \\in \\{0\\}$ and, if $N_z$ is even, possibly $k \\in \\{N_z/2\\}$.\n\n- Memory layout: Use contiguous row-major ordering with $k$ as the fastest-varying index, then $j$, then $i$. The flat memory index of a stored coefficient $(i,j,k)$ must be\n  $$\\mathrm{flat}(i,j,k) = i \\cdot \\left(N_y \\cdot \\left(\\left\\lfloor \\frac{N_z}{2} \\right\\rfloor + 1\\right)\\right) + j \\cdot \\left(\\left\\lfloor \\frac{N_z}{2} \\right\\rfloor + 1\\right) + k.$$\n\nImplement a program that defines the above storage layout and mapping, and then computes, for a given set of test cases, the following five quantities per test case:\n\n- The total number of stored modes, which must equal $N_x \\cdot N_y \\cdot \\left(\\left\\lfloor N_z/2 \\right\\rfloor + 1\\right)$.\n- The number of self-conjugate stored modes determined by the Hermitian condition and the stored set.\n- The flat memory index of a specified sample wrapped wave index $(\\hat{k}_x,\\hat{k}_y,\\hat{k}_z)$ if it is representable in the stored set; if not representable, return the integer $-1$.\n- The count of stored modes whose Hermitian-conjugate partner also lies within the stored set.\n- A boolean indicating whether, for every stored index $(i,j,k)$, mapping to $(\\tilde{k}_x,\\tilde{k}_y,\\tilde{k}_z)$ and back returns the original $(i,j,k)$.\n\nYour program must use the following test suite:\n\n- Test case $1$: $N_x=4$, $N_y=3$, $N_z=6$, with sample wrapped wave index $(\\hat{k}_x,\\hat{k}_y,\\hat{k}_z)=(-1,1,2)$.\n- Test case $2$: $N_x=5$, $N_y=5$, $N_z=5$, with sample wrapped wave index $(\\hat{k}_x,\\hat{k}_y,\\hat{k}_z)=(2,-2,1)$.\n- Test case $3$: $N_x=2$, $N_y=2$, $N_z=2$, with sample wrapped wave index $(\\hat{k}_x,\\hat{k}_y,\\hat{k}_z)=(1,1,1)$.\n\nFinal output format: Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. The results must be emitted in the order of the test cases, and for each test case, emit the five quantities in the exact order described above. For example, the overall output must have the form\n$[\\dots]$\nwith a total of $5 \\times 3$ entries. No units are involved, and all angles, if any appear, must be understood to be in radians. All numeric answers must be emitted as plain integers or booleans in the printed list.",
            "solution": "The problem statement has been validated and is deemed sound. It is scientifically grounded, well-posed, objective, and contains all necessary information to derive a unique solution. The problem requires the implementation of a specific storage and indexing scheme for a three-dimensional real-to-complex Fast Fourier Transform (FFT) used in numerical cosmology, followed by the computation of five specific quantities for a given set of parameters.\n\nThe solution proceeds by systematically deriving the method to calculate each of the five required quantities. The grid dimensions are denoted by $N_x$, $N_y$, and $N_z$. The compact storage array utilizes a reduced dimension along the $z$-axis, $N_z' = \\lfloor N_z/2 \\rfloor + 1$. Its shape is $(N_x, N_y, N_z')$.\n\n**1. Total Number of Stored Modes**\n\nThe total number of stored complex Fourier coefficients is simply the number of elements in the compact storage array. This is the product of its dimensions:\n$$ \\text{Total Modes} = N_x \\cdot N_y \\cdot \\left(\\left\\lfloor \\frac{N_z}{2} \\right\\rfloor + 1\\right) $$\nThis quantity represents the memory footprint of the Fourier-space field, optimized by exploiting Hermitian symmetry.\n\n**2. Number of Self-Conjugate Stored Modes**\n\nA mode with wave vector $\\boldsymbol{\\tilde{k}} = (\\tilde{k}_x, \\tilde{k}_y, \\tilde{k}_z)$ is self-conjugate if it is its own Hermitian conjugate partner, i.e., if $\\boldsymbol{\\tilde{k}} = -\\boldsymbol{\\tilde{k}}$ under the periodic wrapping. This is equivalent to the storage index $(i,j,k)$ being identical to the storage index of the partner mode $(i',j',k')$. This condition, $(i,j,k) = (i',j',k')$, must hold for each dimension independently.\n\nFor a dimension $d \\in \\{x,y,z\\}$ of size $N_d$, the wrapped wave number $\\tilde{k}_d$ must satisfy $\\tilde{k}_d = -\\tilde{k}_d \\pmod{N_d}$, which simplifies to $2\\tilde{k}_d \\equiv 0 \\pmod{N_d}$. The solutions for the storage index along dimension $d$ are:\n- Index $0$, which corresponds to $\\tilde{k}_d=0$.\n- If $N_d$ is even, index $N_d/2$, which corresponds to the Nyquist frequency $\\tilde{k}_d=N_d/2$.\n\nThe number of self-conjugate indices for each dimension $d$ is $S_d = 2$ if $N_d$ is even, and $S_d = 1$ if $N_d$ is odd. This can be written as $S_d = 1 + (1 - N_d \\pmod{2})$.\n\nFor the $z$-axis, the stored indices $k$ are restricted to $\\{0, \\dots, \\lfloor N_z/2 \\rfloor\\}$. The self-conjugate solutions $k=0$ and (if $N_z$ is even) $k=N_z/2$ both fall within this stored range.\nThe total number of self-conjugate modes is the product of the counts for each dimension:\n$$ \\text{Self-Conjugate Modes} = S_x \\cdot S_y \\cdot S_z = \\left(1 + (1 - N_x \\pmod{2})\\right) \\cdot \\left(1 + (1 - N_y \\pmod{2})\\right) \\cdot \\left(1 + (1 - N_z \\pmod{2})\\right) $$\n\n**3. Flat Memory Index of a Sample Mode**\n\nGiven a sample wrapped wave index $(\\hat{k}_x, \\hat{k}_y, \\hat{k}_z)$, we must first determine if it is represented in the compact storage array. The storage scheme explicitly includes only non-negative $z$-frequencies. Therefore, a mode is stored if and only if its $z$-wave number $\\hat{k}_z$ is in the range $[0, \\lfloor N_z/2 \\rfloor]$. If $\\hat{k}_z$ is outside this range, the mode is not stored, and the value to be returned is $-1$.\n\nIf the mode is potentially stored, we must map the wave numbers $(\\hat{k}_x, \\hat{k}_y, \\hat{k}_z)$ back to storage indices $(i,j,k)$.\nThe mapping from wave number $\\tilde{k}_d$ to storage index $i_d$ is given by the modulo operation: $i_d = \\tilde{k}_d \\pmod{N_d}$.\nThus, the storage indices are calculated as:\n$$ i = \\hat{k}_x \\pmod{N_x} $$\n$$ j = \\hat{k}_y \\pmod{N_y} $$\n$$ k = \\hat{k}_z $$\nWith the indices $(i,j,k)$ determined, the flat memory index is computed using the provided row-major formula, where $k$ is the fastest-varying index:\n$$ \\mathrm{flat}(i,j,k) = i \\cdot \\left(N_y \\cdot \\left(\\left\\lfloor \\frac{N_z}{2} \\right\\rfloor + 1\\right)\\right) + j \\cdot \\left(\\left\\lfloor \\frac{N_z}{2} \\right\\rfloor + 1\\right) + k $$\n\n**4. Count of Stored Modes with a Stored Conjugate Partner**\n\nFor a stored mode with index $(i,j,k)$, we determine the index of its Hermitian conjugate partner, $(i',j',k')$.\nThe partner mode has wave vector $(-\\tilde{k}_x, -\\tilde{k}_y, -\\tilde{k}_z)$. The corresponding storage index is\n$k' = (-\\tilde{k}_z) \\pmod{N_z} = (-k) \\pmod{N_z}$, since $\\tilde{k}_z = k$.\nThe partner is stored in the compact array if its $z$-index $k'$ falls within the stored range: $0 \\le k' \\le \\lfloor N_z/2 \\rfloor$.\n\nWe analyze this condition on $k \\in \\{0, \\dots, \\lfloor N_z/2 \\rfloor\\}$:\n- If $k=0$: $k' = (-0) \\pmod{N_z} = 0$. Since $0$ is always in the stored range, all modes with $k=0$ have their partner stored. There are $N_x \\cdot N_y$ such modes.\n- If $k>0$: $k' = N_z - k$. The condition becomes $N_z - k \\le \\lfloor N_z/2 \\rfloor$, which implies $k \\ge N_z - \\lfloor N_z/2 \\rfloor$.\n    - If $N_z$ is even, let $N_z=2m$. The stored range for $k$ is $[0, m]$. The condition is $k \\ge 2m - m = m$. The only solution for $k>0$ in the stored range is $k=m=N_z/2$. Thus, all modes with $k=N_z/2$ also have stored partners. There are $N_x \\cdot N_y$ such modes.\n    - If $N_z$ is odd, let $N_z=2m+1$. The stored range for $k$ is $[0, m]$. The condition is $k \\ge (2m+1) - m = m+1$. There is no $k$ in the stored range that satisfies this.\n\nIn summary, the partner is stored only for modes on the $k=0$ plane, and additionally on the $k=N_z/2$ plane if $N_z$ is even. The total count is:\n$$ \\text{Count} = \\begin{cases} N_x \\cdot N_y & \\text{if } N_z \\text{ is odd} \\\\ 2 \\cdot N_x \\cdot N_y & \\text{if } N_z \\text{ is even} \\end{cases} $$\nThis can be written as $(1 + (1 - N_z \\pmod 2)) \\cdot N_x \\cdot N_y$.\n\n**5. Bidirectional Index Mapping Verification**\n\nThis task requires verifying that the mapping from a storage index $(i,j,k)$ to its wave vector $(\\tilde{k}_x, \\tilde{k}_y, \\tilde{k}_z)$ and back to a storage index $(i',j',k')$ is an identity transformation, i.e., $(i,j,k) = (i',j',k')$.\nThe forward map is given by the problem's definition of $\\tilde{k}_d(i_d)$. The backward map is $i_d' = \\tilde{k}_d \\pmod{N_d}$.\nFor any dimension $d$ and index $i \\in \\{0, \\dots, N_d-1\\}$:\n- If $0 \\le i \\le \\lfloor N_d/2 \\rfloor$, then $\\tilde{k}_d(i) = i$, and $i \\pmod{N_d} = i$.\n- If $\\lfloor N_d/2 \\rfloor < i \\le N_d-1$, then $\\tilde{k}_d(i) = i - N_d$, and $(i - N_d) \\pmod{N_d} = i$.\nIn both cases, the index maps back to itself. This holds for dimensions $x$ and $y$. For the $z$ dimension, the mapping is trivial since $\\tilde{k}_z=k$. Therefore, the bidirectional mapping is always an identity map for any valid indices and grid sizes. The result of this check will be `True` for all test cases. The implementation will perform this check algorithmically to be rigorous.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem for the given test suite and prints the formatted output.\n    \"\"\"\n    test_cases = [\n        (4, 3, 6, (-1, 1, 2)),\n        (5, 5, 5, (2, -2, 1)),\n        (2, 2, 2, (1, 1, 1)),\n    ]\n\n    all_results = []\n    for case in test_cases:\n        Nx, Ny, Nz, sample_k_vec = case\n        results = calculate_metrics(Nx, Ny, Nz, sample_k_vec)\n        all_results.extend(results)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, all_results))}]\")\n\n\ndef calculate_metrics(Nx, Ny, Nz, sample_k_vec):\n    \"\"\"\n    Computes the five required quantities for a given test case.\n    \n    Args:\n        Nx (int): Grid size in x-dimension.\n        Ny (int): Grid size in y-dimension.\n        Nz (int): Grid size in z-dimension.\n        sample_k_vec (tuple): A sample wrapped wave index (kx, ky, kz).\n\n    Returns:\n        tuple: A tuple containing the five computed quantities in order.\n    \"\"\"\n    Nz_prime = Nz // 2 + 1\n\n    # 1. Total number of stored modes\n    total_modes = Nx * Ny * Nz_prime\n\n    # 2. Number of self-conjugate stored modes\n    # A mode is self-conjugate if its wave number k_d satisfies k_d = -k_d mod N_d.\n    # This is true for k_d=0 and, if N_d is even, k_d=N_d/2.\n    sx = 2 if Nx % 2 == 0 else 1\n    sy = 2 if Ny % 2 == 0 else 1\n    sz = 2 if Nz % 2 == 0 else 1\n    self_conjugate_modes = sx * sy * sz\n\n    # 3. Flat memory index of a specified sample wrapped wave index\n    k_hat_x, k_hat_y, k_hat_z = sample_k_vec\n    flat_index = -1\n    # Check if the z-frequency is in the stored half-spectrum\n    if 0 <= k_hat_z < Nz_prime:\n        i = k_hat_x % Nx\n        j = k_hat_y % Ny\n        k = k_hat_z\n        \n        # This check confirms that the given sample_k_vec corresponds to the\n        # canonical wave vectors generated from our storage indices.\n        if (k_tilde(i, Nx) == k_hat_x and k_tilde(j, Ny) == k_hat_y and k == k_hat_z):\n            flat_index = i * (Ny * Nz_prime) + j * Nz_prime + k\n\n    # 4. Count of stored modes whose Hermitian-conjugate partner also lies within the stored set\n    # Partner is stored if its k' index is in [0, Nz_prime-1].\n    # This only happens for modes with k=0 and, if Nz is even, k=Nz/2.\n    num_planes_with_stored_partners = 2 if Nz % 2 == 0 else 1\n    modes_with_stored_partner = num_planes_with_stored_partners * Nx * Ny\n\n    # 5. Boolean indicating if the index mapping is bijective\n    is_bijective = True\n    # This loop programmatically verifies the identity, though it's true by construction.\n    for i_loop in range(Nx):\n        for j_loop in range(Ny):\n            # The z-axis mapping is a trivial identity and does not need a loop.\n            kx_tilde_val = k_tilde(i_loop, Nx)\n            ky_tilde_val = k_tilde(j_loop, Ny)\n            \n            i_back = kx_tilde_val % Nx\n            j_back = ky_tilde_val % Ny\n            \n            if i_loop != i_back or j_loop != j_back:\n                is_bijective = False\n                break\n        if not is_bijective:\n            break\n            \n    return total_modes, self_conjugate_modes, int(flat_index), modes_with_stored_partner, is_bijective\n\ndef k_tilde(idx, N):\n    \"\"\"\n    Maps a storage index `idx` to its corresponding wrapped wave number for a dimension of size `N`.\n    \"\"\"\n    if idx <= N // 2:\n        return idx\n    else:\n        return idx - N\n\nsolve()\n```"
        },
        {
            "introduction": "In Particle-Mesh (PM) simulations, the mass of discrete particles is assigned to a grid, a process that effectively smoothes the density field and suppresses power at small scales. This exercise involves deriving the analytical form of the Fourier-space window functions for common assignment schemes like Nearest-Grid-Point (NGP), Cloud-in-Cell (CIC), and Triangular-Shaped-Cloud (TSC). Understanding these window functions is essential for correcting for this systematic effect and recovering the true underlying power spectrum from simulations .",
            "id": "3495428",
            "problem": "Consider a uniform Cartesian mesh used in a Particleâ€“Mesh method for cosmological $N$-body simulations. Let the grid spacing be $\\Delta$ along each Cartesian axis. A particle-to-mesh mass assignment scheme can be described by a real-space one-dimensional assignment kernel $A(x)$ that is separable across dimensions, so the three-dimensional kernel is $A(x)A(y)A(z)$. The measured Fourier amplitude $\\tilde{\\delta}(\\mathbf{k})$ of the gridded overdensity field is related to the true continuous Fourier amplitude $\\delta(\\mathbf{k})$ by $\\tilde{\\delta}(\\mathbf{k}) = W(\\mathbf{k}) \\, \\delta(\\mathbf{k})$, where $W(\\mathbf{k})$ is the Fourier-space window function determined by $A(x)$ and separability. Assume the Fourier transform of a function $f(\\mathbf{x})$ is defined by $f(\\mathbf{k}) = \\int_{\\mathbb{R}^{3}} f(\\mathbf{x}) \\exp(-\\mathrm{i} \\mathbf{k}\\cdot \\mathbf{x}) \\, d^{3}\\mathbf{x}$.\n\nStarting from first principles appropriate for fast Fourier transform (FFT) analysis and the convolution theorem, take as the fundamental base the following assignment-kernel constructions in one dimension:\n\n- Nearest-Grid-Point (NGP): $A_{\\mathrm{NGP}}(x)$ is a normalized top-hat of width $\\Delta$, i.e., $A_{\\mathrm{NGP}}(x) = \\Delta^{-1}$ for $|x|\\le \\Delta/2$ and $A_{\\mathrm{NGP}}(x)=0$ otherwise.\n\n- Cloud-in-Cell (CIC): $A_{\\mathrm{CIC}}(x)$ is the convolution of two NGP top-hats of width $\\Delta$.\n\n- Triangular-Shaped Cloud (TSC): $A_{\\mathrm{TSC}}(x)$ is the convolution of three NGP top-hats of width $\\Delta$.\n\nUsing these definitions and the separability of the three-dimensional kernel, derive the corresponding three-dimensional Fourier-space window functions $W_{\\mathrm{NGP}}(\\mathbf{k})$, $W_{\\mathrm{CIC}}(\\mathbf{k})$, and $W_{\\mathrm{TSC}}(\\mathbf{k})$ as analytic expressions in terms of $\\mathbf{k}$ and $\\Delta$. Then, define the power suppression factor $S(\\mathbf{k}) \\equiv |W(\\mathbf{k})|^{2}$ and evaluate the suppression factors $S_{\\mathrm{NGP}}$, $S_{\\mathrm{CIC}}$, and $S_{\\mathrm{TSC}}$ at the one-dimensional Nyquist wavenumber vector aligned with the $x$-axis, i.e., at $\\mathbf{k} = (k_{\\mathrm{N}}, 0, 0)$ with $k_{\\mathrm{N}} \\equiv \\pi/\\Delta$.\n\nProvide your final suppression factors $S_{\\mathrm{NGP}}(k_{\\mathrm{N}}\\hat{\\mathbf{x}})$, $S_{\\mathrm{CIC}}(k_{\\mathrm{N}}\\hat{\\mathbf{x}})$, and $S_{\\mathrm{TSC}}(k_{\\mathrm{N}}\\hat{\\mathbf{x}})$ as a single row matrix in exact analytic form involving $\\pi$. No rounding is required, and your answer must be dimensionless.",
            "solution": "The problem as stated is an entirely standard calculation in the field of numerical cosmology and is based on fundamental principles of Fourier analysis and signal processing. All terms are well-defined, and the premises are scientifically sound and internally consistent. The problem is valid.\n\nThe solution proceeds by first calculating the one-dimensional Fourier-space window function for the Nearest-Grid-Point (NGP) scheme, which serves as the fundamental building block. The window function $W(k)$ is the Fourier transform of the real-space assignment kernel $A(x)$. For a single dimension, let's denote the wavenumber as $k_x$. The Fourier transform is defined as $W(k_x) = \\int_{-\\infty}^{\\infty} A(x) \\exp(-\\mathrm{i} k_x x) \\, dx$.\n\nThe NGP assignment kernel is given as a normalized top-hat function:\n$$\nA_{\\mathrm{NGP}}(x) = \n\\begin{cases} \n\\frac{1}{\\Delta} & \\text{for } |x| \\le \\frac{\\Delta}{2} \\\\\n0 & \\text{otherwise}\n\\end{cases}\n$$\nThe one-dimensional window function for NGP, $W_{\\mathrm{NGP}}(k_x)$, is its Fourier transform:\n$$\nW_{\\mathrm{NGP}}(k_x) = \\int_{-\\Delta/2}^{\\Delta/2} \\frac{1}{\\Delta} \\exp(-\\mathrm{i} k_x x) \\, dx\n$$\n$$\nW_{\\mathrm{NGP}}(k_x) = \\frac{1}{\\Delta} \\left[ \\frac{\\exp(-\\mathrm{i} k_x x)}{-\\mathrm{i} k_x} \\right]_{-\\Delta/2}^{\\Delta/2} = \\frac{1}{\\Delta} \\left( \\frac{\\exp(-\\mathrm{i} k_x \\Delta/2) - \\exp(\\mathrm{i} k_x \\Delta/2)}{-\\mathrm{i} k_x} \\right)\n$$\nUsing Euler's formula, $\\sin(\\theta) = \\frac{\\exp(\\mathrm{i}\\theta) - \\exp(-\\mathrm{i}\\theta)}{2\\mathrm{i}}$, the expression in the parenthesis becomes $\\frac{-2\\mathrm{i} \\sin(k_x \\Delta/2)}{-\\mathrm{i} k_x} = \\frac{2 \\sin(k_x \\Delta/2)}{k_x}$.\n$$\nW_{\\mathrm{NGP}}(k_x) = \\frac{1}{\\Delta} \\frac{2 \\sin(k_x \\Delta/2)}{k_x} = \\frac{\\sin(k_x \\Delta/2)}{k_x \\Delta/2}\n$$\nThis is a form of the unnormalized sinc function. For brevity, let $u_x = k_x \\Delta/2$. Then, $W_{\\mathrm{NGP}}(k_x) = \\frac{\\sin(u_x)}{u_x}$.\n\nThe Cloud-in-Cell (CIC) and Triangular-Shaped Cloud (TSC) kernels are defined as convolutions of the NGP kernel. The convolution theorem states that the Fourier transform of a convolution of two functions is the product of their individual Fourier transforms.\n$$\n\\mathcal{F}[f * g] = \\mathcal{F}[f] \\cdot \\mathcal{F}[g]\n$$\nGiven $A_{\\mathrm{CIC}}(x) = A_{\\mathrm{NGP}}(x) * A_{\\mathrm{NGP}}(x)$, its window function is:\n$$\nW_{\\mathrm{CIC}}(k_x) = W_{\\mathrm{NGP}}(k_x) \\cdot W_{\\mathrm{NGP}}(k_x) = \\left( \\frac{\\sin(u_x)}{u_x} \\right)^2\n$$\nSimilarly, for TSC, $A_{\\mathrm{TSC}}(x) = A_{\\mathrm{NGP}}(x) * A_{\\mathrm{NGP}}(x) * A_{\\mathrm{NGP}}(x)$, so its window function is:\n$$\nW_{\\mathrm{TSC}}(k_x) = \\left( W_{\\mathrm{NGP}}(k_x) \\right)^3 = \\left( \\frac{\\sin(u_x)}{u_x} \\right)^3\n$$\nThe problem states that the three-dimensional kernel is separable, i.e., $A(\\mathbf{x}) = A(x)A(y)A(z)$. The three-dimensional Fourier transform is correspondingly separable:\n$$\nW(\\mathbf{k}) = W(k_x) W(k_y) W(k_z)\n$$\nLetting $u_i = k_i \\Delta/2$ for $i \\in \\{x, y, z\\}$, we have:\n$$\nW_{\\mathrm{NGP}}(\\mathbf{k}) = \\left(\\frac{\\sin(u_x)}{u_x}\\right) \\left(\\frac{\\sin(u_y)}{u_y}\\right) \\left(\\frac{\\sin(u_z)}{u_z}\\right)\n$$\n$$\nW_{\\mathrm{CIC}}(\\mathbf{k}) = \\left(\\frac{\\sin(u_x)}{u_x}\\right)^2 \\left(\\frac{\\sin(u_y)}{u_y}\\right)^2 \\left(\\frac{\\sin(u_z)}{u_z}\\right)^2\n$$\n$$\nW_{\\mathrm{TSC}}(\\mathbf{k}) = \\left(\\frac{\\sin(u_x)}{u_x}\\right)^3 \\left(\\frac{\\sin(u_y)}{u_y}\\right)^3 \\left(\\frac{\\sin(u_z)}{u_z}\\right)^3\n$$\nThe power suppression factor is defined as $S(\\mathbf{k}) = |W(\\mathbf{k})|^2$. Since all the window functions derived are real-valued, this simplifies to $S(\\mathbf{k}) = W(\\mathbf{k})^2$.\n$$\nS_{\\mathrm{NGP}}(\\mathbf{k}) = \\left[ \\left(\\frac{\\sin(u_x)}{u_x}\\right) \\left(\\frac{\\sin(u_y)}{u_y}\\right) \\left(\\frac{\\sin(u_z)}{u_z}\\right) \\right]^2\n$$\n$$\nS_{\\mathrm{CIC}}(\\mathbf{k}) = \\left[ \\left(\\frac{\\sin(u_x)}{u_x}\\right)^2 \\left(\\frac{\\sin(u_y)}{u_y}\\right)^2 \\left(\\frac{\\sin(u_z)}{u_z}\\right)^2 \\right]^2 = \\left[ \\left(\\frac{\\sin(u_x)}{u_x}\\right) \\left(\\frac{\\sin(u_y)}{u_y}\\right) \\left(\\frac{\\sin(u_z)}{u_z}\\right) \\right]^4\n$$\n$$\nS_{\\mathrm{TSC}}(\\mathbf{k}) = \\left[ \\left(\\frac{\\sin(u_x)}{u_x}\\right)^3 \\left(\\frac{\\sin(u_y)}{u_y}\\right)^3 \\left(\\frac{\\sin(u_z)}{u_z}\\right)^3 \\right]^2 = \\left[ \\left(\\frac{\\sin(u_x)}{u_x}\\right) \\left(\\frac{\\sin(u_y)}{u_y}\\right) \\left(\\frac{\\sin(u_z)}{u_z}\\right) \\right]^6\n$$\nWe must evaluate these suppression factors at the one-dimensional Nyquist wavenumber vector $\\mathbf{k} = (k_{\\mathrm{N}}, 0, 0)$, where $k_{\\mathrm{N}} = \\pi/\\Delta$.\nThe components of the wavenumber vector are $k_x = k_{\\mathrm{N}} = \\pi/\\Delta$, $k_y = 0$, and $k_z = 0$.\nWe evaluate the corresponding $u_i$ terms:\nFor the $x$-component:\n$$\nu_x = k_x \\frac{\\Delta}{2} = \\left(\\frac{\\pi}{\\Delta}\\right) \\frac{\\Delta}{2} = \\frac{\\pi}{2}\n$$\nSo, the term for the $x$-component is:\n$$\n\\frac{\\sin(u_x)}{u_x} = \\frac{\\sin(\\pi/2)}{\\pi/2} = \\frac{1}{\\pi/2} = \\frac{2}{\\pi}\n$$\nFor the $y$ and $z$ components, $k_y = 0$ and $k_z = 0$, which means $u_y = 0$ and $u_z = 0$. We must take the limit:\n$$\n\\lim_{u \\to 0} \\frac{\\sin(u)}{u} = 1\n$$\nSo, for $\\mathbf{k} = (k_{\\mathrm{N}}, 0, 0)$, the product of the three terms becomes:\n$$\n\\left(\\frac{\\sin(u_x)}{u_x}\\right) \\left(\\frac{\\sin(u_y)}{u_y}\\right) \\left(\\frac{\\sin(u_z)}{u_z}\\right) \\rightarrow \\left(\\frac{2}{\\pi}\\right) \\cdot 1 \\cdot 1 = \\frac{2}{\\pi}\n$$\nNow we can compute the suppression factors at this specific wavenumber:\nFor NGP:\n$$\nS_{\\mathrm{NGP}}(k_{\\mathrm{N}}\\hat{\\mathbf{x}}) = \\left( \\frac{2}{\\pi} \\right)^2 = \\frac{4}{\\pi^2}\n$$\nFor CIC:\n$$\nS_{\\mathrm{CIC}}(k_{\\mathrm{N}}\\hat{\\mathbf{x}}) = \\left( \\frac{2}{\\pi} \\right)^4 = \\frac{16}{\\pi^4}\n$$\nFor TSC:\n$$\nS_{\\mathrm{TSC}}(k_{\\mathrm{N}}\\hat{\\mathbf{x}}) = \\left( \\frac{2}{\\pi} \\right)^6 = \\frac{64}{\\pi^6}\n$$\nThese are the final answers, presented as a row matrix as requested.",
            "answer": "$$\n\\boxed{\\begin{pmatrix} \\frac{4}{\\pi^2} & \\frac{16}{\\pi^4} & \\frac{64}{\\pi^6} \\end{pmatrix}}\n$$"
        }
    ]
}