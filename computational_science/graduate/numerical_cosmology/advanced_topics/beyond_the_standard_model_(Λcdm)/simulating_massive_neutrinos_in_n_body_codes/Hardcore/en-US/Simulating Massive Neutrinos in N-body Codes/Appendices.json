{
    "hands_on_practices": [
        {
            "introduction": "A fundamental challenge in $N$-body simulations is representing a continuous fluid, such as the cosmic neutrino background, with a finite number of discrete particles. This discretization inevitably introduces Poisson shot noise, a numerical artifact that can obscure the physical clustering signal. This exercise provides a concrete method for establishing a simulation's \"noise budget\" by calculating the minimum particle number density required to keep shot noise subdominant to the linear theory power spectrum at a given scale, a critical first step in designing any reliable cosmological simulation .",
            "id": "3487724",
            "problem": "In a gravity-only $N$-body simulation, the massive neutrino component is represented by equal-mass particles that Poisson-sample the linear neutrino density field. For a periodic cubic box of comoving side length $L=1~h^{-1}~\\mathrm{Gpc}$ at redshift $z=0$, with a summed neutrino mass $\\sum m_{\\nu}=0.15~\\mathrm{eV}$, you want the neutrino particle shot noise power at wavenumber $k=0.5~h~\\mathrm{Mpc}^{-1}$ to be at most a fraction $0.10$ of the linear neutrino auto power spectrum at that scale. The Poisson shot noise power for a particle number density $n_{\\nu,\\mathrm{part}}$ is $P_{\\mathrm{shot}}=1/n_{\\nu,\\mathrm{part}}$. Assume a fiducial flat $\\Lambda$CDM cosmology in which a linear Einstein–Boltzmann solver (such as CLASS or CAMB) yields the linear neutrino auto power at $z=0$ for $\\sum m_{\\nu}=0.15~\\mathrm{eV}$ as $P_{\\nu}^{\\mathrm{lin}}(k=0.5~h~\\mathrm{Mpc}^{-1},z=0)=6.0~h^{-3}~\\mathrm{Mpc}^{3}$. Using only these fundamental definitions and facts, compute the minimum neutrino particle number density $n_{\\nu,\\mathrm{part}}$ required to satisfy the shot noise criterion at $k=0.5~h~\\mathrm{Mpc}^{-1}$. Round your answer to three significant figures and express it in units of $h^{3}~\\mathrm{Mpc}^{-3}$.",
            "solution": "The problem is validated by first extracting all given information and then checking it against criteria for scientific soundness, completeness, and consistency.\n\n**Step 1: Extract Givens**\n- Simulation setup: Gravity-only $N$-body simulation in a periodic cubic box.\n- Comoving side length of the box: $L=1~h^{-1}~\\mathrm{Gpc}$.\n- Redshift: $z=0$.\n- Summed neutrino mass: $\\sum m_{\\nu}=0.15~\\mathrm{eV}$.\n- Neutrino particle representation: Equal-mass particles that Poisson-sample the linear neutrino density field.\n- Wavenumber of interest: $k=0.5~h~\\mathrm{Mpc}^{-1}$.\n- Constraint on shot noise: The neutrino particle shot noise power, $P_{\\mathrm{shot}}$, must be at most a fraction $0.10$ of the linear neutrino auto power spectrum, $P_{\\nu}^{\\mathrm{lin}}$.\n- Definition of shot noise power: $P_{\\mathrm{shot}} = 1/n_{\\nu,\\mathrm{part}}$, where $n_{\\nu,\\mathrm{part}}$ is the neutrino particle number density.\n- Value of the linear neutrino auto power spectrum: $P_{\\nu}^{\\mathrm{lin}}(k=0.5~h~\\mathrm{Mpc}^{-1},z=0)=6.0~h^{-3}~\\mathrm{Mpc}^{3}$.\n- Required output: The minimum value of $n_{\\nu,\\mathrm{part}}$ in units of $h^{3}~\\mathrm{Mpc}^{-3}$, rounded to three significant figures.\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is assessed to be valid based on the following analysis:\n- **Scientifically Grounded:** The problem deals with standard concepts in numerical cosmology. The method described, representing massive neutrinos as a set of particles in an $N$-body simulation, is a common technique. The definition of Poisson shot noise power, $P_{\\mathrm{shot}}=1/n$, is a fundamental result from statistics and is correctly applied in this context. The numerical value for the linear power spectrum is physically reasonable for the given cosmological parameters ($\\sum m_{\\nu}=0.15~\\mathrm{eV}$, $z=0$, $k=0.5~h~\\mathrm{Mpc}^{-1}$).\n- **Well-Posed:** The problem provides all necessary information to establish a mathematical inequality and solve for the minimum required particle density. The objective is clearly stated, and a unique solution exists.\n- **Objective:** The problem is phrased in precise, objective, and technical language, free from any subjective or biased statements.\n- **Incomplete or Contradictory Setup:** The problem is self-contained and consistent. Although parameters like $L$, $z$, and $\\sum m_{\\nu}$ are not directly used in the final calculation step, they provide the necessary physical context for the given power spectrum value, $P_{\\nu}^{\\mathrm{lin}}$. This does not represent an underspecified or overconstrained setup but rather a well-defined one. The units are dimensionally consistent: power spectra have units of volume ($h^{-3}~\\mathrm{Mpc}^{3}$) and particle number density has units of inverse volume ($h^{3}~\\mathrm{Mpc}^{-3}$), consistent with the relation $P_{\\mathrm{shot}}=1/n_{\\nu,\\mathrm{part}}$.\n\n**Step 3: Verdict and Action**\nThe problem is valid. A solution will be derived.\n\n**Solution Derivation**\nThe problem requires that the shot noise power from the discrete neutrino particles, $P_{\\mathrm{shot}}$, is no more than a certain fraction of the true linear power spectrum of the neutrinos, $P_{\\nu}^{\\mathrm{lin}}$, at a specific wavenumber $k$.\n\nThe specified constraint is given by the inequality:\n$$P_{\\mathrm{shot}} \\leq f \\cdot P_{\\nu}^{\\mathrm{lin}}(k)$$\nwhere the fraction is $f=0.10$.\n\nThe problem states that the shot noise power for a particle distribution with number density $n_{\\nu,\\mathrm{part}}$ is given by:\n$$P_{\\mathrm{shot}} = \\frac{1}{n_{\\nu,\\mathrm{part}}}$$\n\nSubstituting this definition into the constraint inequality yields:\n$$\\frac{1}{n_{\\nu,\\mathrm{part}}} \\leq f \\cdot P_{\\nu}^{\\mathrm{lin}}(k)$$\n\nTo satisfy this inequality, the particle number density $n_{\\nu,\\mathrm{part}}$ must be sufficiently large. We can rearrange the inequality to solve for $n_{\\nu,\\mathrm{part}}$:\n$$n_{\\nu,\\mathrm{part}} \\geq \\frac{1}{f \\cdot P_{\\nu}^{\\mathrm{lin}}(k)}$$\n\nThe problem asks for the minimum required neutrino particle number density, which we denote as $n_{\\nu,\\mathrm{part,min}}$. This minimum density corresponds to the case where the inequality becomes an equality, representing the maximum tolerable shot noise:\n$$n_{\\nu,\\mathrm{part,min}} = \\frac{1}{f \\cdot P_{\\nu}^{\\mathrm{lin}}(k)}$$\n\nWe are given the following values:\n- The fraction $f = 0.10$.\n- The linear neutrino auto power spectrum at $k = 0.5~h~\\mathrm{Mpc}^{-1}$ is $P_{\\nu}^{\\mathrm{lin}}(k=0.5~h~\\mathrm{Mpc}^{-1}, z=0) = 6.0~h^{-3}~\\mathrm{Mpc}^{3}$.\n\nNow we substitute these values into the expression for $n_{\\nu,\\mathrm{part,min}}$:\n$$n_{\\nu,\\mathrm{part,min}} = \\frac{1}{0.10 \\times 6.0~h^{-3}~\\mathrm{Mpc}^{3}}$$\n\nFirst, calculate the product in the denominator:\n$$0.10 \\times 6.0~h^{-3}~\\mathrm{Mpc}^{3} = 0.60~h^{-3}~\\mathrm{Mpc}^{3}$$\n\nNow, compute the minimum density:\n$$n_{\\nu,\\mathrm{part,min}} = \\frac{1}{0.60~h^{-3}~\\mathrm{Mpc}^{3}} = \\left(\\frac{1}{0.60}\\right) h^{3}~\\mathrm{Mpc}^{-3}$$\n\nCalculating the numerical coefficient:\n$$\\frac{1}{0.60} = \\frac{1}{6/10} = \\frac{10}{6} = \\frac{5}{3} \\approx 1.666...$$\n\nThe problem requires the answer to be rounded to three significant figures.\n$$n_{\\nu,\\mathrm{part,min}} \\approx 1.67~h^{3}~\\mathrm{Mpc}^{-3}$$\n\nThus, the minimum neutrino particle number density required to meet the shot noise criterion is $1.67~h^{3}~\\mathrm{Mpc}^{-3}$.",
            "answer": "$$\\boxed{1.67}$$"
        },
        {
            "introduction": "Beyond controlling initial noise, accurately evolving particle trajectories is paramount. Massive neutrinos, with their significant thermal velocities, move much faster than cold dark matter particles, posing a stringent challenge for the time integration scheme. This practice delves into the dynamics of the simulation run, guiding you to derive a constraint on the maximum time step size that ensures the rapid motion of neutrinos is resolved faithfully, preventing the accumulation of numerical errors that could spoil the simulation's physical accuracy .",
            "id": "3487733",
            "problem": "In a cosmological $N$-body simulation that represents massive neutrinos as particles, the canonical peculiar momentum is defined as $u \\equiv a\\,v$, where $a$ is the scale factor and $v$ is the physical peculiar speed. The update (“kick”) of $u$ is driven by the comoving gravitational potential $\\Phi$ through Newton’s second law in an expanding background:\n$$\n\\frac{d u}{d t} = -\\nabla \\Phi,\n$$\nwith the Hubble friction absorbed by $u$. The time variable advanced by the integrator is the scale factor $a$, so that $dt = da/(a H)$, where $H(a)$ is the Hubble expansion rate.\n\nYou will determine a step-size constraint at the initial redshift $z_{\\mathrm{init}}$ (with $a_{\\mathrm{init}} \\equiv 1/(1+z_{\\mathrm{init}})$) that guarantees the fractional change in neutrino speed over one kick satisfies $\\Delta v / v  \\epsilon_{v}$ with $\\epsilon_{v}=0.01$. Assume:\n\n- The “target force accuracy” of the Particle-Mesh (PM) solver is a fractional force error $\\epsilon_{F}$ at a chosen comoving wavenumber $k_{\\mathrm{typ}}$, so that the maximum comoving gradient driving a spurious kick can be bounded as $|\\nabla \\Phi|_{\\max} = \\epsilon_{F}\\,|\\nabla \\Phi|_{\\mathrm{lin}}(k_{\\mathrm{typ}},a_{\\mathrm{init}})$, where $|\\nabla \\Phi|_{\\mathrm{lin}}$ is the linear-theory amplitude.\n- The linear-theory gravitational potential obeys the Poisson equation in Fourier space, $k^{2}\\Phi(k,a)=4\\pi G a^{2}\\rho_{m}(a)\\,\\delta_{m}(k,a)$, with $\\rho_{m}(a)=\\Omega_{m}\\rho_{\\mathrm{crit},0}a^{-3}$ and $\\rho_{\\mathrm{crit},0}=3H_{0}^{2}/(8\\pi G)$, where $\\Omega_{m}$ is the present-day matter density parameter and $H_{0}$ is the present-day Hubble constant. For a single mode of wavenumber $k_{\\mathrm{typ}}$ and linear density contrast amplitude $\\delta_{\\mathrm{lin}}(k_{\\mathrm{typ}},a_{\\mathrm{init}})$, approximate the comoving gradient amplitude as $|\\nabla \\Phi|_{\\mathrm{lin}} \\simeq 4\\pi G a^{2}\\rho_{m}\\delta_{\\mathrm{lin}}/k_{\\mathrm{typ}}$.\n- The typical neutrino thermal speed at $a_{\\mathrm{init}}$ is given by the Fermi–Dirac mean-momentum estimate. Denote the present-day Cosmic Microwave Background (CMB) temperature as $T_{\\gamma 0}$ and the present-day neutrino temperature as $T_{\\nu 0} = \\left(\\frac{4}{11}\\right)^{1/3}T_{\\gamma 0}$. The neutrino temperature scales as $T_{\\nu}(a)=T_{\\nu 0}/a$, and the thermal energy scale is $E_{\\mathrm{th}}(a)=3.151\\,k_{B}T_{\\nu}(a)$. For a neutrino of mass $m_{\\nu}$, take\n$$\nv_{\\mathrm{th}}(a)=c\\,\\frac{E_{\\mathrm{th}}(a)}{\\sqrt{\\left(m_{\\nu}c^{2}\\right)^{2}+E_{\\mathrm{th}}(a)^{2}}}.\n$$\n\nWorking at $a_{\\mathrm{init}}$, require that the kick implied by the maximal comoving gradient $|\\nabla \\Phi|_{\\max}$ changes the neutrino speed by less than $\\epsilon_{v}$ times its typical thermal speed. Derive and report a single closed-form analytic expression for the maximal acceptable scale-factor step $\\Delta a_{\\max}$ in terms of the symbols $a_{\\mathrm{init}}$, $H(a_{\\mathrm{init}})$, $\\Omega_{m}$, $H_{0}$, $k_{\\mathrm{typ}}$, $\\epsilon_{F}$, $\\delta_{\\mathrm{lin}}(k_{\\mathrm{typ}},a_{\\mathrm{init}})$, $m_{\\nu}$, $k_{B}$, $T_{\\gamma 0}$, and $c$. The final answer must be a single analytical expression for $\\Delta a_{\\max}$ with no units included inside the final answer box. Do not substitute any numerical values.",
            "solution": "The problem as stated will first be subjected to a rigorous validation process.\n\n### Step 1: Extract Givens\nThe following quantities and relations are provided in the problem statement:\n- Canonical peculiar momentum definition: $u \\equiv a\\,v$.\n- Equation of motion for canonical momentum: $\\frac{d u}{d t} = -\\nabla \\Phi$.\n- Relation between time and scale factor differentials: $dt = da/(a H)$.\n- Step-size constraint criterion: The fractional change in speed $\\Delta v / v  \\epsilon_{v}$, with $\\epsilon_{v} = 0.01$. This is specified as the change in neutrino speed due to a kick, $\\Delta v$, must be less than $\\epsilon_{v}$ times its typical thermal speed, $v_{\\mathrm{th}}$.\n- Initial condition is at redshift $z_{\\mathrm{init}}$, corresponding to scale factor $a_{\\mathrm{init}} = 1/(1+z_{\\mathrm{init}})$.\n- Maximum comoving gradient from spurious force: $|\\nabla \\Phi|_{\\max} = \\epsilon_{F}\\,|\\nabla \\Phi|_{\\mathrm{lin}}(k_{\\mathrm{typ}},a_{\\mathrm{init}})$, where $\\epsilon_F$ is the fractional force error.\n- Linear-theory gravitational potential from Poisson equation: $k^{2}\\Phi(k,a)=4\\pi G a^{2}\\rho_{m}(a)\\,\\delta_{m}(k,a)$.\n- Matter density scaling: $\\rho_{m}(a)=\\Omega_{m}\\rho_{\\mathrm{crit},0}a^{-3}$.\n- Present-day critical density: $\\rho_{\\mathrm{crit},0}=3H_{0}^{2}/(8\\pi G)$.\n- Approximation for the comoving gradient amplitude: $|\\nabla \\Phi|_{\\mathrm{lin}} \\simeq 4\\pi G a^{2}\\rho_{m}\\delta_{\\mathrm{lin}}/k_{\\mathrm{typ}}$ for a single mode with wavenumber $k_{\\mathrm{typ}}$ and density contrast $\\delta_{\\mathrm{lin}}(k_{\\mathrm{typ}},a_{\\mathrm{init}})$.\n- Neutrino thermal speed model: $v_{\\mathrm{th}}(a)=c\\,\\frac{E_{\\mathrm{th}}(a)}{\\sqrt{\\left(m_{\\nu}c^{2}\\right)^{2}+E_{\\mathrm{th}}(a)^{2}}}$.\n- Neutrino thermal energy scale: $E_{\\mathrm{th}}(a)=3.151\\,k_{B}T_{\\nu}(a)$.\n- Neutrino temperature scaling: $T_{\\nu}(a)=T_{\\nu 0}/a$.\n- Present-day neutrino temperature: $T_{\\nu 0} = \\left(\\frac{4}{11}\\right)^{1/3}T_{\\gamma 0}$, where $T_{\\gamma 0}$ is the present-day CMB temperature.\n- The desired output is an expression for the maximal scale-factor step, $\\Delta a_{\\max}$, in terms of the symbols: $a_{\\mathrm{init}}$, $H(a_{\\mathrm{init}})$, $\\Omega_{m}$, $H_{0}$, $k_{\\mathrm{typ}}$, $\\epsilon_{F}$, $\\delta_{\\mathrm{lin}}(k_{\\mathrm{typ}},a_{\\mathrm{init}})$, $m_{\\nu}$, $k_{B}$, $T_{\\gamma 0}$, and $c$.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is scientifically grounded, drawing upon standard equations and concepts from modern physical cosmology and numerical methods for N-body simulations. The definitions of canonical momentum, the leapfrog integration scheme (implied by the \"kick\" terminology), the Poisson equation, and the relations for cosmological densities are all standard. The model for neutrino thermal velocity is a correct relativistic expression. All terms are clearly defined, and the relationships are physically and mathematically consistent. The problem is well-posed, providing a clear objective and sufficient information to derive a unique analytical solution. The language is objective and formal. No scientific, logical, or structural flaws are detected.\n\n### Step 3: Verdict and Action\nThe problem is valid. A complete solution will be derived.\n\n### Derivation of the Step-Size Constraint\nThe objective is to find the maximum scale-factor step $\\Delta a_{\\max}$ such that the change in a neutrino's physical speed, $\\Delta v$, from a single spurious force kick is less than a fraction $\\epsilon_{v}$ of its typical thermal speed $v_{\\mathrm{th}}$. The condition is specified at the initial scale factor $a_{\\mathrm{init}}$.\nThe constraint is:\n$$\n|\\Delta \\vec{v}|  \\epsilon_{v} v_{\\mathrm{th}}(a_{\\mathrm{init}})\n$$\nwhere we interpret the \"change in speed\" as the magnitude of the change in the velocity vector, $|\\Delta \\vec{v}|$, which is the most conservative choice. The given numerical value is $\\epsilon_{v} = 0.01$.\n\nIn a leapfrog integration scheme, a \"kick\" is an instantaneous change in momentum at a fixed time (and thus fixed scale factor $a$). The change in canonical momentum $\\vec{u}$ over a time step $\\Delta t$ is given by integrating the equation of motion:\n$$\n\\Delta \\vec{u} = \\int \\frac{d\\vec{u}}{dt} dt \\approx \\frac{d\\vec{u}}{dt} \\Delta t = -(\\nabla \\Phi) \\Delta t\n$$\nThe magnitude of this change, caused by the maximum spurious force, is:\n$$\n|\\Delta \\vec{u}| = |\\nabla \\Phi|_{\\max} \\Delta t\n$$\nThe physical peculiar velocity is $\\vec{v} = \\vec{u}/a$. Since the kick is instantaneous at $a=a_{\\mathrm{init}}$, the change in physical velocity is:\n$$\n|\\Delta \\vec{v}| = \\frac{|\\Delta \\vec{u}|}{a_{\\mathrm{init}}} = \\frac{|\\nabla \\Phi|_{\\max} \\Delta t}{a_{\\mathrm{init}}}\n$$\nThe time step $\\Delta t$ is related to the scale factor step $\\Delta a$ by $\\Delta t = \\Delta a / (a H)$. At $a_{\\mathrm{init}}$, this is $\\Delta t = \\Delta a / (a_{\\mathrm{init}} H(a_{\\mathrm{init}}))$. Substituting this into the expression for $|\\Delta \\vec{v}|$:\n$$\n|\\Delta \\vec{v}| = \\frac{|\\nabla \\Phi|_{\\max}}{a_{\\mathrm{init}}} \\frac{\\Delta a}{a_{\\mathrm{init}} H(a_{\\mathrm{init}})} = \\frac{|\\nabla \\Phi|_{\\max} \\Delta a}{a_{\\mathrm{init}}^2 H(a_{\\mathrm{init}})}\n$$\nNow, we apply the constraint $|\\Delta \\vec{v}|  \\epsilon_{v} v_{\\mathrm{th}}(a_{\\mathrm{init}})$ and solve for the maximum step size $\\Delta a_{\\max}$:\n$$\n\\frac{|\\nabla \\Phi|_{\\max} \\Delta a_{\\max}}{a_{\\mathrm{init}}^2 H(a_{\\mathrm{init}})} = \\epsilon_{v} v_{\\mathrm{th}}(a_{\\mathrm{init}})\n$$\n$$\n\\Delta a_{\\max} = \\frac{\\epsilon_{v} v_{\\mathrm{th}}(a_{\\mathrm{init}}) a_{\\mathrm{init}}^2 H(a_{\\mathrm{init}})}{|\\nabla \\Phi|_{\\max}}\n$$\nNext, we substitute the given expressions for $|\\nabla \\Phi|_{\\max}$ and $v_{\\mathrm{th}}(a_{\\mathrm{init}})$.\n\nFirst, the maximum spurious potential gradient at $a_{\\mathrm{init}}$:\n$$\n|\\nabla \\Phi|_{\\max} = \\epsilon_{F}\\,|\\nabla \\Phi|_{\\mathrm{lin}}(k_{\\mathrm{typ}},a_{\\mathrm{init}})\n$$\nUsing the provided approximation for $|\\nabla \\Phi|_{\\mathrm{lin}}$:\n$$\n|\\nabla \\Phi|_{\\mathrm{lin}} \\simeq \\frac{4\\pi G a_{\\mathrm{init}}^{2}\\rho_{m}(a_{\\mathrm{init}})\\delta_{\\mathrm{lin}}(k_{\\mathrm{typ}},a_{\\mathrm{init}})}{k_{\\mathrm{typ}}}\n$$\nWe substitute $\\rho_{m}(a_{\\mathrm{init}}) = \\Omega_{m}\\rho_{\\mathrm{crit},0}a_{\\mathrm{init}}^{-3}$ and $\\rho_{\\mathrm{crit},0}=3H_{0}^{2}/(8\\pi G)$:\n$$\n|\\nabla \\Phi|_{\\mathrm{lin}} \\simeq \\frac{4\\pi G a_{\\mathrm{init}}^{2}}{k_{\\mathrm{typ}}} \\left( \\Omega_{m} \\frac{3H_{0}^{2}}{8\\pi G} a_{\\mathrm{init}}^{-3} \\right) \\delta_{\\mathrm{lin}}(k_{\\mathrm{typ}},a_{\\mathrm{init}}) = \\frac{3 \\Omega_{m} H_{0}^{2} \\delta_{\\mathrm{lin}}(k_{\\mathrm{typ}},a_{\\mathrm{init}})}{2 k_{\\mathrm{typ}} a_{\\mathrm{init}}}\n$$\nSo, the maximum spurious gradient is:\n$$\n|\\nabla \\Phi|_{\\max} = \\epsilon_{F} \\frac{3 \\Omega_{m} H_{0}^{2} \\delta_{\\mathrm{lin}}(k_{\\mathrm{typ}},a_{\\mathrm{init}})}{2 k_{\\mathrm{typ}} a_{\\mathrm{init}}}\n$$\n\nSecond, the neutrino thermal speed $v_{\\mathrm{th}}(a_{\\mathrm{init}})$. The thermal energy at $a_{\\mathrm{init}}$ is:\n$$\nE_{\\mathrm{th}}(a_{\\mathrm{init}}) = 3.151\\,k_{B}T_{\\nu}(a_{\\mathrm{init}}) = 3.151\\,k_{B}\\frac{T_{\\nu 0}}{a_{\\mathrm{init}}} = \\frac{3.151\\,k_{B}}{a_{\\mathrm{init}}} \\left(\\frac{4}{11}\\right)^{1/3}T_{\\gamma 0}\n$$\nThe thermal speed is therefore:\n$$\nv_{\\mathrm{th}}(a_{\\mathrm{init}}) = c\\,\\frac{E_{\\mathrm{th}}(a_{\\mathrm{init}})}{\\sqrt{\\left(m_{\\nu}c^{2}\\right)^{2} + E_{\\mathrm{th}}(a_{\\mathrm{init}})^{2}}}\n$$\n\nWe now substitute these expressions for $|\\nabla \\Phi|_{\\max}$ and $v_{\\mathrm{th}}(a_{\\mathrm{init}})$ into the equation for $\\Delta a_{\\max}$:\n$$\n\\Delta a_{\\max} = \\frac{\\epsilon_{v} a_{\\mathrm{init}}^2 H(a_{\\mathrm{init}})}{\\epsilon_{F} \\frac{3 \\Omega_{m} H_{0}^{2} \\delta_{\\mathrm{lin}}(k_{\\mathrm{typ}},a_{\\mathrm{init}})}{2 k_{\\mathrm{typ}} a_{\\mathrm{init}}}} \\left( c\\,\\frac{E_{\\mathrm{th}}(a_{\\mathrm{init}})}{\\sqrt{\\left(m_{\\nu}c^{2}\\right)^{2} + E_{\\mathrm{th}}(a_{\\mathrm{init}})^{2}}} \\right)\n$$\nSimplifying the first part:\n$$\n\\Delta a_{\\max} = \\frac{2 \\epsilon_{v} k_{\\mathrm{typ}} a_{\\mathrm{init}}^3 H(a_{\\mathrm{init}})}{3 \\epsilon_{F} \\Omega_{m} H_{0}^{2} \\delta_{\\mathrm{lin}}(k_{\\mathrm{typ}},a_{\\mathrm{init}})} \\left( c\\,\\frac{E_{\\mathrm{th}}(a_{\\mathrm{init}})}{\\sqrt{\\left(m_{\\nu}c^{2}\\right)^{2} + E_{\\mathrm{th}}(a_{\\mathrm{init}})^{2}}} \\right)\n$$\nSubstitute the full expression for $E_{\\mathrm{th}}(a_{\\mathrm{init}})$:\n$$\n\\Delta a_{\\max} = \\frac{2 \\epsilon_{v} k_{\\mathrm{typ}} a_{\\mathrm{init}}^3 H(a_{\\mathrm{init}}) c}{3 \\epsilon_{F} \\Omega_{m} H_{0}^{2} \\delta_{\\mathrm{lin}}(k_{\\mathrm{typ}},a_{\\mathrm{init}})} \\frac{\\frac{3.151\\,k_{B}}{a_{\\mathrm{init}}} \\left(\\frac{4}{11}\\right)^{1/3}T_{\\gamma 0}}{\\sqrt{\\left(m_{\\nu}c^{2}\\right)^{2} + \\left(\\frac{3.151\\,k_{B}}{a_{\\mathrm{init}}} \\left(\\frac{4}{11}\\right)^{1/3}T_{\\gamma 0}\\right)^{2}}}\n$$\nLet's simplify the denominator of the second fraction:\n$$\n\\sqrt{\\left(m_{\\nu}c^{2}\\right)^{2} + \\left(\\frac{3.151\\,k_{B}}{a_{\\mathrm{init}}} \\left(\\frac{4}{11}\\right)^{1/3}T_{\\gamma 0}\\right)^{2}} = \\frac{1}{a_{\\mathrm{init}}}\\sqrt{\\left(m_{\\nu}c^{2}a_{\\mathrm{init}}\\right)^{2} + \\left(3.151\\,k_{B} \\left(\\frac{4}{11}\\right)^{1/3}T_{\\gamma 0}\\right)^{2}}\n$$\nSubstituting this back into the expression for $\\Delta a_{\\max}$ allows cancellation of the $1/a_{\\mathrm{init}}$ term:\n$$\n\\Delta a_{\\max} = \\frac{2 \\epsilon_{v} k_{\\mathrm{typ}} a_{\\mathrm{init}}^3 H(a_{\\mathrm{init}}) c}{3 \\epsilon_{F} \\Omega_{m} H_{0}^{2} \\delta_{\\mathrm{lin}}(k_{\\mathrm{typ}},a_{\\mathrm{init}})} \\frac{3.151\\,k_{B} \\left(\\frac{4}{11}\\right)^{1/3}T_{\\gamma 0}}{\\sqrt{\\left(m_{\\nu}c^{2}a_{\\mathrm{init}}\\right)^{2} + \\left(3.151\\,k_{B} \\left(\\frac{4}{11}\\right)^{1/3}T_{\\gamma 0}\\right)^{2}}}\n$$\nFinally, we substitute the given numerical value $\\epsilon_{v} = 0.01$. The problem requires a single closed-form expression. Grouping the constants and variables yields the final result.\n$$\n\\Delta a_{\\max} = \\frac{2 \\cdot (0.01) \\cdot 3.151 \\cdot a_{\\mathrm{init}}^{3} H(a_{\\mathrm{init}}) k_{\\mathrm{typ}} c k_{B} T_{\\gamma 0} \\left(\\frac{4}{11}\\right)^{1/3}}{3 \\epsilon_{F} \\Omega_{m} H_{0}^{2} \\delta_{\\mathrm{lin}}(k_{\\mathrm{typ}},a_{\\mathrm{init}}) \\sqrt{\\left(m_{\\nu}c^{2}a_{\\mathrm{init}}\\right)^{2} + \\left(3.151 k_B \\left(\\frac{4}{11}\\right)^{1/3}T_{\\gamma 0}\\right)^{2}}}\n$$\nThis is the required expression for the maximum scale-factor step.",
            "answer": "$$\n\\boxed{\\frac{2 \\cdot 0.01 \\cdot 3.151 \\cdot a_{\\mathrm{init}}^{3} H(a_{\\mathrm{init}}) k_{\\mathrm{typ}} c k_{B} T_{\\gamma 0} \\left(\\frac{4}{11}\\right)^{1/3}}{3 \\epsilon_{F} \\Omega_{m} H_{0}^{2} \\delta_{\\mathrm{lin}}(k_{\\mathrm{typ}},a_{\\mathrm{init}}) \\sqrt{\\left(m_{\\nu}c^{2}a_{\\mathrm{init}}\\right)^{2} + \\left(3.151 k_B \\left(\\frac{4}{11}\\right)^{1/3}T_{\\gamma 0}\\right)^{2}}}}\n$$"
        },
        {
            "introduction": "The ultimate test of any numerical simulation is a rigorous assessment of its convergence, ensuring that the results are not artifacts of the chosen resolution. This final practice synthesizes the concepts of particle sampling, force resolution, and time integration into a comprehensive framework for a resolution study. By building an analytical model that incorporates various sources of numerical error, you will learn how to systematically quantify the impact of simulation parameters on key scientific observables, such as the matter power spectrum and halo abundances, and determine whether they meet a specified precision goal .",
            "id": "3487741",
            "problem": "You are tasked with constructing a principled resolution study for simulating massive neutrinos within Particle-Mesh (PM) $N$-body codes in numerical cosmology. The study must vary PM grid size, particle numbers for Cold Dark Matter (CDM) and neutrinos, and time-stepping, and must define convergence metrics at the $1\\%$ level for the CDM auto power spectrum $P_{cc}(k)$, the total matter power spectrum $P_{mm}(k)$, and halo statistics. The objective is to formalize the problem in purely mathematical terms that can be solved algorithmically.\n\nYou must implement the following scientifically grounded framework, beginning from fundamental principles and well-tested formulas, without providing shortcut results:\n\n1. Define a cubic simulation box of side length $L$ in $\\mathrm{Mpc}/h$, with a uniform PM grid of size $N_g$ (cells per side). The PM cell size is $a = L/N_g$ in $\\mathrm{Mpc}/h$. The Nyquist wavenumber is $k_{\\mathrm{N}} = \\pi/a$ in $h\\,\\mathrm{Mpc}^{-1}$.\n\n2. Consider CDM and neutrino fluids represented by particles with numbers $N_{c}$ and $N_{\\nu}$, respectively. Define the neutrino mass fraction $f_{\\nu} \\equiv \\Omega_{\\nu}/\\Omega_{m}$ and the CDM fraction $f_{c} = 1 - f_{\\nu}$, where $\\Omega_{m}$ is the total matter density parameter. Use Hubble parameter $h$ to convert between units.\n\n3. Use the cosmic mean matter density at redshift $z=0$, given by $\\rho_{m} = 2.775 \\times 10^{11}\\, h^{2}\\,\\Omega_{m}\\,M_{\\odot}\\,\\mathrm{Mpc}^{-3}$. The box volume in physical units is $V_{\\mathrm{Mpc}} = (L/h)^{3}$ in $\\mathrm{Mpc}^{3}$ and in code units is $V = L^{3}$ in $(\\mathrm{Mpc}/h)^{3}$. The CDM particle mass is $m_{p,c} = f_{c}\\,\\rho_{m}\\,V_{\\mathrm{Mpc}}/N_{c}$ in $M_{\\odot}$.\n\n4. Model the true CDM linear theory power spectrum as a smooth monotonic function\n$$\nP_{cc}^{\\mathrm{true}}(k) = A\\,\\frac{k^{n_{s}}}{1 + \\left(\\frac{k}{k_{0}}\\right)^{\\alpha}},\n$$\nwith $A0$, $n_{s}0$, $\\alpha0$, and $k_{0}0$ constants. The total matter true power is\n$$\nP_{mm}^{\\mathrm{true}}(k) = P_{cc}^{\\mathrm{true}}(k)\\left(f_{c} + f_{\\nu}\\,S_{\\nu}(k)\\right)^{2},\n$$\nwhere the neutrino transfer suppression is modeled as\n$$\nS_{\\nu}(k) = \\frac{1}{1 + \\left(\\frac{k}{k_{\\mathrm{fs}}}\\right)^{2}}, \\quad k_{\\mathrm{fs}} = 0.8\\,\\left(\\sum m_{\\nu}/\\mathrm{eV}\\right)\\,h\\,\\mathrm{Mpc}^{-1}.\n$$\n\n5. Include the following numerical error sources in the measured spectra:\n   - Particle shot noise for CDM and neutrinos,\n     $$\n     P_{\\mathrm{shot},c} = \\frac{V}{N_{c}}, \\quad P_{\\mathrm{shot},\\nu} = \\frac{V}{N_{\\nu}}.\n     $$\n   - PM force-resolution suppression modeled by a mesh transfer error,\n     $$\n     \\varepsilon_{\\mathrm{PM}}(k) = b_{\\mathrm{PM}}\\,\\left(\\frac{k}{k_{\\mathrm{N}}}\\right)^{2},\n     $$\n     with $b_{\\mathrm{PM}}$ a small dimensionless constant.\n   - Time-stepping error modeled as a global second-order integration bias,\n     $$\n     \\varepsilon_{\\mathrm{ts}} = \\frac{c_{\\mathrm{ts}}}{N_{t}^{2}},\n     $$\n     with $c_{\\mathrm{ts}}$ a dimensionless constant and $N_{t}$ the number of time steps.\n\n   Define a combined multiplicative transfer factor\n   $$\n   Q(k) = 1 - \\varepsilon_{\\mathrm{PM}}(k) - \\varepsilon_{\\mathrm{ts}}.\n   $$\n   Then construct the measured spectra\n   $$\n   P_{cc}^{\\mathrm{meas}}(k) = P_{cc}^{\\mathrm{true}}(k)\\,Q(k) + P_{\\mathrm{shot},c},\n   $$\n   $$\n   P_{\\nu\\nu}^{\\mathrm{meas}}(k) = P_{cc}^{\\mathrm{true}}(k)\\,S_{\\nu}^{2}(k)\\,Q(k) + P_{\\mathrm{shot},\\nu},\n   $$\n   $$\n   P_{c\\nu}^{\\mathrm{meas}}(k) = P_{cc}^{\\mathrm{true}}(k)\\,S_{\\nu}(k)\\,Q(k),\n   $$\n   and\n   $$\n   P_{mm}^{\\mathrm{meas}}(k) = f_{c}^{2}\\,P_{cc}^{\\mathrm{meas}}(k) + 2 f_{c} f_{\\nu}\\,P_{c\\nu}^{\\mathrm{meas}}(k) + f_{\\nu}^{2}\\,P_{\\nu\\nu}^{\\mathrm{meas}}(k).\n   $$\n\n6. Evaluate spectra over the fixed physical wavenumber range $k \\in [0.05, 0.7]\\,h\\,\\mathrm{Mpc}^{-1}$ sampled at $N_{k}$ points. For any $k$ that exceeds $0.8\\,k_{\\mathrm{N}}$, declare that mode unresolved and set its fractional error to $1.0$ for the purposes of the convergence metric.\n\n7. Define spectral convergence metrics by the maximum absolute fractional deviation over the evaluation band:\n   $$\n   \\Delta_{cc} = \\max_{k}\\left|\\frac{P_{cc}^{\\mathrm{meas}}(k) - P_{cc}^{\\mathrm{true}}(k)}{P_{cc}^{\\mathrm{true}}(k)}\\right|,\n   \\quad\n   \\Delta_{mm} = \\max_{k}\\left|\\frac{P_{mm}^{\\mathrm{meas}}(k) - P_{mm}^{\\mathrm{true}}(k)}{P_{mm}^{\\mathrm{true}}(k)}\\right|.\n   $$\n   Spectral convergence at the $1\\%$ level requires $\\Delta_{cc}  0.01$ and $\\Delta_{mm}  0.01$.\n\n8. Define halo statistics using a continuous, physically plausible mass function in $\\mathrm{Mpc}^{-3}\\,M_{\\odot}^{-1}$,\n   $$\n   n(M) = n_{0}\\left(\\frac{M}{M_{0}}\\right)^{-\\alpha}\\exp\\left(-\\frac{M}{M_{\\mathrm{cut}}}\\right),\n   $$\n   with positive constants $n_{0}$, $M_{0}$, $M_{\\mathrm{cut}}$, and $\\alpha1$. The expected true counts above threshold $M_{\\mathrm{th}}$ in the box are\n   $$\n   N_{\\mathrm{true}}(M_{\\mathrm{th}}) = V_{\\mathrm{Mpc}} \\int_{M_{\\mathrm{th}}}^{\\infty} n(M)\\,\\mathrm{d}M.\n   $$\n\n   Finite force resolution and particle sampling impose a minimum resolvable halo mass\n   $$\n   M_{\\mathrm{res}} = \\max\\left(M_{\\mathrm{force}},\\,N_{\\min}\\,m_{p,c}\\right),\n   $$\n   where $M_{\\mathrm{force}} = \\frac{4\\pi}{3}\\,(2a/h)^{3}\\,\\rho_{m}$ and $N_{\\min}$ is the minimum CDM particle count per halo (use $N_{\\min}=200$). The measured counts for threshold $M_{\\mathrm{th}}$ are modeled as\n   $$\n   N_{\\mathrm{meas}}(M_{\\mathrm{th}}) = \\left(1 - \\varepsilon_{\\mathrm{ts,halo}}\\right)\\,V_{\\mathrm{Mpc}} \\int_{\\max(M_{\\mathrm{th}}, M_{\\mathrm{res}})}^{\\infty} n(M)\\,\\mathrm{d}M,\n   $$\n   with $\\varepsilon_{\\mathrm{ts,halo}} = c_{\\mathrm{ts,halo}}/N_{t}$ and $c_{\\mathrm{ts,halo}}$ a small constant. Define two thresholds $M_{\\mathrm{th,1}} = 10^{13}\\,M_{\\odot}$ and $M_{\\mathrm{th,2}} = 10^{14}\\,M_{\\odot}$. Halo convergence at the $1\\%$ level requires both\n   $$\n   \\left|\\frac{N_{\\mathrm{meas}}(M_{\\mathrm{th,i}}) - N_{\\mathrm{true}}(M_{\\mathrm{th,i}})}{N_{\\mathrm{true}}(M_{\\mathrm{th,i}})}\\right|  0.01\n   \\quad \\text{for } i \\in \\{1,2\\}.\n   $$\n\nConstants to use in this study:\n- Spectral shape: $A = 3\\times 10^{5}\\,(\\mathrm{Mpc}/h)^{3}$, $n_{s} = 0.96$, $k_{0} = 0.2\\,h\\,\\mathrm{Mpc}^{-1}$, $\\alpha = 2$.\n- PM error: $b_{\\mathrm{PM}} = 0.02$.\n- Time-stepping spectral error: $c_{\\mathrm{ts}} = 0.5$.\n- Halo mass function: $n_{0} = 1\\times 10^{-6}\\,\\mathrm{Mpc}^{-3}\\,M_{\\odot}^{-1}$, $M_{0} = 10^{12}\\,M_{\\odot}$, $\\alpha = 1.8$, $M_{\\mathrm{cut}} = 5\\times 10^{14}\\,M_{\\odot}$.\n- Halo time-stepping error: $c_{\\mathrm{ts,halo}} = 0.2$.\n- Minimum CDM particles per halo: $N_{\\min} = 200$.\n- Wavenumber evaluation band: $k \\in [0.05, 0.7]\\,h\\,\\mathrm{Mpc}^{-1}$ sampled at $N_{k} = 40$ points.\n\nTest suite:\nFor each case, parameters are $(L, N_{g}, N_{c}, N_{\\nu}, N_{t}, f_{\\nu}, \\sum m_{\\nu}, \\Omega_{m}, h)$ with units as above and $\\sum m_{\\nu}$ in $\\mathrm{eV}$.\n- Case 1 (high-resolution, expected to converge): $(500, 1024, 1024^{3}, 256^{3}, 20, 0.01, 0.12, 0.315, 0.674)$.\n- Case 2 (low CDM sampling, expected to fail): $(500, 1024, 64^{3}, 256^{3}, 20, 0.01, 0.12, 0.315, 0.674)$.\n- Case 3 (coarse PM grid, expected to fail): $(500, 128, 1024^{3}, 256^{3}, 20, 0.01, 0.12, 0.315, 0.674)$.\n- Case 4 (few time steps, expected to fail): $(500, 1024, 1024^{3}, 256^{3}, 4, 0.01, 0.12, 0.315, 0.674)$.\n\nYour program must, for each case, compute three booleans indicating:\n- CDM spectral convergence at $1\\%$: $\\Delta_{cc}  0.01$,\n- matter spectral convergence at $1\\%$: $\\Delta_{mm}  0.01$,\n- halo convergence at $1\\%$ for both thresholds.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list of lists, each inner list corresponding to one test case in the order above, and each inner list containing the three booleans in the order described. For example: $[[\\mathrm{True},\\mathrm{False},\\mathrm{True}],[\\dots]]$.",
            "solution": "The problem requires the construction and implementation of a mathematical framework to perform a resolution study for massive neutrino simulations in cosmology. The goal is to determine whether a given set of simulation parameters ($L$, $N_g$, $N_c$, $N_{\\nu}$, $N_t$, etc.) achieves convergence at the $1\\%$ level for key cosmological observables: the cold dark matter (CDM) power spectrum, the total matter power spectrum, and halo counts. The framework is built upon established principles and simplified, yet physically motivated, models for both the true cosmological signals and the primary sources of numerical error in Particle-Mesh ($N$-body) simulations.\n\nThe analysis is divided into two primary components: the analysis of power spectra in Fourier space, and the analysis of halo counts in real space. For each component, we first define the \"true\" signal, then model the \"measured\" signal by incorporating numerical error terms, and finally define a convergence metric based on the fractional difference between the two.\n\n**1. Simulation Setup and Physical Context**\n\nWe begin by defining the fundamental parameters of the simulation.\n- The simulation volume is a cube of side length $L$ (in units of $\\mathrm{Mpc}/h$) and volume $V = L^3$ (in $(\\mathrm{Mpc}/h)^3$). The physical volume is $V_{\\mathrm{Mpc}} = (L/h)^3$ (in $\\mathrm{Mpc}^3$), where $h$ is the dimensionless Hubble parameter.\n- The Particle-Mesh (PM) grid has $N_g$ cells per side, resulting in a grid cell size of $a = L/N_g$. This defines a Nyquist wavenumber $k_{\\mathrm{N}} = \\pi/a = \\pi N_g / L$ (in $h\\,\\mathrm{Mpc}^{-1}$), which represents the maximum wavenumber resolvable by the grid.\n- The matter content is composed of CDM and massive neutrinos, with density parameters $\\Omega_c$ and $\\Omega_{\\nu}$ respectively. The total matter density parameter is $\\Omega_m = \\Omega_c + \\Omega_{\\nu}$. The mass fractions are $f_c = \\Omega_c / \\Omega_m$ and $f_{\\nu} = \\Omega_{\\nu} / \\Omega_m$, with $f_c = 1 - f_{\\nu}$.\n- These fluids are sampled by $N_c$ CDM particles and $N_{\\nu}$ neutrino particles. The cosmic mean matter density at redshift $z=0$ is $\\rho_{m} = 2.775 \\times 10^{11}\\, h^{2}\\,\\Omega_{m}\\,M_{\\odot}\\,\\mathrm{Mpc}^{-3}$. The mass of a single CDM particle is therefore $m_{p,c} = f_{c}\\,\\rho_{m}\\,V_{\\mathrm{Mpc}}/N_{c}$.\n\n**2. Power Spectrum Convergence Analysis**\n\nThe power spectrum $P(k)$ quantifies the variance of density fluctuations as a function of wavenumber $k$.\n\n**2.1. True Power Spectra**\nThe problem provides a model for the true linear theory CDM power spectrum, $P_{cc}^{\\mathrm{true}}(k)$:\n$$\nP_{cc}^{\\mathrm{true}}(k) = A\\,\\frac{k^{n_{s}}}{1 + \\left(\\frac{k}{k_{0}}\\right)^{\\alpha}}\n$$\nwhere $A = 3\\times 10^{5}\\,(\\mathrm{Mpc}/h)^{3}$, $n_{s} = 0.96$, $k_{0} = 0.2\\,h\\,\\mathrm{Mpc}^{-1}$, and $\\alpha = 2$ are constants defining the amplitude, tilt, and shape of the spectrum.\n\nMassive neutrinos, due to their large thermal velocities, suppress the growth of structure on small scales. This effect is modeled by a scale-dependent transfer function, $S_{\\nu}(k)$:\n$$\nS_{\\nu}(k) = \\frac{1}{1 + \\left(\\frac{k}{k_{\\mathrm{fs}}}\\right)^{2}}\n$$\nThe neutrino free-streaming scale, $k_{\\mathrm{fs}}$, depends on the total neutrino mass $\\sum m_{\\nu}$:\n$$\nk_{\\mathrm{fs}} = 0.8\\,\\left(\\frac{\\sum m_{\\nu}}{\\mathrm{eV}}\\right)\\,h\\,\\mathrm{Mpc}^{-1}\n$$\nThe true total matter power spectrum, $P_{mm}^{\\mathrm{true}}(k)$, combines the CDM and neutrino contributions:\n$$\nP_{mm}^{\\mathrm{true}}(k) = \\left( f_c \\sqrt{P_{cc}^{\\mathrm{true}}(k)} + f_{\\nu} \\sqrt{P_{\\nu\\nu}^{\\mathrm{true}}(k)} \\right)^2\n$$\nAssuming neutrinos trace the same large-scale density field as CDM but are suppressed on small scales, we have $P_{\\nu\\nu}^{\\mathrm{true}}(k) = S_{\\nu}^2(k) P_{cc}^{\\mathrm{true}}(k)$ and the cross-spectrum $P_{c\\nu}^{\\mathrm{true}}(k) = S_{\\nu}(k) P_{cc}^{\\mathrm{true}}(k)$. This leads to the provided expression:\n$$\nP_{mm}^{\\mathrm{true}}(k) = P_{cc}^{\\mathrm{true}}(k)\\left(f_{c} + f_{\\nu}\\,S_{\\nu}(k)\\right)^{2}\n$$\n\n**2.2. Modeled Numerical Errors and Measured Spectra**\nThe measured power spectrum from a simulation deviates from the true one due to several numerical effects:\n- **Shot Noise**: Discretizing a continuous fluid with a finite number of particles ($N$) introduces a constant noise floor in the power spectrum, $P_{\\mathrm{shot}} = V/N$. For our two species, we have:\n  $$\n  P_{\\mathrm{shot},c} = \\frac{V}{N_{c}} = \\frac{L^3}{N_c}, \\quad P_{\\mathrm{shot},\\nu} = \\frac{V}{N_{\\nu}} = \\frac{L^3}{N_{\\nu}}\n  $$\n- **PM Grid Resolution**: The finite grid of the PM solver cannot resolve modes near and above the Nyquist frequency, leading to a suppression of power. This is modeled as a multiplicative error term:\n  $$\n  \\varepsilon_{\\mathrm{PM}}(k) = b_{\\mathrm{PM}}\\,\\left(\\frac{k}{k_{\\mathrm{N}}}\\right)^{2}, \\quad \\text{with } b_{\\mathrm{PM}} = 0.02\n  $$\n- **Time-Stepping Error**: Inaccuracies in temporal integration of particle trajectories introduce a small, largely scale-independent bias. For a second-order scheme with $N_t$ steps, this is modeled as:\n  $$\n  \\varepsilon_{\\mathrm{ts}} = \\frac{c_{\\mathrm{ts}}}{N_{t}^{2}}, \\quad \\text{with } c_{\\mathrm{ts}} = 0.5\n  $$\nThese suppression effects are combined into a single transfer factor $Q(k) = 1 - \\varepsilon_{\\mathrm{PM}}(k) - \\varepsilon_{\\mathrm{ts}}$. The measured auto- and cross-spectra are then constructed by applying the transfer factor to the true signal and adding the relevant shot noise:\n$$\nP_{cc}^{\\mathrm{meas}}(k) = P_{cc}^{\\mathrm{true}}(k)\\,Q(k) + P_{\\mathrm{shot},c}\n$$\n$$\nP_{\\nu\\nu}^{\\mathrm{meas}}(k) = P_{cc}^{\\mathrm{true}}(k)\\,S_{\\nu}^{2}(k)\\,Q(k) + P_{\\mathrm{shot},\\nu}\n$$\n$$\nP_{c\\nu}^{\\mathrm{meas}}(k) = P_{cc}^{\\mathrm{true}}(k)\\,S_{\\nu}(k)\\,Q(k)\n$$\nThe total measured matter power spectrum is the weighted sum of these components:\n$$\nP_{mm}^{\\mathrm{meas}}(k) = f_{c}^{2}\\,P_{cc}^{\\mathrm{meas}}(k) + 2 f_{c} f_{\\nu}\\,P_{c\\nu}^{\\mathrm{meas}}(k) + f_{\\nu}^{2}\\,P_{\\nu\\nu}^{\\mathrm{meas}}(k)\n$$\n\n**2.3. Spectral Convergence Metric**\nConvergence is assessed by the maximum absolute fractional deviation between the true and measured spectra over a specified evaluation band $k \\in [0.05, 0.7]\\,h\\,\\mathrm{Mpc}^{-1}$. We define the metrics $\\Delta_{cc}$ and $\\Delta_{mm}$:\n$$\n\\Delta_{cc} = \\max_{k}\\left|\\frac{P_{cc}^{\\mathrm{meas}}(k) - P_{cc}^{\\mathrm{true}}(k)}{P_{cc}^{\\mathrm{true}}(k)}\\right|, \\quad \\Delta_{mm} = \\max_{k}\\left|\\frac{P_{mm}^{\\mathrm{meas}}(k) - P_{mm}^{\\mathrm{true}}(k)}{P_{mm}^{\\mathrm{true}}(k)}\\right|\n$$\nA crucial condition is that for any mode $k$ that is not well-resolved by the grid, defined as $k > 0.8\\,k_{\\mathrm{N}}$, its fractional error is artificially set to $1.0$. This penalizes simulations with insufficient grid resolution. Convergence at the $1\\%$ level is achieved if $\\Delta_{cc}  0.01$ and $\\Delta_{mm}  0.01$.\n\n**3. Halo Statistics Convergence Analysis**\n\nThe second part of the study concerns halos, the gravitationally bound structures that host galaxies.\n\n**3.1. True Halo Counts**\nThe abundance of halos as a function of their mass $M$ is described by the halo mass function, $n(M)$. The problem specifies the model:\n$$\nn(M) = n_{0}\\left(\\frac{M}{M_{0}}\\right)^{-\\alpha}\\exp\\left(-\\frac{M}{M_{\\mathrm{cut}}}\\right)\n$$\nwith constants $n_{0} = 10^{-6}\\,\\mathrm{Mpc}^{-3}\\,M_{\\odot}^{-1}$, $M_{0} = 10^{12}\\,M_{\\odot}$, $\\alpha = 1.8$, and $M_{\\mathrm{cut}} = 5 \\times 10^{14}\\,M_{\\odot}$.\n\nThe \"true\" expected number of halos in the simulation box with mass greater than a threshold $M_{\\mathrm{th}}$ is given by integrating the mass function over the box volume:\n$$\nN_{\\mathrm{true}}(M_{\\mathrm{th}}) = V_{\\mathrm{Mpc}} \\int_{M_{\\mathrm{th}}}^{\\infty} n(M)\\,\\mathrm{d}M\n$$\nThis integral can be solved analytically using the upper incomplete gamma function, $\\Gamma(s,x) = \\int_x^\\infty t^{s-1}e^{-t} dt$. The result is:\n$$\n\\int_{M_{\\mathrm{th}}}^{\\infty} n(M)\\,\\mathrm{d}M = n_0 M_0^{\\alpha} M_{\\mathrm{cut}}^{1-\\alpha} \\Gamma(1-\\alpha, M_{\\mathrm{th}}/M_{\\mathrm{cut}})\n$$\n\n**3.2. Modeled Numerical Errors and Measured Halo Counts**\nIn a simulation, not all halos can be identified. There is a minimum resolvable halo mass, $M_{\\mathrm{res}}$, determined by two factors:\n- **Force Resolution**: The grid cell size limits the ability to resolve the dense cores of small halos. This is modeled by a mass scale $M_{\\mathrm{force}} = \\frac{4\\pi}{3}\\,(2a/h)^{3}\\,\\rho_{m}$, which corresponds to the mass within a sphere of radius twice the physical grid spacing.\n- **Particle Resolution**: A halo must be sampled by a sufficient number of particles to be identified as a bound object. This mass scale is $N_{\\min}\\,m_{p,c}$, where $N_{\\min}=200$ is the minimum particle count.\nThe overall resolution limit is the larger of these two: $M_{\\mathrm{res}} = \\max\\left(M_{\\mathrm{force}},\\,N_{\\min}\\,m_{p,c}\\right)$.\n\nFurthermore, time-stepping errors can affect halo properties and lead to a systematic bias in their counts, modeled as a first-order effect $\\varepsilon_{\\mathrm{ts,halo}} = c_{\\mathrm{ts,halo}}/N_{t}$, with $c_{\\mathrm{ts,halo}}=0.2$.\n\nCombining these effects, the \"measured\" number of halos is modeled by adjusting the lower integration limit to account for resolution and applying the time-stepping bias:\n$$\nN_{\\mathrm{meas}}(M_{\\mathrm{th}}) = \\left(1 - \\varepsilon_{\\mathrm{ts,halo}}\\right)\\,V_{\\mathrm{Mpc}} \\int_{\\max(M_{\\mathrm{th}}, M_{\\mathrm{res}})}^{\\infty} n(M)\\,\\mathrm{d}M\n$$\n\n**3.3. Halo Convergence Metric**\nConvergence is checked for two mass thresholds, $M_{\\mathrm{th,1}} = 10^{13}\\,M_{\\odot}$ and $M_{\\mathrm{th,2}} = 10^{14}\\,M_{\\odot}$. The fractional error must be below $1\\%$ for both:\n$$\n\\left|\\frac{N_{\\mathrm{meas}}(M_{\\mathrm{th,i}}) - N_{\\mathrm{true}}(M_{\\mathrm{th,i}})}{N_{\\mathrm{true}}(M_{\\mathrm{th,i}})}\\right|  0.01 \\quad \\text{for } i \\in \\{1,2\\}\n$$\nIf this condition holds for both thresholds, halo statistics are considered converged.\n\n**4. Algorithmic Procedure**\nFor each test case defined by the tuple $(L, N_{g}, N_{c}, N_{\\nu}, N_{t}, f_{\\nu}, \\sum m_{\\nu}, \\Omega_{m}, h)$, the algorithm is as follows:\n1.  Calculate derived simulation parameters: $a$, $k_N$, $f_c$, $V$, $V_{\\mathrm{Mpc}}$, $\\rho_m$, $m_{p,c}$, $k_{\\mathrm{fs}}$.\n2.  Define the evaluation vector of $N_k=40$ wavenumbers, linearly spaced from $k=0.05$ to $k=0.7\\,h\\,\\mathrm{Mpc}^{-1}$.\n3.  For each $k$ in the vector, compute $P_{cc}^{\\mathrm{true}}(k)$, $P_{mm}^{\\mathrm{true}}(k)$, $P_{cc}^{\\mathrm{meas}}(k)$, and $P_{mm}^{\\mathrm{meas}}(k)$.\n4.  Calculate the fractional errors for the CDM and total matter spectra, setting the error to $1.0$ for any $k > 0.8 k_N$.\n5.  Find the maximum fractional error for both spectra ($\\Delta_{cc}$, $\\Delta_{mm}$) and compare with $0.01$ to determine spectral convergence.\n6.  Calculate the halo resolution mass $M_{\\mathrm{res}}$.\n7.  Calculate the true and measured halo counts ($N_{\\mathrm{true}}$, $N_{\\mathrm{meas}}$) for both thresholds $M_{\\mathrm{th,1}}$ and $M_{\\mathrm{th,2}}$ by evaluating the integral of the mass function.\n8.  Compute the fractional errors for the two halo counts and check if both are less than $0.01$ to determine halo convergence.\n9.  Return the three boolean results (CDM spectral convergence, matter spectral convergence, halo convergence).\n\nThis procedure formalizes the complex interplay of physical models and numerical artifacts into a deterministic algorithm for assessing simulation quality.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import gamma, gammaincc\n\ndef solve():\n    \"\"\"\n    Constructs and solves the resolution study problem for massive neutrinos\n    in N-body simulations, based on the provided analytical models.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (L, Ng, Nc, Nv, Nt, f_nu, sum_mnu, Omega_m, h)\n        (500, 1024, 1024**3, 256**3, 20, 0.01, 0.12, 0.315, 0.674), # Case 1: High-res\n        (500, 1024, 64**3, 256**3, 20, 0.01, 0.12, 0.315, 0.674),   # Case 2: Low CDM sampling\n        (500, 128, 1024**3, 256**3, 20, 0.01, 0.12, 0.315, 0.674),   # Case 3: Coarse PM grid\n        (500, 1024, 1024**3, 256**3, 4, 0.01, 0.12, 0.315, 0.674),    # Case 4: Few time steps\n    ]\n\n    # Constants from the problem statement\n    A = 3e5\n    ns = 0.96\n    k0 = 0.2\n    alpha_spec = 2.0\n    b_PM = 0.02\n    c_ts = 0.5\n    n0 = 1e-6\n    M0 = 1e12\n    alpha_halo = 1.8\n    M_cut = 5e14\n    c_ts_halo = 0.2\n    N_min = 200.0\n    rho_m_const = 2.775e11\n    k_eval = np.linspace(0.05, 0.7, 40)\n    M_th1 = 1e13\n    M_th2 = 1e14\n    convergence_threshold = 0.01\n\n    def calculate_spectra(k_vals, L, Ng, Nc, Nv, Nt, f_nu, sum_mnu, h):\n        # Derived parameters for spectral analysis\n        a = L / Ng\n        k_N = np.pi / a\n        fc = 1.0 - f_nu\n        V = L**3\n        k_fs = 0.8 * sum_mnu * h\n\n        # True spectra\n        P_cc_true = A * k_vals**ns / (1.0 + (k_vals / k0)**alpha_spec)\n        S_nu = 1.0 / (1.0 + (k_vals / k_fs)**2)\n        P_mm_true = P_cc_true * (fc + f_nu * S_nu)**2\n\n        # Error models\n        P_shot_c = V / Nc\n        P_shot_nu = V / Nv\n        eps_PM = b_PM * (k_vals / k_N)**2\n        eps_ts = c_ts / Nt**2\n        Q = 1.0 - eps_PM - eps_ts\n\n        # Measured spectra\n        P_cc_meas = P_cc_true * Q + P_shot_c\n        P_nunu_meas = P_cc_true * S_nu**2 * Q + P_shot_nu\n        P_cnu_meas = P_cc_true * S_nu * Q\n        \n        P_mm_meas = fc**2 * P_cc_meas + 2.0 * fc * f_nu * P_cnu_meas + f_nu**2 * P_nunu_meas\n        \n        return P_cc_true, P_cc_meas, P_mm_true, P_mm_meas, k_N\n\n    def integral_n_M(M_min):\n        \"\"\"Calculates the integral of the halo mass function from M_min to infinity.\"\"\"\n        s = 1.0 - alpha_halo\n        z = M_min / M_cut\n        # Integral is n0 * M0^alpha * M_cut^(1-alpha) * Gamma(1-alpha, M_min/M_cut)\n        # using Gamma(s,z) = gamma(s) * gammaincc(s,z)\n        integral_val = n0 * (M0**alpha_halo) * (M_cut**s) * gamma(s) * gammaincc(s, z)\n        return integral_val\n\n    def calculate_halo_counts(L, Ng, Nc, Nt, f_nu, Omega_m, h):\n        # Derived parameters for halo analysis\n        a = L / Ng\n        fc = 1.0 - f_nu\n        rho_m = rho_m_const * h**2 * Omega_m\n        V_Mpc = (L / h)**3\n        \n        # Resolvable mass calculation\n        m_pc = fc * rho_m * V_Mpc / Nc\n        M_force = (4.0 * np.pi / 3.0) * (2.0 * a / h)**3 * rho_m\n        M_res = max(M_force, N_min * m_pc)\n\n        # True counts\n        N_true_1 = V_Mpc * integral_n_M(M_th1)\n        N_true_2 = V_Mpc * integral_n_M(M_th2)\n\n        # Measured counts\n        eps_ts_halo = c_ts_halo / Nt\n        N_meas_1 = (1.0 - eps_ts_halo) * V_Mpc * integral_n_M(max(M_th1, M_res))\n        N_meas_2 = (1.0 - eps_ts_halo) * V_Mpc * integral_n_M(max(M_th2, M_res))\n\n        return N_true_1, N_meas_1, N_true_2, N_meas_2\n\n    results = []\n    for case in test_cases:\n        L, Ng, Nc, Nv, Nt, f_nu, sum_mnu, Omega_m, h = case\n        \n        # 1. Spectral convergence\n        P_cc_true, P_cc_meas, P_mm_true, P_mm_meas, k_N = calculate_spectra(\n            k_eval, L, Ng, Nc, Nv, Nt, f_nu, sum_mnu, h\n        )\n        \n        frac_err_cc = np.abs((P_cc_meas - P_cc_true) / P_cc_true)\n        frac_err_mm = np.abs((P_mm_meas - P_mm_true) / P_mm_true)\n        \n        # Apply unresolved mode condition\n        unresolved_mask = k_eval > 0.8 * k_N\n        frac_err_cc[unresolved_mask] = 1.0\n        frac_err_mm[unresolved_mask] = 1.0\n        \n        delta_cc = np.max(frac_err_cc)\n        delta_mm = np.max(frac_err_mm)\n        \n        spec_cc_converged = delta_cc  convergence_threshold\n        spec_mm_converged = delta_mm  convergence_threshold\n\n        # 2. Halo convergence\n        N_true_1, N_meas_1, N_true_2, N_meas_2 = calculate_halo_counts(\n            L, Ng, Nc, Nt, f_nu, Omega_m, h\n        )\n        \n        halo_err_1 = np.abs((N_meas_1 - N_true_1) / N_true_1) if N_true_1 > 0 else (1.0 if N_meas_1 != 0 else 0.0)\n        halo_err_2 = np.abs((N_meas_2 - N_true_2) / N_true_2) if N_true_2 > 0 else (1.0 if N_meas_2 != 0 else 0.0)\n        \n        halo_converged = (halo_err_1  convergence_threshold) and (halo_err_2  convergence_threshold)\n        \n        results.append([spec_cc_converged, spec_mm_converged, halo_converged])\n\n    # Final print statement in the exact required format.\n    # The replace(\" \", \"\") is crucial to match the required output format.\n    print(f\"[{','.join([str(r) for r in results])}]\".replace(\" \", \"\"))\n\nsolve()\n```"
        }
    ]
}