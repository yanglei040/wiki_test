{
    "hands_on_practices": [
        {
            "introduction": "在着手编写求解器之前，理解所选空间离散化方案的精度至关重要。自由薛定谔方程的演化由其色散关系 $\\omega(k) \\propto k^2$ 决定。本练习  提供了一种直接的解析方法，用以量化不同数值方法（如有限差分法和谱方法）对这一基本关系的再现程度，从而帮助你深入理解选择离散化方案时所涉及的权衡。",
            "id": "3485474",
            "problem": "考虑用于模糊（超轻）暗物质的自由薛定谔方程，\n$$\ni \\hbar \\,\\frac{\\partial \\psi}{\\partial t} \\;=\\; -\\,\\frac{\\hbar^{2}}{2 m}\\,\\nabla^{2}\\psi \\,,\n$$\n该方程定义在一个长度为 $L$ 的一维周期性区域上，此区域被 $N$ 个均匀分布的网格点离散化，点间距为 $h = L/N$。为分离色散行为，我们忽略引力势。对于一个与周期性区域一致的平面波模式，设 $k = 2\\pi n/L$（其中 $n$ 为整数），并定义网格相位 $\\theta = k h$（所有三角函数均使用弧度）。精确的色散关系为\n$$\n\\omega_{\\text{exact}}(k) \\;=\\; \\frac{\\hbar k^{2}}{2 m} \\,.\n$$\n考虑拉普拉斯算子的三种空间离散化方法：\n\n1. 中心二阶有限差分：\n$$\n\\left[\\nabla^{2}\\psi\\right]_{j} \\;=\\; \\frac{\\psi_{j+1} - 2 \\psi_{j} + \\psi_{j-1}}{h^{2}} \\,.\n$$\n\n2. 用于二阶导数的三对角紧致四阶有限差分（Padé 型），由以下方程隐式定义：\n$$\n\\alpha\\, \\psi^{\\prime\\prime}_{j-1} \\;+\\; \\psi^{\\prime\\prime}_{j} \\;+\\; \\alpha\\, \\psi^{\\prime\\prime}_{j+1}\n\\;=\\;\n\\frac{a}{h^{2}}\\left(\\psi_{j-1} - 2 \\psi_{j} + \\psi_{j+1}\\right)\n\\quad\\text{其中}\\quad \\alpha = \\frac{1}{10},\\;\\; a = \\frac{6}{5}\\,,\n$$\n使得 $\\psi^{\\prime\\prime}_{j}$ 近似于 $\\left[\\nabla^{2}\\psi\\right]_{j}$。\n\n3. 周期性网格上的伪谱傅里叶拉普拉斯算子，对于任何网格能解析的傅里叶模式，其都能得到精确的特征值 $-k^{2}$。\n\n对于每种离散化方法，通过作用于平面波 $\\psi_{j} = \\exp(i j \\theta)$ 的离散拉普拉斯算子特征值 $-\\left(k_{\\text{num}}\\right)^{2}$ 来定义离散修正波数 $k_{\\text{num}}$。相应的数值角频率为\n$$\n\\omega_{\\text{num}}(k) \\;=\\; \\frac{\\hbar \\left(k_{\\text{num}}\\right)^{2}}{2 m} \\,,\n$$\n数值相速度为 $v_{p,\\text{num}}(k) = \\omega_{\\text{num}}(k)/k$。\n\n从以上定义和离散算子出发，推导相对色散误差的闭式表达式\n$$\n\\varepsilon(\\theta) \\;=\\; \\frac{\\omega_{\\text{num}}(k) - \\omega_{\\text{exact}}(k)}{\\omega_{\\text{exact}}(k)} \\;=\\; \\frac{\\left(k_{\\text{num}}\\right)^{2} - k^{2}}{k^{2}}\n$$\n用网格相位 $\\theta$ 表示这三种格式的相对色散误差。将您的最终答案表示为一个单行矩阵，其中分别包含 $\\varepsilon_{\\text{cen}}(\\theta)$、$\\varepsilon_{\\text{comp}}(\\theta)$ 和 $\\varepsilon_{\\text{spec}}(\\theta)$ 的简化闭式形式。最终表达式无需进行数值计算，也不应包含单位。",
            "solution": "用户提供了一个问题陈述，在尝试解答之前需要对其进行形式验证。\n\n### 问题验证\n\n**步骤 1：提取已知条件**\n- **控制方程**：自由薛定谔方程，$i \\hbar \\,\\frac{\\partial \\psi}{\\partial t} = -\\,\\frac{\\hbar^{2}}{2 m}\\,\\nabla^{2}\\psi$。\n- **区域**：长度为 $L$ 的一维周期性区域，用 $N$ 个点离散化，网格间距 $h = L/N$。\n- **测试函数**：平面波模式，$\\psi_j = \\exp(i j \\theta)$，其中 $k = 2\\pi n/L$（$n$ 为整数），$\\theta = k h$。\n- **精确色散关系**：$\\omega_{\\text{exact}}(k) = \\frac{\\hbar k^{2}}{2 m}$。\n- **数值色散关系**：$\\omega_{\\text{num}}(k) = \\frac{\\hbar \\left(k_{\\text{num}}\\right)^{2}}{2 m}$。量 $-\\left(k_{\\text{num}}\\right)^{2}$ 是离散拉普拉斯算子作用于模式 $\\exp(i j \\theta)$ 的特征值。\n- **色散误差**：$\\varepsilon(\\theta) = \\frac{\\left(k_{\\text{num}}\\right)^{2} - k^{2}}{k^{2}}$。\n- **格式 1（中心二阶）**：$\\left[\\nabla^{2}\\psi\\right]_{j} = \\frac{\\psi_{j+1} - 2 \\psi_{j} + \\psi_{j-1}}{h^{2}}$。\n- **格式 2（紧致四阶）**：$\\alpha\\, \\psi^{\\prime\\prime}_{j-1} + \\psi^{\\prime\\prime}_{j} + \\alpha\\, \\psi^{\\prime\\prime}_{j+1} = \\frac{a}{h^{2}}\\left(\\psi_{j-1} - 2 \\psi_{j} + \\psi_{j+1}\\right)$，其中 $\\alpha = \\frac{1}{10}$ 且 $a = \\frac{6}{5}$。\n- **格式 3（伪谱）**：对于任何网格能解析的傅里叶模式，都能得到精确的特征值 $-k^{2}$。\n\n**步骤 2：使用提取的已知条件进行验证**\n根据所需标准对问题进行评估：\n- **科学依据**：该问题植根于偏微分方程（特别是薛定谔方程）的标准数值分析。所描述的方法（有限差分、紧致有限差分、伪谱法）是计算物理学中的经典技术。其在模糊暗物质中的应用是数值宇宙学中一个公认的课题。该问题在科学和数学上都是合理的。\n- **适定性**：所有必要的定义、方程和参数均已提供。任务是推导特定的解析表达式，根据给定的条件存在唯一解。\n- **客观性**：问题使用精确、无歧义的数学和技术语言陈述。它不含主观或基于观点的内容。\n\n问题陈述没有无效清单中列出的任何缺陷。这是一个在应用数学和计算物理学领域中完整、一致且可形式化的问题。\n\n**步骤 3：结论与行动**\n该问题是**有效的**。将提供完整的解答。\n\n### 解答推导\n\n核心任务是确定三种数值格式中每一种的相对色散误差 $\\varepsilon(\\theta)$。误差的定义由下式给出：\n$$\n\\varepsilon(\\theta) = \\frac{\\omega_{\\text{num}}(k) - \\omega_{\\text{exact}}(k)}{\\omega_{\\text{exact}}(k)} = \\frac{\\left(k_{\\text{num}}\\right)^{2} - k^{2}}{k^{2}} = \\frac{\\left(k_{\\text{num}}\\right)^{2}}{k^{2}} - 1\n$$\n为了求出 $\\varepsilon(\\theta)$，我们必须找到每种格式的修正波数平方 $\\left(k_{\\text{num}}\\right)^{2}$ 的表达式。根据定义，$-\\left(k_{\\text{num}}\\right)^{2}$ 是离散拉普拉斯算子作用于平面波时的特征值。设离散拉普拉斯算子表示为 $\\hat{\\nabla}^{2}$。对于平面波模式 $\\psi_{j} = \\exp(i j k h) = \\exp(i j \\theta)$，其作用由下式给出：\n$$\n\\hat{\\nabla}^{2} \\psi_{j} = -\\left(k_{\\text{num}}\\right)^{2} \\psi_{j}\n$$\n我们将分析每个离散算子对 $\\psi_{j} = \\exp(i j \\theta)$ 的作用，注意 $\\psi_{j\\pm 1} = \\psi_{j} \\exp(\\pm i \\theta)$。我们还使用关系式 $k = \\theta/h$。\n\n**1. 中心二阶有限差分 ($\\varepsilon_{\\text{cen}}(\\theta)$)**\n\n离散拉普拉斯算子由下式给出：\n$$\n\\left[\\hat{\\nabla}^{2}\\psi\\right]_{j} = \\frac{\\psi_{j+1} - 2 \\psi_{j} + \\psi_{j-1}}{h^{2}}\n$$\n将此算子应用于 $\\psi_j = \\exp(i j \\theta)$：\n$$\n\\left[\\hat{\\nabla}^{2}\\psi\\right]_{j} = \\frac{\\exp(i \\theta) \\psi_{j} - 2 \\psi_{j} + \\exp(-i \\theta) \\psi_{j}}{h^{2}} = \\frac{\\psi_j}{h^2} \\left( \\exp(i \\theta) + \\exp(-i \\theta) - 2 \\right)\n$$\n使用恒等式 $2\\cos(\\theta) = \\exp(i \\theta) + \\exp(-i \\theta)$，我们得到：\n$$\n\\left[\\hat{\\nabla}^{2}\\psi\\right]_{j} = \\frac{\\psi_j}{h^2} \\left( 2\\cos(\\theta) - 2 \\right) = \\frac{2\\left(\\cos(\\theta) - 1\\right)}{h^2} \\psi_j\n$$\n使用半角恒等式 $1 - \\cos(\\theta) = 2\\sin^{2}(\\theta/2)$：\n$$\n\\left[\\hat{\\nabla}^{2}\\psi\\right]_{j} = \\frac{-4\\sin^{2}(\\theta/2)}{h^{2}} \\psi_j\n$$\n特征值为 $-\\frac{4\\sin^{2}(\\theta/2)}{h^{2}}$。根据定义，这等于 $-\\left(k_{\\text{num, cen}}\\right)^{2}$。\n$$\n\\left(k_{\\text{num, cen}}\\right)^{2} = \\frac{4\\sin^{2}(\\theta/2)}{h^{2}}\n$$\n那么相对色散误差为：\n$$\n\\varepsilon_{\\text{cen}}(\\theta) = \\frac{\\left(k_{\\text{num, cen}}\\right)^{2}}{k^{2}} - 1 = \\frac{4\\sin^{2}(\\theta/2)/h^{2}}{(\\theta/h)^{2}} - 1 = \\frac{4\\sin^{2}(\\theta/2)}{\\theta^{2}} - 1\n$$\n\n**2. 紧致四阶有限差分 ($\\varepsilon_{\\text{comp}}(\\theta)$)**\n\n该格式被隐式定义：\n$$\n\\alpha\\, \\psi^{\\prime\\prime}_{j-1} \\;+\\; \\psi^{\\prime\\prime}_{j} \\;+\\; \\alpha\\, \\psi^{\\prime\\prime}_{j+1} \\;=\\; \\frac{a}{h^{2}}\\left(\\psi_{j-1} - 2 \\psi_{j} + \\psi_{j+1}\\right)\n$$\n其中 $\\psi^{\\prime\\prime}_{j}$ 是二阶导数的数值近似。对于平面波，$\\psi^{\\prime\\prime}_{j} = -\\left(k_{\\text{num, comp}}\\right)^{2} \\psi_j$。因此，$\\psi^{\\prime\\prime}_{j\\pm 1} = -\\left(k_{\\text{num, comp}}\\right)^{2} \\psi_{j\\pm 1} = -\\left(k_{\\text{num, comp}}\\right)^{2} \\psi_j \\exp(\\pm i\\theta)$。\n代入左侧（LHS）：\n$$\n\\text{LHS} = -\\left(k_{\\text{num, comp}}\\right)^{2} \\psi_j \\left( \\alpha \\exp(-i\\theta) + 1 + \\alpha \\exp(i\\theta) \\right) = -\\left(k_{\\text{num, comp}}\\right)^{2} \\psi_j \\left( 1 + 2\\alpha\\cos(\\theta) \\right)\n$$\n右侧（RHS）在形式上与中心差分算子相同，只是乘以了系数 $a$：\n$$\n\\text{RHS} = \\frac{a}{h^{2}}\\left(\\psi_j \\exp(-i\\theta) - 2\\psi_j + \\psi_j \\exp(i\\theta) \\right) = \\frac{a\\psi_j}{h^2}\\left(2\\cos(\\theta)-2\\right)\n$$\n令 LHS 和 RHS 相等并消去 $\\psi_j$：\n$$\n-\\left(k_{\\text{num, comp}}\\right)^{2} \\left( 1 + 2\\alpha\\cos(\\theta) \\right) = \\frac{a}{h^{2}} \\left(2\\cos(\\theta)-2\\right)\n$$\n求解 $\\left(k_{\\text{num, comp}}\\right)^{2}$：\n$$\n\\left(k_{\\text{num, comp}}\\right)^{2} = - \\frac{2a\\left(\\cos(\\theta)-1\\right)}{h^{2}\\left(1 + 2\\alpha\\cos(\\theta)\\right)} = \\frac{2a\\left(1-\\cos(\\theta)\\right)}{h^{2}\\left(1 + 2\\alpha\\cos(\\theta)\\right)}\n$$\n代入给定值 $\\alpha = 1/10$ 和 $a = 6/5$：\n$$\n\\left(k_{\\text{num, comp}}\\right)^{2} = \\frac{2(6/5)\\left(1-\\cos(\\theta)\\right)}{h^{2}\\left(1 + 2(1/10)\\cos(\\theta)\\right)} = \\frac{(12/5)\\left(1-\\cos(\\theta)\\right)}{h^{2}\\left(1 + (1/5)\\cos(\\theta)\\right)} = \\frac{12\\left(1-\\cos(\\theta)\\right)}{h^{2}\\left(5 + \\cos(\\theta)\\right)}\n$$\n使用恒等式 $1-\\cos(\\theta) = 2\\sin^2(\\theta/2)$：\n$$\n\\left(k_{\\text{num, comp}}\\right)^{2} = \\frac{24\\sin^{2}(\\theta/2)}{h^{2}\\left(5 + \\cos(\\theta)\\right)}\n$$\n相对色散误差为：\n$$\n\\varepsilon_{\\text{comp}}(\\theta) = \\frac{\\left(k_{\\text{num, comp}}\\right)^{2}}{k^{2}} - 1 = \\frac{24\\sin^{2}(\\theta/2)}{h^{2}\\left(5 + \\cos(\\theta)\\right)} \\frac{1}{(\\theta/h)^2} - 1 = \\frac{24\\sin^{2}(\\theta/2)}{\\theta^{2}\\left(5 + \\cos(\\theta)\\right)} - 1\n$$\n\n**3. 伪谱傅里叶拉普拉斯算子 ($\\varepsilon_{\\text{spec}}(\\theta)$)**\n\n问题陈述指出，对于一个网格能解析的傅里叶模式，伪谱拉普拉斯算子能得到精确的特征值，即 $-k^{2}$。具有 $k=2\\pi n/L$ 的平面波 $\\psi_j = \\exp(ijkh)$ 就是这样一种模式。\n因此，伪谱算子 $\\hat{\\nabla}^2_{\\text{spec}}$ 作用于 $\\psi_j$ 的结果是：\n$$\n\\hat{\\nabla}^2_{\\text{spec}} \\psi_j = -k^2 \\psi_j\n$$\n根据定义，特征值也等于 $-\\left(k_{\\text{num, spec}}\\right)^2$。因此，我们有：\n$$\n-\\left(k_{\\text{num, spec}}\\right)^2 = -k^2 \\quad \\implies \\quad \\left(k_{\\text{num, spec}}\\right)^2 = k^2\n$$\n相对色散误差为：\n$$\n\\varepsilon_{\\text{spec}}(\\theta) = \\frac{\\left(k_{\\text{num, spec}}\\right)^{2} - k^{2}}{k^{2}} = \\frac{k^{2} - k^{2}}{k^{2}} = 0\n$$\n这对任何非零波数 $k$ 都成立。如果 $k=0$，模式是常数，$\\omega_{\\text{exact}}$ 和 $\\omega_{\\text{num}}$ 均为零，使得相对误差因 $0/0$ 而无定义。然而，其极限为 $0$，并且对于任何色散分析，我们都考虑 $k \\neq 0$。\n\n**结论**\n\n三种格式的相对色散误差的闭式表达式为：\n- $\\varepsilon_{\\text{cen}}(\\theta) = \\frac{4\\sin^{2}(\\theta/2)}{\\theta^{2}} - 1$\n- $\\varepsilon_{\\text{comp}}(\\theta) = \\frac{24\\sin^{2}(\\theta/2)}{\\theta^{2}(5+\\cos\\theta)} - 1$\n- $\\varepsilon_{\\text{spec}}(\\theta) = 0$\n\n这些结果将以单行矩阵的形式提供。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{4\\sin^{2}(\\theta/2)}{\\theta^{2}} - 1  \\frac{24\\sin^{2}(\\theta/2)}{\\theta^{2}(5+\\cos\\theta)} - 1  0\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "在构建了求解器的核心组件后，验证其正确性是关键一步。量子力学的一个基本对称性是，物理可观测量在波函数的全局相位变换 $\\psi \\to e^{i\\theta}\\psi$ 下保持不变。本实践练习  是所有薛定谔-泊松求解器的基础验证测试，通过数值确认密度和总能量等诊断量在相位旋转后保持不变，你将能验证这些关键物理量实现的正确性。",
            "id": "3485499",
            "problem": "您的任务是验证用于模拟模糊或超轻暗物质的二维周期性薛定谔-泊松诊断法的全局相位不变性。请完全在无量纲代码单位下进行操作，其中约化普朗克常数 $\\hbar$、粒子质量 $m$、引力常数 $G$ 和盒子边长 $L$ 均设为 $1$。角度必须以弧度为单位。\n\n使用的基本原理和定义：\n- 薛定谔-泊松系统通过质量密度 $\\rho(\\mathbf{x},t) = m|\\psi(\\mathbf{x},t)|^2$ 和泊松方程，将一个复标量场 $\\psi(\\mathbf{x},t)$ 与牛顿引力势 $\\Phi(\\mathbf{x},t)$ 耦合起来。\n- 密度为 $\\rho = m|\\psi|^2$。\n- 引力势 $\\Phi$ 在边长为 $L$ 的周期性域上满足泊松方程 $\\nabla^2 \\Phi = 4\\pi G (\\rho - \\overline{\\rho})$，其中 $\\overline{\\rho}$ 表示 $\\rho$ 的空间平均值。减去 $\\overline{\\rho}$ 是为了强制使其均值为零，从而确保傅里葉解在周期性边界条件下是良定义的。\n- 动能泛函为 $T = \\dfrac{\\hbar^2}{2m} \\int |\\nabla \\psi|^2 \\, d^2x$。\n- 引力势能为 $U = \\dfrac{1}{2}\\int \\rho \\, \\Phi \\, d^2x$。\n- 总能量为 $E = T + U$。\n\n全局相位不变性指出，施加变换 $\\psi \\to e^{i\\theta}\\psi$（其中 $\\theta$ 为常数）会使所有物理诊断量保持不变，包括 $\\rho$ 和 $E$。\n\n实现要求：\n- 使用边长为 $L=1$ 的二维周期性方形域，并采用 $N\\times N$ 点的均匀网格，其中 $N$ 为整数。使用 $N=64$。\n- 通过叠加平滑、非平凡的分量，在网格上构造一个确定性的初始复数场 $\\psi(x,y)$，使得 $\\psi$ 既不是纯实数也不是空间均匀的。例如，将一个局域高斯包络与一个平面波相位、一个额外的平面波以及一个小的常数偏移量组合起来；确保该场在 $x$ 和 $y$ 方向上都有变化，并且处处具有非零的复相位。\n- 使用傅里叶变换，通过谱方法计算空间导数和求解泊松方程。对于泊松方程，将势的零模式设为零，并对非零波矢 $\\mathbf{k}$ 使用 $\\Phi_{\\mathbf{k}} = -\\dfrac{4\\pi G}{|\\mathbf{k}|^2}\\,\\rho_{\\mathbf{k}}$，其中在变换前用 $\\rho - \\overline{\\rho}$ 替换 $\\rho$。对于梯度，在傅里叶空间中使用 $\\partial_x \\psi \\leftrightarrow i k_x \\hat{\\psi}$ 和 $\\partial_y \\psi \\leftrightarrow i k_y \\hat{\\psi}$。\n- 计算原始场和经过全局相位旋转的场 $\\psi' = e^{i\\theta}\\psi$ 的诊断量：密度 $\\rho$ 和总能量 $E$。\n- 使用绝对值最大范数进行场比较，即检查 $\\max_{x,y}|\\rho'(x,y)-\\rho(x,y)|$。\n- 对密度比较和总能量比较均使用 $10^{-11}$ 的统一数值容差。\n\n测试套件：\n应用五个不同的角度 $\\theta$ 来测试不变性的不同方面和数值行为。角度必须以弧度为单位。\n1. $\\theta = 0$ (边界情况)。\n2. $\\theta = \\pi/3$ (一般情况)。\n3. $\\theta = \\pi$ (复数场的符号翻转)。\n4. $\\theta = 2\\pi$ (相位的周期性)。\n5. $\\theta = 10^{-8}$ (小角度边缘情况)。\n\n对于每个测试用例，返回一个布尔值，指示是否两个条件都在容差范围内成立：\n- $\\max_{x,y}|\\rho'(x,y)-\\rho(x,y)| \\le 10^{-11}$。\n- $|E' - E| \\le 10^{-11}$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果，例如，\"[True,True,False,True,True]\"。顺序必须与上面列出的测试套件角度相对应。不允许外部输入，所有计算都必须按规定在无量纲单位下进行。",
            "solution": "该问题要求验证从二维薛定谔-泊松系统导出的物理诊断量的全局相位不变性。这个原理是量子力学的一个基石，它假定波函数的全局相位变换 $\\psi \\to \\psi' = e^{i\\theta}\\psi$（其中 $\\theta$ 是一个实常数相角）不会改变任何物理可观测量。我们将首先对指定的诊断量解析地证明这种不变性，然后概述在给定容差内对其进行数值验证的程序。\n\n无量纲单位为 $\\hbar=1$, $m=1$, $G=1$，周期性域的边长为 $L=1$。\n\n**1. 解析不变性**\n\n我们必须证明质量密度 $\\rho$ 和总能量 $E$ 在变换 $\\psi' = e^{i\\theta}\\psi$ 下是不变的。\n\n**a. 质量密度 ($\\rho$)**\n质量密度定义为 $\\rho = m|\\psi|^2$。对于变换后的波函数 $\\psi'$，新的密度 $\\rho'$ 为：\n$$\n\\rho' = m|\\psi'|^2 = m|e^{i\\theta}\\psi|^2\n$$\n使用复数的性质 $|z_1 z_2| = |z_1| |z_2|$，我们得到：\n$$\n\\rho' = m|e^{i\\theta}|^2 |\\psi|^2\n$$\n因为 $\\theta$ 是一个实数，所以 $|e^{i\\theta}|^2 = |\\cos\\theta + i\\sin\\theta|^2 = \\cos^2\\theta + \\sin^2\\theta = 1$。因此，\n$$\n\\rho' = m(1)|\\psi|^2 = m|\\psi|^2 = \\rho\n$$\n质量密度 $\\rho$ 在全局相位旋转下是解析不变的。\n\n**b. 总能量 ($E$)**\n总能量是动能 $T$ 和引力势能 $U$ 的和，即 $E = T + U$。我们分别考察每一项。\n\n**i. 引力势能 ($U$)**\n势能为 $U = \\frac{1}{2}\\int \\rho \\Phi \\, d^2x$。势 $\\Phi$ 由周期性域上的泊松方程决定：$\\nabla^2 \\Phi = 4\\pi G (\\rho - \\overline{\\rho})$，其中 $\\overline{\\rho}$ 是 $\\rho$ 的空间平均值。如上所示，$\\rho'=\\rho$。因此，空间平均值也保持不变：$\\overline{\\rho'} = \\overline{\\rho}$。泊松方程的源项 $(\\rho - \\overline{\\rho})$ 保持不变。在源项和边界条件相同的情况下（这里通过将零频模式 $\\Phi_{\\mathbf{k}=0}$ 设为零来处理），势的解也必须相同。因此，$\\Phi' = \\Phi$。\n\n变换后系统的势能为：\n$$\nU' = \\frac{1}{2}\\int \\rho' \\Phi' \\, d^2x = \\frac{1}{2}\\int \\rho \\Phi \\, d^2x = U\n$$\n因此，引力势能是不变的。\n\n**ii. 动能 ($T$)**\n动能定义为 $T = \\frac{\\hbar^2}{2m} \\int |\\nabla \\psi|^2 \\, d^2x$。对于变换后的场 $\\psi'$，其梯度为：\n$$\n\\nabla \\psi' = \\nabla (e^{i\\theta}\\psi)\n$$\n由于 $\\theta$ 是一个空间常数，指数因子可以从导数中提出：\n$$\n\\nabla \\psi' = e^{i\\theta} (\\nabla \\psi)\n$$\n梯度的模平方则为：\n$$\n|\\nabla \\psi'|^2 = |e^{i\\theta} (\\nabla \\psi)|^2 = |e^{i\\theta}|^2 |\\nabla \\psi|^2 = (1) |\\nabla \\psi|^2 = |\\nabla \\psi|^2\n$$\n动能泛函的被积函数是相同的。因此，动能是不变的：\n$$\nT' = \\frac{\\hbar^2}{2m} \\int |\\nabla \\psi'|^2 \\, d^2x = \\frac{\\hbar^2}{2m} \\int |\\nabla \\psi|^2 \\, d^2x = T\n$$\n\n**iii. 总能量 ($E$)**\n由于动能和势能分量都是不变的（$T'=T$ 和 $U'=U$），它们的和，即总能量，也必定是不变的：\n$$\nE' = T' + U' = T + U = E\n$$\n这就完成了不变性的解析证明。数值任务是验证诊断工具的正确实现是否在浮点精度范围内遵循这一基本对称性。\n\n**2. 数值实现策略**\n\n验证将在边长为 $L=1$ 的域上，使用大小为 $N \\times N$（其中 $N=64$）的均匀笛卡尔网格进行。网格间距为 $\\Delta x = \\Delta y = L/N$。\n\n**a. 初始状态构造**\n构造一个非平凡的初始复数场 $\\psi(x, y)$，确保它既不是纯实数也不是空间均匀的，从而提供一个鲁棒的测试用例。一个局域高斯函数、平面波和一个常数偏移量的叠加是合适的：\n$$\n\\psi(x,y) = A_1 e^{-r^2/(2\\sigma^2)} e^{i(k_{x1}x + k_{y1}y)} + A_2 e^{i(k_{x2}x + k_{y2}y)} + C\n$$\n其中 $r^2 = (x-x_c)^2 + (y-y_c)^2$，对应某个中心点 $(x_c, y_c)$。这种形式确保了场在整个域上具有变化的振幅和相位。\n\n**b. 诊断量计算（谱方法）**\n所有的空间导数和泊松方程都在傅里葉空间中处理，以保证精度并正确实现周期性边界条件。\n\n- **网格和频率**：我们定义空间坐标 $x_j=j\\Delta x, y_l=l\\Delta y$ 以及相应的角波矢 $k_x, k_y$，使用 `fftfreq` 函数并乘以 $2\\pi$ 来计算：$k_{x,n} = 2\\pi n / L$，其中 $n$ 为整数模数。\n- **密度 $\\rho$**：直接在实空间计算：$\\rho_{j,l} = m|\\psi_{j,l}|^2$。\n- **势 $\\Phi$**：\n    1. 计算源项 $S(x,y) = \\rho(x,y) - \\overline{\\rho}$，其中 $\\overline{\\rho} = \\frac{1}{N^2}\\sum_{j,l} \\rho_{j,l}$。\n    2. 计算源项的二维快速傅里叶变换 (FFT)：$S_{\\mathbf{k}} = \\mathcal{F}[S]$。\n    3. 在傅里叶空间中求解势：对于 $\\mathbf{k} \\neq \\mathbf{0}$，$\\Phi_{\\mathbf{k}} = -\\frac{4\\pi G}{|\\mathbf{k}|^2} S_{\\mathbf{k}}$。$|\\mathbf{k}|^2$ 项是 $k_x^2 + k_y^2$。零频模式设为零，即 $\\Phi_{\\mathbf{k}=\\mathbf{0}}=0$，以满足问题要求并解决奇点问题。\n    4. 计算二维傅里叶逆变换以获得实空间中的势：$\\Phi(x,y) = \\mathcal{F}^{-1}[\\Phi_{\\mathbf{k}}]$。\n- **动能 $T$**：\n    1. 计算波函数的 FFT：$\\psi_{\\mathbf{k}} = \\mathcal{F}[\\psi]$。\n    2. 通过乘以 $i\\mathbf{k}$ 来计算空间导数的傅里叶变换：$(\\partial_x\\psi)_{\\mathbf{k}} = ik_x \\psi_{\\mathbf{k}}$ 和 $(\\partial_y\\psi)_{\\mathbf{k}} = ik_y \\psi_{\\mathbf{k}}$。\n    3. 计算傅里叶逆变换以得到实空间梯度：$\\partial_x\\psi = \\mathcal{F}^{-1}[ik_x \\psi_{\\mathbf{k}}]$ 和 $\\partial_y\\psi = \\mathcal{F}^{-1}[ik_y \\psi_{\\mathbf{k}}]$。\n    4. 在实空间中计算动能的被积函数：$|\\nabla\\psi|^2 = |\\partial_x\\psi|^2 + |\\partial_y\\psi|^2$。\n    5. 在域上进行数值积分：$T = \\frac{\\hbar^2}{2m} \\sum_{j,l} |\\nabla\\psi|^2_{j,l} (\\Delta x)^2$。\n- **势能 $U$**：在实空间中进行数值积分：$U = \\frac{1}{2} \\sum_{j,l} \\rho_{j,l} \\Phi_{j,l} (\\Delta x)^2$。\n- **总能量 $E$**：$E=T+U$。\n\n**c. 验证程序**\n对于测试套件中的每个角度 $\\theta$，我们执行以下步骤：\n1.  计算初始场 $\\psi$ 的参考诊断量 $(\\rho, E)$。\n2.  构造旋转后的场 $\\psi' = \\psi \\cdot e^{i\\theta}$。\n3.  计算场 $\\psi'$ 的新诊断量 $(\\rho', E')$。\n4.  计算密度场的最大绝对差：$\\Delta\\rho = \\max|\\rho' - \\rho|$。\n5.  计算总能量的绝对差：$\\Delta E = |E' - E|$。\n6.  如果 $\\Delta\\rho \\le 10^{-11}$ 和 $\\Delta E \\le 10^{-11}$ 同时满足，则测试用例通过。\n\n这个程序严格测试了诊断量的数值实现是否遵循全局相位不变性的基本物理原理，其差异仅源于有限精度的浮点运算。角度的选择包括 $0$、$2\\pi$、一个小值和一个通用值，确保了测试的鲁棒性。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Verifies the global phase invariance of Schrödinger-Poisson diagnostics.\n    \"\"\"\n    # Define constants in dimensionless code units\n    N = 64\n    L = 1.0\n    hbar = 1.0\n    m = 1.0\n    G = 1.0\n    TOLERANCE = 1e-11\n\n    # Define spatial grid and Fourier space wavenumbers\n    x = np.linspace(0, L, N, endpoint=False)\n    dx = L / N\n    \n    # Angular wavenumbers\n    k = 2 * np.pi * np.fft.fftfreq(N, d=dx)\n    \n    X, Y = np.meshgrid(x, x, indexing='ij')\n    Kx, Ky = np.meshgrid(k, k, indexing='ij')\n    K_squared = Kx**2 + Ky**2\n\n    # Construct a non-trivial initial wavefunction psi(x, y)\n    # This combines a localized Gaussian, two plane waves, and a constant offset.\n    r_squared = (X - L / 4)**2 + (Y - L / 4)**2\n    sigma = L / 10\n    gaussian_component = 0.5 * np.exp(-r_squared / (2 * sigma**2))\n    \n    # Plane waves with integer mode numbers (nx, ny)\n    # exp(i * (k_x*x + k_y*y)) = exp(i * 2*pi/L * (nx*x + ny*y))\n    plane_wave_1 = np.exp(1j * 2 * np.pi / L * (1 * X + 2 * Y))\n    plane_wave_2 = 0.2 * np.exp(1j * 2 * np.pi / L * (4 * X - 3 * Y))\n    \n    psi_initial = gaussian_component * plane_wave_1 + plane_wave_2 + 0.01\n\n    def compute_diagnostics(psi):\n        \"\"\"\n        Computes the density (rho) and total energy (E) for a given wavefunction.\n        \"\"\"\n        # Mass density\n        rho = m * np.abs(psi)**2\n        \n        # --- Gravitational Potential Energy (U) ---\n        # Source for Poisson equation: rho - rho_mean\n        rho_mean = np.mean(rho)\n        rho_src = rho - rho_mean\n        \n        # Solve Poisson equation in Fourier space\n        rho_src_k = np.fft.fftn(rho_src)\n        \n        # Avoid division by zero at k=0\n        # The value at this index does not matter as rho_src_k[0, 0] is zero\n        # but we set it to 1 for numerical stability.\n        K_squared_no_zero = K_squared.copy()\n        if K_squared_no_zero[0, 0] == 0:\n            K_squared_no_zero[0, 0] = 1.0\n\n        phi_k = -4 * np.pi * G * rho_src_k / K_squared_no_zero\n        # Explicitly set the zero-mode of the potential to zero\n        phi_k[0, 0] = 0.0\n        \n        # Inverse FFT to get potential in real space. It must be real.\n        phi = np.fft.ifftn(phi_k).real\n\n        # Potential energy\n        dV = dx**2\n        potential_energy_U = 0.5 * np.sum(rho * phi) * dV\n\n        # --- Kinetic Energy (T) ---\n        psi_k = np.fft.fftn(psi)\n        \n        # Gradients in Fourier space\n        grad_psi_x_k = 1j * Kx * psi_k\n        grad_psi_y_k = 1j * Ky * psi_k\n        \n        # Gradients in real space\n        grad_psi_x = np.fft.ifftn(grad_psi_x_k)\n        grad_psi_y = np.fft.ifftn(grad_psi_y_k)\n        \n        # Kinetic energy integrand\n        grad_psi_sq = np.abs(grad_psi_x)**2 + np.abs(grad_psi_y)**2\n        \n        # Kinetic energy\n        kinetic_energy_T = (hbar**2 / (2 * m)) * np.sum(grad_psi_sq) * dV\n        \n        # Total energy\n        total_energy_E = kinetic_energy_T + potential_energy_U\n        \n        return rho, total_energy_E\n\n    # Compute reference diagnostics for the original field\n    rho_ref, E_ref = compute_diagnostics(psi_initial)\n\n    # Test suite angles in radians\n    test_angles = [\n        0.0,\n        np.pi / 3,\n        np.pi,\n        2 * np.pi,\n        1e-8\n    ]\n\n    results = []\n    for theta in test_angles:\n        # Apply global phase rotation\n        psi_prime = psi_initial * np.exp(1j * theta)\n        \n        # Compute diagnostics for the rotated field\n        rho_prime, E_prime = compute_diagnostics(psi_prime)\n        \n        # Compare diagnostics against the reference\n        max_rho_diff = np.max(np.abs(rho_prime - rho_ref))\n        abs_E_diff = np.abs(E_prime - E_ref)\n        \n        # Check if both differences are within tolerance\n        is_invariant = (max_rho_diff = TOLERANCE) and (abs_E_diff = TOLERANCE)\n        results.append(is_invariant)\n\n    # Final print statement in the exact required format\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "在静态诊断量通过验证后，下一步是测试求解器的完整动力学演化。薛定谔方程满足伽利略不变性，即物理定律在所有惯性参考系中都具有相同的形式。本练习  通过对初始条件施加伽利略助推并验证其动力学等效于一个匀速运动的系统，对整个时间步进算法进行严格测试，从而确保你的数值方案能正确处理动能项与势能项的相互作用。",
            "id": "3485529",
            "problem": "考虑用于模糊或超轻暗物质的一维 Schrödinger–Poisson 系统，该系统位于长度为 $L$ 的周期性域中：\n$$\ni\\hbar \\frac{\\partial \\psi(x,t)}{\\partial t} \\;=\\; -\\frac{\\hbar^2}{2m}\\frac{\\partial^2 \\psi(x,t)}{\\partial x^2} \\;+\\; m\\,\\phi(x,t)\\,\\psi(x,t),\n$$\n该系统与牛顿引力势的 Poisson 方程耦合，\n$$\n\\frac{\\partial^2 \\phi(x,t)}{\\partial x^2} \\;=\\; 4\\pi G\\left(\\rho(x,t) - \\overline{\\rho}\\right),\n$$\n其中质量密度为 $\\rho(x,t)=|\\psi(x,t)|^2$，空间平均值为 $\\overline{\\rho}=\\frac{1}{L}\\int_0^L \\rho(x,t)\\,dx$。假设采用周期性边界条件，并使用无量纲代码单位，使得 $\\hbar=1$，$m=1$，并将 $4\\pi G$ 写为无量纲耦合常数 $\\gamma$。\n\nSchrödinger 方程的伽利略增强对称性意味着，将初始波函数乘以平面波相位因子 $e^{i k x}$ 会增加一个均匀速度场，而不会改变初始密度。在 Madelung 表象中，写作 $\\psi(x,t)=\\sqrt{\\rho(x,t)}\\,e^{i S(x,t)}$，速度场为 $v(x,t)=\\frac{\\hbar}{m}\\,\\frac{\\partial S}{\\partial x}$，局部流为 $j(x,t)=\\frac{\\hbar}{m}\\,\\mathrm{Im}\\left(\\psi^*(x,t)\\,\\frac{\\partial \\psi(x,t)}{\\partial x}\\right)$。当对初始为实数且为正的 $\\psi$ 应用增强 $\\psi\\to e^{i k x}\\psi$ 时，预期的均匀速度为 $v=\\frac{\\hbar}{m}k$。\n\n你的任务是使用 Strang 分步法在均匀网格上为上述系统实现一个数值求解器：\n- 在位形空间中，使用势能项 $e^{-i(m/\\hbar)\\phi\\,\\Delta t/2}$ 将波函数推进半个时间步长。\n- 在傅里叶空间中，使用动能项 $e^{-i(\\hbar k^2/2m)\\,\\Delta t}$ 推进一个完整的时间步长，其中 $k$ 是波数。\n- 使用更新后的势能再次推进半个时间步长。\n在每一步中，通过在傅里叶空间中求解 Poisson 方程来计算 $\\phi$：\n$$\n\\widehat{\\phi}(k) \\;=\\; -\\frac{\\gamma}{k^2}\\,\\widehat{\\rho - \\overline{\\rho}}\\,(k) \\quad \\text{for } k\\neq 0, \\quad \\widehat{\\phi}(0)=0,\n$$\n其中帽子符号表示傅里叶变换。使用谱方法计算的周期性傅里叶导数 $\\frac{\\partial \\psi}{\\partial x}$ 来提取速度。\n\n你必须通过以下方式对伽利略增强进行数值测试：\n1. 初始化一个归一化的高斯波函数，\n$$\n\\psi_0(x) = A\\,\\exp\\!\\left(-\\frac{(x-x_0)^2}{2\\sigma^2}\\right),\n$$\n其中 $A$ 的选择应使得 $\\int_0^L |\\psi_0(x)|^2\\,dx = 1$，且 $x_0=L/2$。\n2. 创建一个增强的初始条件 $\\psi_b(x,0) = e^{i k x}\\,\\psi_0(x)$，其中 $k=\\frac{2\\pi n}{L}$，$n$ 为整数。\n3. 使用相同的参数将未增强和增强的初始条件演化到共同的最终时间 $T$。\n4. 计算从增强的初始条件中提取的质量加权平均速度，\n$$\n\\overline{v} \\;=\\; \\frac{\\int_0^L \\rho(x,0)\\,v(x,0)\\,dx}{\\int_0^L \\rho(x,0)\\,dx} \\;=\\; \\frac{\\int_0^L j(x,0)\\,dx}{\\int_0^L \\rho(x,0)\\,dx},\n$$\n并将其与理论值 $v=\\frac{\\hbar}{m}k$ 进行比较。\n5. 通过将增强后的密度 $\\rho_b(x,t)$ 与未增强密度的空间平移版本 $\\rho_0(x-vt,t)$ 进行比较，来验证动力学的参考系不变性。其中平移使用傅里叶平移定理在模 $L$ 下进行。使用相对 $L^2$ 误差来量化差异：\n$$\n\\epsilon(t) \\;=\\; \\frac{\\left\\|\\rho_b(x,t) - \\rho_0(x-vt,t)\\right\\|_{L^2}}{\\left\\|\\rho_0(x,t)\\right\\|_{L^2}}.\n$$\n报告在多个时间快照中的最大误差。\n\n在这些代码单位中，所有量都是无量纲的，因此输出中不需要物理单位。由于使用了傅里叶变换，角度被隐式地以弧度为单位。\n\n实现你的程序以运行以下测试套件，其中每个测试用例是一个指定 $(N, L, \\Delta t, \\text{steps}, n, \\sigma, \\gamma)$ 的元组：\n- 情况 1（基线，零增强）： $(256, 1.0, 1\\times 10^{-4}, 800, 0, 0.08, 1.0)$。\n- 情况 2（中等增强）： $(256, 1.0, 1\\times 10^{-4}, 800, 1, 0.08, 1.0)$。\n- 情况 3（较粗网格，更强增强）： $(128, 1.0, 1\\times 10^{-4}, 800, 3, 0.12, 1.0)$。\n- 情况 4（精细网格，高增强）： $(512, 1.0, 1\\times 10^{-4}, 800, 10, 0.05, 1.0)$。\n\n对于每个测试用例，输出两个浮点数：\n- 从增强的初始条件在 $t=0$ 时提取的质量加权平均速度 $\\overline{v}$。\n- 在快照时间 $t\\in\\{0, T/4, T/2, 3T/4, T\\}$ 上的最大相对 $L^2$ 误差 $\\max_t \\epsilon(t)$，其中 $T = \\text{steps}\\times \\Delta t$。\n\n最终输出格式：你的程序应生成单行输出，其中包含按测试用例顺序排列的、用逗号分隔并括在方括号中的结果列表，每个测试用例依次贡献其两个浮点数。例如，输出必须如下所示\n“[v1,e1,v2,e2,v3,e3,v4,e4]”。",
            "solution": "用户在数值宇宙学领域提供了一个明确定义的计算问题，具体涉及用于模糊或超轻暗物质的 Schrödinger-Poisson 方程的模拟。我将首先正式验证问题陈述，然后进行详细的、基于原理的求解。\n\n### 第 1 步：提取已知条件\n\n- **控制方程：**\n    1.  含时 Schrödinger 方程：\n        $$\n        i\\hbar \\frac{\\partial \\psi(x,t)}{\\partial t} \\;=\\; -\\frac{\\hbar^2}{2m}\\frac{\\partial^2 \\psi(x,t)}{\\partial x^2} \\;+\\; m\\,\\phi(x,t)\\,\\psi(x,t)\n        $$\n    2.  引力势 $\\phi$ 的 Poisson 方程：\n        $$\n        \\frac{\\partial^2 \\phi(x,t)}{\\partial x^2} \\;=\\; 4\\pi G\\left(\\rho(x,t) - \\overline{\\rho}\\right)\n        $$\n- **定义：**\n    - 质量密度：$\\rho(x,t)=|\\psi(x,t)|^2$\n    - 空间平均密度：$\\overline{\\rho}=\\frac{1}{L}\\int_0^L \\rho(x,t)\\,dx$\n    - 流：$j(x,t)=\\frac{\\hbar}{m}\\,\\mathrm{Im}\\left(\\psi^*(x,t)\\,\\frac{\\partial \\psi(x,t)}{\\partial x}\\right)$\n    - 伽利略增强：$\\psi \\to e^{i k x}\\psi$\n    - 增强产生的理论速度：$v=\\frac{\\hbar}{m}k$\n- **边界条件：** 在长度为 $L$ 的域上周期性。\n- **代码单位：** $\\hbar=1$，$m=1$ 及 $\\gamma = 4\\pi G$。\n- **数值方法：**\n    - **时间积分：** Strang 分步法。\n        - 势能步：使用 $e^{-i(m/\\hbar)\\phi\\,\\Delta t/2}$ 推进 $\\Delta t/2$。\n        - 动能步：在傅里叶空间中使用 $e^{-i(\\hbar k_{wave}^2/2m)\\,\\Delta t}$ 推进 $\\Delta t$。\n    - **Poisson 求解器：** 在傅里叶空间中，$\\widehat{\\phi}(k) = -\\frac{\\gamma}{k_{wave}^2}\\,\\widehat{\\rho - \\overline{\\rho}}\\,(k)$，其中 $k_{wave}\\neq 0$，且 $\\widehat{\\phi}(0)=0$。\n    - **导数：** 谱方法计算 $\\frac{\\partial \\psi}{\\partial x}$。\n- **初始条件：**\n    - 未增强：$\\psi_0(x) = A\\,\\exp\\!\\left(-\\frac{(x-x_0)^2}{2\\sigma^2}\\right)$，归一化使得 $\\int_0^L |\\psi_0(x)|^2\\,dx = 1$，且 $x_0=L/2$。\n    - 增强：$\\psi_b(x,0) = e^{i k x}\\,\\psi_0(x)$，其中 $k=\\frac{2\\pi n}{L}$，$n$ 为整数。\n- **任务与输出：**\n    1.  计算 $t=0$ 时的质量加权平均速度：$\\overline{v} = \\frac{\\int_0^L j(x,0)\\,dx}{\\int_0^L \\rho(x,0)\\,dx}$。\n    2.  计算在快照时间 $t\\in\\{0, T/4, T/2, 3T/4, T\\}$ 上的最大相对 $L^2$ 误差 $\\max_t \\epsilon(t)$，其中 $T = \\text{steps}\\times \\Delta t$ 且\n        $$\n        \\epsilon(t) = \\frac{\\left\\|\\rho_b(x,t) - \\rho_0(x-vt,t)\\right\\|_{L^2}}{\\left\\|\\rho_0(x,t)\\right\\|_{L^2}}\n        $$\n- **测试用例：** 一组四个元组 $(N, L, \\Delta t, \\text{steps}, n, \\sigma, \\gamma)$:\n    - 情况 1: $(256, 1.0, 1\\times 10^{-4}, 800, 0, 0.08, 1.0)$\n    - 情况 2: $(256, 1.0, 1\\times 10^{-4}, 800, 1, 0.08, 1.0)$\n    - 情况 3: $(128, 1.0, 1\\times 10^{-4}, 800, 3, 0.12, 1.0)$\n    - 情况 4: $(512, 1.0, 1\\times 10^{-4}, 800, 10, 0.05, 1.0)$\n\n### 第 2 步：使用提取的已知条件进行验证\n\n- **科学依据：** 该问题描述了 Schrödinger-Poisson 系统，这是天体物理学中研究超轻或模糊暗物质的一个标准且广泛使用的模型。数值方法（分步傅里叶法）是解决此类问题的典型技术。伽利略不变性测试是一项基本的物理验证。该问题在科学上是合理的。\n- **适定性：** 该问题是一个为偏微分方程组定义的适定初值问题。所有必要的参数、初始条件、常数和算法规范都已提供，使得问题适定且可解。\n- **客观性：** 问题使用精确、形式化的数学和计算语言陈述，没有任何主观性或歧义。\n- **完整性与一致性：** 问题是自洽的。在 Poisson 求解器中处理 $k_{wave}=0$ 模式的规范 $\\widehat{\\phi}(0)=0$ 与减去平均密度 $\\overline{\\rho}$ 的做法是一致的，这确保了在周期性域上的质量守恒。\n- **可行性：** 指定的网格大小、时间步长和步数参数都在现代计算硬件的合理范围内，使得模拟是可行的。\n- **结构：** 问题结构清晰，有一系列特定任务和明确定义的输出格式，没有解释的空间。\n\n### 第 3 步：结论与行动\n\n根据所有验证标准，该问题是 **有效的**。将开发并实现一个解决方案。\n\n### 基于原理的解决方案设计\n\n解决方案将围绕一个实现指定算法的数值求解器构建。所有计算都将在 $\\hbar=1$ 和 $m=1$ 的无量纲代码单位中执行。\n\n**1. 离散化：**\n长度为 $L$ 的一维周期性域被离散化为一个由 $N$ 个点组成的均匀网格，$x_j = j \\Delta x$，其中 $j=0, \\dots, N-1$，$\\Delta x = L/N$。离散傅里叶变换对应的波数为 $k_q = \\frac{2\\pi q}{L}$，其中 $q$ 是由快速傅里叶变换 (FFT) 程序提供的离散频率。\n\n**2. 时间演化 (Strang 分裂法)：**\nSchrödinger 方程的形式为 $i\\frac{\\partial\\psi}{\\partial t} = (\\hat{T} + \\hat{V})\\psi$，其中 $\\hat{T} = -\\frac{\\hbar^2}{2m}\\nabla^2$ 是动能算符，$\\hat{V} = m\\phi$ 是势能算符。Strang 分裂法为时间演化算符提供了一个二阶精确的近似：\n$$\n\\psi(t+\\Delta t) \\approx e^{-i\\hat{V}(t+\\Delta t/2)\\Delta t/2} \\, e^{-i\\hat{T}\\Delta t} \\, e^{-i\\hat{V}(t)\\Delta t/2} \\, \\psi(t)\n$$\n由于势能 $\\hat{V}$ 是非线性的（它通过 $\\phi$ 依赖于 $\\psi$），我们在每个半步都重新计算它。数值实现遵循“踢-漂移-踢”(kick-drift-kick) 方案：\n- **踢 (势能半步)：** 势能 $\\phi$ 是根据当前波函数 $\\psi$ 计算的。然后通过将波函数乘以相位因子 $e^{-i\\phi \\Delta t/2}$（因为 $m=1$）来更新它。此步骤在位置空间中执行。\n- **漂移 (动能整步)：** 动能演化最容易在傅里叶空间中执行，其中二阶导数算符 $\\frac{\\partial^2}{\\partial x^2}$ 变为乘以 $-k_{wave}^2$。波函数 $\\psi$ 被变换到傅里叶空间 ($\\hat{\\psi}$)，乘以相位因子 $e^{-i(k_{wave}^2/2) \\Delta t}$（因为 $\\hbar=1, m=1$），然后变换回位置空间。\n- **踢 (势能半步)：** 用从动能步获得的新波函数重复势能步。\n\n**3. Poisson 求解器：**\n在每个势能步中，必须确定引力势 $\\phi$。这通过在傅里叶空间求解 Poisson 方程来完成：\n1.  计算密度 $\\rho(x) = |\\psi(x)|^2$ 及其空间平均值 $\\overline{\\rho}$。\n2.  计算密度涨落的傅里叶变换 $\\widehat{\\rho-\\overline{\\rho}}(k_{wave})$。\n3.  求解势能的傅里叶模式：$\\widehat{\\phi}(k_{wave}) = -\\frac{\\gamma}{k_{wave}^2} \\widehat{\\rho-\\overline{\\rho}}(k_{wave})$。通过设置 $\\widehat{\\phi}(0)=0$ 来处理 $k_{wave}=0$ 的情况，这避免了除以零，并且在物理上与问题设置一致。\n4.  计算 $\\widehat{\\phi}(k_{wave})$ 的傅里叶逆变换以获得 $\\phi(x)$。由于势能必须是实数，因此丢弃由数值噪声引起的微小虚部。\n\n**4. 可观测量计算：**\n- **平均速度：** 质量加权平均速度 $\\overline{v}$ 是从初始的增强波函数 $\\psi_b(x,0)$ 计算的。流 $j(x,0)$ 是使用谱导数找到的：$\\frac{\\partial \\psi_b}{\\partial x} = \\mathcal{F}^{-1}\\{i k_{wave} \\mathcal{F}\\{\\psi_b\\}\\}$。然后计算 $j = \\mathrm{Im}(\\psi_b^* \\frac{\\partial \\psi_b}{\\partial x})$，其在域上的积分给出 $\\overline{v}$（因为总质量归一化为 $1$）。解析结果 $\\overline{v} = (\\hbar/m)k = k$ 可用于验证此数值计算。\n- **参考系不变性误差：** 为了计算误差 $\\epsilon(t)$，演化未增强的密度 $\\rho_0(x,t)$ 并存储快照。对于每个快照，密度被空间平移一个量 $v \\cdot t$，其中 $v$ 是理论增强速度 $k$。使用傅里叶平移定理在傅里叶空间中精确执行此平移：$\\mathcal{F}\\{f(x-a)\\} = e^{-ik_{wave}a}\\mathcal{F}\\{f(x)\\}}$。计算增强密度 $\\rho_b(x,t)$ 和平移后的未增强密度 $\\rho_0(x-vt, t)$ 之差的 $L^2$ 范数，并用 $\\rho_0(x,t)$ 的 $L^2$ 范数进行归一化。报告所有快照中这些相对误差的最大值。$L^2$ 范数的数值表示为 $\\|\\cdot\\|_{L^2} \\approx \\sqrt{\\sum (\\cdot)^2 \\Delta x}$。\n\n将使用一个把此逻辑封装在求解器类中的 Python 实现来运行指定的测试用例，并生成所需格式的最终输出。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the Schrödinger-Poisson simulation test suite.\n    \"\"\"\n\n    class SchrodingerPoissonSolver:\n        \"\"\"\n        Solves the 1D Schrödinger-Poisson system using a Strang split-step Fourier method.\n        \"\"\"\n        def __init__(self, N, L, dt, gamma):\n            self.N = N\n            self.L = L\n            self.dt = dt\n            self.gamma = gamma\n\n            self.dx = L / N\n            self.x = np.linspace(0, L, N, endpoint=False)\n            \n            # Wavenumbers (k) for Fourier transforms\n            freq = np.fft.fftfreq(N, d=self.dx)\n            self.k_wave = 2 * np.pi * freq\n            \n            # Pre-calculate the kinetic evolution operator for a full time step.\n            # The operator is exp(-i * T * dt), where T is the kinetic energy operator.\n            # In Fourier space, T becomes hbar^2*k^2/(2m). With hbar=m=1, T_k = k^2/2.\n            self.kinetic_op = np.exp(-1j * (self.k_wave**2) / 2.0 * self.dt)\n\n            # Pre-calculate the inverse of k^2 for the Poisson solver.\n            # The operator in k-space is -gamma/k^2 for k != 0.\n            self.poisson_k_op = np.zeros_like(self.k_wave)\n            nonzero_k_indices = self.k_wave != 0\n            self.poisson_k_op[nonzero_k_indices] = -self.gamma / (self.k_wave[nonzero_k_indices]**2)\n\n        def _solve_poisson(self, rho):\n            \"\"\"Solves the Poisson equation in Fourier space.\"\"\"\n            rho_mean = np.mean(rho)\n            rho_minus_mean = rho - rho_mean\n            \n            rho_k = np.fft.fft(rho_minus_mean)\n            phi_k = self.poisson_k_op * rho_k\n            \n            phi = np.fft.ifft(phi_k)\n            return phi.real\n\n        def _potential_step(self, psi):\n            \"\"\"Applies the potential operator for half a time step.\"\"\"\n            rho = np.abs(psi)**2\n            phi = self._solve_poisson(rho)\n            potential_op_half_step = np.exp(-1j * phi * self.dt / 2.0)\n            return psi * potential_op_half_step\n\n        def _kinetic_step(self, psi):\n            \"\"\"Applies the kinetic operator for a full time step.\"\"\"\n            psi_k = np.fft.fft(psi)\n            psi_k_evolved = psi_k * self.kinetic_op\n            return np.fft.ifft(psi_k_evolved)\n\n        def evolve_step(self, psi):\n            \"\"\"Performs one full time step using Strang splitting (kick-drift-kick).\"\"\"\n            psi = self._potential_step(psi)\n            psi = self._kinetic_step(psi)\n            psi = self._potential_step(psi)\n            return psi\n\n    def run_case(params):\n        \"\"\"\n        Runs a single test case for the Schrödinger-Poisson simulation.\n        \"\"\"\n        N, L, dt, steps, n, sigma, gamma = params\n        \n        solver = SchrodingerPoissonSolver(N, L, dt, gamma)\n        x, dx, k_wave = solver.x, solver.dx, solver.k_wave\n\n        # 1. Initialize unboosted wavefunction (normalized Gaussian)\n        psi0_unnormalized = np.exp(-(x - L / 2.0)**2 / (2 * sigma**2))\n        norm = np.sqrt(np.sum(np.abs(psi0_unnormalized)**2) * dx)\n        psi0 = psi0_unnormalized / norm\n\n        # 2. Create boosted initial condition\n        boost_k = (2.0 * np.pi * n) / L\n        psi_b_t0 = psi0 * np.exp(1j * boost_k * x)\n        \n        # 4. Compute mass-weighted mean velocity at t=0\n        psi_b_t0_k = np.fft.fft(psi_b_t0)\n        d_psi_b_dx = np.fft.ifft(1j * k_wave * psi_b_t0_k)\n        j_b_t0 = np.imag(np.conj(psi_b_t0) * d_psi_b_dx) # hbar=m=1\n        v_mean = np.sum(j_b_t0) * dx\n        \n        v_theory = boost_k\n\n        # 3/5. Evolve both ICs and compute discrepancy\n        snapshot_steps = sorted(list(set([0, steps // 4, steps // 2, 3 * steps // 4, steps])))\n        \n        sim_results = {}\n        for sim_type, psi_initial in [('unboosted', psi0), ('boosted', psi_b_t0)]:\n            snapshots = {}\n            psi = np.copy(psi_initial)\n            \n            if 0 in snapshot_steps:\n                snapshots[0] = np.abs(psi)**2\n                \n            for step in range(1, steps + 1):\n                psi = solver.evolve_step(psi)\n                if step in snapshot_steps:\n                    snapshots[step] = np.abs(psi)**2\n            sim_results[sim_type] = snapshots\n\n        rho0_snapshots = sim_results['unboosted']\n        rhob_snapshots = sim_results['boosted']\n        \n        errors = []\n        for step_num in snapshot_steps:\n            t = step_num * dt\n            rho_b = rhob_snapshots[step_num]\n            rho_0 = rho0_snapshots[step_num]\n            \n            shift = (v_theory * t)\n            rho_0_k = np.fft.fft(rho_0)\n            shift_phase = np.exp(-1j * k_wave * shift)\n            rho_0_shifted = np.fft.ifft(rho_0_k * shift_phase).real\n            \n            diff_rho_sq = (rho_b - rho_0_shifted)**2\n            numerator = np.sqrt(np.sum(diff_rho_sq) * dx)\n            \n            rho_0_sq = rho_0**2\n            denominator = np.sqrt(np.sum(rho_0_sq) * dx)\n            \n            error = numerator / denominator if denominator != 0 else (0.0 if numerator == 0.0 else np.inf)\n            errors.append(error)\n            \n        max_error = np.max(errors)\n        \n        return v_mean, max_error\n\n    test_cases = [\n        (256, 1.0, 1e-4, 800, 0, 0.08, 1.0),\n        (256, 1.0, 1e-4, 800, 1, 0.08, 1.0),\n        (128, 1.0, 1e-4, 800, 3, 0.12, 1.0),\n        (512, 1.0, 1e-4, 800, 10, 0.05, 1.0),\n    ]\n\n    results = []\n    for case in test_cases:\n        v_mean, max_error = run_case(case)\n        results.extend([v_mean, max_error])\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}