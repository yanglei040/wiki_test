{
    "hands_on_practices": [
        {
            "introduction": "在估算功率谱之前，我们必须首先理解其所处的离散傅里叶空间的结构。这个练习将引导你掌握傅里叶网格的基本属性，例如奈奎斯特频率（Nyquist frequency），以及如何精确地计算给定波数壳层内的独立模式数量。通过这个实践，你将巩固对实空间网格参数（如盒子大小 $L$ 和网格数 $N$）与 $k$ 空间基本参数（如基本频率 $k_f$ 和奈奎斯特频率 $k_{\\text{Ny}}$）之间关系的理解，并熟悉为降低功率谱估计中统计噪声而进行模式合并（binning）的实际操作 。",
            "id": "3481934",
            "problem": "考虑一个在边长为 $L$ 的周期性立方体盒子内，在大小为 $N^{3}$ 的离散均匀网格上采样的统计均匀标量场。对该盒子进行离散傅里叶变换，因此允许的波矢量是那些与周期性边界条件相容的波矢量。对于一个将用于估计功率谱的网格，假设输入场是实值的，因此其傅里叶变换表现出厄米对称性。球对称平均功率谱的分箱使用波矢量空间中的球壳。\n\n从将连续场采样到离散格点上的第一性原理以及周期性域中离散傅里叶表示的定义出发，确定网格一维轴上的最高可分辨波数（奈奎斯特频率）$k_{\\mathrm{Ny}}$。然后，为了从实值场估计功率谱，采用只计算独立傅里叶模式的标准约定，即使用字典序规则选择三维波矢量格点的一半：包含满足 $m_{z} > 0$ 的模式，或者 $m_{z} = 0$ 且 $m_{y} > 0$ 的模式，或者 $m_{z} = m_{y} = 0$ 且 $m_{x} \\geq 0$ 的模式，其中 $\\boldsymbol{m} = (m_{x}, m_{y}, m_{z})$ 是离散波矢量的整数索引。\n\n使用具体参数 $N = 16$ 和 $L = 2\\pi$，此时基频为 $k_{f} = 2\\pi/L$。考虑一个波矢量大小的球壳，其中心位于 $k = \\sqrt{5}\\,k_{f}$，宽度为 $\\Delta k = 0.1\\,k_{f}$，并枚举所有波矢量大小落在此球壳内的整数索引三元组 $\\boldsymbol{m}$ 的集合。使用上述独立模式计数约定，返回此球壳内的独立模式总数 $N_{\\mathrm{modes}}$。\n\n将 $k_{\\mathrm{Ny}}$ 以基频 $k_{f}$ 为单位表示，并将 $N_{\\mathrm{modes}}$ 作为无量纲整数提供。最终答案必须以包含 $k_{\\mathrm{Ny}}/k_{f}$ 和 $N_{\\mathrm{modes}}$ 的两元行矩阵形式呈现。",
            "solution": "该问题经验证具有科学依据、适定且客观。这是数值宇宙学中一个关于分析网格上离散傅里叶模式的标准练习。所有必要信息均已提供。\n\n问题要求计算两个量：以基频 $k_f$ 为单位的奈奎斯特频率 $k_{\\mathrm{Ny}}$，以及在波矢量空间中指定球壳内的独立傅里叶模式数量 $N_{\\mathrm{modes}}$。\n\n首先，我们确定奈奎斯特频率。在边长为 $L$ 的立方体盒子中，大小为 $N^3$ 的离散均匀网格的网格间距为 $\\Delta x = L/N$。根据奈奎斯特-香农采样定理，该网格上可以表示的最短波长是网格间距的两倍，即 $\\lambda_{\\mathrm{min}} = 2\\Delta x$。奈奎斯特频率是对应于此最小波长的波数：\n$$k_{\\mathrm{Ny}} = \\frac{2\\pi}{\\lambda_{\\mathrm{min}}} = \\frac{2\\pi}{2\\Delta x} = \\frac{\\pi}{\\Delta x}$$\n代入 $\\Delta x = L/N$，我们得到：\n$$k_{\\mathrm{Ny}} = \\frac{\\pi N}{L}$$\n对于边长为 $L$ 的周期性盒子，其基频（波数）$k_f$ 由最大可能波长（即 $L$）决定。因此：\n$$k_f = \\frac{2\\pi}{L}$$\n奈奎斯特频率与基频的比率为：\n$$\\frac{k_{\\mathrm{Ny}}}{k_f} = \\frac{\\pi N / L}{2\\pi / L} = \\frac{N}{2}$$\n给定网格尺寸参数 $N=16$，该比率为：\n$$\\frac{k_{\\mathrm{Ny}}}{k_f} = \\frac{16}{2} = 8$$\n\n接下来，我们计算指定球壳内的独立模式数量 $N_{\\mathrm{modes}}$。在周期性立方体盒子中，允许的波矢量 $\\boldsymbol{k}$ 由下式给出：\n$$\\boldsymbol{k} = \\frac{2\\pi}{L} \\boldsymbol{m} = k_f \\boldsymbol{m}$$\n其中 $\\boldsymbol{m} = (m_x, m_y, m_z)$ 是一个整数索引向量。对于具体参数 $L = 2\\pi$，基频为：\n$$k_f = \\frac{2\\pi}{2\\pi} = 1$$\n这将波矢量简化为 $\\boldsymbol{k} = \\boldsymbol{m}$。因此，波矢量的大小为 $|\\boldsymbol{k}| = \\sqrt{m_x^2 + m_y^2 + m_z^2}$。每个维度的整数索引 $m_i$ 受网格分辨率的限制。对于离散网格，波数通常被认为在 $[-k_{\\mathrm{Ny}}, k_{\\mathrm{Ny}}]$ 范围内。用整数索引表示，这对应于 $|m_i k_f| \\le k_{\\mathrm{Ny}}$，即 $|m_i| \\le k_{\\mathrm{Ny}}/k_f = N/2$。对于 $N=16$，索引必须满足 $|m_i| \\le 8$。\n\n问题指定了一个球壳，中心位于 $k = \\sqrt{5}\\,k_f$，宽度为 $\\Delta k = 0.1\\,k_f$。当 $k_f=1$ 时，该球壳中心位于 $k=\\sqrt{5}$，宽度为 $\\Delta k = 0.1$。此球壳内的波数满足不等式：\n$$\\sqrt{5} - \\frac{0.1}{2} \\le |\\boldsymbol{k}| \\le \\sqrt{5} + \\frac{0.1}{2}$$\n$$ \\sqrt{5} - 0.05 \\le \\sqrt{m_x^2 + m_y^2 + m_z^2} \\le \\sqrt{5} + 0.05 $$\n将各项平方以便处理平方和，得到：\n$$ (\\sqrt{5} - 0.05)^2 \\le m_x^2 + m_y^2 + m_z^2 \\le (\\sqrt{5} + 0.05)^2 $$\n对边界进行数值计算：\n$$ (2.2360679... - 0.05)^2 \\le m_x^2 + m_y^2 + m_z^2 \\le (2.2360679... + 0.05)^2 $$\n$$ (2.1860679...)^2 \\le m_x^2 + m_y^2 + m_z^2 \\le (2.2860679...)^2 $$\n$$ 4.77887... \\le m_x^2 + m_y^2 + m_z^2 \\le 5.22607... $$\n由于 $m_x$、$m_y$ 和 $m_z$ 是整数，它们的平方和也必须是整数。区间 $[4.77887..., 5.22607...]$ 内唯一的整数是 $5$。因此，我们必须找到所有满足以下条件的整数三元组 $(m_x, m_y, m_z)$：\n$$ m_x^2 + m_y^2 + m_z^2 = 5 $$\n将 $5$ 写成三个整数平方和的唯一方式是 $5 = 2^2 + 1^2 + 0^2$。因此，分量 $(|m_x|, |m_y|, |m_z|)$ 的绝对值必须是 $(2, 1, 0)$ 的一个排列。所有索引都满足 $|m_i| \\le 2$，这完全在要求的范围 $|m_i| \\le 8$ 之内。\n\n现在我们列出所有可能的整数三元组 $\\boldsymbol{m}$，并应用给定的字典序规则来计算独立模式。该规则是，如果一个模式 $\\boldsymbol{m}$ 满足以下条件之一，则将其包含在内：\n1. $m_z > 0$，或\n2. $m_z = 0$ 且 $m_y > 0$，或\n3. $m_z = 0$, $m_y = 0$, 且 $m_x \\geq 0$。\n\n让我们来计算满足这些条件的模式。\n\n条件 1：$m_z > 0$。\n三元组必须满足 $m_z^2+m_y^2+m_x^2=5$。\n如果 $m_z = 1$，则 $m_x^2 + m_y^2 = 4$。解是 $(\\pm 2, 0)$ 的排列。\n这些模式是 $(2, 0, 1)$、$(-2, 0, 1)$、$(0, 2, 1)$、$(0, -2, 1)$。这给出了 $4$ 个模式。\n如果 $m_z = 2$，则 $m_x^2 + m_y^2 = 1$。解是 $(\\pm 1, 0)$ 的排列。\n这些模式是 $(1, 0, 2)$、$(-1, 0, 2)$、$(0, 1, 2)$、$(0, -1, 2)$。这给出了 $4$ 个模式。\n来自条件 1 的总模式数：$4 + 4 = 8$。\n\n条件 2：$m_z = 0$ 且 $m_y > 0$。\n如果 $m_z = 0$，则 $m_x^2 + m_y^2 = 5$。$(|m_x|,|m_y|)$ 的整数解是 $(2, 1)$ 的排列。\n我们需要 $m_y > 0$，所以 $m_y$ 可以是 $1$ 或 $2$。\n如果 $m_y = 1$，则 $m_x^2 = 4$，所以 $m_x = \\pm 2$。这给出模式 $(2, 1, 0)$ 和 $(-2, 1, 0)$。\n如果 $m_y = 2$，则 $m_x^2 = 1$，所以 $m_x = \\pm 1$。这给出模式 $(1, 2, 0)$ 和 $(-1, 2, 0)$。\n来自条件 2 的总模式数：$2 + 2 = 4$。\n\n条件 3：$m_z = 0$，$m_y = 0$，且 $m_x \\geq 0$。\n如果 $m_z=0$ 且 $m_y=0$，则 $m_x^2=5$。这个方程没有整数解 $m_x$。\n来自条件 3 的总模式数：$0$。\n\n独立模式的总数 $N_{\\mathrm{modes}}$ 是这三个互斥条件的计数之和：\n$$ N_{\\mathrm{modes}} = 8 + 4 + 0 = 12 $$\n\n最终答案包含 $k_{\\mathrm{Ny}}/k_f$ 和 $N_{\\mathrm{modes}}$。\n$k_{\\mathrm{Ny}}/k_f = 8$。\n$N_{\\mathrm{modes}} = 12$。\n结果将以一个两元行矩阵的形式呈现。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n8  12\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "宇宙学分析很少直接处理连续场，而是使用像星系或暗物质晕这样的离散示踪物。这种离散性引入了一种必须被精确扣除的噪声项，即“散粒噪声”（shot noise）。本练习将带你推导并实现对功率谱和双谱的散粒噪声修正，特别是针对在实际分析中常见的加权样本目录 。这个实践揭示了一个核心概念：测量到的功率谱是真实宇宙学信号和散粒噪声项的总和，并且展示了该噪声项如何依赖于权重分布的矩，这是任何使用离散示踪物分析都必须考虑的关键因素。",
            "id": "3481941",
            "problem": "考虑一个离散的加权对象集合，其位置为 $\\{\\mathbf{x}_i\\}_{i=1}^{N}$，并具有严格非负的标量权重 $\\{w_i\\}_{i=1}^{N}$。定义加权数密度场为 $n_w(\\mathbf{x})=\\sum_{i=1}^{N} w_i \\,\\delta_{\\mathrm{D}}(\\mathbf{x}-\\mathbf{x}_i)$，其中 $\\delta_{\\mathrm{D}}$ 表示狄拉克δ函数。令 $S_1=\\sum_{i=1}^{N} w_i$ 为总权重，并考虑归一化加权场 $f(\\mathbf{x})=n_w(\\mathbf{x})/S_1$。对于波矢 $\\mathbf{k}$，定义傅里叶变换 $f(\\mathbf{k})=\\int d^3\\mathbf{x}\\, f(\\mathbf{x}) e^{-i\\mathbf{k}\\cdot\\mathbf{x}}$ 以及在非零波矢处的功率谱和双谱的相应估计量：$P(\\mathbf{k})=\\langle f(\\mathbf{k}) f(-\\mathbf{k}) \\rangle$ 和 $B(\\mathbf{k}_1,\\mathbf{k}_2,\\mathbf{k}_3)=\\langle f(\\mathbf{k}_1) f(\\mathbf{k}_2) f(\\mathbf{k}_3) \\rangle$，并满足闭合条件 $\\mathbf{k}_1+\\mathbf{k}_2+\\mathbf{k}_3=\\mathbf{0}$。\n\n从 $f(\\mathbf{k})$ 的定义出发，并假设离散场的采样是一个具有任意但固定的非负权重 $\\{w_i\\}$ 的统计均匀泊松点过程，请从第一性原理推导功率谱和双谱估计量的等效散粒噪声贡献。您的推导必须识别出导致散粒噪声的指标收缩项，并用和式 $S_r=\\sum_{i=1}^{N} w_i^r$（其中 $r=1,2,3$）以及潜在的聚类贡献来表示散粒噪声。然后，实现一个程序，该程序在给定一个权重列表和一个闭合波矢三角形的潜在功率谱值三元组 $(P(k_1),P(k_2),P(k_3))$ 的情况下，计算：\n- 功率谱的等效散粒噪声，记为 $P_{\\mathrm{shot}}$，以及\n- 双谱的散粒噪声，分解为双指标收缩项（记为 $B_{\\mathrm{shot},2}$）和三指标收缩项（记为 $B_{\\mathrm{shot},3}$），以及它们的和 $B_{\\mathrm{shot}}=B_{\\mathrm{shot},2}+B_{\\mathrm{shot},3}$。\n\n所有量都应视为无量纲标量；不需要物理单位或角度。\n\n您的程序必须评估以下参数集测试套件，每个参数集由一个包含权重列表和功率谱值三元组 $(P(k_1),P(k_2),P(k_3))$ 的元组指定：\n1. 权重 $[1.0,0.5,2.0,1.5]$，功率谱值 $(10.0,12.0,8.0)$。\n2. 权重 $[3.0]$，功率谱值 $(5.0,5.0,5.0)$。\n3. 权重由一百个等于 $1.0$ 的条目组成，功率谱值 $(0.2,0.3,0.4)$。\n4. 权重 $[0.0,0.0,1.0,4.0,0.0,2.0]$，功率谱值 $(1.0,2.0,3.0)$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，每个测试用例的结果本身也是一个用方括号括起来的逗号分隔列表，顺序为 $[P_{\\mathrm{shot}},B_{\\mathrm{shot},2},B_{\\mathrm{shot},3},B_{\\mathrm{shot}}]$。例如，输出格式必须为 $[[a_1,b_1,c_1,d_1],[a_2,b_2,c_2,d_2],\\ldots]$，不含空格。",
            "solution": "用户要求推导加权 Poisson 点过程的功率谱和双谱的散粒噪声贡献，并随后进行计算实现。\n\n### 问题验证\n\n**第一步：提取已知条件**\n- 位于位置 $\\{\\mathbf{x}_i\\}_{i=1}^{N}$ 的 $N$ 个离散加权对象集合。\n- 严格非负的标量权重 $\\{w_i\\}_{i=1}^{N}$。\n- 加权数密度场：$n_w(\\mathbf{x})=\\sum_{i=1}^{N} w_i \\,\\delta_{\\mathrm{D}}(\\mathbf{x}-\\mathbf{x}_i)$。\n- 总权重：$S_1=\\sum_{i=1}^{N} w_i$。\n- 归一化加权场：$f(\\mathbf{x})=n_w(\\mathbf{x})/S_1$。\n- 傅里叶变换：$f(\\mathbf{k})=\\int d^3\\mathbf{x}\\, f(\\mathbf{x}) e^{-i\\mathbf{k}\\cdot\\mathbf{x}}$。\n- 功率谱估计量：$P(\\mathbf{k})=\\langle f(\\mathbf{k}) f(-\\mathbf{k}) \\rangle$，其中 $\\mathbf{k} \\neq \\mathbf{0}$。\n- 双谱估计量：$B(\\mathbf{k}_1,\\mathbf{k}_2,\\mathbf{k}_3)=\\langle f(\\mathbf{k}_1) f(\\mathbf{k}_2) f(\\mathbf{k}_3) \\rangle$，对于满足闭合条件 $\\mathbf{k}_1+\\mathbf{k}_2+\\mathbf{k}_3=\\mathbf{0}$ 的非零波矢。\n- 假设：位置 $\\{\\mathbf{x}_i\\}$ 的采样是统计均匀的 Poisson 点过程。\n- 任务：从第一性原理推导功率谱和双谱的等效散粒噪声贡献，并用 $S_r=\\sum_{i=1}^{N} w_i^r$（其中 $r=1,2,3$）以及潜在的聚类功率谱 $P(k)$ 来表示它们。\n\n**第二步：使用提取的已知条件进行验证**\n该问题是理论宇宙学和大尺度结构统计学中一个标准的、定义明确的练习。\n- **科学依据：** 该问题基于应用于宇宙学密度场的统计场论基本原理。功率谱、双谱和散粒噪声等概念是该领域的核心。\n- **良态问题：** 该问题提供了推导唯一解所需的所有必要定义和假设。待计算的量都有明确定义。\n- **客观性：** 该问题以精确的数学和物理语言陈述，没有歧义或主观性陈述。\n\n**第三步：结论与行动**\n问题有效。将提供完整解答。\n\n### 第一性原理推导\n\n推导从归一化加权场 $f(\\mathbf{x})$ 的傅里叶变换开始。将 $f(\\mathbf{x})$ 的定义代入傅里叶积分，得到：\n$$\nf(\\mathbf{k}) = \\int d^3\\mathbf{x} \\frac{1}{S_1} \\left(\\sum_{i=1}^{N} w_i \\delta_{\\mathrm{D}}(\\mathbf{x}-\\mathbf{x}_i)\\right) e^{-i\\mathbf{k}\\cdot\\mathbf{x}} = \\frac{1}{S_1} \\sum_{i=1}^{N} w_i e^{-i\\mathbf{k}\\cdot\\mathbf{x}_i}\n$$\n此表达式是加权点集的离散傅里叶变换，它构成了估计量的基础。期望值 $\\langle \\cdot \\rangle$ 表示对 Poisson 点过程的许多实现的系综平均。Poisson 过程的关键特性是对象的位置是不相关的。\n\n**功率谱散粒噪声**\n功率谱估计量定义为 $P(\\mathbf{k}) = \\langle f(\\mathbf{k}) f(-\\mathbf{k}) \\rangle$。代入 $f(\\mathbf{k})$ 的表达式：\n$$\nP(\\mathbf{k}) = \\left\\langle \\left( \\frac{1}{S_1} \\sum_{i=1}^{N} w_i e^{-i\\mathbf{k}\\cdot\\mathbf{x}_i} \\right) \\left( \\frac{1}{S_1} \\sum_{j=1}^{N} w_j e^{i\\mathbf{k}\\cdot\\mathbf{x}_j} \\right) \\right\\rangle = \\frac{1}{S_1^2} \\left\\langle \\sum_{i,j=1}^{N} w_i w_j e^{-i\\mathbf{k}\\cdot(\\mathbf{x}_i - \\mathbf{x}_j)} \\right\\rangle\n$$\n对指标 $i$ 和 $j$ 的求和可以分为两种情况：$i=j$ 的项和 $i \\neq j$ 的项。\n$$\nP(\\mathbf{k}) = \\frac{1}{S_1^2} \\left\\langle \\sum_{i=j} w_i w_j e^{-i\\mathbf{k}\\cdot(\\mathbf{x}_i - \\mathbf{x}_j)} + \\sum_{i \\neq j} w_i w_j e^{-i\\mathbf{k}\\cdot(\\mathbf{x}_i - \\mathbf{x}_j)} \\right\\rangle\n$$\n第一项，由指标收缩 $i=j$ 产生，是“自计数”项或散粒噪声项。由于当 $i=j$ 时 $\\mathbf{x}_i - \\mathbf{x}_j = \\mathbf{0}$，指数项变为 $e^0 = 1$。此项与对象的位置无关，因此系综平均对其没有影响。\n$$\n\\text{对于 } i=j \\text{ 的项} : \\quad \\frac{1}{S_1^2} \\sum_{i=1}^{N} w_i^2 = \\frac{S_2}{S_1^2}\n$$\n这是对功率谱的等效散粒噪声贡献 $P_{\\mathrm{shot}}$。它是一个与波矢 $\\mathbf{k}$ 无关的恒定偏移量。\n\n第二项，对于 $i \\neq j$，代表不同对象之间的相关性。此项的系综平均产生潜在的聚类功率谱 $P_{\\text{true}}(k)$，对于统计各向同性的宇宙，它取决于模长 $k=|\\mathbf{k}|$。\n$$\n\\text{对于 } i \\neq j \\text{ 的项} : \\quad \\frac{1}{S_1^2} \\left\\langle \\sum_{i \\neq j} w_i w_j e^{-i\\mathbf{k}\\cdot(\\mathbf{x}_i - \\mathbf{x}_j)} \\right\\rangle = P_{\\text{true}}(k)\n$$\n因此，测得的总功率谱是真实信号与散粒噪声之和：$P(k) = P_{\\text{true}}(k) + P_{\\mathrm{shot}}$。问题要求的是散粒噪声贡献本身。\n$$\nP_{\\mathrm{shot}} = \\frac{S_2}{S_1^2}\n$$\n其中 $S_r = \\sum_{i=1}^{N} w_i^r$。\n\n**双谱散粒噪声**\n对于闭合的波矢三角形 $\\mathbf{k}_1+\\mathbf{k}_2+\\mathbf{k}_3=\\mathbf{0}$，双谱估计量为 $B(\\mathbf{k}_1,\\mathbf{k}_2,\\mathbf{k}_3)=\\langle f(\\mathbf{k}_1) f(\\mathbf{k}_2) f(\\mathbf{k}_3) \\rangle$。我们代入 $f(\\mathbf{k})$ 的表达式：\n$$\nB(\\mathbf{k}_1,\\mathbf{k}_2,\\mathbf{k}_3) = \\frac{1}{S_1^3} \\left\\langle \\sum_{i,j,l=1}^{N} w_i w_j w_l e^{-i(\\mathbf{k}_1\\cdot\\mathbf{x}_i + \\mathbf{k}_2\\cdot\\mathbf{x}_j + \\mathbf{k}_3\\cdot\\mathbf{x}_l)} \\right\\rangle\n$$\n三重求和根据指标收缩进行分解。\n$1.$ **所有指标都不同 ($i \\neq j, j \\neq l, i \\neq l$)：** 此项对应于潜在密度场的内禀三点相关性，即真实双谱 $B_{\\text{true}}(\\mathbf{k}_1,\\mathbf{k}_2,\\mathbf{k}_3)$。\n\n$2.$ **三个指标相等 ($i = j = l$)：** 这代表三指标收缩项。\n$$\n\\text{对于 } i=j=l \\text{ 的项} : \\quad \\frac{1}{S_1^3} \\left\\langle \\sum_{i=1}^{N} w_i^3 e^{-i(\\mathbf{k}_1+\\mathbf{k}_2+\\mathbf{k}_3)\\cdot\\mathbf{x}_i} \\right\\rangle\n$$\n由于闭合条件 $\\mathbf{k}_1+\\mathbf{k}_2+\\mathbf{k}_3=\\mathbf{0}$，指数项变为 $e^0=1$。此项为常数，其系综平均是平凡的。\n$$\nB_{\\mathrm{shot},3} = \\frac{1}{S_1^3} \\sum_{i=1}^{N} w_i^3 = \\frac{S_3}{S_1^3}\n$$\n\n$3.$ **两个指标相等 ($i=j \\neq l$，及其置换)：** 这是双指标收缩项。让我们考虑 $i=j \\neq l$ 的情况：\n$$\n\\text{对于 } i=j \\neq l \\text{ 的项} : \\quad \\frac{1}{S_1^3} \\left\\langle \\sum_{i \\neq l} w_i^2 w_l e^{-i(\\mathbf{k}_1+\\mathbf{k}_2)\\cdot\\mathbf{x}_i - i\\mathbf{k}_3\\cdot\\mathbf{x}_l} \\right\\rangle\n$$\n使用闭合条件 $\\mathbf{k}_1+\\mathbf{k}_2 = -\\mathbf{k}_3$，上式变为：\n$$\n\\frac{1}{S_1^3} \\left\\langle \\sum_{i \\neq l} w_i^2 w_l e^{i\\mathbf{k}_3\\cdot(\\mathbf{x}_i - \\mathbf{x}_l)} \\right\\rangle\n$$\n该表达式与一个由 $w^2$ 加权的场和一个由 $w$ 加权的场之间的交叉功率谱有关。假设权重与位置无关（这是问题设定的一个推论），则该交叉谱与密度场的潜在自功率谱 $P_{\\text{true}}(k_3)$ 成正比。通过匹配项可以推导出前置因子，得到 $\\frac{S_2 S_1}{S_1^3} P_{\\text{true}}(k_3) = \\frac{S_2}{S_1^2} P_{\\text{true}}(k_3)$。问题提供了潜在的功率谱值，记为 $P(k)$。因此，这部分散粒噪声是 $\\frac{S_2}{S_1^2} P(k_3) = P_{\\mathrm{shot}} P(k_3)$。\n完整的双指标收缩项 $B_{\\mathrm{shot},2}$ 是三个置换（$i=j \\neq l$, $i=l \\neq j$, $j=l \\neq i$）之和，得到：\n$$\nB_{\\mathrm{shot},2} = \\frac{S_2}{S_1^2}P(k_1) + \\frac{S_2}{S_1^2}P(k_2) + \\frac{S_2}{S_1^2}P(k_3) = \\frac{S_2}{S_1^2} \\left[ P(k_1) + P(k_2) + P(k_3) \\right]\n$$\n\n**公式总结**\n需要计算的散粒噪声分量是：\n- 功率谱散粒噪声：$P_{\\mathrm{shot}} = \\frac{S_2}{S_1^2}$\n- 双谱双指标散粒噪声：$B_{\\mathrm{shot},2} = P_{\\mathrm{shot}} \\left( P(k_1) + P(k_2) + P(k_3) \\right)$\n- 双谱三指标散粒噪声：$B_{\\mathrm{shot},3} = \\frac{S_3}{S_1^3}$\n- 总双谱散粒噪声：$B_{\\mathrm{shot}} = B_{\\mathrm{shot},2} + B_{\\mathrm{shot},3}$\n\n其中 $S_r = \\sum_{i=1}^{N} w_i^r$，$r \\in \\{1, 2, 3\\}$。现在实现这些公式。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem of calculating shot noise contributions for the power spectrum\n    and bispectrum for given sets of weights and underlying power spectrum values.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: General weights\n        ([1.0, 0.5, 2.0, 1.5], (10.0, 12.0, 8.0)),\n        # Case 2: Single object\n        ([3.0], (5.0, 5.0, 5.0)),\n        # Case 3: Uniform weights\n        ([1.0] * 100, (0.2, 0.3, 0.4)),\n        # Case 4: Weights including zeros\n        ([0.0, 0.0, 1.0, 4.0, 0.0, 2.0], (1.0, 2.0, 3.0)),\n    ]\n\n    all_results = []\n    for weights, powers in test_cases:\n        # Use numpy for efficient array operations.\n        # Ensure weights are float64 for precision.\n        w = np.array(weights, dtype=np.float64)\n\n        # Calculate the sums S_r = sum(w_i^r) for r=1, 2, 3.\n        S1 = np.sum(w)\n        \n        # Handle the edge case where all weights are zero.\n        # In this scenario, the field is identically zero, so all estimators\n        # and their shot noise contributions are zero.\n        if S1 == 0.0:\n            P_shot = 0.0\n            B_shot_2 = 0.0\n            B_shot_3 = 0.0\n            B_shot = 0.0\n        else:\n            S2 = np.sum(w**2)\n            S3 = np.sum(w**3)\n            \n            # Calculate the power spectrum shot noise term.\n            # P_shot = S2 / S1^2\n            P_shot = S2 / (S1**2)\n            \n            # Calculate the two-index contraction term for the bispectrum shot noise.\n            # B_shot,2 = P_shot * (P(k1) + P(k2) + P(k3))\n            P_sum = sum(powers)\n            B_shot_2 = P_shot * P_sum\n            \n            # Calculate the three-index contraction term for the bispectrum shot noise.\n            # B_shot,3 = S3 / S1^3\n            B_shot_3 = S3 / (S1**3)\n            \n            # Calculate the total bispectrum shot noise.\n            B_shot = B_shot_2 + B_shot_3\n        \n        # Store the results for the current test case.\n        all_results.append([P_shot, B_shot_2, B_shot_3, B_shot])\n\n    # Format the output string precisely as required, with no spaces.\n    # The output is a string representation of a list of lists.\n    output_parts = []\n    for res in all_results:\n        # Each inner list is formatted as \"[a,b,c,d]\"\n        output_parts.append(f\"[{','.join(map(str, res))}]\")\n    \n    # The final output is a concatenation of the inner lists,\n    # separated by commas, and enclosed in brackets.\n    final_output = f\"[{','.join(output_parts)}]\"\n    \n    print(final_output)\n\nsolve()\n```"
        },
        {
            "introduction": "对星系成团性的观测是在“红移空间”中进行的，其中本动速度会扭曲成团模式，使其呈现各向异性。本练习将介绍分析这种各向异性的标准技术：多极矩展开。你将使用凯撒模型（Kaiser model）和高斯-勒让德积分法（Gauss-Legendre quadrature）来实现一个功率谱多极矩的数值估计器 。这个实践展示了如何通过将各向异性信号投影到正交基（勒让德多项式）上，从而从中提取宇宙学信息，并演示了利用数值积分精确高效地完成这些投影的强大功能，这正是真实数据分析流程中广泛应用的技术。",
            "id": "3481959",
            "problem": "考虑红移空间中一个统计均匀的离散场，其视线单位向量为 $\\hat{\\boldsymbol{n}}$，傅里叶模式 $\\boldsymbol{k}$ 从一个立方周期性体积中采样。该场的离散傅里叶振幅记为 $\\delta_s(\\boldsymbol{k})$。红移空间功率谱是各向异性的；它取决于模的大小 $k=\\lVert \\boldsymbol{k}\\rVert$ 以及夹角余弦 $\\mu=\\hat{\\boldsymbol{k}}\\cdot\\hat{\\boldsymbol{n}}$。多极展开旨在寻找系数 $P_\\ell(k)$，使得功率谱的角度依赖性可以在区间 $\\mu\\in[-1,1]$ 上通过勒让德多项式 $L_\\ell(\\mu)$ 的级数来表示。\n\n从经过充分检验的线性红移空间畸变的物理模型出发，假设各向异性红移空间功率谱的理论形式由 Kaiser 模型给出：$P_s(k,\\mu)=(b+f\\,\\mu^2)^2\\,P_m(k)$，其中 $b$ 是线性偏置参数，$f$ 是线性增长率，$P_m(k)$ 是一个各向同性的物质功率谱模型。使用各向同性物质功率谱形状 $P_m(k)=A\\,k^{n_s}\\exp\\left(-(k/k_c)^2\\right)$，其中振幅为 $A$，谱指数为 $n_s$，特征截断为 $k_c$。\n\n您的任务是为多极系数 $P_\\ell(k)$（其中 $\\ell\\in\\{0,2,4\\}$）构建一个与 $\\mu$ 的离散采样一致的数值估计量。该估计量必须：\n- 利用勒让德多项式在 $\\mu\\in[-1,1]$ 上的正交性，将各向异性功率 $P_s(k,\\mu)$ 投影到多极基上。\n- 用一个适合于在勒让德多项式中展开的函数的离散求积法则替代对 $\\mu$ 的连续积分。您必须明确使用与在 $[-1,1]$ 上的多项式基相适应的积分方案所对应的节点和权重。\n- 将 $k$ 视为每个测试案例的固定值（即，$k$ 的分箱在每个案例中退化为单个 $k$ 值），并仅对 $\\mu$ 进行角向投影。解释在一般的离散设置中，如何进行 $\\mu$ 的分箱，并证明此处选择的求积法是对 $\\mu$ 的一种适应性方法。\n\n使用以下参数值测试套件。对于每个测试案例，计算三个多极矩 $P_0(k)$、$P_2(k)$ 和 $P_4(k)$ 作为浮点数：\n\n- 测试案例 1（一般各向异性，“理想路径”）：\n  - $A=1.5$, $n_s=1.0$, $k_c=0.7$, $b=2.0$, $f=0.8$, $k=0.1$。\n- 测试案例 2（红移空间中的各向同性极限）：\n  - $A=0.9$, $n_s=0.5$, $k_c=0.5$, $b=1.5$, $f=0.0$, $k=0.2$。\n- 测试案例 3（$k$ 空间中的边界）：\n  - $A=1.0$, $n_s=1.5$, $k_c=0.8$, $b=1.0$, $f=1.0$, $k=0.0$。\n- 测试案例 4（强各向异性）：\n  - $A=2.0$, $n_s=1.2$, $k_c=0.6$, $b=1.0$, $f=2.0$, $k=0.3$。\n\n在本练习中，所有量都是无量纲的。角度通过 $\\mu$ 隐式表示，无需单独指定。\n\n您的程序必须：\n- 在每个测试案例中，针对给定的 $k$，实现一个适应勒让德多项式的在 $\\mu\\in[-1,1]$ 上的求积方法，以近似 $P_s(k,\\mu)$ 的多极投影。使用足够数量的求积节点以精确地对多项式角度依赖性进行积分。\n- 对于每个测试案例，输出三个多极矩值 $[P_0,P_2,P_4]$ 作为浮点数。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表。每个测试案例的结果应按顺序作为一个包含三个元素的列表。例如，输出应如下所示：\n\"[[P0_1,P2_1,P4_1],[P0_2,P2_2,P4_2],[P0_3,P2_3,P4_3],[P0_4,P2_4,P4_4]]\"",
            "solution": "该问题要求构建一个数值估计量，用于计算由 Kaiser 模型描述的各向异性红移空间功率谱的多极系数。此任务涉及将模型功率谱投影到勒让德多项式基上。\n\n首先，我们建立理论基础。功率谱 $P_s(k,\\mu)$ 是傅里叶模式模长 $k = \\lVert\\boldsymbol{k}\\rVert$ 和模式向量与视线夹角余弦 $\\mu = \\hat{\\boldsymbol{k}}\\cdot\\hat{\\boldsymbol{n}}$ 的函数。其多极展开式为：\n$$\nP_s(k,\\mu) = \\sum_{\\ell=0}^{\\infty} P_\\ell(k) L_\\ell(\\mu)\n$$\n其中 $L_\\ell(\\mu)$ 是勒让德多项式，$P_\\ell(k)$ 是我们寻求估计的多极系数。\n\n勒让德多项式在区间 $\\mu \\in [-1, 1]$ 上构成一个正交基，其正交关系为：\n$$\n\\int_{-1}^{1} L_\\ell(\\mu) L_{\\ell'}(\\mu) d\\mu = \\frac{2}{2\\ell+1} \\delta_{\\ell\\ell'}\n$$\n其中 $\\delta_{\\ell\\ell'}$ 是克罗内克 δ 符号 (Kronecker delta)。该性质允许我们通过将展开式乘以 $L_\\ell(\\mu)$ 并对 $\\mu$ 进行积分来分离出特定的系数 $P_\\ell(k)$：\n$$\n\\int_{-1}^{1} P_s(k,\\mu) L_\\ell(\\mu) d\\mu = \\int_{-1}^{1} \\left(\\sum_{\\ell'=0}^{\\infty} P_{\\ell'}(k) L_{\\ell'}(\\mu)\\right) L_\\ell(\\mu) d\\mu = P_\\ell(k) \\frac{2}{2\\ell+1}\n$$\n整理后得到 $P_\\ell(k)$ 的精确投影公式：\n$$\nP_\\ell(k) = \\frac{2\\ell+1}{2} \\int_{-1}^{1} P_s(k,\\mu) L_\\ell(\\mu) d\\mu\n$$\n问题提供了 $P_s(k,\\mu)$ 的理论模型，即 Kaiser 模型，我们将其代入此公式：\n$$\nP_s(k,\\mu) = (b+f\\,\\mu^2)^2 P_m(k)\n$$\n其中 $b$ 是线性偏置，$f$ 是线性增长率，$P_m(k) = A\\,k^{n_s}\\exp\\left(-(k/k_c)^2\\right)$ 是各向同性物质功率谱。由于 $P_m(k)$、$b$ 和 $f$ 不依赖于 $\\mu$，我们可以酌情将它们从积分中提出：\n$$\nP_\\ell(k) = P_m(k) \\left[ \\frac{2\\ell+1}{2} \\int_{-1}^{1} (b+f\\,\\mu^2)^2 L_\\ell(\\mu) d\\mu \\right]\n$$\n这就是我们必须计算的积分。问题指定我们必须使用数值估计量。在典型的涉及来自模拟或巡天离散数据的应用中，我们无法获得连续函数 $P_s(k,\\mu)$。取而代之的是一组离散的傅里叶模式。功率谱通过在 $k$ 的球壳和 $\\mu$ 的角楔中对这些模式进行分箱，然后对每个箱内的功率 $|\\delta_s(\\boldsymbol{k})|^2$ 进行平均，从而得到估计值 $\\hat{P}(k_i, \\mu_j)$。此时，积分将通过对这些 $\\mu$ 箱的离散求和来近似，例如黎曼和：$P_\\ell(k_i) \\approx \\frac{2\\ell+1}{2} \\sum_j \\hat{P}(k_i, \\mu_j) L_\\ell(\\mu_j) \\Delta\\mu_j$。\n\n然而，在本问题中，我们被给予了 $P_s(k,\\mu)$ 的解析形式。因此，我们可以使用比简单分箱更复杂且更精确的数值积分技术。问题要求使用“适用于在 $[-1,1]$ 上的多项式基的”求积法则，这直接指向了高斯-勒让德求积 (Gauss-Legendre quadrature)。该方法将函数 $g(\\mu)$ 的积分近似为一个加权和：\n$$\n\\int_{-1}^{1} g(\\mu) d\\mu \\approx \\sum_{i=1}^{N} w_i g(\\mu_i)\n$$\n其中 $\\mu_i$ 是勒让德多项式 $L_N(\\mu)$ 的 $N$ 个根（节点），$w_i$ 是对应的权重。一个 $N$ 点高斯-勒让德求积对于最高为 $2N-1$ 次的多项式是精确的。\n\n为了选择合适的节点数 $N$，我们必须确定被积多项式的次数。被积函数为 $(b+f\\mu^2)^2 L_\\ell(\\mu)$。项 $(b+f\\mu^2)^2 = b^2 + 2bf\\mu^2 + f^2\\mu^4$ 是一个关于 $\\mu$ 的 $4$ 次多项式。对于 $\\ell=0,2,4$，勒让德多项式分别为 $L_0(\\mu)=1$（$0$ 次）、$L_2(\\mu) = \\frac{1}{2}(3\\mu^2-1)$（$2$ 次）和 $L_4(\\mu) = \\frac{1}{8}(35\\mu^4-30\\mu^2+3)$（$4$ 次）。被积函数的最高次数出现在 $\\ell=4$ 时，即（关于 $\\mu$ 的 $4$ 次多项式）$\\times$（关于 $\\mu$ 的 $4$ 次多项式），结果为一个 $8$ 次多项式。\n为了精确地积分一个 $8$ 次多项式，我们需要 $2N-1 \\ge 8$，这意味着 $2N \\ge 9$，所以 $N \\ge 4.5$。最小的整数值为 $N=5$。因此，一个 $5$ 点高斯-勒让德求积将为所有需要的多极矩 $\\ell=0, 2, 4$ 产生数值上精确的结果（达到机器精度）。\n\n因此，我们的多极矩数值估计量为：\n$$\nP_\\ell(k) \\approx P_m(k) \\left[ \\frac{2\\ell+1}{2} \\sum_{i=1}^{5} w_i (b+f\\mu_i^2)^2 L_\\ell(\\mu_i) \\right]\n$$\n其中 $(\\mu_i, w_i)$ 是 $5$ 点高斯-勒让德求积的节点和权重。\n\n我们继续对每个测试案例实施此公式。\n对于测试案例 3，其中 $k=0.0$，我们必须小心。物质功率谱为 $P_m(k) = A\\,k^{n_s}\\exp\\left(-(k/k_c)^2\\right)$。当 $n_s=1.5 > 0$ 时，项 $k^{n_s}$ 在 $k=0$ 处的值为 $0$。因此，$P_m(0)=0$，这反过来意味着所有多极矩 $P_\\ell(0)$ 都将为零。\n\n对于测试案例 2，其中 $f=0.0$，功率谱变为各向同性：$P_s(k,\\mu) = b^2 P_m(k)$。积分得以简化。对于 $\\ell=0$，$P_0(k) = \\frac{1}{2} \\int_{-1}^1 b^2 P_m(k) L_0(\\mu) d\\mu = \\frac{b^2 P_m(k)}{2} \\int_{-1}^1 d\\mu = b^2 P_m(k)$。对于任何 $\\ell > 0$，由于与 $L_0(\\mu)=1$ 的正交性，积分 $\\int_{-1}^1 L_\\ell(\\mu) d\\mu$ 为零，所以 $P_2(k)=P_4(k)=0$。我们的数值估计量应能重现此结果。",
            "answer": "```python\nimport numpy as np\nimport scipy.special\n\ndef solve():\n    \"\"\"\n    Calculates the redshift-space power spectrum multipoles P_0, P_2, P_4\n    for a set of cosmological parameters using the Kaiser model and\n    Gauss-Legendre quadrature for the angular projection.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (A, n_s, k_c, b, f, k)\n        (1.5, 1.0, 0.7, 2.0, 0.8, 0.1), # Test Case 1\n        (0.9, 0.5, 0.5, 1.5, 0.0, 0.2), # Test Case 2\n        (1.0, 1.5, 0.8, 1.0, 1.0, 0.0), # Test Case 3\n        (2.0, 1.2, 0.6, 1.0, 2.0, 0.3), # Test Case 4\n    ]\n\n    all_results = []\n    \n    # The integrand's angular part is a polynomial of degree up to 8.\n    # A 5-point Gauss-Legendre quadrature is exact for polynomials of degree\n    # up to 2*5 - 1 = 9, so it is sufficient.\n    N_QUAD = 5\n    mu_nodes, weights = scipy.special.roots_legendre(N_QUAD)\n\n    # Define Legendre polynomials for l=0, 2, 4\n    def L0(mu):\n        return 1.0\n\n    def L2(mu):\n        return 0.5 * (3 * mu**2 - 1)\n\n    def L4(mu):\n        return (1.0/8.0) * (35 * mu**4 - 30 * mu**2 + 3)\n\n    legendre_funcs = {0: L0, 2: L2, 4: L4}\n\n    for case in test_cases:\n        A, n_s, k_c, b, f, k = case\n        \n        # Calculate the matter power spectrum P_m(k)\n        # Handle the special case k=0. If n_s > 0, k^n_s is 0.\n        if k == 0.0:\n            if n_s > 0:\n                p_m_k = 0.0\n            elif n_s == 0:\n                # exp(-0) = 1, k^0 = 1\n                p_m_k = A\n            else:\n                 # This case is not in the test suite, but would be a singularity.\n                p_m_k = np.inf\n        else:\n            p_m_k = A * k**n_s * np.exp(-(k / k_c)**2)\n        \n        # If P_m(k) is zero, all multipoles are zero.\n        if p_m_k == 0.0:\n            all_results.append([0.0, 0.0, 0.0])\n            continue\n\n        case_results = []\n        for l in [0, 2, 4]:\n            # Numerical integration using Gauss-Legendre quadrature\n            integral_sum = 0.0\n            for i in range(N_QUAD):\n                mu = mu_nodes[i]\n                w = weights[i]\n                \n                # Integrand is (b + f*mu^2)^2 * L_l(mu)\n                angular_part = (b + f * mu**2)**2\n                legendre_val = legendre_funcs[l](mu)\n                \n                integral_sum += w * angular_part * legendre_val\n\n            # Full multipole formula: P_l(k) = (2l+1)/2 * integral * P_m(k)\n            prefactor = (2 * l + 1) / 2.0\n            p_l_k = prefactor * p_m_k * integral_sum\n            case_results.append(p_l_k)\n            \n        all_results.append(case_results)\n\n    # Format the final output string exactly as required\n    # e.g., \"[[r1,r2,r3],[r4,r5,r6]]\"\n    output_str = \"[\" + \",\".join([f\"[{c[0]},{c[1]},{c[2]}]\" for c in all_results]) + \"]\"\n    print(output_str)\n\nsolve()\n```"
        }
    ]
}