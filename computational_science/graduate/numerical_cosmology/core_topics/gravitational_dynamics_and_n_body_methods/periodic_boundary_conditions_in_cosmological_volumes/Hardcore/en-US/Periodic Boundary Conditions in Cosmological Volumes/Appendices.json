{
    "hands_on_practices": [
        {
            "introduction": "Cosmological simulations begin with a snapshot of the early universe's density fluctuations. This practice guides you through the foundational task of generating these initial conditions by sampling a Gaussian random field consistent with a given power spectrum $P(k)$. You will implement the crucial Hermitian symmetry constraint in Fourier space to produce a valid, real-valued density field in a periodic volume, a cornerstone for any N-body or hydrodynamic simulation. ",
            "id": "3481574",
            "problem": "You are tasked with implementing a complete, runnable program that generates statistically consistent cosmological initial conditions on a discrete cubic grid with Periodic Boundary Conditions (PBC). The aim is to sample a Gaussian random field with a prescribed isotropic power spectrum and to explicitly construct Fourier-space amplitudes that satisfy the Hermitian symmetry condition required for a real-space field. Your program must verify phase statistics and the reality condition of the real-space overdensity field.\n\nStart from the following fundamental base:\n- A finite cubic volume of side length $L$ with periodic boundary conditions implies discrete wavevectors $\\mathbf{k} = \\frac{2\\pi}{L} \\mathbf{m}$ where $\\mathbf{m} = (m_x,m_y,m_z)$ and each component $m_i$ is an integer in the range $m_i \\in \\{0,1,\\dots,N-1\\}$ modulo $N$, with $N$ the number of grid points per dimension.\n- The Discrete Fourier Transform (DFT) pair consistent with the Fast Fourier Transform (FFT) convention is defined on the integer grid positions $\\mathbf{r} \\in \\{0,1,\\dots,N-1\\}^3$ as\n$$\n\\delta_{\\mathbf{r}} = \\frac{1}{N^3} \\sum_{\\mathbf{m}} a_{\\mathbf{m}} \\exp\\left(i \\frac{2\\pi}{N} \\mathbf{r}\\cdot \\mathbf{m}\\right),\n$$\n$$\na_{\\mathbf{m}} = \\sum_{\\mathbf{r}} \\delta_{\\mathbf{r}} \\exp\\left(-i \\frac{2\\pi}{N} \\mathbf{r}\\cdot \\mathbf{m}\\right),\n$$\nwhere $a_{\\mathbf{m}}$ are the discrete Fourier-space amplitudes and $\\delta_{\\mathbf{r}}$ is the real-space overdensity field sampled on the grid.\n- For a statistically homogeneous and isotropic Gaussian random field, the power spectrum $P(k)$ is defined by\n$$\n\\langle \\hat{\\delta}(\\mathbf{k}) \\hat{\\delta}^*(\\mathbf{k}') \\rangle = (2\\pi)^3 \\delta_{\\mathrm{D}}(\\mathbf{k}-\\mathbf{k}') P(k),\n$$\nwhere $\\hat{\\delta}(\\mathbf{k})$ is the continuous Fourier transform of $\\delta(\\mathbf{x})$ and $\\delta_{\\mathrm{D}}$ is the Dirac delta function. In a finite periodic volume $V=L^3$, the discrete Fourier amplitudes satisfy\n$$\n\\langle |\\hat{\\delta}(\\mathbf{k})|^2 \\rangle = V P(k).\n$$\n- For a real-valued overdensity field $\\delta(\\mathbf{x})$, the Fourier amplitudes must obey the Hermitian symmetry condition\n$$\na_{\\mathbf{m}_*} = a_{\\mathbf{m}}^*, \\quad \\text{with} \\quad \\mathbf{m}_* \\equiv (-m_x \\bmod N,\\,-m_y \\bmod N,\\,-m_z \\bmod N).\n$$\nModes that map onto themselves under $\\mathbf{m} \\mapsto \\mathbf{m}_*$ are self-conjugate and must have purely real amplitudes.\n\nYour program must:\n1. Construct the discrete wavevector grid and implement the isotropic power spectrum\n$$\nP(k) = A \\left(\\frac{k}{k_0}\\right)^n \\exp\\left[-\\left(\\frac{k}{k_c}\\right)^2\\right],\n$$\nwith amplitude $A$, spectral index $n$, pivot wavenumber $k_0$, and cutoff wavenumber $k_c$. All wavenumbers $k$ must be expressed in $h/\\mathrm{Mpc}$, and volumes in $(\\mathrm{Mpc}/h)^3$. The overdensity $\\delta(\\mathbf{x})$ is dimensionless.\n2. Sample the discrete Fourier amplitudes $a_{\\mathbf{m}}$ from zero-mean complex Gaussian distributions with variance derived from the above relations and the FFT normalization. Use the FFT conventions given, and derive the variance $\\mathrm{Var}(a_{\\mathbf{m}})$ required such that the real-space variance is consistent with the discrete sum over $P(k)$. Ensure the Hermitian symmetry constraint $a_{\\mathbf{m}_*} = a_{\\mathbf{m}}^*$ is satisfied exactly, and enforce that the zero mode at $\\mathbf{k}=\\mathbf{0}$ is set to zero so that $\\delta$ has zero mean.\n3. Compute the real-space field $\\delta_{\\mathbf{r}}$ via inverse FFT and test:\n   - The reality condition: $\\delta_{\\mathbf{r}} \\in \\mathbb{R}$ for all grid points (up to numerical precision). Report whether the maximum absolute imaginary part across the grid is below a tolerance of $10^{-10}$.\n   - Phase statistics: for the set of non-self-conjugate modes in the fundamental half of Fourier space, compute the phases $\\theta_{\\mathbf{m}} = \\arg(a_{\\mathbf{m}})$ in radians and measure the Rayleigh mean resultant length\n   $$\n   R = \\left| \\frac{1}{M} \\sum_{j=1}^{M} e^{i \\theta_j} \\right|,\n   $$\n   where $M$ is the number of included modes. A value $R$ near $0$ indicates phases close to independent and uniformly distributed.\n   - Hermitian symmetry accuracy: compute the maximum absolute deviation\n   $$\n   \\epsilon_{\\mathrm{H}} = \\max_{\\mathbf{m}} \\left| a_{\\mathbf{m}_*} - a_{\\mathbf{m}}^* \\right|.\n   $$\n   - Variance consistency: compute the empirical variance $\\sigma^2_{\\mathrm{emp}}$ of the real-space $\\delta_{\\mathbf{r}}$ and the theoretical target variance\n   $$\n   \\sigma^2_{\\mathrm{th}} = \\frac{1}{V} \\sum_{\\mathbf{m}} P\\left( \\left\\|\\mathbf{k}_{\\mathbf{m}}\\right\\| \\right),\n   $$\n   and report the relative error $\\left| \\sigma^2_{\\mathrm{emp}} - \\sigma^2_{\\mathrm{th}} \\right| / \\sigma^2_{\\mathrm{th}}$.\n   - Periodicity and translation invariance in Fourier magnitude: apply a cyclic shift of the real-space field by an integer vector $\\mathbf{s}$ in grid units and verify that Fourier magnitudes are invariant, i.e., $|a_{\\mathbf{m}}|$ is unchanged. Quantify this by the relative $\\ell_2$ difference of magnitudes.\n\nAngles must be treated in radians. All physical lengths must be treated in $\\mathrm{Mpc}/h$, and wavenumbers in $h/\\mathrm{Mpc}$. The overdensity $\\delta$ is dimensionless; the power spectrum $P(k)$ has units $(\\mathrm{Mpc}/h)^3$.\n\nUse the following test suite of parameter values, which must be hard-coded in your program and executed in order:\n\n- Test Case $1$ (general case):\n  - $N = 16$,\n  - $L = 200.0$ $\\mathrm{Mpc}/h$,\n  - $A = 2.0 \\times 10^3$ $(\\mathrm{Mpc}/h)^3$,\n  - $n = -2.0$,\n  - $k_0 = 1.0$ $h/\\mathrm{Mpc}$,\n  - $k_c = 0.25$ $h/\\mathrm{Mpc}$,\n  - random seed $42$,\n  - shift vector $\\mathbf{s} = (1,2,3)$.\n- Test Case $2$ (edge case with many self-conjugate planes due to even $N$):\n  - $N = 8$,\n  - $L = 50.0$ $\\mathrm{Mpc}/h$,\n  - $A = 5.0 \\times 10^2$ $(\\mathrm{Mpc}/h)^3$,\n  - $n = 0.0$,\n  - $k_0 = 1.0$ $h/\\mathrm{Mpc}$,\n  - $k_c = 0.8$ $h/\\mathrm{Mpc}$,\n  - random seed $123$,\n  - shift vector $\\mathbf{s} = (1,2,3)$.\n- Test Case $3$ (different spectral index and cutoff, translation-invariance check emphasized):\n  - $N = 12$,\n  - $L = 120.0$ $\\mathrm{Mpc}/h$,\n  - $A = 1.0 \\times 10^3$ $(\\mathrm{Mpc}/h)^3$,\n  - $n = -1.5$,\n  - $k_0 = 1.0$ $h/\\mathrm{Mpc}$,\n  - $k_c = 0.4$ $h/\\mathrm{Mpc}$,\n  - random seed $2024$,\n  - shift vector $\\mathbf{s} = (1,2,3)$.\n\nFor each test case, your program must compute and return a list containing:\n- a boolean indicating whether the maximum imaginary part of $\\delta_{\\mathbf{r}}$ is below $10^{-10}$,\n- a float with $\\epsilon_{\\mathrm{H}}$,\n- a float with $R$ for phases in the selected fundamental half of Fourier space,\n- a float with the variance relative error,\n- a float with the relative $\\ell_2$ difference of Fourier magnitudes before and after the cyclic shift.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, with one sublist per test case, for example\n$$\n[\\,[\\mathrm{True},\\,0.0,\\,R_1,\\,E_1,\\,S_1],\\,[\\mathrm{True},\\,0.0,\\,R_2,\\,E_2,\\,S_2],\\,[\\mathrm{True},\\,0.0,\\,R_3,\\,E_3,\\,S_3]\\,].\n$$\nNo other output is allowed.",
            "solution": "The user's request is to create a program that generates cosmological initial conditions on a discrete grid, according to a specified power spectrum and statistical properties. The problem is well-defined, scientifically sound, and constitutes a standard exercise in numerical cosmology. It is therefore deemed valid. The solution involves constructing a Gaussian random field in Fourier space that satisfies the necessary Hermitian symmetry for a real-valued field in configuration space, followed by a series of verification tests.\n\n### Principle-Based Design\n\nThe core of the task is to generate discrete Fourier amplitudes $a_{\\mathbf{m}}$ on a cubic grid of size $N \\times N \\times N$, which, after an inverse Fourier transform, will produce a real-valued overdensity field $\\delta_{\\mathbf{r}}$ with the desired statistical properties.\n\n#### 1. Fourier Space Setup\n\nA finite cubic volume of side length $L$ with periodic boundary conditions naturally discretizes Fourier space. The wavevectors $\\mathbf{k}$ are restricted to a grid:\n$$\n\\mathbf{k}_{\\mathbf{m}} = \\frac{2\\pi}{L} \\mathbf{m}\n$$\nwhere $\\mathbf{m} = (m_x, m_y, m_z)$ is a vector of integers. For compatibility with the Fast Fourier Transform (FFT) algorithm, these integer vectors are conventionally chosen to be in the range corresponding to the array indices output by `fftfreq` functions. For an axis of length $N$, the integer modes are $m_i \\in \\{0, 1, \\dots, N/2-1, -N/2, \\dots, -1\\}$ (for even $N$). We construct a 3D grid of these wavevectors and compute their magnitudes $\\|\\mathbf{k}_{\\mathbf{m}}\\|$, which are needed for the isotropic power spectrum.\n\n#### 2. Power Spectrum and Amplitude Variance\n\nThe statistical properties of the field are encoded in the power spectrum $P(k)$. For a statistically homogeneous and isotropic Gaussian random field, the Fourier amplitudes at different wavevectors are independent random variables. The variance of these amplitudes is related to the power spectrum. The problem provides a specific DFT normalization convention:\n$$\n\\delta_{\\mathbf{r}} = \\frac{1}{N^3} \\sum_{\\mathbf{m}} a_{\\mathbf{m}} \\exp\\left(i \\frac{2\\pi}{N} \\mathbf{r}\\cdot \\mathbf{m}\\right) \\quad \\text{and} \\quad a_{\\mathbf{m}} = \\sum_{\\mathbf{r}} \\delta_{\\mathbf{r}} \\exp\\left(-i \\frac{2\\pi}{N} \\mathbf{r}\\cdot \\mathbf{m}\\right)\n$$\nConnecting this discrete representation to the continuous field definition $\\langle |\\hat{\\delta}(\\mathbf{k})|^2 \\rangle = V P(k)$ yields the expected variance for the discrete amplitudes $a_{\\mathbf{m}}$:\n$$\n\\langle |a_{\\mathbf{m}}|^2 \\rangle = \\frac{N^6}{V} P(k_{\\mathbf{m}}) = \\frac{N^6}{L^3} P(k_{\\mathbf{m}})\n$$\nwhere $k_{\\mathbf{m}} = \\|\\mathbf{k}_{\\mathbf{m}}\\|$. The problem specifies the functional form for $P(k)$:\n$$\nP(k) = A \\left(\\frac{k}{k_0}\\right)^n \\exp\\left[-\\left(\\frac{k}{k_c}\\right)^2\\right]\n$$\nNote that for $k=0$ (the DC mode), the overdensity field has zero mean, which implies $a_{\\mathbf{0}}=0$. Correspondingly, we set $P(0)=0$ to avoid divergences for $n<0$.\n\n#### 3. Hermitian Symmetry and Amplitude Generation\n\nFor the real-space field $\\delta_{\\mathbf{r}}$ to be purely real, its Fourier transform must be Hermitian, i.e., $a_{\\mathbf{m}^*} = a_{\\mathbf{m}}^*$, where $\\mathbf{m}^* = -\\mathbf{m} \\pmod N$. This constraint dictates the generation procedure for the amplitudes:\n1.  **Non-self-conjugate modes**: Most modes $\\mathbf{m}$ form pairs with their conjugate $\\mathbf{m}^* \\neq \\mathbf{m}$. For each such pair, we generate one complex amplitude, e.g., $a_{\\mathbf{m}}$, and deterministically set the other, $a_{\\mathbf{m}^*} = a_{\\mathbf{m}}^*$. The amplitude $a_{\\mathbf{m}} = x+iy$ is drawn from a complex Gaussian distribution, meaning its real ($x$) and imaginary ($y$) parts are drawn from independent real Gaussian distributions. The total variance is $\\langle |a_{\\mathbf{m}}|^2 \\rangle = \\langle x^2 \\rangle + \\langle y^2 \\rangle$. We set $\\langle x^2 \\rangle = \\langle y^2 \\rangle = \\frac{1}{2}\\langle |a_{\\mathbf{m}}|^2 \\rangle$.\n2.  **Self-conjugate modes**: Some modes satisfy $\\mathbf{m}^* = \\mathbf{m}$. The Hermitian condition requires $a_{\\mathbf{m}} = a_{\\mathbf{m}}^*$, meaning $a_{\\mathbf{m}}$ must be purely real. These amplitudes are drawn from a real Gaussian distribution with variance $\\langle a_{\\mathbf{m}}^2 \\rangle = \\langle |a_{\\mathbf{m}}|^2 \\rangle$.\n\nAn explicit looping algorithm is employed to construct the grid `a_m` that strictly adheres to this symmetry. We iterate through all grid indices, processing each mode or mode-pair only once to ensure independence of the underlying random numbers.\n\n#### 4. Real-Space Field and Verification\n\nWith the full grid of Fourier amplitudes $a_{\\mathbf{m}}$ constructed, the real-space field $\\delta_{\\mathbf{r}}$ is obtained via an inverse FFT. The chosen DFT convention matches that of standard numerical libraries (e.g., NumPy's `ifftn`), simplifying the implementation.\n$$\n\\delta_{\\mathbf{r}} = \\texttt{ifftn}(a_{\\mathbf{m}})\n$$\nThe resulting field and the intermediate amplitudes are then subjected to five verification tests, as specified in the problem:\n1.  **Reality**: The maximum absolute imaginary component of $\\delta_{\\mathbf{r}}$ is computed and checked against a small tolerance.\n2.  **Hermitian Symmetry**: The constructed grid $a_{\\mathbf{m}}$ is directly compared with its numerically generated Hermitian conjugate to machine precision.\n3.  **Phase Statistics**: The phases of the generated amplitudes for non-self-conjugate modes are collected. The Rayleigh mean resultant length $R$ is calculated to check if they are uniformly distributed, as expected for a Gaussian random field.\n4.  **Variance Consistency**: The empirical variance of the generated real-space field $\\delta_{\\mathbf{r}}$ is compared to the theoretical variance, which is calculated by summing the power spectrum over all discrete modes: $\\sigma^2_{\\mathrm{th}} = \\frac{1}{V} \\sum_{\\mathbf{m}} P(k_{\\mathbf{m}})$.\n5.  **Translation Invariance**: The real-space field is cyclically shifted. According to the Fourier shift theorem, this should only introduce a phase shift in the Fourier amplitudes, leaving their magnitudes unchanged. The relative $\\ell_2$ norm of the difference in magnitudes before and after the shift quantifies this property.\n\nThis comprehensive procedure ensures the generation of a statistically correct field and verifies the implementation's adherence to the fundamental principles of Fourier analysis and random field theory.",
            "answer": "```python\nimport numpy as np\n\ndef generate_initial_conditions(N, L, A, n, k0, kc, seed, s_vec):\n    \"\"\"\n    Generates and verifies cosmological initial conditions for a single test case.\n    \"\"\"\n    # Initialize a random number generator with the given seed.\n    rng = np.random.default_rng(seed)\n\n    # 1. Construct wavevector grid\n    # Integer modes m in FFT order\n    m_vals = np.fft.fftfreq(N) * N\n    # Physical wavenumbers k = 2*pi*m/L\n    k_vals = (2.0 * np.pi / L) * m_vals\n    kx, ky, kz = np.meshgrid(k_vals, k_vals, k_vals, indexing='ij')\n    k_mag = np.sqrt(kx**2 + ky**2 + kz**2)\n\n    # 2. Define and evaluate the power spectrum P(k) on the grid\n    def power_spectrum(k, A_p, n_p, k0_p, kc_p):\n        if k == 0.0:\n            return 0.0\n        return A_p * (k / k0_p)**n_p * np.exp(-(k / kc_p)**2)\n\n    pk_grid = np.vectorize(power_spectrum)(k_mag, A, n, k0, kc)\n\n    # 3. Sample Fourier amplitudes a_m with Hermitian symmetry\n    a_m = np.zeros((N, N, N), dtype=np.complex128)\n    visited = np.zeros((N, N, N), dtype=bool)\n    non_sc_phases = []\n\n    for ix in range(N):\n        for iy in range(N):\n            for iz in range(N):\n                if visited[ix, iy, iz]:\n                    continue\n\n                # Conjugate indices\n                ix_c = (N - ix) % N\n                iy_c = (N - iy) % N\n                iz_c = (N - iz) % N\n\n                pk = pk_grid[ix, iy, iz]\n                is_sc = (ix == ix_c and iy == iy_c and iz == iz_c)\n\n                if is_sc:\n                    # Self-conjugate modes: purely real amplitude\n                    # Variance <a_m^2> = (N^6/L^3) * P(k)\n                    var_real = (N**6 / L**3) * pk\n                    if var_real > 0:\n                        a_m[ix, iy, iz] = rng.normal() * np.sqrt(var_real)\n                    visited[ix, iy, iz] = True\n                else:\n                    # Non-self-conjugate modes: complex amplitude\n                    # <|a_m|^2> = 2 * Var(Re/Im part)\n                    var_part = 0.5 * (N**6 / L**3) * pk\n                    if var_part > 0:\n                        rand_re, rand_im = rng.normal(size=2)\n                        cplx_val = (rand_re + 1j * rand_im) * np.sqrt(var_part)\n                        a_m[ix, iy, iz] = cplx_val\n                        a_m[ix_c, iy_c, iz_c] = np.conj(cplx_val)\n                        non_sc_phases.append(np.angle(cplx_val))\n                    \n                    visited[ix, iy, iz] = True\n                    visited[ix_c, iy_c, iz_c] = True\n    \n    # Enforce zero mean overdensity\n    a_m[0, 0, 0] = 0.0\n\n    # 4. Perform verification tests\n    \n    # Test 1: Hermitian symmetry accuracy\n    indices = np.indices((N, N, N))\n    conj_indices = (N - indices) % N\n    a_m_star = a_m[tuple(conj_indices)]\n    epsilon_H = np.max(np.abs(a_m_star - np.conj(a_m)))\n\n    # Compute real-space field via inverse FFT\n    delta_r = np.fft.ifftn(a_m)\n    \n    # Test 2: Reality of delta_r\n    max_imag_part = np.max(np.abs(np.imag(delta_r)))\n    is_real = max_imag_part < 1e-10\n\n    # Test 3: Phase statistics (Rayleigh mean resultant length)\n    if non_sc_phases:\n        R = np.abs(np.mean(np.exp(1j * np.array(non_sc_phases))))\n    else:\n        R = 0.0\n\n    # Test 4: Variance consistency\n    V = L**3\n    sigma_sq_th = pk_grid.sum() / V\n    sigma_sq_emp = np.var(np.real(delta_r))\n    \n    if sigma_sq_th == 0.0:\n        variance_rel_error = 0.0 if sigma_sq_emp == 0.0 else np.inf\n    else:\n        variance_rel_error = np.abs(sigma_sq_emp - sigma_sq_th) / sigma_sq_th\n\n    # Test 5: Translation invariance\n    delta_r_shifted = np.roll(np.real(delta_r), shift=s_vec, axis=(0, 1, 2))\n    a_m_shifted = np.fft.fftn(delta_r_shifted)\n\n    mag_orig = np.abs(a_m)\n    mag_shifted = np.abs(a_m_shifted)\n    \n    norm_mag_orig = np.linalg.norm(mag_orig)\n    if norm_mag_orig == 0.0:\n        shift_rel_l2_diff = 0.0 if np.linalg.norm(mag_shifted) == 0.0 else np.inf\n    else:\n        shift_rel_l2_diff = np.linalg.norm(mag_orig - mag_shifted) / norm_mag_orig\n        \n    return [is_real, epsilon_H, R, variance_rel_error, shift_rel_l2_diff]\n\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print results.\n    \"\"\"\n    test_cases = [\n        {\n            \"N\": 16, \"L\": 200.0, \"A\": 2.0e3, \"n\": -2.0, \"k0\": 1.0, \n            \"kc\": 0.25, \"seed\": 42, \"s_vec\": (1, 2, 3)\n        },\n        {\n            \"N\": 8, \"L\": 50.0, \"A\": 5.0e2, \"n\": 0.0, \"k0\": 1.0, \n            \"kc\": 0.8, \"seed\": 123, \"s_vec\": (1, 2, 3)\n        },\n        {\n            \"N\": 12, \"L\": 120.0, \"A\": 1.0e3, \"n\": -1.5, \"k0\": 1.0,\n            \"kc\": 0.4, \"seed\": 2024, \"s_vec\": (1, 2, 3)\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        result = generate_initial_conditions(\n            case[\"N\"], case[\"L\"], case[\"A\"], case[\"n\"], case[\"k0\"], \n            case[\"kc\"], case[\"seed\"], case[\"s_vec\"]\n        )\n        results.append(result)\n\n    # Format the output as a string representation of a list of lists.\n    # This ensures exact format including 'True'/'False' booleans.\n    outer_list_str = []\n    for res_list in results:\n        inner_list_str = f\"[{res_list[0]},{res_list[1]},{res_list[2]},{res_list[3]},{res_list[4]}]\"\n        outer_list_str.append(inner_list_str)\n    \n    print(f\"[{','.join(outer_list_str)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "With a density field in place, the next step is to determine the gravitational potential it creates by solving the Poisson equation $\\nabla^2 \\phi = S \\delta$. This exercise focuses on implementing and validating a spectral Poisson solver, an elegant and efficient method that transforms the differential equation into a simple algebraic one in Fourier space. Calibrating your solver against an exact analytic solution for a single plane-wave perturbation is a fundamental verification test that builds confidence in the core of your gravity calculation. ",
            "id": "3481629",
            "problem": "You are tasked with calibrating a spectral Poisson solver for cosmological volumes with periodic boundary conditions by comparing to analytic solutions for single-mode density perturbations. Work in a cubic, periodic domain of side length $L$ with a uniform grid of $N \\times N \\times N$ points. Treat all quantities as dimensionless for this calibration, i.e., no physical units are required. Angles must be expressed in radians.\n\nFundamental base: In comoving coordinates, the cosmological Poisson equation for the peculiar gravitational potential $\\,\\phi(\\mathbf{x})\\,$ is\n$$\n\\nabla^2 \\phi(\\mathbf{x}) = S\\,\\delta(\\mathbf{x}),\n$$\nwhere $\\,\\delta(\\mathbf{x})\\,$ is the density contrast and $\\,S\\,$ is a constant proportional to $\\,4\\pi G a^2 \\bar{\\rho}\\,$ in physical units. In this problem, treat $\\,S\\,$ as a given dimensionless constant. The domain obeys periodic boundary conditions on all faces.\n\nCalibration target: For a single plane-wave density contrast\n$$\n\\delta(\\mathbf{x}) = A \\cos\\!\\left(\\mathbf{k}\\cdot\\mathbf{x} + \\varphi\\right),\n$$\nwith $\\,\\mathbf{k} = \\frac{2\\pi}{L}(m_x, m_y, m_z)\\,$ and integer triplet $\\, (m_x,m_y,m_z)\\,$, the analytic peculiar potential $\\,\\phi_{\\mathrm{ana}}(\\mathbf{x})\\,$ solving the Poisson equation in the periodic box is a cosine with the same phase and wavevector, scaled by $\\,S/|\\mathbf{k}|^2\\,$, except when $\\,\\mathbf{k}=\\mathbf{0}\\,$ (the zero mode), for which the physically consistent periodic solution is $\\,\\phi_{\\mathrm{ana}}(\\mathbf{x})=0\\,$.\n\nYour program must:\n- Construct the density contrast $\\,\\delta(\\mathbf{x})\\,$ on the grid for each test case.\n- Solve the Poisson equation under periodic boundary conditions using a spectral method based on the Fast Fourier Transform (FFT), taking care to treat the zero mode consistently with the periodic cosmological convention (i.e., mean density does not source a potential).\n- Construct the analytic potential $\\,\\phi_{\\mathrm{ana}}(\\mathbf{x})\\,$ for the same mode.\n- Compute the calibration error as follows:\n  - For nonzero $\\,\\mathbf{k}\\,$: the fractional $L^2$ error\n    $$\n    \\epsilon = \\frac{\\left\\|\\phi_{\\mathrm{num}} - \\phi_{\\mathrm{ana}}\\right\\|_2}{\\left\\|\\phi_{\\mathrm{ana}}\\right\\|_2},\n    $$\n    where $\\,\\|\\cdot\\|_2\\,$ denotes the Euclidean norm over all grid points.\n  - For the zero-mode case $\\,\\mathbf{k} = \\mathbf{0}\\,$: since $\\,\\phi_{\\mathrm{ana}}(\\mathbf{x})=0\\,$ everywhere, define\n    $$\n    \\epsilon = \\sqrt{\\frac{1}{N^3}\\sum_{i} \\left(\\phi_{\\mathrm{num},i}\\right)^2},\n    $$\n    i.e., the root-mean-square of the numerical potential.\n\nTest suite:\nProvide results for the following four test cases. In each case, $\\,N\\,$ is even, $\\,L\\,$ is the box size, $\\,A\\,$ is the cosine amplitude, $\\,\\varphi\\,$ is the phase in radians, and $\\,S\\,$ is the source constant in the Poisson equation above. The integer triplet $\\, (m_x,m_y,m_z)\\,$ defines the single-mode wavevector.\n\n- Case $1$: $\\,N=64\\,$, $\\,L=1.0\\,$, $\\,A=10^{-2}\\,$, $\\,\\varphi=0.3\\,$, $\\,S=1.0\\,$, $\\, (m_x,m_y,m_z)=(3,0,0)\\,$.\n- Case $2$: $\\,N=48\\,$, $\\,L=1.0\\,$, $\\,A=2\\times 10^{-2}\\,$, $\\,\\varphi=1.1\\,$, $\\,S=1.0\\,$, $\\, (m_x,m_y,m_z)=(2,3,5)\\,$.\n- Case $3$: $\\,N=32\\,$, $\\,L=1.0\\,$, $\\,A=10^{-3}\\,$, $\\,\\varphi=0.0\\,$, $\\,S=1.0\\,$, $\\, (m_x,m_y,m_z)=(15,0,0)\\,$. This is near the Nyquist wavenumber for $\\,N=32\\,$.\n- Case $4$: $\\,N=40\\,$, $\\,L=1.0\\,$, $\\,A=0.5\\,$, $\\,\\varphi=0.7\\,$, $\\,S=1.0\\,$, $\\, (m_x,m_y,m_z)=(0,0,0)\\,$. This is the zero-mode (constant density contrast) edge case.\n\nFinal output format:\nYour program should produce a single line of output containing the four calibration errors for the above test cases, in order, as a comma-separated list enclosed in square brackets, for example $\\,\\left[\\epsilon_1,\\epsilon_2,\\epsilon_3,\\epsilon_4\\right]\\,$. Each $\\,\\epsilon_i\\,$ must be a floating-point number.",
            "solution": "The problem requires the validation of a spectral Poisson solver for a periodic cosmological volume. This is achieved by comparing the numerical solution to a known analytic solution for a single plane-wave density perturbation. The problem is well-defined, scientifically sound, and provides all necessary parameters for a complete numerical implementation.\n\nThe governing equation is the cosmological Poisson equation in comoving coordinates:\n$$\n\\nabla^2 \\phi(\\mathbf{x}) = S\\,\\delta(\\mathbf{x})\n$$\nwhere $\\phi(\\mathbf{x})$ is the peculiar gravitational potential, $\\delta(\\mathbf{x})$ is the density contrast, and $S$ is a given constant. The domain is a cubic box of side length $L$ with periodic boundary conditions.\n\nThe core of the numerical solution is the spectral method, which leverages the properties of the Fourier transform. The key insight is that the differential operator $\\nabla^2$ becomes an algebraic multiplication in Fourier space. Let $\\hat{f}(\\mathbf{k}) = \\mathcal{F}[f(\\mathbf{x})]$ denote the Fourier transform of a function $f(\\mathbf{x})$. The differentiation property of the Fourier transform states that $\\mathcal{F}[\\nabla^2 f(\\mathbf{x})] = -|\\mathbf{k}|^2 \\hat{f}(\\mathbf{k})$, where $\\mathbf{k}$ is the wavevector.\n\nApplying the Fourier transform to the Poisson equation yields:\n$$\n-|\\mathbf{k}|^2 \\hat{\\phi}(\\mathbf{k}) = S \\hat{\\delta}(\\mathbf{k})\n$$\nThis algebraic equation can be solved for the Fourier modes of the potential, $\\hat{\\phi}(\\mathbf{k})$:\n$$\n\\hat{\\phi}(\\mathbf{k}) = -S \\frac{\\hat{\\delta}(\\mathbf{k})}{|\\mathbf{k}|^2}\n$$\nThe real-space potential $\\phi(\\mathbf{x})$ is then recovered by applying the inverse Fourier transform:\n$$\n\\phi(\\mathbf{x}) = \\mathcal{F}^{-1}[\\hat{\\phi}(\\mathbf{k})]\n$$\n\nA special case arises for the zero-frequency mode, $\\mathbf{k}=\\mathbf{0}$, also known as the DC component. For this mode, $|\\mathbf{k}|^2 = 0$, and the division is undefined. In cosmology, the mean density of the universe (corresponding to $\\mathbf{k}=\\mathbf{0}$) is treated as the background density, which drives the overall cosmic expansion as described by the Friedmann equations. The peculiar potential $\\phi$ is sourced only by density *fluctuations* or *contrasts* away from the mean. Therefore, the mean density contrast, $\\hat{\\delta}(\\mathbf{k}=\\mathbf{0})$, does not source a peculiar potential. This physical constraint is imposed by setting $\\hat{\\phi}(\\mathbf{k}=\\mathbf{0})=0$.\n\nThe algorithm for the numerical solution is as follows:\n1.  **Grid Generation**: Define a uniform $N \\times N \\times N$ grid of coordinates $\\mathbf{x}$ spanning the box of side $L$. The coordinates for a given axis run from $0$ to $L(N-1)/N$.\n2.  **Density Field Construction**: Evaluate the given single-mode density contrast, $\\delta(\\mathbf{x}) = A \\cos(\\mathbf{k}_{\\text{mode}} \\cdot\\mathbf{x} + \\varphi)$, on the real-space grid. The wavevector is given by $\\mathbf{k}_{\\text{mode}} = \\frac{2\\pi}{L}(m_x, m_y, m_z)$.\n3.  **Forward Fourier Transform**: Compute the Fourier representation of the density field, $\\hat{\\delta}(\\mathbf{k})$, using the Fast Fourier Transform (FFT) algorithm.\n4.  **Fourier-Space Solution**:\n    a.  Construct the grid of wavevectors $\\mathbf{k}$ corresponding to the discrete Fourier transform frequencies.\n    b.  Calculate the squared magnitude, $|\\mathbf{k}|^2$, for each wavevector on the Fourier grid.\n    c.  Compute the Fourier modes of the potential $\\hat{\\phi}(\\mathbf{k}) = -S \\hat{\\delta}(\\mathbf{k}) / |\\mathbf{k}|^2$.\n    d.  Explicitly set the zero-frequency mode to zero: $\\hat{\\phi}(\\mathbf{k}=\\mathbf{0}) = 0$.\n5.  **Inverse Fourier Transform**: Compute the numerical potential in real space, $\\phi_{\\mathrm{num}}(\\mathbf{x})$, by applying the inverse FFT to $\\hat{\\phi}(\\mathbf{k})$. The result of the inverse FFT will be a complex-valued array, but since the input field was real and the operations preserve conjugacy, the imaginary part will be zero to within machine precision and should be discarded.\n\nThe numerical solution $\\phi_{\\mathrm{num}}$ is then compared to the analytic solution $\\phi_{\\mathrm{ana}}$.\nFor a single plane-wave density contrast, applying $\\nabla^2$ to $\\cos(\\mathbf{k}\\cdot\\mathbf{x}+\\varphi)$ yields $-|\\mathbf{k}|^2\\cos(\\mathbf{k}\\cdot\\mathbf{x}+\\varphi)$. Thus, the analytic solution to $\\nabla^2 \\phi = S A \\cos(\\mathbf{k}\\cdot\\mathbf{x}+\\varphi)$ is:\n$$\n\\phi_{\\mathrm{ana}}(\\mathbf{x}) = -A \\frac{S}{|\\mathbf{k}|^2} \\cos(\\mathbf{k}\\cdot\\mathbf{x} + \\varphi), \\quad \\text{for } \\mathbf{k} \\neq \\mathbf{0}\n$$\nFor the zero mode, $\\mathbf{k}=\\mathbf{0}$, the density contrast $\\delta(\\mathbf{x}) = A\\cos(\\varphi)$ is constant. As per the physical convention, this uniform offset does not source a peculiar potential, so $\\phi_{\\mathrm{ana}}(\\mathbf{x})=0$.\n\nFinally, the calibration error $\\epsilon$ is computed.\n- For $\\mathbf{k} \\neq \\mathbf{0}$, we use the fractional $L^2$ error: $\\epsilon = \\frac{\\|\\phi_{\\mathrm{num}} - \\phi_{\\mathrm{ana}}\\|_2}{\\|\\phi_{\\mathrm{ana}}\\|_2}$, where $\\|\\cdot\\|_2$ is the Euclidean norm over all grid points.\n- For $\\mathbf{k} = \\mathbf{0}$, $\\phi_{\\mathrm{ana}}$ is identically zero, so the numerator and denominator would both be zero or near-zero. Instead, the error is defined as the root-mean-square (RMS) of the numerical potential: $\\epsilon = \\sqrt{\\frac{1}{N^3}\\sum_i (\\phi_{\\mathrm{num},i})^2}$.\n\nSince the input density field is a single, pure Fourier mode that is perfectly representable by the grid's basis functions (as the mode numbers $m_x, m_y, m_z$ are integers), the spectral method should yield a solution that matches the analytic solution to machine precision. The computed error $\\epsilon$ is therefore expected to be very small, on the order of $10^{-15}$ or $10^{-16}$.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the Poisson equation for several single-mode test cases\n    and computes the calibration error against the analytic solution.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (N, L, A, phi, S, (mx, my, mz))\n        (64, 1.0, 1e-2, 0.3, 1.0, (3, 0, 0)),\n        (48, 1.0, 2e-2, 1.1, 1.0, (2, 3, 5)),\n        (32, 1.0, 1e-3, 0.0, 1.0, (15, 0, 0)),\n        (40, 1.0, 0.5, 0.7, 1.0, (0, 0, 0)),\n    ]\n\n    results = []\n    for case in test_cases:\n        N, L, A, phi_phase, S, m_tuple = case\n        m = np.array(m_tuple, dtype=float)\n\n        # --- 1. Construct the real-space grid and density field ---\n        \n        # Grid coordinates\n        grid_pts = np.linspace(0.0, L, N, endpoint=False)\n        x, y, z = np.meshgrid(grid_pts, grid_pts, grid_pts, indexing='ij')\n\n        # Wavevector for the single mode\n        k_mode = (2.0 * np.pi / L) * m\n        \n        # Density contrast field delta(x)\n        k_dot_x = k_mode[0] * x + k_mode[1] * y + k_mode[2] * z\n        delta_real = A * np.cos(k_dot_x + phi_phase)\n\n        # --- 2. Solve for the potential phi_num using spectral method ---\n\n        # Forward FFT of the density field\n        delta_fourier = np.fft.fftn(delta_real)\n\n        # Construct the grid of wavevectors in Fourier space\n        k_freq = np.fft.fftfreq(N, d=L / N)\n        kx, ky, kz = np.meshgrid(k_freq, k_freq, k_freq, indexing='ij')\n        \n        # Note: k_freq gives frequency. To get wavenumber, multiply by 2*pi.\n        # k_squared = (2*pi*kx)^2 + (2*pi*ky)^2 + (2*pi*kz)^2\n        k_squared = (2.0 * np.pi)**2 * (kx**2 + ky**2 + kz**2)\n\n        # Solve for phi in Fourier space, handling the k=0 mode\n        phi_fourier = np.zeros_like(delta_fourier)\n        with np.errstate(divide='ignore', invalid='ignore'):\n            phi_fourier = -S * delta_fourier / k_squared\n        \n        # Explicitly set the k=0 (DC) component to zero\n        phi_fourier[0, 0, 0] = 0.0\n\n        # Inverse FFT to get the numerical solution for the potential\n        phi_num = np.real(np.fft.ifftn(phi_fourier))\n\n        # --- 3. Construct the analytic solution phi_ana ---\n        \n        is_zero_mode = np.all(m == 0)\n        \n        if is_zero_mode:\n            phi_ana = np.zeros_like(phi_num)\n        else:\n            k_mode_mag_sq = np.sum(k_mode**2)\n            phi_ana = -A * S / k_mode_mag_sq * np.cos(k_dot_x + phi_phase)\n\n        # --- 4. Compute the calibration error epsilon ---\n        \n        if is_zero_mode:\n            # For the zero mode, use RMS of the numerical potential\n            epsilon = np.sqrt(np.mean(phi_num**2))\n        else:\n            # For non-zero modes, use fractional L2 error\n            norm_ana = np.linalg.norm(phi_ana)\n            # Prevent division by zero if analytic solution is unexpectedly zero\n            if norm_ana == 0:\n                epsilon = np.linalg.norm(phi_num)\n            else:\n                norm_diff = np.linalg.norm(phi_num - phi_ana)\n                epsilon = norm_diff / norm_ana\n        \n        results.append(epsilon)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "This practice connects initial conditions and gravitational evolution by modeling the early, linear growth of structure using the Zel’dovich approximation. You will displace a set of particles according to this powerful analytical theory and then analyze the resulting density field to see how non-linear harmonics emerge from a single initial mode. This exercise provides deep insight into the onset of non-linearity and serves as a sophisticated end-to-end test of particle manipulation and grid-based analysis techniques. ",
            "id": "3481632",
            "problem": "You are asked to implement, validate, and diagnose a one-dimensional periodic experiment in numerical cosmology that compares the evolution of a single plane-wave density mode under periodic boundary conditions to the Zel’dovich approximation, and uses mode coupling to diagnose finite-box and discretization artifacts when the wavenumber magnitude is comparable to the fundamental mode. The experiment must be designed from first principles using mass conservation and the Zel’dovich mapping, without shortcut formulas provided in the problem statement.\n\nConstruct a one-dimensional periodic domain of length $L$ containing $N_{\\mathrm{p}}$ equal-mass particles with initial Lagrangian coordinates $q \\in [0,L)$ uniformly spaced. Impose a single plane-wave displacement field consistent with periodic boundary conditions, with wavevector $k = 2\\pi n_0/L$ where $n_0 \\in \\mathbb{Z}^+$ is the mode index, and with amplitude parameter $\\nu = A k$ such that $0  \\nu  1$ (to avoid shell crossing). The Zel’dovich mapping is defined by\n- the Eulerian position $x(q) = q + \\Psi(q)$,\n- an irrotational displacement $\\Psi(q)$ derived from a scalar potential that yields a longitudinal plane wave.\n\nUse mass conservation and the periodicity of the domain to derive, from first principles, an analytical prediction for the Fourier-series amplitudes of the Eulerian density contrast $\\delta(x)$ at harmonics of the seed mode, i.e., at wavenumbers $k' = m k$ for positive integers $m$. Your derivation must begin from mass conservation $[1+\\delta(x)]\\,dx = dq$ and the Zel’dovich mapping for a single-mode displacement, and may use standard special functions where they naturally arise from the derivation. Do not assume any target formula a priori.\n\nNumerically implement the following algorithm to realize the experiment:\n- Initialize $N_{\\mathrm{p}}$ particles at Lagrangian positions $q_i = (i + 1/2)\\Delta q$ for $i \\in \\{0,\\dots,N_{\\mathrm{p}}-1\\}$ with $\\Delta q = L/N_{\\mathrm{p}}$.\n- Set the displacement to be a longitudinal single-mode wave consistent with periodic boundary conditions: $\\Psi(q) = -A \\sin(k q)$ with $A = \\nu/k$ and $k = 2\\pi n_0/L$.\n- Map to Eulerian positions with periodic boundary conditions: $x_i = \\big(q_i + \\Psi(q_i)\\big) \\bmod L$.\n- Deposit particle masses to an Eulerian grid of $N_{\\mathrm{g}}$ cells using the Cloud-In-Cell (CIC) assignment scheme on a uniform mesh with spacing $\\Delta x = L/N_{\\mathrm{g}}$. Convert deposited mass to the overdensity field $\\delta_j = \\rho_j/\\bar{\\rho} - 1$ on grid cells $j \\in \\{0,\\dots,N_{\\mathrm{g}}-1\\}$.\n- Compute the discrete Fourier transform of $\\delta_j$ on the periodic domain to obtain complex Fourier coefficients at discrete wavenumber indices $n \\in \\{0,\\dots,\\lfloor N_{\\mathrm{g}}/2 \\rfloor\\}$ corresponding to $k_n = 2\\pi n/L$.\n\nBecause mass deposition via Cloud-In-Cell multiplies Fourier amplitudes by the assignment window, divide each measured Fourier amplitude by the one-dimensional CIC window\n$$\nW_{\\mathrm{CIC}}(k_n) = \\left[\\frac{\\sin\\big(k_n \\Delta x/2\\big)}{k_n \\Delta x/2}\\right]^2 = \\left[\\operatorname{sinc}\\left(\\frac{\\pi n}{N_{\\mathrm{g}}}\\right)\\right]^2,\n$$\nwhere $\\operatorname{sinc}(y) = \\sin(y)/y$. Use this deconvolution to compare the de-windowed measured amplitudes against your analytical Zel’dovich prediction at the first three harmonics $m \\in \\{1,2,3\\}$, provided that the harmonic index $m n_0$ does not exceed the available Nyquist index $\\lfloor N_{\\mathrm{g}}/2 \\rfloor$.\n\nDefine two quantitative diagnostics for each experiment:\n- The maximum relative amplitude error across the first three harmonics,\n$$\n\\varepsilon_{\\max} = \\max_{m \\in \\{1,2,3\\} \\,:\\, m n_0 \\le \\lfloor N_{\\mathrm{g}}/2 \\rfloor} \\frac{\\left|\\,\\widehat{\\delta}_{m n_0}^{\\mathrm{(meas)}}/W_{\\mathrm{CIC}}(k_{m n_0}) - \\widehat{\\delta}_{m n_0}^{\\mathrm{(theory)}}\\,\\right|}{\\left|\\widehat{\\delta}_{m n_0}^{\\mathrm{(theory)}}\\right|},\n$$\nwhere $\\widehat{\\delta}_n$ denotes the Fourier coefficient at index $n$ and the superscripts indicate measured versus theoretical (Zel’dovich) predictions. If a theoretical amplitude is negligibly small, you must robustly handle division by values close to zero.\n- A mode-coupling leakage index that diagnoses finite-box and discretization artifacts by quantifying power that leaks outside the harmonic ladder $\\{m n_0\\}$,\n$$\n\\mathcal{L} = \\frac{\\sum_{n=1}^{\\lfloor N_{\\mathrm{g}}/2 \\rfloor} \\left|\\widehat{\\delta}_n^{\\mathrm{(meas)}}\\right|^2 - \\sum_{m \\in \\mathcal{M}} \\left|\\widehat{\\delta}_{m n_0}^{\\mathrm{(meas)}}\\right|^2}{\\sum_{n=1}^{\\lfloor N_{\\mathrm{g}}/2 \\rfloor} \\left|\\widehat{\\delta}_n^{\\mathrm{(meas)}}\\right|^2},\n$$\nwhere $\\mathcal{M} = \\{m \\in \\{1,2,3\\} \\,|\\, m n_0 \\le \\lfloor N_{\\mathrm{g}}/2 \\rfloor\\}$ and the sums exclude the zero mode to avoid sensitivity to the mean-density constraint. Express $\\varepsilon_{\\max}$ and $\\mathcal{L}$ as decimals.\n\nTest suite:\n- Use three test cases to probe different regimes near the fundamental wavenumber and nonlinearity strength, with a fixed box length $L$:\n  1. $N_{\\mathrm{g}} = 64$, $N_{\\mathrm{p}} = 64$, $L = 1$, $n_0 = 1$, $\\nu = 0.3$.\n  2. $N_{\\mathrm{g}} = 64$, $N_{\\mathrm{p}} = 64$, $L = 1$, $n_0 = 2$, $\\nu = 0.3$.\n  3. $N_{\\mathrm{g}} = 64$, $N_{\\mathrm{p}} = 64$, $L = 1$, $n_0 = 1$, $\\nu = 0.9$.\n- All quantities are dimensionless in this problem.\n\nYour program must:\n- Implement the periodic mapping and mass assignment for the three test cases.\n- Compute the analytical Zel’dovich harmonic amplitudes from first principles and compare them to the de-windowed measured amplitudes to obtain $\\varepsilon_{\\max}$ for each case.\n- Compute the mode-coupling leakage index $\\mathcal{L}$ for each case.\n- Produce a single line of output containing the six results, ordered as $[\\varepsilon_{\\max}^{(1)}, \\mathcal{L}^{(1)}, \\varepsilon_{\\max}^{(2)}, \\mathcal{L}^{(2)}, \\varepsilon_{\\max}^{(3)}, \\mathcal{L}^{(3)}]$, where the superscripts refer to the test case number. Print each value rounded to six decimal places, without any additional text.\n\nAngle units are in radians. There are no physical units in this problem, since all quantities are dimensionless by construction. Your derivation must begin from mass conservation and the Zel’dovich mapping and justify any special-function representation you use for the analytical amplitudes. The numerical implementation must enforce periodic boundary conditions exactly via modular arithmetic on $[0,L)$ and must use the Cloud-In-Cell scheme as specified above.",
            "solution": "The problem asks for a theoretical derivation and numerical validation of the density field produced by a single plane-wave perturbation in a one-dimensional periodic cosmology, according to the Zel'dovich approximation. We must derive the analytical Fourier amplitudes of the density contrast, implement a numerical particle simulation, and compute two specified diagnostic metrics.\n\n**Part 1: Analytical Derivation of Fourier Amplitudes**\n\nThe derivation of the theoretical Fourier amplitudes for the Eulerian density contrast, $\\widehat{\\delta}_{m n_0}^{\\mathrm{(theory)}}$, begins, as specified, from the principle of mass conservation. In one dimension, this principle relates an infinitesimal mass element in uniform Lagrangian (initial) coordinates $q$ to its corresponding element in Eulerian (evolved) coordinates $x$. The mass is conserved, so $\\bar{\\rho}\\,dq = \\rho(x)\\,dx$, where $\\bar{\\rho}$ is the mean density and $\\rho(x)$ is the Eulerian density. The Eulerian density contrast is defined as $\\delta(x) = \\rho(x)/\\bar{\\rho} - 1$. Substituting this definition gives $(1+\\delta(x))\\,dx = dq$. This implies that the density contrast can be expressed in terms of the Jacobian of the coordinate transformation from $q$ to $x$:\n$$\n1 + \\delta(x) = \\left(\\frac{dx}{dq}\\right)^{-1} \\implies \\delta(x(q)) = \\left(\\frac{dx}{dq}\\right)^{-1} - 1\n$$\nThe problem specifies the Zel'dovich mapping $x(q) = q + \\Psi(q)$ with a single-mode displacement field $\\Psi(q) = -A \\sin(k q)$, where the fundamental wavevector is $k = 2\\pi n_0 / L$ for a mode index $n_0 \\in \\mathbb{Z}^+$. The derivative is:\n$$\n\\frac{dx}{dq} = 1 - A k \\cos(k q) = 1 - \\nu \\cos(k q)\n$$\nwhere $\\nu = A k$ is the dimensionless amplitude parameter, constrained to $0  \\nu  1$ to prevent shell-crossing (i.e., to ensure $dx/dq  0$ so the mapping is one-to-one).\n\nThe Fourier coefficients $\\widehat{\\delta}_n$ of the periodic function $\\delta(x)$ on the domain $[0, L)$ are given by:\n$$\n\\widehat{\\delta}_n = \\frac{1}{L} \\int_0^L \\delta(x) e^{-i k_n x} dx\n$$\nwhere $k_n = 2\\pi n / L$. To evaluate this integral, we change the integration variable from $x$ to $q$.\n$$\n\\widehat{\\delta}_n = \\frac{1}{L} \\int_0^L \\delta(x(q)) e^{-i k_n x(q)} \\frac{dx}{dq} dq\n$$\nSubstituting $\\delta(x(q)) = (dx/dq)^{-1} - 1$, we get:\n$$\n\\widehat{\\delta}_n = \\frac{1}{L} \\int_0^L \\left(\\left(\\frac{dx}{dq}\\right)^{-1} - 1\\right) e^{-i k_n x(q)} \\frac{dx}{dq} dq = \\frac{1}{L} \\int_0^L \\left(1 - \\frac{dx}{dq}\\right) e^{-i k_n x(q)} dq\n$$\nA more direct path to the same integral arises from observing that $\\int_0^L e^{-ik_n x} dx / L = 0$ for $n \\ne 0$. This implies $\\int_0^L e^{-ik_n x(q)} (dx/dq) dq = 0$. Thus, for $n \\ne 0$:\n$$\n\\int_0^L e^{-i k_n x(q)} dq = \\int_0^L e^{-i k_n x(q)} dq - \\int_0^L e^{-i k_n x(q)} \\frac{dx}{dq} dq = \\int_0^L \\left(1 - \\frac{dx}{dq}\\right) e^{-i k_n x(q)} dq\n$$\nThis confirms that the Fourier coefficients of the density contrast $\\delta(x)$ can be found by evaluating $\\widehat{\\delta}_n = \\frac{1}{L} \\int_0^L e^{-i k_n x(q)} dq$ for $n \\ne 0$. This expression represents the continuum limit of the discrete sum $\\frac{1}{N_p} \\sum_i e^{-ik_n x_i}$, which is the Fourier transform of the particle number density.\n\nWe are interested in the harmonics of the fundamental mode, where the wavenumber index is $n = m n_0$ for positive integers $m$. The corresponding wavevector is $k_{m n_0} = m k$. Substituting $x(q) = q - A \\sin(kq)$:\n$$\n\\widehat{\\delta}_{m n_0} = \\frac{1}{L} \\int_0^L e^{-i k_{m n_0} (q - A \\sin(kq))} dq = \\frac{1}{L} \\int_0^L e^{-i m k q} e^{i m k A \\sin(kq)} dq\n$$\nUsing $k A = \\nu$, we have:\n$$\n\\widehat{\\delta}_{m n_0} = \\frac{1}{L} \\int_0^L e^{-i m k q} e^{i m \\nu \\sin(kq)} dq\n$$\nWe perform a change of variables $\\theta = kq$. Then $d\\theta = k\\,dq$, and the integration range $q \\in [0,L)$ becomes $\\theta \\in [0, kL) = [0, 2\\pi n_0)$. The integral becomes:\n$$\n\\widehat{\\delta}_{m n_0} = \\frac{1}{L} \\int_0^{2\\pi n_0} e^{-i m \\theta} e^{i m \\nu \\sin(\\theta)} \\frac{d\\theta}{k} = \\frac{1}{kL} \\int_0^{2\\pi n_0} e^{i (m \\nu \\sin\\theta - m \\theta)} d\\theta\n$$\nSince $kL = 2\\pi n_0$ and the integrand is $2\\pi$-periodic, the integral over $n_0$ periods is $n_0$ times the integral over a single period $[0, 2\\pi)$:\n$$\n\\widehat{\\delta}_{m n_0} = \\frac{n_0}{2\\pi n_0} \\int_0^{2\\pi} e^{i (m \\nu \\sin\\theta - m \\theta)} d\\theta = \\frac{1}{2\\pi} \\int_0^{2\\pi} e^{i (m \\nu \\sin\\theta - m \\theta)} d\\theta\n$$\nThis is the integral representation of the Bessel function of the first kind, $J_m(z)$:\n$$\nJ_m(z) = \\frac{1}{2\\pi} \\int_0^{2\\pi} e^{i(z\\sin\\theta - m\\theta)} d\\theta\n$$\nBy identifying $z = m \\nu$, we arrive at the final analytical expression for the theoretical Fourier coefficients:\n$$\n\\widehat{\\delta}_{m n_0}^{\\mathrm{(theory)}} = J_m(m\\nu)\n$$\nThis result is remarkably simple: the amplitude of the $m$-th harmonic of the density contrast depends only on the order $m$ and the product $m\\nu$.\n\n**Part 2: Numerical Implementation and Diagnostics**\n\nThe numerical part of the problem involves the following steps:\n\n1.  **Particle Initialization**: $N_{\\mathrm{p}}$ particles are placed at Lagrangian coordinates $q_i = (i + 1/2) (L/N_{\\mathrm{p}})$ for $i=0, \\dots, N_{\\mathrm{p}}-1$.\n2.  **Zel'dovich Mapping**: Each particle is displaced to its Eulerian position $x_i = (q_i - A \\sin(k q_i)) \\pmod L$, with $k=2\\pi n_0/L$ and $A=\\nu/k$. Modular arithmetic ensures periodic boundary conditions are correctly handled.\n3.  **Mass Deposition**: The particle masses are assigned to a uniform Eulerian grid of $N_{\\mathrm{g}}$ cells using the Cloud-In-Cell (CIC) scheme. For each particle at position $x_i$, its mass is distributed linearly between the two nearest grid cells. The position in grid units is $u_i = x_i / \\Delta x$ where $\\Delta x = L/N_{\\mathrm{g}}$. The left cell index is $j_1=\\lfloor u_i \\rfloor$ and the right is $j_2 = (j_1+1) \\pmod{N_{\\mathrm{g}}}$. The weights are $w_2 = u_i - j_1$ for cell $j_2$ and $w_1 = 1 - w_2$ for cell $j_1$.\n4.  **Density Contrast**: The gridded mass is converted to the density contrast field $\\delta_j = \\rho_j/\\bar{\\rho} - 1$, where $\\rho_j$ is the mass in cell $j$ and $\\bar{\\rho}$ is the mean mass per cell. For the given test cases, $N_{\\mathrm{p}}=N_{\\mathrm{g}}$, so the mean is $1$ particle per cell, and $\\delta_j$ is simply the count in cell $j$ minus $1$.\n5.  **Fourier Analysis**: The discrete Fourier transform of the real-valued field $\\delta_j$ is computed using an FFT algorithm (`numpy.fft.rfft`), yielding complex coefficients $\\widehat{\\delta}_n^{\\mathrm{(meas, raw)}}$ after normalization by $N_{\\mathrm{g}}$.\n6.  **Deconvolution**: The CIC scheme has a known filtering effect in Fourier space, which is corrected by dividing the measured coefficients by the CIC window function $W_{\\mathrm{CIC}}(k_n) = [\\operatorname{sinc}(\\pi n/N_{\\mathrm{g}})]^2$.\n7.  **Diagnostics**:\n    *   **$\\varepsilon_{\\max}$**: The maximum relative amplitude error is computed by comparing the de-convolved measured coefficients $|\\widehat{\\delta}_{m n_0}^{\\mathrm{(meas)}}|$ with the theoretical prediction $|\\widehat{\\delta}_{m n_0}^{\\mathrm{(theory)}}| = |J_m(m\\nu)|$ for the first three harmonics ($m \\in \\{1,2,3\\}$) that are resolvable on the grid (i.e., $m n_0 \\le \\lfloor N_{\\mathrm{g}}/2 \\rfloor$).\n    *   **$\\mathcal{L}$**: The mode-coupling leakage index quantifies the fraction of power in the Fourier spectrum that has \"leaked\" out of the expected harmonic ladder $\\{m n_0\\}$. It is calculated as the ratio of the non-harmonic power to the total power, excluding the $n=0$ mode.\n\nThe implementation follows these steps for each of the three test cases, which probe different regimes of fundamental wavenumber and nonlinearity.",
            "answer": "```python\nimport numpy as np\nfrom scipy.special import jv\n\ndef solve():\n    \"\"\"\n    Main function to run the simulation and analysis for all test cases and print\n    the final results in the specified format.\n    \"\"\"\n    test_cases = [\n        # (N_g, N_p, L, n_0, nu)\n        (64, 64, 1.0, 1, 0.3),\n        (64, 64, 1.0, 2, 0.3),\n        (64, 64, 1.0, 1, 0.9),\n    ]\n\n    all_results = []\n    for params in test_cases:\n        epsilon_max, leakage = run_simulation(*params)\n        all_results.extend([epsilon_max, leakage])\n\n    print(f\"[{','.join(f'{v:.6f}' for v in all_results)}]\")\n\ndef run_simulation(N_g, N_p, L, n_0, nu):\n    \"\"\"\n    Executes one test case of the numerical experiment.\n\n    Args:\n        N_g (int): Number of grid cells.\n        N_p (int): Number of particles.\n        L (float): Length of the periodic domain.\n        n_0 (int): Mode index of the initial plane wave.\n        nu (float): Amplitude parameter.\n\n    Returns:\n        tuple: A tuple containing (epsilon_max, leakage).\n    \"\"\"\n    # 1. Initialization\n    k = 2.0 * np.pi * n_0 / L\n    # The problem specifies n_0 is a positive integer, so k != 0.\n    A = nu / k\n        \n    delta_q = L / N_p\n    q_i = (np.arange(N_p, dtype=np.float64) + 0.5) * delta_q\n\n    # 2. Zel'dovich Mapping\n    psi_i = -A * np.sin(k * q_i)\n    x_i = np.mod(q_i + psi_i, L)\n\n    # 3. Mass Deposition (Cloud-In-Cell)\n    delta_x = L / N_g\n    mass_grid = np.zeros(N_g, dtype=np.float64)\n    \n    # Particle positions in grid units\n    u_i = x_i / delta_x\n    \n    # Indices of cells to the left of each particle\n    j1 = np.floor(u_i).astype(int)\n    \n    # Weights for deposition\n    w2 = u_i - j1\n    w1 = 1.0 - w2\n    \n    # Indices of cells to the right (with periodic wrap-around)\n    j2 = np.mod(j1 + 1, N_g)\n    \n    # Deposit mass using np.add.at for efficiency\n    np.add.at(mass_grid, j1, w1)\n    np.add.at(mass_grid, j2, w2)\n\n    # 4. Overdensity and Fourier Analysis\n    mean_density = float(N_p) / float(N_g)\n    delta_j = mass_grid / mean_density - 1.0\n    \n    delta_k_hat_raw = np.fft.rfft(delta_j)\n    \n    # 5. Deconvolution and Diagnostic Calculation\n    \n    # -- Epsilon_max: Maximum relative amplitude error --\n    errors = []\n    harmonics_to_check = [1, 2, 3]\n    nyquist_idx = N_g // 2\n    \n    # Physical Fourier coefficients (normalization by N_g)\n    d_meas_raw = delta_k_hat_raw / N_g\n    \n    k_indices = np.arange(len(d_meas_raw))\n    \n    # CIC window function W(k_n) = [sinc(pi*n/N_g)]^2, where sinc(x)=sin(x)/x\n    # np.sinc(x) calculates sin(pi*x)/(pi*x), which matches our need.\n    win_cic = np.sinc(k_indices / N_g)**2\n    # The window is non-zero for n = Nyquist\n    \n    d_meas_deconv = d_meas_raw / win_cic\n\n    for m in harmonics_to_check:\n        n = m * n_0\n        if n = nyquist_idx:\n            # Theoretical amplitude from Zel'dovich approximation: J_m(m*nu)\n            d_theory = jv(m, m * nu)\n            \n            # Measured (de-convolved) amplitude at this harmonic\n            d_meas = d_meas_deconv[n]\n            \n            numerator = np.abs(d_meas - d_theory)\n            denominator = np.abs(d_theory)\n            \n            if denominator  1e-15:\n                rel_error = 0.0 if numerator  1e-15 else np.inf\n            else:\n                rel_error = numerator / denominator\n            errors.append(rel_error)\n\n    epsilon_max = np.max(errors) if errors else 0.0\n\n    # -- L: Mode-coupling leakage index --\n    power_spectrum = np.abs(delta_k_hat_raw)**2\n    \n    # Total power (excluding n=0 DC mode)\n    total_power = np.sum(power_spectrum[1:])\n    \n    harmonic_indices = []\n    for m in harmonics_to_check:\n        n = m * n_0\n        if n = nyquist_idx:\n            harmonic_indices.append(n)\n            \n    harmonic_power = np.sum(power_spectrum[harmonic_indices])\n    \n    if total_power  1e-15:\n        leakage = 0.0\n    else:\n        leakage = (total_power - harmonic_power) / total_power\n        \n    return epsilon_max, leakage\n\nif __name__ == '__main__':\n    solve()\n```"
        }
    ]
}