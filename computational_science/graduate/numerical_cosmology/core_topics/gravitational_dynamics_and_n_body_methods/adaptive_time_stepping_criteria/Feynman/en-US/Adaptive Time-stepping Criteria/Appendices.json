{
    "hands_on_practices": [
        {
            "introduction": "Before diving into complex implementations, it is essential to build intuition on the fundamentals of numerical error. This exercise offers a unique opportunity to analytically derive and compare the global error accumulation for both an adaptive and a uniform time-stepping strategy. By applying rigorous error analysis to an ordinary differential equation that models cosmic expansion, you will uncover the core reason why adapting the step size to the problem's evolving timescale is not just an optimization, but a fundamental improvement in accuracy .",
            "id": "3464466",
            "problem": "Consider a spatially flat, matter-dominated Friedmann–Lemaître–Robertson–Walker cosmology for which the scale factor $a(t)$ obeys $a(t) \\propto t^{2/3}$, so that its evolution satisfies the nonautonomous linear ordinary differential equation $a'(t) = \\frac{2}{3 t} a(t)$ with $t0$. Let $a(t_0) = a_0$ be given, and consider the interval $[t_0, T]$ with $0  t_0  T$. You will integrate this equation using the second-order explicit midpoint method, a two-stage Runge–Kutta scheme defined by $y_{n+1} = y_n + h f\\!\\left(t_n + \\frac{h}{2}, y_n + \\frac{h}{2} f(t_n, y_n)\\right)$, where $f(t,y) = \\frac{2}{3 t} y$ and $h$ denotes the step size. \n\nUsing only Taylor expansions of the exact solution about a step and the fundamental solution of the linearized error evolution, derive the leading-order global error at $t=T$ under two time-stepping strategies:\n- An adaptive strategy with time-dependent step size $\\Delta t(t) = \\varepsilon t$ for a small dimensionless parameter $\\varepsilon0$.\n- A uniform strategy with constant step size $\\Delta t = h$, where $h$ is chosen such that $N h \\approx T - t_0$ for some integer $N$.\n\nCarry out the following steps:\n1. Compute the local truncation error at a general time $t$ to leading non-vanishing order in $\\Delta t(t)$ for the explicit midpoint method applied to $a'(t) = \\frac{2}{3 t} a(t)$.\n2. Determine how this local error injected at time $s$ propagates to the final time $T$ using the fundamental solution of the homogeneous error equation derived from $a'(t) = \\frac{2}{3 t} a(t)$.\n3. Accumulate the contributions of all steps to construct the leading-order global error at $t=T$ for both the adaptive and uniform strategies. Express each as a time integral over $[t_0, T]$.\n4. Finally, provide the closed-form analytic expression for the ratio \n$$R \\equiv \\frac{E_{\\mathrm{global}}^{\\mathrm{adaptive}}(T)}{E_{\\mathrm{global}}^{\\mathrm{uniform}}(T)}$$\nin terms of $t_0$, $T$, $\\varepsilon$, and $h$.\n\nYour final answer must be a single closed-form analytic expression. No rounding is required. The ratio $R$ is dimensionless; do not attach units.",
            "solution": "The problem asks for the ratio of the leading-order global errors at a final time $T$ for two different time-stepping strategies (adaptive and uniform) when integrating the ordinary differential equation (ODE) $a'(t) = \\frac{2}{3t} a(t)$ using the explicit midpoint method. The solution will proceed by following the four specified steps.\n\nThe ODE is $a'(t) = f(t, a(t))$ with $f(t, a) = \\frac{2}{3t} a$. The exact solution is of the form $a(t) = C t^{2/3}$ for some constant $C$. Given the initial condition $a(t_0)=a_0$, the constant is $C = a_0 t_0^{-2/3}$, so the exact solution is $a(t) = a_0 (t/t_0)^{2/3}$.\n\n### Step 1: Local Truncation Error (LTE)\n\nThe local truncation error, $\\tau(t)$, for a method of order $p$ is the error incurred in a single step of size $\\Delta t$, and its leading term is of the form $\\tau(t) \\approx C(t) (\\Delta t)^{p+1}$. For the second-order ($p=2$) explicit midpoint method, we expect the leading error term to be of order $(\\Delta t)^3$.\n\nThe explicit midpoint method for an initial value problem $y' = f(t,y)$ is:\n$$y_{n+1} = y_n + h f\\left(t_n + \\frac{h}{2}, y_n + \\frac{h}{2} f(t_n, y_n)\\right)$$\nTo find the LTE, we compare the numerical solution after one step, starting from the exact solution $a(t)$, with the Taylor expansion of the exact solution $a(t+\\Delta t)$.\nLet a single step of size $\\Delta t$ be taken from time $t$. The numerical solution $a_1$ is:\n$$a_1 = a(t) + \\Delta t \\, f\\left( t + \\frac{\\Delta t}{2}, a(t) + \\frac{\\Delta t}{2} f(t, a(t)) \\right)$$\nSubstituting $f(t, a) = \\frac{2a}{3t}$:\n$$a_1 = a(t) + \\Delta t \\, \\frac{2}{3(t+\\frac{\\Delta t}{2})} \\left( a(t) + \\frac{\\Delta t}{2} \\frac{2a(t)}{3t} \\right)$$\n$$a_1 = a(t) + \\frac{2\\Delta t}{3t(1+\\frac{\\Delta t}{2t})} a(t) \\left( 1 + \\frac{\\Delta t}{3t} \\right)$$\nWe expand the terms in powers of $\\Delta t$:\n$$\\frac{1}{1+\\frac{\\Delta t}{2t}} = 1 - \\frac{\\Delta t}{2t} + \\frac{(\\Delta t)^2}{4t^2} - O((\\Delta t)^3)$$\n$$a_1 = a(t) + \\frac{2\\Delta t a(t)}{3t} \\left(1 - \\frac{\\Delta t}{2t} + \\frac{(\\Delta t)^2}{4t^2} - \\dots \\right) \\left( 1 + \\frac{\\Delta t}{3t} \\right)$$\n$$a_1 = a(t) + a'(t) \\Delta t \\left(1 - \\frac{\\Delta t}{2t} + \\frac{\\Delta t}{3t} - \\frac{(\\Delta t)^2}{6t^2} + \\frac{(\\Delta t)^2}{4t^2} + \\dots \\right)$$\n$$a_1 = a(t) + a'(t) \\Delta t \\left(1 - \\frac{\\Delta t}{6t} + \\frac{(\\Delta t)^2}{12t^2} + \\dots \\right)$$\n$$a_1 = a(t) + \\Delta t a'(t) - \\frac{(\\Delta t)^2}{6t} a'(t) + \\frac{(\\Delta t)^3}{12t^2} a'(t) + \\dots$$\nThe Taylor series for the exact solution $a(t+\\Delta t)$ is:\n$$a(t+\\Delta t) = a(t) + \\Delta t a'(t) + \\frac{(\\Delta t)^2}{2} a''(t) + \\frac{(\\Delta t)^3}{6} a'''(t) + \\dots$$\nThe LTE is $\\tau(t) = a(t+\\Delta t) - a_1$. The terms of order $\\Delta t^0$ and $\\Delta t^1$ cancel. The coefficient of $(\\Delta t)^2$ is $\\frac{1}{2}a''(t) - (-\\frac{1}{6t}a'(t))$.\nThe derivatives of the exact solution are: $a'(t)=\\frac{2}{3t}a(t)$, $a''(t) = -\\frac{2}{9t^2}a(t) = -\\frac{1}{3t}a'(t)$, and $a'''(t) = \\frac{8}{27t^3}a(t)$.\nSubstituting $a''(t) = -\\frac{1}{3t}a'(t)$, the $(\\Delta t)^2$ term is $\\frac{(\\Delta t)^2}{2}(-\\frac{1}{3t}a'(t)) + \\frac{(\\Delta t)^2}{6t}a'(t) = 0$, confirming the method is second-order.\n\nThe leading non-vanishing term is of order $(\\Delta t)^3$:\n$$\\tau(t) = \\left( \\frac{1}{6}a'''(t) - \\frac{1}{12t^2}a'(t) \\right) (\\Delta t)^3 + O((\\Delta t)^4)$$\nSubstituting the expressions for the derivatives in terms of $a(t)$:\n$$\\tau(t) = \\left( \\frac{1}{6}\\frac{8a(t)}{27t^3} - \\frac{1}{12t^2}\\frac{2a(t)}{3t} \\right) (\\Delta t)^3 + \\dots = \\left( \\frac{4a(t)}{81t^3} - \\frac{a(t)}{18t^3} \\right) (\\Delta t)^3 + \\dots$$\n$$\\tau(t) = a(t) \\left( \\frac{8-9}{162t^3} \\right) (\\Delta t)^3 + \\dots = -\\frac{a(t)}{162t^3} (\\Delta t)^3 + O((\\Delta t)^4)$$\nSo, the leading-order local truncation error at time $t$ for a step $\\Delta t(t)$ is:\n$$\\tau(t) = -\\frac{a(t)}{162 t^3} (\\Delta t(t))^3$$\n\n### Step 2: Error Propagation\n\nThe global error, $e(t) = a_{\\mathrm{num}}(t) - a(t)$, evolves according to a linearized equation. The rate of change of the global error is the sum of the propagation of existing error and the injection of new local error. The homogeneous part of this evolution is $e'(t) \\approx \\frac{\\partial f}{\\partial a} e(t)$.\nFor $f(t,a) = \\frac{2a}{3t}$, the partial derivative is $\\frac{\\partial f}{\\partial a} = \\frac{2}{3t}$. The homogeneous error equation is:\n$$e'(t) = \\frac{2}{3t} e(t)$$\nThis is the same equation as for $a(t)$, so its solution is $e(t) \\propto t^{2/3}$. The fundamental solution $\\Phi(t,s)$ describes the evolution of a unit error injected at time $s$ to a later time $ts$. It is the solution to $e'(t) = \\frac{2}{3t}e(t)$ with initial condition $e(s)=1$. The solution is $e(t) = (t/s)^{2/3}$.\nThus, the fundamental solution for error propagation from time $s$ to time $T$ is:\n$$\\Phi(T,s) = \\left(\\frac{T}{s}\\right)^{2/3}$$\n\n### Step 3: Global Error Accumulation\n\nThe leading-order global error at time $T$, $E_{\\mathrm{global}}(T)$, is the integral of all local errors, each propagated to the final time $T$. The local error is injected at a rate of $\\frac{\\tau(t)}{\\Delta t(t)}$ per unit time. The global error is the solution to the inhomogeneous ODE $e'(t) = \\frac{2}{3t}e(t) + \\frac{\\tau(t)}{\\Delta t(t)}$, with initial condition $e(t_0)=0$.\nUsing the variation of parameters formula, the solution is:\n$$E_{\\mathrm{global}}(T) = \\int_{t_0}^T \\Phi(T, s) \\frac{\\tau(s)}{\\Delta t(s)} ds$$\nThe source term (error injection rate) is:\n$$S(s) = \\frac{\\tau(s)}{\\Delta t(s)} = \\frac{-a(s)/(162s^3) \\cdot (\\Delta t(s))^3}{\\Delta t(s)} = -\\frac{a(s)}{162s^3} (\\Delta t(s))^2$$\nSubstituting $a(s) = a_0(s/t_0)^{2/3}$ and $\\Phi(T,s)=(T/s)^{2/3}$:\n$$E_{\\mathrm{global}}(T) = \\int_{t_0}^T \\left(\\frac{T}{s}\\right)^{2/3} \\left(-\\frac{a_0(s/t_0)^{2/3}}{162s^3} (\\Delta t(s))^2 \\right) ds$$\n$$E_{\\mathrm{global}}(T) = -\\frac{a_0 T^{2/3}}{162 t_0^{2/3}} \\int_{t_0}^T s^{-2/3} \\frac{s^{2/3}}{s^3} (\\Delta t(s))^2 ds$$\n$$E_{\\mathrm{global}}(T) = -\\frac{a_0 T^{2/3}}{162 t_0^{2/3}} \\int_{t_0}^T s^{-3} (\\Delta t(s))^2 ds$$\n\nNow we evaluate this integral for the two strategies.\n\n**Adaptive Strategy**: $\\Delta t(s) = \\varepsilon s$.\n$$E_{\\mathrm{global}}^{\\mathrm{adaptive}}(T) = -\\frac{a_0 T^{2/3}}{162 t_0^{2/3}} \\int_{t_0}^T s^{-3} (\\varepsilon s)^2 ds = -\\frac{a_0 T^{2/3} \\varepsilon^2}{162 t_0^{2/3}} \\int_{t_0}^T s^{-1} ds$$\n$$E_{\\mathrm{global}}^{\\mathrm{adaptive}}(T) = -\\frac{a_0 T^{2/3} \\varepsilon^2}{162 t_0^{2/3}} [\\ln(s)]_{t_0}^T = -\\frac{a_0 T^{2/3} \\varepsilon^2}{162 t_0^{2/3}} \\ln\\left(\\frac{T}{t_0}\\right)$$\n\n**Uniform Strategy**: $\\Delta t(s) = h$.\n$$E_{\\mathrm{global}}^{\\mathrm{uniform}}(T) = -\\frac{a_0 T^{2/3}}{162 t_0^{2/3}} \\int_{t_0}^T s^{-3} h^2 ds = -\\frac{a_0 T^{2/3} h^2}{162 t_0^{2/3}} \\int_{t_0}^T s^{-3} ds$$\n$$E_{\\mathrm{global}}^{\\mathrm{uniform}}(T) = -\\frac{a_0 T^{2/3} h^2}{162 t_0^{2/3}} \\left[-\\frac{1}{2}s^{-2}\\right]_{t_0}^T = -\\frac{a_0 T^{2/3} h^2}{162 t_0^{2/3}} \\left(-\\frac{1}{2T^2} + \\frac{1}{2t_0^2}\\right)$$\n$$E_{\\mathrm{global}}^{\\mathrm{uniform}}(T) = -\\frac{a_0 T^{2/3} h^2}{324 t_0^{2/3}} \\left(\\frac{1}{t_0^2} - \\frac{1}{T^2}\\right)$$\n\n### Step 4: Ratio of Global Errors\n\nThe ratio $R$ is defined as $E_{\\mathrm{global}}^{\\mathrm{adaptive}}(T) / E_{\\mathrm{global}}^{\\mathrm{uniform}}(T)$.\n$$R = \\frac{-\\frac{a_0 T^{2/3} \\varepsilon^2}{162 t_0^{2/3}} \\ln\\left(\\frac{T}{t_0}\\right)}{-\\frac{a_0 T^{2/3} h^2}{324 t_0^{2/3}} \\left(\\frac{1}{t_0^2} - \\frac{1}{T^2}\\right)}$$\nThe common prefactors cancel:\n$$R = \\frac{\\frac{\\varepsilon^2}{162} \\ln\\left(\\frac{T}{t_0}\\right)}{\\frac{h^2}{324} \\left(\\frac{1}{t_0^2} - \\frac{1}{T^2}\\right)} = \\frac{324}{162} \\frac{\\varepsilon^2}{h^2} \\frac{\\ln\\left(\\frac{T}{t_0}\\right)}{\\frac{1}{t_0^2} - \\frac{1}{T^2}}$$\n$$R = 2 \\frac{\\varepsilon^2}{h^2} \\frac{\\ln\\left(\\frac{T}{t_0}\\right)}{\\frac{T^2-t_0^2}{t_0^2 T^2}}$$\nSimplifying the expression gives the final result:\n$$R = \\frac{2 \\varepsilon^2 t_0^2 T^2 \\ln\\left(\\frac{T}{t_0}\\right)}{h^2 (T^2 - t_0^2)}$$",
            "answer": "$$\\boxed{\\frac{2 \\varepsilon^2 t_0^2 T^2 \\ln\\left(\\frac{T}{t_0}\\right)}{h^2 \\left(T^2 - t_0^2\\right)}}$$"
        },
        {
            "introduction": "Modern cosmological simulations are multi-physics problems, evolving distinct quantities like mass density, velocity, and gravitational potential simultaneously. An adaptive time-stepper must make a single decision based on errors from all these components. This exercise tackles the critical design challenge of constructing a unified, dimensionless error norm that properly weights the error contribution from each variable based on its physical relevance and ensures numerical stability across diverse astrophysical regimes .",
            "id": "3464499",
            "problem": "A self-gravitating, compressible, nonrelativistic fluid is evolved in a Newtonian cosmology code in comoving coordinates with scale factor $a(t)$ and Hubble parameter $H(t) = \\dot{a}(t)/a(t)$. The state variables are the mass density $\\rho(\\mathbf{x},t)$, peculiar velocity $\\mathbf{v}(\\mathbf{x},t)$, and gravitational potential $\\Phi(\\mathbf{x},t)$, governed by the continuity equation, Euler equation, and Poisson equation. In a local control volume of linear size $L$, the code’s embedded error estimator for a single trial time step produces local truncation estimates $\\delta \\rho$, $\\delta \\mathbf{v}$, and $\\delta \\Phi$. An adaptive time-stepping controller must aggregate these into a single, dimensionless mixed-variable error norm $E$ to compare to a user tolerance $\\varepsilon$ and accept or reject the step.\n\nFrom first principles, the relevant governing laws and dimensions are:\n- Continuity: $\\partial_t \\rho + \\nabla \\cdot (\\rho \\mathbf{v}) + 3 H \\rho = 0$.\n- Euler: $\\partial_t \\mathbf{v} + (\\mathbf{v}\\cdot\\nabla)\\mathbf{v} = - \\nabla P / \\rho - \\nabla \\Phi - H \\mathbf{v}$, with equation of state yielding sound speed $c_s^2 = \\partial P / \\partial \\rho$.\n- Poisson: $\\nabla^2 \\Phi = 4 \\pi G (\\rho - \\bar{\\rho})$, where $G$ is Newton’s gravitational constant and $\\bar{\\rho}$ is the cosmological mean density.\n- Dimensions: $[\\rho] = M L^{-3}$, $[\\mathbf{v}] = L T^{-1}$, $[\\Phi] = L^2 T^{-2}$, $[H] = T^{-1}$, $[c_s] = L T^{-1}$.\n\nA physically relevant characteristic speed should capture the fastest signal among advection, acoustic, and gravitational motions. One proposed choice is\n$$\nv_* = \\max\\!\\left( \\lVert \\mathbf{v} \\rVert,\\, c_s,\\, \\sqrt{|\\Phi|} \\right),\n$$\nmotivated by the virial scaling $|\\Phi| \\sim \\lVert \\mathbf{v} \\rVert^2$ in bound flows and by the fact that $c_s$ controls compressive dynamics. In constructing $E$, the scaling must be dimensionally consistent and reflect the relative influence of density, velocity, and potential errors on the Euler and Poisson dynamics across regimes, including supersonic flows, virialized halos, and expansion-dominated regions.\n\nWhich of the following candidate mixed-variable norms $E$ is most appropriate, on the basis of dimensional analysis and physical relevance, for aggregating the errors $\\delta \\rho$, $\\delta \\mathbf{v}$, and $\\delta \\Phi$ in this cosmological setting? Here $\\delta v = \\lVert \\delta \\mathbf{v} \\rVert$.\n\nA. \n$$\nE_A = \\left[ \\left( \\frac{\\delta \\rho}{\\rho} \\right)^2 \\left( \\frac{c_s^2}{v_*^2} \\right) + \\left( \\frac{\\delta v}{v_*} \\right)^2 + \\left( \\frac{\\delta \\Phi}{v_*^2} \\right)^2 \\right]^{1/2}\n$$\n\nB.\n$$\nE_B = \\left[ \\left( \\frac{\\delta \\rho}{\\bar{\\rho}} \\right)^2 + \\left( \\frac{\\delta v}{\\lVert \\mathbf{v} \\rVert} \\right)^2 + \\left( \\frac{\\delta \\Phi}{|\\Phi|} \\right)^2 \\right]^{1/2}\n$$\n\nC.\n$$\nE_C = \\left[ \\delta \\rho^2 + \\delta v^2 + \\delta \\Phi^2 \\right]^{1/2}\n$$\n\nD.\n$$\nE_D = \\left[ \\left( \\frac{\\delta \\rho}{\\rho} \\right)^2 + \\left( \\frac{\\delta v}{H L} \\right)^2 + \\left( \\frac{\\delta \\Phi}{H^2 L^2} \\right)^2 \\right]^{1/2}\n$$\n\nSelect the single best option. You must justify your choice by showing, from the governing equations and dimensions, how the scaling of each term in $E$ relates to physically relevant accelerations and timescales, and why the selected option remains appropriate across regimes where $c_s$, $\\lVert \\mathbf{v} \\rVert$, or $\\sqrt{|\\Phi|}$ dominate. Explain why the other options fail either dimensional consistency or physical relevance. Assume no relativistic effects and that spatial variations are adequately resolved on the grid scale $L$.",
            "solution": "The user has provided a problem concerning the construction of a mixed-variable error norm for adaptive time-stepping in a numerical cosmology simulation. My task is to first validate the problem statement and then, if it is valid, derive the correct solution and evaluate all provided options.\n\n### Problem Validation\n\n**Step 1: Extract Givens**\n\n-   **System:** A self-gravitating, compressible, nonrelativistic fluid.\n-   **Framework:** Newtonian cosmology in comoving coordinates.\n-   **State Variables:** Mass density $\\rho(\\mathbf{x},t)$, peculiar velocity $\\mathbf{v}(\\mathbf{x},t)$, gravitational potential $\\Phi(\\mathbf{x},t)$.\n-   **Governing Equations:**\n    -   Continuity: $\\partial_t \\rho + \\nabla \\cdot (\\rho \\mathbf{v}) + 3 H \\rho = 0$.\n    -   Euler: $\\partial_t \\mathbf{v} + (\\mathbf{v}\\cdot\\nabla)\\mathbf{v} = - \\nabla P / \\rho - \\nabla \\Phi - H \\mathbf{v}$, with $c_s^2 = \\partial P / \\partial \\rho$.\n    -   Poisson: $\\nabla^2 \\Phi = 4 \\pi G (\\rho - \\bar{\\rho})$.\n-   **Input Errors:** Local truncation error estimates $\\delta \\rho$, $\\delta \\mathbf{v}$, and $\\delta \\Phi$ in a control volume of size $L$. Let $\\delta v = \\lVert \\delta \\mathbf{v} \\rVert$.\n-   **Objective:** Construct a dimensionless mixed-variable error norm $E$.\n-   **Dimensions:** $[\\rho] = M L^{-3}$, $[\\mathbf{v}] = L T^{-1}$, $[\\Phi] = L^2 T^{-2}$, $[H] = T^{-1}$, $[c_s] = L T^{-1}$.\n-   **Proposed Characteristic Speed:** $v_* = \\max\\!\\left( \\lVert \\mathbf{v} \\rVert,\\, c_s,\\, \\sqrt{|\\Phi|} \\right)$.\n-   **Constraints on Norm $E$:** Must be dimensionally consistent and physically relevant across different dynamical regimes (supersonic, virialized, expansion-dominated).\n\n**Step 2: Validate Using Extracted Givens**\n\n-   **Scientifically Grounded:** The provided governing equations (continuity, Euler, Poisson in comoving coordinates) are the standard, fundamental equations for Newtonian cosmological fluid dynamics. The concepts of adaptive time-stepping, local truncation error, and mixed-variable error norms are central to modern computational astrophysics. The given dimensions are correct. The definition of the characteristic velocity $v_*$ is a physically motivated and widely used standard in the field, representing the maximum local signal speed for advection, sound propagation, and gravitational interaction. The problem is firmly rooted in established principles of physics and numerical analysis.\n-   **Well-Posed:** The problem asks for the evaluation and selection of the \"most appropriate\" candidate expression for an error norm based on clear criteria (dimensional consistency, physical relevance). This is a well-defined task in physical reasoning and mathematical analysis, not an ill-posed search for a numerical answer. A unique, reasoned choice can be made among the options.\n-   **Objective:** The problem is stated in precise, technical language, free of subjectivity or ambiguity.\n\n**Step 3: Verdict and Action**\n\nThe problem statement is scientifically sound, well-posed, objective, and self-contained. It is a valid problem. I will now proceed with a full derivation and analysis.\n\n### Derivation and Analysis\n\nThe central task is to construct a dimensionless error norm $E$ that appropriately combines the errors $\\delta \\rho$, $\\delta v$, and $\\delta \\Phi$. This requires normalizing the error in each variable and weighting it according to its physical importance in the system's dynamics. The dynamics are governed by the Euler equation, which dictates the acceleration of the fluid.\n\nA robust error norm should be constructed such that each of its terms is dimensionless and the overall expression is numerically stable and physically meaningful across all expected regimes. The characteristic velocity $v_* = \\max\\!\\left( \\lVert \\mathbf{v} \\rVert,\\, c_s,\\, \\sqrt{|\\Phi|} \\right)$ is provided as the key local scale for the dynamics. It represents the fastest speed at which information can propagate locally, and thus it sets the local dynamical timescale, e.g., via the Courant-Friedrichs-Lewy (CFL) condition, $\\Delta t \\lesssim L/v_*$.\n\nLet us construct the dimensionless error contribution from each variable:\n\n1.  **Velocity Error:** The error in velocity is $\\delta v$, which has dimensions of velocity, $[L T^{-1}]$. The natural and physically adaptive quantity for normalization is the characteristic velocity $v_*$. Thus, the dimensionless velocity error contribution is $\\left( \\frac{\\delta v}{v_*} \\right)^2$.\n\n2.  **Potential Error:** The error in potential is $\\delta \\Phi$, which has dimensions of velocity squared, $[L^2 T^{-2}]$. To make this dimensionless, we must normalize it by a quantity with the same dimensions. The logical choice, consistent with the velocity normalization, is $v_*^2$. Thus, the dimensionless potential error contribution is $\\left( \\frac{\\delta \\Phi}{v_*^2} \\right)^2$.\n\n3.  **Density Error:** The error in density is $\\delta \\rho$. A simple dimensionless quantity is the relative error, $\\frac{\\delta \\rho}{\\rho}$. However, the dynamic importance of a density fluctuation depends critically on the fluid's compressibility and temperature, represented by the sound speed $c_s$. The Euler equation shows that density influences acceleration through the pressure gradient term, $-\\nabla P/\\rho$, whose magnitude is related to $c_s^2$. The importance of this pressure term relative to the inertial terms (e.g., advection, $\\sim v_*^2$) is characterized by the ratio $c_s^2 / v_*^2$. In a highly supersonic flow ($v_* \\gg c_s$), pressure forces are weak, and a density error should have a smaller impact on the total error norm. Conversely, in a subsonic flow ($v_* \\approx c_s$), pressure is dynamically significant, and the density error should be fully weighted.\n\nTherefore, the squared relative density error, $\\left(\\frac{\\delta \\rho}{\\rho}\\right)^2$, should be multiplied by a weighting factor that captures this physical effect. The most direct and physically motivated weighting factor is precisely the ratio of the characteristic pressure \"energy\" to the characteristic kinetic \"energy\", which is $w_\\rho = \\frac{c_s^2}{v_*^2}$.\n\n**Combining the Terms:**\nCombining these contributions into a single L2-norm (sum of squares), we get the squared error norm:\n$$\nE^2 = w_\\rho \\left(\\frac{\\delta \\rho}{\\rho}\\right)^2 + w_v \\left(\\frac{\\delta v}{v_*}\\right)^2 + w_\\Phi \\left(\\frac{\\delta \\Phi}{v_*^2}\\right)^2\n$$\nSetting the weights $w_v = 1$ and $w_\\Phi = 1$ (since velocity and potential are already normalized by the dominant scale $v_*$), and using our derived weight for density, $w_\\rho = c_s^2/v_*^2$, we arrive at:\n$$\nE^2 = \\left(\\frac{c_s^2}{v_*^2}\\right) \\left(\\frac{\\delta \\rho}{\\rho}\\right)^2 + \\left(\\frac{\\delta v}{v_*}\\right)^2 + \\left(\\frac{\\delta \\Phi}{v_*^2}\\right)^2\n$$\nThis expression is dimensionally consistent, uses a physically adaptive normalization scale ($v_*$), and correctly weights the contribution of the density error according to the local dynamical regime.\n\n### Option-by-Option Analysis\n\n**A. $E_A = \\left[ \\left( \\frac{\\delta \\rho}{\\rho} \\right)^2 \\left( \\frac{c_s^2}{v_*^2} \\right) + \\left( \\frac{\\delta v}{v_*} \\right)^2 + \\left( \\frac{\\delta \\Phi}{v_*^2} \\right)^2 \\right]^{1/2}$**\nThis expression matches our derivation precisely.\n-   **Dimensional Analysis:** Each term inside the square root is dimensionless. The expression is valid.\n-   **Physical Relevance:** It uses the adaptive velocity scale $v_*$ for normalization, ensuring relevance across different regimes. The normalization of $\\delta v$ by $v_*$ and $\\delta \\Phi$ by $v_*^2$ is correct. Crucially, the weighting of the density error term by $c_s^2/v_*^2$ correctly reflects the physical principle that density fluctuations are dynamically important in proportion to the importance of pressure forces (represented by $c_s^2$) relative to the dominant dynamics (represented by $v_*^2$). This makes the norm robust for subsonic, supersonic, and virialized flows.\n-   **Verdict:** Correct.\n\n**B. $E_B = \\left[ \\left( \\frac{\\delta \\rho}{\\bar{\\rho}} \\right)^2 + \\left( \\frac{\\delta v}{\\lVert \\mathbf{v} \\rVert} \\right)^2 + \\left( \\frac{\\delta \\Phi}{|\\Phi|} \\right)^2 \\right]^{1/2}$**\nThis option uses individual local quantities for normalization.\n-   **Dimensional Analysis:** Each term is a ratio of quantities with the same units, so it is dimensionless.\n-   **Physical Relevance:** This norm has several critical flaws.\n    1.  **Numerical Instability:** The denominators $\\lVert \\mathbf{v} \\rVert$ and $|\\Phi|$ can be zero or close to zero in physically common situations (e.g., regions of zero peculiar velocity or zero potential fluctuation). This would cause the norm to diverge, leading to pathological behavior in the time-stepping controller (e.g., forcing infinitesimally small time steps).\n    2.  **Inappropriate Scaling:** The term $\\delta\\rho/\\bar{\\rho}$ normalizes the local density error by the *cosmological mean density* $\\bar{\\rho}$. In a dense halo where $\\rho \\gg \\bar{\\rho}$, a small, physically insignificant *relative* error $\\delta\\rho/\\rho$ would be hugely amplified, leading to inefficiently small time steps.\n    3.  **Lack of Physical Weighting:** It treats a $1\\%$ error in each variable (relative to its own magnitude) as equally important, ignoring the fact that their relative influence changes dramatically with the physical regime, as captured by the Euler equation.\n-   **Verdict:** Incorrect.\n\n**C. $E_C = \\left[ \\delta \\rho^2 + \\delta v^2 + \\delta \\Phi^2 \\right]^{1/2}$**\nThis option adds the squared errors directly.\n-   **Dimensional Analysis:** This is fundamentally flawed. It attempts to add quantities with different physical dimensions:\n    -   $[\\delta \\rho^2] = M^2 L^{-6}$\n    -   $[\\delta v^2] = L^2 T^{-2}$\n    -   $[\\delta \\Phi^2] = L^4 T^{-4}$\n    Adding these quantities is mathematically and physically meaningless. The value of $E_C$ would change depending on the system of units used (e.g., SI vs. cgs).\n-   **Physical Relevance:** Since it is dimensionally inconsistent, it cannot be physically relevant.\n-   **Verdict:** Incorrect.\n\n**D. $E_D = \\left[ \\left( \\frac{\\delta \\rho}{\\rho} \\right)^2 + \\left( \\frac{\\delta v}{H L} \\right)^2 + \\left( \\frac{\\delta \\Phi}{H^2 L^2} \\right)^2 \\right]^{1/2}$**\nThis option uses scales derived from the Hubble parameter $H$ and the grid scale $L$.\n-   **Dimensional Analysis:** The velocity scale $HL$ has units $[L T^{-1}]$ and the potential scale $H^2 L^2$ has units $[L^2 T^{-2}]$. All terms are dimensionless. The expression is valid.\n-   **Physical Relevance:** The scales $HL$ and $H^2 L^2$ are characteristic of the Hubble expansion across the scale $L$. While this might be appropriate for large, linear-regime voids where the Hubble flow dominates, it is completely inappropriate for non-linear, gravitationally collapsed structures such as galaxies and clusters. In these dense regions, peculiar velocities and gravitational potentials are determined by local physics and are often much larger than the Hubble-derived scales (e.g., $\\lVert \\mathbf{v} \\rVert \\gg HL$). Using $HL$ as a normalization would grossly underestimate the true dynamical velocity, causing the error norm to be artificially inflated and forcing the simulation to take unnecessarily small, inefficient time steps. A proper norm must adapt to the *local* dynamical state, which this option fails to do.\n-   **Verdict:** Incorrect.\n\nBased on this comprehensive analysis, Option A is the only candidate that is dimensionally consistent, numerically stable, and physically appropriate across the wide range of conditions encountered in cosmological simulations.",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "This final practice serves as a capstone project, moving from theoretical principles to a full-fledged implementation for a key cosmological calculation. You will design, code, and evaluate a sophisticated adaptive time-step controller tailored specifically to the physics of linear structure formation, linking the step size directly to the rate of change of the Hubble parameter. This exercise exemplifies a powerful technique used in modern cosmology: creating highly efficient and accurate integrators by informing the numerical algorithm with the underlying physics of the problem being solved .",
            "id": "3464540",
            "problem": "You are tasked with designing, implementing, and evaluating an adaptive time-step controller for integrating the cosmological linear growth equation under different background expansion histories. The controller must adjust the physical time-step $\\Delta t$ to ensure that the change in the logarithmic scale factor $\\Delta \\ln a$ remains small during epochs where the Hubble expansion rate $H(z)$ evolves rapidly, while allowing larger $\\Delta \\ln a$ during epochs where $H(z)$ varies slowly, such as matter-dominated epochs. You will quantify the impact of your controller on growth observables by comparing its numerical accuracy and computational effort against a uniform-step baseline.\n\nFundamental bases you may use and must start from:\n- The Friedmann-Lemaître-Robertson-Walker (FLRW) background with spatial flatness and negligible radiation at late times, with the Hubble rate expressed as $H(a) = H_0 E(a)$, where $H_0$ is the present-day Hubble constant and $E(a)$ is dimensionless.\n- The definition $H \\equiv \\dot{a}/a$, equivalently $\\mathrm{d} \\ln a / \\mathrm{d} t = H$, where overdot denotes derivative with respect to cosmic time $t$.\n- Cold dark matter plus dark energy backgrounds, with matter density parameter $\\Omega_{\\mathrm{m}0}$ and dark energy density parameter $\\Omega_{\\mathrm{de}0} = 1 - \\Omega_{\\mathrm{m}0}$. The dark energy equation of state may be time dependent and is parameterized by the Chevallier-Polarski-Linder (CPL) form $w(a) = w_0 + w_a (1 - a)$, which yields\n$$\nE^2(a) = \\Omega_{\\mathrm{m}0} a^{-3} + \\Omega_{\\mathrm{de}0} \\, a^{-3(1+w_0+w_a)} \\exp\\big(3 w_a (a-1)\\big).\n$$\n- The linear matter density contrast $\\delta$ in the sub-horizon regime obeys $\\ddot{\\delta} + 2 H \\dot{\\delta} - 4 \\pi G \\rho_{\\mathrm{m}} \\delta = 0$. Defining the linear growth factor $D(a)$ by $\\delta(\\mathbf{x},a) = D(a) \\, \\delta(\\mathbf{x},a_{\\mathrm{init}})$, the growth factor obeys this same second-order ordinary differential equation (ODE).\n\nYour tasks:\n1. Derive, from the stated bases, a first-order system for $D(a)$ using the independent variable $x \\equiv \\ln a$. You must express the evolution as a first-order system in $x$ for $D$ and its derivative with respect to $x$. Clearly identify the dependence on $E(a)$, $\\Omega_{\\mathrm{m}}(a)$, and $\\mathrm{d} \\ln H / \\mathrm{d} \\ln a$. All derivations should be done in dimensionless units where $H_0 = 1$.\n2. Design two time-stepping strategies to integrate the growth system from $a_{\\mathrm{init}}$ to $a=1$:\n   - Baseline controller: fixed step in $x$, i.e., a uniform $\\Delta x \\equiv \\Delta \\ln a$ for all steps.\n   - Adaptive controller: choose $\\Delta x$ at each step so that both constraints are satisfied:\n     (i) an upper bound on the absolute change of the logarithmic Hubble rate per step, $|\\Delta \\ln H| \\le \\varepsilon_H$, and\n     (ii) an absolute cap $\\Delta x \\le \\Delta x_{\\max}$.\n     You must use the relation $\\mathrm{d} \\ln a / \\mathrm{d} t = H$ to convert your chosen $\\Delta x$ into a physical time-step $\\Delta t = \\Delta x / H$ at the beginning of each step. The design must be principled: the constraint on $|\\Delta \\ln H|$ should be enforced using the instantaneous value of $\\left|\\mathrm{d} \\ln H / \\mathrm{d} \\ln a\\right|$ so that $|\\Delta \\ln H| \\approx \\left|\\mathrm{d} \\ln H / \\mathrm{d} \\ln a\\right| \\Delta x$ does not exceed $\\varepsilon_H$.\n3. Numerically integrate the growth system from $a_{\\mathrm{init}} = 10^{-3}$ to $a=1$ with the following initial conditions motivated by matter domination: at $x_{\\mathrm{init}} = \\ln a_{\\mathrm{init}}$, take $D(a_{\\mathrm{init}}) = a_{\\mathrm{init}}$ and $\\mathrm{d} D / \\mathrm{d} \\ln a|_{a_{\\mathrm{init}}} = D(a_{\\mathrm{init}})$. Use a fixed-step high-accuracy reference solution by taking a very small uniform step in $x$ to serve as ground truth for error assessment.\n4. For each model and controller, report the following growth observables at $a=1$:\n   - The growth factor $D(1)$ (dimensionless).\n   - The logarithmic growth rate $f(1) \\equiv \\mathrm{d} \\ln D / \\mathrm{d} \\ln a \\big|_{a=1}$ (dimensionless).\n   Also compute the absolute relative error of each observable with respect to the high-accuracy reference solution and the total number of steps taken.\n5. Implement your integrator using a classic explicit fourth-order Runge-Kutta method in the independent variable $x = \\ln a$. All quantities must be treated as dimensionless, and you must express the final reported observables and errors as pure numbers with no units.\n\nController specification:\n- For the baseline controller, use a uniform $\\Delta x_{\\mathrm{base}}$.\n- For the adaptive controller, enforce simultaneously $|\\Delta \\ln H| \\le \\varepsilon_H$ and $\\Delta x \\le \\Delta x_{\\max}$. The physical time-step per step is $\\Delta t = \\Delta x / H$ evaluated at the step start. You must implement the bound on $|\\Delta \\ln H|$ using the instantaneous magnitude of $\\mathrm{d} \\ln H / \\mathrm{d} \\ln a$ evaluated at the step start.\n\nReference and numerical settings:\n- Use the high-accuracy reference with a uniform $\\Delta x_{\\mathrm{ref}} = 10^{-4}$.\n- Use the baseline uniform step $\\Delta x_{\\mathrm{base}} = 5 \\times 10^{-2}$.\n- For the adaptive controller, use $\\varepsilon_H = 3 \\times 10^{-2}$ and $\\Delta x_{\\max} = 10^{-1}$.\n\nTest suite:\nRun your program for the following three models, all spatially flat with $\\Omega_{\\mathrm{de}0} = 1 - \\Omega_{\\mathrm{m}0}$ and no radiation:\n- Test A (Einstein-de Sitter): $\\Omega_{\\mathrm{m}0} = 1$, $w_0 = -1$, $w_a = 0$. Note: Dark energy is absent; the equation of state parameters are irrelevant here but should be accepted by your code.\n- Test B (cosmological constant): $\\Omega_{\\mathrm{m}0} = 0.3$, $w_0 = -1$, $w_a = 0$.\n- Test C (thawing dark energy): $\\Omega_{\\mathrm{m}0} = 0.3$, $w_0 = -0.9$, $w_a = 0.8$.\n\nRequired outputs:\n- For each test, produce a list with ten entries in this exact order:\n  1. $D(1)$ from the adaptive controller.\n  2. $f(1)$ from the adaptive controller.\n  3. Absolute relative error of $D(1)$ for the adaptive controller versus reference.\n  4. Absolute relative error of $f(1)$ for the adaptive controller versus reference.\n  5. Total number of steps taken by the adaptive controller.\n  6. $D(1)$ from the baseline controller.\n  7. $f(1)$ from the baseline controller.\n  8. Absolute relative error of $D(1)$ for the baseline controller versus reference.\n  9. Absolute relative error of $f(1)$ for the baseline controller versus reference.\n  10. Total number of steps taken by the baseline controller.\n- Your program should produce a single line of output containing the results for the three tests as a comma-separated list of the three per-test lists enclosed within a single pair of square brackets, for example: \n\"[[...results for Test A...],[...results for Test B...],[...results for Test C...]]\".\nAll reported numbers must be dimensionless and given as floating-point numbers or integers as appropriate. No user input is required; all parameters are to be defined within the program.",
            "solution": "The problem as stated is scientifically grounded, well-posed, and contains all necessary information for a unique numerical solution. It is a standard problem in computational cosmology concerning the numerical integration of the linear growth of structure. The validation is successful, and I will proceed with a full solution.\n\nThe problem requires the derivation and numerical solution of the linear growth equation for the matter density contrast, $D(a)$, in a flat Friedmann-Lemaître-Robertson-Walker (FLRW) universe composed of cold dark matter and dark energy with a Chevallier-Polarski-Linder (CPL) equation of state. The solution will be obtained using a fourth-order Runge-Kutta integrator with two different time-stepping schemes: a uniform step in logarithmic scale factor and an adaptive step based on the rate of change of the Hubble parameter.\n\n**1. Derivation of the First-Order Growth System**\n\nThe starting point is the second-order ordinary differential equation (ODE) for the linear growth factor $D(a)$ in cosmic time $t$:\n$$\n\\ddot{D} + 2 H \\dot{D} - 4 \\pi G \\rho_{\\mathrm{m}} D = 0\n$$\nwhere an overdot denotes a derivative with respect to $t$, $H(a) = \\dot{a}/a$ is the Hubble parameter, $G$ is the gravitational constant, and $\\rho_{\\mathrm{m}}$ is the background matter density.\n\nWe change the independent variable from cosmic time $t$ to the logarithm of the scale factor, $x \\equiv \\ln a$. The chain rule provides the transformation for the derivatives. Let a prime denote a derivative with respect to $x$, i.e., $D' \\equiv \\mathrm{d}D/\\mathrm{d}x$.\n\nThe first derivative transforms as:\n$$\n\\dot{D} = \\frac{\\mathrm{d}D}{\\mathrm{d}t} = \\frac{\\mathrm{d}D}{\\mathrm{d}x} \\frac{\\mathrm{d}x}{\\mathrm{d}t} = D' \\frac{\\mathrm{d}(\\ln a)}{\\mathrm{d}t} = D' \\left(\\frac{1}{a}\\frac{\\mathrm{d}a}{\\mathrm{d}t}\\right) = H D'\n$$\n\nThe second derivative transforms as:\n$$\n\\ddot{D} = \\frac{\\mathrm{d}}{\\mathrm{d}t}(H D') = \\dot{H} D' + H \\dot{D'} = \\left(H \\frac{\\mathrm{d}H}{\\mathrm{d}x}\\right) D' + H \\left(H \\frac{\\mathrm{d}D'}{\\mathrm{d}x}\\right) = H^2 \\frac{\\mathrm{d}\\ln H}{\\mathrm{d}x} D' + H^2 D''\n$$\nNote that $\\mathrm{d}H/\\mathrm{d}t = (\\mathrm{d}H/\\mathrm{d}x)(\\mathrm{d}x/\\mathrm{d}t) = H(\\mathrm{d}H/\\mathrm{d}x)$ and since $x=\\ln a$, $\\mathrm{d}\\ln H/\\mathrm{d}x = \\mathrm{d}\\ln H/\\mathrm{d}\\ln a$.\n\nSubstituting these into the original ODE yields:\n$$\n\\left(H^2 \\frac{\\mathrm{d}\\ln H}{\\mathrm{d}\\ln a} D' + H^2 D''\\right) + 2H (H D') - 4 \\pi G \\rho_{\\mathrm{m}} D = 0\n$$\nDividing by $H^2$ gives:\n$$\nD'' + \\left(2 + \\frac{\\mathrm{d}\\ln H}{\\mathrm{d}\\ln a}\\right) D' - \\frac{4 \\pi G \\rho_{\\mathrm{m}}}{H^2} D = 0\n$$\nThe coefficient of the $D$ term can be simplified using the Friedmann equation for a spatially flat universe: $3H^2 = 8 \\pi G \\rho_{crit}$, where $\\rho_{crit}$ is the critical density. The matter density parameter is defined as $\\Omega_{\\mathrm{m}}(a) \\equiv \\rho_{\\mathrm{m}}(a) / \\rho_{crit}(a) = 8 \\pi G \\rho_{\\mathrm{m}}(a) / (3H(a)^2)$. Rearranging gives:\n$$\n\\frac{4 \\pi G \\rho_{\\mathrm{m}}}{H^2} = \\frac{3}{2} \\Omega_{\\mathrm{m}}(a)\n$$\nThe final equation for $D$ as a function of $x=\\ln a$ is:\n$$\nD'' + \\left(2 + \\frac{\\mathrm{d}\\ln H}{\\mathrm{d}\\ln a}\\right) D' - \\frac{3}{2} \\Omega_{\\mathrm{m}}(a) D = 0\n$$\nTo express the coefficients in terms of the given cosmological parameters, we use the provided expression for the dimensionless Hubble parameter, $E(a) = H(a)/H_0$. Setting $H_0=1$ for dimensionless calculations, $H(a) = E(a)$. The matter density parameter is $\\Omega_{\\mathrm{m}}(a) = \\Omega_{\\mathrm{m}0}a^{-3} / E^2(a)$. For the logarithmic derivative of $H$, we have $\\mathrm{d}\\ln H/\\mathrm{d}\\ln a = \\mathrm{d}\\ln E/\\mathrm{d}\\ln a$. This can be computed from $E^2(a)$:\n$$\n\\frac{\\mathrm{d}\\ln E}{\\mathrm{d}\\ln a} = \\frac{1}{2} \\frac{\\mathrm{d}\\ln E^2}{\\mathrm{d}\\ln a} = \\frac{1}{2E^2} \\frac{\\mathrm{d}E^2}{\\mathrm{d}\\ln a}\n$$\nThe derivative of $E^2(a)$ with respect to $\\ln a$ is:\n$$\n\\frac{\\mathrm{d}E^2}{\\mathrm{d}\\ln a} = -3\\Omega_{\\mathrm{m}0}a^{-3} - 3(1+w(a)) \\left[E^2(a) - \\Omega_{\\mathrm{m}0}a^{-3}\\right]\n$$\nThis leads to the compact form:\n$$\n\\frac{\\mathrm{d}\\ln H}{\\mathrm{d}\\ln a} = -\\frac{3}{2}(1+w(a)) + \\frac{3}{2}w(a)\\Omega_{\\mathrm{m}}(a)\n$$\nwhere $w(a) = w_0 + w_a(1-a)$.\n\nTo solve this numerically, we convert the second-order ODE into a first-order system. Let the state vector be $\\mathbf{Y}(x) = [Y_1(x), Y_2(x)]^T$, where $Y_1 = D$ and $Y_2 = D' = \\mathrm{d}D/\\mathrm{d}\\ln a$. The system is:\n$$\n\\frac{\\mathrm{d}\\mathbf{Y}}{\\mathrm{d}x} = \n\\begin{pmatrix}\n\\mathrm{d}Y_1/\\mathrm{d}x \\\\\n\\mathrm{d}Y_2/\\mathrm{d}x\n\\end{pmatrix}\n=\n\\begin{pmatrix}\nY_2 \\\\\n-\\left(2 + \\frac{\\mathrm{d}\\ln H}{\\mathrm{d}\\ln a}\\right) Y_2 + \\frac{3}{2} \\Omega_{\\mathrm{m}}(a) Y_1\n\\end{pmatrix}\n$$\nThis system is to be integrated from $x_{\\mathrm{init}} = \\ln(10^{-3})$ to $x_{\\mathrm{final}} = \\ln(1) = 0$, with initial conditions $Y_1(x_{\\mathrm{init}}) = 10^{-3}$ and $Y_2(x_{\\mathrm{init}}) = 10^{-3}$.\n\n**2. Numerical Implementation and Stepping Controllers**\n\nThe integration is performed using the classic fourth-order Runge-Kutta (RK4) method. For a system $\\mathrm{d}\\mathbf{Y}/\\mathrm{d}x = \\mathbf{F}(x, \\mathbf{Y})$, a single step from $x_n$ to $x_{n+1} = x_n + \\Delta x$ is:\n$$\n\\mathbf{k}_1 = \\mathbf{F}(x_n, \\mathbf{Y}_n) \\\\\n\\mathbf{k}_2 = \\mathbf{F}(x_n + \\frac{\\Delta x}{2}, \\mathbf{Y}_n + \\frac{\\Delta x}{2} \\mathbf{k}_1) \\\\\n\\mathbf{k}_3 = \\mathbf{F}(x_n + \\frac{\\Delta x}{2}, \\mathbf{Y}_n + \\frac{\\Delta x}{2} \\mathbf{k}_2) \\\\\n\\mathbf{k}_4 = \\mathbf{F}(x_n + \\Delta x, \\mathbf{Y}_n + \\Delta x \\mathbf{k}_3) \\\\\n\\mathbf{Y}_{n+1} = \\mathbf{Y}_n + \\frac{\\Delta x}{6}(\\mathbf{k}_1 + 2\\mathbf{k}_2 + 2\\mathbf{k}_3 + \\mathbf{k}_4)\n$$\n\nTwo controllers for the step size $\\Delta x$ are implemented:\n\n- **Baseline Controller**: A fixed step size $\\Delta x = \\Delta x_{\\mathrm{base}} = 5 \\times 10^{-2}$.\n\n- **Adaptive Controller**: The step size $\\Delta x$ is chosen at the start of each step to satisfy two constraints. The primary constraint limits the change in the logarithm of the Hubble rate per step, $|\\Delta \\ln H| \\le \\varepsilon_H$. This is approximated as $|\\frac{\\mathrm{d}\\ln H}{\\mathrm{d}\\ln a}|\\Delta x \\le \\varepsilon_H$, which implies $\\Delta x \\le \\varepsilon_H / |\\frac{\\mathrm{d}\\ln H}{\\mathrm{d}\\ln a}|$. The second constraint is a hard cap $\\Delta x \\le \\Delta x_{\\max}$. The step size is thus:\n$$\n\\Delta x = \\min\\left(\\frac{\\varepsilon_H}{\\left|\\frac{\\mathrm{d}\\ln H}{\\mathrm{d}\\ln a}\\right|}, \\Delta x_{\\max}\\right)\n$$\nwith $\\varepsilon_H = 3 \\times 10^{-2}$ and $\\Delta x_{\\max} = 10^{-1}$. If $\\mathrm{d}\\ln H/\\mathrm{d}\\ln a = 0$ (which does not occur for the models considered), the step is capped by $\\Delta x_{\\max}$. This strategy ensures that more steps are taken during epochs where the expansion history changes rapidly (i.e., when $|\\mathrm{d}\\ln H/\\mathrm{d}\\ln a|$ is large), and fewer steps are taken when it changes slowly.\n\n**3. Observables and Error Analysis**\n\nA high-accuracy reference solution is computed for each model using a very small uniform step, $\\Delta x_{\\mathrm{ref}} = 10^{-4}$. After integrating to $a=1$ ($x=0$), the final state vector $\\mathbf{Y}(0) = [Y_1(0), Y_2(0)]^T$ provides the key observables:\n- The growth factor at present: $D(1) = Y_1(0)$.\n- The logarithmic growth rate at present: $f(1) = \\frac{\\mathrm{d}\\ln D}{\\mathrm{d}\\ln a}\\Big|_{a=1} = \\frac{1}{D(1)} \\frac{\\mathrm{d}D}{\\mathrm{d}\\ln a}\\Big|_{a=1} = \\frac{Y_2(0)}{Y_1(0)}$.\n\nThe accuracy of the baseline and adaptive controllers is assessed by computing the absolute relative error of these observables against the reference solution for each model:\n$$\n\\text{Error}(Q) = \\left| \\frac{Q_{\\text{method}} - Q_{\\text{ref}}}{Q_{\\text{ref}}} \\right|\n$$\nThe computational effort is quantified by the total number of steps taken by each method to complete the integration. The final code implements this full procedure, running each of the three test models and reporting the specified ten output quantities per model.",
            "answer": "```python\nimport numpy as np\n\n# This program strictly adheres to the problem specification.\n# It does not use libraries beyond the allowed 'numpy' and Python standard library.\n# The 'scipy' library is permitted but not required for this implementation.\n\ndef solve():\n    \"\"\"\n    Main function to orchestrate the numerical integration and reporting of results.\n    \"\"\"\n    # Define test cases as per the problem statement\n    test_cases = [\n        # Test A (Einstein-de Sitter)\n        {'name': 'Test A', 'omega_m0': 1.0, 'w0': -1.0, 'wa': 0.0},\n        # Test B (Lambda-CDM)\n        {'name': 'Test B', 'omega_m0': 0.3, 'w0': -1.0, 'wa': 0.0},\n        # Test C (CPL/thawing dark energy)\n        {'name': 'Test C', 'omega_m0': 0.3, 'w0': -0.9, 'wa': 0.8},\n    ]\n\n    # Numerical settings from the problem statement\n    a_init = 1e-3\n    x_init = np.log(a_init)\n    x_final = 0.0\n    \n    # Initial conditions\n    # Y = [D, dD/dlna]\n    Y_init = np.array([a_init, a_init])\n\n    # Controller parameters\n    dx_ref = 1e-4\n    dx_base = 5e-2\n    eps_H = 3e-2\n    dx_max_adapt = 1e-1\n\n    all_results = []\n\n    for case in test_cases:\n        cosmology = case\n\n        # 1. Generate high-accuracy reference solution\n        Y_ref, _ = integrate(cosmology, Y_init, x_init, x_final, 'fixed', dx_ref)\n        D1_ref = Y_ref[0]\n        f1_ref = Y_ref[1] / Y_ref[0]\n\n        # 2. Run with adaptive controller\n        Y_adapt, steps_adapt = integrate(cosmology, Y_init, x_init, x_final, 'adaptive', {'eps_H': eps_H, 'dx_max': dx_max_adapt})\n        D1_adapt = Y_adapt[0]\n        f1_adapt = Y_adapt[1] / Y_adapt[0]\n        err_D_adapt = abs((D1_adapt - D1_ref) / D1_ref)\n        err_f_adapt = abs((f1_adapt - f1_ref) / f1_ref)\n\n        # 3. Run with baseline controller\n        Y_base, steps_base = integrate(cosmology, Y_init, x_init, x_final, 'fixed', dx_base)\n        D1_base = Y_base[0]\n        f1_base = Y_base[1] / Y_base[0]\n        err_D_base = abs((D1_base - D1_ref) / D1_ref)\n        err_f_base = abs((f1_base - f1_ref) / f1_ref)\n\n        # 4. Collate results in the specified order\n        case_results = [\n            D1_adapt, f1_adapt, err_D_adapt, err_f_adapt, steps_adapt,\n            D1_base, f1_base, err_D_base, err_f_base, steps_base\n        ]\n        all_results.append(case_results)\n\n    # Format output as a single-line string of a nested list\n    # e.g., \"[[...],[...],[...]]\"\n    output_str = \"[\" + \",\".join([\"[\" + \",\".join(map(str, res)) + \"]\" for res in all_results]) + \"]\"\n    print(output_str)\n\n\nclass CosmologyModel:\n    \"\"\"A helper class to encapsulate cosmological calculations for a given model.\"\"\"\n    def __init__(self, omega_m0, w0, wa):\n        self.omega_m0 = omega_m0\n        self.omega_de0 = 1.0 - omega_m0\n        self.w0 = w0\n        self.wa = wa\n\n    def w_of_a(self, a):\n        \"\"\"Dark energy equation of state parameter w(a).\"\"\"\n        return self.w0 + self.wa * (1.0 - a)\n\n    def E_sq(self, a):\n        \"\"\"Squared dimensionless Hubble parameter E^2(a).\"\"\"\n        if self.omega_de0 == 0:\n            return self.omega_m0 * a**-3.0\n            \n        de_term = self.omega_de0 * a**(-3.0 * (1.0 + self.w0 + self.wa)) * \\\n                  np.exp(3.0 * self.wa * (a - 1.0))\n        return self.omega_m0 * a**-3.0 + de_term\n\n    def omega_m_of_a(self, a):\n        \"\"\"Matter density parameter Omega_m(a).\"\"\"\n        return self.omega_m0 * a**-3.0 / self.E_sq(a)\n\n    def dlnH_dlna(self, a):\n        \"\"\"Logarithmic derivative of the Hubble parameter, d(ln H)/d(ln a).\"\"\"\n        w_a = self.w_of_a(a)\n        omega_m_a = self.omega_m_of_a(a)\n        return -1.5 * (1.0 + w_a) + 1.5 * w_a * omega_m_a\n\ndef ode_system(x, Y, cosmo_model: CosmologyModel):\n    \"\"\"\n    Defines the first-order ODE system dY/dx = F(x, Y).\n    x = ln(a)\n    Y = [D, dD/dlna]\n    \"\"\"\n    a = np.exp(x)\n    D, dD_dlna = Y[0], Y[1]\n\n    # Calculate coefficients\n    dlnH = cosmo_model.dlnH_dlna(a)\n    omega_m = cosmo_model.omega_m_of_a(a)\n\n    dY1_dx = dD_dlna\n    dY2_dx = -(2.0 + dlnH) * dD_dlna + 1.5 * omega_m * D\n\n    return np.array([dY1_dx, dY2_dx])\n\ndef rk4_step(x, Y, dx, f, cosmo_model):\n    \"\"\"Performs a single step of the 4th-order Runge-Kutta method.\"\"\"\n    k1 = f(x, Y, cosmo_model)\n    k2 = f(x + 0.5 * dx, Y + 0.5 * dx * k1, cosmo_model)\n    k3 = f(x + 0.5 * dx, Y + 0.5 * dx * k2, cosmo_model)\n    k4 = f(x + dx, Y + dx * k3, cosmo_model)\n    return Y + (dx / 6.0) * (k1 + 2.0 * k2 + 2.0 * k3 + k4)\n\ndef integrate(cosmology_params, Y_init, x_init, x_final, controller_type, params):\n    \"\"\"\n    Integrates the ODE system from x_init to x_final using the specified controller.\n    \"\"\"\n    cosmo_model = CosmologyModel(**{k: v for k, v in cosmology_params.items() if k != 'name'})\n    \n    x = x_init\n    Y = np.copy(Y_init)\n    step_count = 0\n\n    while x  x_final:\n        if controller_type == 'fixed':\n            dx = params\n        elif controller_type == 'adaptive':\n            a = np.exp(x)\n            dlnH_val = cosmo_model.dlnH_dlna(a)\n            # Handle the case where dlnH/dlna is zero to avoid division by zero\n            if abs(dlnH_val)  1e-12:\n                dx = params['dx_max']\n            else:\n                dx = min(params['dx_max'], params['eps_H'] / abs(dlnH_val))\n        else:\n            raise ValueError(\"Unknown controller type\")\n\n        # Adjust the last step to land exactly on x_final\n        if x + dx  x_final:\n            dx = x_final - x\n        \n        Y = rk4_step(x, Y, dx, ode_system, cosmo_model)\n        x += dx\n        step_count += 1\n    \n    return Y, step_count\n\n\n# Execute the main function when the script is run\nif __name__ == \"__main__\":\n    solve()\n```"
        }
    ]
}