{"hands_on_practices": [{"introduction": "这个首个练习旨在奠定基础，将单个粒子的坐标与宏观总偶极矩 $\\mathbf{M}$ 联系起来。你将学习处理分子系统周期性边界条件（PBC）的关键技术，这对于定义一个有物理意义的偶极矩至关重要。本练习将指导你对几个简单的快照进行手动计算，从而在进入自动化分析之前巩固你的理解。 [@problem_id:3407722]", "problem": "一个边长为 $L = 2.0 \\ \\mathrm{nm}$ 的立方模拟单元格，在周期性边界条件 (PBC) 下包含两个刚性、中性的双原子分子。每个分子由两个点电荷 $+q$ 和 $-q$ 组成，其中 $q = 0.5 \\, e$，由长度为 $0.20 \\ \\mathrm{nm}$ 的键连接。提供了三个统计独立的快照。在每个快照中，电荷坐标以折叠位置的形式给出，沿每个笛卡尔方向位于区间 $[0,L)$ 内。系统整体呈电中性。温度为 $T = 300 \\ \\mathrm{K}$。使用以下常数：元电荷 $e = 1.602176634 \\times 10^{-19} \\ \\mathrm{C}$，真空介电常数 $\\varepsilon_{0} = 8.8541878128 \\times 10^{-12} \\ \\mathrm{F} \\, \\mathrm{m}^{-1}$，玻尔兹曼常数 $k_{B} = 1.380649 \\times 10^{-23} \\ \\mathrm{J} \\, \\mathrm{K}^{-1}$。在计算偶极矩之前，将所有长度转换为 $\\mathrm{m}$。\n\n快照（坐标单位为 $\\mathrm{nm}$，电荷单位为 $e$）：\n- 快照 1:\n  - 分子 1：$A_{1}$ 位于 $(0.10, \\ 0.10, \\ 0.10)$，带电荷 $+0.5 \\, e$；$B_{1}$ 位于 $(0.30, \\ 0.10, \\ 0.10)$，带电荷 $-0.5 \\, e$。\n  - 分子 2：$A_{2}$ 位于 $(1.90, \\ 1.90, \\ 0.05)$，带电荷 $+0.5 \\, e$；$B_{2}$ 位于 $(0.10, \\ 1.90, \\ 0.05)$，带电荷 $-0.5 \\, e$。\n- 快照 2:\n  - 分子 1：$A_{1}$ 位于 $(0.30, \\ 0.50, \\ 0.70)$，带电荷 $+0.5 \\, e$；$B_{1}$ 位于 $(0.10, \\ 0.50, \\ 0.70)$，带电荷 $-0.5 \\, e$。\n  - 分子 2：$A_{2}$ 位于 $(0.90, \\ 1.90, \\ 1.95)$，带电荷 $+0.5 \\, e$；$B_{2}$ 位于 $(0.90, \\ 0.10, \\ 1.95)$，带电荷 $-0.5 \\, e$。\n- 快照 3:\n  - 分子 1：$A_{1}$ 位于 $(1.90, \\ 0.20, \\ 1.95)$，带电荷 $+0.5 \\, e$；$B_{1}$ 位于 $(0.10, \\ 0.20, \\ 1.95)$，带电荷 $-0.5 \\, e$。\n  - 分子 2：$A_{2}$ 位于 $(0.50, \\ 0.50, \\ 1.90)$，带电荷 $+0.5 \\, e$；$B_{2}$ 位于 $(0.50, \\ 0.50, \\ 0.10)$，带电荷 $-0.5 \\, e$。\n\n任务：\n1. 对于每个快照，使用基于分子的展开规则计算模拟单元格的总偶极矩向量 $\\mathbf{M}$：对于每个双原子分子，选择第二个原子的镜像，使其与成键伙伴的键长最小化（等效地，重构分子，使其键是在周期性边界条件下最短的镜像）。然后计算分子偶极矩为 $\\sum_{i \\in \\mathrm{mol}} q_{i} \\, \\mathbf{r}_{i}$，并对所有分子求和以获得 $\\mathbf{M}$。\n2. 将这三个快照作为一个等权重的系综，计算样本平均值 $\\langle \\mathbf{M} \\rangle$ 和 $\\langle |\\mathbf{M}|^{2} \\rangle$。\n3. 从一个处于均匀、弱、静态电场 $\\mathbf{E}$ 中的系统的正则系综出发，该系统通过 $-\\mathbf{M} \\cdot \\mathbf{E}$ 进行耦合，并引用线性响应和旋转各向同性，推导一个将静态相对介电常数 $\\varepsilon_{r}$ 与零场下总偶极矩 $\\mathbf{M}$ 的平衡涨落联系起来的表达式。\n4. 使用您推导的表达式、给定的常数以及步骤2中的平均值，对该系统的 $\\varepsilon_{r}$ 进行数值计算。将最终的 $\\varepsilon_{r}$ 表示为一个无量纲数，并四舍五入到四位有效数字。\n5. 简要解释使用逐原子的折叠坐标（不进行基于分子的展开）将如何改变计算出的 $\\mathbf{M}$，从而改变步骤4中的结果，并说明哪种定义在物理上适合用于涨落公式。\n\n您最终报告的答案必须是 $\\varepsilon_{r}$ 的单个数值，无量纲，并四舍五入到四位有效数字。", "solution": "该问题要求从一组分子动力学快照中计算一个由两个刚性双原子分子组成的系统的静态相对介电常数 $\\varepsilon_r$。这涉及几个步骤：使用针对周期性边界条件的特定展开规则计算每个快照的总偶极矩，计算偶极矩及其大小平方的系综平均值，推导将 $\\varepsilon_r$ 与偶极矩涨落联系起来的涨落公式，最后对 $\\varepsilon_r$ 进行数值计算。还将讨论偶极矩定义的物理有效性。\n\n首先，为了进行最终计算，将必要的常数和参数转换为国际单位制（SI）单位。\n立方单元格边长：$L = 2.0 \\times 10^{-9} \\ \\mathrm{m}$。\n单元格体积：$V = L^3 = (2.0 \\times 10^{-9} \\ \\mathrm{m})^3 = 8.0 \\times 10^{-27} \\ \\mathrm{m}^3$。\n电荷大小：$q = 0.5 \\, e = 0.5 \\times (1.602176634 \\times 10^{-19} \\ \\mathrm{C}) = 8.01088317 \\times 10^{-20} \\ \\mathrm{C}$。\n温度：$T = 300 \\ \\mathrm{K}$。\n真空介电常数：$\\varepsilon_{0} = 8.8541878128 \\times 10^{-12} \\ \\mathrm{F} \\, \\mathrm{m}^{-1}$。\n玻尔兹曼常数：$k_{B} = 1.380649 \\times 10^{-23} \\ \\mathrm{J} \\, \\mathrm{K}^{-1}$。\n\n为方便起见，偶极矩的计算将以 $e \\cdot \\mathrm{nm}$ 为单位进行，并在最后阶段转换为国际单位制单位。偶极矩平方的转换因子是 $(1 \\ e \\cdot \\mathrm{nm})^2 = ((1.602176634 \\times 10^{-19} \\ \\mathrm{C}) \\times (10^{-9} \\ \\mathrm{m}))^2 = 2.5669699 \\times 10^{-56} \\ (\\mathrm{C} \\cdot \\mathrm{m})^2$。\n\n任务1：计算每个快照的总偶极矩向量 $\\mathbf{M}$。\n一个在 $\\mathbf{r}_{+}$ 处带电荷 $+q$ 和在 $\\mathbf{r}_{-}$ 处带电荷 $-q$ 的双原子分子的偶极矩为 $\\boldsymbol{\\mu} = q(\\mathbf{r}_{+} - \\mathbf{r}_{-})$。向量 $\\mathbf{d} = \\mathbf{r}_{+} - \\mathbf{r}_{-}$ 是键向量，必须使用周期性边界条件（PBC）下的最小镜像约定进行重构。模拟单元格的总偶极矩 $\\mathbf{M}$ 是各个分子偶极矩的向量和，$\\mathbf{M} = \\sum_j \\boldsymbol{\\mu}_j$。我们将电荷 $+q$ 的位置表示为 $\\mathbf{r}_A$，电荷 $-q$ 的位置表示为 $\\mathbf{r}_B$。电荷大小为 $q=0.5 \\, e$。\n\n快照 1:\n分子 1: $\\mathbf{r}_{A1} = (0.10, 0.10, 0.10) \\ \\mathrm{nm}$, $\\mathbf{r}_{B1} = (0.30, 0.10, 0.10) \\ \\mathrm{nm}$。\n键向量 $\\mathbf{d}_1 = \\mathbf{r}_{A1} - \\mathbf{r}_{B1} = (-0.20, 0, 0) \\ \\mathrm{nm}$。该向量的模长为 $0.20 \\ \\mathrm{nm}$，因此无需 PBC 校正。\n$\\boldsymbol{\\mu}_1 = q \\mathbf{d}_1 = 0.5 \\, e \\times (-0.20, 0, 0) \\ \\mathrm{nm} = (-0.10, 0, 0) \\ e \\cdot \\mathrm{nm}$。\n分子 2: $\\mathbf{r}_{A2} = (1.90, 1.90, 0.05) \\ \\mathrm{nm}$, $\\mathbf{r}_{B2} = (0.10, 1.90, 0.05) \\ \\mathrm{nm}$。\n折叠的键向量为 $\\mathbf{r}_{A2} - \\mathbf{r}_{B2} = (1.80, 0, 0) \\ \\mathrm{nm}$。\n为了应用 $L=2.0 \\ \\mathrm{nm}$ 的最小镜像约定，我们从 $x$ 分量中减去 $L$：$1.80 - 2.0 = -0.20$。\n展开的键向量 $\\mathbf{d}_2 = (-0.20, 0, 0) \\ \\mathrm{nm}$。\n$\\boldsymbol{\\mu}_2 = q \\mathbf{d}_2 = 0.5 \\, e \\times (-0.20, 0, 0) \\ \\mathrm{nm} = (-0.10, 0, 0) \\ e \\cdot \\mathrm{nm}$。\n总偶极矩 $\\mathbf{M}_1 = \\boldsymbol{\\mu}_1 + \\boldsymbol{\\mu}_2 = (-0.20, 0, 0) \\ e \\cdot \\mathrm{nm}$。\n$|\\mathbf{M}_1|^2 = (-0.20)^2 = 0.040 \\ (e \\cdot \\mathrm{nm})^2$。\n\n快照 2:\n分子 1: $\\mathbf{r}_{A1} = (0.30, 0.50, 0.70) \\ \\mathrm{nm}$, $\\mathbf{r}_{B1} = (0.10, 0.50, 0.70) \\ \\mathrm{nm}$。\n键向量 $\\mathbf{d}_1 = \\mathbf{r}_{A1} - \\mathbf{r}_{B1} = (0.20, 0, 0) \\ \\mathrm{nm}$。\n$\\boldsymbol{\\mu}_1 = q \\mathbf{d}_1 = 0.5 \\, e \\times (0.20, 0, 0) \\ \\mathrm{nm} = (0.10, 0, 0) \\ e \\cdot \\mathrm{nm}$。\n分子 2: $\\mathbf{r}_{A2} = (0.90, 1.90, 1.95) \\ \\mathrm{nm}$, $\\mathbf{r}_{B2} = (0.90, 0.10, 1.95) \\ \\mathrm{nm}$。\n折叠的键向量为 $\\mathbf{r}_{A2} - \\mathbf{r}_{B2} = (0, 1.80, 0) \\ \\mathrm{nm}$。$y$ 分量的最小镜像是 $1.80 - 2.0 = -0.20$。\n展开的键向量 $\\mathbf{d}_2 = (0, -0.20, 0) \\ \\mathrm{nm}$。\n$\\boldsymbol{\\mu}_2 = q \\mathbf{d}_2 = 0.5 \\, e \\times (0, -0.20, 0) \\ \\mathrm{nm} = (0, -0.10, 0) \\ e \\cdot \\mathrm{nm}$。\n总偶极矩 $\\mathbf{M}_2 = \\boldsymbol{\\mu}_1 + \\boldsymbol{\\mu}_2 = (0.10, -0.10, 0) \\ e \\cdot \\mathrm{nm}$。\n$|\\mathbf{M}_2|^2 = (0.10)^2 + (-0.10)^2 = 0.010 + 0.010 = 0.020 \\ (e \\cdot \\mathrm{nm})^2$。\n\n快照 3:\n分子 1: $\\mathbf{r}_{A1} = (1.90, 0.20, 1.95) \\ \\mathrm{nm}$, $\\mathbf{r}_{B1} = (0.10, 0.20, 1.95) \\ \\mathrm{nm}$。\n折叠的键向量为 $\\mathbf{r}_{A1} - \\mathbf{r}_{B1} = (1.80, 0, 0) \\ \\mathrm{nm}$。$x$ 分量的最小镜像是 $1.80 - 2.0 = -0.20$。\n展开的键向量 $\\mathbf{d}_1 = (-0.20, 0, 0) \\ \\mathrm{nm}$。\n$\\boldsymbol{\\mu}_1 = q \\mathbf{d}_1 = 0.5 \\, e \\times (-0.20, 0, 0) \\ \\mathrm{nm} = (-0.10, 0, 0) \\ e \\cdot \\mathrm{nm}$。\n分子 2: $\\mathbf{r}_{A2} = (0.50, 0.50, 1.90) \\ \\mathrm{nm}$, $\\mathbf{r}_{B2} = (0.50, 0.50, 0.10) \\ \\mathrm{nm}$。\n折叠的键向量为 $\\mathbf{r}_{A2} - \\mathbf{r}_{B2} = (0, 0, 1.80) \\ \\mathrm{nm}$。$z$ 分量的最小镜像是 $1.80 - 2.0 = -0.20$。\n展开的键向量 $\\mathbf{d}_2 = (0, 0, -0.20) \\ \\mathrm{nm}$。\n$\\boldsymbol{\\mu}_2 = q \\mathbf{d}_2 = 0.5 \\, e \\times (0, 0, -0.20) \\ \\mathrm{nm} = (0, 0, -0.10) \\ e \\cdot \\mathrm{nm}$。\n总偶极矩 $\\mathbf{M}_3 = \\boldsymbol{\\mu}_1 + \\boldsymbol{\\mu}_2 = (-0.10, 0, -0.10) \\ e \\cdot \\mathrm{nm}$。\n$|\\mathbf{M}_3|^2 = (-0.10)^2 + (-0.10)^2 = 0.010 + 0.010 = 0.020 \\ (e \\cdot \\mathrm{nm})^2$。\n\n任务2：计算样本平均值 $\\langle \\mathbf{M} \\rangle$ 和 $\\langle |\\mathbf{M}|^2 \\rangle$。\n该系综由3个快照组成，每个快照的权重均为1/3。\n$\\langle \\mathbf{M} \\rangle = \\frac{1}{3} (\\mathbf{M}_1 + \\mathbf{M}_2 + \\mathbf{M}_3) = \\frac{1}{3} ((-0.20, 0, 0) + (0.10, -0.10, 0) + (-0.10, 0, -0.10))$。\n$\\langle \\mathbf{M} \\rangle = \\frac{1}{3} (-0.20 + 0.10 - 0.10, \\, 0 - 0.10 + 0, \\, 0 + 0 - 0.10) = \\frac{1}{3} (-0.20, -0.10, -0.10) \\ e \\cdot \\mathrm{nm}$。\n$|\\langle \\mathbf{M} \\rangle|^2 = \\left( \\frac{-0.20}{3} \\right)^2 + \\left( \\frac{-0.10}{3} \\right)^2 + \\left( \\frac{-0.10}{3} \\right)^2 = \\frac{0.040 + 0.010 + 0.010}{9} = \\frac{0.060}{9} \\ (e \\cdot \\mathrm{nm})^2$。\n$\\langle |\\mathbf{M}|^2 \\rangle = \\frac{1}{3} (|\\mathbf{M}_1|^2 + |\\mathbf{M}_2|^2 + |\\mathbf{M}_3|^2) = \\frac{1}{3} (0.040 + 0.020 + 0.020) = \\frac{0.080}{3} \\ (e \\cdot \\mathrm{nm})^2$。\n\n任务3：推导一个将 $\\varepsilon_r$ 与 $\\mathbf{M}$ 的涨落联系起来的表达式。\n考虑一个哈密顿量为 $H_0$ 的系统，处于一个弱、静态、均匀的电场 $\\mathbf{E}$ 中。相互作用能为 $H_{int} = - \\mathbf{M} \\cdot \\mathbf{E}$。配分函数为 $Z(\\mathbf{E}) = \\int \\exp\\left(-\\frac{H_0 - \\mathbf{M} \\cdot \\mathbf{E}}{k_B T}\\right) d\\Gamma$。总偶极矩的系综平均值为 $\\langle \\mathbf{M} \\rangle_{\\mathbf{E}} = k_B T \\frac{\\partial \\ln Z}{\\partial \\mathbf{E}}$。\n宏观静电学将极化强度 $\\mathbf{P} = (\\langle \\mathbf{M} \\rangle_{\\mathbf{E}} - \\langle \\mathbf{M} \\rangle_0)/V$ 与电场通过 $\\mathbf{P} = \\varepsilon_0 (\\varepsilon_r - 1) \\mathbf{E}$ 联系起来（对于各向同性介质）。\n从线性响应理论中，可以推导出 $\\mathbf{P} = \\frac{1}{V k_B T} (\\langle \\mathbf{M} \\mathbf{M} \\rangle_0 - \\langle \\mathbf{M} \\rangle_0 \\langle \\mathbf{M} \\rangle_0) \\cdot \\mathbf{E}$。\n对于各向同性系统，协方差矩阵是对角的且分量相等，$\\langle M_\\alpha M_\\beta \\rangle_0 - \\langle M_\\alpha \\rangle_0 \\langle M_\\beta \\rangle_0 = \\frac{1}{3}(\\langle |\\mathbf{M}|^2 \\rangle_0 - |\\langle \\mathbf{M} \\rangle_0|^2)\\delta_{\\alpha\\beta}$。\n因此，$\\mathbf{P} = \\frac{1}{3V k_B T}(\\langle |\\mathbf{M}|^2 \\rangle_0 - |\\langle \\mathbf{M} \\rangle_0|^2)\\mathbf{E}$。\n将两个 $\\mathbf{P}$ 的表达式等同起来，我们得到 $\\varepsilon_0 (\\varepsilon_r - 1) = \\frac{1}{3V k_B T}(\\langle |\\mathbf{M}|^2 \\rangle_0 - |\\langle \\mathbf{M} \\rangle_0|^2)$。\n整理后得到所需的涨落公式：\n$$ \\varepsilon_r - 1 = \\frac{\\langle |\\mathbf{M}|^2 \\rangle_0 - |\\langle \\mathbf{M} \\rangle_0|^2}{3 \\varepsilon_0 V k_B T} $$\n这便将介电常数与零场系综中总偶极矩的方差联系起来。\n\n任务4：对该系统的 $\\varepsilon_r$ 进行数值计算。\n我们使用任务2中计算的样本平均值作为真实系综平均值的估计。\n分子中的涨落项为 $\\langle |\\mathbf{M}|^2 \\rangle - |\\langle \\mathbf{M} \\rangle|^2 = \\frac{0.080}{3} - \\frac{0.060}{9} = \\frac{0.240 - 0.060}{9} = \\frac{0.180}{9} = 0.020 \\ (e \\cdot \\mathrm{nm})^2$。\n将其转换为国际单位制单位：\n分子 $= 0.020 \\times (2.5669699 \\times 10^{-56} \\ (\\mathrm{C} \\cdot \\mathrm{m})^2) = 5.1339398 \\times 10^{-58} \\ (\\mathrm{C} \\cdot \\mathrm{m})^2$。\n现在，计算分母 $3 \\varepsilon_0 V k_B T$：\n分母 $= 3 \\times (8.8541878128 \\times 10^{-12} \\ \\mathrm{F} \\, \\mathrm{m}^{-1}) \\times (8.0 \\times 10^{-27} \\ \\mathrm{m}^3) \\times (1.380649 \\times 10^{-23} \\ \\mathrm{J} \\, \\mathrm{K}^{-1}) \\times (300 \\ \\mathrm{K})$。\n分母 $= 8.798917 \\times 10^{-58} \\ \\mathrm{C}^2 \\cdot \\mathrm{m}^2 / \\mathrm{J}$。（注：$F \\cdot J = (C/V) \\cdot (CV) = C^2$，单位匹配）。\n现在，计算 $\\varepsilon_r$：\n$\\varepsilon_r - 1 = \\frac{5.1339398 \\times 10^{-58}}{8.798917 \\times 10^{-58}} = 0.58348...$\n$\\varepsilon_r = 1 + 0.58348... = 1.58348...$\n四舍五入到四位有效数字，$\\varepsilon_r \\approx 1.583$。\n\n任务5：关于使用折叠坐标与展开坐标的解释。\n使用逐原子的折叠坐标 $\\mathbf{r}'_i \\in [0,L)$ 来计算总偶极矩 $\\mathbf{M}_{\\text{wrapped}} = \\sum_i q_i \\mathbf{r}'_i$ 会导致一个物理上不正确的结果。$\\mathbf{M}_{\\text{wrapped}}$ 的值取决于分子在模拟盒子内的绝对位置，而不仅仅是它们的相对取向。对于跨越周期性边界的分子，这个定义会产生任意大的、非物理的偶极矩。例如，在快照1中，分子2靠近 $x=L$ 边界。其两个原子的折叠坐标相距很远，从而在x轴上产生了一个巨大的偶极矩贡献，这是盒子约定的产物。这个量对于周期性系统没有明确定义，因为它是依赖于原点的。\n关于 $\\varepsilon_r$ 的涨落公式旨在捕捉体材料对电场的响应。这种响应是由于分子偶极子的排列引起的。物理上合适的量是各个分子偶极矩的和 $\\mathbf{M} = \\sum_j \\boldsymbol{\\mu}_j$，其中每个 $\\boldsymbol{\\mu}_j$ 都是从展开的键向量计算得出的。这个量 $\\mathbf{M}$ 正确地代表了包含在模拟体积内的材料的总偶极矩，其涨落与分子间的取向相关性有关。使用 $\\mathbf{M}_{\\text{wrapped}}$ 会引入巨大的、虚假的涨落，这些涨落取决于分子跨越盒子的任意移动，从而导致一个被极大高估且不正确的介电常数。因此，基于分子的展开程序对于进行有物理意义的计算至关重要。", "answer": "$$\n\\boxed{1.583}\n$$", "id": "3407722"}, {"introduction": "在上一练习的基础上，本实践将重点揭示一个在模拟中计算偶极矩时常见且关键的陷阱。你将实现并比较周期性边界条件下总偶极矩的不同定义，亲眼见证朴素的方法会如何导致非物理性的结果。这种亲手操作的比较将巩固你对为何基于分子的重构方法是处理极性分子体系的正确途径的理解。 [@problem_id:3407804]", "problem": "考虑一个分子动力学中的三维、立方、周期性模拟盒子，其具有周期性边界条件（PBC）。设盒子边长为 $L$（单位为 $\\mathrm{nm}$）。对于一个由 $N$ 个固定点电荷 $\\{q_i\\}_{i=1}^N$（单位为基本电荷 $e$）组成的系统，其位置为 $\\{\\mathbf{r}_i\\}_{i=1}^N$（单位为 $\\mathrm{nm}$），模拟单元的瞬时总偶极矩矢量定义为电荷加权位置的总和。在 PBC 下，关于如何在偶极子求和中选择位置 $\\mathbf{r}_i$ 存在不同的实用定义；这些定义会影响总偶极子的涨落和计算出的介电常数。你的任务是实现三种在 PBC 下科学合理的总偶极矩定义，并利用它们，通过一种基于平衡统计力学的涨落方法来计算偶极矩大小平方的系综平均值 $ \\langle \\mathbf{M}^2 \\rangle $ 和介电常数 $ \\epsilon $。\n\n您必须从以下基本原理开始：\n- 点电荷的总偶极矩是电荷加权的位置之和。\n- 在周期性边界条件下，位置是根据盒子边长取模定义的。\n- 最小镜像约定通过减去 $L$ 乘以位移与盒子边长之比的最接近整数，将位移沿每个笛卡尔维度映射到区间 $\\left[-\\frac{L}{2}, \\frac{L}{2}\\right)$。\n- 在平衡统计力学（正则系综）中，线性响应理论将总偶极矩的涨落与材料的介电性质联系起来。对于具有传导（锡箔）边界条件的立方晶胞的各向同性情况，它提供了总偶极子方差与静态介电常数之间的特定关系。\n\n您必须实现并比较瞬时总偶极矩 $\\mathbf{M}$（单位为 $\\mathrm{C}\\cdot\\mathrm{m}$）的这三种定义，每种定义都逐帧应用于有限的轨迹：\n1. 基于位点的折叠位置：直接在偶极子求和 $\\sum_i q_i \\mathbf{r}_i$ 中使用折叠后的位置 $\\mathbf{r}_i \\in [0,L)$（单位为 $\\mathrm{nm}$），不进行任何展开。\n2. 分子最小镜像重构：将位点划分为分子，并为每个分子选择一个参考位点 $i_0$。对于同一分子中的每个其他位点 $i$，计算位移 $\\Delta \\mathbf{r}_{i} = \\mathbf{r}_i - \\mathbf{r}_{i_0}$，然后应用分量级最小镜像映射 $\\Delta \\mathbf{r}_{i} \\leftarrow \\Delta \\mathbf{r}_{i} - L \\, \\mathrm{round}(\\Delta \\mathbf{r}_{i}/L)$，重构 $\\tilde{\\mathbf{r}}_{i} = \\mathbf{r}_{i_0} + \\Delta \\mathbf{r}_{i}$，并对分子的贡献求和以获得总 $\\mathbf{M}$。\n3. 全局最小镜像映射：在所有位点中选择一个全局参考位点 $j_0$。对于每个位点 $i$，计算 $\\Delta \\mathbf{r}_i = \\mathbf{r}_i - \\mathbf{r}_{j_0}$，应用 $\\Delta \\mathbf{r}_i \\leftarrow \\Delta \\mathbf{r}_i - L \\, \\mathrm{round}(\\Delta \\mathbf{r}_i/L)$，设置 $\\tilde{\\mathbf{r}}_i = \\mathbf{r}_{j_0} + \\Delta \\mathbf{r}_i$，并在偶极子求和中使用这些全局映射的位置。\n\n对于所有三种方法，使用 $1\\,\\mathrm{nm} = 10^{-9}\\,\\mathrm{m}$ 将位置转换为米，使用 $e = 1.602176634 \\times 10^{-19}\\,\\mathrm{C}$ 将电荷转换为库仑。设玻尔兹曼常数为 $k_\\mathrm{B} = 1.380649 \\times 10^{-23}\\,\\mathrm{J/K}$，真空介电常数为 $\\varepsilon_0 = 8.854187817 \\times 10^{-12}\\,\\mathrm{F/m}$。对于介电涨落关系，假设各向同性和传导（锡箔）边界条件。模拟体积为 $V = (L \\times 10^{-9})^3\\,\\mathrm{m}^3$。每个测试用例的温度为 $T$（单位为 $\\mathrm{K}$）。\n\n对于下面的每个测试用例，您必须：\n- 使用三种定义中的每一种，为每个帧 $t$ 计算瞬时总偶极矢量 $\\mathbf{M}(t)$（单位为 $\\mathrm{C}\\cdot\\mathrm{m}$）。\n- 在所有帧上计算系综平均值 $\\langle \\mathbf{M} \\rangle$ 和 $\\langle \\mathbf{M}^2 \\rangle$，其中 $\\mathbf{M}^2$ 表示大小的平方 $|\\mathbf{M}|^2$。\n- 使用平衡统计力学中适当的基于涨落的关系，从 $ \\langle \\mathbf{M}^2 \\rangle $ 和 $\\langle \\mathbf{M} \\rangle$ 以及常数 $(\\varepsilon_0, V, k_\\mathrm{B}, T)$ 获得介电常数 $ \\epsilon $（无量纲）。\n- 为每种方法报告 $ \\epsilon $（无量纲）和 $ \\langle \\mathbf{M}^2 \\rangle $（单位为 $(\\mathrm{C}\\cdot\\mathrm{m})^2$）。\n\n物理单位：\n- 将 $ \\epsilon $ 报告为无量纲浮点数。\n- 将 $ \\langle \\mathbf{M}^2 \\rangle $ 报告为单位是 $(\\mathrm{C}\\cdot\\mathrm{m})^2$ 的浮点数。\n\n角度单位：不适用。\n\n您的程序必须处理以下测试套件。在所有情况下，位置都被折叠到区间 $[0,L)$ 内并以 $\\mathrm{nm}$ 表示，电荷以 $e$ 为单位表示，温度以 $\\mathrm{K}$ 为单位，盒子是边长为 $L$（单位 $\\mathrm{nm}$）的立方体。\n\n测试用例 1（两个中性双原子分子，无边界穿越；理想路径）：\n- $L = 3.0$。\n- $T = 298.15$。\n- 分子：$\\{(0,1), (2,3)\\}$。\n- 电荷（位点顺序 $[0,1,2,3]$）：$[+0.5, -0.5, +0.5, -0.5]$。\n- 帧（位置，单位 $\\mathrm{nm}$）：\n  - 帧 1：$\\left[(0.5,0.5,0.5),(0.6,0.5,0.5),(1.0,1.5,2.0),(1.0,1.6,2.0)\\right]$。\n  - 帧 2：$\\left[(0.5,0.5,0.5),(0.5,0.6,0.5),(1.0,1.5,2.0),(1.1,1.5,2.0)\\right]$。\n  - 帧 3：$\\left[(0.5,0.5,0.5),(0.5,0.5,0.6),(1.0,1.5,2.0),(0.9,1.5,2.0)\\right]$。\n  - 帧 4：$\\left[(0.5,0.5,0.5),(0.6,0.5,0.5),(1.0,1.5,2.0),(1.0,1.4,2.0)\\right]$。\n\n测试用例 2（两个类水三原子分子，一个沿 $x$ 轴反复穿越边界；测试分子一致性与位点伪影）：\n- $L = 2.0$。\n- $T = 300.0$。\n- 分子：$\\{(0,1,2), (3,4,5)\\}$。\n- 电荷（顺序 $[0,1,2,3,4,5]$）：$[-0.8476, +0.4238, +0.4238, -0.8476, +0.4238, +0.4238]$。\n- 帧（位置，单位 $\\mathrm{nm}$）：\n  - 帧 1：$\\left[(1.95,1.0,1.0),(0.01,1.0,1.0),(1.90,1.08,1.0),(0.5,0.5,0.5),(0.55,0.5,0.58),(0.45,0.58,0.5)\\right]$。\n  - 帧 2：$\\left[(0.05,1.0,1.0),(1.99,1.0,1.0),(0.10,1.08,1.0),(0.5,0.5,0.5),(0.55,0.5,0.58),(0.45,0.58,0.5)\\right]$。\n  - 帧 3：$\\left[(1.90,1.0,1.0),(1.95,1.05,1.0),(1.85,0.95,1.0),(0.5,0.5,0.5),(0.60,0.50,0.55),(0.40,0.55,0.50)\\right]$。\n  - 帧 4：$\\left[(0.10,1.0,1.0),(0.05,1.05,1.0),(0.15,0.95,1.0),(0.5,0.5,0.5),(0.60,0.50,0.55),(0.40,0.55,0.50)\\right]$。\n\n测试用例 3（小盒子，强穿越；强调最小镜像与基于位点方法的对比；两个中性双原子分子）：\n- $L = 1.0$。\n- $T = 300.0$。\n- 分子：$\\{(0,1), (2,3)\\}$。\n- 电荷（顺序 $[0,1,2,3]$）：$[+0.8, -0.8, +0.5, -0.5]$。\n- 帧（位置，单位 $\\mathrm{nm}$）：\n  - 帧 1：$\\left[(0.99,0.5,0.5),(0.19,0.5,0.5),(0.3,0.3,0.3),(0.5,0.3,0.3)\\right]$。\n  - 帧 2：$\\left[(0.01,0.5,0.5),(0.81,0.5,0.5),(0.7,0.7,0.7),(0.9,0.7,0.7)\\right]$。\n  - 帧 3：$\\left[(0.50,0.99,0.5),(0.70,0.99,0.5),(0.1,0.1,0.9),(0.1,0.3,0.9)\\right]$。\n  - 帧 4：$\\left[(0.25,0.25,0.25),(0.45,0.25,0.25),(0.99,0.99,0.99),(0.19,0.99,0.99)\\right]$。\n\n算法要求：\n- 对于每个帧，使用上述三种定义计算 $\\mathbf{M}(t)$。在最小镜像映射中，操作 $\\mathrm{round}(\\cdot)$ 表示逐分量应用到最近整数的函数。\n- 在构成 $\\mathbf{M}(t)$ 之前，将位置转换为米，将电荷转换为库仑。\n- 在所有帧上为每种定义计算 $\\langle \\mathbf{M} \\rangle$ 和 $\\langle \\mathbf{M}^2 \\rangle$。\n- 使用针对各向同性立方晶胞和传导边界条件的平衡统计力学线性响应，从偶极子涨落和常数 $(\\varepsilon_0, V, k_\\mathrm{B}, T)$ 计算无量纲量 $ \\epsilon $。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果。每个测试用例贡献一个列表，顺序为 $[\\epsilon_\\mathrm{mol}, \\epsilon_\\mathrm{site}, \\epsilon_\\mathrm{mi}, \\langle \\mathbf{M}^2 \\rangle_\\mathrm{mol}, \\langle \\mathbf{M}^2 \\rangle_\\mathrm{site}, \\langle \\mathbf{M}^2 \\rangle_\\mathrm{mi}]$。因此，完整输出是包含三个列表的列表，每个测试用例一个，例如 $[[\\dots],[\\dots],[\\dots]]$。", "solution": "该问题要求根据在分子动力学轨迹中观察到的周期性系统的总电偶极矩 $\\mathbf{M}$ 的涨落来计算静态介电常数 $\\epsilon$。这是计算统计力学中的一种标准技术。结果的有效性和准确性关键取决于在周期性边界条件（PBC）下总偶极矩 $\\mathbf{M}$ 的定义。该问题具有坚实的科学基础，内部逻辑一致，并提供了得出唯一解所需的所有数据和定义。\n\n对于在温度 $T$、体积 $V$、传导（“锡箔”）边界条件下的各向同性立方系统，介电常数和偶极子涨落之间的基本关系由线性响应理论给出：\n$$ \\epsilon = 1 + \\frac{\\langle |\\mathbf{M}|^2 \\rangle - |\\langle \\mathbf{M} \\rangle|^2}{3 \\varepsilon_0 V k_\\mathrm{B} T} $$\n此处，$\\langle \\cdot \\rangle$ 表示系综平均，通过对所提供的轨迹帧进行平均来估算。项 $\\langle |\\mathbf{M}|^2 \\rangle - |\\langle \\mathbf{M} \\rangle|^2$ 是总偶极矩矢量的方差。$\\varepsilon_0$ 是真空介电常数，$k_\\mathrm{B}$ 是玻尔兹曼常数。\n\n$\\mathbf{M}$ 的正确计算需要一致的物理单位。给定的位置 $\\mathbf{r}_i$ 以纳米（$\\mathrm{nm}$）为单位，电荷 $q_i$ 以基本电荷（$e$）为单位，盒子长度 $L$ 以 $\\mathrm{nm}$ 为单位。这些都必须转换为国际单位制（SI）：\n- 位置（米，$\\mathrm{m}$）：$\\mathbf{r}_i (\\mathrm{m}) = \\mathbf{r}_i (\\mathrm{nm}) \\times 10^{-9}$\n- 电荷（库仑，$\\mathrm{C}$）：$q_i (\\mathrm{C}) = q_i (e) \\times (1.602176634 \\times 10^{-19})$\n- 体积（立方米，$\\mathrm{m}^3$）：$V (\\mathrm{m}^3) = (L (\\mathrm{nm}) \\times 10^{-9})^3$\n\n瞬时总偶极矩为 $\\mathbf{M}(t) = \\sum_i q_i \\mathbf{r}_i(t)$。挑战在于如何在 PBC 下定义位置矢量 $\\mathbf{r}_i$。问题指定了三种不同且科学上公认的定义，需要实现并进行比较。\n\n最小镜像约定（MIC）是其中两种定义的核心组成部分。对于边长为 $L$ 的立方盒子中的位移矢量 $\\Delta\\mathbf{r}$，MIC 映射返回在 PBC 下与 $\\Delta\\mathbf{r}$ 等效的最短矢量。这是对每个笛卡尔方向 $d \\in \\{x, y, z\\}$ 逐分量计算的：\n$$ \\text{MIC}(\\Delta r_d) = \\Delta r_d - L \\cdot \\mathrm{round}(\\Delta r_d / L) $$\n其中 $\\mathrm{round}(\\cdot)$ 是最近整数函数。结果矢量的分量在范围 $[-\\frac{L}{2}, \\frac{L}{2})$ 内。\n\n总偶极矩 $\\mathbf{M}$ 的三种定义是：\n\n1.  **基于位点的折叠位置 ($\\mathbf{M}_{\\text{site}}$)**: 这是最直接但通常有问题的方法。偶极矩使用给定的“折叠”原子位置 $\\mathbf{r}_i^{\\text{wrap}} \\in [0, L)^3$ 来计算：\n    $$ \\mathbf{M}_{\\text{site}} = \\sum_{i=1}^N q_i \\mathbf{r}_i^{\\text{wrap}} $$\n    如果一个带有分离正负电荷的分子穿过周期性边界，此方法会产生巨大的、不符合物理规律的涨落，因为折叠操作会人为地将分子拆开。\n\n2.  **分子最小镜像重构 ($\\mathbf{M}_{\\text{mol}}$)**: 这种方法保持了分子的完整性。系统中的粒子被划分为中性分子。对于每个分子，选择一个参考原子（例如，其定义中的第一个原子）。该分子内所有其他原子的位置都相对于参考原子使用 MIC 进行重构。\n    - 对于每个分子 $m$，选择一个参考原子 $i_{0,m}$。\n    - 对于分子 $m$ 中的每个原子 $j$，相对于参考原子的位移是 $\\Delta\\mathbf{r}_j = \\mathbf{r}_j^{\\text{wrap}} - \\mathbf{r}_{i_{0,m}}^{\\text{wrap}}$。\n    - 应用 MIC：$\\Delta\\tilde{\\mathbf{r}}_j = \\text{MIC}(\\Delta\\mathbf{r}_j)$。\n    - 重构位置：$\\tilde{\\mathbf{r}}_j = \\mathbf{r}_{i_{0,m}}^{\\text{wrap}} + \\Delta\\tilde{\\mathbf{r}}_j$。\n    总偶极矩是这些重构后分子的偶极矩之和：\n    $$ \\mathbf{M}_{\\text{mol}} = \\sum_{\\text{molecules } m} \\left( \\sum_{j \\in m} q_j \\tilde{\\mathbf{r}}_j \\right) $$\n    由于给定测试用例中的所有分子都是电中性的，因此得到的 $\\mathbf{M}_{\\text{mol}}$ 与参考原子的选择和坐标系的原点无关。对于极性分子流体，这通常是首选方法。\n\n3.  **全局最小镜像映射 ($\\mathbf{M}_{\\text{mi}}$)**: 这种方法构建了所有粒子的单个连续构型。为整个系统选择一个参考原子 $j_0$（例如，原子索引为0的原子）。所有其他原子的位置都相对于这个全局参考进行重构。\n    - 选择一个全局参考原子 $j_0$。\n    - 对于每个原子 $i$，位移是 $\\Delta\\mathbf{r}_i = \\mathbf{r}_i^{\\text{wrap}} - \\mathbf{r}_{j_0}^{\\text{wrap}}$。\n    - 应用 MIC：$\\Delta\\tilde{\\mathbf{r}}_i = \\text{MIC}(\\Delta\\mathbf{r}_i)$。\n    - 重构位置：$\\tilde{\\mathbf{r}}_i = \\mathbf{r}_{j_0}^{\\text{wrap}} + \\Delta\\tilde{\\mathbf{r}}_i$。\n    然后，从这组全局“展开”的坐标计算总偶极矩：\n    $$ \\mathbf{M}_{\\text{mi}} = \\sum_{i=1}^N q_i \\tilde{\\mathbf{r}}_i $$\n    由于所有测试用例中系统的总电荷为零，因此该定义也与原点无关。\n\n计算过程如下：对于每个测试用例，遍历所有帧。在每个帧中，以国际单位制（SI）计算三个偶极矩矢量 $\\mathbf{M}_{\\text{site}}(t)$、$\\mathbf{M}_{\\text{mol}}(t)$ 和 $\\mathbf{M}_{\\text{mi}}(t)$。处理完所有帧后，为三种方法中的每一种计算平均值 $\\langle \\mathbf{M} \\rangle$ 和 $\\langle |\\mathbf{M}|^2 \\rangle$。最后，将这些值代入涨落公式，以获得相应的介电常数 $\\epsilon_{\\text{site}}$、$\\epsilon_{\\text{mol}}$ 和 $\\epsilon_{\\text{mi}}$。最终报告将包括这些 $\\epsilon$ 值和计算出的 $\\langle |\\mathbf{M}|^2 \\rangle$ 值。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the dielectric constant and average squared dipole moment\n    for molecular systems using three different dipole definitions under PBC.\n    \"\"\"\n    # Physical Constants in SI units\n    E_CHARGE = 1.602176634e-19  # Elementary charge in Coulombs\n    KB = 1.380649e-23           # Boltzmann constant in J/K\n    EPS0 = 8.854187817e-12      # Vacuum permittivity in F/m\n    NM_TO_M = 1e-9              # Nanometer to meter conversion\n\n    test_cases = [\n        {\n            \"L\": 3.0,\n            \"T\": 298.15,\n            \"molecules\": [(0, 1), (2, 3)],\n            \"charges\": np.array([+0.5, -0.5, +0.5, -0.5]),\n            \"frames\": [\n                np.array([[0.5, 0.5, 0.5], [0.6, 0.5, 0.5], [1.0, 1.5, 2.0], [1.0, 1.6, 2.0]]),\n                np.array([[0.5, 0.5, 0.5], [0.5, 0.6, 0.5], [1.0, 1.5, 2.0], [1.1, 1.5, 2.0]]),\n                np.array([[0.5, 0.5, 0.5], [0.5, 0.5, 0.6], [1.0, 1.5, 2.0], [0.9, 1.5, 2.0]]),\n                np.array([[0.5, 0.5, 0.5], [0.6, 0.5, 0.5], [1.0, 1.5, 2.0], [1.0, 1.4, 2.0]]),\n            ],\n        },\n        {\n            \"L\": 2.0,\n            \"T\": 300.0,\n            \"molecules\": [(0, 1, 2), (3, 4, 5)],\n            \"charges\": np.array([-0.8476, +0.4238, +0.4238, -0.8476, +0.4238, +0.4238]),\n            \"frames\": [\n                np.array([[1.95, 1.0, 1.0], [0.01, 1.0, 1.0], [1.90, 1.08, 1.0], [0.5, 0.5, 0.5], [0.55, 0.5, 0.58], [0.45, 0.58, 0.5]]),\n                np.array([[0.05, 1.0, 1.0], [1.99, 1.0, 1.0], [0.10, 1.08, 1.0], [0.5, 0.5, 0.5], [0.55, 0.5, 0.58], [0.45, 0.58, 0.5]]),\n                np.array([[1.90, 1.0, 1.0], [1.95, 1.05, 1.0], [1.85, 0.95, 1.0], [0.5, 0.5, 0.5], [0.60, 0.50, 0.55], [0.40, 0.55, 0.50]]),\n                np.array([[0.10, 1.0, 1.0], [0.05, 1.05, 1.0], [0.15, 0.95, 1.0], [0.5, 0.5, 0.5], [0.60, 0.50, 0.55], [0.40, 0.55, 0.50]]),\n            ],\n        },\n        {\n            \"L\": 1.0,\n            \"T\": 300.0,\n            \"molecules\": [(0, 1), (2, 3)],\n            \"charges\": np.array([+0.8, -0.8, +0.5, -0.5]),\n            \"frames\": [\n                np.array([[0.99, 0.5, 0.5], [0.19, 0.5, 0.5], [0.3, 0.3, 0.3], [0.5, 0.3, 0.3]]),\n                np.array([[0.01, 0.5, 0.5], [0.81, 0.5, 0.5], [0.7, 0.7, 0.7], [0.9, 0.7, 0.7]]),\n                np.array([[0.50, 0.99, 0.5], [0.70, 0.99, 0.5], [0.1, 0.1, 0.9], [0.1, 0.3, 0.9]]),\n                np.array([[0.25, 0.25, 0.25], [0.45, 0.25, 0.25], [0.99, 0.99, 0.99], [0.19, 0.99, 0.99]]),\n            ],\n        }\n    ]\n\n    all_results = []\n    \n    for case in test_cases:\n        L = case[\"L\"]\n        T = case[\"T\"]\n        molecules = case[\"molecules\"]\n        charges = case[\"charges\"]\n        frames = case[\"frames\"]\n\n        L_m = L * NM_TO_M\n        V = L_m ** 3\n        charges_coulomb = charges * E_CHARGE\n        \n        m_site_frames = []\n        m_mol_frames = []\n        m_mi_frames = []\n\n        for positions_nm in frames:\n            # ----- Method 1: Site-based wrapped positions -----\n            m_site = np.sum(charges_coulomb[:, np.newaxis] * (positions_nm * NM_TO_M), axis=0)\n            m_site_frames.append(m_site)\n\n            # ----- Method 2: Molecular minimum-image reconstruction -----\n            m_mol = np.zeros(3)\n            for mol_indices in molecules:\n                mol_indices = list(mol_indices)\n                mol_pos = positions_nm[mol_indices]\n                mol_charges_coulomb = charges_coulomb[mol_indices]\n                \n                ref_pos = mol_pos[0]\n                disp = mol_pos - ref_pos\n                disp_mic = disp - L * np.round(disp / L)\n                \n                pos_reconstructed_nm = ref_pos + disp_mic\n                mol_dipole = np.sum(mol_charges_coulomb[:, np.newaxis] * (pos_reconstructed_nm * NM_TO_M), axis=0)\n                m_mol += mol_dipole\n            m_mol_frames.append(m_mol)\n\n            # ----- Method 3: Global minimum-image mapping -----\n            ref_pos_global = positions_nm[0]\n            disp_global = positions_nm - ref_pos_global\n            disp_mic_global = disp_global - L * np.round(disp_global / L)\n            pos_reconstructed_global_nm = ref_pos_global + disp_mic_global\n            m_mi = np.sum(charges_coulomb[:, np.newaxis] * (pos_reconstructed_global_nm * NM_TO_M), axis=0)\n            m_mi_frames.append(m_mi)\n\n        # Process results for the three methods\n        # The required output order is [mol, site, mi]\n        methods_frames = [m_mol_frames, m_site_frames, m_mi_frames]\n        \n        epsilons = []\n        m2_avgs = []\n        \n        denominator = 3.0 * EPS0 * V * KB * T\n\n        for m_frames in methods_frames:\n            m_frames_np = np.array(m_frames)\n            \n            mean_m = np.mean(m_frames_np, axis=0)\n            m_sq = np.sum(m_frames_np**2, axis=1)\n            mean_m_sq = np.mean(m_sq)\n            m_mean_sq = np.sum(mean_m**2)\n            var_m = mean_m_sq - m_mean_sq\n            \n            if denominator > 1e-90:\n                epsilon = 1.0 + var_m / denominator\n            else:\n                epsilon = 1.0\n            \n            epsilons.append(epsilon)\n            m2_avgs.append(mean_m_sq)\n        \n        case_result = [epsilons[0], epsilons[1], epsilons[2], m2_avgs[0], m2_avgs[1], m2_avgs[2]]\n        all_results.append(case_result)\n        \n    print(str(all_results).replace(\"'\", '\"'))\n\nsolve()\n```", "id": "3407804"}, {"introduction": "一个计算值的价值取决于其误差棒的大小。这最后一个练习旨在探讨统计收敛性这一基本主题，它适用于作为分子动力学模拟标志的时间相关数据。你将学习偶极矩的自相关时间如何影响介电常数计算值的不确定性，以及如何使用分块平均法来估计一个可靠的置信区间。 [@problem_id:3407731]", "problem": "您正在使用分子动力学研究一种平衡、各向同性的极性液体，并试图从总偶极矩矢量的涨落中估算静态相对介电常数（也称为介电常数）。您模拟了总偶极矩矢量 $\\mathbf{M}(t) = \\left(M_x(t), M_y(t), M_z(t)\\right)$ 的平稳时间序列，以均匀时间间隔 $\\Delta t$ 采样，共获得 $N$ 个样本。假设以下物理上真实的模型假设始终成立：(i) 分量 $M_x(t)$、$M_y(t)$ 和 $M_z(t)$ 是联合高斯分布、零均值、同分布，并且在相同时刻不相关，每个分量的方差为 $\\sigma_M^2$；(ii) 动力学过程是平稳且混合的；(iii) 每个笛卡尔分量的归一化自相关函数在由积分自相关时间 (IAT) $\\tau_{\\mathrm{int}}$ 捕获的单个主导时间尺度上衰减，其定义为 $\\tau_{\\mathrm{int}} \\equiv \\int_0^\\infty \\rho_M(t) \\, dt$，其中 $\\rho_M(t)$ 是 $M_x(t)$ 的归一化自相关，并且相同的 $\\tau_{\\mathrm{int}}$ 也表征了控制 $Q(t) \\equiv \\|\\mathbf{M}(t)\\|^2$ 相关性的最慢模式。\n\n在国际单位制 (SI) 中进行计算，并假设各向同性，因此待估算的介电常数可以从应用于体积为 $V$、绝对温度为 $T$ 的有限周期性盒子中极化涨落的线性响应和涨落-耗散理论推导得出。真空介电常数为 $\\varepsilon_0$，玻尔兹曼常数为 $k_{\\mathrm{B}}$。\n\n您的任务如下：\n\n1) 从各向同性体系统的相对介电常数根据平衡极化涨落的定义出发，并利用热力学涨落-响应关系，推导出一个用 $Q(t) \\equiv \\|\\mathbf{M}(t)\\|^2$ 的时间平均值、体积 $V$、绝对温度 $T$、真空介电常数 $\\varepsilon_0$ 和玻尔兹曼常数 $k_{\\mathrm{B}}$ 表示的估计量 $\\widehat{\\varepsilon}_r$ 的表达式。然后，利用上述假设，将此表达式简化为仅依赖于各分量方差 $\\sigma_M^2$ 的形式。\n\n2) 在高斯和各向同性假设下，用 $\\sigma_M^2$ 计算瞬时标量可观测量 $Q(t) = \\|\\mathbf{M}(t)\\|^2$ 的方差。\n\n3) 利用积分自相关时间 (IAT) 的定义和相关平稳过程的中心极限定理，在固定总时间 $T_{\\mathrm{tot}} \\equiv N \\Delta t$ 的大 $N$ 极限下，推导从间隔为 $\\Delta t$ 的 $N$ 个样本获得的 $Q(t)$ 时间平均值方差的领头阶表达式。然后，传递此方差以获得 $\\widehat{\\varepsilon}_r$ 的领头阶渐近标准误差。\n\n4) 设计一种分块平均策略，以基于 $Q(t)$ 的 $B$ 个块均值构造 $\\widehat{\\varepsilon}_r$ 的 $95\\%$ 置信区间 (CI)，其中每个块的时长为 $L$，块数为 $B \\equiv \\left\\lfloor T_{\\mathrm{tot}} / L \\right\\rfloor$。施加两个设计约束以确保统计有效性和估计量稳定性：(a) 独立性代理：对于用户指定的乘数 $m$，有 $L \\ge m \\, \\tau_{\\mathrm{int}}$；(b) 最小块数：对于用户指定的最小块数 $B_{\\min}$，有 $B \\ge B_{\\min}$。使用具有 $B-1$ 自由度的学生t分布临界值来近似 $95\\%$ 置信区间半宽 $H(L)$，说明 $H(L)$ 如何依赖于第 2) 和 3) 部分推导出的量，并解释仅通过 t 乘数保留的定性 L 依赖关系。\n\n5) 算法设计：给定 $N$、$ \\Delta t$、$\\tau_{\\mathrm{int}}$、$\\sigma_M^2$、$T$、$V$ 的数值、一个目标半宽 $\\delta_{\\mathrm{target}}$（无量纲，用于相对介电常数）、一个块独立性乘数 $m$ 和一个最小块数 $B_{\\min}$，设计一个算法，该算法：\n- 计算以时间步为单位的最小块长度 $L_{\\mathrm{steps}}^\\star$，它被定义为满足 $L \\ge m \\, \\tau_{\\mathrm{int}}$ 和 $B \\ge B_{\\min}$ 的最小块长（以时间步数表示）。\n- 使用具有 $B-1$ 自由度的学生t分布临界值以及第 2) 和 3) 部分的领头阶方差公式，计算 $\\widehat{\\varepsilon}_r$ 相应的 $95\\%$ 置信区间半宽 $H^\\star$。\n- 声明目标是否达成，即返回一个布尔标志指示 $H^\\star \\le \\delta_{\\mathrm{target}}$。如果没有任何 $L$ 能同时满足这两个约束，则声明对于给定的轨迹和约束，该目标无法实现。\n\n6) 实现：编写一个完整、可运行的程序，实现上述算法，并在以下测试套件上对其进行评估。对于每个测试，程序必须输出一个包含以下内容的项目：\n- 一个布尔值，指示在约束条件下目标半宽是否可以实现，\n- 以时间步为单位的最小块长度 $L_{\\mathrm{steps}}^\\star$（如果无法实现，则使用 $-1$），\n- 计算出的 $95\\%$ 置信区间半宽 $H^\\star$（如果无法实现，则使用 $-1.0$），\n- 模型参数所隐含的点估计值 $\\widehat{\\varepsilon}_r$。\n\n在程序中使用以下国际单位制 (SI) 的物理常数：\n- $k_{\\mathrm{B}} = 1.380649 \\times 10^{-23} \\ \\mathrm{J} \\ \\mathrm{K}^{-1}$，\n- $\\varepsilon_0 = 8.8541878128 \\times 10^{-12} \\ \\mathrm{F} \\ \\mathrm{m}^{-1}$。\n\n对于所有测试，使用相同的体积和温度，以及与类水液体一致的相同分量方差：\n- $V = 2.7 \\times 10^{-26} \\ \\mathrm{m}^3$，\n- $T = 300 \\ \\mathrm{K}$，\n- $\\sigma_M^2 = 3.70 \\times 10^{-56} \\ (\\mathrm{C} \\cdot \\mathrm{m})^2$。\n\n硬编码到程序中的测试套件参数：\n\n- 测试 1 (正常路径，类水，快速去相关):\n  - $N = 100000000$,\n  - $\\Delta t = 2.0 \\times 10^{-15} \\ \\mathrm{s}$,\n  - $\\tau_{\\mathrm{int}} = 5.0 \\times 10^{-12} \\ \\mathrm{s}$,\n  - $\\delta_{\\mathrm{target}} = 0.5$,\n  - $m = 10$,\n  - $B_{\\min} = 20$.\n\n- 测试 2 (对于相同目标，轨迹过短):\n  - $N = 10000000$,\n  - $\\Delta t = 2.0 \\times 10^{-15} \\ \\mathrm{s}$,\n  - $\\tau_{\\mathrm{int}} = 5.0 \\times 10^{-12} \\ \\mathrm{s}$,\n  - $\\delta_{\\mathrm{target}} = 0.5$,\n  - $m = 10$,\n  - $B_{\\min} = 20$.\n\n- 测试 3 (对于相同目标，近乎不相关的采样):\n  - $N = 100000$,\n  - $\\Delta t = 2.0 \\times 10^{-15} \\ \\mathrm{s}$,\n  - $\\tau_{\\mathrm{int}} = 2.0 \\times 10^{-15} \\ \\mathrm{s}$,\n  - $\\delta_{\\mathrm{target}} = 0.3$,\n  - $m = 10$,\n  - $B_{\\min} = 20$.\n\n- 测试 4 (慢去相关，放宽的目标):\n  - $N = 100000000$,\n  - $\\Delta t = 2.0 \\times 10^{-15} \\ \\mathrm{s}$,\n  - $\\tau_{\\mathrm{int}} = 5.0 \\times 10^{-11} \\ \\mathrm{s}$,\n  - $\\delta_{\\mathrm{target}} = 1.5$,\n  - $m = 10$,\n  - $B_{\\min} = 20$.\n\n此问题中不涉及角度单位。所有与介电常数或其不确定度相关的输出都是无量纲的。块长度必须以时间步数报告。\n\n最终输出格式要求：您的程序应生成单行输出，其中包含四个测试的结果，形式为方括号括起来的逗号分隔列表，其中每个测试结果本身就是一个形式为 $[\\text{可实现性}, L_{\\mathrm{steps}}^\\star, H^\\star, \\widehat{\\varepsilon}_r]$ 的列表。布尔值必须打印为字面上的 $True$ 或 $False$，整数必须打印为十进制数字，浮点数必须打印到小数点后恰好六位。例如，包含两个假设结果的输出将如下所示：$[[True,123,0.123456,42.000000],[False,-1,-1.000000,42.000000]]$。", "solution": "我们首先建立基于涨落的相对介电常数估计量，然后量化其在时间相关性下的统计不确定度，最后开发一种提供实用置信区间 (CI) 的分块平均设计。\n\n首先，对于国际单位制 (SI) 中的各向同性体系统，涨落-响应关系将在无外场情况下，静态电极化率与总偶极矩的平衡涨落联系起来。对于体积为 $V$、绝对温度为 $T$ 的立方周期性盒子，各向同性相对介电常数 $\\varepsilon_r$ 可以用偶极矩模平方的平衡矩来表示。令 $Q(t) \\equiv \\|\\mathbf{M}(t)\\|^2 = M_x(t)^2 + M_y(t)^2 + M_z(t)^2$。在各向同性和平稳性条件下，平衡系综平均遵循\n$$\n\\varepsilon_r \\;=\\; 1 \\;+\\; \\frac{\\langle Q \\rangle - \\|\\langle \\mathbf{M} \\rangle\\|^2}{3 \\, \\varepsilon_0 \\, V \\, k_{\\mathrm{B}} \\, T} \\, .\n$$\n对于零均值平稳液体，$\\langle \\mathbf{M} \\rangle = \\mathbf{0}$，因此通过用长轨迹上的时间平均代替系综平均所获得的估计量为\n$$\n\\widehat{\\varepsilon}_r \\;=\\; 1 \\;+\\; \\frac{\\overline{Q}}{3 \\, \\varepsilon_0 \\, V \\, k_{\\mathrm{B}} \\, T} \\, ,\n$$\n其中 $\\overline{Q}$ 是 $Q(t)$ 的时间平均值。在零均值的各向同性高斯假设下，每个分量的方差为 $\\sigma_M^2 = \\langle M_x^2 \\rangle = \\langle M_y^2 \\rangle = \\langle M_z^2 \\rangle$，因此\n$$\n\\langle Q \\rangle \\;=\\; \\langle M_x^2 + M_y^2 + M_z^2 \\rangle \\;=\\; 3 \\, \\sigma_M^2 \\, .\n$$\n因此点估计简化为\n$$\n\\widehat{\\varepsilon}_r \\;=\\; 1 \\;+\\; \\frac{\\sigma_M^2}{\\varepsilon_0 \\, V \\, k_{\\mathrm{B}} \\, T} \\, .\n$$\n\n其次，我们在高斯各向同性模型下计算 $Q$ 的瞬时方差。如果 $X \\sim \\mathcal{N}(0,\\sigma^2)$，那么 $X^2$ 的均值为 $\\sigma^2$，方差为 $2 \\sigma^4$。对于具有共同方差 $\\sigma_M^2$ 的独立分量 $M_x$、$M_y$、$M_z$，有\n$$\nQ \\;=\\; M_x^2 + M_y^2 + M_z^2 \\, ,\n$$\n与\n$$\n\\mathbb{E}[Q] \\;=\\; 3 \\, \\sigma_M^2 \\, , \\qquad \\mathrm{Var}(Q) \\;=\\; \\mathrm{Var}(M_x^2) + \\mathrm{Var}(M_y^2) + \\mathrm{Var}(M_z^2) \\;=\\; 3 \\cdot 2 \\, \\sigma_M^4 \\;=\\; 6 \\, \\sigma_M^4 \\, .\n$$\n\n第三，我们量化相关采样的统计不确定度。设 $Q(t)$ 是平稳的，其自协方差为 $C_Q(\\tau)$，归一化自相关为 $\\rho_Q(\\tau) = C_Q(\\tau)/C_Q(0)$。在标准混合条件下，总时间 $T_{\\mathrm{tot}} = N \\Delta t$ 上的时间平均值 $\\overline{Q}$ 的方差具有以下领头阶形式\n$$\n\\mathrm{Var}(\\overline{Q}) \\;\\approx\\; \\frac{\\mathrm{Var}(Q)}{T_{\\mathrm{tot}}} \\, 2 \\, \\tau_{\\mathrm{int}} \\, ,\n$$\n其中 $\\tau_{\\mathrm{int}} = \\int_0^\\infty \\rho_Q(\\tau) \\, d\\tau$ 是 $Q$ 的积分自相关时间 (IAT)。根据假设，控制 $Q$ 去相关的最慢模式由与 $M_x$ 相同的 $\\tau_{\\mathrm{int}}$ 捕获，因此我们使用相同的符号。通过 $\\widehat{\\varepsilon}_r$ 的线性估计量传递此不确定度，得到\n$$\n\\mathrm{Var}(\\widehat{\\varepsilon}_r) \\;\\approx\\; \\frac{\\mathrm{Var}(\\overline{Q})}{\\left(3 \\, \\varepsilon_0 \\, V \\, k_{\\mathrm{B}} \\, T\\right)^2}\n\\;=\\; \\frac{2 \\, \\tau_{\\mathrm{int}}}{T_{\\mathrm{tot}}} \\cdot \\frac{\\mathrm{Var}(Q)}{\\left(3 \\, \\varepsilon_0 \\, V \\, k_{\\mathrm{B}} \\, T\\right)^2} \\, .\n$$\n使用 $\\mathrm{Var}(Q) = 6 \\, \\sigma_M^4$，渐近标准误差为\n$$\n\\mathrm{SE}_\\infty(\\widehat{\\varepsilon}_r) \\;\\approx\\; \\frac{\\sqrt{6 \\, \\sigma_M^4 \\cdot 2 \\, \\tau_{\\mathrm{int}} / T_{\\mathrm{tot}}}}{3 \\, \\varepsilon_0 \\, V \\, k_{\\mathrm{B}} \\, T} \\, .\n$$\n\n第四，我们构造一个分块平均置信区间 (CI)。将轨迹划分为 $B = \\left\\lfloor T_{\\mathrm{tot}}/L \\right\\rfloor$ 个时长为 $L$ 的不重叠块。设 $\\overline{Q}^{(b)}$ 为块 $b$ 内 $Q$ 的均值。如果 $L \\gg \\tau_{\\mathrm{int}}$，则块均值近似独立同分布，且\n$$\n\\mathrm{Var}\\!\\left(\\overline{Q}^{(b)}\\right) \\;\\approx\\; \\frac{2 \\, \\tau_{\\mathrm{int}}}{L} \\, \\mathrm{Var}(Q) \\, .\n$$\n块均值的总均值等于全轨迹均值 $\\overline{Q}$，其方差为\n$$\n\\mathrm{Var}(\\overline{Q}) \\;\\approx\\; \\frac{1}{B} \\, \\mathrm{Var}\\!\\left(\\overline{Q}^{(b)}\\right) \\;\\approx\\; \\frac{2 \\, \\tau_{\\mathrm{int}}}{L B} \\, \\mathrm{Var}(Q) \\;=\\; \\frac{2 \\, \\tau_{\\mathrm{int}}}{T_{\\mathrm{tot}}} \\, \\mathrm{Var}(Q) \\, ,\n$$\n这与大样本公式一致，表明在使用有限数量的块时，置信区间半宽的残余 L 依赖性仅通过学生t分布乘数进入。具体来说，如果 $\\widehat{s}_{\\mathrm{blk}}^2$ 是 $B$ 个块均值的样本方差，而 $t_{0.975,\\nu}$ 是具有 $\\nu = B-1$ 自由度的学生t分布的 $0.975$ 分位数，那么 $\\overline{Q}$ 的 $95\\%$ 置信区间半宽近似为\n$$\nH_Q(L) \\;\\approx\\; t_{0.975,B-1} \\, \\sqrt{\\frac{\\widehat{s}_{\\mathrm{blk}}^2}{B}} \\;\\approx\\; t_{0.975,B-1} \\, \\sqrt{\\frac{2 \\, \\tau_{\\mathrm{int}}}{T_{\\mathrm{tot}}} \\, \\mathrm{Var}(Q)} \\, .\n$$\n传递到 $\\widehat{\\varepsilon}_r$ 得到\n$$\nH(L) \\;\\approx\\; \\frac{t_{0.975,B-1}}{3 \\, \\varepsilon_0 \\, V \\, k_{\\mathrm{B}} \\, T} \\, \\sqrt{\\frac{2 \\, \\tau_{\\mathrm{int}}}{T_{\\mathrm{tot}}} \\, \\mathrm{Var}(Q)} \\;=\\; \\frac{t_{0.975,B-1}}{3 \\, \\varepsilon_0 \\, V \\, k_{\\mathrm{B}} \\, T} \\, \\sqrt{\\frac{2 \\, \\tau_{\\mathrm{int}}}{T_{\\mathrm{tot}}} \\cdot 6 \\, \\sigma_M^4} \\, .\n$$\n因此，主要的 L 依赖性完全通过 $t_{0.975,B-1}$ 体现，该值随着 $B$ 的减小而温和增长，而核心方差则与 $T_{\\mathrm{tot}}$ 和 $\\tau_{\\mathrm{int}}$ 成比例。\n\n第五，我们设计算法以在约束条件下实现目标置信区间半宽。设 $T_{\\mathrm{tot}} = N \\Delta t$。通过要求 $L \\ge m \\, \\tau_{\\mathrm{int}}$ 来强制执行独立性代理；在满足此条件的 $L$ 中，优先选择最小的以最大化块数。同时要求最小块数 $B \\ge B_{\\min}$ 以进行稳定的方差估计。定义以时间步为单位的最小允许块大小为\n$$\nL_{\\mathrm{steps}}^\\star \\;=\\; \\left\\lceil \\frac{m \\, \\tau_{\\mathrm{int}}}{\\Delta t} \\right\\rceil \\, .\n$$\n计算 $B = \\left\\lfloor \\frac{N}{L_{\\mathrm{steps}}^\\star} \\right\\rfloor$。如果 $B  B_{\\min}$，则没有块大小能同时满足这两个约束，因为进一步增加 $L$ 只会减少 $B$。在这种情况下，声明目标无法实现。否则，在 $B \\ge B_{\\min}$ 的情况下，计算 $t_{0.975,B-1}$ 并评估\n$$\nH^\\star \\;=\\; \\frac{t_{0.975,B-1}}{3 \\, \\varepsilon_0 \\, V \\, k_{\\mathrm{B}} \\, T} \\, \\sqrt{\\frac{2 \\, \\tau_{\\mathrm{int}}}{T_{\\mathrm{tot}}} \\cdot 6 \\, \\sigma_M^4} \\, .\n$$\n将 $H^\\star$ 与目标 $\\delta_{\\mathrm{target}}$ 进行比较；如果 $H^\\star \\le \\delta_{\\mathrm{target}}$，则声明可实现。否则，注意到增加 $L$ 只会减少 $B$ 并增加 $t_{0.975,B-1}$，因此半宽不会减小；因此，在给定的 $T_{\\mathrm{tot}}$ 和约束条件下，目标无法实现。\n\n最后，我们实现该程序。对于每个测试，我们计算 $\\widehat{\\varepsilon}_r = 1 + \\sigma_M^2 / (\\varepsilon_0 V k_{\\mathrm{B}} T)$，然后计算最小允许的 $L_{\\mathrm{steps}}^\\star$、相应的 $B$，以及半宽 $H^\\star$ 或不可实现的占位符。输出为单行：一个包含四个项目（每个测试一个）的列表，每个项目本身是形式为 $[\\text{可实现性}, L_{\\mathrm{steps}}^\\star, H^\\star, \\widehat{\\varepsilon}_r]$ 的列表，其中浮点数打印到小数点后恰好六位，块长度（以步数计）为整数。\n\n定性地，结果将表明：\n- 对于固定的 $T_{\\mathrm{tot}}$，较大的 $\\tau_{\\mathrm{int}}$ 会使 CI 膨胀 $\\sqrt{\\tau_{\\mathrm{int}}}$ 因子。\n- 对于固定的 $\\tau_{\\mathrm{int}}$，增加 $T_{\\mathrm{tot}}$ 会使 CI 按 $1/\\sqrt{T_{\\mathrm{tot}}}$ 的比例收缩。\n- 块大小主要影响有限样本的t乘数；选择最小允许块大小可以在独立性代理约束下最大化 $B$ 并最小化半宽。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import t as student_t\n\ndef compute_eps_hat(sigma_M2, eps0, V, kB, T):\n    # epsilon_r = 1 + sigma_M^2 / (eps0 * V * kB * T)\n    return 1.0 + (sigma_M2 / (eps0 * V * kB * T))\n\ndef compute_var_Q(sigma_M2):\n    # Var(Q) = 6 * sigma_M^4 for Gaussian, isotropic, zero-mean components\n    return 6.0 * (sigma_M2 ** 2)\n\ndef minimal_block_steps(tau_int, dt, m_factor):\n    # Minimal block size in steps to satisfy L >= m * tau_int\n    return int(np.ceil((m_factor * tau_int) / dt))\n\ndef compute_ci_half_width(var_Q, tau_int, N, dt, eps0, V, kB, T, B):\n    # T_total\n    T_total = N * dt\n    # Student-t critical value for 95% two-sided CI: use 0.975 quantile\n    df = max(B - 1, 1)\n    tcrit = student_t.ppf(0.975, df)\n    # Half-width for epsilon_r estimator\n    # H = tcrit / (3 eps0 V kB T) * sqrt( (2 tau_int / T_total) * var_Q )\n    denom = 3.0 * eps0 * V * kB * T\n    base = (2.0 * tau_int / T_total) * var_Q\n    base = max(base, 0.0)\n    return float(tcrit * np.sqrt(base) / denom)\n\ndef format_float(x):\n    return f\"{x:.6f}\"\n\ndef solve():\n    # Physical constants (SI)\n    kB = 1.380649e-23          # J/K\n    eps0 = 8.8541878128e-12    # F/m\n\n    # Shared system parameters\n    V = 2.7e-26                # m^3\n    T = 300.0                  # K\n    sigma_M2 = 3.70e-56        # (C m)^2 per component variance\n\n    # Test cases: (N, dt, tau_int, delta_target, m, B_min)\n    test_cases = [\n        (100_000_000, 2.0e-15, 5.0e-12, 0.5, 10.0, 20),      # Test 1\n        (10_000_000,  2.0e-15, 5.0e-12, 0.5, 10.0, 20),      # Test 2\n        (100_000,     2.0e-15, 2.0e-15, 0.3, 10.0, 20),      # Test 3\n        (100_000_000, 2.0e-15, 5.0e-11, 1.5, 10.0, 20),      # Test 4\n    ]\n\n    results = []\n    var_Q = compute_var_Q(sigma_M2)\n    eps_hat = compute_eps_hat(sigma_M2, eps0, V, kB, T)\n\n    for N, dt, tau_int, delta_target, m_factor, B_min in test_cases:\n        L_steps_star = minimal_block_steps(tau_int, dt, m_factor)\n        # Number of blocks with minimal admissible block size\n        B = N // L_steps_star if L_steps_star  0 else 0\n\n        if B  B_min or L_steps_star == 0:\n            achievable = False\n            L_out = -1\n            H_star = -1.0\n        else:\n            H_star = compute_ci_half_width(var_Q, tau_int, N, dt, eps0, V, kB, T, B)\n            achievable = H_star = delta_target\n            L_out = L_steps_star\n\n        # Append result as [boolean, int, float, float] with specific formatting to 6 decimals\n        # Booleans must be printed as True/False; integers as base-10; floats with 6 decimals.\n        results.append([achievable, L_out, float(format_float(H_star)) if H_star = 0.0 else -1.0,\n                        float(format_float(eps_hat))])\n\n    # Build the output string with required formatting exactly\n    # We need floats with exactly six decimals inside the list representation.\n    out_items = []\n    for item in results:\n        achievable, L_out, H_star, eps_hat_val = item\n        # Reformat H_star and eps_hat_val to ensure six decimals\n        if H_star = 0.0:\n            H_str = format_float(H_star)\n        else:\n            H_str = format_float(H_star)  # will print -1.000000\n        eps_str = format_float(eps_hat_val)\n        out_items.append(f\"[{str(achievable)},{L_out},{H_str},{eps_str}]\")\n\n    print(f\"[{','.join(out_items)}]\")\n\nsolve()\n```", "id": "3407731"}]}