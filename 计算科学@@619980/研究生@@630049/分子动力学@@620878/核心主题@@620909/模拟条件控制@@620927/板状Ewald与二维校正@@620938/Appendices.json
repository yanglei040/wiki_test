{"hands_on_practices": [{"introduction": "当使用标准三维周期性方法模拟平板几何结构时，会引入不符合物理实际的人工影响。第一个动手实践将通过推导一个模型系统的精确二维静电能，并将其与修正项进行比较，来探讨最常见的一种修正方法。这项练习将帮助你从根本上理解该修正项所近似的对象，以及其精度如何依赖于系统几何构型。[@problem_id:3446607]", "problem": "您的任务是为一个中性的平面“偶极片”系统构建一个计算模型，该系统由交替带电的平面组成，嵌入一个矩形盒子中，在横向施加周期性边界条件，在法向施加真空填充。目标是定量地比较片状结构精确的二维静电能与用于消除伪三维耦合的平板 Ewald 校正项，并基准测试其对总偶极矩 $M_z$ 和盒子长度 $L_z$ 的依赖性。\n\n假设以下物理和数学设定：\n\n- 盒子尺寸为 $L_x$、$L_y$ 和 $L_z$，面积为 $A = L_x L_y$。\n- 有 $N$ 个平行于 $xy$ 平面的无限大平面，位于位置 $z_i$，具有均匀的表面电荷密度 $\\sigma_i$，其中 $i = 1,2,\\dots,N$，且 $0 \\le z_1  z_2  \\dots  z_N \\le L_z$。\n- 系统是严格电中性的，即 $\\sum_{i=1}^{N} \\sigma_i = 0$。\n- 使用无量纲高斯单位制，库仑常数设为1，因此单个无限大平面的电场为 $E = 2\\pi \\sigma$，静电能量密度为 $u = E^2/(8\\pi)$。\n- 沿 $z$ 方向的总偶极矩为 $M_z = \\sum_{i=1}^{N} Q_i z_i$，其中 $Q_i = \\sigma_i A$。\n- 在 $x$ 和 $y$ 方向应用周期性边界条件 (PBC)，在 $z$ 方向根据二维平板几何形状设置真空填充。\n\n从基本定律和定义出发，您的任务是：\n\n1. 通过对盒子厚度积分能量密度 $u = E^2/(8\\pi)$，推导二维平板几何的精确总静电能 $U_{\\text{exact}}$。用平面间的累积电荷来表示结果。具体来说，如果 $S_k = \\sum_{i=1}^{k} \\sigma_i$ 是截至平面 $k$ 的累积表面电荷密度，且 $\\Delta z_k = z_{k+1} - z_k$ 对于 $k = 1, \\dots, N-1$，那么推导出精确总能量为\n   $$U_{\\text{exact}} = 2\\pi A \\sum_{k=1}^{N-1} S_k^2 \\Delta z_k.$$\n   推导必须从场的叠加原理和能量密度公式开始，不使用任何快捷公式。\n\n2. 陈述并使用将传统三维 Ewald 求和能量转换为二维平板极限的平板 Ewald 校正项。Ewald Summation 是在三维周期性边界条件下计算的，平板校正项消除了沿 $z$ 方向周期性镜像之间的伪相互作用。对于一个中性系统，平板 Ewald 校正（Yeh–Berkowitz 风格）为平板几何添加了依赖于形状的 $k \\to 0$ 项：\n   $$U_{\\text{corr}} = \\frac{2\\pi}{V} M_z^2,$$\n   其中 $V = A L_z$ 且 $M_z = \\sum_{i=1}^{N} Q_i z_i$。\n\n3. 实现一个程序，为每个测试用例计算：\n   - 根据任务1中的表达式计算精确总能量 $U_{\\text{exact}}$。\n   - 根据任务2中的表达式计算平板校正项 $U_{\\text{corr}}$。\n   - 计算比率\n     $$R = \\frac{U_{\\text{corr}}}{U_{\\text{exact}}},$$\n     此比率为无量纲。在所选的单位制中，所有能量都是无量纲的。\n\n4. 使用以下测试套件。每个测试用例指定了面积 $A$、盒子长度 $L_z$、平面位置列表 $z_i$（在区间 $[0,L_z]$ 内）以及相应的表面电荷密度 $\\sigma_i$（符号交替，净电荷为零）。所有量均为无量纲。\n\n   - 测试用例1（双平面偶极子，“顺利路径”）：\n     - $A = 10.0$\n     - $L_z = 20.0$\n     - $z = [9.25, 10.75]$\n     - $\\sigma = [0.2, -0.2]$\n   - 测试用例2（总偶极矩为零的三平面，$M_z = 0$）：\n     - $A = 25.0$\n     - $L_z = 10.0$\n     - $z = [3.0, 5.0, 7.0]$\n     - $\\sigma = [0.1, -0.2, 0.1]$\n   - 测试用例3（边界情况：间距等于盒子长度，对于双平面偶极子，比率接近1）：\n     - $A = 10.0$\n     - $L_z = 4.0$\n     - $z = [0.0, 4.0]$\n     - $\\sigma = [1.0, -1.0]$\n   - 测试用例4（具有非平凡累积和的四个交替平面）：\n     - $A = 10.0$\n     - $L_z = 50.0$\n     - $z = [23.5, 24.5, 25.5, 26.5]$\n     - $\\sigma = [0.3, -0.3, 0.3, -0.3]$\n   - 测试用例5（边缘情况：非常大的 $L_z$ 导致极小的校正）：\n     - $A = 10.0$\n     - $L_z = 10^6$\n     - $z = [499998.5, 500001.5]$\n     - $\\sigma = [0.4, -0.4]$\n\n5. 您的程序应生成单行输出，其中包含所有测试用例的比率 $R$，格式为用方括号括起来的逗号分隔列表。为保证数值稳定性和可比性，将每个比率格式化为小数点后十位的小数。最终输出必须精确如下所示：\n   $$[R_1,R_2,R_3,R_4,R_5],$$\n   其中每个 $R_i$ 是一个渲染为小数点后十位的浮点数。\n\n不需要外部输入，也不应读取或写入任何外部文件。所有计算量均以上述定义的无量纲单位表示。不涉及角度。所有答案均为实数。在计算能量之前，通过检查电中性 $\\sum_{i=1}^{N} \\sigma_i = 0$ 来确保科学真实性；如果违反此条件，程序应针对该测试用例引发错误，而不是产生结果。", "solution": "我们从第一性原理出发构建解决方案，从经典电磁学在高斯单位制中的叠加原理和能量密度定义开始，然后连接到分子动力学模拟中用于二维平板几何的平板 Ewald 校正。\n\n首先，考虑 $N$ 个平行于 $xy$ 平面的无限大、均匀带电的平面，它们位于位置 $z_1  z_2  \\dots  z_N$，表面电荷密度分别为 $\\sigma_1, \\dots, \\sigma_N$。系统是电中性的，即 $\\sum_{i=1}^N \\sigma_i = 0$，这确保了最外层平面之外的电场渐近消失，这与沿 z 方向嵌入真空中的平板系统相符。\n\n根据叠加原理，由单个表面电荷密度为 $\\sigma_i$ 的平面产生的电场为 $\\mathbf{E}_i(z) = 2\\pi \\sigma_i \\,\\mathrm{sgn}(z - z_i)\\,\\hat{\\mathbf{z}}$，其中 $\\mathrm{sgn}$ 是符号函数。总电场是它们的和：\n$$\n\\mathbf{E}(z) = \\sum_{i=1}^N \\mathbf{E}_i(z) = 2\\pi \\left( \\sum_{i=1}^N \\sigma_i\\, \\mathrm{sgn}(z - z_i) \\right) \\hat{\\mathbf{z}}.\n$$\n因为 $\\mathrm{sgn}(z - z_i)$ 在平面之间是分段常数，所以总电场沿 $z$ 方向也是分段常数。具体来说，在区间 $(z_k, z_{k+1})$ 中（对于 $k = 1,2,\\dots,N-1$），所有索引 $i \\le k$ 的平面贡献 $+\\sigma_i$，所有 $i  k$ 的平面贡献 $-\\sigma_i$，因此总和简化为：\n$$\n\\sum_{i=1}^N \\sigma_i\\, \\mathrm{sgn}(z - z_i) = \\sum_{i=1}^k \\sigma_i - \\sum_{i=k+1}^N \\sigma_i = \\sum_{i=1}^k \\sigma_i - \\left( \\sum_{i=1}^N \\sigma_i - \\sum_{i=1}^k \\sigma_i \\right) = 2 \\sum_{i=1}^k \\sigma_i,\n$$\n这里使用了电中性条件 $\\sum_{i=1}^N \\sigma_i = 0$。定义累积和 $S_k = \\sum_{i=1}^k \\sigma_i$。那么在区间 $(z_k, z_{k+1})$ 内，场强大小为\n$$\nE_k = |\\mathbf{E}(z)| = 2\\pi \\cdot 2 S_k = 4\\pi S_k,\n$$\n方向沿 $\\hat{\\mathbf{z}}$ 或 $-\\hat{\\mathbf{z}}$，取决于 $S_k$ 的符号。在高斯单位制中，能量密度为 $u = E^2/(8\\pi)$。因此，在厚度为 $\\Delta z_k = z_{k+1} - z_k$ 的区间 $k$ 中，单位面积的能量为：\n$$\n\\frac{U_k}{A} = \\int_{z_k}^{z_{k+1}} \\frac{E_k^2}{8\\pi} \\, dz = \\frac{(4\\pi S_k)^2}{8\\pi} \\Delta z_k = 2\\pi S_k^2 \\Delta z_k.\n$$\n对所有区间求和，单位面积的总能量为：\n$$\n\\frac{U_{\\text{exact}}}{A} = \\sum_{k=1}^{N-1} \\frac{U_k}{A} = 2\\pi \\sum_{k=1}^{N-1} S_k^2 \\Delta z_k.\n$$\n乘以面积便得到精确的总能量：\n$$\nU_{\\text{exact}} = 2\\pi A \\sum_{k=1}^{N-1} S_k^2 \\Delta z_k.\n$$\n此推导完全基于叠加原理和能量密度的定义，既不需要启发式捷径，也不需要未指明的公式。\n\n接下来，我们考虑在分子动力学中用于通过三维 Ewald Summation 建模的二维平板系统的平板 Ewald 校正。Ewald Summation 计算三维周期性边界条件下的静电能；然而，对于一个平板（在 $z$ 方向有真空填充），由于库仑势的长程性质，沿 $z$ 方向的周期性镜像之间存在伪相互作用。对二维平板极限的校正根据依赖于形状的退极化张量修改了 $k \\to 0$ 项。对于平板几何，只有沿 $z$ 的分量有贡献，校正能为：\n$$\nU_{\\text{corr}} = \\frac{2\\pi}{V} M_z^2,\n$$\n其中 $V = A L_z$ 是盒子体积，$M_z = \\sum_{i=1}^{N} Q_i z_i$ 是沿 $z$ 方向的总偶极矩，其中 $Q_i = \\sigma_i A$。此结果源于倒易空间 Ewald 项的长波极限；平板的形状因子为 $zz$ 分量提供单位贡献，而横向分量则消失。\n\n为了基准测试对 $M_z$ 和 $L_z$ 的依赖性，计算比率：\n$$\nR = \\frac{U_{\\text{corr}}}{U_{\\text{exact}}} = \\frac{ \\frac{2\\pi}{A L_z} \\left( \\sum_{i=1}^N Q_i z_i \\right)^2 }{ 2\\pi A \\sum_{k=1}^{N-1} S_k^2 \\Delta z_k } = \\frac{ \\left( \\sum_{i=1}^N \\sigma_i z_i \\right)^2 }{ L_z \\sum_{k=1}^{N-1} S_k^2 \\Delta z_k },\n$$\n此比率是无量纲的，且与面积 $A$ 无关，这对于给定几何形状的形状校正比较来说是符合预期的。\n\n程序的算法设计：\n- 对每个测试用例，验证电中性 $\\sum_i \\sigma_i = 0$。\n- 按 $z_i$ 对平面排序以形成区间，计算累积和 $S_k$，并通过 $U_{\\text{exact}} = 2\\pi A \\sum_{k=1}^{N-1} S_k^2 \\Delta z_k$ 评估 $U_{\\text{exact}}$。\n- 计算 $M_z = \\sum_i Q_i z_i = A \\sum_i \\sigma_i z_i$ 和 $U_{\\text{corr}} = \\frac{2\\pi}{A L_z} (A \\sum_i \\sigma_i z_i)^2 = \\frac{2\\pi A}{L_z} \\left( \\sum_i \\sigma_i z_i \\right)^2$。\n- 计算比率 $R$ 并将输出格式化为小数点后十位。\n- 测试套件涵盖：一个标准的双平面偶极子、一个 $M_z=0$ 导致 $U_{\\text{corr}}=0$ 的配置、一个间距等于 $L_z$ 的边界情况（对于双平面偶极子，比率接近1）、一个具有非平凡累积和的多平面交替配置，以及一个具有非常大 $L_z$ 导致极小校正的情况。\n\n此解决方案以一种有原则的方式将经典场论与平板 Ewald 校正相结合，从而能够对平面带电片状结构的 $M_z$ 和 $L_z$ 依赖性进行稳健的基准测试。", "answer": "```python\nimport numpy as np\n\ndef exact_energy_total(area, Lz, z_positions, sigmas):\n    \"\"\"\n    Compute the exact total electrostatic energy for a neutral set of infinite planes\n    in Gaussian units for 2D slab geometry:\n        U_exact = 2*pi*A * sum_{k=1}^{N-1} S_k^2 * (z_{k+1} - z_k)\n    where S_k is the cumulative sum of sigmas up to plane k after sorting by z.\n    \"\"\"\n    z = np.array(z_positions, dtype=float)\n    sigma = np.array(sigmas, dtype=float)\n    # Check neutrality\n    total_sigma = np.sum(sigma)\n    if abs(total_sigma)  1e-12:\n        raise ValueError(\"System is not neutral: sum(sigma) != 0\")\n    # Sort by z\n    order = np.argsort(z)\n    z_sorted = z[order]\n    sigma_sorted = sigma[order]\n    # Cumulative sums S_k for k=1..N-1\n    S = np.cumsum(sigma_sorted)[:-1]  # exclude last cumulative sum\n    # Intervals between planes\n    dz = np.diff(z_sorted)\n    if np.any(dz  0):\n        raise ValueError(\"Positions must be sorted in non-decreasing order.\")\n    # Compute exact energy\n    U_exact = 2.0 * np.pi * area * np.sum((S ** 2) * dz)\n    return U_exact\n\ndef slab_ewald_correction(area, Lz, z_positions, sigmas):\n    \"\"\"\n    Compute the slab Ewald correction:\n        U_corr = (2*pi / V) * Mz^2, V = A*Lz, Mz = sum_i Q_i z_i = A * sum_i sigma_i z_i\n    \"\"\"\n    z = np.array(z_positions, dtype=float)\n    sigma = np.array(sigmas, dtype=float)\n    total_sigma = np.sum(sigma)\n    if abs(total_sigma)  1e-12:\n        raise ValueError(\"System is not neutral: sum(sigma) != 0\")\n    Mz = area * np.sum(sigma * z)\n    V = area * Lz\n    U_corr = (2.0 * np.pi / V) * (Mz ** 2)\n    return U_corr\n\ndef compute_ratio(area, Lz, z_positions, sigmas):\n    U_exact = exact_energy_total(area, Lz, z_positions, sigmas)\n    U_corr = slab_ewald_correction(area, Lz, z_positions, sigmas)\n    # To avoid division by zero, handle U_exact = 0\n    if abs(U_exact)  1e-20:\n        # If exact energy is zero, ratio defined as 0 if U_corr also zero, else np.inf\n        return 0.0 if abs(U_corr)  1e-20 else float('inf')\n    return U_corr / U_exact\n\ndef solve():\n    # Define the test cases as specified in the problem statement.\n    test_cases = [\n        # Test Case 1\n        {\n            \"A\": 10.0,\n            \"Lz\": 20.0,\n            \"z\": [9.25, 10.75],\n            \"sigma\": [0.2, -0.2],\n        },\n        # Test Case 2\n        {\n            \"A\": 25.0,\n            \"Lz\": 10.0,\n            \"z\": [3.0, 5.0, 7.0],\n            \"sigma\": [0.1, -0.2, 0.1],\n        },\n        # Test Case 3\n        {\n            \"A\": 10.0,\n            \"Lz\": 4.0,\n            \"z\": [0.0, 4.0],\n            \"sigma\": [1.0, -1.0],\n        },\n        # Test Case 4\n        {\n            \"A\": 10.0,\n            \"Lz\": 50.0,\n            \"z\": [23.5, 24.5, 25.5, 26.5],\n            \"sigma\": [0.3, -0.3, 0.3, -0.3],\n        },\n        # Test Case 5\n        {\n            \"A\": 10.0,\n            \"Lz\": 1_000_000.0,\n            \"z\": [499998.5, 500001.5],\n            \"sigma\": [0.4, -0.4],\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        A = case[\"A\"]\n        Lz = case[\"Lz\"]\n        z = case[\"z\"]\n        sigma = case[\"sigma\"]\n        ratio = compute_ratio(A, Lz, z, sigma)\n        # Format with ten digits after the decimal point\n        if np.isfinite(ratio):\n            results.append(f\"{ratio:.10f}\")\n        else:\n            results.append(\"inf\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```", "id": "3446607"}, {"introduction": "在理解了能量修正之后，下一个合理的步骤是探究它如何通过力来影响系统动力学。这个实践练习将重点从平板几何修正的能量项中推导出其对应的解析力。通过实现和测试这些力，你将能够验证一些关键的物理原理，例如中性系统中的动量守恒，并深入了解这些修正在分子动力学代码中的实际应用。[@problem_id:3446662]", "problem": "考虑一个边长为 $L_x$、$L_y$ 和 $L_z$ 的三维周期性模拟盒子，其中包含 $N$ 个位于位置 $(x_i,y_i,z_i)$ 的点电荷 $q_i$，并在所有三个方向上施加周期性边界条件 (PBC)。在旨在模拟二维周期性并在 $z$ 方向上设置真空层的板状几何结构中，通过三维埃瓦尔德求和计算的长程静电作用需要一个二维校正，以消除 $z$ 方向上周期性镜像之间的伪相互作用。一种经过充分检验的校正方法，通常称为板状埃瓦尔德二维校正，它增加了一个仅取决于沿 $z$ 轴总偶极矩的能量项。\n\n从基本静电学以及 $z$ 方向偶极矩分量 $M_z = \\sum_{i=1}^{N} q_i z_i$ 和模拟盒子体积 $V = L_x L_y L_z$ 的定义出发，在约化静电单位（其中库仑核常数为 $1$）下，板状校正能量由 $U_{\\mathrm{corr}} = \\alpha M_z^2$ 给出，其中常数前置因子 $\\alpha$ 仅取决于盒子体积。使用此能量形式以及能量和力之间的标准关系，从第一性原理推导由该校正项引起的、作用于每个粒子沿 $z$ 方向的附加力。确保您的推导能够解释为什么当体系呈电中性时合力为零，为什么对于非电中性体系合力不为零，以及为什么在电中性体系中，当所有 $z$ 坐标进行常数整体平移时，校正力保持不变。\n\n您的程序必须以约化（无量纲）内部单位实现推导出的力公式，并设计和运行一个测试套件以验证：\n- 对于电中性体系，通过验证沿 $z$ 轴的净合力为零来检验动量守恒。\n- 对于非电中性体系，验证净合力非零。\n- 在电中性体系中，验证单个粒子受力在所有 $z$ 坐标进行整体平移下的不变性。\n- 当 $M_z = 0$ 时，即使单个电荷非零，力也为零。\n- 通过有限差分近似，验证推导出的力与校正能量负梯度的一致性。\n\n使用以下测试套件，每个测试由 $(\\mathbf{q}, \\mathbf{z}, \\mathbf{L})$ 指定，其中 $\\mathbf{q} = (q_1,\\dots,q_N)$，$\\mathbf{z} = (z_1,\\dots,z_N)$，以及 $\\mathbf{L} = (L_x,L_y,L_z)$：\n1. 电中性体系（标准情况）：$\\mathbf{q} = (1.0,-1.0,0.5,-0.5)$，$\\mathbf{z} = (0.1,1.3,-0.7,2.2)$，$\\mathbf{L} = (4.0,4.0,12.0)$。\n2. 非电中性体系（边界情况）：$\\mathbf{q} = (1.0,0.2,-0.1)$，$\\mathbf{z} = (0.0,0.5,-0.3)$，$\\mathbf{L} = (5.0,5.0,15.0)$。\n3. 原点平移不变性（覆盖性）：$\\mathbf{q} = (1.0,-1.0,0.5,-0.5)$，$\\mathbf{z} = (0.1,1.3,-0.7,2.2)$ 及平移后的 $\\mathbf{z}' = \\mathbf{z} + c$（其中 $c = 3.0$），$\\mathbf{L} = (4.0,4.0,12.0)$。\n4. 相同高度下零偶极矩（边界条件）：$\\mathbf{q} = (2.0,-2.0)$，$\\mathbf{z} = (1.0,1.0)$，$\\mathbf{L} = (3.0,3.0,9.0)$。\n5. 有限差分验证（数值一致性）：$\\mathbf{q} = (1.5,-0.5,-1.0)$，$\\mathbf{z} = (-0.8,0.4,1.1)$，$\\mathbf{L} = (6.0,6.0,18.0)$，对每个 $z_i$ 使用对称有限差分步长 $\\varepsilon = 10^{-8}$ 来近似 $-\\partial U_{\\mathrm{corr}}/\\partial z_i$。\n\n所有计算必须以约化内部单位（无量纲）执行和报告。您的程序应生成单行输出，其中包含用方括号括起来的、以逗号分隔的结果列表。结果必须按以下顺序排列的布尔值：\n- 测试 1：如果沿 $z$ 轴的净校正力在数值上为零（在容差范围内），则返回 $\\text{True}$，否则返回 $\\text{False}$。\n- 测试 2：如果沿 $z$ 轴的净校正力在数值上非零（超出容差范围），则返回 $\\text{True}$，否则返回 $\\text{False}$。\n- 测试 3：如果为 $\\mathbf{z}$ 和 $\\mathbf{z}'$ 计算的力矢量在容差范围内逐元素相等，则返回 $\\text{True}$，否则返回 $\\text{False}$。\n- 测试 4：如果所有校正力在容差范围内数值上均为零，则返回 $\\text{True}$，否则返回 $\\text{False}$。\n- 测试 5：如果对于所有粒子，推导的解析力与通过有限差分估算的负能量梯度在容差范围内匹配，则返回 $\\text{True}$，否则返回 $\\text{False}$。\n\n您的程序应准确生成一行格式为 $[\\text{result}_1,\\text{result}_2,\\text{result}_3,\\text{result}_4,\\text{result}_5]$ 的输出，其中每个 $\\text{result}_k$ 为 $\\text{True}$ 或 $\\text{False}$。", "solution": "该问题要求推导在板状几何模拟中使用的特定二维静电校正项所产生的力，分析这些力的物理性质，并通过编程验证这些性质。\n\n静电校正能量在约化单位下表示为：\n$$\nU_{\\mathrm{corr}} = \\alpha M_z^2\n$$\n其中 $M_z$ 是模拟盒子总偶极矩的 $z$ 分量，$M_z = \\sum_{i=1}^{N} q_i z_i$，$\\alpha$ 是一个仅取决于盒子体积 $V = L_x L_y L_z$ 的前置因子。问题没有指定 $\\alpha(V)$ 的函数形式。基于 Yeh-Berkowitz 板状埃瓦尔德校正的标准公式，对于真空介电常数 $\\epsilon_0$ 设为 $\\frac{1}{4\\pi}$ 的约化静电单位，我们将采用 $\\alpha = \\frac{2\\pi}{V}$ 的形式。然而，我们对力的推导及其定性性质的分析，将只依赖于 $\\alpha$ 是一个相对于粒子坐标的常数，而与其具体值无关。\n\n### 校正力的推导\n\n作用于粒子 $j$ 的力 $\\mathbf{F}_j$ 是势能对其坐标 $\\mathbf{r}_j = (x_j, y_j, z_j)$ 的负梯度。我们关心的是沿 $z$ 轴的力分量 $F_{z,j}$，其表达式为：\n$$\nF_{z,j} = -\\frac{\\partial U_{\\mathrm{corr}}}{\\partial z_j}\n$$\n能量 $U_{\\mathrm{corr}}$ 仅通过总偶极矩 $M_z$ 依赖于 $z_j$。因此，我们可以应用链式法则进行微分：\n$$\nF_{z,j} = -\\frac{\\mathrm{d}U_{\\mathrm{corr}}}{\\mathrm{d}M_z} \\frac{\\partial M_z}{\\partial z_j}\n$$\n首先，我们计算 $U_{\\mathrm{corr}}$ 对 $M_z$ 的导数：\n$$\n\\frac{\\mathrm{d}U_{\\mathrm{corr}}}{\\mathrm{d}M_z} = \\frac{\\mathrm{d}}{\\mathrm{d}M_z} (\\alpha M_z^2) = 2\\alpha M_z\n$$\n接着，我们计算 $M_z$ 对粒子 $j$ 的坐标 $z_j$ 的偏导数：\n$$\nM_z = \\sum_{i=1}^{N} q_i z_i = q_1 z_1 + q_2 z_2 + \\dots + q_j z_j + \\dots + q_N z_N\n$$\n导数仅对包含 $z_j$ 的项不为零：\n$$\n\\frac{\\partial M_z}{\\partial z_j} = \\frac{\\partial}{\\partial z_j} (q_j z_j) = q_j\n$$\n将这两个结果代回力的表达式，得到作用于粒子 $j$ 沿 $z$ 轴的校正力的最终公式：\n$$\nF_{z,j} = -(2\\alpha M_z)(q_j) = -2\\alpha q_j M_z\n$$\n代入 $M_z$ 的完整表达式，我们得到：\n$$\nF_{z,j} = -2\\alpha q_j \\left( \\sum_{i=1}^{N} q_i z_i \\right)\n$$\n这个公式表明，作用于给定粒子 $j$ 的校正力与其自身电荷 $q_j$ 和体系的总偶极矩 $M_z$ 成正比。$x$ 和 $y$ 方向的力为零，因为 $U_{\\mathrm{corr}}$ 不依赖于 $x_i$ 或 $y_i$ 坐标。\n\n### 物理性质分析\n\n现在我们可以使用推导出的力表达式来分析问题所要求的其集体性质。\n\n1.  **电中性体系的合力：**\n    沿 $z$ 轴的总校正力（或净校正力）$F_{z, \\text{net}}$ 是作用于所有 $N$ 个粒子的单独力的总和：\n    $$\n    F_{z, \\text{net}} = \\sum_{j=1}^{N} F_{z,j} = \\sum_{j=1}^{N} (-2\\alpha q_j M_z)\n    $$\n    由于 $M_z$ 和 $\\alpha$ 是求和中所有粒子的公因子，我们可以将它们提取出来：\n    $$\n    F_{z, \\text{net}} = -2\\alpha M_z \\left( \\sum_{j=1}^{N} q_j \\right)\n    $$\n    括号中的项是体系的总电荷，$Q_{\\text{tot}} = \\sum_{j=1}^{N} q_j$。因此：\n    $$\n    F_{z, \\text{net}} = -2\\alpha M_z Q_{\\text{tot}}\n    $$\n    对于电中性体系，$Q_{\\text{tot}} = 0$。在这种情况下，合力为：\n    $$\n    F_{z, \\text{net}} = -2\\alpha M_z (0) = 0\n    $$\n    这证明了对于中性体系，该校正项遵守了沿 $z$ 轴的总动量守恒，正如牛顿第三定律对内力的要求。\n\n2.  **非电中性体系的合力：**\n    如果体系不是电中性的，则 $Q_{\\text{tot}} \\neq 0$。合力 $F_{z, \\text{net}} = -2\\alpha M_z Q_{\\text{tot}}$ 通常不为零（除非偶极矩 $M_z$ 恰好为零）。这意味着校正项在体系上引起了一个伪合力，导致了质心的非物理性加速。这是该特定校正方案应用于带净电荷体系时的一个已知的人为效应。\n\n3.  **电中性体系中坐标平移下的不变性：**\n    让我们考虑将所有 $z$ 坐标进行一个常数值 $c$ 的整体平移，使得新坐标为 $z'_i = z_i + c$。我们想要检验力是如何变化的。新的偶极矩 $M'_z$ 为：\n    $$\n    M'_z = \\sum_{i=1}^{N} q_i z'_i = \\sum_{i=1}^{N} q_i (z_i + c) = \\sum_{i=1}^{N} q_i z_i + \\sum_{i=1}^{N} q_i c = M_z + c \\left( \\sum_{i=1}^{N} q_i \\right) = M_z + c Q_{\\text{tot}}\n    $$\n    作用于粒子 $j$ 的新力 $F'_{z,j}$ 使用新的偶极矩 $M'_z$ 计算：\n    $$\n    F'_{z,j} = -2\\alpha q_j M'_z = -2\\alpha q_j (M_z + c Q_{\\text{tot}})\n    $$\n    如果体系是电中性的，$Q_{\\text{tot}} = 0$。新的偶极矩和力的表达式简化为：\n    $$\n    M'_z = M_z + c(0) = M_z\n    $$\n    $$\n    F'_{z,j} = -2\\alpha q_j M_z = F_{z,j}\n    $$\n    因此，对于中性体系，总偶极矩和单个校正力在所有粒子沿 $z$ 轴进行匀速平移时都保持不变。这是一个重要的物理一致性要求，因为体系内的内力不应依赖于坐标系原点的选择。对于非中性体系，这种不变性被破坏。\n\n### 算法设计与测试套件实现\n\nPython 程序将实现推导出的力公式，并运行指定的测试套件来验证上述分析的性质。浮点数比较使用 $10^{-9}$ 的容差。\n\n**核心函数：** 将实现一个函数 `calculate_forces(q, z, L)`。它接收电荷数组 `q`、z 坐标数组 `z` 和一个包含盒子长度的元组 `L`。它计算体积 $V = L_x L_y L_z$、常数 $\\alpha = 2\\pi/V$、偶极矩 $M_z = \\sum q_i z_i$，最后返回一个力数组 $F_{z,j} = -2\\alpha q_j M_z$。\n\n**测试套件逻辑：**\n\n1.  **电中性体系测试：** 对于给定的中性体系（$\\sum q_i = 0$），计算各个力。计算这些力的总和，并检查其绝对值是否小于容差。这验证了动量守恒。\n2.  **非电中性体系测试：** 对于给定的非中性体系（$\\sum q_i \\neq 0$），计算合力。预计该力不为零。测试将验证其绝对值是否大于容差。\n3.  **原点平移不变性测试：** 对于给定的中性体系，分别计算原始 $z$ 坐标和移动后的坐标 $z'_i = z_i + 3.0$ 的力。由于体系是中性的，两种情况下的力矢量应该完全相同。测试将检查两个力数组是否在容差范围内逐元素相等。\n4.  **零偶极矩测试：** 此测试用例被构造成总偶极矩 $M_z$ 设计为零（$M_z = 2.0 \\times 1.0 + (-2.0) \\times 1.0 = 0$）。由于 $F_{z,j} \\propto M_z$，所有单个力都必须为零。测试将验证计算出的力数组的所有元素是否在容差范围内为零。\n5.  **有限差分验证测试：** 此测试为解析力推导提供数值检验。作用在每个粒子 $j$ 上的力 $F_{z,j} = -\\partial U_{\\mathrm{corr}}/\\partial z_j$，使用对称有限差分方案来近似：$F_{z,j}^{\\text{num}} \\approx -\\frac{U_{\\mathrm{corr}}(z_j+\\varepsilon) - U_{\\mathrm{corr}}(z_j-\\varepsilon)}{2\\varepsilon}$。使用一个小的微扰量 $\\varepsilon = 10^{-8}$。然后将解析计算的力与这些数值近似值进行逐元素比较，以确保它们在容差范围内匹配，从而确认解析推导 $F_{z,j} = -2\\alpha q_j M_z$ 的正确性。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Validates the slab Ewald 2D electrostatic correction forces against\n    several physical and numerical consistency checks.\n    \"\"\"\n\n    TOLERANCE = 1e-9\n\n    def calculate_energy(q, z, L):\n        \"\"\"Calculates the correction energy U_corr = alpha * M_z^2.\"\"\"\n        volume = L[0] * L[1] * L[2]\n        if volume == 0:\n            return 0.0\n        alpha = 2.0 * np.pi / volume\n        m_z = np.dot(q, z)\n        return alpha * m_z**2\n\n    def calculate_forces(q, z, L):\n        \"\"\"Calculates the correction forces F_{z,j} = -2*alpha*q_j*M_z.\"\"\"\n        q = np.asarray(q)\n        z = np.asarray(z)\n        \n        volume = L[0] * L[1] * L[2]\n        if volume == 0:\n            return np.zeros_like(q)\n            \n        alpha = 2.0 * np.pi / volume\n        m_z = np.dot(q, z)\n        forces = -2.0 * alpha * q * m_z\n        return forces\n\n    results = []\n\n    # Test 1: Neutral system should have zero net force.\n    q1 = [1.0, -1.0, 0.5, -0.5]\n    z1 = [0.1, 1.3, -0.7, 2.2]\n    L1 = (4.0, 4.0, 12.0)\n    forces1 = calculate_forces(q1, z1, L1)\n    net_force1 = np.sum(forces1)\n    results.append(abs(net_force1)  TOLERANCE)\n\n    # Test 2: Non-neutral system should have non-zero net force.\n    q2 = [1.0, 0.2, -0.1]\n    z2 = [0.0, 0.5, -0.3]\n    L2 = (5.0, 5.0, 15.0)\n    forces2 = calculate_forces(q2, z2, L2)\n    net_force2 = np.sum(forces2)\n    results.append(abs(net_force2)  TOLERANCE)\n\n    # Test 3: Force invariance under global z-shift for a neutral system.\n    q3 = [1.0, -1.0, 0.5, -0.5]\n    z3 = np.array([0.1, 1.3, -0.7, 2.2])\n    L3 = (4.0, 4.0, 12.0)\n    shift = 3.0\n    z3_shifted = z3 + shift\n    forces3_original = calculate_forces(q3, z3, L3)\n    forces3_shifted = calculate_forces(q3, z3_shifted, L3)\n    results.append(np.allclose(forces3_original, forces3_shifted, atol=TOLERANCE, rtol=0))\n\n    # Test 4: Zero forces for zero dipole moment.\n    q4 = [2.0, -2.0]\n    z4 = [1.0, 1.0]\n    L4 = (3.0, 3.0, 9.0)\n    forces4 = calculate_forces(q4, z4, L4)\n    results.append(np.allclose(forces4, 0.0, atol=TOLERANCE, rtol=0))\n\n    # Test 5: Finite-difference validation.\n    q5 = np.array([1.5, -0.5, -1.0])\n    z5 = np.array([-0.8, 0.4, 1.1])\n    L5 = (6.0, 6.0, 18.0)\n    epsilon = 1e-8\n    \n    # Analytical forces\n    analytic_forces = calculate_forces(q5, z5, L5)\n    \n    # Numerical forces\n    numerical_forces = np.zeros_like(q5)\n    for i in range(len(q5)):\n        z_plus = np.copy(z5)\n        z_minus = np.copy(z5)\n        z_plus[i] += epsilon\n        z_minus[i] -= epsilon\n        \n        energy_plus = calculate_energy(q5, z_plus, L5)\n        energy_minus = calculate_energy(q5, z_minus, L5)\n        \n        numerical_forces[i] = -(energy_plus - energy_minus) / (2.0 * epsilon)\n        \n    results.append(np.allclose(analytic_forces, numerical_forces, atol=TOLERANCE, rtol=1e-5))\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3446662"}, {"introduction": "在对修正的能量和力有了扎实的掌握之后，我们现在转向一个实际应用：如何在动态的模拟过程中管理这些静电伪影。本练习将指导你从宏观静电学原理出发，推导真空区域中伪电场的表达式，并设计一个自适应算法。该算法能够监控误差场，并智能地决定是增加模拟盒子尺寸，还是切换到更精确（但可能计算成本更高）的二维静电学方法，从而模拟现代模拟软件包中使用的控制逻辑。[@problem_id:3446612]", "problem": "考虑一个三维周期性分子动力学模拟盒子，其边长分别为 $L_x$、$L_y$ 和 $L_z$，包含 $N$ 个点电荷 $q_i$，位置为 $\\mathbf{r}_i = (x_i,y_i,z_i)$。该系统为板层几何构型，在 $x$ 和 $y$ 方向上延伸，在 $z$ 方向上有限，并通过沿 $z$ 方向的真空层隔开。在三维周期性边界条件下，长程静电作用通常通过 Ewald summation 处理。然而，对于板层结构，应用三维 Green’s function 会因沿 $z$ 方向周期性复制的偶极子之间的相互作用，在真空区域引入一个虚假的退极化场。在实践中，必须要么增大 $L_z$ 以减小该虚假场，要么用一个能消除沿 $z$ 方向周期性的二维 Green’s function 替换三维 Green’s function。\n\n您的任务是从基本电动力学出发，推导出一个诊断和控制算法，该算法能够：\n- 计算沿板层法线方向的净偶极矩 $M_z = \\sum_{i=1}^{N} q_i z_i$，使用的坐标是相对于模拟盒子中心的，因此 $z_i \\in [-L_z/2, +L_z/2]$。\n- 推导并计算在三维周期性边界条件下，由周期性堆叠在真空区域沿 $z$ 方向产生的均匀电场，该电场以 $4\\pi \\varepsilon_0 = 1$ 的约化静电单位表示。\n- 将此场的强度与预设阈值进行比较，如果超过阈值，则通过以下方式之一进行调整：\n  1) 将 $L_z$ 增加一个整数倍因子，直到场强低于阈值（或达到允许的最大因子）；或\n  2) 切换到二维 Green’s function 模型，该模型中虚假的真空场被消除。\n- 实现一个自动决策模式，通过比较一个简化的计算成本模型，在增加 $L_z$ 和切换到二维 Green’s function 之间做出选择。\n\n您必须从基本定律和核心定义出发，特别是 Gauss’s law 和沿 $z$ 轴周期性重复的板层的极化定义，来建立在使用三维周期性处理时，每个单元的板层偶极矩与真空区域中均匀虚假场之间的关系。然后设计一个算法，能够动态评估该场，并触发上述两种自适应响应之一。\n\n所有变量和计算都应在 $4\\pi \\varepsilon_0 = 1$ 的约化静电单位下处理。输出值为不带物理单位标签的纯数。\n\n程序要求：\n- 实现一个函数，给定 $L_x$、$L_y$、$L_z$ 和一个配对列表 $(q_i, z_i)$（其中 $z_i \\in [-L_z/2, +L_z/2]$），该函数计算：\n  - $M_z$、\n  - 在三维周期性边界条件下沿 $z$ 方向的初始真空电场强度、\n  - 调整决策、\n  - 调整后的最终 $L_z$、\n  - 以及调整后的最终真空电场强度。\n- 调整决策代码必须为整数：\n  - $0$：无操作（场强低于或等于阈值），\n  - $1$：将 $L_z$ 增加为使场强低于阈值所需的最小整数倍（或限制在指定的最大倍数），\n  - $2$：切换到二维 Green’s function（根据构造，真空场视为零）。\n- 在自动决策模式下，使用此简化成本模型：\n  - 增加 $L_z$ 后保持三维周期性边界条件的成本与应用于 $L_z$ 的乘法因子 $f$ 成正比。\n  - 切换到二维 Green’s function 的成本是一个指定的常数 $C_{2\\mathrm{D}}$。\n  - 选择成本较小的选项。如果成本相等，则优先选择增加 $L_z$。\n- 如果选择增加 $L_z$，使用最小整数因子 $f = \\lceil |E_{\\mathrm{vac}}| / E_{\\mathrm{th}} \\rceil$，并受最大允许因子 $f_{\\max}$ 的限制。如果 $|E_{\\mathrm{vac}}| \\le E_{\\mathrm{th}}$，则不改变 $L_z$。\n\n测试套件：\n- 您必须硬编码并评估以下案例。对于每个案例，返回一个列表 $[M_z, E_{\\mathrm{vac}}^{(0)}, d, L_z^{(\\mathrm{final})}, E_{\\mathrm{vac}}^{(\\mathrm{final})}]$，其中 $E_{\\mathrm{vac}}^{(0)}$ 是三维周期性模型的初始真空场强度，$d$ 是决策代码，$L_z^{(\\mathrm{final})}$ 是沿 $z$ 轴的最终盒子长度，$E_{\\mathrm{vac}}^{(\\mathrm{final})}$ 是所选调整后产生的真空场强度。所有浮点数必须打印为小数点后保留10位的小数值。程序必须生成单行输出，其中包含这些按案例划分的结果列表。\n\n- 案例 A (理想情况：无操作)：\n  - $L_x = 10.0$, $L_y = 10.0$, $L_z = 100.0$。\n  - 电荷：$\\{(q_1, z_1) = (1.0, +1.0), (q_2, z_2) = (-1.0, -1.0)\\}$。\n  - 阈值 $E_{\\mathrm{th}} = 0.01$。\n  - 模式：自动决策。\n  - $C_{2\\mathrm{D}} = 3.0$, $f_{\\max} = 10$。\n\n- 案例 B (增加 $L_z$)：\n  - $L_x = 10.0$, $L_y = 10.0$, $L_z = 10.0$。\n  - 电荷：$\\{(q_1, z_1) = (1.0, +1.0), (q_2, z_2) = (-1.0, -1.0)\\}$。\n  - 阈值 $E_{\\mathrm{th}} = 0.01$。\n  - 模式：强制增加 $L_z$。\n  - $f_{\\max} = 10$。\n\n- 案例 C (切换到二维 Green's function)：\n  - $L_x = 8.0$, $L_y = 8.0$, $L_z = 5.0$。\n  - 电荷：$\\{(q_1, z_1) = (1.0, +2.0), (q_2, z_2) = (-1.0, 0.0)\\}$。\n  - 阈值 $E_{\\mathrm{th}} = 0.02$。\n  - 模式：强制使用二维 Green's function。\n\n- 案例 D (自动决策选择增加 $L_z$)：\n  - $L_x = 12.0$, $L_y = 12.0$, $L_z = 20.0$。\n  - 电荷：$\\{(q_1, z_1) = (2.0, +1.0), (q_2, z_2) = (1.5, +1.0), (q_3, z_3) = (-3.5, 0.0)\\}$。\n  - 阈值 $E_{\\mathrm{th}} = 0.01$。\n  - 模式：自动决策。\n  - $C_{2\\mathrm{D}} = 3.0$, $f_{\\max} = 10$。\n\n- 案例 E (自动决策选择二维 Green's function)：\n  - $L_x = 10.0$, $L_y = 10.0$, $L_z = 10.0$。\n  - 电荷：$\\{(q_1, z_1) = (2.5, +2.0), (q_2, z_2) = (-2.5, -1.0)\\}$。\n  - 阈值 $E_{\\mathrm{th}} = 0.01$。\n  - 模式：自动决策。\n  - $C_{2\\mathrm{D}} = 3.0$, $f_{\\max} = 10$。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含用方括号括起来的、以逗号分隔的各案例结果列表，其中每个案例的结果本身就是一个包含五个值的列表，顺序为 $[M_z, E_{\\mathrm{vac}}^{(0)}, d, L_z^{(\\mathrm{final})}, E_{\\mathrm{vac}}^{(\\mathrm{final})}]$。例如，包含三个结果的列表应如下所示：$[[a_1,b_1,c_1,d_1,e_1],[a_2,b_2,c_2,d_2,e_2],[a_3,b_3,c_3,d_3,e_3]]$。所有浮点数必须打印为小数点后保留10位的小数值。决策代码必须为整数。", "solution": "该问题要求推导并实现一种诊断和控制算法，用于处理在三维(3D)周期性边界条件下的板层几何构型分子动力学模拟中的虚假静电场。解决方案从基本静电学原理出发，直至具体的计算算法。\n\n### 1. 理论基础：虚假真空场\n\n在使用 3D 周期性边界条件模拟板层几何构型（在 $z$ 方向有限，在 $xy$ 平面无限）时，尺寸为 $L_x \\times L_y \\times L_z$ 的模拟盒子在所有三个方向上被无限复制。如果中心原胞内位于位置 $\\mathbf{r}_i$ 的电荷 $q_i$ 的分布具有净偶极矩，这种周期性会产生一个人为的宏观极化。\n\n中心模拟原胞中电荷沿板层法线（$z$ 轴）方向的净偶极矩定义为：\n$$\nM_z = \\sum_{i=1}^{N} q_i z_i\n$$\n其中坐标 $z_i$ 是相对于盒子中心测量的，即 $z_i \\in [-L_z/2, +L_z/2]$。\n\n当该偶极矩在模拟原胞的体积 $V = L_x L_y L_z$ 上平均时，会产生平均极化密度：\n$$\nP_z = \\frac{M_z}{V} = \\frac{\\sum_{i=1}^{N} q_i z_i}{L_x L_y L_z}\n$$\n为完全周期性系统设计的标准 3D Ewald summation 方法，能有效地计算中心原胞与其嵌入在周围介质中的所有周期性映像之间的静电相互作用。一种常见的实现方式（“锡箔”或导电边界条件）会无意中引入一个能量项，该能量项等效于将周期性系统浸入完美导体中。对于具有非零净偶极矩的系统，这会导致在整个模拟原胞中产生一个虚假的、均匀的退极化电场。\n\n该场可以从宏观静电学推导得出。在一个由 Gaussian units（或指定的约化单位，其中 $4\\pi \\varepsilon_0 = 1$）描述的系统中，由 3D 周期性晶格中的平均极化 $\\mathbf{P}$ 产生的电场 $\\mathbf{E}$ 由下式给出：\n$$\n\\mathbf{E}_{\\text{spurious}} = -4\\pi \\mathbf{P}\n$$\n符号表示它是一个退极化场；如果偶极矩 $M_z$ 为正（指向 $+z$ 方向），则感应场指向 $-z$ 方向。对于我们的板层几何构型，相关分量是沿 $z$ 轴的：\n$$\nE_z = -4\\pi P_z = -4\\pi \\frac{M_z}{L_x L_y L_z}\n$$\n这个均匀场存在于模拟原胞的任何地方，包括真空区域，并且是求和方法的产物。它可能引入显著误差，例如，通过人为地极化分子或将离子驱动到板层表面。这个虚假场的强度，我们记为 $E_{\\mathrm{vac}}$，因为它弥漫于真空中，是主要的诊断量：\n$$\nE_{\\mathrm{vac}} = |E_z| = \\frac{4\\pi |M_z|}{L_x L_y L_z}\n$$\n\n### 2. 算法设计与自适应策略\n\n任务的核心是计算该场，并且如果其强度超过给定阈值 $E_{\\mathrm{th}}$，则应用一种自适应策略。\n\n#### 步骤 1：诊断\n给定系统参数（$L_x, L_y, L_z$）以及电荷及其 $z$ 坐标的集合 $\\{(q_i, z_i)\\}$，我们首先计算初始状态：\n1.  计算净偶极矩 $M_z = \\sum_{i} q_i z_i$。\n2.  计算初始体积 $V_0 = L_x L_y L_z$。\n3.  计算初始虚假场的强度 $E_{\\mathrm{vac}}^{(0)} = \\frac{4\\pi |M_z|}{V_0}$。\n\n#### 步骤 2：决策\n将计算出的场强与阈值 $E_{\\mathrm{th}}$ 进行比较。\n- 如果 $E_{\\mathrm{vac}}^{(0)} \\le E_{\\mathrm{th}}$，场强在可接受范围内。无需任何操作。决策代码为 $d=0$。最终状态与初始状态相同：$L_z^{(\\mathrm{final})} = L_z$ 且 $E_{\\mathrm{vac}}^{(\\mathrm{final})} = E_{\\mathrm{vac}}^{(0)}$。\n\n- 如果 $E_{\\mathrm{vac}}^{(0)}  E_{\\mathrm{th}}$，则需要进行自适应调整。操作的选择取决于指定的模式。\n\n#### 步骤 3：自适应调整\n有两种可能的修正措施：\n\n**措施 1：增加 $L_z$ （决策代码 $d=1$）**\n该方法通过增加模拟原胞的体积来减小场强，从而降低平均极化强度 $P_z$。盒子长度 $L_z$ 增加一个整数因子 $f \\ge 1$。新的盒子长度为 $L_z' = f \\cdot L_z$，新体积为 $V' = f \\cdot V$。新的场强将是：\n$$\nE_{\\mathrm{vac}}' = \\frac{4\\pi |M_z|}{V'} = \\frac{4\\pi |M_z|}{f \\cdot V} = \\frac{E_{\\mathrm{vac}}^{(0)}}{f}\n$$\n为确保新场强低于（或等于）阈值，即 $E_{\\mathrm{vac}}' \\le E_{\\mathrm{th}}$，我们需要 $E_{\\mathrm{vac}}^{(0)}/f \\le E_{\\mathrm{th}}$，这意味着 $f \\ge E_{\\mathrm{vac}}^{(0)}/E_{\\mathrm{th}}$。满足此条件的最小整数因子是：\n$$\nf = \\lceil E_{\\mathrm{vac}}^{(0)} / E_{\\mathrm{th}} \\rceil\n$$\n然后，该因子受最大允许因子 $f_{\\max}$ 的限制，因此要应用的因子为 $f_{\\mathrm{actual}} = \\min(\\lceil E_{\\mathrm{vac}}^{(0)}/E_{\\mathrm{th}} \\rceil, f_{\\max})$。\n- 最终盒子长度为 $L_z^{(\\mathrm{final})} = f_{\\mathrm{actual}} \\cdot L_z$。\n- 最终场强为 $E_{\\mathrm{vac}}^{(\\mathrm{final})} = E_{\\mathrm{vac}}^{(0)} / f_{\\mathrm{actual}}$。\n\n**措施 2：切换到 2D Green's Function （决策代码 $d=2$）**\n这种方法从根本上改变了静电计算。它使用 2D 方法（例如 Ewald2D、P2D 或 MMM2D）来代替 3D Ewald sum。这些方法专为具有 2D 周期性的系统设计，并能正确处理板层在 $z$ 方向上的有限性。根据其构造，它们不会在真空中产生虚假场。\n- 模拟盒子的尺寸保持不变：$L_z^{(\\mathrm{final})} = L_z$。\n- 根据模型的定义，最终的虚假真空场为零：$E_{\\mathrm{vac}}^{(\\mathrm{final})} = 0.0$。\n\n#### 步骤 4：自动决策模式\n在此模式下，算法根据一个简化的计算成本模型在措施 1 和措施 2 之间进行选择。\n- 措施 1（增加 $L_z$）的成本取为所需的乘法因子，$C_1 = f_{\\mathrm{actual}} = \\min(\\lceil E_{\\mathrm{vac}}^{(0)}/E_{\\mathrm{th}} \\rceil, f_{\\max})$。这反映了更大的盒子会增加计算量。\n- 措施 2（切换到 2D）的成本是一个指定的常数，$C_2 = C_{2\\mathrm{D}}$。这代表了使用 2D Ewald 算法的开销或复杂性。\n\n通过比较这些成本来做出决策：\n- 如果 $C_1 \\le C_2$，则选择措施 1，因为它在计算上更便宜或等效（并倾向于保留更简单的 3D 方法）。\n- 如果 $C_1  C_2$，则选择措施 2，因为它是更具成本效益的解决方案。\n\n这种集成方法提供了一种稳健的、动态的方法，通过监测和控制静电伪影来维持板层模拟的物理准确性。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve_slab_es(Lx, Ly, Lz, charges, Eth, mode, C_2D=None, f_max=None):\n    \"\"\"\n    Computes electrostatic diagnostics and adaptation for a slab geometry.\n\n    Args:\n        Lx (float): Box length in x-direction.\n        Ly (float): Box length in y-direction.\n        Lz (float): Box length in z-direction.\n        charges (list): A list of tuples (q_i, z_i) for each charge.\n        Eth (float): Electric field magnitude threshold.\n        mode (str): Adaptation mode ('auto', 'force_Lz', 'force_2d').\n        C_2D (float, optional): Cost of switching to 2D Ewald. Required for 'auto' mode.\n        f_max (int, optional): Max factor to increase Lz. Required for 'auto' and 'force_Lz'.\n\n    Returns:\n        list: A list of 5 values: [Mz, E_vac_0, d, Lz_final, E_vac_final].\n    \"\"\"\n    # Step 1: Compute initial state\n    Mz = sum(q * z for q, z in charges)\n    V0 = Lx * Ly * Lz\n    \n    # Handle the case of zero dipole moment to avoid division by zero if V0 is also zero.\n    if V0 == 0:\n        E_vac_0 = 0.0 if Mz == 0 else float('inf')\n    else:\n        # The spurious field E_z = -4*pi*Mz/V. We need the magnitude.\n        E_vac_0 = (4 * np.pi * abs(Mz)) / V0\n\n    # Step 2: Check against threshold\n    if E_vac_0 = Eth:\n        d = 0\n        Lz_final = Lz\n        E_vac_final = E_vac_0\n    else:\n        # Step 3: Adaptation is needed\n        # Defaults for action 2 (switch to 2D)\n        d_2d = 2\n        Lz_final_2d = Lz\n        E_vac_final_2d = 0.0\n\n        # Calculations for action 1 (increase Lz)\n        # Note: np.ceil returns a float, so we cast to int.\n        f = int(np.ceil(E_vac_0 / Eth))\n        f_actual = min(f, f_max) if f_max is not None else f\n        \n        Lz_final_Lz = f_actual * Lz\n        E_vac_final_Lz = E_vac_0 / f_actual\n        d_Lz = 1\n        \n        if mode == 'force_Lz':\n            d = d_Lz\n            Lz_final = Lz_final_Lz\n            E_vac_final = E_vac_final_Lz\n        elif mode == 'force_2d':\n            d = d_2d\n            Lz_final = Lz_final_2d\n            E_vac_final = E_vac_final_2d\n        elif mode == 'auto':\n            # Step 4: Automatic decision based on cost\n            cost_1 = f_actual  # Cost of increasing Lz\n            cost_2 = C_2D        # Cost of switching to 2D\n\n            if cost_1 = cost_2:\n                # Choose to increase Lz\n                d = d_Lz\n                Lz_final = Lz_final_Lz\n                E_vac_final = E_vac_final_Lz\n            else:\n                # Choose to switch to 2D\n                d = d_2d\n                Lz_final = Lz_final_2d\n                E_vac_final = E_vac_final_2d\n        else:\n            raise ValueError(\"Invalid mode specified.\")\n\n    return [Mz, E_vac_0, d, Lz_final, E_vac_final]\n\ndef solve():\n    \"\"\"\n    Main function to run test cases and print results.\n    \"\"\"\n    test_cases = [\n        # Case A (happy path: no action)\n        {'Lx': 10.0, 'Ly': 10.0, 'Lz': 100.0,\n         'charges': [(1.0, 1.0), (-1.0, -1.0)],\n         'Eth': 0.01, 'mode': 'auto', 'C_2D': 3.0, 'f_max': 10},\n\n        # Case B (increase Lz)\n        {'Lx': 10.0, 'Ly': 10.0, 'Lz': 10.0,\n         'charges': [(1.0, 1.0), (-1.0, -1.0)],\n         'Eth': 0.01, 'mode': 'force_Lz', 'f_max': 10},\n\n        # Case C (switch to 2D Green’s function)\n        {'Lx': 8.0, 'Ly': 8.0, 'Lz': 5.0,\n         'charges': [(1.0, 2.0), (-1.0, 0.0)],\n         'Eth': 0.02, 'mode': 'force_2d'},\n\n        # Case D (automatic decision chooses increase Lz)\n        {'Lx': 12.0, 'Ly': 12.0, 'Lz': 20.0,\n         'charges': [(2.0, 1.0), (1.5, 1.0), (-3.5, 0.0)],\n         'Eth': 0.01, 'mode': 'auto', 'C_2D': 3.0, 'f_max': 10},\n\n        # Case E (automatic decision chooses 2D Green’s function)\n        {'Lx': 10.0, 'Ly': 10.0, 'Lz': 10.0,\n         'charges': [(2.5, 2.0), (-2.5, -1.0)],\n         'Eth': 0.01, 'mode': 'auto', 'C_2D': 3.0, 'f_max': 10},\n    ]\n\n    formatted_cases = []\n    for case in test_cases:\n        result = solve_slab_es(**case)\n        \n        # Format each numerical result to 10 decimal places as a string\n        mz, e0, d, lzf, ef = result\n        s = f\"[{mz:.10f},{e0:.10f},{d},{lzf:.10f},{ef:.10f}]\"\n        formatted_cases.append(s)\n        \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(formatted_cases)}]\")\n\nsolve()\n\n```", "id": "3446612"}]}