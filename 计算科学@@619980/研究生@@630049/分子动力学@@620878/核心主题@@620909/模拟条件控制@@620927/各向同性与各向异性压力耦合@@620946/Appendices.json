{"hands_on_practices": [{"introduction": "在进行复杂的分子动力学模拟之前，理解所用方法的内在假设至关重要。一个常见的误区是在本质上各向异性的材料（如大多数晶体）上使用简单的各向同性压力耦合方案。本练习借助线性弹性理论这一简化模型，清晰地揭示了为何这种做法是有问题的。通过这个实践，你将量化各向同性应变如何在各向异性材料中产生非静水压力的内应力，从而深刻理解为何对于特定系统而言，各向异性压力耦合是必不可少的。", "problem": "考虑一个通过分子动力学（MD）模拟的晶体固体。宏观应力张量通过维里定义计算，静水压力定义为 $P = -\\frac{1}{3} \\operatorname{Tr}(\\boldsymbol{\\sigma})$，其中 $\\boldsymbol{\\sigma}$ 是 Cauchy 应力张量。调压器（barostat）是一种通过缩放模拟晶胞以达到目标压力的控制方案。\n\n您将研究两种调压器机制：\n- 一种各向同性调压器，它沿所有笛卡尔方向施加相同的正应变，使得变形梯度与单位矩阵成正比。\n- 一种各向异性调压器，它独立控制三个笛卡尔方向上的正应变。\n\n假设晶体处于小应变和线弹性行为。在小应变极限下，应力和应变的正分量通过胡克定律（Hooke’s law）关联：$\\sigma_{\\alpha\\alpha} = \\sum_{\\beta\\beta} C_{\\alpha\\alpha,\\beta\\beta}\\,\\epsilon_{\\beta\\beta}$，对于 $\\alpha,\\beta \\in \\{x,y,z\\}$。其中，刚度矩阵 $C$ 对于正分量以 $3\\times 3$ 的 Voigt 形式表示：\n$$\n\\mathbf{C} = \\begin{bmatrix}\nC_{11}  C_{12}  C_{13} \\\\\nC_{12}  C_{22}  C_{23} \\\\\nC_{13}  C_{23}  C_{33}\n\\end{bmatrix},\n$$\n正应变向量为 $\\boldsymbol{\\epsilon} = [\\epsilon_{xx}, \\epsilon_{yy}, \\epsilon_{zz}]^\\top$，而正应力向量为 $\\boldsymbol{\\sigma}_{\\mathrm{n}} = [\\sigma_{xx}, \\sigma_{yy}, \\sigma_{zz}]^\\top$。\n\n在各向同性调压器下，施加的正应变是均匀的：$\\epsilon_{xx} = \\epsilon_{yy} = \\epsilon_{zz} = \\alpha$，其中 $\\alpha$ 为某个标量。目标压力为 $P^*$（单位为吉帕斯卡）。在旨在达到静水压状态的各向异性调压器下，目标应力为 $\\boldsymbol{\\sigma}_{\\mathrm{n}} = [-P^*, -P^*, -P^*]^\\top$。\n\n您的任务是：\n1. 从以上定义和线弹性理论出发，推导各向同性调压器为使宏观压力满足 $P = P^*$ 所必须施加的标量应变 $\\alpha$ 的表达式，并根据刚度系数和 $P^*$ 计算由此产生的应力分量 $\\sigma_{xx}$、$\\sigma_{yy}$ 和 $\\sigma_{zz}$。\n2. 使用各向同性应变下得到的 $\\boldsymbol{\\sigma}_{\\mathrm{n}}$，通过将 $\\langle P_{\\alpha\\beta}\\rangle$（此处由 $\\boldsymbol{\\sigma}$ 的对角分量表示）与 $P^* \\delta_{\\alpha\\beta}$ 进行比较，以两种度量标准来量化静水压的误表示误差：\n   - 归一化 Frobenius 失配度 $E_{\\mathrm{rel}}$，定义为偏差向量 $\\mathbf{d} = [\\sigma_{xx} + P^*, \\sigma_{yy} + P^*, \\sigma_{zz} + P^*]^\\top$ 的 Frobenius 范数与 $|P^*| \\sqrt{3}$ 的比值。对于 $P^* = 0$，定义 $E_{\\mathrm{rel}} = 0$。\n   - 最大分量相对偏差 $E_{\\max}$，定义为 $\\max_{\\alpha \\in \\{x,y,z\\}} |\\sigma_{\\alpha\\alpha} + P^*| / |P^*|$。对于 $P^* = 0$，定义 $E_{\\max} = 0$。\n   $E_{\\mathrm{rel}}$ 和 $E_{\\max}$ 均为无量纲量。\n3. 提出一个基于各向异性压力耦合的校正方案：通过求解 $\\mathbf{C}\\,\\boldsymbol{\\epsilon}_{\\mathrm{hydro}} = [-P^*, -P^*, -P^*]^\\top$ 来计算在线弹性条件下能精确产生静水压应力的正应变向量 $\\boldsymbol{\\epsilon}_{\\mathrm{hydro}}$。如果 $\\alpha \\neq 0$，将相对于各向同性调压器应变的校正乘数定义为 $\\mathbf{s} = \\boldsymbol{\\epsilon}_{\\mathrm{hydro}} / \\alpha$（分量形式）。如果 $\\alpha = 0$，则设 $\\mathbf{s} = [0, 0, 0]$。\n\n实现一个程序，对每个给定的测试用例，计算并输出元组 $[E_{\\mathrm{rel}}, E_{\\max}, \\mathbf{s}]$。\n\n物理和数值单位：\n- 所有刚度分量 $C_{ij}$ 的单位均为吉帕斯卡（GPa）。\n- 压力 $P^*$ 的单位为吉帕斯卡（GPa）。\n- 应变为无量纲量。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表。列表中的每个测试用例结果本身就是一个列表 $[E_{\\mathrm{rel}}, E_{\\max}, [s_x, s_y, s_z]]$。最终输出行中不允许有空格。\n\n测试套件：\n- 案例1（近各向同性立方晶体，理想路径）：$P^* = 2.0$ GPa，$\\mathbf{C}$ 为 $C_{11} = 160$, $C_{22} = 160$, $C_{33} = 160$, $C_{12} = 80$, $C_{13} = 80$, $C_{23} = 80$。\n- 案例2（四方各向异性）：$P^* = 2.0$ GPa，$\\mathbf{C}$ 为 $C_{11} = 200$, $C_{22} = 150$, $C_{33} = 100$, $C_{12} = 50$, $C_{13} = 30$, $C_{23} = 40$。\n- 案例3（正交强各向异性）：$P^* = 1.0$ GPa，$\\mathbf{C}$ 为 $C_{11} = 300$, $C_{22} = 120$, $C_{33} = 180$, $C_{12} = 70$, $C_{13} = 20$, $C_{23} = 60$。\n- 案例4（边界条件，零目标压力）：$P^* = 0.0$ GPa，$\\mathbf{C}$ 为 $C_{11} = 220$, $C_{22} = 180$, $C_{33} = 140$, $C_{12} = 90$, $C_{13} = 60$, $C_{23} = 70$。\n\n最终输出格式：\n- 您的程序应精确打印一行：一个包含四个元素的方括号列表，对应四个案例，每个元素都是列表 $[E_{\\mathrm{rel}},E_{\\max},[s_x,s_y,s_z]]$。输出中不得包含空格（例如：\"[[0.0,0.0,[0.0,0.0,0.0]],[...],[...],[...]]\"）。", "solution": "该问题要求在线弹性假设下，对模拟晶体固体中与各向同性和各向异性压力耦合相关的量进行推导和计算。该过程分为三个主要任务：分析各向同性调压器，量化其在产生静水压应力状态时的误差，并提出各向异性校正方案。\n\n该模型的基础是应力张量 $\\boldsymbol{\\sigma}_{\\mathrm{n}}$ 的正分量与应变张量 $\\boldsymbol{\\epsilon}$ 的正分量之间的线弹性关系，由 Voigt 记法下的胡克定律（Hooke's Law）给出：$\\boldsymbol{\\sigma}_{\\mathrm{n}} = \\mathbf{C}\\boldsymbol{\\epsilon}$。这里，$\\boldsymbol{\\sigma}_{\\mathrm{n}} = [\\sigma_{xx}, \\sigma_{yy}, \\sigma_{zz}]^\\top$，$\\boldsymbol{\\epsilon} = [\\epsilon_{xx}, \\epsilon_{yy}, \\epsilon_{zz}]^\\top$，而 $\\mathbf{C}$ 是弹性刚度系数的 $3 \\times 3$ 对称矩阵。\n$$\n\\begin{bmatrix} \\sigma_{xx} \\\\ \\sigma_{yy} \\\\ \\sigma_{zz} \\end{bmatrix} = \\begin{bmatrix} C_{11}  C_{12}  C_{13} \\\\ C_{12}  C_{22}  C_{23} \\\\ C_{13}  C_{23}  C_{33} \\end{bmatrix} \\begin{bmatrix} \\epsilon_{xx} \\\\ \\epsilon_{yy} \\\\ \\epsilon_{zz} \\end{bmatrix}\n$$\n\n静水压力 $P$ 定义为 $P = -\\frac{1}{3}\\operatorname{Tr}(\\boldsymbol{\\sigma}) = -\\frac{1}{3}(\\sigma_{xx} + \\sigma_{yy} + \\sigma_{zz})$。目标压力为 $P^*$。\n\n**1. 各向同性调压器的应变和应力**\n\n各向同性调压器在所有笛卡尔方向上施加均匀应变，使得 $\\epsilon_{xx} = \\epsilon_{yy} = \\epsilon_{zz} = \\alpha$。因此，应变向量为 $\\boldsymbol{\\epsilon} = \\alpha[1, 1, 1]^\\top$。\n\n将此代入胡克定律，我们得到所得的正应力分量：\n$$\n\\sigma_{xx} = (C_{11} + C_{12} + C_{13})\\alpha\n$$\n$$\n\\sigma_{yy} = (C_{12} + C_{22} + C_{23})\\alpha\n$$\n$$\n\\sigma_{zz} = (C_{13} + C_{23} + C_{33})\\alpha\n$$\n\n那么宏观压力 $P$ 为：\n$$\nP = -\\frac{1}{3}(\\sigma_{xx} + \\sigma_{yy} + \\sigma_{zz}) = -\\frac{\\alpha}{3} \\sum_{i,j} C_{ij}\n$$\n其中 $\\sum_{i,j} C_{ij} = C_{11} + C_{22} + C_{33} + 2(C_{12} + C_{13} + C_{23})$。\n调压器的目标是达到 $P = P^*$。我们可以解出所需的标量应变 $\\alpha$。定义一个用于各向同性变形的有效体积模量 $K_{iso}$ 为 $K_{iso} = \\frac{1}{3} \\sum_{i,j} C_{ij}$，则有 $P = -K_{iso} \\alpha$。因此，\n$$\n\\alpha = -\\frac{P^*}{K_{iso}} = -\\frac{3P^*}{C_{11} + C_{22} + C_{33} + 2(C_{12} + C_{13} + C_{23})}\n$$\n将此 $\\alpha$ 值代回，即可得到各向同性应变下的应力分量 $\\sigma_{xx}, \\sigma_{yy}, \\sigma_{zz}$。\n\n**2. 误表示误差的量化**\n\n在理想的静水压状态下，应力张量为 $\\sigma_{\\alpha\\beta} = -P^* \\delta_{\\alpha\\beta}$。由各向同性调压器产生的应力分量通常不满足此条件。我们通过偏差向量 $\\mathbf{d} = [\\sigma_{xx} + P^*, \\sigma_{yy} + P^*, \\sigma_{zz} + P^*]^\\top$ 来量化这种偏差。\n\n- **归一化 Frobenius 失配度 $E_{\\mathrm{rel}}$**：\n  $$\n  E_{\\mathrm{rel}} = \\frac{\\|\\mathbf{d}\\|_F}{|P^*|\\sqrt{3}} = \\frac{\\sqrt{(\\sigma_{xx} + P^*)^2 + (\\sigma_{yy} + P^*)^2 + (\\sigma_{zz} + P^*)^2}}{|P^*|\\sqrt{3}}\n  $$\n- **最大分量相对偏差 $E_{\\max}$**：\n  $$\n  E_{\\max} = \\frac{\\max(|\\sigma_{xx} + P^*|, |\\sigma_{yy} + P^*|, |\\sigma_{zz} + P^*|)}{|P^*|}\n  $$\n对于 $P^*=0$ 的情况，$\\alpha=0$，$\\boldsymbol{\\sigma}_{\\mathrm{n}}=\\mathbf{0}$，因此 $\\mathbf{d}=\\mathbf{0}$，两个误差度量均为 $0$。\n\n**3. 各向异性校正方案**\n\n为了精确产生静水压应力状态 $\\boldsymbol{\\sigma}_{\\mathrm{n}} = [-P^*, -P^*, -P^*]^\\top$，必须施加一个特定的各向异性应变向量 $\\boldsymbol{\\epsilon}_{\\mathrm{hydro}}$。该应变向量可通过求解线性方程组 $\\mathbf{C}\\,\\boldsymbol{\\epsilon}_{\\mathrm{hydro}} = [-P^*, -P^*, -P^*]^\\top$ 获得：\n$$\n\\boldsymbol{\\epsilon}_{\\mathrm{hydro}} = \\mathbf{C}^{-1} \\begin{bmatrix} -P^* \\\\ -P^* \\\\ -P^* \\end{bmatrix}\n$$\n其中 $\\mathbf{C}^{-1}$ 是刚度矩阵的逆，即柔度矩阵。\n校正乘数向量 $\\mathbf{s}$ 定义为 $\\boldsymbol{\\epsilon}_{\\mathrm{hydro}}$ 相对于各向同性应变 $\\alpha$ 的比值（分量形式）：\n$$\n\\mathbf{s} = [s_x, s_y, s_z]^\\top = \\frac{1}{\\alpha} \\boldsymbol{\\epsilon}_{\\mathrm{hydro}}\n$$\n如果 $\\alpha = 0$（即 $P^*=0$），则 $\\boldsymbol{\\epsilon}_{\\mathrm{hydro}} = \\mathbf{0}$，我们将 $\\mathbf{s}$ 定义为 $[0, 0, 0]^\\top$。\n这些计算步骤为每个测试用例提供了计算 $[E_{\\mathrm{rel}}, E_{\\max}, \\mathbf{s}]$ 所需的完整框架。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem for the defined test suite, calculating error metrics\n    and correction factors for isotropic vs. anisotropic pressure coupling.\n    \"\"\"\n\n    def calculate_metrics(p_star, C_dict):\n        \"\"\"\n        Calculates E_rel, E_max, and s for a single test case.\n\n        Args:\n            p_star (float): The target pressure P* in GPa.\n            C_dict (dict): A dictionary with stiffness coefficients C_ij in GPa.\n\n        Returns:\n            tuple: A tuple containing (E_rel, E_max, s_list).\n        \"\"\"\n        # Build the 3x3 stiffness matrix for normal components\n        C_matrix = np.array([\n            [C_dict['c11'], C_dict['c12'], C_dict['c13']],\n            [C_dict['c12'], C_dict['c22'], C_dict['c23']],\n            [C_dict['c13'], C_dict['c23'], C_dict['c33']]\n        ])\n\n        # Special case: P* = 0\n        if p_star == 0.0:\n            return 0.0, 0.0, [0.0, 0.0, 0.0]\n\n        # Task 1: Isotropic barostat analysis\n        # K_iso = (1/3) * sum of all elements of C_matrix\n        K_iso = (1 / 3.0) * (C_dict['c11'] + C_dict['c22'] + C_dict['c33'] + \n                               2 * (C_dict['c12'] + C_dict['c13'] + C_dict['c23']))\n\n        if K_iso == 0:\n            # Physically unstable material, division by zero.\n            # Per problem validation, this should not occur for the given cases.\n            # Return NaNs to indicate an issue.\n            return float('nan'), float('nan'), [float('nan')] * 3\n            \n        alpha = -p_star / K_iso\n\n        # Calculate stress components under isotropic strain\n        epsilon_iso = np.array([alpha, alpha, alpha])\n        sigma_n = C_matrix @ epsilon_iso\n\n        # Task 2: Error quantification\n        # Deviation vector d = [sigma_xx+P*, sigma_yy+P*, sigma_zz+P*]\n        d = sigma_n + p_star\n        \n        # Calculate E_rel\n        norm_d_F = np.linalg.norm(d)\n        E_rel = norm_d_F / (abs(p_star) * np.sqrt(3))\n\n        # Calculate E_max\n        E_max = np.max(np.abs(d)) / abs(p_star)\n\n        # Task 3: Anisotropic correction\n        # Calculate epsilon_hydro by solving C * epsilon_hydro = [-P*, -P*, -P*]\n        target_stress = np.array([-p_star, -p_star, -p_star])\n        epsilon_hydro = np.linalg.solve(C_matrix, target_stress)\n        \n        # Calculate correction multipliers s.\n        # The case alpha=0 (from p_star=0) is handled at the start.\n        s = epsilon_hydro / alpha\n        \n        return E_rel, E_max, s.tolist()\n\n    test_cases = [\n        (2.0, {'c11': 160., 'c22': 160., 'c33': 160., 'c12': 80., 'c13': 80., 'c23': 80.}),\n        (2.0, {'c11': 200., 'c22': 150., 'c33': 100., 'c12': 50., 'c13': 30., 'c23': 40.}),\n        (1.0, {'c11': 300., 'c22': 120., 'c33': 180., 'c12': 70., 'c13': 20., 'c23': 60.}),\n        (0.0, {'c11': 220., 'c22': 180., 'c33': 140., 'c12': 90., 'c13': 60., 'c23': 70.})\n    ]\n\n    results = []\n    for p_star_case, c_vals_case in test_cases:\n        E_rel, E_max, s = calculate_metrics(p_star_case, c_vals_case)\n        s_str = f\"[{s[0]},{s[1]},{s[2]}]\"\n        case_result = f\"[{E_rel},{E_max},{s_str}]\"\n        results.append(case_result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```", "id": "3419438"}, {"introduction": "压力各向异性并非总是需要消除的伪影；在非均相体系中，它恰恰是重要物理现象的标志。本练习引导你完成一项常见且重要的分析任务：从模拟得到的沿界面法线方向的压力张量分布，计算液-气界面的表面张力。这项实践将压力耦合控制的微观应力与可测量的宏观热力学性质联系起来，让你学会如何从原始模拟数据中提取有价值的物理信息。", "problem": "考虑一个在恒定粒子数、压强和温度 (NPT) 系综中的分子动力学 (MD) 系统，其模拟盒子中包含一个平行于 $x$–$y$ 平面且垂直于 $z$ 轴的平面液板。局域应力由依赖于位置的压强张量 $P_{\\alpha\\beta}(z)$ 描述，其对角分量为 $P_{xx}(z)$、$P_{yy}(z)$ 和 $P_{zz}(z)$。定义法向分量为 $P_{N}(z) = P_{zz}(z)$，切向分量为 $P_{T}(z) = \\big(P_{xx}(z)+P_{yy}(z)\\big)/2$。由于周期性边界条件，该系统表现出两个平面界面。\n\n根据牛顿运动方程和局域压强张量的 Irving–Kirkwood 表达式，平面界面的表面张力与法向应力超过切向应力的部分有关。仅使用这些基本依据，并且不引用任何预先推导的表面张力恒等式，推导在周期性板状几何结构中平面界面的表面张力的力学路径，并确定考虑存在两个界面的适当因子。然后，从得到的连续表达式出发，在间距为 $\\Delta z$ 的均匀 $z$ 网格上构建一个一致的离散近似，已知可用数据代表在等距位置上以每个 bin（区间）为中心的、经 bin 平均的压强张量分量。您的离散近似必须遵守以下物理和数值约束：\n- 离散近似必须在 $\\Delta z \\to 0$ 时与连续极限一致。\n- 数据的 bin 平均性质意味着，中点（矩形）黎曼和是适当的最低阶一致求积法则，而非基于端点的法则。\n- 单位必须严格处理：压强分量以 bar（巴）为单位，网格间距 $\\Delta z$ 以 nanometers (nm)（纳米）为单位，最终的表面张力必须以 milli-Newton per meter (mN/m)（毫牛顿/米）为单位报告。\n\n此外，为了表征超出法向-切向对比的各向异性，定义一个面内各向异性积分，用于衡量两个切向分量之差的大小：\n- 设 $A_{xy}$ 为 $\\lvert P_{xx}(z) - P_{yy}(z) \\rvert$ 沿 $z$ 的积分，使用与表面张力相同的单位转换，以 mN/m 表示。\n\n最后，定义一个标量压强失配诊断量，以评估施加的目标平均压强是否得到遵守：\n- 设目标压强为 $P_{\\text{target}} = 1$ bar。定义\n$$\nM \\equiv \\left\\lvert \\left\\langle \\frac{P_{xx}(z)+P_{yy}(z)+P_{zz}(z)}{3} \\right\\rangle_z - P_{\\text{target}} \\right\\rvert,\n$$\n其中 $\\langle \\cdot \\rangle_z$ 表示在所有 bin 上的算术平均值。以 bar 为单位报告 $M$。\n\n您的程序必须实现表面张力和 $A_{xy}$ 积分的离散中点法则版本，并使用适用于具有两个界面的周期性板状结构的因子校正。使用单位转换因子 $1\\,\\text{bar}\\cdot\\text{nm} = 0.1\\,\\text{mN/m}$。对于数值输出，将每个报告的浮点数四舍五入到 $6$ 位小数。\n\n测试套件：\n为以下 $4$ 种情况提供结果。在所有情况下，bin 的数量为 $12$，均匀间距为 $\\Delta z = 1$ nm，$P_{\\text{target}} = 1$ bar。每种情况都由长度相同的数组 $P_{xx}$、$P_{yy}$ 和 $P_{zz}$ 指定，单位为 bar，按从 $z_0$ 到 $z_{11}$ 的 bin 顺序给出。这些数组应被视为在 bin 中心的 bin 平均值。这些情况是：\n\n- 情况 $1$（半各向同性耦合；有明显的法向-切向各向异性，但没有面内各向异性）：\n  - $P_{xx}$: $\\{1,1,-15.666666666666666,-82.33333333333333,-15.666666666666666,1,1,1,-15.666666666666666,-15.666666666666666,-49.0,1\\}$\n  - $P_{yy}$: $\\{1,1,-15.666666666666666,-82.33333333333333,-15.666666666666666,1,1,1,-15.666666666666666,-15.666666666666666,-49.0,1\\}$\n  - $P_{zz}$: $\\{1,1,34.333333333333336,167.66666666666666,34.333333333333336,1,1,1,34.333333333333336,34.333333333333336,101.0,1\\}$\n\n- 情况 $2$（各向同性耦合；减小的法向-切向各向异性，无面内各向异性）：\n  - $P_{xx}$: $\\{1,1,-7.333333333333333,-40.666666666666664,-7.333333333333333,1,1,1,-7.333333333333333,-7.333333333333333,-24.0,1\\}$\n  - $P_{yy}$: $\\{1,1,-7.333333333333333,-40.666666666666664,-7.333333333333333,1,1,1,-7.333333333333333,-7.333333333333333,-24.0,1\\}$\n  - $P_{zz}$: $\\{1,1,17.666666666666668,84.33333333333333,17.666666666666668,1,1,1,17.666666666666668,17.666666666666668,51.0,1\\}$\n\n- 情况 $3$（全各向异性耦合；与情况 $1$ 相同的法向-切向各向异性，但有非零的面内各向异性）：\n  - $P_{xx}$: $\\{1,1,-5.666666666666667,-92.33333333333333,-5.666666666666667,1,1,1,-25.666666666666668,-5.666666666666667,-59.0,1\\}$\n  - $P_{yy}$: $\\{1,1,-25.666666666666668,-72.33333333333333,-25.666666666666668,1,1,1,-5.666666666666667,-25.666666666666668,-39.0,1\\}$\n  - $P_{zz}$: $\\{1,1,34.333333333333336,167.66666666666666,34.333333333333336,1,1,1,34.333333333333336,34.333333333333336,101.0,1\\}$\n\n- 情况 $4$（均匀各向同性流体；无各向异性）：\n  - $P_{xx}$: $\\{1,1,1,1,1,1,1,1,1,1,1,1\\}$\n  - $P_{yy}$: $\\{1,1,1,1,1,1,1,1,1,1,1,1\\}$\n  - $P_{zz}$: $\\{1,1,1,1,1,1,1,1,1,1,1,1\\}$\n\n对于每种情况，您的程序必须按此顺序计算并返回一个包含三个量的列表：\n- 表面张力，单位 mN/m，\n- 面内各向异性积分 $A_{xy}$，单位 mN/m，\n- 压强失配 $M$，单位 bar。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个列表，该列表包含按情况 $1$ 到 $4$ 顺序排列的 $4$ 个结果列表，每个浮点数四舍五入到 $6$ 位小数，格式为用逗号分隔并用方括号括起来。例如：\n\"[[\\dots,\\dots,\\dots],[\\dots,\\dots,\\dots],[\\dots,\\dots,\\dots],[\\dots,\\dots,\\dots]]\"。", "solution": "该问题要求对一个具有平面板状几何结构的分子动力学系统，推导并计算三个量：表面张力 ($\\gamma$)、一个面内各向异性积分 ($A_{xy}$) 和一个压强失配诊断量 ($M$)。\n\n**1. 表面张力公式的推导**\n\n压强张量 $\\mathbf{P}$ 的力学定义将其与作用在连续介质内部的力联系起来。对于一个处于力学平衡的系统，压强张量的散度必须为零，即 $\\nabla \\cdot \\mathbf{P} = 0$。对于一个物理性质仅沿 $z$ 轴变化的平面系统，该平衡条件简化为 $\\frac{d}{dz}P_{zx} = 0$、$\\frac{d}{dz}P_{zy} = 0$ 和 $\\frac{d}{dz}P_{zz} = 0$。最后一个条件意味着压强的法向分量 $P_{N}(z) = P_{zz}(z)$ 在整个模拟盒子中必须是恒定的。这个恒定值必须等于施加于系统的外部压强 $P_{\\text{ext}}$。\n\n表面张力 $\\gamma$ 是创建单位面积界面所需的功。对于一个横截面积为 $A_{xy} = L_x L_y$ 且具有两个界面的系统，在 $x$-$y$ 平面内作用以收缩面积的总力与压强张量的法向分量和切向分量之差的积分有关。单个平面界面的表面张力的基本力学表达式由该应力各向异性的积分给出：\n$$ \\gamma = \\int_{-\\infty}^{\\infty} [P_{N} - P_{T}(z)] dz $$\n其中 $P_N$ 是恒定的法向压强，$P_{T}(z) = \\frac{1}{2}(P_{xx}(z) + P_{yy}(z))$ 是局域切向压强。\n\n在所有三个维度都使用周期性边界条件的模拟中，板状几何结构会导致形成两个相同的界面。计算是在模拟盒子的长度 $L_z$ 上进行的。对盒子长度的积分捕获了两个界面的贡献。因此，盒子中的总张力为 $2\\gamma$：\n$$ 2\\gamma = \\int_{0}^{L_z} [P_{N} - P_{T}(z)] dz $$\n问题提供了所有压强张量分量（包括 $P_{zz}(z)$）随位置变化的值。虽然在一个完美平衡的无限系统中 $P_{zz}(z)$ 会是恒定的，但在有限的模拟中，由于统计分箱，预计会有波动。问题将 $P_N(z) = P_{zz}(z)$ 定义为使用局域值。代入 $P_N(z)$ 和 $P_T(z)$ 的定义，可得：\n$$ 2\\gamma = \\int_{0}^{L_z} \\left( P_{zz}(z) - \\frac{P_{xx}(z) + P_{yy}(z)}{2} \\right) dz $$\n求解单个界面的表面张力 $\\gamma$ 需要除以界面数，即 $2$：\n$$ \\gamma = \\frac{1}{2} \\int_{0}^{L_z} \\left( P_{zz}(z) - \\frac{P_{xx}(z) + P_{yy}(z)}{2} \\right) dz $$\n这是表面张力的连续表达式。\n\n**2. 离散近似和单位**\n\n问题提供了在间距为 $\\Delta z$ 的均匀网格上的 bin 平均数据。与 bin 平均数据一致的离散近似是中点黎曼和。在长度为 $L_z = N_{bins} \\Delta z$ 的盒子上的积分 $\\int_{0}^{L_z} f(z) dz$ 被近似为 $\\sum_{i=0}^{N_{bins}-1} f(z_i) \\Delta z$，其中 $f(z_i)$ 是函数在第 $i$ 个 bin 中的值。\n\n将此应用于表面张力公式，我们得到离散近似：\n$$ \\gamma \\approx \\frac{\\Delta z}{2} \\sum_{i=0}^{N_{bins}-1} \\left( P_{zz,i} - \\frac{P_{xx,i} + P_{yy,i}}{2} \\right) $$\n其中 $P_{\\alpha\\beta,i}$ 是给定的 bin 平均压强分量。\n\n压强分量的单位是 bar，$\\Delta z$ 的单位是 nm。因此，求和的单位是 bar$\\cdot$nm。我们给出的转换因子是 $1\\,\\text{bar}\\cdot\\text{nm} = 0.1\\,\\text{mN/m}$。令此转换因子为 $C_{unit} = 0.1 \\frac{\\text{mN/m}}{\\text{bar}\\cdot\\text{nm}}$。表面张力的最终计算公式是：\n$$ \\gamma \\, [\\text{mN/m}] = C_{unit} \\times \\frac{\\Delta z}{2} \\sum_{i=0}^{N_{bins}-1} \\left( P_{zz,i} - \\frac{P_{xx,i} + P_{yy,i}}{2} \\right) $$\n\n**3. 面内各向异性积分 ($A_{xy}$)**\n\n面内各向异性积分 $A_{xy}$ 定义为：\n$$ A_{xy} = \\int_{0}^{L_z} \\lvert P_{xx}(z) - P_{yy}(z) \\rvert dz $$\n这个量测量了在整个模拟盒子中，液体平面内应力差的总大小。与表面张力（界面的强度性质）不同，$A_{xy}$ 被定义为整个系统的广延性质。因此，不应用 $1/2$ 的因子。\n\n其使用中点法则的离散近似是：\n$$ A_{xy} \\approx \\Delta z \\sum_{i=0}^{N_{bins}-1} \\lvert P_{xx,i} - P_{yy,i} \\rvert $$\n应用相同的单位转换，计算公式为：\n$$ A_{xy} \\, [\\text{mN/m}] = C_{unit} \\times \\Delta z \\sum_{i=0}^{N_{bins}-1} \\lvert P_{xx,i} - P_{yy,i} \\rvert $$\n\n**4. 压强失配诊断量 ($M$)**\n\n压强失配诊断量 $M$ 定义为：\n$$ M \\equiv \\left\\lvert \\left\\langle \\frac{P_{xx}(z)+P_{yy}(z)+P_{zz}(z)}{3} \\right\\rangle_z - P_{\\text{target}} \\right\\rvert $$\n其中 $\\langle \\cdot \\rangle_z$ 表示在所有 bin 上的算术平均值，$P_{\\text{target}}$ 是目标压强，给定为 $1$ bar。平均值内的项是压强张量的迹，对应于局域静水压强。离散公式是该定义的直接转换：\n$$ M \\, [\\text{bar}] = \\left\\lvert \\left( \\frac{1}{N_{bins}} \\sum_{i=0}^{N_{bins}-1} \\frac{P_{xx,i}+P_{yy,i}+P_{zz,i}}{3} \\right) - P_{\\text{target}} \\right\\rvert $$\n该量以 bar 为单位报告，因此不需要单位转换。\n\n现在将实施这些公式来分析所提供的测试用例。对于所有情况，$N_{bins}=12$，$\\Delta z=1$ nm，$P_{\\text{target}}=1$ bar。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes surface tension, in-plane anisotropy, and pressure mismatch for\n    four test cases of a molecular dynamics slab simulation.\n    \"\"\"\n\n    # Define the constants from the problem statement.\n    n_bins = 12\n    delta_z_nm = 1.0  # in nm\n    p_target_bar = 1.0  # in bar\n    conv_factor = 0.1  # (mN/m) / (bar*nm)\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1 (semi-isotropic coupling)\n        (\n            np.array([1, 1, -15.666666666666666, -82.33333333333333, -15.666666666666666, 1, 1, 1, -15.666666666666666, -15.666666666666666, -49.0, 1]),\n            np.array([1, 1, -15.666666666666666, -82.33333333333333, -15.666666666666666, 1, 1, 1, -15.666666666666666, -15.666666666666666, -49.0, 1]),\n            np.array([1, 1, 34.333333333333336, 167.66666666666666, 34.333333333333336, 1, 1, 1, 34.333333333333336, 34.333333333333336, 101.0, 1])\n        ),\n        # Case 2 (isotropic coupling)\n        (\n            np.array([1, 1, -7.333333333333333, -40.666666666666664, -7.333333333333333, 1, 1, 1, -7.333333333333333, -7.333333333333333, -24.0, 1]),\n            np.array([1, 1, -7.333333333333333, -40.666666666666664, -7.333333333333333, 1, 1, 1, -7.333333333333333, -7.333333333333333, -24.0, 1]),\n            np.array([1, 1, 17.666666666666668, 84.33333333333333, 17.666666666666668, 1, 1, 1, 17.666666666666668, 17.666666666666668, 51.0, 1])\n        ),\n        # Case 3 (fully anisotropic coupling)\n        (\n            np.array([1, 1, -5.666666666666667, -92.33333333333333, -5.666666666666667, 1, 1, 1, -25.666666666666668, -5.666666666666667, -59.0, 1]),\n            np.array([1, 1, -25.666666666666668, -72.33333333333333, -25.666666666666668, 1, 1, 1, -5.666666666666667, -25.666666666666668, -39.0, 1]),\n            np.array([1, 1, 34.333333333333336, 167.66666666666666, 34.333333333333336, 1, 1, 1, 34.333333333333336, 34.333333333333336, 101.0, 1])\n        ),\n        # Case 4 (uniform isotropic fluid)\n        (\n            np.array([1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1], dtype=float),\n            np.array([1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1], dtype=float),\n            np.array([1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1], dtype=float)\n        )\n    ]\n\n    results = []\n    for case in test_cases:\n        p_xx, p_yy, p_zz = case\n\n        # --- Calculate Surface Tension (gamma) ---\n        # Integrand for surface tension: P_zz - (P_xx + P_yy) / 2\n        integrand_gamma = p_zz - (p_xx + p_yy) / 2.0\n        # Midpoint rule sum: sum(integrand) * delta_z\n        integral_gamma = np.sum(integrand_gamma) * delta_z_nm\n        # Final surface tension in mN/m, with factor of 1/2 for two interfaces\n        gamma = 0.5 * conv_factor * integral_gamma\n\n        # --- Calculate In-plane Anisotropy Integral (A_xy) ---\n        # Integrand for A_xy: |P_xx - P_yy|\n        integrand_axy = np.abs(p_xx - p_yy)\n        # Midpoint rule sum: sum(integrand) * delta_z\n        integral_axy = np.sum(integrand_axy) * delta_z_nm\n        # Final A_xy in mN/m\n        a_xy = conv_factor * integral_axy\n\n        # --- Calculate Pressure Mismatch (M) ---\n        # Local hydrostatic pressure: (P_xx + P_yy + P_zz) / 3\n        p_hydro = (p_xx + p_yy + p_zz) / 3.0\n        # Average hydrostatic pressure over all bins\n        avg_p_hydro = np.mean(p_hydro)\n        # Mismatch M in bar\n        m = np.abs(avg_p_hydro - p_target_bar)\n        \n        results.append([gamma, a_xy, m])\n\n    # Format the final output string as a list of lists with 6 decimal places.\n    output_parts = []\n    for res in results:\n        res_str = f\"[{res[0]:.6f},{res[1]:.6f},{res[2]:.6f}]\"\n        output_parts.append(res_str)\n    \n    final_output_str = f\"[{','.join(output_parts)}]\"\n    print(final_output_str)\n\nsolve()\n```", "id": "3419421"}, {"introduction": "在理解了为何以及在何种情景下需要使用各向异性压力耦合后，最终的挑战在于亲手实现其核心算法。本练习深入探讨了各向异性压力耦合的核心——Parrinello-Rahman方法。你将推导模拟晶胞矩阵的运动方程，并解决一个关键的实际问题：如何约束晶胞矩阵以防止非物理性的旋转，从而确保模拟在形状和体积变化过程中的正确性与稳定性。", "problem": "您的任务是为分子动力学（MD）中的模拟晶胞矩阵实现并分析一种各向异性压力耦合方案。模拟晶胞由一个矩阵 $\\mathbf{h} \\in \\mathbb{R}^{3 \\times 3}$ 表示，该矩阵将分数坐标 $\\mathbf{s}$ 映射到笛卡尔坐标 $\\mathbf{r} = \\mathbf{h}\\mathbf{s}$。目标是基于从扩展哈密顿量进行的原理性推导，在各向异性压力耦合下更新 $\\mathbf{h}$，并对 $\\mathbf{h}$ 施加一个约束（上三角形式），以避免非物理性的旋转，同时保持对物理系综的正确采样。\n\n起点与要求：\n- 从基本原理出发：牛顿定律和为恒压器引入的扩展哈密顿框架，特别是 Parrinello–Rahman 方案。使用体积 $V = \\det(\\mathbf{h})$、内部柯西应力 $\\mathbf{P}_{\\mathrm{int}}$ 和外部目标压力 $P_{\\mathrm{ext}}$ 的定义。各向异性耦合允许 $\\mathbf{P}_{\\mathrm{int}}$ 的所有独立分量作用于 $\\mathbf{h}$。\n- 从这些原理推导出 $\\mathbf{h}$ 的运动方程，并设计一个离散时间算法来更新 $\\mathbf{h}$。该更新必须正确反映各向异性耦合，并且必须能通过标准的时间积分方法（例如，速度-Verlet 算法）实现，而不依赖于启发式捷径。\n- 在每个更新步骤之后，将 $\\mathbf{h}$ 约束为上三角形式，以消除纯旋转，否则这些旋转会累积并导致模拟盒子的非物理性全局旋转。施加约束的方式必须能保持对物理系综的正确采样。刚性旋转是一种规范自由度；确保约束不会改变具有物理意义的可观测量分布。明确解释如何处理消除旋转的影响，以使粒子间距离在该规范操作下保持不变。\n- 用明确的单位定义所有物理量。一致地使用国际单位制（SI）：长度单位为米（m），时间单位为秒（s），质量单位为千克（kg），压力单位为帕斯卡（Pa），角度单位为弧度。\n\n程序中需要编码的实现细节：\n- 使用类似速度-Verlet的方案实现 $\\mathbf{h}$ 的各向异性更新。为恒压器的自由度使用一个虚构的标量质量参数 $W$，单位为千克。$\\mathbf{h}$ 的加速度必须由内部应力 $\\mathbf{P}_{\\mathrm{int}}$ 和外部目标 $P_{\\mathrm{ext}}\\mathbf{I}$ 之间的不匹配驱动，并由体积和 $\\mathbf{h}$ 的逆转置矩阵进行适当缩放。不要在问题陈述中使用任何捷径公式；您在解答中的推导必须为所实现的更新提供依据。\n- 更新 $\\mathbf{h}$ 后，应用正交-三角分解来分离出旋转。将 $\\mathbf{h}$ 约束为上三角矩阵并确保其为右手系。解释如何通过在消除的旋转下适当地变换坐标来保持物理采样，并在需要时在程序中编码此变换，以证明粒子间距离的不变性。\n- 为保证数值稳定性，请确保稳健地处理行列式，并确保受约束的 $\\mathbf{h}$ 保持非奇异和右手系。所有矩阵运算必须使用双精度浮点算术实现。\n\n测试套件：\n提供一组覆盖不同物理状态和边界条件的五个测试用例。程序必须为每个用例计算所要求的量：\n\n1. 各向同性零不匹配（理想路径）：\n   - $\\mathbf{h}_0 = \\mathrm{diag}(3\\times 10^{-9}\\,\\mathrm{m},\\,3\\times 10^{-9}\\,\\mathrm{m},\\,3\\times 10^{-9}\\,\\mathrm{m})$。\n   - $\\dot{\\mathbf{h}}_0 = \\mathbf{0}$。\n   - $P_{\\mathrm{ext}} = 1.0\\times 10^{8}\\,\\mathrm{Pa}$。\n   - $\\mathbf{P}_{\\mathrm{int}} = P_{\\mathrm{ext}}\\,\\mathbf{I}$。\n   - $W = 1.0\\times 10^{-22}\\,\\mathrm{kg}$。\n   - $\\Delta t = 1.0\\times 10^{-14}\\,\\mathrm{s}$。\n   - 输出量：体积比 $\\det(\\mathbf{h}_{\\mathrm{final}})/\\det(\\mathbf{h}_0)$，以浮点数形式表示。\n\n2. 各向异性对角不匹配：\n   - $\\mathbf{h}_0 = \\mathrm{diag}(3\\times 10^{-9}\\,\\mathrm{m},\\,3\\times 10^{-9}\\,\\mathrm{m},\\,3\\times 10^{-9}\\,\\mathrm{m})$。\n   - $\\dot{\\mathbf{h}}_0 = \\mathbf{0}$。\n   - $P_{\\mathrm{ext}} = 1.0\\times 10^{8}\\,\\mathrm{Pa}$。\n   - $\\mathbf{P}_{\\mathrm{int}} = \\mathrm{diag}(1.5\\times 10^{8},\\,0.7\\times 10^{8},\\,1.1\\times 10^{8})\\,\\mathrm{Pa}$。\n   - $W = 1.0\\times 10^{-22}\\,\\mathrm{kg}$。\n   - $\\Delta t = 1.0\\times 10^{-14}\\,\\mathrm{s}$。\n   - 输出量：体积比 $\\det(\\mathbf{h}_{\\mathrm{final}})/\\det(\\mathbf{h}_0)$，以浮点数形式表示。\n\n3. 纯剪切不匹配及旋转移除下的不变性：\n   - $\\mathbf{h}_0 = \\mathrm{diag}(3\\times 10^{-9}\\,\\mathrm{m},\\,3\\times 10^{-9}\\,\\mathrm{m},\\,3\\times 10^{-9}\\,\\mathrm{m})$。\n   - $\\dot{\\mathbf{h}}_0 = \\mathbf{0}$。\n   - $P_{\\mathrm{ext}} = 1.0\\times 10^{8}\\,\\mathrm{Pa}$。\n   - $\\mathbf{P}_{\\mathrm{int}} = P_{\\mathrm{ext}}\\,\\mathbf{I} + \\begin{bmatrix}0  4.0\\times 10^{7}  0\\\\ 4.0\\times 10^{7}  0  0\\\\ 0  0  0\\end{bmatrix}\\,\\mathrm{Pa}$（$x$-$y$ 平面内的对称剪切）。\n   - $W = 1.0\\times 10^{-22}\\,\\mathrm{kg}$。\n   - $\\Delta t = 1.0\\times 10^{-14}\\,\\mathrm{s}$。\n   - 两个分数坐标粒子：$\\mathbf{s}_1 = [0.1,\\,0.2,\\,0.3]^{\\top}$， $\\mathbf{s}_2 = [0.7,\\,0.5,\\,0.4]^{\\top}$（无量纲）。\n   - 在通过正交-三角投影进行更新和旋转移除后，通过移除的旋转对笛卡尔位置进行刚性旋转以表示规范变换。输出量：一个布尔值，指示粒子间距离 $\\|\\mathbf{r}_2 - \\mathbf{r}_1\\|$（单位米）是否在 $1.0\\times 10^{-12}\\,\\mathrm{m}$ 的绝对容差内保持不变。\n\n4. 非常重的恒压器（响应可忽略的边界情况）：\n   - $\\mathbf{h}_0 = \\mathrm{diag}(3\\times 10^{-9}\\,\\mathrm{m},\\,3\\times 10^{-9}\\,\\mathrm{m},\\,3\\times 10^{-9}\\,\\mathrm{m})$。\n   - $\\dot{\\mathbf{h}}_0 = \\mathbf{0}$。\n   - $P_{\\mathrm{ext}} = 1.0\\times 10^{8}\\,\\mathrm{Pa}$。\n   - $\\mathbf{P}_{\\mathrm{int}} = \\mathrm{diag}(1.3\\times 10^{8},\\,1.3\\times 10^{8},\\,1.3\\times 10^{8})\\,\\mathrm{Pa}$。\n   - $W = 1.0\\times 10^{-18}\\,\\mathrm{kg}$。\n   - $\\Delta t = 1.0\\times 10^{-14}\\,\\mathrm{s}$。\n   - 输出量：体积比 $\\det(\\mathbf{h}_{\\mathrm{final}})/\\det(\\mathbf{h}_0)$，以浮点数形式表示。\n\n5. 带有嵌入旋转的盒子（约束检查）：\n   - 构建 $\\mathbf{U} = \\begin{bmatrix}3.0\\times 10^{-9}  2.0\\times 10^{-10}  0\\\\ 0  2.5\\times 10^{-9}  2.0\\times 10^{-10}\\\\ 0  0  3.2\\times 10^{-9}\\end{bmatrix}$（上三角矩阵，长度单位为米）。\n   - 令 $\\theta = 0.2617993877991494$ 弧度（$15^{\\circ}$），并定义一个绕 $z$ 轴的旋转：$\\mathbf{Q}_{z} = \\begin{bmatrix}\\cos\\theta  -\\sin\\theta  0\\\\ \\sin\\theta  \\cos\\theta  0\\\\ 0  0  1\\end{bmatrix}$。\n   - 设置 $\\mathbf{h}_0 = \\mathbf{Q}_{z}\\,\\mathbf{U}$, $\\dot{\\mathbf{h}}_0 = \\mathbf{0}$, $\\mathbf{P}_{\\mathrm{int}} = P_{\\mathrm{ext}}\\,\\mathbf{I}$, $P_{\\mathrm{ext}} = 1.0\\times 10^{8}\\,\\mathrm{Pa}$, $W = 1.0\\times 10^{-22}\\,\\mathrm{kg}$, $\\Delta t = 1.0\\times 10^{-14}\\,\\mathrm{s}$。\n   - 输出量：一个布尔值，指示投影后受约束的 $\\mathbf{h}$ 在数值上是否为上三角矩阵，绝对容差为 $1.0\\times 10^{-16}$ 米。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含按五个测试用例顺序排列的结果，以逗号分隔并用方括号括起。例如，输出必须类似于“[result1,result2,result3,result4,result5]”。第一、第二和第四个条目必须是浮点数（体积比），第三和第五个条目必须是布尔值。不应打印任何其他文本。", "solution": "该问题要求为由矩阵 $\\mathbf{h} \\in \\mathbb{R}^{3 \\times 3}$ 表示的分子动力学模拟晶胞实现一种各向异性压力耦合方案。该实现必须从 Parrinello 和 Rahman 的扩展哈密顿框架推导而来，使用速度-Verlet方案进行积分，并包含一个约束以维持晶胞矩阵为上三角形式，从而防止非物理性旋转。\n\n### 步骤1：晶胞矩阵 $\\mathbf{h}$ 运动方程的推导\n\nParrinello-Rahman 恒压器将晶胞矩阵的元素作为动力学变量引入。粒子和恒压器系统的扩展拉格朗日量为：\n$$\n\\mathcal{L} = \\sum_{i=1}^{N} \\frac{1}{2}m_i \\dot{\\mathbf{r}}_i^T \\dot{\\mathbf{r}}_i - U(\\{\\mathbf{r}_i\\}) + \\frac{1}{2} W \\mathrm{Tr}(\\dot{\\mathbf{h}}^T \\dot{\\mathbf{h}}) - P_{\\mathrm{ext}} V\n$$\n其中 $\\mathbf{r}_i$ 是粒子笛卡尔坐标，$U$ 是粒子间势能，$W$ 是与恒压器自由度相关的虚构质量，$\\dot{\\mathbf{h}}$ 是晶胞矩阵的时间导数，$P_{\\mathrm{ext}}$ 是目标外部压力，$V = \\det(\\mathbf{h})$ 是晶胞体积。\n\n粒子坐标通过 $\\mathbf{r}_i = \\mathbf{h}\\mathbf{s}_i$ 与分数坐标 $\\mathbf{s}_i \\in [0,1)^3$ 相关联。粒子的动能可以用分数坐标表示：$\\dot{\\mathbf{r}}_i = \\dot{\\mathbf{h}}\\mathbf{s}_i + \\mathbf{h}\\dot{\\mathbf{s}}_i$。为了推导恒压器的运动方程，我们考虑势能项的贡献。\n\n对于一个通用坐标 $q$，欧拉-拉格朗日方程为 $\\frac{d}{dt}\\frac{\\partial\\mathcal{L}}{\\partial\\dot{q}} - \\frac{\\partial\\mathcal{L}}{\\partial q} = 0$。我们将其应用于晶胞矩阵的元素 $h_{\\alpha\\beta}$。\n\n恒压器的动能项为 $\\mathcal{K}_{\\mathrm{baro}} = \\frac{1}{2} W \\sum_{\\alpha,\\beta} (\\dot{h}_{\\alpha\\beta})^2$。对 $\\dot{\\mathbf{h}}$ 的导数为：\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial \\dot{\\mathbf{h}}} = W \\dot{\\mathbf{h}}\n$$\n其时间导数为：\n$$\n\\frac{d}{dt}\\left(\\frac{\\partial \\mathcal{L}}{\\partial \\dot{\\mathbf{h}}}\\right) = W \\ddot{\\mathbf{h}}\n$$\n拉格朗日量对 $\\mathbf{h}$ 的导数结合了来自内部势能 $U$ 和外部压力项 $P_{\\mathrm{ext}}V$ 的贡献。粒子施加在晶胞矩阵上的广义力由 $-\\frac{\\partial U}{\\partial \\mathbf{h}}$ 给出。可以证明这与内部压力张量 $\\mathbf{P}_{\\mathrm{int}}$ 相关，如下所示：\n$$\n-\\frac{\\partial U}{\\partial \\mathbf{h}} = V \\mathbf{P}_{\\mathrm{int}} (\\mathbf{h}^{-1})^T\n$$\n外部压力项的导数为：\n$$\n-\\frac{\\partial(-P_{\\mathrm{ext}}V)}{\\partial \\mathbf{h}} = P_{\\mathrm{ext}} \\frac{\\partial(\\det(\\mathbf{h}))}{\\partial \\mathbf{h}}\n$$\n使用雅可比公式，$\\frac{\\partial(\\det(\\mathbf{h}))}{\\partial \\mathbf{h}} = \\det(\\mathbf{h}) (\\mathbf{h}^{-1})^T = V (\\mathbf{h}^{-1})^T$。所以，该项变为 $P_{\\mathrm{ext}} V (\\mathbf{h}^{-1})^T$。\n\n合并各项，$\\mathbf{h}$ 的欧拉-拉格朗日方程为：\n$$\nW \\ddot{\\mathbf{h}} = V \\mathbf{P}_{\\mathrm{int}} (\\mathbf{h}^{-1})^T - P_{\\mathrm{ext}} V (\\mathbf{h}^{-1})^T\n$$\n这可以简化为晶胞矩阵的运动方程：\n$$\n\\ddot{\\mathbf{h}} = \\frac{V}{W} (\\mathbf{P}_{\\mathrm{int}} - P_{\\mathrm{ext}}\\mathbf{I}) (\\mathbf{h}^{-1})^T\n$$\n其中 $\\mathbf{I}$ 是 $3 \\times 3$ 单位矩阵。该方程决定了晶胞形状和大小如何响应内部应力张量与各向同性外部压力之间的不平衡而加速。\n\n### 步骤2：使用速度-Verlet进行离散时间积分\n\n为了数值上实现这个运动方程，我们使用离散时间步进算法。速度-Verlet算法因其稳定性和时间可逆性而成为一个合适的选择。对于单个时间步长 $\\Delta t$，给定 $\\mathbf{h}(t)$、$\\dot{\\mathbf{h}}(t)$ 和加速度 $\\ddot{\\mathbf{h}}(t)$，我们可以求出新的矩阵 $\\mathbf{h}(t+\\Delta t)$。对于本问题，假设内部压力 $\\mathbf{P}_{\\mathrm{int}}$ 在单个积分步内是恒定的。\n\n算法流程如下：\n1. 计算在时间 $t$ 的加速度，$\\mathbf{A}(t) = \\ddot{\\mathbf{h}}(t)$：\n   $$\n   \\mathbf{A}(t) = \\frac{\\det(\\mathbf{h}(t))}{W} (\\mathbf{P}_{\\mathrm{int}} - P_{\\mathrm{ext}}\\mathbf{I}) (\\mathbf{h}(t)^{-1})^T\n   $$\n2. 将速度更新到时间间隔的中点：\n   $$\n   \\dot{\\mathbf{h}}(t + \\Delta t/2) = \\dot{\\mathbf{h}}(t) + \\mathbf{A}(t) \\frac{\\Delta t}{2}\n   $$\n3. 将晶胞矩阵更新到时间间隔的末端：\n   $$\n   \\mathbf{h}(t + \\Delta t) = \\mathbf{h}(t) + \\dot{\\mathbf{h}}(t + \\Delta t/2) \\Delta t\n   $$\n结合这些步骤得到泰勒展开形式，该形式在实现中使用：\n$$\n\\mathbf{h}(t + \\Delta t) = \\mathbf{h}(t) + \\dot{\\mathbf{h}}(t) \\Delta t + \\frac{1}{2} \\mathbf{A}(t) (\\Delta t)^2\n$$\n\n### 步骤3：约束为上三角形式\n\n矩阵 $\\mathbf{h}$ 有 9 个自由度。然而，一个三斜晶胞的物理状态由 6 个参数（3 个长度和 3 个角度）定义。额外的 3 个自由度对应于整个模拟晶胞的刚性旋转，这是一种非物理性的全局运动。如果不加约束，数值积分可能导致此类旋转的累积。\n\n为了消除这种旋转规范自由度，我们在每个时间步之后将 $\\mathbf{h}$ 约束为上三角矩阵。这通过使用正交-三角分解，特别是QR分解来实现。设未约束的、更新后的晶胞矩阵为 $\\mathbf{h'}$。我们将其分解为：\n$$\n\\mathbf{h'} = \\mathbf{Q} \\mathbf{U}\n$$\n其中 $\\mathbf{Q}$ 是一个正交矩阵（$\\mathbf{Q}^T\\mathbf{Q} = \\mathbf{I}$），代表旋转部分，而 $\\mathbf{U}$ 是一个上三角矩阵，代表晶胞的固有形状和体积。新的、受约束的晶胞矩阵被设置为 $\\mathbf{h}_{\\mathrm{final}} = \\mathbf{U}$。\n\nQR分解不是唯一的。为确保一个唯一且具有物理意义的表示（一个右手坐标系），我们强制要求 $\\mathbf{U}$ 的所有对角元素必须为非负。如果一个标准的QR算法返回的 $\\mathbf{U}$ 具有负的对角元素 $U_{ii}$，我们可以通过将 $\\mathbf{U}$ 的第 $i$ 行和 $\\mathbf{Q}$ 的第 $i$ 列都乘以 $-1$ 来纠正。此过程产生一个新的、有效的分解 $\\mathbf{h'} = \\mathbf{Q'U'}$，其中 $\\mathbf{U'}$ 的所有对角元素均为非负，且 $\\det(\\mathbf{U'}) \\ge 0$。这个修正后的上三角矩阵 $\\mathbf{U'}$ 被作为最终的晶胞矩阵 $\\mathbf{h}_{\\mathrm{final}}$。\n\n此约束不改变被采样的物理系综。用于确定粒子间距离和角度的物理相关量是度规张量 $\\mathbf{G} = \\mathbf{h}^T\\mathbf{h}$。对于未约束和受约束的矩阵：\n$$\n\\mathbf{G'} = (\\mathbf{h'})^T \\mathbf{h'} = (\\mathbf{Q}\\mathbf{U})^T (\\mathbf{Q}\\mathbf{U}) = \\mathbf{U}^T \\mathbf{Q}^T \\mathbf{Q} \\mathbf{U} = \\mathbf{U}^T \\mathbf{U} = \\mathbf{h}_{\\mathrm{final}}^T \\mathbf{h}_{\\mathrm{final}}\n$$\n由于度规张量是不变的，所有从分数坐标导出的内部距离也是不变的。对于存在于绝对空间中的笛卡尔坐标，从晶胞矩阵中移除旋转（`h' -> U = Q^T h'`）必须伴随着对所有粒子位置和速度的反向旋转（`r -> Q^T r`, `v -> Q^T v`）以保持物理状态。两个粒子 $\\mathbf{r}_1$ 和 $\\mathbf{r}_2$ 之间距离在此变换下的不变性由以下公式证明：\n$$\n\\|\\mathbf{r}_2^{\\mathrm{new}} - \\mathbf{r}_1^{\\mathrm{new}}\\| = \\|\\mathbf{Q}^T\\mathbf{r}_2 - \\mathbf{Q}^T\\mathbf{r}_1\\| = \\|\\mathbf{Q}^T(\\mathbf{r}_2 - \\mathbf{r}_1)\\| = \\|\\mathbf{r}_2 - \\mathbf{r}_1\\|\n$$\n最后一步成立，因为像 $\\mathbf{Q}^T$ 这样的正交变换保持范数不变。此属性在测试用例3中进行了测试。", "answer": "```python\nimport numpy as np\nfrom scipy.linalg import qr\n\ndef solve():\n    \"\"\"\n    Implements and tests an anisotropic pressure coupling scheme for a Molecular Dynamics simulation cell.\n    \"\"\"\n\n    # Test cases as provided in the problem description.\n    # Each tuple contains: (h0, hdot0, Pext, Pint, W, dt, test_case_specific_data)\n    test_cases = [\n        # 1. Isotropic zero mismatch\n        (\n            np.diag([3e-9, 3e-9, 3e-9]),  # h0\n            np.zeros((3, 3)),            # hdot0\n            1.0e8,                       # Pext\n            np.diag([1.0e8, 1.0e8, 1.0e8]), # Pint\n            1.0e-22,                     # W\n            1.0e-14,                     # dt\n            {'type': 'volume_ratio'}\n        ),\n        # 2. Anisotropic diagonal mismatch\n        (\n            np.diag([3e-9, 3e-9, 3e-9]),\n            np.zeros((3, 3)),\n            1.0e8,\n            np.diag([1.5e8, 0.7e8, 1.1e8]),\n            1.0e-22,\n            1.0e-14,\n            {'type': 'volume_ratio'}\n        ),\n        # 3. Pure shear mismatch and invariance\n        (\n            np.diag([3e-9, 3e-9, 3e-9]),\n            np.zeros((3, 3)),\n            1.0e8,\n            np.diag([1.0e8, 1.0e8, 1.0e8]) + np.array([[0, 4.0e7, 0], [4.0e7, 0, 0], [0, 0, 0]]),\n            1.0e-22,\n            1.0e-14,\n            {\n                'type': 'distance_invariance',\n                's1': np.array([0.1, 0.2, 0.3]),\n                's2': np.array([0.7, 0.5, 0.4]),\n                'tol': 1.0e-12\n            }\n        ),\n        # 4. Very heavy barostat\n        (\n            np.diag([3e-9, 3e-9, 3e-9]),\n            np.zeros((3, 3)),\n            1.0e8,\n            np.diag([1.3e8, 1.3e8, 1.3e8]),\n            1.0e-18,\n            1.0e-14,\n            {'type': 'volume_ratio'}\n        ),\n        # 5. Box with an embedded rotation\n        (\n            np.array([\n                [np.cos(0.2617993877991494), -np.sin(0.2617993877991494), 0],\n                [np.sin(0.2617993877991494), np.cos(0.2617993877991494), 0],\n                [0, 0, 1]\n            ]) @ np.array([\n                [3.0e-9, 2.0e-10, 0],\n                [0, 2.5e-9, 2.0e-10],\n                [0, 0, 3.2e-9]\n            ]),\n            np.zeros((3, 3)),\n            1.0e8,\n            np.diag([1.0e8, 1.0e8, 1.0e8]),\n            1.0e-22,\n            1.0e-14,\n            {\n                'type': 'upper_triangular_check',\n                'tol': 1.0e-16\n            }\n        ),\n    ]\n\n    results = []\n\n    for h0, hdot0, Pext, Pint, W, dt, params in test_cases:\n        # Step 1: Calculate initial acceleration h_ddot(0)\n        V0 = np.linalg.det(h0)\n        P_mismatch = Pint - Pext * np.eye(3)\n        h0_inv_T = np.linalg.inv(h0).T\n        h_ddot0 = (V0 / W) * P_mismatch @ h0_inv_T\n\n        # Step 2: Update h using the velocity-Verlet position update formula\n        h_prime = h0 + hdot0 * dt + 0.5 * h_ddot0 * (dt**2)\n\n        # Step 3: Apply constraint via QR decomposition\n        Q, R = qr(h_prime)\n\n        # Enforce positive diagonal elements on R for uniqueness and right-handedness\n        diag_signs = np.diag(np.sign(np.diag(R)))\n        h_final = diag_signs @ R\n        Q_final = Q @ diag_signs\n        \n        # Step 4: Calculate the required output based on the test case\n        test_type = params['type']\n        \n        if test_type == 'volume_ratio':\n            V_final = np.linalg.det(h_final)\n            ratio = V_final / V0\n            results.append(ratio)\n\n        elif test_type == 'distance_invariance':\n            s1 = params['s1']\n            s2 = params['s2']\n            \n            # Cartesian positions with the unconstrained cell matrix h_prime\n            r1_prime = h_prime @ s1\n            r2_prime = h_prime @ s2\n            dist_prime = np.linalg.norm(r2_prime - r1_prime)\n\n            # Cartesian positions after counter-rotating by the removed rotation Q_final\n            r1_rotated = Q_final.T @ r1_prime\n            r2_rotated = Q_final.T @ r2_prime\n            dist_rotated = np.linalg.norm(r2_rotated - r1_rotated)\n            \n            is_invariant = np.isclose(dist_prime, dist_rotated, atol=params['tol'])\n            results.append(is_invariant)\n\n        elif test_type == 'upper_triangular_check':\n            tol = params['tol']\n            is_upper = (np.abs(h_final[1, 0])  tol and\n                        np.abs(h_final[2, 0])  tol and\n                        np.abs(h_final[2, 1])  tol)\n            results.append(is_upper)\n\n    # Format the final output string\n    # Convert booleans to lowercase 'true'/'false' as is standard\n    formatted_results = [str(r).lower() if isinstance(r, bool) else f\"{r:.15f}\" for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "3419429"}]}