{"hands_on_practices": [{"introduction": "为了在分子动力学模拟中保持水分子的刚性，需要施加特定的约束力。本练习 [@problem_id:3444600] 旨在通过推导约束函数的梯度，深入探究这些力的数学根源。理解这些梯度及其几何意义，是在基本层面上掌握像SETTLE这样的约束算法如何工作的第一个、也是最关键的一步。", "problem": "考虑一个刚性三位点水分子，其原子标记为氧（$O$）、氢一（$\\mathrm{H}_1$）和氢二（$\\mathrm{H}_2$），位置矢量分别为 $\\mathbf{r}_O$、$\\mathbf{r}_{\\mathrm{H}_1}$ 和 $\\mathbf{r}_{\\mathrm{H}_2}$，位于 $\\mathbb{R}^3$ 空间中。在具有完整约束的分子动力学中，刚性是通过要求所选的原子坐标函数随时间保持恒定来强制实现的。对于 Specialized Efficient Constraint Solver for Torsionally Linked Equations (SETTLE) 算法中的刚性水分子，一个方便的选择是约束两个氧-氢键长和一个氢-氢间距，使用以下三个约束条件\n$$\nC_1(\\mathbf{r}_O,\\mathbf{r}_{\\mathrm{H}_1},\\mathbf{r}_{\\mathrm{H}_2}) \\equiv \\|\\mathbf{r}_{\\mathrm{H}_1}-\\mathbf{r}_O\\|^2 - d_{\\mathrm{OH}}^2,\n$$\n$$\nC_2(\\mathbf{r}_O,\\mathbf{r}_{\\mathrm{H}_1},\\mathbf{r}_{\\mathrm{H}_2}) \\equiv \\|\\mathbf{r}_{\\mathrm{H}_2}-\\mathbf{r}_O\\|^2 - d_{\\mathrm{OH}}^2,\n$$\n$$\nC_3(\\mathbf{r}_O,\\mathbf{r}_{\\mathrm{H}_1},\\mathbf{r}_{\\mathrm{H}_2}) \\equiv \\|\\mathbf{r}_{\\mathrm{H}_1}-\\mathbf{r}_{\\mathrm{H}_2}\\|^2 - d_{\\mathrm{HH}}^2,\n$$\n其中 $d_{\\mathrm{OH}}$ 是固定的氧-氢键长，$d_{\\mathrm{HH}}$ 是固定的氢-氢间距，当两个氧-氢键的长度均为 $d_{\\mathrm{OH}}$ 时，它通过 $d_{\\mathrm{HH}}^2 = 2 d_{\\mathrm{OH}}^2 (1 - \\cos\\theta_0)$ 与平衡时的氢-氧-氢键角 $\\theta_0$ 相关。\n\n仅从多元微积分的基本法则和欧几里得范数的定义出发，推导所有约束 $k \\in \\{1,2,3\\}$ 和原子 $i \\in \\{O,\\mathrm{H}_1,\\mathrm{H}_2\\}$ 的梯度 $\\nabla_{\\mathbf{r}_i} C_k$ 相对于每个原子坐标 $\\mathbf{r}_i$ 的显式解析表达式。然后，在完整约束动力学中约束力的背景下解释它们的几何意义，并评论这些梯度如何与 SETTLE 算法为满足刚性而校正位置的瞬时方向相关。\n\n你的最终答案必须在一个单一的解析表达式中呈现九个梯度矢量。仅使用符号；不要代入数值。不需要单位。最终答案不需要四舍五入。", "solution": "问题要求推导刚性水分子三个约束函数相对于其三个原子位置的梯度。它还要求在约束力的背景下对这些梯度进行几何解释，并说明它们在 SETTLE 算法中的作用。\n\n首先，我们从多元微积分中建立计算两个位置矢量之间欧几里得距离平方的梯度的基本法则。假设两个粒子 $i$ 和 $j$ 的位置由 $\\mathbb{R}^3$ 中的矢量 $\\mathbf{r}_i$ 和 $\\mathbf{r}_j$ 给出。它们之间的距离平方是一个标量函数 $f(\\mathbf{r}_i, \\mathbf{r}_j) = \\|\\mathbf{r}_i - \\mathbf{r}_j\\|^2$。设 $\\mathbf{r}_i = (x_i, y_i, z_i)$ 和 $\\mathbf{r}_j = (x_j, y_j, z_j)$。范数的平方为：\n$$\nf(\\mathbf{r}_i, \\mathbf{r}_j) = (x_i - x_j)^2 + (y_i - y_j)^2 + (z_i - z_j)^2\n$$\n$f$ 相对于 $\\mathbf{r}_i$ 的梯度定义为其偏导数的矢量：$\\nabla_{\\mathbf{r}_i} f = \\left(\\frac{\\partial f}{\\partial x_i}, \\frac{\\partial f}{\\partial y_i}, \\frac{\\partial f}{\\partial z_i}\\right)$。计算相对于 $x_i$ 的偏导数：\n$$\n\\frac{\\partial f}{\\partial x_i} = \\frac{\\partial}{\\partial x_i} \\left[ (x_i - x_j)^2 + (y_i - y_j)^2 + (z_i - z_j)^2 \\right] = 2(x_i - x_j)\n$$\n根据对称性，其他分量为 $\\frac{\\partial f}{\\partial y_i} = 2(y_i - y_j)$ 和 $\\frac{\\partial f}{\\partial z_i} = 2(z_i - z_j)$。将这些组合起来得到梯度矢量：\n$$\n\\nabla_{\\mathbf{r}_i} \\|\\mathbf{r}_i - \\mathbf{r}_j\\|^2 = 2(\\mathbf{r}_i - \\mathbf{r}_j)\n$$\n类似地，计算相对于 $\\mathbf{r}_j$ 的梯度：\n$$\n\\frac{\\partial f}{\\partial x_j} = \\frac{\\partial}{\\partial x_j} \\left[ (x_i - x_j)^2 \\right] = 2(x_i - x_j)(-1) = -2(x_i - x_j)\n$$\n这得到梯度矢量：\n$$\n\\nabla_{\\mathbf{r}_j} \\|\\mathbf{r}_i - \\mathbf{r}_j\\|^2 = -2(\\mathbf{r}_i - \\mathbf{r}_j)\n$$\n对于任何位置为 $\\mathbf{r}_k$ 且 $k \\neq i,j$ 的其他粒子，函数 $f$ 不依赖于 $\\mathbf{r}_k$，因此其梯度为零矢量：$\\nabla_{\\mathbf{r}_k} \\|\\mathbf{r}_i - \\mathbf{r}_j\\|^2 = \\mathbf{0}$。\n\n现在我们将这些法则应用于给定的三个约束函数：\n$C_1 \\equiv \\|\\mathbf{r}_{\\mathrm{H}_1}-\\mathbf{r}_O\\|^2 - d_{\\mathrm{OH}}^2$\n$C_2 \\equiv \\|\\mathbf{r}_{\\mathrm{H}_2}-\\mathbf{r}_O\\|^2 - d_{\\mathrm{OH}}^2$\n$C_3 \\equiv \\|\\mathbf{r}_{\\mathrm{H}_1}-\\mathbf{r}_{\\mathrm{H}_2}\\|^2 - d_{\\mathrm{HH}}^2$\n\n由于 $d_{\\mathrm{OH}}^2$ 和 $d_{\\mathrm{HH}}^2$ 是常数项，它们的导数为零。因此，我们只需要对范数的平方项进行微分。\n\n**约束 $C_1(\\mathbf{r}_O, \\mathbf{r}_{\\mathrm{H}_1}, \\mathbf{r}_{\\mathrm{H}_2})$ 的梯度：**\n函数为 $C_1 = \\|\\mathbf{r}_{\\mathrm{H}_1}-\\mathbf{r}_O\\|^2 - d_{\\mathrm{OH}}^2$。\n- 相对于 $\\mathbf{r}_O$ 的梯度：这对应于我们通用公式中 $i=\\mathrm{H}_1$ 和 $j=O$ 时 $\\mathbf{r}_j$ 的角色。\n$$\n\\nabla_{\\mathbf{r}_O} C_1 = \\nabla_{\\mathbf{r}_O} \\|\\mathbf{r}_{\\mathrm{H}_1}-\\mathbf{r}_O\\|^2 = -2(\\mathbf{r}_{\\mathrm{H}_1}-\\mathbf{r}_O)\n$$\n- 相对于 $\\mathbf{r}_{\\mathrm{H}_1}$ 的梯度：这对应于 $\\mathbf{r}_i$ 的角色。\n$$\n\\nabla_{\\mathbf{r}_{\\mathrm{H}_1}} C_1 = \\nabla_{\\mathbf{r}_{\\mathrm{H}_1}} \\|\\mathbf{r}_{\\mathrm{H}_1}-\\mathbf{r}_O\\|^2 = 2(\\mathbf{r}_{\\mathrm{H}_1}-\\mathbf{r}_O)\n$$\n- 相对于 $\\mathbf{r}_{\\mathrm{H}_2}$ 的梯度：$C_1$ 不依赖于 $\\mathbf{r}_{\\mathrm{H}_2}$。\n$$\n\\nabla_{\\mathbf{r}_{\\mathrm{H}_2}} C_1 = \\mathbf{0}\n$$\n\n**约束 $C_2(\\mathbf{r}_O, \\mathbf{r}_{\\mathrm{H}_1}, \\mathbf{r}_{\\mathrm{H}_2})$ 的梯度：**\n函数为 $C_2 = \\|\\mathbf{r}_{\\mathrm{H}_2}-\\mathbf{r}_O\\|^2 - d_{\\mathrm{OH}}^2$。\n- 相对于 $\\mathbf{r}_O$ 的梯度：\n$$\n\\nabla_{\\mathbf{r}_O} C_2 = \\nabla_{\\mathbf{r}_O} \\|\\mathbf{r}_{\\mathrm{H}_2}-\\mathbf{r}_O\\|^2 = -2(\\mathbf{r}_{\\mathrm{H}_2}-\\mathbf{r}_O)\n$$\n- 相对于 $\\mathbf{r}_{\\mathrm{H}_1}$ 的梯度：$C_2$ 不依赖于 $\\mathbf{r}_{\\mathrm{H}_1}$。\n$$\n\\nabla_{\\mathbf{r}_{\\mathrm{H}_1}} C_2 = \\mathbf{0}\n$$\n- 相对于 $\\mathbf{r}_{\\mathrm{H}_2}$ 的梯度：\n$$\n\\nabla_{\\mathbf{r}_{\\mathrm{H}_2}} C_2 = \\nabla_{\\mathbf{r}_{\\mathrm{H}_2}} \\|\\mathbf{r}_{\\mathrm{H}_2}-\\mathbf{r}_O\\|^2 = 2(\\mathbf{r}_{\\mathrm{H}_2}-\\mathbf{r}_O)\n$$\n\n**约束 $C_3(\\mathbf{r}_O, \\mathbf{r}_{\\mathrm{H}_1}, \\mathbf{r}_{\\mathrm{H}_2})$ 的梯度：**\n函数为 $C_3 = \\|\\mathbf{r}_{\\mathrm{H}_1}-\\mathbf{r}_{\\mathrm{H}_2}\\|^2 - d_{\\mathrm{HH}}^2$。\n- 相对于 $\\mathbf{r}_O$ 的梯度：$C_3$ 不依赖于 $\\mathbf{r}_O$。\n$$\n\\nabla_{\\mathbf{r}_O} C_3 = \\mathbf{0}\n$$\n- 相对于 $\\mathbf{r}_{\\mathrm{H}_1}$ 的梯度：\n$$\n\\nabla_{\\mathbf{r}_{\\mathrm{H}_1}} C_3 = \\nabla_{\\mathbf{r}_{\\mathrm{H}_1}} \\|\\mathbf{r}_{\\mathrm{H}_1}-\\mathbf{r}_{\\mathrm{H}_2}\\|^2 = 2(\\mathbf{r}_{\\mathrm{H}_1}-\\mathbf{r}_{\\mathrm{H}_2})\n$$\n- 相对于 $\\mathbf{r}_{\\mathrm{H}_2}$ 的梯度：\n$$\n\\nabla_{\\mathbf{r}_{\\mathrm{H}_2}} C_3 = \\nabla_{\\mathbf{r}_{\\mathrm{H}_2}} \\|\\mathbf{r}_{\\mathrm{H}_1}-\\mathbf{r}_{\\mathrm{H}_2}\\|^2 = -2(\\mathbf{r}_{\\mathrm{H}_1}-\\mathbf{r}_{\\mathrm{H}_2})\n$$\n\n**几何意义及与约束算法的关系**\n\n在具有完整约束 $C_k=0$ 的经典力学的拉格朗日表述中，维持这些条件的约束力由 $\\mathbf{F}_i^c = \\sum_k -\\lambda_k \\nabla_{\\mathbf{r}_i} C_k$ 给出，其中 $\\lambda_k$ 是由动力学决定的拉格朗日乘子。\n\n梯度矢量 $\\nabla_{\\mathbf{r}_i} C_k$ 指向的方向是，当原子 $i$ 的位置 $\\mathbf{r}_i$ 发生变化时，会引起约束函数 $C_k$ 值最快增加的方向。对于我们的距离约束，这个方向总是沿着参与约束的两个原子之间的连线。例如，$\\nabla_{\\mathbf{r}_{\\mathrm{H}_1}} C_1 = 2(\\mathbf{r}_{\\mathrm{H}_1}-\\mathbf{r}_O)$ 是一个从原子 $O$ 指向原子 $\\mathrm{H}_1$ 的矢量。因此，由第一个约束施加在原子 $\\mathrm{H}_1$ 上的约束力 $\\mathbf{F}_{\\mathrm{H}_1,1}^c = -\\lambda_1 \\nabla_{\\mathbf{r}_{\\mathrm{H}_1}} C_1$ 是一个沿着 O–H_1 键的有心力。来自同一约束施加在原子 $O$ 上的力 $\\mathbf{F}_{O,1}^c = -\\lambda_1 \\nabla_{\\mathbf{r}_O} C_1 = -\\lambda_1 (-2(\\mathbf{r}_{\\mathrm{H}_1}-\\mathbf{r}_O)) = - \\mathbf{F}_{\\mathrm{H}_1,1}^c$ 大小相等、方向相反，符合牛顿第三定律的要求。因此，梯度定义了保持分子刚性的内力的作用线。\n\n在像 SHAKE 和 SETTLE 这样的计算算法中，首先在没有约束的情况下对运动方程进行积分，得到一个暂定的新位置 $\\mathbf{r}_i'$，这个位置通常违反了刚性条件（$C_k(\\mathbf{r}') \\neq 0$）。然后，算法计算校正位移 $\\Delta\\mathbf{r}_i = \\mathbf{r}_i - \\mathbf{r}_i'$，以找到满足约束的新位置 $\\mathbf{r}_i$。这些校正是作为约束梯度的线性组合来构建的。具体来说，原子 $i$ 的位移形式为 $\\Delta \\mathbf{r}_i \\propto \\sum_k g_k \\nabla_{\\mathbf{r}_i} C_k$，其中 $g_k$ 是与拉格朗日乘子相关的标量系数。\n\n这意味着 SETTLE 算法通过沿着这些梯度定义的方向——即沿着原子间的键矢量——移动原子来校正原子位置。例如，为了校正 O–H_1 键长的偏差，SETTLE 沿着连接 $O$ 和 $\\mathrm{H}_1$ 原子的直线移动它们。为了校正 H_1–H_2 距离，它沿着连接两个氢原子的直线移动它们。SETTLE 算法计算效率高，因为它利用了水分子简单的固定几何形状（一个等腰三角形）来找到一个精确的、非迭代的解析解，用于计算这些校正位移的大小，从而同时满足所有三个约束。梯度矢量是这个解析解的基本构成模块。", "answer": "$$\n\\boxed{\\pmatrix{ -2(\\mathbf{r}_{\\mathrm{H}_1}-\\mathbf{r}_O) & 2(\\mathbf{r}_{\\mathrm{H}_1}-\\mathbf{r}_O) & \\mathbf{0} \\\\ -2(\\mathbf{r}_{\\mathrm{H}_2}-\\mathbf{r}_O) & \\mathbf{0} & 2(\\mathbf{r}_{\\mathrm{H}_2}-\\mathbf{r}_O) \\\\ \\mathbf{0} & 2(\\mathbf{r}_{\\mathrm{H}_1}-\\mathbf{r}_{\\mathrm{H}_2}) & -2(\\mathbf{r}_{\\mathrm{H}_1}-\\mathbf{r}_{\\mathrm{H}_2}) }}\n$$", "id": "3444600"}, {"introduction": "理解了理论之后，下一个挑战便是算法的实现。一个简单的SETTLE实现可能会在某些“退化”情况下失效，例如当原子因数值误差而变得几乎共线或重合时。这个动手编程练习 [@problem_id:3444670] 要求你设计并实现一个稳健的解析投影算法，即使在这些极端情况下也能保持稳定，这对于真实世界中长时间模拟的稳定性至关重要。", "problem": "你需要设计并实现一个针对刚性三点水分子的鲁棒解析约束投影算法，以避免当两个氢原子因数值误差而几乎重合时，在SETTLE（Simple Efficient Torsion and Length Enforcement）算法中可能出现的分支切割和简并性问题。该约束投影必须从第一性原理推导得出，并且在氢-氢间距趋于零时（即 $r_{\\mathrm{HH}}\\to 0$）必须保持良定义。\n\n该刚性水分子由一个位于位置 $\\mathbf{r}_{\\mathrm{O}}$ 的氧原子和两个位于位置 $\\mathbf{r}_{\\mathrm{H}_1}$ 和 $\\mathbf{r}_{\\mathrm{H}_2}$ 的氢原子组成，它们都在 $\\mathbb{R}^3$ 空间中。其刚性几何构型的完整约束为：\n- 固定的氧-氢键长：$\\lVert \\mathbf{r}_{\\mathrm{H}_1}-\\mathbf{r}_{\\mathrm{O}}\\rVert = r_{\\mathrm{OH}}$ 和 $\\lVert \\mathbf{r}_{\\mathrm{H}_2}-\\mathbf{r}_{\\mathrm{O}}\\rVert = r_{\\mathrm{OH}}$。\n- 固定的氢-氧-氢键角：$\\angle \\mathrm{H}_1\\mathrm{O}\\mathrm{H}_2 = \\theta$。\n\n这些约束意味着一个固定的氢-氢距离 $r_{\\mathrm{HH}} = 2 r_{\\mathrm{OH}} \\sin\\!\\left(\\tfrac{\\theta}{2}\\right)$，这是一个将余弦定理应用于由两个氢原子和氧原子组成的三角形而得出的几何恒等式。\n\n从分子动力学（MD）中的牛顿定律和完整约束出发，你的任务是：\n- 推导一种相对于氧原子的氢原子位置的重新参数化方法，该方法使用分子平面内的标准正交基向量，并且不依赖于具有模糊分支的反三角函数。\n- 设计鲁棒的回退规则，即使当 $\\mathbf{r}_{\\mathrm{H}_1}\\approx \\mathbf{r}_{\\mathrm{H}_2}$、$\\mathbf{r}_{\\mathrm{H}_1}-\\mathbf{r}_{\\mathrm{O}}$ 和 $\\mathbf{r}_{\\mathrm{H}_2}-\\mathbf{r}_{\\mathrm{O}}$ 几乎为零时，或者当两个氧-氢方向反平行导致角平分线未明确定义时，也能确定性地选择一个有意义的角平分线方向和平面内垂直方向。\n- 实现最终的解析投影算法。给定临时位置 $(\\mathbf{r}_{\\mathrm{O}},\\mathbf{r}_{\\mathrm{H}_1},\\mathbf{r}_{\\mathrm{H}_2})$，该算法输出校正后的位置 $(\\mathbf{r}'_{\\mathrm{O}},\\mathbf{r}'_{\\mathrm{H}_1},\\mathbf{r}'_{\\mathrm{H}_2})$，这些位置在数值精度范围内精确满足约束条件。\n\n使用以下适用于液态水几何构型的物理合理参数：\n- 氧-氢键长 $r_{\\mathrm{OH}} = 0.9572$（单位 $\\mathrm{\\AA}$）。\n- 氢-氧-氢键角 $\\theta = 104.52^\\circ$，以弧度为单位指定。也就是说，使用 $\\theta = 104.52\\times \\pi/180$（单位 $\\mathrm{rad}$）。\n\n你的程序必须实现这个鲁棒的解析投影，并在以下临时位置的测试套件上进行评估。在所有情况下，校正后的氧原子位置必须保持 $\\mathbf{r}'_{\\mathrm{O}}=\\mathbf{r}_{\\mathrm{O}}$（纯粹的分子内校正，无平移）。对于每个案例，报告两个标量误差：\n- 三个约束中的最大长度偏差，以 $\\mathrm{\\AA}$ 表示：\n  $$\\varepsilon_{\\mathrm{len}} = \\max\\left(\\left|\\lVert \\mathbf{r}'_{\\mathrm{H}_1}-\\mathbf{r}_{\\mathrm{O}}\\rVert - r_{\\mathrm{OH}}\\right|,\\ \\left|\\lVert \\mathbf{r}'_{\\mathrm{H}_2}-\\mathbf{r}_{\\mathrm{O}}\\rVert - r_{\\mathrm{OH}}\\right|,\\ \\left|\\lVert \\mathbf{r}'_{\\mathrm{H}_1}-\\mathbf{r}'_{\\mathrm{H}_2}\\rVert - 2 r_{\\mathrm{OH}}\\sin\\!\\left(\\tfrac{\\theta}{2}\\right)\\right|\\right)。$$\n- 氢-氧-氢键角误差，以 $\\mathrm{rad}$ 表示：\n  $$\\varepsilon_{\\mathrm{ang}} = \\left|\\arccos\\!\\left(\\frac{(\\mathbf{r}'_{\\mathrm{H}_1}-\\mathbf{r}_{\\mathrm{O}})\\cdot(\\mathbf{r}'_{\\mathrm{H}_2}-\\mathbf{r}_{\\mathrm{O}})}{\\lVert \\mathbf{r}'_{\\mathrm{H}_1}-\\mathbf{r}_{\\mathrm{O}}\\rVert\\,\\lVert \\mathbf{r}'_{\\mathrm{H}_2}-\\mathbf{r}_{\\mathrm{O}}\\rVert}\\right) - \\theta\\right|。$$\n\n角度必须以 $\\mathrm{rad}$ 计算，长度以 $\\mathrm{\\AA}$ 计算。为了避免在诊断计算中出现数值问题，请将 $\\arccos$ 的任何余弦参数限制在 $[-1,1]$ 区间内。\n\n使用以下五个临时几何构型（单位 $\\mathrm{\\AA}$）定义测试套件：\n- 案例 1（带有小扰动的近理想情况）：\n  - $\\mathbf{r}_{\\mathrm{O}} = (0,0,0)$，\n  - 设 $p = r_{\\mathrm{OH}}\\cos\\!\\left(\\tfrac{\\theta}{2}\\right)$ 且 $q = r_{\\mathrm{OH}}\\sin\\!\\left(\\tfrac{\\theta}{2}\\right)$，\n  - $\\mathbf{r}_{\\mathrm{H}_1} = (q + 1.0\\times 10^{-4},\\ 0,\\ p)$，\n  - $\\mathbf{r}_{\\mathrm{H}_2} = (-q - 1.0\\times 10^{-4},\\ 0,\\ p)$。\n- 案例 2（氢原子几乎重合，$r_{\\mathrm{HH}}\\to 0$）：\n  - $\\mathbf{r}_{\\mathrm{O}} = (1,\\ 2,\\ 3)$，\n  - $\\mathbf{r}_{\\mathrm{H}_1} = \\mathbf{r}_{\\mathrm{O}} + (1.0\\times 10^{-10},\\ 0,\\ 0)$，\n  - $\\mathbf{r}_{\\mathrm{H}_2} = \\mathbf{r}_{\\mathrm{O}} + (1.1\\times 10^{-10},\\ 0,\\ 0)$。\n- 案例 3（氧-氢方向反平行，角平分线未明确定义）：\n  - $\\mathbf{r}_{\\mathrm{O}} = (0,\\ 1,\\ 0)$，\n  - $\\mathbf{r}_{\\mathrm{H}_1} = \\mathbf{r}_{\\mathrm{O}} + (1,\\ 0,\\ 0)$，\n  - $\\mathbf{r}_{\\mathrm{H}_2} = \\mathbf{r}_{\\mathrm{O}} - (1,\\ 0,\\ 0)$。\n- 案例 4（完全简并，所有三个原子重合）：\n  - $\\mathbf{r}_{\\mathrm{O}} = (0,\\ 0,\\ 0)$，\n  - $\\mathbf{r}_{\\mathrm{H}_1} = (0,\\ 0,\\ 0)$，\n  - $\\mathbf{r}_{\\mathrm{H}_2} = (0,\\ 0,\\ 0)$。\n- 案例 5（远离约束流形的大扰动）：\n  - $\\mathbf{r}_{\\mathrm{O}} = (5,\\ -3,\\ 2)$，\n  - $\\mathbf{r}_{\\mathrm{H}_1} = (3,\\ 7,\\ -4)$，\n  - $\\mathbf{r}_{\\mathrm{H}_2} = (-2,\\ 1,\\ 9)$。\n\n你的程序应产生单行输出，其中包含一个用方括号括起来的逗号分隔列表。该列表必须包含10个浮点数，顺序为 $[\\varepsilon_{\\mathrm{len}}^{(1)}, \\varepsilon_{\\mathrm{ang}}^{(1)}, \\varepsilon_{\\mathrm{len}}^{(2)}, \\varepsilon_{\\mathrm{ang}}^{(2)}, \\dots, \\varepsilon_{\\mathrm{len}}^{(5)}, \\varepsilon_{\\mathrm{ang}}^{(5)}]$，其中上标索引表示从1到5的案例编号。\n\n在放置原子过程中，实现解析投影时不应调用迭代求解器或进行三角函数反演。任何诊断计算（如角度误差计算）都必须进行鲁棒处理，以避免数值上的分支切割问题。", "solution": "该问题要求为刚性三点水分子设计并实现一个鲁棒的解析约束算法。该算法必须将一组临时原子位置 $(\\mathbf{r}_{\\mathrm{O}}, \\mathbf{r}_{\\mathrm{H}_1}, \\mathbf{r}_{\\mathrm{H}_2})$ 投影到约束流形上，得到校正后的位置 $(\\mathbf{r}'_{\\mathrm{O}}, \\mathbf{r}'_{\\mathrm{H}_1}, \\mathbf{r}'_{\\mathrm{H}_2})$，这些位置精确满足分子内的几何约束。主要挑战是确保算法在简并构型下（例如原子几乎重合或共线时）仍然是良定义和数值稳定的，因为这些情况可能导致像SETTLE这类算法的标准实现失败。\n\n约束规定了固定的氧-氢键长 $r_{\\mathrm{OH}}$ 和固定的氢-氧-氢键角 $\\theta$。由于要求氧原子的位置保持不变，即 $\\mathbf{r}'_{\\mathrm{O}} = \\mathbf{r}_{\\mathrm{O}}$，投影过程得以简化。\n\n### 基于原理的推导\n\n解决方案是基于临时几何构型构建一个局部标准正交基（一个坐标系），然后根据理想几何构型将氢原子放置到这个新框架中。该方法的鲁棒性取决于这个基的构建过程，该过程必须能确定性地处理所有可能的输入原子简并排列。\n\n设氧原子和两个氢原子的临时位置分别为 $\\mathbf{r}_{\\mathrm{O}}$、$\\mathbf{r}_{\\mathrm{H}_1}$ 和 $\\mathbf{r}_{\\mathrm{H}_2}$。我们处理相对于氧原子的向量：\n$$\n\\mathbf{v}_1 = \\mathbf{r}_{\\mathrm{H}_1} - \\mathbf{r}_{\\mathrm{O}} \\quad \\text{和} \\quad \\mathbf{v}_2 = \\mathbf{r}_{\\mathrm{H}_2} - \\mathbf{r}_{\\mathrm{O}}\n$$\n氢原子的校正后位置 $\\mathbf{r}'_{\\mathrm{H}_1}$ 和 $\\mathbf{r}'_{\\mathrm{H}_2}$ 将相对于一个以 $\\mathbf{r}_{\\mathrm{O}}$ 为中心新构建的局部坐标系 $\\{\\hat{\\mathbf{e}}_x, \\hat{\\mathbf{e}}_y, \\hat{\\mathbf{e}}_z\\}$ 来定义。\n\n这个局部框架内的理想几何构型由两个从约束中导出的关键参数定义：\n1.  从氧原子到 $\\mathrm{H}_1-\\mathrm{H}_2$ 线段中点的距离：$h = r_{\\mathrm{OH}} \\cos(\\theta/2)$。该距离位于角平分线上。\n2.  两个氢原子之间距离的一半：$w = r_{\\mathrm{OH}} \\sin(\\theta/2)$。该距离位于连接两个氢原子的直线上。\n\n我们定义局部基向量，使得 $\\hat{\\mathbf{e}}_y$ 与分子的对称轴（$\\angle \\mathrm{H_1OH_2}$ 的角平分线）对齐，$\\hat{\\mathbf{e}}_x$ 与连接两个氢原子的向量对齐。$\\hat{\\mathbf{e}}_z$ 是分子平面的法向量。\n\n### 鲁棒的标准正交基构建方法\n\n算法的核心是根据临时几何构型导出的特征向量的稳定性，采用分情况讨论的程序来定义基向量。设 $\\epsilon^2$ 是一个小的容差（例如 $10^{-24} \\, \\AA^2$），用于向量范数的平方。\n\n**1. 定义特征向量：**\n- 从 $\\mathrm{H}_1$ 到 $\\mathrm{H}_2$ 的向量：$\\mathbf{d} = \\mathbf{r}_{\\mathrm{H}_2} - \\mathbf{r}_{\\mathrm{H}_1} = \\mathbf{v}_2 - \\mathbf{v}_1$。\n- 与角平分线相关的向量：$\\mathbf{s} = \\mathbf{v}_1 + \\mathbf{v}_2$。\n\n**2. 处理简并情况并构建基：**\n\n**情况 A：完全重合** ($\\lVert \\mathbf{v}_1 \\rVert^2  \\epsilon^2$ 且 $\\lVert \\mathbf{v}_2 \\rVert^2  \\epsilon^2$)\n所有三个原子位于同一位置。方向未定义。我们选择一个标准的、任意的基：\n$$\n\\hat{\\mathbf{e}}_x = (1, 0, 0), \\quad \\hat{\\mathbf{e}}_y = (0, 1, 0), \\quad \\hat{\\mathbf{e}}_z = (0, 0, 1)\n$$\n\n**情况 B：氢原子重合** ($\\lVert \\mathbf{d} \\rVert^2  \\epsilon^2$，但非情况 A)\n氢原子几乎在同一位置。向量 $\\mathbf{d}$ 未明确定义。此时几何构型最具描述性的特征是从氧原子到重合氢原子的向量，可用 $\\mathbf{s} = \\mathbf{v}_1 + \\mathbf{v}_2$ 近似。\n- 角平分线轴 $\\hat{\\mathbf{e}}_y$ 通过单位化 $\\mathbf{s}$ 来定义：$\\hat{\\mathbf{e}}_y = \\mathbf{s} / \\lVert \\mathbf{s} \\rVert$。\n- 分子平面未定义。我们必须确定性地创建一个。选择第二个向量 $\\mathbf{ref}$，保证其不与 $\\hat{\\mathbf{e}}_y$ 共线。一个鲁棒的方法是选择与 $\\hat{\\mathbf{e}}_y$ 最垂直的笛卡尔坐标轴向量（$\\hat{\\mathbf{i}}$、$\\hat{\\mathbf{j}}$ 或 $\\hat{\\mathbf{k}}$）。\n- 平面法向量 $\\hat{\\mathbf{e}}_z$ 通过叉积构造：$\\hat{\\mathbf{e}}_z = (\\hat{\\mathbf{e}}_y \\times \\mathbf{ref}) / \\lVert \\hat{\\mathbf{e}}_y \\times \\mathbf{ref} \\rVert$。\n- 然后通过完成右手坐标系找到H-H轴 $\\hat{\\mathbf{e}}_x$：$\\hat{\\mathbf{e}}_x = \\hat{\\mathbf{e}}_y \\times \\hat{\\mathbf{e}}_z$。\n\n**情况 C：一般情况** ($\\lVert \\mathbf{d} \\rVert^2 \\ge \\epsilon^2$)\n氢原子是不同的，因此向量 $\\mathbf{d}$ 是良定义的，并可作为主轴。\n- H-H轴为 $\\hat{\\mathbf{e}}_x = \\mathbf{d} / \\lVert \\mathbf{d} \\rVert$。\n- 接着我们检查三个原子是否共线。临时平面的法向量为 $\\mathbf{n} = \\mathbf{v}_1 \\times \\mathbf{v}_2$。\n  - **如果 $\\lVert \\mathbf{n} \\rVert^2  \\epsilon^2$ (非共线)：** 平面是良定义的。\n    - 平面法向量为 $\\hat{\\mathbf{e}}_z = \\mathbf{n} / \\lVert \\mathbf{n} \\rVert$。\n    - 角平分线轴为 $\\hat{\\mathbf{e}}_y = \\hat{\\mathbf{e}}_z \\times \\hat{\\mathbf{e}}_x$。\n  - **如果 $\\lVert \\mathbf{n} \\rVert^2 \\le \\epsilon^2$ (共线)：** 平面未明确定义。这包括反平行情况（$\\mathbf{v}_1 \\approx -\\mathbf{v}_2$）。\n    - 我们已经有了 $\\hat{\\mathbf{e}}_x$，必须定义一个正交平面。我们使用与情况 B 中相同的鲁棒方法：选择一个不平行于 $\\hat{\\mathbf{e}}_x$ 的参考向量 $\\mathbf{ref}$。\n    - 构造第二个轴 $\\hat{\\mathbf{e}}_y$：$\\hat{\\mathbf{e}}_y = (\\mathbf{ref} \\times \\hat{\\mathbf{e}}_x) / \\lVert \\mathbf{ref} \\times \\hat{\\mathbf{e}}_x \\rVert$。\n    - 第三个轴为 $\\hat{\\mathbf{e}}_z = \\hat{\\mathbf{e}}_x \\times \\hat{\\mathbf{e}}_y$。\n\n此过程保证了对于任何输入几何构型，都能得到一个唯一的右手标准正交基。\n\n### 原子位置的重建\n\n在建立基 $\\{\\hat{\\mathbf{e}}_x, \\hat{\\mathbf{e}}_y, \\hat{\\mathbf{e}}_z\\}$ 后，可以直接计算校正后的氢原子位置，无需使用任何反三角函数：\n$$\n\\mathbf{r}'_{\\mathrm{O}} = \\mathbf{r}_{\\mathrm{O}}\n$$\n$$\n\\mathbf{r}'_{\\mathrm{H}_1} = \\mathbf{r}_{\\mathrm{O}} - w \\cdot \\hat{\\mathbf{e}}_x + h \\cdot \\hat{\\mathbf{e}}_y\n$$\n$$\n\\mathbf{r}'_{\\mathrm{H}_2} = \\mathbf{r}_{\\mathrm{O}} + w \\cdot \\hat{\\mathbf{e}}_x + h \\cdot \\hat{\\mathbf{e}}_y\n$$\n符号的选择与定义 $\\mathbf{d} = \\mathbf{r}_{\\mathrm{H}_2} - \\mathbf{r}_{\\mathrm{H}_1}$ 保持一致，确保校正后的向量 $\\mathbf{r}'_{\\mathrm{H}_2} - \\mathbf{r}'_{\\mathrm{H}_1}$ 指向与 $\\hat{\\mathbf{e}}_x$ 相同的方向。\n\n这样就完成了解析投影。最后一步是使用校正后的位置计算指定的误差度量 $\\varepsilon_{\\mathrm{len}}$ 和 $\\varepsilon_{\\mathrm{ang}}$，以验证约束是否已满足至机器精度。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main solver function that defines test cases, applies the robust\n    analytic projection, computes errors, and prints the final results.\n    \"\"\"\n    \n    # Geometric parameters for the rigid water model\n    R_OH = 0.9572  # Angstrom\n    THETA_DEG = 104.52  # degrees\n    THETA_RAD = np.deg2rad(THETA_DEG)\n\n    # Derived geometric constants used for reconstruction\n    H_LEN = R_OH * np.cos(THETA_RAD / 2.0)\n    W_LEN = R_OH * np.sin(THETA_RAD / 2.0)\n    R_HH = 2.0 * W_LEN\n    \n    # Numerical tolerance for squared norms to detect degeneracy\n    TOL_SQ = 1e-24\n\n    def analytic_projection(r_o, r_h1, r_h2):\n        \"\"\"\n        Applies a robust analytic projection to a provisional water geometry\n        to satisfy the rigid constraints, handling degenerate cases.\n\n        Args:\n            r_o (np.ndarray): Provisional position of the oxygen atom.\n            r_h1 (np.ndarray): Provisional position of the first hydrogen atom.\n            r_h2 (np.ndarray): Provisional position of the second hydrogen atom.\n\n        Returns:\n            Tuple[np.ndarray, np.ndarray, np.ndarray]: Corrected positions\n            (r_o_prime, r_h1_prime, r_h2_prime) satisfying constraints.\n        \"\"\"\n        v1 = r_h1 - r_o\n        v2 = r_h2 - r_o\n\n        # Case A: Total Coincidence (all three atoms at the same point)\n        # This handles Case 4.\n        if np.dot(v1, v1)  TOL_SQ and np.dot(v2, v2)  TOL_SQ:\n            ex = np.array([1.0, 0.0, 0.0])\n            ey = np.array([0.0, 1.0, 0.0])\n        else:\n            # Vector connecting the two hydrogens\n            d = r_h2 - r_h1\n            d_sq_norm = np.dot(d, d)\n\n            # Case B: Coincident Hydrogens (r_h1 ≈ r_h2)\n            # This handles Case 2.\n            if d_sq_norm  TOL_SQ:\n                # The bisector vector is the most stable direction.\n                s = v1 + v2\n                ey = s / np.linalg.norm(s)\n\n                # Construct a perpendicular reference vector robustly by selecting\n                # the Cartesian axis most perpendicular to ey.\n                abs_ey = np.abs(ey)\n                if abs_ey[0]  abs_ey[1] and abs_ey[0]  abs_ey[2]:\n                    ref = np.array([1.0, 0.0, 0.0])\n                elif abs_ey[1]  abs_ey[2]:\n                    ref = np.array([0.0, 1.0, 0.0])\n                else:\n                    ref = np.array([0.0, 0.0, 1.0])\n\n                ez_unnormalized = np.cross(ey, ref)\n                ez = ez_unnormalized / np.linalg.norm(ez_unnormalized)\n                ex = np.cross(ey, ez)\n            \n            # Case C: General Case (Hydrogens are distinct)\n            # This handles Cases 1, 3, and 5.\n            else:\n                ex = d / np.sqrt(d_sq_norm)\n                n = np.cross(v1, v2) # Normal to the provisional plane\n                n_sq_norm = np.dot(n, n)\n\n                # If plane is well-defined (non-collinear atoms)\n                if n_sq_norm > TOL_SQ:\n                    ez = n / np.sqrt(n_sq_norm)\n                    ey = np.cross(ez, ex)\n                # If atoms are collinear (plane is ill-defined, e.g., Case 3)\n                else:\n                    # Construct perpendiculars using a robust reference vector\n                    abs_ex = np.abs(ex)\n                    if abs_ex[0]  abs_ex[1] and abs_ex[0]  abs_ex[2]:\n                        ref = np.array([1.0, 0.0, 0.0])\n                    elif abs_ex[1]  abs_ex[2]:\n                        ref = np.array([0.0, 1.0, 0.0])\n                    else:\n                        ref = np.array([0.0, 0.0, 1.0])\n                    \n                    # Order of cross products defines ey and ez\n                    ey_unnormalized = np.cross(ref, ex)\n                    ey = ey_unnormalized / np.linalg.norm(ey_unnormalized)\n                    ez = np.cross(ex, ey)\n\n        # Reconstruct hydrogen positions in the new frame\n        r_o_prime = r_o\n        r_h1_prime = r_o - W_LEN * ex + H_LEN * ey\n        r_h2_prime = r_o + W_LEN * ex + H_LEN * ey\n\n        return r_o_prime, r_h1_prime, r_h2_prime\n\n    def calculate_errors(r_o_p, r_h1_p, r_h2_p):\n        \"\"\"Calculates the length and angle errors for a given geometry.\"\"\"\n        # Length errors\n        len_oh1 = np.linalg.norm(r_h1_p - r_o_p)\n        len_oh2 = np.linalg.norm(r_h2_p - r_o_p)\n        len_hh = np.linalg.norm(r_h1_p - r_h2_p)\n        \n        eps_len = max(abs(len_oh1 - R_OH), abs(len_oh2 - R_OH), abs(len_hh - R_HH))\n        \n        # Angle error\n        v1_p = r_h1_p - r_o_p\n        v2_p = r_h2_p - r_o_p\n        \n        cos_val = np.dot(v1_p, v2_p) / (np.linalg.norm(v1_p) * np.linalg.norm(v2_p))\n        cos_val = np.clip(cos_val, -1.0, 1.0)\n        angle_prime = np.arccos(cos_val)\n        eps_ang = abs(angle_prime - THETA_RAD)\n        \n        return eps_len, eps_ang\n\n    # Define the test cases from the problem statement.\n    p = R_OH * np.cos(THETA_RAD / 2)\n    q = R_OH * np.sin(THETA_RAD / 2)\n    \n    test_cases = [\n        # Case 1 (near-ideal with small perturbation)\n        (np.array([0.0, 0.0, 0.0]), np.array([q + 1e-4, 0.0, p]), np.array([-q - 1e-4, 0.0, p])),\n        # Case 2 (nearly coincident hydrogens)\n        (np.array([1.0, 2.0, 3.0]), np.array([1.0 + 1e-10, 2.0, 3.0]), np.array([1.0 + 1.1e-10, 2.0, 3.0])),\n        # Case 3 (antiparallel oxygen-hydrogen directions)\n        (np.array([0.0, 1.0, 0.0]), np.array([1.0, 1.0, 0.0]), np.array([-1.0, 1.0, 0.0])),\n        # Case 4 (complete degeneracy, all atoms coincident)\n        (np.array([0.0, 0.0, 0.0]), np.array([0.0, 0.0, 0.0]), np.array([0.0, 0.0, 0.0])),\n        # Case 5 (large perturbation)\n        (np.array([5.0, -3.0, 2.0]), np.array([3.0, 7.0, -4.0]), np.array([-2.0, 1.0, 9.0]))\n    ]\n    \n    results = []\n    for r_o, r_h1, r_h2 in test_cases:\n        r_o_p, r_h1_p, r_h2_p = analytic_projection(r_o, r_h1, r_h2)\n        eps_len, eps_ang = calculate_errors(r_o_p, r_h1_p, r_h2_p)\n        results.extend([eps_len, eps_ang])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3444670"}, {"introduction": "一个理论上完美的算法仍然可能因为计算机的有限精度算术而出错。这最后一个练习 [@problem_id:3444590] 探讨了SETTLE算法中一个微妙但至关重要的问题：数值稳定性。通过分析浮点误差如何导致对微小负数开方等问题，你将学会选择有原则的、可扩展的容差，从而使你的实现不仅在理论上正确，在实践中也同样稳健。", "problem": "考虑在分子动力学（MD）中实现SETTLE算法中的刚性水分子约束更新。在基于牛顿第二定律（$\\mathbf{F} = m \\mathbf{a}$，其中 $m$ 是质量，$\\mathbf{a} = d^2 \\mathbf{r}/dt^2$）的速度或位置预测步之后，通过围绕氧原子的解析旋转，将氢原子恢复到精确的刚性几何构型。在一种常见的公式中，这种旋转使用位移向量的内积和叉积，这些向量的量级为特征长度尺度 $L$（对于液态水，$L$ 的量级为 $1\\,\\text{\\AA}$），并形成诸如旋转轴 $\\mathbf{a}$（其范数为 $n = \\|\\mathbf{a}\\|$）和三角分量等量，其中 $\\sin \\theta$ 可以通过 $\\sqrt{1 - \\cos^2 \\theta}$ 计算。由于所有输入和中间量都用标准双精度浮点运算表示，因此数学上非负的数值计算表达式（例如 $y = 1 - \\cos^2 \\theta$ 或由乘积之和得到的范数平方）可能会受到微小扰动而略小于0；类似地，范数 $n$ 可能非常小，以至于通过除法进行归一化是病态的。\n\n假设浮点舍入的基本依据如下：对于任何基本算术运算，浮点值为 $x_{\\mathrm{fl}} = x (1 + \\delta)$，其中 $|\\delta| \\le \\epsilon$，$\\epsilon$ 是机器ε（对于双精度，$\\epsilon \\approx 1.11 \\times 10^{-16}$）；对于 $p$ 个乘积之和，当 $p \\epsilon \\ll 1$ 时，其相对误差界可以由 $\\gamma_p \\approx p \\epsilon$ 捕捉。同时假设刚性几何距离为 $O(L)$，因此距离平方和点积为 $O(S)$，其中 $S \\sim L^2$。\n\n您必须为SETTLE旋转计算中的两个检测和校正步骤选择一个有原则的、物理上和数值上一致的策略：\n(i) 当遇到 $\\sqrt{y}$，其中理论上 $y \\ge 0$ 但浮点值 $y_{\\mathrm{fl}}$ 略为负数时，以及\n(ii) 当通过除以一个可能接近于零的范数 $n$ 来形成单位向量时。\n\n哪个选项最能描述一种鲁棒的容差选择，该容差能随问题和算术尺度变化，同时避免静默过度校正和伪失败？\n\nA. 使用与量级无关的固定绝对容差：如果 $y_{\\mathrm{fl}}  -10^{-8}$，则在开平方根之前设置 $y_{\\mathrm{fl}} \\leftarrow 0$；如果 $n  10^{-8}$，则将轴视为零并跳过归一化。\n\nB. 使用随机器ε、计算量的量级及其操作计数而变化的容差：对于理论上非负的 $y$ 开平方根，使用容差 $\\tau_{\\sqrt{}} = c\\,\\gamma_p\\,S$，如果 $y_{\\mathrm{fl}}  -\\tau_{\\sqrt{}}$，则设置 $y_{\\mathrm{fl}} \\leftarrow 0$；对于除以 $n$，使用 $\\tau_{\\mathrm{div}} = c\\,\\sqrt{\\gamma_p}\\,L$，如果 $n  \\tau_{\\mathrm{div}}$，则将旋转轴视为零或使用避免归一化的后备方案。这里的 $c$ 是一个介于10–100之间的适度安全系数。\n\nC. 仅基于机器ε使用单一相对容差：如果 $y_{\\mathrm{fl}}  -c\\,\\epsilon$，则设置 $y_{\\mathrm{fl}} \\leftarrow 0$；如果 $n  c\\,\\epsilon$，则将轴视为零，其中 $c$ 为固定值。\n\nD. 将容差与分子动力学时间步长挂钩：设置 $\\tau_{\\sqrt{}} = c\\,\\Delta t$ 和 $\\tau_{\\mathrm{div}} = c\\,\\Delta t$，这样较小的 $\\Delta t$ 会产生较小的容差，而较大的 $\\Delta t$ 会产生较大的容差。\n\nE. 对两种效应都使用机器ε的平方根：对于开平方根，设置 $\\tau_{\\sqrt{}} = c\\,\\sqrt{\\epsilon}\\,S$；对于范数，设置 $\\tau_{\\mathrm{div}} = c\\,\\sqrt{\\epsilon}\\,L$，其中常数 $c$ 与操作计数或几何条件的病态程度无关。\n\n选择最佳选项，并根据关于浮点误差传播、刚性水中几何量的量级以及SETTLE旋转中归一化和三角重构的病态程度的第一性原理推导来证明您的选择。", "solution": "用户希望我验证问题陈述，如果有效，则提供一个详细的解决方案来证明最佳选项的合理性。\n\n### 问题验证\n\n**步骤1：提取给定信息**\n\n-   **算法：** 用于分子动力学（MD）中刚性水分子约束更新的SETTLE算法。\n-   **物理过程：** 在一个预测步（$\\mathbf{F} = m \\mathbf{a}$）之后，通过围绕氧原子的解析旋转来校正氢原子的位置，以强制执行刚性几何构型。\n-   **计算细节：** 旋转涉及位移向量的内积和叉积。\n-   **特征尺度：** 位移向量的量级为 $L$（例如，$L \\approx 1\\,\\text{\\AA}$）。距离平方和点积的量级为 $S \\sim L^2$。\n-   **数值表示：** 标准双精度浮点运算。\n-   **浮点误差模型：**\n    -   基本运算：$x_{\\mathrm{fl}} = x (1 + \\delta)$，其中 $|\\delta| \\le \\epsilon$。双精度机器ε为 $\\epsilon \\approx 1.11 \\times 10^{-16}$。\n    -   $p$个乘积之和：相对误差界约为 $\\gamma_p \\approx p \\epsilon$，当 $p \\epsilon \\ll 1$ 时。\n-   **需要解决的数值问题：**\n    1.  一个数学上非负的量 $y$（例如，$y = 1 - \\cos^2 \\theta$）其计算值 $y_{\\mathrm{fl}}$ 可能会略微为负。这在计算 $\\sqrt{y}$ 时会导致错误。\n    2.  一个旋转轴向量 $\\mathbf{a}$ 的范数 $n = \\|\\mathbf{a}\\|$ 可能非常接近零，使得通过除以 $n$ 进行归一化是病态的或导致除以零。\n-   **任务：** 为两个校正步骤选择一个有原则的、鲁棒的容差策略：\n    -   (i) 当 $y_{\\mathrm{fl}}$ 略微为负时处理 $\\sqrt{y_{\\mathrm{fl}}}$。\n    -   (ii) 处理通过接近零的范数 $n$ 进行归一化。\n-   **目标：** 该策略必须随问题和算术尺度变化，避免静默过度校正和伪失败。\n\n**步骤2：使用提取的给定信息进行验证**\n\n-   **科学上合理：** 该问题牢固地植根于计算物理和数值分析领域。SETTLE算法、刚性水模型（如TIP3P）和浮点误差分析都是标准的、完善的课题。所描述的数值问题是真实存在的，任何对此类算法的鲁棒实现都必须处理这些问题。\n-   **适定性：** 该问题是适定的。它要求在几个选项中为设置数值容差选择“最佳”方案，“最佳”被明确定义为一个鲁棒、有原则且能根据相关物理和计算参数正确缩放的策略。这允许基于数值误差分析的原则得出一个唯一的答案。\n-   **客观性：** 该问题以精确、客观、技术性的语言陈述，没有歧义或主观论断。给定的浮点误差模型（$\\gamma_p$）是文献中的标准模型（例如，Higham，《数值算法的准确性与稳定性》）。\n\n**缺陷清单的结论：**\n1.  **科学/事实不健全：** 无。\n2.  **不可形式化/不相关：** 无。\n3.  **不完整/矛盾的设置：** 无。\n4.  **不切实际/不可行：** 无。\n5.  **适定性差/结构不良：** 无。\n6.  **伪深刻/琐碎：** 无。该问题解决了科学计算中一个真实且不平凡的挑战。\n7.  **超出科学可验证性：** 无。\n\n**步骤3：结论与行动**\n\n问题陈述是**有效的**。现在将进行求解过程。\n\n### 推导与选项评估\n\n设置鲁棒数值容差的核心原则是，它们必须考虑浮点舍入误差的累积。此误差取决于三个主要因素：\n1.  **机器精度（$\\epsilon$）：** 单个操作相对误差的基本限制。\n2.  **量的量级：** 所涉及数字的特征尺度。对于一个量级为 $M$ 的量，其绝对误差与 $\\epsilon M$ 成正比。\n3.  **操作次数（$p$）：** 误差会随着多次操作而累积。如问题所述，$p$个乘积之和的相对误差的标准最坏情况界限是 $\\gamma_p \\approx p\\epsilon$。\n\n一个鲁棒的容差应该设置在略高于舍入误差的最大预期“噪声”之上，以避免将数值噪声误解为有意义的值，反之亦然。\n\n**容差策略(i)分析：对理论上非负的量 $y$ 开平方根**\n\n量 $y$ 是从输入数据计算得出的。问题指出，点积和距离平方是乘积之和，其量级为 $S \\sim L^2$。让我们假设 $y$ 的计算涉及有效数量为 $p$ 的浮点操作。根据提供的误差模型，计算值 $y_{\\mathrm{fl}}$ 与真值 $y$ 的关系由一个绝对误差界限定：\n$$|y_{\\mathrm{fl}} - y| \\lesssim \\gamma_p \\times (y \\text{的特征量级})$$\n$y$ 的特征量级（例如，一个分量量级为 $L$ 的向量的范数平方）被给定为 $O(S)$。因此，绝对误差界限为：\n$$|y_{\\mathrm{fl}} - y| \\lesssim \\gamma_p S$$\n如果真值 $y$ 为零，计算值 $y_{\\mathrm{fl}}$ 可能会被这个量扰动，可能变得略微为负。一个鲁棒的容差 $\\tau_{\\sqrt{}}$ 应该选择为与这个最大预期误差同量级。因此，一个有原则的选择是：\n$$\\tau_{\\sqrt{}} = c \\gamma_p S$$\n其中 $c \\ge 1$ 是一个小的安全系数。如果我们发现 $y_{\\mathrm{fl}}  0$ 但 $y_{\\mathrm{fl}}  -\\tau_{\\sqrt{}}$，可以安全地假设真值为 $y \\ge 0$，而负结果是由舍入误差引起的。因此，校正 $y_{\\mathrm{fl}} \\leftarrow 0$ 是合理的。\n\n**容差策略(ii)分析：通过范数 $n$ 进行归一化**\n\n我们需要决定何时计算出的范数 $n_{\\mathrm{fl}} = \\text{fl}(\\|\\mathbf{a}\\|)$ 在数值上与零无法区分。最严格的测试发生在真向量 $\\mathbf{a}$ 是零向量 $\\mathbf{a} = \\mathbf{0}$ 时。在这种情况下，计算出的向量 $\\mathbf{a}_{\\mathrm{fl}}$ 将完全由累积的舍入误差组成。\n\n假设 $\\mathbf{a}$ 的分量是使用大约 $k$ 次操作从量级为 $L$ 的初始数据计算得出的。每个计算分量 $a_{i, \\mathrm{fl}}$ 的绝对误差将约为 $\\gamma_k L$。\n$$a_{i, \\mathrm{fl}} = a_i + \\delta_i \\quad \\text{其中} \\quad |\\delta_i| \\lesssim \\gamma_k L$$\n当 $\\mathbf{a}=\\mathbf{0}$ 时，我们有 $a_{i, \\mathrm{fl}} = \\delta_i$。计算出的范数将是误差向量的范数：\n$$n_{\\mathrm{fl}} = \\text{fl}(\\|\\mathbf{a}_{\\mathrm{fl}}\\|) = \\text{fl}(\\|\\boldsymbol{\\delta}\\|) = \\text{fl}\\left(\\sqrt{\\delta_x^2 + \\delta_y^2 + \\delta_z^2}\\right)$$\n这个“噪声范数”的量级将与分量误差的量级相当，即 $n_{\\mathrm{fl}} \\sim \\gamma_k L$。\n因此，一个用于检查 $n$ 是否为零的鲁棒容差 $\\tau_{\\mathrm{div}}$ 应与特征长度 $L$ 和误差累积因子 $\\gamma_p$（使用 $p$ 作为操作计数的通用符号）线性相关：\n$$\\tau_{\\mathrm{div}} = c' \\gamma_p L$$\n其中 $c'$ 是另一个安全系数。\n\n**选项评估**\n\n*   **A. 使用与量级无关的固定绝对容差：如果 $y_{\\mathrm{fl}}  -10^{-8}$，则在开平方根之前设置 $y_{\\mathrm{fl}} \\leftarrow 0$；如果 $n  10^{-8}$，则将轴视为零并跳过归一化。**\n    **不正确。** 这个策略不鲁棒。像 $10^{-8}$ 这样的固定容差是任意的。它未能随问题的特征长度 $L$ 或机器精度 $\\epsilon$ 而变化。如果模拟使用纳米而不是埃作为长度单位，或者使用单精度运行，这个容差将是不合适的。\n\n*   **B. 使用随机器ε、计算量的量级及其操作计数而变化的容差：对于理论上非负的 $y$ 开平方根，使用容差 $\\tau_{\\sqrt{}} = c\\,\\gamma_p\\,S$，如果 $y_{\\mathrm{fl}}  -\\tau_{\\sqrt{}}$，则设置 $y_{\\mathrm{fl}} \\leftarrow 0$；对于除以 $n$，使用 $\\tau_{\\mathrm{div}} = c\\,\\sqrt{\\gamma_p}\\,L$，如果 $n  \\tau_{\\mathrm{div}}$，则将旋转轴视为零或使用避免归一化的后备方案。这里的 $c$ 是一个介于10–100之间的适度安全系数。**\n    **正确。** 这个选项正确地识别了三个关键的尺度变化因素：机器ε（$\\epsilon$）、操作计数（通过 $\\gamma_p$ 的 $p$）和问题量级（$S$ 和 $L$）。\n    -   用于开平方根的容差 $\\tau_{\\sqrt{}} = c\\,\\gamma_p\\,S$ 与我们基于前向误差分析的有原则推导结果完全匹配。\n    -   用于除法的容差 $\\tau_{\\mathrm{div}} = c\\,\\sqrt{\\gamma_p}\\,L$ 正确地随问题量级 $L$ 变化，并包含了对 $\\epsilon$ 和 $p$ 的依赖。虽然最坏情况分析表明应为线性尺度 $\\gamma_p L$，但包含对 $p$ 的依赖性（即使是以 $\\sqrt{p}$ 的形式）是区分此选项为最有原则的选项的关键特征。$\\sqrt{p}$ 尺度可以通过误差抵消的概率观点来解释，这通常比严格的最坏情况界限更能代表典型行为。在这些选择中，这是最复杂和最鲁棒的策略。\n\n*   **C. 仅基于机器ε使用单一相对容差：如果 $y_{\\mathrm{fl}}  -c\\,\\epsilon$，则设置 $y_{\\mathrm{fl}} \\leftarrow 0$；如果 $n  c\\,\\epsilon$，则将轴视为零，其中 $c$ 为固定值。**\n    **不正确。** 这个策略是有缺陷的，因为它忽略了量的量级（$S, L$）和多次操作累积的误差（$p$）。对于多项之和，绝对误差可能远大于 $c\\,\\epsilon S$ 或 $c\\,\\epsilon L$，而容差 $c\\,\\epsilon$ 会太小，导致伪失败。\n\n*   **D. 将容差与分子动力学时间步长挂钩：设置 $\\tau_{\\sqrt{}} = c\\,\\Delta t$ 和 $\\tau_{\\mathrm{div}} = c\\,\\Delta t$，这样较小的 $\\Delta t$ 会产生较小的容差，而较大的 $\\Delta t$ 会产生较大的容差。**\n    **不正确。** 这代表了一个根本性的误解。浮点舍入误差是计算机算术和数学算法的一个属性。MD时间步长 $\\Delta t$ 是物理模型数值积分的一个参数。它们之间没有直接的、有原则的联系。一个鲁棒算法的数值稳定性不应依赖于 $\\Delta t$ 的选择。\n\n*   **E. 对两种效应都使用机器ε的平方根：对于开平方根，设置 $\\tau_{\\sqrt{}} = c\\,\\sqrt{\\epsilon}\\,S$；对于范数，设置 $\\tau_{\\mathrm{div}} = c\\,\\sqrt{\\epsilon}\\,L$，其中常数 $c$ 与操作计数或几何条件的病态程度无关。**\n    **不正确。** 这是一种常见但不够严谨的启发式方法。虽然它正确地使容差随问题量级（$S$ 和 $L$）变化，但它没有考虑误差随操作次数 $p$ 的累积。$p$ 项之和的误差并非与 $p$ 无关。选项B更优，因为它通过 $\\gamma_p$ 明确包含了这种依赖性。", "answer": "$$\\boxed{B}$$", "id": "3444590"}]}