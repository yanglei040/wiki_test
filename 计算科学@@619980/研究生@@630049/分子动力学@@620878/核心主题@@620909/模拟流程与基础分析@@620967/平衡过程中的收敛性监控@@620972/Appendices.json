{"hands_on_practices": [{"introduction": "在分析分子动力学轨迹时，一个常见的误解是样本数量等同于信息量。然而，由于时间的连续性，连续的样本点是高度相关的。本练习将指导您推导和应用积分自相关时间（IAT）和有效样本量（$N_{\\mathrm{eff}}$）的概念，这是量化轨迹真实统计价值的关键工具。通过这个练习[@problem_id:3405213]，您将学会如何评估模拟的统计效率，并据此规划所需的模拟时长。", "problem": "一个分子动力学 (MD) 平衡化模拟会生成一个可观测量（例如势能）的关联时间序列，该序列以均匀的时间间隔 $\\Delta t$ 采样。令 $X_{i}$ 表示在时间 $t_{i} = i \\Delta t$ 的样本，并假设在丢弃初始的瞬态过程后，该过程是平稳的。通过在非负延迟上对 $\\rho(t)$ 进行求和（或积分）的标准时域定义，来定义归一化自相关函数 $\\rho(t)$ 和积分自相关时间 (IAT) $\\tau_{\\mathrm{int}}$。从样本均值的定义 $\\bar{X} = \\frac{1}{N} \\sum_{i=1}^{N} X_{i}$ 以及用自协方差函数表示的关联数据的 $\\bar{X}$ 方差出发，通过将关联序列的 $\\mathrm{Var}(\\bar{X})$ 等同于 $\\sigma^{2}/N_{\\mathrm{eff}}$（其中 $\\sigma^{2}$ 是底层平稳过程的方差），推导有效样本量 $N_{\\mathrm{eff}}$ 关于 $N$、$\\Delta t$ 和 $\\tau_{\\mathrm{int}}$ 的表达式。然后，考虑一次 MD 模拟，其中归一化自相关函数可以很好地用单指数模型 $\\rho(t) = \\exp(-t/\\tau_{c})$ 来描述，对于该模型，IAT 等于相关时间，即 $\\tau_{\\mathrm{int}} = \\tau_{c}$。假设采样间隔为 $\\Delta t = 2\\,\\mathrm{fs}$，当前的生产阶段长度为 $T_{\\mathrm{cur}} = 3.000\\,\\mathrm{ns}$，对平衡部分的可靠分析得出 $\\tau_{c} = 18.7\\,\\mathrm{ps}$。你希望通过使用一个停止规则来监控平衡过程中的收敛，该规则要求达到目标有效样本量 $N_{\\mathrm{eff}}^{\\star} = 200$。基于你推导的表达式和指数模型，计算在 $T_{\\mathrm{cur}}$ 之外，为达到 $N_{\\mathrm{eff}}^{\\star}$ 所需的最小额外生产时间 $\\Delta T_{\\mathrm{add}}$。将你的最终数值答案四舍五入到四位有效数字，并以纳秒 (ns) 为单位表示。在你的推导中，从自相关和关联观测的样本均值方差的基本定义开始；不要假设任何快捷公式。", "solution": "该问题要求完成两个主要任务：首先，从基本原理出发，推导有效样本量 $N_{\\mathrm{eff}}$ 的表达式；其次，应用此表达式计算达到目标有效样本量所需的额外模拟时间。\n\n**第一部分：有效样本量 $N_{\\mathrm{eff}}$ 的推导**\n\n令 $X_i$ 为在时间 $t_i = i \\Delta t$（$i=1, 2, \\dots, N$）采样的平稳可观测量的值。样本均值 $\\bar{X}$ 定义为：\n$$\n\\bar{X} = \\frac{1}{N} \\sum_{i=1}^{N} X_{i}\n$$\n样本均值的方差由下式给出：\n$$\n\\mathrm{Var}(\\bar{X}) = \\mathrm{Var}\\left(\\frac{1}{N} \\sum_{i=1}^{N} X_{i}\\right) = \\frac{1}{N^2} \\mathrm{Var}\\left(\\sum_{i=1}^{N} X_{i}\\right)\n$$\n利用随机变量和的方差性质，我们有：\n$$\n\\mathrm{Var}\\left(\\sum_{i=1}^{N} X_{i}\\right) = \\sum_{i=1}^{N} \\sum_{j=1}^{N} \\mathrm{Cov}(X_i, X_j)\n$$\n对于一个平稳过程，协方差 $\\mathrm{Cov}(X_i, X_j)$ 仅取决于时间延迟 $|t_i - t_j| = |i-j|\\Delta t$。我们定义 $k$ 步离散延迟的自协方差函数为 $\\gamma_k = \\mathrm{Cov}(X_i, X_{i+k})$。过程的方差为 $\\sigma^2 = \\mathrm{Var}(X_i) = \\gamma_0$。由于平稳性，$\\gamma_k = \\gamma_{-k}$。我们可以通过将具有相同延迟 $k = |i-j|$ 的项分组来重写双重求和：\n$$\n\\sum_{i=1}^{N} \\sum_{j=1}^{N} \\mathrm{Cov}(X_i, X_j) = \\sum_{i=1}^{N} \\sum_{j=1}^{N} \\gamma_{|i-j|} = \\sum_{k=-(N-1)}^{N-1} (N-|k|) \\gamma_k\n$$\n这可以分解为 $k=0$、$k>0$ 和 $k<0$ 的项：\n$$\n\\sum_{k=-(N-1)}^{N-1} (N-|k|) \\gamma_k = (N-0)\\gamma_0 + \\sum_{k=1}^{N-1} (N-k)\\gamma_k + \\sum_{k=-(N-1)}^{-1} (N-|k|)\\gamma_k\n$$\n使用 $\\gamma_k = \\gamma_{-k}$，表达式变为：\n$$\nN\\gamma_0 + 2\\sum_{k=1}^{N-1} (N-k)\\gamma_k\n$$\n将此代回 $\\mathrm{Var}(\\bar{X})$ 的表达式中：\n$$\n\\mathrm{Var}(\\bar{X}) = \\frac{1}{N^2} \\left[ N\\gamma_0 + 2\\sum_{k=1}^{N-1} (N-k)\\gamma_k \\right] = \\frac{\\gamma_0}{N} \\left[ 1 + \\frac{2}{N}\\sum_{k=1}^{N-1} (N-k)\\frac{\\gamma_k}{\\gamma_0} \\right]\n$$\n延迟 $k$ 处的归一化自相关函数 (ACF) 为 $\\rho_k = \\gamma_k / \\gamma_0$。代入此式以及 $\\sigma^2=\\gamma_0$：\n$$\n\\mathrm{Var}(\\bar{X}) = \\frac{\\sigma^2}{N} \\left[ 1 + 2\\sum_{k=1}^{N-1} \\left(1-\\frac{k}{N}\\right)\\rho_k \\right]\n$$\n这个表达式是精确的。对于典型的 MD 模拟，总时间远长于相关时间，因此当 $k \\ll N$ 时，ACF $\\rho_k$ 会衰减到零。在此极限下，我们可以做两个近似：\n1.  对于 $\\rho_k$ 不可忽略的 $k$ 值，有 $k/N \\ll 1$，因此 $(1-k/N) \\approx 1$。\n2.  由于当 $k$ 很大时 $\\rho_k \\approx 0$，求和的上限可以从 $N-1$ 扩展到 $\\infty$。\n\n通过这些近似，方差变为：\n$$\n\\mathrm{Var}(\\bar{X}) \\approx \\frac{\\sigma^2}{N} \\left( 1 + 2\\sum_{k=1}^{\\infty} \\rho_k \\right)\n$$\n问题使用连续时间 ACF $\\rho(t)$ 来定义积分自相关时间 (IAT) $\\tau_{\\mathrm{int}}$：\n$$\n\\tau_{\\mathrm{int}} = \\int_0^\\infty \\rho(t) dt\n$$\n我们可以将离散和 $\\sum \\rho_k$ 与此积分联系起来。该积分可以使用步长为 $\\Delta t$ 的梯形法则通过求和来近似：\n$$\n\\tau_{\\mathrm{int}} = \\int_0^\\infty \\rho(t) dt \\approx \\Delta t \\left[ \\frac{1}{2}\\rho(0) + \\sum_{k=1}^{\\infty} \\rho(k \\Delta t) \\right]\n$$\n根据定义 $\\rho(0)=1$ 且 $\\rho_k = \\rho(k \\Delta t)$，我们得到：\n$$\n\\tau_{\\mathrm{int}} \\approx \\Delta t \\left( \\frac{1}{2} + \\sum_{k=1}^{\\infty} \\rho_k \\right)\n$$\n求解求和项：\n$$\n\\sum_{k=1}^{\\infty} \\rho_k \\approx \\frac{\\tau_{\\mathrm{int}}}{\\Delta t} - \\frac{1}{2}\n$$\n现在，将此代回我们对 $\\mathrm{Var}(\\bar{X})$ 的近似表达式中：\n$$\n\\mathrm{Var}(\\bar{X}) \\approx \\frac{\\sigma^2}{N} \\left( 1 + 2 \\left( \\frac{\\tau_{\\mathrm{int}}}{\\Delta t} - \\frac{1}{2} \\right) \\right) = \\frac{\\sigma^2}{N} \\left( 1 + \\frac{2\\tau_{\\mathrm{int}}}{\\Delta t} - 1 \\right) = \\frac{\\sigma^2}{N} \\left( \\frac{2\\tau_{\\mathrm{int}}}{\\Delta t} \\right)\n$$\n问题通过将关联均值的方差等同于 $N_{\\mathrm{eff}}$ 个独立样本均值的方差来定义有效样本量 $N_{\\mathrm{eff}}$：\n$$\n\\mathrm{Var}(\\bar{X}) = \\frac{\\sigma^2}{N_{\\mathrm{eff}}}\n$$\n通过比较 $\\mathrm{Var}(\\bar{X})$ 的两个表达式：\n$$\n\\frac{\\sigma^2}{N_{\\mathrm{eff}}} = \\frac{\\sigma^2}{N} \\frac{2\\tau_{\\mathrm{int}}}{\\Delta t}\n$$\n求解 $N_{\\mathrm{eff}}$ 可得：\n$$\nN_{\\mathrm{eff}} = \\frac{N \\Delta t}{2\\tau_{\\mathrm{int}}}\n$$\n由于 $T = N \\Delta t$ 是总模拟时间，最终的表达式是：\n$$\nN_{\\mathrm{eff}} = \\frac{T}{2\\tau_{\\mathrm{int}}}\n$$\n这就是所求的有效样本量关于 $N$、$\\Delta t$ 和 $\\tau_{\\mathrm{int}}$（或 $T$ 和 $\\tau_{\\mathrm{int}}$）的表达式。\n\n**第二部分：额外生产时间 $\\Delta T_{\\mathrm{add}}$ 的计算**\n\n我们给定 ACF 的单指数模型为 $\\rho(t) = \\exp(-t/\\tau_c)$，对于该模型，IAT 等于相关时间，即 $\\tau_{\\mathrm{int}} = \\tau_c$。我们推导的 $N_{\\mathrm{eff}}$ 公式变为：\n$$\nN_{\\mathrm{eff}} = \\frac{T}{2\\tau_c}\n$$\n目标是达到 $N_{\\mathrm{eff}}^{\\star} = 200$ 的目标有效样本量。令 $T_{\\mathrm{total}}$ 为实现此目标所需的总模拟时间。\n$$\nN_{\\mathrm{eff}}^{\\star} = \\frac{T_{\\mathrm{total}}}{2\\tau_c}\n$$\n我们可以求解 $T_{\\mathrm{total}}$：\n$$\nT_{\\mathrm{total}} = 2 N_{\\mathrm{eff}}^{\\star} \\tau_c\n$$\n给定的值为：\n-   $N_{\\mathrm{eff}}^{\\star} = 200$\n-   $\\tau_c = 18.7\\,\\mathrm{ps}$\n\n代入这些值：\n$$\nT_{\\mathrm{total}} = 2 \\times 200 \\times 18.7\\,\\mathrm{ps} = 400 \\times 18.7\\,\\mathrm{ps} = 7480\\,\\mathrm{ps}\n$$\n为了以纳秒表示，我们使用换算关系 $1\\,\\mathrm{ns} = 1000\\,\\mathrm{ps}$：\n$$\nT_{\\mathrm{total}} = 7480\\,\\mathrm{ps} \\times \\frac{1\\,\\mathrm{ns}}{1000\\,\\mathrm{ps}} = 7.480\\,\\mathrm{ns}\n$$\n当前的生产阶段长度为 $T_{\\mathrm{cur}} = 3.000\\,\\mathrm{ns}$。最小额外生产时间 $\\Delta T_{\\mathrm{add}}$ 是所需的总时间与当前时间之差：\n$$\n\\Delta T_{\\mathrm{add}} = T_{\\mathrm{total}} - T_{\\mathrm{cur}}\n$$\n$$\n\\Delta T_{\\mathrm{add}} = 7.480\\,\\mathrm{ns} - 3.000\\,\\mathrm{ns} = 4.480\\,\\mathrm{ns}\n$$\n问题要求将最终答案四舍五入到四位有效数字。我们的结果 $4.480\\,\\mathrm{ns}$ 已经是这种形式。采样间隔 $\\Delta t = 2\\,\\mathrm{fs}$ 对于理论推导是必需的，但一旦建立了公式 $N_{\\mathrm{eff}} = T/(2\\tau_{\\mathrm{int}})$，对于最终的数值计算则不是必需的。", "answer": "$$\n\\boxed{4.480}\n$$", "id": "3405213"}, {"introduction": "虽然单轨迹分析很有用，但它可能无法揭示伪收敛（即轨迹陷入了相空间的一个局部区域）。一个更稳健的方法是比较从不同初始条件（或速度）开始的多个独立副本。本练习[@problem_id:3405203]将介绍势能标度缩减因子（PSRF, 或 $\\hat{R}$），这是一种通过比较链内方差和链间方差来诊断收敛性的强大工具。您将从第一性原理出发，处理单变量和多变量情况，从而深入理解其统计基础。", "problem": "一个分子动力学平衡过程通过 $M$ 个独立的重复轨迹（从相同的构型开始，速度被独立地随机化）进行监控，以评估多个可观测量的收敛性。假设在每个轨迹的最后一段长度为 $n$ 个样本的区间内，每隔一个固定的时间间隔记录两个可观测量，从而为每个可观测量生成 $M=3$ 条链，每条链有 $n=20$ 个样本。记 $\\boldsymbol{\\mu}_m \\in \\mathbb{R}^2$ 为链 $m$ 中两个可观测量的样本均值向量，$\\mathbf{S}_m \\in \\mathbb{R}^{2 \\times 2}$ 为链 $m$ 的无偏链内样本协方差矩阵。三条重复链在最终分析窗口内产生以下汇总统计量：\n- 链均值：\n$$\n\\boldsymbol{\\mu}_1=\\begin{pmatrix}0.50 \\\\ 1.00\\end{pmatrix},\\quad\n\\boldsymbol{\\mu}_2=\\begin{pmatrix}0.62 \\\\ 0.96\\end{pmatrix},\\quad\n\\boldsymbol{\\mu}_3=\\begin{pmatrix}0.54 \\\\ 1.06\\end{pmatrix}.\n$$\n- 链内协方差矩阵：\n$$\n\\mathbf{S}_1=\\begin{pmatrix}0.050  0.012 \\\\ 0.012  0.042\\end{pmatrix},\\quad\n\\mathbf{S}_2=\\begin{pmatrix}0.048  0.009 \\\\ 0.009  0.039\\end{pmatrix},\\quad\n\\mathbf{S}_3=\\begin{pmatrix}0.052  0.011 \\\\ 0.011  0.041\\end{pmatrix}.\n$$\n假设在平衡状态下，所有链都以可观测量的相同平稳分布为目标，并且各重复是相互独立的。从独立重复之间和内部的方差分解第一性原理以及大数定律出发，推导以下表达式：\n1) 每个可观测量单独的单变量潜在尺度缩减因子（PSRF, $\\hat{R}$），使用边际方差的合并估计量与平均链内方差的比值。\n2) 二维可观测量的多变量 PSRF（记为 $\\hat{R}_{\\mathrm{multi}}$），通过合并方差估计量相对于合并链内协方差的最大广义特征值来定义。\n\n然后，根据给定数据计算单变量和多变量 $\\hat{R}$ 的数值。基于渐近一致性论证，指定在分子动力学平衡监测期间，可以用来宣布收敛的原则性停止阈值和随时间变化的趋势要求（例如，在最后 $n$ 个样本的连续、不重叠的窗口上）。您的阈值规范必须是无量纲的，并从方差比的解释中得到证明。\n\n最后，将上面数据计算出的多变量 $\\hat{R}_{\\mathrm{multi}}$ 作为您的答案报告。将最终值表示为一个无量纲数，并将您的答案四舍五入到四位有效数字。", "solution": "该问题要求推导和计算单变量和多变量潜在尺度缩减因子（PSRF），记为 $\\hat{R}$，作为分子动力学模拟收敛性的诊断指标。\n\n设 $M$ 为独立重复轨迹的数量，$n$ 为每个轨迹分析窗口中的样本数。给定 $M=3$ 和 $n=20$。对于每个轨迹 $m \\in \\{1, \\dots, M\\}$，我们有两个可观测量的样本均值向量 $\\boldsymbol{\\mu}_m$ 和样本协方差矩阵 $\\mathbf{S}_m$。\n\n**1. 单变量潜在尺度缩减因子 ($\\hat{R}$)**\n\n让我们考虑一个单一的可观测量，用 $k \\in \\{1, 2\\}$ 索引。均值向量 $\\boldsymbol{\\mu}_m$ 的相应分量是 $\\mu_{m,k}$，协方差矩阵 $\\mathbf{S}_m$ 的相应对角元素是 $S_{m,kk}$，即链 $m$ 中该可观测量​​的无偏样本方差。\n\n分析基于将总方差分解为链内和链间分量。\n\n平均链内方差 $W_k$ 是各个链方差的均值：\n$$W_k = \\frac{1}{M} \\sum_{m=1}^{M} S_{m,kk}$$\n\n链间方差 $B_k$ 衡量了各链样本均值的方差，并按样本量 $n$ 进行缩放：\n$$B_k = \\frac{n}{M-1} \\sum_{m=1}^{M} (\\mu_{m,k} - \\bar{\\mu}_k)^2$$\n其中 $\\bar{\\mu}_k = \\frac{1}{M} \\sum_{m=1}^{M} \\mu_{m,k}$ 是所有链上可观测量 $k$ 的总均值。\n\n可观测量的边际方差的合并估计量 $\\hat{V}_k$ 结合了这两个方差分量。它是链内方差和链均值方差的加权平均值：\n$$\\hat{V}_k = \\frac{n-1}{n} W_k + \\frac{1}{n} B_k$$\n因子 $\\frac{n-1}{n}$ 是对 $W_k$ 是有限样本的估计这一事实的修正。当链收敛到平稳分布时，$W_k$ 和 $B_k/n$ 都估计了总方差的分量。如果存在差异（例如，链在采样不同区域），链间方差将会被放大。\n\n潜在尺度缩减因子 $\\hat{R}_k$ 是合并方差估计与平均链内方差之比的平方根：\n$$\\hat{R}_k = \\sqrt{\\frac{\\hat{V}_k}{W_k}} = \\sqrt{\\frac{\\frac{n-1}{n} W_k + \\frac{1}{n} B_k}{W_k}} = \\sqrt{\\frac{n-1}{n} + \\frac{B_k}{nW_k}}$$\n如果链已经收敛，这个比率应该接近 $1$。\n\n**单变量 $\\hat{R}$ 的计算：**\n\n对于可观测量 1：\n$\\mu_{1,1}=0.50$, $\\mu_{2,1}=0.62$, $\\mu_{3,1}=0.54$.\n$\\bar{\\mu}_1 = \\frac{0.50+0.62+0.54}{3} = \\frac{1.66}{3}$.\n$B_1 = \\frac{20}{3-1} \\left[ \\left(0.50 - \\frac{1.66}{3}\\right)^2 + \\left(0.62 - \\frac{1.66}{3}\\right)^2 + \\left(0.54 - \\frac{1.66}{3}\\right)^2 \\right] = 10 \\left[ \\left(-\\frac{0.16}{3}\\right)^2 + \\left(\\frac{0.20}{3}\\right)^2 + \\left(-\\frac{0.04}{3}\\right)^2 \\right] = \\frac{10}{9}(0.0256 + 0.0400 + 0.0016) = \\frac{0.672}{9} \\approx 0.07467$.\n$S_{1,11}=0.050$, $S_{2,11}=0.048$, $S_{3,11}=0.052$.\n$W_1 = \\frac{0.050+0.048+0.052}{3} = \\frac{0.150}{3} = 0.050$.\n$\\hat{R}_1 = \\sqrt{\\frac{19}{20} + \\frac{0.07467}{20 \\times 0.050}} = \\sqrt{0.95 + 0.07467} = \\sqrt{1.02467} \\approx 1.0122$.\n\n对于可观测量 2：\n$\\mu_{1,2}=1.00$, $\\mu_{2,2}=0.96$, $\\mu_{3,2}=1.06$.\n$\\bar{\\mu}_2 = \\frac{1.00+0.96+1.06}{3} = \\frac{3.02}{3}$.\n$B_2 = \\frac{20}{3-1} \\left[ \\left(1.00 - \\frac{3.02}{3}\\right)^2 + \\left(0.96 - \\frac{3.02}{3}\\right)^2 + \\left(1.06 - \\frac{3.02}{3}\\right)^2 \\right] = 10 \\left[ \\left(-\\frac{0.02}{3}\\right)^2 + \\left(-\\frac{0.14}{3}\\right)^2 + \\left(\\frac{0.16}{3}\\right)^2 \\right] = \\frac{10}{9}(0.0004 + 0.0196 + 0.0256) = \\frac{0.456}{9} \\approx 0.05067$.\n$S_{1,22}=0.042$, $S_{2,22}=0.039$, $S_{3,22}=0.041$.\n$W_2 = \\frac{0.042+0.039+0.041}{3} = \\frac{0.122}{3}$.\n$\\hat{R}_2 = \\sqrt{\\frac{19}{20} + \\frac{0.05067}{20 \\times (0.122/3)}} = \\sqrt{0.95 + \\frac{0.15201}{2.44}} \\approx \\sqrt{0.95 + 0.0623} = \\sqrt{1.0123} \\approx 1.0061$.\n\n**2. 多变量潜在尺度缩减因子 ($\\hat{R}_{\\mathrm{multi}}$)**\n\n通过将标量方差替换为协方差矩阵，将单变量分析扩展到 $p=2$ 维的情况。\n\n合并链内协方差矩阵 $\\mathbf{W}$ 是各链协方差矩阵的平均值：\n$$\\mathbf{W} = \\frac{1}{M} \\sum_{m=1}^{M} \\mathbf{S}_m$$\n\n链间协方差矩阵 $\\mathbf{B}$ 为：\n$$\\mathbf{B} = \\frac{n}{M-1} \\sum_{m=1}^{M} (\\boldsymbol{\\mu}_m - \\bar{\\boldsymbol{\\mu}})(\\boldsymbol{\\mu}_m - \\bar{\\boldsymbol{\\mu}})^T$$\n其中 $\\bar{\\boldsymbol{\\mu}} = \\frac{1}{M} \\sum_{m=1}^{M} \\boldsymbol{\\mu}_m$ 是总均值向量。\n\n边际协方差矩阵的合并估计量 $\\hat{\\mathbf{V}}$ 为：\n$$\\hat{\\mathbf{V}} = \\frac{n-1}{n} \\mathbf{W} + \\frac{1}{n} \\mathbf{B}$$\n\n多变量 PSRF, $\\hat{R}_{\\mathrm{multi}}$，是通过 $\\hat{\\mathbf{V}}$ 相对于 $\\mathbf{W}$ 的最大广义特征值 $\\lambda_{\\max}$ 来定义的。该特征值是广义特征值问题 $\\hat{\\mathbf{V}}\\mathbf{v} = \\lambda\\mathbf{W}\\mathbf{v}$ 的解。\n代入 $\\hat{\\mathbf{V}}$ 的表达式：\n$$\\left(\\frac{n-1}{n} \\mathbf{W} + \\frac{1}{n} \\mathbf{B}\\right)\\mathbf{v} = \\lambda\\mathbf{W}\\mathbf{v}$$\n假设 $\\mathbf{W}$ 是可逆的，我们可以乘以 $\\mathbf{W}^{-1}$：\n$$\\left(\\frac{n-1}{n} \\mathbf{I} + \\frac{1}{n} \\mathbf{W}^{-1}\\mathbf{B}\\right)\\mathbf{v} = \\lambda\\mathbf{v}$$\n这是一个标准的特征值问题。特征值 $\\lambda$ 与矩阵 $\\mathbf{W}^{-1}\\mathbf{B}$ 的特征值 $\\eta$ 通过 $\\lambda = \\frac{n-1}{n} + \\frac{\\eta}{n}$ 相关联。\n多变量 PSRF 是最大特征值 $\\lambda_{\\max}$ 的平方根：\n$$\\hat{R}_{\\mathrm{multi}} = \\sqrt{\\lambda_{\\max}} = \\sqrt{\\frac{n-1}{n} + \\frac{\\eta_{\\max}}{n}}$$\n其中 $\\eta_{\\max}$ 是 $\\mathbf{W}^{-1}\\mathbf{B}$ 的最大特征值。\n\n**多变量 $\\hat{R}_{\\mathrm{multi}}$ 的计算：**\n\n总均值向量：\n$\\bar{\\boldsymbol{\\mu}} = \\frac{1}{3} \\left( \\begin{pmatrix}0.50 \\\\ 1.00\\end{pmatrix} + \\begin{pmatrix}0.62 \\\\ 0.96\\end{pmatrix} + \\begin{pmatrix}0.54 \\\\ 1.06\\end{pmatrix} \\right) = \\frac{1}{3} \\begin{pmatrix}1.66 \\\\ 3.02\\end{pmatrix}$.\n\n合并链内协方差矩阵 $\\mathbf{W}$：\n$\\mathbf{W} = \\frac{1}{3} \\left( \\begin{pmatrix}0.050  0.012 \\\\ 0.012  0.042\\end{pmatrix} + \\begin{pmatrix}0.048  0.009 \\\\ 0.009  0.039\\end{pmatrix} + \\begin{pmatrix}0.052  0.011 \\\\ 0.011  0.041\\end{pmatrix} \\right) = \\frac{1}{3} \\begin{pmatrix}0.150  0.032 \\\\ 0.032  0.122\\end{pmatrix}$.\n\n链间协方差矩阵 $\\mathbf{B}$：\n偏差向量为 $\\boldsymbol{\\mu}_1 - \\bar{\\boldsymbol{\\mu}} = \\frac{1}{3}\\begin{pmatrix}-0.16 \\\\ -0.02\\end{pmatrix}$, $\\boldsymbol{\\mu}_2 - \\bar{\\boldsymbol{\\mu}} = \\frac{1}{3}\\begin{pmatrix}0.20 \\\\ -0.14\\end{pmatrix}$, $\\boldsymbol{\\mu}_3 - \\bar{\\boldsymbol{\\mu}} = \\frac{1}{3}\\begin{pmatrix}-0.04 \\\\ 0.16\\end{pmatrix}$.\n$\\mathbf{B} = \\frac{20}{3-1} \\sum_{m=1}^{3} (\\boldsymbol{\\mu}_m - \\bar{\\boldsymbol{\\mu}})(\\boldsymbol{\\mu}_m - \\bar{\\boldsymbol{\\mu}})^T = \\frac{10}{9} \\left( \\begin{pmatrix}-0.16 \\\\ -0.02\\end{pmatrix}\\begin{pmatrix}-0.16  -0.02\\end{pmatrix} + \\dots \\right)$\n$\\mathbf{B} = \\frac{10}{9} \\begin{pmatrix} 0.0672  -0.0312 \\\\ -0.0312  0.0456 \\end{pmatrix} \\approx \\begin{pmatrix} 0.07467  -0.03467 \\\\ -0.03467  0.05067 \\end{pmatrix}$.\n\n接下来，我们计算 $\\mathbf{W}^{-1}\\mathbf{B}$。\n$\\det(\\mathbf{W}) = \\frac{1}{9}(0.150 \\times 0.122 - 0.032^2) = \\frac{1}{9}(0.0183 - 0.001024) = \\frac{0.017276}{9}$.\n$\\mathbf{W}^{-1} = \\frac{9}{0.017276} \\frac{1}{3} \\begin{pmatrix} 0.122  -0.032 \\\\ -0.032  0.150 \\end{pmatrix} = \\frac{3}{0.017276} \\begin{pmatrix} 0.122  -0.032 \\\\ -0.032  0.150 \\end{pmatrix}$.\n$\\mathbf{W}^{-1}\\mathbf{B} = \\frac{3}{0.017276} \\begin{pmatrix} 0.122  -0.032 \\\\ -0.032  0.150 \\end{pmatrix} \\frac{10}{9} \\begin{pmatrix} 0.0672  -0.0312 \\\\ -0.0312  0.0456 \\end{pmatrix} = \\frac{10}{3 \\times 0.017276} \\begin{pmatrix} 0.0091968  -0.0052656 \\\\ -0.0068304  0.0078384 \\end{pmatrix}$.\n前置因子为 $\\frac{10}{0.051828} \\approx 192.943$.\n$\\mathbf{W}^{-1}\\mathbf{B} \\approx 192.943 \\begin{pmatrix} 0.0091968  -0.0052656 \\\\ -0.0068304  0.0078384 \\end{pmatrix} \\approx \\begin{pmatrix} 1.7745  -1.0159 \\\\ -1.3178  1.5123 \\end{pmatrix}$.\n该矩阵的特征值 $\\eta$ 是特征方程 $\\eta^2 - \\text{tr}(\\mathbf{W}^{-1}\\mathbf{B})\\eta + \\det(\\mathbf{W}^{-1}\\mathbf{B}) = 0$ 的根。\n$\\text{tr}(\\mathbf{W}^{-1}\\mathbf{B}) \\approx 1.7745 + 1.5123 = 3.2868$.\n$\\det(\\mathbf{W}^{-1}\\mathbf{B}) \\approx (1.7745)(1.5123) - (-1.0159)(-1.3178) \\approx 2.6835 - 1.3388 = 1.3447$.\n$\\eta^2 - 3.2868\\eta + 1.3447 = 0$.\n$\\eta = \\frac{3.2868 \\pm \\sqrt{3.2868^2 - 4(1.3447)}}{2} = \\frac{3.2868 \\pm \\sqrt{10.803 - 5.3788}}{2} = \\frac{3.2868 \\pm \\sqrt{5.4242}}{2} = \\frac{3.2868 \\pm 2.3290}{2}$.\n特征值为 $\\eta_1 \\approx 2.8079$ 和 $\\eta_2 \\approx 0.4789$。最大的是 $\\eta_{\\max} \\approx 2.8079$。\n最后，我们计算 $\\hat{R}_{\\mathrm{multi}}$：\n$\\hat{R}_{\\mathrm{multi}} = \\sqrt{\\frac{20-1}{20} + \\frac{\\eta_{\\max}}{20}} = \\sqrt{0.95 + \\frac{2.8079}{20}} = \\sqrt{0.95 + 0.140395} = \\sqrt{1.090395} \\approx 1.04422$.\n\n**3. 收敛阈值和趋势要求**\n\nPSRF，无论是单变量还是多变量，都提供了一个无量纲的收敛性度量。PSRF 的平方 $\\hat{R}^2$ 估计了边际方差相对于链内方差被高估的因子。理想值为 $\\hat{R}=1.0$，表明链间和链内变异是一致的。\n\n**停止阈值**：一个普遍接受的（尽管依赖于具体问题）宣布收敛的阈值是，当所有被监测的可观测量的 PSRF 值都低于某个值（例如 $1.1$）时。更严格的应用可能要求阈值为 $1.05$ 或 $1.01$。对于多变量情况，相应的准则是 $\\hat{R}_{\\mathrm{multi}} < 1.1$。$\\hat{R}=1.1$ 的值意味着潜在的尺度缩减为 $10\\%$，因为由于不完全收敛，可观测量的估计方差被放大了 $1.1^2 \\approx 1.21$ 倍。\n\n**趋势要求**：在单个时间点达到阈值是不够的。真正的收敛要求稳定性。应在模拟的连续、不重叠的时间窗口上监测 PSRF。停止平衡阶段的一个稳健准则是，在这些窗口上计算的 PSRF 不仅必须持续低于所选阈值，而且还不能表现出明显的上升趋势。在一个相当长的时间段内，稳定或下降的 PSRF 值表明链正在可靠地从同一个平稳分布中采样。通过目视检查 $\\hat{R}$ 与模拟时间的图是确认这种稳定性的标准做法。\n\n将所要求的最终答案四舍五入到四位有效数字，得到 $1.044$。", "answer": "$$\n\\boxed{1.044}\n$$", "id": "3405203"}, {"introduction": "当收敛诊断显示收敛缓慢时，我们不能简单地假设这是系统固有的物理特性。算法参数，特别是恒温器和恒压器的耦合时间，可能会引入人为的慢弛豫模式。本练习[@problem_id:3405236]作为一个案例研究，旨在教您如何诊断这些由算法引起的问题，并制定一个科学合理的方案来解耦物理时间尺度和算法时间尺度，以确保模拟的保真度。", "problem": "一个包含 $N$ 个粒子的溶剂化生物分子体系，通过分子动力学进行平衡，该过程遵循牛顿第二定律 $m_i \\, d^2 \\mathbf{r}_i/dt^2 = - \\nabla_i U(\\mathbf{r}_1,\\dots,\\mathbf{r}_N)$，并附加了用于恒温器和恒压器的标准耦合项，以对适当的统计系综进行采样。在弱扰动、近平衡区域，线性响应理论和 Onsager 回归假说意味着宏观可观测量 $X(t)$ 与其平衡值 $X_{\\mathrm{eq}}$ 的微小偏差会呈指数形式弛豫。当两个独立的弛豫通道并行作用于同一个标量可观测量时（例如，系统内部的固有物理能量交换和与恒温器的算法能量交换），预期净速率是各个速率之和。类似地，对于恒压器下的体积涨落，晶胞自由度与流体动力学模式耦合；在各向同性可压缩流体中，微小体积应变 $\\epsilon(t) = \\Delta V(t)/V_0$ 在最简单的情况下可以由一个代表 Parrinello–Rahman 类型扩展变量的阻尼谐振子来建模，即 $W \\, d^2 \\epsilon/dt^2 + \\gamma_P \\, d \\epsilon/dt + K_T \\, \\epsilon = 0$，其中 $W$ 是一个类惯性参数，$\\gamma_P$ 是与恒压器相关的阻尼系数，而 $K_T$ 是等温体积模量，同时物理流体支持声学模式，其穿过线性尺寸为 $L$、声速为 $c_s$ 的盒子所需的特征传播时间为 $L/c_s$。\n\n在平衡过程中，进行了以下受控实验：\n\n- 在恒定粒子数-体积-温度 (NVT) 模拟中，使用弛豫时间为 $\\tau_T$ 的随机恒温器监测动能温度 $T(t)$。当 $\\tau_T = 0.5 \\, \\mathrm{ps}$ 时，$T(t)$ 趋向其目标值的指数拟合得到观测弛豫时间 $\\tau_{\\mathrm{obs}}^{(T)} = 0.4 \\, \\mathrm{ps}$。当 $\\tau_T = 5.0 \\, \\mathrm{ps}$ 时，拟合得到的观测弛豫时间为 $\\tau_{\\mathrm{obs}}^{(T)} = 1.4286 \\, \\mathrm{ps}$。\n\n- 在恒定粒子数-压力-温度 (NPT) 模拟中，使用各向同性恒压器监测瞬时体积 $V(t)$。立方盒的线性尺寸为 $L = 10 \\, \\mathrm{nm}$，溶剂中的声速为 $c_s = 1500 \\, \\mathrm{m/s}$。当使用有效阻尼时间设置为 $\\tau_P = 50 \\, \\mathrm{ps}$ 的强阻尼恒压器时，体积自相关函数单调衰减，观测到的指数时间约为 $\\tau_{\\mathrm{obs}}^{(V)} \\approx 8 \\, \\mathrm{ps}$。当使用更激进的恒压器，$\\tau_P = 1 \\, \\mathrm{ps}$ 时，体积表现出欠阻尼振荡，其主周期与声波穿过盒子的传播时间相当，并伴有较慢的包络衰减。\n\n基于第一性原理和这些测量结果，选择能够正确解释恒温器弛豫时间和恒压器阻尼如何与系统固有弛豫时间相互作用，从而导致表观上的慢收敛，并能概述一个科学上合理的方案以区分算法时间尺度和物理时间尺度的陈述：\n\nA. 在标量可观测量（如动能温度）的线性响应区域，独立的物理弛豫通道和恒温器弛豫通道并行作用，导致速率加和定律 $1/\\tau_{\\mathrm{obs}} = 1/\\tau_{\\mathrm{phys}} + 1/\\tau_T$。这可以通过扫描 $\\tau_T$ 并拟合 $T(t)$ 的指数衰减来验证；$1/\\tau_{\\mathrm{obs}}$ 对 $1/\\tau_T$ 的图应为一条斜率为 $1$、截距为 $1/\\tau_{\\mathrm{phys}}$ 的直线，并且测量数据与一个恒定的 $\\tau_{\\mathrm{phys}}$ 相符。\n\nB. 对于 Parrinello–Rahman 恒压器，选择远小于模拟盒子声学周期的 $\\tau_P$ 总能减小体积弛豫时间且没有副作用，因为恒压器直接抑制了密度波。\n\nC. 为了区分算法时间尺度和物理时间尺度，一个可靠的方案是：首先，从轻微扰动的平衡态开始进行短时间的恒定粒子数-体积-能量 (NVE) 模拟，通过自相关函数测量固有弛豫（从而得到 $\\tau_{\\mathrm{phys}}$ 和流体动力学时间如 $L/c_s$ 的估计值）；接下来，在对数网格上对 $\\tau_T$ 和 $\\tau_P$ 进行扫描，对能量相关可观测量拟合 $1/\\tau_{\\mathrm{obs}}$ 对 $1/\\tau_T$ 的关系，当 $\\tau_P$ 接近声学时间时检查体积自相关函数是否存在欠阻尼振荡，并选择与最快物理模式相比足够长但与目标慢结构弛豫相比足够短的耦合时间。使用热力学可观量的分块平均法来确认收敛性与算法参数无关。\n\nD. 正确的平衡策略是同时最小化 $\\tau_T$ 和 $\\tau_P$，直到瞬时温度和压力在容差范围内与其目标值匹配；这保证了任何剩余的慢收敛纯粹是物理性的，因为恒温器和恒压器已被设置为无限快。\n\nE. 当两个独立的弛豫通道作用于同一可观测量时，较慢的通道占主导，因此 $\\tau_{\\mathrm{obs}} = \\max(\\tau_T, \\tau_{\\mathrm{phys}})$；因此，扫描 $\\tau_T$ 无法揭示 $\\tau_{\\mathrm{phys}}$，只有改变系统大小才能揭示物理时间尺度。\n\n选择所有正确的选项。", "solution": "**推导与选项分析**\n\n该问题要求评估关于算法耦合参数 ($\\tau_T, \\tau_P$) 与系统固有动力学之间相互作用的陈述。\n\n**选项 A 分析**\n该选项声称，对于温度弛豫，速率相加：$1/\\tau_{\\mathrm{obs}} = 1/\\tau_{\\mathrm{phys}} + 1/\\tau_T$。它进一步提出了一种图形验证方法：$1/\\tau_{\\mathrm{obs}}$ 对 $1/\\tau_T$ 的图应为线性，斜率为 $1$，y 轴截距为 $1/\\tau_{\\mathrm{phys}}$。最后，它断言所提供的数据与此模型一致。\n\n对于独立、并行的​​一阶弛豫过程，速率加和定律是正确的模型。此类过程由形式为 $\\dot{X} = - (k_1 + k_2) X$ 的微分方程控制，其中速率 $k_i = 1/\\tau_i$ 相加。\n所提出的验证方法是这种线性关系的直接结果。设 $y = 1/\\tau_{\\mathrm{obs}}$ 和 $x = 1/\\tau_T$。方程变为 $y = x + 1/\\tau_{\\mathrm{phys}}$，这是一条斜率为 $m = 1$、截距为 $c = 1/\\tau_{\\mathrm{phys}}$ 的直线方程。\n根据提供的数据：\n对于 $\\tau_T = 0.5$, $\\tau_{\\mathrm{obs}} = 0.4$, 我们有 $1/0.4 = 1/\\tau_{\\mathrm{phys}} + 1/0.5 \\implies 2.5 = 1/\\tau_{\\mathrm{phys}} + 2.0 \\implies 1/\\tau_{\\mathrm{phys}} = 0.5$, 所以 $\\tau_{\\mathrm{phys}} = 2.0 \\, \\mathrm{ps}$。\n对于 $\\tau_T = 5.0$, $\\tau_{\\mathrm{obs}} = 1.4286$, 我们有 $1/1.4286 \\approx 0.7 = 1/\\tau_{\\mathrm{phys}} + 1/5.0 = 1/\\tau_{\\mathrm{phys}} + 0.2$。用前面算出的 $\\tau_{\\mathrm{phys}}=2.0$, 我们得到 $0.5 + 0.2 = 0.7$, 这与数据一致。\n因此，该陈述的每个部分都是正确的：物理模型、验证方法以及与给定数据的一致性。\n\n**结论：正确**\n\n**选项 B 分析**\n该选项声称，选择一个远小于声学周期的恒压器时间常数 $\\tau_P$ *总能* 减小体积弛豫时间而没有副作用。\n这是不正确的。恒压器的动力学被建模为一个阻尼谐振子，它与系统的物理响应耦合。使耦合过强（非常小的 $\\tau_P$）可以将系统从过阻尼状态推入欠阻尼状态。虽然初始响应可能更快，但系统随后会围绕平衡体积振荡，这是一种不希望出现的伪影，并且会减慢系统构型采样的整体收敛速度。问题陈述明确提供了与此相反的证据：对于 $\\tau_P = 1 \\, \\mathrm{ps}$，它小于约 $6.67 \\, \\mathrm{ps}$ 的声学时间，“体积表现出欠阻尼振荡”。这些振荡是一个显著的副作用。恒压器试图以比压力通过声波在盒子中达到平衡更快的速度强行改变体积，从而激发了驻留声波。声称它“直接抑制了密度波”与事实恰恰相反；它激发了密度波。\n\n**结论：不正确**\n\n**选项 C 分析**\n该选项提出了一个用于研究和设置耦合参数的详细方案。\n1.  **使用 NVE 运行来测量固有动力学**：NVE 模拟根据系统自身的哈密顿量演化，没有外部热或压力耦合。它们是测量固有物理弛豫时间（例如能量交换率 $\\tau_{\\mathrm{phys}}$ 或流体动力学模式的周期 $L/c_s$）的黄金标准。这是一个合理且标准的做法。\n2.  **扫描耦合参数并分析**：系统地改变 $\\tau_T$ 和 $\\tau_P$ 并观察系统的响应是理解耦合的正确方法。所提到的具体分析——拟合 $1/\\tau_{\\mathrm{obs}}$ 对 $1/\\tau_T$ 的关系以及检查体积自相关函数中的振荡——正是正确的诊断工具，正如问题陈述本身所示。\n3.  **在适当的窗口中选择耦合时间**：选择 $\\tau_T$ 和 $\\tau_P$ “与最快的物理模式相比足够长但与目标慢结构弛豫相比足够短”的建议是 MD 模拟的经典指导原则。这将算法的时间尺度与非常快、不相关的运动（可能导致伪影）和缓慢、具有科学意义的过程（绝不能被算法扰动）分离开来。\n4.  **用分块平均法确认**：分块平均法是估计相关时间序列数据误差和检验收敛性的关键统计工具。验证收敛的热力学平均值与（有效的）算法参数的选择无关，是对模拟结果稳健性的基本检查。\n整个方案是对现代分子动力学最佳实践的全面描述。\n\n**结论：正确**\n\n**选项 D 分析**\n该选项建议最小化 $\\tau_T$ 和 $\\tau_P$，以使恒温器和恒压器“无限快”。其理由是这能完美地将算法效应与物理效应分离开。\n这种方法存在根本性缺陷，并代表了一种常见的误解。强迫瞬时温度或压力匹配目标值并不能复现正确的统计系综。一个无限快的恒温器会消除自然的动能涨落，导致一个非正则（对于动能而言类似于微正则）分布。一个无限快的恒压器，如选项 B 所讨论的，会导致系统体积和压力的严重非物理振荡。这种策略非但不能消除伪影，反而通过违反系统的物理响应时间引入了新的、严重的伪影。真正的平衡需要一种温和的耦合，允许系统在指定的系综条件下自然地探索其相空间，而不是强行钳制宏观变量。\n\n**结论：不正确**\n\n**选项 E 分析**\n该选项声称较慢的弛豫通道占主导，因此 $\\tau_{\\mathrm{obs}} = \\max(\\tau_T, \\tau_{\\mathrm{phys}})$。\n这种数学形式描述的是串行发生的过程，其中总时间由最慢的步骤（瓶颈）决定。然而，物理能量弛豫和与恒温器的算法能量交换是系统达到热平衡的并行路径。如前所述，对于并行过程，是速率相加，而不是时间相加。正确的关系是 $1/\\tau_{\\mathrm{obs}} = 1/\\tau_{\\mathrm{phys}} + 1/\\tau_T$，这意味着 $\\tau_{\\mathrm{obs}} = (\\tau_{\\mathrm{phys}} \\tau_T)/(\\tau_{\\mathrm{phys}} + \\tau_T)$。这个观测到的时间常数总是*小于*两个独立的时间常数。该选项的前提是基于一个不正确的物理模型。因此，其关于扫描 $\\tau_T$ 无法揭示 $\\tau_{\\mathrm{phys}}$ 的结论也是错误的，这一点已被选项 A 的分析明确驳斥。\n\n**结论：不正确**", "answer": "$$\\boxed{AC}$$", "id": "3405236"}]}