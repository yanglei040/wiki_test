{"hands_on_practices": [{"introduction": "径向分布函数 $g(r)$ 是结构分析的基石，它提供了原子堆积的统计图像。然而，其真正的力量在于它能够提供定量的度量标准。本练习 [@problem_id:3450334] 将引导您完成一个基础推导，学习如何计算特定半径内的平均近邻原子数，从而将 $g(r)$ 的抽象概率分布与配位层这一具体概念直接联系起来。", "problem": "在一个处于平衡态的均质各向同性分子流体中，径向分布函数 (RDF) $g(r)$ 定义为在间距 $r$ 处的条件对数密度与体数密度 $\\rho$ 之比。从这个概率定义和基本的几何考虑出发，推导一个以标记粒子为中心、半径为 $R$ 的球内的期望邻居数的表达式，该表达式应使用 $g(r)$、$\\rho$ 和 $R$ 表示。\n\n然后，考虑一个在约化单位下模拟的单原子类 Lennard-Jones 流体，其中距离以特征长度 $\\sigma$ 为单位（因此 $r$ 以 $\\sigma$ 为单位表示，$\\rho$ 以 $\\sigma^{-3}$ 为单位表示）。该流体的体数密度为 $\\rho = 0.85\\,\\sigma^{-3}$。作为一个简化但科学上合理的短程结构模型，假设径向分布函数具有以下分段形式：\n- 对于 $0 \\le r  1$，$g(r) = 0$\n- 对于 $1 \\le r \\le 1.5$，$g(r) = 1 + a\\,(1 - 2(r - 1))$，其中 $a = 1.5$。\n\n使用您推导出的表达式，计算半径 $R = 1.5$ 内的期望邻居数，并给出数值。将您的答案四舍五入到四位有效数字。将最终的邻居数表示为无量纲的计数值。", "solution": "该问题是有效的，因为它在科学上基于统计力学的原理，是良定的和客观的。它包含了获得唯一解所需的所有信息。\n\n问题的第一部分要求推导以标记粒子为中心、半径为 $R$ 的球内的期望邻居数 $N(R)$ 的表达式。\n\n径向分布函数 $g(r)$ 提供了距离中心粒子 $r$ 处的局域粒子数密度（我们称之为 $\\rho(r)$）与平均体数密度 $\\rho$ 之比。这表示为：\n$$\ng(r) = \\frac{\\rho(r)}{\\rho}\n$$\n根据这个定义，距离 $r$ 处的局域数密度可以写为：\n$$\n\\rho(r) = \\rho g(r)\n$$\n为了求出中心粒子周围半径为 $r$、无穷小厚度为 $dr$ 的薄球壳内的粒子数，我们将局域密度 $\\rho(r)$ 乘以该球壳的体积 $dV$。对于一个均质各向同性系统，其几何形状是球形的，球壳的体积由下式给出：\n$$\ndV = 4\\pi r^2 dr\n$$\n因此，该球壳中的无穷小粒子数 $dN$ 为：\n$$\ndN = \\rho(r) \\, dV = \\rho g(r) (4\\pi r^2 dr)\n$$\n通过将此表达式从中心（$r=0$）积分到半径 $R$，可以找到半径为 $R$ 的球内的期望总邻居数 $N(R)$：\n$$\nN(R) = \\int_0^R dN = \\int_0^R \\rho g(r) 4\\pi r^2 dr\n$$\n我们可以通过提出常数项来重新整理这个表达式：\n$$\nN(R) = 4\\pi\\rho \\int_0^R g(r) r^2 dr\n$$\n这就是所要求的期望邻居数的通用表达式。\n\n问题的第二部分要求对在约化单位下描述的特定系统计算此表达式的值。给定的参数是：\n- 体数密度：$\\rho = 0.85$（以 $\\sigma^{-3}$ 为单位，使得乘积 $\\rho\\sigma^3$ 成为值为 $0.85$ 的无量纲量）。\n- 球的半径：$R = 1.5$（以 $\\sigma$ 为单位）。\n- 径向分布函数 $g(r)$ 以分段函数形式给出（其中 $r$ 是无量纲距离 $r/\\sigma$）：\n$$\ng(r) = \n\\begin{cases} \n0  \\text{对于 } 0 \\le r  1 \\\\\n1 + a(1 - 2(r - 1))  \\text{对于 } 1 \\le r \\le 1.5 \n\\end{cases}\n$$\n其中常数 $a$ 给定为 $a=1.5$。\n\n我们需要计算 $R=1.5$ 时的 $N(R)$。使用推导出的公式：\n$$\nN(1.5) = 4\\pi\\rho \\int_0^{1.5} g(r) r^2 dr\n$$\n由于 $g(r)$ 的分段性质，我们在 $r=1$ 处将积分分开：\n$$\n\\int_0^{1.5} g(r) r^2 dr = \\int_0^1 g(r) r^2 dr + \\int_1^{1.5} g(r) r^2 dr\n$$\n对于区间 $0 \\le r  1$，$g(r) = 0$，所以第一个积分为零：\n$$\n\\int_0^1 (0) r^2 dr = 0\n$$\n对于区间 $1 \\le r \\le 1.5$，我们首先用 $a=1.5$ 简化 $g(r)$ 的表达式：\n$$\ng(r) = 1 + 1.5(1 - 2(r - 1)) = 1 + 1.5(1 - 2r + 2) = 1 + 1.5(3 - 2r) = 1 + 4.5 - 3r = 5.5 - 3r\n$$\n现在我们计算第二个积分：\n$$\n\\int_1^{1.5} (5.5 - 3r) r^2 dr = \\int_1^{1.5} (5.5r^2 - 3r^3) dr\n$$\n进行积分：\n$$\n\\left[ 5.5 \\frac{r^3}{3} - 3 \\frac{r^4}{4} \\right]_1^{1.5} = \\left[ \\frac{11}{6}r^3 - \\frac{3}{4}r^4 \\right]_1^{1.5}\n$$\n我们在上限 $r=1.5 = \\frac{3}{2}$ 和下限 $r=1$ 处计算此表达式的值。\n在 $r = 1.5 = \\frac{3}{2}$ 处：\n$$\n\\frac{11}{6}\\left(\\frac{3}{2}\\right)^3 - \\frac{3}{4}\\left(\\frac{3}{2}\\right)^4 = \\frac{11}{6}\\left(\\frac{27}{8}\\right) - \\frac{3}{4}\\left(\\frac{81}{16}\\right) = \\frac{11 \\cdot 9}{16} - \\frac{243}{64} = \\frac{99}{16} - \\frac{243}{64} = \\frac{396}{64} - \\frac{243}{64} = \\frac{153}{64}\n$$\n在 $r=1$ 处：\n$$\n\\frac{11}{6}(1)^3 - \\frac{3}{4}(1)^4 = \\frac{11}{6} - \\frac{3}{4} = \\frac{22-9}{12} = \\frac{13}{12}\n$$\n定积分的值是这两个结果之差：\n$$\n\\int_1^{1.5} g(r) r^2 dr = \\frac{153}{64} - \\frac{13}{12} = \\frac{153 \\cdot 3}{192} - \\frac{13 \\cdot 16}{192} = \\frac{459 - 208}{192} = \\frac{251}{192}\n$$\n现在我们将此结果以及给定的值 $\\rho = 0.85$ 代入 $N(1.5)$ 的表达式中：\n$$\nN(1.5) = 4\\pi\\rho \\left( \\frac{251}{192} \\right) = 4\\pi(0.85)\\left(\\frac{251}{192}\\right)\n$$\n简化表达式：\n$$\nN(1.5) = \\pi(0.85)\\left(\\frac{251}{48}\\right)\n$$\n我们计算其数值：\n$$\nN(1.5) \\approx (3.14159265...)(0.85)\\left(\\frac{251}{48}\\right) \\approx (2.6703537...)(5.2291666...) \\approx 13.963836\n$$\n问题要求将结果四舍五入到四位有效数字。\n$$\nN(1.5) \\approx 13.96\n$$\n这个值表示距离中心粒子 $1.5\\sigma$ 半径内的期望粒子数。", "answer": "$$\\boxed{13.96}$$", "id": "3450334"}, {"introduction": "计算机模拟使用有限的周期性盒子来近似无限系统，这是一种巧妙但非完美的技巧。本练习 [@problem_id:3450315] 旨在解决这一近似所带来的一个关键后果：结构分析中存在一个最大可靠距离。通过从第一性原理出发推导径向分布函数的截断半径，您将对计算几何如何引入人为假象有更深刻的理解，并学会更加审慎地解读您的模拟数据。", "problem": "考虑一个经典平衡态原子模拟，其中包含$N$个相同粒子，数密度为$\\rho$，置于边长为$L$的立方周期性模拟晶胞中，并采用周期性边界条件(PBC)。粒子间距使用最小镜像约定(MIC)计算，这意味着对于主盒子中位移矢量为$\\boldsymbol{r}_{ij}$的任意一对粒子，用于结构度量的间距是集合$\\{\\boldsymbol{r}_{ij} + L \\boldsymbol{n} : \\boldsymbol{n} \\in \\mathbb{Z}^{3}\\}$中的唯一矢量，其每个笛卡尔分量都被限制在区间$\\left[-\\frac{L}{2}, \\frac{L}{2}\\right)$内。径向分布函数(RDF)通过对这些间距的模长进行直方图统计，并用名义球壳体积$4 \\pi r^{2} \\Delta r$和数密度$\\rho$进行归一化来估计。\n\n从RDF作为对相关联度量的基本定义，以及由立方晶胞中PBC所隐含的MIC采样域的几何结构出发，确定最大半径$r_{\\max}$。在此半径内，当使用名义球壳归一化$4 \\pi r^{2} \\Delta r$时，测量所得的RDF不受MIC引入的几何球壳截断和方向各向异性的影响。您的推导应基于第一性原理：即RDF关于对计数的定义，以及在MIC下唯一粒子间位移区域的几何形状，而不应援引任何预先记下的结果。\n\n然后，请提供一个简洁且有物理依据的解释，说明为什么在半径$r  r_{\\max}$时，如果继续使用$4 \\pi r^{2} \\Delta r$进行归一化而没有进行明确的边界形状校正，RDF的估计值会出现偏差，并指出该偏差的几何来源。\n\n请将$r_{\\max}$的最终答案表示为以$L$为变量的闭式解析表达式。无需进行数值计算或标注单位。请勿四舍五入。", "solution": "该问题要求确定最大半径$r_{\\max}$。对于一个边长为$L$、采用周期性边界条件(PBC)和最小镜像约定(MIC)的立方模拟盒子，在此半径内使用标准球壳归一化可以精确计算径向分布函数(RDF) $g(r)$。\n\n首先，我们必须将问题的几何形式化。模拟在主立方晶胞中进行。可将一个参考粒子视为位于原点。所有其他粒子的位置由它们相对于该参考粒子的位移矢量表示。最小镜像约定(MIC)确保对于任意粒子对，用于计算的位移矢量$\\boldsymbol{r}$是在所有周期性镜像中长度最短的一个。对于一个以原点为中心、边长为$L$的立方盒子，MIC将任何位移矢量映射到一个唯一的矢量，其笛卡尔分量$(x, y, z)$均被限制在区间$\\left[-\\frac{L}{2}, \\frac{L}{2}\\right)$内。\n\n这意味着所有粒子间距的采样域是一个立方体，我们称之为MIC域$\\mathcal{D}$，它以原点为中心，边长为$L$。在数学上，该域为：\n$$ \\mathcal{D} = \\left\\{ (x, y, z) \\in \\mathbb{R}^{3} \\mid -\\frac{L}{2} \\le x  \\frac{L}{2}, \\quad -\\frac{L}{2} \\le y  \\frac{L}{2}, \\quad -\\frac{L}{2} \\le z  \\frac{L}{2} \\right\\} $$\n\n径向分布函数$g(r)$测量的是在距离一个参考粒子径向距离为$r$处找到另一个粒子的概率，该概率是相对于同等密度下理想气体的概率而言的。在模拟中，它是通过将对间距按宽度为$\\Delta r$的箱进行直方图统计来估计的。在$r$和$r + \\Delta r$之间的壳层中找到的粒子对数，记为$N(r, \\Delta r)$，通过该壳层的体积以及在该体积中预期的平均粒子数进行归一化。\n\n问题指出，归一化是使用“名义球壳体积”完成的，即$V_{\\text{shell}} = 4 \\pi r^{2} \\Delta r$。使用此公式的前提是假设采样体积是一个完整、未被截断的球壳。只有当这个假设成立时，RDF的估计才不会有几何伪影。\n\n这个假设仅在以参考粒子（位于MIC域原点）为中心、半径为$r$的整个球体完全包含在MIC域$\\mathcal{D}$内时才有效。如果球体的任何部分超出了$\\mathcal{D}$的边界，那么实际采样的体积就会小于$4 \\pi r^2 \\Delta r$，并且采样将不再是各向同性（方向均匀）的。\n\n为了找到使此条件成立的最大半径$r_{\\max}$，我们必须找到可以内切于立方MIC域$\\mathcal{D}$的最大球体。一个以原点为中心、半径为$r$的球体完全包含在$\\mathcal{D}$内，当且仅当其半径小于或等于从原点到$\\mathcal{D}$边界的最短距离。\n\nMIC域$\\mathcal{D}$的边界是由$x = \\pm \\frac{L}{2}$、$y = \\pm \\frac{L}{2}$和$z = \\pm \\frac{L}{2}$定义的六个平面。边界上离原点最近的点是这些面的中心，例如点$\\left(\\frac{L}{2}, 0, 0\\right)$。从原点到该点的距离是：\n$$ d_{\\min} = \\sqrt{\\left(\\frac{L}{2}\\right)^2 + 0^2 + 0^2} = \\frac{L}{2} $$\n面上的任何点离原点的距离至少这么远。立方体的角点，例如$\\left(\\frac{L}{2}, \\frac{L}{2}, \\frac{L}{2}\\right)$，是边界上最远的点，距离为$\\sqrt{3 \\left(\\frac{L}{2}\\right)^2} = \\frac{\\sqrt{3}L}{2}$。\n\n为使采样球体完全包含在MIC域内，其半径$r$不得超过到边界的最短距离。因此，对于几何上无偏的RDF测量，最大半径为：\n$$ r_{\\max} = \\frac{L}{2} $$\n\n现在，我们必须解释为什么当半径$r  r_{\\max}$时，如果继续使用归一化因子$4 \\pi r^{2} \\Delta r$，RDF的估计值会出现偏差。\n\n当$r  r_{\\max} = \\frac{L}{2}$时，半径为$r$的球体不再完全包含在MIC域$\\mathcal{D}$内。该球体被立方体盒子的面所截断。用于对计数的实际采样体积$V_{\\text{actual}}(r, \\Delta r)$是球壳与立方体$\\mathcal{D}$交集的体积。该体积严格小于一个完整球壳的体积，即 $V_{\\text{actual}}(r, \\Delta r)  4 \\pi r^2 \\Delta r$。\n\n计算出的RDF形式如下：\n$$ g(r) \\approx \\frac{N(r, \\Delta r)}{N_{\\text{pairs}} \\cdot (\\text{Volume of shell}) / V_{\\text{box}}} = \\frac{V_{\\text{box}}}{N_{\\text{pairs}}} \\frac{N(r, \\Delta r)}{4 \\pi r^2 \\Delta r} $$\n其中$N(r, \\Delta r)$是计数的粒子对数，根据定义，这些粒子对仅在截断体积$V_{\\text{actual}}(r, \\Delta r)$*内部*找到。由于我们用一个比实际采样体积($V_{\\text{actual}}(r, \\Delta r)$)更大的归一化体积($4 \\pi r^2 \\Delta r$)来除观测到的粒子对计数，因此得到的$g(r)$值被系统地和人为地低估了。随着$r$的增加，这种偏差变得更加严重，导致当$r  L/2$时，$g(r)$会错误地趋向于零。\n\n这种偏差的几何来源是双重的：\n1.  **球壳截断**：如前所述，采样体积小于名义归一化体积。这导致$g(r)$的量值不正确。\n2.  **方向各向异性**：截断在所有方向上并非均匀。当$r  L/2$时，沿笛卡尔轴方向的对矢量被“截断”，而指向立方体角点的对矢量在距离达到$\\frac{\\sqrt{3}L}{2}$之前仍可被观测到。\n\n这意味着RDF中隐含的方向平均被破坏了。采样空间不是球对称的，因此将对相关信息简化为一个纯粹的径向函数$g(r)$在几何上变得不一致。“径向”分布函数的根本定义受到了损害，因为采样几何不再是各向同性的。", "answer": "$$\n\\boxed{\\frac{L}{2}}\n$$", "id": "3450315"}, {"introduction": "结构信息同时存在于实空间（原子位置，$g(r)$）和倒易空间（波矢，$S(q)$）中，而后者是散射实验直接测量的对象。这个高级练习 [@problem_id:3450291] 通过推导它们之间的数学关系，在这两个重要世界之间架起了一座桥梁。此外，它还提供了一个动手实践的数值任务，即从一个模型 $g(r)$ 计算静态结构因子 $S(q)$，迫使您直面并处理诸如截断效应和信号混叠等常见的数值计算陷阱。", "problem": "考虑一个数密度为 $\\rho$ 的均匀各向同性流体的静态结构因子 (SSF) $S(\\mathbf{q})$ 和径向分布函数 $g(r)$。从微观数密度 $\\rho(\\mathbf{r})$ 及其傅里叶变换出发，并根据产生 $g(r)$ 的对相关函数的定义，推导 $S(\\mathbf{q})$ 和 $g(r)$ 之间的关系，表示为\n$$\nS(\\mathbf{q}) \\;=\\; 1 \\;+\\; \\rho \\int_{\\mathbb{R}^3} e^{-i\\mathbf{q}\\cdot\\mathbf{r}}\\,[g(r)-1]\\,d\\mathbf{r}.\n$$\n在各向同性的条件下，将其简化为一个包含零阶球贝塞尔函数的一维积分，并解释有限离散化近似对采样间隔和积分域截断长度的依赖关系。\n\n然后设计一个数值实验，通过一个模型 $g(r)$ 计算 $S(q)$ 来验证所推导的关系，并量化由离散化、加窗和混叠引起的误差。使用以下模型函数来模拟短程有序和阻尼振荡的 $g(r)$：\n$$\ng(r) \\;=\\; 1 \\;+\\; A_1 \\exp\\!\\left(-\\frac{(r-r_a)^2}{2\\sigma_a^2}\\right) \\;+\\; A_2 \\exp\\!\\left(-\\frac{(r-r_b)^2}{2\\sigma_b^2}\\right)\\cos(k_0 r)\\exp\\!\\left(-\\frac{r}{\\lambda}\\right),\n$$\n参数为\n$$\nA_1 = 0.8,\\;\\; r_a = 0.3\\,\\mathrm{nm},\\;\\; \\sigma_a = 0.04\\,\\mathrm{nm},\\\\\nA_2 = 0.25,\\;\\; r_b = 0.9\\,\\mathrm{nm},\\;\\; \\sigma_b = 0.08\\,\\mathrm{nm},\\\\\nk_0 = 8.0\\,\\mathrm{nm}^{-1},\\;\\; \\lambda = 2.0\\,\\mathrm{nm},\n$$\n并使用数密度 $\\rho = 10.0\\,\\mathrm{nm}^{-3}$。波数大小 $q$ 必须以 $\\mathrm{nm}^{-1}$ 表示，距离 $r$ 必须以 $\\mathrm{nm}$ 表示。结构因子 $S(q)$ 是无量纲的，任何报告的误差都必须是无量纲的。\n\n使用各向同性简化形式，在一个截断到足够大的上限的 $r \\in [0,\\infty)$ 上进行数值收敛的积分，计算一个高精度的参考 $S_{\\mathrm{ref}}(q)$，其绝对和相对容差要足够小，以确保相对于离散化测试，求积误差可以忽略不计。然后，通过在 $[0,R_{\\max}]$ 上以间距 $\\Delta r$ 均匀采样 $r$ 并使用黎曼法则或梯形法则来评估离散近似 $S_{\\mathrm{disc}}(q)$。研究在积分前将 $g(r)-1$ 乘以一个窗函数 $W(r)$ 的效果，在 $[0,R_{\\max}]$ 上使用以下窗函数选项：\n- 矩形窗：$W_{\\mathrm{rect}}(r) = 1$。\n- Hann窗：$W_{\\mathrm{hann}}(r) = \\tfrac{1}{2}\\left(1 - \\cos\\left(\\tfrac{2\\pi r}{R_{\\max}}\\right)\\right)$。\n- Blackman窗：$W_{\\mathrm{black}}(r) = 0.42 - 0.5\\cos\\left(\\tfrac{2\\pi r}{R_{\\max}}\\right) + 0.08\\cos\\left(\\tfrac{4\\pi r}{R_{\\max}}\\right)$。\n\n在各向同性简化中使用球贝塞尔核 $j_0(q r) = \\sin(qr)/(qr)$。在以下集合上对波数进行采样\n$$\n\\{\\, q_k \\,\\}_{k=0}^{K} \\quad \\text{其中} \\quad q_k = 0.5\\,k\\,\\mathrm{nm}^{-1}, \\;\\; K=40,\n$$\n即 $q \\in \\{\\,0, 0.5, 1.0, \\dots, 20.0\\,\\mathrm{nm}^{-1}\\,\\}$。\n\n您的程序必须实现以下离散化/加窗案例的测试套件，并为每个案例计算在 $q$ 网格上的最大绝对偏差：\n1. 精细采样，矩形窗：$\\Delta r = 0.002\\,\\mathrm{nm}$，$R_{\\max} = 5.0\\,\\mathrm{nm}$，窗函数 $W_{\\mathrm{rect}}$，补零因子 $p=1$。\n2. 粗糙采样，矩形窗：$\\Delta r = 0.1\\,\\mathrm{nm}$，$R_{\\max} = 5.0\\,\\mathrm{nm}$，窗函数 $W_{\\mathrm{rect}}$，补零因子 $p=1$。\n3. 粗糙采样，Hann窗：$\\Delta r = 0.1\\,\\mathrm{nm}$，$R_{\\max} = 5.0\\,\\mathrm{nm}$，窗函数 $W_{\\mathrm{hann}}$，补零因子 $p=1$。\n4. 粗糙采样，带补零的Blackman窗：$\\Delta r = 0.1\\,\\mathrm{nm}$，$R_{\\max} = 5.0\\,\\mathrm{nm}$，窗函数 $W_{\\mathrm{black}}$，补零因子 $p=8$（即将采样的 $r$ 网格扩展到 $pR_{\\max}$，并将超出 $R_{\\max}$ 的 $g(r)-1$ 设置为零）。\n\n对于参考积分，使用上限 $R_{\\mathrm{ref}} = 10.0\\,\\mathrm{nm}$ 和一个稳健的求积方法，绝对容差为 $10^{-10}$，相对容差为 $10^{-10}$。对于离散近似，使用梯形法则。通过使用 $j_0(0)=1$ 来处理 $q=0$ 的特殊情况。\n\n您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔的结果列表，顺序与上述四个测试案例相同。每个条目必须是在指定 $q$ 网格上的最大绝对误差，表示为不带单位的浮点数。例如，输出格式必须是\n$$\n[\\text{err}_1,\\text{err}_2,\\text{err}_3,\\text{err}_4]\n$$\n其中每个 $\\text{err}_i$ 是一个浮点数。", "solution": "该问题要求推导静态结构因子 $S(\\mathbf{q})$ 与径向分布函数 $g(r)$ 之间的关系，其在各向同性系统下的简化形式，以及随后的一个旨在分析离散化和截断误差的数值实验。\n\n### 第一部分：$S(\\mathbf{q})-g(r)$ 关系的推导\n\n一个包含 $N$ 个粒子的系统，其粒子位置为 $\\{\\mathbf{r}_j\\}$，其微观数密度由下式给出\n$$\n\\rho(\\mathbf{r}) = \\sum_{j=1}^{N} \\delta(\\mathbf{r} - \\mathbf{r}_j),\n$$\n其中 $\\delta(\\mathbf{r})$ 是狄拉克δ函数。其傅里叶变换 $\\hat{\\rho}(\\mathbf{q})$ 为\n$$\n\\hat{\\rho}(\\mathbf{q}) = \\int_{\\mathbb{R}^3} \\rho(\\mathbf{r}) e^{-i\\mathbf{q}\\cdot\\mathbf{r}} d\\mathbf{r} = \\sum_{j=1}^{N} e^{-i\\mathbf{q}\\cdot\\mathbf{r}_j}.\n$$\n静态结构因子 $S(\\mathbf{q})$ 定义为密度傅里叶分量的归一化方差，由下式给出\n$$\nS(\\mathbf{q}) = \\frac{1}{N} \\langle |\\hat{\\rho}(\\mathbf{q})|^2 \\rangle,\n$$\n其中 $\\langle \\cdot \\rangle$ 表示系综平均。展开 $|\\hat{\\rho}(\\mathbf{q})|^2$：\n$$\n|\\hat{\\rho}(\\mathbf{q})|^2 = \\hat{\\rho}(\\mathbf{q})\\hat{\\rho}(-\\mathbf{q}) = \\left( \\sum_{j=1}^{N} e^{-i\\mathbf{q}\\cdot\\mathbf{r}_j} \\right) \\left( \\sum_{k=1}^{N} e^{i\\mathbf{q}\\cdot\\mathbf{r}_k} \\right) = \\sum_{j,k=1}^{N} e^{-i\\mathbf{q}\\cdot(\\mathbf{r}_j - \\mathbf{r}_k)}.\n$$\n将此代入 $S(\\mathbf{q})$ 的定义中，得到\n$$\nS(\\mathbf{q}) = \\frac{1}{N} \\left\\langle \\sum_{j,k=1}^{N} e^{-i\\mathbf{q}\\cdot(\\mathbf{r}_j - \\mathbf{r}_k)} \\right\\rangle.\n$$\n我们将求和分为 $j=k$ 和 $j \\neq k$ 的项：\n$$\nS(\\mathbf{q}) = \\frac{1}{N} \\left\\langle \\sum_{j=1}^{N} e^{-i\\mathbf{q}\\cdot(\\mathbf{r}_j - \\mathbf{r}_j)} + \\sum_{j \\neq k} e^{-i\\mathbf{q}\\cdot(\\mathbf{r}_j - \\mathbf{r}_k)} \\right\\rangle = \\frac{1}{N} \\left\\langle N + \\sum_{j \\neq k} e^{-i\\mathbf{q}\\cdot(\\mathbf{r}_j - \\mathbf{r}_k)} \\right\\rangle,\n$$\n简化为\n$$\nS(\\mathbf{q}) = 1 + \\frac{1}{N} \\left\\langle \\sum_{j \\neq k} e^{-i\\mathbf{q}\\cdot(\\mathbf{r}_j - \\mathbf{r}_k)} \\right\\rangle.\n$$\n求和的系综平均可以用双粒子密度 $n^{(2)}(\\mathbf{r}_1, \\mathbf{r}_2)$ 表示。对于均匀各向同性流体，$n^{(2)}(\\mathbf{r}_1, \\mathbf{r}_2) = \\rho^2 g(|\\mathbf{r}_1 - \\mathbf{r}_2|)$，其中 $\\rho = N/V$ 是平均数密度，$g(r)$ 是径向分布函数。该项变为\n$$\n\\left\\langle \\sum_{j \\neq k} e^{-i\\mathbf{q}\\cdot(\\mathbf{r}_j-\\mathbf{r}_k)} \\right\\rangle = \\int d\\mathbf{r}_1 \\int d\\mathbf{r}_2 \\, n^{(2)}(\\mathbf{r}_1, \\mathbf{r}_2) e^{-i\\mathbf{q}\\cdot(\\mathbf{r}_1 - \\mathbf{r}_2)} = \\rho^2 \\int d\\mathbf{r}_1 \\int d\\mathbf{r}_2 \\, g(|\\mathbf{r}_1-\\mathbf{r}_2|) e^{-i\\mathbf{q}\\cdot(\\mathbf{r}_1 - \\mathbf{r}_2)}.\n$$\n更换变量为 $\\mathbf{r} = \\mathbf{r}_1 - \\mathbf{r}_2$ 和 $\\mathbf{R} = \\mathbf{r}_1$，对 $\\mathbf{R}$ 的积分给出体积 $V$。\n$$\n\\left\\langle \\dots \\right\\rangle = V \\rho^2 \\int_{\\mathbb{R}^3} g(r) e^{-i\\mathbf{q}\\cdot\\mathbf{r}} d\\mathbf{r} = N \\rho \\int_{\\mathbb{R}^3} g(r) e^{-i\\mathbf{q}\\cdot\\mathbf{r}} d\\mathbf{r}.\n$$\n将此代回 $S(\\mathbf{q})$ 的表达式中，得到\n$$\nS(\\mathbf{q}) = 1 + \\rho \\int_{\\mathbb{R}^3} g(r) e^{-i\\mathbf{q}\\cdot\\mathbf{r}} d\\mathbf{r}.\n$$\n由于当 $r \\to \\infty$ 时 $g(r) \\to 1$，该积分不收敛。为了解决这个问题，我们引入总相关函数 $h(r) = g(r) - 1$，它在大的 $r$ 处衰减到零。\n$$\nS(\\mathbf{q}) = 1 + \\rho \\int_{\\mathbb{R}^3} [h(r) + 1] e^{-i\\mathbf{q}\\cdot\\mathbf{r}} d\\mathbf{r} = 1 + \\rho \\int_{\\mathbb{R}^3} h(r) e^{-i\\mathbf{q}\\cdot\\mathbf{r}} d\\mathbf{r} + \\rho \\int_{\\mathbb{R}^3} e^{-i\\mathbf{q}\\cdot\\mathbf{r}} d\\mathbf{r}.\n$$\n最后一项是1的傅里叶变换，它是一个狄拉克δ函数：$\\rho \\int e^{-i\\mathbf{q}\\cdot\\mathbf{r}} d\\mathbf{r} = \\rho (2\\pi)^3 \\delta(\\mathbf{q})$。该项代表前向散射方向（$\\mathbf{q}=\\mathbf{0}$）的散射，并且按惯例从流体的结构因子中分离出来。对于 $\\mathbf{q} \\neq \\mathbf{0}$，该项为零。因此，我们得到所需的关系式：\n$$\nS(\\mathbf{q}) = 1 + \\rho \\int_{\\mathbb{R}^3} [g(r)-1] e^{-i\\mathbf{q}\\cdot\\mathbf{r}} d\\mathbf{r}.\n$$\n\n### 第二部分：各向同性简化\n\n对于各向同性系统，$g(r)$ 仅依赖于大小 $r=|\\mathbf{r}|$。我们可以通过将球坐标系的z轴与向量 $\\mathbf{q}$ 对齐来简化3D傅里叶积分，使得 $\\mathbf{q}\\cdot\\mathbf{r} = qr\\cos\\theta$。体积元为 $d\\mathbf{r} = r^2\\sin\\theta\\,dr\\,d\\theta\\,d\\phi$。\n$$\n\\int_{\\mathbb{R}^3} [g(r)-1] e^{-i\\mathbf{q}\\cdot\\mathbf{r}} d\\mathbf{r} = \\int_0^\\infty dr \\int_0^\\pi d\\theta \\int_0^{2\\pi} d\\phi \\, [g(r)-1] e^{-iqr\\cos\\theta} r^2\\sin\\theta.\n$$\n对 $\\phi$ 的积分得到 $2\\pi$。对 $\\theta$ 的积分是\n$$\n\\int_0^\\pi e^{-iqr\\cos\\theta} \\sin\\theta\\,d\\theta = \\int_{-1}^{1} e^{-iqru} du = \\left[\\frac{e^{-iqru}}{-iqr}\\right]_{-1}^{1} = \\frac{e^{-iqr} - e^{iqr}}{-iqr} = 2 \\frac{\\sin(qr)}{qr}.\n$$\n这个函数 $j_0(qr) = \\sin(qr)/(qr)$ 是零阶球贝塞尔函数。结合这些结果，积分变为\n$$\n4\\pi \\int_0^\\infty [g(r)-1] r^2 \\frac{\\sin(qr)}{qr} dr.\n$$\n因此，对于各向同性系统，结构因子 $S(q)$ 仅依赖于大小 $q=|\\mathbf{q}|$：\n$$\nS(q) = 1 + 4\\pi\\rho \\int_0^\\infty [g(r)-1] r^2 \\frac{\\sin(qr)}{qr} dr.\n$$\n\n### 第三部分：数值实验设计与误差来源\n\n数值实验涉及从模型 $g(r)$ 计算 $S(q)$ 并分析误差。\n-   一个高精度参考值 $S_{\\mathrm{ref}}(q)$ 是使用稳健的数值求积方法 (`scipy.integrate.quad`) 在一个大的定义域 $r \\in [0, R_{\\mathrm{ref}}]$ 上计算的，以近似无限积分。\n-   一个离散近似值 $S_{\\mathrm{disc}}(q)$ 是使用梯形法则在一个离散的点集 $\\{r_i\\}$（间距为 $\\Delta r$，截断长度为 $R_{\\max}$）上计算的。这模拟了实验或模拟数据的处理方式。\n-   $S_{\\mathrm{disc}}(q)$ 和 $S_{\\mathrm{ref}}(q)$ 之间的偏差通过在一组 $q$ 值上的最大绝对误差来量化，即 $\\max_q |S_{\\mathrm{disc}}(q) - S_{\\mathrm{ref}}(q)|$。\n\n影响离散近似精度的关键因素有：\n1.  **采样间隔 ($\\Delta r$)**: 对 $g(r)$ 的离散采样必须足够精细以分辨其特征。粗糙的采样间隔（$\\Delta r$ 过大）会导致混叠，即被积函数的高频分量在变换域中被错误地表示为较低频率，从而导致显著误差。根据奈奎斯特-香农采样定理，采样频率（$1/\\Delta r$）必须至少是信号中存在的最高频率的两倍，以避免混叠。\n2.  **截断长度 ($R_{\\max}$)**: 解析积分是在 $[0, \\infty)$ 上进行的。在数值上，我们必须将其截断为有限长度 $R_{\\max}$。这等效于将函数 $[g(r)-1]$ 乘以一个矩形窗 $W_{\\mathrm{rect}}(r)$，该窗在 $r \\in [0, R_{\\max}]$ 上为 $1$，否则为 $0$。在傅里叶域（q空间）中，这种乘法变成了与窗函数的傅里叶变换的卷积。对于矩形窗，其变换是一个 $\\mathrm{sinc}$ 函数，具有较大的旁瓣。这种卷积会引入伪振荡（吉布斯现象）并展宽谱峰，这种效应被称为频谱泄漏。\n3.  **加窗**: 为了减轻截断引起的频谱泄漏，将函数乘以一个平滑的窗函数（例如，Hann窗、Blackman窗），该函数在 $R_{\\max}$ 处逐渐衰减到零。这些窗函数的傅里叶变换具有小得多的旁瓣，从而显著减少了泄漏，但代价是频谱分辨率稍低（主瓣更宽）。\n4.  **补零**: 在快速傅里叶变换（FFT）算法的背景下，在r域中对数据进行补零，然后在变换，会在q域中产生更密集的频谱采样（插值）。在本问题中，我们对每个 $q$ 值执行直接数值积分。对于直接积分，将积分网格扩展到 $R_{\\max}$ 之外，并在这个填充区域中将被积函数设置为零，并不会改变积分的值。这个案例突显了直接积分和基于FFT的方法之间的关键区别。\n\nPython实现将计算一个参考值 $S_{\\mathrm{ref}}(q)$，然后为四个指定的测试案例评估 $S_{\\mathrm{disc}}(q)$，每个案例具有不同的采样间隔、截断和加窗组合，最后报告每个案例的最大绝对误差。", "answer": "```python\nimport numpy as np\nfrom scipy.integrate import quad, trapezoid\n\ndef solve():\n    \"\"\"\n    Derives and numerically verifies the relation between the static structure factor S(q)\n    and the radial distribution function g(r).\n    \"\"\"\n\n    # Parameters for the g(r) model and system\n    A1 = 0.8\n    r_a = 0.3\n    sigma_a = 0.04\n    A2 = 0.25\n    r_b = 0.9\n    sigma_b = 0.08\n    k0 = 8.0\n    lambda_decay = 2.0\n    rho = 10.0\n\n    # Wavenumber grid for evaluation, in nm^-1\n    q_grid = np.linspace(0.0, 20.0, 41)\n\n    # h(r) = g(r) - 1 function, r in nm\n    def h(r):\n        \"\"\"Computes the total correlation function h(r) = g(r) - 1.\"\"\"\n        term1 = A1 * np.exp(-(r - r_a)**2 / (2 * sigma_a**2))\n        term2 = A2 * np.exp(-(r - r_b)**2 / (2 * sigma_b**2)) * np.cos(k0 * r) * np.exp(-r / lambda_decay)\n        return term1 + term2\n\n    # Spherical Bessel function of order 0, j0(x) = sin(x)/x\n    def j0(x):\n        \"\"\"Computes the spherical Bessel function of order 0, handling x=0.\"\"\"\n        # np.sinc(x/pi) computes sin(pi*x)/(pi*x), so we need to adjust the argument.\n        # Let y = x/pi, then sinc(y) = sin(pi*y)/(pi*y) = sin(x)/x\n        return np.sinc(x / np.pi)\n\n    # --- High-accuracy reference S_ref(q) calculation ---\n    R_ref = 10.0\n    S_ref = np.zeros_like(q_grid)\n    \n    for i, q in enumerate(q_grid):\n        integrand = lambda r: h(r) * r**2 * j0(q * r)\n        integral_val, _ = quad(integrand, 0, R_ref, epsabs=1e-10, epsrel=1e-10)\n        S_ref[i] = 1.0 + 4.0 * np.pi * rho * integral_val\n\n    # --- Test suite for discrete approximations ---\n    test_cases = [\n        # 1. Fine sampling, rectangular window\n        {'dr': 0.002, 'Rmax': 5.0, 'window_name': 'rect', 'p': 1},\n        # 2. Coarse sampling, rectangular window\n        {'dr': 0.1, 'Rmax': 5.0, 'window_name': 'rect', 'p': 1},\n        # 3. Coarse sampling, Hann window\n        {'dr': 0.1, 'Rmax': 5.0, 'window_name': 'hann', 'p': 1},\n        # 4. Coarse sampling, Blackman window with zero-padding\n        {'dr': 0.1, 'Rmax': 5.0, 'window_name': 'blackman', 'p': 8},\n    ]\n\n    max_errors = []\n\n    for case in test_cases:\n        dr = case['dr']\n        Rmax = case['Rmax']\n        window_name = case['window_name']\n        p = case['p']\n\n        R_padded = p * Rmax\n        # Ensure the grid includes 0 and R_padded\n        num_points = int(round(R_padded / dr)) + 1\n        r_grid = np.linspace(0, R_padded, num_points)\n\n        # Calculate h(r) and apply window function\n        h_r = h(r_grid)\n        \n        # The windowed function is non-zero only for r in [0, Rmax]\n        h_r_windowed = np.zeros_like(h_r)\n        \n        # Determine indices within the [0, Rmax] domain. Add small tolerance for float comparison.\n        valid_indices = r_grid = Rmax + 1e-9 * Rmax\n        r_window_domain = r_grid[valid_indices]\n        \n        window_values = np.ones_like(r_window_domain) # Default is rectangular window\n        if window_name == 'hann':\n            if Rmax > 0:\n                window_values = 0.5 * (1.0 - np.cos(2.0 * np.pi * r_window_domain / Rmax))\n        elif window_name == 'blackman':\n            if Rmax > 0:\n                window_values = 0.42 - 0.5 * np.cos(2.0 * np.pi * r_window_domain / Rmax) + 0.08 * np.cos(4.0 * np.pi * r_window_domain / Rmax)\n        \n        h_r_windowed[valid_indices] = h_r[valid_indices] * window_values\n\n        # Calculate S_disc(q) for the current case\n        S_disc = np.zeros_like(q_grid)\n        for i, q in enumerate(q_grid):\n            # Integrand for the trapezoidal rule\n            trapz_integrand = h_r_windowed * r_grid**2 * j0(q * r_grid)\n            integral_val = trapezoid(trapz_integrand, r_grid)\n            S_disc[i] = 1.0 + 4.0 * np.pi * rho * integral_val\n        \n        # Calculate maximum absolute error for this case\n        max_error = np.max(np.abs(S_disc - S_ref))\n        max_errors.append(max_error)\n\n    # Print results in the specified format\n    print(f\"[{','.join(map(str, max_errors))}]\")\n\nsolve()\n\n```", "id": "3450291"}]}