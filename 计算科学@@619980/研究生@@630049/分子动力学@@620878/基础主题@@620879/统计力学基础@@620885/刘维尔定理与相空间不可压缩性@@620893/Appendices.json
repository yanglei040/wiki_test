{"hands_on_practices": [{"introduction": "雅可比行列式是量化坐标变换如何拉伸或压缩相空间体积的根本数学工具。本练习将通过一个在模拟中常见的变换——动量重缩放——来实践计算雅可比行列式，为理解为何某些操作会破坏相空间体积守恒奠定基础。[@problem_id:3421866]", "problem": "考虑一个经典分子动力学系统，该系统由三维空间中的$N$个质点组成，其位置为$\\mathbf{q} = (\\mathbf{q}_{1},\\dots,\\mathbf{q}_{N}) \\in \\mathbb{R}^{3N}$，动量为$\\mathbf{p} = (\\mathbf{p}_{1},\\dots,\\mathbf{p}_{N}) \\in \\mathbb{R}^{3N}$，正质量为$\\mathbf{m} = (m_{1},\\dots,m_{N}) \\in \\mathbb{R}^{N}_{0}$。哈密顿量为$H(\\mathbf{q},\\mathbf{p}) = \\sum_{i=1}^{N} \\frac{|\\mathbf{p}_{i}|^{2}}{2 m_{i}} + U(\\mathbf{q})$，其中$U(\\mathbf{q})$是一个光滑势。正则相空间测度是$\\mathbb{R}^{6N}$上的勒贝格测度$\\mathrm{d}\\mathbf{q}\\,\\mathrm{d}\\mathbf{p}$，而包含质量的扩展测度是$\\mathbb{R}^{7N}$上的$\\mathrm{d}\\mathbf{q}\\,\\mathrm{d}\\mathbf{p}\\,\\mathrm{d}\\mathbf{m}$。\n\n在$t_{0}$时刻，施加一个瞬时的“温度跳跃”操作，该操作对所有粒子以一个统一的因子$\\alpha0$重标度其动量，而位置和质量初始保持不变：对所有$i=1,\\dots,N$，有$\\mathbf{p}_{i} \\mapsto \\alpha\\,\\mathbf{p}_{i}$。\n\n仅使用第一性原理（坐标变换的雅可比行列式的定义以及正则相空间测度的结构），完成以下任务：\n\n1. 计算由动量重标度$\\mathbf{p}\\mapsto \\alpha\\,\\mathbf{p}$（$\\mathbf{q}$不变）在$(\\mathbf{q},\\mathbf{p})$上引起的变换的雅可比行列式的绝对值。\n\n2. 为了对一个原本非哈密顿的瞬时映射强制实现相空间的不可压缩性，可以设计一个组合的瞬时标度变换，该变换除了$\\mathbf{p}\\mapsto \\alpha\\,\\mathbf{p}$之外，还将坐标和质量重标度为$\\mathbf{q}\\mapsto \\beta\\,\\mathbf{q}$（$\\beta0$）和$\\mathbf{m}\\mapsto \\gamma\\,\\mathbf{m}$（$\\gamma0$）。将$(\\mathbf{q},\\mathbf{p},\\mathbf{m})$视为具有测度$\\mathrm{d}\\mathbf{q}\\,\\mathrm{d}\\mathbf{p}\\,\\mathrm{d}\\mathbf{m}$的扩展空间上的坐标，计算该组合映射的雅可比行列式的绝对值，并推导出使扩展空间体积元保持不变（即$|\\det J|=1$）时$\\beta$和$\\gamma$应满足的条件（用$\\alpha$表示）。\n\n将你的最终结果以一个行矩阵的形式报告，该矩阵按此顺序包含：(i) 第1部分中纯动量标度变换的雅可比行列式的绝对值，以及 (ii) 第2部分中保证$|\\det J|=1$的、作为$\\alpha$和$\\beta$的函数的$\\gamma$的显式表达式。无需进行数值计算；请提供一个闭式解析表达式。不要在最终答案中包含任何单位。", "solution": "用户提供了一个经典力学问题，涉及标度操作下相空间体积元的变换。在尝试解答之前，需根据严格标准对该问题进行验证。\n\n### 问题验证\n\n**步骤1：提取给定条件**\n- **系统**：三维空间中的$N$个质点。\n- **坐标**：位置$\\mathbf{q} = (\\mathbf{q}_{1},\\dots,\\mathbf{q}_{N}) \\in \\mathbb{R}^{3N}$，动量$\\mathbf{p} = (\\mathbf{p}_{1},\\dots,\\mathbf{p}_{N}) \\in \\mathbb{R}^{3N}$。\n- **参数**：正质量$\\mathbf{m} = (m_{1},\\dots,m_{N}) \\in \\mathbb{R}^{N}_{0}$。\n- **哈密顿量**：$H(\\mathbf{q},\\mathbf{p}) = \\sum_{i=1}^{N} \\frac{|\\mathbf{p}_{i}|^{2}}{2 m_{i}} + U(\\mathbf{q})$，其中$U(\\mathbf{q})$是一个光滑势。\n- **测度**：正则相空间测度是$\\mathbb{R}^{6N}$上的$\\mathrm{d}\\mathbf{q}\\,\\mathrm{d}\\mathbf{p}$。扩展测度是$\\mathbb{R}^{7N}$上的$\\mathrm{d}\\mathbf{q}\\,\\mathrm{d}\\mathbf{p}\\,\\mathrm{d}\\mathbf{m}$。\n- **变换1（第1部分）**：正则相空间$(\\mathbf{q}, \\mathbf{p})$上的一个瞬时变换，其中$\\mathbf{q} \\mapsto \\mathbf{q}' = \\mathbf{q}$ 且 $\\mathbf{p} \\mapsto \\mathbf{p}' = \\alpha\\,\\mathbf{p}$，标度因子$\\alpha0$。\n- **变换2（第2部分）**：扩展空间$(\\mathbf{q}, \\mathbf{p}, \\mathbf{m})$上的一个瞬时变换，其中$\\mathbf{q} \\mapsto \\mathbf{q}' = \\beta\\,\\mathbf{q}$，$\\mathbf{p} \\mapsto \\mathbf{p}' = \\alpha\\,\\mathbf{p}$，以及 $\\mathbf{m} \\mapsto \\mathbf{m}' = \\gamma\\,\\mathbf{m}$，标度因子$\\alpha0$，$\\beta0$，$\\gamma0$。\n- **目标1**：计算变换1的雅可比行列式的绝对值。\n- **目标2**：计算变换2的雅可比行列式的绝对值，并找到使该行列式等于$1$的、关联$\\alpha$、$\\beta$和$\\gamma$的条件。\n\n**步骤2：使用提取的给定条件进行验证**\n- **科学基础**：该问题设置在哈密顿力学和统计物理的成熟框架内。相空间、坐标变换的雅可比行列式以及体积元等概念是这些领域的基础。动量重标度是非平衡分子动力学模拟中的一种标准技术。该问题在科学上是合理的。\n- **适定性**：变换和变量都得到了明确定义。目标是清晰的、定量的数学任务。存在唯一解，并且可以直接从定义中推导出来。\n- **客观性**：该问题以精确、形式化的数学语言陈述，没有歧义或主观陈述。\n\n该问题没有任何无效性缺陷。它在科学上是合理的，陈述是形式化的，内容是自洽的，并基于向量微积分和经典力学的第一性原理，提出了一个非平凡但可解的挑战。\n\n**步骤3：结论与行动**\n问题被判定为**有效**。将提供完整解答。\n\n### 解答\n\n解答需要计算两个指定坐标变换的雅可比行列式。一个变换的雅可比行列式衡量了体积元被拉伸或压缩的因子。\n\n**第1部分：动量重标度的雅可比行列式**\n\n设初始坐标表示为$X = (\\mathbf{q}, \\mathbf{p})$，变换后的坐标表示为$X' = (\\mathbf{q}', \\mathbf{p}')$。该变换由下式给出：\n$$ \\mathbf{q}' = \\mathbf{q} $$\n$$ \\mathbf{p}' = \\alpha \\mathbf{p} $$\n相空间是$6N$维的，坐标为$(q_{1,1}, \\dots, q_{N,3}, p_{1,1}, \\dots, p_{N,3})$。该变换的雅可比矩阵$J_1$是一个$6N \\times 6N$矩阵，其元素为$J_{ij} = \\frac{\\partial X'_i}{\\partial X_j}$。由于变换的结构，该矩阵是分块对角的：\n$$ J_1 = \\begin{pmatrix} \\frac{\\partial \\mathbf{q}'}{\\partial \\mathbf{q}}  \\frac{\\partial \\mathbf{q}'}{\\partial \\mathbf{p}} \\\\ \\frac{\\partial \\mathbf{p}'}{\\partial \\mathbf{q}}  \\frac{\\partial \\mathbf{p}'}{\\partial \\mathbf{p}} \\end{pmatrix} $$\n我们计算每个分块：\n- $\\frac{\\partial \\mathbf{q}'}{\\partial \\mathbf{q}}$：由于$\\mathbf{q}' = \\mathbf{q}$，这是$3N \\times 3N$的单位矩阵$I_{3N}$。\n- $\\frac{\\partial \\mathbf{q}'}{\\partial \\mathbf{p}}$：由于$\\mathbf{q}'$不依赖于$\\mathbf{p}$，这是$3N \\times 3N$的零矩阵$0_{3N \\times 3N}$。\n- $\\frac{\\partial \\mathbf{p}'}{\\partial \\mathbf{q}}$：由于$\\mathbf{p}'$不依赖于$\\mathbf{q}$，这是$3N \\times 3N$的零矩阵$0_{3N \\times 3N}$。\n- $\\frac{\\partial \\mathbf{p}'}{\\partial \\mathbf{p}}$：由于$\\mathbf{p}' = \\alpha \\mathbf{p}$，$\\mathbf{p}'$的第$i$个分量对$\\mathbf{p}$的第$j$个分量的导数是$\\frac{\\partial (\\alpha p_i)}{\\partial p_j} = \\alpha \\delta_{ij}$。因此，这个分块是$\\alpha$乘以$3N \\times 3N$的单位矩阵，即$\\alpha I_{3N}$。\n\n因此，雅可比矩阵为：\n$$ J_1 = \\begin{pmatrix} I_{3N}  0_{3N \\times 3N} \\\\ 0_{3N \\times 3N}  \\alpha I_{3N} \\end{pmatrix} $$\n分块对角矩阵的行列式是其对角线上各分块行列式的乘积：\n$$ \\det(J_1) = \\det(I_{3N}) \\cdot \\det(\\alpha I_{3N}) $$\n单位矩阵的行列式是$1$。单位矩阵$cI_k$的标量倍数的行列式是$c^k$。因此：\n$$ \\det(J_1) = 1 \\cdot \\alpha^{3N} = \\alpha^{3N} $$\n由于$\\alpha  0$，行列式为正，其绝对值为$|\\det(J_1)| = \\alpha^{3N}$。\n\n**第2部分：扩展空间中组合标度变换的雅可比行列式**\n\n设扩展空间中的初始坐标为$Y = (\\mathbf{q}, \\mathbf{p}, \\mathbf{m})$，变换后的坐标为$Y' = (\\mathbf{q}', \\mathbf{p}', \\mathbf{m}')$。该变换定义为：\n$$ \\mathbf{q}' = \\beta \\mathbf{q} $$\n$$ \\mathbf{p}' = \\alpha \\mathbf{p} $$\n$$ \\mathbf{m}' = \\gamma \\mathbf{m} $$\n这个扩展空间的维度是$3N + 3N + N = 7N$。该变换的雅可比矩阵$J_2$是一个$7N \\times 7N$矩阵。由于对$\\mathbf{q}$、$\\mathbf{p}$和$\\mathbf{m}$的变换是相互独立的，雅可比矩阵是分块对角的：\n$$ J_2 = \\begin{pmatrix} \\frac{\\partial \\mathbf{q}'}{\\partial \\mathbf{q}}  0  0 \\\\ 0  \\frac{\\partial \\mathbf{p}'}{\\partial \\mathbf{p}}  0 \\\\ 0  0  \\frac{\\partial \\mathbf{m}'}{\\partial \\mathbf{m}} \\end{pmatrix} $$\n我们计算每个分块的行列式：\n- $\\frac{\\partial \\mathbf{q}'}{\\partial \\mathbf{q}}$：这是$3N \\times 3N$矩阵$\\beta I_{3N}$。其行列式为$\\det(\\beta I_{3N}) = \\beta^{3N}$。\n- $\\frac{\\partial \\mathbf{p}'}{\\partial \\mathbf{p}}$：这是$3N \\times 3N$矩阵$\\alpha I_{3N}$。其行列式为$\\det(\\alpha I_{3N}) = \\alpha^{3N}$。\n- $\\frac{\\partial \\mathbf{m}'}{\\partial \\mathbf{m}}$：这是$N \\times N$矩阵$\\gamma I_{N}$。其行列式为$\\det(\\gamma I_{N}) = \\gamma^{N}$。\n\n整个雅可比矩阵$J_2$的行列式是这些分块行列式的乘积：\n$$ \\det(J_2) = \\det(\\beta I_{3N}) \\cdot \\det(\\alpha I_{3N}) \\cdot \\det(\\gamma I_{N}) = \\beta^{3N} \\alpha^{3N} \\gamma^{N} $$\n问题要求雅可比行列式的绝对值为1，这强制实现了扩展体积元$\\mathrm{d}\\mathbf{q}\\,\\mathrm{d}\\mathbf{p}\\,\\mathrm{d}\\mathbf{m}$的不变性。由于$\\alpha, \\beta, \\gamma  0$，行列式为正，因此我们设$\\det(J_2) = 1$：\n$$ \\alpha^{3N} \\beta^{3N} \\gamma^{N} = 1 $$\n为了找到对$\\gamma$的条件，我们求解$\\gamma$：\n$$ \\gamma^{N} = (\\alpha^{3N} \\beta^{3N})^{-1} = \\alpha^{-3N} \\beta^{-3N} = (\\alpha \\beta)^{-3N} $$\n对两边取$N$次根（并已知$\\gamma  0$）：\n$$ \\gamma = \\left( (\\alpha \\beta)^{-3N} \\right)^{1/N} = (\\alpha \\beta)^{-3} = \\frac{1}{(\\alpha \\beta)^3} $$\n这就是确保变换在扩展空间中是保体积的所需满足的$\\gamma$的条件。\n\n最终结果是：第1部分的$|\\det(J_1)| = \\alpha^{3N}$，以及第2部分的表达式$\\gamma = (\\alpha \\beta)^{-3}$。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\alpha^{3N}  (\\alpha \\beta)^{-3}\n\\end{pmatrix}\n}\n$$", "id": "3421866"}, {"introduction": "理论上，哈密顿动力学是保体积的，但数值近似往往会破坏这一美妙性质。这个编程练习旨在让你亲手实现并对比两种积分方法——保辛的Velocity Verlet算法和非保辛的四阶龙格-库塔(RK4)算法——直观地展示刘维尔定理在实际模拟中的重要性及其对算法选择的影响。[@problem_id:3421857]", "problem": "考虑一个一维非谐振子，其哈密顿量为 $$H(q,p)=\\frac{p^2}{2m}+\\frac{k}{2}q^2+\\frac{\\alpha}{4}q^4$$, 其中 $q$ 是位置，$p$ 是动量，$m$ 是质量，$k$ 是线性刚度系数，$\\alpha$ 是四次非和谐系数。相关的哈密顿方程为 $$\\dot{q}=\\frac{p}{m},\\quad \\dot{p}=-\\frac{\\partial V}{\\partial q}=-k\\,q-\\alpha\\,q^3$$. 定义相空间流映射 $\\Gamma_t:\\,(q_0,p_0)\\mapsto (q(t),p(t))$，其中 $(q(t),p(t))$ 是在这些方程下从初始条件 $(q_0,p_0)$ 演化到时间 $t$ 的状态。\n\n刘维尔定理（Liouville's theorem）指出，哈密顿矢量场在正则坐标中的散度为零，这意味着精确流保持相空间体积。在数值上，我们使用离散时间步长 $\\Delta t$ 和选定的积分算法来对常微分方程进行积分。像速度 Verlet 这样的辛方法（symplectic method）被设计用来保持辛结构，从而保持相空间体积，而像经典的四阶龙格-库塔（Runge-Kutta）方法这样的通用方法可能不具备此特性。为了量化数值流在有限时间内引起的相空间体积变化，可以估计流映射相对于初始条件的雅可比矩阵（Jacobian）的行列式。具体来说，对于 $t=N\\Delta t$，定义由给定积分器引起的离散数值流映射 $\\Phi_{N\\Delta t}$，并估计 $$\\left|\\det\\left(\\frac{\\partial \\Gamma_t}{\\partial \\Gamma_0}\\right)\\right|\\approx \\left|\\det\\left(\\frac{\\partial \\Phi_{N\\Delta t}}{\\partial (q_0,p_0)}\\right)\\right|$$. 对于精确的哈密顿流，该行列式对所有 $t$ 都应为 $1$。偏离 $1$ 的值表示数值方法引入的相空间压缩或膨胀。\n\n你的任务是编写一个完整的程序，该程序：\n- 实现两种时间离散化方法来近似流 $\\Phi_{N\\Delta t}$：\n  1. 速度 Verlet（一种辛格式），应用于可分离的哈密顿量 $H(q,p)=T(p)+V(q)$，其中 $T(p)=p^2/(2m)$ 和 $V(q)=(k/2)q^2+(\\alpha/4)q^4$。\n  2. 经典四阶龙格-库塔（RK4），直接应用于系统 $\\dot{q}=p/m$ 和 $\\dot{p}=-kq-\\alpha q^3$。\n- 在给定的 $(q_0,p_0)$ 处，通过中心有限差分近似雅可比矩阵 $\\partial \\Phi_{N\\Delta t}/\\partial (q_0,p_0)$，在初始条件的基方向上使用大小为 $\\varepsilon0$ 的微扰：\n  - 第一列近似为 $$\\frac{1}{2\\varepsilon}\\left(\\Phi_{N\\Delta t}(q_0+\\varepsilon,p_0)-\\Phi_{N\\Delta t}(q_0-\\varepsilon,p_0)\\right)$$,\n  - 第二列近似为 $$\\frac{1}{2\\varepsilon}\\left(\\Phi_{N\\Delta t}(q_0,p_0+\\varepsilon)-\\Phi_{N\\Delta t}(q_0,p_0-\\varepsilon)\\right)$$.\n- 计算这两种方法的 $2\\times 2$ 雅可比矩阵的行列式，并返回其与 1 的绝对偏差，即 $$E=\\left|\\det(J)-1\\right|$$.\n\n所有量都是无量纲的；不需要物理单位。此问题中不出现角度。对有限差分使用以下固定的微扰大小：$\\varepsilon=10^{-7}$。\n\n实现该程序以评估以下测试套件。在所有情况下，设置 $m=1$，$k=1$，和 $\\alpha=0.2$。设总演化时间为 $t=N\\Delta t$，其中 $N=\\text{round}(t/\\Delta t)$，$t$ 和 $\\Delta t$ 的选择使得 $t/\\Delta t$ 在构造上是整数。\n\n测试套件（每个案例是一个元组 $(q_0,p_0,\\Delta t,t)$）：\n1. $(q_0,p_0,\\Delta t,t)=\\left(0.5,\\,0.0,\\,0.01,\\,10\\right)$,\n2. $(q_0,p_0,\\Delta t,t)=\\left(1.0,\\,1.0,\\,0.1,\\,10\\right)$,\n3. $(q_0,p_0,\\Delta t,t)=\\left(0.0,\\,2.0,\\,0.25,\\,10\\right)$,\n4. $(q_0,p_0,\\Delta t,t)=\\left(-1.0,\\,0.5,\\,0.01,\\,100\\right)$.\n\n对于每个测试案例，计算两个浮点数：\n- 使用速度 Verlet 的 $E_{\\text{VV}}=\\left|\\det(J_{\\text{VV}})-1\\right|$，\n- 使用 RK4 的 $E_{\\text{RK4}}=\\left|\\det(J_{\\text{RK4}})-1\\right|$。\n\n您的程序应生成单行输出，其中包含结果，格式为方括号内以逗号分隔的列表，按测试案例和方法排序如下：\n$$\\left[E_{\\text{VV}}^{(1)},E_{\\text{RK4}}^{(1)},E_{\\text{VV}}^{(2)},E_{\\text{RK4}}^{(2)},E_{\\text{VV}}^{(3)},E_{\\text{RK4}}^{(3)},E_{\\text{VV}}^{(4)},E_{\\text{RK4}}^{(4)}\\right],$$\n每个浮点数格式化为 $10$ 位小数。", "solution": "目标是通过估计数值流映射相对于初始条件的雅可比矩阵的行列式，来评估两种数值积分器对于一维非谐振子的相空间体积保持特性。起点是从哈密顿量 $$H(q,p)=\\frac{p^2}{2m}+\\frac{k}{2}q^2+\\frac{\\alpha}{4}q^4$$ 推导出的哈密顿方程。正则运动方程为 $$\\dot{q}=\\frac{\\partial H}{\\partial p}=\\frac{p}{m},\\quad \\dot{p}=-\\frac{\\partial H}{\\partial q}=-k\\,q-\\alpha\\,q^3$$. 根据刘维尔定理（Liouville's theorem），由这些方程生成的精确流在相空间 $(q,p)$ 中是保体积的。该定理源于哈密顿矢量场的散度，即 $$\\nabla\\cdot(\\dot{q},\\dot{p})=\\frac{\\partial \\dot{q}}{\\partial q}+\\frac{\\partial \\dot{p}}{\\partial p}=\\frac{\\partial}{\\partial q}\\left(\\frac{p}{m}\\right)+\\frac{\\partial}{\\partial p}\\left(-\\frac{\\partial H}{\\partial q}\\right)=0+0=0$$, 因为在正则坐标中，$\\dot{q}$ 仅依赖于 $p$，而 $\\dot{p}$ 仅依赖于 $q$。零散度意味着相空间中的体积元在连续流下是守恒的，这得出 $$\\left|\\det\\left(\\frac{\\partial \\Gamma_t}{\\partial \\Gamma_0}\\right)\\right|=1$$ 对所有时间 $t$ 成立。\n\n对于数值积分，我们考虑两种离散时间映射 $\\Phi_{\\Delta t}$：\n1. 速度 Verlet，通过对可分离哈密顿量 $H=T(p)+V(q)$ 进行 Strang 分裂推导得出。每个子流（动能和势能）都是一个精确的正则变换，其雅可比行列式为单位一，它们的对称组合产生一个辛的、时间可逆的映射。因此，在精确算术中，复合的离散映射是辛的，对于任何步长都有 $\\left|\\det\\left(\\partial \\Phi_{N\\Delta t}/\\partial (q_0,p_0)\\right)\\right|=1$，尽管数值舍入误差和有限差分近似可能会引入与 1 的微小偏差。\n2. 经典四阶龙格-库塔（RK4），它能精确地逼近局部截断误差，但对于一般的哈密顿系统而言不是辛的。因此，它不严格保持辛形式或相空间体积，预计 $\\left|\\det\\left(\\partial \\Phi_{N\\Delta t}/\\partial (q_0,p_0)\\right)\\right|$ 与 1 的偏差会随着步长增大和积分时间变长而累积。\n\n为了对选定的积分器在给定初始条件 $(q_0,p_0)$ 处估计雅可比矩阵 $\\partial \\Phi_{N\\Delta t}/\\partial (q_0,p_0)$，我们通过将单步映射迭代 $N$ 次来计算数值流 $\\Phi_{N\\Delta t}$，其中 $N=t/\\Delta t$ 是一个整数。雅可比矩阵通过在初始条件基矢量方向上的中心有限差分进行近似：\n- 设 $\\varepsilon0$ 为一个小标量。计算微扰后的最终状态：\n  - $(q^{+q},p^{+q})=\\Phi_{N\\Delta t}(q_0+\\varepsilon,p_0)$ 和 $(q^{-q},p^{-q})=\\Phi_{N\\Delta t}(q_0-\\varepsilon,p_0)$,\n  - $(q^{+p},p^{+p})=\\Phi_{N\\Delta t}(q_0,p_0+\\varepsilon)$ 和 $(q^{-p},p^{-p})=\\Phi_{N\\Delta t}(q_0,p_0-\\varepsilon)$.\n- 构造数值雅可比矩阵 $J\\in\\mathbb{R}^{2\\times 2}$，其列为\n  $$J_{:,1}=\\frac{1}{2\\varepsilon}\\begin{bmatrix}q^{+q}-q^{-q}\\\\p^{+q}-p^{-q}\\end{bmatrix},\\quad J_{:,2}=\\frac{1}{2\\varepsilon}\\begin{bmatrix}q^{+p}-q^{-p}\\\\p^{+p}-p^{-p}\\end{bmatrix}$$.\n- 计算行列式 $\\det(J)$ 并报告与 1 的绝对偏差 $E=\\left|\\det(J)-1\\right|$。\n\n对于速度 Verlet，单步映射的构造是：使用力 $F(q)=-\\partial V/\\partial q=-k\\,q-\\alpha\\,q^3$ 进行半步动量更新，然后使用更新后的半步动量进行全步位置更新，最后使用在新位置上计算的力再进行半步动量更新。具体来说，记 $(q_n,p_n)$ 为离散时间 $n$ 的状态，更新步骤如下：\n- 半步动量更新：$p_{n+\\frac{1}{2}}=p_n+\\frac{\\Delta t}{2}F(q_n)$,\n- 全步位置更新：$q_{n+1}=q_n+\\Delta t\\,\\frac{p_{n+\\frac{1}{2}}}{m}$,\n- 半步动量更新：$p_{n+1}=p_{n+\\frac{1}{2}}+\\frac{\\Delta t}{2}F(q_{n+1})$.\n由于 $T$ 和 $V$ 的精确子流的组合，此映射是辛的。\n\n对于 RK4，单步映射将经典的四阶格式应用于矢量场 $(\\dot{q},\\dot{p})=(p/m,-k\\,q-\\alpha\\,q^3)$。设 $x=(q,p)$ 和 $f(x)=(p/m,\\,-k\\,q-\\alpha\\,q^3)$，则步进为\n$$x_{n+1}=x_n+\\frac{\\Delta t}{6}\\left(k_1+2k_2+2k_3+k_4\\right)$$,\n其中 $k_1=f(x_n)$，$k_2=f\\left(x_n+\\frac{\\Delta t}{2}k_1\\right)$，$k_3=f\\left(x_n+\\frac{\\Delta t}{2}k_2\\right)$，以及 $k_4=f\\left(x_n+\\Delta t\\,k_3\\right)$。\n\n使用指定的测试套件，其中 $m=1$, $k=1$, $\\alpha=0.2$, $\\varepsilon=10^{-7}$，程序对每种方法下的每个案例进行积分，构造有限差分雅可比矩阵，计算 $\\det(J)$，并输出包含八个浮点数的列表\n$$\\left[E_{\\text{VV}}^{(1)},E_{\\text{RK4}}^{(1)},E_{\\text{VV}}^{(2)},E_{\\text{RK4}}^{(2)},E_{\\text{VV}}^{(3)},E_{\\text{RK4}}^{(3)},E_{\\text{VV}}^{(4)},E_{\\text{RK4}}^{(4)}\\right],$$\n每个浮点数格式化为10位小数。基于刘维尔定理和辛积分器的性质，预期 $E_{\\text{VV}}$ 在所有案例中都将接近机器精度，而 $E_{\\text{RK4}}$ 通常会更大，并随步长 $\\Delta t$ 和总积分时间 $t$ 的增加而增加，这反映了非辛离散化引入的相空间体积偏差。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef force(q, k, alpha):\n    # Force F(q) = -dV/dq = -k*q - alpha*q^3\n    return -k * q - alpha * (q ** 3)\n\ndef velocity_verlet_flow(q0, p0, dt, steps, m, k, alpha):\n    q = float(q0)\n    p = float(p0)\n    for _ in range(steps):\n        p_half = p + 0.5 * dt * force(q, k, alpha)\n        q = q + dt * (p_half / m)\n        p = p_half + 0.5 * dt * force(q, k, alpha)\n    return np.array([q, p], dtype=np.float64)\n\ndef rk4_flow(q0, p0, dt, steps, m, k, alpha):\n    q = float(q0)\n    p = float(p0)\n\n    def f(q, p):\n        dqdt = p / m\n        dpdt = -k * q - alpha * (q ** 3)\n        return dqdt, dpdt\n\n    for _ in range(steps):\n        k1_q, k1_p = f(q, p)\n        k2_q, k2_p = f(q + 0.5 * dt * k1_q, p + 0.5 * dt * k1_p)\n        k3_q, k3_p = f(q + 0.5 * dt * k2_q, p + 0.5 * dt * k2_p)\n        k4_q, k4_p = f(q + dt * k3_q, p + dt * k3_p)\n\n        q += (dt / 6.0) * (k1_q + 2.0 * k2_q + 2.0 * k3_q + k4_q)\n        p += (dt / 6.0) * (k1_p + 2.0 * k2_p + 2.0 * k3_p + k4_p)\n    return np.array([q, p], dtype=np.float64)\n\ndef jacobian_det_numeric(flow_func, q0, p0, dt, steps, m, k, alpha, eps):\n    # Central finite differences to approximate Jacobian columns\n    x_plus_q = flow_func(q0 + eps, p0, dt, steps, m, k, alpha)\n    x_minus_q = flow_func(q0 - eps, p0, dt, steps, m, k, alpha)\n    col_q = (x_plus_q - x_minus_q) / (2.0 * eps)\n\n    x_plus_p = flow_func(q0, p0 + eps, dt, steps, m, k, alpha)\n    x_minus_p = flow_func(q0, p0 - eps, dt, steps, m, k, alpha)\n    col_p = (x_plus_p - x_minus_p) / (2.0 * eps)\n\n    J = np.column_stack((col_q, col_p))\n    detJ = J[0, 0] * J[1, 1] - J[0, 1] * J[1, 0]\n    return detJ\n\ndef solve():\n    # Parameters\n    m = 1.0\n    k = 1.0\n    alpha = 0.2\n    eps = 1e-7\n\n    # Define the test cases from the problem statement:\n    # Each test case: (q0, p0, dt, t)\n    test_cases = [\n        (0.5, 0.0, 0.01, 10.0),\n        (1.0, 1.0, 0.1, 10.0),\n        (0.0, 2.0, 0.25, 10.0),\n        (-1.0, 0.5, 0.01, 100.0),\n    ]\n\n    results = []\n    for (q0, p0, dt, t_total) in test_cases:\n        steps = int(round(t_total / dt))\n        # Velocity Verlet\n        det_vv = jacobian_det_numeric(velocity_verlet_flow, q0, p0, dt, steps, m, k, alpha, eps)\n        err_vv = abs(det_vv - 1.0)\n        results.append(f\"{err_vv:.10f}\")\n\n        # RK4\n        det_rk4 = jacobian_det_numeric(rk4_flow, q0, p0, dt, steps, m, k, alpha, eps)\n        err_rk4 = abs(det_rk4 - 1.0)\n        results.append(f\"{err_rk4:.10f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```", "id": "3421857"}, {"introduction": "面对非自治系统（例如，参数随时间变化的系统），我们如何设计保体积的积分算法？本练习将引导你学习一种强大的理论技巧：通过将系统嵌入一个更高维的扩展相空间，构造一个新的、等效的自治哈密顿系统，从而保证其相流是不可压缩的。这个方法是现代高级模拟算法设计的基石之一。[@problem_id:3421893]", "problem": "考虑一个用于分子动力学（MD）的系统，该系统具有 $N$ 个自由度，位置为 $q \\in \\mathbb{R}^{N}$，正则共轭动量为 $p \\in \\mathbb{R}^{N}$。其动能采用显式含时质量 $m_{i}(t)  0$，其势能也可能依赖于时间 $t$。非自治哈密顿量为\n$$\nH(q,p,t) \\equiv \\sum_{i=1}^{N} \\frac{p_{i}^{2}}{2\\,m_{i}(t)} + V(q,t).\n$$\n您希望通过将此系统嵌入一个自治的扩展哈密顿系统中来构造一个可逆的、保体积的积分器。该扩展系统的状态由一个新的坐标 $\\theta$ 及其正则共轭动量 $\\pi$ 扩充。设计目标是，当扩展动力学投影到 $(q,p)$ 上并将 $\\theta$ 解释为物理时间时，能够再现原始的非自治运动方程，并且扩展流是不可压缩的，即其相空间可 compressibility 性 $\\kappa$ 为零。\n\n仅从 Hamilton 方程和相空间可压缩性的定义出发，执行以下步骤：\n\n- 假设一个广义的扩展哈密顿量 $H_{\\mathrm{ext}}(q,p,\\theta,\\pi)$，它能够退化为原始的非自治动力学，即在其扩展轨迹上，投影后的运动方程满足 $\\dot{q}_{i} = p_{i}/m_{i}(\\theta)$ 和 $\\dot{p}_{i} = -\\partial V(q,\\theta)/\\partial q_{i}$，同时强制要求 $\\dot{\\theta} = 1$。\n- 使用 Hamilton 方程，推导与这些要求一致的 $H_{\\mathrm{ext}}(q,p,\\theta,\\pi)$ 的形式，推导结果可以相差一个无关的加性常数。\n- 将扩展相空间可压缩性 $\\kappa_{\\mathrm{ext}}$ 定义为扩展矢量场在坐标 $(q,p,\\theta,\\pi)$ 下的散度，并证明对于您得到的 $H_{\\mathrm{ext}}$，该可 compressibility 性为零，即 $\\kappa_{\\mathrm{ext}} = 0$。\n- 简要解释如何通过将扩展哈密顿量分裂为可解析积分的部分来构造一个时间可逆、保体积的 Trotter–Strang 分裂，除了 Hamilton 方程和散度定义外，不使用任何现成的公式或定理。\n\n您的最终答案应该是满足上述性质的扩展哈密顿量 $H_{\\mathrm{ext}}(q,p,\\theta,\\pi)$ 的显式解析表达式。不包含单位，也不要四舍五入；请提供一个闭式表达式。", "solution": "用户想要解决一个哈密顿力学问题。\n\n### 步骤 1：提取已知条件\n- **系统**：$N$ 个自由度。\n- **坐标**：位置 $q \\in \\mathbb{R}^{N}$，动量 $p \\in \\mathbb{R}^{N}$。\n- **非自治哈密顿量**：$H(q,p,t) \\equiv \\sum_{i=1}^{N} \\frac{p_{i}^{2}}{2\\,m_{i}(t)} + V(q,t)$，其中 $m_{i}(t)  0$。\n- **扩展系统**：状态由一个坐标 $\\theta$ 及其共轭动量 $\\pi$ 扩充。扩展状态为 $(q,p,\\theta,\\pi)$。\n- **扩展系统的动力学要求**：\n    1. 投影后的运动方程必须满足 $\\dot{q}_{i} = p_{i}/m_{i}(\\theta)$ 和 $\\dot{p}_{i} = -\\partial V(q,\\theta)/\\partial q_{i}$。这些是原始的运动方程，其中物理时间 $t$ 被坐标 $\\theta$ 替代。\n    2. 新坐标的动力学必须满足 $\\dot{\\theta} = 1$。\n    3. 扩展流必须是不可压缩的，即其相空间可压缩性 $\\kappa_{\\mathrm{ext}}$ 必须为零。\n- **任务**：\n    1. 推导与要求一致的扩展哈密顿量 $H_{\\mathrm{ext}}(q,p,\\theta,\\pi)$ 的形式。\n    2. 证明对于推导出的 $H_{\\mathrm{ext}}$，扩展相空间可压缩性 $\\kappa_{\\mathrm{ext}}$ 为零。\n    3. 解释如何构造一个可逆的、保体积的 Trotter–Strang 分裂。\n- **最终答案**：$H_{\\mathrm{ext}}(q,p,\\theta,\\pi)$ 的显式表达式。\n\n### 步骤 2：使用提取的已知条件进行验证\n- **科学上合理**：是的。该问题描述了“哈密顿辛化”或“扩展相空间”方法，这是计算经典力学和统计力学中将非自治哈密顿系统处理为自治系统的一种标准而严谨的技术。所有概念——Hamilton 方程、相空间可压缩性（Liouville 定理）和算符分裂——都是该领域的基础。\n- **良定的**：是的。该问题提供了一组清晰的约束条件，并要求推导满足这些约束的特定数学对象（$H_{\\mathrm{ext}}$）。求解路径是明确的。\n- **客观的**：是的。语言是形式化和数学化的，没有主观或含糊不清的陈述。\n\n### 步驟 3：結論和行動\n该问题是**有效的**。这是高等经典力学及其计算应用中的一个标准推导。前提合理，目标清晰，所需步骤逻辑关联。我将进行完整求解。\n\n该问题要求进行几项推导。我们将逐步进行。\n\n**1. 扩展哈密顿量 $H_{\\mathrm{ext}}$ 的推导**\n\n我们正在寻找扩展相空间坐标为 $(q,p,\\theta,\\pi)$ 的自治哈密顿量 $H_{\\mathrm{ext}}(q,p,\\theta,\\pi)$。该系统的动力学由 Hamilton 方程决定：\n$$ \\dot{q}_{i} = \\frac{\\partial H_{\\mathrm{ext}}}{\\partial p_{i}}, \\quad \\dot{p}_{i} = -\\frac{\\partial H_{\\mathrm{ext}}}{\\partial q_{i}} $$\n$$ \\dot{\\theta} = \\frac{\\partial H_{\\mathrm{ext}}}{\\partial \\pi}, \\quad \\dot{\\pi} = -\\frac{\\partial H_{\\mathrm{ext}}}{\\partial \\theta} $$\n\n我们使用给定的要求来确定 $H_{\\mathrm{ext}}$ 的函数形式。\n\n- **要求 1a**：$\\dot{q}_{i} = p_{i}/m_{i}(\\theta)$。\n与 Hamilton 方程 $\\dot{q}_{i} = \\partial H_{\\mathrm{ext}}/\\partial p_{i}$ 比较，我们有：\n$$ \\frac{\\partial H_{\\mathrm{ext}}}{\\partial p_{i}} = \\frac{p_{i}}{m_{i}(\\theta)} $$\n对每个 $i=1, \\dots, N$ 将此方程关于 $p_i$ 积分，得到：\n$$ H_{\\mathrm{ext}}(q,p,\\theta,\\pi) = \\sum_{i=1}^{N} \\frac{p_{i}^{2}}{2\\,m_{i}(\\theta)} + f(q,\\theta,\\pi) $$\n其中 $f$ 是一个不依赖于动量 $p$ 的任意函数。\n\n- **要求 1b**：$\\dot{p}_{i} = -\\partial V(q,\\theta)/\\partial q_{i}$。\n与 Hamilton 方程 $\\dot{p}_{i} = -\\partial H_{\\mathrm{ext}}/\\partial q_{i}$ 比较，我们得到：\n$$ -\\frac{\\partial H_{\\mathrm{ext}}}{\\partial q_{i}} = -\\frac{\\partial V(q,\\theta)}{\\partial q_{i}} $$\n代入我们得到的 $H_{\\mathrm{ext}}$ 表达式：\n$$ \\frac{\\partial}{\\partial q_{i}} \\left( \\sum_{j=1}^{N} \\frac{p_{j}^{2}}{2\\,m_{j}(\\theta)} + f(q,\\theta,\\pi) \\right) = \\frac{\\partial V(q,\\theta)}{\\partial q_{i}} $$\n由于第一项与 $q$ 无关，这简化为：\n$$ \\frac{\\partial f(q,\\theta,\\pi)}{\\partial q_{i}} = \\frac{\\partial V(q,\\theta)}{\\partial q_{i}} $$\n对坐标 $q$ 积分意味着 $f$ 必须具有以下形式：\n$$ f(q,\\theta,\\pi) = V(q,\\theta) + g(\\theta,\\pi) $$\n其中 $g$ 是一个与 $q$ 和 $p$ 无关的任意函数。结合这些结果，扩展哈密顿量为：\n$$ H_{\\mathrm{ext}}(q,p,\\theta,\\pi) = \\sum_{i=1}^{N} \\frac{p_{i}^{2}}{2\\,m_{i}(\\theta)} + V(q,\\theta) + g(\\theta,\\pi) = H(q,p,\\theta) + g(\\theta,\\pi) $$\n此处，$H(q,p,\\theta)$ 是原始哈密顿量，其中时间 $t$ 被形式上替换为坐标 $\\theta$。\n\n- **要求 2**：$\\dot{\\theta} = 1$。\n根据 Hamilton 方程 $\\dot{\\theta} = \\partial H_{\\mathrm{ext}}/\\partial \\pi$，我们必须有：\n$$ \\frac{\\partial H_{\\mathrm{ext}}}{\\partial \\pi} = \\frac{\\partial}{\\partial \\pi} \\left( H(q,p,\\theta) + g(\\theta,\\pi) \\right) = \\frac{\\partial g(\\theta,\\pi)}{\\partial \\pi} = 1 $$\n对 $\\pi$ 积分得到：\n$$ g(\\theta,\\pi) = \\pi + h(\\theta) $$\n其中 $h(\\theta)$ 是一个仅与 $\\theta$ 有关的任意函数。所以，扩展哈密顿量必须具有以下形式：\n$$ H_{\\mathrm{ext}}(q,p,\\theta,\\pi) = H(q,p,\\theta) + \\pi + h(\\theta) $$\n剩下的运动方程，即 $\\dot{\\pi}$ 的方程，不受问题陈述的约束。函数 $h(\\theta)$ 的任何选择都会产生一个有效的哈密顿系统，该系统满足 $q$, $p$ 和 $\\theta$ 的动力学。函数 $h(\\theta)$ 可以通过正则变换被吸收到动量 $\\pi$ 的定义中。具体来说，变换到一个新的动量 $\\Pi = \\pi + h(\\theta)$ 会保持 $(q,p)$ 和 $(\\theta, \\Pi)$ 的正则结构不变，并将哈密顿量变换为 $H(q,p,\\theta) + \\Pi$。因此，通过设置 $h(\\theta) = 0$（或任何常数，该常数可以被吸收到总能级中），可以获得最简单、最基本的形式。问题指定推导“可以相差一个无关的加性常数”，这也支持将 $h(\\theta)$ 设置为一个常数（例如零）。我们选择 $h(\\theta)=0$。\n\n因此，所要求的扩展哈密顿量是：\n$$ H_{\\mathrm{ext}}(q,p,\\theta,\\pi) = \\sum_{i=1}^{N} \\frac{p_{i}^{2}}{2\\,m_{i}(\\theta)} + V(q,\\theta) + \\pi $$\n\n**2. 扩展相空间可压缩性**\n\n相空间可压缩性 $\\kappa_{\\mathrm{ext}}$ 是扩展相空间中流的矢量场的散度。状态矢量为 $z = (q_1, \\dots, q_N, p_1, \\dots, p_N, \\theta, \\pi)$，矢量场为 $\\dot{z}$。\n$$ \\kappa_{\\mathrm{ext}} = \\nabla_{z} \\cdot \\dot{z} = \\sum_{i=1}^{N} \\left( \\frac{\\partial \\dot{q}_{i}}{\\partial q_{i}} + \\frac{\\partial \\dot{p}_{i}}{\\partial p_{i}} \\right) + \\frac{\\partial \\dot{\\theta}}{\\partial \\theta} + \\frac{\\partial \\dot{\\pi}}{\\partial \\pi} $$\n对于任何自治哈密顿系统，矢量场的分量由 Hamilton 方程给出。将这些代入散度的定义：\n$$ \\kappa_{\\mathrm{ext}} = \\sum_{i=1}^{N} \\left( \\frac{\\partial}{\\partial q_{i}}\\left(\\frac{\\partial H_{\\mathrm{ext}}}{\\partial p_{i}}\\right) + \\frac{\\partial}{\\partial p_{i}}\\left(-\\frac{\\partial H_{\\mathrm{ext}}}{\\partial q_{i}}\\right) \\right) + \\frac{\\partial}{\\partial \\theta}\\left(\\frac{\\partial H_{\\mathrm{ext}}}{\\partial \\pi}\\right) + \\frac{\\partial}{\\partial \\pi}\\left(-\\frac{\\partial H_{\\mathrm{ext}}}{\\partial \\theta}\\right) $$\n使用混合偏导数可以将其改写为：\n$$ \\kappa_{\\mathrm{ext}} = \\sum_{i=1}^{N} \\left( \\frac{\\partial^2 H_{\\mathrm{ext}}}{\\partial q_{i} \\partial p_{i}} - \\frac{\\partial^2 H_{\\mathrm{ext}}}{\\partial p_{i} \\partial q_{i}} \\right) + \\left( \\frac{\\partial^2 H_{\\mathrm{ext}}}{\\partial \\theta \\partial \\pi} - \\frac{\\partial^2 H_{\\mathrm{ext}}}{\\partial \\pi \\partial \\theta} \\right) $$\n假设扩展哈密顿量 $H_{\\mathrm{ext}}$ 是二阶连续可微的（$C^2$），这是对物理哈密顿量的一个标准假设（要求 $m_i$ 和 $V$ 足够光滑），那么关于混合偏导数相等的 Clairaut 定理适用。这意味着：\n$$ \\frac{\\partial^2 H_{\\mathrm{ext}}}{\\partial q_{i} \\partial p_{i}} = \\frac{\\partial^2 H_{\\mathrm{ext}}}{\\partial p_{i} \\partial q_{i}} \\quad \\text{and} \\quad \\frac{\\partial^2 H_{\\mathrm{ext}}}{\\partial \\theta \\partial \\pi} = \\frac{\\partial^2 H_{\\mathrm{ext}}}{\\partial \\pi \\partial \\theta} $$\n因此，$\\kappa_{\\mathrm{ext}}$ 的求和中的每一项都恒等于零。\n$$ \\kappa_{\\mathrm{ext}} = \\sum_{i=1}^{N} (0) + 0 = 0 $$\n这个结果被称为哈密顿系统的 Liouville 定理，它证实了我们推导的自治哈密顿量 $H_{\\mathrm{ext}}$ 所生成的流在扩展相空间中确实是不可压缩的（保体积的），这是所有哈密顿流的一个普遍性质。\n\n**3. Trotter-Strang 分裂的构造**\n\n通过对扩展哈密顿量 $H_{\\mathrm{ext}}$ 应用一个对称分裂格式，例如 Trotter-Strang 分裂，可以构造一个时间可逆、保体积（即辛）的积分器。其步骤如下：\n1.  **分裂哈密顿量**：将 $H_{\\mathrm{ext}}$ 分解为几部分之和， $H_{\\mathrm{ext}} = H_{A} + H_{B} + H_{C} + \\dots$，使得由每个部分单独生成的动力学都是可解析求解的。对于我们的 $H_{\\mathrm{ext}}$，一个自然的分裂是：\n    $$ H_{\\mathrm{ext}} = \\underbrace{V(q,\\theta)}_{H_{A}} + \\underbrace{\\sum_{i=1}^{N} \\frac{p_{i}^{2}}{2\\,m_{i}(\\theta)}}_{H_{B}} + \\underbrace{\\pi}_{H_{C}} $$\n2.  **求解子问题**：对于每个部分，相应的 Hamilton 方程都很简单，并且可以在一个小的时间步长 $\\Delta s$ 上精确积分。\n    - 在 $H_A$ 下的流：$q$ 和 $\\theta$ 是常数。$p$ 和 $\\pi$ 通过与 $V$ 的梯度成正比的步长进行更新。\n    - 在 $H_B$ 下的流：$p$ 和 $\\theta$ 是常数。$q$ 通过与 $p/m(\\theta)$ 成正比的步长进行更新，而 $\\pi$ 通过来自 $H_B$ 对 $\\theta$ 的导数的步长进行更新。\n    - 在 $H_C$ 下的流：$q$、$p$ 和 $\\pi$ 是常数。$\\theta$ 更新为 $\\theta \\rightarrow \\theta + \\Delta s$。\n3.  **对称组合**：通过组合子问题的精确流，可以为完整动力学构造一个在步长 $\\Delta s$ 上的二阶对称积分器。对于三部分分裂 $A+B+C$，一个常见的 Strang 分裂是：\n    $$ \\Phi_{\\Delta s} = \\exp\\left(\\frac{\\Delta s}{2}\\mathcal{L}_{A}\\right) \\exp\\left(\\frac{\\Delta s}{2}\\mathcal{L}_{B}\\right) \\exp(\\Delta s\\,\\mathcal{L}_{C}) \\exp\\left(\\frac{\\Delta s}{2}\\mathcal{L}_{B}\\right) \\exp\\left(\\frac{\\Delta s}{2}\\mathcal{L}_{A}\\right) $$\n    其中 $\\exp(\\tau \\mathcal{L}_X)$ 表示在哈密頓量 $X$ 下演化时间 $\\tau$ 的精确流。因为这个数值映射是精确哈密顿流（它们是保体积的）的组合，并且该组合是对稱的，所以得到的积分器 $\\Phi_{\\Delta s}$ 既是保体积的（辛的）又是时间可逆的。这就为原始的非自治系统提供了所需的积分器。\n\n最终需要的答案是扩展哈密顿量的显式表达式。", "answer": "$$\n\\boxed{H_{\\mathrm{ext}}(q,p,\\theta,\\pi) = \\sum_{i=1}^{N} \\frac{p_{i}^{2}}{2\\,m_{i}(\\theta)} + V(q,\\theta) + \\pi}\n$$", "id": "3421893"}]}