{"hands_on_practices": [{"introduction": "我们理论探讨的第一步是建立一个坚实的基础。在处于热平衡状态的系统中，能量是如何在不同类型的粒子间分配的？这个练习将引导我们从正则系综的第一性原理出发，推导出一个混合物体系中单个粒子动能的概率分布。通过这个推导，我们将揭示能量均分原理的一个关键推论：在热平衡下，不同质量的粒子拥有相同的平均平动动能，这是统计力学中一个深刻且具有普适性的结论[@problem_id:3398807]。", "problem": "考虑一个经典的、稀疏的、由不相互作用的点状粒子组成的二元混合物，组分分别为 $A$ 和 $B$，该混合物被限制在体积为 $V$ 的三维空间中，并在正则系综下处于温度 $T$ 的热平衡状态。组分 $A$ 的质量为 $m_A$，组分 $B$ 的质量为 $m_B$。对于一个种类为 $\\alpha \\in \\{A,B\\}$ 的单个粒子，其平动动能定义为 $E_{\\alpha} = \\frac{1}{2} m_{\\alpha} v^2$，其中 $v = |\\mathbf{v}|$ 是速率。\n\n仅从正则系综的定义出发，即相空间微观状态的概率密度与 $\\exp(-\\beta H)$ 成正比（其中逆温度 $\\beta = 1/(k_B T)$，$k_B$ 是 Boltzmann 常数），并结合动量或速度空间中的标准 Liouville 测度以及三个平动自由度，推导每个组分的单个粒子平动动能的概率密度函数 $p_{E,\\alpha}(E)$。然后，根据你推导出的分布，计算平均单粒子动能 $\\langle E_A \\rangle$ 和 $\\langle E_B \\rangle$，并构建能量均分比率 $R \\equiv \\langle E_A \\rangle / \\langle E_B \\rangle$。讨论该分布和 $R$ 是否依赖于 $m_A$ 和 $m_B$。\n\n作为最终报告的量，请提供对于任一组分均成立的、普适的单粒子平动动能概率密度 $p(E)$ 的精确解析表达式，用 $E$、$k_B$ 和 $T$ 表示。不需要数值取整，最终表达式中也不要包含物理单位。", "solution": "该问题是有效的。这是经典统计力学中的一个标准推导，具有科学依据，问题提法恰当且客观。所有必要信息均已提供。\n\n我们从经典系统的正则系综开始。对于一个种类为 $\\alpha \\in \\{A, B\\}$ 的单个粒子，在粒子不相互作用且不受外部势场影响的情况下，其哈密顿量 $H_{\\alpha}$ 仅包含平动动能。用动量 $\\mathbf{p} = (p_x, p_y, p_z)$ 表示，哈密顿量为：\n$$H_{\\alpha}(\\mathbf{p}) = \\frac{|\\mathbf{p}|^2}{2m_{\\alpha}} = \\frac{p_x^2 + p_y^2 + p_z^2}{2m_{\\alpha}}$$\n其中 $m_{\\alpha}$ 是粒子的质量。\n\n根据正则系综，一个粒子具有动量 $\\mathbf{p}$ 的概率密度函数与 Boltzmann 因子 $\\exp(-\\beta H_{\\alpha})$ 成正比，其中 $\\beta = 1/(k_B T)$。\n$$f_{\\alpha}(\\mathbf{p}) = C_{\\alpha} \\exp\\left(-\\beta \\frac{|\\mathbf{p}|^2}{2m_{\\alpha}}\\right)$$\n$C_{\\alpha}$ 是一个归一化常数，由概率密度在所有可能动量上的积分为1的条件确定：\n$$\\int_{-\\infty}^{\\infty} \\int_{-\\infty}^{\\infty} \\int_{-\\infty}^{\\infty} f_{\\alpha}(\\mathbf{p}) dp_x dp_y dp_z = 1$$\n这个积分可以分离成三个相同的高斯积分：\n$$1 = C_{\\alpha} \\left( \\int_{-\\infty}^{\\infty} \\exp\\left(-\\frac{\\beta p_x^2}{2m_{\\alpha}}\\right) dp_x \\right)^3$$\n使用标准高斯积分结果 $\\int_{-\\infty}^{\\infty} \\exp(-ax^2)dx = \\sqrt{\\pi/a}$，其中 $a = \\beta/(2m_{\\alpha})$，我们得到：\n$$1 = C_{\\alpha} \\left( \\sqrt{\\frac{2\\pi m_{\\alpha}}{\\beta}} \\right)^3 = C_{\\alpha} \\left(\\frac{2\\pi m_{\\alpha}}{\\beta}\\right)^{3/2}$$\n解出归一化常数得到：\n$$C_{\\alpha} = \\left(\\frac{\\beta}{2\\pi m_{\\alpha}}\\right)^{3/2}$$\n因此，种类为 $\\alpha$ 的粒子的归一化动量分布为：\n$$f_{\\alpha}(\\mathbf{p}) = \\left(\\frac{\\beta}{2\\pi m_{\\alpha}}\\right)^{3/2} \\exp\\left(-\\beta \\frac{|\\mathbf{p}|^2}{2m_{\\alpha}}\\right)$$\n为了找到动能 $E$ 的概率密度函数，我们进行变量替换，从动量 $\\mathbf{p}$ 转换到动能 $E$。首先切换到动量空间中的球坐标 $(p, \\theta, \\phi)$ 会很方便，其中 $p = |\\mathbf{p}|$ 是动量的大小。体积元为 $d^3p = p^2 \\sin\\theta dp d\\theta d\\phi$。对角度变量积分（$\\int_0^{2\\pi}d\\phi \\int_0^{\\pi}\\sin\\theta d\\theta = 4\\pi$）后，得到动量大小 $p$ 的概率密度：\n$$g_{\\alpha}(p) dp = 4\\pi p^2 f_{\\alpha}(\\mathbf{p}) dp = 4\\pi p^2 \\left(\\frac{\\beta}{2\\pi m_{\\alpha}}\\right)^{3/2} \\exp\\left(-\\beta \\frac{p^2}{2m_{\\alpha}}\\right) dp$$\n动能为 $E = p^2/(2m_{\\alpha})$。这意味着 $p = \\sqrt{2m_{\\alpha}E}$。微分关系为 $dp = \\sqrt{m_{\\alpha}/(2E)} dE$。概率必须守恒，因此 $p_{E,\\alpha}(E) dE = g_{\\alpha}(p) dp$。我们通过代入法求能量的概率密度 $p_{E,\\alpha}(E)$：\n$$p_{E,\\alpha}(E) = g_{\\alpha}(p(E)) \\left|\\frac{dp}{dE}\\right|$$\n$$p_{E,\\alpha}(E) = 4\\pi \\left(\\sqrt{2m_{\\alpha}E}\\right)^2 \\left(\\frac{\\beta}{2\\pi m_{\\alpha}}\\right)^{3/2} \\exp(-\\beta E) \\left(\\sqrt{\\frac{m_{\\alpha}}{2E}}\\right)$$\n$$p_{E,\\alpha}(E) = 4\\pi (2m_{\\alpha}E) \\frac{\\beta^{3/2}}{(2\\pi m_{\\alpha})^{3/2}} \\exp(-\\beta E) \\frac{\\sqrt{m_{\\alpha}}}{\\sqrt{2E}}$$\n现在我们合并并化简各项：\n$$p_{E,\\alpha}(E) = \\frac{4\\pi \\cdot 2 \\cdot \\beta^{3/2}}{ (2\\pi)^{3/2} \\sqrt{2} } \\cdot \\frac{m_{\\alpha} \\sqrt{m_{\\alpha}}}{m_{\\alpha}^{3/2}} \\cdot \\frac{E}{\\sqrt{E}} \\cdot \\exp(-\\beta E)$$\n$$p_{E,\\alpha}(E) = \\frac{8\\pi \\beta^{3/2}}{ 2\\sqrt{2}\\pi\\sqrt{\\pi} \\sqrt{2} } \\cdot 1 \\cdot \\sqrt{E} \\cdot \\exp(-\\beta E)$$\n$$p_{E,\\alpha}(E) = \\frac{8\\pi \\beta^{3/2}}{4\\pi \\sqrt{\\pi}} \\sqrt{E} \\exp(-\\beta E) = \\frac{2}{\\sqrt{\\pi}} \\beta^{3/2} \\sqrt{E} \\exp(-\\beta E)$$\n代入 $\\beta = 1/(k_B T)$：\n$$p_{E,\\alpha}(E) = \\frac{2 \\sqrt{E}}{\\sqrt{\\pi} (k_B T)^{3/2}} \\exp\\left(-\\frac{E}{k_B T}\\right)$$\n关键在于，这个动能分布的表达式与粒子质量 $m_{\\alpha}$ 无关。因此，组分 $A$ 和 $B$ 共享相同的动能分布，我们可以将其记为 $p(E)$。\n\n接下来，我们计算平均单粒子动能 $\\langle E_{\\alpha} \\rangle$。由于两种组分的分布相同，它们的平均能量也将相同。\n$$\\langle E \\rangle = \\int_0^{\\infty} E \\cdot p(E) dE = \\int_0^{\\infty} E \\left(\\frac{2}{\\sqrt{\\pi}} \\beta^{3/2} \\sqrt{E} \\exp(-\\beta E)\\right) dE$$\n$$\\langle E \\rangle = \\frac{2 \\beta^{3/2}}{\\sqrt{\\pi}} \\int_0^{\\infty} E^{3/2} \\exp(-\\beta E) dE$$\n为了求解这个积分，我们使用换元法，令 $x = \\beta E$，因此 $E = x/\\beta$ 且 $dE = dx/\\beta$。\n$$\\langle E \\rangle = \\frac{2 \\beta^{3/2}}{\\sqrt{\\pi}} \\int_0^{\\infty} \\left(\\frac{x}{\\beta}\\right)^{3/2} e^{-x} \\frac{dx}{\\beta} = \\frac{2 \\beta^{3/2}}{\\sqrt{\\pi}} \\frac{1}{\\beta^{5/2}} \\int_0^{\\infty} x^{3/2} e^{-x} dx$$\n$$\\langle E \\rangle = \\frac{2}{\\beta\\sqrt{\\pi}} \\int_0^{\\infty} x^{5/2 - 1} e^{-x} dx$$\n该积分是 Gamma 函数 $\\Gamma(z) = \\int_0^{\\infty} t^{z-1} e^{-t} dt$，其中 $z = 5/2$。\n$\\Gamma(5/2) = \\frac{3}{2}\\Gamma(3/2) = \\frac{3}{2} \\cdot \\frac{1}{2}\\Gamma(1/2) = \\frac{3}{4}\\sqrt{\\pi}$。\n将其代回，我们得到：\n$$\\langle E \\rangle = \\frac{2}{\\beta\\sqrt{\\pi}} \\left(\\frac{3}{4}\\sqrt{\\pi}\\right) = \\frac{3}{2\\beta} = \\frac{3}{2} k_B T$$\n这个结果证实了对于 $3$ 个平动自由度的能量均分定理。平均动能仅依赖于温度，而不依赖于粒子质量。因此，$\\langle E_A \\rangle = \\langle E_B \\rangle = \\frac{3}{2} k_B T$。\n\n能量均分比率 $R$ 为：\n$$R \\equiv \\frac{\\langle E_A \\rangle}{\\langle E_B \\rangle} = \\frac{\\frac{3}{2} k_B T}{\\frac{3}{2} k_B T} = 1$$\n只要系统处于热平衡状态，对于任意质量 $m_A$ 和 $m_B$ 的选择，比率 $R$ 始终等于 $1$。\n\n总而言之，单粒子平动动能分布 $p(E)$ 与粒子质量无关。这是因为动量分布归一化过程中的质量依赖性，恰好被从动量到能量的变量替换过程中引入的质量依赖性所抵消。因此，混合物中任何粒子组分的平均动能 $\\langle E \\rangle$ 也与质量无关，从而导致能量均分比率 $R$ 精确地为 $1$。\n\n最终报告的量是普适的概率密度函数 $p(E)$。", "answer": "$$\\boxed{\\frac{2 \\sqrt{E}}{\\sqrt{\\pi} (k_B T)^{3/2}} \\exp\\left(-\\frac{E}{k_B T}\\right)}$$", "id": "3398807"}, {"introduction": "理论模型是理想化的，而真实的分子动力学模拟则充满了实际的复杂性。例如，为了提高计算效率或模拟特定分子结构，我们常常引入刚性键等约束，或者为了消除系统漂移而固定系统的总质心动量。这个实践练习将理论与模拟实践直接联系起来，要求我们精确计算在一个包含约束的复杂系统中，真正独立的二次能量自由度的数量。准确地“清点”自由度对于验证模拟的正确性以及从模拟数据中计算温度等热力学量至关重要[@problem_id:3398868]。", "problem": "考虑一个在三维空间中对混合物进行的正则系综（粒子数、体积和温度恒定）下的分子动力学模拟。该系统包含 $n_A = 200$ 个单原子粒子和 $n_{B_2} = 50$ 个双原子分子，因此总原子数为 $N = n_A + 2 n_{B_2}$。双原子分子通过完整约束算法以完全刚性的键长进行建模，并且模拟通过始终将总质心线动量固定为零来移除整体漂移。假设所有约束都是独立的，并且恒温器产生限制在约束流形上的 Maxwell–Boltzmann 分布。\n\n从动量的正则 Boltzmann 分布出发，推导速度上的线性约束如何减少进入动能 $K$ 的有效独立二次自由度数 $f$。然后，对于这个特定系统，计算与标量变量 $X = 2K/(k_B T)$ 相关联的卡方分布的参数，其中 $k_B$ 是 Boltzmann 常数，$T$ 是绝对温度。将最终结果表示为一个不进行四舍五入且不带单位的精确整数。清楚地说明由于质心动量固定和刚性键长约束导致的 $f$ 的每一次减少。", "solution": "该问题要求我们确定与一个受约束的分子系统的归一化总动能相关联的卡方分布的参数。该参数等价于有效独立二次自由度数，记为 $f$。\n\n一个包含 $N$ 个粒子的三维系统的总动能 $K$ 由所有笛卡尔动量分量的总和给出：\n$$\nK = \\sum_{i=1}^{N} \\frac{1}{2m_i} (p_{ix}^2 + p_{iy}^2 + p_{iz}^2)\n$$\n在温度为 $T$ 的正则系综中，每个动量分量 $p_{j}$ 是一个随机变量，从均值为零、方差为 $m k_B T$ 的高斯分布中抽取，其中 $m$ 是与该分量相关联的质量。因此，变量 $\\frac{p_j}{\\sqrt{m k_B T}}$ 服从标准正态分布。量 $X = \\frac{2K}{k_B T}$ 可以表示为：\n$$\nX = \\frac{2}{k_B T} \\sum_{i=1}^{N} \\frac{1}{2m_i} (p_{ix}^2 + p_{iy}^2 + p_{iz}^2) = \\sum_{i=1}^{N} \\left[ \\left(\\frac{p_{ix}}{\\sqrt{m_i k_B T}}\\right)^2 + \\left(\\frac{p_{iy}}{\\sqrt{m_i k_B T}}\\right)^2 + \\left(\\frac{p_{iz}}{\\sqrt{m_i k_B T}}\\right)^2 \\right]\n$$\n如果所有 $3N$ 个动量分量都是独立的，那么 $X$ 将是 $3N$ 个标准正态变量平方的总和，因此服从自由度为 $3N$ 的卡方分布，即 $\\chi^2(3N)$。\n\n然而，该系统受到速度（并因此是动量）的约束，这减少了独立动量分量的数量。速度上的每个独立线性约束都会从系统中移除一个自由度。有效自由度数 $f$ 是初始总自由度数减去独立约束的总数。\n\n首先，我们确定系统中的总原子数 $N$。该系统包含 $n_A = 200$ 个单原子粒子和 $n_{B_2} = 50$ 个双原子分子。\n$$\nN = n_A + 2 n_{B_2} = 200 + 2(50) = 200 + 100 = 300 \\text{ 个原子}\n$$\n该系统处于三维空间中（$d=3$）。初始平移自由度的总数为：\n$$\nf_{\\text{initial}} = d \\times N = 3 \\times 300 = 900\n$$\n\n接下来，我们列举施加在系统上的约束。\n\n1.  **刚性键长约束**：该系统包含 $n_{B_2} = 50$ 个双原子分子，每个分子都有一个完全刚性的键。两个原子（例如原子 $i$ 和原子 $j$）之间的刚性键是对它们位置的一个完整约束：\n    $$\n    (\\mathbf{r}_i - \\mathbf{r}_j) \\cdot (\\mathbf{r}_i - \\mathbf{r}_j) - d_{ij}^2 = 0\n    $$\n    对其关于时间求导，得到一个关于速度的约束：\n    $$\n    2(\\mathbf{r}_i - \\mathbf{r}_j) \\cdot (\\mathbf{v}_i - \\mathbf{v}_j) = 0\n    $$\n    对于每个刚性键，这是一个关于速度分量的单个线性方程。由于有 $n_{B_2} = 50$ 个这样的分子，因此存在 50 个此类独立约束。来自刚性键的约束数量为 $c_{\\text{bonds}} = 50$。\n\n2.  **质心动量约束**：系统的总线动量 $\\mathbf{P}$ 被固定为零。总动量是单个粒子动量的总和：\n    $$\n    \\mathbf{P} = \\sum_{i=1}^{N} m_i \\mathbf{v}_i = \\mathbf{0}\n    $$\n    这是一个三维空间中的矢量方程，等价于关于总动量笛卡尔分量的三个独立标量方程：\n    \\begin{align*}\n    P_x = \\sum_{i=1}^{N} m_i v_{ix} = 0 \\\\\n    P_y = \\sum_{i=1}^{N} m_i v_{iy} = 0 \\\\\n    P_z = \\sum_{i=1}^{N} m_i v_{iz} = 0\n    \\end{align*}\n    这三个方程代表了对粒子速度的三个线性约束。由固定质心动量产生的约束数量为 $c_{\\text{COM}} = 3$。\n\n问题陈述所有约束都是独立的。因此，约束总数 $c_{\\text{total}}$ 是来自键和质心动量的约束之和。\n$$\nc_{\\text{total}} = c_{\\text{bonds}} + c_{\\text{COM}} = 50 + 3 = 53\n$$\n\n有效独立二次自由度数 $f$ 是初始自由度数减去约束总数：\n$$\nf = f_{\\text{initial}} - c_{\\text{total}} = 900 - 53 = 847\n$$\n\n这个值 $f=847$ 是相加形成量 $X = 2K/(k_B T)$ 的独立标准正态变量平方的个数。根据定义，$X$ 服从自由度为 $f$ 的卡方分布，记作 $\\chi^2(f)$。此分布的参数是其自由度数。\n\n因此，$X$ 的卡方分布的参数是 $847$。", "answer": "$$\\boxed{847}$$", "id": "3398868"}, {"introduction": "最后的练习将理论、统计学和计算实践融为一体。我们已经知道理想系统的动能遵循特定的伽马分布，也理解了模拟中的约束会改变其参数。现在，我们将亲手编写一个程序，利用最大似然估计从（模拟的）实验数据中反推出系统的有效自由度。这项实践不仅能让你掌握一种强大的数据分析方法，更能让你学会如何通过分析能量涨落来验证模拟是否符合理论预期，甚至诊断出恒温器或约束算法中可能存在的问题[@problem_id:3398873]。", "problem": "您的任务是开发一个完整的程序，用于在高级研究生水平上，使用玻尔兹曼统计分析分子动力学 (MD) 模拟的动能分布。此分析必须以一种能够通过估计有效二次自由度数，来揭示由于约束、刚体和恒温器伪影而导致的与正则系综的偏差的方式来构建和执行。\n\n此任务的基本基础是正则系综和麦克斯韦-玻尔兹曼速度分布。从具有二次型动能的系统的正则系综开始，其中在温度 $T$ 的平衡状态下，每个二次自由度对总动能的贡献是可加的。使用经过充分检验的事实：相空间中的正则概率密度与 $\\exp(-\\beta H)$ 成正比，其中 $\\beta = 1/(k_\\mathrm{B} T)$，动能是速度的二次函数，且哈密顿量中的独立二次模产生独立的高斯速度分量。从这些基础出发，推导总动能的分布，并设计一个用于有效二次自由度数（记为 $f_{\\text{eff}}$）的估计量。\n\n然后，实现一个程序，对于一组给定的合成 MD 场景，执行以下步骤：\n- 使用物理上一致的参数模拟总动能 $E_{\\text{kin}}$ 的独立样本，能量单位为 $\\mathrm{J}$ (焦耳)，温度单位为 $\\mathrm{K}$ (开尔文)。\n- 将模拟的 $E_{\\text{kin}}$ 分布拟合到一个由正则系综和二次型动能结构所蕴含的参数族，以估计形状参数 $k$，同时将绝对热能标度固定在 $k_\\mathrm{B} T$，然后计算 $f_{\\text{eff}} = 2 k$。\n- 汇总并以确切要求的输出格式报告每个测试用例的估计 $f_{\\text{eff}}$。\n\n您的程序必须从第一性原理实现以下估计原则：\n- 设 $E_{\\text{kin}}$ 是在温度 $T$ 的正则系综中，$f$ 个二次自由度的总动能，玻尔兹曼常数为 $k_\\mathrm{B}$。对于一个从正则系综推导出的参数模型，在温度标度由恒温器固定在 $\\theta = k_\\mathrm{B} T$ 的假设下，对数似然导致一个关于形状参数 $k$ 的单一非线性方程，形式如下\n$$ \\psi(k) = \\frac{1}{N} \\sum_{i=1}^{N} \\ln E_i - \\ln \\theta, $$\n其中 $\\psi(\\cdot)$ 是双伽玛函数，$\\{E_i\\}_{i=1}^{N}$ 是观测到的动能样本，$\\theta = k_\\mathrm{B} T$，$N$ 是样本数。数值求解此方程并报告 $f_{\\text{eff}} = 2k$。\n\n估计必须对实际的样本量和参数范围具有鲁棒性，并且必须使用一种基于原理的数值方法可靠地收敛。您可以使用双伽玛函数和三伽玛函数。\n\n物理和数值单位：\n- 所有能量 $E_{\\text{kin}}$ 必须以 $\\mathrm{J}$ (焦耳) 构建和处理。\n- 所有温度 $T$ 必须以 $\\mathrm{K}$ (开尔文) 指定。\n- 玻尔兹曼常数必须是 $k_\\mathrm{B} = 1.380649 \\times 10^{-23}\\,\\mathrm{J}\\,\\mathrm{K}^{-1}$。\n- 最终报告的 $f_{\\text{eff}}$ 是无量纲实数，必须以浮点值输出。\n\n此问题不适用角度单位。\n\n测试套件和参数规范：\n使用以下五个场景生成合成的 MD 动能数据集并估计 $f_{\\text{eff}}$。为了可复现性，对所有随机数生成使用一个固定的伪随机种子，其值为 $123456$。\n\n- 情况 1 (正则，理想情况):\n  - 真实二次自由度: $f_{\\text{true}} = 300$。\n  - 温度: $T = 300\\,\\mathrm{K}$。\n  - 模拟器使用的热能标度: $\\theta_{\\text{eff}} = k_\\mathrm{B} T$。\n  - 独立样本数: $N = 50000$。\n  - 预期行为: 估计量应返回接近 $f_{\\text{true}}$ 的 $f_{\\text{eff}}$。\n\n- 情况 2 (质心线动量受约束):\n  - 真实二次自由度: $f_{\\text{true}} = 297$ (从名义上的 300 中减去 3)。\n  - 温度: $T = 300\\,\\mathrm{K}$。\n  - 模拟器使用的热能标度: $\\theta_{\\text{eff}} = k_\\mathrm{B} T$。\n  - 独立样本数: $N = 50000$。\n  - 预期行为: 估计量应检测到减少量并返回接近 297 的 $f_{\\text{eff}}$。\n\n- 情况 3 (刚体: 10 个自由刚体):\n  - 真实二次自由度: $f_{\\text{true}} = 60$ (每个刚体贡献 6)。\n  - 温度: $T = 300\\,\\mathrm{K}$。\n  - 模拟器使用的热能标度: $\\theta_{\\text{eff}} = k_\\mathrm{B} T$。\n  - 独立样本数: $N = 50000$。\n  - 预期行为: 估计量应返回接近 60 的 $f_{\\text{eff}}$。\n\n- 情况 4 (非正则恒温器，能量涨落更窄):\n  - 真实二次自由度: $f_{\\text{true}} = 300$。\n  - 用于在估计量中设置固定热能标度的温度: $T = 300\\,\\mathrm{K}$，因此在估计量中 $\\theta = k_\\mathrm{B} T$。\n  - 模拟器使用的热能标度: $\\theta_{\\text{eff}} = 0.85\\,k_\\mathrm{B} T$。\n  - 独立样本数: $N = 50000$。\n  - 预期行为: 将 $\\theta$ 固定在 $k_\\mathrm{B} T$ 的估计量应返回低于 300 的 $f_{\\text{eff}}$，以适应减小的涨落。\n\n- 情况 5 (小样本量，边缘情况):\n  - 真实二次自由度: $f_{\\text{true}} = 6$。\n  - 温度: $T = 300\\,\\mathrm{K}$。\n  - 模拟器使用的热能标度: $\\theta_{\\text{eff}} = k_\\mathrm{B} T$。\n  - 独立样本数: $N = 50$。\n  - 预期行为: 估计量应保持一致，但会表现出更大的抽样误差。\n\n数据生成协议：\n- 对于每种情况，使用与正则二次自由度假设一致的参数模型生成总动能的独立样本：\n  - 令 $k_{\\text{true}} = f_{\\text{true}}/2$ 和模拟器标度 $\\theta_{\\text{eff}}$ 如规范所示。抽取 $N$ 个独立样本 $E_i \\sim \\text{Gamma}(k_{\\text{true}}, \\theta_{\\text{eff}})$，这对于正则系综中二次模之和是物理上一致的。\n\n估计量实现协议：\n- 对于每种情况，使用观测到的能量 $\\{E_i\\}$ 和估计量中使用的固定标度 $\\theta = k_\\mathrm{B} T$（注意，在情况 4 中，模拟器使用 $\\theta_{\\text{eff}} \\neq \\theta$），求解\n$$ \\psi(k) = \\frac{1}{N}\\sum_{i=1}^{N} \\ln E_i - \\ln \\theta $$\n中的 $k$。使用鲁棒的数值方法（例如，使用三伽玛函数 $\\psi^{(1)}(k)$ 的牛顿法），并进行正值初始化（例如，矩估计法 $k_0 = \\bar{E}/\\theta$）和采取保障措施以保持 $k > 0$。\n\n要求的最终输出格式：\n- 您的程序应生成单行输出，其中包含从情况 1 到情况 5 的五个估计的 $f_{\\text{eff}}$ 值，形式为用方括号括起来的逗号分隔列表。例如，输出必须是以下形式\n$[f_1,f_2,f_3,f_4,f_5]$\n其中每个 $f_j$ 是一个浮点数。\n\n不允许用户输入、外部文件或网络访问；所有参数都在程序内部。最终程序必须是完整且可运行的。", "solution": "该问题要求开发一个程序，从合成的分子动力学 (MD) 动能数据中估计有效二次自由度数 $f_{\\text{eff}}$。该估计基于统计力学中的正则系综原理。\n\n### 理论基础和动能分布的推导\n\n在正则系综中，一个与恒定绝对温度 $T$ 的热浴处于热平衡的系统，其处于能量为 $H$ 的微观态的概率由玻尔兹曼分布给出，$P \\propto e^{-H/(k_\\mathrm{B} T)}$，其中 $k_\\mathrm{B}$ 是玻尔兹曼常数。\n\n经典粒子系统的总动能 $E_{\\text{kin}}$ 是速度（或动量）分量的二次项之和。对于一个有 $f$ 个独立二次自由度的系统，总动能可以表示为 $f$ 个独立项的和：\n$$\nE_{\\text{kin}} = \\sum_{i=1}^{f} \\epsilon_i\n$$\n根据能量均分定理，每个这样的自由度的平均能量是 $\\langle \\epsilon_i \\rangle = \\frac{1}{2} k_\\mathrm{B} T$。更基本地，每个动量分量服从高斯分布。相应的动能项（例如，$\\frac{1}{2} m v_x^2$）因此服从自由度为 1 的卡方分布，这是伽玛分布的一个特例。具体来说，每个能量项 $\\epsilon_i$ 是一个独立同分布的随机变量，服从形状参数为 $k=1/2$、尺度参数为 $\\theta = k_\\mathrm{B} T$ 的伽玛分布。\n$$\n\\epsilon_i \\sim \\text{Gamma}\\left(k = \\frac{1}{2}, \\theta = k_\\mathrm{B} T\\right)\n$$\n伽玛分布的一个关键性质是其可加性：具有相同尺度参数的独立伽玛分布变量之和也服从伽玛分布。所得分布的形状参数是各个形状参数之和。因此，对于一个具有 $f$ 个独立二次自由度的系统，总动能 $E_{\\text{kin}}$ 服从一个伽玛分布：\n$$\nE_{\\text{kin}} \\sim \\text{Gamma}\\left(k = \\sum_{i=1}^{f} \\frac{1}{2}, \\theta = k_\\mathrm{B} T\\right) = \\text{Gamma}\\left(k = \\frac{f}{2}, \\theta = k_\\mathrm{B} T\\right)\n$$\n这个关系，$f = 2k$，构成了我们分析的基础。通过估计动能分布的形状参数 $k$，我们可以确定有效自由度数，$f_{\\text{eff}} = 2k$。由于模拟中的伪影，如约束或非正则恒温器，这个 $f_{\\text{eff}}$ 可能会偏离名义上的自由度数。\n\n### 形状参数的最大似然估计\n\n问题指定了一个基于固定温度 $T$ 的估计过程，这意味着一个固定的尺度参数 $\\theta = k_\\mathrm{B} T$。给定一组 $N$ 个独立的动能样本 $\\{E_i\\}_{i=1}^{N}$，我们必须估计形状参数 $k$。我们使用最大似然估计 (MLE) 方法。\n\n一个形状为 $k$、尺度为 $\\theta$ 的伽玛分布变量 $E$ 的概率密度函数 (PDF) 是：\n$$\np(E; k, \\theta) = \\frac{E^{k-1} e^{-E/\\theta}}{\\Gamma(k) \\theta^k}\n$$\n其中 $\\Gamma(k)$ 是伽玛函数。对于这组 $N$ 个观测能量，将 $\\theta$ 视为已知常数，其对数似然 $\\mathcal{L}(k)$ 为：\n$$\n\\mathcal{L}(k) = \\ln \\left( \\prod_{i=1}^{N} p(E_i; k, \\theta) \\right) = \\sum_{i=1}^{N} \\ln p(E_i; k, \\theta)\n$$\n$$\n\\mathcal{L}(k) = \\sum_{i=1}^{N} \\left[ (k-1)\\ln E_i - \\frac{E_i}{\\theta} - k\\ln\\theta - \\ln\\Gamma(k) \\right]\n$$\n为了找到使该对数似然最大化的 $k$ 值，我们对其关于 $k$ 求导并令其为零：\n$$\n\\frac{\\partial\\mathcal{L}}{\\partial k} = \\sum_{i=1}^{N} \\left[ \\ln E_i - \\ln\\theta - \\frac{d}{dk}\\ln\\Gamma(k) \\right] = 0\n$$\n引入双伽玛函数 $\\psi(k) = \\frac{d}{dk}\\ln\\Gamma(k)$，我们得到：\n$$\n\\sum_{i=1}^{N} (\\ln E_i - \\ln\\theta) - N\\psi(k) = 0\n$$\n整理此方程得到问题陈述中给出的表达式，必须求解它以得到 $k$：\n$$\n\\psi(k) = \\frac{1}{N} \\sum_{i=1}^{N} \\ln E_i - \\ln\\theta\n$$\n\n### 通过牛顿法进行数值求解\n\n这是一个关于 $k$ 的非线性方程，我们用数值方法求解。牛顿法是一种强大而高效的选择。为了找到函数 $g(k)=0$ 的根，该方法根据以下更新规则进行迭代：\n$$\nk_{n+1} = k_n - \\frac{g(k_n)}{g'(k_n)}\n$$\n我们将要求解的函数定义为 $g(k) = \\psi(k) - C$，其中常数 $C$ 是由经验确定的估计方程的右侧：\n$$\nC = \\frac{1}{N} \\sum_{i=1}^{N} \\ln E_i - \\ln(k_\\mathrm{B} T)\n$$\n$g(k)$ 对 $k$ 的导数是 $g'(k) = \\frac{d}{dk}\\psi(k) = \\psi^{(1)}(k)$，其中 $\\psi^{(1)}(k)$ 是三伽玛函数。\n我们特定问题的牛顿法更新规则是：\n$$\nk_{n+1} = k_n - \\frac{\\psi(k_n) - C}{\\psi^{(1)}(k_n)}\n$$\n- **初始化**：一个鲁棒的初始猜测值 $k_0$ 可以通过矩估计法获得。伽玛分布变量的期望值是 $\\langle E \\rangle = k \\theta$。我们可以用样本均值 $\\bar{E}$ 来近似它，得到 $k_0 = \\bar{E} / \\theta$。\n- **收敛性与稳定性**：迭代进行直到连续估计值之差 $|k_{n+1} - k_n|$ 小于指定的容差。对于 $k > 0$，三伽玛函数 $\\psi^{(1)}(k)$ 总是正的，这意味着我们的目标函数 $g(k)$ 是凸的。这个理想的性质确保了牛顿法将稳健地收敛到唯一解。实现了一个保障措施，如果更新会导致 $k \\le 0$，则通过减小步长来确保 $k$ 的估计值在整个迭代过程中保持为正。\n\n### 算法实现\n\n为了清晰和正确，程序分为三个主要部分：\n1.  **数据生成**：一个函数 `generate_energy_samples` 接受真实自由度 $f_{\\text{true}}$、温度 $T$、一个用于缩放热能的因子以及样本数 $N$。它计算真实的形状参数 $k_{\\text{true}} = f_{\\text{true}}/2$ 和尺度参数 $\\theta_{\\text{eff}}$，并使用带种子的伪随机数生成器从相应的 $\\text{Gamma}(k_{\\text{true}}, \\theta_{\\text{eff}})$ 分布中抽取 $N$ 个样本，以保证可复现性。\n2.  **参数估计**：一个函数 `estimate_k` 实现牛顿法求解器。它接受能量样本数组和固定的估计器温度 $T$ 作为输入。它计算常数 $C$，使用矩估计法初始化 $k_0$，并迭代直到收敛以找到 $k$ 的最大似然估计。\n3.  **主程序**：主函数 `solve` 定义了五个测试用例的参数。它遍历这些用例，依次调用数据生成和估算函数。对于每个用例，它从估计的形状参数 $k$ 计算 $f_{\\text{eff}} = 2k$ 并存储结果。最后，它将所有五个 $f_{\\text{eff}}$ 值格式化并打印为单个逗号分隔的列表。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import digamma, polygamma\n\n# Physical constants and simulation setup\nK_B = 1.380649e-23  # Boltzmann constant in J/K\nSEED = 123456       # Fixed seed for reproducibility\n\ndef generate_energy_samples(f_true, T, theta_eff_factor, N, rng):\n    \"\"\"\n    Generates synthetic kinetic energy samples from a Gamma distribution.\n    \n    Args:\n        f_true (float): The true number of quadratic degrees of freedom.\n        T (float): The temperature in Kelvin.\n        theta_eff_factor (float): A factor to scale the thermal energy,\n                                  simulating thermostat artifacts.\n        N (int): The number of independent samples to generate.\n        rng (numpy.random.Generator): The random number generator instance.\n\n    Returns:\n        numpy.ndarray: An array of N kinetic energy samples.\n    \"\"\"\n    k_true = f_true / 2.0\n    theta_eff = theta_eff_factor * K_B * T\n    return rng.gamma(shape=k_true, scale=theta_eff, size=N)\n\ndef estimate_k(energies, T):\n    \"\"\"\n    Estimates the shape parameter k of a Gamma distribution using MLE\n    with a fixed scale parameter theta = k_B * T.\n\n    Args:\n        energies (numpy.ndarray): The array of observed kinetic energy samples.\n        T (float): The temperature in Kelvin used by the estimator.\n\n    Returns:\n        float: The estimated shape parameter k.\n    \"\"\"\n    theta_estimator = K_B * T\n    \n    # C is the right-hand side of the MLE equation for psi(k)\n    log_energies = np.log(energies)\n    C = np.mean(log_energies) - np.log(theta_estimator)\n    \n    # Initial guess for k using the method of moments\n    k_n = np.mean(energies) / theta_estimator\n    if k_n = 0:\n        k_n = 1.0 # Failsafe initial guess if mean is non-positive\n        \n    # Newton's method for solving psi(k) = C\n    for _ in range(100): # Max 100 iterations for convergence\n        k_prev = k_n\n        g = digamma(k_n) - C\n        g_prime = polygamma(1, k_n)\n        \n        # Update step with a safeguard to keep k positive\n        step = g / g_prime\n        if step >= k_n: \n            k_n = k_n / 2.0  # Halve the step if it would lead to non-positive k\n        else:\n            k_n = k_n - step\n        \n        # Check for convergence\n        if abs(k_n - k_prev)  1e-9:\n            break\n            \n    return k_n\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the results in the required format.\n    \"\"\"\n    rng = np.random.default_rng(SEED)\n\n    test_cases = [\n        {\"name\": \"Case 1\", \"f_true\": 300, \"T\": 300, \"theta_eff_factor\": 1.0, \"N\": 50000},\n        {\"name\": \"Case 2\", \"f_true\": 297, \"T\": 300, \"theta_eff_factor\": 1.0, \"N\": 50000},\n        {\"name\": \"Case 3\", \"f_true\": 60, \"T\": 300, \"theta_eff_factor\": 1.0, \"N\": 50000},\n        {\"name\": \"Case 4\", \"f_true\": 300, \"T\": 300, \"theta_eff_factor\": 0.85, \"N\": 50000},\n        {\"name\": \"Case 5\", \"f_true\": 6, \"T\": 300, \"theta_eff_factor\": 1.0, \"N\": 50},\n    ]\n\n    estimated_f_effs = []\n    for case in test_cases:\n        # Generate synthetic data\n        energies = generate_energy_samples(case[\"f_true\"], case[\"T\"], case[\"theta_eff_factor\"], case[\"N\"], rng)\n        \n        # Estimate k and then f_eff\n        estimated_k = estimate_k(energies, case[\"T\"])\n        f_eff = 2 * estimated_k\n        estimated_f_effs.append(f_eff)\n\n    # Format and print the final output as specified\n    print(f\"[{','.join(f'{f:.10f}' for f in estimated_f_effs)}]\")\n\n# Execute the main function to produce the output\n# In a real execution environment, this line would be called.\n# For this problem's structure, the function definitions are sufficient.\n# The user can run solve() to get the output.\n# Let's assume the problem wants the runnable code that, when executed,\n# prints the final line. So we call solve().\nif __name__ == '__main__':\n    solve()\n```", "id": "3398873"}]}