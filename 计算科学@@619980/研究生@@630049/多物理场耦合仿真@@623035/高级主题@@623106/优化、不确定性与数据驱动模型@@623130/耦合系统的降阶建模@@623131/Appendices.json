{"hands_on_practices": [{"introduction": "本实践介绍了一种构建分区降阶模型的基本技术。在此类模型中，准确而紧凑地表示耦合界面上的物理行为至关重要。该练习 [@problem_id:3524751] 演示了如何利用界面传递算子的奇异值分解（SVD）来生成一组最优的“界面模态”。您将通过解析推导，揭示保留模态数量与最坏情况下的近似误差之间的关系，从而清晰地理解模型降阶中固有的精度与复杂度之间的权衡。", "problem": "考虑一个线性时不变（LTI）分区多物理场系统，该系统包含两个通过一个界面耦合的子系统，其中子系统 $\\mathcal{A}$ 在局部由一个线性传递算子 $T \\in \\mathbb{R}^{m \\times p}$ 表征，该算子通过 $y = T g$ 将界面数据（例如广义界面力）$g \\in \\mathbb{R}^{p}$ 映射到子系统界面响应（例如广义界面位移）$y \\in \\mathbb{R}^{m}$。假设 $T$ 是有界的，并且源于一个在标准界面条件下强制椭圆或抛物线边值问题的适定离散化，因此对于物理上可容许的 $g$，该映射是线性和稳定的。在一个分区降阶建模（ROM）框架中，子系统 $\\mathcal{A}$ 的界面模态由奇异值分解（SVD）构造，即奇异值分解（SVD）$T = U \\Sigma V^{\\top}$，其中 $U \\in \\mathbb{R}^{m \\times m}$ 和 $V \\in \\mathbb{R}^{p \\times p}$ 是正交的，$\\Sigma \\in \\mathbb{R}^{m \\times p}$ 在对角线上包含奇异值 $\\sigma_{1} \\geq \\sigma_{2} \\geq \\cdots \\geq \\sigma_{q} \\geq 0$，其中 $q = \\min\\{m,p\\}$。定义 ROM 界面基为前 $r$ 个左奇异向量 $U_{r} \\in \\mathbb{R}^{m \\times r}$，并通过正交投影 $y_{r} = U_{r} U_{r}^{\\top} y$ 来近似完整的界面响应。\n\n仅使用线性算子、正交投影和奇异值分解的基本性质，推导将界面基截断到维度 $r$ 所引起的最坏情况下的界面匹配误差，该误差以算子诱导的残差度量\n$$\nE_{r}^{\\star} \\equiv \\sup_{\\|g\\|_{2} = 1} \\left\\| y - y_{r} \\right\\|_{2} = \\sup_{\\|g\\|_{2} = 1} \\left\\| (I - U_{r} U_{r}^{\\top}) T g \\right\\|_{2}.\n$$\n将最终答案表示为关于 $T$ 的奇异值的单个闭式解析表达式。答案必须是单个表达式，且不包含不等式或额外文本。不需要四舍五入，也无需报告物理单位。", "solution": "我们从线性映射 $y = T g$ 开始，其中 $T \\in \\mathbb{R}^{m \\times p}$ 且 $g \\in \\mathbb{R}^{p}$。根据定义，分区降阶建模（ROM）的界面基被选为 $T = U \\Sigma V^{\\top}$ 的奇异值分解（SVD）中左奇异向量矩阵 $U$ 的前 $r$ 列。$y$ 在 ROM 界面子空间上的投影为 $y_{r} = U_{r} U_{r}^{\\top} y$，其中 $U_{r} \\in \\mathbb{R}^{m \\times r}$ 具有标准正交列，且 $U_{r}^{\\top} U_{r} = I_{r}$。\n\n对于给定的 $g$，界面匹配误差为\n$$\ne_{r}(g) \\equiv \\left\\| y - y_{r} \\right\\|_{2} = \\left\\| (I - U_{r} U_{r}^{\\top}) y \\right\\|_{2} = \\left\\| (I - U_{r} U_{r}^{\\top}) T g \\right\\|_{2}.\n$$\n我们需要计算在单位范数输入下的最坏情况误差，\n$$\nE_{r}^{\\star} = \\sup_{\\|g\\|_{2} = 1} \\left\\| (I - U_{r} U_{r}^{\\top}) T g \\right\\|_{2}.\n$$\n为继续推导，使用 SVD $T = U \\Sigma V^{\\top}$，其中 $U$ 和 $V$ 是正交的。将到 $\\operatorname{range}(U_{r})$ 的正交补空间上的正交投影器写为 $P_{\\perp} \\equiv I - U_{r} U_{r}^{\\top}$。注意 $P_{\\perp} U_{r} = 0$ 且 $P_{\\perp}$ 保持相对于 $U$ 的正交性。考虑 $U$ 的分解 $U = [U_{r} \\;\\; U_{\\perp}]$，其中 $U_{\\perp} \\in \\mathbb{R}^{m \\times (m-r)}$ 包含剩余的左奇异向量。那么 $P_{\\perp} U = [0 \\;\\; U_{\\perp}]$，所以\n$$\nP_{\\perp} T = P_{\\perp} U \\Sigma V^{\\top} = [0 \\;\\; U_{\\perp}] \\Sigma V^{\\top}.\n$$\n让奇异值与该分区兼容地分组：$\\Sigma = \\operatorname{diag}(\\sigma_{1}, \\ldots, \\sigma_{r}, \\sigma_{r+1}, \\ldots, \\sigma_{q})$ 位于 $q \\times q$ 主对角线上，如果 $m \\neq p$ 则进行零填充。那么\n$$\nP_{\\perp} T = U_{\\perp} \\Sigma_{\\perp} V^{\\top},\n$$\n其中 $\\Sigma_{\\perp} = \\operatorname{diag}(\\sigma_{r+1}, \\ldots, \\sigma_{q})$ 位于 $(q-r) \\times (q-r)$ 对角线上，其余项为零。\n\n因此，对于任何 $g$，\n$$\n\\left\\| (I - U_{r} U_{r}^{\\top}) T g \\right\\|_{2} = \\left\\| U_{\\perp} \\Sigma_{\\perp} V^{\\top} g \\right\\|_{2}.\n$$\n因为 $U_{\\perp}$ 是正交的（其列是标准正交的，并将 $U_{r}$ 扩展为 $\\mathbb{R}^{m}$ 的一个标准正交基），所以 $2$-范数在左乘 $U_{\\perp}$ 时保持不变，从而得到\n$$\n\\left\\| U_{\\perp} \\Sigma_{\\perp} V^{\\top} g \\right\\|_{2} = \\left\\| \\Sigma_{\\perp} V^{\\top} g \\right\\|_{2}.\n$$\n类似地，由于 $V$ 是正交的，定义 $h \\equiv V^{\\top} g$，因此 $\\|h\\|_{2} = \\|g\\|_{2}$。对于单位范数的 $g$，我们有 $\\|h\\|_{2} = 1$，因此\n$$\n\\left\\| \\Sigma_{\\perp} h \\right\\|_{2}^{2} = \\sum_{i=r+1}^{q} \\sigma_{i}^{2} h_{i}^{2}.\n$$\n该量在所有 $\\|h\\|_{2} = 1$ 的 $h$ 上的上确界，是通过选择与最大被舍弃奇异值对应的坐标对齐的 $h$ 来实现的，即 $h = e_{j}$，其中 $j$ 在 $j \\in \\{r+1, \\ldots, q\\}$ 上最大化 $\\sigma_{j}$。因为奇异值是按非增序排列的，所以被舍弃的奇异值中最大的是 $\\sigma_{r+1}$。因此，\n$$\n\\sup_{\\|g\\|_{2} = 1} \\left\\| (I - U_{r} U_{r}^{\\top}) T g \\right\\|_{2} = \\sup_{\\|h\\|_{2} = 1} \\left\\| \\Sigma_{\\perp} h \\right\\|_{2} = \\sigma_{r+1}.\n$$\n这恰好是算子范数 $\\|P_{\\perp} T\\|_{2}$，它等于 $T$ 在秩为 $r$ 截断后的下一个奇异值。因此，将基于 SVD 的界面基截断到维度 $r$ 所引起的最坏情况界面匹配误差是 $T$ 的第 $(r+1)$ 个奇异值。\n\n所要求的最终表达式为\n$$\nE_{r}^{\\star} = \\sigma_{r+1}.\n$$", "answer": "$$\\boxed{\\sigma_{r+1}}$$", "id": "3524751"}, {"introduction": "在构建了降阶基之后，下一步是在降阶空间中高效地评估系统的控制方程。这个动手编程练习 [@problem_id:3524769] 探讨了超降阶技术，这对于加速（尤其是非线性）系统的计算至关重要。您将发现，一个简陋的采样方案可能会破坏原始高保真模型固有的物理守恒律，本练习的核心任务是设计并实现一个能正确处理界面通量、从而保持离散守恒性的评估方案。", "problem": "考虑一个在一维均匀网格上提出的一维、双场、耦合守恒问题，该网格有 $N$ 个控制体（单元），单元宽度为 $\\Delta x$，以及 $N+1$ 个交界面，索引为 $f=0,1,\\dots,N$。状态场为定义在单元中心 $i=0,1,\\dots,N-1$ 的 $a_i$ 和 $b_i$。控制方程由守恒律的积分形式构建，并通过有限体积法进行离散化：对于每个单元 $i$，半离散残差为\n$$\nR_i^a = F_{i+1/2}^a - F_{i-1/2}^a + S_i^a,\\qquad R_i^b = F_{i+1/2}^b - F_{i-1/2}^b + S_i^b,\n$$\n其中 $F_{i\\pm 1/2}^{(\\cdot)}$ 是交界面上的数值通量，$S_i^{(\\cdot)}$ 是局部源项。设平流速度为 $c>0$，$b$ 的扩散系数为 $D\\ge 0$，线性耦合系数为 $k\\ge 0$，源项为\n$$\nS_i^a = -k\\,(a_i - b_i),\\qquad S_i^b = +k\\,(a_i - b_i).\n$$\n假设在左边界对 $a$ 和 $b$ 均使用入口狄利克雷边界条件，给定值为 $a_{\\text{in}}$ 和 $b_{\\text{in}}$，在右边界为出口且扩散通量为零。对 $a$ 和 $b$ 的平流项均使用迎风格式（$c>0$），对 $b$ 的扩散通量使用中心差分格式。具体来说，对于交界面 $f=0,\\dots,N$ 和单元 $i=0,\\dots,N-1$：\n- 对于平流项，$F_f^a = c \\, \\tilde{a}_f$ 和 $F_f^{\\text{adv},b} = c \\, \\tilde{b}_f$，其中 $\\tilde{a}_0 = a_{\\text{in}}$，对于 $f\\ge 1$，$\\tilde{a}_f = a_{f-1}$，类似地，$\\tilde{b}_0=b_{\\text{in}}$，对于 $f\\ge 1$，$\\tilde{b}_f=b_{f-1}$。\n- 对于扩散项，$F_f^{\\text{diff},b} = -D\\,\\frac{b_{R(f)} - b_{L(f)}}{\\Delta x}$，其中对于内部交界面 $f=1,\\dots,N-1$，$L(f)=f-1$，$R(f)=f$；$F_0^{\\text{diff},b}=-D\\,\\frac{b_0 - b_{\\text{in}}}{\\Delta x}$；$F_N^{\\text{diff},b}=0$（零梯度）。\n- $b$ 的总通量为 $F_f^b = F_f^{\\text{adv},b} + F_f^{\\text{diff},b}$。\n\n这种离散构造在控制体层面强制了守恒性：内部交界面通量的级数相消求和后抵消，只留下边界贡献，而源项则在局部起作用。在降阶建模（ROM）中，常采用超简化技术，即只对控制体的一个子集进行采样以评估残差，而未采样的贡献则被忽略或近似。考虑一个采样控制体集合 $\\mathcal{S}\\subset\\{0,1,\\dots,N-1\\}$。\n\n定义两种应用于离散有限体积残差的超简化方案：\n- 一种朴素方案，对于每个 $i\\in\\mathcal{S}$，仅使用由两个采样控制体共享的交界面来形成残差（即，交界面 $f$ 的两个相邻单元都在 $\\mathcal{S}$ 中）。源项 $S_i^{(\\cdot)}$ 总是被包含在内。\n- 一种守恒方案，对于每个 $i\\in\\mathcal{S}$，使用单位权重形成包含两个相邻交界面 $i-1/2$ 和 $i+1/2$ 的残差，无论相邻单元是否被采样，并包含源项。\n\n您的任务是：\n1.  从有限体积积分守恒律出发，推导朴素超简化为何通常会因破坏内部交界面通量的级数相消特性以及忽略采样区域的边界或外部交界面而违反采样控制体的离散守恒性。\n2.  设计一个采样和加权方案，以恢复采样控制体上的精确离散守恒性。具体来说，为采样单元提出一个面向通量的残差组装方法，该方法利用交界面的有向关联以及对每个采样单元相邻的两个交界面使用单位权重，确保对于每个 $i\\in\\mathcal{S}$，超简化残差与全阶残差完全相等。\n3.  实现一个程序，用上述通量和源项构建一个测试问题，评估精确残差，并为每个测试案例计算超简化残差与精确残差在采样单元上的最大绝对偏差。为每个测试案例报告两个数字：朴素方案的最大偏差和守恒方案的最大偏差。\n\n使用以下具有固定参数和采样集的测试套件：\n- 测试案例 1：$N=10$，$\\Delta x = 1/N$，$c = 1.2$，$D = 0.05$，$k = 2.0$，$a_{\\text{in}}=1.0$，$b_{\\text{in}}=0.5$，状态确定性地初始化为 $a_i = \\sin(2\\pi i/N) + 1.0$ 和 $b_i = \\cos(2\\pi i/N) + 0.5$，采样集 $\\mathcal{S}=\\{3,4,5\\}$。\n- 测试案例 2：参数相同，采样集 $\\mathcal{S}=\\{0\\}$。\n- 测试案例 3：参数相同，采样集 $\\mathcal{S}=\\{0,1,2,3,4,5,6,7,8,9\\}$（所有控制体）。\n- 测试案例 4：参数相同，采样集 $\\mathcal{S}=\\{5,6\\}$。\n\n您的程序应：\n- 组装 $a$ 和 $b$ 的交界面通量和精确残差。\n- 根据两种方案为指定的采样集构建超简化残差。\n- 对于每个测试案例，首先计算朴素方案的最大绝对误差，然后计算守恒方案的最大绝对误差，误差在采样单元和两个场上取最大值。\n\n最终输出格式：您的程序应生成单行输出，包含一个用方括号括起来的逗号分隔列表，其中每个元素是针对一个测试案例的包含两个浮点数的列表。例如，输出应类似于 $[[e_{1,\\text{naive}},e_{1,\\text{cons}}],[e_{2,\\text{naive}},e_{2,\\text{cons}}],\\dots]$，其中每个 $e$ 以普通十进制表示法报告。", "solution": "该问题陈述具有科学依据，是适定且完整的。它描述了一个耦合平流-扩散-反应系统的典型有限体积离散化，并提出了一个关于降阶建模中使用的超简化方案的守恒性质的标准问题。所有参数和定义都清晰且在数学上是一致的。因此，该问题是有效的，下面提供了完整的解决方案。\n\n这个问题的核心在于有限体积法固有的离散守恒原理。一个有效的数值方案必须确保一个体积内守恒量的变化率与跨越其边界的通量以及内部的任何源或汇精确平衡。我们将首先形式化这一原理，然后分析不同的超简化方案如何维持或违反它。\n\n一个量 $u$ 的守恒律的积分形式由下式给出\n$$\n\\frac{d}{dt}\\int_{V} u \\,dV + \\int_{\\partial V} \\mathbf{F} \\cdot d\\mathbf{A} = \\int_{V} S \\,dV\n$$\n其中 $V$ 是一个控制体，$\\partial V$ 是其边界，$\\mathbf{F}$ 是通量矢量，$S$ 是源项。在一维情况下，对一个宽度为 $\\Delta x$、从交界面 $i-1/2$ 到 $i+1/2$ 的单元 $i$ 进行离散化，得到\n$$\n\\Delta x \\frac{du_i}{dt} + F_{i+1/2} - F_{i-1/2} = \\Delta x S_i\n$$\n半离散残差 $R_i$ 代表空间算子，使得 $\\frac{du_i}{dt} = - \\frac{1}{\\Delta x} R_i$。问题中定义的残差没有 $\\Delta x$ 缩放，即\n$$\nR_i = F_{i+1/2} - F_{i-1/2} + S_i^{\\text{vol}}\n$$\n其中 $S_i^{\\text{vol}} = \\Delta x S_i$。所给定的源项 $S_i^a$ 和 $S_i^b$ 已经是在单元体积上积分过的。为清晰起见，我们将用整数索引表示交界面，其中交界面 $f$ 位于单元 $f-1$ 和单元 $f$ 之间。因此，单元 $i$ 的残差为 $R_i = F_{i+1} - F_i + S_i$。\n\n这种公式的一个关键特性是，当对一个连续的单元块求和时，内部交界面的通量会在一个伸缩求和（级数相消）中抵消。例如，对于单元 $i$ 和 $i+1$：\n$$\nR_i + R_{i+1} = (F_{i+1} - F_i + S_i) + (F_{i+2} - F_{i+1} + S_{i+1}) = F_{i+2} - F_i + S_i + S_{i+1}\n$$\n共享交界面上的通量 $F_{i+1}$ 被消除了。对整个域 $\\{0, \\dots, N-1\\}$ 求和得到：\n$$\n\\sum_{i=0}^{N-1} R_i = \\sum_{i=0}^{N-1} (F_{i+1} - F_i) + \\sum_{i=0}^{N-1} S_i = (F_N - F_0) + \\sum_{i=0}^{N-1} S_i\n$$\n这展示了全局离散守恒性：总的变化仅由域边界（$F_0$ 和 $F_N$）的通量和所有源项的总和决定。\n\n### 1. 朴素超简化方案中的守恒性违背\n\n超简化通过仅在一小部分采样的控制体 $\\mathcal{S} \\subset \\{0, 1, \\dots, N-1\\}$ 上评估残差来近似完整系统。朴素方案试图通过进一步简化残差计算本身来进行这种近似。\n\n问题将朴素方案定义为“仅使用由两个采样控制体共享的交界面来形成残差”的方案。让我们将其形式化。如果一个交界面 $f$ 的相邻单元 $f-1$ 和 $f$ 都在 $\\mathcal{S}$ 中，则该交界面被两个采样控制体共享。对于一个给定的采样单元 $i \\in \\mathcal{S}$，其残差涉及交界面 $i$ 和 $i+1$。\n- 如果交界面 $i+1$ 是“共享的”，即单元 $i$ 和单元 $i+1$ 都在 $\\mathcal{S}$ 中，则通量 $F_{i+1}$ 对 $R_i$ 有贡献。\n- 如果交界面 $i$ 是“共享的”，即单元 $i-1$ 和单元 $i$ 都在 $\\mathcal{S}$ 中，则通量 $F_i$ 对 $R_i$ 有贡献。\n\n因此，对于一个单元 $i \\in \\mathcal{S}$，朴素超简化残差 $\\hat{R}_i^{\\text{naive}}$ 为：\n$$\n\\hat{R}_i^{\\text{naive}} = \\delta_{i+1 \\in \\mathcal{S}} F_{i+1} - \\delta_{i-1 \\in \\mathcal{S}} F_i + S_i\n$$\n其中 $\\delta$ 是一个指示函数，如果其条件为真则值为 $1$，否则为 $0$。（对于边界单元 $i=0$ 和 $i=N-1$，$i-1$ 和 $i+1$ 超出域索引集，因此它们在 $\\mathcal{S}$ 中的成员资格为假）。\n\n精确的全阶残差为 $R_i = F_{i+1} - F_i + S_i$。朴素残差中的误差为：\n$$\nE_i = R_i - \\hat{R}_i^{\\text{naive}} = (1 - \\delta_{i+1 \\in \\mathcal{S}}) F_{i+1} - (1 - \\delta_{i-1 \\in \\mathcal{S}}) F_i\n$$\n当与采样单元 $i$ 相邻的交界面是采样区域的边界时，这个误差就非零。具体来说：\n- 如果 $i \\in \\mathcal{S}$ 但其右邻居 $i+1 \\notin \\mathcal{S}$，则 $\\delta_{i+1 \\in \\mathcal{S}} = 0$。朴素残差忽略了项 $F_{i+1}$，引入了 $F_{i+1}$ 的误差。\n- 如果 $i \\in \\mathcal{S}$ 但其左邻居 $i-1 \\notin \\mathcal{S}$，则 $\\delta_{i-1 \\in \\mathcal{S}} = 0$。朴素残差忽略了项 $-F_i$，引入了 $-F_i$ 的误差。\n\n这种忽略破坏了守恒的基本原理。采样区域的边界通量（即分隔 $\\mathcal{S}$ 与其补集的交界面集合）被丢弃，意味着超简化系统没有考虑采样部分与非采样部分之间的相互作用。这导致了一个不正确、非守恒的近似。\n\n### 2. 守恒超简化方案的设计\n\n为了在采样单元的层面上恢复离散守恒性，每个 $i \\in \\mathcal{S}$ 的超简化残差必须等于精确的全阶残差。这不是对残差公式的近似，而是对真实残差的选择性评估。一个实现这一点的采样和加权方案，根据定义，就是对全阶残差中存在的所有项应用单位权重的方案。\n\n问题陈述描述了这样一种“守恒方案”，即对于每个 $i \\in \\mathcal{S}$，“使用单位权重”并包含“两个相邻交界面 $i-1/2$ 和 $i+1/2$”。这导致了对于一个单元 $i \\in \\mathcal{S}$ 的守恒超简化残差 $\\hat{R}_i^{\\text{cons}}$ 的以下公式：\n$$\n\\hat{R}_i^{\\text{cons}} = (1) \\cdot F_{i+1} - (1) \\cdot F_i + S_i = R_i\n$$\n这个设计是“守恒的”，因为它正确地计算了采样单元的全残差，从而精确地遵守了该控制体的守恒律。其关键含义，也是像 DEIM（离散经验插值法）这类方法的核心，是评估 $R_i$ 需要知道算子模板（stencil）上的状态变量（例如 $a_i, b_i$）。对于给定的有限体积方案，$R_i$ 的模板由单元 $\\{i-1, i, i+1\\}$ 组成（由于最近邻通量计算）。\n\n因此，一个真正守恒的超简化方案包含两个组成部分：\n1.  **方程采样**：选择将要评估残差的控制体集合 $\\mathcal{S}$。\n2.  **状态采样/重构**：确保每个采样残差的完整模板上的状态变量是可用的。在这个问题的背景下，给定了完整的状态向量，所以我们可以直接访问相邻非采样单元中的状态（例如，如果 $i-1 \\notin \\mathcal{S}$，则访问 $a_{i-1}$）。\n\n通过这种构造，对于任何采样单元 $i \\in \\mathcal{S}$，“守恒”超简化残差与精确残差之间的偏差，根据定义，为零。实现将通过数值验证此属性。\n\n### 3. 实现与评估\n\n我们现在将实现一个Python程序，为给定的测试案例计算精确残差和两种超简化残差。该程序将计算每种方案在所有采样单元和两个场（$a$ 和 $b$）上的最大绝对偏差。\n\n程序步骤如下：\n- 定义系统参数（$N, \\Delta x, c, D, k, a_{\\text{in}}, b_{\\text{in}}$）。\n- 按规定初始化状态向量 $a$ 和 $b$。\n- 计算所有 $N+1$ 个交界面的完整交界面通量 $F^a$ 和 $F^b$。\n- 计算所有 $N$ 个单元的精确残差 $R^a$ 和 $R^b$。\n- 对于由采样集 $\\mathcal{S}$ 定义的每个测试案例：\n    - 通过仅包含 $\\mathcal{S}$ 内部交界面的通量，计算 $i \\in \\mathcal{S}$ 的朴素残差 $\\hat{R}^{\\text{naive}}$。\n    - 通过使用完整的残差公式，计算 $i \\in \\mathcal{S}$ 的守恒残差 $\\hat{R}^{\\text{cons}}$。\n    - 计算两种方案和两个场的误差 $E_i = R_i - \\hat{R}_i$。\n    - 找出朴素方案和守恒方案的最大绝对误差。\n- 收集并以指定格式打印结果。守恒方案的误差预计恒为零。", "answer": "```python\nimport numpy as np\n\ndef compute_full_residuals(N, dx, c, D, k, a_in, b_in, a, b):\n    \"\"\"\n    Computes the full-order finite-volume residuals for the coupled system.\n\n    Args:\n        N (int): Number of control volumes.\n        dx (float): Width of a control volume.\n        c (float): Advection speed.\n        D (float): Diffusion coefficient for field b.\n        k (float): Coupling coefficient.\n        a_in (float): Inflow boundary value for a.\n        b_in (float): Inflow boundary value for b.\n        a (np.ndarray): State vector for field a (size N).\n        b (np.ndarray): State vector for field b (size N).\n\n    Returns:\n        tuple: A tuple containing:\n            - Ra (np.ndarray): Exact residual vector for field a.\n            - Rb (np.ndarray): Exact residual vector for field b.\n            - Fa (np.ndarray): Face flux vector for field a.\n            - Fb (np.ndarray): Face flux vector for field b.\n    \"\"\"\n    # Initialize flux arrays of size N+1\n    Fa = np.zeros(N + 1)\n    Fb = np.zeros(N + 1)\n\n    # Face f=0 (left boundary)\n    Fa[0] = c * a_in\n    Fb[0] = c * b_in - D * (b[0] - b_in) / dx\n\n    # Interior faces f=1 to N-1\n    for f in range(1, N):\n        # Advection flux (upwind)\n        Fa[f] = c * a[f - 1]\n        F_adv_b = c * b[f - 1]\n        # Diffusion flux (central)\n        F_diff_b = -D * (b[f] - b[f - 1]) / dx\n        Fb[f] = F_adv_b + F_diff_b\n\n    # Face f=N (right boundary)\n    Fa[N] = c * a[N - 1]\n    F_adv_b = c * b[N - 1]\n    F_diff_b = 0.0  # Zero diffusive flux\n    Fb[N] = F_adv_b + F_diff_b\n\n    # Initialize residual arrays of size N\n    Ra = np.zeros(N)\n    Rb = np.zeros(N)\n\n    # Compute residuals for cells i=0 to N-1\n    for i in range(N):\n        # Source terms\n        Sa = -k * (a[i] - b[i])\n        Sb = k * (a[i] - b[i])\n        # Residuals\n        Ra[i] = Fa[i + 1] - Fa[i] + Sa\n        Rb[i] = Fb[i + 1] - Fb[i] + Sb\n\n    return Ra, Rb, Fa, Fb\n\n\ndef solve():\n    \"\"\"\n    Main function to run the test cases and compute hyper-reduction errors.\n    \"\"\"\n    # Fixed problem parameters\n    N = 10\n    dx = 1.0 / N\n    c = 1.2\n    D = 0.05\n    k = 2.0\n    a_in = 1.0\n    b_in = 0.5\n\n    # Test cases defined by their sampled sets\n    test_cases = [\n        {\"S\": {3, 4, 5}},\n        {\"S\": {0}},\n        {\"S\": set(range(N))},\n        {\"S\": {5, 6}},\n    ]\n\n    # Initialize state vectors based on the problem description\n    i_vals = np.arange(N)\n    a_init = np.sin(2 * np.pi * i_vals / N) + 1.0\n    b_init = np.cos(2 * np.pi * i_vals / N) + 0.5\n    \n    # Compute the exact full-order residuals and fluxes once\n    Ra_exact, Rb_exact, Fa, Fb = compute_full_residuals(N, dx, c, D, k, a_in, b_in, a_init, b_init)\n\n    results = []\n    \n    for case in test_cases:\n        S = case[\"S\"]\n        max_error_naive = 0.0\n        max_error_cons = 0.0\n\n        for i in S:\n            # Source terms are always included in both schemes\n            Sa = -k * (a_init[i] - b_init[i])\n            Sb = k * (a_init[i] - b_init[i])\n\n            # --- Naive Scheme Residual Calculation ---\n            # Include flux terms only if the face is shared by two sampled cells\n            is_left_neighbor_sampled = (i > 0) and ((i - 1) in S)\n            is_right_neighbor_sampled = (i < N - 1) and ((i + 1) in S)\n            \n            # Use indicator flags to include/exclude flux terms\n            Ra_naive_i = (is_right_neighbor_sampled * Fa[i + 1]) - (is_left_neighbor_sampled * Fa[i]) + Sa\n            Rb_naive_i = (is_right_neighbor_sampled * Fb[i + 1]) - (is_left_neighbor_sampled * Fb[i]) + Sb\n\n            # --- Conservative Scheme Residual Calculation ---\n            # Use all flux terms with unit weights\n            Ra_cons_i = Fa[i + 1] - Fa[i] + Sa\n            Rb_cons_i = Fb[i + 1] - Fb[i] + Sb\n\n            # --- Error Calculation for cell i ---\n            # Compare naive residuals with exact residuals\n            error_a_naive = abs(Ra_naive_i - Ra_exact[i])\n            error_b_naive = abs(Rb_naive_i - Rb_exact[i])\n            max_error_naive = max(max_error_naive, error_a_naive, error_b_naive)\n\n            # Compare conservative residuals with exact residuals\n            error_a_cons = abs(Ra_cons_i - Ra_exact[i])\n            error_b_cons = abs(Rb_cons_i - Rb_exact[i])\n            max_error_cons = max(max_error_cons, error_a_cons, error_b_cons)\n\n        results.append([max_error_naive, max_error_cons])\n\n    # Format the output string as specified\n    # e.g., [[err1_n, err1_c], [err2_n, err2_c]]\n    output_str = \"[\" + \",\".join([f\"[{naive_err},{cons_err}]\" for naive_err, cons_err in results]) + \"]\"\n    print(output_str)\n\nsolve()\n```", "id": "3524769"}, {"introduction": "拥有了降阶基和高效的方程评估方法后，最后的挑战是求解得到的耦合代数方程组，尤其是在存在强耦合的情况下。本实践 [@problem_id:3524781] 聚焦于界面拟牛顿法，这是一种强大的迭代求解策略。您将推导降阶后的雅可比矩阵，构建其拟牛顿近似，并分析该算法的收敛性，从而深入理解耦合降阶模型的完整求解过程。", "problem": "考虑一个双物理场强耦合系统，其全阶单体界面规约产生一个对称正定的舒尔补算子 $S \\in \\mathbb{R}^{3 \\times 3}$，该算子将界面状态映射到残余牵引力。通过Galerkin投影到一个由列向量 $u_{1} = [1, 0, 0]^{\\top}$ 和 $u_{2} = [0, 1/\\sqrt{2}, 1/\\sqrt{2}]^{\\top}$ 组成的二维正交界面基 $U_{r} \\in \\mathbb{R}^{3 \\times 2}$ 上，构建了一个降阶模型 (ROM)。全阶算子为\n$$\nS = \\operatorname{diag}(6, 5, 4).\n$$\n降阶残差为 $R_{r}(y) = \\tilde{J}_{\\star} y - \\tilde{g}$，其中 $y \\in \\mathbb{R}^{2}$，精确的降阶界面雅可比矩阵是Galerkin投影 $\\tilde{J}_{\\star} = U_{r}^{\\top} S U_{r}$，而 $\\tilde{g} \\in \\mathbb{R}^{2}$ 是降阶强迫项。将降阶空间中的拟牛顿界面求解器应用于 $R_{r}(y) = 0$，其迭代公式为\n$$\ny_{k+1} = y_{k} - \\tilde{J}_{k}^{-1} R_{r}(y_{k}),\n$$\n其中 $\\tilde{J}_{k}$ 是 $\\tilde{J}_{\\star}$ 的一个近似。假设 $y_{0} = 0$ 并选择 $\\tilde{g}$ 使得初始降阶残差等于第一个标准基向量，即 $R_{r}(y_{0}) = r_{0} = e_{1}$。初始雅可比矩阵猜测是各向同性的，$\\tilde{J}_{0} = \\gamma I_{2}$，其中 $\\gamma > 0$，并且雅可比矩阵近似使用单个割线条件和Frobenius范数下的最小变化原则进行更新（也就是说，雅可比矩阵近似求解一个受割线约束的最小偏差问题）。\n\n从适用于此多物理场降阶设置的第一性原理出发：\n- 从 $S$ 和 $U_{r}$ 推导出精确的降阶界面雅可比矩阵 $\\tilde{J}_{\\star}$。\n- 使用割线条件和最小变化原则，推导出一次迭代后的第一个拟牛顿降阶雅可比矩阵 $\\tilde{J}_{1}$，并用 $\\gamma$ 和问题数据显式表示。\n- 通过计算降阶迭代矩阵 $I - \\tilde{J}_{1}^{-1} \\tilde{J}_{\\star}$ 的谱半径来分析局部线性收敛性，并将结果简化为关于 $\\gamma$ 的单个闭式解析表达式。\n\n报告谱半径的简化表达式作为你的最终答案。无需四舍五入。最终答案必须是无单位的单个闭式表达式。", "solution": "该问题要求推导应用于降阶模型的拟牛顿法的局部收敛矩阵的谱半径。该过程包括三个主要步骤：首先，确定精确的降阶雅可比矩阵 $\\tilde{J}_{\\star}$；其次，计算第一次更新后的拟牛顿雅可比矩阵近似 $\\tilde{J}_{1}$；第三，计算所得的迭代误差传播矩阵的谱半径。\n\n首先，我们推导精确的降阶界面雅可比矩阵 $\\tilde{J}_{\\star}$。这是通过将全阶舒尔补算子 $S$ Galerkin投影到降阶基 $U_r$ 上得到的。公式为 $\\tilde{J}_{\\star} = U_{r}^{\\top} S U_{r}$。\n\n全阶算子为 $S = \\operatorname{diag}(6, 5, 4)$，可以写成矩阵形式：\n$$\nS = \\begin{pmatrix} 6  0  0 \\\\ 0  5  0 \\\\ 0  0  4 \\end{pmatrix}\n$$\n降阶基 $U_r$ 由两个标准正交列向量 $u_1 = [1, 0, 0]^{\\top}$ 和 $u_2 = [0, 1/\\sqrt{2}, 1/\\sqrt{2}]^{\\top}$ 组成：\n$$\nU_r = \\begin{pmatrix} 1  0 \\\\ 0  \\frac{1}{\\sqrt{2}} \\\\ 0  \\frac{1}{\\sqrt{2}} \\end{pmatrix}\n$$\n基矩阵的转置为：\n$$\nU_{r}^{\\top} = \\begin{pmatrix} 1  0  0 \\\\ 0  \\frac{1}{\\sqrt{2}}  \\frac{1}{\\sqrt{2}} \\end{pmatrix}\n$$\n我们现在执行矩阵乘法来求解 $\\tilde{J}_{\\star}$：\n$$\n\\tilde{J}_{\\star} = U_{r}^{\\top} S U_{r} = \\begin{pmatrix} 1  0  0 \\\\ 0  \\frac{1}{\\sqrt{2}}  \\frac{1}{\\sqrt{2}} \\end{pmatrix} \\begin{pmatrix} 6  0  0 \\\\ 0  5  0 \\\\ 0  0  4 \\end{pmatrix} \\begin{pmatrix} 1  0 \\\\ 0  \\frac{1}{\\sqrt{2}} \\\\ 0  \\frac{1}{\\sqrt{2}} \\end{pmatrix}\n$$\n$$\n\\tilde{J}_{\\star} = \\begin{pmatrix} 1  0  0 \\\\ 0  \\frac{1}{\\sqrt{2}}  \\frac{1}{\\sqrt{2}} \\end{pmatrix} \\begin{pmatrix} 6  0 \\\\ 0  \\frac{5}{\\sqrt{2}} \\\\ 0  \\frac{4}{\\sqrt{2}} \\end{pmatrix} = \\begin{pmatrix} 6  0 \\\\ 0  \\frac{5}{2} + \\frac{4}{2} \\end{pmatrix} = \\begin{pmatrix} 6  0 \\\\ 0  \\frac{9}{2} \\end{pmatrix}\n$$\n因此，精确的降阶雅可比矩阵为 $\\tilde{J}_{\\star} = \\operatorname{diag}(6, 4.5)$。\n\n其次，我们推导第一个拟牛顿降阶雅可比矩阵 $\\tilde{J}_{1}$。从初始猜测 $\\tilde{J}_{0}$ 到 $\\tilde{J}_{1}$ 的更新是基于满足割线条件，同时最小化与 $\\tilde{J}_{0}$ 在Frobenius范数下的变化。这被称为Broyden的“好”方法，其更新公式为：\n$$\n\\tilde{J}_{k+1} = \\tilde{J}_{k} + \\frac{(v_k - \\tilde{J}_{k} s_k) s_k^{\\top}}{s_k^{\\top} s_k}\n$$\n其中 $s_k = y_{k+1} - y_k$ 且 $v_k = R_r(y_{k+1}) - R_r(y_k)$。我们需要计算 $k=0$ 时的这些量。\n\n初始状态为 $y_0 = 0$。初始雅可比矩阵为 $\\tilde{J}_{0} = \\gamma I_{2} = \\operatorname{diag}(\\gamma, \\gamma)$。给定的初始降阶残差为 $R_r(y_0) = r_0 = e_1 = [1, 0]^{\\top}$。\n拟牛顿迭代的第一步是：\n$$\ny_1 = y_0 - \\tilde{J}_{0}^{-1} R_r(y_0) = 0 - (\\gamma I_2)^{-1} e_1 = -\\frac{1}{\\gamma} e_1 = \\begin{pmatrix} -1/\\gamma \\\\ 0 \\end{pmatrix}\n$$\n由此，步长向量 $s_0$ 为：\n$$\ns_0 = y_1 - y_0 = \\begin{pmatrix} -1/\\gamma \\\\ 0 \\end{pmatrix}\n$$\n接下来，我们确定残差的变化量 $v_0$。降阶残差函数为 $R_r(y) = \\tilde{J}_{\\star} y - \\tilde{g}$。使用初始条件 $R_r(y_0) = \\tilde{J}_{\\star} \\cdot 0 - \\tilde{g} = e_1$，这意味着 $\\tilde{g} = -e_1$。因此，$R_r(y) = \\tilde{J}_{\\star} y + e_1$。\n我们计算 $y_1$ 处的残差：\n$$\nR_r(y_1) = \\tilde{J}_{\\star} y_1 + e_1 = \\begin{pmatrix} 6  0 \\\\ 0  \\frac{9}{2} \\end{pmatrix} \\begin{pmatrix} -1/\\gamma \\\\ 0 \\end{pmatrix} + \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix} = \\begin{pmatrix} -6/\\gamma \\\\ 0 \\end{pmatrix} + \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix} = \\begin{pmatrix} 1 - 6/\\gamma \\\\ 0 \\end{pmatrix}\n$$\n残差变化量 $v_0$ 为：\n$$\nv_0 = R_r(y_1) - R_r(y_0) = \\begin{pmatrix} 1 - 6/\\gamma \\\\ 0 \\end{pmatrix} - \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix} = \\begin{pmatrix} -6/\\gamma \\\\ 0 \\end{pmatrix}\n$$\n现在我们计算Broyden更新的各项：\n$$\n\\tilde{J}_{0} s_0 = \\begin{pmatrix} \\gamma  0 \\\\ 0  \\gamma \\end{pmatrix} \\begin{pmatrix} -1/\\gamma \\\\ 0 \\end{pmatrix} = \\begin{pmatrix} -1 \\\\ 0 \\end{pmatrix}\n$$\n$$\nv_0 - \\tilde{J}_{0} s_0 = \\begin{pmatrix} -6/\\gamma \\\\ 0 \\end{pmatrix} - \\begin{pmatrix} -1 \\\\ 0 \\end{pmatrix} = \\begin{pmatrix} 1 - 6/\\gamma \\\\ 0 \\end{pmatrix}\n$$\n$$\ns_0^{\\top} s_0 = (-1/\\gamma)^2 + 0^2 = \\frac{1}{\\gamma^2}\n$$\n更新项为：\n$$\n\\frac{(v_0 - \\tilde{J}_{0} s_0) s_0^{\\top}}{s_0^{\\top} s_0} = \\frac{\\begin{pmatrix} 1 - 6/\\gamma \\\\ 0 \\end{pmatrix} \\begin{pmatrix} -1/\\gamma  0 \\end{pmatrix}}{1/\\gamma^2} = \\gamma^2 \\begin{pmatrix} (1-6/\\gamma)(-1/\\gamma)  0 \\\\ 0  0 \\end{pmatrix} = \\begin{pmatrix} -\\gamma(1-6/\\gamma)  0 \\\\ 0  0 \\end{pmatrix} = \\begin{pmatrix} 6-\\gamma  0 \\\\ 0  0 \\end{pmatrix}\n$$\n最后，我们计算 $\\tilde{J}_1$：\n$$\n\\tilde{J}_1 = \\tilde{J}_0 + \\begin{pmatrix} 6-\\gamma  0 \\\\ 0  0 \\end{pmatrix} = \\begin{pmatrix} \\gamma  0 \\\\ 0  \\gamma \\end{pmatrix} + \\begin{pmatrix} 6-\\gamma  0 \\\\ 0  0 \\end{pmatrix} = \\begin{pmatrix} 6  0 \\\\ 0  \\gamma \\end{pmatrix}\n$$\n\n第三，我们通过计算降阶迭代矩阵 $M = I - \\tilde{J}_{1}^{-1} \\tilde{J}_{\\star}$ 的谱半径来分析局部线性收敛性。谱半径 $\\rho(M)$ 是 $M$ 的特征值的最大绝对值。\n$\\tilde{J}_1$ 的逆矩阵为（给定 $\\gamma > 0$）：\n$$\n\\tilde{J}_{1}^{-1} = \\begin{pmatrix} 1/6  0 \\\\ 0  1/\\gamma \\end{pmatrix}\n$$\n我们计算乘积 $\\tilde{J}_{1}^{-1} \\tilde{J}_{\\star}$：\n$$\n\\tilde{J}_{1}^{-1} \\tilde{J}_{\\star} = \\begin{pmatrix} 1/6  0 \\\\ 0  1/\\gamma \\end{pmatrix} \\begin{pmatrix} 6  0 \\\\ 0  \\frac{9}{2} \\end{pmatrix} = \\begin{pmatrix} 1  0 \\\\ 0  \\frac{9}{2\\gamma} \\end{pmatrix}\n$$\n现在，我们求迭代矩阵 $M$：\n$$\nM = I - \\tilde{J}_{1}^{-1} \\tilde{J}_{\\star} = \\begin{pmatrix} 1  0 \\\\ 0  1 \\end{pmatrix} - \\begin{pmatrix} 1  0 \\\\ 0  \\frac{9}{2\\gamma} \\end{pmatrix} = \\begin{pmatrix} 0  0 \\\\ 0  1 - \\frac{9}{2\\gamma} \\end{pmatrix}\n$$\n对角矩阵的特征值是其对角线上的元素。$M$ 的特征值为 $\\lambda_1 = 0$ 和 $\\lambda_2 = 1 - \\frac{9}{2\\gamma}$。\n谱半径是特征值绝对值的最大值：\n$$\n\\rho(M) = \\max(|\\lambda_1|, |\\lambda_2|) = \\max\\left( |0|, \\left|1 - \\frac{9}{2\\gamma}\\right| \\right) = \\left|1 - \\frac{9}{2\\gamma}\\right|\n$$\n这就是谱半径作为 $\\gamma$ 的函数的最终简化闭式表达式。", "answer": "$$\n\\boxed{\\left|1 - \\frac{9}{2\\gamma}\\right|}\n$$", "id": "3524781"}]}