{"hands_on_practices": [{"introduction": "理论知识的生命力在于其在解决实际问题中的应用。本练习将动量守恒的积分形式和微分形式与计算流体动力学中的一个核心挑战——壁面湍流建模——直接联系起来。我们将通过推导一个经典的壁面模型，来理解如何利用宏观的动量平衡来估计壁面剪切应力，从而避免对计算量极大的近壁区域进行完全解析，这在工程和科研的大涡模拟中至关重要。[@problem_id:3336014]", "problem": "考虑一个位于 $y=0$ 处无限平坦壁面上的统计定常、不可压缩湍流边界层，该边界层通过壁面模化的近壁大涡模拟 (LES) 进行仿真。解析的平均流平行于壁面，并且在流向和展向上是均匀的，其解析的平均流向速度为 $\\overline{U}(y)$，流体密度 $\\rho$ 为常数。假设在近壁匹配层 $0  y  \\Delta$ 内，平面平均流处于统计平衡状态，平均压力梯度和平均流向加速度可忽略不计。在该层内，平面平均总切应力（粘性应力与雷诺应力之和）近似恒定。在 $y=\\Delta$ 处的解析平均速度由对数剖面给出：$\\overline{U}(\\Delta)=\\dfrac{u_{\\ast}}{\\kappa}\\ln\\!\\left(\\dfrac{\\Delta}{y_{0}}\\right)$，其中 $u_{\\ast}=\\sqrt{\\tau_{w}/\\rho}$ 是摩擦速度，$\\tau_w$ 是壁面切应力，$\\kappa$ 是 von Kármán 常数，$y_0$ 是粗糙度长度。\n\n从动量守恒的积分形式出发，推导壁面切应力 $\\tau_w$ 的壁面模型表达式。然后，使用动量守恒的微分形式来验证您的结果。您的最终答案必须仅用匹配高度处的平均解析速度 $\\overline{U}(\\Delta)$、流体密度 $\\rho$、von Kármán 常数 $\\kappa$、匹配高度 $\\Delta$ 和粗糙度长度 $y_0$ 来表示。", "solution": "该问题要求基于动量方程的积分形式推导壁面切应力 $\\tau_w$ 的壁面模型表达式，然后使用微分形式验证此结果。$\\tau_w$ 的最终表达式必须用匹配高度处的平均解析速度 $\\overline{U}(\\Delta)$、流体密度 $\\rho$、von Kármán 常数 $\\kappa$、匹配高度 $\\Delta$ 和粗糙度长度 $y_0$ 来表示。\n\n首先，我们验证问题陈述。\n\n**第1步：提取已知条件**\n-   一个位于 $y=0$ 处无限平坦壁面上的统计定常、不可压缩的湍流边界层。\n-   该仿真是壁面模化的近壁大涡模拟 (LES)。\n-   解析的平均流平行于壁面，平均流向速度为 $\\overline{U}(y)$。\n-   平均流在流向 ($x$) 和展向 ($z$) 上是均匀的。\n-   流体密度 $\\rho$ 是常数。\n-   存在一个近壁匹配层 $0  y  \\Delta$。\n-   在此层内，平面平均流处于统计平衡状态，平均压力梯度和平均流向加速度可忽略不计。\n-   平面平均总切应力在 $0  y  \\Delta$ 范围内近似恒定。\n-   在 $y=\\Delta$ 处的解析平均速度由对数剖面给出：$\\overline{U}(\\Delta)=\\dfrac{u_{\\ast}}{\\kappa}\\ln\\!\\left(\\dfrac{\\Delta}{y_{0}}\\right)$。\n-   定义：$u_{\\ast}=\\sqrt{\\tau_{w}/\\rho}$ (摩擦速度)，$\\tau_w$ (壁面切应力)，$\\kappa$ (von Kármán 常数)，$y_0$ (粗糙度长度)。\n\n**第2步：使用提取的已知条件进行验证**\n该问题在科学上基于流体力学和湍流模拟的原理，特别是关于壁湍流和计算流体动力学(CFD)中的壁面模化。所提供的假设（平衡、均匀性、恒应力层）是推导壁面律对数律和平衡壁面模型的标准假设。该问题提法恰当，信息充分，术语清晰客观。不存在科学或逻辑上的矛盾。该设置描述了计算流体动力学中的一个经典且有效的问题。\n\n**第3步：结论与行动**\n该问题被判定为**有效**。我们继续进行求解。\n\n**第1部分：从动量守恒的积分形式推导**\n\n我们考虑一个控制体 (CV) 的流向（$x$方向）动量守恒的积分形式。该CV是一个矩形盒子，其平行于壁面的面积为 $A=L_x L_z$，高度为 $\\Delta$，从 $y=0$ 处的壁面延伸到 $y=\\Delta$ 的匹配高度。\n\n动量积分方程为：\n$$\n\\frac{d}{dt} \\int_{CV} \\rho \\overline{U} \\, dV + \\oint_{CS} \\rho \\overline{U} (\\mathbf{\\overline{u}} \\cdot \\mathbf{n}) \\, dS = \\sum F_x\n$$\n其中 $\\overline{U}$ 是平均流向速度，$\\mathbf{\\overline{u}} = (\\overline{U}(y), 0, 0)$ 是平均速度矢量，$dV$ 是微元体积，$dS$ 是控制面 (CS) 的微元面积，$\\mathbf{n}$ 是控制面上的向外单位法向量，$\\sum F_x$ 是作用在CV内流体上所有$x$方向外力的总和。\n\n我们逐项分析：\n1.  **非定常项**: $\\frac{d}{dt} \\int_{CV} \\rho \\overline{U} \\, dV$。问题陈述流场是统计定常的，意味着平均量不随时间变化。因此，该项为零。\n\n2.  **动量通量项**: $\\oint_{CS} \\rho \\overline{U} (\\mathbf{\\overline{u}} \\cdot \\mathbf{n}) \\, dS$。平均流纯粹在 $x$ 方向，$\\mathbf{\\overline{u}} = (\\overline{U}(y), 0, 0)$。因此，没有平均动量通量穿过CV的顶面 ($y=\\Delta$)、底面 ($y=0$) 或展向侧面 ($z=0, z=L_z$)，因为在这些面上 $\\mathbf{\\overline{u}} \\cdot \\mathbf{n} = 0$。通量项仅在入口 ($x=0$) 和出口 ($x=L_x$) 面上非零。然而，问题指明平均流在流向上是均匀的，意味着 $\\frac{\\partial \\overline{U}}{\\partial x} = 0$。因此，在入口面进入CV的动量通量与在出口面流出的动量通量相同。净动量通量因此为零。这也与给定的“可忽略的平均流向加速度”一致。\n\n3.  **力项**: $\\sum F_x$。外力来自于控制面上的压力和切应力。\n    -   **压力**: 问题陈述平均压力梯度可忽略，$\\frac{\\partial \\overline{p}}{\\partial x} = 0$。因此，入口面上的压力与出口面上的压力相平衡，导致净压力为零。\n    -   **切向力**:唯一对 $x$ 方向净力有贡献的表面是顶面和底面。\n        -   在底面（$y=0$，即壁面），壁面对流体施加一个阻力。该力作用于负 $x$ 方向，大小等于 $-\\tau_w A$，其中 $\\tau_w$ 是壁面切应力的大小。\n        -   在顶面 ($y=\\Delta$)，CV上方的流体对CV内的流体施加一个切向力。该力作用于正 $x$ 方向，大小等于 $\\overline{\\tau}(\\Delta) A$，其中 $\\overline{\\tau}(\\Delta)$ 是匹配高度处的总平均切应力（解析的粘性应力和亚格子尺度应力之和）。\n    净力为 $\\sum F_x = \\overline{\\tau}(\\Delta) A - \\tau_w A$。\n\n结合动量平衡的所有项，我们得到：\n$$\n0 + 0 = \\overline{\\tau}(\\Delta) A - \\tau_w A\n$$\n这可以简化为：\n$$\n\\tau_w = \\overline{\\tau}(\\Delta)\n$$\n这个结果证实了总切应力在该层中是恒定的初始假设；壁面处的应力与匹配高度处的总应力相平衡。这是平衡壁面模型的基本原理。\n\n现在，我们使用给定的对数速度剖面来构建 $\\tau_w$ 的表达式。问题提供了：\n$$\n\\overline{U}(\\Delta) = \\frac{u_{\\ast}}{\\kappa}\\ln\\!\\left(\\frac{\\Delta}{y_{0}}\\right)\n$$\n以及摩擦速度的定义：\n$$\nu_{\\ast} = \\sqrt{\\frac{\\tau_w}{\\rho}} \\quad \\implies \\quad \\tau_w = \\rho u_{\\ast}^2\n$$\n从速度剖面方程，我们求解 $u_{\\ast}$：\n$$\nu_{\\ast} = \\frac{\\kappa \\overline{U}(\\Delta)}{\\ln(\\Delta/y_0)}\n$$\n将这个 $u_{\\ast}$ 的表达式代入 $\\tau_w$ 的方程中：\n$$\n\\tau_w = \\rho \\left( \\frac{\\kappa \\overline{U}(\\Delta)}{\\ln(\\Delta/y_0)} \\right)^2\n$$\n这就是所求的壁面切应力的壁面模型表达式。\n\n**第2部分：用微分形式进行验证**\n\n在给定的假设（统计定常、平行平均流、零压力梯度）下，平面平均流向动量方程的微分形式简化为：\n$$\n\\frac{d\\overline{\\tau}}{dy} = 0\n$$\n其中 $\\overline{\\tau}(y)$ 是总平均切应力。该方程正式地表明总切应力随高度不变，即 $\\overline{\\tau}(y) = \\text{常数}$。对于边界层，该常数必须是壁面切应力，因此 $\\overline{\\tau}(y) = \\tau_w$。\n\n对数速度剖面 $\\overline{U}(y) = \\frac{u_{\\ast}}{\\kappa}\\ln(y/y_0)$ 的存在是基于湍流切应力的混合长度模型 $\\tau_t = \\rho (\\kappa y)^2 (\\frac{d\\overline{U}}{dy})^2$，以及在对数层中总应力主要由湍流应力主导的假设，即 $\\overline{\\tau} \\approx \\tau_t$。\n\n让我们验证这是自洽的。我们从对数律计算速度梯度：\n$$\n\\frac{d\\overline{U}}{dy} = \\frac{d}{dy}\\left[\\frac{u_{\\ast}}{\\kappa}\\ln\\left(\\frac{y}{y_0}\\right)\\right] = \\frac{u_{\\ast}}{\\kappa} \\frac{1}{(y/y_0)} \\frac{1}{y_0} = \\frac{u_{\\ast}}{\\kappa y}\n$$\n现在我们使用混合长度模型计算 $y=\\Delta$ 处的切应力：\n$$\n\\overline{\\tau}(\\Delta) = \\rho (\\kappa \\Delta)^2 \\left(\\left.\\frac{d\\overline{U}}{dy}\\right|_{y=\\Delta}\\right)^2 = \\rho (\\kappa \\Delta)^2 \\left(\\frac{u_{\\ast}}{\\kappa \\Delta}\\right)^2\n$$\n$$\n\\overline{\\tau}(\\Delta) = \\rho (\\kappa^2 \\Delta^2) \\left(\\frac{u_{\\ast}^2}{\\kappa^2 \\Delta^2}\\right) = \\rho u_{\\ast}^2\n$$\n根据定义，$\\tau_w = \\rho u_{\\ast}^2$。因此，我们已经证明了 $\\overline{\\tau}(\\Delta) = \\tau_w$。这个来自微分分析的结果与积分平衡得出的结论相同，证实了该框架的一致性。对数剖面内在地蕴含了大小为 $\\rho u_{\\ast}^2$ 的切应力，这在一个平衡层中必须等于壁面切应力。\n\n最终的表达式是在第1部分中推导出的那个。", "answer": "$$\\boxed{\\rho \\left( \\frac{\\kappa \\overline{U}(\\Delta)}{\\ln\\left(\\frac{\\Delta}{y_{0}}\\right)} \\right)^{2}}$$", "id": "3336014"}, {"introduction": "从连续的物理定律到离散的计算机代码，转换过程充满了需要审慎处理的细节。本练习通过一个实际的编码任务，揭示了数值实现中的一个微妙但至关重要的概念：“守恒均衡”(well-balanced)格式。我们将看到，在模拟地球物理流（如大气或海洋）时，对静水平衡的朴素离散化会如何产生虚假的动量源；并通过构建一个守恒均衡的格式，来确保离散的压力梯度能精确地抵消离散的重力源，从而在静止流体中保持静止。[@problem_id:3335974]", "problem": "考虑一个一维垂直流体柱，其高度为 $H$，横截面积为 $A$。该流体柱与垂直坐标 $z$ 对齐，$z$ 轴向上为正。设重力由体力密度 $\\rho \\mathbf{g}$ 表示，其中 $\\mathbf{g} = -g(z)\\,\\hat{\\mathbf{z}}$，$g(z) \\ge 0$ 是重力加速度的大小，可能随 $z$ 变化。假设没有运动（$\\mathbf{u} = \\mathbf{0}$），并考虑流体静力学条件。对于一个固定的控制体，动量守恒的积分形式表明，表面力与体力的总和为零。在这种情况下，唯一的表面力是压力，唯一的体力是重力。\n\n从牛顿第二定律和动量守恒的积分形式出发，推导整个流体柱的垂直动量平衡的离散残差，并用顶部和底部面上的压力以及重力体力的柱内积分来表示。然后，设计并实现一个有限体积基准测试，该测试展示了在静水压力平衡中，对重力 $\\rho \\mathbf{g}$ 的不一致离散处理如何在积分意义上导致非零的净残差（伪动量），并提出一种基于压力的修正方法，以恢复精确的离散静水压力平衡。\n\n您的基准测试必须遵循以下规范：\n\n- 基本基础：\n  - 使用牛顿第二定律和动量守恒的积分形式来分析静止的静水压力柱。\n  - 在顶部和底部面上定义 $z$ 分量的向外单位法向量，并用它们写出压力贡献的 $z$ 分量。\n  - 在静水压力平衡中使用物理上一致的 $\\rho(z)$、$p(z)$ 和 $g(z)$ 定义。\n- 几何与离散化：\n  - 使用具有 $N$ 个等厚度 $\\Delta z = H/N$ 的控制体的均匀网格，单元中心位于 $z_i = \\left(i + \\tfrac{1}{2}\\right)\\Delta z$，其中 $i = 0,1,\\dots,N-1$。\n  - 使用横截面积 $A = 1$，以便以牛顿（$\\mathrm{N}$）为单位报告力，无需额外缩放。\n- 两种待比较的离散处理方法：\n  1. 一种“朴素”离散处理方法，其中净表面压力使用在 $z=H$ 和 $z=0$ 处的连续静水压力解计算出的连续静水边界压力 $p_{\\mathrm{top}}$ 和 $p_{\\mathrm{bot}}$，而体力则通过中点法则 $\\sum_{i=0}^{N-1} \\rho_i\\,g_i\\,\\Delta z$ 进行近似，其中 $\\rho_i$ 和 $g_i$ 在单元中心处求值。这会产生一个离散残差，因为静水压力平衡的两侧采用了不同的求积方法。\n  2. 一种“基于压力的修正”方法，该方法构造一个离散的静水压力面压力场 $\\{p_{i+\\tfrac{1}{2}}\\}$，使得每个单元上的离散压力差精确地平衡该单元内的离散重力体力，从而确保对于静水压力数据，在离散意义上整个柱的净积带动量残差恒为零。使用给定的顶部边界压力 $p_{\\mathrm{top}}$ 和与重力源项一致的离散递推关系来计算 $p_{\\mathrm{bot}}$；然后使用这些离散的静水压力面压力来评估整个柱的净残差。\n- 测试案例的物理规范：\n  - 等温理想气体：对于恒定温度 $T$、理想气体常数 $R$ 和恒定 $g$，使用 $\\rho(z) = \\rho_0 \\exp\\!\\left(-\\frac{z}{H_s}\\right)$ 和 $p(z) = p_0 \\exp\\!\\left(-\\frac{z}{H_s}\\right)$，其中 $H_s = \\frac{R T}{g}$，$p_0$ 是 $z=0$ 处的底部压力，$\\rho_0 = \\frac{p_0}{R T}$。\n  - 重力随垂直方向变化的等温理想气体：$g(z) = g_0\\left(1 - \\alpha z\\right)$，其中 $\\alpha$ 很小；此时必须使用 $\\ln\\!\\left(\\frac{p(H)}{p(0)}\\right) = -\\frac{1}{R T}\\int_0^H g(z)\\,\\mathrm{d}z$ 从 $p_0$ 计算出物理上一致的顶部边界压力 $p_{\\mathrm{top}}$。\n- 单位：\n  - 所有输入的物理量必须使用国际单位制（SI）：$H$ 的单位是米（$\\mathrm{m}$），$g$ 的单位是米每二次方秒（$\\mathrm{m/s^2}$），$R$ 的单位是焦耳每千克开尔文（$\\mathrm{J/(kg\\,K)}$），$T$ 的单位是开尔文（$\\mathrm{K}$），$p$ 的单位是帕斯卡（$\\mathrm{Pa}$），$\\rho$ 的单位是千克每立方米（$\\mathrm{kg/m^3}$），力的单位是牛顿（$\\mathrm{N}$）。\n- 需要实现的数值任务：\n  - 对于每个测试案例，构造适用于该案例的静水压力 $\\rho_i$ 和 $p_{\\mathrm{top}}$。\n  - 计算“朴素”处理方法的净积带动量残差 $R_{\\mathrm{naive}}$，其值为净表面压力与离散重力体力之差。\n  - 构造与体力求积一致的离散静水压力面压力，并计算净残差 $R_{\\mathrm{fix}}$。\n  - 以牛顿（$\\mathrm{N}$）为单位报告这两个残差。\n- 测试套件：\n  - 案例1（理想路径）：恒定重力下的等温理想气体，中等分辨率。\n    - 参数：$H = 1000\\,\\mathrm{m}$，$N = 10$，$g = 9.81\\,\\mathrm{m/s^2}$，$T = 300\\,\\mathrm{K}$，$R = 287\\,\\mathrm{J/(kg\\,K)}$，$p_0 = 101325\\,\\mathrm{Pa}$。\n  - 案例2（粗分辨率）：与案例1物理模型相同，但网格非常粗。\n    - 参数：$H = 1000\\,\\mathrm{m}$，$N = 2$，$g = 9.81\\,\\mathrm{m/s^2}$，$T = 300\\,\\mathrm{K}$，$R = 287\\,\\mathrm{J/(kg\\,K)}$，$p_0 = 101325\\,\\mathrm{Pa}$。\n  - 案例3（极端粗网格边缘情况）：与案例1物理模型相同，但 $N = 1$ 个单元。\n    - 参数：$H = 1000\\,\\mathrm{m}$，$N = 1$，$g = 9.81\\,\\mathrm{m/s^2}$，$T = 300\\,\\mathrm{K}$，$R = 287\\,\\mathrm{J/(kg\\,K)}$，$p_0 = 101325\\,\\mathrm{Pa}$。\n  - 案例4（可变重力）：等温理想气体，重力随高度线性减小。\n    - 参数：$H = 2000\\,\\mathrm{m}$，$N = 20$，$g_0 = 9.81\\,\\mathrm{m/s^2}$，$\\alpha = 10^{-5}\\,\\mathrm{m^{-1}}$，$T = 300\\,\\mathrm{K}$，$R = 287\\,\\mathrm{J/(kg\\,K)}$，$p_0 = 101325\\,\\mathrm{Pa}$。\n- 最终输出格式：\n  - 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表。对于每个测试案例，输出一个包含两个元素的列表 `[R_naive, R_fix]`，单位为牛顿（$\\mathrm{N}$）。将这些每个案例的列表聚合到一个总列表中。例如，输出应类似于 `[[r_1_naive, r_1_fix],[r_2_naive, r_2_fix],...]`，其中每个 `r` 是一个代表牛顿（$\\mathrm{N}$）的浮点数。", "solution": "该问题要求推导并实现一个数值基准测试，以展示在计算流体动力学中，对于静水压力问题，“良好平衡”的离散化方案的重要性。我们必须比较一种“朴素”的有限体积离散化方法（由于不一致的数值近似而产生伪净力）和一种保证离散静水压力平衡的“基于压力的修正”方法。\n\n### 1. 连续积分形式的动量平衡\n\n我们从控制体 $V$ 及其表面 $S$ 的动量守恒定律的积分形式开始。对于密度为 $\\rho$、速度为 $\\mathbf{u}$、压力为 $p$ 的流体，在体力密度 $\\mathbf{f}_b$ 的作用下，牛顿第二定律为：\n$$\n\\frac{d}{dt}\\int_V \\rho \\mathbf{u} \\, dV = \\oint_S (-p \\mathbf{n}) \\, dS + \\int_V \\mathbf{f}_b \\, dV\n$$\n其中 $\\mathbf{n}$ 是表面 $S$ 上的向外单位法向量。\n\n对于指定的在重力作用下静止（$\\mathbf{u} = \\mathbf{0}$）的一维垂直流体柱，这是一个静水压力平衡问题。时间导数项为零。体力为 $\\mathbf{f}_b = \\rho \\mathbf{g}$，其中 $\\mathbf{g} = -g(z) \\hat{\\mathbf{z}}$。我们考虑动量方程的垂直（$\\hat{\\mathbf{z}}$）分量。控制体是整个流体柱，从 $z=0$ 到 $z=H$，横截面积 $A$ 恒定。\n\n表面积分的贡献仅来自顶面（$S_{\\text{top}}$，位于 $z=H$）和底面（$S_{\\text{bot}}$，位于 $z=0$），因为来自侧壁的贡献因对称性而抵消，或其法向量与 $\\hat{\\mathbf{z}}$ 正交。\n- 在 $S_{\\text{top}}$ 上：$\\mathbf{n} = \\hat{\\mathbf{z}}$，因此压力分量为 $\\int_{S_{\\text{top}}} (-p \\hat{\\mathbf{z}}) \\cdot \\hat{\\mathbf{z}} \\, dS = -p(H) A$。\n- 在 $S_{\\text{bot}}$ 上：$\\mathbf{n} = -\\hat{\\mathbf{z}}$，因此压力分量为 $\\int_{S_{\\text{bot}}} (-p (-\\hat{\\mathbf{z}})) \\cdot \\hat{\\mathbf{z}} \\, dS = p(0) A$。\n\n$z$ 方向上的净表面力为 $F_{S,z} = A(p(0) - p(H))$。\n\n$z$ 方向上的总体力是 $\\rho \\mathbf{g}$ 的 $z$ 分量的体积分：\n$$\nF_{B,z} = \\int_V (\\rho \\mathbf{g}) \\cdot \\hat{\\mathbf{z}} \\, dV = \\int_0^H \\int_A \\rho(z)(-g(z)) \\, dA \\, dz = -A \\int_0^H \\rho(z) g(z) \\, dz\n$$\n积分动量平衡方程是力的总和，对于平衡状态，该总和必须为零：\n$$\nF_{S,z} + F_{B,z} = 0 \\implies A(p(0) - p(H)) - A \\int_0^H \\rho(z) g(z) \\, dz = 0\n$$\n两边除以 $A$ 并重新整理，得到我们熟悉的静水压力关系式：$p(0) - p(H) = \\int_0^H \\rho(z) g(z) \\, dz$。连续系统上的净力（或残差）恒为零。\n\n### 2. 有限体积离散化\n\n高度为 $H$ 的流体柱被离散为 $N$ 个均匀的控制体（单元），索引为 $i = 0, 1, \\dots, N-1$。每个单元的厚度为 $\\Delta z = H/N$。第 $i$ 个单元占据空间域 $[i\\Delta z, (i+1)\\Delta z]$，其中心位于 $z_i = (i + \\frac{1}{2})\\Delta z$。为简单起见，问题将横截面积设为 $A=1$，因此力在数值上等于压力差或积分源项。\n\n整个流体柱的动量平衡的离散形式是连续积分形式的近似。净残差 $R_{\\text{discrete}}$ 是离散化的表面力和体力的总和。\n$$\nR_{\\text{discrete}} = F_{S,z}^{\\text{discrete}} + F_{B,z}^{\\text{discrete}}\n$$\n\n### 3. “朴素”离散处理方法\n\n“朴素”方法不一致地混合了连续和离散的表示。\n- **表面力：** 净表面力使用在区域边界处的精确、连续的静水压力来计算：$p_{\\text{bot}} = p(0)$ 和 $p_{\\text{top}} = p(H)$。\n  $$\n  F_{S,z}^{\\text{naive}} = p(0) - p(H) = \\int_0^H \\rho(z) g(z) \\, dz\n  $$\n- **体力：** 总体力通过对每个单元的贡献求和来近似。每个单元上的积分使用中点法则进行近似，密度和重力在单元中心 $z_i$ 处求值。\n  $$\n  F_{B,z}^{\\text{naive}} = \\sum_{i=0}^{N-1} \\left( -\\int_{i\\Delta z}^{(i+1)\\Delta z} \\rho(z) g(z) \\, dz \\right) \\approx \\sum_{i=0}^{N-1} \\left( - \\rho(z_i)g(z_i) \\Delta z \\right) = - \\sum_{i=0}^{N-1} \\rho_i g_i \\Delta z\n  $$\n朴素残差 $R_{\\text{naive}}$ 是这两项之和：\n$$\nR_{\\text{naive}} = \\left( p(0) - p(H) \\right) - \\sum_{i=0}^{N-1} \\rho_i g_i \\Delta z = \\int_0^H \\rho(z) g(z) \\, dz - \\sum_{i=0}^{N-1} \\rho_i g_i \\Delta z\n$$\n这个残差恰好是中点法则对积分 $\\int_0^H \\rho(z) g(z) \\, dz$ 的全局求积误差。除非 $\\rho(z)g(z)$ 是 $z$ 的线性函数（对于引力场中的理想气体而言并非如此），否则该误差是非零的。这个非零的净力是一个数值伪影，或称“伪动量”，它会破坏动态模拟的准确性。\n\n### 4. “基于压力的修正”方法（良好平衡方法）\n\n这种方法在单个控制体的层面上强制实现离散的静水压力平衡。对于单元 $i$，其面上的压力必须精确平衡其内部的离散体力。设 $p_{f,i}$ 为 $z = i\\Delta z$ 处面上的压力。单元 $i$ 的平衡关系为：\n$$\n(p_{f,i} - p_{f,i+1}) - \\rho_i g_i \\Delta z = 0\n$$\n这在离散压力梯度和离散源项之间建立了一种关系，确保它们被一致地建模。这个方程可以写成面压力的递推关系式：\n$$\np_{f,i} = p_{f,i+1} + \\rho_i g_i \\Delta z\n$$\n为了构造完整的面压力场 $\\{p_{f,j}\\}_{j=0}^N$，我们从一个边界条件开始。根据问题描述，我们将顶面 $p_{f,N}$ 的压力设置为连续值 $p(H)$。然后我们从 $i=N-1$ 向下递推到 $i=0$ 以找到所有的面压力，最终得到离散的底面压力 $p_{f,0}$。\n\n对于这种“修正后”的格式，净残差 $R_{\\text{fix}}$ 是使用从该方法推导出的边界压力 $p_{f,0}$ 和 $p_{f,N}$ 来计算的。\n$$\nR_{\\text{fix}} = (p_{f,0} - p_{f,N}) - \\sum_{i=0}^{N-1} \\rho_i g_i \\Delta z\n$$\n通过将每个单元的平衡方程从 $i=0$ 到 $N-1$ 求和，我们得到压力项的伸缩求和：\n$$\n\\sum_{i=0}^{N-1} (p_{f,i} - p_{f,i+1}) = p_{f,0} - p_{f,N}\n$$\n从每个单元的平衡关系中，我们还有 $\\sum_{i=0}^{N-1} (p_{f,i} - p_{f,i+1}) = \\sum_{i=0}^{N-1} \\rho_i g_i \\Delta z$。\n将此代入 $R_{\\text{fix}}$ 的表达式中：\n$$\nR_{\\text{fix}} = \\left( \\sum_{i=0}^{N-1} \\rho_i g_i \\Delta z \\right) - \\sum_{i=0}^{N-1} \\rho_i g_i \\Delta z = 0\n$$\n因此，通过构造，基于压力的修正方法的残差恒为零（在机器精度范围内），这证明了该方案是一种在静水压力状态下没有伪动量的良好平衡格式。\n\n### 5. 测试案例的实现\n\n该解决方案通过为每个案例定义连续物理模型来实现，并从中推导出离散量。\n\n- **恒定重力：** 对于恒定的 $g$、温度 $T$ 和气体常数 $R$，标高为 $H_s = RT/g$。等温理想气体的静水压力解为 $p(z) = p_0 e^{-z/H_s}$ 和 $\\rho(z) = p(z)/(RT)$。\n- **可变重力：** 对于 $g(z) = g_0(1 - \\alpha z)$，对静水压力关系式 $dp/p = -g(z)/(RT) \\, dz$ 积分可得 $p(z) = p_0 \\exp\\left(-\\frac{g_0}{RT}(z - \\frac{\\alpha z^2}{2})\\right)$。\n\n对于每个测试案例，我们遵循上述方法计算 $R_{\\text{naive}}$ 和 $R_{\\text{fix}}$。结果，特别是对于粗网格（$N=1, 2$），将清晰地展示朴素方法的失败以及良好平衡方法的稳健性。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef calculate_residuals(params):\n    \"\"\"\n    Calculates the naive and fixed momentum residuals for a given test case.\n    \"\"\"\n    # Extract parameters\n    H = params['H']\n    N = params['N']\n    T = params['T']\n    R = params['R']\n    p0 = params['p0']\n    \n    A = 1.0  # Cross-sectional area is 1 m^2\n    dz = H / N\n\n    # Define cell centers\n    # z_i corresponds to the center of cell i, for i in 0..N-1\n    z_i = (np.arange(N) + 0.5) * dz\n    \n    # Define continuous physics functions based on the case type\n    if params['type'] == 'const_g':\n        g_const = params['g']\n        g_func = lambda z: np.full_like(np.atleast_1d(z), g_const)\n        \n        # Scale height for isothermal atmosphere with constant g\n        Hs = R * T / g_const\n        \n        # Continuous pressure and density profiles\n        p_func = lambda z: p0 * np.exp(-z / Hs)\n        rho_func = lambda z: p_func(z) / (R * T)\n    \n    elif params['type'] == 'var_g':\n        g0 = params['g0']\n        alpha = params['alpha']\n        g_func = lambda z: g0 * (1.0 - alpha * z)\n        \n        # Continuous pressure and density for variable g\n        # Derived from integrating dp/p = -g(z)/(RT) dz\n        exponent_func = lambda z: -(g0 / (R * T)) * (z - 0.5 * alpha * z**2)\n        p_func = lambda z: p0 * np.exp(exponent_func(z))\n        rho_func = lambda z: p_func(z) / (R * T)\n\n    # Evaluate density and gravity at cell centers\n    rho_i = rho_func(z_i)\n    g_i = g_func(z_i)\n\n    # --- 1. Naive Residual Calculation ---\n    \n    # Net surface force from continuous pressure profile at domain boundaries\n    p_top_cont = p_func(H)\n    p_bot_cont = p_func(0.0) # This is p0\n    net_surface_force_naive = A * (p_bot_cont - p_top_cont)\n\n    # Total body force from midpoint rule sum over cells\n    total_body_force_discrete = A * np.sum(rho_i * g_i) * dz\n    \n    # Residual is the sum of forces (surface + body). Body force is negative.\n    # In the problem's terms: difference of surface force and magnitude of body force.\n    R_naive = net_surface_force_naive - total_body_force_discrete\n\n    # --- 2. Pressure-Based Fix Residual Calculation ---\n    \n    # Create an array for face pressures. N+1 faces for N cells.\n    # Face j is at z = j * dz.\n    p_face = np.zeros(N + 1)\n    \n    # Set the top boundary face pressure as the starting point for recursion\n    p_face[N] = p_top_cont\n\n    # Recurse downwards from top to bottom to find all face pressures\n    # p_face[i] = p_face[i+1] + rho_i[i] * g_i[i] * dz\n    for i in range(N - 1, -1, -1):\n        p_face[i] = p_face[i+1] + rho_i[i] * g_i[i] * dz\n        \n    p_bot_fix = p_face[0]\n    p_top_fix = p_face[N]\n\n    # Net surface force using the newly computed consistent boundary pressures\n    net_surface_force_fix = A * (p_bot_fix - p_top_fix)\n    \n    # The discrete body force sum is the same as before\n    # The residual for the fix should be zero by construction\n    R_fix = net_surface_force_fix - total_body_force_discrete\n    \n    return [R_naive, R_fix]\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test suite.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1 (happy path): Isothermal ideal gas with constant gravity\n        {'H': 1000.0, 'N': 10, 'g': 9.81, 'T': 300.0, 'R': 287.0, 'p0': 101325.0, \n         'g0': None, 'alpha': None, 'type': 'const_g'},\n        # Case 2 (coarse resolution): Same as Case 1, coarser grid\n        {'H': 1000.0, 'N': 2, 'g': 9.81, 'T': 300.0, 'R': 287.0, 'p0': 101325.0, \n         'g0': None, 'alpha': None, 'type': 'const_g'},\n        # Case 3 (extreme coarse edge case): N=1 cell\n        {'H': 1000.0, 'N': 1, 'g': 9.81, 'T': 300.0, 'R': 287.0, 'p0': 101325.0, \n         'g0': None, 'alpha': None, 'type': 'const_g'},\n        # Case 4 (variable gravity): Isothermal ideal gas with linearly varying g\n        {'H': 2000.0, 'N': 20, 'g': None, 'T': 300.0, 'R': 287.0, 'p0': 101325.0, \n         'g0': 9.81, 'alpha': 1e-5, 'type': 'var_g'}\n    ]\n\n    results = []\n    for case in test_cases:\n        result = calculate_residuals(case)\n        results.append(result)\n\n    # Format the output string exactly as specified\n    formatted_results = [f\"[{res[0]},{res[1]}]\" for res in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "3335974"}, {"introduction": "现代计算流体动力学的发展离不开先进数值方法的驱动，这些方法通常建立在方程的弱形式之上。本练习将引导我们探索间断伽辽金（Discontinuous Galerkin, DG）方法，这是一种功能强大的现代格式。我们将从理论出发，将动量方程的强形式转化为弱形式，然后通过编码实践，设计一个保证离散动量守恒的数值通量，深刻理解在单元交界面上如何维持守恒律，这是所有有限体积法和DG方法成功的基石。[@problem_id:3336007]", "problem": "考虑一种可压缩的牛顿流体，其质量密度为 $\\rho$，速度为 $\\mathbf{u}$，压力为 $p$，柯西应力偏量为 $\\boldsymbol{\\tau}$，单位张量为 $\\mathbf{I}$。在一个固定的控制体 $\\Omega$（其边界为 $\\partial \\Omega$，外向单位法向量为 $\\mathbf{n}$）上，若忽略体力，根据牛顿第二定律可得到积分形式的动量平衡，这是一个守恒律：总动量的时间变化率等于通过边界的净牵引通量。从这一基本出发点，通过应用散度定理和适当的光滑性假设，推导出微分（强）形式；然后，通过将强形式乘以一个具有紧支撑的足够光滑的检验函数 $\\boldsymbol{\\phi}$ 并在 $\\Omega$ 上积分，再通过分部积分将空间导数转移到 $\\boldsymbol{\\phi}$ 上，推导出弱伽辽金形式。明确讨论出现了哪些边界项，以及在何种边界条件下，弱形式与强形式等价。\n\n接下来，将问题特化为一维无粘情况（设 $\\boldsymbol{\\tau}=\\mathbf{0}$ 且 $\\mathbf{u}=u\\mathbf{e}_x$），使得守恒变量 $m=\\rho u$ 的动量方程可以写成一个具有物理通量 $f(m,\\rho,p)=\\rho u^2+p$ 的守恒律。对于数值离散，考虑在覆盖长度为 $L$ 的一维域上的 $N$ 个单元的均匀网格上使用间断伽辽金（DG）方法，采用分片常数基函数（0次多项式，也称为 $P0$），单元尺寸为常数 $\\Delta x=L/N$。用 $m_i$ 表示单元 $i$ 中动量的单元平均值，用 $(\\rho_i,p_i)$ 表示单元平均的密度和压力，在设计和测试守恒性时，您可以将它们视为独立的输入。\n\n为无粘动量方程设计一个单值数值界面通量 $F^\\star$，该通量需满足 DG 方法中全局守恒所需的两个基本性质：\n- 相容性：当左右状态相同时，$F^\\star(U,U)=f(U)$，其中 $U$ 表示计算物理通量所需的状态变量集合。\n- 守恒对称性：内部界面对相邻单元的贡献必须大小相等、方向相反，这样在对所有单元求和时，内部贡献会伸缩相消，只剩下边界通量。\n\n满足这些性质的一个具体选择是为动量方程量身定制的局部 Lax–Friedrichs（也称 Rusanov）通量。在一维空间中，设 $U_L=(\\rho_L,m_L,p_L)$ 和 $U_R=(\\rho_R,m_R,p_R)$ 分别为界面处的左、右状态，其中 $u_L=m_L/\\rho_L$，$u_R=m_R/\\rho_R$。对于比热比为 $\\gamma$ 的量热完全气体，声速为 $c_L=\\sqrt{\\gamma p_L/\\rho_L}$ 和 $c_R=\\sqrt{\\gamma p_R/\\rho_R}$。定义最大特征速度 $a=\\max\\left(\\lvert u_L\\rvert+c_L,\\lvert u_R\\rvert+c_R\\right)$。数值动量通量是物理通量的相容性中心平均值减去一个与动量跳跃成正比的稳定项：\n$$\nF^\\star(U_L,U_R)=\\tfrac{1}{2}\\left(\\rho_L u_L^2+p_L+\\rho_R u_R^2+p_R\\right)-\\tfrac{1}{2}a\\left(m_R-m_L\\right).\n$$\n用前向欧拉时间积分实现一个半离散 $P0$ DG 更新，\n$$\nm_i^{n+1}=m_i^n-\\frac{\\Delta t}{\\Delta x}\\left(F^\\star_{i+\\tfrac{1}{2}}-F^\\star_{i-\\tfrac{1}{2}}\\right),\n$$\n其中 $F^\\star_{i+\\tfrac{1}{2}}$ 是单元 $i$ 和 $i+1$ 之间界面的数值动量通量，由左右状态计算得出。对于周期性边界条件，将单元 $0$ 的左邻居视为单元 $N-1$。\n\n全程使用无量纲单位。不涉及角度。您的实现应验证由强形式和弱形式所蕴含的离散全局动量守恒性质，即所有单元平均动量之和的变化仅由边界通量引起：\n$$\n\\sum_{i=0}^{N-1} m_i^{n+1}-\\sum_{i=0}^{N-1} m_i^n=-\\frac{\\Delta t}{\\Delta x}\\left(F^\\star_{\\text{right boundary}}-F^\\star_{\\text{left boundary}}\\right).\n$$\n在周期性域上，右边界和左边界是同一个界面，因此净变化为零。\n\n实现程序以运行以下测试套件，每个测试由 $(N,L,\\Delta t,\\text{steps},\\gamma,\\text{boundary type},\\text{initial fields},\\text{boundary states})$ 指定：\n\n- 测试 1（一般周期性、非均匀“理想情况”）：$N=50$，$L=1$，$\\Delta t=10^{-3}$，$\\text{steps}=100$，$\\gamma=1.4$，周期性边界；初始场由 $\\rho(x)=1+0.2\\sin(2\\pi x)$，$u(x)=0.5+0.3\\cos(2\\pi x)$ 和 $p(x)=1+0.1\\sin(4\\pi x)$ 定义。报告一个布尔值，表示总动量是否在 $10^{-12}$ 的容差内守恒，即 $\\left\\lvert\\sum_i m_i^{\\text{final}}-\\sum_i m_i^{\\text{initial}}\\right\\rvert\\le 10^{-12}$ 是否成立。\n\n- 测试 2（均匀周期性状态）：$N=20$，$L=1$，$\\Delta t=10^{-3}$，$\\text{steps}=50$，$\\gamma=1.4$，周期性边界；初始场 $\\rho(x)=1$，$u(x)=1$，$p(x)=1$。报告一个具有相同 $10^{-12}$ 容差的布尔值。\n\n- 测试 3（非周期性、具有指定的开放边界状态；单步离散平衡）：$N=40$，$L=1$，$\\Delta t=10^{-3}$，$\\text{steps}=1$，$\\gamma=1.4$，非周期性边界；内部初始场 $\\rho(x)=1+0.1\\cos(2\\pi x)$，$u(x)=0.2+0.1\\sin(2\\pi x)$，$p(x)=1+0.05\\cos(2\\pi x)$；左边界虚拟状态 $U_L=(\\rho,p,u)=(1.1,1.05,0.3)$ 和右边界虚拟状态 $U_R=(\\rho,p,u)=(0.9,0.95,0.1)$，在计算 $F^\\star$ 时每个都转换为 $(\\rho,m=\\rho u,p)$。报告数值上观测到的总动量变化与该单步的理论预测值 $-\\frac{\\Delta t}{\\Delta x}\\left(F^\\star_{\\text{right boundary}}-F^\\star_{\\text{left boundary}}\\right)$ 之间的绝对浮点数差值。\n\n- 测试 4（边缘情况、单元数极少、随机周期性状态）：$N=2$，$L=1$，$\\Delta t=10^{-3}$，$\\text{steps}=10$，$\\gamma=1.4$，周期性边界；初始场由 $\\rho(x)=1+0.3\\sin(6\\pi x)$，$u(x)=0.4+0.2\\cos(6\\pi x)$，$p(x)=1+0.2\\sin(8\\pi x)$ 确定性地生成。报告一个具有相同 $10^{-12}$ 容差的布尔值。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，按测试 1 到 4 的顺序排列结果，例如 `[result_1,result_2,result_3,result_4]`，其中 `result_1`、`result_2` 和 `result_4` 是布尔值，`result_3` 是无量纲单位的浮点数。", "solution": "该问题需要一个包含两部分的回答：首先，是对流体动力学中动量守恒定律不同形式的理论推导和讨论；其次，是通过一个数值实现来验证特定格式的离散守恒性。\n\n### 第 1 部分：理论推导与讨论\n\n我们从一种可压缩牛顿流体在一个固定控制体 $\\Omega$（其边界为 $\\partial \\Omega$）中的基本积分形式动量守恒定律开始。\n\n**从积分形式到强形式**\n\n动量平衡是牛顿第二定律在连续介质中的表述。对于一个固定的控制体 $\\Omega$，体积内动量的时间变化率加上动量通过边界 $\\partial \\Omega$ 对流出的净速率，等于作用在体积内流体上的所有力的总和。若忽略体力，仅有的力是表面力（压力和粘性应力）。积分形式为：\n$$\n\\frac{d}{dt}\\int_{\\Omega} \\rho \\mathbf{u} \\,d V + \\oint_{\\partial\\Omega} (\\rho \\mathbf{u}) (\\mathbf{u}\\cdot\\mathbf{n}) \\,dA = \\oint_{\\partial\\Omega} \\boldsymbol{\\sigma} \\cdot \\mathbf{n} \\,dA\n$$\n其中 $\\rho$ 是质量密度，$\\mathbf{u}$ 是速度矢量，$\\mathbf{n}$ 是边界上的外向单位法向量，$\\boldsymbol{\\sigma}$ 是柯西应力张量，由 $\\boldsymbol{\\sigma} = -p\\mathbf{I} + \\boldsymbol{\\tau}$ 给出，其中 $p$ 是压力，$\\mathbf{I}$ 是单位张量，$\\boldsymbol{\\tau}$ 是偏应力张量。\n\n对流通量项可以使用张量积 $\\otimes$ 重写为 $\\rho \\mathbf{u} (\\mathbf{u}\\cdot\\mathbf{n}) = (\\rho \\mathbf{u} \\otimes \\mathbf{u}) \\cdot \\mathbf{n}$。对于固定的控制体，时间导数可以移到积分内部。方程变为：\n$$\n\\int_{\\Omega} \\frac{\\partial (\\rho \\mathbf{u})}{\\partial t} \\,d V + \\oint_{\\partial\\Omega} (\\rho \\mathbf{u} \\otimes \\mathbf{u}) \\cdot \\mathbf{n} \\,dA = \\oint_{\\partial\\Omega} \\boldsymbol{\\sigma} \\cdot \\mathbf{n} \\,dA\n$$\n通过应用散度定理，即对于足够光滑的张量场 $\\mathbf{F}$，有 $\\oint_{\\partial \\Omega} \\mathbf{F} \\cdot \\mathbf{n} \\, dA = \\int_{\\Omega} \\nabla \\cdot \\mathbf{F} \\, dV$，我们可以将面积分转换成体积分：\n$$\n\\int_{\\Omega} \\frac{\\partial (\\rho \\mathbf{u})}{\\partial t} \\,d V + \\int_{\\Omega} \\nabla \\cdot (\\rho \\mathbf{u} \\otimes \\mathbf{u}) \\,d V = \\int_{\\Omega} \\nabla \\cdot \\boldsymbol{\\sigma} \\,d V\n$$\n将各项合并到同一个积分下：\n$$\n\\int_{\\Omega} \\left[ \\frac{\\partial (\\rho \\mathbf{u})}{\\partial t} + \\nabla \\cdot (\\rho \\mathbf{u} \\otimes \\mathbf{u} - \\boldsymbol{\\sigma}) \\right] d V = \\mathbf{0}\n$$\n在被积函数足够光滑（例如，连续）的假设下，要使该积分对任意控制体 $\\Omega$ 都为零，被积函数本身必须处处为零。这就得到了动量守恒定律的微分（强）形式：\n$$\n\\frac{\\partial (\\rho \\mathbf{u})}{\\partial t} + \\nabla \\cdot (\\rho \\mathbf{u} \\otimes \\mathbf{u} - \\boldsymbol{\\sigma}) = \\mathbf{0}\n$$\n代入 $\\boldsymbol{\\sigma} = -p\\mathbf{I} + \\boldsymbol{\\tau}$，我们得到最终形式：\n$$\n\\frac{\\partial (\\rho \\mathbf{u})}{\\partial t} + \\nabla \\cdot (\\rho \\mathbf{u} \\otimes \\mathbf{u} + p\\mathbf{I} - \\boldsymbol{\\tau}) = \\mathbf{0}\n$$\n这是一个形如 $\\frac{\\partial \\mathbf{q}}{\\partial t} + \\nabla \\cdot \\mathbf{F} = \\mathbf{0}$ 的守恒律系统，其中 $\\mathbf{q} = \\rho\\mathbf{u}$ 是守恒动量分量的向量，$\\mathbf{F} = \\rho \\mathbf{u} \\otimes \\mathbf{u} + p\\mathbf{I} - \\boldsymbol{\\tau}$ 是动量通量张量。\n\n**弱伽辽金形式的推导**\n\n弱形式是通过将强形式乘以一个足够光滑的矢量检验函数 $\\boldsymbol{\\phi}$（来自一个合适的函数空间，例如 $H^1(\\Omega)$），并在域 $\\Omega$ 上积分得到的：\n$$\n\\int_{\\Omega} \\boldsymbol{\\phi} \\cdot \\left[ \\frac{\\partial (\\rho \\mathbf{u})}{\\partial t} + \\nabla \\cdot (\\rho \\mathbf{u} \\otimes \\mathbf{u} + p\\mathbf{I} - \\boldsymbol{\\tau}) \\right] d V = 0\n$$\n我们分别分析各项。时间导数项，假设 $\\boldsymbol{\\phi}$ 不是时间的函数，为 $\\int_{\\Omega} \\boldsymbol{\\phi} \\cdot \\frac{\\partial(\\rho\\mathbf{u})}{\\partial t} dV = \\frac{d}{dt} \\int_{\\Omega} \\boldsymbol{\\phi} \\cdot (\\rho\\mathbf{u}) dV$。对于通量项，我们使用分部积分（其多维形式是散度定理的一个推论）。对于一个向量 $\\mathbf{v}$ 和一个张量 $\\mathbf{F}$，一个相关的恒等式是 $\\nabla\\cdot(\\mathbf{F}^T\\mathbf{v}) = (\\nabla\\cdot\\mathbf{F})\\cdot\\mathbf{v} + \\mathbf{F}:\\nabla\\mathbf{v}$。由于通量张量 $\\mathbf{F} = \\rho \\mathbf{u} \\otimes \\mathbf{u} + p\\mathbf{I} - \\boldsymbol{\\tau}$ 是对称的，所以 $\\mathbf{F}^T=\\mathbf{F}$。因此：\n$$\n\\int_\\Omega \\boldsymbol{\\phi} \\cdot (\\nabla \\cdot \\mathbf{F}) dV = \\int_\\Omega (\\nabla \\cdot (\\mathbf{F}\\boldsymbol{\\phi})) dV - \\int_\\Omega \\mathbf{F} : \\nabla\\boldsymbol{\\phi} \\, dV\n$$\n对右侧第一项应用散度定理得到：\n$$\n\\int_\\Omega \\boldsymbol{\\phi} \\cdot (\\nabla \\cdot \\mathbf{F}) dV = \\oint_{\\partial\\Omega} (\\mathbf{F}\\boldsymbol{\\phi}) \\cdot \\mathbf{n} \\, dA - \\int_\\Omega \\mathbf{F} : \\nabla\\boldsymbol{\\phi} \\, dV = \\oint_{\\partial\\Omega} \\boldsymbol{\\phi} \\cdot (\\mathbf{F} \\cdot \\mathbf{n}) \\, dA - \\int_\\Omega \\mathbf{F} : \\nabla\\boldsymbol{\\phi} \\, dV\n$$\n将其代回积分方程，我们得到弱伽辽金形式：\n$$\n\\frac{d}{dt} \\int_{\\Omega} \\boldsymbol{\\phi} \\cdot (\\rho\\mathbf{u}) \\, dV - \\int_{\\Omega} (\\rho \\mathbf{u} \\otimes \\mathbf{u} + p\\mathbf{I} - \\boldsymbol{\\tau}) : \\nabla\\boldsymbol{\\phi} \\, dV + \\oint_{\\partial\\Omega} \\boldsymbol{\\phi} \\cdot ((\\rho \\mathbf{u} \\otimes \\mathbf{u} + p\\mathbf{I} - \\boldsymbol{\\tau}) \\cdot \\mathbf{n}) \\, dA = 0\n$$\n这种形式之所以“弱”，是因为它将空间导数从状态变量 $(\\rho, \\mathbf{u}, p, \\boldsymbol{\\tau})$ 转移到了光滑的检验函数 $\\boldsymbol{\\phi}$ 上，从而降低了对解本身的光滑性要求。这对于处理带有不连续性（如激波）的解至关重要。\n\n**等价性与边界条件**\n\n边界积分项 $\\oint_{\\partial\\Omega} \\boldsymbol{\\phi} \\cdot (\\mathbf{F} \\cdot \\mathbf{n}) \\, dA$ 是自然施加边界条件的地方。\n一个满足强形式的解（“强解”）根据定义是足够光滑的，其所有导数都存在，通过逆向分部积分，很容易证明它也满足弱形式。\n从弱形式到强形式的等价性则更为微妙。如果一个解对足够大的空间中所有可能的检验函数 $\\boldsymbol{\\phi}$ 都满足弱形式，人们可以论证它点态地满足强形式。如果我们特别选择在 $\\Omega$ 内具有紧支撑的检验函数（即在 $\\partial\\Omega$ 上 $\\boldsymbol{\\phi} = \\mathbf{0}$），则边界积分为零。弱形式变为：\n$$\n\\frac{d}{dt} \\int_{\\Omega} \\boldsymbol{\\phi} \\cdot (\\rho\\mathbf{u}) \\, dV - \\int_{\\Omega} (\\rho \\mathbf{u} \\otimes \\mathbf{u} + p\\mathbf{I} - \\boldsymbol{\\tau}) : \\nabla\\boldsymbol{\\phi} \\, dV = 0\n$$\n如果假设解是光滑的，我们可以逆向进行分部积分，以恢复强形式的微分算子乘以 $\\boldsymbol{\\phi}$ 的积分。根据变分法基本引理，这意味着算子本身为零，从而恢复了强形式。因此，对于光滑解和具有紧支撑的检验函数，弱形式和强形式是等价的。然而，弱形式更具一般性，因为它容许非光滑解。\n\n### 第 2 部分：数值实现\n\n问题特化为一维无粘（$\\boldsymbol{\\tau}=\\mathbf{0}$）情况。状态向量为 $\\mathbf{u} = u\\mathbf{e}_x$。动量方程变为：\n$$\n\\frac{\\partial (\\rho u)}{\\partial t} + \\frac{\\partial (\\rho u^2 + p)}{\\partial x} = 0\n$$\n这是一个关于守恒变量 $m = \\rho u$ 和物理通量 $f = \\rho u^2 + p$ 的守恒律 $\\frac{\\partial m}{\\partial t} + \\frac{\\partial f}{\\partial x} = 0$。\n\n我们使用分片常数基函数（$P0$）的间断伽辽金方法，在均匀网格上，这等价于有限体积法。我们将偏微分方程在一个大小为 $\\Delta x$ 的单元 $i$（$[x_{i-1/2}, x_{i+1/2}]$）上积分：\n$$\n\\int_{x_{i-1/2}}^{x_{i+1/2}} \\frac{\\partial m}{\\partial t} dx + \\int_{x_{i-1/2}}^{x_{i+1/2}} \\frac{\\partial f}{\\partial x} dx = 0 \\quad \\implies \\quad \\frac{d}{dt} \\int_{x_{i-1/2}}^{x_{i+1/2}} m \\, dx + \\left[f(x_{i+1/2}) - f(x_{i-1/2})\\right] = 0\n$$\n定义单元平均值 $m_i(t) = \\frac{1}{\\Delta x} \\int_{x_{i-1/2}}^{x_{i+1/2}} m(x,t) dx$，我们得到 $\\Delta x \\frac{dm_i}{dt} + [f(x_{i+1/2}) - f(x_{i-1/2})] = 0$。由于解在单元界面处是不连续的，我们用一个单值的数值通量 $F^\\star$ 来代替物理通量 $f$，该通量取决于界面左侧（$U_L$）和右侧（$U_R$）的状态。这给出了半离散格式：\n$$\n\\frac{dm_i}{dt} = -\\frac{1}{\\Delta x} \\left[ F^\\star(U_i, U_{i+1}) - F^\\star(U_{i-1}, U_i) \\right]\n$$\n其中 $F^\\star_{i+1/2} = F^\\star(U_i, U_{i+1})$。应用前向欧拉时间积分步长 $\\frac{m_i^{n+1}-m_i^n}{\\Delta t} = \\frac{dm_i}{dt}$，得到所给定的全离散更新规则。\n\n所选的数值通量是局部 Lax-Friedrichs（Rusanov）通量：\n$$\nF^\\star(U_L,U_R)=\\tfrac{1}{2}\\left(f(U_L)+f(U_R)\\right)-\\tfrac{1}{2}a\\left(m_R-m_L\\right)\n$$\n其中 $a=\\max\\left(\\lvert u_L\\rvert+c_L,\\lvert u_R\\rvert+c_R\\right)$ 是对最大信号速度的估计。该通量是相容的（$F^\\star(U,U) = f(U)$）且守恒的。\n\n对于周期性域，所有更新的总和为 $\\sum_{i=0}^{N-1} (m_i^{n+1}-m_i^n) = -\\frac{\\Delta t}{\\Delta x} \\sum_{i=0}^{N-1} (F^\\star_{i+1/2}-F^\\star_{i-1/2})$。这是一个伸缩求和，由于周期性（$F^\\star_{-1/2} = F^\\star_{N-1/2}$），其结果为零。因此，总动量 $\\sum m_i$ 是守恒的。对于非周期性域，求和伸缩为边界通量：$\\sum_{i=0}^{N-1} (m_i^{n+1}-m_i^n) = -\\frac{\\Delta t}{\\Delta x} (F^\\star_{\\text{right bdy}} - F^\\star_{\\text{left bdy}})$。实现将验证这些性质。对于单元平均的初始化，我们通过单元中心处的函数值来近似积分，这对于光滑函数而言是一种标准的二阶精度选择。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef rusanov_flux(rho_L, m_L, p_L, rho_R, m_R, p_R, gamma):\n    \"\"\"\n    Computes the Rusanov (local Lax-Friedrichs) numerical flux for the\n    1D inviscid momentum equation.\n    \"\"\"\n    # Left state velocity and flux\n    u_L = m_L / rho_L\n    f_L = rho_L * u_L**2 + p_L\n    \n    # Right state velocity and flux\n    u_R = m_R / rho_R\n    f_R = rho_R * u_R**2 + p_R\n    \n    # Sound speeds\n    c_L = np.sqrt(gamma * p_L / rho_L)\n    c_R = np.sqrt(gamma * p_R / rho_R)\n    \n    # Maximum characteristic speed at the interface\n    a = max(abs(u_L) + c_L, abs(u_R) + c_R)\n    \n    # Rusanov flux\n    flux = 0.5 * (f_L + f_R) - 0.5 * a * (m_R - m_L)\n    \n    return flux\n\ndef run_simulation(N, L, dt, steps, gamma, boundary_type, rho0, m0, p0, ghost_L_state=None, ghost_R_state=None):\n    \"\"\"\n    Runs the DG-P0 simulation and returns the result for the specified test.\n    \"\"\"\n    dx = L / N\n    rho, m, p = rho0.copy(), m0.copy(), p0.copy()\n    \n    initial_total_momentum = np.sum(m)\n\n    for _ in range(steps):\n        m_old = m.copy()\n        \n        # Calculate fluxes at all N interfaces (periodic) or N+1 interfaces (non-periodic)\n        if boundary_type == 'periodic':\n            fluxes = np.zeros(N)\n            for i in range(N):\n                i_L = i\n                i_R = (i + 1) % N\n                fluxes[i] = rusanov_flux(rho[i_L], m[i_L], p[i_L], rho[i_R], m[i_R], p[i_R], gamma)\n            \n            # Update momentum in each cell\n            for i in range(N):\n                flux_L = fluxes[(i - 1 + N) % N]\n                flux_R = fluxes[i]\n                m[i] = m_old[i] - (dt / dx) * (flux_R - flux_L)\n        \n        else: # non-periodic\n            fluxes = np.zeros(N + 1)\n            # Left boundary flux\n            fluxes[0] = rusanov_flux(ghost_L_state[0], ghost_L_state[1], ghost_L_state[2], rho[0], m[0], p[0], gamma)\n            \n            # Interior fluxes\n            for i in range(N - 1):\n                fluxes[i+1] = rusanov_flux(rho[i], m[i], p[i], rho[i+1], m[i+1], p[i+1], gamma)\n            \n            # Right boundary flux\n            fluxes[N] = rusanov_flux(rho[N-1], m[N-1], p[N-1], ghost_R_state[0], ghost_R_state[1], ghost_R_state[2], gamma)\n\n            # Update momentum in each cell\n            for i in range(N):\n                flux_L = fluxes[i]\n                flux_R = fluxes[i+1]\n                m[i] = m_old[i] - (dt / dx) * (flux_R - flux_L)\n\n    # Calculate and return the required metric for the test case\n    if boundary_type == 'periodic':\n        final_total_momentum = np.sum(m)\n        conservation_error = abs(final_total_momentum - initial_total_momentum)\n        return conservation_error = 1e-12\n    else: # non-periodic for Test 3\n        final_total_momentum = np.sum(m)\n        observed_change = final_total_momentum - initial_total_momentum\n        \n        F_left_bdy = fluxes[0]\n        F_right_bdy = fluxes[N]\n        predicted_change = -(dt / dx) * (F_right_bdy - F_left_bdy)\n        \n        return abs(observed_change - predicted_change)\n\ndef solve():\n    results = []\n\n    # Test 1\n    N, L, dt, steps, gamma = 50, 1.0, 1e-3, 100, 1.4\n    x = (np.arange(N) + 0.5) * (L / N)\n    rho0_1 = 1.0 + 0.2 * np.sin(2 * np.pi * x)\n    u0_1 = 0.5 + 0.3 * np.cos(2 * np.pi * x)\n    p0_1 = 1.0 + 0.1 * np.sin(4 * np.pi * x)\n    m0_1 = rho0_1 * u0_1\n    results.append(run_simulation(N, L, dt, steps, gamma, 'periodic', rho0_1, m0_1, p0_1))\n    \n    # Test 2\n    N, L, dt, steps, gamma = 20, 1.0, 1e-3, 50, 1.4\n    rho0_2 = np.full(N, 1.0)\n    u0_2 = np.full(N, 1.0)\n    p0_2 = np.full(N, 1.0)\n    m0_2 = rho0_2 * u0_2\n    results.append(run_simulation(N, L, dt, steps, gamma, 'periodic', rho0_2, m0_2, p0_2))\n\n    # Test 3\n    N, L, dt, steps, gamma = 40, 1.0, 1e-3, 1, 1.4\n    x = (np.arange(N) + 0.5) * (L / N)\n    rho0_3 = 1.0 + 0.1 * np.cos(2 * np.pi * x)\n    u0_3 = 0.2 + 0.1 * np.sin(2 * np.pi * x)\n    p0_3 = 1.0 + 0.05 * np.cos(2 * np.pi * x)\n    m0_3 = rho0_3 * u0_3\n    \n    ghost_L_pu, ghost_R_pu = (1.1, 1.05, 0.3), (0.9, 0.95, 0.1)\n    ghost_L_state = (ghost_L_pu[0], ghost_L_pu[0] * ghost_L_pu[2], ghost_L_pu[1]) # (rho, m, p)\n    ghost_R_state = (ghost_R_pu[0], ghost_R_pu[0] * ghost_R_pu[2], ghost_R_pu[1]) # (rho, m, p)\n    results.append(run_simulation(N, L, dt, steps, gamma, 'non-periodic', rho0_3, m0_3, p0_3, ghost_L_state, ghost_R_state))\n\n    # Test 4\n    N, L, dt, steps, gamma = 2, 1.0, 1e-3, 10, 1.4\n    x = (np.arange(N) + 0.5) * (L / N)\n    rho0_4 = 1.0 + 0.3 * np.sin(6 * np.pi * x)\n    u0_4 = 0.4 + 0.2 * np.cos(6 * np.pi * x)\n    p0_4 = 1.0 + 0.2 * np.sin(8 * np.pi * x)\n    m0_4 = rho0_4 * u0_4\n    results.append(run_simulation(N, L, dt, steps, gamma, 'periodic', rho0_4, m0_4, p0_4))\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```", "id": "3336007"}]}