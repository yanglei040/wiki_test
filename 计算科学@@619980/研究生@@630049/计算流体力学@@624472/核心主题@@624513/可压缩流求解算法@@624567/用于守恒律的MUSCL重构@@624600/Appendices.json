{"hands_on_practices": [{"introduction": "理解MUSCL方法的第一步是掌握斜率限制器的基本工作原理。这个练习旨在通过一个简单的计算来建立直观认识，即在一个理想的光滑线性数据剖面上，不同的限制器是如何操作的。通过对给定的线性数据应用`minmod`和`van Leer`这两种常见的限制器，我们将验证它们在这种情况下都能保持原始的二阶精度斜率，而不会进行不必要的限制。[@problem_id:3347626] 这个基础练习对于理解限制器为何能在抑制振荡的同时保持高精度至关重要。", "problem": "考虑一维标量守恒律 $u_t + f(u)_x = 0$，其定义在具有恒定间距 $\\Delta x  0$ 的均匀网格上，该网格由网格中心 $x_i$ 和网格界面 $x_{i \\pm 1/2}$ 组成。在有限体积法中，网格单元 $i$ 内的分段线性守恒律单调上游中心格式 (MUSCL) 重构为\n$$\nu_i(x) = \\bar u_i + \\sigma_i (x - x_i), \\quad x \\in [x_{i-1/2}, x_{i+1/2}],\n$$\n其中 $\\bar u_i$ 是网格平均值，$\\sigma_i$ 是由单边差商构造的受限制斜率\n$$\ns_L = \\frac{\\bar u_i - \\bar u_{i-1}}{\\Delta x}, \\qquad s_R = \\frac{\\bar u_{i+1} - \\bar u_i}{\\Delta x}.\n$$\n从网格单元 $i$ 重构的左右界面状态为\n$$\nu_{i-1/2}^R = \\bar u_i - \\frac{1}{2}\\Delta x\\, \\sigma_i, \\qquad u_{i+1/2}^L = \\bar u_i + \\frac{1}{2}\\Delta x\\, \\sigma_i.\n$$\n考虑两种斜率限制器：\n1. minmod 限制器，定义为\n$$\n\\operatorname{minmod}(a,b) = \n\\begin{cases}\n\\phantom{-}\\min(|a|,|b|)\\,\\operatorname{sign}(a),  \\text{if } a b  0,\\\\\n0,  \\text{otherwise},\n\\end{cases}\n$$\n且 $\\sigma_i^{\\mathrm{mm}} = \\operatorname{minmod}(s_L, s_R)$。\n2. van Leer 谐波平均限制器，定义为\n$$\n\\phi_{\\mathrm{VL}}(a,b) = \n\\begin{cases}\n\\dfrac{2 a b}{a + b},  \\text{if } a b  0,\\\\\n0,  \\text{otherwise},\n\\end{cases}\n$$\n且 $\\sigma_i^{\\mathrm{vl}} = \\phi_{\\mathrm{VL}}(s_L, s_R)$。\n\n给定数据 $\\bar u_{i-1} = 1$，$\\bar u_i = 2$，$\\bar u_{i+1} = 3$，计算每种限制器对应的受限制斜率 $\\sigma_i^{\\mathrm{mm}}$ 和 $\\sigma_i^{\\mathrm{vl}}$，以及相应的界面值 $u_{i-1/2}^R$ 和 $u_{i+1/2}^L$。比较结果并说明它们是否一致。按顺序将最终答案写成行向量 $(\\sigma_i^{\\mathrm{mm}}, \\sigma_i^{\\mathrm{vl}}, u_{i-1/2}^{R,\\mathrm{mm}}, u_{i+1/2}^{L,\\mathrm{mm}}, u_{i-1/2}^{R,\\mathrm{vl}}, u_{i+1/2}^{L,\\mathrm{vl}})$。无需四舍五入。", "solution": "首先根据所需标准对问题陈述进行验证。\n\n### 步骤 1：提取给定条件\n- **守恒律**: $u_t + f(u)_x = 0$。\n- **网格**: 由网格中心 $x_i$ 和界面 $x_{i \\pm 1/2}$ 组成的均匀网格，具有恒定间距 $\\Delta x  0$。\n- **网格单元 $i$ 中的 MUSCL 重构**: $u_i(x) = \\bar u_i + \\sigma_i (x - x_i)$ 对于 $x \\in [x_{i-1/2}, x_{i+1/2}]$。\n- **单边差商**: $s_L = \\frac{\\bar u_i - \\bar u_{i-1}}{\\Delta x}$ 和 $s_R = \\frac{\\bar u_{i+1} - \\bar u_i}{\\Delta x}$。\n- **从网格单元 $i$ 重构的界面状态**: $u_{i-1/2}^R = \\bar u_i - \\frac{1}{2}\\Delta x\\, \\sigma_i$ 和 $u_{i+1/2}^L = \\bar u_i + \\frac{1}{2}\\Delta x\\, \\sigma_i$。\n- **Minmod 限制器**: $\\sigma_i^{\\mathrm{mm}} = \\operatorname{minmod}(s_L, s_R)$，其中 $\\operatorname{minmod}(a,b) = \\begin{cases} \\min(|a|,|b|)\\,\\operatorname{sign}(a),  \\text{if } a b  0,\\\\ 0,  \\text{otherwise}. \\end{cases}$\n- **Van Leer 限制器**: $\\sigma_i^{\\mathrm{vl}} = \\phi_{\\mathrm{VL}}(s_L, s_R)$，其中 $\\phi_{\\mathrm{VL}}(a,b) = \\begin{cases} \\dfrac{2 a b}{a + b},  \\text{if } a b  0,\\\\ 0,  \\text{otherwise}. \\end{cases}$\n- **数据**: 网格平均值给定为 $\\bar u_{i-1} = 1$，$\\bar u_i = 2$ 和 $\\bar u_{i+1} = 3$。\n\n### 步骤 2：使用提取的给定条件进行验证\n该问题是偏微分方程数值方法领域的一个标准练习，特别是在计算流体动力学方面。\n- **科学依据**：该问题描述了守恒律的单调上游中心格式（MUSCL），这是一种成熟的二阶精度有限体积法。线性重构、单边差商以及 minmod 和 van Leer 斜率限制器的定义在此背景下都是标准且正确的。\n- **适定性**：该问题是适定的。它提供了唯一计算所求量所需的所有数据和定义。该任务是所提供公式的直接应用。\n- **客观性**：语言精确且数学化，没有任何主观或模糊的陈述。\n- **完整性与一致性**：问题是自洽的。所提供的数据对于计算是一致且充分的。没有矛盾。\n\n### 步骤 3：结论与行动\n问题是有效的。将提供完整解答。\n\n### 解题过程\n目标是根据给定的网格平均值数据 $\\bar u_{i-1} = 1$, $\\bar u_i = 2$, and $\\bar u_{i+1} = 3$，计算每种限制器对应的受限制斜率 $\\sigma_i^{\\mathrm{mm}}$ 和 $\\sigma_i^{\\mathrm{vl}}$，以及相应的界面值 $u_{i-1/2}^R$ 和 $u_{i+1/2}^L$。\n\n首先，我们计算单边差商 $s_L$ 和 $s_R$。网格间距 $\\Delta x$ 是一个正常数。\n$$\ns_L = \\frac{\\bar u_i - \\bar u_{i-1}}{\\Delta x} = \\frac{2 - 1}{\\Delta x} = \\frac{1}{\\Delta x}\n$$\n$$\ns_R = \\frac{\\bar u_{i+1} - \\bar u_i}{\\Delta x} = \\frac{3 - 2}{\\Delta x} = \\frac{1}{\\Delta x}\n$$\n我们观察到流场数据在这三个网格单元上是线性的，导致 $s_L = s_R$。\n\n接下来，我们使用 minmod 限制器计算受限制的斜率 $\\sigma_i^{\\mathrm{mm}}$。限制器的输入为 $a = s_L = \\frac{1}{\\Delta x}$ 和 $b = s_R = \\frac{1}{\\Delta x}$。由于 $\\Delta x  0$，我们有 $s_L  0$ 和 $s_R  0$，因此它们的乘积 $s_L s_R = \\frac{1}{(\\Delta x)^2}  0$。\n应用 minmod 限制器的定义：\n$$\n\\sigma_i^{\\mathrm{mm}} = \\operatorname{minmod}(s_L, s_R) = \\min(|s_L|, |s_R|)\\,\\operatorname{sign}(s_L)\n$$\n由于 $s_L = s_R = \\frac{1}{\\Delta x}$，这简化为：\n$$\n\\sigma_i^{\\mathrm{mm}} = \\min\\left(\\left|\\frac{1}{\\Delta x}\\right|, \\left|\\frac{1}{\\Delta x}\\right|\\right)\\,\\operatorname{sign}\\left(\\frac{1}{\\Delta x}\\right) = \\frac{1}{\\Delta x} \\cdot 1 = \\frac{1}{\\Delta x}\n$$\n\n现在，我们使用 van Leer 限制器计算受限制的斜率 $\\sigma_i^{\\mathrm{vl}}$。输入 $s_L$ 和 $s_R$ 是相同的。由于 $s_L s_R  0$，我们使用 van Leer 限制器定义中的相应情况：\n$$\n\\sigma_i^{\\mathrm{vl}} = \\phi_{\\mathrm{VL}}(s_L, s_R) = \\frac{2 s_L s_R}{s_L + s_R}\n$$\n代入 $s_L = s_R = \\frac{1}{\\Delta x}$：\n$$\n\\sigma_i^{\\mathrm{vl}} = \\frac{2 \\left(\\frac{1}{\\Delta x}\\right) \\left(\\frac{1}{\\Delta x}\\right)}{\\frac{1}{\\Delta x} + \\frac{1}{\\Delta x}} = \\frac{\\frac{2}{(\\Delta x)^2}}{\\frac{2}{\\Delta x}} = \\frac{2}{(\\Delta x)^2} \\cdot \\frac{\\Delta x}{2} = \\frac{1}{\\Delta x}\n$$\n对于 $s_L = s_R$ 的线性数据，正如预期的那样，两种限制器返回相同的斜率：$\\sigma_i^{\\mathrm{mm}} = \\sigma_i^{\\mathrm{vl}} = \\frac{1}{\\Delta x}$。这表明对于这种特定的线性数据，重构不受限制，并保持其二阶精度。\n\n在确定了受限制的斜率后，我们可以求出界面值。\n对于 minmod 限制器，受限制的斜率为 $\\sigma_i^{\\mathrm{mm}} = \\frac{1}{\\Delta x}$。从网格单元 $i$ 重构的界面值为：\n$$\nu_{i-1/2}^{R,\\mathrm{mm}} = \\bar u_i - \\frac{1}{2}\\Delta x\\, \\sigma_i^{\\mathrm{mm}} = 2 - \\frac{1}{2}\\Delta x \\left(\\frac{1}{\\Delta x}\\right) = 2 - \\frac{1}{2} = \\frac{3}{2}\n$$\n$$\nu_{i+1/2}^{L,\\mathrm{mm}} = \\bar u_i + \\frac{1}{2}\\Delta x\\, \\sigma_i^{\\mathrm{mm}} = 2 + \\frac{1}{2}\\Delta x \\left(\\frac{1}{\\Delta x}\\right) = 2 + \\frac{1}{2} = \\frac{5}{2}\n$$\n\n对于 van Leer 限制器，受限制的斜率为 $\\sigma_i^{\\mathrm{vl}} = \\frac{1}{\\Delta x}$。从网格单元 $i$ 重构的界面值为：\n$$\nu_{i-1/2}^{R,\\mathrm{vl}} = \\bar u_i - \\frac{1}{2}\\Delta x\\, \\sigma_i^{\\mathrm{vl}} = 2 - \\frac{1}{2}\\Delta x \\left(\\frac{1}{\\Delta x}\\right) = 2 - \\frac{1}{2} = \\frac{3}{2}\n$$\n$$\nu_{i+1/2}^{L,\\mathrm{vl}} = \\bar u_i + \\frac{1}{2}\\Delta x\\, \\sigma_i^{\\mathrm{vl}} = 2 + \\frac{1}{2}\\Delta x \\left(\\frac{1}{\\Delta x}\\right) = 2 + \\frac{1}{2} = \\frac{5}{2}\n$$\n\n两种限制器的结果一致。这是因为输入数据剖面是完全线性的，并且两种限制器都被设计为对这种剖面是二阶精度的（即不施加任何限制）。\n\n最终答案是行向量 $(\\sigma_i^{\\mathrm{mm}}, \\sigma_i^{\\mathrm{vl}}, u_{i-1/2}^{R,\\mathrm{mm}}, u_{i+1/2}^{L,\\mathrm{mm}}, u_{i-1/2}^{R,\\mathrm{vl}}, u_{i+1/2}^{L,\\mathrm{vl}})$。代入计算出的值：\n$$\n\\left(\\frac{1}{\\Delta x}, \\frac{1}{\\Delta x}, \\frac{3}{2}, \\frac{5}{2}, \\frac{3}{2}, \\frac{5}{2}\\right)\n$$", "answer": "$$\n\\boxed{\\begin{pmatrix} \\frac{1}{\\Delta x} \\frac{1}{\\Delta x} \\frac{3}{2} \\frac{5}{2} \\frac{3}{2} \\frac{5}{2} \\end{pmatrix}}\n$$", "id": "3347626"}, {"introduction": "最后的这项实践将所有概念整合到一个完整的数值模拟实验中，要求我们编写代码来求解平流方程并分析其精度。在实践中，一个格式的理论精度阶数并不总能完全达到，因为斜率限制器在防止数值振荡的同时，也可能“削平”光滑的极值点，从而降低实际观测到的收敛率。这个练习要求我们实现一个完整的MUSCL格式，通过网格加密来数值地测量其收敛率，并与TVD格式在处理光滑极值时的理论预测进行比较。[@problem_id:3347636] 这是一个总结性的练习，它模拟了计算科学家的真实工作流程：实现数值方法，通过收敛性研究来验证其正确性，并理解其性能的细微差别。", "problem": "考虑在周期性域 $x \\in [0,1]$ 上的标量守恒律 $u_t + f(u)_x = 0$，其通量为 $f(u) = a u$，平流速度 $a$ 为常数，初始条件为光滑函数 $u(x,0) = \\sin(2\\pi x)$。对于所有 $t \\ge 0$，其精确解为 $u(x,t) = \\sin(2\\pi (x - a t))$。使用有限体积法在具有 $N$ 个单元的均匀网格上进行离散化，单元宽度为 $\\Delta x = 1/N$，单元平均值为 $U_i(t) \\approx \\frac{1}{\\Delta x} \\int_{x_{i-1/2}}^{x_{i+1/2}} u(x,t)\\,dx$，并采用周期性边界条件。采用带有 van Leer 限制器的单调上游中心守恒律格式（MUSCL）进行重构，并使用具有固定 Courant–Friedrichs–Lewy (CFL) 数的两步总变差递减（TVD）龙格-库塔方法进行时间推进。\n\n从守恒律的基本有限体积平衡出发，设计并实现一个二阶精度的数值方法，具体如下：\n- 使用包含 $N$ 个单元的均匀网格，$\\Delta x = 1/N$，并对跨界面的通量使用周期性索引。\n- 对于每个单元，使用带有 van Leer 斜率限制器 $\\phi(r) = \\frac{r + |r|}{1 + |r|}$ 的 MUSCL 方法在界面处重构左状态，其中 $r$ 是连续有限差分的比率。\n- 对于 $a  0$，使用迎风选择计算数值通量，即 $F_{i+1/2} = a \\, U_{i+1/2}^{-}$，其中 $U_{i+1/2}^{-}$ 是界面 $x_{i+1/2}$ 处的左状态。\n- 使用两步 TVD 龙格-库塔方法推进解，时间步长 $\\Delta t$ 由常数 CFL 数 $C$ 决定，即 $\\Delta t = C \\, \\Delta x / a$，并进行调整，使得最终时间 $T$ 恰好通过整数步数达到。\n\n用 $u(x,0) = \\sin(2\\pi x)$ 在每个单元 $i$ 内的精确单元平均值来初始化格式，即\n$$\nU_i(0) = \\frac{1}{\\Delta x} \\int_{x_{i-1/2}}^{x_{i+1/2}} \\sin(2\\pi x)\\,dx = \\frac{\\cos(2\\pi x_{i-1/2}) - \\cos(2\\pi x_{i+1/2})}{2\\pi \\Delta x}.\n$$\n对于时间 $T = 1$、$a = 1$ 和 $C = 0.4$ 的误差研究，精确解在周期性域上返回到初始条件，因此在 $t = T$ 时的精确单元平均值与 $U_i(0)$ 一致。\n\n定义时间 $T$ 的离散 $L_2$ 误差为\n$$\nE_{L_2}(N) = \\left( \\Delta x \\sum_{i=0}^{N-1} \\left( U_i(T) - U_i(0) \\right)^2 \\right)^{1/2}.\n$$\n在两次连续的网格加密 $N_1$ 和 $N_2$ 之间，观测到的收敛阶为\n$$\np(N_1,N_2) = \\frac{\\ln\\left( E_{L_2}(N_1) / E_{L_2}(N_2) \\right)}{\\ln\\left( \\Delta x_1 / \\Delta x_2 \\right)} = \\frac{\\ln\\left( E_{L_2}(N_1) / E_{L_2}(N_2) \\right)}{\\ln\\left( N_2 / N_1 \\right)}.\n$$\n\n您的任务是：\n- 从有限体积更新和 MUSCL van Leer 重构出发，实现所述方法以计算数值解。\n- 对一系列网格加密，计算 $t=T$ 时的离散 $L_2$ 误差 $E_{L_2}(N)$。\n- 计算连续加密之间的观测收敛阶 $p(N_1,N_2)$。\n- 考虑到 $u(x,t)$ 的光滑性以及限制器在光滑剖面上的行为，推导 $E_{L_2}(N)$ 相对于 $\\Delta x$ 的预期渐近标度，并根据方法的结构证明该收敛阶的合理性。\n\n使用以下网格分辨率测试套件：\n- $N \\in \\{20,40,80,160\\}$。\n\n设置 $a = 1$、$C = 0.4$ 和 $T = 1$，均为无量纲。输出必须是不带物理单位的数值。\n\n最终输出格式：您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表。该列表必须按顺序包含四个 $L_2$ 误差和三个观测收敛阶：\n$[E_{L_2}(20),E_{L_2}(40),E_{L_2}(80),E_{L_2}(160),p(20,40),p(40,80),p(80,160)]$。", "solution": "该用户希望我解决一个计算流体动力学问题。\n\n这是我的计划：\n1.  **验证问题陈述**：我将仔细检查严谨性验证清单。\n    *   **步骤 1：提取已知信息**：我将列出问题中提供的所有参数、方程和条件。\n    *   **步骤 2：验证**：我将检查科学合理性、适定性、客观性、完整性以及所有其他标准。该问题似乎是关于双曲守恒律数值方法的标准学术练习，这是应用数学和计算物理学中一个成熟的领域。\n    *   **步骤 3：结论**：假设问题有效，我将继续进行解答。\n\n2.  **构建解决方案**：我将把问题分解成核心组成部分，并解释每个部分。\n    *   **控制方程**：标量线性平流方程 $u_t + (au)_x = 0$。\n    *   **有限体积法 (FVM)**：FVM 更新的半离散形式：$\\frac{dU_i}{dt} = -\\frac{1}{\\Delta x} (F_{i+1/2} - F_{i-1/2})$。\n    *   **MUSCL 重构**：这是关键部分。对于每个单元 $i$，我们需要在单元界面 $x_{i-1/2}$ 和 $x_{i+1/2}$ 处重构解的值。在单元内部，重构是线性的：$u(x) = U_i + s_i (x - x_i)$，其中 $x \\in [x_{i-1/2}, x_{i+1/2}]$。\n        *   斜率 $s_i$ 是通过斜率限制器确定的。\n        *   问题指定了 van Leer 限制器。\n        *   斜率 $s_i$ 是某个中心差分近似的限制版本。常见的选择是中心差分斜率 $(U_{i+1} - U_{i-1})/(2\\Delta x)$ 或前向和后向差分的某种组合。让我们使用一个标准实现。限制后的斜率通常表示为 $\\sigma_i / \\Delta x$，其中 $\\sigma_i$ 是一个限制后的差分。\n        *   限制后的差分 $\\sigma_i$ 通常通过将限制器函数 $\\phi(r_i)$ 应用于某个参考差分来计算，例如后向差分 $\\Delta_b U_i = U_i - U_{i-1}$。连续差分的比率是 $r_i = \\frac{\\Delta_f U_i}{\\Delta_b U_i} = \\frac{U_{i+1} - U_i}{U_i - U_{i-1}}$。\n        *   问题陈述中关于斜率计算的确切形式略有模糊。它说“其中 $r$ 是连续有限差分的比率”。这有点令人困惑。通常，$r$ 是连续*非限制*差分的比率，而限制器是应用*于*它们的。让我们根据标准文献重新解释这一点。单元 $i$ 的限制斜率通常基于差分 $U_i - U_{i-1}$ 和 $U_{i+1} - U_i$ 来计算。设 $\\Delta_i^b U = U_i - U_{i-1}$ 和 $\\Delta_i^f U = U_{i+1} - U_i$。比率是 $r_i = \\Delta_i^f U / \\Delta_i^b U$。限制后的斜率可以取为 $\\frac{1}{2} (1+\\kappa) \\phi(r_i) \\Delta_i^b U$ 或类似形式。限制差分 $\\sigma_i$ 的一个常见公式是限制后的前向和后向差分的平均值。`sigma_i = limiter(U_{i+1}-U_i, U_i-U_{i-1})`。让我们为 $s_i$ 假设一个对称的限制器形式。\n        *   让我们仔细重读问题：“...使用带有 van Leer 斜率限制器的 MUSCL 重构左状态...其中 $r$ 是连续有限差分的比率。” 这一定是指“连续非限制差分”。好的。让我们使用一个标准的构造方法。界面 $x_{i+1/2}$ 处的值是从左侧（单元 $i$）和右侧（单元 $i+1$）重构的。\n        *   来自左侧（单元 $i$）的值：$U_{i+1/2}^- = U_i + \\frac{1}{2} \\sigma_i$。\n        *   来自右侧（单元 $i+1$）的值：$U_{i+1/2}^+ = U_{i+1} - \\frac{1}{2} \\sigma_{i+1}$。\n        *   现在，$\\sigma_i$ 是什么？这是限制后的斜率*修正量*。$\\sigma_i$ 是非限制中心差分 $(U_{i+1} - U_{i-1})/2$ 的限制版本。不，那不对。一个更常见的方法是限制前向和后向差分。\n        *   让我们使用像 LeVeque 的《双曲问题有限体积法》这样的教科书中的公式。对于单元 $i$，斜率由邻居决定。 “连续差分”是 $\\Delta U_{i+1/2} = U_{i+1} - U_i$ 和 $\\Delta U_{i-1/2} = U_i - U_{i-1}$。比率是 $r_i = \\frac{\\Delta U_{i-1/2}}{\\Delta U_{i+1/2}} = \\frac{U_i - U_{i-1}}{U_{i+1}-U_i}$。等等，问题说 $r$ 是*连续*有限差分的比率。让我们假设这是一个印刷错误，意为标准的连续非限制差分。让我们定义 $r_i = \\frac{U_{i+1}-U_i}{U_i-U_{i-1}}$。这是“下游”梯度与“上游”梯度（对于 $a0$）的比率。\n        *   van Leer 限制器函数是 $\\phi(r) = \\frac{r + |r|}{1 + |r|}$。注意，如果 $r \\le 0$，则 $\\phi(r)=0$。\n        *   单元 $i$ 中的限制斜率 $s_i$ 通常计算为 $s_i = \\phi(r_i) \\frac{U_i - U_{i-1}}{\\Delta x}$。这是一个迎风偏置的斜率。\n        *   在单元 $i$ 边界处的重构值为：\n            *   左边界 $x_{i-1/2}$: $U_{i,L} = U_i - \\frac{\\Delta x}{2} s_i$\n            *   右边界 $x_{i+1/2}$: $U_{i,R} = U_i + \\frac{\\Delta x}{2} s_i$\n        *   这些是单元 $i$ *内部*在其边界处的状态。问题要求界面 $x_{i+1/2}$ 处的左状态，即 $U_{i+1/2}^-$。这就是 $U_{i,R}$。所以，$U_{i+1/2}^- = U_i + \\frac{1}{2} \\Delta x \\cdot s_i = U_i + \\frac{1}{2} \\phi(r_i) (U_i - U_{i-1})$。\n        *   让我们检查一下。van Leer 限制器的定义通常是针对斜率修正量，而不是斜率本身。设 $\\Delta^+_i = U_{i+1}-U_i$ 和 $\\Delta^-_i = U_i-U_{i-1}$。比率是 $r_i = \\Delta^+_i / \\Delta^-_i$。单元 $i$ 的限制斜率修正是 $\\sigma_i = \\phi(r_i) (U_i-U_{i-1})$。\n        *   所以，$U_{i+1/2}^{-} = U_i + \\frac{1}{2} \\sigma_i = U_i + \\frac{1}{2} \\phi\\left( \\frac{U_{i+1}-U_i}{U_i-U_{i-1}} \\right) (U_i - U_{i-1})$。\n        *   这似乎是一个标准的公式。让我们以此为基础继续。\n\n    *   **数值通量**：问题说 $a  0$，所以我们使用迎风格式。界面 $x_{i+1/2}$ 处的数值通量是 $F_{i+1/2} = f(U_{i+1/2}^-) = a U_{i+1/2}^-$。\n        *   所以，$F_{i+1/2} = a \\left( U_i + \\frac{1}{2} \\phi\\left( \\frac{U_{i+1}-U_i}{U_i-U_{i-1}} \\right) (U_i - U_{i-1}) \\right)$。\n        *   我们需要处理当分母为零时的比率 $r_i$。如果 $U_i - U_{i-1} = 0$，$r_i$ 未定义。如果分子也为零，解是常数，斜率为零，所以 $\\phi(r_i)(U_i-U_{i-1})=0$。如果分子非零，这是一个不连续点。处理这个问题的标准方法是设置 $r_i$ 为一个大数，使得 $\\phi(r_i) \\to 2$。但也许我们可以只检查分母是否为零。如果 `denominator == 0`，则斜率修正为 $0$。van Leer 限制器 $\\phi(r)=\\frac{r+|r|}{1+|r|}$ 对于 $r\\le0$ 是 $0$。让我们检查代码实现。`(r + abs(r)) / (1 + abs(r))`。如果 $U_i - U_{i-1}$ 是一个非常小的数，$r$ 会变得很大。$\\lim_{r\\to\\infty} \\phi(r) = \\lim_{r\\to\\infty} \\frac{2r}{1+r} = 2$。所以斜率修正变为 $2(U_i - U_{i-1})$。这似乎太大了。\n        *   让我们检查 van Leer 的另一种形式。也许是 $\\phi(r) = \\frac{r+|r|}{1+r}$？不，分母可能为零。问题陈述是 $\\phi(r) = \\frac{r + |r|}{1 + |r|}$，所以我必须用这个。\n        *   让我们重新思考斜率修正。一个常见的形式是：$\\sigma_i = \\text{vanleer}(\\Delta^-_i, \\Delta^+_i)$，其中如果 $a+b \\ne 0$，则 $\\text{vanleer}(a,b) = \\frac{ab+|ab|}{a+b}$，否则为 $0$。这等价于如果 $a,b$ 同号则为 $\\frac{2ab}{a+b}$，否则为 $0$。让我们检查与给定 $\\phi(r)$ 的关系。设 $a=\\Delta^-_i$ 和 $b=\\Delta^+_i$。那么 $r=b/a$。函数是 $\\frac{ab + |ab|}{a+b} = \\frac{a^2(b/a) + a^2|b/a|}{a(1+b/a)} = a \\frac{r+|r|}{1+r}$。这不完全一样。分母中少了一个绝对值。\n        *   让我们逐字相信问题陈述：$\\phi(r) = \\frac{r + |r|}{1 + |r|}$。单元 $i$ 的斜率修正 $\\sigma_i$ 从何而来？界面 $i+1/2$ 处的状态是 $U_{i+1/2}^- = U_i + \\frac{1}{2}s_i \\Delta x$ 和 $U_{i+1/2}^+ = U_{i+1} - \\frac{1}{2}s_{i+1} \\Delta x$。这里，$s_i$ 是单元 $i$ 中的斜率。限制斜率 $s_i$ 通常计算为 $s_i = \\frac{1}{\\Delta x} \\text{minmod}(\\alpha \\frac{U_i-U_{i-1}}{\\Delta x}, \\frac{U_{i+1}-U_i}{\\Delta x}, \\alpha \\frac{U_{i+1}-U_{i-1}}{2\\Delta x})$。有很多变体。\n        *   让我们尝试坚持一个简单、常见的解释。重构值为：\n            $U_{L, i+1/2} = U_i + 0.5 \\cdot \\text{slope}_i$\n            $U_{R, i+1/2} = U_{i+1} - 0.5 \\cdot \\text{slope}_{i+1}$\n            其中 $\\text{slope}_i$ 是单元 $i$ 中的限制斜率。\n            设 $\\Delta_i^- = U_i - U_{i-1}$，$\\Delta_i^+ = U_{i+1} - U_i$。\n            设 $r_i = \\Delta_i^+ / \\Delta_i^-$。\n            单元 $i$ 的斜率修正的一个常见选择是 $\\sigma_i = \\phi(r_i) \\Delta_i^-$。\n            这给出 $U_{L, i+1/2} = U_i + 0.5 \\cdot \\phi(r_i) \\cdot (U_i - U_{i-1})$。\n            这是迎风偏置的。让我们尝试找一个更对称的形式。\n            对称限制器应用于中心和单边差分。设 $s_C = (U_{i+1}-U_{i-1})/(2\\Delta x)$ 和 $s_U = (U_i - U_{i-1})/\\Delta x$。那么限制斜率是 $\\text{minmod}(s_C, 2s_U)$。这是 minmod。\n            让我们仔细回到问题陈述：“...使用 MUSCL 重构界面左状态...”。这意味着我们只需要 $U_{i+1/2}^-$。对于 $a0$，通量是 $F_{i+1/2} = f(U_{i+1/2}^-)$。\n            所以，我们只需要重构单元 $i$ 中的“右”值 $U_{i,R}$。\n            $U_{i,R} = U_i + \\frac{1}{2} (\\text{slope}_i \\Delta x)$。让我们称限制差分为 $\\sigma_i = \\text{slope}_i \\Delta x$。\n            所以 $U_{i+1/2}^- = U_i + \\frac{1}{2} \\sigma_i$。\n            $\\sigma_i$ 是什么？一个常见的形式是 $\\sigma_i = \\text{limiter}(U_i - U_{i-1}, U_{i+1 - U_i})$。\n            对于 van Leer，如果 $ab  0$，则 $\\text{limiter}(a,b) = \\frac{2ab}{a+b}$，否则为 $0$。\n            让我们将其与给定的 $\\phi(r)$ 联系起来。\n            设 $a = U_i - U_{i-1}$ 和 $b = U_{i+1} - U_i$。\n            如果 $r0$，$\\text{limiter}(a,b) = a \\frac{2(b/a)}{(b/a)+1} = a \\frac{2r}{r+1}$。\n            给定的函数是 $\\phi(r) = \\frac{r+|r|}{1+|r|}$。如果 $r0$，$\\phi(r) = \\frac{2r}{1+r}$。\n            所以，它匹配上了！单元 $i$ 中的限制差分是 $\\sigma_i = \\phi(r_i) (U_i - U_{i-1})$，其中 $r_i = \\frac{U_{i+1}-U_i}{U_i-U_{i-1}}$。这是一个成熟的 MUSCL-Hancock 类型格式。所以重构是：\n            $r_i = \\frac{U_{i+1}-U_i}{U_i-U_{i-1}}$（处理除以零的情况）\n            $\\sigma_i = \\phi(r_i) (U_i - U_{i-1})$\n            $U_{i+1/2}^- = U_i + \\frac{1}{2} \\sigma_i$。\n            等等，这是一个“来自上游单元”的重构。\n            这是标准方法吗？\n            让我们查阅另一个来源。例如，Toro 的书。在 $x_{i+1/2}$ 处的重构值是：\n            $u_L = U_i + \\frac{1}{2}\\Delta_i$\n            $u_R = U_{i+1} - \\frac{1}{2}\\Delta_{i+1}$\n            其中 $\\Delta_i$ 是单元 $i$ 中的限制斜率。\n            $\\Delta_i = \\text{minmod}(U_{i+1}-U_i, U_i-U_{i-1})$。这是 minmod 限制器。\n            以这种对称方式使用 van Leer 限制器将是：\n            设 $\\Delta_i^- = U_i - U_{i-1}$ 和 $\\Delta_i^+ = U_{i+1} - U_i$。\n            限制斜率修正是 $\\Delta_i = \\frac{2 \\Delta_i^- \\Delta_i^+}{\\Delta_i^- + \\Delta_i^+}$ 如果符号相同，否则为 0。\n            这给出了中心斜率。\n            那么 $U_{i+1/2}^- = U_i + \\frac{1}{2}\\Delta_i$。\n            通量 $F_{i+1/2} = a(U_i + \\frac{1}{2}\\Delta_i)$。\n            这里 $\\Delta_i$ 是单元 $i$ 的限制差分。让我们称之为 $\\sigma_i$ 以与我的符号保持一致。\n            $\\sigma_i = \\text{vanleer}(U_i - U_{i-1}, U_{i+1} - U_i)$。\n            $U_{i+1/2}^- = U_i + \\frac{1}{2} \\sigma_i$。\n            这与问题的措辞一致吗？“...使用带有 van Leer 斜率限制器 $\\phi(r) = \\frac{r + |r|}{1 + |r|}$ 的 MUSCL 重构左状态，其中 $r$ 是连续...差分的比率...”\n            让我们定义 $r_i = \\frac{U_{i+1}-U_i}{U_i - U_{i-1}}$。\n            单元 $i$ 中的限制差分可以写成 $\\sigma_i = \\frac{U_i-U_{i-1} + U_{i+1}-U_i}{2} \\times \\text{some_limiter_fn}(r_i)$。\n            形式 $\\sigma_i = \\text{vanleer}(U_i-U_{i-1}, U_{i+1}-U_i)$ 可以用 $r_i$ 重写。\n            设 $\\Delta_b = U_i-U_{i-1}$ 和 $\\Delta_f=U_{i+1}-U_i$。那么 $r_i = \\Delta_f/\\Delta_b$。\n            $\\sigma_i = \\frac{2 \\Delta_b \\Delta_f}{\\Delta_b + \\Delta_f} = \\frac{2 \\Delta_b^2 r_i}{\\Delta_b (1+r_i)} = \\Delta_b \\frac{2r_i}{1+r_i}$。\n            这就是 $\\Delta_b \\phi(r_i)$。所以一定是这样。单元 $i$ 的斜率由两侧的差分决定，然后使用该斜率确定 $i+1/2$ 处的左状态。\n            所以空间算子（ODE 的右侧）的配方是：\n            对于每个单元 $i=0, \\dots, N-1$：\n            1.  获取模板 $\\{U_{i-1}, U_i, U_{i+1}\\}$。使用周期性边界，例如 $U_{-1} = U_{N-1}$。\n            2.  计算差分：$\\Delta_b = U_i - U_{i-1}$，$\\Delta_f = U_{i+1} - U_i$。\n            3.  计算比率：$r = \\Delta_f / \\Delta_b$。处理 $\\Delta_b \\approx 0$ 的情况。如果 $\\Delta_b = 0$，那么 $r$ 应该是什么？如果 $\\Delta_f$ 也为 0，则该区域是平坦的，斜率为 0。如果 $\\Delta_f \\ne 0$，这是一个阶跃。根据限制器 $\\phi(r)$，如果 $r \\le 0$，则 $\\phi(r)=0$。如果 $\\Delta_b$ 和 $\\Delta_f$ 符号相反，则 $r0$，所以 $\\sigma_i = 0$。这在极值点是正确的。如果 $\\Delta_b = 0$ 且 $\\Delta_f \\ne 0$，我们有问题。我们假设如果 $\\Delta_b = 0$，则 $\\sigma_i = 0$。这是安全的，它在这些点上退化为一阶。这可以通过检查 `if abs(denominator)  small_epsilon` 来实现。\n            4.  计算限制器函数：$\\phi(r) = \\frac{r + |r|}{1 + |r|}$。注意这是对于 $r0$。对于 $r \\le 0$，$\\phi(r)=0$。所以我们可以只写 `if r>0: phi = (r + abs(r)) / (1 + abs(r)); else: phi=0`。不，这不鲁棒。最好说：`if r = 0: phi = 0; else: phi = 2*r / (1+r)`。\n            5.  计算单元 $i$ 的限制差分：$\\sigma_i = \\phi(r) \\Delta_b$。\n            6.  单元 $i$ 右边界处的重构状态是 $U_{i, R} = U_i + \\frac{1}{2} \\sigma_i$。\n            这是值 $U_{i+1/2}^-$。\n            通量是 $F_{i+1/2} = a U_{i+1/2}^-$。\n            单元 $i$ 的右端项是 $L(U)_i = -\\frac{1}{\\Delta x} (F_{i+1/2} - F_{i-1/2})$。\n            所以我们需要 $F_{i+1/2}$ 和 $F_{i-1/2}$。\n            $F_{i+1/2}$ 依赖于模板 $\\{U_{i-1}, U_i, U_{i+1}\\}$。\n            $F_{i-1/2}$ 依赖于模板 $\\{U_{i-2}, U_{i-1}, U_i\\}$。\n            因此，计算 $L(U)_i$ 需要模板 $\\{U_{i-2}, U_{i-1}, U_i, U_{i+1}\\}$。对于右端项算子，这是一个四点模板。这对于三阶精度通量是标准的，但我们正在构建一个二阶格式。让我们检查我的逻辑。\n\n            让我们重新检查重构。\n            $U_{i+1/2}^- = U_i + \\frac{1}{2} \\sigma_i$。\n            $F_{i+1/2} = a (U_i + \\frac{1}{2}\\sigma_i)$。\n            $L(U)_i = -\\frac{a}{\\Delta x} \\left[ (U_i + \\frac{1}{2}\\sigma_i) - (U_{i-1} + \\frac{1}{2}\\sigma_{i-1}) \\right]$。\n            $\\sigma_i$ 依赖于 $\\{U_{i-1}, U_i, U_{i+1}\\}$。\n            $\\sigma_{i-1}$ 依赖于 $\\{U_{i-2}, U_{i-1}, U_i\\}$。\n            所以 $L(U)_i$ 的模板确实是 $\\{U_{i-2}, U_{i-1}, U_i, U_{i+1}\\}$。这是正确的。\n\n            为了在 numpy 中高效地实现这一点，我们将需要使用 `np.roll` 进行周期性移位。\n            `U_im1 = np.roll(U, 1)`\n            `U_ip1 = np.roll(U, -1)`\n            `U_im2 = np.roll(U, 2)`\n            \n            让我们定义一个计算右端项的函数，比如 `RHS(U)`。\n            输入：`U`（单元平均值数组）。\n            1. `Um1 = np.roll(U, 1)`\n            2. `Up1 = np.roll(U, -1)`\n            3. `delta_b = U - Um1`\n            4. `delta_f = Up1 - U`\n            5. `r = delta_f / delta_b`（注意除以零）。让我们使用 `np.divide(delta_f, delta_b, out=np.zeros_like(r), where=delta_b!=0)`。\n            6. `phi = np.zeros_like(r)`。`mask = r > 0`。`phi[mask] = 2 * r[mask] / (1 + r[mask])`。\n            7. `sigma = phi * delta_b`。这个 `sigma` 数组是针对所有 `i` 的。\n            8. `U_left_at_interfaces = U + 0.5 * sigma`。这是一个包含所有 $i$ 的 $U_{i+1/2}^-$ 的数组。所以这个数组的索引 `i` 对应于界面 $i+1/2$。\n            9. `Fluxes = a * U_left_at_interfaces`。这是一个包含所有 $i$ 的 $F_{i+1/2}$ 的数组。\n            10. `Fluxes_im1 = np.roll(Fluxes, 1)`。这是一个包含所有 $i$ 的 $F_{i-1/2}$ 的数组。\n            11. `rhs = -(1/dx) * (Fluxes - Fluxes_im1)`。\n            这看起来是空间算子的一个可靠计划。\n\n    *   **时间积分**：两步 TVD 龙格-库塔方法。\n        *   $U^{(1)} = U^n + \\Delta t L(U^n)$\n        *   $U^{n+1} = \\frac{1}{2} U^n + \\frac{1}{2} (U^{(1)} + \\Delta t L(U^{(1)}))$\n        *   这里 $L(U)$ 是我刚刚设计的空间算子（右端项）。\n\n    *   **问题参数**：\n        *   $a = 1$。\n        *   $T = 1$。\n        *   $C = 0.4$ (CFL 数)。\n        *   $N \\in \\{20, 40, 80, 160\\}$。\n        *   $\\Delta x = 1/N$。\n        *   $\\Delta t = C \\Delta x / a$。\n        *   问题说“调整使得最终时间 $T$ 恰好通过整数步数达到”。\n            *   设 $N_{steps}$ 为步数。$N_{steps} \\Delta t = T$。\n            *   临时 $\\Delta t_p = C \\Delta x / a$。\n            *   $N_{steps} = \\lceil T / \\Delta t_p \\rceil$。\n            *   调整后的 $\\Delta t = T / N_{steps}$。\n            *   有效的 CFL 将略小于 $C=0.4$。\n\n    *   **初始条件**：\n        *   $u(x,0) = \\sin(2\\pi x)$。\n        *   单元中心 $x_i = (i+0.5)\\Delta x$ 对于 $i=0, \\dots, N-1$。\n        *   单元界面 $x_{i-1/2} = i \\Delta x$。\n        *   $U_i(0) = \\frac{1}{\\Delta x} \\int_{i\\Delta x}^{(i+1)\\Delta x} \\sin(2\\pi x) dx = \\frac{1}{\\Delta x} [-\\frac{\\cos(2\\pi x)}{2\\pi}]_{i\\Delta x}^{(i+1)\\Delta x}$\n        *   $U_i(0) = \\frac{\\cos(2\\pi i\\Delta x) - \\cos(2\\pi(i+1)\\Delta x)}{2\\pi\\Delta x}$。\n        *   问题给出了 $U_i(0) = \\frac{\\cos(2\\pi x_{i-1/2}) - \\cos(2\\pi x_{i+1/2})}{2\\pi \\Delta x}$。这是一样的。$x_{i-1/2}=i\\Delta x$ 并且 $x_{i+1/2}=(i+1)\\Delta x$。正确。\n\n    *   **误差计算**：\n        *   在 $T=1$ 时，当 $a=1$ 时，精确解是 $u(x,1) = \\sin(2\\pi(x-1)) = \\sin(2\\pi x)$，即初始条件。\n        *   所以在 $T=1$ 时的精确单元平均值是 $U_i(T)_{exact} = U_i(0)$。\n        *   离散 $L_2$ 误差是 $E_{L_2}(N) = \\sqrt{\\Delta x \\sum_{i=0}^{N-1} (U_i(T)_{numerical} - U_i(0))^2}$。这只是 `np.sqrt(dx * np.sum((U_final - U_initial)**2))`。\n\n    *   **收敛阶**：\n        *   $p(N_1, N_2) = \\frac{\\ln(E_{L_2}(N_1) / E_{L_2}(N_2))}{\\ln(N_2 / N_1)}$。\n\n    *   **预期的渐近标度**：\n        *   该格式是二阶精度的。\n        *   TVD-RK2 在时间上是二阶的。\n        *   MUSCL 重构在空间上是二阶的。\n        *   van Leer 限制器对于光滑解是二阶精度的。在极值点，梯度改变符号，$r0$，限制器函数 $\\phi(r)=0$。这使得斜率为 0，格式局部退化为一阶精度（迎风）。\n        *   由于解 $u(x,t) = \\sin(2\\pi(x-at))$ 是光滑的并且每个波长有两个极值点（一个最大值和一个最小值），因此精度阶数将从 2 降低。\n        *   对于梯度非零的光滑解，限制器是“开启”的，并达到二阶精度。例如，如果 $U_i = c_0 + c_1 i \\Delta x$，那么 $U_{i+1}-U_i = c_1 \\Delta x$ 并且 $U_i-U_{i-1} = c_1 \\Delta x$。所以 $r_i=1$。$\\phi(1) = 2(1)/(1+1) = 1$。斜率被保留。该格式对于单调光滑数据是二阶精度的。\n        *   在极值点，$U_i$ 是一个局部最大值/最小值。假设在 $i_0$ 处，$U_{i_0}$ 是最大值。那么 $U_{i_0}-U_{i_0-1} > 0$ 并且 $U_{i_0+1}-U_{i_0}  0$。所以对于单元 $i_0$，$r_{i_0}  0$ 并且 $\\phi(r_{i_0})=0$，导致零斜率。对于单元 $i_0+1$，上游差分是 $U_{i_0+1}-U_{i_0}  0$，下游差分是 $U_{i_0+2}-U_{i_0+1}  0$（假设我们远离另一个极值点）。所以 $r_{i_0+1} > 0$。斜率非零。\n        *   斜率限制器对极值的削峰会降低整体收敛阶。对于 $L_p$ 范数，观察到的阶数通常在 1 和 2 之间。对于 $L_1$ 范数，阶数通常更接近 1。对于 $L_2$ 范数，它通常比 $L_1$ 范数稍高。大约 1.5 的阶数是合理的。我需要更精确地进行“推导”。\n        *   推导：该方法在空间和时间上是形式二阶的。局部截断误差 (LTE) 是 $O(\\Delta x^2, \\Delta t^2)$。然而，在光滑极值点，斜率限制器 $\\phi(r)$ 因为 $r  0$ 而变为零。这迫使重构在包含极值点的单元中是分段常数（一阶）的。该单元中的 LTE 是 $O(\\Delta x)$。$L_p$ 范数下的全局误差与局部误差的总和有关。由于受影响的单元（那些有极值点的单元）数量很少且为常数（对于正弦波是两个），它们的一阶误差贡献是 $O(\\Delta x)$。绝大多数单元具有二阶误差 $O(\\Delta x^2)$。将这些加起来得到全局误差：\n            $E_{L_p} = \\left( \\sum_i (\\text{error}_i)^p \\Delta x \\right)^{1/p}$。\n            让我们考虑 $L_1$ 误差：$E_{L_1} = \\sum_i|\\text{error}_i|\\Delta x$。\n            有 $O(N)$ 个单元的 LTE 是 $O(\\Delta x^2)$，对全局误差的贡献是 $N \\cdot O(\\Delta x^2) \\Delta x = O(N \\Delta x^3) = O(\\Delta x^2)$。\n            有常数数量的单元，比如说 $k$ 个，其 LTE 是 $O(\\Delta x)$，对全局误差的贡献是 $k \\cdot O(\\Delta x) \\Delta x = O(\\Delta x^2)$。\n            这个简单的分析表明，总的阶数应该仍然是 2。\n            这是不正确的。推理有缺陷。单个单元中 $O(\\Delta x)$ 的 LTE 在时间 $T=O(1)$ 内导致的全局误差贡献是 $O(\\Delta x)$。\n            让我们更仔细一点。一个 LTE 为 $O(\\Delta x^k)$ 的单元在一个时间步长后的误差是 $\\Delta t \\times \\text{LTE} = O(\\Delta x^{k+1})$。经过 $N_t = T/\\Delta t = O(1/\\Delta x)$ 步后，误差累积。全局误差是 $O(N_t \\times \\Delta x^k) = O(\\Delta x^{k-1})$。不，这是针对 ODE 的。对于双曲 PDE，误差会传播。\n            $L_1$ 范数中的误差由 $T \\times (\\text{LTE 绝对值之和}) \\times \\Delta x$ 界定。\n            $E_{L_1} \\approx T \\sum_i |\\tau_i| \\Delta x$。\n            对于大多数单元，$\\tau_i = O(\\Delta x^2)$。对于极值点附近的少数单元，$\\tau_i = O(\\Delta x)$。\n            $\\sum_i |\\tau_i| \\Delta x \\approx \\sum_{i \\notin \\text{extrema}} O(\\Delta x^2) \\Delta x + \\sum_{i \\in \\text{extrema}} O(\\Delta x) \\Delta x$\n            $\\approx (N-k) O(\\Delta x^3) + k O(\\Delta x^2) \\approx O(N\\Delta x^3) + O(\\Delta x^2) \\approx O(\\Delta x^2) + O(\\Delta x^2) = O(\\Delta x^2)$。\n            我的分析仍然指向 2。这被认为是错误的。\n            让我们查阅文献。例如，Sweby (1984)，Harten (1983)。在光滑极值点，TVD 格式必然退化到一阶。这是 Harten 定理。这意味着局部误差是 $O(\\Delta t \\Delta x)$。\n            $L_1$ 范数下的全局误差通常是 $O(\\Delta x)$。$L_{\\infty}$ 范数下的误差是 $O(\\Delta x)$。\n            $L_2$ 范数下的误差，其中 $p=2$：阶数是 $O(\\Delta x^{(2+1)/2}) = O(\\Delta x^{1.5})$。这似乎更合理。\n            让我将其形式化。\n            带有 TVD 限制器的 MUSCL 格式在解的光滑、单调部分上是形式二阶空间精度的，这意味着局部截断误差 (LTE) 为 $O(\\Delta x^2)$。然而，在光滑极值点，为了保持 TVD 特性，斜率限制器将重构降为一阶，导致这些单元中的 LTE 为 $O(\\Delta x)$。时间积分是二阶的，所以 $\\Delta t \\sim \\Delta x$，这些标度关系也适用于时空中的完整 LTE。\n            在固定时间 $T$ 的全局误差 $E$ 取决于其测量所用的 $L_p$ 范数。误差是在 $O(1/\\Delta x)$ 个时间步长上局部截断误差的累积。\n            在任何 $L_p$ 范数 ($p \\geq 1$) 中，全局误差 $E_{L_p}$ 可以通过考虑来自绝大多数误差为 $O(\\Delta x^2)$ 的单元和少数（$O(1)$个）在极值点附近误差为 $O(\\Delta x)$ 的单元的贡献来估计。\n            全局误差的 $p$ 次方是：\n            $ E_{L_p}^p = \\Delta x \\sum_{i=1}^N |e_i(T)|^p $。\n            单元 $i$ 中的误差 $e_i(T)$ 是 LTE 的累积。在格式为二阶的单元中，误差为 $O(\\Delta x^2)$。在格式为一阶的单元中，误差为 $O(\\Delta x)$。\n            $E_{L_p}^p \\approx \\Delta x \\left( \\sum_{\\text{2nd-order cells}} |O(\\Delta x^2)|^p + \\sum_{\\text{1st-order cells}} |O(\\Delta x)|^p \\right)$\n            $E_{L_p}^p \\approx \\Delta x \\left( N \\cdot O(\\Delta x^{2p}) + k \\cdot O(\\Delta x^p) \\right)$，其中 $k=O(1)$ 是极值点的数量。\n            由于 $N = 1/\\Delta x$，这变为：\n            $E_{L_p}^p \\approx O(\\Delta x^{-1}) \\cdot O(\\Delta x^{2p+1}) + O(\\Delta x^{p+1}) = O(\\Delta x^{2p}) + O(\\Delta x^{p+1})$。\n            收敛由两个速率中较慢的一个决定。由于 $p \\geq 1$，我们有 $2p \\ge p+1$，所以 $O(\\Delta x^{p+1})$ 项占主导地位（或者在 $p=1$ 时相等）。\n            因此，$E_{L_p}^p \\sim O(\\Delta x^{p+1})$，这意味着 $E_{L_p} \\sim O(\\Delta x^{(p+1)/p})$。\n            对于问题中指定的 $L_2$ 范数，$p=2$。预期的渐近收敛阶因此是 $(2+1)/2 = 1.5$。\n            这似乎是一个坚实的理由。\n\n### 最终解决方案：\n问题是有效的。开始撰写。\n问题是适定的且有科学依据的，代表了计算流体动力学中的一个标准数值分析任务。所有必要的数据和定义都已提供。\n\n### 1. 有限体积离散化\n\n标量守恒律为 $u_t + f(u)_x = 0$，通量为 $f(u)=au$。我们在一个包含 $N$ 个单元的均匀网格上离散此方程，每个单元的宽度为 $\\Delta x = 1/N$。单元中心为 $x_i = (i+1/2)\\Delta x$，其中 $i=0, ..., N-1$。单元 $i$ 中的单元平均值为 $U_i(t)$。单元 $i$ 的半离散有限体积公式为：\n$$\n\\frac{dU_i}{dt} = L(U)_i = -\\frac{1}{\\Delta x} (F_{i+1/2} - F_{i-1/2})\n$$\n其中 $L(U)_i$ 是空间离散化算子，$F_{i\\pm 1/2}$ 是在单元界面 $x_{i\\pm 1/2}$ 处的数值通量。\n\n### 2. MUSCL 重构与数值通量\n\n为了达到二阶空间精度，我们使用 MUSCL（守恒律的单调上游中心格式）在每个单元内重构解的分段线性表示。单元 $i$ 内某点 $x$ 处的解值近似为：\n$$\nu(x) = U_i + s_i(x - x_i)\n$$\n其中 $s_i$ 是单元 $i$ 中的一个限制斜率，以防止伪振荡并确保总变差递减（TVD）特性。\n\n对于具有恒定速度 $a0$ 的线性平流方程，信息从左向右传播。因此，迎风通量是合适的。界面 $x_{i+1/2}$ 处的数值通量由从迎风单元（即单元 $i$）重构的状态决定：\n$$\nF_{i+1/2} = f(U_{i+1/2}^{-}) = a U_{i+1/2}^{-}\n$$\n状态 $U_{i+1/2}^{-}$ 是从单元 $i$ 在其右边界 $x_{i+1/2} = x_i + \\Delta x/2$ 处重构的解的值：\n$$\nU_{i+1/2}^{-} = U_i + s_i \\frac{\\Delta x}{2}\n$$\n限制斜率 $s_i$ 写为 $s_i = \\sigma_i / \\Delta x$，其中 $\\sigma_i$ 是单元 $i$ 的限制差分。状态则为：\n$$\nU_{i+1/2}^{-} = U_i + \\frac{1}{2}\\sigma_i\n$$\n限制差分 $\\sigma_i$ 使用 van Leer 斜率限制器计算。该限制器作用于连续差分的比率，以在一阶和二阶格式之间进行混合。我们定义后向差分 $\\Delta_i^- = U_i - U_{i-1}$ 和前向差分 $\\Delta_i^+ = U_{i+1} - U_i$。单元 $i$ 的连续差分比率为 $r_i = \\Delta_i^+ / \\Delta_i^-$。限制差分 $\\sigma_i$ 则计算如下：\n$$\n\\sigma_i = \\phi(r_i) \\Delta_i^-\n$$\n其中 van Leer 限制器函数给定为 $\\phi(r) = \\frac{r + |r|}{1 + |r|}$。该函数可以简化：对于 $r \\le 0$ 时为 $0$，对于 $r  0$ 时为 $\\frac{2r}{1+r}$。条件 $r \\le 0$ 出现在局部极值点或其附近，限制器在此处正确地将斜率设置为零以避免产生新的极值，从而局部地退化为一阶迎风格式。对于光滑、单调的区域，$r  0$，限制器允许更高阶的斜率。\n\n结合这些元素，界面 $i+1/2$ 处数值通量的完整表达式为：\n$$\nF_{i+1/2} = a \\left( U_i + \\frac{1}{2} \\phi\\left(\\frac{U_{i+1}-U_i}{U_i-U_{i-1}}\\right) (U_i-U_{i-1}) \\right)\n$$\n周期性边界条件用于评估在域边界处的差分。例如，要计算 $\\sigma_0$，我们需要 $U_{-1}$，它被设置为 $U_{N-1}$。\n\n### 3. 时间推进\n\n我们使用两步 TVD 龙格-库塔方法（TVD-RK2）将解从时间 $t^n$ 推进到 $t^{n+1} = t^n + \\Delta t$。该方法在时间上是二阶精度的，并保持空间离散化的 TVD 特性。这两个阶段是：\n$$\n\\begin{align*}\nU^{(1)} = U^n + \\Delta t L(U^n) \\\\\nU^{n+1} = \\frac{1}{2} U^n + \\frac{1}{2} \\left( U^{(1)} + \\Delta t L(U^{(1)}) \\right)\n\\end{align*}\n$$\n其中 $U^n$ 是在时间 $t^n$ 的所有单元平均值 $U_i$ 的向量。时间步长 $\\Delta t$ 由 CFL 条件确定。计算一个临时时间步长 $\\Delta t_{prov} = C \\Delta x / a$。为确保最终时间 $T$ 以整数步数到达，我们计算步数 $N_{steps} = \\lceil T / \\Delta t_{prov} \\rceil$ 并使用调整后的时间步长 $\\Delta t = T / N_{steps}$。\n\n### 4. 误差分析与预期收敛阶\n\n问题要求计算在 $T=1$ 时的离散 $L_2$ 误差。对于 $a=1$，精确解 $u(x,1)=\\sin(2\\pi(x-1))=\\sin(2\\pi x)$ 返回到其初始状态。因此，$T=1$ 时的精确单元平均值与初始值 $U_i(0)$ 相同。误差计算公式为：\n$$\nE_{L_2}(N) = \\left( \\Delta x \\sum_{i=0}^{N-1} \\left( U_i(T) - U_i(0) \\right)^2 \\right)^{1/2}\n$$\n在两个网格 $N_1$ 和 $N_2$ 之间观测到的收敛阶 $p$ 为：\n$$\np(N_1,N_2) = \\frac{\\ln\\left( E_{L_2}(N_1) / E_{L_2}(N_2) \\right)}{\\ln\\left( N_2 / N_1 \\right)}\n$$\n所构建的格式是形式上二阶精度的。然而，符合 TVD 的斜率限制器，包括 van Leer 限制器，在光滑极值点处会将局部精度降低到一阶（Harten 定理）。由于初始条件 $u(x,0)=\\sin(2\\pi x)$ 有一个最大值和一个最小值，因此每个周期有两个单元的局部截断误差（LTE）为 $O(\\Delta x)$，而不是在其他地方达到的 $O(\\Delta x^2)$。\n\n$L_p$ 范数下的全局误差 $E_{L_p}$ 可以通过考虑其对 LTE 的依赖性来分析。经过 $N_{steps} = T/\\Delta t \\sim O(1/\\Delta x)$ 步后的误差标度为：\n$$\nE_{L_p}^p \\approx \\Delta x \\left( \\sum_{\\text{2nd-order cells}} |e_{i}|^p + \\sum_{\\text{1st-order cells}} |e_{i}|^p \\right)\n$$\n假设局部单元误差 $e_i$ 与 LTE 具有相同的标度，则在 $N-k$ 个二阶单元中的误差为 $O(\\Delta x^2)$，在 $k=O(1)$ 个一阶单元中的误差为 $O(\\Delta x)$。\n$$\nE_{L_p}^p \\approx \\Delta x \\left( (N-k) \\cdot (O(\\Delta x^2))^p + k \\cdot (O(\\Delta x))^p \\right)\n$$\n代入 $N = 1/\\Delta x$：\n$$\nE_{L_p}^p \\approx \\Delta x \\left( O(\\Delta x^{-1}) \\cdot O(\\Delta x^{2p}) + O(1) \\cdot O(\\Delta x^p) \\right) = O(\\Delta x^{2p}) + O(\\Delta x^{p+1})\n$$\n对于 $p \\geq 1$，我们有 $2p \\ge p+1$，所以 $O(\\Delta x^{p+1})$ 项是主导项（或在 $p=1$ 时相等）。因此，全局误差的标度为：\n$$\nE_{L_p} \\sim \\left( O(\\Delta x^{p+1}) \\right)^{1/p} = O(\\Delta x^{(p+1)/p})\n$$\n对于 $L_2$ 范数，我们有 $p=2$。因此，预期的渐近收敛阶为 $(2+1)/2 = 1.5$。数值结果应显示，随着网格加密，收敛阶会趋近于此值。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef van_leer_limiter(r: np.ndarray) - np.ndarray:\n    \"\"\"\n    Computes the van Leer limiter function phi(r).\n    phi(r) = (r + |r|) / (1 + |r|)\n    Numerically, this is 0 for r = 0 and 2r / (1+r) for r  0.\n    \"\"\"\n    phi = np.zeros_like(r, dtype=float)\n    mask = r  0\n    r_masked = r[mask]\n    phi[mask] = (2 * r_masked) / (1 + r_masked)\n    return phi\n\ndef calculate_rhs(U: np.ndarray, dx: float, a: float) - np.ndarray:\n    \"\"\"\n    Calculates the right-hand side of the finite-volume semi-discretization\n    using MUSCL reconstruction with a van Leer limiter.\n    L(U)_i = - (F_{i+1/2} - F_{i-1/2}) / dx\n    \"\"\"\n    # Periodic boundary conditions are handled by np.roll\n    U_m1 = np.roll(U, 1)  # Stencil for U_{i-1}\n    U_p1 = np.roll(U, -1) # Stencil for U_{i+1}\n\n    # Differences centered on cell i\n    delta_b = U - U_m1      # U_i - U_{i-1}\n    delta_f = U_p1 - U      # U_{i+1} - U_i\n\n    # Ratio of successive differences, r_i = delta_f_i / delta_b_i\n    # Use a small tolerance to avoid division by zero.\n    # Where denominator is zero, ratio is zero, leading to zero slope correction.\n    r = np.zeros_like(U, dtype=float)\n    denom_is_nonzero = np.abs(delta_b)  1e-12\n    np.divide(delta_f, delta_b, out=r, where=denom_is_nonzero)\n\n    # Calculate limited difference sigma_i for each cell i\n    phi = van_leer_limiter(r)\n    sigma = phi * delta_b\n\n    # Reconstruct the state U at the right-hand interface of each cell i (x_{i+1/2})\n    # U_{i+1/2}^- = U_i + 0.5 * sigma_i\n    U_left_at_interface = U + 0.5 * sigma\n\n    # Numerical flux at interface i+1/2 (upwind for a  0)\n    # F_{i+1/2} = a * U_{i+1/2}^-\n    F = a * U_left_at_interface\n\n    # Flux at interface i-1/2\n    F_m1 = np.roll(F, 1)\n\n    # Compute the RHS of the semi-discrete equation\n    rhs = -(F - F_m1) / dx\n    return rhs\n\ndef solve():\n    \"\"\"\n    Main solver function to run the simulation and compute errors and rates.\n    \"\"\"\n    # Problem parameters\n    a = 1.0\n    C = 0.4\n    T = 1.0\n    N_list = [20, 40, 80, 160]\n\n    errors_l2 = []\n    \n    for N in N_list:\n        # Grid setup\n        dx = 1.0 / N\n        x_interfaces = np.linspace(0.0, 1.0, N + 1)\n        \n        # Initial condition (exact cell averages)\n        U_initial = (np.cos(2 * np.pi * x_interfaces[:-1]) - np.cos(2 * np.pi * x_interfaces[1:])) / (2 * np.pi * dx)\n        U = U_initial.copy()\n\n        # Time step adjustment to hit T exactly\n        dt_provisional = C * dx / a\n        num_steps = int(np.ceil(T / dt_provisional))\n        dt = T / num_steps\n\n        # Time integration using two-stage TVD Runge-Kutta method\n        for _ in range(num_steps):\n            # Stage 1\n            rhs1 = calculate_rhs(U, dx, a)\n            U1 = U + dt * rhs1\n            \n            # Stage 2\n            rhs2 = calculate_rhs(U1, dx, a)\n            U = 0.5 * U + 0.5 * (U1 + dt * rhs2)\n\n        # Compute discrete L2 error at T=1\n        # The exact solution at T=1 is the same as the initial condition\n        error_l2 = np.sqrt(dx * np.sum((U - U_initial)**2))\n        errors_l2.append(error_l2)\n\n    # Compute observed convergence rates\n    rates = []\n    for i in range(len(N_list) - 1):\n        N1 = N_list[i]\n        N2 = N_list[i+1]\n        E1 = errors_l2[i]\n        E2 = errors_l2[i+1]\n        # p = ln(E1/E2) / ln(N2/N1)\n        rate = np.log(E1 / E2) / np.log(N2 / N1)\n        rates.append(rate)\n\n    # Format the final output\n    results = errors_l2 + rates\n    # The print statement must produce only the required output line.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```", "id": "3347636"}]}