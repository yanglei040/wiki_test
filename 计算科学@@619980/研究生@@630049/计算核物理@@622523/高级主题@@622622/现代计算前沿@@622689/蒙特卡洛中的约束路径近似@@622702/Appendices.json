{"hands_on_practices": [{"introduction": "为了掌握约束路径近似的核心，最好的起点是亲手实现一个基础版本。本练习将引导你为一个双点 Hubbard 模型构建一个单步辅助场量子蒙特卡罗 (AFQMC) 投影算符 [@problem_id:3551579]。这个模型是一个理想的“实验室”，因为它足够简单，可以精确求解，使我们能够清晰地观察到约束路径方法引入的系统偏差，并验证当试探波函数包含精确节面时该方法的准确性。", "problem": "考虑一个一维双格点 Hubbard 模型，该模型在自旋旋转下不变，在自旋空间中表现出 2 阶特殊酉群 (SU(2)) 对称性。设格点由 $i \\in \\{1,2\\}$ 标记，自旋由 $\\sigma \\in \\{\\uparrow,\\downarrow\\}$ 标记。哈密顿量为\n$$\n\\hat{H} = \\hat{K} + \\hat{V},\n$$\n其中动能项为\n$$\n\\hat{K} = -t \\sum_{\\sigma} \\left( \\hat{c}_{1\\sigma}^{\\dagger} \\hat{c}_{2\\sigma} + \\hat{c}_{2\\sigma}^{\\dagger} \\hat{c}_{1\\sigma} \\right),\n$$\n在位相互作用项为\n$$\n\\hat{V} = U \\sum_{i=1}^{2} \\hat{n}_{i\\uparrow} \\hat{n}_{i\\downarrow},\n$$\n其中 $t > 0$ 和 $U \\ge 0$，$\\hat{c}_{i\\sigma}^{\\dagger}$ 和 $\\hat{c}_{i\\sigma}$ 分别是费米子产生和湮灭算符，$\\hat{n}_{i\\sigma} = \\hat{c}_{i\\sigma}^{\\dagger} \\hat{c}_{i\\sigma}$ 是粒子数算符。在半填充条件下进行计算，体系包含两个费米子，每个自旋方向各一个。\n\n这个双格点体系在半填充时的基态能量是精确已知的，可以通过在自旋单态子空间中直接对角化得到。将其记为 $E_0(U,t)$。对于该模型，其表达式为：\n$$\nE_0(U,t) = \\frac{U}{2} - \\sqrt{\\left( \\frac{U}{2} \\right)^2 + 4 t^2 }.\n$$\n\n您将实现一个带有约束路径近似的辅助场量子蒙特卡洛 (AFQMC) 投影算法。AFQMC 投影算法使用单个时间片上的 Trotter-Suzuki 分解来近似虚时演化算符：\n$$\ne^{-\\Delta \\tau \\hat{H}} \\approx e^{-\\Delta \\tau \\hat{K}} e^{-\\Delta \\tau \\hat{V}}.\n$$\n相互作用项通过离散的 Hirsch-Hubbard-Stratonovich 变换进行解耦：\n$$\ne^{-\\Delta \\tau U \\hat{n}_{i\\uparrow} \\hat{n}_{i\\downarrow}} = \\frac{1}{2} e^{-\\Delta \\tau U / 2} \\sum_{s_i=\\pm 1} e^{\\lambda s_i (\\hat{n}_{i\\uparrow} - \\hat{n}_{i\\downarrow})},\n$$\n其中 $\\lambda$ 的选择需满足 $\\cosh(\\lambda) = e^{\\Delta \\tau U / 2}$，即：\n$$\n\\lambda = \\operatorname{arccosh}\\left( e^{\\Delta \\tau U / 2} \\right).\n$$\n\n将单体传播子表示为格点基下的 $2 \\times 2$ 矩阵。动能矩阵为\n$$\nK = \\begin{pmatrix} 0  -t \\\\ -t  0 \\end{pmatrix},\n$$\n其单时间片传播子为 $B_K = e^{-\\Delta \\tau K}$ (矩阵指数)。解耦后的相互作用为每个自旋产生一个对角势：\n$$\nD_{\\sigma}(\\mathbf{s}) = \\operatorname{diag}\\left( e^{\\sigma \\lambda s_1}, e^{\\sigma \\lambda s_2} \\right),\n$$\n其中自旋向上为 $\\sigma = +1$，自旋向下为 $\\sigma = -1$，$\\mathbf{s} = (s_1,s_2)$ 表示单个时间片上两个格点的 Hubbard-Stratonovich 伊辛场。\n\n使用由每个自旋的成键轨道构建的试探斯莱特行列式 $|\\Psi_T\\rangle$：\n$$\n|\\phi_T\\rangle = \\frac{1}{\\sqrt{2}} \\begin{pmatrix} 1 \\\\ 1 \\end{pmatrix},\n$$\n因此，每个自旋部分的试探波函数是单粒子态 $|\\phi_T\\rangle$。在无相互作用极限 $U=0$ 下，该试探波函数包含了精确的费米子节点。对于单个时间片，在场构型 $\\mathbf{s}$ 下，自旋 $\\sigma$ 的 walker 轨道经过传播后为：\n$$\n|\\phi_{\\sigma}(\\mathbf{s})\\rangle = B_K \\, D_{\\sigma}(\\mathbf{s}) \\, |\\phi_T\\rangle.\n$$\n\n定义自旋 $\\sigma$ 与试探波函数的交叠为\n$$\nO_{\\sigma}(\\mathbf{s}) = \\langle \\phi_T | \\phi_{\\sigma}(\\mathbf{s}) \\rangle,\n$$\n总交叠为 $O(\\mathbf{s}) = O_{\\uparrow}(\\mathbf{s}) \\, O_{\\downarrow}(\\mathbf{s})$。约束路径近似通过丢弃任何使得 $O(\\mathbf{s}) \\le 0$ 的场构型 $\\mathbf{s}$ 来强制保持试探交叠的符号。\n\n对于每个允许的构型 $\\mathbf{s}$，定义自旋 $\\sigma$ 的混合单体格林函数为\n$$\nG_{\\sigma}(\\mathbf{s}) = \\frac{|\\phi_{\\sigma}(\\mathbf{s})\\rangle \\langle \\phi_T |}{O_{\\sigma}(\\mathbf{s})},\n$$\n由此可得动能的混合估计量\n$$\nE_K(\\mathbf{s}) = \\sum_{\\sigma} \\operatorname{Tr}\\left[ K \\, G_{\\sigma}(\\mathbf{s}) \\right],\n$$\n和相互作用能的混合估计量\n$$\nE_U(\\mathbf{s}) = U \\sum_{i=1}^{2} \\left( G_{\\uparrow}(\\mathbf{s}) \\right)_{ii} \\left( G_{\\downarrow}(\\mathbf{s}) \\right)_{ii}.\n$$\n局域能量为 $E_L(\\mathbf{s}) = E_K(\\mathbf{s}) + E_U(\\mathbf{s})$。\n\n在时间步长为 $\\Delta \\tau$ 的单个时间片上，约束路径能量是允许构型上交叠加权的平均值：\n$$\nE_{\\text{CP}}(\\Delta \\tau) = \\frac{\\sum_{\\mathbf{s} \\in \\mathcal{A}} O(\\mathbf{s}) \\, E_L(\\mathbf{s})}{\\sum_{\\mathbf{s} \\in \\mathcal{A}} O(\\mathbf{s})},\n$$\n其中 $\\mathcal{A}$ 是所有满足 $O(\\mathbf{s}) > 0$ 的 $\\mathbf{s}$ 的集合。Hubbard-Stratonovich 变换中的常数前因子在该比率中被消去，因此无需包含在权重中。\n\n从虚时薛定谔方程以及上述分解和解耦出发，实现算法以计算给定模型的 $E_{\\text{CP}}(\\Delta \\tau)$，并将其与精确基态能量 $E_0(U,t)$ 进行比较。使用以下测试套件，固定 $t=1$ 且使用单个时间片 $L=1$：\n\n- 情况 1 (理想路径，无相互作用，粗时间步)：$U=0$, $\\Delta \\tau = 0.5$。\n- 情况 2 (无相互作用，细时间步)：$U=0$, $\\Delta \\tau = 0.05$。\n- 情况 3 (有相互作用，粗时间步)：$U=4$, $\\Delta \\tau = 0.5$。\n- 情况 4 (有相互作用，中等时间步)：$U=4$, $\\Delta \\tau = 0.2$。\n- 情况 5 (有相互作用，细时间步)：$U=4$, $\\Delta \\tau = 0.05$。\n\n对于每种情况，计算并返回浮点数形式的约束路径能量 $E_{\\text{CP}}(\\Delta \\tau)$。此外，对于情况 1 和 2，返回一个布尔值，指示当试探波函数包含正确节点时，约束路径近似是否精确；即，$|E_{\\text{CP}}(\\Delta \\tau) - E_0(U,t)|  10^{-10}$ 是否成立。\n\n最终输出格式：您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表。该列表必须按此顺序包含七个条目：\n$$\n\\left[ E_{\\text{CP}}(0.5; U{=}0), E_{\\text{CP}}(0.05; U{=}0), E_{\\text{CP}}(0.5; U{=}4), E_{\\text{CP}}(0.2; U{=}4), E_{\\text{CP}}(0.05; U{=}4), \\text{ExactCase1}, \\text{ExactCase2} \\right],\n$$\n其中最后两个是布尔值。能量值不需要物理单位。", "solution": "### 第 1 步：提取给定信息\n问题为一维双格点 Hubbard 模型在半填充（两个费米子，一个自旋向上，一个自旋向下）情况下提供了以下数据和定义：\n\n1.  **哈密顿量**: $\\hat{H} = \\hat{K} + \\hat{V}$\n    *   动能项: $\\hat{K} = -t \\sum_{\\sigma} \\left( \\hat{c}_{1\\sigma}^{\\dagger} \\hat{c}_{2\\sigma} + \\hat{c}_{2\\sigma}^{\\dagger} \\hat{c}_{1\\sigma} \\right)$\n    *   相互作用项: $\\hat{V} = U \\sum_{i=1}^{2} \\hat{n}_{i\\uparrow} \\hat{n}_{i\\downarrow}$\n    *   参数: $t  0$, $U \\ge 0$。\n\n2.  **精确基态能量**: $E_0(U,t) = \\frac{U}{2} - \\sqrt{\\left( \\frac{U}{2} \\right)^2 + 4 t^2 }$.\n\n3.  **AFQMC 投影（单个时间片 $\\Delta \\tau$）**:\n    *   Trotter-Suzuki 分解: $e^{-\\Delta \\tau \\hat{H}} \\approx e^{-\\Delta \\tau \\hat{K}} e^{-\\Delta \\tau \\hat{V}}$。\n    *   相互作用项的离散 Hirsch-Hubbard-Stratonovich 变换:\n        $$\n        e^{-\\Delta \\tau U \\hat{n}_{i\\uparrow} \\hat{n}_{i\\downarrow}} = \\frac{1}{2} e^{-\\Delta \\tau U / 2} \\sum_{s_i=\\pm 1} e^{\\lambda s_i (\\hat{n}_{i\\uparrow} - \\hat{n}_{i\\downarrow})}\n        $$\n    *   Hubbard-Stratonovich 参数: $\\lambda = \\operatorname{arccosh}\\left( e^{\\Delta \\tau U / 2} \\right)$。\n\n4.  **单体表示（格点基）**:\n    *   动能矩阵: $K = \\begin{pmatrix} 0  -t \\\\ -t  0 \\end{pmatrix}$。\n    *   动能传播子: $B_K = e^{-\\Delta \\tau K}$ (矩阵指数)。\n    *   相互作用势矩阵（对于 HS 场 $\\mathbf{s} = (s_1, s_2)$ 和自旋 $\\sigma$）:\n        $$\n        D_{\\sigma}(\\mathbf{s}) = \\operatorname{diag}\\left( e^{\\sigma \\lambda s_1}, e^{\\sigma \\lambda s_2} \\right)\n        $$\n        其中自旋向上为 $\\sigma = +1$，自旋向下为 $\\sigma = -1$。\n\n5.  **试探波函数和传播**:\n    *   试探轨道（对每个自旋）: $|\\phi_T\\rangle = \\frac{1}{\\sqrt{2}} \\begin{pmatrix} 1 \\\\ 1 \\end{pmatrix}$。\n    *   传播后的 walker 轨道: $|\\phi_{\\sigma}(\\mathbf{s})\\rangle = B_K \\, D_{\\sigma}(\\mathbf{s}) \\, |\\phi_T\\rangle$。\n\n6.  **可观测量和约束**:\n    *   自旋分辨交叠: $O_{\\sigma}(\\mathbf{s}) = \\langle \\phi_T | \\phi_{\\sigma}(\\mathbf{s}) \\rangle$。\n    *   总交叠: $O(\\mathbf{s}) = O_{\\uparrow}(\\mathbf{s}) \\, O_{\\downarrow}(\\mathbf{s})$。\n    *   约束路径条件: 保留构型 $\\mathbf{s}$，其中 $O(\\mathbf{s})  0$。\n    *   混合单体格林函数: $G_{\\sigma}(\\mathbf{s}) = \\frac{|\\phi_{\\sigma}(\\mathbf{s})\\rangle \\langle \\phi_T |}{O_{\\sigma}(\\mathbf{s})}$。\n    *   混合动能估计量: $E_K(\\mathbf{s}) = \\sum_{\\sigma} \\operatorname{Tr}\\left[ K \\, G_{\\sigma}(\\mathbf{s}) \\right]$。\n    *   混合相互作用能估计量: $E_U(\\mathbf{s}) = U \\sum_{i=1}^{2} \\left( G_{\\uparrow}(\\mathbf{s}) \\right)_{ii} \\left( G_{\\downarrow}(\\mathbf{s}) \\right)_{ii}$。\n    *   局域能量: $E_L(\\mathbf{s}) = E_K(\\mathbf{s}) + E_U(\\mathbf{s})$。\n\n7.  **最终约束路径能量**:\n    *   $E_{\\text{CP}}(\\Delta \\tau) = \\frac{\\sum_{\\mathbf{s} \\in \\mathcal{A}} O(\\mathbf{s}) \\, E_L(\\mathbf{s})}{\\sum_{\\mathbf{s} \\in \\mathcal{A}} O(\\mathbf{s})}$，其中 $\\mathcal{A} = \\{\\mathbf{s} | O(\\mathbf{s})  0\\}$。HS 变换的常数前因子被消去，可以忽略。\n\n8.  **测试套件**: 固定 $t=1$，单个时间片。\n    *   情况 1: $U=0$, $\\Delta \\tau = 0.5$。\n    *   情况 2: $U=0$, $\\Delta \\tau = 0.05$。\n    *   情况 3: $U=4$, $\\Delta \\tau = 0.5$。\n    *   情况 4: $U=4$, $\\Delta \\tau = 0.2$。\n    *   情况 5: $U=4$, $\\Delta \\tau = 0.05$。\n    *   对于情况 1 和 2，还需返回一个布尔值，用于判断 $|E_{\\text{CP}}(\\Delta \\tau) - E_0(U,t)|  10^{-10}$。\n\n### 第 2 步：使用提取的信息进行验证\n1.  **科学依据**: 该问题牢固地植根于标准的多体量子力学和计算物理学。Hubbard 模型、辅助场量子蒙特卡洛 (AFQMC)、Trotter-Suzuki 分解和 Hirsch-Hubbard-Stratonovich 变换都是该领域的基石概念。所提供的方程是这些概念在指定模型下的正确表示。双格点 Hubbard 模型的精确解是一个众所周知的基准。\n2.  **良构性**: 该问题是良构的。它要求为一个确定性算法计算一个特定量 $E_{\\text{CP}}(\\Delta \\tau)$。由于系统只有两个格点，对 Hubbard-Stratonovich 场 $\\mathbf{s}$ 的求和不是蒙特卡洛抽样，而是对 $2^2=4$ 种构型的精确枚举。所有必需的公式、参数和初始状态都已明确提供，从而为每个测试用例得出一个唯一的、可计算的解。\n3.  **客观性**: 该问题以精确、客观的数学语言陈述，没有歧义或主观论断。\n4.  **完整性和一致性**: 该问题是自洽的。它提供了计算所需的所有组件，从哈密顿量到最终的能量公式。没有缺失的定义或矛盾的约束。\n5.  **相关性**: 该问题直接切中*计算核物理*（以及更广泛的计算量子物理）领域内*蒙特卡洛中的约束路径近似*这一主题。\n\n该问题没有表现出任何科学上不健全、信息缺失或模棱两可等缺陷。\n\n### 第 3 步：结论和行动\n问题有效。将提供完整解答。\n\n### 基于原理的设计和解答\n核心任务是计算单个虚时间步的约束路径能量估计量 $E_{\\text{CP}}(\\Delta \\tau)$。这涉及到对所有可能的辅助场构型 $\\mathbf{s}$ 上的局域能量 $E_L(\\mathbf{s})$ 进行平均，并以其相应的交叠 $O(\\mathbf{s})$ 作为权重。该计算是确定性的，因为我们对整个辅助场空间进行求和，这个空间很小（$2^2 = 4$ 种构型）。\n\n对于每个测试用例 $(U, \\Delta\\tau)$，算法流程如下：\n\n1.  **初始化**: 定义模型的物理参数。跃迁强度固定为 $t=1$。构建单体动能矩阵 $K$ 和试探轨道 $|\\phi_T\\rangle$。$|\\phi_T\\rangle$ 是无相互作用系统（$U=0$）的基态，即成键轨道。\n    $$\n    K = \\begin{pmatrix} 0  -1 \\\\ -1  0 \\end{pmatrix}, \\quad |\\phi_T\\rangle = \\frac{1}{\\sqrt{2}} \\begin{pmatrix} 1 \\\\ 1 \\end{pmatrix}\n    $$\n\n2.  **计算与步长相关的参数**:\n    *   Hubbard-Stratonovich 参数 $\\lambda$ 同时依赖于 $U$ 和 $\\Delta\\tau$。当 $U=0$ 时，我们有 $e^{\\Delta \\tau U / 2} = 1$，且 $\\lambda = \\operatorname{arccosh}(1) = 0$，这正确地消除了传播子中的相互作用部分。当 $U  0$ 时，$\\lambda  0$。\n    *   单体动能传播子 $B_K$ 是 $-\\Delta\\tau K$ 的矩阵指数。这可以通过数值或解析方法计算。解析地，对于 $K=\\begin{pmatrix} 0  -t \\\\ -t  0 \\end{pmatrix}$，$B_K = e^{-\\Delta\\tau K} = \\begin{pmatrix} \\cosh(\\Delta\\tau t)  \\sinh(\\Delta\\tau t) \\\\ \\sinh(\\Delta\\tau t)  \\cosh(\\Delta\\tau t) \\end{pmatrix}$。\n\n3.  **遍历辅助场**: 计算需要对离散 Hubbard-Stratonovich 场 $\\mathbf{s} = (s_1, s_2)$ 的所有四种可能构型进行求和，其中 $s_i \\in \\{+1, -1\\}$。构型集合为 $\\{(1,1), (1,-1), (-1,1), (-1,-1)\\}$。对于每种构型 $\\mathbf{s}$：\n\n    a.  **构建相互作用传播子**: 对于自旋 $\\sigma=+1$（上）和 $\\sigma=-1$（下），定义对角矩阵 $D_{\\sigma}(\\mathbf{s})$，它们表示给定场构型下相互作用项的作用。\n        $$\n        D_{\\uparrow}(\\mathbf{s}) = \\operatorname{diag}(e^{\\lambda s_1}, e^{\\lambda s_2}), \\quad D_{\\downarrow}(\\mathbf{s}) = \\operatorname{diag}(e^{-\\lambda s_1}, e^{-\\lambda s_2})\n        $$\n\n    b.  **传播 walker 并计算交叠**: 试探轨道 $|\\phi_T\\rangle$ 在动能项和特定相互作用构型 $\\mathbf{s}$ 的影响下，在虚时中向前传播一步。\n        $$\n        |\\phi_{\\sigma}(\\mathbf{s})\\rangle = B_K D_{\\sigma}(\\mathbf{s}) |\\phi_T\\rangle\n        $$\n        对每个自旋，计算这个传播后的 walker 与原始试探波函数的交叠，$O_{\\sigma}(\\mathbf{s}) = \\langle \\phi_T |\\phi_{\\sigma}(\\mathbf{s})\\rangle$。总交叠权重是乘积 $O(\\mathbf{s}) = O_{\\uparrow}(\\mathbf{s}) O_{\\downarrow}(\\mathbf{s})$。因为我们的试探轨道是成键轨道（所有分量均为正），并且传播子 $B_K$ 和 $D_\\sigma$ 由正指数函数构成，所以得到的传播后 walker $|\\phi_{\\sigma}(\\mathbf{s})\\rangle$ 的所有分量也将是正的。因此，交叠 $O(\\mathbf{s})$ 将始终为正。约束路径条件 $O(\\mathbf{s})  0$ 总是满足的，允许的构型集合 $\\mathcal{A}$ 包含所有四种可能性。\n\n    c.  **计算局域能量**: 如果构型是允许的（此处所有构型都允许），则计算局域能量 $E_L(\\mathbf{s})$。这首先需要混合单体格林函数：\n        $$\n        G_{\\sigma}(\\mathbf{s}) = \\frac{|\\phi_{\\sigma}(\\mathbf{s})\\rangle \\langle \\phi_T |}{O_{\\sigma}(\\mathbf{s})}\n        $$\n        由此，可以找到动能和势能的估计量：\n        $$\n        E_K(\\mathbf{s}) = \\operatorname{Tr}[K G_{\\uparrow}(\\mathbf{s})] + \\operatorname{Tr}[K G_{\\downarrow}(\\mathbf{s})]\n        $$\n        $$\n        E_U(\\mathbf{s}) = U \\left( (G_{\\uparrow}(\\mathbf{s}))_{11} (G_{\\downarrow}(\\mathbf{s}))_{11} + (G_{\\uparrow}(\\mathbf{s}))_{22} (G_{\\downarrow}(\\mathbf{s}))_{22} \\right)\n        $$\n        总局域能量为 $E_L(\\mathbf{s}) = E_K(\\mathbf{s}) + E_U(\\mathbf{s})$。\n\n    d.  **累加结果**: 将加权能量 $O(\\mathbf{s}) E_L(\\mathbf{s})$ 和权重 $O(\\mathbf{s})$ 加到运行总和中。\n\n4.  **最终能量计算**: 遍历所有四个场构型后，最终的约束路径能量计算为累加和的比率：\n    $$\n    E_{\\text{CP}}(\\Delta \\tau) = \\frac{\\sum_{\\mathbf{s}} O(\\mathbf{s}) E_L(\\mathbf{s})}{\\sum_{\\mathbf{s}} O(\\mathbf{s})}\n    $$\n\n5.  **特殊情况分析 ($U=0$)**: 对于无相互作用情况（$U=0$），我们得到 $\\lambda=0$。这使得 $D_{\\sigma}(\\mathbf{s})$ 对所有 $\\mathbf{s}$ 都成为单位矩阵。walker 的传播变得与 $\\mathbf{s}$ 无关，局域能量 $E_L$ 对所有构型都是常数。由于 $|\\phi_T\\rangle$ 是 $K$ 的本征态，本征值为 $-t$，因此这个粒子-空穴对称的试探波函数是无相互作用哈密顿量 $\\hat{K}$ 的本征态，能量为 $2 \\times (-t) = -2t$。当试探态是哈密顿量的本征态时，混合估计量形式会得到精确的本征值。因此，对于 $U=0$ 和 $t=1$，我们期望 $E_{\\text{CP}} = -2$。这与精确基态能量 $E_0(0,1) = -2$ 相符。因此，检查 $|E_{\\text{CP}} - E_0|  10^{-10}$ 应为真，这反映了当试探波函数具有基态的正确节点时（对于 $U=0$ 的情况正是如此），约束路径近似是精确的。在这种特殊情况下，Trotter 误差也消失了，因为 $|\\phi_T\\rangle$ 是 $\\hat{K}$ 的一个本征态。\n\n实现将精确地遵循为每个测试用例提供的这些步骤。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import expm\n\ndef solve():\n    \"\"\"\n    Computes the single-slice constrained-path AFQMC energy for a two-site Hubbard model.\n    \"\"\"\n    \n    test_cases = [\n        # (U, delta_tau)\n        (0.0, 0.5), # Case 1\n        (0.0, 0.05), # Case 2\n        (4.0, 0.5), # Case 3\n        (4.0, 0.2), # Case 4\n        (4.0, 0.05), # Case 5\n    ]\n\n    results_ecp = []\n\n    for U, dtau in test_cases:\n        t = 1.0\n        \n        # Define matrices and trial wavefunction\n        K = np.array([[0, -t], \n                      [-t, 0]])\n        phi_T = (1.0 / np.sqrt(2.0)) * np.array([1.0, 1.0])\n\n        # Calculate step-dependent parameters\n        arg_arccosh = np.exp(dtau * U / 2.0)\n        if np.isclose(arg_arccosh, 1.0):\n            lambda_val = 0.0\n        else:\n            lambda_val = np.arccosh(arg_arccosh)\n        \n        # Kinetic propagator matrix\n        B_K = expm(-dtau * K)\n\n        total_weight = 0.0\n        total_energy_times_weight = 0.0\n\n        # Iterate over all 2^2 = 4 auxiliary field configurations\n        s_fields = [(1, 1), (1, -1), (-1, 1), (-1, -1)]\n        \n        for s1, s2 in s_fields:\n            s = np.array([s1, s2])\n\n            # 1. Construct interaction propagators D_sigma(s)\n            D_up = np.diag(np.exp(lambda_val * s))\n            D_dn = np.diag(np.exp(-lambda_val * s))\n\n            # 2. Propagate walkers\n            phi_up_s = B_K @ D_up @ phi_T\n            phi_dn_s = B_K @ D_dn @ phi_T\n            \n            # 3. Compute overlaps\n            O_up_s = phi_T.T @ phi_up_s\n            O_dn_s = phi_T.T @ phi_dn_s\n            O_s = O_up_s * O_dn_s\n            \n            # 4. Constrained-path approximation check\n            if O_s = 0:\n                continue\n\n            # 5. Compute Green's functions\n            G_up = np.outer(phi_up_s, phi_T) / O_up_s\n            G_dn = np.outer(phi_dn_s, phi_T) / O_dn_s\n\n            # 6. Compute local energy\n            E_k_s = np.trace(K @ G_up) + np.trace(K @ G_dn)\n            E_u_s = U * np.dot(np.diag(G_up), np.diag(G_dn))\n            E_L_s = E_k_s + E_u_s\n\n            # 7. Accumulate weighted values\n            total_energy_times_weight += E_L_s * O_s\n            total_weight += O_s\n        \n        E_cp = total_energy_times_weight / total_weight\n        results_ecp.append(E_cp)\n\n    # Post-processing for boolean checks\n    t = 1.0\n    U_case1, _ = test_cases[0]\n    U_case2, _ = test_cases[1]\n    \n    E0_case1 = 0.5 * U_case1 - np.sqrt((0.5 * U_case1)**2 + 4 * t**2)\n    E0_case2 = 0.5 * U_case2 - np.sqrt((0.5 * U_case2)**2 + 4 * t**2)\n    \n    is_exact1 = np.abs(results_ecp[0] - E0_case1)  1e-10\n    is_exact2 = np.abs(results_ecp[1] - E0_case2)  1e-10\n\n    results_bool = [is_exact1, is_exact2]\n\n    # Format the final output as specified\n    output_values = results_ecp + results_bool\n    print(f\"[{output_values[0]},{output_values[1]},{output_values[2]},{output_values[3]},{output_values[4]},{str(output_values[5]).lower()},{str(output_values[6]).lower()}]\")\n\nsolve()\n```", "id": "3551579"}, {"introduction": "在理解了约束路径的基本机制后，下一步是学习如何优化它以获得最佳结果。约束虽然是解决符号问题的必要手段，但它本身是一种近似，会引入偏差。本练习探讨了约束路径的一个变体——无相近似，并引入一个由指数 $\\gamma$ 控制的“软”约束 [@problem_id:3551580]。你将通过量化均方误差 ($\\mathrm{MSE}$) 来探索偏差与方差之间的权衡，并找到最优的 $\\gamma$ 值，这是在实践中优化量子蒙特卡罗算法的关键一步。", "problem": "考虑一个用于计算核物理的辅助场量子蒙特卡洛 (AFQMC) 中约束路径近似的简化模型，其中一组独立的随机行走子带有一个与所选试探波函数的交叠相位。设行走子-试探波函数交叠相位由角度 $\\,\\Delta \\theta \\in [-\\pi,\\pi]\\,$（以弧度为单位）表示，并定义 $\\,c=\\cos \\Delta \\theta\\,$. 施加于每个行走子的软约束权重定义为 $\\,w(c;\\gamma)=\\max(0,c)^\\gamma\\,$, 其中 $\\,\\gamma \\ge 0\\,$ 是一个可调指数。目标是通过直方图 $\\,P(c)\\,$ 来诊断 $\\,c\\,$ 的分布，然后调节 $\\,\\gamma\\,$ 以在标量可观测量的一个加权比率估计量中平衡偏差和方差。\n\n基本和核心定义：\n- 在带有约束路径或无相位近似的 AFQMC 中，复数交叠会引起相位涨落 $\\,\\Delta \\theta\\,$, 且 $\\,c=\\cos \\Delta \\theta\\,$ 编码了其真实投影。约束路径软权重 $\\,w(c;\\gamma)\\,$ 通过抑制 $\\,c\\,$ 值较小或为负的贡献来控制方差，但代价是引入偏差。\n- 一个用于标量可观测量 $\\,\\mu\\,$ 的标准蒙特卡洛加权比率估计量使用 $\\,\\hat{\\mu}(\\gamma)=\\dfrac{\\sum_{i=1}^N w_i(\\gamma)L_i}{\\sum_{i=1}^N w_i(\\gamma)}\\,$, 其中 $\\,L_i\\,$ 是每个行走子的局域能量估计值。对于大的 $\\,N\\,$ 和独立的行走子，$\\,\\hat{\\mu}(\\gamma)\\,$ 集中在 $\\,\\dfrac{\\mathbb{E}[w L]}{\\mathbb{E}[w]}\\,$ 附近，并允许使用由 $\\,\\mathrm{Var}(w L)\\,$, $\\,\\mathrm{Var}(w)\\,$ 和 $\\,\\mathrm{Cov}(w L, w)\\,$ 构建的 delta 方法进行方差近似。\n- 为使问题自洽且纯数学化，假设一个生成模型，其中局域能量与 $\\,c\\,$ 线性相关，并具有独立的加性噪声：$\\,L=\\mu+\\kappa_L c+\\eta\\,$, 其中 $\\,\\eta\\,$ 是一个均值为零、方差为 $\\,\\sigma^2\\,$ 且独立于 $\\,c\\,$ 的噪声项。\n\n需要实现的任务：\n1. 对每个测试用例，生成 $\\,N\\,$ 个独立的 $\\,\\Delta \\theta\\,$ 样本（以弧度为单位），计算 $\\,c=\\cos \\Delta \\theta\\,$，并使用 $\\,M\\,$ 个等距的区间在 $\\,[-1,1]\\,$ 区间上构建一个归一化的直方图 $\\,P(c)\\,$。该直方图必须产生离散的区间中心 $\\,\\{c_j\\}_{j=1}^M\\,$ 和概率 $\\,\\{p_j\\}_{j=1}^M\\,$，且满足 $\\,\\sum_{j=1}^M p_j=1\\,$。\n2. 对于一个 $\\,\\gamma\\,$ 值的网格，仅使用基于直方图的矩近似来计算比率估计量的偏差和方差。对于任意固定的 $\\,\\gamma\\,$ 和使用离散分布 $\\,\\{(c_j,p_j)\\}\\,$，定义\n   $$w_j(\\gamma)=\\max(0,c_j)^\\gamma,\\quad \\mathbb{E}[w]=\\sum_{j=1}^M p_j\\,w_j,\\quad \\mathbb{E}[wc]=\\sum_{j=1}^M p_j\\,w_j\\,c_j,$$\n   $$\\mathbb{E}[wL]=\\mu\\,\\mathbb{E}[w]+\\kappa_L\\,\\mathbb{E}[wc],$$\n   $$\\mathbb{E}[w^2]=\\sum_{j=1}^M p_j\\,w_j^2,\\quad \\mathbb{E}[w^2L]=\\sum_{j=1}^M p_j\\,w_j^2\\left(\\mu+\\kappa_L c_j\\right),$$\n   $$\\mathbb{E}[w^2L^2]=\\sum_{j=1}^M p_j\\,w_j^2\\left[\\left(\\mu+\\kappa_L c_j\\right)^2+\\sigma^2\\right].$$\n   那么偏差和方差的近似值为\n   $$\\mathrm{bias}(\\gamma)=\\frac{\\mathbb{E}[wL]}{\\mathbb{E}[w]}-\\mu=\\kappa_L\\frac{\\mathbb{E}[wc]}{\\mathbb{E}[w]},$$\n   $$\\mathrm{Var}(wL)=\\mathbb{E}[w^2L^2]-\\left(\\mathbb{E}[wL]\\right)^2,\\quad \\mathrm{Var}(w)=\\mathbb{E}[w^2]-\\left(\\mathbb{E}[w]\\right)^2,$$\n   $$\\mathrm{Cov}(wL,w)=\\mathbb{E}[w^2L]-\\mathbb{E}[wL]\\,\\mathbb{E}[w].$$\n   使用比率估计量的 delta 方法，其中 $\\,A=\\frac{1}{N}\\sum w_i L_i\\,$ 且 $\\,B=\\frac{1}{N}\\sum w_i\\,$，且 $\\,a=\\mathbb{E}[wL]\\,$ 和 $\\,b=\\mathbb{E}[w]\\,$，方差近似为\n   $$\\mathrm{Var}\\left(\\hat{\\mu}(\\gamma)\\right)\\approx \\frac{1}{N}\\left[\\frac{\\mathrm{Var}(wL)}{b^2}+\\frac{a^2}{b^4}\\mathrm{Var}(w)-\\frac{2a}{b^3}\\mathrm{Cov}(wL,w)\\right].$$\n   则均方误差为\n   $$\\mathrm{MSE}(\\gamma)=\\left[\\mathrm{bias}(\\gamma)\\right]^2+\\mathrm{Var}\\left(\\hat{\\mu}(\\gamma)\\right).$$\n3. 对于每个测试用例，在指定的网格上扫描 $\\,\\gamma\\,$，并选择使 $\\,\\mathrm{MSE}(\\gamma)\\,$ 最小化的值。如果在数值精度范围内，有多个 $\\,\\gamma\\,$ 值产生相同的最小 $\\,\\mathrm{MSE}(\\gamma)\\,$, 则选择其中最小的 $\\,\\gamma\\,$ 值。\n4. 角度必须以弧度处理。输出无需报告物理单位，但最终的 $\\,\\gamma\\,$ 值必须表示为四舍五入到两位小数的浮点数。\n\n测试套件和参数：\n- 用例 $\\,1\\,$ (理想情况，中等集中的相位)：$\\,N=200000\\,$ 个行走子；$\\,\\Delta \\theta\\,$ 从均值为 $\\,0\\,$、集中度为 $\\,\\kappa_\\theta=8.0\\,$ 的 von Mises 分布中采样；$\\,\\mu=1.5\\,$；$\\,\\kappa_L=0.8\\,$；$\\,\\sigma=0.7\\,$；$\\,M=200\\,$ 个区间；$\\,\\gamma\\,$ 从 $\\,0.0\\,$ 到 $\\,6.0\\,$ 扫描，步长为 $\\,0.25\\,$。\n- 用例 $\\,2\\,$ (边缘情况，均匀相位)：$\\,N=200000\\,$ 个行走子；$\\,\\Delta \\theta\\,$ 在 $\\,[-\\pi,\\pi]\\,$ 上均匀分布；$\\,\\mu=0.0\\,$；$\\,\\kappa_L=0.5\\,$；$\\,\\sigma=1.5\\,$；$\\,M=200\\,$ 个区间；$\\,\\gamma\\,$ 从 $\\,0.0\\,$ 到 $\\,6.0\\,$ 扫描，步长为 $\\,0.25\\,$。\n- 用例 $\\,3\\,$ (高噪声，弱相关)：$\\,N=200000\\,$ 个行走子；$\\,\\Delta \\theta\\,$ 从均值为 $\\,0\\,$、集中度为 $\\,\\kappa_\\theta=1.5\\,$ 的 von Mises 分布中采样；$\\,\\mu=2.0\\,$；$\\,\\kappa_L=0.3\\,$；$\\,\\sigma=3.0\\,$；$\\,M=200\\,$ 个区间；$\\,\\gamma\\,$ 从 $\\,0.0\\,$ 到 $\\,6.0\\,$ 扫描，步长为 $\\,0.25\\,$。\n- 用例 $\\,4\\,$ (符号挑战性相关)：$\\,N=200000\\,$ 个行走子；$\\,\\Delta \\theta\\,$ 在 $\\,[-\\pi,\\pi]\\,$ 上均匀分布；$\\,\\mu=-1.0\\,$；$\\,\\kappa_L=-0.6\\,$；$\\,\\sigma=1.0\\,$；$\\,M=200\\,$ 个区间；$\\,\\gamma\\,$ 从 $\\,0.0\\,$ 到 $\\,6.0\\,$ 扫描，步长为 $\\,0.25\\,$。\n\n最终输出规格：\n你的程序应生成单行输出，其中包含四个测试用例的最优指数 $\\,\\gamma^\\star\\,$，形式为用方括号括起来的逗号分隔列表，每个值四舍五入到两位小数，例如 $\\,\\left[\\gamma^\\star_1,\\gamma^\\star_2,\\gamma^\\star_3,\\gamma^\\star_4\\right]\\,$. 输出中没有物理单位。", "solution": "该问题要求在一个简化的辅助场量子蒙特卡洛 (AFQMC) 模型中，找到最优的软约束指数 $\\,\\gamma^\\star\\,$, 以最小化标量可观测量的加权比率估计量的均方误差 (MSE)。MSE 代表总误差，它结合了估计量的偏差平方和方差。优化过程涉及一个权衡：增加 $\\,\\gamma\\,$ 通常通过抑制噪声贡献来减少方差，但可能会引入系统性偏差。\n\n对于每个测试用例，解决方案按照规定的任务系统地进行：\n1.  生成基础统计分布。\n2.  使用离散直方图表示法计算统计矩。\n3.  为一系列 $\\,\\gamma\\,$ 值计算偏差、方差和 MSE。\n4.  确定使 MSE 最小化的最优 $\\,\\gamma^\\star\\,$。\n\n**第 1 步：模拟与直方图构建**\n\n第一步是为行走子-试探波函数交叠投影 $\\,c = \\cos \\Delta \\theta\\,$ 的分布建模。对每个测试用例，我们从其指定的分布（von Mises 分布或均匀分布）中生成 $\\,N\\,$ 个相角 $\\,\\Delta \\theta\\,$ 的样本。\n- 对于均值为 $\\,\\mu_\\theta=0\\,$、集中度为 $\\,\\kappa_\\theta\\,$ 的 von Mises 分布，从 $\\,\\mathrm{VM}(0, \\kappa_\\theta)\\,$ 中抽取样本。\n- 对于均匀分布，从 $\\,\\mathrm{Unif}[-\\pi, \\pi]\\,$ 中抽取样本。\n\n由这 $\\,N\\,$ 个 $\\,\\Delta \\theta_i\\,$ 样本，我们计算出 $\\,c_i = \\cos \\Delta \\theta_i\\,$。为了使用 $\\,c\\,$ 的概率分布（记为 $\\,P(c)\\,$）的离散表示，我们构建一个归一化直方图。区间 $\\,[-1, 1]\\,$ 被划分为 $\\,M\\,$ 个等距的区间。该直方图产生一组区间中心 $\\,\\{c_j\\}_{j=1}^M\\,$ 及其对应的概率 $\\,\\{p_j\\}_{j=1}^M\\,$。概率 $\\,p_j\\,$ 是落入第 $\\,j\\,$ 个区间的样本数占总样本数 $\\,N\\,$ 的比例。根据构造，$\\,\\sum_{j=1}^M p_j = 1\\,$。\n\n**第 2 步：基于直方图的矩计算**\n\n分析的核心依赖于使用离散概率分布 $\\,\\{(c_j, p_j)\\}_{j=1}^M\\,$ 计算各种期望值（矩）。这些矩是指数 $\\,\\gamma\\,$ 的函数。每个区间中心 $\\,c_j\\,$ 的软约束权重定义为 $\\,w_j(\\gamma) = \\max(0, c_j)^\\gamma\\,$。注意，当 $\\,\\gamma=0\\,$ 时，使用约定 $\\,0^0=1\\,$，使得对所有 $\\,j\\,$ 都有 $\\,w_j(0) = 1\\,$。\n\n使用离散分布，任何期望 $\\,\\mathbb{E}[f(c)]\\,$ 都可通过求和 $\\,\\sum_{j=1}^M p_j f(c_j)\\,$ 来近似。我们计算偏差和方差公式所需的以下矩：\n- $\\,\\mathbb{E}[w] = \\sum_{j=1}^M p_j w_j(\\gamma)\\,$\n- $\\,\\mathbb{E}[wc] = \\sum_{j=1}^M p_j w_j(\\gamma) c_j\\,$\n- $\\,\\mathbb{E}[w^2] = \\sum_{j=1}^M p_j \\left(w_j(\\gamma)\\right)^2\\,$\n\n局域能量 $\\,L\\,$ 被建模为 $\\,L = \\mu + \\kappa_L c + \\eta\\,$，其中 $\\,\\eta\\,$ 是独立噪声，满足 $\\,\\mathbb{E}[\\eta]=0\\,$ 和 $\\,\\mathbb{E}[\\eta^2]=\\sigma^2\\,$。涉及 $\\,L\\,$ 的矩是通过利用 $\\,\\eta\\,$ 与 $\\,c\\,$（因此也与 $\\,w\\,$）的独立性来推导的：\n- $\\,\\mathbb{E}[wL] = \\mathbb{E}[w(\\mu + \\kappa_L c + \\eta)] = \\mu\\mathbb{E}[w] + \\kappa_L\\mathbb{E}[wc] + \\mathbb{E}[w]\\mathbb{E}[\\eta] = \\mu\\mathbb{E}[w] + \\kappa_L\\mathbb{E}[wc]\\,$.\n- $\\,\\mathbb{E}[w^2L] = \\mathbb{E}[w^2(\\mu + \\kappa_L c + \\eta)] = \\mu\\mathbb{E}[w^2] + \\kappa_L\\mathbb{E}[w^2c]\\,$, 其中 $\\,\\mathbb{E}[w^2c] = \\sum_{j=1}^M p_j (w_j(\\gamma))^2 c_j\\,$.\n- $\\,\\mathbb{E}[w^2L^2] = \\mathbb{E}[w^2(\\mu + \\kappa_L c + \\eta)^2] = \\mathbb{E}[w^2((\\mu + \\kappa_L c)^2 + 2\\eta(\\mu+\\kappa_L c) + \\eta^2)]\\,$. 取期望并使用 $\\,\\mathbb{E}[\\eta]=0\\,$ 将其简化为 $\\,\\mathbb{E}[w^2((\\mu + \\kappa_L c)^2 + \\sigma^2)]\\,$. 在我们的离散形式中，这变为 $\\,\\mathbb{E}[w^2L^2] = \\sum_{j=1}^M p_j (w_j(\\gamma))^2 \\left[ (\\mu + \\kappa_L c_j)^2 + \\sigma^2 \\right]\\,$.\n\n**第 3 步：偏差、方差和 MSE 计算**\n\n在为给定的 $\\,\\gamma\\,$ 计算出必要的矩之后，我们现在可以评估比率估计量 $\\,\\hat{\\mu}(\\gamma)\\,$ 的偏差和方差。\n\n偏差由下式给出：\n$$\n\\mathrm{bias}(\\gamma) = \\frac{\\mathbb{E}[wL]}{\\mathbb{E}[w]} - \\mu = \\kappa_L \\frac{\\mathbb{E}[wc]}{\\mathbb{E}[w]}\n$$\n该项量化了加权方案引入的系统误差。\n\n估计量的方差 $\\,\\mathrm{Var}(\\hat{\\mu}(\\gamma))\\,$ 使用 delta 方法对两个随机变量 $\\,A = \\frac{1}{N}\\sum w_i L_i\\,$ 和 $\\,B = \\frac{1}{N}\\sum w_i\\,$ 的比率进行近似。首先，我们计算基础量 $\\,w\\,$ 和 $\\,wL\\,$ 的方差和协方差：\n- $\\,\\mathrm{Var}(w) = \\mathbb{E}[w^2] - (\\mathbb{E}[w])^2\\,$\n- $\\,\\mathrm{Var}(wL) = \\mathbb{E}[w^2L^2] - (\\mathbb{E}[wL])^2\\,$\n- $\\,\\mathrm{Cov}(wL, w) = \\mathbb{E}[w^2L] - \\mathbb{E}[wL]\\mathbb{E}[w]\\,$\n\n令 $\\,a = \\mathbb{E}[wL]\\,$ 和 $\\,b = \\mathbb{E}[w]\\,$，估计量方差为：\n$$\n\\mathrm{Var}(\\hat{\\mu}(\\gamma)) \\approx \\frac{1}{N} \\left[ \\frac{\\mathrm{Var}(wL)}{b^2} + \\frac{a^2}{b^4}\\mathrm{Var}(w) - \\frac{2a}{b^3}\\mathrm{Cov}(wL, w) \\right]\n$$\n该项量化了估计量的统计不确定性（噪声）。\n\n最后，均方误差 (MSE) 是偏差平方与方差之和：\n$$\n\\mathrm{MSE}(\\gamma) = \\left[\\mathrm{bias}(\\gamma)\\right]^2 + \\mathrm{Var}(\\hat{\\mu}(\\gamma))\n$$\n\n**第 4 步：指数 $\\,\\gamma\\,$ 的优化**\n\n对于每个测试用例，流程是在指定的网格（从 $\\,0.0\\,$ 到 $\\,6.0\\,$，步长为 $\\,0.25\\,$）上为每个 $\\,\\gamma\\,$ 值计算 $\\,\\mathrm{MSE}(\\gamma)\\,$。然后我们确定产生最小 MSE 的 $\\,\\gamma^\\star\\,$ 值。根据问题的平局打破规则，如果多个 $\\,\\gamma\\,$ 值产生相同的最小 MSE，则选择其中最小的值作为 $\\,\\gamma^\\star\\,$。对所有四个测试用例重复此过程，并收集得到的最优指数。该实现利用 `numpy` 对直方图数据进行高效的向量化操作。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import vonmises\n\ndef solve():\n    \"\"\"\n    Solves the AFQMC constrained-path approximation problem for four test cases.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"N\": 200000, \"dist\": \"vonmises\", \"kappa_theta\": 8.0,\n            \"mu\": 1.5, \"kappa_L\": 0.8, \"sigma\": 0.7, \"M\": 200,\n            \"gamma_min\": 0.0, \"gamma_max\": 6.0, \"gamma_step\": 0.25\n        },\n        {\n            \"N\": 200000, \"dist\": \"uniform\", \"kappa_theta\": None,\n            \"mu\": 0.0, \"kappa_L\": 0.5, \"sigma\": 1.5, \"M\": 200,\n            \"gamma_min\": 0.0, \"gamma_max\": 6.0, \"gamma_step\": 0.25\n        },\n        {\n            \"N\": 200000, \"dist\": \"vonmises\", \"kappa_theta\": 1.5,\n            \"mu\": 2.0, \"kappa_L\": 0.3, \"sigma\": 3.0, \"M\": 200,\n            \"gamma_min\": 0.0, \"gamma_max\": 6.0, \"gamma_step\": 0.25\n        },\n        {\n            \"N\": 200000, \"dist\": \"uniform\", \"kappa_theta\": None,\n            \"mu\": -1.0, \"kappa_L\": -0.6, \"sigma\": 1.0, \"M\": 200,\n            \"gamma_min\": 0.0, \"gamma_max\": 6.0, \"gamma_step\": 0.25\n        },\n    ]\n\n    optimal_gammas = []\n\n    for case in test_cases:\n        N = case[\"N\"]\n        M = case[\"M\"]\n        mu = case[\"mu\"]\n        kappa_L = case[\"kappa_L\"]\n        sigma = case[\"sigma\"]\n\n        # Step 1: Generate samples and construct histogram\n        if case[\"dist\"] == \"vonmises\":\n            delta_theta = vonmises.rvs(kappa=case[\"kappa_theta\"], loc=0, size=N)\n        elif case[\"dist\"] == \"uniform\":\n            delta_theta = np.random.uniform(-np.pi, np.pi, size=N)\n        \n        c = np.cos(delta_theta)\n        \n        counts, bin_edges = np.histogram(c, bins=M, range=(-1.0, 1.0))\n        p_j = counts / N\n        c_j = (bin_edges[:-1] + bin_edges[1:]) / 2.0\n        \n        min_mse = np.inf\n        optimal_gamma = -1.0\n        \n        gamma_grid = np.arange(case[\"gamma_min\"], case[\"gamma_max\"] + case[\"gamma_step\"], case[\"gamma_step\"])\n\n        # Steps 2  3: Iterate through gamma grid, calculate MSE\n        for gamma in gamma_grid:\n            # Calculate weights w_j\n            w_j = np.maximum(0, c_j)**gamma\n\n            # Calculate moments\n            E_w = np.sum(p_j * w_j)\n            \n            # If E[w] is zero, this gamma is invalid, continue.\n            if E_w == 0:\n                continue\n\n            E_wc = np.sum(p_j * w_j * c_j)\n            \n            E_w2 = np.sum(p_j * w_j**2)\n            E_w2c = np.sum(p_j * w_j**2 * c_j)\n            \n            # Moments involving L\n            E_wL = mu * E_w + kappa_L * E_wc\n            E_w2L = mu * E_w2 + kappa_L * E_w2c\n            \n            Lj_part_sq = (mu + kappa_L * c_j)**2\n            E_w2L2 = np.sum(p_j * w_j**2 * (Lj_part_sq + sigma**2))\n\n            # Calculate bias\n            bias_gamma = kappa_L * (E_wc / E_w)\n            \n            # Calculate variances and covariance\n            Var_w = E_w2 - E_w**2\n            Var_wL = E_w2L2 - E_wL**2\n            Cov_wL_w = E_w2L - E_wL * E_w\n\n            # Calculate variance of the estimator using delta method\n            a = E_wL\n            b = E_w\n            \n            # To avoid division by zero if b (E[w]) is extremely small\n            if b  1e-15: continue\n            \n            var_mu_hat_term1 = Var_wL / b**2\n            var_mu_hat_term2 = (a**2 / b**4) * Var_w\n            var_mu_hat_term3 = (2 * a / b**3) * Cov_wL_w\n            \n            var_mu_hat = (1/N) * (var_mu_hat_term1 + var_mu_hat_term2 - var_mu_hat_term3)\n\n            # Calculate MSE\n            mse = bias_gamma**2 + var_mu_hat\n            \n            # Step 4: Find optimal gamma\n            if mse  min_mse:\n                min_mse = mse\n                optimal_gamma = gamma\n\n        optimal_gammas.append(optimal_gamma)\n\n    # Format the final output\n    formatted_results = [f\"{g:.2f}\" for g in optimal_gammas]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "3551580"}]}