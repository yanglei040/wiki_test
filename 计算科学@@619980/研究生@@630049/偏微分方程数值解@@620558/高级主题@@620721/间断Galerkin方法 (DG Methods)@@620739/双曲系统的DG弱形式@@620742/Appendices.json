{"hands_on_practices": [{"introduction": "我们从双曲系统的最基本模型——线性平流方程开始。间断伽辽金（DG）方法的一个核心设计选择是在单元交界面上使用的数值通量。这个选择直接决定了数值格式的稳定性和准确性。\n\n本练习旨在通过一种具体的方式来理解这些影响[@problem_id:3377316]。通过推导半离散系统并运用傅里叶分析，您将定量地测量两种基本通量选择（迎风通量和中心通量）所引入的色散（相位误差）和耗散（振幅误差）。这项练习将为您建立关于DG格式行为方式的关键直觉。", "problem": "考虑一维线性平流方程 $\\partial_t u + a \\,\\partial_x u = 0$，其中平流速度 $a>0$ 为常数，定义在一个由大小为 $h$ 的均匀网格单元离散的周期性区域上。使用每个单元上多项式次数为 $p=1$ 的间断伽辽金(DG)方法，以及在参考单元 $\\xi \\in [-1,1]$ 上由 $\\phi_0(\\xi)=1$ 和 $\\phi_1(\\xi)=\\xi$ 定义的模态基，通过 $x=x_j+(h/2)\\,\\xi$ 映射到每个物理单元 $I_j=[x_{j-1/2},x_{j+1/2}]$。通量函数为 $f(u)=a\\,u$。将比较两种数值通量：$a>0$ 时的迎风通量和中心通量。周期性边界条件意味着来自相邻单元的值会环绕整个区域。\n\n从DG弱形式出发，通过使用检验函数 $v=\\phi_0$ 和 $v=\\phi_1$ 在每个单元 $I_j$ 上推导半离散系统，并仔细处理所选基和映射下的体项和边界项。将半离散系统表示为 $M\\,\\partial_t \\mathbf{u}_j = \\mathcal{L}_j(\\mathbf{u}_{j-1},\\mathbf{u}_j,\\mathbf{u}_{j+1})$ 的形式，其中 $M$ 是局部质量矩阵，$\\mathbf{u}_j=(u_{j,0},u_{j,1})^\\top$ 是单元 $j$ 中的模态系数。然后应用离散傅里叶(Bloch)拟设 $\\mathbf{u}_j(t)=\\hat{\\mathbf{u}}(t)\\,e^{i k x_j}$，其中 $k$ 是空间波数，单位为弧度/米，以获得一个 $2\\times 2$ 的傅里叶符号矩阵 $A(k)$，使得对于两种通量选择，都有 $\\partial_t \\hat{\\mathbf{u}} = A(k)\\,\\hat{\\mathbf{u}}$。半离散傅里叶符号由 $A(k)$ 的特征值 $\\lambda(k)$ 定义；选择在极限 $k\\to 0$ 时趋近于 $-i\\,a\\,k$ 的特征值作为物理分支。\n\n定义色散误差为 $E_{\\mathrm{disp}}(k) = \\operatorname{Im}(\\lambda(k))/(-a) - k$（单位为弧度/米），耗散率为 $E_{\\mathrm{diss}}(k) = \\operatorname{Re}(\\lambda(k))$（单位为 1/秒）。实现一个程序，为迎风通量和中心通量构建 $A(k)$，计算它们的特征值，选择物理分支，并评估 $E_{\\mathrm{disp}}(k)$ 和 $E_{\\mathrm{diss}}(k)$。\n\n使用以下测试套件，其中 $a=1.0$ 米/秒，$h=1.0$ 米，波数单位为弧度/米（角度单位为弧度）：\n- $k_1 = 0.0$\n- $k_2 = 0.2\\,\\pi$\n- $k_3 = 0.5\\,\\pi$\n- $k_4 = 0.9\\,\\pi$\n\n你的程序应生成单行输出，包含一个由方括号括起来的逗号分隔列表。对于每个测试用例 $k_i$，输出一个包含四个浮点数的列表 $[E_{\\mathrm{disp}}^{\\mathrm{up}}, E_{\\mathrm{diss}}^{\\mathrm{up}}, E_{\\mathrm{disp}}^{\\mathrm{cen}}, E_{\\mathrm{diss}}^{\\mathrm{cen}}]$，其中上标表示通量选择。将四个测试用例的结果汇总到一个列表中。最终要求的格式是\n$[[d_1,s_1,d_2,s_2],[d_1,s_1,d_2,s_2],[d_1,s_1,d_2,s_2],[d_1,s_1,d_2,s_2]]$\n所有条目均为浮点数，其中每个方括号组内的条目顺序为：迎风色散误差、迎风耗散率、中心色散误差、中心耗散率。不应打印单位；所有角度必须以弧度处理，色散误差以弧度/米表示，耗散率以 1/秒 表示。", "solution": "起点是一维线性平流方程 $\\partial_t u + a \\,\\partial_x u = 0$，其中速度 $a>0$ 为常数。间断伽辽金(DG)方法通过在每个单元 $I_j=[x_{j-1/2},x_{j+1/2}]$ 中使用参考单元 $\\xi \\in [-1,1]$ 上的模态基 $\\phi_0(\\xi)=1$ 和 $\\phi_1(\\xi)=\\xi$ 来近似 $u$，并通过 $x=x_j+(h/2)\\,\\xi$ 进行映射。单元 $j$ 中的局部近似为 $u_h(x,t) = u_{j,0}(t)\\,\\phi_0(\\xi(x)) + u_{j,1}(t)\\,\\phi_1(\\xi(x))$。对于一个检验函数 $v$，DG弱形式为\n$$\n\\int_{I_j} \\partial_t u_h\\, v\\, dx \\;-\\; \\int_{I_j} f(u_h)\\,\\partial_x v\\, dx \\;+\\; \\widehat{f}\\big(u_h^{-},u_h^{+}\\big)\\, v\\big|_{x_{j+1/2}} \\;-\\; \\widehat{f}\\big(u_h^{-},u_h^{+}\\big)\\, v\\big|_{x_{j-1/2}} \\;=\\; 0,\n$$\n其中 $f(u)=a\\,u$，$\\widehat{f}$ 是界面上的数值通量。对于 $p=1$，我们用 $v=\\phi_0$ 和 $v=\\phi_1$ 作检验函数。映射导数为 $\\partial_x v = (2/h)\\,\\partial_\\xi v$，雅可比为 $dx=(h/2)\\,d\\xi$。质量矩阵的项为\n$$\nM_{mn} = \\int_{I_j} \\phi_m \\phi_n\\, dx = \\frac{h}{2}\\int_{-1}^1 \\phi_m(\\xi)\\,\\phi_n(\\xi)\\, d\\xi,\n$$\n这得到 $M=\\mathrm{diag}(h, h/3)$，因为 $\\int_{-1}^1 1\\,d\\xi=2$，$\\int_{-1}^1 \\xi\\,d\\xi=0$，以及 $\\int_{-1}^1 \\xi^2\\,d\\xi=2/3$。\n\n体项涉及 $-\\int_{I_j} a\\,u_h\\,\\partial_x v\\,dx$。对于 $v=\\phi_0$，$\\partial_x \\phi_0=0$，所以体项为零。对于 $v=\\phi_1$，$\\partial_x \\phi_1 = 2/h$，因此\n$$\n-\\int_{I_j} a\\,u_h\\,\\partial_x \\phi_1\\,dx \\;=\\; -\\frac{2a}{h}\\int_{I_j} u_h\\,dx \\;=\\; -\\frac{2a}{h}\\frac{h}{2}\\int_{-1}^1 \\big(u_{j,0}\\,\\phi_0(\\xi) + u_{j,1}\\,\\phi_1(\\xi)\\big)\\, d\\xi \\;=\\; -2a\\,u_{j,0},\n$$\n因为 $\\int_{-1}^1 \\phi_1(\\xi)\\,d\\xi=0$。\n\n边界项在单元端点处计算检验函数的值。在 $x_{j+1/2}$ 处，外法线为 $+1$，且 $\\phi_0(1)=1$，$\\phi_1(1)=1$。在 $x_{j-1/2}$ 处，外法线为 $-1$，且 $\\phi_0(-1)=1$，$\\phi_1(-1)=-1$。因此，对于 $v=\\phi_0$ 和 $v=\\phi_1$ 的边界贡献分别为 $\\widehat{f}_{j+1/2} - \\widehat{f}_{j-1/2}$ 和 $\\widehat{f}_{j+1/2} + \\widehat{f}_{j-1/2}$。单元界面上的迹值为：在 $x_{j+1/2}$ 处 $u_j^{+}=u_{j,0}+u_{j,1}$，在 $x_{j-1/2}$ 处 $u_j^{-}=u_{j,0}-u_{j,1}$。\n\n对于 $a>0$ 的迎风通量，$\\widehat{f}=a\\,u^{-}$，因此 $\\widehat{f}_{j+1/2} = a\\,(u_{j,0}+u_{j,1})$ 且 $\\widehat{f}_{j-1/2} = a\\,(u_{j-1,0}+u_{j-1,1})$。结合所有项，半离散方程变为\n$$\nh\\,\\partial_t u_{j,0} \\;+\\; a\\big[(u_{j,0}+u_{j,1}) - (u_{j-1,0}+u_{j-1,1})\\big] \\;=\\; 0,\n$$\n$$\n\\frac{h}{3}\\,\\partial_t u_{j,1} \\;-\\; 2a\\,u_{j,0} \\;+\\; a\\big[(u_{j,0}+u_{j,1}) + (u_{j-1,0}+u_{j-1,1})\\big] \\;=\\; 0.\n$$\n\n对于中心通量，$\\widehat{f}=\\tfrac{a}{2}\\,(u^{-}+u^{+})$，得到 $\\widehat{f}_{j+1/2} = \\tfrac{a}{2}\\big((u_{j,0}+u_{j,1}) + (u_{j+1,0}-u_{j+1,1})\\big)$ 且 $\\widehat{f}_{j-1/2} = \\tfrac{a}{2}\\big((u_{j-1,0}+u_{j-1,1}) + (u_{j,0}-u_{j,1})\\big)$。半离散方程为\n$$\nh\\,\\partial_t u_{j,0} \\;+\\; \\frac{a}{2}\\Big[\\big(u_{j,0}+u_{j,1}\\big) + \\big(u_{j+1,0}-u_{j+1,1}\\big) - \\big(u_{j-1,0}+u_{j-1,1}\\big) - \\big(u_{j,0}-u_{j,1}\\big)\\Big] \\;=\\; 0,\n$$\n$$\n\\frac{h}{3}\\,\\partial_t u_{j,1} \\;-\\; 2a\\,u_{j,0} \\;+\\; \\frac{a}{2}\\Big[\\big(u_{j,0}+u_{j,1}\\big) + \\big(u_{j+1,0}-u_{j+1,1}\\big) + \\big(u_{j-1,0}+u_{j-1,1}\\big) + \\big(u_{j,0}-u_{j,1}\\big)\\Big] \\;=\\; 0.\n$$\n\n为了获得傅里叶符号，应用 Bloch 拟设 $\\mathbf{u}_j(t)=\\hat{\\mathbf{u}}(t)\\,e^{i k x_j}$，其中 $k$ 是波数，$x_{j\\pm 1}=x_j\\pm h$。那么 $u_{j\\pm1,m}= \\hat{u}_m\\,e^{\\pm i k h}\\,e^{i k x_j}$。提出因子 $e^{i k x_j}$ 并将 $\\hat{\\mathbf{u}}=(\\hat{u}_0,\\hat{u}_1)^\\top$ 的半离散系统写为 $\\partial_t \\hat{\\mathbf{u}} = A(k)\\,\\hat{\\mathbf{u}}$。对于迎风通量，引入 $z=e^{-i k h}=\\cos(kh)-i\\sin(kh)$，得到\n$$\nA_{\\mathrm{up}}(k) \\;=\\; -\\frac{a}{h}\n\\begin{pmatrix}\n1 - z  & 1 - z\\\\\n3(z - 1)  & 3(1 + z)\n\\end{pmatrix}.\n$$\n对于中心通量，使用三角恒等式，得到\n$$\nA_{\\mathrm{cen}}(k) \\;=\\; -\\frac{a}{h}\n\\begin{pmatrix}\ni\\,\\sin(kh)  & 1 - \\cos(kh)\\\\\n3\\big(\\cos(kh)-1\\big)  & -3\\,i\\,\\sin(kh)\n\\end{pmatrix}.\n$$\n半离散傅里叶符号由 $A(k)$ 的特征值 $\\lambda(k)$ 给出。物理分支满足当 $k\\to 0$ 时 $\\lambda(k)\\to -i\\,a\\,k$，而第二个分支对应一个量级为 $O(a/h)$ 的伪模态。\n\n定义色散误差为 $E_{\\mathrm{disp}}(k) = \\operatorname{Im}(\\lambda(k))/(-a) - k$，它将数值相速度与精确关系 $\\lambda_{\\mathrm{exact}}(k)=-i\\,a\\,k$ 进行比较；定义耗散率为 $E_{\\mathrm{diss}}(k) = \\operatorname{Re}(\\lambda(k))$，对于精确的连续平流，耗散率为零，而对于耗散离散化，耗散率非零。算法如下：\n1. 对于给定的 $(a,h,k)$，如上构建 $A_{\\mathrm{up}}(k)$ 和 $A_{\\mathrm{cen}}(k)$。\n2. 计算它们的特征值。\n3. 通过在计算出的特征值中最小化 $|\\operatorname{Im}(\\lambda)+a\\,k|$ 来选择物理特征值；如果需要，通过选择模 $|\\lambda|$ 较小的特征值来处理并列情况。\n4. 为两种通量计算 $E_{\\mathrm{disp}}(k)$ 和 $E_{\\mathrm{diss}}(k)$。\n\n当 $a=1.0$ 米/秒，$h=1.0$ 米，以及测试波数 $k_1=0.0$, $k_2=0.2\\,\\pi$, $k_3=0.5\\,\\pi$, $k_4=0.9\\,\\pi$ (弧度/米)时，程序为每个 $k_i$ 生成四个浮点数 $[E_{\\mathrm{disp}}^{\\mathrm{up}}, E_{\\mathrm{diss}}^{\\mathrm{up}}, E_{\\mathrm{disp}}^{\\mathrm{cen}}, E_{\\mathrm{diss}}^{\\mathrm{cen}}]$，并汇总成一个列表。定性地看，中心通量产生纯虚特征值，因此对所有 $k$ 都有 $E_{\\mathrm{diss}}^{\\mathrm{cen}}(k)=0$，这反映了半离散设置中的能量守恒。而迎风通量在 $\\lambda(k)$ 中引入了负实部，因此除了在 $k=0$ 时，$E_{\\mathrm{diss}}^{\\mathrm{up}}(k)  0$，这反映了数值耗散。两种通量的色散误差都量化了随 $kh$ 增大的相位不准确性；物理分支在 $k\\to 0$ 时趋近于精确的 $-i\\,a\\,k$，因此两种通量的 $E_{\\mathrm{disp}}(0)=0$。", "answer": "```python\nimport numpy as np\n\ndef A_upwind(a, h, k):\n    \"\"\"\n    Construct the 2x2 Fourier symbol matrix A(k) for P1 DG with upwind flux (a  0).\n    Uses z = exp(-i k h).\n    \"\"\"\n    z = np.exp(-1j * k * h)\n    factor = -a / h\n    A11 = (1 - z)\n    A12 = (1 - z)\n    A21 = 3 * (z - 1)\n    A22 = 3 * (1 + z)\n    A = factor * np.array([[A11, A12],\n                           [A21, A22]], dtype=complex)\n    return A\n\ndef A_central(a, h, k):\n    \"\"\"\n    Construct the 2x2 Fourier symbol matrix A(k) for P1 DG with central flux.\n    Uses trig form with sin(kh) and cos(kh).\n    \"\"\"\n    kh = k * h\n    s = np.sin(kh)\n    c = np.cos(kh)\n    factor = -a / h\n    A11 = 1j * s\n    A12 = (1 - c)\n    A21 = 3 * (c - 1)\n    A22 = -3j * s\n    A = factor * np.array([[A11, A12],\n                           [A21, A22]], dtype=complex)\n    return A\n\ndef physical_branch_eigenvalue(eigs, a, k):\n    \"\"\"\n    Select the physical branch eigenvalue: the one whose imaginary part\n    is closest to -a*k. Break ties by smaller magnitude.\n    \"\"\"\n    target_im = -a * k\n    # Compute closeness and magnitude\n    closeness = [abs(np.imag(lam) - target_im) for lam in eigs]\n    # Find indices sorted by closeness then by magnitude\n    indices = sorted(range(len(eigs)),\n                     key=lambda i: (closeness[i], abs(eigs[i])))\n    return eigs[indices[0]]\n\ndef compute_errors(a, h, k, flux_type):\n    \"\"\"\n    Compute dispersion and dissipation errors for given a, h, k, and flux type.\n    flux_type: 'upwind' or 'central'\n    Returns (E_disp, E_diss).\n    \"\"\"\n    if flux_type == 'upwind':\n        A = A_upwind(a, h, k)\n    elif flux_type == 'central':\n        A = A_central(a, h, k)\n    else:\n        raise ValueError(\"Unknown flux type\")\n    eigs = np.linalg.eigvals(A)\n    lam = physical_branch_eigenvalue(eigs, a, k)\n    E_disp = (np.imag(lam) / (-a)) - k  # radians per meter\n    E_diss = np.real(lam)               # inverse seconds\n    return float(E_disp), float(E_diss)\n\ndef solve():\n    # Define parameters\n    a = 1.0  # m/s\n    h = 1.0  # m\n    # Test suite wavenumbers in radians per meter (angles in radians)\n    test_cases = [\n        0.0,\n        0.2 * np.pi,\n        0.5 * np.pi,\n        0.9 * np.pi,\n    ]\n\n    results = []\n    for k in test_cases:\n        disp_up, diss_up = compute_errors(a, h, k, 'upwind')\n        disp_cen, diss_cen = compute_errors(a, h, k, 'central')\n        results.append([disp_up, diss_up, disp_cen, diss_cen])\n\n    # Final print statement in the exact required format.\n    # Single line: list of lists with floats.\n    print(f\"[{','.join(str(r) for r in results)}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```", "id": "3377316"}, {"introduction": "在掌握了基本原理之后，我们现在转向一个非线性守恒律：用于描述交通流的Lighthill-Whitham-Richards（LWR）模型。这将理论带入了实际应用的领域。DG框架尤其适用于处理复杂的几何形状和边界条件。\n\n本练习演示了如何通过基于供需物理原理设计自定义的边界通量求解器，来模拟一个匝道汇入高速公路的真实场景[@problem_id:3377321]。通过为该问题实施一个DG0格式（等价于有限体积法），您将学习如何处理非线性通量和实现复杂的边界条件，超越简单的周期性区域。您还将接触到队列形成和溢出的物理建模。", "problem": "考虑单车道链路上的车辆交通流的一维标量双曲守恒律，\n$$\\partial_t \\rho(x,t) + \\partial_x \\big( \\rho(x,t)\\,V(\\rho(x,t)) \\big) = 0,$$\n其中 $\\rho(x,t)$ 是交通密度，单位是车辆/公里；$V(\\rho)$ 是速度，单位是公里/秒；通量 $f(\\rho)$ 定义为 $f(\\rho) = \\rho V(\\rho)$，单位是车辆/秒。假设采用 Greenshields 基本图，即\n$$V(\\rho) = V_{\\max}\\left(1 - \\frac{\\rho}{\\rho_{\\max}}\\right),\\qquad f(\\rho) = V_{\\max}\\left(\\rho - \\frac{\\rho^2}{\\rho_{\\max}}\\right),$$\n其中 $V_{\\max}  0$ 的单位是公里/秒，$\\rho_{\\max}  0$ 的单位是车辆/公里。设空间域为 $x \\in [0,L]$，其中 $L$ 的单位是公里。位于 $x=0$ 的左边界模拟一个有两个流入流的汇合点：上游主线，其特征为外部上游密度 $\\rho_{\\mathrm{up}}$（单位：车辆/公里）；以及一个匝道，提供外生需求 $q_{\\mathrm{r}}$（单位：车辆/秒）。位于 $x=L$ 的右边界连接到一个外部下游状态，其特征为密度 $\\rho_{\\mathrm{down}}$（单位：车辆/公里）。\n\n您的任务是为上述守恒律推导、实现并执行一个零阶（每个单元上为分段常数表示）不连续伽辽金 (DG) 方法。您必须从每个单元上的积分弱形式出发，应用分部积分，并使用界面数值通量来封闭半离散系统。对于内部界面，请对严格凹通量函数使用单调的 Godunov 通量。对于左边界，请实现一个汇合黎曼求解器，该求解器在一个固定的优先级分配下，结合上游主线需求和匝道需求，并受限于区域边界的供给。对于右边界，请使用 Godunov 通量与外部下游密度。\n\n定义由 Greenshields 模型导出的临界密度和通行能力。将 Godunov 求解器中使用的需求函数和供给函数纯粹用基本图和这些临界量来表示，并在内部界面和边界处一致地使用它们。匝道排队 $Q(t)$（单位：车辆）遵循蓄水池动态模型\n$$\\frac{dQ}{dt} = q_{\\mathrm{r}} - F_{\\mathrm{r}}(t),$$\n其中 $F_{\\mathrm{r}}(t)$ 是由 $x=0$ 处的边界黎曼求解器确定的匝道准入流量，单位是车辆/秒。物理排队长度 $\\ell_{\\mathrm{q}}(t)$（单位：公里）为\n$$\\ell_{\\mathrm{q}}(t) = \\frac{Q(t)}{\\rho_{\\mathrm{j,r}}},$$\n其中 $\\rho_{\\mathrm{j,r}}$ 是匝道拥堵密度，单位是车辆/公里。如果在时刻 $t$ 出现 $\\ell_{\\mathrm{q}}(t) \\ge L_{\\mathrm{ramp}}$，则称发生了排队溢出，其中 $L_{\\mathrm{ramp}}$ 是匝道的有限存储长度，单位是公里。\n\n在数值上，将 $[0,L]$ 离散为 $N$ 个均匀单元，并基于从 $f'(\\rho)$ 导出的最大特征速度，使用 Courant-Friedrichs-Lewy (CFL) 条件执行显式时间积分；使用一个小于 1 的固定 CFL 数。如果需要，将密度裁剪到物理允许的区间 $[0,\\rho_{\\max}]$ 内。假设初始密度为均匀的 $\\rho(x,0)=\\rho_{\\mathrm{init}}$，单位是车辆/公里。$x=0$ 处的汇合优先级由分配给上游主线的一个固定比例 $p \\in (0,1)$ 指定；匝道获得互补的比例 $(1-p)$，并受到需求限制和供给限制的约束。除了边界汇合外，不包括任何松弛项或额外的源项。\n\n使用下面包含三组参数的测试套件，每组都按指示指定了一致的单位。在所有情况下，速度单位为公里/秒，密度单位为车辆/公里，通量单位为车辆/秒，长度单位为公里，时间单位为秒，不涉及角度。\n\n- 测试用例 1 (理想情况，预计无溢出)：\n  - $L = 1.0$, $N = 200$, $T = 200.0$, $\\mathrm{CFL} = 0.9$.\n  - $V_{\\max} = 0.03$, $\\rho_{\\max} = 180.0$, $\\rho_{\\mathrm{init}} = 40.0$.\n  - $\\rho_{\\mathrm{up}} = 60.0$, $\\rho_{\\mathrm{down}} = 40.0$.\n  - $q_{\\mathrm{r}} = 0.10$, $p = 0.70$, $L_{\\mathrm{ramp}} = 0.50$, $\\rho_{\\mathrm{j,r}} = 150.0$.\n\n- 测试用例 2 (拥堵且排队增长，但无溢出)：\n  - $L = 1.0$, $N = 200$, $T = 200.0$, $\\mathrm{CFL} = 0.9$.\n  - $V_{\\max} = 0.03$, $\\rho_{\\max} = 180.0$, $\\rho_{\\mathrm{init}} = 40.0$.\n  - $\\rho_{\\mathrm{up}} = 80.0$, $\\rho_{\\mathrm{down}} = 160.0$.\n  - $q_{\\mathrm{r}} = 0.60$, $p = 0.70$, $L_{\\mathrm{ramp}} = 1.00$, $\\rho_{\\mathrm{j,r}} = 150.0$.\n\n- 测试用例 3 (拥堵并发生溢出)：\n  - $L = 1.0$, $N = 200$, $T = 200.0$, $\\mathrm{CFL} = 0.9$.\n  - $V_{\\max} = 0.03$, $\\rho_{\\max} = 180.0$, $\\rho_{\\mathrm{init}} = 40.0$.\n  - $\\rho_{\\mathrm{up}} = 80.0$, $\\rho_{\\mathrm{down}} = 160.0$.\n  - $q_{\\mathrm{r}} = 1.20$, $p = 0.70$, $L_{\\mathrm{ramp}} = 0.20$, $\\rho_{\\mathrm{j,r}} = 150.0$.\n\n对于每个测试用例，运行 DG 求解器并确定在 $[0,T]$ 时间内是否发生排队溢出。用 $0$ 表示“无溢出”，用 $1$ 表示“发生溢出”来代表溢出结果。您的程序应生成单行输出，其中包含三个测试用例的结果，格式为方括号内以逗号分隔的列表，例如 $[0,1,1]$。您的计算所隐含的所有数值答案均使用上述单位；最终打印的输出是不带单位符号的整数。", "solution": "该问题要求为控制交通流的一维标量双曲守恒律（即 Lighthill-Whitham-Richards (LWR) 模型）开发并应用一个零阶不连续伽辽金 (DG) 方法。\n\n控制偏微分方程 (PDE) 为：\n$$\n\\partial_t \\rho(x,t) + \\partial_x f(\\rho(x,t)) = 0\n$$\n其中 $\\rho(x,t)$ 是交通密度，$f(\\rho)$ 是交通通量。空间域为 $x \\in [0,L]$。问题指定了用于基本图的 Greenshields 模型：\n$$\nV(\\rho) = V_{\\max}\\left(1 - \\frac{\\rho}{\\rho_{\\max}}\\right)\n$$\n$$\nf(\\rho) = \\rho V(\\rho) = V_{\\max}\\left(\\rho - \\frac{\\rho^2}{\\rho_{\\max}}\\right)\n$$\n该通量函数 $f(\\rho)$ 是一个严格凹的抛物线，其根位于 $\\rho=0$ 和 $\\rho=\\rho_{\\max}$。\n\n首先，我们确定基本图的关键属性。特征速度由 $c(\\rho) = f'(\\rho)$ 给出：\n$$\nf'(\\rho) = V_{\\max}\\left(1 - \\frac{2\\rho}{\\rho_{\\max}}\\right)\n$$\nCFL 条件所需的最大绝对特征速度为 $\\max_{\\rho \\in [0, \\rho_{\\max}]} |f'(\\rho)| = V_{\\max}$，它在 $\\rho=0$ 和 $\\rho=\\rho_{\\max}$ 处取得。\n\n临界密度 $\\rho_c$ 是使通量最大化的密度。这在 $f'(\\rho_c) = 0$ 时发生：\n$$\nV_{\\max}\\left(1 - \\frac{2\\rho_c}{\\rho_{\\max}}\\right) = 0 \\implies \\rho_c = \\frac{\\rho_{\\max}}{2}\n$$\n通行能力 $C$（或 $f_{\\max}$）是在临界密度下达到的最大通量：\n$$\nC = f(\\rho_c) = V_{\\max}\\left(\\frac{\\rho_{\\max}}{2} - \\frac{(\\rho_{\\max}/2)^2}{\\rho_{\\max}}\\right) = \\frac{V_{\\max}\\rho_{\\max}}{4}\n$$\n对于黎曼问题，定义需求函数和供给函数是很有用的。需求 $D(\\rho)$ 是密度为 $\\rho$ 的上游区域可以发送的最大流量，而供给 $S(\\rho)$ 是密度为 $\\rho$ 的下游区域可以接收的最大流量。对于凹通量函数：\n$$\nD(\\rho) = \\begin{cases} f(\\rho)  \\text{if } \\rho \\le \\rho_c \\\\ C  \\text{if } \\rho  \\rho_c \\end{cases}\n$$\n$$\nS(\\rho) = \\begin{cases} C  \\text{if } \\rho \\le \\rho_c \\\\ f(\\rho)  \\text{if } \\rho  \\rho_c \\end{cases}\n$$\n\n采用零阶 DG 方法 (DG0)。区域 $[0,L]$ 被划分为 $N$ 个均匀的单元（元素）$I_j = [x_{j-1/2}, x_{j+1/2}]$，其中 $j=1, \\dots, N$，每个单元的宽度为 $\\Delta x = L/N$。在 DG0 中，解 $\\rho(x,t)$ 被一个分段常数函数近似：\n$$\n\\rho_h(x,t) = \\sum_{j=1}^{N} \\rho_j(t) \\phi_j(x), \\quad \\text{其中} \\quad \\phi_j(x) = \\begin{cases} 1  \\text{if } x \\in I_j \\\\ 0  \\text{otherwise} \\end{cases}\n$$\n通过将 PDE 乘以一个测试函数 $v(x)$ 并在一个单元 $I_j$ 上积分来获得弱形式。对于 DG0，测试函数也是分段常数，$v(x) = \\phi_j(x)$。\n$$\n\\int_{x_{j-1/2}}^{x_{j+1/2}} \\partial_t \\rho_h(x,t) \\phi_j(x) \\,dx + \\int_{x_{j-1/2}}^{x_{j+1/2}} \\partial_x f(\\rho_h(x,t)) \\phi_j(x) \\,dx = 0\n$$\n在 $I_j$ 内代入 $\\rho_h(x,t) = \\rho_j(t)$ 并对第一项积分得到 $\\Delta x \\frac{d\\rho_j}{dt}$。对于第二项，我们应用分部积分：\n$$\n\\int_{x_{j-1/2}}^{x_{j+1/2}} \\partial_x f(\\rho_h) \\,dx = f(\\rho_h(x_{j+1/2}^-,t)) - f(\\rho_h(x_{j-1/2}^+,t))\n$$\n其中 $x_{j \\pm 1/2}^\\pm$ 表示从单元内部/外部的极限。在单元界面处的 $f(\\rho_h)$ 值是不连续的，必须用一个单值的数值通量 $\\hat{f}$ 来代替。单元 $j$ 的半离散格式变为：\n$$\n\\Delta x \\frac{d\\rho_j}{dt} + \\hat{f}_{j+1/2} - \\hat{f}_{j-1/2} = 0 \\implies \\frac{d\\rho_j}{dt} = -\\frac{1}{\\Delta x}(\\hat{f}_{j+1/2} - \\hat{f}_{j-1/2})\n$$\n这与一阶有限体积格式相同，这对于 DG0 是预期的结果。时间使用显式前向欧拉方法进行离散化，其固定时间步长 $\\Delta t$ 由 CFL 条件确定：\n$$\n\\Delta t = \\mathrm{CFL} \\frac{\\Delta x}{\\max|f'(\\rho)|} = \\mathrm{CFL} \\frac{\\Delta x}{V_{\\max}}, \\quad \\text{with } \\mathrm{CFL}  1\n$$\n完全离散的更新格式为：\n$$\n\\rho_j^{n+1} = \\rho_j^n - \\frac{\\Delta t}{\\Delta x}(\\hat{f}_{j+1/2}^n - \\hat{f}_{j-1/2}^n)\n$$\n\n数值通量 $\\hat{f}$ 定义如下：\n1.  **内部界面** ($j=1, \\dots, N-1$)：使用 Godunov 通量。对于一个凹通量函数，它由状态 $\\rho_j$ 和 $\\rho_{j+1}$ 之间的黎曼问题的解给出，可简化为：\n    $$\n    \\hat{f}_{j+1/2} = F_G(\\rho_j, \\rho_{j+1}) = \\min(D(\\rho_j), S(\\rho_{j+1}))\n    $$\n2.  **右边界** ($x=L$)：通量 $\\hat{f}_{N+1/2}$ 由内部状态 $\\rho_N$ 和外部下游状态 $\\rho_{\\mathrm{down}}$ 之间的黎曼问题确定：\n    $$\n    \\hat{f}_{N+1/2} = F_G(\\rho_N, \\rho_{\\mathrm{down}}) = \\min(D(\\rho_N), S(\\rho_{\\mathrm{down}}))\n    $$\n3.  **左边界** ($x=0$)：通量 $\\hat{f}_{1/2}$ 模拟一个汇合。它是进入区域的总流量，由上游主线需求 $d_m = D(\\rho_{\\mathrm{up}})$ 和匝道需求 $d_r = q_{\\mathrm{r}}$ 组合而成，并受第一个单元的供给 $S_1 = S(\\rho_1)$ 的限制。问题指定了主线和匝道的优先级分配比例分别为 $p$ 和 $1-p$。其建模方式为：首先根据这些比例分配可用供给 $S_1$，计算临时流量，然后允许其中一个流使用另一个流未使用的任何供给。主线 ($F_m$) 和匝道 ($F_r$) 的准入流量计算如下：\n    a. 基于分配的供给的临时流量：\n    $$ F'_m = \\min(d_m, p \\cdot S_1) \\quad \\text{and} \\quad F'_r = \\min(d_r, (1-p) \\cdot S_1) $$\n    b. 每个分配的未使用供给：\n    $$ S_{m,\\text{rem}} = p \\cdot S_1 - F'_m \\quad \\text{and} \\quad S_{r,\\text{rem}} = (1-p) \\cdot S_1 - F'_r $$\n    c. 重新分配未使用供给后的最终流量：\n    $$ F_m = F'_m + \\min(d_m - F'_m, S_{r,\\text{rem}}) $$\n    $$ F_r = F'_r + \\min(d_r - F'_r, S_{m,\\text{rem}}) $$\n    边界上的数值通量是总流入流量：\n    $$\n    \\hat{f}_{1/2} = F_m + F_r\n    $$\n\n匝道排队动态遵循一个蓄水池模型。排队数量 $Q(t)$（单位：车辆）根据以下公式演化：\n$$\n\\frac{dQ}{dt} = q_{\\mathrm{r}} - F_{\\mathrm{r}}(t)\n$$\n其中 $F_r(t)$ 是来自汇合求解器的匝道准入流量。用前向欧拉法离散化：\n$$\nQ^{n+1} = \\max(0, Q^n + \\Delta t (q_{\\mathrm{r}} - F^n_{\\mathrm{r}}))\n$$\n排队的物理长度为 $\\ell_{\\mathrm{q}}(t) = Q(t)/\\rho_{\\mathrm{j,r}}$。如果在 $[0,T]$ 内的任何时刻 $\\ell_{\\mathrm{q}}(t) \\ge L_{\\mathrm{ramp}}$，则发生溢出。\n\n为确保物理真实性，在每个时间步后，计算出的密度被裁剪到 $[0, \\rho_{\\max}]$ 范围内。模拟从均匀初始密度 $\\rho(x,0) = \\rho_{\\mathrm{init}}$ 和空匝道队列 $Q(0)=0$ 开始。对于每个测试用例，我们运行模拟直到时间 $T$，并记录是否曾满足溢出条件。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite for the DG0 traffic flow solver.\n    \"\"\"\n    test_cases = [\n        # Test Case 1 (happy path, no spillback expected)\n        {\n            'L': 1.0, 'N': 200, 'T': 200.0, 'CFL': 0.9,\n            'V_max': 0.03, 'rho_max': 180.0, 'rho_init': 40.0,\n            'rho_up': 60.0, 'rho_down': 40.0,\n            'q_r': 0.10, 'p': 0.70, 'L_ramp': 0.50, 'rho_j_r': 150.0\n        },\n        # Test Case 2 (congestion with queue growth, but no spillback)\n        {\n            'L': 1.0, 'N': 200, 'T': 200.0, 'CFL': 0.9,\n            'V_max': 0.03, 'rho_max': 180.0, 'rho_init': 40.0,\n            'rho_up': 80.0, 'rho_down': 160.0,\n            'q_r': 0.60, 'p': 0.70, 'L_ramp': 1.00, 'rho_j_r': 150.0\n        },\n        # Test Case 3 (congestion with spillback)\n        {\n            'L': 1.0, 'N': 200, 'T': 200.0, 'CFL': 0.9,\n            'V_max': 0.03, 'rho_max': 180.0, 'rho_init': 40.0,\n            'rho_up': 80.0, 'rho_down': 160.0,\n            'q_r': 1.20, 'p': 0.70, 'L_ramp': 0.20, 'rho_j_r': 150.0\n        }\n    ]\n\n    results = []\n    for params in test_cases:\n        result = run_simulation(**params)\n        results.append(result)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef run_simulation(L, N, T, CFL, V_max, rho_max, rho_init, \n                   rho_up, rho_down, q_r, p, L_ramp, rho_j_r):\n    \"\"\"\n    Executes the DG0 simulation for one set of parameters.\n\n    Returns:\n        int: 1 if spillback occurs, 0 otherwise.\n    \"\"\"\n    # Derived parameters\n    dx = L / N\n    dt = CFL * dx / V_max\n    rho_c = rho_max / 2.0\n    C = V_max * rho_max / 4.0\n\n    # Helper functions for the fundamental diagram\n    def f(rho):\n        return V_max * (rho - rho**2 / rho_max)\n\n    def D(rho):\n        return np.where(rho = rho_c, f(rho), C)\n\n    def S(rho):\n        return np.where(rho = rho_c, C, f(rho))\n\n    # Initialization\n    rho = np.full(N, rho_init, dtype=float)\n    Q = 0.0\n    t = 0.0\n    spillback_occurred = False\n    \n    num_steps = int(np.ceil(T / dt))\n\n    for _ in range(num_steps):\n        # Calculate fluxes at all N+1 interfaces\n        fluxes = np.zeros(N + 1, dtype=float)\n        \n        # --- Left boundary (x=0, interface j=1/2) ---\n        # Merge Riemann solver\n        d_m = D(np.array([rho_up]))[0] # D expects array, get scalar\n        d_r = q_r\n        s_1 = S(np.array([rho[0]]))[0]   # S expects array, get scalar\n        \n        # Provisional flows based on priority split of supply\n        F_m_prov = min(d_m, p * s_1)\n        F_r_prov = min(d_r, (1.0 - p) * s_1)\n\n        # Unused supply\n        s_m_rem = p * s_1 - F_m_prov\n        s_r_rem = (1.0 - p) * s_1 - F_r_prov\n\n        # Final flows with redistribution of unused supply\n        F_m = F_m_prov + min(d_m - F_m_prov, s_r_rem)\n        F_r = F_r_prov + min(d_r - F_r_prov, s_m_rem)\n\n        fluxes[0] = F_m + F_r\n        \n        # Store admitted ramp flow for queue update\n        F_r_admitted = F_r\n\n        # --- Interior interfaces (j=3/2 to N-1/2) ---\n        D_interior = D(rho[:-1])\n        S_interior = S(rho[1:])\n        fluxes[1:N] = np.minimum(D_interior, S_interior)\n\n        # --- Right boundary (x=L, interface j=N+1/2) ---\n        fluxes[N] = min(D(np.array([rho[-1]]))[0], S(np.array([rho_down]))[0])\n\n        # DG0/FVM update step (explicit Euler)\n        rho = rho - (dt / dx) * (fluxes[1:] - fluxes[:-1])\n        \n        # Clip densities to physical bounds\n        rho = np.clip(rho, 0.0, rho_max)\n\n        # Update queue dynamics\n        Q = max(0.0, Q + dt * (q_r - F_r_admitted))\n\n        # Check for spillback\n        if not spillback_occurred and (Q / rho_j_r) = L_ramp:\n            spillback_occurred = True\n            # Optimization: if problem only asks for occurrence, not time, we can stop.\n            break\n\n        t += dt\n    \n    return 1 if spillback_occurred else 0\n\nsolve()\n```", "id": "3377321"}, {"introduction": "许多物理系统，如河流或大气中的流动，是由包含源项的双曲方程（例如，重力在变化的河床高程上作用）来描述的。一个主要的挑战是确保数值格式能够正确地保持重要的物理稳态。这就引出了“良好平衡”（well-balanced）格式的概念，即为已知的稳态解（如静止湖泊）设计的通量散度离散与源项离散能够精确抵消。\n\n这个高级练习聚焦于浅水方程[@problem_id:3377340]。您将使用路径守恒方法推导一个良好平衡源项离散化的关键组成部分。这项练习为您提供了对为复杂双曲平衡律创建稳健且准确的DG格式所需的设计原则的深刻见解。", "problem": "考虑一维浅水方程，其描述了在固定底床地形上的水深 $h(x,t)$、速度 $u(x,t)$ 和河床高程 $b(x)$，其中重力加速度为 $g0$，\n$$\n\\partial_{t} h + \\partial_{x} (h u) = 0, \\qquad \\partial_{t} (h u) + \\partial_{x}\\!\\left(h u^{2} + \\frac{g}{2} h^{2}\\right) = - g h \\,\\partial_{x} b.\n$$\n静湖状态定义为 $u(x,t) = 0$ 且自由水面高程 $H(x) = h(x,t) + b(x)$ 等于一个空间常数 $H_{0}$，因此 $h(x,t) = H_{0} - b(x)$。\n\n在用于上述双曲系统的间断伽辽金（DG）方法中，考虑在一个单元 $K = [x_{L}, x_{R}]$ 上使用测试函数 $\\varphi(x)$ 的动量方程的弱形式。其中，静水压力通量 $\\frac{g}{2} h^{2}$ 通过分部积分处理，并在单元边界处被一个相容的数值通量替代，而源项 $-g h\\,\\partial_{x} b$ 则使用从非守恒积形式导出的路径守恒界面贡献进行离散化。具体来说，在具有左右迹 $(b_{L}, h_{L})$ 和 $(b_{R}, h_{R})$ 的界面上，界面源贡献取为：\n$$\nS_{\\text{face}} = g\\,\\varphi(x_{f})\\,n_{f}\\,\\int_{0}^{1} h(s)\\,\\mathrm{d}b(s),\n$$\n其中 $x_{f}$ 是界面位置，$n_{f} \\in \\{-1,+1\\}$ 是单元在该界面处的外向单位法向量，直线路径通过 $b(s) = (1-s)\\,b_{L} + s\\,b_{R}$ 连接左右界面状态，并且静湖关系 $h(s) = H_{0} - b(s)$ 在路径上逐点强制满足。\n\n仅从上述浅水模型、静湖特性和DG弱形式构造出发，推导直线路径的界面源贡献的闭式解析表达式：\n$$\nS_{\\text{face}} = g\\,\\varphi(x_{f})\\,n_{f}\\,\\int_{0}^{1} h(s)\\,\\mathrm{d}b(s),\n$$\n该表达式应纯粹用 $g$、$H_{0}$、$b_{L}$ 和 $b_{R}$ 来表示。你的最终答案必须是 $g\\int_{0}^{1} h(s)\\,\\mathrm{d}b(s)$ 的单一解析表达式；最终表达式中不应包含 $\\varphi(x_{f})$ 或 $n_{f}$。不需要进行数值取整，最终答案中也不应报告单位。", "solution": "目标是为界面源贡献项，特别是量 $g\\int_{0}^{1} h(s)\\,\\mathrm{d}b(s)$，推导一个闭式解析表达式。该项出现在用于浅水方程的路径守恒间断伽辽金格式中。\n\n问题为连接单元界面处左状态 $(b_{L}, h_{L})$ 和右状态 $(b_{R}, h_{R})$ 的路径提供了以下定义：\n1.  由 $s \\in [0, 1]$ 参数化的河床高程 $b(s)$ 的直线路径：\n    $$b(s) = (1-s)b_{L} + s\\,b_{R}$$\n2.  沿此路径的水深 $h(s)$ 由静湖条件 $h(s) + b(s) = H_{0}$ 确定，其中 $H_{0}$ 是恒定的自由水面高程。这给出：\n    $$h(s) = H_{0} - b(s)$$\n\n需要计算的量是路径积分 $g\\int_{0}^{1} h(s)\\,\\mathrm{d}b(s)$。这在形式上是一个黎曼-斯蒂尔杰斯积分。我们可以通过将积分变量从参数 $s$ 更改为底床地形变量 $b$ 来计算它。\n\n$b(s)$ 的路径从 $s=0$ 开始，到 $s=1$ 结束。我们来计算 $b$ 的相应值：\n-   在 $s=0$ 时，路径的起点是 $b(0) = (1-0)b_{L} + (0)b_{R} = b_{L}$。\n-   在 $s=1$ 时，路径的终点是 $b(1) = (1-1)b_{L} + (1)b_{R} = b_{R}$。\n\n被积函数是 $h(s)$，它被定义为 $b(s)$ 的函数：$h(s) = H_{0} - b(s)$。由于积分是关于 $b$ 的，我们可以将被积函数直接表示为 $b$ 的函数，即 $H_{0} - b$。\n\n通过这些代换，积分从参数 $s \\in [0, 1]$ 上的黎曼-斯蒂尔杰斯积分转换为变量 $b$ 上从 $b_{L}$ 到 $b_{R}$ 的标准黎曼积分：\n$$ \\int_{0}^{1} h(s)\\,\\mathrm{d}b(s) = \\int_{b_{L}}^{b_{R}} (H_{0} - b)\\,\\mathrm{d}b $$\n\n我们现在计算这个定积分。被积函数 $(H_{0} - b)$ 关于 $b$ 的原函数是：\n$$ \\int (H_{0} - b)\\,\\mathrm{d}b = H_{0}b - \\frac{1}{2}b^{2} $$\n\n在积分的上限 $b_{R}$ 和下限 $b_{L}$ 处计算该原函数的值，得到：\n$$ \\left[ H_{0}b - \\frac{1}{2}b^{2} \\right]_{b_{L}}^{b_{R}} = \\left(H_{0}b_{R} - \\frac{1}{2}b_{R}^{2}\\right) - \\left(H_{0}b_{L} - \\frac{1}{2}b_{L}^{2}\\right) $$\n\n我们可以按 $H_{0}$ 和二次项对各项进行分组：\n$$ H_{0}(b_{R} - b_{L}) - \\frac{1}{2}(b_{R}^{2} - b_{L}^{2}) $$\n\n为得到更紧凑的形式，我们使用平方差因式分解 $b_{R}^{2} - b_{L}^{2} = (b_{R} - b_{L})(b_{R} + b_{L})$：\n$$ H_{0}(b_{R} - b_{L}) - \\frac{1}{2}(b_{R} - b_{L})(b_{R} + b_{L}) $$\n\n提取公因式 $(b_{R} - b_{L})$ 得到：\n$$ (b_{R} - b_{L}) \\left[ H_{0} - \\frac{1}{2}(b_{R} + b_{L}) \\right] = (b_{R} - b_{L}) \\left( H_{0} - \\frac{b_{L} + b_{R}}{2} \\right) $$\n这个表达式代表了积分 $\\int_{0}^{1} h(s)\\,\\mathrm{d}b(s)$ 的值。\n\n问题要求界面源贡献项的完整表达式，即 $g\\int_{0}^{1} h(s)\\,\\mathrm{d}b(s)$。我们将积分结果乘以重力加速度 $g$：\n$$ g\\int_{0}^{1} h(s)\\,\\mathrm{d}b(s) = g(b_{R} - b_{L})\\left(H_{0} - \\frac{b_{L} + b_{R}}{2}\\right) $$\n这就是用指定的变量 $g$、$H_{0}$、$b_{L}$ 和 $b_{R}$ 表示的最终解析表达式。", "answer": "$$\\boxed{g(b_{R} - b_{L})\\left(H_{0} - \\frac{b_{L} + b_{R}}{2}\\right)}$$", "id": "3377340"}]}