{"hands_on_practices": [{"introduction": "在处理加权蒙特卡洛事件时，首要任务是量化权重变化对统计精度的影响。此练习引导您推导“有效样本数”($N_{\\text{eff}}$)的概念，这是一个关键指标，用于衡量加权样本的统计效力，并将其与等效的未加权样本进行比较。通过完成这项实践[@problem_id:3513799]，您将理解为何权重分布的方差会降低分析的精度，以及如何精确地评估这种影响。", "problem": "在计算高能物理中，事件生成器通常会产生带有正权重 $w_i>0$ 的模拟事件，这些权重反映了微分截面因子或重要性抽样调整。考虑使用 $N$ 个独立的事件级贡献 $Y_i$ 来估计一个标量可观测量，这些贡献在目标物理分布下具有共同的有限方差 $\\sigma^2$。一个标准的自归一化加权估计量构造为 $\\hat{\\mu}=\\sum_{i=1}^{N}\\alpha_i Y_i$，其中归一化系数为 $\\alpha_i=w_i/\\sum_{j=1}^{N}w_j$。利用独立随机变量线性组合的方差法则和 $\\{\\alpha_i\\}$ 上的归一化约束，通过将 $\\hat{\\mu}$ 的方差与未加权样本均值的方差进行匹配，来定义有效样本量 $N_{\\text{eff}}$ 的概念。对权重 $\\{2,1,1,0.5\\}$ 数值计算 $N_{\\text{eff}}$，并从统计功效的角度解释 $N_{\\text{eff}}$。\n\n选择所有正确的陈述：\n\nA. 对于具有共同方差 $\\sigma^2$ 的独立事件贡献，自归一化加权估计量的方差满足 $\\operatorname{Var}(\\hat{\\mu})=\\sigma^2\\sum_{i=1}^{N}\\alpha_i^2$，并且令 $\\operatorname{Var}(\\hat{\\mu})=\\sigma^2/N_{\\text{eff}}$ 可得 $N_{\\text{eff}}=\\left(\\sum_{i=1}^{N}w_i\\right)^2\\Big/\\left(\\sum_{i=1}^{N}w_i^2\\right)$。\n\nB. 对于任何非负权重的选择，总是有 $N_{\\text{eff}}\\geq N$。\n\nC. 数量 $N_{\\text{eff}}$ 等于严格为正的权重的数量。\n\nD. 当且仅当所有权重在相差一个共同的缩放因子下是相同的，即对于某个常数 $c>0$ 和所有 $i$ 都有 $w_i=c$ 时，我们有 $N_{\\text{eff}}=N$。\n\nE. 对于权重 $\\{2,1,1,0.5\\}$，$N_{\\text{eff}}$ 为 $3.24$，因此 $\\operatorname{Var}(\\hat{\\mu})=\\sigma^2/3.24$，这在统计功效的意义上，与从 $3.24$ 个独立的、等权重的事件计算出的未加权均值的方差相匹配。\n\nF. 在接受-拒绝去加权法中，对于归一化常数 $w_{\\max}=\\max_i w_i$，接受概率为 $\\min\\{1,w_i/w_{\\max}\\}$ 时，接受事件的期望数量等于 $N_{\\text{eff}}$。", "solution": "问题陈述在计算物理的统计数据分析背景下提出了一个定义明确的问题。它要求推导和解释加权样本的有效样本量 $N_{\\text{eff}}$。所有提供的信息在科学上都是合理的、自洽的，并且足以进行严格求解。因此，该问题是有效的。\n\n核心任务是通过比较加权均值的方差和未加权均值的方差来定义有效样本量 $N_{\\text{eff}}$。\n\n令 $N$ 个权重组成的集合为 $\\{w_1, w_2, \\ldots, w_N\\}$，其中 $w_i > 0$。标量可观测量 $\\mu$ 的加权估计量由下式给出：\n$$ \\hat{\\mu} = \\sum_{i=1}^{N} \\alpha_i Y_i $$\n其中 $Y_i$ 是具有共同方差 $\\operatorname{Var}(Y_i) = \\sigma^2$ 的独立贡献，且系数 $\\alpha_i$ 是归一化权重：\n$$ \\alpha_i = \\frac{w_i}{\\sum_{j=1}^{N} w_j} $$\n这些系数满足归一化条件 $\\sum_{i=1}^{N} \\alpha_i = 1$。\n\n估计量 $\\hat{\\mu}$ 的方差是使用独立随机变量线性组合的方差性质 $\\operatorname{Var}\\left(\\sum_i c_i X_i\\right) = \\sum_i c_i^2 \\operatorname{Var}(X_i)$ 计算的。在我们的例子中，系数是 $\\alpha_i$，在此计算中被视作常数。\n$$ \\operatorname{Var}(\\hat{\\mu}) = \\operatorname{Var}\\left(\\sum_{i=1}^{N} \\alpha_i Y_i\\right) = \\sum_{i=1}^{N} \\alpha_i^2 \\operatorname{Var}(Y_i) = \\sum_{i=1}^{N} \\alpha_i^2 \\sigma^2 = \\sigma^2 \\sum_{i=1}^{N} \\alpha_i^2 $$\n\n$M$ 个独立事件的未加权均值 $\\bar{Y} = \\frac{1}{M}\\sum_{i=1}^{M} Y_i$ 的方差为：\n$$ \\operatorname{Var}(\\bar{Y}) = \\operatorname{Var}\\left(\\frac{1}{M}\\sum_{i=1}^{M} Y_i\\right) = \\frac{1}{M^2} \\sum_{i=1}^{M} \\operatorname{Var}(Y_i) = \\frac{1}{M^2} (M \\sigma^2) = \\frac{\\sigma^2}{M} $$\n\n有效样本量 $N_{\\text{eff}}$ 是通过将加权估计量 $\\hat{\\mu}$ 的方差与 $N_{\\text{eff}}$ 个事件的未加权均值的方差相等来定义的：\n$$ \\operatorname{Var}(\\hat{\\mu}) = \\frac{\\sigma^2}{N_{\\text{eff}}} $$\n代入我们对 $\\operatorname{Var}(\\hat{\\mu})$ 的表达式：\n$$ \\sigma^2 \\sum_{i=1}^{N} \\alpha_i^2 = \\frac{\\sigma^2}{N_{\\text{eff}}} $$\n$$ N_{\\text{eff}} = \\frac{1}{\\sum_{i=1}^{N} \\alpha_i^2} $$\n现在，我们将用原始权重 $w_i$ 表示的 $\\alpha_i$ 的定义代入。令 $W = \\sum_{j=1}^{N} w_j$。\n$$ N_{\\text{eff}} = \\frac{1}{\\sum_{i=1}^{N} \\left(\\frac{w_i}{W}\\right)^2} = \\frac{1}{\\frac{1}{W^2} \\sum_{i=1}^{N} w_i^2} = \\frac{W^2}{\\sum_{i=1}^{N} w_i^2} $$\n因此，有效样本量的公式是：\n$$ N_{\\text{eff}} = \\frac{\\left(\\sum_{i=1}^{N} w_i\\right)^2}{\\sum_{i=1}^{N} w_i^2} $$\n\n现在，我们评估每个选项。\n\n**A. 对于具有共同方差 $\\sigma^2$ 的独立事件贡献，自归一化加权估计量的方差满足 $\\operatorname{Var}(\\hat{\\mu})=\\sigma^2\\sum_{i=1}^{N}\\alpha_i^2$，并且令 $\\operatorname{Var}(\\hat{\\mu})=\\sigma^2/N_{\\text{eff}}$ 可得 $N_{\\text{eff}}=\\left(\\sum_{i=1}^{N}w_i\\right)^2\\Big/\\left(\\sum_{i=1}^{N}w_i^2\\right)$。**\n我们上面的推导证实了这个陈述的两个部分。方差计算是正确的，得到的 $N_{\\text{eff}}$ 表达式也是正确的。\n结论：**正确**。\n\n**B. 对于任何非负权重的选择，总是有 $N_{\\text{eff}}\\geq N$。**\n为了评估这一点，我们将 $N_{\\text{eff}} = \\frac{(\\sum w_i)^2}{\\sum w_i^2}$ 与 $N$ 进行比较。\n考虑 $\\mathbb{R}^N$ 中两个向量 $u = (w_1, \\ldots, w_N)$ 和 $v = (1, \\ldots, 1)$ 的柯西-施瓦茨不等式：\n$$ \\left(\\sum_{i=1}^{N} u_i v_i\\right)^2 \\leq \\left(\\sum_{i=1}^{N} u_i^2\\right) \\left(\\sum_{i=1}^{N} v_i^2\\right) $$\n$$ \\left(\\sum_{i=1}^{N} w_i \\cdot 1\\right)^2 \\leq \\left(\\sum_{i=1}^{N} w_i^2\\right) \\left(\\sum_{i=1}^{N} 1^2\\right) $$\n$$ \\left(\\sum_{i=1}^{N} w_i\\right)^2 \\leq \\left(\\sum_{i=1}^{N} w_i^2\\right) \\cdot N $$\n由于权重是正的，$\\sum w_i^2 > 0$，所以我们可以用它来除，而不用改变不等式的方向：\n$$ \\frac{\\left(\\sum_{i=1}^{N} w_i\\right)^2}{\\sum_{i=1}^{N} w_i^2} \\leq N $$\n这意味着 $N_{\\text{eff}} \\leq N$。该陈述声称 $N_{\\text{eff}} \\geq N$，这与事实相反。因此，该陈述是错误的。权重的差异减小了有效样本量。\n结论：**不正确**。\n\n**C. 数量 $N_{\\text{eff}}$ 等于严格为正的权重的数量。**\n问题提供了一组特定的权重进行检验：$w = \\{2, 1, 1, 0.5\\}$。这里，事件数量为 $N=4$，所有权重都严格为正。\n让我们为这组权重计算 $N_{\\text{eff}}$：\n$$ \\sum_{i=1}^{4} w_i = 2 + 1 + 1 + 0.5 = 4.5 $$\n$$ \\sum_{i=1}^{4} w_i^2 = 2^2 + 1^2 + 1^2 + 0.5^2 = 4 + 1 + 1 + 0.25 = 6.25 $$\n$$ N_{\\text{eff}} = \\frac{(4.5)^2}{6.25} = \\frac{20.25}{6.25} = 3.24 $$\n严格为正的权重的数量是 $4$，但 $N_{\\text{eff}} = 3.24$。因此，$3.24 \\neq 4$。该陈述是错误的。\n结论：**不正确**。\n\n**D. 当且仅当所有权重在相差一个共同的缩放因子下是相同的，即对于某个常数 $c>0$ 和所有 $i$ 都有 $w_i=c$ 时，我们有 $N_{\\text{eff}}=N$。**\n短语“在相差一个共同的缩放因子下是相同的”被“即 $w_i=c$ 对于某个常数 $c>0$”所阐明。这意味着我们必须检验条件 $w_1 = w_2 = \\ldots = w_N = c > 0$。\n选项B中使用的柯西-施瓦茨不等式的等号成立，当且仅当向量 $u$ 和 $v$ 线性相关，即对于某个标量 $k$ 有 $u=kv$。\n在我们的例子中，$u = (w_1, \\ldots, w_N)$ 且 $v=(1, \\ldots, 1)$。线性相关意味着对所有 $i$ 都有 $w_i = k \\cdot 1$。由于权重是正的， $k$ 必须是一个正常数，我们称之为 $c$。因此，$N_{\\text{eff}} = N$ 当且仅当对所有 $i$ 都有 $w_i = c$。\n该陈述是正确的。它精确地描述了最大有效样本量的条件。\n结论：**正确**。\n\n**E. 对于权重 $\\{2,1,1,0.5\\}$，$N_{\\text{eff}}$ 为 $3.24$，因此 $\\operatorname{Var}(\\hat{\\mu})=\\sigma^2/3.24$，这在统计功效的意义上，与从 $3.24$ 个独立的、等权重的事件计算出的未加权均值的方差相匹配。**\n选项C中的计算表明，对于给定的权重，$N_{\\text{eff}} = 3.24$ 是正确的。\n根据 $N_{\\text{eff}}$ 的定义，我们有 $\\operatorname{Var}(\\hat{\\mu}) = \\sigma^2 / N_{\\text{eff}}$，即 $\\sigma^2 / 3.24$。这是正确的。\n$M$ 个事件的未加权均值的方差是 $\\sigma^2/M$。对于一个包含 $M=3.24$ 个事件的假设样本，其方差确实会是 $\\sigma^2/3.24$。\n对于关于均值的检验，统计功效是估计量标准误 $\\sqrt{\\operatorname{Var}(\\hat{\\mu})}$ 的函数。由于加权均值的方差在数学上等同于3.24个事件的未加权均值的方差，因此统计功效是相同的。这种解释是合理的，并代表了 $N_{\\text{eff}}$ 概念的根本目的。\n结论：**正确**。\n\n**F. 在接受-拒绝去加权法中，对于归一化常数 $w_{\\max}=\\max_i w_i$，接受概率为 $\\min\\{1,w_i/w_{\\max}\\}$ 时，接受事件的期望数量等于 $N_{\\text{eff}}$。**\n第 $i$ 个事件的接受概率是 $p_i = w_i/w_{\\max}$（因为 $w_i \\le w_{\\max}$，$\\min$ 是多余的）。接受或拒绝每个事件的过程是一个伯努利试验。接受事件的期望数量 $E[N_{\\text{acc}}]$ 是所有 $N$ 个初始事件的单个接受概率之和：\n$$ E[N_{\\text{acc}}] = \\sum_{i=1}^{N} p_i = \\sum_{i=1}^{N} \\frac{w_i}{w_{\\max}} = \\frac{1}{w_{\\max}} \\sum_{i=1}^{N} w_i $$\n该陈述声称 $E[N_{\\text{acc}}] = N_{\\text{eff}}$。让我们用给定的权重 $w = \\{2, 1, 1, 0.5\\}$ 来检验这一点。\n我们有 $w_{\\max} = \\max\\{2, 1, 1, 0.5\\} = 2$ 和 $\\sum w_i = 4.5$。\n$$ E[N_{\\text{acc}}] = \\frac{4.5}{2} = 2.25 $$\n从选项C中，我们知道 $N_{\\text{eff}} = 3.24$。\n由于 $2.25 \\neq 3.24$，该陈述是错误的。这是两个描述加权样本不同属性的不同量。它们仅在所有权重都相同的平凡情况下才相等。\n结论：**不正确**。", "answer": "$$\\boxed{ADE}$$", "id": "3513799"}, {"introduction": "认识到大权重事件会显著增加方差后，一个自然的策略便是设计算法来控制这些权重。此练习[@problem_id:3513734]介绍了一种实用的“部分退加权”方案，它是一种混合方法，旨在平衡效率和方差。该方法对权重低于某个阈值 $w_c$ 的事件进行退加权处理，以降低其对总体方差的贡献，同时保留高权重事件，以捕捉重要的物理过程。通过推导这种组合估计量及其方差，您将掌握在保持估计无偏性的前提下，如何设计和分析旨在优化蒙特卡洛模拟性能的复杂算法。", "problem": "在一个用于高能物理过程的蒙特卡洛（MC）模拟中，目标是估计由积分 $\\sigma = \\int \\sigma(x) \\,\\mathrm{d}x$ 定义的总截面 $\\sigma$，其中 $x$ 标记了末态运动学，$\\sigma(x) \\ge 0$ 是微分截面。事件通过从一个建议密度 $g(x)$ 进行重要性采样生成，每个事件 $x$ 带有一个权重 $w(x) = \\sigma(x)/g(x)$。设 $w$ 表示当 $x \\sim g(x)$ 时事件权重的随机变量。假设事件是独立同分布的，其权重概率密度为 $\\rho(w)$，支撑集为 $[0,\\infty)$，且具有有限的一阶矩和二阶矩。\n\n考虑以下使用固定阈值 $w_c > 0$ 的部分去权重方案：对于权重为 $w  w_c$ 的事件，通过以概率 $w/w_c$ 接受该事件来进行去权重，并在接受后为其分配恒定权重 $w_c$；对于权重为 $w \\ge w_c$ 的事件，保留原始的带权事件，不作修改。定义一个实现此规则的组合估计量的单个事件贡献 $Y$。对于一个包含 $N$ 个独立事件的样本，其权重为 $(w_1,\\dots,w_N)$，并使用独立的伯努利试验 $(B_1,\\dots,B_N)$ 进行去权重，其中 $\\mathbb{P}(B_i = 1 \\mid w_i) = \\min(1, w_i/w_c)$，基于 $(Y_1,\\dots,Y_N)$ 定义 $\\sigma$ 的一个组合估计量 $\\hat{\\sigma}_{\\mathrm{pu}}$。\n\n仅从重要性采样的定义、标准MC估计量 $\\hat{\\sigma} = \\frac{1}{N}\\sum_{i=1}^{N} w_i$ 的无偏性，以及全期望和全方差定律出发，推导组合估计量 $\\hat{\\sigma}_{\\mathrm{pu}}$ 在部分去权重方案下的显式表达式及其方差 $\\mathrm{Var}(\\hat{\\sigma}_{\\mathrm{pu}})$ 的闭式形式。用 $N$、$w_c$ 以及关于 $\\rho(w)$ 的期望值（例如 $\\mathbb{E}[w]$、$\\mathbb{E}[w \\,\\mathbf{1}_{\\{w  w_c\\}}]$ 和 $\\mathbb{E}[w^{2} \\,\\mathbf{1}_{\\{w \\ge w_c\\}}]$）来表示你的最终结果。不需要进行数值近似。将估计量及其方差的表达式作为你的最终答案。不包括单位。", "solution": "问题陈述已经过验证，被认为是可靠、适定且有科学依据的。我们可以开始求解。\n\n目标是推导部分去权重估计量 $\\hat{\\sigma}_{\\mathrm{pu}}$ 及其方差 $\\mathrm{Var}(\\hat{\\sigma}_{\\mathrm{pu}})$ 的显式表达式。该估计量由一组 $N$ 个独立同分布（i.i.d.）的事件构建。对于每个事件 $i$，我们有一个初始权重 $w_i$ 和一个相应的对估计量的单事件贡献 $Y_i$。\n\n首先，我们根据所描述的部分去权重方案，将单个事件的贡献 $Y_i$ 形式化。设 $w$ 为单个事件的权重。该方案依赖于一个固定的正阈值 $w_c$。\n- 如果 $w  w_c$，事件以概率 $p = w/w_c$ 被接受。一旦接受，其贡献为恒定权重 $w_c$。如果被拒绝（概率为 $1-p$），其贡献为 $0$。这个结果可以用随机变量 $B w_c$ 来建模，其中 $B$ 是一个参数为 $p=w/w_c$ 的伯努利随机变量，即 $\\mathbb{P}(B=1|w) = w/w_c$。\n- 如果 $w \\ge w_c$，事件以其原始权重 $w$ 被保留。其贡献确定性地为 $w$。\n\n我们可以使用指示函数来表示权重为 $w$ 的单个事件的贡献 $Y$。设 $\\mathbf{1}_{\\{w  w_c\\}}$ 为条件 $w  w_c$ 的指示函数，$\\mathbf{1}_{\\{w \\ge w_c\\}}$ 为 $w \\ge w_c$ 的指示函数。贡献 $Y$ 是一个定义如下的随机变量：\n$$Y = (B w_c) \\mathbf{1}_{\\{w  w_c\\}} + w \\mathbf{1}_{\\{w \\ge w_c\\}}$$\n其中 $B$ 是一个伯努利随机变量，以 $w$ 为条件，其 $\\mathbb{P}(B=1|w) = w/w_c$。对于 $w \\ge w_c$，第一项为零，且 $Y=w$。\n\n对于一个包含 $N$ 个独立同分布事件的样本，组合估计量 $\\hat{\\sigma}_{\\mathrm{pu}}$ 是单个贡献 $Y_i$ 的样本均值：\n$$\\hat{\\sigma}_{\\mathrm{pu}} = \\frac{1}{N} \\sum_{i=1}^{N} Y_i$$\n其中每个 $Y_i$ 由其对应的权重 $w_i$ 构建：\n$$Y_i = (B_i w_c) \\mathbf{1}_{\\{w_i  w_c\\}} + w_i \\mathbf{1}_{\\{w_i \\ge w_c\\}}$$\n这里，$B_i$ 是独立的伯努利变量，对于每个 $w_i  w_c$ 的事件 $i$，其参数为 $w_i/w_c$。这就给出了估计量的显式表达式。\n\n接下来，我们证明该估计量对于 $\\sigma$ 是无偏的。如果一个估计量的期望等于真实值，则该估计量是无偏的。由于 $Y_i$ 是独立同分布的，该估计量的期望为：\n$$\\mathbb{E}[\\hat{\\sigma}_{\\mathrm{pu}}] = \\mathbb{E}\\left[\\frac{1}{N} \\sum_{i=1}^{N} Y_i\\right] = \\frac{1}{N} \\sum_{i=1}^{N} \\mathbb{E}[Y_i] = \\mathbb{E}[Y]$$\n我们使用全期望定律计算 $\\mathbb{E}[Y]$：$\\mathbb{E}[Y] = \\mathbb{E}_w[\\mathbb{E}[Y|w]]$。\n首先，我们求在给定权重 $w$ 的条件下 $Y$ 的条件期望：\n- 如果 $w  w_c$：$Y = B w_c$。\n$$\\mathbb{E}[Y|w] = \\mathbb{E}[B w_c | w] = w_c \\mathbb{E}[B|w] = w_c \\left( \\frac{w}{w_c} \\right) = w$$\n- 如果 $w \\ge w_c$：$Y = w$，在给定 $w$ 的情况下是常数。\n$$\\mathbb{E}[Y|w] = \\mathbb{E}[w|w] = w$$\n在这两种情况下，我们都发现 $\\mathbb{E}[Y|w] = w$。这意味着对于任何给定的事件权重，该过程都是无偏的。\n现在，我们对所有可能的 $w$ 值求期望：\n$$\\mathbb{E}[Y] = \\mathbb{E}_w[\\mathbb{E}[Y|w]] = \\mathbb{E}_w[w]$$\n问题陈述指出，标准蒙特卡洛估计量 $\\hat{\\sigma} = \\frac{1}{N}\\sum w_i$ 对于 $\\sigma = \\int \\sigma(x) dx$ 是无偏的。这意味着 $\\mathbb{E}[w] = \\sigma$。\n因此，$\\mathbb{E}[\\hat{\\sigma}_{\\mathrm{pu}}] = \\mathbb{E}[Y] = \\mathbb{E}[w] = \\sigma$。估计量 $\\hat{\\sigma}_{\\mathrm{pu}}$ 是无偏的。\n\n最后，我们推导估计量的方差 $\\mathrm{Var}(\\hat{\\sigma}_{\\mathrm{pu}})$。由于 $Y_i$ 是独立同分布的，它们的和的方差是它们方差的和：\n$$\\mathrm{Var}(\\hat{\\sigma}_{\\mathrm{pu}}) = \\mathrm{Var}\\left(\\frac{1}{N} \\sum_{i=1}^{N} Y_i\\right) = \\frac{1}{N^2} \\sum_{i=1}^{N} \\mathrm{Var}(Y_i) = \\frac{1}{N} \\mathrm{Var}(Y)$$\n为了计算 $\\mathrm{Var}(Y)$，我们使用全方差定律（也称为方差分解公式）：\n$$\\mathrm{Var}(Y) = \\mathbb{E}_w[\\mathrm{Var}(Y|w)] + \\mathrm{Var}_w(\\mathbb{E}[Y|w])$$\n我们已经计算出内部的条件期望 $\\mathbb{E}[Y|w] = w$。因此第二项是：\n$$\\mathrm{Var}_w(\\mathbb{E}[Y|w]) = \\mathrm{Var}_w(w) = \\mathbb{E}[w^2] - (\\mathbb{E}[w])^2 = \\mathbb{E}[w^2] - \\sigma^2$$\n现在我们计算第一项 $\\mathbb{E}_w[\\mathrm{Var}(Y|w)]$。首先，我们求条件方差 $\\mathrm{Var}(Y|w)$：\n- 如果 $w  w_c$：$Y = B w_c$。\n$$\\mathrm{Var}(Y|w) = \\mathrm{Var}(B w_c | w) = w_c^2 \\mathrm{Var}(B|w)$$\n对于参数为 $p=w/w_c$ 的伯努利变量 $B$，其方差为 $p(1-p)$。\n$$\\mathrm{Var}(Y|w) = w_c^2 \\left(\\frac{w}{w_c}\\right) \\left(1 - \\frac{w}{w_c}\\right) = w_c w \\left(1 - \\frac{w}{w_c}\\right) = w_c w - w^2$$\n- 如果 $w \\ge w_c$：$Y=w$，在给定 $w$ 的情况下是常数。\n$$\\mathrm{Var}(Y|w) = 0$$\n我们可以将其紧凑地写为：$\\mathrm{Var}(Y|w) = (w_c w - w^2)\\mathbf{1}_{\\{w  w_c\\}}$。\n接下来，我们对这个条件方差关于 $w$ 求期望：\n$$\\mathbb{E}_w[\\mathrm{Var}(Y|w)] = \\mathbb{E}[(w_c w - w^2)\\mathbf{1}_{\\{w  w_c\\}}] = \\mathbb{E}[w_c w \\mathbf{1}_{\\{w  w_c\\}}] - \\mathbb{E}[w^2 \\mathbf{1}_{\\{w  w_c\\}}]$$\n$$= w_c \\mathbb{E}[w \\mathbf{1}_{\\{w  w_c\\}}] - \\mathbb{E}[w^2 \\mathbf{1}_{\\{w  w_c\\}}]$$\n现在，组合得到总方差 $\\mathrm{Var}(Y)$：\n$$\\mathrm{Var}(Y) = \\left( w_c \\mathbb{E}[w \\mathbf{1}_{\\{w  w_c\\}}] - \\mathbb{E}[w^2 \\mathbf{1}_{\\{w  w_c\\}}] \\right) + \\left( \\mathbb{E}[w^2] - (\\mathbb{E}[w])^2 \\right)$$\n我们可以将项 $\\mathbb{E}[w^2]$ 分解为 $\\mathbb{E}[w^2] = \\mathbb{E}[w^2 \\mathbf{1}_{\\{w  w_c\\}}] + \\mathbb{E}[w^2 \\mathbf{1}_{\\{w \\ge w_c\\}}]$。将其代入方差表达式中得到：\n$$\\mathrm{Var}(Y) = w_c \\mathbb{E}[w \\mathbf{1}_{\\{w  w_c\\}}] - \\mathbb{E}[w^2 \\mathbf{1}_{\\{w  w_c\\}}] + \\mathbb{E}[w^2 \\mathbf{1}_{\\{w  w_c\\}}] + \\mathbb{E}[w^2 \\mathbf{1}_{\\{w \\ge w_c\\}}] - (\\mathbb{E}[w])^2$$\n项 $\\mathbb{E}[w^2 \\mathbf{1}_{\\{w  w_c\\}}]$ 相互抵消，得到：\n$$\\mathrm{Var}(Y) = w_c \\mathbb{E}[w \\mathbf{1}_{\\{w  w_c\\}}] + \\mathbb{E}[w^2 \\mathbf{1}_{\\{w \\ge w_c\\}}] - (\\mathbb{E}[w])^2$$\n此表达式符合要求的格式。因此，估计量 $\\hat{\\sigma}_{\\mathrm{pu}}$ 的方差为：\n$$\\mathrm{Var}(\\hat{\\sigma}_{\\mathrm{pu}}) = \\frac{1}{N} \\left( w_c \\mathbb{E}[w \\mathbf{1}_{\\{w  w_c\\}}] + \\mathbb{E}[w^2 \\mathbf{1}_{\\{w \\ge w_c\\}}] - (\\mathbb{E}[w])^2 \\right)$$\n关于估计量及其方差的这些结果就是所要求的最终表达式。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\hat{\\sigma}_{\\mathrm{pu}} = \\frac{1}{N} \\sum_{i=1}^{N} \\left( B_i w_c \\mathbf{1}_{\\{w_i  w_c\\}} + w_i \\mathbf{1}_{\\{w_i \\ge w_c\\}} \\right) \\\\ \\mathrm{Var}(\\hat{\\sigma}_{\\mathrm{pu}}) = \\frac{1}{N} \\left( w_c \\mathbb{E}[w \\mathbf{1}_{\\{w  w_c\\}}] + \\mathbb{E}[w^2 \\mathbf{1}_{\\{w \\ge w_c\\}}] - (\\mathbb{E}[w])^2 \\right)\n\\end{pmatrix}\n}\n$$", "id": "3513734"}, {"introduction": "现代高能物理计算中的一个高级挑战是如何处理来源于高阶量子修正的负权重事件。此练习[@problem_id:3513801]探讨了一种名为“带符号泊松稀疏化”的先进技术，该技术能将单个带权重的事件（$w = w_{+} - w_{-}$）转化为一组带正负号的未加权事件。这种转换极大地简化了后续的直方图填充和分析。通过理论推导和编程实现，您将验证该方法的无偏性，并理解负权重如何导致方差膨胀，从而为处理复杂的NLO及更高阶模拟数据提供一个强大的工具。", "problem": "你的任务是形式化并测试一个用于处理计算高能物理中负事件权重的带符号泊松稀疏化过程。考虑一个权重被分解为 $w = w_{+} - w_{-}$ (其中 $w_{+} \\ge 0$ 且 $w_{-} \\ge 0$) 的单个加权事件。目标是通过由两个独立泊松随机变量构建的带符号无权样本来表示该事件，并研究其无偏性和方差性质，包括负权重对方法差膨胀的影响。\n\n从以下基本事实出发：\n- 如果 $N \\sim \\mathrm{Poisson}(\\lambda)$，那么对任意 $\\lambda \\ge 0$，有 $\\mathbb{E}[N] = \\lambda$ 和 $\\mathrm{Var}[N] = \\lambda$。\n- 如果 $X$ 和 $Y$ 是独立随机变量，那么 $\\mathbb{E}[X \\pm Y] = \\mathbb{E}[X] \\pm \\mathbb{E}[Y]$ 且 $\\mathrm{Var}[X \\pm Y] = \\mathrm{Var}[X] + \\mathrm{Var}[Y]$。\n- 对任意常数 $c$，有 $\\mathbb{E}[c X] = c\\,\\mathbb{E}[X]$ 且 $\\mathrm{Var}[c X] = c^{2}\\,\\mathrm{Var}[X]$。\n\n对于选定的单位尺度 $a  0$，定义带符号泊松稀疏化估计量如下。抽取两个独立的泊松随机变量 $N_{+} \\sim \\mathrm{Poisson}(\\lambda_{+})$ 和 $N_{-} \\sim \\mathrm{Poisson}(\\lambda_{-})$，其率分别为 $\\lambda_{+} = w_{+}/a$ 和 $\\lambda_{-} = w_{-}/a$。定义带符号无权估计量为 $S = a\\,(N_{+} - N_{-})$。\n\n需要完成的任务：\n- 从第一性原理推导 $S$ 是 $w$ 的无偏估计量，并用 $w_{+}$、$w_{-}$ 和 $a$ 表示其方差。\n- 定义并推导一个方差膨胀因子，以分离出符号抵消效应：对于 $|w|  0$，定义 $F = \\dfrac{w_{+} + w_{-}}{|w|}$，并将其解释为方差 $a\\,(w_{+} + w_{-})$ 超过“仅使用非负权重产生相同净绝对权重 $|w|$ 时所产生的方差（即 $a\\,|w|$）”的倍数。对于 $|w| = 0$ 的特殊情况，指明该膨胀因子未定义，且必须按如下所述通过哨兵值报告。\n\n编程任务：\n- 实现一个程序，对于给定的测试套件，模拟带符号稀疏化估计量 $S$，并将经验均值和经验方差与其推导出的理论值进行比较。对每个测试用例，使用 $R$ 次独立重复生成 $S$ 的独立样本，并使用总体归一化计算经验均值 $\\hat{\\mu}$ 和经验方差 $\\hat{v}$。理论均值为 $\\mu = w_{+} - w_{-}$，理论方差为 $v = a\\,(w_{+} + w_{-})$。\n- 对于 $|w|  0$，计算经验膨胀因子 $\\hat{F} = \\hat{v}/(a\\,|w|)$ 和理论膨胀因子 $F = (w_{+} + w_{-})/|w|$。对于 $|w| = 0$，不计算膨胀因子；而是如下文规定，为膨胀因子误差输出哨兵值 $-1.0$。\n- 对每个测试用例，输出差值三元组 $(\\Delta_{\\mu}, \\Delta_{v}, \\Delta_{F}) = \\big(\\hat{\\mu} - \\mu,\\; \\hat{v} - v,\\; \\hat{F} - F\\big)$，其中对于 $|w| = 0$ 的情况，你必须按照约定输出 $\\Delta_{F} = -1.0$。\n\n模拟细节：\n- 对每个测试用例，使用指定的率生成 $R$ 个独立的 $(N_{+}, N_{-})$ 对，对每次重复构造 $S = a\\,(N_{+} - N_{-})$，并使用总体归一化计算 $\\hat{\\mu}$ 和 $\\hat{v}$。每个测试用例使用独立的随机数生成器种子以确保可复现性。\n\n测试套件：\n- 程序必须使用以下测试用例，每个用例指定为一个五元组 $(w_{+}, w_{-}, a, R, \\text{seed})$：\n  - 用例 A: $(3.0, 0.0, 1.2, 1000000, 12345)$\n  - 用例 B: $(0.0, 2.5, 0.8, 1000000, 271828)$\n  - 用例 C: $(5.0, 5.0, 1.0, 1000000, 314159)$\n  - 用例 D: $(4.0, 1.5, 0.7, 1000000, 1618033)$\n\n要求的最终输出格式：\n- 你的程序应生成单行输出，其中包含所有测试用例结果的串联列表，该列表为逗号分隔，并用方括号括起来。结果必须按 $[\\Delta_{\\mu}^{A}, \\Delta_{v}^{A}, \\Delta_{F}^{A}, \\Delta_{\\mu}^{B}, \\Delta_{v}^{B}, \\Delta_{F}^{B}, \\Delta_{\\mu}^{C}, \\Delta_{v}^{C}, \\Delta_{F}^{C}, \\Delta_{\\mu}^{D}, \\Delta_{v}^{D}, \\Delta_{F}^{D}]$ 的顺序排列，每个值都渲染为浮点数。对于 $|w| = 0$ 的情况，膨胀因子误差应输出哨兵值 $-1.0$。", "solution": "问题陈述是有效的。它在概率论和统计学方面有科学依据，信息提供充分，表述适定且客观。它代表了计算高能物理领域中一个关于加权蒙特卡洛事件统计处理的可形式化且相关的问题。我们现在开始解答。\n\n解答包含两部分：首先，对所提出估计量的统计性质进行理论推导；其次，通过数值实现来验证这些推导。\n\n### 理论推导\n\n问题定义了一个带符号无权估计量 $S$，用于处理权重为 $w = w_{+} - w_{-}$（其中 $w_{+} \\ge 0$ 且 $w_{-} \\ge 0$）的加权事件。该估计量使用一个单位尺度 $a  0$ 和两个独立的泊松随机变量 $N_{+} \\sim \\mathrm{Poisson}(\\lambda_{+})$ 及 $N_{-} \\sim \\mathrm{Poisson}(\\lambda_{-})$ 构建，其率分别为 $\\lambda_{+} = w_{+}/a$ 和 $\\lambda_{-} = w_{-}/a$。估计量由 $S = a\\,(N_{+} - N_{-})$ 给出。\n\n#### 1. 估计量 $S$ 的无偏性\n如果一个估计量的期望等于它所估计参数的真值，则该估计量是无偏的。这里，我们必须证明 $\\mathbb{E}[S] = w$。我们使用期望的基本性质。根据期望的线性性，我们有：\n$$\n\\mathbb{E}[S] = \\mathbb{E}[a\\,(N_{+} - N_{-})] = a\\,\\mathbb{E}[N_{+} - N_{-}]\n$$\n由于 $N_{+}$ 和 $N_{-}$ 是独立的，它们差的期望等于它们期望的差：\n$$\n\\mathbb{E}[S] = a\\,(\\mathbb{E}[N_{+}] - \\mathbb{E}[N_{-}])\n$$\n泊松随机变量 $N \\sim \\mathrm{Poisson}(\\lambda)$ 的期望是 $\\mathbb{E}[N] = \\lambda$。将此应用于 $N_{+}$ 和 $N_{-}$：\n$$\n\\mathbb{E}[S] = a\\,(\\lambda_{+} - \\lambda_{-})\n$$\n代入给定的率的定义，$\\lambda_{+} = w_{+}/a$ 和 $\\lambda_{-} = w_{-}/a$：\n$$\n\\mathbb{E}[S] = a\\,\\left(\\frac{w_{+}}{a} - \\frac{w_{-}}{a}\\right) = a\\,\\left(\\frac{w_{+} - w_{-}}{a}\\right) = w_{+} - w_{-}\n$$\n根据定义，$w = w_{+} - w_{-}$，因此我们证明了 $\\mathbb{E}[S] = w$。所以，$S$ 是 $w$ 的一个无偏估计量。\n\n#### 2. 估计量 $S$ 的方差\n接下来，我们推导 $S$ 的方差，记为 $\\mathrm{Var}(S)$。我们使用对任意常数 $c$ 成立的性质 $\\mathrm{Var}(cX) = c^2\\,\\mathrm{Var}(X)$：\n$$\n\\mathrm{Var}(S) = \\mathrm{Var}(a\\,(N_{+} - N_{-})) = a^2\\,\\mathrm{Var}(N_{+} - N_{-})\n$$\n对于独立随机变量 $X$ 和 $Y$，它们的和或差的方差等于它们方差的和：$\\mathrm{Var}(X \\pm Y) = \\mathrm{Var}(X) + \\mathrm{Var}(Y)$。由于 $N_{+}$ 和 $N_{-}$ 是独立的：\n$$\n\\mathrm{Var}(S) = a^2\\,(\\mathrm{Var}(N_{+}) + \\mathrm{Var}(N_{-}))\n$$\n泊松随机变量 $N \\sim \\mathrm{Poisson}(\\lambda)$ 的方差是 $\\mathrm{Var}(N) = \\lambda$。应用此性质：\n$$\n\\mathrm{Var}(S) = a^2\\,(\\lambda_{+} + \\lambda_{-})\n$$\n代入率 $\\lambda_{+}$ 和 $\\lambda_{-}$ 的定义：\n$$\n\\mathrm{Var}(S) = a^2\\,\\left(\\frac{w_{+}}{a} + \\frac{w_{-}}{a}\\right) = a^2\\,\\left(\\frac{w_{+} + w_{-}}{a}\\right) = a\\,(w_{+} + w_{-})\n$$\n这就是估计量的理论方差 $v = a\\,(w_{+} + w_{-})$，与问题陈述一致。\n\n#### 3. 方差膨胀因子 $F$\n对于 $|w|  0$，方差膨胀因子定义为 $F = \\dfrac{w_{+} + w_{-}}{|w|}$。为了解释这一点，我们将实际方差 $v = a\\,(w_{+} + w_{-})$ 与一个理想化估计量的方差进行比较，该理想化估计量能达到相同的净权重大小 $|w|$，但没有任何由负权重引起的抵消。\n\n在这种理想情况下，总权重大小 $|w|$ 将完全由正权重构成（或完全由负权重构成，这在方差上是等效的）。这对应于权重分解 $w'_{\\text{total}} = w'_+ + w'_- = |w|$，其中一个分量为零。在这种理想情景下，估计量的方差 $v_{\\text{ideal}}$ 将是：\n$$\nv_{\\text{ideal}} = a\\,(w'_+ + w'_-) = a\\,|w|\n$$\n这代表了使用该估计方案对大小为 $|w|$ 的净权重可实现的最小方差。\n\n实际方差与此理想最小方差的比率为：\n$$\n\\frac{v}{v_{\\text{ideal}}} = \\frac{a\\,(w_{+} + w_{-})}{a\\,|w|} = \\frac{w_{+} + w_{-}}{|w|} = F\n$$\n因此，$F$ 正是由于正负权重分量（$w_{+}  0$ 且 $w_{-}  0$）同时存在而导致方差膨胀的因子，这种情况会导致净权重 $w$ 发生抵消。根据三角不等式，$w_{+} + w_{-} \\ge |w_{+} - w_{-}| = |w|$，这意味着 $F \\ge 1$。当且仅当 $w_{+}$ 或 $w_{-}$ 为零（无抵消）时，因子 $F$ 等于 $1$；当两者均为正数时，$F  1$，表示方差膨胀。\n\n对于 $|w| = 0$ 的情况（当 $w_{+} = w_{-}$ 时发生），$F$ 的分母为 $0$，使得该因子未定义。问题正确地指明这种情况必须用一个哨兵值来处理。在这种情况下，方差为 $v = a\\,(w_{+} + w_{-}) = 2aw_{+}$，它是一个非零值，而净权重为零，导致了无穷大的相对不确定性。\n\n下面的 Python 程序实现了模拟，以数值方式验证这些理论发现。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Simulates a signed Poisson thinning procedure for several test cases,\n    compares empirical and theoretical statistics, and outputs the differences.\n    \"\"\"\n    # Test cases are given as quintuples: (w+, w-, a, R, seed)\n    test_cases = [\n        # Case A\n        (3.0, 0.0, 1.2, 1000000, 12345),\n        # Case B\n        (0.0, 2.5, 0.8, 1000000, 271828),\n        # Case C\n        (5.0, 5.0, 1.0, 1000000, 314159),\n        # Case D\n        (4.0, 1.5, 0.7, 1000000, 1618033),\n    ]\n\n    results = []\n    for w_plus, w_minus, a, R, seed in test_cases:\n        # Create a dedicated random number generator for reproducibility.\n        rng = np.random.default_rng(seed)\n\n        # 1. Theoretical calculations\n        w_net = w_plus - w_minus\n        mu_th = w_net\n        v_th = a * (w_plus + w_minus)\n\n        # 2. Simulation\n        # Define Poisson rates\n        lambda_plus = w_plus / a\n        lambda_minus = w_minus / a\n\n        # Generate R independent Poisson-distributed random numbers\n        N_plus_samples = rng.poisson(lam=lambda_plus, size=R)\n        N_minus_samples = rng.poisson(lam=lambda_minus, size=R)\n\n        # Construct samples of the estimator S\n        S_samples = a * (N_plus_samples - N_minus_samples)\n\n        # 3. Compute empirical statistics\n        # Empirical mean\n        mu_emp = np.mean(S_samples)\n        \n        # Empirical variance using population normalization (ddof=0)\n        v_emp = np.var(S_samples, ddof=0)\n\n        # 4. Calculate differences\n        delta_mu = mu_emp - mu_th\n        delta_v = v_emp - v_th\n\n        # Handle the inflation factor F\n        # Use np.isclose for robust floating-point comparison to zero\n        if not np.isclose(w_net, 0.0):\n            # Theoretical inflation factor\n            F_th = (w_plus + w_minus) / abs(w_net)\n            \n            # Empirical inflation factor\n            F_emp = v_emp / (a * abs(w_net))\n            \n            delta_F = F_emp - F_th\n        else:\n            # As per problem specification, use sentinel value for delta_F when w=0\n            delta_F = -1.0\n        \n        results.extend([delta_mu, delta_v, delta_F])\n    \n    # Format and print the final output in the required single-line format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == '__main__':\n    solve()\n```", "id": "3513801"}]}