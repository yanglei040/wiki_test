{"hands_on_practices": [{"introduction": "首先，我们来探讨 tau-leaping 方法的统计学基础。该练习要求你从反应事件遵循泊松分布这一核心假设出发，为一个简单的生灭系统推导单步跳跃后系统状态的期望和方差。掌握这一计算对于理解 tau-leaping 方法如何近似化学主方程所描述的真实随机动力学至关重要。[@problem_id:3354348]", "problem": "考虑一个计算系统生物学中的单物种生灭反应系统，该系统包含 $2$ 个反应，其化学计量向量为 $S=\\begin{pmatrix}1\\\\-1\\end{pmatrix}$。状态 $X(t)$ 表示在时间 $t$ 的离散分子数。反应 $1$ 使分子数增加 $1$，其倾向函数为 $a_{1}(x)=\\alpha$，其中 $\\alpha>0$ 是一个恒定的生成速率。反应 $2$ 使分子数减少 $1$，其倾向函数为 $a_{2}(x)=\\beta x$，其中 $\\beta>0$ 是一阶降解速率常数，而 $x \\in \\mathbb{Z}_{\\ge 0}$ 是当前的分子数。\n\n假设一个长度为 $\\tau>0$ 的固定跳跃间隔，并且跳跃条件在 $[t,t+\\tau]$ 上成立，因此在跳跃期间，倾向函数在 $X(t)=x$ 的值上有效保持恒定。使用基于化学主方程（CME）的tau-leaping近似方法，其中在短时间内具有恒定倾向的反应发生次数被近似为独立的泊松随机变量，其参数等于倾向函数乘以该区间长度，执行以下操作：\n\n- 推导 $X(t+\\tau)$ 的显式tau-leaping更新，用 $X(t)$ 和在 $[t,t+\\tau]$ 上的随机反应次数来表示，并确定这些随机计数的分布和参数。\n- 计算条件期望 $\\mathbb{E}[X(t+\\tau)\\mid X(t)=x]$ 和条件方差 $\\mathrm{Var}[X(t+\\tau)\\mid X(t)=x]$。\n\n将您的最终答案表示为闭式解析表达式。无需四舍五入，也无需单位。", "solution": "问题要求推导单物种生灭过程的tau-leaping更新方程、条件期望和条件方差。我们将首先根据tau-leaping近似的原则建立更新规则，然后计算所需的统计矩。\n\n该系统涉及单一化学物种，其数量由状态变量 $X(t)$ 表示。共有 $M=2$ 个反应。\n反应 $1$：生成反应，化学计量变化为 $\\nu_1 = +1$，倾向函数为 $a_1(x) = \\alpha$，其中 $\\alpha > 0$ 是一个常数。\n反应 $2$：消亡反应，化学计量变化为 $\\nu_2 = -1$，倾向函数为 $a_2(x) = \\beta x$，其中 $\\beta > 0$ 是一个速率常数，而 $x$ 是当前的分子数。\n\n通用的tau-leaping更新规则将在小时间间隔 $\\tau$ 内状态向量的变化近似为：\n$$X(t+\\tau) = X(t) + \\sum_{j=1}^{M} \\nu_j K_j$$\n其中 $K_j$ 是反应 $j$ 在区间 $[t, t+\\tau]$ 内发生的次数，$\\nu_j$ 是与反应 $j$ 相关的化学计量变化。如问题所述，tau-leaping的核心假设是，对于一个足够小的 $\\tau$（跳跃条件），每个反应 $j$ 的发生次数 $K_j$ 可以被近似为一个独立的泊松随机变量：\n$$K_j \\sim \\text{Poisson}(\\lambda_j = a_j(X(t)) \\cdot \\tau)$$\n\n首先，我们将为给定系统建立显式的tau-leaping更新。\n设 $X(t)=x$。状态是一个标量计数。化学计量变化为 $\\nu_1=1$ 和 $\\nu_2=-1$。状态更新方程为：\n$$X(t+\\tau) = x + \\nu_1 K_1 + \\nu_2 K_2 = x + (1)K_1 + (-1)K_2 = x + K_1 - K_2$$\n这里，$K_1$ 和 $K_2$ 是独立的随机变量，分别代表在区间 $[t, t+\\tau]$ 内的生成和消亡事件的数量。\n\n根据tau-leaping近似，这些随机计数的分布是泊松分布。这些泊松分布的参数（速率）由在区间开始时 $X(t)=x$ 处评估的倾向函数乘以跳跃时长 $\\tau$ 确定。\n\n对于反应 1（生成），倾向为 $a_1(x) = \\alpha$。相应泊松分布的参数是 $\\lambda_1 = a_1(x)\\tau = \\alpha\\tau$。因此，生成事件的数量是一个随机变量 $K_1 \\sim \\text{Poisson}(\\alpha\\tau)$。\n\n对于反应 2（消亡），倾向为 $a_2(x) = \\beta x$。其泊松分布的参数是 $\\lambda_2 = a_2(x)\\tau = \\beta x \\tau$。因此，消亡事件的数量是一个随机变量 $K_2 \\sim \\text{Poisson}(\\beta x \\tau)$。\n\n因此，$X(t+\\tau)$ 的显式tau-leaping更新由表达式 $X(t+\\tau) = x + K_1 - K_2$ 给出，其中 $K_1$ 和 $K_2$ 是独立的随机变量，其分布为 $K_1 \\sim \\text{Poisson}(\\alpha\\tau)$ 和 $K_2 \\sim \\text{Poisson}(\\beta x \\tau)$。\n\n接下来，我们计算在给定时间 $t$ 的状态下，时间 $t+\\tau$ 状态的条件期望。\n$$\\mathbb{E}[X(t+\\tau) \\mid X(t)=x]$$\n使用我们推导的更新方程：\n$$\\mathbb{E}[X(t+\\tau) \\mid X(t)=x] = \\mathbb{E}[x + K_1 - K_2]$$\n根据期望算子的线性性质，这变为：\n$$\\mathbb{E}[x + K_1 - K_2] = \\mathbb{E}[x] + \\mathbb{E}[K_1] - \\mathbb{E}[K_2]$$\n因为 $x$ 是一个给定值（条件），所以它相对于期望是一个常数，因此 $\\mathbb{E}[x]=x$。\n参数为 $\\lambda$ 的泊松随机变量的期望等于 $\\lambda$。因此：\n$$\\mathbb{E}[K_1] = \\alpha\\tau$$\n$$\\mathbb{E}[K_2] = \\beta x \\tau$$\n将这些代入条件期望的表达式中，得到：\n$$\\mathbb{E}[X(t+\\tau) \\mid X(t)=x] = x + \\alpha\\tau - \\beta x \\tau = x(1 - \\beta\\tau) + \\alpha\\tau$$\n\n最后，我们计算在给定时间 $t$ 的状态下，时间 $t+\\tau$ 状态的条件方差。\n$$\\mathrm{Var}[X(t+\\tau) \\mid X(t)=x]$$\n使用相同的更新方程：\n$$\\mathrm{Var}[X(t+\\tau) \\mid X(t)=x] = \\mathrm{Var}[x + K_1 - K_2]$$\n方差对常数位移是不变的，所以加上 $x$ 不会改变方差：\n$$\\mathrm{Var}[x + K_1 - K_2] = \\mathrm{Var}[K_1 - K_2]$$\n方差的一个关键性质是，对于任意两个独立的随机变量 $Y_1$ 和 $Y_2$，有 $\\mathrm{Var}[Y_1 - Y_2] = \\mathrm{Var}[Y_1] + \\mathrm{Var}[Y_2]$。由于在tau-leaping框架中，$K_1$ 和 $K_2$ 被规定为独立的：\n$$\\mathrm{Var}[K_1 - K_2] = \\mathrm{Var}[K_1] + \\mathrm{Var}[K_2]$$\n参数为 $\\lambda$ 的泊松随机变量的方差也等于 $\\lambda$。因此：\n$$\\mathrm{Var}[K_1] = \\alpha\\tau$$\n$$\\mathrm{Var}[K_2] = \\beta x \\tau$$\n将这些代入条件方差的表达式中，得到：\n$$\\mathrm{Var}[X(t+\\tau) \\mid X(t)=x] = \\alpha\\tau + \\beta x \\tau = (\\alpha + \\beta x)\\tau$$\n\n推导出的条件期望和条件方差的表达式，提供了在tau-leaping近似下，物种数量在跳跃间隔 $\\tau$ 内变化的均值和方差。这些矩是分析随机模拟算法行为的基础。", "answer": "$$\\boxed{\\begin{pmatrix} x(1 - \\beta\\tau) + \\alpha\\tau \\\\ (\\alpha + \\beta x)\\tau \\end{pmatrix}}$$", "id": "3354348"}, {"introduction": "尽管 tau-leaping 方法功能强大，但其基本形式可能会失效，尤其是在分子数量较少的体系中，它可能产生非物理的负数种群。最后一个练习将展示这个关键问题，并引导你学习一种称为混合方法的稳健解决方案，该方法将反应划分为“关键”和“非关键”两类。完成此练习后，你将理解如何改进 tau-leaping 算法以确保其物理真实性，这是实现可靠模拟的关键一步。[@problem_id:3354376]", "problem": "考虑一个由化学主方程 (CME) 控制的充分混合的生物化学反应系统。状态是两个物种 $X_{1}$ 和 $X_{2}$ 的分子数向量 $\\mathbf{x} = (x_{1}, x_{2})$。该系统有四个基元反应，其化学计量变化为 $\\nu_{ij}$，倾向函数为 $a_{j}(\\mathbf{x}) = c_{j} h_{j}(\\mathbf{x})$，其中 $c_{j}$ 是随机速率常数，$h_{j}(\\mathbf{x})$ 是不同反应物组合的数量：\n- 反应 $\\mathrm{R}_{1}$: $X_{1} \\to \\varnothing$，其中 $c_{1} = 0.9$ $s^{-1}$ 且 $h_{1}(\\mathbf{x}) = x_{1}$。\n- 反应 $\\mathrm{R}_{2}$: $\\varnothing \\to X_{1}$，其中 $c_{2} = 1.0$ $s^{-1}$ 且 $h_{2}(\\mathbf{x}) = 1$。\n- 反应 $\\mathrm{R}_{3}$: $X_{1} + X_{2} \\to X_{2}$，其中 $c_{3} = 0.001$ $s^{-1}$ 且 $h_{3}(\\mathbf{x}) = x_{1} x_{2}$。\n- 反应 $\\mathrm{R}_{4}$: $X_{2} \\to \\varnothing$，其中 $c_{4} = 0.05$ $s^{-1}$ 且 $h_{4}(\\mathbf{x}) = x_{2}$。\n\n化学计量系数如下：\n- 对于物种 $X_{1}$：$\\nu_{1,1} = -1$, $\\nu_{1,2} = +1$, $\\nu_{1,3} = -1$, $\\nu_{1,4} = 0$。\n- 对于物种 $X_{2}$：$\\nu_{2,1} = 0$, $\\nu_{2,2} = 0$, $\\nu_{2,3} = 0$, $\\nu_{2,4} = -1$。\n\n设当前状态为 $\\mathbf{x} = (x_{1}, x_{2}) = (3, 80)$。在显式 tau-leaping 近似中，选择一个跳跃时间 $\\tau$，使得反应倾向在 $[t, t + \\tau)$ 区间内保持近似恒定，并且每个物种的净变化在均值和方差上都得到很好的控制。\n\n从 CME 和倾向的定义出发，根据化学计量和倾向推导每个物种的漂移 $\\mu_{i}(\\mathbf{x})$ 和扩散 $\\sigma_{i}^{2}(\\mathbf{x})$ 的表达式。施加标准的 tau-leaping 有界变化条件，确保在跳跃期间每个物种的期望相对变化和标准差标度的相对变化不超过给定的阈值 $\\epsilon$。使用这些条件，为完整的反应集计算一个候选 $\\tau$，其中阈值参数 $\\epsilon = 1.0$，安全因子 $\\eta = 0.8$。\n\n然后，抽取泊松随机反应计数 $K_{j} \\sim \\mathrm{Poisson}(a_{j}(\\mathbf{x}) \\tau)$ 来演示步长的接受或拒绝。对于此演示，假设实现的计数为 $K_{1} = 4$, $K_{2} = 1$, $K_{3} = 1$ 和 $K_{4} = 3$。确定此跳跃是否会产生负的物种数，从而必须被拒绝。\n\n在拒绝后，将反应重新分类为关键子集和非关键子集，规则如下：任何减少当前数量 $x_{i} \\leq n_{c}$ 的物种 $X_{i}$ 的反应均被视为关键反应，关键阈值设为 $n_{c} = 10$。仅使用非关键反应重新计算漂移和扩散，并使用相同的有界变化条件、相同的 $\\epsilon$ 和安全因子 $\\eta$ 来获得一个新的非关键 $\\tau_{\\mathrm{nc}}$。此外，通过从一个速率等于总关键倾向 $a^{c}(\\mathbf{x}) = \\sum_{j \\in \\mathcal{C}} a_{j}(\\mathbf{x})$ 的指数时钟中采样，计算到下一个关键事件发生的时间。对于本例，假设抽取的均匀分布随机变量为 $r = 0.2$，因此 $\\tau_{c} = \\frac{1}{a^{c}(\\mathbf{x})} \\ln\\!\\left(\\frac{1}{r}\\right)$。最终接受的跳跃时间为 $\\tau_{\\mathrm{final}} = \\min\\{\\tau_{\\mathrm{nc}}, \\tau_{c}\\}$。\n\n计算给定状态和实现下的 $\\tau_{\\mathrm{final}}$。最终结果以秒为单位表示，并四舍五入到四位有效数字。最终答案必须是单个实数。", "solution": "该问题需要在近似随机模拟的框架内进行多步分析，特别是使用显式 tau-leaping 方法及其涉及关键反应的混合扩展。求解过程首先推导漂移和扩散的一般表达式，然后验证跳跃的拒绝，最后使用混合方法计算修正后的跳跃时间。\n\n### 漂移和扩散的推导\n状态向量 $\\mathbf{x}$ 的演化由化学主方程 (CME) 描述。在 tau-leaping 近似中，对于一个足够小的时间步长 $\\tau$，使得倾向函数 $a_j(\\mathbf{x})$ 近似恒定，每个反应 $\\mathrm{R}_j$ 发生的次数 $K_j$ 可以用一个泊松随机变量来近似，$K_j \\sim \\mathrm{Poisson}(a_j(\\mathbf{x})\\tau)$。\n\n在区间 $\\tau$ 内物种 $X_i$ 的分子数变化由 $\\Delta x_i = \\sum_{j=1}^{M} \\nu_{ij} K_j$ 给出，其中 $M$ 是反应的总数。\n\n漂移 $\\mu_i(\\mathbf{x})$ 定义为物种 $X_i$ 的期望变化率。利用泊松变量 $\\mathrm{Poisson}(\\lambda)$ 的期望为 $\\lambda$ 的性质，我们有 $\\mathbb{E}[K_j] = a_j(\\mathbf{x})\\tau$。\n期望变化为：\n$$ \\mathbb{E}[\\Delta x_i] = \\mathbb{E}\\left[\\sum_{j=1}^{M} \\nu_{ij} K_j\\right] = \\sum_{j=1}^{M} \\nu_{ij} \\mathbb{E}[K_j] = \\sum_{j=1}^{M} \\nu_{ij} a_j(\\mathbf{x})\\tau $$\n漂移是单位时间的期望变化：\n$$ \\mu_i(\\mathbf{x}) = \\frac{\\mathbb{E}[\\Delta x_i]}{\\tau} = \\sum_{j=1}^{M} \\nu_{ij} a_j(\\mathbf{x}) $$\n\n扩散 $\\sigma_i^2(\\mathbf{x})$ 是变化率的方差。利用泊松变量 $\\mathrm{Poisson}(\\lambda)$ 的方差也为 $\\lambda$ 的性质，我们有 $\\mathrm{Var}(K_j) = a_j(\\mathbf{x})\\tau$。假设反应的发生是独立的，则变化的方差为：\n$$ \\mathrm{Var}(\\Delta x_i) = \\mathrm{Var}\\left[\\sum_{j=1}^{M} \\nu_{ij} K_j\\right] = \\sum_{j=1}^{M} \\nu_{ij}^2 \\mathrm{Var}(K_j) = \\sum_{j=1}^{M} \\nu_{ij}^2 a_j(\\mathbf{x})\\tau $$\n扩散是单位时间变化的方差：\n$$ \\sigma_i^2(\\mathbf{x}) = \\frac{\\mathrm{Var}(\\Delta x_i)}{\\tau} = \\sum_{j=1}^{M} \\nu_{ij}^2 a_j(\\mathbf{x}) $$\n\n### 跳跃拒绝分析\n首先，我们计算当前状态 $\\mathbf{x} = (x_1, x_2) = (3, 80)$ 的倾向函数：\n$a_1(\\mathbf{x}) = c_1 x_1 = 0.9 \\times 3 = 2.7$ $s^{-1}$\n$a_2(\\mathbf{x}) = c_2 \\times 1 = 1.0 \\times 1 = 1.0$ $s^{-1}$\n$a_3(\\mathbf{x}) = c_3 x_1 x_2 = 0.001 \\times 3 \\times 80 = 0.24$ $s^{-1}$\n$a_4(\\mathbf{x}) = c_4 x_2 = 0.05 \\times 80 = 4.0$ $s^{-1}$\n\n问题提供了一组假设的跳跃实现的泊松计数值：$K_1 = 4$, $K_2 = 1$, $K_3 = 1$ 和 $K_4 = 3$。我们计算物种数的变化，$\\Delta x_i = \\sum_j \\nu_{ij} K_j$。\n\n对于物种 $X_1$：\n$$ \\Delta x_1 = \\nu_{1,1} K_1 + \\nu_{1,2} K_2 + \\nu_{1,3} K_3 + \\nu_{1,4} K_4 = (-1)(4) + (+1)(1) + (-1)(1) + (0)(3) = -4 + 1 - 1 = -4 $$\n对于物种 $X_2$：\n$$ \\Delta x_2 = \\nu_{2,1} K_1 + \\nu_{2,2} K_2 + \\nu_{2,3} K_3 + \\nu_{2,4} K_4 = (0)(4) + (0)(1) + (0)(1) + (-1)(3) = -3 $$\n\n新状态将是 $\\mathbf{x}' = \\mathbf{x} + \\Delta\\mathbf{x} = (3 - 4, 80 - 3) = (-1, 77)$。\n由于物种 $X_1$ 的数量变为负数 ($x'_1 = -1$)，这在物理上是不可能的，因此必须拒绝此跳跃。\n\n### 混合方法：反应划分和 $\\tau$ 计算\n拒绝后，算法切换到混合方法。反应被划分为关键和非关键集。如果一个反应减少了当前数量 $x_i$ 小于或等于阈值 $n_c = 10$ 的物种 $X_i$，则该反应是关键的。\n\n在状态 $\\mathbf{x} = (3, 80)$ 时：\n- $x_1 = 3 \\le n_c$，所以减少 $X_1$ 的反应是关键的。\n- $x_2 = 80 > n_c$。\n\n分析反应：\n- $\\mathrm{R}_{1}$: $\\nu_{1,1} = -1$。减少 $X_1$。因此，$\\mathrm{R}_{1}$ 是关键的。\n- $\\mathrm{R}_{2}$: $\\nu_{1,2} = +1$。不减少 $X_1$。非关键的。\n- $\\mathrm{R}_{3}$: $\\nu_{1,3} = -1$。减少 $X_1$。因此，$\\mathrm{R}_{3}$ 是关键的。\n- $\\mathrm{R}_{4}$: $\\nu_{2,4} = -1$。减少 $X_2$，但 $x_2 > n_c$。非关键的。\n\n集合为：关键集 $\\mathcal{C} = \\{\\mathrm{R}_{1}, \\mathrm{R}_{3}\\}$ 和非关键集 $\\mathcal{NC} = \\{\\mathrm{R}_{2}, \\mathrm{R}_{4}\\}$。\n\n关键反应的总倾向是：\n$$ a^c(\\mathbf{x}) = a_1(\\mathbf{x}) + a_3(\\mathbf{x}) = 2.7 + 0.24 = 2.94 \\, \\mathrm{s}^{-1} $$\n到下一个关键反应的时间 $\\tau_c$ 是从一个速率为 $a^c(\\mathbf{x})$ 的指数分布中采样的。使用给定的均匀随机变量 $r = 0.2$：\n$$ \\tau_c = \\frac{1}{a^c(\\mathbf{x})} \\ln\\left(\\frac{1}{r}\\right) = \\frac{1}{2.94} \\ln\\left(\\frac{1}{0.2}\\right) = \\frac{\\ln(5)}{2.94} \\approx 0.547428 \\, \\mathrm{s} $$\n\n接下来，我们使用有界变化条件为非关键反应计算一个跳跃时间 $\\tau_{\\mathrm{nc}}$。我们首先需要仅由非关键反应 $\\mathrm{R}_{2}$ 和 $\\mathrm{R}_{4}$ 产生的漂移和扩散。\n对于 $X_1$：\n$$ \\mu_1^{\\mathrm{nc}}(\\mathbf{x}) = \\nu_{1,2}a_2(\\mathbf{x}) + \\nu_{1,4}a_4(\\mathbf{x}) = (+1)(1.0) + (0)(4.0) = 1.0 $$\n$$ (\\sigma_1^{\\mathrm{nc}})^2(\\mathbf{x}) = \\nu_{1,2}^2 a_2(\\mathbf{x}) + \\nu_{1,4}^2 a_4(\\mathbf{x}) = (+1)^2(1.0) + (0)^2(4.0) = 1.0 $$\n对于 $X_2$：\n$$ \\mu_2^{\\mathrm{nc}}(\\mathbf{x}) = \\nu_{2,2}a_2(\\mathbf{x}) + \\nu_{2,4}a_4(\\mathbf{x}) = (0)(1.0) + (-1)(4.0) = -4.0 $$\n$$ (\\sigma_2^{\\mathrm{nc}})^2(\\mathbf{x}) = \\nu_{2,2}^2 a_2(\\mathbf{x}) + \\nu_{2,4}^2 a_4(\\mathbf{x}) = (0)^2(1.0) + (-1)^2(4.0) = 4.0 $$\n\n每个物种的候选 $\\tau$ 由以下公式确定：\n$$ \\tau_i^{\\mathrm{raw}} = \\min\\left(\\frac{\\epsilon x_i}{|\\mu_i^{\\mathrm{nc}}(\\mathbf{x})|}, \\frac{(\\epsilon x_i)^2}{(\\sigma_i^{\\mathrm{nc}})^2(\\mathbf{x})}\\right) $$\n给定 $\\epsilon = 1.0$。\n对于 $X_1$ ($x_1=3$)：\n$$ \\tau_1^{\\mathrm{raw}} = \\min\\left(\\frac{1.0 \\times 3}{|1.0|}, \\frac{(1.0 \\times 3)^2}{1.0}\\right) = \\min(3, 9) = 3 \\, \\mathrm{s} $$\n对于 $X_2$ ($x_2=80$)：\n$$ \\tau_2^{\\mathrm{raw}} = \\min\\left(\\frac{1.0 \\times 80}{|-4.0|}, \\frac{(1.0 \\times 80)^2}{4.0}\\right) = \\min\\left(\\frac{80}{4}, \\frac{6400}{4}\\right) = \\min(20, 1600) = 20 \\, \\mathrm{s} $$\n总的非关键时间步长是这些值的最小值，并应用了安全因子 $\\eta = 0.8$：\n$$ \\tau_{\\mathrm{nc}} = \\eta \\times \\min(\\tau_1^{\\mathrm{raw}}, \\tau_2^{\\mathrm{raw}}) = 0.8 \\times \\min(3, 20) = 0.8 \\times 3 = 2.4 \\, \\mathrm{s} $$\n\n最后，混合步长所接受的跳跃时间是到下一个关键事件的时间与非关键系统跳跃时间的最小值：\n$$ \\tau_{\\mathrm{final}} = \\min\\{\\tau_{\\mathrm{nc}}, \\tau_c\\} = \\min\\{2.4, 0.547428\\} = 0.547428 \\, \\mathrm{s} $$\n四舍五入到四位有效数字，我们得到 $0.5474$。", "answer": "$$\\boxed{0.5474}$$", "id": "3354376"}]}