{"hands_on_practices": [{"introduction": "为了分析随机轨迹，我们必须首先能够量化其发生的概率。对于连续时间马尔可夫链，任何特定路径的似然性取决于两个核心要素：已发生的反应事件的速率，以及在状态上停留的总时间。积分风险（integrated hazard）$ \\int_0^T \\lambda(X_s; \\theta) ds $正是捕捉后者的关键。这项练习 ([@problem_id:3303233]) 提供了计算这一基本量的具体实践，将抽象的积分与基于分段恒定轨迹数据的具体求和联系起来，这是构建参数推断中似然函数的关键一步。", "problem": "在计算系统生物学中，生物化学反应网络的随机动力学可以建模为连续时间马尔可夫链（CTMC），其中系统状态 $X_t \\in \\mathbb{N}$ 是分段常数，并在随机时间发生跳跃式变化。瞬时总事件率（也称为风险率或强度）$\\lambda(X_t;\\theta)$ 决定了等待时间和跳跃事件的分布。考虑一个具有三种反应的单物种网络：构成性合成、一级衰变和双分子湮灭。总风险率建模为\n$$\n\\lambda(x;\\theta) \\;=\\; \\theta_1 \\;+\\; \\theta_2\\, x \\;+\\; \\theta_3 \\binom{x}{2},\n$$\n其中 $\\theta = (\\theta_1,\\theta_2,\\theta_3)$ 是待从观测轨迹中估计的未知参数，且 $\\binom{x}{2} = \\frac{x(x-1)}{2}$。\n\n在区间 $[0,T]$ (其中 $T = 6.0$) 上观测到一条实现的跳跃轨迹，其跳跃时间为 $t_0 = 0$, $t_1 = 0.5$, $t_2 = 1.1$, $t_3 = 2.0$, $t_4 = 4.0$, $t_5 = 6.0$，其分段常数状态 $X_s = x_k$ (对于 $s \\in [t_k, t_{k+1})$) 由下式给出\n$$\nx_0 = 3,\\quad x_1 = 4,\\quad x_2 = 2,\\quad x_3 = 2,\\quad x_4 = 5.\n$$\n\n从时间非齐次跳跃过程的生存函数的基本定义以及积分风险率 $\\int_0^T \\lambda(X_s;\\theta)\\,ds$ 在路径分布中的作用出发，推导在 $X_s$ 沿轨迹的分段常数性质下，该积分如何化简。然后，对给定的轨迹应用此化简，并将结果表达式化简为关于 $\\theta_1$, $\\theta_2$ 和 $\\theta_3$ 的单一闭式解析表达式。\n\n你的最终答案必须是一个单一的解析表达式。无需四舍五入，且不涉及物理单位。", "solution": "我们从通过其风险率（强度）函数构造连续时间马尔可夫链（CTMC）路径分布的标准方法开始。对于一个瞬时总速率为 $\\lambda(X_t;\\theta)$ 的时间非齐次跳跃过程，在给定 $X_s$ 轨迹的条件下，区间 $[0,t]$ 内没有事件发生的概率是\n$$\n\\Pr(\\text{no jump in }[0,t] \\mid \\{X_s\\}_{s \\in [0,t]}) \\;=\\; \\exp\\!\\left(-\\int_0^t \\lambda(X_s;\\theta)\\,ds\\right).\n$$\n该公式源于非齐次泊松过程（NHPP）生存函数的基本定义，并通过 CTMC 框架推广到状态依赖的强度。因此，积分 $\\int_0^T \\lambda(X_s;\\theta)\\,ds$ 是进入路径似然的积分风险率。\n\n在可数状态空间上的 CTMC 中，样本路径是分段常数的，在孤立的时间点发生跳跃。令跳跃时间为 $0 = t_0  t_1  \\dots  t_m  t_{m+1} = T$，且状态在两次跳跃之间是恒定的：$X_s = x_k$ (对于 $s \\in [t_k, t_{k+1})$, $k = 0,\\dots,m$)。在此分段常数性质下，被积函数 $\\lambda(X_s;\\theta)$ 在每个区间 $[t_k, t_{k+1})$ 上是常数，等于 $\\lambda(x_k;\\theta)$。因此，该积分可以分解为各区间的和：\n$$\n\\int_0^T \\lambda(X_s;\\theta)\\,ds\n\\;=\\; \\sum_{k=0}^{m} \\int_{t_k}^{t_{k+1}} \\lambda(x_k;\\theta)\\,ds\n\\;=\\; \\sum_{k=0}^{m} \\lambda(x_k;\\theta)\\,(t_{k+1}-t_k).\n$$\n这种化简是阶梯函数黎曼积分基本性质的直接结果。\n\n现在我们对给定的轨迹应用此化简。该轨迹由 $t_0 = 0$, $t_1 = 0.5$, $t_2 = 1.1$, $t_3 = 2.0$, $t_4 = 4.0$, $t_5 = 6.0$ 和 $x_0 = 3$, $x_1 = 4$, $x_2 = 2$, $x_3 = 2$, $x_4 = 5$ 指定。共有 $m = 4$ 次跳跃和 $m+1 = 5$ 个区间。各区间的时长为\n$$\n\\Delta_0 = t_1 - t_0 = 0.5,\\quad\n\\Delta_1 = t_2 - t_1 = 0.6,\\quad\n\\Delta_2 = t_3 - t_2 = 0.9,\\quad\n\\Delta_3 = t_4 - t_3 = 2.0,\\quad\n\\Delta_4 = t_5 - t_4 = 2.0,\n$$\n它们的总和为 $T = 6.0$，这可作为一致性检验。\n\n总风险率为\n$$\n\\lambda(x;\\theta) \\;=\\; \\theta_1 \\;+\\; \\theta_2\\, x \\;+\\; \\theta_3 \\binom{x}{2}\n\\;=\\; \\theta_1 \\;+\\; \\theta_2\\, x \\;+\\; \\theta_3 \\,\\frac{x(x-1)}{2}.\n$$\n我们为每个 $x_k$ 计算 $\\lambda(x_k;\\theta)$：\n- 对于 $x_0 = 3$,\n$$\n\\lambda(3;\\theta) \\;=\\; \\theta_1 \\;+\\; 3\\theta_2 \\;+\\; \\theta_3 \\binom{3}{2}\n\\;=\\; \\theta_1 \\;+\\; 3\\theta_2 \\;+\\; 3\\theta_3.\n$$\n- 对于 $x_1 = 4$,\n$$\n\\lambda(4;\\theta) \\;=\\; \\theta_1 \\;+\\; 4\\theta_2 \\;+\\; \\theta_3 \\binom{4}{2}\n\\;=\\; \\theta_1 \\;+\\; 4\\theta_2 \\;+\\; 6\\theta_3.\n$$\n- 对于 $x_2 = 2$,\n$$\n\\lambda(2;\\theta) \\;=\\; \\theta_1 \\;+\\; 2\\theta_2 \\;+\\; \\theta_3 \\binom{2}{2}\n\\;=\\; \\theta_1 \\;+\\; 2\\theta_2 \\;+\\; \\theta_3.\n$$\n- 对于 $x_3 = 2$,\n$$\n\\lambda(2;\\theta) \\;=\\; \\theta_1 \\;+\\; 2\\theta_2 \\;+\\; \\theta_3.\n$$\n- 对于 $x_4 = 5$,\n$$\n\\lambda(5;\\theta) \\;=\\; \\theta_1 \\;+\\; 5\\theta_2 \\;+\\; \\theta_3 \\binom{5}{2}\n\\;=\\; \\theta_1 \\;+\\; 5\\theta_2 \\;+\\; 10\\theta_3.\n$$\n\n将各项乘以相应的时长并求和，得到积分风险率：\n$$\n\\int_0^{6.0} \\lambda(X_s;\\theta)\\,ds\n\\;=\\; 0.5\\big(\\theta_1 + 3\\theta_2 + 3\\theta_3\\big)\n\\;+\\; 0.6\\big(\\theta_1 + 4\\theta_2 + 6\\theta_3\\big)\n\\;+\\; 0.9\\big(\\theta_1 + 2\\theta_2 + \\theta_3\\big)\n\\;+\\; 2.0\\big(\\theta_1 + 2\\theta_2 + \\theta_3\\big)\n\\;+\\; 2.0\\big(\\theta_1 + 5\\theta_2 + 10\\theta_3\\big).\n$$\n我们按参数收集各项：\n- $\\theta_1$ 的系数：\n$$\n0.5 + 0.6 + 0.9 + 2.0 + 2.0 \\;=\\; 6.0.\n$$\n- $\\theta_2$ 的系数：\n$$\n0.5\\cdot 3 + 0.6\\cdot 4 + 0.9\\cdot 2 + 2.0\\cdot 2 + 2.0\\cdot 5\n\\;=\\; 1.5 + 2.4 + 1.8 + 4.0 + 10.0 \\;=\\; 19.7 \\;=\\; \\frac{197}{10}.\n$$\n- $\\theta_3$ 的系数：\n$$\n0.5\\cdot 3 + 0.6\\cdot 6 + 0.9\\cdot 1 + 2.0\\cdot 1 + 2.0\\cdot 10\n\\;=\\; 1.5 + 3.6 + 0.9 + 2.0 + 20.0 \\;=\\; 28.0 \\;=\\; 28.\n$$\n\n因此，积分风险率化简为闭式表达式\n$$\n\\int_0^{6.0} \\lambda(X_s;\\theta)\\,ds \\;=\\; 6\\,\\theta_1 \\;+\\; \\frac{197}{10}\\,\\theta_2 \\;+\\; 28\\,\\theta_3.\n$$\n此表达式通过将分段常数状态下评估的风险率按区间时长加权求和，实现了积分项的计算，这正是对 CTMC 中随机轨迹进行分布分析所要求的。", "answer": "$$\\boxed{6\\theta_1+\\frac{197}{10}\\theta_2+28\\theta_3}$$", "id": "3303233"}, {"introduction": "除了分析单个路径的似然性，理解轨迹的长期、集体行为对于统计分析也同样重要。一个核心问题是，一个系统需要多长时间才能“忘记”其初始状态并收敛到其平稳分布。这个时间尺度由混合时间（mixing time）来量化。这项理论练习 ([@problem_id:3303209]) 深入探讨了混合时间与系统生成元矩阵的谱隙（spectral gap）$ \\lambda_1 $之间的根本联系。通过推导混合时间的下界，您将更深刻地理解微观动力学如何决定宏观的弛豫和去相关时间尺度。", "problem": "在计算系统生物学中，随机基因表达动力学的一个常用模型是定义在有限状态空间 $\\{0,1,\\ldots,N\\}$ 上的具有反射边界的连续时间可逆生灭马尔可夫链，它例如可以表示某个经历合成与降解过程的分子种类的数量。设该链是不可约的，具有唯一的平稳分布 $\\pi$、生成元 $Q$ 和转移半群 $T_t = \\exp(t Q)$。将谱隙记为 $\\lambda_1  0$，其定义为 $-Q$ 作用于在 $\\pi$ 下均值为零的函数上时的最小正特征值。设达到 $\\epsilon$ 的全变差 (TV) 混合时间定义为\n$$\nt_{\\mathrm{mix}}(\\epsilon) \\equiv \\inf\\left\\{t \\ge 0 : \\sup_{x \\in \\{0,1,\\ldots,N\\}} \\left\\|T_t(x,\\cdot) - \\pi\\right\\|_{\\mathrm{TV}} \\le \\epsilon \\right\\},\n$$\n其中对于 $\\{0,1,\\ldots,N\\}$ 上的概率测度 $\\mu$ 和 $\\nu$，\n$$\n\\|\\mu - \\nu\\|_{\\mathrm{TV}} \\equiv \\frac{1}{2} \\sum_{i=0}^{N} \\left|\\mu(i) - \\nu(i)\\right|.\n$$\n在随机轨迹的分布分析中，一个关键对象是可观测量沿平稳轨迹的自相关。对于可逆动力学，该自相关函数允许进行谱分解，其中最慢的衰减模式由 $\\lambda_1$ 控制。仅利用连续时间可逆马尔可夫链的基本性质、通过其对偶刻画定义的全变差距离，以及通过特征函数和特征值对 $T_t$ 的谱刻画，推导出一个仅依赖于 $\\lambda_1$ 和 $\\epsilon$ 的 $t_{\\mathrm{mix}}(\\epsilon)$ 的普适下界。然后，简要地将此界与轨迹空间中最慢模式的去相关时间尺度联系起来。\n\n将最终的下界表示为仅含 $\\lambda_1$ 和 $\\epsilon$ 的单个闭式表达式。不需要进行数值舍入，最终表达式中不应包含任何单位。", "solution": "该问题是有效的，因为它在科学上基于马尔可夫链理论，是适定的、客观的且自洽的。它提出了随机过程分析中一个标准的、非平凡的问题。我们可以开始求解。\n\n目标是为连续时间可逆马尔可夫链的全变差混合时间 $t_{\\mathrm{mix}}(\\epsilon)$ 推导出一个普适下界。该界应仅依赖于谱隙 $\\lambda_1$ 和混合阈值 $\\epsilon$。问题指明，推导应依赖于全变差距离的对偶刻画以及转移半群 $T_t$ 的谱性质。\n\n设状态空间为 $\\mathcal{S} = \\{0, 1, \\ldots, N\\}$。$\\mathcal{S}$ 上两个概率测度 $\\mu$ 和 $\\nu$ 之间的全变差距离由下式给出\n$$\n\\|\\mu - \\nu\\|_{\\mathrm{TV}} = \\frac{1}{2} \\sum_{i=0}^{N} |\\mu(i) - \\nu(i)|.\n$$\n将此组合定义与谱理论联系起来的一个关键工具是全变差范数的对偶刻画，其表述如下：\n$$\n\\|\\mu - \\nu\\|_{\\mathrm{TV}} = \\sup_{f: \\|\\cdot\\|_{\\infty} \\le 1} \\frac{1}{2} \\left| \\mathbb{E}_{\\mu}[f] - \\mathbb{E}_{\\nu}[f] \\right|,\n$$\n其中上确界取自 $\\mathcal{S}$ 上所有无穷范数 $\\|f\\|_{\\infty} = \\sup_{i \\in \\mathcal{S}} |f(i)| \\le 1$ 的实值函数 $f$。\n\n混合时间的定义是\n$$\nt_{\\mathrm{mix}}(\\epsilon) \\equiv \\inf \\left\\{ t \\ge 0 : d(t) \\le \\epsilon \\right\\},\n$$\n其中 $d(t) \\equiv \\sup_{x \\in \\mathcal{S}} \\|T_t(x, \\cdot) - \\pi\\|_{\\mathrm{TV}}$。这里，$T_t(x, \\cdot)$ 是链从状态 $x$ 出发在时间 $t$ 时的概率分布，而 $\\pi$ 是唯一的平稳分布。\n\n让我们将对偶刻画应用于距离 $d(t)$：\n$$\n\\|T_t(x, \\cdot) - \\pi\\|_{\\mathrm{TV}} = \\sup_{f: \\|f\\|_{\\infty} \\le 1} \\frac{1}{2} \\left| \\mathbb{E}_{T_t(x, \\cdot)}[f] - \\mathbb{E}_{\\pi}[f] \\right|.\n$$\n期望 $\\mathbb{E}_{T_t(x, \\cdot)}[f]$ 是当状态根据 $T_t(x, \\cdot)$ 分布时 $f$ 的期望。这恰好是半群 $T_t$ 作用于函数 $f$ 并在起始状态 $x$ 处求值的结果：\n$$\n\\mathbb{E}_{T_t(x, \\cdot)}[f] = \\sum_{i=0}^{N} f(i) T_t(x, i) = (T_t f)(x).\n$$\n因此，我们可以将从起始状态 $x$ 出发的距离写为：\n$$\n\\|T_t(x, \\cdot) - \\pi\\|_{\\mathrm{TV}} = \\sup_{f: \\|f\\|_{\\infty} \\le 1} \\frac{1}{2} \\left| (T_t f)(x) - \\mathbb{E}_{\\pi}[f] \\right|.\n$$\n为了找到 $d(t) = \\sup_{x \\in \\mathcal{S}} \\|T_t(x, \\cdot) - \\pi\\|_{\\mathrm{TV}}$ 的一个下界，我们只需选择一个特定的、良态的测试函数 $f$ 并计算该表达式，因为上确界将大于或等于对任何特定 $f$ 的取值。\n\n该链是可逆的，因此生成元 $Q$ 在以内积 $\\langle g, h \\rangle_\\pi = \\sum_{i=0}^N g(i) h(i) \\pi(i)$ 定义的函数希尔伯特空间 $L^2(\\pi)$ 中是自伴的。因此，算子 $-Q$ 具有实数、非负的特征值 $0 = \\lambda_0  \\lambda_1 \\le \\lambda_2 \\le \\dots \\le \\lambda_N$。设 $\\phi_0, \\phi_1, \\ldots, \\phi_N$ 是相应的标准正交特征函数。对应于 $\\lambda_0=0$ 的特征函数是常数函数 $\\phi_0(i) = 1$。谱隙为 $\\lambda_1 > 0$。半群 $T_t = \\exp(tQ)$ 作用于特征函数 $\\phi_k$ 的结果是 $T_t \\phi_k = \\exp(-t\\lambda_k) \\phi_k$。\n\n系统的最慢衰减非平稳模式对应于与谱隙 $\\lambda_1$ 相关的特征函数 $\\phi_1$。这使得 $\\phi_1$ 成为一个极佳的测试函数候选者。在 $L^2(\\pi)$ 中，特征函数 $\\phi_1$ 与常数函数 $\\phi_0$ 正交：\n$$\n\\langle \\phi_1, \\phi_0 \\rangle_\\pi = \\sum_{i=0}^N \\phi_1(i) \\cdot 1 \\cdot \\pi(i) = \\mathbb{E}_{\\pi}[\\phi_1] = 0.\n$$\n测试函数 $f$ 必须满足 $\\|f\\|_{\\infty} \\le 1$。特征函数 $\\phi_1$ 在 $L^2(\\pi)$ 中是归一化的（即 $\\|\\phi_1\\|_{L^2(\\pi)}=1$），但在无穷范数下不一定。我们通过用其无穷范数对 $\\phi_1$ 进行归一化来定义一个合适的测试函数 $f_1$：\n$$\nf_1 = \\frac{\\phi_1}{\\|\\phi_1\\|_{\\infty}}.\n$$\n该函数满足 $\\|f_1\\|_{\\infty} = 1$，并且由于 $\\mathbb{E}_{\\pi}[\\phi_1]=0$，我们也有 $\\mathbb{E}_{\\pi}[f_1] = 0$。\n\n将 $f_1$ 代入对偶形式，可得到 TV 距离的一个下界：\n$$\n\\|T_t(x, \\cdot) - \\pi\\|_{\\mathrm{TV}} \\ge \\frac{1}{2} \\left| (T_t f_1)(x) - \\mathbb{E}_{\\pi}[f_1] \\right| = \\frac{1}{2} \\left| T_t \\left( \\frac{\\phi_1}{\\|\\phi_1\\|_{\\infty}} \\right) (x) - 0 \\right|.\n$$\n利用 $T_t$ 的线性性质及其对 $\\phi_1$ 的作用：\n$$\n\\|T_t(x, \\cdot) - \\pi\\|_{\\mathrm{TV}} \\ge \\frac{1}{2\\|\\phi_1\\|_{\\infty}} |(T_t \\phi_1)(x)| = \\frac{1}{2\\|\\phi_1\\|_{\\infty}} |\\exp(-t\\lambda_1) \\phi_1(x)| = \\frac{\\exp(-t\\lambda_1) |\\phi_1(x)|}{2\\|\\phi_1\\|_{\\infty}}.\n$$\n这个不等式对任何起始状态 $x$ 都成立。为了得到 $d(t)$ 的下界，我们对所有 $x \\in \\mathcal{S}$ 取上确界：\n$$\nd(t) = \\sup_{x \\in \\mathcal{S}} \\|T_t(x, \\cdot) - \\pi\\|_{\\mathrm{TV}} \\ge \\sup_{x \\in \\mathcal{S}} \\left( \\frac{\\exp(-t\\lambda_1) |\\phi_1(x)|}{2\\|\\phi_1\\|_{\\infty}} \\right).\n$$\n$|\\phi_1(x)|$ 对 $x$ 的上确界根据定义就是 $\\|\\phi_1\\|_{\\infty}$。因此，我们得到：\n$$\nd(t) \\ge \\frac{\\exp(-t\\lambda_1)}{2\\|\\phi_1\\|_{\\infty}} \\sup_{x \\in \\mathcal{S}} |\\phi_1(x)| = \\frac{\\exp(-t\\lambda_1)}{2\\|\\phi_1\\|_{\\infty}} \\|\\phi_1\\|_{\\infty} = \\frac{1}{2}\\exp(-t\\lambda_1).\n$$\n我们现在已经建立了一个关于全变差距离衰减的普适下界。\n\n根据定义，在 $t = t_{\\mathrm{mix}}(\\epsilon)$ 时，我们有 $d(t_{\\mathrm{mix}}(\\epsilon)) \\le \\epsilon$。将其与我们的下界结合起来得到：\n$$\n\\frac{1}{2}\\exp(-\\lambda_1 t_{\\mathrm{mix}}(\\epsilon)) \\le d(t_{\\mathrm{mix}}(\\epsilon)) \\le \\epsilon.\n$$\n重新整理这个不等式以求解 $t_{\\mathrm{mix}}(\\epsilon)$：\n$$\n\\exp(-\\lambda_1 t_{\\mathrm{mix}}(\\epsilon)) \\le 2\\epsilon\n$$\n$$\n-\\lambda_1 t_{\\mathrm{mix}}(\\epsilon) \\le \\ln(2\\epsilon)\n$$\n$$\n\\lambda_1 t_{\\mathrm{mix}}(\\epsilon) \\ge -\\ln(2\\epsilon) = \\ln\\left(\\frac{1}{2\\epsilon}\\right).\n$$\n这就得出了混合时间的最终下界：\n$$\nt_{\\mathrm{mix}}(\\epsilon) \\ge \\frac{1}{\\lambda_1} \\ln\\left(\\frac{1}{2\\epsilon}\\right).\n$$\n这个不等式对任何 $\\epsilon \\in (0, 1)$ 都成立。对于 $\\epsilon \\ge 1/2$，右侧为非正数，这是一个平凡界，因为时间是非负的。\n\n为了将此界与最慢模式的去相关时间尺度联系起来，我们考虑一个可观测量 $g$ 的平稳自相关函数。对于一个零均值可观测量，$\\mathbb{E}_\\pi[g]=0$，其自相关函数为 $C_g(t) = \\mathbb{E}_\\pi[g(X_0) g(X_t)] = \\langle g, T_t g \\rangle_\\pi$。最慢模式对应于特征函数 $g=\\phi_1$。其自相关函数为 $C_{\\phi_1}(t) = \\langle \\phi_1, T_t \\phi_1 \\rangle_\\pi = \\langle \\phi_1, \\exp(-t\\lambda_1) \\phi_1 \\rangle_\\pi = \\exp(-t\\lambda_1) \\|\\phi_1\\|^2_{L^2(\\pi)} = \\exp(-t\\lambda_1)$。这种指数衰减的特征时间尺度 $\\tau_1$ 是相关性下降到 $1/e$ 所需的时间，即 $\\tau_1 = 1/\\lambda_1$。因此，混合时间的下界可以表示为 $t_{\\mathrm{mix}}(\\epsilon) \\ge \\tau_1 \\ln\\left(\\frac{1}{2\\epsilon}\\right)$。这表明混合时间从根本上受限于系统中最慢动力学模式的去相关时间，并按一个取决于与平稳状态期望接近程度的对数因子进行缩放。", "answer": "$$\n\\boxed{\\frac{1}{\\lambda_1} \\ln\\left(\\frac{1}{2\\epsilon}\\right)}\n$$", "id": "3303209"}, {"introduction": "现在，我们将综合对路径似然和长期动力学的理解，来解决一个实际的数据分析问题。遍历定理（ergodic theorem）允许我们使用单条长轨迹的时间平均来估计系综平均值，例如相对熵率（relative entropy rate），它量化了两种不同模型参数化之间的可区分性。这项综合性练习 ([@problem_id:3303203]) 将指导您完成从推导相对熵率的估计量，到通过批次均值法（batch means method）进行计算实现和评估其统计不确定性的整个工作流程。这项实践旨在培养将理论原理应用于真实模拟数据以进行模型比较和分析的关键技能。", "problem": "给定一个连续时间、有限状态的化学反应网络，该网络被建模为连续时间马尔可夫链 (CTMC)。该网络通过随机模拟算法 (SSA)（也称为 Gillespie 算法）进行模拟。设 $X_t \\in \\mathbb{N}^d$ 表示在时间 $t$ 的状态，其中有 $d \\in \\mathbb{N}$ 个物种。存在 $R \\in \\mathbb{N}$ 个反应，每个反应都有化学计量向量 $\\nu_r \\in \\mathbb{Z}^d$ 和依赖于参数向量 $\\theta \\in \\Theta \\subset \\mathbb{R}^p$ 的倾向（强度）函数 $a_\\theta(x,r)$。总强度为 $\\lambda_\\theta(x) = \\sum_{r=1}^R a_\\theta(x,r)$。对于两个参数值 $\\theta$ 和 $\\theta'$，请考虑它们在轨迹 $\\{X_t\\}_{t \\in [0,T]}$ 上诱导的路径测度。\n\n您的任务如下。\n\n1) 从作为随机模拟算法 (SSA) 基础的标记点过程的标准似然表示出发，用倾向函数 $a_\\theta(x,r)$、总强度 $\\lambda_\\theta(x)$ 以及已实现的反应标记来表示在参数 $\\theta$ 相对于 $\\theta'$ 下观测到一条轨迹 $\\{X_t\\}_{t \\in [0,T]}$ 的对数似然比。将相对熵率 $\\mathcal{R}(\\theta \\| \\theta')$ 定义为在参数为 $\\theta$ 的过程的平稳分布下，单位时间内对数似然比期望的长时间极限。\n\n2) 在将 $\\mathcal{R}(\\theta \\| \\theta')$ 表示为关于 $\\theta$ 下 $X_t$ 的平稳分布的平稳期望时，从第 1 部分中出现的平稳被积函数设为 $\\Psi_{\\theta,\\theta'}(x)$。使用 CTMC 的遍历定理，基于单条长 SSA 轨迹 $\\{X_t\\}_{t \\in [0,T]}$，构建 $\\mathcal{R}(\\theta \\| \\theta')$ 的一个一致估计量 $\\widehat{\\mathcal{R}}_T$，该估计量写为状态函数在连续时间上的平均值。您的估计量必须能从 SSA 产生的分段常数路径（由一系列停留时间和状态组成）计算得出。\n\n3) 使用 CTMC 遍历加性泛函的鞅中心极限定理 (MCLT)，推导中心化可观测量 $g(X_t)$ 的时间平均估计量的渐近分布，并将您的结果特化到 $g(x) = \\Psi_{\\theta,\\theta'}(x) - \\mathcal{R}(\\theta \\| \\theta')$ 的情况。将渐近方差 $\\sigma^2_{\\theta,\\theta'}$ 用以下至少一种等价方式表示：作为连续时间上的积分自协方差，或通过与 CTMC 生成元相关的泊松方程。然后，提出并论证一个统计上一致的、基于模拟的 $\\sigma^2_{\\theta,\\theta'}$ 估计量 $\\widehat{\\sigma^2}_{\\theta,\\theta'}$，该估计量仅使用单条长 SSA 轨迹，且无需解泊松方程。\n\n4) 实现一个完整的程序，该程序：\n- 对下面指定的每个测试用例，在参数 $\\theta$ 下模拟长 SSA 轨迹。\n- 使用 SSA 轨迹计算第 2 部分中的一致估计量 $\\widehat{\\mathcal{R}}_T$。\n- 使用连续时间上的批均值估计量来估计渐近方差 $\\widehat{\\sigma^2}_{\\theta,\\theta'}$：将老化期后的时间区间划分为 $B$ 个宽度为 $w$ 的等时长批次，计算每个批次上 $\\Psi_{\\theta,\\theta'}(X_t)$ 的批均值，并使用这些批均值的样本方差通过关系式 $\\mathrm{Var}(\\text{批均值}) \\approx \\sigma^2_{\\theta,\\theta'} / w$ 来估计 $\\sigma^2_{\\theta,\\theta'}$。\n- 使用固定的随机种子，以使所有输出都是可复现的。\n- 将最终输出生成在单行上，格式为一个方括号内逗号分隔的列表，其中每个测试用例贡献一个双元素列表 $[\\widehat{\\mathcal{R}}_T,\\widehat{\\sigma^2}_{\\theta,\\theta'}]$。将报告的每个数字四舍五入到 6 位小数。\n\n约束和建模细节：\n- 测试套件中的网络是每个物种独立的生灭过程。对于物种索引 $i \\in \\{1,\\dots,d\\}$，反应为：出生 $X_i \\to X_i + 1$，速率为 $k_{b,i}$；死亡 $X_i \\to X_i - 1$，速率为 $k_{d,i} X_i$。因此，对于每个物种，$a_\\theta(x,\\text{birth}_i) = k_{b,i}$ 和 $a_\\theta(x,\\text{death}_i) = k_{d,i}\\, x_i$。总强度为 $\\lambda_\\theta(x) = \\sum_{i=1}^d \\left(k_{b,i} + k_{d,i}\\, x_i\\right)$。只有倾向函数为非负的有效反应才能发生。在以下测试中，$\\theta$ 和 $\\theta'$ 的所有分量都严格为正。\n- 您必须使用随机模拟算法 (SSA) 模拟至总时间范围 $T_{\\text{total}}$，并从所有估计量中舍弃一个老化期 $T_b$。使用 $B$ 个等时长的批次，批次宽度 $w = (T_{\\text{total}} - T_b)/B$。\n- 使用每个测试指定的初始条件 $X_0$。如果某个分量将变为负数，则在 SSA 中通过其零倾向函数来抑制该反应。\n\n测试套件：\n- 测试 1：维度 $d=1$。参数 $\\theta=(k_b,k_d)=(1.8,1.0)$，$\\theta'=(1.5,1.0)$。初始条件 $X_0 = \\lfloor k_b/k_d \\rfloor = 1$。时间范围 $T_{\\text{total}}=20000$，老化期 $T_b=2000$，批次 $B=50$。\n- 测试 2：维度 $d=2$。参数 $\\theta=(k_b,k_d)=([2.0,1.5],[1.0,0.75])$，$\\theta'=([2.1,1.6],[1.0,0.75])$。初始条件 $X_0 = \\left(\\lfloor 2.0/1.0 \\rfloor,\\lfloor 1.5/0.75 \\rfloor\\right)=(2,2)$。时间范围 $T_{\\text{total}}=20000$，老化期 $T_b=2000$，批次 $B=50$。\n- 测试 3：维度 $d=2$。参数 $\\theta=(k_b,k_d)=([1.2,0.9],[0.9,0.6])$，$\\theta'=(k_b',k_d')=\\theta$。初始条件 $X_0 = \\left(\\lfloor 1.2/0.9 \\rfloor,\\lfloor 0.9/0.6 \\rfloor\\right)=(1,1)$。时间范围 $T_{\\text{total}}=20000$，老化期 $T_b=2000$，批次 $B=50$。\n\n数值和输出要求：\n- 使用固定的随机种子，等于 $1729$。\n- 对于每个测试，计算并返回一个列表 $[\\widehat{\\mathcal{R}}_T,\\widehat{\\sigma^2}_{\\theta,\\theta'}]$，两个条目都四舍五入到 6 位小数。\n- 您的程序应生成单行输出，包含结果，格式为方括号内逗号分隔的列表，测试用例按 1、2、3 的顺序排列。例如，输出格式必须为 $[[x_{1},y_{1}],[x_{2},y_{2}],[x_{3},y_{3}]]$，其中每个 $x_i$ 和 $y_i$ 是四舍五入到 6 位小数的浮点数。", "solution": "用户的问题被验证为具有科学依据、问题明确且客观。这是对随机化学动力学进行统计分析的严谨练习，借鉴了连续时间马尔可夫链、点过程和统计估计理论中的既定原则。该问题结构为一个引导性推导，后附一个数值实现，所有必要的参数和模型都已明确指定。\n\n### 第 1 部分：对数似然比和相对熵率\n\n在有限状态空间上，由随机模拟算法 (SSA) 模拟的连续时间马尔可夫链的轨迹可以表示为一个标记点过程。在时间区间 $[0, T]$ 上的轨迹由初始状态 $X_0=x_0$、在时间 $0  t_1  t_2  \\ldots  t_N  T$ 发生的 $N$ 个反应事件（标记）序列 $r_1, r_2, \\ldots, r_N$ 以及访问过的状态 $x_0, x_1, \\ldots, x_N$ 完全描述，其中对于 $k=1, \\ldots, N$，有 $x_k = x_{k-1} + \\nu_{r_k}$。系统在 $t \\in [t_{k-1}, t_k)$ 时的状态为 $X_t = x_{k-1}$，其中 $t_0=0$。\n\n在参数向量 $\\theta$ 下观测到这一特定路径历史的似然是每个事件的概率与事件间停留时间的概率的乘积。给定状态 $x_{k-1}$，第 $k$ 个反应 $r_k$ 在时间 $t_k$ 发生的概率密度由其倾向函数 $a_\\theta(x_{k-1}, r_k)$ 给出。在时间 $t_{k-1}$ 和 $t_k$ 之间没有反应发生的概率是 $\\exp\\left(-\\lambda_\\theta(x_{k-1})(t_k - t_{k-1})\\right)$，其中 $\\lambda_\\theta(x) = \\sum_{r=1}^R a_\\theta(x, r)$ 是总强度。\n\n轨迹的完整似然是：\n$$ L(\\text{traj}|\\theta) = \\left( \\prod_{k=1}^N a_\\theta(x_{k-1}, r_k) \\right) \\exp\\left( -\\sum_{k=1}^N \\lambda_\\theta(x_{k-1})(t_k - t_{k-1}) - \\lambda_\\theta(x_N)(T - t_N) \\right) $$\n指数中的和可以重写为总强度在路径 $\\{X_s\\}_{s \\in [0,T]}$ 上的连续时间积分：\n$$ \\int_0^T \\lambda_\\theta(X_s) ds = \\sum_{k=1}^N \\lambda_\\theta(x_{k-1})(t_k - t_{k-1}) + \\lambda_\\theta(x_N)(T - t_N) $$\n因此，对数似然，记为 $\\log L(\\theta)$，为：\n$$ \\log L(\\theta) = \\sum_{k=1}^N \\log a_\\theta(X_{t_k^-}, r_k) - \\int_0^T \\lambda_\\theta(X_s) ds $$\n其中 $X_{t_k^-} = x_{k-1}$ 是第 $k$ 次跳跃前的状态。\n\n在参数 $\\theta$ 相对于 $\\theta'$ 下观测到轨迹的对数似然比是：\n$$ \\mathcal{LLR} = \\log\\frac{L(\\theta)}{L(\\theta')} = \\log L(\\theta) - \\log L(\\theta') $$\n$$ \\mathcal{LLR} = \\left( \\sum_{k=1}^N \\log a_\\theta(X_{t_k^-}, r_k) - \\int_0^T \\lambda_\\theta(X_s) ds \\right) - \\left( \\sum_{k=1}^N \\log a_{\\theta'}(X_{t_k^-}, r_k) - \\int_0^T \\lambda_{\\theta'}(X_s) ds \\right) $$\n合并各项，我们得到对数似然比的表达式：\n$$ \\mathcal{LLR} = \\sum_{k=1}^N \\log\\left(\\frac{a_\\theta(X_{t_k^-}, r_k)}{a_{\\theta'}(X_{t_k^-}, r_k)}\\right) - \\int_0^T (\\lambda_\\theta(X_s) - \\lambda_{\\theta'}(X_s)) ds $$\n\n相对熵率（或 Kullback-Leibler 散度率）是单位时间内期望对数似然比的长时间极限，其中期望 $E_\\theta[\\cdot]$ 是关于由 $\\theta$ 诱导的路径测度来计算的。\n$$ \\mathcal{R}(\\theta \\| \\theta') = \\lim_{T \\to \\infty} \\frac{1}{T} E_\\theta[\\mathcal{LLR}] $$\n为了计算这个期望，我们利用每个反应 $r$ 的计数过程 $N_t^r$ 可以分解为其补偿器和一个鞅：$dN_t^r = a_\\theta(X_t, r)dt + dM_t^r$，其中 $E_\\theta[dM_t^r]=0$。$\\mathcal{LLR}$ 中的和是一个随机积分 $\\sum_{k=1}^N \\dots = \\sum_{r=1}^R \\int_0^T \\log\\frac{a_\\theta(X_s, r)}{a_{\\theta'}(X_s, r)} dN_s^r$。\n取期望并代入补偿器，鞅项消失，我们得到：\n$$ E_\\theta[\\mathcal{LLR}] = E_\\theta\\left[ \\int_0^T \\sum_{r=1}^R a_\\theta(X_s, r) \\log\\left(\\frac{a_\\theta(X_s, r)}{a_{\\theta'}(X_s, r)}\\right) ds - \\int_0^T (\\lambda_\\theta(X_s) - \\lambda_{\\theta'}(X_s)) ds \\right] $$\n根据期望的线性性和 Fubini 定理：\n$$ E_\\theta[\\mathcal{LLR}] = \\int_0^T E_\\theta\\left[ \\sum_{r=1}^R a_\\theta(X_s, r) \\log\\left(\\frac{a_\\theta(X_s, r)}{a_{\\theta'}(X_s, r)}\\right) - (\\lambda_\\theta(X_s) - \\lambda_{\\theta'}(X_s)) \\right] ds $$\n我们将被积函数识别为状态的函数 $\\Psi_{\\theta,\\theta'}(x)$：\n$$ \\Psi_{\\theta,\\theta'}(x) = \\sum_{r=1}^R a_\\theta(x, r) \\log\\left(\\frac{a_\\theta(x, r)}{a_{\\theta'}(x, r)}\\right) - (\\lambda_\\theta(x) - \\lambda_{\\theta'}(x)) $$\n对于一个已达到其平稳分布 $\\pi_\\theta$ 的遍历 CTMC，期望 $E_\\theta[\\Psi_{\\theta,\\theta'}(X_s)]$ 变得与时间 $s$ 无关，等于 $E_{\\pi_\\theta}[\\Psi_{\\theta,\\theta'}(X)]$。因此，相对熵率是该被积函数的平稳期望：\n$$ \\mathcal{R}(\\theta \\| \\theta') = E_{\\pi_\\theta}[\\Psi_{\\theta,\\theta'}(X)] = \\sum_{x} \\pi_\\theta(x) \\Psi_{\\theta,\\theta'}(x) $$\n\n### 第 2 部分：相对熵率的一致估计量\n\n对于不可约、正常返的 CTMC，遍历定理指出，对于状态空间上的任何函数 $f$ 使得 $E_{\\pi_\\theta}[|f(X)|]  \\infty$，时间平均几乎必然收敛于平稳期望：\n$$ \\lim_{T\\to\\infty} \\frac{1}{T}\\int_0^T f(X_s)ds = E_{\\pi_\\theta}[f(X)] $$\n我们可以通过将此定理应用于 $f(x) = \\Psi_{\\theta,\\theta'}(x)$ 来构建 $\\mathcal{R}(\\theta \\| \\theta')$ 的一个一致估计量。所得估计量 $\\widehat{\\mathcal{R}}_T$ 是 $\\Psi_{\\theta,\\theta'}(X_t)$ 在单条长轨迹上的时间平均值：\n$$ \\widehat{\\mathcal{R}}_T = \\frac{1}{T} \\int_0^T \\Psi_{\\theta,\\theta'}(X_s) ds $$\n对于由 SSA 生成的轨迹，路径 $X_s$ 是分段常数的。设在 $[0, T]$ 内的跳跃时间为 $t_1, \\ldots, t_N$，状态为 $x_0, \\ldots, x_N$。该积分计算为在这些状态恒定的区间上的和：\n$$ \\widehat{\\mathcal{R}}_T = \\frac{1}{T} \\left( \\sum_{k=1}^N \\Psi_{\\theta,\\theta'}(x_{k-1}) (t_k - t_{k-1}) + \\Psi_{\\theta,\\theta'}(x_N) (T - t_N) \\right) $$\n在实践中，会舍弃一个老化期 $T_b$，以使过程接近平稳状态。然后，估计量在时长为 $T_e = T_{\\text{total}} - T_b$ 的区间 $[T_b, T_{\\text{total}}]$ 上计算：\n$$ \\widehat{\\mathcal{R}}_{T_e} = \\frac{1}{T_e} \\int_{T_b}^{T_{\\text{total}}} \\Psi_{\\theta,\\theta'}(X_s) ds $$\n\n### 第 3 部分：渐近方差和批均值估计量\n\n遍历 CTMC 加性泛函的鞅中心极限定理 (MCLT) 描述了时间平均估计量的渐近分布。对于中心化可观测量 $g(X_t) = \\Psi_{\\theta,\\theta'}(X_t) - \\mathcal{R}(\\theta \\| \\theta')$，该定理指出：\n$$ \\sqrt{T_e} \\left( \\widehat{\\mathcal{R}}_{T_e} - \\mathcal{R}(\\theta \\| \\theta') \\right) = \\frac{1}{\\sqrt{T_e}} \\int_{T_b}^{T_{\\text{total}}} g(X_s) ds \\quad \\xrightarrow{d} \\quad \\mathcal{N}(0, \\sigma^2_{\\theta,\\theta'}) $$\n当 $T_e \\to \\infty$ 时。渐近方差 $\\sigma^2_{\\theta,\\theta'}$ 量化了估计量的波动幅度。它可以表示为在平稳状态下中心化可观测量的积分时间自协方差：\n$$ \\sigma^2_{\\theta,\\theta'} = 2 \\int_0^\\infty \\text{Cov}_{\\pi_\\theta}(g(X_0), g(X_t)) dt = 2 \\int_0^\\infty E_{\\pi_\\theta}[g(X_0) g(X_t)] dt $$\n直接从数据中估计这个量很困难。一个实用且一致的方法是批均值估计量。将时长为 $T_e$ 的老化期后的轨迹划分为 $B$ 个等时长 $w = T_e/B$ 的连续批次。对每个批次 $j \\in \\{1, \\ldots, B\\}$，计算批均值：\n$$ Y_j = \\frac{1}{w} \\int_{T_b + (j-1)w}^{T_b + j w} \\Psi_{\\theta,\\theta'}(X_s) ds $$\n如果批次宽度 $w$ 足够大，大于过程的相关时间，则批均值 $Y_1, \\ldots, Y_B$ 近似独立同分布。单个批均值的方差约为 $\\text{Var}(Y_j) \\approx \\sigma^2_{\\theta,\\theta'} / w$。\n\n我们可以通过缩放批均值的样本方差来估计 $\\sigma^2_{\\theta,\\theta'}$。$\\{Y_j\\}_{j=1}^B$ 的样本方差为：\n$$ S_Y^2 = \\frac{1}{B-1} \\sum_{j=1}^B (Y_j - \\bar{Y})^2, \\quad \\text{其中 } \\bar{Y} = \\frac{1}{B}\\sum_{j=1}^B Y_j = \\widehat{\\mathcal{R}}_{T_e} $$\n重新整理该关系，我们得到渐近方差的批均值估计量：\n$$ \\widehat{\\sigma^2}_{\\theta,\\theta'} = w \\cdot S_Y^2 = \\frac{w}{B-1} \\sum_{j=1}^B (Y_j - \\widehat{\\mathcal{R}}_{T_e})^2 $$\n在 $B \\to \\infty$ 和 $w \\to \\infty$ 的极限下，该估计量对于 $\\sigma^2_{\\theta,\\theta'}$ 是一致的。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the simulation and analysis for all test cases.\n    \"\"\"\n    np.random.seed(1729)\n\n    test_cases = [\n        {\n            \"d\": 1,\n            \"theta\": {\"kb\": np.array([1.8]), \"kd\": np.array([1.0])},\n            \"theta_prime\": {\"kb\": np.array([1.5]), \"kd\": np.array([1.0])},\n            \"x0\": np.array([1]),\n            \"T_total\": 20000, \"T_b\": 2000, \"B\": 50,\n        },\n        {\n            \"d\": 2,\n            \"theta\": {\"kb\": np.array([2.0, 1.5]), \"kd\": np.array([1.0, 0.75])},\n            \"theta_prime\": {\"kb\": np.array([2.1, 1.6]), \"kd\": np.array([1.0, 0.75])},\n            \"x0\": np.array([2, 2]),\n            \"T_total\": 20000, \"T_b\": 2000, \"B\": 50,\n        },\n        {\n            \"d\": 2,\n            \"theta\": {\"kb\": np.array([1.2, 0.9]), \"kd\": np.array([0.9, 0.6])},\n            \"theta_prime\": {\"kb\": np.array([1.2, 0.9]), \"kd\": np.array([0.9, 0.6])},\n            \"x0\": np.array([1, 1]),\n            \"T_total\": 20000, \"T_b\": 2000, \"B\": 50,\n        },\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        d = case[\"d\"]\n        theta = case[\"theta\"]\n        theta_prime = case[\"theta_prime\"]\n        x0 = case[\"x0\"]\n        T_total = case[\"T_total\"]\n        T_b = case[\"T_b\"]\n        B = case[\"B\"]\n\n        # Run SSA simulation\n        times, states = ssa(d, theta, x0, T_total)\n        \n        # Calculate Psi integrand constants\n        c0, c_vec = calculate_psi_constants(theta, theta_prime)\n\n        # Post-process trajectory to get estimators\n        r_hat, sigma2_hat = analyze_trajectory(times, states, T_total, T_b, B, c0, c_vec)\n        \n        all_results.append([round(r_hat, 6), round(sigma2_hat, 6)])\n\n    print(str(all_results).replace(\" \", \"\"))\n\ndef ssa(d, theta, x0, t_total):\n    \"\"\"\n    Performs a Stochastic Simulation Algorithm (Gillespie) run.\n    \"\"\"\n    kb, kd = theta[\"kb\"], theta[\"kd\"]\n    \n    times = [0.0]\n    states = [np.copy(x0)]\n    \n    t = 0.0\n    x = np.copy(x0)\n    \n    # Stoichiometry matrix: first d rows are births, next d are deaths\n    stoich = np.vstack([np.eye(d, dtype=int), -np.eye(d, dtype=int)])\n\n    while t  t_total:\n        propensities = np.concatenate([kb, kd * x])\n        \n        # Suppress death reactions if count is zero\n        propensities[d:] = np.where(x  0, propensities[d:], 0)\n        \n        lambda_total = np.sum(propensities)\n\n        if lambda_total = 0:\n            # No more reactions possible, absorbing state.\n            break\n\n        dt = np.random.exponential(1.0 / lambda_total)\n        \n        # Choose reaction\n        r = np.random.choice(2 * d, p=propensities / lambda_total)\n\n        t += dt\n        if t  t_total:\n            # We only need the trajectory up to t_total.\n            # The last state is held until t_total.\n            break\n\n        x += stoich[r]\n        \n        times.append(t)\n        states.append(np.copy(x))\n        \n    return np.array(times), np.array(states)\n\ndef calculate_psi_constants(theta, theta_prime):\n    \"\"\"\n    Calculates the constants for the affine function Psi(x) = c0 + c_vec.dot(x).\n    \"\"\"\n    kb, kd = theta[\"kb\"], theta[\"kd\"]\n    kb_p, kd_p = theta_prime[\"kb\"], theta_prime[\"kd\"]\n\n    # Term for a_theta * log(a_theta/a_theta_prime) where a_theta=0 should be 0.\n    # Handled by numpy's x*log(x) - 0 limit.\n    # Here, we pre-calculate based on the derived affine form, which is safe.\n\n    with np.errstate(divide='ignore', invalid='ignore'):\n        log_term_b = kb * np.log(kb / kb_p)\n        log_term_d = kd * np.log(kd / kd_p)\n\n    log_term_b = np.nan_to_num(log_term_b)\n    log_term_d = np.nan_to_num(log_term_d)\n    \n    c0 = np.sum(log_term_b - (kb - kb_p))\n    c_vec = log_term_d - (kd - kd_p)\n    \n    return c0, c_vec\n\ndef analyze_trajectory(times, states, T_total, T_b, B, c0, c_vec):\n    \"\"\"\n    Computes the estimators for R and sigma^2 using batch means.\n    \"\"\"\n    # Calculate Psi(x) for each state in the trajectory\n    psi_vals = c0 + states @ c_vec\n\n    T_eff = T_total - T_b\n    w = T_eff / B\n    batch_integrals = np.zeros(B)\n\n    # Add the final time point to correctly handle the last interval\n    if times[-1]  T_total:\n        times = np.append(times, T_total)\n        states = np.vstack([states, states[-1]])\n        psi_vals = np.append(psi_vals, psi_vals[-1])\n        \n    # Iterate through each segment of the piecewise-constant path\n    for k in range(1, len(times)):\n        t_start, t_end = times[k-1], times[k]\n        psi = psi_vals[k-1]\n        \n        # Find the portion of this segment that is post-burn-in\n        interval_start = max(t_start, T_b)\n        interval_end = min(t_end, T_total)\n\n        if interval_start = interval_end:\n            continue\n        \n        # Distribute the integral contribution of this segment to the correct batches\n        t = interval_start\n        while t  interval_end:\n            batch_idx = int((t - T_b) / w)\n            if batch_idx = B: batch_idx = B - 1 # Handle floating point edge cases\n            \n            batch_end_time = T_b + (batch_idx + 1) * w\n            \n            contribution_end = min(interval_end, batch_end_time)\n            dt = contribution_end - t\n            \n            batch_integrals[batch_idx] += psi * dt\n            t = contribution_end\n    \n    # Calculate the final estimators\n    total_integral = np.sum(batch_integrals)\n    r_hat = total_integral / T_eff if T_eff  0 else 0.0\n\n    batch_means = batch_integrals / w\n    # Use ddof=1 for sample variance (1/(B-1) factor)\n    sigma2_hat = w * np.var(batch_means, ddof=1) if B  1 else 0.0\n\n    return r_hat, sigma2_hat\n\nsolve()\n```", "id": "3303203"}]}