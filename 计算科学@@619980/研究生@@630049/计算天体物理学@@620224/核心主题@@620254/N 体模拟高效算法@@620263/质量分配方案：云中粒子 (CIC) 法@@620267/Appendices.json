{"hands_on_practices": [{"introduction": "要精通任何数值方法，首先必须掌握其最基本的操作。“云在格点”(Cloud-in-Cell, CIC) 方案的核心机制是线性插值，本练习将通过一个关键案例来巩固这一概念。您将推导一个位于周期性边界附近的粒子的权重，这有助于确保您对算法在处理环绕边界条件时的行为有牢固的理解。[@problem_id:3516929]", "problem": "考虑一个长度为 $L$ 的周期性一维域，该域由 $N$ 个均匀分布的网格节点离散化，节点位置为 $x_i = i\\,\\Delta$，$i \\in \\{0,1,\\dots,N-1\\}$，网格间距为 $\\Delta \\equiv L/N$。在采用云中单元（Cloud-In-Cell, CIC）质量分配的粒子-网格（Particle-Mesh）方法中，一个位于位置 $x_p$、质量为 $m_p$ 的粒子，通过将其狄拉克δ函数（Dirac delta）与一个一维、紧支集、分段线性的 CIC 核函数进行卷积，从而对网格密度产生贡献，该核函数的支撑集大小为 $\\Delta$ 且经过单位归一化。该域是严格周期性的，因此距离是根据周长为 $L$ 的圆上的最小间隔来测量的。\n\n一个粒子位于 $x_p = L - \\epsilon$，其中 $0  \\epsilon  \\Delta$。请仅使用上述定义和圆上周期性距离的第一性原理，推导分配给网格节点 $i=N-1$ 和 $i=0$ 的归一化 CIC 权重 $w_i$，并明确证明对于该粒子，这些是仅有的非零贡献。此外，请证明总分配权重是守恒的。\n\n请以行矩阵 $\\begin{pmatrix} w_{N-1}  w_{0} \\end{pmatrix}$ 的形式给出最终答案，该答案应为关于 $\\epsilon$ 和 $\\Delta$ 的闭合形式函数。无需进行数值计算，也无需单位。最终答案必须是单个解析表达式。", "solution": "在尝试解答之前，将对问题进行验证。\n\n### 步骤 1：提取已知条件\n- 域：周期性，一维，长度 $L$。\n- 网格：$N$ 个均匀分布的网格节点，位置为 $x_i = i\\,\\Delta$，$i \\in \\{0,1,\\dots,N-1\\}$。\n- 网格间距：$\\Delta \\equiv L/N$。\n- 方法：使用云中单元（CIC）质量分配的粒子-网格方法。\n- 核函数描述：分配方法被描述为将粒子的狄拉克δ函数与一个一维、紧支集、分段线性的核函数进行卷积，该核函数的支撑集大小为 $\\Delta$ 且经过单位归一化。\n- 粒子属性：质量为 $m_p$，位于位置 $x_p = L - \\epsilon$，约束条件为 $0  \\epsilon  \\Delta$。\n- 距离度量：周长为 $L$ 的圆上的最小间隔（周期性边界条件）。\n- 要求任务：\n    1. 推导节点 $i=N-1$ 和 $i=0$ 的归一化 CIC 权重 $w_i$。\n    2. 明确证明这些是仅有的非零权重。\n    3. 证明总分配权重是守恒的。\n\n### 步骤 2：使用提取的已知条件进行验证\n该问题定义明确，在计算天体物理学领域有科学依据，且表述客观。它涉及一种标准的数值技术，即云中单元（CIC）质量分配方案。\n\n问题陈述中存在一个潜在的歧义。问题明确指出了“云中单元（Cloud-In-Cell, CIC）”方法，但对其核函数的描述与标准公式有细微的不一致。具体来说，它提到了一个“支撑集大小为 $\\Delta$ 的核函数”。对一个以粒子位置为中心、支撑集宽度为 $\\Delta$ 的核函数的字面解释将意味着质量通常只分配给一个网格节点（因为节点间距也是 $\\Delta$），这与 CIC 将质量插值到两个最近节点的定义性特征相矛盾。标准的 CIC 方法采用一个支撑集大小为 $2\\Delta$ 的有效连续核函数（一个三角函数），这确保了一个粒子总是恰好对两个节点有贡献。\n\n然而，“支撑集 $\\Delta$”这个短语可以在 CIC 算法在网格上操作的背景下得到合理解释。在 CIC 中，位于宽度为 $\\Delta$ 的网格单元内（例如，在节点 $i$ 和 $i+1$ 之间）的粒子仅将其质量分配给这两个边界节点。就受影响的网格单元而言，分配的“支撑”是一个单元。鉴于问题明确引用了众所周知的“云中单元”名称，后一种解释更有可能是其本意。\n\n因此，在假设问题指的是标准 CIC 质量分配方案的前提下，该问题被认为是有效的，其中描述性文本是对算法的一个略有不精确但在上下文中可以理解的刻画。\n\n### 步骤 3：结论与行动\n问题有效。将基于云中单元方法的标准定义，提供一个完整、合理的解答。\n\n一维的云中单元（CIC）质量分配方案是一种线性插值方法。对于位于网格节点 $x_i$ 和 $x_{i+1}$ 之间的网格单元内、位置为 $x_p$ 的粒子，其质量被分配到这两个节点上。权重与粒子到对侧节点的距离成线性比例。\n\n网格节点位于 $x_i = i\\Delta$，$i \\in \\{0, 1, \\dots, N-1\\}$。网格间距为 $\\Delta = L/N$。该域是周期性的，因此位于 $x=L$ 的节点与位于 $x=0$ 的节点相同。\n粒子位于 $x_p = L - \\epsilon$，其中 $0  \\epsilon  \\Delta$。\n\n我们必须首先确定粒子所在的网格单元。网格节点位于 $\\Delta$ 的整数倍处。节点 $i=N-1$ 位于 $x_{N-1} = (N-1)\\Delta = N\\Delta - \\Delta = L - \\Delta$。序列中的下一个节点将是 $i=N$，位于 $x_N = N\\Delta = L$。由于周期性，这个位置等同于位于 $x_0 = 0$ 的节点 $i=0$。\n\n粒子的位置是 $x_p = L - \\epsilon$。鉴于 $0  \\epsilon  \\Delta$，可以得出 $L - \\Delta  L - \\epsilon  L$。\n这意味着 $x_{N-1}  x_p  x_N$，其中 $x_N$ 是 $x_0$ 的周期性等效位置。因此，该粒子位于连接节点 $i=N-1$ 和 $i=0$ 的网格单元中。根据 CIC 方案，这两个是唯一会接收到非零权重的节点。\n\n让我们将该单元的“左”节点表示为 $x_{N-1}$，其“右”节点表示为 $x_0 \\equiv L$。该单元的宽度为 $\\Delta$。粒子在该单元内的位置，从左节点 $x_{N-1}$ 测量，为：\n$$d = x_p - x_{N-1} = (L - \\epsilon) - (L - \\Delta) = \\Delta - \\epsilon$$\n粒子距离左节点的分数距离为 $\\delta_{frac} = d / \\Delta$。\n$$\\delta_{frac} = \\frac{\\Delta - \\epsilon}{\\Delta} = 1 - \\frac{\\epsilon}{\\Delta}$$\n根据 CIC 算法，分配给右节点（$i=0$）的权重等于此分数距离，而分配给左节点（$i=N-1$）的权重是 $1$ 减去此分数距离。\n\n节点 $i=0$ 上的权重：\n$$w_0 = \\delta_{frac} = \\frac{\\Delta - \\epsilon}{\\Delta}$$\n\n节点 $i=N-1$ 上的权重：\n$$w_{N-1} = 1 - \\delta_{frac} = 1 - \\left(\\frac{\\Delta - \\epsilon}{\\Delta}\\right) = \\frac{\\Delta - (\\Delta - \\epsilon)}{\\Delta} = \\frac{\\epsilon}{\\Delta}$$\n\n为证明这些是仅有的非零贡献，我们考虑相邻节点。CIC 核函数 $W(x_p - x_i)$ 仅在 $|x_p - x_i|  \\Delta$（使用周期性距离）时非零。\n考虑节点 $i=N-2$：$x_{N-2} = (N-2)\\Delta = L - 2\\Delta$。周期性距离为：\n$$d(x_p, x_{N-2}) = |(L-\\epsilon) - (L-2\\Delta)| = |2\\Delta - \\epsilon|$$\n由于 $0  \\epsilon  \\Delta$，我们有 $\\Delta  2\\Delta - \\epsilon  2\\Delta$。此距离大于 $\\Delta$，因此 $w_{N-2} = 0$。\n\n考虑节点 $i=1$：$x_1 = \\Delta$。周期性距离必须考虑域的环绕特性。直接距离是 $|x_p - x_1| = |(L-\\epsilon) - \\Delta| = L - \\Delta - \\epsilon$。跨越周期性边界的距离是 $\\epsilon + \\Delta$。最小间隔是：\n$$d(x_p, x_1) = \\min(L - \\Delta - \\epsilon, \\Delta + \\epsilon) = \\Delta + \\epsilon$$\n由于 $\\epsilon > 0$，此距离大于 $\\Delta$，因此 $w_1 = 0$。\n所有其他节点都更远，因此它们的权重也为零。\n\n最后，我们证明总权重是守恒的（即权重之和为 $1$）。\n$$\\sum_i w_i = w_{N-1} + w_0 = \\frac{\\epsilon}{\\Delta} + \\frac{\\Delta-\\epsilon}{\\Delta} = \\frac{\\epsilon + \\Delta - \\epsilon}{\\Delta} = \\frac{\\Delta}{\\Delta} = 1$$\n总分配权重是守恒的，从而验证了所推导的表达式是归一化权重。\n\n最终结果是节点 $i=N-1$ 和 $i=0$ 的权重集。\n$w_{N-1} = \\frac{\\epsilon}{\\Delta}$\n$w_0 = \\frac{\\Delta - \\epsilon}{\\Delta}$", "answer": "$$\\boxed{\\begin{pmatrix} \\frac{\\epsilon}{\\Delta}  \\frac{\\Delta - \\epsilon}{\\Delta} \\end{pmatrix}}$$", "id": "3516929"}, {"introduction": "将离散粒子映射到网格上必然会引入平滑效应，这会模糊小尺度上的结构。为了理解并最终校正这种效应，我们首先需要对其进行量化。本练习将引导您通过计算 CIC 方案对应窗口函数的二阶矩，来推导其“有效平滑尺度”，这是连接算法的实空间行为与其傅里叶空间特性的重要桥梁。[@problem_id:3516951]", "problem": "考虑一个一维均匀笛卡尔网格，其网格间距为 $\\Delta$（假设 $\\Delta$ 的单位是米）。在粒子-网格密度分配中，通过将位于原点的单位质量粒子与一个紧凑归一化的窗函数 $W(x)$ 进行卷积，将其映射到网格上，从而实现对密度场的有效平滑。窗函数 $W(x)$ 假定为偶函数且被归一化，使得 $\\int_{-\\infty}^{\\infty} W(x)\\,dx = 1$。质量分配方案的有效平滑尺度可以通过其二阶矩来表征\n$$\nm_{2} \\equiv \\int_{-\\infty}^{\\infty} x^{2} W(x)\\,dx,\n$$\n其量纲为长度的平方。\n\n在计算天体物理学中常用的质量分配方案包括最近邻网格点（NGP）、云中粒子（CIC）和三角形云（TSC）。从网格插值和质量守恒的基本思想出发：\n- 对于最近邻网格点（NGP），单位质量被完全分配给最近的单个网格点，这对应于在单个单元上的均匀高顶礼帽窗函数。\n- 对于云中粒子（CIC），单位质量根据距离按比例线性地分配给最近的两个网格点，这对应于在两个单元上有紧支集的分段线性窗函数。\n- 对于三角形云（TSC），单位质量通过一个连续的分段二次廓线分布在三个相邻单元上，这对应于具有更大支集和更高光滑度的紧凑窗函数。\n\n利用这些物理特性，通过推断支集和连续性如何影响 $m_{2}$ 的大小，比较 NGP、CIC 和 TSC 方案的有效平滑尺度的顺序。然后，根据线性距离权重和质量守恒的要求，显式推导一维云中粒子（CIC）窗函数 $W_{\\mathrm{CIC}}(x)$，并计算 CIC 的二阶矩\n$$\nm_{2,\\mathrm{CIC}} = \\int_{-\\infty}^{\\infty} x^{2} W_{\\mathrm{CIC}}(x)\\,dx\n$$\n以闭合形式表示。\n\n将你的最终答案表示为仅含 $\\Delta$ 的单个解析表达式。最终方框内的表达式不应包含单位。不需要进行数值舍入。", "solution": "问题陈述已经过验证，被认为是可靠、适定且具有科学依据的。它提出了一个关于质量分配方案表征的计算天体物理学标准问题。因此，我们可以开始求解。\n\n该问题要求得到两个主要结果：首先，定性比较最近邻网格点（NGP）、云中粒子（CIC）和三角形云（TSC）方案的有效平滑尺度；其次，显式推导一维 CIC 窗函数并计算其二阶矩。\n\n有效平滑尺度由窗函数 $W(x)$ 的二阶矩量化，定义为\n$$\nm_{2} \\equiv \\int_{-\\infty}^{\\infty} x^{2} W(x)\\,dx\n$$\n由于窗函数 $W(x)$ 代表粒子的有效质量分布且为非负（$W(x) \\ge 0$），量 $m_2$ 可以解释为该分布的方差（对于以原点为中心的分布）。被积函数中的 $x^2$ 项给予了函数中离原点较远部分更大的权重。因此，一个分布更广的窗函数，即具有更大有效宽度或支集的窗函数，其二阶矩 $m_2$ 将会更大。\n\n让我们根据这三种方案的物理描述及其在网格间距为 $\\Delta$ 的网格上的支集来分析它们的窗函数：\n1.  **最近邻网格点（NGP）：** 该方案将粒子的全部质量分配给最近的单个网格点。这等效于使用一个高顶礼帽或盒型窗函数 $W_{\\mathrm{NGP}}(x)$，它在一个网格单元上是均匀的。为了以原点为中心，其支集必须是 $[-\\Delta/2, \\Delta/2]$，总宽度为 $\\Delta$。\n2.  **云中粒子（CIC）：** 该方案将粒子的质量线性地分配给最近的两个网格点。这对应于一个三角形窗函数 $W_{\\mathrm{CIC}}(x)$，它是分段线性的，并且其支集跨越两个网格单元。以原点为中心，其支集为 $[-\\Delta, \\Delta]$，总宽度为 $2\\Delta$。\n3.  **三角形云（TSC）：** 该方案使用分段二次廓线将质量分布在三个单元上。相应的窗函数 $W_{\\mathrm{TSC}}(x)$ 比 CIC 窗函数更光滑，且具有更宽的支集。以原点为中心，其支集为 $[-3\\Delta/2, 3\\Delta/2]$，总宽度为 $3\\Delta$。\n\n窗函数的支集从 NGP 到 CIC 再到 TSC 依次增大：$\\text{width}(W_{\\mathrm{NGP}})  \\text{width}(W_{\\mathrm{CIC}})  \\text{width}(W_{\\mathrm{TSC}})$。更宽的支集意味着质量分布在离中心更大范围的距离上。由于 $m_2$ 衡量的是离原点的均方偏移，一个更宽的分布将固有地导致更大的 $m_2$ 值。因此，我们可以定性地将平滑尺度排序为：\n$$\nm_{2,\\mathrm{NGP}}  m_{2,\\mathrm{CIC}}  m_{2,\\mathrm{TSC}}\n$$\n\n接下来，我们将显式推导 CIC 窗函数 $W_{\\mathrm{CIC}}(x)$，并计算其二阶矩 $m_{2,\\mathrm{CIC}}$。\n\nCIC 方案的定义性特征是它在最近的两个网格点之间进行质量的线性插值。让我们将其形式化以推导窗函数的形状。在粒子-网格方法中，窗函数 $W(x)$ 通常与分配函数 $S(x-x_j)$ 成正比，该函数给出位于位置 $x$ 的粒子的质量被分配到网格点 $x_j$ 的分数。\n\n考虑一个位于两个网格点之间的粒子，其位置为 $x_p$，这两个网格点分别在 $x=0$ 和 $x=\\Delta$。因此，$0 \\le x_p \\le \\Delta$。质量根据与网格点的距离进行线性分配。\n分配给 $x=\\Delta$ 处网格点的质量分数与粒子到 $x=0$ 处网格点的距离成正比，即 $x_p$。因此，该分数为 $x_p / \\Delta$。\n分配给 $x=0$ 处网格点的质量分数与粒子到 $x=\\Delta$ 处网格点的距离成正比，即 $\\Delta - x_p$。因此，该分数为 $(\\Delta - x_p)/\\Delta = 1 - x_p/\\Delta$。\n注意这两个分数之和为 1，实现了质量守恒。\n\n这种线性加权方案可以用一个分配函数 $S(u)$ 来描述，其中 $u$ 是以 $\\Delta$ 为单位的到网格点的距离。更一般地，对于位置在 $x_p$ 的粒子和位置在 $x_j$ 的网格点，分配的质量分数为 $S(x_p - x_j)$。\n从我们的例子中，对于 $x_j=0$ 处的网格点，分配的分数为 $1 - x_p/\\Delta$。我们要求当 $x_p \\in [0, \\Delta]$ 时，$S(x_p) = 1 - x_p/\\Delta$。\n对于 $x_j=\\Delta$ 处的网格点，分配的分数为 $x_p/\\Delta$。其自变量为 $x_p - \\Delta$。令 $u = x_p - \\Delta$，则 $u \\in [-\\Delta, 0]$ 且 $x_p = u + \\Delta$。该分数为 $(u+\\Delta)/\\Delta = 1 + u/\\Delta$。我们要求当 $u \\in [-\\Delta, 0]$ 时，$S(u) = 1 + u/\\Delta$。\n\n将这些结合起来并为了对称性使用绝对值，分配函数具有三角形的形式：\n$$\nS(x) =\n\\begin{cases}\n1 - \\frac{|x|}{\\Delta}  \\text{对于 } |x| \\le \\Delta \\\\\n0  \\text{对于 } |x|  \\Delta\n\\end{cases}\n$$\n问题陈述中指出，窗函数 $W(x)$ 是归一化的，使得 $\\int_{-\\infty}^{\\infty} W(x)\\,dx = 1$。分配函数 $S(x)$ 不一定是归一化的。我们来计算它的积分：\n$$\n\\int_{-\\infty}^{\\infty} S(x)\\,dx = \\int_{-\\Delta}^{\\Delta} \\left(1 - \\frac{|x|}{\\Delta}\\right)dx\n$$\n由于被积函数是偶函数，我们可以写成：\n$$\n\\int_{-\\Delta}^{\\Delta} \\left(1 - \\frac{|x|}{\\Delta}\\right)dx = 2 \\int_{0}^{\\Delta} \\left(1 - \\frac{x}{\\Delta}\\right)dx = 2 \\left[x - \\frac{x^2}{2\\Delta}\\right]_{0}^{\\Delta} = 2 \\left(\\Delta - \\frac{\\Delta^2}{2\\Delta}\\right) = 2 \\left(\\Delta - \\frac{\\Delta}{2}\\right) = \\Delta\n$$\n为了得到归一化的窗函数 $W_{\\mathrm{CIC}}(x)$，我们必须将 $S(x)$ 除以其积分值 $\\Delta$。\n$$\nW_{\\mathrm{CIC}}(x) = \\frac{1}{\\Delta} S(x) =\n\\begin{cases}\n\\frac{1}{\\Delta}\\left(1 - \\frac{|x|}{\\Delta}\\right)  \\text{对于 } |x| \\le \\Delta \\\\\n0  \\text{对于 } |x|  \\Delta\n\\end{cases}\n$$\n该函数是分段线性的，其支集跨越两个单元（$[-\\Delta, \\Delta]$），是偶函数，且归一化为 1，与所有给定的描述相符。\n\n现在我们计算二阶矩 $m_{2,\\mathrm{CIC}}$：\n$$\nm_{2,\\mathrm{CIC}} = \\int_{-\\infty}^{\\infty} x^{2} W_{\\mathrm{CIC}}(x)\\,dx = \\int_{-\\Delta}^{\\Delta} x^{2} \\left[\\frac{1}{\\Delta}\\left(1 - \\frac{|x|}{\\Delta}\\right)\\right] dx\n$$\n被积函数是关于 $x$ 的偶函数，所以我们可以简化积分：\n$$\nm_{2,\\mathrm{CIC}} = 2 \\int_{0}^{\\Delta} x^{2} \\left[\\frac{1}{\\Delta}\\left(1 - \\frac{x}{\\Delta}\\right)\\right] dx = \\frac{2}{\\Delta} \\int_{0}^{\\Delta} \\left(x^2 - \\frac{x^3}{\\Delta}\\right) dx\n$$\n我们进行积分：\n$$\nm_{2,\\mathrm{CIC}} = \\frac{2}{\\Delta} \\left[ \\frac{x^3}{3} - \\frac{x^4}{4\\Delta} \\right]_{0}^{\\Delta}\n$$\n代入积分上下限进行求值：\n$$\nm_{2,\\mathrm{CIC}} = \\frac{2}{\\Delta} \\left[ \\left(\\frac{\\Delta^3}{3} - \\frac{\\Delta^4}{4\\Delta}\\right) - (0 - 0) \\right] = \\frac{2}{\\Delta} \\left(\\frac{\\Delta^3}{3} - \\frac{\\Delta^3}{4}\\right)\n$$\n对括号内的项通分：\n$$\nm_{2,\\mathrm{CIC}} = \\frac{2}{\\Delta} \\left(\\frac{4\\Delta^3 - 3\\Delta^3}{12}\\right) = \\frac{2}{\\Delta} \\left(\\frac{\\Delta^3}{12}\\right)\n$$\n简化表达式得到最终结果：\n$$\nm_{2,\\mathrm{CIC}} = \\frac{2\\Delta^3}{12\\Delta} = \\frac{\\Delta^2}{6}\n$$\n该结果的量纲为长度的平方，符合二阶矩的要求。", "answer": "$$\\boxed{\\frac{\\Delta^2}{6}}$$", "id": "3516951"}, {"introduction": "在宇宙学等领域，从观测数据中精确测量功率谱至关重要。然而，正如我们所见，质量分配方案会在傅里叶空间中通过其窗口函数压制测量的功率谱。本练习将带您进入高级数据分析领域，解决如何从受噪声影响的网格化数据中“反卷积”出真实功率谱的关键问题。您将探索朴素方法的局限性，并实施一种包含正则化的稳健技术，从而直面偏差与方差之间的权衡，这是所有实验科学中的核心挑战。[@problem_id:3516941]", "problem": "给定一个间距为 $\\Delta$ 的三维均匀笛卡尔网格和云中单元 (Cloud-in-Cell, CIC) 质量分配方法。目标是推导傅里叶空间窗函数 $W_{\\mathrm{CIC}}(\\mathbf{k})$，计算其与功率谱相关的模的平方 $|W_{\\mathrm{CIC}}(\\mathbf{k})|^2$，并实现一个对测量功率谱的数值稳定反卷积，该反卷积要考虑在窗函数值较小的波矢附近，由正则化引入的偏差与方差之间的权衡。\n\n从以下基本概念出发：\n- 实空间中的一维顶帽盒函数 (top-hat box function) $T(x)$ 的宽度为 $\\Delta$，定义为：当 $|x| \\le \\Delta/2$ 时 $T(x) = \\frac{1}{\\Delta}$，否则 $T(x) = 0$，使得 $\\int_{-\\infty}^{\\infty} T(x) \\, dx = 1$。\n- 一维云中单元 (CIC) 分配核函数是顶帽函数自身的卷积，$w_{\\mathrm{CIC}}(x) = (T * T)(x)$，这是一个支撑集在 $[-\\Delta, \\Delta]$ 上且积分为 $1$ 的三角函数。\n- 函数 $f(\\mathbf{x})$ 的傅里叶变换定义为 $F(\\mathbf{k}) = \\int_{\\mathbb{R}^3} f(\\mathbf{x}) \\, e^{-i \\mathbf{k} \\cdot \\mathbf{x}} \\, d^3 \\mathbf{x}$。\n- 实空间中的卷积对应于傅里叶空间中的乘法：如果 $h = f * g$，那么 $\\widehat{h}(\\mathbf{k}) = \\widehat{f}(\\mathbf{k}) \\, \\widehat{g}(\\mathbf{k})$。\n\n任务：\n1. 从定义 $w_{\\mathrm{CIC}}(x) = (T * T)(x)$ 出发，并使用上述傅里叶变换定义，推导一维云中单元核函数 $w_{\\mathrm{CIC}}(x)$ 的一维傅里叶变换 $\\widehat{w}_{\\mathrm{CIC}}(k)$。利用笛卡尔网格上的可分离性，推导 $\\mathbf{k} = (k_x, k_y, k_z)$ 的三维傅里叶空间窗函数 $W_{\\mathrm{CIC}}(\\mathbf{k})$。\n2. 对于一个测量的功率谱模型 $P_{\\mathrm{meas}}(\\mathbf{k}) = |W_{\\mathrm{CIC}}(\\mathbf{k})|^2 \\, P_{\\mathrm{true}}(k) + \\eta(\\mathbf{k})$，其中 $k = \\|\\mathbf{k}\\|$，测量噪声 $\\eta(\\mathbf{k})$ 的均值为零，方差为 $\\sigma^2(\\mathbf{k})$，设计两种真实功率谱的估计量：\n   - 朴素反卷积估计量 $P_{\\mathrm{naive}}(\\mathbf{k}) = P_{\\mathrm{meas}}(\\mathbf{k}) / |W_{\\mathrm{CIC}}(\\mathbf{k})|^2$。\n   - 一个岭正则化估计量，它通过最小化一个带有 Tikhonov (岭) 惩罚项的平方误差目标函数得到，为每个 $\\mathbf{k}$ 产生一个形式为 $P_{\\mathrm{ridge}}(\\mathbf{k}) = \\alpha(\\mathbf{k}) \\, P_{\\mathrm{meas}}(\\mathbf{k})$ 的标量逆，其中标量 $\\alpha(\\mathbf{k})$ 依赖于 $|W_{\\mathrm{CIC}}(\\mathbf{k})|^2$ 和一个正则化参数 $\\lambda > 0$。\n3. 对每种估计量，推导其偏差 $\\mathrm{bias}(\\mathbf{k}) = \\mathbb{E}[P_{\\mathrm{est}}(\\mathbf{k})] - P_{\\mathrm{true}}(k)$、方差 $\\mathrm{var}(\\mathbf{k}) = \\mathrm{Var}[P_{\\mathrm{est}}(\\mathbf{k})]$ 和均方误差 $\\mathrm{mse}(\\mathbf{k}) = \\mathrm{bias}(\\mathbf{k})^2 + \\mathrm{var}(\\mathbf{k})$。用 $|W_{\\mathrm{CIC}}(\\mathbf{k})|^2$、$P_{\\mathrm{true}}(k)$、$\\sigma^2(\\mathbf{k})$ 和 $\\lambda$ 表示这些量。\n4. 实现一个程序来计算 $W_{\\mathrm{CIC}}(\\mathbf{k})$，并为下面的测试套件评估朴素估计量和岭正则化估计量的偏差、方差和均方误差。\n\n数值评估的假设和定义：\n- 在无量纲代码单位中，使用网格间距 $\\Delta = 1$。\n- 使用以“弧度/单位长度”表示的波数 $\\mathbf{k}$。这是此处使用的傅里叶变换定义所要求的。\n- 采用一个无量纲的真实各向同性功率谱 $P_{\\mathrm{true}}(k) = A \\exp\\!\\big(- (k/k_c)^2 \\big)$，在代码单位中 $A = 10$ 且 $k_c = 1$。\n- 使用一个白噪声模型 $\\sigma^2(\\mathbf{k}) = \\sigma_0^2$，其值由每个测试用例指定。\n\n测试套件：\n- 用例 1 (零波数边界，低噪声)：$\\mathbf{k} = (0, 0, 0)$，$\\lambda = 10^{-6}$，$\\sigma_0^2 = 10^{-4}$。\n- 用例 2 (理想情况，中等波数)：$\\mathbf{k} = (\\pi/4, \\pi/4, \\pi/4)$，$\\lambda = 10^{-6}$，$\\sigma_0^2 = 10^{-3}$。\n- 用例 3 (各向异性高波数，一个分量在奈奎斯特频率)：$\\mathbf{k} = (\\pi, 0, 0)$，$\\lambda = 10^{-2}$，$\\sigma_0^2 = 10^{-2}$。\n- 用例 4 (所有方向均在奈奎斯特频率的极端高波数)：$\\mathbf{k} = (\\pi, \\pi, \\pi)$，$\\lambda = 10^{-1}$，$\\sigma_0^2 = 10^{-2}$。\n- 用例 5 (高低分量混合)：$\\mathbf{k} = (0.9\\pi, 0.9\\pi, 0.1\\pi)$，$\\lambda = 5 \\times 10^{-3}$，$\\sigma_0^2 = 5 \\times 10^{-3}$。\n\n最终输出格式要求：\n- 你的程序应生成单行输出，包含一个用方括号括起来的逗号分隔列表形式的结果。\n- 每个元素对应一个测试用例，并且其本身必须是一个包含六个浮点数的列表，顺序完全如下：$[\\,|W_{\\mathrm{CIC}}(\\mathbf{k})|^2,\\; P_{\\mathrm{true}}(k),\\; \\mathrm{bias}_{\\mathrm{ridge}}(\\mathbf{k}),\\; \\mathrm{var}_{\\mathrm{ridge}}(\\mathbf{k}),\\; \\mathrm{mse}_{\\mathrm{ridge}}(\\mathbf{k}),\\; \\mathrm{mse}_{\\mathrm{naive}}(\\mathbf{k})\\,]$。\n- 在所采用的代码单位中，所有量都是无量纲的。", "solution": "该问题已经过验证并被确定为有效。它在科学上基于信号处理和傅里叶分析应用于计算宇宙学的原理，是适定的并有唯一解，且给出了客观、明确的数据和定义。\n\n解题过程按要求分为四个阶段：\n1. 推导傅里叶空间中的三维云中单元 (CIC) 窗函数。\n2. 构建用于真实功率谱的朴素估计量和岭正则化估计量。\n3. 推导两种估计量的偏差、方差和均方误差 (MSE)。\n4. 对给定的测试用例进行数值实现和评估。\n\n**1. CIC 窗函数 $W_{\\mathrm{CIC}}(\\mathbf{k})$ 的推导**\n\n推导从一维顶帽函数 $T(x)$ 开始，它是一个盒状函数，将一个粒子的质量投影到一个长度为 $\\Delta$ 的线段上。\n当 $|x| \\le \\frac{\\Delta}{2}$ 时，$T(x) = \\frac{1}{\\Delta}$，否则 $T(x) = 0$。它被归一化以使得 $\\int_{-\\infty}^{\\infty} T(x) dx = 1$。\n\n其傅里叶变换 $\\widehat{T}(k)$ 计算如下：\n$$\n\\widehat{T}(k) = \\int_{-\\infty}^{\\infty} T(x) e^{-ikx} dx = \\frac{1}{\\Delta} \\int_{-\\Delta/2}^{\\Delta/2} e^{-ikx} dx\n$$\n$$\n\\widehat{T}(k) = \\frac{1}{\\Delta} \\left[ \\frac{e^{-ikx}}{-ik} \\right]_{-\\Delta/2}^{\\Delta/2} = \\frac{1}{-ik\\Delta} \\left( e^{-ik\\Delta/2} - e^{ik\\Delta/2} \\right)\n$$\n使用欧拉恒等式 $e^{i\\theta} - e^{-i\\theta} = 2i\\sin(\\theta)$，我们得到：\n$$\n\\widehat{T}(k) = \\frac{1}{-ik\\Delta} \\left( -2i\\sin\\left(\\frac{k\\Delta}{2}\\right) \\right) = \\frac{2\\sin(k\\Delta/2)}{k\\Delta} = \\frac{\\sin(k\\Delta/2)}{k\\Delta/2}\n$$\n这是未归一化的 sinc 函数，我们记作 $\\mathrm{sinc}(x) = \\sin(x)/x$。因此，$\\widehat{T}(k) = \\mathrm{sinc}(k\\Delta/2)$。\n\n一维 CIC 分配核函数 $w_{\\mathrm{CIC}}(x)$ 是顶帽函数自身的卷积：$w_{\\mathrm{CIC}}(x) = (T * T)(x)$。根据卷积定理，其傅里叶变换 $\\widehat{w}_{\\mathrm{CIC}}(k)$ 是各个傅里叶变换的乘积：\n$$\n\\widehat{w}_{\\mathrm{CIC}}(k) = \\widehat{T}(k) \\cdot \\widehat{T}(k) = \\left( \\mathrm{sinc}\\left(\\frac{k\\Delta}{2}\\right) \\right)^2\n$$\n\n三维 CIC 核函数在笛卡尔网格上是可分离的，意味着它是三个一维核函数的乘积：$W_{\\mathrm{CIC}}^{real}(\\mathbf{x}) = w_{\\mathrm{CIC}}(x)w_{\\mathrm{CIC}}(y)w_{\\mathrm{CIC}}(z)$。因此，其三维傅里叶变换 $W_{\\mathrm{CIC}}(\\mathbf{k})$ 是每个分量波矢 $k_x, k_y, k_z$ 的一维傅里叶变换的乘积：\n$$\nW_{\\mathrm{CIC}}(\\mathbf{k}) = \\widehat{w}_{\\mathrm{CIC}}(k_x) \\widehat{w}_{\\mathrm{CIC}}(k_y) \\widehat{w}_{\\mathrm{CIC}}(k_z) = \\mathrm{sinc}^2\\left(\\frac{k_x\\Delta}{2}\\right) \\mathrm{sinc}^2\\left(\\frac{k_y\\Delta}{2}\\right) \\mathrm{sinc}^2\\left(\\frac{k_z\\Delta}{2}\\right) = \\prod_{i=x,y,z} \\mathrm{sinc}^2\\left(\\frac{k_i\\Delta}{2}\\right)\n$$\n\n**2. 功率谱估计量的构建**\n\n网格化过程对底层的连续密度场起到线性滤波器的作用。在傅里叶空间中，网格化场的变换是连续场的变换与窗函数的乘积。因此，与场的傅里叶变换模的平方成正比的功率谱，会受到 $|W_{\\mathrm{CIC}}(\\mathbf{k})|^2$ 的调制。\n测量功率谱的模型给出如下：\n$$\nP_{\\mathrm{meas}}(\\mathbf{k}) = |W_{\\mathrm{CIC}}(\\mathbf{k})|^2 P_{\\mathrm{true}}(k) + \\eta(\\mathbf{k})\n$$\n其中 $\\eta(\\mathbf{k})$ 是一个噪声项，满足 $\\mathbb{E}[\\eta(\\mathbf{k})] = 0$ 且 $\\mathrm{Var}[\\eta(\\mathbf{k})] = \\sigma^2(\\mathbf{k})$。我们定义传递函数 $G(\\mathbf{k}) = |W_{\\mathrm{CIC}}(\\mathbf{k})|^2$。\n$$\nG(\\mathbf{k}) = \\left| \\prod_{i=x,y,z} \\mathrm{sinc}^2\\left(\\frac{k_i\\Delta}{2}\\right) \\right|^2 = \\prod_{i=x,y,z} \\mathrm{sinc}^4\\left(\\frac{k_i\\Delta}{2}\\right)\n$$\n模型变为 $P_{\\mathrm{meas}}(\\mathbf{k}) = G(\\mathbf{k}) P_{\\mathrm{true}}(k) + \\eta(\\mathbf{k})$。\n\n**朴素反卷积估计量：**\n该估计量直接对传递函数求逆：\n$$\nP_{\\mathrm{naive}}(\\mathbf{k}) = \\frac{P_{\\mathrm{meas}}(\\mathbf{k})}{G(\\mathbf{k})}\n$$\n\n**岭正则化估计量：**\n该估计量通过最小化一个 Tikhonov 正则化的最小二乘目标函数来推导。对于每个 $\\mathbf{k}$，我们寻求一个估计值 $\\hat{P}_{\\mathrm{true}}$ 来最小化：\n$$\nJ(\\hat{P}_{\\mathrm{true}}) = (P_{\\mathrm{meas}}(\\mathbf{k}) - G(\\mathbf{k})\\hat{P}_{\\mathrm{true}})^2 + \\lambda \\hat{P}_{\\mathrm{true}}^2\n$$\n对 $\\hat{P}_{\\mathrm{true}}$ 求导并令其为零以找到最小值：\n$$\n\\frac{\\partial J}{\\partial \\hat{P}_{\\mathrm{true}}} = -2G(\\mathbf{k})(P_{\\mathrm{meas}}(\\mathbf{k}) - G(\\mathbf{k})\\hat{P}_{\\mathrm{true}}) + 2\\lambda \\hat{P}_{\\mathrm{true}} = 0\n$$\n$$\n-G(\\mathbf{k})P_{\\mathrm{meas}}(\\mathbf{k}) + G(\\mathbf{k})^2\\hat{P}_{\\mathrm{true}} + \\lambda \\hat{P}_{\\mathrm{true}} = 0\n$$\n求解 $\\hat{P}_{\\mathrm{true}}$，即为我们的岭估计量 $P_{\\mathrm{ridge}}(\\mathbf{k})$：\n$$\nP_{\\mathrm{ridge}}(\\mathbf{k}) = \\frac{G(\\mathbf{k})}{G(\\mathbf{k})^2 + \\lambda} P_{\\mathrm{meas}}(\\mathbf{k})\n$$\n\n**3. 偏差、方差和均方误差**\n\n我们现在分析每种估计量的统计特性。\n\n**朴素估计量 ($P_{\\mathrm{naive}}$):**\n$$\nP_{\\mathrm{naive}} = \\frac{G P_{\\mathrm{true}} + \\eta}{G} = P_{\\mathrm{true}} + \\frac{\\eta}{G}\n$$\n- **期望和偏差：** 期望值为 $\\mathbb{E}[P_{\\mathrm{naive}}] = \\mathbb{E}[P_{\\mathrm{true}} + \\eta/G] = P_{\\mathrm{true}} + \\mathbb{E}[\\eta]/G = P_{\\mathrm{true}}$。因此偏差为零。\n  $$\n  \\mathrm{bias}_{\\mathrm{naive}}(\\mathbf{k}) = \\mathbb{E}[P_{\\mathrm{naive}}] - P_{\\mathrm{true}} = 0\n  $$\n- **方差：** 方差完全由噪声项决定。\n  $$\n  \\mathrm{var}_{\\mathrm{naive}}(\\mathbf{k}) = \\mathrm{Var}\\left[P_{\\mathrm{true}} + \\frac{\\eta}{G}\\right] = \\mathrm{Var}\\left[\\frac{\\eta}{G}\\right] = \\frac{1}{G(\\mathbf{k})^2} \\mathrm{Var}[\\eta] = \\frac{\\sigma^2(\\mathbf{k})}{G(\\mathbf{k})^2}\n  $$\n- **均方误差：** $\\mathrm{mse} = \\mathrm{bias}^2 + \\mathrm{var}$。\n  $$\n  \\mathrm{mse}_{\\mathrm{naive}}(\\mathbf{k}) = 0^2 + \\frac{\\sigma^2(\\mathbf{k})}{G(\\mathbf{k})^2} = \\frac{\\sigma^2(\\mathbf{k})}{G(\\mathbf{k})^2} = \\frac{\\sigma^2(\\mathbf{k})}{|W_{\\mathrm{CIC}}(\\mathbf{k})|^4}\n  $$\n\n**岭估计量 ($P_{\\mathrm{ridge}}$):**\n$$\nP_{\\mathrm{ridge}} = \\frac{G}{G^2 + \\lambda} (G P_{\\mathrm{true}} + \\eta)\n$$\n- **期望和偏差：**\n  $$\n  \\mathbb{E}[P_{\\mathrm{ridge}}] = \\mathbb{E}\\left[\\frac{G}{G^2 + \\lambda} (G P_{\\mathrm{true}} + \\eta)\\right] = \\frac{G^2}{G^2 + \\lambda} P_{\\mathrm{true}}\n  $$\n  该估计量是有偏的。偏差为：\n  $$\n  \\mathrm{bias}_{\\mathrm{ridge}}(\\mathbf{k}) = \\mathbb{E}[P_{\\mathrm{ridge}}] - P_{\\mathrm{true}} = \\left(\\frac{G(\\mathbf{k})^2}{G(\\mathbf{k})^2 + \\lambda} - 1\\right)P_{\\mathrm{true}}(k) = \\frac{-\\lambda}{G(\\mathbf{k})^2 + \\lambda} P_{\\mathrm{true}}(k)\n  $$\n- **方差：**\n  $$\n  \\mathrm{var}_{\\mathrm{ridge}}(\\mathbf{k}) = \\mathrm{Var}\\left[\\frac{G}{G^2 + \\lambda} (G P_{\\mathrm{true}} + \\eta)\\right] = \\mathrm{Var}\\left[\\frac{G}{G^2 + \\lambda} \\eta\\right] = \\left(\\frac{G}{G^2 + \\lambda}\\right)^2 \\mathrm{Var}[\\eta] = \\frac{G(\\mathbf{k})^2 \\sigma^2(\\mathbf{k})}{(G(\\mathbf{k})^2 + \\lambda)^2}\n  $$\n- **均方误差：**\n  $$\n  \\mathrm{mse}_{\\mathrm{ridge}}(\\mathbf{k}) = \\mathrm{bias}_{\\mathrm{ridge}}(\\mathbf{k})^2 + \\mathrm{var}_{\\mathrm{ridge}}(\\mathbf{k})\n  $$\n  $$\n  \\mathrm{mse}_{\\mathrm{ridge}}(\\mathbf{k}) = \\left(\\frac{-\\lambda P_{\\mathrm{true}}(k)}{G(\\mathbf{k})^2 + \\lambda}\\right)^2 + \\frac{G(\\mathbf{k})^2 \\sigma^2(\\mathbf{k})}{(G(\\mathbf{k})^2 + \\lambda)^2} = \\frac{\\lambda^2 P_{\\mathrm{true}}(k)^2 + G(\\mathbf{k})^2 \\sigma^2(\\mathbf{k})}{(G(\\mathbf{k})^2 + \\lambda)^2}\n  $$\n\n**4. 数值实现**\n\n针对指定的测试用例实现了推导出的公式。网格间距为 $\\Delta = 1$。真实功率谱为 $P_{\\mathrm{true}}(k) = 10 \\exp(-k^2)$，其中 $k = \\|\\mathbf{k}\\|$。噪声方差是一个常数 $\\sigma^2(\\mathbf{k}) = \\sigma_0^2$。\n\n每个测试用例需要计算的量是：\n- $G(\\mathbf{k}) = |W_{\\mathrm{CIC}}(\\mathbf{k})|^2 = \\prod_{i=x,y,z} \\mathrm{sinc}^4(k_i/2)$\n- $P_{\\mathrm{true}}(k)$\n- $\\mathrm{bias}_{\\mathrm{ridge}}(\\mathbf{k})$\n- $\\mathrm{var}_{\\mathrm{ridge}}(\\mathbf{k})$\n- $\\mathrm{mse}_{\\mathrm{ridge}}(\\mathbf{k})$\n- $\\mathrm{mse}_{\\mathrm{naive}}(\\mathbf{k})$\n\n这些表达式在提供的 Python 代码中进行了数值评估。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the CIC window function and evaluates bias, variance, and MSE\n    for naive and ridge-regularized power spectrum estimators.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    # Each case is (k_vector, lambda, sigma_squared).\n    test_cases = [\n        # Case 1: k at origin, low noise\n        (np.array([0.0, 0.0, 0.0]), 1e-6, 1e-4),\n        # Case 2: Moderate wavenumbers, low noise\n        (np.array([np.pi/4, np.pi/4, np.pi/4]), 1e-6, 1e-3),\n        # Case 3: Anisotropic, one component at Nyquist\n        (np.array([np.pi, 0.0, 0.0]), 1e-2, 1e-2),\n        # Case 4: Isotropic at Nyquist\n        (np.array([np.pi, np.pi, np.pi]), 1e-1, 1e-2),\n        # Case 5: Mixed high and low wavenumbers\n        (np.array([0.9*np.pi, 0.9*np.pi, 0.1*np.pi]), 5e-3, 5e-3),\n    ]\n\n    # Parameters for the true power spectrum.\n    A = 10.0\n    k_c = 1.0\n    delta = 1.0  # Grid spacing\n\n    results = []\n\n    def sinc(x):\n        \"\"\"\n        Numerically stable sinc function, sinc(x) = sin(x)/x.\n        \"\"\"\n        return np.where(x == 0.0, 1.0, np.sin(x) / x)\n\n    for case in test_cases:\n        k_vec, lambda_val, sigma_sq_val = case\n\n        # 1. Calculate the true power spectrum P_true(k)\n        k_mag = np.linalg.norm(k_vec)\n        p_true = A * np.exp(-(k_mag / k_c)**2)\n\n        # 2. Calculate the power spectrum transfer function G(k) = |W_CIC(k)|^2\n        # W_CIC(k) = Product_i sinc^2(k_i * delta / 2)\n        # G(k) = |W_CIC(k)|^2 = Product_i sinc^4(k_i * delta / 2)\n        sinc_args = k_vec * delta / 2.0\n        sinc_vals = sinc(sinc_args)\n        G_k = np.prod(sinc_vals**4)\n\n        # 3. Calculate bias, variance, and MSE for both estimators\n        \n        # Guard against division by zero for the naive estimator, though not\n        # expected for these test cases.\n        G_k_sq = G_k**2\n        if G_k_sq == 0.0:\n            mse_naive = np.inf\n        else:\n            mse_naive = sigma_sq_val / G_k_sq\n\n        # Ridge estimator calculations\n        denom_ridge = G_k_sq + lambda_val\n        \n        bias_ridge = (-lambda_val / denom_ridge) * p_true\n        var_ridge = (G_k_sq / (denom_ridge**2)) * sigma_sq_val\n        mse_ridge = bias_ridge**2 + var_ridge\n\n        # Store the results for this case in the specified order\n        # [|W_CIC(k)|^2, P_true(k), bias_ridge, var_ridge, mse_ridge, mse_naive]\n        case_results = [\n            G_k,\n            p_true,\n            bias_ridge,\n            var_ridge,\n            mse_ridge,\n            mse_naive\n        ]\n        results.append(case_results)\n\n    # Format the final output string as specified: [[...],[...],...]\n    # Each inner list is a string representation of the list of floats.\n    list_strs = []\n    for row in results:\n        list_strs.append(f\"[{','.join(f'{x:.8e}' for x in row)}]\")\n    final_output = f\"[{','.join(list_strs)}]\"\n\n    print(final_output)\n\nsolve()\n```", "id": "3516941"}]}