{"hands_on_practices": [{"introduction": "我们从引力本身开始。在构建复杂的模拟之前，至关重要的是理解我们选择的引力势能软化核函数（softening kernel）如何与纯粹的牛顿引力在量级上产生差异。这项实践将引导你推导并比较两种流行的核函数（Plummer软化和三次样条软化）的力误差，让你对它们在软化长度附近的具体行为有一个直观的感受。[@problem_id:3535229]", "problem": "考虑一个总质量为 $m$、引力常数为 $G$ 的质点。令 $r$ 表示物理距离，$\\epsilon$ 表示软化长度。定义无量纲距离 $u \\equiv r/\\epsilon$。两个质点之间未软化的牛顿引力大小为 $F_{N}(r) = G m / r^{2}$。我们考虑两种广泛使用的软化模型：\n\n1. Plummer 软化：其引力势通过逆距离势的正则化形式进行建模。从第一性原理出发，对该势进行适当的微分，推导出相应的力的大小 $F_{\\mathrm{P}}(r)$，并将相对于牛顿引力的相对力误差表示为 $u$ 的函数。\n\n2. 三次样条软化：通过将质点替换为一个球对称的质量密度来获得软化引力场，该质量密度等于平滑长度为 $h=\\epsilon$、紧支集为 $2\\epsilon$ 的三维三次样条核。该核定义为\n$$\nW(r,\\epsilon) = \\frac{1}{\\pi \\epsilon^{3}} \\, w(u), \\quad u \\equiv \\frac{r}{\\epsilon},\n$$\n其无量纲廓线为\n$$\nw(u) =\n\\begin{cases}\n1 - \\frac{3}{2} u^{2} + \\frac{3}{4} u^{3}, & 0 \\le u < 1, \\\\\n\\frac{1}{4} (2 - u)^{3}, & 1 \\le u < 2, \\\\\n0, & u \\ge 2.\n\\end{cases}\n$$\n从牛顿引力定律和球对称质量分布的球壳定理出发，推导出包围的质量分数 $M(u)$，进而推导出软化力的大小 $F_{\\mathrm{S}}(r)$，并将相对于牛顿引力的相对力误差表示为 $u$ 的函数。\n\n您必须计算并比较最大相对力误差\n$$\n\\max_{u \\in [0.5, 2]} \\left\\{ \\frac{\\left| F_{\\epsilon}(r) - F_{N}(r) \\right|}{F_{N}(r)} \\right\\}\n$$\n对于 Plummer 软化与三次样条软化，其中 $F_{\\epsilon}$ 表示给定模型的软化力。由于该量根据其构造是无量纲的，因此不需要物理单位。\n\n您的程序必须为以下测试套件生成数值结果，该测试套件探讨了在区间 $u \\in [0.5, 2]$ 上的采样分辨率效应：\n- 测试用例 1：具有 $N=1001$ 个采样点的均匀网格。\n- 测试用例 2：具有 $N=10001$ 个采样点的均匀网格。\n- 测试用例 3：具有 $N=501$ 个采样点的均匀网格。\n\n对于每个测试用例，计算两个浮点数：Plummer 软化和三次样条软化的最大相对力误差。您的程序应生成单行输出，其中包含六个结果，按以下顺序以方括号括起来的逗号分隔列表形式呈现\n$$\n[\\text{Plummer}_{1001}, \\text{Spline}_{1001}, \\text{Plummer}_{10001}, \\text{Spline}_{10001}, \\text{Plummer}_{501}, \\text{Spline}_{501}],\n$$\n其中每个条目都是一个浮点数。此问题不涉及角度，因此不需要角度单位。", "solution": "用户提供的问题陈述经过严格评估，被认为是有效的。它在科学上是合理的、适定的和客观的，基于计算天体物理学的既定原则。该问题要求在指定区间内，推导并比较两种引力软化模型（Plummer 和三次样条）的最大相对力误差。\n\n解决方案分三个阶段进行：\n1.  Plummer 软化模型相对力误差的推导及其行为分析。\n2.  三次样条软化模型相对力误差的推导及其行为分析。\n3.  计算两种模型的最大误差并实现数值解。\n\n所有数学实体均按照指定的格式规则使用 LaTeX排版。\n\n**1. Plummer 软化分析**\n\nPlummer 势是牛顿势的一种标准正则化形式，由下式给出：\n$$\n\\Phi_{\\mathrm{P}}(r) = - \\frac{G m}{\\sqrt{r^2 + \\epsilon^2}}\n$$\n引力是中心力，其大小是势的负径向导数：\n$$\nF_{\\mathrm{P}}(r) = - \\frac{d\\Phi_{\\mathrm{P}}}{dr} = - \\frac{d}{dr} \\left( - \\frac{G m}{(r^2 + \\epsilon^2)^{1/2}} \\right) = G m \\left( - \\frac{1}{2} (r^2 + \\epsilon^2)^{-3/2} \\cdot 2r \\right)\n$$\n因此，力的大小为：\n$$\nF_{\\mathrm{P}}(r) = \\frac{G m r}{(r^2 + \\epsilon^2)^{3/2}}\n$$\n未软化的牛顿力为 $F_{N}(r) = G m / r^2$。相对力误差 $E_{\\mathrm{P}}$ 定义为：\n$$\nE_{\\mathrm{P}}(r) = \\frac{\\left| F_{\\mathrm{P}}(r) - F_{N}(r) \\right|}{F_{N}(r)} = \\left| \\frac{F_{\\mathrm{P}}(r)}{F_{N}(r)} - 1 \\right|\n$$\n力的比值为：\n$$\n\\frac{F_{\\mathrm{P}}(r)}{F_{N}(r)} = \\frac{G m r}{(r^2 + \\epsilon^2)^{3/2}} \\cdot \\frac{r^2}{G m} = \\frac{r^3}{(r^2 + \\epsilon^2)^{3/2}}\n$$\n使用无量纲距离 $u = r/\\epsilon$，该比值变为：\n$$\n\\frac{F_{\\mathrm{P}}(u)}{F_{N}(u)} = \\frac{(u\\epsilon)^3}{((u\\epsilon)^2 + \\epsilon^2)^{3/2}} = \\frac{u^3 \\epsilon^3}{(\\epsilon^2(u^2 + 1))^{3/2}} = \\frac{u^3}{(u^2 + 1)^{3/2}}\n$$\n对于任何 $u > 0$，我们有 $u^2 < u^2 + 1$，这意味着 $u^3 < (u^2 + 1)^{3/2}$。因此，该比值始终小于 1，软化力弱于牛顿力。相对误差简化为：\n$$\nE_{\\mathrm{P}}(u) = 1 - \\frac{u^3}{(u^2 + 1)^{3/2}}\n$$\n为了找到区间 $u \\in [0.5, 2]$ 上的最大误差，我们分析 $E_{\\mathrm{P}}(u)$ 关于 $u$ 的导数：\n$$\n\\frac{d E_{\\mathrm{P}}}{d u} = - \\frac{d}{du} \\left( \\frac{u^3}{(u^2 + 1)^{3/2}} \\right) = - \\frac{3u^2(u^2+1)^{3/2} - u^3 \\cdot \\frac{3}{2}(u^2+1)^{1/2}(2u)}{(u^2+1)^3}\n$$\n$$\n\\frac{d E_{\\mathrm{P}}}{d u} = - \\frac{3u^2(u^2+1) - 3u^4}{(u^2+1)^{5/2}} = - \\frac{3u^4 + 3u^2 - 3u^4}{(u^2+1)^{5/2}} = - \\frac{3u^2}{(u^2+1)^{5/2}}\n$$\n由于 $u > 0$，导数 $\\frac{d E_{\\mathrm{P}}}{d u}$ 始终为负。这证明了对于 $u > 0$，$E_{\\mathrm{P}}(u)$ 是一个单调递减函数。因此，其在区间 $[0.5, 2]$ 上的最大值必定出现在左端点 $u = 0.5$处。\n\n**2. 三次样条软化分析**\n\n对于球对称质量分布，球壳定理指出，在半径 $r$ 处的引力由该半径内包围的总质量 $M(r)$ 决定：\n$$\nF_{\\mathrm{S}}(r) = \\frac{G M(r)}{r^2}\n$$\n包围的质量 $M(r)$ 通过对半径为 $r$ 的球体内的质量密度 $\\rho(r') = m W(r', \\epsilon)$ 进行积分得到：\n$$\nM(r) = \\int_0^r 4\\pi r'^2 \\rho(r') dr' = \\int_0^r 4\\pi r'^2 m W(r', \\epsilon) dr'\n$$\n问题要求计算包围的质量分数 $M_{\\text{frac}}(u) = M(r)/m$。将积分转换为无量纲变量 $u' = r'/\\epsilon$（其中 $dr' = \\epsilon du'$）：\n$$\nM_{\\text{frac}}(u) = \\int_0^u 4\\pi (u'\\epsilon)^2 W(u'\\epsilon, \\epsilon) \\epsilon du' = \\int_0^u 4\\pi u'^2 \\epsilon^3 \\left( \\frac{1}{\\pi \\epsilon^3} w(u') \\right) du' = 4 \\int_0^u u'^2 w(u') du'\n$$\n必须根据 $w(u)$ 的定义分段进行积分。\n对于 $0 \\le u < 1$：\n$$\nM_{\\text{frac}}(u) = 4 \\int_0^u u'^2 \\left(1 - \\frac{3}{2} u'^2 + \\frac{3}{4} u'^3\\right) du' = 4 \\left[ \\frac{u'^3}{3} - \\frac{3}{10} u'^5 + \\frac{1}{8} u'^6 \\right]_0^u\n$$\n$$\nM_{\\text{frac}}(u) = \\frac{4}{3} u^3 - \\frac{6}{5} u^5 + \\frac{1}{2} u^6\n$$\n对于 $1 \\le u < 2$：\n积分为 $M_{\\text{frac}}(1) + 4 \\int_1^u u'^2 w(u') du'$。首先，$M_{\\text{frac}}(1) = \\frac{4}{3} - \\frac{6}{5} + \\frac{1}{2} = \\frac{40 - 36 + 15}{30} = \\frac{19}{30}$。\n积分为：\n$$\n4 \\int_1^u u'^2 \\left(\\frac{1}{4}(2-u')^3\\right) du' = \\int_1^u u'^2(8 - 12u' + 6u'^2 - u'^3) du'\n$$\n$$\n= \\left[ \\frac{8}{3}u'^3 - 3u'^4 + \\frac{6}{5}u'^5 - \\frac{1}{6}u'^6 \\right]_1^u = \\left(\\frac{8}{3}u^3 - 3u^4 + \\frac{6}{5}u^5 - \\frac{1}{6}u^6\\right) - \\left(\\frac{8}{3} - 3 + \\frac{6}{5} - \\frac{1}{6}\\right)\n$$\n常数项为 $\\frac{80 - 90 + 36 - 5}{30} = \\frac{21}{30}$。因此，对于 $1 \\le u < 2$：\n$$\nM_{\\text{frac}}(u) = \\frac{19}{30} + \\left(\\frac{8}{3}u^3 - 3u^4 + \\frac{6}{5}u^5 - \\frac{1}{6}u^6\\right) - \\frac{21}{30} = \\frac{8}{3}u^3 - 3u^4 + \\frac{6}{5}u^5 - \\frac{1}{6}u^6 - \\frac{1}{15}\n$$\n对于 $u \\ge 2$，所有质量都被包围，因此 $M_{\\text{frac}}(u)=1$。相对力误差为：\n$$\nE_{\\mathrm{S}}(r) = \\left| \\frac{F_{\\mathrm{S}}(r)}{F_{N}(r)} - 1 \\right| = \\left| \\frac{G M(r)/r^2}{G m/r^2} - 1 \\right| = \\left| \\frac{M(r)}{m} - 1 \\right| = |M_{\\text{frac}}(u) - 1|\n$$\n由于当 $r < 2\\epsilon$ 时，$M(r) \\le m$，因此包围的质量分数小于或等于 1。误差为：\n$$\nE_{\\mathrm{S}}(u) = 1 - M_{\\text{frac}}(u)\n$$\n为了找到最大误差，我们分析其导数：\n$$\n\\frac{d E_{\\mathrm{S}}}{d u} = - \\frac{d M_{\\text{frac}}}{d u} = - 4 u^2 w(u)\n$$\n核函数廓线 $w(u)$ 在其支集 $[0, 2]$ 上是非负的。因此，$\\frac{d E_{\\mathrm{S}}}{d u} \\le 0$，意味着 $E_{\\mathrm{S}}(u)$ 也是一个单调递减函数。其在区间 $[0.5, 2]$ 上的最大值必定出现在左端点 $u = 0.5$ 处。\n\n**3. 数值计算**\n\n分析研究表明，对于两种软化模型，在区间 $u \\in [0.5, 2]$ 上的最大相对误差都出现在 $u=0.5$ 处。这一洞见意味着最大误差与测试用例中指定的采样分辨率 $N$ 无关，因为任何从 $u=0.5$ 开始的均匀网格都将在第一个点取到其最大值。问题简化为计算在 $u=0.5$ 处的误差值。\n\n对于 Plummer 软化：\n$$\n\\max E_{\\mathrm{P}} = E_{\\mathrm{P}}(0.5) = 1 - \\frac{(0.5)^3}{(0.5^2 + 1)^{3/2}} = 1 - \\frac{0.125}{(1.25)^{1.5}} \\approx 0.9105572809\n$$\n对于三次样条软化，$u=0.5$ 属于第一种情况（$0 \\le u < 1$）：\n$$\n\\max E_{\\mathrm{S}} = E_{\\mathrm{S}}(0.5) = 1 - M_{\\text{frac}}(0.5) = 1 - \\left( \\frac{4}{3} (0.5)^3 - \\frac{6}{5} (0.5)^5 + \\frac{1}{2} (0.5)^6 \\right)\n$$\n$$\n\\max E_{\\mathrm{S}} = 1 - \\left( \\frac{4}{3} \\cdot \\frac{1}{8} - \\frac{6}{5} \\cdot \\frac{1}{32} + \\frac{1}{2} \\cdot \\frac{1}{64} \\right) = 1 - \\left( \\frac{1}{6} - \\frac{3}{80} + \\frac{1}{128} \\right) = 1 - \\frac{263}{1920} \\approx 0.8630208333\n$$\n程序将计算这两个值，并按要求为每个测试用例报告它们。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the maximum relative force error for Plummer and cubic-spline softening\n    for different sampling resolutions.\n    \"\"\"\n    # The problem defines three test cases with different sampling resolutions (N).\n    # Test cases: N=1001, N=10001, N=501\n    test_cases = [1001, 10001, 501]\n\n    # As derived in the solution, the relative error functions for both Plummer and\n    # cubic-spline softening are monotonically decreasing on the interval u in [0.5, 2].\n    # Therefore, the maximum error for both models occurs at the minimum value of u,\n    # which is u = 0.5. This result is independent of the sampling resolution N.\n\n    # We calculate these maximum values once.\n    u_max = 0.5\n\n    # --- Plummer Softening Calculation ---\n    # The relative error is E_P(u) = 1 - u^3 / (u^2 + 1)^(3/2).\n    max_err_plummer = 1.0 - u_max**3 / (u_max**2 + 1.0)**1.5\n\n    # --- Cubic-Spline Softening Calculation ---\n    # For u in [0, 1), the relative error is E_S(u) = 1 - (4/3*u^3 - 6/5*u^5 + 1/2*u^6).\n    # Since u_max = 0.5 is in this range, we use this formula.\n    max_err_spline = 1.0 - (\n        (4.0/3.0) * u_max**3 -\n        (6.0/5.0) * u_max**5 +\n        (1.0/2.0) * u_max**6\n    )\n\n    # The problem asks for numerical results for each test case. Since the maximum\n    # is analytically determined to be at u=0.5, the result is the same for all N.\n    # The order of results must be:\n    # [Plummer_1001, Spline_1001, Plummer_10001, Spline_10001, Plummer_501, Spline_501]\n    \n    results = []\n    for _ in test_cases:\n        results.append(max_err_plummer)\n        results.append(max_err_spline)\n\n    # The loop over `test_cases = [1001, 10001, 501]` naturally produces\n    # the results in the specified order.\n\n    # Format the final output as a comma-separated list in brackets.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```", "id": "3535229"}, {"introduction": "在分析了静态力之后，我们现在将软化引力置于运动之中。这项练习将挑战你构建一个完整的N体模拟，模拟一个坍缩的恒星系统，并验证你的程序是否能正确地保持能量守恒，并使系统达到一个真实的动力学平衡。这是对任何引力模拟代码的基本检验。[@problem_id:3535189]", "problem": "您需要实现一个完整的、可运行的程序，为以下系统构建一个可复现的单元测试：一个自引力系统，其初始构型为冷普卢默球（cold Plummer sphere），且其引力相互作用是软化的。测试的目的是在多个动力学时标内，基于牛顿动力学的第一性原理，验证总能量守恒和维里比（virial ratio）的行为，而不依赖于此处明确给出的任何快捷公式。程序必须完全自洽并使用无量纲单位。\n\n其基本原理如下。牛顿引力指出，一个质量为 $m$、位于位置 $\\mathbf{x}$ 的粒子，由于其他质量的存在而经历的加速度 $\\mathbf{a}$ 遵循 $\\mathbf{a} = - \\nabla \\Phi$，其中 $\\Phi$ 是引力势。一个粒子系统的总能量 $E$ 是动能 $T$ 和势能 $W$ 的和，其中 $T = \\sum_{i} \\tfrac{1}{2} m_i \\lVert \\mathbf{v}_i \\rVert^2$，而 $W$ 由与所选势能相符的成对相互作用定义。对于处于平衡状态的系统，维里定理指出 $2 T + W = 0$，维里比为 $Q = T / \\lvert W \\rvert$。为了在计算天体物理学中对近距离遭遇进行正则化，引力通常被软化；您必须实现一种软化的自引力，确保计算出的力和计算出的势能之间保持一致。\n\n您必须：\n\n- 构建一个具有标度半径 $a$ 和总质量 $M$ 的普卢默球的 $N$ 体实现，在三维空间中进行采样，使得生成的粒子位置遵循普卢默分布，且质心位于原点。所有粒子必须具有相等的质量。该系统是冷的，意味着所有初始粒子速度都设置为零。\n- 使用无量纲单位，其中 $G = 1$、$M = 1$ 和 $a = 1$。特征动力学时标定义为 $t_{\\mathrm{dyn}} = \\sqrt{a^3 / (G M)}$，在这些单位下 $t_{\\mathrm{dyn}} = 1$。本问题中所有时间均以 $t_{\\mathrm{dyn}}$ 为单位表示，无需进行物理单位转换。\n- 实现一个时间可逆的辛积分器，以在指定的动力学时标数内演化系统。时间步长必须是恒定的。您必须根据软化的引力相互作用计算粒子加速度，确保用于加速度的表达式是用于计算势能 $W$ 的同一软化势能函数的负梯度。\n- 在每一步（包括初始状态），计算总能量 $E = T + W$ 和瞬时维里比 $Q = T / \\lvert W \\rvert$。追踪在整个积分区间内 $E$ 相对于其初始值的最大分数偏差，定义为 $\\max_t \\left( \\lvert E(t) - E(0) \\rvert / \\lvert E(0) \\rvert \\right)$。对于维里比，计算 $Q(t)$ 在区间 $t \\in [t_{\\mathrm{transient}}, t_{\\mathrm{end}}]$ 上的时间平均值，其中 $t_{\\mathrm{transient}} = 3 \\, t_{\\mathrm{dyn}}$。\n- 对每个测试用例，返回两个布尔值：\n  1. 一个能量守恒布尔值，如果 $E$ 的最大分数偏差小于或等于指定的容差，则为真。\n  2. 一个维里比布尔值，如果 $Q$ 在 $[t_{\\mathrm{transient}}, t_{\\mathrm{end}}]$ 上的时间平均值位于 $0.5$ 左右的指定容差区间内，则为真；即 $Q_{\\mathrm{avg}} \\in [0.5 - \\delta_Q, 0.5 + \\delta_Q]$。\n\n您必须设计并运行以下测试套件，涵盖问题的不同方面，包括通用情况、小粒子数、大软化长度和更强的自引力：\n\n- 测试用例1（通用情况，理想路径）：$N = 64$，$\\epsilon = 0.05$，$\\Delta t = 0.005$，$t_{\\mathrm{end}} = 10$，能量容差 $\\delta_E = 0.005$，维里比容差 $\\delta_Q = 0.12$，随机种子 $s = 42$。\n- 测试用例2（粒子数边界情况）：$N = 16$，$\\epsilon = 0.05$，$\\Delta t = 0.005$，$t_{\\mathrm{end}} = 8$，能量容差 $\\delta_E = 0.02$，维里比容差 $\\delta_Q = 0.22$，随机种子 $s = 12345$。\n- 测试用例3（大软化长度）：$N = 64$，$\\epsilon = 0.30$，$\\Delta t = 0.01$，$t_{\\mathrm{end}} = 10$，能量容差 $\\delta_E = 0.007$，维里比容差 $\\delta_Q = 0.10$，随机种子 $s = 31415$。\n- 测试用例4（更强的相互作用）：$N = 64$，$\\epsilon = 0.008$，$\\Delta t = 0.003$，$t_{\\mathrm{end}} = 8$，能量容差 $\\delta_E = 0.01$，维里比容差 $\\delta_Q = 0.15$，随机种子 $s = 271828$。\n\n在所有情况下，引力常数 $G = 1$，普卢默标度半径 $a = 1$，总质量 $M = 1$。确保在力和势能计算中一致地使用软化相互作用。\n\n您的程序应生成一行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，其中每个条目对应一个测试用例，并且本身是一个按顺序包含两个布尔值 $[b_E, b_Q]$ 的列表，$b_E$ 是能量守恒布尔值，$b_Q$ 是维里比布尔值。例如，对于两个用例，一个有效的输出格式是 $[[\\mathrm{True},\\mathrm{False}],[\\mathrm{True},\\mathrm{True}]]$。不应打印任何其他文本。", "solution": "该问题陈述经评估有效。它在计算天体物理学领域提出了一个适定且有科学依据的任务。它要求实现一个标准的 N 体模拟，包括为普卢默球生成初始条件、使用辛格式进行数值积分，以及一致地应用软化引力势。模拟和验证所需的所有参数均已提供。该问题是该领域的标准练习，没有科学缺陷、歧义或矛盾。解决方案需要为特定算法做出标准的、有据可查的选择，这是该领域专家完成此项任务时的预期部分。\n\n以下解决方案概述了所需程序的理论基础和算法设计。\n我们将使用无量纲单位，其中引力常数 $G=1$，系统总质量 $M=1$，普卢默标度半径 $a=1$。因此，时间单位，即动力学时标 $t_{\\mathrm{dyn}} = \\sqrt{a^3/(GM)}$，也为 $1$。\n\n### 初始条件：冷普卢默球\n\n模拟始于代表普卢默球的 $N$ 个粒子的集合，这是一个用于恒星系统的球对称模型。其密度分布 $\\rho(r)$ 由下式给出：\n$$\n\\rho(r) = \\frac{3M}{4\\pi a^3} \\left(1 + \\frac{r^2}{a^2}\\right)^{-5/2}\n$$\n为了生成遵循此分布的粒子位置，我们使用 Aarseth、Henon 和 Wielen (1974) 描述的逆变换采样法。这涉及将累积质量函数 $M(r)$ 与一个均匀分布的随机变量相关联。半径 $r$ 内的累积质量为：\n$$\nM(r) = \\int_0^r \\rho(r') 4\\pi r'^2 dr' = M \\frac{r^3}{(a^2 + r^2)^{3/2}}\n$$\n我们通过设置 $M(r)/M = u$ 来采样粒子的半径 $r$，其中 $u$ 是从 $[0,1)$ 上的均匀分布中抽取的随机数。求解 $r$ 得到采样公式：\n$$\nr(u) = a \\left( u^{-2/3} - 1 \\right)^{-1/2}\n$$\n一旦为 $N$ 个粒子中的每一个生成了半径 $r$，就通过在半径为 $r$ 的球面上选择一个随机的、各向同性的方向来分配位置向量 $\\mathbf{x}$。这可以通过从标准正态分布生成一个三维向量，将其归一化为单位长度，然后按 $r$ 缩放来稳健地实现。\n\n所有粒子被赋予相等的质量，$m_i = M/N = 1/N$。该系统是“冷的”，意味着所有初始速度都为零：$\\mathbf{v}_i(0) = \\mathbf{0}$。最后，为确保质心 (COM) 位于原点，计算生成粒子位置的质心 $\\mathbf{x}_{\\mathrm{COM}} = \\frac{1}{N} \\sum_{i=1}^N \\mathbf{x}_i$，然后从每个粒子的位置向量中减去该向量，即 $\\mathbf{x}_i \\rightarrow \\mathbf{x}_i - \\mathbf{x}_{\\mathrm{COM}}$。\n\n### 带软化引力的运动方程\n\n为了避免数值无穷大和减轻近距离遭遇中强二体散射的影响，牛顿势被“软化”。我们采用与初始密度分布一致的普卢默式软化。两个粒子 $i$ 和 $j$ 之间的软化势能为：\n$$\nW_{ij} = -\\frac{G m_i m_j}{\\sqrt{\\lVert \\mathbf{x}_i - \\mathbf{x}_j \\rVert^2 + \\epsilon^2}}\n$$\n其中 $\\epsilon$ 是软化长度。系统的总势能是所有唯一对的总和：\n$$\nW = \\sum_{i<j} W_{ij}\n$$\n粒子 $i$ 的加速度 $\\mathbf{a}_i$ 是由所有其他粒子 $j \\ne i$ 的力（势的负梯度）的总和除以其质量 $m_i$ 得出的：\n$$\n\\mathbf{a}_i = \\frac{1}{m_i} \\sum_{j \\ne i} \\left( -\\nabla_{\\mathbf{x}_i} W_{ij} \\right) = \\sum_{j \\ne i} -G m_j \\frac{\\mathbf{x}_i - \\mathbf{x}_j}{(\\lVert \\mathbf{x}_i - \\mathbf{x}_j \\rVert^2 + \\epsilon^2)^{3/2}}\n$$\n势能和力的这种一致定义对于能量守恒至关重要。\n\n### 数值积分器：KDK Leapfrog\n\n为了随时间演化系统，我们使用“踢-漂移-踢”（Kick-Drift-Kick, KDK）形式的二阶 Leapfrog 辛积分器。该算法时间可逆，并对哈密顿系统表现出良好的长期能量守恒特性。对于一个恒定的时间步长 $\\Delta t$，从时间 $t_n$ 到 $t_{n+1}$ 的一次更新包括：\n1.  **Kick（半步）**：使用在 $t_n$ 时的加速度 $\\mathbf{a}_n$ 将速度从 $\\mathbf{v}_n$ 更新到 $\\mathbf{v}_{n+1/2}$：\n    $$\n    \\mathbf{v}_{n+1/2} = \\mathbf{v}_n + \\mathbf{a}_n \\frac{\\Delta t}{2}\n    $$\n2.  **Drift（全步）**：使用中间速度将位置从 $\\mathbf{x}_n$ 更新到 $\\mathbf{x}_{n+1}$：\n    $$\n    \\mathbf{x}_{n+1} = \\mathbf{x}_n + \\mathbf{v}_{n+1/2} \\Delta t\n    $$\n3.  **Kick（半步）**：使用在 *新* 位置 $\\mathbf{x}_{n+1}$ 计算出的加速度 $\\mathbf{a}_{n+1}$ 将速度更新到 $\\mathbf{v}_{n+1}$：\n    $$\n    \\mathbf{v}_{n+1} = \\mathbf{v}_{n+1/2} + \\mathbf{a}_{n+1} \\frac{\\Delta t}{2}\n    $$\n这个循环在整个模拟时间内重复进行。\n\n### 诊断和验证\n\n在每一步之后，我们计算以下量：\n- **动能**：$T = \\sum_i \\frac{1}{2} m_i \\lVert \\mathbf{v}_i \\rVert^2$\n- **势能**：$W = \\sum_{i<j} -\\frac{G m_i m_j}{\\sqrt{\\lVert \\mathbf{x}_i - \\mathbf{x}_j \\rVert^2 + \\epsilon^2}}$\n- **总能量**：$E = T + W$\n- **维里比**：$Q = T / |W|$\n\n初始总能量 $E(0)$（其中 $T(0)=0$）被用作参考。最大分数能量偏差是在整个模拟过程中计算的 $\\max_t(|E(t) - E(0)| / |E(0)|)$。\n\n维里比的平均值是在系统达到准平衡后计算的。初始的冷坍缩是一个剧烈的瞬态过程。问题指定了一个瞬态时间 $t_{\\mathrm{transient}} = 3 \\, t_{\\mathrm{dyn}}$。平均维里比 $\\langle Q \\rangle$ 是通过对 $t \\in [t_{\\mathrm{transient}}, t_{\\mathrm{end}}]$ 范围内的所有时间步的 $Q(t)$ 值求平均来计算的。\n\n该算法直接映射到程序实现中。 NumPy 将被广泛用于高效的向量化计算，特别是对于成对的力和能量。", "answer": "```python\nimport numpy as np\n\ndef generate_plummer_sphere(N, a, seed):\n    \"\"\"\n    Generates N-body realization of a Plummer sphere.\n    \"\"\"\n    rng = np.random.default_rng(seed)\n    \n    # Generate radii using inverse transform sampling\n    u_r = rng.uniform(0, 1, size=N)\n    radii = a / np.sqrt(u_r**(-2.0/3.0) - 1.0)\n    \n    # Generate isotropic directions\n    vecs = rng.normal(size=(N, 3))\n    norms = np.linalg.norm(vecs, axis=1)\n    valid_indices = norms > 1e-15\n    vecs[valid_indices] /= norms[valid_indices, np.newaxis]\n    \n    # Create positions\n    pos = radii[:, np.newaxis] * vecs\n    \n    # Center the COM\n    com = np.mean(pos, axis=0)\n    pos -= com\n    \n    return pos\n\ndef get_acceleration(pos, mass, G, epsilon):\n    \"\"\"\n    Calculates acceleration on each particle using direct summation.\n    pos: (N, 3) array of positions\n    mass: scalar mass of each particle\n    \"\"\"\n    N = pos.shape[0]\n    acc = np.zeros_like(pos)\n    \n    # Use broadcasting to get all pairwise differences\n    diff = pos[:, np.newaxis, :] - pos[np.newaxis, :, :]\n    \n    # Calculate squared distances\n    dist_sq = np.sum(diff**2, axis=-1)\n    \n    # Softened inverse cube law, setting diagonal to 0 to avoid self-force\n    inv_r3 = (dist_sq + epsilon**2)**(-1.5)\n    np.fill_diagonal(inv_r3, 0.0)\n    \n    # Sum forces. Note mass is scalar (m_j = m for all j)\n    # The sum is over the j index, for each particle i.\n    acc = -G * mass * np.sum(diff * inv_r3[..., np.newaxis], axis=1)\n    \n    return acc\n\ndef get_potential_energy(pos, mass, G, epsilon):\n    \"\"\"\n    Calculates total potential energy of the system.\n    \"\"\"\n    N = pos.shape[0]\n    \n    # Get pairwise separation vectors and squared distances\n    diff = pos[:, np.newaxis, :] - pos[np.newaxis, :, :]\n    dist_sq = np.sum(diff**2, axis=-1)\n    \n    # Calculate softened pairwise potentials\n    # Add a large value to the diagonal to avoid division by zero, though we only sum upper triangle\n    np.fill_diagonal(dist_sq, np.inf)\n    rij = np.sqrt(dist_sq + epsilon**2)\n    \n    potential_pairs = -G * mass * mass / rij\n    \n    # Sum over unique pairs (upper triangle of the matrix)\n    total_potential = np.sum(np.triu(potential_pairs))\n    \n    return total_potential\n\ndef get_kinetic_energy(vel, mass):\n    \"\"\"\n    Calculates total kinetic energy of the system.\n    \"\"\"\n    return 0.5 * mass * np.sum(vel**2)\n\ndef run_simulation(N, M, a, G, epsilon, dt, t_end, t_transient, seed):\n    \"\"\"\n    Runs a single N-body simulation test case.\n    \"\"\"\n    m = M / N\n    pos = generate_plummer_sphere(N, a, seed)\n    vel = np.zeros_like(pos)\n    \n    # Initial state diagnostics\n    W0 = get_potential_energy(pos, m, G, epsilon)\n    E0 = W0  # T0 is 0\n    \n    if abs(E0)  1e-15:\n        # Avoid division by zero if initial potential is unexpectedly zero\n        return -1.0, -1.0 \n\n    max_frac_E_dev = 0.0\n    Q_values_for_avg = []\n    \n    num_steps = int(round(t_end / dt))\n    \n    # Main KDK leapfrog integration loop\n    for n in range(num_steps):\n        # Kick (half step)\n        accel_n = get_acceleration(pos, m, G, epsilon)\n        vel_half_step = vel + accel_n * dt / 2.0\n        \n        # Drift (full step)\n        pos += vel_half_step * dt\n        \n        # Kick (half step)\n        accel_n_plus_1 = get_acceleration(pos, m, G, epsilon)\n        vel = vel_half_step + accel_n_plus_1 * dt / 2.0\n        \n        # Diagnostics at step n+1\n        T = get_kinetic_energy(vel, m)\n        W = get_potential_energy(pos, m, G, epsilon)\n        E = T + W\n        \n        frac_E_dev = abs((E - E0) / E0)\n        if frac_E_dev > max_frac_E_dev:\n            max_frac_E_dev = frac_E_dev\n            \n        current_t = (n + 1) * dt\n        if current_t >= t_transient:\n            if abs(W) > 1e-15:\n                Q = T / abs(W)\n                Q_values_for_avg.append(Q)\n\n    avg_Q = np.mean(Q_values_for_avg) if Q_values_for_avg else 0.0\n    \n    return max_frac_E_dev, avg_Q\n\ndef solve():\n    \"\"\"\n    Main function to run test suite and print results.\n    \"\"\"\n    # Dimensionless units\n    G = 1.0\n    M = 1.0\n    a = 1.0\n    t_transient = 3.0\n\n    test_cases = [\n        # (N, epsilon, dt, t_end, delta_E, delta_Q, seed)\n        (64, 0.05, 0.005, 10.0, 0.005, 0.12, 42),\n        (16, 0.05, 0.005, 8.0, 0.02, 0.22, 12345),\n        (64, 0.30, 0.01, 10.0, 0.007, 0.10, 31415),\n        (64, 0.008, 0.003, 8.0, 0.01, 0.15, 271828),\n    ]\n\n    results = []\n    for case in test_cases:\n        N, epsilon, dt, t_end, delta_E, delta_Q, seed = case\n        \n        max_frac_E_dev, avg_Q = run_simulation(\n            N, M, a, G, epsilon, dt, t_end, t_transient, seed\n        )\n        \n        b_E = max_frac_E_dev = delta_E\n        b_Q = abs(avg_Q - 0.5) = delta_Q\n        \n        results.append([b_E, b_Q])\n\n    # Format the final output string precisely as required\n    print(str(results).replace(\" \", \"\"))\n\nsolve()\n```", "id": "3535189"}, {"introduction": "最后，我们来解决一个研究中的关键问题：如何为软化长度 $\\epsilon$ 选择正确的值。这项高级实践将指导你设计一个校准流程，通过将关键的宇宙学统计量——物质功率谱和暗物质晕质量函数——与高分辨率基准进行比较，来选择一个最优的 $\\epsilon$。这项练习将弥合实现数值方法与利用它产生科学上可靠结果之间的鸿沟。[@problem_id:3535195]", "problem": "你的任务是在计算天体物理学领域实现一个校准流程，该流程扫描引力势软化长度，并自动选择一个软化长度，使其能够将给定的小型引导性宇宙学模拟的物质功率谱和晕质量函数，在指定容差范围内，与高分辨率基准目标相匹配。该校准必须从牛顿引力的第一性原理和标准宇宙学结构形成理论推导得出。最终产品必须是一个完整、可运行的程序。\n\n假设一个由牛顿引力支配的非相对论、无碰撞、自引力系统，并且引导性模拟使用一个软化的引力势来控制短程数值赝象。物理目标是找到一个软化长度 $\\,\\epsilon\\,$，它能在保持小尺度力稳定的同时，相对于高分辨率基准，不会显著扭曲成团统计量。\n\n从以下基本基础开始：\n\n- 牛顿引力和泊松方程：由质量密度 $\\,\\rho(\\mathbf{r})\\,$ 引起的引力势 $\\,\\phi(\\mathbf{r})\\,$ 满足 $\\,\\nabla^2 \\phi(\\mathbf{r}) = 4\\pi G \\rho(\\mathbf{r})\\,$，在傅里叶空间中，$\\,\\phi(\\mathbf{k})\\,$ 与 $\\,\\rho(\\mathbf{k})/k^2\\,$ 成正比，其中 $\\,k = \\lVert \\mathbf{k} \\rVert\\,$。\n- 软化势应通过Plummer型替换牛顿格林函数来建模，其中 $\\,1/r\\,$ 的奇点由一个非零的软化长度 $\\,\\epsilon\\,$ 来调节。你必须推导出相应的傅里叶空间核函数修正，并解释这将如何改变系统在波数 $\\,k\\,$ 处的线性响应。\n- 在无碰撞物质的线性理论中，密度扰动 $\\,\\delta(\\mathbf{k})\\,$ 的增长可以通过泊松方程和运动方程与引力势联系起来。由此，推导出一个抑制因子 $\\,S(k,\\epsilon)\\,$，该因子编码了软化引力核相对于未平滑情况如何减小在波数 $\\,k\\,$ 处的引力耦合强度。\n- 对于物质功率谱 $\\,P(k)\\,$，假设软化核导致了尺度依赖的增长修正，使得 $\\,P(k)\\,$ 被一个关于 $\\,S(k,\\epsilon)\\,$ 的函数所抑制；你必须从第一性原理证明 $\\,S(k,\\epsilon)\\,$ 的某个幂次如何进入 $\\,P(k)\\,$ 的修正，而不是通过快捷公式。\n- 对于晕质量函数 $\\,n(M)\\,$，假设抑制可以通过密度场方差对尺度的依赖性来处理。使用晕质量 $\\,M\\,$ 与特征实空间平滑半径 $\\,R(M)\\,$ 及波数 $\\,k(M)\\,$ 通过标准Press–Schechter逻辑相关联的思想，而不使用详细的拟合函数。推导软化引力核如何转化为一个抑制因子 $\\,S_M(M,\\epsilon)\\,$，以及它如何影响 $\\,n(M)\\,$。\n\n你必须实现一个流程，对于在一个指定区间内的均匀网格上的一组候选软化长度 $\\,\\epsilon\\,$，计算两个定量指标：\n\n1. 软化预测与基准之间的物质功率谱的均方根分数偏差，\n$$\n\\Delta_P(\\epsilon) \\equiv \\sqrt{\\frac{1}{N_k} \\sum_{i=1}^{N_k} \\left(\\frac{P_{\\mathrm{pred}}(k_i;\\epsilon)-P_{\\mathrm{bench}}(k_i)}{P_{\\mathrm{bench}}(k_i)}\\right)^2 },\n$$\n其中 $\\,\\{k_i\\}\\,$ 是给定的离散波数。\n\n2. 软化预测与基准之间的晕质量函数的均方根分数偏差，\n$$\n\\Delta_H(\\epsilon) \\equiv \\sqrt{\\frac{1}{N_M} \\sum_{j=1}^{N_M} \\left(\\frac{n_{\\mathrm{pred}}(M_j;\\epsilon)-n_{\\mathrm{bench}}(M_j)}{n_{\\mathrm{bench}}(M_j)}\\right)^2 },\n$$\n其中 $\\,\\{M_j\\}\\,$ 是给定的离散晕质量。\n\n该流程必须选择所提供网格上满足 $\\,\\Delta_P(\\epsilon) \\le \\tau_P\\,$ 和 $\\,\\Delta_H(\\epsilon) \\le \\tau_H\\,$ 的最大软化长度 $\\,\\epsilon\\,$，同时受物理下界 $\\,\\epsilon \\ge f \\,\\bar{\\ell}\\,$ 的约束，其中 $\\,\\bar{\\ell}\\,$ 是平均粒子间距，$\\,f\\,$ 是一个为避免过度碰撞性的无量纲因子。如果没有任何 $\\,\\epsilon\\,$ 满足约束条件，则该测试用例的流程必须返回 $-1.0$。\n\n你必须明确地、一致地处理物理单位：\n- 以 $\\,h^{-1}\\,\\mathrm{kpc}\\,$ 为单位报告 $\\,\\epsilon\\,$。\n- 使用以 $\\,h\\,\\mathrm{Mpc}^{-1}\\,$ 为单位的波数 $\\,k\\,$。\n- 使用以 $\\,h^{-1}\\,M_\\odot\\,$ 为单位的质量 $\\,M\\,$。\n- 使用以 $\\,h^2\\,M_\\odot\\,\\mathrm{Mpc}^{-3}\\,$ 为单位的平均物质密度 $\\,\\bar{\\rho}\\,$。\n- 根据需要，在 $\\,h^{-1}\\,\\mathrm{Mpc}\\,$ 和 $\\,h^{-1}\\,\\mathrm{kpc}\\,$ 之间一致地转换长度尺度。\n\n程序必须实现以下特定的测试套件。对于每个测试用例，使用提供的基准数组和参数。基准数组是固定的数值序列；保持它们不变。\n\n定义基准波数和物质功率谱值：\n- 波数（单位为 $\\,h\\,\\mathrm{Mpc}^{-1}\\,$）：\n$$\n\\{k_i\\}_{i=1}^{7} = \\{0.1,\\ 0.2,\\ 0.5,\\ 1.0,\\ 1.5,\\ 2.0,\\ 3.0\\}.\n$$\n- 高分辨率基准物质功率谱值（单位为任意一致单位）：\n$$\n\\{P_{\\mathrm{bench}}(k_i)\\}_{i=1}^{7} = \\{1000,\\ 900,\\ 750,\\ 500,\\ 350,\\ 250,\\ 150\\}.\n$$\n\n定义基准晕质量和晕质量函数值：\n- 晕质量（单位为 $\\,h^{-1}\\,M_\\odot\\,$）：\n$$\n\\{M_j\\}_{j=1}^{7} = \\{10^{12},\\ 3\\times 10^{12},\\ 10^{13},\\ 3\\times 10^{13},\\ 10^{14},\\ 3\\times 10^{14},\\ 10^{15}\\}.\n$$\n- 高分辨率基准晕质量函数值（单位为 $\\,(\\mathrm{Mpc}/h)^{-3}\\,$ 每单位对数质量）：\n$$\n\\{n_{\\mathrm{bench}}(M_j)\\}_{j=1}^{7} = \\{10^{-3},\\ 6\\times 10^{-4},\\ 3\\times 10^{-4},\\ 10^{-4},\\ 3\\times 10^{-5},\\ 5\\times 10^{-6},\\ 10^{-6}\\}.\n$$\n\n使用适用于标准宇宙学的平均物质密度，其中物质密度参数 $\\,\\Omega_{\\mathrm{m}} = 0.315\\,$，\n$$\n\\bar{\\rho} = 2.775\\times 10^{11}\\,\\Omega_{\\mathrm{m}}\\,h^2\\,M_\\odot\\,\\mathrm{Mpc}^{-3}.\n$$\n\n使用顶帽关系（top-hat relation）将质量映射到特征尺度\n$$\nR(M) = \\left(\\frac{3M}{4\\pi \\bar{\\rho}}\\right)^{1/3},\n$$\n并关联一个特征波数\n$$\nk(M) = \\frac{\\pi}{R(M)}.\n$$\n\n对于软化预测，你必须从软化势中推导并实现一个傅里叶空间抑制因子 $\\,S(k,\\epsilon)\\,$，然后构建\n$$\nP_{\\mathrm{pred}}(k;\\epsilon) = P_{\\mathrm{bench}}(k)\\,\\left[S(k,\\epsilon)\\right]^\\nu,\n$$\n其中有一个从你的推导中产生的、有物理依据的指数 $\\,\\nu\\,$，以及\n$$\nn_{\\mathrm{pred}}(M;\\epsilon) = n_{\\mathrm{bench}}(M)\\,\\left[S(k(M),\\epsilon)\\right]^\\gamma,\n$$\n其中有一个有物理依据的指数 $\\,\\gamma\\,$，其基础是软化引力如何改变小尺度塌缩统计。你必须选择并捍卫 $\\,\\nu\\,$ 和 $\\,\\gamma\\,$ 的值。\n\n应用以下三个测试用例。在每个案例中，候选软化长度的均匀网格单位为 $\\,h^{-1}\\,\\mathrm{Mpc}\\,$，平均粒子间距约束使用 $\\,\\epsilon \\ge f\\bar{\\ell}\\,$ 且 $\\,f=0.3\\,$。\n\n- 测试用例1（一般情况）：\n    - $\\,\\bar{\\ell} = 0.25\\,h^{-1}\\,\\mathrm{Mpc}\\,$。\n    - 网格：$\\,\\epsilon \\in [0.05,\\,0.30]\\,h^{-1}\\,\\mathrm{Mpc}\\,$，步长为 $\\,0.005\\,h^{-1}\\,\\mathrm{Mpc}\\,$。\n    - 容差：$\\,\\tau_P = 0.08\\,$, $\\,\\tau_H = 0.12\\,$。\n\n- 测试用例2（严格容差，可能受边界压迫）：\n    - $\\,\\bar{\\ell} = 0.20\\,h^{-1}\\,\\mathrm{Mpc}\\,$。\n    - 网格：$\\,\\epsilon \\in [0.02,\\,0.18]\\,h^{-1}\\,\\mathrm{Mpc}\\,$，步长为 $\\,0.004\\,h^{-1}\\,\\mathrm{Mpc}\\,$。\n    - 容差：$\\,\\tau_P = 0.03\\,$, $\\,\\tau_H = 0.05\\,$。\n\n- 测试用例3（宽松容差，允许高软化）：\n    - $\\,\\bar{\\ell} = 0.35\\,h^{-1}\\,\\mathrm{Mpc}\\,$。\n    - 网格：$\\,\\epsilon \\in [0.10,\\,0.60]\\,h^{-1}\\,\\mathrm{Mpc}\\,$，步长为 $\\,0.01\\,h^{-1}\\,\\mathrm{Mpc}\\,$。\n    - 容差：$\\,\\tau_P = 0.30\\,$, $\\,\\tau_H = 0.30\\,$。\n\n选择规则：\n- 在满足 $\\,\\epsilon \\ge 0.3\\,\\bar{\\ell}\\,$ 以及 $\\,\\Delta_P(\\epsilon) \\le \\tau_P\\,$ 和 $\\,\\Delta_H(\\epsilon) \\le \\tau_H\\,$ 的网格值中，选择最大的 $\\,\\epsilon\\,$。\n- 如果没有 $\\,\\epsilon\\,$ 满足约束条件，则该测试用例返回 $-1.0$。\n\n最终输出格式：\n- 你的程序应生成单行输出，包含三个测试用例选择的软化长度，单位为 $\\,h^{-1}\\,\\mathrm{kpc}\\,$，每个值四舍五入到三位小数，以逗号分隔的列表形式并用方括号括起来，例如 $\\,\\left[\\epsilon_1,\\epsilon_2,\\epsilon_3\\right]\\,$。条目必须是纯十进制浮点数，不带任何单位字符串。\n\n你的程序必须是自包含的，并且可以使用 NumPy 和 SciPy 库。不允许外部输入或文件，也不允许网络访问。", "solution": "该问题陈述已经过严格验证，被认为是科学上合理的、适定的且客观的。它在计算天体物理学领域提出了一个清晰、可形式化的任务，该任务是自洽且无矛盾的。该问题要求从第一性原理推导物理模型，并在计算流程中实现它们，这是一项实质性且有效的科学实践。因此，我们可以着手提供一个完整的解决方案。\n\n该任务的核心是从一组离散的候选者中找到最大的引力软化长度 $\\epsilon$，该长度能将宇宙学模拟的统计特性——特别是物质功率谱 $P(k)$ 和晕质量函数 $n(M)$——维持在与高分辨率基准的指定容差范围内。这需要首先从理论上推导软化对这些统计量的影响，然后实现一个数值流程来执行选择。\n\n### 1. 傅里叶空间中引力抑制因子的推导\n\n在标准牛顿引力中，一个点质量 $m$ 的引力势为 $\\phi_N(r) = -Gm/r$。该势满足泊松方程 $\\nabla^2 \\phi = 4\\pi G \\rho$，在傅里叶空间中变为 $-k^2 \\phi(\\mathbf{k}) = 4\\pi G \\rho(\\mathbf{k})$，从而得到熟悉的核函数 $\\phi(\\mathbf{k}) \\propto \\rho(\\mathbf{k})/k^2$。\n\n问题指定使用一个Plummer型软化势来正则化 $r=0$ 处的奇点：\n$$\n\\phi_{\\mathrm{soft}}(r) = -\\frac{Gm}{\\sqrt{r^2 + \\epsilon^2}}\n$$\n其中 $\\epsilon$ 是软化长度。为了理解其对结构形成的影响（通常在傅里叶空间中分析），我们必须求出此软化势的傅里叶变换。点质量的牛顿势的傅里叶变换为 $\\tilde{\\phi}_N(\\mathbf{k}) = -4\\pi Gm / k^2$。软化势的傅里叶变换是：\n$$\n\\tilde{\\phi}_{\\mathrm{soft}}(\\mathbf{k}) = \\mathcal{F}\\left[ -\\frac{Gm}{\\sqrt{r^2 + \\epsilon^2}} \\right]\n$$\n这是一个标准结果，常在等离子体物理或引力理论的背景下推导。$(r^2+a^2)^{-1/2}$ 的变换与第二类修正贝塞尔函数有关。结果是：\n$$\n\\tilde{\\phi}_{\\mathrm{soft}}(\\mathbf{k}) = -\\frac{4\\pi Gm}{k^2} \\left[ (k\\epsilon) K_1(k\\epsilon) \\right]\n$$\n其中 $K_1$ 是一阶第二类修正贝塞尔函数。\n\n通过比较傅里叶空间中的软化势和牛顿势，我们可以确定乘性抑制因子，我们将其表示为 $S(k, \\epsilon)$：\n$$\n\\tilde{\\phi}_{\\mathrm{soft}}(\\mathbf{k}) = \\tilde{\\phi}_N(\\mathbf{k}) \\cdot S(k, \\epsilon)\n$$\n因此，由于长度为 $\\epsilon$ 的软化而修正了波数为 $k$ 处的引力耦合强度的抑制因子是：\n$$\nS(k, \\epsilon) = (k\\epsilon) K_1(k\\epsilon)\n$$\n该函数具有正确的物理行为：\n- 对于长波（$k\\epsilon \\to 0$），$S(k, \\epsilon) \\to 1$，意味着软化没有影响。\n- 对于短波（$k\\epsilon \\to \\infty$），$S(k, \\epsilon) \\to 0$，意味着引力被强烈抑制。\n\n### 2. 对功率谱和晕质量函数影响的建模\n\n该问题要求基于抑制因子 $S(k, \\epsilon)$ 构建预测的（软化的）功率谱 $P_{\\mathrm{pred}}(k;\\epsilon)$ 和晕质量函数 $n_{\\mathrm{pred}}(M;\\epsilon)$ 的模型。\n\n#### 2.1. 物质功率谱 ($P(k)$)\n\n物质功率谱定义为傅里叶空间中密度场的方差，$P(k) \\propto \\langle |\\delta(\\mathbf{k})|^2 \\rangle$。密度扰动 $\\delta$ 的增长是由引力不稳定性驱动的。在线性微扰理论和 Zel'dovich 近似的框架下，本动速度场由引力势产生，而粒子位移场 $\\mathbf{\\Psi}(\\mathbf{k})$ 与势的梯度成正比，$\\mathbf{\\Psi}(\\mathbf{k}) \\propto i\\mathbf{k} \\phi(\\mathbf{k})$。\n\n软化后，势被抑制，$\\phi_{\\mathrm{soft}}(\\mathbf{k}) = S(k, \\epsilon) \\phi_N(\\mathbf{k})$。因此，位移场也以相同的因子被抑制：$\\mathbf{\\Psi}_{\\mathrm{soft}}(\\mathbf{k}) = S(k, \\epsilon) \\mathbf{\\Psi}_N(\\mathbf{k})$。\n\n密度场通过连续性方程与位移场相关联，在线性理论中，这给出 $\\delta(\\mathbf{k}) = -i\\mathbf{k} \\cdot \\mathbf{\\Psi}(\\mathbf{k})$。将此应用于软化情况：\n$$\n\\delta_{\\mathrm{soft}}(\\mathbf{k}) = -i\\mathbf{k} \\cdot \\mathbf{\\Psi}_{\\mathrm{soft}}(\\mathbf{k}) = -i\\mathbf{k} \\cdot [S(k, \\epsilon) \\mathbf{\\Psi}_N(\\mathbf{k})] = S(k, \\epsilon) \\delta_N(\\mathbf{k})\n$$\n功率谱与密度场成二次方关系，因此被抑制因子的平方所抑制：\n$$\nP_{\\mathrm{pred}}(k;\\epsilon) = \\langle |\\delta_{\\mathrm{soft}}(\\mathbf{k})|^2 \\rangle = \\langle |S(k, \\epsilon) \\delta_N(\\mathbf{k})|^2 \\rangle = [S(k, \\epsilon)]^2 \\langle |\\delta_N(\\mathbf{k})|^2 \\rangle = [S(k, \\epsilon)]^2 P_{\\mathrm{bench}}(k)\n$$\n这为选择指数 $\\nu=2$ 提供了坚实的物理依据。\n\n#### 2.2. 晕质量函数 ($n(M)$)\n\n晕质量函数描述了给定质量 $M$ 的已塌缩的、引力束缚的天体（晕）的数密度。像 Press-Schechter 及其扩展理论将 $n(M)$ 与在对应于晕质量的尺度 $R(M)$ 上平滑的线性密度场方差 $\\sigma^2(M)$ 联系起来。\n\n软化会抑制功率谱，这反过来又会减小方差 $\\sigma^2(M)$。如前所述，$\\delta_{\\mathrm{soft}}(\\mathbf{k}) \\approx S(k, \\epsilon) \\delta_N(\\mathbf{k})$。这表明形成晕的种子密度涨落本身也受到了抑制。一个简单的第一性原理论证是，晕的丰度可能与这些种子涨落的幅度成比例。如果超过塌缩阈值的区域数量与该尺度上的典型涨落幅度成正比，那么晕质量函数将以一个因子 $S(k, \\epsilon)$ 被抑制。\n\n这意味着：\n$$\nn_{\\mathrm{pred}}(M;\\epsilon) = n_{\\mathrm{bench}}(M) \\cdot [S(k(M), \\epsilon)]^1\n$$\n其中 $k(M)$ 是与质量 $M$ 相关联的特征波数。这为选择指数 $\\gamma=1$ 提供了物理基础。虽然存在更复杂的模型（例如，涉及 $n(M)$ 的高质量端对 $\\sigma$ 变化的指数敏感性），但这种线性缩放代表了线性密度场被抑制的直接且稳健的后果，与所要求的“第一性原理”方法一致。\n\n### 3. 算法流程与实现\n\n校准流程的实现如下：\n1.  **初始化**：按照问题中的规定，定义所有常数、基准数据和测试用例参数。平均物质密度 $\\bar{\\rho}$ 计算为 $\\bar{\\rho} = 2.775\\times 10^{11}\\,\\Omega_{\\mathrm{m}}\\,h^2\\,M_\\odot\\,\\mathrm{Mpc}^{-3}$，其中 $\\Omega_{\\mathrm{m}} = 0.315$。单位被一致地处理，$\\epsilon$ 和 $k$ 具有长度的倒数单位，使得它们的乘积 $k\\epsilon$ 是无量纲的。\n2.  **遍历测试用例**：主程序循环遍历三个已定义的测试用例。\n3.  **候选者评估**：对于每个测试用例，流程遍历其指定网格上的每个候选软化长度 $\\epsilon$。\n    a. **物理约束**：首先，检查 $\\epsilon$ 是否满足物理下界 $\\epsilon \\ge f \\bar{\\ell}$，其中 $f=0.3$。过小的候选者被丢弃。\n    b. **功率谱偏差 $\\Delta_P(\\epsilon)$**：对于每个有效的 $\\epsilon$，计算与基准功率谱的偏差。对于每个基准波数 $k_i$，我们计算 $P_{\\mathrm{pred}}(k_i;\\epsilon) = P_{\\mathrm{bench}}(k_i)\\,[S(k_i, \\epsilon)]^2$。然后根据提供的 $\\Delta_P(\\epsilon)$ 公式计算分数差异的均方根。\n    c. **晕质量函数偏差 $\\Delta_H(\\epsilon)$**：类似地，计算与基准晕质量函数的偏差。对于每个基准质量 $M_j$，我们计算其特征半径 $R(M_j) = (3M_j / 4\\pi\\bar{\\rho})^{1/3}$ 和波数 $k(M_j) = \\pi/R(M_j)$。然后我们计算 $n_{\\mathrm{pred}}(M_j;\\epsilon) = n_{\\mathrm{bench}}(M_j)\\,[S(k(M_j), \\epsilon)]^1$。分数差异的均方根给出 $\\Delta_H(\\epsilon)$。\n    d. **容差检查**：将计算出的偏差与容差进行比较：$\\Delta_P(\\epsilon) \\le \\tau_P$ 和 $\\Delta_H(\\epsilon) \\le \\tau_H$。\n4.  **选择逻辑**：\n    - 收集网格中所有同时满足物理约束和两个容差约束的 $\\epsilon$ 值。\n    - 如果这组有效的软化长度不为空，则选择集合中的最大值作为最优的 $\\epsilon$。\n    - 如果集合为空（即网格上没有 $\\epsilon$ 值满足所有条件），则该测试用例的结果定义为 $-1.0$。\n5.  **最终输出**：每个测试用例选择的 $\\epsilon$（单位为 $h^{-1}\\,\\mathrm{Mpc}$）通过乘以 $1000$ 转换为 $h^{-1}\\,\\mathrm{kpc}$。收集最终结果并以指定格式 `[result1, result2, result3]` 打印，每个值四舍五入到三位小数。\n\n此过程为所述问题提供了一个完整且确定性的解决方案。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import k1\n\ndef solve():\n    \"\"\"\n    Implements a calibration pipeline to select an optimal gravitational softening length\n    based on matching matter power spectra and halo mass functions to benchmarks.\n    \"\"\"\n\n    # --- Fixed Physical Constants and Benchmark Data ---\n\n    # Cosmological parameters\n    OMEGA_M = 0.315\n    # Mean matter density in h^2 M_sun / Mpc^3\n    RHO_BAR = 2.775e11 * OMEGA_M\n\n    # Benchmark wavenumbers k_i in h/Mpc\n    K_BENCH = np.array([0.1, 0.2, 0.5, 1.0, 1.5, 2.0, 3.0])\n    # Benchmark matter power spectrum P_bench(k_i)\n    P_BENCH = np.array([1000.0, 900.0, 750.0, 500.0, 350.0, 250.0, 150.0])\n\n    # Benchmark halo masses M_j in h^-1 M_sun\n    M_BENCH = np.array([1e12, 3e12, 1e13, 3e13, 1e14, 3e14, 1e15])\n    # Benchmark halo mass function n_bench(M_j) in (Mpc/h)^-3 / ln(M)\n    N_BENCH = np.array([1e-3, 6e-4, 3e-4, 1e-4, 3e-5, 5e-6, 1e-6])\n    \n    # Exponents for suppression models, as derived from first principles\n    NU_P = 2.0  # For power spectrum P(k) \\propto [S(k,e)]^nu\n    GAMMA_H = 1.0 # For halo mass function n(M) \\propto [S(k(M),e)]^gamma\n\n    # Factor for physical lower bound on softening\n    F_LOWER_BOUND = 0.3\n\n    # --- Helper Functions ---\n\n    def suppression_factor(k, epsilon):\n        \"\"\"\n        Calculates the Fourier-space suppression factor S(k, epsilon) for a\n        Plummer potential.\n        S(k, e) = (k*e) * K_1(k*e), where K_1 is modified Bessel function.\n        \"\"\"\n        x = k * epsilon\n        # Handle the limit x -> 0 where x*K1(x) -> 1, avoiding potential numerical issues.\n        # SciPy's k1 handles x=0 correctly (inf), so we check x.\n        # A small x limit where the approximation is good.\n        if np.all(x  1e-6):\n            return np.ones_like(x)\n        # For non-zero x, calculate directly.\n        return x * k1(x)\n\n    def mass_to_wavenumber(M):\n        \"\"\"\n        Converts halo mass M to characteristic wavenumber k(M) via top-hat radius.\n        R(M) = (3*M / (4*pi*rho_bar))^(1/3)\n        k(M) = pi / R(M)\n        \"\"\"\n        # R is in h^-1 Mpc\n        R = (3.0 * M / (4.0 * np.pi * RHO_BAR))**(1.0/3.0)\n        # k is in h Mpc^-1\n        k = np.pi / R\n        return k\n\n    # --- Test Case Definitions ---\n    test_cases = [\n        {\n            \"l_bar\": 0.25,  # h^-1 Mpc\n            \"eps_grid_params\": (0.05, 0.30, 0.005), # start, stop, step in h^-1 Mpc\n            \"tau_P\": 0.08,\n            \"tau_H\": 0.12,\n        },\n        {\n            \"l_bar\": 0.20,\n            \"eps_grid_params\": (0.02, 0.18, 0.004),\n            \"tau_P\": 0.03,\n            \"tau_H\": 0.05,\n        },\n        {\n            \"l_bar\": 0.35,\n            \"eps_grid_params\": (0.10, 0.60, 0.01),\n            \"tau_P\": 0.30,\n            \"tau_H\": 0.30,\n        },\n    ]\n\n    final_results = []\n\n    # --- Main Loop over Test Cases ---\n    for case in test_cases:\n        l_bar = case[\"l_bar\"]\n        start, stop, step = case[\"eps_grid_params\"]\n        tau_P = case[\"tau_P\"]\n        tau_H = case[\"tau_H\"]\n\n        # Generate grid of candidate epsilon values in h^-1 Mpc\n        # Use np.arange and add a small amount to stop to ensure it's inclusive\n        eps_grid = np.arange(start, stop + step / 2, step)\n\n        # Physical lower bound for epsilon in h^-1 Mpc\n        eps_min_phys = F_LOWER_BOUND * l_bar\n\n        valid_epsilons = []\n\n        # characteristic wavenumbers for halo masses\n        k_from_M_bench = mass_to_wavenumber(M_BENCH)\n\n        for eps in eps_grid:\n            # 1. Check physical constraint\n            if eps  eps_min_phys:\n                continue\n\n            # 2. Calculate P(k) deviation\n            S_k = suppression_factor(K_BENCH, eps)\n            P_pred = P_BENCH * (S_k**NU_P)\n            delta_P = np.sqrt(np.mean(((P_pred - P_BENCH) / P_BENCH)**2))\n\n            # 3. Calculate n(M) deviation\n            S_M = suppression_factor(k_from_M_bench, eps)\n            n_pred = N_BENCH * (S_M**GAMMA_H)\n            delta_H = np.sqrt(np.mean(((n_pred - N_BENCH) / N_BENCH)**2))\n\n            # 4. Check tolerances\n            if delta_P = tau_P and delta_H = tau_H:\n                valid_epsilons.append(eps)\n\n        if not valid_epsilons:\n            # No epsilon satisfied the constraints\n            result = -1.0\n        else:\n            # Select the largest valid epsilon\n            # The result is in h^-1 Mpc, convert to h^-1 kpc\n            result = max(valid_epsilons) * 1000.0\n\n        final_results.append(result)\n\n    # Format the final output as specified\n    formatted_results = [f\"{res:.3f}\" if res != -1.0 else \"-1.0\" for res in final_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "3535195"}]}