{"hands_on_practices": [{"introduction": "逆变换采样是根据给定概率分布生成随机数最直接、计算效率最高的方法。本练习聚焦于推导Henyey-Greenstein相函数的采样器，这是天体物理学中各向异性散射的基石模型。掌握此推导将为你配备一个构建真实蒙特卡洛辐射转移模拟的关键工具。[@problem_id:3522939]", "problem": "考虑在辐射转移中，使用 Henyey–Greenstein 相函数模拟的星际尘埃光子散射。该相函数在计算天体物理学中被广泛用于描述各向异性散射。令 $\\mu=\\cos\\theta\\in[-1,1]$ 表示散射角的余弦。对于各向异性参数 $g\\in(-1,1)$，未归一化的概率密度函数由 $p(\\mu)\\propto \\dfrac{1-g^{2}}{\\left(1+g^{2}-2g\\mu\\right)^{3/2}}$ 给出。在蒙特卡洛（MC）辐射转移中，通过逆变换采样法实现对 $\\mu$ 的高效采样：抽取一个均匀分布随机数 $\\xi\\in(0,1)$，并将 $\\mu$ 设置为在 $\\xi$ 处求值的逆累积分布函数（CDF）。从概率密度函数（PDF）的基本定义、其在支撑集 $[-1,1]$ 上的归一化以及累积分布函数 $F(\\mu)=\\int_{-1}^{\\mu}p(\\mu')\\,d\\mu'$ 出发，推导出一个闭式解析表达式，用于表示逆 CDF 映射 $\\xi\\mapsto\\mu(\\xi;g)$，该映射生成的样本在 $\\mu\\in[-1,1]$ 上遵循归一化的 Henyey–Greenstein 分布律。将最终结果表示为以 $g$ 和 $\\xi$ 为变量的单个符号表达式。不需要进行数值近似或舍入。不要返回角度 $\\theta$；返回待采样的量 $\\mu=\\cos\\theta$。", "solution": "推导过程主要分为三步：概率密度函数（PDF）的归一化、累积分布函数（CDF）的计算，以及 CDF 的求逆。\n\n### 1. PDF 的归一化\n\n设未归一化的 PDF 为 $p_{un}(\\mu) = \\frac{1-g^2}{(1+g^2-2g\\mu)^{3/2}}$。归一化后的 PDF $p(\\mu)$ 必须满足条件 $\\int_{-1}^{1} p(\\mu) \\, d\\mu = 1$。令 $p(\\mu) = C \\cdot p_{un}(\\mu)$，其中 $C$ 是归一化常数。我们必须首先计算 $p_{un}(\\mu)$ 在其支撑集 $[-1, 1]$ 上的积分。\n\n$$\n\\int_{-1}^{1} p_{un}(\\mu) \\, d\\mu = \\int_{-1}^{1} \\frac{1-g^2}{(1+g^2-2g\\mu)^{3/2}} \\, d\\mu\n$$\n\n我们使用换元法，令 $u = 1+g^2-2g\\mu$，这意味着 $d\\mu = -\\frac{du}{2g}$。积分上下限从 $\\mu=-1$ 变为 $u=(1+g)^2$，从 $\\mu=1$ 变为 $u=(1-g)^2$。\n\n$$\n\\begin{aligned}\n\\int_{-1}^{1} p_{un}(\\mu) \\, d\\mu = (1-g^2) \\int_{(1+g)^2}^{(1-g)^2} u^{-3/2} \\left(-\\frac{du}{2g}\\right) \\\\\n= \\frac{1-g^2}{-2g} \\left[ \\frac{u^{-1/2}}{-1/2} \\right]_{(1+g)^2}^{(1-g)^2} \\\\\n= \\frac{1-g^2}{g} \\left[ u^{-1/2} \\right]_{(1+g)^2}^{(1-g)^2} \\\\\n= \\frac{1-g^2}{g} \\left( ((1-g)^2)^{-1/2} - ((1+g)^2)^{-1/2} \\right)\n\\end{aligned}\n$$\n\n由于 $g \\in (-1, 1)$，因此 $1-g$ 和 $1+g$ 均为正数。所以，$\\sqrt{(1-g)^2} = 1-g$ 且 $\\sqrt{(1+g)^2} = 1+g$。\n\n$$\n\\begin{aligned}\n\\int_{-1}^{1} p_{un}(\\mu) \\, d\\mu = \\frac{1-g^2}{g} \\left( \\frac{1}{1-g} - \\frac{1}{1+g} \\right) \\\\\n= \\frac{(1-g)(1+g)}{g} \\left( \\frac{(1+g) - (1-g)}{(1-g)(1+g)} \\right) \\\\\n= \\frac{1}{g} (1+g-1+g) = \\frac{2g}{g} = 2\n\\end{aligned}\n$$\n\n给定表达式的积分为 $2$。因此，归一化常数 $C = 1/2$。正确归一化的 PDF 为：\n\n$$\np(\\mu) = \\frac{1}{2} \\frac{1-g^2}{(1+g^2-2g\\mu)^{3/2}}\n$$\n\n### 2. CDF 的计算\n\nCDF $F(\\mu)$ 定义为 PDF 从支撑集的下界到 $\\mu$ 的积分。\n\n$$\nF(\\mu) = \\int_{-1}^{\\mu} p(\\mu') \\, d\\mu' = \\int_{-1}^{\\mu} \\frac{1}{2} \\frac{1-g^2}{(1+g^2-2g\\mu')^{3/2}} \\, d\\mu'\n$$\n\n我们使用与归一化步骤中相同的原函数。对于 $g \\neq 0$：\n\n$$\n\\begin{aligned}\nF(\\mu) = \\frac{1-g^2}{2} \\left[ \\frac{1}{g} (1+g^2-2g\\mu')^{-1/2} \\right]_{-1}^{\\mu} \\\\\n= \\frac{1-g^2}{2g} \\left[ (1+g^2-2g\\mu)^{-1/2} - (1+g^2-2g(-1))^{-1/2} \\right] \\\\\n= \\frac{1-g^2}{2g} \\left( \\frac{1}{\\sqrt{1+g^2-2g\\mu}} - \\frac{1}{\\sqrt{(1+g)^2}} \\right) \\\\\n= \\frac{1-g^2}{2g} \\left( \\frac{1}{\\sqrt{1+g^2-2g\\mu}} - \\frac{1}{1+g} \\right)\n\\end{aligned}\n$$\n\n我们可以验证 $F(-1)=0$ 和 $F(1)=1$，这证实了 CDF 的正确性。\n\n### 3. CDF 的求逆\n\n为了求逆函数 $\\mu(\\xi) = F^{-1}(\\xi)$，我们令 $F(\\mu) = \\xi$ 并解出 $\\mu$。此方法对 $g \\neq 0$ 有效。\n\n$$\n\\xi = \\frac{1-g^2}{2g} \\left( \\frac{1}{\\sqrt{1+g^2-2g\\mu}} - \\frac{1}{1+g} \\right)\n$$\n\n我们重排方程以分离出 $\\mu$：\n\n$$\n\\frac{2g\\xi}{1-g^2} = \\frac{1}{\\sqrt{1+g^2-2g\\mu}} - \\frac{1}{1+g}\n$$\n\n$$\n\\frac{1}{\\sqrt{1+g^2-2g\\mu}} = \\frac{2g\\xi}{1-g^2} + \\frac{1}{1+g} = \\frac{2g\\xi + (1-g)}{(1-g)(1+g)} = \\frac{1-g+2g\\xi}{1-g^2}\n$$\n\n两边取倒数得到：\n\n$$\n\\sqrt{1+g^2-2g\\mu} = \\frac{1-g^2}{1-g+2g\\xi}\n$$\n\n两边平方：\n\n$$\n1+g^2-2g\\mu = \\left( \\frac{1-g^2}{1-g+2g\\xi} \\right)^2\n$$\n\n最后，解出 $\\mu$：\n\n$$\n2g\\mu = 1+g^2 - \\left( \\frac{1-g^2}{1-g+2g\\xi} \\right)^2\n$$\n\n$$\n\\mu(\\xi; g) = \\frac{1}{2g} \\left[ 1+g^2 - \\left( \\frac{1-g^2}{1-g+2g\\xi} \\right)^2 \\right]\n$$\n\n此表达式是 $g \\neq 0$ 时所需的逆 CDF。对于 $g=0$（各向同性散射）的特殊情况，PDF 变为均匀分布 $p(\\mu)=1/2$，CDF 为 $F(\\mu) = (\\mu+1)/2$。对其求逆得到 $\\mu = 2\\xi-1$。所推导的关于 $\\mu(\\xi; g)$ 的通用表达式在极限 $g \\to 0$ 时正确地得到了这个结果，这可以通过使用 L'Hôpital 法则或泰勒展开来验证。因此，该表达式在整个定义域 $g \\in (-1, 1)$ 上是连续的。这就是逆 CDF 的单个符号表达式。", "answer": "$$\n\\boxed{\\frac{1}{2g} \\left[ 1+g^{2} - \\left( \\frac{1-g^{2}}{1-g+2g\\xi} \\right)^{2} \\right]}\n$$", "id": "3522939"}, {"introduction": "尽管逆变换采样是理想选择，但其前提条件——存在可解析反演的累积分布函数（CDF）——并非总能满足。此时，接受-拒绝采样法就成了一种不可或缺且高度灵活的工具。本练习将指导你为一种不同的各向异性散射分布构建采样器，阐明其通用原理及采样效率这一重要概念。[@problem_id:3523288]", "problem": "考虑蒙特卡洛辐射传输 (MCRT) 中的一个任务：对散射偏转角进行采样，其概率密度函数 (PDF) 在 $\\theta \\in [0,\\pi]$ 上与 $1+\\alpha \\cos^{2}\\theta$ 成正比，其中 $\\alpha \\in [0,1]$ 控制各向异性程度。定义 $\\mu \\equiv \\cos \\theta$，因此 $\\mu \\in [-1,1]$，并将关于 $\\mu$ 的目标密度解释为与 $1+\\alpha \\mu^{2}$ 成正比。目标是使用接受-拒绝采样法，其包络在 $\\mu$ 上是均匀的，来构建一个以弧度为单位的 $\\theta$ 采样器，并描述接受率作为 $\\alpha$ 的函数。\n\n从概率密度函数和接受-拒绝采样法的基本定义出发，完成以下任务：\n\n1. 推导目标密度 $f(\\mu) \\propto 1+\\alpha \\mu^{2}$ 在 $\\mu \\in [-1,1]$ 上相对于勒贝格测度 $d\\mu$ 的归一化常数 $Z(\\alpha)$。以闭式形式表达归一化后的目标密度 $f(\\mu)$。\n\n2. 使用一个在 $\\mu \\in [-1,1]$ 上均匀的包络密度 $g(\\mu)$（即 $g(\\mu)=\\frac{1}{2}$），找到最小包络尺度 $M(\\alpha)$，使得对所有 $\\mu \\in [-1,1]$ 都有 $f(\\mu) \\le M(\\alpha)\\,g(\\mu)$。根据接受-拒绝采样法的基本原理，推导出接受率 $R(\\alpha)$ 作为 $\\alpha$ 的函数的闭式表达式。\n\n3. 设计一个接受-拒绝采样器，该采样器：\n   - 从 $g(\\mu)$ 中提议 $\\mu$，\n   - 以根据你推导的 $M(\\alpha)$ 得出的概率 $a(\\mu,\\alpha)$ 接受，\n   - 返回以弧度为单位的角度 $\\theta = \\arccos(\\mu)$。\n   你的实现必须对所有 $\\alpha \\in [0,1]$ 都有效。\n\n4. 测试套件和输出规范：\n   - 对于参数值 $\\alpha \\in \\{0, 0.25, 0.5, 1\\}$，计算你推导出的解析接受率 $R(\\alpha)$。\n   - 你的程序必须输出单行，包含这四个结果，形式为方括号内的逗号分隔列表，并按给定的 $\\alpha$ 值顺序排列。每个值必须四舍五入到 $6$ 位小数。\n   - 最终输出格式必须严格为：“[r0,r1,r2,r3]”，其中每个 $r_k$ 是一个有 $6$ 位小数的浮点数。采样器内部使用的角度必须以弧度为单位，但程序要求的输出是接受率列表，这些值是无量纲的。\n\n科学和数值要求：\n- 所有角度均以弧度为单位。\n- 接受-拒绝框架必须根据适当归一化的PDF进行表述。\n- 确保你的推导与从 $\\theta$ 到 $\\mu = \\cos \\theta$ 的变量变换下的PDF定义一致。\n- 最终程序必须是自包含的，且不得读取任何输入。\n\n你的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔的结果列表，例如“[r0,r1,r2,r3]”。", "solution": "该解答分为三个部分：归一化概率密度函数 (PDF) 的推导、接受-拒绝采样参数的推导，以及最后算法的构建和所需值的计算。\n\n### 1. 归一化目标 PDF 的推导\n问题指定了变量 $\\mu = \\cos\\theta$ 在区间 $\\mu \\in [-1, 1]$ 上的目标概率密度与 $1+\\alpha\\mu^2$ 成正比。让我们将这个未归一化的密度表示为 $\\tilde{f}(\\mu)$。\n$$\n\\tilde{f}(\\mu) = 1 + \\alpha\\mu^2\n$$\n为了将其转换为一个真正的 PDF $f(\\mu)$，我们必须通过除以它在定义域上的积分来对其进行归一化。这个积分就是归一化常数 $Z(\\alpha)$。\n$$\nZ(\\alpha) = \\int_{-1}^{1} \\tilde{f}(\\mu) \\, d\\mu = \\int_{-1}^{1} (1 + \\alpha\\mu^2) \\, d\\mu\n$$\n积分过程很简单：\n$$\nZ(\\alpha) = \\left[ \\mu + \\frac{\\alpha\\mu^3}{3} \\right]_{-1}^{1} = \\left(1 + \\frac{\\alpha(1)^3}{3}\\right) - \\left(-1 + \\frac{\\alpha(-1)^3}{3}\\right) = \\left(1 + \\frac{\\alpha}{3}\\right) - \\left(-1 - \\frac{\\alpha}{3}\\right)\n$$\n$$\nZ(\\alpha) = 1 + \\frac{\\alpha}{3} + 1 + \\frac{\\alpha}{3} = 2 + \\frac{2\\alpha}{3}\n$$\n因此，归一化后的 PDF $f(\\mu)$ 由下式给出：\n$$\nf(\\mu) = \\frac{\\tilde{f}(\\mu)}{Z(\\alpha)} = \\frac{1 + \\alpha\\mu^2}{2 + \\frac{2\\alpha}{3}}\n$$\n\n### 2. 包络尺度和接受率\n接受-拒绝采样法需要一个提议 PDF $g(\\mu)$ 和一个包络尺度常数 $M(\\alpha)$，使得在定义域中对所有 $\\mu$ 都有 $f(\\mu) \\le M(\\alpha)g(\\mu)$。问题指定了一个在 $\\mu \\in [-1, 1]$ 上的均匀提议 PDF。\n$$\ng(\\mu) = \\frac{1}{1 - (-1)} = \\frac{1}{2}\n$$\n最小包络尺度 $M(\\alpha)$ 是目标 PDF 与提议 PDF 之比在定义域上的最大值。\n$$\nM(\\alpha) = \\max_{\\mu \\in [-1, 1]} \\frac{f(\\mu)}{g(\\mu)}\n$$\n代入 $f(\\mu)$ 和 $g(\\mu)$ 的表达式：\n$$\n\\frac{f(\\mu)}{g(\\mu)} = \\frac{\\frac{1 + \\alpha\\mu^2}{2 + 2\\alpha/3}}{\\frac{1}{2}} = \\frac{2(1 + \\alpha\\mu^2)}{2(1 + \\alpha/3)} = \\frac{1 + \\alpha\\mu^2}{1 + \\alpha/3} = \\frac{3(1 + \\alpha\\mu^2)}{3 + \\alpha}\n$$\n为了找到这个比率的最大值，我们检查它对 $\\mu$ 的依赖性。令 $h(\\mu) = \\frac{3(1 + \\alpha\\mu^2)}{3 + \\alpha}$。关于 $\\mu$ 的导数是 $h'(\\mu) = \\frac{6\\alpha\\mu}{3 + \\alpha}$。由于 $\\alpha \\in [0, 1]$，$6\\alpha/(3+\\alpha)$ 这一项是非负的。\n- 如果 $\\alpha=0$，$h(\\mu)$ 是常数。\n- 如果 $\\alpha > 0$，$h(\\mu)$ 是一个关于 $\\mu$ 的开口向上的抛物线，其最小值在 $\\mu=0$ 处。因此，它在区间 $[-1, 1]$ 上的最大值必须出现在边界 $\\mu=-1$ 或 $\\mu=1$ 处。\n根据对称性 ($\\mu^2$)，两个端点的值是相同的。让我们在 $\\mu=1$ 处求值：\n$$\nM(\\alpha) = \\left. \\frac{3(1 + \\alpha\\mu^2)}{3 + \\alpha} \\right|_{\\mu=1} = \\frac{3(1 + \\alpha)}{3 + \\alpha}\n$$\n在接受-拒绝采样法中，只要 $f$ 和 $g$ 都是归一化的 PDF，接受一个提议样本的总概率就是包络尺度 $M(\\alpha)$ 的倒数。这就是接受率 $R(\\alpha)$。\n$$\nR(\\alpha) = \\frac{1}{M(\\alpha)} = \\frac{3 + \\alpha}{3(1 + \\alpha)}\n$$\n这是接受率 $R(\\alpha)$ 作为 $\\alpha$ 函数的闭式表达式。\n\n### 3. 采样器设计与计算\n接受-拒绝采样器按以下方式操作：\n1.  从提议分布 $g(\\mu)$ 中抽取一个候选值 $\\mu_c$，即从 $[-1, 1]$ 上的均匀分布中采样 $\\mu_c$。\n2.  从 $[0, 1]$ 上的均匀分布中抽取一个随机数 $u$。\n3.  如果满足条件 $u \\le \\frac{f(\\mu_c)}{M(\\alpha)g(\\mu_c)}$，则接受 $\\mu_c$。对于给定的 $\\mu_c$，其接受概率 $a(\\mu_c, \\alpha)$ 可以很好地简化：\n    $$\n    a(\\mu_c, \\alpha) = \\frac{f(\\mu_c)}{M(\\alpha)g(\\mu_c)} = \\frac{1}{M(\\alpha)} \\frac{f(\\mu_c)}{g(\\mu_c)} = \\frac{3 + \\alpha}{3(1 + \\alpha)} \\cdot \\frac{3(1 + \\alpha\\mu_c^2)}{3 + \\alpha} = \\frac{1 + \\alpha\\mu_c^2}{1 + \\alpha}\n    $$\n    所以，接受条件是 $u \\le \\frac{1 + \\alpha\\mu_c^2}{1 + \\alpha}$。\n4.  如果样本被接受，最终输出为散射角 $\\theta = \\arccos(\\mu_c)$（以弧度为单位）。如果被拒绝，则从步骤1开始重复该过程。\n\n问题要求为 $\\alpha \\in \\{0, 0.25, 0.5, 1\\}$ 计算解析接受率 $R(\\alpha)$，这将在最终程序中实现。\n$$\nR(\\alpha) = \\frac{3 + \\alpha}{3(1 + \\alpha)}\n$$\n- 对于 $\\alpha=0$：$R(0) = \\frac{3}{3(1)} = 1$。\n- 对于 $\\alpha=0.25$：$R(0.25) = \\frac{3.25}{3(1.25)} = \\frac{3.25}{3.75} = \\frac{13}{15} \\approx 0.866667$。\n- 对于 $\\alpha=0.5$：$R(0.5) = \\frac{3.5}{3(1.5)} = \\frac{3.5}{4.5} = \\frac{7}{9} \\approx 0.777778$。\n- 对于 $\\alpha=1$：$R(1) = \\frac{4}{3(2)} = \\frac{4}{6} = \\frac{2}{3} \\approx 0.666667$。\n程序将计算这些值并按要求进行格式化。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Calculates the analytic acceptance rate for a Monte Carlo sampler\n    based on the problem specification.\n    \"\"\"\n    # Define the test cases for the anisotropy parameter alpha.\n    test_cases = [0.0, 0.25, 0.5, 1.0]\n\n    results = []\n    for alpha in test_cases:\n        # The acceptance rate R(alpha) is derived from first principles as:\n        # R(alpha) = (3 + alpha) / (3 * (1 + alpha))\n        # This formula is valid for all alpha >= 0.\n        acceptance_rate = (3.0 + alpha) / (3.0 * (1.0 + alpha))\n        results.append(acceptance_rate)\n\n    # Format the results into a string with each value rounded to 6 decimal places,\n    # as required by the problem statement.\n    formatted_results = [f\"{r:.6f}\" for r in results]\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "3523288"}, {"introduction": "高效的蒙特卡洛模拟不仅需要正确的采样，还需要策略性的资源管理。本练习将视角从单个光子包的运动机制转向整个模拟的全局优化。你将处理一个关键任务：在固定的计算预算下，如何在模拟的不同区域间分配光子包，以最小化整体统计误差，这是一种能显著提升模拟效率的强大技术。[@problem_id:3523263]", "problem": "使用蒙特卡洛辐射传输模拟来估计一个全局的、按体积加权的辐射度量，该度量可以写成空间单元上的一个线性泛函。将计算域划分为 $M$ 个不相交的单元，索引为 $i \\in \\{1,\\dots,M\\}$。在单元 $i$ 中，每个辐射包产生一个得分 $X_{i,k}$，$k \\in \\{1,\\dots,n_i\\}$，其中 $n_i$ 是分配给单元 $i$ 的包的数量。假设 $\\{X_{i,k}\\}_{k=1}^{n_i}$ 是独立同分布的，具有有限均值 $\\mu_i$ 和方差 $\\sigma_i^2$，并且不同单元间的抽样流是独立的。单元均值的估计量是 $\\hat{\\mu}_i = \\frac{1}{n_i} \\sum_{k=1}^{n_i} X_{i,k}$。我们感兴趣的全局量是\n$$\nQ \\equiv \\sum_{i=1}^{M} w_i \\,\\mu_i,\n$$\n其中 $w_i > 0$ 是由得分泛函的物理意义确定的固定单元权重（例如，单元体积乘以一个已知的响应因子）。您通过以下方式估计 $Q$：\n$$\n\\hat{Q} \\equiv \\sum_{i=1}^{M} w_i \\,\\hat{\\mu}_i.\n$$\n给定一次初步引导性运行得到的每个样本的方差 $\\sigma_i^2$ 和一个固定的总包预算 $N_{\\text{tot}}$，该预算对分配施加约束 $\\sum_{i=1}^{M} n_i = N_{\\text{tot}}$。在优化时，将 $n_i$ 视为正实数决策变量。\n\n仅从独立的蒙特卡洛样本均值的基本性质以及独立随机变量之和的方差法则出发，推导在预算约束下最小化 $\\mathrm{Var}(\\hat{Q})$ 的分配 $\\{n_i^\\star\\}_{i=1}^{M}$。将您的结果写成一个用 $\\{w_i\\}_{i=1}^M$、$\\{\\sigma_i^2\\}_{i=1}^M$ 和 $N_{\\text{tot}}$ 表示的闭式表达式。\n\n然后，对于 $M=4$ 的具体情况，使用以下数据计算您的表达式：\n$$w_1 = 1,\\quad w_2 = 2,\\quad w_3 = \\frac{1}{2},\\quad w_4 = \\frac{3}{2}$$\n以及引导性运行得到的每样本方差：\n$$\\sigma_1^2 = 4,\\quad \\sigma_2^2 = 1,\\quad \\sigma_3^2 = 9,\\quad \\sigma_4^2 = 16$$\n总预算为 $N_{\\text{tot}} = 115000$。\n将最终的分配向量 $(n_1^\\star,n_2^\\star,n_3^\\star,n_4^\\star)$ 精确地表示为整数，无需四舍五入。您的最终答案必须是一个单行向量表达式。", "solution": "首先，我们建立目标函数，即估计量 $\\hat{Q}$ 的方差，记为 $\\mathrm{Var}(\\hat{Q})$。估计量定义为：\n$$\n\\hat{Q} \\equiv \\sum_{i=1}^{M} w_i \\,\\hat{\\mu}_i\n$$\n其中 $\\hat{\\mu}_i$ 是单元 $i$ 的样本均值。问题陈述中提到，不同单元间的抽样流是独立的。这意味着当 $i \\neq j$ 时，随机变量 $\\hat{\\mu}_i$ 和 $\\hat{\\mu}_j$ 是独立的。对于独立随机变量之和，其和的方差等于方差之和。应用此规则和方差的尺度性质 $\\mathrm{Var}(aX) = a^2 \\mathrm{Var}(X)$，我们得到：\n$$\n\\mathrm{Var}(\\hat{Q}) = \\mathrm{Var}\\left(\\sum_{i=1}^{M} w_i \\hat{\\mu}_i\\right) = \\sum_{i=1}^{M} \\mathrm{Var}(w_i \\hat{\\mu}_i) = \\sum_{i=1}^{M} w_i^2 \\mathrm{Var}(\\hat{\\mu}_i)\n$$\n接下来，我们确定 $\\mathrm{Var}(\\hat{\\mu}_i)$。单元均值的估计量 $\\hat{\\mu}_i$ 是 $n_i$ 个独立同分布（i.i.d.）得分 $X_{i,k}$ 的平均值，每个得分的方差为 $\\sigma_i^2$：\n$$\n\\hat{\\mu}_i = \\frac{1}{n_i} \\sum_{k=1}^{n_i} X_{i,k}\n$$\n这个样本均值的方差是：\n$$\n\\mathrm{Var}(\\hat{\\mu}_i) = \\mathrm{Var}\\left(\\frac{1}{n_i} \\sum_{k=1}^{n_i} X_{i,k}\\right) = \\frac{1}{n_i^2} \\mathrm{Var}\\left(\\sum_{k=1}^{n_i} X_{i,k}\\right)\n$$\n由于得分 $X_{i,k}$ 是独立同分布的，它们的和的方差等于它们方差的和：\n$$\n\\mathrm{Var}(\\hat{\\mu}_i) = \\frac{1}{n_i^2} \\sum_{k=1}^{n_i} \\mathrm{Var}(X_{i,k}) = \\frac{1}{n_i^2} (n_i \\sigma_i^2) = \\frac{\\sigma_i^2}{n_i}\n$$\n将此结果代回到 $\\mathrm{Var}(\\hat{Q})$ 的表达式中，我们得到需要最小化的目标函数：\n$$\nV(n_1, \\dots, n_M) = \\mathrm{Var}(\\hat{Q}) = \\sum_{i=1}^{M} \\frac{w_i^2 \\sigma_i^2}{n_i}\n$$\n这个方差必须在预算约束下最小化：\n$$\n\\sum_{i=1}^{M} n_i = N_{\\text{tot}}\n$$\n我们使用拉格朗日乘数法来解决这个约束优化问题。决策变量 $n_i$ 被视为正实数。拉格朗日函数 $\\mathcal{L}$ 是：\n$$\n\\mathcal{L}(n_1, \\dots, n_M, \\lambda) = \\sum_{i=1}^{M} \\frac{w_i^2 \\sigma_i^2}{n_i} - \\lambda \\left(\\sum_{i=1}^{M} n_i - N_{\\text{tot}}\\right)\n$$\n为了找到最小值，我们将 $\\mathcal{L}$ 关于每个 $n_j$ 的偏导数设为零：\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial n_j} = -\\frac{w_j^2 \\sigma_j^2}{n_j^2} - \\lambda = 0 \\quad \\text{for } j=1, \\dots, M\n$$\n这得到：\n$$\n\\frac{w_j^2 \\sigma_j^2}{n_j^2} = -\\lambda\n$$\n由于 $w_j^2 > 0$，$\\sigma_j^2 \\ge 0$ 且 $n_j^2 > 0$，右边先验地必须是非负的。让我们定义一个新的正常数 $\\lambda' = -\\lambda$。取正平方根（因为 $n_j$ 和 $w_j$ 是正的，且 $\\sigma_j \\equiv \\sqrt{\\sigma_j^2} \\ge 0$）：\n$$\n\\frac{w_j \\sigma_j}{n_j} = \\sqrt{\\lambda'} \\implies n_j = \\frac{w_j \\sigma_j}{\\sqrt{\\lambda'}}\n$$\n为了确定 $\\sqrt{\\lambda'}$，我们将 $n_j$ 的表达式代入约束方程：\n$$\n\\sum_{j=1}^{M} n_j = \\sum_{j=1}^{M} \\frac{w_j \\sigma_j}{\\sqrt{\\lambda'}} = \\frac{1}{\\sqrt{\\lambda'}} \\sum_{j=1}^{M} w_j \\sigma_j = N_{\\text{tot}}\n$$\n解出 $\\sqrt{\\lambda'}$ 得到：\n$$\n\\sqrt{\\lambda'} = \\frac{\\sum_{j=1}^{M} w_j \\sigma_j}{N_{\\text{tot}}}\n$$\n最后，我们将其代回到 $n_j$ 的表达式中，以找到最优分配 $n_j^\\star$：\n$$\nn_j^\\star = \\frac{w_j \\sigma_j}{\\left( \\frac{\\sum_{k=1}^{M} w_k \\sigma_k}{N_{\\text{tot}}} \\right)} = N_{\\text{tot}} \\frac{w_j \\sigma_j}{\\sum_{k=1}^{M} w_k \\sigma_k}\n$$\n这就是最优分配的闭式表达式。\n\n现在，我们针对给定的数值情况计算这个表达式：\n$M=4$， $N_{\\text{tot}} = 115000$。\n权重为 $w_1 = 1$，$w_2 = 2$，$w_3 = \\frac{1}{2}$，$w_4 = \\frac{3}{2}$。\n方差为 $\\sigma_1^2 = 4$，$\\sigma_2^2 = 1$，$\\sigma_3^2 = 9$，$\\sigma_4^2 = 16$。\n首先，计算标准差 $\\sigma_i = \\sqrt{\\sigma_i^2}$：\n$\\sigma_1 = \\sqrt{4} = 2$\n$\\sigma_2 = \\sqrt{1} = 1$\n$\\sigma_3 = \\sqrt{9} = 3$\n$\\sigma_4 = \\sqrt{16} = 4$\n\n接下来，计算乘积 $w_i \\sigma_i$：\n$w_1 \\sigma_1 = 1 \\times 2 = 2$\n$w_2 \\sigma_2 = 2 \\times 1 = 2$\n$w_3 \\sigma_3 = \\frac{1}{2} \\times 3 = \\frac{3}{2}$\n$w_4 \\sigma_4 = \\frac{3}{2} \\times 4 = 6$\n\n然后，计算分母中的和：\n$$\n\\sum_{k=1}^{4} w_k \\sigma_k = 2 + 2 + \\frac{3}{2} + 6 = 10 + \\frac{3}{2} = \\frac{23}{2}\n$$\n现在我们可以计算每个单元的最优分配：\n$$\nn_i^\\star = N_{\\text{tot}} \\frac{w_i \\sigma_i}{\\sum_{k=1}^{4} w_k \\sigma_k} = 115000 \\frac{w_i \\sigma_i}{23/2} = \\frac{2 \\times 115000}{23} (w_i \\sigma_i) = 10000 (w_i \\sigma_i)\n$$\n$n_1^\\star = 10000 \\times (w_1 \\sigma_1) = 10000 \\times 2 = 20000$\n$n_2^\\star = 10000 \\times (w_2 \\sigma_2) = 10000 \\times 2 = 20000$\n$n_3^\\star = 10000 \\times (w_3 \\sigma_3) = 10000 \\times \\frac{3}{2} = 15000$\n$n_4^\\star = 10000 \\times (w_4 \\sigma_4) = 10000 \\times 6 = 60000$\n\n得到的分配向量是 $(n_1^\\star, n_2^\\star, n_3^\\star, n_4^\\star) = (20000, 20000, 15000, 60000)$。\n我们来检查预算约束：$20000 + 20000 + 15000 + 60000 = 115000 = N_{\\text{tot}}$。约束得到满足，且这些值是精确的整数。", "answer": "$$\n\\boxed{\\begin{pmatrix} 20000 & 20000 & 15000 & 60000 \\end{pmatrix}}\n$$", "id": "3523263"}]}