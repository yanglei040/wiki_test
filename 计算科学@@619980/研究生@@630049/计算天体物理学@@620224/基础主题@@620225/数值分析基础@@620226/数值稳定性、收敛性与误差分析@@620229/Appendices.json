{"hands_on_practices": [{"introduction": "掌握数值方法不仅需要理论知识，更需要在实践中加深理解。本章的第一个练习将从误差的最基本来源——计算机算术的有限精度——入手。我们将通过一个具体案例，探讨灾难性抵消（catastrophic cancellation）这一常见陷阱，展示一个数学上完全正确的公式如何在实际计算中得出灾难性的错误结果，以及如何通过简单的等价变换来恢复其数值稳定性。[@problem_id:3527080]", "problem": "在高精度引力波模板生成和弱引力透镜图合成中，小角度三角函数组合经常出现，若在浮点运算中直接计算，可能会遭受灾难性抵消。考虑函数 $f(x) = \\frac{1 - \\cos x}{x^{2}}$ 在小角度 $x = 10^{-8}$ 弧度处的值。假设运算遵循电气和电子工程师协会 (IEEE) 754 标准，采用 binary64 双精度浮点数，舍入方式为“舍入到最近，偶数优先”，且基本函数均被正确舍入。\n\n从三角函数的基本级数展开和标准浮点舍入模型出发，分析按原样计算 $f(x)$ 的数值稳定性。具体来说：\n\n1.  利用 $\\cos x$ 的泰勒级数和 IEEE 754 双精度的性质，量化在 $x = 10^{-8}$ 处直接计算 $f(x)$ 时，由于 $1 - \\cos x$ 中的相减抵消所造成的有效数字损失。\n2.  构造一个在数学上与 $f(x)$ 等价的重构形式，该形式能避免相减抵消，并且对于小 $x$ 值是数值稳定的。从第一性原理证明其稳定性。\n3.  在标准模型 $\\operatorname{fl}(a \\circ b) = (a \\circ b)(1 + \\delta)$（其中对于每个基本运算 $\\circ$，都有 $|\\delta| \\leq u$，$u$ 是 binary64 双精度的单位舍入误差）下，为您重构的表达式推导一个前向相对误差界。对基本函数的求值也做类似处理，即将其视为一个单一的、正确舍入的步骤。\n4.  通过在 $x = 10^{-8}$ 处进行一次简短计算来验证该误差界。具体方法是：利用泰勒级数估计 $f(x)$ 的精确值，并将其与您的浮点模型分析所隐含的计算值进行比较。利用此结果估计稳定重构形式的观测相对误差大小，并检查其与您推导的误差界的一致性。\n\n报告您的最终量，即在这些假设下，于 $x = 10^{-8}$ 处直接计算 $f(x)$ 所得到的经验观测相对误差，以无单位小数形式表示。将您的最终答案四舍五入到四位有效数字。", "solution": "该问题要求对函数 $f(x) = \\frac{1 - \\cos x}{x^{2}}$ 在一个很小的 $x$ 值（具体为 $x = 10^{-8}$）下进行详细的数值分析。分析将按照题目要求分四部分进行。所有计算均假设采用 IEEE 754 双精度算术。\n\n首先，我将分析朴素计算的数值稳定性，量化有效数字的损失。其次，我将构造并论证该函数的一个数值稳定的重构形式。第三，将为这个稳定的重构形式推导一个前向相对误差界。最后，我将验证分析结果，并计算所要求的最终量，即朴素计算的观测相对误差。\n\n1. 朴素计算的数值稳定性\n\n函数由 $f(x) = \\frac{1 - \\cos x}{x^{2}}$ 给出。我们在 $x = 10^{-8}$ 处对其求值。对于小 $x$ 值，这种朴素公式的主要误差来源是分子中的减法 $1 - \\cos x$。\n\n$\\cos x$ 在 $x=0$ 附近的泰勒级数展开为：\n$$\n\\cos x = 1 - \\frac{x^{2}}{2!} + \\frac{x^{4}}{4!} - \\frac{x^{6}}{6!} + \\mathcal{O}(x^{8})\n$$\n对于 $x = 10^{-8}$，$\\cos x$ 的值为：\n$$\n\\cos(10^{-8}) = 1 - \\frac{(10^{-8})^{2}}{2} + \\frac{(10^{-8})^{4}}{24} - \\dots = 1 - 5 \\times 10^{-17} + \\frac{1}{24} \\times 10^{-32} - \\dots\n$$\n$\\cos(10^{-8})$ 的值非常接近 $1$。在 IEEE 754 双精度（binary64）中，一个浮点数用 $53$ 位的尾数存储。单位舍入误差为 $u = 2^{-53} \\approx 1.11022 \\times 10^{-16}$。在 $1$ 附近，可表示数之间的间隔是 $1$ 的机器ε，即 $\\epsilon_{1} = 2^{-52} \\approx 2.22044 \\times 10^{-16}$。\n\n一个实数 $y$ 会被舍入到最接近的可表示浮点数。平局决断规则是“向偶数舍入”，但这在这里不相关。一个位于两个可表示数 $a$ 和 $b$ 之间的数 $y$，如果 $|y-a|  |y-b|$，则舍入为 $a$。可表示数 $1$ 和 $1-\\epsilon_1 = 1-2^{-52}$ 之间的中点是 $1 - \\epsilon_1/2 = 1 - 2^{-53} = 1-u$。\n\n必须将 $\\cos(10^{-8})$ 的真实值与此中点进行比较，以确定其如何被舍入。真实值为 $c_{true} = \\cos(10^{-8}) \\approx 1 - 5 \\times 10^{-17}$。我们需要确定 $c_{true}$ 是大于还是小于中点 $1 - u \\approx 1 - 1.11 \\times 10^{-16}$。\n由于 $5 \\times 10^{-17}  1.11 \\times 10^{-16}$，因此 $1 - 5 \\times 10^{-17} > 1 - 1.11 \\times 10^{-16}$。所以，$\\cos(10^{-8})$ 的真实值位于区间 $(1-u, 1)$ 内。由于该值比 $1-\\epsilon_1$ 更接近 $1$，它被正确舍入为 $1$。\n因此，$\\operatorname{fl}(\\cos(10^{-8})) = 1$。\n\n然后，分子被计算为 $\\operatorname{fl}(1 - \\operatorname{fl}(\\cos(10^{-8}))) = \\operatorname{fl}(1 - 1) = 0$。\n分母为 $\\operatorname{fl}(x^2) = \\operatorname{fl}((10^{-8})^2) = \\operatorname{fl}(10^{-16})$，这是一个非零的浮点数。最终的计算结果是 $\\operatorname{fl}(0 / \\operatorname{fl}(10^{-16})) = 0$。\n\n$f(x)$ 的真实值可以从其泰勒级数中找到：\n$$\nf(x) = \\frac{1 - (1 - \\frac{x^{2}}{2} + \\frac{x^{4}}{24} - \\dots)}{x^{2}} = \\frac{1}{2} - \\frac{x^{2}}{24} + \\mathcal{O}(x^{4})\n$$\n对于 $x=10^{-8}$，真实值是 $f_{true} \\approx 1/2$。计算值为 $0$。这种现象称为灾难性抵消。对于 $y \\approx 1$ 的情况，减法 $1-y$ 会损失有效数字。在这种情况下，差值小于操作数相关的可用精度，导致减法结果的有效数字完全丧失。相对误差为 $|0 - (1/2)| / |1/2| = 1$，即 $100\\%$。该减法损失了大约 $-\\log_2(x^2/2) \\approx -\\log_2(5 \\times 10^{-17}) \\approx 54$ 比特的信息，而尾数中只有 $53$ 比特可用。\n\n2. 函数的稳定重构\n\n为避免 $1 - \\cos x$ 中的灾难性抵消，我们使用半角三角恒等式：\n$$\n1 - \\cos x = 2 \\sin^2\\left(\\frac{x}{2}\\right)\n$$\n将此代入 $f(x)$ 的表达式中：\n$$\nf(x) = \\frac{2 \\sin^2(x/2)}{x^{2}} = \\frac{2 \\sin^2(x/2)}{4(x/2)^{2}} = \\frac{1}{2} \\left( \\frac{\\sin(x/2)}{x/2} \\right)^2\n$$\n我们记 $y = x/2$。重构后的函数为 $f(x) = \\frac{1}{2} \\left( \\frac{\\sin y}{y} \\right)^2$。对于小的 $x$，这个公式是数值稳定的。\n\n其稳定性来源于避免了两个几乎相等的数相减。对于小 $y$，$\\sin y \\approx y$。对小自变量 $y$ 计算 $\\sin y$ 不涉及内部抵消，是一个良态运算。随后的除以 $y$ 的运算也是良态的。函数 $S(y) = \\frac{\\sin y}{y}$ 的条件数是 $\\kappa_S(y) = \\left| \\frac{y S'(y)}{S(y)} \\right| = |y \\cot y - 1|$。当 $y \\to 0$ 时，我们有 $y \\cot y \\approx y(\\frac{1}{y} - \\frac{y}{3}) = 1 - \\frac{y^2}{3}$，所以 $\\kappa_S(y) \\to 0$。计算 $S(y)$ 的问题对于小 $y$ 是内在良态的。由于重构算法使用稳定运算（除法、小自变量的正弦函数、平方）来计算这个良态函数，因此整个计算是稳定的。\n\n3. 稳定重构的前向相对误差界\n\n设稳定形式为 $g(y) = \\frac{1}{2} S(y)^2$，其中 $S(y) = \\frac{\\sin y}{y}$ 且 $y=x/2$。我们使用标准模型 $\\operatorname{fl}(a \\circ b) = (a \\circ b)(1+\\delta)$（其中 $|\\delta| \\leq u$）来分析误差传播。\n计算过程如下：\n1. $y_{fl} = (x/2)(1+\\delta_1)$\n2. $s_{fl} = \\sin(y_{fl})(1+\\delta_2)$\n3. $d_{fl} = (s_{fl}/y_{fl})(1+\\delta_3)$\n4. $q_{fl} = d_{fl}^2(1+\\delta_4)$\n5. $f_{fl} = (q_{fl}/2)(1+\\delta_5)$\n\n让 $\\hat{f}$ 表示计算值 $f_{fl}$。总相对误差为 $\\frac{\\hat{f} - f(x)}{f(x)}$。我们来追踪误差。\n$y=x/2$ 的相对误差是 $\\delta_y = \\delta_1$。\n$s = \\sin y$ 的相对误差是 $\\delta_s \\approx \\kappa_{\\sin}(y)\\delta_y + \\delta_2 = (y\\cot y)\\delta_1 + \\delta_2$。\n$d=s/y$ 的相对误差是 $\\delta_d \\approx \\delta_s - \\delta_y + \\delta_3 = ((y\\cot y)\\delta_1 + \\delta_2) - \\delta_1 + \\delta_3 = (y\\cot y - 1)\\delta_1 + \\delta_2 + \\delta_3$。\n项 $(y\\cot y - 1)$ 是 $S(y)$ 对 $y$ 中扰动的相对灵敏度，即 $-\\kappa_S(y)$（不带绝对值）。所以 $\\delta_d \\approx -\\kappa_S(y)\\delta_1 + \\delta_2 + \\delta_3$。\n$q=d^2$ 的相对误差是 $\\delta_q \\approx 2\\delta_d + \\delta_4 = 2(-\\kappa_S(y)\\delta_1 + \\delta_2 + \\delta_3) + \\delta_4$。\n$f=q/2$ 的最终相对误差是 $\\delta_f \\approx \\delta_q + \\delta_5 = -2\\kappa_S(y)\\delta_1 + 2\\delta_2 + 2\\delta_3 + \\delta_4 + \\delta_5$。\n\n取绝对值，总相对误差的界为：\n$$\n|\\delta_f| \\leq (2|\\kappa_S(y)| + 2 + 2 + 1 + 1)u = (2|y\\cot y - 1| + 6)u\n$$\n对于小 $y$，$|y\\cot y - 1| \\approx y^2/3$。对于 $x = 10^{-8}$，$y = 0.5 \\times 10^{-8}$。\n$|\\kappa_S(y)| \\approx \\frac{(0.5 \\times 10^{-8})^2}{3} = \\frac{0.25 \\times 10^{-16}}{3} \\approx 8.3 \\times 10^{-18}$。\n与 $6$ 相比，这一项可以忽略不计。因此，前向相对误差界大约为 $6u$。\n$|\\delta_f| \\lesssim 6u = 6 \\times 2^{-53} \\approx 6.66 \\times 10^{-16}$。\n\n4. 验证与最终答案计算\n\n首先，按要求，我们验证稳定重构形式的误差界。该界约为 $6u \\approx 6.66 \\times 10^{-16}$。稳定计算的观测相对误差预计在 $u$ 的量级，这与该界是一致的。$\\kappa_S(y)$ 的值很小，证实了该算法是稳定的，并且除了浮点运算本身固有的舍入误差外，引入的误差极小。\n\n现在，我们计算最终答案所需的量：在 $x = 10^{-8}$ 处朴素计算 $f(x)$ 的经验观测相对误差。\n“真实”值由泰勒级数估计：\n$$\nf_{true} = \\frac{1}{2} - \\frac{x^{2}}{24} + \\frac{x^{4}}{720} - \\dots = \\frac{1}{2} - \\frac{(10^{-8})^2}{24} + \\mathcal{O}(10^{-32}) = 0.5 - \\frac{10^{-16}}{24} + \\dots\n$$\n$f_{true} \\approx 0.5 - 4.166... \\times 10^{-18}$。\n\n使用朴素公式的计算值，如第 1 部分所确定的，是：\n$$\nf_{computed} = 0\n$$\n观测到的相对误差定义为 $\\frac{|f_{computed} - f_{true}|}{|f_{true}|}$。\n$$\n\\text{相对误差} = \\frac{|0 - (0.5 - 4.166... \\times 10^{-18})|}{|0.5 - 4.166... \\times 10^{-18}|} = \\frac{0.5 - 4.166... \\times 10^{-18}}{0.5 - 4.166... \\times 10^{-18}} = 1\n$$\n相对误差精确为 $1$。问题要求将此值四舍五入到四位有效数字。", "answer": "$$\n\\boxed{1.000}\n$$", "id": "3527080"}, {"introduction": "在解决了单步运算中的精度问题后，我们转向误差在多步积分中的累积效应，特别是在处理“刚性”（stiff）常微分方程组时遇到的挑战。天体物理学中的许多现象，如热弛豫或化学反应网络，都涉及跨越多个数量级的时间尺度，这正是刚性问题的典型特征。这个练习将对比经典的显式方法（如四阶龙格-库塔法）与隐式方法（如后向欧拉法），揭示在求解刚性问题时，数值稳定性和计算成本之间的关键权衡。[@problem_id:3527094]", "problem": "考虑一个与计算天体物理学相关的双模态热弛豫的线性自治常微分方程（ODE）模型，其状态向量 $\\mathbf{y}(t) = (y_1(t), y_2(t))^{\\top}$ 的演化遵循以下方程：\n$$\n\\frac{d\\mathbf{y}}{dt} = -\\Lambda \\mathbf{y}, \\quad \\Lambda = \\begin{pmatrix} \\lambda_1  0 \\\\ 0  \\lambda_2 \\end{pmatrix}, \\quad \\lambda_1 = 1, \\ \\lambda_2 = 10^{6},\n$$\n在有限时间区间 $t \\in [0,1]$ 上。假设初始数据为 $\\mathbf{y}(0) = (1,1)^{\\top}$，并测量慢分量 $y_1(t)$ 的绝对误差。\n\n你需要分析两种数值方法：使用均匀时间步长 $h_{\\mathrm{RK4}}$ 的显式经典四阶龙格－库塔方法（显式RK4），以及使用均匀时间步长 $h_{\\mathrm{IE}}$ 的隐式欧拉方法（也称为后向欧拉法）。\n\n任务：\n1. 应用于标量测试方程 $\\frac{dy}{dt} = -\\lambda y$ 的单步法的线性稳定性要求，推导对于给定的 $\\lambda_1$ 和 $\\lambda_2$，显式RK4方法为保持稳定所需的时间步长 $h_{\\mathrm{RK4}}$ 的限制条件。你的推导应基于这样一个事实：对于每个特征值，稳定性要求 $|R(-h \\lambda)| \\leq 1$，其中 $R(z)$ 是该方法的标量稳定性函数。\n2. 对于隐式欧拉法，推导在小 $h_{\\mathrm{IE}}$ 的极限下，保证绝对误差 $|y_1(1) - \\exp(-1)|$ 至多为目标容差 $\\varepsilon = 10^{-6}$ 的主阶渐近条件对 $h_{\\mathrm{IE}}$ 的要求。\n3. 在这些条件下，令 $N_{\\mathrm{RK4}} = 1/h_{\\mathrm{RK4}}$ 和 $N_{\\mathrm{IE}} = 1/h_{\\mathrm{IE}}$ 分别表示两种方法在 $[0,1]$ 区间上的均匀步数。定义计算成本比为 $C = N_{\\mathrm{RK4}}/N_{\\mathrm{IE}}$。使用在第1部分和第2部分中推导出的最紧凑的步长限制来计算 $C$。\n\n将 $C$ 的最终值四舍五入到三位有效数字。$C$ 无需单位。", "solution": "给定的常微分方程组为 $\\frac{d\\mathbf{y}}{dt} = -\\Lambda \\mathbf{y}$。由于矩阵 $\\Lambda$ 是对角矩阵，该系统代表了两个解耦的标量常微分方程：\n$$\n\\frac{dy_1}{dt} = -\\lambda_1 y_1 = -y_1\n$$\n$$\n\\frac{dy_2}{dt} = -\\lambda_2 y_2 = -10^6 y_2\n$$\n在初始条件 $\\mathbf{y}(0) = (1,1)^{\\top}$ 下，精确解为：\n$$\ny_1(t) = \\exp(-\\lambda_1 t) = \\exp(-t)\n$$\n$$\ny_2(t) = \\exp(-\\lambda_2 t) = \\exp(-10^6 t)\n$$\n该系统是刚性的，因为特征值 $\\lambda_1$ 和 $\\lambda_2$ 相差多个数量级 ($\\lambda_2/\\lambda_1 = 10^6$) 。分量 $y_2(t)$ 代表一个快速衰减的瞬态，而分量 $y_1(t)$ 代表一个慢衰减的模态。\n\n### 任务1：显式RK4的稳定性\n对于一个线性系统，如果数值解对于任何模态都不增长，则该数值方法是稳定的。这要求对于系统雅可比矩阵的每个特征值 $\\lambda$，步长 $h$ 必须满足 $|R(-h\\lambda)| \\leq 1$，其中 $R(z)$ 是该方法的稳定性函数。对于给定的系统，雅可比矩阵 $-\\Lambda$ 的特征值为 $-\\lambda_1 = -1$ 和 $-\\lambda_2 = -10^6$。\n\n显式RK4方法的稳定性函数是指数函数的四阶泰勒多项式：\n$$\nR(z) = 1 + z + \\frac{z^2}{2!} + \\frac{z^3}{3!} + \\frac{z^4}{4!}\n$$\n该条件必须对两个特征值都成立。我们来分析稳定性函数的自变量 $z = -h\\lambda$。\n对于 $\\lambda_1 = 1$，条件是 $|R(-h_{\\mathrm{RK4}})| \\le 1$。\n对于 $\\lambda_2 = 10^6$，条件是 $|R(-h_{\\mathrm{RK4}} \\cdot 10^6)| \\le 1$。\n\n由于 $\\lambda_2 \\gg \\lambda_1$，方法的稳定性受到与 $\\lambda_2$ 相关的较快模态的约束。自变量 $-h_{\\mathrm{RK4}}\\lambda_2$ 必须位于RK4方法的绝对稳定域内。对于负实数自变量 $z \\in \\mathbb{R}^{-}$，该区域为区间 $[-S_{\\mathrm{RK4}}, 0]$，其中 $S_{\\mathrm{RK4}} \\approx 2.785$ 是 $|R(-S)|=1$ 的解。\n因此，稳定性的条件是：\n$$\nh_{\\mathrm{RK4}} \\lambda_2 \\leq S_{\\mathrm{RK4}}\n$$\n为了找到最紧凑的步长限制，我们使用能确保稳定性的最大可能步长：\n$$\nh_{\\mathrm{RK4}} = \\frac{S_{\\mathrm{RK4}}}{\\lambda_2} = \\frac{2.785}{10^6} = 2.785 \\times 10^{-6}\n$$\n\n### 任务2：隐式欧拉法的精度\n隐式欧拉方法是A-稳定的，这意味着其绝对稳定域覆盖整个左半复平面。因此，对于任何 $h > 0$ 和 $\\lambda > 0$，都有 $|R(-h\\lambda)| = |1/(1+h\\lambda)|  1$。稳定性对步长 $h_{\\mathrm{IE}}$ 没有限制。步长仅受慢分量 $y_1(t)$ 的精度要求限制。\n\n对于第一个分量 $y_1'(t) = -\\lambda_1 y_1(t)$，隐式欧拉格式为：\n$$\n\\frac{y_{1,n+1} - y_{1,n}}{h_{\\mathrm{IE}}} = -\\lambda_1 y_{1,n+1} \\implies y_{1,n+1} = \\frac{y_{1,n}}{1 + h_{\\mathrm{IE}}\\lambda_1}\n$$\n经过 $N$ 步到达时间 $t = N h_{\\mathrm{IE}}$ 后，数值解为 $y_{1,N} = y_{1,0} (1 + h_{\\mathrm{IE}}\\lambda_1)^{-N}$。对于区间 $[0,1]$，我们有 $N = 1/h_{\\mathrm{IE}}$，$y_{1,0}=1$ 和 $\\lambda_1=1$。在 $t=1$ 时的数值解为：\n$$\ny_{1, \\text{num}}(1) = (1 + h_{\\mathrm{IE}})^{-1/h_{\\mathrm{IE}}}\n$$\n精确解为 $y_1(1) = \\exp(-1)$。绝对误差为 $|y_{1, \\text{num}}(1) - y_1(1)|$。对于小的 $h_{\\mathrm{IE}}$，我们可以分析此误差的主阶项。\n我们使用 $\\ln(1+x)$ 在 $x=0$ 附近的泰勒级数展开：$\\ln(1+x) = x - \\frac{x^2}{2} + O(x^3)$。\n\\begin{align*}\ny_{1, \\text{num}}(1) = (1 + h_{\\mathrm{IE}})^{-1/h_{\\mathrm{IE}}} = \\exp\\left(-\\frac{1}{h_{\\mathrm{IE}}} \\ln(1 + h_{\\mathrm{IE}})\\right) \\\\\n= \\exp\\left(-\\frac{1}{h_{\\mathrm{IE}}} \\left(h_{\\mathrm{IE}} - \\frac{h_{\\mathrm{IE}}^2}{2} + O(h_{\\mathrm{IE}}^3)\\right)\\right) \\\\\n= \\exp\\left(-1 + \\frac{h_{\\mathrm{IE}}}{2} + O(h_{\\mathrm{IE}}^2)\\right) \\\\\n= \\exp(-1) \\exp\\left(\\frac{h_{\\mathrm{IE}}}{2} + O(h_{\\mathrm{IE}}^2)\\right)\n\\end{align*}\n对于小的 $x$，使用展开式 $\\exp(x) = 1+x+O(x^2)$：\n$$\ny_{1, \\text{num}}(1) \\approx \\exp(-1) \\left(1 + \\frac{h_{\\mathrm{IE}}}{2}\\right)\n$$\n因此，在 $t=1$ 时的主阶全局误差为：\n$$\nE(h_{\\mathrm{IE}}) = y_{1, \\text{num}}(1) - \\exp(-1) \\approx \\frac{h_{\\mathrm{IE}}}{2} \\exp(-1)\n$$\n我们要求 $|E(h_{\\mathrm{IE}})| \\leq \\varepsilon = 10^{-6}$。\n$$\n\\frac{h_{\\mathrm{IE}}}{2} \\exp(-1) \\leq 10^{-6}\n$$\n求解最紧凑的限制（允许的最大步长）：\n$$\nh_{\\mathrm{IE}} = \\frac{2 \\times 10^{-6}}{\\exp(-1)} = 2e \\times 10^{-6}\n$$\n\n### 任务3：计算成本比\n每种方法在区间 $[0,1]$ 上积分所需的步数为 $N = 1/h$。\n$$\nN_{\\mathrm{RK4}} = \\frac{1}{h_{\\mathrm{RK4}}} = \\frac{1}{2.785 \\times 10^{-6}}\n$$\n$$\nN_{\\mathrm{IE}} = \\frac{1}{h_{\\mathrm{IE}}} = \\frac{1}{2e \\times 10^{-6}}\n$$\n计算成本比 $C$ 定义为 $C = N_{\\mathrm{RK4}}/N_{\\mathrm{IE}}$。\n$$\nC = \\frac{N_{\\mathrm{RK4}}}{N_{\\mathrm{IE}}} = \\frac{1/h_{\\mathrm{RK4}}}{1/h_{\\mathrm{IE}}} = \\frac{h_{\\mathrm{IE}}}{h_{\\mathrm{RK4}}}\n$$\n代入推导出的步长：\n$$\nC = \\frac{2e \\times 10^{-6}}{2.785 \\times 10^{-6}} = \\frac{2e}{2.785}\n$$\n使用值 $e \\approx 2.71828$：\n$$\nC \\approx \\frac{2 \\times 2.71828}{2.785} \\approx \\frac{5.43656}{2.785} \\approx 1.952086...\n$$\n四舍五入到三位有效数字，我们得到 $C \\approx 1.95$。此结果表明，对于给定的精度要求，由于刚性分量施加的严格稳定性约束，显式RK4方法所需的步数大约是隐式欧拉方法的两倍。", "answer": "$$\n\\boxed{1.95}\n$$", "id": "3527094"}, {"introduction": "最后，我们将从常微分方程（ODE）过渡到偏微分方程（PDE），这是描述天体物理中流体动力学和磁流体力学（MHD）的基本语言。数值格式不仅是对真实解的近似，它们本身也会引入非物理行为，其中最主要的是数值耗散（导致振幅衰减）和数值色散（导致相位误差）。这个练习将模拟一道线性的阿尔芬波（Alfvén wave），让你能够亲手测量一个数值格式的误差如何具体表现为波的振幅和相位的变化，从而将抽象的误差分析与可观测的模拟结果联系起来。[@problem_id:3527099]", "problem": "你需要实现一个自包含程序，该程序使用一阶有限体积法和 Courant–Friedrichs–Lewy (CFL) 数为 $0.8$ 的 Lax–Friedrichs (Rusanov) 数值通量，对一维线性阿尔芬波进行数值模拟。其目的是量化数值耗散（振幅衰减）和数值色散（相位延迟）作为空间分辨率的函数。\n\n物理模型是理想磁流体力学（MHD, Magnetohydrodynamics）的线性化阿尔芬子系统，采用无量纲单位，并将真空磁导率设为1。设 $x \\in [0,L)$，具有周期性边界条件。对于与 $x$ 轴对齐的恒定背景密度 $\\rho_0$ 和恒定背景磁场 $B_0$，横向扰动 $(v_y,B_y)$ 的解耦线性阿尔芬子系统可以写成守恒形式\n$$\n\\partial_t \\mathbf{U} + \\partial_x \\mathbf{F}(\\mathbf{U}) = 0,\\quad \\mathbf{U} =\n\\begin{bmatrix}\nv_y \\\\\nB_y\n\\end{bmatrix},\\quad\n\\mathbf{F}(\\mathbf{U}) =\n\\begin{bmatrix}\n- (B_0/\\rho_0)\\, B_y \\\\\n- B_0\\, v_y\n\\end{bmatrix}.\n$$\n特征速度为 $\\lambda = \\pm v_A$，其中阿尔芬速度 $v_A = B_0/\\sqrt{\\rho_0}$。\n\n通过选择以下方式，初始化一个波数为 $k = 2\\pi/L$ 的右行单色模式\n$$\nv_y(x,0) = A \\sin(k x),\\quad B_y(x,0) = -\\sqrt{\\rho_0}\\, v_y(x,0),\n$$\n这对应于右行阿尔芬本征模式。精确解保持振幅不变且无失真地传播：\n$$\nv_y(x,t) = A \\sin(k (x - v_A t)),\\quad B_y(x,t) = -\\sqrt{\\rho_0}\\, v_y(x,t).\n$$\n\n数值方法和参数：\n- 使用一个包含 $N$ 个单元的均匀网格，单元中心为 $x_i = (i+1/2)\\,\\Delta x$，其中 $i=0,\\dots,N-1$，$\\Delta x = L/N$。\n- 使用一阶有限体积更新\n$$\n\\mathbf{U}_i^{n+1} = \\mathbf{U}_i^n - \\frac{\\Delta t}{\\Delta x}\\left(\\hat{\\mathbf{F}}_{i+1/2}^n - \\hat{\\mathbf{F}}_{i-1/2}^n\\right),\n$$\n其中施加周期性边界条件，Lax–Friedrichs (Rusanov) 界面通量为\n$$\n\\hat{\\mathbf{F}}_{i+1/2} = \\frac{1}{2}\\left(\\mathbf{F}(\\mathbf{U}_i) + \\mathbf{F}(\\mathbf{U}_{i+1})\\right) - \\frac{\\alpha}{2}\\left(\\mathbf{U}_{i+1} - \\mathbf{U}_i\\right),\n$$\n且 $\\alpha = \\max|\\lambda| = v_A$。\n- 对于所有完整的时间步，通过 $\\Delta t = \\mathrm{CFL}\\,\\Delta x/\\alpha$ 强制 Courant–Friedrichs–Lewy (CFL) 数为 $0.8$。如果不能通过整数个完整步长精确达到最终时间 $T$，则采用一个最终步长 $\\Delta t_\\mathrm{final} \\le \\mathrm{CFL}\\,\\Delta x/\\alpha$ 以精确达到 $T$。\n- 使用区域长度 $L = 1$，背景参数 $\\rho_0 = 1$，$B_0 = 1$（因此 $v_A = 1$），振幅 $A = 10^{-3}$，以及最终时间 $T = 0.7$（无量纲单位）。\n\n测量和输出：\n- 设 $k = 2\\pi/L$。在推进到时间 $T$ 后，通过使用单元中心上的离散内积，将 $v_y(x,T)$ 投影到基 $\\{\\sin(k x), \\cos(k x)\\}$ 上，来计算数值振幅和相位。定义\n$$\na_s = \\frac{\\sum_{i=0}^{N-1} v_y(x_i,T)\\,\\sin(k x_i)}{\\sum_{i=0}^{N-1} \\sin^2(k x_i)},\\quad\na_c = \\frac{\\sum_{i=0}^{N-1} v_y(x_i,T)\\,\\cos(k x_i)}{\\sum_{i=0}^{N-1} \\cos^2(k x_i)}.\n$$\n则数值振幅和相位为\n$$\nA_\\mathrm{num} = \\sqrt{a_s^2 + a_c^2},\\quad \\phi_\\mathrm{num} = \\mathrm{atan2}(a_c, a_s).\n$$\n精确相位为 $\\phi_\\mathrm{exact} = -k v_A T$。定义振幅比和相位误差为\n$$\nR = \\frac{A_\\mathrm{num}}{A},\\quad \\Delta\\phi = \\mathrm{wrap}_{(-\\pi,\\pi]}\\left(\\phi_\\mathrm{num} - \\phi_\\mathrm{exact}\\right),\n$$\n其中 $\\mathrm{wrap}_{(-\\pi,\\pi]}(\\cdot)$ 将角度包裹到 $(-\\pi,\\pi]$ 区间内。以弧度报告 $\\Delta\\phi$。\n\n测试套件：\n- 模拟并报告以下网格分辨率 $N \\in \\{32, 64, 128, 256\\}$ 的 $(R,\\Delta\\phi)$。\n- 使用固定参数 $L = 1$，$\\rho_0 = 1$，$B_0 = 1$，$A = 10^{-3}$，$T = 0.7$，$\\mathrm{CFL} = 0.8$。\n\n最终输出格式：\n- 你的程序应生成单行输出，包含一个由四个双元素列表组成的列表，每个内部列表是对应一个 $N$ 的 $[R,\\Delta\\phi]$，顺序为 $N=32$，$N=64$，$N=128$，$N=256$。\n- 单行输出必须格式化为用逗号分隔、不含空格的列表，并用方括号括起来。例如：\"[[R32,phi32],[R64,phi64],[R128,phi128],[R256,phi256]]\"。\n- $R$ 和 $\\Delta\\phi$ 必须是浮点数。以弧度（无量纲）报告 $\\Delta\\phi$，R 作为无量纲比率报告。\n\n本问题中所有量均为无量纲；无需物理单位。角度必须以弧度为单位。", "solution": "我们考虑理想磁流体力学（MHD, Magnetohydrodynamics）中关于密度为 $\\rho_0$、磁场 $B_0$ 沿 $x$ 方向的均匀态的一维线性化阿尔芬子系统。在横向变量 $\\mathbf{U} = [v_y, B_y]^T$ 中，系统\n$$\n\\partial_t \\mathbf{U} + \\partial_x \\mathbf{F}(\\mathbf{U}) = 0,\\quad\n\\mathbf{F}(\\mathbf{U}) = \\begin{bmatrix}\n- (B_0/\\rho_0) B_y \\\\\n- B_0 v_y\n\\end{bmatrix}\n$$\n具有常系数雅可比矩阵 $\\mathbf{A} = \\partial \\mathbf{F}/\\partial \\mathbf{U} = \\begin{bmatrix} 0  -B_0/\\rho_0 \\\\ -B_0  0 \\end{bmatrix}$，其特征值为 $\\lambda = \\pm v_A$，其中阿尔芬速度是 $v_A = B_0/\\sqrt{\\rho_0}$。右行特征向量满足 $B_y = -\\sqrt{\\rho_0}\\, v_y$，左行特征向量满足 $B_y = +\\sqrt{\\rho_0}\\, v_y$。\n\n我们将波数为 $k = 2\\pi/L$ 的右行单傅里叶模式初始化为\n$$\nv_y(x,0) = A \\sin(k x),\\quad B_y(x,0) = -\\sqrt{\\rho_0}\\, v_y(x,0),\n$$\n这是系统的一个本征模式。精确解保持振幅不变，并以速度 $v_A$ 平移：\n$$\nv_y(x,t) = A \\sin(k (x - v_A t)),\\quad B_y(x,t) = -\\sqrt{\\rho_0}\\, v_y(x,t).\n$$\n\n我们在空间上对一个包含 $N$ 个单元的均匀网格进行离散，单元中心为 $x_i = (i+1/2)\\,\\Delta x$，其中 $i=0,\\dots,N-1$，$\\Delta x = L/N$。一阶有限体积法通过以下方式更新单元平均值\n$$\n\\mathbf{U}_i^{n+1} = \\mathbf{U}_i^n - \\frac{\\Delta t}{\\Delta x}\\left(\\hat{\\mathbf{F}}_{i+1/2}^n - \\hat{\\mathbf{F}}_{i-1/2}^n\\right),\n$$\n其中强制施加周期性边界条件，$\\hat{\\mathbf{F}}_{i+1/2}$ 是 Lax–Friedrichs (Rusanov) 数值通量\n$$\n\\hat{\\mathbf{F}}_{i+1/2} = \\frac{1}{2}\\left(\\mathbf{F}(\\mathbf{U}_i) + \\mathbf{F}(\\mathbf{U}_{i+1})\\right) - \\frac{\\alpha}{2}\\left(\\mathbf{U}_{i+1} - \\mathbf{U}_i\\right),\\quad \\alpha = \\max|\\lambda| = v_A.\n$$\n时间步进使用 Courant–Friedrichs–Lewy (CFL) 数 $\\mathrm{CFL} = 0.8$，即对于所有完整步长 $\\Delta t = \\mathrm{CFL}\\,\\Delta x/\\alpha$，如果需要，再加上一个最终的较短步长以精确达到 $T$。\n\n由于初始条件是单个右行本征模式，当投影到右特征向量上时，该系统有效地简化为以速度 $a = v_A$ 平流一个标量波。对于标量线性平流方程 $u_t + a u_x = 0$，使用常数 $\\alpha = |a|$ 的 Lax–Friedrichs (Rusanov) 更新可以写成\n$$\nu_j^{n+1} = u_j^n - \\frac{a \\Delta t}{2\\Delta x}(u_{j+1}^n - u_{j-1}^n) + \\frac{\\alpha \\Delta t}{2\\Delta x}(u_{j+1}^n - 2 u_j^n + u_{j-1}^n).\n$$\n通过对 $u_{j\\pm 1}^n$ 和 $u_j^{n+1}$ 进行泰勒展开得到的修正方程分析表明，在 $\\Delta x$ 的主导阶上，\n$$\nu_t + a u_x = D\\, u_{xx} + \\mathcal{O}(\\Delta x^2),\\quad D = \\frac{1}{2}\\left(\\alpha \\Delta x - a^2 \\Delta t\\right).\n$$\n当 $\\alpha = |a|$ 且 $\\Delta t = \\mathrm{CFL}\\,\\Delta x/\\alpha$ 时，这简化为\n$$\nD = \\frac{|a|\\,\\Delta x}{2}\\left(1 - \\mathrm{CFL}\\right).\n$$\n因此，对于单个傅里叶模式 $u \\propto \\sin(k x)$，振幅近似按 $\\exp(- D k^2 t)$ 衰减，揭示了由 $1 - \\mathrm{CFL}$ 控制的、与 $\\Delta x$ 呈线性的耗散误差。此外，修正方程中的高阶项在左侧包含一个 $(a/6)\\,\\Delta x^2\\, u_{xxx}$ 形式的色散项，这意味着有效的数值相速度为\n$$\nc_\\mathrm{num} \\approx a\\left(1 - \\frac{(k \\Delta x)^2}{6}\\right)\n$$\n对于小的 $k \\Delta x$。因此，在时间 $T$ 之后，相位误差的行为如下\n$$\n\\Delta \\phi \\equiv (\\phi_\\mathrm{num} - \\phi_\\mathrm{exact}) \\approx \\left(c_\\mathrm{num} - a\\right) k T \\approx -\\frac{a}{6}\\, k^3\\, \\Delta x^2\\, T,\n$$\n对于固定的 $k$ 和 $T$，这是 $\\Delta x$ 的二阶项。\n\n在我们的具体设置中，我们选择 $L = 1$，$\\rho_0 = 1$，$B_0 = 1$，因此 $v_A = 1$，且 $k = 2\\pi/L = 2\\pi$。我们设置 $A = 10^{-3}$ 和 $T = 0.7$。对于每个 $N \\in \\{32, 64, 128, 256\\}$，算法流程如下：\n1. 计算 $\\Delta x = L/N$ 和 $\\Delta t = \\mathrm{CFL}\\,\\Delta x/\\alpha$，其中 $\\mathrm{CFL} = 0.8$，$\\alpha = v_A = 1$。\n2. 在单元中心 $x_i = (i+1/2)\\,\\Delta x$ 处，使用 $v_y(x,0) = A \\sin(k x)$ 和 $B_y(x,0) = -\\sqrt{\\rho_0}\\, v_y(x,0)$ 初始化 $\\mathbf{U}_i^0$。\n3. 通过重复应用使用 Lax–Friedrichs 通量的有限体积更新来推进时间，并使用一个最终的较短步长，使累计时间恰好等于 $T$。\n4. 使用投影来测量 $v_y(x,T)$ 的数值振幅和相位\n$$\na_s = \\frac{\\sum_i v_y(x_i,T)\\,\\sin(k x_i)}{\\sum_i \\sin^2(k x_i)},\\quad\na_c = \\frac{\\sum_i v_y(x_i,T)\\,\\cos(k x_i)}{\\sum_i \\cos^2(k x_i)},\n$$\n然后计算\n$$\nA_\\mathrm{num} = \\sqrt{a_s^2 + a_c^2},\\quad \\phi_\\mathrm{num} = \\mathrm{atan2}(a_c,a_s).\n$$\n5. 计算精确相位 $\\phi_\\mathrm{exact} = -k v_A T$ 并定义振幅比和相位误差\n$$\nR = \\frac{A_\\mathrm{num}}{A},\\quad \\Delta\\phi = \\mathrm{wrap}_{(-\\pi,\\pi]}\\left(\\phi_\\mathrm{num} - \\phi_\\mathrm{exact}\\right).\n$$\n\n解释：\n- 耗散：Lax–Friedrichs 格式引入了一个主导阶的扩散系数 $D = \\frac{1}{2} v_A \\Delta x (1 - \\mathrm{CFL})$。对于我们的 $\\mathrm{CFL} = 0.8$ 和 $v_A = 1$，$D = 0.1\\,\\Delta x$。因此，振幅比应近似遵循 $R \\approx \\exp(- D k^2 T) = \\exp(-0.1\\, k^2\\, \\Delta x\\, T)$，当 $\\Delta x \\to 0$ 时，该值线性趋近于 $1$。\n- 色散：相速度误差是 $\\mathcal{O}(\\Delta x^2)$ 阶的，这意味着对于 $a = v_A = 1$ 的右行模式，$\\Delta \\phi \\sim -\\frac{1}{6} k^3 \\Delta x^2 T$。因此，将分辨率加倍（即 $\\Delta x$ 减半）应使 $\\Delta \\phi$ 的量级大约减小 4 倍。\n\n该程序实现了这个求解器，并为指定的 $N$ 值输出格式化为包含四个 $[R,\\Delta\\phi]$ 对（以弧度为单位）的单行列表，不含空格，从而实现自动验证。报告的量是无量纲的，角度以弧度为单位。", "answer": "```python\nimport numpy as np\n\ndef rusanov_flux(U, F, alpha):\n    \"\"\"\n    Compute Rusanov (Lax–Friedrichs) numerical flux at all interfaces for a 1D periodic grid.\n    U: array shape (m, N), conservative variables in each cell.\n    F: array shape (m, N), physical flux in each cell.\n    alpha: scalar, maximum wavespeed (constant).\n    Returns: array shape (m, N), numerical flux at interfaces i+1/2 stored at index i.\n    \"\"\"\n    U_right = np.roll(U, -1, axis=1)\n    F_right = np.roll(F, -1, axis=1)\n    return 0.5 * (F + F_right) - 0.5 * alpha * (U_right - U)\n\ndef simulate_linear_alfven(N, L=1.0, rho0=1.0, B0=1.0, A=1e-3, T=0.7, CFL=0.8):\n    \"\"\"\n    Simulate the linear Alfvén subsystem with Rusanov flux on N cells and measure amplitude ratio and phase error.\n    Returns: (R, dphi) where R = A_num/A and dphi is the wrapped phase error in radians.\n    \"\"\"\n    # Constants and grid\n    vA = B0 / np.sqrt(rho0)\n    alpha = vA\n    dx = L / N\n    k = 2.0 * np.pi / L\n\n    # Cell centers\n    i = np.arange(N)\n    x = (i + 0.5) * dx\n\n    # Initial condition: right-going eigenmode (By = -sqrt(rho0) * vy)\n    vy0 = A * np.sin(k * x)\n    By0 = -np.sqrt(rho0) * vy0\n\n    # State vector U = [vy, By]\n    U = np.vstack([vy0, By0])\n\n    # Time step control\n    dt_full = CFL * dx / alpha\n    t = 0.0\n\n    # Advance in time\n    while t + dt_full  T - 1e-15:\n        # Physical flux F(U) = [-(B0/rho0) * By, -B0 * vy]\n        F = np.vstack([-(B0 / rho0) * U[1], -B0 * U[0]])\n        # Numerical flux at interfaces\n        F_half = rusanov_flux(U, F, alpha)\n        # Update U\n        U = U - (dt_full / dx) * (F_half - np.roll(F_half, 1, axis=1))\n        t += dt_full\n\n    # Final partial step to hit exactly T\n    dt_last = T - t\n    if dt_last > 1e-15:\n        F = np.vstack([-(B0 / rho0) * U[1], -B0 * U[0]])\n        F_half = rusanov_flux(U, F, alpha)\n        U = U - (dt_last / dx) * (F_half - np.roll(F_half, 1, axis=1))\n        t += dt_last\n\n    # Sanity: ensure we reached T\n    # Measure amplitude and phase using projection onto sin(kx), cos(kx)\n    vy = U[0]\n    s = np.sin(k * x)\n    c = np.cos(k * x)\n    s_norm = np.dot(s, s)\n    c_norm = np.dot(c, c)\n\n    # Avoid division by zero (should not happen for N >= 2)\n    a_s = float(np.dot(vy, s) / s_norm) if s_norm > 0 else 0.0\n    a_c = float(np.dot(vy, c) / c_norm) if c_norm > 0 else 0.0\n\n    A_num = np.hypot(a_s, a_c)\n    phi_num = np.arctan2(a_c, a_s)\n\n    # Exact phase at time T\n    phi_exact = -k * vA * T\n\n    # Wrap phase error into (-pi, pi]\n    dphi = phi_num - phi_exact\n    dphi = (dphi + np.pi) % (2.0 * np.pi) - np.pi\n\n    R = A_num / A\n    return R, dphi\n\ndef solve():\n    # Define the test cases: resolutions N\n    test_cases = [32, 64, 128, 256]\n\n    results = []\n    for N in test_cases:\n        R, dphi = simulate_linear_alfven(N=N, L=1.0, rho0=1.0, B0=1.0, A=1e-3, T=0.7, CFL=0.8)\n        results.append((R, dphi))\n\n    # Format output: list of [R, dphi] with no spaces\n    def fmt_float(x):\n        # 12 significant digits is a reasonable compromise\n        return f\"{x:.12g}\"\n\n    inner = \",\".join(f\"[{fmt_float(r)},{fmt_float(p)}]\" for r, p in results)\n    print(f\"[{inner}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```", "id": "3527099"}]}