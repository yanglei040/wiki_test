{"hands_on_practices": [{"introduction": "本实践旨在搭建有限元法（FEM）与有限差分法（FDM）之间的基础桥梁。通过对一个简单的一维扩散问题同时使用标准的线性“帽子”函数作为试探函数和检验函数，你将看到抽象的伽辽金法如何具体地重现出著名的三点式有限差分格式。这项练习对于建立直观认识、将有限元法与更熟悉的数值概念联系起来从而揭开其神秘面纱至关重要 [@problem_id:3337463]。", "problem": "考虑从有界区间上扩散通量守恒推导出的具有齐次狄利克雷边界条件的一维稳态扩散模型：寻找一个函数 $u$ 使得在 $(0,L)$ 上有 $- \\dfrac{d}{dx} \\left( \\nu \\dfrac{du}{dx} \\right) = s(x)$，且满足 $u(0) = 0$ 和 $u(L) = 0$，其中 $\\nu > 0$ 是一个常数扩散系数，$s(x)$ 是一个给定的源项。设该区间被剖分为 $N$ 个均匀子区间，节点为 $\\{x_i\\}_{i=0}^{N}$，网格间距为 $h = L/N$，并使用与节点 $\\{x_i\\}$ 相关联的标准线性帽状基函数 $\\{\\phi_i\\}$。使用伽辽金有限元法 (FEM)，其试验空间和测试空间由满足本质边界条件的帽状函数张成，按以下步骤进行。\n\n从强形式乘以一个测试函数并进行分部积分得到的弱形式出发，通过对限制在单个单元 $e = [x_{i-1}, x_i]$ 上的帽状函数导数的乘积进行积分，计算以 $\\nu$ 和 $h$ 表示的单元级双线性形式贡献。组装这些单元贡献，得到与内部节点 $i$ 相关联的离散方程，该方程用未知节点值 $u_{i-1}$、$u_i$ 和 $u_{i+1}$ 以及在测试函数 $\\phi_i$ 处求值的载荷泛函表示。\n\n然后，特化为常数源 $s(x) = s_0$（其中 $s_0$ 为常数），并计算标量 $m_i = \\int_{0}^{L} \\phi_i(x)\\,dx$。将组装后的 FEM 方程除以 $m_i$，得到节点 $i$ 处的逐点形式，该形式可以直接与相同强形式的二阶中心有限差分 (FD) 离散化进行比较。通过这种方式，确定节点 $i$ 处左侧的三点格式系数，顺序为 $(i-1,i,i+1)$，并表示为仅含 $\\nu$ 和 $h$ 的闭式函数。\n\n将你的最终答案以单个行向量的形式报告，其中包含这三个系数，顺序为 $(i-1,i,i+1)$。不要包含任何单位。不要提供中间结果。最终答案必须是闭式解析表达式。", "solution": "我们从强形式 $- \\dfrac{d}{dx} \\left( \\nu \\dfrac{du}{dx} \\right) = s(x)$ 及边界条件 $u(0)=0$ 和 $u(L)=0$ 开始。标准弱形式是通过乘以一个测试函数 $v \\in H_0^1(0,L)$ 并进行分部积分推导出来的，利用齐次本质边界条件消去边界项：\n$$\n\\int_{0}^{L} \\nu \\dfrac{du}{dx} \\dfrac{dv}{dx}\\,dx = \\int_{0}^{L} s(x)\\, v(x)\\,dx.\n$$\n在使用线性帽状函数 $\\{\\phi_i\\}$（在 $x=0$ 和 $x=L$ 处为零）的伽辽金有限元法 (FEM) 中，我们寻求一个近似解 $u_h = \\sum_{j=1}^{N-1} u_j \\phi_j$，并选择测试函数为 $v = \\phi_i$。内部节点 $i$ 的离散方程为\n$$\n\\sum_{j} \\left( \\int_{0}^{L} \\nu \\dfrac{d\\phi_j}{dx} \\dfrac{d\\phi_i}{dx}\\,dx \\right) u_j \\;=\\; \\int_{0}^{L} s(x)\\, \\phi_i(x)\\,dx.\n$$\n因为网格是均匀的，间距为 $h$，且基函数是紧支集函数，所以对节点 $i$ 对应的行有非零贡献的仅来自单元 $[x_{i-1},x_i]$ 和 $[x_i,x_{i+1}]$。\n\n在单个单元 $e=[x_{i-1},x_i]$ 上，局部基函数的限制为 $\\phi_{i-1}$ 和 $\\phi_i$。它们在单元 $e$ 上的导数是常数：$\\dfrac{d\\phi_{i-1}}{dx} = -\\dfrac{1}{h}$ 和 $\\dfrac{d\\phi_i}{dx} = \\dfrac{1}{h}$。对于 $r,s \\in \\{i-1,i\\}$，单元级双线性形式矩阵的元素 $a_{e,rs} = \\int_{e} \\nu \\dfrac{d\\phi_r}{dx}\\dfrac{d\\phi_s}{dx}\\,dx$ 为\n$$\na_{e,11} = \\int_{x_{i-1}}^{x_i} \\nu \\left(-\\dfrac{1}{h}\\right)\\left(-\\dfrac{1}{h}\\right) dx = \\nu \\dfrac{1}{h^2} h = \\dfrac{\\nu}{h}, \n$$\n$$\na_{e,12} = \\int_{x_{i-1}}^{x_i} \\nu \\left(-\\dfrac{1}{h}\\right)\\left(\\dfrac{1}{h}\\right) dx = - \\nu \\dfrac{1}{h^2} h = -\\dfrac{\\nu}{h},\n$$\n$$\na_{e,21} = \\int_{x_{i-1}}^{x_i} \\nu \\left(\\dfrac{1}{h}\\right)\\left(-\\dfrac{1}{h}\\right) dx = - \\dfrac{\\nu}{h}, \\quad\na_{e,22} = \\int_{x_{i-1}}^{x_i} \\nu \\left(\\dfrac{1}{h}\\right)\\left(\\dfrac{1}{h}\\right) dx = \\dfrac{\\nu}{h}.\n$$\n因此，在单元 $[x_{i-1},x_i]$ 上的单元矩阵为 $\\dfrac{\\nu}{h} \\begin{pmatrix} 1  -1 \\\\ -1  1 \\end{pmatrix}$。在单元 $[x_i,x_{i+1}]$ 上进行相同的计算，该单元上的局部基为 $\\{\\phi_i,\\phi_{i+1}\\}$，导数为 $\\dfrac{d\\phi_i}{dx} = -\\dfrac{1}{h}$ 和 $\\dfrac{d\\phi_{i+1}}{dx} = \\dfrac{1}{h}$，得到相同的 $2\\times 2$ 模式。\n\n从节点 $i$ 的两个相邻单元组装对全局行的贡献，得到刚度系数\n$$\nK_{i,i-1} = -\\dfrac{\\nu}{h}, \\qquad K_{i,i} = \\dfrac{\\nu}{h} + \\dfrac{\\nu}{h} = \\dfrac{2\\nu}{h}, \\qquad K_{i,i+1} = -\\dfrac{\\nu}{h}.\n$$\n因此，内部节点 $i$ 处的 FEM 离散方程为\n$$\n-\\dfrac{\\nu}{h} u_{i-1} + \\dfrac{2\\nu}{h} u_i - \\dfrac{\\nu}{h} u_{i+1} \\;=\\; f_i,\n$$\n其中载荷项为 $f_i = \\int_{0}^{L} s(x)\\, \\phi_i(x)\\,dx$。对于常数源 $s(x) = s_0$，这变为 $f_i = s_0 \\int_{0}^{L} \\phi_i(x)\\,dx$。\n\n我们现在计算标量 $m_i = \\int_{0}^{L} \\phi_i(x)\\,dx$。在具有线性帽状函数的均匀网格上，$\\phi_i$ 是一个支撑在 $[x_{i-1},x_{i+1}]$ 上的三角形，高为 $1$，底边长为 $2h$。其面积是两个底为 $h$ 高为 $1$ 的直角三角形面积之和，因此\n$$\nm_i = \\int_{x_{i-1}}^{x_{i}} \\phi_i(x)\\,dx + \\int_{x_{i}}^{x_{i+1}} \\phi_i(x)\\,dx = \\dfrac{1\\cdot h}{2} + \\dfrac{1\\cdot h}{2} = h.\n$$\n于是 $f_i = s_0\\, m_i = s_0\\, h$。将整个 FEM 方程除以 $m_i = h$ 得到节点 $i$ 处的逐点平衡：\n$$\n-\\dfrac{\\nu}{h^2} u_{i-1} + \\dfrac{2\\nu}{h^2} u_i - \\dfrac{\\nu}{h^2} u_{i+1} \\;=\\; s_0.\n$$\n该方程的左侧恰好是 $-\\nu \\dfrac{d^2 u}{dx^2}$ 的三点二阶中心有限差分 (FD) 格式，即 $\\nu \\dfrac{-u_{i-1} + 2u_i - u_{i+1}}{h^2}$。因此，按 $(i-1,i,i+1)$ 顺序的三点格式系数为\n$$\n\\left( -\\dfrac{\\nu}{h^2}, \\; \\dfrac{2\\nu}{h^2}, \\; -\\dfrac{\\nu}{h^2} \\right).\n$$\n这些系数仅依赖于 $\\nu$ 和 $h$，符合要求。", "answer": "$$\\boxed{\\begin{pmatrix}-\\dfrac{\\nu}{h^{2}}  \\dfrac{2\\nu}{h^{2}}  -\\dfrac{\\nu}{h^{2}}\\end{pmatrix}}$$", "id": "3337463"}, {"introduction": "从静态问题转向动态问题，本练习将探讨一维弹性波方程，这是计算地震学的基石。你将研究检验空间的内积（定义了检验范数）在时域和频域公式中的选择有何不同，以及这种选择如何与长期数值稳定性相关联。本实践将质量矩阵和刚度矩阵等抽象概念与最大稳定时间步长、频率相关的品质因子 $Q$ 等具体物理性质联系起来，展示了如何为分析波的传播与衰减而定制检验空间 [@problem_id:3617857]。", "problem": "考虑一维线性弹性问题，研究对象为一根长度为 $L$、横截面积为 $A$、质量密度为 $\\rho$、杨氏模量为 $E$ 的均匀杆。设 $u(x,t)$ 表示位移场，并采用固定的狄利克雷边界条件 $u(0,t)=0$ 和 $u(L,t)=0$。由基本线性动量平衡和本构关系可得其强形式\n$$\n\\rho A \\frac{\\partial^2 u}{\\partial t^2}(x,t) - \\frac{\\partial}{\\partial x}\\left(E A \\frac{\\partial u}{\\partial x}(x,t)\\right) = f(x,t),\n$$\n其中储存的弹性势能密度定义为 $E A\\,\\varepsilon(u)^2$（其中 $\\varepsilon(u)=\\partial_x u$），动能密度为 $\\rho A\\,(\\partial_t u)^2$。在角频率为 $\\omega$ 的时谐（频域）表达式中，需求解满足以下方程的 $u(x)$\n$$\n-\\omega^2 \\rho A\\,u(x) - \\frac{\\partial}{\\partial x}\\left(E A \\frac{\\partial u}{\\partial x}(x)\\right) = g(x),\n$$\n如果需要，可以通过有效模量来模拟复数值的能量储存和衰减。在时域表达式中，长时间的稳定性由动能和势能所诱导的能量范数控制。\n\n在一个包含 $N$ 个线性单元的均匀网格上对区间 $[0,L]$ 进行有限元近似，令 $V_h$ 表示试探函数空间（在 $x=0$ 和 $x=L$ 处为零的连续分段线性函数），并令 $W_h$ 表示检验函数空间。定义以下用于检验的对称正定内积：\n- 角频率为 $\\omega$ 的时谐能量内积，\n$$\n\\langle w_h,z_h\\rangle_{\\omega} := \\int_0^L E A\\,\\frac{\\mathrm{d} w_h}{\\mathrm{d} x}\\,\\frac{\\mathrm{d} z_h}{\\mathrm{d} x}\\,\\mathrm{d}x \\;+\\; \\omega^2 \\int_0^L \\rho A\\, w_h z_h\\,\\mathrm{d}x,\n$$\n它诱导了范数 $\\|u_h\\|_{\\omega}^2 := \\langle u_h,u_h\\rangle_{\\omega}$。\n- 具有特征角频率 $\\omega_c$ 的时域图能量内积，\n$$\n\\langle w_h,z_h\\rangle_{\\mathrm{td}} := \\int_0^L E A\\,\\frac{\\mathrm{d} w_h}{\\mathrm{d} x}\\,\\frac{\\mathrm{d} z_h}{\\mathrm{d} x}\\,\\mathrm{d}x \\;+\\; \\omega_c^2 \\int_0^L \\rho A\\, w_h z_h\\,\\mathrm{d}x,\n$$\n它诱导了范数 $\\|u_h\\|_{\\mathrm{td}}^2 := \\langle u_h,u_h\\rangle_{\\mathrm{td}}$。\n\n在矩阵形式中，这些内积对应于 $K+\\omega^2 M$ 和 $K+\\omega_c^2 M$，其中 $M$ 和 $K$ 是由均匀网格上的线性有限元基函数组装而成的标准一致质量矩阵和刚度矩阵。对于半离散系统 $M \\ddot{u}_h + K u_h = f_h$ 的显式时间积分，其长时间稳定性的一个充分条件是时间步长受最大无阻尼固有角频率的限制，即 $\\Delta t \\le \\frac{2}{\\sqrt{\\lambda_{\\max}}}$，其中 $\\lambda_{\\max}$ 是问题 $K \\phi = \\lambda M \\phi$ 的最大广义特征值。\n\n地球物理介质中的衰减通常用与频率相关的品质因子（Q）来表征。品质因子（Q）由关系式 $Q(\\omega)$ 定义，在小阻尼、单模态设置下，它满足 $Q(\\omega) \\approx \\frac{1}{2\\zeta(\\omega)}$，其中 $\\zeta(\\omega)$ 是模态阻尼比。在半离散设置中，一个实用的结构阻尼近似是使用瑞利阻尼 $C=\\alpha M+\\beta K$，这得到 $\\zeta(\\omega) = \\frac{\\alpha}{2\\omega} + \\frac{\\beta \\omega}{2}$。在频率 $\\omega$ 下，每个周期的能量衰减因子为 $\\exp\\!\\left(-\\frac{2\\pi}{Q(\\omega)}\\right)$。\n\n您的任务是：\n1. 为所描述的杆和网格组装一维线性有限元矩阵 $M$ 和 $K$。\n2. 从广义特征值问题 $K \\phi = \\lambda M \\phi$ 中计算出最大无阻尼角频率 $\\sqrt{\\lambda_{\\max}}$，以及相应的最大显式中心差分稳定时间步长 $\\Delta t_{\\max} = \\frac{2}{\\sqrt{\\lambda_{\\max}}}$（单位为秒）。\n3. 对于给定的强迫角频率 $\\omega_f$ 和选为最大无阻尼角频率的特征时域频率 $\\omega_c$（即 $\\omega_c = \\sqrt{\\lambda_{\\max}}$），计算检验范数的比率\n$$\nR := \\sup_{u_h \\neq 0} \\frac{\\|u_h\\|_{\\omega_f}}{\\|u_h\\|_{\\mathrm{td}}} \\;=\\; \\sqrt{\\lambda_{\\max}\\!\\left((K+\\omega_f^2 M,\\; K+\\omega_c^2 M)\\right)},\n$$\n其中 $\\lambda_{\\max}\\!\\left((A,B)\\right)$ 表示对称矩阵对 $(A,B)$ 的最大广义特征值。\n4. 对于给定的 $Q(\\omega)$ 定律，评估 $Q(\\omega_f)$ 并计算每个周期的能量衰减因子 $D := \\exp\\!\\left(-\\frac{2\\pi}{Q(\\omega_f)}\\right)$（无量纲）。\n\n将计算出的 $R$ 与稳定性联系起来：大的 $R$ 值表明，相对于按 $\\omega_c$ 缩放的时域图能量范数，$\\omega_f$ 处的时谐检验范数对高频分量的惩罚不足，这暗示除非阻尼（由 $Q(\\omega)$ 量化）能充分衰减那些模态，否则可能出现长时间的增长。\n\n物理单位必须按以下方式使用：$L$ 以米（$\\mathrm{m}$）为单位，$A$ 以平方米（$\\mathrm{m}^2$）为单位，$\\rho$ 以千克每立方米（$\\mathrm{kg/m^3}$）为单位，$E$ 以帕斯卡（$\\mathrm{Pa}$）为单位，角频率 $\\omega$ 以弧度每秒（$\\mathrm{rad/s}$）为单位，$\\Delta t_{\\max}$ 输出以秒（$\\mathrm{s}$）为单位。角度除了通过角频率外不直接使用；不涉及度。\n\n使用以下品质因子定律\n$$\nQ(\\omega) = Q_0 \\left(\\frac{\\omega}{\\omega_\\star}\\right)^{p},\n$$\n其中 $Q_0$、$\\omega_\\star$ 和 $p$ 是给定常数。作为瑞利阻尼及其与 $Q$ 关系的背景，您可以选择性地通过在两个频率 $\\omega_a=\\omega_f$ 和 $\\omega_b=2\\omega_f$ 处匹配 $Q(\\omega)$ 来计算 $(\\alpha,\\beta)$：\n$$\n\\frac{1}{Q(\\omega_a)} = \\frac{\\alpha}{\\omega_a} + \\beta \\,\\omega_a,\\qquad \\frac{1}{Q(\\omega_b)} = \\frac{\\alpha}{\\omega_b} + \\beta \\,\\omega_b,\n$$\n但您无需输出 $(\\alpha,\\beta)$。\n\n测试套件：\n提供以下三组参数以探究不同的机制。对于每种情况，组装 $M$ 和 $K$，计算 $\\Delta t_{\\max}$、$R$ 和 $D$。\n\n- 情况 1（中等频率，近似恒定的 $Q$）：\n  - $L = 1.0\\times 10^{3}\\ \\mathrm{m}$，$A = 1.0\\ \\mathrm{m}^2$，$\\rho = 2700\\ \\mathrm{kg/m^3}$，$E = 3.0\\times 10^{10}\\ \\mathrm{Pa}$，\n  - $N = 80$ 个单元，\n  - $\\omega_f = 2\\pi\\cdot 20\\ \\mathrm{rad/s}$，\n  - $Q_0 = 150$，$\\omega_\\star = 2\\pi\\cdot 10\\ \\mathrm{rad/s}$，$p=0$。\n- 情况 2（较高频率，随频率降低的 $Q$）：\n  - $L = 2.0\\times 10^{3}\\ \\mathrm{m}$，$A = 1.0\\ \\mathrm{m}^2$，$\\rho = 2500\\ \\mathrm{kg/m^3}$，$E = 5.0\\times 10^{10}\\ \\mathrm{Pa}$，\n  - $N = 120$ 个单元，\n  - $\\omega_f = 2\\pi\\cdot 50\\ \\mathrm{rad/s}$，\n  - $Q_0 = 80$，$\\omega_\\star = 2\\pi\\cdot 10\\ \\mathrm{rad/s}$，$p=0.25$。\n- 情况 3（低频率，高频处略微增加的 $Q$，由负 $p$ 表示）：\n  - $L = 1.0\\times 10^{3}\\ \\mathrm{m}$，$A = 1.0\\ \\mathrm{m}^2$，$\\rho = 2600\\ \\mathrm{kg/m^3}$，$E = 3.5\\times 10^{10}\\ \\mathrm{Pa}$，\n  - $N = 60$ 个单元，\n  - $\\omega_f = 2\\pi\\cdot 1\\ \\mathrm{rad/s}$，\n  - $Q_0 = 200$，$\\omega_\\star = 2\\pi\\cdot 1\\ \\mathrm{rad/s}$，$p=-0.2$。\n\n最终输出格式：\n您的程序应生成一行输出，其中包含用方括号括起来的逗号分隔的结果列表。每个测试用例的结果必须是按此顺序排列的三个浮点数列表 $[R,\\Delta t_{\\max},D]$，其中 $\\Delta t_{\\max}$ 的单位为秒。例如，输出应如下所示：\n$$\n[\\,[R_1,\\Delta t_{\\max,1},D_1],[R_2,\\Delta t_{\\max,2},D_2],[R_3,\\Delta t_{\\max,3},D_3]\\,].\n$$\n\n该问题要求您从基本定律和核心定义出发，推导相关的弱形式，将试探函数和检验函数的检验范数与能量原理联系起来，并为指定的测试套件实现计算。确保参数的科学真实性，并以指定的确切格式提供结果。", "solution": "我们从一维杆的线性动量基本平衡和 Hooke 定律开始。在狄利克雷边界条件 $u(0,t)=0$ 和 $u(L,t)=0$ 下，强形式\n$$\n\\rho A\\,\\frac{\\partial^2 u}{\\partial t^2}(x,t) - \\frac{\\partial}{\\partial x}\\left(E A\\,\\frac{\\partial u}{\\partial x}(x,t)\\right) = f(x,t)\n$$\n对于 $f\\in L^2(0,L)$ 是适定的。储存的弹性势能密度和动能密度分别为 $E A\\,\\varepsilon(u)^2$ 和 $\\rho A\\,(\\partial_t u)^2$，其中 $\\varepsilon(u)=\\partial_x u$。\n\n对于有限元方法，我们选择标准的试探函数空间 $V_h \\subset H^1_0(0,L)$，该空间由连续的分段线性函数组成，其节点基函数为 $\\{\\varphi_i\\}_{i=1}^{n}$，在 $x=0$ 和 $x=L$ 处为零，对于 $N$ 个单元有 $n=N-1$ 个内部自由度。检验函数空间 $W_h$ 取为 $V_h$（Galerkin 法），但配备了根据物理特性调整的内积（通过范数的 Petrov-Galerkin 法）。标准的双线性形式是\n$$\nm(w,z) := \\int_0^L \\rho A\\, w z\\,\\mathrm{d}x,\\qquad a(w,z) := \\int_0^L E A\\,\\frac{\\mathrm{d} w}{\\mathrm{d} x}\\,\\frac{\\mathrm{d} z}{\\mathrm{d} x}\\,\\mathrm{d}x.\n$$\n通过 $M_{ij}=m(\\varphi_i,\\varphi_j)$ 和 $K_{ij}=a(\\varphi_i,\\varphi_j)$，这些形式组装成质量矩阵 $M$ 和刚度矩阵 $K$。\n\n时域弱形式：将强形式乘以 $w_h\\in W_h$，分部积分，并强制施加本质边界条件，得到\n$$\nm(w_h,\\ddot{u}_h) + a(w_h,u_h) = \\ell(w_h),\n$$\n其中 $\\ell(w_h) := \\int_0^L w_h f\\,\\mathrm{d}x$。对于函数对 $(u_h,\\dot{u}_h)$ 的自然能量范数是\n$$\n\\|(u_h,\\dot{u}_h)\\|_{\\mathrm{energy}}^2 := a(u_h,u_h) + m(\\dot{u}_h,\\dot{u}_h),\n$$\n它保证了在无阻尼情况下的能量守恒和在有耗散情况下的单调衰减。当纯粹为残差最小化（例如在图范数的背景下）设计关于 $u_h$ 的检验范数时，会引入一个特征角频率 $\\omega_c$，它反映了半离散系统所支持的最快无阻尼动力学。一个一致的选择是 $\\omega_c := \\sqrt{\\lambda_{\\max}}$，其中 $\\lambda_{\\max}$ 是 $K \\phi = \\lambda M \\phi$ 的最大广义特征值；的确，$\\sqrt{\\lambda_{\\max}}$ 是半离散系统的最大无阻尼角频率。这导致了时域图能量内积\n$$\n\\langle w_h,z_h\\rangle_{\\mathrm{td}} := a(w_h,z_h) + \\omega_c^2\\, m(w_h,z_h),\n$$\n它对高频内容的惩罚与它在直到 $\\omega_c$ 的所有模态上的物理能量足迹成比例。\n\n时谐弱形式：在固定角频率 $\\omega$ 下，位移幅值 $u_h \\in V_h$ 满足\n$$\n-\\omega^2 m(w_h,u_h) + a(w_h,u_h) = \\ell_\\omega(w_h),\n$$\n其中 $\\ell_\\omega$ 代表时谐强迫。在没有阻尼的情况下，一个控制残差的自然能量内积是\n$$\n\\langle w_h,z_h\\rangle_{\\omega} := a(w_h,z_h) + \\omega^2\\, m(w_h,z_h),\n$$\n这有利于解析接近所选 $\\omega$ 的特征。\n\n范数比较：对于对称正定矩阵 $A$ 和 $B$，希尔伯特空间 $(\\mathbb{R}^n,\\langle\\cdot,\\cdot\\rangle_A)$ 和 $(\\mathbb{R}^n,\\langle\\cdot,\\cdot\\rangle_B)$ 之间的恒等映射的算子范数等于\n$$\n\\sup_{u\\neq 0} \\frac{\\|u\\|_A}{\\|u\\|_B} = \\sqrt{\\lambda_{\\max}(B^{-1}A)} = \\sqrt{\\lambda_{\\max}((A,B))},\n$$\n其中 $\\lambda_{\\max}((A,B))$ 是求解 $A v = \\lambda B v$ 的最大广义特征值。将此应用于 $A=K+\\omega_f^2 M$ 和 $B=K+\\omega_c^2 M$，我们得到比率\n$$\nR := \\sup_{u_h \\neq 0} \\frac{\\|u_h\\|_{\\omega_f}}{\\|u_h\\|_{\\mathrm{td}}} = \\sqrt{\\lambda_{\\max}\\!\\left((K+\\omega_f^2 M,\\; K+\\omega_c^2 M)\\right)}.\n$$\n如果 $\\omega_c\\ge \\omega_f$，$R\\le 1$ 适用于能量集中在低频的模态；然而，对于相对于 $\\omega_f$ 的高频内容，$R$ 会增长，并表明时谐检验范数与调整到 $\\omega_c$ 的时域范数相比，低估了高频残差的响应。\n\n时域中的长时间稳定性：对于半离散无阻尼系统 $M \\ddot{u}_h + K u_h = f_h$，显式中心差分时间步进是稳定的，前提是\n$$\n\\Delta t \\le \\frac{2}{\\sqrt{\\lambda_{\\max}}},\n$$\n这可由放大矩阵的谱半径和 Courant-Friedrichs-Lewy (CFL) 条件（从谐振子 $x'' + \\omega^2 x=0$ 的稳定性界限推导）得出。此界限在无阻尼情况下是紧的。在有阻尼的系统中，稳定区域会适度增长，但采用 $\\Delta t_{\\max} = \\frac{2}{\\sqrt{\\lambda_{\\max}}}$ 是一个保守且稳健的准则。\n\n通过品质因子与衰减的联系：品质因子（Q），$Q(\\omega)$，编码了每个周期储存的相对能量与损失的能量。在小阻尼假设下，单模态关系给出 $Q(\\omega) \\approx \\frac{1}{2\\zeta(\\omega)}$，其中瑞利阻尼 $C=\\alpha M + \\beta K$ 的模态阻尼比为\n$$\n\\zeta(\\omega) = \\frac{\\alpha}{2\\omega} + \\frac{\\beta \\omega}{2}.\n$$\n给定 $Q(\\omega)$，每个周期的能量衰减因子为\n$$\nD = \\exp\\!\\left(-\\frac{2\\pi}{Q(\\omega)}\\right).\n$$\n因此，即使 $R$ 很大（表明时谐范数可能低估了高频内容），足够小的 $D$（强衰减）也能减轻长时间的增长。相反，大的 $Q$（弱衰减）则需要检验范数提供更强的控制，这表明 $\\omega_c$ 应选择在 $\\sqrt{\\lambda_{\\max}}$ 附近。\n\n算法步骤：\n1. 在 $[0,L]$ 上构建具有 $N$ 个单元的均匀网格，节点间距 $h = \\frac{L}{N}$，在施加狄利克雷边界条件后，内部自由度为 $n=N-1$。使用标准一维线性有限元公式为每个单元组装 $M$ 和 $K$：\n$$\nK^{(e)} = \\frac{E A}{h} \\begin{bmatrix} 1  -1 \\\\ -1  1 \\end{bmatrix},\\qquad M^{(e)} = \\frac{\\rho A h}{6} \\begin{bmatrix} 2  1 \\\\ 1  2 \\end{bmatrix}.\n$$\n将单元贡献累加到全局矩阵中，并移除边界行和列。\n2. 计算 $(K,M)$ 的广义特征值，并设 $\\lambda_{\\max}$ 为最大特征值，然后计算 $\\Delta t_{\\max} = \\frac{2}{\\sqrt{\\lambda_{\\max}}}$。\n3. 设 $\\omega_c = \\sqrt{\\lambda_{\\max}}$。对于给定的 $\\omega_f$，构建广义特征值问题 $(K+\\omega_f^2 M) v = \\lambda (K+\\omega_c^2 M) v$ 并计算其最大特征值 $\\lambda_{\\max}^{(\\mathrm{pair})}$。设 $R = \\sqrt{\\lambda_{\\max}^{(\\mathrm{pair})}}$。\n4. 评估 $Q(\\omega_f) = Q_0 \\left(\\frac{\\omega_f}{\\omega_\\star}\\right)^p$。计算 $D = \\exp\\!\\left(-\\frac{2\\pi}{Q(\\omega_f)}\\right)$。\n5. 对于每个测试用例，将 $[R,\\Delta t_{\\max},D]$ 输出到一个单行的聚合列表中。\n\n科学真实性：参数集使用了合理的地球物理值，适用于岩石（$E$ 在 $10^{10}$ 到 $10^{11}$ $\\mathrm{Pa}$ 的量级，$\\rho$ 约 $2500$ 到 $2700$ $\\mathrm{kg/m^3}$），杆长为千米级，频率在 $1$ 到 $50$ $\\mathrm{Hz}$ 范围内。由此产生的波速 $c=\\sqrt{E/\\rho}$ 在 $10^{3}$ 到 $10^{4}$ $\\mathrm{m/s}$ 的量级，与地壳材料中的弹性波传播一致。\n\n该程序使用对称广义特征值计算来实现这些步骤，以避免形成矩阵的逆，从而确保数值稳健性。最终输出通过 $R$ 提供了时谐和时域检验范数的定量比较，以及显式时间步长稳定性界限 $\\Delta t_{\\max}$（单位为秒）和由 $Q(\\omega_f)$ 告知的每个周期的能量衰减 $D$，从而在一个统一的计算框架中将范数设计、稳定性和衰减联系起来。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import eigh\n\ndef assemble_1d_rod(L, A, rho, E, N):\n    \"\"\"\n    Assemble 1D linear FE mass and stiffness matrices for a uniform rod\n    with Dirichlet boundary conditions at both ends. Uses consistent mass.\n    Returns reduced (interior-DOF) M and K.\n    \"\"\"\n    h = L / N\n    # Element matrices\n    ke = (E * A / h) * np.array([[1.0, -1.0],\n                                 [-1.0, 1.0]])\n    me = (rho * A * h / 6.0) * np.array([[2.0, 1.0],\n                                         [1.0, 2.0]])\n    # Global assembly (full with N+1 nodes)\n    nnodes = N + 1\n    K_full = np.zeros((nnodes, nnodes))\n    M_full = np.zeros((nnodes, nnodes))\n    for e in range(N):\n        # Nodes for element e\n        n1 = e\n        n2 = e + 1\n        # Assemble\n        K_full[n1:n2+1, n1:n2+1] += ke\n        M_full[n1:n2+1, n1:n2+1] += me\n    # Apply Dirichlet BCs at nodes 0 and N: reduce to interior dofs [1..N-1]\n    interior = np.arange(1, nnodes - 1)\n    K = K_full[np.ix_(interior, interior)]\n    M = M_full[np.ix_(interior, interior)]\n    return M, K\n\ndef largest_undamped_freq(M, K):\n    \"\"\"\n    Compute largest undamped angular frequency sqrt(lambda_max)\n    from generalized eigenproblem K v = lambda M v.\n    \"\"\"\n    # eigh for symmetric generalized eigenproblem\n    # Return all eigenvalues; take largest positive\n    evals = eigh(K, M, eigvals_only=True)\n    lam_max = np.max(evals)\n    # Numerical safety\n    lam_max = float(np.real(lam_max))\n    omega_max = np.sqrt(lam_max)\n    return omega_max, lam_max\n\ndef norm_ratio(M, K, omega_f, omega_c):\n    \"\"\"\n    Compute R = sqrt(lambda_max) for generalized eigenproblem\n    (K + omega_f^2 M) v = lambda (K + omega_c^2 M) v.\n    \"\"\"\n    A = K + (omega_f**2) * M\n    B = K + (omega_c**2) * M\n    evals = eigh(A, B, eigvals_only=True)\n    lam_pair_max = np.max(evals)\n    lam_pair_max = float(np.real(lam_pair_max))\n    R = np.sqrt(lam_pair_max)\n    return R\n\ndef quality_factor(omega, Q0, omega_star, p):\n    \"\"\"\n    Frequency-dependent Q law: Q(omega) = Q0 * (omega/omega_star)^p\n    \"\"\"\n    return Q0 * (omega / omega_star) ** p\n\ndef energy_decay_per_cycle(Q):\n    \"\"\"\n    Energy decay factor per cycle: exp(-2*pi / Q)\n    \"\"\"\n    return float(np.exp(-2.0 * np.pi / Q))\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each case: (L [m], A [m^2], rho [kg/m^3], E [Pa], N, omega_f [rad/s], Q0, omega_star [rad/s], p)\n    test_cases = [\n        (1.0e3, 1.0, 2700.0, 3.0e10, 80, 2.0*np.pi*20.0, 150.0, 2.0*np.pi*10.0, 0.0),\n        (2.0e3, 1.0, 2500.0, 5.0e10, 120, 2.0*np.pi*50.0, 80.0, 2.0*np.pi*10.0, 0.25),\n        (1.0e3, 1.0, 2600.0, 3.5e10, 60, 2.0*np.pi*1.0, 200.0, 2.0*np.pi*1.0, -0.2),\n    ]\n\n    results = []\n    for case in test_cases:\n        L, A, rho, E, N, omega_f, Q0, omega_star, p = case\n\n        # Assemble FE matrices\n        M, K = assemble_1d_rod(L, A, rho, E, N)\n\n        # Largest undamped angular frequency and dt_max\n        omega_max, lam_max = largest_undamped_freq(M, K)\n        dt_max = 2.0 / omega_max  # seconds\n\n        # Time-domain characteristic frequency\n        omega_c = omega_max\n\n        # Norm ratio R between time-harmonic and time-domain test norms\n        R = norm_ratio(M, K, omega_f, omega_c)\n\n        # Quality factor at omega_f and energy decay per cycle\n        Qf = quality_factor(omega_f, Q0, omega_star, p)\n        D = energy_decay_per_cycle(Qf)\n\n        results.append([R, dt_max, D])\n\n    # Final print statement in the exact required format.\n    # Convert to string with default float formatting.\n    print(f\"[{','.join('[' + ','.join(map(str, r)) + ']' for r in results)}]\")\n\nsolve()\n```", "id": "3617857"}, {"introduction": "最后的这项实践将解决地球物理学中的一个关键挑战：模拟高度非均质介质中的流动，其中渗透率等属性在多个尺度上变化。你将实现一种复杂的混合方法，它为试探空间结合了多尺度有限元法（MsFEM），并为检验空间结合了间断彼得罗夫-伽辽金（DPG）方法。该练习展示了一种先进的策略：通过设计试探函数来局部地捕捉小尺度物理现象，同时计算出最优检验函数以确保全局精度和稳定性，特别是对于界面通量等关键物理量 [@problem_id:3617861]。", "problem": "考虑在区间 $\\Omega = (0,1)$ 内的非均质多孔介质中的稳态一维地下水流，其水头 $p(x)$ 由质量守恒和达西定律控制：在 $\\Omega$ 上满足 $- \\dfrac{\\mathrm{d}}{\\mathrm{d}x}\\left(k(x)\\,\\dfrac{\\mathrm{d}p}{\\mathrm{d}x}\\right) = 0$，并带有狄利克雷边界条件 $p(0)=0$ 和 $p(1)=1$。渗透率场指定为 $k(x) = \\exp\\!\\big(\\beta \\sin(2\\pi f x) + 0.5 \\cos(6\\pi x)\\big)$，其中 $\\beta > 0$ 控制对比度，$f > 0$ 控制细尺度振荡频率。对于这个无源问题，精确常数通量为 $q_{\\mathrm{exact}} = -\\left(\\int_{0}^{1} \\dfrac{1}{k(x)}\\,\\mathrm{d}x\\right)^{-1}$，单位为单位长度的水头。\n\n您将为试探空间构建一个多尺度有限元方法 (MsFEM)，并为检验空间构建一个间断 Petrov-Galerkin (DPG) 方法，然后评估检验空间构造中的过采样对界面通量准确性的影响。试探函数通过局部嵌入 $k(x)$ 的细尺度信息来近似解，而检验函数在 DPG 意义下是“最优”的，这是相对于一个指定的检验范数而言，并且是在围绕每个目标单元、跨越多个粗单元的过采样片区上计算得到的。\n\n使用以下原理和定义来设计一个完整且可执行的算法。\n\n- 控制律和弱形式基础：\n  - 一维达西定律为 $q(x) = -k(x)\\,\\dfrac{\\mathrm{d}p}{\\mathrm{d}x}$，无源情况下的质量守恒为 $\\dfrac{\\mathrm{d}q}{\\mathrm{d}x}=0$。\n  - 对于试探函数 $u$ 和检验函数 $v$ 的原始变分形式是基于子域 $K\\subset\\Omega$ 上的双线性形式 $b(u,v) = \\int_{K} k(x)\\,\\dfrac{\\mathrm{d}u}{\\mathrm{d}x}\\,\\dfrac{\\mathrm{d}v}{\\mathrm{d}x}\\,\\mathrm{d}x$。\n\n- 试探空间 (MsFEM)：\n  - 将 $\\Omega$ 划分为 $N_c$ 个等尺寸的粗单元。在每个粗单元 $K=[x_a,x_b]$ 上，通过求解齐次局部算子 $-\\dfrac{\\mathrm{d}}{\\mathrm{d}x}\\left(k(x)\\,\\dfrac{\\mathrm{d}\\phi}{\\mathrm{d}x}\\right)=0$，并在狄利克雷节点约束 $\\phi_L(x_a)=1, \\phi_L(x_b)=0$ 和 $\\phi_R(x_a)=0, \\phi_R(x_b)=1$ 下，定义两个局部试探基函数。以常规的协调方式组装这些基函数，以获得全局试探空间。\n  - 对于局部调和坐标的数值积分，使用复合梯形法则在每个粗单元上以 $N_{\\mathrm{int,per\\,elem}}$ 个子区间来近似 $1/k(x)$ 的积分。\n\n- 检验空间 (带最优检验的 DPG)：\n  - 在每个粗单元 $K$ 上，为每个局部试探基函数定义最优 DPG 检验函数，作为在粗单元过采样片区上的 Riesz 表示子。过采样半径 $r\\in\\{0,1,2,\\dots\\}$ 决定了片区是目标单元 $K$ 及其两侧 $r$ 个邻居单元的并集，并裁剪到定义域边界。\n  - 选择检验内积为 $(v,w)_V = \\int_{\\mathrm{patch}} \\left(\\dfrac{\\mathrm{d}v}{\\mathrm{d}x}\\,\\dfrac{\\mathrm{d}w}{\\mathrm{d}x} + \\gamma\\,v\\,w\\right)\\mathrm{d}x$，其中 $\\gamma>0$。在片区上使用均匀子网格上的连续分片线性函数来离散化检验空间，每个粗单元包含 $n_t$ 个等长的子区间。\n  - 对应于给定试探基函数 $\\phi$ 的最优检验函数 $v^*$ 满足 $(v^*, w)_V = b(\\phi,w)$，其中 $w$ 为片区上检验空间中的任意函数。这通过求解一个对称正定线性系统来得到 $v^*$ 在所选检验基下的系数来实现。\n\n- 全局双线性形式和组装：\n  - 对于每个粗单元 $K$ 和每个局部试探基函数，通过双线性形式 $b(u,v)$ 计算对全局刚度的贡献，其中检验函数 $v$ 选择为与试探基函数相关联的最优检验函数 $v^*$，并在计算 $b$ 时将检验函数限制在 $K$ 上。\n  - 将单元贡献组装成一个用于粗网格节点未知数的全局对称矩阵，施加狄利克雷边界条件 $p(0)=0$ 和 $p(1)=1$，并求解得到的线性系统以获得内部节点值。\n\n- 通量计算：\n  - 在每个粗单元 $K=[x_i,x_{i+1}]$ 上，计算与局部 MsFEM 试探表示一致的数值单元通量 $q_h$。对于此一维无源情况，在 $K$ 上的局部数值通量是常数，并且可以用节点解值和 $K$ 上的调和积分来表示。\n  - 精确通量 $q_{\\mathrm{exact}}$ 在整个定义域内是常数，可以使用与之前相同的复合梯形法则，即每个粗单元 $N_{\\mathrm{int,per\\,elem}}$ 个子区间，来从 $\\int_{0}^{1} 1/k(x)\\,\\mathrm{d}x$ 计算得出（为保持一致性，对所有粗单元的结果求和）。\n\n- 误差度量：\n  - 对于每个内部粗网格界面 $x_i$，将界面数值通量定义为相邻粗单元中常数数值通量的算术平均值。令 $q_i^{\\mathrm{avg}}$ 表示此平均值。计算绝对相对误差 $e_i = \\left|q_i^{\\mathrm{avg}} - q_{\\mathrm{exact}}\\right|/\\left|q_{\\mathrm{exact}}\\right|$。\n  - 对于每组参数，报告所有内部界面上 $\\{e_i\\}$ 的平均值，结果为单个浮点数。\n\n实现要求：\n\n- 将检验空间参数固定为 $\\gamma = 1$ 和检验网格中每个粗单元 $n_t = 12$ 个子区间。将积分分辨率固定为每个粗单元 $N_{\\mathrm{int,per\\,elem}} = 2000$ 个子区间，用于积分 $1/k(x)$。\n- 对于每个测试用例，使用给定的 $\\beta$ 和 $f$ 定义 $k(x)$，按所述方法构建全局多尺度 Petrov-Galerkin 方法，求解粗网格节点的水头值，计算界面通量误差，并输出平均界面绝对相对误差。\n\n测试套件：\n\n- 程序必须评估以下六组参数集，每组以元组 $\\left(N_c, r, f, \\beta\\right)$ 的形式给出：\n  1. $\\left(8, 0, 20, 1.0\\right)$\n  2. $\\left(8, 1, 20, 1.0\\right)$\n  3. $\\left(8, 2, 20, 1.0\\right)$\n  4. $\\left(8, 1, 40, 1.0\\right)$\n  5. $\\left(8, 1, 20, 2.5\\right)$\n  6. $\\left(4, 1, 20, 1.0\\right)$\n\n最终输出格式：\n\n- 您的程序应生成单行输出，其中包含用方括号括起来的、以逗号分隔的结果列表，顺序与测试用例相同。每个条目是对应测试用例的平均界面绝对相对误差。例如，输出必须具有 $[\\text{result}_1,\\text{result}_2,\\dots,\\text{result}_6]$ 的形式，其中每个 $\\text{result}_i$ 是一个浮点数。", "solution": "所提供的问题具有科学依据、是适定的且客观的。它概述了一个用于评估多尺度有限元方法的全面数值实验。所有过程、参数和定义均已提供，构成了一套完整且内部一致的指令。该问题是有效的，可以构建解答。\n\n该算法首先将域 $\\Omega = (0,1)$ 离散化为 $N_c$ 个粗单元。对于每个测试用例，我们为粗网格节点上的未知水头值 $\\mathbf{p}$ 构建一个全局线性系统 $A\\mathbf{p} = \\mathbf{f}$。矩阵 $A$ 和向量 $\\mathbf{f}$ 由单元级贡献组装而成，这些贡献是使用一种特殊的多尺度间断 Petrov-Galerkin (MsDPG) 公式计算的。一旦求得节点水头值，我们就计算每个单元上的数值通量，确定内部界面处的通量，并将其与精确通量进行比较以量化误差。\n\n### 1. 预备知识与离散化\n域 $\\Omega = (0,1)$ 被划分为 $N_c$ 个粗单元 $K_i = [x_i, x_{i+1}]$，其中 $i=0, \\dots, N_c-1$。粗网格节点为 $x_i = iH$，其中 $H=1/N_c$ 是粗网格尺寸。导水率 $k(x)$ 由 $k(x) = \\exp\\!\\big(\\beta \\sin(2\\pi f x) + 0.5 \\cos(6\\pi x)\\big)$ 给出。边界条件为 $p(0)=0$ 和 $p(1)=1$。\n\n### 2. 试探空间 (MsFEM 基函数)\n试探基函数在每个粗单元 $K_i=[x_i, x_{i+1}]$ 上通过求解带有线性狄利克雷边界条件的齐次问题 $-\\frac{\\mathrm{d}}{\\mathrm{d}x}\\left(k(x)\\frac{\\mathrm{d}\\phi}{\\mathrm{d}x}\\right)=0$ 来局部构建。两个局部基函数 $\\phi_L^{(i)}(x)$ 和 $\\phi_R^{(i)}(x)$ 由条件 $\\phi_L^{(i)}(x_i)=1, \\phi_L^{(i)}(x_{i+1})=0$ 和 $\\phi_R^{(i)}(x_i)=0, \\phi_R^{(i)}(x_{i+1})=1$ 定义。\n\n局部问题的一般解为 $\\phi(x) = C_1 \\int_{x_i}^x \\frac{1}{k(s)}\\mathrm{d}s + C_2$。应用边界条件可得：\n$$\n\\phi_L^{(i)}(x) = 1 - \\frac{\\int_{x_i}^x \\frac{1}{k(s)}\\mathrm{d}s}{\\int_{x_i}^{x_{i+1}} \\frac{1}{k(s)}\\mathrm{d}s}\n\\quad \\text{和} \\quad\n\\phi_R^{(i)}(x) = \\frac{\\int_{x_i}^x \\frac{1}{k(s)}\\mathrm{d}s}{\\int_{x_i}^{x_{i+1}} \\frac{1}{k(s)}\\mathrm{d}s}\n$$\n令 $I_{K_i} = \\int_{x_i}^{x_{i+1}} \\frac{1}{k(s)}\\mathrm{d}s$。其导数为：\n$$\n\\frac{\\mathrm{d}\\phi_L^{(i)}}{\\mathrm{d}x} = -\\frac{1}{k(x)I_{K_i}}\n\\quad \\text{和} \\quad\n\\frac{\\mathrm{d}\\phi_R^{(i)}}{\\mathrm{d}x} = \\frac{1}{k(x)I_{K_i}}\n$$\n积分 $I_{K_i}$ 在每个粗单元 $K_i$ 上使用复合梯形法则进行数值计算，每个单元有 $N_{\\mathrm{int,per\\,elem}}=2000$ 个子区间。\n\n### 3. 检验空间 (最优 DPG 函数)\n对于单元 $K_i$ 上的每个局部试探基函数，会计算一个最优检验函数。该检验函数定义在围绕 $K_i$ 的单元过采样片区上。$K_i$ 的片区由 $K_i$ 本身及其两侧的 $r$ 个粗单元组成，并裁剪到定义域边界 $[0,1]$。\n\n该片区上的检验空间使用连续分片线性 (PWL) 函数 $\\psi_j(x)$ 进行离散化，这些函数定义在一个精细均匀子网格上，每个粗单元有 $n_t=12$ 个子区间。对于给定的试探基函数 $\\phi$，其最优检验函数 $v^*$ 通过求解其在 PWL 基下的系数来找到。它必须对片区上所有的 PWL 函数 $w$ 满足 $(v^*, w)_V = b(\\phi, w)$。双线性形式为：\n- 检验内积：$(v, w)_V = \\int_{\\mathrm{patch}} \\left(\\frac{\\mathrm{d}v}{\\mathrm{d}x}\\frac{\\mathrm{d}w}{\\mathrm{d}x} + \\gamma vw\\right)\\mathrm{d}x$，其中 $\\gamma=1$。\n- 原始双线性形式：$b(\\phi, w) = \\int_{K_i} k(x)\\frac{\\mathrm{d}\\phi}{\\mathrm{d}x}\\frac{\\mathrm{d}w}{\\mathrm{d}x}\\mathrm{d}x$。\n\n将 $v^* = \\sum_j c_j \\psi_j$ 和 $w = \\psi_k$ 代入，得到线性系统 $M\\mathbf{c} = \\mathbf{F}$，其中 $M_{kj} = (\\psi_j, \\psi_k)_V$ 且 $F_k = b(\\phi, \\psi_k)$。\n\n在计算右端向量 $\\mathbf{F}$ 时出现了一个关键的简化。对于一个试探函数 $\\phi \\in \\{\\phi_L^{(i)}, \\phi_R^{(i)}\\}$，其导数与 $1/k(x)$ 成正比。例如，对于 $\\phi_L^{(i)}$：\n$$\nF_k = b(\\phi_L^{(i)}, \\psi_k) = \\int_{K_i} k(x) \\left(-\\frac{1}{k(x)I_{K_i}}\\right) \\frac{\\mathrm{d}\\psi_k}{\\mathrm{d}x} \\mathrm{d}x = -\\frac{1}{I_{K_i}} \\int_{K_i} \\frac{\\mathrm{d}\\psi_k}{\\mathrm{d}x} \\mathrm{d}x\n$$\n根据微积分基本定理，$\\int_{K_i} \\frac{\\mathrm{d}\\psi_k}{\\mathrm{d}x} \\mathrm{d}x = \\psi_k(x_{i+1}) - \\psi_k(x_i)$。由于 $\\psi_k$ 是一个 PWL 基函数（一个“帽”函数），它在对应的精细节点处为 $1$，在所有其他精细节点处为 $0$。粗网格节点 $x_i$ 和 $x_{i+1}$ 也是精细检验网格的节点。因此，向量 $\\mathbf{F}$ 是稀疏的，只有两个非零项，对应于中心在 $K_i$ 端点的检验基函数。这避免了对 $\\mathbf{F}$ 进行数值积分。矩阵 $M$ 是片区上 PWL 基的标准有限元刚度+质量矩阵，使用已知的解析公式进行组装。\n\n### 4. 全局系统组装与求解\n对于每个粗单元 $K_i$，计算一个 $2 \\times 2$ 的局部刚度矩阵 $S^{(i)}$。其元素通过将双线性形式 $b(\\cdot, \\cdot)$ 应用于局部试探函数和最优检验函数对来给出。\n$$\nS^{(i)} = \\begin{pmatrix} b(\\phi_L^{(i)}, v_L^*)  b(\\phi_R^{(i)}, v_L^*) \\\\ b(\\phi_L^{(i)}, v_R^*)  b(\\phi_R^{(i)}, v_R^*) \\end{pmatrix}\n$$\n其中 $v_L^*$ 和 $v_R^*$ 分别是 $\\phi_L^{(i)}$ 和 $\\phi_R^{(i)}$ 的最优检验函数。这些元素的表达式也得到了简化。例如：\n$$\nb(\\phi_L^{(i)}, v_L^*) = -\\frac{1}{I_{K_i}} \\int_{K_i} \\frac{\\mathrm{d}v_L^*}{\\mathrm{d}x} \\mathrm{d}x = -\\frac{1}{I_{K_i}} \\left(v_L^*(x_{i+1}) - v_L^*(x_i)\\right)\n$$\n值 $v_L^*(x_{i+1})$ 和 $v_L^*(x_i)$ 就是上一步求解得到的向量 $\\mathbf{c}$ 中的特定系数。可以证明，这种构造会产生一个对称的单元矩阵 $S^{(i)}$，这又会导致一个对称的全局刚度矩阵 $A$。\n\n全局矩阵 $A$ 通过对所有 $S^{(i)}$ 的贡献求和来组装。在得到的系统 $A\\mathbf{p}=\\mathbf{f}$ 上施加狄利克雷边界条件 $p(0)=0$ 和 $p(1)=1$。求解针对 $N_c-1$ 个内部节点值的简化系统，以获得完整的数值解 $\\mathbf{p} = [p_0, p_1, \\dots, p_{N_c}]^T$。\n\n### 5. 通量与误差计算\n由于选择了 MsFEM 基和无源问题，每个单元 $K_i$ 上的数值通量 $q_h^{(i)}$ 是常数。它由下式给出：\n$$\nq_h^{(i)} = -k(x)\\frac{\\mathrm{d}}{\\mathrm{d}x}\\left(p_i \\phi_L^{(i)}(x) + p_{i+1}\\phi_R^{(i)}(x)\\right) = -k(x)\\left(p_i \\frac{-1}{k(x)I_{K_i}} + p_{i+1}\\frac{1}{k(x)I_{K_i}}\\right) = -\\frac{p_{i+1}-p_i}{I_{K_i}}\n$$\n整个域上的精确常数通量为 $q_{\\mathrm{exact}} = - \\big(\\int_0^1 \\frac{1}{k(x)} \\mathrm{d}x\\big)^{-1}$。为保持一致性，该积分计算为 $\\sum_{i=0}^{N_c-1} I_{K_i}$。\n\n内部粗网格界面 $x_i$ 处的数值通量取为两个相邻单元中通量的算术平均值：$q_i^{\\mathrm{avg}} = (q_h^{(i-1)} + q_h^{(i)})/2$。每个内部界面处的绝对相对误差为 $e_i = |q_i^{\\mathrm{avg}} - q_{\\mathrm{exact}}|/|q_{\\mathrm{exact}}|$。每个测试用例的最终报告值是所有 $N_c-1$ 个内部界面上这些误差的平均值。", "answer": "```python\nimport numpy as np\nimport scipy.linalg\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the results.\n    \"\"\"\n    test_cases = [\n        (8, 0, 20.0, 1.0),\n        (8, 1, 20.0, 1.0),\n        (8, 2, 20.0, 1.0),\n        (8, 1, 40.0, 1.0),\n        (8, 1, 20.0, 2.5),\n        (4, 1, 20.0, 1.0),\n    ]\n\n    # Fixed parameters as specified in the problem\n    gamma = 1.0\n    nt = 12\n    N_int_per_elem = 2000\n\n    results = []\n    for case in test_cases:\n        Nc, r, f, beta = case\n        mean_error = run_case(Nc, r, f, beta, gamma, nt, N_int_per_elem)\n        results.append(mean_error)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef run_case(Nc, r, f, beta, gamma, nt, N_int_per_elem):\n    \"\"\"\n    Executes a single simulation for a given set of parameters.\n    \"\"\"\n    H = 1.0 / Nc\n    x_coarse = np.linspace(0, 1, Nc + 1)\n    k_fn = lambda x: np.exp(beta * np.sin(2 * np.pi * f * x) + 0.5 * np.cos(6 * np.pi * x))\n    \n    # Precompute harmonic integrals I_K for each coarse element\n    I_K = np.zeros(Nc)\n    inv_k_fn = lambda x: 1.0 / k_fn(x)\n    for i in range(Nc):\n        x_quad = np.linspace(x_coarse[i], x_coarse[i+1], N_int_per_elem + 1)\n        k_inv_vals = inv_k_fn(x_quad)\n        I_K[i] = np.trapz(k_inv_vals, x_quad)\n\n    # Assemble global stiffness matrix\n    A = np.zeros((Nc + 1, Nc + 1))\n    for i in range(Nc):\n        S_elem = compute_element_stiffness(i, Nc, r, f, beta, gamma, nt, I_K)\n        A[i:i+2, i:i+2] += S_elem\n    \n    # Solve linear system for interior nodes\n    A_int = A[1:Nc, 1:Nc]\n    b_int = np.zeros(Nc - 1)\n    \n    # Apply Dirichlet boundary conditions p(0)=0, p(1)=1\n    # p(0)=0 doesn't contribute to RHS\n    # p(Nc)=1 contributes -A[Nc-1, Nc] to the last equation\n    b_int[-1] = -A[Nc - 1, Nc]\n    \n    p_int = np.linalg.solve(A_int, b_int)\n    \n    p = np.zeros(Nc + 1)\n    p[0] = 0.0\n    p[1:Nc] = p_int\n    p[Nc] = 1.0\n\n    # Compute exact and numerical fluxes\n    q_exact = -1.0 / np.sum(I_K)\n    q_h = -(p[1:] - p[:-1]) / I_K\n    \n    # Compute interfacial flux errors\n    errors = []\n    for i in range(1, Nc):\n        q_avg = 0.5 * (q_h[i-1] + q_h[i])\n        error = np.abs(q_avg - q_exact) / np.abs(q_exact)\n        errors.append(error)\n        \n    return np.mean(errors)\n\ndef compute_element_stiffness(elem_idx, Nc, r, f, beta, gamma, nt, I_K):\n    \"\"\"\n    Computes the 2x2 element stiffness matrix for a coarse element.\n    \"\"\"\n    i = elem_idx\n    H = 1.0 / Nc\n\n    # Determine patch boundaries for the test space\n    patch_start_elem = max(0, i - r)\n    patch_end_elem = min(Nc - 1, i + r)\n    \n    x_patch_start = patch_start_elem * H\n    x_patch_end = (patch_end_elem + 1) * H\n\n    num_coarse_in_patch = patch_end_elem - patch_start_elem + 1\n    num_test_intervals = num_coarse_in_patch * nt\n    num_test_nodes = num_test_intervals + 1\n    ht = H / nt\n\n    # Assemble M matrix for test space inner product\n    M = np.zeros((num_test_nodes, num_test_nodes))\n    diag_val = 2.0 / ht + 2.0 * gamma * ht / 3.0\n    off_diag_val = -1.0 / ht + gamma * ht / 6.0\n    \n    for k in range(num_test_nodes):\n        if k == 0 or k == num_test_nodes - 1:\n            M[k, k] = 1.0 / ht + gamma * ht / 3.0\n        else:\n            M[k, k] = diag_val\n        if k > 0:\n            M[k, k-1] = off_diag_val\n        if k < num_test_nodes - 1:\n            M[k, k+1] = off_diag_val\n\n    # Create F vector for the phi_L basis function\n    F_L = np.zeros(num_test_nodes)\n    # The coarse element K_i corresponds to a specific range of fine nodes\n    # First node of K_i is at fine node index (i - patch_start_elem) * nt\n    start_fine_node_idx = (i - patch_start_elem) * nt\n    end_fine_node_idx = start_fine_node_idx + nt\n    \n    # F_k = -1/I_K[i] * (psi_k(x_{i+1}) - psi_k(x_i))\n    F_L[start_fine_node_idx] = 1.0 / I_K[i]\n    F_L[end_fine_node_idx] = -1.0 / I_K[i]\n    \n    # Solve for optimal test function coefficients for phi_L\n    v_L_coeffs = scipy.linalg.solve(M, F_L, assume_a='sym')\n    \n    # Since F_R = -F_L, v_R_coeffs = -v_L_coeffs\n    # We only need endpoint coefficients to compute the stiffness entries\n    v_L_start_val = v_L_coeffs[start_fine_node_idx]\n    v_L_end_val = v_L_coeffs[end_fine_node_idx]\n    \n    # Compute element stiffness matrix entries\n    # S_ij = b(phi_j, v_i*)\n    # b(phi_L, v_L*) = (-1/I_K[i]) * (v_L*(x_{i+1}) - v_L*(x_i))\n    S11 = (-1.0 / I_K[i]) * (v_L_end_val - v_L_start_val)\n    # b(phi_R, v_L*) = (1/I_K[i]) * (v_L*(x_{i+1}) - v_L*(x_i))\n    S12 = (1.0 / I_K[i]) * (v_L_end_val - v_L_start_val)\n    \n    # Matrix is symmetric with S22=S11 and S12=S21. Also S11=-S12.\n    # So S has the form c * [[1, -1], [-1, 1]] where c = -S12\n    c = -S12\n    S = c * np.array([[1.0, -1.0], [-1.0, 1.0]])\n\n    return S\n\nif __name__ == \"__main__\":\n    solve()\n\n```", "id": "3617861"}]}