{"hands_on_practices": [{"introduction": "在计算地球物理学中，许多数值方法（如有限元法）会以无序数据流的形式生成矩阵项。坐标（COO）格式非常适合处理这种初始的、非结构化的数据。本练习将引导你完成一个基本但至关重要的过程：如何通过对这些无序的“三元组”进行排序和合并，来构建最终的稀疏矩阵，这是理解更复杂装配算法的基石 [@problem_id:3614751]。", "problem": "在结构化网格上为二维扩散算子组装线性系统时，稀疏矩阵由局部模板贡献以流的形式传入并聚合而成。考虑一个大小为 $5 \\times 5$ 的网格，其节点使用从0开始的行和列索引。全局稀疏矩阵 $A \\in \\mathbb{R}^{5 \\times 5}$ 将以坐标列表（COO）格式构建，其中贡献以三元组 $(i_{k}, j_{k}, v_{k})$ 的流形式到达，分别表示行索引 $i_{k}$、列索引 $j_{k}$ 和值 $v_{k}$。\n\n假设输入流包含 $K = 19$ 个三元组，其顺序严格如下所列：\n$(i_{1}, j_{1}, v_{1}) = (1, 1, 4.0)$，\n$(i_{2}, j_{2}, v_{2}) = (0, 1, -1.0)$，\n$(i_{3}, j_{3}, v_{3}) = (2, 2, 1.0)$，\n$(i_{4}, j_{4}, v_{4}) = (2, 1, -0.5)$，\n$(i_{5}, j_{5}, v_{5}) = (0, 0, 2.0)$，\n$(i_{6}, j_{6}, v_{6}) = (2, 1, -0.25)$，\n$(i_{7}, j_{7}, v_{7}) = (1, 2, -0.5)$，\n$(i_{8}, j_{8}, v_{8}) = (2, 2, 4.0)$，\n$(i_{9}, j_{9}, v_{9}) = (3, 2, 0.1)$，\n$(i_{10}, j_{10}, v_{10}) = (1, 1, -0.5)$，\n$(i_{11}, j_{11}, v_{11}) = (2, 3, 0.1)$，\n$(i_{12}, j_{12}, v_{12}) = (1, 0, -1.0)$，\n$(i_{13}, j_{13}, v_{13}) = (0, 1, -0.5)$，\n$(i_{14}, j_{14}, v_{14}) = (1, 1, 0.25)$，\n$(i_{15}, j_{15}, v_{15}) = (2, 1, -1.0)$，\n$(i_{16}, j_{16}, v_{16}) = (0, 0, 0.5)$，\n$(i_{17}, j_{17}, v_{17}) = (4, 4, 1.0)$，\n$(i_{18}, j_{18}, v_{18}) = (3, 3, 3.0)$，\n$(i_{19}, j_{19}, v_{19}) = (1, 2, -1.0)$。\n\n任务：\n1. 严格按照流给出的顺序，使用从0开始的索引构建长度为 $K = 19$ 的COO数组 $I, J, V$。\n2. 对 $(I, J)$ 执行稳定的字典序排序，即先按 $I$ 递增排序，再按 $J$ 递增排序，并保持相等键 $(I, J)$ 的原始顺序。\n3. 通过稳定求和合并重复项：对于排序后数组中每一组相等的键 $(i, j)$，将其替换为单个条目，该条目的值是按其保持的（稳定）顺序对相应 $v_{k}$ 求和的结果。\n4. 合并后，矩阵元素 $A_{2,1}$ 的最终值是多少？\n\n将您的最终答案表示为一个实数。请勿四舍五入。", "solution": "该问题被评估为有效。它在计算线性代数领域，特别是在稀疏矩阵组装方面，具有科学依据，这是求解偏微分方程数值方法的基础。该问题是适定的，提供了所有必要的数据——一个完整的矩阵贡献流——以及一个用于处理这些数据的清晰、确定性的算法。指令是客观且无歧义的，可以导出一个唯一且可验证的解。\n\n任务是确定在从一个COO格式的三元组流组装稀疏矩阵 $A \\in \\mathbb{R}^{5 \\times 5}$ 后，矩阵元素 $A_{2,1}$ 的最终值。组装过程包括三个步骤：构建初始COO数组，执行稳定的字典序排序，以及通过求和合并重复条目。\n\n给定的输入流包含 $K = 19$ 个三元组 $(i_{k}, j_{k}, v_{k})$，其中 $k = 1, \\dots, 19$。索引 $i$ 和 $j$ 是从0开始的。\n\n初始的COO数组 $I$、$J$ 和 $V$ 是通过按给定顺序从输入流中提取行索引、列索引和值来构建的：\n$I = [1, 0, 2, 2, 0, 2, 1, 2, 3, 1, 2, 1, 0, 1, 2, 0, 4, 3, 1]$\n$J = [1, 1, 2, 1, 0, 1, 2, 2, 2, 1, 3, 0, 1, 1, 1, 0, 4, 3, 2]$\n$V = [4.0, -1.0, 1.0, -0.5, 2.0, -0.25, -0.5, 4.0, 0.1, -0.5, 0.1, -1.0, -0.5, 0.25, -1.0, 0.5, 1.0, 3.0, -1.0]$\n\n下一步是使用 $(I, J)$ 作为排序键，对三元组执行稳定的字典序排序。这个操作将对同一矩阵元素的所有贡献分组到一起。排序的稳定性确保了对任何给定条目，其贡献的原始顺序得以保留。\n\n问题要求的是矩阵元素 $A_{2,1}$ 的最终值。这对应于行索引 $i=2$ 和列索引 $j=1$。我们可以将分析集中在输入流中 $(i_k, j_k) = (2, 1)$ 的三元组上。\n\n扫描输入流，我们识别出以下对元素 $A_{2,1}$ 有贡献的三元组：\n1.  第 $4$ 个三元组是 $(i_4, j_4, v_4) = (2, 1, -0.5)$。\n2.  第 $6$ 个三元组是 $(i_6, j_6, v_6) = (2, 1, -0.25)$。\n3.  第 $15$ 个三元组是 $(i_{15}, j_{15}, v_{15}) = (2, 1, -1.0)$。\n\n这些三元组的原始索引是 $k=4$、$k=6$ 和 $k=15$。稳定排序会将这三个三元组分组到一起，并且由于它们的键 $(2, 1)$ 相同，它们的相对顺序将被保留。因此，在排序后的列表中，它们将按照在原始流中被找到的顺序出现。\n\n最后一步是通过稳定求和来合并这些重复项。这意味着我们按照它们被保留的顺序将这三个三元组的值相加，以获得矩阵元素 $A_{2,1}$ 的最终值。\n\n总和计算如下：\n$$A_{2,1} = v_4 + v_6 + v_{15}$$\n代入给定的值：\n$$A_{2,1} = (-0.5) + (-0.25) + (-1.0)$$\n执行加法：\n$$A_{2,1} = -0.75 + (-1.0)$$\n$$A_{2,1} = -1.75$$\n\n因此，在行索引为2和列索引为1处的矩阵元素的最终值为 $-1.75$。", "answer": "$$\\boxed{-1.75}$$", "id": "3614751"}, {"introduction": "现实世界中的稀疏矩阵通常既非完全规则也非完全随机。混合（HYB）格式通过结合为规则部分设计的 ELLPACK 格式和为不规则部分设计的 COO 格式，为这一挑战提供了实用的解决方案。本练习要求你通过分析行非零元分布，找到最小化总存储空间的最佳 ELL 部分宽度 $k$，这是一个在高性能计算中优化内存占用的核心问题 [@problem_id:3614722]。", "problem": "一个稀疏系统矩阵产生于地球物理油藏模型中三维非结构化网格上的非均匀扩散的隐式有限体积离散化。该矩阵有 $n$ 行，由于可变的局部连接性，每行的非零元数量呈一定分布。要求您在一个结合了 ELLPACK (ELL) 和坐标 (COO) 存储的混合 (HYB) 稀疏格式中选择 ELLPACK (ELL) 宽度 $k$，以最小化总存储空间，然后计算由此产生的 ELL 和 COO 部分的大小。\n\n假设如下：\n- 行数为 $n = 100000$。\n- 每行非零元数量 $d$ 的直方图如下：\n  - $20000$ 行，$d=7$，\n  - $40000$ 行，$d=8$，\n  - $25000$ 行，$d=9$，\n  - $10000$ 行，$d=12$，\n  - $5000$ 行，$d=20$。\n- 在 HYB 格式中，ELL 部分为每行存储 $k$ 个填充槽，每个槽包含一个浮点值和一个列索引。COO 部分存储每行超出 $k$ 的任何溢出项，每个溢出项包含一个浮点值、一个行索引和一个列索引。\n- 使用 8 字节的双精度浮点值和 4 字节的 32 位整数。\n- 忽略除上述每项表示方式之外的任何额外元数据、填充或对齐开销。\n\n令 $S_{\\mathrm{ELL}}(k)$ 表示以字节为单位的 ELL 存储空间，$S_{\\mathrm{COO}}(k)$ 表示以字节为单位的 COO 存储空间。选择整数 $k \\ge 0$ 以最小化总存储空间 $S_{\\mathrm{ELL}}(k) + S_{\\mathrm{COO}}(k)$，并计算在这个最优 $k$ 值下 $S_{\\mathrm{ELL}}(k)$ 和 $S_{\\mathrm{COO}}(k)$ 的值。两种存储空间大小都以字节表示。不要四舍五入，报告精确整数。\n\n将您的最终答案以行向量 $\\big(k, S_{\\mathrm{ELL}}(k), S_{\\mathrm{COO}}(k)\\big)$ 的形式给出。", "solution": "用户希望找到最优的 ELLPACK 宽度 $k$，以最小化混合 ELL/COO 格式下稀疏矩阵的总存储空间，并计算在此最优 $k$ 下 ELL 和 COO 部分的存储大小。\n\n### 步骤1：提取已知条件\n- 总行数：$n = 100000$。\n- 每行非零元数量 ($d$) 的直方图：\n  - $n_7 = 20000$ 行，$d=7$。\n  - $n_8 = 40000$ 行，$d=8$。\n  - $n_9 = 25000$ 行，$d=9$。\n  - $n_{12} = 10000$ 行，$d=12$。\n  - $n_{20} = 5000$ 行，$d=20$。\n- 存储成本：\n  - 双精度浮点值：$s_f = 8$ 字节。\n  - 32位整数：$s_i = 4$ 字节。\n- 混合 (HYB) 格式存储结构：\n  - ELL 部分：对于 $n$ 行中的每一行，存储 $k$ 个槽。每个槽包含一个浮点值和一个列索引。\n  - COO 部分：存储溢出项。对于具有 $d$ 个非零元的行，如果 $d > k$，则存储 $d-k$ 个项。每个项包含一个浮点值、一个行索引和一个列索引。\n\n### 步骤2：使用提取的已知条件进行验证\n该问题具有科学依据，因为它涉及稀疏矩阵的标准存储格式，这是计算科学与工程（包括计算地球物理学）中的一个核心课题。问题是适定的，提供了构建待最小化的成本函数所需的所有数值数据和清晰定义。直方图中的行数总和等于总行数（$20000+40000+25000+10000+5000 = 100000$），因此数据是内部一致的。语言客观而精确。问题有效。\n\n### 步骤3：进行求解\n\n目标是找到整数 $k \\ge 0$，以最小化总存储空间 $S_{\\mathrm{total}}(k) = S_{\\mathrm{ELL}}(k) + S_{\\mathrm{COO}}(k)$。\n\n首先，我们确定每种格式下单个项的存储成本。\n- 对于 ELL 部分，每个项由一个浮点值和一个列索引组成。每个 ELL 项的存储空间为 $s_{\\mathrm{ell\\_entry}} = s_f + s_i = 8 + 4 = 12$ 字节。\n- 对于 COO 部分，每个项由一个浮点值、一个行索引和一个列索引组成。每个 COO 项的存储空间为 $s_{\\mathrm{coo\\_entry}} = s_f + 2s_i = 8 + 2 \\times 4 = 16$ 字节。\n\n接下来，我们建立存储函数 $S_{\\mathrm{ELL}}(k)$ 和 $S_{\\mathrm{COO}}(k)$。\n\n**ELL 存储空间，$S_{\\mathrm{ELL}}(k)$：**\nELL 部分为 $n$ 行中的每一行都分配 $k$ 个槽，而不管每行中实际的非零元数量。\n$$S_{\\mathrm{ELL}}(k) = n \\cdot k \\cdot s_{\\mathrm{ell\\_entry}} = 100000 \\cdot k \\cdot 12 = 1200000 \\cdot k$$\n\n**COO 存储空间，$S_{\\mathrm{COO}}(k)$：**\nCOO 部分存储那些非零元数量 $d$ 超过 ELL 宽度 $k$ 的行的项。对于一个有 $d$ 个非零元的行，溢出项的数量为 $\\max(0, d-k)$。\nCOO 项的总数 $N_{\\mathrm{COO}}(k)$ 是从直方图中对所有行类型求和：\n$$N_{\\mathrm{COO}}(k) = \\sum_{d \\in \\{7,8,9,12,20\\}} n_d \\cdot \\max(0, d-k)$$\n那么总的 COO 存储空间是：\n$$S_{\\mathrm{COO}}(k) = N_{\\mathrm{COO}}(k) \\cdot s_{\\mathrm{coo\\_entry}} = 16 \\cdot N_{\\mathrm{COO}}(k)$$\n\n**总存储空间，$S_{\\mathrm{total}}(k)$：**\n$$S_{\\mathrm{total}}(k) = 1200000 \\cdot k + 16 \\cdot \\sum_{d \\in \\{7,8,9,12,20\\}} n_d \\cdot \\max(0, d-k)$$\n我们需要找到使该函数最小化的整数 $k$。我们可以分析当 $k$ 增加 1 时总存储空间的变化量 $\\Delta S_{\\mathrm{total}}(k) = S_{\\mathrm{total}}(k+1) - S_{\\mathrm{total}}(k)$。最小值将在该差值从负变正的地方找到。\n\nELL 存储空间的变化量是：\n$$\\Delta S_{\\mathrm{ELL}}(k) = S_{\\mathrm{ELL}}(k+1) - S_{\\mathrm{ELL}}(k) = 1200000(k+1) - 1200000k = 1200000$$\n\nCOO 存储空间的变化量是：\n$$\\Delta S_{\\mathrm{COO}}(k) = S_{\\mathrm{COO}}(k+1) - S_{\\mathrm{COO}}(k) = 16 \\cdot (N_{\\mathrm{COO}}(k+1) - N_{\\mathrm{COO}}(k))$$\n让我们分析 COO 项数量的变化量 $\\Delta N_{\\mathrm{COO}}(k) = N_{\\mathrm{COO}}(k+1) - N_{\\mathrm{COO}}(k)$。\n对于具有 $n_d$ 行的单一类型行，变化量是 $n_d \\cdot [\\max(0, d-(k+1)) - \\max(0, d-k)]$。\n- 如果 $d \\le k$，这个差值是 $0-0=0$。\n- 如果 $d > k$，那么 $d-k > 0$ 且 $d-(k+1) \\ge 0$。差值是 $n_d \\cdot [(d-k-1) - (d-k)] = -n_d$。\n所以，$\\Delta N_{\\mathrm{COO}}(k)$ 是非零元数量多于 $k$ 的行数的负值。\n令 $N_{>k}$ 为 $d > k$ 的行数。\n$$N_{>k} = \\sum_{d' > k} n_{d'}$$\n那么，$\\Delta N_{\\mathrm{COO}}(k) = -N_{>k}$，并且 $\\Delta S_{\\mathrm{COO}}(k) = -16 \\cdot N_{>k}$。\n\n总存储空间的变化量是：\n$$\\Delta S_{\\mathrm{total}}(k) = \\Delta S_{\\mathrm{ELL}}(k) + \\Delta S_{\\mathrm{COO}}(k) = 1200000 - 16 \\cdot N_{>k}$$\n只要 $\\Delta S_{\\mathrm{total}}(k)  0$，总存储空间 $S_{\\mathrm{total}}(k)$ 就会减少。\n$1200000 - 16 \\cdot N_{>k}  0 \\implies 1200000  16 \\cdot N_{>k} \\implies N_{>k} > \\frac{1200000}{16} = 75000$\n我们需要找到使非零元数量多于 $k$ 的行数大于 $75000$ 的最大 $k$。\n\n让我们计算在给定分布点附近的 $k$ 值的 $N_{>k}$：\n- 对于 $k \\in \\{0, 1, \\dots, 6\\}$：$N_{>k} = n_7+n_8+n_9+n_{12}+n_{20} = 20000+40000+25000+10000+5000 = 100000$。因为 $100000 > 75000$，所以成本一直降低到 $k=7$。\n- 对于 $k=7$：$N_{>7} = n_8+n_9+n_{12}+n_{20} = 40000+25000+10000+5000 = 80000$。因为 $80000 > 75000$，所以 $\\Delta S_{\\mathrm{total}}(7)  0$，这意味着 $S_{\\mathrm{total}}(8)  S_{\\mathrm{total}}(7)$。成本继续降低。\n- 对于 $k=8$：$N_{>8} = n_9+n_{12}+n_{20} = 25000+10000+5000 = 40000$。因为 $40000  75000$，所以 $\\Delta S_{\\mathrm{total}}(8) > 0$，这意味着 $S_{\\mathrm{total}}(9) > S_{\\mathrm{total}}(8)$。成本开始增加。\n\n因此，在 $k=8$ 时达到最小总存储空间。\n\n现在，我们计算存储大小 $S_{\\mathrm{ELL}}(8)$ 和 $S_{\\mathrm{COO}}(8)$。\n对于最优宽度 $k=8$：\n- **ELL 存储空间：**\n$$S_{\\mathrm{ELL}}(8) = 1200000 \\cdot 8 = 9600000 \\text{ 字节}$$\n- **COO 存储空间：**\n我们计算溢出项的数量 $N_{\\mathrm{COO}}(8)$。当行的 $d > 8$ 时发生溢出。\n- 对于 $d=9$ 的行 ($n_9 = 25000$)：$25000 \\times (9-8) = 25000$ 项。\n- 对于 $d=12$ 的行 ($n_{12} = 10000$)：$10000 \\times (12-8) = 40000$ 项。\n- 对于 $d=20$ 的行 ($n_{20} = 5000$)：$5000 \\times (20-8) = 60000$ 项。\nCOO 项的总数是：\n$$N_{\\mathrm{COO}}(8) = 25000 + 40000 + 60000 = 125000$$\n总的 COO 存储空间是：\n$$S_{\\mathrm{COO}}(8) = 125000 \\cdot s_{\\mathrm{coo\\_entry}} = 125000 \\cdot 16 = 2000000 \\text{ 字节}$$\n\n最优的 ELL 宽度是 $k=8$，此时 ELL 存储空间为 $9600000$ 字节，COO 存储空间为 $2000000$ 字节。所要求的答案是行向量 $\\big(k, S_{\\mathrm{ELL}}(k), S_{\\mathrm{COO}}(k)\\big)$。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n8  9600000  2000000\n\\end{pmatrix}\n}\n$$", "id": "3614722"}]}