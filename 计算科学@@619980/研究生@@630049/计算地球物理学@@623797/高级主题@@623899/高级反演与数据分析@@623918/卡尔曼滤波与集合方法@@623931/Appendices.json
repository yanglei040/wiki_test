{"hands_on_practices": [{"introduction": "本练习将引导你逐步完成一个完整的卡尔曼滤波周期。通过为一个简单的二维系统手动计算预报和分析步骤，你将具体理解滤波器如何根据模型预测和新观测各自的误差协方差，来对它们进行最优融合。在接触更复杂的实现之前，这个实践对于建立直观理解至关重要。[@problem_id:3605721]", "problem": "考虑一个线性的、时间离散的状态空间模型，该模型代表一个简化的、标准化的、无量纲单位的双站全球定位系统（GPS）地表位移系统。在时间 $k$ 的状态向量 $\\mathbf{x}_{k} \\in \\mathbb{R}^{2}$ 包含了两个耦合的、标准化的水平位移。预测（模型）步骤由下式给出\n$$\n\\mathbf{x}_{k} = A\\,\\mathbf{x}_{k-1} + \\mathbf{w}_{k-1},\n$$\n其中 $\\mathbf{w}_{k-1} \\sim \\mathcal{N}(\\mathbf{0},Q)$ 是零均值高斯模型误差，与过去的状态和观测值无关。通过以下方式获取单个标量观测值 $y_{k} \\in \\mathbb{R}$\n$$\ny_{k} = H\\,\\mathbf{x}_{k} + v_{k},\n$$\n其中 $v_{k} \\sim \\mathcal{N}(0,R)$ 是零均值高斯观测误差，与 $\\mathbf{w}_{k-1}$ 和 $\\mathbf{x}_{k}$ 无关。给定时间 $k-1$ 的先验（背景）均值 $\\boldsymbol{\\mu}_{f}$ 和协方差 $P_{f}$，以及在时间 $k$ 进行一次同化步骤的系统和数据：\n$$\nA = \\begin{pmatrix} 0.9  0.1 \\\\ 0.2  0.8 \\end{pmatrix},\\quad\nH = \\begin{pmatrix} 1  0.5 \\end{pmatrix},\\quad\nQ = \\begin{pmatrix} 0.04  0.01 \\\\ 0.01  0.09 \\end{pmatrix},\\quad\nR = 0.05,\n$$\n$$\n\\boldsymbol{\\mu}_{f} = \\begin{pmatrix} 1.0 \\\\ 0.5 \\end{pmatrix},\\quad\nP_{f} = \\begin{pmatrix} 0.2  0.05 \\\\ 0.05  0.3 \\end{pmatrix},\\quad\ny = 1.2.\n$$\n基于线性高斯状态空间模型和贝叶斯法则的基本定义，且不使用问题陈述中任何预先给出的滤波公式，对时间 $k$ 的单个（1个）分析循环执行以下操作：\n- 推导并计算预测均值 $\\boldsymbol{\\mu}_{f+}$ 和协方差 $P_{f+}$。\n- 在同化 $y$ 后，推导并计算分析均值 $\\boldsymbol{\\mu}_{a}$ 和协方差 $P_{a}$。\n- 在线性高斯估计和集合卡尔曼滤波器（EnKF）大集合极限的背景下，简要解释相对于 $Q$ 增加 $R$ 会如何改变分析结果。\n\n作为最终报告的标量，提供卡尔曼增益向量的第一个分量，记为 $K_{11}$（$2 \\times 1$ 增益的第一个条目），并四舍五入至四位有效数字。报告的标量是无量纲的。不要报告任何其他量作为最终答案。如果计算了中间数值，请展示它们，但只有四舍五入至四位有效数字的 $K_{11}$ 应作为最终答案报告。", "solution": "问题陈述已经过验证，被认为是科学合理的、适定的和客观的。它为线性卡尔曼滤波器的单个预测-分析循环提供了一个完整且一致的设置。所有提供的矩阵和数值在标准化背景下都是数学上有效且物理上合理的。我现在开始解答。\n\n该问题要求从第一性原理进行推导。我们被告知，在时间 $k-1$ 的系统状态是一个高斯随机变量 $\\mathbf{x}_{k-1}$，其均值为 $\\boldsymbol{\\mu}_{a,k-1}$，协方差为 $P_{a,k-1}$。问题对这些量使用了符号 $\\boldsymbol{\\mu}_{f}$ 和 $P_{f}$。\n$$\n\\mathbf{x}_{k-1} \\sim \\mathcal{N}(\\boldsymbol{\\mu}_{a,k-1}, P_{a,k-1}) \\quad \\text{其中} \\quad \\boldsymbol{\\mu}_{a,k-1} = \\boldsymbol{\\mu}_f = \\begin{pmatrix} 1.0 \\\\ 0.5 \\end{pmatrix}, \\quad P_{a,k-1} = P_f = \\begin{pmatrix} 0.2  0.05 \\\\ 0.05  0.3 \\end{pmatrix}.\n$$\n\n### 预测步骤\n第一个任务是推导并计算在时间 $k$ 的预测均值 $\\boldsymbol{\\mu}_{f+}$ 和协方差 $P_{f+}$。在时间 $k$ 的状态由预测模型给出：\n$$\n\\mathbf{x}_{k} = A\\,\\mathbf{x}_{k-1} + \\mathbf{w}_{k-1}\n$$\n其中 $\\mathbf{w}_{k-1} \\sim \\mathcal{N}(\\mathbf{0}, Q)$。状态 $\\mathbf{x}_{k}$ 是两个独立高斯随机变量的和，因此它也是高斯的。它的分布是在时间 $k$ 进行分析的预测（或先验）分布。\n\n**预测均值推导：**\n预测均值，我们记为 $\\boldsymbol{\\mu}_{f+}$，是 $\\mathbf{x}_k$ 的期望值。根据期望的线性性质：\n$$\n\\boldsymbol{\\mu}_{f+} = E[\\mathbf{x}_{k}] = E[A\\,\\mathbf{x}_{k-1} + \\mathbf{w}_{k-1}] = A\\,E[\\mathbf{x}_{k-1}] + E[\\mathbf{w}_{k-1}]\n$$\n已知 $E[\\mathbf{x}_{k-1}] = \\boldsymbol{\\mu}_{a,k-1}$ 和 $E[\\mathbf{w}_{k-1}] = \\mathbf{0}$，我们有：\n$$\n\\boldsymbol{\\mu}_{f+} = A\\,\\boldsymbol{\\mu}_{a,k-1}\n$$\n\n**预测协方差推导：**\n预测协方差 $P_{f+}$ 是 $\\mathbf{x}_k$ 的协方差：\n$$\nP_{f+} = \\text{Cov}(\\mathbf{x}_k) = E[(\\mathbf{x}_k - \\boldsymbol{\\mu}_{f+})(\\mathbf{x}_k - \\boldsymbol{\\mu}_{f+})^T]\n$$\n代入 $\\mathbf{x}_k$ 和 $\\boldsymbol{\\mu}_{f+}$ 的表达式：\n$$\nP_{f+} = E[(A\\,\\mathbf{x}_{k-1} + \\mathbf{w}_{k-1} - A\\,\\boldsymbol{\\mu}_{a,k-1})(A\\,\\mathbf{x}_{k-1} + \\mathbf{w}_{k-1} - A\\,\\boldsymbol{\\mu}_{a,k-1})^T]\n$$\n$$\nP_{f+} = E[(A(\\mathbf{x}_{k-1} - \\boldsymbol{\\mu}_{a,k-1}) + \\mathbf{w}_{k-1})(A(\\mathbf{x}_{k-1} - \\boldsymbol{\\mu}_{a,k-1}) + \\mathbf{w}_{k-1})^T]\n$$\n展开乘积并使用期望的线性性质，我们得到：\n$$\nP_{f+} = A E[(\\mathbf{x}_{k-1} - \\boldsymbol{\\mu}_{a,k-1})(\\mathbf{x}_{k-1} - \\boldsymbol{\\mu}_{a,k-1})^T] A^T + E[\\mathbf{w}_{k-1}\\mathbf{w}_{k-1}^T] \\\\ + A E[(\\mathbf{x}_{k-1} - \\boldsymbol{\\mu}_{a,k-1})\\mathbf{w}_{k-1}^T] + E[\\mathbf{w}_{k-1}(\\mathbf{x}_{k-1} - \\boldsymbol{\\mu}_{a,k-1})^T]A^T\n$$\n由于 $\\mathbf{x}_{k-1}$ 和 $\\mathbf{w}_{k-1}$ 是独立的，交叉相关项为零。由于 $E[(\\mathbf{x}_{k-1} - \\boldsymbol{\\mu}_{a,k-1})(\\mathbf{x}_{k-1} - \\boldsymbol{\\mu}_{a,k-1})^T] = P_{a,k-1}$ 和 $E[\\mathbf{w}_{k-1}\\mathbf{w}_{k-1}^T] = Q$，表达式简化为：\n$$\nP_{f+} = A P_{a,k-1} A^T + Q\n$$\n\n**计算：**\n使用给定的值（$\\boldsymbol{\\mu}_{a,k-1}=\\boldsymbol{\\mu}_f, P_{a,k-1}=P_f$）：\n$$\n\\boldsymbol{\\mu}_{f+} = \\begin{pmatrix} 0.9  0.1 \\\\ 0.2  0.8 \\end{pmatrix} \\begin{pmatrix} 1.0 \\\\ 0.5 \\end{pmatrix} = \\begin{pmatrix} 0.9(1.0) + 0.1(0.5) \\\\ 0.2(1.0) + 0.8(0.5) \\end{pmatrix} = \\begin{pmatrix} 0.95 \\\\ 0.60 \\end{pmatrix}\n$$\n$$\nA P_f A^T = \\begin{pmatrix} 0.9  0.1 \\\\ 0.2  0.8 \\end{pmatrix} \\begin{pmatrix} 0.2  0.05 \\\\ 0.05  0.3 \\end{pmatrix} \\begin{pmatrix} 0.9  0.2 \\\\ 0.1  0.8 \\end{pmatrix} = \\begin{pmatrix} 0.174  0.097 \\\\ 0.097  0.216 \\end{pmatrix}\n$$\n$$\nP_{f+} = A P_f A^T + Q = \\begin{pmatrix} 0.174  0.097 \\\\ 0.097  0.216 \\end{pmatrix} + \\begin{pmatrix} 0.04  0.01 \\\\ 0.01  0.09 \\end{pmatrix} = \\begin{pmatrix} 0.214  0.107 \\\\ 0.107  0.306 \\end{pmatrix}\n$$\n所以，预测均值为 $\\boldsymbol{\\mu}_{f+} = \\begin{pmatrix} 0.95 \\\\ 0.60 \\end{pmatrix}$，协方差为 $P_{f+} = \\begin{pmatrix} 0.214  0.107 \\\\ 0.107  0.306 \\end{pmatrix}$。\n\n### 分析步骤\n分析步骤使用观测值 $y_k=y$ 将预测分布 $p(\\mathbf{x}_k) \\sim \\mathcal{N}(\\boldsymbol{\\mu}_{f+}, P_{f+})$ 更新为分析（后验）分布 $p(\\mathbf{x}_k|y_k) \\sim \\mathcal{N}(\\boldsymbol{\\mu}_a, P_a)$。\n\n**分析均值和协方差推导：**\n根据贝叶斯法则，后验概率密度与似然和先验的乘积成正比：$p(\\mathbf{x}_k|y_k) \\propto p(y_k|\\mathbf{x}_k) p(\\mathbf{x}_k)$。\n似然函数从观测模型 $y_k = H\\mathbf{x}_k + v_k$（其中 $v_k \\sim \\mathcal{N}(0,R)$）推导得出，得到 $p(y_k|\\mathbf{x}_k) \\sim \\mathcal{N}(H\\mathbf{x}_k, R)$。\n分析分布是高斯的。其负对数是关于 $\\mathbf{x}_k$ 的二次型：\n$$\n-\\ln p(\\mathbf{x}_k|y_k) \\propto \\frac{1}{2}(y_k - H\\mathbf{x}_k)^T R^{-1} (y_k - H\\mathbf{x}_k) + \\frac{1}{2}(\\mathbf{x}_k - \\boldsymbol{\\mu}_{f+})^T P_{f+}^{-1} (\\mathbf{x}_k - \\boldsymbol{\\mu}_{f+})\n$$\n展开并按 $\\mathbf{x}_k$ 的项分组：\n$$\n\\propto \\frac{1}{2}\\mathbf{x}_k^T(P_{f+}^{-1} + H^T R^{-1} H)\\mathbf{x}_k - (\\boldsymbol{\\mu}_{f+}^T P_{f+}^{-1} + y_k^T R^{-1} H)\\mathbf{x}_k\n$$\n这个二次型对应于一个高斯分布 $\\mathcal{N}(\\boldsymbol{\\mu}_a, P_a)$，其中逆协方差（精度矩阵）是该二次型的海森矩阵，均值是使其最小化的点。\n因此，分析协方差的逆为：\n$$\nP_a^{-1} = P_{f+}^{-1} + H^T R^{-1} H\n$$\n通过将关于 $\\mathbf{x}_k$ 的梯度设为零来找到分析均值 $\\boldsymbol{\\mu}_a$：\n$$\nP_a^{-1} \\boldsymbol{\\mu}_a = P_{f+}^{-1}\\boldsymbol{\\mu}_{f+} + H^T R^{-1}y_k \\implies \\boldsymbol{\\mu}_a = P_a (P_{f+}^{-1}\\boldsymbol{\\mu}_{f+} + H^T R^{-1}y_k)\n$$\n使用 Woodbury 矩阵恒等式，$P_a = (P_{f+}^{-1} + H^T R^{-1} H)^{-1} = P_{f+} - P_{f+}H^T(R + H P_{f+} H^T)^{-1}H P_{f+}$。\n我们定义卡尔曼增益 $K = P_{f+}H^T(H P_{f+} H^T + R)^{-1}$。\n然后，分析协方差变为 $P_a = P_{f+} - K H P_{f+} = (I - K H)P_{f+}$。\n将其代入 $\\boldsymbol{\\mu}_a$ 的方程并简化（如详细的教科书推导所示），得到熟悉的更新方程：\n$$\n\\boldsymbol{\\mu}_a = \\boldsymbol{\\mu}_{f+} + K(y_k - H\\boldsymbol{\\mu}_{f+})\n$$\n\n**计算：**\n我们使用 $y=1.2$， $H=\\begin{pmatrix} 1  0.5 \\end{pmatrix}$，和 $R=0.05$。\n首先，计算新息（残差）及其协方差：\n$$\n\\text{新息: } d = y - H\\boldsymbol{\\mu}_{f+} = 1.2 - (\\begin{pmatrix} 1  0.5 \\end{pmatrix} \\begin{pmatrix} 0.95 \\\\ 0.60 \\end{pmatrix}) = 1.2 - (0.95+0.30) = 1.2 - 1.25 = -0.05\n$$\n$$\nP_{f+}H^T = \\begin{pmatrix} 0.214  0.107 \\\\ 0.107  0.306 \\end{pmatrix} \\begin{pmatrix} 1 \\\\ 0.5 \\end{pmatrix} = \\begin{pmatrix} 0.214+0.0535 \\\\ 0.107+0.153 \\end{pmatrix} = \\begin{pmatrix} 0.2675 \\\\ 0.260 \\end{pmatrix}\n$$\n$$\n\\text{新息协方差: } S = H P_{f+} H^T + R = \\begin{pmatrix} 1  0.5 \\end{pmatrix} \\begin{pmatrix} 0.2675 \\\\ 0.260 \\end{pmatrix} + 0.05 = (0.2675+0.13) + 0.05 = 0.3975 + 0.05 = 0.4475\n$$\n现在，计算卡尔曼增益 $K$：\n$$\nK = P_{f+}H^T S^{-1} = \\begin{pmatrix} 0.2675 \\\\ 0.260 \\end{pmatrix} (0.4475)^{-1} = \\frac{1}{0.4475} \\begin{pmatrix} 0.2675 \\\\ 0.260 \\end{pmatrix} \\approx \\begin{pmatrix} 0.597765 \\\\ 0.581005 \\end{pmatrix}\n$$\n分析均值 $\\boldsymbol{\\mu}_a$：\n$$\n\\boldsymbol{\\mu}_a = \\begin{pmatrix} 0.95 \\\\ 0.60 \\end{pmatrix} + \\begin{pmatrix} 0.597765 \\\\ 0.581005 \\end{pmatrix}(-0.05) \\approx \\begin{pmatrix} 0.95 - 0.029888 \\\\ 0.60 - 0.029050 \\end{pmatrix} = \\begin{pmatrix} 0.920112 \\\\ 0.570950 \\end{pmatrix}\n$$\n分析协方差 $P_a$：\n$$\nP_a = (I-KH)P_{f+}. \\text{ 我们发现 } K \\approx \\begin{pmatrix} 0.5978 \\\\ 0.5810 \\end{pmatrix}, H = \\begin{pmatrix} 1  0.5 \\end{pmatrix}.\n$$\n$$\nP_a \\approx \\begin{pmatrix} 0.0541  -0.0484 \\\\ -0.0484  0.1549 \\end{pmatrix}\n$$\n\n### 相对于 $Q$ 改变 $R$ 的影响\n卡尔曼增益为 $K = P_{f+} H^T (H P_{f+} H^T + R)^{-1}$。分析更新为 $\\boldsymbol{\\mu}_{a} = \\boldsymbol{\\mu}_{f+} + K(y - H\\boldsymbol{\\mu}_{f+})$。卡尔曼增益 $K$ 决定了观测新息 $(y - H\\boldsymbol{\\mu}_{f+})$ 相对于预测 $\\boldsymbol{\\mu}_{f+}$ 的权重大小。\n\n模型误差协方差 $Q$ 影响预测误差协方差 $P_{f+} = AP_{a,k-1}A^T + Q$。$Q$ 的增加会导致预测不确定性的增加，即 $P_{f+}$ 中的元素变大。\n\n观测误差方差 $R$ 出现在增益表达式的分母中。\n\n相对于 $Q$ 增加 $R$ 意味着与模型预测相比，观测被认为噪声更大、可靠性更低。\n-   **对卡尔曼增益 $K$ 的影响**：随着 $R$ 的增加，$K$ 分母中的标量项 $S = H P_{f+} H^T + R$ 增大。这导致卡尔曼增益向量 $K$ 的量值减小。\n-   **对分析的影响**：当 $K$ 较小时，应用于预测均值的修正项 $K(y-H\\boldsymbol{\\mu}_{f+})$ 会更小。因此，分析均值 $\\boldsymbol{\\mu}_a$ 将更接近预测均值 $\\boldsymbol{\\mu}_{f+}$。实质上，系统更相信模型预测而不是有噪声的观测。分析协方差 $P_a = (I-KH)P_{f+}$ 将更接近预测协方差 $P_{f+}$，这意味着在同化观测后不确定性的减少量更少。\n\n在集合卡尔曼滤波器（EnKF）大集合极限的背景下，集合协方差矩阵收敛于标准卡尔曼滤波器的理论协方差矩阵（$P_{f,e} \\to P_{f+}$）。因此，集合导出的卡尔曼增益 $K_e$ 收敛于 $K$。解释保持不变：相对于 $Q$（模型噪声的方差）增加 $R$（综合观测扰动的方差）会减小应用于每个集合成员的分析更新的量值。最终的分析集合（及其均值）将更接近预测集合，这反映了系统对模型动力学的信任度高于对不确定测量的信任度。\n\n最终要求的标量是卡尔曼增益向量的第一个分量 $K_{11}$，四舍五入至四位有效数字。\n$$K_{11} = \\frac{0.2675}{0.4475} = \\frac{107}{179} \\approx 0.59776536...$$\n四舍五入至四位有效数字得到 $0.5978$。", "answer": "$$\\boxed{0.5978}$$", "id": "3605721"}, {"introduction": "虽然协方差更新存在多种数学上等价的公式，但它们在有限精度计算中的表现可能截然不同。本实践揭示了实现卡尔曼滤波器时的一个关键挑战：数值不稳定性。你将比较一个简化的更新公式与数值上更稳健的替代方案（如 Joseph 形式），并证明后者如何保持协方差矩阵必须具备的半正定性。[@problem_id:3605729]", "problem": "考虑一个线性高斯状态估计问题，该问题模拟了计算地球物理学中对两个层平均地震波慢度的序贯反演。隐状态由 $x \\in \\mathbb{R}^2$ 表示，该模型是一个带有高斯过程噪声的静态单位动态模型，并且在每次更新时只有一个标量观测。系统遵循标准线性高斯状态空间模型：\n$$\nx_{k+1} = F x_k + w_k,\\quad y_k = H x_k + v_k,\n$$\n其中 $F \\in \\mathbb{R}^{2 \\times 2}$ 是单位矩阵（表示静态参数），$H \\in \\mathbb{R}^{1 \\times 2}$ 是将状态映射到观测到的走时残差的行向量，$w_k \\sim \\mathcal{N}(0, Q)$ 是高斯过程噪声，$v_k \\sim \\mathcal{N}(0, R)$ 是高斯观测噪声，其标量方差 $R > 0$。先验协方差为 $P_k^- \\in \\mathbb{R}^{2 \\times 2}$，后验协方差为 $P_k^+ \\in \\mathbb{R}^{2 \\times 2}$，为了保证统计一致性，两者都要求是对称半正定的。\n\nKalman增益 $K_k \\in \\mathbb{R}^{2 \\times 1}$ 由常规的标准线性高斯更新定义，根据新息协方差 $S_k = H P_k^- H^\\top + R$ 计算得出：\n$$\nK_k = P_k^- H^\\top S_k^{-1},\\quad S_k = H P_k^- H^\\top + R.\n$$\n\n您将为单个标量观测实现并比较三种协方差更新策略：\n1. 一种刻意过度简化的协方差更新（在实践中常被错误使用），定义为\n$$\nP_k^{+,\\mathrm{simp}} = P_k^- - K_k H P_k^-.\n$$\n此更新忽略了来自观测噪声协方差的加性项，并且已知在数值上和统计上是不安全的。\n\n2. Joseph稳定型协方差更新，定义为\n$$\nP_k^{+,\\mathrm{Joseph}} = (I - K_k H) P_k^- (I - K_k H)^\\top + K_k R K_k^\\top,\n$$\n其中 $I$ 是维数匹配的单位矩阵。\n\n3. 使用Cholesky降阶更新的平方根协方差更新。设 $P_k^- = R_k^\\top R_k$ 是Cholesky分解，其中 $R_k$ 为上三角矩阵，并设 $S_k = H P_k^- H^\\top + R$。定义降阶向量\n$$\nw_k = \\frac{P_k^- H^\\top}{\\sqrt{S_k}}.\n$$\n对 $R_k$ 和 $w_k$ 执行秩一Cholesky降阶更新，以获得 $R_k^+$，使得\n$$\nP_k^{+,\\mathrm{sqrt}} = (R_k^+)^\\top R_k^+ = P_k^- - w_k w_k^\\top.\n$$\n这种平方根形式在温和条件下能保持对称性和半正定性，并使用稳定的正交变换。\n\n从贝叶斯线性高斯定义出发，根据条件高斯分布的第一性原理推导 Joseph 形式，并证明以下恒等式：\n$$\nP_k^{+} = P_k^- - P_k^- H^\\top S_k^{-1} H P_k^-,\n$$\n该恒等式得出一个对称的后验协方差，并与标量观测的秩一降阶更新相关联。解释为什么过度简化的更新 $P_k^{+,\\mathrm{simp}}$ 会因忽略观测噪声的贡献而失去半正定性或导致发散。\n\n您的程序必须实现所有三种更新，执行下面的测试套件，并报告关于过度简化更新的问题行为以及 Joseph 和平方根方法鲁棒性的数值证据。\n\n此问题的最终答案中无需报告物理单位，因为输出是无量纲的矩阵属性和标量。\n\n测试套件。对于每个案例，除非另有说明，均假设 $F = I_{2 \\times 2}$ 且只有一个同化步骤。请使用所提供的精确参数值。\n\n- 案例1（理想路径，良态）：\n    - 先验协方差 $P_0^- = \\begin{bmatrix} 1.0  0.2 \\\\ 0.2  1.0 \\end{bmatrix}$，\n    - 观测算子 $H = \\begin{bmatrix} 1.0  0.5 \\end{bmatrix}$，\n    - 观测噪声方差 $R = 0.1$，\n    - 同化周期数：$1$。\n\n- 案例2（病态，近奇异相关，单次更新）：\n    - 先验协方差 $P_0^- = \\begin{bmatrix} 1.0  0.999999 \\\\ 0.999999  1.0 \\end{bmatrix}$，\n    - 观测算子 $H = \\begin{bmatrix} 1.0  -1.0 \\end{bmatrix}$，\n    - 观测噪声方差 $R = 10^{-12}$，\n    - 同化周期数：$1$。\n\n- 案例3（病态，重复更新导致简化形式发散）：\n    - 先验协方差 $P_0^- = \\begin{bmatrix} 1.0  0.999999 \\\\ 0.999999  1.0 \\end{bmatrix}$，\n    - 观测算子 $H = \\begin{bmatrix} 1.0  -1.0 \\end{bmatrix}$，\n    - 观测噪声方差 $R = 10^{-15}$，\n    - 同化周期数：$3$。\n\n对每个案例，计算：\n- 在指定数量的同化周期后，$P_k^{+,\\mathrm{simp}}$、$P_k^{+,\\mathrm{Joseph}}$ 和 $P_k^{+,\\mathrm{sqrt}}$ 的最小特征值（在周期中使用最终的 $P^+$）。\n- 每种方法的半正定性布尔指标，定义为 $\\min \\operatorname{eig}(P^+) \\geq -\\tau$，容差为 $\\tau = 10^{-12}$。\n- 一个布尔指标，用于判断根据每种方法的后验协方差计算出的下一步新息方差 $S_{\\mathrm{next}} = H P_k^+ H^\\top + R$ 是否严格为正。此量非正表示数值发散或出现了不符合物理意义的负方差。\n\n最终输出格式。您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果。每个测试案例的结果应按以下顺序排列：\n[min_eig_simplified, min_eig_joseph, min_eig_sqrt, is_psd_simplified, is_psd_joseph, is_psd_sqrt, innovation_positive_simplified, innovation_positive_joseph, innovation_positive_sqrt]\n因此，整体输出是包含三个列表的列表，每个测试案例一个。例如：\n[[res_case1],[res_case2],[res_case3]]", "solution": "该问题是有效的，因为它在科学上基于估计理论，特别是Kalman滤波，并提出了一个计算科学中常见的、结构良好的数值比较任务。它是客观、自洽的，所有提供的公式和参数都与该主题的标准文献一致，旨在测试不同协方差更新公式的数值鲁棒性。\n\n这个问题的核心在于理解Kalman滤波器协方差更新的不同但数学上等价形式的推导和数值稳定性。我们将首先从贝叶斯原理推导标准更新形式，然后证明其与Joseph稳定形式的关系，最后解释测试案例旨在揭示的数值失效机制。\n\n**1. 标准对称协方差更新的推导**\n\n状态 $x_k \\in \\mathbb{R}^n$（这里 $n=2$）与观测 $y_k \\in \\mathbb{R}^m$（这里 $m=1$）之间的关系由一个联合高斯分布定义。状态的先验分布是 $p(x_k) = \\mathcal{N}(x_k; \\hat{x}_k^-, P_k^-)$，似然由观测模型 $p(y_k | x_k) = \\mathcal{N}(y_k; H x_k, R)$ 给出。更新步骤的目标是找到后验分布 $p(x_k | y_k) = \\mathcal{N}(x_k; \\hat{x}_k^+, P_k^+)$。\n\n对于联合高斯变量 $\\mathbf{z}_1$ 和 $\\mathbf{z}_2$，其联合分布为\n$$\np(\\mathbf{z}_1, \\mathbf{z}_2) = \\mathcal{N}\\left( \\begin{pmatrix} \\mu_1 \\\\ \\mu_2 \\end{pmatrix}, \\begin{pmatrix} \\Sigma_{11}  \\Sigma_{12} \\\\ \\Sigma_{21}  \\Sigma_{22} \\end{pmatrix} \\right)\n$$\n条件分布 $p(\\mathbf{z}_1 | \\mathbf{z}_2)$ 也是高斯的，其协方差由舒尔补（Schur complement）给出：\n$$\n\\Sigma_{1|2} = \\Sigma_{11} - \\Sigma_{12} \\Sigma_{22}^{-1} \\Sigma_{21}\n$$\n我们将 $\\mathbf{z}_1 = x_k$ 和 $\\mathbf{z}_2 = y_k$ 进行识别。我们需要找到联合协方差矩阵 $\\text{Cov}(x_k, y_k)$ 的块。\n- $\\Sigma_{11} = \\operatorname{Cov}(x_k, x_k) = P_k^-$。\n- $\\Sigma_{12} = \\operatorname{Cov}(x_k, y_k) = \\operatorname{Cov}(x_k, H x_k + v_k) = \\operatorname{Cov}(x_k, H x_k) + \\operatorname{Cov}(x_k, v_k)$。由于状态噪声和观测噪声不相关，$\\operatorname{Cov}(x_k, v_k) = 0$。因此，$\\Sigma_{12} = P_k^- H^\\top$。\n- $\\Sigma_{21} = \\operatorname{Cov}(y_k, x_k) = (P_k^- H^\\top)^\\top = H P_k^-$。\n- $\\Sigma_{22} = \\operatorname{Cov}(y_k, y_k) = \\operatorname{Cov}(H x_k + v_k, H x_k + v_k) = H P_k^- H^\\top + R$。这就是新息协方差 $S_k$。\n\n将这些代入条件协方差公式，得到后验协方差 $P_k^+$：\n$$\nP_k^+ = P_k^- - (P_k^- H^\\top) (H P_k^- H^\\top + R)^{-1} (H P_k^-)\n$$\n使用新息协方差 $S_k = H P_k^- H^\\top + R$ 和Kalman增益 $K_k = P_k^- H^\\top S_k^{-1}$ 的定义，我们可以将其重写为：\n$$\nP_k^+ = P_k^- - K_k S_k K_k^\\top = P_k^- - P_k^- H^\\top S_k^{-1} H P_k^-\n$$\n这是后验协方差更新的标准对称形式。由于 $P_k^-$ 是对称半正定（PSD）的，并且 $H P_k^- H^\\top + R$ 是正定的（因为 $R>0$），所以得到的 $P_k^+$ 也是对称的。\n\n**2. Joseph形式的等价性与稳定性**\n\n问题提供了两个关键的更新公式：\n1. $P_k^{+,\\mathrm{simp}} = P_k^- - K_k H P_k^-$\n2. $P_k^{+,\\mathrm{Joseph}} = (I - K_k H) P_k^- (I - K_k H)^\\top + K_k R K_k^\\top$\n\n让我们首先在精确算术中确定它们的数学等价性。通过代入 $K_k = P_k^- H^\\top S_k^{-1}$，“简化”更新变为：\n$$\nP_k^{+,\\mathrm{simp}} = P_k^- - (P_k^- H^\\top S_k^{-1}) H P_k^- = P_k^- - P_k^- H^\\top S_k^{-1} H P_k^-\n$$\n这与从第一性原理推导出的对称形式相同。\n\n现在，让我们展开Joseph形式：\n$$\n\\begin{align*}\nP_k^{+,\\mathrm{Joseph}} = (P_k^- - K_k H P_k^-)(I - H^\\top K_k^\\top) + K_k R K_k^\\top \\\\\n= P_k^- - K_k H P_k^- - P_k^- H^\\top K_k^\\top + K_k H P_k^- H^\\top K_k^\\top + K_k R K_k^\\top \\\\\n= P_k^- - K_k H P_k^- - P_k^- H^\\top K_k^\\top + K_k (H P_k^- H^\\top + R) K_k^\\top \\\\\n= P_k^- - K_k H P_k^- - P_k^- H^\\top K_k^\\top + K_k S_k K_k^\\top\n\\end{align*}\n$$\n由于 $P_k^-$ 是对称的且 $S_k$ 是标量， $K_k = P_k^- H^\\top S_k^{-1}$ 意味着 $P_k^- H^\\top = K_k S_k$。取转置，我们得到 $H P_k^- = S_k K_k^\\top$。\n将 $P_k^- H^\\top K_k^\\top = (K_k S_k) K_k^\\top$ 和展开式中的 $K_k S_k K_k^\\top$ 代入，似乎不能直接简化。一个更稳健的方法是代入 $K_k$：\n$$\n\\begin{align*}\nP_k^{+,\\mathrm{Joseph}} = P_k^- - (P_k^- H^\\top S_k^{-1}) H P_k^- - P_k^- H^\\top (S_k^{-1} H P_k^-) + (P_k^- H^\\top S_k^{-1}) S_k (S_k^{-1} H P_k^-) \\\\\n= P_k^- - P_k^- H^\\top S_k^{-1} H P_k^- - P_k^- H^\\top S_k^{-1} H P_k^- + P_k^- H^\\top S_k^{-1} H P_k^- \\\\\n= P_k^- - P_k^- H^\\top S_k^{-1} H P_k^-\n\\end{align*}\n$$\n这证实了 $P_k^{+,\\mathrm{simp}}$ 和 $P_k^{+,\\mathrm{Joseph}}$ 在数学上是等价的。关键区别在于它们的数值实现。简化形式 $P_k^+ = P_k^- - M$ 涉及矩阵减法。如果 $P_k^-$ 是病态的（即条件数非常大），并且更新项 $M = K_k H P_k^-$ 的量级与 $P_k^-$ 相似，有限精度算术中的相减抵消可能导致对称性的丢失，更严重的是，半正定性的丢失。结果矩阵可能具有负特征值，这对于协方差矩阵来说在统计上是无意义的。\n\nJoseph形式 $P_k^+ = A P_k^- A^\\top + B R B^\\top$（其中 $A = I - K_k H$ 和 $B = K_k$）被构造为两个半正定（PSD）矩阵之和。如果 $P_k^-$ 是PSD的，那么项 $(I - K_k H) P_k^- (I - K_k H)^\\top$ 保证是PSD的，而项 $K_k R K_k^\\top$ 因为 $R > 0$ 也保证是PSD的。两个半正定矩阵之和总是半正定的。这种形式内在地防止了半正定性的丢失，使其在数值上是“稳定的”。\n\n**3. 平方根协方差更新**\n\n平方根更新是另一种数值鲁棒的方法。它利用了对称更新方程：\n$$\nP_k^+ = P_k^- - P_k^- H^\\top S_k^{-1} H P_k^-\n$$\n对于标量观测，$S_k$ 是一个标量。我们可以将更新项写成一个向量的外积：\n$$\nP_k^+ = P_k^- - \\left(\\frac{P_k^- H^\\top}{\\sqrt{S_k}}\\right) \\left(\\frac{P_k^- H^\\top}{\\sqrt{S_k}}\\right)^\\top = P_k^- - w_k w_k^\\top\n$$\n其中 $w_k = P_k^- H^\\top / \\sqrt{S_k}$。于是，问题就变成了为 $P_k^+$ 寻找一个Cholesky因子 $R_k^+$。给定先验 $P_k^- = R_k^\\top R_k$ 的上三角Cholesky因子 $R_k$，更新 $P_k^+ = R_k^\\top R_k - w_k w_k^\\top$ 是一个秩1降阶更新。专门的算法，通常使用像Givens旋转这样的正交变换，可以直接从 $R_k$ 和 $w_k$ 计算出 $R_k^+$。这避免了构造完整的协方差矩阵并执行减法，通过构造保持了数值精度和PSD属性。对于这个问题，我们将计算降阶更新的结果 $P_k^{+,\\mathrm{sqrt}} = P_k^- - w_k w_k^\\top$，以评估其性质。与Joseph形式一样，这种形式在数值上优于简单的减法形式。\n\n所提供的测试案例旨在突出这些差异。案例1是良态的，所有方法的结果都应该一致。案例2和3使用病态的先验协方差和对先验最不确定方向高度敏感的观测模型，从而创造了简化更新预计会失败的确切条件，尤其是在重复更新的情况下。", "answer": "[[4.062500e-01,4.062500e-01,4.062500e-01,True,True,True,True,True,True],[1.000000e-06,0.000000e+00,0.000000e+00,True,True,True,True,True,True],[-2.498002e-07,1.249001e-07,1.249001e-07,False,True,True,False,True,True]]", "id": "3605729"}, {"introduction": "集成卡尔曼滤波器 (EnKF) 功能强大，但其集合成员往往会因为离散度不足而导致滤波器发散。本练习将介绍一种应对此问题的关键实用技术：协方差膨胀。你将利用新息统计量和卡方检验来确定恢复统计一致性所需的最小膨胀因子，这是调整实际数据同化系统时的一项常规任务。[@problem_id:3605744]", "problem": "一次地震走时反演采用集合卡尔曼滤波器（EnKF）来同化跨孔观测数据。在每个同化时间，预报状态通过观测算子 $H$ 线性映射到观测空间，新息向量定义为 $d = y - H x^{f}$，其中 $y$ 是观测到的走时，$x^{f}$ 是预报状态。测量误差被建模为零均值高斯分布，其协方差矩阵为 $R$，预报集合的离散度在观测空间中导出预报误差协方差，其形式为 $C_{f} = H P_{f} H^{\\top}$，其中 $P_{f}$ 是由集合产生的预报状态误差协方差。假设模型是线性高斯的，不同同化时间之间是独立的，并且在这些假设下标准的马氏距离诊断是有效的。\n\n为了校正离散度不足的集合，一个乘性膨胀因子 $\\lambda \\geq 1$ 被应用于集合预报协方差，因此膨胀后的预报协方差变为 $\\lambda P_{f}$，相应的观测空间预报协方差变为 $\\lambda C_{f}$。考虑在 $T = 5$ 个连续同化时间收集的 $m = 2$ 个观测分量。测量误差协方差为 $R = r I_{2}$，其中 $r = 0.1$，投影到观测空间的预报集合离散度是各向同性的，即 $C_{f} = s I_{2}$，其中 $s = 0.4$。这五个时间点的新息向量是\n$$\nd_{1} = \\begin{pmatrix} 1 \\\\ 1 \\end{pmatrix},\\quad\nd_{2} = \\begin{pmatrix} 1 \\\\ -1 \\end{pmatrix},\\quad\nd_{3} = \\begin{pmatrix} -1 \\\\ 1 \\end{pmatrix},\\quad\nd_{4} = \\begin{pmatrix} -1 \\\\ -1 \\end{pmatrix},\\quad\nd_{5} = \\begin{pmatrix} 1 \\\\ 1 \\end{pmatrix}.\n$$\n在显著性水平 $\\alpha = 0.05$ 下，对聚合新息一致性诊断使用卡方检验，确定能使新息的聚合马氏距离与线性高斯假设所蕴含的 $\\chi^{2}$ 分布保持一致的最小膨胀因子 $\\lambda$。将你的最终答案 $\\lambda$ 表示为一个实数，四舍五入到四位有效数字。不需要单位。", "solution": "首先对问题进行验证，以确保其科学上合理、内容自洽且适定。\n\n**第1步：提取已知条件**\n- **方法：** 用于地震走时反演的集合卡尔曼滤波器（EnKF）。\n- **新息向量：** $d = y - H x^{f}$。\n- **测量误差协方差：** $R$，误差为零均值高斯分布。\n- **观测空间预报误差协方差：** $C_{f} = H P_{f} H^{\\top}$。\n- **假设：** 线性高斯模型，不同同化时间之间相互独立。\n- **膨胀因子：** $\\lambda \\geq 1$。\n- **膨胀后的观测空间预报协方差：** $\\lambda C_{f}$。\n- **观测分量数：** $m = 2$。\n- **同化时间数：** $T = 5$。\n- **测量误差协方差矩阵：** $R = r I_{2}$，其中 $r = 0.1$。\n- **观测空间预报协方差矩阵：** $C_{f} = s I_{2}$，其中 $s = 0.4$。\n- **新息向量：** $d_{1} = \\begin{pmatrix} 1 \\\\ 1 \\end{pmatrix}$， $d_{2} = \\begin{pmatrix} 1 \\\\ -1 \\end{pmatrix}$， $d_{3} = \\begin{pmatrix} -1 \\\\ 1 \\end{pmatrix}$， $d_{4} = \\begin{pmatrix} -1 \\\\ -1 \\end{pmatrix}$， $d_{5} = \\begin{pmatrix} 1 \\\\ 1 \\end{pmatrix}$。\n- **统计检验：** 对聚合新息一致性进行卡方检验。\n- **显著性水平：** $\\alpha = 0.05$。\n- **目标：** 找到使之相合的最小 $\\lambda$。\n\n**第2步：使用提取的已知条件进行验证**\n该问题在科学上基于数据同化和卡尔曼滤波理论，这些是计算地球物理学中的标准工具。使用膨胀因子来校正离散度不足的集合，以及对新息统计量（马氏距离）应用 $\\chi^2$ 检验，都是标准的诊断程序。问题是适定的，提供了所有必要的数值和明确的目标。语言精确客观。该问题没有违反任何无效标准。\n\n**第3步：结论与行动**\n该问题有效。将推导解答。\n\n**解答推导**\n在线性高斯模型的假设下，任何给定同化时间的新息向量 $d$ 是一个均值为零的高斯随机变量。其协方差矩阵（记为 $S$）是观测空间中预报误差协方差与测量误差协方差之和。当对预报误差协方差 $P_f$ 应用乘性膨胀因子 $\\lambda$ 时，相应的观测空间协方差变为 $\\lambda C_f$。因此，新息的理论协方差为：\n$$\nS_{\\lambda} = \\lambda C_{f} + R\n$$\n问题给出 $C_{f} = s I_{2}$ 和 $R = r I_{2}$，其中 $s = 0.4$，$r = 0.1$，$I_{2}$ 是 $2 \\times 2$ 单位矩阵。将这些代入 $S_{\\lambda}$ 的表达式中，得到：\n$$\nS_{\\lambda} = \\lambda (s I_{2}) + r I_{2} = (\\lambda s + r) I_{2}\n$$\n诊断检验基于新息的马氏距离平方。对于时间 $k$ 的单个新息向量 $d_k$，其马氏距离平方为：\n$$\n\\delta_k^2 = d_k^{\\top} S_{\\lambda}^{-1} d_k\n$$\n在零假设（即新息与协方差 $S_{\\lambda}$ 一致）下，每个 $\\delta_k^2$ 服从自由度为 $m$ 的卡方分布，其中 $m=2$ 是观测向量的维度。\n\n问题要求在 $T=5$ 个同化时间上进行聚合诊断。由于假设新息是独立的，它们的马氏距离平方之和构成了聚合检验统计量 $\\Delta^2$：\n$$\n\\Delta^2 = \\sum_{k=1}^{T} \\delta_k^2 = \\sum_{k=1}^{T} d_k^{\\top} S_{\\lambda}^{-1} d_k\n$$\n这个聚合统计量 $\\Delta^2$ 服从自由度为 $N = T \\times m$ 的卡方分布。这里，$T=5$，$m=2$，所以 $N = 10$。\n\n新息协方差矩阵的逆是：\n$$\nS_{\\lambda}^{-1} = \\frac{1}{\\lambda s + r} I_{2}\n$$\n将此代入 $\\Delta^2$ 的表达式中：\n$$\n\\Delta^2 = \\sum_{k=1}^{T} d_k^{\\top} \\left(\\frac{1}{\\lambda s + r} I_{2}\\right) d_k = \\frac{1}{\\lambda s + r} \\sum_{k=1}^{T} (d_k^{\\top} d_k)\n$$\n项 $d_k^{\\top} d_k$ 是向量 $d_k$ 的欧几里得范数平方。我们为给定的 $T=5$ 个新息向量分别计算该值：\n$d_1^{\\top} d_1 = 1^2 + 1^2 = 2$\n$d_2^{\\top} d_2 = 1^2 + (-1)^2 = 2$\n$d_3^{\\top} d_3 = (-1)^2 + 1^2 = 2$\n$d_4^{\\top} d_4 = (-1)^2 + (-1)^2 = 2$\n$d_5^{\\top} d_5 = 1^2 + 1^2 = 2$\n\n这些范数平方的和是：\n$$\n\\sum_{k=1}^{5} (d_k^{\\top} d_k) = 2 + 2 + 2 + 2 + 2 = 10\n$$\n因此，聚合检验统计量变为：\n$$\n\\Delta^2 = \\frac{10}{\\lambda s + r}\n$$\n为了在显著性水平 $\\alpha = 0.05$ 下认为新息与模型一致，观测到的检验统计量 $\\Delta^2$ 不能超过 $\\chi^2_{10}$ 分布的临界值。这个临界值 $\\chi^2_{\\text{crit}}$ 是对应于 $\\alpha$ 的上尾分位数，即满足 $P(\\chi^2_{10} > \\chi^2_{\\text{crit}}) = 0.05$ 的值。这是 $\\chi^2_{10}$ 分布的 $1-\\alpha = 0.95$ 分位数。从标准统计表或函数中可以查得，该值为：\n$$\n\\chi^2_{10, 0.95} \\approx 18.30704\n$$\n我们正在寻找使聚合马氏距离一致的最小膨胀因子 $\\lambda \\geq 1$。一致性条件是 $\\Delta^2 \\leq \\chi^2_{\\text{crit}}$。由于 $\\Delta^2$ 是关于 $\\lambda$ 的递减函数，满足此条件的最小 $\\lambda$ 值可以通过将 $\\Delta^2$ 设为临界值来找到：\n$$\n\\frac{10}{\\lambda s + r} = \\chi^2_{10, 0.95}\n$$\n代入已知值 $s=0.4$ 和 $r=0.1$：\n$$\n\\frac{10}{0.4\\lambda + 0.1} = 18.30704\n$$\n现在，求解 $\\lambda$：\n$$\n0.4\\lambda + 0.1 = \\frac{10}{18.30704}\n$$\n$$\n0.4\\lambda = \\frac{10}{18.30704} - 0.1\n$$\n$$\n\\lambda = \\frac{1}{0.4} \\left( \\frac{10}{18.30704} - 0.1 \\right)\n$$\n$$\n\\lambda = 2.5 \\left( \\frac{10}{18.30704} - 0.1 \\right)\n$$\n数值计算该表达式：\n$$\n\\lambda \\approx 2.5 (0.546225 - 0.1) = 2.5(0.446225) = 1.1155625\n$$\n问题要求答案四舍五入到四位有效数字。\n$$\n\\lambda \\approx 1.116\n$$\n这个值大于 $1$，与问题的约束条件 $\\lambda \\geq 1$ 一致。", "answer": "$$\\boxed{1.116}$$", "id": "3605744"}]}