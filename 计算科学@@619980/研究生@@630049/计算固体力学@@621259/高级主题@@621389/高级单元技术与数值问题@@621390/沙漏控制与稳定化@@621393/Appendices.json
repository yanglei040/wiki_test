{"hands_on_practices": [{"introduction": "本节的第一个练习是您在代码层面理解沙漏控制的入门。在抑制这些非物理模式之前，我们必须首先学会如何检测和量化它们。这个练习将指导您从基本原理出发，为一个标准的八节点六面体单元实现沙漏能量的计算。通过成功完成此任务，并验证沙漏能量在刚体运动和均匀应变场下正确地为零，您将为任何使用减缩积分的有限元程序构建一个至关重要的组成部分。[@problem_id:3571351]", "problem": "实现一个完整且可运行的程序，该程序针对单个减积分八节点三线性六面体有限元，构造四个线性沙漏模式，为指定的节点位移模式评估二次沙漏应变能泛函，并确认该能量对于仿射位移场为零。您的推导和实现必须从父域上的有限元插值基本原理和立方体角点的对称性论证出发，除了标准三线性形函数外，不得预设任何简化公式。\n\n单元的几何形状在物理空间中由占据一个以原点为中心的长方体八个顶点的节点定义。设节点 $i$ 的物理坐标为 $\\mathbf{X}_i \\in \\mathbb{R}^3$（单位为米），边长 $L_x$、$L_y$、$L_z$ 指定为 $L_x = 0.3$，$L_y = 0.2$，$L_z = 0.1$。节点的排序和位置如下：\n- 节点 $1$：$\\mathbf{X}_1 = \\left(-\\frac{L_x}{2}, -\\frac{L_y}{2}, -\\frac{L_z}{2}\\right)$,\n- 节点 $2$：$\\mathbf{X}_2 = \\left(\\frac{L_x}{2}, -\\frac{L_y}{2}, -\\frac{L_z}{2}\\right)$,\n- 节点 $3$：$\\mathbf{X}_3 = \\left(\\frac{L_x}{2}, \\frac{L_y}{2}, -\\frac{L_z}{2}\\right)$,\n- 节点 $4$：$\\mathbf{X}_4 = \\left(-\\frac{L_x}{2}, \\frac{L_y}{2}, -\\frac{L_z}{2}\\right)$,\n- 节点 $5$：$\\mathbf{X}_5 = \\left(-\\frac{L_x}{2}, -\\frac{L_y}{2}, \\frac{L_z}{2}\\right)$,\n- 节点 $6$：$\\mathbf{X}_6 = \\left(\\frac{L_x}{2}, -\\frac{L_y}{2}, \\frac{L_z}{2}\\right)$,\n- 节点 $7$：$\\mathbf{X}_7 = \\left(\\frac{L_x}{2}, \\frac{L_y}{2}, \\frac{L_z}{2}\\right)$,\n- 节点 $8$：$\\mathbf{X}_8 = \\left(-\\frac{L_x}{2}, \\frac{L_y}{2}, \\frac{L_z}{2}\\right)$。\n\n在父（参考）域中，节点 $i$ 对应的自然坐标为 $\\left(\\xi_i,\\eta_i,\\zeta_i\\right) \\in \\{-1,1\\}^3$，其排序与上述相同：\n- 节点 $1$：$\\left(-1,-1,-1\\right)$，\n- 节点 $2$：$\\left(1,-1,-1\\right)$，\n- 节点 $3$：$\\left(1,1,-1\\right)$，\n- 节点 $4$：$\\left(-1,1,-1\\right)$，\n- 节点 $5$：$\\left(-1,-1,1\\right)$，\n- 节点 $6$：$\\left(1,-1,1\\right)$，\n- 节点 $7$：$\\left(1,1,1\\right)$，\n- 节点 $8$：$\\left(-1,1,1\\right)$。\n\n设标准三线性形函数为 $N_i(\\xi,\\eta,\\zeta) = \\frac{1}{8} \\left(1 + \\xi \\, \\xi_i\\right)\\left(1 + \\eta \\, \\eta_i\\right)\\left(1 + \\zeta \\, \\zeta_i\\right)$。单元中心 $(\\xi,\\eta,\\zeta) = (0,0,0)$ 处的雅可比矩阵是 $3 \\times 3$ 矩阵 $\\mathbf{J} = \\frac{\\partial \\mathbf{X}}{\\partial (\\xi,\\eta,\\zeta)}$ 在该中心点的值。定义单元体积为 $V = 8 \\, \\det(\\mathbf{J})$，特征长度平方为 $L^2 = \\mathrm{tr}\\!\\left(\\mathbf{J}^\\mathsf{T} \\mathbf{J}\\right)$。这些量必须使用上述定义从第一性原理计算得出。\n\n定义在节点处评估的四个标量沙漏模式向量 $\\gamma^\\alpha \\in \\mathbb{R}^8$ ($\\alpha = 1,2,3,4$) 为父坐标的双线性和三线性单项式：\n- $\\gamma^1_i = \\xi_i \\, \\eta_i$,\n- $\\gamma^2_i = \\eta_i \\, \\zeta_i$,\n- $\\gamma^3_i = \\zeta_i \\, \\xi_i$,\n- $\\gamma^4_i = \\xi_i \\, \\eta_i \\, \\zeta_i$。\n\n给定节点上的节点位移向量场 $\\mathbf{u}_i \\in \\mathbb{R}^3$（单位为米），通过质心集中质量投影定义沙漏振幅 $\\mathbf{a}^\\alpha \\in \\mathbb{R}^3$：\n$\\mathbf{a}^\\alpha = \\frac{1}{8} \\sum_{i=1}^{8} \\gamma^\\alpha_i \\, \\mathbf{u}_i$，\n沙漏应变能定义为：\n$W_{\\mathrm{hg}} = \\frac{1}{2} \\, \\beta \\, \\mu \\, \\frac{V}{L^2} \\, \\sum_{\\alpha=1}^{4} \\left\\| \\mathbf{a}^\\alpha \\right\\|^2,$\n其中 $\\mu$ 是剪切模量，$\\beta$ 是无量纲稳定化参数。使用 $\\mu = 5.0 \\times 10^5$ (帕斯卡) 和 $\\beta = 1.0$ (无量纲)。能量 $W_{\\mathrm{hg}}$ 必须以焦耳表示。\n\n您必须实现完整的流程，该流程：\n- 从父坐标构造 $\\gamma^\\alpha$，\n- 从节点坐标计算中心点的 $\\mathbf{J}$、$V$ 和 $L^2$，\n- 为每个测试用例计算 $\\mathbf{a}^\\alpha$，然后计算 $W_{\\mathrm{hg}}$。\n\n测试套件。您必须对以下四种节点位移模式评估 $W_{\\mathrm{hg}}$，每种模式都定义为物理坐标 $\\mathbf{X}_i$ 的函数或直接的节点向量。所有位移单位均为米：\n\n- 情况A（仿射场）：$\\mathbf{u}_i = \\mathbf{A} \\, \\mathbf{X}_i + \\mathbf{b}$，其中\n$\\mathbf{A} = \\begin{bmatrix}\n0.01  0.02  -0.01 \\\\\n0.0  -0.005  0.015 \\\\\n0.02  0.01  0.005\n\\end{bmatrix}$ 且 $\\mathbf{b} = \\begin{bmatrix} 0.001 \\\\ -0.0005 \\\\ 0.0002 \\end{bmatrix}$。对于任何仿射场，沙漏能量应为零。\n\n- 情况B（纯沙漏模式）：$\\mathbf{u}_i = \\begin{bmatrix} u_0 \\, \\gamma^1_i \\\\ 0 \\\\ 0 \\end{bmatrix}$，其中 $u_0 = 1.0 \\times 10^{-3}$。\n\n- 情况C（仿射加沙漏）：$\\mathbf{u}_i = \\mathbf{A} \\, \\mathbf{X}_i + \\mathbf{b} + \\begin{bmatrix} 0 \\\\ v_0 \\, \\gamma^3_i \\\\ 0 \\end{bmatrix}$，其中 $v_0 = 2.0 \\times 10^{-3}$。\n\n- 情况D（零场）：$\\mathbf{u}_i = \\mathbf{0}$。\n\n您的程序必须生成单行输出，其中包含四个能量值，格式为逗号分隔的列表并用方括号括起，单位为焦耳，顺序为[情况A, 情况B, 情况C, 情况D]。例如，输出格式应与“[0.0,0.1,0.2,0.3]”完全一样，但使用本问题的正确数值。本问题不涉及角度。不使用百分比。所有结果必须是单位为焦耳的浮点数。", "solution": "该问题要求对单个八节点三线性六面体有限元的沙漏控制方法进行实现和理论论证。这包括构造沙漏模式，计算单元的几何特性，以及为几个指定的节点位移场评估二次沙漏应变能泛函。\n\n求解过程遵循一系列逻辑步骤：首先，我们建立物理单元与其父域之间的几何关系；其次，我们定义沙漏模式及相应的能量泛函；第三，我们应用此框架来评估指定测试用例的能量。\n\n**1. 单元几何与等参映射**\n\n物理空间中的有限元几何 $\\mathbf{X} \\in \\mathbb{R}^3$ 是从一个具有自然坐标 $(\\xi, \\eta, \\zeta) \\in [-1, 1]^3$ 的标准父域映射而来的。这种等参映射使用与插值位移场相同的形函数来插值几何。物理坐标 $\\mathbf{X}$ 由下式给出：\n$$ \\mathbf{X}(\\xi, \\eta, \\zeta) = \\sum_{i=1}^{8} N_i(\\xi, \\eta, \\zeta) \\mathbf{X}_i $$\n其中 $\\mathbf{X}_i$ 是八个节点的物理坐标，$N_i$ 是三线性形函数：\n$$ N_i(\\xi, \\eta, \\zeta) = \\frac{1}{8} (1 + \\xi \\xi_i)(1 + \\eta \\eta_i)(1 + \\zeta \\zeta_i) $$\n这里，$(\\xi_i, \\eta_i, \\zeta_i)$ 是节点 $i$ 的自然坐标，其取值于 $\\{-1, 1\\}^3$。\n\n**2. 雅可比矩阵与单元级量**\n\n沙漏公式基于单元中心 $(\\xi, \\eta, \\zeta) = (0, 0, 0)$ 处的单点积分。我们需要该点处映射的雅可比矩阵 $\\mathbf{J}$。雅可比矩阵的项为 $J_{ab} = \\frac{\\partial X_a}{\\partial \\xi_b}$，其中 $X_a$ 是 $\\mathbf{X}$ 的第 $a$ 个分量，$\\xi_b$ 是第 $b$ 个自然坐标（例如，$\\xi_1 = \\xi$，$\\xi_2 = \\eta$，$\\xi_3 = \\zeta$）。\n$$ \\mathbf{J} = \\frac{\\partial \\mathbf{X}}{\\partial (\\xi, \\eta, \\zeta)} \\bigg|_{(0,0,0)} = \\sum_{i=1}^{8} \\mathbf{X}_i \\otimes \\nabla N_i(0,0,0) $$\n形函数在中心点的梯度为：\n$$ \\nabla N_i(0,0,0) = \\left( \\frac{\\partial N_i}{\\partial \\xi}, \\frac{\\partial N_i}{\\partial \\eta}, \\frac{\\partial N_i}{\\partial \\zeta} \\right) \\bigg|_{(0,0,0)} = \\frac{1}{8} (\\xi_i, \\eta_i, \\zeta_i) $$\n因此，$\\mathbf{J}$ 的列向量为：\n$$ \\frac{\\partial \\mathbf{X}}{\\partial \\xi} \\bigg|_{(0,0,0)} = \\sum_{i=1}^{8} \\frac{\\xi_i}{8} \\mathbf{X}_i, \\quad \\frac{\\partial \\mathbf{X}}{\\partial \\eta} \\bigg|_{(0,0,0)} = \\sum_{i=1}^{8} \\frac{\\eta_i}{8} \\mathbf{X}_i, \\quad \\frac{\\partial \\mathbf{X}}{\\partial \\zeta} \\bigg|_{(0,0,0)} = \\sum_{i=1}^{8} \\frac{\\zeta_i}{8} \\mathbf{X}_i $$\n对于指定的长方体，节点坐标为 $\\mathbf{X}_i = (\\frac{L_x}{2} \\xi_i, \\frac{L_y}{2} \\eta_i, \\frac{L_z}{2} \\zeta_i)$。将此代入表达式中，并使用正交关系 $\\sum_i \\xi_i \\eta_i = 0$、$\\sum_i \\xi_i \\zeta_i = 0$ 等，以及性质 $\\sum_i \\xi_i^2 = 8$，我们发现：\n$$ \\frac{\\partial \\mathbf{X}}{\\partial \\xi} \\bigg|_{(0,0,0)} = \\frac{1}{8} \\sum_{i=1}^{8} \\xi_i \\begin{pmatrix} \\frac{L_x}{2}\\xi_i \\\\ \\frac{L_y}{2}\\eta_i \\\\ \\frac{L_z}{2}\\zeta_i \\end{pmatrix} = \\frac{1}{8} \\begin{pmatrix} \\frac{L_x}{2}\\sum_i \\xi_i^2 \\\\ \\frac{L_y}{2}\\sum_i \\xi_i \\eta_i \\\\ \\frac{L_z}{2}\\sum_i \\xi_i \\zeta_i \\end{pmatrix} = \\begin{pmatrix} L_x/2 \\\\ 0 \\\\ 0 \\end{pmatrix} $$\n类似地，我们求得其他列向量，得到一个对角雅可比矩阵：\n$$ \\mathbf{J} = \\begin{bmatrix} L_x/2  0  0 \\\\ 0  L_y/2  0 \\\\ 0  0  L_z/2 \\end{bmatrix} $$\n当 $L_x=0.3$、$L_y=0.2$ 和 $L_z=0.1$ 时，我们有：\n$$ \\mathbf{J} = \\begin{bmatrix} 0.15  0  0 \\\\ 0  0.1  0 \\\\ 0  0  0.05 \\end{bmatrix} $$\n单元体积 $V$ 和特征长度平方 $L^2$ 由 $\\mathbf{J}$ 计算得出：\n$$ \\det(\\mathbf{J}) = (0.15)(0.1)(0.05) = 0.00075 $$\n$$ V = 8 \\det(\\mathbf{J}) = 8 \\times 0.00075 = 0.006 \\, \\mathrm{m}^3 $$\n这正确地给出了体积 $L_x L_y L_z = (0.3)(0.2)(0.1) = 0.006$。\n$$ L^2 = \\mathrm{tr}(\\mathbf{J}^\\mathsf{T} \\mathbf{J}) = \\mathrm{tr}(\\mathbf{J}^2) = (L_x/2)^2 + (L_y/2)^2 + (L_z/2)^2 = (0.15)^2 + (0.1)^2 + (0.05)^2 $$\n$$ L^2 = 0.0225 + 0.01 + 0.0025 = 0.035 \\, \\mathrm{m}^2 $$\n\n**3. 沙漏公式**\n\n沙漏模式是在单个积分点产生零应变但非零的变形模式。必须对其进行控制以防止伪机制的出现。四个标量沙漏模式向量 $\\gamma^\\alpha \\in \\mathbb{R}^8$ 在节点上通过自然坐标的乘积定义：\n$$ \\gamma^1_i = \\xi_i \\eta_i, \\quad \\gamma^2_i = \\eta_i \\zeta_i, \\quad \\gamma^3_i = \\zeta_i \\xi_i, \\quad \\gamma^4_i = \\xi_i \\eta_i \\zeta_i $$\n这些向量与被单元刚度矩阵正确捕捉的常数场、线性场和双线性场正交。具体来说，在求和 $\\sum_{i=1}^8$ 下，它们与对应于常数场 ($1$) 和线性场 ($\\xi_i, \\eta_i, \\zeta_i$) 的节点向量正交。\n\n给定一个节点位移场 $\\mathbf{u}_i$，沙漏模式的向量振幅 $\\mathbf{a}^\\alpha \\in \\mathbb{R}^3$ 是通过将 $\\mathbf{u}_i$ 投影到每个模式形状 $\\gamma^\\alpha_i$ 上得到的：\n$$ \\mathbf{a}^\\alpha = \\frac{1}{8} \\sum_{i=1}^{8} \\gamma^\\alpha_i \\mathbf{u}_i $$\n然后，沙漏应变能 $W_{\\mathrm{hg}}$ 被定义为这些振幅的二次函数：\n$$ W_{\\mathrm{hg}} = \\frac{1}{2} \\beta \\mu \\frac{V}{L^2} \\sum_{\\alpha=1}^{4} \\|\\mathbf{a}^\\alpha\\|^2 $$\n使用给定的参数 $\\mu = 5.0 \\times 10^5$ Pa 和 $\\beta = 1.0$，能量前置因子为：\n$$ \\frac{1}{2} \\beta \\mu \\frac{V}{L^2} = \\frac{1}{2} (1.0) (5.0 \\times 10^5) \\frac{0.006}{0.035} = \\frac{3 \\times 10^5}{7} \\, \\mathrm{J/m^2} $$\n\n**4. 测试用例评估**\n\n**情况A（仿射场）：** $\\mathbf{u}_i = \\mathbf{A} \\mathbf{X}_i + \\mathbf{b}$\n模式 $\\alpha$ 的振幅为：\n$$ \\mathbf{a}^\\alpha = \\frac{1}{8} \\sum_{i=1}^{8} \\gamma^\\alpha_i (\\mathbf{A} \\mathbf{X}_i + \\mathbf{b}) = \\mathbf{A} \\left( \\frac{1}{8} \\sum_{i=1}^{8} \\gamma^\\alpha_i \\mathbf{X}_i \\right) + \\mathbf{b} \\left( \\frac{1}{8} \\sum_{i=1}^{8} \\gamma^\\alpha_i \\right) $$\n对于所有的 $\\alpha=1, \\dots, 4$，求和 $\\sum_i \\gamma^\\alpha_i = 0$，这是因为与常数模式正交。项 $\\sum_i \\gamma^\\alpha_i \\mathbf{X}_i$ 也为零。例如，对于 $\\alpha=1$ ($\\gamma^1_i = \\xi_i \\eta_i$)：\n$$ \\sum_{i=1}^{8} \\gamma^1_i \\mathbf{X}_i = \\sum_{i=1}^{8} (\\xi_i \\eta_i) \\begin{pmatrix} \\frac{L_x}{2}\\xi_i \\\\ \\frac{L_y}{2}\\eta_i \\\\ \\frac{L_z}{2}\\zeta_i \\end{pmatrix} = \\begin{pmatrix} \\frac{L_x}{2}\\sum_i \\xi_i^2 \\eta_i \\\\ \\frac{L_y}{2}\\sum_i \\xi_i \\eta_i^2 \\\\ \\frac{L_z}{2}\\sum_i \\xi_i \\eta_i \\zeta_i \\end{pmatrix} = \\begin{pmatrix} \\frac{L_x}{2}\\sum_i \\eta_i \\\\ \\frac{L_y}{2}\\sum_i \\xi_i \\\\ \\frac{L_z}{2}\\sum_i (\\xi_i\\eta_i\\zeta_i) \\end{pmatrix} = \\mathbf{0} $$\n这是因为 $\\sum_i \\xi_i=\\sum_i\\eta_i=0$ 且三线性模式 $\\xi\\eta\\zeta$ 与双线性模式 $\\xi\\eta$ 正交。类似的推导表明这对所有的 $\\gamma^\\alpha$ 都成立。因此，对于所有 $\\alpha$，$\\mathbf{a}^\\alpha = \\mathbf{0}$，并且 $W_{\\mathrm{hg}} = 0$。\n\n**情况B（纯沙漏模式）：** $\\mathbf{u}_i = [u_0 \\gamma^1_i, 0, 0]^\\mathsf{T}$，其中 $u_0 = 1.0 \\times 10^{-3}$ m。\n由于沙漏模式的正交性（$\\sum_i \\gamma^\\alpha_i \\gamma^\\beta_i = 8 \\delta_{\\alpha\\beta}$），只有振幅 $\\mathbf{a}^1$ 非零。\n$$ \\mathbf{a}^1 = \\frac{1}{8} \\sum_{i=1}^{8} \\gamma^1_i \\begin{pmatrix} u_0 \\gamma^1_i \\\\ 0 \\\\ 0 \\end{pmatrix} = \\frac{1}{8} \\begin{pmatrix} u_0 \\sum_i (\\gamma^1_i)^2 \\\\ 0 \\\\ 0 \\end{pmatrix} = \\frac{1}{8} \\begin{pmatrix} u_0 \\cdot 8 \\\\ 0 \\\\ 0 \\end{pmatrix} = \\begin{pmatrix} u_0 \\\\ 0 \\\\ 0 \\end{pmatrix} $$\n$$ \\mathbf{a}^2 = \\mathbf{a}^3 = \\mathbf{a}^4 = \\mathbf{0} $$\n总振幅平方和为 $\\sum \\|\\mathbf{a}^\\alpha\\|^2 = \\|\\mathbf{a}^1\\|^2 = u_0^2 = (1.0 \\times 10^{-3})^2 = 1.0 \\times 10^{-6} \\, \\mathrm{m}^2$。\n$$ W_{\\mathrm{hg}} = \\left(\\frac{3 \\times 10^5}{7}\\right) \\times (1.0 \\times 10^{-6}) = \\frac{0.3}{7} \\approx 0.042857 \\, \\mathrm{J} $$\n\n**情况C（仿射加沙漏）：** $\\mathbf{u}_i = \\mathbf{A} \\mathbf{X}_i + \\mathbf{b} + [0, v_0 \\gamma^3_i, 0]^\\mathsf{T}$，其中 $v_0 = 2.0 \\times 10^{-3}$ m。\n根据线性性质，位移场的仿射部分对沙漏振幅没有贡献。我们只需考虑纯沙漏部分 $\\mathbf{u}_i^{\\mathrm{hg}} = [0, v_0 \\gamma^3_i, 0]^\\mathsf{T}$。\n与情况B类似，只有 $\\mathbf{a}^3$ 非零：\n$$ \\mathbf{a}^3 = \\frac{1}{8} \\sum_{i=1}^{8} \\gamma^3_i \\begin{pmatrix} 0 \\\\ v_0 \\gamma^3_i \\\\ 0 \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ v_0 \\\\ 0 \\end{pmatrix} $$\n$$ \\mathbf{a}^1 = \\mathbf{a}^2 = \\mathbf{a}^4 = \\mathbf{0} $$\n总振幅平方和为 $\\sum \\|\\mathbf{a}^\\alpha\\|^2 = \\|\\mathbf{a}^3\\|^2 = v_0^2 = (2.0 \\times 10^{-3})^2 = 4.0 \\times 10^{-6} \\, \\mathrm{m}^2$。\n$$ W_{\\mathrm{hg}} = \\left(\\frac{3 \\times 10^5}{7}\\right) \\times (4.0 \\times 10^{-6}) = \\frac{1.2}{7} \\approx 0.171429 \\, \\mathrm{J} $$\n\n**情况D（零场）：** $\\mathbf{u}_i = \\mathbf{0}$\n如果所有位移都为零，则振幅显然对于所有 $\\alpha$ 都有 $\\mathbf{a}^\\alpha = \\mathbf{0}$，因此 $W_{\\mathrm{hg}} = 0$。\n\n**结果总结：**\n-   情况A: $W_{\\mathrm{hg}} = 0.0$ J\n-   情况B: $W_{\\mathrm{hg}} \\approx 0.042857$ J\n-   情况C: $W_{\\mathrm{hg}} \\approx 0.171429$ J\n-   情况D: $W_{\\mathrm{hg}} = 0.0$ J", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements the hourglass control calculation for an 8-node hexahedral element.\n    \"\"\"\n    # 1. Define constants and element geometry\n    L_x, L_y, L_z = 0.3, 0.2, 0.1  # meters\n    mu = 5.0e5  # Pascals\n    beta = 1.0  # Dimensionless stabilization parameter\n\n    # Natural coordinates for nodes 1-8\n    natural_coords = np.array([\n        [-1, -1, -1],  # Node 1\n        [ 1, -1, -1],  # Node 2\n        [ 1,  1, -1],  # Node 3\n        [-1,  1, -1],  # Node 4\n        [-1, -1,  1],  # Node 5\n        [ 1, -1,  1],  # Node 6\n        [ 1,  1,  1],  # Node 7\n        [-1,  1,  1]   # Node 8\n    ])\n\n    # Physical coordinates\n    # X_i = (L_x/2 * xi_i, L_y/2 * eta_i, L_z/2 * zeta_i)\n    L_vec = np.array([L_x / 2.0, L_y / 2.0, L_z / 2.0])\n    physical_coords = natural_coords * L_vec\n\n    # 2. Compute Jacobian, Volume, and Characteristic Length\n    # Derivatives of shape functions at the center (xi,eta,zeta)=(0,0,0)\n    # dN_i/d_xi = (1/8)*xi_i, etc.\n    # The gradient vectors for all nodes are (1/8) * natural_coords\n    grad_N_center = 0.125 * natural_coords.T  # Shape (3, 8)\n\n    # Jacobian J_ij = sum_k (X_ik * dN_k/d_xi_j)\n    # J = X^T @ grad_N_center^T\n    J = physical_coords.T @ grad_N_center.T\n    \n    # For a rectangular element, J is diagonal:\n    # J = diag(L_x/2, L_y/2, L_z/2)\n    # This calculation is kept general for verification.\n\n    det_J = np.linalg.det(J)\n    V = 8.0 * det_J\n    L_sq = np.trace(J.T @ J)\n    \n    # 3. Construct hourglass mode vectors\n    xi = natural_coords[:, 0]\n    eta = natural_coords[:, 1]\n    zeta = natural_coords[:, 2]\n\n    gamma1 = xi * eta\n    gamma2 = eta * zeta\n    gamma3 = zeta * xi\n    gamma4 = xi * eta * zeta\n    \n    gammas = np.array([gamma1, gamma2, gamma3, gamma4]) # Shape (4, 8)\n\n    # 4. Define test cases\n    A = np.array([\n        [0.01, 0.02, -0.01],\n        [0.0, -0.005, 0.015],\n        [0.02, 0.01, 0.005]\n    ])\n    b = np.array([0.001, -0.0005, 0.0002])\n    u0 = 1.0e-3\n    v0 = 2.0e-3\n\n    # Case A: Affine field\n    u_A = (A @ physical_coords.T).T + b\n    \n    # Case B: Pure hourglass mode\n    u_B = np.zeros((8, 3))\n    u_B[:, 0] = u0 * gamma1\n\n    # Case C: Affine + hourglass\n    u_C_hg = np.zeros((8, 3))\n    u_C_hg[:, 1] = v0 * gamma3\n    u_C = u_A + u_C_hg\n\n    # Case D: Zero field\n    u_D = np.zeros((8, 3))\n\n    test_cases = [u_A, u_B, u_C, u_D]\n    results = []\n\n    # 5. Calculate hourglass energy for each case\n    energy_prefactor = 0.5 * beta * mu * V / L_sq\n    \n    for u in test_cases:\n        sum_a_sq_norm = 0.0\n        for alpha in range(4):\n            # Project displacements onto hourglass mode to get amplitude vector a_alpha\n            # a_alpha = (1/8) * sum(gamma_i * u_i)\n            # This is equivalent to (1/8) * u.T @ gamma\n            a_alpha = (1.0 / 8.0) * u.T @ gammas[alpha]\n            sum_a_sq_norm += np.linalg.norm(a_alpha)**2\n        \n        W_hg = energy_prefactor * sum_a_sq_norm\n        results.append(W_hg)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3571351"}, {"introduction": "既然我们能够计算沙漏能，一个关键问题随之而来：多大的稳定化程度才算“恰到好处”？本练习将从纯粹的实现层面，带您进入基于物理原理的参数“调优”艺术。您将探索沙漏稳定化系数与单元动态行为（特别是其对波传播的影响）之间的关系。通过推导出一个阈值，确保伪波速保持在物理波速的一个很小比例之内，您将对显式动力学仿真中数值稳定性与物理精度之间的权衡有更深刻的理解。[@problem_id:3571348]", "problem": "在一个采用质量集中的显式动力学模拟中，使用了一个八节点三线性六面体单元，并采用单点（减缩）积分。材料是均匀、各向同性的线性弹性体，其质量密度为 $\\rho$，剪切模量为 $\\mu$。考虑一个边长为 $h$、体积为 $V = h^{3}$ 的立方体单元。使用基于刚度的稳定化方法进行沙漏控制，其单个沙漏模式的储存能模型为\n$$\nE_{\\mathrm{hg}} = \\frac{1}{2}\\,\\alpha\\,\\mu\\,V\\,q^{2},\n$$\n其中 $\\alpha$ 是一个无量纲沙漏系数， $q$ 是一个无量纲沙漏变形量。\n\n重点关注与父域中沿 $\\xi$ 方向变化相关的典型沙漏模式。设八个节点被排序，使得符号向量 $s = [s_{1},\\dots,s_{8}]^{T}$ 在参考立方体的每个角点上都满足 $s_{i} = \\operatorname{sign}(\\xi_{i}) \\in \\{-1,1\\}$。在全局 $x$ 方向上指定一个形式为 $u_{i} = a\\,s_{i}$ 的节点位移模式，其中 $a$ 是一个实数幅值，并定义沙漏量为\n$$\nq = \\frac{1}{8h}\\sum_{i=1}^{8} s_{i}\\,u_{i}.\n$$\n假设此单元沿 $x$ 方向周期性重复，从而使指定的模式模拟单元奈奎斯特波数 $k_{N} = \\pi/h$。取连续介质剪切波速为 $c_{s} = \\sqrt{\\mu/\\rho}$，并将伪沙漏模式建模为一个离散谐振子，其相速度为 $c_{\\mathrm{hg}} = \\omega_{\\mathrm{hg}}/k_{N}$，其中 $\\omega_{\\mathrm{hg}}$ 是从沙漏能量和集中质量的二次型之比中提取的自然角频率。使用节点集中质量 $m_{n} = \\rho V/8$。\n\n定义当单元奈奎斯特波数处的伪相速度等于物理剪切波速的一小部分 $\\varepsilon$（$\\varepsilon = 0.05$）时，沙漏刚度“显著改变波速色散”。在所述假设下，推导并计算阈值 $\\alpha_{\\mathrm{th}}$，使得在 $k_{N} = \\pi/h$ 时 $c_{\\mathrm{hg}} = \\varepsilon\\,c_{s}$ 成立。\n\n将您最终的 $\\alpha_{\\mathrm{th}}$ 数值四舍五入到四位有效数字。将最终答案表示为一个无量纲数。", "solution": "该问题要求在一个八节点六面体单元的一组特定建模假设下，推导无量纲沙漏系数 $\\alpha_{\\mathrm{th}}$ 的阈值。该阈值的判据是，在单元奈奎斯特波数下，伪沙漏模式的相速度 $c_{\\mathrm{hg}}$ 等于物理剪切波速 $c_s$ 的一小部分 $\\varepsilon$。\n\n首先，我们确定在指定的位移模式下，沙漏变形量 $q$ 的值。全局 $x$ 方向的节点位移为 $u_{i} = a\\,s_{i}$，其中 $a$ 是一个随时间变化的幅值， $s_{i}$ 是节点 $i$ 的局部坐标 $\\xi_i$ 的符号。沙漏量 $q$ 定义为：\n$$\nq = \\frac{1}{8h}\\sum_{i=1}^{8} s_{i}\\,u_{i}\n$$\n代入 $u_i$ 的表达式：\n$$\nq = \\frac{1}{8h}\\sum_{i=1}^{8} s_{i}\\,(a\\,s_{i}) = \\frac{a}{8h}\\sum_{i=1}^{8} s_{i}^{2}\n$$\n由于 $s_{i} \\in \\{-1, 1\\}$，对于所有节点 $i=1, \\dots, 8$，我们有 $s_{i}^{2} = 1$。求和项变为 $\\sum_{i=1}^{8} s_{i}^{2} = 8$。因此，沙漏量与幅值 $a$ 成正比：\n$$\nq = \\frac{a}{8h}(8) = \\frac{a}{h}\n$$\n接下来，我们用幅值 $a$ 表示储存的沙漏能 $E_{\\mathrm{hg}}$。沙漏能的模型为：\n$$\nE_{\\mathrm{hg}} = \\frac{1}{2}\\,\\alpha\\,\\mu\\,V\\,q^{2}\n$$\n代入 $q = a/h$ 和单元体积 $V = h^{3}$：\n$$\nE_{\\mathrm{hg}} = \\frac{1}{2}\\,\\alpha\\,\\mu\\,h^{3}\\,\\left(\\frac{a}{h}\\right)^{2} = \\frac{1}{2}\\,\\alpha\\,\\mu\\,h^{3}\\,\\frac{a^{2}}{h^{2}} = \\frac{1}{2}(\\alpha\\,\\mu\\,h)a^{2}\n$$\n该表达式是谐振子的势能。沙漏模式的有效刚度 $K_{\\mathrm{hg}}$ 可以从这个二次型中确定为：\n$$\nK_{\\mathrm{hg}} = \\alpha\\,\\mu\\,h\n$$\n现在，我们确定在指定的运动下，单元的动能 $T$。该模拟使用集中质量矩阵，每个节点的质量为 $m_{n} = \\rho V/8$。每个节点的速度为 $\\dot{u}_{i} = \\frac{d}{dt}(a s_i) = \\dot{a} s_i$。总动能是八个节点动能之和：\n$$\nT = \\frac{1}{2}\\sum_{i=1}^{8} m_{n}\\,\\dot{u}_{i}^{2} = \\frac{1}{2}\\sum_{i=1}^{8} \\left(\\frac{\\rho V}{8}\\right)(\\dot{a} s_{i})^{2}\n$$\n代入 $V=h^3$ 并提出常数项：\n$$\nT = \\frac{1}{2}\\left(\\frac{\\rho h^{3}}{8}\\right)\\dot{a}^{2}\\sum_{i=1}^{8}s_{i}^{2}\n$$\n如前所述，$\\sum_{i=1}^{8} s_{i}^{2} = 8$。动能变为：\n$$\nT = \\frac{1}{2}\\left(\\frac{\\rho h^{3}}{8}\\right)\\dot{a}^{2}(8) = \\frac{1}{2}(\\rho h^{3})\\dot{a}^{2}\n$$\n从这个关于 $\\dot{a}$ 的二次型中，我们确定沙漏模式的有效质量：\n$$\nM_{\\mathrm{eff}} = \\rho h^{3}\n$$\n这个单自由度系统（广义坐标为 $a$）的运动方程是一个简谐振子方程，$M_{\\mathrm{eff}}\\ddot{a} + K_{\\mathrm{hg}}a = 0$。自然角频率 $\\omega_{\\mathrm{hg}}$ 由下式给出：\n$$\n\\omega_{\\mathrm{hg}}^{2} = \\frac{K_{\\mathrm{hg}}}{M_{\\mathrm{eff}}} = \\frac{\\alpha\\,\\mu\\,h}{\\rho h^{3}} = \\frac{\\alpha\\,\\mu}{\\rho h^{2}}\n$$\n取平方根，我们得到角频率：\n$$\n\\omega_{\\mathrm{hg}} = \\sqrt{\\frac{\\alpha\\,\\mu}{\\rho h^{2}}} = \\frac{1}{h}\\sqrt{\\frac{\\alpha\\,\\mu}{\\rho}}\n$$\n伪沙漏模式的相速度 $c_{\\mathrm{hg}}$ 定义为其角频率与波数之比，即 $c_{\\mathrm{hg}} = \\omega_{\\mathrm{hg}}/k_N$。问题指定了单元奈奎斯特波数 $k_{N} = \\pi/h$。\n$$\nc_{\\mathrm{hg}} = \\frac{\\omega_{\\mathrm{hg}}}{k_{N}} = \\frac{\\frac{1}{h}\\sqrt{\\frac{\\alpha \\mu}{\\rho}}}{\\frac{\\pi}{h}} = \\frac{1}{\\pi}\\sqrt{\\frac{\\alpha \\mu}{\\rho}}\n$$\n问题将波速色散“显著改变”的阈值条件定义为 $c_{\\mathrm{hg}} = \\varepsilon\\,c_{s}$，其中 $c_{s} = \\sqrt{\\mu/\\rho}$ 是连续介质剪切波速，$\\varepsilon = 0.05$。我们将沙漏系数 $\\alpha$ 设置为其阈值 $\\alpha_{\\mathrm{th}}$ 并施加此条件：\n$$\n\\frac{1}{\\pi}\\sqrt{\\frac{\\alpha_{\\mathrm{th}}\\,\\mu}{\\rho}} = \\varepsilon \\sqrt{\\frac{\\mu}{\\rho}}\n$$\n假设 $\\mu > 0$ 且 $\\rho > 0$，我们可以从两边消去项 $\\sqrt{\\mu/\\rho}$：\n$$\n\\frac{1}{\\pi}\\sqrt{\\alpha_{\\mathrm{th}}} = \\varepsilon\n$$\n求解 $\\alpha_{\\mathrm{th}}$：\n$$\n\\sqrt{\\alpha_{\\mathrm{th}}} = \\pi\\,\\varepsilon\n$$\n$$\n\\alpha_{\\mathrm{th}} = (\\pi\\,\\varepsilon)^{2}\n$$\n这是阈值的符号表达式。现在，我们代入给定的数值 $\\varepsilon = 0.05$：\n$$\n\\alpha_{\\mathrm{th}} = (\\pi \\times 0.05)^{2} = (0.05\\pi)^{2}\n$$\n数值计算如下：\n$$\n\\alpha_{\\mathrm{th}} \\approx (3.14159265 \\times 0.05)^{2} \\approx (0.15707963)^{2} \\approx 0.02467401\n$$\n将结果四舍五入到四位有效数字，得到：\n$$\n\\alpha_{\\mathrm{th}} \\approx 0.02467\n$$", "answer": "$$\\boxed{0.02467}$$", "id": "3571348"}, {"introduction": "固定的稳定化系数可能是一把“钝器”——有时过于刚硬，导致单元“锁定”，有时又太弱，无法有效控制伪模式。这最后一个练习介绍了一种更复杂、更实用的方法：自适应沙漏控制。您将推导并实现一个根据单元当前变形状态动态调整稳定化系数的规则。通过确保伪沙漏能量始终是单元真实弹性应变能的一个受控的小比例，该方法只在需要时、在需要的地方提供稳定性，从而在更广泛的问题中获得更鲁棒和更准确的结果。[@problem_id:3571380]", "problem": "考虑一个在三维线性弹性分析中采用单点积分的八节点三线性六面体有限元。在欠积分下，可能会出现称为沙漏模式的非物理零能模式。一种常见的稳定化方法是通过增加一个沙漏控制项来增强离散能量。您的任务是从第一性原理出发，推导出一个用于沙漏系数的自适应法则，该法则将沙漏能与弹性应变能之间的比率维持在预设容差范围内，然后实现它。\n\n从以下基本原则出发：\n- 针对小应变和小位移的虚功原理和线性弹性理论。\n- 线性各向同性材料的弹性应变能密度，由 $w = \\frac{1}{2} \\boldsymbol{\\varepsilon} : \\boldsymbol{\\sigma}$ 给出，其中 $\\boldsymbol{\\sigma} = \\mathbf{C} \\boldsymbol{\\varepsilon}$，$\\mathbf{C}$ 是 Voigt 记法下的 $6 \\times 6$ 各向同性刚度矩阵。\n- 对于单点积分六面体单元内的恒定应变状态，弹性应变能可以写为 $W_e = \\frac{1}{2} \\boldsymbol{\\varepsilon}^\\mathsf{T} \\mathbf{C} \\, \\boldsymbol{\\varepsilon} \\, V$，其中 $V$ 是单元体积。\n- 沙漏稳定能建模为 $W_h = \\frac{1}{2} k_h \\, \\| \\mathbf{q} \\|^2$，其中 $\\mathbf{q}$ 是从节点位移中提取的沙漏模式幅值向量，$k_h$ 是标量沙漏刚度。在许多基于物理的公式中，$k_h$ 与剪切模量和体积成比例，即 $k_h = c_h \\, G \\, V$，其中 $G$ 是剪切模量，$c_h$ 是待调整的无量纲系数。\n\n您的目标：\n1. 推导沙漏系数 $c_h$ 的自适应法则，使得比率 $W_h/W_e \\le \\eta$ 成立，其中 $\\eta$ 是一个预设的无量纲容差。\n2. 在一个程序中实现此法则，该程序利用单元的运动学和材料参数，为几个测试案例计算 $c_h$。\n\n使用的单元运动学和算子：\n- 八节点六面体单元，节点编号为 $0$ 到 $7$，每个节点的自然坐标 $(\\xi_i,\\eta_i,\\zeta_i)$ 分配如下：\n  - 节点 $0$：$(-1,-1,-1)$，节点 $1$：$(+1,-1,-1)$，节点 $2$：$(+1,+1,-1)$，节点 $3$：$(-1,+1,-1)$，\n  - 节点 $4$：$(-1,-1,+1)$，节点 $5$：$(+1,-1,+1)$，节点 $6$：$(+1,+1,+1)$，节点 $7$：$(-1,+1,+1)$。\n- 假设一个单位立方体映射，使得物理体积为 $V = 1.0$，并且从自然坐标到物理坐标的映射在单元中心 $(\\xi,\\eta,\\zeta)=(0,0,0)$ 处产生形函数的导数，为 $\\partial N_i/\\partial x = \\xi_i/4$，$\\partial N_i/\\partial y = \\eta_i/4$，$\\partial N_i/\\partial z = \\zeta_i/4$。\n- 使用以下公式构建尺寸为 $6 \\times 24$ 的应变-位移矩阵 $\\mathbf{B}$（Voigt 顺序 $\\boldsymbol{\\varepsilon} = [\\varepsilon_{xx}, \\varepsilon_{yy}, \\varepsilon_{zz}, \\varepsilon_{xy}, \\varepsilon_{yz}, \\varepsilon_{zx}]^\\mathsf{T}$）：\n  - $\\varepsilon_{xx} = \\sum_{i=0}^{7} (\\partial N_i/\\partial x)\\, u_{x,i}$，\n  - $\\varepsilon_{yy} = \\sum_{i=0}^{7} (\\partial N_i/\\partial y)\\, u_{y,i}$，\n  - $\\varepsilon_{zz} = \\sum_{i=0}^{7} (\\partial N_i/\\partial z)\\, u_{z,i}$，\n  - $\\varepsilon_{xy} = \\sum_{i=0}^{7} [(\\partial N_i/\\partial x)\\, u_{y,i} + (\\partial N_i/\\partial y)\\, u_{x,i}]$，\n  - $\\varepsilon_{yz} = \\sum_{i=0}^{7} [(\\partial N_i/\\partial y)\\, u_{z,i} + (\\partial N_i/\\partial z)\\, u_{y,i}]$，\n  - $\\varepsilon_{zx} = \\sum_{i=0}^{7} [(\\partial N_i/\\partial z)\\, u_{x,i} + (\\partial N_i/\\partial x)\\, u_{z,i}]$，\n  其中 $u_{x,i}, u_{y,i}, u_{z,i}$ 是节点 $i$ 的位移分量。\n- 使用三维线性弹性的 Voigt 记法中的各向同性刚度矩阵 $\\mathbf{C}$：\n  - 根据杨氏模量 $E$ 和泊松比 $\\nu$ 计算 Lamé 参数 $\\lambda = \\dfrac{E \\nu}{(1+\\nu)(1-2\\nu)}$ 和 $G = \\dfrac{E}{2(1+\\nu)}$。\n  - 那么\n    $$\\mathbf{C} = \\begin{bmatrix}\n    \\lambda+2G  \\lambda  \\lambda  0  0  0 \\\\\n    \\lambda  \\lambda+2G  \\lambda  0  0  0 \\\\\n    \\lambda  \\lambda  \\lambda+2G  0  0  0 \\\\\n    0  0  0  G  0  0 \\\\\n    0  0  0  0  G  0 \\\\\n    0  0  0  0  0  G\n    \\end{bmatrix}. $$\n\n沙漏幅值提取：\n- 对八个节点使用四个标准的 Flanagan–Belytschko 沙漏向量 $\\mathbf{H}_\\alpha$（$\\alpha=1,2,3,4$）：\n  - $\\mathbf{H}_1 = [\\, +1,-1,+1,-1,-1,+1,-1,+1 \\,]$,\n  - $\\mathbf{H}_2 = [\\, +1,+1,-1,-1,-1,-1,+1,+1 \\,]$,\n  - $\\mathbf{H}_3 = [\\, +1,-1,-1,+1,-1,+1,+1,-1 \\,]$,\n  - $\\mathbf{H}_4 = [\\, +1,+1,+1,+1,-1,-1,-1,-1 \\,]$.\n- 通过为每个模式构建三个特定分量的行来定义尺寸为 $12 \\times 24$ 的沙漏提取算子 $\\mathbf{Q}$：\n  - 对于每个模式 $\\alpha$ 和分量 $c \\in \\{x,y,z\\}$，定义 $q_{\\alpha c} = \\sum_{i=0}^{7} H_{\\alpha,i} \\, u_{c,i}$。\n  - 将这些堆叠成向量 $\\mathbf{q} \\in \\mathbb{R}^{12}$，形式为 $\\mathbf{q} = [q_{1x},q_{1y},q_{1z},q_{2x},\\dots,q_{4z}]^\\mathsf{T}$，因此 $\\mathbf{q} = \\mathbf{Q} \\mathbf{u}$，其中 $\\mathbf{u} \\in \\mathbb{R}^{24}$ 是节点位移向量，排序为 $(u_{x,0},u_{y,0},u_{z,0},\\dots,u_{x,7},u_{y,7},u_{z,7})$。\n\n自适应法则目标：\n- 通过在当前状态下自适应地选择 $c_h$，为给定的 $\\eta > 0$ 维持 $W_h/W_e \\le \\eta$。假设 $W_h = \\frac{1}{2} c_h \\, G \\, V \\, \\|\\mathbf{q}\\|^2$。\n- 根据 $E$、$\\nu$、$V$、$\\mathbf{B}$、$\\mathbf{C}$、$\\mathbf{Q}$ 和 $\\mathbf{u}$，推导 $c_h$ 的表达式，并遵守约束 $W_h/W_e \\le \\eta$。\n\n边界和退化情况处理：\n- 如果 $\\|\\mathbf{q}\\|^2 = 0$，则将 $c_h$ 设置为给定的基准值 $c_h^{\\text{base}}$。\n- 否则，如果 $W_e = 0$ 且 $\\|\\mathbf{q}\\|^2 > 0$，则设置 $c_h = 0$。\n- 否则，将 $c_h$ 选择为 $c_h^{\\text{base}}$ 和通过精确强制 $W_h/W_e = \\eta$ 所得值中的较小者。\n\n单位和最终答案：\n- 使用国际单位制：$E$ 单位为 $\\mathrm{Pa}$，位移 $u$ 单位为 $\\mathrm{m}$，体积 $V$ 单位为 $\\mathrm{m}^3$。输出 $c_h$ 是无量纲的。不涉及角度单位。\n- 您的程序必须为下面的测试套件计算 $c_h$，并打印包含四个浮点值 $[c_{h,1},c_{h,2},c_{h,3},c_{h,4}]$ 列表的单行，其中每个条目对应一个测试案例。\n\n测试套件规格：\n- 通用几何：使用列出的节点自然坐标，$V = 1.0$。\n- 完全按照上述描述构建 $\\mathbf{B}$ 和 $\\mathbf{Q}$。\n- 案例 1（一般混合状态）：\n  - $E = 210 \\times 10^9$, $\\nu = 0.30$, $\\eta = 0.05$, $c_h^{\\text{base}} = 0.15$。\n  - 位移是线性场和沙漏内容的叠加：\n    - 线性场由 $u_{x,i} = a_0 + a_1 \\xi_i + a_2 \\eta_i + a_3 \\zeta_i$ 定义，其中 $(a_0,a_1,a_2,a_3) = (0, 1.0\\times 10^{-3}, 2.0\\times 10^{-3}, -1.0\\times 10^{-3})$；\n      $u_{y,i} = b_0 + b_1 \\xi_i + b_2 \\eta_i + b_3 \\zeta_i$，其中 $(b_0,b_1,b_2,b_3) = (0, -0.5\\times 10^{-3}, 1.0\\times 10^{-3}, 0.5\\times 10^{-3})$；\n      $u_{z,i} = c_0 + c_1 \\xi_i + c_2 \\eta_i + c_3 \\zeta_i$，其中 $(c_0,c_1,c_2,c_3) = (0, 0.8\\times 10^{-3}, -1.2\\times 10^{-3}, 0.3\\times 10^{-3})$。\n    - 添加沙漏分量：将 $2.0\\times 10^{-4} \\times \\mathbf{H}_1$ 添加到 $u_x$，将 $1.0\\times 10^{-4} \\times \\mathbf{H}_2$ 添加到 $u_y$，将 $1.5\\times 10^{-4} \\times \\mathbf{H}_3$ 添加到 $u_z$。\n- 案例 2（主导沙漏，低弹性应变能）：\n  - $E = 70 \\times 10^9$, $\\nu = 0.33$, $\\eta = 0.02$, $c_h^{\\text{base}} = 0.10$。\n  - 位移纯为沙漏模式：$u_x = 1.0\\times 10^{-3} \\times \\mathbf{H}_4$，$u_y = 1.0\\times 10^{-3} \\times \\mathbf{H}_4$，$u_z = 0.5\\times 10^{-3} \\times \\mathbf{H}_4$。\n- 案例 3（纯线性场，无沙漏激活）：\n  - $E = 100 \\times 10^9$, $\\nu = 0.25$, $\\eta = 0.10$, $c_h^{\\text{base}} = 0.20$。\n  - 位移是纯线性的，其中 $(a_0,a_1,a_2,a_3) = (0, 0.5\\times 10^{-3}, -0.8\\times 10^{-3}, 0.6\\times 10^{-3})$，$(b_0,b_1,b_2,b_3) = (0, -0.3\\times 10^{-3}, 0.7\\times 10^{-3}, -0.2\\times 10^{-3})$，$(c_0,c_1,c_2,c_3) = (0, 0.4\\times 10^{-3}, 0.1\\times 10^{-3}, -0.5\\times 10^{-3})$。\n- 案例 4（刚体平移）：\n  - $E = 100 \\times 10^9$, $\\nu = 0.25$, $\\eta = 0.10$, $c_h^{\\text{base}} = 0.20$。\n  - 位移是恒定的：对于所有节点 $i$，$u_{x,i} = u_{y,i} = u_{z,i} = 1.0\\times 10^{-3}$。\n\n最终输出格式要求：\n- 您的程序应生成单行输出，包含一个用方括号括起来的逗号分隔列表的结果，例如 $[c_{h,1},c_{h,2},c_{h,3},c_{h,4}]$。", "solution": "该问题要求推导并实现一个针对八节点三线性六面体有限元（使用单点积分）的无量纲沙漏系数（记为 $c_h$）的自适应法则。该法则必须确保沙漏能 $W_h$ 与弹性应变能 $W_e$ 的比率保持在预设容差 $\\eta$ 的范围内。\n\n推导过程从提供的基本原理和定义出发。\n\n单元的弹性应变能由下式给出：\n$$ W_e = \\frac{1}{2} \\boldsymbol{\\varepsilon}^\\mathsf{T} \\mathbf{C} \\, \\boldsymbol{\\varepsilon} \\, V $$\n其中 $\\boldsymbol{\\varepsilon} \\in \\mathbb{R}^6$ 是 Voigt 记法下的应变向量，$\\mathbf{C} \\in \\mathbb{R}^{6 \\times 6}$ 是对称正定的材料刚度矩阵，$V$ 是单元体积。应变 $\\boldsymbol{\\varepsilon}$ 通过应变-位移矩阵 $\\mathbf{B} \\in \\mathbb{R}^{6 \\times 24}$ 与节点位移向量 $\\mathbf{u} \\in \\mathbb{R}^{24}$ 线性相关，即 $\\boldsymbol{\\varepsilon} = \\mathbf{B} \\mathbf{u}$。\n\n沙漏稳定能建模为：\n$$ W_h = \\frac{1}{2} k_h \\, \\| \\mathbf{q} \\|^2 $$\n其中 $\\mathbf{q} \\in \\mathbb{R}^{12}$ 是沙漏模式幅值向量，$k_h$ 是标量沙漏刚度。沙漏幅值通过算子 $\\mathbf{Q} \\in \\mathbb{R}^{12 \\times 24}$ 从节点位移中提取，使得 $\\mathbf{q} = \\mathbf{Q} \\mathbf{u}$。沙漏刚度 $k_h$ 由无量纲系数 $c_h$、材料剪切模量 $G$ 和单元体积 $V$ 定义：\n$$ k_h = c_h \\, G \\, V $$\n\n核心目标是维持以下不等式：\n$$ \\frac{W_h}{W_e} \\le \\eta $$\n其中 $\\eta > 0$ 是一个无量纲容差。\n\n将 $W_h$ 和 $W_e$ 的表达式代入此不等式，我们得到：\n$$ \\frac{\\frac{1}{2} k_h \\, \\| \\mathbf{q} \\|^2}{\\frac{1}{2} \\boldsymbol{\\varepsilon}^\\mathsf{T} \\mathbf{C} \\, \\boldsymbol{\\varepsilon} \\, V} \\le \\eta $$\n代入 $k_h$ 的表达式，得到：\n$$ \\frac{\\frac{1}{2} (c_h \\, G \\, V) \\, \\| \\mathbf{q} \\|^2}{\\frac{1}{2} \\boldsymbol{\\varepsilon}^\\mathsf{T} \\mathbf{C} \\, \\boldsymbol{\\varepsilon} \\, V} \\le \\eta $$\n假设单元体积 $V$ 非零，分子和分母中的项 $\\frac{1}{2}$ 和 $V$ 可以消去，表达式简化为：\n$$ \\frac{c_h \\, G \\, \\| \\mathbf{q} \\|^2}{\\boldsymbol{\\varepsilon}^\\mathsf{T} \\mathbf{C} \\, \\boldsymbol{\\varepsilon}} \\le \\eta $$\n\n为了确定满足此标准的 $c_h$ 值，我们考虑比率恰好等于 $\\eta$ 的边界情况。然后我们可以解出一个目标值 $c_h^{\\text{target}}$。这仅在分母项非零时才有意义，具体来说，是当单元正在经历某种沙漏变形（$\\| \\mathbf{q} \\|^2 > 0$）且具有非零应变能（$W_e > 0$，这意味着 $\\boldsymbol{\\varepsilon}^\\mathsf{T} \\mathbf{C} \\, \\boldsymbol{\\varepsilon} > 0$）时。\n$$ c_h \\, G \\, \\| \\mathbf{q} \\|^2 = \\eta \\, (\\boldsymbol{\\varepsilon}^\\mathsf{T} \\mathbf{C} \\, \\boldsymbol{\\varepsilon}) $$\n解出 $c_h$，得到目标系数：\n$$ c_h^{\\text{target}} = \\eta \\frac{\\boldsymbol{\\varepsilon}^\\mathsf{T} \\mathbf{C} \\, \\boldsymbol{\\varepsilon}}{G \\, \\| \\mathbf{q} \\|^2} $$\n\n问题指定了一个完整的自适应法则，该法则整合了此推导并处理了退化情况：\n1.  **如果 $\\| \\mathbf{q} \\|^2 = 0$：** 这表示没有沙漏现象。无论 $c_h$ 为何值，沙漏能 $W_h$ 均为零。在这种情况下，不需要自适应控制，使用预定义的基准值 $c_h^{\\text{base}}$。因此，$c_h = c_h^{\\text{base}}$。\n2.  **否则，如果 $W_e = 0$ 且 $\\| \\mathbf{q} \\|^2 > 0$：** 这对应于纯沙漏模式，根据定义，它在单元的积分点处产生零应变。$c_h^{\\text{target}}$ 表达式的分子为零，导致 $c_h^{\\text{target}} = 0$。法则规定设置 $c_h = 0$。这可以防止添加稳定能，因为这会导致比率 $W_h/W_e$ 变为无穷大。\n3.  **否则（一般情况，其中 $W_e > 0$ 且 $\\| \\mathbf{q} \\|^2 > 0$）：** 推导出的目标值 $c_h^{\\text{target}}$ 使能量比率恰好等于 $\\eta$。为确保比率至多为 $\\eta$，任何 $c_h \\le c_h^{\\text{target}}$ 都是有效的。为了防止系数变得过大（可能导致数值锁定），它被限制在基准值。因此，法则是选择两者中的较小者：\n    $$ c_h = \\min(c_h^{\\text{base}}, c_h^{\\text{target}}) $$\n\n实现将为每个测试案例构建必要的矩阵（$\\mathbf{B}$, $\\mathbf{C}$, $\\mathbf{Q}$）和向量（$\\mathbf{u}$），计算能量，并应用这个三部分法则来确定 $c_h$ 的最终值。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef calculate_ch(E, nu, eta, c_h_base, u_params):\n    \"\"\"\n    Computes the adaptive hourglass coefficient c_h for a single test case.\n    \"\"\"\n    # 1. Define Element Geometry and Kinematics\n    V = 1.0\n    # Natural coordinates for nodes 0-7\n    coords = np.array([\n        [-1, -1, -1], [1, -1, -1], [1, 1, -1], [-1, 1, -1],\n        [-1, -1, 1], [1, -1, 1], [1, 1, 1], [-1, 1, 1]\n    ])\n    \n    # Flanagan-Belytschko hourglass vectors\n    H_vectors = np.array([\n        [1, -1, 1, -1, -1, 1, -1, 1],\n        [1, 1, -1, -1, -1, -1, 1, 1],\n        [1, -1, -1, 1, -1, 1, 1, -1],\n        [1, 1, 1, 1, -1, -1, -1, -1]\n    ])\n    \n    # 2. Material Properties and Stiffness Matrix (C)\n    lam = (E * nu) / ((1 + nu) * (1 - 2 * nu))\n    G = E / (2 * (1 + nu))\n    \n    C = np.zeros((6, 6))\n    C[0, 0] = C[1, 1] = C[2, 2] = lam + 2 * G\n    C[0, 1] = C[0, 2] = C[1, 0] = C[1, 2] = C[2, 0] = C[2, 1] = lam\n    C[3, 3] = C[4, 4] = C[5, 5] = G\n    \n    # 3. Construct Strain-Displacement Matrix (B)\n    B = np.zeros((6, 24))\n    for i in range(8):\n        xi, yi, zi = coords[i]\n        dNi_dx = xi / 4.0\n        dNi_dy = yi / 4.0\n        dNi_dz = zi / 4.0\n        \n        # B_i block for node i\n        B_i = np.array([\n            [dNi_dx, 0, 0],\n            [0, dNi_dy, 0],\n            [0, 0, dNi_dz],\n            [dNi_dy, dNi_dx, 0],\n            [0, dNi_dz, dNi_dy],\n            [dNi_dz, 0, dNi_dx]\n        ])\n        \n        B[:, 3*i:3*i+3] = B_i\n\n    # 4. Construct Hourglass Extraction Matrix (Q)\n    Q = np.zeros((12, 24))\n    for alpha in range(4):  # Loop over H vectors\n        for c in range(3):  # Loop over components x, y, z\n            row = 3 * alpha + c\n            for i in range(8): # Loop over nodes\n                col = 3 * i + c\n                Q[row, col] = H_vectors[alpha, i]\n                \n    # 5. Construct Nodal Displacement Vector (u)\n    u = np.zeros(24)\n    if 'linear' in u_params:\n        ax, ay, az = u_params['linear']\n        for i in range(8):\n            xi, yi, zi = coords[i]\n            u[3*i + 0] = ax[0] + ax[1]*xi + ax[2]*yi + ax[3]*zi\n            u[3*i + 1] = ay[0] + ay[1]*xi + ay[2]*yi + ay[3]*zi\n            u[3*i + 2] = az[0] + az[1]*xi + az[2]*yi + az[3]*zi\n            \n    if 'hg' in u_params:\n        h_comps = u_params['hg']\n        for comp_idx, val, h_idx in h_comps: # (component, value, H_vector_index)\n            for i in range(8):\n                u[3*i + comp_idx] += val * H_vectors[h_idx-1, i]\n\n    if 'const' in u_params:\n        u[:] = u_params['const']\n\n    # 6. Calculate Key Quantities and Apply Adaptive Rule\n    q = Q @ u\n    q_norm_sq = np.dot(q, q)\n    \n    # Check for near-zero hourglass norm\n    if q_norm_sq  1e-30:\n        return c_h_base\n        \n    epsilon = B @ u\n    strain_energy_density_term = epsilon.T @ C @ epsilon\n    \n    We = 0.5 * strain_energy_density_term * V\n    \n    # Check for near-zero elastic energy\n    if We  1e-20:\n        return 0.0\n        \n    # General case\n    c_h_target = eta * strain_energy_density_term / (G * q_norm_sq)\n    \n    return min(c_h_base, c_h_target)\n\ndef solve():\n    # Test cases defined in the problem statement\n    test_cases = [\n        {\n            \"E\": 210e9, \"nu\": 0.30, \"eta\": 0.05, \"c_h_base\": 0.15,\n            \"u_params\": {\n                \"linear\": [\n                    (0, 1.0e-3, 2.0e-3, -1.0e-3),\n                    (0, -0.5e-3, 1.0e-3, 0.5e-3),\n                    (0, 0.8e-3, -1.2e-3, 0.3e-3)\n                ],\n                \"hg\": [\n                    (0, 2.0e-4, 1), # u_x component, value, H1\n                    (1, 1.0e-4, 2), # u_y component, value, H2\n                    (2, 1.5e-4, 3)  # u_z component, value, H3\n                ]\n            }\n        },\n        {\n            \"E\": 70e9, \"nu\": 0.33, \"eta\": 0.02, \"c_h_base\": 0.10,\n            \"u_params\": {\n                \"hg\": [\n                    (0, 1.0e-3, 4),\n                    (1, 1.0e-3, 4),\n                    (2, 0.5e-3, 4)\n                ]\n            }\n        },\n        {\n            \"E\": 100e9, \"nu\": 0.25, \"eta\": 0.10, \"c_h_base\": 0.20,\n            \"u_params\": {\n                \"linear\": [\n                    (0, 0.5e-3, -0.8e-3, 0.6e-3),\n                    (0, -0.3e-3, 0.7e-3, -0.2e-3),\n                    (0, 0.4e-3, 0.1e-3, -0.5e-3)\n                ]\n            }\n        },\n        {\n            \"E\": 100e9, \"nu\": 0.25, \"eta\": 0.10, \"c_h_base\": 0.20,\n            \"u_params\": {\n                \"const\": 1.0e-3\n            }\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        c_h = calculate_ch(case[\"E\"], case[\"nu\"], case[\"eta\"], case[\"c_h_base\"], case[\"u_params\"])\n        results.append(c_h)\n\n    print(f\"[{','.join(f'{r:.8f}' for r in results)}]\")\n\nsolve()\n```", "id": "3571380"}]}