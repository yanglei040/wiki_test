{"hands_on_practices": [{"introduction": "在有限元分析中，直接在全局方程组中施加狄利克雷（Dirichlet）边界条件虽然精确，但在编程实现上可能较为繁琐。罚函数法提供了一种在变分框架内施加本质边界条件的灵活且易于实现的替代方案。本练习旨在通过一个一维弹性杆的经典问题，让您亲手实现罚函数法，并探索罚参数 $ \\beta $ 的选择以及网格密度对求解精度的影响，这是掌握弱边界条件施加方法的关键一步 [@problem_id:3504185]。", "problem": "一维线性弹性杆占据区间 $[0,L]$，其横截面积 $A$ 和杨氏模量 $E$ 为常数。未知的轴向位移场为 $u(x)$。对于无体力作用的杆，其平衡强形式为 $ \\dfrac{d}{dx}\\left(EA \\dfrac{du}{dx}\\right)=0 $，其中 $x\\in(0,L)$。在 $x=0$ 处规定了狄利克雷边界条件 $u(0)=\\bar u$，在 $x=L$ 处规定了诺伊曼边界条件 $EA\\,u'(L)=\\bar N$。从虚功原理（PVW）和使用线性形函数的基本有限元插值出发，推导其弱形式。该弱形式应通过罚函数法引入狄利克雷边界条件，并以其自然形式包含诺伊曼边界条件。仔细论证罚参数随网格尺寸变化的标度关系。\n\n实现一个程序，为 $[0,L]$ 上的 $N$ 个线性单元组成的均匀网格组装全局刚度矩阵和载荷向量，通过带有罚参数 $\\beta$ 的罚项施加 $u(0)=\\bar u$，将 $x=L$ 处的牵引力作为自然边界项施加，并求解最终的线性系统以获得节点位移。对于罚参数，使用与网格相关的标度关系 $\\beta=\\alpha\\,EA/h$，其中 $h=L/N$ 且 $\\alpha>0$ 是一个无量纲的调节参数。对于每个测试用例，计算边界位移的绝对误差 $e_0=\\lvert u_h(0)-\\bar u\\rvert$，单位为米，其中 $u_h(0)$ 是在 $x=0$ 处的有限元近似解。\n\n使用以下在计算岩土力学中常见的物理上和数值上均符合实际的参数：$E=50\\times 10^6$ 帕斯卡，$A=1.0$ 平方米，$L=10.0$ 米，$\\bar N=1.0\\times 10^5$ 牛顿，以及 $\\bar u=0.0$ 米。这些值对应于一个承受中等轴向端部载荷的刚性土工材料杆。在这些边界条件下，其精确解析解为 $u(x)=\\dfrac{\\bar N}{EA}\\,x$，该解满足 $u(0)=0$ 和 $EA\\,u'(L)=\\bar N$。\n\n程序必须评估以下 $(\\alpha,N)$ 对的测试套件，以评估罚参数大小和网格细化效应：\n- $(\\alpha,N)=\\left(10^{-2},5\\right)$,\n- $(\\alpha,N)=\\left(10^{-2},20\\right)$,\n- $(\\alpha,N)=\\left(10^{-2},80\\right)$,\n- $(\\alpha,N)=\\left(10^{0},5\\right)$,\n- $(\\alpha,N)=\\left(10^{0},20\\right)$,\n- $(\\alpha,N)=\\left(10^{0},80\\right)$,\n- $(\\alpha,N)=\\left(10^{2},5\\right)$,\n- $(\\alpha,N)=\\left(10^{2},20\\right)$,\n- $(\\alpha,N)=\\left(10^{2},80\\right)$.\n\n对于每个测试用例，计算并返回单个标量 $e_0$，单位为米。您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔的结果列表（例如，$[\\text{result}_1,\\text{result}_2,\\dots,\\text{result}_9]$）。所有位移误差必须在该单行输出中以浮点数形式表示，单位为米（m），并按测试套件指定的顺序排列。", "solution": "问题陈述完整、科学上合理且适定。它提出了一个一维计算固体力学中的标准问题，要求推导并实现用于处理带混合边界条件的线性弹性杆的有限元方法。其物理参数和数值方法是标准的，并且适用于计算岩土力学领域。因此，我们可以开始求解。\n\n求解过程从虚功原理（PVW）开始，该原理提供了基于积分的平衡问题弱形式。对于无体力作用的一维杆，虚功原理指出，对于任何运动学上容许的虚位移场 $\\delta u(x)$，其内虚功必须等于外虚功。\n\n内虚功是虚应变能密度在整个域上的积分：\n$$ \\delta W_{int} = \\int_{0}^{L} \\sigma(x) \\delta\\epsilon(x) A \\,dx $$\n此处，$\\sigma(x)$ 是轴向应力，$\\delta\\epsilon(x)$ 是虚轴向应变，$A$ 是恒定的横截面积。域为区间 $[0, L]$。\n\n外虚功是外力通过虚位移所做的功。在此问题中，唯一的外力是施加在 $x=L$ 处的点载荷 $\\bar N$。因此，外虚功为：\n$$ \\delta W_{ext} = \\bar N \\delta u(L) $$\n\n线性弹性的本构关系为 $\\sigma(x) = E \\epsilon(x)$，其中 $E$ 是杨氏模量。应变-位移运动学关系为 $\\epsilon(x) = \\dfrac{du}{dx}$。虚应变与虚位移的关系类似：$\\delta\\epsilon(x) = \\dfrac{d(\\delta u)}{dx}$。\n\n将这些关系代入虚功原理表达式（$\\delta W_{int} = \\delta W_{ext}$），得到平衡方程的弱形式：\n求 $u(x)$，使得 $u(0)=\\bar u$，并且对于所有容许的虚位移 $\\delta u(x)$（在经典的 Galerkin 公式中，$\\delta u(0) = 0$）满足：\n$$ \\int_{0}^{L} EA \\dfrac{du}{dx} \\dfrac{d(\\delta u)}{dx} \\,dx = \\bar N \\delta u(L) $$\n该方程是我们有限元公式的基础。Neumann 边界条件 $EA u'(L) = \\bar N$ 作为右侧的一个功项被自然地并入弱形式中，因此被称为自然边界条件。Dirichlet 边界条件 $u(0)=\\bar u$ 是一个本质边界条件，必须单独施加。\n\n为数值求解此问题，我们采用有限元法。将域 $[0,L]$ 离散为 $N$ 个等长的线性单元，单元长度 $h = L/N$。总节点数为 $n_{nodes} = N+1$。在每个从全局坐标 $x_i$ 延伸到 $x_{i+1}$ 的单元 $e$ 内，位移场 $u^{(e)}(x)$ 使用线性形函数 $N_i(x)$ 和节点位移 $d_i$ 进行近似：\n$$ u^{(e)}(x) = N_i(x) d_i + N_{i+1}(x) d_{i+1} $$\n类似地，虚位移近似为：\n$$ \\delta u^{(e)}(x) = N_i(x) \\delta d_i + N_{i+1}(x) \\delta d_{i+1} $$\n单元内的应变通过对位移近似求导得出：\n$$ \\dfrac{du^{(e)}}{dx} = \\dfrac{dN_i}{dx} d_i + \\dfrac{dN_{i+1}}{dx} d_{i+1} = \\dfrac{1}{h} \\begin{bmatrix} -1  1 \\end{bmatrix} \\begin{Bmatrix} d_i \\\\ d_{i+1} \\end{Bmatrix} = \\mathbf{B}^{(e)} \\mathbf{d}^{(e)} $$\n此处，$\\mathbf{B}^{(e)}$ 是单元的应变-位移矩阵。\n\n弱形式积分是作为所有单元的总和来计算的。对于单个单元 $e$，其对内虚功的贡献为：\n$$ (\\delta\\mathbf{d}^{(e)})^T \\left( \\int_{x_i}^{x_{i+1}} (\\mathbf{B}^{(e)})^T EA \\mathbf{B}^{(e)} \\,dx \\right) \\mathbf{d}^{(e)} = (\\delta\\mathbf{d}^{(e)})^T \\mathbf{k}^{(e)} \\mathbf{d}^{(e)} $$\n项 $\\mathbf{k}^{(e)}$ 是单元刚度矩阵。由于 $\\mathbf{B}^{(e)}$、$E$ 和 $A$ 在单元内是常数，该积分很简单：\n$$ \\mathbf{k}^{(e)} = \\int_{0}^{h} \\left(\\dfrac{EA}{h^2} \\begin{bmatrix} 1  -1 \\\\ -1  1 \\end{bmatrix}\\right) dx' = \\dfrac{EA}{h} \\begin{bmatrix} 1  -1 \\\\ -1  1 \\end{bmatrix} $$\n单元刚度矩阵被组装成一个全局 $(N+1) \\times (N+1)$ 刚度矩阵 $\\mathbf{K}$。施加边界条件前的全局方程组为 $\\mathbf{K}\\mathbf{d} = \\mathbf{F}$，其中 $\\mathbf{d}$ 是全局节点位移向量，$\\mathbf{F}$ 是全局力向量。在 $x=L$（节点 $N$）处的自然边界条件为 $\\mathbf{F}$ 的第 $N$ 个分量贡献了 $\\bar N$。\n\nDirichlet 条件 $u(0)=\\bar u$（或 $d_0=\\bar u$）通过罚函数法施加。此方法通过增加一个罚项来修正系统的总势能 $\\Pi$：\n$$ \\Pi_{pen} = \\Pi + \\dfrac{1}{2} \\beta (u(0) - \\bar u)^2 = \\dfrac{1}{2} \\int_{0}^{L} EA \\left(\\dfrac{du}{dx}\\right)^2 dx - \\bar N u(L) + \\dfrac{1}{2} \\beta (u(0) - \\bar u)^2 $$\n其中 $\\beta \\gg 0$ 是罚参数。对 $\\Pi_{pen}$ 取变分并令其为零（$\\delta \\Pi_{pen}=0$），得到修正后的弱形式：\n$$ \\int_{0}^{L} EA \\dfrac{du}{dx} \\dfrac{d(\\delta u)}{dx} \\,dx + \\beta (u(0)-\\bar u)\\delta u(0) = \\bar N \\delta u(L) $$\n在离散系统中，此修改影响节点 $0$ 的方程：\n$$ (\\mathbf{K}\\mathbf{d})_0 + \\beta (d_0 - \\bar u) = F_0 $$\n这通过将 $\\beta$ 加到对角刚度项 $K_{0,0}$ 并将 $\\beta \\bar u$ 加到力项 $F_0$ 来实现。修正后的方程组 $\\mathbf{K}_{pen}\\mathbf{d} = \\mathbf{F}_{pen}$ 为：\n$$ K_{0,0} \\rightarrow K_{0,0} + \\beta $$\n$$ F_0 \\rightarrow F_0 + \\beta \\bar u $$\n问题指定罚参数的标度关系为 $\\beta = \\alpha \\dfrac{EA}{h}$。节点 $0$ 处的物理刚度主要由第一个单元贡献，即 $K_{0,0} = \\dfrac{EA}{h}$。修正后的刚度项变为 $K'_{0,0} = \\dfrac{EA}{h} + \\alpha \\dfrac{EA}{h} = (1+\\alpha)\\dfrac{EA}{h}$。这种标度关系确保了罚刚度与物理刚度之比由无量纲参数 $\\alpha$ 给出。它使得罚函数强度的选择与网格尺寸 $h$ 无关。为使该方法有效，$\\alpha$ 应足够大（例如，$\\alpha \\gg 1$）以精确施加约束，但又不能大到导致矩阵 $\\mathbf{K}_{pen}$ 出现数值病态。\n\n将要实现的算法如下：\n1.  对每个测试用例 $(\\alpha, N)$，定义网格参数：$h=L/N$ 和 $n_{nodes}=N+1$。\n2.  计算罚参数 $\\beta = \\alpha\\,EA/h$。\n3.  初始化大小为 $(N+1) \\times (N+1)$ 的全局刚度矩阵 $\\mathbf{K}$ 和大小为 $(N+1)$ 的全局力向量 $\\mathbf{F}$ 为零。\n4.  计算单元刚度矩阵 $\\mathbf{k}^{(e)} = \\dfrac{EA}{h} \\begin{bmatrix} 1  -1 \\\\ -1  1 \\end{bmatrix}$。\n5.  通过遍历所有 $N$ 个单元并将其贡献添加到全局矩阵中来组装 $\\mathbf{K}$。\n6.  通过设置力向量的最后一个分量 $F_N = \\bar N$ 来施加自然边界条件。\n7.  通过修改系统的第一行/列来施加罚函数 Dirichlet 边界条件：$K_{0,0} \\leftarrow K_{0,0} + \\beta$ 和 $F_0 \\leftarrow F_0 + \\beta\\bar u$。\n8.  求解线性系统 $\\mathbf{K}\\mathbf{d} = \\mathbf{F}$ 以获得节点位移向量 $\\mathbf{d}$。\n9.  计算边界位移误差 $e_0 = |d_0 - \\bar u|$。由于 $\\bar u=0.0$，这简化为 $e_0 = |d_0|$。\n10. 存储结果并对所有测试用例重复此过程。\n\n让我们指定用于计算的参数：\n- 杨氏模量：$E = 50 \\times 10^6$ Pa\n- 横截面积：$A = 1.0$ m$^2$\n- 杆长：$L = 10.0$ m\n- 给定位移：$\\bar u = 0.0$ m\n- 给定力：$\\bar N = 1.0 \\times 10^5$ N\n- 测试套件：$(\\alpha, N)$ 对为 $\\left(10^{-2},5\\right)$、$\\left(10^{-2},20\\right)$、$\\left(10^{-2},80\\right)$、$\\left(10^{0},5\\right)$、$\\left(10^{0},20\\right)$、$\\left(10^{0},80\\right)$、$\\left(10^{2},5\\right)$、$\\left(10^{2},20\\right)$ 和 $\\left(10^{2},80\\right)$。\n计算将为误差 $e_0$ 产生九个值，这些值将以指定格式报告。精确位移的解析解 $u(x) = \\dfrac{\\bar N}{EA}x$ 证实了 $u(0)=0$，因此 $u_h(0)$ 的任何非零值都是由罚函数法的近似误差引起的。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n# No scipy needed, numpy.linalg.solve is sufficient.\n\ndef solve():\n    \"\"\"\n    Solves the 1D elastic bar problem using the Finite Element Method \n    with penalty imposition of Dirichlet boundary conditions.\n    \"\"\"\n\n    # Define physical and material parameters from the problem statement\n    E = 50.0e6  # Young's modulus in Pascals (Pa)\n    A = 1.0     # Cross-sectional area in square meters (m^2)\n    L = 10.0    # Length of the bar in meters (m)\n    N_bar = 1.0e5 # Applied axial force at x=L in Newtons (N)\n    u_bar = 0.0   # Prescribed displacement at x=0 in meters (m)\n\n    # Define the test suite of (alpha, N) pairs\n    test_cases = [\n        (1e-2, 5),\n        (1e-2, 20),\n        (1e-2, 80),\n        (1e0, 5),\n        (1e0, 20),\n        (1e0, 80),\n        (1e2, 5),\n        (1e2, 20),\n        (1e2, 80),\n    ]\n\n    results = []\n    for alpha, N in test_cases:\n        # 1. Preprocessing and Mesh Definition\n        h = L / N                  # Element length\n        num_nodes = N + 1          # Number of nodes\n        \n        # 2. Calculate Penalty Parameter\n        # As per the problem, beta = alpha * E * A / h\n        beta = alpha * E * A / h\n\n        # 3. Element Stiffness Matrix Calculation\n        # For a 1D linear bar element, k_e = (EA/h) * [[1, -1], [-1, 1]]\n        elem_stiffness = (E * A / h) * np.array([[1.0, -1.0], [-1.0, 1.0]])\n\n        # 4. Assembly of Global Stiffness Matrix and Force Vector\n        # Initialize global matrix and vector with zeros\n        K = np.zeros((num_nodes, num_nodes))\n        F = np.zeros(num_nodes)\n\n        # Assemble the stiffness matrix by looping through elements\n        for i in range(N):\n            # Global indices for the element connecting nodes i and i+1\n            g_indices = [i, i + 1]\n            # Add element stiffness contribution to the global matrix\n            K[np.ix_(g_indices, g_indices)] += elem_stiffness\n\n        # 5. Application of Boundary Conditions\n        # a) Natural Boundary Condition (Neumann)\n        # Add the point load N_bar to the last node's force component.\n        F[N] += N_bar\n\n        # b) Essential Boundary Condition (Dirichlet) via Penalty Method\n        # Modify the stiffness and force for the constrained DOF (node 0)\n        # K_00 = K_00 + beta\n        K[0, 0] += beta\n        # F_0 = F_0 + beta * u_bar\n        F[0] += beta * u_bar\n\n        # 6. Solve the Linear System\n        # Solve Kd = F for the nodal displacement vector d\n        d = np.linalg.solve(K, F)\n\n        # 7. Post-processing: Calculate Error\n        # The FEA displacement at x=0 is the first component of the solution vector.\n        u_h_at_0 = d[0]\n        # Calculate the absolute boundary displacement error.\n        e0 = abs(u_h_at_0 - u_bar)\n\n        results.append(e0)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3504185"}, {"introduction": "与必须强制施加的狄利克雷边界条件不同，诺伊曼（Neumann）边界条件（如面力）在虚功原理中作为外力功自然出现，因此被称为自然边界条件。本练习将引导您为一个二维四边形单元实现两种常见的面力荷载向量组装方法：“一致”荷载向量和“集总”荷载向量。通过执行一个“单元检验”（patch test），您将能够量化这两种方法在再现恒定应力状态时的准确性，从而深刻理解有限元程序开发中验证和确认的重要性 [@problem_id:3504177]。", "problem": "要求您从第一性原理出发，为平面应变线性弹性问题中的单个等参双线性四边形单元（记为 $\\text{Q4}$）边界上的均布牵引力，实现边界牵引（诺伊曼）载荷向量的组装，并比较所谓的“一致”与“集中”边界牵引向量在虚功原理意义下再现恒定应力斑块检验（patch test）的能力。\n\n您的推导应仅基于以下基本且被广泛接受的事实：\n- 小应变线性弹性运动学和本构律：工程应变向量 $\\boldsymbol{\\varepsilon} = [\\varepsilon_{xx}, \\varepsilon_{yy}, \\gamma_{xy}]^{\\mathsf{T}}$ 与位移场 $\\boldsymbol{u} = [u, v]^{\\mathsf{T}}$ 的关系为 $\\varepsilon_{xx} = \\partial u / \\partial x$、$\\varepsilon_{yy} = \\partial v / \\partial y$ 和 $\\gamma_{xy} = \\partial u / \\partial y + \\partial v / \\partial x$；柯西应力向量 $\\boldsymbol{\\sigma} = [\\sigma_{xx}, \\sigma_{yy}, \\sigma_{xy}]^{\\mathsf{T}}$ 通过一个对称正定的四阶张量与 $\\boldsymbol{\\varepsilon}$ 相关（对于平面应变下的各向同性材料，这特化为使用拉梅参数（Lamé parameters）的著名矩阵）。\n- 标准的伽辽金有限元法（FEM），使用等参双线性四边形形函数，用于刚度积分的精确 $2 \\times 2$ 高斯积分，以及用于次数至多为线性的直边线积分的精确 2 点高斯积分。\n- 虚功原理：对于任何容许的虚位移场，内虚功与外虚功平衡。在离散情况下，这意味着对于一个能产生恒定应力状态且可被精确表示的线性位移场，如果组装的诺伊曼载荷向量 $\\boldsymbol{f}_{\\mathrm{N}}$ 是通过一致方法计算的，那么全局内部节点力向量 $\\boldsymbol{f}_{\\mathrm{int}} = \\boldsymbol{K}\\boldsymbol{u}$ 应与其匹配。\n\n构建以下数值实验：\n- 考虑一个占据 $\\Omega = [0, L_x] \\times [0, L_y]$ 的单个矩形单元，其单位厚度为 $t = 1$。使用平面应变各向同性线性弹性模型，其杨氏模量为 $E$（单位：帕斯卡），泊松比为 $\\nu$（无量纲）。单元节点从左下角开始按逆时针顺序编号，单元的边是矩形的四个直边。\n- 选择一个目标恒定柯西应力向量 $\\boldsymbol{\\sigma}_0 = [\\sigma_{xx}^0, \\sigma_{yy}^0, \\sigma_{xy}^0]^{\\mathsf{T}}$（单位：帕斯卡），通过对平面应变本构矩阵求逆来计算相应的恒定工程应变向量 $\\boldsymbol{\\varepsilon}_0$。根据 $\\boldsymbol{\\varepsilon}_0$，定义精确的线性位移场\n  $\n  u(x,y) = \\varepsilon_{xx}^0 x + \\tfrac{1}{2}\\gamma_{xy}^0 y, \\quad\n  v(x,y) = \\tfrac{1}{2}\\gamma_{xy}^0 x + \\varepsilon_{yy}^0 y,\n  $\n  其刚体运动分量为零。通过在单元节点坐标处对 $\\boldsymbol{u}(x,y)$ 进行采样，来评估节点位移向量 $\\boldsymbol{u}$。\n- 使用精确的 $2 \\times 2$ 高斯积分和标准的 $\\text{Q4}$ 应变-位移矩阵 $\\boldsymbol{B}(\\xi,\\eta)$ 来组装单元刚度矩阵 $\\boldsymbol{K}_e$；然后组装全局刚度矩阵 $\\boldsymbol{K}$（在此，它与 $\\boldsymbol{K}_e$ 一致）。\n- 针对边界牵引场 $\\boldsymbol{t} = \\boldsymbol{\\sigma}_0 \\boldsymbol{n}$（其中 $\\boldsymbol{n}$ 是外法向单位向量），在整个边界 $\\partial\\Omega$ 上组装两个版本的全局诺伊曼牵引载荷向量：\n  1. 一致版本 $\\boldsymbol{f}_{\\mathrm{N}}^{\\mathrm{cons}}$，通过在每个直边上使用限制在边上的单元形函数和两点高斯积分，对 $\\boldsymbol{N}^{\\mathsf{T}}\\boldsymbol{t}$ 进行精确线积分计算。\n  2. 集中版本 $\\boldsymbol{f}_{\\mathrm{N}}^{\\mathrm{lump}}$，首先在每个边界边 $\\Gamma_e$ 上积分总边力 $\\int_{\\Gamma_e} \\boldsymbol{t}\\, \\mathrm{d}s$，然后将其均等地分配给两个边节点（边上的每个节点精确地获得总边力的一半）。\n- 无需求解任何平衡系统，评估内力向量 $\\boldsymbol{f}_{\\mathrm{int}} = \\boldsymbol{K}\\boldsymbol{u}$ 和残差\n  $\n  \\boldsymbol{r}_{\\mathrm{cons}} = \\boldsymbol{K}\\boldsymbol{u} - \\boldsymbol{f}_{\\mathrm{N}}^{\\mathrm{cons}}, \\quad\n  \\boldsymbol{r}_{\\mathrm{lump}} = \\boldsymbol{K}\\boldsymbol{u} - \\boldsymbol{f}_{\\mathrm{N}}^{\\mathrm{lump}}.\n  $\n  报告相对欧几里得范数\n  $\n  e_{\\mathrm{cons}} = \\dfrac{\\|\\boldsymbol{r}_{\\mathrm{cons}}\\|_2}{\\|\\boldsymbol{f}_{\\mathrm{N}}^{\\mathrm{cons}}\\|_2}, \\quad\n  e_{\\mathrm{lump}} = \\dfrac{\\|\\boldsymbol{r}_{\\mathrm{lump}}\\|_2}{\\|\\boldsymbol{f}_{\\mathrm{N}}^{\\mathrm{cons}}\\|_2}.\n  $\n  这些是无量纲数。一个接近机器精度的 $e_{\\mathrm{cons}}$ 值表示通过了恒定应力斑块检验，而 $e_{\\mathrm{lump}}$ 则量化了由集中化引入的误差。\n\n对以下参数集测试套件实现上述过程，所有测试均在平面应变和单位厚度下进行：\n- 测试 1：$E = 1000$，$\\nu = 0.25$，$L_x = 2.0$，$L_y = 1.0$，$\\boldsymbol{\\sigma}_0 = [5.0, 0.0, 0.0]^{\\mathsf{T}}$。\n- 测试 2：$E = 1000$，$\\nu = 0.25$，$L_x = 1.5$，$L_y = 0.8$，$\\boldsymbol{\\sigma}_0 = [0.0, 0.0, 4.0]^{\\mathsf{T}}$。\n- 测试 3：$E = 1000$，$\\nu = 0.25$，$L_x = 3.0$，$L_y = 0.5$，$\\boldsymbol{\\sigma}_0 = [2.0, -1.0, 3.0]^{\\mathsf{T}}$。\n\n所有模量单位为帕斯卡，所有长度单位为米。输出 $e_{\\mathrm{cons}}$ 和 $e_{\\mathrm{lump}}$ 是无量纲数，必须以十进制数形式报告。\n\n您的程序应产生单行输出，包含一个以逗号分隔的列表的列表形式的结果，其中每个内部列表按顺序对应一个测试，格式为 $[e_{\\mathrm{cons}}, e_{\\mathrm{lump}}]$。例如，输出必须类似于\n$[[e_1^{\\mathrm{cons}}, e_1^{\\mathrm{lump}}],[e_2^{\\mathrm{cons}}, e_2^{\\mathrm{lump}}],[e_3^{\\mathrm{cons}}, e_3^{\\mathrm{lump}}]]$\n其中每个 $e$ 以标准表示法下的浮点小数形式给出。不应打印任何额外文本。", "solution": "## 问题验证\n\n### 步骤 1：提取已知条件\n- **单元类型**：平面应变下的等参双线性四边形（$\\text{Q4}$）。\n- **单元几何**：一个占据 $\\Omega = [0, L_x] \\times [0, L_y]$ 的单个矩形单元，单位厚度 $t = 1$。\n- **节点排序**：从左下角 $(0,0)$ 开始逆时针排序。\n- **材料模型**：各向同性线性弹性，杨氏模量为 $E$，泊松比为 $\\nu$。\n- **目标状态**：一个恒定的柯西应力向量 $\\boldsymbol{\\sigma}_0 = [\\sigma_{xx}^0, \\sigma_{yy}^0, \\sigma_{xy}^0]^{\\mathsf{T}}$。\n- **精确位移场**：与 $\\boldsymbol{\\sigma}_0$ 对应的位移场（通过恒定应变 $\\boldsymbol{\\varepsilon}_0$）由 $u(x,y) = \\varepsilon_{xx}^0 x + \\tfrac{1}{2}\\gamma_{xy}^0 y$ 和 $v(x,y) = \\tfrac{1}{2}\\gamma_{xy}^0 x + \\varepsilon_{yy}^0 y$ 给出。\n- **节点位移**：向量 $\\boldsymbol{u}$ 是通过在四个单元节点处评估精确位移场得到的。\n- **刚度矩阵组装**：单元刚度矩阵 $\\boldsymbol{K}_e$ 使用精确的 $2 \\times 2$ 高斯积分进行组装。全局刚度 $\\boldsymbol{K}$ 与 $\\boldsymbol{K}_e$ 相同。\n- **边界牵引**：边界 $\\partial\\Omega$ 上的牵引力为 $\\boldsymbol{t} = \\boldsymbol{\\sigma}_0 \\boldsymbol{n}$，其中 $\\boldsymbol{n}$ 是外法向单位向量。\n- **一致载荷向量 ($\\boldsymbol{f}_{\\mathrm{N}}^{\\mathrm{cons}}$)**：通过在每条边上使用两点高斯积分来对 $\\boldsymbol{N}^{\\mathsf{T}}\\boldsymbol{t}$ 进行积分计算。\n- **集中载荷向量 ($\\boldsymbol{f}_{\\mathrm{N}}^{\\mathrm{lump}}$)**：通过积分每条边上的总力，并将其均等（50/50）地分配给两个边节点来计算。\n- **残差**：$\\boldsymbol{r}_{\\mathrm{cons}} = \\boldsymbol{K}\\boldsymbol{u} - \\boldsymbol{f}_{\\mathrm{N}}^{\\mathrm{cons}}$ 和 $\\boldsymbol{r}_{\\mathrm{lump}} = \\boldsymbol{K}\\boldsymbol{u} - \\boldsymbol{f}_{\\mathrm{N}}^{\\mathrm{lump}}$。\n- **误差度量**：相对欧几里得范数 $e_{\\mathrm{cons}} = \\dfrac{\\|\\boldsymbol{r}_{\\mathrm{cons}}\\|_2}{\\|\\boldsymbol{f}_{\\mathrm{N}}^{\\mathrm{cons}}\\|_2}$ 和 $e_{\\mathrm{lump}} = \\dfrac{\\|\\boldsymbol{r}_{\\mathrm{lump}}\\|_2}{\\|\\boldsymbol{f}_{\\mathrm{N}}^{\\mathrm{cons}}\\|_2}$。\n- **测试用例**：\n    1. $E = 1000$ Pa, $\\nu = 0.25$, $L_x = 2.0$ m, $L_y = 1.0$ m, $\\boldsymbol{\\sigma}_0 = [5.0, 0.0, 0.0]^{\\mathsf{T}}$ Pa。\n    2. $E = 1000$ Pa, $\\nu = 0.25$, $L_x = 1.5$ m, $L_y = 0.8$ m, $\\boldsymbol{\\sigma}_0 = [0.0, 0.0, 4.0]^{\\mathsf{T}}$ Pa。\n    3. $E = 1000$ Pa, $\\nu = 0.25$, $L_x = 3.0$ m, $L_y = 0.5$ m, $\\boldsymbol{\\sigma}_0 = [2.0, -1.0, 3.0]^{\\mathsf{T}}$ Pa。\n\n### 步骤 2：使用提取的已知条件进行验证\n1.  **科学依据**：该问题完全基于固体力学中有限元法（FEM）的基本原理。线性弹性、等参单元、高斯积分、虚功原理和斑块检验都是标准且成熟的概念。所提供的方程是这些原理的正确表述。\n2.  **良态的**：该问题描述了一个确定性的数值实验。所有必需的输入和过程都已指定，从而为所要求的误差度量产生唯一的数值结果。\n3.  **客观的**：问题以精确、正式且无偏见的技术语言陈述。\n4.  **完整且一致**：所有必要的参数、边界条件和数值过程都已完全指定。设置中没有矛盾。\n5.  **现实且可行**：参数在物理上是合理的。数值过程是标准的，并且在计算上是可行的。\n\n### 步骤 3：结论与行动\n该问题有效。它构成了计算力学中的一个标准验证练习。将提供完整解答。\n\n## 解答\n\n目标是在单个矩形双线性四边形（$\\text{Q4}$）单元上执行斑块检验，以比较一致和集中的诺伊曼载荷向量。斑块检验的核心是验证对于单元可以精确表示的位移场，内部生成的节点力与外部施加的节点力相平衡。\n\n### 理论基础\n虚功原理在其离散化的有限元形式中指出，为了使系统处于平衡状态，内部节点力向量 $\\boldsymbol{f}_{\\mathrm{int}}$ 必须与外部节点力向量 $\\boldsymbol{f}_{\\mathrm{ext}}$ 相平衡。即 $\\boldsymbol{f}_{\\mathrm{int}} = \\boldsymbol{f}_{\\mathrm{ext}}$。\n内力由单元应力计算得出，即 $\\boldsymbol{f}_{\\mathrm{int}} = \\int_{\\Omega_e} \\boldsymbol{B}^{\\mathsf{T}}\\boldsymbol{\\sigma} \\, \\mathrm{d}V$。如果应力状态 $\\boldsymbol{\\sigma}$ 是由节点位移 $\\boldsymbol{u}$ 引起的，这等效于 $\\boldsymbol{f}_{\\mathrm{int}} = \\boldsymbol{K}\\boldsymbol{u}$。由边界牵引引起的外力由 $\\boldsymbol{f}_{\\mathrm{N}} = \\int_{\\partial\\Omega_e} \\boldsymbol{N}^{\\mathsf{T}}\\boldsymbol{t} \\, \\mathrm{d}S$ 给出。一个正确构造的单元必须满足 $\\boldsymbol{K}\\boldsymbol{u} = \\boldsymbol{f}_{\\mathrm{N}}$，其中 $\\boldsymbol{u}$ 对应于一个恒定应力状态，并且 $\\boldsymbol{f}_{\\mathrm{N}}$ 是一致计算的。\n\n此问题的一个关键方面是 $\\text{Q4}$ 单元再现目标状态的能力。与恒定应变（因此是恒定应力）相对应的位移场 $u(x,y), v(x,y)$ 是 $x$ 和 $y$ 的线性函数。一个通用的双线性等参单元可以精确表示任何形如 $f(x,y) = c_1 + c_2x + c_3y + c_4xy$ 的函数。目标位移场是纯线性的，是该单元可表示函数的一个子集。因此，一个矩形 $\\text{Q4}$ 单元可以精确插值与任何恒定应力状态相对应的位移场。此外，对于矩形单元，单元的公式能在整个单元域内（而不仅仅是在节点处）正确地再现恒定应变状态。\n\n比较的关键在于计算载荷向量 $\\boldsymbol{f}_{\\mathrm{N}}$ 的两种方法：\n\n1.  **一致载荷向量 ($\\boldsymbol{f}_{\\mathrm{N}}^{\\mathrm{cons}}$)**：该向量直接从虚功原理导出，通过使用与位移插值相同的形函数进行力插值。积分 $\\int_{\\partial\\Omega} \\boldsymbol{N}^{\\mathsf{T}}\\boldsymbol{t} \\, \\mathrm{d}S$ 沿每条边进行计算。对于直边和恒定的牵引向量 $\\boldsymbol{t}$，使用 2 点高斯积分对线性形函数进行积分是精确的，其结果是将总边力在边的两个节点之间均等分配。\n\n2.  **集中载荷向量 ($\\boldsymbol{f}_{\\mathrm{N}}^{\\mathrm{lump}}$)**：这是一种简化的、临时的（ad-hoc）方法。问题将其定义为取一条边上的总力 $\\boldsymbol{F}_{edge} = \\int_{\\Gamma_e} \\boldsymbol{t} \\, \\mathrm{d}S$，并将其一半分配给该边上的每个节点。\n\n对于直边、线性（$\\text{Q4}$）形函数和恒定牵引向量 $\\boldsymbol{t}$（本问题即是如此，因为 $\\boldsymbol{\\sigma}_0$ 是恒定的且单元是矩形）的特定情况，一致载荷向量的计算产生了与指定的集中方案完全相同的 50/50 力分布。因此，我们预测 $\\boldsymbol{f}_{\\mathrm{N}}^{\\mathrm{cons}} = \\boldsymbol{f}_{\\mathrm{N}}^{\\mathrm{lump}}$，从而误差 $e_{\\mathrm{cons}}$ 和 $e_{\\mathrm{lump}}$ 都应接近机器精度，表明在这两种理想化条件下，两种方法都通过了斑块检验。如果牵引力不恒定、边界弯曲或使用高阶单元，则会产生误差。\n\n### 算法实现步骤\n\n1.  **设置**：对于每个测试用例，定义材料属性（$E, \\nu$）、几何形状（$L_x, L_y$）和目标应力（$\\boldsymbol{\\sigma}_0$）。设置厚度 $t=1$。定义四个节点的物理坐标。\n\n2.  **本构矩阵**：计算 $3 \\times 3$ 的平面应变本构矩阵 $\\boldsymbol{D}$。\n    $$ \\boldsymbol{D} = \\frac{E}{(1+\\nu)(1-2\\nu)} \\begin{bmatrix} 1-\\nu  \\nu  0 \\\\ \\nu  1-\\nu  0 \\\\ 0  0  \\frac{1-2\\nu}{2} \\end{bmatrix} $$\n\n3.  **节点位移**：计算目标恒定应变向量 $\\boldsymbol{\\varepsilon}_0 = \\boldsymbol{D}^{-1}\\boldsymbol{\\sigma}_0$。使用 $\\boldsymbol{\\varepsilon}_0$ 通过在四个节点坐标处对精确的线性位移场进行采样，来找到节点位移向量 $\\boldsymbol{u}$。\n\n4.  **刚度矩阵 ($\\boldsymbol{K}$)**：通过使用 $2 \\times 2$ 高斯积分在单元面积上对 $\\boldsymbol{B}^{\\mathsf{T}}\\boldsymbol{D}\\boldsymbol{B}$ 进行数值积分，来组装 $8 \\times 8$ 的单元刚度矩阵。应变-位移矩阵 $\\boldsymbol{B}(\\xi, \\eta)$ 是父坐标 $(\\xi, \\eta)$ 的函数，由形函数的空间导数导出。对于矩形单元，等参映射的雅可比行列式是常数，简化了计算。\n    $$ \\boldsymbol{K}_e = \\int_{-1}^{1}\\int_{-1}^{1} \\boldsymbol{B}(\\xi,\\eta)^{\\mathsf{T}} \\boldsymbol{D} \\boldsymbol{B}(\\xi,\\eta) \\, t \\, \\det(\\boldsymbol{J}) \\, \\mathrm{d}\\xi \\mathrm{d}\\eta $$\n\n5.  **内力**：计算内部节点力向量 $\\boldsymbol{f}_{\\mathrm{int}} = \\boldsymbol{K}\\boldsymbol{u}$。\n\n6.  **载荷向量**：\n    *   **一致 ($\\boldsymbol{f}_{\\mathrm{N}}^{\\mathrm{cons}}$)**：通过对四个边界边的贡献求和来组装。对于每条边，使用 2 点高斯线积分来积分 $\\boldsymbol{N}^{\\mathsf{T}}\\boldsymbol{t}$。牵引力 $\\boldsymbol{t}$ 在每条边上是恒定的。\n    *   **集中 ($\\boldsymbol{f}_{\\mathrm{N}}^{\\mathrm{lump}}$)**：通过对每个边的贡献求和来组装。对于每条边，计算总力向量，并将其一半加到该边上两个节点的自由度上。\n\n7.  **误差计算**：按问题中的规定计算残差 $\\boldsymbol{r}_{\\mathrm{cons}}$ 和 $\\boldsymbol{r}_{\\mathrm{lump}}$ 及其相对范数 $e_{\\mathrm{cons}}$ 和 $e_{\\mathrm{lump}}$。\n\n以下 Python 程序为给定的测试套件实现了此过程。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements a patch test for a single Q4 element to compare consistent\n    and lumped Neumann boundary load vectors.\n    \"\"\"\n    test_cases = [\n        # (E, nu, Lx, Ly, sigma0)\n        (1000.0, 0.25, 2.0, 1.0, np.array([5.0, 0.0, 0.0])),\n        (1000.0, 0.25, 1.5, 0.8, np.array([0.0, 0.0, 4.0])),\n        (1000.0, 0.25, 3.0, 0.5, np.array([2.0, -1.0, 3.0])),\n    ]\n\n    results = []\n    for case in test_cases:\n        result = run_patch_test(case)\n        results.append(result)\n\n    # Format the flot numbers in the output string representation\n    formatted_results = []\n    for res_pair in results:\n        formatted_pair = f'[{res_pair[0]:.17e}, {res_pair[1]:.17e}]'\n        formatted_results.append(formatted_pair)\n    \n    print(f\"[{','.join(formatted_results)}]\")\n\ndef run_patch_test(test_case):\n    \"\"\"\n    Executes the patch test logic for a single parameter set.\n    \"\"\"\n    E, nu, Lx, Ly, sigma0 = test_case\n    t = 1.0  # Unit thickness\n\n    # 1. Material and Geometry Setup\n    node_coords = np.array([\n        [0.0, 0.0],\n        [Lx, 0.0],\n        [Lx, Ly],\n        [0.0, Ly]\n    ])\n\n    # 2. Constitutive Matrix (D) for Plane Strain\n    factor = E / ((1.0 + nu) * (1.0 - 2.0 * nu))\n    D = factor * np.array([\n        [1.0 - nu, nu, 0.0],\n        [nu, 1.0 - nu, 0.0],\n        [0.0, 0.0, (1.0 - 2.0 * nu) / 2.0]\n    ])\n\n    # 3. Target Strain and Nodal Displacements\n    D_inv = np.linalg.inv(D)\n    eps0 = D_inv @ sigma0\n    eps_xx, eps_yy, gam_xy = eps0\n\n    u_nodes = np.zeros(8)\n    for i in range(4):\n        x, y = node_coords[i]\n        u_nodes[2 * i] = eps_xx * x + 0.5 * gam_xy * y\n        u_nodes[2 * i + 1] = 0.5 * gam_xy * x + eps_yy * y\n\n    # 4. Stiffness Matrix Assembly (K)\n    K = np.zeros((8, 8))\n    detJ = (Lx / 2.0) * (Ly / 2.0)\n    \n    gauss_points = [-1.0 / np.sqrt(3.0), 1.0 / np.sqrt(3.0)]\n    weights = [1.0, 1.0]\n    parent_coords = np.array([[-1., -1.], [1., -1.], [1., 1.], [-1., 1.]])\n\n    for i, xi in enumerate(gauss_points):\n        for j, eta in enumerate(gauss_points):\n            B = np.zeros((3, 8))\n            for n in range(4):\n                xi_n, eta_n = parent_coords[n]\n                dN_dxi = 0.25 * xi_n * (1.0 + eta_n * eta)\n                dN_deta = 0.25 * eta_n * (1.0 + xi_n * xi)\n                dN_dx = (2.0 / Lx) * dN_dxi\n                dN_dy = (2.0 / Ly) * dN_deta\n                \n                B[0, 2 * n] = dN_dx\n                B[1, 2 * n + 1] = dN_dy\n                B[2, 2 * n] = dN_dy\n                B[2, 2 * n + 1] = dN_dx\n            \n            K += B.T @ D @ B * detJ * weights[i] * weights[j] * t\n\n    # 5. Internal Force Vector\n    f_int = K @ u_nodes\n\n    # 6. Neumann Load Vector Assembly\n    f_cons = np.zeros(8)\n    f_lump = np.zeros(8)\n    sigma_mat = np.array([[sigma0[0], sigma0[2]], [sigma0[2], sigma0[1]]])\n    \n    edges = [\n        (0, 1, np.array([0.0, -1.0]), Lx), # Bottom\n        (1, 2, np.array([1.0, 0.0]), Ly),  # Right\n        (2, 3, np.array([0.0, 1.0]), Lx),  # Top\n        (3, 0, np.array([-1.0, 0.0]), Ly)  # Left\n    ]\n\n    for n1_idx, n2_idx, normal, length in edges:\n        traction = sigma_mat @ normal\n        total_force_edge = traction * length * t\n        \n        # Lumped vector\n        f_lump[2 * n1_idx: 2 * n1_idx + 2] += 0.5 * total_force_edge\n        f_lump[2 * n2_idx: 2 * n2_idx + 2] += 0.5 * total_force_edge\n\n        # Consistent vector (using 2-point Gauss quadrature on edge)\n        detJ_line = length / 2.0\n        for k, s in enumerate(gauss_points): # s is local coord on edge [-1, 1]\n            wk = weights[k]\n            N1_edge = 0.5 * (1.0 - s)\n            N2_edge = 0.5 * (1.0 + s)\n            \n            # Add contribution to node 1 of the edge\n            f_cons[2 * n1_idx: 2 * n1_idx + 2] += (N1_edge * traction) * detJ_line * wk * t\n            # Add contribution to node 2 of the edge\n            f_cons[2 * n2_idx: 2 * n2_idx + 2] += (N2_edge * traction) * detJ_line * wk * t\n            \n    # 7. Residual and Error Calculation\n    r_cons = f_int - f_cons\n    r_lump = f_int - f_lump\n\n    norm_f_cons = np.linalg.norm(f_cons)\n    \n    if norm_f_cons  1e-15:\n        e_cons = np.linalg.norm(r_cons)\n        e_lump = np.linalg.norm(r_lump)\n    else:\n        e_cons = np.linalg.norm(r_cons) / norm_f_cons\n        e_lump = np.linalg.norm(r_lump) / norm_f_cons\n\n    return [e_cons, e_lump]\n\nif __name__ == '__main__':\n    solve()\n```", "id": "3504177"}, {"introduction": "在处理瞬态耦合问题（如岩土力学中的固结问题）时，狄利克雷边界条件的施加方式对解的物理真实性，特别是对质量守恒等基本物理定律的满足程度，有着至关重要的影响。本高级练习将超越基础的罚函数法，引导您在一个一维固结模型中实现并比较三种主流的弱边界条件施加技术：罚函数法、拉格朗日乘子法和 Nitsche 法。通过计算和比较不同方法下的流体质量不平衡误差 $ \\Delta m $，您将深入探究各种方法在保证数值解物理意义方面的优劣，这对于开发高保真度的计算模型至关重要 [@problem_id:3504268]。", "problem": "考虑一维小应变 Biot 固结在刚性骨架极限下的情况，此时流体压力场由一个从流体质量平衡和 Darcy 定律推导出的扩散型偏微分方程 (PDE) 控制。设空间域为 $x \\in [0,L]$，其中 $L$ 的单位为米。流体压力 $p(x,t)$ 的控制方程为\n$$\nS \\, \\frac{\\partial p}{\\partial t}(x,t) - \\frac{\\partial}{\\partial x}\\!\\left( K \\, \\frac{\\partial p}{\\partial x}(x,t) \\right) = 0,\n$$\n其中 $S$ 是储水率 (单位为 $\\mathrm{Pa}^{-1}$)，$K = k/\\mu$ 是水力扩散系数 (渗透率除以动力粘度，单位为 $\\mathrm{m}^2/(\\mathrm{Pa}\\cdot\\mathrm{s})$)。初始条件为均匀压力 $p(x,0) = p_0$，其中 $p_0$ 的单位为帕斯卡。左边界 $x=0$ 为无流动边界 (齐次 Neumann)，右边界 $x=L$ 为排水边界 (Dirichlet)，即 $p(L,t)=0$。排水边界将通过以下三种弱施加策略之一来施加：罚函数法、拉格朗日乘子法和 Nitsche 方法。\n\n从将 PDE 乘以检验函数 $w(x)$ 并在域 $[0,L]$ 上积分得到的弱形式出发，\n$$\n\\int_0^L S \\, w \\, \\frac{\\partial p}{\\partial t} \\, dx + \\int_0^L K \\, \\frac{\\partial w}{\\partial x} \\, \\frac{\\partial p}{\\partial x} \\, dx - w(0) \\, q_N(0,t) - w(L) \\, q_N(L,t) = 0,\n$$\n其中 $q_N(x,t)$ 表示给定的法向通量，使用有限元法 (FEM) 推导一个半离散空间近似。有限元法使用线性 (双节点) 单元，包含 $N_e$ 个单元和 $N_n=N_e+1$ 个节点的均匀网格，以及每个单元上的分段线性试探函数和检验函数。使用具有恒定时间步长 $\\Delta t$ 的后向欧拉时间积分，以在每个时间步获得一个全离散系统。通过以下各种方法施加排水边界条件 $p(L,t)=0$：\n\n1) 罚函数法：添加一个与 $(p(L,t) - p_D)$（其中 $p_D=0$）成正比的边界罚项，该项由无量纲稳定化参数 $\\gamma_p$ 按 $\\gamma_p \\, K/h$ 进行缩放，其中 $h$ 是与 $x=L$ 相邻的最后一个单元的尺寸。\n\n2) 拉格朗日乘子法：通过使用拉格朗日乘子以一个约束方程来增广离散系统，从而施加约束 $p(L,t)=p_D$。可选地，可以使用增广拉格朗日正则化，在排水边界自由度的对角线上添加 $\\beta \\, K/h$，其中 $\\beta$ 是一个无量纲稳定化参数（对于纯拉格朗日乘子法，设 $\\beta=0$；对于增广变体，设 $\\beta0$）。\n\n3) Nitsche 方法：在排水边界上使用带有稳定化参数 $\\gamma_N$（无量纲）的对称 Nitsche 公式，添加一致性项\n$$\n- \\int_{\\Gamma_D} w \\, (n \\cdot K \\nabla p) \\, ds - \\int_{\\Gamma_D} (n \\cdot K \\nabla w) \\, (p - p_D) \\, ds\n$$\n和一个罚项\n$$\n\\int_{\\Gamma_D} \\gamma_N \\, \\frac{K}{h} \\, w \\, (p - p_D) \\, ds,\n$$\n其中 $n$ 是外单位法向量，在一维情况下 $\\Gamma_D=\\{x=L\\}$。\n\n设物理参数为 $L = 1\\,\\mathrm{m}$，$S = 1.0\\times 10^{-9}\\,\\mathrm{Pa}^{-1}$，$K = 1.0\\times 10^{-6}\\,\\mathrm{m}^2/(\\mathrm{Pa}\\cdot\\mathrm{s})$，$p_0 = 1.0\\times 10^{5}\\,\\mathrm{Pa}$，网格为均匀网格，有 $N_e = 40$ 个单元，因此 $h = L/N_e$。使用后向欧拉法，时间步长 $\\Delta t = 10\\,\\mathrm{s}$，最终时间 $T = 1000\\,\\mathrm{s}$（即 $N_t = T/\\Delta t$ 个时间步）。\n\n将时刻 $t$ 的单位横截面积的总流体含量定义为\n$$\nM(t) = S \\int_0^L p(x,t)\\, dx,\n$$\n在有限元离散化中，这等于 $M(t) \\approx \\mathbf{1}^\\top \\mathbf{M}\\, \\mathbf{p}(t)$，其中 $\\mathbf{M}$ 是一致质量矩阵，$\\mathbf{p}(t)$ 是节点压力向量。根据 Darcy 定律将排水边界处的向外通量定义为\n$$\nq_\\mathrm{out}(t) = - K \\, \\frac{\\partial p}{\\partial x}(L,t),\n$$\n并在每个时间步通过最后一个单元上的梯度将其近似为\n$$\nq_\\mathrm{out}(t_n) \\approx K \\, \\frac{p_{N_n-2}(t_n) - p_{N_n-1}(t_n)}{h}.\n$$\n将直到时间 $T$ 为止单位面积的累积排出流体含量定义为\n$$\nQ(T) = \\sum_{n=1}^{N_t} q_\\mathrm{out}(t_n)\\, \\Delta t.\n$$\n根据全局质量守恒，在没有源项且 $x=0$ 处通量为零的情况下，守恒恒等式为\n$$\nM(T) - M(0) + Q(T) = 0.\n$$\n将质量守恒误差定义为\n$$\n\\Delta m = \\left| M(T) - M(0) + Q(T) \\right|,\n$$\n单位为米（单位横截面积的流体含量）。通过为一组稳定化参数计算 $\\Delta m$，实现并比较这三种边界施加策略。设 $p_D=0$。\n\n你的程序必须为以下每个测试用例求解离散系统：\n- 罚函数法，$\\gamma_p = 0.1$，$\\gamma_p = 10.0$ 和 $\\gamma_p = 1000.0$。\n- Nitsche 方法，$\\gamma_N = 1.0$，$\\gamma_N = 10.0$ 和 $\\gamma_N = 100.0$。\n- 拉格朗日乘子法，增广参数 $\\beta = 0.0$ (纯拉格朗日乘子) 和 $\\beta = 10.0$。\n\n对于每个测试用例，计算并返回以米为单位的 $\\Delta m$。你的程序应产生单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果（例如，$[0.00123,0.00045, \\ldots ]$）。所有数值必须以米为单位，表示为以 10 为基数的浮点十进制数。", "solution": "用户希望解决一个一维固结问题，并比较三种弱施加 Dirichlet 边界条件的不同方法。我将首先验证问题陈述。\n\n### 步骤 1：提取给定条件\n- **控制偏微分方程**：$S \\, \\frac{\\partial p}{\\partial t}(x,t) - \\frac{\\partial}{\\partial x}\\!\\left( K \\, \\frac{\\partial p}{\\partial x}(x,t) \\right) = 0$，对于 $x \\in [0,L]$。\n- **参数**：储水率 $S$，水力扩散系数 $K$。\n- **初始条件**：$p(x,0) = p_0$。\n- **边界条件**：$x=0$ 处为齐次 Neumann（无流动），$x=L$ 处为 Dirichlet（$p(L,t)=p_D=0$）。\n- **弱形式**：$\\int_0^L S \\, w \\, \\frac{\\partial p}{\\partial t} \\, dx + \\int_0^L K \\, \\frac{\\partial w}{\\partial x} \\, \\frac{\\partial p}{\\partial x} \\, dx - w(0) \\, q_N(0,t) - w(L) \\, q_N(L,t) = 0$。\n- **离散化**：线性双节点有限元（$N_e$ 个单元，$N_n=N_e+1$ 个节点），均匀网格尺寸 $h=L/N_e$。采用步长为 $\\Delta t$ 的后向欧拉时间积分。\n- **物理/数值常数**：$L = 1\\,\\mathrm{m}$，$S = 1.0\\times 10^{-9}\\,\\mathrm{Pa}^{-1}$，$K = 1.0\\times 10^{-6}\\,\\mathrm{m}^2/(\\mathrm{Pa}\\cdot\\mathrm{s})$，$p_0 = 1.0\\times 10^{5}\\,\\mathrm{Pa}$，$N_e = 40$，$h = L/N_e$，$\\Delta t = 10\\,\\mathrm{s}$，$T = 1000\\,\\mathrm{s}$。\n- **边界条件施加方法**：\n    1.  **罚函数法**：添加罚项 $\\gamma_p \\, K/h \\, (p(L,t) - p_D)$。\n    2.  **拉格朗日乘子法**：用约束 $p(L,t)=p_D$ 和可选的正则化项 $\\beta \\, K/h$ 来增广系统。\n    3.  **对称 Nitsche 方法**：添加项 $- \\int_{\\Gamma_D} w \\, (n \\cdot K \\nabla p) \\, ds - \\int_{\\Gamma_D} (n \\cdot K \\nabla w) \\, (p - p_D) \\, ds + \\int_{\\Gamma_D} \\gamma_N \\, \\frac{K}{h} \\, w \\, (p - p_D) \\, ds$。\n- **分析量**：\n    -   总流体含量：$M(t) = S \\int_0^L p(x,t)\\, dx \\approx \\mathbf{1}^\\top \\mathbf{M}\\, \\mathbf{p}(t)$。\n    -   向外通量：$q_\\mathrm{out}(t) = - K \\, \\frac{\\partial p}{\\partial x}(L,t) \\approx K \\, (p_{N_n-2}(t_n) - p_{N_n-1}(t_n))/h$。\n    -   累积排出量：$Q(T) = \\sum_{n=1}^{N_t} q_\\mathrm{out}(t_n)\\, \\Delta t$。\n    -   质量守恒误差：$\\Delta m = \\left| M(T) - M(0) + Q(T) \\right|$。\n- **测试用例**：\n    -   罚函数法：$\\gamma_p \\in \\{0.1, 10.0, 1000.0\\}$。\n    -   Nitsche 方法：$\\gamma_N \\in \\{1.0, 10.0, 100.0\\}$。\n    -   拉格朗日乘子法：$\\beta \\in \\{0.0, 10.0\\}$。\n\n### 步骤 2：使用提取的给定条件进行验证\n1.  **科学上合理**：该问题描述了多孔介质中的一维流体扩散，这是基于质量守恒和 Darcy 定律的岩土力学和水文学的基石。所有模型和方法都是计算力学中的标准方法。该设置在科学上是有效的。\n2.  **适定性**：该问题是一个抛物型偏微分方程的适定初边值问题。数值公式是标准的，并在每个时间步长导出一个可解的线性方程组。\n3.  **客观性**：所有术语都以数学精度定义。没有使用主观语言。\n4.  **科学或事实上的不健全性**：无。物理、数学和数值方法都是正确的。\n5.  **非形式化或不相关**：该问题高度形式化，与指定主题直接相关。\n6.  **不完整或矛盾的设置**：问题已完全指定。离散总流体含量的定义 $M(t) \\approx \\mathbf{1}^\\top \\mathbf{M}\\, \\mathbf{p}(t)$ 是正确的，因为对于检验函数 $w(x)=1 = \\sum_i N_i(x)$，对应的节点权重向量为 $\\mathbf{w}=\\mathbf{1}$，积分 $\\int S w p \\,dx$ 变为 $\\mathbf{w}^\\top \\mathbf{M} \\mathbf{p} = \\mathbf{1}^\\top \\mathbf{M} \\mathbf{p}$。通量近似是最后一个单元上的有效有限差分。所有定义都是一致的。\n7.  **不切实际或不可行**：物理参数对于沙或淤泥等材料是合理的。数值参数定义了一个数值稳定的模拟（后向欧拉格式是无条件稳定的）。\n8.  **不适定或结构不良**：非不适定。结构清晰且逻辑性强。\n9.  **伪深刻、琐碎或同义反复**：该问题是数值分析中的一个实质性练习，比较了不同既定数值技术的实际性能。\n10. **超出科学可验证性**：结果是可数值计算和可验证的。\n\n### 步骤 3：结论和行动\n问题有效。我将继续进行求解推导。\n\n控制流体压力 $p(x,t)$ 的偏微分方程是一个扩散方程：\n$$S \\, \\frac{\\partial p}{\\partial t} - \\frac{\\partial}{\\partial x}\\!\\left( K \\, \\frac{\\partial p}{\\partial x} \\right) = 0$$\n我们从推导半离散有限元近似开始。将方程乘以一个检验函数 $w(x)$ 并在域 $[0,L]$ 上积分，得到弱形式。对第二项进行分部积分后，我们有：\n$$\\int_0^L S \\, w \\, \\frac{\\partial p}{\\partial t} \\, dx + \\int_0^L K \\, \\frac{\\partial w}{\\partial x} \\, \\frac{\\partial p}{\\partial x} \\, dx - \\left[ w K \\frac{\\partial p}{\\partial x} \\right]_0^L = 0$$\n边界项可以写成 Darcy 通量 $q(x,t) = -K \\frac{\\partial p}{\\partial x}(x,t)$ 的形式。弱形式变为：\n$$\\int_0^L S \\, w \\, \\frac{\\partial p}{\\partial t} \\, dx + \\int_0^L K \\, \\frac{\\partial w}{\\partial x} \\, \\frac{\\partial p}{\\partial x} \\, dx + w(L)q(L,t) - w(0)q(0,t) = 0$$\n$x=0$ 处的无流动条件意味着 $q(0,t)=0$。$x=L$ 处的条件将通过各种弱施加方法处理。\n\n我们用 $N_e$ 个尺寸均匀为 $h = L/N_e$ 的线性有限元来离散化空间域，共有 $N_n = N_e+1$ 个节点。我们将压力场近似为 $p(x,t) \\approx \\sum_{j=0}^{N_n-1} p_j(t) N_j(x)$，其中 $p_j(t)$ 是节点压力值，$N_j(x)$ 是分段线性基函数。使用 Galerkin 方法，检验函数 $w(x)$ 选自相同的基，即 $w(x) = N_i(x)$。这导出了一个常微分方程组：\n$$\\mathbf{M} \\frac{d\\mathbf{p}}{dt} + \\mathbf{K} \\mathbf{p} = \\mathbf{f}$$\n其中 $\\mathbf{p}$ 是节点压力向量，矩阵由单元贡献组装而成：\n-   一致质量矩阵：$\\mathbf{M}_{ij} = \\int_0^L S N_i(x) N_j(x) \\, dx$。对于一个线性单元，$\\mathbf{M}^e = \\frac{S h}{6} \\begin{pmatrix} 2  1 \\\\ 1  2 \\end{pmatrix}$。\n-   刚度矩阵：$\\mathbf{K}_{ij} = \\int_0^L K N_i'(x) N_j'(x) \\, dx$。对于一个线性单元，$\\mathbf{K}^e = \\frac{K}{h} \\begin{pmatrix} 1  -1 \\\\ -1  1 \\end{pmatrix}$。\n-   力向量 $\\mathbf{f}$：由边界项产生。目前，$f_i(t) = -w(L)q(L,t)|_{w=N_i}$，仅当 $i=N_n-1$ 时非零。\n\n应用后向欧拉格式进行时间积分，$\\frac{d\\mathbf{p}}{dt} \\approx \\frac{\\mathbf{p}^{n+1} - \\mathbf{p}^n}{\\Delta t}$，我们得到在每个时间步 $n+1$ 需求解的全离散系统：\n$$(\\mathbf{M} + \\Delta t \\mathbf{K}) \\mathbf{p}^{n+1} = \\mathbf{M} \\mathbf{p}^n + \\Delta t \\mathbf{f}^{n+1}$$\n其中 $\\mathbf{p}^{n+1}$ 是在时间 $t_{n+1}$ 的未知压力向量。边界条件 $p(L,t) = p_D=0$ 施加在节点 $i=N_n-1$ 上。\n\n**1. 罚函数法**\nDirichlet 约束通过在弱形式中添加一个罚项来近似施加，这可以解释为一种 Robin 型边界条件，其中通量与约束违反成正比：$q(L,t) \\approx \\alpha (p(L,t) - p_D)$。罚参数给定为 $\\alpha = \\gamma_p K/h$。力向量的贡献是 $f_{N_n-1}^{n+1} = -q(L,t_{n+1}) \\approx -\\alpha (p_{N_n-1}^{n+1} - p_D)$。当 $p_D=0$ 时，系统变为：\n$$(\\mathbf{M} + \\Delta t \\mathbf{K}) \\mathbf{p}^{n+1} + \\Delta t \\alpha \\begin{pmatrix} 0 \\\\ \\vdots \\\\ 0 \\\\ 1 \\end{pmatrix} p_{N_n-1}^{n+1} = \\mathbf{M} \\mathbf{p}^n$$\n这等同于修改系统矩阵 $\\mathbf{A} = \\mathbf{M} + \\Delta t \\mathbf{K}$，通过在其最后一个对角线元素上添加一个项：\n$$A_{N_n-1, N_n-1} \\rightarrow A_{N_n-1, N_n-1} + \\Delta t \\, \\gamma_p \\frac{K}{h}$$\n右侧向量是 $\\mathbf{b} = \\mathbf{M} \\mathbf{p}^n$。我们求解 $(\\mathbf{A}_{mod}) \\mathbf{p}^{n+1} = \\mathbf{b}$。\n\n**2. 拉格朗日乘子法**\n该方法引入一个新的未知数，即拉格朗日乘子 $\\lambda$，它代表边界上的反作用通量，$\\lambda \\approx q(L,t)$。系统通过精确的约束方程 $p_{N_n-1}^{n+1} = p_D = 0$ 进行增广。力向量变为 $\\mathbf{f}^{n+1} = [0, \\dots, 0, -\\lambda^{n+1}]^\\top$。在步骤 $n+1$ 的完整系统结合了离散化的偏微分方程和约束：\n$$ \\begin{cases} (\\mathbf{M} + \\Delta t \\mathbf{K}) \\mathbf{p}^{n+1} + \\Delta t \\lambda^{n+1} \\mathbf{c} = \\mathbf{M} \\mathbf{p}^n \\\\ \\mathbf{c}^\\top \\mathbf{p}^{n+1} = p_D \\end{cases} $$\n其中 $\\mathbf{c}$ 是一个在索引 $N_n-1$ 处为 1，其他位置为 0 的向量。这构成了一个 $(N_n+1) \\times (N_n+1)$ 的鞍点系统：\n$$ \\begin{pmatrix} \\mathbf{M} + \\Delta t \\mathbf{K}  \\Delta t \\, \\mathbf{c} \\\\ \\mathbf{c}^\\top  0 \\end{pmatrix} \\begin{pmatrix} \\mathbf{p}^{n+1} \\\\ \\lambda^{n+1} \\end{pmatrix} = \\begin{pmatrix} \\mathbf{M} \\mathbf{p}^n \\\\ p_D \\end{pmatrix} $$\n增广变体在主自由度 $p_{N_n-1}$ 的对角线项上添加了一个稳定项 $\\beta K/h$。这修改了系统矩阵左上块的 $(N_n-1, N_n-1)$ 项：\n$$(\\mathbf{M} + \\Delta t \\mathbf{K})_{N_n-1, N_n-1} \\rightarrow (\\mathbf{M} + \\Delta t \\mathbf{K})_{N_n-1, N_n-1} + \\Delta t \\beta \\frac{K}{h}$$\n对于纯拉格朗日乘子法，$\\beta=0$。由于 $p_D=0$，右侧向量的最后一个元素是 $0$。\n\n**3. Nitsche 方法**\n对称 Nitsche 方法通过用三个弱施加 Dirichlet 条件的项来替换自然边界项 $w(L)q(L,t)$，从而修改了弱形式。最终的弱形式是：\n$$\\int_0^L S w \\dot{p}\\,dx + \\int_0^L K w'p'\\,dx - [K p' w]_L - [K w'(p-p_D)]_L + [\\gamma_N \\frac{K}{h}w(p-p_D)]_L = 0$$\n这三个边界项对刚度矩阵 $\\mathbf{K}$ 和载荷向量 $\\mathbf{f}$ 都有贡献。离散化这些项会导致对边界节点（$N_n-2$ 和 $N_n-1$）对应的刚度矩阵项进行修改。最终的对称修改方案将全局刚度矩阵 $\\mathbf{K}_{std}$ 在 $(N_n-2, N_n-1)$ 和 $(N_n-1, N_n-2)$ 处的项清零，并将 $(N_n-1, N_n-1)$ 项更新为 $(\\gamma_N-1)K/h$。需要求解的系统是 $(\\mathbf{M} + \\Delta t \\mathbf{K}_{Nitsche})\\mathbf{p}^{n+1} = \\mathbf{M} \\mathbf{p}^n$。\n\n**质量守恒误差**\n计算质量守恒误差 $\\Delta m = | M(T) - M(0) + Q(T) |$ 以评估每种方法的准确性。\n-   初始流体含量为 $M(0) = S \\int_0^L p_0 \\, dx = S p_0 L$。\n-   最终流体含量由最终压力向量 $\\mathbf{p}(T)$ 计算得出：$M(T) \\approx \\mathbf{1}^\\top \\mathbf{M} \\mathbf{p}(T)$。\n-   累积流出量 $Q(T)$ 是每个时间步流出量的总和，$Q(T) = \\sum_{n=1}^{N_t} q_\\mathrm{out}(t_n)\\, \\Delta t$，其中流出通量由解近似为 $q_\\mathrm{out}(t_n) \\approx K (p_{N_n-2}(t_n) - p_{N_n-1}(t_n))/h$。\n\n实现将模拟压力演化直至 $T=1000\\,\\mathrm{s}$，对 8 个测试用例中的每一个进行计算，并计算相应的 $\\Delta m$。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the 1D consolidation problem using FEM with different\n    weak boundary condition enforcement methods and calculates the\n    mass conservation error for each.\n    \"\"\"\n\n    # Physical and numerical parameters from the problem statement\n    L = 1.0  # m\n    S = 1.0e-9  # Pa^-1\n    K = 1.0e-6  # m^2/(Pa*s)\n    p0 = 1.0e5  # Pa\n    Ne = 40  # Number of elements\n    h = L / Ne  # Element size\n    Nn = Ne + 1  # Number of nodes\n    T = 1000.0  # s\n    dt = 10.0  # s\n    Nt = int(T / dt)  # Number of time steps\n    pD = 0.0 # Prescribed pressure at drained boundary\n\n    # Test cases from the problem statement\n    test_cases = [\n        ('penalty', 0.1),\n        ('penalty', 10.0),\n        ('penalty', 1000.0),\n        ('nitsche', 1.0),\n        ('nitsche', 10.0),\n        ('nitsche', 100.0),\n        ('lagrange', 0.0),\n        ('lagrange', 10.0),\n    ]\n\n    results = []\n\n    # Assemble global mass (M) and stiffness (K) matrices\n    M = np.zeros((Nn, Nn))\n    K_std = np.zeros((Nn, Nn))\n\n    # Element-level matrices\n    m_e = (S * h / 6.0) * np.array([[2.0, 1.0], [1.0, 2.0]])\n    k_e = (K / h) * np.array([[1.0, -1.0], [-1.0, 1.0]])\n\n    for e in range(Ne):\n        # Global indices for the element's nodes\n        i, j = e, e + 1\n        # Add element contributions to global matrices\n        M[np.ix_([i, j], [i, j])] += m_e\n        K_std[np.ix_([i, j], [i, j])] += k_e\n\n    # Calculate initial mass M(0)\n    M0 = S * p0 * L\n\n    for method, param in test_cases:\n        p = np.full(Nn, p0) # Initial condition p(x,0) = p0\n        Q_T = 0.0 # Cumulative discharged fluid\n\n        for _ in range(Nt):\n            # Form the basic system Ax=b where A = M + dt*K and b = M*p_prev\n            # Make copies to avoid modifying the base matrices\n            K_eff = K_std.copy()\n            \n            # Right-hand side is the same for all methods\n            b_sys = M @ p\n            \n            if method == 'penalty':\n                gamma_p = param\n                A_sys = M + dt * K_eff\n                A_sys[Nn - 1, Nn - 1] += dt * gamma_p * K / h\n                p = np.linalg.solve(A_sys, b_sys)\n\n            elif method == 'nitsche':\n                gamma_N = param\n                # Modify the standard stiffness matrix for Nitsche's method\n                K_eff = K_std.copy()\n                # Apply symmetric Nitsche modifications\n                K_eff[Nn - 2, Nn - 1] += K / h\n                K_eff[Nn - 1, Nn - 2] += K / h\n                K_eff[Nn - 1, Nn - 1] += (gamma_N - 2) * K / h\n                A_sys = M + dt * K_eff\n                p = np.linalg.solve(A_sys, b_sys)\n\n            elif method == 'lagrange':\n                beta = param\n                A = M + dt * K_eff\n                # Add augmentation term if beta > 0\n                if beta > 0:\n                    A[Nn - 1, Nn - 1] += dt * beta * K / h\n                \n                # Assemble augmented system matrix\n                A_aug = np.zeros((Nn + 1, Nn + 1))\n                A_aug[:Nn, :Nn] = A\n                # Contribution from lambda to the pressure equation\n                A_aug[Nn - 1, Nn] = -dt\n                # Constraint equation\n                A_aug[Nn, Nn - 1] = 1.0\n\n                # Assemble augmented RHS vector\n                b_aug = np.zeros(Nn + 1)\n                b_aug[:Nn] = b_sys\n                b_aug[Nn] = pD\n                \n                sol = np.linalg.solve(A_aug, b_aug)\n                p = sol[:Nn]\n            \n            # Calculate outflow flux for the current time step\n            q_out = K * (p[Nn - 2] - p[Nn - 1]) / h\n            # Accumulate total outflow\n            Q_T += q_out * dt\n        \n        # Calculate final mass M(T)\n        MT = np.ones(Nn) @ M @ p\n        \n        # Calculate mass conservation error\n        delta_m = abs(MT - M0 + Q_T)\n        results.append(delta_m)\n\n    # Print results in the required format\n    print(f\"[{','.join(f'{r:.10f}' for r in results)}]\")\n\nsolve()\n```", "id": "3504268"}]}