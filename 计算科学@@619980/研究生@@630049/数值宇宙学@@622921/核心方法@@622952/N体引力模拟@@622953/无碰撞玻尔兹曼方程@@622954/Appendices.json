{"hands_on_practices": [{"introduction": "我们从无碰撞玻尔兹曼方程最基本的方面开始：它描述了粒子分布，其中每个粒子的运动轨迹都遵循经典力学。本练习通过特征线法将抽象的偏微分方程与具体的粒子轨道联系起来 [@problem_id:3494458]。通过实现一个辛积分器，您不仅可以可视化这些轨道，还能数值验证能量和角动量等关键不变量的守恒性，从而巩固您对引力系统中对称性与守恒律之间联系的理解。", "problem": "考虑在牛顿引力作用下，一个无碰撞系统的无碰撞玻尔兹曼（Vlasov）方程，其相空间分布函数为 $f(\\mathbf{x},\\mathbf{v},t)$，引力势为不随时间变化的 $\\Phi(\\mathbf{x})$。$f$ 的演化满足\n$$\n\\frac{\\partial f}{\\partial t} + \\mathbf{v}\\cdot\\nabla_{\\mathbf{x}} f - \\nabla_{\\mathbf{x}}\\Phi(\\mathbf{x})\\cdot\\nabla_{\\mathbf{v}} f = 0,\n$$\n而特征线法将问题简化为求解特征常微分方程组\n$$\n\\frac{d\\mathbf{x}}{dt} = \\mathbf{v},\\qquad \\frac{d\\mathbf{v}}{dt} = -\\nabla_{\\mathbf{x}} \\Phi(\\mathbf{x}).\n$$\n根据第一性原理，任何沿特征线为常数的标量 $Q(\\mathbf{x},\\mathbf{v},t)$ 在沿特征方程的解进行计算时，都必须满足 $\\frac{dQ}{dt}=0$。在不随时间变化的势中，总能量以及当存在适当对称性时的角动量分量是这类不变量的候选者。\n\n您的任务是：\n- 根据特征线法和 Newton 第二定律，推导在不随时间变化的势 $\\Phi(\\mathbf{x})$ 中沿粒子轨迹守恒的解析不变量，以及角动量分量得以守恒所需的对称性条件。\n- 实现一个辛蛙跳（踢-漂移-踢）积分器，用以在二维空间 $\\mathbf{x}=(x,y)$ 和 $\\mathbf{v}=(v_x,v_y)$ 中，为给定的不随时变化的势计算粒子轨迹。使用此数值积分器来评估沿数值近似特征线的不变量守恒质量。\n\n所有计算均在无量纲代码单位中进行（无物理单位）。不直接使用角度。对于任何类似百分比的比较，请以小数形式报告（例如，用 $0.01$ 而不是带百分号的 $1$）。\n\n使用以下势 $\\Phi(\\mathbf{x})$（均为不随时变化的）、它们对应的梯度 $\\nabla_{\\mathbf{x}}\\Phi(\\mathbf{x})$ 以及初始条件作为测试套件：\n- 测试用例1（自由粒子）：$\\Phi(\\mathbf{x})=0$。初始条件 $\\mathbf{x}_0=(1,0)$，$\\mathbf{v}_0=(0,0.5)$。\n- 测试用例2（中心谐振子）：$\\Phi(\\mathbf{x})=\\tfrac{1}{2}\\,\\omega^2 r^2$，其中 $r=\\sqrt{x^2+y^2}$ 且 $\\omega=0.5$。初始条件 $\\mathbf{x}_0=(1,0)$，$\\mathbf{v}_0=(0,0.8)$。\n- 测试用例3（开普勒势）：$\\Phi(\\mathbf{x})=-GM/r$，其中 $GM=1$ 且 $r=\\sqrt{x^2+y^2}$。初始条件 $\\mathbf{x}_0=(1,0)$，$\\mathbf{v}_0=(0,1)$。\n- 测试用例4（各向异性谐振子，轴对称性破缺）：$\\Phi(\\mathbf{x})=\\tfrac{1}{2}(\\omega_x^2 x^2+\\omega_y^2 y^2)$，其中 $\\omega_x=1$ 且 $\\omega_y=1.3$。初始条件 $\\mathbf{x}_0=(1,0)$，$\\mathbf{v}_0=(0,1)$。\n- 测试用例5（中心谐振子，径向运动）：$\\Phi(\\mathbf{x})=\\tfrac{1}{2}\\,\\omega^2 r^2$，其中 $\\omega=0.5$。初始条件 $\\mathbf{x}_0=(1,0)$，$\\mathbf{v}_0=(-0.5,0)$。\n\n对每个测试用例，使用踢-漂移-踢蛙跳法在总时间 $T=30$ 内积分特征方程，固定时间步长为 $\\Delta t=0.005$（因此步数为 $N=T/\\Delta t=6000$）。沿每条数值计算出的轨迹，在每一步计算：\n- 总比能 $E$（单位质量的能量）。\n- 适用于 $x$–$y$ 平面内运动的比角动量 $z$ 分量 $L_z$（单位质量的角动量）。\n\n使用以下度量来量化守恒性：\n- 对于量 $Q\\in\\{E,L_z\\}$，其初始值为 $Q_0$，计算最大漂移 $\\max_t |Q(t)-Q_0|$。若 $|Q_0|\\ge Q_{\\min}$（其中 $Q_{\\min}=10^{-12}$），则计算相对漂移 $\\max_t |Q(t)-Q_0|/|Q_0|$。若 $|Q_0|<Q_{\\min}$，则使用绝对漂移。\n- 最终结果应基于最大漂移是否小于或等于指定的容差（能量为 $\\varepsilon_E=10^{-4}$，角动量为 $\\varepsilon_L=10^{-4}$）来确定守恒性。\n\n一个包含 $10$ 个布尔值（True/False）的列表，指示 $5$ 个测试用例中每个用例的 $E$ 和 $L_z$ 的守恒性，必须是您程序的唯一输出。", "solution": "所提出的问题是计算物理学中一个明确定义的练习，特别是在数值宇宙学和天体物理学的背景下。它要求分两部分作答：首先，对在不随时变化的势中运动的粒子的守恒量进行理论推导；其次，使用一个辛积分器对几个测试用例的这些守恒律进行数值验证。\n\n### 问题验证\n\n1.  **提取给定信息**：\n    -   **控制方程**：一个相空间分布函数为 $f(\\mathbf{x},\\mathbf{v},t)$ 在不随时间变化的势 $\\Phi(\\mathbf{x})$ 中的无碰撞玻尔兹曼（Vlasov）方程：$\\frac{\\partial f}{\\partial t} + \\mathbf{v}\\cdot\\nabla_{\\mathbf{x}} f - \\nabla_{\\mathbf{x}}\\Phi(\\mathbf{x})\\cdot\\nabla_{\\mathbf{v}} f = 0$。\n    -   **特征方程**：$\\frac{d\\mathbf{x}}{dt} = \\mathbf{v}$，$\\frac{d\\mathbf{v}}{dt} = -\\nabla_{\\mathbf{x}} \\Phi(\\mathbf{x})$。\n    -   **不变量的定义**：如果一个量 $Q$ 沿特征线的全时间导数 $\\frac{dQ}{dt}$ 为零，则其为不变量。\n    -   **数值方法**：辛蛙跳（踢-漂移-踢）积分器。\n    -   **模拟参数**：总时间 $T=30$，时间步长 $\\Delta t=0.005$，步数 $N=6000$。\n    -   **测试用例（势 $\\Phi(\\mathbf{x})$ 和初始条件 $(\\mathbf{x}_0, \\mathbf{v}_0)$）**：\n        1.  **自由粒子**：$\\Phi(\\mathbf{x})=0$；$\\mathbf{x}_0=(1,0)$，$\\mathbf{v}_0=(0,0.5)$。\n        2.  **中心谐振子**：$\\Phi(\\mathbf{x})=\\tfrac{1}{2}\\,\\omega^2 r^2$，$\\omega=0.5$；$\\mathbf{x}_0=(1,0)$，$\\mathbf{v}_0=(0,0.8)$。\n        3.  **开普勒势**：$\\Phi(\\mathbf{x})=-GM/r$，$GM=1$；$\\mathbf{x}_0=(1,0)$，$\\mathbf{v}_0=(0,1)$。\n        4.  **各向异性谐振子**：$\\Phi(\\mathbf{x})=\\tfrac{1}{2}(\\omega_x^2 x^2+\\omega_y^2 y^2)$，$\\omega_x=1, \\omega_y=1.3$；$\\mathbf{x}_0=(1,0)$，$\\mathbf{v}_0=(0,1)$。\n        5.  **径向中心谐振子**：$\\Phi(\\mathbf{x})=\\tfrac{1}{2}\\,\\omega^2 r^2$，$\\omega=0.5$；$\\mathbf{x}_0=(1,0)$，$\\mathbf{v}_0=(-0.5,0)$。\n    -   **监控量**：比能 $E$，比角动量 $z$ 分量 $L_z$。\n    -   **守恒度量**：最大漂移 $\\max_t |Q(t)-Q_0|$。如果 $|Q_0|\\ge Q_{\\min}=10^{-12}$，则漂移为相对于 $|Q_0|$ 的相对值，否则为绝对值。\n    -   **守恒阈值**：能量为 $\\varepsilon_E=10^{-4}$，角动量为 $\\varepsilon_L=10^{-4}$。\n    -   **要求输出**：一个包含 $10$ 个布尔值（True/False）的列表，指示 $5$ 个测试用例中每个用例的 $E$ 和 $L_z$ 的守恒性。\n\n2.  **使用提取的给定信息进行验证**：\n    -   **科学上成立**：该问题基于经典力学的基本原理（牛顿引力、能量守恒、角动量守恒）和天体物理学中使用的标准数值方法（辛积分）。所有概念都是标准的并且在事实上是可靠的。\n    -   **良构的**：问题提供了所有必要的信息：微分方程（通过势函数）、初始条件、积分算法和精确的评估标准。每个测试用例都存在唯一且有意义的数值解。\n    -   **客观的**：问题使用精确、无歧义的数学和计算语言陈述。所有评估标准都是定量的。\n\n3.  **结论与行动**：问题有效。这是一个计算物理学中标准的、良构的问题，它结合了理论推导与数值实现和验证。我将继续进行详细的解答。\n\n### 第一部分：解析不变量的推导\n\n运动不变量（或运动常数）是相空间坐标的函数 $Q(\\mathbf{x}, \\mathbf{v})$，它沿着粒子的轨迹保持不变。其全时间导数必须为零：\n$$\n\\frac{dQ}{dt} = 0\n$$\n使用多变量链式法则，可以将其展开为：\n$$\n\\frac{dQ}{dt} = \\sum_i \\frac{\\partial Q}{\\partial x_i}\\frac{dx_i}{dt} + \\sum_i \\frac{\\partial Q}{\\partial v_i}\\frac{dv_i}{dt} = \\nabla_{\\mathbf{x}}Q \\cdot \\frac{d\\mathbf{x}}{dt} + \\nabla_{\\mathbf{v}}Q \\cdot \\frac{d\\mathbf{v}}{dt}\n$$\n代入特征方程 $\\frac{d\\mathbf{x}}{dt} = \\mathbf{v}$ 和 $\\frac{d\\mathbf{v}}{dt} = -\\nabla_{\\mathbf{x}}\\Phi$，我们得到不变量的条件：\n$$\n\\nabla_{\\mathbf{x}}Q \\cdot \\mathbf{v} + \\nabla_{\\mathbf{v}}Q \\cdot (-\\nabla_{\\mathbf{x}}\\Phi) = 0\n$$\n\n**1. 比能守恒**\n\n粒子的比能（单位质量的能量）是其比动能和势能之和：\n$$\nE(\\mathbf{x}, \\mathbf{v}) = \\frac{1}{2}|\\mathbf{v}|^2 + \\Phi(\\mathbf{x}) = \\frac{1}{2}\\sum_i v_i^2 + \\Phi(x_1, x_2, \\dots)\n$$\n为了检查 $E$ 是否为不变量，我们计算其全时间导数：\n$$\n\\frac{dE}{dt} = \\nabla_{\\mathbf{x}}E \\cdot \\mathbf{v} + \\nabla_{\\mathbf{v}}E \\cdot (-\\nabla_{\\mathbf{x}}\\Phi)\n$$\n必要的梯度是：\n$$\n\\nabla_{\\mathbf{x}}E = \\nabla_{\\mathbf{x}}\\left(\\frac{1}{2}|\\mathbf{v}|^2 + \\Phi(\\mathbf{x})\\right) = \\nabla_{\\mathbf{x}}\\Phi(\\mathbf{x})\n$$\n$$\n\\nabla_{\\mathbf{v}}E = \\nabla_{\\mathbf{v}}\\left(\\frac{1}{2}\\sum_i v_i^2 + \\Phi(\\mathbf{x})\\right) = \\mathbf{v}\n$$\n将这些梯度代入 $\\frac{dE}{dt}$ 的表达式中：\n$$\n\\frac{dE}{dt} = (\\nabla_{\\mathbf{x}}\\Phi) \\cdot \\mathbf{v} + \\mathbf{v} \\cdot (-\\nabla_{\\mathbf{x}}\\Phi) = (\\nabla_{\\mathbf{x}}\\Phi) \\cdot \\mathbf{v} - \\mathbf{v} \\cdot (\\nabla_{\\mathbf{x}}\\Phi) = 0\n$$\n因此，对于任何不随时间变化的势 $\\Phi(\\mathbf{x})$，比能 $E$ 都是守恒的。这适用于所有五个给定的测试用例。\n\n**2. 比角动量守恒**\n\n比角动量矢量定义为 $\\mathbf{L} = \\mathbf{x} \\times \\mathbf{v}$。其全时间导数为：\n$$\n\\frac{d\\mathbf{L}}{dt} = \\frac{d}{dt}(\\mathbf{x} \\times \\mathbf{v}) = \\frac{d\\mathbf{x}}{dt} \\times \\mathbf{v} + \\mathbf{x} \\times \\frac{d\\mathbf{v}}{dt}\n$$\n代入特征方程：\n$$\n\\frac{d\\mathbf{L}}{dt} = \\mathbf{v} \\times \\mathbf{v} + \\mathbf{x} \\times (-\\nabla_{\\mathbf{x}}\\Phi)\n$$\n由于任何矢量与其自身的叉积为零（$\\mathbf{v} \\times \\mathbf{v} = \\mathbf{0}$），这简化为：\n$$\n\\frac{d\\mathbf{L}}{dt} = -\\mathbf{x} \\times \\nabla_{\\mathbf{x}}\\Phi\n$$\n矢量 $\\mathbf{\\tau} = \\mathbf{x} \\times \\mathbf{F}$（其中力为 $\\mathbf{F} = -\\nabla_{\\mathbf{x}}\\Phi$）代表比力矩。要使 $\\mathbf{L}$ 成为运动常数，其导数必须为零，这要求比力矩为零：$\\mathbf{x} \\times \\nabla_{\\mathbf{x}}\\Phi = \\mathbf{0}$。当且仅当势的梯度 $\\nabla_{\\mathbf{x}}\\Phi$ 与位置矢量 $\\mathbf{x}$ 平行时，此条件才满足。这是中心力的定义，它源于球对称势，即仅依赖于径向距离 $r=|\\mathbf{x}|$ 的势，使得 $\\Phi(\\mathbf{x}) = \\Phi(r)$。\n\n对于在 $x$-$y$ 平面内的二维运动，我们关心角动量的 $z$ 分量，$L_z = x v_y - y v_x$。\n$$\n\\frac{dL_z}{dt} = \\frac{d}{dt}(x v_y - y v_x) = (\\dot{x}v_y + x\\dot{v}_y) - (\\dot{y}v_x + y\\dot{v}_x)\n$$\n代入 $\\dot{x}=v_x$，$\\dot{y}=v_y$，$\\dot{v}_x = -\\partial_x\\Phi$ 和 $\\dot{v}_y=-\\partial_y\\Phi$：\n$$\n\\frac{dL_z}{dt} = (v_x v_y - x \\partial_y\\Phi) - (v_y v_x - y \\partial_x\\Phi) = y \\partial_x\\Phi - x \\partial_y\\Phi\n$$\n如果势是球对称的，该项为零。让我们分析这些测试用例：\n- 用例 1、2、3、5 涉及的势仅为 $r$ 的函数（$\\Phi=0$, $\\Phi=\\tfrac{1}{2}\\omega^2 r^2$, $\\Phi=-GM/r$）。这些是球对称的，因此 $L_z$ 是一个解析不变量。\n- 用例 4 涉及的势为 $\\Phi(\\mathbf{x})=\\tfrac{1}{2}(\\omega_x^2 x^2+\\omega_y^2 y^2)$。这里，$\\partial_x\\Phi = \\omega_x^2 x$ 且 $\\partial_y\\Phi = \\omega_y^2 y$。$L_z$ 的变化率为：\n  $$ \\frac{dL_z}{dt} = y(\\omega_x^2 x) - x(\\omega_y^2 y) = xy(\\omega_x^2 - \\omega_y^2) $$\n  由于 $\\omega_x \\neq \\omega_y$，除非粒子沿坐标轴之一运动（$x=0$ 或 $y=0$），$L_z$ 不守恒。对于给定的初始条件，轨道是一般的，因此 $L_z$ 将不守恒。\n\n### 第二部分：数值积分与验证\n\n我们使用踢-漂移-踢（KDK）蛙跳算法，这是一种二阶辛积分器。给定在时间 $t_n$ 的状态 $(\\mathbf{x}_n, \\mathbf{v}_n)$，在 $t_{n+1} = t_n + \\Delta t$ 的状态计算如下：\n1.  **踢（半步）**：$\\mathbf{v}_{n+1/2} = \\mathbf{v}_n + \\mathbf{a}(\\mathbf{x}_n) \\frac{\\Delta t}{2}$\n2.  **漂移（全步）**：$\\mathbf{x}_{n+1} = \\mathbf{x}_n + \\mathbf{v}_{n+1/2} \\Delta t$\n3.  **踢（半步）**：$\\mathbf{v}_{n+1} = \\mathbf{v}_{n+1/2} + \\mathbf{a}(\\mathbf{x}_{n+1}) \\frac{\\Delta t}{2}$\n其中 $\\mathbf{a}(\\mathbf{x}) = -\\nabla_{\\mathbf{x}}\\Phi(\\mathbf{x})$ 是加速度。该方法非常适用于哈密顿系统，因为它能在长时间内近似地保持能量守恒（误差有界），并且在中心势中能精确地保持角动量等其他不变量。\n\n我们将为每个测试用例实现此算法，跟踪轨迹上 $E$ 和 $L_z$ 的值，并计算它们相对于初始值的最大漂移。最终的布尔值将指示这些漂移是否在指定的容差范围内。对于各向异性情况，我们预期 $L_z$ 的守恒检查会失败，正如解析推导的那样。对于径向运动的情况，初始角动量 $L_{z,0}=0$。问题的对称性将使轨迹保持在x轴上，因此 $L_z$ 应保持为零，直至机器精度。对于这种情况，将使用绝对漂移进行守恒检查。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the final results.\n    \"\"\"\n    T = 30.0\n    dt = 0.005\n    eps_E = 1e-4\n    eps_L = 1e-4\n    Q_min = 1e-12\n\n    def run_simulation(x0, v0, phi_func, a_func, T, dt, eps_E, eps_L, Q_min):\n        \"\"\"\n        Integrates a particle's trajectory using the leapfrog method\n        and checks for conservation of energy and angular momentum.\n        \"\"\"\n        n_steps = int(T / dt)\n        x = np.copy(x0)\n        v = np.copy(v0)\n\n        # Initial values of invariants\n        E0 = 0.5 * np.dot(v, v) + phi_func(x)\n        Lz0 = x[0] * v[1] - x[1] * v[0]\n        \n        E_hist = [E0]\n        Lz_hist = [Lz0]\n\n        for _ in range(n_steps):\n            # Kick-Drift-Kick Leapfrog\n            v_half = v + a_func(x) * dt / 2.0\n            x = x + v_half * dt\n            v = v_half + a_func(x) * dt / 2.0\n            \n            # Calculate invariants at the end of the step\n            E = 0.5 * np.dot(v, v) + phi_func(x)\n            Lz = x[0] * v[1] - x[1] * v[0]\n            \n            E_hist.append(E)\n            Lz_hist.append(Lz)\n\n        # Convert to numpy arrays for vectorized operations\n        E_hist = np.array(E_hist)\n        Lz_hist = np.array(Lz_hist)\n\n        # --- Energy Conservation Check ---\n        max_abs_drift_E = np.max(np.abs(E_hist - E0))\n        if np.abs(E0) >= Q_min:\n            drift_E = max_abs_drift_E / np.abs(E0)\n        else:\n            drift_E = max_abs_drift_E\n        E_preserved = drift_E = eps_E\n\n        # --- Angular Momentum Conservation Check ---\n        max_abs_drift_Lz = np.max(np.abs(Lz_hist - Lz0))\n        if np.abs(Lz0) >= Q_min:\n            drift_Lz = max_abs_drift_Lz / np.abs(Lz0)\n        else:\n            drift_Lz = max_abs_drift_Lz\n        Lz_preserved = drift_Lz = eps_L\n\n        return E_preserved, Lz_preserved\n\n    # --- Test Case Definitions ---\n    \n    # Case 1: Free particle\n    phi_free = lambda x: 0.0\n    a_free = lambda x: np.array([0.0, 0.0])\n    \n    # Case 2: Central harmonic\n    omega_ch = 0.5\n    phi_central_harmonic = lambda x: 0.5 * omega_ch**2 * np.dot(x, x)\n    a_central_harmonic = lambda x: -omega_ch**2 * x\n\n    # Case 3: Kepler potential\n    GM = 1.0\n    def phi_kepler(x):\n        r = np.linalg.norm(x)\n        return -GM / r if r > 0 else -np.inf\n    def a_kepler(x):\n        r = np.linalg.norm(x)\n        return -GM * x / r**3 if r > 0 else np.array([0.0, 0.0])\n\n    # Case 4: Anisotropic harmonic\n    omega_x, omega_y = 1.0, 1.3\n    phi_anisotropic = lambda x: 0.5 * (omega_x**2 * x[0]**2 + omega_y**2 * x[1]**2)\n    a_anisotropic = lambda x: np.array([-omega_x**2 * x[0], -omega_y**2 * x[1]])\n\n    # Case 5: Radial central harmonic (same physics as case 2)\n    \n    test_cases = [\n        # (x0, v0, phi_func, a_func)\n        (np.array([1.0, 0.0]), np.array([0.0, 0.5]), phi_free, a_free),\n        (np.array([1.0, 0.0]), np.array([0.0, 0.8]), phi_central_harmonic, a_central_harmonic),\n        (np.array([1.0, 0.0]), np.array([0.0, 1.0]), phi_kepler, a_kepler),\n        (np.array([1.0, 0.0]), np.array([0.0, 1.0]), phi_anisotropic, a_anisotropic),\n        (np.array([1.0, 0.0]), np.array([-0.5, 0.0]), phi_central_harmonic, a_central_harmonic),\n    ]\n\n    results = []\n    for x0, v0, phi, a in test_cases:\n        E_pres, Lz_pres = run_simulation(x0, v0, phi, a, T, dt, eps_E, eps_L, Q_min)\n        results.append(E_pres)\n        results.append(Lz_pres)\n    \n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3494458"}, {"introduction": "在探索了单粒子动力学之后，我们现在转向自引力起关键作用的集体现象。双流不稳定性是一个经典例子，它展示了动力学理论如何预测初始密度扰动的增长，这是宇宙结构形成中的一个关键过程 [@problem_id:3494537]。本练习要求您从弗拉索夫-泊松方程组出发，推导该不稳定性的色散关系并计算其增长率，从而将线性微扰理论与可观测的宇宙联系起来。", "problem": "考虑一个由弗拉索夫-泊松方程描述的一维、无碰撞自引力系统。描述相空间分布函数 $f(x,v,t)$ 的弗拉索夫方程为 $\\partial_t f + v\\,\\partial_x f - \\partial_x \\phi\\,\\partial_v f = 0$，描述引力势 $\\phi(x,t)$ 的泊松方程为 $\\partial_{xx} \\phi = 4\\pi G\\left(\\rho(x,t) - \\rho_0\\right)$，其中 $\\rho(x,t)=\\int_{-\\infty}^{\\infty} f(x,v,t)\\,dv$ 且 $\\rho_0$ 是均匀背景密度。在均匀背景中初始化两束冷流，其分布函数为 $f(x,v,0)=\\frac{\\rho_0}{2}\\,\\delta(v-v_0)+\\frac{\\rho_0}{2}\\,\\delta(v+v_0)$，其中 $\\delta$ 表示狄拉克 $\\delta$ 函数。假设小振幅微扰在空间和时间上呈 $\\propto e^{i(kx-\\omega t)}$ 的正弦形式，其波数为 $k$，复频率为 $\\omega$。\n\n从上述基本定律和核心定义出发，利用第一性原理推导出一个合适的线性化描述，以捕捉此冷束流构型下引力双流增长的现象。将增长率表示为在给定 $k$ 值下，与增长最快的线性模式相关联的复频率 $\\omega$ 的正虚部。你必须确保你的推导在逻辑上是一致的，从弗拉索夫-泊松系统开始，并且不假设或引用目标色散关系。\n\n使用 $G=1$ 的无量纲代码单位（因此所有量均为无量纲），对以下测试套件中的每个参数集，数值计算其最大线性增长率。每个测试用例的最终增长率必须以一个实值浮点数的形式返回，该浮点数代表在这些代码单位下的逆时间。该测试套件涵盖了以下代表性用例：\n\n- 用例 $1$ （作为退化双流的单流极限）：$\\rho_0=1.0$, $v_0=0.0$, $k=0.1$.\n- 用例 $2$ （中等流速，长波长）：$\\rho_0=1.0$, $v_0=0.5$, $k=0.2$.\n- 用例 $3$ （强流速，短波长）：$\\rho_0=1.0$, $v_0=2.0$, $k=1.5$.\n- 用例 $4$ （判别式边界条件）：选择 $\\rho_0=1.0, v_0=1.0$，并设置 $k=\\sqrt{(A/4)/v_0^2}$，其中 $A=2\\pi G\\rho_0$，即 $k=\\sqrt{\\pi/2}\\approx 1.253314$.\n- 用例 $5$ （无引力基线）：$\\rho_0=0.0$, $v_0=1.0$, $k=2.0$.\n\n你的程序必须为每个用例计算由你的推导所蕴含的所有线性模式中的最大线性增长率 $\\gamma_{\\max}=\\max\\{\\mathrm{Im}(\\omega)\\}$。如果不存在不稳定模式，则该用例返回 $0.0$。你的程序应生成单行输出，其中包含一个由方括号括起来的逗号分隔列表（例如，$[$result1,result2,result3$]$），结果的顺序与上述用例的顺序完全一致。不允许任何外部输入，所有计算都必须使用指定的代码单位进行，不得使用任何外部数据。本问题不涉及角度；请勿引入任何角度单位。所有最终输出都必须是浮点数，单位为指定无量纲系统中的逆时间。", "solution": "用户提供了一个有效且适定的问题，该问题基于动理学理论和引力动力学的标准原理。任务是从第一性原理出发，推导自引力双流系统的色散关系，然后用它来计算几个特定情况下的最大线性增长率。\n\n### 从第一性原理推导\n\n该系统由一维弗拉索夫-泊松方程描述。弗拉索夫方程控制相空间分布函数 $f(x,v,t)$ 的演化：\n$$\n\\frac{\\partial f}{\\partial t} + v \\frac{\\partial f}{\\partial x} - \\frac{\\partial \\phi}{\\partial x} \\frac{\\partial f}{\\partial v} = 0\n$$\n泊松方程将引力势 $\\phi(x,t)$ 与质量密度 $\\rho(x,t)$ 联系起来：\n$$\n\\frac{\\partial^2 \\phi}{\\partial x^2} = 4\\pi G \\left( \\rho(x,t) - \\rho_0 \\right)\n$$\n其中质量密度是分布函数的速度积分，$\\rho(x,t) = \\int_{-\\infty}^{\\infty} f(x,v,t) \\, dv$。\n\n我们通过将每个量分解为一个均匀背景分量（下标为 $0$）和一个小的一阶微扰（下标为 $1$）来对系统进行线性化：\n$f(x,v,t) = f_0(v) + f_1(x,v,t)$\n$\\phi(x,t) = \\phi_0 + \\phi_1(x,t)$\n\n背景分布是关于 $v=0$ 对称的两束冷流：\n$$\nf_0(v) = \\frac{\\rho_0}{2} \\left[ \\delta(v-v_0) + \\delta(v+v_0) \\right]\n$$\n背景密度为 $\\int f_0(v) dv = \\rho_0/2 + \\rho_0/2 = \\rho_0$。背景势 $\\phi_0$ 必须满足未受扰动的泊松方程，$\\partial_{xx}\\phi_0 = 4\\pi G(\\rho_0 - \\rho_0) = 0$。这意味着 $\\phi_0$ 是一个常数，因此背景引力 $-\\partial_x \\phi_0$ 为零。分布 $f_0(v)$ 与 $x$ 和 $t$ 无关，因此它是弗拉索夫方程的一个有效平衡解。\n\n将微扰量代入弗拉索夫方程，并只保留一阶项，得到线性化的弗拉索夫方程：\n$$\n\\frac{\\partial f_1}{\\partial t} + v \\frac{\\partial f_1}{\\partial x} - \\frac{\\partial \\phi_1}{\\partial x} \\frac{\\partial f_0}{\\partial v} = 0\n$$\n类似地，线性化的泊松方程为：\n$$\n\\frac{\\partial^2 \\phi_1}{\\partial x^2} = 4\\pi G \\rho_1\n$$\n其中 $\\rho_1(x,t) = \\int f_1(x,v,t) \\, dv$。\n\n我们假设微扰呈正弦形式，波数为 $k$，复频率为 $\\omega$，形式为 $e^{i(kx-\\omega t)}$。这使我们可以用代数算子替换偏导数：$\\partial_t \\to -i\\omega$ 和 $\\partial_x \\to ik$。将此应用于关于傅里叶振幅 $\\hat{f}_1(v)$ 和 $\\hat{\\phi}_1$ 的线性化弗拉索夫方程：\n$$\n-i\\omega \\hat{f}_1 + ikv \\hat{f}_1 - ik\\hat{\\phi}_1 \\frac{\\partial f_0}{\\partial v} = 0\n$$\n求解 $\\hat{f}_1$：\n$$\n-i(\\omega-kv)\\hat{f}_1 = ik\\hat{\\phi}_1 \\frac{\\partial f_0}{\\partial v} \\implies \\hat{f}_1(v) = -\\frac{k}{\\omega-kv}\\hat{\\phi}_1 \\frac{\\partial f_0}{\\partial v}\n$$\n微扰密度振幅 $\\hat{\\rho}_1$ 通过对 $\\hat{f}_1(v)$ 进行速度积分得到：\n$$\n\\hat{\\rho}_1 = \\int_{-\\infty}^{\\infty} \\hat{f}_1(v) \\, dv = -k\\hat{\\phi}_1 \\int_{-\\infty}^{\\infty} \\frac{1}{\\omega-kv} \\frac{\\partial f_0}{\\partial v} \\, dv\n$$\n我们使用分部积分法来简化该积分：$\\int u \\, dv' = [uv] - \\int v \\, du'$。令 $u = \\frac{1}{\\omega-kv}$ 且 $dv' = \\frac{\\partial f_0}{\\partial v}dv$。则 $du = \\frac{k}{(\\omega-kv)^2}dv$ 且 $v' = f_0$。由于当 $|v| \\to \\infty$ 时 $f_0 \\to 0$，边界项 $[uv]$ 消失。\n$$\n\\int_{-\\infty}^{\\infty} \\frac{1}{\\omega-kv} \\frac{\\partial f_0}{\\partial v} \\, dv = - \\int_{-\\infty}^{\\infty} f_0(v) \\frac{k}{(\\omega-kv)^2} \\, dv\n$$\n将此代回到 $\\hat{\\rho}_1$ 的表达式中：\n$$\n\\hat{\\rho}_1 = -k\\hat{\\phi}_1 \\left( -k \\int_{-\\infty}^{\\infty} \\frac{f_0(v)}{(\\omega-kv)^2} \\, dv \\right) = k^2\\hat{\\phi}_1 \\int_{-\\infty}^{\\infty} \\frac{f_0(v)}{(\\omega-kv)^2} \\, dv\n$$\n傅里叶变换后的泊松方程为 $(ik)^2\\hat{\\phi}_1 = 4\\pi G \\hat{\\rho}_1$，即 $-k^2\\hat{\\phi}_1 = 4\\pi G \\hat{\\rho}_1$。\n代入 $\\hat{\\rho}_1$ 的表达式：\n$$\n-k^2\\hat{\\phi}_1 = 4\\pi G \\left( k^2\\hat{\\phi}_1 \\int_{-\\infty}^{\\infty} \\frac{f_0(v)}{(\\omega-kv)^2} \\, dv \\right)\n$$\n对于非平庸解（$\\hat{\\phi}_1 \\neq 0$）和 $k \\neq 0$ 的情况，我们可以消去 $k^2\\hat{\\phi}_1$ 以获得自引力系统的广义色散关系：\n$$\n-1 = 4\\pi G \\int_{-\\infty}^{\\infty} \\frac{f_0(v)}{(\\omega-kv)^2} \\, dv\n$$\n现在，我们针对给定的双流分布 $f_0(v) = \\frac{\\rho_0}{2} [ \\delta(v-v_0) + \\delta(v+v_0) ]$ 来计算该式。积分变为：\n$$\n\\int \\frac{f_0(v)}{(\\omega-kv)^2} dv = \\frac{\\rho_0}{2} \\int \\frac{\\delta(v-v_0) + \\delta(v+v_0)}{(\\omega-kv)^2} dv = \\frac{\\rho_0}{2} \\left[ \\frac{1}{(\\omega-kv_0)^2} + \\frac{1}{(\\omega+kv_0)^2} \\right]\n$$\n色散关系简化为一个关于 $\\omega$ 的代数方程：\n$$\n-1 = 4\\pi G \\cdot \\frac{\\rho_0}{2} \\left[ \\frac{1}{(\\omega-kv_0)^2} + \\frac{1}{(\\omega+kv_0)^2} \\right]\n$$\n令 $\\omega_J^2 = 2\\pi G \\rho_0$。\n$$\n-1 = \\omega_J^2 \\left[ \\frac{(\\omega+kv_0)^2 + (\\omega-kv_0)^2}{((\\omega-kv_0)(\\omega+kv_0))^2} \\right] = \\omega_J^2 \\frac{2\\omega^2 + 2(kv_0)^2}{(\\omega^2-(kv_0)^2)^2}\n$$\n重新整理后得到一个关于 $\\omega$ 的四次方程，它是一个关于 $X = \\omega^2$ 的二次方程：\n$$\n-(\\omega^2 - (kv_0)^2)^2 = 2\\omega_J^2 (\\omega^2 + (kv_0)^2) \\\\\n-\\left(X^2 - 2X(kv_0)^2 + (kv_0)^4\\right) = 2\\omega_J^2 X + 2\\omega_J^2(kv_0)^2 \\\\\nX^2 + 2(\\omega_J^2 - (kv_0)^2)X + ( (kv_0)^4 + 2\\omega_J^2(kv_0)^2 ) = 0\n$$\n求解这个关于 $X = \\omega^2$ 的二次方程：\n$$\n\\omega^2 = -(\\omega_J^2 - (kv_0)^2) \\pm \\sqrt{(\\omega_J^2 - (kv_0)^2)^2 - ((kv_0)^4 + 2\\omega_J^2(kv_0)^2)} \\\\\n\\omega^2 = (kv_0)^2 - \\omega_J^2 \\pm \\sqrt{\\omega_J^4 - 2\\omega_J^2(kv_0)^2 + (kv_0)^4 - (kv_0)^4 - 2\\omega_J^2(kv_0)^2} \\\\\n\\omega^2 = (kv_0)^2 - \\omega_J^2 \\pm \\sqrt{\\omega_J^4 - 4\\omega_J^2(kv_0)^2} \\\\\n\\omega^2 = (kv_0)^2 - \\omega_J^2 \\pm \\omega_J \\sqrt{\\omega_J^2 - 4(kv_0)^2}\n$$\n如果 $\\omega$ 具有正虚部，即 $\\gamma = \\mathrm{Im}(\\omega) > 0$，则存在不稳定性。当 $\\omega^2$ 为负数或复数时会发生这种情况。令 $D = \\omega_J^2 - 4(kv_0)^2$ 为根式内的判别式。\n\n情况 I：$D \\geq 0$ （即 $k^2v_0^2 \\leq \\omega_J^2/4$）。\n$\\omega^2$ 的两个解都是实数。可以证明这两个解都是负数，对应两个纯增长/衰减模式。增长率 $\\gamma$ 由 $\\gamma^2 = -\\omega^2$ 给出。我们寻求最大增长率，它对应于最负的 $\\omega^2$：\n$$\n\\gamma_{\\max}^2 = - \\left( (kv_0)^2 - \\omega_J^2 - \\omega_J \\sqrt{\\omega_J^2 - 4(kv_0)^2} \\right) = \\omega_J^2 - (kv_0)^2 + \\omega_J \\sqrt{\\omega_J^2 - 4(kv_0)^2}\n$$\n\n情况 II：$D  0$ （即 $k^2v_0^2 > \\omega_J^2/4$）。\n$\\omega^2$ 的解是一对共轭复数。令 $\\omega = \\omega_r + i\\gamma$。则 $\\omega^2 = (\\omega_r^2 - \\gamma^2) + i(2\\omega_r\\gamma)$。对 $\\omega^2$ 的实部和虚部分析表明，在这种情况下总存在不稳定模式。增长率的平方由下式给出：\n$$\n\\gamma^2 = \\frac{1}{2} \\left( \\omega_J^2 - (kv_0)^2 + \\sqrt{((kv_0)^2)^2 + 2(kv_0)^2\\omega_J^2} \\right)\n$$\n在这种情况下，只有一个正增长率，也就是最大增长率。\n\n特殊情况：\n- 如果 $\\rho_0 = 0$，则 $\\omega_J^2 = 0$。色散关系 $-1=0$ 没有解，这意味着没有集体模式，且 $\\gamma=0$。\n- 如果 $v_0 = 0$，系统是一束单一的冷流。这属于情况 I。公式给出 $\\gamma_{\\max}^2 = \\omega_J^2 + \\omega_J^2 = 2\\omega_J^2 = 2(2\\pi G \\rho_0) = 4\\pi G \\rho_0$。增长率为 $\\gamma = \\sqrt{4\\pi G \\rho_0}$，即经典的琴斯不稳定性增长率，它与 $k$ 无关。\n\n现在我们使用这些公式，在 $G=1$ 的条件下，为给定的测试用例计算增长率。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves for the maximum linear growth rate of the gravitational two-stream instability\n    for a series of test cases.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1 (single-stream limit as a degenerate two-stream):\n        {'rho0': 1.0, 'v0': 0.0, 'k': 0.1},\n        # Case 2 (moderate streaming, long wavelength):\n        {'rho0': 1.0, 'v0': 0.5, 'k': 0.2},\n        # Case 3 (strong streaming, short wavelength):\n        {'rho0': 1.0, 'v0': 2.0, 'k': 1.5},\n        # Case 4 (discriminant boundary condition):\n        {'rho0': 1.0, 'v0': 1.0, 'k': np.sqrt(np.pi / 2.0)},\n        # Case 5 (no gravity baseline):\n        {'rho0': 0.0, 'v0': 1.0, 'k': 2.0},\n    ]\n\n    results = []\n    G = 1.0\n\n    for case in test_cases:\n        rho0 = case['rho0']\n        v0 = case['v0']\n        k = case['k']\n\n        # If there is no mass, there is no gravity, and thus no instability.\n        if rho0 == 0.0:\n            results.append(0.0)\n            continue\n        \n        # Calculate key parameters from the derived dispersion relation.\n        # omega_J^2 = 2 * pi * G * rho_0\n        omega_J_sq = 2.0 * np.pi * G * rho0\n        kv0_sq = (k * v0)**2\n\n        # The behavior of the instability is determined by the sign of the discriminant D.\n        # D = omega_J^2 - 4 * (k*v_0)^2\n        discriminant = omega_J_sq - 4.0 * kv0_sq\n\n        if discriminant >= 0:\n            # Regime 1: Two purely growing modes exist.\n            # The maximum growth rate corresponds to the most negative omega^2 solution.\n            # gamma_max^2 = omega_J^2 - (kv_0)^2 + omega_J * sqrt(omega_J^2 - 4*(kv_0)^2)\n            gamma_sq = (\n                omega_J_sq - kv0_sq +\n                np.sqrt(omega_J_sq) * np.sqrt(discriminant)\n            )\n        else: # discriminant  0\n            # Regime 2: A pair of complex conjugate modes exists.\n            # gamma^2 = 0.5 * [omega_J^2 - (kv_0)^2 + sqrt(((kv_0)^2)^2 + 2*(kv_0)^2*omega_J^2)]\n            term_under_sqrt = kv0_sq**2 + 2.0 * kv0_sq * omega_J_sq\n            gamma_sq = 0.5 * (omega_J_sq - kv0_sq + np.sqrt(term_under_sqrt))\n\n        # The growth rate gamma is the square root of gamma_sq.\n        # gamma_sq should always be non-negative from the derivation.\n        # We take max(0, ...) as a safeguard against small negative numbers from floating point errors.\n        gamma_max = np.sqrt(max(0.0, gamma_sq))\n        results.append(gamma_max)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3494537"}, {"introduction": "线性理论描述了结构增长的开端，但当扰动变大时会发生什么呢？本练习使用 Zel'dovich 近似深入探讨非线性阶段，该近似为引力坍缩的初始阶段提供了一个出色的模型 [@problem_id:3494498]。通过模拟一维“薄饼”（pancakes）的形成并对产生的物质流进行计数，您将直接观察到壳层穿越和焦散面的形成，这突显了为何相空间描述对于理解错综复杂的宇宙结构网至关重要。", "problem": "您将在一个空间维度下，在膨胀背景中研究由无碰撞玻尔兹曼方程（也称弗拉索夫方程）和牛顿引力控制的无碰撞冷暗物质。考虑由拉格朗日坐标 $q$ 中的单值相空间片表示的冷初始条件，在线性区使用一阶拉格朗日微扰理论将其演化到欧拉坐标 $x$，并通过对拉格朗日根求和，将映射延续到壳层穿越之后。假设初始单位质量的奇特引力势为单模余弦形式，\n$$\\phi_0(q) = -\\frac{A}{k^2}\\cos(k q),$$\n其中振幅参数 $A>0$ 且波数 $k>0$。设 $D$ 为乘以位移场的线性增长因子。计算在共动无量纲单位制下进行，距离和角度以弧度为单位，并在任意自洽的单位下将背景均匀密度设为 $\\rho_0=1$。\n\n从一维的无碰撞玻尔兹曼（弗拉索夫）方程和牛顿动力学出发，\n$$\\frac{\\partial f}{\\partial t} + v \\frac{\\partial f}{\\partial x} - \\frac{\\partial \\Phi}{\\partial x}\\frac{\\partial f}{\\partial v} = 0,$$\n结合泊松方程和冷初始条件假设，推导针对此初始势的一维一阶拉格朗日映射 $x(q;D)$ 及其雅可比 $J(q;D)=\\partial x/\\partial q$。解释当映射不再单调时壳层穿越如何发生，并论证在欧拉位置 $x$ 处的流数等于满足 $x(q_i;D)=x$ 的不同拉格朗日根 $q_i$ 的数量。论证壳层穿越后的一维质量密度由下式给出\n$$\\rho(x;D) = \\sum_{i} \\frac{\\rho_0}{\\left|J(q_i;D)\\right|},$$\n其中求和遍及所有满足 $x(q_i;D)=x$ 的根 $q_i$。定性解释多流区如何因雅可比倒数之和以及 $J$ 在折叠焦散处的消失而与 $\\rho(x;D)$ 的峰值相关联。\n\n然后，设计并实现一个鲁棒的数值算法以：\n- 将拉格朗日域划分为由 $J(q;D)$ 的零点界定的单调段。\n- 对于给定的欧拉位置 $x_\\star$，通过在每个单调段上执行区间限定和二分法来求解 $x(q;D)=x_\\star$，从而计算拉格朗日根的数量。\n- 返回整数形式的流数 $N_{\\mathrm{streams}}(x_\\star;A,D,k)$。\n\n数值要求：\n- 对拉格朗日域使用基本周期 $q \\in [-\\pi/k,\\pi/k]$，并假设周期性边界条件。\n- 全程使用弧度作为角度单位和无量纲共动单位。\n- 在每个单调拉格朗日段中实现区间限定和二分法。为进行根检测，将绝对值小于 $10^{-12}$ 的函数值视为零，并避免在段边界处重复计数根。\n- 您的求解器应是确定性的，不需要任何随机数。\n\n测试套件和要求输出：\n- 您必须为以下六组参数 $(A,D,k,x_\\star)$ 计算整数流数 $N_{\\mathrm{streams}}$：\n  1. $(0.8, 0.9, 1.0, 0.3)$\n  2. $(1.0, 1.2, 1.0, 0.0)$\n  3. $(1.0, 1.2, 1.0, 1.0)$\n  4. $(1.5, 1.2, 1.0, 0.4)$\n  5. $(0.0, 2.0, 1.0, -0.7)$\n  6. $(1.0, 1.0, 1.0, 0.1)$\n\n最终输出格式：\n- 您的程序应产生单行输出，其中包含用方括号括起来的、以逗号分隔的整数结果，例如，“[r1,r2,r3,r4,r5,r6]”。\n- 唯一的打印输出必须是这一行。\n\n您的程序必须是使用现代编程语言编写的完整、可运行的实现。所有计算都是无量纲的；不需要进行物理单位转换，所有角度均以弧度为单位。所有测试用例的答案必须是如上所述的整数。", "solution": "该问题要求从基本原理出发，对一维冷暗物质的结构形成进行分析，并最终设计一个数值算法来计算给定位置的流数。\n\n像冷暗物质（CDM）这样的无碰撞流体的演化由无碰撞玻尔兹曼方程（也称弗拉索夫方程）控制：\n$$\n\\frac{\\partial f}{\\partial t} + v \\frac{\\partial f}{\\partial x} - \\frac{\\partial \\Phi}{\\partial x}\\frac{\\partial f}{\\partial v} = 0\n$$\n此处，$f(x, v, t)$ 是相空间分布函数，$x$ 是共动位置，$v$ 是奇特速度，$\\Phi(x, t)$ 是奇特引力势。该势通过泊松方程与质量密度 $\\rho(x, t)$ 耦合。对于 CDM，初始条件是“冷的”，意味着速度弥散为零。初始相空间分布是一个由 $f(x, v, t=0) = \\rho_0 \\delta(v - v_0(x))$ 描述的片，其中 $\\delta$ 是 Dirac δ函数。\n\n这种冷片结构在拉格朗日坐标中随时间保持不变。动力学可以通过将初始（拉格朗日）位置 $q$ 映射到之后时间的最终（欧拉）位置 $x$ 来描述。在一阶拉格朗日微扰理论（LPT），也称为 Zel'dovich 近似中，此映射由下式给出：\n$$\nx(q; D) = q + D(t) s(q)\n$$\n其中 $D(t)$ 是包含时间演化的线性增长因子，$s(q)$ 是初始位移场。在一维中，位移场与初始引力势的梯度成正比。势的极小值必须吸引粒子，因此位于 $q>q_{min}$ 的粒子应有负位移，而位于 $qq_{min}$ 的粒子应有正位移，从而朝向势的极小值移动。这要求位移场与引力势的负梯度成正比。\n初始位移场 $s(q)$ 与初始奇特引力势 $\\phi_0$ 相关，通过 $s(q) = -\\frac{d\\phi_0}{dq}$。对于给定的势 $\\phi_0(q) = -\\frac{A}{k^2}\\cos(k q)$，我们有：\n$$\ns(q) = -\\frac{d}{dq}\\left(-\\frac{A}{k^2}\\cos(k q)\\right) = -\\frac{A}{k}\\sin(k q)\n$$\n因此，Zel'dovich 映射为：\n$$\nx(q; D) = q - \\frac{AD}{k} \\sin(k q)\n$$\n映射的雅可比 $J$ 是欧拉位置相对于拉格朗日位置的导数：\n$$\nJ(q; D) = \\frac{\\partial x}{\\partial q} = 1 - AD \\cos(k q)\n$$\n当 $AD \\le 1$ 时，$J \\ge 0$ 且映射是单调的，这意味着每个拉格朗日位置 $q$ 映射到一个唯一的欧拉位置 $x$。然而，当 $AD > 1$ 时，$J$ 可以为负，映射不再单调。壳层穿越发生在雅可比首次为零的时刻，即 $AD=1$ 时在 $q=0$ 处。对于 $AD > 1$ 的情况，在某些欧拉位置 $x$ 处，可能有多个拉格朗日坐标 $q_i$ 映射到同一点，即 $x(q_i;D)=x$。这些不同的 $q_i$ 对应于来自不同初始位置的物质流，它们在 $x$ 处相交。在 $x$ 处的流数就是满足此方程的根 $q_i$ 的数量。\n\n根据质量守恒，一个小拉格朗日区间 $dq$ 中的质量 $\\rho_0 dq$ 被映射到一个欧拉区间 $dx$ 中，其中质量为 $\\rho(x) dx$。因此，$\\rho(x) = \\rho_0 \\frac{dq}{dx} = \\frac{\\rho_0}{J(q;D)}$。当存在多流时，总密度是每个流贡献的总和，即 $\\rho(x;D) = \\sum_i \\frac{\\rho_0}{|J(q_i;D)|}$。$|J|$ 中的绝对值是因为密度必须是正的。密度在 $J=0$ 的位置发散，这些位置称为焦散面，它们标志着多流区的边界。\n\n**数值算法：**\n\n为计算在给定欧拉位置 $x_\\star$ 处的流数，我们需要求解 $x(q;D) = x_\\star$ 的根的数量。\n1.  **确定单调段**：函数 $x(q;D)$ 在其导数 $J(q;D)$ 改变符号的位置（即 $J=0$）有极值。$J(q;D) = 1 - AD\\cos(kq) = 0$ 意味着 $\\cos(kq) = 1/(AD)$。\n    -   如果 $AD \\le 1$，则 $\\cos(kq)$ 永不等于 $1/(AD)$（或仅在 $AD=1$ 时在 $q=0$ 处等于），因此在基本域 $q \\in [-\\pi/k, \\pi/k]$ 内 $J(q;D)$ 不变号。整个域是一个单调段。\n    -   如果 $AD > 1$，则存在解 $kq = \\pm \\arccos(1/(AD))$。令 $\\alpha = \\arccos(1/(AD))$，则临界点为 $q_{c1} = -\\alpha/k$ 和 $q_{c2} = \\alpha/k$。这会将域 $[-\\pi/k, \\pi/k]$ 分为三个单调段：$[-\\pi/k, q_{c1}]$、$ [q_{c1}, q_{c2}]$ 和 $[q_{c2}, \\pi/k]$。\n\n2.  **根查找**：在每个单调段内，我们可以通过检查函数 $f(q) = x(q;D) - x_\\star$ 在段边界处的值来确定是否存在根。\n    -   如果 $f(q_{start}) \\cdot f(q_{end})  0$，则在该段内存在一个根。由于该段是单调的，所以根是唯一的。\n    -   如果 $f(q_{start})$ 或 $f(q_{end})$ 为零，则在边界上有一个根。我们需要小心，避免在相邻段的共享边界上重复计数根。\n\n    一个鲁棒的方法是：对每个开区间 $(q_i, q_{i+1})$ 检查符号变化来计数内部根。然后，检查所有边界点 $q_i$ 是否为根，并将它们相加，注意不要重复计数。\n\n此过程可以可靠地计算出任何给定 $x_\\star$ 的根的总数，即流数。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test cases.\n    It counts the number of streams for a 1D cold dark matter model.\n    \"\"\"\n    \n    # Test cases defined in the problem statement as (A, D, k, x_star)\n    test_cases = [\n        (0.8, 0.9, 1.0, 0.3),\n        (1.0, 1.2, 1.0, 0.0),\n        (1.0, 1.2, 1.0, 1.0),\n        (1.5, 1.2, 1.0, 0.4),\n        (0.0, 2.0, 1.0, -0.7),\n        (1.0, 1.0, 1.0, 0.1),\n    ]\n\n    results = []\n    for params in test_cases:\n        result = count_streams(*params)\n        results.append(result)\n\n    # Print the final output in the required format\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef count_streams(A: float, D: float, k: float, x_star: float) -> int:\n    \"\"\"\n    Calculates the number of streams N_streams for a given set of parameters.\n\n    The number of streams is the number of roots of the equation x(q) = x_star,\n    where x(q) = q - (A*D/k) * sin(k*q) is the Lagrangian-to-Eulerian mapping.\n\n    Args:\n        A: Amplitude parameter of the initial potential.\n        D: Linear growth factor.\n        k: Wavenumber of the initial potential.\n        x_star: The Eulerian position to evaluate.\n\n    Returns:\n        The integer number of streams at x_star.\n    \"\"\"\n    \n    # Numerical tolerance for checking if a value is zero.\n    tol = 1.0e-12\n\n    # The mapping function x(q)\n    # x(q) = q - (A*D/k) * sin(k*q)\n    # We need to find the number of roots for f(q) = x(q) - x_star = 0\n    C = A * D\n    \n    def f(q: float) -> float:\n        \"\"\"The function whose roots we need to count: f(q) = x(q) - x_star.\"\"\"\n        # Handle the k=0 case to avoid division by zero, though k>0 is assumed.\n        if abs(k)  tol:\n            return q - x_star\n        return q - (C / k) * np.sin(k * q) - x_star\n\n    # The Lagrangian domain is q in [-pi/k, pi/k].\n    q_min = -np.pi / k\n    q_max = np.pi / k\n\n    # Determine monotonic segments based on the value of AD.\n    # Shell crossing occurs if AD > 1.\n    if C = 1.0:\n        # If AD = 1, x(q) is monotonic over the entire domain.\n        # The domain consists of a single segment.\n        segment_boundaries = [q_min, q_max]\n    else:\n        # If AD > 1, shell crossing occurred. x(q) has local extrema.\n        # The extrema are at J(q) = 1 - AD*cos(k*q) = 0.\n        # This gives cos(k*q) = 1/AD.\n        alpha = np.arccos(1.0 / C)\n        q_crit1 = -alpha / k\n        q_crit2 = alpha / k\n        # The domain is split into three monotonic segments.\n        segment_boundaries = [q_min, q_crit1, q_crit2, q_max]\n\n    # Evaluate the function f(q) at the segment boundaries.\n    y_vals = [f(p) for p in segment_boundaries]\n\n    # Count roots within the open intervals (p_i, p_{i+1}).\n    # A root exists if f(p_i) and f(p_{i+1}) have opposite signs.\n    num_internal_roots = 0\n    for i in range(len(segment_boundaries) - 1):\n        if y_vals[i] * y_vals[i+1]  0:\n            num_internal_roots += 1\n\n    # Count roots that fall exactly on the segment boundaries.\n    # Use a set to avoid double-counting if extrema values are identical.\n    boundary_root_indices = set()\n    for i, y_val in enumerate(y_vals):\n        if abs(y_val)  tol:\n            boundary_root_indices.add(i)\n    \n    num_boundary_roots = len(boundary_root_indices)\n\n    # The total number of streams is the sum of internal and boundary roots.\n    total_streams = num_internal_roots + num_boundary_roots\n    \n    return total_streams\n\n# Execute the solver\nsolve()\n```", "id": "3494498"}]}