{"hands_on_practices": [{"introduction": "混合树-粒子网格（Tree-PM）方法的核心在于引力相互作用的数学分解。本练习将引导你从傅里叶空间的定义出发，推导出短程相互作用在实空间中的解析形式。掌握这一基本计算对于理解力分解的原理至关重要，也是分析和设计不同分解方案的基础 [@problem_id:3475892]。", "problem": "考虑数值宇宙学中的一种混合树-粒子网格（Tree-PM）方法，其中点质量的牛顿势通过一个共动平滑尺度为 $r_{s}$ 的高斯滤波器被分解为一个短程（树）部分和一个长程（粒子网格）部分。位于原点的点质量 $m$ 的牛顿势由 $\\phi_{\\mathrm{N}}(r)=-G m/r$ 给出，其中 $G$ 是引力常数，$r$ 是共动距离。在傅里叶空间中，使用约定 $\\phi(\\boldsymbol{k})=\\int \\mathrm{d}^{3}\\boldsymbol{r}\\,\\phi(\\boldsymbol{r})\\exp(-\\mathrm{i}\\,\\boldsymbol{k}\\cdot\\boldsymbol{r})$ 和 $\\phi(\\boldsymbol{r})=\\int \\mathrm{d}^{3}\\boldsymbol{k}\\,\\phi(\\boldsymbol{k})\\exp(\\mathrm{i}\\,\\boldsymbol{k}\\cdot\\boldsymbol{r})/(2\\pi)^{3}$，点质量的牛顿势的格林函数为 $\\Phi(\\boldsymbol{k})=-4\\pi G m/k^{2}$。通过将 $\\Phi(\\boldsymbol{k})$ 乘以一个高斯函数 $W(k)=\\exp(-k^{2} r_{s}^{2})$ 来实现高斯分解，从而将长程部分定义为 $\\Phi_{\\mathrm{LR}}(\\boldsymbol{k})=\\Phi(\\boldsymbol{k})W(k)$，短程部分定义为 $\\Phi_{\\mathrm{SR}}(\\boldsymbol{k})=\\Phi(\\boldsymbol{k})\\left[1-W(k)\\right]$。互补误差函数的定义为 $\\mathrm{erfc}(x)=1-\\mathrm{erf}(x)$，其中 $\\mathrm{erf}(x)=\\frac{2}{\\sqrt{\\pi}}\\int_{0}^{x}\\exp(-t^{2})\\,\\mathrm{d}t$。\n\n从这些定义和约定出发，并且除了所述的基本基础之外不引入任何捷径公式，通过傅里叶逆变换推导点质量的实空间短程势 $\\phi_{\\mathrm{SR}}(r)$，然后根据 $F_{\\mathrm{SR}}(r)=\\mathrm{d}\\phi_{\\mathrm{SR}}/\\mathrm{d}r$ 计算球对称径向短程力的大小 $F_{\\mathrm{SR}}(r)$。将最终的 $F_{\\mathrm{SR}}(r)$ 表示为以 $G$、$m$、$r$、$r_{s}$、$\\mathrm{erfc}$ 和 $\\exp$ 表示的单个闭式解析表达式。对任何物理量使用国际单位制（SI）；如果要进行数值计算，力的单位将是牛顿。不需要进行数值计算；提供一个精确表达式。不要四舍五入。最终答案必须仅为 $F_{\\mathrm{SR}}(r)$ 的显式解析表达式。", "solution": "该问题经检验具有科学依据，提法恰当且客观。它代表了数值宇宙学模拟背景下的一个标准计算。所有定义、约定和物理前提均与既定原则一致。因此，该问题被认为是有效的，并将推导出完整的解。\n\n目标是计算短程力的大小 $F_{\\mathrm{SR}}(r)$，根据问题定义，它是短程势的径向导数，$F_{\\mathrm{SR}}(r) = \\mathrm{d}\\phi_{\\mathrm{SR}}/\\mathrm{d}r$。为了实现这一点，我们必须首先推导实空间短程势 $\\phi_{\\mathrm{SR}}(r)$ 的表达式。\n\n问题陈述，傅里叶空间中的短程势 $\\Phi_{\\mathrm{SR}}(\\boldsymbol{k})$ 由全牛顿势与长程势之差给出：\n$$\n\\Phi_{\\mathrm{SR}}(\\boldsymbol{k}) = \\Phi(\\boldsymbol{k}) \\left[1-W(k)\\right] = \\Phi(\\boldsymbol{k}) - \\Phi_{\\mathrm{LR}}(\\boldsymbol{k})\n$$\n其中 $\\Phi(\\boldsymbol{k})$ 是全牛顿势 $\\phi_{\\mathrm{N}}(r)$ 的傅里叶变换，$\\Phi_{\\mathrm{LR}}(\\boldsymbol{k})$ 是长程势 $\\phi_{\\mathrm{LR}}(r)$ 的傅里叶变换。\n\n傅里叶逆变换是一种线性运算。将其应用于上述方程，可得到实空间中的关系：\n$$\n\\phi_{\\mathrm{SR}}(\\boldsymbol{r}) = \\mathcal{F}^{-1}[\\Phi_{\\mathrm{SR}}(\\boldsymbol{k})] = \\mathcal{F}^{-1}[\\Phi(\\boldsymbol{k})] - \\mathcal{F}^{-1}[\\Phi_{\\mathrm{LR}}(\\boldsymbol{k})]\n$$\n已知 $\\phi_{\\mathrm{N}}(r)=-G m/r$ 是 $\\Phi(\\boldsymbol{k})$ 的傅里叶逆变换，并且由于势是球对称的，我们可以将 $\\phi_{\\mathrm{SR}}(r)$ 写为：\n$$\n\\phi_{\\mathrm{SR}}(r) = \\phi_{\\mathrm{N}}(r) - \\phi_{\\mathrm{LR}}(r) = -\\frac{G m}{r} - \\phi_{\\mathrm{LR}}(r)\n$$\n我们的首要任务是通过对 $\\Phi_{\\mathrm{LR}}(\\boldsymbol{k})$ 进行傅里叶逆变换来计算 $\\phi_{\\mathrm{LR}}(r)$。问题给出了傅里叶约定：\n$$\n\\phi_{\\mathrm{LR}}(\\boldsymbol{r}) = \\int \\frac{\\mathrm{d}^3\\boldsymbol{k}}{(2\\pi)^3} \\Phi_{\\mathrm{LR}}(\\boldsymbol{k}) \\exp(\\mathrm{i}\\,\\boldsymbol{k}\\cdot\\boldsymbol{r})\n$$\n我们已知 $\\Phi_{\\mathrm{LR}}(\\boldsymbol{k}) = \\Phi(\\boldsymbol{k})W(k) = \\left(-\\frac{4\\pi G m}{k^2}\\right) \\exp(-k^2 r_s^2)$。将其代入积分：\n$$\n\\phi_{\\mathrm{LR}}(r) = \\int \\frac{\\mathrm{d}^3\\boldsymbol{k}}{(2\\pi)^3} \\left(-\\frac{4\\pi G m}{k^2}\\right) \\exp(-k^2 r_s^2) \\exp(\\mathrm{i}\\,\\boldsymbol{k}\\cdot\\boldsymbol{r})\n$$\n为了计算这个三维积分，我们切换到 $\\boldsymbol{k}$ 空间中的球坐标。设 z 轴与向量 $\\boldsymbol{r}$ 对齐，因此 $\\boldsymbol{r}$ 的大小为 $r=|\\boldsymbol{r}|$，且 $\\boldsymbol{k}\\cdot\\boldsymbol{r} = kr\\cos\\theta_k$，其中 $\\theta_k$ 是 $\\boldsymbol{k}$ 的极角。体积元是 $\\mathrm{d}^3\\boldsymbol{k} = k^2 \\sin\\theta_k \\, \\mathrm{d}k \\, \\mathrm{d}\\theta_k \\, \\mathrm{d}\\phi_k$。\n$$\n\\phi_{\\mathrm{LR}}(r) = -\\frac{4\\pi G m}{(2\\pi)^3} \\int_0^\\infty \\mathrm{d}k \\int_0^\\pi \\mathrm{d}\\theta_k \\int_0^{2\\pi} \\mathrm{d}\\phi_k \\, k^2 \\sin\\theta_k \\left(\\frac{1}{k^2}\\right) \\exp(-k^2 r_s^2) \\exp(\\mathrm{i}kr\\cos\\theta_k)\n$$\n对方位角 $\\phi_k$ 的积分得到 $2\\pi$。$k^2$ 项相互抵消。\n$$\n\\phi_{\\mathrm{LR}}(r) = -\\frac{8\\pi^2 G m}{8\\pi^3} \\int_0^\\infty \\mathrm{d}k \\, \\exp(-k^2 r_s^2) \\int_0^\\pi \\mathrm{d}\\theta_k \\, \\sin\\theta_k \\exp(\\mathrm{i}kr\\cos\\theta_k)\n$$\n$$\n\\phi_{\\mathrm{LR}}(r) = -\\frac{G m}{\\pi} \\int_0^\\infty \\mathrm{d}k \\, \\exp(-k^2 r_s^2) \\left[ \\int_0^\\pi \\sin\\theta_k \\exp(\\mathrm{i}kr\\cos\\theta_k) \\, \\mathrm{d}\\theta_k \\right]\n$$\n方括号中的积分可以通过代换 $u=\\cos\\theta_k$，$\\mathrm{d}u=-\\sin\\theta_k \\mathrm{d}\\theta_k$ 来求解：\n$$\n\\int_1^{-1} e^{\\mathrm{i}kru} (-\\mathrm{d}u) = \\int_{-1}^1 e^{\\mathrm{i}kru} \\mathrm{d}u = \\left[\\frac{e^{\\mathrm{i}kru}}{\\mathrm{i}kr}\\right]_{-1}^1 = \\frac{e^{\\mathrm{i}kr} - e^{-\\mathrm{i}kr}}{\\mathrm{i}kr} = \\frac{2\\sin(kr)}{kr}\n$$\n将此结果代回 $\\phi_{\\mathrm{LR}}(r)$ 的表达式中：\n$$\n\\phi_{\\mathrm{LR}}(r) = -\\frac{G m}{\\pi} \\int_0^\\infty \\exp(-k^2 r_s^2) \\frac{2\\sin(kr)}{kr} \\, \\mathrm{d}k = -\\frac{2 G m}{\\pi r} \\int_0^\\infty \\frac{\\sin(kr)}{k} \\exp(-k^2 r_s^2) \\, \\mathrm{d}k\n$$\n这个积分是与误差函数 $\\mathrm{erf}(x)$ 相关的一种标准形式。恒等式为 $\\int_0^\\infty \\frac{\\sin(ax)}{x} \\exp(-b^2 x^2) \\mathrm{d}x = \\frac{\\pi}{2} \\mathrm{erf}\\left(\\frac{a}{2b}\\right)$。在这里，我们有 $x=k$，$a=r$ 和 $b=r_s$。\n$$\n\\int_0^\\infty \\frac{\\sin(kr)}{k} \\exp(-k^2 r_s^2) \\, \\mathrm{d}k = \\frac{\\pi}{2} \\mathrm{erf}\\left(\\frac{r}{2r_s}\\right)\n$$\n将此代入 $\\phi_{\\mathrm{LR}}(r)$ 的表达式：\n$$\n\\phi_{\\mathrm{LR}}(r) = -\\frac{2 G m}{\\pi r} \\left(\\frac{\\pi}{2} \\mathrm{erf}\\left(\\frac{r}{2r_s}\\right)\\right) = -\\frac{G m}{r} \\mathrm{erf}\\left(\\frac{r}{2r_s}\\right)\n$$\n现在我们可以写出短程势 $\\phi_{\\mathrm{SR}}(r)$：\n$$\n\\phi_{\\mathrm{SR}}(r) = -\\frac{G m}{r} - \\left(-\\frac{G m}{r} \\mathrm{erf}\\left(\\frac{r}{2r_s}\\right)\\right) = -\\frac{G m}{r} \\left(1 - \\mathrm{erf}\\left(\\frac{r}{2r_s}\\right)\\right)\n$$\n使用给定的互补误差函数的定义 $\\mathrm{erfc}(x) = 1 - \\mathrm{erf}(x)$，我们得到短程势的最终表达式：\n$$\n\\phi_{\\mathrm{SR}}(r) = -\\frac{G m}{r} \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right)\n$$\n最后一步是通过对 $\\phi_{\\mathrm{SR}}(r)$ 关于 $r$ 求导来计算力的大小 $F_{\\mathrm{SR}}(r)$。\n$$\nF_{\\mathrm{SR}}(r) = \\frac{\\mathrm{d}}{\\mathrm{d}r}\\phi_{\\mathrm{SR}}(r) = \\frac{\\mathrm{d}}{\\mathrm{d}r}\\left[ -\\frac{G m}{r} \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) \\right]\n$$\n使用乘积法则求导，$(uv)' = u'v + uv'$：\n$$\nF_{\\mathrm{SR}}(r) = -G m \\left[ \\left(\\frac{\\mathrm{d}}{\\mathrm{d}r}\\frac{1}{r}\\right) \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) + \\frac{1}{r} \\left(\\frac{\\mathrm{d}}{\\mathrm{d}r}\\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right)\\right) \\right]\n$$\n$$\nF_{\\mathrm{SR}}(r) = -G m \\left[ -\\frac{1}{r^2} \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) + \\frac{1}{r} \\left(\\frac{\\mathrm{d}}{\\mathrm{d}r}\\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right)\\right) \\right]\n$$\n为了求 $\\mathrm{erfc}$ 的导数，我们使用它以误差函数积分形式的定义：$\\frac{\\mathrm{d}}{\\mathrm{d}x}\\mathrm{erf}(x) = \\frac{2}{\\sqrt{\\pi}}\\exp(-x^2)$。因此，$\\frac{\\mathrm{d}}{\\mathrm{d}x}\\mathrm{erfc}(x) = -\\frac{2}{\\sqrt{\\pi}}\\exp(-x^2)$。使用链式法则，其中自变量为 $u = r/(2r_s)$，其导数为 $\\mathrm{d}u/\\mathrm{d}r = 1/(2r_s)$：\n$$\n\\frac{\\mathrm{d}}{\\mathrm{d}r}\\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) = \\left( -\\frac{2}{\\sqrt{\\pi}}\\exp\\left(-\\left(\\frac{r}{2r_s}\\right)^2\\right) \\right) \\cdot \\frac{1}{2r_s} = -\\frac{1}{r_s\\sqrt{\\pi}}\\exp\\left(-\\frac{r^2}{4r_s^2}\\right)\n$$\n将此导数代回 $F_{\\mathrm{SR}}(r)$ 的表达式中：\n$$\nF_{\\mathrm{SR}}(r) = -G m \\left[ -\\frac{1}{r^2} \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) + \\frac{1}{r} \\left(-\\frac{1}{r_s\\sqrt{\\pi}}\\exp\\left(-\\frac{r^2}{4r_s^2}\\right)\\right) \\right]\n$$\n$$\nF_{\\mathrm{SR}}(r) = -G m \\left[ -\\frac{1}{r^2} \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) - \\frac{1}{r r_s\\sqrt{\\pi}}\\exp\\left(-\\frac{r^2}{4r_s^2}\\right) \\right]\n$$\n将前导因子 $-G m$ 分配进去，得到问题所定义的短程力大小的最终表达式：\n$$\nF_{\\mathrm{SR}}(r) = \\frac{G m}{r^2} \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) + \\frac{G m}{r r_s\\sqrt{\\pi}} \\exp\\left(-\\frac{r^2}{4r_s^2}\\right)\n$$\n这是一个用指定量表示的单个闭式解析表达式。", "answer": "$$\\boxed{\\frac{G m}{r^2} \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) + \\frac{G m}{r r_s\\sqrt{\\pi}} \\exp\\left(-\\frac{r^2}{4r_s^2}\\right)}$$", "id": "3475892"}, {"introduction": "在理解了力分解的原理之后，我们转向算法的实际实现。粒子网格（PM）部分虽然能高效计算长程力，但其依赖的网格结构会引入数值误差，其中一个主要问题就是力的各向异性。本练习旨在分析这种误差，即计算出的力的大小会因其相对于网格轴的方向而异，并指导你构建一个改进的格林函数以同时校正网格效应和质量分配带来的平滑效应 [@problem_id:3475881]。", "problem": "考虑一个用于数值宇宙学的混合树-粒子-网格（Tree–PM）引力求解器。长程力场由粒子-网格（PM）部分在间距为 $\\Delta x$ 的均匀立方网格上使用快速傅里叶变换（FFT）泊松求解器处理，而短程力场由树部分处理。在PM步骤中，通过网格中云（CIC）方案将密度场 $\\delta(\\boldsymbol{x})$ 分配到网格上，通过应用格林函数 $G(\\boldsymbol{k})$ 在傅里叶空间中计算引力势，并通过取谱梯度 $-\\mathrm{i} \\boldsymbol{k} \\Phi(\\boldsymbol{k})$ 并使用相同的CIC方案插值回粒子位置来获得力。假设一个周期性区域，并且密度是一个单一的平面波模式 $\\delta(\\boldsymbol{x}) = \\delta_{0} \\exp\\left(\\mathrm{i} \\boldsymbol{k} \\cdot \\boldsymbol{x}\\right)$，其 $|\\boldsymbol{k}| \\equiv k$ 远低于奈奎斯特波数，因此可以忽略混叠效应。\n\n标准的FFT PM求解器使用离散拉普拉斯格林函数\n$$\nG_{\\mathrm{std}}(\\boldsymbol{k}) = - \\frac{1}{\\hat{k}^{2}},\n\\quad\n\\hat{k}^{2} \\equiv \\frac{4}{\\Delta x^{2}} \\sum_{i=1}^{3} \\sin^{2}\\!\\left(\\frac{k_{i} \\Delta x}{2}\\right),\n$$\n并使用谱梯度 $-\\mathrm{i} \\boldsymbol{k} \\Phi(\\boldsymbol{k})$ 计算力。在本练习的第一部分，忽略CIC窗口和任何反卷积，因此只有 $G_{\\mathrm{std}}(\\boldsymbol{k})$ 控制方向响应。定义无量纲波数 $q \\equiv k \\Delta x$。对于两个大小相等（均为 $k$）的模式，一个与坐标轴对齐，$\\boldsymbol{k}_{\\mathrm{ax}} = (k, 0, 0)$，另一个与空间对角线对齐，$\\boldsymbol{k}_{\\mathrm{dg}} = \\left(k/\\sqrt{3}, k/\\sqrt{3}, k/\\sqrt{3}\\right)$，推导使用 $G_{\\mathrm{std}}(\\boldsymbol{k})$ 时PM力大小之比 $R(q) \\equiv \\left|\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}_{\\mathrm{ax}})\\right| / \\left|\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}_{\\mathrm{dg}})\\right|$ 的解析表达式。将所有比例常数（如 $4 \\pi G$、尺度因子和平均密度）视为符号，并注意它们在比率中会抵消。\n\n接下来，为了减少Tree-PM方法中PM力的各向异性，提出一个改进的傅里叶空间格林函数 $G_{\\mathrm{imp}}(\\boldsymbol{k})$，它使用连续的各向同性核 $-1/k^{2}$，并显式地对由质量分配和力插值两过程引入的网格中云窗口进行反卷积。一维的网格中云窗口是 $W_{\\mathrm{CIC}}(k_{i}) = \\left[\\mathrm{sinc}\\!\\left(\\frac{k_{i} \\Delta x}{2}\\right)\\right]^{2}$，其中 $\\mathrm{sinc}(x) \\equiv \\sin(x)/x$，三维窗口是各坐标分量的乘积。将 $G_{\\mathrm{imp}}(\\boldsymbol{k})$ 写成一个关于 $\\boldsymbol{k}$ 和 $\\Delta x$ 的闭合形式解析表达式。\n\n以双元素行矩阵 $\\left(R(q), G_{\\mathrm{imp}}(\\boldsymbol{k})\\right)$ 的形式提供你的最终答案，纯粹以解析形式表示，不进行数值代入。如果你选择定义任何特殊函数，请在推导过程中进行；最终答案必须只包含表达式本身。你不需要提供单位，也不需要四舍五入。", "solution": "该问题要求推导与混合Tree-PM引力求解器相关的两个量：首先，是使用标准粒子-网格（PM）求解器时，两个不同波矢的力的大小之比；其次，是一个修正了数值效应的改进格林函数。\n\n第一部分：力之比 $R(q)$ 的推导。\n\n引力场 $\\boldsymbol{F}(\\boldsymbol{x})$ 通过 $\\boldsymbol{F}(\\boldsymbol{x}) = - \\nabla \\Phi(\\boldsymbol{x})$ 与引力势 $\\Phi(\\boldsymbol{x})$ 相关联。在傅里葉空间中，此关系变为 $\\boldsymbol{F}(\\boldsymbol{k}) = - \\mathrm{i} \\boldsymbol{k} \\Phi(\\boldsymbol{k})$。引力势通过泊松方程 $\\nabla^2 \\Phi(\\boldsymbol{x}) = C \\delta(\\boldsymbol{x})$ 与密度对比场 $\\delta(\\boldsymbol{x})$ 相关，其中 $C$ 是一个包含 $4 \\pi G$及其他宇宙学参数的常数。在傅里葉空间中，此方程为 $-k^2 \\Phi(\\boldsymbol{k}) = C \\delta(\\boldsymbol{k})$，其中 $k = |\\boldsymbol{k}|$。因此，真实的连续空间格林函数为 $G_{\\mathrm{true}}(\\boldsymbol{k}) = -1/k^2$，且 $\\Phi(\\boldsymbol{k}) = C G_{\\mathrm{true}}(\\boldsymbol{k}) \\delta(\\boldsymbol{k})$。\n\n问题描述了一个PM求解器，其中给定密度模式 $\\delta(\\boldsymbol{k})$ 的势计算为 $\\Phi(\\boldsymbol{k}) = C G_{\\mathrm{std}}(\\boldsymbol{k}) \\delta(\\boldsymbol{k})$，使用的是离散格林函数\n$$\nG_{\\mathrm{std}}(\\boldsymbol{k}) = - \\frac{1}{\\hat{k}^{2}}, \\quad \\text{其中} \\quad \\hat{k}^{2} \\equiv \\frac{4}{\\Delta x^{2}} \\sum_{i=1}^{3} \\sin^{2}\\!\\left(\\frac{k_{i} \\Delta x}{2}\\right).\n$$\n对于这一部分，我们被要求忽略网格中云（CIC）窗口函数的影响。傅里葉空间中的力由 $\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}) = - \\mathrm{i} \\boldsymbol{k} \\Phi(\\boldsymbol{k})$ 给出。代入 $\\Phi(\\boldsymbol{k})$ 的表达式：\n$$\n\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}) = - \\mathrm{i} \\boldsymbol{k} \\left( C G_{\\mathrm{std}}(\\boldsymbol{k}) \\delta(\\boldsymbol{k}) \\right).\n$$\n此力矢量的大小为：\n$$\n|\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k})| = |-\\mathrm{i} \\boldsymbol{k}| |C G_{\\mathrm{std}}(\\boldsymbol{k}) \\delta(\\boldsymbol{k})|.\n$$\n由于 $\\delta(\\boldsymbol{k})$ 是模式 $\\boldsymbol{k}$ 的标量振幅，且 $C$ 是一个常数，我们可以将大小写成与以下成比例：\n$$\n|\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k})| \\propto |\\boldsymbol{k}| |G_{\\mathrm{std}}(\\boldsymbol{k})| = k \\left| - \\frac{1}{\\hat{k}^{2}} \\right| = \\frac{k}{\\hat{k}^{2}}.\n$$\n当我们计算比率 $R(q)$ 时，比例常数将会抵消。\n\n现在我们为两个指定的波矢计算此表达式的值。\n\n1.  对于轴对齐模式，$\\boldsymbol{k}_{\\mathrm{ax}} = (k, 0, 0)$:\n分量为 $k_1 = k$, $k_2 = 0$, $k_3 = 0$。离散波数的平方变为：\n$$\n\\hat{k}_{\\mathrm{ax}}^{2} = \\frac{4}{\\Delta x^{2}} \\left[ \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2}\\right) + \\sin^{2}\\!\\left(\\frac{0 \\cdot \\Delta x}{2}\\right) + \\sin^{2}\\!\\left(\\frac{0 \\cdot \\Delta x}{2}\\right) \\right] = \\frac{4}{\\Delta x^{2}} \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2}\\right).\n$$\n此模式的力的大小则与以下成比例：\n$$\n|\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}_{\\mathrm{ax}})| \\propto \\frac{k}{\\hat{k}_{\\mathrm{ax}}^{2}} = \\frac{k}{\\frac{4}{\\Delta x^{2}} \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2}\\right)} = \\frac{k \\Delta x^{2}}{4 \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2}\\right)}.\n$$\n\n2.  对于空间对角线模式，$\\boldsymbol{k}_{\\mathrm{dg}} = \\left(k/\\sqrt{3}, k/\\sqrt{3}, k/\\sqrt{3}\\right)$:\n分量为 $k_1 = k_2 = k_3 = k/\\sqrt{3}$。离散波数的平方为：\n$$\n\\hat{k}_{\\mathrm{dg}}^{2} = \\frac{4}{\\Delta x^{2}} \\sum_{i=1}^{3} \\sin^{2}\\!\\left(\\frac{(k/\\sqrt{3}) \\Delta x}{2}\\right) = \\frac{4}{\\Delta x^{2}} \\cdot 3 \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2\\sqrt{3}}\\right) = \\frac{12}{\\Delta x^{2}} \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2\\sqrt{3}}\\right).\n$$\n此模式的力的大小与以下成比例：\n$$\n|\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}_{\\mathrm{dg}})| \\propto \\frac{k}{\\hat{k}_{\\mathrm{dg}}^{2}} = \\frac{k}{\\frac{12}{\\Delta x^{2}} \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2\\sqrt{3}}\\right)} = \\frac{k \\Delta x^{2}}{12 \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2\\sqrt{3}}\\right)}.\n$$\n比率 $R(q)$ 定义为这两个力大小的比值：\n$$\nR(q) = \\frac{|\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}_{\\mathrm{ax}})|}{|\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}_{\\mathrm{dg}})|} = \\frac{\\frac{k \\Delta x^{2}}{4 \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2}\\right)}}{\\frac{k \\Delta x^{2}}{12 \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2\\sqrt{3}}\\right)}} = \\frac{12 \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2\\sqrt{3}}\\right)}{4 \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2}\\right)}.\n$$\n引入无量纲波数 $q \\equiv k \\Delta x$，我们得到比率的最终表达式：\n$$\nR(q) = 3 \\frac{\\sin^{2}\\!\\left(\\frac{q}{2\\sqrt{3}}\\right)}{\\sin^{2}\\!\\left(\\frac{q}{2}\\right)}.\n$$\n\n第二部分：改进格林函数 $G_{\\mathrm{imp}}(\\boldsymbol{k})$ 的推导。\n\n目标是构建一个格林函数 $G_{\\mathrm{imp}}(\\boldsymbol{k})$，使得数值计算出的力能紧密匹配真实的物理力。数值计算过程包括几个步骤，每一步都在傅里葉空间中引入一个修正。\n真实的力为 $\\boldsymbol{F}_{\\mathrm{true}}(\\boldsymbol{k}) = -\\mathrm{i}\\boldsymbol{k} \\Phi_{\\mathrm{true}}(\\boldsymbol{k}) = -\\mathrm{i}\\boldsymbol{k} (C G_{\\mathrm{true}}(\\boldsymbol{k}) \\delta_{\\mathrm{true}}(\\boldsymbol{k}))$。设 $G_{\\mathrm{true}}(\\boldsymbol{k}) = -1/k^2$ 并吸收常数 $C$，我们有 $\\boldsymbol{F}_{\\mathrm{true}}(\\boldsymbol{k}) \\propto \\frac{\\mathrm{i}\\boldsymbol{k}}{k^2}\\delta_{\\mathrm{true}}(\\boldsymbol{k})$。\n\n数值计算过程如下：\n1.  **质量分配**：将连续密度场分配到网格上。对于CIC方案，此实空间的卷积等效于在傅里葉空间中乘以一个窗口函数 $W(\\boldsymbol{k})$。网格密度为 $\\delta_{g}(\\boldsymbol{k}) = W(\\boldsymbol{k}) \\delta_{\\mathrm{true}}(\\boldsymbol{k})$。\n2.  **泊松求解**：使用格林函数计算网格上的势：$\\Phi_{g}(\\boldsymbol{k}) = G_{\\mathrm{imp}}(\\boldsymbol{k}) \\delta_{g}(\\boldsymbol{k})$。\n3.  **力计算**：通过取梯度计算网格上的力场。假设使用与第一部分相同的谱梯度，$\\boldsymbol{F}_{g}(\\boldsymbol{k}) = -\\mathrm{i}\\boldsymbol{k} \\Phi_{g}(\\boldsymbol{k})$。\n4.  **力插值**：将力从网格插值回粒子位置。此步骤等效于与CIC核的另一次卷积，或在傅里葉空间中乘以 $W(\\boldsymbol{k})$。最终的数值力为 $\\boldsymbol{F}_{\\mathrm{num}}(\\boldsymbol{k}) = W(\\boldsymbol{k}) \\boldsymbol{F}_{g}(\\boldsymbol{k})$。\n\n结合这些步骤，我们找到数值力的表达式：\n$$\n\\boldsymbol{F}_{\\mathrm{num}}(\\boldsymbol{k}) = W(\\boldsymbol{k}) \\left( -\\mathrm{i}\\boldsymbol{k} \\Phi_{g}(\\boldsymbol{k}) \\right) = W(\\boldsymbol{k}) \\left( -\\mathrm{i}\\boldsymbol{k} \\left( G_{\\mathrm{imp}}(\\boldsymbol{k}) \\delta_{g}(\\boldsymbol{k}) \\right) \\right) = W(\\boldsymbolk) \\left( -\\mathrm{i}\\boldsymbol{k} G_{\\mathrm{imp}}(\\boldsymbol{k}) W(\\boldsymbol{k}) \\delta_{\\mathrm{true}}(\\boldsymbol{k}) \\right)\n$$\n$$\n\\boldsymbol{F}_{\\mathrm{num}}(\\boldsymbol{k}) = -\\mathrm{i}\\boldsymbol{k} W(\\boldsymbol{k})^2 G_{\\mathrm{imp}}(\\boldsymbol{k}) \\delta_{\\mathrm{true}}(\\boldsymbol{k}).\n$$\n为了使数值力等于（或成比例于）真实力，我们设置 $\\boldsymbol{F}_{\\mathrm{num}}(\\boldsymbol{k}) \\propto \\boldsymbol{F}_{\\mathrm{true}}(\\boldsymbol{k})$：\n$$\n-\\mathrm{i}\\boldsymbol{k} W(\\boldsymbol{k})^2 G_{\\mathrm{imp}}(\\boldsymbol{k}) \\delta_{\\mathrm{true}}(\\boldsymbol{k}) \\propto \\frac{\\mathrm{i}\\boldsymbol{k}}{k^2} \\delta_{\\mathrm{true}}(\\boldsymbol{k}).\n$$\n这要求 $- W(\\boldsymbol{k})^2 G_{\\mathrm{imp}}(\\boldsymbol{k}) = 1/k^2$。解出改进的格林函数，我们得到：\n$$\nG_{\\mathrm{imp}}(\\boldsymbol{k}) = - \\frac{1}{k^2 W(\\boldsymbol{k})^2}.\n$$\n此表达式展示了双重需求：它“使用连续的各向同性核 $-1/k^2$”并通过除以 $W(\\boldsymbol{k})^2$ 来对窗口函数效应进行“反卷积”。\n\n问题指定一维CIC窗口函数为 $W_{\\mathrm{CIC}}(k_i) = \\left[\\mathrm{sinc}\\left(\\frac{k_i \\Delta x}{2}\\right)\\right]^2$。对于立方网格，三维窗口函数是一维窗口的乘积：\n$$\nW(\\boldsymbol{k}) = W_{\\mathrm{CIC}}(k_x) W_{\\mathrm{CIC}}(k_y) W_{\\mathrm{CIC}}(k_z) = \\prod_{i=1}^{3} \\left[\\mathrm{sinc}\\left(\\frac{k_i \\Delta x}{2}\\right)\\right]^2.\n$$\n需要反卷积的总窗口效应是 $W(\\boldsymbol{k})^2$：\n$$\nW(\\boldsymbol{k})^2 = \\left( \\prod_{i=1}^{3} \\left[\\mathrm{sinc}\\left(\\frac{k_i \\Delta x}{2}\\right)\\right]^2 \\right)^2 = \\prod_{i=1}^{3} \\left[\\mathrm{sinc}\\left(\\frac{k_i \\Delta x}{2}\\right)\\right]^4.\n$$\n将此代入 $G_{\\mathrm{imp}}(\\boldsymbol{k})$ 的表达式中，得到最终结果：\n$$\nG_{\\mathrm{imp}}(\\boldsymbol{k}) = - \\frac{1}{k^2 \\prod_{i=1}^{3} \\left[\\mathrm{sinc}\\left(\\frac{k_{i} \\Delta x}{2}\\right)\\right]^4}.\n$$\n此处，$k^2 = k_x^2 + k_y^2 + k_z^2$，函数 $\\mathrm{sinc}(x)$ 定义为 $\\sin(x)/x$。\n\n最终答案是包含 $R(q)$ 和 $G_{\\mathrm{imp}}(\\boldsymbol{k})$ 表达式的行矩阵。", "answer": "$$\n\\boxed{\\begin{pmatrix} 3 \\frac{\\sin^2\\left(\\frac{q}{2\\sqrt{3}}\\right)}{\\sin^2\\left(\\frac{q}{2}\\right)}  - \\frac{1}{k^2 \\prod_{i=1}^{3} \\left[\\mathrm{sinc}\\left(\\frac{k_{i} \\Delta x}{2}\\right)\\right]^4} \\end{pmatrix}}\n$$", "id": "3475881"}, {"introduction": "一个高效的Tree-PM混合代码要求树算法和PM算法的误差达到微妙的平衡，而不是盲目地追求单个组件的最高精度。本练习探讨了如何通过协调树算法的精度（由张角参数 $\\theta$ 控制）与PM计算的残余误差（由分裂尺度 $r_s$ 决定）来实现这一优化。这种误差匹配是实现计算效率和精度的关键，体现了混合算法调优的核心思想 [@problem_id:3475856]。", "problem": "考虑在数值宇宙学中，一种混合树-粒子网格（Tree-PM）方法将牛顿引力势分裂为一个在粒子网格（PM）上求解的长程分量和一个通过树算法计算的短程分量。长程/短程分裂是通过傅里叶空间中的一个高斯滤波器实现的，其特征分裂尺度为 $r_{s}$，使得对于一个点质量 $m$，其短程实空间势是牛顿势乘以互补误差函数 $\\operatorname{erfc}$，即在间距 $r$ 处的短程势分数为 $\\operatorname{erfc}\\!\\left(r/(2 r_{s})\\right)$。树算法采用标准的打开判据 $s/d \\le \\theta$，其中 $s$ 是源单元的大小， $d$ 是从目标点到单元质心的距离，$\\theta$ 是一个无量纲的打开参数。\n\n假设树势是通过在单极矩处截断多极展开来构建的，因此首个被忽略的项是四极矩。设四极矩对势误差的贡献尺度为 $E_{M_{2}}(d) \\sim G |M_{2}|/d^{3}$，其中 $G$ 是引力常数，$M_{2}$ 是单元四极矩振幅的标量度量（例如，应用于无迹四极张量的谱范数）。为了得到一个保守的、与几何无关的界，采用 $|M_{2}| \\le M s^{2}$，其中 $M$ 是单元的总质量。使用牛顿单极势的大小 $|\\Phi_{M}(d)| \\sim G M/d$ 作为相对势误差的归一化因子。\n\n通过将树在分裂尺度上的四极截断误差与势在 $r=r_{s}$ 处的PM残差振幅相匹配来定义目标相对误差 $\\epsilon_{\\rm target}$，即设 $\\epsilon_{\\rm target} = \\operatorname{erfc}\\!\\left(\\frac{1}{2}\\right)$。施加要求，即在打开阈值处的相对树截断误差不大于 $\\epsilon_{\\rm target}$。\n\n在这些假设和定义下，推导最优打开参数 $\\theta_{\\rm opt}$ 的解析表达式，并使用上述高斯分裂对其进行数值评估。将 $\\theta_{\\rm opt}$ 的最终答案表示为一个无量纲数。将您的答案四舍五入到 $4$ 位有效数字。", "solution": "首先验证问题，以确保其科学上合理、良定且客观。\n\n**步骤1：提取已知条件**\n- **方法**：混合树-粒子网格（Tree-PM）。\n- **势分裂**：长程（PM）和短程（树）。\n- **分裂尺度**：$r_{s}$。\n- **短程势分数**：在间距 $r$ 处为 $\\operatorname{erfc}(r/(2 r_{s}))$。\n- **树打开判据**：$s/d \\le \\theta$，其中 $s$ 是单元大小，$d$ 是到单元的距离，$\\theta$ 是打开参数。\n- **树近似**：仅使用单极矩，主要误差来自四极矩。\n- **四极误差尺度**：$E_{M_{2}}(d) \\sim G |M_{2}|/d^{3}$，其中 $M_2$ 是四极矩的度量。\n- **四极矩界**：$|M_{2}| \\le M s^{2}$，其中 $M$ 是单元质量。\n- **误差归一化**：$|\\Phi_{M}(d)| \\sim G M/d$。\n- **目标相对误差**：$\\epsilon_{\\rm target} = \\operatorname{erfc}(\\frac{1}{2})$。\n- **约束条件**：在打开阈值处的相对树截断误差必须不大于 $\\epsilon_{\\rm target}$。\n- **目标**：推导最优打开参数 $\\theta_{\\rm opt}$ 的表达式并进行数值计算，四舍五入到 $4$ 位有效数字。\n\n**步骤2：使用提取的已知条件进行验证**\n该问题具有科学依据。混合Tree-PM方法、使用以互补误差函数 $\\operatorname{erfc}$ 为特征的高斯分裂、Barnes-Hut打开判据（$s/d \\le \\theta$）以及引力势的多极展开，都是计算宇宙学和天体物理学中标准且成熟的概念。所提供的误差尺度和界（$E_{M_2} \\propto d^{-3}$，$|M_2| \\le Ms^2$）是用于此类算法性能和误差分析的标准近似。\n\n问题是良定的。它提供了所有必要的定义、尺度和约束，以推导出打开参数 $\\theta_{\\rm opt}$ 的唯一表达式。语言客观、精确，没有歧义。\n\n**步骤3：结论与行动**\n问题被判定为**有效**。将推导解答。\n\n推导过程如下。首先，我们构建相对树截断误差的公式。该误差主要由多极展开中被忽略的首项（即四极项）决定。该势误差的大小尺度为：\n$$E_{M_{2}}(d) \\sim \\frac{G |M_{2}|}{d^{3}}$$\n其中 $G$ 是引力常数，$|M_{2}|$ 是源单元的四极矩大小，$d$ 是到目标点的距离。\n\n该误差需要用单极势的大小进行归一化，其大小为：\n$$|\\Phi_{M}(d)| \\sim \\frac{G M}{d}$$\n其中 $M$ 是单元的总质量。\n\n相对树截断误差 $\\epsilon_{\\rm tree}$ 是这两个量的比值：\n$$\\epsilon_{\\rm tree}(d) = \\frac{E_{M_{2}}(d)}{|\\Phi_{M}(d)|} \\sim \\frac{G |M_{2}|/d^{3}}{G M/d} = \\frac{|M_{2}|}{M d^{2}}$$\n\n为了获得一个保守的界，我们使用所提供的与几何无关的四极矩上限：$|M_{2}| \\le M s^{2}$，其中 $s$ 是源单元的大小。将此代入相对误差的表达式中，得到：\n$$\\epsilon_{\\rm tree}(d) \\le \\frac{M s^{2}}{M d^{2}} = \\left(\\frac{s}{d}\\right)^{2}$$\n该表达式用比值 $s/d$ 来界定相对误差。\n\n树算法采用打开判据 $s/d \\le \\theta$。只要满足此条件，算法就将一个单元视为一个点质量（单极矩）。最宽松的情况，即代表打开单元的阈值条件，是当该比率达到其最大允许值 $s/d = \\theta$ 时。在这个打开阈值处，相对截断误差的上限是：\n$$\\epsilon_{\\rm tree, threshold} \\le \\theta^{2}$$\n\n问题要求将这个截断误差的先验估计与由长程/短程力分裂引入的、依赖于尺度的误差相匹配。目标相对误差 $\\epsilon_{\\rm target}$ 是通过在特征分裂尺度 $r=r_s$ 处评估PM残差（即短程势分数）来定义的。短程势分数由 $\\operatorname{erfc}(r/(2r_s))$ 给出。因此，\n$$\\epsilon_{\\rm target} = \\operatorname{erfc}\\left(\\frac{r_s}{2 r_s}\\right) = \\operatorname{erfc}\\left(\\frac{1}{2}\\right)$$\n\n最终的约束是在打开阈值处的相对树截断误差不应大于这个目标误差：$\\epsilon_{\\rm tree, threshold} \\le \\epsilon_{\\rm target}$。为了找到最优打开参数 $\\theta_{\\rm opt}$，我们通过将打开阈值处的最大可能树误差设置为等于目标误差来平衡误差。较小的 $\\theta$ 会导致计算成本更高（打开更多节点），但其精度会超出需要；而较大的 $\\theta$ 则会违反误差平衡原则。因此，最优选择是设置：\n$$\\theta_{\\rm opt}^2 = \\epsilon_{\\rm target}$$\n\n求解 $\\theta_{\\rm opt}$，我们得到：\n$$\\theta_{\\rm opt} = \\sqrt{\\epsilon_{\\rm target}}$$\n\n代入 $\\epsilon_{\\rm target}$ 的表达式：\n$$\\theta_{\\rm opt} = \\sqrt{\\operatorname{erfc}\\left(\\frac{1}{2}\\right)}$$\n\n现在，我们对这个表达式进行数值评估。互补误差函数定义为 $\\operatorname{erfc}(x) = 1 - \\operatorname{erf}(x)$，其中 $\\operatorname{erf}(x)$ 是误差函数。\n需要 $\\operatorname{erfc}(1/2)$ 的值。\n$$\\operatorname{erfc}(0.5) \\approx 0.479500122187$$\n取平方根即可得到最优打开参数的值：\n$$\\theta_{\\rm opt} = \\sqrt{0.479500122187} \\approx 0.69245947203$$\n\n问题要求将答案四舍五入到4位有效数字。\n前四位有效数字是 $6$、$9$、$2$、$4$。第五位是 $5$，因此我们将第四位数字向上取整。\n$$\\theta_{\\rm opt} \\approx 0.6925$$\n这是在给定假设下最优打开参数的最终数值。", "answer": "$$\\boxed{0.6925}$$", "id": "3475856"}]}