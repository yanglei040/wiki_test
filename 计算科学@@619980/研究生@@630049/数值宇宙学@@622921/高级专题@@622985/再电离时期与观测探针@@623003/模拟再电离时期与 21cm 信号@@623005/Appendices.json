{"hands_on_practices": [{"introduction": "在模拟再电离的大尺度结构之前，我们必须首先理解产生21厘米信号的微观物理过程。本练习聚焦于关键的自旋温度（$T_S$），并探讨其如何通过碰撞和莱曼阿尔法（Lyman-Alpha）光子与气体动力学温度耦合。通过这个练习，你将深入了解不同的天体物理环境如何转化为可观测的21厘米信号波动，特别是如何影响其功率谱（$P_{21}(k)$）[@problem_id:3488955]。", "problem": "我们要求您设计并实现一个最小化的、自洽的数值实验，以评估三维21厘米亮温度功率谱在再电离时期对不同自旋温度耦合方案的敏感性。该研究仅限于一个科学上合理、能分离出自旋温度耦合效应且可明确测试的玩具模型。\n\n基本原理和定义：\n- 21厘米差分亮温度被建模为 $T_{\\mathrm{b}}(\\mathbf{x}) \\approx 27\\,\\mathrm{mK}\\,x_{\\mathrm{HI}}(\\mathbf{x})\\left[1+\\delta(\\mathbf{x})\\right]\\left(1 - \\frac{T_{\\gamma}}{T_{\\mathrm{S}}(\\mathbf{x})}\\right)\\sqrt{\\frac{1+z}{10}}$，其中 $x_{\\mathrm{HI}}(\\mathbf{x})$ 是中性氢分数，$\\delta(\\mathbf{x})$ 是物质超密度，$T_{\\gamma}$ 是宇宙微波背景（CMB）温度，$T_{\\mathrm{S}}(\\mathbf{x})$ 是自旋温度，$z$ 是红移。\n- 自旋温度耦合由Wouthuysen-Field关系给出，$T_{\\mathrm{S}}^{-1} = \\dfrac{T_{\\gamma}^{-1} + x_{c}\\,T_{\\mathrm{K}}^{-1} + x_{\\alpha}\\,T_{\\alpha}^{-1}}{1 + x_{c} + x_{\\alpha}}$，其中 $x_{c}$ 是碰撞耦合系数，$x_{\\alpha}$ 是莱曼-阿尔法（Ly$\\alpha$）耦合系数，$T_{\\mathrm{K}}$ 是气体的动理学温度，$T_{\\alpha}$ 是Ly$\\alpha$色温度。假设 $T_{\\alpha} = T_{\\mathrm{K}}$。\n- 亮温度涨落的三维功率谱 $P_{21}(k)$ 由离散周期性盒子中使用的快速傅里叶变换（FFT）的傅里叶变换约定来定义，并在操作上通过将 $\\left|\\tilde{\\Delta}_{21}(\\mathbf{k})\\right|^{2}$ 分箱到球形 $k$ 壳层中并除以盒子体积来估计，其中 $\\Delta_{21}(\\mathbf{x}) \\equiv T_{\\mathrm{b}}(\\mathbf{x}) - \\langle T_{\\mathrm{b}}\\rangle$。\n\n物理和数值设置：\n- 域：一个共动边长为 $L = 200\\,\\mathrm{Mpc}\\,h^{-1}$ 的周期性立方体，在每个维度上均匀离散化为 $N = 32$ 个单元格。\n- 红移：$z = 10$，因此 $T_{\\gamma} = 2.725\\,(1+z)\\,\\mathrm{K}$。\n- 中性分数：选择一个空间均匀的值 $x_{\\mathrm{HI}}(\\mathbf{x}) = 1$ 以分离出自旋温度效应。\n- 动理学温度：选择一个空间均匀的值 $T_{\\mathrm{K}} = 5\\,\\mathrm{K}$ 并设置 $T_{\\alpha} = T_{\\mathrm{K}}$。\n- 当耦合“开启”时的耦合系数：$x_{c,\\mathrm{on}} = 0.1$ 和 $x_{\\alpha,\\mathrm{on}} = 2.0$。当耦合“关闭”时，将其设为零。\n- 超密度场：通过以下步骤构建一个统计上均匀且各向同性的高斯随机超密度场 $\\delta(\\mathbf{x})$：\n  1. 在实空间网格上采样一个零均值、单位方差的高斯白噪声场。\n  2. 变换到傅里叶空间，并应用一个球对称的传递函数 $T(k) = \\left(\\dfrac{k}{k_{0}}\\right)^{n/2}\\exp\\left[-\\dfrac{1}{2}\\left(\\dfrac{k}{k_{c}}\\right)^{2}\\right]$ 来塑造该场，其中 $n = -2.5$，$k_{0} = 0.1\\,h\\,\\mathrm{Mpc}^{-1}$，以及 $k_{c} = 0.8\\,h\\,\\mathrm{Mpc}^{-1}$，并将零模设置为零。然后逆变换回实空间，并减去任何残余均值以确保 $\\langle \\delta\\rangle = 0$。\n\n目标量：\n- 对于每种自旋温度耦合方案，通过以下步骤计算分箱的 $P_{21}(k)$：\n  1. 以毫开尔文为单位，使用上面的公式，其中 $x_{\\mathrm{HI}}=1$ 并采用所选的 $T_{\\mathrm{S}}$ 方案，构建 $T_{\\mathrm{b}}(\\mathbf{x})$。\n  2. 减去空间均值以获得 $\\Delta_{21}(\\mathbf{x})$。\n  3. 计算傅里叶变换，并将 $|\\tilde{\\Delta}_{21}(\\mathbf{k})|^{2}$ 分箱到宽度为 $\\Delta k$ 的 $k$ 空间球壳中，然后除以盒子体积 $L^{3}$，以获得单位为 $\\mathrm{mK}^{2}\\,(\\mathrm{Mpc}\\,h^{-1})^{3}$ 的 $P_{21}(k)$ 估计值。\n- 使用三个不相交的 $k$ 箱，中心位于 $k \\in \\{0.1,\\,0.3,\\,0.5\\}\\,h\\,\\mathrm{Mpc}^{-1}$，每个的半宽为 $\\Delta k/2 = 0.05\\,h\\,\\mathrm{Mpc}^{-1}$；即，分箱区间为 $[0.05,0.15)$, $[0.25,0.35)$, 和 $[0.45,0.55)$。\n\n自旋温度测试套件：\n- 通过“切换”$x_{c}$和$x_{\\alpha}$来评估四种耦合方案：\n  1. 情况 A（基线）：$x_{c} = x_{c,\\mathrm{on}}$，$x_{\\alpha} = x_{\\alpha,\\mathrm{on}}$。\n  2. 情况 B（仅碰撞）：$x_{c} = x_{c,\\mathrm{on}}$，$x_{\\alpha} = 0$。\n  3. 情况 C（仅 Ly$\\alpha$）：$x_{c} = 0$，$x_{\\alpha} = x_{\\alpha,\\mathrm{on}}$。\n  4. 情况 D（两者皆无）：$x_{c} = 0$，$x_{\\alpha} = 0$。\n\n要求输出：\n- 对于每种情况，计算分箱功率谱相对于基线的相对变化量 $\\Delta_{\\mathrm{frac}}(k) = \\dfrac{P_{21}^{\\mathrm{case}}(k) - P_{21}^{\\mathrm{A}}(k)}{P_{21}^{\\mathrm{A}}(k)}$，在上面定义的三个 $k$ 箱处进行评估。将这些相对变化量表示为无量纲的小数。\n- 您的程序必须使用随机种子 $42$ 以确保可复现性，实现上述所有步骤，并将结果生成为单行输出，格式为逗号分隔的列表之列表，按照 A, B, C, D 的情况顺序。例如，输出必须具有 [[a1,a2,a3],[b1,b2,b3],[c1,c2,c3],[d1,d2,d3]] 的形式，其中每个条目是对应于三个分箱中相对变化量的浮点数。因此，基线情况 A 应产生大约 [0,0,0] 的结果。\n\n不使用角度单位。计算中出现的所有物理单位必须一致：温度以开尔文为单位，$T_{\\mathrm{b}}$ 以毫开尔文为单位，波数以 $h\\,\\mathrm{Mpc}^{-1}$ 为单位，体积以 $(\\mathrm{Mpc}\\,h^{-1})^{3}$ 为单位，$P_{21}$ 以 $\\mathrm{mK}^{2}\\,(\\mathrm{Mpc}\\,h^{-1})^{3}$ 为单位。最终要求的相对变化量是无量纲的。程序必须是自包含的，不需要任何输入，并按上述指定格式准确打印一行。", "solution": "问题陈述提出了一个在物理宇宙学中定义明确且有科学依据的数值实验。它提供了一套清晰、自包含的指令和参数，用于构建再电离时期21厘米亮温度场的玩具模型。其目标是量化21厘米功率谱对控制氢自旋温度的不同物理耦合机制的敏感性。所有提供的定义、方程和数值都与该领域简化模型的标准文献和实践相一致。问题没有科学缺陷、矛盾或歧义，可以得到唯一且有意义的解。所指定的简化，例如均匀的中性分数和动理学温度，对于分离出自旋温度耦合效应这一既定目标是合适的。因此，该问题被认为是有效的。\n\n解决方案通过完全按照描述实现数值模拟来进行。核心步骤是：1) 设置计算域和物理常数；2) 生成具有指定统计特性的高斯随机超密度场 $\\delta(\\mathbf{x})$；3) 对于四种自旋温度耦合情况中的每一种，计算21厘米亮温度场 $T_{\\mathrm{b}}(\\mathbf{x})$；4) 对于每种情况，计算亮温度涨落的分箱功率谱 $P_{21}(k)$；以及 5) 计算每个分箱中功率谱相对于基线情况的相对变化量。\n\n首先，我们根据问题陈述定义物理和数值常数。\n模拟域是一个边长为 $L=200\\,\\mathrm{Mpc}\\,h^{-1}$ 的周期性立方体，位于一个 $N^3=32^3$ 单元格的网格上。\n红移为 $z=10$，得出宇宙微波背景（CMB）温度为 $T_{\\gamma} = 2.725(1+z) = 29.975\\,\\mathrm{K}$。\n给定均匀的中性氢分数 $x_{\\mathrm{HI}}=1$ 和均匀的气体动理学温度 $T_{\\mathrm{K}}=5\\,\\mathrm{K}$。莱曼-阿尔法（Ly$\\alpha$）色温度被设置为等于动理学温度，$T_{\\alpha}=T_{\\mathrm{K}}$。\n\n超密度场 $\\delta(\\mathbf{x})$ 在傅里叶空间中生成。构建一个波矢 $\\mathbf{k}$ 的网格，其分量由 $k_i = 2\\pi m_i/L$ 给出，其中整数 $m_i \\in [-N/2, N/2-1]$。我们在傅里叶空间中生成一个复高斯白噪声场 $\\tilde{w}(\\mathbf{k})$。这等同于在实空间生成白噪声然后进行变换。然后通过应用指定的传递函数 $T(k)$ 来塑造该场：\n$$\n\\tilde{\\delta}(\\mathbf{k}) = \\tilde{w}(\\mathbf{k}) T(k)\n$$\n其中 $k=|\\mathbf{k}|$ 且传递函数为\n$$\nT(k) = \\left(\\frac{k}{k_{0}}\\right)^{n/2}\\exp\\left[-\\frac{1}{2}\\left(\\frac{k}{k_{c}}\\right)^{2}\\right]\n$$\n参数为 $n=-2.5$，$k_0 = 0.1\\,h\\,\\mathrm{Mpc}^{-1}$，以及 $k_c = 0.8\\,h\\,\\mathrm{Mpc}^{-1}$。直流分量 $\\tilde{\\delta}(\\mathbf{k}=0)$ 被设为零。一次快速傅里叶逆变换（FFT）产生实空间场 $\\delta(\\mathbf{x})$。减去任何残余的数值均值以确保 $\\langle\\delta\\rangle=0$。这同一个密度场用于所有四种情况。\n\n对于每个测试情况（A, B, C, D），我们计算相应的空间均匀自旋温度 $T_{\\mathrm{S}}$。Wouthuysen-Field 关系式给出如下：\n$$\nT_{\\mathrm{S}}^{-1} = \\frac{T_{\\gamma}^{-1} + x_{c}\\,T_{\\mathrm{K}}^{-1} + x_{\\alpha}\\,T_{\\alpha}^{-1}}{1 + x_{c} + x_{\\alpha}}\n$$\n耦合系数 $(x_c, x_\\alpha)$ 根据情况设置：A $(x_{c,\\mathrm{on}}, x_{\\alpha,\\mathrm{on}})$，B $(x_{c,\\mathrm{on}}, 0)$，C $(0, x_{\\alpha,\\mathrm{on}})$，和 D $(0,0)$，其中 $x_{c,\\mathrm{on}}=0.1$ 和 $x_{\\alpha,\\mathrm{on}}=2.0$。\n\n然后计算每种情况下的亮温度场 $T_{\\mathrm{b}}(\\mathbf{x})$。由于 $x_{\\mathrm{HI}}$、$z$、$T_{\\gamma}$ 和 $T_{\\mathrm{S}}$（在给定情况下）都是空间均匀的，表达式简化为超密度的线性函数：\n$$\nT_{\\mathrm{b}}(\\mathbf{x}) = C \\cdot (1 + \\delta(\\mathbf{x}))\n$$\n其中常数 $C$ 由下式给出\n$$\nC = 27\\,\\mathrm{mK} \\cdot x_{\\mathrm{HI}} \\cdot \\left(1 - \\frac{T_{\\gamma}}{T_{\\mathrm{S}}}\\right) \\cdot \\sqrt{\\frac{1+z}{10}}\n$$\n涨落场为 $\\Delta_{21}(\\mathbf{x}) = T_{\\mathrm{b}}(\\mathbf{x}) - \\langle T_{\\mathrm{b}} \\rangle$。由于 $\\langle\\delta\\rangle=0$，我们有 $\\langle T_{\\mathrm{b}}\\rangle = C$，因此 $\\Delta_{21}(\\mathbf{x}) = C \\cdot \\delta(\\mathbf{x})$。\n\n功率谱 $P_{21}(k)$ 通过数值方法进行估计。我们计算离散傅里叶变换 $\\tilde{\\Delta}_{21}(\\mathbf{k}) = \\mathrm{FFT}[\\Delta_{21}(\\mathbf{x})]$。每个模式中的功率是 $|\\tilde{\\Delta}_{21}(\\mathbf{k})|^2$。然后，这些功率值在 $k$ 空间中的三个球壳内进行平均，这些球壳由区间 $[0.05, 0.15)$, $[0.25, 0.35)$, 和 $[0.45, 0.55)$ 定义，单位均为 $h\\,\\mathrm{Mpc}^{-1}$。问题要求的是相对变化量，即功率谱的比值。任何归一化常数（例如关联离散和连续傅里叶变换的体积因子）都会被抵消。因此，我们可以简单地对每个分箱内的原始 $|\\tilde{\\Delta}_{21}(\\mathbf{k})|^2$ 值进行平均，以获得一个与分箱功率谱成正比的量。\n\n最后，对于情况 B、C 和 D，计算每个 $k$ 箱相对于基线情况 A 的相对变化量：\n$$\n\\Delta_{\\mathrm{frac}}(k) = \\frac{P_{21}^{\\mathrm{case}}(k) - P_{21}^{\\mathrm{A}}(k)}{P_{21}^{\\mathrm{A}}(k)}\n$$\n由于 $\\Delta_{21}(\\mathbf{x}) \\propto \\delta(\\mathbf{x})$，功率谱 $P_{21}(k) \\propto P_{\\delta}(k)$，其中 $P_{\\delta}(k)$ 是超密度场的功率谱。具体来说，$P_{21}^{\\text{case}}(k) = C_{\\text{case}}^2 P_{\\delta}(k)$。因此，相对变化量简化为 $\\Delta_{\\mathrm{frac}} = (C_{\\text{case}}/C_{\\text{A}})^2 - 1$，这与波数 $k$ 无关。我们的数值模拟将明确展示模型简化的这一结果，即对于任何给定情况，在所有三个 $k$ 箱中产生的相对变化量值几乎相同。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the sensitivity of the 21cm power spectrum to spin temperature\n    coupling prescriptions in a toy model of the epoch of reionization.\n    \"\"\"\n    \n    # 1. Define constants and parameters\n    L = 200.0  # Box side length in Mpc/h\n    N = 32     # Grid size along each dimension\n    z = 10.0   # Redshift\n    x_HI = 1.0 # Uniform neutral hydrogen fraction\n    T_K = 5.0  # Uniform gas kinetic temperature in K\n    T_alpha = T_K # Ly-alpha color temperature in K\n    x_c_on = 0.1\n    x_alpha_on = 2.0\n    n = -2.5   # Power spectrum spectral index parameter\n    k0 = 0.1   # Power spectrum pivot scale in h/Mpc\n    kc = 0.8   # Power spectrum cutoff scale in h/Mpc\n    T_CMB_0 = 2.725 # CMB temperature at z=0 in K\n    seed = 42\n\n    T_gamma = T_CMB_0 * (1.0 + z)\n    \n    # Define the four test cases\n    cases = {\n        'A': (x_c_on, x_alpha_on),    # Baseline\n        'B': (x_c_on, 0.0),           # Collisions only\n        'C': (0.0, x_alpha_on),       # Ly-alpha only\n        'D': (0.0, 0.0)              # Neither\n    }\n    case_order = ['A', 'B', 'C', 'D']\n\n    # 2. Set up Fourier space grid\n    k_vec = 2 * np.pi * np.fft.fftfreq(N, d=L/N)\n    kx, ky, kz = np.meshgrid(k_vec, k_vec, k_vec, indexing='ij')\n    k_mag = np.sqrt(kx**2 + ky**2 + kz**2)\n\n    # 3. Generate the overdensity field delta(x)\n    np.random.seed(seed)\n    # Generate Gaussian white noise in real space and transform\n    white_noise = np.random.randn(N, N, N)\n    white_noise_k = np.fft.fftn(white_noise)\n    \n    # Define transfer function T(k)\n    T_k = np.zeros_like(k_mag, dtype=np.float64)\n    non_zero_k = k_mag > 0\n    k_mag_safe = k_mag[non_zero_k]\n    T_k[non_zero_k] = np.power(k_mag_safe / k0, n / 2.0) * np.exp(-0.5 * np.power(k_mag_safe / kc, 2))\n    \n    # Apply transfer function to shape the field\n    delta_k = white_noise_k * T_k\n    delta_k[0, 0, 0] = 0.0  # Set mean to zero\n\n    # Transform back to real space and ensure mean is zero\n    delta_r = np.real(np.fft.ifftn(delta_k))\n    delta_r -= np.mean(delta_r)\n\n    # 4. Define binning scheme and a function to compute binned power spectrum\n    k_bins = [\n        (0.05, 0.15),\n        (0.25, 0.35),\n        (0.45, 0.55)\n    ]\n\n    def get_binned_power_spectrum(delta_21_field):\n        \"\"\"Computes the binned power spectrum of a given field.\"\"\"\n        delta_21_k = np.fft.fftn(delta_21_field)\n        power_modes = np.abs(delta_21_k)**2\n        \n        binned_P = []\n        for k_min, k_max in k_bins:\n            mask = (k_mag >= k_min)  (k_mag  k_max)\n            modes_in_bin = np.sum(mask)\n            if modes_in_bin > 0:\n                # Average power of modes in the k-shell\n                p_k = np.mean(power_modes[mask])\n                binned_P.append(p_k)\n            else:\n                binned_P.append(0.0) # No modes in this bin\n        return np.array(binned_P)\n\n    # 5. Calculate power spectrum for each case\n    all_power_spectra = {}\n    prefactor_Tb = 27.0 * x_HI * np.sqrt((1.0 + z) / 10.0)\n\n    for name, (xc, xa) in cases.items():\n        # Calculate spin temperature T_S\n        denominator = 1.0 + xc + xa\n        if np.isclose(denominator, 0): # Should not happen for problem cases\n            T_S = T_gamma\n        else:\n            T_S_inv = (T_gamma**-1 + xc * T_K**-1 + xa * T_alpha**-1) / denominator\n            T_S = 1.0 / T_S_inv if T_S_inv > 0 else np.inf\n\n        # Calculate the scaling constant C for the brightness temperature\n        if np.isclose(T_S, T_gamma):\n            C = 0.0\n        else:\n            C = prefactor_Tb * (1.0 - T_gamma / T_S)\n        \n        # Fluctuation field is C * delta_r\n        delta_21 = C * delta_r\n\n        # Compute and store binned power spectrum\n        all_power_spectra[name] = get_binned_power_spectrum(delta_21)\n\n    # 6. Compute and format fractional changes\n    P_A_binned = all_power_spectra['A']\n    final_results = []\n\n    for name in case_order:\n        P_case_binned = all_power_spectra[name]\n        \n        # Calculate fractional change, handling potential division by zero\n        frac_change = np.zeros_like(P_A_binned)\n        valid_bins = P_A_binned > 1e-12 # Use a small threshold for float comparison\n        \n        frac_change[valid_bins] = (P_case_binned[valid_bins] - P_A_binned[valid_bins]) / P_A_binned[valid_bins]\n        \n        # Handle case where P_A(k) is zero but P_case(k) is not (very unlikely)\n        # In this specific problem, it indicates P_case(k) must also be zero\n        \n        final_results.append(list(frac_change))\n\n    # Print in the required format\n    print(str(final_results).replace(\" \", \"\"))\n\nsolve()\n```", "id": "3488955"}, {"introduction": "理解了信号的来源之后，下一步是模拟信号所追踪的中性氢组分（$x_{HI}$）的演化，这需要对来自第一代恒星和星系的电离光子进行建模。本练习将深入探讨数值宇宙学的基石：实现一种严格遵守光子守恒的有限体积辐射转移方案，以确保模拟的物理稳健性。这项技能对于构建或理解最先进的再电离模拟至关重要[@problem_id:3488852]。", "problem": "考虑在再电离时期（Epoch of Reionization, EoR）氢电离光子的数值输运。一个光子守恒的有限体积离散化方法应该在每个控制体积中推进光子数，使得全局光子预算精确地平衡源发射、边界通量和吸收。从笛卡尔控制体积上的光子数守恒定律的积分形式开始，该形式源于灰色（单频箱）近似下的辐射转移方程：单元内光子数的时间变化率等于通过各个面的净光子流入量加上单元内发射量减去吸收量。设光速为 $c$（单位为 $\\mathrm{m\\,s^{-1}}$），吸收系数为 $\\kappa$（单位为 $\\mathrm{m^{-1}}$），光子源率密度为 $S$（单位为 $\\mathrm{photons\\,m^{-3}\\,s^{-1}}$），光子数密度为 $n_{\\gamma}$（单位为 $\\mathrm{photons\\,m^{-3}}$）。汇率密度为 $c\\,\\kappa\\,n_{\\gamma}$（单位为 $\\mathrm{photons\\,m^{-3}\\,s^{-1}}$）。对于一个均匀的笛卡尔网格，其单元体积为 $V$，面面积为 $A$，定义每单元光子数 $N_i = \\int_{V_i} n_{\\gamma}\\,\\mathrm{d}V$（单位为 $\\mathrm{photons}$）和面光子率 $\\Phi_{i\\pm\\frac{1}{2}} = \\int_{A_{i\\pm\\frac{1}{2}}} \\boldsymbol{F}\\cdot\\mathrm{d}\\boldsymbol{A}$（单位为 $\\mathrm{photons\\,s^{-1}}$），其中 $\\boldsymbol{F}$ 是光子数通量密度（单位为 $\\mathrm{photons\\,m^{-2}\\,s^{-1}}$）。假设一个沿 $x$ 轴的一维网格，具有由 $i \\in \\{0,\\dots,N_x-1\\}$ 索引的均匀单元，以及位于 $i\\pm\\frac{1}{2}$ 的面；右侧面的外法线方向为 $+\\hat{x}$ 方向，因此正的 $\\Phi$ 表示光子向 $x$ 增加的方向输运。设单元 $i$ 内的体积积分源为 $S_i V$（单位为 $\\mathrm{photons\\,s^{-1}}$），记为 $Q_i$。\n\n你的任务：\n\n1) 推导一个离散的、光子守恒的、有限体积的更新法则，用于在一个时间步长 $\\Delta t$（单位为 $\\mathrm{s}$）内更新每单元的光子数。该更新法则在吸收汇项上应为完全隐式，以确保对刚性吸收的正定性和鲁棒性。更新法则必须用单元量 $N_i^n$ 和 $N_i^{n+1}$（单位为 $\\mathrm{photons}$）、面光子率 $\\Phi_{i\\pm\\frac{1}{2}}$（单位为 $\\mathrm{photons\\,s^{-1}}$）、单元积分源率 $Q_i$（单位为 $\\mathrm{photons\\,s^{-1}}$）、光速 $c$（单位为 $\\mathrm{m\\,s^{-1}}$）和吸收系数 $\\kappa_i$（单位为 $\\mathrm{m^{-1}}$）来表示。\n\n2) 实现所推导的更新法则，用于一维网格。在此网格中，几何信息已如上所述被吸收到 $N_i$ 和 $\\Phi_{i\\pm\\frac{1}{2}}$ 的定义中，因此在 $\\Delta t$ 内对 $N_i$ 的通量贡献为 $-\\Delta t\\,(\\Phi_{i+\\frac{1}{2}}-\\Phi_{i-\\frac{1}{2}})$（单位为 $\\mathrm{photons}$）。\n\n3) 对下面的每个测试用例，执行一个时间步长，并计算由下式定义的绝对全局守恒残差 $R$（单位为 $\\mathrm{photons}$）：\n$$\nR \\equiv \\left|\\left(\\sum_{i=0}^{N_x-1} N_i^{n+1}-\\sum_{i=0}^{N_x-1} N_i^{n}\\right) - \\left(-\\Delta t\\,\\big(\\Phi_{N_x-\\frac{1}{2}}-\\Phi_{-\\frac{1}{2}}\\big) + \\Delta t\\,\\sum_{i=0}^{N_x-1} Q_i - \\Delta t\\,\\sum_{i=0}^{N_x-1} c\\,\\kappa_i\\,N_i^{n+1}\\right)\\right| ,\n$$\n其中 $\\Phi_{-\\frac{1}{2}}$ 和 $\\Phi_{N_x-\\frac{1}{2}}$ 分别是左右边界面的光子率。一个光子守恒的格式应产生与舍入误差相当的 $R$。\n\n使用科学记数法表示残差 $R$ 的最终答案（单位为 $\\mathrm{photons}$），保留六位有效数字。\n\n测试套件（所有量均应以上述单位解释）：\n\n- 用例 A（正常路径）：$N_x = 4$，初始每单元光子数 $[N_0^n,N_1^n,N_2^n,N_3^n] = [10^6, 2\\times 10^6, 5\\times 10^5, 1.5\\times 10^6]$，面光子率 $[\\Phi_{-\\frac{1}{2}},\\Phi_{\\frac{1}{2}},\\Phi_{\\frac{3}{2}},\\Phi_{\\frac{5}{2}},\\Phi_{\\frac{7}{2}}] = [10^5, 5\\times 10^4, -2\\times 10^4, 0, -5\\times 10^4]$，单元积分源率 $[Q_0,Q_1,Q_2,Q_3] = [10^4, 0, 2\\times 10^4, 0]$，对所有 $i$ 均为均匀吸收系数 $\\kappa_i = 10^{-10}$，$\\Delta t = 10^{-1}$，$c = 2.99792458\\times 10^8$。\n\n- 用例 B（零通量边界，仅有源和吸收）：$N_x = 3$，初始 $[N_0^n,N_1^n,N_2^n] = [0,0,0]$，面 $[\\Phi_{-\\frac{1}{2}},\\Phi_{\\frac{1}{2}},\\Phi_{\\frac{3}{2}},\\Phi_{\\frac{5}{2}}] = [0,0,0,0]$，源 $[Q_0,Q_1,Q_2] = [10^5,10^5,10^5]$，对所有 $i$ 均为 $\\kappa_i = 10^{-9}$，$\\Delta t = 1$，$c = 2.99792458\\times 10^8$。\n\n- 用例 C（真空，检验严格守恒，带源和平衡的边界通量）：$N_x = 2$，初始 $[N_0^n,N_1^n] = [10^3, 2\\times 10^3]$，面 $[\\Phi_{-\\frac{1}{2}},\\Phi_{\\frac{1}{2}},\\Phi_{\\frac{3}{2}}] = [10^2,10^2,10^2]$，源 $[Q_0,Q_1] = [0,10^2]$，对所有 $i$ 均为 $\\kappa_i = 0$，$\\Delta t = 10$，$c = 2.99792458\\times 10^8$。\n\n- 用例 D（刚性吸收，隐式汇下的正定性）：$N_x = 1$，初始 $[N_0^n] = [10^9]$，面 $[\\Phi_{-\\frac{1}{2}},\\Phi_{\\frac{1}{2}}] = [0,0]$，源 $[Q_0] = [10^8]$，$\\kappa_0 = 1$，$\\Delta t = 10^{-9}$，$c = 2.99792458\\times 10^8$。\n\n- 用例 E（来自边界的净流入，无源，无吸收）：$N_x = 3$，初始 $[N_0^n,N_1^n,N_2^n] = [10^4,2\\times 10^4,3\\times 10^4]$，面 $[\\Phi_{-\\frac{1}{2}},\\Phi_{\\frac{1}{2}},\\Phi_{\\frac{3}{2}},\\Phi_{\\frac{5}{2}}] = [5\\times 10^3,0,0,-5\\times 10^3]$，源 $[Q_0,Q_1,Q_2] = [0,0,0]$，对所有 $i$ 均为 $\\kappa_i = 0$，$\\Delta t = 1$，$c = 2.99792458\\times 10^8$。\n\n你的程序应生成一行输出，其中包含一个用方括号括起来的逗号分隔的残差列表（例如，$[r_A,r_B,r_C,r_D,r_E]$），其中每个 $r$ 是对应案例的绝对残差 $R$，以科学记数法格式化，并保留六位有效数字。所有残差必须以 $\\mathrm{photons}$ 为单位报告。", "solution": "用户的要求是推导一个用于辐射转移的光子守恒有限体积更新法则，并将其应用于一系列测试用例，报告每个用例的全局守恒残差。\n\n该问题是有效的，因为它在科学上基于辐射转移原理，数学上是适定的，客观的，并提供了一套完整且一致的数据和定义。这项任务是守恒律数值方法中的一个标准练习。我现在将进行推导和实现。\n\n**1. 有限体积更新法则的推导**\n\n基本原理是控制体积 $V_i$ 内光子数的守恒。$V_i$ 中光子数的时间变化率等于进入该体积的净光子率加上内部发射率，减去内部吸收率。这由输运方程的积分形式表示：\n$$\n\\frac{\\mathrm{d}}{\\mathrm{d}t} \\int_{V_i} n_{\\gamma}\\,\\mathrm{d}V = -\\oint_{\\partial V_i} \\boldsymbol{F}\\cdot\\mathrm{d}\\boldsymbol{A} + \\int_{V_i} S\\,\\mathrm{d}V - \\int_{V_i} c\\,\\kappa\\,n_{\\gamma}\\,\\mathrm{d}V\n$$\n这里，$n_{\\gamma}$ 是光子数密度，$\\boldsymbol{F}$ 是光子数通量密度，$S$ 是源率密度，$c$ 是光速，$\\kappa$ 是吸收系数。\n\n我们将此方程转换为问题中的离散量：\n- 单元 $i$ 中的每单元光子数为 $N_i(t) = \\int_{V_i} n_{\\gamma}\\,\\mathrm{d}V$。\n- 单元积分源率为 $Q_i = \\int_{V_i} S\\,\\mathrm{d}V$。\n- 假设吸收系数 $\\kappa_i$ 在单元内是常数，体积积分吸收率为 $\\int_{V_i} c\\,\\kappa\\,n_{\\gamma}\\,\\mathrm{d}V = c\\,\\kappa_i \\int_{V_i} n_{\\gamma}\\,\\mathrm{d}V = c\\,\\kappa_i N_i(t)$。\n- 在一维情况下，面积分 $\\oint_{\\partial V_i} \\boldsymbol{F}\\cdot\\mathrm{d}\\boldsymbol{A}$ 表示离开单元的净通量。问题将面光子率 $\\Phi_{i \\pm \\frac{1}{2}}$ 定义为在 $+\\hat{x}$ 方向上穿过面的光子率。离开单元 $i$ 的净通量是右侧面（$i+\\frac{1}{2}$）的流出率减去左侧面（$i-\\frac{1}{2}$）的流入率。这对应于 $\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}$。\n\n将这些离散量代入守恒定律，得到 $N_i$ 的半离散常微分方程：\n$$\n\\frac{\\mathrm{d}N_i}{\\mathrm{d}t} = -(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}) + Q_i - c\\,\\kappa_i N_i\n$$\n为了在时间步长 $\\Delta t$ 上从 $t^n$ 到 $t^{n+1}$ 进行时间离散化，我们将导数近似为 $\\frac{N_i^{n+1} - N_i^n}{\\Delta t}$。问题要求吸收汇项要被隐式处理，这意味着它在新时间层 $t^{n+1}$ 进行评估。源项和通量项在时间步长内被视为常数。这种混合显式-隐式（IMEX）格式写为：\n$$\n\\frac{N_i^{n+1} - N_i^n}{\\Delta t} = -(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}) + Q_i - c\\,\\kappa_i N_i^{n+1}\n$$\n为了找到更新法则，我们求解 $N_i^{n+1}$。首先，乘以 $\\Delta t$：\n$$\nN_i^{n+1} - N_i^n = \\Delta t \\left[ -(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}) + Q_i \\right] - \\Delta t\\,c\\,\\kappa_i N_i^{n+1}\n$$\n接下来，将所有包含 $N_i^{n+1}$ 的项移到左边：\n$$\nN_i^{n+1} + \\Delta t\\,c\\,\\kappa_i N_i^{n+1} = N_i^n - \\Delta t(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}) + \\Delta t\\,Q_i\n$$\n提取公因式 $N_i^{n+1}$：\n$$\nN_i^{n+1}(1 + c\\,\\kappa_i\\,\\Delta t) = N_i^n + \\Delta t\\,Q_i - \\Delta t(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}})\n$$\n最后，除以括号中的项，得到 $N_i^{n+1}$ 的显式更新法则：\n$$\nN_i^{n+1} = \\frac{N_i^n + \\Delta t\\,Q_i - \\Delta t\\,(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}})}{1 + c\\,\\kappa_i\\,\\Delta t}\n$$\n对每个单元 $i=0, \\dots, N_x-1$ 应用此方程来计算 $t^{n+1}$ 时刻的状态。对汇项的这种隐式处理保证了对于非负输入，$N_i^{n+1}$ 的正定性。\n\n**2. 全局守恒与残差 R**\n\n问题定义了绝对全局守恒残差 $R$ 以验证该格式。通过对我们所有单元的更新法则求和，我们可以证明该格式在构造上是完全守恒的。在求解 $N_i^{n+1}$ 之前，重新排列我们的时间离散方程：\n$$\n(N_i^{n+1} - N_i^n) - \\left[ -\\Delta t(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}) + \\Delta t\\,Q_i - \\Delta t\\,c\\,\\kappa_i N_i^{n+1} \\right] = 0\n$$\n对所有单元 $i=0, \\dots, N_x-1$ 求和：\n$$\n\\sum_{i=0}^{N_x-1}(N_i^{n+1} - N_i^n) - \\left[ -\\Delta t \\sum_{i=0}^{N_x-1}(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}) + \\Delta t \\sum_{i=0}^{N_x-1} Q_i - \\Delta t \\sum_{i=0}^{N_x-1} c\\,\\kappa_i N_i^{n+1} \\right] = 0\n$$\n通量上的求和构成一个伸缩级数：\n$$\n\\sum_{i=0}^{N_x-1}(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}) = (\\Phi_{\\frac{1}{2}} - \\Phi_{-\\frac{1}{2}}) + (\\Phi_{\\frac{3}{2}} - \\Phi_{\\frac{1}{2}}) + \\dots + (\\Phi_{N_x-\\frac{1}{2}} - \\Phi_{N_x-\\frac{3}{2}}) = \\Phi_{N_x-\\frac{1}{2}} - \\Phi_{-\\frac{1}{2}}\n$$\n将此代回，得到全局守恒方程：\n$$\n\\left(\\sum_{i=0}^{N_x-1}N_i^{n+1} - \\sum_{i=0}^{N_x-1}N_i^{n}\\right) - \\left[ -\\Delta t (\\Phi_{N_x-\\frac{1}{2}} - \\Phi_{-\\frac{1}{2}}) + \\Delta t \\sum_{i=0}^{N_x-1} Q_i - \\Delta t \\sum_{i=0}^{N_x-1} c\\,\\kappa_i N_i^{n+1} \\right] = 0\n$$\n残差 $R$ 的绝对值内的表达式正是这个方程。因此，如果更新法则被正确实现，$R$ 将在浮点舍入误差范围内为零。下面的实现根据推导出的公式计算所有单元的 $N_i^{n+1}$，然后评估 $R$ 来验证此属性。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Derives and implements a photon-conserving finite-volume update rule for \n    radiative transfer, calculates the global conservation residual for a suite \n    of test cases, and prints the results in the specified format.\n    \"\"\"\n    \n    # Define the speed of light, c, in m/s\n    c = 2.99792458e8\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case A: Happy path\n        {'Nx': 4, 'Nn': np.array([1e6, 2e6, 5e5, 1.5e6], dtype=np.float64),\n         'Phi': np.array([1e5, 5e4, -2e4, 0, -5e4], dtype=np.float64),\n         'Q': np.array([1e4, 0, 2e4, 0], dtype=np.float64),\n         'kappa': np.full(4, 1e-10, dtype=np.float64), 'dt': 1e-1},\n        \n        # Case B: Zero-flux boundaries, sources and absorption only\n        {'Nx': 3, 'Nn': np.array([0., 0., 0.], dtype=np.float64),\n         'Phi': np.array([0., 0., 0., 0.], dtype=np.float64),\n         'Q': np.array([1e5, 1e5, 1e5], dtype=np.float64),\n         'kappa': np.full(3, 1e-9, dtype=np.float64), 'dt': 1.0},\n        \n        # Case C: Vacuum, check strict conservation with sources and balanced boundary fluxes\n        {'Nx': 2, 'Nn': np.array([1e3, 2e3], dtype=np.float64),\n         'Phi': np.array([100., 100., 100.], dtype=np.float64),\n         'Q': np.array([0., 100.], dtype=np.float64),\n         'kappa': np.full(2, 0.0, dtype=np.float64), 'dt': 10.0},\n        \n        # Case D: Stiff absorption, positivity under implicit sink\n        {'Nx': 1, 'Nn': np.array([1e9], dtype=np.float64),\n         'Phi': np.array([0., 0.], dtype=np.float64),\n         'Q': np.array([1e8], dtype=np.float64),\n         'kappa': np.array([1.0], dtype=np.float64), 'dt': 1e-9},\n        \n        # Case E: Net inflow from boundaries, no sources, no absorption\n        {'Nx': 3, 'Nn': np.array([1e4, 2e4, 3e4], dtype=np.float64),\n         'Phi': np.array([5e3, 0., 0., -5e3], dtype=np.float64),\n         'Q': np.array([0., 0., 0.], dtype=np.float64),\n         'kappa': np.full(3, 0.0, dtype=np.float64), 'dt': 1.0}\n    ]\n\n    residuals = []\n    for case in test_cases:\n        # Unpack parameters for the current test case\n        Nx = case['Nx']\n        Nn = case['Nn']\n        Phi = case['Phi']\n        Q = case['Q']\n        kappa = case['kappa']\n        dt = case['dt']\n\n        # Array to store the new photon counts\n        Nn_plus_1 = np.zeros(Nx, dtype=np.float64)\n\n        # Apply the update rule for each cell\n        for i in range(Nx):\n            # Flux divergence for cell i\n            flux_diff = Phi[i+1] - Phi[i]\n            \n            # Numerator of the update rule\n            numerator = Nn[i] + dt * Q[i] - dt * flux_diff\n            \n            # Denominator of the update rule (implicit sink term)\n            denominator = 1.0 + c * kappa[i] * dt\n            \n            Nn_plus_1[i] = numerator / denominator\n\n        # Calculate the absolute global conservation residual R\n        \n        # Total change in photon number in the domain\n        total_change_N = np.sum(Nn_plus_1) - np.sum(Nn)\n        \n        # Total contribution from boundary fluxes\n        # The term phi_Nx-1/2 corresponds to Phi[Nx] and phi_-1/2 to Phi[0]\n        boundary_flux_term = -dt * (Phi[Nx] - Phi[0])\n        \n        # Total contribution from internal sources\n        source_term = dt * np.sum(Q)\n        \n        # Total contribution from absorption sinks (using new state Nn+1)\n        sink_term = -dt * c * np.sum(kappa * Nn_plus_1)\n        \n        # Sum of all photon changes due to fluxes, sources, and sinks\n        total_contributions = boundary_flux_term + source_term + sink_term\n        \n        # The residual is the absolute difference, which should be near zero\n        residual = abs(total_change_N - total_contributions)\n        residuals.append(residual)\n\n    # Format the final results as specified: scientific notation with six significant figures\n    # The format specifier '.5e' gives one digit before the decimal and five after.\n    formatted_results = [f\"{r:.5e}\" for r in residuals]\n    \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "3488852"}, {"introduction": "原始的“真实空间”模拟并非望远镜的直接观测量，观测是在“红移空间”中进行的，其中气体的本动速度会扭曲推断出的天体位置。本练习旨在解决一个前沿问题：线性红移空间畸变（RSD）模型在再电离时期典型的尖锐电离前沿附近的失效。你将校准一个更精确的非线性RSD模型，这是做出精确、可检验的预测以及正确解释观测数据的关键一步[@problem_id:3488873]。", "problem": "考虑再电离时期红移氢 $21\\,\\text{cm}$ 信号的高自旋温度极限，此时亮温度对比度在实空间中遵循 $\\delta T_{b} \\propto x_{\\mathrm{HI}} (1 + \\delta)$ 的正比关系，其中 $x_{\\mathrm{HI}}$ 是中性氢分数，$\\delta$ 是物质过密度。在红移空间中，沿视线方向的映射 $s = r + v_{\\parallel}/(aH)$ 意味着存在一个雅可比因子 $\\mathrm{d}s/\\mathrm{d}r = 1 + (1/(aH))\\,\\partial v_{\\parallel}/\\partial r$，它通过质量守恒来调制亮温度。定义无量纲速度梯度参数 $\\eta \\equiv (1+z)H^{-1}\\,\\partial v_{\\parallel}/\\partial r_{\\parallel}$，因此在通常的物质落入符号约定下，用 $\\eta$ 表示的精确雅可比因子为 $J_{\\mathrm{exact}}(\\eta) = 1/(1 - \\eta)$。对于较小的 $|\\eta|$，线性红移空间畸变近似将其展开为 $J_{\\mathrm{lin}}(\\eta) \\approx 1 + \\eta$。\n\n在电离泡附近，尖锐的电离前沿和非线性流会产生较大的 $|\\eta|$，此时线性近似失效，且当 $\\eta \\to 1$ 时，$J_{\\mathrm{exact}}(\\eta)$ 会变得奇异。为了解决这个问题，我们采用一种有物理动机的正则化方法，通过用以下截断形式替换 $J_{\\mathrm{exact}}(\\eta)$ 来近似小尺度速度弥散和有限厚度效应：\n$$\nJ_{\\mathrm{clip}}(\\eta;\\epsilon) \\equiv \\frac{1}{\\max(1 - \\eta, \\epsilon)} \\, ,\n$$\n其中 $\\epsilon$ 是一个小的正常数，用于防止发散并模拟未分辨的弥散平滑效应。使用 $\\epsilon = 0.05$。\n\n你的任务是分析速度梯度项中的非线性如何调制电离泡附近的 $\\delta T_{b}$，并提出一种超线性修正。具体来说，考虑单参数有理函数族\n$$\nJ_{\\mathrm{corr}}(\\eta;\\beta) \\equiv \\frac{1}{1 - \\eta + \\beta \\eta^{2}} \\, ,\n$$\n该函数族被构建为在 $\\eta \\to 0$ 时能再现正确的线性行为，同时允许通过 $\\beta \\ge 0$ 进行受控的非线性正则化。你必须通过在电离前沿周围的薄壳层上最小化 $J_{\\mathrm{corr}}$ 和 $J_{\\mathrm{clip}}$ 之间由中性氢分数和密度加权的平方误差来校准 $\\beta$。\n\n将电离前沿建模为位于半径 $R_{\\mathrm{b}}$ 处的球对称、平滑的阶跃，并用以下关于半径 $r$ 的一维函数来近似泡边缘附近的视线剖面：\n- 中性氢分数：\n$$\nx_{\\mathrm{HI}}(r) = \\frac{1}{2}\\left[1 + \\tanh\\left(\\frac{r - R_{\\mathrm{b}}}{w}\\right)\\right] \\, .\n$$\n- 过密度：\n$$\n\\delta(r) = \\delta_{0} \\exp\\left(-\\frac{(r - R_{\\mathrm{b}})^{2}}{2\\sigma^{2}}\\right) \\, .\n$$\n- 无量纲速度梯度：\n$$\n\\eta(r) = \\eta_{0}\\,\\mathrm{sech}^{2}\\!\\left(\\frac{r - R_{\\mathrm{b}}}{w}\\right) \\, .\n$$\n\n为明确起见，假设亮度归一化值为 $T_{0} = 27\\,\\text{mK}$，并取高自旋温度极限，以便对于当前的玩具模型可以忽略归一化值中的红移依赖性。对于每组参数，在区间 $[R_{\\mathrm{b}} - 3w,\\, R_{\\mathrm{b}} + 3w]$ 上使用 $N = 4001$ 个点的均匀网格来评估 $r$。定义亮温度的三种模型预测（单位为毫开尔文 (mK)）：\n$$\n\\delta T_{b}^{\\mathrm{lin}}(r) = T_{0}\\,x_{\\mathrm{HI}}(r)\\,[1 + \\delta(r)]\\,[1 + \\eta(r)] \\, ,\n$$\n$$\n\\delta T_{b}^{\\mathrm{clip}}(r) = T_{0}\\,x_{\\mathrm{HI}}(r)\\,[1 + \\delta(r)]\\,J_{\\mathrm{clip}}(\\eta(r);\\epsilon) \\, ,\n$$\n$$\n\\delta T_{b}^{\\mathrm{corr}}(r;\\beta) = T_{0}\\,x_{\\mathrm{HI}}(r)\\,[1 + \\delta(r)]\\,J_{\\mathrm{corr}}(\\eta(r);\\beta) \\, .\n$$\n\n通过最小化相对于 $\\delta T_{b}^{\\mathrm{clip}}(r)$ 的中性氢分数和密度加权的归一化均方根误差来校准 $\\beta$：\n$$\n\\mathrm{NRMSE}(\\beta) \\equiv \\sqrt{\\frac{\\int_{r_{-}}^{r_{+}}\\left[\\delta T_{b}^{\\mathrm{corr}}(r;\\beta) - \\delta T_{b}^{\\mathrm{clip}}(r)\\right]^{2}\\,\\mathrm{d}r}{\\int_{r_{-}}^{r_{+}}\\left[\\delta T_{b}^{\\mathrm{clip}}(r)\\right]^{2}\\,\\mathrm{d}r}} \\, ,\n$$\n其中 $r_{-} = R_{\\mathrm{b}} - 3w$ 且 $r_{+} = R_{\\mathrm{b}} + 3w$。同时报告线性近似的相应误差：\n$$\n\\mathrm{NRMSE}_{\\mathrm{lin}} \\equiv \\sqrt{\\frac{\\int_{r_{-}}^{r_{+}}\\left[\\delta T_{b}^{\\mathrm{lin}}(r) - \\delta T_{b}^{\\mathrm{clip}}(r)\\right]^{2}\\,\\mathrm{d}r}{\\int_{r_{-}}^{r_{+}}\\left[\\delta T_{b}^{\\mathrm{clip}}(r)\\right]^{2}\\,\\mathrm{d}r}} \\, .\n$$\n\n实现一个程序，对于下面的每组参数，通过在有界区间 $\\beta \\in [0, 2]$ 上最小化 $\\mathrm{NRMSE}(\\beta)$ 来执行校准，并为每个测试用例返回三个量：线性误差 $\\mathrm{NRMSE}_{\\mathrm{lin}}$、最优 $\\beta^{\\star}$ 和修正后误差 $\\mathrm{NRMSE}(\\beta^{\\star})$。在指定的网格上使用复合梯形法则进行数值积分，并在一个足够精细的 $\\beta$ 网格上进行一维搜索来近似最小化器。\n\n使用以下参数值测试套件，它们分别探测中度非线性情况、近发散流入情况、流出情况和尖锐前沿情况：\n- 情况 1：$R_{\\mathrm{b}} = 5.0$（共动百万秒差距），$w = 0.5$（共动百万秒差距），$\\eta_{0} = 0.4$，$\\delta_{0} = 0.3$，$\\sigma = 0.6$（共动百万秒差距）。\n- 情况 2：$R_{\\mathrm{b}} = 10.0$（共动百万秒差距），$w = 0.4$（共动百万秒差距），$\\eta_{0} = 0.95$，$\\delta_{0} = 0.2$，$\\sigma = 0.5$（共动百万秒差距）。\n- 情况 3：$R_{\\mathrm{b}} = 8.0$（共动百万秒差距），$w = 0.7$（共动百万秒差距），$\\eta_{0} = -0.6$，$\\delta_{0} = 0.25$，$\\sigma = 0.8$（共动百万秒差距）。\n- 情况 4：$R_{\\mathrm{b}} = 12.0$（共动百万秒差距），$w = 0.2$（共动百万秒差距），$\\eta_{0} = 0.8$，$\\delta_{0} = 0.15$，$\\sigma = 0.3$（共动百万秒差距）。\n\n物理和数值单位要求：\n- 中间亮温度 $\\delta T_{b}$ 的单位是毫开尔文。误差 $\\mathrm{NRMSE}$ 和参数 $\\beta$ 是无量纲的。没有角度。不报告百分比。\n\n最终输出格式：\n- 你的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果。该列表必须按顺序包含案例 1 到 4 的三元组 $\\left[\\mathrm{NRMSE}_{\\mathrm{lin}}, \\beta^{\\star}, \\mathrm{NRMSE}(\\beta^{\\star})\\right]$，并按案例分组，展平为单个列表。例如，输出应类似于 $[\\text{c1\\_lin},\\text{c1\\_beta},\\text{c1\\_corr},\\text{c2\\_lin},\\text{c2\\_beta},\\text{c2\\_corr},\\ldots]$，其中每个条目都是一个浮点数。", "solution": "用户提供的问题经评估有效。\n\n### 步骤 1：提取给定条件\n- **物理正比关系**：$21\\,\\text{cm}$ 亮温度对比度 $\\delta T_{b}$ 与 $x_{\\mathrm{HI}} (1 + \\delta)$ 成正比，其中 $x_{\\mathrm{HI}}$ 是中性氢分数，$\\delta$ 是物质过密度。\n- **红移空间雅可比因子**：视线方向的速度梯度通过一个雅可比因子来调制信号。无量纲速度梯度为 $\\eta \\equiv (1+z)H^{-1}\\,\\partial v_{\\parallel}/\\partial r_{\\parallel}$。\n- **雅可比因子模型**：\n    - 线性近似：$J_{\\mathrm{lin}}(\\eta) \\approx 1 + \\eta$。\n    - 截断的“真值”模型：$J_{\\mathrm{clip}}(\\eta;\\epsilon) \\equiv \\frac{1}{\\max(1 - \\eta, \\epsilon)}$，其中 $\\epsilon = 0.05$。此模型对精确雅可比因子 $J_{\\mathrm{exact}}(\\eta) = 1/(1 - \\eta)$ 的奇点进行正则化。\n    - 修正模型：$J_{\\mathrm{corr}}(\\eta;\\beta) \\equiv \\frac{1}{1 - \\eta + \\beta \\eta^{2}}$，其中 $\\beta \\ge 0$ 是一个校准参数。\n- **一维径向剖面**：\n    - 中性氢分数：$x_{\\mathrm{HI}}(r) = \\frac{1}{2}\\left[1 + \\tanh\\left(\\frac{r - R_{\\mathrm{b}}}{w}\\right)\\right]$。\n    - 过密度：$\\delta(r) = \\delta_{0} \\exp\\left(-\\frac{(r - R_{\\mathrm{b}})^{2}}{2\\sigma^{2}}\\right)$。\n    - 速度梯度：$\\eta(r) = \\eta_{0}\\,\\mathrm{sech}^{2}\\!\\left(\\frac{r - R_{\\mathrm{b}}}{w}\\right)$。\n- **亮温度模型**：\n    - 线性：$\\delta T_{b}^{\\mathrm{lin}}(r) = T_{0}\\,x_{\\mathrm{HI}}(r)\\,[1 + \\delta(r)]\\,[1 + \\eta(r)]$。\n    - 截断：$\\delta T_{b}^{\\mathrm{clip}}(r) = T_{0}\\,x_{\\mathrm{HI}}(r)\\,[1 + \\delta(r)]\\,J_{\\mathrm{clip}}(\\eta(r);\\epsilon)$。\n    - 修正：$\\delta T_{b}^{\\mathrm{corr}}(r;\\beta) = T_{0}\\,x_{\\mathrm{HI}}(r)\\,[1 + \\delta(r)]\\,J_{\\mathrm{corr}}(\\eta(r);\\beta)$。\n- **常数和数值参数**：\n    - 亮度归一化：$T_{0} = 27\\,\\text{mK}$。\n    - 截断参数：$\\epsilon = 0.05$。\n    - 空间网格：在 $[R_{\\mathrm{b}} - 3w, R_{\\mathrm{b}} + 3w]$ 上均匀分布的 $N = 4001$ 个点。\n    - $\\beta$ 的校准范围：$[0, 2]$。\n- **误差度量**：\n    - 修正模型误差：$\\mathrm{NRMSE}(\\beta) \\equiv \\sqrt{\\frac{\\int_{r_{-}}^{r_{+}}\\left[\\delta T_{b}^{\\mathrm{corr}}(r;\\beta) - \\delta T_{b}^{\\mathrm{clip}}(r)\\right]^{2}\\,\\mathrm{d}r}{\\int_{r_{-}}^{r_{+}}\\left[\\delta T_{b}^{\\mathrm{clip}}(r)\\right]^{2}\\,\\mathrm{d}r}}$，其中 $r_{\\pm} = R_{\\mathrm{b}} \\pm 3w$。\n    - 线性模型误差：$\\mathrm{NRMSE}_{\\mathrm{lin}}$ 的定义类似，用 $\\delta T_{b}^{\\mathrm{lin}}$ 替换 $\\delta T_{b}^{\\mathrm{corr}}$。\n- **数值方法**：积分使用复合梯形法则计算。$\\mathrm{NRMSE}(\\beta)$ 的最小化通过网格搜索完成。\n- **测试用例**：提供了四组参数 $(R_{\\mathrm{b}}, w, \\eta_{0}, \\delta_{0}, \\sigma)$。\n    1. $(5.0, 0.5, 0.4, 0.3, 0.6)$\n    2. $(10.0, 0.4, 0.95, 0.2, 0.5)$\n    3. $(8.0, 0.7, -0.6, 0.25, 0.8)$\n    4. $(12.0, 0.2, 0.8, 0.15, 0.3)$\n\n### 步骤 2：使用提取的给定条件进行验证\n该问题在再电离时期的宇宙学中有科学依据，特别是关于 $21\\,\\text{cm}$ 信号和红移空间畸变的建模。所提供的方程是该领域中常见的基于物理动机的简化。问题是适定的，提供了所有必要的函数、参数，以及一个具有明确数值方法的清晰计算目标。它不包含矛盾、歧义或主观论断。该问题是模型验证和参数校准中的一个标准计算物理练习。\n\n### 步骤 3：结论与行动\n问题有效。将提供解决方案。\n\n### 基于原理的解决方案设计\n目标是通过最小化修正雅可比因子模型 $J_{\\mathrm{corr}}(\\eta; \\beta)$ 与一个物理正则化的“真值”模型 $J_{\\mathrm{clip}}(\\eta; \\epsilon)$ 的偏差，来找到最优参数 $\\beta^{\\star}$。这通过所得亮温度信号的归一化均方根误差 (NRMSE) 来量化。我们还将计算标准线性近似的误差 $\\mathrm{NRMSE}_{\\mathrm{lin}}$ 以进行比较。\n\n首先，我们观察到亮温度模型共享一个公共乘法因子 $A(r) \\equiv T_{0}\\,x_{\\mathrm{HI}}(r)\\,[1 + \\delta(r)]$。修正模型的 $\\mathrm{NRMSE}$ 表达式为：\n$$\n\\mathrm{NRMSE}(\\beta) = \\sqrt{\\frac{\\int_{r_{-}}^{r_{+}}\\left[A(r) J_{\\mathrm{corr}}(\\eta(r);\\beta) - A(r) J_{\\mathrm{clip}}(\\eta(r);\\epsilon)\\right]^{2}\\,\\mathrm{d}r}{\\int_{r_{-}}^{r_{+}}\\left[A(r) J_{\\mathrm{clip}}(\\eta(r);\\epsilon)\\right]^{2}\\,\\mathrm{d}r}}\n$$\n这个表达式可以大幅简化。因子 $A(r)^2$ 同时出现在分子和分母的积分中，并且可以从平方差中提出。来自 $A(r)^2$ 的常数 $T_0^2$ 被抵消，剩下：\n$$\n\\mathrm{NRMSE}(\\beta)^{2} = \\frac{\\int_{r_{-}}^{r_{+}} \\left[J_{\\mathrm{corr}}(\\eta(r);\\beta) - J_{\\mathrm{clip}}(\\eta(r);\\epsilon)\\right]^{2} W(r) \\,\\mathrm{d}r}{\\int_{r_{-}}^{r_{+}} \\left[J_{\\mathrm{clip}}(\\eta(r);\\epsilon)\\right]^{2} W(r) \\,\\mathrm{d}r}\n$$\n其中权重函数是 $W(r) = \\left(x_{\\mathrm{HI}}(r)\\,[1 + \\delta(r)]\\right)^2$。这种表述阐明了我们正在最小化雅可比模型之间的平方差，其权重因子强调了中性氢密度高的区域。类似的简化也适用于 $\\mathrm{NRMSE}_{\\mathrm{lin}}$。\n\n对于每个测试用例，算法流程如下：\n1.  **网格和剖面生成**：在区间 $[R_{\\mathrm{b}} - 3w, R_{\\mathrm{b}} + 3w]$ 上创建一个包含 $N=4001$ 个点的均匀空间网格 $r$。计算中性氢分数 $x_{\\mathrm{HI}}(r)$、过密度 $\\delta(r)$ 和速度梯度 $\\eta(r)$ 的剖面，并将其存储为数组。\n2.  **雅可比因子计算**：在网格上评估不同的雅可比模型：线性模型 $J_{\\mathrm{lin}}(\\eta(r))$、截断模型 $J_{\\mathrm{clip}}(\\eta(r);\\epsilon)$ 和修正模型 $J_{\\mathrm{corr}}(\\eta(r);\\beta)$。\n3.  **数值积分设置**：计算权重函数 $W(r)$。通过对被积函数 $\\left[J_{\\mathrm{clip}}\\right]^2 W(r)$ 应用梯形法则来计算 NRMSE 的分母，该分母在给定测试用例中是常数。\n4.  **线性误差计算**：通过数值积分 $\\left[J_{\\mathrm{lin}} - J_{\\mathrm{clip}}\\right]^2 W(r)$ 来计算 $\\mathrm{NRMSE}_{\\mathrm{lin}}$ 的分子。然后 $\\mathrm{NRMSE}_{\\mathrm{lin}}$ 是两个积分之比的平方根。\n5.  **$\\beta$的校准**：在区间 $[0, 2]$ 内创建一个精细的 $\\beta$ 值网格。对于此网格中的每个 $\\beta$：\n    a. 计算修正雅可比因子 $J_{\\mathrm{corr}}(\\eta(r);\\beta)$。\n    b. 通过积分 $\\left[J_{\\mathrm{corr}} - J_{\\mathrm{clip}}\\right]^2 W(r)$ 来计算 $\\mathrm{NRMSE}(\\beta)$ 的分子。\n    c. 将 $\\mathrm{NRMSE}(\\beta)$ 计算为分子与预先计算的分母之比的平方根。\n6.  **最优参数识别**：识别出在网格上产生最小 $\\mathrm{NRMSE}(\\beta)$ 的值 $\\beta^{\\star}$。这个 $\\beta^{\\star}$ 是我们对最优参数的近似。相应的最小误差是 $\\mathrm{NRMSE}(\\beta^{\\star})$。\n7.  **结果汇总**：收集当前测试用例计算出的三个值——$\\mathrm{NRMSE}_{\\mathrm{lin}}$、$\\beta^{\\star}$ 和 $\\mathrm{NRMSE}(\\beta^{\\star})$。\n\n对所有四个测试用例重复此过程，并将最终结果按要求格式化为单个列表。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem of calibrating a redshift-space distortion model\n    for the 21cm signal near an ionization bubble.\n    \"\"\"\n    # Define constants and numerical parameters from the problem statement.\n    epsilon = 0.05\n    N_r = 4001\n    beta_min = 0.0\n    beta_max = 2.0\n    N_beta = 1001  # Grid size for beta search, sufficiently fine as requested.\n\n    # Test cases as tuples of (Rb, w, eta0, delta0, sigma)\n    test_cases = [\n        # Case 1: Moderate nonlinearity\n        (5.0, 0.5, 0.4, 0.3, 0.6),\n        # Case 2: Near-divergent inflow\n        (10.0, 0.4, 0.95, 0.2, 0.5),\n        # Case 3: Outflow\n        (8.0, 0.7, -0.6, 0.25, 0.8),\n        # Case 4: Sharp front\n        (12.0, 0.2, 0.8, 0.15, 0.3),\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        Rb, w, eta0, d0, sigma = case\n\n        # 1. Setup the spatial grid and radial profiles\n        r_min, r_max = Rb - 3 * w, Rb + 3 * w\n        r = np.linspace(r_min, r_max, N_r)\n        \n        # Dimensionless radial coordinate for profile functions\n        x_rel = (r - Rb) / w\n        \n        # Neutral fraction profile\n        x_HI = 0.5 * (1.0 + np.tanh(x_rel))\n        \n        # Overdensity profile\n        delta = d0 * np.exp(-(r - Rb)**2 / (2.0 * sigma**2))\n        \n        # Dimensionless velocity gradient profile\n        eta = eta0 * (1.0 / np.cosh(x_rel))**2\n\n        # 2. Define the Jacobian factor models\n        # Clipped model (the \"truth\" to be fitted)\n        J_clip = 1.0 / np.maximum(1.0 - eta, epsilon)\n        # Linear approximation model\n        J_lin = 1.0 + eta\n        \n        # 3. Calculate the common weighting factor for the integrals.\n        # The normalization T0 cancels in the NRMSE ratio.\n        weight = (x_HI * (1.0 + delta))**2\n        \n        # 4. Calculate the denominator for NRMSE, which is constant for a given case.\n        # This is the integral over the squared \"truth\" signal.\n        integrand_den = (J_clip**2) * weight\n        integral_den = np.trapz(integrand_den, r)\n\n        # 5. Calculate NRMSE for the linear model\n        integrand_num_lin = ((J_lin - J_clip)**2) * weight\n        integral_num_lin = np.trapz(integrand_num_lin, r)\n        nrmse_lin = np.sqrt(integral_num_lin / integral_den)\n        \n        # 6. Find optimal beta and the corresponding minimum NRMSE via grid search\n        beta_grid = np.linspace(beta_min, beta_max, N_beta)\n        nrmse_corr_values = np.zeros_like(beta_grid)\n        \n        for i, b in enumerate(beta_grid):\n            # Corrected model with the current beta value\n            J_corr = 1.0 / (1.0 - eta + b * eta**2)\n            \n            # Calculate the numerator of NRMSE for this beta\n            integrand_num_corr = ((J_corr - J_clip)**2) * weight\n            integral_num_corr = np.trapz(integrand_num_corr, r)\n            \n            # Store the resulting NRMSE\n            nrmse_corr_values[i] = np.sqrt(integral_num_corr / integral_den)\n            \n        # Find the minimum NRMSE and the beta that produced it\n        min_idx = np.argmin(nrmse_corr_values)\n        beta_star = beta_grid[min_idx]\n        nrmse_corr_star = nrmse_corr_values[min_idx]\n        \n        # 7. Append the results for the current case to the main list\n        all_results.extend([nrmse_lin, beta_star, nrmse_corr_star])\n\n    # 8. Format and print the final output as a single line\n    print(f\"[{','.join(f'{x:.6f}' for x in all_results)}]\")\n\nsolve()\n```", "id": "3488873"}]}