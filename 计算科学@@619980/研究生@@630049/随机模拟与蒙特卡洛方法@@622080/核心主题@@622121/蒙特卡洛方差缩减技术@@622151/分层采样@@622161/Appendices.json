{"hands_on_practices": [{"introduction": "动手实践的第一步是掌握分层抽样的核心优势：减少方差。本练习将探讨一个具有挑战性的场景，即重尾分布，其中原始蒙特卡洛方法的效率较低。通过将理论推导与编程实践相结合，我们将量化地展示分层抽样如何通过在不同数据层中进行合理分配，显著提高估计的效率和准确性 [@problem_id:3349482]。", "problem": "考虑一个重尾随机变量 $X$，其服从帕累托分布，尺度参数为 $x_m>0$，形状参数为 $\\alpha>2$，其概率密度函数 (PDF) 为 $f_X(x)=\\alpha x_m^{\\alpha} x^{-(\\alpha+1)}$ (当 $x\\ge x_m$ 时)。定义指示函数加权的尾部被积函数为 $g(x)=x\\mathbf{1}\\{x>x_0\\}$，其中阈值 $x_0>x_m$。目标是使用蒙特卡洛 (MC) 方法估计尾部期望 $\\mu=E[g(X)]$，并证明与粗略蒙特卡洛方法相比，采用奈曼分配的双层分层抽样设计能够降低变异系数。\n\n仅从期望、方差和分层抽样的基本定义出发，不使用任何预先给定的快捷公式，执行以下操作：\n\n1. 定义两个层：主体层 $h=0$ 为 $[x_m,x_0]$，尾部层 $h=1$ 为 $(x_0,\\infty)$。设层权重为 $w_h=P(X\\in\\text{stratum }h)$，被积函数在层内的标准差为 $\\sigma_h=\\sqrt{\\mathrm{Var}(g(X)\\mid X\\in\\text{stratum }h)}$。使用第一性原理，为帕累托模型推导计算 $\\mu$、$\\mathrm{Var}(g(X))$ 和 $\\mathrm{Var}(g(X)\\mid X>x_0)$ 所需的符号表达式。\n\n2. 构建分层估计量 $\\hat{\\mu}_{\\text{strat}}=\\sum_{h=0}^1 w_h \\bar{g}_h$，其中 $\\bar{g}_h$ 是从限制在第 $h$ 层的 $X$ 的条件分布中抽取的 $n_h$ 个独立样本计算出的 $g(X)$ 的样本均值。从 $\\hat{\\mu}_{\\text{strat}}$ 在独立性下的方差出发，推导在总样本量 $N=\\sum_{h=0}^1 n_h$ 固定的约束下使方差最小化的奈曼分配法则 $n_h\\propto w_h \\sigma_h$。解释该法则如何应用于当前的 $g(x)$，并注意任何方差为零的贡献。\n\n3. 将无偏估计量 $\\hat{\\mu}$ 的变异系数 (CV) 定义为 $\\mathrm{CV}=\\sqrt{\\mathrm{Var}(\\hat{\\mu})}/\\mu$。对于从 $X$ 中进行 $N$ 次独立抽样的粗略蒙特卡洛方法，用 $\\mathrm{Var}(g(X))$、$\\mu$ 和 $N$ 表示 $\\mathrm{CV}_{\\text{crude}}$。对于采用奈曼分配的双层设计，用尾部层的量和 $N$ 表示 $\\mathrm{CV}_{\\text{strat}}$。\n\n4. 实现一个程序，使用您推导的解析表达式计算 $\\mathrm{CV}_{\\text{crude}}$、$\\mathrm{CV}_{\\text{strat}}$ 以及它们的比率 $r=\\mathrm{CV}_{\\text{strat}}/\\mathrm{CV}_{\\text{crude}}$。使用以下参数值测试套件来评估和比较变异系数：\n   - 测试用例 1：$(\\alpha,x_m,x_0,N)=(3.0,1.0,2.0,10000)$\n   - 测试用例 2：$(\\alpha,x_m,x_0,N)=(2.1,1.0,5.0,10000)$\n   - 测试用例 3：$(\\alpha,x_m,x_0,N)=(5.0,1.0,10.0,10000)$\n   - 测试用例 4：$(\\alpha,x_m,x_0,N)=(3.0,1.0,1.1,10000)$\n\n5. 对每个测试用例，还要计算布尔值 $b$ 以指示改进情况，定义为 $b=(\\mathrm{CV}_{\\text{strat}} < \\mathrm{CV}_{\\text{crude}})$。\n\n您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果，并按测试用例的以下扁平化顺序排列：$[\\mathrm{CV}_{\\text{crude}}^{(1)},\\mathrm{CV}_{\\text{strat}}^{(1)},r^{(1)},b^{(1)},\\mathrm{CV}_{\\text{crude}}^{(2)},\\mathrm{CV}_{\\text{strat}}^{(2)},r^{(2)},b^{(2)},\\mathrm{CV}_{\\text{crude}}^{(3)},\\mathrm{CV}_{\\text{strat}}^{(3)},r^{(3)},b^{(3)},\\mathrm{CV}_{\\text{crude}}^{(4)},\\mathrm{CV}_{\\text{strat}}^{(4)},r^{(4)},b^{(4)}]$。所有数值答案必须是无量纲的实数（浮点数）或布尔值。此问题不涉及任何物理单位。", "solution": "所述问题具有科学依据，提法恰当，客观，并包含足够的信息以获得唯一解。这是蒙特卡洛积分中方差缩减技术的标准应用，没有任何矛盾或谬误。因此，该问题被认为是有效的。我们从第一性原理出发，给出一个完整的解。\n\n该解答需要为与帕累托分布的随机变量 $X$ 相关的几个统计量推导符号表达式。其概率密度函数 (PDF) 由 $f_X(x) = \\alpha x_m^{\\alpha} x^{-(\\alpha+1)}$ 给出（当 $x \\ge x_m$ 时），参数为 $\\alpha > 2$ 和 $x_m > 0$。我们感兴趣的被积函数是 $g(x) = x\\mathbf{1}\\{x>x_0\\}$，其中 $x_0 > x_m$。\n\n### 第 1 部分：基本量的推导\n\n首先，我们推导 $X$ 的累积分布函数 (CDF)，记为 $F_X(x) = P(X \\le x)$，这对于计算层权重至关重要。对于 $x \\ge x_m$：\n$$\nF_X(x) = \\int_{x_m}^{x} f_X(t) dt = \\int_{x_m}^{x} \\alpha x_m^{\\alpha} t^{-(\\alpha+1)} dt = \\alpha x_m^{\\alpha} \\left[ \\frac{t^{-\\alpha}}{-\\alpha} \\right]_{x_m}^{x} = -x_m^{\\alpha} (x^{-\\alpha} - x_m^{-\\alpha}) = 1 - \\left(\\frac{x_m}{x}\\right)^{\\alpha}\n$$\n\n这两个层分别是对应于区间 $[x_m, x_0]$ 的主体层 $h=0$ 和对应于 $(x_0, \\infty)$ 的尾部层 $h=1$。层权重 $w_h = P(X \\in \\text{stratum } h)$ 为：\n$$\nw_0 = P(x_m \\le X \\le x_0) = F_X(x_0) - F_X(x_m) = \\left(1 - \\left(\\frac{x_m}{x_0}\\right)^{\\alpha}\\right) - 0 = 1 - \\left(\\frac{x_m}{x_0}\\right)^{\\alpha}\n$$\n$$\nw_1 = P(X > x_0) = 1 - F_X(x_0) = 1 - \\left(1 - \\left(\\frac{x_m}{x_0}\\right)^{\\alpha}\\right) = \\left(\\frac{x_m}{x_0}\\right)^{\\alpha}\n$$\n可以很容易地验证 $w_0 + w_1 = 1$。\n\n现在，我们推导被积函数 $g(X) = X\\mathbf{1}\\{X>x_0\\}$ 的矩。\n期望 $\\mu = \\mathrm{E}[g(X)]$ 由以下公式给出：\n$$\n\\mu = \\int_{x_m}^{\\infty} g(x) f_X(x) dx = \\int_{x_m}^{\\infty} x\\mathbf{1}\\{x>x_0\\} (\\alpha x_m^{\\alpha} x^{-(\\alpha+1)}) dx\n$$\n指示函数 $\\mathbf{1}\\{x>x_0\\}$ 将积分域限制在 $(x_0, \\infty)$：\n$$\n\\mu = \\int_{x_0}^{\\infty} x (\\alpha x_m^{\\alpha} x^{-(\\alpha+1)}) dx = \\alpha x_m^{\\alpha} \\int_{x_0}^{\\infty} x^{-\\alpha} dx = \\alpha x_m^{\\alpha} \\left[ \\frac{x^{-\\alpha+1}}{1-\\alpha} \\right]_{x_0}^{\\infty}\n$$\n由于 $\\alpha > 2$，上限处的项为 $0$。\n$$\n\\mu = \\alpha x_m^{\\alpha} \\left(0 - \\frac{x_0^{1-\\alpha}}{1-\\alpha}\\right) = \\frac{\\alpha}{\\alpha-1} x_m^{\\alpha} x_0^{1-\\alpha}\n$$\n为了求方差 $\\mathrm{Var}(g(X)) = \\mathrm{E}[g(X)^2] - \\mu^2$，我们首先计算二阶矩 $\\mathrm{E}[g(X)^2]$：\n$$\n\\mathrm{E}[g(X)^2] = \\int_{x_0}^{\\infty} x^2 (\\alpha x_m^{\\alpha} x^{-(\\alpha+1)}) dx = \\alpha x_m^{\\alpha} \\int_{x_0}^{\\infty} x^{1-\\alpha} dx = \\alpha x_m^{\\alpha} \\left[ \\frac{x^{2-\\alpha}}{2-\\alpha} \\right]_{x_0}^{\\infty}\n$$\n由于 $\\alpha > 2$，上限处的项同样为 $0$。\n$$\n\\mathrm{E}[g(X)^2] = \\alpha x_m^{\\alpha} \\left(0 - \\frac{x_0^{2-\\alpha}}{2-\\alpha}\\right) = \\frac{\\alpha}{\\alpha-2} x_m^{\\alpha} x_0^{2-\\alpha}\n$$\n因此，方差为：\n$$\n\\mathrm{Var}(g(X)) = \\frac{\\alpha}{\\alpha-2} x_m^{\\alpha} x_0^{2-\\alpha} - \\left(\\frac{\\alpha}{\\alpha-1} x_m^{\\alpha} x_0^{1-\\alpha}\\right)^2\n$$\n接下来，我们确定层内方差 $\\sigma_h^2 = \\mathrm{Var}(g(X) \\mid X \\in \\text{stratum } h)$。\n对于层 $h=0$ ($[x_m, x_0]$)：在此层中的任何 $X$，被积函数 $g(X) = X\\mathbf{1}\\{X>x_0\\}$ 恒为 $0$。常数的方差为 $0$。\n$$\n\\sigma_0^2 = \\mathrm{Var}(g(X) \\mid X \\in [x_m, x_0]) = 0 \\implies \\sigma_0 = 0\n$$\n对于层 $h=1$ ($(x_0, \\infty)$)：此处，$g(X) = X$。我们需要计算 $\\sigma_1^2 = \\mathrm{Var}(X \\mid X > x_0)$。条件 PDF 为 $f_{X|X>x_0}(x) = f_X(x)/P(X>x_0) = f_X(x)/w_1$ (当 $x > x_0$ 时)。\n$$\nf_{X|X>x_0}(x) = \\frac{\\alpha x_m^{\\alpha} x^{-(\\alpha+1)}}{(x_m/x_0)^{\\alpha}} = \\alpha x_0^{\\alpha} x^{-(\\alpha+1)}\n$$\n这是一个形状参数为 $\\alpha$、尺度参数为 $x_0$ 的帕累托分布的 PDF。我们需要求其方差。条件均值为：\n$$\n\\mathrm{E}[X \\mid X > x_0] = \\int_{x_0}^{\\infty} x (\\alpha x_0^{\\alpha} x^{-(\\alpha+1)}) dx = \\frac{\\alpha}{\\alpha-1} x_0\n$$\n条件二阶矩为：\n$$\n\\mathrm{E}[X^2 \\mid X > x_0] = \\int_{x_0}^{\\infty} x^2 (\\alpha x_0^{\\alpha} x^{-(\\alpha+1)}) dx = \\frac{\\alpha}{\\alpha-2} x_0^2\n$$\n条件方差为：\n$$\n\\sigma_1^2 = \\mathrm{Var}(X \\mid X > x_0) = \\mathrm{E}[X^2 \\mid X > x_0] - (\\mathrm{E}[X \\mid X > x_0])^2 = \\frac{\\alpha}{\\alpha-2} x_0^2 - \\left(\\frac{\\alpha}{\\alpha-1} x_0\\right)^2\n$$\n$$\n\\sigma_1^2 = x_0^2 \\alpha \\left(\\frac{1}{\\alpha-2} - \\frac{\\alpha}{(\\alpha-1)^2}\\right) = x_0^2 \\alpha \\left(\\frac{(\\alpha-1)^2 - \\alpha(\\alpha-2)}{(\\alpha-2)(\\alpha-1)^2}\\right) = x_0^2 \\alpha \\left(\\frac{\\alpha^2 - 2\\alpha + 1 - \\alpha^2 + 2\\alpha}{(\\alpha-2)(\\alpha-1)^2}\\right)\n$$\n$$\n\\sigma_1^2 = \\frac{\\alpha x_0^2}{(\\alpha-2)(\\alpha-1)^2}\n$$\n\n### 第 2 部分：奈曼分配\n\n分层估计量为 $\\hat{\\mu}_{\\text{strat}} = \\sum_{h=0}^1 w_h \\bar{g}_h$，其中 $\\bar{g}_h$ 是从第 $h$ 层抽取的 $n_h$ 个样本的均值。该估计量的方差为：\n$$\n\\mathrm{Var}(\\hat{\\mu}_{\\text{strat}}) = \\sum_{h=0}^1 w_h^2 \\mathrm{Var}(\\bar{g}_h) = \\sum_{h=0}^1 w_h^2 \\frac{\\sigma_h^2}{n_h} = \\frac{w_0^2 \\sigma_0^2}{n_0} + \\frac{w_1^2 \\sigma_1^2}{n_1}\n$$\n奈曼分配在总样本量 $N=n_0+n_1$ 固定的约束下，使该方差最小化。我们使用拉格朗日乘子法。设 $L(n_0, n_1, \\lambda) = \\frac{w_0^2 \\sigma_0^2}{n_0} + \\frac{w_1^2 \\sigma_1^2}{n_1} + \\lambda(n_0+n_1-N)$。\n将偏导数设为零，$\\frac{\\partial L}{\\partial n_h} = -\\frac{w_h^2 \\sigma_h^2}{n_h^2} + \\lambda = 0$，得出 $n_h = \\frac{w_h \\sigma_h}{\\sqrt{\\lambda}}$。这表明 $n_h \\propto w_h \\sigma_h$。确切的分配公式为 $n_h = N \\frac{w_h \\sigma_h}{\\sum_k w_k \\sigma_k}$。\n\n在我们的具体问题中，$\\sigma_0 = 0$。分配公式规定：\n$$\nn_0 = N \\frac{w_0 \\sigma_0}{w_0 \\sigma_0 + w_1 \\sigma_1} = 0\n$$\n$$\nn_1 = N \\frac{w_1 \\sigma_1}{w_0 \\sigma_0 + w_1 \\sigma_1} = N \\frac{w_1 \\sigma_1}{w_1 \\sigma_1} = N\n$$\n该法则规定，所有抽样精力都应集中在第 1 层，因为第 0 层的方差为零，其对积分的贡献可以确定地认为是零。在奈曼分配下，总方差通常可以表示为 $\\mathrm{Var}(\\hat{\\mu}_{\\text{strat}}) = \\frac{1}{N}(\\sum_h w_h \\sigma_h)^2$。在我们的案例中，这简化为：\n$$\n\\mathrm{Var}(\\hat{\\mu}_{\\text{strat}}) = \\frac{1}{N}(w_0 \\sigma_0 + w_1 \\sigma_1)^2 = \\frac{(w_1 \\sigma_1)^2}{N}\n$$\n\n### 第 3 部分：变异系数\n\n无偏估计量 $\\hat{\\mu}$ 的变异系数 ($\\mathrm{CV}$) 为 $\\mathrm{CV} = \\sqrt{\\mathrm{Var}(\\hat{\\mu})}/\\mu$。\n对于有 $N$ 个样本的粗略蒙特卡洛方法，$\\hat{\\mu}_{\\text{crude}}$ 是无偏的，其方差为 $\\mathrm{Var}(\\hat{\\mu}_{\\text{crude}}) = \\mathrm{Var}(g(X))/N$。\n$$\n\\mathrm{CV}_{\\text{crude}} = \\frac{\\sqrt{\\mathrm{Var}(g(X))/N}}{\\mu} = \\frac{\\sqrt{\\mathrm{Var}(g(X))}}{\\mu \\sqrt{N}}\n$$\n对于采用奈曼分配的分层抽样，$\\hat{\\mu}_{\\text{strat}}$ 也是无偏的，其方差为 $\\mathrm{Var}(\\hat{\\mu}_{\\text{strat}}) = (w_1 \\sigma_1)^2/N$。\n$$\n\\mathrm{CV}_{\\text{strat}} = \\frac{\\sqrt{(w_1 \\sigma_1)^2/N}}{\\mu} = \\frac{w_1 \\sigma_1}{\\mu \\sqrt{N}}\n$$\n\n### 第 4 和 5 部分：实现公式\n\n程序将为每个测试用例 $(\\alpha, x_m, x_0, N)$ 实现上述推导出的以下公式：\n1.  均值：$\\mu = \\frac{\\alpha}{\\alpha-1} x_m^{\\alpha} x_0^{1-\\alpha}$\n2.  $g(X)$ 的方差：$\\mathrm{Var}(g(X)) = \\left(\\frac{\\alpha}{\\alpha-2} x_m^{\\alpha} x_0^{2-\\alpha}\\right) - \\mu^2$\n3.  $\\mathrm{CV}_{\\text{crude}} = \\frac{\\sqrt{\\mathrm{Var}(g(X))}}{\\mu \\sqrt{N}}$\n4.  尾部权重：$w_1 = (x_m/x_0)^{\\alpha}$\n5.  尾部标准差：$\\sigma_1 = \\sqrt{\\frac{\\alpha x_0^2}{(\\alpha-2)(\\alpha-1)^2}} = \\frac{x_0}{\\alpha-1}\\sqrt{\\frac{\\alpha}{\\alpha-2}}$\n6.  $\\mathrm{CV}_{\\text{strat}} = \\frac{w_1 \\sigma_1}{\\mu \\sqrt{N}}$\n7.  比率：$r = \\mathrm{CV}_{\\text{strat}} / \\mathrm{CV}_{\\text{crude}} = \\frac{w_1 \\sigma_1}{\\sqrt{\\mathrm{Var}(g(X))}}$\n8.  改进：$b = (\\mathrm{CV}_{\\text{strat}} < \\mathrm{CV}_{\\text{crude}})$。根据全方差定律，$\\mathrm{Var}(g(X)) = w_1 \\sigma_1^2 + w_0 w_1 (\\mu/w_1)^2 = w_1\\sigma_1^2 + w_0/w_1 \\mu^2$。比率的平方为 $r^2 = \\frac{w_1^2 \\sigma_1^2}{\\mathrm{Var}(g(X))} = \\frac{w_1^2 \\sigma_1^2}{w_1 \\sigma_1^2 + w_0/w_1 \\mu^2} < 1$，只要 $w_0>0$（由 $x_0>x_m$ 保证），此式成立。因此，$b$ 将始终为真。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes and compares coefficients of variation for crude Monte Carlo\n    and stratified sampling estimators of a tail expectation.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (alpha, x_m, x_0, N)\n        (3.0, 1.0, 2.0, 10000),\n        (2.1, 1.0, 5.0, 10000),\n        (5.0, 1.0, 10.0, 10000),\n        (3.0, 1.0, 1.1, 10000),\n    ]\n\n    results = []\n    for case in test_cases:\n        alpha, x_m, x_0, N = case\n\n        # 1. Calculate the true mean mu = E[g(X)]\n        mu = (alpha / (alpha - 1)) * (x_m**alpha) * (x_0**(1 - alpha))\n\n        # 2. Calculate the variance of g(X) for crude MC\n        # E[g(X)^2]\n        E_g_sq = (alpha / (alpha - 2)) * (x_m**alpha) * (x_0**(2 - alpha))\n        var_g = E_g_sq - mu**2\n\n        # 3. Calculate CV_crude\n        cv_crude = np.sqrt(var_g) / (mu * np.sqrt(N))\n\n        # 4. Calculate quantities for stratified sampling\n        # Stratum 1 (tail) weight w_1\n        w_1 = (x_m / x_0)**alpha\n        \n        # Stratum 1 (tail) standard deviation sigma_1\n        sigma_1_sq = (alpha * x_0**2) / ((alpha - 2) * (alpha - 1)**2)\n        sigma_1 = np.sqrt(sigma_1_sq)\n\n        # 5. Calculate CV_strat\n        cv_strat = (w_1 * sigma_1) / (mu * np.sqrt(N))\n\n        # 6. Calculate the ratio and improvement boolean\n        ratio = cv_strat / cv_crude\n        improvement = cv_strat  cv_crude\n\n        # Append results in the specified order\n        results.append(cv_crude)\n        results.append(cv_strat)\n        results.append(ratio)\n        results.append(improvement)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3349482"}, {"introduction": "在掌握了基本原理之后，我们将把分层抽样应用于更复杂、更前沿的场景。本练习将分层抽样与常用于求解偏微分方程（PDEs）的多层蒙特卡洛（MLMC）方法相结合。核心挑战在于，如何在给定的计算成本预算下，通过优化方法在不同层级（levels）和层（strata）之间最优地分配样本资源，以实现最小的估计方差。这展示了分层抽样在解决真实世界复杂科学计算问题中的强大能力与灵活性 [@problem_id:3349509]。", "problem": "考虑一个用于椭圆偏微分方程（PDE）的、依赖于层级的目标量的多层蒙特卡洛（MLMC）估计量。设离散层级 $\\ell$ 上的目标量表示为 $Q_{\\ell}$，并定义标准 MLMC 伸缩差分 $Y_{\\ell} = Q_{\\ell} - Q_{\\ell-1}$（对于 $\\ell \\ge 1$），其中 $Y_{0} = Q_{0}$。假设在每个层级 $\\ell$，您通过将输入空间划分为 $H_{\\ell}$ 个不相交的层来实施分层抽样方案，这些层由 $h \\in \\{1,\\dots,H_{\\ell}\\}$ 索引，对应的层概率为 $P_{\\ell,h}$，条件层方差为 $\\sigma_{\\ell,h}^{2} = \\operatorname{Var}(Y_{\\ell} \\mid \\text{stratum } h)$，每个样本的计算成本为 $c_{\\ell,h}  0$。\n\n假设所有层和所有层级之间的样本是独立的。考虑无偏分层 MLMC 估计量\n$$\n\\widehat{\\mu} = \\sum_{\\ell=0}^{L-1} \\sum_{h=1}^{H_{\\ell}} P_{\\ell,h} \\,\\overline{Y}_{\\ell,h},\n$$\n其中 $\\overline{Y}_{\\ell,h}$ 是在层级 $\\ell$ 的层 $h$ 内条件抽取的 $n_{\\ell,h}$ 个样本上 $Y_{\\ell}$ 的经验均值。在独立性假設下，\n$$\n\\operatorname{Var}(\\widehat{\\mu}) = \\sum_{\\ell=0}^{L-1} \\sum_{h=1}^{H_{\\ell}} \\frac{P_{\\ell,h}^{2} \\,\\sigma_{\\ell,h}^{2}}{n_{\\ell,h}}.\n$$\n总计算成本为\n$$\n\\mathcal{C}(n) = \\sum_{\\ell=0}^{L-1} \\sum_{h=1}^{H_{\\ell}} c_{\\ell,h}\\, n_{\\ell,h}.\n$$\n\n您的任务是确定最优的连续（实值）样本分配 $n_{\\ell,h} \\ge 0$，该分配在固定总成本预算 $\\mathcal{C}(n) \\le C$ 的约束下最小化 $\\operatorname{Var}(\\widehat{\\mu})$，然后通过将每个 $n_{\\ell,h}$ 向下取整到最近的整数来报告一个整数分配。您必须从第一性原理出发，仅从方差表达式和成本约束推导出该分配。对于 $P_{\\ell,h}\\,\\sigma_{\\ell,h} = 0$ 或 $c_{\\ell,h} = \\infty$ 的层，分配应为 $n_{\\ell,h} = 0$。如果对所有层都有 $P_{\\ell,h}^2 \\sigma_{\\ell,h}^2 = 0$，则最小化方差为 $0$，所有分配均为 $0$。\n\n您必须实现一个完整、可运行的程序，该程序：\n- 计算在 $\\sum c_{\\ell,h} n_{\\ell,h} \\le C$ 约束下最小化 $\\operatorname{Var}(\\widehat{\\mu})$ 的最优连续分配 $n_{\\ell,h}^{\\star}$。\n- 将每个 $n_{\\ell,h}^{\\star}$ 向下取整为整数，形成报告的分配。\n- 计算相应的最小化连续方差值（不要使用向下取整后的整数重新计算方差；报告与连续最优解对应的解析最小值）。\n\n为了在椭圆 PDE 背景下实现科学真实性，请在测试套件中考虑以下参数化。设网格尺寸在空间维度 $d=2$ 中按 $h_{\\ell} = h_{0} 2^{-\\ell}$ 缩放，因此每个样本的成本近似按 $c_{\\ell} \\propto h_{\\ell}^{-d} \\propto 4^{\\ell}$ 缩放。设强误差衰减意味着方差衰减 $\\sigma_{\\ell}^{2} \\propto 2^{-\\gamma \\ell}$，其中 $\\gamma  0$。将一维输入驱动因素分层为基于分位数的层，其概率为 $P_{\\ell,h}$，条件方差乘数为 $r_{h}$，因此 $\\sigma_{\\ell,h} = s_{\\ell} r_{h}$，其中 $s_{\\ell}$ 是依赖于层级的基线标准差。假设 $c_{\\ell,h} = c_{\\ell}$ 与 $h$ 无关。\n\n测试套件：\n1. 理想情况，包含三个层级，每个层级三个层：\n   - 层级：$L=3$，其中 $\\ell \\in \\{0,1,2\\}$。\n   - 成本：$c_{\\ell} = c_{0}\\,4^{\\ell}$，其中 $c_{0} = 5000$。\n   - 基线标准差：$s_{\\ell} = s_{0}\\,2^{-2\\ell}$，其中 $s_{0} = 0.25$。\n   - 每个层级的层概率：对于 $h \\in \\{1,2,3\\}$，$P_{\\ell,h} \\in \\{0.2, 0.6, 0.2\\}$。\n   - 层乘数：$r_{h} \\in \\{1.4, 1.0, 1.4\\}$。\n   - 预算：$C = 20000000$。\n2. 边界情况，包含两个层级，每个层级四个层，包括零概率和零方差的层：\n   - 层级：$L=2$，其中 $\\ell \\in \\{0,1\\}$。\n   - 成本：$c_{\\ell} = c_{0}\\,4^{\\ell}$，其中 $c_{0} = 10000$。\n   - 基线标准差：$s_{\\ell} = s_{0}\\,2^{-1.5\\ell}$，其中 $s_{0} = 0.1$。\n   - 每个层级的层概率：对于 $h \\in \\{1,2,3,4\\}$，$P_{\\ell,h} \\in \\{0.0, 0.3, 0.4, 0.3\\}$。\n   - 层乘数：$r_{h} \\in \\{0.0, 1.0, 1.2, 0.8\\}$。\n   - 预算：$C = 150000$。\n3. 边缘情况，包含三个层级，每个层级两个层，所有层级的方差均为零：\n   - 层级：$L=3$，其中 $\\ell \\in \\{0,1,2\\}$。\n   - 成本：$c_{\\ell} = c_{0}\\,4^{\\ell}$，其中 $c_{0} = 2000$。\n   - 基线标准差：对于所有 $\\ell$，$s_{\\ell} = 0$。\n   - 每个层级的层概率：对于 $h \\in \\{1,2\\}$，$P_{\\ell,h} \\in \\{0.5, 0.5\\}$。\n   - 层乘数：$r_{h} \\in \\{1.0, 1.0\\}$。\n   - 预算：$C = 100000$。\n\n要求的最终输出格式：\n- 您的程序应生成一行输出，包含一个方括号括起来的逗号分隔列表。每个测试用例的结果必须是 $[\\text{allocations}, \\text{min\\_variance}]$ 形式的列表，其中 $\\text{allocations}$ 是按层级索引 $\\ell$ 递增，然后按层索引 $h$ 递增的字典序排列的整数 $n_{\\ell,h}$ 的扁平化列表，$\\text{min\\_variance}$ 是最小化连续方差值，以浮点数表示。例如：$[[[n_{0,1},\\dots,n_{L-1,H_{L-1}}], v_{1}], [[\\dots], v_{2}], [[\\dots], v_{3}]]$。\n\n所有答案必须是无量纲的数值。所有浮点数请用标准十进制表示法表示。", "solution": "我们考虑在离散层级和输入空间上都进行分层的多层蒙特卡洛（MLMC）估计量。目标是在固定的总成本约束下最小化方差，这是一个凸优化问题。\n\n基本基础和定义：\n- 目标量期望值的估计量为\n$$\n\\widehat{\\mu} = \\sum_{\\ell=0}^{L-1} \\sum_{h=1}^{H_{\\ell}} P_{\\ell,h} \\,\\overline{Y}_{\\ell,h},\n$$\n其中 $Y_{\\ell} = Q_{\\ell} - Q_{\\ell-1}$ ($Y_{0} = Q_{0}$)，$P_{\\ell,h}$ 是层概率，$\\overline{Y}_{\\ell,h}$ 是在层级 $\\ell$ 的层 $h$ 内对 $n_{\\ell,h}$ 个独立样本的样本均值。\n\n- 在层和层级之间独立的假设下，方差是可加的：\n$$\n\\operatorname{Var}(\\widehat{\\mu}) = \\sum_{\\ell=0}^{L-1} \\sum_{h=1}^{H_{\\ell}} \\operatorname{Var}\\!\\left(P_{\\ell,h} \\,\\overline{Y}_{\\ell,h}\\right)\n= \\sum_{\\ell=0}^{L-1} \\sum_{h=1}^{H_{\\ell}} P_{\\ell,h}^{2} \\,\\operatorname{Var}\\!\\left(\\overline{Y}_{\\ell,h}\\right)\n= \\sum_{\\ell=0}^{L-1} \\sum_{h=1}^{H_{\\ell}} \\frac{P_{\\ell,h}^{2} \\,\\sigma_{\\ell,h}^{2}}{n_{\\ell,h}},\n$$\n其中 $\\sigma_{\\ell,h}^{2} = \\operatorname{Var}(Y_{\\ell} \\mid \\text{stratum } h)$。\n\n- 总成本与样本数呈线性关系：\n$$\n\\mathcal{C}(n) = \\sum_{\\ell=0}^{L-1} \\sum_{h=1}^{H_{\\ell}} c_{\\ell,h}\\,n_{\\ell,h},\n$$\n其中 $c_{\\ell,h}  0$ 表示每个样本的成本。\n\n优化问题：\n我们希望求解\n$$\n\\min_{n_{\\ell,h} \\ge 0} \\sum_{\\ell,h} \\frac{a_{\\ell,h}}{n_{\\ell,h}}\n\\quad \\text{subject to} \\quad \\sum_{\\ell,h} c_{\\ell,h}\\,n_{\\ell,h} \\le C,\n$$\n这里我们简记 $a_{\\ell,h} := P_{\\ell,h}^{2}\\,\\sigma_{\\ell,h}^{2}$，且求和遍及所有 $(\\ell,h)$ 对。\n\n这是一个凸优化问题，因为 $f(n) = a/n$ 在 $n0$ 上是凸函数，且约束是线性的。使用拉格朗日乘子法，构建拉格朗日函数\n$$\n\\mathcal{L}(n,\\lambda) = \\sum_{\\ell,h} \\frac{a_{\\ell,h}}{n_{\\ell,h}} + \\lambda\\left(\\sum_{\\ell,h} c_{\\ell,h}\\,n_{\\ell,h} - C\\right),\n$$\n其中对偶变量 $\\lambda \\ge 0$。对于每个 $n_{\\ell,h}  0$ 的 $(\\ell,h)$，平稳性条件给出\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial n_{\\ell,h}} = -\\frac{a_{\\ell,h}}{n_{\\ell,h}^{2}} + \\lambda c_{\\ell,h} = 0\n\\quad \\Rightarrow \\quad\nn_{\\ell,h}^{2} = \\frac{a_{\\ell,h}}{\\lambda c_{\\ell,h}}\n\\quad \\Rightarrow \\quad\nn_{\\ell,h} = \\sqrt{\\frac{a_{\\ell,h}}{\\lambda c_{\\ell,h}}}.\n$$\n在等式处强制执行成本约束（方差随 $n_{\\ell,h}$ 增加而严格减小，因此最优解会用尽全部预算，除非所有 $a_{\\ell,h} = 0$）可得\n$$\n\\sum_{\\ell,h} c_{\\ell,h} \\, n_{\\ell,h}\n= \\sum_{\\ell,h} c_{\\ell,h} \\,\\sqrt{\\frac{a_{\\ell,h}}{\\lambda c_{\\ell,h}}}\n= \\sum_{\\ell,h} \\frac{\\sqrt{a_{\\ell,h} c_{\\ell,h}}}{\\sqrt{\\lambda}}\n= C.\n$$\n因此，\n$$\n\\sqrt{\\lambda} = \\frac{\\sum_{\\ell,h} \\sqrt{a_{\\ell,h} c_{\\ell,h}}}{C}.\n$$\n代入回去得到最优连续分配\n$$\nn_{\\ell,h}^{\\star} = \\sqrt{\\frac{a_{\\ell,h}}{c_{\\ell,h}}}\\,\\frac{C}{\\sum_{j} \\sqrt{a_{j} c_{j}}}\n= \\frac{C}{S}\\,\\frac{P_{\\ell,h}\\,\\sigma_{\\ell,h}}{\\sqrt{c_{\\ell,h}}},\n\\quad \\text{其中} \\quad\nS := \\sum_{j} P_{j}\\,\\sigma_{j}\\,\\sqrt{c_{j}},\n$$\n且索引 $j$ 遍及所有 $(\\ell,h)$ 对。\n\n如果对于特定的层 $(\\ell,h)$ 有 $a_{\\ell,h} = 0$，则公式给出 $n_{\\ell,h}^{\\star} = 0$，符合预期。如果对所有对都有 $a_{\\ell,h} = 0$，则 $S=0$，最小化方差为 $0$，任何总成本为零的分配都满足约束；自然的选择是所有对的 $n_{\\ell,h}^{\\star} = 0$。\n\n最优时可达到的最小方差：\n将 $n_{\\ell,h}^{\\star}$ 代入方差，\n$$\n\\operatorname{Var}_{\\min} = \\sum_{\\ell,h} \\frac{a_{\\ell,h}}{n_{\\ell,h}^{\\star}}\n= \\sum_{\\ell,h} \\frac{a_{\\ell,h}}{\\sqrt{a_{\\ell,h}/c_{\\ell,h}}\\,(C/S)}\n= \\sum_{\\ell,h} \\sqrt{a_{\\ell,h} c_{\\ell,h}}\\,\\frac{S}{C}\n= \\frac{S^{2}}{C}.\n$$\n\n算法设计：\n- 计算 $a_{\\ell,h} = P_{\\ell,h}^{2}\\,\\sigma_{\\ell,h}^{2}$。\n- 计算 $S = \\sum_{\\ell,h} \\sqrt{a_{\\ell,h}\\,c_{\\ell,h}} = \\sum_{\\ell,h} P_{\\ell,h}\\,\\sigma_{\\ell,h}\\,\\sqrt{c_{\\ell,h}}$。\n- 如果 $S = 0$，设置所有 $n_{\\ell,h}^{\\star} = 0$ 且 $\\operatorname{Var}_{\\min} = 0$。\n- 否则，计算 $n_{\\ell,h}^{\\star} = (C/S)\\,\\sqrt{a_{\\ell,h}/c_{\\ell,h}}$。\n- 通过将 $n_{\\ell,h}^{\\star}$ 向下取整到 $\\lfloor n_{\\ell,h}^{\\star} \\rfloor$ 来报告整数分配。要报告的最小化方差是连续最优值 $\\operatorname{Var}_{\\min} = S^{2}/C$。\n\n应用于给定的测试套件：\n- 对于每个测试用例，构建 $c_{\\ell,h}$、$s_{\\ell}$、$r_{h}$，并使用给定的 $P_{\\ell,h}$ 设置 $\\sigma_{\\ell,h} = s_{\\ell}\\,r_{h}$。使用与 $h$ 无关的 $c_{\\ell,h} = c_{\\ell}$。然后遵循算法计算 $n_{\\ell,h}^{\\star}$，向下取整为整数，并计算 $\\operatorname{Var}_{\\min}$。\n\n最终输出格式：\n- 对于每个测试用例，输出一个列表 $[\\text{allocations}, \\text{min\\_variance}]$，其中 allocations 是按 $\\ell$ 递增然后按 $h$ 递增的字典序排列的 $\\lfloor n_{\\ell,h}^{\\star}\\rfloor$ 的扁平化列表，$\\text{min\\_variance}$ 是 $\\operatorname{Var}_{\\min}$ 的浮点数值。将三个测试用例聚合在一个外部列表中，并打印该单行表示。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef optimal_allocation(P, sigma, cost, budget):\n    \"\"\"\n    Compute optimal continuous allocation and minimal variance for stratified MLMC.\n\n    Parameters:\n    - P: list of lists, P[l][h] = stratum probability at level l, stratum h.\n    - sigma: list of lists, sigma[l][h] = conditional std at level l, stratum h.\n    - cost: list, cost[l] = per-sample cost at level l (independent of h).\n    - budget: float, total cost budget C.\n\n    Returns:\n    - n_star: list of lists of floats, optimal continuous allocation n_{l,h}^*.\n    - vmin: float, minimized continuous variance.\n    \"\"\"\n    L = len(P)\n    # Compute a_{l,h} = P_{l,h}^2 * sigma_{l,h}^2 and S = sum sqrt(a_{l,h} * c_{l,h})\n    a = []\n    sqrt_terms = []\n    for l in range(L):\n        H_l = len(P[l])\n        a_l = []\n        for h in range(H_l):\n            a_lh = (P[l][h]**2) * (sigma[l][h]**2)\n            a_l.append(a_lh)\n            # c_{l,h} = cost[l]\n            sqrt_terms.append(np.sqrt(a_lh * cost[l]))\n        a.append(a_l)\n    S = np.sum(sqrt_terms)\n    if S == 0.0 or budget == 0.0:\n        # No variance to reduce or no budget: allocations zero, variance zero\n        n_star = [[0.0 for _ in P[l]] for l in range(L)]\n        vmin = 0.0\n        return n_star, vmin\n    # Compute n_{l,h}^* = (budget / S) * sqrt(a_{l,h} / cost[l])\n    n_star = []\n    for l in range(L):\n        n_star_l = []\n        for h in range(len(P[l])):\n            a_lh = a[l][h]\n            if a_lh == 0.0 or np.isinf(cost[l]) or cost[l] == 0.0:\n                n_star_l.append(0.0)\n            else:\n                n_star_l.append((budget / S) * np.sqrt(a_lh / cost[l]))\n        n_star.append(n_star_l)\n    vmin = (S**2) / budget\n    return n_star, vmin\n\ndef flatten_allocations(n_star):\n    \"\"\"Flatten nested allocations in lexicographic order by level then stratum.\"\"\"\n    flat = []\n    for l in range(len(n_star)):\n        for h in range(len(n_star[l])):\n            flat.append(int(np.floor(n_star[l][h])))\n    return flat\n\ndef solve():\n    # Define the test cases from the problem statement.\n\n    # Test case 1: Happy path with L=3, H each=3\n    L1 = 3\n    c0_1 = 5000.0\n    cost1 = [c0_1 * (4**l) for l in range(L1)]\n    s0_1 = 0.25\n    # s_l = s0 * 2^{-2 l}\n    s_levels_1 = [s0_1 * (2**(-2*l)) for l in range(L1)]\n    P_strata_1 = [0.2, 0.6, 0.2]\n    r_strata_1 = [1.4, 1.0, 1.4]\n    # Build P and sigma arrays\n    P1 = [P_strata_1[:] for _ in range(L1)]\n    sigma1 = []\n    for l in range(L1):\n        sigma1.append([s_levels_1[l] * r for r in r_strata_1])\n    budget1 = 20000000.0\n\n    # Test case 2: Boundary case with zero-probability and zero-variance strata\n    L2 = 2\n    c0_2 = 10000.0\n    cost2 = [c0_2 * (4**l) for l in range(L2)]\n    s0_2 = 0.1\n    # s_l = s0 * 2^{-1.5 l}\n    s_levels_2 = [s0_2 * (2**(-1.5*l)) for l in range(L2)]\n    P_strata_2 = [0.0, 0.3, 0.4, 0.3]\n    r_strata_2 = [0.0, 1.0, 1.2, 0.8]\n    P2 = [P_strata_2[:] for _ in range(L2)]\n    sigma2 = []\n    for l in range(L2):\n        sigma2.append([s_levels_2[l] * r for r in r_strata_2])\n    budget2 = 150000.0\n\n    # Test case 3: Edge case with zero variance across all levels\n    L3 = 3\n    c0_3 = 2000.0\n    cost3 = [c0_3 * (4**l) for l in range(L3)]\n    s_levels_3 = [0.0 for _ in range(L3)]\n    P_strata_3 = [0.5, 0.5]\n    r_strata_3 = [1.0, 1.0]\n    P3 = [P_strata_3[:] for _ in range(L3)]\n    sigma3 = []\n    for l in range(L3):\n        sigma3.append([s_levels_3[l] * r for r in r_strata_3])\n    budget3 = 100000.0\n\n    test_cases = [\n        (P1, sigma1, cost1, budget1),\n        (P2, sigma2, cost2, budget2),\n        (P3, sigma3, cost3, budget3),\n    ]\n\n    results = []\n    for P, sigma, cost, budget in test_cases:\n        n_star, vmin = optimal_allocation(P, sigma, cost, budget)\n        allocations = flatten_allocations(n_star)\n        results.append([allocations, float(vmin)])\n\n    # Final print statement in the exact required format.\n    print(f\"{results}\")\n\nsolve()\n```", "id": "3349509"}]}