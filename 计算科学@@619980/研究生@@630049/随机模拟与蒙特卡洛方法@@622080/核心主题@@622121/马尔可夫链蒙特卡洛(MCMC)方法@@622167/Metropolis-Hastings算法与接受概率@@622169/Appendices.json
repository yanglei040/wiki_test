{"hands_on_practices": [{"introduction": "Metropolis-Hastings 算法的接受概率公式虽然简洁，但在实际应用中却充满了陷阱。本练习旨在解决一个关键的实际问题：数值稳定性，尤其是在处理来自大型数据集的对数概率时，该问题尤为突出。通过这个练习，您将学会如何以数值稳定的方式计算接受概率，并正确处理非对称提议分布（例如对数正态随机游走）的 Hastings 校正项 [@problem_id:3355587]。", "problem": "考虑一个 Metropolis-Hastings (MH) 步骤，其目标是 $\\mathbb{R}^{2}$ 上的一个未归一化概率密度，形式为 $\\pi(\\theta) \\propto \\exp(\\ell(\\theta))$，其中 $\\ell(\\theta)$ 是对数后验。当前状态为 $x = (2.0,\\, 0.5)$，提议状态为 $y = (2.1,\\, 0.55)$。对数后验值（其汇总了大量数据贡献）为\n$$\n\\ell(x) \\;=\\; -1.357913942 \\times 10^{6}, \n\\qquad\n\\ell(y) \\;=\\; -1.357919942 \\times 10^{6}.\n$$\n提议分布是一个独立分量乘性对数正态随机游走，其尺度参数 $\\sigma_{1} > 0$ 和 $\\sigma_{2} > 0$ 固定：\n$$\nq(y \\mid x) \\;=\\; \\prod_{i=1}^{2} \\left[ \\frac{1}{y_{i}\\,\\sigma_{i}\\,\\sqrt{2\\pi}} \\; \\exp\\!\\left( -\\frac{\\left(\\ln y_{i} - \\ln x_{i}\\right)^{2}}{2\\sigma_{i}^{2}} \\right) \\right].\n$$\n请仅使用基本的马尔可夫链蒙特卡洛原理和定义，以数值稳定的方式计算从 $x$ 移动到 $y$ 的 Metropolis-Hastings 接受概率。您的计算不得单独对 $\\ell(x)$ 或 $\\ell(y)$ 进行指数运算。请将最终数值答案四舍五入至六位有效数字。", "solution": "用户在马尔可夫链蒙特卡洛方法领域提供了一个适定问题。所有给定条件都是一致的，并且足以得到唯一解。该问题具有科学依据且客观。因此，我将提供完整的解题过程。\n\nMetropolis-Hastings (MH) 算法的基本原理是细致平衡条件，它确保生成的马尔可夫链以目标分布 $\\pi(\\theta)$ 作为其平稳分布。对于从当前状态 $x$ 到新状态 $y$ 的提议移动，其接受概率 $\\alpha(y \\mid x)$ 的定义是为了满足此条件。接受概率的公式为：\n$$\n\\alpha(y \\mid x) = \\min\\left(1, A(y \\mid x)\\right)\n$$\n其中 $A(y \\mid x)$ 是 Metropolis-Hastings 接受率，由下式给出：\n$$\nA(y \\mid x) = \\frac{\\pi(y) \\, q(x \\mid y)}{\\pi(x) \\, q(y \\mid x)}\n$$\n这里，$\\pi(\\cdot)$ 是目标概率密度，而 $q(\\cdot \\mid \\cdot)$ 是提议（或转移）密度。\n\n问题指出，目标密度是一个形式为 $\\pi(\\theta) \\propto \\exp(\\ell(\\theta))$ 的未归一化后验，其中 $\\ell(\\theta)$ 是对数后验。因此，在状态 $y$ 和 $x$ 处的目标密度之比为：\n$$\n\\frac{\\pi(y)}{\\pi(x)} = \\frac{C \\exp(\\ell(y))}{C \\exp(\\ell(x))} = \\exp(\\ell(y) - \\ell(x))\n$$\n其中 $C$ 是未知的归一化常数，它被抵消了。\n\n接下来，我们必须确定提议密度的比率 $\\frac{q(x \\mid y)}{q(y \\mid x)}$，这被称为 Hastings 修正因子。提议密度由下式给出：\n$$\nq(y \\mid x) = \\prod_{i=1}^{2} \\left[ \\frac{1}{y_{i}\\,\\sigma_{i}\\,\\sqrt{2\\pi}} \\; \\exp\\!\\left( -\\frac{\\left(\\ln y_{i} - \\ln x_{i}\\right)^{2}}{2\\sigma_{i}^{2}} \\right) \\right]\n$$\n这描述了这样一个过程：从均值为 $\\ln x_i$、标准差为 $\\sigma_i$ 的正态分布中抽取 $\\ln y_i$，从而从 $x=(x_1, x_2)$ 生成新状态 $y=(y_1, y_2)$。\n\n为了求得 $q(x \\mid y)$，我们只需在 $q(y \\mid x)$ 的表达式中交换 $x$ 和 $y$ 的角色：\n$$\nq(x \\mid y) = \\prod_{i=1}^{2} \\left[ \\frac{1}{x_{i}\\,\\sigma_{i}\\,\\sqrt{2\\pi}} \\; \\exp\\!\\left( -\\frac{\\left(\\ln x_{i} - \\ln y_{i}\\right)^{2}}{2\\sigma_{i}^{2}} \\right) \\right]\n$$\n现在，我们可以计算这个比率。我们观察到指数中的平方项是对称的：$(\\ln x_i - \\ln y_i)^2 = (-( \\ln y_i - \\ln x_i))^2 = (\\ln y_i - \\ln x_i)^2$。因此，密度的指数部分是相同的，在比率中被抵消了。\n\\begin{align*}\n\\frac{q(x \\mid y)}{q(y \\mid x)} = \\frac{\\displaystyle\\prod_{i=1}^{2} \\left[ \\frac{1}{x_{i}\\,\\sigma_{i}\\,\\sqrt{2\\pi}} \\; \\exp\\!\\left( -\\frac{\\left(\\ln x_{i} - \\ln y_{i}\\right)^{2}}{2\\sigma_{i}^{2}} \\right) \\right]}{\\displaystyle\\prod_{i=1}^{2} \\left[ \\frac{1}{y_{i}\\,\\sigma_{i}\\,\\sqrt{2\\pi}} \\; \\exp\\!\\left( -\\frac{\\left(\\ln y_{i} - \\ln x_{i}\\right)^{2}}{2\\sigma_{i}^{2}} \\right) \\right]} \\\\\n= \\frac{\\displaystyle\\prod_{i=1}^{2} \\frac{1}{x_{i}\\,\\sigma_{i}\\,\\sqrt{2\\pi}}}{\\displaystyle\\prod_{i=1}^{2} \\frac{1}{y_{i}\\,\\sigma_{i}\\,\\sqrt{2\\pi}}} \\\\\n= \\frac{\\frac{1}{(x_1 \\sigma_1 \\sqrt{2\\pi})(x_2 \\sigma_2 \\sqrt{2\\pi})}}{\\frac{1}{(y_1 \\sigma_1 \\sqrt{2\\pi})(y_2 \\sigma_2 \\sqrt{2\\pi})}} \\\\\n= \\frac{y_1 y_2 \\sigma_1 \\sigma_2 (2\\pi)}{x_1 x_2 \\sigma_1 \\sigma_2 (2\\pi)} \\\\\n= \\frac{y_1 y_2}{x_1 x_2}\n\\end{align*}\n请注意，未知的尺度参数 $\\sigma_1$ 和 $\\sigma_2$ 已被抵消，因此计算中不需要它们的值。\n\n现在我们可以组合出完整的接受率 $A(y \\mid x)$：\n$$\nA(y \\mid x) = \\frac{\\pi(y)}{\\pi(x)} \\cdot \\frac{q(x \\mid y)}{q(y \\mid x)} = \\exp(\\ell(y) - \\ell(x)) \\cdot \\frac{y_1 y_2}{x_1 x_2}\n$$\n问题要求进行数值稳定的计算，特别禁止单独对 $\\ell(x)$ 和 $\\ell(y)$ 进行指数运算。这些对数后验的大负数值会导致 $\\exp(\\ell(x))$ 和 $\\exp(\\ell(y))$ 在任何标准浮点运算中下溢为零。我们关于 $A(y \\mid x)$ 的表达式通过首先计算差值 $\\ell(y) - \\ell(x)$ 来正确地避免了这个问题。\n\n计算 $\\alpha$ 最稳定的方法是首先计算接受率的对数：\n$$\n\\ln A(y \\mid x) = \\ln\\left( \\exp(\\ell(y) - \\ell(x)) \\cdot \\frac{y_1 y_2}{x_1 x_2} \\right) = (\\ell(y) - \\ell(x)) + \\ln\\left(\\frac{y_1 y_2}{x_1 x_2}\\right)\n$$\n然后，接受概率为 $\\alpha(y \\mid x) = \\min(1, \\exp(\\ln A(y \\mid x)))$。\n\n让我们代入给定的数值：\n当前状态：$x = (x_1, x_2) = (2.0, 0.5)$。\n提议状态：$y = (y_1, y_2) = (2.1, 0.55)$。\n对数后验值：\n$\\ell(x) = -1.357913942 \\times 10^{6}$\n$\\ell(y) = -1.357919942 \\times 10^{6}$\n\n首先，我们计算对数后验的差值：\n$$\n\\ell(y) - \\ell(x) = (-1.357919942 \\times 10^{6}) - (-1.357913942 \\times 10^{6}) = -0.000006000 \\times 10^{6} = -6.0\n$$\n接下来，我们计算 Hastings 修正因子的对数：\n$$\n\\ln\\left(\\frac{y_1 y_2}{x_1 x_2}\\right) = \\ln\\left(\\frac{2.1 \\times 0.55}{2.0 \\times 0.5}\\right) = \\ln\\left(\\frac{1.155}{1.0}\\right) = \\ln(1.155)\n$$\n使用标准计算器，$\\ln(1.155) \\approx 0.1441003433$。\n\n现在我们计算 $\\ln A(y \\mid x)$：\n$$\n\\ln A(y \\mid x) = -6.0 + \\ln(1.155) \\approx -6.0 + 0.1441003433 = -5.8558996567\n$$\n由于 $\\ln A(y \\mid x)$ 是负数，其指数 $A(y \\mid x)$ 将小于 1。因此，接受概率为：\n$$\n\\alpha(y \\mid x) = A(y \\mid x) = \\exp(\\ln A(y \\mid x))\n$$\n$$\n\\alpha(y \\mid x) \\approx \\exp(-5.8558996567) \\approx 0.0028631168\n$$\n问题要求答案四舍五入到六位有效数字。前六位有效数字是 $2, 8, 6, 3, 1, 1$。第七位是 $6$，所以我们将第六位向上舍入。\n$$\n\\alpha(y \\mid x) \\approx 0.00286312\n$$\n这也可以表示为 $2.86312 \\times 10^{-3}$。", "answer": "$$\n\\boxed{0.00286312}\n$$", "id": "3355587"}, {"introduction": "在科学和工程领域，许多模型参数都受到约束，这给 MCMC 方法的应用带来了挑战。本练习将引导您处理一个定义在受限集合上的目标分布，该分布是连续和离散分量的混合体。通过构建一个在边界上使用投影的提议机制，您将深入理解如何为复杂状态空间正确地表述 Metropolis-Hastings 算法，并精确处理边界效应以满足细致平衡条件 [@problem_id:3355557]。", "problem": "考虑一个支撑在凸集 $\\mathcal{C} = [0,1]$ 上的目标概率测度 $\\pi$。该目标是 $(0,1)$ 上的一个连续分量与边界上原子的混合：在 $0$ 处的权重为 $w_{0} = \\frac{1}{10}$，在 $1$ 处的权重为 $w_{1} = \\frac{1}{5}$，以及连续权重 $w_{c} = 1 - w_{0} - w_{1} = \\frac{7}{10}$ 根据概率密度函数 (pdf) $f(x) = 6 x (1 - x)$（对于 $x \\in (0,1)$）分布在 $(0,1)$ 上。因此，$\\pi$ 是 $[0,1]$ 上的一个概率测度，其关于混合控制测度 $\\mu = \\lambda|_{(0,1)} + \\nu_{\\{0,1\\}}$（限制在 $(0,1)$ 上的勒贝格测度 $\\lambda$ 加上 $\\{0,1\\}$ 上的计数测度 $\\nu$）的 Radon-Nikodym 导数由 $\\pi(x) = w_{c} f(x)$（对于 $x \\in (0,1)$），$\\pi(0) = w_{0}$ 和 $\\pi(1) = w_{1}$ 给出。\n\n通过先取一个高斯步 $\\eta \\sim \\mathcal{N}(0, \\sigma^{2})$，然后使用欧几里得投影 $\\Pi_{\\mathcal{C}}$ 投影到约束集上，来构造一个 Metropolis-Hastings (MH) 提议，因此在一维情况下有 $y = \\Pi_{\\mathcal{C}}(x + \\eta) = \\min\\{\\max\\{x + \\eta, 0\\}, 1\\}$。所得的提议分布 $q(\\cdot \\mid x)$ 是 $[0,1]$ 上的一个混合测度，其在 $(0,1)$ 上有连续密度，并在 $\\{0,1\\}$ 处有由越界提议的投影所引致的非零点质量。令 $\\varphi(z) = \\frac{1}{\\sqrt{2 \\pi}} \\exp\\!\\left(-\\frac{z^{2}}{2}\\right)$ 表示标准正态概率密度函数，并令 $\\Phi(z)$ 表示其累积分布函数 (cdf)。对于 $y \\in (0,1)$，有 $q(y \\mid x) = \\frac{1}{\\sigma} \\varphi\\!\\left(\\frac{y - x}{\\sigma}\\right)$，而 $q(0 \\mid x) = \\Phi\\!\\left(\\frac{-x}{\\sigma}\\right)$ 以及 $q(1 \\mid x) = 1 - \\Phi\\!\\left(\\frac{1 - x}{\\sigma}\\right)$。\n\n从马尔可夫链的细致平衡原理出发，推导该投影提议的修正 Metropolis-Hastings 接受概率 $\\alpha(x, y)$，并明确 $(0,1)$ 上的连续密度和边界 $\\{0,1\\}$ 处原子质量的作用。解释控制测度的选择如何决定接受率的形式，并阐明投影引致的边界质量对可逆性的影响。\n\n然后，进行一个具体计算，取 $\\sigma = 0.2$，当前状态 $x = \\frac{1}{2}$ 和一个提议状态 $y = \\frac{1}{10}$（注意两者都位于 $(0,1)$ 内）。计算这次内部移动的 Metropolis-Hastings 接受概率 $\\alpha\\!\\left(\\frac{1}{2}, \\frac{1}{10}\\right)$。将最终数值答案四舍五入到四位有效数字，并报告结果时不带单位。", "solution": "该问题是有效的。它提出了计算统计学领域中的一个良态问题，具体涉及在受约束的混合状态空间上的 Metropolis-Hastings 算法。所有提供的信息在科学上都是合理的、内部一致的，并且足以推导所要求的理论解释和进行具体计算。\n\nMetropolis-Hastings (MH) 算法的核心原理是细致平衡条件，它确保目标概率测度 $\\pi$ 是所构造的马尔可夫链的平稳分布。对于一个具有转移核 $P(x, \\cdot)$ 的链，关于 $\\pi$ 的细致平衡条件陈述为：对于任意两个可测集 $A$ 和 $B$，有 $\\int_A \\pi(dx) P(x, B) = \\int_B \\pi(dy) P(y, A)$。\n\n为了使用密度，我们必须引入一个控制测度 $\\mu$。问题正确地指出了混合目标分布所需的控制测度为 $\\mu = \\lambda|_{(0,1)} + \\nu_{\\{0,1\\}}$，即开区间 $(0,1)$ 上的勒贝格测度与边界点 $\\{0,1\\}$ 上的计数测度之和。$\\pi$ 关于 $\\mu$ 的 Radon-Nikodym 导数，我们遵循问题的约定简记为 $\\pi(x)$，为：\n$$\n\\pi(x) =\n\\begin{cases}\nw_0 = \\frac{1}{10}  \\text{if } x=0 \\\\\nw_1 = \\frac{1}{5}  \\text{if } x=1 \\\\\nw_c f(x) = \\frac{7}{10} \\cdot 6x(1-x) = \\frac{21}{5}x(1-x)  \\text{if } x \\in (0,1)\n\\end{cases}\n$$\nMH 转移核 $P(x, dy)$ 由一个提议步骤和一个接受/拒绝步骤组成。对于 $x \\neq y$，转移核关于 $\\mu$ 的密度为 $p(x, y) = q(y|x) \\alpha(x,y)$，其中 $q(y|x)$ 是提议分布关于 $\\mu$ 的密度，$\\alpha(x,y)$ 是接受概率。细致平衡条件可以用这些密度表示为：\n$$\n\\pi(x) q(y|x) \\alpha(x,y) = \\pi(y) q(x|y) \\alpha(y,x)\n$$\n满足此方程的接受概率的标准解是：\n$$\n\\alpha(x,y) = \\min\\left\\{1, \\frac{\\pi(y) q(x|y)}{\\pi(x) q(y|x)}\\right\\}\n$$\n这个通用公式对任何状态空间（连续、离散或混合）都有效，只要密度 $\\pi(\\cdot)$ 和 $q(\\cdot|\\cdot)$ 是关于同一个控制测度 $\\mu$ 取的。提议密度 $q(y|x)$ 关于 $\\mu$ 的形式如下：\n$$\nq(y|x) =\n\\begin{cases}\nq(0|x) = \\Phi\\left(\\frac{-x}{\\sigma}\\right)  \\text{if } y=0 \\\\\nq(1|x) = 1 - \\Phi\\left(\\frac{1-x}{\\sigma}\\right)  \\text{if } y=1 \\\\\n\\frac{1}{\\sigma}\\varphi\\left(\\frac{y-x}{\\sigma}\\right)  \\text{if } y \\in (0,1)\n\\end{cases}\n$$\n控制测度 $\\mu$ 的作用是提供一个统一的框架来处理状态空间的连续和离散部分。通过定义相对于 $\\mu$ 的密度，MH 接受率保持其标准形式，正确地平衡了连续状态和离散状态之间的概率流。投影引致的边界质量被项 $q(0|x)$ 和 $q(1|x)$ 明确地捕捉，它们表示从 $x$ 出发的一个提议高斯步落在区间 $[0,1]$ 之外并被投影到相应边界点的概率。这些项对于维持可逆性至关重要。例如，对于从 $x \\in (0,1)$ 到边界点 $y=0$ 的移动，接受率正确地包含了离散质量 $\\pi(0)$ 和积分提议概率 $q(0|x)$。\n\n我们被要求计算从 $x = \\frac{1}{2}$ 到 $y = \\frac{1}{10}$ 的特定移动的接受概率。由于 $x$ 和 $y$ 都在区间 $(0,1)$ 的内部，我们处于连续到连续转移的情况。\n对于 $x, y \\in (0,1)$，相关密度为：\n$\\pi(x) = w_c f(x)$\n$\\pi(y) = w_c f(y)$\n$q(y|x) = \\frac{1}{\\sigma}\\varphi\\left(\\frac{y-x}{\\sigma}\\right)$\n$q(x|y) = \\frac{1}{\\sigma}\\varphi\\left(\\frac{x-y}{\\sigma}\\right)$\n\n接受率 $R(x,y)$ 是：\n$$\nR(x,y) = \\frac{\\pi(y) q(x|y)}{\\pi(x) q(y|x)} = \\frac{w_c f(y) \\cdot \\frac{1}{\\sigma}\\varphi\\left(\\frac{x-y}{\\sigma}\\right)}{w_c f(x) \\cdot \\frac{1}{\\sigma}\\varphi\\left(\\frac{y-x}{\\sigma}\\right)}\n$$\n标准正态 pdf $\\varphi(z)$ 是一个偶函数，意味着 $\\varphi(z) = \\varphi(-z)$。因此，$\\varphi\\left(\\frac{x-y}{\\sigma}\\right) = \\varphi\\left(-\\frac{y-x}{\\sigma}\\right) = \\varphi\\left(\\frac{y-x}{\\sigma}\\right)$。\n提议比率简化为 $1$：\n$$\n\\frac{q(x|y)}{q(y|x)} = 1\n$$\n这是对称提议的一个特征，它将 Metropolis-Hastings 算法简化为对此类移动更简单的 Metropolis 算法。接受率变为：\n$$\nR(x,y) = \\frac{f(y)}{f(x)}\n$$\n于是接受概率是：\n$$\n\\alpha(x,y) = \\min\\left\\{1, \\frac{f(y)}{f(x)}\\right\\}\n$$\n现在我们用给定的值进行具体计算：\n当前状态：$x = \\frac{1}{2} = 0.5$\n提议状态：$y = \\frac{1}{10} = 0.1$\n密度函数是 $f(z) = 6z(1-z)$。\n\n首先，我们计算 $f(x)$：\n$$\nf\\left(\\frac{1}{2}\\right) = 6 \\cdot \\frac{1}{2} \\cdot \\left(1 - \\frac{1}{2}\\right) = 6 \\cdot \\frac{1}{2} \\cdot \\frac{1}{2} = \\frac{6}{4} = \\frac{3}{2} = 1.5\n$$\n接下来，我们计算 $f(y)$：\n$$\nf\\left(\\frac{1}{10}\\right) = 6 \\cdot \\frac{1}{10} \\cdot \\left(1 - \\frac{1}{10}\\right) = 6 \\cdot \\frac{1}{10} \\cdot \\frac{9}{10} = \\frac{54}{100} = 0.54\n$$\n该比率为：\n$$\n\\frac{f(y)}{f(x)} = \\frac{0.54}{1.5} = \\frac{54/100}{3/2} = \\frac{54}{100} \\cdot \\frac{2}{3} = \\frac{18}{50} = \\frac{9}{25} = 0.36\n$$\n最后，接受概率是：\n$$\n\\alpha\\left(\\frac{1}{2}, \\frac{1}{10}\\right) = \\min\\left\\{1, 0.36\\right\\} = 0.36\n$$\n问题要求答案四舍五入到四位有效数字，即 $0.3600$。", "answer": "$$\n\\boxed{0.3600}\n$$", "id": "3355557"}, {"introduction": "现代统计学中的一个常见挑战是处理具有难解（intractable）似然函数的模型。本练习介绍了一种强大的解决方案：伪边缘 Metropolis-Hastings 算法，它通过使用似然函数的无偏估计量来规避这一难题。您将推导其期望接受概率，并分析如何通过在辅助变量中引入相关性来显著提升算法的计算效率，这是优化此类高级 MCMC 方法的关键技巧 [@problem_id:3355594]。", "problem": "考虑一个 Metropolis–Hastings 算法，其目标后验密度为 $\\mathbb{R}^{d}$ 上的 $\\pi(x)$，该密度在相差一个归一化常数的情况下已知，其中 $\\pi(x) \\propto \\pi_{0}(x) L(x)$，$\\pi_{0}(x)$ 是先验， $L(x)$ 是似然。为避免精确计算 $L(x)$，使用伪边缘构造，引入辅助随机变量 $U \\sim g(u)$ 和一个非负无偏似然估计量 $\\widehat{L}(x, U)$，满足对所有 $x$ 都有 $\\mathbb{E}_{U \\sim g}[\\widehat{L}(x, U)] = L(x)$。假设采用乘性噪声模型\n$$\n\\widehat{L}(x, U) \\;=\\; L(x)\\,\\exp\\!\\big(\\epsilon\\big), \\quad \\epsilon \\sim \\mathcal{N}\\!\\big(-\\sigma^{2}/2,\\,\\sigma^{2}\\big),\n$$\n其中 $\\sigma^{2} \\in (0,\\infty)$ 不依赖于 $x$。在状态 $(x, U)$，使用对称随机游走提议 $y \\sim q(x, \\cdot)$（使得 $q(x, y) = q(y, x)$）来提议一个新参数，并从一个马尔可夫转移核 $K_{\\rho}(U, \\cdot)$ 中提议一个新的辅助变量 $U'$，该核保持 $g$ 不变，并在当前和提议的对数噪声之间引入相关性 $\\rho \\in [0,1)$：\n$$\n\\epsilon \\,=\\, \\ln\\!\\big(\\widehat{L}(x, U)/L(x)\\big), \\quad \\epsilon' \\,=\\, \\ln\\!\\big(\\widehat{L}(y, U')/L(y)\\big), \\quad \\text{其中 } \\begin{pmatrix}\\epsilon \\\\ \\epsilon'\\end{pmatrix} \\sim \\mathcal{N}\\!\\left(\\begin{pmatrix}-\\sigma^{2}/2 \\\\ -\\sigma^{2}/2\\end{pmatrix}, \\begin{pmatrix}\\sigma^{2}  \\rho\\,\\sigma^{2} \\\\ \\rho\\,\\sigma^{2}  \\sigma^{2}\\end{pmatrix}\\right).\n$$\n在扩展空间上的 Metropolis–Hastings 接受概率为\n$$\n\\alpha\\big((x,U),(y,U')\\big) \\;=\\; \\min\\!\\left\\{1,\\; \\frac{\\pi_{0}(y)\\,\\widehat{L}(y, U')\\,q(y,x)}{\\pi_{0}(x)\\,\\widehat{L}(x, U)\\,q(x,y)} \\right\\}.\n$$\n定义精确对数 Metropolis 比率\n$$\n\\Delta \\;=\\; \\log\\!\\big(\\pi(y)\\,q(y,x)\\big) \\,-\\, \\log\\!\\big(\\pi(x)\\,q(x,y)\\big),\n$$\n并注意，根据 $q$ 的对称性，该式简化为 $\\Delta = \\log \\pi(y) - \\log \\pi(x)$。令 $\\Phi(\\cdot)$ 表示标准正态分布的累积分布函数。\n\n从 Metropolis–Hastings 接受概率、无偏估计和多元正态分布性质的基本定义出发，推导条件期望接受概率\n$$\n\\mathbb{E}\\!\\left[\\, \\alpha\\big((x,U),(y,U')\\big) \\,\\middle|\\, x,y \\,\\right]\n$$\n的一个闭式表达式，该表达式是 $\\Delta$、$\\sigma^{2}$ 和 $\\rho$ 的函数，且仅用 $\\Phi(\\cdot)$ 表示。你的推导过程应通过确定对数噪声差的分布并精确计算所得的期望来进行。在你的解释中，分析增大 $\\rho$ 如何改变对数比率噪声的方差，并从而影响期望接受概率，并论证为何使用保持 $g$ 不变的 $K_{\\rho}$ 能保证 $x$ 的边缘平稳分布的正确性。\n\n你的最终答案应提供一个关于 $\\mathbb{E}\\!\\left[\\, \\alpha\\big((x,U),(y,U')\\big) \\,\\middle|\\, x,y \\,\\right]$ 的单一闭式解析表达式，用 $\\Delta$、$\\sigma^{2}$、$\\rho$ 和 $\\Phi(\\cdot)$ 表示。最终答案中不应包含任何不等式或极限。不需要进行数值计算。", "solution": "问题要求在一个伪边缘 Metropolis-Hastings 算法中，推导条件期望接受概率 $\\mathbb{E}\\!\\left[\\, \\alpha\\big((x,U),(y,U')\\big) \\,\\middle|\\, x,y \\,\\right]$。\n\n首先，我们验证问题陈述的有效性。\n\n### 第一步：提取已知条件\n- 目标后验密度：$\\mathbb{R}^{d}$ 上的 $\\pi(x) \\propto \\pi_{0}(x) L(x)$。\n- 无偏似然估计量：$\\widehat{L}(x, U)$，其中 $U \\sim g(u)$ 且 $\\mathbb{E}_{U \\sim g}[\\widehat{L}(x, U)] = L(x)$。\n- 乘性噪声模型：$\\widehat{L}(x, U) = L(x)\\,\\exp(\\epsilon)$，其中 $\\epsilon \\sim \\mathcal{N}(-\\sigma^{2}/2,\\,\\sigma^{2})$，$\\sigma^{2} \\in (0,\\infty)$。\n- 参数提议：$y \\sim q(x, \\cdot)$，提议核 $q(x, y) = q(y, x)$ 对称。\n- 辅助变量提议：$U' \\sim K_{\\rho}(U, \\cdot)$，其中 $K_{\\rho}$ 保持 $g$ 不变。\n- 相关的对数噪声：$\\epsilon = \\ln(\\widehat{L}(x, U)/L(x))$ 和 $\\epsilon' = \\ln(\\widehat{L}(y, U')/L(y))$ 服从联合正态分布：\n$$\n\\begin{pmatrix}\\epsilon \\\\ \\epsilon'\\end{pmatrix} \\sim \\mathcal{N}\\!\\left(\\begin{pmatrix}-\\sigma^{2}/2 \\\\ -\\sigma^{2}/2\\end{pmatrix}, \\begin{pmatrix}\\sigma^{2}  \\rho\\,\\sigma^{2} \\\\ \\rho\\,\\sigma^{2}  \\sigma^{2}\\end{pmatrix}\\right), \\quad \\rho \\in [0,1).\n$$\n- Metropolis-Hastings 接受概率：$\\alpha\\big((x,U),(y,U')\\big) = \\min\\!\\left\\{1,\\; \\frac{\\pi_{0}(y)\\,\\widehat{L}(y, U')\\,q(y,x)}{\\pi_{0}(x)\\,\\widehat{L}(x, U)\\,q(x,y)} \\right\\}$。\n- 精确对数 Metropolis 比率：$\\Delta = \\log(\\pi(y)\\,q(y,x)) - \\log(\\pi(x)\\,q(x,y))$，由于 $q$ 的对称性，简化为 $\\Delta = \\log \\pi(y) - \\log \\pi(x)$。\n- 符号：$\\Phi(\\cdot)$ 表示标准正态分布的累积分布函数。\n\n### 第二步：使用提取的已知条件进行验证\n该问题有科学依据，描述了一种成熟的统计方法（带有相关噪声的伪边缘 Metropolis-Hastings）。所有术语都得到了精确定义，并且设定是内部一致的。对数噪声 $\\epsilon$ 的均值被指定为 $-\\sigma^2/2$，这正确地确保了似然估计量是无偏的：$\\mathbb{E}[\\exp(\\epsilon)] = \\exp(-\\sigma^2/2 + (1/2)\\text{Var}(\\epsilon)) = \\exp(-\\sigma^2/2 + \\sigma^2/2) = 1$。该问题是良定的，要求一个特定的、可推导的量。设定没有矛盾、并非无关紧要，也不依赖于非科学的主张。\n\n### 第三步：结论与行动\n问题是有效的。我们开始进行求解。\n\n### 期望接受概率的推导\n\n接受概率由下式给出\n$$\n\\alpha\\big((x,U),(y,U')\\big) = \\min\\!\\left\\{1, R \\right\\}, \\quad \\text{其中} \\quad R = \\frac{\\pi_{0}(y)\\,\\widehat{L}(y, U')\\,q(y,x)}{\\pi_{0}(x)\\,\\widehat{L}(x, U)\\,q(x,y)}.\n$$\n我们将给定的定义代入比率 $R$ 中。利用提议的对称性，$q(x,y) = q(y,x)$，这些项相互抵消。我们也代入似然估计量的乘性噪声模型，$\\widehat{L}(x,U) = L(x) \\exp(\\epsilon)$ 和 $\\widehat{L}(y,U') = L(y) \\exp(\\epsilon')$。\n$$\nR = \\frac{\\pi_{0}(y)\\,L(y)\\,\\exp(\\epsilon')}{\\pi_{0}(x)\\,L(x)\\,\\exp(\\epsilon)}.\n$$\n由于目标后验是 $\\pi(x) \\propto \\pi_0(x) L(x)$，我们有 $\\frac{\\pi_0(y)L(y)}{\\pi_0(x)L(x)} = \\frac{\\pi(y)}{\\pi(x)}$。该比率变为\n$$\nR = \\frac{\\pi(y)}{\\pi(x)}\\exp(\\epsilon' - \\epsilon) = \\exp(\\log\\pi(y) - \\log\\pi(x) + \\epsilon' - \\epsilon).\n$$\n使用精确对数 Metropolis 比率的定义，$\\Delta = \\log\\pi(y) - \\log\\pi(x)$，我们可以写出\n$$\nR = \\exp(\\Delta + \\epsilon' - \\epsilon).\n$$\n因此，接受概率是 $\\Delta$ 和对数噪声之差 $Z = \\epsilon' - \\epsilon$ 的函数：\n$$\n\\alpha = \\min\\{1, \\exp(\\Delta + Z)\\}.\n$$\n为了找到条件期望 $\\mathbb{E}[\\alpha | x, y]$，我们必须对随机变量 $Z$ 的分布进行平均。由于 $x$ 和 $y$ 是固定的，$\\Delta$ 是一个常数。该期望是关于 $(U, U')$ 的联合分布计算的，该联合分布导出了 $(\\epsilon, \\epsilon')$ 的指定联合分布。\n\n变量 $Z$ 是两个联合正态随机变量的差，因此它也服从正态分布。我们求其均值和方差：\n$$\n\\mathbb{E}[Z] = \\mathbb{E}[\\epsilon' - \\epsilon] = \\mathbb{E}[\\epsilon'] - \\mathbb{E}[\\epsilon] = \\left(-\\frac{\\sigma^2}{2}\\right) - \\left(-\\frac{\\sigma^2}{2}\\right) = 0.\n$$\n$$\n\\text{Var}(Z) = \\text{Var}(\\epsilon' - \\epsilon) = \\text{Var}(\\epsilon') + \\text{Var}(\\epsilon) - 2\\text{Cov}(\\epsilon, \\epsilon') = \\sigma^2 + \\sigma^2 - 2(\\rho\\sigma^2) = 2\\sigma^2(1-\\rho).\n$$\n令 $\\sigma_Z^2 = 2\\sigma^2(1-\\rho)$。因此，$Z \\sim \\mathcal{N}(0, \\sigma_Z^2)$。令 $p(z)$ 为 $Z$ 的概率密度函数。所求的期望为\n$$\n\\mathbb{E}[\\alpha | x, y] = \\int_{-\\infty}^{\\infty} \\min\\{1, \\exp(\\Delta + z)\\} p(z) dz.\n$$\n函数 $\\min\\{1, \\exp(\\Delta + z)\\}$ 在 $\\Delta+z \\le 0$ (即 $z \\le -\\Delta$) 时等于 $\\exp(\\Delta+z)$，在 $\\Delta+z > 0$ (即 $z > -\\Delta$) 时等于 $1$。我们在 $z = -\\Delta$ 处拆分积分：\n$$\n\\mathbb{E}[\\alpha | x, y] = \\int_{-\\infty}^{-\\Delta} \\exp(\\Delta + z) p(z) dz + \\int_{-\\Delta}^{\\infty} 1 \\cdot p(z) dz.\n$$\n第二个积分是概率 $P(Z > -\\Delta)$。由于 $Z \\sim \\mathcal{N}(0, \\sigma_Z^2)$，标准化变量 $S = Z/\\sigma_Z$ 服从 $\\mathcal{N}(0,1)$。\n$$\n\\int_{-\\Delta}^{\\infty} p(z) dz = P(Z > -\\Delta) = P\\left(\\frac{Z}{\\sigma_Z} > -\\frac{\\Delta}{\\sigma_Z}\\right) = 1 - \\Phi\\left(-\\frac{\\Delta}{\\sigma_Z}\\right) = \\Phi\\left(\\frac{\\Delta}{\\sigma_Z}\\right).\n$$\n第一个积分是\n$$\nI_1 = \\int_{-\\infty}^{-\\Delta} \\exp(\\Delta + z) \\frac{1}{\\sqrt{2\\pi\\sigma_Z^2}} \\exp\\left(-\\frac{z^2}{2\\sigma_Z^2}\\right) dz.\n$$\n我们合并指数项并在指数上配方：\n$$\n\\Delta + z - \\frac{z^2}{2\\sigma_Z^2} = \\Delta - \\frac{1}{2\\sigma_Z^2}(z^2 - 2\\sigma_Z^2 z) = \\Delta - \\frac{1}{2\\sigma_Z^2}((z - \\sigma_Z^2)^2 - (\\sigma_Z^2)^2) = \\Delta + \\frac{\\sigma_Z^2}{2} - \\frac{(z-\\sigma_Z^2)^2}{2\\sigma_Z^2}.\n$$\n将此代回积分 $I_1$：\n$$\nI_1 = \\int_{-\\infty}^{-\\Delta} \\exp\\left(\\Delta + \\frac{\\sigma_Z^2}{2}\\right) \\frac{1}{\\sqrt{2\\pi\\sigma_Z^2}} \\exp\\left(-\\frac{(z-\\sigma_Z^2)^2}{2\\sigma_Z^2}\\right) dz.\n$$\n$$\nI_1 = \\exp\\left(\\Delta + \\frac{\\sigma_Z^2}{2}\\right) \\int_{-\\infty}^{-\\Delta} \\frac{1}{\\sqrt{2\\pi\\sigma_Z^2}} \\exp\\left(-\\frac{(z-\\sigma_Z^2)^2}{2\\sigma_Z^2}\\right) dz.\n$$\n该积分是均值为 $\\sigma_Z^2$、方差为 $\\sigma_Z^2$ 的正态分布在 $-\\Delta$ 处的累积分布函数值。设 $W \\sim \\mathcal{N}(\\sigma_Z^2, \\sigma_Z^2)$。该积分为 $P(W \\le -\\Delta)$。\n$$\nP(W \\le -\\Delta) = P\\left(\\frac{W-\\sigma_Z^2}{\\sigma_Z} \\le \\frac{-\\Delta-\\sigma_Z^2}{\\sigma_Z}\\right) = \\Phi\\left(-\\frac{\\Delta+\\sigma_Z^2}{\\sigma_Z}\\right).\n$$\n因此，$I_1 = \\exp\\left(\\Delta + \\frac{\\sigma_Z^2}{2}\\right) \\Phi\\left(-\\frac{\\Delta+\\sigma_Z^2}{\\sigma_Z}\\right)$。\n将两部分结合起来得到期望接受概率：\n$$\n\\mathbb{E}[\\alpha | x, y] = \\exp\\left(\\Delta + \\frac{\\sigma_Z^2}{2}\\right) \\Phi\\left(-\\frac{\\Delta+\\sigma_Z^2}{\\sigma_Z}\\right) + \\Phi\\left(\\frac{\\Delta}{\\sigma_Z}\\right).\n$$\n代入 $\\sigma_Z^2 = 2\\sigma^2(1-\\rho)$ 和 $\\sigma_Z = \\sqrt{2\\sigma^2(1-\\rho)}$，我们得到最终表达式：\n$$\n\\mathbb{E}[\\alpha | x, y] = \\exp\\left(\\Delta + \\sigma^2(1-\\rho)\\right) \\Phi\\left(-\\frac{\\Delta + 2\\sigma^2(1-\\rho)}{\\sqrt{2\\sigma^2(1-\\rho)}}\\right) + \\Phi\\left(\\frac{\\Delta}{\\sqrt{2\\sigma^2(1-\\rho)}}\\right).\n$$\n\n### 参数分析\n- **$\\rho$ 对噪声方差的影响：** 对数比率噪声的方差 $\\text{Var}(Z) = 2\\sigma^2(1-\\rho)$ 是相关性 $\\rho$ 的递减函数。当 $\\rho$ 从 $0$ 增加到 $1$ 时，方差从 $2\\sigma^2$ 减小到 $0$。更高的相关性 $\\rho$ 意味着噪声项 $\\epsilon$ 和 $\\epsilon'$ 更相似，使其差 $Z$ 的变异性更小。\n\n- **$\\rho$ 对期望接受概率的影响：** 噪声项 $Z$ 给接受比率引入了额外的随机性，与能够获取精确似然的算法（其中 $Z=0$）相比，这通常会通过降低平均接受概率来降低 MCMC 采样器的性能。通过增加 $\\rho$，我们减小了 $Z$ 的方差，从而使伪边缘算法的行为更像精确算法。在极限 $\\rho \\to 1$ 的情况下，$\\sigma_Z^2 \\to 0$，且 $Z$ 依分布收敛于 $0$。期望接受概率收敛于 $\\mathbb{E}[\\min\\{1, \\exp(\\Delta)\\}] = \\min\\{1, \\exp(\\Delta)\\}$，这正是精确 Metropolis-Hastings 算法的接受概率。因此，增加 $\\rho$ 会提高期望接受概率，这通常会提高采样器的统计效率。\n\n- **$g$ 在 $K_\\rho$ 下的不变性：** 该算法的正确性依赖于一个事实，即联合密度 $\\pi_{ext}(x, u) \\propto \\pi_0(x) \\widehat{L}(x, u) g(u)$ 是扩展空间 $(X, U)$ 上马尔可夫链的平稳分布。如果满足细致平衡条件，Metropolis-Hastings 算法能保证这一点。完整的接受比率需要比较前向提议密度 $Q((x,U), (y,U')) = q(x,y)K_\\rho(U,U')$ 与反向提议密度 $Q((y,U'), (x,U)) = q(y,x)K_\\rho(U',U)$。针对扩展目标 $\\pi_{ext}(x,u)$ 的 M-H 法则中的比率包含项 $\\frac{g(U)K_\\rho(U,U')}{g(U')K_\\rho(U',U)}$。$K_\\rho$ 保持 $g$ 不变的条件正是细致平衡条件 $g(U)K_\\rho(U,U') = g(U')K_\\rho(U',U)$。这使得辅助变量的提议密度之比为 1，从而将接受概率简化为问题陈述中给出的形式。这保证了 $\\pi_{ext}$ 是平稳分布。因此，由 $\\int \\pi_{ext}(x, u) du = \\int \\pi_0(x) \\widehat{L}(x,u) g(u) du = \\pi_0(x) \\mathbb{E}[\\widehat{L}(x,U)] = \\pi_0(x) L(x) \\propto \\pi(x)$ 给出的 $x$ 的边缘分布，就是正确的目标后验。", "answer": "$$\n\\boxed{\\exp\\left(\\Delta + \\sigma^{2}(1-\\rho)\\right) \\Phi\\left(-\\frac{\\Delta + 2\\sigma^{2}(1-\\rho)}{\\sqrt{2\\sigma^{2}(1-\\rho)}}\\right) + \\Phi\\left(\\frac{\\Delta}{\\sqrt{2\\sigma^{2}(1-\\rho)}}\\right)}\n$$", "id": "3355594"}]}