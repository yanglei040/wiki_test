{"hands_on_practices": [{"introduction": "本章的练习旨在将理论付诸实践，加深您对布朗桥的理解。我们将从最基本的练习开始：推导并实现一个精确的采样器，用于在特定时间点上对布朗桥进行采样。这项练习将巩固您对布朗桥作为条件高斯过程的基本认识，并为您掌握更复杂的布朗桥模拟技术奠定基础 [@problem_id:3350886]。", "problem": "考虑一个标准布朗运动 $W_t$，$t \\in [0,1]$，其中 $W_0 = 0$，均值为零，协方差函数为 $\\mathbb{E}[W_s W_t] = \\min(s,t)$。将区间 $[0,1]$ 上的布朗桥 $B_t$ 定义为在事件 $W_1 = 0$ 的条件下从 $W_t$ 得到的随机过程，因此 $B_0 = 0$ 且 $B_1 = 0$。从高斯过程的基本性质以及 $(W_t, W_1)$ 的联合高斯分布出发，使用条件高斯分布推导固定 $t \\in (0,1)$ 时 $B_t$ 的分布，包括其均值和方差。推导出分布后，为固定 $t$ 处的 $B_t$ 设计一个精确采样方法，该方法仅依赖于条件高斯表示，不使用任何渐近或近似论证。\n\n您的程序必须实现您推导出的精确采样器，然后对下面指定的每个测试用例执行以下步骤：\n1. 使用推导出的条件高斯分布生成 $n$ 个 $B_t$ 的独立样本。\n2. 计算样本均值 $\\hat{m}(t)$ 和样本方差 $\\hat{v}(t)$（按规定使用除数 $n$）。\n3. 根据您的推导计算 $B_t$ 的理论均值 $m(t)$ 和方差 $v(t)$。\n4. 对每个测试用例，按以下顺序输出两个值：\n   - 样本均值 $\\hat{m}(t)$。\n   - 差值 $\\hat{v}(t) - v(t)$。\n\n测试套件包含四组参数 $(t, n, \\text{seed})$，必须严格按照给定值使用：\n- 情况 1：$t = 0.5$, $n = 20000$, $\\text{seed} = 1234567$。\n- 情况 2：$t = 0.01$, $n = 50000$, $\\text{seed} = 202311$。\n- 情况 3：$t = 0.99$, $n = 50000$, $\\text{seed} = 314159$。\n- 情况 4：$t = 0.2$, $n = 30000$, $\\text{seed} = 271828$。\n\n您的程序应生成单行输出，其中包含按上述测试用例和值的顺序排列的结果，结果为用方括号括起来的逗号分隔列表。例如，输出格式必须严格符合\n$[\\hat{m}(t_1),\\hat{v}(t_1)-v(t_1),\\hat{m}(t_2),\\hat{v}(t_2)-v(t_2),\\hat{m}(t_3),\\hat{v}(t_3)-v(t_3),\\hat{m}(t_4),\\hat{v}(t_4)-v(t_4)]$ 的形式。", "solution": "该问题要求推导在固定时间 $t \\in (0,1)$ 处布朗桥 $B_t$ 的分布，并基于此推导设计一个精确采样算法。\n\n### 第1部分：布朗桥分布的推导\n\n一个标准布朗运动 $W_t$（$t \\in [0,1]$）是一个高斯过程，满足 $W_0=0$，均值函数为 $\\mathbb{E}[W_t] = 0$，协方差函数为 $\\mathbb{E}[W_s W_t] = \\min(s,t)$。布朗桥 $B_t$ 定义为在事件 $W_1=0$ 条件下的过程 $W_t$。为了求出固定 $t \\in (0,1)$ 时 $B_t$ 的分布，我们使用条件高斯分布的性质。\n\n考虑随机变量 $W_t$ 和 $W_1$ 的联合分布。由于 $W_t$ 是一个高斯过程，随机向量 $\\mathbf{X} = \\begin{pmatrix} W_t \\\\ W_1 \\end{pmatrix}$ 服从多元正态分布。\n\n均值向量 $\\boldsymbol{\\mu}$ 由下式给出：\n$$\n\\boldsymbol{\\mu} = \\mathbb{E}[\\mathbf{X}] = \\begin{pmatrix} \\mathbb{E}[W_t] \\\\ \\mathbb{E}[W_1] \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ 0 \\end{pmatrix}\n$$\n\n协方差矩阵 $\\boldsymbol{\\Sigma}$ 由下式给出：\n$$\n\\boldsymbol{\\Sigma} = \\begin{pmatrix} \\mathbb{E}[W_t^2]  \\mathbb{E}[W_t W_1] \\\\ \\mathbb{E}[W_1 W_t]  \\mathbb{E}[W_1^2] \\end{pmatrix}\n$$\n使用协方差函数 $\\mathbb{E}[W_s W_u] = \\min(s,u)$，我们计算 $\\boldsymbol{\\Sigma}$ 的元素：\n- $\\mathbb{E}[W_t^2] = \\min(t,t) = t$\n- $\\mathbb{E}[W_1^2] = \\min(1,1) = 1$\n- $\\mathbb{E}[W_t W_1] = \\min(t,1) = t$ (因为 $t \\in [0,1]$)\n\n因此，协方差矩阵为：\n$$\n\\boldsymbol{\\Sigma} = \\begin{pmatrix} t  t \\\\ t  1 \\end{pmatrix}\n$$\n所以，$\\begin{pmatrix} W_t \\\\ W_1 \\end{pmatrix} \\sim \\mathcal{N}\\left(\\begin{pmatrix} 0 \\\\ 0 \\end{pmatrix}, \\begin{pmatrix} t  t \\\\ t  1 \\end{pmatrix}\\right)$。\n\n我们想要求 $B_t$ 的分布，也就是在 $W_1=0$ 条件下 $W_t$ 的分布。对于一个一般的已分块高斯向量 $\\begin{pmatrix} \\mathbf{X}_1 \\\\ \\mathbf{X}_2 \\end{pmatrix} \\sim \\mathcal{N}\\left(\\begin{pmatrix} \\boldsymbol{\\mu}_1 \\\\ \\boldsymbol{\\mu}_2 \\end{pmatrix}, \\begin{pmatrix} \\boldsymbol{\\Sigma}_{11}  \\boldsymbol{\\Sigma}_{12} \\\\ \\boldsymbol{\\Sigma}_{21}  \\boldsymbol{\\Sigma}_{22} \\end{pmatrix}\\right)$，在给定 $\\mathbf{X}_2 = \\mathbf{x}_2$ 的条件下，$\\mathbf{X}_1$ 的条件分布也是高斯分布，其均值和协方差为：\n$$\n\\mathbb{E}[\\mathbf{X}_1 | \\mathbf{X}_2 = \\mathbf{x}_2] = \\boldsymbol{\\mu}_1 + \\boldsymbol{\\Sigma}_{12} \\boldsymbol{\\Sigma}_{22}^{-1} (\\mathbf{x}_2 - \\boldsymbol{\\mu}_2)\n$$\n$$\n\\text{Cov}(\\mathbf{X}_1 | \\mathbf{X}_2 = \\mathbf{x}_2) = \\boldsymbol{\\Sigma}_{11} - \\boldsymbol{\\Sigma}_{12} \\boldsymbol{\\Sigma}_{22}^{-1} \\boldsymbol{\\Sigma}_{21}\n$$\n\n在我们的具体情况中，$\\mathbf{X}_1 = W_t$，$\\mathbf{X}_2 = W_1$，且 $\\mathbf{x}_2=0$。标量分量为 $\\boldsymbol{\\mu}_1=0$，$\\boldsymbol{\\mu}_2=0$，$\\boldsymbol{\\Sigma}_{11}=t$，$\\boldsymbol{\\Sigma}_{12}=t$，$\\boldsymbol{\\Sigma}_{21}=t$，以及 $\\boldsymbol{\\Sigma}_{22}=1$。逆矩阵 $\\boldsymbol{\\Sigma}_{22}^{-1}$ 就是 $1^{-1}=1$。\n\n$B_t$ 的理论均值，记为 $m(t)$，是：\n$$\nm(t) = \\mathbb{E}[W_t | W_1 = 0] = 0 + t \\cdot 1^{-1} \\cdot (0 - 0) = 0\n$$\n\n$B_t$ 的理论方差，记为 $v(t)$，是：\n$$\nv(t) = \\text{Var}(W_t | W_1 = 0) = t - t \\cdot 1^{-1} \\cdot t = t - t^2 = t(1-t)\n$$\n因此，在固定时间 $t$ 处，布朗桥 $B_t$ 的分布是均值为 $0$、方差为 $t(1-t)$ 的正态分布：\n$$\nB_t \\sim \\mathcal{N}(0, t(1-t))\n$$\n\n### 第2部分：精确采样方法设计\n\n对于一个高斯随机变量 $X \\sim \\mathcal{N}(\\mu, \\sigma^2)$，可以从一个标准正态随机变量 $Z \\sim \\mathcal{N}(0,1)$ 构建一个精确采样器。其变换为 $X = \\mu + \\sigma Z$。\n\n基于推导出的分布 $B_t \\sim \\mathcal{N}(0, t(1-t))$，我们有 $\\mu=0$ 且 $\\sigma^2 = t(1-t)$。标准差为 $\\sigma = \\sqrt{t(1-t)}$。因此，可以使用以下公式生成 $B_t$ 的一个精确样本：\n$$\nB_t = \\sqrt{t(1-t)} \\cdot Z, \\quad \\text{其中 } Z \\sim \\mathcal{N}(0,1)\n$$\n该方法是精确的，因为它依赖于直接变换，不涉及任何近似或渐近假设，前提是有一个标准正态分布的采样器可用。\n\n### 第3部分：算法实现\n\n程序将对每个测试用例 $(t, n, \\text{seed})$ 实现以下算法：\n1.  为保证可复现性，将随机数生成器的种子设置为给定的 `seed`。\n2.  计算理论均值 $m(t) = 0$ 和理论方差 $v(t) = t(1-t)$。\n3.  从标准正态分布 $\\mathcal{N}(0,1)$ 中生成 $n$ 个独立样本 $Z_1, Z_2, \\dots, Z_n$。\n4.  使用公式 $b_i = \\sqrt{t(1-t)} \\cdot Z_i$ 变换这些样本，以获得 $n$ 个布朗桥样本 $b_i$。\n5.  计算样本均值 $\\hat{m}(t) = \\frac{1}{n} \\sum_{i=1}^n b_i$。\n6.  计算样本方差 $\\hat{v}(t) = \\frac{1}{n} \\sum_{i=1}^n (b_i - \\hat{m}(t))^2$，按规定使用除数 $n$。\n7.  计算所需的两个输出值：样本均值 $\\hat{m}(t)$ 以及样本方差与理论方差之差 $\\hat{v}(t) - v(t)$。\n8.  从所有测试用例中收集这些值，并将其格式化为单行输出。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Derives and implements an exact sampler for a Brownian Bridge B_t\n    at a fixed time t, based on its conditional Gaussian distribution.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (t, n, seed)\n        (0.5, 20000, 1234567),\n        (0.01, 50000, 202311),\n        (0.99, 50000, 314159),\n        (0.2, 30000, 271828),\n    ]\n\n    results = []\n    for t, n, seed in test_cases:\n        # Set seed for reproducibility.\n        rng = np.random.default_rng(seed)\n\n        # Theoretical properties of B_t from derivation B_t ~ N(0, t(1-t)).\n        # Theoretical mean m(t) = 0.\n        # Theoretical variance v(t) = t * (1 - t).\n        theoretical_variance = t * (1.0 - t)\n\n        # Generate n samples from a standard normal distribution Z ~ N(0,1).\n        z_samples = rng.normal(size=n)\n        \n        # Transform standard normal samples to samples of B_t.\n        # B_t = sqrt(t*(1-t)) * Z\n        std_dev = np.sqrt(theoretical_variance)\n        b_t_samples = std_dev * z_samples\n\n        # Compute the sample mean, m_hat(t).\n        sample_mean = np.mean(b_t_samples)\n\n        # Compute the sample variance, v_hat(t).\n        # The problem specifies using the population variance with divisor n.\n        # numpy.var() uses ddof=0 by default, which corresponds to a divisor of n.\n        sample_variance = np.var(b_t_samples)\n\n        # Calculate the difference between sample and theoretical variance.\n        variance_diff = sample_variance - theoretical_variance\n\n        # Append results for this test case.\n        results.append(sample_mean)\n        results.append(variance_diff)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3350886"}, {"introduction": "在掌握了单点采样之后，我们将挑战升级，转向整个路径的属性。此练习将探讨布朗桥最大值的分布，这是一个在金融和物理学等领域中至关重要的量。通过构建一个精确的采样器并将其与朴素的离散化方法进行比较，您将亲身体会到精确模拟相对于近似方法的优越性，并理解离散化偏差这一实践中的常见陷阱 [@problem_id:3350866]。", "problem": "设 $\\{W_t\\}_{t \\in [0,1]}$ 为一个标准布朗运动 (BM)，并定义标准布朗桥 $\\{B^{\\mathrm{br}}_t\\}_{t \\in [0,1]}$ 为 $B^{\\mathrm{br}}_t = W_t - t W_1$。令 $M = \\max_{t \\in [0,1]} B^{\\mathrm{br}}_t$。您将利用 $M$ 的分布为 $M$ 构建一个精确采样器，然后将基于此精确采样器的蒙特卡洛 (MC) 估计量 $E[g(M)]$ 与朴素的基于离散化的估计量进行比较，后者通过在均匀时间网格上观察到的桥的最大值来近似 $M$。\n\n任务：\n\n1) 仅从布朗运动和布朗桥的基本定义，结合布朗运动的反射原理以及高斯过程的标准性质，推导出 $M$ 的累积分布函数。具体而言，对于 $x \\ge 0$，从第一性原理出发，以闭式形式表达 $F_M(x) = \\mathbb{P}(M \\le x)$。然后推导出构建 $M$ 的精确采样器所需的逆变换。\n\n2) 使用应用于任务1中推导出的分布的逆变换采样法，设计一个 $M$ 的精确采样算法。该算法必须从 $M$ 的精确分布中产生独立同分布的样本，且没有任何离散化误差。\n\n3) 设计一个朴素的基于离散化的估计量，如下所示。对于给定的整数网格大小 $n_{\\text{grid}} \\in \\mathbb{N}$，在均匀网格 $t_i = i/n_{\\text{grid}}$（其中 $i \\in \\{0,1,\\dots,n_{\\text{grid}}\\}$）上模拟布朗桥 $\\{B^{\\mathrm{br}}_t\\}$，使用关系式 $B^{\\mathrm{br}}_{t_i} = W_{t_i} - t_i W_1$ 以及独立的、均值为零、方差等于时间步长的高斯布朗运动增量。通过 $\\max_{0 \\le i \\le n_{\\text{grid}}} B^{\\mathrm{br}}_{t_i}$ 来近似最大值 $M$，并使用此近似值通过蒙特卡洛方法估计 $E[g(M)]$。解释为什么当 $g$ 是非递减函数时，这个估计量存在离散化偏差，以及偏差的方向是什么。\n\n4) 实现一个程序，该程序：\n- 使用您的精确采样器计算 $E[g(M)]$ 的 MC 估计及其相关的蒙特卡洛标准误。\n- 使用朴素离散化方法计算 $E[g(M)]$ 的 MC 估计及其相关的蒙特卡洛标准误。\n- 对于每个测试用例，报告精确采样器估计值、基于离散化的估计值、估计的偏差（离散化减去精确值）、精确采样器估计的标准误、基于离散化的估计的标准误，以及偏差的双边置信区间半宽，计算公式为 $z_{0.975} \\sqrt{\\mathrm{SE}_{\\text{exact}}^2 + \\mathrm{SE}_{\\text{disc}}^2}$，其中 $z_{0.975} = 1.96$。\n\n数值规格和测试套件：\n\n- 为精确路径和离散化路径使用独立的伪随机数生成器 (PRNG) 种子，以确保两个 MC 估计量的独立性。使用种子值 $\\mathrm{seed}_{\\mathrm{exact}} = 12345$ 和 $\\mathrm{seed}_{\\mathrm{disc}} = 67890$。\n- 对于每个测试用例，使用以下函数 $g$、网格大小 $n_{\\text{grid}}$ 以及样本量 $N_{\\text{exact}}$ 和 $N_{\\text{disc}}$：\n  - 测试用例 1：$g(x) = x$，$n_{\\text{grid}} = 16$，$N_{\\text{exact}} = 200000$，$N_{\\text{disc}} = 100000$。\n  - 测试用例 2：$g(x) = \\exp(0.75 x)$，$n_{\\text{grid}} = 64$，$N_{\\text{exact}} = 200000$，$N_{\\text{disc}} = 50000$。\n  - 测试用例 3：$g(x) = x^2$，$n_{\\text{grid}} = 256$，$N_{\\text{exact}} = 200000$，$N_{\\text{disc}} = 20000$。\n  - 测试用例 4：$g(x) = \\mathbf{1}\\{x \\le 0.5\\}$，$n_{\\text{grid}} = 64$，$N_{\\text{exact}} = 200000$，$N_{\\text{disc}} = 50000$。\n- 所有期望和标准误都必须报告为无量纲实数。\n\n输出格式：\n\n您的程序应生成单行输出，其中包含一个类 JSON 的嵌套列表形式的结果，每个测试用例对应一个条目。每个条目必须是包含六个实数的列表，顺序如下：\n$[\\text{exact\\_mean}, \\text{disc\\_mean}, \\text{bias}, \\text{se\\_exact}, \\text{se\\_disc}, \\text{ci95\\_bias}]$,\n其中 $\\text{bias} = \\text{disc\\_mean} - \\text{exact\\_mean}$ 且 $\\text{ci95\\_bias} = 1.96 \\sqrt{\\text{se\\_exact}^2 + \\text{se\\_disc}^2}$。例如，输出应具有以下形式：\n$[[a_1,b_1,c_1,d_1,e_1,f_1],[a_2,b_2,c_2,d_2,e_2,f_2],[a_3,b_3,c_3,d_3,e_3,f_3],[a_4,b_4,c_4,d_4,e_4,f_4]]$，\n所有条目均为实数。不得有其他打印文本。", "solution": "我们首先回顾基本定义。一个标准布朗运动 (BM) $\\{W_t\\}_{t \\in [0,1]}$ 满足：$W_0 = 0$，具有独立增量，并且对于 $0 \\le s  t \\le 1$，增量 $W_t - W_s$ 是均值为 $0$、方差为 $t-s$ 的高斯分布。在 $[0,1]$ 上的标准布朗桥 (BB) 是一个高斯过程 $\\{B^{\\mathrm{br}}_t\\}$，定义为 $B^{\\mathrm{br}}_t = W_t - t W_1$，这将过程固定在两个端点，因为 $B^{\\mathrm{br}}_0 = 0$ 且 $B^{\\mathrm{br}}_1 = W_1 - W_1 = 0$。该过程是中心化的，$\\mathbb{E}[B^{\\mathrm{br}}_t] = 0$，其协方差为 $\\mathrm{Cov}(B^{\\mathrm{br}}_s,B^{\\mathrm{br}}_t) = \\min(s,t) - s t$。\n\n定义最大值 $M = \\max_{t \\in [0,1]} B^{\\mathrm{br}}_t$。我们将通过 BM 的基本性质和反射原理来推导 $M$ 的分布。\n\n步骤 1：最大值的分布。考虑事件 $\\{ M \\le x \\}$，其中 $x \\ge 0$。根据定义，\n$$\nM \\le x \\quad \\Longleftrightarrow \\quad B^{\\mathrm{br}}_t \\le x \\text{ for all } t \\in [0,1].\n$$\n使用表示式 $B^{\\mathrm{br}}_t = W_t - t W_1$，我们可以通过以 $W_1 = y$ 为条件来分析 $\\{ \\max_{t \\in [0,1]} (W_t - t W_1) \\le x \\}$。在 $W_1 = y$ 的条件下，过程 $t \\mapsto W_t - t y$ 等于一个从 $0$ 开始、具有确定性线性漂移 $-y$ 的布朗运动，即 $\\widetilde{W}_t = W_t - t y$。因此\n$$\n\\mathbb{P}(M \\le x) = \\int_{-\\infty}^{\\infty} \\mathbb{P}\\Big( \\sup_{t \\in [0,1]} (W_t - t y) \\le x \\,\\Big|\\, W_1 = y \\Big) \\, \\varphi(y) \\, dy,\n$$\n其中 $\\varphi(y)$ 是标准正态密度。\n\n对于一个带有漂移 $-y$ 的布朗运动，其在时间 $1$ 之前穿过水平 $x$ 的概率有一个从反射原理和 Cameron-Martin 测度变换推导出的经典表达式。具体来说，对于 $x \\ge 0$，\n$$\n\\mathbb{P}\\Big( \\sup_{t \\in [0,1]} (W_t - t y) \\ge x \\,\\Big|\\, W_1 = y \\Big) = \\exp\\big(-2 x (x + y) \\big)\\, \\mathbf{1}\\{x + y \\ge 0\\}.\n$$\n因此\n$$\n\\mathbb{P}(M \\le x \\mid W_1 = y) = 1 - \\exp\\big(-2 x (x + y) \\big)\\, \\mathbf{1}\\{x + y \\ge 0\\}.\n$$\n对 $y \\sim \\mathcal{N}(0,1)$ 进行积分，涉及指示函数和指数的项通过高斯积分（桥理论中的标准计算）简化为\n$$\nF_M(x) = \\mathbb{P}(M \\le x) = 1 - \\exp(-2 x^2), \\quad x \\ge 0.\n$$\n这个公式是 $[0,1]$ 上标准布朗桥最大值的一个公认分布，它源于适用于固定端点过程的反射原理。\n\n步骤 2：逆变换采样器。累积分布函数 $F_M$ 在 $[0,\\infty)$ 上是连续且严格递增的，其中 $F_M(0) = 0$ 且 $\\lim_{x \\to \\infty} F_M(x) = 1$。对于 $U \\sim \\mathrm{Uniform}(0,1)$，逆变换 $M = F_M^{-1}(U)$ 给出了一个来自 $M$ 分布的精确样本。由于对于 $x \\ge 0$，$F_M(x) = 1 - \\exp(-2 x^2)$，我们进行逆运算：\n$$\nU = 1 - \\exp(-2 x^2) \\;\\Longleftrightarrow\\; 1-U = \\exp(-2 x^2) \\;\\Longleftrightarrow\\; -\\log(1-U) = 2 x^2\n$$\n因此\n$$\nx = \\sqrt{\\frac{-\\log(1-U)}{2}}.\n$$\n因为 $1-U$ 也服从 $\\mathrm{Uniform}(0,1)$ 分布，所以我们可以等价地设 $M = \\sqrt{-\\tfrac{1}{2}\\log U}$。任何一种形式都能产生 $M$ 的精确独立同分布样本。\n\n步骤 3：朴素的基于离散化的估计量。对于给定的整数网格大小 $n_{\\text{grid}} \\ge 1$，定义 $t_i = i/n_{\\text{grid}}$，其中 $i \\in \\{0,1,\\dots,n_{\\text{grid}}\\}$。通过 $W_{t_0} = 0$ 和独立增量 $W_{t_i} - W_{t_{i-1}} \\sim \\mathcal{N}(0, t_i - t_{i-1}) = \\mathcal{N}(0, 1/n_{\\text{grid}})$ 来模拟这些时间点的布朗运动。然后构造桥值 $B^{\\mathrm{br}}_{t_i} = W_{t_i} - t_i W_1$，并通过下式近似最大值\n$$\nM^{(n_{\\text{grid}})} = \\max_{0 \\le i \\le n_{\\text{grid}}} B^{\\mathrm{br}}_{t_i}.\n$$\n给定一个可测函数 $g:\\mathbb{R}_+ \\to \\mathbb{R}$，$E[g(M)]$ 的朴素基于离散化的 MC 估计量使用 $g(M^{(n_{\\text{grid}})})$ 的样本均值。因为 $M^{(n_{\\text{grid}})} \\le M$ 几乎必然成立（网格忽略了网格点之间潜在的局部最大值），当 $g$ 是非递减函数时，该估计量具有非正偏差：\n$$\n\\mathbb{E}[g(M^{(n_{\\text{grid}})})] \\le \\mathbb{E}[g(M)].\n$$\n当 $n_{\\text{grid}} \\to \\infty$ 时，偏差的幅度趋于 $0$，但对于中等大小的 $n_{\\text{grid}}$，偏差可能不可忽略。\n\n步骤 4：蒙特卡洛估计量和精度。对于一个随机变量 $X$ 的独立同分布实现样本 $\\{X_j\\}_{j=1}^N$，$\\mathbb{E}[X]$ 的蒙特卡洛估计量是样本均值 $\\overline{X}_N = \\frac{1}{N} \\sum_{j=1}^N X_j$，其蒙特卡洛标准误估计为 $\\widehat{\\mathrm{SE}}(\\overline{X}_N) = \\widehat{\\sigma}_X/\\sqrt{N}$，其中 $\\widehat{\\sigma}_X^2$ 是带有贝塞尔校正的样本方差。将此应用于 $X = g(M)$，使用精确采样器可以得到一个无偏估计量，对于有界或适当可积的 $g$，其方差有限。将其应用于 $X = g(M^{(n_{\\text{grid}})})$ 会得到一个有偏估计量，当 $g$ 是非递减时，其偏差为负。为精确运行和基于离散化的运行使用独立的 PRNG 流可确保两个蒙特卡洛估计之差的方差等于它们方差之和；因此，偏差的双边置信区间半宽可以计算为 $1.96 \\sqrt{\\mathrm{SE}_{\\text{exact}}^2 + \\mathrm{SE}_{\\text{disc}}^2}$。\n\n算法设计：\n\n- 精确采样器：\n  - 生成 $U \\sim \\mathrm{Uniform}(0,1)$。\n  - 设 $M = \\sqrt{-\\tfrac{1}{2} \\log U}$。\n  - 独立重复以获得所需的样本量。\n\n- 朴素离散化采样器：\n  - 对于每次重复：\n    - 通过对独立的 $\\mathcal{N}(0, 1/n_{\\text{grid}})$ 增量进行累加和，在网格上模拟布朗运动。\n    - 计算 $B^{\\mathrm{br}}_{t_i} = W_{t_i} - t_i W_1$。\n    - 取 $i$ 上的最大值以获得 $M^{(n_{\\text{grid}})}$。\n  - 重复以获得所需的样本量。为提高计算效率和控制内存，分批处理重复，并对网格维度进行矢量化计算。\n\n实现说明：\n\n- 使用独立的种子 $\\mathrm{seed}_{\\mathrm{exact}} = 12345$ 和 $\\mathrm{seed}_{\\mathrm{disc}} = 67890$ 来确保两个 MC 估计量的独立性。\n- 对于问题陈述中指定的每个测试用例，计算并报告：\n  - exact\\_mean $= \\frac{1}{N_{\\text{exact}}} \\sum_{j=1}^{N_{\\text{exact}}} g(M_j)$,\n  - disc\\_mean $= \\frac{1}{N_{\\text{disc}}} \\sum_{j=1}^{N_{\\text{disc}}} g(M^{(n_{\\text{grid}})}_j)$,\n  - bias $= \\text{disc\\_mean} - \\text{exact\\_mean}$,\n  - 根据样本方差计算的蒙特卡洛标准误 $\\text{se\\_exact}$ 和 $\\text{se\\_disc}$，\n  - $\\text{ci95\\_bias} = 1.96 \\sqrt{\\text{se\\_exact}^2 + \\text{se\\_disc}^2}$。\n\n最终程序将所有测试用例的结果汇总到单行的一个类 JSON 嵌套列表中，如要求所述。", "answer": "```python\nimport numpy as np\n\ndef sample_max_bridge_exact(rng: np.random.Generator, n: int) - np.ndarray:\n    # Exact sampler for M = max_{t in [0,1]} B^{br}_t; CDF F(x) = 1 - exp(-2 x^2), x=0\n    # Inverse transform: M = sqrt(-0.5 * log(U)), U ~ Uniform(0,1)\n    U = rng.random(n)\n    # Guard against U == 0 (extremely unlikely)\n    U = np.where(U == 0.0, np.nextafter(0.0, 1.0), U)\n    M = np.sqrt(-0.5 * np.log(U))\n    return M\n\ndef sample_max_bridge_discretized(rng: np.random.Generator, n_samples: int, n_grid: int, batch_cap: int = None) - np.ndarray:\n    # Simulate maxima of Brownian bridge on a uniform grid of n_grid intervals (n_grid+1 points)\n    # t_i = i / n_grid, increments dW ~ N(0, 1/n_grid)\n    # Process in batches for memory efficiency\n    if batch_cap is None:\n        # target about 5e6 doubles per batch (approx 40 MB)\n        target_elems = 5_000_000\n        batch_cap = max(1, int(target_elems // max(1, n_grid)))\n    t = np.linspace(0.0, 1.0, n_grid + 1, dtype=np.float64)  # shape (n_grid+1,)\n    maxima = np.empty(n_samples, dtype=np.float64)\n    produced = 0\n    var_inc = 1.0 / n_grid\n    while produced  n_samples:\n        bsz = min(batch_cap, n_samples - produced)\n        # Generate Brownian increments and cumulative sum to get W at grid points\n        dW = rng.normal(loc=0.0, scale=np.sqrt(var_inc), size=(bsz, n_grid))\n        W = np.concatenate([np.zeros((bsz, 1), dtype=np.float64), np.cumsum(dW, axis=1)], axis=1)  # shape (bsz, n_grid+1)\n        W1 = W[:, [-1]]  # shape (bsz, 1)\n        # Bridge values: B = W - t * W1\n        B = W - t * W1  # broadcasting over t\n        max_batch = np.max(B, axis=1)\n        maxima[produced:produced + bsz] = max_batch\n        produced += bsz\n    return maxima\n\ndef mc_stats(values: np.ndarray):\n    mean = float(np.mean(values))\n    # Sample standard deviation with Bessel's correction\n    sd = float(np.std(values, ddof=1)) if values.size  1 else 0.0\n    se = sd / np.sqrt(values.size) if values.size  0 else 0.0\n    return mean, sd, se\n\ndef solve():\n    # Define test cases: (g_id, g_func, n_grid, N_exact, N_disc)\n    def g1(x): return x  # g(x) = x\n    def g2(x): return np.exp(0.75 * x)  # g(x) = exp(0.75 x)\n    def g3(x): return x**2  # g(x) = x^2\n    def g4(x): return (x = 0.5).astype(np.float64)  # g(x) = 1{x = 0.5}\n\n    test_cases = [\n        (\"case1\", g1, 16, 200_000, 100_000),\n        (\"case2\", g2, 64, 200_000, 50_000),\n        (\"case3\", g3, 256, 200_000, 20_000),\n        (\"case4\", g4, 64, 200_000, 50_000),\n    ]\n\n    # Independent RNGs for exact and discretized estimators\n    rng_exact = np.random.default_rng(12345)\n    rng_disc = np.random.default_rng(67890)\n\n    results = []\n    for _, g, n_grid, N_exact, N_disc in test_cases:\n        # Exact sampling\n        M_exact = sample_max_bridge_exact(rng_exact, N_exact)\n        g_exact = g(M_exact)\n        exact_mean, exact_sd, se_exact = mc_stats(g_exact)\n\n        # Discretization-based sampling\n        M_disc = sample_max_bridge_discretized(rng_disc, N_disc, n_grid)\n        g_disc = g(M_disc)\n        disc_mean, disc_sd, se_disc = mc_stats(g_disc)\n\n        # Bias and CI half-width for bias (independent estimates)\n        bias = disc_mean - exact_mean\n        ci95_bias = 1.96 * np.sqrt(se_exact**2 + se_disc**2)\n\n        results.append([\n            exact_mean,\n            disc_mean,\n            bias,\n            se_exact,\n            se_disc,\n            ci95_bias\n        ])\n\n    # Print as a single JSON-like nested list\n    # Ensure deterministic formatting with default str conversion\n    def fmt_list(lst):\n        return \"[\" + \",\".join(str(x) if not isinstance(x, list) else fmt_list(x) for x in lst) + \"]\"\n\n    print(fmt_list(results))\n\nif __name__ == \"__main__\":\n    solve()\n```", "id": "3350866"}, {"introduction": "最后的练习将布朗桥的应用扩展到统计推断领域，展示其在更抽象的建模问题中的威力。这个思想实验将探讨当模型设定不正确时会发生什么：您将推导一个基于错误模型的最大似然估计量，并以真实的布朗桥过程为基准来分析其偏差。这个练习揭示了对随机过程的深刻理解对于构建稳健的统计模型是何等重要 [@problem_id:3350925]。", "problem": "考虑在区间 $[0,T]$上观测到的一个连续时间随机过程，其中 $T0$。您在等间隔的时间点 $t_i = iT/n$（$i=0,1,\\dots,n$，其中 $t_0=0$ 且 $t_n=T$）收集了 $n$ 个离散时间观测值。对于观测到的过程 $(X_t)_{t\\in[0,T]}$，您使用了以下错误设定的模型：假设它是一个具有线性时间相关漂移的布朗运动，即它满足随机微分方程（SDE）$dX_t = \\theta t \\, dt + dW_t$，其中 $(W_t)_{t\\geq 0}$ 是一个标准布朗运动，$X_0=0$，并且 $\\theta \\in \\mathbb{R}$ 是一个待估计的未知参数。在这个错误设定的模型下，增量 $Z_i := X_{t_i} - X_{t_{i-1}}$ 是独立的高斯随机变量，并且对于每个 $i=1,\\dots,n$，$Z_i$ 的分布仅通过其均值依赖于 $\\theta$。\n\n您决定使用最大似然估计（MLE）来估计 $\\theta$，具体方法是利用错误设定模型下增量 $Z_i$ 的联合高斯似然。\n\n现在假设真实的数据生成过程不是这个错误设定的模型，而是从 $0$ 到时刻 $T$ 的值 $y$ 的布朗桥 $(B_t)_{t\\in[0,T]}$，其中 $y\\in\\mathbb{R}$ 是一个已知的终点值。具体来说，$B_t$ 定义为条件过程 $B_t := W_t - \\frac{t}{T} W_T + \\frac{t}{T} y$，因此 $B_0=0$ 且 $B_T = y$ 几乎必然成立，其中 $(W_t)_{t\\geq 0}$ 是一个标准布朗运动。您仍然使用在错误设定的线性漂移模型下推导出的同一个 MLE，来从观测到的增量 $B_{t_i}-B_{t_{i-1}}$ 中估计 $\\theta$。\n\n从布朗运动高斯增量的基本性质以及布朗桥作为条件布朗运动的定义表示出发，完成以下任务：\n\n- 在错误设定的线性漂移模型下，使用等间隔的观测时间 $t_i = iT/n$，推导出 $\\theta$ 的 MLE $\\hat{\\theta}$。\n- 在从 $0$ 到时刻 $T$ 的值 $y$ 的真实布朗桥模型下，计算 $\\mathbb{E}[\\hat{\\theta}]$，并由此得到当该估计量应用于布朗桥数据时的偏差。\n\n请将您的最终答案表示为一个关于 $T$、$n$ 和 $y$ 的单一封闭形式解析表达式。不需要四舍五入，也不涉及物理单位。最终答案必须是单一的解析表达式。", "solution": "该问题要求我们首先在一个错误设定的随机过程模型中推导参数 $\\theta$ 的最大似然估计（MLE），然后计算当数据实际上由布朗桥生成时该估计量的期望。这个期望量化了由于模型设定错误而导致的估计量的系统误差，即偏差。\n\n解答分为两个主要部分：\n1.  为错误设定的线性漂移模型推导 MLE $\\hat{\\theta}$。\n2.  在真实的布朗桥数据生成过程下计算期望 $\\mathbb{E}[\\hat{\\theta}]$。\n\n**第1部分：最大似然估计量 $\\hat{\\theta}$ 的推导**\n\n过程 $(X_t)_{t\\in[0,T]}$ 的错误设定模型由以下随机微分方程（SDE）给出：\n$$dX_t = \\theta t \\, dt + dW_t$$\n初始条件为 $X_0 = 0$。其中，$(W_t)_{t \\ge 0}$ 是一个标准布朗运动，$\\theta$ 是待估计的参数。\n\n通过将 SDE 从 $0$ 积分到 $t$，我们得到该过程的显式形式：\n$$X_t = \\int_0^t \\theta s \\, ds + \\int_0^t dW_s = \\frac{1}{2}\\theta t^2 + W_t$$\n观测数据记录在离散时间点 $t_i = \\frac{iT}{n}$（$i=0, 1, \\dots, n$）。令 $\\Delta t = T/n$ 为时间步长，则 $t_i = i\\Delta t$。\n我们考虑过程的增量，$Z_i = X_{t_i} - X_{t_{i-1}}$（$i=1, \\dots, n$）。\n$$Z_i = \\left(\\frac{1}{2}\\theta t_i^2 + W_{t_i}\\right) - \\left(\\frac{1}{2}\\theta t_{i-1}^2 + W_{t_{i-1}}\\right) = \\frac{\\theta}{2}(t_i^2 - t_{i-1}^2) + (W_{t_i} - W_{t_{i-1}})$$\n在此模型下，增量 $Z_i$ 是独立的高斯随机变量。我们来确定它们的均值和方差。\n$Z_i$ 的均值为：\n$$\\mu_i(\\theta) = \\mathbb{E}[Z_i] = \\frac{\\theta}{2}(t_i^2 - t_{i-1}^2) = \\frac{\\theta}{2}((i\\Delta t)^2 - ((i-1)\\Delta t)^2) = \\frac{\\theta(\\Delta t)^2}{2}(i^2 - (i-1)^2) = \\frac{\\theta(\\Delta t)^2}{2}(2i-1)$$\n$Z_i$ 的方差为：\n$$\\sigma_i^2 = \\text{Var}(Z_i) = \\text{Var}(W_{t_i} - W_{t_{i-1}}) = t_i - t_{i-1} = \\Delta t$$\n因此，在错误设定的模型下，$Z_i \\sim \\mathcal{N}\\left(\\frac{\\theta(\\Delta t)^2}{2}(2i-1), \\Delta t\\right)$。\n\n基于观测值 $Z_1, \\dots, Z_n$ 的参数 $\\theta$ 的对数似然函数是各个对数密度的和：\n$$\\ell(\\theta; Z_1, \\dots, Z_n) = \\sum_{i=1}^n \\ln\\left[ \\frac{1}{\\sqrt{2\\pi\\Delta t}} \\exp\\left( -\\frac{(Z_i - \\mu_i(\\theta))^2}{2\\Delta t} \\right) \\right]$$\n$$\\ell(\\theta) = -\\frac{n}{2}\\ln(2\\pi\\Delta t) - \\frac{1}{2\\Delta t}\\sum_{i=1}^n \\left(Z_i - \\frac{\\theta(\\Delta t)^2}{2}(2i-1)\\right)^2$$\n为了找到 MLE $\\hat{\\theta}$，我们将 $\\ell(\\theta)$ 对 $\\theta$ 求导，并令结果为零：\n$$\\frac{d\\ell}{d\\theta} = -\\frac{1}{2\\Delta t}\\sum_{i=1}^n 2\\left(Z_i - \\frac{\\theta(\\Delta t)^2}{2}(2i-1)\\right) \\left(-\\frac{(\\Delta t)^2}{2}(2i-1)\\right) = 0$$\n$$\\sum_{i=1}^n \\left(Z_i - \\frac{\\hat{\\theta}(\\Delta t)^2}{2}(2i-1)\\right) (2i-1) = 0$$\n重新整理以求解 $\\hat{\\theta}$：\n$$\\sum_{i=1}^n Z_i(2i-1) = \\hat{\\theta} \\sum_{i=1}^n \\frac{(\\Delta t)^2}{2}(2i-1)^2$$\n$$\\hat{\\theta} = \\frac{\\sum_{i=1}^n Z_i(2i-1)}{\\frac{(\\Delta t)^2}{2} \\sum_{i=1}^n (2i-1)^2}$$\n我们需要计算分母中的和。前 $n$ 个奇数的平方和有一个已知公式：\n$$\\sum_{i=1}^n (2i-1)^2 = \\frac{n(2n-1)(2n+1)}{3} = \\frac{n(4n^2-1)}{3}$$\n将此代入 $\\hat{\\theta}$ 的分母中：\n$$\\frac{(\\Delta t)^2}{2} \\sum_{i=1}^n (2i-1)^2 = \\frac{1}{2}\\left(\\frac{T}{n}\\right)^2 \\frac{n(4n^2-1)}{3} = \\frac{T^2}{2n^2} \\frac{n(4n^2-1)}{3} = \\frac{T^2(4n^2-1)}{6n}$$\n因此，$\\theta$ 的 MLE 是：\n$$\\hat{\\theta} = \\frac{\\sum_{i=1}^n Z_i(2i-1)}{\\frac{T^2(4n^2-1)}{6n}}$$\n\n**第2部分：在布朗桥模型下 $\\hat{\\theta}$ 的期望**\n\n现在，我们假设数据 $Z_i$ 实际上是从 $0$ 到时刻 $T$ 的值 $y$ 的布朗桥 $(B_t)_{t\\in[0,T]}$ 的增量。其定义为 $B_t = W_t - \\frac{t}{T}W_T + \\frac{t}{T}y$。观测到的增量为 $Z_i = B_{t_i} - B_{t_{i-1}}$。我们想要计算 $\\mathbb{E}[\\hat{\\theta}]$，其中期望是根据布朗桥的定律计算的。\n\n$$\\mathbb{E}[\\hat{\\theta}] = \\mathbb{E}\\left[\\frac{\\sum_{i=1}^n (B_{t_i} - B_{t_{i-1}})(2i-1)}{\\frac{T^2(4n^2-1)}{6n}}\\right]$$\n分母是一个确定性常数。根据期望的线性性质，我们可以将期望移到求和符号内部：\n$$\\mathbb{E}[\\hat{\\theta}] = \\frac{\\sum_{i=1}^n \\mathbb{E}[B_{t_i} - B_{t_{i-1}}](2i-1)}{\\frac{T^2(4n^2-1)}{6n}}$$\n首先，我们求布朗桥过程 $B_t$ 的均值：\n$$\\mathbb{E}[B_t] = \\mathbb{E}\\left[W_t - \\frac{t}{T}W_T + \\frac{t}{T}y\\right] = \\mathbb{E}[W_t] - \\frac{t}{T}\\mathbb{E}[W_T] + \\frac{t}{T}y$$\n因为对于任意 $s \\ge 0$，都有 $\\mathbb{E}[W_s] = 0$，所以上式简化为：\n$$\\mathbb{E}[B_t] = 0 - \\frac{t}{T}(0) + \\frac{t}{T}y = \\frac{yt}{T}$$\n现在我们计算增量的期望：\n$$\\mathbb{E}[B_{t_i} - B_{t_{i-1}}] = \\mathbb{E}[B_{t_i}] - \\mathbb{E}[B_{t_{i-1}}] = \\frac{yt_i}{T} - \\frac{yt_{i-1}}{T} = \\frac{y}{T}(t_i - t_{i-1})$$\n由于 $t_i - t_{i-1} = \\Delta t = T/n$，我们得到：\n$$\\mathbb{E}[B_{t_i} - B_{t_{i-1}}] = \\frac{y}{T} \\left(\\frac{T}{n}\\right) = \\frac{y}{n}$$\n现在，我们将此结果代回到 $\\mathbb{E}[\\hat{\\theta}]$ 的表达式中。分子变为：\n$$\\sum_{i=1}^n \\mathbb{E}[B_{t_i} - B_{t_{i-1}}](2i-1) = \\sum_{i=1}^n \\frac{y}{n}(2i-1) = \\frac{y}{n} \\sum_{i=1}^n (2i-1)$$\n前 $n$ 个奇数的和是 $\\sum_{i=1}^n (2i-1) = n^2$。\n所以，分子是 $\\frac{y}{n} (n^2) = yn$。\n\n最后，我们组合出 $\\mathbb{E}[\\hat{\\theta}]$ 的完整表达式：\n$$\\mathbb{E}[\\hat{\\theta}] = \\frac{yn}{\\frac{T^2(4n^2-1)}{6n}} = \\frac{6n^2y}{T^2(4n^2-1)}$$\n问题要求计算期望和偏差。在一个错误设定的模型中，真实的数据生成过程（布朗桥）不包含参数 $\\theta$，因此标准意义上的偏差 $\\mathbb{E}[\\hat{\\theta}] - \\theta_{\\text{true}}$ 是没有良好定义的。一个在此情境下常见的合理解释是，相对于一个无漂移的基准模型（即 $\\theta=0$）来定义偏差。在这种情况下，偏差就等于估计量的期望，即 偏差$(\\hat{\\theta}) = \\mathbb{E}[\\hat{\\theta}] - 0 = \\mathbb{E}[\\hat{\\theta}]$。因此，计算出的期望本身就是偏差。", "answer": "$$\\boxed{\\frac{6n^2y}{T^2(4n^2-1)}}$$", "id": "3350925"}]}