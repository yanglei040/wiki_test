{"hands_on_practices": [{"introduction": "要掌握延迟拒绝（DR）等高级MCMC方法，首要任务是理解其核心构造，以确保算法在理论上的正确性。这项练习将深入探讨DR算法的关键组成部分：多阶段接受概率的推导。通过为三阶段DR方案构建精确的接受公式，您将直接面对确保细致平衡条件的复杂性，这是保证算法最终能从目标分布中正确抽样的基础 [@problem_id:3302333]。", "problem": "考虑一个在 $\\mathbb{R}^{d}$ 上、除归一化常数外已知的目标概率密度（记为 $\\pi(x)$），以及在马尔可夫链蒙特卡洛 (MCMC) 更广泛的框架内，通过 Metropolis–Hastings (MH) 方法构建的马尔可夫链。延迟拒绝 (DR) 方案扩展了 MH 方法，它允许在一次拒绝后进行第二次、第三次尝试等，使用具有可能增强的局部适应性的特定阶段提议核。在 $k$ 阶 DR 中，使用一个提议密度族 $\\{q_{j}(\\cdot)\\}_{j=1}^{k}$，其中 $q_{1}(x,\\cdot)$ 是第一阶段的核，而对于 $j \\ge 2$，$q_{j}(x,y_{1},\\ldots,y_{j-1},\\cdot)$ 可能依赖于当前状态和先前已提议的点。选择接受概率，以使最终的马尔可夫转移核满足关于 $\\pi(\\cdot)$ 的细致平衡条件。\n\n假设我们运行一个包含 $k=3$ 个阶段的 DR 方案。在给定的迭代中，从当前状态 $x$ 出发，我们抽取 $y_{1} \\sim q_{1}(x,\\cdot)$ 并尝试标准的 MH 接受/拒绝决策。如果该提议被拒绝，我们抽取 $y_{2} \\sim q_{2}(x,y_{1},\\cdot)$ 并尝试第二阶段的接受/拒绝。如果再次被拒绝，我们抽取 $y_{3} \\sim q_{3}(x,y_{1},y_{2},\\cdot)$ 并尝试第三阶段的接受/拒绝，其接受概率记为 $\\alpha_{3}(x,y_{1},y_{2},y_{3})$。较早阶段的接受概率分别记为 $\\alpha_{1}(x,y_{1})$ 和 $\\alpha_{2}(x,y_{1},y_{2})$。假设所有提议密度在其支撑集上处处为正，并且所有接受概率的选择都是为了强制满足细致平衡条件，并构建一个关于 $\\pi(\\cdot)$ 的可逆马尔可夫链。\n\n利用细致平衡原理，以及“前向路径中的每个第 $j$ 阶段提议，当从提议状态回看当前状态时，必须与由 $j$ 个嵌套提议和 $j-1$ 次拒绝组成的反向路径相匹配”这一事实，请确定第三阶段接受概率 $\\alpha_{3}(x,y_{1},y_{2},y_{3})$ 的正确显式公式，并描述评估反向路径各量以及存储提议的必要性所带来的计算影响。\n\n哪个选项是正确的？\n\nA. $\\alpha_{3}(x,y_{1},y_{2},y_{3}) = \\min\\Bigg\\{1,\\; \\dfrac{\\pi(y_{3})\\, q_{1}(y_{3},y_{2})\\, q_{2}(y_{3},y_{2},y_{1})\\, q_{3}(y_{3},y_{2},y_{1},x)\\, \\big(1-\\alpha_{1}(y_{3},y_{2})\\big)\\, \\big(1-\\alpha_{2}(y_{3},y_{2},y_{1})\\big)}{\\pi(x)\\, q_{1}(x,y_{1})\\, q_{2}(x,y_{1},y_{2})\\, q_{3}(x,y_{1},y_{2},y_{3})\\, \\big(1-\\alpha_{1}(x,y_{1})\\big)\\, \\big(1-\\alpha_{2}(x,y_{1},y_{2})\\big)} \\Bigg\\}$。计算上，必须评估反向路径的提议密度和反向路径的拒绝情况，这通常需要在 $y_{1}$、$y_{2}$ 和 $y_{3}$ 处对目标函数进行求值；前向路径的量 $\\alpha_{1}(x,y_{1})$ 和 $\\alpha_{2}(x,y_{1},y_{2})$ 应当被存储以避免重复计算。内存和算术成本随阶段数增长的量级为 $\\mathcal{O}(k)$，并且缓存 $\\pi(\\cdot)$ 和 $q_{j}(\\cdot)$ 的求值对于控制开销至关重要。\n\nB. $\\alpha_{3}(x,y_{1},y_{2},y_{3}) = \\min\\Bigg\\{1,\\; \\dfrac{\\pi(y_{3})\\, q_{1}(y_{3},x)\\, q_{2}(y_{3},x)\\, q_{3}(y_{3},x)}{\\pi(x)\\, q_{1}(x,y_{1})\\, q_{2}(x,y_{1},y_{2})\\, q_{3}(x,y_{1},y_{2},y_{3})} \\Bigg\\}$。计算上，由于只出现提议密度，因此无需评估任何先前阶段的接受概率，也无需存储中间提议，所以除了评估提议之外，内存和计算成本可以忽略不计。\n\nC. $\\alpha_{3}(x,y_{1},y_{2},y_{3}) = \\min\\Bigg\\{1,\\; \\dfrac{\\pi(y_{3})\\, q_{1}(y_{2},y_{3})\\, q_{2}(y_{1},y_{2},y_{3})\\, q_{3}(x,y_{1},y_{2},y_{3})\\, \\big(1-\\alpha_{1}(y_{2},y_{3})\\big)\\, \\big(1-\\alpha_{2}(y_{1},y_{2},y_{3})\\big)}{\\pi(x)\\, q_{1}(x,y_{1})\\, q_{2}(x,y_{1},y_{2})\\, q_{3}(x,y_{1},y_{2},y_{3})\\, \\big(1-\\alpha_{1}(x,y_{1})\\big)\\, \\big(1-\\alpha_{2}(x,y_{1},y_{2})\\big)} \\Bigg\\}$。计算上，反向路径的拒绝是不必要的，因为第三阶段直接镜像了前向提议；因此，只应存储前向的拒绝情况。\n\nD. $\\alpha_{3}(x,y_{1},y_{2},y_{3}) = \\min\\Bigg\\{1,\\; \\dfrac{\\pi(y_{3})\\, q_{1}(y_{3},y_{2})\\, q_{2}(y_{3},y_{2},y_{1})\\, q_{3}(y_{3},y_{2},y_{1},x)\\, \\alpha_{1}(y_{3},y_{2})\\, \\alpha_{2}(y_{3},y_{2},y_{1})}{\\pi(x)\\, q_{1}(x,y_{1})\\, q_{2}(x,y_{1},y_{2})\\, q_{3}(x,y_{1},y_{2},y_{3})\\, \\alpha_{1}(x,y_{1})\\, \\alpha_{2}(x,y_{1},y_{2})} \\Bigg\\}$。计算上，因为出现的是接受概率而非拒绝概率，所以可以无损地丢弃早期的提议，并且不需要进行反向路径的评估，因为它们会因对称性而抵消。", "solution": "### **阶段一：问题验证**\n\n**步骤一：提取已知条件**\n- 目标概率密度：$\\pi(x)$，在 $\\mathbb{R}^d$ 上，除归一化常数外已知。\n- 方法：马尔可夫链蒙特卡洛 (MCMC) 中的 Metropolis-Hastings (MH)。\n- 扩展：阶数为 $k=3$ 的延迟拒绝 (DR) 方案。\n- 提议核：\n    - 阶段 1: $y_1 \\sim q_1(x, \\cdot)$\n    - 阶段 2: $y_2 \\sim q_2(x, y_1, \\cdot)$ (在拒绝 $y_1$ 后使用)\n    - 阶段 3: $y_3 \\sim q_3(x, y_1, y_2, \\cdot)$ (在拒绝 $y_2$ 后使用)\n- 接受概率：\n    - 阶段 1: $\\alpha_1(x, y_1)$\n    - 阶段 2: $\\alpha_2(x, y_1, y_2)$\n    - 阶段 3: $\\alpha_3(x, y_1, y_2, y_3)$\n- 假设：\n    - 提议密度在其支撑集上处处为正。\n    - 选择接受概率以强制满足细致平衡条件，从而构建一个关于 $\\pi(\\cdot)$ 的可逆马尔可夫链。\n- 目标：确定 $\\alpha_3(x, y_1, y_2, y_3)$ 的正确显式公式，并描述其计算影响。\n\n**步骤二：使用提取的已知条件进行验证**\n- **科学上是否成立？** 是。延迟拒绝算法是 Metropolis-Hastings 算法一个公认且已发表的扩展。它是计算统计学和统计物理学中的一种标准技术。该问题严格基于 MCMC 和细致平衡的原理。\n- **是否适定？** 是。该问题要求给出第三阶段接受概率的显式公式，这可以从细致平衡条件推导出来。该设置对于 DR 是标准的。DR 的基础理论保证了解的存在性。\n- **是否客观？** 是。语言精确、技术性强，没有任何主观或基于意见的陈述。这是该领域问题的标准表述。\n\n**检查缺陷：**\n1. **科学上不成立：** 无。前提条件是 DR MCMC 的标准前提。\n2. **无法形式化：** 无。该问题已经用数学术语形式化了。它直接关于延迟拒绝策略。\n3. **不完整/矛盾：** 无。所有必要组成部分（提议核、目标密度、阶段、细致平衡）都已定义。阶数 $k=3$ 已明确。\n4. **不现实/不可行：** 无。这是一个关于算法的理论问题，而非物理系统。条件对于该算法是标准的。\n5. **不适定：** 无。$\\alpha_j$ 的唯一公式可以从 DR 的广义细致平衡条件推导得出。\n6. **伪深刻/微不足道：** 无。推导 DR 接受概率是一个不平凡的练习，需要将细致平衡原理仔细应用于多阶段过程。这是对理解该算法的一个很好的检验。\n7. **外部可验证性：** 无。该推导是一个数学证明问题。\n\n**步骤三：结论与行动**\n- **结论：** 问题陈述是有效的。\n- **行动：** 我将继续推导解答。\n\n---\n\n### **阶段二：解答推导**\n\n核心原理是广义细致平衡条件。对于一个转移核为 $P(x, dy)$ 的马尔可夫链，细致平衡表明 $\\pi(x) P(x, dy) = \\pi(y) P(y, dx)$。在带有提议核的 MCMC 的背景下，对于转移概率密度 $p(x, y)$，这通常写作 $\\pi(x) p(x, y) = \\pi(y) p(y, x)$。\n\n对于像 DR 这样的多阶段算法，我们需要平衡从状态 $x$到状态 $y$ 的总概率流与从 $y$ 到 $x$ 的流。这比标准 MH 更复杂。\n\n让我们定义路径及其概率。\n\n**前向路径：$x \\to y_3$**\n此移动仅在以下情况下发生：\n1. 我们从 $x$ 提议 $y_1$。概率密度：$q_1(x, y_1)$。\n2. 我们拒绝 $y_1$。概率：$1 - \\alpha_1(x, y_1)$。\n3. 然后我们从 $x$ (给定 $y_1$) 提议 $y_2$。概率密度：$q_2(x, y_1, y_2)$。\n4. 我们拒绝 $y_2$。概率：$1 - \\alpha_2(x, y_1, y_2)$。\n5. 然后我们从 $x$ (给定 $y_1, y_2$) 提议 $y_3$。概率密度：$q_3(x, y_1, y_2, y_3)$。\n6. 我们接受 $y_3$。概率：$\\alpha_3(x, y_1, y_2, y_3)$。\n\n因此，通过路径 $(y_1, y_2)$ 从 $x$ 移动到 $y_3$ 的概率密度为：\n$T_3(x \\to y_3) = q_1(x, y_1) (1-\\alpha_1(x, y_1)) q_2(x, y_1, y_2) (1-\\alpha_2(x, y_1, y_2)) q_3(x, y_1, y_2, y_3) \\alpha_3(x, y_1, y_2, y_3)$。\n这是关于测度 $dy_1 dy_2 dy_3$ 的密度。\n\n**反向路径：$y_3 \\to x$**\n这是棘手的部分。为了使第 3 阶段的移动满足细致平衡，我们需要考虑能回到 $x$ 的反向提议序列。DR 的逻辑是，一个第 $j$ 阶段的提议 $x \\to y_j$ 与一个由从 $y_j$ 开始并以 $x$ 结束的 $j$ 个提议序列组成的反向路径相平衡。\n\nDR 接受概率 $\\alpha_j$ 的标准推导是平衡移动 $x \\to y_j$ 的流与反向流 $y_j \\to x$。关键的洞见是，接受概率 $\\alpha_j(x, y_1, ..., y_j)$ 的定义是为了平衡整个提议序列的流。\n\n让我们使用 Tierney (1999) 或 Green  Mira (2001) 的广义 Metropolis-Hastings 框架。第 $j$ 阶段移动的细致平衡方程是：\n$\\pi(x) P_j(x \\to y_j) = \\pi(y_j) P_j(y_j \\to x)$\n其中 $P_j(x \\to y_j)$ 是从 $x$ 开始提议序列 $(y_1, ..., y_j)$ 并在阶段 $j$ 接受 $y_j$ 的概率密度。\n\n对于 $j=3$：\n$P_3(x \\to y_3)$ 是以下事件序列的概率密度：\n$x \\to y_1$ (提议) $\\implies$ 拒绝\n$x \\to y_2$ (提议) $\\implies$ 拒绝\n$x \\to y_3$ (提议) $\\implies$ 接受\n\n此路径的密度是：\n$\\text{前向密度} = q_1(x, y_1) (1-\\alpha_1(x, y_1)) q_2(x, y_1, y_2) (1-\\alpha_2(x, y_1, y_2)) q_3(x, y_1, y_2, y_3) \\alpha_3(x, y_1, y_2, y_3)$\n\n现在，让我们构建从 $y_3$ 到 $x$ 的反向路径。此路径是通过尝试反转提议序列来构建的：$y_3 \\to y_2 \\to y_1 \\to x$。\n- 从 $y_3$ 的第一阶段提议：$z_1 \\sim q_1(y_3, \\cdot)$。我们需要考虑 $z_1=y_2$。这被拒绝。\n- 从 $y_3$ 的第二阶段提议：$z_2 \\sim q_2(y_3, y_2, \\cdot)$。我们需要考虑 $z_2=y_1$。这被拒绝。\n- 从 $y_3$ 的第三阶段提议：$x \\sim q_3(y_3, y_2, y_1, \\cdot)$。这被接受。\n\n反向路径概率密度（不包括接受因子）是：\n$\\pi(y_3) \\times [q_1(y_3, y_2) (1-\\alpha_1(y_3, y_2)) q_2(y_3, y_2, y_1) (1-\\alpha_2(y_3, y_2, y_1)) q_3(y_3, y_2, y_1, x)]$\n\n然后通过均衡此特定路径的完整概率流，并采用标准的 Metropolis-Hastings 形式来定义接受概率 $\\alpha_3(x, y_1, y_2, y_3)$：\n$\\alpha_3(\\dots) = \\min \\left\\{ 1, \\frac{\\text{反向路径流}}{\\text{前向路径流}} \\right\\}$\n\n该比率为：\n比率 $= \\frac{\\pi(y_3) \\ q_1(y_3, y_2) (1-\\alpha_1(y_3, y_2)) q_2(y_3, y_2, y_1) (1-\\alpha_2(y_3, y_2, y_1)) q_3(y_3, y_2, y_1, x)}{\\pi(x) \\ q_1(x, y_1) (1-\\alpha_1(x, y_1)) q_2(x, y_1, y_2) (1-\\alpha_2(x, y_1, y_2)) q_3(x, y_1, y_2, y_3)}$\n\n这给出了第三阶段接受概率的完整表达式：\n$$\n\\alpha_3(x, y_1, y_2, y_3) = \\min\\Bigg\\{1, \\frac{\\pi(y_3) q_1(y_3, y_2) \\big(1-\\alpha_1(y_3, y_2)\\big) q_2(y_3, y_2, y_1) \\big(1-\\alpha_2(y_3, y_2, y_1)\\big) q_3(y_3, y_2, y_1, x)}{\\pi(x) q_1(x, y_1) \\big(1-\\alpha_1(x, y_1)\\big) q_2(x, y_1, y_2) \\big(1-\\alpha_2(x, y_1, y_2)\\big) q_3(x, y_1, y_2, y_3)}\\Bigg\\}\n$$\n其中较低阶段的接受概率本身是递归定义的：\n$$\n\\alpha_1(u, v) = \\min\\left\\{1, \\frac{\\pi(v) q_1(v, u)}{\\pi(u) q_1(u, v)}\\right\\}\n$$\n$$\n\\alpha_2(u, v_1, v_2) = \\min\\left\\{1, \\frac{\\pi(v_2) q_1(v_2, v_1) \\big(1-\\alpha_1(v_2, v_1)\\big) q_2(v_2, v_1, u)}{\\pi(u) q_1(u, v_1) \\big(1-\\alpha_1(u, v_1)\\big) q_2(u, v_1, v_2)}\\right\\}\n$$\n\n现在我将评估所提供的选项。\n\n**选项 A**\n提供的公式是：\n$ \\alpha_{3}(x,y_{1},y_{2},y_{3}) = \\min\\Bigg\\{1,\\; \\dfrac{\\pi(y_{3})\\, q_{1}(y_{3},y_{2})\\, q_{2}(y_{3},y_{2},y_{1})\\, q_{3}(y_{3},y_{2},y_{1},x)\\, \\big(1-\\alpha_{1}(y_{3},y_{2})\\big)\\, \\big(1-\\alpha_{2}(y_{3},y_{2},y_{1})\\big)}{\\pi(x)\\, q_{1}(x,y_{1})\\, q_{2}(x,y_{1},y_{2})\\, q_{3}(x,y_{1},y_{2},y_{3})\\, \\big(1-\\alpha_{1}(x,y_{1})\\big)\\, \\big(1-\\alpha_{2}(x,y_{1},y_{2})\\big)} \\Bigg\\} $\n此公式与从延迟拒绝的细致平衡原理推导出的公式相同。所有函数的参数都是正确的，包括前向路径 ($x \\to y_1 \\to y_2 \\to y_3$) 和反向路径 ($y_3 \\to y_2 \\to y_1 \\to x$) 的提议核和低阶段拒绝概率。\n\n计算分析陈述：\n- “必须评估反向路径的提议密度和反向路径的拒绝情况”：正确。分子包含 $q_j(y_3, \\dots)$ 项和 $(1-\\alpha_j(y_3, \\dots))$ 项。\n- “这通常需要在 $y_{1}$、$y_{2}$ 和 $y_{3}$ 处对目标函数进行求值”：正确。例如，为了在主表达式中评估 $\\alpha_1(y_3, y_2)$，需要 $\\pi(y_2)$ 和 $\\pi(y_3)$。为了评估 $\\alpha_2(y_3, y_2, y_1)$，还需要 $\\pi(y_1)$。前向路径已经需要对 $\\pi(x)$, $\\pi(y_1)$, $\\pi(y_2)$ 和 $\\pi(y_3)$ 进行求值，因此这些值应该被缓存。\n- “前向路径的量 $\\alpha_{1}(x,y_{1})$ 和 $\\alpha_{2}(x,y_{1},y_{2})$ 应当被存储”：正确。这些量是在决定进入阶段2和3时计算的，并且在分母中再次需要。存储它们可以避免重新计算。\n- “内存和算术成本随阶段数增长的量级为 $\\mathcal{O}(k)$... 缓存... 至关重要”：正确。在阶段 $k$，必须存储 $k-1$ 个先前的提议及相关量。接受率比值中的项数也随 $k$ 线性增长。这使得将计算和内存成本描述为 $\\mathcal{O}(k)$ 在实践中是准确的。缓存对于避免 $\\pi$ 和 $q$ 的重新计算呈爆炸式增长至关重要。\n\n此选项中的整个陈述在事实上和逻辑上都是健全的。\n**结论：正确。**\n\n**选项 B**\n提供的公式是：\n$ \\alpha_{3}(x,y_{1},y_{2},y_{3}) = \\min\\Bigg\\{1,\\; \\dfrac{\\pi(y_{3})\\, q_{1}(y_{3},x)\\, q_{2}(y_{3},x)\\, q_{3}(y_{3},x)}{\\pi(x)\\, q_{1}(x,y_{1})\\, q_{2}(x,y_{1},y_{2})\\, q_{3}(x,y_{1},y_{2},y_{3})} \\Bigg\\} $\n这个公式有根本性的错误。它忽略了说明先前阶段拒绝的关键因子 $(1-\\alpha_j)$。此外，反向提议密度，例如 $q_1(y_3, x)$，是不正确的；它们没有反映结构化的反向路径 $y_3 \\to y_2 \\to y_1 \\to x$。其计算分析表明成本可以忽略不计且无需存储，这是这个错误公式的直接推论，因此也是不正确的。\n**结论：不正确。**\n\n**选项 C**\n提供的公式是：\n$ \\alpha_{3}(x,y_{1},y_{2},y_{3}) = \\min\\Bigg\\{1,\\; \\dfrac{\\pi(y_{3})\\, q_{1}(y_{2},y_{3})\\, q_{2}(y_{1},y_{2},y_{3})\\, q_{3}(x,y_{1},y_{2},y_{3})\\, \\big(1-\\alpha_{1}(y_{2},y_{3})\\big)\\, \\big(1-\\alpha_{2}(y_{1},y_{2},y_{3})\\big)}{\\pi(x)\\, q_{1}(x,y_{1})\\, q_{2}(x,y_{1},y_{2})\\, q_{3}(x,y_{1},y_{2},y_{3})\\, \\big(1-\\alpha_{1}(x,y_{1})\\big)\\, \\big(1-\\alpha_{2}(x,y_{1},y_{2})\\big)} \\Bigg\\} $\n这个公式不正确。分子中反向路径提议密度的参数是毫无意义的。例如，$q_1(y_2, y_3)$ 意味着从 $y_2$到 $y_3$ 的提议，而反向路径是从 $y_3$ 开始的。分子中出现的项 $q_3(x, y_1, y_2, y_3)$ 同样是错误的。反向路径接受概率的参数也同样混乱。后续声称“反向路径的拒绝是不必要的”与其自身（不正确的）公式相矛盾，该公式明确包含了这些项。\n**结论：不正确。**\n\n**选项 D**\n提供的公式是：\n$ \\alpha_{3}(x,y_{1},y_{2},y_{3}) = \\min\\Bigg\\{1,\\; \\dfrac{\\pi(y_{3})\\, q_{1}(y_{3},y_{2})\\, q_{2}(y_{3},y_{2},y_{1})\\, q_{3}(y_{3},y_{2},y_{1},x)\\, \\alpha_{1}(y_{3},y_{2})\\, \\alpha_{2}(y_{3},y_{2},y_{1})}{\\pi(x)\\, q_{1}(x,y_{1})\\, q_{2}(x,y_{1},y_{2})\\, q_{3}(x,y_{1},y_{2},y_{3})\\, \\alpha_{1}(x,y_{1})\\, \\alpha_{2}(x,y_{1},y_{2})} \\Bigg\\} $\n这个公式错误地使用了接受概率 $\\alpha_j$ 而不是拒绝概率 $(1-\\alpha_j)$ 来表示中间步骤。移动之所以进入第 $j+1$ 阶段，恰恰是因为第 $j$ 阶段的提议被*拒绝*了，这是一个概率为 $(1-\\alpha_j)$ 的事件。使用 $\\alpha_j$ 将意味着移动被接受，这会终止提议序列，使得进入第 $j+1$ 阶段成为不可能。其计算分析同样有缺陷，声称可以丢弃早期的提议，这是错误的。\n**结论：不正确。**", "answer": "$$\\boxed{A}$$", "id": "3302333"}, {"introduction": "一个理论上正确的算法未必在实践中是高效的。在掌握了如何构建延迟拒绝采样器之后，下一个关键问题是评估其性能，以判断“何时”以及“为何”使用它。这项练习引入了一个定量分析框架，用于评估DR策略相对于标准Metropolis-Hastings算法的效率增益 [@problem_id:3302307]。通过对单位时间内的预期平方跳跃距离进行建模，您将学会如何在增加的计算成本与提高的样本移动性之间做出权衡，从而就算法设计做出明智的决策。", "problem": "考虑马尔可夫链蒙特卡洛（MCMC）中的Metropolis–Hastings算法的一种两阶段延迟拒绝（DR）变体，其目标概率密度为$\\mathbb{R}^d$上的$\\pi(x)$。设当前状态为$X \\in \\mathbb{R}^d$。阶段1的提议为$Y \\sim q_1(X,\\cdot)$，其接受概率为\n$$\n\\alpha_1(X,Y) \\;=\\; \\min\\!\\left\\{1, \\;\\frac{\\pi(Y)\\,q_1(Y,X)}{\\pi(X)\\,q_1(X,Y)}\\right\\}\n$$。\n如果阶段1的提议被拒绝，则抽取一个阶段2的提议$Z \\sim q_2(X,Y,\\cdot)$，并以概率$\\alpha_2(X,Y,Z)$接受它。该概率的选择要确保生成的马尔可夫链对于$\\pi$是可逆的。一种常见的选择（Mira的两阶段延迟拒绝接受概率）是\n$$\n\\alpha_2(X,Y,Z) \\;=\\; \\min\\!\\left\\{1, \\; \\frac{\\pi(Z)\\,q_1(Z,Y)\\,\\big(1-\\alpha_1(Z,Y)\\big)\\,q_2(Z,Y,X)}{\\pi(X)\\,q_1(X,Y)\\,\\big(1-\\alpha_1(X,Y)\\big)\\,q_2(X,Y,Z)}\\right\\}\n$$。\n在平稳状态下定义以下期望量：\n- $p_1 \\;=\\; \\mathbb{E}\\!\\left[\\alpha_1(X,Y)\\right]$，阶段1的接受概率。\n- $p_2 \\;=\\; \\mathbb{E}\\!\\left[\\alpha_2(X,Y,Z)\\,\\big|\\,\\text{stage-$1$ rejection}\\right]$，在阶段1被拒绝的条件下，阶段2的接受概率。\n- $J_1 \\;=\\; \\mathbb{E}\\!\\left[\\|Y-X\\|^2 \\,\\big|\\,\\text{stage-$1$ acceptance}\\right]$，在阶段1被接受的条件下，阶段1的条件期望平方跳跃距离，其中$\\|\\cdot\\|$是欧几里得范数。\n- $J_2 \\;=\\; \\mathbb{E}\\!\\left[\\|Z-X\\|^2 \\,\\big|\\,\\text{stage-$2$ acceptance}\\right]$，在阶段2被接受的条件下，阶段2的条件期望平方跳跃距离。\n\n假设一个成本模型，其中每次迭代的期望计算时间包含一个总是会产生的阶段1成本$c_1>0$，以及一个仅在阶段1拒绝时产生的增量阶段2成本$c_2>0$。对于只使用$q_1$（无延迟拒绝）的单阶段基准，其效率通过单位时间内的期望平方跳跃距离来衡量，定义为每次迭代的期望平方跳跃除以每次迭代的期望计算时间。\n\n哪个选项正确地指出了一个量化标准，用于判断DR何时相对于单阶段基准能产生净效率增益（以单位时间内的期望平方跳跃距离表示），并且还指出了DR可能因对$q_2$的选择不当或计算成本增加而无法提高效率的现实情况？\n\nA. 如果满足以下条件，DR比基准更有效：\n$$\n\\frac{p_1\\,J_1 + (1-p_1)\\,p_2\\,J_2}{\\,c_1 + (1-p_1)\\,c_2\\,} \\;>\\; \\frac{p_1\\,J_1}{\\,c_1\\,}\n$$。\n当$q_2$过于局部，使得$J_2$相对于$J_1$可以忽略不计时（例如，一个非常小的步长导致$J_2 \\approx 0$），或者当阶段2的机制大幅增加成本时（例如，由于昂贵的局部曲率计算导致$c_2 \\gg c_1$），DR可能无法提高效率，导致左侧的值低于基准。\n\nB. DR总是能提高效率，因为任何额外的接受都会严格增加单位时间内的期望平方跳跃距离。一个有效的标准是\n$$\n\\frac{p_1\\,J_1 + p_2\\,J_2}{\\,c_1 + c_2\\,} \\;>\\; \\frac{p_1\\,J_1}{\\,c_1\\,}\n$$，\n并且没有任何$q_2$的选择或成本$c_2$会使DR比基准更差。\n\nC. DR是有益的当且仅当$p_2>p_1$且$c_2<c_1$。这个条件确保了第二阶段比第一阶段更有效，并且成本更低。\n\nD. DR比基准更有效，如果\n$$\n\\frac{p_1\\,J_1 + (1-p_1)\\,p_2\\,J_2}{\\,c_1 + (1-p_1)\\,c_2\\,} \\;>\\; \\frac{(p_1+p_2)\\,J_1}{\\,c_1+c_2\\,}\n$$。\n右侧代表一种混合基准。如果$J_2$非常大，那么DR总是优越的。", "solution": "用户希望我扮演一位严谨的STEM教授，来验证和解决一个关于延迟拒绝（DR）Metropolis-Hastings算法效率的问题。\n\n### 问题验证\n\n**步骤1：提取已知条件**\n\n-   **算法**：一个两阶段延迟拒绝（DR）Metropolis–Hastings MCMC算法。\n-   **目标密度**：$\\mathbb{R}^d$上的$\\pi(x)$。\n-   **当前状态**：$X \\in \\mathbb{R}^d$。\n-   **阶段1提议**：$Y \\sim q_1(X,\\cdot)$。\n-   **阶段1接受概率**：$\\alpha_1(X,Y) = \\min\\!\\left\\{1, \\;\\frac{\\pi(Y)\\,q_1(Y,X)}{\\pi(X)\\,q_1(X,Y)}\\right\\}$。\n-   **阶段2提议**：如果阶段1被拒绝，则$Z \\sim q_2(X,Y,\\cdot)$。\n-   **阶段2接受概率**：$\\alpha_2(X,Y,Z) = \\min\\!\\left\\{1, \\; \\frac{\\pi(Z)\\,q_1(Z,Y)\\,\\big(1-\\alpha_1(Z,Y)\\big)\\,q_2(Z,Y,X)}{\\pi(X)\\,q_1(X,Y)\\,\\big(1-\\alpha_1(X,Y)\\big)\\,q_2(X,Y,Z)}\\right\\}$。该概率的选择要确保生成的马尔可夫链对于$\\pi$是可逆的。\n-   **期望量的定义（在平稳状态下）**：\n    -   $p_1 = \\mathbb{E}\\!\\left[\\alpha_1(X,Y)\\right]$（阶段1的接受概率）。\n    -   $p_2 = \\mathbb{E}\\!\\left[\\alpha_2(X,Y,Z)\\,\\big|\\,\\text{stage-$1$ rejection}\\right]$（阶段1拒绝条件下的阶段2接受概率）。\n    -   $J_1 = \\mathbb{E}\\!\\left[\\|Y-X\\|^2 \\,\\big|\\,\\text{stage-$1$ acceptance}\\right]$（阶段1的条件期望平方跳跃距离）。$\\|\\cdot\\|$是欧几里得范数。\n    -   $J_2 = \\mathbb{E}\\!\\left[\\|Z-X\\|^2 \\,\\big|\\,\\text{stage-$2$ acceptance}\\right]$（阶段2的条件期望平方跳跃距离）。\n-   **成本模型**：\n    -   阶段1成本：$c_1 > 0$（总是产生）。\n    -   阶段2增量成本：$c_2 > 0$（仅在阶段1拒绝时产生）。\n-   **效率指标**：单位时间内的期望平方跳跃距离，定义为$\\frac{\\mathbb{E}[\\text{每次迭代的平方跳跃}]}{\\mathbb{E}[\\text{每次迭代的计算时间}]}$。\n-   **问题**：确定DR相对于仅使用$q_1$的单阶段基准具有更高效率的量化标准，并讨论DR可能无法提高效率的现实情况。\n\n**步骤2：使用提取的已知条件进行验证**\n\n-   **科学上合理（关键）**：该问题描述了标准的两阶段延迟拒绝MCMC算法。接受概率$\\alpha_1$和$\\alpha_2$的形式是正确的，可以确保关于$\\pi(x)$的细致平衡（可逆性）条件得到满足。这是计算统计学中一个成熟且有效的方法。效率指标虽然是一种启发式方法，但在评估类似随机游走的采样器时是常用且合理的选择。该问题在根本上是合理的。\n-   **适定性**：该问题是适定的。它清晰地定义了两种算法（基准和DR），提供了一个量化的比较指标（效率），并给出了构建两种情况下效率所需的所有必要定义和参数（$p_1, p_2, J_1, J_2, c_1, c_2$）。可以推导出唯一的答案。\n-   **客观性（关键）**：该问题以精确、客观的数学语言陈述。没有主观或含糊的术语。\n-   问题设置是完整且一致的。没有遗漏任何基本信息，也没有任何矛盾之处。成本模型是对现实的合理简化。\n\n**步骤3：结论与行动**\n\n问题陈述是有效的。这是MCMC方法领域中一个表述良好的问题。我将进行推导和求解。\n\n### 推导与求解\n\n问题的核心是比较两种MCMC方案的效率：\n1.  **基准**：使用提议分布$q_1$的标准Metropolis-Hastings算法。\n2.  **DR**：所描述的两阶段延迟拒绝算法。\n\n效率定义为 $\\text{效率} = \\frac{\\mathbb{E}[\\text{平方跳跃距离}]}{\\mathbb{E}[\\text{时间}]}$。我们需要为两种方案计算这个值。\n\n**1. 基准算法的效率**\n\n-   **每次迭代的期望平方跳跃距离**：在基准方案中，如果提议被接受，就会发生从$X$到$Y$的跳跃。这种情况发生的概率是$p_1 = \\mathbb{E}[\\alpha_1(X,Y)]$。如果提议被拒绝（概率为$1-p_1$），跳跃距离为$0$。给定接受的情况下，期望平方跳跃距离为$J_1$。因此，每次迭代的无条件期望平方跳跃距离是接受概率乘以条件期望平方跳跃距离：\n    $$ \\mathbb{E}_{\\text{baseline}}[\\text{jump}] = p_1 \\cdot J_1 + (1-p_1) \\cdot 0 = p_1 J_1 $$\n-   **每次迭代的期望计算时间**：基准算法总是从$q_1$提议并计算$\\alpha_1$。根据成本模型，这在每次迭代中产生$c_1$的成本。\n    $$ \\mathbb{E}_{\\text{baseline}}[\\text{time}] = c_1 $$\n-   **基准效率**：\n    $$ \\text{Eff}_{\\text{baseline}} = \\frac{p_1 J_1}{c_1} $$\n\n**2. DR算法的效率**\n\n-   **每次迭代的期望平方跳跃距离**：总跳跃是两个互斥事件贡献的总和：阶段1接受和阶段2接受。\n    -   阶段1的跳跃以概率$p_1$发生。该跳跃的期望平方距离为$J_1$。对总期望跳跃的贡献是$p_1 J_1$。\n    -   阶段2的跳跃仅在阶段1被拒绝（概率$1-p_1$）且阶段2被接受（条件概率$p_2$）时发生。阶段2接受的总概率是$(1-p_1)p_2$。该跳跃的期望平方距离为$J_2$。对总期望跳跃的贡献是$(1-p_1)p_2 J_2$。\n    -   总期望平方跳跃距离是这些贡献的总和：\n        $$ \\mathbb{E}_{\\text{DR}}[\\text{jump}] = p_1 J_1 + (1-p_1) p_2 J_2 $$\n-   **每次迭代的期望计算时间**：阶段1的成本$c_1$总是产生。额外的阶段2成本$c_2$仅在阶段1被拒绝时产生，其概率为$1-p_1$。\n    $$ \\mathbb{E}_{\\text{DR}}[\\text{time}] = c_1 + (1-p_1) c_2 $$\n-   **DR算法的效率**：\n    $$ \\text{Eff}_{\\text{DR}} = \\frac{p_1 J_1 + (1-p_1) p_2 J_2}{c_1 + (1-p_1) c_2} $$\n\n**3. 效率增益准则**\n\n如果$\\text{Eff}_{\\text{DR}} > \\text{Eff}_{\\text{baseline}}$，则DR比基准更有效。\n$$ \\frac{p_1 J_1 + (1-p_1) p_2 J_2}{c_1 + (1-p_1) c_2} > \\frac{p_1 J_1}{c_1} $$\n这个不等式是DR提供净效率增益的量化标准。\n\n**4. DR失败案例分析**\n\n我们可以分析推导出的不等式。它表明DR的好处（分子中的$(1-p_1)p_2 J_2$项）必须足够大，以补偿额外的成本（分母中的$(1-p_1)c_2$项）。DR在两种主要情况下可能效率不高：\n-   **增加的跳跃距离很小**：好处来自于$(1-p_1)p_2 J_2$项。如果$q_2$的选择不当，这一项可能会很小。例如，如果$q_2$提议的步长非常小，那么接受的跳跃也会很小，导致$J_2$可以忽略不计。即使接受率$p_2$很高，如果$J_2 \\approx 0$，$\\text{Eff}_{\\text{DR}}$的分子约等于$p_1 J_1$，而分母大于$c_1$。这将使DR效率降低。\n-   **增加的成本很大**：额外的成本由$c_2$驱动。如果生成阶段2提议$Z$并计算$\\alpha_2$的计算成本非常高（例如，需要计算局部Hessian矩阵或求解微分方程），那么$c_2$将会很大。一个大的$c_2$会使分母$c_1 + (1-p_1) c_2$膨胀，这很容易超过增加的跳跃距离带来的好处，使DR效率降低。\n\n### 逐项分析\n\n**A. 如果满足以下条件，DR比基准更有效**\n$$\n\\frac{p_1\\,J_1 + (1-p_1)\\,p_2\\,J_2}{\\,c_1 + (1-p_1)\\,c_2\\,} \\;>\\; \\frac{p_1\\,J_1}{\\,c_1\\,}\n$$。\n**当$q_2$过于局部，使得$J_2$相对于$J_1$可以忽略不计时（例如，一个非常小的步长导致$J_2 \\approx 0$），或者当阶段2的机制大幅增加成本时（例如，由于昂贵的局部曲率计算导致$c_2 \\gg c_1$），DR可能无法提高效率，导致左侧的值低于基准。**\n\n该选项的量化标准与我的推导完全匹配。其对失败模式的定性解释也与我的分析完全一致：如果额外的跳跃距离（$J_2$）太小或额外的成本（$c_2$）太大，效率可能会下降。\n**结论：** 正确。\n\n**B. DR总是能提高效率，因为任何额外的接受都会严格增加单位时间内的期望平方跳跃距离。一个有效的标准是**\n$$\n\\frac{p_1\\,J_1 + p_2\\,J_2}{\\,c_1 + c_2\\,} \\;>\\; \\frac{p_1\\,J_1}{\\,c_1\\,}\n$$，\n**并且没有任何$q_2$的选择或成本$c_2$会使DR比基准更差。**\n\n“DR总是能提高效率”的说法是错误的。它忽略了成本$c_2$。虽然分子（总跳跃）增加了，但分母（总时间）也增加了，其比率可能会减小。所提供的DR效率公式是错误的；它遗漏了关键的$(1-p_1)$因子，这些因子用于缩放第二阶段的贡献。\n**结论：** 不正确。\n\n**C. DR是有益的当且仅当$p_2>p_1$且$c_2<c_1$。这个条件确保了第二阶段比第一阶段更有效，并且成本更低。**\n\n这些是过于简化的启发式方法，不是严格的条件。例如，即使$c_2$略大于$c_1$，如果$J_2$巨大，DR仍然可以是有益的。反之，即使$c_2 < c_1$，如果$p_2$或$J_2$非常小，DR也可能效率低下。将$p_2$与$p_1$进行比较也具有误导性；它们是针对不同提议在不同条件下计算的概率。正确的标准是A中给出的完整权衡。\n**结论：** 不正确。\n\n**D. DR比基准更有效，如果**\n$$\n\\frac{p_1\\,J_1 + (1-p_1)\\,p_2\\,J_2}{\\,c_1 + (1-p_1)\\,c_2\\,} \\;>\\; \\frac{(p_1+p_2)\\,J_1}{\\,c_1+c_2\\,}\n$$。\n**右侧代表一种混合基准。如果$J_2$非常大，那么DR总是优越的。**\n\n左侧是正确的DR效率表达式。然而，右侧是一个无意义的基准。它似乎将两种方案的元素（$p_1, p_2, c_1, c_2, J_1$）随意混合在一起。正确的基准是只涉及阶段1参数的简单Metropolis-Hastings。此外，“如果$J_2$非常大，那么DR总是优越的”这一说法是错误的，因为它忽略了$p_2$和$c_2$。如果$p_2$接近于零或$c_2$是天文数字，那么大的$J_2$也无济于事。\n**结论：** 不正确。", "answer": "$$\\boxed{A}$$", "id": "3302307"}, {"introduction": "从理论到实践的转化充满了挑战，即使对算法有深刻的理解，细微的编程错误也可能破坏MCMC采样器（如延迟接受或延迟拒绝）的可逆性等关键性质。因此，验证实现代码的正确性是至关重要的一步。这项练习探讨了几种强大的诊断工具，可用于测试MCMC代码的正确性，从而确保您的模拟结果真实可靠 [@problem_id:3302329]。这些方法将抽象的细致平衡条件与从MCMC运行轨迹中计算出的具体统计量联系起来。", "problem": "考虑一个混合了两种机制的马尔可夫链蒙特卡洛（MCMC）实现：一个两阶段延迟接受（DA）方案和一个两阶段延迟拒绝（DR）方案。目标分布在 $\\mathbb{R}^d$ 上的未归一化密度为 $\\pi(x)$。在 DA 中，第一阶段的过滤器使用一个计算成本较低的近似 $\\tilde{\\pi}(x)$；在 DR 中，第二阶段的提议是在第一阶段被拒绝的条件下抽取的。该实现链的单步马尔可夫核为 $P(x,dy)$，可能涉及辅助随机性和 DA 与 DR 移动的混合。\n\n根据构造，一个正确实现的 DA 或 DR 算法应保持 $\\pi$ 不变，并且关于 $\\pi$ 是可逆的，即满足细致平衡条件 $\\pi(x) P(x,dy) = \\pi(y) P(y,dx)$。在实践中，编码错误或数值近似可能会使接受概率产生偏差或破坏可逆性。\n\n您的任务是选择有效的诊断方法，以检测此类实现中的偏差或可逆性缺失，并具体说明在单次长运行 $\\{X_t\\}_{t=1}^T$（对于某个大 $T \\in \\mathbb{N}$）上执行这些诊断所需的计算。您可以假设，对于任何记录在案的提议移动，您都可以评估所访问状态下的未归一化目标 $\\pi(x)$、DA 在这些状态下使用的近似目标 $\\tilde{\\pi}(x)$，以及 DR 使用的提议密度 $q_1(x,y)$ 和第二阶段条件提议密度 $q_2(x,y;z)$，对于程序中实际出现的任何三元组 $(x,y,z)$。您也可以假设您可以重新计算代码在提议时使用的任何接受率。除了细致平衡和可逆性的定义之外，不应假设任何进一步的结构公式。\n\n以下哪些是检测偏差或可逆性缺失的有效且信息丰富的诊断方法，以及它们需要哪些计算？\n\nA. 双向复合比率恒等式检查：对于在算法最终接受或拒绝移动的阶段记录的每个提议对 $(x,y)$，计算代码实际使用的复合 Hastings 比率 $R(x,y)$。然后重新计算角色互换后的相同复合比率 $R(y,x)$，使用与代码在 $y$ 处向 $x$ 提议时会出现的相同的特定阶段要素（包括 DA 中的 $\\tilde{\\pi}$ 和 DR 中的条件 $q_2$）。报告所有此类对的算术误差 $E(x,y) = \\log R(x,y) + \\log R(y,x)$ 的分布；在正确实现下，$E(x,y)$ 应在数值精度范围内集中在 $0$ 附近。这需要评估 $x$ 和 $y$ 处的 $\\pi(\\cdot)$ 和 $\\tilde{\\pi}(\\cdot)$，以及代码在 $(x,y)$ 和 $(y,x)$ 的相关阶段使用的所有提议密度。\n\nB. 通过分箱检验经验细致平衡流对称性：将状态空间划分为 $m \\in \\mathbb{N}$ 个不相交的箱子 $\\{B_i\\}_{i=1}^m$。从路径 $\\{X_t\\}$ 中计算计数 $N_i = \\sum_{t=1}^T \\mathbf{1}\\{X_t \\in B_i\\}$ 和 $N_{ij} = \\sum_{t=1}^{T-1} \\mathbf{1}\\{X_t \\in B_i, X_{t+1} \\in B_j\\}$。构造 $\\hat{\\pi}(B_i) = N_i / \\sum_{k=1}^m N_k$ 和 $\\hat{P}(B_i,B_j) = N_{ij}/\\sum_{k=1}^m N_{ik}$。对所有 $i \\neq j$，使用配对 $z$ 检验或卡方拟合优度统计量，其方差通过批均值法从长度为 $b \\in \\mathbb{N}$ 的数据块中估计，来检验零假设约束 $\\hat{\\pi}(B_i)\\hat{P}(B_i,B_j) = \\hat{\\pi}(B_j)\\hat{P}(B_j,B_i)$。显著的偏差表明缺乏可逆性或存在偏差。这只需要计算转移和箱占用数，外加估计抽样变异性。\n\nC. 滞后1交叉矩的时间反演对称性：对于有界测试函数 $f:\\mathbb{R}^d \\to \\mathbb{R}$ 和 $g:\\mathbb{R}^d \\to \\mathbb{R}$，构造反对称统计量 $S_T(f,g) = \\frac{1}{T-1}\\sum_{t=1}^{T-1}\\left[f(X_t)g(X_{t+1}) - f(X_{t+1})g(X_t)\\right]$。在平稳性和可逆性条件下，$\\mathbb{E}[S_T(f,g)] = 0$。为一组函数（例如，坐标投影和低阶多项式）计算 $S_T(f,g)$，通过批均值估计其方差，并构造学生化的 $t$ 统计量来检验其是否等于 $0$。持续的非零值表明缺乏可逆性或存在偏差。这只需要在轨迹上评估 $f$ 和 $g$，以及一个自协方差稳健的方差估计器。\n\nD. 使用感知提议的转移估计对短循环进行柯尔莫哥洛夫循环条件检验：对于从路径中随机抽样的不同状态的三元组 $(x,y,z)$，通过对 $x$ 进行蒙特卡洛条件化来估计您的代码将在这些特定状态之间引导的单步转移质量 $P(x,y)$：从 $x$ 开始，遵循程序的逻辑（包括 DA 过滤器和 DR 第二阶段提议）模拟 $M \\in \\mathbb{N}$ 次模拟提议，当提议是离散时，统计恰好落在 $y$ 的比例；当提议是连续时，统计落在半径为 $\\epsilon > 0$ 的小球 $B_\\epsilon(y)$ 内的比例，再除以相应的小球体积，得到局部密度估计。用同样的方法得到 $\\hat{P}(y,z)$, $\\hat{P}(z,x)$, $\\hat{P}(x,z)$, $\\hat{P}(z,y)$ 和 $\\hat{P}(y,x)$。构造循环和 $C(x,y,z) = \\log \\hat{P}(x,y) + \\log \\hat{P}(y,z) + \\log \\hat{P}(z,x) - \\log \\hat{P}(x,z) - \\log \\hat{P}(z,y) - \\log \\hat{P}(y,x)$。在可逆性条件下，$\\mathbb{E}[C(x,y,z)] = 0$。汇总抽样三元组的 $C(x,y,z)$，并检验其均值是否在蒙特卡洛误差之外显著不为 $0$。这需要从实现的​​代码中进行提议模拟，评估接受决策，并仔细控制 $\\epsilon$ 和 $M$。\n\nE. 分阶段接受率相等：在一个正确实现的 DA 或 DR 中，边际第一阶段接受率必须等于边际第二阶段接受率；因此，通过检查经验第一阶段接受频率是否等于第二阶段接受频率来检验可逆性。如果它们有实质性差异，则断定缺乏可逆性。\n\nF. 通用接受水平：正确实现的可逆高维随机游走方案的最优平均接受率接近 $0.234$。因此，作为可逆性诊断，检查观察到的长期接受率是否约为 $0.234$；否则，结论是该实现存在偏差或不可逆。\n\n选择所有适用项。", "solution": "用户要求评估一个马尔可夫链蒙特卡洛（MCMC）实现的诊断方法，该实现结合了延迟接受（DA）和延迟拒绝（DR）方案。主要目标是检测偏差（未能从目标分布 $\\pi$ 中抽样）或缺乏可逆性。一个旨在从 $\\pi(x)$ 抽样的正确 MCMC 算法必须使 $\\pi$ 成为其平稳分布。虽然可逆性（细致平衡）是实现这一点的充分条件而非必要条件，但它是证明 MCMC 采样器正确性的标准机制。违反关于 $\\pi$ 的细致平衡是实现错误的明确标志，几乎肯定会导致偏差。因此，所提出的诊断方法必须根据其检验可逆性条件的能力进行评估：\n$$\n\\pi(x) P(x,dy) = \\pi(y) P(y,dx)\n$$\n其中 $P(x,dy)$ 是马尔可夫链的转移核。\n\n**问题陈述的验证**\n\n问题陈述是有效的。\n1.  **提取的已知条件**：该设置涉及一个混合 MCMC 算法，使用两阶段 DA 和 DR，目标是 $\\mathbb{R}^d$ 上的未归一化密度 $\\pi(x)$。对于 DA，使用一个计算成本较低的近似 $\\tilde{\\pi}(x)$。任务是给定一个单次长链 $\\{X_t\\}_{t=1}^T$ 以及重新评估算法组件（$\\pi$, $\\tilde{\\pi}$, 提议密度 $q_1$, $q_2$, 和接受率）的能力，识别用于检测偏差或缺乏可逆性的有效诊断方法。\n2.  **科学依据**：该问题在计算统计学和 MCMC 方法的理论中有充分的依据。DA 和 DR 是成熟的技术，可逆性是一个基本概念。\n3.  **适定性和客观性**：该问题是客观的，使用了精确的术语，并且是适定的。它要求从一个列表中识别有效的方法，这是一个可以基于既定原则解决的任务。所提供的假设足以评估各个选项。\n4.  **无缺陷**：该问题不违反任何无效性标准。它在科学上是合理的、可形式化的、完整的、可行的且非平凡的。\n\n进入解决方案。\n\n**选项分析**\n\n**A. 双向复合比率恒等式检查**\n\n该诊断方法提议检查一个支撑任何满足细致平衡的类 Metropolis 算法的基本恒等式。从状态 $x$ 到状态 $y$ 的移动的接受概率 $\\alpha(x,y)$ 通常定义为 $\\alpha(x,y) = \\min(1, R(x,y))$，其中 $R(x,y)$ 是 Hastings 比率。为了使关于 $\\pi$ 的细致平衡成立，该比率必须满足恒等式：\n$$\nR(x,y) = \\frac{\\pi(y) p_{rev}(y,x)}{\\pi(x) p_{fwd}(x,y)}\n$$\n其中 $p_{fwd}(x,y)$ 是从 $x$ 提议 $y$ 的密度，而 $p_{rev}(y,x)$ 是逆向提议的密度。这适用于标准的 Metropolis-Hastings、DA 和 DR，尽管提议密度项可能会变得非常复杂，特别是对于 DR。\n\n根据这个定义，逆向移动的比率为：\n$$\nR(y,x) = \\frac{\\pi(x) p_{rev}(x,y)}{\\pi(y) p_{fwd}(y,x)}\n$$\n等等，符号有点混乱。让我们将从 $x \\to y$ 的移动的提议密度表示为 $q(x,y)$，逆向移动 $y \\to x$ 的提议密度表示为 $q(y,x)$。那么 $R(x,y) = \\frac{\\pi(y)q(y,x)}{\\pi(x)q(x,y)}$。由此直接得出 $R(y,x) = \\frac{\\pi(x)q(x,y)}{\\pi(y)q(y,x)}$。\n因此，对于任何正确构造的比率，以下恒等式必须成立：\n$$\nR(x,y) R(y,x) = 1\n$$\n取对数得到 $\\log R(x,y) + \\log R(y,x) = 0$。选项中定义的量 $E(x,y)$ 正是这个和。\n\n这个测试是强有力的，因为它检查了接受计算的核心逻辑。在指定前向或后向提议密度或目标密度的任何部分出现编码错误，都会导致该恒等式不成立。鉴于问题允许重新计算前向和后向移动所需的所有组件（$\\pi$, $\\tilde{\\pi}$, $q_1$, $q_2$），这个测试是可行的。对于 DA 或 DR 移动，“复合 Hastings 比率”指的是决定最终接受的有效比率，它必须满足此属性。$E(x,y)$ 的值超出数值精度范围而不为零，是违反细致平衡的错误的直接指标。\n\n**结论：正确。**\n\n**B. 通过分箱检验经验细致平衡流对称性**\n\n该诊断方法测试了可逆性的一个宏观结果。细致平衡条件 $\\pi(x)p(x,y) = \\pi(y)p(y,x)$ 意味着对于一个平稳链，在任何给定的时间间隔内，从集合 $B_i$ 到集合 $B_j$ 的预期转移次数等于从集合 $B_j$ 到集合 $B_i$ 的预期转移次数。对于一个长轨迹，我们期望观察到的计数能反映这种对称性。\n\n令 $N_{ij}$ 为从箱 $B_i$ 到箱 $B_j$ 的转移次数。该测试提议检查是否对所有箱对 $(i, j)$ 都有 $N_{ij} \\approx N_{ji}$。选项中的表述是 $\\hat{\\pi}(B_i)\\hat{P}(B_i,B_j) = \\hat{\\pi}(B_j)\\hat{P}(B_j,B_i)$。使用提供的定义，$\\hat{\\pi}(B_i) = N_i / T_{total}$（其中 $T_{total} = \\sum_k N_k$，约等于 $T$）和 $\\hat{P}(B_i,B_j) = N_{ij}/N_i$（因为 $\\sum_k N_{ik} = N_i$，假设链不终止）。\n将这些代入方程得到：\n$$\n\\frac{N_i}{T_{total}} \\frac{N_{ij}}{N_i} = \\frac{N_j}{T_{total}} \\frac{N_{ji}}{N_j} \\implies \\frac{N_{ij}}{T_{total}} = \\frac{N_{ji}}{T_{total}} \\implies N_{ij} = N_{ji}\n$$\n这是一个标准且广泛使用的用于检验可逆性的“黑盒”诊断方法。计数矩阵 $[N_{ij}]$ 与对称性的统计显著偏差是反对可逆性的有力证据。提议使用适当的统计检验（如用于列联表对称性的卡方检验或配对检验）并考虑 MCMC 抽样误差（例如，使用批均值）是合理的统计实践。该诊断仅需要输出链 $\\{X_t\\}$，因此适用范围广。\n\n**结论：正确。**\n\n**C. 滞后1交叉矩的时间反演对称性**\n\n该诊断基于可逆性的另一个直接推论。对于一个平稳马尔可夫链，可逆性等价于 $(X_t, X_{t+1})$ 的联合分布是对称的，即对 $(X_t, X_{t+1})$ 与 $(X_{t+1}, X_t)$ 具有相同的分布。\n令 $(X_t, X_{t+1})$ 在平稳状态下的联合密度为 $\\mu(x,y) = \\pi(x)p(x,y)$，其中 $p(x,y)$ 是转移密度。细致平衡条件是 $\\pi(x)p(x,y) = \\pi(y)p(y,x)$，这正是联合密度对称性的表述：$\\mu(x,y) = \\mu(y,x)$。\n\n鉴于这种对称性，对于任意两个有界测试函数 $f$ 和 $g$，以下成立：\n$$\n\\mathbb{E}[f(X_t)g(X_{t+1})] = \\iint f(x)g(y)\\mu(x,y) dx dy\n$$\n由于 $\\mu(x,y)=\\mu(y,x)$ 的对称性，我们可以在积分表达式中交换 $x$ 和 $y$：\n$$\n\\mathbb{E}[f(X_t)g(X_{t+1})] = \\iint f(y)g(x)\\mu(y,x) dy dx = \\iint g(x)f(y)\\mu(x,y) dx dy = \\mathbb{E}[g(X_t)f(X_{t+1})]\n$$\n提议的统计量是 $S_T(f,g) = \\frac{1}{T-1}\\sum_{t=1}^{T-1}\\left[f(X_t)g(X_{t+1}) - f(X_{t+1})g(X_t)\\right]$。\n其在平稳性和可逆性下的期望是：\n$$\n\\mathbb{E}[S_T(f,g)] = \\mathbb{E}[f(X_t)g(X_{t+1})] - \\mathbb{E}[f(X_{t+1})g(X_t)]\n$$\n从上面的推导来看，这个值不为零。让我重新检查一下我的推理。\n期望 $\\mathbb{E}[f(X_{t+1})g(X_t)]$ 是 $\\iint f(y)g(x)\\mu(x,y) dx dy$。没有理由这会等于 $\\mathbb{E}[f(X_t)g(X_{t+1})]$。\n但是，思考过程中的最初论证是正确的。\n$\\mathbb{E}[S_T(f,g)] = \\iint [f(x)g(y) - f(y)g(x)] \\mu(x,y) dx dy$。\n令 $A(x,y) = f(x)g(y) - f(y)g(x)$。注意 $A(x,y) = -A(y,x)$。\n$\\mathbb{E}[S_T(f,g)] = \\iint A(x,y) \\mu(x,y) dx dy$。\n使用 $\\mu(x,y) = \\mu(y,x)$:\n$\\mathbb{E}[S_T(f,g)] = \\iint A(x,y) \\mu(y,x) dx dy$。\n交换积分变量 $x \\leftrightarrow y$:\n$\\mathbb{E}[S_T(f,g)] = \\iint A(y,x) \\mu(x,y) dy dx = \\iint -A(x,y) \\mu(x,y) dx dy = -\\mathbb{E}[S_T(f,g)]$。\n因此，$2\\mathbb{E}[S_T(f,g)] = 0$，这意味着 $\\mathbb{E}[S_T(f,g)] = 0$。\n因此该测试是有效的。它检验经验滞后1交叉协方差矩阵是否对称。选择一组测试函数（例如，坐标函数 $f(x)=x_i$, $g(x)=x_j$）可以增强诊断的功效。使用如批均值之类的稳健方差估计器是合适的。\n\n**结论：正确。**\n\n**D. 使用感知提议的转移估计对短循环进行柯尔莫哥洛夫循环条件检验**\n\n柯尔莫哥洛夫准则指出，一个马尔可夫链是可逆的，当且仅当对于任何状态循环 $x_1, x_2, \\ldots, x_k, x_1$，沿循环的转移概率乘积等于沿反向路径的乘积：\n$$\nP(x_1, x_2) P(x_2, x_3) \\cdots P(x_k, x_1) = P(x_1, x_k) \\cdots P(x_3, x_2) P(x_2, x_1)\n$$\n对于连续状态空间，这用转移密度 $p(x,y)$ 表示。对于一个 3-循环 $(x,y,z)$，这变成 $p(x,y)p(y,z)p(z,x) = p(x,z)p(z,y)p(y,x)$。对这个条件的检验是可逆性的直接检验。\n\n提议的诊断方法是估计来自路径的状态三元组的转移密度 $p(\\cdot, \\cdot)$，并检查对数比率。估计方法是从一个状态 $x$ 开始，使用实际编码的算法运行许多“模拟提议”，并计算落在一个目标状态 $y$ 周围小球 $B_\\epsilon(y)$ 内的比例。这提供了 $\\hat{p}(x,y)$ 的一个估计。这是一种有效的、尽管计算上极其密集的探测转移核的方法。它属于“白盒”测试的范畴，因为它需要访问采样器内部的逻辑。主要挑战是实践上的：在高维空间中，转移到任何小的固定体积的概率是无穷小的，这使得所需的模拟提议次数 $M$ 变得高得令人望而却步。$\\epsilon$ 的选择也很微妙。然而，作为一个诊断方法的理论原则，它是完全有效的。问题要求的是*有效且信息丰富*的诊断方法，不一定是计算效率高的方法。这个测试信息量很大，因为它直接检查了微观动力学。\n\n**结论：正确。**\n\n**E. 分阶段接受率相等**\n\n该选项声称，对于一个正确的 DA 或 DR 实现，第一阶段的边际接受率必须等于第二阶段的边际接受率。这显然是错误的。\n在 DA 中，第一阶段使用一个近似密度 $\\tilde{\\pi}$ 作为廉价过滤器，而第二阶段提供校正以确保最终目标是真实的 $\\pi$。相对接受率 $\\bar{\\alpha}_1$ 和 $\\bar{\\alpha}_2$ 完全取决于近似 $\\tilde{\\pi}(x)$ 相对于 $\\pi(x)$ 的质量。如果 $\\tilde{\\pi}$ 是一个非常好的近似，$\\bar{\\alpha}_1$ 可能很高，$\\bar{\\alpha}_2$ 也会很高。如果 $\\tilde{\\pi}$ 是一个差的近似，一个接受率可能高而另一个低以作补偿。没有任何物理或数学原理强迫它们相等。\n在 DR 中，第二阶段仅在第一阶段被拒绝时才被调用。它是一个完全不同的提议机制，旨在给链提供另一个移动的机会。接受率由不同的提议密度和接受率决定。没有理由期望它们相等。\n这个诊断是基于这些算法的一个虚构属性。\n\n**结论：不正确。**\n\n**F. 通用接受水平**\n\n该选项提议使用约 $0.234$ 的理论最优平均接受率作为正确性的基准。这个值源于对特定算法的分析：随机游走 Metropolis（RWM）算法，并且是在高维（$d \\to \\infty$）目标密度是 i.i.d. 分量乘积的假设下得出的。\n问题中描述的 MCMC 方案要通用得多。它可以有任意的提议机制（不一定是随机游走）和任意的目标密度（不一定是 i.i.d.）。DA 和 DR 框架可以应用于多种类型的提议。\n此外，$0.234$ 这个值是关于采样器*效率*（最优混合）的结果，而不是其*正确性*（可逆性或无偏性）。一个完全正确且可逆的采样器可以被调整到使其接受率远非 $0.234$；它只会变得低效。反之，一个不正确、不可逆的采样器可能偶然地具有 $0.234$ 的接受率。因此，这不是一个检测偏差或缺乏可逆性的有效诊断方法。\n\n**结论：不正确。**\n\n**最终结论**\n\n选项 A、B、C 和 D 描述了用于测试可逆性并因此检测 MCMC 实现中潜在偏差的有效诊断方法。选项 E 和 F 基于不正确的假设。", "answer": "ABCD", "id": "3302329"}]}