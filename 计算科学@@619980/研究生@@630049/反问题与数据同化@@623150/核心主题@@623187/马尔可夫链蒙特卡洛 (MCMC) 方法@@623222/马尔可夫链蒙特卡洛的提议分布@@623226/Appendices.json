{"hands_on_practices": [{"introduction": "在设计复杂的提议分布之前，我们必须首先学会如何通过MCMC采样器的输出来诊断其性能。迹图（trace plot）是最基本的可视化诊断工具，它展示了参数样本随迭代次数的演变过程。这项练习将挑战你解读一种常见的迹图模式，并将其与目标分布的特性及采样器的效率联系起来，这是评估MCMC结果的关键第一步。[@problem_id:1932803]", "problem": "一位统计学家正在使用马尔可夫链蒙特卡洛（MCMC）方法从参数 $\\theta$ 的一维后验概率分布中生成样本。在运行采样器大量迭代并丢弃用于“老化”（burn-in）的初始样本集后，他们检查了剩余样本的轨迹图（trace plot）。该图显示了每次迭代中 $\\theta$ 的值。他们观察到链并没有围绕一个单一的中心值徘徊。相反，$\\theta$ 的采样值在两个截然不同的狭窄区域之间持续且频繁地来回跳跃：一个区域以 $\\theta = -5.2$ 附近为中心，另一个以 $\\theta = 2.8$ 附近为中心。这两个区域之间的转换是突然的，并且在整个采样过程中发生了很多次。\n\n下列哪个陈述对这一观察结果提供了最准确的解释？\n\nA. MCMC 采样器未能收敛到平稳分布。必须增加“老化”期（burn-in）的长度。\n\nB. $\\theta$ 的后验分布很可能是双峰的，并且采样器表现良好，成功地探索了分布的两个峰。\n\nC. 样本表现出极高的自相关性，这表明采样器混合得非常差并且被卡住了。\n\nD. 后验分布高度偏斜，采样器难以探索分布的长尾。\n\nE. MCMC 算法使用的提议分布（proposal distribution）方差太小，导致链无法有效探索参数空间。", "solution": "我们在“老化”期（burn-in）后，根据向平稳目标分布 $\\pi(\\theta \\mid \\text{data})$ 的收敛情况来解释 MCMC 轨迹。如果链已经收敛，样本的经验分布应该反映 $\\pi(\\theta \\mid \\text{data})$ 的特征。当 $\\pi(\\theta \\mid \\text{data})$ 是双峰的，且峰值位于两个分离的区域附近时，一个混合良好的链通常会表现为在每个峰周围形成值的聚类，并在分隔两个峰的低概率谷之间进行转换。\n\n观察结果表明，在“老化”期后，链并未围绕单个中心值徘徊；相反，它在 $\\theta=-5.2$ 和 $\\theta=2.8$ 附近的两个狭窄区域之间频繁而突然地交替，并且在整个采样过程中有许多转换。这些特征表明：\n- 目标分布中有两个明显的高密度区域，这与双峰后验分布一致。\n- 频繁的转换意味着采样器没有被卡住，并且正在充分探索两个峰，这是跨峰混合可接受的标志，而不是混合不良。\n\n我们现在评估每个选项：\n- A：“未能收敛；增加‘老化’期。” 这是不可能的，因为对两个区域的持续访问和频繁转换表明平稳分布本身就有两个峰。增加“老化”期不会消除真正的双峰性。\n- B：“后验分布很可能是双峰的；采样器成功地探索了两个峰。” 这直接符合轨迹的特征：两个狭窄的聚类和频繁的切换表明后验分布是双峰的，并且对两个峰的探索是令人满意的。\n- C：“极高的自相关性；混合差且链被卡住。” 高自相关性和被卡住会导致链长时间困在单个区域内，转换很少。观察报告中有很多转换，这与该说法相矛盾。\n- D：“高度偏斜的后验分布，带有长尾。” 单个偏斜分布通常不会产生两个截然不同的狭窄聚类；相反，它会显示一个单峰，并向尾部有延伸的偏移。\n- E：“提议分布的方差太小。” 太小的提议分布方差会导致微小的局部移动，难以在分离良好的区域之间穿梭，从而导致转换稀少，而不是在峰之间频繁、突然地跳跃。\n\n因此，最准确的解释是后验分布是双峰的，并且采样器正在有效地探索两个峰。", "answer": "$$\\boxed{B}$$", "id": "1932803"}, {"introduction": "从诊断“什么”是好的采样，我们转向“如何”实现它。随机游走Metropolis (RWM) 算法是MCMC方法的基石，但其性能，尤其是在高维问题中，对提议步长（proposal step size）的选择极为敏感。这项练习将引导你通过一个经典的理论推导来确定最优的提议尺度，从而揭示MCMC理论中的一个著名结果，并让你亲身体会理论分析如何指导实践。[@problem_id:3415063]", "problem": "考虑一个线性逆问题，其具有高斯先验和加性高斯观测噪声，从而得到状态向量 $x \\in \\mathbb{R}^{d}$ 上的高斯后验，其均值为 $\\mu$，协方差矩阵为 $C \\in \\mathbb{R}^{d \\times d}$，即后验密度为 $\\pi(x) = \\mathcal{N}(\\mu, C)$。您希望使用马尔可夫链蒙特卡洛 (MCMC) 方法，特别是随机游走 Metropolis (RWM) 算法，从 $\\pi(x)$ 中采样，其对称高斯提议的形式为\n$$\nq(x' \\mid x) = \\mathcal{N}\\big(x, \\Sigma_{\\text{prop}}\\big), \\quad \\Sigma_{\\text{prop}} = s^{2} C,\n$$\n其中 $s > 0$ 是一个标量步长，$C$ 作为针对后验协方差结构的预条件子。\n\n使用白化坐标变换 $u = C^{-1/2}(x - \\mu)$，使得目标分布变为标准高斯分布 $\\mathcal{N}(0, I_{d})$，在白化坐标下的提议为 $u' = u + s z$，其中 $z \\sim \\mathcal{N}(0, I_{d})$。在高维情况下，为了避免接受概率消失或爆炸，通常考虑缩放 $s = \\ell / \\sqrt{d}$，其中 $\\ell > 0$ 是一个无量纲步长常数。\n\n从随机游走 Metropolis 接受概率的基本定义和对大 $d$ 有效的渐近分布近似出发，推导大 $d$ 情况下的近似接受概率作为 $\\ell$ 的函数，然后基于白化坐标中的期望平方跳跃距离 (ESJD) 定义一个效率度量。确定使该效率最大化的 $\\ell$ 值，从而获得原始坐标下的最优提议协方差 $\\Sigma_{\\text{prop}}^{\\star}$，作为 $d$ 和 $C$ 的函数。\n\n将您的最终答案 $\\Sigma_{\\text{prop}}^{\\star}$ 表示为关于 $d$ 和 $C$ 的单一闭式表达式，其中最优步长常数 $\\ell^{\\star}$ 四舍五入到三位有效数字。最终表达式不需要单位。", "solution": "我们首先回顾对称提议下的随机游走 Metropolis (RWM) 接受概率。给定当前状态 $x$ 和提议状态 $x'$，接受概率为\n$$\n\\alpha(x, x') = \\min\\Big(1, \\frac{\\pi(x')}{\\pi(x)}\\Big).\n$$\n对于高斯目标 $\\pi(x) = \\mathcal{N}(\\mu, C)$，在白化坐标 $u = C^{-1/2}(x - \\mu)$ 下工作很方便，这样目标密度变为 $\\pi(u) \\propto \\exp\\big(-\\|u\\|^{2}/2\\big)$，即标准高斯分布 $\\mathcal{N}(0, I_{d})$。提议取为\n$$\nu' = u + s z, \\quad z \\sim \\mathcal{N}(0, I_{d}).\n$$\n为了在维度 $d$ 增长时获得接受概率的非退化极限，我们采用缩放\n$$\ns = \\frac{\\ell}{\\sqrt{d}},\n$$\n其中 $\\ell > 0$ 是一个待确定的无量纲步长常数。\n\n在白化坐标中的接受率为\n$$\nr(u, u') = \\frac{\\pi(u')}{\\pi(u)} = \\exp\\Big(-\\frac{1}{2}\\big(\\|u'\\|^{2} - \\|u\\|^{2}\\big)\\Big).\n$$\n定义提议增量 $\\delta = u' - u = s z = \\frac{\\ell}{\\sqrt{d}} z$。那么\n$$\n\\|u'\\|^{2} - \\|u\\|^{2} = \\|u + \\delta\\|^{2} - \\|u\\|^{2} = 2 u \\cdot \\delta + \\|\\delta\\|^{2},\n$$\n因此对数接受率为\n$$\nA = \\ln r(u, u') = - u \\cdot \\delta - \\frac{1}{2} \\|\\delta\\|^{2} = - \\frac{\\ell}{\\sqrt{d}} u \\cdot z - \\frac{1}{2} \\frac{\\ell^{2}}{d} \\|z\\|^{2}.\n$$\n我们在 $d \\to \\infty$ 的极限下分析 $A$。由于 $u \\sim \\mathcal{N}(0, I_{d})$ 和 $z \\sim \\mathcal{N}(0, I_{d})$ 是独立的，我们考虑随机和\n$$\n\\frac{1}{\\sqrt{d}} u \\cdot z = \\frac{1}{\\sqrt{d}} \\sum_{i=1}^{d} u_{i} z_{i}.\n$$\n根据独立性和标准高斯性质，项 $u_{i} z_{i}$ 是独立的、均值为零且方差为 1。根据中心极限定理 (CLT)，我们有\n$$\n\\frac{1}{\\sqrt{d}} u \\cdot z \\Rightarrow W \\sim \\mathcal{N}(0, 1),\n$$\n当 $d \\to \\infty$ 时。此外，根据大数定律，当 $d \\to \\infty$ 时，$\\|z\\|^{2}/d \\to 1$ 几乎必然成立。因此，在大 $d$ 极限下，对数接受率依分布收敛于\n$$\nA \\Rightarrow - \\ell W - \\frac{\\ell^{2}}{2}, \\quad W \\sim \\mathcal{N}(0, 1).\n$$\n接受概率，在 $u$ 的平稳分布和提议 $z$ 上取平均后，收敛于\n$$\n\\alpha(\\ell) = \\mathbb{E}\\big[ \\min\\big(1, \\exp(A)\\big) \\big] = \\mathbb{E}\\big[ \\min\\big(1, \\exp(- \\ell W - \\frac{\\ell^{2}}{2})\\big) \\big],\n$$\n其中 $W \\sim \\mathcal{N}(0, 1)$。我们显式地计算这个期望。令 $\\phi(w) = \\frac{1}{\\sqrt{2\\pi}} \\exp(-w^{2}/2)$ 表示标准正态概率密度函数 (PDF)，$\\Phi$ 为其累积分布函数 (CDF)。观察到\n$$\n\\min\\big(1, \\exp(- \\ell W - \\frac{\\ell^{2}}{2})\\big) =\n\\begin{cases}\n1,  \\text{if } - \\ell W - \\frac{\\ell^{2}}{2} \\ge 0 \\iff W \\le - \\frac{\\ell}{2}, \\\\\n\\exp(- \\ell W - \\frac{\\ell^{2}}{2}),  \\text{if } W > - \\frac{\\ell}{2}.\n\\end{cases}\n$$\n因此\n$$\n\\alpha(\\ell) = \\int_{-\\infty}^{- \\ell/2} \\phi(w) \\, dw + \\int_{- \\ell/2}^{\\infty} \\exp\\Big(- \\ell w - \\frac{\\ell^{2}}{2}\\Big) \\phi(w) \\, dw.\n$$\n注意到\n$$\n\\exp\\Big(- \\ell w - \\frac{\\ell^{2}}{2}\\Big) \\phi(w) = \\frac{1}{\\sqrt{2\\pi}} \\exp\\Big( - \\frac{w^{2}}{2} - \\ell w - \\frac{\\ell^{2}}{2} \\Big) = \\frac{1}{\\sqrt{2\\pi}} \\exp\\Big( - \\frac{(w + \\ell)^{2}}{2} \\Big) = \\phi(w + \\ell).\n$$\n因此，\n$$\n\\alpha(\\ell) = \\Phi\\Big( - \\frac{\\ell}{2} \\Big) + \\int_{- \\ell/2}^{\\infty} \\phi(w + \\ell) \\, dw = \\Phi\\Big( - \\frac{\\ell}{2} \\Big) + \\int_{\\ell/2}^{\\infty} \\phi(u) \\, du = \\Phi\\Big( - \\frac{\\ell}{2} \\Big) + \\big(1 - \\Phi(\\ell/2)\\big).\n$$\n使用对称性 $\\Phi(-a) = 1 - \\Phi(a)$，我们得到\n$$\n\\alpha(\\ell) = 2 \\Phi\\Big( - \\frac{\\ell}{2} \\Big).\n$$\n\n现在我们基于白化坐标中的期望平方跳跃距离 (ESJD) 来定义效率度量。平方跳跃长度为 $\\|\\delta\\|^{2} = \\frac{\\ell^{2}}{d} \\|z\\|^{2}$，对于大的 $d$ 有 $\\|z\\|^{2} \\approx d$。因此，白化坐标中的 ESJD 渐近地为\n$$\nJ(\\ell) = \\mathbb{E}\\big[ \\|\\delta\\|^{2} \\, \\text{accept} \\big] \\approx \\ell^{2} \\, \\alpha(\\ell) = \\ell^{2} \\cdot 2 \\Phi\\Big( - \\frac{\\ell}{2} \\Big).\n$$\n我们寻求使 $J(\\ell)$ 最大化的 $\\ell^{\\star}$。求导：\n$$\n\\alpha(\\ell) = 2 \\Phi\\Big( - \\frac{\\ell}{2} \\Big), \\quad \\alpha'(\\ell) = 2 \\cdot \\Big( - \\frac{1}{2} \\Big) \\phi\\Big( \\frac{\\ell}{2} \\Big) = - \\phi\\Big( \\frac{\\ell}{2} \\Big).\n$$\n因此\n$$\nJ'(\\ell) = 2 \\ell \\alpha(\\ell) + \\ell^{2} \\alpha'(\\ell) = 2 \\ell \\cdot 2 \\Phi\\Big( - \\frac{\\ell}{2} \\Big) - \\ell^{2} \\phi\\Big( \\frac{\\ell}{2} \\Big).\n$$\n令 $J'(\\ell) = 0$ 并除以 $\\ell > 0$ 得到一阶条件\n$$\n4 \\Phi\\Big( - \\frac{\\ell}{2} \\Big) = \\ell \\, \\phi\\Big( \\frac{\\ell}{2} \\Big).\n$$\n这个超越方程有一个唯一的正解 $\\ell^{\\star}$，我们通过数值方法确定它。使用标准的求根方法（例如，牛顿法）应用于\n$$\nf(\\ell) = \\ell \\, \\phi\\Big( \\frac{\\ell}{2} \\Big) - 4 \\Phi\\Big( - \\frac{\\ell}{2} \\Big),\n$$\n我们发现\n$$\n\\ell^{\\star} \\approx 2.38,\n$$\n对应的最优接受率为\n$$\n\\alpha(\\ell^{\\star}) = 2 \\Phi\\Big( - \\frac{\\ell^{\\star}}{2} \\Big) \\approx 2 \\Phi(-1.19) \\approx 0.234,\n$$\n这是 RWM 在高维情况下一个众所周知的近优接受率。\n\n映射回原始坐标，最优缩放为 $s^{\\star} = \\ell^{\\star}/\\sqrt{d}$，最优提议协方差为\n$$\n\\Sigma_{\\text{prop}}^{\\star} = (s^{\\star})^{2} C = \\frac{\\ell^{\\star 2}}{d} \\, C.\n$$\n将 $\\ell^{\\star}$ 四舍五入到三位有效数字，最优协方差为\n$$\n\\Sigma_{\\text{prop}}^{\\star} = \\frac{(2.38)^{2}}{d} \\, C.\n$$\n这一选择在最大化随机游走 Metropolis 算法（针对协方差为 $C$ 的 $d$ 维高斯后验）的渐近 ESJD 的意义上，实现了近乎最优的效率。", "answer": "$$\\boxed{\\frac{(2.38)^{2}}{d}\\,C}$$", "id": "3415063"}, {"introduction": "为了提高采样效率，我们可以采用更复杂的提议机制，例如使用梯度信息的Metropolis调整的朗之万算法 (MALA)。虽然这些方法通常在统计上更高效（即需要更少的迭代次数来收敛），但它们每一步的计算成本也更高。这项练习在一个常见的偏微分方程（PDE）约束反演问题的背景下，量化了随机游走与MALA提议之间的计算成本权衡，这是一个在实际应用中至关重要的考量。[@problem_id:3415120]", "problem": "考虑一个受偏微分方程（PDE）约束的贝叶斯逆问题，其中未知参数场 $m$ 通过状态方程 $A(m) u = f$（在一个有界域上，具有适当的边界条件）进入由算子 $A(m)$ 定义的正向模型。观测值由 $d = S u + \\varepsilon$ 给出，其中 $S$ 是一个线性观测算子，$\\varepsilon$ 是加性观测噪声，其被建模为均值为零、协方差矩阵为 $\\Gamma$ 的高斯分布。参数 $m$ 的对数后验密度由对数先验和源自高斯似然的数据失配项之和定义，因此在给定的 $m$ 处评估对数后验需要求解正向PDE以得到 $u$。\n\n在马尔可夫链蒙特卡洛（MCMC; Markov chain Monte Carlo）方法中，考虑使用两种提议机制在参数空间中生成新状态：\n\n- 随机游走提议，使用对称高斯增量，不使用梯度。\n- Metropolis调整的朗之万算法（MALA; Metropolis Adjusted Langevin Algorithm），该算法使用对数后验关于 $m$ 的梯度来构建漂移项。\n\n为在PDE约束的设定下计算对数后验关于 $m$ 的梯度，假设采用标准的伴随状态法：在给定参数 $m$ 处的当前正向解 $u$ 的情况下，求解伴随PDE以获得伴随状态 $p$，然后据此组装出 $\\nabla \\log \\pi(m \\mid d)$。假设以下成本模型：\n\n- 单次求解正向PDE的计算成本为 $C_f$。\n- 单次求解伴随PDE的计算成本为 $C_a$。\n- 与PDE求解相比，所有其他操作（组装、向量代数、从高斯分布中抽样以及先验的评估）的成本可忽略不计。\n\n假设以下缓存策略和接受率计算方法，与Metropolis–Hastings算法一致：\n\n- 在每次迭代中，当前参数 $m$ 处的正向解 $u$ 和对数后验值已从上一个被接受的步骤中获得，因此是可用的。\n- 对于随机游走提议，生成一个提议 $y$ 不需要梯度评估，其接受概率取决于在 $y$ 处评估对数后验，这需要一次对 $u(y)$ 的正向求解。\n- 对于步长为 $h$ 的MALA提议，提议按 $y = x + \\frac{h}{2} \\nabla \\log \\pi(x \\mid d) + \\sqrt{h} \\, \\eta$ 抽取，其中 $\\eta$ 是参数空间中的一个标准高斯变量。Metropolis–Hastings接受率同时涉及 $\\log \\pi(y \\mid d)$ 和逆向提议密度 $q(x \\mid y)$，后者需要计算 $\\nabla \\log \\pi(y \\mid d)$，因此需要在 $y$ 处进行一次伴随求解。在给定已缓存的正向解的情况下，计算当前状态 $x$ 的 $\\nabla \\log \\pi(x \\mid d)$ 需要在 $x$ 处进行一次伴随求解。\n\n在这些假设下，推导MALA算法每个提议的计算成本与随机游走提议的计算成本之比的闭式表达式，该表达式仅用 $C_f$ 和 $C_a$ 表示。请将您的最终答案以单个解析表达式的形式给出。不需要四舍五入，最终答案中也不需要单位。", "solution": "目标是确定在PDE约束的贝叶斯逆问题背景下，Metropolis调整的朗之万算法（MALA）与标准随机游走（RW）Metropolis算法的单位提议计算成本之比。成本需用单次正向PDE求解的成本（记为 $C_f$）和单次伴随PDE求解的成本（记为 $C_a$）来表示。所有其他计算成本均假定可以忽略不计。\n\n首先，我们分析随机游走Metropolis算法每个提议的计算成本。设马尔可夫链的当前状态为 $m$。问题陈述指出，正向解 $u(m)$ 和对数后验 $\\log \\pi(m \\mid d)$ 在上一个被接受的步骤中已经计算并缓存。\n1.  从一个对称分布中生成一个提议 $y$，例如 $y = m + \\eta$，其中 $\\eta$ 是从一个零均值高斯分布中抽取的样本。根据问题陈述，此步骤的成本可以忽略不计。\n2.  为了计算Metropolis-Hastings接受概率 $\\alpha = \\min\\left(1, \\frac{\\pi(y \\mid d)}{\\pi(m \\mid d)}\\right)$，我们需要评估提议状态 $y$ 处的后验密度。这涉及到计算 $\\log \\pi(y \\mid d)$。\n3.  问题陈述指出，在给定参数下评估对数后验需要求解正向PDE。因此，要计算 $\\log \\pi(y \\mid d)$，必须首先求解状态方程 $A(y)u = f$ 以获得状态 $u(y)$。\n4.  这次单次正向PDE求解的成本为 $C_f$。\n5.  所有后续操作（例如，计算数据失配、评估先验、为接受检验抽取随机数）均假定成本可以忽略不计。\n\n因此，随机游走Metropolis算法每个提议的总计算成本，记为 $\\text{Cost}_{\\text{RW}}$，主要由单次正向PDE求解决定。\n$$\n\\text{Cost}_{\\text{RW}} = C_f\n$$\n\n接下来，我们分析Metropolis调整的朗之万算法（MALA）每个提议的计算成本。设链的当前状态为 $x$。同前，正向解 $u(x)$ 和对数后验 $\\log \\pi(x \\mid d)$ 是已缓存的。\n1.  使用基于梯度的漂移项生成提议 $y$：$y = x + \\frac{h}{2} \\nabla \\log \\pi(x \\mid d) + \\sqrt{h} \\, \\eta$。要构建此提议，必须计算当前状态下的对数后验梯度 $\\nabla \\log \\pi(x \\mid d)$。\n2.  问题指定使用伴随状态法进行此梯度计算。由于正向解 $u(x)$ 已经可用（已缓存），计算梯度仅需单次求解伴随PDE。此操作的成本为 $C_a$。\n3.  计算梯度后，形成提议 $y$。此过程的代数运算成本可以忽略不计。\n4.  MALA的Metropolis-Hastings接受概率为 $\\alpha = \\min\\left(1, \\frac{\\pi(y \\mid d) q(x \\mid y)}{\\pi(x \\mid d) q(y \\mid x)}\\right)$。为了评估此比率，我们需要计算两项：提议处的对数后验 $\\log \\pi(y \\mid d)$ 和逆向提议密度 $q(x \\mid y)$。\n5.  为了评估 $\\log \\pi(y \\mid d)$，我们必须像随机游走情况一样，在 $y$ 处求解正向PDE以获得 $u(y)$。这次正向求解的成本为 $C_f$。\n6.  为了评估逆向提议密度 $q(x \\mid y)$，我们必须计算从 $y$ 开始的提议的漂移项。该漂移项依赖于提议状态处的梯度 $\\nabla \\log \\pi(y \\mid d)$。\n7.  为了使用伴随状态法计算 $\\nabla \\log \\pi(y \\mid d)$，我们需要正向解 $u(y)$ 和相应的伴随解 $p(y)$。正向解 $u(y)$ 已在上一步中计算（成本为 $C_f$）。因此，我们现在只需在状态 $y$ 处求解伴随PDE。第二次伴随求解的成本为 $C_a$。\n\n总结单个MALA提议的主要操作成本：\n- 在当前状态 $x$ 进行一次伴随求解以计算提议漂移：$C_a$。\n- 在提议状态 $y$ 进行一次正向求解以评估后验：$C_f$。\n- 在提议状态 $y$ 进行一次伴随求解以计算逆向提议密度：$C_a$。\n\nMALA算法每个提议的总计算成本，记为 $\\text{Cost}_{\\text{MALA}}$，是这些成本的总和。\n$$\n\\text{Cost}_{\\text{MALA}} = C_a + C_f + C_a = C_f + 2C_a\n$$\n\n最后，我们计算所需的MALA与随机游走提议的单位提议计算成本之比。\n$$\n\\frac{\\text{Cost}_{\\text{MALA}}}{\\text{Cost}_{\\text{RW}}} = \\frac{C_f + 2C_a}{C_f}\n$$", "answer": "$$\n\\boxed{\\frac{C_f + 2C_a}{C_f}}\n$$", "id": "3415120"}]}