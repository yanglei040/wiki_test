{"hands_on_practices": [{"introduction": "计算溶剂化自由能是理解溶质-溶剂相互作用的核心任务。热力学积分 (Thermodynamic Integration, TI) 是一种基于第一性原理的强大方法，用于精确计算自由能变。本练习 [@problem_id:3488293] 将指导您通过数值方法实现热力学积分，并利用分步炼金术解耦方案，将总溶剂化自由能分解为物理上清晰的静电和范德华贡献。通过处理模拟生成的假设数据，您将掌握连接理论概念与实际计算的关键技能。", "problem": "您的任务是将一个分阶段的炼金术解耦方案转换成一个数值算法，用以分离极性和非极性溶剂化贡献。该物理系统是一个溶剂化的溶质，炼金术方案分两个阶段关闭相互作用：首先是静电（库仑）相互作用，然后是范德华（Lennard-Jones）相互作用。您的程序将根据预先计算的势能对炼金术耦合参数的导数的系综平均值，为几个测试用例计算溶剂化自由能的贡献。最终结果必须以千焦/摩尔为单位表示，并四舍五入到三位小数。\n\n基本原理。使用正则系综中亥姆霍兹自由能及其耦合参数导数的定义。设亥姆霍兹自由能为 $F(\\lambda) = -k_{\\mathrm{B}} T \\ln Z(\\lambda)$，其中 $Z(\\lambda)$ 是逆温度 $\\beta = 1/(k_{\\mathrm{B}} T)$ 下的正则配分函数，而 $U(\\mathbf{x}; \\lambda)$ 是依赖于耦合参数 $\\lambda \\in [0,1]$ 的势能。其导数由经过充分检验的热力学积分恒等式 $dF/d\\lambda = \\langle \\partial U/\\partial \\lambda \\rangle_{\\lambda}$ 给出，其中平均值是在固定 $\\lambda$ 的正则系综上计算的。在一个分阶段的方案中，静电和范德华相互作用具有独立的耦合参数，且势能可以加性分解，总的可逆功是 $dF$ 沿分段路径的曲线积分。对于一条路径，首先将静电耦合参数 $\\lambda_{\\mathrm{elec}}$ 从 $0$ 变到 $1$，此时固定 $\\lambda_{\\mathrm{vdW}} = 0$，然后将 $\\lambda_{\\mathrm{vdW}}$ 从 $0$ 变到 $1$，此时固定 $\\lambda_{\\mathrm{elec}} = 1$，总变化是两个积分之和：\n$$\n\\Delta F_{\\mathrm{total}} = \\int_{0}^{1} \\left\\langle \\frac{\\partial U}{\\partial \\lambda_{\\mathrm{elec}}} \\right\\rangle_{\\lambda_{\\mathrm{elec}}} d\\lambda_{\\mathrm{elec}}\n\\;+\\;\n\\int_{0}^{1} \\left\\langle \\frac{\\partial U}{\\partial \\lambda_{\\mathrm{vdW}}} \\right\\rangle_{\\lambda_{\\mathrm{vdW}}} d\\lambda_{\\mathrm{vdW}}\n\\equiv \\Delta F_{\\mathrm{elec}} + \\Delta F_{\\mathrm{vdW}}.\n$$\n您的任务是使用所提供的数据点为每个积分实现数值积分。\n\n数值方法要求。给定一组 $N$ 个点 $\\{(\\lambda_i, y_i)\\}_{i=0}^{N-1}$，其中 $y_i = \\left\\langle \\partial U/\\partial \\lambda \\right\\rangle_{\\lambda_i}$ 的单位为 $\\mathrm{kJ/mol}$：\n- 如果 $\\lambda_i$ 是等间距的，并且 $N$ 是奇数（即子区间的数量为偶数），则使用复合辛普森法则：\n$$\n\\int_{\\lambda_0}^{\\lambda_{N-1}} y(\\lambda)\\, d\\lambda \\approx \\frac{h}{3} \\left[ y_0 + y_{N-1} + 4 \\sum_{j=1,\\,\\text{odd}}^{N-2} y_j + 2 \\sum_{j=2,\\,\\text{even}}^{N-3} y_j \\right]\n$$\n其中对于所有 $i$，$h = \\lambda_{i+1} - \\lambda_i$。\n- 否则，在非均匀网格上使用复合梯形法则：\n$$\n\\int_{\\lambda_0}^{\\lambda_{N-1}} y(\\lambda)\\, d\\lambda \\approx \\sum_{i=0}^{N-2} \\frac{(\\lambda_{i+1}-\\lambda_i)}{2}\\, (y_{i+1} + y_i).\n$$\n为判断是否为等间距，如果所有连续差分的绝对值之差在 $10^{-12}$ 的绝对容差范围内相等，则将网格视为均匀的。\n\n测试套件。对于下面的每个测试用例，都给出了两个数据集：一个用于静电阶段，另一个用于范德华阶段。每个数据集都指定了 $\\lambda$ 网格和相应的系综平均值 $\\left\\langle \\partial U/\\partial \\lambda \\right\\rangle_{\\lambda}$（单位为 $\\mathrm{kJ/mol}$）。计算每个案例的 $\\Delta F_{\\mathrm{elec}}$、$\\Delta F_{\\mathrm{vdW}}$ 和 $\\Delta F_{\\mathrm{total}} = \\Delta F_{\\mathrm{elec}} + \\Delta F_{\\mathrm{vdW}}$。所有最终答案都以 $\\mathrm{kJ/mol}$ 为单位，并四舍五入到三位小数。\n\n- 测试用例 $1$（两个网格均为均匀网格；两者都应适用复合辛普森法则）：\n  - 静电阶段：\n    - $\\lambda_{\\mathrm{elec}} = [\\,0.0,\\,0.25,\\,0.5,\\,0.75,\\,1.0\\,]$\n    - $y_{\\mathrm{elec}} = [\\,0.0,\\,2.0,\\,4.0,\\,2.0,\\,0.0\\,]$\n  - 范德华阶段：\n    - $\\lambda_{\\mathrm{vdW}} = [\\,0.0,\\,\\tfrac{1}{6},\\,\\tfrac{2}{6},\\,\\tfrac{3}{6},\\,\\tfrac{4}{6},\\,\\tfrac{5}{6},\\,1.0\\,]$\n    - $y_{\\mathrm{vdW}} = [\\,0.0,\\,3.0,\\,5.0,\\,6.0,\\,5.0,\\,3.0,\\,0.0\\,]$\n\n- 测试用例 $2$（静电阶段恒为零；范德华网格非均匀；对范德华阶段使用复合梯形法则）：\n  - 静电阶段：\n    - $\\lambda_{\\mathrm{elec}} = [\\,0.0,\\,0.5,\\,1.0\\,]$\n    - $y_{\\mathrm{elec}} = [\\,0.0,\\,0.0,\\,0.0\\,]$\n  - 范德华阶段：\n    - $\\lambda_{\\mathrm{vdW}} = [\\,0.0,\\,0.1,\\,0.4,\\,1.0\\,]$\n    - $y_{\\mathrm{vdW}} = [\\,0.0,\\,0.2,\\,0.8,\\,2.0\\,]$\n\n- 测试用例 $3$（静电阶段均匀；范德华阶段非均匀）：\n  - 静电阶段：\n    - $\\lambda_{\\mathrm{elec}} = [\\,0.0,\\,0.25,\\,0.5,\\,0.75,\\,1.0\\,]$\n    - $y_{\\mathrm{elec}} = [\\,0.0,\\,2.0,\\,1.0,\\,2.0,\\,0.0\\,]$\n  - 范德华阶段：\n    - $\\lambda_{\\mathrm{vdW}} = [\\,0.0,\\,0.5,\\,0.9,\\,1.0\\,]$\n    - $y_{\\mathrm{vdW}} = [\\,0.0,\\,1.0,\\,2.0,\\,2.0\\,]$\n\n程序输出规范。您的程序必须产生单行输出，包含一个由方括号括起来的逗号分隔列表。该列表必须包含九个浮点数，顺序如下：\n$$[\\,\\Delta F_{\\mathrm{total}}^{(1)},\\,\\Delta F_{\\mathrm{elec}}^{(1)},\\,\\Delta F_{\\mathrm{vdW}}^{(1)},\\,\\Delta F_{\\mathrm{total}}^{(2)},\\,\\Delta F_{\\mathrm{elec}}^{(2)},\\,\\Delta F_{\\mathrm{vdW}}^{(2)},\\,\\Delta F_{\\mathrm{total}}^{(3)},\\,\\Delta F_{\\mathrm{elec}}^{(3)},\\,\\Delta F_{\\mathrm{vdW}}^{(3)}\\,]$$\n其中上标表示测试用例的索引。每个浮点数必须四舍五入到三位小数。单位是 $\\mathrm{kJ/mol}$。\n\n概念要求。除了计算数值，该算法还体现了一个有效的炼金术方案：它通过先解耦库仑相互作用，再解耦范德华相互作用，来分离极性和非极性贡献。结果的组合是可加的，因为势能在两个耦合中是可加分离的，并且自由能变是态函数。您的程序不应模拟动力学；它必须仅基于所提供的数据集执行指定的数值积分。", "solution": "该问题要求实现一个数值算法，以根据一个分阶段的炼金术解耦方案计算溶剂化自由能的贡献。该计算基于统计力学中的热力学积分原理。与系统参数 $\\lambda$ 变化相关的自由能变化 $\\Delta F$ 由势能对 $\\lambda$ 的导数的系综平均值的积分给出。\n\n其控制方程是亥姆霍兹自由能 $F$ 的热力学积分恒等式：\n$$\n\\frac{dF}{d\\lambda} = \\left\\langle \\frac{\\partial U}{\\partial \\lambda} \\right\\rangle_{\\lambda}\n$$\n将其从 $\\lambda=0$ 积分到 $\\lambda=1$ 可得到总自由能变化：\n$$\n\\Delta F = \\int_{0}^{1} \\left\\langle \\frac{\\partial U}{\\partial \\lambda} \\right\\rangle_{\\lambda} d\\lambda\n$$\n问题描述了一个两阶段方案，其中静电（库仑）相互作用和范德华（Lennard-Jones）相互作用被相继解耦。势能 $U$ 相对于静电耦合参数 $\\lambda_{\\mathrm{elec}}$ 和范德华耦合参数 $\\lambda_{\\mathrm{vdW}}$ 是可加分离的。总的溶剂化自由能 $\\Delta F_{\\mathrm{total}}$ 是每个阶段贡献之和，因为自由能是态函数。所选路径是先将 $\\lambda_{\\mathrm{elec}}$ 从 $0$ 变到 $1$（此时 $\\lambda_{\\mathrm{vdW}}=0$），然后将 $\\lambda_{\\mathrm{vdW}}$ 从 $0$ 变到 $1$（此时 $\\lambda_{\\mathrm{elec}}=1$）。这得到：\n$$\n\\Delta F_{\\mathrm{elec}} = \\int_{0}^{1} \\left\\langle \\frac{\\partial U}{\\partial \\lambda_{\\mathrm{elec}}} \\right\\rangle_{\\lambda_{\\mathrm{elec}}} d\\lambda_{\\mathrm{elec}}\n$$\n$$\n\\Delta F_{\\mathrm{vdW}} = \\int_{0}^{1} \\left\\langle \\frac{\\partial U}{\\partial \\lambda_{\\mathrm{vdW}}} \\right\\rangle_{\\lambda_{\\mathrm{vdW}}} d\\lambda_{\\mathrm{vdW}}\n$$\n$$\n\\Delta F_{\\mathrm{total}} = \\Delta F_{\\mathrm{elec}} + \\Delta F_{\\mathrm{vdW}}\n$$\n我们的任务是使用提供的离散数据点 $(\\lambda_i, y_i)$ 数值计算这些积分 $\\Delta F_{\\mathrm{elec}}$ 和 $\\Delta F_{\\mathrm{vdW}}$，其中 $y_i = \\langle \\partial U/\\partial \\lambda \\rangle_{\\lambda_i}$。问题为选择数值积分方法指定了清晰的决策逻辑。\n\n对于每个积分，算法流程如下：\n1.  接收 $N$ 个数据点 $\\{(\\lambda_i, y_i)\\}_{i=0}^{N-1}$ 的集合。\n2.  确定 $\\lambda_i$ 网格是否为均匀间隔。这通过计算连续 $\\lambda_i$ 值之间的差值 $\\Delta \\lambda_i = \\lambda_{i+1} - \\lambda_i$，并检查所有这些差值是否在 $10^{-12}$ 的绝对容差范围内彼此相等来完成。\n3.  应用指定的积分法则：\n    *   如果网格是均匀的且点数 $N$ 是奇数，则使用复合辛普森法则。此法则对平滑函数和等距数据特别准确。\n    $$\n    \\int_{\\lambda_0}^{\\lambda_{N-1}} y(\\lambda)\\, d\\lambda \\approx \\frac{h}{3} \\left[ y_0 + y_{N-1} + 4 \\sum_{j=1,\\,\\text{odd}}^{N-2} y_j + 2 \\sum_{j=2,\\,\\text{even}}^{N-3} y_j \\right]\n    $$\n    其中 $h$ 是常数间距。\n    *   在所有其他情况下（即，如果网格是非均匀的，或者如果网格是均匀的但 $N$ 是偶数），则使用复合梯形法则。此法则更通用，可以处理任何网格间距。\n    $$\n    \\int_{\\lambda_0}^{\\lambda_{N-1}} y(\\lambda)\\, d\\lambda \\approx \\sum_{i=0}^{N-2} \\frac{(\\lambda_{i+1}-\\lambda_i)}{2}\\, (y_{i+1} + y_i)\n    $$\n这些标准的数值积分例程在 `SciPy` 等科学计算库中有高效的实现。我们将使用 `scipy.integrate.simpson` 和 `scipy.integrate.trapezoid`。\n\n每个测试用例的计算如下：\n\n**测试用例 1：**\n*   **静电阶段：** 网格 $\\lambda_{\\mathrm{elec}} = [\\,0.0,\\,0.25,\\,0.5,\\,0.75,\\,1.0\\,]$ 有 $N=5$ 个点（奇数），并且是均匀间隔的，间距 $h=0.25$。因此，对 $y_{\\mathrm{elec}} = [\\,0.0,\\,2.0,\\,4.0,\\,2.0,\\,0.0\\,]$ 应用辛普森法则。\n    $\\Delta F_{\\mathrm{elec}}^{(1)} = \\frac{0.25}{3} [y_0 + y_4 + 4(y_1 + y_3) + 2y_2] = \\frac{0.25}{3} [0.0 + 0.0 + 4(2.0 + 2.0) + 2(4.0)] = \\frac{0.25}{3}[16.0 + 8.0] = 2.000 \\, \\mathrm{kJ/mol}$。\n*   **范德华阶段：** 网格 $\\lambda_{\\mathrm{vdW}} = [\\,0.0,\\,\\tfrac{1}{6},\\,\\tfrac{2}{6},\\,\\tfrac{3}{6},\\,\\tfrac{4}{6},\\,\\tfrac{5}{6},\\,1.0\\,]$ 有 $N=7$ 个点（奇数），并且是均匀间隔的，间距 $h=1/6$。对 $y_{\\mathrm{vdW}} = [\\,0.0,\\,3.0,\\,5.0,\\,6.0,\\,5.0,\\,3.0,\\,0.0\\,]$ 应用辛普森法则。\n    $\\Delta F_{\\mathrm{vdW}}^{(1)} = \\frac{1/6}{3} [y_0 + y_6 + 4(y_1 + y_3 + y_5) + 2(y_2 + y_4)] = \\frac{1}{18} [0.0+0.0+4(3.0+6.0+3.0) + 2(5.0+5.0)] = \\frac{1}{18}[48.0 + 20.0] = \\frac{68}{18} \\approx 3.778 \\, \\mathrm{kJ/mol}$。\n*   **总计：** $\\Delta F_{\\mathrm{total}}^{(1)} = 2.000 + 3.778 = 5.778 \\, \\mathrm{kJ/mol}$。\n\n**测试用例 2：**\n*   **静电阶段：** 网格 $\\lambda_{\\mathrm{elec}} = [\\,0.0,\\,0.5,\\,1.0\\,]$ 有 $N=3$ 个点（奇数），并且是均匀的，间距 $h=0.5$。适用辛普森法则，但由于所有 $y_{\\mathrm{elec}}$ 值都为 $0.0$，积分显然为 $\\Delta F_{\\mathrm{elec}}^{(2)} = 0.000 \\, \\mathrm{kJ/mol}$。\n*   **范德华阶段：** 网格 $\\lambda_{\\mathrm{vdW}} = [\\,0.0,\\,0.1,\\,0.4,\\,1.0\\,]$ 是非均匀的（间距为 $0.1, 0.3, 0.6$）。必须对 $y_{\\mathrm{vdW}} = [\\,0.0,\\,0.2,\\,0.8,\\,2.0\\,]$ 使用梯形法则。\n    $\\Delta F_{\\mathrm{vdW}}^{(2)} = \\frac{0.1}{2}(0.0+0.2) + \\frac{0.3}{2}(0.2+0.8) + \\frac{0.6}{2}(0.8+2.0) = 0.01 + 0.15 + 0.84 = 1.000 \\, \\mathrm{kJ/mol}$。\n*   **总计：** $\\Delta F_{\\mathrm{total}}^{(2)} = 0.000 + 1.000 = 1.000 \\, \\mathrm{kJ/mol}$。\n\n**测试用例 3：**\n*   **静电阶段：** 网格 $\\lambda_{\\mathrm{elec}} = [\\,0.0,\\,0.25,\\,0.5,\\,0.75,\\,1.0\\,]$ 有 $N=5$ 个点（奇数），并且是均匀的，间距 $h=0.25$。对 $y_{\\mathrm{elec}} = [\\,0.0,\\,2.0,\\,1.0,\\,2.0,\\,0.0\\,]$ 应用辛普森法则。\n    $\\Delta F_{\\mathrm{elec}}^{(3)} = \\frac{0.25}{3} [0.0 + 0.0 + 4(2.0 + 2.0) + 2(1.0)] = \\frac{0.25}{3}[16.0 + 2.0] = 1.500 \\, \\mathrm{kJ/mol}$。\n*   **范德华阶段：** 网格 $\\lambda_{\\mathrm{vdW}} = [\\,0.0,\\,0.5,\\,0.9,\\,1.0\\,]$ 是非均匀的（间距为 $0.5, 0.4, 0.1$）。对 $y_{\\mathrm{vdW}} = [\\,0.0,\\,1.0,\\,2.0,\\,2.0\\,]$ 使用梯形法则。\n    $\\Delta F_{\\mathrm{vdW}}^{(3)} = \\frac{0.5}{2}(0.0+1.0) + \\frac{0.4}{2}(1.0+2.0) + \\frac{0.1}{2}(2.0+2.0) = 0.25 + 0.6 + 0.2 = 1.050 \\, \\mathrm{kJ/mol}$。\n*   **总计：** $\\Delta F_{\\mathrm{total}}^{(3)} = 1.500 + 1.050 = 2.550 \\, \\mathrm{kJ/mol}$。\n\n最后，将所有三个案例的计算值 $(\\Delta F_{\\mathrm{total}}, \\Delta F_{\\mathrm{elec}}, \\Delta F_{\\mathrm{vdW}})$ 收集起来，四舍五入到三位小数，并格式化为指定的输出字符串。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.integrate import simpson, trapezoid\n\ndef solve():\n    \"\"\"\n    Computes solvation free energy contributions for three test cases\n    using numerical quadrature based on a staged alchemical protocol.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"elec\": {\n                \"lambdas\": [0.0, 0.25, 0.5, 0.75, 1.0],\n                \"y_values\": [0.0, 2.0, 4.0, 2.0, 0.0]\n            },\n            \"vdw\": {\n                \"lambdas\": [0.0, 1.0/6.0, 2.0/6.0, 3.0/6.0, 4.0/6.0, 5.0/6.0, 1.0],\n                \"y_values\": [0.0, 3.0, 5.0, 6.0, 5.0, 3.0, 0.0]\n            }\n        },\n        {\n            \"elec\": {\n                \"lambdas\": [0.0, 0.5, 1.0],\n                \"y_values\": [0.0, 0.0, 0.0]\n            },\n            \"vdw\": {\n                \"lambdas\": [0.0, 0.1, 0.4, 1.0],\n                \"y_values\": [0.0, 0.2, 0.8, 2.0]\n            }\n        },\n        {\n            \"elec\": {\n                \"lambdas\": [0.0, 0.25, 0.5, 0.75, 1.0],\n                \"y_values\": [0.0, 2.0, 1.0, 2.0, 0.0]\n            },\n            \"vdw\": {\n                \"lambdas\": [0.0, 0.5, 0.9, 1.0],\n                \"y_values\": [0.0, 1.0, 2.0, 2.0]\n            }\n        }\n    ]\n\n    def compute_integral(lambdas, y_values):\n        \"\"\"\n        Calculates the integral based on the specified quadrature rules.\n        \n        - If the lambda grid is uniform and has an odd number of points, use Simpson's rule.\n        - Otherwise, use the trapezoidal rule.\n        \"\"\"\n        N = len(lambdas)\n        \n        # Check for uniform spacing with an absolute tolerance of 1e-12\n        is_uniform = False\n        if N > 1:\n            diffs = np.diff(lambdas)\n            if np.allclose(diffs, diffs[0], atol=1e-12, rtol=0):\n                is_uniform = True\n\n        # Apply the appropriate integration rule\n        if is_uniform and N % 2 == 1:\n            # Simpson's rule for uniform grid with odd number of points\n            return simpson(y=y_values, x=lambdas)\n        else:\n            # Trapezoidal rule for non-uniform grid or even number of points\n            return trapezoid(y=y_values, x=lambdas)\n\n    all_results = []\n    for case in test_cases:\n        # Calculate electrostatic contribution\n        df_elec = compute_integral(case[\"elec\"][\"lambdas\"], case[\"elec\"][\"y_values\"])\n        \n        # Calculate van der Waals contribution\n        df_vdw = compute_integral(case[\"vdw\"][\"lambdas\"], case[\"vdw\"][\"y_values\"])\n        \n        # Calculate total free energy change\n        df_total = df_elec + df_vdw\n        \n        # Append results in the specified order: total, elec, vdw\n        all_results.extend([df_total, df_elec, df_vdw])\n\n    # Format results to three decimal places and create the final output string\n    formatted_results = [f\"{res:.3f}\" for res in all_results]\n    \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "3488293"}, {"introduction": "显式溶剂模拟虽然功能强大，但通常在有限尺寸的周期性盒子中进行，这会为带电体系引入显著的人为效应。静电相互作用的长程特性导致溶质与其周期性镜像之间产生伪影，从而污染计算结果。本练习 [@problem_id:3488331] 聚焦于解决这一关键问题，通过实施基于多极展开的 Makov-Payne (MP) 校正方案，系统地消除这些有限尺寸误差。您将学习如何将原始模拟数据校正到物理上更有意义的无限大体系极限，并将其与经典的隐式溶剂模型（如 Born 模型）进行比较。", "problem": "考虑一个净电荷为 $q$ 的带电、近似球形的簇，嵌入在极性溶剂中。我们将比较两种溶剂化计算模型：一种是在周期性边界条件（PBC）下的显式溶剂模拟，另一种是基于连续介质静电学的隐式溶剂连续介质空腔描述。目标是计算显式溶剂 PBC 模型的溶剂化自由能 $ \\Delta G_{\\mathrm{solv}} $（单位为电子伏特），应用类 Makov-Payne（MP-like）校正来消除由周期性镜像和中和背景引起的主要有限尺寸效应，然后将校正后的值与不同簇尺寸下的隐式连续介质预测值进行比较。所有能量必须以电子伏特（eV）表示。\n\n从基本静电学出发：麦克斯韦方程组和泊松方程表明，对于一个半径为 $R$ 的球形空腔，其中包含一个净电荷为 $q$ 的点状或球对称电荷分布，并浸入在相对介电常数为 $\\varepsilon$ 的均匀电介质中，连续介质静电学（隐式溶剂）提供了一个明确定义的充电自由能。基于此基础，推导隐式溶剂球形空腔溶剂化自由能 $ \\Delta G_{\\mathrm{solv}}^{\\mathrm{implicit}} $ 作为 $q$、$R$ 和 $\\varepsilon$ 的函数。然后，将显式溶剂 PBC 模拟的能量建模为连续介质值加上伪镜像相互作用贡献和一个高阶残余有限尺寸项。伪贡献源于周期性晶格中带有 Ewald 型中和背景的长程库仑相互作用，并可以按逆盒子长度 $L^{-1}$ 的幂进行多极展开。领头项由净电荷、晶格马德隆常数和有效介电屏蔽控制；下一项涉及电荷分布的四极矩。必须从未校正的 PBC 估算值中减去这些类 MP 校正，以近似无限体积极限。\n\n为您的推导和计算定义以下量和常数：\n- 令 $k_{e} = \\dfrac{1}{4\\pi \\varepsilon_{0}}$ 表示库仑常数，其中 $\\varepsilon_{0}$ 是真空介电常数，$k_{e}$ 将在国际单位制（SI）中处理。\n- 基本电荷用 $e$ 表示，$1\\,\\mathrm{\\AA} = 10^{-10}\\,\\mathrm{m}$。\n- 用于 Ewald 求和的立方晶格马德隆常数为 $\\alpha = -2.837297$（无量纲）。\n- 四极矩通过其类迹标量 $Q$ 进入，单位为电荷乘以长度的平方；在本问题中，$Q$ 将以 $e\\,\\mathrm{\\AA}^{2}$ 为单位提供，计算时必须转换为库仑·米²。\n- 显式溶剂 PBC 能量被建模为 $ \\Delta G_{\\mathrm{solv}}^{\\mathrm{PBC,uncorr}} = \\Delta G_{\\mathrm{solv}}^{\\mathrm{implicit}} + E_{\\mathrm{spurious}} + E_{\\mathrm{res}} $，其中 $E_{\\mathrm{spurious}}$ 由类 MP 展开中的主要净电荷项和四极矩项构成，$E_{\\mathrm{res}}$ 是一个与 $L^{-5}$ 成比例的高阶残余项，由无量纲系数 $\\gamma$ 以及与量纲分析一致的 $q$、$R$ 和 $L$ 的适当幂次控制。\n- 类 MP 校正后的溶剂化自由能为 $ \\Delta G_{\\mathrm{solv}}^{\\mathrm{PBC,corr}} = \\Delta G_{\\mathrm{solv}}^{\\mathrm{PBC,uncorr}} - E_{\\mathrm{spurious}} $。\n- 比较指标是绝对偏差 $ \\left| \\Delta G_{\\mathrm{solv}}^{\\mathrm{PBC,corr}} - \\Delta G_{\\mathrm{solv}}^{\\mathrm{implicit}} \\right| $，单位为电子伏特。\n\n从所述基本原理推导所需表达式，确保每一项都具有正确的物理量纲，并且介电屏蔽得到一致处理。对于伪 PBC 贡献，使用有效介电常数 $\\varepsilon_{\\mathrm{eff}}$ 来参数化长程周期性镜像相互作用的屏蔽程度。您的实现必须在计算过程中将所有量转换为国际单位制（SI）单位，然后将能量转换为电子伏特以供输出。\n\n使用以下参数集测试套件，其中 $q$ 以 $e$ 为单位指定，$R$ 和 $L$ 的单位为 $\\mathrm{\\AA}$，$\\varepsilon$ 和 $\\varepsilon_{\\mathrm{eff}}$ 为无量纲，$Q$ 的单位为 $e\\,\\mathrm{\\AA}^{2}$，$\\gamma$ 为无量纲：\n1. 案例 1 (理想情况，大盒子，强屏蔽溶剂，球形电荷): $q = +1$, $R = 4\\,\\mathrm{\\AA}$, $L = 30\\,\\mathrm{\\AA}$, $\\varepsilon = 78.4$, $\\varepsilon_{\\mathrm{eff}} = 78.4$, $Q = 0\\,e\\,\\mathrm{\\AA}^{2}$, $\\gamma = 0.05$。\n2. 案例 2 (较小的簇和盒子，类真空有效屏蔽，非零四极矩): $q = +1$, $R = 2\\,\\mathrm{\\AA}$, $L = 20\\,\\mathrm{\\AA}$, $\\varepsilon = 78.4$, $\\varepsilon_{\\mathrm{eff}} = 1.0$, $Q = 10\\,e\\,\\mathrm{\\AA}^{2}$, $\\gamma = 0.05$。\n3. 案例 3 (较大的簇，负电荷，强屏蔽，球形电荷): $q = -1$, $R = 8\\,\\mathrm{\\AA}$, $L = 30\\,\\mathrm{\\AA}$, $\\varepsilon = 78.4$, $\\varepsilon_{\\mathrm{eff}} = 78.4$, $Q = 0\\,e\\,\\mathrm{\\AA}^{2}$, $\\gamma = 0.02$。\n4. 案例 4 (分数电荷，中等极性溶剂，类真空有效屏蔽，非零四极矩): $q = +0.5$, $R = 3\\,\\mathrm{\\AA}$, $L = 15\\,\\mathrm{\\AA}$, $\\varepsilon = 20.0$, $\\varepsilon_{\\mathrm{eff}} = 1.0$, $Q = 5\\,e\\,\\mathrm{\\AA}^{2}$, $\\gamma = 0.10$。\n\n您的程序必须为每个案例计算：\n- 隐式连续介质球形空腔溶剂化自由能 $ \\Delta G_{\\mathrm{solv}}^{\\mathrm{implicit}} $，单位为电子伏特。\n- 通过将伪类 MP 周期性镜像项和残余 $L^{-5}$ 项（基于您的推导）添加到隐式值中，计算未校正的显式溶剂 PBC 估算值 $ \\Delta G_{\\mathrm{solv}}^{\\mathrm{PBC,uncorr}} $。\n- 通过减去伪类 MP 项，计算校正后的显式溶剂估算值 $ \\Delta G_{\\mathrm{solv}}^{\\mathrm{PBC,corr}} $。\n- 绝对偏差 $ \\left| \\Delta G_{\\mathrm{solv}}^{\\mathrm{PBC,corr}} - \\Delta G_{\\mathrm{solv}}^{\\mathrm{implicit}} \\right| $，单位为电子伏特。\n\n输出规范：\n- 您的程序应生成单行输出，其中包含四个案例的绝对偏差，以逗号分隔列表的形式置于方括号内，单位为电子伏特。例如，输出格式必须为 $[x_{1},x_{2},x_{3},x_{4}]$，其中每个 $x_{i}$ 是一个以 eV 为单位的浮点数。\n\n此问题不涉及角度。所有物理量在计算过程中必须转换为国际单位制（SI）单位，最终能量必须以电子伏特（eV）表示。不需要外部输入；程序必须使用上面给出的参数值。", "solution": "该推导依赖于连续介质静电学以及在带有中和背景的 Ewald 求和晶格中周期性镜像相互作用的多极展开。隐式溶剂球形空腔溶剂化自由能，源于在介电常数为 $\\varepsilon \\varepsilon_{0}$ 的介质中，将一个半径为 $R$ 的球形空腔从 0 充电至 $q$ 的过程，其中 $\\varepsilon$ 是相对介电常数，$\\varepsilon_{0}$ 是真空介电常数。对于球对称电荷分布，真空和电介质之间的势能差可以通过对组装电荷分布所需做的功进行积分来获得，从而得到标准的类 Born 表达式。具体而言，利用泊松方程和电介质界面处的边界条件，将电荷 $q$ 放置在半径为 $R$ 的球形空腔中心时，其静电自能变化由下式给出：\n$$\n\\Delta G_{\\mathrm{solv}}^{\\mathrm{implicit}} = -\\frac{1}{2} \\, k_{e} \\, \\frac{q^{2}}{R} \\left( 1 - \\frac{1}{\\varepsilon} \\right),\n$$\n其中 $k_{e} = \\dfrac{1}{4\\pi \\varepsilon_{0}}$，$q$ 的单位是库仑，$R$ 的单位是米。该表达式是通过比较真空中的静电自能与电介质中的静电自能得到的，并且与 Born 模型的能量随半径的倒数和介电屏蔽的标度关系一致。\n\n对于显式溶剂 PBC 模型，在长度为 $L$ 的有限周期性盒子中，使用 Ewald 求和与均匀中和背景计算出的能量包含了与周期性镜像的伪相互作用。一个经过充分检验的、用于校正这些有限尺寸效应的方法是 Makov–Payne (MP) 展开，它依赖于缺陷或簇的静电势的多极展开。领头项源于净电荷，与 $L^{-1}$ 成比例，而次阶项涉及四极矩，与 $L^{-3}$ 成比例。对于长程相互作用，通过一个有效因子 $\\varepsilon_{\\mathrm{eff}}$ 来引入介电屏蔽，伪能量贡献为\n$$\nE_{\\mathrm{spurious}} = k_{e} \\left[ \\frac{q^{2}\\,\\alpha}{2\\,\\varepsilon_{\\mathrm{eff}}\\,L} + \\frac{2\\pi \\, q \\, Q}{3\\,\\varepsilon_{\\mathrm{eff}}\\,L^{3}} \\right],\n$$\n其中 $\\alpha$ 是立方晶格的无量纲马德隆常数（此处 $\\alpha = -2.837297$），$Q$ 是一个与四极矩的迹成比例的标量（单位为库仑·米²），$q$ 的单位是库仑，$L$ 的单位是米。该形式源于在存在中和背景的 PBC 条件下带电分布的静电能，并展开以包含净电荷和四极矩的贡献。介电因子 $\\varepsilon_{\\mathrm{eff}}$ 以一种有效的方式解释了长程贡献的屏蔽效应。\n\n存在更高阶的有限尺寸误差，可以将其建模为与 $L^{-5}$ 成比例的残余项，这与下一阶多极矩和晶格求和的行为一致。一个量纲一致的形式，与簇尺寸 $R$ 的四次方、净电荷 $q^{2}$ 以及 $L$ 的逆幂成正比，可以写为\n$$\nE_{\\mathrm{res}} = k_{e} \\, \\gamma \\, \\frac{q^{2}}{L} \\left( \\frac{R^{4}}{L^{4}} \\right),\n$$\n其中 $\\gamma$ 是一个无量纲系数，用于捕捉被忽略的高阶项的振幅，所有量均采用国际单位制（SI）单位。该表达式的单位是能量，因为 $k_{e} \\, q^{2} / L$ 的单位是焦耳，而 $\\left( \\dfrac{R^{4}}{L^{4}} \\right)$ 是无量纲的。\n\n结合这些分量，未校正的显式溶剂 PBC 溶剂化自由能被建模为\n$$\n\\Delta G_{\\mathrm{solv}}^{\\mathrm{PBC,uncorr}} = \\Delta G_{\\mathrm{solv}}^{\\mathrm{implicit}} + E_{\\mathrm{spurious}} + E_{\\mathrm{res}}.\n$$\n通过减去伪项应用类 MP 校正，得到\n$$\n\\Delta G_{\\mathrm{solv}}^{\\mathrm{PBC,corr}} = \\Delta G_{\\mathrm{solv}}^{\\mathrm{implicit}} + E_{\\mathrm{res}}.\n$$\n因此，校正后的显式溶剂值与隐式连续介质预测值之间的绝对偏差为\n$$\n\\left| \\Delta G_{\\mathrm{solv}}^{\\mathrm{PBC,corr}} - \\Delta G_{\\mathrm{solv}}^{\\mathrm{implicit}} \\right| = \\left| E_{\\mathrm{res}} \\right|.\n$$\n\n算法实现细节：\n1. 将所有输入量转换为国际单位制（SI）单位：\n   - 电荷：$q_{\\mathrm{SI}} = q \\times e$，$e$ 的单位是库仑。\n   - 距离：$R_{\\mathrm{SI}} = R \\times 10^{-10}\\,\\mathrm{m}$ 和 $L_{\\mathrm{SI}} = L \\times 10^{-10}\\,\\mathrm{m}$。\n   - 四极矩：$Q_{\\mathrm{SI}} = Q \\times e \\times (10^{-10}\\,\\mathrm{m})^{2}$。\n2. 计算隐式溶剂能量（单位：焦耳）：\n   $$\n   \\Delta G_{\\mathrm{solv}}^{\\mathrm{implicit}} = -\\frac{1}{2} \\, k_{e} \\, \\frac{q_{\\mathrm{SI}}^{2}}{R_{\\mathrm{SI}}} \\left( 1 - \\frac{1}{\\varepsilon} \\right).\n   $$\n3. 计算伪 PBC 贡献（单位：焦耳）：\n   $$\n   E_{\\mathrm{spurious}} = k_{e} \\left[ \\frac{q_{\\mathrm{SI}}^{2}\\,\\alpha}{2\\,\\varepsilon_{\\mathrm{eff}}\\,L_{\\mathrm{SI}}} + \\frac{2\\pi \\, q_{\\mathrm{SI}} \\, Q_{\\mathrm{SI}}}{3\\,\\varepsilon_{\\mathrm{eff}}\\,L_{\\mathrm{SI}}^{3}} \\right].\n   $$\n4. 计算残余项（单位：焦耳）：\n   $$\n   E_{\\mathrm{res}} = k_{e} \\, \\gamma \\, \\frac{q_{\\mathrm{SI}}^{2}}{L_{\\mathrm{SI}}} \\left( \\frac{R_{\\mathrm{SI}}^{4}}{L_{\\mathrm{SI}}^{4}} \\right).\n   $$\n5. 构建未校正和校正的 PBC 能量（单位：焦耳）：\n   $$\n   \\Delta G_{\\mathrm{solv}}^{\\mathrm{PBC,uncorr}} = \\Delta G_{\\mathrm{solv}}^{\\mathrm{implicit}} + E_{\\mathrm{spurious}} + E_{\\mathrm{res}}, \\quad\n   \\Delta G_{\\mathrm{solv}}^{\\mathrm{PBC,corr}} = \\Delta G_{\\mathrm{solv}}^{\\mathrm{implicit}} + E_{\\mathrm{res}}.\n   $$\n6. 计算绝对偏差（单位：焦耳）：\n   $$\n   \\left| \\Delta G_{\\mathrm{solv}}^{\\mathrm{PBC,corr}} - \\Delta G_{\\mathrm{solv}}^{\\mathrm{implicit}} \\right| = \\left| E_{\\mathrm{res}} \\right|.\n   $$\n7. 使用 $1\\,\\mathrm{eV} = 1.602176634\\times 10^{-19}\\,\\mathrm{J}$ 将最终输出所需的所有能量转换为电子伏特。\n\n将此程序应用于四个测试案例。最终的程序输出必须是单行，包含四个绝对偏差，以逗号分隔的列表形式置于方括号内，即 $[x_{1},x_{2},x_{3},x_{4}]$。\n\n此设计测试了多个方面：\n- 一个具有强介电屏蔽和可忽略四极矩 ($Q=0$) 的通用案例。\n- 一个具有类真空有效屏蔽和非零四极矩的案例，这会增强 $L^{-3}$ 伪项。\n- 跨越不同电荷符号和簇尺寸的变化，以检查 $R$ 的标度关系。\n- 一个分数电荷和中等介电常数的场景，以验证与 $q^{2}$ 的标度关系以及对 $L$ 的敏感性。\n\n所有步骤都基于泊松方程、球形空腔的连续介质静电学，以及为周期性单元中的带电系统建立的有限尺寸校正展开。推导出的表达式确保了量纲一致性和科学合理性。", "answer": "```python\n# Python 3.12\n# Required libraries: numpy 1.23.5, scipy 1.11.4 (scipy not used)\nimport numpy as np\n\ndef compute_absolute_deviation_cases():\n    # Physical constants (SI units)\n    epsilon_0 = 8.8541878128e-12  # F/m\n    k_e = 1.0 / (4.0 * np.pi * epsilon_0)  # Coulomb constant, N m^2 / C^2\n    e_charge = 1.602176634e-19  # Coulombs\n    angstrom_to_meter = 1e-10  # meters\n    joule_to_eV = 1.0 / 1.602176634e-19  # eV per Joule\n\n    # Madelung constant for cubic lattice (dimensionless)\n    alpha = -2.837297\n\n    # Test cases: (q_in_e, R_Ang, L_Ang, epsilon, epsilon_eff, Q_in_eA2, gamma)\n    test_cases = [\n        ( +1.0, 4.0, 30.0, 78.4, 78.4, 0.0, 0.05),   # Case 1\n        ( +1.0, 2.0, 20.0, 78.4, 1.0, 10.0, 0.05),   # Case 2\n        ( -1.0, 8.0, 30.0, 78.4, 78.4, 0.0, 0.02),   # Case 3\n        ( +0.5, 3.0, 15.0, 20.0, 1.0, 5.0, 0.10),    # Case 4\n    ]\n\n    results_eV = []\n\n    for q_e, R_A, L_A, eps_r, eps_eff, Q_eA2, gamma in test_cases:\n        # Convert inputs to SI\n        q_SI = q_e * e_charge  # C\n        R_SI = R_A * angstrom_to_meter  # m\n        L_SI = L_A * angstrom_to_meter  # m\n        Q_SI = Q_eA2 * e_charge * (angstrom_to_meter ** 2)  # C m^2\n\n        # Implicit-solvent Born-like solvation energy (Joules)\n        # ΔG_implicit = -(1/2) * k_e * q^2 / R * (1 - 1/eps_r)\n        deltaG_implicit_J = -0.5 * k_e * (q_SI ** 2) / R_SI * (1.0 - 1.0 / eps_r)\n\n        # Spurious PBC energy (Joules), MP-like corrections (net charge and quadrupole)\n        # E_spurious = k_e [ (q^2 * alpha) / (2 * eps_eff * L) + (2π * q * Q) / (3 * eps_eff * L^3) ]\n        term_charge = (q_SI ** 2) * alpha / (2.0 * eps_eff * L_SI)\n        term_quadrupole = (2.0 * np.pi * q_SI * Q_SI) / (3.0 * eps_eff * (L_SI ** 3))\n        E_spurious_J = k_e * (term_charge + term_quadrupole)\n\n        # Residual higher-order finite-size term (Joules)\n        # E_res = k_e * gamma * (q^2 / L) * (R^4 / L^4)\n        E_res_J = k_e * gamma * (q_SI ** 2) / L_SI * ((R_SI ** 4) / (L_SI ** 4))\n\n        # Uncorrected explicit PBC energy (Joules)\n        deltaG_PBC_uncorr_J = deltaG_implicit_J + E_spurious_J + E_res_J\n\n        # Corrected explicit PBC energy (Joules)\n        deltaG_PBC_corr_J = deltaG_PBC_uncorr_J - E_spurious_J\n\n        # Absolute deviation (Joules)\n        abs_deviation_J = abs(deltaG_PBC_corr_J - deltaG_implicit_J)\n\n        # Convert to eV\n        abs_deviation_eV = abs_deviation_J * joule_to_eV\n        results_eV.append(abs_deviation_eV)\n\n    return results_eV\n\ndef solve():\n    deviations = compute_absolute_deviation_cases()\n    # Produce single-line output in the exact required format\n    print(f\"[{','.join(map(str, deviations))}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```", "id": "3488331"}, {"introduction": "许多重要的化学过程（如电子激发和电荷转移）发生在溶剂尚未完全弛豫的超快时间尺度上。理解溶剂的动态响应对于模拟这些非平衡现象至关重要。本高级练习 [@problem_id:3488286] 将引导您构建一个完整的计算流程，将显式溶剂的微观动力学与含时可极化连续介质模型 (TD-PCM) 联系起来。您将基于线性响应理论，从偶极自相关函数（模拟显式溶剂动力学的输出）出发，推导频率依赖的介电函数 $\\varepsilon(\\omega)$，并应用它来预测溶剂致变色效应中的超快能量转移。这项实践展示了如何融合显式和隐式模型，以探索溶剂化过程的动态本质。", "problem": "开发一个完整的、可运行的程序，实现一个物理上一致的流程，将显式溶剂分子动力学与隐式溶剂时间相关的可极化连续介质模型连接起来。计算必须从线性响应理论和电磁连续介质理论的第一性原理出发，不依赖任何预先封装的高级公式。您的程序必须按顺序执行以下任务。\n\n- 对于显式溶剂分子动力学，基本的可观测量是时域中的总偶极矩自相关函数。在本问题中，您将从一小组类德拜弛豫模式中合成此自相关函数，以模拟在显式模拟中会测量到的结果，然后将其用作输入数据。接着，您必须从第一性原理出发，使用涨落-耗散定理和线性响应理论，计算复的、频率依赖的介电函数。\n\n- 使用嵌入在线性介电介质中球形空腔内点偶极子的连续介质静电学，您必须构建一个适用于溶质偶极子突然变化的时间相关反应场。这将产生一个时间相关的溶剂化致色能量位移。您必须计算该时间相关能量位移的两种预测：一种是使用可极化连续介质模型，其中时间相关映射源自归一化自相关函数；另一种是使用基于由相同弛豫模式组装的、随时间演化的有效介电响应的直接非平衡构造。您必须量化并报告激发后瞬间的超快能量位移，以及在指定时间窗口内这两种预测之间的最大绝对偏差。\n\n- 单位和常数必须被明确且一致地处理。所有涉及能量的答案必须以电子伏特表示。所有提供的时间单位为皮秒，任何提供的角频率单位为弧度/秒。偶极矩使用德拜单位，空腔半径使用埃。您必须在内部将所有此类输入转换为国际单位制，以确保物理正确性。\n\n推导必须仅从经过充分检验的基础出发。您必须基于以下基本定律和核心定义进行计算，不得使用任何快捷方式。\n\n- 广义磁化率与共轭通量平衡时间自相关函数之间的时频关系中的线性响应和涨落-耗散定理。\n- 物质中的麦克斯韦电动力学以及由极化对施加场的响应定义的介电极化率和介电函数。\n- 嵌入在均匀、各向同性、线性介电介质中球形空腔内点偶极子的反应场和相互作用能。\n\n您不得插入任何额外的经验拟合公式。只能使用上述基础和数学上严谨的步骤来构建算法。\n\n构建以下三个明确的测试用例。在每个用例中，将时域中的单边偶极矩自相关函数合成为代表一组类德拜模式的指数衰减的叠加，其振幅的选择应使静态介电增强受控。具体来说，令单边自相关函数为\n$$\nC(t) \\equiv \\sum_{i=1}^{N} A_i \\, e^{-t/\\tau_i},\n$$\n其中 $t \\ge 0$，振幅 $A_i$ 必须由下式设定\n$$\nA_i = \\frac{3 \\, \\varepsilon_0 \\, V}{\\beta} \\, \\Delta \\varepsilon_i,\n$$\n其中 $\\varepsilon_0$ 是真空介电常数，$V$ 是模拟体积，$\\beta = 1/(k_\\mathrm{B} T)$ 是绝对温度 $T$ 下的逆热能，$\\Delta \\varepsilon_i$ 是模式 $i$ 对静态介电增强的贡献。时间常数为 $\\tau_i$。静态和高频介电常数由以下关系式关联\n$$\n\\varepsilon_s = \\varepsilon_\\infty + \\sum_i \\Delta \\varepsilon_i.\n$$\n您必须在内部使用以下 SI 单位的常数和单位换算。\n- 真空介电常数 $\\varepsilon_0 = 8.8541878128\\times 10^{-12}$ 法拉/米。\n- 玻尔兹曼常数 $k_\\mathrm{B} = 1.380649\\times 10^{-23}$ 焦耳/开尔文。\n- 基本电荷 $e = 1.602176634\\times 10^{-19}$ 库仑。\n- 德拜到库仑米：$1$ 德拜 $= 3.33564\\times 10^{-30}$ 库仑米。\n- 埃到米：$1$ 埃 $= 1\\times 10^{-10}$ 米。\n- 纳米到米：$1$ 纳米 $= 1\\times 10^{-9}$ 米。\n- 皮秒到秒：$1$ 皮秒 $= 1\\times 10^{-12}$ 秒。\n- 电子伏特到焦耳：$1$ 电子伏特 $= 1.602176634\\times 10^{-19}$ 焦耳。\n\n您的程序必须：\n\n- 对于每个测试用例，使用指定的 $\\Delta t$ 和 $t_\\mathrm{max}$，在从 $t_0 = 0$ 到 $t_\\mathrm{max}$ 的均匀网格 $t_k = k \\,\\Delta t$ 上构造 $C(t)$。\n- 在指定的角频率 $\\omega_\\mathrm{ref}$ 处计算复介电函数 $\\varepsilon(\\omega)$，方法是首先通过涨落-耗散和线性响应关系，由 $C(t)$ 的单边傅里叶-拉普拉斯变换计算介电极化率 $\\chi(\\omega)$。您必须正确处理 $t=0$ 的边界项，并对变换执行数值稳定的求积。\n- 计算嵌入半径为 $a$ 的球形空腔中，溶质偶极子发生瞬时变化 $\\Delta \\mu$ 后，初始超快溶剂化致色能量位移 $\\Delta E(0^+)$（单位：电子伏特）。这是通过在高频介电常数 $\\varepsilon_\\infty$ 处评估球形空腔中点偶极子在均匀介电质中的反应场能量来计算的。\n- 在指定的一系列评估时间 $t_\\mathrm{eval}$ 上，计算溶剂化致色能量位移的两个时间相关预测：\n  - 一个时间相关的可极化连续介质模型预测 $\\Delta E_\\mathrm{TD\\text{-}PCM}(t)$，它通过归一化自相关函数 $S(t) = C(t)/C(0)$ 连接短时和长时反应场。\n  - 一个显式非平衡预测 $\\Delta E_\\mathrm{explicit}(t)$，通过由相同的弛豫模式构建随时间演化的有效介电常数 $\\varepsilon(t)$，然后在该 $\\varepsilon(t)$ 处评估反应场能量得到。\n- 在指定的 $t_\\mathrm{eval}$ 网格上，计算 $\\max_{t \\in t_\\mathrm{eval}} |\\Delta E_\\mathrm{TD\\text{-}PCM}(t) - \\Delta E_\\mathrm{explicit}(t)|$ 的最大绝对偏差（单位：电子伏特）。\n\n所有物理单位必须得到遵守。能量必须以电子伏特报告，并四舍五入到 $6$ 位小数。不涉及角度。频率以角频率形式给出，单位为弧度/秒。\n\n测试套件。您的程序必须实现以下三个参数集。\n\n- 用例 $1$（单模式类德拜弛豫）。\n  - $T = 300$ 开尔文。\n  - $V = 3.0$ 纳米$^3$。\n  - $\\varepsilon_\\infty = 1.8$。\n  - 德拜模式：$\\{(\\Delta \\varepsilon_1 = 60.0,\\ \\tau_1 = 8.0\\ \\text{皮秒})\\}$。\n  - 自相关采样：$\\Delta t = 0.01$ 皮秒， $t_\\mathrm{max} = 80.0$ 皮秒。\n  - 溶质参数：$\\Delta \\mu = 5.0$ 德拜， $a = 4.0$ 埃。\n  - 评估：$\\omega_\\mathrm{ref} = 2\\pi \\times 10^{12}$ 弧度/秒， $t_\\mathrm{eval} = [0.0,\\ 0.05,\\ 0.5,\\ 5.0]$ 皮秒。\n\n- 用例 $2$（具有快慢分量的双指数）。\n  - $T = 300$ 开尔文。\n  - $V = 2.0$ 纳米$^3$。\n  - $\\varepsilon_\\infty = 1.9$。\n  - 德拜模式：$\\{(\\Delta \\varepsilon_1 = 45.0,\\ \\tau_1 = 0.1\\ \\text{皮秒}),\\ (\\Delta \\varepsilon_2 = 35.0,\\ \\tau_2 = 5.0\\ \\text{皮秒})\\}$。\n  - 自相关采样：$\\Delta t = 0.002$ 皮秒， $t_\\mathrm{max} = 20.0$ 皮秒。\n  - 溶质参数：$\\Delta \\mu = 6.0$ 德拜， $a = 3.5$ 埃。\n  - 评估：$\\omega_\\mathrm{ref} = 2\\pi \\times 10^{12}$ 弧度/秒， $t_\\mathrm{eval} = [0.0,\\ 0.05,\\ 0.5,\\ 5.0]$ 皮秒。\n\n- 用例 $3$（边缘用例，具有超小时间常数和粗糙采样以探测离散化极限）。\n  - $T = 300$ 开尔文。\n  - $V = 2.5$ 纳米$^3$。\n  - $\\varepsilon_\\infty = 2.0$。\n  - 德拜模式：$\\{(\\Delta \\varepsilon_1 = 40.0,\\ \\tau_1 = 0.001\\ \\text{皮秒}),\\ (\\Delta \\varepsilon_2 = 20.0,\\ \\tau_2 = 0.05\\ \\text{皮秒}),\\ (\\Delta \\varepsilon_3 = 15.0,\\ \\tau_3 = 2.0\\ \\text{皮秒})\\}$。\n  - 自相关采样：$\\Delta t = 0.05$ 皮秒， $t_\\mathrm{max} = 10.0$ 皮秒。\n  - 溶质参数：$\\Delta \\mu = 7.0$ 德拜， $a = 3.8$ 埃。\n  - 评估：$\\omega_\\mathrm{ref} = 2\\pi \\times 10^{12}$ 弧度/秒， $t_\\mathrm{eval} = [0.0,\\ 0.05,\\ 0.5,\\ 5.0]$ 皮秒。\n\n输出规范。\n\n- 对于每个用例，您的程序必须产生三个浮点数：\n  - $\\varepsilon(\\omega_\\mathrm{ref})$ 的实部（无量纲）。\n  - 初始超快能量位移 $\\Delta E(0^+)$（单位：电子伏特），四舍五入到 $6$ 位小数。\n  - 在 $t_\\mathrm{eval}$ 上两种时间相关预测之间的最大绝对偏差（单位：电子伏特），四舍五入到 $6$ 位小数。\n\n- 您的程序应生成一行输出，其中包含按顺序串联的三个用例的所有结果，以逗号分隔列表形式并用方括号括起来。例如，格式为 $[\\text{case1\\_eps\\_real},\\text{case1\\_dE0},\\text{case1\\_maxdev},\\text{case2\\_eps\\_real},\\dots,\\text{case3\\_maxdev}]$。\n\n所有中间步骤必须遵守指定的单位。能量必须在最终输出中以电子伏特表示并四舍五入到 $6$ 位小数。不使用角度。频率以角频率形式给出，单位为弧度/秒。时间单位为皮秒。距离单位为空腔半径用埃，体积用纳米。偶极矩单位为德拜。", "solution": "用户的要求是开发一个计算流程，该流程将显式溶剂分子动力学原理与隐式溶剂连续介质模型连接起来，以描述时间相关的溶剂化现象。该问题在科学上是适定的，基于已建立的物理理论，并为获得唯一解提供了所有必要的数据和约束。下面概述的步骤严格遵循问题陈述，从第一性原理出发构建解决方案。\n\n### 第一步：理论基础和单位制\n\n所有计算将在内部使用国际单位制（SI）进行，以确保物理和量纲上的一致性。提供的常数和换算因子如下：\n- 真空介电常数：$\\varepsilon_0 = 8.8541878128 \\times 10^{-12}$ F/m\n- 玻尔兹曼常数：$k_\\mathrm{B} = 1.380649 \\times 10^{-23}$ J/K\n- 基本电荷：$e = 1.602176634 \\times 10^{-19}$ C\n- $1$ 德拜 $= 3.33564 \\times 10^{-30}$ C·m\n- $1$ 埃 $= 1 \\times 10^{-10}$ m\n- $1$ 纳米 $= 1 \\times 10^{-9}$ m\n- $1$ 皮秒 $= 1 \\times 10^{-12}$ s\n- $1$ 电子伏特 $= 1.602176634 \\times 10^{-19}$ J\n\n逆热能为 $\\beta = 1/(k_\\mathrm{B} T)$。所有最终的能量值将使用关系式 $1$ J $= (1/e)$ eV 从焦耳转换为电子伏特（eV）。\n\n### 第二步：偶极矩自相关函数的合成\n\n起点是总偶极矩自相关函数 $C(t) = \\langle \\mathbf{M}(t) \\cdot \\mathbf{M}(0) \\rangle$，其中 $\\mathbf{M}$ 是模拟体积 $V$ 的总偶极矩。问题为 $t \\ge 0$ 的 $C(t)$ 指定了一个合成形式，即作为 $N$ 个类德拜指数衰减的总和：\n$$\nC(t) = \\sum_{i=1}^{N} A_i e^{-t/\\tau_i}\n$$\n振幅 $A_i$ 由每个模式对介电常数的贡献 $\\Delta \\varepsilon_i$ 通过以下关系确定：\n$$\nA_i = \\frac{3 \\varepsilon_0 V}{\\beta} \\Delta \\varepsilon_i\n$$\n这将微观涨落与宏观介电性质联系起来。总静态介电常数 $\\varepsilon_s$ 通过 $\\varepsilon_s = \\varepsilon_\\infty + \\sum_{i} \\Delta \\varepsilon_i$ 与高频介电常数 $\\varepsilon_\\infty$ 相关。我们将根据每个测试用例的指定，在离散时间网格上构建 $C(t)$。\n\n### 第三步：从线性响应理论计算复介电函数\n\n复的、频率依赖的介电函数 $\\varepsilon(\\omega)$ 使用涨落-耗散定理进行计算。该定理将介电响应与系统偶极矩的平衡涨落联系起来。一个标准的公式是：\n$$\n\\frac{\\varepsilon(\\omega) - \\varepsilon_\\infty}{\\varepsilon_s - \\varepsilon_\\infty} = 1 - i\\omega \\mathcal{L}[S(t)](\\omega)\n$$\n其中 $S(t) = C(t)/C(0)$ 是归一化的自相关函数，$\\mathcal{L}[S(t)](\\omega) = \\int_0^\\infty e^{-i\\omega t} S(t) dt$ 是其单边傅里叶-拉普拉斯变换。\n\n整理得到 $\\varepsilon(\\omega)$：\n$$\n\\varepsilon(\\omega) = \\varepsilon_\\infty + (\\varepsilon_s - \\varepsilon_\\infty) \\left( 1 - i\\omega \\int_0^\\infty e^{-i\\omega t} S(t) dt \\right)\n$$\n根据指示，该积分将使用梯形法则在从 $t=0$ 到 $t=t_\\mathrm{max}$ 的合成时间网格上对 $S(t)$ 进行数值计算。这种方法明确遵循了线性响应理论的原理。在指定的参考频率 $\\omega_\\mathrm{ref}$ 下 $\\varepsilon(\\omega)$ 的实部是要求的输出之一。\n\n### 第四步：时间相关的溶剂化致色能量位移\n\n我们考虑一个溶质分子，其偶极矩在 $t=0$ 时发生瞬时变化 $\\Delta\\boldsymbol{\\mu}$，所引起的能量位移。该溶质位于半径为 $a$ 的球形空腔中。偶极子与溶剂反应场的相互作用能由连续介质静电学给出。\n\n在介电常数为 $\\varepsilon$ 的介质中，半径为 $a$ 的空腔内偶极子 $\\mu$ 的 Onsager 反应场能量为：\n$$\nW = -\\frac{1}{2} \\boldsymbol{\\mu} \\cdot \\mathbf{R} = -\\frac{(\\Delta\\mu)^2}{8\\pi\\varepsilon_0 a^3} \\left( \\frac{2(\\varepsilon - 1)}{2\\varepsilon + 1} \\right)\n$$\n我们定义 Onsager 因子为 $f(\\varepsilon) = \\frac{2(\\varepsilon - 1)}{2\\varepsilon + 1}$。\n\n**A. 初始超快能量位移, $\\Delta E(0^+)$**\n在 $t=0^+$ 激发后，只有溶剂极化的电子部分能够响应。相关的介电常数是 $\\varepsilon_\\infty$。因此，初始能量位移为：\n$$\n\\Delta E(0^+) = -\\frac{(\\Delta\\mu)^2}{8\\pi\\varepsilon_0 a^3} f(\\varepsilon_\\infty)\n$$\n该量将被计算并以 eV 为单位报告。\n\n**B. 时间相关的可极化连续介质模型 (TD-PCM)**\n该模型假设时间相关的能量弛豫在初始 ($t=0^+$) 和最终 ($t\\to\\infty$) 平衡态之间插值，其动力学由归一化的溶剂响应函数 $S(t)$ 控制。能量是对应于高频和静态极限的能量的加权平均：\n$$\n\\Delta E_\\mathrm{TD\\text{-}PCM}(t) = -\\frac{(\\Delta\\mu)^2}{8\\pi\\varepsilon_0 a^3} \\left[ f(\\varepsilon_\\infty)S(t) + f(\\varepsilon_s)(1-S(t)) \\right]\n$$\n这表示将溶剂响应划分为仍与初始状态相关的部分 ($S(t)$) 和已弛豫到最终平衡状态的部分 ($1-S(t)$)。\n\n**C. 显式非平衡模型**\n这个替代模型构建了一个时间相关的有效介电常数 $\\varepsilon(t)$，它描述了多德拜介质对阶跃函数扰动的响应。其表达式为：\n$$\n\\varepsilon(t) = \\varepsilon_s - \\sum_{i} \\Delta\\varepsilon_i e^{-t/\\tau_i}\n$$\n注意 $\\varepsilon(t=0) = \\varepsilon_\\infty$ 且 $\\varepsilon(t\\to\\infty) = \\varepsilon_s$。然后通过在每个时间点将此 $\\varepsilon(t)$ 直接代入静态 Onsager 能量公式来计算能量位移：\n$$\n\\Delta E_\\mathrm{explicit}(t) = -\\frac{(\\Delta\\mu)^2}{8\\pi\\varepsilon_0 a^3} f(\\varepsilon(t))\n$$\n最后，我们计算这两种预测之间的最大绝对偏差，即 $\\max_{t \\in t_\\mathrm{eval}} |\\Delta E_\\mathrm{TD\\text{-}PCM}(t) - \\Delta E_\\mathrm{explicit}(t)|$，该计算在指定的评估时间点上进行。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to orchestrate the solution for all test cases.\n    \"\"\"\n    # Define global constants and unit conversion factors in SI\n    EPS_0 = 8.8541878128e-12  # Vacuum permittivity in F/m\n    K_B = 1.380649e-23       # Boltzmann constant in J/K\n    E_CHARGE = 1.602176634e-19 # Elementary charge in C\n\n    D_TO_CM = 3.33564e-30    # Debye to C*m\n    A_TO_M = 1e-10           # Angstrom to m\n    NM_TO_M = 1e-9           # nanometer to m\n    PS_TO_S = 1e-12          # picosecond to s\n    J_TO_EV = 1.0 / E_CHARGE   # Joules to eV\n\n    test_cases = [\n        { # Case 1\n            'T': 300, 'V': 3.0, 'eps_inf': 1.8,\n            'modes': [(60.0, 8.0)],\n            'dt': 0.01, 't_max': 80.0,\n            'delta_mu': 5.0, 'a': 4.0,\n            'omega_ref': 2 * np.pi * 1e12,\n            't_eval': [0.0, 0.05, 0.5, 5.0]\n        },\n        { # Case 2\n            'T': 300, 'V': 2.0, 'eps_inf': 1.9,\n            'modes': [(45.0, 0.1), (35.0, 5.0)],\n            'dt': 0.002, 't_max': 20.0,\n            'delta_mu': 6.0, 'a': 3.5,\n            'omega_ref': 2 * np.pi * 1e12,\n            't_eval': [0.0, 0.05, 0.5, 5.0]\n        },\n        { # Case 3\n            'T': 300, 'V': 2.5, 'eps_inf': 2.0,\n            'modes': [(40.0, 0.001), (20.0, 0.05), (15.0, 2.0)],\n            'dt': 0.05, 't_max': 10.0,\n            'delta_mu': 7.0, 'a': 3.8,\n            'omega_ref': 2 * np.pi * 1e12,\n            't_eval': [0.0, 0.05, 0.5, 5.0]\n        }\n    ]\n\n    def solve_case(params):\n        \"\"\"\n        Solves a single test case according to the problem description.\n        \"\"\"\n        # 1. Unpack parameters and convert to SI units\n        T_K = params['T']\n        V_m3 = params['V'] * (NM_TO_M**3)\n        eps_inf = params['eps_inf']\n        \n        modes = params['modes']\n        delta_eps_i = [m[0] for m in modes]\n        tau_i_s = [m[1] * PS_TO_S for m in modes]\n        \n        dt_s = params['dt'] * PS_TO_S\n        t_max_s = params['t_max'] * PS_TO_S\n        \n        delta_mu_Cm = params['delta_mu'] * D_TO_CM\n        a_m = params['a'] * A_TO_M\n        \n        omega_ref_rad_s = params['omega_ref']\n        t_eval_s = [t * PS_TO_S for t in params['t_eval']]\n\n        # 2. Calculate fundamental quantities based on inputs\n        beta = 1.0 / (K_B * T_K)\n        eps_s = eps_inf + sum(delta_eps_i)\n        \n        # Amplitudes for the dipole autocorrelation function\n        A_i = [(3 * EPS_0 * V_m3 / beta) * de for de in delta_eps_i]\n        \n        # --- Part 1: Compute complex dielectric function eps(omega_ref) ---\n        num_steps = int(round(t_max_s / dt_s)) + 1\n        t_grid_s = np.linspace(0, t_max_s, num_steps)\n        \n        C_t = np.zeros_like(t_grid_s)\n        for i, t in enumerate(t_grid_s):\n            C_t[i] = sum(amp * np.exp(-t / tau) for amp, tau in zip(A_i, tau_i_s))\n\n        C0 = sum(A_i)\n        S_t = C_t / C0 if C0 != 0 else np.zeros_like(t_grid_s)\n\n        integrand = np.exp(-1j * omega_ref_rad_s * t_grid_s) * S_t\n        S_tilde_omega = np.trapz(integrand, t_grid_s)\n        \n        eps_omega_ref = eps_inf + (eps_s - eps_inf) * (1 - 1j * omega_ref_rad_s * S_tilde_omega)\n        result_eps_real = eps_omega_ref.real\n        \n        # --- Part 2: Compute initial ultrafast energy shift delta E(0+) ---\n        def onsager_factor(eps):\n            # The denominator 2*eps + 1 is always positive for eps >= 1\n            return (2 * (eps - 1)) / (2 * eps + 1)\n\n        f_inf = onsager_factor(eps_inf)\n        \n        prefactor_J = - (delta_mu_Cm**2) / (8 * np.pi * EPS_0 * a_m**3)\n        \n        delta_E0_J = prefactor_J * f_inf\n        result_delta_E0_eV = delta_E0_J * J_TO_EV\n        \n        # --- Part 3: Compute time-dependent shifts and their max deviation ---\n        f_s = onsager_factor(eps_s)\n        max_dev_J = 0.0\n\n        for t_ev in t_eval_s:\n            C_tev = sum(amp * np.exp(-t_ev / tau) for amp, tau in zip(A_i, tau_i_s))\n            S_tev = C_tev / C0 if C0 != 0 else 0\n            \n            E_td_pcm_J = prefactor_J * (f_inf * S_tev + f_s * (1 - S_tev))\n            \n            eps_t = eps_s - sum(de * np.exp(-t_ev / tau) for de, tau in zip(delta_eps_i, tau_i_s))\n            f_t = onsager_factor(eps_t)\n            E_explicit_J = prefactor_J * f_t\n            \n            dev_J = abs(E_td_pcm_J - E_explicit_J)\n            if dev_J > max_dev_J:\n                max_dev_J = dev_J\n                \n        result_max_dev_eV = max_dev_J * J_TO_EV\n\n        return result_eps_real, round(result_delta_E0_eV, 6), round(result_max_dev_eV, 6)\n\n    all_results = []\n    for case_params in test_cases:\n        all_results.extend(solve_case(case_params))\n        \n    print(f\"[{','.join(map(str, all_results))}]\")\n\nsolve()\n\n```", "id": "3488286"}]}