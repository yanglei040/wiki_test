{"hands_on_practices": [{"introduction": "在比较带电缺陷超胞与中性体相超胞的总能量时，一个关键的挑战是它们没有一个共同的能量参考点。由于缺陷电荷和补偿背景电荷的存在，带电超胞中的平均静电势会发生偏移。本练习将指导您如何计算这一势能对齐项 $\\Delta V$ [@problem_id:3442720]，这是对齐两种计算的能标并获得有意义的缺陷形成能的关键第一步。通过处理模型势函数，您将掌握从第一性原理计算的原始数据中提取和分析静电势的核心技能。", "problem": "考虑一个在周期性超胞中使用密度泛函理论（DFT）处理的带电点缺陷。静电势场由泊松方程决定，对于具有周期性边界条件和均匀补偿背景的足够大的超胞中的局域电荷分布，长程静电响应会衰减，使得远离缺陷处的平面平均势相对于原始（无缺陷）超胞趋于一个恒定的偏移量。此偏移量定义了比较带电和中性计算之间能量所需的势能对齐。您的任务是计算有缺陷和原始超胞的静电势在远场的平均值之间的带符号偏移量，并评估结构弛豫和超胞尺寸如何影响此偏移量的稳定性。\n\n从以下经过充分检验的物理基础开始：\n- 静电势 $V(\\mathbf{r})$ 满足泊松方程 $\\nabla^{2} V(\\mathbf{r}) = -\\rho(\\mathbf{r}) / \\varepsilon_{0}$。\n- 在具有局域缺陷电荷和均匀中和背景的周期性超胞中，当超胞尺寸趋于无穷大时，远场平面平均势在恒定规范内变为空间均匀。\n\n定义原始超胞和有缺陷超胞沿 $z$ 方向的一维平面平均静电势 $V(z)$。缺陷位于中心 $z_{0} = L/2$ 处，其中 $L$ 是超胞沿 $z$ 方向的长度。您将获得在均匀网格上 $V_{\\text{pristine}}(z)$ 和 $V_{\\text{defect}}(z)$ 的参数化数据集，以及沿 $z$ 方向的径向排除截断值 $R_{c}$，它将“远离缺陷”区域定义为所有到 $z_{0}$ 的距离至少为 $R_{c}$ 的网格点。仅使用该远场区域中的网格点，计算对齐偏移量 $\\Delta V$，即有缺陷势和原始势的远场平均值之间的带符号差值，以电子伏特表示。然后，通过将每个测试案例与指定的参考案例（弛豫后的大超胞）进行比较，评估 $\\Delta V$ 对结构弛豫和超胞尺寸的稳定性。报告与参考值的偏差大小是否在指定的容差范围内。\n\n单位和数值要求：\n- 距离 $z$ 和 $L$ 以埃（$\\text{\\AA}$）为单位。\n- 静电势 $V(z)$ 以电子伏特（$\\text{eV}$）为单位。\n- 以 $\\text{eV}$ 为单位表示计算出的对齐偏移量 $\\Delta V$，四舍五入到三位小数。\n- 使用 $\\tau = 0.05$ $\\text{eV}$ 的稳定性容差。对于每个案例，报告一个布尔值，指示 $|\\Delta V_{\\text{case}} - \\Delta V_{\\text{ref}}| \\le \\tau$ 是否成立。\n\n算法规格：\n- 在 $[0, L]$ 上构建包含 $N$ 个点的均匀 $z$ 网格。\n- 将 $|z - z_{0}| \\ge R_{c}$ 的点识别为远区域掩码。\n- 计算远区域点上 $V_{\\text{pristine}}(z)$ 和 $V_{\\text{defect}}(z)$ 的算术平均值。\n- 将 $\\Delta V$ 定义为对齐有缺陷势和原始势的远场平均值所需的带符号偏移量，并以 $\\text{eV}$ 报告。\n\n测试套件：\n对于每个案例，势根据指定的参数确定性地生成，如下所示。令：\n- $z_{0} = L/2$,\n- $z$ 为在 $[0, L]$ 上的含 $N$ 个点的均匀网格，\n- $V_{\\text{pristine}}(z) = P_{0} + A \\sin\\left(\\dfrac{2\\pi z}{\\lambda}\\right) + \\dfrac{A}{20} \\cos\\left(\\dfrac{4\\pi z}{L}\\right)$,\n- $V_{\\text{defect}}(z) = V_{\\text{pristine}}(z) + \\Delta + B \\exp\\left(-\\dfrac{(z - z_{0})^{2}}{2 w^{2}}\\right)$.\n\n以下所有参数均以其各自的单位给出（$L$ 和 $w$ 以 $\\text{\\AA}$ 为单位，势以 $\\text{eV}$ 为单位）。参考案例为案例4。\n\n- 案例1（小超胞，未弛豫）：\n  - $L = 10.0$, $N = 101$, $P_{0} = 12.0$, $A = 0.25$, $\\lambda = 5.0$, $\\Delta = 0.12$, $B = 0.80$, $w = 0.80$, $R_{c} = 3.0$。\n- 案例2（小超胞，弛豫）：\n  - $L = 10.0$, $N = 101$, $P_{0} = 12.0$, $A = 0.15$, $\\lambda = 5.0$, $\\Delta = 0.105$, $B = 0.30$, $w = 0.80$, $R_{c} = 3.0$。\n- 案例3（大超胞，未弛豫）：\n  - $L = 30.0$, $N = 301$, $P_{0} = 12.0$, $A = 0.20$, $\\lambda = 8.0$, $\\Delta = 0.098$, $B = 0.60$, $w = 1.20$, $R_{c} = 5.0$。\n- 案例4（大超胞，弛豫；参考）：\n  - $L = 30.0$, $N = 301$, $P_{0} = 12.0$, $A = 0.10$, $\\lambda = 8.0$, $\\Delta = 0.100$, $B = 0.25$, $w = 1.20$, $R_{c} = 5.0$。\n- 案例5（边界情况，近乎均匀的势）：\n  - $L = 18.0$, $N = 180$, $P_{0} = 10.0$, $A = 0.00$, $\\lambda = 9.0$, $\\Delta = 0.000$, $B = 0.00$, $w = 1.00$, $R_{c} = 4.0$。\n\n最终输出格式：\n- 您的程序应生成一行输出，其中包含一个用方括号括起来的逗号分隔列表形式的聚合结果。第一个元素是五个 $\\Delta V$ 值的列表（每个值四舍五入到三位小数），按上述测试套件的顺序排列。第二个元素是五个布尔值的列表，对应于每个案例相对于案例4的稳定性分类。例如：$[[\\delta_{1},\\delta_{2},\\delta_{3},\\delta_{4},\\delta_{5}],[b_{1},b_{2},b_{3},b_{4},b_{5}]]$.", "solution": "该问题要求计算周期性超胞中带电点缺陷的静电势对齐偏移量 $\\Delta V$，这是计算材料科学中纠正密度泛函理论（DFT）计算中有限尺寸误差的标准程序。我们获得了原始超胞的平面平均静电势 $V_{\\text{pristine}}(z)$ 和含缺陷超胞的平面平均静电势 $V_{\\text{defect}}(z)$ 沿 $z$ 方向的解析模型。任务是计算几个测试案例的 $\\Delta V$，并评估其相对于结构弛豫和超胞尺寸的稳定性。\n\n该问题的理论基础是带电缺陷的静电势修正。当带电缺陷置于有限的周期性超胞中时，通常会添加一个人为的均匀背景电荷密度，以维持模拟单元的整体电中性，这是使用周期性边界条件和 Ewald 求和进行计算的要求。局域缺陷电荷与此背景及其自身周期性镜像的相互作用引入了依赖于超胞尺寸的静电能量误差。这种误差表现为远离缺陷区域的静电势中的一个伪恒定偏移。为了获得孤立缺陷的正确形成能，必须计算此偏移量，并用它来将带电超胞的势与中性参考（原始超胞）的势对齐。\n\n对齐偏移量 $\\Delta V$ 定义为在离缺陷足够远的区域内，缺陷超胞的平均势与原始超胞的平均势之间的差值。在数学上，这表示为：\n$$\n\\Delta V = \\overline{V_{\\text{defect}}(z)}_{\\text{far}} - \\overline{V_{\\text{pristine}}(z)}_{\\text{far}}\n$$\n其中上划线表示在“远离缺陷”区域上进行的算术平均。该区域由网格上所有满足与缺陷中心 $z_0 = L/2$ 的距离大于或等于指定截断半径 $R_c$ 的点 $z$ 定义。即点集 $\\{z : |z - z_0| \\ge R_c\\}$。\n\n提供的势的解析形式是：\n$$\nV_{\\text{pristine}}(z) = P_{0} + A \\sin\\left(\\frac{2\\pi z}{\\lambda}\\right) + \\frac{A}{20} \\cos\\left(\\frac{4\\pi z}{L}\\right)\n$$\n$$\nV_{\\text{defect}}(z) = V_{\\text{pristine}}(z) + \\Delta + B \\exp\\left(-\\frac{(z - z_0)^2}{2 w^2}\\right)\n$$\n此处，$V_{\\text{pristine}}(z)$ 模拟了主体材料的固有周期性势。势 $V_{\\text{defect}}(z)$ 是通过向原始势添加两项来构建的：一个恒定偏移 $\\Delta$ 和一个位于缺陷位置 $z_0$ 的局域高斯形貌势。高斯项 $B \\exp\\left(-\\frac{(z - z_0)^2}{2 w^2}\\right)$ 代表了缺陷势的短程分量。\n\n将这些形式代入 $\\Delta V$ 的定义中，得到一个简化的表达式：\n$$\n\\Delta V = \\overline{\\left(V_{\\text{pristine}}(z) + \\Delta + B e^{-\\frac{(z - z_0)^2}{2w^2}}\\right)}_{\\text{far}} - \\overline{V_{\\text{pristine}}(z)}_{\\text{far}}\n$$\n根据平均算符的线性性质，这可以简化为：\n$$\n\\Delta V = \\overline{V_{\\text{pristine}}(z)}_{\\text{far}} + \\overline{\\Delta}_{\\text{far}} + \\overline{B e^{-\\frac{(z - z_0)^2}{2w^2}}}_{\\text{far}} - \\overline{V_{\\text{pristine}}(z)}_{\\text{far}}\n$$\n$$\n\\Delta V = \\Delta + \\overline{B \\exp\\left(-\\frac{(z - z_0)^2}{2 w^2}\\right)}_{\\text{far}}\n$$\n这个结果表明，计算出的对齐偏移量 $\\Delta V$ 等于内建的势移参数 $\\Delta$ 加上一个修正项，该修正项源于高斯函数尾部在远场区域的平均值。如果高斯函数是良好局域的（$w$ 较小）并且远场区域离缺陷中心足够远（$R_c$ 较大），则该修正值会很小。\n\n解决每个测试案例的计算步骤如下：\n1.  **网格构建**：在区间 $[0, L]$ 上生成一个包含 $N$ 个点的均匀一维网格，记为 $\\{z_i\\}$。这些点由 $z_i = i \\cdot \\frac{L}{N-1}$ 给出，其中 $i = 0, 1, \\dots, N-1$。\n2.  **势能评估**：使用给定的参数化公式，在每个网格点 $z_i$ 上计算 $V_{\\text{pristine}}(z_i)$ 和 $V_{\\text{defect}}(z_i)$ 的值。\n3.  **远区域掩码**：通过对网格点应用布尔掩码来识别远离缺陷的区域。如果一个点 $z_i$ 满足条件 $|z_i - z_0| \\ge R_c$（其中 $z_0 = L/2$），则该点被包含在远区域中。\n4.  **平均**：仅使用由远区域掩码选择的网格点上的值，计算 $V_{\\text{pristine}}$ 和 $V_{\\text{defect}}$ 的算术平均值。\n5.  **偏移计算**：对齐偏移量 $\\Delta V$ 计算为两个平均值之差：$\\Delta V = \\overline{V_{\\text{defect}}}_{\\text{far}} - \\overline{V_{\\text{pristine}}}_{\\text{far}}$。结果四舍五入到三位小数。\n6.  **稳定性分析**：对于每个计算出的偏移量 $\\Delta V_{\\text{case}}$，评估其与参考偏移量 $\\Delta V_{\\text{ref}}$（来自案例4）的偏差。如果绝对差在给定的容差 $\\tau = 0.05$ $\\text{eV}$ 之内，即 $|\\Delta V_{\\text{case}} - \\Delta V_{\\text{ref}}| \\le \\tau$，则确认其稳定性。结果以布尔值报告。\n\n最后，将所有五个测试案例计算出的 $\\Delta V$ 值和稳定性布尔值编译成两个单独的列表，并以指定格式呈现。这种系统化的方法确保了势能对齐修正的准确和可复现的确定，这是从DFT模拟中获得可靠缺陷形成能的关键步骤。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the potential alignment offset for charged defects in periodic\n    supercells based on parameterized 1D potential models and assesses\n    the stability of the offset.\n    \"\"\"\n    \n    # Test cases with parameters for the potential functions.\n    # L, w, Rc in Angstroms; P0, A, Delta, B in eV.\n    test_cases = [\n        # Case 1 (small supercell, unrelaxed)\n        {'L': 10.0, 'N': 101, 'P0': 12.0, 'A': 0.25, 'lambda_': 5.0, 'Delta': 0.12, 'B': 0.80, 'w': 0.80, 'Rc': 3.0},\n        # Case 2 (small supercell, relaxed)\n        {'L': 10.0, 'N': 101, 'P0': 12.0, 'A': 0.15, 'lambda_': 5.0, 'Delta': 0.105, 'B': 0.30, 'w': 0.80, 'Rc': 3.0},\n        # Case 3 (large supercell, unrelaxed)\n        {'L': 30.0, 'N': 301, 'P0': 12.0, 'A': 0.20, 'lambda_': 8.0, 'Delta': 0.098, 'B': 0.60, 'w': 1.20, 'Rc': 5.0},\n        # Case 4 (large supercell, relaxed; reference)\n        {'L': 30.0, 'N': 301, 'P0': 12.0, 'A': 0.10, 'lambda_': 8.0, 'Delta': 0.100, 'B': 0.25, 'w': 1.20, 'Rc': 5.0},\n        # Case 5 (edge case, nearly uniform potentials)\n        {'L': 18.0, 'N': 180, 'P0': 10.0, 'A': 0.00, 'lambda_': 9.0, 'Delta': 0.000, 'B': 0.00, 'w': 1.00, 'Rc': 4.0},\n    ]\n\n    delta_v_values = []\n\n    for case in test_cases:\n        # Unpack parameters for the current test case\n        L = case['L']\n        N = case['N']\n        P0 = case['P0']\n        A = case['A']\n        lambda_ = case['lambda_']\n        Delta = case['Delta']\n        B = case['B']\n        w = case['w']\n        Rc = case['Rc']\n\n        # 1. Construct the uniform z-grid\n        z_grid = np.linspace(0, L, N)\n        z0 = L / 2.0\n\n        # 2. Calculate potentials on the grid\n        v_pristine = (P0 + A * np.sin(2 * np.pi * z_grid / lambda_) + \n                      (A / 20.0) * np.cos(4 * np.pi * z_grid / L))\n        \n        gaussian_term = B * np.exp(-(z_grid - z0)**2 / (2 * w**2))\n        v_defect = v_pristine + Delta + gaussian_term\n\n        # 3. Identify the far-from-defect region\n        far_region_mask = np.abs(z_grid - z0) >= Rc\n\n        # 4. Compute the arithmetic mean over the far-region points\n        avg_v_pristine_far = np.mean(v_pristine[far_region_mask])\n        avg_v_defect_far = np.mean(v_defect[far_region_mask])\n\n        # 5. Compute the alignment offset Delta V\n        delta_v = avg_v_defect_far - avg_v_pristine_far\n        delta_v_values.append(delta_v)\n\n    # Round the Delta V values to three decimal places\n    rounded_delta_v = [round(dv, 3) for dv in delta_v_values]\n\n    # 6. Evaluate stability against the reference case (Case 4)\n    # The reference value is the 4th element (index 3)\n    delta_v_ref = delta_v_values[3]\n    tolerance = 0.05\n    stability_flags = [abs(dv - delta_v_ref) <= tolerance for dv in delta_v_values]\n    \n    # Format the stability flags as lowercase strings 'true'/'false'\n    stability_str_list = [str(b).lower() for b in stability_flags]\n\n    # Assemble the final output string in the specified format\n    final_output = f\"[[{','.join(map(str, rounded_delta_v))}],[{','.join(stability_str_list)}]]\"\n    \n    # Final print statement in the exact required format.\n    print(final_output)\n\nsolve()\n```", "id": "3442720"}, {"introduction": "在周期性边界条件下，超胞模型会引入缺陷与其周期性镜像之间的伪相互作用，这是一种随着超胞尺寸 $L$ 增大而减小的有限尺寸效应。本练习将引导您实施一种有限尺寸标度分析方法 [@problem_id:3442717]，将不同尺寸超胞中计算得到的形成能拟合到基于物理原理的标度模型（例如，与 $L^{-1}$ 和 $L^{-3}$ 成比例）。通过这种外推法，您可以得到物理上更有意义的孤立缺陷（即无限大超胞）的形成能，这是准确预测缺陷性质的必要步骤。", "problem": "给定一系列超胞线性尺寸，以及在周期性边界条件（PBC）下，使用第一性原理方法（如密度泛函理论，DFT）计算得到的带电和中性点缺陷的相应测量形成能。任务是实现一种有限尺寸标度外推方法，以估算稀释极限下的形成能，该方法基于长程静电学和多极展开。此外，还需要比较两个捕捉与晶胞长度倒数相关的主导标度行为的渐近模型。对于每个测试用例，程序必须将能量拟合为长度倒数的函数，并报告从一个能量与长度倒数呈线性关系的模型和一个能量与长度倒数呈线性和三次方组合关系的模型中外推得到的稀释极限能量，然后根据一个定量标准选择哪个模型更合适。能量必须以电子伏特（eV）表示，长度以埃（$\\mathrm{\\AA}$）表示。\n\n推导的背景原理：在PBC下，一个处于电荷态 $q$ 的缺陷与其周期性镜像以及一个补偿背景电荷相互作用，导致形成能中存在有限尺寸误差，该误差随着超胞长度 $L$ 的增加而衰减。根据三维静电学和多极展开，渐近误差中的主导项与线性尺寸的逆幂成正比。由于库仑镜像相互作用和多极矩贡献的对称性，该误差可以展开为长度倒数的奇次幂，在绝缘主体材料的通常条件下，得到以 $L^{-1}$ 和 $L^{-3}$ 为主导贡献项的级数。因此，作为 $L$ 的函数的测量形成能可以用一个关于 $x = L^{-1}$ 的截断级数来近似，其中常数项捕捉了稀释极限能量，而附加项则解释了有限尺寸校正。这些渐近模型不假设或要求任何特定的微观参数，如介电常数或缺陷多极矩；它们仅使用从经过充分检验的物理原理中推导出的标度行为。\n\n实现要求：\n- 对于每个测试用例，构建测量形成能的数据向量 $y$ 和特征向量 $x = 1/L$，其中 $L$ 是以 $\\mathrm{\\AA}$ 为单位的超胞线性尺寸。\n- 通过普通最小二乘法（OLS）拟合两个模型：\n  1. 模型A（线性反比长度模型）：$E(L) = a_0 + a_1 x$，其中 $x = 1/L$，$a_0$ 是稀释极限形成能的估计值。\n  2. 模型B（线性加立方反比长度模型）：$E(L) = b_0 + b_1 x + b_3 x^3$，其中 $x = 1/L$，$b_0$ 是稀释极限形成能的估计值。\n- 对于每个模型，计算残差平方和与贝叶斯信息准则（BIC），定义为 $\\mathrm{BIC} = n \\ln(\\hat{\\sigma}^2) + k \\ln(n)$，其中 $n$ 是数据点数量，$k$ 是拟合参数的数量（模型A为 $k=2$，模型B为 $k=3$），$\\hat{\\sigma}^2$ 是残差方差，由 $\\hat{\\sigma}^2 = \\mathrm{RSS}/n$ 给出。为避免在残差平方和趋于零时 $\\ln(\\hat{\\sigma}^2)$ 出现发散，请对 $\\hat{\\sigma}^2$ 使用一个物理上合理的下界，例如用 $\\max(\\hat{\\sigma}^2, \\varepsilon)$ 替换 $\\hat{\\sigma}^2$，其中 $\\varepsilon$ 是一个小的正常数（例如 $\\varepsilon = 10^{-18}$）。\n- 对于每个测试用例，选择BIC较小的模型作为首选模型。以整数形式报告模型偏好：使用 $0$ 表示模型A（线性反比长度模型），使用 $1$ 表示模型B（线性加立方反比长度模型）。\n\n测试套件规范（单位：$L$ 单位为 $\\mathrm{\\AA}$，$E$ 单位为 $\\mathrm{eV}$）。每个案例提供一个 $L$ 值列表和测量的形成能 $E_f(D^q; L)$：\n- 案例1（带电缺陷，反比和反比三次方标度行为均显著）：\n  - $L$ 值：$\\{\\,12,\\,16,\\,20,\\,24,\\,30,\\,40\\,\\}\\,\\mathrm{\\AA}$\n  - $E$ 值：$\\{\\,2.155208,\\,2.139697,\\,2.131125,\\,2.125651,\\,2.120333,\\,2.115141\\,\\}\\,\\mathrm{eV}$\n- 案例2（弱带电或类中性缺陷，以反比三次方标度行为为主）：\n  - $L$ 值：$\\{\\,10,\\,14,\\,20,\\,28,\\,36\\,\\}\\,\\mathrm{\\AA}$\n  - $E$ 值：$\\{\\,3.017000,\\,3.007946,\\,3.004000,\\,3.002333,\\,3.001646\\,\\}\\,\\mathrm{eV}$\n- 案例3（最小样本量等于模型B的参数数量）：\n  - $L$ 值：$\\{\\,15,\\,25,\\,35\\,\\}\\,\\mathrm{\\AA}$\n  - $E$ 值：$\\{\\,1.522370,\\,1.512512,\\,1.508758\\,\\}\\,\\mathrm{eV}$\n- 案例4（数据主要呈反比长度标度行为，并伴有轻微测量噪声）：\n  - $L$ 值：$\\{\\,18,\\,22,\\,26,\\,34,\\,50,\\,70\\,\\}\\,\\mathrm{\\AA}$\n  - $E$ 值：$\\{\\,0.824222,\\,0.815182,\\,0.816385,\\,0.811765,\\,0.806000,\\,0.807214\\,\\}\\,\\mathrm{eV}$\n\n数值和输出要求：\n- 使用线性代数实现OLS拟合。不要假定任何预先计算好的系数公式；使用一种基于原理的最小二乘法从数据中计算它们。\n- 对于每个测试用例，计算并返回：\n  - 从模型A外推的稀释极限能量 $a_0$，以浮点数形式表示，单位为eV。\n  - 从模型B外推的稀释极限能量 $b_0$，以浮点数形式表示，单位为eV。\n  - 基于BIC的模型偏好，以整数形式表示（模型A为 $0$，模型B为 $1$）。\n- 所有能量以eV为单位表示，并精确到小数点后6位。\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表。每个测试用例贡献一个形式为 $[a_0,b_0,m]$ 的子列表，其中 $a_0$ 和 $b_0$ 四舍五入到小数点后6位，$m$ 是表示模型偏好的整数。例如，一个包含两个案例的有效输出格式为 $[[a_0^{(1)},b_0^{(1)},m^{(1)}],[a_0^{(2)},b_0^{(2)},m^{(2)}]]$。", "solution": "该问题要求为在周期性边界条件下计算的缺陷形成能实现一种有限尺寸标度外推方法。这是计算材料科学中一个标准且关键的程序，用于修正由模拟晶胞的人为周期性引入的赝象。我们将把给定的能量与晶胞尺寸数据拟合到两个物理模型，并使用贝叶斯信息准则（BIC）来选择更合适的模型。\n\n### 基于原理的设计\n\n**1. 有限尺寸效应的物理起源**\n\n在使用周期性边界条件（PBC）的第一性原理计算中，将一个带电缺陷放置在模拟晶胞内，该晶胞在所有三个维度上周期性地复制，从而形成一个人工的缺陷晶格。该系统的总能量包括缺陷与其周期性镜像之间的伪静电相互作用，以及与通常为保持整体电中性而引入的均匀补偿背景电荷的相互作用。对于一个电荷为 $q$ 的缺陷，位于边长为 $L$ 的立方超胞中，并嵌入在介电常数为 $\\epsilon_r$ 的介质中，其形成能中的主导阶静电误差（称为 Makov-Payne 校正）按 $L^{-1}$ 标度变化。\n\n进一步的校正来自缺陷电荷分布的高阶多极矩与其周期性镜像产生的场的相互作用。对于各向同性主体材料中的缺陷，对称性分析表明，能量展开中的下一个主导项按 $L^{-3}$ 标度变化。因此，计算得到的形成能 $E(L)$ 可以表示为晶胞尺寸 $L$ 的逆幂的渐近级数：\n\n$$\nE(L) = E_0 + c_1 L^{-1} + c_3 L^{-3} + O(L^{-5})\n$$\n\n这里，$E_0$ 是稀释极限（$L \\to \\infty$）下的真实形成能，$c_1, c_3$ 是与缺陷电荷、多极矩以及主体材料的介电响应相关的系数。任务是将数据外推到 $L \\to \\infty$（或 $x = L^{-1} \\to 0$）以求得 $E_0$。\n\n**2. 渐近模型与线性回归**\n\n我们的任务是将数据拟合到此展开式的两个截断版本。令 $x = L^{-1}$。\n\n**模型A（线性反比长度模型）：**此模型仅包含主导阶校正项。\n$$\nE(x) = a_0 + a_1 x\n$$\n这是一个线性模型，其中 $a_0$ 代表外推得到的稀释极限能量 $E_0$。\n\n**模型B（线性加立方反比长度模型）：**此模型同时包含主导项和次主导项。\n$$\nE(x) = b_0 + b_1 x + b_3 x^3\n$$\n在这里，$b_0$ 是外推得到的能量 $E_0$，$b_1$ 对应于 $c_1$，$b_3$ 对应于 $c_3$。\n\n两个模型都可以表述为 $y = X\\beta + \\epsilon$ 形式的一般线性回归问题，其中 $y$ 是观测能量的向量，$X$ 是设计矩阵，$\\beta$ 是待拟合的参数向量，$\\epsilon$ 是误差向量。\n\n对于一组 $n$ 个数据点 $(L_i, E_i)$，我们有 $y = [E_1, E_2, \\dots, E_n]^T$ 和 $x_i = L_i^{-1}$。\n\n对于**模型A**：\n参数向量为 $\\beta_A = [a_0, a_1]^T$。设计矩阵 $X_A$ 为：\n$$\nX_A = \\begin{pmatrix}\n1 & x_1 \\\\\n1 & x_2 \\\\\n\\vdots & \\vdots \\\\\n1 & x_n\n\\end{pmatrix}\n$$\n\n对于**模型B**：\n参数向量为 $\\beta_B = [b_0, b_1, b_3]^T$。设计矩阵 $X_B$ 为：\n$$\nX_B = \\begin{pmatrix}\n1 & x_1 & x_1^3 \\\\\n1 & x_2 & x_2^3 \\\\\n\\vdots & \\vdots & \\vdots \\\\\n1 & x_n & x_n^3\n\\end{pmatrix}\n$$\n\n**3. 普通最小二乘法（OLS）解**\n\nOLS 的目标是找到参数向量 $\\hat{\\beta}$，以最小化残差平方和（RSS），即 $\\mathrm{RSS} = \\sum_{i=1}^n (y_i - \\hat{y}_i)^2$，其中 $\\hat{y} = X\\hat{\\beta}$ 是预测值。解析解由正规方程给出：\n$$\n\\hat{\\beta} = (X^T X)^{-1} X^T y\n$$\n为保证数值稳定性，特别是在 $X$ 的列近似共线的情况下，最好使用奇异值分解（SVD）或QR分解等方法来解决最小二乘问题。`numpy.linalg.lstsq` 函数提供了这样一种稳健的实现。外推得到的稀释极限能量（$a_0$ 或 $b_0$）是所得系数向量 $\\hat{\\beta}$ 的第一个元素。\n\n**4. 使用贝叶斯信息准则（BIC）进行模型选择**\n\n为了决定哪个模型能更好地描述数据，我们必须在拟合优度与模型复杂度之间取得平衡。参数更多的模型（如模型B）几乎总能更好地拟合数据（即具有更低的RSS），但这可能是由于过拟合。BIC是一种对模型复杂度进行惩罚的统计准则。其定义为：\n$$\n\\mathrm{BIC} = n \\ln(\\hat{\\sigma}^2) + k \\ln(n)\n$$\n其中：\n- $n$ 是数据点的数量。\n- $k$ 是模型参数的数量（模型A为 $k=2$，模型B为 $k=3$）。\n- $\\hat{\\sigma}^2 = \\mathrm{RSS}/n$ 是残差方差的最大似然估计。\n\n第一项 $n \\ln(\\hat{\\sigma}^2)$ 衡量拟合优度（较小的RSS导致较小的值）。第二项 $k \\ln(n)$ 是复杂度惩罚项；它随着参数数量 $k$ 的增加而增加。BIC值较低的模型更受青睐，因为它代表了准确性与简单性之间更好的折衷。\n\n当数据点数量 $n$ 等于参数数量 $k$ 时（如测试案例3中的模型B），会出现一个特殊情况。此时，模型可以完美拟合数据，导致 $\\mathrm{RSS} = 0$ 且 $\\hat{\\sigma}^2 = 0$。由于 $\\ln(0)$ 未定义，我们通过计算 $\\ln(\\max(\\hat{\\sigma}^2, \\varepsilon))$ 来对方差进行正则化，其中 $\\varepsilon$ 是一个小的正常数，给定为 $10^{-18}$。这可以防止数值发散，同时确保完美拟合受到BIC的强烈青睐。选择BIC值较低的模型；对模型A的偏好用 $0$ 表示，对模型B的偏好用 $1$ 表示。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the finite-size scaling problem for defect formation energies\n    for a suite of test cases.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"L\": np.array([12., 16., 20., 24., 30., 40.]),\n            \"E\": np.array([2.155208, 2.139697, 2.131125, 2.125651, 2.120333, 2.115141])\n        },\n        {\n            \"L\": np.array([10., 14., 20., 28., 36.]),\n            \"E\": np.array([3.017000, 3.007946, 3.004000, 3.002333, 3.001646])\n        },\n        {\n            \"L\": np.array([15., 25., 35.]),\n            \"E\": np.array([1.522370, 1.512512, 1.508758])\n        },\n        {\n            \"L\": np.array([18., 22., 26., 34., 50., 70.]),\n            \"E\": np.array([0.824222, 0.815182, 0.816385, 0.811765, 0.806000, 0.807214])\n        }\n    ]\n\n    all_results = []\n    \n    # A small positive constant for BIC calculation regularization\n    epsilon = 1e-18\n\n    for case in test_cases:\n        L = case[\"L\"]\n        E = case[\"E\"]\n        n = len(L)\n        x = 1.0 / L\n\n        # --- Model A: E = a0 + a1 * x ---\n        X_A = np.vstack([np.ones(n), x]).T\n        k_A = X_A.shape[1]\n        \n        # Perform Ordinary Least Squares fit using numpy.linalg.lstsq\n        coeffs_A, residuals_A, _, _ = np.linalg.lstsq(X_A, E, rcond=None)\n        a0 = coeffs_A[0]\n        \n        # Residual sum of squares (RSS)\n        rss_A = residuals_A[0] if residuals_A.size > 0 else 0.0\n        \n        # Bayesian Information Criterion (BIC)\n        sigma2_A = rss_A / n\n        sigma2_A_reg = max(sigma2_A, epsilon)\n        bic_A = n * np.log(sigma2_A_reg) + k_A * np.log(n)\n\n        # --- Model B: E = b0 + b1*x + b3*x^3 ---\n        X_B = np.vstack([np.ones(n), x, x**3]).T\n        k_B = X_B.shape[1]\n        \n        coeffs_B, residuals_B, _, _ = np.linalg.lstsq(X_B, E, rcond=None)\n        b0 = coeffs_B[0]\n        \n        # RSS for model B\n        rss_B = residuals_B[0] if residuals_B.size > 0 else 0.0\n        \n        # BIC for model B\n        sigma2_B = rss_B / n\n        sigma2_B_reg = max(sigma2_B, epsilon)\n        bic_B = n * np.log(sigma2_B_reg) + k_B * np.log(n)\n\n        # --- Model Selection a la BIC ---\n        # Prefer simpler model (A) in case of a tie\n        model_preference = 1 if bic_B < bic_A else 0\n        \n        # Store results for this case\n        all_results.append([a0, b0, model_preference])\n\n    # Format the final output string exactly as required, without spaces.\n    sub_results_str = []\n    for a0, b0, m in all_results:\n        formatted_a0 = f\"{a0:.6f}\"\n        formatted_b0 = f\"{b0:.6f}\"\n        sub_results_str.append(f\"[{formatted_a0},{formatted_b0},{m}]\")\n    \n    final_output = f\"[{','.join(sub_results_str)}]\"\n\n    # Final print statement in the exact required format.\n    print(final_output)\n\nsolve()\n```", "id": "3442717"}, {"introduction": "计算缺陷形成能的最终目的之一是确定热力学电荷转变能级 $\\epsilon(q/q')$，它决定了缺陷在不同费米能级下的稳定电荷态。本练习作为一个综合性实践，将利用已校正的形成能来计算这些关键的物理量 [@problem_id:3442716]。此外，本练习还探讨了如何进一步校正这些能级以弥补标准密度泛函理论（DFT）的带隙误差，并比较了简单的“剪刀算符”校正与更复杂的混合泛函校正方案所带来的差异。", "problem": "给定一组假设的缺陷热力学数据，用于探究周期性超胞中电荷跃迁能级的计算。从经过充分检验的缺陷热力学原理出发，推导一个程序，该程序使用两种方法计算修正到格林函数屏蔽库仑（GW）带边的电荷跃迁能级：（i）一种刚性移动导带底的“剪刀算符”（scissors operator），以及（ii）一种同时移动两个带边并修改电荷态总能量的自洽杂化泛函（self-consistent hybrid functionals）。然后，确定这两种方法是否会导致电荷跃迁能级的不同排序。您的程序必须实现以下工作流程，并为提供的测试套件生成所需的输出。\n\n基本原理和定义：\n- 电荷态为 $q$ 的缺陷形成能，以价带顶（VBM）为参考，并在费米能级 $E_{\\mathrm{F}}$ 处进行评估，定义为\n$$\nE_{\\mathrm{f}}(D^q; E_{\\mathrm{F}}) = E_{\\mathrm{tot}}(D^q) - E_{\\mathrm{tot}}(\\text{bulk}) + \\sum_i n_i \\mu_i + q\\,(E_{\\mathrm{F}} + E_{\\mathrm{v}}) + E_{\\mathrm{corr}}(q).\n$$\n此处 $E_{\\mathrm{tot}}$ 表示总能量，$n_i$ 是化学计量整数，$\\mu_i$ 是化学势，$E_{\\mathrm{v}}$ 是价带顶能量，$E_{\\mathrm{corr}}(q)$ 集合了有限尺寸和对齐校正项。在本问题中，这些贡献项在每个测试中都进行了数值参数化。\n- 电荷态 $q$ 和 $q'$（其中 $q' \\neq q$）之间的热力学电荷跃迁能级（以VBM为参考）是它们形成能相等的地方。令 $E_{\\mathrm{F}}$ 满足 $E_{\\mathrm{f}}(D^q; E_{\\mathrm{F}}) = E_{\\mathrm{f}}(D^{q'}; E_{\\mathrm{F}})$ 并求解 $E_{\\mathrm{F}}$，可得\n$$\n\\epsilon(q/q') = \\frac{E_{\\mathrm{f}}(D^q; E_{\\mathrm{F}}{=}0) - E_{\\mathrm{f}}(D^{q'}; E_{\\mathrm{F}}{=}0)}{q' - q}.\n$$\n- $E_{\\mathrm{f}}$ 的校正由镜像电荷项和势能对齐项建模。对电荷态 $q$ 使用以下参数化：\n$$\nE_{\\mathrm{corr}}(q) = k\\,q^2 + \\Delta_{\\mathrm{align}}\\,q,\n$$\n其中 $k$ 和 $\\Delta_{\\mathrm{align}}$ 是每个测试用例给定的常数，单位为电子伏特（eV）。\n- 在剪刀算符方法中，价带顶保持不变，而导带底向上移动 $\\Delta_{\\mathrm{sc}}$。如果密度泛函理论（DFT）带隙为 $E_{\\mathrm{g}}^{\\mathrm{DFT}}$，则剪刀算符下的GW带隙为\n$$\nE_{\\mathrm{g}}^{\\mathrm{GW,sc}} = E_{\\mathrm{g}}^{\\mathrm{DFT}} + \\Delta_{\\mathrm{sc}},\n$$\nVBM参考移动为 $\\Delta_{\\mathrm{VBM}}^{\\mathrm{sc}} = 0$。剪刀算符校正下的电荷跃迁能级仍然以DFT的VBM为参考，但必须被裁剪到GW带隙区间 $[0, E_{\\mathrm{g}}^{\\mathrm{GW,sc}}]$ 内。\n- 在自洽杂化泛函方法中，两个带边都移动给定的量，并且由于自相互作用减小和屏蔽效应变化，带电超胞的总能量也会改变。通过以下方式对杂化泛函移动进行建模：\n$$\n\\Delta E_{\\mathrm{hyb}}(q) = s\\,q + t\\,q^2,\n$$\n相对于DFT的VBM和CBM移动分别为 $\\Delta_{\\mathrm{VBM}}^{\\mathrm{hyb}}$ 和 $\\Delta_{\\mathrm{CBM}}^{\\mathrm{hyb}}$。杂化带隙为\n$$\nE_{\\mathrm{g}}^{\\mathrm{hyb}} = E_{\\mathrm{g}}^{\\mathrm{DFT}} + \\Delta_{\\mathrm{CBM}}^{\\mathrm{hyb}} - \\Delta_{\\mathrm{VBM}}^{\\mathrm{hyb}}.\n$$\n以杂化VBM为参考的杂化校正电荷跃迁能级为\n$$\n\\epsilon_{\\mathrm{hyb}}(q/q') = \\frac{\\left[E_{\\mathrm{f}}(D^q; 0) + \\Delta E_{\\mathrm{hyb}}(q)\\right] - \\left[E_{\\mathrm{f}}(D^{q'}; 0) + \\Delta E_{\\mathrm{hyb}}(q')\\right]}{q' - q} + \\Delta_{\\mathrm{VBM}}^{\\mathrm{hyb}},\n$$\n该值必须被裁剪到 $[0, E_{\\mathrm{g}}^{\\mathrm{hyb}}]$ 区间内。\n- 裁剪规则：如果计算出的 $\\epsilon$ 低于 $0$，则将其设置为 $0$；如果高于其方法的带隙，则将其设置为带隙值。舍入规则：报告所有电荷跃迁能级，以电子伏特为单位，舍入到 $3$ 位小数的浮点数。\n- 排序分析：对于每种情况，比较剪刀算符和杂化泛函方法下跃迁集合的成对排序。使用 $\\delta = 10^{-6}\\ \\mathrm{eV}$ 的容差：对于两个能级 $x$ 和 $y$，如果 $x \\le y - \\delta$，则定义它们的关系为 $x<y$；如果 $x \\ge y + \\delta$，则为 $x>y$；否则为 $x\\sim y$。如果在剪刀算符集合和杂化泛函集合之间，任何成对关系不同，则认为排序不同。\n\n输入数据在程序中针对三个科学上合理的测试用例是固定的。所有能量单位均为电子伏特，所有输出必须按规定以电子伏特报告。\n\n测试套件：\n- 情况 1（来自 $q \\in \\{-1,0,+1\\}$ 的相邻跃迁）：\n    - 电荷：$[-1, 0, +1]$。\n    - $E_{\\mathrm{F}}{=}0$ 时的DFT形成能：$E_{\\mathrm{f}}(D^{-1};0)=2.9\\ \\mathrm{eV}$，$E_{\\mathrm{f}}(D^{0};0)=2.1\\ \\mathrm{eV}$，$E_{\\mathrm{f}}(D^{+1};0)=1.6\\ \\mathrm{eV}$。\n    - 校正：$k=0.04\\ \\mathrm{eV}$，$\\Delta_{\\mathrm{align}}=0.03\\ \\mathrm{eV}$。\n    - DFT带隙：$E_{\\mathrm{g}}^{\\mathrm{DFT}}=1.1\\ \\mathrm{eV}$。\n    - 剪刀算符：$\\Delta_{\\mathrm{sc}}=1.7\\ \\mathrm{eV}$，所以 $\\Delta_{\\mathrm{VBM}}^{\\mathrm{sc}}=0\\ \\mathrm{eV}$。\n    - 杂化泛函移动：$\\Delta_{\\mathrm{VBM}}^{\\mathrm{hyb}}=0.15\\ \\mathrm{eV}$，$\\Delta_{\\mathrm{CBM}}^{\\mathrm{hyb}}=1.90\\ \\mathrm{eV}$；电荷依赖的能量移动参数 $s=0.02\\ \\mathrm{eV}$，$t=0.03\\ \\mathrm{eV}$。\n    - 待评估的跃迁（按此顺序）：$\\epsilon(-1/0)$ 和 $\\epsilon(0/+1)$。\n- 情况 2（能级近简并，可能重排）：\n    - 电荷：$[-1, 0, +1]$。\n    - $E_{\\mathrm{F}}{=}0$ 时的DFT形成能：$E_{\\mathrm{f}}(D^{-1};0)=2.0\\ \\mathrm{eV}$，$E_{\\mathrm{f}}(D^{0};0)=2.05\\ \\mathrm{eV}$，$E_{\\mathrm{f}}(D^{+1};0)=2.1\\ \\mathrm{eV}$。\n    - 校正：$k=0.06\\ \\mathrm{eV}$，$\\Delta_{\\mathrm{align}}=0.02\\ \\mathrm{eV}$。\n    - DFT带隙：$E_{\\mathrm{g}}^{\\mathrm{DFT}}=1.6\\ \\mathrm{eV}$。\n    - 剪刀算符：$\\Delta_{\\mathrm{sc}}=1.0\\ \\mathrm{eV}$，所以 $\\Delta_{\\mathrm{VBM}}^{\\mathrm{sc}}=0\\ \\mathrm{eV}$。\n    - 杂化泛函移动：$\\Delta_{\\mathrm{VBM}}^{\\mathrm{hyb}}=0.25\\ \\mathrm{eV}$，$\\Delta_{\\mathrm{CBM}}^{\\mathrm{hyb}}=0.60\\ \\mathrm{eV}$；电荷依赖的能量移动参数 $s=-0.05\\ \\mathrm{eV}$，$t=0.08\\ \\mathrm{eV}$。\n    - 待评估的跃迁（按此顺序）：$\\epsilon(-1/0)$ 和 $\\epsilon(0/+1)$。\n- 情况 3（扩展的电荷集和更强的镜像电荷效应）：\n    - 电荷：$[-2, -1, 0, +1]$。\n    - $E_{\\mathrm{F}}{=}0$ 时的DFT形成能：$E_{\\mathrm{f}}(D^{-2};0)=3.5\\ \\mathrm{eV}$，$E_{\\mathrm{f}}(D^{-1};0)=2.8\\ \\mathrm{eV}$，$E_{\\mathrm{f}}(D^{0};0)=2.3\\ \\mathrm{eV}$，$E_{\\mathrm{f}}(D^{+1};0)=1.9\\ \\mathrm{eV}$。\n    - 校正：$k=0.10\\ \\mathrm{eV}$，$\\Delta_{\\mathrm{align}}=-0.01\\ \\mathrm{eV}$。\n    - DFT带隙：$E_{\\mathrm{g}}^{\\mathrm{DFT}}=0.9\\ \\mathrm{eV}$。\n    - 剪刀算符：$\\Delta_{\\mathrm{sc}}=2.2\\ \\mathrm{eV}$，所以 $\\Delta_{\\mathrm{VBM}}^{\\mathrm{sc}}=0\\ \\mathrm{eV}$。\n    - 杂化泛函移动：$\\Delta_{\\mathrm{VBM}}^{\\mathrm{hyb}}=-0.20\\ \\mathrm{eV}$，$\\Delta_{\\mathrm{CBM}}^{\\mathrm{hyb}}=2.30\\ \\mathrm{eV}$；电荷依赖的能量移动参数 $s=0.00\\ \\mathrm{eV}$，$t=-0.02\\ \\mathrm{eV}$。\n    - 待评估的跃迁（按此顺序）：$\\epsilon(-2/-1)$，$\\epsilon(-1/0)$ 和 $\\epsilon(0/+1)$。\n\n程序要求：\n- 实现上述定义，并为每个情况计算指定跃迁的剪刀算符校正和杂化泛函校正的电荷跃迁能级，应用给定的 $E_{\\mathrm{corr}}(q)$ 和 $\\Delta E_{\\mathrm{hyb}}(q)$ 以及适当的VBM移动。将能级裁剪到它们各自的带隙区间内，并舍入到 $3$ 位小数。\n- 对于每种情况，使用 $\\delta=10^{-6}\\ \\mathrm{eV}$ 的容差和上面定义的成对关系规则，确定剪刀算符和杂化泛函方法之间的排序是否不同。\n- 最终输出格式：您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果。对于每种情况，包含一个 $[\\text{scissor\\_levels}, \\text{hybrid\\_levels}, \\text{ordering\\_diff}]$ 形式的嵌套列表，其中 $\\text{scissor\\_levels}$ 和 $\\text{hybrid\\_levels}$ 是以电子伏特为单位、舍入到3位小数的浮点数列表（按指定的跃迁顺序），而 $\\text{ordering\\_diff}$ 是一个布尔值。三个情况的结果必须按顺序出现，形成一个顶层列表。例如，输出必须看起来像 $[[\\ldots],[\\ldots],[\\ldots]]$，不含任何额外文本。", "solution": "问题陈述经评估有效。它在科学上基于计算材料科学中的缺陷热力学原理，问题定义明确，数据充分且一致，并以客观方式表述。该问题要求实现用于校正缺陷电荷跃迁能级的既定模型，并对结果进行后续分析。\n\n解决方案首先通过算法定义在两种不同校正方案——剪刀算符和自洽杂化泛函方法——下计算电荷跃迁能级的步骤，然后比较所得能级的相对排序。\n\n基本量是热力学电荷跃迁能级 $\\epsilon(q/q')$，它在电荷态 $q$ 和 $q'$ 之间，由下式给出：\n$$\n\\epsilon(q/q') = \\frac{E_{\\mathrm{f}}(D^q; E_{\\mathrm{F}}{=}0) - E_{\\mathrm{f}}(D^{q'}; E_{\\mathrm{F}}{=}0)}{q' - q}\n$$\n此处，$E_{\\mathrm{f}}(D^q; E_{\\mathrm{F}}{=}0)$ 是当费米能级 $E_{\\mathrm{F}}$ 位于价带顶时（按惯例 $E_{\\mathrm{F}}=0$），电荷态为 $q$ 的缺陷的形成能。问题提供了基准的密度泛函理论（DFT）形成能，必须首先对其进行有限尺寸效应校正。对电荷 $q$ 的校正被参数化为：\n$$\nE_{\\mathrm{corr}}(q) = k\\,q^2 + \\Delta_{\\mathrm{align}}\\,q\n$$\n设 $E_{\\mathrm{f}}^{\\mathrm{DFT}}(D^q; 0)$ 为测试套件中给定的DFT形成能。完全校正后的DFT形成能，作为进一步校正的基准，是：\n$$\nE_{\\mathrm{f}}^{\\mathrm{corr}}(D^q; 0) = E_{\\mathrm{f}}^{\\mathrm{DFT}}(D^q; 0) + E_{\\mathrm{corr}}(q)\n$$\n\n然后对两种方法进行计算：\n\n**1. 剪刀算符方法**\n\n在此方法中，DFT能带结构被刚性移动。价带顶（VBM）保持固定（$\\Delta_{\\mathrm{VBM}}^{\\mathrm{sc}} = 0$），导带底（CBM）向上移动 $\\Delta_{\\mathrm{sc}}$。电荷跃迁能级使用校正后的DFT形成能计算，然后裁剪到所得的带隙内。\n\n对于一个跃迁 $(q, q')$，能级计算如下：\n$$\n\\epsilon_{\\mathrm{sc}}^{\\mathrm{unclipped}}(q/q') = \\frac{E_{\\mathrm{f}}^{\\mathrm{corr}}(D^q; 0) - E_{\\mathrm{f}}^{\\mathrm{corr}}(D^{q'}; 0)}{q' - q}\n$$\n新的带隙是 $E_{\\mathrm{g}}^{\\mathrm{GW,sc}} = E_{\\mathrm{g}}^{\\mathrm{DFT}} + \\Delta_{\\mathrm{sc}}$。最终能级被裁剪到区间 $[0, E_{\\mathrm{g}}^{\\mathrm{GW,sc}}]$ 内：\n$$\n\\epsilon_{\\mathrm{sc}}(q/q') = \\max(0, \\min(\\epsilon_{\\mathrm{sc}}^{\\mathrm{unclipped}}(q/q'), E_{\\mathrm{g}}^{\\mathrm{GW,sc}}))\n$$\n\n**2. 自洽杂化泛函方法**\n\n此方法涉及对两个带边和缺陷总能量的移动。电荷态 $q$ 的总能量被一个依赖于电荷的项进一步修正：\n$$\n\\Delta E_{\\mathrm{hyb}}(q) = s\\,q + t\\,q^2\n$$\n用于跃迁能级计算的形成能现在是 $E_{\\mathrm{f}}^{\\mathrm{hyb}}(D^q; 0) = E_{\\mathrm{f}}^{\\mathrm{corr}}(D^q; 0) + \\Delta E_{\\mathrm{hyb}}(q)$。VBM本身也移动了 $\\Delta_{\\mathrm{VBM}}^{\\mathrm{hyb}}$。现在以新的杂化泛函VBM为参考的跃迁能级是：\n$$\n\\epsilon_{\\mathrm{hyb}}^{\\mathrm{unclipped}}(q/q') = \\frac{E_{\\mathrm{f}}^{\\mathrm{hyb}}(D^q; 0) - E_{\\mathrm{f}}^{\\mathrm{hyb}}(D^{q'}; 0)}{q' - q} + \\Delta_{\\mathrm{VBM}}^{\\mathrm{hyb}}\n$$\n杂化泛函带隙是 $E_{\\mathrm{g}}^{\\mathrm{hyb}} = E_{\\mathrm{g}}^{\\mathrm{DFT}} + \\Delta_{\\mathrm{CBM}}^{\\mathrm{hyb}} - \\Delta_{\\mathrm{VBM}}^{\\mathrm{hyb}}$。最终能级被裁剪到区间 $[0, E_{\\mathrm{g}}^{\\mathrm{hyb}}]$ 内：\n$$\n\\epsilon_{\\mathrm{hyb}}(q/q') = \\max(0, \\min(\\epsilon_{\\mathrm{hyb}}^{\\mathrm{unclipped}}(q/q'), E_{\\mathrm{g}}^{\\mathrm{hyb}}))\n$$\n\n**3. 排序分析**\n\n对于每个测试用例，我们计算剪刀算符方法的一组跃迁能级 $L_{\\mathrm{sc}}$ 和杂化泛函方法的一组跃迁能级 $L_{\\mathrm{hyb}}$。为确定排序是否已改变，我们比较每个集合内每对能级之间的成对关系。对于任意两个能级 $x$ 和 $y$，它们的关系用容差 $\\delta = 10^{-6}\\ \\mathrm{eV}$ 定义：\n- 如果 $x \\le y - \\delta$，则 $x < y$\n- 如果 $x \\ge y + \\delta$，则 $x > y$\n- 否则，$x \\sim y$\n\n如果对于一组中的任意一对能级 $(x_i, x_j)$，其关系与另一组中对应对 $(y_i, y_j)$ 的关系不同，则认为排序不同。此比较在计算出的能级的未舍入浮点值上执行。最终报告的值按要求舍入到3位小数。\n\n实现将通过顺序应用这些步骤来处理所提供套件中的每个测试用例。一个辅助函数将管理成对排序比较逻辑。每个用例的结果，包含两个计算出的能级列表和一个指示排序是否不同的布尔值，将被汇总到一个最终列表中以供输出。", "answer": "```python\nimport numpy as np\nimport itertools\n\ndef solve():\n    \"\"\"\n    Computes and compares charge transition levels for defect thermodynamics\n    using scissors-operator and hybrid-functional corrections.\n    \"\"\"\n\n    test_cases = [\n        {\n            \"name\": \"Case 1\",\n            \"charges\": {\n                -1: 2.9,\n                0: 2.1,\n                1: 1.6\n            },\n            \"transitions\": [(-1, 0), (0, 1)],\n            \"k\": 0.04, \"d_align\": 0.03, \"e_g_dft\": 1.1, \"d_sc\": 1.7,\n            \"d_vbm_hyb\": 0.15, \"d_cbm_hyb\": 1.90, \"s\": 0.02, \"t\": 0.03\n        },\n        {\n            \"name\": \"Case 2\",\n            \"charges\": {\n                -1: 2.0,\n                0: 2.05,\n                1: 2.1\n            },\n            \"transitions\": [(-1, 0), (0, 1)],\n            \"k\": 0.06, \"d_align\": 0.02, \"e_g_dft\": 1.6, \"d_sc\": 1.0,\n            \"d_vbm_hyb\": 0.25, \"d_cbm_hyb\": 0.60, \"s\": -0.05, \"t\": 0.08\n        },\n        {\n            \"name\": \"Case 3\",\n            \"charges\": {\n                -2: 3.5,\n                -1: 2.8,\n                0: 2.3,\n                1: 1.9\n            },\n            \"transitions\": [(-2, -1), (-1, 0), (0, 1)],\n            \"k\": 0.10, \"d_align\": -0.01, \"e_g_dft\": 0.9, \"d_sc\": 2.2,\n            \"d_vbm_hyb\": -0.20, \"d_cbm_hyb\": 2.30, \"s\": 0.00, \"t\": -0.02\n        }\n    ]\n\n    final_results = []\n    \n    TOLERANCE = 1e-6\n\n    def get_relation(x, y, delta):\n        if x <= y - delta:\n            return -1  # Less than\n        if x >= y + delta:\n            return 1   # Greater than\n        return 0       # Approximately equal\n    \n    def check_ordering_diff(levels1, levels2, delta):\n        n = len(levels1)\n        if n < 2:\n            return False\n        \n        indices = range(n)\n        for i, j in itertools.combinations(indices, 2):\n            rel1 = get_relation(levels1[i], levels1[j], delta)\n            rel2 = get_relation(levels2[i], levels2[j], delta)\n            if rel1 != rel2:\n                return True\n        return False\n\n    for case in test_cases:\n        params = case\n\n        # Step 1: Calculate corrected DFT formation energies\n        ef_corr_dft = {}\n        for q, ef_dft in params[\"charges\"].items():\n            ecorr = params[\"k\"] * q**2 + params[\"d_align\"] * q\n            ef_corr_dft[q] = ef_dft + ecorr\n\n        # Step 2: Scissors-Operator Approach\n        scissor_levels_raw = []\n        e_g_gw_sc = params[\"e_g_dft\"] + params[\"d_sc\"]\n        for q_from, q_to in params[\"transitions\"]:\n            numerator = ef_corr_dft[q_from] - ef_corr_dft[q_to]\n            denominator = q_to - q_from\n            eps_unclipped = numerator / denominator\n            eps_clipped = np.clip(eps_unclipped, 0, e_g_gw_sc)\n            scissor_levels_raw.append(eps_clipped)\n\n        # Step 3: Hybrid-Functional Approach\n        hybrid_levels_raw = []\n        e_g_hyb = params[\"e_g_dft\"] + params[\"d_cbm_hyb\"] - params[\"d_vbm_hyb\"]\n        for q_from, q_to in params[\"transitions\"]:\n            de_hyb_from = params[\"s\"] * q_from + params[\"t\"] * q_from**2\n            de_hyb_to = params[\"s\"] * q_to + params[\"t\"] * q_to**2\n            \n            ef_hyb_from = ef_corr_dft[q_from] + de_hyb_from\n            ef_hyb_to = ef_corr_dft[q_to] + de_hyb_to\n            \n            numerator = ef_hyb_from - ef_hyb_to\n            denominator = q_to - q_from\n            \n            eps_unclipped = (numerator / denominator) + params[\"d_vbm_hyb\"]\n            eps_clipped = np.clip(eps_unclipped, 0, e_g_hyb)\n            hybrid_levels_raw.append(eps_clipped)\n\n        # Step 4: Ordering Analysis\n        ordering_diff = check_ordering_diff(scissor_levels_raw, hybrid_levels_raw, TOLERANCE)\n\n        # Assemble results for the case\n        scissor_levels_rounded = [round(lvl, 3) for lvl in scissor_levels_raw]\n        hybrid_levels_rounded = [round(lvl, 3) for lvl in hybrid_levels_raw]\n        \n        final_results.append([\n            scissor_levels_rounded,\n            hybrid_levels_rounded,\n            ordering_diff\n        ])\n\n    # Final print statement in the exact required format\n    print(str(final_results).replace(\" \", \"\"))\n\nsolve()\n\n```", "id": "3442716"}]}