{"hands_on_practices": [{"introduction": "本练习至关重要，它在局域化的抽象定义与一个具体、可计算的量之间架起了桥梁。我们将从一个普遍的非正交基矢出发（这在使用类原子轨道作为初始猜测时很常见），在离散的$k$空间中推导局域化泛函。这个练习将阐明最大局域化瓦尼尔函数（MLWF）流程究竟在最小化什么 ([@problem_id:3502300])。", "problem": "考虑在晶体动量 $\\mathbf{k}$ 处的一组非正交紧束缚类布洛赫态 $\\{|\\phi_{m}(\\mathbf{k})\\rangle\\}_{m=1}^{N}$，它们张成一个选定的 $N$ 维子空间。它们的重叠矩阵为 $S_{mn}(\\mathbf{k})=\\langle\\phi_{m}(\\mathbf{k})|\\phi_{n}(\\mathbf{k})\\rangle$，并假定对于每个 $\\mathbf{k}$，该矩阵都是厄米且正定的。定义 Löwdin 正交化的类布洛赫态为 $|\\tilde{\\phi}_{m}(\\mathbf{k})\\rangle=\\sum_{n}|\\phi_{n}(\\mathbf{k})\\rangle\\left[S^{-1/2}(\\mathbf{k})\\right]_{nm}$，使得 $\\langle\\tilde{\\phi}_{m}(\\mathbf{k})|\\tilde{\\phi}_{n}(\\mathbf{k})\\rangle=\\delta_{mn}$。设 $N_{\\mathbf{k}}$ 为均匀布里渊区（BZ）网格中 $\\mathbf{k}$ 点的数量，并设 $\\{\\mathbf{b}\\}$ 表示一个对称的有限差分近邻点集，其权重为 $\\{w_{\\mathbf{b}}\\}$，满足 $\\sum_{\\mathbf{b}}w_{\\mathbf{b}}\\mathbf{b}=\\mathbf{0}$ 和 $\\sum_{\\mathbf{b}}w_{\\mathbf{b}}b_{\\mu}b_{\\nu}=\\delta_{\\mu\\nu}$，其中 $\\mu,\\nu\\in\\{x,y,z\\}$ 为笛卡尔分量。\n\n定义近邻点之间的原始 $\\mathbf{k}$ 点间重叠矩阵，\n$$\nM^{(0)}_{mn}(\\mathbf{k},\\mathbf{b})=\\langle\\phi_{m}(\\mathbf{k})|\\phi_{n}(\\mathbf{k}+\\mathbf{b})\\rangle,\n$$\n及其经过 Löwdin 正交化的对应矩阵，\n$$\n\\tilde{M}_{mn}(\\mathbf{k},\\mathbf{b})=\\langle\\tilde{\\phi}_{m}(\\mathbf{k})|\\tilde{\\phi}_{n}(\\mathbf{k}+\\mathbf{b})\\rangle.\n$$\n最大局域化瓦尼尔函数（MLWF）是由布里渊区上光滑规范的类布洛赫态构造而来的，其二次展宽泛函是位置算符的二阶中心矩在所有能带上的总和。仅使用以下基本依据：(i) 布洛赫定理以及瓦尼尔函数作为光滑类布洛赫态的傅里叶变换的定义，(ii) 二次展宽作为瓦尼尔态上位置方差的定义，以及 (iii) Löwdin 正交化过程，推导在 Löwdin 正交化空间中广义 MLWF 展宽泛函的一个离散、周期规范表达式，该表达式应完全用均匀网格上的 $S_{mn}(\\mathbf{k})$ 和 $M^{(0)}_{mn}(\\mathbf{k},\\mathbf{b})$ 表示。对于相位，使用复对数的主支，即对于任意复数 $z\\neq 0$，令 $\\arg(z)=\\Im\\ln z\\in(-\\pi,\\pi]$。您的最终表达式应为一个单一的闭合形式解析表达式，仅包含对 $\\mathbf{k}$、$\\mathbf{b}$、$S^{-1/2}(\\mathbf{k})$ 和 $M^{(0)}(\\mathbf{k},\\mathbf{b})$ 的求和，并且不应引入任何未由这些量定义的新量。无需进行数值计算。请将您的答案表示为单个解析表达式。如果需要引入瓦尼尔中心，必须将其消去，替换为相同的 $\\mathbf{k}$ 点间相位的组合，从而在网格上得到一个闭合形式的泛函。", "solution": "用户希望我扮演一位 STEM 领域的严谨细致的教授，解决一个与计算材料科学相关的问题。\n\n### 问题验证\n\n**第 1 步：提取已知条件**\n\n*   一组 $N$ 个非正交的类布洛赫态 $\\{|\\phi_{m}(\\mathbf{k})\\rangle\\}$，位于晶体动量 $\\mathbf{k}$ 处。\n*   重叠矩阵：$S_{mn}(\\mathbf{k})=\\langle\\phi_{m}(\\mathbf{k})|\\phi_{n}(\\mathbf{k})\\rangle$，该矩阵是厄米且正定的。\n*   Löwdin 正交化态：$|\\tilde{\\phi}_{m}(\\mathbf{k})\\rangle=\\sum_{n}|\\phi_{n}(\\mathbf{k})\\rangle\\left[S^{-1/2}(\\mathbf{k})\\right]_{nm}$。\n*   Löwdin 态的正交性：$\\langle\\tilde{\\phi}_{m}(\\mathbf{k})|\\tilde{\\phi}_{n}(\\mathbf{k})\\rangle=\\delta_{mn}$。\n*   具有 $N_{\\mathbf{k}}$ 个点的均匀布里渊区（BZ）网格。\n*   带有权重 $\\{w_{\\mathbf{b}}\\}$ 的对称有限差分近邻点集 $\\{\\mathbf{b}\\}$。\n*   近邻点集和权重的性质：对于笛卡尔分量 $\\mu,\\nu$，有 $\\sum_{\\mathbf{b}}w_{\\mathbf{b}}\\mathbf{b}=\\mathbf{0}$ 和 $\\sum_{\\mathbf{b}}w_{\\mathbf{b}}b_{\\mu}b_{\\nu}=\\delta_{\\mu\\nu}$。\n*   原始 $\\mathbf{k}$ 点间重叠矩阵：$M^{(0)}_{mn}(\\mathbf{k},\\mathbf{b})=\\langle\\phi_{m}(\\mathbf{k})|\\phi_{n}(\\mathbf{k}+\\mathbf{b})\\rangle$。\n*   Löwdin 正交化的 $\\mathbf{k}$ 点间重叠矩阵：$\\tilde{M}_{mn}(\\mathbf{k},\\mathbf{b})=\\langle\\tilde{\\phi}_{m}(\\mathbf{k})|\\tilde{\\phi}_{n}(\\mathbf{k}+\\mathbf{b})\\rangle$。\n*   任务：在 Löwdin 正交化空间中，使用离散 BZ 表示推导二次展宽泛函 $\\Omega$。\n*   限制条件：最终表达式必须是仅用 $S_{mn}(\\mathbf{k})$ 和 $M^{(0)}_{mn}(\\mathbf{k},\\mathbf{b})$ 表示的单一闭合形式表达式。必须消去瓦尼尔中心。相位计算需使用复对数的主支，$\\arg(z)=\\Im\\ln z\\in(-\\pi,\\pi]$。\n\n**第 2 步：使用提取的已知条件进行验证**\n\n*   **科学上合理：** 该问题牢固地植根于现代极化理论和最大局域化瓦尼尔函数（MLWFs）方法，后者是计算材料科学的基石。所有概念，包括布洛赫态、Löwdin 正交化以及展宽泛函的离散表示，都是标准且成熟的。\n*   **提法恰当：** 这是一个提法恰当的问题。它要求在一组清晰的定义和约束条件（离散 k 空间，特定基矢）下，对一个已知的物理量（展宽泛函）进行具体推导。预计存在唯一的解析表达式。\n*   **客观性：** 该问题以精确、客观的技术语言表述，没有歧义或主观内容。\n*   **结论：** 该问题在科学上是合理的，提法恰当、客观且完整。\n\n**第 3 步：判断与行动**\n\n该问题有效。我将开始进行推导。\n\n### 解题推导\n\n一组 $N$ 个瓦尼尔函数的总二次展宽泛函 $\\Omega$ 是各个展宽（位置算符 $\\mathbf{r}$ 的二阶中心矩）的总和：\n$$\n\\Omega = \\sum_{n=1}^{N} \\Omega_n = \\sum_{n=1}^{N} \\left( \\langle w_n | \\mathbf{r}^2 | w_n \\rangle - |\\langle w_n | \\mathbf{r} | w_n \\rangle|^2 \\right)\n$$\n其中 $|w_n\\rangle$ 表示局域在原胞中、对应能带 $n$ 的瓦尼尔函数，而 $\\langle w_n | \\mathbf{r} | w_n \\rangle = \\bar{\\mathbf{r}}_n$ 是瓦尼尔中心。该问题要求为直接由离散布里渊区（BZ）网格上的 Löwdin 正交化类布洛赫态 $|\\tilde{\\phi}_{n}(\\mathbf{k})\\rangle$ 构造的瓦尼尔函数推导此泛函的表达式。\n\n推导过程分为几个步骤：\n1.  将展宽泛函中的两项，即 $\\sum_n \\langle r^2 \\rangle_n$ 和 $\\sum_n |\\bar{\\mathbf{r}}_n|^2$，用 k 空间中的量来表示。\n2.  使用给定的有限差分方案将这些 k 空间表达式离散化。\n3.  将得到的公式用给定的重叠矩阵 $S(\\mathbf{k})$ 和 $M^{(0)}(\\mathbf{k},\\mathbf{b})$ 来表示。\n\n**1. 二阶矩之和 $\\sum_n \\langle r^2 \\rangle_n$**\n\n所有瓦尼尔函数上位置算符的二阶矩之和可以与贝里联络矩阵的平方的迹联系起来。在连续谱下，此项为：\n$$\n\\sum_{n=1}^{N} \\langle w_n | r^2 | w_n \\rangle = \\frac{V}{(2\\pi)^d} \\int_{\\mathrm{BZ}} d^d k \\, \\sum_{m,n=1}^{N} |\\mathbf{A}_{mn}(\\mathbf{k})|^2\n$$\n其中 $\\mathbf{A}_{mn}(\\mathbf{k}) = \\langle u_{m\\mathbf{k}} | i\\nabla_{\\mathbf{k}} | u_{n\\mathbf{k}} \\rangle$ 是贝里联络，且 $|\\psi_{n\\mathbf{k}}\\rangle = e^{i\\mathbf{k}\\cdot\\mathbf{r}}|u_{n\\mathbf{k}}\\rangle$。态 $|\\psi_{n\\mathbf{k}}\\rangle$ 是用于构造瓦尼尔函数的光滑布洛赫态。在本问题中， $|\\psi_{n\\mathbf{k}}\\rangle = |\\tilde{\\phi}_{n}(\\mathbf{k})\\rangle$。\n\n在离散 BZ 中，此项由一个基于 $\\mathbf{k}$ 点间重叠矩阵 $\\tilde{M}(\\mathbf{k}, \\mathbf{b})$ 的矩阵对数的局域化泛函表示。贝里联络矩阵元平方和的有限差分表示由下式给出：\n$$\n\\sum_{n=1}^{N} \\langle w_n | r^2 | w_n \\rangle = \\frac{1}{N_{\\mathbf{k}}} \\sum_{\\mathbf{k},\\mathbf{b}} w_{\\mathbf{b}} \\mathrm{Tr}\\left[ \\left(\\log \\tilde{M}(\\mathbf{k},\\mathbf{b})\\right)^\\dagger \\log \\tilde{M}(\\mathbf{k},\\mathbf{b}) \\right]\n$$\n其中 $\\log$ 表示矩阵对数。权重 $\\{w_{\\mathbf{b}}\\}$ 的性质确保了此表达式对应于正确的连续谱极限。\n\n**2. 瓦尼尔中心平方和 $\\sum_n |\\bar{\\mathbf{r}}_n|^2$**\n\n瓦尼尔中心 $\\bar{\\mathbf{r}}_n$ 是位置算符在瓦尼尔态 $|w_n\\rangle$ 中的期望值。在 k 空间中，这是贝里联络对角元在 BZ 上的平均值：\n$$\n\\bar{\\mathbf{r}}_n = \\frac{1}{N_{\\mathbf{k}}} \\sum_{\\mathbf{k}} \\mathbf{A}_{nn}(\\mathbf{k})\n$$\n向量 $\\mathbf{A}_{nn}(\\mathbf{k})$ 可以从重叠矩阵 $\\tilde{M}(\\mathbf{k},\\mathbf{b})$ 对角元的相位中获得。对于一个小的位移 $\\mathbf{b}$，我们有 $\\mathbf{b}\\cdot\\mathbf{A}_{nn}(\\mathbf{k}) \\approx \\Im \\ln \\tilde{M}_{nn}(\\mathbf{k},\\mathbf{b}) = \\arg(\\tilde{M}_{nn}(\\mathbf{k},\\mathbf{b}))$。利用性质 $\\sum_{\\mathbf{b}} w_{\\mathbf{b}} b_\\mu b_\\nu = \\delta_{\\mu\\nu}$，我们可以投影出 $\\mathbf{A}_{nn}(\\mathbf{k})$ 的笛卡尔分量：\n$$\nA_{nn,\\mu}(\\mathbf{k}) = \\sum_{\\nu} \\delta_{\\mu\\nu} A_{nn,\\nu}(\\mathbf{k}) = \\sum_{\\nu} \\left(\\sum_{\\mathbf{b}} w_{\\mathbf{b}} b_\\mu b_\\nu\\right) A_{nn,\\nu}(\\mathbf{k}) = \\sum_{\\mathbf{b}} w_{\\mathbf{b}} b_\\mu (\\mathbf{b}\\cdot\\mathbf{A}_{nn}(\\mathbf{k}))\n$$\n代入相位近似，我们得到贝里联络向量的离散表示：\n$$\n\\mathbf{A}_{nn}(\\mathbf{k}) \\approx \\sum_{\\mathbf{b}} w_{\\mathbf{b}} \\mathbf{b} \\, \\Im\\ln \\left( \\tilde{M}_{nn}(\\mathbf{k},\\mathbf{b}) \\right)\n$$\n因此，瓦尼尔中心为：\n$$\n\\bar{\\mathbf{r}}_n = \\frac{1}{N_{\\mathbf{k}}} \\sum_{\\mathbf{k}} \\sum_{\\mathbf{b}} w_{\\mathbf{b}} \\mathbf{b} \\, \\Im\\ln \\left( \\tilde{M}_{nn}(\\mathbf{k},\\mathbf{b}) \\right)\n$$\n其平方和为：\n$$\n\\sum_{n=1}^{N} |\\bar{\\mathbf{r}}_n|^2 = \\sum_{n=1}^{N} \\left| \\frac{1}{N_{\\mathbf{k}}} \\sum_{\\mathbf{k},\\mathbf{b}} w_{\\mathbf{b}} \\mathbf{b} \\, \\Im\\ln \\left( \\tilde{M}_{nn}(\\mathbf{k},\\mathbf{b}) \\right) \\right|^2\n$$\n\n**3. 用 $S$ 和 $M^{(0)}$ 表示的最终表达式**\n\n我们将这两项的表达式合并，并代入 $\\tilde{M}(\\mathbf{k},\\mathbf{b})$ 的定义。Löwdin 正交化的重叠矩阵 $\\tilde{M}(\\mathbf{k},\\mathbf{b})$ 通过 Löwdin 变换与原始重叠矩阵 $M^{(0)}(\\mathbf{k},\\mathbf{b})$ 相关联：\n$$\n|\\tilde{\\phi}_{m}(\\mathbf{k})\\rangle = \\sum_{p} |\\phi_{p}(\\mathbf{k})\\rangle [S(\\mathbf{k})^{-1/2}]_{pm}\n$$\n$$\n\\langle\\tilde{\\phi}_{m}(\\mathbf{k})| = \\sum_{p} \\langle\\phi_{p}(\\mathbf{k})| [S(\\mathbf{k})^{-1/2}]_{mp} \\quad \\text{(因为 } S^{-1/2} \\text{ 是厄米的)}\n$$\n因此，\n$$\n\\tilde{M}_{mn}(\\mathbf{k},\\mathbf{b}) = \\langle\\tilde{\\phi}_{m}(\\mathbf{k})|\\tilde{\\phi}_{n}(\\mathbf{k}+\\mathbf{b})\\rangle = \\sum_{p,q} [S(\\mathbf{k})^{-1/2}]_{mp} \\langle\\phi_{p}(\\mathbf{k})|\\phi_{q}(\\mathbf{k}+\\mathbf{b})\\rangle [S(\\mathbf{k}+\\mathbf{b})^{-1/2}]_{qn}\n$$\n用矩阵表示法，即为：\n$$\n\\tilde{M}(\\mathbf{k},\\mathbf{b}) = S(\\mathbf{k})^{-1/2} M^{(0)}(\\mathbf{k},\\mathbf{b}) S(\\mathbf{k}+\\mathbf{b})^{-1/2}\n$$\n将此式代入展宽泛函各分量的表达式中，即可得到 $\\Omega$ 的最终表达式。\n\n完整的二次展宽泛函 $\\Omega$ 为：\n$$\n\\Omega = \\frac{1}{N_{\\mathbf{k}}} \\sum_{\\mathbf{k},\\mathbf{b}} w_{\\mathbf{b}} \\mathrm{Tr}\\left[ \\left(\\log \\tilde{M}(\\mathbf{k},\\mathbf{b})\\right)^\\dagger \\log \\tilde{M}(\\mathbf{k},\\mathbf{b}) \\right] - \\sum_{n=1}^{N} \\left| \\frac{1}{N_{\\mathbf{k}}} \\sum_{\\mathbf{k},\\mathbf{b}} w_{\\mathbf{b}} \\mathbf{b} \\, \\Im\\ln \\left( \\tilde{M}_{nn}(\\mathbf{k},\\mathbf{b}) \\right) \\right|^2\n$$\n其中 $\\tilde{M}(\\mathbf{k},\\mathbf{b}) = S(\\mathbf{k})^{-1/2} M^{(0)}(\\mathbf{k},\\mathbf{b}) S(\\mathbf{k}+\\mathbf{b})^{-1/2}$。这就是所要求的、满足问题所有标准的单一闭合形式解析表达式。", "answer": "$$\n\\boxed{\\frac{1}{N_{\\mathbf{k}}} \\sum_{\\mathbf{k},\\mathbf{b}} w_{\\mathbf{b}} \\mathrm{Tr}\\left[ \\left(\\log \\tilde{M}(\\mathbf{k},\\mathbf{b})\\right)^\\dagger \\log \\tilde{M}(\\mathbf{k},\\mathbf{b}) \\right] - \\sum_{n=1}^{N} \\left| \\frac{1}{N_{\\mathbf{k}}} \\sum_{\\mathbf{k},\\mathbf{b}} w_{\\mathbf{b}} \\mathbf{b} \\, \\Im\\ln \\left( \\tilde{M}_{nn}(\\mathbf{k},\\mathbf{b}) \\right) \\right|^2 \\quad \\text{其中} \\quad \\tilde{M}(\\mathbf{k},\\mathbf{b}) = S(\\mathbf{k})^{-1/2} M^{(0)}(\\mathbf{k},\\mathbf{b}) S(\\mathbf{k}+\\mathbf{b})^{-1/2}}\n$$", "id": "3502300"}, {"introduction": "从理论转向代码，本练习将指导您为一个简单的一维紧束缚模型构建瓦尼尔表示。您将实现从将布洛赫态投影到初始轨道，到通过局域化展宽和能带插值误差来评估所得瓦尼尔函数质量的关键步骤。这项实践将揭示初始投影的选择如何影响最终的局域化效果 ([@problem_id:3502323])。", "problem": "考虑一个一维晶格，其晶格常数为 $a$，每个晶胞有两个正交的类原子轨道，记为 $|s\\rangle$ 和 $|p\\rangle$。假设一个紧束缚近似描述，其中作用在轨道基 $\\{|s\\rangle,|p\\rangle\\}$ 上的布洛赫哈密顿量 $H(k)$ 由以下 $2\\times 2$ 的厄米矩阵定义，对于布里渊区 $[-\\pi,\\pi)$ 中的晶体动量 $k$（以弧度为单位）：\n$$\nH(k) \\;=\\;\n\\begin{pmatrix}\n\\varepsilon_s + 2 t_s \\cos(k a)  & 2 t_{sp} \\, i \\sin(k a) \\\\\n- 2 t_{sp} \\, i \\sin(k a)  & \\varepsilon_p + 2 t_p \\cos(k a)\n\\end{pmatrix},\n$$\n在本问题中，$a$ 被归一化为 $a=1$。使用以下参数集：\n$$\n\\varepsilon_s = 0,\\quad \\varepsilon_p = 1.5,\\quad t_s = -1.0,\\quad t_p = -0.2,\\quad t_{sp} = 0.4.\n$$\n根据布洛赫定理和标准线性代数，对于每个 $k$ 值，存在 $H(k)$ 的两个正交本征矢量 $|\\psi_{k,1}\\rangle$ 和 $|\\psi_{k,2}\\rangle$，其对应的本征值为 $E_1(k)$ 和 $E_2(k)$。\n\n最大局域化瓦尼尔函数 (MLWF) 是通过为胞周期布洛赫函数选择一个光滑规范并将其傅里叶变换到实空间来构建的。在实际计算中，一个常见的初始化方法是将布洛赫本征态投影到用户定义的试探轨道上，并对得到的投影进行 Löwdin 正交归一化，以获得一个光滑且依赖于 $k$ 的幺正规范。初始试探轨道的选择会影响此规范的光滑性、所得瓦尼尔函数的空间局域性（展宽），以及哈密顿量在瓦尼尔基下的局域性，后者控制着截断实空间跃迁范围时的插值误差。\n\n你的任务是，从第一性原理出发，实现以下流程，并针对不同试探轨道的选择计算定量诊断指标。\n\n需要使用的基本基组和定义：\n- 使用布洛赫定理对角化 $H(k)$，得到 $E_n(k)$ 和 $|\\psi_{k,n}\\rangle$。\n- 给定试探轨道 $\\{|g_m\\rangle\\}_{m=1}^{N_w}$（其中 $N_w=2$），定义每个 $k$ 点的投影矩阵，其矩阵元为 $A_{n m}(k) = \\langle \\psi_{k,n} | g_m \\rangle$。\n- 定义 Löwdin 正交归一化的规范混合矩阵 $U(k)$，其形状为 $2\\times 2$，由 $U(k) = A(k)\\, [A(k)^\\dagger A(k)]^{-1/2}$ 给出，其中 $[\\,\\cdot\\,]^{-1/2}$ 表示厄米逆平方根。\n- 瓦尼尔规范下的胞周期布洛赫函数是 $|u_{k}^{(m)}\\rangle = \\sum_{n=1}^{2} |\\psi_{k,n}\\rangle \\, U_{n m}(k)$（对于 $m=1,2$）的列向量。\n- 在均匀网格上，定义相邻 $k$ 点之间的 k空间最近邻交叠矩阵为 $M_{m n}(k) = \\langle u_{k}^{(m)} | u_{k+\\Delta k}^{(n)} \\rangle$，并在 $k$ 空间采用周期性边界条件。\n- 作为一维中的定量展宽度量，使用离散化的总展宽\n$$\n\\Omega \\;=\\; \\sum_{k} \\left[ \\sum_{n=1}^{2} \\left( 1 - |M_{n n}(k)|^2 \\right) \\;+\\; \\sum_{\\substack{m,n=1 \\\\ m\\neq n}}^{2} |M_{m n}(k)|^2 \\right],\n$$\n在给定 $a=1$ 的情况下，该值为无量纲（单位为 $a^2$）。\n- 每个 $k$ 点的瓦尼尔规范下的哈密顿量为 $H_W(k) = U(k)^\\dagger \\, \\mathrm{diag}(E_1(k), E_2(k)) \\, U(k)$。\n- 通过离散傅里叶变换定义实空间跃迁矩阵 $h(R) = \\frac{1}{N_k} \\sum_{j=0}^{N_k-1} H_W(k_j) \\, e^{-i k_j R}$，其中 $\\{k_j\\}$ 是 $[-\\pi,\\pi)$ 区间上 $N_k$ 个点的均匀网格，$R$ 是一个整数格矢（单位为 $a$）。\n- 对于一个截断半径 $R_{\\max}$，定义截断插值哈密顿量 $H_{\\mathrm{interp}}(k) = \\sum_{R=-R_{\\max}}^{R_{\\max}} h(R) \\, e^{i k R}$。\n- 通过以下公式量化能带插值误差\n$$\n\\Delta_{\\mathrm{MAE}} \\;=\\; \\frac{1}{2 N_k} \\sum_{j=0}^{N_k-1} \\sum_{n=1}^{2} \\left| E_n(k_j) - \\widetilde{E}_n(k_j) \\right|,\n$$\n其中 $\\{\\widetilde{E}_n(k_j)\\}$ 是 $H_{\\mathrm{interp}}(k_j)$ 按升序排列的本征值，$E_n(k_j)$ 是 $H(k_j)$ 按升序排列的原始本征值。角度以弧度表示，并设 $a=1$，因此 $\\Omega$ 是无量纲的，$\\Delta_{\\mathrm{MAE}}$ 的能量单位与上述参数一致。\n\n实现此流程并评估以下测试套件，该套件探讨了试探轨道选择和截断的影响：\n\n- 测试用例1（理想情况）：试探集 $\\mathrm{A}$，其中 $|g_1\\rangle = |s\\rangle$ 和 $|g_2\\rangle = |p\\rangle$，使用 $N_k = 201$ 的均匀网格，截断半径 $R_{\\max} = 1$。\n- 测试用例2（较差投影的比较）：试探集 $\\mathrm{B}$，其中 $|g_1\\rangle = \\frac{1}{\\sqrt{2}}(|s\\rangle + i\\,|p\\rangle)$ 和 $|g_2\\rangle = \\frac{1}{\\sqrt{2}}(|s\\rangle - i\\,|p\\rangle)$，使用 $N_k = 201$ 的均匀网格，截断半径 $R_{\\max} = 1$。\n- 测试用例3（边界截断）：试探集 $\\mathrm{A}$，使用 $N_k = 201$，截断半径 $R_{\\max} = 0$。\n\n你的程序必须：\n- 构建 $H(k)$，在指定的网格上对其进行对角化，为每个测试用例通过 Löwdin 正交归一化形成投影矩阵和 $U(k)$，计算展宽 $\\Omega$，形成 $H_W(k)$，计算 $h(R)$，用指定的 $R_{\\max}$ 重建 $H_{\\mathrm{interp}}(k)$，并计算 $\\Delta_{\\mathrm{MAE}}$。\n- 生成一行输出，包含一个用方括号括起来的逗号分隔列表，其中每个测试用例贡献一个包含两个浮点数 $[\\Omega,\\Delta_{\\mathrm{MAE}}]$ 的列表，四舍五入到六位小数。最终格式必须为\n$$\n\\text{[[$\\Omega_1$,$\\Delta_{\\mathrm{MAE},1}$],[$\\Omega_2$,$\\Delta_{\\mathrm{MAE},2}$],[$\\Omega_3$,$\\Delta_{\\mathrm{MAE},3}$]]}.\n$$\n所有角度均以弧度为单位，报告的 $\\Omega$ 是无量纲的（单位为 $a^2$），$\\Delta_{\\mathrm{MAE}}$ 的能量单位与紧束缚参数匹配。", "solution": "问题陈述经评估有效。它在科学上基于凝聚态物理和计算材料科学的原理，特别是紧束缚理论和瓦尼尔函数的构建。该问题是适定的，提供了一套完整而明确的定义、参数和计算步骤，以达到唯一的数值解。语言客观而精确。因此，我们着手求解。\n\n问题的核心是实现一个数值计算流程，模拟构建最大局域化瓦尼尔函数 (MLWF) 的初始步骤，并根据局域性（展宽）和哈密顿量插值精度的定量指标，评估不同初始投影的质量。\n\n一维紧束缚哈密顿量表示为第一布里渊区 $[-\\pi, \\pi)$ 中每个晶体动量 $k$ 的一个 $2 \\times 2$ 矩阵：\n$$\nH(k) =\n\\begin{pmatrix}\n\\varepsilon_s + 2 t_s \\cos(k a)  & 2 t_{sp} \\, i \\sin(k a) \\\\\n- 2 t_{sp} \\, i \\sin(k a)  & \\varepsilon_p + 2 t_p \\cos(k a)\n\\end{pmatrix}\n$$\n提供的参数为 $\\varepsilon_s = 0$, $\\varepsilon_p = 1.5$, $t_s = -1.0$, $t_p = -0.2$, $t_{sp} = 0.4$，晶格常数归一化为 $a=1$。计算在覆盖布里渊区的 $N_k$ 个点的均匀离散网格 $\\{k_j\\}_{j=0}^{N_k-1}$ 上进行。\n\n对于三个指定的测试用例中的每一个，执行以下计算过程：\n\n1.  **布洛赫本征态计算**：对于网格上的每个 $k_j$，构建厄米哈密顿矩阵 $H(k_j)$ 并进行数值对角化。这将产生两个实数本征值 $E_n(k_j)$（按升序排列，$n=1, 2$），以及一组对应的正交归一的本征矢量 $|\\psi_{k_j,n}\\rangle$。对于给定的 $k_j$，其本征矢量构成了 $2 \\times 2$ 幺正矩阵 $V(k_j)$ 的列。\n\n2.  **投影与正交归一化**：选择一组两个试探轨道 $\\{|g_m\\rangle\\}_{m=1}^2$。它们在原子轨道基 $\\{|s\\rangle, |p\\rangle\\}$ 中表示为列向量。布洛赫本征态在这些试探轨道上的投影由矩阵 $A(k_j)$ 捕获，其矩阵元为 $A_{nm}(k_j) = \\langle \\psi_{k_j,n} | g_m \\rangle$。如果 $G$ 是以向量 $|g_m\\rangle$ 为列的矩阵，那么 $A(k_j) = V(k_j)^\\dagger G$。\n    为了在整个布里渊区获得一个光滑的幺正规范，该投影矩阵需经过 Löwdin 正交归一化，得到依赖于 $k$ 的幺正规范混合矩阵：\n    $$\n    U(k_j) = A(k_j) \\left[A(k_j)^\\dagger A(k_j)\\right]^{-1/2}\n    $$\n    矩阵逆平方根 $[ \\cdot ]^{-1/2}$ 是对 $2 \\times 2$ 正定厄米矩阵 $A^\\dagger A$ 使用标准数值线性代数程序计算的。\n\n3.  **展宽计算 ($\\Omega$)**：瓦尼尔规范下的胞周期布洛赫函数为 $|u_{k_j}^{(m)}\\rangle = \\sum_{n=1}^2 |\\psi_{k_j,n}\\rangle U_{nm}(k_j)$。为了评估此规范的光滑性，我们计算最近邻交叠矩阵 $M(k_j) = \\langle u_{k_j}^{(m)} | u_{k_j+\\Delta k}^{(n)} \\rangle$。然后，通过对网格中所有 $k_j$ 上的这些交叠矩阵元素的特定组合求和，来计算总展宽泛函 $\\Omega$：\n    $$\n    \\Omega = \\sum_{j=0}^{N_k-1} \\left[ \\sum_{n=1}^{2} \\left( 1 - |M_{nn}(k_j)|^2 \\right) + \\sum_{\\substack{m,n=1 \\\\ m\\neq n}}^{2} |M_{mn}(k_j)|^2 \\right]\n    $$\n    较小的 $\\Omega$ 值表示更光滑的规范，这对应于实空间中更局域化的瓦尼尔函数。\n\n4.  **插值误差计算 ($\\Delta_{\\mathrm{MAE}}$)**：评估瓦尼尔表象用于插值哈密顿量的质量。首先，在每个 $k_j$ 处将哈密顿量变换到瓦尼尔规范：\n    $$\n    H_W(k_j) = U(k_j)^\\dagger \\, \\mathrm{diag}(E_1(k_j), E_2(k_j)) \\, U(k_j)\n    $$\n    接着，通过在布里渊区上的离散傅里叶逆变换计算实空间跃迁矩阵 $h(R)$：\n    $$\n    h(R) = \\frac{1}{N_k} \\sum_{j=0}^{N_k-1} H_W(k_j) e^{-i k_j R}\n    $$\n    其中 $R$ 是一个整数格点指标。此变换在指定的半径 $R_{\\max}$ 处被截断。然后，使用截断后的跃迁项集合在每个 $k_j$ 处重建（插值）哈密顿量：\n    $$\n    H_{\\mathrm{interp}}(k_j) = \\sum_{R=-R_{\\max}}^{R_{\\max}} h(R) e^{i k_j R}\n    $$\n    最后，能带插值误差 $\\Delta_{\\mathrm{MAE}}$ 计算为原始哈密顿量的本征值 $E_n(k_j)$ 与插值哈密顿量的本征值 $\\widetilde{E}_n(k_j)$ 之间的平均绝对误差：\n    $$\n    \\Delta_{\\mathrm{MAE}} = \\frac{1}{2 N_k} \\sum_{j=0}^{N_k-1} \\sum_{n=1}^{2} \\left| E_n(k_j) - \\widetilde{E}_n(k_j) \\right|\n    $$\n\n三个测试用例如下评估：\n-   **测试用例 1**：试探轨道是原子基函数，$|g_1\\rangle=|s\\rangle$ 和 $|g_2\\rangle=|p\\rangle$。这里，$G$ 是单位矩阵。截断半径为 $R_{\\max} = 1$。这代表了一个标准的“良好”选择。\n-   **测试用例 2**：试探轨道是原子基函数的混合， $|g_1\\rangle = \\frac{1}{\\sqrt{2}}(|s\\rangle + i|p\\rangle)$ 和 $|g_2\\rangle = \\frac{1}{\\sqrt{2}}(|s\\rangle - i|p\\rangle)$。此用例测试了程序对初始投影的敏感性。$R_{\\max} = 1$。\n-   **测试用例 3**：试探轨道与用例1相同，但采用严格的截断半径 $R_{\\max} = 0$，意味着只保留实空间哈密顿量的在位部分进行插值。\n\n提供的 Python 代码实现了这整个流程，为这三种情况中的每一种计算指标对 $[\\Omega, \\Delta_{\\mathrm{MAE}}]$。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import sqrtm, inv, eigh\n\ndef solve():\n    \"\"\"\n    Main function to run the Wannier function analysis for all test cases.\n    \"\"\"\n\n    def solve_case(trial_G, N_k, R_max):\n        \"\"\"\n        Implements the full pipeline for a single test case.\n\n        Args:\n            trial_G (np.ndarray): 2x2 matrix with trial orbitals as columns.\n            N_k (int): Number of k-points in the mesh.\n            R_max (int): Truncation radius for real-space hopping.\n\n        Returns:\n            list: A list containing [Omega, Delta_MAE].\n        \"\"\"\n        # Define constants from the problem statement\n        eps_s = 0.0\n        eps_p = 1.5\n        t_s = -1.0\n        t_p = -0.2\n        t_sp = 0.4\n        a = 1.0\n\n        # 1. Setup k-mesh\n        k_mesh = np.linspace(-np.pi, np.pi, N_k, endpoint=False)\n        \n        # Lists to store k-dependent quantities\n        E_k_list = []\n        V_k_list = []\n        U_k_list = []\n\n        # 2. Loop over k to diagonalize H(k) and compute U(k)\n        for k in k_mesh:\n            H_k = np.array([\n                [eps_s + 2 * t_s * np.cos(k * a), 2 * t_sp * 1j * np.sin(k * a)],\n                [-2 * t_sp * 1j * np.sin(k * a), eps_p + 2 * t_p * np.cos(k * a)]\n            ], dtype=np.complex128)\n            E, V = eigh(H_k)\n            E_k_list.append(E)\n            V_k_list.append(V)\n            \n            A_k = V.conj().T @ trial_G\n            A_dagger_A = A_k.conj().T @ A_k\n            A_dagger_A_inv_sqrt = inv(sqrtm(A_dagger_A))\n            U_k = A_k @ A_dagger_A_inv_sqrt\n            U_k_list.append(U_k)\n\n        # 3. Compute spread Omega\n        omega_sum = 0.0\n        for i in range(N_k):\n            u_k = V_k_list[i] @ U_k_list[i]\n            i_plus_1 = (i + 1) % N_k\n            u_k_plus_dk = V_k_list[i_plus_1] @ U_k_list[i_plus_1]\n            M_k = u_k.conj().T @ u_k_plus_dk\n            \n            omega_sum += (1 - np.abs(M_k[0, 0])**2) + (1 - np.abs(M_k[1, 1])**2)\n            omega_sum += np.abs(M_k[0, 1])**2 + np.abs(M_k[1, 0])**2\n\n        # 4. Compute interpolation error Delta_MAE\n        H_W_k_list = []\n        for i in range(N_k):\n            E_diag = np.diag(E_k_list[i])\n            U_k = U_k_list[i]\n            H_W_k = U_k.conj().T @ E_diag @ U_k\n            H_W_k_list.append(H_W_k)\n        H_W_k_array = np.array(H_W_k_list)\n\n        h_R = np.fft.ifft(np.fft.ifftshift(H_W_k_array, axes=0), axis=0) * N_k\n        \n        H_interp_k_list = np.zeros_like(H_W_k_array)\n        R_grid = np.fft.ifftshift(np.arange(-N_k // 2, (N_k + 1) // 2))\n\n        for r_idx, R in enumerate(R_grid):\n            if abs(R) = R_max:\n                phase = np.exp(1j * k_mesh * R).reshape(N_k, 1, 1)\n                H_interp_k_list += h_R[r_idx] * phase\n        \n        total_abs_error = 0.0\n        for i in range(N_k):\n            E_interp = np.sort(np.linalg.eigvalsh(H_interp_k_list[i]))\n            total_abs_error += np.sum(np.abs(E_k_list[i] - E_interp))\n        \n        Delta_MAE = total_abs_error / (2 * N_k)\n        \n        return [omega_sum, Delta_MAE]\n\n    # Run all test cases\n    N_k = 201\n    \n    # Case 1\n    G1 = np.eye(2, dtype=np.complex128)\n    res1 = solve_case(G1, N_k=N_k, R_max=1)\n    \n    # Case 2\n    G2 = np.array([[1, 1], [1j, -1j]], dtype=np.complex128) / np.sqrt(2)\n    res2 = solve_case(G2, N_k=N_k, R_max=1)\n    \n    # Case 3\n    res3 = solve_case(G1, N_k=N_k, R_max=0)\n    \n    # Format and print the final output\n    print(f\"[[{res1[0]:.6f},{res1[1]:.6f}],[{res2[0]:.6f},{res2[1]:.6f}],[{res3[0]:.6f},{res3[1]:.6f}]]\")\n\nsolve()\n```", "id": "3502323"}, {"introduction": "真实的材料，特别是金属，常常呈现出能带纠缠等复杂情况，这是简单的投影方案无法处理的。这个高级实践将介绍至关重要的“解纠缠”概念，即从一个较大的能量窗口中优化地“切割”出目标子空间。您将实现一个自适应算法来稳定该过程并量化其稳定性，从而深入了解将瓦尼尔函数应用于金属体系的一项关键技术 ([@problem_id:3502336])。", "problem": "给定一个计算任务，您需要通过监测从两组不同的初始局域投影获得的子空间之间的“溢出”，来量化和控制一个金属紧束缚模型的子空间解纠缠的稳定性，并在检测到不稳定性时，实现一个自适应准则来优化内能量窗。推导和算法必须从以下基本依据出发：到子空间的正交投影算符的定义、由量子力学保证的布洛赫本征态的正交归一性，以及子空间之间距离的标准线性代数表征。\n\n考虑一个每个原胞有 $2$ 个轨道的一维紧束缚模型。对于布里渊区（BZ）中的晶体动量 $k$，哈密顿量是一个 $2 \\times 2$ 的厄米矩阵\n$$\nH(k) \\equiv\n\\begin{pmatrix}\n\\varepsilon_{a} + 2 t_{a} \\cos k   V_{0} + 2 t_{ab} \\cos k \\\\\nV_{0} + 2 t_{ab} \\cos k   \\varepsilon_{b} + 2 t_{b} \\cos k\n\\end{pmatrix},\n$$\n其固定参数为 $\\varepsilon_{a} = -0.3$，$t_{a} = 1.0$，$\\varepsilon_{b} = 0.2$，$t_{b} = -0.7$，$V_{0} = 0.6$，$t_{ab} = 0.2$，所有参数均采用无量纲的紧束缚单位。设费米能级 $E_{\\mathrm{F}} = 0.0$。布里渊区在 $N_{k} = 51$ 个点的均匀网格上进行采样，$k_{j}$ 在 $[-\\pi,\\pi]$ 上等距分布，角度以弧度为单位。\n\n在每个 $k_{j}$ 处，令 $\\{ \\lvert \\psi_{n}(k_{j}) \\rangle \\}_{n=1}^{2}$ 表示 $H(k_{j})$ 的正交归一的本征矢量，其对应的本征值为 $\\{ E_{n}(k_{j}) \\}_{n=1}^{2}$。对于一个预设的内能量窗半宽度 $w  0$，通过选择所有满足 $\\lvert E_{n}(k_{j}) - E_{\\mathrm{F}} \\rvert \\le w$ 的能带指标 $n$ 来定义在 $k_{j}$ 处的初始内窗能带指标集。如果该集合为空，则选择使 $\\lvert E_{n}(k_{j}) - E_{\\mathrm{F}} \\rvert$ 最小的单个指标 $n$。将每个原胞的目标 Wannier 函数数量固定为 $M = 1$。\n\n给出两个不同的初始局域投影，形式为轨道基矢下的列向量（长度为 $2$）：第一个是 $g_{1} = (1, 0)^{\\top}$；第二个是 $g_{2}(\\alpha) = (\\cos \\alpha, \\sin \\alpha)^{\\top}$，其中 $\\alpha$ 是一个指定的角度，单位为弧度。对于每个 $k_{j}$ 和每个初始投影 $g_{i}$，在内窗所选本征态张成的空间内，通过最大化与 $g_{i}$ 的张成空间的重叠，在正交归一性的约束下，构造解纠缠的 $M$ 维子空间。此过程仅使用布洛赫本征矢量的正交归一性、正交投影算符的性质以及成熟的线性代数理论。将得到的在 $k_{j}$ 处的解纠缠子空间上的正交投影算符记为 $P_{i}(k_{j})$，其中 $i \\in \\{1,2\\}$。\n\n将在 $k_{j}$ 处两个解纠缠子空间之间的归一化的子空间溢出定义为一个在 $[0,1]$ 区间内的标量，它当且仅当两个子空间重合时为零，并随它们的不匹配程度而增加。该溢出使用正交投影算符和子空间之间的主夹角从第一性原理出发构建。k 点平均溢出是在 $N_{k}$ 个点上的算术平均值。\n\n自适应优化准则：给定一个溢出容差 $\\tau  0$ 和一个非负整数的添加次数上限 $c$，监测每个 $k_{j}$ 处的溢出。如果 $k_{j}$ 处的溢出超过 $\\tau$，则自适应地扩大在 $k_{j}$ 处的内能量窗，方法是添加能量上最接近的、被排除在外的能带指标（即，当前不在内窗中且其 $\\lvert E_{n}(k_{j}) - E_{\\mathrm{F}} \\rvert$ 最小的能带指标），从而增加在该 $k_{j}$ 处可用于子空间选择的能带集合。每次添加后，重新计算解纠缠子空间和在 $k_{j}$ 处的溢出。重复此过程，直到 $k_{j}$ 处的溢出低于 $\\tau$，或者在 $k_{j}$ 处的添加次数达到 $c$，或者所有能带都已被包含。\n\n您的程序必须纯数值地为指定的模型和测试套件实现以下步骤，不使用任何外部数据：\n\n-   使用给定参数在每个 $k_{j}$ 处构建 $H(k)$，并对其进行对角化以获得 $E_{n}(k_{j})$ 和 $\\lvert \\psi_{n}(k_{j}) \\rangle$。\n-   对于每个测试用例，在每个 $k_{j}$ 处，按照规定构建内窗集合，并使用正交投影和重叠最大化的第一性原理，从两个初始投影为 $M = 1$ 构建解纠缠的投影算符 $P_{1}(k_{j})$ 和 $P_{2}(k_{j})$。\n-   计算每个 $k_{j}$ 处的归一化溢出及其在布里渊区上的平均值。\n-   在每个 $k_{j}$ 处独立应用具有给定容差和上限的自适应优化准则，并报告优化后最终的 k 点平均溢出。\n\n使用的测试套件和参数：\n\n-   通用模型参数：$\\varepsilon_{a} = -0.3$, $t_{a} = 1.0$, $\\varepsilon_{b} = 0.2$, $t_{b} = -0.7$, $V_{0} = 0.6$, $t_{ab} = 0.2$, $E_{\\mathrm{F}} = 0.0$, $N_{k} = 51$。\n-   目标子空间维度：$M = 1$。\n-   初始投影 $g_{1} = (1, 0)^{\\top}$ 和 $g_{2}(\\alpha) = (\\cos \\alpha, \\sin \\alpha)^{\\top}$。\n\n提供四个测试用例，每个用例由一个元组 $(\\alpha, w, \\tau, c)$ 定义：\n-   用例 1：$\\alpha = 0.2$，$w = 1.5$，$\\tau = 0.01$，$c = 0$。\n-   用例 2：$\\alpha = 1.5707963267948966$，$w = 0.2$，$\\tau = 0.2$，$c = 1$。\n-   用例 3：$\\alpha = 1.3$，$w = 0.05$，$\\tau = 0.05$，$c = 0$。\n-   用例 4：$\\alpha = 0.4$，$w = 0.6$，$\\tau = 0.00001$，$c = 2$。\n\n您的程序应生成单行输出，其中包含每个测试用例在自适应优化完成后的最终 k 点平均溢出，形式为用方括号括起来的逗号分隔列表。每个值必须四舍五入到小数点后六位。例如，一个包含三个假设结果的输出必须看起来像 $[\\text{r}_{1},\\text{r}_{2},\\text{r}_{3}]$，其中每个 $\\text{r}_{i}$ 显示小数点后六位数字。所有角度必须以弧度为单位，所有量均为无量纲。", "solution": "该问题经验证具有科学依据、良定且客观。所有参数和过程都已足够明确，可以构建一个唯一、稳定且有意义的数值解。所涉及的物理和数学概念——紧束缚哈密顿量、布洛赫定理、子空间投影和主夹角——在计算固态物理学中都是标准的。我们着手求解。\n\n核心任务是实现一个用于子空间解纠缠的数值程序，并量化其相对于初始投影选择的稳定性。该方法遵循为构建最大局域 Wannier 函数所建立的原则，此处特化为目标子空间维度 M=1 的情况。\n\n首先，我们建立物理模型及其性质。该系统是一个每个格点有 $2$ 个轨道的一维紧束缚模型。依赖于晶体动量的哈密顿量 $H(k)$ 是一个 $2 \\times 2$ 的厄米矩阵，定义如下：\n$$\nH(k) =\n\\begin{pmatrix}\n\\varepsilon_{a} + 2 t_{a} \\cos k   V_{0} + 2 t_{ab} \\cos k \\\\\nV_{0} + 2 t_{ab} \\cos k   \\varepsilon_{b} + 2 t_{b} \\cos k\n\\end{pmatrix}\n$$\n给定参数为 $\\varepsilon_{a} = -0.3$，$t_{a} = 1.0$，$\\varepsilon_{b} = 0.2$，$t_{b} = -0.7$，$V_{0} = 0.6$ 和 $t_{ab} = 0.2$。该问题在一个离散的网格上求解，该网格由在第一布里渊区 $[-\\pi, \\pi]$ 中均匀分布的 $N_{k} = 51$ 个晶体动量点 $k_{j}$ 组成。对于每个 $k_j$，我们求解不含时薛定谔方程 $H(k_j) |\\psi_n(k_j)\\rangle = E_n(k_j) |\\psi_n(k_j)\\rangle$。对 $n \\in \\{1, 2\\}$，这个本征值问题被数值求解，得到能带能量 $E_n(k_j)$ 和相应的正交归一的布洛赫本征矢量 $|\\psi_n(k_j)\\rangle$。这些本征矢量构成了每个 $k_j$ 处希尔伯特空间的基。\n\n其次，我们定义目标子空间。金属的 Wannier 化过程需要从一个“内”能量窗内更大的一组能带中解纠缠出目标数量 $M$ 的能带。对于给定的半宽度 $w  0$ 和费米能级 $E_{\\mathrm{F}} = 0.0$，在 $k_j$ 处的内窗能带指标集，记为 $\\mathcal{I}_{\\text{in}}(k_j)$，包含所有满足 $|E_n(k_j) - E_{\\mathrm{F}}| \\le w$ 的指标 $n$。如果此集合为空，则定义它包含使 $|E_n(k_j) - E_{\\mathrm{F}}|$ 最小的单个能带指标。由与该指标集对应的布洛赫态张成的子空间即为“内窗子空间”，$\\mathcal{W}_{\\text{in}}(k_j) = \\text{span}\\{|\\psi_n(k_j)\\rangle\\}_{n \\in \\mathcal{I}_{\\text{in}}(k_j)}$。到该子空间上的正交投影算符为 $P_{\\text{in}}(k_j) = \\sum_{n \\in \\mathcal{I}_{\\text{in}}(k_j)} |\\psi_n(k_j)\\rangle \\langle\\psi_n(k_j)|$。\n\n第三，我们执行解纠缠。目标是在 $\\mathcal{W}_{\\text{in}}(k_j)$ 中识别一个最优的 $M$ 维子空间，该子空间在整个布里渊区上尽可能“光滑”。光滑性通过最大化与一组固定的试探局域轨道的重叠来促成。此处，目标维度是 $M=1$，我们考虑两个初始试探轨道（投影）$g_1 = (1, 0)^{\\top}$ 和 $g_2(\\alpha) = (\\cos \\alpha, \\sin \\alpha)^{\\top}$。对于每个试探轨道 $g_i$，我们寻求一个归一化的态 $|\\phi_i(k_j)\\rangle \\in \\mathcal{W}_{\\text{in}}(k_j)$，它使重叠的平方 $|\\langle g_i | \\phi_i(k_j) \\rangle|^2$ 最大化。由于 $|\\phi_i(k_j)\\rangle$ 位于 $\\mathcal{W}_{\\text{in}}(k_j)$ 中，它可以写作 $|\\phi_i(k_j)\\rangle = P_{\\text{in}}(k_j) |\\phi_i(k_j)\\rangle$。根据正交投影算符的性质，在 $\\mathcal{W}_{\\text{in}}(k_j)$ 空间中，与 $g_i$ 投影最大的矢量与 $g_i$ 自身在 $\\mathcal{W}_{\\text{in}}(k_j)$ 空间上的投影共线。因此，最优态通过将 $g_i$ 投影到内窗子空间上并对结果进行归一化得到：\n$$\n|\\phi_i(k_j)\\rangle = \\frac{P_{\\text{in}}(k_j) |g_i\\rangle}{\\| P_{\\text{in}}(k_j) |g_i\\rangle \\|}\n$$\n这个态 $|\\phi_i(k_j)\\rangle$ 张成了试探轨道 $g_i$ 的解纠缠一维子空间。到这个最终子空间上的正交投影算符是 $P_i(k_j) = |\\phi_i(k_j)\\rangle\\langle\\phi_i(k_j)|$。\n\n第四，我们量化从 $g_1$ 和 $g_2(\\alpha)$ 得到的两个子空间之间的差异。“溢出”是这两个分别由 $|\\phi_1(k_j)\\rangle$ 和 $|\\phi_2(k_j)\\rangle$ 张成的一维子空间之间距离的度量。这个距离使用子空间之间的主夹角 $\\theta$ 来定义，其中 $\\cos^2\\theta = |\\langle \\phi_1(k_j) | \\phi_2(k_j) \\rangle|^2$。一个与问题要求一致的归一化溢出度量是：\n$$\nS(k_j) = \\sin^2\\theta = 1 - |\\langle \\phi_1(k_j) | \\phi_2(k_j) \\rangle|^2\n$$\n该值在 $[0, 1]$ 区间内，如果子空间相同则为 $0$，如果正交则为 $1$。\n\n最后，我们实现自适应优化过程。对于每个 $k_j$，如果计算出的溢出 $S(k_j)$ 超过容差 $\\tau$，则内窗子空间 $\\mathcal{W}_{\\text{in}}(k_j)$ 被扩大。这是通过添加能量上最接近的、尚未在 $\\mathcal{I}_{\\text{in}}(k_j)$ 中的能带实现的。然后用新的、更大的内窗重复解纠缠和溢出计算。此过程迭代进行，直到 $S(k_j) \\le \\tau$，或达到添加能带次数的上限 $c$，或所有可用能带都已包含在窗内。每个 $k_j$ 的最终溢出是此循环终止时获得的值。整体的评价指标是 k 点平均溢出 $\\bar{S} = \\frac{1}{N_k} \\sum_{j=1}^{N_k} S(k_j)$。\n\n对于每个测试用例 $(\\alpha, w, \\tau, c)$，算法按以下步骤进行：\n1. 遍历布里渊区网格中的每个 $k_j$。\n2. 构建并对角化 $H(k_j)$ 以获得本征值 $E_n(k_j)$ 和本征矢量 $|\\psi_n(k_j)\\rangle$。\n3. 基于 $w$ 确定初始内窗指标集 $\\mathcal{I}_{\\text{in}}(k_j)$。\n4. 进入一个自适应循环：\n    a. 从当前指标集构建内窗本征矢量的矩阵 $U_{\\text{in}}$。\n    b. 计算解纠缠矢量 $|\\phi_1(k_j)\\rangle$ 和 $|\\phi_2(k_j)\\rangle$。\n    c. 计算溢出 $S(k_j)$。\n    d. 如果 $S(k_j) \\le \\tau$，或达到添加上限 $c$，或所有能带都已包含，则退出循环。\n    e. 否则，将下一个可用能带添加到指标集并继续循环。\n5. 存储当前 $k_j$ 的最终 $S(k_j)$。\n6. 遍历所有 $k_j$ 后，计算平均溢出。对所有测试用例重复此过程。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test suite.\n    It orchestrates the calculation for each case and prints the final result.\n    \"\"\"\n    test_cases = [\n        # (alpha, w, tau, c)\n        (0.2, 1.5, 0.01, 0),\n        (1.5707963267948966, 0.2, 0.2, 1),\n        (1.3, 0.05, 0.05, 0),\n        (0.4, 0.6, 0.00001, 2),\n    ]\n\n    results = []\n    for case in test_cases:\n        alpha, w, tau, c = case\n        avg_spillage = calculate_refined_spillage(alpha, w, tau, c)\n        results.append(avg_spillage)\n\n    results_str = [f\"{r:.6f}\" for r in results]\n    print(f\"[{','.join(results_str)}]\")\n\ndef calculate_refined_spillage(alpha, w, tau, c):\n    \"\"\"\n    Calculates the k-averaged spillage for a single test case,\n    including the adaptive refinement procedure.\n\n    Args:\n        alpha (float): Angle for the second initial projector g2.\n        w (float): Half-width of the inner energy window.\n        tau (float): Spillage tolerance for adaptive refinement.\n        c (int): Maximum number of band additions per k-point.\n\n    Returns:\n        float: The final k-averaged spillage after refinement.\n    \"\"\"\n    # Fixed model and simulation parameters\n    eps_a, t_a = -0.3, 1.0\n    eps_b, t_b = 0.2, -0.7\n    V0, t_ab = 0.6, 0.2\n    E_F = 0.0\n    N_k = 51\n    NUM_BANDS = 2\n\n    k_grid = np.linspace(-np.pi, np.pi, N_k, dtype=np.float64)\n    g1 = np.array([1.0, 0.0], dtype=np.complex128).reshape(NUM_BANDS, 1)\n    g2 = np.array([np.cos(alpha), np.sin(alpha)], dtype=np.complex128).reshape(NUM_BANDS, 1)\n\n    total_spillage = 0.0\n\n    for k in k_grid:\n        cos_k = np.cos(k)\n        H = np.array([\n            [eps_a + 2 * t_a * cos_k, V0 + 2 * t_ab * cos_k],\n            [V0 + 2 * t_ab * cos_k, eps_b + 2 * t_b * cos_k]\n        ], dtype=np.complex128)\n\n        eigvals, eigvecs = np.linalg.eigh(H)\n\n        abs_energy_diffs = np.abs(eigvals - E_F)\n        initial_indices_mask = abs_energy_diffs = w\n        initial_indices = np.where(initial_indices_mask)[0]\n\n        if initial_indices.size == 0:\n            initial_indices = np.array([np.argmin(abs_energy_diffs)])\n\n        current_indices = set(initial_indices)\n        num_additions = 0\n        final_k_spillage = 0.0\n\n        while True:\n            U_in = eigvecs[:, sorted(list(current_indices))]\n            \n            proj_g1 = U_in.T.conj() @ g1\n            norm_proj_g1 = np.linalg.norm(proj_g1)\n            phi1 = U_in @ proj_g1 / norm_proj_g1 if norm_proj_g1 > 1e-15 else U_in[:, [0]]\n\n            proj_g2 = U_in.T.conj() @ g2\n            norm_proj_g2 = np.linalg.norm(proj_g2)\n            phi2 = U_in @ proj_g2 / norm_proj_g2 if norm_proj_g2 > 1e-15 else U_in[:, [0]]\n\n            inner_product_sq = np.abs((phi1.conj().T @ phi2)[0, 0])**2\n            final_k_spillage = 1.0 - inner_product_sq\n\n            if final_k_spillage = tau or num_additions >= c or len(current_indices) == NUM_BANDS:\n                break\n            \n            available_indices = set(range(NUM_BANDS)) - current_indices\n            if not available_indices:\n                break\n            \n            closest_band_idx = min(available_indices, key=lambda idx: abs_energy_diffs[idx])\n            current_indices.add(closest_band_idx)\n            num_additions += 1\n            \n        total_spillage += final_k_spillage\n        \n    return total_spillage / N_k\n\nsolve()\n```", "id": "3502336"}]}