{"hands_on_practices": [{"introduction": "理解Tomasulo算法的最佳方式之一是逐周期地追踪指令流。本练习是一个基础性的推演，旨在展示该算法的核心优势：一旦指令的操作数就绪，便立即执行，即使这会打乱程序原有的顺序。通过分析一组精心设计的独立和相关指令，你将亲眼见证动态调度如何通过乱序执行来隐藏延迟并提升性能。[@problem_id:3685502]", "problem": "考虑一个具有以下特性和定义的Tomasulo风格动态调度流水线。Tomasulo算法使用保留站（RS）进行寄存器重命名，以消除读后写（WAR）和写后写（WAW）冒险，一旦所有操作数都可用，就在功能单元（FU）中开始执行，并通过单个公共数据总线（CDB）广播产生的结果，以唤醒相关的RS条目。该系统没有重排序缓冲（ROB）；寄存器文件在CDB广播后立即更新。一个RS条目捕获操作数值或将在CDB上匹配的标签，并且只有当两个操作数都可用且相应的功能单元空闲时才开始执行。在该系统中：\n- 发射率为每周期一条指令，从周期$1$开始。\n- 加法使用两个相同的加法功能单元（FU），延迟为$L_{\\text{add}} = 2$个周期。\n- 乘法使用一个乘法功能单元（FU），延迟为$L_{\\text{mul}} = 5$个周期。\n- 加法保留站：$3$个条目；乘法保留站：$2$个条目。\n- 如果两个操作数都可用且FU空闲，则执行在发射后的下一个周期立即开始；否则，执行在两个操作数都变得可用且FU空闲后的下一个周期立即开始。\n- 一个由FU产生的结果在最后一个执行周期结束后的下一个周期在CDB上广播。如果多个结果在同一周期争用CDB，索引较低的RS条目获胜，另一个结果被精确延迟一个周期。\n- 源操作数$R_5$、$R_6$、$R_8$和$R_9$在周期$1$可用。操作数$R_3$在周期$1$可用。由于之前的长延迟加载，操作数$R_2$在发射时不可用，并将在周期$6$时通过CDB变得可用。\n\n给定以下指令序列（按程序顺序），其中三个加法相互独立，两个乘法在加法上形成依赖链：\n1. $I_1$: $R_1 \\leftarrow R_2 + R_3$\n2. $I_2$: $R_4 \\leftarrow R_5 + R_6$\n3. $I_3$: $R_7 \\leftarrow R_8 + R_9$\n4. $I_4$: $R_{10} \\leftarrow R_1 \\times R_4$\n5. $I_5$: $R_{11} \\leftarrow R_{10} \\times R_7$\n\n假设RS索引在每个RS文件中按程序顺序分配（即，第一个加法指令获得$\\text{A1}$，下一个加法指令获得$\\text{A2}$，依此类推；第一个乘法指令获得$\\text{M1}$，下一个乘法指令获得$\\text{M2}$），并且在出现冲突时，RS索引决定CDB的仲裁优先级。除了在周期$6$时$R_2$的延迟可用性外，没有其他缓存未命中，也没有超出上述FU数量的结构性冒险。\n\n任务：\n- 使用上述操作定义，确定每条指令$I_k$（$k \\in \\{1,2,3,4,5\\}$）的精确CDB写回周期。\n- 根据这些写回时间，确定在这个没有重排序缓冲的Tomasulo系统中，目的寄存器提交到寄存器文件的最终顺序。\n\n将最终提交顺序以LaTeX格式表示为目的寄存器标识符的单行矩阵。无需四舍五入。", "solution": "该问题为一个基于Tomasulo的动态调度处理器提供了详细的规范，并要求确定五条特定指令的写回周期以及它们的目的寄存器的最终提交顺序。此分析需要对指令流经流水线各阶段（发射、执行和写回）进行逐周期模拟。\n\n首先，我们为每条指令建立从发射到在公共数据总线（CDB）上写回的时间线。处理器从周期$1$开始，每个周期发射一条指令。\n\n指令 $I_1: R_1 \\leftarrow R_2 + R_3$\n- **发射：** $I_1$在周期$1$发射。它被分配到第一个可用的加法保留站$\\text{A1}$。\n- **操作数可用性：** $R_3$的值在周期$1$可用。$R_2$的值被指定在周期$6$时通过CDB变得可用。因此，$I_1$的两个操作数在周期$6$结束时准备就绪。\n- **执行：** 根据规则，执行在操作数准备就绪且功能单元（FU）空闲的下一个周期立即开始。在周期$6$结束时，两个加法FU都是空闲的。因此，$I_1$在周期$7$开始执行。加法延迟为$L_{\\text{add}} = 2$个周期。执行发生在周期$7$和$8$期间，在周期$8$结束时完成。\n- **写回（CDB）：** 结果在最后一个执行周期结束后的下一个周期在CDB上广播。这发生在周期$8+1 = 9$。\n- **$I_1$的CDB写回周期：$9$。**\n\n指令 $I_2: R_4 \\leftarrow R_5 + R_6$\n- **发射：** $I_2$在周期$2$发射。它被分配到保留站$\\text{A2}$。\n- **操作数可用性：** $R_5$和$R_6$的值在周期$1$可用，因此它们在发射时就已准备就绪。\n- **执行：** 两个操作数都已准备就绪，并且在周期$2$结束时有一个加法FU是空闲的。执行在周期$2+1 = 3$开始。它使用两个加法FU中的一个。延迟为$L_{\\text{add}} = 2$个周期，执行发生在周期$3$和$4$期间，在周期$4$结束时完成。\n- **写回（CDB）：** 结果在周期$4+1 = 5$时在CDB上广播。\n- **$I_2$的CDB写回周期：$5$。**\n\n指令 $I_3: R_7 \\leftarrow R_8 + R_9$\n- **发射：** $I_3$在周期$3$发射。它被分配到保留站$\\text{A3}$。\n- **操作数可用性：** $R_8$和$R_9$的值在周期$1$可用，因此它们在发射时就已准备就绪。\n- **执行：** 两个操作数在周期$3$结束时都已准备就绪。在周期$4$开始时，一个加法FU正忙于处理$I_2$。然而，第二个加法FU是空闲的。因此，$I_3$在周期$3+1 = 4$开始执行。延迟为$L_{\\text{add}} = 2$个周期，执行发生在周期$4$和$5$期间，在周期$5$结束时完成。\n- **写回（CDB）：** 结果准备在周期$5+1 = 6$时广播。然而，问题陈述指出$R_2$的值在周期$6$时通过CDB变得可用。这造成了CDB竞争。题目陈述为这个外部事件给出了一个固定的时间点，这意味着它具有优先权。关于竞争的规则规定，失败者将被“精确延迟一个周期”。因此，$I_3$在周期$6+1=7$将其结果写入CDB。\n- **$I_3$的CDB写回周期：$7$。**\n\n指令 $I_4: R_{10} \\leftarrow R_1 \\times R_4$\n- **发射：** $I_4$在周期$4$发射。它被分配到第一个乘法保留站$\\text{M1}$。\n- **操作数可用性：** $I_4$依赖于$I_1$（产生$R_1$）和$I_2$（产生$R_4$）的结果。保留站条目$\\text{M1}$将等待标签$\\text{A1}$和$\\text{A2}$。\n  - $I_2$的结果（标签$\\text{A2}$）在周期$5$时在CDB上广播。\n  - $I_1$的结果（标签$\\text{A1}$）在周期$9$时在CDB上广播。\n  $I_4$的两个操作数在周期$9$结束时都可用。\n- **执行：** 单个乘法FU是可用的。执行在周期$9+1 = 10$开始。乘法延迟为$L_{\\text{mul}} = 5$个周期。执行发生在周期$10, 11, 12, 13, 14$期间，在周期$14$结束时完成。\n- **写回（CDB）：** 结果在周期$14+1 = 15$时在CDB上广播。\n- **$I_4$的CDB写回周期：$15$。**\n\n指令 $I_5: R_{11} \\leftarrow R_{10} \\times R_7$\n- **发射：** $I_5$在周期$5$发射。它被分配到第二个乘法保留站$\\text{M2}$。\n- **操作数可用性：** $I_5$依赖于$I_4$（产生$R_{10}$）和$I_3$（产生$R_7$）的结果。保留站条目$\\text{M2}$将等待标签$\\text{M1}$和$\\text{A3}$。\n  - $I_3$的结果（标签$\\text{A3}$）在周期$7$时在CDB上广播。\n  - $I_4$的结果（标签$\\text{M1}$）在周期$15$时在CDB上广播。\n  $I_5$的两个操作数在周期$15$结束时都可用。\n- **执行：** 乘法FU被$I_4$使用直到周期$14$结束，在周期$15$时空闲。执行在周期$15+1 = 16$开始。延迟为$L_{\\text{mul}} = 5$个周期，执行发生在周期$16, 17, 18, 19, 20$期间，在周期$20$结束时完成。\n- **写回（CDB）：** 结果在周期$20+1 = 21$时在CDB上广播。\n- **$I_5$的CDB写回周期：$21$。**\n\nCDB写回周期总结：\n- $I_1$（写入$R_1$）：周期$9$\n- $I_2$（写入$R_4$）：周期$5$\n- $I_3$（写入$R_7$）：周期$7$\n- $I_4$（写入$R_{10}$）：周期$15$\n- $I_5$（写入$R_{11}$）：周期$21$\n\n题目指出，该系统没有重排序缓冲（ROB），寄存器文件在CDB广播后立即更新。这意味着目的寄存器的提交顺序由其CDB写回事件的时间顺序决定。\n\n按周期号对写回事件进行排序：\n1. 周期$5$：$I_2$写入$R_4$。\n2. 周期$7$：$I_3$写入$R_7$。\n3. 周期$9$：$I_1$写入$R_1$。\n4. 周期$15$：$I_4$写入$R_{10}$。\n5. 周期$21$：$I_5$写入$R_{11}$。\n\n因此，目的寄存器的最终提交顺序是$R_4$，然后是$R_7$，然后是$R_1$，接着是$R_{10}$，最后是$R_{11}$。该序列表示为寄存器标识符的行矩阵。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\nR_4  R_7  R_1  R_{10}  R_{11}\n\\end{pmatrix}\n}\n$$", "id": "3685502"}, {"introduction": "在上一个练习的基础上，本次实践将聚焦于Tomasulo处理器的实际限制。即使数据流调度是完美的，处理器性能仍会受限于有限的资源，例如功能单元（$FU$）和公共数据总线（$CDB$）。这个“广播风暴”场景是一个刻意设计的压力测试，旨在检验处理器如何处理突发的计算完成事件，以及对$CDB$和单一功能单元的争用如何最终将执行串行化。[@problem_id:3685441]", "problem": "考虑一个 Tomasulo 风格的乱序数据通路，其具有以下属性和策略，所有这些在计算机组成和体系结构中都是标准且经过充分验证的：\n\n- 有一个单一的公共数据总线（CDB），意味着在任何给定的周期内最多只能广播一个结果。\n- 保留站（RS）保存已发射的操作以及尚未就绪的操作数的标签。其操作数均已就绪的保留站条目可以被调度到空闲的功能单元（FU）上。\n- 有一个浮点加法器功能单元（FU），其执行延迟为 $\\ell_{a} = 3$ 个周期。当一个加法操作在周期 $s$ 开始执行时，它会占用该 FU $s, s+1, s+2$ 这几个周期，并从周期 $s+\\ell_{a} = s+3$ 开始有资格广播其结果。\n- CDB 仲裁按标签升序进行：在任何有多个已完成结果等待广播的周期中，CDB 选择最小的标签。广播将值传递给所有持有相应标签的等待中的保留站条目。\n- 唤醒和启动规则：与广播标签匹配的保留站操作数在广播的同一周期内变为就绪；但是，一个操作的开始执行时间不能早于其两个操作数都就绪后的下一个周期。开始执行要求相应的功能单元在那个启动周期是空闲的。\n- 下面描述的所有操作都已发射；没有进一步的发射、内存活动或提交会干扰时间线。\n\n在周期 $10$ 的开始，一个病态的“广播风暴”按如下方式产生。恰好有四个独立的浮点操作（来自此处未建模的任何旧的加法器或乘法器的混合）同时变得有资格写回；它们的标签是 $\\tau_{1}, \\tau_{2}, \\tau_{3}, \\tau_{4}$，具有严格的优先级 $\\tau_{1} \\lt \\tau_{2} \\lt \\tau_{3} \\lt \\tau_{4}$。从周期 $10$ 开始，这四个操作都在争夺单一的 CDB。\n\n同时，有三个待处理的浮点加法操作驻留在保留站中：\n\n- 操作 $A_{1}$ 等待两个源操作数，其标签为 $\\tau_{1}$ 和 $\\tau_{2}$。\n- 操作 $A_{2}$ 等待两个源操作数，其标签为 $\\tau_{3}$ 和 $\\tau_{4}$。\n- 操作 $A_{3}$ 等待 $A_{1}$ 和 $A_{2}$ 的结果（也就是说，一旦 $A_{1}$ 和 $A_{2}$ 完成， $A_{3}$ 将接收对应于它们写回的标签）。\n\n假设除了四个已完成但未广播的、标签为 $\\tau_{1}, \\tau_{2}, \\tau_{3}, \\tau_{4}$ 的生产者操作和三个加法操作 $A_{1}, A_{2}, A_{3}$ 之外，没有其他就绪或正在执行的操作。浮点加法器 FU 在周期 $10$ 开始时是空闲的。所有操作都遵循上述关于广播、唤醒、调度和延迟的规则。\n\n在这些约束条件下，确定操作 $A_{3}$ 在 CDB 上广播其结果的周期索引 $C_{\\text{final}}$。请以单个整型周期数的形式提供您的答案。不需要四舍五入，最终答案中不应包含单位。", "solution": "问题要求确定特定浮点加法操作 $A_{3}$ 在公共数据总线（CDB）上广播其结果的周期。数据通路遵循 Tomasulo 算法，并有指定的调度、执行和结果广播规则。为了确定这一点，我们必须从周期 $10$ 开始时的初始状态出发，逐周期地模拟相关处理器组件的状态——包括保留站（RS）、浮点加法器功能单元（FU）和 CDB。\n\n关键参数如下：\n- 一个单一的浮点加法器 FU。\n- 加法器执行延迟为 $\\ell_{a} = 3$ 个周期。一个在周期 $s$ 开始的操作会占用 FU $s, s+1, s+2$ 这几个周期。\n- 一个在周期 $s$ 开始的操作的结果从周期 $s + \\ell_{a} = s+3$ 开始有资格在 CDB 上广播。\n- 一个单一的 CDB，仲裁基于最小的标签值。\n- 一个操作可以在其两个操作数都就绪后的下一个周期开始执行，前提是所需的功能单元是空闲的。\n\n我们构建一个事件时间线：\n\n**初始状态（周期 $10$ 开始时）**\n- 四个带有标签 $\\tau_{1}, \\tau_{2}, \\tau_{3}, \\tau_{4}$（其中 $\\tau_{1} \\lt \\tau_{2} \\lt \\tau_{3} \\lt \\tau_{4}$）的结果已准备好广播。它们正在争夺 CDB。\n- 加法器 FU 是空闲的。\n- 操作 $A_{1}$ 位于一个 RS 中，等待标签为 $\\tau_{1}$ 和 $\\tau_{2}$ 的操作数。\n- 操作 $A_{2}$ 位于一个 RS 中，等待标签为 $\\tau_{3}$ 和 $\\tau_{4}$ 的操作数。\n- 操作 $A_{3}$ 位于一个 RS 中，等待 $A_{1}$ 和 $A_{2}$ 的结果。\n\n**逐周期分析**\n\n*   **周期 $10$**：\n    *   **CDB**：四个待处理的结果争夺 CDB。根据最小标签优先的仲裁规则，带有标签 $\\tau_{1}$ 的结果被广播。\n    *   **唤醒**：$A_{1}$ 的 RS 条目接收到 $\\tau_{1}$ 的值。它现在只等待 $\\tau_{2}$。\n\n*   **周期 $11$**：\n    *   **CDB**：三个结果（$\\tau_{2}, \\tau_{3}, \\tau_{4}$）处于待处理状态。带有标签 $\\tau_{2}$ 的结果赢得仲裁并被广播。\n    *   **唤醒**：$A_{1}$ 的 RS 条目接收到 $\\tau_{2}$ 的值。在周期 $11$ 结束时，$A_{1}$ 的两个操作数都已就绪。\n\n*   **周期 $12$**：\n    *   **CDB**：两个结果（$\\tau_{3}, \\tau_{4}$）处于待处理状态。带有标签 $\\tau_{3}$ 的结果被广播。\n    *   **唤醒**：$A_{2}$ 的 RS 条目接收到 $\\tau_{3}$ 的值。\n    *   **开始执行**：$A_{1}$ 的操作数在周期 $11$ 就绪。根据规则，它可以在下一个周期，即周期 $12$ 开始。加法器 FU 是空闲的。因此，**$A_{1}$ 开始执行**。它将占用 FU 周期 $12, 13, 14$。\n\n*   **周期 $13$**：\n    *   **CDB**：最后一个待处理的初始结果，带有标签 $\\tau_{4}$，被广播。\n    *   **唤醒**：$A_{2}$ 的 RS 条目接收到 $\\tau_{4}$ 的值。在周期 $13$ 结束时，$A_{2}$ 的两个操作数都已就绪。\n    *   **执行**：$A_{1}$ 继续执行（第 $2$ 个周期，共 $3$ 个）。加法器 FU 处于忙碌状态。\n\n*   **周期 $14$**：\n    *   **CDB**：由于没有新的结果准备写回，CDB 处于空闲状态。\n    *   **执行**：$A_{1}$ 继续执行（第 $3$ 个周期，共 $3$ 个）。加法器 FU 处于忙碌状态。$A_{2}$ 的操作数在周期 $13$ 就绪，它有资格在周期 $14$ 开始，但由于 FU 不空闲，必须等待。\n\n*   **周期 $15$**：\n    *   **完成与广播**：$A_{1}$ 在周期 $12$ 开始，延迟为 $3$ 个周期。它在周期 $14$ 结束时完成，并从周期 $12 + \\ell_{a} = 15$ 开始有资格广播其结果。CDB 是空闲的，所以 **$A_{1}$ 广播其结果**。\n    *   **唤醒**：$A_{3}$ 的 RS 接收到来自 $A_{1}$ 的值。它现在等待 $A_{2}$ 的结果。\n    *   **开始执行**：加法器 FU 现在是空闲的。自周期 $13$ 结束以来一直就绪的 $A_{2}$ 现在可以开始。因此，**$A_{2}$ 开始执行**。它将占用 FU 周期 $15, 16, 17$。\n\n*   **周期 $16$**：\n    *   **CDB**：空闲。\n    *   **执行**：$A_{2}$ 继续执行（第 $2$ 个周期，共 $3$ 个）。FU 处于忙碌状态。\n\n*   **周期 $17$**：\n    *   **CDB**：空闲。\n    *   **执行**：$A_{2}$ 继续执行（第 $3$ 个周期，共 $3$ 个）。FU 处于忙碌状态。\n\n*   **周期 $18$**：\n    *   **完成与广播**：$A_{2}$ 在周期 $15$ 开始。它在周期 $17$ 结束时完成，并有资格在周期 $15 + \\ell_{a} = 18$ 广播。CDB 是空闲的，所以 **$A_{2}$ 广播其结果**。\n    *   **唤醒**：$A_{3}$ 的 RS 接收到来自 $A_{2}$ 的值。在周期 $18$ 结束时，$A_{3}$ 的两个操作数都已就绪。\n    *   **FU 状态**：处理完 $A_{2}$ 后，加法器 FU 现在是空闲的。\n\n*   **周期 $19$**：\n    *   **CDB**：空闲。\n    *   **开始执行**：$A_{3}$ 的操作数在周期 $18$ 就绪。它可以在周期 $19$ 开始。加法器 FU 是空闲的。因此，**$A_{3}$ 开始执行**。它将占用 FU 周期 $19, 20, 21$。\n\n*   **周期 $20$**：\n    *   **CDB**：空闲。\n    *   **执行**：$A_{3}$ 继续执行（第 $2$ 个周期，共 $3$ 个）。FU 处于忙碌状态。\n\n*   **周期 $21$**：\n    *   **CDB**：空闲。\n    *   **执行**：$A_{3}$ 继续执行（第 $3$ 个周期，共 $3$ 个）。FU 处于忙碌状态。\n\n*   **周期 $22$**：\n    *   **完成与广播**：$A_{3}$ 在周期 $19$ 开始，延迟为 $3$ 个周期。它在周期 $21$ 结束时完成，并有资格在周期 $19 + \\ell_{a} = 22$ 广播。CDB 是空闲的。因此，**$A_{3}$ 在周期 $22$ 在 CDB 上广播其结果**。\n\n操作 $A_{3}$ 广播其结果的最终周期索引 $C_{\\text{final}}$ 是 $22$。", "answer": "$$\n\\boxed{22}\n$$", "id": "3685441"}, {"introduction": "最后的这项实践将挑战你像处理器设计者一样进行思考，对核心进行“法医式”分析。你将不再从头开始进行模拟，而是会得到一个特定时刻的机器状态快照，并需要反向推导出导致该状态的执行历史。这种分析要求你对保留站、寄存器结果状态表以及数据冒险之间的相互作用有深入且完整的理解，是真正检验你是否掌握算法规则的试金石。[@problem_id:3685422]", "problem": "一个处理器实现了 Tomasulo 算法，具有以下微架构特性和时序规则：\n\n- 每个周期有一个发射槽。每个周期最多按程序顺序发射一条指令。\n- 功能单元和保留站 (RS)：\n  - 一个加/减法单元，有两个保留站 $A_1$ 和 $A_2$；每个操作的延迟为 $2$ 个周期。\n  - 一个乘法单元，有两个保留站 $M_1$ 和 $M_2$；每个操作的延迟为 $4$ 个周期。\n  - 一个统一的加载/存储单元，有两个加载缓冲 $L_1$、$L_2$ 和一个存储缓冲 $S_1$；每个内存操作占用该单元 $2$ 个周期；该单元一次最多服务一个内存操作。\n- 有一条公共数据总线 (CDB)。每个周期最多一个结果可以通过 CDB 写回。\n- Tomasulo 流水线语义：\n  - 一条指令发射到一个可用的保留站，并带有其源操作数标签或值后，其执行不早于下一个周期开始，前提是功能单元空闲且其所有源操作数都可用（即，拥有的是值而非标签）。\n  - 需要 $k$ 个周期的执行在第 $k$ 个执行周期结束时完成；如果 CDB 空闲，其结果可以在随后的周期被放到 CDB 上。在 CDB 广播时，所有保留站和寄存器结果状态表捕获该值并清除匹配的标签；产生结果的保留站随后被释放。\n  - 寄存器结果状态表为每个体系结构寄存器 $F_i$ 记录作为 $F_i$ 最近的在执行中写入者的保留站标签；空白（表示为 $0$）表示没有在执行中的写入者。当一个值在 CDB 上广播时，当且仅当该寄存器的结果状态与广播标签匹配时，它才被清除为 $0$。\n\n考虑以下指令序列（使用浮点寄存器名 $F_i$；用于寻址的整数基址寄存器是 $R_1$ 并且总是就绪的）：\n\n- $\\mathrm{I1}$: $\\mathrm{L.D}\\ F2,\\ 0(R1)$\n- $\\mathrm{I2}$: $\\mathrm{L.D}\\ F4,\\ 8(R1)$\n- $\\mathrm{I3}$: $\\mathrm{MUL.D}\\ F6,\\ F2,\\ F4$\n- $\\mathrm{I4}$: $\\mathrm{ADD.D}\\ F6,\\ F6,\\ F2$\n- $\\mathrm{I5}$: $\\mathrm{SUB.D}\\ F2,\\ F4,\\ F2$\n- $\\mathrm{I6}$: $\\mathrm{S.D}\\ F6,\\ 16(R1)$\n- $\\mathrm{I7}$: $\\mathrm{ADD.D}\\ F8,\\ F2,\\ F6$\n\n假设处理器在周期 1 开始发射，基址寄存器 $R_1$ 在整个过程中都是就绪的，所有内存访问都命中，并在加载/存储单元中精确地占用 2 个周期，除了所述资源所隐含的结构性冒险外，不发生其他结构性冒险。CDB 使用的冲突由程序顺序解决（较早的指令先写）。\n\n在周期 $c = 9$ 结束时（即，在周期 9 发生的任何写回完成并且所有结构都已更新之后）获取了一个取证快照。快照揭示了以下状态：\n\n- 保留站和缓冲：\n  - $L_1$：不繁忙。\n  - $L_2$：不繁忙。\n  - $M_1$：繁忙，操作 $\\mathrm{MUL.D}$，$V_j$ 和 $V_k$ 均有效且 $Q_j = Q_k = 0$；剩余执行时间 = 1 周期。\n  - $M_2$：不繁忙。\n  - $A_1$：繁忙，操作 $\\mathrm{ADD.D}$，一个源操作数有效（$Q = 0$），另一个源操作数等待标签 $M_1$（即，$Q = M_1$）。\n  - $A_2$：不繁忙。\n  - $S_1$：繁忙，有效地址已计算且有效；存储数据等待标签 $A_1$（即，数据 $Q = A_1$）。\n- 寄存器结果状态（仅显示非零条目；其他所有条目均为 $0$）：\n  - $F6 \\rightarrow A_1$。\n  - $F2$、$F4$ 和 $F8$ 的条目均为 $0$（没有记录在执行中的写入者）。\n\n仅使用 Tomasulo 算法的规则、给定的延迟和上面的快照，重构在周期 9 结束时，I1 到 I7 中有哪些指令已经完成了写回，并解释到此为止必须存在哪些数据冒险（写后读、写后写和读后写）才能与快照保持一致。\n\n设 $N$ 为在周期 9 结束时，I1 到 I7 中已完成写回的指令数量。计算 $N$。你的最终答案必须是一个没有单位的整数。不需要四舍五入。", "solution": "解答需要重构从周期 1 到周期 9 的执行时间线，以得到给定的快照。我们将首先分析快照以确定关键事实，然后按时间顺序构建时间线。\n\n**对周期 9 结束时快照的分析：**\n1.  **保留站 $M_1$**：它持有一条延迟为 $4$ 个周期的指令，且剩余 $1$ 个执行周期。这意味着它已经执行了 $4-1=3$ 个周期（周期 $7, 8, 9$）。执行必须在周期 $7$ 开始。这条指令必须是 I3 (`MUL.D F6, F2, F4`)。要在周期 $7$ 开始执行，它的源操作数（来自 I1 和 I2）必须在周期 $6$ 结束前可用。\n2.  **保留站 $A_1$**：它持有一条 `ADD.D` 指令，并正在等待来自 $M_1$ 的结果。这必须是 I4 (`ADD.D F6, F6, F2`)，它对 I3 的寄存器 $F6$ 有真相关（RAW）。另一个操作数 $F2$ 被列为有效，意味着产生它的指令已经写回。\n3.  **保留站 $S_1$**：它持有一个存储指令，I6 (`S.D F6, 16(R1)`)，并正在等待来自 $A_1$ 的数据。这反映了对 I4 的寄存器 $F6$ 的 RAW 相关。\n4.  **寄存器结果状态 (RRS)**：\n    - $F6 \\rightarrow A_1$：这证实了 I4 是最后发射的、以寄存器 $F6$ 为目标的指令。这展示了 I3 和 I4 之间的写后写（WAW）冒险的处理方式。\n    - $F2 \\rightarrow 0, F4 \\rightarrow 0$：这意味着最后写入 $F2$（I5）和 $F4$（I2）的指令必须已经完成了它们的写回阶段。如果它们仍在执行，RRS 将持有它们的保留站标签。\n    - $F8 \\rightarrow 0$：写入 $F8$ 的指令是 I7。由于其 RRS 条目为 0，I7 尚未被发射。这很可能是因为当轮到 I7 发射时，所有加法器保留站都被占用了（结构性冒险）。\n5.  **加载/存储缓冲**：$L_1$ 和 $L_2$ 不繁忙。这意味着 I1 和 I2 不仅已经执行，而且还完成了它们的写回阶段，释放了它们的缓冲。\n\n**逐周期时间线重构：**\n\n令 IS、EX 和 WB 分别表示发射、执行和写回阶段。\n\n- **周期 1**：I1 (`L.D F2,...`) 发射到 $L_1$。RRS: $F2 \\rightarrow L_1$。\n- **周期 2**：I1 开始执行（占用加载/存储单元 2, 3 周期）。I2 (`L.D F4,...`) 发射到 $L_2$。RRS: $F2 \\rightarrow L_1, F4 \\rightarrow L_2$。\n- **周期 3**：I1 完成执行。I3 (`MUL.D F6,F2,F4`) 发射到 $M_1$。它需要 $F2$（标签 $L_1$）和 $F4$（标签 $L_2$）。RRS: $F2 \\rightarrow L_1, F4 \\rightarrow L_2, F6 \\rightarrow M_1$。\n- **周期 4**：I1 在 CDB 上写回（广播标签 $L_1$）。$M_1$ 捕获 $F2$ 的值。加载/存储单元现在空闲。I2 开始执行（占用加载/存储单元 4, 5 周期）。I4 (`ADD.D F6,F6,F2`) 发射到 $A_1$。它需要 $F6$（标签 $M_1$）和 $F2$（值已就绪）。RRS 更新为：$F6 \\rightarrow A_1$。\n- **周期 5**：I2 完成执行。I5 (`SUB.D F2,F4,F2`) 发射到 $A_2$。它需要 $F4$（标签 $L_2$）和 $F2$（值已就绪）。RRS 更新：$F2 \\rightarrow A_2$。\n- **周期 6**：I2 在 CDB 上写回（广播标签 $L_2$）。$M_1$ 捕获 $F4$ 的值，其两个操作数现在都已就绪。$A_2$ 捕获 $F4$ 的值，其两个操作数现在都已就绪。I6 (`S.D F6,...`) 发射到 $S_1$。它需要 $F6$ 的值（标签 $A_1$）。其地址被计算。\n- **周期 7**：I3 在乘法单元中开始执行（周期 $7,8,9,10$）。I5 在加/减法单元中开始执行（周期 $7,8$）。I7 无法发射，因为加法器保留站 $A_1, A_2$ 都被占用了。\n- **周期 8**：I3 继续执行（第 2/4 周期）。I5 完成执行。\n- **周期 9**：I3 继续执行（第 3/4 周期，剩余 1 周期）。I5 准备写回。由于 CDB 空闲，I5 写回。标签 $A_2$ 被广播。$RRS(F2)$（指向 $A_2$）被清除为 $0$。保留站 $A_2$ 被释放。\n\n这个时间线与快照中描述的状态完全匹配。\n\n**在周期 9 结束时已完成写回的指令：**\n根据时间线：\n- I1 (`L.D F2, ...`)：在周期 4 完成写回。\n- I2 (`L.D F4, ...`)：在周期 6 完成写回。\n- I5 (`SUB.D F2, ...`)：在周期 9 完成写回。\n\n其他指令的状态：\n- I3 (`MUL.D F6, ...`)：仍在执行中。\n- I4 (`ADD.D F6, ...`)：停顿，等待 I3。\n- I6 (`S.D F6, ...`)：停顿，等待 I4。\n- I7 (`ADD.D F8, ...`)：尚未发射。\n\n已完成写回的指令是 I1、I2 和 I5。因此，已完成写回的指令数量为 $N=3$。", "answer": "$$\n\\boxed{3}\n$$", "id": "3685422"}]}