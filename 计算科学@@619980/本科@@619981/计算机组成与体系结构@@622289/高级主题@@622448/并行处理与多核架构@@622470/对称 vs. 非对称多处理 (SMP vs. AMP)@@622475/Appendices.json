{"hands_on_practices": [{"introduction": "我们从基础开始。阿姆达尔定律是性能分析的基石，它揭示了系统中可加速部分和串行部分对整体性能提升的影响。本练习将应用该定律，比较一个通过并行化扩展的对称多处理（SMP）系统与一个通过“大”核加速特定工作负载的非对称多处理（AMP）系统。通过推导加速比的比率，你将从第一性原理层面理解，基于不同的工作负载特性，一种架构何时会优于另一种架构。[@problem_id:3683281]", "problem": "一个单程序工作负载将在两种备选的多核架构上运行，这两种架构具有相同的技术和功耗预算。架构A是一个非对称多处理器 (AMP)，拥有一个可加速单指令多数据 (SIMD) 可矢量化操作的“大”核，其余核心是与基准单核参考相同的基准核心。架构B是一个对称多处理器 (SMP)，拥有 $p$ 个相同的基准核心，但没有SIMD加速功能。\n\n假设如下：\n- 程序的基准单核执行时间为 $T_{1}$。\n- 程序的指令组合中，有比例为 $f_{vec}$ 的部分是可SIMD矢量化的，并且仅在AMP的大核上获得理想加速因子 $k_{v}$ 的加速，而剩余比例为 $1 - f_{vec}$ 的部分则无法从SIMD加速中受益。\n- 在SMP上，程序中一个（可能不同的）比例为 $f_{par}$ 的部分可在 $p$ 个相同的基准核心上理想并行化，而剩余比例为 $1 - f_{par}$ 的部分是内在串行的，并在单个核心上运行。\n- 忽略所有由同步、通信、调度和内存系统效应引起的开销；假设可并行化部分具有完美的负载均衡，可矢量化部分具有理想的SIMD加速比。所有基准核心都以相同的频率运行，并具有与基准单核参考相同的每指令性能；大核的唯一不同之处在于为可矢量化部分提供了SIMD加速因子 $k_{v}$。\n\n仅从“执行时间是互斥代码部分的总和”以及“加速比定义为基准时间除以优化后时间”这两个定义出发，推导比率\n$$R \\equiv \\frac{S_{AMP}}{S_{SMP}},$$\n的封闭形式表达式，并尽可能地简化。其中 $S_{AMP}$ 是程序在大核上运行时AMP的加速比，$S_{SMP}$ 是程序在 $p$ 个核心上以理想并行化方式运行时SMP的加速比。请用 $f_{vec}$、$k_{v}$、$f_{par}$ 和 $p$ 来表示您的最终答案，形式为一个单一的解析表达式。", "solution": "在尝试任何解答之前，需对问题陈述进行验证。\n\n**步骤1：提取已知条件**\n- 基准单核执行时间：$T_{1}$\n- 系统A (AMP)：具有一个“大”核的非对称多处理器。\n- 系统B (SMP)：具有 $p$ 个相同基准核心的对称多处理器。\n- AMP程序特性：程序中比例为 $f_{vec}$ 的部分是可SIMD矢量化的，并在大核上以因子 $k_{v}$ 进行加速。剩余比例为 $1 - f_{vec}$ 的部分不被加速。指定程序在大核上运行。\n- SMP程序特性：程序中比例为 $f_{par}$ 的部分可在 $p$ 个核心上理想并行化。剩余比例为 $1 - f_{par}$ 的部分是内在串行的。\n- 假设：忽略所有开销；负载均衡和加速比是理想的。\n- 定义：执行时间是互斥代码部分的总和。加速比 $S$ 定义为基准时间除以优化后时间，$S = T_{baseline} / T_{optimized}$。\n- 目标：推导比率 $R \\equiv \\frac{S_{AMP}}{S_{SMP}}$ 的封闭形式表达式，用 $f_{vec}$、$k_v$、$f_{par}$ 和 $p$ 表示。\n\n**步骤2：使用提取的已知条件进行验证**\n该问题被评估为**有效**。它提出了一个基于阿姆达尔定律（Amdahl's Law）的适定的、有科学依据的场景，阿姆达尔定律是计算机体系结构中用于建模性能加速比的一项基本原则。AMP和SMP这两种系统是常见的架构范式。使用代码比例（$f_{vec}$, $f_{par}$）和加速因子（$k_v$, $p$）是此类分析的标准方法论。这些假设虽然是理想化情况（例如，零开销），但被明确陈述以定义一个简化但连贯的理论模型，这在学术问题中是一种常见且有效的做法。该问题是自洽的、客观的、逻辑一致的，并且有一个明确且唯一可确定的目标。\n\n**步骤3：解题推导**\n推导过程首先计算每个系统的执行时间和相应的加速比，然后计算它们的比率。\n\n设 $T_{1}$ 为程序在单个基准核心上的执行时间。\n\n首先，我们分析非对称多处理器 (AMP) 配置。问题陈述指明程序在大核上运行。程序由比例为 $f_{vec}$ 的可矢量化部分和比例为 $1 - f_{vec}$ 的不可矢量化部分组成。不可矢量化部分在大核上的执行时间与在基准核心上相同，为 $(1 - f_{vec}) T_{1}$。可矢量化部分被加速了因子 $k_{v}$，因此其在大核上的执行时间为 $\\frac{f_{vec} T_{1}}{k_{v}}$。AMP上的总执行时间 $T_{AMP}$ 是这两个互斥部分的时间之和：\n$$T_{AMP} = (1 - f_{vec}) T_{1} + \\frac{f_{vec} T_{1}}{k_{v}}$$\n提取因子 $T_{1}$，我们得到：\n$$T_{AMP} = T_{1} \\left( 1 - f_{vec} + \\frac{f_{vec}}{k_{v}} \\right)$$\nAMP的加速比 $S_{AMP}$ 是基准时间 $T_{1}$ 与优化后时间 $T_{AMP}$ 的比率：\n$$S_{AMP} = \\frac{T_{1}}{T_{AMP}} = \\frac{T_{1}}{T_{1} \\left( 1 - f_{vec} + \\frac{f_{vec}}{k_{v}} \\right)} = \\frac{1}{1 - f_{vec} + \\frac{f_{vec}}{k_{v}}}$$\n\n接下来，我们分析对称多处理器 (SMP) 配置。程序有比例为 $1 - f_{par}$ 的串行部分和比例为 $f_{par}$ 的可并行化部分。串行部分在单个核心上运行，其执行时间为 $(1 - f_{par}) T_{1}$。可并行化部分理想地分布在 $p$ 个核心上，因此其执行时间为 $\\frac{f_{par} T_{1}}{p}$。SMP上的总执行时间 $T_{SMP}$ 是串行和并行阶段的时间之和：\n$$T_{SMP} = (1 - f_{par}) T_{1} + \\frac{f_{par} T_{1}}{p}$$\n提取因子 $T_{1}$：\n$$T_{SMP} = T_{1} \\left( 1 - f_{par} + \\frac{f_{par}}{p} \\right)$$\nSMP的加速比 $S_{SMP}$ 是基准时间 $T_{1}$ 与优化后时间 $T_{SMP}$ 的比率：\n$$S_{SMP} = \\frac{T_{1}}{T_{SMP}} = \\frac{T_{1}}{T_{1} \\left( 1 - f_{par} + \\frac{f_{par}}{p} \\right)} = \\frac{1}{1 - f_{par} + \\frac{f_{par}}{p}}$$\n\n最后，我们计算所求比率 $R \\equiv \\frac{S_{AMP}}{S_{SMP}}$：\n$$R = \\frac{S_{AMP}}{S_{SMP}} = \\frac{\\frac{1}{1 - f_{vec} + \\frac{f_{vec}}{k_{v}}}}{\\frac{1}{1 - f_{par} + \\frac{f_{par}}{p}}}$$\n这可以简化为分母的倒数之比：\n$$R = \\frac{1 - f_{par} + \\frac{f_{par}}{p}}{1 - f_{vec} + \\frac{f_{vec}}{k_{v}}}$$\n为了进一步简化此表达式并消除复合分数，我们可以对主分数的分子和分母进行通分。\n分子变为：\n$$1 - f_{par} + \\frac{f_{par}}{p} = \\frac{p(1 - f_{par}) + f_{par}}{p} = \\frac{p - p f_{par} + f_{par}}{p} = \\frac{p - f_{par}(p - 1)}{p}$$\n分母变为：\n$$1 - f_{vec} + \\frac{f_{vec}}{k_{v}} = \\frac{k_{v}(1 - f_{vec}) + f_{vec}}{k_{v}} = \\frac{k_{v} - k_{v} f_{vec} + f_{vec}}{k_{v}} = \\frac{k_{v} - f_{vec}(k_{v} - 1)}{k_{v}}$$\n将它们代回 $R$ 的表达式中：\n$$R = \\frac{\\frac{p - f_{par}(p - 1)}{p}}{\\frac{k_{v} - f_{vec}(k_{v} - 1)}{k_{v}}}$$\n这简化为最终的封闭形式表达式：\n$$R = \\frac{k_{v} [p - f_{par}(p - 1)]}{p[k_{v} - f_{vec}(k_{v} - 1)]}$$\n该表达式给出了在指定的理想化条件下，AMP系统相对于SMP系统的性能比。", "answer": "$$\\boxed{\\frac{k_{v} [p - f_{par}(p - 1)]}{p [k_{v} - f_{vec}(k_{v} - 1)]}}$$", "id": "3683281"}, {"introduction": "现实世界中的性能不仅仅关乎原始速度，还涉及各种开销。这个练习模拟了非对称系统中的一个关键决策：将任务转移到一个更快的“大”核上执行，何时才真正划算？你将通过平衡数据传输和设置的固定成本与计算增益，推导出使得任务卸载变得有利的最小内核大小。[@problem_id:3683271]", "problem": "考虑一个混合了对称多处理（Symmetric Multiprocessing, SMP）和非对称多处理（Asymmetric Multiprocessing, AMP）设计思想的多核系统。该系统有两个核心：一个“小”核和一个“大”核。在非对称多处理（AMP）的意义上，只有大核实现了专门的指令集架构（Instruction Set Architecture, ISA）扩展，用以加速特定的内核。小核没有这些ISA扩展，只能执行基准的内核实现。\n\n假设以下基于第一性原理的、有科学依据的性能模型：\n- 内核包含 $n$ 个符合扩展条件的运算。\n- 小核以每秒 $\\mu$ 次运算的基准服务速率执行。\n- 大核在运行经ISA加速的内核时，相对于小核实现了 $k$ 倍的乘法加速因子，因此其服务速率为 $k \\mu$，其中 $k > 1$。\n- 将内核卸载到大核需要一次性的固定复制和设置成本 $T_{\\text{copy}}$（以秒为单位），涵盖了代码/数据移动和启动开销。该成本与 $n$ 无关。\n- 忽略排队、争用和干扰；假设内核在任何一个核心上执行时都是独占执行。\n\n仅使用“完成时间等于工作量除以服务速率加上任何固定开销”这一基本关系，定义卸载“有帮助”的条件，即卸载到大核的总完成时间严格小于在小核上本地执行的时间。推导使卸载有帮助的最小内核大小 $n^{\\*}$（以运算次数为单位）的精确闭式符号表达式。你的最终答案只能用 $k$、$\\mu$ 和 $T_{\\text{copy}}$ 来表示。不需要进行数值计算，也不允许四舍五入。以运算（指令）为单位报告 $n^{\\*}$。", "solution": "该问题对比了核心相同的对称多处理（SMP）和核心不同的非对称多处理（AMP）。在此情境下，只有大核拥有专门的指令集架构（ISA）扩展，这使其在处理给定内核时具有非对称优势。我们使用“完成时间等于工作量除以服务速率加上任何固定开销”这一定律来对执行过程建模。\n\n设内核包含 $n$ 个符合扩展条件的运算。小核以每秒 $\\mu$ 次运算的速率执行，因此在小核上的本地执行时间为\n$$\nT_{\\text{local}} = \\frac{n}{\\mu}.\n$$\n如果将内核卸载到大核，会产生用于复制和设置代码/数据的固定开销 $T_{\\text{copy}}$。由于ISA扩展，大核以每秒 $k \\mu$ 次运算的速率执行内核。因此，卸载后的总完成时间为\n$$\nT_{\\text{offload}} = T_{\\text{copy}} + \\frac{n}{k \\mu}.\n$$\n\n如果卸载后的完成时间严格小于本地完成时间，则卸载“有帮助”：\n$$\nT_{\\text{offload}}  T_{\\text{local}}.\n$$\n代入表达式：\n$$\nT_{\\text{copy}} + \\frac{n}{k \\mu}  \\frac{n}{\\mu}.\n$$\n重新整理，将含 $n$ 的项移到右侧：\n$$\nT_{\\text{copy}}  \\frac{n}{\\mu} - \\frac{n}{k \\mu} = \\frac{n}{\\mu}\\left(1 - \\frac{1}{k}\\right).\n$$\n求解 $n$：\n$$\nn > \\mu T_{\\text{copy}} \\cdot \\frac{1}{1 - \\frac{1}{k}}.\n$$\n注意到 $1 - \\frac{1}{k} = \\frac{k - 1}{k}$，因此\n$$\nn > \\mu T_{\\text{copy}} \\cdot \\frac{k}{k - 1}.\n$$\n卸载开始有帮助的最小内核大小 $n^{\\*}$（即等式成立且两个完成时间相等时的大小）为\n$$\nn^{\\*} = \\frac{k \\mu T_{\\text{copy}}}{k - 1}.\n$$\n\n这个结果与直观的权衡相符：更大的 $k$（更大的加速比）或更大的 $\\mu$（更高的基准速率）会降低时间单位上的阈值，但是，由于 $n^{\\*}$ 是以运算次数为单位的，它会与 $\\mu T_{\\text{copy}}$ 成比例增加，并以 $\\frac{k}{k - 1}$ 的比例缩放，这反映了当 $k$ 变得很大时收益递减的现象。最终的表达式给出了用 $k$、$\\mu$ 和 $T_{\\text{copy}}$ 表示的精确符号阈值。", "answer": "$$\\boxed{\\frac{k \\mu T_{\\text{copy}}}{k - 1}}$$", "id": "3683271"}, {"introduction": "架构选择对软件设计，尤其是操作系统，有着深远的影响。这个练习深入探讨了操作系统中一个经典的问题——在等待锁时是自旋等待还是阻塞——但它加入了非对称多处理系统这一现代背景。你将计算出决定最优策略的等待时间阈值，从而揭示硬件异构性如何影响底层软件的启发式策略。[@problem_id:3683333]", "problem": "一个共享资源由一个锁来保护，该系统可能在对称多处理（SMP）或非对称多处理（AMP）模式下运行。在SMP中，所有核心都是相同的。在AMP中，一个“大”核和一个“小”核共存，由于性能更高，大核执行给定的临界区所需的周期数更少。考虑一个当前调度在大核上运行的竞争线程。它必须在锁上自旋（忙等待）或阻塞（睡眠）并让操作系统（OS）重新调度之间做出选择。使用以下经过充分检验的事实和定义作为您推理的基础：\n\n- 自旋等待时间 $t$ 所消耗的中央处理器（CPU）周期数为 $f t$，其中 $f$ 是核心频率，单位为周期/秒。\n- 阻塞会产生 $b$ 个周期的固定开销（由于上下文切换和唤醒），但在等待期间不消耗CPU周期。\n- 在大核上，临界区消耗 $c_{\\text{big}}$ 个周期。在小核上，相同的临界区消耗 $c_{\\text{small}}$ 个周期。\n- 在给定的AMP系统中，在大核上执行临界区比在小核上执行节省 $k$ 个周期，因此 $c_{\\text{big}} = c_{\\text{small}} - k$。\n\n假设AMP场景的参数如下：大核频率为 $f = 3.2 \\times 10^{9}$ 周期/秒，阻塞开销为 $b = 1.5 \\times 10^{4}$ 周期，大核在临界区的优势为 $k = 8.0 \\times 10^{3}$ 周期。将自旋路径的总周期成本建模为自旋所花费的周期数加上在大核上执行临界区的周期数，将阻塞路径的总周期成本建模为阻塞开销加上在小核上执行临界区的周期数。推导出阻塞严格优于自旋的阈值等待时间 $t^{*}$，然后根据给定参数计算其数值。\n\n将 $t^{*}$ 以微秒表示，并将您的答案四舍五入到四位有效数字。", "solution": "首先将对问题进行验证，以确保其科学合理、定义明确且客观。\n\n### 步骤1：提取已知条件\n问题陈述中提供的数据、变量、定义和条件如下：\n- 一个共享资源由一个锁在SMP或AMP系统中保护。\n- 在AMP中，一个“大”核和一个“小”核共存。\n- 一个竞争线程当前位于大核上。\n- 该线程必须在自旋（忙等待）或阻塞（睡眠）之间做出选择。\n- 自旋时间 $t$ 的CPU周期成本：成本为 $f t$，其中 $f$ 是核心频率。\n- 阻塞的CPU周期成本：固定开销为 $b$ 个周期。\n- 大核上临界区的周期数：$c_{\\text{big}}$。\n- 小核上临界区的周期数：$c_{\\text{small}}$。\n- 临界区成本之间的关系：$c_{\\text{big}} = c_{\\text{small}} - k$。\n- 自旋路径的总周期成本：自旋所花费的周期数加上在大核上执行临界区的周期数。\n- 阻塞路径的总周期成本：阻塞开销加上在小核上执行临界区的周期数。\n- 大核频率：$f = 3.2 \\times 10^{9}$ 周期/秒。\n- 阻塞开销：$b = 1.5 \\times 10^{4}$ 周期。\n- 大核在临界区的优势：$k = 8.0 \\times 10^{3}$ 周期。\n- 任务是找到阈值等待时间 $t^{*}$，在该时间点，阻塞严格优于自旋。\n- $t^{*}$ 的最终答案应以微秒为单位，并四舍五入到四位有效数字。\n\n### 步骤2：使用提取的已知条件进行验证\n根据验证标准对问题进行评估。\n- **科学依据：** 该问题使用了计算机组织与体系结构中的既定概念，包括对称多处理（SMP）、非对称多处理（AMP）、自旋锁、阻塞、上下文切换开销和CPU周期成本。所提出的模型是分析自旋和阻塞之间性能权衡的标准且有效的简化模型。\n- **定义明确：** 该问题为自旋和阻塞路径的成本提供了清晰明确的定义。关键是，它指定了在每种情况下执行临界区的核心。这使得可以构建一个可解的代数不等式来找到阈值时间 $t^{*}$。问题是自包含的，并为唯一解提供了所有必要的参数。\n- **客观性：** 问题以精确、定量的术语陈述，没有主观或推测性的主张。\n\n该问题没有表现出验证标准中列出的任何缺陷。它是科学合理、定义明确且客观的。\n\n### 步骤3：结论与行动\n该问题被判定为**有效**。将推导解答。\n\n### 解答推导\n目标是找到阈值等待时间 $t^{*}$，在该时间点，阻塞的总周期成本严格小于自旋的总周期成本。设 $t$ 为线程等待锁释放的时间。\n\n根据问题陈述，对于大核上的线程，自旋路径的总周期成本 $C_{\\text{spin}}$ 是自旋所花费的周期数和在大核上执行临界区的周期数之和。自旋成本为 $f t$，其中 $f$ 是大核的频率。\n$$C_{\\text{spin}}(t) = f t + c_{\\text{big}}$$\n\n阻塞路径的总周期成本 $C_{\\text{block}}$ 是固定阻塞开销和执行临界区的周期数之和。问题指定在阻塞路径中，临界区在小核上执行。这是一个合理的情景，即操作系统在唤醒线程时，可能会将其调度到任何可用的核心上，而这个核心可能是小核。\n$$C_{\\text{block}} = b + c_{\\text{small}}$$\n注意 $C_{\\text{block}}$ 是一个常数，不依赖于等待时间 $t$。\n\n当 $C_{\\text{block}}  C_{\\text{spin}}(t)$ 时，阻塞成为严格更优的选项。阈值时间 $t^{*}$ 是两种成本相等的点，标志着两种机制之间的边界。对于任何大于 $t^{*}$ 的等待时间，自旋将更加昂贵。\n$$C_{\\text{spin}}(t^{*}) = C_{\\text{block}}$$\n$$f t^{*} + c_{\\text{big}} = b + c_{\\text{small}}$$\n\n为了求解 $t^{*}$，我们重新整理方程：\n$$f t^{*} = b + c_{\\text{small}} - c_{\\text{big}}$$\n\n问题给出了两个核心上临界区成本之间的关系：\n$$c_{\\text{big}} = c_{\\text{small}} - k$$\n这可以重写为：\n$$c_{\\text{small}} - c_{\\text{big}} = k$$\n\n将此代入 $t^{*}$ 的方程中：\n$$f t^{*} = b + k$$\n\n现在，我们可以分离出 $t^{*}$ 来找到它的符号表达式：\n$$t^{*} = \\frac{b + k}{f}$$\n\n问题提供了以下数值：\n- $b = 1.5 \\times 10^{4}$ 周期\n- $k = 8.0 \\times 10^{3}$ 周期\n- $f = 3.2 \\times 10^{9}$ 周期/秒\n\n我们将这些值代入 $t^{*}$ 的表达式中：\n$$t^{*} = \\frac{1.5 \\times 10^{4} + 8.0 \\times 10^{3}}{3.2 \\times 10^{9}}$$\n$$t^{*} = \\frac{15 \\times 10^{3} + 8.0 \\times 10^{3}}{3.2 \\times 10^{9}} = \\frac{23 \\times 10^{3}}{3.2 \\times 10^{9}} = \\frac{2.3 \\times 10^{4}}{3.2 \\times 10^{9}} \\text{ seconds}$$\n\n进行除法计算：\n$$t^{*} = \\frac{2.3}{3.2} \\times 10^{4-9} = 0.71875 \\times 10^{-5} \\text{ seconds}$$\n\n问题要求答案以微秒（$\\mu\\text{s}$）为单位。我们使用转换因子 $1 \\text{ s} = 10^6 \\text{ } \\mu\\text{s}$ 将秒转换为微秒：\n$$t^{*} = (0.71875 \\times 10^{-5} \\text{ s}) \\times (10^6 \\text{ } \\mu\\text{s/s})$$\n$$t^{*} = 0.71875 \\times 10^{1} \\text{ } \\mu\\text{s} = 7.1875 \\text{ } \\mu\\text{s}$$\n\n最后，我们必须将结果四舍五入到四位有效数字。数字 $7.1875$ 有五位有效数字。四舍五入到四位有效数字得到 $7.188$。\n$$t^{*} \\approx 7.188 \\text{ } \\mu\\text{s}$$", "answer": "$$\\boxed{7.188}$$", "id": "3683333"}]}