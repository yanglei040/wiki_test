{"hands_on_practices": [{"introduction": "要真正理解错误检测，我们必须超越抽象概念，了解它是如何从底层构建的。第一个练习 [@problem_id:3640130] 要求你仅使用基本的与非门（NAND gates）来设计一个奇偶校验生成器，将奇偶校验的数学定义与其具体的硬件实现及相关成本联系起来。通过完成这个练习，你将深入了解错误校验电路在门级的复杂性。", "problem": "一个存储子系统使用偶校验位来检测每个传输的数据字中的单比特错误。对于长度为 $n$ 的数据字，偶校验位 $p$ 由模2和 $p = d_{1} \\oplus d_{2} \\oplus \\cdots \\oplus d_{n}$ 定义，其中 $\\oplus$ 表示布尔变量的异或（XOR）运算，且 $d_{i} \\in \\{0,1\\}$。你需要设计一个组合逻辑奇偶校验生成器，要求仅使用双输入与非门，并假设扇出无限，且只有未取反的主输入 $d_{i}$ 可用。\n\n仅从与非（NAND）和异或（XOR）的布尔代数定义以及标准恒等式出发，完成以下步骤：\n\n- 仅使用双输入与非门构建一个双输入异或（XOR）子电路，并通过布尔表达式的代数变换来证明其正确性。\n- 使用由相同的双输入异或子电路构成的平衡二叉归约树来实现 $p = d_{1} \\oplus \\cdots \\oplus d_{n}$。\n- 推导整个奇偶校验生成器所需的双输入与非门的总确切数量 $G(n)$，将其表示为 $n$ 的函数。\n\n为了提供背景和对比（请勿将此包含在所要求的最终值中），请在你的推理中说明，与在同样平衡树中使用双输入异或门作为基本单元（将每个异或基本单元计为一个门）的基准方案相比，仅使用与非门的门数量如何。\n\n请以 $n$ 的单个闭式表达式形式给出最终答案 $G(n)$。不需要数值近似或四舍五入。", "solution": "问题要求推导构建一个 $n$ 位偶校验生成器所需的双输入与非门的总数量 $G(n)$。该设计被限制为仅使用双输入与非门，输入为未取反的主输入，并且必须构造成一个由相同的双输入异或子电路组成的平衡二叉归约树。\n\n推导将按照问题陈述的要求分三步进行。首先，我们将仅使用双输入与非门构建一个双输入异或子电路，并证明其正确性。其次，我们将分析平衡二叉树的结构，以确定所需的此类异或子电路的数量。最后，我们将结合这些结果来推导总门数 $G(n)$。\n\n**第一步：使用双输入与非门构建双输入异或子电路**\n\n设异或函数的输入为 $A$ 和 $B$。异或的布尔表达式为：\n$$A \\oplus B = A'B + AB'$$\n双输入与非门的布尔表达式为：\n$$A \\uparrow B = (A \\cdot B)' = A' + B'$$\n其中我们使用运算符 $\\uparrow$ 来表示与非运算。\n\n我们必须仅使用 $\\uparrow$ 运算符构建一个等效于 $A \\oplus B$ 的电路。虽然存在多种实现方式，一个著名且高效的电路使用四个双输入与非门。其结构由以下布尔表达式给出：\n$$F = (A \\uparrow (A \\uparrow B)) \\uparrow (B \\uparrow (A \\uparrow B))$$\n\n为了证明该构造的正确性，我们将对此表达式进行代数变换，以证明它等效于 $A \\oplus B$。让我们定义一个中间信号 $G_1 = A \\uparrow B$。输出 $F$ 的表达式变为：\n$$F = (A \\uparrow G_1) \\uparrow (B \\uparrow G_1)$$\n使用与非运算的定义展开此式：\n$$F = ( (A \\uparrow G_1) \\cdot (B \\uparrow G_1) )'$$\n$$F = ( (A \\cdot G_1)' \\cdot (B \\cdot G_1)' )'$$\n应用德摩根定律 $(X' \\cdot Y')' = X + Y$，我们可以简化此表达式。令 $X = A \\cdot G_1$ 且 $Y = B \\cdot G_1$。\n$$F = (A \\cdot G_1) + (B \\cdot G_1)$$\n使用分配律，我们可以提出公因子 $G_1$：\n$$F = (A+B) \\cdot G_1$$\n现在，我们代入 $G_1 = A \\uparrow B = (A \\cdot B)'$ 的表达式：\n$$F = (A+B) \\cdot (A \\cdot B)'$$\n对 $(A \\cdot B)'$ 应用德摩根定律得到 $A' + B'$：\n$$F = (A+B) \\cdot (A' + B')$$\n我们使用分配律展开此表达式：\n$$F = A \\cdot (A' + B') + B \\cdot (A' + B')$$\n$$F = (A \\cdot A') + (A \\cdot B') + (B \\cdot A') + (B \\cdot B')$$\n根据布尔代数公理，$X \\cdot X' = 0$。因此，$A \\cdot A' = 0$ 且 $B \\cdot B' = 0$。表达式简化为：\n$$F = 0 + A \\cdot B' + A' \\cdot B + 0$$\n$$F = A'B + AB'$$\n这个最终表达式是异或函数 $A \\oplus B$ 的定义。因此，由四个双输入与非门构建的电路正确地实现了一个双输入异或函数。构建一个这样的子电路所需的门数量为 $4$。该设计直接使用输入 $A$ 和 $B$，满足了问题中只有未取反的输入可用的约束条件。\n\n**第二步：平衡二叉归约树分析**\n\n校验位 $p$ 定义为 $n$ 个数据位的异或和：\n$$p = d_{1} \\oplus d_{2} \\oplus \\cdots \\oplus d_{n}$$\n异或运算是可结合的，即 $(A \\oplus B) \\oplus C = A \\oplus (B \\oplus C)$。这使我们能够通过将双输入异或运算级联成树状结构来计算 $n$ 输入的异或和。指定使用平衡二叉归约树是为了最小化传播延迟。\n\n要使用双输入门计算 $n$ 个输入的异Or和，我们总共需要 $n-1$ 个这样的门。我们可以通过归纳法来证明这一点。设 $N_{\\text{XOR}}(n)$ 为 $n$ 个输入所需的双输入异或子电路的数量。\n- 当 $n=2$ 时，我们需要 $1$ 个子电路，所以 $N_{\\text{XOR}}(2) = 1 = 2-1$。\n- 当 $n=3$ 时，我们计算 $(d_1 \\oplus d_2) \\oplus d_3$，这需要 $2$ 个子电路。所以 $N_{\\text{XOR}}(3) = 2 = 3-1$。\n- 对于一个通用的 $n$，平衡树结构将 $n$ 个输入划分为大小为 $\\lceil n/2 \\rceil$ 和 $\\lfloor n/2 \\rfloor$ 的两组。这两组的异或和被递归地计算，然后它们的结果通过最后一个异或门进行组合。递推关系式为：\n$$N_{\\text{XOR}}(n) = N_{\\text{XOR}}(\\lceil n/2 \\rceil) + N_{\\text{XOR}}(\\lfloor n/2 \\rfloor) + 1$$\n其中基例为 $N_{\\text{XOR}}(1) = 0$。\n假设归纳假设 $N_{\\text{XOR}}(k) = k-1$ 对所有 $k  n$ 成立：\n$$N_{\\text{XOR}}(n) = (\\lceil n/2 \\rceil - 1) + (\\lfloor n/2 \\rfloor - 1) + 1$$\n$$N_{\\text{XOR}}(n) = \\lceil n/2 \\rceil + \\lfloor n/2 \\rfloor - 1$$\n对于任何整数 $n$，恒等式 $\\lceil n/2 \\rceil + \\lfloor n/2 \\rfloor = n$ 成立。因此：\n$$N_{\\text{XOR}}(n) = n - 1$$\n这证明了实现 $n$ 位奇偶校验生成器总共需要 $n-1$ 个相同的双输入异或子电路。\n\n**第三步：总与非门数量 $G(n)$ 的推导**\n\n我们已经确定了以下几点：\n1.  每个双输入异或子电路是使用 $4$ 个双输入与非门实现的。\n2.  整个 $n$ 位奇偶校验生成器需要 $n-1$ 个这样的相同异或子电路，排列成一棵平衡树。\n\n树中的每个异或子电路接收的输入要么是主输入 $d_i$，要么是前一级异或子电路的未取反输出。由于每个子电路都是一个独立的模块，它们之间没有门共享的机会。\n\n因此，双输入与非门的总数量 $G(n)$ 是异或子电路数量与每个子电路的与非门数量的乘积：\n$$G(n) = (\\text{异或子电路数量}) \\times (\\text{每个异或子电路的与非门数量})$$\n$$G(n) = (n-1) \\times 4$$\n$$G(n) = 4(n-1)$$\n\n如题目要求的背景和对比，一个使用基本双输入异或门的基准设计总共需要 $n-1$ 个门。我们仅使用与非门的实现需要 $4(n-1)$ 个门，是其 $4$ 倍。这个系数直接反映了在给定约束下，从仅有与非门的逻辑族中合成异或函数的门复杂度。\n\n对于一个 $n$ 位奇偶校验生成器，所需的双输入与非门总数的最终推导表达式为 $G(n) = 4(n-1)$。", "answer": "$$\\boxed{4(n-1)}$$", "id": "3640130"}, {"introduction": "虽然奇偶校验能有效检测单位元错误，但它也存在着关键的局限性。本练习 [@problem_id:3640110] 提出了一个涉及数据总线上相邻导线串扰的真实场景，这是多位元错误的常见来源。通过对此物理现象进行建模，你将计算出一个*未被检测到*的错误的概率，从而揭示简单奇偶校验码的一个根本盲点，并强调选择与可能错误模式相匹配的纠错码的重要性。", "problem": "一个具有$32$根数据线和一根奇偶校验线的并行数据总线实现了偶校验错误检测，这意味着奇偶校验生成器设置奇偶校验位，使得在$33$个传输位中逻辑1的总数为偶数。接收器对接收到的数据重新计算奇偶校验，并与接收到的奇偶校验位进行比较以检测差异。每次数据传输是一个字（$32$个数据位加上一个奇偶校验位），通过印刷电路板上物理上相邻的微带线同时发送。由于微带线很长且间距很近，电容耦合会在相邻导线之间引起串扰。\n\n将单个字传输过程中的物理错误机制建模如下：\n- 由于随机噪声，独立的单线位翻转以每个传输中每根线$p$的概率发生，并且这些事件在各条线之间是独立的。\n- 此外，对于每对物理上相邻的导线，耦合的双线同时翻转（两根线一起反转）以每个传输中每对相邻导线$q$的概率发生，这在各对之间是独立的，并且与单线翻转无关。\n\n假设$33$根导线的线性物理排列为：$D_{0}, D_{1}, \\ldots, D_{31}, P$，其中$D_{i}$是数据线，$P$是奇偶校验线。在这种排列中，有$32$对相邻导线：$(D_{0},D_{1}), (D_{1},D_{2}), \\ldots, (D_{30},D_{31}), (D_{31},P)$。在本案例研究中，取$p = 1.2 \\times 10^{-6}$和$q = 3.0 \\times 10^{-8}$。\n\n从偶校验的定义和基本概率公理出发，并使用稀有事件近似，忽略所有$p^{2}$、$pq$和$q^{2}$阶的项（即，假设每次传输最多发生一个错误事件），推导并计算发生错误但未被奇偶校验检测出的概率。将最终概率表示为科学记数法的小数，并四舍五入到四位有效数字。", "solution": "问题要求在给定两种错误机制和一个稀有事件近似的条件下，计算一个偶校验系统发生未被检测到的错误的概率。\n\n**第一步：理解未检测到错误的条件**\n系统采用偶校验，这意味着对于每一个发送的字（32个数据位 + 1个校验位），比特“1”的总数是偶数。接收器通过检查接收到的33位字中“1”的数量是否仍为偶数来检测错误。\n- 如果翻转的比特总数为奇数（例如1, 3, 5...），则接收到的字中“1”的数量将变为奇数，错误被**检测到**。\n- 如果翻转的比特总数为非零偶数（例如2, 4, 6...），则接收到的字中“1”的数量将仍为偶数，错误**未被检测到**。\n\n**第二步：根据近似分析错误机制**\n问题规定忽略所有 $p^2$, $pq$ 和 $q^2$ 阶的项。这等同于假设在单次传输中最多发生一个错误事件（即一次单线位翻转或一次耦合双线翻转）。\n\n1.  **单线位翻转**：此事件翻转1个比特。因为1是奇数，所以这种类型的错误总是能被偶校验**检测到**。因此，它对未被检测到的错误概率没有贡献。\n2.  **耦合双线同时翻转**：此事件同时翻转2个比特。因为2是偶数，所以这种类型的错误总是**未被检测到**。\n\n根据稀有事件近似，唯一能导致未被检测到的错误的事件类型是单个“耦合双线同时翻转”事件。\n\n**第三步：计算未被检测到错误的总概率**\n未被检测到错误的总概率是在所有可能位置上发生一次耦合双线翻转事件的概率之和。\n- 总共有33根导线（$D_{0}, \\ldots, D_{31}, P$）呈线性排列。\n- 相邻导线的对数为 $33 - 1 = 32$ 对。\n- 每个相邻对发生耦合翻转的概率为 $q$。\n\n设 $U$ 为发生未被检测到错误的事件。在所给的近似下，这等同于在32个相邻对中的任意一个上发生耦合翻转的事件的并集。由于这些事件的概率（$q$）很小，并且我们忽略了 $q^2$ 阶的项，我们可以将并集的概率近似为各个事件概率的总和：\n$$ P(U) \\approx \\sum_{i=1}^{32} P(\\text{第 } i \\text{ 对发生耦合翻转}) $$\n$$ P(U) \\approx 32 \\times q $$\n\n**第四步：代入数值并计算**\n将给定的值 $q = 3.0 \\times 10^{-8}$ 代入公式：\n$$ P(U) \\approx 32 \\times (3.0 \\times 10^{-8}) = 96 \\times 10^{-8} $$\n将结果转换为标准的科学记数法：\n$$ P(U) \\approx 9.6 \\times 10^{-7} $$\n\n**第五步：格式化输出**\n根据要求，结果需要以科学记数法表示并四舍五入到四位有效数字。\n$$ 9.600 \\times 10^{-7} $$", "answer": "$$\\boxed{9.600 \\times 10^{-7}}$$", "id": "3640110"}, {"introduction": "检测到错误只是成功了一半，系统还必须能够优雅地从中恢复。最后一个练习 [@problem_id:3640136] 将我们的焦点从错误*检测*转移到系统级的错误*处理*。你将设计一个微码例程来管理缓存奇偶校验错误，并关键地量化此恢复过程对性能的影响，从而将低级硬件故障与其对处理器整体吞吐量的高级影响联系起来。", "problem": "一个中央处理器（CPU）对每一条一级数据缓存（L1 DC）行实现奇校验错误检测。当在数据读取过程中检测到奇偶校验错误时，控制权转移到一个微码例程。请仅使用核心定义和关于性能指标与期望的经过充分检验的事实，为该奇偶校验错误提出一个科学上现实的微码服务序列，并推导其对吞吐量的影响。以下条件得到保证：\n\n- 数据缓存访问会触发对存储在缓存行旁边的奇偶校验位的检查；该检查会检测到任何单位错误。\n- 在读取时检测到错误后，微码必须防止架构上可见的损坏，从较低级别恢复一个干净的缓存行，并通过重放故障指令来恢复执行。\n- 流水线支持刷新与重放，并且缓存层次结构拥有一个二级（L2）缓存和主存。\n\n对于您的序列，假设处理奇偶校验错误的每个阶段的周期成本如下：\n\n- 流水线刷新成本为 $F = 15$ 个周期。\n- 缓存行重填是源的平均值：缓存行由 L2 缓存提供的概率为 $q = 0.9$，延迟为 $\\ell_{2} = 12$ 个周期；必须从主存获取的概率为 $1 - q = 0.1$，延迟为 $\\ell_{m} = 200$ 个周期。\n- 微码中的异常记录和状态管理成本为 $E = 40$ 个周期。\n- 重放故障指令的成本为 $X = 4$ 个周期。\n\n假设在固定时钟频率下，稳态时的基准每指令周期数（CPI）为 $CPI_{0} = 1.2$，并且一条指令访问数据缓存的概率为 $p = 0.35$（此估算中每条指令最多一次数据访问）。令 $r$ 表示每次数据缓存访问的奇偶校验错误率，其中 $0 \\le r \\ll 1$。使用定义 $\\text{每周期指令数 (IPC)} = \\frac{\\text{指令数}}{\\text{周期数}}$ 和 $\\text{每指令周期数 (CPI)} = \\frac{\\text{周期数}}{\\text{指令数}}$，在固定频率下有 $IPC = \\frac{1}{CPI}$，以及每指令开销的期望线性性。\n\n任务：\n\n- 提出了一个逻辑上有序的微码例程，该例程刷新流水线、重填缓存行、执行异常处理并重放指令，其方式能够防止损坏数据的传播并保持架构状态。\n- 使用给定的周期成本和上述定义，推导归一化吞吐量 $T(r)$ 的闭式表达式，该吞吐量定义为存在奇偶校验错误时的有效 $IPC$ 与无错误时的基准 $IPC$ 之比，并且仅是 $r$ 的函数。将您的最终答案表示为关于 $r$ 的单个解析表达式。\n\n无需四舍五入。最终表达式中不包含任何单位。", "solution": "首先验证问题是科学上成立的、良态的、客观的和完整的。所有有效问题的条件都已满足，可以推导出完整的解决方案。\n\n解决方案按要求分为两部分：首先，为奇偶校验错误提出一个逻辑上的微码服务序列；其次，推导归一化吞吐量作为错误率 $r$ 的函数。\n\n**第一部分：微码服务序列**\n\n在从一级数据缓存（L1 DC）读取数据期间检测到奇偶校验错误后，微码必须协调一个恢复序列，以满足三个主要目标：防止损坏数据的传播、恢复数据的正确副本以及恢复正常执行。一个逻辑上合理且最简的操作序列如下：\n\n1.  **流水线刷新**：一旦检测到错误，必须立即刷新处理器流水线。此操作会丢弃故障指令和任何后续推测执行的指令。这是关键的第一步，以防止从缓存中读取的损坏数据被写入架构寄存器或以其他方式影响处理器的架构状态。此操作的成本为 $F = 15$ 个周期。\n\n2.  **异常记录和状态管理**：在停止推测执行后，微码例程接管控制。它必须记录奇偶校验错误的发生，通常记录在机器检查寄存器中。这为系统可靠性分析提供了诊断信息。此阶段还包括为数据恢复做准备所需的任何状态管理。此操作的成本为 $E = 40$ 个周期。\n\n3.  **缓存行重填**：微码使包含损坏数据的 L1 DC 行无效。然后，它向内存层次结构的下一级发起读取请求，以获取该行的干净副本。此请求由二级（L2）缓存或主存提供服务。系统在等待数据返回并写入 L1 DC 时暂停。此操作确保了数据完整性的恢复。其延迟是概率性的。\n\n4.  **指令重放**：一旦 L1 DC 中有了正确的数据，微码通过重新发起最初导致故障的指令，将控制权交还给程序。由于流水线已被刷新，该指令被重新获取并重新开始执行。这一次，数据缓存访问将使用正确的数据成功完成。与重放机制相关的成本为 $X = 4$ 个周期。\n\n处理单个奇偶校验错误的总周期惩罚（表示为 $C_{\\text{penalty}}$）是这些顺序阶段成本的总和。缓存行重填阶段的延迟是一个必须计算的平均值 $\\bar{\\ell}$。\n\n**第二部分：归一化吞吐量 $T(r)$ 的推导**\n\n推导过程首先计算每次错误的总周期惩罚，然后确定其对有效每指令周期数（CPI）的影响，最后表示归一化吞吐量。\n\n首先，我们使用全期望定律以及给定的概率和延迟来计算平均缓存行重填延迟 $\\bar{\\ell}$。\n缓存行由 L2 缓存提供的概率为 $q = 0.9$，延迟为 $\\ell_{2} = 12$ 个周期。\n缓存行由主存提供的概率为 $1 - q = 0.1$，延迟为 $\\ell_{m} = 200$ 个周期。\n$$\n\\bar{\\ell} = q \\cdot \\ell_{2} + (1 - q) \\cdot \\ell_{m}\n$$\n代入给定值：\n$$\n\\bar{\\ell} = (0.9)(12) + (0.1)(200) = 10.8 + 20 = 30.8 \\text{ 周期}\n$$\n一次奇偶校验错误事件的总周期惩罚 $C_{\\text{penalty}}$ 是顺序恢复阶段成本的总和：\n$$\nC_{\\text{penalty}} = F + E + \\bar{\\ell} + X\n$$\n代入已知值：\n$$\nC_{\\text{penalty}} = 15 + 40 + 30.8 + 4 = 89.8 \\text{ 周期}\n$$\n接下来，我们确定有效 CPI，表示为 $CPI_{\\text{eff}}$。无错误时的基准 CPI 为 $CPI_{0} = 1.2$。有效 CPI 是基准 CPI 加上由奇偶校验错误引起的每指令平均周期开销。\n\n一条指令仅当它访问数据缓存并且在该访问上发生奇偶校验错误时，才会产生此惩罚。\n给定指令访问数据缓存的概率为 $p = 0.35$。\n每次数据缓存访问发生奇偶校验错误的概率为 $r$。\n假设这些事件是独立的，任何给定指令触发奇偶校验错误的概率是乘积 $p \\cdot r$。\n\n每指令的期望周期开销是单次错误的总结惩罚乘以每指令发生错误的概率：\n$$\n\\text{Overhead}_{\\text{cycles/instruction}} = C_{\\text{penalty}} \\cdot (p \\cdot r)\n$$\n有效 CPI 则为：\n$$\nCPI_{\\text{eff}}(r) = CPI_{0} + \\text{Overhead}_{\\text{cycles/instruction}} = CPI_{0} + C_{\\text{penalty}} \\cdot p \\cdot r\n$$\n归一化吞吐量 $T(r)$ 定义为有效每周期指令数（$IPC_{\\text{eff}}$）与基准 IPC（$IPC_{0}$）之比。使用关系 $IPC = \\frac{1}{CPI}$：\n$$\nT(r) = \\frac{IPC_{\\text{eff}}}{IPC_{0}} = \\frac{1/CPI_{\\text{eff}}(r)}{1/CPI_{0}} = \\frac{CPI_{0}}{CPI_{\\text{eff}}(r)}\n$$\n代入 $CPI_{\\text{eff}}(r)$ 的表达式：\n$$\nT(r) = \\frac{CPI_{0}}{CPI_{0} + C_{\\text{penalty}} \\cdot p \\cdot r}\n$$\n这个表达式可以重新排列以分离对 $r$ 的依赖关系：\n$$\nT(r) = \\frac{1}{1 + \\left(\\frac{C_{\\text{penalty}} \\cdot p}{CPI_{0}}\\right) r}\n$$\n现在，我们将数值代入 $r$ 的系数中：\n$CPI_{0} = 1.2 = \\frac{6}{5}$\n$p = 0.35 = \\frac{7}{20}$\n$C_{\\text{penalty}} = 89.8 = \\frac{898}{10} = \\frac{449}{5}$\n系数为：\n$$\n\\frac{C_{\\text{penalty}} \\cdot p}{CPI_{0}} = \\frac{\\left(\\frac{449}{5}\\right) \\cdot \\left(\\frac{7}{20}\\right)}{\\frac{6}{5}} = \\frac{449 \\cdot 7}{5 \\cdot 20} \\cdot \\frac{5}{6} = \\frac{449 \\cdot 7}{20 \\cdot 6} = \\frac{3143}{120}\n$$\n因此，归一化吞吐量 $T(r)$ 的最终闭式表达式为：\n$$\nT(r) = \\frac{1}{1 + \\frac{3143}{120} r}\n$$", "answer": "$$\n\\boxed{\\frac{1}{1 + \\frac{3143}{120} r}}\n$$", "id": "3640136"}]}