{"hands_on_practices": [{"introduction": "新兴存储技术的一个核心优势是其非易失性，这意味着断电后数据依然能被保存。本练习将此特性置于一个实际的工程场景中：设计一个能够从突然断电中恢复的容灾系统。通过从第一性原理出发，定量分析使用传统DRAM加电池备份方案来维持数据所需要的能耗，你将为评估和理解PCM等非易失性存储器带来的能效优势打下坚实的基础 [@problem_id:3638958]。", "problem": "一个服务器级系统必须具备容错能力，通过确保主内存的内容在突然断电后能够得以保存，直到可以进行有序恢复。两种设计方案正在讨论中：电池备用的动态随机存取存储器 (DRAM) 和相变存储器 (PCM)。DRAM 需要持续的能量来保存数据（通过刷新），而 PCM 是非易失性的，不需要能量来被动地保存数据。仅使用电荷、电压、功率和能量之间的基本关系，推导出一个表达式，用于计算在 DRAM 中为大小为 $S$ 字节的任意内存占用提供保存时间 $t$ 所需的电池能量，然后为指定的系统进行数值计算。\n\n假设与参数：\n- DRAM 子系统在电源电压 $V_{\\text{DRAM}}$ 下运行，每个比特需要以周期 $T_{\\text{ref}}$ 进行周期性刷新。将刷新过程建模为在每个刷新间隔内，每比特从电源汲取有效电荷 $q_{r}$。这个集总参数 $q_{r}$ 包含了在刷新一个存储比特期间读出放大器和外围电路切换所消耗的电荷。\n- 在保存期间，DRAM 内存控制器和保存管理逻辑消耗近似恒定的功率 $P_{\\text{ctl}}$，该功率与 $S$ 无关。\n- 电池通过效率为 $\\eta$ (其中 $0\\eta\\leq 1$) 的稳压器向 DRAM 负载提供能量。所需的电池能量等于负载能量除以 $\\eta$。\n- 假设在所考虑的时间尺度上，相变存储器 (PCM) 是完全非易失性的，因此其数据保存需要零能量；你可以在推导中定性地使用这一事实，但必须仅计算 DRAM 情况下的电池能量。\n- 使用 1 吉字节 (GB) 等于 $10^{9}$ 字节的定义。\n\n任务：\n1. 从第一性原理出发，用 $S$、$q_{r}$ 和 $T_{\\text{ref}}$ 表示 DRAM 刷新电流。由此推导出 DRAM 刷新功率，然后推导出包含 $P_{\\text{ctl}}$ 的 DRAM 总负载功率。最后，推导出在时间 $t$ 内所需电池能量 $E_{\\text{battery}}(S,t)$ 的闭式表达式，用 $S$、$V_{\\text{DRAM}}$、$q_{r}$、$T_{\\text{ref}}$、$P_{\\text{ctl}}$ 和 $\\eta$ 表示。\n2. 对以下数值进行数值计算：\n   - $S = 16 \\times 10^{9}$ 字节,\n   - $t = 2 \\text{ 小时}$,\n   - $V_{\\text{DRAM}} = 1.2 \\text{ V}$,\n   - $q_{r} = 4.0 \\times 10^{-13} \\text{ 库仑/比特/刷新}$,\n   - $T_{\\text{ref}} = 64 \\times 10^{-3} \\text{ 秒}$,\n   - $P_{\\text{ctl}} = 0.20 \\text{ 瓦}$,\n   - $\\eta = 0.90$.\n以 kJ 为单位表示最终能量，并将答案四舍五入到四位有效数字。\n\n你的最终答案必须是一个实数值，对应于在所述参数下 DRAM 情况所需的电池能量，以 kJ 为单位表示。请勿在最终的方框答案中包含任何单位。", "solution": "问题陈述被认为是有效的，因为它科学地基于电学和计算机体系结构的基本原理，是良定的，所有必要的参数都已定义，并且使用客观、正式的语言表述。不存在会使问题无效的矛盾、歧义或不切实际的假设。\n\n解决方案按要求分为两部分：首先，推导电池能量的符号表达式；其次，对其进行数值计算。\n\n第一部分：电池能量表达式 $E_{\\text{battery}}(S, t)$ 的推导。\n\n大小为 $S$ 字节的内存中的比特总数 $N_{\\text{bits}}$ 由下式给出：\n$$N_{\\text{bits}} = 8 S$$\n这源于一个字节等于 8 比特的标准定义。\n\n问题指明，在每个刷新周期 $T_{\\text{ref}}$ 内，每个比特会汲取有效电荷 $q_{r}$。因此，刷新整个存储阵列一次从电源汲取的总电荷为：\n$$Q_{\\text{total\\_ref}} = N_{\\text{bits}} \\times q_{r} = 8 S q_{r}$$\n\n电流是电荷的流速，$I = \\frac{dQ}{dt}$。对于周期性过程，平均电流是每个周期传输的总电荷除以周期时长。因此，DRAM 刷新所需的平均电流 $I_{\\text{DRAM\\_ref}}$ 为：\n$$I_{\\text{DRAM\\_ref}} = \\frac{Q_{\\text{total\\_ref}}}{T_{\\text{ref}}} = \\frac{8 S q_{r}}{T_{\\text{ref}}}$$\n\n电功率是电压和电流的乘积，$P = V I$。DRAM 单元专用于刷新操作所消耗的功率 $P_{\\text{DRAM\\_ref}}$ 是刷新电流和 DRAM 电源电压 $V_{\\text{DRAM}}$ 的乘积：\n$$P_{\\text{DRAM\\_ref}} = V_{\\text{DRAM}} I_{\\text{DRAM\\_ref}} = \\frac{8 S q_{r} V_{\\text{DRAM}}}{T_{\\text{ref}}}$$\n\n电池必须支持的负载所消耗的总功率 $P_{\\text{load}}$ 是 DRAM 刷新功率与内存控制器及其相关保存逻辑所消耗的恒定功率 $P_{\\text{ctl}}$ 之和。\n$$P_{\\text{load}} = P_{\\text{DRAM\\_ref}} + P_{\\text{ctl}} = \\frac{8 S q_{r} V_{\\text{DRAM}}}{T_{\\text{ref}}} + P_{\\text{ctl}}$$\n\n能量是功率对时间的积分。由于总负载功率 $P_{\\text{load}}$ 在保存间隔 $t$ 内是恒定的，因此负载消耗的总能量 $E_{\\text{load}}$ 是该功率与时间长度的乘积：\n$$E_{\\text{load}} = P_{\\text{load}} \\times t = \\left( \\frac{8 S q_{r} V_{\\text{DRAM}}}{T_{\\text{ref}}} + P_{\\text{ctl}} \\right) t$$\n\n该负载由电池通过效率为 $\\eta$ 的稳压器供电。效率是输出功率（或能量）与输入功率（或能量）之比，即 $\\eta = \\frac{E_{\\text{load}}}{E_{\\text{battery}}}$。因此，电池必须提供的能量 $E_{\\text{battery}}$ 是负载能量除以效率：\n$$E_{\\text{battery}} = \\frac{E_{\\text{load}}}{\\eta}$$\n代入 $E_{\\text{load}}$ 的表达式，得到所需电池能量作为内存大小 $S$ 和保存时间 $t$ 的函数的最终闭式表达式：\n$$E_{\\text{battery}}(S, t) = \\frac{t}{\\eta} \\left( \\frac{8 S q_{r} V_{\\text{DRAM}}}{T_{\\text{ref}}} + P_{\\text{ctl}} \\right)$$\n\n第二部分：数值计算。\n\n现在我们将提供的数值代入推导出的表达式中。我们必须确保所有单位一致（国际单位制单位）。\n给定的参数如下：\n$S = 16 \\times 10^{9}$ 字节\n$t = 2 \\text{ 小时} = 2 \\times 3600 \\text{ s} = 7200 \\text{ s}$\n$V_{\\text{DRAM}} = 1.2 \\text{ V}$\n$q_{r} = 4.0 \\times 10^{-13} \\text{ C}$ 每比特每次刷新\n$T_{\\text{ref}} = 64 \\times 10^{-3} \\text{ s}$\n$P_{\\text{ctl}} = 0.20 \\text{ W}$\n$\\eta = 0.90$\n\n首先，我们计算 DRAM 刷新功率 $P_{\\text{DRAM\\_ref}}$：\n$$P_{\\text{DRAM\\_ref}} = \\frac{8 \\times (16 \\times 10^{9} \\text{ bytes}) \\times (4.0 \\times 10^{-13} \\text{ C/bit}) \\times (1.2 \\text{ V})}{64 \\times 10^{-3} \\text{ s}}$$\n因子 8 正确地将字节转换为比特。\n$$P_{\\text{DRAM\\_ref}} = \\frac{(128 \\times 10^{9}) \\times (4.0 \\times 10^{-13}) \\times 1.2}{64 \\times 10^{-3}} \\text{ W}$$\n$$P_{\\text{DRAM\\_ref}} = \\frac{51.2 \\times 10^{-2} \\times 1.2}{64 \\times 10^{-3}} \\text{ W} = \\frac{61.44 \\times 10^{-2}}{64 \\times 10^{-3}} \\text{ W}$$\n$$P_{\\text{DRAM\\_ref}} = 0.96 \\text{ W}$$\n\n接下来，我们计算总负载功率 $P_{\\text{load}}$：\n$$P_{\\text{load}} = P_{\\text{DRAM\\_ref}} + P_{\\text{ctl}} = 0.96 \\text{ W} + 0.20 \\text{ W} = 1.16 \\text{ W}$$\n\n现在，我们可以计算所需的总电池能量 $E_{\\text{battery}}$，单位为焦耳：\n$$E_{\\text{battery}} = \\frac{P_{\\text{load}} \\times t}{\\eta} = \\frac{1.16 \\text{ W} \\times 7200 \\text{ s}}{0.90} \\text{ J}$$\n$$E_{\\text{battery}} = \\frac{8352}{0.90} \\text{ J} = 9280 \\text{ J}$$\n\n问题要求最终答案以千焦 (kJ) 为单位。\n$$E_{\\text{battery}} = 9280 \\text{ J} \\times \\frac{1 \\text{ kJ}}{1000 \\text{ J}} = 9.280 \\text{ kJ}$$\n该值已按要求表示为四位有效数字。", "answer": "$$\\boxed{9.280}$$", "id": "3638958"}, {"introduction": "虽然非易失性带来了显著优势，但新兴存储技术也伴随着独特的挑战，其中最主要的就是有限的写入寿命。为了使这些技术在实际系统中可用，架构师们设计了磨损均衡（wear-leveling）等关键技术来延长存储器的使用寿命。这个练习模拟了一种具体的硬件磨损均衡方案，并要求你计算其预期寿命，从而将底层的器件物理特性与上层的系统可靠性联系起来 [@problem_id:3638977]。", "problem": "一个三级（L3）缓存使用相变存储器（PCM）实现。由于PCM单元的写耐久度有限，系统采用一个硬件磨损均衡环，将单个逻辑缓存行托管在多个物理PCM行上。该环使用 $M$ 个物理行，并每隔一个轮换周期 $p$ 秒轮换一次活动主机行。当环轮换时，大小为 $B$ 字节的逻辑缓存行的当前内容会以每次编程操作 $g$ 字节的写入粒度迁移到新的活动物理行。此外，每次轮换都会在目标行上更新映射元数据，这会产生 $m$ 次编程操作。在活动期间，逻辑缓存行以每秒 $\\lambda$ 次编程操作的速率接收一个稳定的写入流。读取操作不会造成磨损。每个物理PCM行在累积 $N_{\\text{end}}$ 次编程操作后会失效。\n\n假设环的轮换是完全周期性的，工作负载和轮换是独立且稳定的，并且每个物理行在每个周期内恰好活动 $p$ 秒。将每次编程操作（包括迁移和元数据更新）视为一个相等的磨损单位。在这些条件下，确定单个物理行的预期寿命，以年为单位表示。\n\n使用以下参数：\n- 每个物理行的耐久度 $N_{\\text{end}} = 3.0 \\times 10^8$ 次编程操作。\n- 环的大小 $M = 64$。\n- 轮换周期 $p = 1.0$ 秒。\n- 逻辑行大小 $B = 64$ 字节。\n- 写入粒度 $g = 8$ 字节/编程操作。\n- 每次轮换的元数据更新成本 $m = 2$ 次编程操作。\n- 活动行的写入速率 $\\lambda = 50$ 次编程操作/秒。\n\n将最终答案四舍五入到四位有效数字。每年使用 $365$ 天，并以年为单位表示寿命。", "solution": "该问题的目标是确定在给定的磨损均衡方案下，单个物理PCM行的预期寿命。为此，我们首先需要计算单个物理行承受的平均编程操作速率（即平均磨损率）。\n\n系统的磨损均衡环由 $M$ 个物理行组成，活动状态在这些行之间轮换。每个行活动 $p$ 秒，然后环旋转到下一个行。因此，一个完整的轮换周期（即环中的每个行都活动过一次）的总持续时间 $T_{\\text{cycle}}$ 为：\n$$T_{\\text{cycle}} = M \\times p$$\n\n在一个完整的轮换周期内，一个特定的物理行仅在其作为活动主机的那 $p$ 秒内以及轮换开始时承受磨损。我们将此周期内该行的总磨损 $W_{\\text{cycle}}$ 分解为三个部分：\n1.  **数据迁移磨损 ($W_{\\text{mig}}$)**：当该行变为活动状态时，大小为 $B$ 字节的逻辑缓存行内容会以 $g$ 字节/编程操作的粒度写入该行。因此：\n    $$W_{\\text{mig}} = \\frac{B}{g}$$\n2.  **元数据更新磨损 ($W_{\\text{meta}}$)**：每次轮换还会导致 $m$ 次编程操作来更新新活动行上的元数据。\n    $$W_{\\text{meta}} = m$$\n3.  **活动工作负载磨损 ($W_{\\text{active}}$)**：在该行活动的 $p$ 秒内，它以每秒 $\\lambda$ 次编程操作的速率接收写入流。\n    $$W_{\\text{active}} = \\lambda \\times p$$\n\n将这三部分相加，得到单个物理行在一个完整轮换周期内累积的总编程操作次数：\n$$W_{\\text{cycle}} = W_{\\text{mig}} + W_{\\text{meta}} + W_{\\text{active}} = \\frac{B}{g} + m + \\lambda p$$\n\n单个物理行的平均磨损率 $R_{\\text{wear}}$ 就是每个周期的总磨损除以周期的总持续时间：\n$$R_{\\text{wear}} = \\frac{W_{\\text{cycle}}}{T_{\\text{cycle}}} = \\frac{\\frac{B}{g} + m + \\lambda p}{Mp}$$\n\n最后，该行的预期寿命 $L_{\\text{sec}}$（以秒为单位）是其总耐久度 $N_{\\text{end}}$ 除以平均磨损率：\n$$L_{\\text{sec}} = \\frac{N_{\\text{end}}}{R_{\\text{wear}}} = \\frac{N_{\\text{end}} \\cdot Mp}{\\frac{B}{g} + m + \\lambda p}$$\n\n现在，我们代入给定的数值进行计算：\n- $N_{\\text{end}} = 3.0 \\times 10^8$ 次编程操作\n- $M = 64$\n- $p = 1.0$ 秒\n- $B = 64$ 字节\n- $g = 8$ 字节/编程操作\n- $m = 2$ 次编程操作\n- $\\lambda = 50$ 次编程操作/秒\n\n首先，计算一个轮换周期内的总磨损 $W_{\\text{cycle}}$：\n$$W_{\\text{cycle}} = \\frac{64}{8} + 2 + (50 \\times 1.0) = 8 + 2 + 50 = 60 \\text{ 次编程操作}$$\n\n完整轮换周期的持续时间 $T_{\\text{cycle}}$ 为：\n$$T_{\\text{cycle}} = 64 \\times 1.0 \\text{ s} = 64 \\text{ s}$$\n\n平均磨损率 $R_{\\text{wear}}$ 为：\n$$R_{\\text{wear}} = \\frac{60 \\text{ 次编程操作}}{64 \\text{ s}} = 0.9375 \\text{ 次编程操作/秒}$$\n\n该行的寿命（以秒为单位）为：\n$$L_{\\text{sec}} = \\frac{3.0 \\times 10^8 \\text{ 次编程操作}}{0.9375 \\text{ 次编程操作/秒}} = 3.2 \\times 10^8 \\text{ 秒}$$\n\n最后，将寿命从秒转换为年。每年有 $365 \\times 24 \\times 60 \\times 60 = 31,536,000$ 秒。\n$$L_{\\text{years}} = \\frac{3.2 \\times 10^8 \\text{ s}}{31,536,000 \\text{ s/年}} \\approx 10.1471334 \\text{ 年}$$\n\n按要求四舍五入到四位有效数字，得到：\n$$L_{\\text{years}} \\approx 10.15 \\text{ 年}$$", "answer": "$$\n\\boxed{10.15}\n$$", "id": "3638977"}, {"introduction": "除了写入寿命，高昂的写入能耗是另一个需要重点关注的特性。因此，面向新兴存储器的系统优化通常意味着要尽可能地减少写入操作。本练习在缓存替换策略的层面上探讨了这一思想，通过比较标准的LRU策略和一种优先淘汰“干净”缓存行的“写入感知”策略，展示了系统级决策如何与存储特性协同设计，以优化能耗这一关键指标 [@problem_id:3638905]。", "problem": "一款多核处理器使用了一个共享的、组相联的、写回式二级 (L2) 缓存。其主存采用相变存储器 (PCM) 实现，这是一种新兴的非易失性存储器，其行写入能耗远高于行读取能耗。正在考虑两种用于 L2 缓存的候选替换策略：基准的最近最少使用 (LRU) 策略，以及一种感知写入的“清洁优先”变体，该变体在可能的情况下倾向于驱逐清洁缓存行。这两种策略在一个代表性的稳态工作负载下进行了性能分析，得到了以下每次驱逐的统计数据：\n\n- 在最近最少使用 (LRU) 策略下：被驱逐的缓存行为脏的概率是 $0.55$，且如果该缓存行未被驱逐，其将被重新引用的概率是 $0.18$。\n- 在感知写入的策略下：被驱逐的缓存行为脏的概率是 $0.25$，且如果该缓存行未被驱逐，其将被重新引用的概率是 $0.31$。\n\n假设该系统中主存流量的每行能耗成本如下，这反映了 PCM 的特性：\n- 每次从 L2 中驱逐脏行都会导致一次对主存的写回，成本为 $18 \\text{ nJ}$。\n- 每次被驱逐后又被重新引用的缓存行（无论被驱逐的行是清洁的还是脏的）都会引发一次从主存的额外行读取，成本为 $3.6 \\text{ nJ}$。\n\n将脏行写回和后续重用读取的成本视为对每次驱逐总期望能耗的加性贡献，并假设给定概率是平稳的。仅使用关于互斥和/或重叠事件的期望值定义以及期望的线性性质，确定这两种策略中每次驱逐的最小期望能耗成本。最终答案以 $\\text{nJ}$ 为单位表示，并四舍五入到四位有效数字。最终答案必须是一个实数。", "solution": "问题要求计算在两种不同的替换策略下，L2 缓存每次驱逐的最小期望能耗成本：最近最少使用 (LRU) 策略和一种感知写入的变体。主存是相变存储器 (PCM)，其写入操作的能耗很高。每次驱逐的总期望能耗成本是需要最小化的量。\n\n我们来定义单次缓存行驱逐的相关事件和能耗成本：\n-   设 $D$ 为被驱逐的缓存行为脏行的事件。如果此事件发生，则需要将其写回到主存。\n-   设 $R$ 为被驱逐的缓存行在未被驱逐的情况下会被重新引用的事件。如果此事件发生，则需要从主存进行一次后续读取。\n-   脏行驱逐的写回能耗成本为 $E_{\\text{write}} = 18 \\text{ nJ}$。\n-   重新引用的缓存行的读取能耗成本为 $E_{\\text{read}} = 3.6 \\text{ nJ}$。\n\n单次驱逐的总能耗成本 $E_{\\text{total}}$ 是写回（如果有）和重新引用读取（如果有）所消耗能量的总和。我们可以使用指示随机变量来表示这一点。设 $I_D$ 是一个指示随机变量，如果缓存行为脏行，其值为 $1$，否则为 $0$。设 $I_R$ 是一个指示随机变量，如果缓存行被重新引用，其值为 $1$，否则为 $0$。总能量是一个随机变量：\n$$E_{\\text{total}} = I_D \\cdot E_{\\text{write}} + I_R \\cdot E_{\\text{read}}$$\n我们关心的是每次驱逐的期望能耗成本，即 $E_{\\text{total}}$ 的期望值，记为 $E[E_{\\text{total}}]$。\n\n问题陈述指导我们使用期望的线性性质。该原理指出，随机变量之和的期望等于它们各自期望之和，无论这些变量是否独立。\n$$E[E_{\\text{total}}] = E[I_D \\cdot E_{\\text{write}} + I_R \\cdot E_{\\text{read}}]$$\n应用期望的线性性质：\n$$E[E_{\\text{total}}] = E[I_D \\cdot E_{\\text{write}}] + E[I_R \\cdot E_{\\text{read}}]$$\n由于 $E_{\\text{write}}$ 和 $E_{\\text{read}}$ 是常数，它们可以从期望中提取出来：\n$$E[E_{\\text{total}}] = E[I_D] \\cdot E_{\\text{write}} + E[I_R] \\cdot E_{\\text{read}}$$\n指示随机变量的期望等于它所指示事件的概率。因此，$E[I_D] = P(D)$ 且 $E[I_R] = P(R)$。任何策略下每次驱逐的期望能耗成本公式为：\n$$E[\\text{Energy}] = P(D) \\cdot E_{\\text{write}} + P(R) \\cdot E_{\\text{read}}$$\n正如问题所要求的，该公式通过对每种事件类型的期望成本求和，正确地处理了重叠事件（即一个缓存行可以既是脏的又被重新引用）。现在，我们使用提供的统计数据，将此公式应用于这两种策略。\n\n对于最近最少使用 (LRU) 策略：\n给定的概率是：\n-   驱逐脏行的概率：$P(D_{\\text{LRU}}) = 0.55$\n-   重新引用被驱逐缓存行的概率：$P(R_{\\text{LRU}}) = 0.18$\n\nLRU 策略下每次驱逐的期望能耗成本 $E_{\\text{LRU}}$ 为：\n$$E_{\\text{LRU}} = P(D_{\\text{LRU}}) \\cdot E_{\\text{write}} + P(R_{\\text{LRU}}) \\cdot E_{\\text{read}}$$\n$$E_{\\text{LRU}} = (0.55) \\cdot (18 \\text{ nJ}) + (0.18) \\cdot (3.6 \\text{ nJ})$$\n$$E_{\\text{LRU}} = 9.9 \\text{ nJ} + 0.648 \\text{ nJ}$$\n$$E_{\\text{LRU}} = 10.548 \\text{ nJ}$$\n\n对于感知写入 (WA) 策略：\n给定的概率是：\n-   驱逐脏行的概率：$P(D_{\\text{WA}}) = 0.25$\n-   重新引用被驱逐缓存行的概率：$P(R_{\\text{WA}}) = 0.31$\n\n感知写入策略下每次驱逐的期望能耗成本 $E_{\\text{WA}}$ 为：\n$$E_{\\text{WA}} = P(D_{\\text{WA}}) \\cdot E_{\\text{write}} + P(R_{\\text{WA}}) \\cdot E_{\\text{read}}$$\n$$E_{\\text{WA}} = (0.25) \\cdot (18 \\text{ nJ}) + (0.31) \\cdot (3.6 \\text{ nJ})$$\n$$E_{\\text{WA}} = 4.5 \\text{ nJ} + 1.116 \\text{ nJ}$$\n$$E_{\\text{WA}} = 5.616 \\text{ nJ}$$\n\n最后，我们必须确定这两种策略中每次驱逐的最小期望能耗成本。我们比较计算出的期望能量：\n$$E_{\\text{LRU}} = 10.548 \\text{ nJ}$$\n$$E_{\\text{WA}} = 5.616 \\text{ nJ}$$\n最小期望能耗成本是这两个值中较小的一个：\n$$\\min(E_{\\text{LRU}}, E_{\\text{WA}}) = \\min(10.548, 5.616) = 5.616 \\text{ nJ}$$\n问题要求答案四舍五入到四位有效数字。值 $5.616$ 已经有四位有效数字。因此，不需要进一步的四舍五入。每次驱逐的最小期望能耗成本是 $5.616 \\text{ nJ}$。", "answer": "$$\\boxed{5.616}$$", "id": "3638905"}]}