{"hands_on_practices": [{"introduction": "现代CPU拥有极高准确率的分支预测器，因此人们可能直觉地认为，预测错误事件的罕见性不足以构成安全威胁。这项练习将挑战这一直觉，通过计算大量分支指令中预期发生的错误预测次数，您将具体理解为何即使是极高的预测准确率，也仍然为“幽灵”（Spectre）式攻击敞开了大门。这个计算揭示了攻击可行性的根本原因：在一个执行海量指令的系统中，小概率事件会频繁发生。[@problem_id:3679344]", "problem": "现代乱序执行中央处理器（CPU）使用动态分支预测来推测执行代码路径。在Spectre类型的瞬态执行攻击中，预测错误的分支可被利用来执行未经授权的瞬态内存访问，这些访问会调制微架构侧信道（例如，高速缓存），从而泄露信息。考虑一个简化的统计模型，其中遇到的每个条件分支都是一个独立的伯努利试验，其预测正确的概率为 $a$，预测错误的概率为 $1-a$。假设预测器具有平稳性，即在所考虑的范围内 $a$ 不会变化。\n\n给定分支预测器准确率 $a = 0.99$，以及一个由攻击者控制的循环执行的 $N = 10^{6}$ 条分支指令的范围。请仅使用基本概率定义和性质（例如，指示随机变量和期望的线性性），推导出在 $N$ 个分支中预测错误的期望数量，并计算其数值。无需进行四舍五入。\n\n然后，基于瞬态执行和基于高速缓存的侧信道的第一性原理，定性讨论在每个预测错误都可以在侧信道中驱动至少一个可靠的比特级信号的合理假设下，每 $10^{6}$ 个分支中如此的期望预测错误数量是否足以在Spectre类型的攻击中维持一个有意义的泄露带宽。你的讨论应基于科学推理，但不会改变所要求的数值答案。\n\n请将预测错误的期望数量作为你的最终答案。", "solution": "该问题在计算机体系结构和概率论方面有科学依据，内容自洽且问题良定，因此被认为是有效的。我们开始解答。\n\n问题要求计算在一个包含 $N$ 条条件分支指令的序列中，预测错误的期望数量。每个分支的预测被建模为一个独立的伯努利试验。\n\n设 $N$ 为该范围内分支指令的总数。给定 $N = 10^{6}$。\n设 $a$ 为分支预测正确的概率。给定 $a = 0.99$。\n因此，任何给定分支预测错误的概率为 $1 - a$。\n\n为了求出预测错误的总期望数量，我们将遵循指定的方法，使用指示随机变量和期望的线性性。\n\n让我们定义一组指示随机变量 $\\{X_1, X_2, \\dots, X_N\\}$。对于每个分支 $i \\in \\{1, 2, \\dots, N\\}$，随机变量 $X_i$ 定义如下：\n$$\nX_i = \n\\begin{cases} \n1  \\text{如果第 } i\\text{ 个分支预测错误} \\\\\n0  \\text{如果第 } i\\text{ 个分支预测正确}\n\\end{cases}\n$$\n根据定义，预测错误的概率是 $P(X_i = 1) = 1 - a$。预测正确的概率是 $P(X_i = 0) = a$。\n\n指示随机变量的期望值是它所指示事件的概率。对于任意 $i$，$X_i$ 的期望是：\n$$\nE[X_i] = (1 \\cdot P(X_i=1)) + (0 \\cdot P(X_i=0))\n$$\n$$\nE[X_i] = (1 \\cdot (1-a)) + (0 \\cdot a) = 1-a\n$$\n这对从 $1$ 到 $N$ 的所有 $i$ 都成立，因为我们假设分支预测的准确率是平稳的。\n\n设 $M$ 为 $N$ 个分支中预测错误的总数。$M$ 是各个指示随机变量的总和：\n$$\nM = \\sum_{i=1}^{N} X_i\n$$\n我们要求解 $M$ 的期望值，记为 $E[M]$。期望的一个基本性质是其线性性。随机变量之和的期望等于它们各自期望之和。无论这些随机变量是否独立，该性质都成立。\n$$\nE[M] = E\\left[\\sum_{i=1}^{N} X_i\\right] = \\sum_{i=1}^{N} E[X_i]\n$$\n由于对所有 $i$ 都有 $E[X_i] = 1-a$，我们可以将其代入求和式中：\n$$\nE[M] = \\sum_{i=1}^{N} (1-a)\n$$\n这是一个包含 $N$ 个相同项的和，因此可以简化为：\n$$\nE[M] = N(1-a)\n$$\n这个表达式给出了以分支总数 $N$ 和预测器准确率 $a$ 表示的预测错误的期望数量。\n\n现在，我们代入给定的数值：$N = 10^{6}$ 和 $a = 0.99$。\n预测错误的概率是 $1 - a = 1 - 0.99 = 0.01$。\n预测错误的期望数量是：\n$$\nE[M] = 10^{6} \\times (1 - 0.99) = 10^{6} \\times 0.01 = 10000\n$$\n因此，在一个包含 $10^{6}$ 条已执行分支指令的范围内，攻击者可以预期引发 $10000$ 次预测错误。\n\n问题的第二部分要求定性讨论这个数量是否足以在Spectre类型的攻击中维持一个有意义的泄露带宽。\n每百万个分支的期望预测错误数量是 $10000$ 次。Spectre攻击的原理是利用预测错误后瞬态执行的指令来访问秘密数据，并将该数据编码到微架构侧信道中，例如数据高速缓存的状态。问题中给出的假设是，每次预测错误可以驱动至少一个可靠的比特级信号。\n\n$10000$ 次瞬态执行窗口的期望计数对攻击者来说是巨大的资源。即使泄露一个秘密比特（例如，一个加密密钥的一位）需要多次预测错误来放大信号并克服系统噪声，这个数量也足够大。例如，如果攻击者需要 $100$ 个预测错误的瞬态路径才能高置信度地泄露一个比特，他们仍然可以期望泄露 $10000 / 100 = 100$ 比特的信息。这足以窃取像 $128$ 位或 $256$ 位加密密钥这样的敏感数据的全部或部分内容。\n\n此外，现代处理器每秒执行数十亿条指令。一个包含 $10^{6}$ 个分支的循环可以在非常短的时间内（毫秒量级，取决于时钟频率和循环体复杂度）执行完毕。因此，每 $10^{6}$ 个分支产生 $10000$ 次泄露机会的期望值可以转化为很高的每秒比特数据窃取速率。例如，如果该循环在 $100$ 毫秒（$0.1$ 秒）内运行，那么在此时间内实现 $100$ 比特的泄露将对应于 $100 \\text{ 比特} / 0.1 \\text{ 秒} = 1000$ 比特/秒（即 $1$ kbps）的泄露带宽。在安全领域，这是一个非常显著的泄露带宽，远远超过了从内存中窃取密钥、密码和其他敏感数据结构所必需的速率。\n\n总之，即使有非常准确的分支预测器（$99\\%$），现代CPU处理的指令量巨大，这意味着预测错误的绝对数量仍然很大。$10000$ 次期望预测错误的值足以维持Spectre类攻击所需的一个有意义且危险的泄露带宽。", "answer": "$$\n\\boxed{10000}\n$$", "id": "3679344"}, {"introduction": "推测执行漏洞的范畴超越了单纯的分支预测。本实践将带您探索一种不同的攻击向量，它与内存操作相关，被称为“推测性存储绕过”（speculative store bypass）。通过将攻击建模为一系列概率性事件，您将推导出成功窃取信息一次所需的预期尝试次数。这个过程不仅能加深您对这类攻击统计特性的理解，也揭示了内存消歧预测器在其中的关键作用。[@problem_id:3679357]", "problem": "中央处理器（CPU）的流水线可以在内存消歧预测器估计年轻加载和年长存储不发生地址冲突时，推测性地在年长存储之前发出年轻加载。考虑一种推测性存储绕过攻击场景（一类Spectre风格的漏洞），其中攻击者在多次独立的迭代中重复执行一段经过插桩的代码序列。在每次迭代中，必须发生四个事件才能通过微架构侧信道泄露一个瞬态值：(i) 一条控制流路径为加载打开一个推测窗口，其概率为 $m$，(ii) 年轻加载与年长存储的地址相同，其概率为 $a$，(iii) 内存消歧预测器导致绕过，其概率为 $P(\\text{bypass})=1-c$，其中 $c \\in [0,1]$ 是预测器对不存在依赖关系的置信度，以及 (iv) 侧信道编码和解码成功，其概率为 $q$。假设这些事件在迭代之间和迭代内部都是独立的，并且每次迭代的结果构成一次“泄露”与“不泄露”的单一伯努利试验。\n\n从独立事件的基本概率法则和几何分布关于首次成功所需试验次数的均值定义出发，推导出一个封闭形式的解析表达式，用以表示观察到一次瞬态泄露所需的预期攻击迭代次数。将您的最终答案表示为关于 $m$、$a$、$c$ 和 $q$ 的单一简化表达式。无需四舍五入，所报告的量没有物理单位。", "solution": "该问题陈述已经过验证，被认为是科学上可靠、定义明确且客观的。它提供了一个简化但概念上合理的推测性存储绕过攻击的概率模型，这是一种现代处理器中已知的侧信道漏洞。所有必要的参数都已定义，并且明确陈述了独立性和伯努利试验的假设，从而可以得出一个严谨且唯一的解。\n\n问题要求计算观察到首次瞬态泄露所需的预期迭代次数。根据问题陈述，每次攻击迭代都是一次独立的伯努利试验，其中“成功”定义为发生一次瞬态泄露。在一系列独立的伯努利试验中，首次成功所需的试验次数 $N$ 服从几何分布。\n\n设 $p$ 为单次迭代中成功（即发生泄露）的概率。几何分布的概率质量函数由 $P(N=k) = (1-p)^{k-1}p$ 给出，其中 $k = 1, 2, 3, \\dots$。一个服从几何分布的随机变量 $N$ 的期望值或均值由下式给出：\n$$\nE[N] = \\frac{1}{p}\n$$\n我们的任务是首先确定单次迭代中发生泄露的概率 $p$。当且仅当四个特定的独立事件在同一次迭代中全部发生时，才会发生泄露。我们将这些事件表示如下：\n1.  $E_m$: 控制流路径打开一个推测窗口。该事件的概率为 $P(E_m) = m$。\n2.  $E_a$: 年轻加载和年长存储指令发生地址冲突（指向同一内存地址）。该事件的概率为 $P(E_a) = a$。\n3.  $E_b$: 内存消歧预测器错误地导致绕过，允许加载在存储之前推测性执行。该事件的概率为 $P(E_b) = P(\\text{bypass}) = 1-c$。\n4.  $E_q$: 侧信道编码和解码过程成功传输了瞬态数据。该事件的概率为 $P(E_q) = q$。\n\n由于问题陈述这些事件是独立的，因此单次迭代中发生泄露的概率 $p$ 是这些单个事件概率的乘积。\n$$\np = P(E_m \\cap E_a \\cap E_b \\cap E_q)\n$$\n根据独立性，这变为：\n$$\np = P(E_m) \\cdot P(E_a) \\cdot P(E_b) \\cdot P(E_q)\n$$\n代入给定的概率：\n$$\np = m \\cdot a \\cdot (1-c) \\cdot q\n$$\n这个表达式 $p = maq(1-c)$ 代表了在任意单次攻击迭代中成功泄露的概率。\n\n现在，我们可以通过将 $p$ 的表达式代入几何分布的均值公式，来求出首次泄露所需的预期迭代次数 $E[N]$。\n$$\nE[N] = \\frac{1}{p} = \\frac{1}{maq(1-c)}\n$$\n这就是观察到一次瞬态泄露所需的预期攻击迭代次数的封闭形式解析表达式，用给定的参数 $m$、$a$、$c$ 和 $q$ 表示。", "answer": "$$\n\\boxed{\\frac{1}{maq(1-c)}}\n$$", "id": "3679357"}, {"introduction": "保护处理器免受推测执行攻击并非没有代价，它常常以牺牲性能为前提。这项练习让您能够量化这种权衡关系，通过建模分析一种常见的缓解措施——引入推测屏障（speculation fences）——所导致的性能下降。您将推导出一个解析表达式，它直接将缓解措施的频率与性能损失（以每周期指令数 $IPC$ 的降低来衡量）联系起来，这正是现代计算机体系结构设计中面临的核心挑战之一。[@problem_id:3679423]", "problem": "考虑一个简化的乱序 (OoO) 超标量处理器核心，用于缓解 Spectre 类推测执行漏洞。该核心的最大提交宽度为每周期 $w$ 条指令。一次分支预测错误会产生 $p$ 个周期的恢复惩罚，在此期间没有指令退役。作为一种缓解措施，系统在每次加载指令后立即插入一个推测栅栏（例如，加载栅栏），以防止更晚的指令越过加载指令进行推测执行。假设每个栅栏都是一个串行化屏障，它会排空推测性工作并产生一个相当于 $p$ 个停顿周期的退役气泡。\n\n设动态指令流的栅栏频率为 $\\phi$，定义为每条指令的平均栅栏数。在这些假设下：\n- 不存在其他停顿来源或缓存未命中。\n- 在不被栅栏停顿时，流水线能维持最大提交宽度。\n- 栅栏本身不执行有效工作，并作为普通指令退役，遵循上述停顿模型。\n\n仅使用每周期指令数 (IPC) 的基本定义（即退役指令数除以总周期数），推导 IPC 下降值 $\\Delta \\text{IPC}$（定义为 $\\Delta \\text{IPC} = \\text{IPC}_{\\text{baseline}} - \\text{IPC}_{\\text{with fences}}$）的闭式解析表达式，该表达式应为 $w$、$p$ 和 $\\phi$ 的函数。您的最终答案必须是仅包含 $w$、$p$ 和 $\\phi$ 的单个闭式表达式。不需要进行数值近似。", "solution": "首先对问题陈述进行严格的验证过程。\n\n### 步骤 1：提取已知条件\n- 最大提交宽度：每周期 $w$ 条指令。\n- 栅栏引起的停顿持续时间：每个栅栏 $p$ 个周期。\n- 栅栏频率：$\\phi$，定义为动态流中每条指令的平均栅栏数。\n- 假设：不存在其他停顿来源或缓存未命中。\n- 假设：在没有停顿时，流水线维持最大提交宽度 $w$。\n- 假设：栅栏作为普通指令退役。\n- IPC 的定义：$\\text{IPC} = \\frac{\\text{退役指令数}}{\\text{总周期数}}$。\n- 待推导的量：IPC 下降值，$\\Delta \\text{IPC} = \\text{IPC}_{\\text{baseline}} - \\text{IPC}_{\\text{with fences}}$。\n- 最终表达式必须是 $w$、$p$ 和 $\\phi$ 的函数。\n\n### 步骤 2：使用提取的已知条件进行验证\n- **科学依据**：该问题在计算机体系结构原理，特别是处理器流水线的性能建模方面有坚实的理论基础。每周期指令数（IPC）、提交宽度、推测执行和串行化栅栏等概念是该领域的标准。该模型是一个简化模型，这是一阶性能分析中一种有效且常用的技术。\n- **适定性**：问题陈述清晰，提供了推导唯一解析表达式所需的所有必要变量（$w$、$p$、$\\phi$）和假设。目标明确无歧义。\n- **客观性**：语言技术性强且精确，没有任何主观或非科学的陈述。\n\n### 步骤 3：结论与行动\n该问题是有效的。这是一个适定的、具有科学依据的计算机体系结构性能分析问题。开始进行求解。\n\n目标是推导 IPC 下降值 $\\Delta \\text{IPC}$ 的表达式，它被定义为基线 IPC 与带有推测栅栏的 IPC 之间的差值。\n$$\n\\Delta \\text{IPC} = \\text{IPC}_{\\text{baseline}} - \\text{IPC}_{\\text{with fences}}\n$$\n\n首先，我们确定基线 IPC，即 $\\text{IPC}_{\\text{baseline}}$。在基线场景中，没有栅栏，并且根据问题陈述，没有其他停顿来源。处理器维持其最大提交宽度，即每周期 $w$ 条指令。因此，基线 IPC 就是：\n$$\n\\text{IPC}_{\\text{baseline}} = w\n$$\n\n接下来，我们确定带有推测栅栏的系统的 IPC，即 $\\text{IPC}_{\\text{with fences}}$。我们使用 IPC 的基本定义。让我们考虑一个大的、具有统计代表性的执行窗口，其总时间为 $T$ 个周期。这个总时间由两部分组成：指令退役的活动周期（$T_{\\text{active}}$）和由栅栏引起的停顿周期（$T_{\\text{stall}}$）。\n$$\nT = T_{\\text{active}} + T_{\\text{stall}}\n$$\n在活动周期内，处理器以其最大速率 $w$ 退役指令。因此，退役的指令总数 $I$ 为：\n$$\nI = w T_{\\text{active}}\n$$\n问题将 $\\phi$ 定义为栅栏频率，即退役指令中栅栏指令所占的比例。因此，在所有退役指令 $I$ 中，栅栏指令的数量 $I_{\\text{fence}}$ 为：\n$$\nI_{\\text{fence}} = \\phi I\n$$\n每个栅栏指令引入 $p$ 个周期的停顿。总停顿时间是栅栏数量乘以每个栅栏的惩罚：\n$$\nT_{\\text{stall}} = I_{\\text{fence}} \\cdot p = (\\phi I) p\n$$\n现在我们可以在不同的时间分量之间建立关系。我们将 $I$ 的表达式代入 $T_{\\text{stall}}$ 的方程中：\n$$\nT_{\\text{stall}} = \\phi (w T_{\\text{active}}) p = w \\phi p T_{\\text{active}}\n$$\n我们现在可以仅用活动时间 $T_{\\text{active}}$ 来表示总时间 $T$：\n$$\nT = T_{\\text{active}} + T_{\\text{stall}} = T_{\\text{active}} + w \\phi p T_{\\text{active}} = T_{\\text{active}}(1 + w \\phi p)\n$$\n带有栅栏时的 IPC 是退役的指令总数 $I$ 除以所花费的总时间 $T$：\n$$\n\\text{IPC}_{\\text{with fences}} = \\frac{I}{T} = \\frac{w T_{\\text{active}}}{T_{\\text{active}}(1 + w \\phi p)}\n$$\n$T_{\\text{active}}$ 项被消去，从而得出采取缓解措施的系统中 IPC 的表达式：\n$$\n\\text{IPC}_{\\text{with fences}} = \\frac{w}{1 + w \\phi p}\n$$\n最后，我们可以通过从基线 IPC 中减去这个结果来计算 IPC 下降值 $\\Delta \\text{IPC}$：\n$$\n\\Delta \\text{IPC} = \\text{IPC}_{\\text{baseline}} - \\text{IPC}_{\\text{with fences}} = w - \\frac{w}{1 + w \\phi p}\n$$\n为了简化此表达式，我们进行通分：\n$$\n\\Delta \\text{IPC} = \\frac{w(1 + w \\phi p)}{1 + w \\phi p} - \\frac{w}{1 + w \\phi p}\n$$\n$$\n\\Delta \\text{IPC} = \\frac{w + w^2 \\phi p - w}{1 + w \\phi p}\n$$\n$$\n\\Delta \\text{IPC} = \\frac{w^2 \\phi p}{1 + w \\phi p}\n$$\n这就是 IPC 下降值作为指定参数函数的最终闭式解析表达式。", "answer": "$$\n\\boxed{\\frac{w^{2} \\phi p}{1 + w \\phi p}}\n$$", "id": "3679423"}]}