{"hands_on_practices": [{"introduction": "在深入研究复杂的定点数算术之前，掌握其基本存储方式至关重要。第一个练习 [@problem_id:3641292] 模拟了一个在嵌入式系统中常见且令人头疼的错误：混合字节序（endianness）通信问题。通过追踪一个简单数值如何因字节序错乱而被破坏，您将具体理解为何字节序并非无关紧要的细节，而是能够彻底改变数值大小的关键因素。", "problem": "一个 $32$ 位有符号定点数字段在传感器和主机之间进行通信。传感器使用二补数 $Qm.n$ 格式（其中 $m=7$ 且 $n=24$）对实数值进行编码，因此有 $1$ 个符号位、$m=7$ 个整数位和 $n=24$ 个小数位（总宽度为 $1+m+n=32$）。对于一个位模式，若其有符号整数解释为 $I$，则其所表示的实数值为 $r=I/2^{n}$。\n\n由于一个混合字节序的实现缺陷，主机会在解释每个接收到的字段之前，反转其 $4$ 个字节的顺序，尽管传感器已经按照主机的本地字节序发送了字节。换句话说，主机对传输的 $32$ 位模式应用了一个 $4$ 字节的反转。\n\n为诊断此问题，你命令传感器发出精确的实数值 $x=1$（即实数一）。设 $y$ 是主机在相同的 $Q7.24$ 解释下，从字节反转后的 $32$ 位模式计算出的实数值。\n\n仅从上述定义和位索引推理出发，推导出比率 $y/x$，并证明它是一个 2 的幂。设 $s$ 为有符号整数，使得 $y/x=2^{s}$。求 $s$ 的值。\n\n你的最终答案必须是单个整数 $s$。不需要进行四舍五入。", "solution": "题目要求推导一个整数 $s$，使得两个定点数之比 $y/x$ 等于 $2^s$。值 $x$ 是由传感器编码的数，而 $y$ 是主机在发生字节反转错误后解码的数。数字格式为 $32$ 位有符号二补数 $Qm.n$ 表示法，其中 $m=7$ 且 $n=24$。\n\n首先，我们确定实数值 $x=1$ 的 $32$ 位二进制表示。在定点系统中，一个实数值 $r$ 由一个缩放后的整数 $I$ 表示。它们之间的关系由 $r = I / 2^n$ 给出。对于 $Q7.24$ 格式，小数位数为 $n=24$。\n为了表示实数值 $x=1$，我们必须找到对应的整数 $I_x$：\n$$x = \\frac{I_x}{2^{n}} \\implies 1 = \\frac{I_x}{2^{24}}$$\n解出 $I_x$，我们得到：\n$$I_x = 2^{24}$$\n下一步是将这个整数 $I_x = 2^{24}$ 表示为 $32$ 位二补数二进制格式。设一个 $32$ 位字的各位从 $b_0$（最低有效位，LSB）到 $b_{31}$（最高有效位，MSB）进行索引。一个正二进制数的整数值由 $\\sum_{k=0}^{30} b_k 2^k$ 给出。值 $2^{24}$ 由一个字表示，其中只有位置 $24$ 上的位被设置为 $1$，所有其他位均为 $0$。\n该位模式，我们称之为 $W_x$，是：\n$$W_x = \\underbrace{0000000}_{b_{31}-b_{25}}1_{b_{24}}\\underbrace{000000000000000000000000}_{b_{23}-b_0}$$\n符号位 $b_{31}$ 为 $0$，这与正数是一致的。\n\n这个 $32$ 位字由四个 $8$ 位字节组成。我们把这些字节从最高有效到最低有效记为 $B_3, B_2, B_1, B_0$。\n$B_3$ 包含位 $b_{31}, b_{30}, \\ldots, b_{24}$。\n$B_2$ 包含位 $b_{23}, b_{22}, \\ldots, b_{16}$。\n$B_1$ 包含位 $b_{15}, b_{14}, \\ldots, b_8$。\n$B_0$ 包含位 $b_7, b_6, \\ldots, b_0$。\n\n$W_x$ 中唯一的非零位是 $b_{24}$。这个位是最高有效字节 $B_3$ 的最低有效位。\n四个字节的值是：\n$$B_3 = (00000001)_2 = 1$$\n$$B_2 = (00000000)_2 = 0$$\n$$B_1 = (00000000)_2 = 0$$\n$$B_0 = (00000000)_2 = 0$$\n\n根据题意，主机会反转这四个字节的顺序。如果传输的字节流在概念上是 $(B_3, B_2, B_1, B_0)$，主机会将它们重新组装成一个新的 $32$ 位字 $W_y$，其字节序为 $(B_0, B_1, B_2, B_3)$。\n新字 $W_y$ 的字节是：\n新的最高有效字节，$B'_3 = B_0 = (00000000)_2$。\n新的第二个字节，$B'_2 = B_1 = (00000000)_2$。\n新的第三个字节，$B'_1 = B_2 = (00000000)_2$。\n新的最低有效字节，$B'_0 = B_3 = (00000001)_2$。\n\n主机中得到的结果 $32$ 位模式 $W_y$ 是：\n$$W_y = \\underbrace{00000000}_{B'_3}\\underbrace{00000000}_{B'_2}\\underbrace{00000000}_{B'_1}\\underbrace{00000001}_{B'_0}$$\n这个位模式在 LSB 位置 $b_0$ 上有一个单独的 $1$。\n\n主机解释这个模式 $W_y$ 以获得一个整数值 $I_y$。由于符号位 $b'_{31}$ 为 $0$，该数为正。其整数值为：\n$$I_y = 1 \\cdot 2^0 = 1$$\n然后，主机使用相同的 $Q7.24$ 格式将这个整数 $I_y$ 转换为实数值 $y$：\n$$y = \\frac{I_y}{2^n} = \\frac{1}{2^{24}}$$\n\n我们被要求求出比率 $y/x$。我们有 $x=1$ 和 $y=1/2^{24}$。\n$$\\frac{y}{x} = \\frac{1/2^{24}}{1} = \\frac{1}{2^{24}} = 2^{-24}$$\n题目指出这个比率是 $2^s$。通过令表达式相等，我们得到：\n$$2^s = 2^{-24}$$\n因此，整数 $s$ 是 $-24$。\n所使用的逻辑完全依赖于定点表示法的定义和指定的位/字节操作，符合题目要求。该比率确实是 2 的一个幂。", "answer": "$$\\boxed{-24}$$", "id": "3641292"}, {"introduction": "在对性能要求严苛的系统中，除法运算通常是需要避免的。本练习 [@problem_id:3641212] 探讨了一种用更高效的“乘以倒数”来替代高成本除法的标准技巧。此处的关键挑战在于，您需要推导出在乘法之后必须进行的正确缩放移位数，以确保最终结果在数值上是准确的，并且不会引入系统性偏差。", "problem": "一个数字信号处理流水线使用预计算的倒数进行乘法来替代除以一个正常数，其中使用二的补码（TC）$Qm.n$格式的有符号定点数。在$Qm.n$格式中，一个实数值$v$由一个整数$I$表示，使得$v = I \\cdot 2^{-n}$。设$x$在$Qm_{x}.n_{x}$格式中由整数$I_{x}$表示，倒数近似值$r \\approx 1/c$在$Qm_{r}.n_{r}$格式中由整数$I_{r}$表示。目标结果$z = x/c$将在$Qm_{z}.n_{z}$格式中由整数$I_{z}$表示。硬件以全精度计算整数乘积$P = I_{x} \\cdot I_{r}$，然后生成$J = \\operatorname{round}(P / 2^{s})$，其中$\\operatorname{round}(\\cdot)$表示向最近偶数舍入（四舍六入五成双），最后将$I_{z} = J$解释为$Qm_{z}.n_{z}$格式的输出。假设没有发生溢出或饱和，并且舍入模式具有零均值误差。对于$r$等于精确倒数$1/c$的特殊情况，施加无偏性要求，即对于每个可表示的$x$，期望的表示输出等于精确的实数结果，即$\\mathbb{E}[I_{z} \\cdot 2^{-n_{z}}] = x/c$。\n\n从定点表示和舍入的基本原理出发，推导出一个关于$n_{x}$、$n_{r}$和$n_{z}$的移位$s$的闭式表达式，以保证上述意义上的无偏性。你的最终答案必须是关于$s$的单个解析表达式。", "solution": "我们从定点$Qm.n$的核心定义开始：一个实数值$v$由一个整数$I$根据$v = I \\cdot 2^{-n}$表示。对于二的补码（TC）中的有符号值，在可表示范围内，$I$和$v$之间的映射是线性的，两个定点值的乘法对应于其整数的乘法，并伴随其2的幂次缩放因子的指数相加。\n\n设$x$在$Qm_{x}.n_{x}$格式中表示为$x = I_{x} \\cdot 2^{-n_{x}}$，设$r$在$Qm_{r}.n_{r}$格式中表示为$r = I_{r} \\cdot 2^{-n_{r}}$。当$r$等于精确倒数时，考虑精确的实数乘积：由于$r = 1/c$，精确目标是\n$$\nz = \\frac{x}{c} = x \\cdot r = \\left(I_{x} \\cdot 2^{-n_{x}}\\right) \\left(I_{r} \\cdot 2^{-n_{r}}\\right) = \\left(I_{x} I_{r}\\right) \\cdot 2^{-(n_{x} + n_{r})}.\n$$\n硬件计算整数乘积$P = I_{x} I_{r}$，然后生成\n$$\nJ = \\operatorname{round}\\!\\left(\\frac{P}{2^{s}}\\right).\n$$\n最后，$J$在目标格式$Qm_{z}.n_{z}$中被解释为输出整数$I_{z} = J$，其对应的表示实数值为\n$$\nz_{\\text{fp}} = I_{z} \\cdot 2^{-n_{z}} = J \\cdot 2^{-n_{z}}.\n$$\n在向最近偶数舍入（四舍六入五成双）的规则下，当考虑小数部分的分布或打破平局的随机性时，舍入误差是零均值的。因此，对于任何确定的$P$，\n$$\n\\mathbb{E}[J] = \\mathbb{E}\\!\\left[\\operatorname{round}\\!\\left(\\frac{P}{2^{s}}\\right)\\right] = \\frac{P}{2^{s}}.\n$$\n因此，期望的表示输出为\n$$\n\\mathbb{E}[z_{\\text{fp}}] = \\mathbb{E}[J] \\cdot 2^{-n_{z}} = \\frac{P}{2^{s}} \\cdot 2^{-n_{z}} = \\left(I_{x} I_{r}\\right) \\cdot 2^{-(s + n_{z})}.\n$$\n当$r = 1/c$时，为了相对于精确实数结果$z = \\left(I_{x} I_{r}\\right) \\cdot 2^{-(n_{x} + n_{r})}$的无偏性，我们需要\n$$\n\\mathbb{E}[z_{\\text{fp}}] = z \\quad \\text{for all representable } x,\n$$\n由于对于任意可表示的$I_{x}$和$I_{r}$，$I_{x} I_{r}$因子会消去，该要求简化为对缩放指数的条件：\n$$\n2^{-(s + n_{z})} = 2^{-(n_{x} + n_{r})}.\n$$\n令指数相等，得到充分必要条件\n$$\ns + n_{z} = n_{x} + n_{r} \\quad \\Longrightarrow \\quad s = n_{x} + n_{r} - n_{z}.\n$$\n这个移位$s$确保了，除了零均值的舍入噪声外，当$r$是精确倒数时，表示结果具有正确的缩放，使其期望值与精确除法$x/c$相匹配。如果$r$是$1/c$的一个近似值，那么任何残余偏差都源于$r$本身的近似误差，而不是源于缩放，因为推导出的$s$已经使得相对于理想倒数的缩放是无偏的。", "answer": "$$\\boxed{n_{x}+n_{r}-n_{z}}$$", "id": "3641212"}, {"introduction": "我们的最后一个练习 [@problem_id:3641311] 旨在解决所有定点设计中的核心权衡问题：动态范围与精度之间的平衡。您将计算一个点积，其结果对于直接存储而言过大或过小，因此必须找到一个最佳的缩放因子 $s$。这个练习要求您同时满足两个相互冲突的约束条件——既要避免溢出，又要符合严格的误差预算——从而让您深入理解在实际应用中如何巧妙地对信号进行缩放。", "problem": "考虑一个定点数据通路，它以参数 $m=6$ 和 $n=10$ 的二的补码 (2C) 定点格式 $Qm.n$ 存储标量结果。在 $Qm.n$ 格式中，可表示的值是分辨率 $2^{-n}$ 的整数倍，可表示范围是 $[-2^{m},\\,2^{m}-2^{-n}]$。当将实数值映射到 $Qm.n$ 网格时，使用四舍五入到最近邻的规则。\n\n给定点积\n$$y=\\sum_{i=1}^{N} a_i b_i,$$\n其中 $N=8$，$a_i \\in \\mathbb{Z}$ 和 $b_i \\in \\mathbb{Z}$ 由下式指定：\n$$[a_1,a_2,a_3,a_4,a_5,a_6,a_7,a_8]=[5,-7,3,12,-9,4,2,-6],$$\n$$[b_1,b_2,b_3,b_4,b_5,b_6,b_7,b_8]=[3,8,-11,5,-2,1,-4,9].$$\n\n为了将点积的结果存储在 $Q6.10$ 中而不发生溢出，并随后恢复原始 $y$ 的一个缩放近似值，您可以在存储前对最终和应用一个实值缩放因子 $s>0$，即存储 $y_s=\\operatorname{round}_{Q6.10}(s\\,y)$，然后通过 $1/s$ 进行反缩放以形成 $\\hat{y}=y_s/s$。四舍五入到最近邻的映射是到最近的 $Q6.10$ 网格点。\n\n确定最大的缩放因子 $s$，该因子同时满足：\n- 在 $Q6.10$ 中存储 $y_s$ 时避免溢出，且\n- 保证绝对反缩放误差 $|\\hat{y}-y|$ 不超过界限 $\\epsilon=8.0\\times 10^{-4}$。\n\n将您的最终缩放因子四舍五入到六位有效数字。答案不需要物理单位。", "solution": "问题要求找到满足两个条件的最大缩放因子 $s$：在定点表示中避免溢出，并维持指定的误差界限。\n\n首先，我们计算点积 $y = \\sum_{i=1}^{N} a_i b_i$ 的精确值。\n维度为 $N=8$，整数向量给定为\n$[a_1, a_2, a_3, a_4, a_5, a_6, a_7, a_8] = [5, -7, 3, 12, -9, 4, 2, -6]$\n$[b_1, b_2, b_3, b_4, b_5, b_6, b_7, b_8] = [3, 8, -11, 5, -2, 1, -4, 9]$\n点积计算如下：\n$$y = (5)(3) + (-7)(8) + (3)(-11) + (12)(5) + (-9)(-2) + (4)(1) + (2)(-4) + (-6)(9)$$\n$$y = 15 - 56 - 33 + 60 + 18 + 4 - 8 - 54$$\n$$y = (15 + 60 + 18 + 4) - (56 + 33 + 8 + 54) = 97 - 151$$\n$$y = -54$$\n\n接下来，我们建立对缩放因子 $s$ 的约束。定点格式为 $Qm.n$，其中 $m=6$ 且 $n=10$。分辨率，即可表示的最小正值，是 $\\Delta = 2^{-n} = 2^{-10}$。\n\n第一个约束与反缩放误差有关。原始值 $y$ 被 $s$ 缩放得到 $s \\cdot y$。这个实数值然后被量化到 $Q6.10$ 格式中的最近网格点，得到存储值 $y_s = \\operatorname{round}_{Q6.10}(s \\cdot y)$。对于四舍五入到最近邻，量化误差 $E_q = y_s - s \\cdot y$ 的幅值有界，为分辨率的一半：$|E_q| \\le \\frac{\\Delta}{2}$。\n反缩放值为 $\\hat{y} = y_s / s$。反缩放误差为 $|\\hat{y} - y|$。我们可以用量化误差来表示它：\n$$|\\hat{y} - y| = \\left| \\frac{y_s}{s} - y \\right| = \\left| \\frac{s \\cdot y + E_q}{s} - y \\right| = \\left| y + \\frac{E_q}{s} - y \\right| = \\frac{|E_q|}{s}$$\n使用 $|E_q|$ 的界限，我们得到反缩放误差的一个上界：\n$$|\\hat{y} - y| \\le \\frac{\\Delta / 2}{s} = \\frac{\\Delta}{2s}$$\n问题要求此误差不超过 $\\epsilon = 8.0 \\times 10^{-4}$。\n$$\\frac{\\Delta}{2s} \\le \\epsilon$$\n对 $s$ 求解，我们得到一个下界：\n$$s \\ge \\frac{\\Delta}{2\\epsilon} = \\frac{2^{-10}}{2 \\cdot (8.0 \\times 10^{-4})} = \\frac{2^{-10}}{1.6 \\times 10^{-3}} = \\frac{2^{-10}}{16 \\times 10^{-4}} = \\frac{2^{-10}}{2^4 \\times 10^{-4}} = \\frac{10^4}{2^{14}}$$\n由于 $2^{14} = 16384$， $s$ 的下界是 $s \\ge \\frac{10000}{16384} = 0.6103515625$。\n\n第二个约束是避免溢出。$Q6.10$ 格式的可表示范围是 $[-2^m, 2^m - 2^{-n}]$，即 $[-2^6, 2^6 - 2^{-10}]$，或 $[-64, 64 - 2^{-10}]$。存储值 $y_s$ 必须落在此范围内。\n为保证 $y_s = \\operatorname{round}_{Q6.10}(s \\cdot y)$ 在范围内，量化前的值 $q = s \\cdot y$ 必须能舍入到一个有效的数字。\n最小可表示值为 $V_{min} = -2^m = -64$。最大值为 $V_{max} = 2^m - \\Delta = 64 - 2^{-10}$。\n为避免负溢出，$q$ 必须舍入到一个大于等于 $V_{min}$ 的值。如果 $q \\ge V_{min} - \\frac{\\Delta}{2}$，则可以保证。\n为避免正溢出，$q$ 必须舍入到一个小于等于 $V_{max}$ 的值。如果 $q \\le V_{max} + \\frac{\\Delta}{2}$，则可以保证。\n因此，量化前的值必须满足：\n$$V_{min} - \\frac{\\Delta}{2} \\le s \\cdot y \\le V_{max} + \\frac{\\Delta}{2}$$\n$$-2^m - \\frac{\\Delta}{2} \\le s \\cdot y \\le (2^m - \\Delta) + \\frac{\\Delta}{2}$$\n$$-2^m - \\frac{\\Delta}{2} \\le s \\cdot y \\le 2^m - \\frac{\\Delta}{2}$$\n代入值 $y=-54$，$m=6$ 和 $\\Delta=2^{-10}$：\n$$-64 - \\frac{2^{-10}}{2} \\le -54s \\le 64 - \\frac{2^{-10}}{2}$$\n$$-64 - 2^{-11} \\le -54s \\le 64 - 2^{-11}$$\n由于 $s > 0$，项 $-54s$ 是负数，所以右侧不等式 ($-54s \\le 64 - 2^{-11}$) 总是满足的。对 $s$ 的约束来自于左侧不等式：\n$$-64 - 2^{-11} \\le -54s$$\n两边乘以 $-1$ 并反转不等号，得到 $s$ 的上界：\n$$64 + 2^{-11} \\ge 54s \\implies s \\le \\frac{64 + 2^{-11}}{54}$$\n\n为同时满足两个条件，$s$ 必须在区间 $\\left[ \\frac{10^4}{2^{14}}, \\frac{64 + 2^{-11}}{54} \\right]$ 内。我们寻求 $s$ 的最大可能值，即此区间的上界：\n$$s_{max} = \\frac{64 + 2^{-11}}{54}$$\n我们计算该值：\n$$s_{max} = \\frac{64 + \\frac{1}{2048}}{54} = \\frac{\\frac{64 \\cdot 2048 + 1}{2048}}{54} = \\frac{131072 + 1}{2048 \\cdot 54} = \\frac{131073}{110592}$$\n$$s_{max} \\approx 1.18519422735...$$\n将其四舍五入到六位有效数字，我们看第七位数字。前六位数字是 $1.18519$。第七位数字是 $4$，因此我们向下舍入。\n$$s_{max} \\approx 1.18519$$", "answer": "$$\\boxed{1.18519}$$", "id": "3641311"}]}