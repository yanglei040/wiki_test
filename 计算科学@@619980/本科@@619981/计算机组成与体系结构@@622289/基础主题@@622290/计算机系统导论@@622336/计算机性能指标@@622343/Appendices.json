{"hands_on_practices": [{"introduction": "性能分析的第一步通常是理解执行每条指令的“成本”。我们引入 CPI（每指令周期数）这一概念，作为衡量平均每条指令需要多少个时钟周期的指标。本练习将指导你通过将其分解为一个基础值和由常见流水线冒险引起的额外开销，来计算处理器的整体 CPI，从而展示微体系结构特性如何直接影响这一基本性能指标。[@problem_id:3628693]", "problem": "一个单发射、按序执行的 $5$ 级流水线执行一个包含稳定指令组合的大型程序，冒险会导致流水线停顿。忽略所有冒险的基础每指令周期数 (CPI) 为 $1.0$。指令组合比例如下：加载指令 $0.20$，存储指令 $0.15$，算术和逻辑指令 $0.45$，以及控制流指令（分支） $0.20$。对于此工作负载，观察到以下微体系结构行为：\n\n- 当紧跟在加载指令之后的一条指令使用了加载的值时，会发生加载-使用依赖；每次加载发生此依赖的概率为 $0.30$，发生时会导致 $1$ 个周期的停顿。\n- 加载指令的数据缓存未命中率为 $0.02$，存储指令为 $0.01$。每次加载未命中会使流水线停顿 $12$ 个周期，每次存储未命中会使流水线停顿 $8$ 个周期。\n- 分支预测器是一个两级自适应预测器，其初始准确率为 $0.88$。每次分支预测错误都会导致流水线冲刷，并产生 $4$ 个周期的开销。\n\n分析时作如下假设：指令间的冒险在统计上是独立的，不同事件引起的停顿周期不重叠，算术和逻辑指令在基础流水线时序之外不引起停顿，并且指令流足够长，因此期望值具有代表性。一项体系结构改进将分支预测器的准确率提高到 $0.96$，所有其他特性保持不变。\n\n仅使用吞吐率和平均值的基本定义，计算在分支预测器准确率提高后，此工作负载的改进后总体每指令周期数 (CPI)。将你的答案四舍五入到四位有效数字。最终的 CPI 以纯数字形式表示，不带单位。", "solution": "该问题要求计算在特定体系结构改进后的总体每指令周期数 (CPI)。验证问题陈述是强制性的第一步。\n\n### 第一步：提取已知条件\n- 处理器流水线：单发射、按序执行、$5$ 级\n- 基础 CPI (无冒险): $CPI_{base} = 1.0$\n- 指令组合比例：\n    - 加载指令 ($f_{load}$): $0.20$\n    - 存储指令 ($f_{store}$): $0.15$\n    - 算术/逻辑指令 ($f_{alu}$): $0.45$\n    - 控制流/分支指令 ($f_{branch}$): $0.20$\n- 加载-使用依赖：\n    - 每次加载的发生概率 ($P_{dep}$): $0.30$\n    - 每次发生的停顿周期 ($S_{dep}$): $1$\n- 数据缓存未命中：\n    - 加载未命中率 ($M_{load}$): $0.02$\n    - 存储未命中率 ($M_{store}$): $0.01$\n    - 每次加载未命中的停顿周期 ($S_{load\\_miss}$): $12$\n    - 每次存储未命中的停顿周期 ($S_{store\\_miss}$): $8$\n- 分支预测：\n    - 初始准确率 ($A_{init}$): $0.88$\n    - 改进后准确率 ($A_{imp}$): $0.96$\n    - 每次预测错误的停顿周期 ($S_{branch\\_miss}$): $4$\n- 假设：\n    - 冒险在统计上是独立的。\n    - 不同事件引起的停顿周期不重叠。\n    - 算术和逻辑指令不引起停顿。\n    - 指令流足够长，因此期望值具有代表性。\n\n### 第二步：使用提取的已知条件进行验证\n根据验证标准对问题进行评估。\n- **科学依据充分：** 该问题基于计算机组成和体系结构的基本概念，特别是流水线性能分析。CPI、指令组合、数据冒险（加载-使用）、缓存未命中和分支预测错误等概念都是该领域的标准和成熟概念。所提供的数值对于一个假设的处理器来说是合理的。\n- **定义明确：** 该问题提供了计算最终 CPI 所需的所有必要数据（基础 CPI、指令比例、冒险概率和停顿开销）。问题清晰明确。关于不同事件的停顿周期是可加的这一假设简化了计算，并确保了唯一解。\n- **客观性：** 问题陈述不含主观语言、观点或偏见。它呈现了一个纯粹用于定量分析的技术场景。\n\n该问题没有表现出验证标准中列出的任何缺陷。它科学合理、自成体系、一致且定义明确。\n\n### 第三步：结论与行动\n该问题被判定为**有效**。将提供解决方案。\n\n流水线处理器的总体 CPI 可以表示为基础 CPI 与所有引起停顿的事件所贡献的 CPI 之和。理想流水线的基础 CPI 已知为 $1.0$。总 CPI 计算如下：\n$$CPI_{total} = CPI_{base} + \\sum_{i} CPI_{stall, i}$$\n其中 $CPI_{stall, i}$ 是第 $i$ 种冒险平均每条指令贡献的停顿周期数。每个停顿事件的贡献是其发生频率（每条指令）与每次发生的开销（以周期为单位）的乘积。\n\n问题描述了三种停顿来源：\n1. 加载-使用数据冒险。\n2. 数据缓存未命中（包括加载和存储）。\n3. 分支预测错误。\n\n问题要求计算改进后的总体 CPI，这需要使用改进后的分支预测器准确率。我们将分别计算每个来源的 CPI 贡献。\n\n**1. 加载-使用冒险的 CPI 贡献 ($CPI_{dep}$)**\n当紧跟在加载指令之后的指令使用了加载的值时，会发生加载-使用冒险停顿。此事件每条指令的发生频率是加载指令的比例乘以给定加载发生此依赖的概率。\n$$CPI_{dep} = f_{load} \\times P_{dep} \\times S_{dep}$$\n代入给定值：\n$$CPI_{dep} = 0.20 \\times 0.30 \\times 1 = 0.06$$\n\n**2. 数据缓存未命中的 CPI 贡献 ($CPI_{dcache}$)**\n此贡献有两个组成部分：加载未命中停顿和存储未命中停顿。根据不同事件的停顿周期不重叠的假设，我们可以将它们的单独贡献相加。\n\n-   **加载未命中停顿：** 每次指令的加载未命中频率是加载指令的比例乘以加载未命中率。\n    $$CPI_{load\\_miss} = f_{load} \\times M_{load} \\times S_{load\\_miss}$$\n    代入给定值：\n    $$CPI_{load\\_miss} = 0.20 \\times 0.02 \\times 12 = 0.048$$\n\n-   **存储未命中停顿：** 每次指令的存储未命中频率是存储指令的比例乘以存储未命中率。\n    $$CPI_{store\\_miss} = f_{store} \\times M_{store} \\times S_{store\\_miss}$$\n    代入给定值：\n    $$CPI_{store\\_miss} = 0.15 \\times 0.01 \\times 8 = 0.012$$\n\n数据缓存未命中的总贡献是这两个部分的总和：\n$$CPI_{dcache} = CPI_{load\\_miss} + CPI_{store\\_miss} = 0.048 + 0.012 = 0.060$$\n\n**3. 分支预测错误的 CPI 贡献 ($CPI_{branch}$)**\n问题要求使用改进后的分支预测器准确率，$A_{imp} = 0.96$。因此，分支预测错误率是 $1 - A_{imp}$。每条指令的分支预测错误频率是分支指令的比例乘以这个预测错误率。\n$$CPI_{branch} = f_{branch} \\times (1 - A_{imp}) \\times S_{branch\\_miss}$$\n代入给定值：\n$$CPI_{branch} = 0.20 \\times (1 - 0.96) \\times 4 = 0.20 \\times 0.04 \\times 4 = 0.032$$\n\n**4. 计算改进后的总体 CPI ($CPI_{improved}$)**\n改进后的总体 CPI 是基础 CPI 与所有停顿来源的 CPI 贡献之和。\n$$CPI_{improved} = CPI_{base} + CPI_{dep} + CPI_{dcache} + CPI_{branch}$$\n代入计算出的值：\n$$CPI_{improved} = 1.0 + 0.06 + 0.060 + 0.032$$\n$$CPI_{improved} = 1.0 + 0.120 + 0.032$$\n$$CPI_{improved} = 1.152$$\n问题要求答案四舍五入到四位有效数字。计算出的值 $1.152$ 已经有四位有效数字。", "answer": "$$\\boxed{1.152}$$", "id": "3628693"}, {"introduction": "在理解了简单流水线的性能后，我们转向能够在每个周期执行多条指令的现代超标量处理器。在这种情况下，IPC（每周期指令数）是衡量吞吐率的一个更直观的指标。本练习将挑战你扮演一个双发射处理器的调度器角色，不仅在指令流中寻找性能瓶颈，还要关注处理器有限的硬件资源（结构冒险）所带来的限制，这将帮助你理解受资源限制的性能概念。[@problem_id:3628660]", "problem": "一个双发射超标量处理器在结构性冒险允许的情况下，每个周期最多可以发射 $2$ 条指令。该机器有三个不同的功能流水线：一个整数算术逻辑单元 (ALU)，一个内存流水线 (加载/存储)，以及一个浮点加法流水线。每个周期都存在以下结构性约束：\n- 最多可以发射 $1$ 个整数 ALU 操作。\n- 最多可以发射 $1$ 个内存操作。\n- 最多可以发射 $1$ 个浮点加法操作。\n- 由于共享写回端口，内存操作和浮点加法操作不能在同一周期发射。\n\n假设所有指令都是独立的，重排序缓冲区足够大可以任意重排序，没有控制冒险，并且功能延迟被流水线完全隐藏。一个展开的循环体包含 $N_{\\text{ALU}}=37$ 个整数 ALU 操作，$N_{\\text{MEM}}=28$ 个内存操作，以及 $N_{\\text{FP}}=25$ 个浮点加法操作，每个循环体总共有 $N_{\\text{tot}}=90$ 条指令。考虑循环体多次重复的稳态情况，其中边界效应可以忽略不计。\n\n仅使用每周期指令数 (IPC) 作为每周期完成的指令数的基本定义，确定在避免结构性冒险的最优调度下可实现的最大稳态 IPC。将最终的 IPC 表示为十进制数，并四舍五入到四位有效数字。", "solution": "首先将根据科学合理性、清晰性和完整性的要求对问题进行验证。\n\n### 问题验证\n\n**步骤 1：提取已知条件**\n- 处理器：双发射超标量（每个周期最多可发射 $2$ 条指令）。\n- 功能单元：$1$ 个整数 ALU，$1$ 个内存流水线，$1$ 个浮点加法流水线。\n- 每个周期的结构性约束：\n  - 最多可以发射 $1$ 个整数 ALU 操作。\n  - 最多可以发射 $1$ 个内存操作。\n  - 最多可以发射 $1$ 个浮点加法操作。\n  - 内存操作和浮点加法操作不能在同一周期发射。\n- 假设：\n  - 所有指令都是独立的。\n  - 重排序缓冲区足够大，可进行任意重排序。\n  - 没有控制冒险。\n  - 功能延迟被流水线完全隐藏。\n- 工作负载（一个展开的循环体）：\n  - $N_{\\text{ALU}}=37$ 个整数 ALU 操作。\n  - $N_{\\text{MEM}}=28$ 个内存操作。\n  - $N_{\\text{FP}}=25$ 个浮点加法操作。\n  - 总指令数：$N_{\\text{tot}} = 37 + 28 + 25 = 90$。\n- 分析背景：稳态，边界效应可忽略。\n- 目标：确定可实现的最大稳态每周期指令数 (IPC)。\n- 要求输出格式：十进制数，四舍五入到四位有效数字。\n\n**步骤 2：使用提取的已知条件进行验证**\n该问题在科学上基于计算机组成与体系结构的原理。它描述了一个简化但合理的超标量处理器模型，具有明确定义的结构性冒险。发射宽度、功能单元、指令混合和 IPC 等概念是性能分析的标准度量。问题提法得当、客观且自成体系。假设（指令独立、完美重排序）是典型的理想化处理，用于隔离结构性冒险对性能的影响，这是一种常见的教学技巧。所提供的数据是完整且一致的（$N_{\\text{ALU}} + N_{\\text{MEM}} + N_{\\text{FP}} = N_{\\text{tot}}$）。不存在与科学不合理、模糊或不完整相关的缺陷。\n\n**步骤 3：结论与行动**\n问题被认为是有效的。将制定解决方案。\n\n### 解决方案\n\n对于给定的指令混合，可实现的最大每周期指令数 (IPC) 取决于处理器架构中最严格的瓶颈。我们必须分析在每个架构约束下，执行循环体中 $N_{\\text{tot}}=90$ 条指令所需的最小周期数。实际周期数将是这些下界中的最大值，因为所有约束都必须同时满足。\n\n设 $C$ 为执行一个循环体所需的周期数。\n\n1.  **发射宽度约束**：处理器是双发射的，意味着每个周期最多可以发射 $2$ 条指令。要执行 $N_{\\text{tot}} = 90$ 条指令，所需的最小周期数 $C_{\\text{issue}}$ 为：\n    $$C_{\\text{issue}} = \\left\\lceil \\frac{N_{\\text{tot}}}{2} \\right\\rceil = \\left\\lceil \\frac{90}{2} \\right\\rceil = 45 \\text{ 周期}$$\n\n2.  **整数 ALU 资源约束**：只有一个整数 ALU 流水线。要执行 $N_{\\text{ALU}} = 37$ 条整数指令，所需的最小周期数 $C_{\\text{ALU}}$ 为：\n    $$C_{\\text{ALU}} = \\left\\lceil \\frac{N_{\\text{ALU}}}{1} \\right\\rceil = \\left\\lceil \\frac{37}{1} \\right\\rceil = 37 \\text{ 周期}$$\n\n3.  **内存资源约束**：只有一个内存流水线。要执行 $N_{\\text{MEM}} = 28$ 条内存指令，所需的最小周期数 $C_{\\text{MEM}}$ 为：\n    $$C_{\\text{MEM}} = \\left\\lceil \\frac{N_{\\text{MEM}}}{1} \\right\\rceil = \\left\\lceil \\frac{28}{1} \\right\\rceil = 28 \\text{ 周期}$$\n\n4.  **浮点加法器约束**：只有一个浮点加法流水线。要执行 $N_{\\text{FP}} = 25$ 条浮点加法指令，所需的最小周期数 $C_{\\text{FP}}$ 为：\n    $$C_{\\text{FP}} = \\left\\lceil \\frac{N_{\\text{FP}}}{1} \\right\\rceil = \\left\\lceil \\frac{25}{1} \\right\\rceil = 25 \\text{ 周期}$$\n\n5.  **共享写回端口约束**：内存操作和浮点加法操作不能在同一周期发射。这意味着它们是互斥的，必须占用不同的周期。因此，发射所有内存指令和所有浮点指令所需的总周期数至少是它们数量的总和。这个周期的下界 $C_{\\text{conflict}}$ 是：\n    $$C_{\\text{conflict}} = N_{\\text{MEM}} + N_{\\text{FP}} = 28 + 25 = 53 \\text{ 周期}$$\n\n执行循环体所需的总周期数 $C_{\\text{total}}$ 由这些约束中最严格的一个决定，即计算出的下界中的最大值。\n$$C_{\\text{total}} = \\max(C_{\\text{issue}}, C_{\\text{ALU}}, C_{\\text{MEM}}, C_{\\text{FP}}, C_{\\text{conflict}})$$\n$$C_{\\text{total}} = \\max(45, 37, 28, 25, 53) = 53 \\text{ 周期}$$\n\n瓶颈在于内存和浮点流水线之间共享资源的结构性冒险，这需要至少 $53$ 个周期。我们必须验证一个 $53$ 周期的调度是否可以实现。在 $53$ 个周期内，一个双发射机器有 $53 \\times 2 = 106$ 个可用的发射槽。这对于 $90$ 条指令来说是足够的。这 $28$ 个内存操作和 $25$ 个浮点操作必须在不同的周期发射，消耗 $53$ 个周期和 $53$ 个发射槽。在这 $53$ 个周期中的每一个周期，都有一个发射槽是可用的。我们需要发射 $37$ 个整数 ALU 操作。因为我们有 $53$ 个可用的第二发射槽，而只需要发射 $37$ 个 ALU 操作，所以可以将每个 ALU 操作与一个内存操作或一个浮点操作配对。例如，我们可以有 $28$ 个周期发射 (MEM, ALU) 对，和 $9$ 个周期发射 (FP, ALU) 对。剩下的 $25 - 9 = 16$ 个 FP 操作可以单独发射。总周期数将是 $28 + 9 + 16 = 53$。因此，在最优调度下，一个 $53$ 周期的执行是可行的。\n\n稳态 IPC 是每周期完成的总指令数。\n$$\\text{IPC} = \\frac{N_{\\text{tot}}}{C_{\\text{total}}} = \\frac{90}{53}$$\n计算数值：\n$$\\text{IPC} \\approx 1.6981132...$$\n四舍五入到四位有效数字，我们得到 $1.698$。", "answer": "$$\\boxed{1.698}$$", "id": "3628660"}, {"introduction": "CPU 核心的性能只是故事的一部分；对于许多现代应用程序来说，内存访问速度才是真正的瓶颈。本练习将介绍强大的屋顶线模型（Roofline model），这是一个将处理器的峰值计算吞吐率与其内存带宽联系起来的可视化框架。通过计算“临界计算强度”，你将学会判断一个给定的程序是受计算限制还是受内存限制，这是优化高性能代码的一项关键技能。[@problem_id:3628699]", "problem": "使用屋顶线性能模型对一个单插槽处理器进行评估。该处理器在流式访问上的持续峰值双精度吞吐量为 $3500$ GFLOPS（每秒十亿次浮点运算），持续内存带宽为 $560$ GB/s（每秒千兆字节）。考虑一个计算核心，其运算强度为 $I$ FLOP/byte（每字节浮点运算次数）。利用吞吐量、带宽和运算强度的第一性原理定义，以及屋顶线模型关于可实现吞吐量受限于首先饱和的资源这一概念性陈述，推导出计算核心从内存受限过渡到计算受限的临界运算强度 $I^{\\ast}$。然后，为给定处理器计算 $I^{\\ast}$ 的数值。将您的最终值四舍五入到四位有效数字。以 FLOP/byte 为单位表示最终答案。", "solution": "问题陈述已经过评估，被认为是有效的。它在科学上基于计算机体系结构的原理，特别是使用屋顶线模型的性能建模。所提供的数据是现实的，问题提法得当、客观、完整，可以推导出唯一且有意义的解。\n\n任务是为一个以其峰值浮点吞吐量和持续内存带宽为特征的处理器，推导出临界运算强度 $I^{\\ast}$，然后计算其数值。屋顶线模型假设，可实现的性能 $\\pi$ 受两个主要因素的制约：处理器的峰值计算速率和内存系统的带宽。\n\n我们用符号定义给定的量：\n- 处理器的峰值双精度吞吐量为 $\\pi_{\\text{peak}}$。\n- 持续内存带宽为 $\\beta$。\n- 计算核心的运算强度为 $I$。\n\n这些量的单位如下：\n- $\\pi_{\\text{peak}}$ 的单位是每秒浮点运算次数 (FLOP/s)。\n- $\\beta$ 的单位是每秒字节数 (B/s)。\n- $I$ 的单位是每字节浮点运算次数 (FLOP/byte)。\n\n根据屋顶线模型，对于一个运算强度为 $I$ 的核心，其可达到的性能 $\\pi(I)$ 是两个性能限制值中的最小值：计算受限性能和内存受限性能。\n\n$1$. **计算受限性能**：一个核心的性能永远不能超过处理器的峰值吞吐量。这代表了一个硬性限制，在屋顶线图中表现为一条“水平天花板”。\n$$ \\pi_{\\text{compute}} = \\pi_{\\text{peak}} $$\n\n$2$. **内存受限性能**：一个核心的性能也可能受限于从内存获取数据的速率。为了维持一定的吞吐量 $\\pi$，必须以相应的速率从内存向核心提供数据。对于一个运算强度为 $I$ 的核心，从内存传输的每个字节对应于 $I$ 次浮点运算。如果内存系统能以最大速率 $\\beta$ 字节/秒提供数据，那么内存系统能支持的最大性能就是运算强度与内存带宽的乘积。这在屋顶线图中表现为一条“倾斜天花板”。\n$$ \\pi_{\\text{memory}}(I) = I \\times \\beta $$\n\n因此，总的可达到性能由组合模型给出：\n$$ \\pi(I) = \\min(\\pi_{\\text{peak}}, I \\times \\beta) $$\n\n如果一个核心的性能受限于内存带宽，即当 $I \\times \\beta  \\pi_{\\text{peak}}$ 时，它被认为是**内存受限**的。相反，如果一个核心的性能受限于处理器的峰值吞吐量，即当 $I \\times \\beta \\geq \\pi_{\\text{peak}}$ 时，它被认为是**计算受限**的。\n\n**临界运算强度**，记作 $I^{\\ast}$，是系统从内存受限过渡到计算受限时的特定 $I$ 值。这个过渡点，即屋顶线图的“拐点”，是两个性能极限相等的地方。\n$$ \\pi_{\\text{memory}}(I^{\\ast}) = \\pi_{\\text{compute}} $$\n代入两个极限的表达式：\n$$ I^{\\ast} \\times \\beta = \\pi_{\\text{peak}} $$\n求解 $I^{\\ast}$ 得到符号推导：\n$$ I^{\\ast} = \\frac{\\pi_{\\text{peak}}}{\\beta} $$\n\n现在，我们使用问题陈述中提供的值来对该表达式进行数值计算。\n给定的值为：\n- 峰值吞吐量: $\\pi_{\\text{peak}} = 3500 \\text{ GFLOPS} = 3500 \\times 10^{9} \\text{ FLOP/s}$\n- 内存带宽: $\\beta = 560 \\text{ GB/s} = 560 \\times 10^{9} \\text{ bytes/s}$\n\n将这些值代入推导出的 $I^{\\ast}$ 公式中：\n$$ I^{\\ast} = \\frac{3500 \\times 10^{9} \\text{ FLOP/s}}{560 \\times 10^{9} \\text{ bytes/s}} $$\n分子和分母中的因子 $10^{9}$ 相互抵消，将表达式简化为数值系数的比值。单位正确地组合成 FLOP/byte。\n$$ I^{\\ast} = \\frac{3500}{560} \\text{ FLOP/byte} $$\n执行除法运算：\n$$ I^{\\ast} = \\frac{350}{56} = \\frac{50}{8} = \\frac{25}{4} = 6.25 \\text{ FLOP/byte} $$\n问题要求将最终答案四舍五入到四位有效数字。计算出的值 $6.25$ 有三位有效数字。为了用四位有效数字表示，我们在末尾添加一个零。\n$$ I^{\\ast} = 6.250 \\text{ FLOP/byte} $$\n这个值代表了机器的平衡点。运算强度小于 $6.250$ 的核心将受限于内存带宽，而运算强度大于 $6.250$ 的核心将受限于处理器的计算能力。", "answer": "$$\\boxed{6.250}$$", "id": "3628699"}]}