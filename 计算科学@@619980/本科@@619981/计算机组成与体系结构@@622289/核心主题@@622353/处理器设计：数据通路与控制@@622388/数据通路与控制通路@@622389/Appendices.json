{"hands_on_practices": [{"introduction": "在数字系统设计中，性能与资源成本之间的权衡是一个核心主题。本练习通过一个经典场景——将并行加法器转换为串行加法器——来深入探讨这一基本权衡。通过此练习，你将量化分析一个更简单、更小的数据路径（串行）如何导致更长的执行时间（延迟），以及一个更快的数据路径（并行）如何需要更复杂的控制信号分配，从而为根本性的设计决策建立坚实的直觉。[@problem_id:3632396]", "problem": "一个处理器的数据路径当前使用一个由 $W$ 个相同的 $1$ 位全加器切片构成的 $W$ 位行波进位加法器来实现一个 $W$ 位的加法。控制路径是微编码的，并向算术逻辑单元（ALU）广播 $k$ 条功能选择控制线。在此设计中，ALU是基于切片的，这 $k$ 条线同样地扇出到 $W$ 个位切片中的每一个。您被要求重新设计数据路径以使用位串行加法器，并量化由此产生的延迟和控制路径简化增益。\n\n在位串行设计中，数据路径由一个单独的 $1$ 位全加器、两个用于保存操作数的 $W$ 位移位寄存器 $R_A$ 和 $R_B$、一个用于累加和的 $W$ 位移位寄存器 $R_S$ 以及一个单独的进位触发器 $C$ 组成。一个简单的有限状态机（FSM）控制器按如下顺序控制操作：\n- 一个初始化微操作，将进位触发器清零为 $C \\leftarrow 0$ 并准备 $R_S$ 以接收结果位。\n- 一个包含 $W$ 个相同周期的循环。在每个周期中，$R_A$ 的最低有效位（LSB）和 $R_B$ 的最低有效位（LSB）被送到全加器，产生的和位被移入 $R_S$，进位输出更新 $C$，并且 $R_A$ 和 $R_B$ 都右移 $1$ 位。\n- 一个最终的提交微操作，将 $R_S$ 的内容写入体系结构规定的目标寄存器。\n\n假设初始化和提交各消耗恰好 $1$ 个时钟周期，并且每个循环迭代也消耗恰好 $1$ 个时钟周期。将控制路径简化增益定义为原始 $W$ 位并行设计中ALU功能选择控制扇出端点总数与 $1$ 位串行设计中该数量的比值 $G$。为此，仅计算 $k$ 条ALU功能选择线及其到ALU切片的扇出端点；不包括任何其他控制或数据路径信号。\n\n仅使用行波进位加法、顺序控制和控制信号扇出的基本定义，推导：\n- 在位串行数据路径上进行一次 $W$ 位加法（包括初始化和提交）的精确延迟（以周期为单位），$L_{\\text{serial}}$。\n- 如上定义的控制路径简化增益 $G$。\n\n使用 LaTeX 的 $\\texttt{pmatrix}$ 环境将您的最终答案表示为单个行向量，其条目为 $L_{\\text{serial}}$（以周期为单位）和 $G$。不需要进行数值计算或四舍五入；请提供一个以 $W$ 和 $k$ 表示的封闭形式解析表达式。", "solution": "所述问题具有科学依据，提法明确且内容自洽，呈现了计算机组成与体系结构中的一个有效场景。所有必要的定义和条件都已提供，可以无歧义地推导出所需的量。我们开始求解。\n\n问题要求推导位串行加法器设计的两个量：以时钟周期为单位的延迟 $L_{\\text{serial}}$ 和控制路径简化增益 $G$。\n\n首先，我们推导延迟 $L_{\\text{serial}}$。问题将位串行加法描述为三个不同微操作的序列，每个操作的持续时间都以时钟周期为单位指定。总延迟是这些操作持续时间的总和。\n1.  初始化步骤，包括将进位触发器 $C$ 清零（$C \\leftarrow 0$），规定消耗恰好 $1$ 个时钟周期。\n2.  主处理循环，执行逐位加法，运行 $W$ 个相同的周期，其中 $W$ 是操作数宽度。问题规定该循环的每次迭代消耗恰好 $1$ 个时钟周期。因此，循环阶段的总时间为 $W \\times 1 = W$ 个时钟周期。\n3.  最后的提交步骤，将累加寄存器 $R_S$ 的结果写入其最终目标，规定消耗恰好 $1$ 个时钟周期。\n\n总延迟 $L_{\\text{serial}}$ 是这三个顺序阶段延迟的总和：\n$$L_{\\text{serial}} = (\\text{latency of initialization}) + (\\text{latency of loop}) + (\\text{latency of commit})$$\n代入给定值：\n$$L_{\\text{serial}} = 1 + W + 1$$\n$$L_{\\text{serial}} = W + 2$$\n因此，$W$ 位串行加法的延迟为 $W+2$ 个时钟周期。\n\n接下来，我们推导控制路径简化增益 $G$。它被定义为原始并行设计中ALU功能选择控制扇出端点总数与新的位串行设计中该数量的比值。我们必须只计算 $k$ 条ALU功能选择线连接到ALU切片的端点。\n\n在原始的并行设计中，ALU是一个由 $W$ 个相同的 $1$ 位全加器切片构成的 $W$ 位行波进位加法器。有 $k$ 条来自微编码控制路径的功能选择控制线。问题指出这 $k$ 条线“同样地扇出到 $W$ 个位切片中的每一个”。这意味着 $k$ 个控制信号中的每一个都是 $W$ 个切片中每一个的输入。扇出端点的总数是控制线数量与它们连接的切片数量的乘积。\n$$\\text{Endpoints}_{\\text{original}} = (\\text{number of control lines}) \\times (\\text{number of slices})$$\n$$\\text{Endpoints}_{\\text{original}} = k \\times W$$\n\n在新的位串行设计中，ALU由一个单独的 $1$ 位全加器组成。控制路径仍然需要向这个单一切片提供 $k$ 条功能选择线以指定操作（即使描述的唯一操作是加法，功能选择线的存在也暗示了通用的ALU架构）。因此，这 $k$ 条控制线连接到这一个切片。\n$$\\text{Endpoints}_{\\text{serial}} = (\\text{number of control lines}) \\times (\\text{number of slices})$$\n$$\\text{Endpoints}_{\\text{serial}} = k \\times 1 = k$$\n\n控制路径简化增益 $G$ 是这两个量的比值：\n$$G = \\frac{\\text{Endpoints}_{\\text{original}}}{\\text{Endpoints}_{\\text{serial}}}$$\n$$G = \\frac{k W}{k}$$\n假设 $k$ 是一个正整数，因为它代表物理控制线的数量（$k > 0$），我们可以从分子和分母中消去 $k$。\n$$G = W$$\n\n推导出的两个量是 $L_{\\text{serial}} = W + 2$ 和 $G = W$。问题要求将最终答案表示为单个行向量。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\nW + 2  W\n\\end{pmatrix}\n}\n$$", "id": "3632396"}, {"introduction": "处理控制冒险是提升流水线处理器性能的关键。本练习探讨了一种先进技术：通过在指令集架构中引入条件传送指令，将某些分支指令转换为数据流操作。这项实践将引导你分析这种架构增强带来的实际收益（减少流水线冲刷）和相应代价（增加数据路径中的多路复用硬件），从而揭示指令集、控制路径和数据路径之间的紧密联系。[@problem_id:3632345]", "problem": "一个标量流水线处理器在一个具有 $N$ 个阶段的经典流水线中获取、解码和执行指令，阶段从早到晚编号为 $\\{1, 2, \\ldots, N\\}$，其中阶段 $1$ 是指令获取。分支指令在阶段 $s_b$ 被解决，其中 $2 \\leq s_b \\leq N$。假设动态分支指令频率为 $f_b$（动态指令中分支指令所占的比例），分支预测错误率为 $r_m$（被分支预测器预测错误的分支结果所占的比例），并且一次错误预测的分支会精确地冲刷掉所有占据着严格早于解决阶段的流水线阶段中的错误路径指令。指令集架构 (ISA) 中增加了一种条件传送能力，它允许将一部分动态分支指令转换为不改变控制路径的数据流指令。具体来说，有 $p\\%$ 的动态分支被转换为条件传送指令，每条条件传送指令的执行都没有任何控制冒险惩罚，并且其延迟等于一个标准算术逻辑单元 (ALU) 操作的延迟。\n\n为了在数据通路中支持条件传送，设计上的选择是在ALU结果通路上增加一个谓词控制的 $2{:}1$ 多路复用器，该多路复用器以逐位的方式在两个源之间进行选择，并在每个寄存器文件写端口处进行复制以保持时序隔离。假设机器有 $W$ 个寄存器文件写端口，每个端口都由一个宽度为 $B$ 位的ALU结果总线的副本提供数据。基线设计不包含这些谓词控制的多路复用器。\n\n从错误预测分支的流水线冲刷和位级多路复用器的基本组合复制的根本定义出发，推导：\n\n1. 当 $p\\%$ 的动态分支被转换为条件传送时，每条已提交指令的平均控制冒险惩罚的减少量，以周期为单位表示。用 $f_b$、$r_m$、$p$ 和 $s_b$ 的符号形式表达你的答案。\n\n2. 数据通路多路复用复杂度的增加量，以支持条件传送而插入的 $2{:}1$ 位级多路复用器的总数来衡量。用 $B$ 和 $W$ 的符号形式表达你的答案。\n\n将你的最终答案以一个双元素行矩阵的形式报告，其第一个元素是每条指令的平均控制冒险惩罚的减少量（以周期为单位），第二个元素是增加的 $2{:}1$ 位级多路复用器的总数。在你的表达式中使用百分比形式的 $p$。不需要进行数值计算，也不应进行四舍五入。", "solution": "该问题要求推导两个量：控制冒险惩罚的减少量和数据通路复杂度的增加量。我们将逐一推导。\n\n**1. 平均控制冒险惩罚的减少量**\n\n首先，我们计算基线设计中的平均控制冒险惩罚。惩罚仅在分支指令被错误预测时发生。\n- **每次错误预测的惩罚**：当分支在阶段 $s_b$ 被解决时，所有在流水线中更早阶段（即 $1$ 到 $s_b-1$）的指令都必须被冲刷。这导致了 $s_b - 1$ 个周期的损失。\n- **错误预测的频率**：动态指令中分支的比例是 $f_b$，其中被错误预测的比例是 $r_m$。因此，每条指令的错误预测分支频率是 $f_b \\cdot r_m$。\n- **基线平均惩罚 ($P_{\\text{base}}$)**：\n$$ P_{\\text{base}} = (\\text{错误预测分支的频率}) \\times (\\text{每次错误预测的惩罚}) = f_b r_m (s_b - 1) $$\n\n接下来，我们引入条件传送。$p\\%$ 的动态分支被转换为数据流指令，不再是分支，因此不产生控制冒险。\n- **新的分支频率 ($f'_b$)**：只有 $(1 - \\frac{p}{100})$ 的原始分支保留下来。因此，新的动态分支频率是 $f'_b = f_b \\left(1 - \\frac{p}{100}\\right)$。\n- **新的平均惩罚 ($P_{\\text{new}}$)**：错误率和单次惩罚不变，但作用于新的、更低的分支频率。\n$$ P_{\\text{new}} = f'_b r_m (s_b - 1) = f_b \\left(1 - \\frac{p}{100}\\right) r_m (s_b - 1) $$\n\n- **惩罚的减少量 ($\\Delta P$)**：\n$$ \\Delta P = P_{\\text{base}} - P_{\\text{new}} $$\n$$ \\Delta P = f_b r_m (s_b - 1) - f_b \\left(1 - \\frac{p}{100}\\right) r_m (s_b - 1) $$\n$$ \\Delta P = f_b r_m (s_b - 1) \\left[ 1 - \\left(1 - \\frac{p}{100}\\right) \\right] $$\n$$ \\Delta P = f_b r_m (s_b - 1) \\left(\\frac{p}{100}\\right) = \\frac{p}{100} f_b r_m (s_b - 1) $$\n\n**2. 数据通路多路复用复杂度的增加**\n\n复杂度增加量以新增加的 $2:1$ 位级多路复用器的总数来衡量。\n- **每个写端口**：为了支持条件传送，需要在ALU结果通路上增加谓词控制的多路复用。由于ALU结果总线是 $B$ 位宽，并且选择是“以逐位的方式”进行的，这意味着每个写端口需要 $B$ 个 $1$ 位的 $2:1$ 多路复用器。\n- **总数**：该设计被复制到处理器的 $W$ 个寄存器文件写端口中的每一个。\n- **增加的多路复用器总数 ($M_{\\text{added}}$)**：\n$$ M_{\\text{added}} = (\\text{每个写端口的多路复用器数量}) \\times (\\text{写端口数量}) = B \\times W $$\n\n因此，最终答案的两个组成部分是 $\\frac{p}{100} f_b r_m (s_b - 1)$ 和 $BW$。", "answer": "$$\n\\boxed{\\begin{pmatrix} \\frac{p}{100} f_b r_m (s_b - 1)  B W \\end{pmatrix}}\n$$", "id": "3632345"}, {"introduction": "理论上的控制信号是即时且稳定的，但在实际的流水线中，组合逻辑产生的信号会存在瞬态“毛刺”，这可能导致灾难性的错误。本练习让你深入探究设计稳健控制逻辑的实际挑战，聚焦于处理器控制流的核心——程序计数器（PC）的选择逻辑。你需要设计一个无毛刺的控制方案，即使在原始决策信号不完美的情况下也能保证稳定、正确的操作，从而强化对同步设计原则和寄存器化控制路径重要性的理解。[@problem_id:3632388]", "problem": "一个 $5$ 级精简指令集计算机 (RISC) 流水线由指令提取 (IF)、指令译码 (ID)、执行 (EX)、访存 (MEM) 和写回 (WB) 组成。下一个程序计数器 (PC) 的值，表示为 $PC_{\\text{next}}$，由一个 $4$ 输入 $1$ 输出的多路选择器从四个来源中选择：顺序递增的 $PC+4$、计算出的分支目标 $PC_{\\text{br}}$、跳转目标 $PC_{\\text{jmp}}$ 和异常向量 $PC_{\\text{exc}}$。该多路选择器由一个宽度为 $4$ 的独热 (one-hot) 向量 $S$ 控制，其中 $S_0$ 选择 $PC+4$，$S_1$ 选择 $PC_{\\text{br}}$，$S_2$ 选择 $PC_{\\text{jmp}}$，$S_3$ 选择 $PC_{\\text{exc}}$。独热约束要求 $\\sum_{i=0}^{3} S_i = 1$，且只有一个 $S_i$ 等于 $1$。\n\n分支解析发生在 EX 阶段。EX 阶段的一个组合逻辑网络产生原始决策信号 $\\{d_{\\text{seq}}, d_{\\text{br}}, d_{\\text{jmp}}, d_{\\text{exc}}\\}$，其中 $d_{\\text{seq}}$ 表示顺序执行， $d_{\\text{br}}$ 表示分支跳转，$d_{\\text{jmp}}$ 表示无条件跳转，$d_{\\text{exc}}$ 表示异常。由于操作数到达时间和控制信号（如流水线清空和暂停）的影响，当输入稳定时，原始决策信号在周期内可能表现出动态冒险（瞬时毛刺）。处理器使用周期为 $T$ 的单相同步时钟，所有流水线寄存器在上升沿捕获数据。$PC$ 寄存器在 IF 阶段根据采样边沿之前周期内有效的多路选择器输出来更新。\n\n为 $PC$ 多路选择器设计一个无毛刺的控制路径，使得：\n- 施加到多路选择器上的选择线在驱动 $PC_{\\text{next}}$ 的整个周期内保持独热且稳定。\n- 即使在 $\\{d_{\\text{seq}}, d_{\\text{br}}, d_{\\text{jmp}}, d_{\\text{exc}}\\}$ 存在瞬态行为的情况下，也能保证互斥选择。\n- 设计必须遵循单相同步时序模型和典型的流水线流控制信号，包括 $valid$、$stall$ 和 $flush$。\n\n下列哪种控制策略满足这些要求？\n\nA. 通过将 EX 阶段的原始组合逻辑输出直接连接到 $PC$ 多路选择器来驱动它，连接方式为 $S_0 \\leftarrow d_{\\text{seq}}$，$S_1 \\leftarrow d_{\\text{br}}$，$S_2 \\leftarrow d_{\\text{jmp}}$，$S_3 \\leftarrow d_{\\text{exc}}$，并添加一个组合逻辑回退机制，使得当所有 $d$ 信号都为 $0$ 时，强制 $S_0$ 为 $1$；在 EX 和 IF 之间不插入任何寄存器。\n\nB. 在 EX 阶段通过屏蔽成对冲突来构建不相交的独热决策（例如，异常优先于所有，跳转优先于分支，分支优先于顺序执行），用 EX 阶段的 $valid$ 信号和不存在传入的 $flush$ 信号来限定它们，然后将得到的独热向量在 EX/MEM 边界寄存。在下一个周期使用该寄存后的向量来驱动 IF 阶段的 $PC$ 多路选择器，并进一步用 IF 阶段的 $stall$ 和下游的 $flush$ 进行屏蔽，以确保在驱动 $PC_{\\text{next}}$ 的周期内，$\\{S_0,S_1,S_2,S_3\\}$ 中有且仅有一个被置为有效。\n\nC. 使用优先级编码器将原始 EX 决策编码为二进制选择信号 $\\{s_1, s_0\\}$（异常最高，其次是跳转，然后是分支，最后是顺序执行），并在同一周期内将 $\\{s_1, s_0\\}$ 组合地馈送到 IF 阶段的 $PC$ 多路选择器；依赖优先级编码器来抑制冲突，而不是强制执行独热。\n\nD. 使用线或 (wired-OR) 逻辑组合 $d_{\\text{br}}$ 和 $d_{\\text{jmp}}$ 形成一个单一的“非顺序”信号，用 $d_{\\text{exc}}$ 的反相信号对其进行门控，并将此门控信号的反相作为 $S_0$；直接使用其余信号形成 $S_1$、$S_2$ 和 $S_3$，不使用任何寄存器，并假设互斥的译码使得同时断言实际上不可能。\n\nE. 用实现独热仲裁器的交叉耦合置位-复位锁存器替换 EX 组合逻辑网络，并在同一周期内将锁存器输出直接馈送到 IF 阶段的 $PC$ 多路选择器，并假设异步仲裁能确保互斥性和毛刺抑制，而无需流水线寄存器。", "solution": "问题的核心在于为位于IF阶段的程序计数器（PC）多路选择器设计一个控制路径，该路径必须从EX阶段产生的、可能带有毛刺的决策信号中，生成一个在整个时钟周期内都稳定且满足独热（one-hot）约束的选择信号。\n\n**基本原则：**\n1.  **毛刺抑制与稳定性**：在同步数字设计中，组合逻辑的输出在输入变化后会经历一个短暂的、不确定的状态，即“毛刺”。用这样的信号直接驱动多路选择器或寄存器的控制端（如选择线、时钟使能）是极其危险的，可能导致锁存错误的值。消除毛刺、保证信号在一个完整时钟周期内稳定的标准方法是，在组合逻辑的输出端放置一个同步寄存器（例如D触发器），在时钟沿对其进行采样。\n2.  **流水线时序**：决策在EX阶段做出，但PC更新发生在IF阶段。这意味着控制信号需要从一个较晚的流水线阶段（EX）反馈到一个较早的阶段（IF）。直接的组合逻辑反馈路径（从EX到IF）会很长，难以满足时序，并且会传播毛刺。因此，在EX阶段生成的控制决策必须被寄存，然后在下一个或更晚的周期中反馈。最自然的位置是在EX/MEM流水线寄存器中对决策进行寄存。\n3.  **互斥性（独热强制）**：原始决策信号 $\\{d_{\\text{seq}}, d_{\\text{br}}, d_{\\text{jmp}}, d_{\\text{exc}}\\}$ 在瞬态期间可能不互斥（例如，多个信号可能同时为高电平）。为了生成独热信号，必须通过优先级逻辑来强制互斥。一个标准的优先级顺序是：异常 > 跳转 > 分支 > 顺序执行。这个优先级逻辑本身是组合逻辑，其输出仍然会有毛刺，但能保证在稳定后是互斥的。这些经过优先级编码的信号才是应该被寄存的。\n4.  **流水线流控制**：最终的选择信号还必须考虑流水线暂停（stall）和清空（flush）等情况，确保PC在这些情况下行为正确。\n\n**选项分析：**\n\n*   **A**: 此选项失败，因为它指定“不插入任何寄存器”，直接将EX阶段带有毛刺的原始信号连接到IF阶段的多路选择器，这违反了稳定性要求。\n*   **B**: 此选项完美地遵循了所有设计原则。它首先在EX阶段使用优先级逻辑（“屏蔽成对冲突”）来创建互斥的决策。然后，它“在EX/MEM边界寄存”这些决策，这是消除毛刺并稳定信号的关键步骤。接着，它将这个稳定的、寄存后的信号从MEM阶段（即EX之后的下一个周期）反馈给IF阶段的PC多路选择器。最后，它将此信号与本地的暂停/清空信号结合，以生成最终的、在所有情况下都有效的独热控制向量。这是教科书式的正确设计。\n*   **C**: 此选项失败，因为它也使用了一条纯组合路径（“组合地馈送到IF阶段”），将EX阶段产生的信号（即使经过了优先级编码器）的毛刺直接传播到IF阶段。\n*   **D**: 此选项失败，因为它“不使用任何寄存器”，并且依赖于一个与问题前提（信号存在毛刺和动态冒险）相矛盾的错误假设（“假设互斥的译码使得同时断言实际上不可能”）。\n*   **E**: 此选项引入了异步电路（锁存器仲裁器）到同步流水线中，却没有正确的同步接口。这是一种糟糕的设计实践，因为它有亚稳态的风险，并且其“在同一周期内...直接馈送”的描述违反了同步时序原则。\n\n因此，只有选项B描述了一个鲁棒、无毛刺且符合同步流水线设计原则的控制方案。", "answer": "$$\\boxed{B}$$", "id": "3632388"}]}