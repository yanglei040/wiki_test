{"hands_on_practices": [{"introduction": "动态分支预测的一个最经典和有效的应用场景是处理程序循环。本练习 [@problem_id:3637231] 让你在一个嵌套循环的背景下，通过手动追踪状态转换，来量化分析1位和2位预测器的性能差异。通过这个实践，你将直观地理解为什么2位饱和计数器在处理循环退出分支时（通常仅在最后一次迭代时改变方向）表现得远比简单的1位预测器更为出色。", "problem": "考虑由以下伪代码定义的嵌套循环\nfor $i = 1$ to $m$:\n    for $j = 1$ to $n$:\n        body\n将控制这些循环的两个条件后向分支建模如下：内层循环的退出测试在每次外层迭代中精确执行 $n$ 次，并产生结果序列 $\\mathrm{T}, \\mathrm{T}, \\dots, \\mathrm{T}, \\mathrm{NT}$（即 $\\mathrm{T}$ 重复 $n-1$ 次，然后是 $\\mathrm{NT}$ 一次），而外层循环的退出测试在整个运行过程中精确执行 $m$ 次，并产生结果序列 $\\mathrm{T}$ 重复 $m-1$ 次，然后是 $\\mathrm{NT}$ 一次。假设每个静态分支都有其专用的预测器条目（无别名效应），并且没有其他分支。假设 $n \\geq 2$ 且 $m \\geq 2$。\n\n考虑两种动态分支预测器，每种预测器都为每个静态分支维护状态：\n1) 一个 $1$ 位预测器，它总是预测最后一次观测到的结果，并在每次预测错误时翻转其位。两个分支的初始状态都是“预测 $\\mathrm{NT}$”。\n2) 一个 $2$ 位饱和计数器预测器，具有 $4$ 个状态：强不跳转 ($00$)、弱不跳转 ($01$)、弱跳转 ($10$)、强跳转 ($11$)。最高有效位决定预测结果（$0$ 表示 $\\mathrm{NT}$，$1$ 表示 $\\mathrm{T}$）。当结果为 $\\mathrm{T}$ 时，计数器加 $1$ 直到在 $11$ 处饱和；当结果为 $\\mathrm{NT}$ 时，计数器减 $1$ 直到在 $00$ 处饱和。两个分支的初始状态都是弱不跳转 ($01$)。\n\n从这些定义和循环结果模式出发，根据第一性原理推导出每种预测器在嵌套循环整个执行过程中的总预测错误次数，将内层循环和外层循环退出分支的贡献相加。将你的最终答案表示为一个单行矩阵，其第一个条目是 $1$ 位预测器下的总预测错误次数，第二个条目是 $2$ 位预测器下的总预测错误次数。无需四舍五入。你的最终表达式应为关于 $m$ 和 $n$ 的封闭形式。", "solution": "该问题已经过验证，被认为在计算机组成与体系结构领域内是合理的、定义明确的，且具有科学依据。它提供了一套完整且一致的定义和约束，足以推导出唯一解。我们继续进行分析。\n\n总预测错误次数是内层循环分支和外层循环分支的预测错误次数之和。我们将分别分析每种预测器。\n\n### $1$ 位预测器分析\n\n$1$ 位预测器有两个状态：预测跳转 ($\\mathrm{P_T}$) 和预测不跳转 ($\\mathrm{P_{NT}}$)。预测器在预测错误时翻转其状态。对于内层和外层循环分支，初始状态都给定为“预测 $\\mathrm{NT}$”，对应于状态 $\\mathrm{P_{NT}}$。\n\n#### 使用 $1$ 位预测器的内层循环分支\n内层循环的结果序列 $\\mathrm{T}, \\mathrm{T}, \\dots, \\mathrm{T}, \\mathrm{NT}$（$n-1$ 次 $\\mathrm{T}$，然后一次 $\\mathrm{NT}$）被执行 $m$ 次。我们分析该序列一次完整执行的行为。\n\n让我们追踪第一次外层循环迭代（$i=1$）：\n- 内层循环分支的预测器初始状态为 $\\mathrm{P_{NT}}$。\n- **第 1 次执行：** 结果是 $\\mathrm{T}$。预测是 $\\mathrm{NT}$。这是一次 **预测错误**。状态翻转为 $\\mathrm{P_T}$。\n- **第 2 到 $n-1$ 次执行：** 结果总是 $\\mathrm{T}$。现在的预测是 $\\mathrm{T}$。这些都是正确的预测。状态保持为 $\\mathrm{P_T}$。\n- **第 $n$ 次执行：** 结果是 $\\mathrm{NT}$。预测是 $\\mathrm{T}$。这是一次 **预测错误**。状态翻转回 $\\mathrm{P_{NT}}$。\n\n对于外层循环的第一次迭代，内层循环分支产生 $2$ 次预测错误。在这次迭代结束时，预测器状态为 $\\mathrm{P_{NT}}$。\n\n对于随后的每次外层循环迭代（从 $i=2$ 到 $m$），内层循环分支的预测器都从状态 $\\mathrm{P_{NT}}$ 重新开始。因此，对于 $m$ 次外层循环迭代中的每一次，分析都是相同的。每次执行内层循环时，它都会产生恰好 $2$ 次预测错误。\n\n在 $m$ 次外层循环迭代中，内层循环分支的总预测错误次数 = $2 \\times m = 2m$。\n\n#### 使用 $1$ 位预测器的外层循环分支\n外层循环分支的结果序列是 $\\mathrm{T}, \\mathrm{T}, \\dots, \\mathrm{T}, \\mathrm{NT}$（$m-1$ 次 $\\mathrm{T}$，然后一次 $\\mathrm{NT}$）。这个序列只执行一次。\n\n- 外层循环分支的预测器初始状态为 $\\mathrm{P_{NT}}$。\n- **第 1 次执行：** 结果是 $\\mathrm{T}$。预测是 $\\mathrm{NT}$。这是一次 **预测错误**。状态翻转为 $\\mathrm{P_T}$。\n- **第 2 到 $m-1$ 次执行：** 结果总是 $\\mathrm{T}$。预测是 $\\mathrm{T}$。这些都是正确的预测。状态保持为 $\\mathrm{P_T}$。\n- **第 $m$ 次执行：** 结果是 $\\mathrm{NT}$。预测是 $\\mathrm{T}$。这是一次 **预测错误**。状态翻转回 $\\mathrm{P_{NT}}$。\n\n外层循环分支的总预测错误次数为 $2$。\n\n#### $1$ 位预测器的总预测错误次数\n总预测错误次数 $M_1$ 是两个分支的预测错误次数之和。\n$$M_1 = (\\text{内层循环预测错误次数}) + (\\text{外层循环预测错误次数}) = 2m + 2$$\n\n### $2$ 位饱和计数器预测器分析\n\n$2$ 位预测器使用一个 $4$ 状态的饱和计数器：$00$ (强不跳转, $\\mathrm{SN}$), $01$ (弱不跳转, $\\mathrm{WN}$), $10$ (弱跳转, $\\mathrm{WT}$), 和 $11$ (强跳转, $\\mathrm{ST}$)。对于状态 $00$ 和 $01$ (最高有效位为 $0$)，预测为 $\\mathrm{NT}$；对于状态 $10$ 和 $11$ (最高有效位为 $1$)，预测为 $\\mathrm{T}$。当结果为 $\\mathrm{T}$ 时，计数器递增（在 $11$ 处饱和）；当结果为 $\\mathrm{NT}$ 时，计数器递减（在 $00$ 处饱和）。两个分支的初始状态都是 $01$ ($\\mathrm{WN}$)。\n\n#### 使用 $2$ 位预测器的内层循环分支\n我们追踪第一次及后续外层循环迭代的行为。\n\n对于第一次外层循环迭代（$i=1$）：\n- 预测器初始状态为 $01$ ($\\mathrm{WN}$)，预测 $\\mathrm{NT}$。\n- **第 1 次执行：** 结果是 $\\mathrm{T}$。预测是 $\\mathrm{NT}$。这是一次 **预测错误**。状态递增到 $10$ ($\\mathrm{WT}$)。\n- **第 2 次执行：** 结果是 $\\mathrm{T}$。状态是 $10$ ($\\mathrm{WT}$)，预测 $\\mathrm{T}$。这是一次正确的预测。状态递增到 $11$ ($\\mathrm{ST}$)。\n- **第 3 到 $n-1$ 次执行：** 结果是 $\\mathrm{T}$。状态是 $11$ ($\\mathrm{ST}$)，预测 $\\mathrm{T}$。这些都是正确的预测。由于饱和，状态保持为 $11$。\n- **第 $n$ 次执行：** 结果是 $\\mathrm{NT}$。状态是 $11$ ($\\mathrm{ST}$)，预测 $\\mathrm{T}$。这是一次 **预测错误**。状态递减到 $10$ ($\\mathrm{WT}$)。\n\n对于外层循环的第一次迭代（$i=1$），内层循环分支产生 $2$ 次预测错误。在这次迭代结束时，预测器状态为 $10$ ($\\mathrm{WT}$)。\n\n对于第二次外层循环迭代（$i=2$）：\n- 预测器从上一次迭代结束时的状态 $10$ ($\\mathrm{WT}$) 开始，预测 $\\mathrm{T}$。\n- **第 1 次执行：** 结果是 $\\mathrm{T}$。预测是 $\\mathrm{T}$。这是一次正确的预测。状态递增到 $11$ ($\\mathrm{ST}$)。\n- **第 2 到 $n-1$ 次执行：** 结果是 $\\mathrm{T}$。状态是 $11$ ($\\mathrm{ST}$)，预测 $\\mathrm{T}$。这些都是正确的预测。状态保持为 $11$。\n- **第 $n$ 次执行：** 结果是 $\\mathrm{NT}$。状态是 $11$ ($\\mathrm{ST}$)，预测 $\\mathrm{T}$。这是一次 **预测错误**。状态递减到 $10$ ($\\mathrm{WT}$)。\n\n对于第二次迭代（$i=2$），只有 $1$ 次预测错误。迭代结束时，预测器状态再次变为 $10$ ($\\mathrm{WT}$)。\n这个模式对从 $i=2$ 到 $m$ 的所有后续迭代都重复。这 $m-1$ 次迭代中的每一次都将从状态 $10$ 开始，并产生恰好 $1$ 次预测错误。\n\n内层循环分支的总预测错误次数：\n$$(\\text{$i=1$ 的预测错误次数}) + (\\text{$i=2$ 到 $m$ 的预测错误次数})$$\n$$2 + (m-1) \\times 1 = 2 + m - 1 = m+1$$\n\n#### 使用 $2$ 位预测器的外层循环分支\n结果序列为 $\\mathrm{T}, \\mathrm{T}, \\dots, \\mathrm{T}, \\mathrm{NT}$（$m-1$ 次 $\\mathrm{T}$，一次 $\\mathrm{NT}$）。\n- 预测器初始状态为 $01$ ($\\mathrm{WN}$)，预测 $\\mathrm{NT}$。\n- **第 1 次执行：** 结果是 $\\mathrm{T}$。预测是 $\\mathrm{NT}$。这是一次 **预测错误**。状态递增到 $10$ ($\\mathrm{WT}$)。\n- **第 2 次执行：** 结果是 $\\mathrm{T}$。状态是 $10$ ($\\mathrm{WT}$)，预测 $\\mathrm{T}$。这是一次正确的预测。状态递增到 $11$ ($\\mathrm{ST}$)。因为 $m \\geq 2$，所以这一步成立。\n- **第 3 到 $m-1$ 次执行：** 结果是 $\\mathrm{T}$。状态是 $11$ ($\\mathrm{ST}$)，预测 $\\mathrm{T}$。这些都是正确的预测。状态保持为 $11$。\n- **第 $m$ 次执行：** 结果是 $\\mathrm{NT}$。状态是 $11$ ($\\mathrm{ST}$)，预测 $\\mathrm{T}$。这是一次 **预测错误**。状态递减到 $10$ ($\\mathrm{WT}$)。\n\n外层循环分支的总预测错误次数为 $2$。\n\n#### $2$ 位预测器的总预测错误次数\n总预测错误次数 $M_2$ 是两个分支的预测错误次数之和。\n$$M_2 = (\\text{内层循环预测错误次数}) + (\\text{外层循环预测错误次数}) = (m+1) + 2 = m+3$$\n\n### 总结\n- $1$ 位预测器的总预测错误次数：$M_1 = 2m + 2$。\n- $2$ 位预测器的总预测错误次数：$M_2 = m + 3$。\n\n最终答案以行矩阵 $[M_1, M_2]$ 的形式呈现。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n2m+2 & m+3\n\\end{pmatrix}\n}\n$$", "id": "3637231"}, {"introduction": "在理解了预测器在循环上的行为后，我们可以将问题泛化，以探索它们在任何简单周期性分支模式下的性能。这个练习 [@problem_id:3637265] 要求你为一个重复的 $T^aN^b$ （连续 $a$ 次“跳转”后跟连续 $b$ 次“不跳转”）模式推导出稳态误判率的闭式解。这项任务将训练你从逐步追踪转向稳态分析的思维方式，揭示预测器性能如何依赖于分支行为的底层参数。", "problem": "程序中反复遇到一个静态条件分支。其结果遵循一个周期性模式：分支连续 $a$ 次执行为“跳转”(Taken)，然后连续 $b$ 次执行为“不跳转”(Not Taken)，并且这种 $T^aN^b$ 模式无限重复。假设 $a$ 和 $b$ 均为正整数。考虑两种动态分支预测器：\n\n1. 一个 1 位最后结果预测器，它总是预测下一个结果与最近一次的结果相同。将其初始化，使得在第一次实际结果出现之前的首次预测为“不跳转”。\n\n2. 一个 2 位饱和计数器预测器，具有四种状态：强烈不跳转 ($0$)、微弱不跳转 ($1$)、微弱跳转 ($2$) 和强烈跳转 ($3$)。当预测器处于状态 $0$ 或 $1$ 时，预测为“不跳转”；当处于状态 $2$ 或 $3$ 时，预测为“跳转”。当实际结果为“跳转”时，计数器加 1，除非已达到 $3$；当实际结果为“不跳转”时，计数器减 1，除非已达到 $0$。在第一次实际结果出现之前，将计数器初始化为“强烈不跳转”($0$)。\n\n从这些初始状态开始，并让模式无限重复以至于任何初始瞬态都可以忽略不计，推导两种预测器在一个完整周期内每个结果的稳态平均误判率的闭式解析表达式，表达式应为关于 $a$ 和 $b$ 的函数。将每个误判率表示为关于 $a$ 和 $b$ 的无量纲分数。最终答案必须是一个计算过程，并包含两种预测器各自的表达式。无需四舍五入。", "solution": "该问题要求在给定周期性分支结果模式的情况下，为两种动态分支预测器推导稳态平均误判率。该模式包含连续 $a$ 次“跳转”（$T$）结果，随后是连续 $b$ 次“不跳转”（$N$）结果，以 $T^aN^b$ 的形式重复。一个完整周期内的总结果数为 $a+b$。平均误判率是在一个稳态周期内的总误判数除以该周期内的总结果数。\n\n**1. 对 1 位最后结果预测器的分析**\n\n该预测器有两种状态，可用最后一次的结果表示：$T$ 或 $N$。对下一个分支的预测是上一次结果的重复。题目要求的是稳态率，这意味着我们可以分析单个 $T^aN^b$ 周期，并假设系统已经度过了任何初始瞬态。一个周期开始时预测器的状态由前一个周期的最后结果决定。\n\n我们来分析一个稳态周期 $T_1, T_2, \\dots, T_a, N_1, N_2, \\dots, N_b$。\n该周期之前的结果是前一个周期的 $N_b$。因此，在观察到 $T_1$ 之前，预测器的状态是 $N$。\n\n- **对于 $T^a$ 序列：**\n  - 第一个分支是 $T_1$。预测器状态为 $N$，因此预测为“不跳转”。实际结果是“跳转”。这是一次**误判**。预测器状态更新为 $T$。\n  - 对于随后的 $a-1$ 个分支（$T_2, \\dots, T_a$），预测器状态为 $T$。它对所有这些分支都正确预测为“跳转”。\n  - 在 $T^a$ 序列中的误判次数：$1$。这对任何正整数 $a \\ge 1$ 都成立。\n\n- **对于 $N^b$ 序列：**\n  - 该序列在上一次“跳转”分支 $T_a$ 之后开始。此时预测器的状态为 $T$。\n  - 该序列的第一个分支是 $N_1$。预测器状态为 $T$，因此预测为“跳转”。实际结果是“不跳转”。这是一次**误判**。预测器状态更新为 $N$。\n  - 对于随后的 $b-1$ 个分支（$N_2, \\dots, N_b$），预测器状态为 $N$。它对所有这些分支都正确预测为“不跳转”。\n  - 在 $N^b$ 序列中的误判次数：$1$。这对任何正整数 $b \\ge 1$ 都成立。\n\n在一个完整的稳态周期中，“跳转”块的开始处有一次误判，“不跳转”块的开始处有一次误判。\n每个周期的总误判数，$M_1 = 1 + 1 = 2$。\n每个周期的总结果数是 $a+b$。\n1 位预测器的稳态误判率 $R_1$ 为：\n$$R_1 = \\frac{M_1}{a+b} = \\frac{2}{a+b}$$\n\n**2. 对 2 位饱和计数器预测器的分析**\n\n该预测器使用一个 4 状态计数器：$0$（强烈不跳转，SN）、$1$（微弱不跳转，WN）、$2$（微弱跳转，WT）和 $3$（强烈跳转，ST）。\n- 预测：状态为 $0, 1$ 时预测“不跳转”；状态为 $2, 3$ 时预测“跳转”。\n- 状态更新：当结果为“跳转”时，状态 $C$ 变为 $\\min(C+1, 3)$。当结果为“不跳转”时，状态 $C$ 变为 $\\max(C-1, 0)$。\n\n为了找到稳态误判率，我们必须首先确定一个周期开始时计数器的状态。设 $C_{start}$ 为 $T^a$ 序列开始时计数器的状态。在稳态下，这必定是前一个 $N^b$ 序列完成后的状态。设 $C_{mid}$ 为 $T^a$ 序列之后的状态。\n\n一个完整周期内的状态转换如下：\n1. 经过 $a$ 次“跳转”结果后，状态从 $C_{start}$ 转换到 $C_{mid} = \\min(3, C_{start} + a)$。\n2. 经过 $b$ 次“不跳转”结果后，状态从 $C_{mid}$ 转换回 $C_{start} = \\max(0, C_{mid} - b)$。\n\n将这两者结合起来，得到稳态起始状态 $C_{start}$ 的一个不动点方程：\n$$C_{start} = \\max(0, \\min(3, C_{start} + a) - b)$$\n我们通过考虑 $a$ 和 $b$ 的不同情况来求解 $C_{start}$（它必须是 $\\{0, 1, 2, 3\\}$ 中的一个整数）。如果 $C_{start}' = \\max(0, \\min(3, C_{start} + a) - b)$ 意味着 $C_{start}' = C_{start}$，则达到了一个稳定的不动点 $C_{start}$。\n对此方程的分析得出以下稳态起始状态：\n- 如果 $b=1, a \\ge 2$：$C_{start}=2$。\n- 如果 $b=2, a \\ge 3$：$C_{start}=1$。\n- 其他情况：$C_{start}=0$。这涵盖了 ($a=1, \\forall b \\ge 1$)、（$a=2, b \\ge 2$）和（$a \\ge 3, b \\ge 3$）这些情况。\n\n确定了 $C_{start}$ 后，我们可以计算周期中每个部分的误判次数。\n- $T^a$ 序列期间的误判 ($M_T$)：当预测器状态为 $0$ 或 $1$ 时发生。从 $C_{start}$ 开始，每次“跳转”分支状态都会增加。误判次数是状态达到 $2$ 所需的步数。\n  - 如果 $C_{start}=0$，状态为 $0 \\to 1 \\to 2 \\dots$。前两个分支会发生误判（如果 $a \\ge 2$）。$M_T = \\min(a, 2)$。\n  - 如果 $C_{start}=1$，状态为 $1 \\to 2 \\to 3 \\dots$。第一个分支发生一次误判。$M_T = 1$（因为 $a \\ge 1$）。\n  - 如果 $C_{start} \\ge 2$，预测器已经处于“跳转”状态，因此没有误判。$M_T = 0$。\n\n- $N^b$ 序列期间的误判 ($M_N$)：当预测器状态为 $2$ 或 $3$ 时发生。此序列开始时的状态是 $C_{mid} = \\min(3, C_{start}+a)$。误判次数是状态递减到 $1$ 所需的步数。\n  - 如果 $C_{mid}=3$，状态为 $3 \\to 2 \\to 1 \\dots$。前两个分支会发生误判（如果 $b \\ge 2$）。$M_N = \\min(b, 2)$。\n  - 如果 $C_{mid}=2$，状态为 $2 \\to 1 \\to 0 \\dots$。第一个分支发生一次误判。$M_N = 1$（因为 $b \\ge 1$）。\n  - 如果 $C_{mid} \\le 1$，预测器已经处于“不跳转”状态，因此没有误判。$M_N = 0$。\n\n现在我们为每种 $(a,b)$ 的情况计算总误判数，$M_2 = M_T+M_N$：\n\n- **情况 A：$a=1, \\forall b \\ge 1$。**\n  $C_{start}=0$，所以 $C_{mid}=\\min(3, 0+1)=1$。\n  $M_T = \\min(1,2)=1$。由于 $C_{mid}=1$，所以 $M_N=0$。\n  $M_2 = 1+0=1$。\n\n- **情况 B：$b=1, a \\ge 2$。**\n  $C_{start}=2$，所以 $C_{mid}=\\min(3, 2+a)=3$（因为 $a\\ge2$）。\n  由于 $C_{start}=2$，所以 $M_T = 0$。$M_N=\\min(1,2)=1$。\n  $M_2 = 0+1=1$。\n\n- **情况 C：$a=2, b \\ge 2$。**\n  $C_{start}=0$，所以 $C_{mid}=\\min(3, 0+2)=2$。\n  $M_T = \\min(2,2)=2$。由于 $C_{mid}=2$，所以 $M_N=1$。\n  $M_2 = 2+1=3$。\n\n- **情况 D：$a \\ge 3, b=2$。**\n  $C_{start}=1$，所以 $C_{mid}=\\min(3, 1+a)=3$（因为 $a\\ge3$）。\n  由于 $C_{start}=1$，所以 $M_T=1$。$M_N=\\min(2,2)=2$。\n  $M_2 = 1+2=3$。\n\n- **情况 E：$a \\ge 3, b \\ge 3$。**\n  $C_{start}=0$，所以 $C_{mid}=\\min(3, 0+a)=3$（因为 $a\\ge3$）。\n  $M_T=\\min(a,2)=2$。$M_N=\\min(b,2)=2$。\n  $M_2 = 2+2=4$。\n\n总误判数 $M_2$ 可以总结为关于 $a$ 和 $b$ 的分段函数：\n$$M_2(a,b) = \\begin{cases} 1  \\text{若 } a=1 \\text{ 或 } b=1 \\\\ 3  \\text{若 } (a=2 \\text{ 且 } b \\ge 2) \\text{ 或 } (a \\ge 3 \\text{ 且 } b=2) \\\\ 4  \\text{若 } a \\ge 3 \\text{ 且 } b \\ge 3 \\end{cases}$$\n因此，2 位预测器的误判率 $R_2$ 为：\n$$R_2 = \\frac{M_2(a,b)}{a+b}$$\n\n所需的两个表达式是 $R_1$ 和 $R_2$。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{2}{a+b} \\\\\n\\frac{1}{a+b} \\times \\begin{cases} 1  & \\text{若 } a=1 \\text{ 或 } b=1 \\\\ 3  & \\text{若 } (a=2 \\text{ 且 } b \\ge 2) \\text{ 或 } (a \\ge 3 \\text{ 且 } b=2) \\\\ 4  & \\text{若 } a \\ge 3 \\text{ 且 } b \\ge 3 \\end{cases}\n\\end{pmatrix}\n}\n$$", "id": "3637265"}, {"introduction": "历史总会重演吗？动态分支预测的核心假设是“会”。但如果分支结果完全随机，没有任何规律可循，预测器又将表现如何？本练习 [@problem_id:3637335] 构建了一个分支结果完全随机（跳转和不跳转的概率均为 $1/2$）的理想化思想实验。通过分析这个场景，你将发现动态预测器的性能极限，并理解为什么对于不可预测的事件流，复杂的历史预测机制并不比简单的静态猜测（例如，总是预测“跳转”）更优越。", "problem": "考虑一个单个条件分支，其方向由一个输入字的奇偶性决定，该输入字在每个动态实例上都是均匀随机的。将动态分支结果建模为一个独立同分布 (i.i.d.) 序列 $\\{X_{n}\\}_{n \\ge 1}$，其中 $X_{n} \\in \\{0,1\\}$，$X_{n}=1$ 表示“执行”(Taken)，$X_{n}=0$ 表示“不执行”(Not Taken)，并且对于所有 $n$，$\\Pr(X_{n}=1)=\\Pr(X_{n}=0)=\\frac{1}{2}$。设错误预测率为在前 $N$ 个结果中错误预测的比例，当 $N \\to \\infty$ 时的极限（如果存在）。\n\n该单个分支使用三个预测器：\n1. 一个一位预测器，它存储最后一次观测到的结果，并总是为下一个实例预测该结果。观测到 $X_{n}$ 后，存储的位更新为 $X_{n}$。\n2. 一个两位饱和计数器，具有 4 个状态，索引为 $0,1,2,3$，其中状态 $0$ 和 $1$ 预测“不执行”，状态 $2$ 和 $3$ 预测“执行”。当观测到“执行”结果时，计数器加 1，除非它已经是 3；当观测到“不执行”结果时，计数器减 1，除非它已经是 0。\n3. 一个静态“总是执行”预测器，它总是预测“执行”。\n\n假设任何初始预测器状态是任意但固定的，并考虑在所述 i.i.d. 分支结果模型下的稳态行为。计算一位预测器、两位饱和计数器预测器和静态“总是执行”预测器的期望稳态错误预测率。将您的最终答案表示为单个行矩阵 $\\bigl[m_{1\\text{-bit}} \\; m_{2\\text{-bit}} \\; m_{\\text{static}}\\bigr]$，其中每个条目是相应错误预测率的精确值，写成最简分数形式。无需四舍五入。", "solution": "该问题要求在特定的分支结果随机模型下，计算三种不同分支预测器的稳态错误预测率。分支结果构成一个独立同分布 (i.i.d.) 序列 $\\{X_n\\}_{n \\ge 1}$，其中 $X_n=1$（执行）和 $X_n=0$（不执行）各自以概率 $\\Pr(X_n=1) = \\Pr(X_n=0) = \\frac{1}{2}$ 发生。错误预测率定义为长期平均的错误预测比例。对于一个遍历系统，这等价于稳态下发生错误预测的期望概率。\n\n我们将分别分析每个预测器。\n\n1.  **一位预测器 ($m_{1\\text{-bit}}$)**\n\n    该预测器有两个状态，对应于最后一次观测到的结果。设时间步 $t$ 的状态 $S_t$ 是时间步 $t-1$ 的分支结果，即 $S_t = X_{t-1}$。\n    - 状态 $S_{p,0}$：最后一次结果是“不执行”($X_{t-1}=0$)。对 $X_t$ 的预测是“不执行”($0$)。\n    - 状态 $S_{p,1}$：最后一次结果是“执行”($X_{t-1}=1$)。对 $X_t$ 的预测是“执行”($1$)。\n\n    这些状态之间的转换构成一个马尔可夫链。设 $\\pi_0$ 和 $\\pi_1$ 分别为处于状态 $S_{p,0}$ 和 $S_{p,1}$ 的稳态概率。\n    如果下一个结果是 $0$，系统会从任何状态转换到 $S_{p,0}$，其发生概率为 $\\frac{1}{2}$。\n    如果下一个结果是 $1$，系统会从任何状态转换到 $S_{p,1}$，其发生概率为 $\\frac{1}{2}$。\n\n    稳态平衡方程为：\n    $$ \\pi_0 = (\\pi_0 + \\pi_1) \\cdot \\Pr(X_n=0) = 1 \\cdot \\frac{1}{2} = \\frac{1}{2} $$\n    $$ \\pi_1 = (\\pi_0 + \\pi_1) \\cdot \\Pr(X_n=1) = 1 \\cdot \\frac{1}{2} = \\frac{1}{2} $$\n    和为 $\\pi_0 + \\pi_1 = \\frac{1}{2} + \\frac{1}{2} = 1$，符合要求。因此，在稳态下，预测器处于任一状态的概率相等。\n\n    错误预测率 $m_{1\\text{-bit}}$ 是每个状态下错误预测概率的加权平均值。\n    - 在状态 $S_{p,0}$，预测为 $0$。如果结果是 $1$，则发生错误预测。其概率为 $\\Pr(X_n=1) = \\frac{1}{2}$。\n    - 在状态 $S_{p,1}$，预测为 $1$。如果结果是 $0$，则发生错误预测。其概率为 $\\Pr(X_n=0) = \\frac{1}{2}$。\n\n    总错误预测率为：\n    $$ m_{1\\text{-bit}} = \\pi_0 \\cdot \\Pr(\\text{mispredict}|S_{p,0}) + \\pi_1 \\cdot \\Pr(\\text{mispredict}|S_{p,1}) $$\n    $$ m_{1\\text{-bit}} = \\frac{1}{2} \\cdot \\frac{1}{2} + \\frac{1}{2} \\cdot \\frac{1}{2} = \\frac{1}{4} + \\frac{1}{4} = \\frac{1}{2} $$\n\n2.  **两位饱和计数器预测器 ($m_{2\\text{-bit}}$)**\n\n    该预测器使用一个 4 状态机，其状态索引为 $\\{0, 1, 2, 3\\}$。\n    - 预测规则：状态 $0, 1$ 预测“不执行”($0$)。状态 $2, 3$ 预测“执行”($1$)。\n    - 更新规则：当结果为“执行”($1$)时，状态 $i$ 转换到 $\\min(i+1, 3)$。当结果为“不执行”($0$)时，状态 $i$ 转换到 $\\max(i-1, 0)$。\n\n    设 $\\pi_i$ 为处于状态 $i$ 的稳态概率。执行和不执行的转换概率均为 $\\frac{1}{2}$。稳态平衡方程为（令流入一个状态的流量等于流出该状态的流量）：\n    - 对于状态 $0$：流出量为 $\\pi_0 \\cdot \\frac{1}{2}$（到状态 $1$）。流入量为 $\\pi_1 \\cdot \\frac{1}{2}$（从状态 $1$）和 $\\pi_0 \\cdot \\frac{1}{2}$（从状态 $0$）。\n      $$ \\pi_0 \\cdot \\frac{1}{2} + \\pi_0 \\cdot \\frac{1}{2} = \\pi_0 \\cdot \\frac{1}{2} + \\pi_1 \\cdot \\frac{1}{2} \\implies \\pi_0 \\cdot \\frac{1}{2} = \\pi_1 \\cdot \\frac{1}{2} \\implies \\pi_0 = \\pi_1 $$\n    - 对于状态 $1$：流出量为 $\\pi_1 \\cdot \\frac{1}{2} + \\pi_1 \\cdot \\frac{1}{2} = \\pi_1$。流入量来自状态 $0$（$\\pi_0 \\cdot \\frac{1}{2}$）和状态 $2$（$\\pi_2 \\cdot \\frac{1}{2}$）。\n      $$ \\pi_1 = \\pi_0 \\cdot \\frac{1}{2} + \\pi_2 \\cdot \\frac{1}{2} $$\n      代入 $\\pi_0 = \\pi_1$，我们得到 $\\pi_1 = \\pi_1 \\cdot \\frac{1}{2} + \\pi_2 \\cdot \\frac{1}{2}$，可简化为 $\\pi_1 \\cdot \\frac{1}{2} = \\pi_2 \\cdot \\frac{1}{2}$，因此 $\\pi_1 = \\pi_2$。\n    - 对于状态 $3$：根据与状态 $0$ 的对称性，流出量为 $\\pi_3 \\cdot \\frac{1}{2}$（到状态 $2$）。流入量来自状态 $2$（$\\pi_2 \\cdot \\frac{1}{2}$）和状态 $3$（$\\pi_3 \\cdot \\frac{1}{2}$）。\n      $$ \\pi_3 = \\pi_2 \\cdot \\frac{1}{2} + \\pi_3 \\cdot \\frac{1}{2} \\implies \\pi_3 \\cdot \\frac{1}{2} = \\pi_2 \\cdot \\frac{1}{2} \\implies \\pi_3 = \\pi_2 $$\n\n    综合这些结果，我们得到 $\\pi_0 = \\pi_1 = \\pi_2 = \\pi_3$。\n    使用归一化条件 $\\sum_{i=0}^{3} \\pi_i = 1$：\n    $$ \\pi_0 + \\pi_1 + \\pi_2 + \\pi_3 = 4\\pi_0 = 1 \\implies \\pi_0 = \\frac{1}{4} $$\n    因此，$\\pi_0 = \\pi_1 = \\pi_2 = \\pi_3 = \\frac{1}{4}$。预测器处于四个状态中任何一个的概率都相等。\n\n    现在，我们计算错误预测率 $m_{2\\text{-bit}}$。\n    - 在状态 $0$ 和 $1$，预测为“不执行”($0$)。当结果为“执行”($1$)时发生错误预测，概率为 $\\frac{1}{2}$。\n    - 在状态 $2$ 和 $3$，预测为“执行”($1$)。当结果为“不执行”($0$)时发生错误预测，概率为 $\\frac{1}{2}$。\n\n    总错误预测率为：\n    $$ m_{2\\text{-bit}} = \\sum_{i=0}^{3} \\pi_i \\cdot \\Pr(\\text{mispredict}|\\text{state } i) $$\n    $$ m_{2\\text{-bit}} = (\\pi_0 + \\pi_1) \\cdot \\Pr(X_n=1) + (\\pi_2 + \\pi_3) \\cdot \\Pr(X_n=0) $$\n    $$ m_{2\\text{-bit}} = \\left(\\frac{1}{4} + \\frac{1}{4}\\right) \\cdot \\frac{1}{2} + \\left(\\frac{1}{4} + \\frac{1}{4}\\right) \\cdot \\frac{1}{2} $$\n    $$ m_{2\\text{-bit}} = \\frac{1}{2} \\cdot \\frac{1}{2} + \\frac{1}{2} \\cdot \\frac{1}{2} = \\frac{1}{4} + \\frac{1}{4} = \\frac{1}{2} $$\n\n3.  **静态“总是执行”预测器 ($m_{\\text{static}}$)**\n\n    该预测器没有动态状态。它总是预测“执行”($1$)。\n    当且仅当实际的分支结果是“不执行”($0$)时，才会发生错误预测。\n    “不执行”结果的概率给定为 $\\Pr(X_n=0) = \\frac{1}{2}$。\n    由于分支结果是 i.i.d. 的，根据大数定律，长期的错误预测比例将收敛到这个概率。\n    因此，稳态错误预测率为：\n    $$ m_{\\text{static}} = \\Pr(X_n=0) = \\frac{1}{2} $$\n\n    最终结果是这三种错误预测率的汇总。该问题突出了一个基本概念：对于一个概率相等的、完全随机的 i.i.d. 分支流，任何基于历史的预测器都无法比静态预测或随机猜测表现得更好，因为没有可供学习的模式。\n\n最终结果汇总：\n- $m_{1\\text{-bit}} = \\frac{1}{2}$\n- $m_{2\\text{-bit}} = \\frac{1}{2}$\n- $m_{\\text{static}} = \\frac{1}{2}$\n\n所要求的答案是行矩阵 $\\bigl[m_{1\\text{-bit}} \\; m_{2\\text{-bit}} \\; m_{\\text{static}}\\bigr]$。\n$$ \\begin{pmatrix} \\frac{1}{2} & \\frac{1}{2} & \\frac{1}{2} \\end{pmatrix} $$", "answer": "$$\n\\boxed{\\begin{pmatrix} \\frac{1}{2} & \\frac{1}{2} & \\frac{1}{2} \\end{pmatrix}}\n$$", "id": "3637335"}]}