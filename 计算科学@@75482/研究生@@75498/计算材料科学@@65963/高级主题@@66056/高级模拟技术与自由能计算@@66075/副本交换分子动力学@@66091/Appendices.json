{"hands_on_practices": [{"introduction": "副本交换分子动力学方法的核心在于副本间的交换移动。为了确保整个扩展系综能够正确地采样正则分布，交换必须满足细致平衡条件。本练习将引导你从统计力学的基本原理出发，推导决定交换是否被接受的Metropolis-Hastings准则，这是理解副本交换如何有效跨越能量势垒的理论基石。", "problem": "考虑一个分子系统的两个独立副本，每个副本都由相同的哈密顿量控制，并与一个恒温器耦合，使得每个副本中的系统都处于温度为 $T$ 的正则系综中。在副本交换分子动力学（REMD）和并行退火（PT）中，人们为两个分别处于温度 $T_1$ 和 $T_2$ 的副本构建一个联合系综，其联合平衡密度正比于玻尔兹曼因子的乘积。提议一个温度交换移动，该移动交换两个副本的温度，同时保持它们的微观构型不变。假设交换的提议机制是对称的。从正则分布的定义和细致平衡原理出发，推导该温度交换移动的 Metropolis–Hastings 接受概率，该概率是提议交换时刻与两个构型相关的瞬时势能 $E_1$ 和 $E_2$ 的函数。\n\n然后，针对以下特定情况计算此接受概率：$T_1 = 300\\,\\mathrm{K}$，$T_2 = 450\\,\\mathrm{K}$，$E_1 = -25.0\\,\\mathrm{kJ\\,mol^{-1}}$，以及 $E_2 = -20.0\\,\\mathrm{kJ\\,mol^{-1}}$。使用摩尔气体常数 $R = 8.314462618\\,\\mathrm{J\\,mol^{-1}\\,K^{-1}}$ 以及适用于以每摩尔表示的能量的逆温度定义 $\\beta_i = 1/(R T_i)$。将最终的接受概率表示为一个无量纲数。将最终数值答案四舍五入到四位有效数字。", "solution": "对于构型为 $x$、势能为 $E(x)$、逆温度为 $\\beta$ 的单个副本，其正则平衡分布正比于 $\\exp(-\\beta E(x))$。对于两个独立的副本，其逆温度分别为 $\\beta_1$ 和 $\\beta_2$，构型分别为 $x_1$ 和 $x_2$，相应能量为 $E_1 = E(x_1)$ 和 $E_2 = E(x_2)$，其联合平衡密度为\n$$\n\\pi_{\\mathrm{old}}(x_1, x_2 \\mid \\beta_1, \\beta_2) \\propto \\exp(-\\beta_1 E_1)\\,\\exp(-\\beta_2 E_2).\n$$\n一个提议的温度交换移动会产生新状态 $(x_1, x_2 \\mid \\beta_2, \\beta_1)$，即温度被交换而构型保持不变。交换后状态的相应联合平衡密度为\n$$\n\\pi_{\\mathrm{new}}(x_1, x_2 \\mid \\beta_2, \\beta_1) \\propto \\exp(-\\beta_2 E_1)\\,\\exp(-\\beta_1 E_2).\n$$\n根据对称提议的 Metropolis–Hastings 构建方法，接受概率 $a$ 为\n$$\na = \\min\\left(1, \\frac{\\pi_{\\mathrm{new}}}{\\pi_{\\mathrm{old}}}\\right) = \\min\\left(1, \\exp\\big[-\\beta_2 E_1 - \\beta_1 E_2 + \\beta_1 E_1 + \\beta_2 E_2\\big]\\right).\n$$\n合并各项可得\n$$\na = \\min\\left(1, \\exp\\big[(\\beta_1 - \\beta_2)(E_1 - E_2)\\big]\\right).\n$$\n这是在联合正则系综中与细致平衡相符的接受准则。\n\n我们现在使用指定的值来计算此表达式。对于摩尔能量，逆温度由下式定义：\n$$\n\\beta_1 = \\frac{1}{R T_1}, \\qquad \\beta_2 = \\frac{1}{R T_2}.\n$$\n能量差为\n$$\n\\Delta E \\equiv E_1 - E_2 = -25.0\\,\\mathrm{kJ\\,mol^{-1}} - \\left(-20.0\\,\\mathrm{kJ\\,mol^{-1}}\\right) = -5.0\\,\\mathrm{kJ\\,mol^{-1}} = -5000\\,\\mathrm{J\\,mol^{-1}}.\n$$\n因此，接受因子中的指数为\n$$\n(\\beta_1 - \\beta_2)\\,\\Delta E = \\left(\\frac{1}{R T_1} - \\frac{1}{R T_2}\\right)(-5000).\n$$\n当 $T_1 = 300\\,\\mathrm{K}$，$T_2 = 450\\,\\mathrm{K}$，且 $R = 8.314462618\\,\\mathrm{J\\,mol^{-1}\\,K^{-1}}$ 时，\n$$\n\\beta_1 = \\frac{1}{8.314462618 \\times 300}, \\qquad \\beta_2 = \\frac{1}{8.314462618 \\times 450},\n$$\n从而\n$$\n\\beta_1 - \\beta_2 = \\frac{1}{8.314462618 \\times 300} - \\frac{1}{8.314462618 \\times 450} = \\frac{T_2 - T_1}{R T_1 T_2}.\n$$\n数值上，\n$$\n\\beta_1 - \\beta_2 = \\frac{150}{8.314462618 \\times 300 \\times 450} \\approx 1.33636 \\times 10^{-4},\n$$\n因此\n$$\n(\\beta_1 - \\beta_2)\\,\\Delta E \\approx (1.33636 \\times 10^{-4}) \\times (-5000) \\approx -0.66818.\n$$\n那么，接受概率为\n$$\na = \\min\\left(1, \\exp(-0.66818)\\right) \\approx \\exp(-0.66818).\n$$\n使用 $\\exp(-0.66818) = \\exp(-0.69314718 + 0.02496743) = \\exp(-0.69314718)\\,\\exp(0.02496743) = \\frac{1}{2}\\,\\exp(0.02496743)$ 和 $\\exp(0.02496743) \\approx 1.02528$，我们得到\n$$\na \\approx \\frac{1}{2} \\times 1.02528 \\approx 0.51264.\n$$\n四舍五入到四位有效数字，接受概率为\n$$\n0.5126.\n$$", "answer": "$$\\boxed{0.5126}$$", "id": "3442046"}, {"introduction": "在掌握了单个交换事件的概率之后[@problem_id:3442046]，下一步是将其应用于设计高效的模拟。副本交换的效率很大程度上取决于温度阶梯的设置，而这又通过相邻副本间的平均交换接受率来衡量。本练习是一个实际的计算任务，要求你根据能量分布直方图估算预期的交换接受率，并应用一个通用的启发式准则来判断温度设置是否优化，从而将理论知识与模拟设计实践直接联系起来。", "problem": "您的任务是构建一个程序，该程序从正则系综和 Metropolis–Hastings 判据的第一性原理出发，估算两个正则副本之间的期望副本交换接受率，并判断温度阶梯间距对于金属玻璃是否足够。考虑两个副本，它们在温度 $T_i$ 和 $T_j$ 下从经验直方图中独立地采样势能。提议交换的接受率应从两个副本的联合正则分布的细致平衡要求中推导得出。期望接受率定义为 Metropolis–Hastings 接受率在两个能量直方图形成的乘积测度上的联合期望。您的推导必须从正则系综概率测度和细致平衡原理开始，不能直接给出目标接受率公式。\n\n给定均匀能量网格上的离散化能量直方图，您必须使用能正确考虑区间宽度的离散求和来数值估算期望接受率，然后使用一个以数值范围明确陈述的、有科学依据的判据来判断温度阶梯对于金属玻璃的适宜性。所有量必须以一致的物理单位表示。能量使用电子伏特 (eV)，温度使用开尔文 (K)。玻尔兹曼常数 $k_{\\mathrm{B}}$ 必须使用电子伏特/开尔文单位，其中 $k_{\\mathrm{B}} = 8.617333262 \\times 10^{-5}\\,\\mathrm{eV/K}$。本任务不涉及角度。\n\n测试套件提供了参数化的、模拟金属玻璃经验势能直方图的、科学上合理的合成直方图规范。对于每个测试用例，您必须在指定的均匀能量网格上构建直方图 $p_i(U)$ 和 $p_j(U)$，使用与网格一致的数值积分将其归一化（使其能量积分为 1），然后计算期望的交换接受率。对于每种情况，您必须输出一个列表，其中包含接受率值和一个布尔值，该布尔值指示温度阶梯间距对于金属玻璃是否足够。判断依据是接受率应在窗口 $[\\alpha_{\\min}, \\alpha_{\\max}]$ 内，其中 $\\alpha_{\\min} = 0.2$ 和 $\\alpha_{\\max} = 0.4$。当且仅当接受率位于此闭区间内时，温度阶梯被认为是足够的。\n\n直方图构建规则：\n- 对于单个高斯分量，能量 $U$ 上的概率密度函数定义为 $f(U; \\mu, \\sigma) = \\dfrac{1}{\\sigma \\sqrt{2\\pi}} \\exp\\!\\left(-\\dfrac{(U - \\mu)^2}{2\\sigma^2}\\right)$。\n- 对于 $M$ 个高斯分量的混合模型，定义 $p(U) = \\sum_{m=1}^{M} w_m f(U; \\mu_m, \\sigma_m)$，其中非负权重 $\\{w_m\\}$ 的总和为 1。\n- 在一个均匀网格 $U_k$ 上将 $U$ 离散化，$k = 0, 1, \\dots, N-1$，其中 $U_k$ 使用 $N$ 个点覆盖指定的范围。\n- 归一化离散直方图，使其满足 $\\sum_{k=0}^{N-1} p(U_k) \\,\\Delta U = 1$，其中 $\\Delta U$ 是均匀的区间宽度。\n\n期望接受率估算要求：\n- 将期望接受率计算为两个归一化直方图的联合乘积上的离散双重求和，使用由细致平衡所蕴含的 Metropolis–Hastings 接受率，用于交换在逆温 $\\beta_i$ 和 $\\beta_j$ 下独立采样的两个能量，其中 $\\beta = 1/(k_{\\mathrm{B}} T)$。\n\n适宜性判据：\n- 使用 $\\alpha_{\\min} = 0.2$ 和 $\\alpha_{\\max} = 0.4$。如果期望接受率在 $[\\alpha_{\\min}, \\alpha_{\\max}]$ 范围内，则返回布尔值 $true$；否则返回 $false$。\n\n最终输出格式：\n- 您的程序应生成一行输出，其中包含所有测试用例的结果，格式为一个由方括号括起来的逗号分隔列表，其中每个项目都是 $[\\text{acceptance}, \\text{adequate}]$ 形式的双元素列表。例如：$[[a_1,b_1],[a_2,b_2],\\dots]$。每个接受率必须是浮点数，每个适宜性判断必须是布尔值。\n\n测试套件（为以下情况构建直方图并计算结果）：\n- 情况 1（中等阶梯间距，单峰）：\n  - 温度：$T_i = 600\\,\\mathrm{K}$，$T_j = 660\\,\\mathrm{K}$。\n  - 能量网格：$U \\in [-3100\\,\\mathrm{eV}, -2900\\,\\mathrm{eV}]$，含 $N = 801$ 个点。\n  - 副本 i：单峰高斯分布，参数为 $\\mu_i = -3000\\,\\mathrm{eV}$，$\\sigma_i = 18\\,\\mathrm{eV}$。\n  - 副本 j：单峰高斯分布，参数为 $\\mu_j = -2990\\,\\mathrm{eV}$，$\\sigma_j = 22\\,\\mathrm{eV}$。\n- 情况 2（近邻温度，单峰）：\n  - 温度：$T_i = 600\\,\\mathrm{K}$，$T_j = 602\\,\\mathrm{K}$。\n  - 能量网格：$U \\in [-3100\\,\\mathrm{eV}, -2900\\,\\mathrm{eV}]$，含 $N = 801$ 个点。\n  - 副本 i：单峰高斯分布，参数为 $\\mu_i = -3000\\,\\mathrm{eV}$，$\\sigma_i = 18\\,\\mathrm{eV}$。\n  - 副本 j：单峰高斯分布，参数为 $\\mu_j = -2999.7\\,\\mathrm{eV}$，$\\sigma_j = 18.7\\,\\mathrm{eV}$。\n- 情况 3（宽间距温度，单峰）：\n  - 温度：$T_i = 600\\,\\mathrm{K}$，$T_j = 900\\,\\mathrm{K}$。\n  - 能量网格：$U \\in [-3100\\,\\mathrm{eV}, -2900\\,\\mathrm{eV}]$，含 $N = 801$ 个点。\n  - 副本 i：单峰高斯分布，参数为 $\\mu_i = -3000\\,\\mathrm{eV}$，$\\sigma_i = 18\\,\\mathrm{eV}$。\n  - 副本 j：单峰高斯分布，参数为 $\\mu_j = -2950\\,\\mathrm{eV}$，$\\sigma_j = 35\\,\\mathrm{eV}$。\n- 情况 4（代表玻璃态非均匀性的双峰混合模型）：\n  - 温度：$T_i = 700\\,\\mathrm{K}$，$T_j = 770\\,\\mathrm{K}$。\n  - 能量网格：$U \\in [-3040\\,\\mathrm{eV}, -2920\\,\\mathrm{eV}]$，含 $N = 601$ 个点。\n  - 副本 i：含两个分量的混合模型：\n    - 权重：$w_{i,1} = 0.6$，$w_{i,2} = 0.4$。\n    - 均值：$\\mu_{i,1} = -2995\\,\\mathrm{eV}$，$\\mu_{i,2} = -2970\\,\\mathrm{eV}$。\n    - 标准差：$\\sigma_{i,1} = 18\\,\\mathrm{eV}$，$\\sigma_{i,2} = 12\\,\\mathrm{eV}$。\n  - 副本 j：含两个分量的混合模型：\n    - 权重：$w_{j,1} = 0.5$，$w_{j,2} = 0.5$。\n    - 均值：$\\mu_{j,1} = -2988\\,\\mathrm{eV}$，$\\mu_{j,2} = -2960\\,\\mathrm{eV}$。\n    - 标准差：$\\sigma_{j,1} = 22\\,\\mathrm{eV}$，$\\sigma_{j,2} = 15\\,\\mathrm{eV}$。\n- 情况 5（相同温度，单峰；边界条件）：\n  - 温度：$T_i = 650\\,\\mathrm{K}$，$T_j = 650\\,\\mathrm{K}$。\n  - 能量网格：$U \\in [-3050\\,\\mathrm{eV}, -2930\\,\\mathrm{eV}]$，含 $N = 601$ 个点。\n  - 副本 i：单峰高斯分布，参数为 $\\mu_i = -2995\\,\\mathrm{eV}$，$\\sigma_i = 20\\,\\mathrm{eV}$。\n  - 副本 j：单峰高斯分布，参数为 $\\mu_j = -2995\\,\\mathrm{eV}$，$\\sigma_j = 20\\,\\mathrm{eV}$。\n\n您的程序必须实现以上要求，计算每种情况的期望接受率，并以 $[[a_1,b_1],[a_2,b_2],[a_3,b_3],[a_4,b_4],[a_5,b_5]]$ 的确切格式输出单行结果，其中每个 $a_k$ 是一个浮点值，每个 $b_k$ 是一个布尔值。", "solution": "该问题要求估算两个正则副本 $i$ 和 $j$ 在温度 $T_i$ 和 $T_j$ 下的期望副本交换接受概率，其势能从给定的分布中采样。推导必须源于统计力学的第一性原理。\n\n设双副本系统的状态由其各自构型的势能 $(U_i, U_j)$ 定义。在用于副本交换模拟的扩展正则系综中，此状态的联合概率密度是各个正则概率的乘积。假设两个系统的态密度 $\\Omega(U)$ 相同（因为它们代表相同的物理系统），则概率正比于玻尔兹曼因子：\n$$\nP(U_i, U_j) \\propto \\Omega(U_i) e^{-\\beta_i U_i} \\cdot \\Omega(U_j) e^{-\\beta_j U_j}\n$$\n其中 $\\beta_k = 1/(k_{\\mathrm{B}} T_k)$ 是副本 $k$ 的逆温，$k_{\\mathrm{B}}$ 是玻尔兹曼常数。\n\n副本 $i$ 和 $j$ 之间的交换移动提议了一个从状态 $(U_i, U_j)$ 到 $(U_j, U_i)$ 的跃迁，其中构型被交换。温度为 $T_i$ 的副本现在具有能量 $U_j$，而温度为 $T_j$ 的副本具有能量 $U_i$。这个新状态的概率是：\n$$\nP(U_j, U_i) \\propto \\Omega(U_j) e^{-\\beta_i U_j} \\cdot \\Omega(U_i) e^{-\\beta_j U_i}\n$$\n\n为了维持扩展系综的平衡，交换移动必须满足细致平衡原理。该原理表述为：\n$$\nP(U_i, U_j) W((U_i, U_j) \\to (U_j, U_i)) = P(U_j, U_i) W((U_j, U_i) \\to (U_i, U_j))\n$$\n其中 $W(A \\to B)$ 是从状态 $A$ 到状态 $B$ 的总跃迁概率。它是提议概率 $g(A \\to B)$ 和接受概率 $\\alpha(A \\to B)$ 的乘积。由于交换的提议是对称的，即 $g((U_i, U_j) \\to (U_j, U_i)) = g((U_j, U_i) \\to (U_i, U_j))$，细致平衡条件简化为接受概率的比率：\n$$\n\\frac{\\alpha(U_i \\leftrightarrow U_j)}{\\alpha(U_j \\leftrightarrow U_i)} = \\frac{P(U_j, U_i)}{P(U_i, U_j)} = \\frac{\\Omega(U_j) e^{-\\beta_i U_j} \\Omega(U_i) e^{-\\beta_j U_i}}{\\Omega(U_i) e^{-\\beta_i U_i} \\Omega(U_j) e^{-\\beta_j U_j}} = \\frac{e^{-\\beta_i U_j - \\beta_j U_i}}{e^{-\\beta_i U_i - \\beta_j U_j}}\n$$\n注意态密度项 $\\Omega(U)$ 被消掉了。简化指数项可得：\n$$\n\\frac{\\alpha(U_i \\leftrightarrow U_j)}{\\alpha(U_j \\leftrightarrow U_i)} = e^{-(\\beta_i U_j + \\beta_j U_i) + (\\beta_i U_i + \\beta_j U_j)} = e^{(\\beta_i - \\beta_j)U_i - (\\beta_i - \\beta_j)U_j} = e^{-(\\beta_j - \\beta_i)(U_j - U_i)}\n$$\nMetropolis-Hastings 判据为满足此关系的接受概率提供了一个常用且有效的选择：\n$$\n\\alpha(U_i \\leftrightarrow U_j) = \\min\\left(1, e^{-(\\beta_j - \\beta_i)(U_j - U_i)}\\right)\n$$\n这是涉及能量 $U_i$ 和 $U_j$ 的单次提议交换的接受概率。\n\n问题指出，副本 $i$ 和 $j$ 从经验直方图中独立采样势能，我们将其表示为连续概率密度函数 $p_i(U)$ 和 $p_j(U)$。期望接受概率 $\\langle \\alpha \\rangle$ 是 $\\alpha(U_i \\leftrightarrow U_j)$ 在所有可能的能量对 $(U_i, U_j)$ 上的平均值，由联合概率密度 $p_i(U_i)p_j(U_j)$ 加权：\n$$\n\\langle \\alpha \\rangle = \\int_{-\\infty}^{\\infty} dU_i \\int_{-\\infty}^{\\infty} dU_j \\, p_i(U_i) p_j(U_j) \\, \\alpha(U_i \\leftrightarrow U_j)\n$$\n代入推导出的 $\\alpha(U_i \\leftrightarrow U_j)$ 表达式：\n$$\n\\langle \\alpha \\rangle = \\int_{-\\infty}^{\\infty} dU_i \\int_{-\\infty}^{\\infty} dU_j \\, p_i(U_i) p_j(U_j) \\, \\min\\left(1, e^{-(\\beta_j - \\beta_i)(U_j - U_i)}\\right)\n$$\n\n对于数值计算，这个双重积分在均匀能量网格上进行离散化。设网格由 $N$ 个点 $\\{U_k\\}_{k=0}^{N-1}$ 组成，均匀间距为 $\\Delta U$。该积分由一个双重黎曼和近似。在以 $U_k$ 为中心的能量区间中找到副本 $i$ 的概率是 $P_i(k) = p_i(U_k) \\Delta U$。求和为：\n$$\n\\langle \\alpha \\rangle \\approx \\sum_{k=0}^{N-1} \\sum_{l=0}^{N-1} (p_i(U_k) \\Delta U) (p_j(U_l) \\Delta U) \\min\\left(1, e^{-(\\beta_j - \\beta_i)(U_l - U_k)}\\right)\n$$\n问题规定直方图由（混合）高斯分布构建。设 $h_i(U_k)$ 是未归一化的高斯混合函数在网格点 $U_k$ 处的值。归一化条件是 $\\sum_{k=0}^{N-1} p_i(U_k) \\Delta U = 1$。这意味着归一化密度 $p_i(U_k)$ 与未归一化值 $h_i(U_k)$ 的关系为 $p_i(U_k) = h_i(U_k) / C_i$，其中归一化常数为 $C_i = \\sum_{k=0}^{N-1} h_i(U_k) \\Delta U$。将此代入 $\\langle \\alpha \\rangle$ 的表达式并简化，可以证明区间宽度 $\\Delta U$ 被消掉了：\n$$\n\\langle \\alpha \\rangle \\approx \\frac{\\sum_{k=0}^{N-1} \\sum_{l=0}^{N-1} h_i(U_k) h_j(U_l) \\min\\left(1, e^{-(\\beta_j - \\beta_i)(U_l - U_k)}\\right)}{\\left(\\sum_{k=0}^{N-1} h_i(U_k)\\right) \\left(\\sum_{l=0}^{N-1} h_j(U_l)\\right)}\n$$\n这个表达式是稳健的，并用于实现。算法按以下步骤进行：\n1. 构建均匀能量网格 $\\{U_k\\}$。\n2. 根据提供的高斯参数，在此网格上评估未归一化的直方图函数 $h_i(U_k)$ 和 $h_j(U_k)$。\n3. 计算分子中的双重求和以及分母中求和的乘积。为提高效率，使用矢量化数组操作。\n4. 将两个结果相除，得到估算的期望接受率 $\\langle \\alpha \\rangle$。\n\n最后，对温度阶梯间距进行判断。对于金属玻璃模拟，足够阶梯间距的判据是接受率在闭区间 $[\\alpha_{\\min}, \\alpha_{\\max}]$ 内，其中 $\\alpha_{\\min} = 0.2$ 且 $\\alpha_{\\max} = 0.4$。将计算出的 $\\langle \\alpha \\rangle$ 与此范围进行比较，并相应地返回一个布尔值。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve the replica exchange problem for all test cases.\n    \"\"\"\n    \n    # Constants\n    KB_EV_K = 8.617333262e-5  # Boltzmann constant in eV/K\n    ALPHA_MIN = 0.2\n    ALPHA_MAX = 0.4\n\n    test_cases = [\n        # Case 1\n        {\n            \"temps\": (600, 660), \"N\": 801, \"U_range\": (-3100, -2900),\n            \"h_i\": [{\"w\": 1.0, \"mu\": -3000, \"sigma\": 18}],\n            \"h_j\": [{\"w\": 1.0, \"mu\": -2990, \"sigma\": 22}],\n        },\n        # Case 2\n        {\n            \"temps\": (600, 602), \"N\": 801, \"U_range\": (-3100, -2900),\n            \"h_i\": [{\"w\": 1.0, \"mu\": -3000, \"sigma\": 18}],\n            \"h_j\": [{\"w\": 1.0, \"mu\": -2999.7, \"sigma\": 18.7}],\n        },\n        # Case 3\n        {\n            \"temps\": (600, 900), \"N\": 801, \"U_range\": (-3100, -2900),\n            \"h_i\": [{\"w\": 1.0, \"mu\": -3000, \"sigma\": 18}],\n            \"h_j\": [{\"w\": 1.0, \"mu\": -2950, \"sigma\": 35}],\n        },\n        # Case 4\n        {\n            \"temps\": (700, 770), \"N\": 601, \"U_range\": (-3040, -2920),\n            \"h_i\": [\n                {\"w\": 0.6, \"mu\": -2995, \"sigma\": 18},\n                {\"w\": 0.4, \"mu\": -2970, \"sigma\": 12},\n            ],\n            \"h_j\": [\n                {\"w\": 0.5, \"mu\": -2988, \"sigma\": 22},\n                {\"w\": 0.5, \"mu\": -2960, \"sigma\": 15},\n            ],\n        },\n        # Case 5\n        {\n            \"temps\": (650, 650), \"N\": 601, \"U_range\": (-3050, -2930),\n            \"h_i\": [{\"w\": 1.0, \"mu\": -2995, \"sigma\": 20}],\n            \"h_j\": [{\"w\": 1.0, \"mu\": -2995, \"sigma\": 20}],\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        acceptance, is_adequate = compute_case(case, KB_EV_K, ALPHA_MIN, ALPHA_MAX)\n        results.append(f\"[{acceptance},{str(is_adequate).lower()}]\")\n        \n    print(f\"[{','.join(results)}]\")\n\n\ndef gaussian_pdf(x, mu, sigma):\n    \"\"\"\n    Computes the value of a Gaussian probability density function.\n    No scipy dependency used as per strict interpretation.\n    \"\"\"\n    return (1 / (sigma * np.sqrt(2 * np.pi))) * np.exp(-0.5 * ((x - mu) / sigma) ** 2)\n\ndef build_histogram(U, components):\n    \"\"\"\n    Builds an unnormalized histogram from a Gaussian mixture model.\n    \"\"\"\n    h = np.zeros_like(U)\n    for comp in components:\n        h += comp[\"w\"] * gaussian_pdf(U, comp[\"mu\"], comp[\"sigma\"])\n    return h\n\ndef compute_case(case, kb, alpha_min, alpha_max):\n    \"\"\"\n    Computes the expected acceptance and adequacy for a single test case.\n    \"\"\"\n    T_i, T_j = case[\"temps\"]\n    N = case[\"N\"]\n    U_min, U_max = case[\"U_range\"]\n    \n    # 1. Construct the energy grid\n    U = np.linspace(U_min, U_max, N)\n    \n    # 2. Build unnormalized histograms\n    h_i = build_histogram(U, case[\"h_i\"])\n    h_j = build_histogram(U, case[\"h_j\"])\n    \n    # 3. Calculate inverse temperatures\n    # Use a small epsilon to avoid division by zero if T=0, though not expected here.\n    beta_i = 1.0 / (kb * (T_i + 1e-12))\n    beta_j = 1.0 / (kb * (T_j + 1e-12))\n    delta_beta = beta_j - beta_i\n\n    # Handle the trivial case of identical temperatures\n    if np.isclose(delta_beta, 0.0):\n        acceptance = 1.0\n        is_adequate = alpha_min = acceptance = alpha_max\n        return acceptance, is_adequate\n\n    # 4. Compute the double summation using vectorized operations\n    \n    # Denominator computation\n    sum_h_i = np.sum(h_i)\n    sum_h_j = np.sum(h_j)\n    denominator = sum_h_i * sum_h_j\n\n    if denominator == 0:\n        return 0.0, False\n\n    # Numerator computation\n    # Create matrices for broadcasting\n    U_k = U[:, np.newaxis]  # Column vector for U_i\n    U_l = U[np.newaxis, :]  # Row vector for U_j\n\n    h_i_col = h_i[:, np.newaxis]\n    h_j_row = h_j[np.newaxis, :]\n    \n    # Calculate matrix of energy differences\n    delta_U_matrix = U_l - U_k\n    \n    # Calculate acceptance probability for each pair (U_k, U_l)\n    exponent_matrix = -delta_beta * delta_U_matrix\n    alpha_matrix = np.minimum(1.0, np.exp(exponent_matrix))\n    \n    # Calculate the joint unnormalized probability matrix\n    joint_h_matrix = h_i_col * h_j_row\n    \n    # Compute the numerator sum\n    numerator = np.sum(joint_h_matrix * alpha_matrix)\n    \n    # 5. Calculate final expected acceptance\n    acceptance = numerator / denominator\n    \n    # 6. Diagnose adequacy\n    is_adequate = alpha_min = acceptance = alpha_max\n    \n    return acceptance, is_adequate\n\nsolve()\n\n```", "id": "3485799"}, {"introduction": "进行增强采样模拟的最终目的是为了计算常规分子动力学难以获得的精确热力学性质。本练习将聚焦于副本交换模拟的数据分析，展示如何运用强大的多态贝内特接受率方法（MBAR）来整合所有副本的数据。通过计算系统的定容热容$C_V$及其统计不确定性，你将掌握一个前沿的数据处理工作流程，学会如何将原始模拟数据转化为有意义的物理洞见。", "problem": "给定从一组温度 $\\{T_i\\}$ 下对定容材料体系进行的复本交换分子动力学 (REMD) 模拟中汇集的势能样本。温度为 $T$ 的正则系综由玻尔兹曼权重 $e^{-\\beta E}$ 定义，其中 $\\beta = 1/(k_B T)$，$k_B$ 是玻尔兹曼常数。多态贝内特接受率 (MBAR) 方法提供依赖于状态的权重 $\\{w_n^{(j)}\\}$，以对汇集的样本 $\\{E_n\\}$ 进行重加权，从而估计目标温度 $T_j$ 下的系综平均值。\n\n从正则系综的定义和热力学关系出发，推导在正则分布下，用能量矩表示的定容热容 $C_V(T)$ 的表达式。然后，使用提供的 MBAR 权重，实现一个计算过程，该过程：\n- 通过能量涨落，从汇集的样本中评估热容 $C_V(T)$，并且\n- 使用 MBAR 权重和一阶不确定度传播，传播不确定度以获得单标准差误差棒。\n\n假设样本独立以进行不确定度传播，并使用从归一化 MBAR 权重导出的有效样本量来缩放不确定度。使用 $k_B = 8.617333262145\\times 10^{-5}$ 电子伏特/开尔文。能量必须以电子伏特 (eV) 为单位处理，温度以开尔文 (K) 为单位，所得热容必须以电子伏特/开尔文 (eV/K) 表示。所有角度量（如果出现）必须以弧度处理；此任务中没有直接出现角度。\n\n对于目标温度 $T_j$，让归一化的 MBAR 权重满足 $\\sum_n w_n^{(j)} = 1$，并使用 $\\{E_n, w_n^{(j)}\\}$ 定义加权矩估计。使用这些估计来计算 $C_V(T_j)$，方法是仅用一阶和二阶能量矩来表示它。对于不确定度传播，使用 $E$ 和 $E^2$ 的加权方差和协方差，以及从权重导出的有效样本量，通过一阶泰勒展开（德尔塔方法）计算估计量的方差。\n\n为以下测试套件实现一个程序来执行上述操作。在每种情况下，能量都是从所有复本中汇集的，并且 MBAR 为每个目标温度提供一个权重向量。在所有情况下，您的程序必须在计算任何量之前，内部将每个提供的权重向量归一化使其总和为 $1$。\n\n测试套件：\n- 情况 $1$（一般行为）：\n  - 温度：$[300.0, 450.0, 600.0]$ K。\n  - 能量 (eV)：$[-0.80, -0.79, -0.78, -0.76, -0.74, -0.73, -0.71, -0.70, -0.68, -0.67, -0.65, -0.64]$。\n  - 针对目标温度的 MBAR 权重矩阵（行对应温度，列对应能量样本）：\n    - $300.0$ K 对应的行：$[0.1333, 0.1222, 0.1111, 0.1000, 0.0889, 0.0778, 0.0667, 0.0667, 0.0556, 0.0556, 0.0556, 0.0667]$。\n    - $450.0$ K 对应的行：$[0.09, 0.09, 0.09, 0.09, 0.085, 0.085, 0.085, 0.085, 0.08, 0.08, 0.08, 0.08]$。\n    - $600.0$ K 对应的行：$[0.05, 0.055, 0.06, 0.065, 0.07, 0.08, 0.085, 0.09, 0.095, 0.1, 0.105, 0.1]$。\n- 情况 $2$（简并权重和有效样本量压力测试）：\n  - 温度：$[250.0, 600.0]$ K。\n  - 能量 (eV)：$[-0.90, -0.88, -0.86, -0.84, -0.82, -0.80, -0.78, -0.76, -0.74, -0.72]$。\n  - MBAR 权重矩阵：\n    - $250.0$ K 对应的行：$[0.40, 0.30, 0.10, 0.06, 0.04, 0.03, 0.02, 0.02, 0.02, 0.01]$。\n    - $600.0$ K 对应的行：$[0.05, 0.06, 0.07, 0.08, 0.09, 0.10, 0.11, 0.12, 0.16, 0.16]$。\n- 情况 $3$（近恒定能量的边界情况）：\n  - 温度：$[500.0]$ K。\n  - 能量 (eV)：$[-0.5005, -0.5004, -0.5006, -0.5003, -0.5007, -0.5005, -0.5006, -0.5004]$。\n  - MBAR 权重矩阵：\n    - $500.0$ K 对应的行：$[0.125, 0.125, 0.125, 0.125, 0.125, 0.125, 0.125, 0.125]$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个列表形式的结果，每个测试用例对应一个条目。每个测试用例条目是一个列表，每个目标温度对应一个条目，每个温度条目是一个双元素列表 $[C_V, \\sigma_{C_V}]$，两个值均以 eV/K 为单位。例如，打印的结构必须类似于 $[[[c_1, s_1], [c_2, s_2]], [[c_3, s_3], [c_4, s_4]], [[c_5, s_5]]]$，用实际数值替换这些符号。", "solution": "目标是推导定容热容 $C_V$ 的表达式，并利用复本交换分子动力学 (REMD) 模拟的数据，通过多态贝内特接受率 (MBAR) 方法实现相应的计算。这包括统计不确定度的传播。\n\n该问题具有充分的科学依据，内容自洽，且算法上已明确。它基于统计力学的基本原理和计算材料科学的标准实践。所有必需的数据、常数和程序要求均已提供。因此，该问题被认为是有效的，下面给出了完整的解决方案。\n\n### 基于原理的推导与算法设计\n\n#### 1. 正则系综中的热容\n\n定容热容 $C_V$ 定义为平均内能 $\\langle E \\rangle$ 对温度 $T$ 在恒定体积 $V$ 下的偏导数：\n$$\nC_V = \\left( \\frac{\\partial \\langle E \\rangle}{\\partial T} \\right)_V\n$$\n在正则 (NVT) 系综中，任何可观测量 $A$ 的期望值由 $\\langle A \\rangle = Z^{-1} \\sum_i A_i e^{-\\beta E_i}$ 给出，其中 $Z = \\sum_i e^{-\\beta E_i}$ 是配分函数，$E_i$ 是能量微观态，$\\beta = (k_B T)^{-1}$ 是逆热能，$k_B$ 是玻尔兹曼常数。\n\n平均能量可以表示为配分函数的导数：\n$$\n\\langle E \\rangle = -\\frac{\\partial \\ln Z}{\\partial \\beta}\n$$\n使用链式法则，我们可以将 $C_V$ 的定义改写为关于 $\\beta$ 的形式：\n$$\nC_V = \\frac{\\partial \\langle E \\rangle}{\\partial \\beta} \\frac{\\partial \\beta}{\\partial T}\n$$\n第二项计算如下：\n$$\n\\frac{\\partial \\beta}{\\partial T} = \\frac{\\partial}{\\partial T} \\left( \\frac{1}{k_B T} \\right) = -\\frac{1}{k_B T^2}\n$$\n第一项 $\\frac{\\partial \\langle E \\rangle}{\\partial \\beta}$ 是：\n$$\n\\frac{\\partial \\langle E \\rangle}{\\partial \\beta} = \\frac{\\partial}{\\partial \\beta} \\left( -\\frac{\\partial \\ln Z}{\\partial \\beta} \\right) = -\\frac{\\partial^2 \\ln Z}{\\partial \\beta^2}\n$$\n进行微分得到：\n$$\n\\frac{\\partial \\langle E \\rangle}{\\partial \\beta} = \\frac{\\partial}{\\partial \\beta} \\left( \\frac{\\sum_i E_i e^{-\\beta E_i}}{Z} \\right) = \\frac{(\\sum_i -E_i^2 e^{-\\beta E_i})Z - (\\sum_i E_i e^{-\\beta E_i})(-\\sum_i E_i e^{-\\beta E_i})}{Z^2} = -\\langle E^2 \\rangle + \\langle E \\rangle^2\n$$\n结合这些结果，得到用能量涨落表示的热容表达式：\n$$\nC_V = (-\\langle E^2 \\rangle + \\langle E \\rangle^2) \\left( -\\frac{1}{k_B T^2} \\right) = \\frac{\\langle E^2 \\rangle - \\langle E \\rangle^2}{k_B T^2}\n$$\n分子 $\\langle E^2 \\rangle - \\langle E \\rangle^2$ 是能量的方差 $\\sigma_E^2$。因此，最终表达式为：\n$$\nC_V = \\frac{\\sigma_E^2}{k_B T^2}\n$$\n\n#### 2. 能量矩的 MBAR 估计量\n\n问题提供了一组 $N$ 个汇集能量样本 $\\{E_n\\}_{n=1}^N$，并且对于每个目标温度 $T_j$，提供了一组相应的 MBAR 权重 $\\{w_n^{(j)}\\}_{n=1}^N$。在使用之前，这些权重必须进行归一化，以确保它们代表一个有效的概率分布：\n$$\n\\tilde{w}_n^{(j)} = \\frac{w_n^{(j)}}{\\sum_{k=1}^N w_k^{(j)}} \\quad \\text{使得} \\quad \\sum_{n=1}^N \\tilde{w}_n^{(j)} = 1\n$$\n此后，我们用 $w_n^{(j)}$ 表示温度 $T_j$ 的归一化权重。在 $T_j$ 下，能量一阶矩和二阶矩的 MBAR 估计量是加权平均值：\n$$\n\\hat{E}_j = \\langle E \\rangle_j \\approx \\sum_{n=1}^N w_n^{(j)} E_n\n$$\n$$\n\\widehat{E^2}_j = \\langle E^2 \\rangle_j \\approx \\sum_{n=1}^N w_n^{(j)} E_n^2\n$$\n将这些估计量代入上述公式，得到 $T_j$ 下的热容估计值：\n$$\n\\hat{C}_{V,j} = \\frac{\\widehat{E^2}_j - (\\hat{E}_j)^2}{k_B T_j^2}\n$$\n\n#### 3. 使用德尔塔方法进行不确定度传播\n\n为了求出 $\\hat{C}_{V,j}$ 的标准差，我们使用一阶不确定度传播（德尔塔方法）。令 $X = \\hat{E}_j$ 和 $Y = \\widehat{E^2}_j$。我们的函数是 $f(X, Y) = (Y - X^2) / (k_B T_j^2)$。$\\hat{C}_{V,j} = f(X, Y)$ 的方差近似为：\n$$\n\\sigma_{\\hat{C}_{V,j}}^2 \\approx \\left(\\frac{\\partial f}{\\partial X}\\right)^2 \\text{Var}(X) + \\left(\\frac{\\partial f}{\\partial Y}\\right)^2 \\text{Var}(Y) + 2 \\left(\\frac{\\partial f}{\\partial X}\\right) \\left(\\frac{\\partial f}{\\partial Y}\\right) \\text{Cov}(X, Y)\n$$\n在样本估计值处计算的偏导数是：\n$$\n\\frac{\\partial f}{\\partial X} = \\frac{-2X}{k_B T_j^2} \\quad \\implies \\quad \\frac{-2\\hat{E}_j}{k_B T_j^2}\n$$\n$$\n\\frac{\\partial f}{\\partial Y} = \\frac{1}{k_B T_j^2}\n$$\n估计量 $X$ 和 $Y$ 的方差和协方差通过从归一化权重导出的有效样本量 $N_{eff,j}$ 进行缩放：\n$$\nN_{eff,j} = \\frac{1}{\\sum_{n=1}^N (w_n^{(j)})^2}\n$$\n可观测量 $A$ 和 $B$ 的均值估计量的方差和协方差由 $\\text{Var}(\\hat{A}) \\approx \\widehat{\\text{Var}}(A)/N_{eff,j}$ 和 $\\text{Cov}(\\hat{A}, \\hat{B}) \\approx \\widehat{\\text{Cov}}(A,B)/N_{eff,j}$ 给出。所需的加权样本（协）方差为：\n$$\n\\text{Var}(X) = \\text{Var}(\\hat{E}_j) \\approx \\frac{1}{N_{eff,j}} \\left( \\widehat{E^2}_j - (\\hat{E}_j)^2 \\right)\n$$\n$$\n\\text{Var}(Y) = \\text{Var}(\\widehat{E^2}_j) \\approx \\frac{1}{N_{eff,j}} \\left( \\widehat{E^4}_j - (\\widehat{E^2}_j)^2 \\right)\n$$\n$$\n\\text{Cov}(X, Y) = \\text{Cov}(\\hat{E}_j, \\widehat{E^2}_j) \\approx \\frac{1}{N_{eff,j}} \\left( \\widehat{E^3}_j - \\hat{E}_j \\widehat{E^2}_j \\right)\n$$\n其中 $\\widehat{E^k}_j = \\sum_{n=1}^N w_n^{(j)} E_n^k$ 对于 $k \\in \\{3,4\\}$。\n\n将这些代入德尔塔方法公式，得到热容估计量的方差：\n$$\n\\sigma_{\\hat{C}_{V,j}}^2 = \\frac{1}{(k_B T_j^2)^2 N_{eff,j}} \\left[ 4(\\hat{E}_j)^2(\\widehat{E^2}_j - \\hat{E}_j^2) + (\\widehat{E^4}_j - (\\widehat{E^2}_j)^2) - 4\\hat{E}_j(\\widehat{E^3}_j - \\hat{E}_j\\widehat{E^2}_j) \\right]\n$$\n单标准差误差棒为 $\\sigma_{\\hat{C}_{V,j}} = \\sqrt{\\sigma_{\\hat{C}_{V,j}}^2}$。\n\n#### 4. 算法总结\n\n对于每个测试用例和每个目标温度 $T_j$，计算过程如下：\n1.  接收汇集的能量样本 $\\{E_n\\}$、目标温度 $T_j$ 和未归一化的 MBAR 权重 $\\{w_{n, \\text{raw}}^{(j)}\\}$。\n2.  归一化权重：$w_n^{(j)} = w_{n, \\text{raw}}^{(j)} / \\sum_k w_{k, \\text{raw}}^{(j)}$。\n3.  计算能量的前四阶加权矩：$\\hat{E}_j$、$\\widehat{E^2}_j$、$\\widehat{E^3}_j$ 和 $\\widehat{E^4}_j$。\n4.  使用推导出的公式计算热容估计值 $\\hat{C}_{V,j}$。\n5.  计算有效样本量 $N_{eff,j}$。\n6.  使用德尔塔方法的完整表达式计算估计量的方差 $\\sigma_{\\hat{C}_{V,j}}^2$。\n7.  计算标准差 $\\sigma_{\\hat{C}_{V,j}}$。对于可能导致小的负方差的数值不稳定性，将在开方前取方差与 $0$ 的最大值。\n8.  返回数据对 $[\\hat{C}_{V,j}, \\sigma_{\\hat{C}_{V,j}}]$。\n对所有温度和所有测试用例重复此过程，并将结果汇总成指定的输出格式。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main solver function to process all test cases and print the results.\n    \"\"\"\n    k_B = 8.617333262145e-5  # eV/K\n\n    test_cases = [\n        {\n            \"temperatures\": [300.0, 450.0, 600.0],\n            \"energies\": [-0.80, -0.79, -0.78, -0.76, -0.74, -0.73, -0.71, -0.70, -0.68, -0.67, -0.65, -0.64],\n            \"weights_matrix\": [\n                [0.1333, 0.1222, 0.1111, 0.1000, 0.0889, 0.0778, 0.0667, 0.0667, 0.0556, 0.0556, 0.0556, 0.0667],\n                [0.09, 0.09, 0.09, 0.09, 0.085, 0.085, 0.085, 0.085, 0.08, 0.08, 0.08, 0.08],\n                [0.05, 0.055, 0.06, 0.065, 0.07, 0.08, 0.085, 0.09, 0.095, 0.1, 0.105, 0.1]\n            ]\n        },\n        {\n            \"temperatures\": [250.0, 600.0],\n            \"energies\": [-0.90, -0.88, -0.86, -0.84, -0.82, -0.80, -0.78, -0.76, -0.74, -0.72],\n            \"weights_matrix\": [\n                [0.40, 0.30, 0.10, 0.06, 0.04, 0.03, 0.02, 0.02, 0.02, 0.01],\n                [0.05, 0.06, 0.07, 0.08, 0.09, 0.10, 0.11, 0.12, 0.16, 0.16]\n            ]\n        },\n        {\n            \"temperatures\": [500.0],\n            \"energies\": [-0.5005, -0.5004, -0.5006, -0.5003, -0.5007, -0.5005, -0.5006, -0.5004],\n            \"weights_matrix\": [\n                [0.125, 0.125, 0.125, 0.125, 0.125, 0.125, 0.125, 0.125]\n            ]\n        }\n    ]\n\n    def format_nested_list(l):\n        \"\"\"\n        Recursively formats a nested list into a string without spaces after commas.\n        \"\"\"\n        if not isinstance(l, list):\n            # Format numbers to avoid excessive precision in output\n            if isinstance(l, float):\n                return f\"{l:.8g}\"\n            return str(l)\n        return '[' + ','.join(format_nested_list(item) for item in l) + ']'\n    \n    def calculate_cv_and_error(T, E, weights_unnormalized, k_B):\n        \"\"\"\n        Calculates C_V and its uncertainty for a single temperature.\n        \"\"\"\n        # 1. Normalize weights\n        weights_sum = np.sum(weights_unnormalized)\n        weights = weights_unnormalized / weights_sum if weights_sum != 0 else weights_unnormalized\n\n        # 2. Compute the first four weighted moments of energy\n        E1 = np.dot(weights, E)\n        E2 = np.dot(weights, E**2)\n        E3 = np.dot(weights, E**3)\n        E4 = np.dot(weights, E**4)\n        \n        # 3. Calculate heat capacity estimate\n        var_E = E2 - E1**2\n        k_B_T_sq = k_B * T**2\n        cv = var_E / k_B_T_sq if k_B_T_sq != 0 else 0.0\n\n        # 4. Calculate uncertainty\n        # Effective sample size\n        n_eff = 1.0 / np.sum(weights**2) if np.sum(weights**2) > 0 else 1.0\n\n        # Weighted sample variances and covariances of observables E and E^2\n        var_E2 = E4 - E2**2\n        cov_E_E2 = E3 - E1 * E2\n\n        # Delta method expression for variance of C_V\n        # S_prime sums up the terms from the Taylor expansion\n        s_prime = (4 * E1**2 * var_E) + var_E2 - (4 * E1 * cov_E_E2)\n        \n        # Handle cases where the denominator is zero\n        denominator = n_eff * k_B_T_sq**2\n        if denominator > 0:\n            var_cv = s_prime / denominator\n            # Prevent sqrt of a small negative number due to float precision\n            sigma_cv = np.sqrt(max(0, var_cv))\n        else:\n            sigma_cv = 0.0\n            \n        return [cv, sigma_cv]\n\n    results = []\n    for case in test_cases:\n        energies_np = np.array(case[\"energies\"], dtype=np.float64)\n        case_results = []\n        for i, T in enumerate(case[\"temperatures\"]):\n            weights_np = np.array(case[\"weights_matrix\"][i], dtype=np.float64)\n            cv_result = calculate_cv_and_error(T, energies_np, weights_np, k_B)\n            case_results.append(cv_result)\n        results.append(case_results)\n\n    # Final print statement in the exact required format\n    print(format_nested_list(results))\n\nsolve()\n```", "id": "3485758"}]}