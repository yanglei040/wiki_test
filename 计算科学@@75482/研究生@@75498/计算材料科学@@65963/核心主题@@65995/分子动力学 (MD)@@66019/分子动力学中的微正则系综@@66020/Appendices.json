{"hands_on_practices": [{"introduction": "在微正则系综模拟中，温度可以从两个角度来理解：一个是基于系统相空间几何结构（熵 $S(E)$）的统计学观点，另一个是基于粒子时间平均运动（动能 $\\langle K \\rangle$）的动力学观点。这项实践提供了一个动手操作的机会，引导你为一个理想的谐振子系统推导这两种温度的定义，并用数值方法验证它们的一致性。这个过程将帮助你连接抽象的统计理论与具体的分子动力学模拟实践，从而深刻理解微正则系综的核心原理 [@problem_id:3494648]。", "problem": "考虑一个由$N$个独立的一维经典谐振子组成的系统，该系统在微正则系综中根据确定性分子动力学进行演化。其哈密顿量为 $H(\\mathbf{x},\\mathbf{p}) = \\sum_{i=1}^{N} \\left( \\frac{p_i^2}{2 m} + \\frac{1}{2} m \\omega^2 x_i^2 \\right)$，其中$m$是质量（单位：千克），$\\omega$是角频率（单位：弧度/秒），$x_i$是位置（单位：米），$p_i$是动量（单位：千克·米/秒）。微正则熵定义为 $S(E) = k_{\\mathrm{B}} \\ln \\Omega(E)$，其中$k_{\\mathrm{B}}$为玻尔兹曼常数（单位：焦耳/开尔文），$\\Omega(E)$是能量小于或等于$E$的微观状态所占据的相空间体积。态密度为 $g(E) = \\partial \\Omega(E)/\\partial E$。微正则逆温度由 $1/T(E) = \\partial S(E) / \\partial E$ 定义。\n\n从以上定义和基本原理出发，推导一个通过对此哈密顿量的相空间中的能量壳层进行采样来重构态密度$g(E)$的方法。根据重构的$g(E)$，计算$S(E)$，然后求出$1/T(E) = \\partial S(E)/\\partial E$。独立地，在相同的总能量$E$下执行微正则分子动力学（即遵循牛顿定律并使用速度Verlet算法积分的恒能量动力学），并通过动力学温度的经典定义，从动能$K(t)$的时间序列中估算动力学温度。比较这两个逆温度：从熵的导数得到的$1/T(E)$和从$K(t)$得到的$1/T_{\\mathrm{kin}}$。\n\n您的程序必须实现以下功能：\n\n- 一个针对$N$个具有指定$m$和$\\omega$的独立谐振子的速度Verlet积分器，使用时间步长$\\Delta t$（单位：秒）和给定的步数。随机初始化位置和速度，然后重新缩放它们以匹配精确的目标总能量$E$（单位：焦耳）。\n- 从第一性原理出发，通过相空间中的能量壳层采样，重构此哈密顿量的$g(E)$。使用此重构来计算$S(E)$，然后计算$1/T(E) = \\partial S/\\partial E$。\n- 从分子动力学轨迹获得的$K(t)$的时间平均值计算动力学温度$T_{\\mathrm{kin}}$。使用适用于具有$N$个二次速度自由度的经典动能的关系式。\n\n对于每个测试用例，报告两个逆温度之间的相对差异，该差异定义为一个无量纲小数：\n$$\n\\delta = \\frac{\\left| \\frac{1}{T(E)} - \\frac{1}{T_{\\mathrm{kin}}} \\right|}{\\frac{1}{T_{\\mathrm{kin}}}}.\n$$\n\n在整个过程中使用国际单位制（SI）：质量单位为千克，角频率单位为弧度/秒，时间单位为秒，能量单位为焦耳，温度单位为开尔文。除了角频率的规定外，不需要角度。您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔的结果列表。\n\n测试套件（每个案例是一个元组 $(N, m, \\omega, E, \\Delta t, \\text{steps})$）：\n\n1. $(4,\\;6.6335209\\times 10^{-26}\\,\\mathrm{kg},\\;1.0\\times 10^{13}\\,\\mathrm{rad/s},\\;4 k_{\\mathrm{B}} \\cdot 300\\,\\mathrm{K},\\;1.0\\times 10^{-16}\\,\\mathrm{s},\\;80000)$\n2. $(4,\\;6.6335209\\times 10^{-26}\\,\\mathrm{kg},\\;1.0\\times 10^{13}\\,\\mathrm{rad/s},\\;4 k_{\\mathrm{B}} \\cdot 1\\,\\mathrm{K},\\;1.0\\times 10^{-16}\\,\\mathrm{s},\\;80000)$\n3. $(1,\\;6.6335209\\times 10^{-26}\\,\\mathrm{kg},\\;1.0\\times 10^{13}\\,\\mathrm{rad/s},\\;1 k_{\\mathrm{B}} \\cdot 270\\,\\mathrm{K},\\;1.0\\times 10^{-16}\\,\\mathrm{s},\\;120000)$\n4. $(8,\\;6.6335209\\times 10^{-26}\\,\\mathrm{kg},\\;1.0\\times 10^{13}\\,\\mathrm{rad/s},\\;8 k_{\\mathrm{B}} \\cdot 1200\\,\\mathrm{K},\\;1.0\\times 10^{-16}\\,\\mathrm{s},\\;60000)$\n\n您的程序应生成单行输出，其中包含四个$\\delta$值，格式为方括号括起来的逗号分隔列表（例如，“[result1,result2,result3,result4]”）。", "solution": "该问题要求对微正则系综中一个由$N$个独立的一维经典谐振子组成的系统的两种温度定义进行比较。第一种是$T(E)$，它源自统计力学中熵的定义。第二种是$T_{\\mathrm{kin}}$，它源自通过分子动力学模拟获得的时间平均动能。本解答将给出两者的理论推导，概述数值计算的步骤，并建立它们之间的理论等效性，附带的程序将对此进行数值验证。\n\n### 1. 从态密度得到的统计温度\n\n第一步是从微正则熵 $S(E) = k_{\\mathrm{B}} \\ln \\Omega(E)$ 推导统计温度$T(E)$，其中$\\Omega(E)$是能量小于或等于$E$的状态的相空间体积。逆温度则由$1/T(E) = \\partial S(E)/\\partial E$给出。\n\n系统的哈密顿量为：\n$$\nH(\\mathbf{x},\\mathbf{p}) = \\sum_{i=1}^{N} \\left( \\frac{p_i^2}{2 m} + \\frac{1}{2} m \\omega^2 x_i^2 \\right)\n$$\n相空间体积$\\Omega(E)$是在$H(\\mathbf{x},\\mathbf{p}) \\leq E$的条件下对所有位置$x_i$和动量$p_i$的积分：\n$$\n\\Omega(E) = \\int_{H(\\mathbf{x},\\mathbf{p}) \\leq E} \\prod_{i=1}^{N} dx_i dp_i\n$$\n为了计算这个积分，我们进行变量替换，将不等式变换为超球面方程。我们定义新坐标$q_j$：\n$$\nq_{2i-1} = \\sqrt{\\frac{m \\omega^2}{2}} x_i \\quad \\text{and} \\quad q_{2i} = \\frac{1}{\\sqrt{2m}} p_i\n$$\n在这些新坐标下，哈密顿量变为：\n$$\nH = \\sum_{i=1}^{N} (q_{2i-1}^2 + q_{2i}^2) = \\sum_{j=1}^{2N} q_j^2\n$$\n条件$H \\leq E$现在是$\\sum_{j=1}^{2N} q_j^2 \\leq E$，它描述了一个半径为$R = \\sqrt{E}$的$2N$维超球体的内部。\n\n微分体积元变换如下：\n$$\ndx_i = \\sqrt{\\frac{2}{m \\omega^2}} dq_{2i-1} \\quad \\text{and} \\quad dp_i = \\sqrt{2m} dq_{2i}\n$$\n每个振子的雅可比行列式为 $J_i = \\sqrt{\\frac{2}{m \\omega^2}} \\sqrt{2m} = \\frac{2}{\\omega}$。对于整个$N$振子系统，相空间体积元为：\n$$\n\\prod_{i=1}^{N} dx_i dp_i = \\left(\\frac{2}{\\omega}\\right)^N \\prod_{j=1}^{2N} dq_j\n$$\n相空间体积积分变为：\n$$\n\\Omega(E) = \\left(\\frac{2}{\\omega}\\right)^N \\int_{\\sum_{j=1}^{2N} q_j^2 \\leq E} \\prod_{j=1}^{2N} dq_j\n$$\n该积分是半径为$R$的$d$维超球体的体积，由公式 $V_d(R) = \\frac{\\pi^{d/2}}{\\Gamma(d/2 + 1)} R^d$ 给出。当$d=2N$且$R=\\sqrt{E}$时，体积为：\n$$\nV_{2N}(\\sqrt{E}) = \\frac{\\pi^N}{\\Gamma(N+1)} (\\sqrt{E})^{2N} = \\frac{(\\pi E)^N}{N!}\n$$\n将此代回，我们得到相空间体积：\n$$\n\\Omega(E) = \\left(\\frac{2}{\\omega}\\right)^N \\frac{(\\pi E)^N}{N!} = \\frac{1}{N!} \\left(\\frac{2\\pi E}{\\omega}\\right)^N\n$$\n问题要求的是态密度$g(E)$，即$\\Omega(E)$的导数：\n$$\ng(E) = \\frac{\\partial \\Omega(E)}{\\partial E} = \\frac{1}{N!} \\left(\\frac{2\\pi}{\\omega}\\right)^N \\frac{\\partial (E^N)}{\\partial E} = \\frac{N}{N!} \\left(\\frac{2\\pi}{\\omega}\\right)^N E^{N-1} = \\frac{1}{(N-1)!} \\left(\\frac{2\\pi}{\\omega}\\right)^N E^{N-1}\n$$\n对于这个特定的哈密顿量，这个解析推导构成了从第一性原理出发对$g(E)$的所需“重构”。熵则为：\n$$\nS(E) = k_{\\mathrm{B}} \\ln \\Omega(E) = k_{\\mathrm{B}} \\ln \\left[ \\frac{1}{N!} \\left(\\frac{2\\pi}{\\omega}\\right)^N E^N \\right] = k_{\\mathrm{B}} \\left( \\ln\\left[\\frac{1}{N!} \\left(\\frac{2\\pi}{\\omega}\\right)^N\\right] + N \\ln E \\right)\n$$\n微正则逆温度$1/T(E)$是熵对能量的导数：\n$$\n\\frac{1}{T(E)} = \\frac{\\partial S(E)}{\\partial E} = k_{\\mathrm{B}} \\frac{\\partial}{\\partial E} (N \\ln E) = \\frac{N k_{\\mathrm{B}}}{E}\n$$\n这提供了第一个纯理论的逆温度值。\n\n### 2. 从分子动力学得到的动力学温度\n\n第二种方法是通过分子动力学（MD）模拟计算动力学温度$T_{\\mathrm{kin}}$。动力学温度的经典定义源于能量均分定理，该定理指出哈密顿量中的每个二次自由度对系统的平均能量贡献为$\\frac{1}{2} k_{\\mathrm{B}} T$。\n\n系统的总动能为 $K = \\sum_{i=1}^{N} \\frac{p_i^2}{2m}$。这是$N$个二次项（每个动量$p_i$一项）的和。根据能量均分定理，时间平均总动能$\\langle K \\rangle$与动力学温度$T_{\\mathrm{kin}}$的关系为：\n$$\n\\langle K \\rangle = N \\cdot \\frac{1}{2} k_{\\mathrm{B}} T_{\\mathrm{kin}}\n$$\n由此，我们可以将逆动力学温度表示为：\n$$\n\\frac{1}{T_{\\mathrm{kin}}} = \\frac{N k_{\\mathrm{B}}}{2 \\langle K \\rangle}\n$$\n$\\langle K \\rangle$的值是通过执行恒定能量的MD模拟，并在长轨迹上对瞬时动能进行平均来获得的。\n\n模拟过程如下：\n1.  **初始化**：$N$个位置$x_i$和$N$个速度$v_i$通过从标准正态分布中抽取的随机值进行初始化。初始动量为$p_i = m v_i$。根据这些初始条件计算总能量$E_{\\mathrm{init}}$。然后将位置和动量通过一个因子$\\lambda = \\sqrt{E / E_{\\mathrm{init}}}$进行重新缩放，其中$E$是目标总能量。这确保了模拟以微正则系综所需的精确能量开始。\n2.  **积分**：使用速度Verlet算法传播轨迹，这是一种时间可逆的辛积分器，可在长时间模拟中提供出色的能量守恒。对于振子$i$，力为$F_i = -m \\omega^2 x_i$，因此加速度为$a_i = -\\omega^2 x_i$。在一个时间步长$\\Delta t$内，位置$x_i$和速度$v_i$的更新步骤如下：\n    $$\n    v_i(t + \\Delta t/2) = v_i(t) + \\frac{1}{2} a_i(t) \\Delta t\n    $$\n    $$\n    x_i(t + \\Delta t) = x_i(t) + v_i(t + \\Delta t/2) \\Delta t\n    $$\n    $$\n    a_i(t + \\Delta t) = -\\omega^2 x_i(t + \\Delta t)\n    $$\n    $$\n    v_i(t + \\Delta t) = v_i(t + \\Delta t/2) + \\frac{1}{2} a_i(t + \\Delta t) \\Delta t\n    $$\n3.  **平均**：在模拟过程中，每一步都会计算并累加瞬时动能$K(t) = \\sum_{i=1}^N \\frac{(m v_i(t))^2}{2m}$。在模拟结束时计算时间平均值$\\langle K \\rangle$。\n\n### 3. 比较与理论等效性\n\n对于经典谐振子系统，维里定理指出，总动能的时间平均值等于总势能的时间平均值，即$\\langle K \\rangle = \\langle V \\rangle$。由于总能量$E = K + V$在微正则系综中是守恒的，我们有$E = \\langle K + V \\rangle = \\langle K \\rangle + \\langle V \\rangle$。这意味着$\\langle K \\rangle = E/2$。\n\n将这个预期结果代入动力学温度的表达式中，得到：\n$$\n\\frac{1}{T_{\\mathrm{kin}}} = \\frac{N k_{\\mathrm{B}}}{2 \\langle K \\rangle} = \\frac{N k_{\\mathrm{B}}}{2 (E/2)} = \\frac{N k_{\\mathrm{B}}}{E}\n$$\n这与从统计力学推导出的$1/T(E)$的表达式完全相同。因此，对于该系统，这两种温度定义在理论上是等效的。计算的目的在于数值验证这种等效性。相对差异$\\delta$将量化由有限的时间步长和数值模拟的有限持续时间所产生的任何偏差。一个小的$\\delta$值既证实了温度的统计图像和动力学图像的一致性，也证实了MD模拟的准确性。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.constants import k as k_B\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print results.\n    \"\"\"\n    test_cases_raw = [\n        (4, 6.6335209e-26, 1.0e13, 4, 300, 1.0e-16, 80000),\n        (4, 6.6335209e-26, 1.0e13, 4, 1, 1.0e-16, 80000),\n        (1, 6.6335209e-26, 1.0e13, 1, 270, 1.0e-16, 120000),\n        (8, 6.6335209e-26, 1.0e13, 8, 1200, 1.0e-16, 60000),\n    ]\n\n    test_cases = []\n    for i, case in enumerate(test_cases_raw):\n        N, m, omega, E_factor, T_factor, dt, steps = case\n        E = E_factor * k_B * T_factor\n        test_cases.append((N, m, omega, E, dt, steps))\n\n    results = []\n    for case in test_cases:\n        delta = compute_relative_difference(case)\n        results.append(delta)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef compute_relative_difference(case_params):\n    \"\"\"\n    Computes the relative difference delta for a single test case.\n    \"\"\"\n    N, m, omega, E_target, dt, n_steps = case_params\n\n    # ======== 1. Statistical Temperature T(E) ========\n    # From the derivation, 1/T(E) = N * k_B / E\n    if E_target > 1e-30:\n        inv_T_statistical = (N * k_B) / E_target\n    else:\n        inv_T_statistical = 0.0\n\n    # ======== 2. Kinetic Temperature T_kin from MD ========\n    # Perform MD simulation to get the time-averaged kinetic energy\n    np.random.seed(42) # For reproducibility\n\n    # Initialization\n    x = np.random.randn(N)\n    v = np.random.randn(N)\n    \n    # Scale to target energy E_target\n    K_init = 0.5 * m * np.sum(v**2)\n    U_init = 0.5 * m * omega**2 * np.sum(x**2)\n    E_init = K_init + U_init\n    \n    if E_init > 1e-12:\n        scale_factor = np.sqrt(E_target / E_init)\n        x *= scale_factor\n        v *= scale_factor\n    elif E_target > 0:\n        x = np.random.randn(N)\n        v = np.random.randn(N)\n        K_init = 0.5 * m * np.sum(v**2)\n        U_init = 0.5 * m * omega**2 * np.sum(x**2)\n        E_init = K_init + U_init\n        if E_init > 1e-12:\n            scale_factor = np.sqrt(E_target / E_init)\n            x *= scale_factor\n            v *= scale_factor\n        else:\n            x = np.zeros(N)\n            v = np.zeros(N)\n    else: # E_target is zero or negative\n        x = np.zeros(N)\n        v = np.zeros(N)\n\n\n    # Velocity Verlet integrator\n    a = -omega**2 * x\n    total_K = 0.0\n    \n    # Production run\n    for _ in range(n_steps):\n        v_half = v + 0.5 * a * dt\n        x = x + v_half * dt\n        a = -omega**2 * x\n        v = v_half + 0.5 * a * dt\n        \n        K_current = 0.5 * m * np.sum(v**2)\n        total_K += K_current\n        \n    avg_K = total_K / n_steps\n    \n    # Calculate kinetic temperature\n    if avg_K > 1e-30:\n        inv_T_kinetic = (N * k_B) / (2.0 * avg_K)\n    else:\n        inv_T_kinetic = 0.0\n\n    # ======== 3. Compute Relative Difference ========\n    if abs(inv_T_kinetic) > 1e-30:\n        relative_difference = np.abs(inv_T_statistical - inv_T_kinetic) / inv_T_kinetic\n    else:\n        relative_difference = 0.0 if np.abs(inv_T_statistical)  1e-30 else np.inf\n        \n    return relative_difference\n\nsolve()\n```", "id": "3494648"}, {"introduction": "许多分子模型，如常见的水模型，会使用约束来固定键长或键角，这会减少系统的有效自由度。这项实践将挑战你把动能温度的概念推广到这类约束系统中。通过将动力学投影到允许的运动流形上，你将推导并实现一种正确计算约束系统温度的方法，这是模拟复杂分子时一项至关重要的技能 [@problem_id:3494645]。", "problem": "你的任务是研究在微正则系综中存在约束时的能量均分，这在恒定粒子数、体积和能量 (NVE) 系综中通过使用 SHAKE 约束算法 (SHAKE) 的约束分子动力学得以实现。从第一性原理出发，推导完整约束下微正则温度的表达式，并实现一个程序，该程序能够构建约束速度场、计算模式分辨的动能，并定量评估能量均分。\n\n从以下基础开始：\n- 牛顿第二定律和动能的定义：对于一个具有广义笛卡尔速度 $\\mathbf{v} \\in \\mathbb{R}^{n}$ 和对角质量矩阵 $\\mathbf{M} = \\mathrm{diag}(m_1,\\dots,m_n)$ 的系统，其动能为 $K = \\tfrac{1}{2}\\,\\mathbf{v}^{\\mathsf{T}}\\mathbf{M}\\mathbf{v}$。\n- 形式为 $\\boldsymbol{\\Phi}(\\mathbf{q}) = \\mathbf{0}$ 的完整约束，其雅可比矩阵为 $\\mathbf{J}(\\mathbf{q}) = \\partial \\boldsymbol{\\Phi}/\\partial \\mathbf{q}$，当约束被精确维持时，意味着瞬时速度约束为 $\\mathbf{J}(\\mathbf{q})\\,\\mathbf{v} = \\mathbf{0}$。\n- 玻尔兹曼常数 $k_{\\mathrm{B}}$ 是一个关联能量与温度的正值常数，其值为 $k_{\\mathrm{B}} = 1.380649\\times 10^{-23}\\,\\mathrm{J}/\\mathrm{K}$。\n\n你的任务：\n1) 仅从上述定义出发，通过引入质量加权速度 $\\mathbf{w} = \\mathbf{M}^{1/2}\\mathbf{v}$ 和质量加权约束算子 $\\mathbf{A} = \\mathbf{J}\\,\\mathbf{M}^{-1/2}$，推导动能的约束模式表示。证明容许的 $\\mathbf{w}$ 满足 $\\mathbf{A}\\,\\mathbf{w} = \\mathbf{0}$，并且任何容许的 $\\mathbf{w}$ 都可以写成 $\\mathbf{w} = \\mathbf{N}\\,\\mathbf{a}$ 的形式，其中 $\\mathbf{N}$ 的列构成了 $\\mathrm{null}(\\mathbf{A})$ 的一个标准正交基，而 $\\mathbf{a} \\in \\mathbb{R}^{f_{\\mathrm{eff}}}$ 是模式振幅，其中 $f_{\\mathrm{eff}} = \\dim \\mathrm{null}(\\mathbf{A})$ 是无约束二次自由度的有效数量。\n2) 利用约束流形上二次动能的微正则温度定义，以及在 $\\mathbf{a}$ 空间中等能面的几何结构，推导使用 $f_{\\mathrm{eff}}$ 将总动能 $K$ 与温度 $T$ 关联起来的公式。\n3) 实现一个程序，对于下方的每个测试用例，执行以下操作：\n   - 通过对 $\\mathbf{A}$ 进行奇异值分解来数值构建 $\\mathbf{N}$，并计算 $f_{\\mathrm{eff}}$ 为 $\\mathbf{A}$ 的零度。\n   - 通过在坐标 $\\mathbf{a}$ 中选择相等的模式能量，生成一个具有精确指定总动能 $K_{\\text{target}}$ 的约束速度场。\n   - 计算模式分辨的动能 $K_i = \\tfrac{1}{2} a_i^2$ 和与能量均分的最大相对偏差，定义为\n     $$\\delta_{\\max} = \\begin{cases}\n     \\max_i \\left|\\dfrac{K_i - K_{\\text{target}}/f_{\\mathrm{eff}}}{K_{\\text{target}}/f_{\\mathrm{eff}}}\\right|,  \\text{if } K_{\\text{target}}  0,\\\\\n     0,  \\text{if } K_{\\text{target}} = 0,\n     \\end{cases}$$\n     其中 $i = 1,\\dots,f_{\\mathrm{eff}}$。\n   - 使用你推导的温度公式计算以开尔文为单位的约束微正则温度 $T$。\n   - 为每个测试用例返回一个形式为 $[T, f_{\\mathrm{eff}}, \\delta_{\\max}]$ 的列表，其中 $T$ 是以开尔文为单位的浮点数，$f_{\\mathrm{eff}}$ 是一个整数，$\\delta_{\\max}$ 是一个浮点数。\n\n物理单位和约定：\n- 所有质量必须解释为千克，所有能量必须解释为焦耳，输出温度必须以开尔文表示。玻尔兹曼常数必须为 $k_{\\mathrm{B}} = 1.380649\\times 10^{-23}\\,\\mathrm{J}/\\mathrm{K}$。\n- 不涉及角度；无需角度单位。\n\n测试套件：\n将以下四个案例提供给你的程序。每个案例都是一维的（因此对于 $N$ 个粒子，$\\mathbf{v} \\in \\mathbb{R}^{N}$），具有线性的完整约束，这些约束在给定构型下强制固定的对间距离。作用于速度的约束雅可比矩阵在该构型下可以由一个常数矩阵 $\\mathbf{J}$ 表示，其行编码了沿约束键的等速约束。具体使用：\n\n- 案例 1（具有完全约束链的理想情况）：\n  - $N=3$ 时，质量 $\\mathbf{m} = [\\,1.66\\times 10^{-27},\\, 3.32\\times 10^{-27},\\, 4.98\\times 10^{-27}\\,]\\,\\mathrm{kg}$。\n  - 约束 $\\mathbf{J} = \\begin{bmatrix} -1  1  0 \\\\ 0  -1  1 \\end{bmatrix}$。\n  - 目标动能 $K_{\\text{target}} = 1.0\\times 10^{-20}\\,\\mathrm{J}$。\n\n- 案例 2（具有剩余内部运动的部分约束）：\n  - $N=4$ 时，质量 $\\mathbf{m} = [\\,1.66\\times 10^{-27},\\, 3.32\\times 10^{-27},\\, 4.98\\times 10^{-27},\\, 6.64\\times 10^{-27}\\,]\\,\\mathrm{kg}$。\n  - 约束 $\\mathbf{J} = \\begin{bmatrix} -1  1  0  0 \\end{bmatrix}$。\n  - 目标动能 $K_{\\text{target}} = 3.0\\times 10^{-21}\\,\\mathrm{J}$。\n\n- 案例 3（测试数值秩检测的冗余约束）：\n  - $N=3$ 时，质量 $\\mathbf{m} = [\\,1.66\\times 10^{-27},\\, 3.32\\times 10^{-27},\\, 4.98\\times 10^{-27}\\,]\\,\\mathrm{kg}$。\n  - 约束 $\\mathbf{J} = \\begin{bmatrix} -1  1  0 \\\\ -2  2  0 \\end{bmatrix}$。\n  - 目标动能 $K_{\\text{target}} = 2.5\\times 10^{-21}\\,\\mathrm{J}$。\n\n- 案例 4（零能边界情况）：\n  - $N=2$ 时，质量 $\\mathbf{m} = [\\,1.00\\times 10^{-26},\\, 2.00\\times 10^{-26}\\,]\\,\\mathrm{kg}$。\n  - 约束 $\\mathbf{J} = \\begin{bmatrix} -1  1 \\end{bmatrix}$。\n  - 目标动能 $K_{\\text{target}} = 0.0\\,\\mathrm{J}$。\n\n最终输出格式：\n你的程序应生成单行输出，其中包含一个由方括号括起来的逗号分隔列表的结果。每个测试用例的结果本身必须是一个列表 $[T, f_{\\mathrm{eff}}, \\delta_{\\max}]$，按此顺序排列，其中 $T$ 是以开尔文为单位的浮点数，$f_{\\mathrm{eff}}$ 是一个整数，$\\delta_{\\max}$ 是一个浮点数。例如，输出必须类似于\n$[[T_1,f_{\\mathrm{eff},1},\\delta_{\\max,1}],[T_2,f_{\\mathrm{eff},2},\\delta_{\\max,2}],\\dots]$。", "solution": "目标是为一个受完整约束的经典系统推导温度的统计力学描述，并实现一个算法来构建满足能量均分的约束速度场。\n\n**第一部分：动能的约束模式表示**\n\n我们从一个具有 $n$ 个广义笛卡尔坐标及相应速度 $\\mathbf{v} \\in \\mathbb{R}^{n}$ 和对角质量矩阵 $\\mathbf{M} = \\mathrm{diag}(m_1, \\dots, m_n)$ 的系统的动能基本定义开始。\n动能 $K$ 由下式给出：\n$$K = \\frac{1}{2}\\mathbf{v}^{\\mathsf{T}}\\mathbf{M}\\mathbf{v}$$\n为简化此表达式，我们引入质量加权速度 $\\mathbf{w} \\in \\mathbb{R}^{n}$，定义为：\n$$\\mathbf{w} = \\mathbf{M}^{1/2}\\mathbf{v}$$\n其中 $\\mathbf{M}^{1/2} = \\mathrm{diag}(\\sqrt{m_1}, \\dots, \\sqrt{m_n})$。因此，笛卡尔速度可以表示为 $\\mathbf{v} = \\mathbf{M}^{-1/2}\\mathbf{w}$。将其代入动能表达式可得：\n$$K = \\frac{1}{2}(\\mathbf{M}^{-1/2}\\mathbf{w})^{\\mathsf{T}}\\mathbf{M}(\\mathbf{M}^{-1/2}\\mathbf{w}) = \\frac{1}{2}\\mathbf{w}^{\\mathsf{T}}(\\mathbf{M}^{-1/2})^{\\mathsf{T}}\\mathbf{M}\\mathbf{M}^{-1/2}\\mathbf{w}$$\n由于 $\\mathbf{M}$ 是对角的，其平方根和平方根的逆也是对角的，因此是对称的。所以，$(\\mathbf{M}^{-1/2})^{\\mathsf{T}} = \\mathbf{M}^{-1/2}$。表达式简化为：\n$$K = \\frac{1}{2}\\mathbf{w}^{\\mathsf{T}}\\mathbf{M}^{-1/2}\\mathbf{M}\\mathbf{M}^{-1/2}\\mathbf{w} = \\frac{1}{2}\\mathbf{w}^{\\mathsf{T}}\\mathbf{I}\\mathbf{w} = \\frac{1}{2}\\mathbf{w}^{\\mathsf{T}}\\mathbf{w} = \\frac{1}{2}\\sum_{i=1}^{n} w_i^2$$\n此变换将动能表达式对角化，使得每个坐标的贡献都具有单一的权重。\n\n系统受 $k$ 个完整约束 $\\boldsymbol{\\Phi}(\\mathbf{q}) = \\mathbf{0}$ 的限制，这些约束对时间求导后，对速度施加了线性约束：\n$$\\mathbf{J}(\\mathbf{q})\\mathbf{v} = \\mathbf{0}$$\n其中 $\\mathbf{J}(\\mathbf{q}) = \\partial \\boldsymbol{\\Phi}/\\partial \\mathbf{q}$ 是 $k \\times n$ 的约束雅可比矩阵。将 $\\mathbf{v} = \\mathbf{M}^{-1/2}\\mathbf{w}$ 代入速度约束方程，得到：\n$$\\mathbf{J}\\mathbf{M}^{-1/2}\\mathbf{w} = \\mathbf{0}$$\n我们定义质量加权约束算子 $\\mathbf{A} = \\mathbf{J}\\mathbf{M}^{-1/2}$。质量加权速度的约束方程变为：\n$$\\mathbf{A}\\mathbf{w} = \\mathbf{0}$$\n这表明任何物理上容许的质量加权速度矢量 $\\mathbf{w}$ 都必须位于矩阵 $\\mathbf{A}$ 的零空间中，记作 $\\mathrm{null}(\\mathbf{A})$。此零空间的维度 $f_{\\mathrm{eff}} = \\dim(\\mathrm{null}(\\mathbf{A})) = n - \\mathrm{rank}(\\mathbf{A})$，代表了系统有效、无约束的动能自由度数量。\n\n设 $\\{\\mathbf{n}_1, \\dots, \\mathbf{n}_{f_{\\mathrm{eff}}}\\}$ 是 $\\mathrm{null}(\\mathbf{A})$ 的一个标准正交基。我们可以构成一个大小为 $n \\times f_{\\mathrm{eff}}$ 的矩阵 $\\mathbf{N} = [\\mathbf{n}_1|\\dots|\\mathbf{n}_{f_{\\mathrm{eff}}}]$，其列是这些基矢量。根据构造，$\\mathbf{A}\\mathbf{N} = \\mathbf{0}$ 且 $\\mathbf{N}^{\\mathsf{T}}\\mathbf{N} = \\mathbf{I}_{f_{\\mathrm{eff}}}$，其中 $\\mathbf{I}_{f_{\\mathrm{eff}}}$ 是 $f_{\\mathrm{eff}} \\times f_{\\mathrm{eff}}}$ 的单位矩阵。任何容许的矢量 $\\mathbf{w}$ 都可以唯一地表示为这些基矢量的线性组合：\n$$\\mathbf{w} = \\sum_{i=1}^{f_{\\mathrm{eff}}} a_i \\mathbf{n}_i = \\mathbf{N}\\mathbf{a}$$\n其中 $\\mathbf{a} = [a_1, \\dots, a_{f_{\\mathrm{eff}}}]^{\\mathsf{T}}$ 是一个模式振幅矢量。\n\n将 $\\mathbf{w}$ 的此表示代回动能表达式中，我们得到：\n$$K = \\frac{1}{2}(\\mathbf{N}\\mathbf{a})^{\\mathsf{T}}(\\mathbf{N}\\mathbf{a}) = \\frac{1}{2}\\mathbf{a}^{\\mathsf{T}}\\mathbf{N}^{\\mathsf{T}}\\mathbf{N}\\mathbf{a} = \\frac{1}{2}\\mathbf{a}^{\\mathsf{T}}\\mathbf{I}_{f_{\\mathrm{eff}}}\\mathbf{a} = \\frac{1}{2}\\mathbf{a}^{\\mathsf{T}}\\mathbf{a}$$\n此最终结果表明，总动能是 $f_{\\mathrm{eff}}$ 个独立二次项的和：\n$$K = \\sum_{i=1}^{f_{\\mathrm{eff}}} \\frac{1}{2} a_i^2$$\n每一项 $K_i = \\frac{1}{2}a_i^2$ 都可以被解释为一个独立动力学模式的动能。\n\n**第二部分：约束下的微正则温度**\n\n在微正则系综中，对于一个处于固定构型 $\\mathbf{q}$ 的系统，其总动能 $K$ 是恒定的。系统在质量加权速度空间中的可及态被限制在由 $\\mathbf{w}^{\\mathsf{T}}\\mathbf{w} = 2K$ 定义的超球面和由 $\\mathbf{A}\\mathbf{w} = \\mathbf{0}$ 定义的线性子空间的交集上。在模式振幅空间中，这对应于一个由 $\\mathbf{a}^{\\mathsf{T}}\\mathbf{a} = \\sum_{i=1}^{f_{\\mathrm{eff}}} a_i^2 = 2K$ 定义的 $f_{\\mathrm{eff}}$ 维超球面的表面。\n\n能量均分定理指出，对于处于热平衡的经典系统，与哈密顿量中每个独立的二次自由度相关的平均能量为 $\\frac{1}{2}k_{\\mathrm{B}}T$。在我们的公式体系中，动能由 $f_{\\mathrm{eff}}$ 个这样的二次项 $\\frac{1}{2}a_i^2$ 组成。因此，总动能 $K$ 是这些模式的平均能量之和：\n$$K = \\sum_{i=1}^{f_{\\mathrm{eff}}} \\left\\langle \\frac{1}{2}a_i^2 \\right\\rangle = f_{\\mathrm{eff}} \\cdot \\left(\\frac{1}{2}k_{\\mathrm{B}}T\\right)$$\n此处，$T$ 是动力学温度，这是分子动力学模拟中用作热力学温度估计量的一个标准度量。从此关系中，我们推导出约束微正则温度的公式：\n$$T = \\frac{2K}{f_{\\mathrm{eff}}k_{\\mathrm{B}}}$$\n此公式在 $f_{\\mathrm{eff}}  0$ 的条件下有效。如果 $f_{\\mathrm{eff}} = 0$，系统没有动能自由度，意味着 $K=0$ 和绝对零度 $T=0\\,\\mathrm{K}$。\n\n**第三部分：算法实现**\n\n该推导直接导出了以下算法：\n1.  对于给定系统（质量 $\\mathbf{m}$ 和约束雅可比矩阵 $\\mathbf{J}$），构建对角质量矩阵 $\\mathbf{M}$ 及其平方根的逆 $\\mathbf{M}^{-1/2}$。\n2.  形成质量加权约束算子 $\\mathbf{A} = \\mathbf{J}\\mathbf{M}^{-1/2}$。\n3.  数值确定 $\\mathbf{A}$ 的秩。有效自由度数为 $f_{\\mathrm{eff}} = n - \\mathrm{rank}(\\mathbf{A})$，其中 $n$ 是粒子数。\n4.  使用奇异值分解计算 $\\mathbf{A}$ 的零空间的标准正交基。结果矩阵 $\\mathbf{N}$ 的列是这些基矢量。\n5.  对于目标动能 $K_{\\text{target}}$，通过强制能量均分来构建模式振幅矢量 $\\mathbf{a}$，即，将每个模式能量 $K_i = \\frac{1}{2}a_i^2$ 设置为平均值 $K_{\\text{target}}/f_{\\mathrm{eff}}$。这得到对于所有 $i=1, \\dots, f_{\\mathrm{eff}}$，$|a_i| = \\sqrt{2K_{\\text{target}}/f_{\\mathrm{eff}}}$。不失一般性，我们选择正根。\n6.  计算模式分辨的动能 $K_i$ 和与平均模式能量的最大相对偏差 $\\delta_{\\max}$。\n7.  使用推导出的公式 $T = 2K_{\\text{target}}/(f_{\\mathrm{eff}}k_{\\mathrm{B}})$ 计算温度 $T$。\n\n此过程允许系统性地构建具有指定动能的约束速度场，并评估系统的动力学温度。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes constrained microcanonical temperature, effective degrees of freedom,\n    and energy equipartition deviation for several test cases.\n    \"\"\"\n    k_B = 1.380649e-23\n\n    test_cases = [\n        {\"m_vals\": np.array([1.66e-27, 3.32e-27, 4.98e-27]), \"J_vals\": np.array([[-1, 1, 0], [0, -1, 1]]), \"K_target\": 1.0e-20},\n        {\"m_vals\": np.array([1.66e-27, 3.32e-27, 4.98e-27, 6.64e-27]), \"J_vals\": np.array([[-1, 1, 0, 0]]), \"K_target\": 3.0e-21},\n        {\"m_vals\": np.array([1.66e-27, 3.32e-27, 4.98e-27]), \"J_vals\": np.array([[-1, 1, 0], [-2, 2, 0]]), \"K_target\": 2.5e-21},\n        {\"m_vals\": np.array([1.00e-26, 2.00e-26]), \"J_vals\": np.array([[-1, 1]]), \"K_target\": 0.0},\n    ]\n\n    results = []\n    for case in test_cases:\n        m_vals = case[\"m_vals\"]\n        J = case[\"J_vals\"]\n        K_target = case[\"K_target\"]\n\n        num_particles = len(m_vals)\n        \n        M_inv_sqrt = np.diag(1.0 / np.sqrt(m_vals))\n        A = J @ M_inv_sqrt\n\n        # Use a tolerance for rank calculation to handle floating point inaccuracies\n        rank_A = np.linalg.matrix_rank(A, tol=1e-9)\n            \n        f_eff = num_particles - rank_A\n\n        if f_eff == 0:\n            T = 0.0\n            delta_max = 0.0\n        else:\n            if K_target == 0.0:\n                T = 0.0\n                delta_max = 0.0\n            else:\n                T = (2.0 * K_target) / (f_eff * k_B)\n                \n                # Construct the null space basis N from SVD of A\n                # A = U S Vh, where Vh = V.T\n                # The columns of V corresponding to zero singular values form the null space basis.\n                # These are the last f_eff rows of Vh.\n                _U, _s, Vh = np.linalg.svd(A)\n                N = Vh[rank_A:].T\n                \n                # Set modal amplitudes 'a' for equal energy partition\n                # K_i = 0.5 * a_i^2 = K_target / f_eff\n                # a_i = sqrt(2 * K_target / f_eff)\n                a_i_val = np.sqrt(2.0 * K_target / f_eff)\n                a = np.full(f_eff, a_i_val)\n\n                # Compute mode-resolved kinetic energies\n                K_modes = 0.5 * np.square(a)\n\n                # Compute the maximum relative deviation from equipartition\n                mean_modal_energy = K_target / f_eff\n                relative_errors = np.abs((K_modes - mean_modal_energy) / mean_modal_energy)\n                delta_max = np.max(relative_errors)\n\n        results.append([T, f_eff, delta_max])\n\n    print(f\"[{','.join(map(repr, results))}]\".replace(\" \", \"\"))\n\nsolve()\n```", "id": "3494645"}, {"introduction": "热力学公式并非在所有统计系综中都可以互换，这是一个需要时刻警惕的要点。本练习将通过一个经典例子来阐明这一点，即证明正则系综中的热容涨落公式（$C_V \\propto \\mathrm{Var}(E)$）在总能量恒定的微正则系综（$NVE$）中是失效的。你将学习如何从熵函数对能量的二阶导数 $\\partial^2 S/\\partial E^2$ 出发，推导出正确的微正则热容表达式，从而对 $NVE$ 模拟中的热力学响应函数建立更深刻、更严谨的理解 [@problem_id:3494674]。", "problem": "您正在研究经典分子动力学中的恒定粒子数、恒定体积、恒定能量（$NVE$）微正则系综，及其对估算模型材料热容 $C$ 的影响。在正则（$NVT$）系综中，通常使用将热容与能量涨落联系起来的涨落公式。然而，在微正则（$NVE$）系综中，总能量是守恒的，因此正则涨落公式对于计算 $C$ 是无效的。您的目标是通过测量 $NVE$ 系综中动能 $K$ 的涨落来证明这种失效，然后利用熵 $S(E)$ 相对于能量的曲率，构建一个正确的用于计算 $C$ 的微正则替代方法。\n\n您的推理和计算应基于以下原理和事实：\n- 动能和势能可分离的经典系统的牛顿哈密顿动力学：$H = K + U$，其中 $K = \\sum_i p_i^2/(2m_i)$，$U$ 是位置的函数。\n- 微正则系综由能量壳层 $H(\\mathbf{p},\\mathbf{q}) = E$ 上的均匀概率密度定义，Gibbs 熵 $S(E)$ 可定义为 $S(E) = k_{\\mathrm{B}} \\ln \\Phi(E)$，其中 $\\Phi(E)$ 是由能量面 $H \\leq E$ 所包围的相空间体积。\n- 经典系统中的能量均分原理指出，在热平衡状态下，每个二次自由度对平均能量的贡献为 $k_{\\mathrm{B}} T / 2$。对于具有许多自由度的微正则系统，当使用 Gibbs 熵温度时，该关系在主导阶上同样成立。\n- 对于仅有二次动能项的类理想气体系统，相空间体积 $\\Phi(E)$ 的标度关系为 $\\Phi(E) \\propto E^{f/2}$，其中 $f$ 是二次动量自由度的数量。\n- 对于具有二次动能项和二次势能项的谐振子网络系统（非耦合或通过线性变换耦合），相空间体积 $\\Phi(E)$ 的标度关系为 $\\Phi(E) \\propto E^{f}$，其中 $f$ 是二次动量自由度的数量（总共有 $2f$ 个二次项贡献，$f$ 个来自能量，$f$ 个来自坐标）。\n\n任务：\n1. 对于下述每个测试用例，在微正则（$NVE$）条件下，通过对微正则分布进行采样，生成动能方差 $\\langle K^2 \\rangle - \\langle K \\rangle^2$ 的测量值。对于具有二次模式的谐振子网络，由于能量球面上分解为 $f$ 个动量和 $f$ 个坐标二次贡献的均匀测度，分数 $x = K/E$ 服从参数为 $a = f/2$、$b = f/2$ 的 Beta 分布（在 (0,1) 区间上）。对于只有动能的理想气体，$K \\equiv E$，因此 $x \\equiv 1$ 且方差为零。\n2. 使用您测量的 $\\langle K \\rangle$，通过能量均分原理定义微正则温度为 $T = 2 \\langle K \\rangle / (f k_{\\mathrm{B}})$，其中 $k_{\\mathrm{B}}$ 是玻尔兹曼常数，单位为焦耳每开尔文。\n3. 通过将动能方差代入正则公式，计算一个朴素的正则涨落估算值 $C_{\\mathrm{fluct}}$：设 $C_{\\mathrm{fluct}} = (\\langle K^2 \\rangle - \\langle K \\rangle^2) / (k_{\\mathrm{B}} T^2)$。这是对正则公式的刻意误用，您必须对其进行量化。\n4. 利用 Gibbs 熵 $S(E)$ 相对于能量的曲率构建正确的微正则热容 $C_{\\mathrm{micro}}$。不要使用任何正则涨落公式。相反，应从微正则热力学中温度的定义出发，推导出一个用 $S(E)$ 相对于 $E$ 的导数表示 $C_{\\mathrm{micro}}$ 的关系式。利用给定两种系统类型的 $\\Phi(E)$ 的标度形式，使这些导数显式化，然后计算 $C_{\\mathrm{micro}}$。\n5. 对于每个测试用例，输出两个值：$C_{\\mathrm{fluct}}$ 和 $C_{\\mathrm{micro}}$，单位均为焦耳每开尔文，以 64 位浮点数形式表示。\n\n要求：\n- 所有能量必须以焦耳（$\\mathrm{J}$）为单位，温度以开尔文（$\\mathrm{K}$）为单位，热容以焦耳每开尔文（$\\mathrm{J/K}$）为单位。\n- 此计算不涉及角度。\n- 不涉及百分比；任何比率都必须以小数形式报告。\n- 采样时使用固定的随机种子以保证可复现性。\n- 测试套件：\n  - 案例 1（边界行为，小自由度）：谐振子网络，$f = 2$，$E = 1.0 \\times 10^{-20}\\ \\mathrm{J}$。\n  - 案例 2（较大系统，多自由度）：谐振子网络，$f = 30$，$E = 1.0 \\times 10^{-19}\\ \\mathrm{J}$。\n  - 案例 3（边缘案例，仅有动能的理想气体）：理想气体，$f = 6$，$E = 1.0 \\times 10^{-21}\\ \\mathrm{J}$。\n  - 案例 4（中等大小的谐振子网络）：谐振子网络，$f = 6$，$E = 1.0 \\times 10^{-21}\\ \\mathrm{J}$。\n- 采样规范：\n  - 对于谐振子案例，从 $\\mathrm{Beta}(a,b)$ 分布中采样 $x$，其中 $a = f/2$，$b = f/2$，然后设 $K = x E$。为保证准确性，至少使用 $5 \\times 10^{4}$ 个样本。\n  - 对于理想气体，所有样本均设 $K = E$。\n- 最终输出格式：\n  - 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表。该列表必须按顺序包含 $8$ 个数字 $[C_{\\mathrm{fluct}}^{(1)}, C_{\\mathrm{micro}}^{(1)}, C_{\\mathrm{fluct}}^{(2)}, C_{\\mathrm{micro}}^{(2)}, C_{\\mathrm{fluct}}^{(3)}, C_{\\mathrm{micro}}^{(3)}, C_{\\mathrm{fluct}}^{(4)}, C_{\\mathrm{micro}}^{(4)}]$，对应于上面列出的四个测试用例。\n\n通过从所述基础推导所有必需的公式来确保科学真实性，并且不要对 $C_{\\mathrm{micro}}$ 使用任何正则涨落公式。", "solution": "该问题要求分析微正则（$NVE$）系综内的热容计算。具体来说，我们必须将一个朴素应用的正则涨落公式与一个严格推导的微正则热容 $C$ 表达式进行对比。该分析将针对两种模型系统进行：理想气体和谐振子网络。\n\n首先，我们推导微正则热容 $C_{\\mathrm{micro}}$ 的正确表达式。微正则热力学的基础是 Gibbs 熵 $S(E)$，它根据能量面 $H \\leq E$ 包围的相空间体积 $\\Phi(E)$ 定义：\n$$S(E) = k_{\\mathrm{B}} \\ln \\Phi(E)$$\n其中 $k_{\\mathrm{B}}$ 是玻尔兹曼常数。热力学温度 $T$ 定义为熵对能量的导数的倒数：\n$$ \\frac{1}{T} = \\frac{\\partial S(E)}{\\partial E} $$\n定容热容 $C$ 定义为使温度升高一个单位所需的能量，$C = \\partial E / \\partial T$。我们可以用 $S(E)$ 的导数来表示它。对温度的定义使用链式法则：\n$$ \\frac{\\partial}{\\partial E} \\left(\\frac{1}{T}\\right) = \\frac{\\partial}{\\partial T}\\left(\\frac{1}{T}\\right) \\frac{\\partial T}{\\partial E} = -\\frac{1}{T^2} \\frac{\\partial T}{\\partial E} = -\\frac{1}{T^2 C} $$\n同时，我们有：\n$$ \\frac{\\partial}{\\partial E} \\left(\\frac{1}{T}\\right) = \\frac{\\partial}{\\partial E} \\left(\\frac{\\partial S(E)}{\\partial E}\\right) = \\frac{\\partial^2 S(E)}{\\partial E^2} $$\n将这两个表达式相等，得到一个基于熵的曲率的微正则热容公式：\n$$ C_{\\mathrm{micro}} = -\\frac{1}{T^2 \\left(\\frac{\\partial^2 S(E)}{\\partial E^2}\\right)} = - \\frac{\\left(\\frac{\\partial S(E)}{\\partial E}\\right)^2}{\\frac{\\partial^2 S(E)}{\\partial E^2}} $$\n现在我们将此公式应用于具体系统，使用它们给定的相空间体积标度律。\n\n对于具有 $f$ 个二次动量自由度（并隐含地有 $f$ 个二次势能自由度）的谐振子网络，相空间体积的标度关系为 $\\Phi(E) \\propto E^f$。因此，$S(E) = k_{\\mathrm{B}} \\ln(c_1 E^f) = k_{\\mathrm{B}} \\ln c_1 + f k_{\\mathrm{B}} \\ln E$，其中 $c_1$ 是某个常数。其导数为：\n$$ \\frac{\\partial S}{\\partial E} = \\frac{f k_{\\mathrm{B}}}{E} \\quad \\text{和} \\quad \\frac{\\partial^2 S}{\\partial E^2} = -\\frac{f k_{\\mathrm{B}}}{E^2} $$\n将这些代入我们的 $C_{\\mathrm{micro}}$ 表达式：\n$$ C_{\\mathrm{micro}}^{\\mathrm{(harmonic)}} = - \\frac{\\left(\\frac{f k_{\\mathrm{B}}}{E}\\right)^2}{-\\frac{f k_{\\mathrm{B}}}{E^2}} = \\frac{f^2 k_{\\mathrm{B}}^2 / E^2}{f k_{\\mathrm{B}} / E^2} = f k_{\\mathrm{B}} $$\n\n对于具有 $f$ 个二次动量自由度的理想气体，相空间体积的标度关系为 $\\Phi(E) \\propto E^{f/2}$。熵为 $S(E) = k_{\\mathrm{B}} \\ln(c_2 E^{f/2}) = k_{\\mathrm{B}} \\ln c_2 + \\frac{f}{2} k_{\\mathrm{B}} \\ln E$。其导数为：\n$$ \\frac{\\partial S}{\\partial E} = \\frac{f k_{\\mathrm{B}}}{2E} \\quad \\text{和} \\quad \\frac{\\partial^2 S}{\\partial E^2} = -\\frac{f k_{\\mathrm{B}}}{2E^2} $$\n将这些代入 $C_{\\mathrm{micro}}$ 的表达式：\n$$ C_{\\mathrm{micro}}^{\\mathrm{(ideal)}} = - \\frac{\\left(\\frac{f k_{\\mathrm{B}}}{2E}\\right)^2}{-\\frac{f k_{\\mathrm{B}}}{2E^2}} = \\frac{f^2 k_{\\mathrm{B}}^2 / (4E^2)}{f k_{\\mathrm{B}} / (2E^2)} = \\frac{f}{2} k_{\\mathrm{B}} $$\n这些结果，$f k_{\\mathrm{B}}$ 和 $\\frac{f}{2} k_{\\mathrm{B}}$，是这些系统的正确且广为接受的经典热容值。\n\n接下来，我们评估朴素的基于涨落的估算值 $C_{\\mathrm{fluct}}$。这涉及到刻意误用正则系综的热容公式，但将其应用于微正则系综内的动能涨落。指定的公式是：\n$$ T = \\frac{2 \\langle K \\rangle}{f k_{\\mathrm{B}}} \\quad \\text{和} \\quad C_{\\mathrm{fluct}} = \\frac{\\langle K^2 \\rangle - \\langle K \\rangle^2}{k_{\\mathrm{B}} T^2} = \\frac{\\mathrm{Var}(K)}{k_{\\mathrm{B}} T^2} $$\n期望值 $\\langle K \\rangle$ 和 $\\langle K^2 \\rangle$ 将通过采样获得。\n\n对于谐振子网络，动能分数 $x = K/E$ 被指定服从参数为 $a = b = f/2$ 的 Beta 分布，$x \\sim \\mathrm{Beta}(a,b)$。该分布的均值和方差可解析地得知：\n$$ \\langle x \\rangle = \\frac{a}{a+b} = \\frac{f/2}{f} = \\frac{1}{2} $$\n$$ \\mathrm{Var}(x) = \\frac{ab}{(a+b)^2(a+b+1)} = \\frac{(f/2)^2}{f^2(f+1)} = \\frac{1}{4(f+1)} $$\n由此，我们求出动能 $K = xE$ 的均值和方差：\n$$ \\langle K \\rangle = E \\langle x \\rangle = \\frac{E}{2} $$\n$$ \\mathrm{Var}(K) = E^2 \\mathrm{Var}(x) = \\frac{E^2}{4(f+1)} $$\n使用这些解析结果（数值采样将对其进行近似），我们可以找到 $C_{\\mathrm{fluct}}$ 的表达式。首先，温度是：\n$$ T = \\frac{2 (E/2)}{f k_{\\mathrm{B}}} = \\frac{E}{f k_{\\mathrm{B}}} $$\n这个温度与从熵导出的温度（$1/T = \\partial S/\\partial E = f k_{\\mathrm{B}}/E$）相匹配，证实了问题前提的一致性。现在，我们计算 $C_{\\mathrm{fluct}}$：\n$$ C_{\\mathrm{fluct}}^{\\mathrm{(harmonic)}} = \\frac{\\mathrm{Var}(K)}{k_{\\mathrm{B}} T^2} = \\frac{E^2 / (4(f+1))}{k_{\\mathrm{B}} (E / (f k_{\\mathrm{B}}))^2} = \\frac{E^2}{4(f+1)} \\frac{f^2 k_{\\mathrm{B}}}{E^2} = \\frac{f^2}{4(f+1)} k_{\\mathrm{B}} $$\n\n对于理想气体，系统只有动能，所以 $K \\equiv E$。\n$$ \\langle K \\rangle = E \\quad \\text{和} \\quad \\mathrm{Var}(K) = \\langle E^2 \\rangle - \\langle E \\rangle^2 = E^2 - E^2 = 0 $$\n温度为 $T = 2E/(f k_{\\mathrm{B}})$，这再次与熵的导数一致。基于涨落的热容立即可得：\n$$ C_{\\mathrm{fluct}}^{\\mathrm{(ideal)}} = \\frac{0}{k_{\\mathrm{B}} T^2} = 0 $$\n\n$C_{\\mathrm{micro}}$ 和 $C_{\\mathrm{fluct}}$ 之间的差异现在很清楚了。对于谐振子网络，$C_{\\mathrm{fluct}} = k_{\\mathrm{B}} f^2 / (4(f+1))$，当 $f$ 很大时，该值趋近于 $f k_{\\mathrm{B}} / 4$，比正确值 $C_{\\mathrm{micro}} = f k_{\\mathrm{B}}$ 小 4 倍。对于理想气体，$C_{\\mathrm{fluct}}$ 恒等于零，而正确值为 $C_{\\mathrm{micro}} = f k_{\\mathrm{B}} / 2$。这表明，$NVE$ 系综中的动能涨落不能通过简单的正则公式得到热容。\n\n计算步骤将包括：\n1. 对于每个测试用例，使用 $C_{\\mathrm{micro}}^{\\mathrm{(harmonic)}} = f k_{\\mathrm{B}}$ 或 $C_{\\mathrm{micro}}^{\\mathrm{(ideal)}} = \\frac{f}{2} k_{\\mathrm{B}}$ 计算解析的 $C_{\\mathrm{micro}}$。\n2. 对于谐振子案例，从 $\\mathrm{Beta}(f/2, f/2)$ 分布中生成大量 $x$ 的样本，以获得 $\\langle K \\rangle$ 和 $\\mathrm{Var}(K)$ 的数值估计。对于理想气体案例，设 $\\langle K \\rangle = E$ 和 $\\mathrm{Var}(K) = 0$。\n3. 使用数值获得的 $\\langle K \\rangle$ 计算 $T$。\n4. 使用数值获得的 $\\mathrm{Var}(K)$ 和计算出的 $T$ 来求得 $C_{\\mathrm{fluct}}$。\n5. 报告每个测试用例的 $C_{\\mathrm{fluct}}$ 和 $C_{\\mathrm{micro}}$。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import beta\n\ndef solve():\n    \"\"\"\n    Calculates and compares a naive fluctuation-based heat capacity (C_fluct)\n    with the correct microcanonical heat capacity (C_micro) for different\n    model systems in the NVE ensemble.\n    \"\"\"\n    # Boltzmann constant in J/K\n    k_B = 1.380649e-23\n\n    # Sampling parameters\n    NUM_SAMPLES = 50000\n    # Use a fixed random seed for reproducibility\n    RNG = np.random.default_rng(seed=42)\n\n    # Test suite from the problem statement\n    test_cases = [\n        (\"harmonic\", 2, 1.0e-20),\n        (\"harmonic\", 30, 1.0e-19),\n        (\"ideal\", 6, 1.0e-21),\n        (\"harmonic\", 6, 1.0e-21),\n    ]\n\n    results = []\n\n    for system_type, f, E in test_cases:\n        #\n        # Task 4: Correct Microcanonical Heat Capacity (C_micro)\n        #\n        if system_type == \"harmonic\":\n            C_micro = f * k_B\n        elif system_type == \"ideal\":\n            C_micro = (f / 2) * k_B\n        else:\n            raise ValueError(f\"Unknown system type: {system_type}\")\n\n        #\n        # Tasks 1-3: Naive Fluctuation Heat Capacity (C_fluct)\n        #\n        if system_type == \"harmonic\":\n            # Task 1 (part 1): Sample kinetic energy K for a harmonic network\n            a = f / 2.0\n            b = f / 2.0\n            \n            x_samples = beta.rvs(a, b, size=NUM_SAMPLES, random_state=RNG)\n            K_samples = x_samples * E\n            \n            mean_K = np.mean(K_samples)\n            var_K = np.var(K_samples)\n\n        elif system_type == \"ideal\":\n            # Task 1 (part 2): For an ideal gas, K is constant and equal to E\n            mean_K = E\n            var_K = 0.0\n\n        # Task 2: Define microcanonical temperature T from mean kinetic energy\n        if f > 0:\n            T = 2 * mean_K / (f * k_B)\n        else:\n            T = 0.0\n\n        # Task 3: Calculate C_fluct\n        if T > 1e-9:\n            C_fluct = var_K / (k_B * T**2)\n        else:\n            C_fluct = 0.0\n\n        # Store the pair of results for this case\n        results.extend([C_fluct, C_micro])\n\n    # Final print statement in the exact required format\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3494674"}]}