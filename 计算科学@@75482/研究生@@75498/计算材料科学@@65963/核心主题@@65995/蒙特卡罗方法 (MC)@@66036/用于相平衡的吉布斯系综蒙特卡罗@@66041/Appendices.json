{"hands_on_practices": [{"introduction": "在实际的分子模拟中，为了计算效率，我们必须在有限的距离内截断分子间相互作用势。然而，这种截断会引入系统性误差，影响相平衡性质的准确计算。本练习 [@problem_id:3454569] 将引导您量化这种截断在吉布斯系综蒙特卡洛模拟中引起的偏差，并推导和应用必要的长程校正项。掌握这一基本技能对于从模拟中获得精确的热力学数据至关重要。", "problem": "考虑一个单组分流体的两相吉布斯系综蒙特卡洛 (GEMC) 模拟，该流体通过伦纳德-琼斯对势相互作用。伦纳德-琼斯势定义为 $u(r) = 4\\epsilon\\left[\\left(\\dfrac{\\sigma}{r}\\right)^{12} - \\left(\\dfrac{\\sigma}{r}\\right)^6\\right]$，其中 $\\epsilon$ 设定能量标度，$\\sigma$ 设定长度标度。在实际模拟中，该势在截断半径 $r_c$ 处被截断，通常会添加长程校正以补偿来自 $r>r_c$ 的被忽略的贡献。在本问题中，您将通过推导和实现两个数密度分别为 $\\rho_1$ 和 $\\rho_2$ 的盒子的尾部校正，来量化忽略长程校正时共存性质中的偏差。\n\n从以下经过充分检验的、适用于径向分布函数 $g(r)=1$（对于超出截断距离 $r_c$ 的情况）的均匀流体的基本公式出发：\n- 单位体积势能由 $U/V = \\dfrac{1}{2}\\rho^2 \\int u(r)\\, 4\\pi r^2\\,dr$ 给出。\n- 对压力的维里贡献由 $P_{\\text{vir}} = -\\dfrac{2\\pi}{3}\\rho^2 \\int r^3\\dfrac{du}{dr}\\,dr$ 给出。\n- 在 Widom 插入图像中，超额化学势由 $\\mu_{\\text{ex}} = -k_{\\text{B}}T\\ln\\left\\langle e^{-\\Delta U/k_{\\text{B}}T}\\right\\rangle$ 给出；在对于超出 $r_c$ 的尾部的平均场近似中，插入能的贡献简化为 $u(r)$ 对 $4\\pi r^2$ 的均匀积分，并由 $\\rho$ 加权。\n\n您的任务：\n1. 推导单位体积势能的尾部校正 $U_{\\text{tail}}/V$，即 $r\\in[r_c,\\infty)$ 范围内的贡献，假设在该范围内 $g(r)=1$。用 $\\rho$、$\\epsilon$、$\\sigma$ 和 $r_c$ 表示。\n2. 根据维里表达式，推导压力的尾部校正 $P_{\\text{tail}}$，即 $r\\in[r_c,\\infty)$ 范围内的贡献，假设 $g(r)=1$。\n3. 通过考虑一个测试粒子与密度为 $\\rho$ 的均匀流体中超出 $r_c$ 的粒子之间的平均场插入能，推导超额化学势的尾部校正 $\\mu_{\\text{tail}}$。\n4. 解释在 GEMC 中，跨盒子间的截断（未校正）压力和截断（未校正）化学势的均等化如何意味着真实压力和真实化学势将因尾部校正的差异而不同。将共存偏差定义为 $\\Delta P_{\\text{bias}} = P_{\\text{tail}}(\\rho_1) - P_{\\text{tail}}(\\rho_2)$ 和 $\\Delta \\mu_{\\text{bias}} = \\mu_{\\text{tail}}(\\rho_1) - \\mu_{\\text{tail}}(\\rho_2)$。\n5. 实现一个程序，对于每个测试用例，使用您推导的公式计算每个盒子中单位体积的尾部能量以及共存偏差 $\\Delta P_{\\text{bias}}$ 和 $\\Delta \\mu_{\\text{bias}}$。所有量必须以基于所提供的 $\\epsilon$ 和 $\\sigma$ 值的约化伦纳德-琼斯单位报告（即，能量单位为 $\\epsilon$，长度单位为 $\\sigma$，密度单位为 $\\sigma^{-3}$）。不涉及角度或百分比。\n\n测试套件（每个用例指定 $(\\epsilon,\\sigma,r_c,\\rho_1,\\rho_2)$）：\n- 用例 A：$(\\epsilon, \\sigma, r_c, \\rho_1, \\rho_2) = (1, 1, 2.5, 0.8, 0.02)$。\n- 用例 B：$(\\epsilon, \\sigma, r_c, \\rho_1, \\rho_2) = (1, 1, 5.0, 0.7, 0.02)$。\n- 用例 C（边界情况，密度相等）：$(\\epsilon, \\sigma, r_c, \\rho_1, \\rho_2) = (1, 1, 2.5, 0.5, 0.5)$。\n- 用例 D（短截断，偏差更强）：$(\\epsilon, \\sigma, r_c, \\rho_1, \\rho_2) = (1, 1, 1.5, 0.85, 0.01)$。\n\n对于每个测试用例，您的程序必须输出一个包含四个浮点数的列表：\n- $U_{\\text{tail}}(\\rho_1)/V$，\n- $U_{\\text{tail}}(\\rho_2)/V$，\n- $\\Delta P_{\\text{bias}}$，\n- $\\Delta \\mu_{\\text{bias}}$。\n\n最终输出格式：您的程序应生成单行输出，包含一个用方括号括起来的逗号分隔列表。其中每个元素对应一个测试用例，并且本身是上述指定的四个浮点数的列表（例如，`[[x_{A1},x_{A2},x_{A3},x_{A4}],[x_{B1},x_{B2},x_{B3},x_{B4}],\\dots]`）。", "solution": "在尝试求解之前，需对问题陈述进行验证。\n\n### 步骤1：提取已知条件\n- **系统**：一个单组分流体的两相吉布斯系综蒙特卡洛 (GEMC) 模拟。\n- **相互作用势**：伦纳德-琼斯势，$u(r) = 4\\epsilon\\left[\\left(\\dfrac{\\sigma}{r}\\right)^{12} - \\left(\\dfrac{\\sigma}{r}\\right)^6\\right]$。\n- **参数**：$\\epsilon$ (能量标度)，$\\sigma$ (长度标度)。\n- **模拟方案**：势能在截断距离 $r_c$ 处被截断。\n- **目标**：为两个数密度分别为 $\\rho_1$ 和 $\\rho_2$ 的盒子，量化在忽略长程校正时共存性质中的偏差。\n- **近似**：对于距离 $r > r_c$，径向分布函数 $g(r)=1$。\n- **基本公式**：\n    - 单位体积势能：$U/V = \\dfrac{1}{2}\\rho^2 \\int u(r)\\, 4\\pi r^2\\,dr$。\n    - 对压力的维里贡献：$P_{\\text{vir}} = -\\dfrac{2\\pi}{3}\\rho^2 \\int r^3\\dfrac{du}{dr}\\,dr$。\n    - 超额化学势（平均场尾部）：插入能的贡献是 $u(r)$ 对 $4\\pi r^2$ 的均匀积分，并由密度 $\\rho$ 加权。\n- **任务**：\n    1. 推导单位体积势能的尾部校正 $U_{\\text{tail}}/V$。\n    2. 推导压力的尾部校正 $P_{\\text{tail}}$。\n    3. 推导超额化学势的尾部校正 $\\mu_{\\text{tail}}$。\n    4. 解释在 GEMC 中共存偏差 $\\Delta P_{\\text{bias}}$ 和 $\\Delta \\mu_{\\text{bias}}$ 的来源。\n    5. 实现一个程序来计算 $U_{\\text{tail}}(\\rho_1)/V$、$U_{\\text{tail}}(\\rho_2)/V$、$\\Delta P_{\\text{bias}}$ 和 $\\Delta \\mu_{\\text{bias}}$。\n- **单位**：所有量都应以基于 $\\epsilon$ 和 $\\sigma$ 的约化伦纳德-琼斯单位表示。\n- **测试用例**：\n    - 用例 A：$(\\epsilon, \\sigma, r_c, \\rho_1, \\rho_2) = (1, 1, 2.5, 0.8, 0.02)$。\n    - 用例 B：$(\\epsilon, \\sigma, r_c, \\rho_1, \\rho_2) = (1, 1, 5.0, 0.7, 0.02)$。\n    - 用例 C：$(\\epsilon, \\sigma, r_c, \\rho_1, \\rho_2) = (1, 1, 2.5, 0.5, 0.5)$。\n    - 用例 D：$(\\epsilon, \\sigma, r_c, \\rho_1, \\rho_2) = (1, 1, 1.5, 0.85, 0.01)$。\n- **输出格式**：一个包含每个测试用例的四个浮点数列表的列表的单行：`[[U_{\\text{tail}}(\\rho_1)/V, U_{\\text{tail}}(\\rho_2)/V, \\Delta P_{\\text{bias}}, \\Delta \\mu_{\\text{bias}}]_{\\text{A}}, \\dots]`。\n\n### 步骤2：使用提取的已知条件进行验证\n根据验证标准对问题进行评估：\n- **科学依据**：该问题是统计力学和计算物理学中的一个标准练习。它涉及伦纳德-琼斯流体、吉布斯系综模拟以及长程校正的推导，这些都是基础且成熟的概念。对于 $r > r_c$ 假设 $g(r)=1$ 是这些推导中标准的平均场近似。\n- **定义明确**：问题规范清晰。它要求推导特定的物理量，并随后对给定参数集进行数值计算。任务明确，可得出唯一解。\n- **客观性**：语言技术性强且精确，没有任何主观或有偏见的陈述。\n- **缺陷检查**：该问题不违反任何无效性标准。它在科学上是合理的，可形式化，完整，并提出了一个在计算科学中具有一定挑战性但可解决的问题。\n\n### 步骤3：结论与操作\n此问题是**有效的**。将提供分步解答。\n\n---\n\n推导将使用约化伦纳德-琼斯单位进行，其中能量以 $\\epsilon$ 为单位表示，长度以 $\\sigma$ 为单位表示，密度 $\\rho^*$ 以 $\\sigma^{-3}$ 为单位表示，以此类推。测试用例提供了 $\\epsilon=1$ 和 $\\sigma=1$，因此给定的 $r_c$ 和 $\\rho$ 的数值已经处于适当的约化单位。为简洁起见，将省略约化量上的星号符号。约化伦纳德-琼斯势为：\n$$\nu(r) = 4\\left(r^{-12} - r^{-6}\\right)\n$$\n\n**1. 势能尾部校正的推导，$U_{\\text{tail}}/V$**\n\n单位体积势能的尾部校正是来自距离 $r \\in [r_c, \\infty)$ 的相互作用的贡献。使用所提供的公式和在该范围内 $g(r)=1$ 的假设：\n$$\n\\frac{U_{\\text{tail}}}{V} = \\frac{1}{2}\\rho^2 \\int_{r_c}^{\\infty} u(r) \\, 4\\pi r^2 \\, dr\n$$\n代入伦纳德-琼斯势：\n$$\n\\frac{U_{\\text{tail}}}{V} = \\frac{1}{2}\\rho^2 \\int_{r_c}^{\\infty} 4\\left(r^{-12} - r^{-6}\\right) \\, 4\\pi r^2 \\, dr = 8\\pi\\rho^2 \\int_{r_c}^{\\infty} \\left(r^{-10} - r^{-4}\\right) \\, dr\n$$\n进行积分：\n$$\n\\int \\left(r^{-10} - r^{-4}\\right) \\, dr = \\frac{r^{-9}}{-9} - \\frac{r^{-3}}{-3} = -\\frac{1}{9}r^{-9} + \\frac{1}{3}r^{-3}\n$$\n计算从 $r_c$ 到 $\\infty$ 的定积分：\n$$\n\\left[-\\frac{1}{9}r^{-9} + \\frac{1}{3}r^{-3}\\right]_{r_c}^{\\infty} = (0 - 0) - \\left(-\\frac{1}{9}r_c^{-9} + \\frac{1}{3}r_c^{-3}\\right) = \\frac{1}{9}r_c^{-9} - \\frac{1}{3}r_c^{-3}\n$$\n因此，单位体积势能尾部校正的最终表达式为：\n$$\n\\frac{U_{\\text{tail}}}{V}(\\rho, r_c) = 8\\pi\\rho^2 \\left(\\frac{1}{9r_c^9} - \\frac{1}{3r_c^3}\\right)\n$$\n\n**2. 压力尾部校正的推导，$P_{\\text{tail}}$**\n\n压力的尾部校正来自 $r \\in [r_c, \\infty)$ 的维里贡献。首先，我们求势的导数：\n$$\n\\frac{du}{dr} = 4\\left(-12r^{-13} + 6r^{-7}\\right)\n$$\n压力的尾部贡献则为：\n$$\nP_{\\text{tail}} = -\\frac{2\\pi}{3}\\rho^2 \\int_{r_c}^{\\infty} r^3 \\frac{du}{dr} \\, dr = -\\frac{2\\pi}{3}\\rho^2 \\int_{r_c}^{\\infty} r^3 \\cdot 4\\left(-12r^{-13} + 6r^{-7}\\right) \\, dr\n$$\n$$\nP_{\\text{tail}} = -\\frac{8\\pi}{3}\\rho^2 \\int_{r_c}^{\\infty} \\left(-12r^{-10} + 6r^{-4}\\right) \\, dr\n$$\n对表达式进行积分：\n$$\n\\int \\left(-12r^{-10} + 6r^{-4}\\right) \\, dr = -12\\frac{r^{-9}}{-9} + 6\\frac{r^{-3}}{-3} = \\frac{4}{3}r^{-9} - 2r^{-3}\n$$\n计算定积分：\n$$\n\\left[\\frac{4}{3}r^{-9} - 2r^{-3}\\right]_{r_c}^{\\infty} = (0 - 0) - \\left(\\frac{4}{3}r_c^{-9} - 2r_c^{-3}\\right) = 2r_c^{-3} - \\frac{4}{3}r_c^{-9}\n$$\n将其代回，压力的尾部校正为：\n$$\nP_{\\text{tail}}(\\rho, r_c) = -\\frac{8\\pi}{3}\\rho^2 \\left(2r_c^{-3} - \\frac{4}{3}r_c^{-9}\\right) = \\frac{32\\pi}{9}\\rho^2 r_c^{-9} - \\frac{16\\pi}{3}\\rho^2 r_c^{-3}\n$$\n\n**3. 化学势尾部校正的推导，$\\mu_{\\text{tail}}$**\n\n超额化学势的尾部校正对应于单个测试粒子与系统中所有超出 $r_c$ 的其他粒子之间的相互作用能，假设密度为均匀的 $\\rho$。\n$$\n\\mu_{\\text{tail}} = \\int_{r_c}^{\\infty} u(r) \\rho g(r) \\, 4\\pi r^2 \\, dr\n$$\n当 $g(r)=1$时：\n$$\n\\mu_{\\text{tail}} = \\rho \\int_{r_c}^{\\infty} u(r) \\, 4\\pi r^2 \\, dr\n$$\n该积分与为能量校正所做的积分相关。具体而言，$\\mu_{\\text{tail}} = \\dfrac{2}{\\rho} \\left( \\dfrac{U_{\\text{tail}}}{V} \\right)$。使用任务1的结果：\n$$\n\\int_{r_c}^{\\infty} u(r) \\, 4\\pi r^2 \\, dr = 8\\pi \\left(\\frac{1}{9r_c^9} - \\frac{1}{3r_c^3}\\right)\n$$\n因此，超额化学势的尾部校正为：\n$$\n\\mu_{\\text{tail}}(\\rho, r_c) = 8\\pi\\rho \\left(\\frac{1}{9r_c^9} - \\frac{1}{3r_c^3}\\right)\n$$\n注意，问题要求的是插入能的 $\\mu_{tail}$，根据 Widom 测试粒子方法在平均场近似下的推导，这实际上是 $2 \\times (U_{excess}/N)$。所推导的公式实际上是 $U_{excess}/N$，因为陈述指的是“插入能贡献(...)简化为均匀积分”。超额化学势尾部贡献的标准定义实际上是每个粒子超额能量尾部贡献的两倍。\n$$\n\\mu_{\\text{tail}} = \\rho \\int_{r_c}^\\infty u(r) 4 \\pi r^2 dr = 2 \\left( \\frac{1}{2} \\rho \\int_{r_c}^\\infty u(r) 4 \\pi r^2 dr \\right) = 2 \\frac{U_{\\text{tail, per particle}}}{1}\n$$\n问题中的积分表达式暗示了尾部能量，而在化学势的背景下，因子 $2$ 是标准的。\n所以，$\\mu_{\\text{tail}}$ 是一个粒子相互作用能的 $2$ 倍。一个粒子与平均场流体的相互作用是 $\\rho \\int u(r) 4\\pi r^2 dr$。\n$$\n\\mu_{\\text{tail}}(\\rho, r_c) = \\rho \\int_{r_c}^{\\infty} 4\\left(r^{-12} - r^{-6}\\right) 4\\pi r^2 dr = 16\\pi\\rho \\int_{r_c}^{\\infty} \\left(r^{-10} - r^{-4}\\right) dr\n$$\n使用之前的积分结果：\n$$\n\\mu_{\\text{tail}}(\\rho, r_c) = 16\\pi\\rho \\left(\\frac{1}{9r_c^9} - \\frac{1}{3r_c^3}\\right)\n$$\n\n**4. GEMC 中的共存偏差**\n\n在 GEMC 模拟中，两相（例如，盒子1中的液体，盒子2中的蒸气）之间的平衡要求温度、压力和化学势相等：$T_1=T_2$，$P_1=P_2$，和 $\\mu_1=\\mu_2$。模拟算法强制执行这些条件。\n当使用没有长程校正的截断势时，算法实际上是使*截断*性质相等，这些性质是仅从 $r \\le r_c$ 的势计算得出的。让这些性质为 $P_{\\text{trunc}}$ 和 $\\mu_{\\text{trunc}}$。因此，在收敛时，模拟建立：\n$$\nP_{1, \\text{trunc}} = P_{2, \\text{trunc}} \\quad \\text{和} \\quad \\mu_{1, \\text{trunc}} = \\mu_{2, \\text{trunc}}\n$$\n真实的物理性质是截断部分和尾部校正的总和：\n$$\nP_{\\text{true}}(\\rho) = P_{\\text{trunc}}(\\rho) + P_{\\text{tail}}(\\rho)\n$$\n$$\n\\mu_{\\text{true}}(\\rho) = \\mu_{\\text{trunc}}(\\rho) + \\mu_{\\text{tail}}(\\rho)\n$$\n因此，两个盒子之间*真实*压力的差异是：\n$$\n\\Delta P = P_{1, \\text{true}} - P_{2, \\text{true}} = \\left(P_{1, \\text{trunc}} + P_{\\text{tail}}(\\rho_1)\\right) - \\left(P_{2, \\text{trunc}} + P_{\\text{tail}}(\\rho_2)\\right)\n$$\n由于 $P_{1, \\text{trunc}} = P_{2, \\text{trunc}}$，这简化为压力偏差：\n$$\n\\Delta P_{\\text{bias}} = P_{\\text{tail}}(\\rho_1) - P_{\\text{tail}}(\\rho_2)\n$$\n类似地，*真实*化学势的差异是：\n$$\n\\Delta \\mu = \\mu_{1, \\text{true}} - \\mu_{2, \\text{true}} = \\left(\\mu_{1, \\text{trunc}} + \\mu_{\\text{tail}}(\\rho_1)\\right) - \\left(\\mu_{2, \\text{trunc}} + \\mu_{\\text{tail}}(\\rho_2)\\right)\n$$\n由于 $\\mu_{1, \\text{trunc}} = \\mu_{2, \\text{trunc}}$，这简化为化学势偏差：\n$$\n\\Delta \\mu_{\\text{bias}} = \\mu_{\\text{tail}}(\\rho_1) - \\mu_{\\text{tail}}(\\rho_2)\n$$\n因为尾部校正 $P_{\\text{tail}}$ 和 $\\mu_{\\text{tail}}$ 分别是密度 $\\rho^2$ 和 $\\rho$ 的函数，并且共存相具有不同的密度（$\\rho_1 \\neq \\rho_2$），所以尾部校正不相等。这导致了系统性误差，或称为偏差，使得模拟系统没有达到真正的力学和化学平衡。\n\n**5. 实现**\n以下 Python 代码实现了推导出的公式，并为给定的测试用例计算所需的量。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef u_tail_per_v(rho, rc):\n    \"\"\"\n    Calculates the tail correction to the potential energy per unit volume\n    in reduced Lennard-Jones units.\n    Formula: U_tail/V = 8 * pi * rho^2 * (1/9 * rc^-9 - 1/3 * rc^-3)\n    \"\"\"\n    rc_inv3 = 1.0 / (rc**3)\n    rc_inv9 = 1.0 / (rc**9)\n    return 8.0 * np.pi * rho**2 * (rc_inv9 / 9.0 - rc_inv3 / 3.0)\n\ndef p_tail(rho, rc):\n    \"\"\"\n    Calculates the tail correction to the pressure in reduced\n    Lennard-Jones units.\n    Formula: P_tail = (32*pi/9 * rc^-9 - 16*pi/3 * rc^-3) * rho^2\n    \"\"\"\n    rc_inv3 = 1.0 / (rc**3)\n    rc_inv9 = 1.0 / (rc**9)\n    term1 = (32.0 * np.pi / 9.0) * rc_inv9\n    term2 = -(16.0 * np.pi / 3.0) * rc_inv3\n    return (term1 + term2) * rho**2\n\ndef mu_tail(rho, rc):\n    \"\"\"\n    Calculates the tail correction to the excess chemical potential in\n    reduced Lennard-Jones units.\n    Formula: mu_tail = 16 * pi * rho * (1/9 * rc^-9 - 1/3 * rc^-3)\n    \"\"\"\n    rc_inv3 = 1.0 / (rc**3)\n    rc_inv9 = 1.0 / (rc**9)\n    return 16.0 * np.pi * rho * (rc_inv9 / 9.0 - rc_inv3 / 3.0)\n\ndef solve():\n    \"\"\"\n    Solves the problem for all test cases and prints the results in the\n    specified format.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    # Each case is a tuple: (epsilon, sigma, r_c, rho_1, rho_2)\n    # Since epsilon and sigma are 1, parameters are already in reduced units.\n    test_cases = [\n        (1, 1, 2.5, 0.8, 0.02),\n        (1, 1, 5.0, 0.7, 0.02),\n        (1, 1, 2.5, 0.5, 0.5),\n        (1, 1, 1.5, 0.85, 0.01),\n    ]\n\n    results = []\n    for case in test_cases:\n        epsilon, sigma, rc, rho1, rho2 = case\n\n        # Calculate the tail energy per unit volume for each box\n        U_tail_V1 = u_tail_per_v(rho1, rc)\n        U_tail_V2 = u_tail_per_v(rho2, rc)\n\n        # Calculate the tail pressure for each box\n        P_tail1 = p_tail(rho1, rc)\n        P_tail2 = p_tail(rho2, rc)\n        # The pressure bias is the difference in tail corrections\n        delta_P_bias = P_tail1 - P_tail2\n\n        # Calculate the tail chemical potential for each box\n        mu_tail1 = mu_tail(rho1, rc)\n        mu_tail2 = mu_tail(rho2, rc)\n        # The chemical potential bias is the difference in tail corrections\n        delta_mu_bias = mu_tail1 - mu_tail2\n\n        case_results = [U_tail_V1, U_tail_V2, delta_P_bias, delta_mu_bias]\n        results.append(case_results)\n\n    # Final print statement in the exact required format.\n    # [[val_A1, val_A2, ...], [val_B1, val_B2, ...], ...]\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3454569"}, {"introduction": "为了研究混合物的相行为，可以将标准的吉布斯系综推广到半巨正则系综，在该系综中，我们固定物种间的化学势差 $\\Delta \\mu$ 而不是各物种的总粒子数。本练习 [@problem_id:3454556] 首先要求您从第一性原理出发，为关键的“身份交换”蒙特卡洛移动推导其接受率。接着，您将把这个框架应用于一个实际问题：在一个平均场模型中识别共沸物的存在，从而将微观的模拟规则与宏观的热力学现象联系起来。", "problem": "你需要编写一个完整的、可运行的程序，该程序基于平均场正则溶液模型，使用半巨正则吉布斯系综来检测二元混合物中的共沸物。你的任务是：从第一性原理推导身份交换移动的接受概率，并实现一个数值求解器，在组成-温度平面上绘制连接线，并检测是否存在共沸物。\n\n从以下基本基础开始：\n- 巨正则系综和半巨正则系综中的玻尔兹曼分布。一个能量为 $U$、物种 $A$ 数量为 $N_A$、物种 $B$ 数量为 $N_B$、温度为 $T$、化学势为 $\\mu_A$ 和 $\\mu_B$ 的微观态的概率权重正比于 $\\exp\\left(-\\beta U + \\beta \\mu_A N_A + \\beta \\mu_B N_B\\right)$，其中 $\\beta = 1/(k_B T)$，$k_B$ 是玻尔兹曼常数。\n- 蒙特卡洛移动的细致平衡：必须选择接受概率 $p_{\\mathrm{acc}}$，以使具有转移概率 $T(i \\to j)$ 的马尔可夫链具有玻尔兹曼稳态分布。\n- 在温度 $T$ 和摩尔分数 $x_B$下，盒子 $i$ 中单个粒子的平均场正则溶液自由能模型为\n$$\nf_i(x_B,T) = k_B T\\left[x_B \\ln x_B + (1-x_B)\\ln(1-x_B)\\right] + \\frac{z_i}{2}\\left[x_B^2 \\varepsilon_{BB} + (1-x_B)^2 \\varepsilon_{AA} + 2 x_B (1-x_B) \\varepsilon_{AB}\\right],\n$$\n其中 $z_i$ 是盒子 $i$ 中的有效配位数，与密度成正比，$\\varepsilon_{AA}$、$\\varepsilon_{BB}$ 和 $\\varepsilon_{AB}$ 是相互作用能参数。\n\n你的推导必须得到在固定化学势差 $\\Delta \\mu = \\mu_B - \\mu_A$ 的半巨正则吉布斯系综中，切换一个选定粒子身份的身份交换接受概率：\n$$\np_{\\mathrm{acc}} = \\min\\left[1, \\exp\\left(-\\beta \\Delta U + \\beta \\Delta \\mu \\, \\Delta N_B\\right)\\right],\n$$\n其中 $\\Delta U$ 是能量变化，$\\Delta N_B$ 是由于身份交换导致盒子中物种 $B$ 数量的变化。\n\n对于计算任务，考虑代表两个共存相（类液相和类气相）的两个盒子，它们处于相同温度 $T$。两个盒子中的密度遵循临界温度 $T_c$ 附近的平均场共存关系：\n$$\n\\rho_L(T) = \\rho_c + \\rho_0 \\sqrt{\\max\\left(0, 1 - \\frac{T}{T_c}\\right)}, \\quad \\rho_V(T) = \\rho_c - \\rho_0 \\sqrt{\\max\\left(0, 1 - \\frac{T}{T_c}\\right)}.\n$$\n有效配位数是 $z_L(T) = z_0 \\rho_L(T)$ 和 $z_V(T) = z_0 \\rho_V(T)$，其中 $z_0$ 是一个常数。在化学势差 $\\Delta \\mu$ 恒定的半巨正则描述中，在温度 $T$ 下，盒子 $i$ 中的平衡组成通过求解以下方程获得：\n$$\n\\frac{\\partial f_i}{\\partial x_B}(x_B,T) = \\Delta \\mu,\n$$\n即，\n$$\nk_B T \\ln \\frac{x_B}{1-x_B} + z_i(T) \\left[x_B \\varepsilon_{BB} - (1-x_B)\\varepsilon_{AA} + (1-2x_B)\\varepsilon_{AB}\\right] = \\Delta \\mu.\n$$\n在给定的 $T$ 下，该方程为两个盒子定义了 $x_B^{(L)}(T)$ 和 $x_B^{(V)}(T)$。在温度 $T$ 下的连接线是点对 $\\{x_B^{(L)}(T), x_B^{(V)}(T)\\}$。当温度满足 $x_B^{(L)}(T) = x_B^{(V)}(T)$ 时，出现共沸物。\n\n你的程序应：\n- 实现一个函数，对于给定的参数和温度列表，求解每个盒子中的平衡方程，以获得整个温度网格上的 $x_B^{(L)}(T)$ 和 $x_B^{(V)}(T)$。\n- 通过找到一个温度 $T$，使得绝对差 $\\left|x_B^{(L)}(T) - x_B^{(V)}(T)\\right|$ 最小化并低于容差 $\\tau$，来检测共沸物。报告共沸温度 $T_{\\mathrm{az}}$ 和组成 $x_{B,\\mathrm{az}} = \\frac{1}{2}\\left[x_B^{(L)}(T_{\\mathrm{az}}) + x_B^{(V)}(T_{\\mathrm{az}})\\right]$。如果网格内不存在这样的温度，则返回一个表示未找到共沸物的标记值。\n- 所有温度和能量都采用约化单位，其中 $k_B = 1$；所有输出均以约化温度单位和无量纲小数表示的摩尔分数表示。将所有输出四舍五入到三位小数。\n\n测试套件：\n- 案例1（一般共存）：$\\varepsilon_{AA} = -1.0$, $\\varepsilon_{BB} = -0.5$, $\\varepsilon_{AB} = -0.7$, $z_0 = 6.0$, $\\rho_c = 0.5$, $\\rho_0 = 0.4$, $T_c = 1.5$, $\\Delta \\mu = 0.0$, 温度网格 $\\{0.6, 0.8, 1.0, 1.2, 1.4\\}$, 容差 $\\tau = 0.02$。\n- 案例2（简并对称相互作用，类边界行为）：$\\varepsilon_{AA} = -0.8$, $\\varepsilon_{BB} = -0.8$, $\\varepsilon_{AB} = -0.8$, $z_0 = 6.0$, $\\rho_c = 0.5$, $\\rho_0 = 0.4$, $T_c = 1.5$, $\\Delta \\mu = 0.0$, 温度网格 $\\{0.6, 0.8, 1.0, 1.2, 1.4\\}$, 容差 $\\tau = 0.02$。\n- 案例3（由于有偏的化学势差而无共沸物）：$\\varepsilon_{AA} = -1.0$, $\\varepsilon_{BB} = -0.5$, $\\varepsilon_{AB} = -0.7$, $z_0 = 6.0$, $\\rho_c = 0.5$, $\\rho_0 = 0.4$, $T_c = 1.5$, $\\Delta \\mu = 0.4$, 温度网格 $\\{0.6, 0.8, 1.0, 1.2, 1.4\\}$, 容差 $\\tau = 0.02$。\n\n最终输出格式：\n- 你的程序应该生成一行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果。每个测试用例的结果如果检测到共沸物，则必须是一个二元列表 $[T_{\\mathrm{az}}, x_{B,\\mathrm{az}}]$，否则为 $[-1.0,-1.0]$。例如，输出可能看起来像 $[[0.800,0.500],[-1.000,-1.000],[1.200,0.470]]$。", "solution": "该问题提出了两个不同但相关的任务。第一个是理论推导，即在半巨正则系综中蒙特卡洛身份交换移动的接受概率。第二个是计算任务，即使用从此框架派生的平均场热力学模型，在二元混合物中寻找共沸物。\n\n### 第1部分：身份交换接受概率的推导\n\n我们从系统的基本统计力学描述开始。问题指定了一个半巨正则系综，其中温度 $T$、总粒子数 $N = N_A + N_B$ 和体积 $V$ 是固定的，同时化学势差 $\\Delta\\mu = \\mu_B - \\mu_A$ 也是固定的。具有能量 $U$ 和组成 $(N_A, N_B)$ 的微观态的概率 $\\pi$ 由该系综的玻尔兹曼分布给出。\n\n在巨正则系综中，一个状态的概率正比于 $\\exp(-\\beta U + \\beta\\mu_A N_A + \\beta\\mu_B N_B)$，其中 $\\beta = 1/(k_B T)$。我们可以使用指定的约束重写指数部分：\n$$\n-\\beta U + \\beta\\mu_A N_A + \\beta\\mu_B N_B = -\\beta U + \\beta\\mu_A N_A + \\beta(\\mu_A + \\Delta\\mu) N_B\n$$\n$$\n= -\\beta U + \\beta\\mu_A (N_A + N_B) + \\beta\\Delta\\mu N_B\n$$\n由于总粒子数 $N = N_A + N_B$ 是固定的，因此对于所有可通过身份交换移动访问的状态，$\\beta\\mu_A N$ 项是一个常数。因此，该项可以被吸收到概率分布的归一化常数中。因此，一个微观态的统计权重正比于：\n$$\n\\pi(U, N_B) \\propto \\exp(-\\beta U + \\beta\\Delta\\mu N_B)\n$$\n这是一个有效的蒙特卡洛模拟必须采样的稳态分布。\n\n身份交换移动包括将一个物种 A 的粒子变为 B，反之亦然。让我们考虑从一个初始态 $i$ 到一个最终态 $j$ 的转变。这些状态由其能量和组成来表征，即 $i = (U_i, N_{B,i})$ 和 $j = (U_j, N_{B,j})$。\n\n蒙特卡洛模拟的动力学必须满足细致平衡条件，这确保了模拟能正确地采样稳态分布 $\\pi$。细致平衡条件是：\n$$\n\\pi_i T(i \\to j) = \\pi_j T(j \\to i)\n$$\n其中 $T(i \\to j)$ 是从状态 $i$ 到状态 $j$ 的转移概率。这个转移概率可以分解为一个提议概率 $\\alpha(i \\to j)$ 和一个接受概率 $p_{\\mathrm{acc}}(i \\to j)$，使得 $T(i \\to j) = \\alpha(i \\to j) p_{\\mathrm{acc}}(i \\to j)$。\n\n将此代入细致平衡方程得到：\n$$\n\\pi_i \\alpha(i \\to j) p_{\\mathrm{acc}}(i \\to j) = \\pi_j \\alpha(j \\to i) p_{\\mathrm{acc}}(j \\to i)\n$$\n这可以重新排列以表示接受概率的比率：\n$$\n\\frac{p_{\\mathrm{acc}}(i \\to j)}{p_{\\mathrm{acc}}(j \\to i)} = \\frac{\\pi_j}{\\pi_i} \\frac{\\alpha(j \\to i)}{\\alpha(i \\to j)}\n$$\n对于身份交换移动，一个简单的提议方案是随机选择 $N$ 个粒子中的一个并尝试翻转其身份。提议一个 $A \\to B$ 移动的概率与 A 粒子的数量 $N_A$ 成正比，而提议一个 $B \\to A$ 移动的概率与 $N_B$ 成正比。然而，一个更简单的选择是对称提议：从所有粒子中均匀随机地选择一个并尝试翻转其身份。在这种情况下，$\\alpha(i \\to j) = \\alpha(j \\to i)$，提议比率为1。Metropolis-Hastings 准则随后简化为 Metropolis 选择：\n$$\np_{\\mathrm{acc}}(i \\to j) = \\min\\left(1, \\frac{\\pi_j}{\\pi_i}\\right)\n$$\n我们现在计算稳态概率之比 $\\pi_j / \\pi_i$：\n$$\n\\frac{\\pi_j}{\\pi_i} = \\frac{\\exp(-\\beta U_j + \\beta\\Delta\\mu N_{B,j})}{\\exp(-\\beta U_i + \\beta\\Delta\\mu N_{B,i})}\n$$\n$$\n\\frac{\\pi_j}{\\pi_i} = \\exp[-\\beta(U_j - U_i) + \\beta\\Delta\\mu(N_{B,j} - N_{B,i})]\n$$\n令 $\\Delta U = U_j - U_i$ 为能量变化，$\\Delta N_B = N_{B,j} - N_{B,i}$ 为 B 粒子数量的变化。该比率变为：\n$$\n\\frac{\\pi_j}{\\pi_i} = \\exp(-\\beta \\Delta U + \\beta\\Delta\\mu \\Delta N_B)\n$$\n对于 $A \\to B$ 交换，一个 A 粒子被转换为 B 粒子，所以 $\\Delta N_B = +1$。对于 $B \\to A$ 交换，$\\Delta N_B = -1$。\n将该比率代入 Metropolis 公式，得到最终的接受概率：\n$$\np_{\\mathrm{acc}} = \\min\\left[1, \\exp\\left(-\\beta \\Delta U + \\beta \\Delta \\mu \\, \\Delta N_B\\right)\\right]\n$$\n这样就完成了所要求的推导。\n\n### 第2部分：共沸物检测的算法方法\n\n计算任务是通过分析二元混合物的相平衡来找到共沸物。当两个共存相（液相 L 和气相 V）的组成变得相等时，即 $x_B^{(L)}(T_{\\mathrm{az}}) = x_B^{(V)}(T_{\\mathrm{az}})$，在温度 $T_{\\mathrm{az}}$ 处出现共沸物。\n\n该系统由一个平均场正则溶液模型描述。在给定的温度 $T$ 和化学势差 $\\Delta\\mu$ 下，每个相 $i \\in \\{L, V\\}$ 中的平衡组成 $x_B$ 由热力学平衡条件确定，该条件表明单个粒子的自由能 $f_i$ 对组成 $x_B$ 的偏导数等于 $\\Delta\\mu$：\n$$\n\\frac{\\partial f_i}{\\partial x_B}(x_B, T) = \\Delta \\mu\n$$\n使用所提供的 $f_i(x_B, T)$ 表达式，该条件产生了以下关于 $x_B$ 的超越方程：\n$$\nk_B T \\ln \\frac{x_B}{1-x_B} + z_i(T) \\left[x_B \\varepsilon_{BB} - (1-x_B)\\varepsilon_{AA} + (1-2x_B)\\varepsilon_{AB}\\right] = \\Delta \\mu\n$$\n有效配位数 $z_i(T)$ 取决于各相的温度依赖性密度 $\\rho_i(T)$：\n$$\nz_i(T) = z_0 \\rho_i(T)\n$$\n液相和气相的密度由临界温度 $T_c$ 附近的平均场标度关系给出：\n$$\n\\rho_L(T) = \\rho_c + \\rho_0 \\sqrt{\\max\\left(0, 1 - \\frac{T}{T_c}\\right)}\n$$\n$$\n\\rho_V(T) = \\rho_c - \\rho_0 \\sqrt{\\max\\left(0, 1 - \\frac{T}{T_c}\\right)}\n$$\n对于任何温度 $T  T_c$，我们有 $\\rho_L(T) \\neq \\rho_V(T)$，这意味着 $z_L(T) \\neq z_V(T)$。因此，两相的平衡方程是不同的，可能导致不同的组成 $x_B^{(L)}$ 和 $x_B^{(V)}$。在临界温度 $T = T_c$ 时，密度和配位数变得相等，$z_L = z_V$，因此组成也必须相同，$x_B^{(L)} = x_B^{(V)}$。如果参数的组合使得尽管密度不同但组成相等，则可能在 $T  T_c$ 时出现共沸物。\n\n寻找共沸物的算法如下：\n1.  遍历所提供的温度网格中的每个温度 $T$。\n2.  对于每个 $T$，计算密度 $\\rho_L(T)$ 和 $\\rho_V(T)$ 以及配位数 $z_L(T)$ 和 $z_V(T)$。\n3.  定义我们为每个相 $i$ 寻求其根的函数：\n    $$\n    F_i(x_B) = k_B T \\ln \\frac{x_B}{1-x_B} + z_i(T) \\left[x_B \\varepsilon_{BB} - (1-x_B)\\varepsilon_{AA} + (1-2x_B)\\varepsilon_{AB}\\right] - \\Delta \\mu\n    $$\n4.  分别求解非线性方程 $F_L(x_B^{(L)}) = 0$ 和 $F_V(x_B^{(V)}) = 0$ 以得到 $x_B^{(L)}$ 和 $x_B^{(V)}$。由于对于给定的参数，函数 $F_i(x_B)$ 在区间 $x_B \\in (0, 1)$ 内是单调的，因此使用像 Brent-Dekker 方法（SciPy 中的 `brentq`）这样的稳健数值求根方法是合适的。\n5.  计算组成的绝对差，$\\Delta x_B(T) = |x_B^{(L)}(T) - x_B^{(V)}(T)|$。\n6.  记录产生迄今为止发现的最小差异 $\\Delta x_{B, \\min}$ 的温度 $T^*$。如果多个温度给出相同的最小差异，则选择最低的温度。\n7.  检查完网格中的所有温度后，如果最小差异 $\\Delta x_{B, \\min}$ 小于指定的容差 $\\tau$，则认为检测到了共沸物。共沸温度为 $T_{\\mathrm{az}} = T^*$，组成为 $x_{B, \\mathrm{az}} = \\frac{1}{2}\\left[x_B^{(L)}(T^*) + x_B^{(V)}(T^*)\\right]$。\n8.  如果 $\\Delta x_{B, \\min} \\geq \\tau$，则在给定的温度网格和容差内未找到共沸物。报告一个标记值。\n9.  所有数值输出均四舍五入到三位小数。\n\n此过程系统地绘制了整个温度网格上的连接线 $\\{x_B^{(L)}(T), x_B^{(V)}(T)\\}$，并识别出最接近的点，如果足够近，则将其识别为共沸物。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import brentq\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite for azeotrope detection.\n    \"\"\"\n    # Test cases as defined in the problem statement.\n    # (params, temp_grid, tolerance)\n    test_cases = [\n        ({\n            'eps_AA': -1.0, 'eps_BB': -0.5, 'eps_AB': -0.7, \n            'z0': 6.0, 'rho_c': 0.5, 'rho_0': 0.4, 'Tc': 1.5, 'delta_mu': 0.0\n         }, np.array([0.6, 0.8, 1.0, 1.2, 1.4]), 0.02),\n        ({\n            'eps_AA': -0.8, 'eps_BB': -0.8, 'eps_AB': -0.8,\n            'z0': 6.0, 'rho_c': 0.5, 'rho_0': 0.4, 'Tc': 1.5, 'delta_mu': 0.0\n         }, np.array([0.6, 0.8, 1.0, 1.2, 1.4]), 0.02),\n        ({\n            'eps_AA': -1.0, 'eps_BB': -0.5, 'eps_AB': -0.7, \n            'z0': 6.0, 'rho_c': 0.5, 'rho_0': 0.4, 'Tc': 1.5, 'delta_mu': 0.4\n         }, np.array([0.6, 0.8, 1.0, 1.2, 1.4]), 0.02),\n    ]\n\n    results = []\n    for params, temp_grid, tolerance in test_cases:\n        result = find_azeotrope(params, temp_grid, tolerance)\n        results.append(result)\n\n    # Format the final output string.\n    output_str_parts = []\n    for res in results:\n        # Each result is a list [T_az, xB_az] or [-1.0, -1.0]\n        # round to 3 decimal places\n        output_str_parts.append(f\"[{res[0]:.3f},{res[1]:.3f}]\")\n    \n    final_output = f\"[{','.join(output_str_parts)}]\"\n    print(final_output)\n\n\ndef find_azeotrope(params, temp_grid, tolerance):\n    \"\"\"\n    Finds an azeotrope for a given set of parameters and temperature grid.\n\n    Args:\n        params (dict): A dictionary of model parameters.\n        temp_grid (np.array): An array of temperatures to scan.\n        tolerance (float): The tolerance for composition difference.\n\n    Returns:\n        list: A list [T_az, xB_az] if an azeotrope is found, otherwise [-1.0, -1.0].\n    \"\"\"\n    p = params\n    k_B = 1.0\n\n    min_diff = float('inf')\n    azeotrope_data = None\n\n    # Function to solve for x_B\n    def equilibrium_eq(x_B, T, z):\n        # To avoid log(0) or division by zero, x_B is bounded slightly away from 0 and 1\n        if x_B == 0 or x_B >= 1:\n            return float('nan') # Should not happen with brentq's interval\n        \n        term1 = k_B * T * np.log(x_B / (1.0 - x_B))\n        term2 = z * (x_B * p['eps_BB'] - (1.0 - x_B) * p['eps_AA'] + (1.0 - 2.0 * x_B) * p['eps_AB'])\n        return term1 + term2 - p['delta_mu']\n\n    for T in temp_grid:\n        if T >= p['Tc']:\n            sqrt_term = 0.0\n        else:\n            sqrt_term = np.sqrt(1.0 - T / p['Tc'])\n\n        rho_L = p['rho_c'] + p['rho_0'] * sqrt_term\n        rho_V = p['rho_c'] - p['rho_0'] * sqrt_term\n\n        z_L = p['z0'] * rho_L\n        z_V = p['z0'] * rho_V\n\n        # Search interval for x_B, mole fraction\n        x_interval = [1e-9, 1 - 1e-9]\n\n        try:\n            x_B_L = brentq(equilibrium_eq, x_interval[0], x_interval[1], args=(T, z_L))\n            x_B_V = brentq(equilibrium_eq, x_interval[0], x_interval[1], args=(T, z_V))\n        except ValueError:\n            # Root finding might fail if the function does not cross zero.\n            # This indicates an issue with parameters or model assumptions not covered.\n            # For this problem, we assume solutions always exist.\n            continue\n            \n        diff = abs(x_B_L - x_B_V)\n\n        if diff  min_diff:\n            min_diff = diff\n            azeotrope_data = (T, x_B_L, x_B_V)\n\n    if azeotrope_data and min_diff  tolerance:\n        T_az, x_B_L_az, x_B_V_az = azeotrope_data\n        xB_az = 0.5 * (x_B_L_az + x_B_V_az)\n        return [T_az, xB_az]\n    else:\n        return [-1.0, -1.0]\n\nsolve()\n```", "id": "3454556"}, {"introduction": "为了高效地对复杂系统（如受限流体）进行抽样，高级模拟常常需要将不同类型的蒙特卡洛移动组合成混合算法。本练习 [@problem_id:3454523] 旨在挑战您设计并验证一种混合方案，该方案结合了类吉布斯系综的粒子交换和类巨正则系综的粒子插入/删除。核心任务是从细致平衡原理出发推导移动的接受率，以确保所构建的算法在物理上是正确且稳健的。", "problem": "要求您设计并测试一种混合马尔可夫链蒙特卡洛（MC）方案，该方案将 Gibbs 系综蒙特卡洛（GEMC）的粒子交换与限制在多孔盒子中的巨正则系综蒙特卡洛（GCMC）的粒子插入和删除相结合，用于模拟甲烷在纳米孔中的共存简化模型。计算的目标是确保混合移动集相对于预期的稳态分布满足细致平衡条件，并且混合不同类型的移动不会破坏微观可逆性。\n\n考虑两个处于恒定温度下的模拟盒子：一个多孔盒子（盒子 $1$）和一个体相盒子（盒子 $2$）。对于两个盒子，都将甲烷视为无相互作用的点粒子（理想气体）。多孔盒子受到一个空间均匀的外部势场作用，使得盒子$1$中的每个粒子都贡献一个能量惩罚$+\\epsilon$（其中 $\\epsilon \\ge 0$），而体相盒子没有外部势场贡献。使用约化单位，其中 $k_{\\mathrm B}T = 1$，因此 $\\beta = 1$，并让所有能量以相同的约化能量单位表示，所有体积以相同的约化体积单位表示。在这些单位中，所有数值都以纯数字形式书写。设化学势为标量 $\\mu$，也使用这些约化单位。\n\n定义以下混合移动类型：\n- 移动类型 S（类 Gibbs 交换）：在盒子$2$中选择一个粒子，并提议将其移动到盒子$1$中的一个均匀随机位置（其逆向移动类似地将粒子从盒子$1$移动到盒子$2$）。在正向移动（盒子 $2 \\to 1$）中，此移动使粒子数对 $(N_1,N_2)$ 变为 $(+1,-1)$，其中 $N_1$ 和 $N_2$ 是当前的粒子数。\n- 移动类型 G（多孔盒子中的巨正则移动）：提议在盒子$1$中的一个均匀随机位置进行插入（其逆向移动是从盒子$1$的粒子中均匀选择一个进行删除）。在正向移动（插入）中，此移动使 $(N_1,N_2)$ 变为 $(+1,0)$。\n\n假设移动类型的选择与状态无关，类型 S 的选择概率为固定的 $p_{\\mathrm S}$，类型 G 的选择概率为固定的 $p_{\\mathrm G}$，且 $p_{\\mathrm S} + p_{\\mathrm G} = 1$。在每种类型内部，假设在一种移动及其逆向移动之间选择方向的概率固定为 $1/2$（对于类型 S，是盒子 $2 \\to 1$ 与盒子 $1 \\to 2$ 之间；对于类型 G，是插入与删除之间）。在特定方向内，提议概率为：\n- 对于类型 S，盒子 $2 \\to 1$：从 $N_2$ 个粒子中均匀选择一个，并在盒子$1$中均匀选择一个新位置，得到的提议密度正比于 $(1/N_2)\\,(1/V_1)$；其逆向移动使用 $(1/(N_1+1))\\,(1/V_2)$。\n- 对于类型 G，向盒子$1$中插入：在 $V_1$ 中均匀选择一个位置，提议密度为 $(1/V_1)$；其逆向删除使用 $(1/(N_1+1))$。\n\n设粒子数为 $(N_1,N_2)$ 的构型的未归一化稳态权重正比于\n$$\n\\pi(N_1,N_2) \\propto \\exp\\!\\big(-\\beta\\,U_1(N_1) - \\beta\\,U_2(N_2) + \\beta\\,\\mu\\,(N_1 + N_2)\\big),\n$$\n其中 $U_1(N_1) = \\epsilon\\,N_1$ 且 $U_2(N_2) = 0$。粒子的位置已被积分掉，这与理想气体和均匀外场的假设一致；您的接受率公式必须基于第一性原理的细致平衡，并使用所述的提议机制在 Metropolis–Hastings 构造中推导得出。\n\n任务 1. 从细致平衡原理和 Metropolis–Hastings 接受准则出发，推导以下移动的接受概率：\n- 类型 S 的正向交换（盒子 $2 \\to 1$）及其逆向交换（盒子 $1 \\to 2$），确保对于给定的 $\\pi(N_1,N_2)$ 满足细致平衡。\n- 类型 G 的正向插入（到盒子 $1$）及其逆向删除（从盒子 $1$），确保对于给定的 $\\pi(N_1,N_2)$ 满足细致平衡。\n\n您的推导必须从细致平衡的定义和给定的提议密度开始，并且必须得出以 $(N_1,N_2,V_1,V_2,\\beta,\\epsilon,\\mu)$ 表示的显式接受函数。\n\n任务 2. 实现一个程序，该程序能够：\n- 对于给定的参数和指定的正向方向，计算正向和逆向的单步跃迁概率 $K(x \\to y)$ 和 $K(y \\to x)$，其中 $K$ 包括类型选择概率、方向选择概率、该移动的提议概率以及推导出的 Metropolis–Hastings 接受概率。\n- 验证比率 $K(x \\to y)/K(y \\to x)$ 等于由给定的 $\\pi(N_1,N_2)$ 以及移动类型和方向引起的 $(N_1,N_2)$ 变化所蕴含的比率 $\\pi(y)/\\pi(x)$。对于移动类型 S（盒子 $2 \\to 1$），该比率必须为 $\\exp(-\\beta\\,\\epsilon)$；对于移动类型 G（向盒子 $1$ 插入），该比率必须为 $\\exp(\\beta\\,\\mu - \\beta\\,\\epsilon)$。\n- 返回一个布尔值，指示等式两边的绝对差是否小于 $10^{-12}$ 的容差。\n\n测试套件。使用约化单位，$\\beta = 1$。对于以下每种情况，计算上述布尔值。在所有情况下，使用 $p_{\\mathrm S} = 0.7$ 和 $p_{\\mathrm G} = 0.3$。\n- 情况 1（类型 S 正向，盒子 $2 \\to 1$）：$N_1 = 10$, $N_2 = 90$, $V_1 = 5.0$, $V_2 = 95.0$, $\\epsilon = 1.5$。\n- 情况 2（类型 S 正向，盒子 $2 \\to 1$）：$N_1 = 0$, $N_2 = 5$, $V_1 = 12.0$, $V_2 = 8.0$, $\\epsilon = 2.3$。\n- 情况 3（类型 G 正向，向盒子 $1$ 插入）：$N_1 = 10$, $V_1 = 5.0$, $\\epsilon = 1.5$, $\\mu = -2.0$。\n- 情况 4（类型 G 正向，向盒子 $1$ 插入）：$N_1 = 0$, $V_1 = 2.0$, $\\epsilon = 0.2$, $\\mu = 3.0$。\n- 情况 5（类型 G 正向，向盒子 $1$ 插入）：$N_1 = 50$, $V_1 = 100.0$, $\\epsilon = 4.0$, $\\mu = 1.0$。\n\n最终输出格式。您的程序应生成单行输出，其中包含对应于情况 1 到 5 的五个布尔值，以逗号分隔的列表形式并用方括号括起来，例如，“[True,True,True,True,True]”。不允许有其他输出。", "solution": "该问题要求为一种混合的 Gibbs 系综蒙特卡洛（GEMC）和巨正则系综蒙特卡洛（GCMC）方案推导接受概率，并随后进行数值验证，以证明所得到的跃迁概率满足细致平衡原理。该系统包含两个装有无相互作用粒子的盒子，其中盒子$1$中的粒子具有额外的能量惩罚 $\\epsilon$。所有计算均在约化单位下进行，其中 $\\beta = (k_BT)^{-1} = 1$。\n\n本分析的基础是细致平衡条件，该条件指出，对于构型空间中的任意两个状态 $x$ 和 $y$，平衡状态下的跃迁速率必须满足：\n$$\n\\pi(x) K(x \\to y) = \\pi(y) K(y \\to x)\n$$\n此处，$\\pi(x)$ 是状态 $x$ 的平衡概率，而 $K(x \\to y)$ 是从状态 $x$ 到 $y$ 的总跃迁概率。跃迁概率可以分解为提议一个移动的概率 $p_{select}(x \\to y)$ 和接受该移动的概率 $A(x \\to y)$：\n$$\nK(x \\to y) = p_{select}(x \\to y) A(x \\to y)\n$$\nMetropolis-Hastings 算法提供了一种保证细致平衡的接受概率选择：\n$$\nA(x \\to y) = \\min\\left(1, \\frac{\\pi(y) p_{select}(y \\to x)}{\\pi(x) p_{select}(x \\to y)}\\right)\n$$\n问题规定，移动类型（S 或 G）及其方向（例如，正向或逆向）的选择与当前状态无关，并且对于一个移动及其逆向移动是对称的。也就是说，$p_{type}(x \\to y) = p_{type}(y \\to x)$ 且 $p_{dir}(x \\to y) = p_{dir}(y \\to x)$。完整的提议概率 $p_{select}(x \\to y)$ 包括这些概率以及一个与从初始构型生成特定最终构型相关的项 $T_{prob}(x \\to y)$。\n$$\np_{select}(x \\to y) = p_{type} \\cdot p_{dir} \\cdot T_{prob}(x \\to y)\n$$\n由于 $p_{type}$ 和 $p_{dir}$ 的对称性，接受准则简化为：\n$$\nA(x \\to y) = \\min\\left(1, \\frac{\\pi(y) T_{prob}(y \\to x)}{\\pi(x) T_{prob}(x \\to y)}\\right)\n$$\n问题给出了宏观状态 $(N_1, N_2)$ 的未归一化稳态权重：\n$$\n\\pi(N_1, N_2) \\propto \\exp(-\\beta \\epsilon N_1 + \\beta \\mu (N_1 + N_2))\n$$\n我们使用此表达式以及给定的提议项 $T_{prob}$ 来推导接受规则。\n\n**任务 1：接受概率的推导**\n\n**移动类型 S（类 Gibbs 交换）**\n此移动在盒子 $1$ 和盒子 $2$ 之间转移一个粒子。\n- 正向移动（$2 \\to 1$）：状态从 $x = (N_1, N_2)$ 变为 $y = (N_1+1, N_2-1)$。\n- 逆向移动（$1 \\to 2$）：状态从 $y = (N_1+1, N_2-1)$ 变为 $x = (N_1, N_2)$。\n提议项由 $T_{prob}(x \\to y) \\propto \\frac{1}{N_2 V_1}$ 和 $T_{prob}(y \\to x) \\propto \\frac{1}{(N_1+1) V_2}$ 给出。稳态权重的比率为：\n$$\n\\frac{\\pi(y)}{\\pi(x)} = \\frac{\\pi(N_1+1, N_2-1)}{\\pi(N_1, N_2)} = \\frac{\\exp(-\\beta\\epsilon(N_1+1) + \\beta\\mu(N_1+1+N_2-1))}{\\exp(-\\beta\\epsilon N_1 + \\beta\\mu(N_1+N_2))} = \\exp(-\\beta\\epsilon)\n$$\n接受函数的参数 $R_S$ 为：\n$$\nR_S = \\frac{\\pi(y)}{\\pi(x)} \\frac{T_{prob}(y \\to x)}{T_{prob}(x \\to y)} = \\exp(-\\beta\\epsilon) \\frac{1/((N_1+1)V_2)}{1/(N_2 V_1)} = \\frac{N_2 V_1}{(N_1+1)V_2} \\exp(-\\beta\\epsilon)\n$$\n正向交换（$2 \\to 1$）的接受概率为：\n$$\nA_{S, 2 \\to 1} = \\min(1, R_S) = \\min\\left(1, \\frac{N_2 V_1}{(N_1+1)V_2} \\exp(-\\beta\\epsilon)\\right)\n$$\n逆向交换（$1 \\to 2$）的接受概率为：\n$$\nA_{S, 1 \\to 2} = \\min(1, 1/R_S) = \\min\\left(1, \\frac{(N_1+1)V_2}{N_2 V_1} \\exp(\\beta\\epsilon)\\right)\n$$\n\n**移动类型 G（多孔盒子中的巨正则移动）**\n此移动在盒子 $1$ 中插入或删除一个粒子。\n- 正向移动（插入）：状态从 $x = (N_1, N_2)$ 变为 $y = (N_1+1, N_2)$。\n- 逆向移动（删除）：状态从 $y = (N_1+1, N_2)$ 变为 $x = (N_1, N_2)$。\n提议项由 $T_{prob}(x \\to y) \\propto \\frac{1}{V_1}$ 和 $T_{prob}(y \\to x) \\propto \\frac{1}{N_1+1}$ 给出。稳态权重的比率为：\n$$\n\\frac{\\pi(y)}{\\pi(x)} = \\frac{\\pi(N_1+1, N_2)}{\\pi(N_1, N_2)} = \\frac{\\exp(-\\beta\\epsilon(N_1+1) + \\beta\\mu(N_1+1+N_2))}{\\exp(-\\beta\\epsilon N_1 + \\beta\\mu(N_1+N_2))} = \\exp(\\beta\\mu - \\beta\\epsilon)\n$$\n接受函数的参数 $R_G$ 为：\n$$\nR_G = \\frac{\\pi(y)}{\\pi(x)} \\frac{T_{prob}(y \\to x)}{T_{prob}(x \\to y)} = \\exp(\\beta\\mu - \\beta\\epsilon) \\frac{1/(N_1+1)}{1/V_1} = \\frac{V_1}{N_1+1} \\exp(\\beta\\mu - \\beta\\epsilon)\n$$\n正向插入的接受概率为：\n$$\nA_{G, \\text{ins}} = \\min(1, R_G) = \\min\\left(1, \\frac{V_1}{N_1+1} \\exp(\\beta\\mu - \\beta\\epsilon)\\right)\n$$\n逆向删除的接受概率为：\n$$\nA_{G, \\text{del}} = \\min(1, 1/R_G) = \\min\\left(1, \\frac{N_1+1}{V_1} \\exp(-\\beta\\mu + \\beta\\epsilon)\\right)\n$$\n\n**任务 2：数值验证**\n任务是验证总跃迁概率的比率 $\\frac{K(x \\to y)}{K(y \\to x)}$ 等于稳态概率的比率 $\\frac{\\pi(y)}{\\pi(x)}$。根据构造，这个等式必须成立。恒等式 $\\frac{A(x \\to y)}{A(y \\to x)} = \\frac{\\pi(y) T_{prob}(y \\to x)}{\\pi(x) T_{prob}(x \\to y)}$ 保证了这一点：\n$$\n\\frac{K(x \\to y)}{K(y \\to x)} = \\frac{p_{type} p_{dir} T_{prob}(x \\to y) A(x \\to y)}{p_{type} p_{dir} T_{prob}(y \\to x) A(y \\to x)} = \\frac{T_{prob}(x \\to y)}{T_{prob}(y \\to x)} \\frac{\\pi(y) T_{prob}(y \\to x)}{\\pi(x) T_{prob}(x \\to y)} = \\frac{\\pi(y)}{\\pi(x)}\n$$\n程序将对每个测试用例，使用推导出的接受概率公式，数值计算该等式的两边，并在指定的容差范围内验证它们的一致性。对于从初始状态 $x$ 到最终状态 $y$ 的正向移动，等式左边是 $K(x \\to y)$ 与 $K(y \\to x)$ 的比率，右边是解析已知的目标比率，对于类型 S 为 $\\exp(-\\beta\\epsilon)$，对于类型 G 为 $\\exp(\\beta\\mu - \\beta\\epsilon)$。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes and verifies detailed balance for a hybrid MC scheme.\n    \n    The function tests two types of Monte Carlo moves (S: swap, G: grand canonical)\n    for a simplified model of gas coexistence in nanopores. For each test case,\n    it calculates the forward and reverse transition probabilities K(x-y) and K(y-x).\n    It then verifies that their ratio K(x-y)/K(y-x) equals the ratio of the\n    stationary probabilities pi(y)/pi(x), as required by detailed balance.\n    \"\"\"\n    \n    # Parameters given in the problem\n    p_S = 0.7\n    p_G = 0.3\n    beta = 1.0\n    tolerance = 1e-12\n\n    # Test suite from the problem statement.\n    # Each case: (type, N1_initial, N2_initial, V1, V2, epsilon, mu)\n    # V2 or mu might be None if not used by the move type.\n    test_cases = [\n        ('S', 10, 90, 5.0, 95.0, 1.5, None),\n        ('S', 0, 5, 12.0, 8.0, 2.3, None),\n        ('G', 10, None, 5.0, None, 1.5, -2.0),\n        ('G', 0, None, 2.0, None, 0.2, 3.0),\n        ('G', 50, None, 100.0, None, 4.0, 1.0),\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        move_type, N1, N2, V1, V2, epsilon, mu = case\n        \n        computed_ratio = 0.0\n        target_ratio = 0.0\n\n        if move_type == 'S':\n            # Type S forward move: box 2 - 1\n            # Initial state x: (N1, N2), Final state y: (N1+1, N2-1)\n            \n            # The problem's test cases ensure N2  0 for this move.\n            \n            # Target ratio from stationary distribution: pi(y)/pi(x) = exp(-beta*epsilon)\n            target_ratio = np.exp(-beta * epsilon)\n\n            # Proposal factors T_prob from the problem statement\n            T_forward = 1.0 / (N2 * V1)\n            T_reverse = 1.0 / ((N1 + 1) * V2)\n\n            # Argument R for the Metropolis-Hastings acceptance rule\n            # R = (pi(y)/pi(x)) * (T_reverse / T_forward)\n            R = target_ratio * (T_reverse / T_forward) if T_forward != 0 else float('inf')\n\n            # Acceptance probabilities A(x-y) and A(y-x)\n            A_forward = min(1.0, R)\n            A_reverse = min(1.0, 1.0 / R) if R != 0 else 1.0\n\n            # Total transition probabilities K = p_type * p_direction * T_prob * A\n            # p_direction is 1/2 for both forward and reverse moves.\n            K_forward = p_S * 0.5 * T_forward * A_forward\n            K_reverse = p_S * 0.5 * T_reverse * A_reverse\n            \n            # Ratio of transition probabilities K(x-y)/K(y-x)\n            if K_reverse == 0:\n                # This should not happen with the given test cases.\n                computed_ratio = float('inf') if K_forward != 0 else 1.0\n            else:\n                computed_ratio = K_forward / K_reverse\n\n        elif move_type == 'G':\n            # Type G forward move: insertion into box 1\n            # Initial state x: (N1, N_any), Final state y: (N1+1, N_any)\n\n            # Target ratio from analytical derivation: pi(y)/pi(x) = exp(beta*mu - beta*epsilon)\n            target_ratio = np.exp(beta * mu - beta * epsilon)\n\n            # Proposal factors T_prob\n            T_forward = 1.0 / V1          # Insertion\n            T_reverse = 1.0 / (N1 + 1)    # Deletion\n            \n            # Argument R for the Metropolis-Hastings acceptance rule\n            R = target_ratio * (T_reverse / T_forward) if T_forward != 0 else float('inf')\n            \n            # Acceptance probabilities\n            A_forward = min(1.0, R)\n            A_reverse = min(1.0, 1.0 / R) if R != 0 else 1.0\n            \n            # Total transition probabilities K\n            K_forward = p_G * 0.5 * T_forward * A_forward\n            K_reverse = p_G * 0.5 * T_reverse * A_reverse\n            \n            # Ratio K(x-y)/K(y-x)\n            if K_reverse == 0:\n                computed_ratio = float('inf') if K_forward != 0 else 1.0\n            else:\n                computed_ratio = K_forward / K_reverse\n        \n        # Verify if computed ratio matches the target ratio within tolerance\n        is_balanced = np.abs(computed_ratio - target_ratio)  tolerance\n        results.append(is_balanced)\n        \n    # Format and print the final output as specified.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3454523"}]}