## 引言
[刚体动力学](@entry_id:142040)是计算科学，特别是分子模拟领域，不可或缺的一个分支。当系统中的分子或其特定部分（如溶剂分子或[蛋白质结构域](@entry_id:165258)）的内部[振动](@entry_id:267781)可以被忽略时，将其作为一个整体的刚体来处理，能够极大地提高模拟效率。然而，精确描述三维空间中的旋转运动面临着独特的数学挑战。传统的[欧拉角](@entry_id:171794)表示法虽然直观，但其固有的“[万向节死锁](@entry_id:171734)”问题会在特定姿态下导致数值不稳定甚至模拟失败。本文旨在解决这一知识鸿沟，全面介绍一种更为稳健和优雅的解决方案——[四元数表示](@entry_id:146458)法。通过本文的学习，读者将系统地掌握使用[四元数](@entry_id:147023)进行[刚体动力学](@entry_id:142040)模拟的核心知识。第一章“原理与机制”将奠定数学和物理基础，深入讲解[四元数代数](@entry_id:196348)、[运动方程](@entry_id:170720)以及保持物理约束的先进[数值积分方法](@entry_id:141406)。第二章“应用与跨学科联系”将展示这一理论框架的强大应用价值，探讨其在生物物理、[材料科学](@entry_id:152226)和非平衡系统中的具体应用。最后，在“动手实践”部分，读者将通过解决实际的编程问题，巩固所学知识，将理论付诸实践。

## 原理与机制

[刚体动力学](@entry_id:142040)是分子模拟中的一个核心组成部分，它使我们能够高效地处理分子内部自由度被冻结或不重要的系统，例如溶剂分子（如水）、蛋白质的特定结构域或晶体材料。与将分子视为受约束的点质量集合（例如使用 SHAKE 和 RATTLE 算法）相比，采用刚体描述（即用[质心](@entry_id:265015)位置和方向来描述）提供了另一种等效且在概念和计算上都具有优势的框架 [@problem_id:3442416]。在这种方法中，[四元数](@entry_id:147023)作为描述方向的关键工具脱颖而出，它提供了一种稳健且无[奇异点](@entry_id:199525)的表示方法。本章将深入探讨使用[四元数表示](@entry_id:146458)进行[刚体动力学](@entry_id:142040)的基本原理和核心机制，从基本代数和[运动学方程](@entry_id:173032)到先进的[数值积分](@entry_id:136578)和恒温技术。

### 表征方向：[四元数](@entry_id:147023)框架

在三维空间中描述物体的方向似乎是一个简单的问题，但选择合适的数学表示是高效和准确模拟的关键。虽然[欧拉角](@entry_id:171794)因其直观性而被广泛使用，但它们存在固有的数学问题，而[四元数](@entry_id:147023)则提供了一个优雅的解决方案。

#### 为何选择[四元数](@entry_id:147023)？超越[欧拉角](@entry_id:171794)

传统上，方向可以通过三个[欧拉角](@entry_id:171794)（例如 $\psi, \theta, \phi$）来参数化。然而，这种表示方法存在一个被称为**[万向节死锁](@entry_id:171734)**（gimbal lock）的严重缺陷。在特定的方向上，三个[旋转轴](@entry_id:187094)中的两个会发生重合，导致一个自由度的丢失。在这些[奇异点](@entry_id:199525)上，角速度与[欧拉角](@entry_id:171794)速率之间的关系变得奇异，使得[运动方程](@entry_id:170720)无法求解或在数值上极不稳定。

为了克服这一限制，我们转向**四元数**。一个[单位四元数](@entry_id:204470) $\mathbf{q} = (q_0, q_1, q_2, q_3)$ 是一个四维向量，其范数为 1，即 $q_0^2 + q_1^2 + q_2^2 + q_3^2 = 1$。这些向量构成了[三维球面](@entry_id:261323)（3-sphere, $S^3$）。与需要三个参数的[欧拉角](@entry_id:171794)不同，[四元数](@entry_id:147023)使用四个参数来描述一个三自由度的旋转，这种冗余性巧妙地避免了[奇异点](@entry_id:199525)。一个重要的特性是，四元数对[旋转群](@entry_id:204412) $\mathrm{SO}(3)$ 进行了**双重覆盖**：[四元数](@entry_id:147023) $\mathbf{q}$ 和它的负值 $-\mathbf{q}$ 代表完全相同的物理旋转 [@problem_id:3442455]。这种特性在处理周期性或从[旋转矩阵](@entry_id:140302)恢复[四元数](@entry_id:147023)时需要特别注意。

#### [四元数代数](@entry_id:196348)与旋转

一个[四元数](@entry_id:147023) $\mathbf{q}$ 可以被视为一个标量部分 $q_0$ 和一个矢量部分 $\mathbf{q}_v = (q_1, q_2, q_3)$ 的组合，即 $\mathbf{q} = (q_0, \mathbf{q}_v)$。四元数之间的[乘法规则](@entry_id:197368)（哈密顿积）是其在旋转应用中的核心。对于两个[四元数](@entry_id:147023) $\mathbf{a} = (a_0, \mathbf{a}_v)$ 和 $\mathbf{b} = (b_0, \mathbf{b}_v)$，它们的乘积为：
$$
\mathbf{a} \otimes \mathbf{b} = (a_0 b_0 - \mathbf{a}_v \cdot \mathbf{b}_v, a_0 \mathbf{b}_v + b_0 \mathbf{a}_v + \mathbf{a}_v \times \mathbf{b}_v)
$$
此乘法是不可交换的，即 $\mathbf{a} \otimes \mathbf{b} \neq \mathbf{b} \otimes \mathbf{a}$，这正反映了[三维旋转](@entry_id:148533)的不[可交换性](@entry_id:263314)。

[四元数](@entry_id:147023) $\mathbf{q}$ 的**共轭**定义为 $\mathbf{q}^* = (q_0, -\mathbf{q}_v)$。

使用[单位四元数](@entry_id:204470) $\mathbf{q}$ 旋转一个空间向量 $\mathbf{x}$ 的操作是通过**“[三明治积](@entry_id:201270)”**实现的。首先，我们将向量 $\mathbf{x}$ 嵌入到一个“纯”[四元数](@entry_id:147023)中，即标量部分为零的四元数 $\mathbf{p} = (0, \mathbf{x})$。旋转后的向量 $\mathbf{x}'$ 位于新的纯四元数 $\mathbf{p}'$ 的矢量部分，其计算公式为 [@problem_id:3442418]：
$$
\mathbf{p}' = \mathbf{q} \otimes \mathbf{p} \otimes \mathbf{q}^*
$$
可以证明，如果 $\mathbf{q}$ 是[单位四元数](@entry_id:204470)，则 $\mathbf{p}'$ 的标量部分确实为零，其矢量部分 $\mathbf{x}'$ 的长度与 $\mathbf{x}$ 相同，这证实了该操作确实是一个纯旋转。

#### 表征之间的转换

尽管[四元数](@entry_id:147023)在动力学计算中占优，但在输入、输出或与其他软件交互时，我们经常需要在四元数和更直观的旋转矩阵之间进行转换。

**从四元数到旋转矩阵**

我们可以通过展开[三明治积](@entry_id:201270) $\mathbf{p}' = \mathbf{q} \otimes \mathbf{p} \otimes \mathbf{q}^*$ 来推导与[单位四元数](@entry_id:204470) $\mathbf{q} = (q_0, \mathbf{q}_v)$ 相关联的[旋转矩阵](@entry_id:140302) $R(\mathbf{q})$。旋转后的向量 $\mathbf{x}'$ 是对 $\mathbf{x}$ 的线性变换，即 $\mathbf{x}'=R(\mathbf{q})\mathbf{x}$。经过代数运算，我们可以得到 $\mathbf{x}'$ 的表达式为 [@problem_id:3442418]：
$$
\mathbf{x}' = (q_0^2 - \|\mathbf{q}_v\|^2) \mathbf{x} + 2(\mathbf{q}_v \cdot \mathbf{x})\mathbf{q}_v + 2q_0 (\mathbf{q}_v \times \mathbf{x})
$$
由于 $\mathbf{q}$ 是[单位四元数](@entry_id:204470)，$\|\mathbf{q}_v\|^2 = 1 - q_0^2$，上式可写为 $\mathbf{x}' = (2q_0^2 - 1) \mathbf{x} + 2(\mathbf{q}_v \cdot \mathbf{x})\mathbf{q}_v + 2q_0 (\mathbf{q}_v \times \mathbf{x})$。通过将这个表达式的各项写成矩阵形式，我们可以得到[旋转矩阵](@entry_id:140302) $R(\mathbf{q})$ 的元素：
$$
R(\mathbf{q}) = \begin{pmatrix}
q_0^2+q_1^2-q_2^2-q_3^2 & 2(q_1q_2-q_0q_3) & 2(q_1q_3+q_0q_2) \\
2(q_1q_2+q_0q_3) & q_0^2-q_1^2+q_2^2-q_3^2 & 2(q_2q_3-q_0q_1) \\
2(q_1q_3-q_0q_2) & 2(q_2q_3+q_0q_1) & q_0^2-q_1^2-q_2^2+q_3^2
\end{pmatrix}
$$

**从旋转矩阵到[四元数](@entry_id:147023)**

反向转换，即从一个给定的[旋转矩阵](@entry_id:140302) $R \in \mathrm{SO}(3)$ 中恢复四元数，需要更加小心，以确保[数值稳定性](@entry_id:146550)。通过考察 $R(\mathbf{q})$ 的对角线元素，我们可以建立四元数分量与[矩阵元](@entry_id:186505)素之间的关系。[矩阵的迹](@entry_id:139694)（trace）提供了一个直接的途径来计算 $q_0$：
$$
\mathrm{tr}(R) = R_{11} + R_{22} + R_{33} = (q_0^2+q_1^2-q_2^2-q_3^2) + (q_0^2-q_1^2+q_2^2-q_3^2) + (q_0^2-q_1^2-q_2^2+q_3^2) = 3q_0^2 - (q_1^2+q_2^2+q_3^2)
$$
利用 $q_1^2+q_2^2+q_3^2 = 1 - q_0^2$，我们得到 $\mathrm{tr}(R) = 4q_0^2 - 1$，因此 $4q_0^2 = 1 + \mathrm{tr}(R)$。类似地，我们可以得到：
$$
4q_1^2 = 1 + R_{11} - R_{22} - R_{33} \\
4q_2^2 = 1 - R_{11} + R_{22} - R_{33} \\
4q_3^2 = 1 - R_{11} - R_{22} + R_{33}
$$
一个数值稳健的算法会避免除以一个接近于零的数。当旋转角度接近 $180^\circ$ 时，$q_0 \approx 0$，此时直接使用迹来计算 $q_0$ 并用它作为除数来求解其他分量将导致巨大的[数值误差](@entry_id:635587)。一个健壮的策略是 [@problem_id:3442418]：
1.  计算上述四个表达式的右侧值，并找出其中最大的一个。
2.  如果 $1+\mathrm{tr}(R)$ 是最大的，这意味着 $|q_0|$ 是最大的分量。我们计算 $q_0 = \frac{1}{2}\sqrt{1+\mathrm{tr}(R)}$，然后利用 $R$ 的非对角元素（例如 $R_{32} - R_{23} = 4q_0q_1$）来求解其他分量。
3.  如果 $1+R_{11}-R_{22}-R_{33}$ 是最大的，则 $|q_1|$ 是最大的分量。我们计算 $q_1$，并用它作为除数来求解其他分量。
4.  依此类推，对 $q_2$ 和 $q_3$ 进行相同的处理。
这种**分支算法**确保了计算的稳定性，是任何实用软件实现中的标准做法。

#### 数值漂移的挑战

在动力学模拟中，由于[有限精度算术](@entry_id:142321)和离散时间积分，即使初始时是单位范数，[四元数](@entry_id:147023)也会逐渐**偏离单位球面**，即 $\|\mathbf{q}\| \neq 1$。这种累积误差，可以建模为一个[随机游走过程](@entry_id:171699)，其中每一步都会增加一个小的随机扰动 [@problem_id:3442423]。
这种范数漂移会带来严重的后果。当一个非单位范数的[四元数](@entry_id:147023)被代入标准公式时，生成的旋转矩阵 $R(\mathbf{q})$ 将不再是正交的，即 $R^T R \neq I$。这种**正交性缺陷**意味着该变换不再是纯旋转，它可能会引入不符合物理规律的缩放或剪切。
我们可以通过计算**正交性缺陷** $D_{\mathrm{ortho}} = \|R(\mathbf{q})^T R(\mathbf{q}) - I\|_F$ 来量化这种误差，其中 $\|\cdot\|_F$ 是[弗罗贝尼乌斯范数](@entry_id:143384) [@problem_id:3442423]。为了纠正一个因噪声而变得非正交的矩阵 $\widetilde{R}$，一种标准的做法是找到在[弗罗贝尼乌斯范数](@entry_id:143384)意义下与之最接近的**特殊正交矩阵** $R^\star \in \mathrm{SO}(3)$。这个问题可以通过**奇异值分解（SVD）**来解决。如果 $\widetilde{R} = U \Sigma V^T$，其中 $U, V$ 是[正交矩阵](@entry_id:169220)，$\Sigma$ 是[奇异值](@entry_id:152907)[对角矩阵](@entry_id:637782)，则最近的[正交矩阵](@entry_id:169220)是 $UV^T$。为确保它是一个[真旋转](@entry_id:141831)（即[行列式](@entry_id:142978)为 +1），我们构造 $R^\star = U \mathrm{diag}(1, 1, \det(UV^T)) V^T$ [@problem_id:3442418]。
尽管可以进行后处理校正，但更可取的方法是使用从一开始就保持[四元数范数](@entry_id:151872)的[数值积分](@entry_id:136578)方案，这将在后面的部分讨论。

### [刚体运动](@entry_id:193355)方程

描述刚体运动需要两组方程：一组描述其动力学（[角速度](@entry_id:192539)如何响应力矩），另一组描述其运动学（方向如何随[角速度](@entry_id:192539)变化）。

#### 体[坐标系](@entry_id:156346)中的牛顿-欧拉方程

将刚体的运动分解为质心的[平移运动](@entry_id:187700)和围绕[质心](@entry_id:265015)的转动运动是很方便的。[平移运动](@entry_id:187700)由[牛顿第二定律](@entry_id:274217)描述：$M\ddot{\mathbf{R}} = \mathbf{F}_{\mathrm{ext}}$，其中 $M$ 是总质量，$\mathbf{R}$ 是质心位置，$\mathbf{F}_{\mathrm{ext}}$ 是合外力。
转动运动在与刚体固连的**体[坐标系](@entry_id:156346)**中描述最为简洁。在这个[坐标系](@entry_id:156346)中，[惯性张量](@entry_id:148659) $\mathbf{I}$ 是一个常数矩阵。[转动动力学](@entry_id:267911)由**[欧拉方程](@entry_id:177914)**描述 [@problem_id:3442460] [@problem_id:3442462]：
$$
\dot{\mathbf{L}} + \boldsymbol{\omega} \times \mathbf{L} = \boldsymbol{\tau}_b
$$
这里，$\mathbf{L}$ 是在体[坐标系](@entry_id:156346)中表示的角动量，$\boldsymbol{\omega}$ 是体[坐标系](@entry_id:156346)中的[角速度](@entry_id:192539)，$\boldsymbol{\tau}_b$ 是体[坐标系](@entry_id:156346)中的合外力矩。角动量和[角速度](@entry_id:192539)通过[惯性张量](@entry_id:148659)相关联：$\mathbf{L} = \mathbf{I}\boldsymbol{\omega}$。$\boldsymbol{\omega} \times \mathbf{L}$ 这一项是**陀螺项**，源于体[坐标系](@entry_id:156346)本身是一个[非惯性系](@entry_id:168746)。

#### [四元数](@entry_id:147023)[运动学](@entry_id:173318)：连接动力学与方向

[欧拉方程](@entry_id:177914)描述了 $\boldsymbol{\omega}$ 的演化，但我们需要一个方程来描述方向（由 $\mathbf{q}$ 表示）如何随时间变化。这个联系由**[四元数运动学方程](@entry_id:178485)**提供。对于在体[坐标系](@entry_id:156346)中表示的角速度 $\boldsymbol{\omega}$，该方程为：
$$
\dot{\mathbf{q}} = \frac{1}{2} \mathbf{q} \otimes \boldsymbol{\omega}_q
$$
其中 $\boldsymbol{\omega}_q = (0, \boldsymbol{\omega})$ 是与角速度向量对应的纯四元数 [@problem_id:3442460]。如果角速度在固定的空间（实验室）[坐标系](@entry_id:156346)中表示为 $\boldsymbol{\omega}_s$，则[运动学方程](@entry_id:173032)变为 $\dot{\mathbf{q}} = \frac{1}{2} \boldsymbol{\omega}_{s,q} \otimes \mathbf{q}$ [@problem_id:3442475]。刚体模拟的完整任务就是同时求[解耦](@entry_id:637294)合的欧拉方程和[四元数运动学方程](@entry_id:178485)。

#### 从原子作用力计算力矩

在[分子模拟](@entry_id:182701)中，力矩并非抽象给定，而是源于作用在分子各个原子上的力。假设我们有一系列原子，其在体[坐标系](@entry_id:156346)中的位置为 $\mathbf{r}_i^B$，并且受到在实验室坐标系中计算出的力 $\mathbf{f}_i^W$。为了在体[坐标系](@entry_id:156346)中计算合外力矩，我们必须首先将这些力转换到体[坐标系](@entry_id:156346)中。这种[坐标系转换](@entry_id:263003)通过当前方向的[旋转矩阵](@entry_id:140302)的逆（即[转置](@entry_id:142115)）来完成：
$$
\mathbf{f}_i^B = R(\mathbf{q})^T \mathbf{f}_i^W
$$
然后，体[坐标系](@entry_id:156346)中的总力矩是每个力产生的力矩的矢量和 [@problem_id:3442468]：
$$
\boldsymbol{\tau}_b = \sum_{i} \mathbf{r}_i^B \times \mathbf{f}_i^B
$$
这个过程是所有[刚体分子动力学](@entry_id:754367)模拟的核心，它将原子级的相互作用（力）与刚体的宏观运动（力矩）联系起来。原则上，只要合外力 $\mathbf{F}$ 和合外力矩 $\boldsymbol{\tau}$ 相同，原子力的具体[分布](@entry_id:182848)对刚体的瞬时运动没有影响 [@problem_id:3442416]。

#### 一个解析示例：[主轴](@entry_id:172691)上的恒定力矩

为了更好地理解这些方程是如何协同工作的，我们考虑一个可解析求解的特殊情况：一个对称顶（$I_1=I_2$）刚体，其初始[角速度](@entry_id:192539)和所受的恒定力矩都沿着其对称主轴（例如 $z$ 轴）[@problem_id:3442460]。
在这种情况下，欧拉方程大大简化。由于 $\boldsymbol{\omega} = (0, 0, \omega_3)$ 且 $\boldsymbol{\tau}_b = (0, 0, \tau_3)$，陀螺项 $\boldsymbol{\omega} \times \mathbf{L}$ 为零。[欧拉方程](@entry_id:177914)的前两个分量变为 $\dot{\omega}_1=0$ 和 $\dot{\omega}_2=0$，因此 $\omega_1$ 和 $\omega_2$ 保持为零。第三个分量给出 $I_3 \dot{\omega}_3 = \tau_3$，这是一个简单的常加速度运动，可以直接积分得到 $\omega_3(t) = \omega_3(0) + (\tau_3/I_3)t$。
然后，我们将这个时间依赖的[角速度](@entry_id:192539)代入[四元数运动学方程](@entry_id:178485)。由于 $\omega_1=\omega_2=0$，该[方程组](@entry_id:193238)也简化为关于 $q_0$ 和 $q_3$ 的两​​个耦合方程，而 $q_1$ 和 $q_2$ 保持为零。这个简化的系统可以被精确地积分，得到一个描述绕 $z$ 轴[匀加速](@entry_id:268628)转动的四元数 $q(t)$。这个解析解不仅具有教学价值，也为验证更复杂的[数值积分器](@entry_id:752799)的正确性提供了一个宝贵的基准。

### 先进主题：[哈密顿表述](@entry_id:276227)与相空间

为了更深入地理解[刚体动力学](@entry_id:142040)，特别是为了发展先进的[积分算法](@entry_id:192581)和恒温技术，转向哈密顿力学框架是必要的。

#### [从拉格朗日到哈密顿](@entry_id:164887)动力学

刚体的[转动动能](@entry_id:177668)为 $K_{\mathrm{rot}} = \frac{1}{2}\boldsymbol{\omega}^T \mathbf{I} \boldsymbol{\omega}$。在哈密顿框架中，我们使用[广义动量](@entry_id:165699)而不是[广义速度](@entry_id:178456)。对于[四元数](@entry_id:147023)坐标 $q$，其[共轭动量](@entry_id:172203) $\boldsymbol{\pi}$ 通过[勒让德变换](@entry_id:146727)定义为 $\boldsymbol{\pi} = \frac{\partial K_{\mathrm{rot}}}{\partial \dot{q}}$。
为了计算这个导数，我们需要使用[链式法则](@entry_id:190743)，并利用 $\dot{q}$ 和 $\boldsymbol{\omega}$ 之间的关系。如前所述，$\dot{q} = \frac{1}{2} \mathbf{q} \otimes \boldsymbol{\omega}_q$。这个[线性关系](@entry_id:267880)可以写成矩阵形式 $\dot{q} = \frac{1}{2} G(q) \boldsymbol{\omega}$，其中 $G(q)$ 是一个 $4 \times 3$ 的**[生成矩阵](@entry_id:275809)**，其元素是 $q$ 的分量的线性组合。利用这个关系，我们可以推导出[四元数](@entry_id:147023)动量 $\boldsymbol{\pi}$ 和物理上有意义的体[坐标系](@entry_id:156346)角动量 $\mathbf{L}$ 之间的联系 [@problem_id:3442475]：
$$
\boldsymbol{\pi} = 2 G(q)^T \mathbf{L}
$$
(注意：具体的矩阵形式取决于[运动学方程](@entry_id:173032)的约定)。这个关系至关重要，它表明在冗余的四维[四元数](@entry_id:147023)空间中的动量如何与物理的三维角动量联系起来。此外，从 $G(q)$ 的性质可以推导出，物理上有效的[四元数](@entry_id:147023)动量必须满足约束条件 $\mathbf{q} \cdot \boldsymbol{\pi} = 0$，即 $\boldsymbol{\pi}$ 必须位于[单位球](@entry_id:142558)面 $S^3$ 在点 $\mathbf{q}$ 处的[切空间](@entry_id:199137)内。

#### 相空间测度的重要性

在[统计力](@entry_id:194984)学中，进行正确的系综平均（例如通过[蒙特卡洛方法](@entry_id:136978)）要求我们在相空间上使用正确的[体积元](@entry_id:267802)（或**测度**）。对于旋转自由度，这意味着我们需要在旋转群 $\mathrm{SO}(3)$ 的空间上进行积分。
如果使用[欧拉角](@entry_id:171794) $(\psi, \theta, \phi)$ 进行[参数化](@entry_id:272587)，一个常见的错误是使用均匀的勒贝格测度 $d\psi d\theta d\phi$。这是不正确的，因为它没有考虑[坐标系](@entry_id:156346)的几何畸变。正确的、在 $\mathrm{SO}(3)$ 上不变的测度（[哈尔测度](@entry_id:142417)）在[欧拉角](@entry_id:171794)坐标下的体积元正比于 $\sin\theta d\psi d\theta d\phi$ [@problem_id:3442455]。使用平坦测度会导致在极点（$\theta \to 0$ 或 $\theta \to \pi$）附近对方向的采样不足。
对于均匀随机方向的采样（对应于零[势能](@entry_id:748988)的情况），正确的归一化[概率密度函数](@entry_id:140610)为 $f(\psi, \theta, \phi) = \frac{\sin\theta}{8\pi^2}$。
[四元数表示](@entry_id:146458)法再次显示出其优势：在四维空间中单位球面 $S^3$ 上的均匀测度自然地对应于 $\mathrm{SO}(3)$ 上的[哈尔测度](@entry_id:142417)。这使得使用四元数进行[蒙特卡洛采样](@entry_id:752171)或理论推导时，测度问题变得更加简单。

### 数值积分：保持结构

理论方程是一回事，在计算机上求解它们是另一回事。离散化过程会引入误差，除非我们使用特殊设计的算法，否则这些误差会破坏系统的基本物理和几何结构。

#### 为何需要[几何积分](@entry_id:261978)器

正如前面所讨论的，像[前向欧拉法](@entry_id:141238)这样的简单[积分器](@entry_id:261578)无法保持[四元数](@entry_id:147023)的单位范数，也无法精确守恒能量或动量等物理[不变量](@entry_id:148850) [@problem_id:3442423]。为了解决这个问题，主要有两种方法：
1.  **约束求解器**：在一个非约束的积分步骤之后，强制施加约束。一个简单的方法是引入一个拉格朗日乘子项 $\lambda(t) \mathbf{q}$ 到运动方程中，其大小恰好能抵消掉任何导致范数变化的运动 [@problem_id:3442447]。更复杂的算法，如 SHAKE 和 RATTLE，通过迭代求解[约束力](@entry_id:170052)来满足键长等几何约束。
2.  **[几何积分](@entry_id:261978)**：设计从根本上就尊重系统几何结构的[积分算法](@entry_id:192581)。这类算法通过将更新步骤构造为[流形](@entry_id:153038)上的离散映射来实现这一点，例如，在[李群](@entry_id:137659)上的一个移动。对于[刚体动力学](@entry_id:142040)，这是现代且更稳健的方法。

#### 一个二阶[李群积分器](@entry_id:751268)

一个优秀的刚[体积分](@entry_id:171119)器应该能精确地保持方向[流形](@entry_id:153038)（通过四元数单位范数）并且对于[无力矩运动](@entry_id:167374)能长时间保持[能量守恒](@entry_id:140514)。我们可以构建一个这样的二阶、时间可逆的**[李群积分器](@entry_id:751268)** [@problem_id:3442462]：
该方法的核心思想是使用**隐式中点格式**，它在时间步的中心点评估系统的状态。

1.  **动量更新**：我们将[欧拉方程](@entry_id:177914) $\dot{\mathbf{L}} = \boldsymbol{\tau}_b - \boldsymbol{\omega} \times \mathbf{L}$ 在时间步 $[t_n, t_{n+1}]$ 的中点 $t_{n+1/2}$ 进行离散化。这会得到一个关于中点动量 $\mathbf{L}^{n+1/2}$ 的隐式[非线性方程](@entry_id:145852)。这个方程可以通过简单的**[不动点迭代](@entry_id:749443)**来求解，对于足够小的时间步长，该迭代会快速收敛。一旦得到 $\mathbf{L}^{n+1/2}$，就可以通过 $\mathbf{L}^{n+1} = 2\mathbf{L}^{n+1/2} - \mathbf{L}^n$ 计算出最终的动量。该方案在没有外力矩时能精确保持角动量的大小 $\|\mathbf{L}\|$，这是其优异长期稳定性的根源。

2.  **方向更新**：我们使用计算出的中点[角速度](@entry_id:192539) $\boldsymbol{\omega}^{n+1/2} = \mathbf{I}^{-1}\mathbf{L}^{n+1/2}$ 来更新方向。我们将这个中点[角速度](@entry_id:192539)视为在整个时间步 $\Delta t$ 内是恒定的，并以此构造一个增量旋转。这个增量旋转本身是一个[单位四元数](@entry_id:204470) $\Delta \mathbf{q}$，通过**指数映射**从[角速度](@entry_id:192539)生成。最终的方向更新是一个[四元数乘法](@entry_id:154753)：
    $$
    \mathbf{q}^{n+1} = \mathbf{q}^n \otimes \Delta \mathbf{q}
    $$
    由于两个[单位四元数](@entry_id:204470)的乘积仍然是[单位四元数](@entry_id:204470)，这个更新步骤**自动且精确地保持了四元数的单位范数**，无需任何额外的投影或归一化步骤。

这个集成的算法，结合了动量的隐式中点更新和方向的李群更新，构成了分子动力学中用于模拟刚体的最先进方法之一。

#### 高级积分主题

**从[势能](@entry_id:748988)计算力矩**：在许多模拟中，力矩是方向依赖势能 $U(\mathbf{q})$ 的梯度。手动推导这个梯度可能非常繁琐且容易出错。**[自动微分](@entry_id:144512)（AD）**是一种强大的计算技术，可以精确地计算函数的导数。通过使用**[对偶数](@entry_id:172934)**，我们可以将函数求值和导数计算合并在一个计算过程中，得到精确到机器精度的力矩 [@problem_id:3442449]。

**正则系综的恒温技术**：在恒定温度下进行模拟需要使用**恒温器**。然而，为刚体选择和实施正确的恒温器需要特别小心。一个常见的错误是基于不正确的动能表达式来应用[恒温器](@entry_id:169186)。例如，直接对四元数动量 $\boldsymbol{\pi}$ 或[角速度](@entry_id:192539) $\boldsymbol{\omega}$ 应用标准恒温器是错误的，因为它们的“质量”矩阵（即动能表达式中的二次型矩阵）是依赖于方向 $q$ 的，或者对于非对称刚体是非各向同性的 [@problem_id:3442434]。
正确的做法是在一个动能表达式为具有**常数[质量矩阵](@entry_id:177093)**的简单二次型的[坐标系](@entry_id:156346)中应用[恒温器](@entry_id:169186)。对于刚体，最方便的选择是**体[坐标系](@entry_id:156346)角动量** $\mathbf{L}$。动能表示为 $K_{\mathrm{rot}} = \frac{1}{2}\mathbf{L}^T \mathbf{I}^{-1} \mathbf{L}$，其中惯性张量 $\mathbf{I}$ 是常数。无论是随机的[朗之万恒温器](@entry_id:142944)还是确定性的诺斯-胡佛链恒温器，都应该耦合到这个表达式 [@problem_id:3442434]。这是确保模拟正确采样[正则系综](@entry_id:142391)[分布](@entry_id:182848)的关键一步。