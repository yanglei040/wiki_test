{"hands_on_practices": [{"introduction": "对偶变量（Antithetic variates）通过在样本对之间引入负相关性，为减少方差提供了一种巧妙的方法。本练习将引导您从第一性原理出发，推导指数函数这一经典案例中的方差缩减量，该方法因函数的单调性而在此处尤为有效。通过完成这个基础示例 [@problem_id:3360544]，您将具体理解对偶采样的原理和工作方式。", "problem": "考虑当 $U\\sim \\text{Uniform}(0,1)$ 时，估计积分 $I=\\mathbb{E}[f(U)]$，其中 $f(u)=\\exp(u)$。请从第一性原理出发：期望的积分定义、方差的定义 $\\operatorname{Var}(X)=\\mathbb{E}[X^{2}]-(\\mathbb{E}[X])^{2}$，以及期望的线性性。现有两种估计量，它们使用固定的 $N$ 次函数求值的计算预算（其中 $N$ 为偶数）。\n\n- 普通蒙特卡洛（MC）：抽取独立同分布（i.i.d.）的 $U_{1},\\ldots,U_{N}\\sim \\text{Uniform}(0,1)$ 并计算 $\\widehat{I}_{N}=\\frac{1}{N}\\sum_{i=1}^{N} f(U_{i})$。\n\n- 对偶变量法：抽取独立同分布的 $U_{1},\\ldots,U_{N/2}\\sim \\text{Uniform}(0,1)$，形成对偶对 $(U_{i},1-U_{i})$，并计算 $\\widehat{I}^{\\mathrm{anti}}_{N}=\\frac{2}{N}\\sum_{i=1}^{N/2}\\frac{f(U_{i})+f(1-U_{i})}{2}$。\n\n仅使用上述积分定义以及期望和方差的性质，完成以下任务：\n\n1. 推导 $\\operatorname{Var}(f(U))$ 的精确表达式。\n2. 推导单个对偶对 $\\operatorname{Var}\\!\\left(\\frac{f(U)+f(1-U)}{2}\\right)$ 的精确表达式。\n3. 因此，在相同的计算成本 $N$ 下，推导 $\\widehat{I}_{N}$ 和 $\\widehat{I}^{\\mathrm{anti}}_{N}$ 的精确方差。\n4. 将等成本下的方差缩减因子 $R$ 定义为比率 $R=\\operatorname{Var}(\\widehat{I}^{\\mathrm{anti}}_{N})/\\operatorname{Var}(\\widehat{I}_{N})$，并将其化简为一个不依赖于 $N$ 的闭式表达式。\n\n以精确的符号形式提供 $R$ 作为最终答案。不要进行近似计算，也不要包含单位。如果使用任何中间数值进行验证，请不要在最终结果中使用它。", "solution": "此问题定义良好，具有科学依据，并包含唯一解所需的所有信息。我们着手进行推导。\n\n设 $U$ 是一个服从 Uniform($0,1$) 分布的随机变量。其概率密度函数为 $p(u) = 1$（当 $u \\in [0, 1]$ 时），否则为 $0$。我们感兴趣的函数是 $f(u) = \\exp(u)$。需要估计的积分是 $I = \\mathbb{E}[f(U)]$。\n\n首先，我们计算积分 $I$ 的真实值：\n$$I = \\mathbb{E}[f(U)] = \\int_{0}^{1} f(u) p(u) \\, du = \\int_{0}^{1} \\exp(u) \\cdot 1 \\, du = [\\exp(u)]_{0}^{1} = \\exp(1) - \\exp(0) = e-1$$\n\n这证实了我们的估计量的期望值应为 $e-1$。\n\n**1. 推导 $\\operatorname{Var}(f(U))$**\n\n为了计算方差，我们使用公式 $\\operatorname{Var}(X) = \\mathbb{E}[X^2] - (\\mathbb{E}[X])^2$。我们首先需要 $f(U)$ 的二阶矩。\n$$\\mathbb{E}[(f(U))^2] = \\mathbb{E}[\\exp(2U)] = \\int_{0}^{1} \\exp(2u) \\, du = \\left[\\frac{1}{2}\\exp(2u)\\right]_{0}^{1} = \\frac{1}{2}(\\exp(2) - \\exp(0)) = \\frac{e^2 - 1}{2}$$\n现在，我们可以计算 $f(U)$ 的方差：\n$$\\operatorname{Var}(f(U)) = \\mathbb{E}[(f(U))^2] - (\\mathbb{E}[f(U)])^2 = \\frac{e^2 - 1}{2} - (e-1)^2$$\n展开平方项：\n$$(e-1)^2 = e^2 - 2e + 1$$\n将此代回方差表达式：\n$$\\operatorname{Var}(f(U)) = \\frac{e^2 - 1}{2} - (e^2 - 2e + 1) = \\frac{e^2 - 1 - 2(e^2 - 2e + 1)}{2} = \\frac{e^2 - 1 - 2e^2 + 4e - 2}{2}$$\n$$\\operatorname{Var}(f(U)) = \\frac{-e^2 + 4e - 3}{2}$$\n\n**2. 推导 $\\operatorname{Var}\\!\\left(\\frac{f(U)+f(1-U)}{2}\\right)$**\n\n设 $Y = \\frac{f(U)+f(1-U)}{2} = \\frac{\\exp(U)+\\exp(1-U)}{2}$。我们需要计算 $\\operatorname{Var}(Y)$。\n首先，我们求 $Y$ 的期望：\n$$\\mathbb{E}[Y] = \\mathbb{E}\\left[\\frac{\\exp(U)+\\exp(1-U)}{2}\\right] = \\frac{1}{2}(\\mathbb{E}[\\exp(U)] + \\mathbb{E}[\\exp(1-U)])$$\n如果 $U \\sim \\text{Uniform}(0,1)$，那么随机变量 $V = 1-U$ 也服从 $\\text{Uniform}(0,1)$ 分布。因此，$\\mathbb{E}[\\exp(1-U)] = \\mathbb{E}[\\exp(V)] = \\mathbb{E}[\\exp(U)] = e-1$。\n$$\\mathbb{E}[Y] = \\frac{1}{2}((e-1) + (e-1)) = e-1$$\n这表明对偶变量抽样提供了一个无偏估计。\n\n接下来，我们求 $Y$ 的二阶矩：\n$$\\mathbb{E}[Y^2] = \\mathbb{E}\\left[\\left(\\frac{\\exp(U)+\\exp(1-U)}{2}\\right)^2\\right] = \\frac{1}{4}\\mathbb{E}[\\exp(2U) + 2\\exp(U)\\exp(1-U) + \\exp(2(1-U))]$$\n中间项化简为：$2\\exp(U)\\exp(1-U) = 2\\exp(U+1-U) = 2e$。\n$$\\mathbb{E}[Y^2] = \\frac{1}{4}\\mathbb{E}[\\exp(2U) + 2e + \\exp(2-2U)]$$\n使用期望的线性性：\n$$\\mathbb{E}[Y^2] = \\frac{1}{4}(\\mathbb{E}[\\exp(2U)] + \\mathbb{E}[2e] + \\mathbb{E}[\\exp(2-2U)])$$\n我们已经知道 $\\mathbb{E}[\\exp(2U)] = \\frac{e^2-1}{2}$。对于最后一项，我们计算积分：\n$$\\mathbb{E}[\\exp(2-2U)] = \\int_{0}^{1} \\exp(2-2u) \\, du = \\left[-\\frac{1}{2}\\exp(2-2u)\\right]_{0}^{1} = -\\frac{1}{2}(\\exp(0) - \\exp(2)) = \\frac{e^2-1}{2}$$\n将这些结果代回：\n$$\\mathbb{E}[Y^2] = \\frac{1}{4}\\left(\\frac{e^2-1}{2} + 2e + \\frac{e^2-1}{2}\\right) = \\frac{1}{4}(e^2-1+2e) = \\frac{e^2+2e-1}{4}$$\n现在我们计算 $Y$ 的方差：\n$$\\operatorname{Var}(Y) = \\mathbb{E}[Y^2] - (\\mathbb{E}[Y])^2 = \\frac{e^2+2e-1}{4} - (e-1)^2 = \\frac{e^2+2e-1 - 4(e^2-2e+1)}{4}$$\n$$\\operatorname{Var}(Y) = \\frac{e^2+2e-1 - 4e^2+8e-4}{4} = \\frac{-3e^2+10e-5}{4}$$\n\n**3. 推导估计量的方差**\n\n普通蒙特卡洛估计量为 $\\widehat{I}_{N} = \\frac{1}{N}\\sum_{i=1}^{N} f(U_{i})$，其中 $U_i$ 是独立同分布的。$N$ 个独立同分布随机变量均值的方差是单个变量方差除以 $N$。\n$$\\operatorname{Var}(\\widehat{I}_{N}) = \\frac{1}{N}\\operatorname{Var}(f(U)) = \\frac{1}{N} \\left(\\frac{-e^2 + 4e - 3}{2}\\right) = \\frac{-e^2 + 4e - 3}{2N}$$\n对偶变量估计量为 $\\widehat{I}^{\\mathrm{anti}}_{N} = \\frac{1}{N/2}\\sum_{i=1}^{N/2} Y_i$，其中 $Y_i = \\frac{f(U_i)+f(1-U_i)}{2}$。由于 $i=1, \\dots, N/2$ 的 $U_i$ 是独立同分布的，所以随机变量 $Y_i$ 也是独立同分布的。该估计量是 $N/2$ 个独立同分布样本的均值。\n$$\\operatorname{Var}(\\widehat{I}^{\\mathrm{anti}}_{N}) = \\frac{1}{N/2}\\operatorname{Var}(Y) = \\frac{2}{N}\\left(\\frac{-3e^2+10e-5}{4}\\right) = \\frac{-3e^2+10e-5}{2N}$$\n\n**4. 推导方差缩减因子 $R$**\n\n在相同计算成本 $N$ 下，方差缩减因子 $R$ 是两个方差的比值。\n$$R = \\frac{\\operatorname{Var}(\\widehat{I}^{\\mathrm{anti}}_{N})}{\\operatorname{Var}(\\widehat{I}_{N})} = \\frac{\\frac{-3e^2+10e-5}{2N}}{\\frac{-e^2+4e-3}{2N}}$$\n分母中的项 $2N$ 相互抵消，得到一个与 $N$ 无关的 $R$ 的表达式：\n$$R = \\frac{-3e^2+10e-5}{-e^2+4e-3}$$\n这可以通过分子和分母同乘以 $-1$ 来重写，以使首项系数为正：\n$$R = \\frac{3e^2-10e+5}{e^2-4e+3}$$\n两种形式是等价的。我们给出直接从正值方差项推导出的形式。", "answer": "$$\\boxed{\\frac{-3e^2+10e-5}{-e^2+4e-3}}$$", "id": "3360544"}, {"introduction": "虽然分层抽样可以是一种强大的方差缩减工具，但其有效性取决于分层变量的审慎选择。本练习探讨了一个关键原则：选择不当的分层会适得其反地增加方差，尤其是在非按比例分配样本时。通过分析一个分层失败的场景，并进而推导出一个通用的筛选标准 [@problem_id:3360521]，您将培养出选择能真正提高估计效率的变量所需的批判性判断力。", "problem": "考虑使用蒙特卡洛模拟估计积分 $I = \\mathbb{E}[f(X)]$ 的任务，其中 $X$ 是一个随机向量，$f$ 是一个实值可测函数。你可以假设以下基本事实成立：无偏样本均值估计量的方差等于其加数方差除以样本量，以及全方差定律成立。构建并分析以下情景，以探究选择不当的分层会增加方差的原理，然后推导一个有原则的筛选标准来选择分层变量。\n\n情景。设 $X \\sim \\mathcal{N}(0,1)$ 与一个具有三个水平 $\\{1,2,3\\}$ 且概率为 $\\mathbb{P}(Y=1)=0.7$, $\\mathbb{P}(Y=2)=0.2$ 和 $\\mathbb{P}(Y=3)=0.1$ 的分类变量 $Y$ 独立。目标函数为 $f(X) = X$。假设你对 $Y$ 进行分层抽样，在每个层 $h \\in \\{1,2,3\\}$ 中采用相等分配，即 $n_h = n/3$ 个样本，并通过将每个层的均值按其真实层概率加权来构成标准的分层估计量。\n\n任务：\n1. 从第一性原理出发，推导在此情景下忽略 $Y$ 的普通蒙特卡洛估计量 $I$ 的方差，以及在 $Y$ 的三个层上使用相等分配的分层估计量的方差。然后计算分层方差与普通蒙特卡洛方差之比。将此比值四舍五入至四位有效数字。\n2. 将方差比较推广到一个具有 $L$ 个层、层概率为 $\\{p_h\\}_{h=1}^{L}$ 且采用相等分配 $n_h = n/L$ 的分类筛选变量 $W$。假设一个层内同方差模型 $f(X) = \\mu_h + \\varepsilon$ 当 $W=h$ 时成立，其中 $\\varepsilon$ 是独立噪声，满足 $\\mathbb{E}[\\varepsilon]=0$ 和 $\\operatorname{Var}(\\varepsilon) = \\sigma_{\\varepsilon}^{2}$，且均值 $\\{\\mu_h\\}$ 是确定性的层特定值。仅使用核心定义和全方差定律，用 $f(X)$ 和 $W$ 之间的典型相关系数的平方（记为 $\\rho_{c}^{2}$）以及层概率 $\\{p_h\\}$ 来表示分层估计量与普通蒙特卡洛估计量的方差之比。然后，推导筛选阈值 $T$（作为 $L$ 和 $\\{p_h\\}$ 的函数）的闭式解析表达式，使得对 $W$ 进行分层能严格减小方差的充要条件是 $\\rho_{c}^{2} > T$。提供 $T$ 作为你的最终解析表达式。\n\n答案格式要求：\n- 最终答案必须包含两项内容：任务1的数值方差比和任务2的阈值 $T$ 的解析表达式，并列呈现。\n- 将数值比率四舍五入至四位有效数字。\n- 不包含任何单位。", "solution": "该问题被认为是有效的，因为它具有科学依据，问题提出得当，客观，并且不包含矛盾或歧义。它代表了蒙特卡洛方法中的一个标准理论练习。\n\n### 任务1：特定情景下的方差比\n\n设待估计的积分为 $I = \\mathbb{E}[f(X)]$，其中目标函数为 $f(X) = X$ 且 $X \\sim \\mathcal{N}(0,1)$。期望值为 $I = \\mathbb{E}[X] = 0$。\n\n使用大小为 $n$ 的样本，普通蒙特卡洛估计量由 $\\hat{I}_{MC} = \\frac{1}{n} \\sum_{i=1}^{n} X_i$ 给出。该估计量的方差为：\n$$\n\\operatorname{Var}(\\hat{I}_{MC}) = \\frac{1}{n} \\operatorname{Var}(X)\n$$\n由于 $X \\sim \\mathcal{N}(0,1)$，其方差为 $\\operatorname{Var(X)} = 1$。因此，\n$$\n\\operatorname{Var}(\\hat{I}_{MC}) = \\frac{1}{n}\n$$\n\n接下来，我们考虑分层估计量。总体根据分类变量 $Y$ 进行分层，该变量有三个层 $h \\in \\{1, 2, 3\\}$，概率分别为 $p_1 = 0.7$, $p_2 = 0.2$ 和 $p_3 = 0.1$。分配是相等的，每个层抽取 $n_h = n/3$ 个样本。分层估计量为：\n$$\n\\hat{I}_{strat} = \\sum_{h=1}^{3} p_h \\hat{I}_h = \\sum_{h=1}^{3} p_h \\left( \\frac{1}{n_h} \\sum_{i=1}^{n_h} f(X_{h,i}) \\right)\n$$\n其中 $X_{h,i}$ 是从层 $h$ 抽取的第 $i$ 个样本。分层估计量的方差由下式给出：\n$$\n\\operatorname{Var}(\\hat{I}_{strat}) = \\operatorname{Var}\\left(\\sum_{h=1}^{3} p_h \\hat{I}_h\\right) = \\sum_{h=1}^{3} p_h^2 \\operatorname{Var}(\\hat{I}_h)\n$$\n因为来自不同层的样本是独立的。每个层中样本均值的方差为：\n$$\n\\operatorname{Var}(\\hat{I}_h) = \\frac{1}{n_h} \\operatorname{Var}(f(X) | Y=h)\n$$\n问题陈述 $X$ 和 $Y$ 是独立的。这意味着给定 $Y=h$ 时 $X$ 的条件分布与 $X$ 的边际分布相同。因此，条件方差等于边际方差：\n$$\n\\operatorname{Var}(f(X) | Y=h) = \\operatorname{Var}(X | Y=h) = \\operatorname{Var}(X) = 1\n$$\n对所有层 $h$ 成立。将此结果和 $n_h = n/3$ 代入 $\\hat{I}_{strat}$ 的方差公式：\n$$\n\\operatorname{Var}(\\hat{I}_{strat}) = \\sum_{h=1}^{3} \\frac{p_h^2}{n/3} (1) = \\frac{3}{n} \\sum_{h=1}^{3} p_h^2\n$$\n我们现在计算概率的平方和：\n$$\n\\sum_{h=1}^{3} p_h^2 = (0.7)^2 + (0.2)^2 + (0.1)^2 = 0.49 + 0.04 + 0.01 = 0.54\n$$\n因此，分层估计量的方差为：\n$$\n\\operatorname{Var}(\\hat{I}_{strat}) = \\frac{3}{n} (0.54) = \\frac{1.62}{n}\n$$\n分层方差与普通蒙特卡洛方差之比为：\n$$\n\\frac{\\operatorname{Var}(\\hat{I}_{strat})}{\\operatorname{Var}(\\hat{I}_{MC})} = \\frac{1.62/n}{1/n} = 1.62\n$$\n四舍五入到四位有效数字得到 $1.620$。方差之所以增加，是因为对一个不相关的变量进行了分层，并且结合了非比例的样本分配。\n\n### 任务2：通用筛选标准\n\n我们现在推广该分析。设 $W$ 是一个具有 $L$ 个层、概率为 $\\{p_h\\}_{h=1}^L$ 且采用相等分配 $n_h = n/L$ 的分类筛选变量。模型为当 $W=h$ 时，$f(X) = \\mu_h + \\varepsilon$，其中 $\\mathbb{E}[\\varepsilon]=0$, $\\operatorname{Var}(\\varepsilon)=\\sigma_\\varepsilon^2$，且 $\\varepsilon$ 与 $W$ 独立。\n\n首先，我们求普通蒙特卡洛估计量的方差，$\\operatorname{Var}(\\hat{I}_{MC}) = \\frac{1}{n} \\operatorname{Var}(f(X))$。我们使用全方差定律：\n$$\n\\operatorname{Var}(f(X)) = \\mathbb{E}[\\operatorname{Var}(f(X)|W)] + \\operatorname{Var}(\\mathbb{E}[f(X)|W])\n$$\n条件矩为：\n$$\n\\mathbb{E}[f(X)|W=h] = \\mathbb{E}[\\mu_h + \\varepsilon | W=h] = \\mu_h + \\mathbb{E}[\\varepsilon] = \\mu_h\n$$\n$$\n\\operatorname{Var}(f(X)|W=h) = \\operatorname{Var}(\\mu_h + \\varepsilon | W=h) = \\operatorname{Var}(\\varepsilon) = \\sigma_\\varepsilon^2\n$$\n全方差的第一项是期望的层内方差：\n$$\n\\mathbb{E}[\\operatorname{Var}(f(X)|W)] = \\sum_{h=1}^{L} p_h \\operatorname{Var}(f(X)|W=h) = \\sum_{h=1}^{L} p_h \\sigma_\\varepsilon^2 = \\sigma_\\varepsilon^2\n$$\n第二项是层间方差。随机变量 $\\mathbb{E}[f(X)|W]$ 以概率 $p_h$ 取值 $\\mu_h$。其方差为：\n$$\n\\operatorname{Var}(\\mathbb{E}[f(X)|W]) = \\mathbb{E}[(\\mathbb{E}[f(X)|W])^2] - (\\mathbb{E}[\\mathbb{E}[f(X)|W]])^2 = \\sum_{h=1}^L p_h \\mu_h^2 - \\left(\\sum_{h=1}^L p_h \\mu_h\\right)^2\n$$\n因此，$f(X)$ 的总方差为 $\\operatorname{Var}(f(X)) = \\sigma_\\varepsilon^2 + \\operatorname{Var}(\\mathbb{E}[f(X)|W])$。\n\n采用相等分配 $n_h = n/L$ 的分层估计量的方差为：\n$$\n\\operatorname{Var}(\\hat{I}_{strat}) = \\sum_{h=1}^L \\frac{p_h^2}{n_h} \\operatorname{Var}(f(X)|W=h) = \\sum_{h=1}^L \\frac{p_h^2}{n/L} \\sigma_\\varepsilon^2 = \\frac{L \\sigma_\\varepsilon^2}{n} \\sum_{h=1}^L p_h^2\n$$\n方差之比为：\n$$\nR = \\frac{\\operatorname{Var}(\\hat{I}_{strat})}{\\operatorname{Var}(\\hat{I}_{MC})} = \\frac{\\frac{L \\sigma_\\varepsilon^2}{n} \\sum_{h=1}^L p_h^2}{\\frac{1}{n} (\\sigma_\\varepsilon^2 + \\operatorname{Var}(\\mathbb{E}[f(X)|W]))} = \\frac{L \\sigma_\\varepsilon^2 \\sum_{h=1}^L p_h^2}{\\sigma_\\varepsilon^2 + \\operatorname{Var}(\\mathbb{E}[f(X)|W])}\n$$\n$f(X)$ 和 $W$ 之间的典型相关系数的平方 $\\rho_c^2$ 是 $f(X)$ 中由 $W$ 解释的方差比例：\n$$\n\\rho_c^2 = \\frac{\\operatorname{Var}(\\mathbb{E}[f(X)|W])}{\\operatorname{Var}(f(X))} = \\frac{\\operatorname{Var}(\\mathbb{E}[f(X)|W])}{\\sigma_\\varepsilon^2 + \\operatorname{Var}(\\mathbb{E}[f(X)|W])}\n$$\n根据这个定义，我们可以用 $\\operatorname{Var}(\\mathbb{E}[f(X)|W])$ 和 $\\rho_c^2$ 来表示 $\\sigma_\\varepsilon^2$ 和 $\\operatorname{Var}(f(X))$：\n$$\n\\rho_c^2 (\\sigma_\\varepsilon^2 + \\operatorname{Var}(\\mathbb{E}[f(X)|W])) = \\operatorname{Var}(\\mathbb{E}[f(X)|W]) \\implies \\rho_c^2 \\sigma_\\varepsilon^2 = (1-\\rho_c^2) \\operatorname{Var}(\\mathbb{E}[f(X)|W])\n$$\n$$\n\\sigma_\\varepsilon^2 = \\frac{1-\\rho_c^2}{\\rho_c^2} \\operatorname{Var}(\\mathbb{E}[f(X)|W])\n$$\n且比率 $R$ 的分母是 $\\operatorname{Var}(f(X)) = \\frac{\\operatorname{Var}(\\mathbb{E}[f(X)|W])}{\\rho_c^2}$。将这些代入 $R$ 的表达式：\n$$\nR = \\frac{L \\left(\\frac{1-\\rho_c^2}{\\rho_c^2} \\operatorname{Var}(\\mathbb{E}[f(X)|W])\\right) \\left(\\sum_{h=1}^L p_h^2\\right)}{\\frac{\\operatorname{Var}(\\mathbb{E}[f(X)|W])}{\\rho_c^2}}\n$$\n假设 $\\operatorname{Var}(\\mathbb{E}[f(X)|W]) > 0$（这意味着 $\\rho_c^2 > 0$），我们可以将其简化为：\n$$\nR = L (1-\\rho_c^2) \\sum_{h=1}^L p_h^2\n$$\n分层严格减小方差的充要条件是 $R  1$：\n$$\nL (1-\\rho_c^2) \\sum_{h=1}^L p_h^2  1\n$$\n$$\n1-\\rho_c^2  \\frac{1}{L \\sum_{h=1}^L p_h^2}\n$$\n$$\n\\rho_c^2 > 1 - \\frac{1}{L \\sum_{h=1}^L p_h^2}\n$$\n因此，使得分层有益的充要条件为 $\\rho_c^2 > T$ 的筛选阈值 $T$ 为：\n$$\nT = 1 - \\frac{1}{L \\sum_{h=1}^L p_h^2}\n$$", "answer": "$$\\boxed{\\begin{pmatrix} 1.620 \\\\ 1 - \\frac{1}{L \\sum_{h=1}^{L} p_h^2} \\end{pmatrix}}$$", "id": "3360521"}, {"introduction": "条件蒙特卡洛方法是 Rao-Blackwell 定理的一个应用，也是最强大的方差缩减策略之一，它通过用随机量的条件期望来替代该量本身。这个综合性练习要求您首先为一个概率估计问题推导条件估计量的解析形式及相应的方差缩减。然后，您将通过编写一个仿真程序 [@problem_id:3360535]，以经验方式验证理论上预测的显著效率提升，从而将理论与实践联系起来。", "problem": "给定两个独立的指数随机变量 $X$ 和 $Y$，其率分别为 $\\lambda_X$ 和 $\\lambda_Y$。考虑一个固定的阈值 $c0$ 和指示函数 $f(X,Y) = \\mathbf{1}\\{X+Yc\\}$。目标是使用条件期望 $g(X) = \\mathbb{E}[f(X,Y)\\mid X]$ 作为被积函数，分析条件蒙特卡洛作为一种方差缩减技术的有效性，并量化其与原始蒙特卡洛方法相比的方差缩减效果。\n\n从条件期望的基本定义和指数随机变量的生存函数出发，推导 $g(x)=\\mathbb{E}[\\mathbf{1}\\{x+Yc\\}\\mid X=x]$ 作为 $x$、$\\lambda_Y$ 和 $c$ 的函数的显式表达式，且不预先假设 $\\mathbb{P}(X+Yc)$ 有任何封闭形式。利用全方差公式以及 $X$ 和 $Y$ 的独立性等成熟原理，以 $\\lambda_X$、$\\lambda_Y$ 和 $c$ 为参数，用封闭形式表示原始蒙特卡洛被积函数 $f(X,Y)$ 的方差和条件蒙特卡洛被积函数 $g(X)$ 的方差。在此基础上，推导由下式定义的方差缩减因子的封闭形式表达式：\n$$\n\\mathrm{VRF} = \\frac{\\mathrm{Var}(f(X,Y))}{\\mathrm{Var}(g(X))}.\n$$\n您必须从指数生存函数和条件期望的定义以及全方差公式出发，不假设或引用任何关于 $\\mathbb{P}(X+Yc)$ 或任何中间量的预先推导出的公式。\n\n然后，对以下参数值测试套件，数值计算方差缩减效果：\n- 测试用例 1：$\\lambda_X = 1.5$，$\\lambda_Y = 2.0$， $c = 1.0$。\n- 测试用例 2：$\\lambda_X = 1.0$，$\\lambda_Y = 1.0$， $c = 1.0$。\n- 测试用例 3：$\\lambda_X = 1.0$，$\\lambda_Y = 0.5$， $c = 1.2$。\n- 测试用例 4：$\\lambda_X = 0.1$，$\\lambda_Y = 2.0$， $c = 2.0$。\n\n你的程序必须：\n- 对每个测试用例，使用第一性原理以及与你的推导一致的解析积分结果，计算精确概率 $p = \\mathbb{P}(X+Yc)$。\n- 使用你推导出的 $\\mathrm{Var}(f(X,Y))$ 和 $\\mathrm{Var}(g(X))$ 的封闭形式，计算解析方差缩减因子 $\\mathrm{VRF}$。\n- 对每个测试用例，通过蒙特卡洛模拟（$N = 500000$ 次独立抽样）来估计经验方差缩减因子，并使用固定的随机种子 $20241010$ 以确保可复现性。经验方差缩减因子定义为原始指示函数样本的经验方差与条件样本的经验方差之比。对两者均使用总体方差（通过 $N$ 进行归一化），以避免估计器偏差抵消。\n- 为每个测试用例报告一个包含三个浮点数的三元组：精确概率 $p$、解析 $\\mathrm{VRF}$ 和经验 $\\mathrm{VRF}$。将报告的每个浮点数四舍五入到六位小数。\n\n最终输出格式：\n你的程序应生成单行输出，其中包含一个以逗号分隔的列表的列表，每个内部列表对应于按上述顺序排列的一个测试用例，形式为 $[p,\\mathrm{VRF}_{\\mathrm{analytic}},\\mathrm{VRF}_{\\mathrm{empirical}}]$。例如：\n\"[[p1,vrfA1,vrfE1],[p2,vrfA2,vrfE2],[p3,vrfA3,vrfE3],[p4,vrfA4,vrfE4]]\"。\n\n本问题不涉及任何物理单位或角度单位。所有概率都必须以十进制数表示。请仅使用基于指数分布和条件期望性质的、数学上一致的定义和推导，以确保科学真实性。", "solution": "经评估，用户提供的问题是有效的。该问题是自洽的，在概率论和随机模拟方面有科学依据，并且问题提法清晰。问题要求在条件蒙特卡洛设置下推导方差缩减的解析表达式并进行数值评估，这在指定领域是一项标准且有意义的任务。\n\n问题在于分析使用条件蒙特卡洛方法估计 $p = \\mathbb{P}(X+Yc)$ 时所实现的方差缩减效果，其中 $X \\sim \\text{Exp}(\\lambda_X)$ 和 $Y \\sim \\text{Exp}(\\lambda_Y)$ 是独立的指数随机变量。原始蒙特卡洛估计器使用被积函数 $f(X,Y) = \\mathbf{1}\\{X+Yc\\}$，而条件蒙特卡洛估计器使用被积函数 $g(X) = \\mathbb{E}[f(X,Y)|X]$。\n\n**第1步：推导条件期望 $g(x)$**\n条件期望 $g(x)$ 定义为 $g(x) = \\mathbb{E}[\\mathbf{1}\\{X+Yc\\} \\mid X=x]$。由于 $X$ 和 $Y$ 是独立的，以 $X=x$ 为条件不会改变 $Y$ 的分布。\n$$\ng(x) = \\mathbb{E}[\\mathbf{1}\\{x+Yc\\}] = \\mathbb{P}(x+Yc) = \\mathbb{P}(Yc-x)\n$$\n一个率为 $\\lambda_Y$ 的指数随机变量 $Y$ 的生存函数是，当 $t \\geq 0$ 时 $\\mathbb{P}(Yt) = e^{-\\lambda_Y t}$，当 $t  0$ 时 $\\mathbb{P}(Y>t)=1$。我们必须考虑参数 $c-x$ 的两种情况：\n1. 如果 $x \\leq c$，则 $c-x \\geq 0$，所以 $\\mathbb{P}(Yc-x) = e^{-\\lambda_Y (c-x)}$。\n2. 如果 $x  c$，则 $c-x  0$，所以 $\\mathbb{P}(Yc-x) = 1$。\n由于 $X$ 是一个指数随机变量，其支撑集为 $x \\ge 0$。因此，我们可以将 $g(x)$ 写成：\n$$\ng(x) = \\begin{cases} e^{-\\lambda_Y(c-x)}  \\text{如果 } 0 \\leq x \\leq c \\\\ 1  \\text{如果 } x  c \\end{cases}\n$$\n\n**第2步：推导精确概率 $p = \\mathbb{P}(X+Yc)$**\n根据全期望公式，$p = \\mathbb{E}[f(X,Y)] = \\mathbb{E}[\\mathbb{E}[f(X,Y)|X]] = \\mathbb{E}[g(X)]$。该期望是通过将 $g(x)$ 对 $X$ 的概率密度函数 (PDF) 进行积分来计算的，其中 $f_X(x) = \\lambda_X e^{-\\lambda_X x}$ (对于 $x \\ge 0$)。\n$$\np = \\int_{0}^{\\infty} g(x) f_X(x) dx = \\int_{0}^{c} g(x) f_X(x) dx + \\int_{c}^{\\infty} g(x) f_X(x) dx\n$$\n代入 $g(x)$ 的表达式：\n$$\np = \\int_{0}^{c} e^{-\\lambda_Y(c-x)} (\\lambda_X e^{-\\lambda_X x}) dx + \\int_{c}^{\\infty} 1 \\cdot (\\lambda_X e^{-\\lambda_X x}) dx\n$$\n第二个积分是 $X$ 在 $c$ 处的生存函数：$\\int_{c}^{\\infty} \\lambda_X e^{-\\lambda_X x} dx = [-e^{-\\lambda_X x}]_c^\\infty = e^{-\\lambda_X c}$。\n第一个积分是：\n$$\n\\int_{0}^{c} \\lambda_X e^{-\\lambda_Y c} e^{\\lambda_Y x} e^{-\\lambda_X x} dx = \\lambda_X e^{-\\lambda_Y c} \\int_{0}^{c} e^{(\\lambda_Y - \\lambda_X)x} dx\n$$\n我们考虑该积分的两种情况：\n1. 如果 $\\lambda_X \\neq \\lambda_Y$：\n$$\n\\lambda_X e^{-\\lambda_Y c} \\left[ \\frac{e^{(\\lambda_Y - \\lambda_X)x}}{\\lambda_Y - \\lambda_X} \\right]_0^c = \\frac{\\lambda_X e^{-\\lambda_Y c}}{\\lambda_Y - \\lambda_X} (e^{(\\lambda_Y - \\lambda_X)c} - 1) = \\frac{\\lambda_X}{\\lambda_Y - \\lambda_X}(e^{-\\lambda_X c} - e^{-\\lambda_Y c})\n$$\n2. 如果 $\\lambda_X = \\lambda_Y = \\lambda$：\n$$\n\\lambda e^{-\\lambda c} \\int_{0}^{c} e^{0 \\cdot x} dx = \\lambda e^{-\\lambda c} \\int_{0}^{c} 1 dx = \\lambda c e^{-\\lambda c}\n$$\n综合这些结果，我们得到 $p$ 的表达式：\n- 如果 $\\lambda_X \\neq \\lambda_Y$：\n$p = \\frac{\\lambda_X}{\\lambda_Y - \\lambda_X}(e^{-\\lambda_X c} - e^{-\\lambda_Y c}) + e^{-\\lambda_X c} = \\frac{\\lambda_Y e^{-\\lambda_X c} - \\lambda_X e^{-\\lambda_Y c}}{\\lambda_Y - \\lambda_X}$\n- 如果 $\\lambda_X = \\lambda_Y = \\lambda$：$p = \\lambda c e^{-\\lambda c} + e^{-\\lambda c} = (1+\\lambda c)e^{-\\lambda c}$\n\n**第3步：推导方差和方差缩减因子 (VRF)**\n原始蒙特卡洛被积函数 $f(X,Y)$ 是一个成功概率为 $p$ 的伯努利随机变量。其方差为：\n$$\n\\mathrm{Var}(f(X,Y)) = p(1-p)\n$$\n条件蒙特卡洛被积函数是 $g(X)$。其方差为 $\\mathrm{Var}(g(X)) = \\mathbb{E}[(g(X))^2] - (\\mathbb{E}[g(X)])^2 = \\mathbb{E}[(g(X))^2] - p^2$。我们需要计算 $\\mathbb{E}[(g(X))^2]$：\n$$\n\\mathbb{E}[(g(X))^2] = \\int_{0}^{\\infty} (g(x))^2 f_X(x) dx = \\int_{0}^{c} (e^{-\\lambda_Y(c-x)})^2 (\\lambda_X e^{-\\lambda_X x}) dx + \\int_{c}^{\\infty} 1^2 \\cdot (\\lambda_X e^{-\\lambda_X x}) dx\n$$\n第二个积分同样是 $e^{-\\lambda_X c}$。第一个积分是：\n$$\n\\int_{0}^{c} \\lambda_X e^{-2\\lambda_Y c} e^{2\\lambda_Y x} e^{-\\lambda_X x} dx = \\lambda_X e^{-2\\lambda_Y c} \\int_{0}^{c} e^{(2\\lambda_Y - \\lambda_X)x} dx\n$$\n我们根据 $2\\lambda_Y - \\lambda_X$ 是否为零来考虑两种情况：\n1. 如果 $2\\lambda_Y \\neq \\lambda_X$：\n$$\n\\lambda_X e^{-2\\lambda_Y c} \\left[\\frac{e^{(2\\lambda_Y-\\lambda_X)x}}{2\\lambda_Y - \\lambda_X}\\right]_0^c = \\frac{\\lambda_X e^{-2\\lambda_Y c}}{2\\lambda_Y - \\lambda_X}(e^{(2\\lambda_Y - \\lambda_X)c} - 1) = \\frac{\\lambda_X}{2\\lambda_Y - \\lambda_X}(e^{-\\lambda_X c} - e^{-2\\lambda_Y c})\n$$\n2. 如果 $2\\lambda_Y = \\lambda_X$：\n$$\n\\lambda_X e^{-2\\lambda_Y c} \\int_0^c 1 dx = \\lambda_X c e^{-2\\lambda_Y c}\n$$\n综合 $\\mathbb{E}[(g(X))^2]$ 的结果：\n- 如果 $2\\lambda_Y \\neq \\lambda_X$：\n$\\mathbb{E}[(g(X))^2] = \\frac{\\lambda_X}{2\\lambda_Y - \\lambda_X}(e^{-\\lambda_X c} - e^{-2\\lambda_Y c}) + e^{-\\lambda_X c} = \\frac{2\\lambda_Y e^{-\\lambda_X c} - \\lambda_X e^{-2\\lambda_Y c}}{2\\lambda_Y - \\lambda_X}$\n- 如果 $2\\lambda_Y = \\lambda_X$：\n$\\mathbb{E}[(g(X))^2] = \\lambda_X c e^{-2\\lambda_Y c} + e^{-\\lambda_X c} = \\lambda_X c e^{-\\lambda_X c} + e^{-\\lambda_X c} = (1 + \\lambda_X c) e^{-\\lambda_X c}$\n\n最后，条件估计器的方差为 $\\mathrm{Var}(g(X)) = \\mathbb{E}[(g(X))^2] - p^2$。方差缩减因子 (VRF) 是两个方差的比值：\n$$\n\\mathrm{VRF} = \\frac{\\mathrm{Var}(f(X,Y))}{\\mathrm{Var}(g(X))} = \\frac{p(1-p)}{\\mathbb{E}[(g(X))^2] - p^2}\n$$\n全方差公式表明 $\\mathrm{Var}(f(X,Y)) = \\mathrm{Var}(g(X)) + \\mathbb{E}[\\mathrm{Var}(f(X,Y)|X)]$。由于 $\\mathrm{Var}(f(X,Y)|X) = g(X)(1-g(X)) \\geq 0$，其期望也是非负的。这保证了 $\\mathrm{Var}(f(X,Y)) \\geq \\mathrm{Var}(g(X))$，因此 $\\mathrm{VRF} \\geq 1$，从而证实了方差缩减。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem by deriving analytical expressions for variance reduction\n    and validating them with Monte Carlo simulation for the given test cases.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (1.5, 2.0, 1.0),\n        (1.0, 1.0, 1.0),\n        (1.0, 0.5, 1.2),\n        (0.1, 2.0, 2.0),\n    ]\n\n    results = []\n    N = 500000\n    seed = 20241010\n    rng = np.random.default_rng(seed)\n    \n    TOLERANCE = 1e-9\n\n    for lx, ly, c in test_cases:\n        # --- Analytical Calculations ---\n        \n        # Calculate p = E[g(X)]\n        if abs(lx - ly)  TOLERANCE:\n            # Case lambda_X = lambda_Y\n            p_analytic = (1 + lx * c) * np.exp(-lx * c)\n        else:\n            # Case lambda_X != lambda_Y\n            term1 = ly * np.exp(-lx * c)\n            term2 = lx * np.exp(-ly * c)\n            p_analytic = (term1 - term2) / (ly - lx)\n            \n        # Calculate E[g(X)^2]\n        if abs(lx - 2 * ly)  TOLERANCE:\n            # Case lambda_X = 2 * lambda_Y\n            e_g_sq_analytic = (1 + lx * c) * np.exp(-lx * c)\n        else:\n            # Case lambda_X != 2 * lambda_Y\n            term1 = 2 * ly * np.exp(-lx * c)\n            term2 = lx * np.exp(-2 * ly * c)\n            e_g_sq_analytic = (term1 - term2) / (2 * ly - lx)\n\n        # Calculate analytical variances\n        var_f_analytic = p_analytic * (1 - p_analytic)\n        var_g_analytic = e_g_sq_analytic - p_analytic**2\n        \n        # Ensure variance is non-negative before division\n        if var_g_analytic  0:\n            vrf_analytic = var_f_analytic / var_g_analytic\n        else:\n            vrf_analytic = np.inf\n\n        # --- Monte Carlo Simulation ---\n        \n        # Generate random samples\n        x_samples = rng.exponential(scale=1/lx, size=N)\n        y_samples = rng.exponential(scale=1/ly, size=N)\n        \n        # Crude Monte Carlo estimator samples\n        f_samples = (x_samples + y_samples  c).astype(float)\n        \n        # Conditional Monte Carlo estimator samples\n        g_samples = np.where(x_samples  c, 1.0, np.exp(-ly * (c - x_samples)))\n        \n        # Calculate empirical population variances (ddof=0)\n        var_f_empirical = np.var(f_samples, ddof=0)\n        var_g_empirical = np.var(g_samples, ddof=0)\n        \n        # Calculate empirical variance reduction factor\n        if var_g_empirical  0:\n            vrf_empirical = var_f_empirical / var_g_empirical\n        else:\n            vrf_empirical = np.inf\n            \n        # Store results rounded to six decimal places\n        results.append([\n            round(p_analytic, 6),\n            round(vrf_analytic, 6),\n            round(vrf_empirical, 6)\n        ])\n\n    # Final print statement in the exact required format.\n    formatted_results = [f\"[{p},{vrfA},{vrfE}]\" for p, vrfA, vrfE in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "3360535"}]}