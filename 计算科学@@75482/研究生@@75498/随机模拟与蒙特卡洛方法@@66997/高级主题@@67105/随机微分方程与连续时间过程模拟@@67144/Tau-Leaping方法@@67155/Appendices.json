{"hands_on_practices": [{"introduction": "本练习是我们实践性理解的基石。我们将通过一个简单的生灭系统，比较单步 tau-leaping 带来的期望变化与单次精确随机模拟算法（SSA）事件所产生的期望变化，从而阐明 tau-leaping 方法背后的核心假设——即它近似了在一个时间步长 $\\tau$ 内可能发生的多个离散事件的累积效应。[@problem_id:3350254]", "problem": "考虑一个单物种生灭系统的连续时间马尔可夫跳跃过程，其状态为 $X(t) \\in \\mathbb{N}$，并有两个反应通道：一个出生反应，其倾向函数为 $a_{1}(x)=\\lambda x$；以及一个死亡反应，其倾向函数为 $a_{2}(x)=\\mu x$，其中 $\\lambda0$ 和 $\\mu0$。假设在一个短时间区间 $[t,t+\\tau]$ 内，倾向函数可以被视为在 $X(t)=x$ 的值上是恒定的，并考虑由下式定义的 tau-跳跃法 的单步：\n$$\nX(t+\\tau)=X(t)+K_{1}-K_{2},\n$$\n其中 $K_{1}\\sim \\mathrm{Poisson}(\\lambda x \\tau)$ 和 $K_{2}\\sim \\mathrm{Poisson}(\\mu x \\tau)$ 是独立的。另外，考虑由随机模拟算法 (SSA) 生成的一个事件，即根据状态 $x$ 下的倾向函数所决定的反应概率，选择一次反应发生。\n\n从独立泊松随机变量的定义和随机模拟算法 (SSA) 的构造出发，推导在一次 tau-跳跃 中状态的期望变化 $\\mathbb{E}[X(t+\\tau)-X(t)\\mid X(t)=x]$，以及由于一次 SSA 反应发生导致的状态期望变化 $\\mathbb{E}[\\Delta X_{\\mathrm{SSA}}\\mid X(t)=x]$。然后，在 $\\lambda\\neq \\mu$ 的假设下，计算比率\n$$\nR(x,\\tau,\\lambda,\\mu)=\\frac{\\mathbb{E}[X(t+\\tau)-X(t)\\mid X(t)=x]}{\\mathbb{E}[\\Delta X_{\\mathrm{SSA}}\\mid X(t)=x]}。\n$$\n将 $R(x,\\tau,\\lambda,\\mu)$ 表示为单一的闭式解析表达式。不需要四舍五入。最终答案无需单位。", "solution": "用户要求我解决一个关于随机模拟方法的问题。\n\n### 第一步：提取已知条件\n- 一个单物种系统的连续时间马尔可夫跳跃过程。\n- 状态：$X(t) \\in \\mathbb{N}$。\n- 反应1 (出生)：倾向函数 $a_{1}(x) = \\lambda x$，其中 $\\lambda  0$。状态变化为 $+1$。\n- 反应2 (死亡)：倾向函数 $a_{2}(x) = \\mu x$，其中 $\\mu  0$。状态变化为 $-1$。\n- 在区间 $[t, t+\\tau]$ 上的 tau-跳跃法更新：$X(t+\\tau) = X(t) + K_{1} - K_{2}$。\n- $K_{1} \\sim \\mathrm{Poisson}(\\lambda x \\tau)$，其中 $x = X(t)$。\n- $K_{2} \\sim \\mathrm{Poisson}(\\mu x \\tau)$，其中 $x = X(t)$。\n- $K_{1}$ 和 $K_{2}$ 是独立的。\n- 随机模拟算法 (SSA)：一个事件是根据状态 $x$ 下的倾向函数选择的一次反应发生。\n- 假设：$\\lambda \\neq \\mu$。\n- 目标：计算比率 $R(x,\\tau,\\lambda,\\mu) = \\frac{\\mathbb{E}[X(t+\\tau)-X(t)\\mid X(t)=x]}{\\mathbb{E}[\\Delta X_{\\mathrm{SSA}}\\mid X(t)=x]}$。\n\n### 第二步：使用提取的已知条件进行验证\n1.  **科学基础**：该问题描述了一个标准的生灭过程，这是随机种群动力学和化学动力学中的一个基本模型。tau-跳跃法和随机模拟算法（SSA，也称为 Gillespie 算法）都是模拟此类系统的公认基石方法。数学公式是标准且正确的。\n2.  **问题明确**：问题要求推导两个期望值及其比率。这些都是明确定义的数学量。给出了条件 $\\lambda \\neq \\mu$，这是避免比率定义中分母为零所必需的，确保了比率的良定性。问题是自洽的，并提供了所有必要的信息。\n3.  **客观性**：问题以精确、客观的数学语言陈述。没有主观或基于意见的元素。\n\n该问题是有效的，因为它科学上合理、问题明确且客观。验证清单中未发现任何缺陷。我将继续进行解答。\n\n### 第三步：结论与行动\n问题有效。我将提供一个完整、有理据的解答。\n\n问题要求计算两个不同的期望值及其比率。我们将分别计算每个部分。\n\n首先，我们计算一次 tau-跳跃 中状态的期望变化，$\\mathbb{E}[X(t+\\tau)-X(t)\\mid X(t)=x]$。\n状态更新由下式给出：\n$$X(t+\\tau) = X(t) + K_{1} - K_{2}$$\n因此，在区间 $[t, t+\\tau]$ 内的状态变化为 $\\Delta X_{\\tau} = X(t+\\tau) - X(t) = K_{1} - K_{2}$。\n我们需要找到这个变化的期望，条件是时间 $t$ 时的状态为 $x$。\n$$ \\mathbb{E}[X(t+\\tau)-X(t)\\mid X(t)=x] = \\mathbb{E}[K_{1} - K_{2} \\mid X(t)=x] $$\n根据期望的线性性质，这变为：\n$$ \\mathbb{E}[K_{1} \\mid X(t)=x] - \\mathbb{E}[K_{2} \\mid X(t)=x] $$\n问题陈述，$K_{1}$ 和 $K_{2}$ 从其参数依赖于状态 $x$ 的泊松分布中抽取。具体来说，$K_{1} \\sim \\mathrm{Poisson}(\\lambda x \\tau)$ 和 $K_{2} \\sim \\mathrm{Poisson}(\\mu x \\tau)$。一个服从 $\\mathrm{Poisson}(\\nu)$ 分布的泊松随机变量的期望值就是 $\\nu$。\n因此，$K_{1}$ 和 $K_{2}$ 的期望值为：\n$$ \\mathbb{E}[K_{1} \\mid X(t)=x] = \\lambda x \\tau $$\n$$ \\mathbb{E}[K_{2} \\mid X(t)=x] = \\mu x \\tau $$\n将这些代入期望变化的表达式中，得到我们的第一个结果：\n$$ \\mathbb{E}[X(t+\\tau)-X(t)\\mid X(t)=x] = \\lambda x \\tau - \\mu x \\tau = (\\lambda - \\mu)x\\tau $$\n\n其次，我们计算由随机模拟算法 (SSA) 中单次事件发生引起的状态期望变化，$\\mathbb{E}[\\Delta X_{\\mathrm{SSA}}\\mid X(t)=x]$。\n在 SSA 框架中，在任何给定时间，从所有可能的反应集合中选择一个反应发生。选择特定反应 $j$ 的概率与其倾向函数 $a_j(x)$ 成正比。\n所有反应的总倾向函数是 $a_{0}(x) = \\sum_j a_j(x)$。在我们的例子中，这是：\n$$ a_{0}(x) = a_{1}(x) + a_{2}(x) = \\lambda x + \\mu x = (\\lambda + \\mu)x $$\n下一个反应是出生（反应1）的概率是：\n$$ P_{1} = \\frac{a_{1}(x)}{a_{0}(x)} = \\frac{\\lambda x}{(\\lambda + \\mu)x} = \\frac{\\lambda}{\\lambda + \\mu} $$\n对于 $x  0$，此简化是有效的。如果 $x=0$，两个倾向函数都为 $0$，没有反应发生，变化确定为 $0$。我们假设 $x0$ 继续进行。\n下一个反应是死亡（反应2）的概率是：\n$$ P_{2} = \\frac{a_{2}(x)}{a_{0}(x)} = \\frac{\\mu x}{(\\lambda + \\mu)x} = \\frac{\\mu}{\\lambda + \\mu} $$\n一个出生反应使状态变化 $\\Delta X = +1$。一个死亡反应使状态变化 $\\Delta X = -1$。\n单步 SSA 的状态期望变化 $\\mathbb{E}[\\Delta X_{\\mathrm{SSA}}\\mid X(t)=x]$ 是这两个结果的加权平均：\n$$ \\mathbb{E}[\\Delta X_{\\mathrm{SSA}}\\mid X(t)=x] = (+1) \\cdot P_{1} + (-1) \\cdot P_{2} $$\n$$ \\mathbb{E}[\\Delta X_{\\mathrm{SSA}}\\mid X(t)=x] = (1) \\left(\\frac{\\lambda}{\\lambda + \\mu}\\right) + (-1) \\left(\\frac{\\mu}{\\lambda + \\mu}\\right) = \\frac{\\lambda - \\mu}{\\lambda + \\mu} $$\n值得注意的是，对于 $x  0$，这个期望值与 $x$ 无关。\n\n最后，我们计算问题陈述中定义的比率 $R(x,\\tau,\\lambda,\\mu)$：\n$$ R(x,\\tau,\\lambda,\\mu) = \\frac{\\mathbb{E}[X(t+\\tau)-X(t)\\mid X(t)=x]}{\\mathbb{E}[\\Delta X_{\\mathrm{SSA}}\\mid X(t)=x]} $$\n代入两个推导出的表达式：\n$$ R(x,\\tau,\\lambda,\\mu) = \\frac{(\\lambda - \\mu)x\\tau}{\\frac{\\lambda - \\mu}{\\lambda + \\mu}} $$\n问题陈述 $\\lambda \\neq \\mu$，这确保了 $\\lambda - \\mu \\neq 0$。因此，我们可以安全地从分子和分母中约掉此项。\n$$ R(x,\\tau,\\lambda,\\mu) = x\\tau (\\lambda + \\mu) $$\n这是该比率的最终闭式解析表达式。", "answer": "$$\n\\boxed{(\\lambda + \\mu)x\\tau}\n$$", "id": "3350254"}, {"introduction": "tau-leaping 的有效性取决于“跳跃条件”——即在时间步长 $\\tau$ 内反应倾向性保持近似恒定的假设。本练习将通过一个动手计算任务，让您直观地看到当步长 $\\tau$ 过大、该条件被违背时会发生什么，并要求您通过精确模型与近似模型之间的偏差、总变差距离等指标来量化由此产生的近似误差。[@problem_id:3350297]", "problem": "构建一个数学上精确且可计算验证的例子，以展示在 tau-leaping 方法中采用过大的跳跃步长 $\\tau$ 会如何违反跳跃条件，并导致不准确的反应计数分布，同时量化由此产生的物种数量预期变化的偏差。请在如下定义的单反应随机化学动力学系统内完成此任务。\n\n考虑一个物种 $X$ 参与一个反应 $\\mathcal{R}_1: X \\to \\varnothing$，其速率常数为 $c \\in \\mathbb{R}_{0}$。该系统是一个由化学主方程（CME; Chemical Master Equation）描述的连续时间马尔可夫链。系统在时间 $t=0$ 时开始，初始整数数量为 $X(0) = x_0 \\in \\mathbb{Z}_{\\ge 0}$。在状态 $x$ 下，反应 $\\mathcal{R}_1$ 的倾向性函数为 $a(x) = c x$。在时间区间 $[0,\\tau]$ 内，tau-leaping 方法所依赖的跳跃条件要求倾向性函数大致保持恒定。当 $\\tau$ 过大时，此条件对于该系统会失效，因为 $a(x)$ 强烈依赖于 $x$，而 $x$ 在此区间内可能会发生显著变化。\n\n任务：\n1) 从 CME 中反应通道的指数等待时间的定义以及每个 $X$ 分子存活的独立性出发，当从 $X(0)=x_0$ 开始时，推导出在 $[0,\\tau]$ 区间内反应发生次数（死亡数）的精确有限时间分布。从该分布中，推导出区间内 $X$ 的精确预期变化，即 $X(\\tau)-X(0)$ 的期望值。\n\n2) 在基本的泊松 tau-leap 近似下，将倾向性函数在整个区间 $[0,\\tau]$ 内固定为其初始值 $a(x_0)=c x_0$，将反应发生次数建模为在 $[0,\\tau]$ 区间内具有该恒定速率的泊松随机变量，并推导出相应的反应计数近似分布以及区间内 $X$ 的近似预期变化。\n\n3) 定义以下三个定量指标来评估跳跃条件的违反情况：\n   - 物种数量预期变化的偏差，定义为 $b(x_0,c,\\tau) = \\mathbb{E}_{\\text{leap}}[X(\\tau)-X(0)] - \\mathbb{E}_{\\text{exact}}[X(\\tau)-X(0)]$。\n   - 在 $[0,\\tau]$ 区间内，精确反应计数分布与 tau-leap 反应计数分布之间的全变差距离，定义为 $d_{\\mathrm{TV}} = \\frac{1}{2}\\sum_{k=0}^{\\infty}\\lvert p_{\\text{leap}}(k)-p_{\\text{exact}}(k)\\rvert$，其中 $p_{\\text{exact}}(k)$ 和 $p_{\\text{leap}}(k)$ 分别是发生 $k$ 次反应的精确概率和 tau-leap 概率。注意，对于 $k  x_0$，$p_{\\text{exact}}(k)=0$，而 $p_{\\text{leap}}(k)$ 可能为 $kx_0$ 分配非零概率。\n   - tau-leap 无效概率质量，定义为 $q_{\\text{inv}} = \\sum_{k=x_0+1}^{\\infty} p_{\\text{leap}}(k)$，它量化了 tau-leap 分布为不可能的反应计数值 $k  x_0$ 所分配的概率。\n\n4) 实现一个程序，该程序：\n   - 仅使用从任务 1 和 2 中推导出的封闭形式的分布和期望（不要使用蒙特卡洛采样）。\n   - 对于下面测试套件中的每个参数三元组 $(x_0,c,\\tau)$，计算并返回如上定义的浮点数三元组 $(b, d_{\\mathrm{TV}}, q_{\\text{inv}})$。\n\n使用以下参数值测试套件，每个都被视为独立的测试用例：\n- 用例 1（理想情况，小步长跳跃）：$(x_0,c,\\tau) = (50, 1.0, 0.01)$。\n- 用例 2（中等步长跳跃）：$(x_0,c,\\tau) = (50, 1.0, 0.2)$。\n- 用例 3（大步长跳跃，均值等于初始数量）：$(x_0,c,\\tau) = (50, 1.0, 1.0)$。\n- 用例 4（非常大的步长跳跃）：$(x_0,c,\\tau) = (50, 1.0, 2.0)$。\n- 用例 5（小种群，刚性衰变）：$(x_0,c,\\tau) = (5, 2.0, 1.5)$。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含五个用例的所有结果，以逗号分隔的列表形式包含在方括号中，并按以下展平顺序排列：\n  $[b_1, d_{\\mathrm{TV},1}, q_{\\text{inv},1}, b_2, d_{\\mathrm{TV},2}, q_{\\text{inv},2}, \\dots, b_5, d_{\\mathrm{TV},5}, q_{\\text{inv},5}]$。\n- 每个数值必须四舍五入到 $10$ 位小数。\n- 不涉及物理单位。\n- 不适用角度。\n- 不要包含任何附加文本。\n\n问题必须使用所述定义从第一性原理解决；不要引入启发式校正（例如非负性约束或二项 tau-leaps），也不要使用基于采样的估计器。您的程序必须是自包含的，并且不得要求任何输入。每个测试用例的答案必须是一个浮点数列表，按上述规定汇总为单行输出。", "solution": "问题陈述是有效的，因为它在科学上基于随机化学动力学原理，问题设定良好，目标明确，并且没有任何事实或逻辑上的不一致。我们将首先推导精确模型和近似模型，然后用它们来计算指定的指标。\n\n所考虑的系统涉及单个化学物种 $X$ 经历单分子衰变反应 $\\mathcal{R}_1: X \\to \\varnothing$，速率常数为 $c$。系统在时间 $t=0$ 时以 $X(0) = x_0$ 个分子开始。倾向性函数给出了单位时间内发生反应的瞬时概率，其表达式为 $a(x) = c x$。\n\n**任务 1：精确分布和期望**\n\n反应 $X \\to \\varnothing$ 描述了单个分子的衰变。在这个一级过程中，$x_0$ 个分子中的每一个都独立于其他分子。任何单个 $X$ 分子的寿命都是一个速率参数为 $c$ 的指数分布随机变量。\n\n一个特定分子存活至少 $\\tau$ 时长的概率由指数分布的生存函数给出，即 $P(\\text{survival}) = e^{-c\\tau}$。因此，单个分子在时间区间 $[0, \\tau]$ 内衰变的概率是 $p = 1 - e^{-c\\tau}$。\n\n由于我们从 $x_0$ 个独立的分子开始，衰变的分子数量（我们用随机变量 $K$ 表示）是在 $x_0$ 次独立伯努利试验中“成功”（衰变）的次数，其中每次试验的成功概率是 $p$。这种情况恰好可以用二项分布来描述。因此，在 $[0, \\tau]$ 内反应发生次数 $K$ 的精确分布是：\n$$\nK \\sim \\text{Binomial}(n=x_0, p=1-e^{-c\\tau})\n$$\n$K$ 的概率质量函数（PMF），我们记作 $p_{\\text{exact}}(k)$，是：\n$$\np_{\\text{exact}}(k) = \\binom{x_0}{k} (1-e^{-c\\tau})^k (e^{-c\\tau})^{x_0-k}, \\quad \\text{对于 } k \\in \\{0, 1, \\dots, x_0\\}\n$$\n对于任何 $k  x_0$，$p_{\\text{exact}}(k) = 0$，因为反应的分子数不可能多于初始存在的分子数。\n\n在时间 $\\tau$ 的分子数是 $X(\\tau) = X(0) - K = x_0 - K$。$X$ 分子数量的预期变化是 $\\mathbb{E}_{\\text{exact}}[X(\\tau) - X(0)] = \\mathbb{E}[x_0 - K - x_0] = -\\mathbb{E}[K]$。二项随机变量 $\\text{Binomial}(n, p)$ 的期望是 $np$。因此，反应发生的精确预期次数是 $\\mathbb{E}[K] = x_0 p = x_0(1-e^{-c\\tau})$。\n\n所以，物种数量的精确预期变化是：\n$$\n\\mathbb{E}_{\\text{exact}}[X(\\tau)-X(0)] = -x_0(1-e^{-c\\tau})\n$$\n\n**任务 2：Tau-Leap 近似分布和期望**\n\n基本的 tau-leaping 方法通过假设倾向性函数在时间区间 $[0, \\tau]$（即“跳跃”区间）内保持恒定来近似真实的随机过程。倾向性函数被“冻结”在其初始值 $a(X(0)) = a(x_0) = c x_0$。\n\n在此假设下，反应过程被建模为一个具有恒定速率 $\\lambda' = c x_0$ 的齐次泊松过程。长度为 $\\tau$ 的区间内反应发生的次数，我们用 $K'$ 表示，是一个参数为 $\\lambda = \\lambda'\\tau = c x_0 \\tau$ 的泊松随机变量。\n$$\nK' \\sim \\text{Poisson}(\\lambda=c x_0 \\tau)\n$$\n反应发生次数的近似 PMF，$p_{\\text{leap}}(k)$，由下式给出：\n$$\np_{\\text{leap}}(k) = \\frac{e^{-\\lambda} \\lambda^k}{k!} = \\frac{e^{-c x_0 \\tau} (c x_0 \\tau)^k}{k!}, \\quad \\text{对于 } k \\in \\{0, 1, 2, \\dots\\}\n$$\n与精确分布不同，泊松分布在所有非负整数上都有支撑，这意味着对于所有 $k \\ge 0$，$p_{\\text{leap}}(k)  0$。\n\n物种数量的近似变化计算为 $X'(\\tau) - X(0) = -K'$。近似的预期变化是 $\\mathbb{E}_{\\text{leap}}[X(\\tau)-X(0)] = -\\mathbb{E}[K']$。参数为 $\\lambda$ 的泊松随机变量的期望是 $\\lambda$。\n\n因此，物种数量的近似预期变化是：\n$$\n\\mathbb{E}_{\\text{leap}}[X(\\tau)-X(0)] = -\\lambda = -c x_0 \\tau\n$$\n\n**任务 3：定量指标**\n\n对于较小的 $c\\tau$ 使用泰勒展开，$\\mathbb{E}_{\\text{exact}}[\\Delta X] = -x_0(1-(1-c\\tau+\\frac{(c\\tau)^2}{2}-\\dots)) = -c x_0 \\tau + \\frac{x_0(c\\tau)^2}{2} - \\dots$。tau-leap 近似匹配了一阶项但忽略了高阶项，这导致当 $\\tau$ 不小时出现差异。我们可以使用指定的指标来量化这些差异。\n\n1.  **物种数量预期变化的偏差, $b(x_0,c,\\tau)$**:\n    这是近似预期变化与精确预期变化之间的差值。\n    $$\n    b = \\mathbb{E}_{\\text{leap}}[X(\\tau)-X(0)] - \\mathbb{E}_{\\text{exact}}[X(\\tau)-X(0)] = (-c x_0 \\tau) - (-x_0(1-e^{-c\\tau})) = x_0(1 - e^{-c\\tau} - c\\tau)\n    $$\n    这个量总是非正的，表明基本的 tau-leap 方法通过忽略跳跃区间内反应物的消耗，系统地高估了衰变反应的数量。\n\n2.  **tau-leap 无效概率质量, $q_{\\text{inv}}$**:\n    该指标衡量 tau-leap 近似为物理上不可能的事件（即反应次数多于可用反应物，$k  x_0$）所分配的概率。\n    $$\n    q_{\\text{inv}} = \\sum_{k=x_0+1}^{\\infty} p_{\\text{leap}}(k)\n    $$\n    这是在 $x_0$ 处评估的泊松分布的累积分布函数（CDF）的补集。它等同于生存函数（SF）：\n    $$\n    q_{\\text{inv}} = 1 - \\sum_{k=0}^{x_0} \\frac{e^{-\\lambda} \\lambda^k}{k!} = \\text{SF}_{\\text{Poisson}}(x_0; \\lambda=c x_0 \\tau)\n    $$\n\n3.  **全变差距离, $d_{\\mathrm{TV}}$**:\n    这衡量了两个概率分布之间的总差异。\n    $$\n    d_{\\mathrm{TV}} = \\frac{1}{2}\\sum_{k=0}^{\\infty}\\lvert p_{\\text{leap}}(k)-p_{\\text{exact}}(k)\\rvert\n    $$\n    我们可以根据 $p_{\\text{exact}}$ 的支撑集来拆分求和：\n    $$\n    d_{\\mathrm{TV}} = \\frac{1}{2}\\left( \\sum_{k=0}^{x_0}\\lvert p_{\\text{leap}}(k)-p_{\\text{exact}}(k)\\rvert + \\sum_{k=x_0+1}^{\\infty}\\lvert p_{\\text{leap}}(k)-0\\rvert \\right)\n    $$\n    括号中的第二项恰好是 $q_{\\text{inv}}$。因此，我们得出一个计算上方便的公式：\n    $$\n    d_{\\mathrm{TV}} = \\frac{1}{2}\\left( \\sum_{k=0}^{x_0}\\lvert p_{\\text{leap}}(k)-p_{\\text{exact}}(k)\\rvert + q_{\\text{inv}} \\right)\n    $$\n\n**任务 4：计算实现**\n\n程序将实现上述推导出的封闭形式表达式。对于每个参数集 $(x_0, c, \\tau)$，它将：\n-   使用其解析公式计算偏差 $b$。\n-   使用泊松分布的生存函数计算无效质量 $q_{\\text{inv}}$。\n-   根据推导的公式，通过对 $k=x_0$ 为止的二项分布和泊松分布 PMF 之间的差值进行数值求和，并加上 $q_{\\text{inv}}$，来计算全变差距离 $d_{\\mathrm{TV}}$。Python 的 `scipy.stats` 库非常适合用于评估这些统计函数。\n每个测试用例的结果将按规定进行汇总和格式化。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import binom, poisson\n\ndef solve():\n    \"\"\"\n    Solves the problem by calculating the bias, total variation distance, and\n    invalid probability mass for several test cases comparing an exact\n    stochastic model with its tau-leap approximation.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (50, 1.0, 0.01),  # Case 1 (happy path, small leap)\n        (50, 1.0, 0.2),   # Case 2 (moderate leap)\n        (50, 1.0, 1.0),   # Case 3 (large leap, mean equal to initial count)\n        (50, 1.0, 2.0),   # Case 4 (very large leap)\n        (5, 2.0, 1.5),    # Case 5 (small population, stiff decay)\n    ]\n\n    all_results = []\n    \n    for x0, c, tau in test_cases:\n        # Task 1  2: Define parameters for exact and leap models\n        # Exact model: Binomial(n=x0, p=1-exp(-c*tau))\n        # The number of reactions K is Binomial.\n        # Change in X is -K.\n        exact_expected_change = -x0 * (1 - np.exp(-c * tau))\n\n        # Leap model: Poisson(lambda=c*x0*tau)\n        # The number of reactions K' is Poisson.\n        # Change in X is -K'.\n        lambda_leap = c * x0 * tau\n        leap_expected_change = -lambda_leap\n        \n        # Task 3: Calculate the metrics\n\n        # 1. Bias in expected species change, b(x0, c, tau)\n        b = leap_expected_change - exact_expected_change\n\n        # 2. Tau-leap invalidity probability mass, q_inv\n        # This is the probability that the Poisson leap model predicts\n        # more reactions than molecules available (k  x0).\n        # It's the survival function of the Poisson distribution at x0.\n        q_inv = poisson.sf(x0, lambda_leap)\n\n        # 3. Total variation distance, d_TV\n        # d_TV = 0.5 * sum(|p_leap(k) - p_exact(k)| for all k)\n        # We can split this sum:\n        # Term 1: for k from 0 to x0\n        # Term 2: for k from x0+1 to infinity. For these k, p_exact(k) = 0.\n        # Term 2 is exactly q_inv.\n        \n        k_values = np.arange(0, x0 + 1)\n        \n        # PMF for the exact distribution (Binomial)\n        p_binom = 1 - np.exp(-c * tau)\n        p_exact_k = binom.pmf(k_values, x0, p_binom)\n        \n        # PMF for the leap approximation (Poisson)\n        p_leap_k = poisson.pmf(k_values, lambda_leap)\n        \n        # Sum of absolute differences over the valid range of k for the exact model\n        sum_abs_diff = np.sum(np.abs(p_leap_k - p_exact_k))\n        \n        d_tv = 0.5 * (sum_abs_diff + q_inv)\n        \n        all_results.extend([b, d_tv, q_inv])\n\n    # Format the final output string as required\n    formatted_results = [f\"{r:.10f}\" for r in all_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n\n```", "id": "3350297"}, {"introduction": "在认识到不当选择 $\\tau$ 会导致显著误差后，我们现在转向一个实际的解决方案：自适应步长控制。这个问题要求您推导一个广泛使用的规则来自动选择 $\\tau$，通过限制物种种群数量在期望和方差上的相对变化，来确保模拟的准确性和稳定性，这是将 tau-leaping 方法应用于复杂系统的关键一步。[@problem_id:3350266]", "problem": "考虑一个具有 $d$ 个化学物种和 $M$ 个反应通道的充分混合的随机反应网络。设时间 $t$ 的系统状态为 $X(t) \\in \\mathbb{N}^d$。对于每个反应通道 $j \\in \\{1,\\dots,M\\}$，令 $\\nu_j \\in \\mathbb{Z}^d$ 表示其化学计量变化向量， $a_j(X)$ 表示其在状态 $X$ 下的倾向函数。在时间增量 $\\tau  0$ 上的 $\\tau$-跳跃近似中，以 $X(t)$ 为条件，反应 $j$ 发生的次数被建模为一个均值为 $a_j(X(t))\\,\\tau$ 的泊松随机变量，且不同反应通道的发生是相互独立的。\n\n您的任务是设计一个步长控制规则，在时间 $t$ 强制执行以下要求：对于每个物种索引 $i \\in \\{1,\\dots,d\\}$，该物种在跳跃期间的绝对变化量，在相对意义上，受限于其当前数量 $X_i(t)$ 的一个用户选择的分数 $\\delta \\in (0,1)$。仅使用泊松随机变量的基本性质以及期望和方差的线性性质，推导出一个关于 $\\tau$ 的充分条件，该条件逐分量地强制满足此要求。具体来说，从 $\\tau$-跳跃近似的定义和反应次数的独立性出发，推导出一个关于 $X(t)$、$\\delta$、倾向函数 $a_j(X(t))$ 和化学计量系数 $\\nu_{ij}$ 的最大 $\\tau$ 的显式闭式表达式，该表达式确保对于每个 $i$，物种 $i$ 的期望绝对变化和变化的方差分别受限于 $\\delta\\,X_i(t)$ 和 $\\delta^2 X_i(t)^2$。\n\n将您的最终答案表示为仅包含 $\\{a_j(X(t))\\}_{j=1}^M$ 和 $\\{\\nu_j\\}_{j=1}^M$ 的单个闭式解析表达式。除了非负性外，不要假设 $a_j$ 有任何特殊结构。您可以假设对于所有 $i \\in \\{1,\\dots,d\\}$，都有 $X_i(t)  0$。最终答案必须是单个符号表达式。无需进行数值计算。", "solution": "用户提供了一个来自随机模拟领域的有效且良态的问题陈述。任务是推导一种基于控制物种数量相对变化的 $\\tau$-跳跃方法的步长选择公式。\n\n设时间 $t$ 的系统状态为物种数量向量 $X(t) = (X_1(t), \\dots, X_d(t))$。系统通过 $M$ 个反应通道演化。对于每个反应 $j \\in \\{1, \\dots, M\\}$，我们已知其倾向函数 $a_j(X)$ 和化学计量变化向量 $\\nu_j = (\\nu_{1j}, \\dots, \\nu_{dj})^T$。\n\n在 $\\tau$-跳跃近似中，在时间间隔 $[t, t+\\tau)$ 内反应 $j$ 发生的次数（由随机变量 $K_j$ 表示）是从以状态 $X(t)$ 为条件的泊松分布中抽取的。\n$$K_j \\sim \\text{Poisson}(\\lambda_j)$$\n其中均值 $\\lambda_j = a_j(X(t))\\tau$。问题陈述指出，随机变量 $K_1, K_2, \\dots, K_M$ 是相互独立的。\n\n在时间间隔 $[t, t+\\tau)$ 内，物种 $i$ 的数量总变化（记为 $\\Delta X_i$）由所有反应通道的贡献之和给出：\n$$\\Delta X_i = \\sum_{j=1}^{M} \\nu_{ij} K_j$$\n我们的目标是找到满足以下两个条件的最大时间步长 $\\tau  0$，这两个条件适用于每个物种 $i \\in \\{1, \\dots, d\\}$，给定控制参数 $\\delta \\in (0,1)$ 并假设 $X_i(t)  0$。\n\n首先，我们计算变化量 $\\Delta X_i$ 的期望。利用期望的线性性质：\n$$E[\\Delta X_i] = E\\left[\\sum_{j=1}^{M} \\nu_{ij} K_j\\right] = \\sum_{j=1}^{M} \\nu_{ij} E[K_j]$$\n参数为 $\\lambda_j$ 的泊松随机变量 $K_j$ 的期望是 $E[K_j] = \\lambda_j = a_j(X(t))\\tau$。将此代入上式可得：\n$$E[\\Delta X_i] = \\sum_{j=1}^{M} \\nu_{ij} a_j(X(t))\\tau = \\tau \\sum_{j=1}^{M} \\nu_{ij} a_j(X(t))$$\n\n第一个条件限制了此期望变化的幅度。问题文本中的“期望绝对变化”根据标准文献和所提供的工具（期望和方差的线性性质），被解释为期望变化的绝对值：\n$$|E[\\Delta X_i]| \\le \\delta X_i(t)$$\n代入我们关于 $E[\\Delta X_i]$ 的表达式：\n$$\\left|\\tau \\sum_{j=1}^{M} \\nu_{ij} a_j(X(t))\\right| \\le \\delta X_i(t)$$\n因为 $\\tau  0$，我们有：\n$$\\tau \\left|\\sum_{j=1}^{M} \\nu_{ij} a_j(X(t))\\right| \\le \\delta X_i(t)$$\n如果项 $\\left|\\sum_{j=1}^{M} \\nu_{ij} a_j(X(t))\\right|$ 非零，我们可以分离出 $\\tau$ 来找到每个物种 $i$ 的第一个上界：\n$$\\tau \\le \\frac{\\delta X_i(t)}{\\left|\\sum_{j=1}^{M} \\nu_{ij} a_j(X(t))\\right|}$$\n如果求和项为零，则该条件对该物种 $i$ 的 $\\tau$ 不施加上界。\n\n第二，我们计算变化量 $\\Delta X_i$ 的方差。由于随机变量 $\\{K_j\\}_{j=1}^M$ 是独立的，它们的加权和的方差是它们方差的加权和：\n$$\\text{Var}(\\Delta X_i) = \\text{Var}\\left(\\sum_{j=1}^{M} \\nu_{ij} K_j\\right) = \\sum_{j=1}^{M} \\text{Var}(\\nu_{ij} K_j) = \\sum_{j=1}^{M} \\nu_{ij}^2 \\text{Var}(K_j)$$\n参数为 $\\lambda_j$ 的泊松随机变量 $K_j$ 的方差是 $\\text{Var}(K_j) = \\lambda_j = a_j(X(t))\\tau$。代入此式可得：\n$$\\text{Var}(\\Delta X_i) = \\sum_{j=1}^{M} \\nu_{ij}^2 a_j(X(t))\\tau = \\tau \\sum_{j=1}^{M} \\nu_{ij}^2 a_j(X(t))$$\n\n第二个条件限制了此方差：\n$$\\text{Var}(\\Delta X_i) \\le \\delta^2 X_i(t)^2$$\n代入我们关于 $\\text{Var}(\\Delta X_i)$ 的表达式：\n$$\\tau \\sum_{j=1}^{M} \\nu_{ij}^2 a_j(X(t)) \\le \\delta^2 X_i(t)^2$$\n项 $\\sum_{j=1}^{M} \\nu_{ij}^2 a_j(X(t))$ 是非负的，因为 $a_j(X(t)) \\ge 0$ 且 $\\nu_{ij}^2 \\ge 0$。如果这个和为正，我们可以分离出 $\\tau$ 来找到每个物种 $i$ 的第二个上界：\n$$\\tau \\le \\frac{\\delta^2 X_i(t)^2}{\\sum_{j=1}^{M} \\nu_{ij}^2 a_j(X(t))}$$\n如果求和项为零，则该条件对该物种 $i$ 的 $\\tau$ 不施加上界。\n\n为确保整个系统跳跃的稳定性和准确性，时间步长 $\\tau$ 必须对所有物种 $i \\in \\{1, \\dots, d\\}$ 满足这两个不等式。因此，$\\tau$ 必须小于或等于所有推导出的上界的最小值。$\\tau$ 的最大允许值是在所有物种和两个条件下这些界限的最小值。\n$$\\tau = \\min_{i \\in \\{1,\\dots,d\\}} \\left\\{ \\tau_{1,i}, \\tau_{2,i} \\right\\}$$\n其中 $\\tau_{1,i}$ 和 $\\tau_{2,i}$ 分别代表来自物种 $i$ 的期望和方差条件的界限。如果分母为零，相应的项不约束最小值（可以视为无穷大）。结合这些，得到允许的最大 $\\tau$ 的最终表达式：\n$$\\tau = \\min_{i \\in \\{1,\\dots,d\\}} \\left\\{ \\frac{\\delta X_i(t)}{\\left| \\sum_{j=1}^M \\nu_{ij} a_j(X(t)) \\right|}, \\frac{\\delta^2 X_i(t)^2}{\\sum_{j=1}^M \\nu_{ij}^2 a_j(X(t))} \\right\\}$$\n这个单一表达式提供了所需的关于 $\\tau$ 的充分条件。", "answer": "$$\\boxed{\\min_{i \\in \\{1,\\dots,d\\}} \\left\\{ \\frac{\\delta X_i(t)}{\\left| \\sum_{j=1}^{M} \\nu_{ij} a_j(X(t)) \\right|}, \\frac{\\delta^2 X_i(t)^2}{\\sum_{j=1}^{M} \\nu_{ij}^2 a_j(X(t))} \\right\\}}$$", "id": "3350266"}]}