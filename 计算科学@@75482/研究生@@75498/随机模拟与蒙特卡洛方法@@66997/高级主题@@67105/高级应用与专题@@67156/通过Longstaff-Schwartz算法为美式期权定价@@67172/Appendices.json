{"hands_on_practices": [{"introduction": "在深入研究基于模拟的朗斯塔夫-施瓦茨（Longstaff-Schwartz）算法之前，我们必须首先掌握其理论基础：离散时间框架下的最优停止问题。这个练习 [@problem_id:3330861] 提供了一个在简单的二叉树模型中进行具体计算的机会。通过这种方式，你可以亲手实践如何运用动态规划，在每个节点比较持有价值与立即执行价值，从而为美式期权定价，为后续更复杂的模拟方法建立坚实的直觉。", "problem": "考虑一个离散时间的、周期为$2$的单风险资产二叉树模型，时间步长$\\Delta t = 0.5$年。在时间$t = 0$时，资产价格为$S_0 = 100$。在每个时间步长内，价格或者乘以一个因子$u = 1.2$上涨，或者乘以一个因子$d = 0.85$下跌，且与过去无关。连续复利的无风险利率为每年$r = 0.05$，因此每步的总回报因子为$R = \\exp(r \\Delta t)$。令$\\mathbb{Q}$表示与无套利条件一致的唯一风险中性概率测度。\n\n令$Z_t$表示一份行权价为$K = 100$的美式看跌期权的收益过程，因此在时间$t$的立即行权收益为$Z_t = (K - S_t)_{+}$，其中$(x)_{+} = \\max\\{x, 0\\}$。定义Snell包络$Y_t$为控制贴现后收益过程的最小$\\mathbb{Q}$-上鞅，它刻画了在$t \\in \\{0, \\Delta t, 2 \\Delta t\\}$上美式期权的最优停时问题。\n\n从风险中性定价和离散时间最优停时的基本原理出发：\n- 推导刻画此美式看跌期权Snell包络的动态规划递推关系。\n- 计算$2$周期二叉树中每个节点的Snell包络的显式值。\n- 识别每个时间步的最优停时区域。\n- 最后，计算该美式看跌期权在时间$0$的价值。\n\n将最终的时间$0$期权价值表示为一个纯数字，并将您的答案四舍五入到四位有效数字。最终数值答案中不要包含任何货币符号或单位。", "solution": "该问题已经过验证。\n\n### 步骤1：提取已知条件\n- **模型**：离散时间、两期二叉树模型。\n- **资产**：单一风险资产。\n- **时间步长**：$\\Delta t = 0.5$年。\n- **初始资产价格**：$S_0 = 100$。\n- **上涨因子**：$u = 1.2$。\n- **下跌因子**：$d = 0.85$。\n- **连续复利无风险利率**：$r = 0.05$每年。\n- **每步总回报因子**：$R = \\exp(r \\Delta t)$。\n- **概率测度**：$\\mathbb{Q}$，唯一的风险中性概率测度。\n- **期权类型**：美式看跌期权。\n- **行权价**：$K = 100$。\n- **立即行权收益过程**：$Z_t = (K - S_t)_{+}$，其中$(x)_{+} = \\max\\{x, 0\\}$。\n- **Snell包络**：$Y_t$，在$t \\in \\{0, \\Delta t, 2 \\Delta t\\}$上控制贴现后收益过程的最小$\\mathbb{Q}$-上鞅。\n- **任务**：\n    1. 推导Snell包络的动态规划递推关系。\n    2. 计算每个节点的Snell包络。\n    3. 识别最优停时区域。\n    4. 计算美式看跌期权在时间$0$的价值。\n    5. 将最终答案四舍五入到四位有效数字。\n\n### 步骤2：使用提取的已知条件进行验证\n1.  **科学基础**：该问题基于二叉树期权定价模型，这是金融工程的基石，也是Black-Scholes模型的离散时间近似。所有概念（风险中性定价、Snell包络、最优停时）都是随机微积分和数理金融中的标准概念。该问题在科学上和数学上都是合理的。\n2.  **良定性**：该问题指定了构建模型和找到美式期权唯一价格所需的所有参数（$S_0, u, d, r, K, \\Delta t$以及周期数）。条件$d  \\exp(r\\Delta t)  u$成立（$0.85  \\exp(0.025) \\approx 1.0253  1.2$），这确保了唯一的风险中性概率的存在，并排除了套利机会。因此，该问题是良定的。\n3.  **客观性**：问题使用了精确、客观的数学和金融术语进行陈述。没有主观或基于观点的陈述。\n4.  **完整性与一致性**：问题是自洽的，并提供了所有必要的信息。给定数据中没有矛盾。\n\n### 步骤3：结论与行动\n该问题是**有效的**。将提供完整解答。\n\n### 解\n在离散时间设置中，美式期权的定价是一个最优停时问题。期权的价值可以通过风险中性定价和动态规划来找到。我们首先构建标的资产价格树，然后确定风险中性概率，最后从最终时间段开始逆向回推，以找到每个节点的期权价值。\n\n**1. 模型参数和风险中性概率**\n\n给定参数为：\n- 初始股价 $S_0 = 100$。\n- 上涨因子 $u = 1.2$。\n- 下跌因子 $d = 0.85$。\n- 无风险利率 $r = 0.05$ 每年。\n- 时间步长 $\\Delta t = 0.5$ 年。\n- 行权价 $K = 100$。\n- 周期数 $N=2$。时间点为 $t_0=0$，$t_1=\\Delta t = 0.5$，和 $t_2=2\\Delta t = 1.0$。\n\n股价上涨的风险中性概率 $q$ 由无套利条件确定，该条件表明资产的预期未来价格经无风险利率贴现后必须等于其当前价格。\n$$S_t = \\exp(-r \\Delta t) \\left( q S_t u + (1-q) S_t d \\right)$$\n两边同除以 $S_t$ 得：\n$$1 = \\exp(-r \\Delta t) \\left( q u + (1-q) d \\right)$$\n解出 $q$：\n$$q = \\frac{\\exp(r \\Delta t) - d}{u - d}$$\n让我们计算每步贴现因子和风险中性概率的数值。\n每步利率为 $r \\Delta t = 0.05 \\times 0.5 = 0.025$。\n每步贴现因子为 $\\exp(-r \\Delta t) = \\exp(-0.025) \\approx 0.97530991$。\n总回报因子为 $\\exp(r \\Delta t) = \\exp(0.025) \\approx 1.02531512$。\n$$q = \\frac{1.02531512 - 0.85}{1.2 - 0.85} = \\frac{0.17531512}{0.35} \\approx 0.50089949$$\n下跌的风险中性概率为 $1-q \\approx 1 - 0.50089949 = 0.49910051$。\n\n**2. 股价树**\n\n股价树演变如下：\n- 时间 $t=0$：$S_0 = 100$。\n- 时间 $t=1 (\\Delta t = 0.5)$：\n    - $S_1^u = S_0 u = 100 \\times 1.2 = 120$。\n    - $S_1^d = S_0 d = 100 \\times 0.85 = 85$。\n- 时间 $t=2 (2\\Delta t = 1.0)$：\n    - $S_2^{uu} = S_1^u u = 120 \\times 1.2 = 144$。\n    - $S_2^{ud} = S_1^u d = 120 \\times 0.85 = 102$。\n    - $S_2^{dd} = S_1^d d = 85 \\times 0.85 = 72.25$。\n\n**3. 动态规划递推和Snell包络**\n\n令 $V_t$ 为美式看跌期权在时间 $t$ 的价值。立即行权的收益为 $Z_t = (K - S_t)_{+}$。贴现后的收益过程为 $\\zeta_t = \\exp(-rt) Z_t$。问题将Snell包络 $Y_t$ 定义为控制 $\\zeta_t$ 的最小 $\\mathbb{Q}$-上鞅。对于完全市场中的离散时间模型，Snell包络由动态规划递推关系刻画：\n$$Y_T = \\zeta_T = \\exp(-rT)Z_T$$\n$$Y_t(\\omega) = \\max\\left\\{ \\zeta_t(\\omega), \\mathbb{E}^{\\mathbb{Q}}[Y_{t+\\Delta t} | \\mathcal{F}_t](\\omega) \\right\\}$$\n其中 $T=2\\Delta t$ 是最终时间，$\\mathcal{F}_t$ 是在时间 $t$ 可用的信息。\n\n未贴现的期权价格是 $V_t = Y_t \\exp(rt)$。将其代入 $Y_t$ 的递推关系，得到 $V_t$ 的递推关系：\n$$V_t \\exp(-rt) = \\max\\left\\{ Z_t \\exp(-rt), \\mathbb{E}^{\\mathbb{Q}}[V_{t+\\Delta t}\\exp(-r(t+\\Delta t)) | \\mathcal{F}_t] \\right\\}$$\n两边乘以 $\\exp(rt)$：\n$$V_t = \\max\\left\\{ Z_t, \\exp(-r\\Delta t)\\mathbb{E}^{\\mathbb{Q}}[V_{t+\\Delta t} | \\mathcal{F}_t] \\right\\}$$\n这是美式期权价格的标准递推公式。$\\exp(-r\\Delta t)\\mathbb{E}^{\\mathbb{Q}}[V_{t+\\Delta t} | \\mathcal{F}_t]$ 项是继续持有价值。我们将从时间 $t=2\\Delta t$ 开始逆向计算每个节点上 $V_t$ 的值。\n\n**4. 期权价值（$V_t$）的逆向归纳法**\n\n- **时间 $t=2 (2\\Delta t = 1.0)$**：在到期时，期权价值为其内在价值。\n    - $V_2^{uu} = (K - S_2^{uu})_{+} = (100 - 144)_{+} = 0$。\n    - $V_2^{ud} = (K - S_2^{ud})_{+} = (100 - 102)_{+} = 0$。\n    - $V_2^{dd} = (K - S_2^{dd})_{+} = (100 - 72.25)_{+} = 27.75$。\n\n- **时间 $t=1 (\\Delta t = 0.5)$**：在每个节点，我们将立即行权价值与继续持有价值进行比较。\n    - **节点 u ($S_1^u = 120$)**：\n        - 立即行权价值：$E_1^u = (100 - 120)_{+} = 0$。\n        - 继续持有价值：$C_1^u = \\exp(-r\\Delta t)[q V_2^{uu} + (1-q) V_2^{ud}] = \\exp(-0.025)[q \\cdot 0 + (1-q) \\cdot 0] = 0$。\n        - 期权价值：$V_1^u = \\max\\{E_1^u, C_1^u\\} = \\max\\{0, 0\\} = 0$。\n    - **节点 d ($S_1^d = 85$)**：\n        - 立即行权价值：$E_1^d = (100 - 85)_{+} = 15$。\n        - 继续持有价值：$C_1^d = \\exp(-r\\Delta t)[q V_2^{ud} + (1-q) V_2^{dd}] = \\exp(-0.025)[q \\cdot 0 + (1-q) \\cdot 27.75]$。\n        - $C_1^d \\approx 0.97530991 \\times [0.49910051 \\times 27.75] \\approx 0.97530991 \\times 13.849989 \\approx 13.50722$。\n        - 期权价值：$V_1^d = \\max\\{E_1^d, C_1^d\\} = \\max\\{15, 13.50722\\} = 15$。\n\n- **时间 $t=0 (S_0 = 100)$**：\n    - 立即行权价值：$E_0 = (100 - 100)_{+} = 0$。\n    - 继续持有价值：$C_0 = \\exp(-r\\Delta t)[q V_1^u + (1-q) V_1^d] = \\exp(-0.025)[q \\cdot 0 + (1-q) \\cdot 15]$。\n    - $C_0 \\approx 0.97530991 \\times [0.49910051 \\times 15] \\approx 0.97530991 \\times 7.48650765 \\approx 7.30155$。\n    - 期权价值：$V_0 = \\max\\{E_0, C_0\\} = \\max\\{0, 7.30155\\} = 7.30155$。\n\n美式看跌期权在时间0的价值是 $V_0 \\approx 7.30155$。\n\n**5. 每个节点的Snell包络（$Y_t$）**\n\nSnell包络是贴现后的期权价格：$Y_t = V_t \\exp(-rt)$。\n- **时间 $t=2 (t=1.0)$**：$r t = 0.05 \\times 1.0 = 0.05$。$\\exp(-0.05) \\approx 0.95122942$。\n    - $Y_2^{uu} = V_2^{uu} \\exp(-0.05) = 0$。\n    - $Y_2^{ud} = V_2^{ud} \\exp(-0.05) = 0$。\n    - $Y_2^{dd} = V_2^{dd} \\exp(-0.05) = 27.75 \\times \\exp(-0.05) \\approx 26.3964$。\n- **时间 $t=1 (t=0.5)$**：$r t = 0.05 \\times 0.5 = 0.025$。$\\exp(-0.025) \\approx 0.97530991$。\n    - $Y_1^u = V_1^u \\exp(-0.025) = 0 \\times \\exp(-0.025) = 0$。\n    - $Y_1^d = V_1^d \\exp(-0.025) = 15 \\times \\exp(-0.025) \\approx 14.6296$。\n- **时间 $t=0 (t=0)$**：$r t = 0$。$\\exp(0) = 1$。\n    - $Y_0 = V_0 \\exp(0) = V_0 \\approx 7.30155$。\n\n**6. 最优停时区域**\n\n最优停时（行权）区域是状态$(t, S_t)$的集合，其中期权价值等于立即行权收益，即$V_t(S_t) = (K - S_t)_{+}$。这发生在立即行权价值大于或等于继续持有价值时。\n- 在 $t=1 (\\Delta t = 0.5)$：\n    - 在节点 u ($S_1^u=120$)：$V_1^u=0$ 且 $E_1^u=0$。我们选择持有（或无差异）。\n    - 在节点 d ($S_1^d=85$)：$V_1^d=15$ 且 $E_1^d=15$。因为 $E_1^d > C_1^d$，所以最优选择是行权。因此，$(\\Delta t, 85)$ 在停时区域内。\n- 在 $t=2 (2\\Delta t = 1.0)$：\n    - 如果期权是价内期权，行权总是最优的。\n    - 在节点 dd ($S_2^{dd}=72.25$)：$V_2^{dd} = 27.75 > 0$。最优选择是行权。因此，$(2\\Delta t, 72.25)$ 在停时区域内。\n    - 在节点 uu 和 ud，期权是价外期权，所以不行权。\n\n最优停时区域由节点 $\\{(\\Delta t, S_t=85), (2\\Delta t, S_t=72.25)\\}$ 组成。\n\n**7. 最终答案**\n\n美式看跌期权在时间$0$的价值是 $V_0$。\n$$V_0 \\approx 7.30155$$\n四舍五入到四位有效数字，该值为$7.302$。", "answer": "$$\\boxed{7.302}$$", "id": "3330861"}, {"introduction": "从离散模型过渡到朗斯塔夫-施瓦茨算法时，我们会遇到许多实际执行中的细节问题。该算法的核心是将未来收益对基函数进行回归，但一个常见的实践做法是仅对价内（in-the-money）路径进行回归。本练习 [@problem_id:3330849] 引导我们深入探讨这一常用技巧，审视其理论合理性以及可能引入的偏差，这对于从一个初步的实现方案走向一个更稳健、更精确的模型至关重要。", "problem": "考虑一份执行价为 $K$ 的百慕大看跌期权，其标的为单一风险资产，其价格过程 $\\{S_t\\}_{t \\ge 0}$ 在风险中性测度 $\\mathbb{Q}$ 下根据随机微分方程 $dS_t = r S_t \\, dt + \\sigma S_t \\, dW_t$ 演化，其中 $r  0$ 是恒定短期利率，$\\sigma  0$ 是恒定波动率，$\\{W_t\\}_{t \\ge 0}$ 是标准布朗运动。该期权可以在离散日期 $0  t_1  t_2  \\cdots  t_m = T$ 执行，其贴现支付过程为 $B_t h(S_t)$，其中 $B_t = e^{-r t}$ 且 $h(s) = (K - s)_+$。令 $\\mathcal{F}_t$ 表示由 $\\{S_u\\}_{u \\le t}$ 生成的信息流。百慕大期权价值过程 $\\{V_{t_i}\\}$ 是在 $\\mathbb{Q}$ 下的 Snell 包络，由 $V_{t_i} = \\operatorname{ess\\,sup}_{\\tau \\in \\mathcal{T}_{t_i}} \\mathbb{E}^{\\mathbb{Q}}\\!\\left[ e^{-r(\\tau - t_i)} h(S_\\tau) \\mid \\mathcal{F}_{t_i} \\right]$ 给出，其中 $\\mathcal{T}_{t_i}$ 是取值于 $\\{t_i, \\ldots, t_m\\}$ 的停时集合。\n\n为这类美式期权类金融产品定价的一种广泛使用的基于模拟的方法是 Longstaff–Schwartz (LS) 算法，该算法通过将模拟的未来贴现现金流对当前状态的一组基函数进行回归，来估计每个执行日期的条件持有价值。一个常见的实践选择是在日期 $t_i$ 将回归限制在那些在 $t_i$ 时刻处于价内 (in-the-money) 的模拟路径上，即那些满足 $h(S_{t_i})  0$ 的路径。\n\n选择所有关于在 Longstaff–Schwartz 算法中将回归限制在价内路径上的做法的正确陈述，为其可采纳性提供形式化的理由，并识别出这种做法可能引入偏差的情景。\n\nA. 对于任何日期 $t_i$ 和任何满足 $h(S_{t_i}) = 0$ 的状态，最优策略是持有，因为持有价值几乎必然是非负的；因此，在此类状态下的执行决策是平凡的，不需要在此处估计持有价值。在此非负性和 $\\{S_t\\}$ 的马尔可夫性质下，将回归限制在价内区域 $\\mathcal{I}_{t_i} = \\{ s : h(s)  0 \\}$ 是可采纳的，因为它不影响价外状态下的停止决策。\n\nB. 假设在日期 $t_i$，我们将从 $t_{i+1}, \\ldots, t_m$ 通过后向归纳法定义的贴现未来现金流 $Y_{t_i}$ 对基函数 $\\{\\phi_j\\}_{j=1}^p$ 进行回归，仅使用满足 $S_{t_i} \\in \\mathcal{I}_{t_i}$ 的模拟路径。如果状态在 $\\mathbb{Q}$ 下是马尔可夫的，$Y_{t_i}$ 是平方可积的，并且 $\\{\\phi_j\\}$ 的张成空间在 $L^2(\\mu_{t_i})$ 中是稠密的（其中 $\\mu_{t_i}$ 是 $S_{t_i}$ 在条件 $S_{t_i} \\in \\mathcal{I}_{t_i}$ 下的分布），那么当路径数 $N \\to \\infty$ 且基维度 $p \\to \\infty$（以适当方式）时，限制在 $\\mathcal{I}_{t_i}$ 上的最小二乘估计量对于持有价值 $\\mathbb{E}^{\\mathbb{Q}}[Y_{t_i} \\mid S_{t_i} = s]$（对于 $s \\in \\mathcal{I}_{t_i}$）是一致的。\n\nC. 将回归限制在价内路径上不会在估计的百慕大期权价格中引入偏差，因为无论回归设计如何，Longstaff–Schwartz 估计量都是真实价格的无偏估计量。\n\nD. 如果条件设计在 $t_i$ 的最优执行边界附近放置的概率质量非常小，从而导致在深度价内状态上训练的回归模型外推到边界，那么将回归限制在价内路径上可能会引入偏差。使用全局多项式基时，这可能会在边界附近引发对执行/持有决策的系统性错误分类，由于过早执行而趋向于一个向下偏倚的价格。\n\nE. 在多维马尔可夫设置中（例如，在随机波动率情况下，状态为 $(S_{t_i}, V_{t_i})$），在 $t_i$ 时刻限制在价内路径上会改变回归量的联合设计分布。如果基函数是在 $(S_{t_i}, V_{t_i})$ 的无条件分布下选择为正交的，那么在给定 $h(S_{t_i})  0$ 的条件下，这种正交性会丧失，这会恶化数值条件并增加有限样本投影误差，从而在价格估计中引入偏差。\n\n选择所有适用项。", "solution": "用户希望分析在 Longstaff-Schwartz (LS) 算法中将回归限制在价内路径上的做法。\n\n首先，我将验证问题陈述。\n\n### 步骤 1：提取已知条件\n-   资产价格过程：$\\{S_t\\}_{t \\ge 0}$，在风险中性测度 $\\mathbb{Q}$ 下。\n-   随机微分方程 (SDE)：$dS_t = r S_t \\, dt + \\sigma S_t \\, dW_t$。\n-   参数：$r  0$（恒定短期利率），$\\sigma  0$（恒定波动率）。\n-   随机驱动：$\\{W_t\\}_{t \\ge 0}$ 是标准布朗运动。\n-   期权类型：执行价为 $K$ 的百慕大看跌期权。\n-   执行日期：$0  t_1  t_2  \\cdots  t_m = T$。\n-   贴现支付过程：$B_t h(S_t)$，其中 $B_t = e^{-r t}$ 且 $h(s) = (K - s)_+ = \\max(K-s, 0)$。\n-   信息流：$\\mathcal{F}_t$ 表示由 $\\{S_u\\}_{u \\le t}$ 生成的信息流。\n-   百慕大价值过程：$\\{V_{t_i}\\}$ 是在 $\\mathbb{Q}$ 下的 Snell 包络，由 $V_{t_i} = \\operatorname{ess\\,sup}_{\\tau \\in \\mathcal{T}_{t_i}} \\mathbb{E}^{\\mathbb{Q}}\\!\\left[ e^{-r(\\tau - t_i)} h(S_\\tau) \\mid \\mathcal{F}_{t_i} \\right]$ 给出。\n-   停时集合：$\\mathcal{T}_{t_i}$ 是取值于 $\\{t_i, \\ldots, t_m\\}$ 的停时集合。\n-   算法背景：使用 Longstaff-Schwartz (LS) 算法进行定价。\n-   所考虑的做法：在每个执行日期 $t_i$，用于估计持有价值的回归被限制在价内的模拟路径上，即那些满足 $h(S_{t_i})  0$ 的路径。\n\n### 步骤 2：使用提取的已知条件进行验证\n-   **科学依据**：该问题在标准的 Black-Scholes-Merton 期权定价框架下表述。Longstaff-Schwartz 算法是通过蒙特卡洛模拟为美式期权定价的规范且被广泛研究的方法。所有概念和术语在量化金融中都是标准的。该问题在科学上和数学上都是合理的。\n-   **适定性**：该问题要求评估关于 LS 算法特定实现细节的几个技术性陈述的正确性。设置清晰，陈述可以被形式化地分析。进行有意义且独特的分析是可能的。\n-   **客观性**：语言精确且技术性强。待评估的陈述是关于数值算法属性的客观主张，不含主观内容。\n\n问题陈述没有明显的缺陷。它不是不健全、不完整、模棱两可或微不足道的。它是计算金融领域中一个有效且适定的问题。\n\n### 步骤 3：结论与行动\n问题陈述是有效的。我将继续进行详细的解答并评估每个选项。\n\n### 基于原理的推导与分析\n\nLongstaff-Schwartz 算法通过后向归纳法工作。在每个执行时间 $t_i$（对于 $i = m-1, m-2, \\ldots, 1$），它估计持有价值，即持有期权而非执行它的价值。在时间 $t_i$、资产价格为 $S_{t_i} = s$ 时的持有价值由下式给出：\n$$\nC(s) = \\mathbb{E}^{\\mathbb{Q}}\\!\\left[ e^{-r(t_{i+1}-t_i)} V_{t_{i+1}} \\mid S_{t_i} = s \\right]\n$$\n其中 $V_{t_{i+1}}$ 是在下一个执行日期的期权价值，由所有后续日期的最优策略决定。LS 算法通过将模拟的未来贴现支付对当前状态 $s$ 的一组基函数进行回归来近似 $C(s)$。\n\n在时间 $t_i$ 的最优停止法则是，如果立即支付 $h(s) = (K-s)_+$ 大于持有价值 $C(s)$，则执行。LS 算法实现了该法则的一个估计版本：如果 $h(s)  \\widehat{C}(s)$ 则执行，其中 $\\widehat{C}(s)$ 是基于回归的 $C(s)$ 的估计值。\n\n问题的核心是仅使用那些在时间 $t_i$ 期权处于“价内”（ITM）的模拟路径来执行此回归的做法，即 $S_{t_i}  K$ 的路径，这意味着 $h(S_{t_i})  0$。\n\n### 逐项分析\n\n**A. 对于任何日期 $t_i$ 和任何满足 $h(S_{t_i}) = 0$ 的状态，...**\n\n让我们分析这个陈述。\n-   $h(S_{t_i}) = 0$ 的状态对应于 $S_{t_i} \\ge K$。对于看跌期权，这是一个“价外”（OTM）或“平价”状态。立即执行的支付为 $h(S_{t_i}) = 0$。\n-   持有价值 $C(s)$ 是未来贴现支付 $e^{-r(\\tau - t_i)} h(S_\\tau)$ 的期望。由于支付函数 $h(s) = (K-s)_+$ 是非负的，所以持有价值也是非负的，$C(s) \\ge 0$。\n-   因为波动率 $\\sigma  0$，股票价格 $S_t$ 在未来某个时间 $\\tau \\in \\{t_{i+1}, \\ldots, t_m\\}$ 跌破执行价 $K$ 的概率非零。因此，对于任何有限状态 $s$，持有价值 $C(s)$ 都是严格为正的。\n-   因此，对于任何满足 $h(s) = 0$ 的状态 $s$，比较的是立即支付 0 和一个正的持有价值 $C(s)  0$。最优决策总是持有，因为 $h(s)  C(s)$。\n-   这意味着对于价外状态的执行决策是平凡的，不依赖于 $C(s)$ 的具体值，只要它是正的。唯一不平凡的决策发生在价内状态，此时 $h(s)  0$，我们需要比较 $h(s)$ 和 $C(s)$。\n-   因此，没有必要为价外状态精确估计持有价值函数。将回归限制在价内路径上，即在需要进行估计以做出决策的地方，因此是一种可采纳的简化。它正确地指出，建模工作应集中在状态空间中那些最优策略不明显的区域。\n\n该陈述是为什么可以考虑将回归限制在价内路径上的一个正确理由。\n\n**结论：正确。**\n\n**B. 假设在日期 $t_i$，我们将从 $t_{i+1}, \\ldots, t_m$ 通过后向归纳法定义的贴现未来现金流 ...**\n\n该陈述解决了在受限域上进行回归的理论有效性问题。\n-   LS 算法使用最小二乘投影到由基函数 $\\{\\phi_j\\}$ 张成的线性空间上来近似条件期望 $f(s) = \\mathbb{E}^{\\mathbb{Q}}[Y \\mid X=s]$。这里，$X=S_{t_i}$，$Y$ 是贴现未来现金流。\n-   此类非参数回归估计量的一致性是统计理论中的一个标准结果。在 $L^2$ 意义下一致性的关键条件是：\n    1.  数据点 $(X_k, Y_k)$ 是独立同分布的（或满足较弱的依赖条件），其中 $X$ 从某个分布 $\\mu$ 中抽取。此处数据点是从条件分布 $\\mu_{t_i}$ 中抽取的独立同分布样本。\n    2.  条件期望函数 $f(s) = \\mathbb{E}[Y \\mid X=s]$ 属于 $L^2(\\mu)$。这由 $Y_{t_i}$ 是平方可积的假设来保证。\n    3.  选择的基函数 $\\{\\phi_j\\}$ 使得它们的张成空间在 $L^2(\\mu)$ 中是稠密的。这意味着 $L^2(\\mu)$ 中的任何函数都可以通过基函数的线性组合被任意好地近似。标准选择如多项式或样条函数在紧致域上满足此条件。\n-   在这些条件下，当样本数 $N \\to \\infty$ 且基函数数量 $p \\to \\infty$（且 $p/N \\to 0$ 以控制方差）时，最小二乘估计量 $\\widehat{f}_p(s)$ 在 $L^2(\\mu)$ 范数下收敛于真实函数 $f(s)$。\n-   该陈述在受限回归的背景下正确地列出了这些标准条件。它提供了理论保证，即在渐近情况下，在价内区域上的回归可以一致地估计该区域上的真实持有价值函数。\n\n该陈述是将非参数回归理论正确应用于 LS 算法。\n\n**结论：正确。**\n\n**C. 将回归限制在价内路径上不会在估计的百慕大期权价格中引入偏差 ...**\n\n这个陈述提出了两个强烈的断言，两者都是错误的。\n1.  **“Longstaff–Schwartz 估计量是无偏估计量”**：已知 LS 价格估计量是有偏的。具体来说，它提供了一个向下偏倚的真实期权价格估计。原因在于该算法使用一个估计的持有价值 $\\widehat{C}(s)$ 来定义一个估计的停止法则 $\\hat{\\tau}$。与使用真实持有价值 $C(s)$ 的真实最优停止法则 $\\tau^*$ 相比，这个法则通常是次优的。根据定义，任何次优执行策略的价值都小于或等于最优策略的价值。因此，价格估计量的期望值小于或等于真实价格：$\\mathbb{E}[\\hat{V}_0] \\le V_0$。偏差是非正的。\n2.  **“无论回归设计如何”**：LS 估计量的偏差和方差高度依赖于回归设计。这包括基函数的选择、基函数的数量、模拟路径的数量，以及如其他选项所讨论的，回归的定义域。一个糟糕的设计（例如，选择不当的基函数）可能导致在估计 $C(s)$ 时产生较大的投影误差，这反过来又会导致一个更次优的执行策略和最终价格估计中更大的（向下）偏差。\n\n由于 LS 估计量是无偏的这一前提从根本上是错误的，整个陈述都是有缺陷的。\n\n**结论：不正确。**\n\n**D. 如果条件设计在 $t_i$ 的最优执行边界附近放置的概率质量非常小...**\n\n该陈述强调了价内限制的一个关键实践陷阱。\n-   状态空间中最关键的部分是围绕最优执行边界的区域，在该区域 $h(s) \\approx C(s)$。在此区域内估计 $C(s)$ 的一个小误差就可能将决策从“持有”翻转为“执行”，反之亦然。\n-   如果回归仅在价内路径上执行，并且在时间 $t_i$ 的模拟路径碰巧集中在“深度”价内（即 $S_{t_i}$ 远小于 $K$），那么在执行边界附近的数据点就会很少。\n-   当使用全局基函数，如在整个价内域上的单个多项式时，拟合由整个数据集决定。函数在数据密集的区域（深度价内）拟合得很好，但可能在数据稀疏的区域（边界附近）外推得很差。这是函数逼近中一个众所周知的问题。\n-   如果这种外推导致边界附近的持有价值被系统性地低估（即 $\\widehat{C}(s)  C(s)$），那么算法将在某些最优决策是持有（$C(s) > h(s)$）的状态下决定执行（$\\widehat{C}(s)  h(s)$）。这就是过早执行。\n-   如前所述，使用像过早执行这样的次优策略会导致较低的期望值。这导致了估计期权价格的向下偏差。\n\n所描述的机制是 LS 算法中一个有效且重要的偏差来源，并且它因限制回归的做法而加剧。\n\n**结论：正确。**\n\n**E. 在多维马尔可夫设置中 ...**\n\n该陈述分析了在多维设置下价内限制的含义。\n-   考虑一个状态向量 $(S_t, v_t)$，其中 $v_t$ 是像波动率一样的随机因子。基函数现在是两个变量的函数，例如 $\\phi_j(s, v)$。\n-   一种复杂的基函数选择方法是选择一个相对于时间 $t_i$ 状态变量的无条件联合分布是正交的集合。正交性是理想的，因为它能在最小二乘问题中得到一个对角（或近对角）的格兰姆矩阵 $X^T X$，这使得系数的估计在数值上稳定且高效。\n-   价内限制 $h(S_{t_i})  0$ 或 $S_{t_i}  K$ 仅对状态向量的一个分量施加条件。现在回归是使用来自 $(S_{t_i}, v_{t_i})$ 在给定 $S_{t_i}  K$ 条件下的条件分布的样本执行的。\n-   正交性是一个在特定域上具有特定权重测度（概率密度）的积分属性。如果我们改变积分域（从所有可能的 $s$ 值到 $s  K$）或权重测度（从无条件密度到条件密度），正交性通常会被破坏。也就是说，对于 $j \\neq k$，$\\mathbb{E}[\\phi_j \\phi_k \\mid S_{t_i}  K] \\neq 0$。\n-   失去正交性意味着回归量变得相关，格兰姆矩阵可能变得病态（具有大的条件数）。这使得最小二乘解对小扰动敏感，增加了估计系数的方差，从而增加了估计的持有价值函数 $\\widehat{C}(s,v)$ 的总体有限样本误差。\n-   $\\widehat{C}$ 中增加的误差导致了不太准确的执行策略，结果是最终价格估计中更大的偏差。\n\n该陈述正确地识别出了在多维背景下限制回归域所产生的一个微妙但重要的技术问题。\n\n**结论：正确。**", "answer": "$$\\boxed{ABDE}$$", "id": "3330849"}, {"introduction": "掌握了算法的核心逻辑与细微之处后，最后一步是考虑其在需要大规模计算的真实场景中的应用，这必然要求并行计算。本练习 [@problem_id:3330830] 关注于并行环境中随机数生成的关键挑战——一个虽常被忽视但至关重要的问题。它探讨了如何设计方案以确保模拟结果不仅在统计上有效（各随机数流相互独立），而且还能完全复现，这是可靠科学计算的基石。", "problem": "考虑在风险中性几何布朗运动模型下，使用 Longstaff–Schwartz 最小二乘回归算法对单一资产上的美式看跌期权进行定价。风险中性动态由随机微分方程 $dS_t = r S_t \\, dt + \\sigma S_t \\, dW_t$ 给出，其中 $S_t$ 表示在时间 $t$ 的资产价格，$r$ 是无风险利率，$\\sigma$ 是波动率，$W_t$ 是在风险中性测度下的标准布朗运动。在模拟中，通常使用 Euler–Maruyama 对数离散化：对于时间步长 $\\Delta t$，资产路径更新为 $S_{t+\\Delta t} = S_t \\exp\\left((r - \\tfrac{1}{2}\\sigma^2)\\Delta t + \\sigma \\sqrt{\\Delta t} Z\\right)$，其中 $Z$ 是一个标准正态随机变量，通过诸如逆累积分布函数法等变换从均匀分布随机变量中派生而来。\n\n在 Longstaff–Schwartz 算法中，在每个行权日 $t_k$（索引 $k \\in \\{1,\\dots,K\\}$），通过仅使用价内路径，将已实现的贴现现金流对 $S_{t_k}$ 的基函数进行回归，来估计继续价值。为了使回归是一致的，并使蒙特卡洛估计量在极限情况下是无偏的，模拟的路径必须具有与布朗运动一致的独立增量，并且各路径之间必须统计独立。在 $P$ 个工作单元上进行并行模拟时，我们需要一种随机数生成的设计，以同时确保两个属性：\n\n(i) 分配给不同路径或工作单元的随机数流之间没有重叠且互相关可忽略，从而使蒙特卡洛误差分析中使用的独立性假设是合理的。\n\n(ii) 跨次运行的可复现性，无论操作系统调度顺序如何，并且理想情况下对 $P$（工作单元数量）的变化保持不变，从而使数值结果仅取决于全局种子以及从路径索引和时间步到随机输入的算法映射，而不是运行时的交错执行。\n\n伪随机数生成器 (PRNG) 定义为一个确定性状态递归 $x_{n+1} = f(x_n)$，其输出为 $u_n = g(x_n)$，其中 $u_n \\in (0,1)$ 是均匀分布随机变量。对于线性递归，例如线性同余生成器和多重递归生成器，存在闭式“向前跳转”映射 $x_{n+\\ell} = f^{(\\ell)}(x_n)$，这使得能够将长周期划分为不相交的连续子流。对于基于计数器的生成器，输出是多索引计数器和密钥的确定性函数，$u_{j,k} = h(\\text{key}, \\text{counter}(j,k))$，这消除了状态，并允许随机变量按路径和时间直接索引。\n\n假设您模拟 $N$ 条路径和 $K$ 个行权日，并且每个路径在每个行权日需要 $L$ 个均匀分布随机变量来构建上述更新所需的正态增量 $Z$。请考虑在并行的 Longstaff–Schwartz 实现中分配随机数流的以下设计方案：\n\nA. 使用单个全局种子和单个共享的 PRNG 实例。每个工作单元通过线程安全接口根据需要从这个全局流中提取随机数，因此总序列是连续的，工作单元根据运行时调度交错提取。声称具有可复现性，因为 PRNG 和种子是固定的。\n\nB. 使用带有已知“向前跳转”矩阵的多重递归生成器 (MRG) 来实现子流。固定一个全局种子 $x_0$。对于路径索引 $j \\in \\{0,\\dots,N-1\\}$，分配从位置 $j \\cdot (K L)$ 开始的子流，即路径 $j$ 的第一个随机变量使用 $x_{j\\cdot (KL)}$，并且该路径为其完整轨迹恰好消耗 $K L$ 个随机变量。路径是独立的，因为子流是不相交的；可复现性成立，因为映射仅取决于 $j$、$K$ 和 $L$。\n\nC. 在单个 PRNG 流上使用跨步法：对于固定数量的工作单元 $P$，工作单元 $i \\in \\{0,\\dots,P-1\\}$ 取用索引为 $n$ 的输出，其中 $n \\equiv i \\pmod{P}$。这保证了在固定的 $P$ 下，流之间不重叠且工作单元之间相互独立，并且由于 PRNG 和种子是固定的，因此具有可复现性。\n\nD. 在一个广泛使用的 PRNG（例如，周期约为 $2^{19937}-1$ 的 Mersenne Twister）上，为每个工作单元 $i$ 设置种子 $s+i$。允许每个工作单元独立生成自己的流，并假定凭借不同的种子即可实现独立性和可复现性。\n\nE. 使用基于计数器的 PRNG，例如 Philox 或 Threefry。固定一个全局密钥 $k_{\\text{global}}$。定义一个从元组 $(j,k,\\ell)$ 到计数器值的确定性映射，其中 $j$ 是路径索引，$k$ 是行权日索引，$\\ell \\in \\{0,\\dots,L-1\\}$ 枚举该路径在该时间点消耗的均匀分布随机变量。生成 $u_{j,k,\\ell} = h(k_{\\text{global}}, \\text{counter}(j,k,\\ell))$，并从这些 $u_{j,k,\\ell}$ 构建 $Z$。不为线程分配任何状态，并让任何工作单元按需生成任何 $(j,k,\\ell)$。独立性成立，因为不同的计数器映射到具有良好统计特性的不同输出；可复现性成立，因为输出仅取决于 $(j,k,\\ell)$ 和 $k_{\\text{global}}$，而不取决于执行顺序。\n\n哪些选项能够正确地同时确保流的独立性（在蒙特卡洛意义上，即跨路径和工作单元的随机变量集不重叠、低相关）和强意义上的跨次运行可复现性（即对于固定的 $(N,K,L)$ 和全局种子，数值结果对 $P$ 和线程调度的变化保持不变）？选择所有适用的选项。", "solution": "问题陈述描述了计算金融中的一个标准场景：在并行计算架构上使用 Longstaff-Schwartz 蒙特卡洛算法为美式期权定价。阐述的核心挑战是设计一个并行随机数生成 (PRNG) 方案，该方案能满足两个关键属性：(i) 随机数流的统计独立性；(ii) 结果的强可复现性，即对运行时调度和并行工作单元数量 ($P$) 均保持不变。\n\n问题陈述在科学上和数学上都是合理的。关于几何布朗运动模型、其对数离散化、Longstaff-Schwartz 算法以及各种 PRNG 架构（基于流的向前跳转、跨步法、基于计数器）的描述，都与随机模拟和计算机科学中的既有理论和实践相一致。对有效并行模拟的要求被正确地识别出来。该问题是适定的、完整的，并就不同设计的适用性提出了一个精确的问题。因此，有必要进行全面分析。\n\n我们将根据所述的两个标准来评估所提出的五种设计方案：\n(i) **独立性**：用于不同模拟路径的随机变量必须统计独立，这通常通过确保随机变量集不相交并且来自具有良好高维均匀性的生成器来实现。\n(ii) **强可复现性**：对于相同的初始种子，最终的数值结果必须完全相同，无论工作单元的数量 ($P$) 或这些工作单元之间计算的非确定性调度如何。\n\n**选项A：单个共享的PRNG**\n\n该设计涉及单个 PRNG 流，所有工作单元都通过线程安全机制按需从中提取数字，以防止竞争条件。\n\n-   **独立性**：虽然所有随机数都源自一个（假定高质量的）顺序流，但它们分配给特定路径和时间步是非确定性的。假设均匀分布随机变量的全局流为 $u_0, u_1, u_2, \\dots$。在一次运行中，路径 $j=0$ 的第一个随机变量可能是 $u_m$。在另一次运行中，由于线程调度不同，它可能是 $u_n$，其中 $n \\neq m$。用于构建给定路径的随机变量集合不是固定的。这使得统计分析变得复杂，但更关键的失败在于可复现性。\n-   **可复现性**：该设计在可复现性要求上灾难性地失败了。由操作系统调度程序控制的不同工作单元请求的非确定性交错，意味着随机数到模拟路径的映射将因每次运行而异。因此，即使使用相同的全局种子，单个路径的轨迹和最终汇总的期权价格也将是不可复现的。它也未能满足强可复现性，因为改变 $P$ 会改变调度动态，从而改变结果。\n\n**A 的结论**：**不正确**。此方法不可复现。\n\n**选项B：带有向前跳转的MRG子流**\n\n此设计将单个长 PRNG 周期划分为不相交的连续块（子流）。对于需要 $N$ 条路径、每条路径需要 $K \\cdot L$ 个随机变量的模拟，路径 $j$ 被分配从虚拟全局流中索引 $j \\cdot K \\cdot L$ 开始的随机变量块。这是通过“向前跳转”函数实现的，该函数可以高效地计算与任意未来步骤对应的 PRNG 状态。\n\n-   **独立性**：由于不同路径的子流是主序列的不相交块，因此使用的随机数没有重叠。对于像 MRG 这样具有足够长周期和良好统计特性的生成器，这些子流被认为具有很高的统计质量，并且在蒙特卡洛模拟中可以被视为相互独立的。这是一种标准的、有理论支持的实现流独立性的方法。\n-   **可复现性**：随机数子流到路径的分配是确定性的。路径 $j$ 的随机数完全由其索引 $j$、固定参数 $K$ 和 $L$ 以及全局种子决定。这种映射完全独立于工作单元的数量 $P$ 和运行时调度。任何负责计算路径 $j$ 的工作单元都将使用完全相同的随机数序列，确保模拟是完全可复现的，并且对 $P$ 的变化保持不变。\n\n**B 的结论**：**正确**。此方法同时满足独立性和强可复现性。\n\n**选项C：在单个 PRNG 流上使用跨步法**\n\n在此设计中，全局流 $u_0, u_1, u_2, \\dots$ 通过步幅在 $P$ 个工作单元之间进行划分。工作单元 $i$ 接收索引为 $n$ 且满足 $n \\equiv i \\pmod{P}$ 的随机变量子序列。\n\n-   **独立性**：流是不相交的。然而，跨步流的统计质量可能很差。对于某些 PRNG，特别是线性同余生成器 (LCG)，这些跨步子序列可能高度相关。虽然对于更复杂的生成器来说，这个问题可能不那么严重，但与使用子流（选项 B）相比，它通常被认为是一种确保独立性的不够稳健的方法。\n-   **可复现性**：此方法不满足强可复现性标准。工作单元生成的随机数序列取决于其索引 $i$ 和工作单元总数 $P$。如果模拟以 $P$ 个工作单元运行，路径计算将使用来自这 $P$ 个交错流的数字。如果将工作单元数量更改为 $P'$，流的定义本身就会改变。例如，使用 $P=4$ 时工作单元 $i=0$ 的流（即 $u_0, u_4, u_8, \\dots$）计算的路径，将使用一组与使用 $P=8$（此时工作单元 $i=0$ 得到 $u_0, u_8, u_{16}, \\dots$）计算时不同的随机数。因此，结果依赖于 $P$。\n\n**C 的结论**：**不正确**。此方法的可复现性无法对工作单元数量 $P$ 保持不变。\n\n**选项D：用 `seed + i` 为每个工作单元设置种子**\n\n这是一种常见但有缺陷的启发式方法，其中每个工作单元 $i$ 用从一个基础种子派生出的种子（如 $s+i$）来初始化其自己的 PRNG 实例。\n\n-   **独立性**：此设计不保证独立性。对于许多 PRNG，用等差间隔的种子初始化的流可能高度相关。它们也不能保证不相交；对于像 Mersenne Twister 这样具有巨大周期的生成器，序列重叠是可能的，尽管可能性不大。依赖“不同的种子”只是对独立性的假设，而非证明。在严肃的科学计算中，这种方法普遍不被推荐。\n-   **可复现性**：该设计未能通过强可复现性测试。所使用的随机数流集合取决于工作单元的数量 $P$。如果模拟以 $P=4$ 个工作单元运行，它将使用以 $s, s+1, s+2, s+3$ 为种子的 4 个流。如果以 $P=8$ 个工作单元重新运行，它将使用以 $s, \\dots, s+7$ 为种子的 8 个流。在第一次运行中由工作单元 1（种子 $s+1$）计算的路径 $j$，在第二次运行中可能由工作单元 5（种子 $s+5$）计算。因此，它将使用完全不同的随机数序列，使得整体结果依赖于 $P$。\n\n**D 的结论**：**不正确**。它未能保证独立性，并且其可复现性无法对 $P$ 保持不变。\n\n**选项E：基于计数器的 PRNG**\n\n这种现代方法将 PRNG 视为一个无状态函数 $h(\\text{key}, \\text{counter})$，它将一个密钥和一个计数器值映射到一个伪随机输出。\n\n-   **独立性**：该设计以最强的方式确保了独立性。模拟所需的每个随机变量，例如路径 $j$、时间步 $k$ 和变量编号 $\\ell$ 的变量，都是使用从元组 $(j, k, \\ell)$ 派生的唯一计数器值生成的。由于生成器函数的输入对于每一个随机变量都是唯一的，并且该函数被设计为具有密码学属性（如无密钥分组密码），因此输出在统计上具有非常高标准的独立性。没有需要担心重叠的“流”，只有根据唯一索引按需生成的随机变量。\n-   **可复现性**：此设计提供了完美的、强可复现性。随机变量 $u_{j,k,\\ell}$ 是全局密钥及其唯一索引 $(j,k,\\ell)$ 的确定性函数。该值完全独立于由哪个工作单元计算、何时计算、工作单元总数 $P$ 或并行执行环境的任何其他方面。因此，整个模拟是可复现的，并且对 $P$ 和调度的变化保持不变。\n\n**E 的结论**：**正确**。此方法为独立性和强可复现性提供了最强的保证。\n\n**结论**\n\n根据分析，只有选项 B 和 E 提供的设计能够正确地同时确保蒙特卡洛模拟所需的统计独立性和稳健数值工作所需的强可复现性（对调度和工作单元数量的不变性）。", "answer": "$$\\boxed{BE}$$", "id": "3330830"}]}