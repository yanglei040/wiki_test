{"hands_on_practices": [{"introduction": "理论是基础，但真正的理解来自于实践。本节将指导你亲手推导一个离散伴随模型，这是将理论应用于实际数值计算的关键一步。我们将以一个通用的龙格-库塔（Runge-Kutta）格式为例，通过构建拉格朗日函数并求解其定常条件，系统性地导出伴随方程[@problem_id:3363656]。这个练习不仅能让你掌握“先离散化后优化”方法的精髓，还能让你深刻理解伴随方程为何是时间反向传播的。", "problem": "考虑一个依赖于参数的常微分方程 (ODE) 初值问题，其状态为 $y \\in \\mathbb{R}^{d}$，参数为 $m \\in \\mathbb{R}^{p}$，\n$$\n\\frac{d y(t)}{d t} = f(y(t), m, t), \\quad y(0) = y_{0},\n$$\n其中 $f:\\mathbb{R}^{d} \\times \\mathbb{R}^{p} \\times \\mathbb{R} \\to \\mathbb{R}^{d}$ 对其所有参数均连续可微。设代价泛函为终端失配，\n$$\nJ(y_{N}) = \\frac{1}{2} \\left\\| H y_{N} - d \\right\\|_{R^{-1}}^{2} = \\frac{1}{2} (H y_{N} - d)^{\\top} R^{-1} (H y_{N} - d),\n$$\n其中 $H \\in \\mathbb{R}^{q \\times d}$，$d \\in \\mathbb{R}^{q}$，且 $R \\in \\mathbb{R}^{q \\times q}$ 是对称正定矩阵。将时间区间 $[0, T]$ 离散化为 $N$ 个等大的时间步，步长为 $\\Delta t = T/N$，网格点为 $t_{n} = n \\Delta t$，其中 $n \\in \\{0, 1, \\ldots, N\\}$。\n\n使用一个通用的两阶段 Runge-Kutta (RK) 格式（不一定是显式的），其 Butcher 系数为 $a_{ij}$、$b_{i}$ 和 $c_{i}$（$i, j \\in \\{1, 2\\}$），将 $y_{n}$推进到 $y_{n+1}$。在时间点 $t_{n} + c_{i} \\Delta t$ 定义阶段状态 $Y_{n}^{(i)}$ 和阶段右端项 $k_{n}^{(i)}$。\n\n任务：\n- 写出定义 $Y_{n}^{(i)}$ 和 $k_{n}^{(i)}$ 的两阶段 RK 阶段方程，以及从 $y_{n}$ 到 $y_{n+1}$ 的状态更新方程。\n- 通过为状态更新和每个阶段方程引入拉格朗日乘子来构建离散拉格朗日量，其中将 $Y_{n}^{(i)}$ 和 $k_{n}^{(i)}$ 视为受 RK 关系和 $k_{n}^{(i)} - f(Y_{n}^{(i)}, m, t_{n} + c_{i} \\Delta t) = 0$ 约束的独立变量。\n- 利用拉格朗日量的平稳性，推导出与 $y_n$ 相关的步长乘子的时间反向伴随递推关系，以及在每个时间步耦合阶段乘子的代数伴随阶段方程。\n- 最后，推导出关于参数 $m$ 的基于离散伴随的梯度，将其表示为关于伴随阶段乘子和 $\\partial_{m} f$ 的单一符号解析表达式。\n\n假设所有必要的导数都存在且连续，并假设 $y_{0}$ 不依赖于 $m$。将最终答案表示为关于 $m$ 的梯度的单一解析表达式。不需要进行数值计算。不要包含任何单位。不需要四舍五入。", "solution": "该问题是适定的，在反问题和最优控制领域有坚实的科学基础，并包含了进行形式推导所需的所有信息。任务是为一个由通用两阶段 Runge-Kutta (RK) 方法离散化的、依赖于参数的常微分方程 (ODE) 推导其离散伴随模型及相应的梯度。\n\n正演问题由 ODE 初值问题定义\n$$\n\\frac{d y(t)}{d t} = f(y(t), m, t), \\quad y(0) = y_{0}\n$$\n其状态为 $y \\in \\mathbb{R}^{d}$，参数为 $m \\in \\mathbb{R}^{p}$。需要最小化的代价泛函是\n$$\nJ(y_{N}) = \\frac{1}{2} (H y_{N} - d)^{\\top} R^{-1} (H y_{N} - d)\n$$\n其中 $y_N$ 是最终时刻 $T$ 的状态。\n\n首先，我们写出用于在时间区间 $[0, T]$ 上以时间步长 $\\Delta t$ 离散化 ODE 的通用两阶段 Runge-Kutta 格式的方程。对于从 $t_n$到 $t_{n+1}$ 的每个时间步（$n \\in \\{0, 1, \\ldots, N-1\\}$），该格式由阶段方程和状态更新方程定义。\n\n阶段方程定义了阶段 $i \\in \\{1, 2\\}$ 的阶段状态 $Y_{n}^{(i)} \\in \\mathbb{R}^{d}$ 和阶段右端项 $k_{n}^{(i)} \\in \\mathbb{R}^{d}$：\n$$\nY_{n}^{(i)} = y_n + \\Delta t \\sum_{j=1}^{2} a_{ij} k_n^{(j)}\n$$\n$$\nk_{n}^{(i)} = f(Y_n^{(i)}, m, t_n + c_i \\Delta t)\n$$\n然后使用状态更新方程将状态向量 $y_n$ 推进到 $y_{n+1}$：\n$$\ny_{n+1} = y_n + \\Delta t \\sum_{i=1}^{2} b_i k_n^{(i)}\n$$\n其中 $y_n$ 是 $y(t_n)$ 的数值近似。\n\n为了使用拉格朗日乘子法推导伴随模型，我们构建拉格朗日量 $\\mathcal{L}$。目标是在每个时间步 $n \\in \\{0, 1, \\ldots, N-1\\}$ 中由 RK 格式施加的约束条件下最小化 $J(y_N)$。我们将 $y_n$、$Y_{n}^{(i)}$ 和 $k_{n}^{(i)}$ 视为独立变量。约束条件是：\n1.  状态更新：$y_{n+1} - y_n - \\Delta t \\sum_{i=1}^{2} b_i k_n^{(i)} = 0$\n2.  阶段状态定义：$Y_n^{(i)} - y_n - \\Delta t \\sum_{j=1}^{2} a_{ij} k_n^{(j)} = 0$，对于 $i \\in \\{1, 2\\}$\n3.  阶段右端项定义：$k_n^{(i)} - f(Y_n^{(i)}, m, t_n + c_i \\Delta t) = 0$，对于 $i \\in \\{1, 2\\}$\n\n我们为每个约束引入拉格朗日乘子（伴随变量）：\n- $\\lambda_{n+1} \\in \\mathbb{R}^{d}$ 对应于第 $n$ 步的状态更新约束。\n- $\\mu_{n}^{(i)} \\in \\mathbb{R}^{d}$ 对应于第 $n$ 步的阶段 $i$ 的阶段状态约束。\n- $\\nu_{n}^{(i)} \\in \\mathbb{R}^{d}$ 对应于第 $n$ 步的阶段 $i$ 的阶段右端项约束。\n\n离散拉格朗日量 $\\mathcal{L}$ 是目标泛函与乘子和其各自约束的内积之和，并对所有时间步求和：\n$$\n\\mathcal{L} = J(y_N) + \\sum_{n=0}^{N-1} \\left[ \\lambda_{n+1}^{\\top} \\left(y_{n+1} - y_n - \\Delta t \\sum_{i=1}^{2} b_i k_n^{(i)}\\right) + \\sum_{i=1}^{2} (\\mu_n^{(i)})^{\\top} \\left(Y_n^{(i)} - y_n - \\Delta t \\sum_{j=1}^{2} a_{ij} k_n^{(j)}\\right) + \\sum_{i=1}^{2} (\\nu_n^{(i)})^{\\top} \\left(k_n^{(i)} - f(Y_n^{(i)}, m, t_n + c_i \\Delta t)\\right) \\right]\n$$\n\n通过强制拉格朗日量对于状态变量 $y_n$、$Y_n^{(i)}$ 和 $k_n^{(j)}$ 的平稳性来推导伴随方程。$\\mathcal{L}$ 对这些变量的偏导数必须为零。\n\n1.  关于 $y_N$ 的导数：\n    $$\n    \\frac{\\partial \\mathcal{L}}{\\partial y_N} = \\frac{\\partial J}{\\partial y_N} + \\lambda_N^{\\top} = 0 \\implies \\lambda_N = -\\nabla_{y_N} J\n    $$\n    代价泛函的梯度为 $\\nabla_{y_N} J = H^{\\top} R^{-1} (H y_N - d)$。这给出了伴随状态 $\\lambda_N$ 的终端条件：\n    $$\n    \\lambda_N = -H^{\\top} R^{-1} (H y_N - d)\n    $$\n\n2.  关于 $y_n$（$n \\in \\{1, \\ldots, N-1\\}$）的导数：\n    涉及 $y_n$ 的项出现在索引为 $n$ 和 $n-1$ 的求和中。\n    $$\n    \\frac{\\partial \\mathcal{L}}{\\partial y_n} = \\lambda_n^{\\top} - \\lambda_{n+1}^{\\top} - \\sum_{i=1}^{2} (\\mu_n^{(i)})^{\\top} = 0\n    $$\n    这得到了伴随状态 $\\lambda_n$ 的反向递推关系，$\\lambda_n$ 是与 $y_n$ 关联的乘子：\n    $$\n    \\lambda_n = \\lambda_{n+1} + \\sum_{i=1}^{2} \\mu_n^{(i)}, \\quad \\text{对于 } n = N-1, \\ldots, 1\n    $$\n\n3.  关于阶段变量 $Y_n^{(i)}$ 和 $k_n^{(j)}$ 的导数给出了每个时间步 $n \\in \\{0, \\ldots, N-1\\}$ 的代数伴随阶段方程。\n    关于 $Y_n^{(i)}$（$i \\in \\{1, 2\\}$）的导数：\n    $$\n    \\frac{\\partial \\mathcal{L}}{\\partial Y_n^{(i)}} = (\\mu_n^{(i)})^{\\top} - (\\nu_n^{(i)})^{\\top} \\frac{\\partial f}{\\partial y}(Y_n^{(i)}, m, t_n + c_i \\Delta t) = 0\n    $$\n    $$\n    \\mu_n^{(i)} = \\left(\\frac{\\partial f}{\\partial y}(Y_n^{(i)}, m, t_n + c_i \\Delta t)\\right)^{\\top} \\nu_n^{(i)}\n    $$\n    关于 $k_n^{(j)}$（$j \\in \\{1, 2\\}$）的导数：\n    $$\n    \\frac{\\partial \\mathcal{L}}{\\partial k_n^{(j)}} = -\\lambda_{n+1}^{\\top} \\Delta t \\, b_j - \\sum_{i=1}^{2} (\\mu_n^{(i)})^{\\top} \\Delta t \\, a_{ij} + (\\nu_n^{(j)})^{\\top} = 0\n    $$\n    $$\n    \\nu_n^{(j)} = \\Delta t \\left( b_j \\lambda_{n+1} + \\sum_{i=1}^{2} a_{ij} \\mu_n^{(i)} \\right)\n    $$\n    在每个步骤 $n$ 中的这两组方程为阶段乘子 $\\mu_n^{(i)}$ 和 $\\nu_n^{(i)}$ 构成了一个耦合线性系统，在给定前一个（反向）步骤的 $\\lambda_{n+1}$ 后即可求解。\n\n最后，我们推导代价泛函关于参数 $m$ 的梯度表达式。根据伴随方法，如果正演和伴随方程都得到满足，则 $J$ 关于 $m$ 的全导数等于拉格朗日量关于 $m$ 的偏导数。由于假设 $y_0$ 与 $m$无关，我们有：\n$$\n\\frac{d J}{d m} = \\frac{\\partial \\mathcal{L}}{\\partial m}\n$$\n拉格朗日量中唯一显式依赖于 $m$ 的项是 $f$。\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial m} = \\sum_{n=0}^{N-1} \\sum_{i=1}^{2} (\\nu_n^{(i)})^{\\top} \\left( -\\frac{\\partial f}{\\partial m}(Y_n^{(i)}, m, t_n + c_i \\Delta t) \\right) = - \\sum_{n=0}^{N-1} \\sum_{i=1}^{2} (\\nu_n^{(i)})^{\\top} \\partial_m f(Y_n^{(i)}, \\ldots)\n$$\n梯度 $\\nabla_m J$ 是一个列向量，它是行向量 $dJ/dm$ 的转置。令 $\\partial_m f$ 表示 $f$ 相对于 $m$ 各分量的偏导数矩阵。\n$$\n\\nabla_m J = \\left(\\frac{\\partial \\mathcal{L}}{\\partial m}\\right)^{\\top} = \\left( - \\sum_{n=0}^{N-1} \\sum_{i=1}^{2} (\\nu_n^{(i)})^{\\top} \\partial_m f(Y_n^{(i)}, \\ldots) \\right)^{\\top}\n$$\n这就得到了梯度的最终表达式：\n$$\n\\nabla_m J = - \\sum_{n=0}^{N-1} \\sum_{i=1}^{2} \\left[ \\partial_m f(Y_n^{(i)}, m, t_n + c_i \\Delta t) \\right]^{\\top} \\nu_n^{(i)}\n$$\n此处，$\\nu_n^{(i)}$ 是通过从 $n=N-1$ 到 $n=0$ 反向求解伴随方程得到的伴随阶段乘子。", "answer": "$$\n\\boxed{- \\sum_{n=0}^{N-1} \\sum_{i=1}^{2} \\left[ \\partial_m f(Y_n^{(i)}, m, t_n + c_i \\Delta t) \\right]^{\\top} \\nu_n^{(i)}}\n$$", "id": "3363656"}, {"introduction": "推导出伴随方程并编写代码后，如何确保其正确性？伴随模型中的细微错误可能导致梯度计算偏差，从而使整个优化或数据同化过程失败。本练习介绍一种至关重要的验证技术——点积测试（dot-product test），它直接源于伴随算子 $L^*$ 的数学定义 $\\langle Lu, v \\rangle_Y = \\langle u, L^*v \\rangle_X$ [@problem_id:3363680]。通过这个实践，你将学会如何为切线线性模型及其伴随实现构建一个稳健的数值检验，即使在数据同化中常见的加权内积空间中也能确保其正确性。", "problem": "考虑一个可微的离散正向模型 $F:\\mathbb{R}^{n}\\to\\mathbb{R}^{m}$ 和一个固定状态 $x\\in\\mathbb{R}^{n}$。设 $X=\\mathbb{R}^{n}$ 和 $Y=\\mathbb{R}^{m}$ 分别被赋予由对称正定（SPD）矩阵 $W_{x}\\in\\mathbb{R}^{n\\times n}$ 和 $W_{y}\\in\\mathbb{R}^{m\\times m}$ 定义的加权内积：\n$$\\langle u,v\\rangle_{X}=u^{\\top}W_{x}v,\\quad \\langle p,q\\rangle_{Y}=p^{\\top}W_{y}q.$$\n假设雅可比矩阵 $F'(x)$ 的切线线性实现可用于计算任意扰动 $\\delta x\\in\\mathbb{R}^{n}$ 的 $F'(x)\\delta x$，并假设您已经实现了一个候选伴随算子 $A_{\\mathrm{adj}}:\\mathbb{R}^{m}\\to\\mathbb{R}^{n}$，旨在表示 $F'(x)$ 关于 $X$ 和 $Y$ 上给定内积的伴随。您希望通过一个数值测试来验证 $A_{\\mathrm{adj}}$ 的正确性，该测试使用随机生成的扰动 $\\delta x\\in\\mathbb{R}^{n}$ 和 $\\delta y\\in\\mathbb{R}^{m}$，并通过一个与待比较量的大小成比例的适当容差来考虑有限精度算法。\n\n哪个选项正确地构建了一个稳健的点积测试，用以在 $X$ 和 $Y$ 的加权内积下验证 $A_{\\mathrm{adj}}$ 相对于 $F'(x)$ 的正确性？\n\nA. 从标准正态分布中抽取独立的随机向量 $\\delta x\\in\\mathbb{R}^{n}$ 和 $\\delta y\\in\\mathbb{R}^{m}$。计算 $s_{1}=\\delta y^{\\top}\\big(F'(x)\\delta x\\big)$ 和 $s_{2}=\\delta x^{\\top}\\big(F'(x)^{\\top}\\delta y\\big)$。如果对于一个小的容差 $\\varepsilon$，有 $\\big|s_{1}-s_{2}\\big|\\leq \\varepsilon\\,\\|\\delta x\\|_{2}\\,\\|\\delta y\\|_{2}$，则声明伴随实现是正确的。\n\nB. 从标准正态分布中抽取独立的随机向量 $\\delta x\\in\\mathbb{R}^{n}$ 和 $\\delta y\\in\\mathbb{R}^{m}$。计算 $s_{1}=\\big(F'(x)\\delta x\\big)^{\\top}W_{y}\\delta y$ 和 $s_{2}=\\delta x^{\\top}W_{x}\\big(A_{\\mathrm{adj}}\\delta y\\big)$。重复几次试验，如果相对差异满足\n$$\\frac{\\big|s_{1}-s_{2}\\big|}{\\big|s_{1}\\big|+\\big|s_{2}\\big|}\\leq \\varepsilon,$$\n则声明伴随实现是正确的，其中 $\\varepsilon$ 的选择与机器精度在同一数量级，并按问题相关因素进行缩放，且不等式在多次试验中均成立。\n\nC. 抽取独立的随机向量 $\\delta x\\in\\mathbb{R}^{n}$ 和 $\\delta y\\in\\mathbb{R}^{m}$。测试 $\\big\\|F'(x)\\delta x-A_{\\mathrm{adj}}\\delta y\\big\\|_{2}\\leq \\varepsilon$ 是否满足（对于一个小的容差 $\\varepsilon$），如果不等式在多次试验中均成立，则声明成功。\n\nD. 选择一个单一的随机向量 $\\delta x\\in\\mathbb{R}^{n}$ 并设置 $\\delta y=F'(x)\\delta x$。使用标准欧几里得内积测试 $\\big(F'(x)\\delta x\\big)^{\\top}\\delta y=\\delta x^{\\top}\\big(A_{\\mathrm{adj}}\\delta y\\big)$，如果等式在一个小的绝对容差 $\\varepsilon$ 内成立，则声明成功。", "solution": "用户希望我验证一个候选伴随实现 $A_{\\mathrm{adj}}$ 相对于一个切线线性模型 $F'(x)$ 的正确性。\n\n首先，我将验证问题陈述。\n\n### 步骤1：提取已知条件\n- 一个可微的离散正向模型 $F:\\mathbb{R}^{n}\\to\\mathbb{R}^{m}$。\n- 一个固定状态 $x\\in\\mathbb{R}^{n}$。\n- 状态空间为 $X=\\mathbb{R}^{n}$，配备内积 $\\langle u,v\\rangle_{X}=u^{\\top}W_{x}v$。\n- 观测空间为 $Y=\\mathbb{R}^{m}$，配备内积 $\\langle p,q\\rangle_{Y}=p^{\\top}W_{y}q$。\n- $W_{x}\\in\\mathbb{R}^{n\\times n}$ 和 $W_{y}\\in\\mathbb{R}^{m\\times m}$ 是对称正定（SPD）矩阵。\n- 一个切线线性实现提供了雅可比矩阵 $F'(x)$ 对向量的作用：$F'(x)\\delta x$。\n- 一个候选伴随算子实现 $A_{\\mathrm{adj}}:\\mathbb{R}^{m}\\to\\mathbb{R}^{n}$ 是可用的。\n- 目标是构建一个稳健的数值测试，该测试使用随机扰动和缩放容差，以验证 $A_{\\mathrm{adj}}$ 是 $F'(x)$ 关于给定内积的正确伴随。\n\n### 步骤2：使用提取的已知条件进行验证\n1.  **科学基础**：该问题基于线性代数和泛函分析的基本概念，特别是关于一般内积的伴随算子的定义。其背景是逆问题和数据同化，其中切线线性和伴随模型是标准的计算工具。这是一个在科学计算中非常常见和实际的问题。该问题在科学上和数学上都是合理的。\n2.  **适定性**：该问题要求正确构建一个数值测试。伴随算子的定义是唯一且明确的，从而为测试提供了单一的正确原则。该问题是适定的。\n3.  **客观性**：语言是正式、精确的，并使用标准的数学符号。它没有任何主观或模糊的术语。\n4.  **不完整或矛盾的设置**：该问题提供了构建所需测试的所有必要定义和约束。信息是自洽且一致的。\n5.  **不切实际或不可行**：所描述的场景——通过“点积测试”验证伴随代码——是在开发用于优化和数据同化的数值模型中一个标准且必要的程序。这是非常现实的。\n6.  **病态或结构不良**：问题结构清晰，要求一个具体的结果：一个有效的测试程序。\n7.  **伪深刻、琐碎或同义反复**：该问题并不琐碎，因为它要求在存在非标准（加权）内积的情况下正确应用伴随的定义，并理解稳健的数值比较技术。\n\n### 步骤3：结论与行动\n问题陈述是有效的。我现在将继续进行解答。\n\n### 基于原理的推导\n线性算子的伴随是由其在相关空间的内积中的行为定义的。设 $L: X \\to Y$ 是两个内积空间 $X$ 和 $Y$ 之间的一个线性算子。伴随算子，记为 $L^*: Y \\to X$，由以下关系唯一确定：\n$$ \\langle Lu, v \\rangle_Y = \\langle u, L^*v \\rangle_X, \\quad \\text{对于所有 } u \\in X, v \\in Y $$\n在我们的问题中，线性算子是雅可比矩阵（切线线性模型）$L = F'(x)$。向量空间是 $X = \\mathbb{R}^n$ 和 $Y = \\mathbb{R}^m$。向量是扰动 $u = \\delta x \\in \\mathbb{R}^n$ 和 $v = \\delta y \\in \\mathbb{R}^m$。内积是指定的加权内积：\n- $\\langle \\cdot, \\cdot \\rangle_X = \\langle \\cdot, \\cdot \\rangle_{\\mathbb{R}^n, W_x}$\n- $\\langle \\cdot, \\cdot \\rangle_Y = \\langle \\cdot, \\cdot \\rangle_{\\mathbb{R}^m, W_y}$\n\n将这些代入定义关系中，$F'(x)$ 的伴随，记为 $(F'(x))^*$，必须满足：\n$$ \\langle F'(x)\\delta x, \\delta y \\rangle_Y = \\langle \\delta x, (F'(x))^*\\delta y \\rangle_X $$\n对于所有 $\\delta x \\in \\mathbb{R}^n$ 和 $\\delta y \\in \\mathbb{R}^m$。\n\n现在，我们使用给定的矩阵-向量定义来表示内积：\n- 左侧（LHS）是：$\\langle F'(x)\\delta x, \\delta y \\rangle_Y = \\big(F'(x)\\delta x\\big)^{\\top} W_y \\delta y$。\n- 右侧（RHS）是：$\\langle \\delta x, (F'(x))^*\\delta y \\rangle_X = \\delta x^{\\top} W_x \\big((F'(x))^*\\delta y\\big)$。\n\n为了验证我们的候选实现 $A_{\\mathrm{adj}}$ 是正确的，我们必须测试是否 $A_{\\mathrm{adj}} \\approx (F'(x))^*$。这通过选择随机向量 $\\delta x$ 和 $\\delta y$ 并检查当用 $A_{\\mathrm{adj}}$ 替代 $(F'(x))^*$ 时定义等式是否成立来完成。让我们定义要比较的两个标量：\n$$ s_1 = \\big(F'(x)\\delta x\\big)^{\\top} W_y \\delta y $$\n$$ s_2 = \\delta x^{\\top} W_x \\big(A_{\\mathrm{adj}}\\delta y\\big) $$\n一个数值测试必须验证 $s_1 \\approx s_2$。在有限精度算术中，不期望精确相等 $s_1 = s_2$。比较必须使用一个对 $s_1$ 和 $s_2$ 的尺度具有鲁棒性的容差。绝对容差 $|s_1 - s_2| \\leq \\varepsilon$ 是不稳健的。需要一个相对容差。一种特别稳健的相对误差形式，即使在 $s_1$ 或 $s_2$ 接近零时也表现良好，其形式为\n$$ \\frac{|s_1 - s_2|}{|s_1| + |s_2|} \\leq \\varepsilon $$\n其中 $\\varepsilon$ 是一个小的容差，通常在机器精度的数量级。这是一个正确且稳健的伴随“点积测试”的基础。\n\n### 逐项分析\n\n**A. 从标准正态分布中抽取独立的随机向量 $\\delta x\\in\\mathbb{R}^{n}$ 和 $\\delta y\\in\\mathbb{R}^{m}$。计算 $s_{1}=\\delta y^{\\top}\\big(F'(x)\\delta x\\big)$ 和 $s_{2}=\\delta x^{\\top}\\big(F'(x)^{\\top}\\delta y\\big)$。如果对于一个小的容差 $\\varepsilon$，有 $\\big|s_{1}-s_{2}\\big|\\leq \\varepsilon\\,\\|\\delta x\\|_{2}\\,\\|\\delta y\\|_{2}$，则声明伴随实现是正确的。**\n\n这个选项有两个根本性缺陷。首先，它使用了标准的欧几里得内积（点积），即 $W_x=I$ 和 $W_y=I$。问题明确指定了使用 SPD 矩阵 $W_x$ 和 $W_y$ 的加权内积。其次，它测试的是矩阵转置 $F'(x)^{\\top}$ 作为伴随的正确性，而不是用户提供的实现 $A_{\\mathrm{adj}}$。目标是验证代码 $A_{\\mathrm{adj}}$。\n\n**结论：错误。**\n\n**B. 从标准正态分布中抽取独立的随机向量 $\\delta x\\in\\mathbb{R}^{n}$ 和 $\\delta y\\in\\mathbb{R}^{m}$。计算 $s_{1}=\\big(F'(x)\\delta x\\big)^{\\top}W_{y}\\delta y$ 和 $s_{2}=\\delta x^{\\top}W_{x}\\big(A_{\\mathrm{adj}}\\delta y\\big)$。重复几次试验，如果相对差异满足 $\\frac{\\big|s_{1}-s_{2}\\big|}{\\big|s_{1}\\big|+\\big|s_{2}\\big|}\\leq \\varepsilon$，则声明伴随实现是正确的，其中 $\\varepsilon$ 的选择与机器精度在同一数量级，并按问题相关因素进行缩放，且不等式在多次试验中均成立。**\n\n这个选项正确地使用指定的加权内积构建了伴随恒等式的两边。\n- $s_1 = \\big(F'(x)\\delta x\\big)^{\\top}W_{y}\\delta y = \\langle F'(x)\\delta x, \\delta y \\rangle_Y$。\n- $s_2 = \\delta x^{\\top}W_{x}\\big(A_{\\mathrm{adj}}\\delta y\\big) = \\langle \\delta x, A_{\\mathrm{adj}}\\delta y \\rangle_X$。\n比较 $s_1$ 和 $s_2$ 是在测试候选算子 $A_{\\mathrm{adj}}$ 是否满足伴随的定义属性。它使用了一个稳健的相对误差度量，该度量随计算值的大小而缩放，这正是稳健数值测试所要求的。使用独立的随机向量并重复几次试验是标准的最佳实践。\n\n**结论：正确。**\n\n**C. 抽取独立的随机向量 $\\delta x\\in\\mathbb{R}^{n}$ 和 $\\delta y\\in\\mathbb{R}^{m}$。测试 $\\big\\|F'(x)\\delta x-A_{\\mathrm{adj}}\\delta y\\big\\|_{2}\\leq \\varepsilon$ 是否满足（对于一个小的容差 $\\varepsilon$），如果不等式在多次试验中均成立，则声明成功。**\n\n这种比较在数学上和维度上都是无意义的。向量 $F'(x)\\delta x$ 在 $\\mathbb{R}^m$（观测空间）中，而向量 $A_{\\mathrm{adj}}\\delta y$ 在 $\\mathbb{R}^n$（状态空间）中。除非 $n=m$，否则减法没有定义。即使 $n=m$，也没有任何原理说明这两个向量在任何范数下都应该接近。切线线性和伴随算子在不同空间之间进行映射。\n\n**结论：错误。**\n\n**D. 选择一个单一的随机向量 $\\delta x\\in\\mathbb{R}^{n}$ 并设置 $\\delta y=F'(x)\\delta x$。使用标准欧几里得内积测试 $\\big(F'(x)\\delta x\\big)^{\\top}\\delta y=\\delta x^{\\top}\\big(A_{\\mathrm{adj}}\\delta y\\big)$，如果等式在一个小的绝对容差 $\\varepsilon$ 内成立，则声明成功。**\n\n这个选项有多个缺陷。首先，它使用了标准的欧几里得内积，忽略了用矩阵 $W_x$ 和 $W_y$ 指定的加权内积。其次，它没有使用独立的随机向量；相反，它创建了一个依赖关系 $\\delta y = F'(x)\\delta x$。伴随属性必须对所有向量对成立，而不仅仅是这个特定的、高度受限的子集。在这样一个小的子空间上进行测试不是一个通用或稳健的验证方法。第三，它使用了一个简单的绝对容差，其稳健性不如相对容差。\n\n**结论：错误。**", "answer": "$$\\boxed{B}$$", "id": "3363680"}]}