{"hands_on_practices": [{"introduction": "在开发数值求解器时，验证是至关重要的一步。对于像圆柱体这样的规范几何结构，可以证明，使用全域傅里叶基函数的矩量法与经典的解析级数解是等价的。本练习旨在巩固您对伽辽金法的理解，并为验证计算电磁学代码的正确性提供一个具体的基准 [@problem_id:3305813]。", "problem": "要求您使用解析结果，验证一个用于计算电磁学中规范二维散射问题的全域矩量法解。考虑在自由空间中，一个半径为 $a$ 的理想电导体 (PEC) 圆柱体对沿 $z$ 轴方向的电场（$\\text{TM}_z$）的时谐横磁波散射问题。入射场是沿 $x$ 轴传播的单位振幅平面波 $E_z^{\\text{inc}}(r,\\phi) = e^{i k r \\cos(\\phi)}$。光速为 $c = 299\\,792\\,458$ 米/秒。所有角度必须以弧度为单位，所有长度以米为单位，所有频率以赫兹为单位，最终的数值输出是无量纲的。\n\n从二维 $\\text{TM}_z$ 的标量亥姆霍兹方程开始，\n$$\n\\nabla^2 E_z + k^2 E_z = 0,\n$$\n其中自由空间波数为 $k = \\frac{2\\pi f}{c}$，PEC 上的总场边界条件为，\n$$\nE_z^{\\text{tot}}(r=a,\\phi) = 0.\n$$\n使用二维自由空间格林函数 $G(\\mathbf{r},\\mathbf{r}') = \\frac{i}{4} H_0^{(1)}(k|\\mathbf{r}-\\mathbf{r}'|)$，将圆柱体外部的散射场表示为圆形边界上的单层势，其中 $H_\\nu^{(1)}(\\cdot)$ 是第一类汉克尔函数，\n$$\nE_z^{\\text{scat}}(r,\\phi) = \\frac{i}{4} \\int_0^{2\\pi} q(\\phi') H_0^{(1)}\\!\\left(k\\left|\\mathbf{r} - \\mathbf{r}'\\right|\\right) a\\, d\\phi',\n$$\n其中 $\\mathbf{r}'$ 约束在圆 $r'=a$ 上，$q(\\phi')$ 是一个未知的等效源密度。使用由所有整数 $n \\in \\mathbb{Z}$ 索引的全域傅里叶基函数 $b_n(\\phi) = e^{i n \\phi}$，在伽辽金意义下对 $r = a$ 施加边界条件 $E_z^{\\text{inc}}(a,\\phi) + E_z^{\\text{scat}}(a,\\phi) = 0$。使用 Graf 加法定理对圆上的积分算子进行对角化，\n$$\nH_0^{(1)}\\!\\left(k\\left|\\mathbf{r} - \\mathbf{r}'\\right|\\right) = \\sum_{m=-\\infty}^{\\infty} H_m^{(1)}(k r_) J_m(k r_) e^{i m (\\phi - \\phi')},\n$$\n其中 $r_ = \\max(r,r')$ 和 $r_ = \\min(r,r')$，$J_\\nu(\\cdot)$ 是第一类贝塞尔函数。证明作用于 $b_n(\\phi')$ 的单层算子得到\n$$\n\\mathcal{S}[b_n](\\phi) = \\frac{i}{4} \\int_0^{2\\pi} H_0^{(1)}\\!\\left(k\\left|\\mathbf{r} - \\mathbf{r}'\\right|\\right) a\\, b_n(\\phi') d\\phi' = \\lambda_n b_n(\\phi),\n$$\n其对角特征值为\n$$\n\\lambda_n = \\frac{i \\pi a}{2} J_n(k a) H_n^{(1)}(k a).\n$$\n使用边界上入射场的 Jacobi–Anger 展开，\n$$\nE_z^{\\text{inc}}(a,\\phi) = \\sum_{n=-\\infty}^{\\infty} i^n J_n(k a) e^{i n \\phi},\n$$\n来推导源密度系数 $q_n$ 的伽辽金解，\n$$\n\\lambda_n q_n + i^n J_n(k a) = 0 \\quad \\Rightarrow \\quad q_n = - \\frac{i^n J_n(k a)}{\\lambda_n}.\n$$\n证明圆柱体外部的散射场展开具有以下形式\n$$\nE_z^{\\text{scat}}(r,\\phi) = \\sum_{n=-\\infty}^{\\infty} A_n H_n^{(1)}(k r) e^{i n \\phi},\n$$\n其中单层势的投影得到\n$$\nA_n = \\frac{i}{4} (2\\pi a) q_n J_n(k a) = - \\frac{i^n J_n(k a)}{H_n^{(1)}(k a)}.\n$$\n最后一个等式通过逐个模式地施加狄利克雷边界条件 $E_z^{\\text{inc}}(a,\\phi) + E_z^{\\text{scat}}(a,\\phi) = 0$ 提供了解析散射系数，并同时通过单层势验证了全域傅里叶-伽辽金矩量法解。\n\n实现一个程序，计算数值全域矩量法系数并与解析系数进行比较，并用解析场验证散射场。使用贝塞尔函数 $J_n(\\cdot)$ 和汉克尔函数 $H_n^{(1)}(\\cdot)$，对于给定的截断阶数 $N$，取 $n$ 从 $-N$ 到 $N$。为计算散射场，使用\n$$\nE_z^{\\text{scat}}(r,\\phi) \\approx \\sum_{n=-N}^{N} A_n H_n^{(1)}(k r) e^{i n \\phi},\n$$\n其中使用上述解析 $A_n$ 和通过 $q_n$ 及单层势投影由矩量法推导出的 $A_n$。\n\n您的程序必须计算以下三个测试用例，每个用例产生一个浮点结果，这些结果将被汇总并打印为单行：\n\n1. 系数验证（正常路径）。参数：$a=0.5$ 米，$f = 3.0 \\times 10^8$ 赫兹，截断阶数 $N=40$。计算在所有模式 $n \\in \\{-N,\\dots,N\\}$ 上，数值全域 $A_n$ 和解析 $A_n$ 之间的最大相对误差，定义为\n$$\n\\max_{-N \\le n \\le N} \\frac{\\left|A_n^{\\text{MoM}} - A_n^{\\text{analytical}}\\right|}{\\max\\left(\\left|A_n^{\\text{analytical}}\\right|, \\varepsilon\\right)},\n$$\n其中 $\\varepsilon = 10^{-15}$。\n\n2. 在有限观测半径处的场验证（系数之外的覆盖）。参数：$a=0.35$ 米，$f = 1.2 \\times 10^9$ 赫兹，截断阶数 $N=60$，观测半径 $r_{\\text{obs}} = 10a$，角度 $\\phi_m = \\frac{2\\pi m}{16}$（其中 $m = 0,1,\\dots,15$，以弧度为单位）。计算在所有角度上，由数值全域 $A_n$ 和解析 $A_n$ 构建的 $E_z^{\\text{scat}}(r_{\\text{obs}},\\phi_m)$ 之间的最大相对误差，\n$$\n\\max_m \\frac{\\left|E_z^{\\text{scat,MoM}}(r_{\\text{obs}},\\phi_m) - E_z^{\\text{scat,analytical}}(r_{\\text{obs}},\\phi_m)\\right|}{\\max\\left(\\left|E_z^{\\text{scat,analytical}}(r_{\\text{obs}},\\phi_m)\\right|, \\varepsilon\\right)}.\n$$\n\n3. 截断下的边界条件残差（边界情况）。参数：$a=0.02$ 米，选择 $f$ 以使 $ka=0.5$（即，$f = \\frac{0.5 c}{2\\pi a}$ 赫兹），截断阶数 $N=5$。使用截断到 $n \\in \\{-N,\\dots,N\\}$ 的解析系数，计算在角度 $\\phi_m = \\frac{2\\pi m}{64}$（其中 $m = 0,1,\\dots,63$）上的边界条件的归一化最大残差，\n$$\n\\max_m \\frac{\\left|E_z^{\\text{inc}}(a,\\phi_m) + \\sum_{n=-N}^{N} A_n^{\\text{analytical}} H_n^{(1)}(k a) e^{i n \\phi_m}\\right|}{\\max_m \\left|E_z^{\\text{inc}}(a,\\phi_m)\\right|}.\n$$\n\n您的程序应产生单行输出，其中包含三个数值结果，以逗号分隔并用方括号括起来（例如，“[result1,result2,result3]”）。每个结果必须是浮点数。使用指定的物理单位（$a$ 用米，$f$ 用赫兹），所有角度使用弧度。", "solution": "我们从横磁极化中沿 $z$ 方向的电场 $E_z$ 的二维标量亥姆霍兹方程开始，该方程在散射体外部由 $\\nabla^2 E_z + k^2 E_z = 0$ 给出。对于 $r=a$ 处的理想电导体 (PEC) 边界，狄利克雷边界条件强制总切向电场在表面上为零，即 $E_z^{\\text{tot}}(r=a,\\phi) = 0$。总场等于入射场和散射场之和，$E_z^{\\text{tot}} = E_z^{\\text{inc}} + E_z^{\\text{scat}}$。\n\n我们使用密度为 $q(\\phi')$ 的单层势和二维自由空间格林函数来表示边界曲线 $\\Gamma$（半径为 $a$ 的圆）上的散射场，\n$$\nE_z^{\\text{scat}}(r,\\phi) = \\frac{i}{4} \\int_{\\Gamma} q(\\phi') H_0^{(1)}\\!\\left(k\\left|\\mathbf{r} - \\mathbf{r}'\\right|\\right) ds' = \\frac{i}{4} \\int_0^{2\\pi} q(\\phi') H_0^{(1)}\\!\\left(k\\left|\\mathbfr - \\mathbf{r}'\\right|\\right) a\\, d\\phi',\n$$\n其中 $H_0^{(1)}(\\cdot)$ 是第一类零阶汉克尔函数，$ds' = a\\, d\\phi'$ 是圆上的微分弧长。\n\n在边界 $r=a$ 上，施加 $E_z^{\\text{inc}}(a,\\phi) + E_z^{\\text{scat}}(a,\\phi) = 0$ 得到了单层势表示下 $\\text{TM}_z$ 的电场积分方程 (EFIE)。为使用全域基函数求解此方程，我们将未知量 $q(\\phi')$ 展开为傅里叶级数，\n$$\nq(\\phi') = \\sum_{n=-\\infty}^{\\infty} q_n e^{i n \\phi'},\n$$\n并用同一族函数 $b_n(\\phi) = e^{i n \\phi}$ 对 EFIE 进行测试（伽辽金方法）。由于圆对称性，圆上的积分算子被傅里叶谐波对角化。使用 Graf 加法定理，\n$$\nH_0^{(1)}\\!\\left(k\\left|\\mathbf{r} - \\mathbf{r}'\\right|\\right) = \\sum_{m=-\\infty}^{\\infty} H_m^{(1)}(k r_) J_m(k r_) e^{i m (\\phi - \\phi')},\n$$\n设 $r=r'=a$ 得到\n$$\nH_0^{(1)}\\!\\left(k\\left|\\mathbf{r} - \\mathbf{r}'\\right|\\right)\\bigg|_{r=r'=a} = \\sum_{m=-\\infty}^{\\infty} H_m^{(1)}(k a) J_m(k a) e^{i m (\\phi - \\phi')}.\n$$\n将单层算子应用于 $b_n(\\phi')$ 并对 $\\phi'$ 积分，得到\n$$\n\\mathcal{S}[b_n](\\phi) = \\frac{i}{4} \\int_0^{2\\pi} \\left[\\sum_{m=-\\infty}^{\\infty} H_m^{(1)}(k a) J_m(k a) e^{i m (\\phi - \\phi')}\\right] a\\, e^{i n \\phi'} d\\phi'.\n$$\n交换求和与积分，并利用正交性，\n$$\n\\int_0^{2\\pi} e^{i (n - m) \\phi'} d\\phi' = 2\\pi \\delta_{n m},\n$$\n我们发现\n$$\n\\mathcal{S}[b_n](\\phi) = \\frac{i}{4} a \\left[2\\pi H_n^{(1)}(k a) J_n(k a)\\right] e^{i n \\phi} = \\lambda_n b_n(\\phi),\n$$\n其特征值为\n$$\n\\lambda_n = \\frac{i \\pi a}{2} J_n(k a) H_n^{(1)}(k a).\n$$\n因此，投影到 $b_n$ 上的 EFIE 变为\n$$\n\\lambda_n q_n + \\langle b_n, E_z^{\\text{inc}}(a,\\cdot) \\rangle = 0,\n$$\n其中尖括号表示傅里叶系数的提取。使用边界上入射平面波的 Jacobi–Anger 展开，\n$$\nE_z^{\\text{inc}}(a,\\phi) = e^{i k a \\cos \\phi} = \\sum_{n=-\\infty}^{\\infty} i^n J_n(k a) e^{i n \\phi},\n$$\n我们确定入射傅里叶系数为 $E_{n}^{\\text{inc}} = i^n J_n(k a)$。因此，源密度系数为\n$$\nq_n = - \\frac{i^n J_n(k a)}{\\lambda_n} = - \\frac{i^n J_n(k a)}{\\frac{i \\pi a}{2} J_n(k a) H_n^{(1)}(k a)} = - \\frac{2}{i \\pi a} \\frac{i^n}{H_n^{(1)}(k a)}.\n$$\n\n为了在相同的谐波基中获得远离边界（$ra$）的散射场，我们使用 Graf 加法定理对 $ra$（$r_=r$, $r_=a$）的情况展开单层势，得到\n$$\nE_z^{\\text{scat}}(r,\\phi) = \\frac{i}{4} \\int_0^{2\\pi} q(\\phi') \\left[\\sum_{m=-\\infty}^{\\infty} H_m^{(1)}(k r) J_m(k a) e^{i m (\\phi - \\phi')}\\right] a\\, d\\phi' = \\sum_{n=-\\infty}^{\\infty} A_n H_n^{(1)}(k r) e^{i n \\phi},\n$$\n其中散射场模态振幅为\n$$\nA_n = \\frac{i}{4} \\left(2\\pi a\\right) q_n J_n(k a).\n$$\n代入 $q_n$，\n$$\nA_n = \\frac{i}{4} \\left(2\\pi a\\right) \\left[- \\frac{i^n J_n(k a)}{\\lambda_n}\\right] J_n(k a) = - \\frac{i^n J_n(k a)}{H_n^{(1)}(k a)}.\n$$\n这最后一个表达式正是通过逐个模式地施加边界条件 $E_z^{\\text{inc}}(a,\\phi) + \\sum_n A_n H_n^{(1)}(k a) e^{i n \\phi} = 0$ 所获得的解析系数，因为正交性确保了\n$$\ni^n J_n(k a) + A_n H_n^{(1)}(k a) = 0 \\quad \\Rightarrow \\quad A_n = - \\frac{i^n J_n(k a)}{H_n^{(1)}(k a)}.\n$$\n因此，使用单层势的全域傅里叶-伽辽金矩量法解与 PEC 圆柱体的精确解析解进行比对，验证了其正确性。\n\n算法设计：\n1. 对于给定的 $a$ 和 $f$，计算 $k = \\frac{2\\pi f}{c}$ 和 $k a$。\n2. 对于截断阶数 $N$，枚举 $n \\in \\{-N, -N+1, \\dots, N\\}$。\n3. 使用可靠的特殊函数库计算每个 $n$ 对应的 $J_n(k a)$ 和 $H_n^{(1)}(k a)$。\n4. 计算伽辽金单层特征值 $\\lambda_n = \\frac{i \\pi a}{2} J_n(k a) H_n^{(1)}(k a)$。\n5. 计算源密度系数 $q_n = - \\frac{i^n J_n(k a)}{\\lambda_n}$。\n6. 计算矩量法散射场系数 $A_n^{\\text{MoM}} = \\frac{i}{4} (2\\pi a) q_n J_n(k a)$。\n7. 计算解析系数 $A_n^{\\text{analytical}} = - \\frac{i^n J_n(k a)}{H_n^{(1)}(k a)}$。\n8. 验证：\n   a. 系数验证：计算 $A_n^{\\text{MoM}}$ 和 $A_n^{\\text{analytical}}$ 之间相对差异的 $\\max_n$，使用一个小的 $\\varepsilon$ 来防止除以零。\n   b. 场验证：对于指定的角度和 $r_{\\text{obs}}$，根据两组 $A_n$ 计算 $E_z^{\\text{scat}}(r_{\\text{obs}},\\phi)$，并取所有角度上的最大相对差异。\n   c. 边界条件残差：对于边界上的角度，计算残差 $E_z^{\\text{inc}}(a,\\phi) + \\sum_{n=-N}^{N} A_n^{\\text{analytical}} H_n^{(1)}(k a) e^{i n \\phi}$，并用所有角度上的最大入射场幅值进行归一化。\n\n数值考虑：\n- 对 $A_n$、$H_n^{(1)}$ 和 $E_z^{\\text{scat}}$ 使用复数运算。\n- 利用对称性 $J_{-n}(x) = (-1)^n J_n(x)$ 和 $H_{-n}^{(1)}(x) = (-1)^n H_n^{(1)}(x)$；然而，对负整数阶直接求值也是可以接受的。\n- 选择 $\\varepsilon = 10^{-15}$ 以在分母接近零时稳定相对误差的除法运算。\n\n程序将为指定的测试用例计算三个浮点结果，并将它们以逗号分隔的列表形式打印在单行中，并用方括号括起来，例如，“[1.0e-15,2.0e-15,0.0123]”。所有角度均以弧度处理，长度以米为单位，频率以赫兹为单位，输出为无量纲。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import jv, hankel1\n\nc = 299_792_458.0  # speed of light in m/s\n\ndef compute_coefficients(a, f, N):\n    \"\"\"\n    Compute MoM and analytical scattered-field coefficients A_n for n in [-N, N].\n    Returns arrays of n, A_mom, A_analytic, and ka.\n    \"\"\"\n    k = 2.0 * np.pi * f / c\n    ka = k * a\n    ns = np.arange(-N, N+1, dtype=int)\n    # Precompute Bessel and Hankel at ka for all n\n    J = np.array([jv(n, ka) for n in ns], dtype=np.complex128)\n    H = np.array([hankel1(n, ka) for n in ns], dtype=np.complex128)\n    # Eigenvalues of single-layer operator on the circle\n    lam = 1j * np.pi * a / 2.0 * J * H\n    # Incident coefficients: i^n J_n(ka)\n    i_pow_n = np.array([(1j)**n for n in ns], dtype=np.complex128)\n    Einc_n = i_pow_n * J\n    # Source density coefficients q_n from Galerkin EFIE\n    # Guard against division by zero in pathological cases\n    q = -Einc_n / lam\n    # MoM scattered-field coefficients via single-layer projection\n    A_mom = (1j / 4.0) * (2.0 * np.pi * a) * q * J\n    # Analytical coefficients from boundary condition\n    # A_n = - i^n J_n(ka) / H_n^{(1)}(ka)\n    A_analytic = -Einc_n / H\n    return ns, A_mom, A_analytic, ka, k\n\ndef coeff_validation_case(a, f, N, eps=1e-15):\n    ns, A_mom, A_analytic, ka, k = compute_coefficients(a, f, N)\n    denom = np.maximum(np.abs(A_analytic), eps)\n    rel_err = np.abs(A_mom - A_analytic) / denom\n    return float(np.max(rel_err))\n\ndef field_validation_case(a, f, N, r_obs, angles, eps=1e-15):\n    ns, A_mom, A_analytic, ka, k = compute_coefficients(a, f, N)\n    # Compute Hankel at observation radius\n    kr = k * r_obs\n    H_obs = np.array([hankel1(n, kr) for n in ns], dtype=np.complex128)\n    # Evaluate scattered fields for both methods\n    errs = []\n    for phi in angles:\n        exp_nphi = np.array([np.exp(1j * n * phi) for n in ns], dtype=np.complex128)\n        Es_mom = np.sum(A_mom * H_obs * exp_nphi)\n        Es_ana = np.sum(A_analytic * H_obs * exp_nphi)\n        denom = max(np.abs(Es_ana), eps)\n        errs.append(np.abs(Es_mom - Es_ana) / denom)\n    return float(np.max(errs))\n\ndef boundary_residual_case(a, f, N, angles):\n    ns, A_mom, A_analytic, ka, k = compute_coefficients(a, f, N)\n    # Residual using analytical coefficients truncated to N at the boundary\n    # Residual(phi) = E_inc(a,phi) + sum_{n=-N}^N A_n H_n(ka) e^{i n phi}\n    H_boundary = np.array([hankel1(n, ka) for n in ns], dtype=np.complex128)\n    max_inc_mag = 0.0\n    max_resid = 0.0\n    for phi in angles:\n        E_inc = np.exp(1j * ka * np.cos(phi))\n        # Compute truncated field sum at boundary\n        exp_nphi = np.array([np.exp(1j * n * phi) for n in ns], dtype=np.complex128)\n        sum_trunc = np.sum(A_analytic * H_boundary * exp_nphi)\n        resid = E_inc + sum_trunc\n        max_inc_mag = max(max_inc_mag, np.abs(E_inc))\n        max_resid = max(max_resid, np.abs(resid))\n    # Normalize residual by max incident magnitude\n    if max_inc_mag == 0.0:\n        return float(max_resid)\n    return float(max_resid / max_inc_mag)\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: Coefficient validation (happy path)\n        {\n            \"type\": \"coeff\",\n            \"a\": 0.5,          # meters\n            \"f\": 3.0e8,        # Hz\n            \"N\": 40\n        },\n        # Case 2: Field validation at finite observation radius\n        {\n            \"type\": \"farfield\",\n            \"a\": 0.35,         # meters\n            \"f\": 1.2e9,        # Hz\n            \"N\": 60,\n            \"r_obs_multiplier\": 10.0,\n            \"angles\": [2.0*np.pi*m/16.0 for m in range(16)]\n        },\n        # Case 3: Boundary-condition residual under truncation (edge case)\n        {\n            \"type\": \"boundary\",\n            \"a\": 0.02,         # meters\n            \"ka_target\": 0.5,  # choose f so that k*a = 0.5\n            \"N\": 5,\n            \"angles\": [2.0*np.pi*m/64.0 for m in range(64)]\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        if case[\"type\"] == \"coeff\":\n            a = case[\"a\"]\n            f = case[\"f\"]\n            N = case[\"N\"]\n            result = coeff_validation_case(a, f, N)\n            results.append(result)\n        elif case[\"type\"] == \"farfield\":\n            a = case[\"a\"]\n            f = case[\"f\"]\n            N = case[\"N\"]\n            r_obs = case[\"r_obs_multiplier\"] * a\n            angles = case[\"angles\"]\n            result = field_validation_case(a, f, N, r_obs, angles)\n            results.append(result)\n        elif case[\"type\"] == \"boundary\":\n            a = case[\"a\"]\n            ka_target = case[\"ka_target\"]\n            # f = (ka_target * c) / (2*pi*a)\n            f = (ka_target * c) / (2.0 * np.pi * a)\n            N = case[\"N\"]\n            angles = case[\"angles\"]\n            result = boundary_residual_case(a, f, N, angles)\n            results.append(result)\n        else:\n            results.append(float(\"nan\"))\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3305813"}, {"introduction": "边界元方法的数值性能取决于其底层积分算子的谱特性。在像球面这样的对称域上，全域基函数（球谐函数）可以使这些算子对角化，从而能够清晰地分析它们的特征值以及由此产生的系统条件数。本实践揭示了积分方程中病态问题的根源，并演示了如何运用像卡尔德龙恒等式这样的理论工具来设计稳健且条件良好的数值格式 [@problem_id:3305837]。", "problem": "考虑三维时谐标量波散射，该过程由亥姆霍兹方程控制。设 $\\Gamma$ 为半径为 $a0$ 的球面，设 $k0$ 为自由空间波数。定义在 $\\Gamma$ 上的以下边界积分算子，这些算子由亥姆霍兹格林函数 $G_k(\\mathbf{x},\\mathbf{y}) = \\exp(i k \\|\\mathbf{x}-\\mathbf{y}\\|)/(4\\pi \\|\\mathbf{x}-\\mathbf{y}\\|)$ 构建：\n\n- 单层算子 $S_k$，作用于面密度 $\\varphi$，通过 $(S_k \\varphi)(\\mathbf{x}) = \\int_{\\Gamma} G_k(\\mathbf{x},\\mathbf{y}) \\,\\varphi(\\mathbf{y}) \\, dS_{\\mathbf{y}}$。\n- 伴随双层算子 $K_k'$，通过单层势的平均法向导数作用。\n- 超奇异算子 $W_k$，作用于势的边界迹。\n\n在球面上，球谐函数 $Y_{\\ell}^m(\\theta,\\phi)$（其中 $\\ell \\in \\{0,1,2,\\dots\\}$ 且 $m \\in \\{-\\ell,\\dots,\\ell\\}$）构成一个标准正交的全域基，该基能将算子 $S_k$、$K_k'$ 和 $W_k$ 对角化。设 $L$ 为一个非负整数截断指数。用 $v_{\\ell}$ 表示 $S_k$ 的特征值，用 $\\kappa_{\\ell}'$ 表示 $K_k'$ 的特征值，它们对应于由所有具有固定 $\\ell$ 的 $Y_{\\ell}^m$ 所张成的子空间（特征值不依赖于 $m$）。Calderón 恒等式表明，这些算子在光滑闭曲面上满足复合关系，特别是在适当的函数设置中，$W_k S_k = K_k'^2 - \\tfrac{1}{4} I$。\n\n仅从下面列出的基本定律和核心定义出发，您必须从第一性原理推导出球体 $\\Gamma$ 上算子的谱形式，并设计一种数值稳定的算法来评估：\n- 截断单层算子的条件数，\n- 由复合算子 $W_k S_k + \\tfrac{1}{4} I$ 构建的 Calderón 正则化算子的条件数。\n\n使用的基本定律和定义集：\n- 用于辐射解的亥姆霍兹方程 $\\Delta u + k^2 u = 0$ 及其通过由 $G_k$ 构建的边界层势的表示。\n- 球谐函数的加法定理和球坐标系下的变量分离法。\n- 层势的法向导数穿过 $\\Gamma$ 时的跳跃关系。\n- 作为球坐标系下可分离解的径向部分的球贝塞尔函数和球汉克尔函数，以及它们的基本朗斯基恒等式。\n\n您的程序必须使用在阶数 $L$ 处截断的全域基 $\\{Y_{\\ell}^m\\}$ 来实现以下内容：\n1. 计算半径为 $a$ 的球面上单层算子 $S_k$ 的特征值 $\\{v_{\\ell}\\}_{\\ell=0}^L$。\n2. 计算同一球面上伴随双层算子 $K_k'$ 的特征值 $\\{\\kappa_{\\ell}'\\}_{\\ell=0}^L$。\n3. 构建 Calderón 正则化算子，其特征值为 $\\{\\kappa_{\\ell}'^{\\,2}\\}_{\\ell=0}^L$，使用恒等式 $W_k S_k = K_k'^2 - \\tfrac{1}{4} I$ 来消去 $W_k$。\n4. 对于下面的每个测试用例，报告：\n   - 在截断基上 $S_k$ 的条件数，定义为 $\\max_{\\ell \\in \\{0,\\dots,L\\}} |v_{\\ell}| \\big/ \\min_{\\ell \\in \\{0,\\dots,L\\}} |v_{\\ell}|$，\n   - Calderón 正则化算子 $W_k S_k + \\tfrac{1}{4} I = K_k'^2$ 的条件数，定义为 $\\max_{\\ell \\in \\{0,\\dots,L\\}} |\\kappa_{\\ell}'|^2 \\big/ \\min_{\\ell \\in \\{0,\\dots,L\\}} |\\kappa_{\\ell}'|^2$，\n   - 改善因子，定义为两个条件数之比。\n\n此问题中的所有量都是无量纲的，或者是 $a$ 和 $k$ 以无量纲乘积 $ka$ 形式出现的组合，因此输出中不需要物理单位。内部需要的角度，被理解为以弧度为单位。\n\n要实现的测试套件，其中每个测试用例是一个三元组 $(a,k,L)$：\n- 测试 1 (正常路径): $(1.0, 0.3, 8)$\n- 测试 2 (中等频率，较大截断): $(1.0, 2.0, 20)$\n- 测试 3 (高频，更高截断): $(1.0, 10.0, 35)$\n- 测试 4 (边界截断情况): $(1.0, 0.5, 0)$\n\n您的程序应生成单行输出，其中包含四个测试用例的结果，格式为方括号括起来的逗号分隔列表，其中每个内部列表按 [S_k的条件数, 正则化算子的条件数, 改善因子] 的顺序包含三个浮点数。例如，输出格式必须类似于：\n[[cS1,cR1,imp1],[cS2,cR2,imp2],[cS3,cR3,imp3],[cS4,cR4,imp4]]", "solution": "问题陈述是亥姆霍兹方程在球坐标几何中边界积分算子谱理论方面一个适定且科学严谨的练习。它要求使用球谐函数的全域基来推导单层和伴随双层算子的特征值。该问题是有效的，我们可以继续进行求解。\n\n问题的核心是确定算子 $S_k$ 和 $K_k'$ 在半径为 $a$ 的球体 $\\Gamma$ 上的特征值。这些算子可由球谐函数基 $\\{Y_{\\ell}^m\\}$ 对角化。我们从第一性原理推导相应的特征值，记为 $v_{\\ell}$ 和 $\\kappa_{\\ell}'$。\n\n**1. 单层算子 ($S_k$) 的特征值**\n\n单层算子 $S_k$ 作用于面密度 $\\varphi$ 的方式如下：\n$$ (S_k \\varphi)(\\mathbf{x}) = \\int_{\\Gamma} G_k(\\mathbf{x},\\mathbf{y}) \\,\\varphi(\\mathbf{y}) \\, dS_{\\mathbf{y}} $$\n其中 $G_k(\\mathbf{x},\\mathbf{y}) = \\frac{\\exp(i k \\lVert \\mathbf{x}-\\mathbf{y} \\rVert)}{4\\pi \\lVert \\mathbf{x}-\\mathbf{y} \\rVert}$ 是亥姆霍兹方程的自由空间格林函数。为了找到特征值 $v_{\\ell}$，我们令 $\\varphi$ 为一个球谐函数，$\\varphi(\\mathbf{y}) = Y_{\\ell}^m(\\hat{\\mathbf{y}})$，其中 $\\hat{\\mathbf{y}}$ 是球面上点 $\\mathbf{y}$ 的方向向量。\n\n对于球面 $\\Gamma$ 上的 $\\mathbf{x}$ 和 $\\mathbf{y}$（$|\\mathbf{x}| = |\\mathbf{y}| = a$），格林函数可以使用球面波的加法定理展开：\n$$ G_k(\\mathbf{x},\\mathbf{y}) = ik \\sum_{n=0}^{\\infty} \\sum_{p=-n}^{n} j_n(ka) h_n^{(1)}(ka) Y_n^p(\\hat{\\mathbf{x}}) \\overline{Y_n^p(\\hat{\\mathbf{y}})} $$\n其中 $j_n$ 和 $h_n^{(1)}$ 分别是第一类球贝塞尔函数和球汉克尔函数。\n\n将此展开式代入算子定义，其中 $\\varphi(\\mathbf{y}) = Y_{\\ell}^m(\\hat{\\mathbf{y}})$ 且面元 $dS_{\\mathbf{y}} = a^2 d\\Omega_{\\mathbf{y}}$：\n$$ (S_k Y_{\\ell}^m)(\\mathbf{x}) = \\int_{\\Omega} \\left( ik \\sum_{n=0}^{\\infty} \\sum_{p=-n}^{n} j_n(ka) h_n^{(1)}(ka) Y_n^p(\\hat{\\mathbf{x}}) \\overline{Y_n^p(\\hat{\\mathbf{y}})} \\right) Y_{\\ell}^m(\\hat{\\mathbf{y}}) \\, a^2 d\\Omega_{\\mathbf{y}} $$\n其中积分是在单位球的立体角 $\\Omega$ 上进行的。交换求和与积分的次序：\n$$ (S_k Y_{\\ell}^m)(\\mathbf{x}) = ik a^2 \\sum_{n=0}^{\\infty} \\sum_{p=-n}^{n} j_n(ka) h_n^{(1)}(ka) Y_n^p(\\hat{\\mathbf{x}}) \\int_{\\Omega} \\overline{Y_n^p(\\hat{\\mathbf{y}})} Y_{\\ell}^m(\\hat{\\mathbf{y}}) d\\Omega_{\\mathbf{y}} $$\n根据球谐函数的标准正交性，$\\int_{\\Omega} \\overline{Y_n^p} Y_{\\ell}^m d\\Omega = \\delta_{n\\ell} \\delta_{pm}$。双重求和坍缩为 $n=\\ell$ 和 $p=m$ 的单项：\n$$ (S_k Y_{\\ell}^m)(\\mathbf{x}) = \\left( ik a^2 j_{\\ell}(ka) h_{\\ell}^{(1)}(ka) \\right) Y_{\\ell}^m(\\hat{\\mathbf{x}}) $$\n因此，单层算子 $S_k$ 的特征值 $v_{\\ell}$（与指数 $m$ 无关）为：\n$$ v_{\\ell} = ik a^2 j_{\\ell}(ka) h_{\\ell}^{(1)}(ka) $$\n\n**2. 伴随双层算子 ($K_k'$) 的特征值**\n\n算子 $K_k'$ 是通过单层势 $u = S_k \\varphi$ 的平均法向导数定义的。令 $\\varphi = Y_{\\ell}^m$。势 $u(\\mathbf{x}) = (S_k Y_{\\ell}^m)(\\mathbf{x})$ 是亥姆霍兹方程在 $|\\mathbf{x}|  a$ 时的辐射解，以及在 $|\\mathbf{x}|  a$ 时的正则解。使用变量分离法，势可以表示为：\n$$ u(\\mathbf{x}) = ik a^2 Y_{\\ell}^m(\\hat{\\mathbf{x}}) \\begin{cases} j_{\\ell}(ka) h_{\\ell}^{(1)}(kr)  r  a \\\\ h_{\\ell}^{(1)}(ka) j_{\\ell}(kr)  r  a \\end{cases} $$\n其中 $r=|\\mathbf{x}|$。向外的单位法向量为 $\\mathbf{n} = \\hat{\\mathbf{r}}$，因此法向导数为 $\\frac{\\partial}{\\partial n} = \\frac{\\partial}{\\partial r}$。在 $\\Gamma$ 上法向导数的外部 (+) 和内部 (-) 极限为：\n$$ \\frac{\\partial u}{\\partial n}\\bigg|_{+} = \\frac{\\partial u}{\\partial r}\\bigg|_{r=a^+} = ik a^2 Y_{\\ell}^m(\\hat{\\mathbf{x}}) j_{\\ell}(ka) \\left[k \\frac{d}{d(kr)} h_{\\ell}^{(1)}(kr)\\right]_{r=a} = ik^2 a^2 j_{\\ell}(ka) h_{\\ell}^{(1)\\prime}(ka) Y_{\\ell}^m(\\hat{\\mathbf{x}}) $$\n$$ \\frac{\\partial u}{\\partial n}\\bigg|_{-} = \\frac{\\partial u}{\\partial r}\\bigg|_{r=a^-} = ik a^2 Y_{\\ell}^m(\\hat{\\mathbf{x}}) h_{\\ell}^{(1)}(ka) \\left[k \\frac{d}{d(kr)} j_{\\ell}(kr)\\right]_{r=a} = ik^2 a^2 h_{\\ell}^{(1)}(ka) j_{\\ell}^{\\prime}(ka) Y_{\\ell}^m(\\hat{\\mathbf{x}}) $$\n其中撇号表示对自变量求导。算子 $K_k'$ 是这两个极限的平均值：\n$$ (K_k' Y_{\\ell}^m)(\\mathbf{x}) = \\frac{1}{2} \\left(\\frac{\\partial u}{\\partial n}\\bigg|_{+} + \\frac{\\partial u}{\\partial n}\\bigg|_{-}\\right) $$\n代入导数表达式得到：\n$$ (K_k' Y_{\\ell}^m)(\\mathbf{x}) = \\left( \\frac{1}{2} ik^2 a^2 \\left[ j_{\\ell}'(ka) h_{\\ell}^{(1)}(ka) + j_{\\ell}(ka) h_{\\ell}^{(1)\\prime}(ka) \\right] \\right) Y_{\\ell}^m(\\hat{\\mathbf{x}}) $$\n因此，伴随双层算子 $K_k'$ 的特征值 $\\kappa_{\\ell}'$ 为：\n$$ \\kappa_{\\ell}' = \\frac{1}{2} i (ka)^2 \\left[ j_{\\ell}'(ka) h_{\\ell}^{(1)}(ka) + j_{\\ell}(ka) h_{\\ell}^{(1)\\prime}(ka) \\right] $$\n\n**3. Calderón 正则化和条件数**\n\n问题要求分析算子 $W_k S_k + \\frac{1}{4}I$。给定的 Calderón 恒等式表明 $W_k S_k = K_k'^2 - \\frac{1}{4}I$。因此，正则化算子就是 $K_k'^2$。由于 $Y_{\\ell}^m$ 是 $K_k'$ 的特征函数，特征值为 $\\kappa_{\\ell}'$，它们也是 $K_k'^2$ 的特征函数，特征值为 $(\\kappa_{\\ell}')^2$。\n\n线性算子表示为矩阵的条件数是其最大奇异值与最小奇异值之比。在基 $\\{Y_{\\ell}^m\\}_{\\ell=0,..,L}$ 中，算子 $S_k$ 和 $K_k'^2$ 分别由对角矩阵表示，其对角元为 $\\{v_{\\ell}\\}$ 和 $\\{(\\kappa_{\\ell}')^2\\}$（重数为 $2\\ell+1$）。奇异值是这些特征值的模。\n\n截断单层算子 $S_k$ 的条件数为：\n$$ \\text{cond}(S_k) = \\frac{\\max_{\\ell \\in \\{0, \\dots, L\\}} |v_{\\ell}|}{\\min_{\\ell \\in \\{0, \\dots, L\\}} |v_{\\ell}|} $$\n\nCalderón 正则化算子 $K_k'^2$ 的条件数为：\n$$ \\text{cond}(K_k'^2) = \\frac{\\max_{\\ell \\in \\{0, \\dots, L\\}} |(\\kappa_{\\ell}')^2|}{\\min_{\\ell \\in \\{0, \\dots, L\\}} |(\\kappa_{\\ell}')^2|} = \\frac{\\left(\\max_{\\ell \\in \\{0, \\dots, L\\}} |\\kappa_{\\ell}'|\\right)^2}{\\left(\\min_{\\ell \\in \\{0, \\dots, L\\}} |\\kappa_{\\ell}'|\\right)^2} $$\n\n改善因子是这两个条件数之比，即 $\\text{cond}(S_k) / \\text{cond}(K_k'^2)$。\n\n**4. 算法实现**\n\n数值计算过程如下：\n对于每个测试用例 $(a, k, L)$：\n1.  定义参数 $z = ka$。\n2.  对于从 $0$ 到 $L$ 的每个整数阶 $\\ell$：\n    a. 使用一个鲁棒的库（如 `scipy.special`）计算球贝塞尔函数 $j_{\\ell}(z)$、$j_{\\ell}'(z)$ 和球诺依曼函数 $y_{\\ell}(z)$、$y_{\\ell}'(z)$。\n    b. 构建球汉克尔函数 $h_{\\ell}^{(1)}(z) = j_{\\ell}(z) + i y_{\\ell}(z)$ 及其导数 $h_{\\ell}^{(1)\\prime}(z) = j_{\\ell}'(z) + i y_{\\ell}'(z)$。\n    c. 使用推导出的公式评估特征值 $v_{\\ell}$ 和 $\\kappa_{\\ell}'$。\n3.  构建绝对值数组 $|v_0|, \\dots, |v_L|$ 和 $|\\kappa'_0|^2, \\dots, |\\kappa'_L|^2$。\n4.  通过在这些数组中找到最大值和最小值并计算它们的比率来计算条件数。\n5.  计算改善因子。\n\n对于 $L=0$ 的特殊情况，基只包含一个函数。得到的算子矩阵是 $1 \\times 1$ 的，其条件数平凡地为 $1$。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import spherical_jn, spherical_yn\n\ndef solve():\n    \"\"\"\n    Solves the problem of computing condition numbers for boundary integral operators on a sphere.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    # Each case is a tuple (a, k, L).\n    test_cases = [\n        (1.0, 0.3, 8),\n        (1.0, 2.0, 20),\n        (1.0, 10.0, 35),\n        (1.0, 0.5, 0),\n    ]\n\n    results = []\n    for a, k, L in test_cases:\n        # For L=0, the basis contains a single function space. The condition\n        # number of any operator represented in this basis is trivially 1.\n        if L == 0:\n            results.append([1.0, 1.0, 1.0])\n            continue\n\n        # Wavenumber-radius product\n        z = k * a\n        # Array of spherical harmonic degrees\n        ells = np.arange(L + 1)\n\n        # Compute spherical Bessel and Neumann functions of orders 0 to L\n        # The sph_jn(L, z) call returns an array of values for n=0..L\n        j_l = spherical_jn(ells, z)\n        y_l = spherical_yn(ells, z)\n\n        # Compute derivatives of spherical Bessel and Neumann functions\n        # The derivative call in scipy requires a loop over orders.\n        j_l_prime = np.array([spherical_jn(l, z, derivative=True) for l in ells])\n        y_l_prime = np.array([spherical_yn(l, z, derivative=True) for l in ells])\n\n        # Construct spherical Hankel functions and their derivatives\n        # h_l^(1)(z) = j_l(z) + i * y_l(z)\n        h1_l = j_l + 1j * y_l\n        h1_l_prime = j_l_prime + 1j * y_l_prime\n\n        # 1. Compute eigenvalues {v_l} of the single-layer operator S_k\n        # v_l = i * k * a^2 * j_l(ka) * h_l^(1)(ka)\n        v_l_vals = 1j * k * a**2 * j_l * h1_l\n\n        # 2. Compute eigenvalues {kappa'_l} of the adjoint double-layer operator K'_k\n        # kappa'_l = 0.5 * i * (ka)^2 * (j_l'(ka)h_l^(1)(ka) + j_l(ka)h_l^(1)'(ka))\n        k_prime_l_vals = 0.5 * 1j * z**2 * (j_l_prime * h1_l + j_l * h1_l_prime)\n        \n        # 3. Form eigenvalues of Calderon-regularized operator, { (kappa'_l)^2 }\n        # These are simply the square of the eigenvalues of K'_k.\n\n        # 4. Compute condition numbers and improvement factor\n        \n        # Magnitudes of eigenvalues of S_k\n        abs_v = np.abs(v_l_vals)\n        # Magnitudes of eigenvalues of K'_k^2, which is |kappa'_l|^2\n        abs_k_sq = np.abs(k_prime_l_vals)**2\n\n        # Condition number of S_k\n        cond_S = np.max(abs_v) / np.min(abs_v)\n        \n        # Condition number of K'_k^2\n        cond_R = np.max(abs_k_sq) / np.min(abs_k_sq)\n        \n        # Improvement factor\n        improvement = cond_S / cond_R\n\n        results.append([cond_S, cond_R, improvement])\n\n    # Format the final output string as specified\n    formatted_results = [f\"[{','.join(map(str, r))}]\" for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "3305837"}, {"introduction": "尽管纯粹的伽辽金法非常优雅，但在实际应用中，彼得罗夫-伽辽金格式的灵活性可能更有优势，尤其是在混合使用不同类型的基函数时。这类混合格式的稳定性并非理所当然，必须通过离散 inf-sup 条件进行评估，该条件关联了测试函数空间和试探函数空间的选择。本练习将为您提供分析非标准离散化方案数值稳定性的实践经验，这对于设计能结合全域函数和局部函数优点的先进混合求解器而言，是一项至关重要的技能 [@problem_id:3305810]。", "problem": "考虑时谐波的理想电导体边界条件的弱施加，该条件要求总电场的切向分量在导体边界上为零。根据麦克斯韦方程组，理想电导体边界条件规定电场的切向分量在导体边界 $\\partial \\Omega$ 上满足 $E_{\\mathrm{tan}} = 0$。在纯边界公式中，该条件的施加可以描述为：寻找一个边界量 $u$，使得残差 $r = \\mathcal{T}u + E_{\\mathrm{inc},\\mathrm{tan}}$ 在 $\\partial \\Omega$ 上以弱形式最小化。其中，$\\mathcal{T}$ 是一个将边界未知量映射到在 $\\partial \\Omega$ 上感应出的切向场的算子，而 $E_{\\mathrm{inc},\\mathrm{tan}}$ 是入射场限制在 $\\partial \\Omega$ 上的切向分量。在本问题中，为分离测试函数与试探函数不匹配造成的影响，我们将 $\\mathcal{T}$ 近似为单位算子，并专注于混合使用全域试探函数和局域测试函数（反之亦然）的 Petrov–Galerkin 离散化方法的稳定性与逼近特性。\n\n设边界 $\\partial \\Omega$ 为半径 $R=1$ 米的单位圆，由 $s \\in [0, 2\\pi)$ 参数化，其位置向量为 $r(s) = (\\cos s, \\sin s)$。令 $\\langle f, g \\rangle = \\int_{0}^{2\\pi} f(s)\\, \\overline{g(s)}\\, ds$ 表示 $\\partial \\Omega$ 上的 $L^{2}$ 内积，其中积分变量为角参数 $s$（单位为弧度）。考虑 $\\partial \\Omega$ 上的两族函数：\n\n1. 全域平面波函数：对于给定的波数 $k$（单位为 rad/m）和单位方向向量 $\\hat{d} = (\\cos \\theta, \\sin \\theta)$（方向角 $\\theta$ 的单位为弧度），在边界上定义标量函数\n$$\n\\phi_{\\theta}(s) = e^{\\mathrm{i}\\, k\\, \\hat{d} \\cdot r(s)} \\quad \\text{for } s \\in [0, 2\\pi).\n$$\n\n2. 局域帽函数（Rao–Wilton–Glisson 函数的一维模拟）：对于整数 $N \\geq 3$ 和节点 $s_{n} = 2\\pi n/N$（其中 $n = 0, 1, \\dots, N-1$），定义支撑在 $[s_{n-1}, s_{n+1}]$ 上的周期性分段线性函数 $\\chi_{n}(s)$，满足 $\\chi_{n}(s_{n}) = 1$，$\\chi_{n}(s_{n-1}) = \\chi_{n}(s_{n+1}) = 0$，并在每个区间上线性变化，其中下标按模 $N$ 计算。具体而言，对于 $s \\in [0,2\\pi)$ 且 $\\Delta = 2\\pi/N$，\n$$\n\\chi_{n}(s) = \n\\begin{cases}\n\\dfrac{s - s_{n-1}}{\\Delta},  s \\in [s_{n-1}, s_{n}], \\\\\n\\dfrac{s_{n+1} - s}{\\Delta},  s \\in [s_{n}, s_{n+1}], \\\\\n0,  \\text{otherwise}.\n\\end{cases}\n$$\n\n通过构建矩形 Gram 矩阵 $B$ 来定义 Petrov–Galerkin 的测试函数与试探函数配对，其元素为\n$$\nB_{pq} = \\langle \\psi_{p}, \\varphi_{q} \\rangle,\n$$\n其中 $\\{\\psi_{p}\\}$ 是所选的测试函数集，$\\{\\varphi_{q}\\}$ 是所选的试探函数集，两者均从平面波函数集或局域帽函数集中选取。为评估与缩放无关的稳定性，定义归一化 Gram 矩阵 $\\widetilde{B}$ 为\n$$\n\\widetilde{B}_{pq} = \\frac{B_{pq}}{\\|\\psi_{p}\\|_{L^{2}(\\partial\\Omega)}\\, \\|\\varphi_{q}\\|_{L^{2}(\\partial\\Omega)}},\n$$\n并定义离散 inf-sup 常数估计值为 $\\widetilde{B}$ 的最小奇异值。\n\n为在弱施加下衡量逼近效果，设入射场的边界数据为标量函数\n$$\nf(s) = e^{\\mathrm{i}\\, k\\, \\hat{d}_{0} \\cdot r(s)},\n$$\n其入射方向为 $\\hat{d}_{0} = (\\cos \\theta_{0}, \\sin \\theta_{0})$。通过分量为 $g_{p} = \\langle \\psi_{p}, f \\rangle$ 的向量 $g$ 来定义残差对测试空间的测试。Petrov–Galerkin 弱施加旨在寻找试探系数 $c$，以最小化残差 $\\|D_{\\psi}^{-1}(B c + g)\\|_{2}$，其中 $D_{\\psi} = \\mathrm{diag}(\\|\\psi_{p}\\|_{L^{2}(\\partial\\Omega)})$。使用最小二乘解 $c^{\\star}$ 来最小化 $\\|D_{\\psi}^{-1}(B c + g)\\|_{2}$。定义归一化残差比\n$$\n\\rho = \\frac{\\|D_{\\psi}^{-1}(B c^{\\star} + g)\\|_{2}}{\\|D_{\\psi}^{-1} g\\|_{2}}.\n$$\n\n您的任务是实现一个程序，该程序：\n- 针对单位圆 $\\partial \\Omega$ 上的四个指定案例，构建测试函数集和试探函数集，使用数值积分计算在 $s \\in [0, 2\\pi)$ 上的所有所需内积，计算作为 $\\widetilde{B}$ 的最小奇异值的离散 inf-sup 常数估计值，并计算入射数据 $f(s)$ 的归一化残差比 $\\rho$。\n\n数值积分必须在 $s$ 上使用至少 $L = 4096$ 个点的均匀采样，并且所有角度都必须解释为弧度。波数 $k$ 的单位必须为 rad/m，边界半径为 $R=1$ 米，因此微分弧长 $ds$ 的单位为米。所有输出必须为浮点数。\n\n测试套件：\n- 案例 1（匹配函数族的平衡 Petrov–Galerkin）：测试函数和试探函数均为平面波，有 $M=9$ 个方向 $\\theta_{m} = 2\\pi m / 9$（$m=0,1,\\dots,8$），波数 $k = 10.0 \\text{ rad/m}$，入射方向角 $\\theta_{0} = 1.0$ 弧度。计算 $\\widetilde{B}$ 的最小奇异值和 $\\rho$。\n- 案例 2（全域试探函数，局域测试函数）：试探函数为平面波，有 $M=7$ 个方向 $\\theta_{m} = 2\\pi m / 7$（$m=0,1,\\dots,6$）；测试函数为局域帽函数，有 $N=16$ 个节点；波数 $k = 10.0 \\text{ rad/m}$；入射方向角 $\\theta_{0} = 0.7$ 弧度。计算 $\\widetilde{B}$ 的最小奇异值和 $\\rho$。\n- 案例 3（局域试探函数，全域测试函数）：试探函数为局域帽函数，有 $N=16$ 个节点；测试函数为平面波，有 $M=7$ 个方向 $\\theta_{m} = 2\\pi m / 7$（$m=0,1,\\dots,6$）；波数 $k = 10.0 \\text{ rad/m}$；入射方向角 $\\theta_{0} = 0.7$ 弧度。计算 $\\widetilde{B}$ 的最小奇异值和 $\\rho$。\n- 案例 4（严重聚集的全域试探函数，局域测试函数）：试探函数为平面波，有 $M=7$ 个方向 $\\theta_{m} = 0.02 m$（$m=0,1,\\dots,6$）；测试函数为局域帽函数，有 $N=16$ 个节点；波数 $k = 10.0 \\text{ rad/m}$；入射方向角 $\\theta_{0} = 0.3$ 弧度。计算 $\\widetilde{B}$ 的最小奇异值和 $\\rho$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含四个案例的八个结果，格式为方括号括起来的逗号分隔列表，顺序如下\n$$\n[\\sigma_{\\min}^{(1)}, \\rho^{(1)}, \\sigma_{\\min}^{(2)}, \\rho^{(2)}, \\sigma_{\\min}^{(3)}, \\rho^{(3)}, \\sigma_{\\min}^{(4)}, \\rho^{(4)}],\n$$\n其中 $\\sigma_{\\min}^{(i)}$ 和 $\\rho^{(i)}$ 分别是案例 $i$ 的 $\\widetilde{B}$ 的最小奇异值和归一化残差比。所有角度单位必须是弧度，波数单位是 rad/m；八个输出必须是浮点数。", "solution": "用户提供了一个计算电磁学领域中有效且适定的问题。任务是分析几种 Petrov–Galerkin 格式在一个单位圆上的模型边值问题中的稳定性和逼近性质。这将通过计算两个关键指标来完成：离散 inf-sup 常数估计值（$\\sigma_{\\min}$）和归一化残差比（$\\rho$）。\n\n解决此问题的逻辑步骤如下：\n\n1.  **域和函数的离散化**：连续边界 $\\partial\\Omega$ 是一个半径为 $R=1$ 的单位圆，由角度 $s \\in [0, 2\\pi)$ 参数化。为了进行数值积分，这个连续域被离散化为一个由 $L=4096$ 个等距点 $s_j = 2\\pi j / L$（$j=0, \\dots, L-1$）组成的精细网格。积分的微分元变为 $\\Delta s_{quad} = 2\\pi/L$。平面波和局域帽这两族函数在这些离散点上进行求值，以生成先验已知值的向量。\n    *   **平面波函数**：$\\phi_{\\theta}(s) = e^{\\mathrm{i}\\, k\\, \\hat{d} \\cdot r(s)}$。当 $R=1$，$r(s) = (\\cos s, \\sin s)$ 且 $\\hat{d} = (\\cos\\theta, \\sin\\theta)$ 时，该式简化为 $\\phi_{\\theta}(s) = e^{\\mathrm{i}\\, k\\, \\cos(s - \\theta)}$。\n    *   **局域帽函数**：$\\chi_{n}(s)$ 仅在两个相邻的节点区间上非零。对于位于节点 $s_k$ 和 $s_{k+1}$ 之间的任意点 $s$，只有 $\\chi_k(s)$ 和 $\\chi_{k+1}(s)$ 非零，并呈线性变化。它们的值根据所提供的分段线性定义计算，并遵循圆上的周期性。\n\n2.  **内积的数值计算**：$L^2$ 内积 $\\langle f, g \\rangle = \\int_{0}^{2\\pi} f(s)\\, \\overline{g(s)}\\, ds$ 使用梯形法则在一个包含 $L$ 个点的均匀网格上进行数值近似。该积分表示为一个求和式：\n    $$\n    \\langle f, g \\rangle \\approx \\sum_{j=0}^{L-1} f(s_j) \\overline{g(s_j)} \\Delta s_{quad} = \\frac{2\\pi}{L} \\sum_{j=0}^{L-1} f(s_j) \\overline{g(s_j)}.\n    $$\n    该数值积分用于计算所有必要的量：\n    *   Petrov–Galerkin 矩阵的元素：$B_{pq} = \\langle \\psi_{p}, \\varphi_{q} \\rangle$。\n    *   右端向量的分量：$g_{p} = \\langle \\psi_{p}, f \\rangle$。\n    *   基函数的 $L^2$ 范数：$\\|\\psi_{p}\\|_{L^2} = \\sqrt{\\langle \\psi_p, \\psi_p \\rangle}$ 和 $\\|\\varphi_{q}\\|_{L^2} = \\sqrt{\\langle \\varphi_q, \\varphi_q \\rangle}$。\n\n3.  **Inf-Sup 常数估计值（$\\sigma_{\\min}$）的计算**：Petrov–Galerkin 系统的稳定性通过离散 inf-sup（或 LBB）条件进行评估，此处通过归一化 Gram 矩阵 $\\widetilde{B}$ 的最小奇异值来估计。矩阵 $\\widetilde{B}$ 通过归一化 $B$ 的每个元素来构建：\n    $$\n    \\widetilde{B}_{pq} = \\frac{B_{pq}}{\\|\\psi_{p}\\|_{L^2}\\, \\|\\varphi_{q}\\|_{L^2}}.\n    $$\n    计算 $\\widetilde{B}$ 的奇异值分解（SVD）。此分解中最小的奇异值 $\\sigma_{\\min}$ 用作离散 inf-sup 常数的估计值。一个小的 $\\sigma_{\\min}$ 值表明系统可能存在不稳定性。\n\n4.  **归一化残差比（$\\rho$）的计算**：逼近质量的衡量标准是试探函数展开式能多大程度上抵消入射场在测试空间上的投影。这通过求解一个加权最小二乘问题来量化，即找到最优的试探系数 $c^\\star$ 以最小化 $\\|D_{\\psi}^{-1}(B c + g)\\|_{2}$。这里，$D_{\\psi}$ 是一个对角矩阵，其元素为 $\\|\\psi_{p}\\|_{L^2}$。令 $A = D_{\\psi}^{-1}B$ 和 $b = D_{\\psi}^{-1}g$。该问题等价于寻找最小化 $\\|Ac+b\\|_{2}$ 的 $c^\\star$。这是一个标准的线性最小二乘问题，可通过 `numpy.linalg.lstsq` 等例程求解。解 $c^\\star$ 产生最小残差范数 $\\|D_{\\psi}^{-1}(B c^{\\star} + g)\\|_{2}$。然后计算归一化残差比 $\\rho$：\n    $$\n    \\rho = \\frac{\\|D_{\\psi}^{-1}(B c^{\\star} + g)\\|_{2}}{\\|D_{\\psi}^{-1} g\\|_{2}}.\n    $$\n    分母代表初始的加权残差范数（当 $c=0$ 时），因此 $\\rho$ 衡量了残差的相对减小量。$\\rho$ 的值接近 0 表示逼近能力出色，而接近 1 则表示逼近能力较差。\n\n将此过程应用于问题中指定的四个测试案例，从而得出所需的八个输出值。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef get_plane_wave_vals(k, thetas, s_grid):\n    \"\"\"\n    Evaluates plane-wave functions on a grid.\n\n    Args:\n        k (float): Wavenumber in rad/m.\n        thetas (np.ndarray): Array of direction angles in radians.\n        s_grid (np.ndarray): Array of boundary parameter values in radians.\n\n    Returns:\n        np.ndarray: A (len(thetas), len(s_grid)) array of complex function values.\n    \"\"\"\n    # The radius R=1 is implicit in the formula k * cos(...).\n    cos_diff = np.cos(s_grid[np.newaxis, :] - thetas[:, np.newaxis])\n    return np.exp(1j * k * cos_diff)\n\ndef get_hat_function_vals(N, s_grid):\n    \"\"\"\n    Evaluates periodic hat functions on a grid.\n\n    Args:\n        N (int): Number of nodes/functions.\n        s_grid (np.ndarray): Array of boundary parameter values in radians.\n\n    Returns:\n        np.ndarray: A (N, len(s_grid)) array of float function values.\n    \"\"\"\n    L = len(s_grid)\n    vals = np.zeros((N, L), dtype=float)\n    delta = 2 * np.pi / N\n    \n    s_norm = s_grid / delta\n    \n    k_indices = np.floor(s_norm).astype(int)\n    frac_part = s_norm - k_indices\n    \n    # Handle periodicity of nodes using modulo operator\n    k_indices %= N\n    k1_indices = (k_indices + 1) % N\n\n    # Vectorized assignment of function values.\n    # For each grid point s_j, at most two hat functions are non-zero.\n    col_indices = np.arange(L)\n    vals[k_indices, col_indices] = 1.0 - frac_part\n    vals[k1_indices, col_indices] = frac_part\n    \n    return vals\n\ndef calculate_metrics(k, test_spec, trial_spec, theta0):\n    \"\"\"\n    Computes sigma_min and rho for a given Petrov-Galerkin setup.\n    \"\"\"\n    L = 4096\n    s_grid = np.linspace(0, 2 * np.pi, L, endpoint=False)\n    ds_quad = 2 * np.pi / L\n\n    # 1. Generate function values at quadrature points\n    test_type, test_n, test_params = test_spec\n    if test_type == 'plane_wave':\n        psi_vals = get_plane_wave_vals(k, test_params, s_grid)\n    else: # 'hat'\n        psi_vals = get_hat_function_vals(test_n, s_grid)\n    \n    trial_type, trial_n, trial_params = trial_spec\n    if trial_type == 'plane_wave':\n        phi_vals = get_plane_wave_vals(k, trial_params, s_grid)\n    else: # 'hat'\n        phi_vals = get_hat_function_vals(trial_n, s_grid)\n\n    f_vals = get_plane_wave_vals(k, np.array([theta0]), s_grid).flatten()\n\n    # 2. Compute inner products via numerical quadrature\n    B = ds_quad * (psi_vals @ np.conj(phi_vals).T)\n    g = ds_quad * (psi_vals @ np.conj(f_vals))\n\n    norm_psi = np.sqrt(ds_quad * np.sum(np.abs(psi_vals)**2, axis=1))\n    norm_phi = np.sqrt(ds_quad * np.sum(np.abs(phi_vals)**2, axis=1))\n\n    # 3. Calculate sigma_min (smallest singular value of normalized matrix)\n    B_tilde = B / np.outer(norm_psi, norm_phi)\n    singular_values = np.linalg.svd(B_tilde, compute_uv=False)\n    sigma_min = np.min(singular_values) if singular_values.size > 0 else 0.0\n\n    # 4. Calculate rho (normalized residual ratio)\n    inv_norm_psi = 1.0 / norm_psi\n    \n    D_psi_inv_g = inv_norm_psi * g\n    D_psi_inv_B = inv_norm_psi[:, np.newaxis] * B\n    \n    # Solve the weighted least-squares problem: min || (D_psi_inv_B)c + (D_psi_inv_g) ||_2\n    _, residuals, _, _ = np.linalg.lstsq(D_psi_inv_B, -D_psi_inv_g, rcond=None)\n    \n    if residuals.size > 0:\n        min_residual_norm_sq = residuals[0]\n    else:\n        min_residual_norm_sq = 0.0\n    \n    min_residual_norm = np.sqrt(min_residual_norm_sq)\n    initial_residual_norm = np.linalg.norm(D_psi_inv_g)\n    \n    if initial_residual_norm  1e-15:\n        rho = 0.0\n    else:\n        rho = min_residual_norm / initial_residual_norm\n        \n    return sigma_min, rho\n\ndef solve():\n    \"\"\" Main function to run all test cases and print results. \"\"\"\n    test_cases = [\n        # Case 1: Balanced Petrov-Galerkin (PW/PW)\n        {'k': 10.0, 'theta0': 1.0,\n         'test_spec': ('plane_wave', 9, 2 * np.pi * np.arange(9) / 9),\n         'trial_spec': ('plane_wave', 9, 2 * np.pi * np.arange(9) / 9)},\n        # Case 2: Entire-domain trials, local tests (PW/Hat)\n        {'k': 10.0, 'theta0': 0.7,\n         'test_spec': ('hat', 16, None),\n         'trial_spec': ('plane_wave', 7, 2 * np.pi * np.arange(7) / 7)},\n        # Case 3: Local trials, entire-domain tests (Hat/PW)\n        {'k': 10.0, 'theta0': 0.7,\n         'test_spec': ('plane_wave', 7, 2 * np.pi * np.arange(7) / 7),\n         'trial_spec': ('hat', 16, None)},\n        # Case 4: Clustered entire-domain trials, local tests (PW-clustered/Hat)\n        {'k': 10.0, 'theta0': 0.3,\n         'test_spec': ('hat', 16, None),\n         'trial_spec': ('plane_wave', 7, 0.02 * np.arange(7))},\n    ]\n\n    results = []\n    for case in test_cases:\n        sigma_min, rho = calculate_metrics(\n            k=case['k'],\n            test_spec=case['test_spec'],\n            trial_spec=case['trial_spec'],\n            theta0=case['theta0']\n        )\n        results.extend([sigma_min, rho])\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3305810"}]}