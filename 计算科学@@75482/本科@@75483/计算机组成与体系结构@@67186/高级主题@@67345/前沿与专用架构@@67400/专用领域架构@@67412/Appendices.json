{"hands_on_practices": [{"introduction": "访问片外存储器（DRAM）既缓慢又耗能，是高性能计算的主要瓶颈。本练习将引导你运用一种基础而关键的优化技术——分块（Tiling），来最大限度地减少这种昂贵的数据移动。通过分析一个经典的矩阵乘法问题，你将推导出在有限的片上存储器（SRAM）约束下，能够实现最优数据复用的分块大小，这是设计任何高性能加速器都必须掌握的核心技能。[@problem_id:3636754]", "problem": "考虑一个专为维度为 $N$ 的大型方阵上的稠密矩阵乘法设计的专用领域架构（DSA），用于计算 $C = AB$，其中 $A$、$B$ 和 $C$ 是由8位整数组成的 $N \\times N$ 矩阵。该加速器拥有一个容量为 $S$ 字节的片上静态随机存取存储器（SRAM）暂存器，并与片外动态随机存取存储器（DRAM）通信。计算核心采用单级方形分块方案，块边长为 $T$。$A$、$B$ 和 $C$ 的 $T \\times T$ 形状的分块被调入暂存器并进行复用，同时一个 $T \\times T$ 的 $C$ 的输出分块在暂存器中进行累加。假设以下条件：\n\n- 每个元素为1字节，因此 $A$、$B$ 和 $C$ 的每个分块的内存占用均为 $T^2$ 字节。\n- 在生成一个 $T \\times T$ 的 $C$ 输出分块时，算法以分块为单位沿 $k$ 维度进行流式计算，在每个 $k$ 步加载一个来自 $A$ 的 $T \\times T$ 分块和一个来自 $B$ 的 $T \\times T$ 分块，并使对应的 $C$ 的 $T \\times T$ 分块驻留在SRAM中，直到其累加完成。\n- $C$ 的输出分块在片上初始化（无需从片外进行初始读取），并在累加完成后每个分块写回片外存储器一次。\n- 忽略控制开销、$N$ 不能整除时的边界分块以及双缓冲；将 $T$ 视为必须满足SRAM容量约束的正整数。\n\n从矩阵乘法的定义和单级分块下数据复用的第一性原理出发，推导以字节为单位的片外数据移动量 $B(T)$ 作为 $T$ 的函数，并证明 $B(T)$ 在所有可行 $T$ 上的单调性。利用SRAM容量约束和你的单调性论证，确定能使总片外字节数最小化的最优整数块边长 $T$。用一个关于 $S$ 的单一闭式解析表达式来表示你的最终答案。无需四舍五入，且你的答案应是无量纲的。", "solution": "该问题要求推导在专用领域架构（DSA）上执行的分块矩阵乘法算法中，能使片外数据移动最小化的最优整数块边长 $T$。推导过程必须从第一性原理出发。\n\n首先，我们建立总数据移动量 $B(T)$ 作为块边长 $T$ 的函数。计算过程是两个稠密 $N \\times N$ 矩阵的乘法，$C = AB$。元素是8位整数，这意味着每个元素占用1字节。\n\n该算法采用单级方形分块方案。$N \\times N$ 的矩阵被划分为大小为 $T \\times T$ 的分块。根据问题陈述，假设 $N$ 可以被 $T$ 整除，那么矩阵 $A$、$B$ 或 $C$ 中任意一个的总分块数为 $\\left(\\frac{N}{T}\\right) \\times \\left(\\frac{N}{T}\\right) = \\left(\\frac{N}{T}\\right)^2$。\n\n问题指定了“输出驻留”数据流。这意味着当一个 $T \\times T$ 的输出矩阵 $C$ 的分块在累加时，它会一直驻留在片上SRAM暂存器中。让我们分析计算一个这样的输出分块所需的数据移动。\n\n单个 $T \\times T$ 的 $C$ 分块（例如 $C_{ii,jj}$）的计算由对分块索引 $kk$ 的求和给出：\n$$C_{ii,jj} = \\sum_{kk=0}^{(N/T)-1} A_{ii,kk} B_{kk,jj}$$\n其中 $A_{ii,kk}$ 和 $B_{kk,jj}$ 是对应的 $T \\times T$ 输入分块。\n\n根据问题描述：\n$1.$ $C$ 的 $T \\times T$ 输出分块在片上初始化。在对所有 $N/T$ 个 $kk$ 值完成全部累加后，它被一次性写回到片外DRAM。由于每个元素是1字节，一个分块的大小是 $T^2$ 字节。这为这一个输出分块的总写入流量贡献了 $T^2$ 字节。\n$2.$ 对于累加过程中的每一步（即，对于从 $0$ 到 $(N/T)-1$ 的每个 $kk$ 值），一个 $A$ 的 $T \\times T$ 分块和一个 $B$ 的 $T \\times T$ 分块从DRAM加载到SRAM中。\n计算一个 $C$ 分块所需的总步数是 $N/T$。\n为一个 $C$ 分块从DRAM读取的数据量是步数乘以每步加载的数据量：\n$$ \\text{Read traffic per C tile} = \\frac{N}{T} \\times (\\text{size of A tile} + \\text{size of B tile}) = \\frac{N}{T} \\times (T^2 + T^2) = \\frac{N}{T} \\times 2T^2 = 2NT \\text{ bytes} $$\n因此，计算一个 $T \\times T$ 的 $C$ 分块的总片外数据移动（读取+写入）为 $2NT + T^2$ 字节。\n\n整个矩阵 $C$ 由 $(N/T)^2$ 个这样的分块组成。总数据移动量 $B(T)$ 是每个分块的移动量乘以总分块数：\n$$ B(T) = \\left(\\frac{N}{T}\\right)^2 \\times (2NT + T^2) $$\n$$ B(T) = \\frac{N^2}{T^2} (2NT) + \\frac{N^2}{T^2} (T^2) = \\frac{2N^3}{T} + N^2 $$\n\n接下来，我们必须考虑由片上SRAM容量 $S$ 施加的约束。该算法要求，在累加一个 $C$ 分块的任何时刻，暂存器都必须容纳用于 $C$ 的 $T \\times T$ 累加器、一个 $A$ 的 $T \\times T$ 分块和一个 $B$ 的 $T \\times T$ 分块。所需的总容量是这三个分块大小的总和。\n$$ \\text{SRAM requirement} = \\text{size}(A_{\\text{tile}}) + \\text{size}(B_{\\text{tile}}) + \\text{size}(C_{\\text{tile}}) $$\n$$ \\text{SRAM requirement} = T^2 + T^2 + T^2 = 3T^2 \\text{ bytes} $$\n这个所需容量不能超过可用的SRAM大小 $S$：\n$$ 3T^2 \\le S $$\n\n我们的目标是找到一个整数 $T$，它能在约束条件 $3T^2 \\le S$ 和 $T$ 为正整数的情况下，最小化 $B(T) = \\frac{2N^3}{T} + N^2$。\n\n为了确定 $B(T)$ 如何随 $T$ 变化，我们分析其单调性。为此，我们可以将 $T$ 视为一个连续的正变量。$B(T)$ 对 $T$ 的导数是：\n$$ \\frac{dB}{dT} = \\frac{d}{dT} \\left( \\frac{2N^3}{T} + N^2 \\right) = \\frac{d}{dT} (2N^3 T^{-1}) + \\frac{d}{dT} (N^2) $$\n$$ \\frac{dB}{dT} = -1 \\cdot 2N^3 T^{-2} + 0 = -\\frac{2N^3}{T^2} $$\n由于 $N$ 是问题维度，$N > 0$，而 $T$ 是块边长，$T > 0$。因此，$N^3 > 0$ 且 $T^2 > 0$。所以，导数 $\\frac{dB}{dT}$ 对所有可行的 $T$ 都是严格为负的。这证明了 $B(T)$ 是一个关于 $T$ 的严格单调递减函数。\n\n要最小化一个单调递减函数，必须为其参数选择可能的最大值。$T$ 的可行范围由SRAM容量约束 $3T^2 \\le S$ 定义。\n$$ T^2 \\le \\frac{S}{3} $$\n$$ T \\le \\sqrt{\\frac{S}{3}} $$\n由于 $T$ 必须是整数，最优的 $T$ 值是满足此不等式的最大整数。这是右侧表达式的向下取整。\n$$ T_{\\text{optimal}} = \\left\\lfloor \\sqrt{\\frac{S}{3}} \\right\\rfloor $$\n这个表达式以SRAM容量 $S$ 的闭式解析表达式的形式，给出了最优的整数块边长 $T$。", "answer": "$$\\boxed{\\left\\lfloor \\sqrt{\\frac{S}{3}} \\right\\rfloor}$$", "id": "3636754"}, {"introduction": "脉动阵列（Systolic Array）是一种强大的专用领域架构，但其固定的硬件结构带来了一个实际挑战：如何将任意尺寸的计算问题高效地映射上去？本练习将探讨处理单元（PE）利用率这一衡量加速器效率的关键指标。你将分析当矩阵维度与阵列尺寸不匹配时，计算资源是如何被浪费的，并由此推导出在该硬件上可实现的最大理论利用率。[@problem_id:3636753]", "problem": "专用领域架构（DSA）通过塑造其数据通路和内存层次结构以适应计算结构，从而专门用于加速一类狭义定义的计算。考虑一个固定空间维度为 $m \\times n$ 的脉动阵列（SA），用于加速通用矩阵乘法（GEMM），其中 $C = A \\cdot B$，$A \\in \\mathbb{R}^{r \\times k}$，$B \\in \\mathbb{R}^{k \\times c}$。该脉动阵列由 $m \\times n$ 个相同的处理单元（PE）组成。在标准数据流中，每个处理单元通过 $k$ 个乘累加步骤累加 $C$ 的一个元素，阵列执行一系列空间分块，直到产生 $C$ 的所有 $r \\times c$ 个输出。假设 $r$ 和 $c$ 分别不是 $m$ 和 $n$ 的倍数。\n\n将时间平均处理单元利用率定义为所有处理单元执行的有效乘累加操作总数与在整个 GEMM 上调度脉动阵列所消耗的总乘累加容量之比。假设以下几点，这与广泛使用的脉动阵列 GEMM 映射一致：\n- 每个空间分块都会为整个 $m \\times n$ 阵列调度 $k$ 个累加周期，无论在部分边缘分块中某些处理单元是否没有有效输出可产生。\n- 在 $k$ 个累加周期之外的控制和重构开销与 $k$ 相比可以忽略不计。\n- 数据传输被调度，以使每个分块的 $k$ 个累加周期不会因跨分块的流水线填充和排空效应而缩短或延长。\n\n从这些定义和 GEMM 的基本结构出发，推导当 $r$ 和 $c$ 不是 $m$ 和 $n$ 的倍数时的利用率。提出一种在固定的 $m \\times n$ 脉动阵列下最大化处理单元利用率的填充或分区方法，并将可实现的最大利用率表示为关于 $r$、$c$、$m$ 和 $n$ 的单一闭式解析表达式。你的最终答案必须是单一表达式。最终答案中不要提供中间公式。不需要四舍五入，最终答案中也不报告单位。", "solution": "该问题要求推导执行通用矩阵乘法（GEMM）的脉动阵列（SA）的时间平均处理单元（PE）利用率，并确定一种最大化该利用率的策略。\n\n首先，对给定问题进行验证。\n\n**步骤1：提取已知条件**\n- **架构**：一个固定空间维度为 $m \\times n$ 的脉动阵列（SA）。它由 $m \\times n$ 个相同的处理单元（PE）组成。\n- **计算**：通用矩阵乘法（GEMM），$C = A \\cdot B$。\n- **矩阵维度**：$A \\in \\mathbb{R}^{r \\times k}$ 和 $B \\in \\mathbb{R}^{k \\times c}$，得到 $C \\in \\mathbb{R}^{r \\times c}$。\n- **条件**：$r$ 不是 $m$ 的倍数，$c$ 不是 $n$ 的倍数。\n- **数据流**：每个处理单元通过 $k$ 个乘累加（MAC）步骤累加 $C$ 的一个元素。\n- **分块**：脉动阵列通过执行一系列大小为 $m \\times n$ 的空间分块来计算 $r \\times c$ 的输出矩阵 $C$。\n- **利用率定义**：时间平均处理单元利用率是有效 MAC 操作总数与消耗的总 MAC 容量之比。\n- **假设1**：每个空间分块，包括边缘的部分分块，都为整个 $m \\times n$ 阵列调度完整的 $k$ 个累加周期。\n- **假设2**：控制和重构开销可以忽略不计。\n- **假设3**：跨分块的数据传输流水线效应不会改变每个分块的 $k$ 个累加周期。\n\n**步骤2：使用提取的已知条件进行验证**\n- **科学依据**：该问题具有科学依据。用于 GEMM 的、采用输出固定分块的脉动阵列模型是计算机体系结构和高性能计算中的一个典型例子。关于调度部分分块和忽略开销的假设是对此类加速器进行性能建模时使用的标准简化方法。\n- **适定性**：该问题是适定的。定义、变量和约束条件都已明确陈述，可以导出一个唯一的解析解。目标定义清晰。\n- **客观性**：该问题以精确、客观的语言陈述，没有歧义或主观论断。\n\n**步骤3：结论与行动**\n- **结论**：该问题有效。它是专用领域架构分析中的一个标准的、可形式化的问题。\n- **行动**：继续推导解决方案。\n\n**处理单元利用率的推导**\n\n时间平均处理单元利用率 $U$ 定义为：\n$$U = \\frac{\\text{有效 MAC 操作总数}}{\\text{消耗的 MAC 总容量}}$$\n\n我们将分别推导分子和分母的表达式。\n\n**分子：有效 MAC 操作总数**\n计算过程为矩阵乘积 $C = A \\cdot B$，其中 $A$ 是一个 $r \\times k$ 矩阵，$B$ 是一个 $k \\times c$ 矩阵。得到的矩阵 $C$ 维度为 $r \\times c$。矩阵 $C$ 的每个元素 $C_{ij}$ 是 $A$ 的第 $i$ 行与 $B$ 的第 $j$ 列的内积：\n$$C_{ij} = \\sum_{p=1}^{k} A_{ip} B_{pj}$$\n对于输出矩阵 $C$ 中的 $r \\times c$ 个元素中的每一个，此计算需要 $k$ 次乘法和 $k-1$ 次加法。这对应于 $k$ 次乘累加（MAC）操作。\n因此，计算整个矩阵 $C$ 所需的有效 MAC 操作总数为：\n$$\\text{有效 MAC 总数} = (r \\times c) \\times k = rck$$\n\n**分母：消耗的 MAC 总容量**\n脉动阵列的维度为 $m \\times n$，它通过将 $r \\times c$ 的输出矩阵分解为大小为 $m \\times n$ 的分块来处理。\n要用高度为 $m$ 的分块覆盖矩阵 $C$ 的 $r$ 行，沿行维度所需的分块数量为 $\\lceil \\frac{r}{m} \\rceil$。\n同样，要用宽度为 $n$ 的分块覆盖矩阵 $C$ 的 $c$ 列，沿列维度所需的分块数量为 $\\lceil \\frac{c}{n} \\rceil$。\n覆盖整个 $r \\times c$ 输出空间所需的空间分块总数 $N_{\\text{tiles}}$ 是这两个量的乘积：\n$$N_{\\text{tiles}} = \\left\\lceil \\frac{r}{m} \\right\\rceil \\times \\left\\lceil \\frac{c}{n} \\right\\rceil$$\n根据问题的明确假设，每个分块（无论是完整分块还是部分边缘分块）都会占用整个 $m \\times n$ 处理单元阵列，持续时间为 $k$ 个 MAC 周期。\n脉动阵列执行单个分块的 MAC 容量是处理单元数量乘以周期数：\n$$\\text{每分块容量} = (m \\times n) \\times k = mnk$$\n整个 GEMM 操作消耗的总 MAC 容量是每分块容量乘以分块总数：\n$$\\text{消耗的 MAC 总容量} = N_{\\text{tiles}} \\times (\\text{每分块容量}) = \\left( \\left\\lceil \\frac{r}{m} \\right\\rceil \\left\\lceil \\frac{c}{n} \\right\\rceil \\right) (mnk)$$\n\n**利用率表达式与最大化**\n将分子和分母的表达式代入利用率公式：\n$$U = \\frac{rck}{mnk \\left\\lceil \\frac{r}{m} \\right\\rceil \\left\\lceil \\frac{c}{n} \\right\\rceil}$$\n项 $k$ 代表累加深度，在有效工作和每个分块消耗的容量中都是公因子，因此可以消掉：\n$$U = \\frac{rc}{mn \\left\\lceil \\frac{r}{m} \\right\\rceil \\left\\lceil \\frac{c}{n} \\right\\rceil}$$\n问题要求提出一种填充或分区方法来最大化此利用率。分子 $r \\times c$ 是给定问题实例的固定有效工作量。脉动阵列维度 $m$ 和 $n$ 也是固定的。要最大化 $U$，必须最小化分母。这等同于最小化对应于分块总数的项，$N_{\\text{tiles}} = \\lceil \\frac{r}{m} \\rceil \\lceil \\frac{c}{n} \\rceil$。\n\n覆盖一个 $r \\times c$ 区域所需的 $m \\times n$ 分块数量不能少于 $\\lceil \\frac{r}{m} \\rceil \\times \\lceil \\frac{c}{n} \\rceil$。任何“分区”方案都必须覆盖所有 $r \\times c$ 个输出，而任何将问题“填充”到新维度 $r' \\ge r$ 和 $c' \\ge c$ 的操作将导致分块数量为 $\\lceil \\frac{r'}{m} \\rceil \\lceil \\frac{c'}{n} \\rceil \\ge \\lceil \\frac{r}{m} \\rceil \\lceil \\frac{c}{n} \\rceil$。因此，超出向上取整函数所隐含边界的填充不会减少分块数量，因此不能提高利用率。\n\n因此，最优策略是分块公式所隐含的标准策略：在概念上将矩阵填充到脉动阵列维度的下一个整数倍的维度。也就是说，计算的结构就好像我们在计算一个大小为 $(m \\lceil \\frac{r}{m} \\rceil) \\times (n \\lceil \\frac{c}{n} \\rceil)$ 的输出矩阵。这种方法使用了最少可能数量的分块，从而最小化了消耗的总容量。\n\n因此，上面推导出的 $U$ 的表达式已经代表了在所述约束条件下的最大可实现利用率。\n\n最大可实现利用率的最终闭式解析表达式为：\n$$U_{\\text{max}} = \\frac{rc}{mn \\left\\lceil \\frac{r}{m} \\right\\rceil \\left\\lceil \\frac{c}{n} \\right\\rceil}$$\n这可以被因式分解以显示每个维度中不匹配的独立影响：\n$$U_{\\text{max}} = \\left( \\frac{r}{m \\left\\lceil \\frac{r}{m} \\right\\rceil} \\right) \\left( \\frac{c}{n \\left\\lceil \\frac{c}{n} \\right\\rceil} \\right)$$\n项 $m \\lceil \\frac{r}{m} \\rceil$ 是“填充后”的行维度，项 $n \\lceil \\frac{c}{n} \\rceil$ 是“填充后”的列维度。利用率是真实面积 $rc$ 与填充后面积 $(m \\lceil \\frac{r}{m} \\rceil)(n \\lceil \\frac{c}{n} \\rceil)$之比。", "answer": "$$\\boxed{\\frac{rc}{mn \\left\\lceil \\frac{r}{m} \\right\\rceil \\left\\lceil \\frac{c}{n} \\right\\rceil}}$$", "id": "3636753"}, {"introduction": "在真实世界的系统中，计算和数据传输必须被精心协同，以避免处理器停顿。这个高级练习将让你扮演系统架构师的角色，为一种模板（Stencil）计算设计数据流管道。你将运用双缓冲（Double Buffering）技术来隐藏直接存储器访问（DMA）的延迟，并求解能完美平衡计算与访存子系统、从而实现最高吞吐量的最小分块尺寸。[@problem_id:3636696]", "problem": "一个采用软件管理的暂存板内存的领域特定架构 (DSA) 处理一个二维网格，它使用一种模板计算，该模板要求每个计算块周围有一个宽度为 $h$ 的光环。该 DSA 有两个独立的直接内存访问 (DMA) 通道（一个用于输入，一个用于输出），每个通道的持续带宽为 $b$，每次传输的设置延迟为 $t_0$。暂存板被组织成一个双缓冲，以便在一个缓冲用于计算时，另一个缓冲可用于 DMA 传输下一个块的输入数据和上一个块的输出数据。每个网格点更新的计算受吞吐量限制，为每秒 $r$ 次更新。每个网格元素是一个大小为 $s$ 字节的字。模板要求块输入区域包含计算区域及其四周的光环。\n\n考虑在一个维度为 $N_x \\times N_y$ 的大网格上流式处理固定宽度为 $W$ 个元素的块（其中 $N_x$ 和 $N_y$ 足够大，以至于在稳态调度中可以忽略边界效应）。每个块处理 $W \\times H$ 个计算元素，并且必须读取 $(W + 2h) \\times (H + 2h)$ 个输入元素（以覆盖光环）并写回 $W \\times H$ 个输出元素。假设每个块的输入和输出传输都是通过每个通道每次传输一个块的单个 DMA 事务来执行的。\n\n参数:\n- 网格维度: $N_x = 8192$, $N_y = 8192$。\n- 光环宽度: $h = 2$。\n- 元素大小: $s = 8$ 字节。\n- 块宽度: $W = 512$。\n- 每个通道的 DMA 带宽: $b = 25 \\times 10^{9}$ 字节/秒。\n- 每次传输的 DMA 设置延迟: $t_0 = 2 \\times 10^{-6}$ 秒。\n- 计算吞吐量: $r = 2 \\times 10^{9}$ 元素更新/秒。\n\n任务:\n1. 使用第一性原理，推导出在双缓冲下保证 DMA 传输与计算完全重叠的不等式，并求解满足该不等式的最小块高度 $H_{\\min}$。将一个块的输入传输时间建模为 $T_{\\text{in}} = t_0 + \\frac{s (W + 2h)(H + 2h)}{b}$，输出传输时间建模为 $T_{\\text{out}} = t_0 + \\frac{s W H}{b}$。将计算时间建模为 $T_{\\text{comp}} = \\frac{W H}{r}$。完全重叠要求 $T_{\\text{comp}} \\ge \\max\\{T_{\\text{in}}, T_{\\text{out}}\\}$。\n2. 对于 $H = H_{\\min}$，量化计算期间每个缓冲器同时容纳输入区域（包括光环）和输出区域所需的暂存板容量，即 $S_{\\text{buffer}} = s \\left[ (W + 2h)(H + 2h) + W H \\right]$ 字节。同时报告双缓冲的总暂存板容量 $S_{\\text{total}} = 2 S_{\\text{buffer}}$。\n3. 将 $H_{\\min}$ 表示为一个无量纲整数，并将暂存板容量以千字节（KB）为单位表示，其中一千字节定义为 $1024$ 字节。将所有数值结果四舍五入到四位有效数字。\n\n你的最终答案必须是一个单行矩阵，按顺序包含 $H_{\\min}$、$S_{\\text{buffer}}$（单位为千字节）和 $S_{\\text{total}}$（单位为千字节）。", "solution": "该问题已经过验证，被认为是有效的。它具有科学依据，问题阐述清晰，并且为完整解答提供了所有必要的参数和模型。\n\n核心任务是找到最小的块高度 $H_{\\min}$，使得计算能够与 DMA 传输完全重叠。该架构使用双缓冲，这意味着当处理器在一个缓冲中对数据进行计算时，DMA 引擎可以为下一个块在另一个缓冲中进行数据的输入和输出传输。为了实现完全重叠，一个块的计算时间 $T_{\\text{comp}}$ 必须大于或等于数据传输所需的时间。不同块的输入和输出传输与计算是并行发生的，并且由于输入和输出有独立的通道，总传输时间由两次传输中较慢的一次决定。因此，完全重叠的条件表示为：\n$$\nT_{\\text{comp}} \\ge \\max\\{T_{\\text{in}}, T_{\\text{out}}\\}\n$$\n\n时间的表达式如下：\n- 计算时间: $T_{\\text{comp}} = \\frac{W H}{r}$\n- 输入传输时间: $T_{\\text{in}} = t_0 + \\frac{s (W + 2h)(H + 2h)}{b}$\n- 输出传输时间: $T_{\\text{out}} = t_0 + \\frac{s W H}{b}$\n\n在这里，$W$ 是块宽度，$H$ 是块高度，$r$ 是计算吞吐量，$t_0$ 是 DMA 设置延迟，$s$ 是元素大小，$h$ 是光环宽度，$b$ 是 DMA 通道带宽。\n\n首先，我们确定 $T_{\\text{in}}$ 和 $T_{\\text{out}}$ 哪个更大。让我们比较一下传输数据的大小。输入区域是 $(W + 2h) \\times (H + 2h)$ 个元素，而输出区域是 $W \\times H$ 个元素。由于 $W, H, h$ 都是正整数，我们有：\n$$\n(W + 2h)(H + 2h) = WH + 2hW + 2hH + 4h^2 > WH\n$$\n这意味着输入数据的量严格大于输出数据的量。因此，输入数据的传输时间将比输出数据的传输时间长，因为两者具有相同的设置延迟 $t_0$。\n$$\nT_{\\text{in}} > T_{\\text{out}}\n$$\n因此，完全重叠的条件简化为：\n$$\nT_{\\text{comp}} \\ge T_{\\text{in}}\n$$\n\n代入 $T_{\\text{comp}}$ 和 $T_{\\text{in}}$ 的表达式，我们得到主导不等式：\n$$\n\\frac{W H}{r} \\ge t_0 + \\frac{s (W + 2h)(H + 2h)}{b}\n$$\n我们需要解这个关于 $H$ 的不等式。让我们展开右边的项，并将包含 $H$ 的项组合在一起：\n$$\n\\frac{W H}{r} \\ge t_0 + \\frac{s}{b} (WH + 2hW + 2hH + 4h^2) \\\\\n\\frac{W H}{r} \\ge t_0 + \\frac{sWH}{b} + \\frac{2shH}{b} + \\frac{s(2hW + 4h^2)}{b}\n$$\n现在，我们将所有含 $H$ 的项收集到不等式的一侧：\n$$\n\\frac{W H}{r} - \\frac{sWH}{b} - \\frac{2shH}{b} \\ge t_0 + \\frac{s(2hW + 4h^2)}{b} \\\\\nH \\left( \\frac{W}{r} - \\frac{sW}{b} - \\frac{2sh}{b} \\right) \\ge t_0 + \\frac{s}{b}(2hW + 4h^2)\n$$\n该不等式的形式为 $H \\cdot C_1 \\ge C_2$。为了解出 $H$，我们必须首先确定系数 $C_1 = \\frac{W}{r} - \\frac{sW}{b} - \\frac{2sh}{b}$ 的符号。让我们代入给定的数值：\n- $W = 512$\n- $h = 2$\n- $s = 8 \\, \\text{字节}$\n- $b = 25 \\times 10^9 \\, \\text{字节/秒}$\n- $t_0 = 2 \\times 10^{-6} \\, \\text{秒}$\n- $r = 2 \\times 10^9 \\, \\text{更新/秒}$\n\n我们计算系数 $C_1$ 中的各项：\n$$\n\\frac{1}{r} = \\frac{1}{2 \\times 10^9} \\, \\text{秒/更新} = 0.5 \\times 10^{-9} \\, \\text{秒} \\\\\n\\frac{s}{b} = \\frac{8 \\, \\text{字节}}{25 \\times 10^9 \\, \\text{字节/秒}} = 0.32 \\times 10^{-9} \\, \\text{秒}\n$$\n由于 $\\frac{1}{r} > \\frac{s}{b}$，项 $W(\\frac{1}{r} - \\frac{s}{b})$ 为正，这表明在单个元素的基础上，计算比数据传输慢，从而使重叠成为可能。\n$H$ 的系数是：\n$$\nC_1 = W\\left(\\frac{1}{r} - \\frac{s}{b}\\right) - \\frac{2sh}{b} = 512(0.5 \\times 10^{-9} - 0.32 \\times 10^{-9}) - \\frac{2(8)(2)}{25 \\times 10^9} \\\\\nC_1 = 512(0.18 \\times 10^{-9}) - \\frac{32}{25 \\times 10^9} = (92.16 \\times 10^{-9}) - (1.28 \\times 10^{-9}) = 90.88 \\times 10^{-9} \\, \\text{秒}\n$$\n由于 $C_1$ 是正数，我们可以用它来除不等式两边而不改变不等号的方向：\n$$\nH \\ge \\frac{t_0 + \\frac{s}{b}(2hW + 4h^2)}{C_1}\n$$\n让我们计算分子 $C_2 = t_0 + \\frac{s}{b}(2hW + 4h^2)$：\n$$\nC_2 = 2 \\times 10^{-6} + (0.32 \\times 10^{-9})(2(2)(512) + 4(2^2)) \\\\\nC_2 = 2 \\times 10^{-6} + (0.32 \\times 10^{-9})(2048 + 16) \\\\\nC_2 = 2 \\times 10^{-6} + (0.32 \\times 10^{-9})(2064) = 2 \\times 10^{-6} + 660.48 \\times 10^{-9} \\\\\nC_2 = 2000 \\times 10^{-9} + 660.48 \\times 10^{-9} = 2660.48 \\times 10^{-9} \\, \\text{秒}\n$$\n现在我们求 $H$ 的下界：\n$$\nH \\ge \\frac{2660.48 \\times 10^{-9}}{90.88 \\times 10^{-9}} \\approx 29.2768\n$$\n由于块高度 $H$ 必须是网格元素的整数倍，因此 $H$ 的最小值是大于或等于此下界的最小整数。\n$$\nH_{\\min} = \\lceil 29.2768 \\rceil = 30\n$$\n\n接下来，我们使用 $H = H_{\\min} = 30$ 来计算每个缓冲所需的暂存板内存容量 $S_{\\text{buffer}}$ 和双缓冲的总容量 $S_{\\text{total}}$。单个缓冲容量的公式如下：\n$$\nS_{\\text{buffer}} = s \\left[ (W + 2h)(H + 2h) + W H \\right]\n$$\n代入已知值：\n$$\nW + 2h = 512 + 2(2) = 516 \\\\\nH_{\\min} + 2h = 30 + 2(2) = 34\n$$\n输入区域的元素数量为 $(516)(34) = 17544$。输出区域的元素数量为 $W H_{\\min} = 512 \\times 30 = 15360$。\n$$\nS_{\\text{buffer}} = 8 \\, \\text{字节} \\times (17544 + 15360) = 8 \\times 32904 = 263232 \\, \\text{字节}\n$$\n总暂存板容量是两个这样缓冲区的容量之和：\n$$\nS_{\\text{total}} = 2 \\times S_{\\text{buffer}} = 2 \\times 263232 = 526464 \\, \\text{字节}\n$$\n\n最后，我们将容量转换为千字节（其中 $1 \\, \\text{KB} = 1024 \\, \\text{bytes}$），并四舍五入到四位有效数字。\n$$\nS_{\\text{buffer}} = \\frac{263232}{1024} \\, \\text{KB} = 257.0625 \\, \\text{KB} \\approx 257.1 \\, \\text{KB}\n$$\n$$\nS_{\\text{total}} = \\frac{526464}{1024} \\, \\text{KB} = 514.125 \\, \\text{KB} \\approx 514.1 \\, \\text{KB}\n$$\n所要求的三个值是 $H_{\\min}=30$，$S_{\\text{buffer}} \\approx 257.1 \\, \\text{KB}$，以及 $S_{\\text{total}} \\approx 514.1 \\, \\text{KB}$。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n30 & 257.1 & 514.1\n\\end{pmatrix}\n}\n$$", "id": "3636696"}]}