{
    "hands_on_practices": [
        {
            "introduction": "Before implementing adjoint methods numerically, it is crucial to grasp their formulation in a continuous setting. This foundational exercise guides you through the derivation of adjoint sensitivities for a system governed by the frequency-domain Maxwell's equations with a dispersive material model. Mastering this \"pen-and-paper\" derivation will build the essential intuition for correctly formulating adjoint problems in diverse physical contexts. ",
            "id": "3288658",
            "problem": "Consider a linear, isotropic, source-driven, time-harmonic electromagnetic field in a bounded domain $\\Omega \\subset \\mathbb{R}^{3}$ with outward unit normal and impedance boundary conditions on $\\partial \\Omega$. Assume the $\\exp(i \\omega t)$ time convention. At each angular frequency $\\omega$, the electric field $\\mathbf{E}(\\mathbf{r},\\omega)$ satisfies the frequency-domain curl-curl equation derived from Maxwell’s equations,\n$$\n\\nabla \\times \\mu^{-1}(\\mathbf{r}) \\nabla \\times \\mathbf{E}(\\mathbf{r},\\omega) - \\omega^{2} \\epsilon(\\mathbf{r},\\omega) \\mathbf{E}(\\mathbf{r},\\omega) = i \\omega \\mathbf{J}_{\\mathrm{s}}(\\mathbf{r},\\omega),\n$$\nwhere $\\mu(\\mathbf{r})$ is the magnetic permeability, $\\epsilon(\\mathbf{r},\\omega)$ is the electric permittivity, and $\\mathbf{J}_{\\mathrm{s}}(\\mathbf{r},\\omega)$ is a given source current density. Suppose the material permittivity follows a single-pole Debye dispersion within a subregion that coincides with $\\Omega$, given by\n$$\n\\epsilon(\\mathbf{r},\\omega) = \\epsilon_{\\infty}(\\mathbf{r}) + \\frac{\\Delta \\epsilon(\\mathbf{r})}{1 + i \\omega \\tau(\\mathbf{r})},\n$$\nwith $\\epsilon_{\\infty}(\\mathbf{r}) > 0$, $\\Delta \\epsilon(\\mathbf{r}) \\ge 0$, and $\\tau(\\mathbf{r}) > 0$. For this problem, assume $\\Delta \\epsilon(\\mathbf{r})$ and $\\tau(\\mathbf{r})$ are spatially uniform in $\\Omega$ (that is, independent of $\\mathbf{r}$) but otherwise unknown scalars to be determined by optimization, while $\\epsilon_{\\infty}(\\mathbf{r})$ and $\\mu(\\mathbf{r})$ are known, real, and strictly positive functions.\n\nLet $\\{\\omega_{k}\\}_{k=1}^{K}$ be a finite set of positive angular frequencies. The electric field $\\mathbf{E}(\\mathbf{r},\\omega_{k})$ is the solution to the forward problem at each $\\omega_{k}$. Define the objective functional\n$$\nJ(\\Delta \\epsilon,\\tau) = \\frac{1}{2} \\sum_{k=1}^{K} \\int_{\\Omega} w(\\mathbf{r},\\omega_{k}) \\left| \\mathbf{E}(\\mathbf{r},\\omega_{k}) - \\mathbf{E}_{\\mathrm{t}}(\\mathbf{r},\\omega_{k}) \\right|^{2} \\, d\\mathbf{r},\n$$\nwhere $w(\\mathbf{r},\\omega_{k}) \\ge 0$ is a real-valued weighting function and $\\mathbf{E}_{\\mathrm{t}}(\\mathbf{r},\\omega_{k})$ is a given real or complex target field distribution. The dependence of $J$ on $(\\Delta \\epsilon,\\tau)$ arises through the state $\\mathbf{E}$ via the forward constraint.\n\nUsing the adjoint-state method in the frequency domain, derive analytic expressions for the sensitivities $\\partial J / \\partial \\Delta \\epsilon$ and $\\partial J / \\partial \\tau$ in terms of the forward fields $\\mathbf{E}(\\mathbf{r},\\omega_{k})$, adjoint fields $\\boldsymbol{\\lambda}(\\mathbf{r},\\omega_{k})$, and the material parameters. Your derivation must start from the fundamental laws stated above, and must explicitly account for the influence of $\\partial \\epsilon / \\partial p$ (with $p \\in \\{\\Delta \\epsilon,\\tau\\}$) on the frequency-domain operator that maps fields to sources. Assume the adjoint field at each $\\omega_{k}$ satisfies the appropriate complex-conjugate-transpose adjoint equation consistent with the standard $L^{2}$ Hermitian inner product on vector fields over $\\Omega$.\n\nExpress your final result as a single closed-form analytic expression for the two-component gradient vector $\\left( \\partial J / \\partial \\Delta \\epsilon, \\, \\partial J / \\partial \\tau \\right)$, using an integral form over $\\Omega$ and a sum over the discrete set of frequencies $\\{\\omega_{k}\\}_{k=1}^{K}$. No numerical evaluation is required. No rounding is required. Do not include physical units in your final expression.",
            "solution": "The frequency-domain curl-curl equation following from Maxwell’s equations under the $\\exp(i \\omega t)$ convention is\n$$\n\\nabla \\times \\mu^{-1}(\\mathbf{r}) \\nabla \\times \\mathbf{E}(\\mathbf{r},\\omega) - \\omega^{2} \\epsilon(\\mathbf{r},\\omega) \\mathbf{E}(\\mathbf{r},\\omega) = i \\omega \\mathbf{J}_{\\mathrm{s}}(\\mathbf{r},\\omega).\n$$\nWe denote the linear operator\n$$\n\\mathcal{A}(\\omega; \\Delta \\epsilon,\\tau)\\mathbf{E} := \\nabla \\times \\mu^{-1}(\\mathbf{r}) \\nabla \\times \\mathbf{E}(\\mathbf{r},\\omega) - \\omega^{2} \\epsilon(\\mathbf{r},\\omega) \\mathbf{E}(\\mathbf{r},\\omega),\n$$\nso the forward constraint is\n$$\n\\mathcal{A}(\\omega; \\Delta \\epsilon,\\tau)\\mathbf{E}(\\mathbf{r},\\omega) = i \\omega \\mathbf{J}_{\\mathrm{s}}(\\mathbf{r},\\omega).\n$$\nThe objective functional is\n$$\nJ(\\Delta \\epsilon,\\tau) = \\frac{1}{2} \\sum_{k=1}^{K} \\int_{\\Omega} w(\\mathbf{r},\\omega_{k}) \\left| \\mathbf{E}(\\mathbf{r},\\omega_{k}) - \\mathbf{E}_{\\mathrm{t}}(\\mathbf{r},\\omega_{k}) \\right|^{2} \\, d\\mathbf{r}.\n$$\nWe adopt the standard $L^{2}$ Hermitian inner product for complex vector fields,\n$$\n\\langle \\mathbf{u}, \\mathbf{v} \\rangle := \\int_{\\Omega} \\mathbf{u}^{*}(\\mathbf{r}) \\cdot \\mathbf{v}(\\mathbf{r}) \\, d\\mathbf{r},\n$$\nwith the superscript $^{*}$ denoting complex conjugation and $\\,\\cdot\\,$ the Euclidean dot product on $\\mathbb{C}^{3}$.\n\nWe seek the sensitivities $\\partial J / \\partial p$ for $p \\in \\{\\Delta \\epsilon,\\tau\\}$. The dependence of $J$ on $p$ is implicit through the state $\\mathbf{E}$, which satisfies $\\mathcal{A}(\\omega;p)\\mathbf{E}(\\omega) = i\\omega \\mathbf{J}_{\\mathrm{s}}(\\omega)$, where we suppress $\\mathbf{r}$ in the notation for brevity. Differentiating the forward constraint with respect to $p$ gives the first-order variation\n$$\n\\mathcal{A}(\\omega;p)\\,\\delta \\mathbf{E}(\\omega) + \\left( \\frac{\\partial \\mathcal{A}(\\omega;p)}{\\partial p} \\right) \\mathbf{E}(\\omega) \\, \\delta p = \\mathbf{0}.\n$$\nWe also compute the first variation of $J$,\n$$\n\\delta J = \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} w(\\mathbf{r},\\omega_{k}) \\left( \\mathbf{E}(\\mathbf{r},\\omega_{k}) - \\mathbf{E}_{\\mathrm{t}}(\\mathbf{r},\\omega_{k}) \\right) \\cdot \\delta \\mathbf{E}^{*}(\\mathbf{r},\\omega_{k}) \\, d\\mathbf{r} \\right\\},\n$$\nwhere $\\Re\\{\\cdot\\}$ denotes the real part, and we have used that $J$ is real-valued and quadratic in the field mismatch.\n\nTo eliminate the dependence on $\\delta \\mathbf{E}$, we introduce the adjoint field $\\boldsymbol{\\lambda}(\\mathbf{r},\\omega)$ at each $\\omega$ by requiring it to satisfy the adjoint equation\n$$\n\\mathcal{A}^{\\dagger}(\\omega;p)\\,\\boldsymbol{\\lambda}(\\mathbf{r},\\omega) = w(\\mathbf{r},\\omega) \\left( \\mathbf{E}(\\mathbf{r},\\omega) - \\mathbf{E}_{\\mathrm{t}}(\\mathbf{r},\\omega) \\right),\n$$\nwhere $\\mathcal{A}^{\\dagger}$ denotes the adjoint operator under the chosen Hermitian inner product. For the operator\n$$\n\\mathcal{A}(\\omega;p) = \\nabla \\times \\mu^{-1}(\\mathbf{r}) \\nabla \\times \\,\\cdot\\, - \\omega^{2} \\epsilon(\\mathbf{r},\\omega;p)\\, \\mathrm{Id},\n$$\nwith real $\\mu(\\mathbf{r})$ and real $\\epsilon_{\\infty}(\\mathbf{r})$ and the Debye $\\epsilon(\\mathbf{r},\\omega;p)$ possibly complex-valued, the adjoint under the $L^{2}$ Hermitian inner product takes the form\n$$\n\\mathcal{A}^{\\dagger}(\\omega;p) = \\nabla \\times \\mu^{-1}(\\mathbf{r}) \\nabla \\times \\,\\cdot\\, - \\omega^{2} \\epsilon^{*}(\\mathbf{r},\\omega;p)\\, \\mathrm{Id},\n$$\nsubject to the same boundary conditions, since the curl-curl operator is self-adjoint for real $\\mu(\\mathbf{r})$ under the assumed boundary conditions.\n\nBy duality, we multiply the linearized constraint by $\\boldsymbol{\\lambda}^{*}$ in the inner product and use the adjoint equation to write\n$$\n0 = \\langle \\boldsymbol{\\lambda}, \\mathcal{A}(\\omega;p)\\,\\delta \\mathbf{E} \\rangle + \\left\\langle \\boldsymbol{\\lambda}, \\left( \\frac{\\partial \\mathcal{A}(\\omega;p)}{\\partial p} \\right) \\mathbf{E} \\right\\rangle \\delta p\n= \\langle \\mathcal{A}^{\\dagger}(\\omega;p)\\,\\boldsymbol{\\lambda}, \\delta \\mathbf{E} \\rangle + \\left\\langle \\boldsymbol{\\lambda}, \\left( \\frac{\\partial \\mathcal{A}(\\omega;p)}{\\partial p} \\right) \\mathbf{E} \\right\\rangle \\delta p.\n$$\nUsing the adjoint definition $\\mathcal{A}^{\\dagger}(\\omega;p)\\,\\boldsymbol{\\lambda} = w(\\mathbf{r},\\omega) \\left( \\mathbf{E} - \\mathbf{E}_{\\mathrm{t}} \\right)$ and comparing with $\\delta J$, we obtain\n$$\n\\delta J = \\sum_{k=1}^{K} \\Re \\left\\{ \\langle w(\\mathbf{r},\\omega_{k})(\\mathbf{E} - \\mathbf{E}_{\\mathrm{t}}), \\delta \\mathbf{E} \\rangle \\right\\}\n= \\sum_{k=1}^{K} \\Re \\left\\{ \\langle \\mathcal{A}^{\\dagger}(\\omega_{k};p)\\,\\boldsymbol{\\lambda}(\\omega_{k}), \\delta \\mathbf{E}(\\omega_{k}) \\rangle \\right\\}.\n$$\nTherefore,\n$$\n\\delta J = - \\sum_{k=1}^{K} \\Re \\left\\{ \\left\\langle \\boldsymbol{\\lambda}(\\omega_{k}), \\left( \\frac{\\partial \\mathcal{A}(\\omega_{k};p)}{\\partial p} \\right) \\mathbf{E}(\\omega_{k}) \\right\\rangle \\right\\} \\delta p,\n$$\nwhich yields the adjoint-state sensitivity formula\n$$\n\\frac{\\partial J}{\\partial p} = - \\sum_{k=1}^{K} \\Re \\left\\{ \\left\\langle \\boldsymbol{\\lambda}(\\omega_{k}), \\left( \\frac{\\partial \\mathcal{A}(\\omega_{k};p)}{\\partial p} \\right) \\mathbf{E}(\\omega_{k}) \\right\\rangle \\right\\}.\n$$\nWe now compute $\\partial \\mathcal{A} / \\partial p$ explicitly. The operator depends on $\\epsilon(\\mathbf{r},\\omega;p)$ only via the term $-\\omega^{2} \\epsilon(\\mathbf{r},\\omega;p)\\,\\mathrm{Id}$. Thus,\n$$\n\\frac{\\partial \\mathcal{A}(\\omega;p)}{\\partial p} = - \\omega^{2} \\left( \\frac{\\partial \\epsilon(\\mathbf{r},\\omega;p)}{\\partial p} \\right) \\mathrm{Id}.\n$$\nFor the Debye model\n$$\n\\epsilon(\\mathbf{r},\\omega;p) = \\epsilon_{\\infty}(\\mathbf{r}) + \\frac{\\Delta \\epsilon}{1 + i \\omega \\tau},\n$$\nwith $\\Delta \\epsilon$ and $\\tau$ uniform in $\\Omega$, we have the parameter derivatives\n$$\n\\frac{\\partial \\epsilon(\\mathbf{r},\\omega;p)}{\\partial \\Delta \\epsilon} = \\frac{1}{1 + i \\omega \\tau}, \\qquad\n\\frac{\\partial \\epsilon(\\mathbf{r},\\omega;p)}{\\partial \\tau} = \\Delta \\epsilon \\frac{\\partial}{\\partial \\tau} \\left( \\frac{1}{1 + i \\omega \\tau} \\right) = - \\frac{i \\omega \\Delta \\epsilon}{(1 + i \\omega \\tau)^{2}}.\n$$\nTherefore,\n$$\n\\frac{\\partial \\mathcal{A}(\\omega;\\Delta \\epsilon,\\tau)}{\\partial \\Delta \\epsilon} = - \\omega^{2} \\frac{1}{1 + i \\omega \\tau}\\, \\mathrm{Id}, \\qquad\n\\frac{\\partial \\mathcal{A}(\\omega;\\Delta \\epsilon,\\tau)}{\\partial \\tau} = - \\omega^{2} \\left( - \\frac{i \\omega \\Delta \\epsilon}{(1 + i \\omega \\tau)^{2}} \\right) \\mathrm{Id}\n= \\frac{i \\omega^{3} \\Delta \\epsilon}{(1 + i \\omega \\tau)^{2}}\\, \\mathrm{Id}.\n$$\nPlugging these into the sensitivity formula, and writing the inner product explicitly, we obtain\n$$\n\\frac{\\partial J}{\\partial \\Delta \\epsilon}\n= - \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\left[ - \\omega_{k}^{2} \\frac{1}{1 + i \\omega_{k} \\tau} \\mathbf{E}(\\mathbf{r},\\omega_{k}) \\right] \\, d\\mathbf{r} \\right\\}\n= \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\omega_{k}^{2} \\frac{1}{1 + i \\omega_{k} \\tau} \\, \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\mathbf{E}(\\mathbf{r},\\omega_{k}) \\, d\\mathbf{r} \\right\\},\n$$\nand\n$$\n\\frac{\\partial J}{\\partial \\tau}\n= - \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\left[ \\frac{i \\omega_{k}^{3} \\Delta \\epsilon}{(1 + i \\omega_{k} \\tau)^{2}} \\mathbf{E}(\\mathbf{r},\\omega_{k}) \\right] \\, d\\mathbf{r} \\right\\}\n= - \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\frac{i \\omega_{k}^{3} \\Delta \\epsilon}{(1 + i \\omega_{k} \\tau)^{2}} \\, \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\mathbf{E}(\\mathbf{r},\\omega_{k}) \\, d\\mathbf{r} \\right\\}.\n$$\nWe can equivalently present $\\partial J / \\partial \\tau$ as\n$$\n\\frac{\\partial J}{\\partial \\tau}\n= \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\omega_{k}^{2} \\left( - \\frac{\\partial \\epsilon(\\omega_{k})}{\\partial \\tau} \\right) \\boldsymbol{\\lambda}^{*} \\cdot \\mathbf{E} \\, d\\mathbf{r} \\right\\}\n= \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\frac{i \\omega_{k}^{3} \\Delta \\epsilon}{(1 + i \\omega_{k} \\tau)^{2}} \\, \\boldsymbol{\\lambda}^{*} \\cdot \\mathbf{E} \\, d\\mathbf{r} \\right\\},\n$$\nwhich matches the previous expression up to the explicit negative sign in the operator derivative. The adjoint field $\\boldsymbol{\\lambda}(\\mathbf{r},\\omega_{k})$ is determined by solving\n$$\n\\nabla \\times \\mu^{-1}(\\mathbf{r}) \\nabla \\times \\boldsymbol{\\lambda}(\\mathbf{r},\\omega_{k}) - \\omega_{k}^{2} \\epsilon^{*}(\\mathbf{r},\\omega_{k}) \\boldsymbol{\\lambda}(\\mathbf{r},\\omega_{k})\n= w(\\mathbf{r},\\omega_{k}) \\left( \\mathbf{E}(\\mathbf{r},\\omega_{k}) - \\mathbf{E}_{\\mathrm{t}}(\\mathbf{r},\\omega_{k}) \\right),\n$$\nwith the same boundary conditions as the forward problem, ensuring the adjoint-state method consistently accounts for the dependence of the operator on the dispersive permittivity.\n\nCollecting the two sensitivities into a row vector, the gradient is\n$$\n\\left( \\frac{\\partial J}{\\partial \\Delta \\epsilon}, \\, \\frac{\\partial J}{\\partial \\tau} \\right)\n= \\left( \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\omega_{k}^{2} \\frac{ \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\mathbf{E}(\\mathbf{r},\\omega_{k}) }{1 + i \\omega_{k} \\tau} \\, d\\mathbf{r} \\right\\}, \\;\n- \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\frac{i \\omega_{k}^{3} \\Delta \\epsilon}{(1 + i \\omega_{k} \\tau)^{2}} \\, \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\mathbf{E}(\\mathbf{r},\\omega_{k}) \\, d\\mathbf{r} \\right\\} \\right).\n$$\nThis expression explicitly incorporates the effect of $\\partial \\epsilon / \\partial p$ on the operator $\\mathcal{A}$ and yields the desired frequency-domain adjoint sensitivities for the Debye dispersion parameters.",
            "answer": "$$\\boxed{\\begin{pmatrix}\n\\displaystyle \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\omega_{k}^{2} \\frac{ \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\mathbf{E}(\\mathbf{r},\\omega_{k}) }{1 + i \\omega_{k} \\tau} \\, d\\mathbf{r} \\right\\} &\n\\displaystyle - \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\frac{i \\omega_{k}^{3} \\Delta \\epsilon}{(1 + i \\omega_{k} \\tau)^{2}} \\, \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\mathbf{E}(\\mathbf{r},\\omega_{k}) \\, d\\mathbf{r} \\right\\}\n\\end{pmatrix}}$$"
        },
        {
            "introduction": "Transitioning from continuous theory to discrete computation requires a critical validation step to ensure correctness. This practice focuses on implementing the adjoint method for a discretized wave equation and verifying the resulting gradient using a finite-difference test. Completing this exercise will equip you with the indispensable skill of not only calculating sensitivities but also building confidence in their accuracy, a vital prerequisite for any reliable design optimization. ",
            "id": "3288672",
            "problem": "Consider a two-dimensional scalar frequency-domain wave model that arises from simplifying Maxwell’s equations under transverse-magnetic polarization to a scalar Helmholtz-type equation on a square domain with homogeneous Dirichlet boundary conditions. Let the computational domain be discretized as an $N \\times N$ grid of interior nodes with grid spacing $\\Delta x$, so that the discrete negative Laplacian $L \\in \\mathbb{R}^{n \\times n}$ with $n = N^2$ is given by the standard five-point stencil. Define the parameter-dependent system matrix as\n$$\nA(\\varepsilon) \\;=\\; L \\;+\\; \\omega^2 \\operatorname{diag}(\\varepsilon),\n$$\nwhere $\\varepsilon \\in \\mathbb{R}^n$ is the spatially varying permittivity at the grid nodes and $\\omega$ is the angular frequency. For a fixed real-valued source vector $b \\in \\mathbb{R}^n$, the state $u(\\varepsilon) \\in \\mathbb{R}^n$ satisfies the linear system\n$$\nA(\\varepsilon)\\, u(\\varepsilon) \\;=\\; b.\n$$\nConsider the scalar objective functional\n$$\nJ(u) \\;=\\; \\tfrac{1}{2}\\,\\lVert B\\,u \\rVert_2^2,\n$$\nwhere $B \\in \\mathbb{R}^{m \\times n}$ is a linear measurement operator that selects specified grid nodes (for instance, a single “sensor” node).\n\nYou will validate the adjoint-state gradient of $J$ with respect to a localized permittivity parameter $p$ corresponding to a single voxel (grid node) index $i_0$. The verification uses a finite-difference test to demonstrate asymptotic agreement.\n\nYour tasks:\n\n- Starting from the discrete forward model $A(\\varepsilon)\\,u = b$ and the definition of $J(u)$, derive from first principles the adjoint-state method for the sensitivity $\\partial J/\\partial p$, where $p$ is the value of $\\varepsilon$ at voxel $i_0$. Use only the chain rule, properties of linear systems, and inner-product duality; do not assume any pre-derived gradient formula.\n- Specify an error metric that compares the adjoint prediction of the first-order variation of $J$ against a symmetric finite-difference evaluation. The metric must be dimensionless and must reveal the asymptotic agreement with decreasing step size $h$.\n- Choose a concrete, fully specified test as follows:\n  - Use $N = 30$ and $\\Delta x = 1$ so that $n = N^2 = 900$.\n  - Use the discrete negative Laplacian $L$ formed by the five-point stencil: each interior node has a main diagonal entry $4/\\Delta x^2$ and four nearest-neighbor off-diagonals $-1/\\Delta x^2$.\n  - Set $\\omega = 4$ (in radians per second). Since the final requested outputs are dimensionless error metrics, no unit conversion is required in the outputs.\n  - Use a uniform background permittivity $\\varepsilon_{\\mathrm{bg}} = 1$, i.e., $\\varepsilon = \\varepsilon_{\\mathrm{bg}} \\mathbf{1}$, except for the voxel $i_0$ used for the finite-difference perturbations.\n  - Place a unit-amplitude point source at grid index $(i_s, j_s) = (\\lfloor N/3 \\rfloor, \\lfloor N/3 \\rfloor)$ by setting the corresponding entry of $b$ to $1$ and all others to $0$.\n  - Define the measurement operator $B$ to pick a single sensor node at $(i_r, j_r) = (2\\lfloor N/3 \\rfloor, 2\\lfloor N/3 \\rfloor)$, so $m = 1$ and $J(u) = \\tfrac{1}{2} \\, |u_{i_r,j_r}|^2$.\n  - Choose the parameter voxel index $i_0$ to be the central grid node $(\\lfloor N/2 \\rfloor, \\lfloor N/2 \\rfloor)$.\n- Implement a program that:\n  - Builds $L$ and, for each required permittivity, forms $A(\\varepsilon)$ and solves for $u$.\n  - Forms and solves the adjoint system implied by your derivation to obtain the adjoint state and the gradient component $\\partial J/\\partial p$ at voxel $i_0$.\n  - For each finite-difference step size $h$ in the test suite $h \\in \\{10^{-1}, 10^{-2}, 10^{-3}, 10^{-4}, 10^{-5}\\}$ (with $h$ interpreted as an absolute perturbation of the voxel permittivity, which is dimensionless in this setup), computes the symmetric difference\n    $$\n    \\Delta J_{\\mathrm{fd}}(h) \\;=\\; J\\big(u(\\varepsilon + h\\,e_{i_0})\\big) \\;-\\; J\\big(u(\\varepsilon - h\\,e_{i_0})\\big),\n    $$\n    where $e_{i_0}$ is the standard basis vector at index $i_0$, and compares it to the adjoint first-order prediction $2h\\,(\\partial J/\\partial p)$.\n  - Uses the following error metric for each $h$:\n    $$\n    r(h) \\;=\\; \\frac{\\big|\\Delta J_{\\mathrm{fd}}(h) \\;-\\; 2h\\,(\\partial J/\\partial p)\\big|}{\\max\\!\\big(10^{-14}, \\, \\big|\\Delta J_{\\mathrm{fd}}(h)\\big|\\big)}.\n    $$\n    This metric is dimensionless and should decay with $h$ in the asymptotic regime before round-off error dominates.\n- Output specification: Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of the provided test-suite step sizes $[10^{-1},10^{-2},10^{-3},10^{-4},10^{-5}]$. Each entry must be the floating-point value of $r(h)$ for the corresponding $h$, with no units.\n\nYour submission must be a complete, runnable program that constructs the linear systems, computes the forward and adjoint solutions, evaluates the gradient and the finite-difference tests for the specified step sizes, and prints the resulting list in the exact format described above. No user input is permitted. The result values are pure numbers (dimensionless). The design must ensure scientific realism and numerical plausibility for the specified configuration, and the derivation must begin from the stated discrete model and objective without using pre-derived sensitivity formulas.",
            "solution": "### First-Principles Derivation of the Adjoint-State Gradient\n\nThe problem is defined by the following equations:\n1.  State Equation: $A(\\varepsilon) u(\\varepsilon) = b$, where $A(\\varepsilon) = L + \\omega^2 \\operatorname{diag}(\\varepsilon)$.\n2.  Objective Functional: $J(u) = \\frac{1}{2} \\|Bu\\|_2^2$.\n\nLet the parameter of interest, $p$, be the permittivity at a single grid node $i_0$, so $p = \\varepsilon_{i_0}$. We seek the total derivative of $J$ with respect to $p$, denoted $\\frac{dJ}{dp}$.\n\nApplying the chain rule, the derivative of $J$ with respect to $p$ is:\n$$\n\\frac{dJ}{dp} = \\left(\\nabla_u J\\right)^T \\frac{du}{dp}\n$$\nwhere $\\nabla_u J \\in \\mathbb{R}^n$ is the gradient of $J$ with respect to the state vector $u$, and $\\frac{du}{dp} \\in \\mathbb{R}^n$ is the sensitivity of the state with respect to the parameter $p$.\n\nTo find an expression for $\\frac{du}{dp}$, we differentiate the state equation with respect to $p$. Since the source term $b$ is independent of $p$, its derivative is zero:\n$$\n\\frac{d}{dp} \\left( A(\\varepsilon(p)) u(\\varepsilon(p)) \\right) = \\frac{db}{dp} = 0\n$$\n$$\n\\frac{dA}{dp} u + A \\frac{du}{dp} = 0\n$$\nSolving for the state sensitivity $\\frac{du}{dp}$ yields:\n$$\n\\frac{du}{dp} = -A^{-1} \\frac{dA}{dp} u\n$$\nSubstituting this back into the expression for $\\frac{dJ}{dp}$:\n$$\n\\frac{dJ}{dp} = -(\\nabla_u J)^T A^{-1} \\frac{dA}{dp} u\n$$\nThe term $(\\nabla_u J)^T A^{-1}$ can be computationally demanding. The adjoint method reorders the computation. Using the property that for an invertible matrix $A$, $(A^{-1})^T=(A^T)^{-1}$, we can rewrite the expression as:\n$$\n\\frac{dJ}{dp} = - \\left( (A^T)^{-1} \\nabla_u J \\right)^T \\frac{dA}{dp} u\n$$\nWe now define the adjoint state vector $\\lambda \\in \\mathbb{R}^n$ as the solution to the adjoint equation:\n$$\nA^T \\lambda = \\nabla_u J\n$$\nSubstituting $\\lambda = (A^T)^{-1} \\nabla_u J$ into the gradient expression, we obtain the adjoint formulation for the gradient:\n$$\n\\frac{dJ}{dp} = -\\lambda^T \\frac{dA}{dp} u\n$$\nThis formulation is computationally efficient. It requires solving one forward linear system for $u$, one adjoint linear system for $\\lambda$, and then computing the gradient via a vector product for each parameter of interest.\n\nNow we specialize this general result to the given problem:\n-   **Objective Gradient $\\nabla_u J$**: The objective is $J(u) = \\frac{1}{2} u^T B^T B u$. Its gradient with respect to $u$ is $\\nabla_u J = B^T B u$. In our specific case, $B$ selects a single node $i_r$, so $B = e_{i_r}^T$. Thus, $B^T B = e_{i_r}e_{i_r}^T$, a matrix that is zero except for a $1$ at the $(i_r, i_r)$ diagonal position. The product $B^T B u$ is a vector that is zero everywhere except at index $i_r$, where it has the value $u_{i_r}$. So, $\\nabla_u J = u_{i_r} e_{i_r}$.\n-   **System Matrix Symmetry**: The matrix $A(\\varepsilon) = L + \\omega^2 \\operatorname{diag}(\\varepsilon)$ is symmetric. The discrete negative Laplacian $L$ for a standard five-point stencil is symmetric, and $\\operatorname{diag}(\\varepsilon)$ is a diagonal, hence symmetric, matrix. Thus $A^T = A$.\n-   **Adjoint Equation**: The adjoint equation $A^T \\lambda = \\nabla_u J$ simplifies to $A \\lambda = u_{i_r} e_{i_r}$.\n-   **Matrix Derivative $\\frac{dA}{dp}$**: The parameter is $p = \\varepsilon_{i_0}$. The permittivity vector $\\varepsilon$ only depends on $p$ at index $i_0$, so $\\frac{\\partial \\varepsilon}{\\partial p} = e_{i_0}$. The derivative of the system matrix is:\n$$\n\\frac{dA}{dp} = \\frac{d}{dp}\\left(L + \\omega^2 \\operatorname{diag}(\\varepsilon)\\right) = \\omega^2 \\operatorname{diag}\\left(\\frac{d\\varepsilon}{dp}\\right) = \\omega^2 \\operatorname{diag}(e_{i_0})\n$$\nThe matrix $\\operatorname{diag}(e_{i_0})$ is a matrix with a single non-zero entry, a $1$, at position $(i_0, i_0)$.\n-   **Final Gradient Expression**: Substituting these components into the adjoint gradient formula:\n$$\n\\frac{dJ}{dp} = -\\lambda^T \\left( \\omega^2 \\operatorname{diag}(e_{i_0}) \\right) u\n$$\nThe product $\\left( \\operatorname{diag}(e_{i_0}) \\right) u$ yields a vector whose only non-zero component is $u_{i_0}$ at index $i_0$. The subsequent inner product with $\\lambda^T$ picks out the $i_0$-th component, resulting in:\n$$\n\\frac{\\partial J}{\\partial p} = -\\omega^2 \\lambda_{i_0} u_{i_0}\n$$\n\n### Error Metric and Validation Procedure\n\nTo validate the derived gradient, we compare its prediction of the change in $J$ to that calculated by a symmetric finite-difference scheme. A Taylor series expansion shows that for a small step size $h$:\n$$\nJ(p+h) - J(p-h) = 2h \\frac{\\partial J}{\\partial p} + O(h^3)\n$$\nThe term on the left is the symmetric finite-difference variation, $\\Delta J_{\\mathrm{fd}}(h)$. The first term on the right is the first-order prediction based on the adjoint-state gradient. The discrepancy between them is the truncation error, which is of order $O(h^3)$.\n\nThe error metric provided is:\n$$\nr(h) = \\frac{\\big|\\Delta J_{\\mathrm{fd}}(h) - 2h\\,(\\partial J/\\partial p)\\big|}{\\max\\!\\big(10^{-14}, \\, \\big|\\Delta J_{\\mathrm{fd}}(h)\\big|\\big)}\n$$\nThe numerator is the absolute truncation error, which is expected to be $O(h^3)$. The denominator is dominated by $|\\Delta J_{\\mathrm{fd}}(h)|$, which is approximately $|2h (\\partial J/\\partial p)| = O(h)$. Therefore, the relative error metric $r(h)$ is expected to be of order $O(h^2)$. This quadratic convergence with decreasing $h$ is a strong indicator of a correctly computed gradient. The term $10^{-14}$ in the denominator serves as a floor to prevent division by zero or by numerically insignificant values when $h$ becomes extremely small.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nimport scipy.sparse as sp\nimport scipy.sparse.linalg as spla\n\ndef solve():\n    \"\"\"\n    Performs adjoint-state sensitivity analysis for a 2D scalar wave equation\n    and validates the gradient using a finite-difference test.\n    \"\"\"\n\n    # 1. Setup: Define problem parameters\n    N = 30\n    n = N * N\n    dx = 1.0\n    omega = 4.0\n    omega2 = omega**2\n    eps_bg_val = 1.0\n\n    # Grid locations and their 1D indices\n    is_src, js_src = N // 3, N // 3\n    k_src = is_src * N + js_src\n\n    is_rcv, js_rcv = 2 * (N // 3), 2 * (N // 3)\n    k_rcv = is_rcv * N + js_rcv\n\n    is_param, js_param = N // 2, N // 2\n    k_param = is_param * N + js_param\n    \n    # Finite-difference step sizes\n    h_steps = [10**(-i) for i in range(1, 6)]\n\n    # 2. Matrix Construction: Build the discrete Laplacian L\n    # Using LIL format for easy construction, then CSR for efficient computation\n    L = sp.lil_matrix((n, n), dtype=np.float64)\n    laplacian_coeff = 1.0 / (dx**2)\n\n    for i in range(N):\n        for j in range(N):\n            k = i * N + j\n            \n            # Main diagonal\n            L[k, k] = 4.0 * laplacian_coeff\n            \n            # Off-diagonals for neighbors\n            if i > 0:   # Neighbor above\n                L[k, k - N] = -1.0 * laplacian_coeff\n            if i  N - 1: # Neighbor below\n                L[k, k + N] = -1.0 * laplacian_coeff\n            if j > 0:   # Neighbor left\n                L[k, k - 1] = -1.0 * laplacian_coeff\n            if j  N - 1: # Neighbor right\n                L[k, k + 1] = -1.0 * laplacian_coeff\n    \n    # Convert to CSR (Compressed Sparse Row) format for fast arithmetic and solving\n    L = L.tocsr()\n\n    # 3. Adjoint Gradient Calculation\n    \n    # Background permittivity vector\n    eps_bg = np.full(n, eps_bg_val, dtype=np.float64)\n    \n    # System matrix A for the background medium\n    A_bg = L + sp.diags(omega2 * eps_bg, 0, format='csr')\n\n    # Source vector b (point source)\n    b = np.zeros(n, dtype=np.float64)\n    b[k_src] = 1.0\n\n    # a. Solve forward problem for state u\n    u = spla.spsolve(A_bg, b)\n\n    # b. Solve adjoint problem for lambda\n    # Adjoint source f_adj = B^T * B * u. For B = e_{k_rcv}^T, this is u[k_rcv] * e_{k_rcv}\n    adj_rhs = np.zeros(n, dtype=np.float64)\n    adj_rhs[k_rcv] = u[k_rcv]\n    \n    # The adjoint system matrix is A^T. Since A is symmetric, A^T = A.\n    adjoint_state = spla.spsolve(A_bg, adj_rhs)\n\n    # c. Compute the gradient dJ/dp\n    # dJ/dp = -omega^2 * lambda[k_param] * u[k_param]\n    grad_adj = -omega2 * adjoint_state[k_param] * u[k_param]\n    \n    # 4. Finite-Difference Validation Loop\n    results = []\n    \n    for h in h_steps:\n        # Perturb permittivity up and down\n        eps_plus = eps_bg.copy()\n        eps_plus[k_param] += h\n        \n        eps_minus = eps_bg.copy()\n        eps_minus[k_param] -= h\n        \n        # Form perturbed system matrices\n        A_plus = L + sp.diags(omega2 * eps_plus, 0, format='csr')\n        A_minus = L + sp.diags(omega2 * eps_minus, 0, format='csr')\n        \n        # Solve for perturbed states\n        u_plus = spla.spsolve(A_plus, b)\n        u_minus = spla.spsolve(A_minus, b)\n        \n        # Calculate objective function for each state\n        # J(u) = 0.5 * u[k_rcv]^2\n        J_plus = 0.5 * u_plus[k_rcv]**2\n        J_minus = 0.5 * u_minus[k_rcv]**2\n        \n        # Symmetric finite-difference variation\n        delta_J_fd = J_plus - J_minus\n        \n        # Adjoint first-order prediction of the variation\n        delta_J_adj = 2.0 * h * grad_adj\n        \n        # Compute the relative error metric\n        denominator = max(1e-14, abs(delta_J_fd))\n        error_metric = abs(delta_J_fd - delta_J_adj) / denominator\n        \n        results.append(error_metric)\n\n    # 5. Output\n    # The problem asks for the floating point values in a list format\n    print(f\"[{','.join(f'{r:.15g}' for r in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "The adjoint method's utility extends beyond simple source-driven problems to more complex analyses, such as eigenvalue sensitivity. This advanced practice demonstrates how to compute the sensitivity of a resonant cavity's complex frequency and Quality factor (Q). It introduces the concept of biorthogonal adjoints, which are necessary for the non-Hermitian systems that arise in realistic models involving material loss or absorbing boundaries like Perfectly Matched Layers (PMLs), showcasing the versatility of the adjoint framework. ",
            "id": "3288711",
            "problem": "Consider a discretized electromagnetic cavity with Perfectly Matched Layers (PMLs) modeled by a non-Hermitian generalized eigenproblem. Let the semi-discrete frequency-domain vector wave equation be written as the generalized eigenproblem $A \\mathbf{e} = \\tilde{\\omega} B \\mathbf{e}$, where $A \\in \\mathbb{C}^{n \\times n}$ represents the discretized curl-curl operator modified by complex coordinate stretching due to PMLs, $B \\in \\mathbb{R}^{n \\times n}$ represents the discretized permittivity weighting, $\\mathbf{e} \\in \\mathbb{C}^{n}$ is the right eigenvector approximating the electric field, and $\\tilde{\\omega} \\in \\mathbb{C}$ is the complex resonant frequency expressed in radians per second (rad/s). In the presence of PMLs, the operator $A$ is generally complex-symmetric and non-Hermitian, and the appropriate adjoint-state inner product is the biorthogonal complex-symmetric bilinear form with transpose (not conjugate transpose).\n\nStarting from Maxwell’s equations in the frequency domain and the weak-form discretization, derive from first principles the first-order sensitivity of the complex resonant frequency $\\tilde{\\omega}$ with respect to a small spatial perturbation in the relative permittivity (unitless) field $\\delta \\epsilon(\\mathbf{r})$, encoded in $B$ as a diagonal perturbation $\\delta B$. Use the adjoint-state method with biorthogonal adjoint eigenmodes appropriate to complex-symmetric operators. Then, using the derived sensitivity for $\\tilde{\\omega}$, determine the corresponding first-order sensitivity of the Quality factor (Q) $Q = -\\Re(\\tilde{\\omega})/(2 \\Im(\\tilde{\\omega}))$ of the mode, treating $Q$ as a function of $\\Re(\\tilde{\\omega})$ and $\\Im(\\tilde{\\omega})$ and applying first-order perturbation.\n\nYour task is to implement the derived expressions as a complete, runnable program. For each test case below, select the physically relevant mode as the eigenpair with the largest real part among those with negative imaginary part (to ensure a positive Quality factor). Compute:\n- The first-order sensitivity $d\\tilde{\\omega}/d\\alpha$ at $\\alpha = 0$ for a perturbation $\\delta B(\\alpha) = \\alpha \\,\\operatorname{diag}(\\mathbf{d})$, reported as two floats: $\\Re\\left(d\\tilde{\\omega}/d\\alpha\\right)$ and $\\Im\\left(d\\tilde{\\omega}/d\\alpha\\right)$, both expressed in radians per second per unit perturbation amplitude $\\alpha$ (rad/s).\n- The first-order sensitivity $dQ/d\\alpha$ at $\\alpha = 0$, reported as a float (dimensionless per unit $\\alpha$).\n\nAll answers must be expressed in the following units:\n- $\\tilde{\\omega}$ and its sensitivity in radians per second (rad/s) per unit $\\alpha$.\n- $Q$ and its sensitivity are dimensionless per unit $\\alpha$.\n- The perturbation vector $\\mathbf{d}$ is a unitless change in relative permittivity distribution.\n\nTest Suite (three cases):\nUse $n = 5$, and define the baseline stiffness-like matrix $K \\in \\mathbb{R}^{5 \\times 5}$ as\n$$\nK = \\begin{bmatrix}\n2  -1  0  0  0 \\\\\n-1  2  -1  0  0 \\\\\n0  -1  2  -1  0 \\\\\n0  0  -1  2  -1 \\\\\n0  0  0  -1  2\n\\end{bmatrix}.\n$$\n\nCase $1$ (happy path):\n- PML profile $\\Sigma_1 = \\operatorname{diag}\\left(0,\\,0.1,\\,0.4,\\,0.7,\\,1.0\\right)$.\n- Operator $A_1 = K - \\mathrm{i}\\,\\Sigma_1$.\n- Permittivity weighting $B_1 = \\operatorname{diag}\\left(2.5,\\,3.0,\\,3.5,\\,4.0,\\,4.5\\right)$.\n- Perturbation vector $\\mathbf{d}_1 = \\left[0,\\,0,\\,1,\\,0,\\,0\\right]$ so that $\\delta B_1(\\alpha) = \\alpha\\,\\operatorname{diag}(\\mathbf{d}_1)$.\n\nCase $2$ (significant PML, distributed perturbation):\n- PML profile $\\Sigma_2 = \\operatorname{diag}\\left(0,\\,0.5,\\,1.0,\\,1.5,\\,2.0\\right)$.\n- Operator $A_2 = K - \\mathrm{i}\\,\\Sigma_2$.\n- Permittivity weighting $B_2 = \\operatorname{diag}\\left(1.8,\\,2.2,\\,2.6,\\,3.0,\\,3.4\\right)$.\n- Perturbation vector $\\mathbf{d}_2 = \\left[1,\\,0,\\,0,\\,0,\\,1\\right]$ so that $\\delta B_2(\\alpha) = \\alpha\\,\\operatorname{diag}(\\mathbf{d}_2)$.\n\nCase $3$ (edge case: zero perturbation):\n- Use $A_3 = A_1$ and $B_3 = B_1$.\n- Perturbation vector $\\mathbf{d}_3 = \\left[0,\\,0,\\,0,\\,0,\\,0\\right]$ so that $\\delta B_3(\\alpha) = \\alpha\\,\\operatorname{diag}(\\mathbf{d}_3)$.\n\nAlgorithmic requirements:\n- Solve $A \\mathbf{e} = \\tilde{\\omega} B \\mathbf{e}$ for eigenpairs $(\\tilde{\\omega}, \\mathbf{e})$.\n- Use the biorthogonal adjoint-state bilinear form appropriate to complex-symmetric operators (transpose-based product, not conjugate) when forming the needed inner products.\n- Select the mode as specified above.\n- Compute $d\\tilde{\\omega}/d\\alpha$ using your derived expression evaluated at $\\alpha = 0$.\n- Compute $dQ/d\\alpha$ from $Q = -\\Re(\\tilde{\\omega})/(2\\Im(\\tilde{\\omega}))$ using first-order perturbation with the computed $d\\tilde{\\omega}/d\\alpha$.\n\nFinal Output Format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each test case contributes a sub-list with exactly three floats in the order $\\left[\\Re\\left(d\\tilde{\\omega}/d\\alpha\\right), \\Im\\left(d\\tilde{\\omega}/d\\alpha\\right), dQ/d\\alpha\\right]$. For example, the output should look like:\n$[\\,[x_1, y_1, z_1],\\,[x_2, y_2, z_2],\\,[x_3, y_3, z_3]]$,\nwith no additional text printed.",
            "solution": "### Derivation of First-Order Sensitivities\n\n**1. Sensitivity of the Complex Resonant Frequency $\\tilde{\\omega}$**\n\nWe begin with the discretized frequency-domain wave equation, expressed as a generalized eigenvalue problem that depends on a perturbation parameter $\\alpha$:\n$$A \\mathbf{e}(\\alpha) = \\tilde{\\omega}(\\alpha) B(\\alpha) \\mathbf{e}(\\alpha)$$\nHere, $A$ is the constant system matrix, while the permittivity matrix $B(\\alpha) = B_0 + \\alpha \\frac{dB}{d\\alpha}$ is perturbed. The unperturbed problem at $\\alpha=0$ is $A \\mathbf{e} = \\tilde{\\omega} B \\mathbf{e}$, where we drop the explicit dependence on $\\alpha$ for brevity.\n\nTo find the sensitivity $\\frac{d\\tilde{\\omega}}{d\\alpha}$, we differentiate the governing equation with respect to $\\alpha$ and evaluate at $\\alpha=0$:\n$$A \\frac{d\\mathbf{e}}{d\\alpha} \\bigg|_{\\alpha=0} = \\frac{d\\tilde{\\omega}}{d\\alpha} \\bigg|_{\\alpha=0} B \\mathbf{e} + \\tilde{\\omega} \\frac{dB}{d\\alpha} \\bigg|_{\\alpha=0} \\mathbf{e} + \\tilde{\\omega} B \\frac{d\\mathbf{e}}{d\\alpha} \\bigg|_{\\alpha=0}$$\n\nThe problem states that the operator $A$ is complex-symmetric, i.e., $A = A^T$. The matrix $B$ represents permittivity and is real and diagonal, thus also symmetric ($B=B^T$). For such complex-symmetric systems, the left eigenvector is simply the transpose of the right eigenvector. The adjoint problem is obtained by transposing the original equation:\n$$ (A \\mathbf{e})^T = (\\tilde{\\omega} B \\mathbf{e})^T \\implies \\mathbf{e}^T A^T = \\tilde{\\omega} \\mathbf{e}^T B^T $$\nSince $A=A^T$ and $B=B^T$, this becomes:\n$$ \\mathbf{e}^T A = \\tilde{\\omega} \\mathbf{e}^T B $$\nThis is the adjoint eigenvalue equation, with the adjoint eigenvector being $\\mathbf{e}^T$.\n\nWe now apply the adjoint method. We pre-multiply the differentiated equation by the adjoint eigenvector $\\mathbf{e}^T$:\n$$ \\mathbf{e}^T A \\left(\\frac{d\\mathbf{e}}{d\\alpha}\\right) = \\left(\\frac{d\\tilde{\\omega}}{d\\alpha}\\right) \\mathbf{e}^T B \\mathbf{e} + \\tilde{\\omega} \\mathbf{e}^T \\left(\\frac{dB}{d\\alpha}\\right) \\mathbf{e} + \\tilde{\\omega} \\mathbf{e}^T B \\left(\\frac{d\\mathbf{e}}{d\\alpha}\\right) $$\n(All derivatives are evaluated at $\\alpha=0$).\n\nUsing the adjoint property $\\mathbf{e}^T A = \\tilde{\\omega} \\mathbf{e}^T B$, we substitute this into the left-hand side:\n$$ \\tilde{\\omega} \\mathbf{e}^T B \\left(\\frac{d\\mathbf{e}}{d\\alpha}\\right) = \\left(\\frac{d\\tilde{\\omega}}{d\\alpha}\\right) \\mathbf{e}^T B \\mathbf{e} + \\tilde{\\omega} \\mathbf{e}^T \\left(\\frac{dB}{d\\alpha}\\right) \\mathbf{e} + \\tilde{\\omega} \\mathbf{e}^T B \\left(\\frac{d\\mathbf{e}}{d\\alpha}\\right) $$\n\nThe term $\\tilde{\\omega} \\mathbf{e}^T B \\left(\\frac{d\\mathbf{e}}{d\\alpha}\\right)$ appears on both sides and cancels. This leaves:\n$$ 0 = \\left(\\frac{d\\tilde{\\omega}}{d\\alpha}\\right) \\mathbf{e}^T B \\mathbf{e} + \\tilde{\\omega} \\mathbf{e}^T \\left(\\frac{dB}{d\\alpha}\\right) \\mathbf{e} $$\n\nSolving for the frequency sensitivity $\\frac{d\\tilde{\\omega}}{d\\alpha}$ yields the central result of adjoint-state analysis for this problem:\n$$ \\frac{d\\tilde{\\omega}}{d\\alpha} = - \\frac{\\tilde{\\omega} \\, \\mathbf{e}^T \\frac{dB}{d\\alpha} \\mathbf{e}}{\\mathbf{e}^T B \\mathbf{e}} $$\nThe perturbation is given as $\\delta B(\\alpha) = \\alpha \\, \\mathrm{diag}(\\mathbf{d})$, so $\\frac{dB}{d\\alpha} = \\mathrm{diag}(\\mathbf{d})$. The sensitivity is independent of the normalization of the eigenvector $\\mathbf{e}$. The bilinear form $\\mathbf{u}^T \\mathbf{v}$ corresponds to the specified biorthogonal inner product.\n\n**2. Sensitivity of the Quality factor $Q$**\n\nThe Quality factor $Q$ is defined as $Q = -\\frac{\\Re(\\tilde{\\omega})}{2\\Im(\\tilde{\\omega})}$. Let $\\tilde{\\omega} = \\omega_r + i\\omega_i$, so $Q = -\\frac{\\omega_r}{2\\omega_i}$. We treat $Q$ as a function of $\\omega_r$ and $\\omega_i$ and use the chain rule to find its sensitivity with respect to $\\alpha$:\n$$ \\frac{dQ}{d\\alpha} = \\frac{\\partial Q}{\\partial \\omega_r} \\frac{d\\omega_r}{d\\alpha} + \\frac{\\partial Q}{\\partial \\omega_i} \\frac{d\\omega_i}{d\\alpha} $$\n\nFirst, we find the partial derivatives of $Q$:\n$$ \\frac{\\partial Q}{\\partial \\omega_r} = \\frac{\\partial}{\\partial \\omega_r}\\left(-\\frac{\\omega_r}{2\\omega_i}\\right) = -\\frac{1}{2\\omega_i} $$\n$$ \\frac{\\partial Q}{\\partial \\omega_i} = \\frac{\\partial}{\\partial \\omega_i}\\left(-\\frac{\\omega_r}{2\\omega_i}\\right) = -\\frac{\\omega_r}{2} \\left(-\\frac{1}{\\omega_i^2}\\right) = \\frac{\\omega_r}{2\\omega_i^2} $$\n\nThe derivatives $\\frac{d\\omega_r}{d\\alpha}$ and $\\frac{d\\omega_i}{d\\alpha}$ are the real and imaginary parts of the complex frequency sensitivity we derived:\n$$ \\frac{d\\omega_r}{d\\alpha} = \\Re\\left(\\frac{d\\tilde{\\omega}}{d\\alpha}\\right) \\quad \\text{and} \\quad \\frac{d\\omega_i}{d\\alpha} = \\Im\\left(\\frac{d\\tilde{\\omega}}{d\\alpha}\\right) $$\n\nSubstituting these into the chain rule expression:\n$$ \\frac{dQ}{d\\alpha} = \\left(-\\frac{1}{2\\omega_i}\\right) \\Re\\left(\\frac{d\\tilde{\\omega}}{d\\alpha}\\right) + \\left(\\frac{\\omega_r}{2\\omega_i^2}\\right) \\Im\\left(\\frac{d\\tilde{\\omega}}{d\\alpha}\\right) $$\n\nThis expression can be re-written in terms of $Q$ itself by substituting $\\omega_r = -2Q\\omega_i$:\n$$ \\frac{dQ}{d\\alpha} = -\\frac{1}{2\\omega_i} \\Re\\left(\\frac{d\\tilde{\\omega}}{d\\alpha}\\right) + \\frac{-2Q\\omega_i}{2\\omega_i^2} \\Im\\left(\\frac{d\\tilde{\\omega}}{d\\alpha}\\right) $$\n$$ \\frac{dQ}{d\\alpha} = -\\frac{1}{2\\Im(\\tilde{\\omega})} \\Re\\left(\\frac{d\\tilde{\\omega}}{d\\alpha}\\right) - \\frac{Q}{\\Im(\\tilde{\\omega})} \\Im\\left(\\frac{d\\tilde{\\omega}}{d\\alpha}\\right) $$\nThis is the final expression for the sensitivity of the Quality factor. All quantities on the right-hand side are determined from the unperturbed eigenproblem and the derived frequency sensitivity.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import eig\n\ndef solve():\n    \"\"\"\n    Solves for the sensitivity of complex frequency and Quality factor\n    for a discretized electromagnetic cavity model.\n    \"\"\"\n    \n    # Define the baseline stiffness-like matrix K\n    n = 5\n    K = np.diag(np.full(n, 2.0)) - np.diag(np.full(n - 1, 1.0), k=1) - np.diag(np.full(n - 1, 1.0), k=-1)\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"Sigma_diag\": [0.0, 0.1, 0.4, 0.7, 1.0],\n            \"B_diag\": [2.5, 3.0, 3.5, 4.0, 4.5],\n            \"d_vec\": [0.0, 0.0, 1.0, 0.0, 0.0],\n        },\n        {\n            \"Sigma_diag\": [0.0, 0.5, 1.0, 1.5, 2.0],\n            \"B_diag\": [1.8, 2.2, 2.6, 3.0, 3.4],\n            \"d_vec\": [1.0, 0.0, 0.0, 0.0, 1.0],\n        },\n        {\n            \"Sigma_diag\": [0.0, 0.1, 0.4, 0.7, 1.0],\n            \"B_diag\": [2.5, 3.0, 3.5, 4.0, 4.5],\n            \"d_vec\": [0.0, 0.0, 0.0, 0.0, 0.0],\n        },\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        # 1. Construct matrices for the current case\n        Sigma = np.diag(case[\"Sigma_diag\"])\n        A = K - 1j * Sigma\n        B = np.diag(case[\"B_diag\"])\n        d_vec = np.array(case[\"d_vec\"])\n        dB_d_alpha = np.diag(d_vec)\n\n        # 2. Solve the generalized eigenvalue problem A*e = omega*B*e\n        omegas, e_vectors = eig(A, B)\n\n        # 3. Select the physically relevant mode\n        # Find indices of modes with negative imaginary part (representing loss)\n        # A small tolerance is used to handle floating-point inaccuracies near zero.\n        valid_indices = np.where(omegas.imag  -1e-12)[0]\n        \n        if valid_indices.size == 0:\n            # This case is not expected based on problem physics but is handled defensively.\n            # If no lossy modes are found, sensitivities cannot be computed as specified.\n            results.append([np.nan, np.nan, np.nan])\n            continue\n\n        # Filter the eigenpairs to include only the valid ones\n        valid_omegas = omegas[valid_indices]\n        valid_e_vectors = e_vectors[:, valid_indices]\n\n        # Among the valid modes, find the one with the largest real part\n        target_idx = np.argmax(valid_omegas.real)\n        \n        # This is the selected eigenpair for sensitivity analysis\n        omega = valid_omegas[target_idx]\n        e_vec = valid_e_vectors[:, target_idx]\n\n        # 4. Compute the sensitivity of the complex frequency d(omega)/d(alpha)\n        # Numerator: -omega * (e^T * dB/dalpha * e)\n        # Denominator: e^T * B * e\n        # The bilinear form u^T*v is computed using np.dot(u, v) for 1D arrays\n        numerator_d_omega = -omega * np.dot(e_vec, dB_d_alpha @ e_vec)\n        denominator_d_omega = np.dot(e_vec, B @ e_vec)\n        \n        if abs(denominator_d_omega)  1e-15:\n             # This should not happen for a physical mode.\n            d_omega_d_alpha = complex(0, 0)\n        else:\n            d_omega_d_alpha = numerator_d_omega / denominator_d_omega\n\n        # 5. Compute the Quality factor Q\n        # Defensive check for division by zero\n        if abs(omega.imag)  1e-15:\n            Q = np.inf\n        else:\n            Q = -omega.real / (2 * omega.imag)\n\n        # 6. Compute the sensitivity of the Quality factor dQ/d(alpha)\n        if abs(omega.imag)  1e-15 or np.isinf(Q):\n            dQ_d_alpha = np.nan\n        else:\n            term1 = (-1.0 / (2.0 * omega.imag)) * d_omega_d_alpha.real\n            term2 = (-Q / omega.imag) * d_omega_d_alpha.imag\n            dQ_d_alpha = term1 + term2\n        \n        results.append([d_omega_d_alpha.real, d_omega_d_alpha.imag, dQ_d_alpha])\n\n    # Final print statement in the exact required format.\n    formatted_cases = []\n    for res_case in results:\n        # Format each case without spaces inside the brackets\n        case_str = f\"[{res_case[0]},{res_case[1]},{res_case[2]}]\"\n        formatted_cases.append(case_str)\n    \n    final_output_str = f\"[{','.join(formatted_cases)}]\"\n    print(final_output_str)\n\nsolve()\n```"
        }
    ]
}