{
    "hands_on_practices": [
        {
            "introduction": "此练习侧重于从第一性原理推导连续频域中的灵敏度。我们将探讨伴随法如何应用于时谐电磁问题，其中材料的介电常数遵循德拜（Debye）色散模型，这对于基于梯度的电磁设备设计而言是一项基础技能。通过完成此推导，您将巩固对如何构建伴随方程以及如何处理依赖于参数的算子的理解。",
            "id": "3288658",
            "problem": "考虑一个有界域 $\\Omega \\subset \\mathbb{R}^{3}$ 中的线性、各向同性、源驱动的时谐电磁场，其边界 $\\partial \\Omega$ 上具有外单位法向量和阻抗边界条件。假设时间约定为 $\\exp(i \\omega t)$。在每个角频率 $\\omega$ 下，电场 $\\mathbf{E}(\\mathbf{r},\\omega)$ 满足从 Maxwell 方程组推导出的频域旋度-旋度方程，\n$$\n\\nabla \\times \\mu^{-1}(\\mathbf{r}) \\nabla \\times \\mathbf{E}(\\mathbf{r},\\omega) - \\omega^{2} \\epsilon(\\mathbf{r},\\omega) \\mathbf{E}(\\mathbf{r},\\omega) = i \\omega \\mathbf{J}_{\\mathrm{s}}(\\mathbf{r},\\omega),\n$$\n其中 $\\mu(\\mathbf{r})$ 是磁导率，$\\epsilon(\\mathbf{r},\\omega)$ 是电容率，$\\mathbf{J}_{\\mathrm{s}}(\\mathbf{r},\\omega)$ 是给定的源电流密度。假设在一个与 $\\Omega$ 重合的子区域内，材料电容率遵循单极点 Debye 色散模型，由下式给出\n$$\n\\epsilon(\\mathbf{r},\\omega) = \\epsilon_{\\infty}(\\mathbf{r}) + \\frac{\\Delta \\epsilon(\\mathbf{r})}{1 + i \\omega \\tau(\\mathbf{r})},\n$$\n其中 $\\epsilon_{\\infty}(\\mathbf{r}) > 0$，$\\Delta \\epsilon(\\mathbf{r}) \\ge 0$ 且 $\\tau(\\mathbf{r}) > 0$。对于本问题，假设 $\\Delta \\epsilon(\\mathbf{r})$ 和 $\\tau(\\mathbf{r})$ 在 $\\Omega$ 内是空间均匀的（即与 $\\mathbf{r}$ 无关），但为待通过优化确定的未知标量，而 $\\epsilon_{\\infty}(\\mathbf{r})$ 和 $\\mu(\\mathbf{r})$ 是已知的、实的、严格为正的函数。\n\n令 $\\{\\omega_{k}\\}_{k=1}^{K}$ 为一个正角频率的有限集合。电场 $\\mathbf{E}(\\mathbf{r},\\omega_{k})$ 是在每个 $\\omega_{k}$ 处的正问题的解。定义目标泛函\n$$\nJ(\\Delta \\epsilon,\\tau) = \\frac{1}{2} \\sum_{k=1}^{K} \\int_{\\Omega} w(\\mathbf{r},\\omega_{k}) \\left| \\mathbf{E}(\\mathbf{r},\\omega_{k}) - \\mathbf{E}_{\\mathrm{t}}(\\mathbf{r},\\omega_{k}) \\right|^{2} \\, d\\mathbf{r},\n$$\n其中 $w(\\mathbf{r},\\omega_{k}) \\ge 0$ 是一个实值权重函数，$\\mathbf{E}_{\\mathrm{t}}(\\mathbf{r},\\omega_{k})$ 是一个给定的实数或复数目标场分布。$J$ 对 $(\\Delta \\epsilon,\\tau)$ 的依赖性是通过状态 $\\mathbf{E}$ 并经由正向约束产生的。\n\n使用频域中的伴随状态法，推导灵敏度 $\\partial J / \\partial \\Delta \\epsilon$ 和 $\\partial J / \\partial \\tau$ 的解析表达式，用正向场 $\\mathbf{E}(\\mathbf{r},\\omega_{k})$、伴随场 $\\boldsymbol{\\lambda}(\\mathbf{r},\\omega_{k})$ 和材料参数来表示。您的推导必须从上述基本定律开始，并且必须明确地考虑 $\\partial \\epsilon / \\partial p$（其中 $p \\in \\{\\Delta \\epsilon,\\tau\\}$）对将场映射到源的频域算子的影响。假设在每个 $\\omega_{k}$ 处的伴随场满足与 $\\Omega$ 上矢量场的标准 $L^{2}$ Hermitian 内积相一致的、相应的复共轭转置伴随方程。\n\n将您的最终结果表示为双分量梯度向量 $\\left( \\partial J / \\partial \\Delta \\epsilon, \\, \\partial J / \\partial \\tau \\right)$ 的单个闭式解析表达式，使用在 $\\Omega$ 上的积分形式和对离散频率集 $\\{\\omega_{k}\\}_{k=1}^{K}$ 的求和。无需进行数值计算。无需进行舍入。最终表达式中不要包含物理单位。",
            "solution": "在 $\\exp(i \\omega t)$ 约定下，由 Maxwell 方程组得出的频域旋度-旋度方程为\n$$\n\\nabla \\times \\mu^{-1}(\\mathbf{r}) \\nabla \\times \\mathbf{E}(\\mathbf{r},\\omega) - \\omega^{2} \\epsilon(\\mathbf{r},\\omega) \\mathbf{E}(\\mathbf{r},\\omega) = i \\omega \\mathbf{J}_{\\mathrm{s}}(\\mathbf{r},\\omega).\n$$\n我们记线性算子为\n$$\n\\mathcal{A}(\\omega; \\Delta \\epsilon,\\tau)\\mathbf{E} := \\nabla \\times \\mu^{-1}(\\mathbf{r}) \\nabla \\times \\mathbf{E}(\\mathbf{r},\\omega) - \\omega^{2} \\epsilon(\\mathbf{r},\\omega) \\mathbf{E}(\\mathbf{r},\\omega),\n$$\n因此正向约束为\n$$\n\\mathcal{A}(\\omega; \\Delta \\epsilon,\\tau)\\mathbf{E}(\\mathbf{r},\\omega) = i \\omega \\mathbf{J}_{\\mathrm{s}}(\\mathbf{r},\\omega).\n$$\n目标泛函为\n$$\nJ(\\Delta \\epsilon,\\tau) = \\frac{1}{2} \\sum_{k=1}^{K} \\int_{\\Omega} w(\\mathbf{r},\\omega_{k}) \\left| \\mathbf{E}(\\mathbf{r},\\omega_{k}) - \\mathbf{E}_{\\mathrm{t}}(\\mathbf{r},\\omega_{k}) \\right|^{2} \\, d\\mathbf{r}.\n$$\n我们对复矢量场采用标准 $L^{2}$ Hermitian 内积，\n$$\n\\langle \\mathbf{u}, \\mathbf{v} \\rangle := \\int_{\\Omega} \\mathbf{u}^{*}(\\mathbf{r}) \\cdot \\mathbf{v}(\\mathbf{r}) \\, d\\mathbf{r},\n$$\n其中上标 $^{*}$ 表示复共轭，$\\,\\cdot\\,$ 表示 $\\mathbb{C}^{3}$ 上的欧几里得点积。\n\n我们求解 $p \\in \\{\\Delta \\epsilon,\\tau\\}$ 的灵敏度 $\\partial J / \\partial p$。$J$ 对 $p$ 的依赖性通过状态 $\\mathbf{E}$ 隐式体现，该状态满足 $\\mathcal{A}(\\omega;p)\\mathbf{E}(\\omega) = i\\omega \\mathbf{J}_{\\mathrm{s}}(\\omega)$，为简洁起见，我们在记法中省略了 $\\mathbf{r}$。对正向约束关于 $p$ 求导，得到一阶变分\n$$\n\\mathcal{A}(\\omega;p)\\,\\delta \\mathbf{E}(\\omega) + \\left( \\frac{\\partial \\mathcal{A}(\\omega;p)}{\\partial p} \\right) \\mathbf{E}(\\omega) \\, \\delta p = \\mathbf{0}.\n$$\n我们也计算 $J$ 的一阶变分，\n$$\n\\delta J = \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} w(\\mathbf{r},\\omega_{k}) \\left( \\mathbf{E}(\\mathbf{r},\\omega_{k}) - \\mathbf{E}_{\\mathrm{t}}(\\mathbf{r},\\omega_{k}) \\right) \\cdot \\delta \\mathbf{E}^{*}(\\mathbf{r},\\omega_{k}) \\, d\\mathbf{r} \\right\\},\n$$\n其中 $\\Re\\{\\cdot\\}$ 表示实部，并且我们利用了 $J$ 是实值函数且是场失配的二次函数这一性质。\n\n为消除对 $\\delta \\mathbf{E}$ 的依赖，我们在每个 $\\omega$ 处引入伴随场 $\\boldsymbol{\\lambda}(\\mathbf{r},\\omega)$，并要求它满足伴随方程\n$$\n\\mathcal{A}^{\\dagger}(\\omega;p)\\,\\boldsymbol{\\lambda}(\\mathbf{r},\\omega) = w(\\mathbf{r},\\omega) \\left( \\mathbf{E}(\\mathbf{r},\\omega) - \\mathbf{E}_{\\mathrm{t}}(\\mathbf{r},\\omega) \\right),\n$$\n其中 $\\mathcal{A}^{\\dagger}$ 表示在所选的 Hermitian 内积下的伴随算子。对于算子\n$$\n\\mathcal{A}(\\omega;p) = \\nabla \\times \\mu^{-1}(\\mathbf{r}) \\nabla \\times \\,\\cdot\\, - \\omega^{2} \\epsilon(\\mathbf{r},\\omega;p)\\, \\mathrm{Id},\n$$\n其中 $\\mu(\\mathbf{r})$ 和 $\\epsilon_{\\infty}(\\mathbf{r})$ 为实的，而 Debye 模型中的 $\\epsilon(\\mathbf{r},\\omega;p)$ 可能为复值，其在 $L^{2}$ Hermitian 内积下的伴随算子形式为\n$$\n\\mathcal{A}^{\\dagger}(\\omega;p) = \\nabla \\times \\mu^{-1}(\\mathbf{r}) \\nabla \\times \\,\\cdot\\, - \\omega^{2} \\epsilon^{*}(\\mathbf{r},\\omega;p)\\, \\mathrm{Id},\n$$\n并满足相同的边界条件，因为在假定的边界条件下，对于实的 $\\mu(\\mathbf{r})$，旋度-旋度算子是自伴的。\n\n根据对偶性，我们将线性化约束在内积中乘以 $\\boldsymbol{\\lambda}^{*}$，并利用伴随方程写出\n$$\n0 = \\langle \\boldsymbol{\\lambda}, \\mathcal{A}(\\omega;p)\\,\\delta \\mathbf{E} \\rangle + \\left\\langle \\boldsymbol{\\lambda}, \\left( \\frac{\\partial \\mathcal{A}(\\omega;p)}{\\partial p} \\right) \\mathbf{E} \\right\\rangle \\delta p\n= \\langle \\mathcal{A}^{\\dagger}(\\omega;p)\\,\\boldsymbol{\\lambda}, \\delta \\mathbf{E} \\rangle + \\left\\langle \\boldsymbol{\\lambda}, \\left( \\frac{\\partial \\mathcal{A}(\\omega;p)}{\\partial p} \\right) \\mathbf{E} \\right\\rangle \\delta p.\n$$\n使用伴随定义 $\\mathcal{A}^{\\dagger}(\\omega;p)\\,\\boldsymbol{\\lambda} = w(\\mathbf{r},\\omega) \\left( \\mathbf{E} - \\mathbf{E}_{\\mathrm{t}} \\right)$ 并与 $\\delta J$ 比较，我们得到\n$$\n\\delta J = \\sum_{k=1}^{K} \\Re \\left\\{ \\langle w(\\mathbf{r},\\omega_{k})(\\mathbf{E} - \\mathbf{E}_{\\mathrm{t}}), \\delta \\mathbf{E} \\rangle \\right\\}\n= \\sum_{k=1}^{K} \\Re \\left\\{ \\langle \\mathcal{A}^{\\dagger}(\\omega_{k};p)\\,\\boldsymbol{\\lambda}(\\omega_{k}), \\delta \\mathbf{E}(\\omega_{k}) \\rangle \\right\\}.\n$$\n因此，\n$$\n\\delta J = - \\sum_{k=1}^{K} \\Re \\left\\{ \\left\\langle \\boldsymbol{\\lambda}(\\omega_{k}), \\left( \\frac{\\partial \\mathcal{A}(\\omega_{k};p)}{\\partial p} \\right) \\mathbf{E}(\\omega_{k}) \\right\\rangle \\right\\} \\delta p,\n$$\n这就得出了伴随状态灵敏度公式\n$$\n\\frac{\\partial J}{\\partial p} = - \\sum_{k=1}^{K} \\Re \\left\\{ \\left\\langle \\boldsymbol{\\lambda}(\\omega_{k}), \\left( \\frac{\\partial \\mathcal{A}(\\omega_{k};p)}{\\partial p} \\right) \\mathbf{E}(\\omega_{k}) \\right\\rangle \\right\\}.\n$$\n我们现在显式地计算 $\\partial \\mathcal{A} / \\partial p$。该算子对 $\\epsilon(\\mathbf{r},\\omega;p)$ 的依赖仅通过项 $-\\omega^{2} \\epsilon(\\mathbf{r},\\omega;p)\\,\\mathrm{Id}$ 体现。因此，\n$$\n\\frac{\\partial \\mathcal{A}(\\omega;p)}{\\partial p} = - \\omega^{2} \\left( \\frac{\\partial \\epsilon(\\mathbf{r},\\omega;p)}{\\partial p} \\right) \\mathrm{Id}.\n$$\n对于 Debye 模型\n$$\n\\epsilon(\\mathbf{r},\\omega;p) = \\epsilon_{\\infty}(\\mathbf{r}) + \\frac{\\Delta \\epsilon}{1 + i \\omega \\tau},\n$$\n其中 $\\Delta \\epsilon$ 和 $\\tau$ 在 $\\Omega$ 内均匀，我们有以下参数导数\n$$\n\\frac{\\partial \\epsilon(\\mathbf{r},\\omega;p)}{\\partial \\Delta \\epsilon} = \\frac{1}{1 + i \\omega \\tau}, \\qquad\n\\frac{\\partial \\epsilon(\\mathbf{r},\\omega;p)}{\\partial \\tau} = \\Delta \\epsilon \\frac{\\partial}{\\partial \\tau} \\left( \\frac{1}{1 + i \\omega \\tau} \\right) = - \\frac{i \\omega \\Delta \\epsilon}{(1 + i \\omega \\tau)^{2}}.\n$$\n因此，\n$$\n\\frac{\\partial \\mathcal{A}(\\omega;\\Delta \\epsilon,\\tau)}{\\partial \\Delta \\epsilon} = - \\omega^{2} \\frac{1}{1 + i \\omega \\tau}\\, \\mathrm{Id}, \\qquad\n\\frac{\\partial \\mathcal{A}(\\omega;\\Delta \\epsilon,\\tau)}{\\partial \\tau} = - \\omega^{2} \\left( - \\frac{i \\omega \\Delta \\epsilon}{(1 + i \\omega \\tau)^{2}} \\right) \\mathrm{Id}\n= \\frac{i \\omega^{3} \\Delta \\epsilon}{(1 + i \\omega \\tau)^{2}}\\, \\mathrm{Id}.\n$$\n将这些代入灵敏度公式，并显式地写出内积，我们得到\n$$\n\\frac{\\partial J}{\\partial \\Delta \\epsilon}\n= - \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\left[ - \\omega_{k}^{2} \\frac{1}{1 + i \\omega_{k} \\tau} \\mathbf{E}(\\mathbf{r},\\omega_{k}) \\right] \\, d\\mathbf{r} \\right\\}\n= \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\omega_{k}^{2} \\frac{1}{1 + i \\omega_{k} \\tau} \\, \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\mathbf{E}(\\mathbf{r},\\omega_{k}) \\, d\\mathbf{r} \\right\\},\n$$\n以及\n$$\n\\frac{\\partial J}{\\partial \\tau}\n= - \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\left[ \\frac{i \\omega_{k}^{3} \\Delta \\epsilon}{(1 + i \\omega_{k} \\tau)^{2}} \\mathbf{E}(\\mathbf{r},\\omega_{k}) \\right] \\, d\\mathbf{r} \\right\\}\n= - \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\frac{i \\omega_{k}^{3} \\Delta \\epsilon}{(1 + i \\omega_{k} \\tau)^{2}} \\, \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\mathbf{E}(\\mathbf{r},\\omega_{k}) \\, d\\mathbf{r} \\right\\}.\n$$\n我们可以将 $\\partial J / \\partial \\tau$ 等价地表示为\n$$\n\\frac{\\partial J}{\\partial \\tau}\n= \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\omega_{k}^{2} \\left( - \\frac{\\partial \\epsilon(\\omega_{k})}{\\partial \\tau} \\right) \\boldsymbol{\\lambda}^{*} \\cdot \\mathbf{E} \\, d\\mathbf{r} \\right\\}\n= \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\frac{i \\omega_{k}^{3} \\Delta \\epsilon}{(1 + i \\omega_{k} \\tau)^{2}} \\, \\boldsymbol{\\lambda}^{*} \\cdot \\mathbf{E} \\, d\\mathbf{r} \\right\\},\n$$\n这与前面的表达式一致，只在算子导数中相差一个显式的负号。伴随场 $\\boldsymbol{\\lambda}(\\mathbf{r},\\omega_{k})$ 通过求解以下方程来确定\n$$\n\\nabla \\times \\mu^{-1}(\\mathbf{r}) \\nabla \\times \\boldsymbol{\\lambda}(\\mathbf{r},\\omega_{k}) - \\omega_{k}^{2} \\epsilon^{*}(\\mathbf{r},\\omega_{k}) \\boldsymbol{\\lambda}(\\mathbf{r},\\omega_{k})\n= w(\\mathbf{r},\\omega_{k}) \\left( \\mathbf{E}(\\mathbf{r},\\omega_{k}) - \\mathbf{E}_{\\mathrm{t}}(\\mathbf{r},\\omega_{k}) \\right),\n$$\n其边界条件与正问题相同，从而确保伴随状态法一致地考虑了算子对色散电容率的依赖性。\n\n将两个灵敏度收集到一个行向量中，梯度为\n$$\n\\left( \\frac{\\partial J}{\\partial \\Delta \\epsilon}, \\, \\frac{\\partial J}{\\partial \\tau} \\right)\n= \\left( \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\omega_{k}^{2} \\frac{ \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\mathbf{E}(\\mathbf{r},\\omega_{k}) }{1 + i \\omega_{k} \\tau} \\, d\\mathbf{r} \\right\\}, \\;\n- \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\frac{i \\omega_{k}^{3} \\Delta \\epsilon}{(1 + i \\omega_{k} \\tau)^{2}} \\, \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\mathbf{E}(\\mathbf{r},\\omega_{k}) \\, d\\mathbf{r} \\right\\} \\right).\n$$\n此表达式显式地包含了 $\\partial \\epsilon / \\partial p$ 对算子 $\\mathcal{A}$ 的影响，并得出了所需的 Debye 色散参数的频域伴随灵敏度。",
            "answer": "$$\\boxed{\\begin{pmatrix}\n\\displaystyle \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\omega_{k}^{2} \\frac{ \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\mathbf{E}(\\mathbf{r},\\omega_{k}) }{1 + i \\omega_{k} \\tau} \\, d\\mathbf{r} \\right\\} \\\\\n\\displaystyle - \\sum_{k=1}^{K} \\Re \\left\\{ \\int_{\\Omega} \\frac{i \\omega_{k}^{3} \\Delta \\epsilon}{(1 + i \\omega_{k} \\tau)^{2}} \\, \\boldsymbol{\\lambda}^{*}(\\mathbf{r},\\omega_{k}) \\cdot \\mathbf{E}(\\mathbf{r},\\omega_{k}) \\, d\\mathbf{r} \\right\\}\n\\end{pmatrix}}$$"
        },
        {
            "introduction": "在掌握了连续理论之后，关键在于掌握其离散实现与验证。本练习将指导您为标量波动方程推导离散伴随系统，并实现一个有限差分测试来验证您的梯度计算。所谓的“梯度检验”是计算科学中不可或缺的工具，可以确保您的灵敏度分析代码的正确性，完成此练习将使您获得使用这一关键验证技术的实践经验。",
            "id": "3288672",
            "problem": "考虑一个二维标量频域波模型，该模型通过将横磁极化（transverse-magnetic polarization）条件下的麦克斯韦方程组简化为在方形域上的标量亥姆霍兹型方程而得到，并采用齐次狄利克雷（Dirichlet）边界条件。设计算域离散为一个包含 $N \\times N$ 个内部节点的网格，网格间距为 $\\Delta x$，因此，具有 $n = N^2$ 的离散负拉普拉斯算子 $L \\in \\mathbb{R}^{n \\times n}$ 由标准的五点差分格式给出。定义依赖于参数的系统矩阵为\n$$\nA(\\varepsilon) \\;=\\; L \\;+\\; \\omega^2 \\operatorname{diag}(\\varepsilon),\n$$\n其中 $\\varepsilon \\in \\mathbb{R}^n$ 是网格节点上空间变化的介电常数，$\\omega$ 是角频率。对于一个固定的实值源向量 $b \\in \\mathbb{R}^n$，状态 $u(\\varepsilon) \\in \\mathbb{R}^n$ 满足以下线性系统\n$$\nA(\\varepsilon)\\, u(\\varepsilon) \\;=\\; b.\n$$\n考虑标量目标泛函\n$$\nJ(u) \\;=\\; \\tfrac{1}{2}\\,\\lVert B\\,u \\rVert_2^2,\n$$\n其中 $B \\in \\mathbb{R}^{m \\times n}$ 是一个线性测量算子，用于选择指定的网格节点（例如，单个“传感器”节点）。\n\n您需要验证目标泛函 $J$ 关于对应单个体素（网格节点）索引 $i_0$ 的局部介电常数参数 $p$ 的伴随态梯度。此验证使用有限差分检验来展示渐近一致性。\n\n您的任务如下：\n\n- 从离散正演模型 $A(\\varepsilon)\\,u = b$ 和 $J(u)$ 的定义出发，基于第一性原理推导计算灵敏度 $\\partial J/\\partial p$ 的伴随态方法，其中 $p$ 是体素 $i_0$ 处的 $\\varepsilon$ 值。推导过程仅可使用链式法则、线性系统性质和内积对偶性；不得假定任何预先推导好的梯度公式。\n- 指定一个误差度量，用于比较 $J$ 的一阶变分的伴随预测值与对称有限差分评估值。该度量必须是无量纲的，并且必须能揭示当步长 $h$ 减小时的渐近一致性。\n- 选择一个具体的、完全指定的测试，如下所示：\n  - 使用 $N = 30$ 和 $\\Delta x = 1$，因此 $n = N^2 = 900$。\n  - 使用由五点差分格式构成的离散负拉普拉斯算子 $L$：每个内部节点的主对角线元素为 $4/\\Delta x^2$，四个最近邻的非对角线元素为 $-1/\\Delta x^2$。\n  - 设置 $\\omega = 4$（单位为弧度/秒）。由于最终要求的输出是无量纲的误差度量，因此输出中无需进行单位转换。\n  - 使用均匀背景介电常数 $\\varepsilon_{\\mathrm{bg}} = 1$，即 $\\varepsilon = \\varepsilon_{\\mathrm{bg}} \\mathbf{1}$，但用于有限差分扰动的体素 $i_0$ 除外。\n  - 在网格索引 $(i_s, j_s) = (\\lfloor N/3 \\rfloor, \\lfloor N/3 \\rfloor)$ 处放置一个单位振幅点源，方法是将其对应的 $b$ 向量分量设为 $1$，其余分量设为 $0$。\n  - 定义测量算子 $B$ 以拾取位于 $(i_r, j_r) = (2\\lfloor N/3 \\rfloor, 2\\lfloor N/3 \\rfloor)$ 的单个传感器节点，因此 $m = 1$ 且 $J(u) = \\tfrac{1}{2} \\, |u_{i_r,j_r}|^2$。\n  - 选择参数体素索引 $i_0$ 为中心网格节点 $(\\lfloor N/2 \\rfloor, \\lfloor N/2 \\rfloor)$。\n- 实现一个程序，该程序：\n  - 构建 $L$，并针对每种所需的介电常数，构成 $A(\\varepsilon)$ 并求解 $u$。\n  - 根据您的推导，构建并求解伴随系统，以获得伴随态和在体素 $i_0$ 处的梯度分量 $\\partial J/\\partial p$。\n  - 对于测试集 $h \\in \\{10^{-1}, 10^{-2}, 10^{-3}, 10^{-4}, 10^{-5}\\}$ 中的每个有限差分步长 $h$（在此设置中，$h$ 被解释为对体素介电常数的绝对扰动，是无量纲的），计算对称差分\n    $$\n    \\Delta J_{\\mathrm{fd}}(h) \\;=\\; J\\big(u(\\varepsilon + h\\,e_{i_0})\\big) \\;-\\; J\\big(u(\\varepsilon - h\\,e_{i_0})\\big),\n    $$\n    其中 $e_{i_0}$ 是索引 $i_0$ 处的标准基向量，并将其与伴随一阶预测值 $2h\\,(\\partial J/\\partial p)$ 进行比较。\n  - 对每个 $h$ 使用以下误差度量：\n    $$\n    r(h) \\;=\\; \\frac{\\big|\\Delta J_{\\mathrm{fd}}(h) \\;-\\; 2h\\,(\\partial J/\\partial p)\\big|}{\\max\\!\\big(10^{-14}, \\, \\big|\\Delta J_{\\mathrm{fd}}(h)\\big|\\big)}.\n    $$\n    此度量是无量纲的，并且在舍入误差占主导地位之前，应在渐近区域随 $h$ 的减小而衰减。\n- 输出规范：您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，列表内容为按所提供的测试集步长 $[10^{-1},10^{-2},10^{-3},10^{-4},10^{-5}]$ 顺序排列的结果。每个条目必须是对应 $h$ 的 $r(h)$ 的浮点值，不带单位。\n\n您提交的必须是一个完整的、可运行的程序，该程序能够构建线性系统，计算正演解和伴随解，评估指定步长的梯度和有限差分检验，并以上述确切格式打印结果列表。不允许用户输入。结果值为纯数字（无量纲）。设计必须确保指定配置的科学真实性和数值合理性，并且推导必须从给定的离散模型和目标函数开始，不得使用预先推导的灵敏度公式。",
            "solution": "用户在计算电磁学领域提供了一个定义明确的问题，具体涉及对离散标量亥姆霍兹方程的伴随态梯度进行验证。该问题在科学上是合理的，内容自洽，并且算法上是明确的。我将首先按照要求从第一性原理推导伴随态梯度，然后指定验证程序和误差度量，最后实现数值求解。\n\n### 第 1 部分：伴随态梯度的第一性原理推导\n\n该问题由以下方程定义：\n1. 状态方程：$A(\\varepsilon) u(\\varepsilon) = b$，其中 $A(\\varepsilon) = L + \\omega^2 \\operatorname{diag}(\\varepsilon)$。\n2. 目标泛函：$J(u) = \\frac{1}{2} \\|Bu\\|_2^2$。\n\n令我们感兴趣的参数 $p$ 为单个网格节点 $i_0$ 处的介电常数，即 $p = \\varepsilon_{i_0}$。我们寻求 $J$ 相对于 $p$ 的全导数，记为 $\\frac{dJ}{dp}$。\n\n应用链式法则，$J$ 相对于 $p$ 的导数为：\n$$\n\\frac{dJ}{dp} = \\left(\\nabla_u J\\right)^T \\frac{du}{dp}\n$$\n其中 $\\nabla_u J \\in \\mathbb{R}^n$ 是 $J$ 相对于状态向量 $u$ 的梯度，而 $\\frac{du}{dp} \\in \\mathbb{R}^n$ 是状态相对于参数 $p$ 的灵敏度。\n\n为了找到 $\\frac{du}{dp}$ 的表达式，我们将状态方程对 $p$ 求导。由于源项 $b$ 与 $p$ 无关，其导数为零：\n$$\n\\frac{d}{dp} \\left( A(\\varepsilon(p)) u(\\varepsilon(p)) \\right) = \\frac{db}{dp} = 0\n$$\n$$\n\\frac{dA}{dp} u + A \\frac{du}{dp} = 0\n$$\n求解状态灵敏度 $\\frac{du}{dp}$ 可得：\n$$\n\\frac{du}{dp} = -A^{-1} \\frac{dA}{dp} u\n$$\n将此代入 $\\frac{dJ}{dp}$ 的表达式中：\n$$\n\\frac{dJ}{dp} = -(\\nabla_u J)^T A^{-1} \\frac{dA}{dp} u\n$$\n项 $(\\nabla_u J)^T A^{-1}$ 的计算量可能很大。伴随方法重新排列了计算顺序。利用可逆矩阵 $A$ 的性质 $(A^{-1})^T=(A^T)^{-1}$，我们可以将表达式重写为：\n$$\n\\frac{dJ}{dp} = - \\left( (A^T)^{-1} \\nabla_u J \\right)^T \\frac{dA}{dp} u\n$$\n我们现在将伴随态向量 $\\lambda \\in \\mathbb{R}^n$ 定义为伴随方程的解：\n$$\nA^T \\lambda = \\nabla_u J\n$$\n将 $\\lambda = (A^T)^{-1} \\nabla_u J$ 代入梯度表达式，我们得到梯度的伴随公式：\n$$\n\\frac{dJ}{dp} = -\\lambda^T \\frac{dA}{dp} u\n$$\n这个公式在计算上是高效的。它需要为 $u$ 求解一个正演线性系统，为 $\\lambda$ 求解一个伴随线性系统，然后通过向量积为每个感兴趣的参数计算梯度。\n\n现在我们将这个一般性结果具体化到给定问题上：\n- **目标梯度 $\\nabla_u J$**：目标函数为 $J(u) = \\frac{1}{2} u^T B^T B u$。其相对于 $u$ 的梯度是 $\\nabla_u J = B^T B u$。在我们的具体案例中，$B$ 选择单个节点 $i_r$，因此 $B = e_{i_r}^T$。从而，$B^T B = e_{i_r}e_{i_r}^T$，这是一个除了在对角线位置 $(i_r, i_r)$ 处为 $1$ 外，其余元素均为零的矩阵。乘积 $B^T B u$ 是一个向量，除了在索引 $i_r$ 处值为 $u_{i_r}$ 外，其他位置均为零。所以，$\\nabla_u J = u_{i_r} e_{i_r}$。\n- **系统矩阵对称性**：矩阵 $A(\\varepsilon) = L + \\omega^2 \\operatorname{diag}(\\varepsilon)$ 是对称的。用于标准五点差分格式的离散负拉普拉斯算子 $L$ 是对称的，而 $\\operatorname{diag}(\\varepsilon)$ 是一个对角矩阵，因此也是对称的。所以 $A^T = A$。\n- **伴随方程**：伴随方程 $A^T \\lambda = \\nabla_u J$ 简化为 $A \\lambda = u_{i_r} e_{i_r}$。\n- **矩阵导数 $\\frac{dA}{dp}$**：参数为 $p = \\varepsilon_{i_0}$。介电常数向量 $\\varepsilon$ 仅在索引 $i_0$ 处依赖于 $p$，所以 $\\frac{\\partial \\varepsilon}{\\partial p} = e_{i_0}$。系统矩阵的导数是：\n$$\n\\frac{dA}{dp} = \\frac{d}{dp}\\left(L + \\omega^2 \\operatorname{diag}(\\varepsilon)\\right) = \\omega^2 \\operatorname{diag}\\left(\\frac{d\\varepsilon}{dp}\\right) = \\omega^2 \\operatorname{diag}(e_{i_0})\n$$\n矩阵 $\\operatorname{diag}(e_{i_0})$ 是一个只有一个非零项的矩阵，该项为 $1$，位于位置 $(i_0, i_0)$。\n- **最终梯度表达式**：将这些分量代入伴随梯度公式：\n$$\n\\frac{dJ}{dp} = -\\lambda^T \\left( \\omega^2 \\operatorname{diag}(e_{i_0}) \\right) u\n$$\n乘积 $\\left( \\operatorname{diag}(e_{i_0}) \\right) u$ 产生一个向量，其唯一的非零分量是在索引 $i_0$ 处的 $u_{i_0}$。随后与 $\\lambda^T$ 的内积会提取出第 $i_0$ 个分量，得到：\n$$\n\\frac{\\partial J}{\\partial p} = -\\omega^2 \\lambda_{i_0} u_{i_0}\n$$\n\n### 第 2 部分：误差度量与验证程序\n\n为验证所推导的梯度，我们将其对 $J$ 变化量的预测与通过对称有限差分格式计算出的结果进行比较。泰勒级数展开表明，对于一个小的步长 $h$：\n$$\nJ(p+h) - J(p-h) = 2h \\frac{\\partial J}{\\partial p} + O(h^3)\n$$\n左边的项是对称有限差分变分 $\\Delta J_{\\mathrm{fd}}(h)$。右边的第一项是基于伴随态梯度的一阶预测。它们之间的差异是截断误差，其阶数为 $O(h^3)$。\n\n所提供的误差度量为：\n$$\nr(h) = \\frac{\\big|\\Delta J_{\\mathrm{fd}}(h) - 2h\\,(\\partial J/\\partial p)\\big|}{\\max\\!\\big(10^{-14}, \\, \\big|\\Delta J_{\\mathrm{fd}}(h)\\big|\\big)}\n$$\n分子是绝对截断误差，预计为 $O(h^3)$ 阶。分母主要由 $|\\Delta J_{\\mathrm{fd}}(h)|$ 决定，其近似等于 $|2h (\\partial J/\\partial p)| = O(h)$。因此，相对误差度量 $r(h)$ 预计为 $O(h^2)$ 阶。这种随 $h$ 减小而呈现的二次收敛性是梯度计算正确的有力指标。分母中的项 $10^{-14}$ 作为下限，以防止在 $h$ 变得极小时出现除以零或除以数值上无意义的值。\n\n### 第 3 部分：数值实现计划\n\n1.  **设置**：定义常量：$N=30$, $n=N^2=900$, $\\Delta x=1$, $\\omega=4$, $\\varepsilon_{\\mathrm{bg}}=1$。确定源 $(k_s)$、接收器 $(k_r)$ 和参数 $(k_p)$ 的一维索引。\n2.  **矩阵构建**：为 $N \\times N$ 网格构建具有狄利克雷边界条件的稀疏离散负拉普拉斯算子 $L$。\n3.  **伴随梯度计算**：\n    a.  设置 $\\varepsilon = \\varepsilon_{\\mathrm{bg}}\\mathbf{1}$。\n    b.  构建标称矩阵 $A = L + \\omega^2 \\operatorname{diag}(\\varepsilon)$。\n    c.  构建源向量 $b = e_{k_s}$。\n    d.  求解正演系统 $Au = b$ 以获得状态 $u$。\n    e.  构建伴随源 $f_{adj} = u_{k_r} e_{k_r}$。\n    f.  求解伴随系统 $A\\lambda = f_{adj}$ 以获得伴随态 $\\lambda$。\n    g.  计算梯度 $\\frac{\\partial J}{\\partial p} = -\\omega^2 \\lambda_{k_p} u_{k_p}$。\n4.  **有限差分循环**：对于 $\\{10^{-1}, 10^{-2}, 10^{-3}, 10^{-4}, 10^{-5}\\}$ 中的每个步长 $h$：\n    a.  创建扰动后的介电常数向量 $\\varepsilon_{\\pm} = \\varepsilon_{\\mathrm{bg}}\\mathbf{1} \\pm h e_{k_p}$。\n    b.  构建扰动后的矩阵 $A_{\\pm} = L + \\omega^2 \\operatorname{diag}(\\varepsilon_{\\pm})$。\n    c.  求解系统 $A_{\\pm}u_{\\pm} = b$ 以获得状态 $u_{\\pm}$。\n    d.  计算目标函数值 $J_{\\pm} = \\frac{1}{2} (u_{\\pm})_{k_r}^2$。\n    e.  计算有限差分变分 $\\Delta J_{\\mathrm{fd}}(h) = J_+ - J_-$。\n    f.  按规定计算误差度量 $r(h)$。\n5.  **输出**：收集 $r(h)$ 的值并按要求格式打印。为提高效率，将使用来自 `scipy.sparse` 和 `scipy.sparse.linalg` 的稀疏线性代数程序。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nimport scipy.sparse as sp\nimport scipy.sparse.linalg as spla\n\ndef solve():\n    \"\"\"\n    Performs adjoint-state sensitivity analysis for a 2D scalar wave equation\n    and validates the gradient using a finite-difference test.\n    \"\"\"\n\n    # 1. Setup: Define problem parameters\n    N = 30\n    n = N * N\n    dx = 1.0\n    omega = 4.0\n    omega2 = omega**2\n    eps_bg_val = 1.0\n\n    # Grid locations and their 1D indices\n    is_src, js_src = N // 3, N // 3\n    k_src = is_src * N + js_src\n\n    is_rcv, js_rcv = 2 * (N // 3), 2 * (N // 3)\n    k_rcv = is_rcv * N + js_rcv\n\n    is_param, js_param = N // 2, N // 2\n    k_param = is_param * N + js_param\n    \n    # Finite-difference step sizes\n    h_steps = [10**(-i) for i in range(1, 6)]\n\n    # 2. Matrix Construction: Build the discrete Laplacian L\n    # Using LIL format for easy construction, then CSR for efficient computation\n    L = sp.lil_matrix((n, n), dtype=np.float64)\n    laplacian_coeff = 1.0 / (dx**2)\n\n    for i in range(N):\n        for j in range(N):\n            k = i * N + j\n            \n            # Main diagonal\n            L[k, k] = 4.0 * laplacian_coeff\n            \n            # Off-diagonals for neighbors\n            if i > 0:   # Neighbor above\n                L[k, k - N] = -1.0 * laplacian_coeff\n            if i < N - 1: # Neighbor below\n                L[k, k + N] = -1.0 * laplacian_coeff\n            if j > 0:   # Neighbor left\n                L[k, k - 1] = -1.0 * laplacian_coeff\n            if j < N - 1: # Neighbor right\n                L[k, k + 1] = -1.0 * laplacian_coeff\n    \n    # Convert to CSR (Compressed Sparse Row) format for fast arithmetic and solving\n    L = L.tocsr()\n\n    # 3. Adjoint Gradient Calculation\n    \n    # Background permittivity vector\n    eps_bg = np.full(n, eps_bg_val, dtype=np.float64)\n    \n    # System matrix A for the background medium\n    A_bg = L + sp.diags(omega2 * eps_bg, 0, format='csr')\n\n    # Source vector b (point source)\n    b = np.zeros(n, dtype=np.float64)\n    b[k_src] = 1.0\n\n    # a. Solve forward problem for state u\n    u = spla.spsolve(A_bg, b)\n\n    # b. Solve adjoint problem for lambda\n    # Adjoint source f_adj = B^T * B * u. For B = e_{k_rcv}^T, this is u[k_rcv] * e_{k_rcv}\n    adj_rhs = np.zeros(n, dtype=np.float64)\n    adj_rhs[k_rcv] = u[k_rcv]\n    \n    # The adjoint system matrix is A^T. Since A is symmetric, A^T = A.\n    adjoint_state = spla.spsolve(A_bg, adj_rhs)\n\n    # c. Compute the gradient dJ/dp\n    # dJ/dp = -omega^2 * lambda[k_param] * u[k_param]\n    grad_adj = -omega2 * adjoint_state[k_param] * u[k_param]\n    \n    # 4. Finite-Difference Validation Loop\n    results = []\n    \n    for h in h_steps:\n        # Perturb permittivity up and down\n        eps_plus = eps_bg.copy()\n        eps_plus[k_param] += h\n        \n        eps_minus = eps_bg.copy()\n        eps_minus[k_param] -= h\n        \n        # Form perturbed system matrices\n        A_plus = L + sp.diags(omega2 * eps_plus, 0, format='csr')\n        A_minus = L + sp.diags(omega2 * eps_minus, 0, format='csr')\n        \n        # Solve for perturbed states\n        u_plus = spla.spsolve(A_plus, b)\n        u_minus = spla.spsolve(A_minus, b)\n        \n        # Calculate objective function for each state\n        # J(u) = 0.5 * u[k_rcv]^2\n        J_plus = 0.5 * u_plus[k_rcv]**2\n        J_minus = 0.5 * u_minus[k_rcv]**2\n        \n        # Symmetric finite-difference variation\n        delta_J_fd = J_plus - J_minus\n        \n        # Adjoint first-order prediction of the variation\n        delta_J_adj = 2.0 * h * grad_adj\n        \n        # Compute the relative error metric\n        denominator = max(1e-14, abs(delta_J_fd))\n        error_metric = abs(delta_J_fd - delta_J_adj) / denominator\n        \n        results.append(error_metric)\n\n    # 5. Output\n    # The problem asks for the floating point values in a list format\n    print(f\"[{','.join(f'{r:.15g}' for r in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "最后的这个练习将伴随法扩展到一个更高级的主题：特征值问题。您将计算谐振腔的复数谐振频率和品质因子的灵敏度，这需要应用适用于非厄米（non-Hermitian）系统的双正交性（biorthogonality）概念，这在电磁学中很常见。许多电磁设计问题，如滤波器和激光器，其本质都是优化谐振模式，因此该练习为您提供了特征值灵敏度分析的直接经验。",
            "id": "3288711",
            "problem": "考虑一个带有完美匹配层 (PML) 的离散化电磁谐振腔，其模型为一个非厄米广义本征问题。设半离散频域矢量波动方程写为广义本征问题 $A \\mathbf{e} = \\tilde{\\omega} B \\mathbf{e}$，其中 $A \\in \\mathbb{C}^{n \\times n}$ 表示因 PML 引起的复坐标伸展而修正的离散化旋度-旋度算子，$B \\in \\mathbb{R}^{n \\times n}$ 表示离散化的介电常数权重，$\\mathbf{e} \\in \\mathbb{C}^{n}$ 是近似电场的右本征矢量，$\\tilde{\\omega} \\in \\mathbb{C}$ 是以弧度/秒 (rad/s) 表示的复谐振频率。在存在 PML 的情况下，算子 $A$ 通常是复对称且非厄米的，而合适的伴随态内积是使用转置（而非共轭转置）的双正交“复对称”双线性形式。\n\n从频域中的 Maxwell 方程组和弱形式离散化出发，根据第一性原理推导复谐振频率 $\\tilde{\\omega}$ 对相对介电常数（无量纲）场 $\\delta \\epsilon(\\mathbf{r})$ 中微小空间扰动的一阶灵敏度，该扰动在 $B$ 中编码为对角扰动 $\\delta B$。使用适用于复对称算子的伴随态方法和双正交伴随本征模。然后，利用推导出的 $\\tilde{\\omega}$ 的灵敏度，确定该模式的品质因子 (Quality factor (Q)) $Q = -\\Re(\\tilde{\\omega})/(2 \\Im(\\tilde{\\omega}))$ 的相应一阶灵敏度，其中将 $Q$ 视为 $\\Re(\\tilde{\\omega})$ 和 $\\Im(\\tilde{\\omega})$ 的函数并应用一阶微扰。\n\n您的任务是把推导出的表达式实现为一个完整、可运行的程序。对于下面的每个测试用例，选择具有物理意义的模式，即在虚部为负的本征对中，实部最大的那个（以确保品质因子为正）。计算：\n- 对于扰动 $\\delta B(\\alpha) = \\alpha \\,\\mathrm{diag}(\\mathbf{d})$，在 $\\alpha = 0$ 处的一阶灵敏度 $d\\tilde{\\omega}/d\\alpha$，以两个浮点数报告：$\\Re\\left(d\\tilde{\\omega}/d\\alpha\\right)$ 和 $\\Im\\left(d\\tilde{\\omega}/d\\alpha\\right)$，两者均以弧度/秒/单位扰动幅度 $\\alpha$ (rad/s) 表示。\n- 在 $\\alpha = 0$ 处的一阶灵敏度 $dQ/d\\alpha$，以一个浮点数报告（无量纲/单位 $\\alpha$）。\n\n所有答案必须用以下单位表示：\n- $\\tilde{\\omega}$ 及其灵敏度的单位为弧度/秒 (rad/s) /单位 $\\alpha$。\n- $Q$ 及其灵敏度为无量纲/单位 $\\alpha$。\n- 扰动矢量 $\\mathbf{d}$ 是相对介电常数分布中的一个无量纲变化。\n\n测试套件（三个案例）：\n使用 $n = 5$，并将基线类刚度矩阵 $K \\in \\mathbb{R}^{5 \\times 5}$ 定义为\n$$\nK = \\begin{bmatrix}\n2  -1  0  0  0 \\\\\n-1  2  -1  0  0 \\\\\n0  -1  2  -1  0 \\\\\n0  0  -1  2  -1 \\\\\n0  0  0  -1  2\n\\end{bmatrix}.\n$$\n\n案例 1 (正常路径):\n- PML 分布 $\\Sigma_1 = \\mathrm{diag}\\left(0,\\,0.1,\\,0.4,\\,0.7,\\,1.0\\right)$。\n- 算子 $A_1 = K - \\mathrm{i}\\,\\Sigma_1$。\n- 介电常数权重 $B_1 = \\mathrm{diag}\\left(2.5,\\,3.0,\\,3.5,\\,4.0,\\,4.5\\right)$。\n- 扰动矢量 $\\mathbf{d}_1 = \\left[0,\\,0,\\,1,\\,0,\\,0\\right]$，因此 $\\delta B_1(\\alpha) = \\alpha\\,\\mathrm{diag}(\\mathbf{d}_1)$。\n\n案例 2 (显著的 PML，分布式扰动):\n- PML 分布 $\\Sigma_2 = \\mathrm{diag}\\left(0,\\,0.5,\\,1.0,\\,1.5,\\,2.0\\right)$。\n- 算子 $A_2 = K - \\mathrm{i}\\,\\Sigma_2$。\n- 介电常数权重 $B_2 = \\mathrm{diag}\\left(1.8,\\,2.2,\\,2.6,\\,3.0,\\,3.4\\right)$。\n- 扰动矢量 $\\mathbf{d}_2 = \\left[1,\\,0,\\,0,\\,0,\\,1\\right]$，因此 $\\delta B_2(\\alpha) = \\alpha\\,\\mathrm{diag}(\\mathbf{d}_2)$。\n\n案例 3 (边界情况：零扰动):\n- 使用 $A_3 = A_1$ 和 $B_3 = B_1$。\n- 扰动矢量 $\\mathbf{d}_3 = \\left[0,\\,0,\\,0,\\,0,\\,0\\right]$，因此 $\\delta B_3(\\alpha) = \\alpha\\,\\mathrm{diag}(\\mathbf{d}_3)$。\n\n算法要求：\n- 求解 $A \\mathbf{e} = \\tilde{\\omega} B \\mathbf{e}$ 以获得本征对 $(\\tilde{\\omega}, \\mathbf{e})$。\n- 在构成所需的内积时，使用适用于复对称算子的双正交伴随态双线性形式（基于转积而非共轭）。\n- 按上述规定选择模式。\n- 使用您推导出的表达式计算在 $\\alpha = 0$ 处的值 $d\\tilde{\\omega}/d\\alpha$。\n- 利用计算出的 $d\\tilde{\\omega}/d\\alpha$，通过一阶微扰从 $Q = -\\Re(\\tilde{\\omega})/(2\\Im(\\tilde{\\omega}))$ 计算 $dQ/d\\alpha$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表。每个测试用例对应一个子列表，其中包含恰好三个浮点数，顺序为 $\\left[\\Re\\left(d\\tilde{\\omega}/d\\alpha\\right), \\Im\\left(d\\tilde{\\omega}/d\\alpha\\right), dQ/d\\alpha\\right]$。例如，输出应如下所示：\n$[\\,[x_1, y_1, z_1],\\,[x_2, y_2, z_2],\\,[x_3, y_3, z_3]\\,]$,\n不打印任何附加文本。",
            "solution": "用户提供了一个计算电磁学中有效且适定的问题。我将首先从第一性原理推导必要的灵敏度表达式，然后提供一个 Python 实现来计算给定测试用例所需的值。\n\n### 一阶灵敏度的推导\n\n**1. 复谐振频率 $\\tilde{\\omega}$ 的灵敏度**\n\n我们从离散化的频域波动方程开始，该方程表示为一个依赖于扰动参数 $\\alpha$ 的广义本征值问题：\n$$A \\mathbf{e}(\\alpha) = \\tilde{\\omega}(\\alpha) B(\\alpha) \\mathbf{e}(\\alpha)$$\n此处，$A$ 是恒定的系统矩阵，而介电常数矩阵 $B(\\alpha) = B_0 + \\alpha \\frac{dB}{d\\alpha}$ 受到扰动。在 $\\alpha=0$ 时的未扰动问题是 $A \\mathbf{e} = \\tilde{\\omega} B \\mathbf{e}$，为简洁起见，我们省略了对 $\\alpha$ 的显式依赖。\n\n为了求得灵敏度 $\\frac{d\\tilde{\\omega}}{d\\alpha}$，我们将控制方程对 $\\alpha$ 求导，并在 $\\alpha=0$ 处取值：\n$$A \\frac{d\\mathbf{e}}{d\\alpha} \\bigg|_{\\alpha=0} = \\frac{d\\tilde{\\omega}}{d\\alpha} \\bigg|_{\\alpha=0} B \\mathbf{e} + \\tilde{\\omega} \\frac{dB}{d\\alpha} \\bigg|_{\\alpha=0} \\mathbf{e} + \\tilde{\\omega} B \\frac{d\\mathbf{e}}{d\\alpha} \\bigg|_{\\alpha=0}$$\n\n问题陈述算子 $A$ 是复对称的，即 $A = A^T$。矩阵 $B$ 代表介电常数，是实对角矩阵，因此也是对称的 ($B=B^T$)。对于此类复对称系统，左本征矢量就是右本征矢量的转置。通过对原方程进行转置可以得到伴随问题：\n$$ (A \\mathbf{e})^T = (\\tilde{\\omega} B \\mathbf{e})^T \\implies \\mathbf{e}^T A^T = \\tilde{\\omega} \\mathbf{e}^T B^T $$\n由于 $A=A^T$ 和 $B=B^T$，上式变为：\n$$ \\mathbf{e}^T A = \\tilde{\\omega} \\mathbf{e}^T B $$\n这就是伴随本征值方程，其伴随本征矢量为 $\\mathbf{e}^T$。\n\n现在我们应用伴随方法。我们用伴随本征矢量 $\\mathbf{e}^T$ 左乘求导后的方程：\n$$ \\mathbf{e}^T A \\left(\\frac{d\\mathbf{e}}{d\\alpha}\\right) = \\left(\\frac{d\\tilde{\\omega}}{d\\alpha}\\right) \\mathbf{e}^T B \\mathbf{e} + \\tilde{\\omega} \\mathbf{e}^T \\left(\\frac{dB}{d\\alpha}\\right) \\mathbf{e} + \\tilde{\\omega} \\mathbf{e}^T B \\left(\\frac{d\\mathbf{e}}{d\\alpha}\\right) $$\n（所有导数均在 $\\alpha=0$ 处取值）。\n\n利用伴随性质 $\\mathbf{e}^T A = \\tilde{\\omega} \\mathbf{e}^T B$，我们将其代入等式左边：\n$$ \\tilde{\\omega} \\mathbf{e}^T B \\left(\\frac{d\\mathbf{e}}{d\\alpha}\\right) = \\left(\\frac{d\\tilde{\\omega}}{d\\alpha}\\right) \\mathbf{e}^T B \\mathbf{e} + \\tilde{\\omega} \\mathbf{e}^T \\left(\\frac{dB}{d\\alpha}\\right) \\mathbf{e} + \\tilde{\\omega} \\mathbf{e}^T B \\left(\\frac{d\\mathbf{e}}{d\\alpha}\\right) $$\n\n项 $\\tilde{\\omega} \\mathbf{e}^T B \\left(\\frac{d\\mathbf{e}}{d\\alpha}\\right)$ 在等式两边都出现，因此可以消去。剩下：\n$$ 0 = \\left(\\frac{d\\tilde{\\omega}}{d\\alpha}\\right) \\mathbf{e}^T B \\mathbf{e} + \\tilde{\\omega} \\mathbf{e}^T \\left(\\frac{dB}{d\\alpha}\\right) \\mathbf{e} $$\n\n求解频率灵敏度 $\\frac{d\\tilde{\\omega}}{d\\alpha}$，得到该问题伴随态分析的核心结果：\n$$ \\frac{d\\tilde{\\omega}}{d\\alpha} = - \\frac{\\tilde{\\omega} \\, \\mathbf{e}^T \\frac{dB}{d\\alpha} \\mathbf{e}}{\\mathbf{e}^T B \\mathbf{e}} $$\n扰动由 $\\delta B(\\alpha) = \\alpha \\, \\mathrm{diag}(\\mathbf{d})$ 给出，因此 $\\frac{dB}{d\\alpha} = \\mathrm{diag}(\\mathbf{d})$。灵敏度与本征矢量 $\\mathbf{e}$ 的归一化无关。双线性形式 $\\mathbf{u}^T \\mathbf{v}$ 对应于指定的双正交内积。\n\n**2. 品质因子 $Q$ 的灵敏度**\n\n品质因子 $Q$ 定义为 $Q = -\\frac{\\Re(\\tilde{\\omega})}{2\\Im(\\tilde{\\omega})}$。令 $\\tilde{\\omega} = \\omega_r + i\\omega_i$，则 $Q = -\\frac{\\omega_r}{2\\omega_i}$。我们将 $Q$ 视为 $\\omega_r$ 和 $\\omega_i$ 的函数，并使用链式法则求其关于 $\\alpha$ 的灵敏度：\n$$ \\frac{dQ}{d\\alpha} = \\frac{\\partial Q}{\\partial \\omega_r} \\frac{d\\omega_r}{d\\alpha} + \\frac{\\partial Q}{\\partial \\omega_i} \\frac{d\\omega_i}{d\\alpha} $$\n\n首先，我们求 $Q$ 的偏导数：\n$$ \\frac{\\partial Q}{\\partial \\omega_r} = \\frac{\\partial}{\\partial \\omega_r}\\left(-\\frac{\\omega_r}{2\\omega_i}\\right) = -\\frac{1}{2\\omega_i} $$\n$$ \\frac{\\partial Q}{\\partial \\omega_i} = \\frac{\\partial}{\\partial \\omega_i}\\left(-\\frac{\\omega_r}{2\\omega_i}\\right) = -\\frac{\\omega_r}{2} \\left(-\\frac{1}{\\omega_i^2}\\right) = \\frac{\\omega_r}{2\\omega_i^2} $$\n\n导数 $\\frac{d\\omega_r}{d\\alpha}$ 和 $\\frac{d\\omega_i}{d\\alpha}$ 是我们推导出的复频率灵敏度的实部和虚部：\n$$ \\frac{d\\omega_r}{d\\alpha} = \\Re\\left(\\frac{d\\tilde{\\omega}}{d\\alpha}\\right) \\quad \\text{和} \\quad \\frac{d\\omega_i}{d\\alpha} = \\Im\\left(\\frac{d\\tilde{\\omega}}{d\\alpha}\\right) $$\n\n将这些代入链式法则表达式中：\n$$ \\frac{dQ}{d\\alpha} = \\left(-\\frac{1}{2\\omega_i}\\right) \\Re\\left(\\frac{d\\tilde{\\omega}}{d\\alpha}\\right) + \\left(\\frac{\\omega_r}{2\\omega_i^2}\\right) \\Im\\left(\\frac{d\\tilde{\\omega}}{d\\alpha}\\right) $$\n\n这个表达式可以通过代入 $\\omega_r = -2Q\\omega_i$ 用 $Q$ 本身重写：\n$$ \\frac{dQ}{d\\alpha} = -\\frac{1}{2\\omega_i} \\Re\\left(\\frac{d\\tilde{\\omega}}{d\\alpha}\\right) + \\frac{-2Q\\omega_i}{2\\omega_i^2} \\Im\\left(\\frac{d\\tilde{\\omega}}{d\\alpha}\\right) $$\n$$ \\frac{dQ}{d\\alpha} = -\\frac{1}{2\\Im(\\tilde{\\omega})} \\Re\\left(\\frac{d\\tilde{\\omega}}{d\\alpha}\\right) - \\frac{Q}{\\Im(\\tilde{\\omega})} \\Im\\left(\\frac{d\\tilde{\\omega}}{d\\alpha}\\right) $$\n这是品质因子灵敏度的最终表达式。右边的所有量都由未扰动的本征问题和推导出的频率灵敏度确定。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import eig\n\ndef solve():\n    \"\"\"\n    Solves for the sensitivity of complex frequency and Quality factor\n    for a discretized electromagnetic cavity model.\n    \"\"\"\n    \n    # Define the baseline stiffness-like matrix K\n    n = 5\n    K = np.diag(np.full(n, 2.0)) - np.diag(np.full(n - 1, 1.0), k=1) - np.diag(np.full(n - 1, 1.0), k=-1)\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"Sigma_diag\": [0.0, 0.1, 0.4, 0.7, 1.0],\n            \"B_diag\": [2.5, 3.0, 3.5, 4.0, 4.5],\n            \"d_vec\": [0.0, 0.0, 1.0, 0.0, 0.0],\n        },\n        {\n            \"Sigma_diag\": [0.0, 0.5, 1.0, 1.5, 2.0],\n            \"B_diag\": [1.8, 2.2, 2.6, 3.0, 3.4],\n            \"d_vec\": [1.0, 0.0, 0.0, 0.0, 1.0],\n        },\n        {\n            \"Sigma_diag\": [0.0, 0.1, 0.4, 0.7, 1.0],\n            \"B_diag\": [2.5, 3.0, 3.5, 4.0, 4.5],\n            \"d_vec\": [0.0, 0.0, 0.0, 0.0, 0.0],\n        },\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        # 1. Construct matrices for the current case\n        Sigma = np.diag(case[\"Sigma_diag\"])\n        A = K - 1j * Sigma\n        B = np.diag(case[\"B_diag\"])\n        d_vec = np.array(case[\"d_vec\"])\n        dB_d_alpha = np.diag(d_vec)\n\n        # 2. Solve the generalized eigenvalue problem A*e = omega*B*e\n        omegas, e_vectors = eig(A, B)\n\n        # 3. Select the physically relevant mode\n        # Find indices of modes with negative imaginary part (representing loss)\n        # A small tolerance is used to handle floating-point inaccuracies near zero.\n        valid_indices = np.where(omegas.imag < -1e-12)[0]\n        \n        if valid_indices.size == 0:\n            # This case is not expected based on problem physics but is handled defensively.\n            # If no lossy modes are found, sensitivities cannot be computed as specified.\n            results.append([np.nan, np.nan, np.nan])\n            continue\n\n        # Filter the eigenpairs to include only the valid ones\n        valid_omegas = omegas[valid_indices]\n        valid_e_vectors = e_vectors[:, valid_indices]\n\n        # Among the valid modes, find the one with the largest real part\n        target_idx = np.argmax(valid_omegas.real)\n        \n        # This is the selected eigenpair for sensitivity analysis\n        omega = valid_omegas[target_idx]\n        e_vec = valid_e_vectors[:, target_idx]\n\n        # 4. Compute the sensitivity of the complex frequency d(omega)/d(alpha)\n        # Numerator: -omega * (e^T * dB/dalpha * e)\n        # Denominator: e^T * B * e\n        # The bilinear form u^T*v is computed using np.dot(u, v) for 1D arrays\n        numerator_d_omega = -omega * np.dot(e_vec, dB_d_alpha @ e_vec)\n        denominator_d_omega = np.dot(e_vec, B @ e_vec)\n        \n        if abs(denominator_d_omega) < 1e-15:\n             # This should not happen for a physical mode.\n            d_omega_d_alpha = complex(0, 0)\n        else:\n            d_omega_d_alpha = numerator_d_omega / denominator_d_omega\n\n        # 5. Compute the Quality factor Q\n        # Defensive check for division by zero\n        if abs(omega.imag) < 1e-15:\n            Q = np.inf\n        else:\n            Q = -omega.real / (2 * omega.imag)\n\n        # 6. Compute the sensitivity of the Quality factor dQ/d(alpha)\n        if abs(omega.imag) < 1e-15 or np.isinf(Q):\n            dQ_d_alpha = np.nan\n        else:\n            term1 = (-1.0 / (2.0 * omega.imag)) * d_omega_d_alpha.real\n            term2 = (-Q / omega.imag) * d_omega_d_alpha.imag\n            dQ_d_alpha = term1 + term2\n        \n        results.append([d_omega_d_alpha.real, d_omega_d_alpha.imag, dQ_d_alpha])\n\n    # Final print statement in the exact required format.\n    formatted_cases = []\n    for res_case in results:\n        # Format each case without spaces inside the brackets\n        case_str = f\"[{res_case[0]},{res_case[1]},{res_case[2]}]\"\n        formatted_cases.append(case_str)\n    \n    final_output_str = f\"[{','.join(formatted_cases)}]\"\n    print(final_output_str)\n\nsolve()\n```"
        }
    ]
}