{
    "hands_on_practices": [
        {
            "introduction": "The first step in building confidence in any numerical simulation is verifying that its discrete algorithms correctly represent fundamental physical laws. In computational electromagnetics, this means ensuring that conservation laws, such as the Poynting theorem for energy, are upheld in their discretized form. This exercise provides a direct numerical test of the time-average Poynting theorem, where you will implement a simple numerical quadrature to approximate the power integrals for a known analytic field—a uniform plane wave in a lossy medium. By confirming that the numerically calculated outgoing power equals the input power minus the volumetric ohmic losses , you will gain foundational experience in translating continuous physical principles into a verifiable computational framework.",
            "id": "3342602",
            "problem": "You are asked to demonstrate energy conservation in the frequency-domain setting of computational electromagnetics by constructing a discrete time-average Poynting flux over non-port boundaries and verifying that the discrete outward power balance equals the input port power minus the volumetric Ohmic dissipation. You must do this in a self-contained program for a two-dimensional transverse electric to the axis scenario with a known analytic field, using a simple quadrature that mimics a first-order finite element method.\n\nConsider a rectangular domain $\\Omega = [0,L_x]\\times[0,L_y]$ filled with a homogeneous, isotropic medium with permeability $\\mu=\\mu_0$, permittivity $\\varepsilon=\\varepsilon_0 \\varepsilon_r$, and conductivity $\\sigma$. Adopt the time-harmonic convention $e^{+j\\omega t}$, where $\\omega=2\\pi f$. Take the scalar electric field component $E_z(x,y)$ nonzero (transverse electric to the axis), and the magnetic field components $H_x(x,y)$ and $H_y(x,y)$ nonzero. Use the following as the fundamental base:\n\n- The curl equations of Maxwell’s equations in the frequency domain: $\\nabla\\times \\mathbf{E} = -j\\omega \\mu \\mathbf{H}$ and $\\nabla\\times \\mathbf{H} = (\\sigma + j\\omega \\varepsilon)\\mathbf{E}$.\n- The time-average Poynting vector definition: $\\langle \\mathbf{S} \\rangle = \\tfrac{1}{2}\\operatorname{Re}\\{\\mathbf{E}\\times \\mathbf{H}^*\\}$.\n- The time-average Ohmic power dissipation density: $\\tfrac{1}{2}\\sigma|\\mathbf{E}|^2$.\n\nUse the analytic field corresponding to a uniform plane wave propagating in the $+x$ direction with attenuation, restricted to the two-dimensional setup with $E_z$ polarization:\n- Propagation constant $\\gamma = \\sqrt{j\\omega \\mu (\\sigma + j\\omega \\varepsilon)}$.\n- Intrinsic impedance $\\eta_c = \\sqrt{\\dfrac{j\\omega \\mu}{\\sigma + j\\omega \\varepsilon}}$.\n- Field phasors $E_z(x,y) = E_0 e^{-\\gamma x}$, $H_x(x,y)=0$, $H_y(x,y) = -E_z(x,y)/\\eta_c$.\n\nConstruct a discrete outward power balance as follows, using a structured grid and midpoint quadrature that emulates a lowest-order finite element discretization:\n\n- Partition the domain into $N_x\\times N_y$ rectangular cells of uniform sizes $\\Delta x = L_x/N_x$ and $\\Delta y = L_y/N_y$.\n- Define the discrete boundary flux $\\int_{\\partial\\Omega\\setminus\\Gamma_{\\text{port}}}\\mathbf{S}_h\\cdot \\hat{n}\\, dA$ by summing midpoint contributions over all non-port boundary edges, where $\\Gamma_{\\text{port}}$ is the driven port at $x=0$. In this geometry with the given fields, only the boundary at $x=L_x$ contributes nonzero flux. Approximate the boundary integral by midpoint rule over the $N_y$ boundary edges: for each edge midpoint at $(x=L_x, y=(j+\\tfrac{1}{2})\\Delta y)$, compute $\\mathbf{S}_h = \\tfrac{1}{2}\\operatorname{Re}\\{\\mathbf{E}\\times \\mathbf{H}^*\\}$ and accumulate $\\mathbf{S}_h\\cdot \\hat{n}$ times $\\Delta y$.\n- Define the input port power $P_{\\text{port}}$ as the incoming power across $x=0$, i.e., $P_{\\text{port}} = -\\int_{\\Gamma_{\\text{port}}}\\langle \\mathbf{S}\\rangle \\cdot \\hat{n}\\, dA$. Approximate it by the midpoint rule over the $N_y$ edges at $x=0$.\n- Define the discrete volumetric loss $\\int_{\\Omega} \\tfrac{1}{2}\\sigma|\\mathbf{E}|^2\\, dV$ by midpoint quadrature over the $N_x\\times N_y$ cells: at each cell center $(x=(i+\\tfrac{1}{2})\\Delta x, y=(j+\\tfrac{1}{2})\\Delta y)$, accumulate $\\tfrac{1}{2}\\sigma|E_z|^2 \\Delta x \\Delta y$.\n\nYour program must compute, for each test case, the scalar residual\n$$R = \\left(\\int_{\\partial\\Omega\\setminus\\Gamma_{\\text{port}}}\\mathbf{S}_h\\cdot \\hat{n}\\, dA\\right) - \\left(P_{\\text{port}} - \\int_{\\Omega} \\tfrac{1}{2}\\sigma|\\mathbf{E}|^2\\, dV\\right),$$\nwhich is expected to be approximately zero for a correct construction, up to quadrature and floating-point error. All powers must be expressed in watts, and your final residuals $R$ must be reported in watts.\n\nAngle units are not used. All physical constants must be in the International System of Units (SI). Use $\\mu_0 = 4\\pi\\times 10^{-7}$ and $\\varepsilon_0 \\approx 8.854187817\\times 10^{-12}$.\n\nTest suite:\n- Case $1$: $f=3.0\\times 10^{9}$ (hertz), $\\varepsilon_r=1.0$, $\\sigma=2.0\\times 10^{-2}$ (siemens per meter), $L_x=5.0\\times 10^{-1}$ (meter), $L_y=3.0\\times 10^{-1}$ (meter), $E_0=1.0$ (volt per meter), $N_x=300$, $N_y=60$.\n- Case $2$: $f=5.0\\times 10^{9}$ (hertz), $\\varepsilon_r=2.5$, $\\sigma=0.0$ (siemens per meter), $L_x=2.5\\times 10^{-1}$ (meter), $L_y=1.0\\times 10^{-1}$ (meter), $E_0=2.0$ (volt per meter), $N_x=240$, $N_y=40$.\n- Case $3$: $f=1.0\\times 10^{9}$ (hertz), $\\varepsilon_r=4.0$, $\\sigma=5.0$ (siemens per meter), $L_x=5.0\\times 10^{-2}$ (meter), $L_y=5.0\\times 10^{-2}$ (meter), $E_0=1.0$ (volt per meter), $N_x=200$, $N_y=40$.\n\nYour program should produce a single line of output containing the residuals for the three cases as a comma-separated list enclosed in square brackets, for example, $[r_1,r_2,r_3]$, where each $r_k$ is a floating-point number representing $R$ in watts for the $k$-th test case. The numerical method must follow the construction above and use only the given analytic fields and midpoint quadrature.",
            "solution": "We begin from the frequency-domain Maxwell curl equations for time-harmonic fields with the $e^{+j\\omega t}$ convention:\n$$\\nabla\\times \\mathbf{E} = -j\\omega \\mu \\mathbf{H}, \\quad \\nabla\\times \\mathbf{H} = (\\sigma + j\\omega \\varepsilon)\\mathbf{E}.$$\nThe complex Poynting vector is $\\mathbf{S}_c = \\tfrac{1}{2}\\mathbf{E}\\times \\mathbf{H}^*$, and the time-average real power flux density is $\\langle \\mathbf{S} \\rangle = \\operatorname{Re}\\{\\mathbf{S}_c\\} = \\tfrac{1}{2}\\operatorname{Re}\\{\\mathbf{E}\\times \\mathbf{H}^*\\}$. From these and the vector identity $\\nabla\\cdot(\\mathbf{E}\\times \\mathbf{H}^*) = \\mathbf{H}^*\\cdot (\\nabla\\times \\mathbf{E}) - \\mathbf{E}\\cdot (\\nabla\\times \\mathbf{H}^*)$, we obtain the frequency-domain Poynting theorem:\n$$\\nabla \\cdot \\langle \\mathbf{S} \\rangle = -\\tfrac{1}{2}\\sigma |\\mathbf{E}|^2,$$\nafter taking the real part and using the constitutive relations for linear, time-invariant media; the reactive terms vanish upon time averaging for steady-state fields. Integrating over a domain $\\Omega$ and applying the divergence theorem yields\n$$\\int_{\\partial \\Omega} \\langle \\mathbf{S} \\rangle \\cdot \\hat{n}\\, dA = - \\int_{\\Omega} \\tfrac{1}{2}\\sigma |\\mathbf{E}|^2\\, dV.$$\nIn a driven finite element formulation with a prescribed port at a portion of the boundary $\\Gamma_{\\text{port}}\\subset \\partial \\Omega$, one typically treats the power injection from the port as an external input $P_{\\text{port}}$, and computes the outward flux only over the remaining boundary $\\partial \\Omega \\setminus \\Gamma_{\\text{port}}$. The balance then reads\n$$\\int_{\\partial \\Omega \\setminus \\Gamma_{\\text{port}}} \\langle \\mathbf{S} \\rangle \\cdot \\hat{n}\\, dA = P_{\\text{port}} - \\int_{\\Omega} \\tfrac{1}{2}\\sigma |\\mathbf{E}|^2\\, dV.$$\nThis is the statement to be verified numerically using a discrete construction.\n\nWe choose a two-dimensional transverse electric to the axis setting with $\\mathbf{E} = \\hat{z} E_z(x,y)$, $\\mathbf{H} = \\hat{x} H_x(x,y) + \\hat{y} H_y(x,y)$. For a homogeneous isotropic medium and a uniform plane wave propagating in $+x$ with attenuation,\n$$\\gamma = \\sqrt{j\\omega \\mu (\\sigma + j\\omega \\varepsilon)}, \\quad \\eta_c = \\sqrt{\\frac{j\\omega \\mu}{\\sigma + j\\omega \\varepsilon}},$$\n$$E_z(x,y) = E_0 e^{-\\gamma x}, \\quad H_x(x,y)=0, \\quad H_y(x,y) = -\\frac{E_z(x,y)}{\\eta_c}.$$\nThe time-average Poynting vector is\n$$\\langle \\mathbf{S} \\rangle = \\tfrac{1}{2}\\operatorname{Re}\\{\\mathbf{E}\\times \\mathbf{H}^*\\} = \\tfrac{1}{2}\\operatorname{Re}\\{ E_z \\hat{z} \\times (H_x^* \\hat{x} + H_y^* \\hat{y})\\} = \\tfrac{1}{2}\\operatorname{Re}\\{-E_z H_y^* \\hat{x} + E_z H_x^* \\hat{y}\\}.$$\nWith $H_x=0$, the only nonzero component is\n$$\\langle S_x \\rangle = -\\tfrac{1}{2}\\operatorname{Re}\\{E_z H_y^*\\} = \\tfrac{1}{2}\\operatorname{Re}\\left\\{\\frac{|E_z|^2}{\\eta_c^*}\\right\\}, \\quad \\langle S_y \\rangle = 0.$$\nThus, on the boundary $x=L_x$, the outward normal is $+\\hat{x}$ and the outward power flux density equals $\\langle S_x(L_x)\\rangle$. On the driven port boundary at $x=0$, with outward normal $-\\hat{x}$, the incoming port power is\n$$P_{\\text{port}} = -\\int_{\\Gamma_{\\text{port}}} \\langle \\mathbf{S} \\rangle \\cdot \\hat{n}\\, dA = \\int_{0}^{L_y} \\langle S_x(0)\\rangle \\, dy.$$\nThe volumetric Ohmic loss density is $\\tfrac{1}{2}\\sigma |E_z|^2$, hence\n$$\\int_{\\Omega} \\tfrac{1}{2}\\sigma |E_z|^2\\, dV = \\int_{0}^{L_y}\\int_{0}^{L_x} \\tfrac{1}{2}\\sigma |E_0|^2 e^{-2\\operatorname{Re}(\\gamma) x}\\, dx\\, dy.$$\nAnalytically, one can verify that\n$$\\int_{x=L_x} \\langle \\mathbf{S} \\rangle \\cdot \\hat{n}\\, dA = \\int_{0}^{L_y} \\langle S_x(L_x)\\rangle \\, dy = \\int_{0}^{L_y} \\tfrac{1}{2}\\operatorname{Re}\\left\\{\\frac{|E_0|^2 e^{-2\\operatorname{Re}(\\gamma) L_x}}{\\eta_c^*}\\right\\}\\, dy,$$\nand that the balance\n$$\\int_{x=L_x} \\langle \\mathbf{S} \\rangle \\cdot \\hat{n}\\, dA = P_{\\text{port}} - \\int_{\\Omega} \\tfrac{1}{2}\\sigma |E_z|^2\\, dV$$\nholds exactly for continuous fields in the absence of reflections. The numerical task is to emulate a discrete finite element calculation by constructing midpoint quadrature approximations of these integrals, using the given analytic fields to evaluate the integrands at the required midpoints.\n\nDiscrete construction:\n- Partition the domain into $N_x\\times N_y$ uniform cells with $\\Delta x = L_x/N_x$, $\\Delta y = L_y/N_y$, and define cell centers at $x_i = (i+\\tfrac{1}{2})\\Delta x$, $y_j = (j+\\tfrac{1}{2})\\Delta y$ for $i \\in \\{0,\\dots,N_x-1\\}$, $j \\in \\{0,\\dots,N_y-1\\}$.\n- For boundary integrals on vertical sides, the edge midpoints are at $x=0$ or $x=L_x$, $y_{j+\\tfrac{1}{2}}=(j+\\tfrac{1}{2})\\Delta y$, $j \\in \\{0,\\dots,N_y-1\\}$. At each midpoint, compute $E_z$ and $H_y$ from the analytic expressions and then compute $\\langle S_x\\rangle = -\\tfrac{1}{2}\\operatorname{Re}\\{E_z H_y^*\\}$. The discrete outward flux over $x=L_x$ is the sum over $j$ of $\\langle S_x(L_x,y_{j+\\tfrac{1}{2}})\\rangle \\Delta y$. The port power is the sum over $j$ of $\\langle S_x(0,y_{j+\\tfrac{1}{2}})\\rangle \\Delta y$.\n- For the volumetric loss, at each cell center $(x_i,y_j)$, evaluate $\\tfrac{1}{2}\\sigma |E_z(x_i,y_j)|^2$ and sum over all cells multiplied by the cell area $\\Delta x \\Delta y$.\n\nDefine the residual\n$$R = \\left(\\sum_{j=0}^{N_y-1} \\langle S_x(L_x,y_{j+\\tfrac{1}{2}})\\rangle \\Delta y\\right) - \\left(\\sum_{j=0}^{N_y-1} \\langle S_x(0,y_{j+\\tfrac{1}{2}})\\rangle \\Delta y - \\sum_{i=0}^{N_x-1}\\sum_{j=0}^{N_y-1} \\tfrac{1}{2}\\sigma |E_z(x_i,y_j)|^2 \\Delta x \\Delta y\\right).$$\nBecause the fields are uniform in $y$, the midpoint quadrature is exact in $y$ and reduces the sums to factors of $L_y$. The $x$-integral is approximated by the midpoint rule, which is second-order accurate for smooth integrands such as $|E_z|^2$. Therefore, as the mesh is refined, the discrete residual $R$ converges to $0$ with $\\mathcal{O}(\\Delta x^2)$, and in practice is dominated by floating-point rounding and the quadrature error.\n\nFor the specified test suite:\n- Case $1$ has nonzero $\\sigma$ and moderate attenuation; the outgoing flux is less than the incoming port power, with the difference equal to the Ohmic loss, up to quadrature error, hence $R\\approx 0$.\n- Case $2$ is lossless with $\\sigma=0$, so the volumetric loss vanishes and the outgoing flux equals the port power, hence $R\\approx 0$.\n- Case $3$ is highly lossy with a short domain; the outgoing flux is much smaller than the port power and almost all input power is dissipated; nonetheless, the balance should hold within quadrature error and yield $R\\approx 0$.\n\nThe program implements these steps, computes $R$ in watts for each case, and prints a single line in the form $[r_1,r_2,r_3]$.",
            "answer": "```python\nimport numpy as np\n\n# Physical constants (SI)\nmu0 = 4.0e-7 * np.pi\neps0 = 8.854187817e-12\n\ndef propagation_constant(mu, eps, sigma, omega):\n    # gamma = sqrt(j*omega*mu*(sigma + j*omega*eps))\n    return np.sqrt(1j * omega * mu * (sigma + 1j * omega * eps))\n\ndef intrinsic_impedance(mu, eps, sigma, omega):\n    # eta_c = sqrt((j*omega*mu)/(sigma + j*omega*eps))\n    return np.sqrt((1j * omega * mu) / (sigma + 1j * omega * eps))\n\ndef discrete_power_balance_residual(f, eps_r, sigma, Lx, Ly, E0, Nx, Ny):\n    # Material parameters\n    mu = mu0\n    eps = eps0 * eps_r\n    omega = 2.0 * np.pi * f\n\n    # Wave parameters\n    gamma = propagation_constant(mu, eps, sigma, omega)\n    eta_c = intrinsic_impedance(mu, eps, sigma, omega)\n\n    # Grid spacing\n    dx = Lx / Nx\n    dy = Ly / Ny\n\n    # Helper to compute E_z at a given x\n    def Ez(x):\n        return E0 * np.exp(-gamma * x)\n\n    # Poynting Sx via E and H relation: H_y = -E/eta_c, Sx = -(1/2) Re(E * conj(H_y))\n    def Sx_from_E(E):\n        # Using Sx = 0.5 * Re(|E|^2 / conj(eta_c))\n        return 0.5 * np.real((np.abs(E) ** 2) / np.conj(eta_c))\n\n    # Boundary flux at x = Lx (non-port boundary), outward normal +x\n    E_L = Ez(Lx)\n    Sx_L = Sx_from_E(E_L)\n    # Midpoint quadrature along y is exact here (uniform in y)\n    boundary_flux_nonport = Sx_L * Ly\n\n    # Port power at x = 0 (incoming power)\n    E_0 = Ez(0.0)\n    Sx_0 = Sx_from_E(E_0)\n    P_port = Sx_0 * Ly\n\n    # Volumetric loss integral using midpoint rule over x (uniform in y)\n    # Loss density q(x) = 0.5 * sigma * |E(x)|^2\n    # Midpoints in x\n    x_mid = (np.arange(Nx) + 0.5) * dx\n    E_mid = Ez(x_mid)\n    q_mid = 0.5 * sigma * (np.abs(E_mid) ** 2)  # W/m^3\n    # Integrate over volume: sum q_mid * dx * Ly\n    loss = np.sum(q_mid) * dx * Ly\n\n    # Residual R = boundary_flux_nonport - (P_port - loss)\n    R = boundary_flux_nonport - (P_port - loss)\n    # Return as a float\n    return float(np.real(R))\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each tuple: (f, eps_r, sigma, Lx, Ly, E0, Nx, Ny)\n    test_cases = [\n        (3.0e9, 1.0, 2.0e-2, 5.0e-1, 3.0e-1, 1.0, 300, 60),   # Case 1\n        (5.0e9, 2.5, 0.0,     2.5e-1, 1.0e-1, 2.0, 240, 40),   # Case 2\n        (1.0e9, 4.0, 5.0,     5.0e-2, 5.0e-2, 1.0, 200, 40),   # Case 3\n    ]\n\n    results = []\n    for case in test_cases:\n        f, eps_r, sigma, Lx, Ly, E0, Nx, Ny = case\n        R = discrete_power_balance_residual(f, eps_r, sigma, Lx, Ly, E0, Nx, Ny)\n        results.append(R)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```"
        },
        {
            "introduction": "Beyond initial verification, the principles of energy conservation serve as powerful diagnostics for assessing the stability and physical realism of a complex simulation. A numerical model of a passive system that spuriously generates energy is non-physical, and its results are unreliable. This practice challenges you to formalize the power balance check into such a diagnostic by creating a normalized energy balance residual, $r$, which quantifies any deviation from the conservation law. By testing this diagnostic against both physically correct scenarios and one with a simulated numerical error , you will learn to build robust, automated checks to detect instabilities or non-passive behavior in advanced electromagnetic solvers.",
            "id": "3342626",
            "problem": "You are to design and implement a programmatic diagnostic to detect non-physical (spurious) energy growth in time-domain simulations of passive, homogeneous, isotropic media by post-processing frequency-domain equivalents. The diagnostic must be based on integrating the real part of the complex Poynting vector over the computational boundary and comparing this boundary power balance against volumetric dissipation, as mandated by Poynting’s theorem, for a single-tone steady-state. Your task is to derive, implement, and evaluate a normalized residual that quantifies violation of energy conservation, using only boundary fluxes and material loss. The goal is a scalar indicator where values close to zero indicate consistency with passivity and values significantly away from zero indicate possible spurious growth or numerical imbalance.\n\nStarting point and physical setting:\n\n- Begin strictly from the macroscopic Maxwell curl equations in a passive, homogeneous, isotropic medium with conductivity $\\sigma$, permittivity $\\varepsilon$, and permeability $\\mu$, along with the standard definitions of electromagnetic energy density and the Poynting vector. Use the time-harmonic (phasor) representation to define the complex Poynting vector and its time-averaged real power flow interpretation.\n\n- Consider a rectangular three-dimensional domain $V$ of dimensions $L_x \\times L_y \\times L_z$ filled with a uniform medium. An incoming, normally incident, linearly polarized, one-dimensional plane wave at angular frequency $\\omega = 2\\pi f$ propagates in the $+x$ direction with electric field amplitude $E_0$ (uniform in $y$ and $z$). The total fields are those of the uniform plane wave in a homogeneous lossy medium. There are no internal reactive elements beyond the medium itself, and no magnetic conduction.\n\n- The input is implemented as an incident wave specified on the input boundary at $x=0$, so the net time-averaged source power equals the net inward real power flux through the input boundary, and all other power exchanges are via the remaining boundaries and ohmic dissipation inside $V$.\n\nDiagnostic to implement:\n\n- Use the complex propagation constant $\\gamma$ and the intrinsic impedance $\\eta$ of the medium at frequency $f$ to model the steady-state fields of a normally incident plane wave that decays along $x$ in a lossy medium. Assume the principal square-root branch and enforce the physically admissible sign such that the attenuation constant $\\alpha = \\operatorname{Re}\\{\\gamma\\}$ is non-negative and the real part of the admittance $\\operatorname{Re}\\{1/\\eta\\}$ is non-negative.\n\n- Define the real, time-averaged, net input power $P_{\\mathrm{in}}$ as the inward real power flux through the input boundary at $x=0$. Define the real, time-averaged, net outward power through the remaining boundaries $P_{\\mathrm{out}}$ (in this one-dimensional setting, only the boundary at $x=L_x$ contributes). Define the real, time-averaged, volumetric ohmic dissipation power $P_{\\mathrm{diss}}$ over the volume $V$.\n\n- Derive from first principles an energy-balance residual $R = P_{\\mathrm{in}} - (P_{\\mathrm{out}} + P_{\\mathrm{diss}})$ and implement the normalized diagnostic \n$$\nr = \\frac{R}{P_{\\mathrm{in}}}.\n$$\nIn a physically correct, passive, steady-state setting, $r$ should be as close to $0$ as numerical accuracy permits. Significant deviations of $r$ from $0$ indicate violation of passivity or numerical imbalance. You must compute $P_{\\mathrm{in}}$, $P_{\\mathrm{out}}$, and $P_{\\mathrm{diss}}$ using only the boundary real power fluxes and the volumetric ohmic loss implied by the medium properties.\n\nNumerical modeling assumptions you must explicitly use:\n\n- The medium is homogeneous with parameters $\\mu = \\mu_0$, $\\varepsilon = \\varepsilon_r \\varepsilon_0$, and $\\sigma$, where $\\mu_0$ and $\\varepsilon_0$ are the permeability and permittivity of free space.\n\n- The complex propagation constant and intrinsic impedance satisfy\n$$\n\\gamma = \\sqrt{j \\omega \\mu \\left(\\sigma + j \\omega \\varepsilon\\right)}, \n\\quad \n\\eta = \\sqrt{\\frac{j \\omega \\mu}{\\sigma + j \\omega \\varepsilon}},\n$$\nwith the physically admissible branch choice as described above.\n\n- For a $+x$ propagating uniform plane wave with electric field amplitude $E_0$ and phasor fields uniform in $y$ and $z$, the real part of the complex Poynting vector on a plane $x=\\text{const}$ has only an $x$-component and decays as the square of the field magnitude along $x$. Use this structure to compute boundary fluxes on $x=0$ and $x=L_x$.\n\n- The volumetric, time-averaged ohmic dissipation is computed from the standard phasor-domain loss density integrated over the volume.\n\nTest suite:\n\nImplement your program to compute $r$ for the following four cases. In each case, all quantities are in SI units, and $r$ is dimensionless.\n\n- Case A (nominal lossy medium):\n  - $E_0 = 1.0$, $f = 1.0 \\times 10^9$, $\\varepsilon_r = 4.0$, $\\sigma = 2.0 \\times 10^{-2}$, $L_x = 0.5$, $L_y = 0.4$, $L_z = 1.0$.\n  - Use the physically correct boundary fluxes (no artificial scaling).\n\n- Case B (nearly lossless medium):\n  - $E_0 = 1.2$, $f = 2.0 \\times 10^9$, $\\varepsilon_r = 2.5$, $\\sigma = 1.0 \\times 10^{-6}$, $L_x = 1.0$, $L_y = 0.3$, $L_z = 1.0$.\n  - Use the physically correct boundary fluxes (no artificial scaling).\n\n- Case C (highly lossy medium):\n  - $E_0 = 0.8$, $f = 1.0 \\times 10^8$, $\\varepsilon_r = 4.0$, $\\sigma = 5.0 \\times 10^{-1}$, $L_x = 0.2$, $L_y = 0.5$, $L_z = 1.0$.\n  - Use the physically correct boundary fluxes (no artificial scaling).\n\n- Case D (simulated diagnostic failure due to boundary underestimation):\n  - Same as Case A, but when computing the outward flux at $x=L_x$ only, artificially scale the boundary flux by a factor $s = 0.9$ to simulate a systematic underestimation of the magnetic field at the output boundary (mimicking numerical dispersion or boundary truncation error). All other quantities are computed as in the physically correct model.\n\nRequired outputs and units:\n\n- Compute the diagnostic residual $r$ for each case as a floating-point number (unitless). Your program should produce a single line of output containing the four results as a comma-separated list enclosed in square brackets, in the order [Case A, Case B, Case C, Case D], for example: \"[rA,rB,rC,rD]\".\n\n- All intermediate physical quantities internally used in your program (powers) must be consistent with watts, but only the final $r$ values must be printed, unitless.\n\nAngle units are not involved.\n\nConstraints and coverage:\n\n- Your implementation must be robust in the low-loss limit $\\alpha \\to 0$, where $\\alpha = \\operatorname{Re}\\{\\gamma\\}$. In this limit, treat the integral of the squared field magnitude along $x$ consistently by taking the appropriate limit.\n\n- The chosen test suite exercises typical regimes: nominal loss, near-lossless, highly lossy, and an injected boundary underestimation to test the sensitivity of the diagnostic.\n\n- Your program must be self-contained and must not read input.\n\nYour derivation must start from the macroscopic Maxwell curl equations and standard definitions of electromagnetic power and energy density, and must justify why the proposed residual $r$ is a sensitive detector of spurious non-passive behavior, as well as discuss its limitations in nearly lossless regimes and under imperfect boundary characterization. Do not use any unexplained shortcut formulae in your derivation; every step must be grounded in the fundamental laws and standard definitions. Clearly state all assumptions you make. The final numerical answers must be the four floating-point residuals $r$ for the four cases, printed as a single list on one line as specified above.",
            "solution": "The problem requires the derivation and implementation of a numerical diagnostic based on Poynting's theorem to verify energy conservation in time-domain simulations of passive media. The diagnostic is a normalized residual, $r$, derived from the balance of power fluxes and volumetric dissipation for a single-frequency, steady-state plane wave in a homogeneous, isotropic, and lossy medium.\n\nThe derivation begins with the macroscopic Maxwell curl equations in a source-free region:\n$$\n\\nabla \\times \\mathbf{E}(\\mathbf{r}, t) = -\\frac{\\partial \\mathbf{B}(\\mathbf{r}, t)}{\\partial t}\n$$\n$$\n\\nabla \\times \\mathbf{H}(\\mathbf{r}, t) = \\mathbf{J}(\\mathbf{r}, t) + \\frac{\\partial \\mathbf{D}(\\mathbf{r}, t)}{\\partial t}\n$$\nFor a time-harmonic steady state with angular frequency $\\omega$, the fields can be represented in phasor form, e.g., $\\mathbf{E}(\\mathbf{r}, t) = \\operatorname{Re}\\{\\vec{E}(\\mathbf{r}) e^{j\\omega t}\\}$. The Maxwell equations become:\n$$\n\\nabla \\times \\vec{E} = -j\\omega \\vec{B}\n$$\n$$\n\\nabla \\times \\vec{H} = \\vec{J} + j\\omega \\vec{D}\n$$\nThe medium is linear, homogeneous, and isotropic, with constitutive relations $\\vec{D} = \\varepsilon \\vec{E}$, $\\vec{B} = \\mu \\vec{H}$, and Ohm's law for conductivity $\\vec{J} = \\sigma \\vec{E}$. Substituting these yields:\n$$\n\\nabla \\times \\vec{E} = -j\\omega \\mu \\vec{H}\n$$\n$$\n\\nabla \\times \\vec{H} = (\\sigma + j\\omega \\varepsilon) \\vec{E}\n$$\nTo derive the power balance, we follow the standard procedure for Poynting's theorem. We take the dot product of the first equation with the complex conjugate of the magnetic field, $\\vec{H}^*$, and subtract the dot product of the complex conjugate of the second equation with the electric field, $\\vec{E}$:\n$$\n\\vec{H}^* \\cdot (\\nabla \\times \\vec{E}) - \\vec{E} \\cdot (\\nabla \\times \\vec{H}^*) = -j\\omega \\mu \\vec{H} \\cdot \\vec{H}^* - \\vec{E} \\cdot ((\\sigma - j\\omega \\varepsilon) \\vec{E}^*)\n$$\nUsing the vector identity $\\nabla \\cdot (\\vec{A} \\times \\vec{B}) = \\vec{B} \\cdot (\\nabla \\times \\vec{A}) - \\vec{A} \\cdot (\\nabla \\times \\vec{B})$, we can identify the left side as $\\nabla \\cdot (\\vec{E} \\times \\vec{H}^*)$. The equation becomes:\n$$\n\\nabla \\cdot (\\vec{E} \\times \\vec{H}^*) = -j\\omega \\mu |\\vec{H}|^2 - \\sigma |\\vec{E}|^2 + j\\omega \\varepsilon |\\vec{E}|^2\n$$\nLet us define the complex Poynting vector as $\\vec{S}_c = \\vec{E} \\times \\vec{H}^*$. Rearranging the terms, we get the differential form of the complex Poynting theorem:\n$$\n-\\nabla \\cdot \\vec{S}_c = \\sigma |\\vec{E}|^2 + j\\omega (\\mu |\\vec{H}|^2 - \\varepsilon |\\vec{E}|^2)\n$$\nIntegrating this equation over a finite volume $V$ enclosed by a surface $S$ and applying the divergence theorem gives the integral form:\n$$\n-\\oint_S \\vec{S}_c \\cdot d\\mathbf{S} = \\int_V \\sigma |\\vec{E}|^2 dV + j\\omega \\int_V (\\mu |\\vec{H}|^2 - \\varepsilon |\\vec{E}|^2) dV\n$$\nThe physical interpretation comes from taking the real part of this equation. The time-averaged power flux density is given by $\\langle \\mathbf{S} \\rangle = \\frac{1}{2}\\operatorname{Re}\\{\\vec{S}_c\\}$, the time-averaged power dissipated per unit volume (ohmic loss) is $p_d = \\frac{1}{2}\\sigma |\\vec{E}|^2$, and the terms $\\frac{1}{4}\\mu|\\vec{H}|^2$ and $\\frac{1}{4}\\varepsilon|\\vec{E}|^2$ represent the time-averaged stored magnetic and electric energy densities, respectively. Taking $\\frac{1}{2}$ of the real part of the integral equation yields:\n$$\n-\\oint_S \\frac{1}{2}\\operatorname{Re}\\{\\vec{S}_c\\} \\cdot d\\mathbf{S} = \\int_V \\frac{1}{2}\\sigma |\\vec{E}|^2 dV\n$$\nThis equation is a statement of the conservation of energy in the steady state: the net time-averaged power flowing into the volume $V$ (left-hand side) is exactly equal to the total time-averaged power dissipated as heat within the volume (right-hand side).\n\nLet us define the quantities for our specific problem:\n1. $P_{\\mathrm{in}}$: Time-averaged power flowing into $V$ through the input boundary at $x=0$.\n2. $P_{\\mathrm{out}}$: Time-averaged power flowing out of $V$ through all other boundaries.\n3. $P_{\\mathrm{diss}}$: Total time-averaged power dissipated within $V$.\n\nThe power balance equation can therefore be written as $P_{\\mathrm{in}} - P_{\\mathrm{out}} = P_{\\mathrm{diss}}$, or $P_{\\mathrm{in}} = P_{\\mathrm{out}} + P_{\\mathrm{diss}}$. The diagnostic residual is defined as $R = P_{\\mathrm{in}} - (P_{\\mathrm{out}} + P_{\\mathrm{diss}})$. For a physically correct passive system, $R$ must be identically zero. The normalized residual $r = R / P_{\\mathrm{in}}$ provides a dimensionless metric where $r=0$ signifies perfect energy balance.\n\nNext, we apply this to the specified one-dimensional plane wave propagating in the $+x$ direction in a domain of size $L_x \\times L_y \\times L_z$. The electric field is linearly polarized (say, along $\\hat{y}$) with amplitude $E_0$ at the input face $x=0$. The phasor fields are:\n$$\n\\vec{E}(x) = \\hat{y} E_0 e^{-\\gamma x}\n$$\n$$\n\\vec{H}(x) = \\hat{z} \\frac{E_0}{\\eta} e^{-\\gamma x}\n$$\nHere, $\\gamma = \\sqrt{j\\omega\\mu(\\sigma + j\\omega\\varepsilon)}$ is the complex propagation constant, and $\\eta = \\sqrt{j\\omega\\mu / (\\sigma + j\\omega\\varepsilon)}$ is the complex intrinsic impedance. We write $\\gamma = \\alpha + j\\beta$, where $\\alpha = \\operatorname{Re}\\{\\gamma\\}$ is the attenuation constant and must be non-negative for a passive medium.\n\nThe time-averaged Poynting vector is:\n$$\n\\langle \\mathbf{S}(x) \\rangle = \\frac{1}{2}\\operatorname{Re}\\{\\vec{E}(x) \\times \\vec{H}^*(x)\\} = \\frac{1}{2}\\operatorname{Re}\\{(\\hat{y} E_0 e^{-\\gamma x}) \\times (\\hat{z} \\frac{E_0}{\\eta^*} e^{-\\gamma^* x})\\}\n$$\n$$\n\\langle \\mathbf{S}(x) \\rangle = \\hat{x} \\frac{E_0^2}{2} e^{-(\\gamma+\\gamma^*)x} \\operatorname{Re}\\{\\frac{1}{\\eta^*}\\} = \\hat{x} \\frac{E_0^2}{2} e^{-2\\alpha x} \\operatorname{Re}\\{\\frac{1}{\\eta}\\}\n$$\nThe power flow is only in the $x$-direction, so only the boundaries at $x=0$ and $x=L_x$ contribute to the power balance.\nThe net inward power flux through the input boundary at $x=0$ (area $A = L_y L_z$) is:\n$$\nP_{\\mathrm{in}} = |\\langle \\mathbf{S}(0) \\rangle| A = \\frac{A E_0^2}{2} \\operatorname{Re}\\{\\frac{1}{\\eta}\\}\n$$\nThe net outward power flux through the output boundary at $x=L_x$ is:\n$$\nP_{\\mathrm{out}} = |\\langle \\mathbf{S}(L_x) \\rangle| A = \\left(\\frac{A E_0^2}{2} \\operatorname{Re}\\{\\frac{1}{\\eta}\\}\\right) e^{-2\\alpha L_x} = P_{\\mathrm{in}} e^{-2\\alpha L_x}\n$$\nThe total volumetric power dissipation is the integral of the loss density $p_d(x) = \\frac{1}{2}\\sigma |\\vec{E}(x)|^2$:\n$$\nP_{\\mathrm{diss}} = \\int_V p_d dV = \\int_0^{L_x} \\int_0^{L_y} \\int_0^{L_z} \\frac{1}{2}\\sigma |E_0 e^{-\\gamma x}|^2 dz dy dx\n$$\n$$\nP_{\\mathrm{diss}} = \\frac{A \\sigma E_0^2}{2} \\int_0^{L_x} e^{-2\\alpha x} dx = \\frac{A \\sigma E_0^2}{2} \\left[\\frac{e^{-2\\alpha x}}{-2\\alpha}\\right]_0^{L_x} = \\frac{A \\sigma E_0^2}{4\\alpha} (1 - e^{-2\\alpha L_x})\n$$\nThis formula for $P_{\\mathrm{diss}}$ becomes indeterminate ($0/0$) when $\\alpha \\to 0$. In this limit, the integral $\\int_0^{L_x} e^{-2\\alpha x}dx \\to L_x$, so $P_{\\mathrm{diss}} \\to \\frac{1}{2}A \\sigma E_0^2 L_x$. For numerical implementation, it is robust to compute the integral as $-\\text{expm1}(-2\\alpha L_x)/(2\\alpha)$, which has a stable limit.\n\nFor Cases A, B, and C, we compute $r = (P_{\\mathrm{in}} - (P_{\\mathrm{out}} + P_{\\mathrm{diss}})) / P_{\\mathrm{in}}$. Analytically, it can be shown that $\\operatorname{Re}\\{1/\\eta\\} = \\sigma/(2\\alpha)$, which implies $P_{\\mathrm{out}} + P_{\\mathrm{diss}} = P_{\\mathrm{in}}$, so $R=0$ and $r=0$. The numerical calculation will yield a value very close to zero, limited by floating-point precision.\n\nFor Case D, we simulate a numerical error by scaling the true outward flux by a factor $s=0.9$. The computed outward power is $P'_{\\mathrm{out}} = s \\cdot P_{\\mathrm{out}}$. The residual becomes:\n$$\nR_D = P_{\\mathrm{in}} - (s \\cdot P_{\\mathrm{out}} + P_{\\mathrm{diss}}) = P_{\\mathrm{in}} - (s \\cdot P_{\\mathrm{in}}e^{-2\\alpha L_x} + P_{\\mathrm{in}}(1-e^{-2\\alpha L_x}))\n$$\n$$\nR_D = P_{\\mathrm{in}} - P_{\\mathrm{in}}(s \\cdot e^{-2\\alpha L_x} + 1 - e^{-2\\alpha L_x}) = P_{\\mathrm{in}}(1 - s)e^{-2\\alpha L_x} = 0.1 \\cdot P_{\\mathrm{in}} e^{-2\\alpha L_x}\n$$\nThe normalized residual is therefore $r_D = R_D/P_{\\mathrm{in}} = 0.1 \\cdot e^{-2\\alpha L_x}$. This demonstrates that the diagnostic $r$ is a sensitive indicator of boundary flux imbalances.\n\nThe diagnostic's main limitation occurs in nearly lossless media, where $\\sigma \\to 0$. In this regime, $P_{\\mathrm{in}}$, $P_{\\mathrm{out}}$, and $P_{\\mathrm{diss}}$ all approach zero. Normalizing by $P_{\\mathrm{in}}$ can amplify small floating-point errors, potentially leading to a noisy or misleading value for $r$. However, the absolute residual $R$ should still approach zero. Imperfect characterization of boundaries in a numerical simulation (e.g., due to numerical dispersion or inaccurate boundary conditions) will lead to computed flux values that do not match the physical reality, causing $r$ to deviate from zero, as explicitly demonstrated in Case D. This makes $r$ a valuable tool for verification and validation of electromagnetic simulation codes.",
            "answer": "```python\nimport numpy as np\nfrom scipy import constants\n\ndef solve():\n    \"\"\"\n    Solves for the energy balance residual for four test cases of a plane wave\n    propagating in a lossy medium.\n    \"\"\"\n\n    # Define physical constants\n    MU_0 = constants.mu_0\n    EPSILON_0 = constants.epsilon_0\n\n    # Define test cases as specified in the problem statement\n    # Each tuple is (E0, f, eps_r, sigma, Lx, Ly, Lz, name, optional_scale)\n    test_cases = [\n        (1.0, 1.0e9, 4.0, 2.0e-2, 0.5, 0.4, 1.0, 'A', 1.0),\n        (1.2, 2.0e9, 2.5, 1.0e-6, 1.0, 0.3, 1.0, 'B', 1.0),\n        (0.8, 1.0e8, 4.0, 5.0e-1, 0.2, 0.5, 1.0, 'C', 1.0),\n        (1.0, 1.0e9, 4.0, 2.0e-2, 0.5, 0.4, 1.0, 'D', 0.9) # Case D is Case A with s=0.9\n    ]\n\n    results = []\n\n    for case in test_cases:\n        E0, f, eps_r, sigma, Lx, Ly, Lz, name, s = case\n\n        # Step 1: Calculate medium and wave parameters\n        omega = 2.0 * np.pi * f\n        mu = MU_0\n        eps_complex = eps_r * EPSILON_0 - 1j * (sigma / omega) # Using complex permittivity\n        \n        # In the provided formulas, we have (sigma + j*omega*epsilon).\n        # We can also write this as j*omega * (epsilon - j*sigma/omega) = j*omega*eps_complex\n        \n        # Calculate complex propagation constant gamma\n        # gamma = sqrt(j*omega*mu * (sigma + j*omega*eps_r*EPSILON_0))\n        # The principal square root from np.sqrt ensures Re{gamma} = 0\n        gamma = np.sqrt(1j * omega * mu * (sigma + 1j * omega * eps_r * EPSILON_0))\n        alpha = gamma.real\n        \n        # Calculate complex intrinsic impedance eta\n        # eta = sqrt( (j*omega*mu) / (sigma + j*omega*eps_r*EPSILON_0) )\n        # The principal square root ensures Re{eta} = 0, which implies Re{1/eta} = 0\n        eta = np.sqrt((1j * omega * mu) / (sigma + 1j * omega * eps_r * EPSILON_0))\n\n        # Step 2: Calculate power terms based on derived formulas\n        area = Ly * Lz\n        \n        # Calculate inward power at x=0\n        # P_in = (Area * E0^2 / 2) * Re(1/eta)\n        P_in = (area * E0**2 / 2.0) * np.real(1.0 / eta)\n        \n        # Calculate outward power at x=Lx\n        # P_out = P_in * exp(-2*alpha*Lx)\n        # For Case D, this is scaled by s\n        P_out = P_in * np.exp(-2.0 * alpha * Lx)\n        if name == 'D':\n            P_out *= s\n            \n        # Calculate total dissipated power in the volume V\n        # P_diss = (Area * sigma * E0^2 / 2) * Integral_0^Lx(exp(-2*alpha*x) dx)\n        # The integral is (1 - exp(-2*alpha*Lx)) / (2*alpha)\n        # To handle the alpha - 0 case robustly, we use a conditional expression.\n        if np.isclose(alpha, 0.0):\n            integral_val = Lx\n        else:\n            # Use of np.expm1 is more numerically stable than 1 - np.exp for small arguments\n            integral_val = -np.expm1(-2.0 * alpha * Lx) / (2.0 * alpha)\n\n        P_diss = (area * sigma * E0**2 / 2.0) * integral_val\n\n        # Step 3: Calculate the normalized residual r\n        # r = (P_in - (P_out + P_diss)) / P_in\n        # Handle the case where P_in might be zero (lossless medium)\n        if np.isclose(P_in, 0.0):\n            # If P_in is zero, R should also be zero in the ideal case. r is ill-defined.\n            # For this problem, sigma  0, so P_in  0.\n            # If R is also zero, r is 0. If R is non-zero, r would be inf.\n            residual_R = P_in - (P_out + P_diss)\n            if np.isclose(residual_R, 0.0):\n                r = 0.0\n            else:\n                r = np.inf # Signifies an issue\n        else:\n            r = (P_in - (P_out + P_diss)) / P_in\n        \n        results.append(r)\n\n    # Print results in the specified format\n    print(f\"[{','.join(f'{res:.6e}' for res in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "A primary goal in antenna analysis is calculating the far-field radiation pattern and total radiated power, but directly simulating the vast far-field region is often computationally prohibitive. This necessitates techniques that extrapolate far-field characteristics from near-field results. This advanced practice guides you through implementing a numerical near-to-far-field (NTFF) transformation based on the electromagnetic equivalence principle, using simulated field data on a closed \"Huygens\" surface to compute the power radiated into the far zone. The exercise culminates in a critical validation step: verifying that the total power radiated to the far field equals the total power flowing through the near-field surface , demonstrating the power and self-consistency of an indispensable tool in modern antenna engineering.",
            "id": "3342672",
            "problem": "You are given a time-harmonic electromagnetic source in vacuum: a $z$-directed Hertzian current element (short dipole) of length $\\ell$ and phasor current amplitude $I_0$. The phasor time dependence convention is $e^{j \\omega t}$. A closed spherical Huygens surface of radius $a$ encloses the source. The environment is free space with permittivity $\\varepsilon_0$, permeability $\\mu_0$, speed of light $c = 1/\\sqrt{\\mu_0 \\varepsilon_0}$, wave impedance $\\eta_0 = \\sqrt{\\mu_0 / \\varepsilon_0}$, and wavenumber $k = \\omega / c = 2 \\pi f / c$.\n\nStarting from the Fundamental Laws and Core Definitions (Maxwell's equations in the frequency domain, the Equivalence Principle for electromagnetic fields, and Poynting's theorem for time-average power), implement a numerical near-to-far transformation that uses equivalent surface currents on the Huygens surface to obtain the far-field Poynting power density of the radiated field. Use a purely mathematical and logic-based approach and do not rely on any shortcut formulas. All angles must be in radians. All powers must be expressed in watts and all power densities in $\\mathrm{W/m^2}$.\n\nYou must:\n\n1. Use the tangential electric and magnetic field phasors on the spherical surface at radius $a$, denoted $E_\\theta(a,\\theta',\\phi')$ and $H_\\phi(a,\\theta',\\phi')$ (the primes denote the surface angular variables). These are the only nonzero tangential components for a $z$-directed Hertzian dipole in free space. For computational tractability and scientific realism, you may generate the surface field data from well-tested far-zone expressions that are valid when $k a \\gg 1$. You must not write down or rely on shortcut formulas in this problem statement; your solution must derive any required expressions from first principles.\n\n2. Form the equivalent electric and magnetic surface current densities on the spherical Huygens surface using the outward unit normal $\\mathbf{n}(\\theta',\\phi')$:\n   $$\\mathbf{J}_s(\\theta',\\phi') = \\mathbf{n}(\\theta',\\phi') \\times \\mathbf{H}(a,\\theta',\\phi'),\\qquad \\mathbf{M}_s(\\theta',\\phi') = -\\,\\mathbf{n}(\\theta',\\phi') \\times \\mathbf{E}(a,\\theta',\\phi').$$\n\n3. Compute the radiated far-field electric field $\\mathbf{E}_\\infty(\\hat{\\mathbf{r}})$ at an observation sphere of radius $R$ for a set of observation polar angles $\\theta \\in [0,\\pi]$ with fixed azimuth $\\phi = 0$. Use the appropriate radiation integrals consistent with the Equivalence Principle to map $\\mathbf{J}_s$ and $\\mathbf{M}_s$ on the closed surface to $\\mathbf{E}_\\infty(\\hat{\\mathbf{r}})$, including the correct oscillatory phase factor and $1/R$ amplitude scaling for the far field. Your derivation must start from Maxwell's equations and the Green's function representation, not from memorized target formulas. The final computed $\\mathbf{E}_\\infty$ must be expressed in $\\mathrm{V/m}$.\n\n4. From $\\mathbf{E}_\\infty(\\hat{\\mathbf{r}})$, compute the far-field magnetic field $\\mathbf{H}_\\infty(\\hat{\\mathbf{r}})$ using free-space relations, and then compute the time-average Poynting power density in the far zone\n   $$S_\\infty(\\theta) = \\frac{1}{2} \\operatorname{Re}\\!\\left[\\hat{\\mathbf{r}} \\cdot \\left(\\mathbf{E}_\\infty(\\hat{\\mathbf{r}}) \\times \\mathbf{H}_\\infty^*(\\hat{\\mathbf{r}})\\right)\\right],$$\n   in $\\mathrm{W/m^2}$, where $\\hat{\\mathbf{r}}$ is the observation unit vector and $^*$ denotes complex conjugation.\n\n5. Numerically integrate $S_\\infty(\\theta)$ over the observation sphere to obtain the total radiated power $P_{\\mathrm{ff}}$ in watts:\n   $$P_{\\mathrm{ff}} = \\int_0^{2\\pi} \\int_0^\\pi S_\\infty(\\theta)\\, R^2 \\sin\\theta \\, d\\theta \\, d\\phi.$$\n   By symmetry for the given source, $S_\\infty$ is independent of $\\phi$, so you may reduce the integral to a one-dimensional polar integration multiplied by $2\\pi$.\n\n6. Independently compute the input power $P_{\\mathrm{in}}$ crossing the Huygens surface by numerically integrating the radial component of the time-average Poynting vector derived from the surface field data:\n   $$P_{\\mathrm{in}} = \\int_0^{2\\pi} \\int_0^\\pi \\frac{1}{2} \\operatorname{Re}\\!\\left[\\mathbf{n}(\\theta',\\phi') \\cdot \\left(\\mathbf{E}(a,\\theta',\\phi') \\times \\mathbf{H}^*(a,\\theta',\\phi')\\right)\\right] a^2 \\sin\\theta' \\, d\\theta' \\, d\\phi'.$$\n   Use the same unit normal $\\mathbf{n}(\\theta',\\phi')$ and express $P_{\\mathrm{in}}$ in watts. For the given source and free-space environment, $P_{\\mathrm{in}}$ equals the total radiated power in steady state.\n\n7. Validate energy conservation by computing the relative error\n   $$\\delta = \\frac{|P_{\\mathrm{ff}} - P_{\\mathrm{in}}|}{P_{\\mathrm{in}}},$$\n   for each test case. The result must be a dimensionless decimal value.\n\nTest Suite:\n- Case A: $f = 600 \\times 10^6$ Hz, $I_0 = 1.0$ A, $\\ell = \\lambda / 50$, $a = 1.5 \\lambda$, $R = 10 \\lambda$.\n- Case B: $f = 3.0 \\times 10^9$ Hz, $I_0 = 0.75$ A, $\\ell = \\lambda / 80$, $a = 0.8 \\lambda$, $R = 8 \\lambda$.\n- Case C: $f = 1.0 \\times 10^9$ Hz, $I_0 = 0.2$ A, $\\ell = \\lambda / 30$, $a = 2.0 \\lambda$, $R = 12 \\lambda$.\n\nAll occurrences of $\\lambda$ denote the free-space wavelength $\\lambda = 2\\pi / k$. Angles are in radians. The numerical integrations must be performed over $\\theta$ and $\\phi$ using appropriate quadrature on uniform angle grids with clear step sizes. Your program must compute $\\delta$ for each case.\n\nFinal Output Format:\nYour program should produce a single line of output containing the three relative errors as a comma-separated list enclosed in square brackets, in the order [Case A, Case B, Case C]. For example: \"[0.00123,0.00098,0.00175]\".",
            "solution": "The user has provided a computational electromagnetics problem that requires validation and, if valid, a full solution.\n\n### Step 1: Problem Validation\n\nThe problem is a well-posed and scientifically sound exercise in computational electromagnetics. It asks for the implementation and verification of a near-to-far-field transformation (NTFF) based on the electromagnetic Equivalence Principle.\n\n- **Givens**: The problem provides all necessary information: a specific source (Hertzian dipole), a Huygens surface definition, physical constants (implicitly, via free space), a set of three distinct test cases with all parameters defined ($f$, $I_0$, $\\ell$, $a$, $R$), and a precise definition of the quantities to be computed and the final validation metric ($\\delta$).\n- **Scientific Grounding**: The problem is grounded in fundamental principles of electromagnetism: Maxwell's equations, the Equivalence Principle (formalized by Stratton-Chu integrals), and Poynting's theorem for power flow. These are canonical subjects in any advanced electrodynamics course.\n- **Well-Posed and Objective**: The task is structured as a self-consistency check, a standard validation procedure for numerical codes. It asks to verify that the power flowing through a closed surface equals the power radiated to the far field, where the far-field is computed from data on that same surface. The instruction to generate surface fields using a far-zone approximation for $ka \\gg 1$ is a standard simplification to create a self-contained, tractable problem. It does not introduce a contradiction but rather defines the input data for the NTFF algorithm. The requested calculations are objective and lead to a unique numerical result.\n- **No Flaws**: The problem does not violate any of the invalidity criteria. It is not based on false premises, is directly formalizable, is complete, and poses a non-trivial but feasible computational challenge.\n\n**Verdict**: The problem is valid.\n\n### Step 2: Principle-Based Solution Derivation\n\nThe solution rests upon the electromagnetic Equivalence Principle and Poynting's theorem. We will first derive the necessary theoretical expressions starting from fundamental laws, and then outline the numerical implementation.\n\n**1. Governing Equations and the Equivalence Principle**\nIn a source-free region of vacuum, time-harmonic electromagnetic fields with time dependence $e^{j\\omega t}$ obey Maxwell's curl equations:\n$$ \\nabla \\times \\mathbf{E} = -j\\omega\\mu_0 \\mathbf{H} $$\n$$ \\nabla \\times \\mathbf{H} = j\\omega\\varepsilon_0 \\mathbf{E} $$\nThe Equivalence Principle states that the fields in a source-free volume $V$ can be found by replacing the sources outside $V$ with a set of equivalent electric and magnetic surface currents on the boundary $S$ of $V$. These currents are given by:\n$$ \\mathbf{J}_s = \\mathbf{n} \\times \\mathbf{H} $$\n$$ \\mathbf{M}_s = -\\mathbf{n} \\times \\mathbf{E} $$\nwhere $\\mathbf{n}$ is the unit normal vector pointing out of $V$, and $(\\mathbf{E}, \\mathbf{H})$ are the original fields on $S$. These currents radiate into a source-free space, producing zero fields inside $S$ and the original fields outside $S$.\n\n**2. Radiation Integrals for the Far Field**\nThe electric field radiated by these surface currents can be expressed using a free-space Green's function, $G(\\mathbf{r}, \\mathbf{r}') = \\frac{e^{-jk|\\mathbf{r}-\\mathbf{r}'|}}{4\\pi|\\mathbf{r}-\\mathbf{r}'|}$. In the far field, where the observation distance $r = |\\mathbf{r}|$ is much larger than the source dimensions $r' = |\\mathbf{r}'|$ (i.e., $r \\gg a$), we use the approximation $|\\mathbf{r}-\\mathbf{r}'| \\approx r - \\hat{\\mathbf{r}}\\cdot\\mathbf{r}'$. The far-field electric field $\\mathbf{E}_\\infty$ is transverse to the direction of propagation $\\hat{\\mathbf{r}}$ and is given by:\n$$ \\mathbf{E}_\\infty(\\mathbf{r}) \\approx -\\frac{jke^{-jkr}}{4\\pi r} \\left( \\eta_0 \\mathbf{N}_\\perp + \\mathbf{L} \\times \\hat{\\mathbf{r}} \\right) $$\nwhere $\\mathbf{N}$ and $\\mathbf{L}$ are the radiation vectors, defined as the Fourier transforms of the surface currents:\n$$ \\mathbf{N} = \\int_S \\mathbf{J}_s(\\mathbf{r}') e^{jk\\hat{\\mathbf{r}}\\cdot\\mathbf{r}'} dS' $$\n$$ \\mathbf{L} = \\int_S \\mathbf{M}_s(\\mathbf{r}') e^{jk\\hat{\\mathbf{r}}\\cdot\\mathbf{r}'} dS' $$\nand $\\mathbf{N}_\\perp = \\mathbf{N} - (\\mathbf{N}\\cdot\\hat{\\mathbf{r}})\\hat{\\mathbf{r}}$ is the component of $\\mathbf{N}$ perpendicular to $\\hat{\\mathbf{r}}$. In spherical coordinates, the transverse field components at an observation point $(\\theta, \\phi)$ are:\n$$ E_{\\infty,\\theta} \\approx -\\frac{jke^{-jkr}}{4\\pi r}(L_\\phi + \\eta_0 N_\\theta) $$\n$$ E_{\\infty,\\phi} \\approx \\frac{jke^{-jkr}}{4\\pi r}(L_\\theta - \\eta_0 N_\\phi) $$\nwhere $(N_\\theta, N_\\phi)$ and $(L_\\theta, L_\\phi)$ are the spherical components of $\\mathbf{N}$ and $\\mathbf{L}$ in the observation frame.\n\n**3. Application to the Hertzian Dipole Problem**\nThe source is a $z$-directed Hertzian dipole of length $\\ell$ and current $I_0$ at the origin. The Huygens surface is a sphere of radius $a$. The problem specifies using far-zone expressions ($ka \\gg 1$) for the fields on this surface:\n$$ \\mathbf{E}(a, \\theta', \\phi') \\approx E_\\theta \\hat{\\boldsymbol{\\theta}}' = \\frac{j k \\eta_0 I_0 \\ell}{4\\pi a} \\sin\\theta' e^{-jka} \\hat{\\boldsymbol{\\theta}}' $$\n$$ \\mathbf{H}(a, \\theta', \\phi') \\approx H_\\phi \\hat{\\boldsymbol{\\phi}}' = \\frac{j k I_0 \\ell}{4\\pi a} \\sin\\theta' e^{-jka} \\hat{\\boldsymbol{\\phi}}' $$\nThe outward normal is $\\mathbf{n} = \\hat{\\mathbf{r}}'$. The equivalent currents on the surface $r'=a$ are:\n$$ \\mathbf{J}_s = \\hat{\\mathbf{r}}' \\times (H_\\phi \\hat{\\boldsymbol{\\phi}}') = -H_\\phi \\hat{\\boldsymbol{\\theta}}' $$\n$$ \\mathbf{M}_s = - \\hat{\\mathbf{r}}' \\times (E_\\theta \\hat{\\boldsymbol{\\theta}}') = -E_\\theta \\hat{\\boldsymbol{\\phi}}' $$\nThe radiation vectors are integrals over the spherical surface $dS' = a^2 \\sin\\theta' d\\theta' d\\phi'$. The phase term is $e^{jk\\hat{\\mathbf{r}}\\cdot\\mathbf{r}'} = e^{jka(\\sin\\theta\\sin\\theta'\\cos(\\phi-\\phi') + \\cos\\theta\\cos\\theta')}$. We can set the observation azimuth $\\phi=0$ without loss of generality.\nDue to the azimuthal symmetry of the source and geometry, many components of the Cartesian integrals for $\\mathbf{N}$ and $\\mathbf{L}$ vanish. The integration over $\\phi'$ can be performed analytically, yielding Bessel functions:\n$$ \\int_0^{2\\pi} e^{jz\\cos\\phi'}d\\phi' = 2\\pi J_0(z), \\quad \\int_0^{2\\pi} \\cos\\phi' e^{jz\\cos\\phi'}d\\phi' = 2\\pi j J_1(z) $$\nThis simplifies the 2D surface integrals to 1D integrals over $\\theta'$. The non-zero Cartesian components of the radiation vectors (for $\\phi=0$) are:\n$$ L_y(\\theta) = - \\int_0^\\pi E_\\theta(a, \\theta') \\left( \\int_0^{2\\pi} (\\cos\\phi') e^{jk\\hat{\\mathbf{r}}\\cdot\\mathbf{r}'} d\\phi' \\right) a^2 \\sin\\theta'd\\theta' $$\n$$ N_x(\\theta) = - \\int_0^\\pi H_\\phi(a, \\theta') \\left( \\int_0^{2\\pi} (\\cos\\theta'\\cos\\phi') e^{jk\\hat{\\mathbf{r}}\\cdot\\mathbf{r}'} d\\phi' \\right) a^2 \\sin\\theta'd\\theta' $$\n$$ N_z(\\theta) = - \\int_0^\\pi H_\\phi(a, \\theta') \\left( \\int_0^{2\\pi} (-\\sin\\theta') e^{jk\\hat{\\mathbf{r}}\\cdot\\mathbf{r}'} d\\phi' \\right) a^2 \\sin\\theta'd\\theta' $$\nFor a $z$-directed source, the far field has only an $E_\\theta$ component, so we expect $E_{\\infty,\\phi}=0$. This is confirmed as $L_\\theta=0$ and $N_\\phi=0$ by symmetry. The required components are $L_\\phi = L_y$ and $N_\\theta = N_x \\cos\\theta - N_z \\sin\\theta$. These 1D integrals over $\\theta'$ involving Bessel functions will be computed numerically.\n\n**4. Power Calculation and Verification**\nThe core of the problem is to verify energy conservation.\n- **Input Power ($P_{\\mathrm{in}}$)**: This is the total power crossing the Huygens surface, computed by integrating the radial component of the time-average Poynting vector $\\mathbf{S} = \\frac{1}{2}\\operatorname{Re}(\\mathbf{E} \\times \\mathbf{H}^*)$ over the surface:\n$$ P_{\\mathrm{in}} = \\oint_S \\mathbf{S} \\cdot d\\mathbf{S} = \\int_0^{2\\pi}\\int_0^\\pi \\frac{1}{2}\\operatorname{Re}[E_\\theta(a,\\theta') H_\\phi^*(a,\\theta')] a^2 \\sin\\theta' d\\theta' d\\phi' $$\nSince $E_\\theta = \\eta_0 H_\\phi$ in our model, the integrand is azimuthally symmetric and the integral simplifies to a 1D numerical integration over $\\theta'$.\n\n- **Far-Field Power ($P_{\\mathrm{ff}}$)**: This is computed by integrating the far-field power density over a large sphere of radius $R$:\n$$ S_\\infty(\\theta) = \\frac{1}{2}\\operatorname{Re}[\\hat{\\mathbf{r}}\\cdot(\\mathbf{E}_\\infty \\times \\mathbf{H}_\\infty^*)] = \\frac{1}{2\\eta_0}|E_{\\infty,\\theta}|^2 $$\n$$ P_{\\mathrm{ff}} = \\int_0^{2\\pi}\\int_0^\\pi S_\\infty(\\theta) R^2 \\sin\\theta d\\theta d\\phi = 2\\pi R^2 \\int_0^\\pi S_\\infty(\\theta) \\sin\\theta d\\theta $$\nNote that the $R^2$ dependence in the surface element cancels the $1/R^2$ dependence in $S_\\infty$, making $P_{\\mathrm{ff}}$ independent of the observation radius $R$, as expected.\n\n- **Relative Error**: The self-consistency of the numerical model is validated by computing the relative error:\n$$ \\delta = \\frac{|P_{\\mathrm{ff}} - P_{\\mathrm{in}}|}{P_{\\mathrm{in}}} $$\nA small value of $\\delta$ confirms that the numerical implementation of the near-to-far-field transformation conserves power.\n\n**5. Numerical Implementation**\nThe procedure is implemented as follows:\n1. For each test case, calculate all physical and geometric parameters.\n2. Compute $P_{\\mathrm{in}}$ by numerically integrating its defining expression over a uniform grid in $\\theta'$ using the trapezoidal rule.\n3. To find $P_{\\mathrm{ff}}$, an outer loop iterates over an observation grid in $\\theta$. For each observation angle $\\theta_i$:\n    a. The 1D integrals for $L_y, N_x, N_z$ are computed numerically over a fine uniform grid in $\\theta'$. These integrands involve Bessel functions $J_0$ and $J_1$.\n    b. The far-field $E_{\\infty,\\theta}(\\theta_i)$ is assembled from these components.\n    c. The power density $S_\\infty(\\theta_i)$ is calculated.\n4. The resulting array of $S_\\infty(\\theta_i)$ values is numerically integrated over the observation grid $\\theta$ to yield $P_{\\mathrm{ff}}$.\n5. The relative error $\\delta$ is computed.\nThis process is repeated for all test cases.",
            "answer": "```python\nimport numpy as np\nfrom scipy import special\n\ndef solve():\n    \"\"\"\n    Main function to run test cases and print results.\n    \"\"\"\n    # Physical constants\n    C0 = 299792458.0  # Speed of light in vacuum (m/s)\n    MU0 = 4.0 * np.pi * 1e-7  # Permeability of vacuum (H/m)\n    EPS0 = 1.0 / (MU0 * C0**2)  # Permittivity of vacuum (F/m)\n    ETA0 = np.sqrt(MU0 / EPS0)  # Impedance of free space (Ohms)\n\n    # Test cases from the problem statement\n    test_cases = [\n        # (f, I0, l_lambda_ratio, a_lambda_ratio, R_lambda_ratio)\n        (600e6, 1.0, 1.0/50.0, 1.5, 10.0),  # Case A\n        (3.0e9, 0.75, 1.0/80.0, 0.8, 8.0),   # Case B\n        (1.0e9, 0.2, 1.0/30.0, 2.0, 12.0),  # Case C\n    ]\n    \n    # Numerical integration parameters\n    # Grid for radiation integrals (Huygens surface source points)\n    N_theta_prime = 2001\n    theta_prime_grid = np.linspace(0, np.pi, N_theta_prime)\n\n    # Grid for far-field power integration (observer points)\n    N_theta_obs = 1001\n    theta_obs_grid = np.linspace(0, np.pi, N_theta_obs)\n    \n    results = []\n    \n    for case in test_cases:\n        f, I0, l_ratio, a_ratio, R_ratio = case\n        \n        # Calculate derived parameters\n        lambda_ = C0 / f\n        k = 2.0 * np.pi / lambda_\n        omega = 2.0 * np.pi * f\n        dipole_length = l_ratio * lambda_\n        huygens_radius = a_ratio * lambda_\n        obs_radius = R_ratio * lambda_\n\n        # --- 1. Compute Input Power (P_in) ---\n        # Power is integrated over the Huygens surface at r = a.\n        # E_theta = eta0 * H_phi for the assumed far-zone fields on the surface.\n        # S_r = 0.5 * Re(E_theta * H_phi*) = 0.5 * eta0 * |H_phi|^2\n        # H_phi(a, theta') = (j*k*I0*l / (4*pi*a)) * sin(theta') * exp(-jka)\n        H_phi_amp = (k * I0 * dipole_length) / (4.0 * np.pi * huygens_radius)\n        \n        # Integrand for P_in\n        integrand_Pin = (0.5 * ETA0 * (H_phi_amp * np.sin(theta_prime_grid))**2 * \n                         huygens_radius**2 * np.sin(theta_prime_grid))\n        \n        # P_in is integral over theta' from 0 to pi, and over phi' from 0 to 2pi.\n        # The phi' integral gives 2pi.\n        P_in = 2.0 * np.pi * np.trapz(integrand_Pin, theta_prime_grid)\n\n        # --- 2. Compute Far-Field Power (P_ff) ---\n        E_far_theta = np.zeros(N_theta_obs, dtype=np.complex128)\n\n        # Pre-calculate source field amplitudes on the Huygens surface\n        H_phi_complex_amp = (1j * k * I0 * dipole_length / (4.0 * np.pi * huygens_radius) *\n                             np.exp(-1j * k * huygens_radius))\n        E_theta_complex_amp = ETA0 * H_phi_complex_amp\n\n        # Pre-calculate radiation vector coefficients\n        coeff_N = -H_phi_complex_amp * huygens_radius**2\n        coeff_M = -E_theta_complex_amp * huygens_radius**2\n        \n        # Vectorized grid calculations for the integration over theta'\n        sin_theta_p = np.sin(theta_prime_grid)\n        cos_theta_p = np.cos(theta_prime_grid)\n\n        for i, theta_obs in enumerate(theta_obs_grid):\n            # Phase term depends on observer angle theta_obs and source angle theta_p\n            sin_theta_o = np.sin(theta_obs)\n            cos_theta_o = np.cos(theta_obs)\n            \n            # Argument for Bessel functions\n            z_bessel = k * huygens_radius * sin_theta_o * sin_theta_p\n            \n            # Phase term from the exponent\n            exp_term = np.exp(1j * k * huygens_radius * cos_theta_o * cos_theta_p)\n            \n            # Evaluate Bessel functions on the grid points\n            j0_vals = special.j0(z_bessel)\n            j1_vals = special.j1(z_bessel)\n            \n            # Integrands for N_x, N_z, and L_y (others are zero by symmetry)\n            # These are evaluated on the theta_prime_grid\n            integrand_Nx = cos_theta_p * sin_theta_p * (2.0 * np.pi * 1j * j1_vals) * exp_term\n            integrand_Nz = -sin_theta_p**2 * (2.0 * np.pi * j0_vals) * exp_term\n            integrand_Ly = sin_theta_p * (2.0 * np.pi * 1j * j1_vals) * exp_term\n                                            \n            # Numerical integration over theta'\n            integral_Nx = np.trapz(integrand_Nx * sin_theta_p, theta_prime_grid)\n            integral_Nz = np.trapz(integrand_Nz * sin_theta_p, theta_prime_grid)\n            integral_Ly = np.trapz(integrand_Ly * sin_theta_p, theta_prime_grid)\n\n            # Compute radiation vector components\n            Nx = coeff_N * integral_Nx\n            Nz = coeff_N * integral_Nz\n            Ly = coeff_M * integral_Ly\n\n            # Spherical components in observer frame\n            N_theta = Nx * cos_theta_o - Nz * sin_theta_o\n            L_phi = Ly\n            \n            # Far-field E_theta component\n            E_far_theta[i] = (-1j * k * np.exp(-1j * k * obs_radius) / (4.0 * np.pi * obs_radius) *\n                              (L_phi + ETA0 * N_theta))\n        \n        # Far-field power density\n        S_far_density = (1.0 / (2.0 * ETA0)) * np.abs(E_far_theta)**2\n        \n        # Total far-field power by integrating density over the large sphere\n        integrand_Pff = S_far_density * obs_radius**2 * np.sin(theta_obs_grid)\n        P_ff = 2.0 * np.pi * np.trapz(integrand_Pff, theta_obs_grid)\n        \n        # --- 3. Compute Relative Error ---\n        if P_in == 0:\n            relative_error = np.inf if P_ff != 0 else 0\n        else:\n            relative_error = np.abs(P_ff - P_in) / P_in\n            \n        results.append(relative_error)\n    \n    # Print the final result in the specified format\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```"
        }
    ]
}