{
    "hands_on_practices": [
        {
            "introduction": "This first exercise confronts a classic case where a solution to an electromagnetic problem is not unique. By implementing a finite difference solver for Laplace's equation, $\\nabla^2 \\phi = 0$, with pure Neumann boundary conditions, you will numerically demonstrate the resulting ambiguity. This practice is essential for learning how to identify and resolve ill-posed problems, a critical skill in computational modeling. ",
            "id": "3354244",
            "problem": "Consider the quasi-static limit of Maxwell’s equations in a source-free, homogeneous, isotropic medium with permittivity $\\varepsilon$, where the electric field $\\mathbf{E}$ is irrotational and can be represented as $\\mathbf{E} = - \\nabla \\phi$. In this limit, the constitutive relation $\\mathbf{D} = \\varepsilon \\mathbf{E}$ and Gauss’s law $\\nabla \\cdot \\mathbf{D} = 0$ imply the Laplace equation $\\nabla^2 \\phi = 0$ for the scalar potential $\\phi$. The uniqueness theorem for boundary-value problems states that for pure Neumann boundary conditions, the solution of $\\nabla^2 \\phi = 0$ on a closed bounded domain is determined only up to an additive constant, and a natural way to restore uniqueness is to add a constraint that fixes the constant (for example, a zero-mean constraint).\n\nYou will implement a finite difference simulation of $\\nabla^2 \\phi = 0$ on the unit square domain $\\Omega = [0,1] \\times [0,1]$ with pure Neumann boundary conditions on all four sides. Use a uniform grid of $N_x \\times N_y$ points, with spacings $h_x = \\frac{1}{N_x - 1}$ and $h_y = \\frac{1}{N_y - 1}$. Index grid points as $(i,j)$ with $i \\in \\{0,1,\\dots,N_y-1\\}$ denoting the $y$-index and $j \\in \\{0,1,\\dots,N_x-1\\}$ denoting the $x$-index. Denote the unknowns by $\\phi_{i,j}$ arranged into a vector of length $N = N_x N_y$ via a lexicographic map $k = i N_x + j$. Discretize the Laplacian with the standard five-point stencil for interior points:\n$$\n\\frac{\\phi_{i+1,j} - 2 \\phi_{i,j} + \\phi_{i-1,j}}{h_y^2} + \\frac{\\phi_{i,j+1} - 2 \\phi_{i,j} + \\phi_{i,j-1}}{h_x^2} = 0,\n$$\nand impose inhomogeneous Neumann boundary conditions using ghost nodes derived from the central difference approximation of the normal derivative. Let $\\partial \\phi / \\partial n$ on the top, bottom, left, and right boundaries be specified by constants $g_t$, $g_b$, $g_l$, and $g_r$, respectively. With outward unit normals $\\mathbf{n}$, the boundary conditions are\n$$\n\\left.\\frac{\\partial \\phi}{\\partial n}\\right|_{\\text{top}} = g_t,\\quad\n\\left.\\frac{\\partial \\phi}{\\partial n}\\right|_{\\text{bottom}} = g_b,\\quad\n\\left.\\frac{\\partial \\phi}{\\partial n}\\right|_{\\text{left}} = g_l,\\quad\n\\left.\\frac{\\partial \\phi}{\\partial n}\\right|_{\\text{right}} = g_r.\n$$\nLet the derivatives along coordinate directions at boundaries satisfy\n$$\n\\left.\\frac{\\partial \\phi}{\\partial y}\\right|_{\\text{top}} = + g_t,\\quad\n\\left.\\frac{\\partial \\phi}{\\partial y}\\right|_{\\text{bottom}} = - g_b,\\quad\n\\left.\\frac{\\partial \\phi}{\\partial x}\\right|_{\\text{left}} = - g_l,\\quad\n\\left.\\frac{\\partial \\phi}{\\partial x}\\right|_{\\text{right}} = + g_r,\n$$\nreflecting outward normal directions. Enforce these with central differences to eliminate ghost nodes:\n- At the bottom ($i = 0$), use $\\frac{\\phi_{1,j} - \\phi_{-1,j}}{2 h_y} = - g_b$ so that $\\phi_{-1,j} = \\phi_{1,j} + 2 h_y g_b$, yielding the $y$-term\n$$\n\\frac{\\phi_{1,j} - 2 \\phi_{0,j} + \\phi_{-1,j}}{h_y^2} = \\frac{2 \\phi_{1,j} - 2 \\phi_{0,j}}{h_y^2} + \\frac{2 g_b}{h_y}.\n$$\n- At the top ($i = N_y - 1$), use $\\frac{\\phi_{N_y,j} - \\phi_{N_y-2,j}}{2 h_y} = + g_t$ so that $\\phi_{N_y,j} = \\phi_{N_y-2,j} + 2 h_y g_t$, yielding\n$$\n\\frac{\\phi_{N_y,j} - 2 \\phi_{N_y-1,j} + \\phi_{N_y-2,j}}{h_y^2} = \\frac{2 \\phi_{N_y-2,j} - 2 \\phi_{N_y-1,j}}{h_y^2} + \\frac{2 g_t}{h_y}.\n$$\n- At the left ($j = 0$), use $\\frac{\\phi_{i,1} - \\phi_{i,-1}}{2 h_x} = - g_l$ so that $\\phi_{i,-1} = \\phi_{i,1} + 2 h_x g_l$, yielding\n$$\n\\frac{\\phi_{i,1} - 2 \\phi_{i,0} + \\phi_{i,-1}}{h_x^2} = \\frac{2 \\phi_{i,1} - 2 \\phi_{i,0}}{h_x^2} + \\frac{2 g_l}{h_x}.\n$$\n- At the right ($j = N_x - 1$), use $\\frac{\\phi_{i,N_x} - \\phi_{i,N_x-2}}{2 h_x} = + g_r$ so that $\\phi_{i,N_x} = \\phi_{i,N_x-2} + 2 h_x g_r$, yielding\n$$\n\\frac{\\phi_{i,N_x} - 2 \\phi_{i,N_x-1} + \\phi_{i,N_x-2}}{h_x^2} = \\frac{2 \\phi_{i,N_x-2} - 2 \\phi_{i,N_x-1}}{h_x^2} + \\frac{2 g_r}{h_x}.\n$$\nCollect all terms into a linear system $A \\phi = b$, where $A$ is an $N \\times N$ matrix and $b$ is a vector of length $N$. Move the constant terms produced by Neumann boundaries to the right-hand side, i.e., subtract them from the left-hand side contributions so that they appear with a minus sign on the right-hand side; concretely, each applicable boundary contribution adds $-\\frac{2 g_b}{h_y}$, $-\\frac{2 g_t}{h_y}$, $-\\frac{2 g_l}{h_x}$, or $-\\frac{2 g_r}{h_x}$ to the corresponding entry in $b$. For interior nodes, use the standard coefficients $\\frac{1}{h_y^2}$, $-\\frac{2}{h_y^2}$, and $\\frac{1}{h_x^2}$, $-\\frac{2}{h_x^2}$; for boundary nodes, replace missing neighbors using the ghost-node substitutions, which produce modified coefficients of $\\frac{2}{h_y^2}$ or $\\frac{2}{h_x^2}$ for the nearest interior neighbor and $-\\frac{2}{h_y^2}$ or $-\\frac{2}{h_x^2}$ for the center, with the constant offsets moved to $b$ as described above. This construction yields an $A$ whose row sums are zero, so the constant vector is in the nullspace, and the system is solvable if and only if the right-hand side $b$ sums to zero, which is ensured when $g_t = - g_b$ and $g_r = - g_l$.\n\nTasks:\n- For each test case in the test suite below, assemble $A$ and $b$ following the above rules, and compute a particular solution $\\phi_0$ using the Moore–Penrose pseudoinverse. The pseudoinverse may be computed via Singular Value Decomposition (SVD).\n- Demonstrate the constant-offset non-uniqueness by verifying that $A(\\phi_0 + c \\mathbf{1}) = b$ holds numerically for multiple constants $c$, where $\\mathbf{1}$ is the $N$-vector of ones. Quantify this by computing the maximum residual norm over a set of constants $c$:\n$$\nr_{\\max} = \\max_{c \\in \\mathcal{C}} \\left\\| A(\\phi_0 + c \\mathbf{1}) - b \\right\\|_2,\n$$\nwith $\\mathcal{C} = \\{-0.3, 0.0, 0.9\\}$.\n- Impose the zero-mean constraint to restore uniqueness by projecting any solution onto the subspace of zero mean:\n$$\n\\phi_{\\text{zm}} = \\phi - \\frac{1}{N} \\sum_{k=0}^{N-1} \\phi_k.\n$$\nFor each $c \\in \\mathcal{C}$, compute $\\phi_c = \\phi_0 + c \\mathbf{1}$ and $\\phi_{c,\\text{zm}} = \\phi_c - \\frac{1}{N} \\sum_{k} (\\phi_c)_k$. Quantify uniqueness restoration by computing:\n$$\nd_{\\max} = \\max_{c \\in \\mathcal{C}} \\left\\| \\phi_{c,\\text{zm}} - \\phi_{0,\\text{zm}} \\right\\|_2,\\quad m_{\\text{abs}} = \\left| \\frac{1}{N} \\sum_{k=0}^{N-1} (\\phi_{0,\\text{zm}})_k \\right|.\n$$\n\nTest suite:\n- Case $1$: $N_x = 5$, $N_y = 4$, $g_t = 1.0$, $g_b = -1.0$, $g_l = 0.0$, $g_r = 0.0$.\n- Case $2$: $N_x = 6$, $N_y = 6$, $g_t = 0.0$, $g_b = 0.0$, $g_l = 0.5$, $g_r = -0.5$.\n- Case $3$: $N_x = 3$, $N_y = 3$, $g_t = 0.0$, $g_b = 0.0$, $g_l = 0.0$, $g_r = 0.0$.\n\nAll quantities are dimensionless in this mathematical formulation. Angles do not appear. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, flattening the triples $(r_{\\max}, d_{\\max}, m_{\\text{abs}})$ for the $3$ cases in order. For example, the output format must be\n$$\n[\\text{case1\\_}r_{\\max},\\text{case1\\_}d_{\\max},\\text{case1\\_}m_{\\text{abs}},\\text{case2\\_}r_{\\max},\\text{case2\\_}d_{\\max},\\text{case2\\_}m_{\\text{abs}},\\text{case3\\_}r_{\\max},\\text{case3\\_}d_{\\max},\\text{case3\\_}m_{\\text{abs}}].\n$$\nEach entry must be a float.",
            "solution": "The core of this problem is to construct and analyze the linear system of equations, $A \\phi = b$, representing the discretized Laplace equation $\\nabla^2 \\phi = 0$ on a unit square grid with pure Neumann boundary conditions. The vector $\\phi$ contains the unknown potential values $\\phi_{i,j}$ at each grid point, ordered lexicographically. The matrix $A$ represents the discretized Laplacian operator, and the vector $b$ incorporates the values from the inhomogeneous boundary conditions.\n\nFirst, the grid and discretization parameters are established. For an $N_x \\times N_y$ grid on the domain $[0,1] \\times [0,1]$, the total number of unknowns is $N = N_x N_y$. The grid spacings are $h_x = 1/(N_x - 1)$ and $h_y = 1/(N_y - 1)$. The coefficients for the finite difference stencil are $c_x = 1/h_x^2$ and $c_y = 1/h_y^2$. The mapping from a 2D grid index $(i, j)$ to a 1D vector index $k$ is $k = i N_x + j$.\n\nThe matrix $A$ and vector $b$ are assembled by iterating through each grid point $(i, j)$ and constructing the corresponding row of the linear system. The form of this equation depends on whether the point is in the interior, on a boundary, or at a corner.\n1.  **Interior points** ($0 < i < N_y-1$ and $0 < j < N_x-1$): The standard five-point stencil for the Laplacian is used, setting the coefficients in row $k$ of $A$ for the center node $\\phi_{i,j}$ and its four neighbors. The corresponding entry $b_k$ is $0$.\n2.  **Boundary points**: For points on the boundary, the finite difference approximations incorporating the Neumann conditions (derived from ghost nodes) are used. For example, on the bottom boundary ($i=0$), the stencil is modified, contributing $2c_y$ to the coefficient of the neighbor $\\phi_{1,j}$, $-2c_y$ to the diagonal term for $\\phi_{0,j}$, and adding $-\\frac{2g_b}{h_y}$ to the right-hand side vector $b_k$. Similar modifications are made for the other three boundaries.\n3.  **Corner points**: These points are affected by two boundary conditions simultaneously. The equation for a corner node combines the stencil modifications from both relevant boundaries.\n\nAfter assembly, the matrix $A$ is singular. Its row sums are all zero, which means the constant vector $\\mathbf{1}$ (a vector of all ones) lies in its nullspace ($A\\mathbf{1} = \\mathbf{0}$). A solution to $A\\phi=b$ exists only if $b$ is compatible, which discretely corresponds to the net flux being zero. The problem statement ensures this condition is met for the test cases.\n\nTo handle the singularity and non-uniqueness, the following steps are taken:\n-   A particular solution $\\phi_0$ is found by computing the minimum-norm least-squares solution to $A\\phi=b$, equivalent to using the Moore-Penrose pseudoinverse: $\\phi_0 = A^\\dagger b$. This can be computed using `numpy.linalg.lstsq`.\n-   The non-uniqueness is demonstrated by checking that any vector $\\phi_0 + c\\mathbf{1}$ is also a solution. The residual $\\|A(\\phi_0 + c\\mathbf{1}) - b\\|_2$ should be close to zero, limited only by floating-point precision, for any constant $c$. The maximum residual $r_{\\max}$ over a set of constants $\\mathcal{C}$ quantifies this.\n-   Uniqueness is restored by projecting any solution onto the subspace of functions with a zero mean via the transformation $\\phi_{\\text{zm}} = \\phi - \\text{mean}(\\phi)$. We verify that for any constant offset $c$, the projection is invariant: $\\phi_{c, \\text{zm}} = \\phi_{0,\\text{zm}}$. This is quantified by computing $d_{\\max} = \\max_{c \\in \\mathcal{C}} \\|\\phi_{c,\\text{zm}} - \\phi_{0,\\text{zm}}\\|_2$, which should be close to zero.\n-   Finally, the absolute value of the mean of the projected base solution, $m_{\\text{abs}} = |\\text{mean}(\\phi_{0,\\text{zm}})|$, is computed to confirm it is indeed zero.\n\nThe provided Python code implements this entire procedure, iterating through the test cases, performing the matrix assembly and calculations, and formatting the output as required.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef run_simulation(Nx, Ny, gt, gb, gl, gr):\n    \"\"\"\n    Assembles and solves the finite difference system for the Laplace equation\n    with pure Neumann boundary conditions, then computes the required metrics.\n    \n    Args:\n        Nx (int): Number of grid points in the x-direction.\n        Ny (int): Number of grid points in the y-direction.\n        gt, gb, gl, gr (float): Neumann boundary condition values for top, bottom,\n                                 left, and right sides, respectively.\n                                 \n    Returns:\n        tuple: A tuple containing (r_max, d_max, m_abs).\n    \"\"\"\n    N = Nx * Ny\n    \n    # Grid spacings. Handles 1D cases not present in the test suite.\n    hx = 1.0 / (Nx - 1) if Nx > 1 else float('inf')\n    hy = 1.0 / (Ny - 1) if Ny > 1 else float('inf')\n    \n    # Pre-calculate stencil coefficients.\n    cx = 1.0 / hx**2 if hx != float('inf') else 0.0\n    cy = 1.0 / hy**2 if hy != float('inf') else 0.0\n    \n    A = np.zeros((N, N))\n    b = np.zeros(N)\n    \n    # Assemble the matrix A and vector b\n    for i in range(Ny):\n        for j in range(Nx):\n            k = i * Nx + j  # Row index for the current node (i, j)\n            \n            # Y-derivative part (d^2/dy^2)\n            if Ny > 1:\n                if i == 0:  # Bottom boundary (i=0)\n                    A[k, k] -= 2 * cy\n                    A[k, k + Nx] += 2 * cy\n                    b[k] -= 2 * gb / hy\n                elif i == Ny - 1:  # Top boundary (i=Ny-1)\n                    A[k, k] -= 2 * cy\n                    A[k, k - Nx] += 2 * cy\n                    b[k] -= 2 * gt / hy\n                else:  # Interior y\n                    A[k, k] -= 2 * cy\n                    A[k, k - Nx] += cy\n                    A[k, k + Nx] += cy\n            \n            # X-derivative part (d^2/dx^2)\n            if Nx > 1:\n                if j == 0:  # Left boundary (j=0)\n                    A[k, k] -= 2 * cx\n                    A[k, k + 1] += 2 * cx\n                    b[k] -= 2 * gl / hx\n                elif j == Nx - 1:  # Right boundary (j=Nx-1)\n                    A[k, k] -= 2 * cx\n                    A[k, k - 1] += 2 * cx\n                    b[k] -= 2 * gr / hx\n                else:  # Interior x\n                    A[k, k] -= 2 * cx\n                    A[k, k - 1] += cx\n                    A[k, k + 1] += cx\n\n    # Task 1: Compute a particular solution phi_0 using Moore-Penrose pseudoinverse.\n    # np.linalg.lstsq finds the minimum-norm least-squares solution.\n    phi_0 = np.linalg.lstsq(A, b, rcond=None)[0]\n    \n    # Task 2: Demonstrate non-uniqueness and compute r_max\n    C = [-0.3, 0.0, 0.9]\n    ones_vec = np.ones(N)\n    residual_norms = []\n    \n    for c in C:\n        phi_c = phi_0 + c * ones_vec\n        residual_vector = A @ phi_c - b\n        residual_norms.append(np.linalg.norm(residual_vector))\n        \n    r_max = np.max(residual_norms)\n    \n    # Task 3: Impose zero-mean constraint and quantify uniqueness restoration\n    # Base zero-mean solution\n    phi_0_zm = phi_0 - np.mean(phi_0)\n    \n    diff_norms = []\n    for c in C:\n        phi_c = phi_0 + c * ones_vec\n        # Project phi_c to have zero mean\n        phi_c_zm = phi_c - np.mean(phi_c)\n        # Compute the norm of the difference to the base zero-mean solution\n        diff_norms.append(np.linalg.norm(phi_c_zm - phi_0_zm))\n        \n    d_max = np.max(diff_norms)\n    \n    # Absolute mean of the base zero-mean solution (should be ~0)\n    m_abs = np.abs(np.mean(phi_0_zm))\n    \n    return r_max, d_max, m_abs\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (Nx, Ny, gt, gb, gl, gr)\n        (5, 4, 1.0, -1.0, 0.0, 0.0),\n        (6, 6, 0.0, 0.0, 0.5, -0.5),\n        (3, 3, 0.0, 0.0, 0.0, 0.0),\n    ]\n\n    results = []\n    for case in test_cases:\n        Nx, Ny, gt, gb, gl, gr = case\n        r_max, d_max, m_abs = run_simulation(Nx, Ny, gt, gb, gl, gr)\n        results.extend([r_max, d_max, m_abs])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{x:.10e}' for x in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "We now turn from uniqueness to the theoretical underpinnings of the reciprocity theorem. This exercise is a fundamental pen-and-paper derivation that shows how the symmetry of material tensors leads to a corresponding symmetry in the electromagnetic response. Proving the reciprocity property of the dyadic Green's function, $G_{ij}(\\mathbf{r}, \\mathbf{r}') = G_{ji}(\\mathbf{r}', \\mathbf{r})$, provides deep insight into the structure of Maxwell's equations and justifies its use in many advanced algorithms. ",
            "id": "3354292",
            "problem": "Consider a three-dimensional, linear, source-free except at specified points, stratified medium whose material tensors depend only on the coordinate $z$ and are piecewise constant in $z$ with planar interfaces parallel to the $x$-$y$ plane. Assume a time-harmonic convention $\\exp(-i \\omega t)$ and that the constitutive relations are $\\mathbf{D} = \\boldsymbol{\\epsilon}(z) \\mathbf{E}$ and $\\mathbf{B} = \\boldsymbol{\\mu}(z) \\mathbf{H}$, with $\\boldsymbol{\\epsilon}(z) = \\boldsymbol{\\epsilon}^{T}(z)$ and $\\boldsymbol{\\mu}(z) = \\boldsymbol{\\mu}^{T}(z)$ everywhere (no magnetoelectric coupling). The frequency-domain Maxwell equations are\n$$\n\\nabla \\times \\mathbf{E} = i \\omega \\boldsymbol{\\mu} \\mathbf{H}, \\qquad\n\\nabla \\times \\mathbf{H} = \\mathbf{J} - i \\omega \\boldsymbol{\\epsilon} \\mathbf{E},\n$$\nwith standard interface conditions: continuity of the tangential components of $\\mathbf{E}$ and $\\mathbf{H}$ at every interface, and an outgoing-wave radiation condition at infinity.\n\nDefine the electric dyadic Green’s function $\\mathbf{G}(\\mathbf{r}, \\mathbf{r}')$ for this medium as the solution of\n$$\n\\nabla \\times \\boldsymbol{\\mu}^{-1}(\\mathbf{r}) \\nabla \\times \\mathbf{G}(\\mathbf{r}, \\mathbf{r}') - \\omega^{2} \\boldsymbol{\\epsilon}(\\mathbf{r}) \\mathbf{G}(\\mathbf{r}, \\mathbf{r}') = \\mathbf{I} \\, \\delta(\\mathbf{r} - \\mathbf{r}'),\n$$\nsubject to the same interface and radiation conditions, where $\\mathbf{I}$ is the identity dyad and $\\delta(\\cdot)$ is the Dirac delta distribution. By definition, for any impressed electric current density $\\mathbf{J}(\\mathbf{r}')$, the electric field response is\n$$\n\\mathbf{E}(\\mathbf{r}) = i \\omega \\int \\mathbf{G}(\\mathbf{r}, \\mathbf{r}') \\cdot \\mathbf{J}(\\mathbf{r}') \\, dV'.\n$$\n\nLet $\\mathbf{J}^{(1)}(\\boldsymbol{\\rho}) = \\hat{\\mathbf{e}}_{j} \\, \\delta(\\boldsymbol{\\rho} - \\mathbf{r}')$ and $\\mathbf{J}^{(2)}(\\boldsymbol{\\rho}) = \\hat{\\mathbf{e}}_{i} \\, \\delta(\\boldsymbol{\\rho} - \\mathbf{r})$ be two point electric-current excitations defined using a dummy coordinate $\\boldsymbol{\\rho}$, where $\\hat{\\mathbf{e}}_{i}$ and $\\hat{\\mathbf{e}}_{j}$ are Cartesian unit vectors and $\\mathbf{r}$, $\\mathbf{r}'$ are arbitrary field/source points (possibly in different layers). Denote the corresponding field solutions by $(\\mathbf{E}^{(1)}, \\mathbf{H}^{(1)})$ and $(\\mathbf{E}^{(2)}, \\mathbf{H}^{(2)})$.\n\nStarting from the frequency-domain Maxwell equations and using only the stated constitutive symmetries, boundary/interface conditions, and outgoing radiation condition, compute the reciprocity check quantity\n$$\nR_{ij}(\\mathbf{r}, \\mathbf{r}') \\equiv G_{ij}(\\mathbf{r}, \\mathbf{r}') - G_{ji}(\\mathbf{r}', \\mathbf{r}),\n$$\nwhere $G_{ij}$ is the $(i,j)$ component of the dyadic Green’s function. Express your final result for $R_{ij}(\\mathbf{r}, \\mathbf{r}')$ as a single simplified analytic expression. No rounding is required, and no units should be provided in the final answer.",
            "solution": "The problem requires the computation of the reciprocity check quantity $R_{ij}(\\mathbf{r}, \\mathbf{r}') \\equiv G_{ij}(\\mathbf{r}, \\mathbf{r}') - G_{ji}(\\mathbf{r}', \\mathbf{r})$. This quantity measures the failure of the reciprocity relation for the dyadic Green's function. The derivation will be based on the Lorentz reciprocity theorem, applied to the specific context defined in the problem.\n\nLet us consider two sets of time-harmonic sources and fields, $(\\mathbf{E}^{(1)}, \\mathbf{H}^{(1)})$ corresponding to a current source $\\mathbf{J}^{(1)}$, and $(\\mathbf{E}^{(2)}, \\mathbf{H}^{(2)})$ corresponding to $\\mathbf{J}^{(2)}$. They satisfy the frequency-domain Maxwell equations:\n$$\n\\nabla \\times \\mathbf{E}^{(1)} = i \\omega \\boldsymbol{\\mu} \\mathbf{H}^{(1)} \\quad (1a)\n$$\n$$\n\\nabla \\times \\mathbf{H}^{(1)} = \\mathbf{J}^{(1)} - i \\omega \\boldsymbol{\\epsilon} \\mathbf{E}^{(1)} \\quad (1b)\n$$\n$$\n\\nabla \\times \\mathbf{E}^{(2)} = i \\omega \\boldsymbol{\\mu} \\mathbf{H}^{(2)} \\quad (2a)\n$$\n$$\n\\nabla \\times \\mathbf{H}^{(2)} = \\mathbf{J}^{(2)} - i \\omega \\boldsymbol{\\epsilon} \\mathbf{E}^{(2)} \\quad (2b)\n$$\nWe use the vector identity $\\nabla \\cdot (\\mathbf{A} \\times \\mathbf{B}) = \\mathbf{B} \\cdot (\\nabla \\times \\mathbf{A}) - \\mathbf{A} \\cdot (\\nabla \\times \\mathbf{B})$ to form the expression $\\nabla \\cdot (\\mathbf{E}^{(1)} \\times \\mathbf{H}^{(2)})$:\n$$\n\\nabla \\cdot (\\mathbf{E}^{(1)} \\times \\mathbf{H}^{(2)}) = \\mathbf{H}^{(2)} \\cdot (\\nabla \\times \\mathbf{E}^{(1)}) - \\mathbf{E}^{(1)} \\cdot (\\nabla \\times \\mathbf{H}^{(2)})\n$$\nSubstituting from equations $(1a)$ and $(2b)$:\n$$\n\\nabla \\cdot (\\mathbf{E}^{(1)} \\times \\mathbf{H}^{(2)}) = \\mathbf{H}^{(2)} \\cdot (i \\omega \\boldsymbol{\\mu} \\mathbf{H}^{(1)}) - \\mathbf{E}^{(1)} \\cdot (\\mathbf{J}^{(2)} - i \\omega \\boldsymbol{\\epsilon} \\mathbf{E}^{(2)})\n$$\n$$\n\\nabla \\cdot (\\mathbf{E}^{(1)} \\times \\mathbf{H}^{(2)}) = i \\omega \\mathbf{H}^{(2)} \\cdot (\\boldsymbol{\\mu} \\mathbf{H}^{(1)}) - \\mathbf{E}^{(1)} \\cdot \\mathbf{J}^{(2)} + i \\omega \\mathbf{E}^{(1)} \\cdot (\\boldsymbol{\\epsilon} \\mathbf{E}^{(2)})\n$$\nSimilarly, for $\\nabla \\cdot (\\mathbf{E}^{(2)} \\times \\mathbf{H}^{(1)})$, using equations $(2a)$ and $(1b)$:\n$$\n\\nabla \\cdot (\\mathbf{E}^{(2)} \\times \\mathbf{H}^{(1)}) = \\mathbf{H}^{(1)} \\cdot (\\nabla \\times \\mathbf{E}^{(2)}) - \\mathbf{E}^{(2)} \\cdot (\\nabla \\times \\mathbf{H}^{(1)})\n$$\n$$\n\\nabla \\cdot (\\mathbf{E}^{(2)} \\times \\mathbf{H}^{(1)}) = \\mathbf{H}^{(1)} \\cdot (i \\omega \\boldsymbol{\\mu} \\mathbf{H}^{(2)}) - \\mathbf{E}^{(2)} \\cdot (\\mathbf{J}^{(1)} - i \\omega \\boldsymbol{\\epsilon} \\mathbf{E}^{(1)})\n$$\n$$\n\\nabla \\cdot (\\mathbf{E}^{(2)} \\times \\mathbf{H}^{(1)}) = i \\omega \\mathbf{H}^{(1)} \\cdot (\\boldsymbol{\\mu} \\mathbf{H}^{(2)}) - \\mathbf{E}^{(2)} \\cdot \\mathbf{J}^{(1)} + i \\omega \\mathbf{E}^{(2)} \\cdot (\\boldsymbol{\\epsilon} \\mathbf{E}^{(1)})\n$$\nSubtracting the two resulting expressions gives:\n$$\n\\nabla \\cdot (\\mathbf{E}^{(1)} \\times \\mathbf{H}^{(2)} - \\mathbf{E}^{(2)} \\times \\mathbf{H}^{(1)}) = \\mathbf{E}^{(2)} \\cdot \\mathbf{J}^{(1)} - \\mathbf{E}^{(1)} \\cdot \\mathbf{J}^{(2)} + i \\omega [\\mathbf{H}^{(2)} \\cdot (\\boldsymbol{\\mu} \\mathbf{H}^{(1)}) - \\mathbf{H}^{(1)} \\cdot (\\boldsymbol{\\mu} \\mathbf{H}^{(2)})] + i \\omega [\\mathbf{E}^{(1)} \\cdot (\\boldsymbol{\\epsilon} \\mathbf{E}^{(2)}) - \\mathbf{E}^{(2)} \\cdot (\\boldsymbol{\\epsilon} \\mathbf{E}^{(1)})]\n$$\nThe problem states that the material tensors are symmetric, i.e., $\\boldsymbol{\\epsilon} = \\boldsymbol{\\epsilon}^T$ and $\\boldsymbol{\\mu} = \\boldsymbol{\\mu}^T$. For any two vectors $\\mathbf{A}, \\mathbf{B}$ and a symmetric tensor $\\mathbf{T}$, we have $\\mathbf{A} \\cdot (\\mathbf{T} \\mathbf{B}) = \\mathbf{B} \\cdot (\\mathbf{T} \\mathbf{A})$. Therefore, the terms in the square brackets vanish:\n$$\n\\mathbf{H}^{(2)} \\cdot (\\boldsymbol{\\mu} \\mathbf{H}^{(1)}) - \\mathbf{H}^{(1)} \\cdot (\\boldsymbol{\\mu} \\mathbf{H}^{(2)}) = 0\n$$\n$$\n\\mathbf{E}^{(1)} \\cdot (\\boldsymbol{\\epsilon} \\mathbf{E}^{(2)}) - \\mathbf{E}^{(2)} \\cdot (\\boldsymbol{\\epsilon} \\mathbf{E}^{(1)}) = 0\n$$\nThis simplifies the differential relation to the following, known as the differential form of the Lorentz reciprocity theorem:\n$$\n\\nabla \\cdot (\\mathbf{E}^{(1)} \\times \\mathbf{H}^{(2)} - \\mathbf{E}^{(2)} \\times \\mathbf{H}^{(1)}) = \\mathbf{E}^{(2)} \\cdot \\mathbf{J}^{(1)} - \\mathbf{E}^{(1)} \\cdot \\mathbf{J}^{(2)}\n$$\nWe integrate this equation over all space, a volume $V$ bounded by a surface $S$ at infinity. Applying the divergence theorem:\n$$\n\\oint_{S} (\\mathbf{E}^{(1)} \\times \\mathbf{H}^{(2)} - \\mathbf{E}^{(2)} \\times \\mathbf{H}^{(1)}) \\cdot d\\mathbf{S} = \\int_{V} (\\mathbf{E}^{(2)} \\cdot \\mathbf{J}^{(1)} - \\mathbf{E}^{(1)} \\cdot \\mathbf{J}^{(2)}) \\, dV\n$$\nThe fields $(\\mathbf{E}^{(1)}, \\mathbf{H}^{(1)})$ and $(\\mathbf{E}^{(2)}, \\mathbf{H}^{(2)})$ are solutions to Maxwell's equations for localized sources and must satisfy the outgoing-wave (Silver-Müller) radiation condition at infinity. This condition ensures that the surface integral on the left-hand side vanishes as the surface $S$ recedes to infinity. Furthermore, at the planar interfaces within the stratified medium, the tangential components of $\\mathbf{E}$ and $\\mathbf{H}$ are continuous. This implies that the normal component of the vector field $\\mathbf{E}^{(1)} \\times \\mathbf{H}^{(2)} - \\mathbf{E}^{(2)} \\times \\mathbf{H}^{(1)}$ is also continuous across these interfaces, so no additional surface terms arise from the internal boundaries.\nWith the surface integral at infinity being zero, we obtain the integral form of the reciprocity theorem, also known as the reaction theorem:\n$$\n\\int_{V} \\mathbf{E}^{(2)} \\cdot \\mathbf{J}^{(1)} \\, dV = \\int_{V} \\mathbf{E}^{(1)} \\cdot \\mathbf{J}^{(2)} \\, dV\n$$\nNow, we apply this theorem to the specific point current sources defined in the problem:\n$$\n\\mathbf{J}^{(1)}(\\boldsymbol{\\rho}) = \\hat{\\mathbf{e}}_{j} \\, \\delta(\\boldsymbol{\\rho} - \\mathbf{r}')\n$$\n$$\n\\mathbf{J}^{(2)}(\\boldsymbol{\\rho}) = \\hat{\\mathbf{e}}_{i} \\, \\delta(\\boldsymbol{\\rho} - \\mathbf{r})\n$$\nwhere $\\boldsymbol{\\rho}$ is the integration variable.\nSubstituting these into the reaction theorem:\n$$\n\\int_{V} \\mathbf{E}^{(2)}(\\boldsymbol{\\rho}) \\cdot [ \\hat{\\mathbf{e}}_{j} \\, \\delta(\\boldsymbol{\\rho} - \\mathbf{r}') ] \\, dV_{\\boldsymbol{\\rho}} = \\int_{V} \\mathbf{E}^{(1)}(\\boldsymbol{\\rho}) \\cdot [ \\hat{\\mathbf{e}}_{i} \\, \\delta(\\boldsymbol{\\rho} - \\mathbf{r}) ] \\, dV_{\\boldsymbol{\\rho}}\n$$\nEvaluating the integrals using the sifting property of the Dirac delta distribution:\n$$\n\\mathbf{E}^{(2)}(\\mathbf{r}') \\cdot \\hat{\\mathbf{e}}_{j} = \\mathbf{E}^{(1)}(\\mathbf{r}) \\cdot \\hat{\\mathbf{e}}_{i}\n$$\nThis equation relates the field components. Let $E^{(2)}_j(\\mathbf{r}')$ be the $j$-th Cartesian component of the field $\\mathbf{E}^{(2)}$ at point $\\mathbf{r}'$, and $E^{(1)}_i(\\mathbf{r})$ be the $i$-th component of $\\mathbf{E}^{(1)}$ at $\\mathbf{r}$. The relation is:\n$$\nE^{(1)}_{i}(\\mathbf{r}) = E^{(2)}_{j}(\\mathbf{r}')\n$$\nNext, we relate these field components to the dyadic Green's function $\\mathbf{G}(\\mathbf{r}, \\mathbf{r}')$. The electric field is given by:\n$$\n\\mathbf{E}(\\mathbf{r}) = i \\omega \\int \\mathbf{G}(\\mathbf{r}, \\boldsymbol{\\rho}') \\cdot \\mathbf{J}(\\boldsymbol{\\rho}') \\, dV_{\\boldsymbol{\\rho}'}\n$$\nFor the first source, $\\mathbf{J}^{(1)}(\\boldsymbol{\\rho}') = \\hat{\\mathbf{e}}_{j} \\, \\delta(\\boldsymbol{\\rho}' - \\mathbf{r}')$, the field $\\mathbf{E}^{(1)}$ at point $\\mathbf{r}$ is:\n$$\n\\mathbf{E}^{(1)}(\\mathbf{r}) = i \\omega \\int \\mathbf{G}(\\mathbf{r}, \\boldsymbol{\\rho}') \\cdot [\\hat{\\mathbf{e}}_{j} \\, \\delta(\\boldsymbol{\\rho}' - \\mathbf{r}')] \\, dV_{\\boldsymbol{\\rho}'} = i \\omega \\, \\mathbf{G}(\\mathbf{r}, \\mathbf{r}') \\cdot \\hat{\\mathbf{e}}_{j}\n$$\nThe $i$-th component is obtained by dotting with $\\hat{\\mathbf{e}}_i$:\n$$\nE^{(1)}_{i}(\\mathbf{r}) = \\hat{\\mathbf{e}}_i \\cdot \\mathbf{E}^{(1)}(\\mathbf{r}) = i \\omega \\, \\hat{\\mathbf{e}}_i \\cdot (\\mathbf{G}(\\mathbf{r}, \\mathbf{r}') \\cdot \\hat{\\mathbf{e}}_{j}) = i \\omega \\, G_{ij}(\\mathbf{r}, \\mathbf{r}')\n$$\nFor the second source, $\\mathbf{J}^{(2)}(\\boldsymbol{\\rho}') = \\hat{\\mathbf{e}}_{i} \\, \\delta(\\boldsymbol{\\rho}' - \\mathbf{r})$, the field $\\mathbf{E}^{(2)}$ at point $\\mathbf{r}'$ is:\n$$\n\\mathbf{E}^{(2)}(\\mathbf{r}') = i \\omega \\int \\mathbf{G}(\\mathbf{r}', \\boldsymbol{\\rho}') \\cdot [\\hat{\\mathbf{e}}_{i} \\, \\delta(\\boldsymbol{\\rho}' - \\mathbf{r})] \\, dV_{\\boldsymbol{\\rho}'} = i \\omega \\, \\mathbf{G}(\\mathbf{r}', \\mathbf{r}) \\cdot \\hat{\\mathbf{e}}_{i}\n$$\nThe $j$-th component is obtained by dotting with $\\hat{\\mathbf{e}}_j$:\n$$\nE^{(2)}_{j}(\\mathbf{r}') = \\hat{\\mathbf{e}}_j \\cdot \\mathbf{E}^{(2)}(\\mathbf{r}') = i \\omega \\, \\hat{\\mathbf{e}}_j \\cdot (\\mathbf{G}(\\mathbf{r}', \\mathbf{r}) \\cdot \\hat{\\mathbf{e}}_{i}) = i \\omega \\, G_{ji}(\\mathbf{r}', \\mathbf{r})\n$$\nSubstituting these expressions for the field components into the reciprocity relation $E^{(1)}_{i}(\\mathbf{r}) = E^{(2)}_{j}(\\mathbf{r}')$:\n$$\ni \\omega \\, G_{ij}(\\mathbf{r}, \\mathbf{r}') = i \\omega \\, G_{ji}(\\mathbf{r}', \\mathbf{r})\n$$\nSince this must hold for non-zero frequency $\\omega \\neq 0$, we can divide by $i \\omega$ to obtain the reciprocity property for the dyadic Green's function:\n$$\nG_{ij}(\\mathbf{r}, \\mathbf{r}') = G_{ji}(\\mathbf{r}', \\mathbf{r})\n$$\nFinally, we compute the requested quantity $R_{ij}(\\mathbf{r}, \\mathbf{r}')$:\n$$\nR_{ij}(\\mathbf{r}, \\mathbf{r}') = G_{ij}(\\mathbf{r}, \\mathbf{r}') - G_{ji}(\\mathbf{r}', \\mathbf{r}) = G_{ji}(\\mathbf{r}', \\mathbf{r}) - G_{ji}(\\mathbf{r}', \\mathbf{r}) = 0\n$$\nThe reciprocity check quantity is identically zero due to the symmetry of the material tensors, which makes the medium reciprocal.",
            "answer": "$$\\boxed{0}$$"
        },
        {
            "introduction": "This final practice tests the robustness of the reciprocity theorem in a computationally intensive scenario. You will develop a finite-volume simulation for a medium that is simultaneously anisotropic, dispersive, and lossy, represented by a complex permittivity tensor $\\boldsymbol{\\epsilon}(\\omega)$. Numerically confirming that reciprocity holds even in such a complex environment will build your intuition and validate the power of this fundamental principle in practical engineering applications. ",
            "id": "3354270",
            "problem": "Consider frequency-domain computational electromagnetics with time dependence $e^{j\\omega t}$ in a two-dimensional rectangular domain discretized on a uniform Cartesian grid. You will verify Lorentz reciprocity for an electroquasistatic model with a lossy anisotropic dispersive slab. Use Maxwell's equations and the electroquasistatic limit as the fundamental base, and do not assume any specialized reciprocity formulas beyond the general statement derived from Maxwell's equations. The objective is to construct a symmetric discrete operator that represents $\\nabla \\cdot \\left(\\boldsymbol{\\epsilon}(\\omega)\\nabla \\phi\\right) = -\\rho$ with a complex symmetric permittivity tensor and to confirm numerically, for multiple scenarios, that the discrete Lorentz reciprocity identity\n$$\n\\int_{\\Omega} \\rho_1(\\mathbf{r}) \\,\\phi_2(\\mathbf{r})\\,dV \\;=\\; \\int_{\\Omega} \\rho_2(\\mathbf{r}) \\,\\phi_1(\\mathbf{r})\\,dV\n$$\nholds within numerical tolerance for passive dispersive media where $\\boldsymbol{\\epsilon}(\\omega)$ is complex and symmetric. The computations must be carried out entirely in the finite-volume-discretized electroquasistatic setting with Dirichlet boundary conditions that enforce $\\phi=0$ on the outer boundary of the computational domain. The existence and uniqueness of the discrete solution are ensured by these boundary conditions and the passive, strictly dissipative or lossless nature of the materials.\n\nFundamental base and modeling assumptions:\n- Start from frequency-domain Maxwell's equations with time dependence $e^{j\\omega t}$:\n  - $\\nabla \\times \\mathbf{E} = -j\\omega \\mu_0 \\mathbf{H}$,\n  - $\\nabla \\times \\mathbf{H} = \\mathbf{J} + j\\omega \\boldsymbol{\\epsilon}(\\omega)\\mathbf{E}$,\n  - $\\nabla \\cdot \\left(\\boldsymbol{\\epsilon}(\\omega)\\mathbf{E}\\right) = \\rho$,\n  - $\\nabla \\cdot \\mathbf{B} = 0$,\n  and the constitutive relations $\\mathbf{D} = \\boldsymbol{\\epsilon}(\\omega)\\mathbf{E}$, $\\mathbf{B} = \\mu_0 \\mathbf{H}$. In the electroquasistatic limit, model $\\mathbf{E} = -\\nabla \\phi$ and solve $\\nabla \\cdot \\left(\\boldsymbol{\\epsilon}(\\omega)\\nabla \\phi\\right) = -\\rho$.\n- Use a rectangular domain of $N_x\\times N_y$ nodes, uniform spacing $h$ in both directions, and enforce Dirichlet boundary conditions $\\phi=0$ on the domain boundary. Assemble a finite-volume operator with fluxes across faces computed using harmonic averaging to preserve symmetry.\n- Model the slab as a horizontal band with an anisotropic diagonal permittivity tensor $\\boldsymbol{\\epsilon}(\\omega) = \\mathrm{diag}\\left(\\epsilon_x(\\omega), \\epsilon_y(\\omega)\\right)$; outside the slab, use vacuum with $\\epsilon_0$. Inside the slab, use Debye-type dispersive models with added conduction:\n  $$\n  \\epsilon_k(\\omega) = \\epsilon_{\\infty,k} + \\frac{\\epsilon_{s,k} - \\epsilon_{\\infty,k}}{1 + j\\omega \\tau_k} + \\frac{\\sigma_k}{j\\omega}, \\quad k\\in\\{x,y\\}.\n  $$\n  Passivity requires nonnegative dissipated power; with the $e^{j\\omega t}$ convention, this is captured by the $\\sigma_k/(j\\omega)$ term and the Debye term with $\\tau_k>0$ and $\\epsilon_{s,k}\\ge \\epsilon_{\\infty,k}$.\n- Excite the system with two compactly supported impressed electric charge dipoles $\\rho_1$ and $\\rho_2$, each implemented as a pair of equal and opposite point charges of magnitude $q$ separated by one grid spacing along a specified coordinate axis, located at specified grid nodes. The discrete total charge per cell $Q\\,[\\mathrm{C}]$ serves as the source on the right-hand side of the cell-integrated equation; the discrete reciprocity identity to verify is\n  $$\n  I_1 \\equiv \\sum_{\\text{cells}} Q_1 \\,\\phi_2 \\;\\stackrel{?}{=}\\; \\sum_{\\text{cells}} Q_2 \\,\\phi_1 \\equiv I_2.\n  $$\n- Use the uniqueness theorem for the boundary-value problem with Dirichlet boundary conditions to justify solving for $\\phi$ uniquely for each source.\n\nDiscretization requirements:\n- Use a finite-volume discretization on a uniform grid with spacing $h$ so that the discrete balance for each interior cell $C$ reads\n  $$\n  \\epsilon_{x,e}(\\phi_E - \\phi_C) - \\epsilon_{x,w}(\\phi_C - \\phi_W) + \\epsilon_{y,n}(\\phi_N - \\phi_C) - \\epsilon_{y,s}(\\phi_C - \\phi_S) = -Q_C,\n  $$\n  where $\\epsilon_{x,e}$ is the effective permittivity at the east face (use harmonic averaging of $\\epsilon_x$ from the two neighboring cells), and similarly for the other faces. For Dirichlet boundary neighbors, treat $\\phi=0$ and include the corresponding face coefficient only in the diagonal of the interior cell. This construction yields a complex-symmetric system matrix for symmetric $\\boldsymbol{\\epsilon}(\\omega)$.\n- Represent the dipoles as discrete charges $+q$ and $-q$ assigned to neighboring interior cells, with zero net charge per dipole.\n\nPhysical and numerical units:\n- Use the International System of Units (SI). The vacuum permittivity is $\\epsilon_0 = 8.8541878128\\times 10^{-12}\\,\\mathrm{F/m}$. The grid spacing is $h=10^{-3}\\,\\mathrm{m}$.\n\nTest suite and parameter specifications:\n- Global domain settings: $N_x=40$, $N_y=40$, $h=10^{-3}\\,\\mathrm{m}$. Slab occupies rows $j_1=14$ through $j_2=26$ inclusive (counting from $0$ at the bottom row to $N_y-1$ at the top). Charge magnitude $q=10^{-9}\\,\\mathrm{C}$ for all dipoles. Ensure dipole centers are at least one cell away from the boundary so that both charges lie on interior cells.\n- Material models:\n  - Anisotropic dispersive slab A: $\\epsilon_{\\infty,x} = 2\\,\\epsilon_0$, $\\epsilon_{s,x} = 8\\,\\epsilon_0$, $\\tau_x = 1\\times 10^{-10}\\,\\mathrm{s}$, $\\sigma_x = 0.5\\,\\mathrm{S/m}$; $\\epsilon_{\\infty,y} = 3\\,\\epsilon_0$, $\\epsilon_{s,y} = 6\\,\\epsilon_0$, $\\tau_y = 5\\times 10^{-11}\\,\\mathrm{s}$, $\\sigma_y = 0.2\\,\\mathrm{S/m}$.\n  - Isotropic lossless slab B: $\\epsilon_{\\infty,x} = \\epsilon_{\\infty,y} = 4\\,\\epsilon_0$, $\\epsilon_{s,x} = \\epsilon_{s,y} = 4\\,\\epsilon_0$, $\\sigma_x = \\sigma_y = 0$, with any $\\tau$ (irrelevant because $\\epsilon_s=\\epsilon_{\\infty}$).\n- Frequencies:\n  - $\\omega_1 = 2\\pi \\cdot 5\\times 10^{9}\\,\\mathrm{rad/s}$,\n  - $\\omega_2 = 2\\pi \\cdot 5\\times 10^{7}\\,\\mathrm{rad/s}$,\n  - $\\omega_3 = 2\\pi \\cdot 3\\times 10^{10}\\,\\mathrm{rad/s}$.\n- Dipole locations and orientations:\n  - Case $1$ (general anisotropic-dispersive, moderate frequency): material A at $\\omega_1$; dipole $\\rho_1$ centered at $(i,j)=(8,10)$, oriented along $x$; dipole $\\rho_2$ centered at $(i,j)=(30,29)$, oriented along $y$.\n  - Case $2$ (low frequency, strong dispersion/conductive loss): material A at $\\omega_2$; the same dipole placements as Case $1$.\n  - Case $3$ (isotropic, lossless check): material B at $\\omega_1$; dipole $\\rho_1$ centered at $(i,j)=(12,20)$, oriented along $x$; dipole $\\rho_2$ centered at $(i,j)=(28,20)$, oriented along $y$.\n  - Case $4$ (near-interface edge case): material A at $\\omega_3$; slab interface is near $j=14$; dipole $\\rho_1$ centered at $(i,j)=(20,13)$, oriented along $x$; dipole $\\rho_2$ centered at $(i,j)=(22,27)$, oriented along $y$.\n- For each case, compute $\\phi_1$ for $\\rho_1$ and $\\phi_2$ for $\\rho_2$, then evaluate the discrete reciprocity integrals $I_1 = \\sum Q_1 \\phi_2$ and $I_2 = \\sum Q_2 \\phi_1$. Report a dimensionless reciprocity error for each case defined as\n  $$\n  \\mathrm{err} \\;=\\; \\frac{\\left| I_1 - I_2 \\right|}{\\max\\left(\\left|I_1\\right|, \\left|I_2\\right|, \\varepsilon\\right)} \\quad \\text{with} \\quad \\varepsilon=10^{-30}.\n  $$\n\nProgram requirements:\n- Your program must assemble the complex-symmetric finite-volume matrix for the operator $\\nabla \\cdot \\left(\\boldsymbol{\\epsilon}(\\omega)\\nabla \\phi\\right)$ using harmonic averaging of face coefficients, solve the two linear systems for $\\phi_1$ and $\\phi_2$ per case using sparse direct methods, and compute the four reciprocity errors for the test suite above.\n- Final output format: Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[r1,r2,r3,r4]\") where each $r_k$ is the reciprocity error for case $k$ as a floating-point number with full machine precision. No additional text should be printed.",
            "solution": "The problem requires the numerical verification of the Lorentz reciprocity theorem within a two-dimensional electroquasistatic (EQS) framework. The system involves a lossy, anisotropic, and dispersive dielectric slab. The verification will be conducted by simulating two distinct dipole sources and their corresponding potential fields, and then evaluating the reciprocity identity. The entire formulation must be grounded in Maxwell's equations and discretized using a finite-volume method that preserves the symmetry of the underlying physical operator.\n\n**1. Theoretical Foundation of Reciprocity**\n\nThe Lorentz reciprocity theorem is a fundamental principle derived from Maxwell's equations. For two sets of time-harmonic sources $(\\mathbf{J}_1, \\rho_1)$ and $(\\mathbf{J}_2, \\rho_2)$ at frequency $\\omega$ in a linear medium with symmetric constitutive tensors ($\\boldsymbol{\\epsilon}^T = \\boldsymbol{\\epsilon}$, $\\boldsymbol{\\mu}^T = \\boldsymbol{\\mu}$), the theorem holds. In this non-magnetic, electroquasistatic case, the governing equation for the electric potential $\\phi$ is $\\nabla \\cdot \\left(\\boldsymbol{\\epsilon}(\\omega)\\nabla\\phi\\right) = -\\rho$.\nFollowing a standard derivation involving integration by parts and applying the divergence theorem, one can show that if the permittivity tensor $\\boldsymbol{\\epsilon}$ is symmetric, the following integral identity holds:\n$$\n\\int_{\\Omega} \\rho_1 \\phi_2 dV = \\int_{\\Omega} \\rho_2 \\phi_1 dV\n$$\nThis assumes that the boundary terms from the integration by parts vanish, which is ensured here by the homogeneous Dirichlet boundary conditions ($\\phi=0$) on the domain's outer boundary. The problem specifies a diagonal permittivity tensor, which is inherently symmetric, so the continuous reciprocity identity is expected to hold.\n\n**2. Finite-Volume Discretization**\n\nThe problem is discretized on a uniform Cartesian grid. Integrating the governing equation over a control volume (cell) $C_{i,j}$ and applying the divergence theorem yields the balance equation: the sum of fluxes out of the cell equals the negative of the total charge within it.\n$$\n\\oint_{\\partial C_{i,j}} (\\boldsymbol{\\epsilon}\\nabla\\phi) \\cdot \\hat{\\mathbf{n}} dS = -Q_{i,j}\n$$\nThe flux through each of the four faces of the cell is approximated. For example, the flux through the east face is approximated as $F_e = \\epsilon_{x,e}(\\phi_{E}-\\phi_C)$, where $\\phi_C$ and $\\phi_E$ are potentials at the centers of the cell and its eastern neighbor. To ensure the resulting system matrix is symmetric, the face permittivity $\\epsilon_{x,e}$ must be calculated consistently from both sides. Harmonic averaging is used for this purpose:\n$$\n\\epsilon_{x,e} = \\frac{2\\epsilon_{x, C}\\epsilon_{x, E}}{\\epsilon_{x, C} + \\epsilon_{x, E}}\n$$\nThis formulation leads to a set of linear equations $A\\boldsymbol{\\phi} = \\mathbf{b}$, where $\\boldsymbol{\\phi}$ is the vector of unknown potentials at interior nodes and $\\mathbf{b} = -\\mathbf{Q}$ is the source vector. The construction with harmonic averaging guarantees that the system matrix $A$ is complex-symmetric ($A=A^T$).\n\n**3. Numerical Verification of Reciprocity**\n\nThe symmetry of the discrete operator $A$ directly implies the discrete form of the reciprocity theorem. Let two source vectors $\\mathbf{Q}_1$ and $\\mathbf{Q}_2$ generate potential vectors $\\boldsymbol{\\phi}_1$ and $\\boldsymbol{\\phi}_2$. The solutions are $\\boldsymbol{\\phi}_1 = A^{-1}(-\\mathbf{Q}_1)$ and $\\boldsymbol{\\phi}_2 = A^{-1}(-\\mathbf{Q}_2)$. The discrete reciprocity integrals are scalar products $I_1 = \\mathbf{Q}_1^T \\boldsymbol{\\phi}_2$ and $I_2 = \\mathbf{Q}_2^T \\boldsymbol{\\phi}_1$.\nSubstituting the expressions for the potentials:\n$$\nI_1 = \\mathbf{Q}_1^T (-A^{-1}\\mathbf{Q}_2) = -\\mathbf{Q}_1^T A^{-1}\\mathbf{Q}_2\n$$\n$$\nI_2 = \\mathbf{Q}_2^T (-A^{-1}\\mathbf{Q}_1) = -\\mathbf{Q}_2^T A^{-1}\\mathbf{Q}_1\n$$\nSince $I_2$ is a scalar, it equals its transpose: $I_2 = -(\\mathbf{Q}_2^T A^{-1}\\mathbf{Q}_1)^T = -\\mathbf{Q}_1^T (A^{-1})^T \\mathbf{Q}_2$. For reciprocity ($I_1 = I_2$) to hold, we require $A^{-1} = (A^{-1})^T$, which is true because $A = A^T$.\nThe numerical experiment serves to confirm that the finite-volume implementation correctly assembles a symmetric matrix. Any deviation from $I_1=I_2$ should be attributable only to floating-point precision errors.\n\n**4. Implementation Strategy**\n\nThe numerical procedure for each test case is as follows:\n1.  Define grid parameters, material properties, and excitation frequency $\\omega$.\n2.  Construct the complex permittivity grids, $\\epsilon_x(i,j)$ and $\\epsilon_y(i,j)$, based on the slab geometry and the Debye model for the given $\\omega$.\n3.  Assemble the complex-symmetric sparse matrix $A$ for all interior grid nodes using the 5-point finite-volume stencil with harmonic averaging for face permittivities.\n4.  For each of the two dipoles, define the charge distribution $\\mathbf{Q}$ and construct the source vector $\\mathbf{b} = -\\mathbf{Q}$.\n5.  Solve the two linear systems $A\\boldsymbol{\\phi}_1 = \\mathbf{b}_1$ and $A\\boldsymbol{\\phi}_2 = \\mathbf{b}_2$ using a sparse direct solver to obtain the potential vectors $\\boldsymbol{\\phi}_1$ and $\\boldsymbol{\\phi}_2$.\n6.  Calculate the reciprocity integrals $I_1 = \\mathbf{Q}_1^T\\boldsymbol{\\phi}_2$ and $I_2 = \\mathbf{Q}_2^T\\boldsymbol{\\phi}_1$.\n7.  Compute the relative reciprocity error using the specified formula.\n\nThis process is repeated for each of the four test cases, and the final list of errors is reported.",
            "answer": "```python\nimport numpy as np\nfrom scipy.sparse import lil_matrix, csc_matrix\nfrom scipy.sparse.linalg import spsolve\n\ndef solve():\n    \"\"\"\n    Verifies Lorentz reciprocity for a 2D electroquasistatic system\n    with an anisotropic, dispersive, and lossy slab.\n    \"\"\"\n    \n    # Physical and numerical constants\n    e0 = 8.8541878128e-12  # Vacuum permittivity in F/m\n    \n    # Global domain settings\n    Nx, Ny = 40, 40\n    h = 1e-3  # Grid spacing in m\n    slab_j1, slab_j2 = 14, 26\n    q_mag = 1e-9  # Charge magnitude for dipoles in C\n    err_eps = 1e-30 # Small number for error denominator\n    \n    # Test case definitions\n    # (material_params, omega, dipole1_info, dipole2_info)\n    \n    # Material A model\n    mat_A = {\n        'eps_inf_x': 2 * e0, 'eps_s_x': 8 * e0, 'tau_x': 1e-10, 'sigma_x': 0.5,\n        'eps_inf_y': 3 * e0, 'eps_s_y': 6 * e0, 'tau_y': 5e-11, 'sigma_y': 0.2\n    }\n    \n    # Material B model (isotropic, lossless)\n    mat_B = {\n        'eps_inf_x': 4 * e0, 'eps_s_x': 4 * e0, 'tau_x': 1e-10, 'sigma_x': 0.0,\n        'eps_inf_y': 4 * e0, 'eps_s_y': 4 * e0, 'tau_y': 1e-10, 'sigma_y': 0.0\n    }\n    \n    # Frequencies\n    w1 = 2 * np.pi * 5e9\n    w2 = 2 * np.pi * 5e7\n    w3 = 2 * np.pi * 3e10\n    \n    test_cases = [\n        (mat_A, w1, {'center': (8, 10), 'orient': 'x'}, {'center': (30, 29), 'orient': 'y'}),\n        (mat_A, w2, {'center': (8, 10), 'orient': 'x'}, {'center': (30, 29), 'orient': 'y'}),\n        (mat_B, w1, {'center': (12, 20), 'orient': 'x'}, {'center': (28, 20), 'orient': 'y'}),\n        (mat_A, w3, {'center': (20, 13), 'orient': 'x'}, {'center': (22, 27), 'orient': 'y'})\n    ]\n\n    results = []\n\n    def get_permittivity(mat_params, w):\n        \"\"\"Calculates complex permittivity for a given material and frequency.\"\"\"\n        eps = {}\n        for k in ['x', 'y']:\n            eps_inf = mat_params[f'eps_inf_{k}']\n            eps_s = mat_params[f'eps_s_{k}']\n            tau = mat_params[f'tau_{k}']\n            sigma = mat_params[f'sigma_{k}']\n            \n            # Debye + conductivity model\n            eps[k] = eps_inf + (eps_s - eps_inf) / (1 + 1j * w * tau) + sigma / (1j * w)\n        return eps['x'], eps['y']\n\n    for case_num, (mat_params, w, d1_info, d2_info) in enumerate(test_cases):\n        \n        # 1. Construct permittivity grid\n        eps_x = np.full((Nx, Ny), e0, dtype=complex)\n        eps_y = np.full((Nx, Ny), e0, dtype=complex)\n        \n        slab_eps_x, slab_eps_y = get_permittivity(mat_params, w)\n        \n        eps_x[:, slab_j1:slab_j2 + 1] = slab_eps_x\n        eps_y[:, slab_j1:slab_j2 + 1] = slab_eps_y\n        \n        # 2. Assemble system matrix A\n        num_unknowns = (Nx - 2) * (Ny - 2)\n        A = lil_matrix((num_unknowns, num_unknowns), dtype=complex)\n        \n        # Map 2D interior grid (i, j) to 1D vector index k\n        def to_k(i, j):\n            return (j - 1) * (Nx - 2) + (i - 1)\n\n        for j in range(1, Ny - 1):      # Iterate over interior rows\n            for i in range(1, Nx - 1):  # Iterate over interior columns\n                \n                k = to_k(i, j)\n                \n                # West face\n                eps_x_w_val = (2 * eps_x[i-1, j] * eps_x[i, j]) / (eps_x[i-1, j] + eps_x[i, j])\n                \n                # East face\n                eps_x_e_val = (2 * eps_x[i, j] * eps_x[i+1, j]) / (eps_x[i, j] + eps_x[i+1, j])\n                \n                # South face\n                eps_y_s_val = (2 * eps_y[i, j-1] * eps_y[i, j]) / (eps_y[i, j-1] + eps_y[i, j])\n                \n                # North face\n                eps_y_n_val = (2 * eps_y[i, j] * eps_y[i, j+1]) / (eps_y[i, j] + eps_y[i, j+1])\n\n                # Diagonal term\n                A[k, k] = -(eps_x_w_val + eps_x_e_val + eps_y_s_val + eps_y_n_val)\n                \n                # Off-diagonal terms\n                if i > 1:      A[k, to_k(i-1, j)] = eps_x_w_val  # West neighbor\n                if i  Nx - 2: A[k, to_k(i+1, j)] = eps_x_e_val  # East neighbor\n                if j > 1:      A[k, to_k(i, j-1)] = eps_y_s_val  # South neighbor\n                if j  Ny - 2: A[k, to_k(i, j+1)] = eps_y_n_val  # North neighbor\n\n        A = A.tocsc()\n        \n        # 3. Create source vectors\n        def create_source_vector(dipole_info):\n            Q = np.zeros((Nx, Ny), dtype=complex)\n            i, j = dipole_info['center']\n            \n            if dipole_info['orient'] == 'x':\n                i1, j1 = i, j\n                i2, j2 = i + 1, j\n            else: # 'y'\n                i1, j1 = i, j\n                i2, j2 = i, j + 1\n            \n            Q[i1, j1] = -q_mag\n            Q[i2, j2] = +q_mag\n            \n            # Map Q grid to 1D source vector b = -Q\n            b = np.zeros(num_unknowns, dtype=complex)\n            for j_s in range(1, Ny - 1):\n                for i_s in range(1, Nx - 1):\n                    if Q[i_s, j_s] != 0:\n                        b[to_k(i_s, j_s)] = -Q[i_s, j_s]\n            \n            return Q, b\n            \n        Q1_grid, b1 = create_source_vector(d1_info)\n        Q2_grid, b2 = create_source_vector(d2_info)\n        \n        # 4. Solve linear systems\n        phi1_vec = spsolve(A, b1)\n        phi2_vec = spsolve(A, b2)\n\n        # 5. Calculate reciprocity integrals and error\n        I1 = 0.0\n        I2 = 0.0\n        \n        # Use source vectors directly for calculation\n        # I1 = sum(Q1 * phi2) = -b1.T @ phi2\n        # I2 = sum(Q2 * phi1) = -b2.T @ phi1\n        # The transpose is just a regular transpose, not conjugate transpose\n        \n        I1 = -np.dot(b1, phi2_vec)\n        I2 = -np.dot(b2, phi1_vec)\n        \n        error = abs(I1 - I2) / max(abs(I1), abs(I2), err_eps)\n        results.append(error)\n        \n    # Final output\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```"
        }
    ]
}