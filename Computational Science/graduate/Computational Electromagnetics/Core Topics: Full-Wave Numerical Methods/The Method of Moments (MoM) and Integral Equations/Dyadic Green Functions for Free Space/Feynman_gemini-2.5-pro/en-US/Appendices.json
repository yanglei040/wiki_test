{
    "hands_on_practices": [
        {
            "introduction": "The dyadic Green's function provides a complete description of how an electromagnetic field propagates from a source to an observation point. This first practice grounds this abstract mathematical object in a tangible physical context by connecting it to one of the most fundamental radiators in electromagnetics. We will apply the far-field asymptotic form of the free-space dyadic Green's function to derive the fields and radiated power from an oscillating electric dipole, reinforcing the interpretation of the Green's function as the system's impulse response. This exercise bridges the gap between the formal definition of the dyadic Green's function and its practical use in calculating observable quantities like radiation patterns.",
            "id": "3303047",
            "problem": "An oscillating point electric dipole with complex phasor dipole moment amplitude $\\mathbf{p}_{0} = p_{0}\\,\\hat{\\mathbf{z}}$ is located at the origin of homogeneous free space with permittivity $\\varepsilon_{0}$ and permeability $\\mu_{0}$. Assume the time dependence $\\exp(-i \\omega t)$, define the free-space wavenumber $k = \\omega \\sqrt{\\mu_{0}\\varepsilon_{0}}$, and denote the free-space wave impedance by $\\eta_{0} = \\sqrt{\\mu_{0}/\\varepsilon_{0}}$ and the speed of light by $c = 1/\\sqrt{\\mu_{0}\\varepsilon_{0}}$. Let the electric dyadic Green’s function in free space be the tensor $\\mathbf{G}^{E}(\\mathbf{r},\\mathbf{r}')$ that solves the vector Helmholtz equation in the sense that for any impressed electric current density $\\mathbf{J}(\\mathbf{r}')$, the radiated electric field satisfies\n$$\n\\nabla \\times \\nabla \\times \\mathbf{E}(\\mathbf{r}) - k^{2}\\mathbf{E}(\\mathbf{r}) = i \\omega \\mu_{0} \\mathbf{J}(\\mathbf{r}), \\quad \\mathbf{E}(\\mathbf{r}) = i \\omega \\mu_{0} \\int \\mathbf{G}^{E}(\\mathbf{r},\\mathbf{r}') \\cdot \\mathbf{J}(\\mathbf{r}') \\, dV'.\n$$\nTreat the oscillating electric dipole as a point source with equivalent current density $\\mathbf{J}(\\mathbf{r}) = -i \\omega \\mathbf{p}_{0}\\,\\delta(\\mathbf{r})$. Using only the frequency-domain Maxwell equations, the definition of the dyadic Green’s function for free space, its far-field asymptotic form, and the time-average version of Poynting’s theorem, do the following:\n\n1. Derive the far-field electric and magnetic fields radiated by the dipole, as functions of the observation direction $\\hat{\\mathbf{r}}$ and the polar angle $\\theta$ measured from the $+\\hat{\\mathbf{z}}$ axis.\n\n2. From these fields, derive the time-averaged radiated power per unit solid angle and identify the normalized angular radiation pattern $F(\\theta)$, defined to be dimensionless and normalized so that $\\max_{\\theta} F(\\theta) = 1$.\n\n3. Integrate over all solid angles to obtain the total time-averaged radiated power $P_{\\text{rad}}$.\n\nAnswer format requirements:\n- Provide your final answer as a pair consisting of:\n  - The normalized angular radiation pattern $F(\\theta)$ expressed purely as a function of $\\theta$.\n  - The total time-averaged radiated power $P_{\\text{rad}}$ expressed symbolically in terms of $\\omega$, $|p_{0}|$, $\\varepsilon_{0}$, and $c$.\n- Express $P_{\\text{rad}}$ in watts in the International System of Units (SI).\n- Provide the two answers inside a single row matrix as the final boxed answer.\n- No numerical evaluation or rounding is required.",
            "solution": "The problem statement is scientifically grounded, self-contained, and well-posed. It describes a canonical problem in electromagnetic theory—radiation from a point electric dipole—using standard definitions and equations. The problem is therefore deemed valid.\n\nThe electric field $\\mathbf{E}(\\mathbf{r})$ radiated by an impressed current density $\\mathbf{J}(\\mathbf{r}')$ is given by the integral relation involving the electric dyadic Green's function $\\mathbf{G}^{E}(\\mathbf{r},\\mathbf{r}')$:\n$$\n\\mathbf{E}(\\mathbf{r}) = i \\omega \\mu_{0} \\int \\mathbf{G}^{E}(\\mathbf{r},\\mathbf{r}') \\cdot \\mathbf{J}(\\mathbf{r}') \\, dV'\n$$\nThe point electric dipole at the origin is represented by the equivalent current density $\\mathbf{J}(\\mathbf{r}') = -i \\omega \\mathbf{p}_{0}\\,\\delta(\\mathbf{r}')$, where $\\mathbf{p}_{0} = p_{0}\\,\\hat{\\mathbf{z}}$ and $\\delta(\\mathbf{r}')$ is the three-dimensional Dirac delta function.\n\nSubstituting the current density into the integral for $\\mathbf{E}(\\mathbf{r})$ gives:\n$$\n\\mathbf{E}(\\mathbf{r}) = i \\omega \\mu_{0} \\int \\mathbf{G}^{E}(\\mathbf{r},\\mathbf{r}') \\cdot (-i \\omega \\mathbf{p}_{0}\\,\\delta(\\mathbf{r}')) \\, dV'\n$$\nUsing the sifting property of the Dirac delta function, which states that $\\int f(\\mathbf{x}')\\delta(\\mathbf{x}')d\\mathbf{x}'=f(\\mathbf{0})$, we can evaluate the integral at $\\mathbf{r}'=\\mathbf{0}$:\n$$\n\\mathbf{E}(\\mathbf{r}) = (i \\omega)(-i \\omega) \\mu_{0} \\mathbf{G}^{E}(\\mathbf{r},\\mathbf{0}) \\cdot \\mathbf{p}_{0} = \\omega^{2} \\mu_{0} \\mathbf{G}^{E}(\\mathbf{r},\\mathbf{0}) \\cdot \\mathbf{p}_{0}\n$$\nThe problem requires the far-field solution. The far-field asymptotic form of the free-space dyadic Green's function $\\mathbf{G}^{E}(\\mathbf{r},\\mathbf{r}')$ for a source at $\\mathbf{r}'=\\mathbf{0}$ is\n$$\n\\mathbf{G}^{E}(\\mathbf{r},\\mathbf{0}) \\approx (\\mathbf{I} - \\hat{\\mathbf{r}}\\hat{\\mathbf{r}}) \\frac{\\exp(ik|\\mathbf{r}|)}{4\\pi|\\mathbf{r}|} \\quad \\text{as } |\\mathbf{r}| \\to \\infty\n$$\nwhere $\\mathbf{I}$ is the identity dyad, $\\hat{\\mathbf{r}}=\\mathbf{r}/|\\mathbf{r}|$ is the radial unit vector, and $r=|\\mathbf{r}|$. The term $\\hat{\\mathbf{r}}\\hat{\\mathbf{r}}$ represents a dyadic product.\n\nSubstituting this asymptotic form into the expression for $\\mathbf{E}(\\mathbf{r})$ yields the far-field electric field:\n$$\n\\mathbf{E}(\\mathbf{r}) \\approx \\omega^{2} \\mu_{0} \\left[ (\\mathbf{I} - \\hat{\\mathbf{r}}\\hat{\\mathbf{r}}) \\frac{\\exp(ikr)}{4\\pi r} \\right] \\cdot \\mathbf{p}_{0}\n$$\nThe term $(\\mathbf{I} - \\hat{\\mathbf{r}}\\hat{\\mathbf{r}}) \\cdot \\mathbf{p}_{0}$ projects the dipole moment vector $\\mathbf{p}_{0}$ onto the plane perpendicular to the observation direction $\\hat{\\mathbf{r}}$. We are given $\\mathbf{p}_{0} = p_{0}\\hat{\\mathbf{z}}$. In spherical coordinates, $\\hat{\\mathbf{z}} = \\cos\\theta\\,\\hat{\\mathbf{r}} - \\sin\\theta\\,\\hat{\\boldsymbol{\\theta}}$, and the dot product with $\\hat{\\mathbf{r}}$ is $\\hat{\\mathbf{r}} \\cdot \\hat{\\mathbf{z}} = \\cos\\theta$.\nThus, the projection is:\n$$\n(\\mathbf{I} - \\hat{\\mathbf{r}}\\hat{\\mathbf{r}}) \\cdot \\mathbf{p}_{0} = \\mathbf{p}_{0} - \\hat{\\mathbf{r}}(\\hat{\\mathbf{r}} \\cdot \\mathbf{p}_{0}) = p_{0}\\hat{\\mathbf{z}} - \\hat{\\mathbf{r}}(p_{0}\\cos\\theta) = p_{0}(\\hat{\\mathbf{z}} - \\hat{\\mathbf{r}}\\cos\\theta)\n$$\nSubstituting the spherical representation of $\\hat{\\mathbf{z}}$:\n$$\np_{0}((\\cos\\theta\\,\\hat{\\mathbf{r}} - \\sin\\theta\\,\\hat{\\boldsymbol{\\theta}}) - \\hat{\\mathbf{r}}\\cos\\theta) = -p_{0}\\sin\\theta\\,\\hat{\\boldsymbol{\\theta}}\n$$\nInserting this result back into the expression for $\\mathbf{E}(\\mathbf{r})$:\n$$\n\\mathbf{E}(\\mathbf{r}) \\approx \\omega^{2} \\mu_{0} \\frac{\\exp(ikr)}{4\\pi r} (-p_{0}\\sin\\theta\\,\\hat{\\boldsymbol{\\theta}}) = -\\frac{\\omega^{2} \\mu_{0} p_{0} \\sin\\theta}{4\\pi r} \\exp(ikr) \\hat{\\boldsymbol{\\theta}}\n$$\nUsing the relations $k = \\omega\\sqrt{\\mu_0\\varepsilon_0}$ and $c=1/\\sqrt{\\mu_0\\varepsilon_0}$, we can write $\\omega^2\\mu_0 = k^2c^2\\mu_0 = k^2/ \\varepsilon_0$. The electric field is then:\n$$\n\\mathbf{E}(\\mathbf{r}) \\approx -\\frac{k^{2} p_{0}}{4\\pi\\varepsilon_{0}} \\frac{\\exp(ikr)}{r} \\sin\\theta\\,\\hat{\\boldsymbol{\\theta}}\n$$\nThis is the far-field electric field, which completes the first part of Task 1.\n\nFor the second part of Task 1, we find the far-field magnetic field $\\mathbf{H}(\\mathbf{r})$. In the far field, the radiated fields locally resemble a transverse electromagnetic (TEM) plane wave, for which the magnetic field is related to the electric field by $\\mathbf{H} = \\frac{1}{\\eta_{0}} \\hat{\\mathbf{r}} \\times \\mathbf{E}$, where $\\eta_{0} = \\sqrt{\\mu_{0}/\\varepsilon_{0}}$ is the free-space impedance.\n$$\n\\mathbf{H}(\\mathbf{r}) \\approx \\frac{1}{\\eta_{0}} \\hat{\\mathbf{r}} \\times \\left( -\\frac{k^{2} p_{0}}{4\\pi\\varepsilon_{0}} \\frac{\\exp(ikr)}{r} \\sin\\theta\\,\\hat{\\boldsymbol{\\theta}} \\right)\n$$\nUsing the cross product $\\hat{\\mathbf{r}} \\times \\hat{\\boldsymbol{\\theta}} = \\hat{\\boldsymbol{\\phi}}$:\n$$\n\\mathbf{H}(\\mathbf{r}) \\approx -\\frac{k^{2} p_{0}}{4\\pi\\eta_{0}\\varepsilon_{0}} \\frac{\\exp(ikr)}{r} \\sin\\theta\\,\\hat{\\boldsymbol{\\phi}}\n$$\nThe constant group can be simplified using $\\eta_0\\varepsilon_0 = \\sqrt{\\mu_0/\\varepsilon_0}\\varepsilon_0 = \\sqrt{\\mu_0\\varepsilon_0} = 1/c$.\nSo, $\\frac{k^2}{\\eta_0\\varepsilon_0} = k^2 c = k(\\omega)$.\n$$\n\\mathbf{H}(\\mathbf{r}) \\approx -\\frac{k\\omega p_{0}}{4\\pi} \\frac{\\exp(ikr)}{r} \\sin\\theta\\,\\hat{\\boldsymbol{\\phi}}\n$$\nThe expressions for $\\mathbf{E}(\\mathbf{r})$ and $\\mathbf{H}(\\mathbf{r})$ complete Task 1.\n\nFor Task 2, we derive the time-averaged radiated power per unit solid angle. This is obtained from the radial component of the time-averaged Poynting vector, $\\langle\\mathbf{S}\\rangle = \\frac{1}{2}\\text{Re}\\{\\mathbf{E} \\times \\mathbf{H}^*\\}$.\n$$\n\\mathbf{H}^*(\\mathbf{r}) \\approx -\\frac{k\\omega p_{0}^*}{4\\pi} \\frac{\\exp(-ikr)}{r} \\sin\\theta\\,\\hat{\\boldsymbol{\\phi}}\n$$\n$$\n\\mathbf{E} \\times \\mathbf{H}^* \\approx \\left( -\\frac{k^{2} p_{0}}{4\\pi\\varepsilon_{0}} \\frac{\\exp(ikr)}{r} \\sin\\theta\\,\\hat{\\boldsymbol{\\theta}} \\right) \\times \\left( -\\frac{k\\omega p_{0}^*}{4\\pi} \\frac{\\exp(-ikr)}{r} \\sin\\theta\\,\\hat{\\boldsymbol{\\phi}} \\right)\n$$\nThe minus signs cancel, and $\\exp(ikr)\\exp(-ikr)=1$. The vector cross product is $\\hat{\\boldsymbol{\\theta}} \\times \\hat{\\boldsymbol{\\phi}} = \\hat{\\mathbf{r}}$.\n$$\n\\mathbf{E} \\times \\mathbf{H}^* \\approx \\frac{k^3\\omega |p_0|^2 \\sin^2\\theta}{16\\pi^2\\varepsilon_0 r^2} \\hat{\\mathbf{r}}\n$$\nThis expression is purely real, so $\\text{Re}\\{\\mathbf{E} \\times \\mathbf{H}^*\\} = \\mathbf{E} \\times \\mathbf{H}^*$.\n$$\n\\langle\\mathbf{S}\\rangle = \\frac{1}{2} \\frac{k^3\\omega |p_0|^2 \\sin^2\\theta}{16\\pi^2\\varepsilon_0 r^2} \\hat{\\mathbf{r}} = \\frac{k^3\\omega |p_0|^2 \\sin^2\\theta}{32\\pi^2\\varepsilon_0 r^2} \\hat{\\mathbf{r}}\n$$\nTo express this in the requested variables, we substitute $k=\\omega/c$:\n$$\nk^3\\omega = (\\omega/c)^3\\omega = \\omega^4/c^3\n$$\n$$\n\\langle\\mathbf{S}\\rangle = \\frac{\\omega^4 |p_0|^2}{32\\pi^2\\varepsilon_0 c^3 r^2} \\sin^2\\theta\\,\\hat{\\mathbf{r}}\n$$\nThe time-averaged power radiated per unit solid angle, denoted $\\frac{dP_{\\text{rad}}}{d\\Omega}$, is given by $r^2$ times the magnitude of the Poynting vector:\n$$\n\\frac{dP_{\\text{rad}}}{d\\Omega} = r^2 |\\langle\\mathbf{S}\\rangle| = \\frac{\\omega^4 |p_0|^2}{32\\pi^2\\varepsilon_0 c^3} \\sin^2\\theta\n$$\nThe normalized angular radiation pattern $F(\\theta)$ is defined to be dimensionless with a maximum value of $1$. The angular dependence of the power is contained in the $\\sin^2\\theta$ term. The maximum value of $\\sin^2\\theta$ is $1$, occurring at $\\theta=\\pi/2$. Therefore, the normalized radiation pattern is:\n$$\nF(\\theta) = \\sin^2\\theta\n$$\nThis completes Task 2.\n\nFor Task 3, we find the total time-averaged radiated power $P_{\\text{rad}}$ by integrating the power per unit solid angle over all solid angles $\\Omega$. The differential solid angle is $d\\Omega = \\sin\\theta d\\theta d\\phi$.\n$$\nP_{\\text{rad}} = \\int_{\\Omega} \\frac{dP_{\\text{rad}}}{d\\Omega} d\\Omega = \\int_{0}^{2\\pi} \\int_{0}^{\\pi} \\left( \\frac{\\omega^4 |p_0|^2}{32\\pi^2\\varepsilon_0 c^3} \\sin^2\\theta \\right) \\sin\\theta d\\theta d\\phi\n$$\nThe integrand is independent of $\\phi$, so the integral over $\\phi$ yields $2\\pi$:\n$$\nP_{\\text{rad}} = \\frac{\\omega^4 |p_0|^2}{32\\pi^2\\varepsilon_0 c^3} (2\\pi) \\int_{0}^{\\pi} \\sin^3\\theta d\\theta = \\frac{\\omega^4 |p_0|^2}{16\\pi\\varepsilon_0 c^3} \\int_{0}^{\\pi} \\sin^3\\theta d\\theta\n$$\nWe evaluate the remaining integral:\n$$\n\\int_{0}^{\\pi} \\sin^3\\theta d\\theta = \\int_{0}^{\\pi} \\sin\\theta(1-\\cos^2\\theta)d\\theta\n$$\nLet $u = \\cos\\theta$, so $du = -\\sin\\theta d\\theta$. The limits of integration change from $\\theta=0 \\to u=1$ and $\\theta=\\pi \\to u=-1$.\n$$\n\\int_{0}^{\\pi} \\sin^3\\theta d\\theta = \\int_{1}^{-1} (1-u^2)(-du) = \\int_{-1}^{1} (1-u^2)du = \\left[u - \\frac{u^3}{3}\\right]_{-1}^{1}\n$$\n$$\n= \\left(1 - \\frac{1}{3}\\right) - \\left(-1 - \\frac{(-1)^3}{3}\\right) = \\frac{2}{3} - \\left(-1 + \\frac{1}{3}\\right) = \\frac{2}{3} - \\left(-\\frac{2}{3}\\right) = \\frac{4}{3}\n$$\nSubstituting this result into the expression for $P_{\\text{rad}}$:\n$$\nP_{\\text{rad}} = \\frac{\\omega^4 |p_0|^2}{16\\pi\\varepsilon_0 c^3} \\left(\\frac{4}{3}\\right) = \\frac{\\omega^4 |p_0|^2}{12\\pi\\varepsilon_0 c^3}\n$$\nThis is the total time-averaged power radiated by the dipole, expressed in terms of the required physical constants. The expression is in SI units (Watts). This completes Task 3.\n\nThe final answer consists of the pair $(F(\\theta), P_{\\text{rad}})$.",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\sin^2\\theta & \\frac{\\omega^4 |p_0|^2}{12\\pi\\varepsilon_0 c^3}\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "Transitioning from analytical formulas to numerical computation requires addressing the singular nature of the Green's function, which becomes infinite when the source and observation points coincide. This practice tackles this head-on by guiding you through the implementation of a 'singularity subtraction' scheme, a cornerstone technique in computational electromagnetics. You will develop a numerical algorithm to calculate the electric field from a volume current distribution, carefully handling the kernel's singularity by subtracting its quasistatic part and adding back an analytically derived self-term. This hands-on coding exercise makes the abstract concept of regularization concrete, equipping you with a vital skill for developing robust numerical solvers.",
            "id": "3303052",
            "problem": "You are to design and implement a numerical scheme for evaluating the frequency-domain electric field generated by a volume current distribution in free space via a dyadic Green's function, using singularity subtraction by adding and subtracting a quasistatic kernel. The computation must be based on first principles of electromagnetics and fundamental definitions of Green's functions.\n\nThe foundational base from which you must derive your approach includes:\n- Maxwell's equations in the frequency domain with time dependence $e^{+i \\omega t}$, the constitutive relations in free space, and the wavenumber definition $k = \\omega \\sqrt{\\mu_0 \\epsilon_0}$.\n- The scalar free-space Helmholtz Green's function $G_0(\\mathbf{r},\\mathbf{r}') = \\dfrac{e^{i k |\\mathbf{r} - \\mathbf{r}'|}}{4 \\pi |\\mathbf{r} - \\mathbf{r}'|}$.\n- The dyadic Green's representation of the electric field due to an electric current density $\\mathbf{J}(\\mathbf{r}')$,\n  $$ \\mathbf{E}(\\mathbf{r}) = -i \\omega \\mu_0 \\int_{\\mathbb{R}^3} \\left[ \\mathbf{I} + \\frac{1}{k^2} \\nabla \\nabla \\right] G_0(\\mathbf{r},\\mathbf{r}') \\cdot \\mathbf{J}(\\mathbf{r}') \\, d\\mathbf{r}' , $$\n  where $\\mathbf{I}$ is the identity dyadic and $\\nabla$ acts on $\\mathbf{r}$.\n- The decomposition of $\\nabla \\nabla f(|\\mathbf{r}-\\mathbf{r}'|)$ for a radial function $f$ into components along $\\hat{\\mathbf{R}} \\hat{\\mathbf{R}}$ and $\\mathbf{I} - \\hat{\\mathbf{R}} \\hat{\\mathbf{R}}$, where $\\mathbf{R} = \\mathbf{r} - \\mathbf{r}'$ and $\\hat{\\mathbf{R}} = \\mathbf{R}/|\\mathbf{R}|$.\n- The quasistatic kernel obtained by taking the limit $k \\to 0$ of the singular part, and the distributional identity for the Hessian of the Coulomb potential,\n  $$ \\nabla \\nabla \\left(\\frac{1}{R}\\right) = \\operatorname{PV}\\left[\\frac{3 \\hat{\\mathbf{R}} \\hat{\\mathbf{R}} - \\mathbf{I}}{R^3}\\right] - \\frac{4 \\pi}{3} \\mathbf{I} \\, \\delta(\\mathbf{R}), $$\n  where $\\operatorname{PV}$ denotes the Cauchy principal value.\n\nYour task is to:\n- Derive an explicit algorithmic form for the dyadic kernel acting on $\\mathbf{J}$ that is suitable for numerical evaluation on a discrete grid, starting from the above fundamental base and without invoking shortcut formulas that bypass the derivation.\n- Implement singularity subtraction by adding and subtracting the quasistatic kernel inside a small spherical neighborhood around the singularity ($\\mathbf{r} = \\mathbf{r}'$), and add back the analytically integrable delta-function self-term. Explicitly, the analytic correction due to the quasistatic kernel should be included as a local \"self-term\" proportional to $-\\mathbf{J}(\\mathbf{r})/(3 k^2)$, multiplied by the appropriate physical prefactor for $\\mathbf{E}(\\mathbf{r})$.\n\nNumerical setup:\n- Consider a uniform current density $\\mathbf{J}(\\mathbf{r}') = J_0 \\, \\hat{\\mathbf{x}}$ within a finite cubic domain of side length $a$ centered at the origin, and zero outside. The cube is discretized uniformly with $N$ points per side, spacing $\\Delta = a/(N-1)$, and numerical integration is performed by summation of the kernel over grid cells.\n- The observation point $\\mathbf{r}$ may be inside or outside the cube. When $\\mathbf{r}$ is inside, perform singularity subtraction by excluding a ball of radius $R_0$ around $\\mathbf{r}$ for the quasistatic part (use $R_0 = 2 \\Delta$), numerically integrating the regularized kernel in that ball, and adding back the analytic self-term implied by the distributional identity. When $\\mathbf{r}$ is outside, no subtraction is required.\n- Use the vacuum constants $\\mu_0 = 4 \\pi \\times 10^{-7} \\, \\mathrm{H/m}$ and $c = 299{,}792{,}458 \\, \\mathrm{m/s}$, with $\\epsilon_0 = 1/(\\mu_0 c^2)$. The wavenumber is $k = \\omega/c$ where $\\omega = 2 \\pi f$.\n\nYour program must compute the magnitude of the electric field $|\\mathbf{E}(\\mathbf{r})|$ in volt per meter (V/m) for the following test suite of three cases, each specified by $(a, N, f, J_0, \\mathbf{r})$:\n1. Case A (general internal point with subtraction):\n   - $a = 0.2 \\, \\mathrm{m}$, $N = 41$, $f = 1.0 \\times 10^8 \\, \\mathrm{Hz}$, $J_0 = 1.0 \\, \\mathrm{A/m^2}$, $\\mathbf{r} = (0,0,0) \\, \\mathrm{m}$. The observation point is inside the cube. Apply singularity subtraction with $R_0 = 2 \\Delta$.\n2. Case B (external point without subtraction):\n   - $a = 0.2 \\, \\mathrm{m}$, $N = 41$, $f = 1.0 \\times 10^8 \\, \\mathrm{Hz}$, $J_0 = 1.0 \\, \\mathrm{A/m^2}$, $\\mathbf{r} = (0,0,1.0) \\, \\mathrm{m}$. The observation point is outside the cube. Do not apply subtraction.\n3. Case C (near-quasistatic internal point with subtraction):\n   - $a = 0.2 \\, \\mathrm{m}$, $N = 41$, $f = 1.0 \\times 10^6 \\, \\mathrm{Hz}$, $J_0 = 1.0 \\, \\mathrm{A/m^2}$, $\\mathbf{r} = (0,0,0) \\, \\mathrm{m}$. The observation point is inside the cube. Apply singularity subtraction with $R_0 = 2 \\Delta$.\n\nAngle units are not involved. Physical units: report magnitudes in volt per meter (V/m) as decimal floats.\n\nYour program should produce a single line of output containing the three results as a comma-separated list enclosed in square brackets, in the order [Case A, Case B, Case C], for example, \"[x_A,x_B,x_C]\". Each entry must be a float representing $|\\mathbf{E}(\\mathbf{r})|$ in V/m.\n\nYour implementation must be fully self-contained, must not require user input or external files, and must run as-is. All numerical steps and any constants used must be clearly defined within the program.",
            "solution": "The problem requires the design and implementation of a numerical scheme to compute the electric field $\\mathbf{E}(\\mathbf{r})$ generated by a volume current density $\\mathbf{J}(\\mathbf{r}')$. The method is based on the dyadic Green's function formalism and employs singularity subtraction to handle the kernel's singular behavior when the observation point $\\mathbf{r}$ is inside the source region.\n\n### 1. Theoretical Formulation\n\nThe electric field $\\mathbf{E}(\\mathbf{r})$ in the frequency domain (assuming $e^{+i\\omega t}$ time dependence) due to a current density $\\mathbf{J}(\\mathbf{r}')$ in free space is given by the volume integral equation:\n$$\n\\mathbf{E}(\\mathbf{r}) = \\int_{V'} \\overline{\\overline{K}}(\\mathbf{r}, \\mathbf{r}') \\cdot \\mathbf{J}(\\mathbf{r}') \\, dV'\n$$\nwhere $V'$ is the source volume and $\\overline{\\overline{K}}(\\mathbf{r}, \\mathbf{r}')$ is the electric field kernel. The kernel is related to the dyadic Green's function $\\overline{\\overline{G}}_E$ by $\\overline{\\overline{K}} = -i \\omega \\mu_0 \\overline{\\overline{G}}_E$. The dyadic Green's function is given as:\n$$\n\\overline{\\overline{G}}_E(\\mathbf{r}, \\mathbf{r}') = \\left[ \\mathbf{I} + \\frac{1}{k^2} \\nabla \\nabla \\right] G_0(\\mathbf{r},\\mathbf{r}')\n$$\nHere, $\\mathbf{I}$ is the identity dyadic, $k = \\omega/c$ is the wavenumber in free space, $\\nabla$ operates on the observation coordinates $\\mathbf{r}$, and $G_0(\\mathbf{r},\\mathbf{r}')$ is the scalar free-space Helmholtz Green's function:\n$$\nG_0(\\mathbf{r}, \\mathbf{r}') = \\frac{e^{ikR}}{4\\pi R}\n$$\nwith $\\mathbf{R} = \\mathbf{r} - \\mathbf{r}'$ and $R = |\\mathbf{R}|$.\n\nThe primary challenge in evaluating the integral is the singular nature of the kernel as $R \\to 0$. The term $\\nabla\\nabla G_0$ contains a non-integrable (strong) singularity of order $O(1/R^3)$.\n\n### 2. Derivation of the Dyadic Kernel\n\nTo derive an explicit form for the kernel, we must evaluate the Hessian $\\nabla \\nabla G_0(R)$. For a general radial function $f(R)$, the Hessian can be expressed as:\n$$\n\\nabla \\nabla f(R) = \\left( \\frac{d^2f}{dR^2} - \\frac{1}{R}\\frac{df}{dR} \\right) \\hat{\\mathbf{R}}\\hat{\\mathbf{R}} + \\frac{1}{R}\\frac{df}{dR} \\mathbf{I}\n$$\nwhere $\\hat{\\mathbf{R}} = \\mathbf{R}/R$. For $f(R) = G_0(R) = \\frac{e^{ikR}}{4\\pi R}$, the derivatives are:\n$$\n\\frac{dG_0}{dR} = \\frac{e^{ikR}}{4\\pi} \\left( \\frac{ik}{R} - \\frac{1}{R^2} \\right)\n$$\n$$\n\\frac{d^2G_0}{dR^2} = \\frac{e^{ikR}}{4\\pi} \\left( \\frac{-k^2}{R} - \\frac{2ik}{R^2} + \\frac{2}{R^3} \\right)\n$$\nSubstituting these into the Hessian formula yields:\n$$\n\\nabla \\nabla G_0(R) = \\frac{e^{ikR}}{4\\pi R^3} \\left[ (-k^2R^2 - 3ikR + 3) \\hat{\\mathbf{R}}\\hat{\\mathbf{R}} + (ikR - 1) \\mathbf{I} \\right]\n$$\nThe full kernel $\\overline{\\overline{K}} = -i\\omega\\mu_0 (\\mathbf{I} G_0 + \\frac{1}{k^2}\\nabla\\nabla G_0)$ can then be written as:\n$$\n\\overline{\\overline{K}}(\\mathbf{R}) = \\frac{-i\\omega\\mu_0 e^{ikR}}{4\\pi k^2 R^3} \\left[ (k^2R^2+ikR-1)\\mathbf{I} + (-k^2R^2-3ikR+3)\\hat{\\mathbf{R}}\\hat{\\mathbf{R}} \\right]\n$$\nAs $R \\to 0$, the terms proportional to $3\\hat{\\mathbf{R}}\\hat{\\mathbf{R}}/R^3$ and $-\\mathbf{I}/R^3$ dominate, exhibiting the strong $O(1/R^3)$ singularity.\n\n### 3. Singularity Subtraction\n\nTo handle this singularity, we subtract and add a quasistatic kernel. The singular behavior of $\\nabla\\nabla G_0$ as $R \\to 0$ mirrors that of the simpler electrostatic potential $1/R$. The problem provides the distributional identity for the Hessian of the Coulomb potential:\n$$\n\\nabla \\nabla \\left(\\frac{1}{R}\\right) = \\operatorname{PV}\\left[\\frac{3 \\hat{\\mathbf{R}} \\hat{\\mathbf{R}} - \\mathbf{I}}{R^3}\\right] - \\frac{4 \\pi}{3} \\mathbf{I} \\, \\delta(\\mathbf{R})\n$$\nwhere $\\operatorname{PV}$ denotes the Cauchy Principal Value. The quasistatic part of the kernel, responsible for the strong singularity, is defined as:\n$$\n\\overline{\\overline{K}}_{\\text{qs,PV}}(\\mathbf{R}) = \\frac{-i\\omega\\mu_0}{k^2} \\operatorname{PV}\\left[\\nabla\\nabla\\left(\\frac{1}{4\\pi R}\\right)\\right] = \\frac{-i\\omega\\mu_0}{4\\pi k^2} \\operatorname{PV}\\left[\\frac{3 \\hat{\\mathbf{R}} \\hat{\\mathbf{R}} - \\mathbf{I}}{R^3}\\right]\n$$\nThe integral for $\\mathbf{E}(\\mathbf{r})$ is rewritten by adding and subtracting this quasistatic kernel and isolating the delta-function contribution:\n$$\n\\mathbf{E}(\\mathbf{r}) = \\int_{V'} \\left( \\overline{\\overline{K}}(\\mathbf{R}) - \\overline{\\overline{K}}_{\\text{qs,PV}}(\\mathbf{R}) \\right) \\cdot \\mathbf{J}(\\mathbf{r}') \\, dV' + \\operatorname{PV} \\int_{V'} \\overline{\\overline{K}}_{\\text{qs,PV}}(\\mathbf{R}) \\cdot \\mathbf{J}(\\mathbf{r}') \\, dV' + \\mathbf{E}_{\\text{self}}\n$$\nThe \"self-term\" $\\mathbf{E}_{\\text{self}}$ arises from the delta function part of the identity:\n$$\n\\mathbf{E}_{\\text{self}} = \\int_{V'} \\frac{-i\\omega\\mu_0}{k^2} \\left(-\\frac{1}{3}\\mathbf{I}\\delta(\\mathbf{R})\\right) \\cdot \\mathbf{J}(\\mathbf{r}') \\, dV' = \\frac{i\\omega\\mu_0}{3k^2} \\mathbf{J}(\\mathbf{r}) = \\frac{i}{3\\omega\\epsilon_0}\\mathbf{J}(\\mathbf{r})\n$$\nThe remaining kernel, $\\overline{\\overline{K}}_{\\text{reg}}(\\mathbf{R}) = \\overline{\\overline{K}}(\\mathbf{R}) - \\overline{\\overline{K}}_{\\text{qs,PV}}(\\mathbf{R})$, is regularized. While it still weakly diverges as $O(1/R)$, this singularity is integrable, allowing for direct numerical summation.\n\n### 4. Numerical Algorithm\n\nFollowing the problem's prescription, for an observation point $\\mathbf{r}$ inside the source volume, we partition the numerical integration domain.\n1.  **Outside the subtraction ball ($R > R_0$)**: The full kernel $\\overline{\\overline{K}}(\\mathbf{R})$ is used. The integrand is well-behaved.\n2.  **Inside the subtraction ball ($0 < R \\le R_0$)**: The regularized kernel $\\overline{\\overline{K}}_{\\text{reg}}(\\mathbf{R}) = \\overline{\\overline{K}}(\\mathbf{R}) - \\overline{\\overline{K}}_{\\text{qs,PV}}(\\mathbf{R})$ is used for numerical integration. This avoids the strong singularity.\n3.  **Analytical Correction**: The contribution of the subtracted term, $\\int_{V' \\cap B_{R_0}} \\overline{\\overline{K}}_{\\text{qs,PV}} \\cdot \\mathbf{J}' dV'$, where $B_{R_0}$ is the ball of radius $R_0$, is handled analytically. For a spherical region and constant $\\mathbf{J}$, the principal value integral is zero by symmetry. The delta-function contribution is added back as the self-term $\\mathbf{E}_{\\text{self}}$.\n\nThe discretized computation for an internal point $\\mathbf{r}$ is:\n$$\n\\mathbf{E}(\\mathbf{r}) \\approx \\sum_{\\mathbf{r}'_i, |\\mathbf{R}_i| > R_0} \\overline{\\overline{K}}(\\mathbf{R}_i) \\cdot \\mathbf{J}(\\mathbf{r}'_i)\n\\Delta V + \\sum_{\\mathbf{r}'_i, 0 < |\\mathbf{R}_i| \\le R_0} \\overline{\\overline{K}}_{\\text{reg}}(\\mathbf{R}_i) \\cdot \\mathbf{J}(\\mathbf{r}'_i) \\Delta V + \\mathbf{E}_{\\text{self}}\n$$\nwhere $\\Delta V = (a/(N-1))^3$ is the volume of a grid cell. For an external point, $R$ is never zero, so no subtraction is needed and only the full kernel $\\overline{\\overline{K}}$ is used for all source cells.\n\nThe kernel-vector product can be expressed as $\\overline{\\overline{K}}\\cdot\\mathbf{J} = (\\alpha \\mathbf{I} + \\beta \\hat{\\mathbf{R}}\\hat{\\mathbf{R}}) \\cdot \\mathbf{J} = \\alpha \\mathbf{J} + \\beta(\\hat{\\mathbf{R}}\\cdot\\mathbf{J})\\hat{\\mathbf{R}}$. The coefficients for the full kernel are:\n$$\n\\alpha_{\\text{full}} = \\frac{-i\\omega\\mu_0 e^{ikR}}{4\\pi k^2 R^3} (k^2R^2+ikR-1)\n$$\n$$\n\\beta_{\\text{full}} = \\frac{-i\\omega\\mu_0 e^{ikR}}{4\\pi k^2 R^3} (-k^2R^2-3ikR+3)\n$$\nThe coefficients for the quasistatic part are:\n$$\n\\alpha_{\\text{qs}} = \\frac{-i\\omega\\mu_0}{4\\pi k^2 R^3} (-1)\n$$\n$$\n\\beta_{\\text{qs}} = \\frac{-i\\omega\\mu_0}{4\\pi k^2 R^3} (3)\n$$\nThe numerical implementation will use $\\alpha_{\\text{reg}} = \\alpha_{\\text{full}} - \\alpha_{\\text{qs}}$ and $\\beta_{\\text{reg}} = \\beta_{\\text{full}} - \\beta_{\\text{qs}}$ inside the subtraction radius $R_0$.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the electric field from a volume current source using a dyadic Green's function\n    with singularity subtraction.\n    \"\"\"\n    # Define physical constants\n    MU0 = 4 * np.pi * 1e-7  # Vacuum permeability (H/m)\n    C = 299792458.0         # Speed of light in vacuum (m/s)\n    EPS0 = 1 / (MU0 * C**2)  # Vacuum permittivity (F/m)\n\n    test_cases = [\n        # Case A: (a, N, f, J0, r_obs) - Internal point\n        (0.2, 41, 1.0e8, 1.0, np.array([0.0, 0.0, 0.0])),\n        # Case B: (a, N, f, J0, r_obs) - External point\n        (0.2, 41, 1.0e8, 1.0, np.array([0.0, 0.0, 1.0])),\n        # Case C: (a, N, f, J0, r_obs) - Near-quasistatic internal point\n        (0.2, 41, 1.0e6, 1.0, np.array([0.0, 0.0, 0.0])),\n    ]\n\n    results = []\n    for case in test_cases:\n        a, N, f, J0, r_obs = case\n\n        # Derived parameters\n        omega = 2 * np.pi * f\n        k = omega / C\n        delta = a / (N - 1)\n        dV = delta**3\n        R0 = 2 * delta\n        \n        # Current density vector\n        J_vec = np.array([J0, 0.0, 0.0], dtype=complex)\n        \n        # Grid setup for the source cube\n        half_width = a / 2.0\n        grid_coords = np.linspace(-half_width, half_width, N)\n        \n        E_total = np.array([0.0, 0.0, 0.0], dtype=complex)\n\n        # Check if observation point is inside the source volume\n        is_internal = np.all(np.abs(r_obs) <= half_width + 1e-9)\n\n        # Numerical integration over the source volume\n        for x_p in grid_coords:\n            for y_p in grid_coords:\n                for z_p in grid_coords:\n                    r_prime = np.array([x_p, y_p, z_p])\n                    \n                    R_vec = r_obs - r_prime\n                    R = np.linalg.norm(R_vec)\n                    \n                    # Skip the singularity point r = r' itself. It is handled by the self-term.\n                    if R < 1e-12:\n                        continue\n                    \n                    R_hat = R_vec / R\n                    \n                    # Select kernel based on position (internal/external point) and distance\n                    use_regularized_kernel = is_internal and R <= R0\n                    \n                    if use_regularized_kernel:\n                        # Regularized kernel: K_full - K_qs\n                        # Numerically more stable to compute (K_full - K_qs) directly\n                        # Full kernel coeffients\n                        exp_ikR = np.exp(1j * k * R)\n                        \n                        common_factor_full = -1j * omega * MU0 * exp_ikR / (4 * np.pi * k**2 * R**3)\n                        alpha_full = common_factor_full * (k**2 * R**2 + 1j * k * R - 1)\n                        beta_full = common_factor_full * (-k**2 * R**2 - 3j * k * R + 3)\n                        \n                        # Quasistatic kernel coefficients\n                        common_factor_qs = -1j * omega * MU0 / (4 * np.pi * k**2 * R**3)\n                        alpha_qs = common_factor_qs * (-1)\n                        beta_qs = common_factor_qs * (3)\n                        \n                        alpha = alpha_full - alpha_qs\n                        beta = beta_full - beta_qs\n                    else:\n                        # Full kernel\n                        exp_ikR = np.exp(1j * k * R)\n                        \n                        common_factor = -1j * omega * MU0 * exp_ikR / (4 * np.pi * k**2 * R**3)\n                        alpha = common_factor * (k**2 * R**2 + 1j * k * R - 1)\n                        beta = common_factor * (-k**2 * R**2 - 3j * k * R + 3)\n                        \n                    # Calculate contribution from this source cell\n                    Rhat_dot_J = np.dot(R_hat, J_vec)\n                    dE = (alpha * J_vec + beta * Rhat_dot_J * R_hat) * dV\n                    E_total += dE\n                    \n        # Add the analytical self-term for internal points\n        if is_internal:\n            # E_self = (i * omega * mu0) / (3 * k^2) * J = i / (3 * omega * eps0) * J\n            J_at_r_obs = np.array([J0, 0.0, 0.0], dtype=complex)\n            E_self = 1j / (3 * omega * EPS0) * J_at_r_obs\n            E_total += E_self\n\n        # Calculate the magnitude of the total electric field\n        E_magnitude = np.linalg.norm(E_total)\n        results.append(E_magnitude)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "The power of the Green's function formalism extends beyond analyzing existing fields to synthesizing sources that create desired electromagnetic environments. This advanced practice explores such a design-oriented problem, where the goal is to engineer a \"quiet zone\" in space, free from an incident field. By leveraging the surface equivalence principle, you will determine the specific magnetic currents on a closed Huygens surface that radiate a field to precisely cancel an incoming plane wave in a prescribed shadow region. This exercise not only showcases the practical utility of Green's functions in applications like field cancellation and antenna synthesis but also introduces the critical concept of numerical robustness by evaluating the solution's sensitivity to surface discretization.",
            "id": "3303043",
            "problem": "You are asked to design and evaluate a computational procedure that uses the dyadic Green’s function for free space to synthesize equivalent surface currents on a closed Huygens surface such that the total electric field is approximately nulled in a prescribed shadow region, and to quantify how sensitive the design is to the discretization of the Huygens surface.\n\nStart from first principles appropriate to computational electromagnetics, without assuming any target formulas. Use the following as the fundamental base:\n- The time-harmonic, source-free Maxwell equations in the frequency domain with the convention $\\exp(-i \\omega t)$:\n$$\\nabla \\times \\mathbf{E} = i \\omega \\mu \\,\\mathbf{H}, \\quad \\nabla \\times \\mathbf{H} = -i \\omega \\varepsilon \\,\\mathbf{E}, \\quad \\nabla \\cdot \\mathbf{E} = 0, \\quad \\nabla \\cdot \\mathbf{H} = 0.$$\n- The free-space scalar Green’s function $g(\\mathbf{r},\\mathbf{r}')$ for the Helmholtz equation,\n$$g(\\mathbf{r},\\mathbf{r}') = \\frac{e^{i k \\lvert \\mathbf{r} - \\mathbf{r}' \\rvert}}{4 \\pi \\lvert \\mathbf{r} - \\mathbf{r}' \\rvert}, \\quad k = \\omega \\sqrt{\\mu \\varepsilon}.$$\n- The dyadic Green’s function $\\overline{\\overline{G}}(\\mathbf{r},\\mathbf{r}')$ for free space defined by\n$$(\\nabla \\times \\nabla \\times - k^2 \\overline{\\overline{I}})\\,\\overline{\\overline{G}}(\\mathbf{r},\\mathbf{r}') = \\overline{\\overline{I}} \\,\\delta(\\mathbf{r}-\\mathbf{r}'),$$\nwhere $\\overline{\\overline{I}}$ is the identity dyad, and $\\delta(\\cdot)$ is the Dirac delta.\n\nYour task is to do the following.\n\n1) Derive, from the above base using the vector calculus identities implied by the definitions of $\\overline{\\overline{G}}$ and $g$, a surface integral representation for the radiated electric field due to a purely magnetic equivalent surface current density $\\mathbf{M}_s(\\mathbf{r}')$ residing on a closed surface $S$ in free space. Show that in a source-free region outside $S$, the electric field contribution from $\\mathbf{M}_s$ can be written in terms of the scalar Green’s function by an operator acting on $\\mathbf{M}_s(\\mathbf{r}')$ of the form\n$$\\mathbf{E}_M(\\mathbf{r}) = - \\nabla \\times \\int_S g(\\mathbf{r},\\mathbf{r}') \\,\\mathbf{M}_s(\\mathbf{r}') \\, \\mathrm{d}S' = - \\int_S \\nabla g(\\mathbf{r},\\mathbf{r}') \\times \\mathbf{M}_s(\\mathbf{r}') \\,\\mathrm{d}S',$$\nwith $\\nabla$ acting on $\\mathbf{r}$, and where $\\nabla g(\\mathbf{r},\\mathbf{r}')$ is the gradient of the scalar Green’s function with respect to the observation coordinate. Explicitly obtain $\\nabla g(\\mathbf{r},\\mathbf{r}')$ as a function of $k$, $\\mathbf{r}$, and $\\mathbf{r}'$.\n\n2) Consider a spherical Huygens surface $S$ of radius $a$ centered at the origin. Discretize $S$ into $N_\\theta \\times N_\\phi$ nonoverlapping rectangular spherical patches by uniform partition in polar angle $\\theta \\in (0,\\pi)$ and azimuthal angle $\\phi \\in (0,2\\pi)$ of widths $\\Delta \\theta = \\pi/N_\\theta$ and $\\Delta \\phi = 2\\pi/N_\\phi$, respectively. Approximate each patch by its centroid at $(\\theta_c,\\phi_c)$ and area $A = a^2 \\sin\\theta_c\\, \\Delta \\theta \\,\\Delta \\phi$, with local spherical unit vectors $\\hat{\\mathbf{r}}$, $\\hat{\\boldsymbol{\\theta}}$, $\\hat{\\boldsymbol{\\phi}}$ evaluated at the centroid. Use a piecewise-constant tangential basis for the magnetic surface current on each patch,\n$$\\mathbf{M}_s(\\mathbf{r}') \\approx \\sum_{p=1}^{P} \\left(m_{p,1}\\, \\hat{\\boldsymbol{\\theta}}_p + m_{p,2}\\, \\hat{\\boldsymbol{\\phi}}_p\\right)\\, \\chi_p(\\mathbf{r}'),$$\nwhere $P=N_\\theta N_\\phi$, $\\chi_p$ is the indicator of patch $p$, and $m_{p,1}$, $m_{p,2}$ are unknown complex coefficients. Derive the discrete linear mapping from the unknown coefficient vector to the electric field at an arbitrary observation point $\\mathbf{r}$, using the approximation that the integral over a patch is the value at the centroid times the area:\n$$\\mathbf{E}_M(\\mathbf{r}) \\approx - \\sum_{p=1}^{P} A_p \\Big( \\nabla g(\\mathbf{r},\\mathbf{r}_p) \\times \\hat{\\boldsymbol{\\theta}}_p \\Big)\\, m_{p,1} - \\sum_{p=1}^{P} A_p \\Big( \\nabla g(\\mathbf{r},\\mathbf{r}_p) \\times \\hat{\\boldsymbol{\\phi}}_p \\Big)\\, m_{p,2}.$$\nExpress this in the canonical linear algebra form $\\mathbf{A}\\,\\mathbf{m} \\approx \\mathbf{b}$ for a set of observation points by stacking the three Cartesian components of the electric field at each observation point, where $\\mathbf{m} \\in \\mathbb{C}^{2P}$ and $\\mathbf{b}$ is the negative of the incident field contribution at those points.\n\n3) Let the incident field be a unit-amplitude plane wave\n$$\\mathbf{E}_{\\mathrm{inc}}(\\mathbf{r}) = \\hat{\\mathbf{x}}\\, e^{i k z},$$\nwith wave number $k = 2 \\pi$ in normalized units, so that the free-space wavelength is $1$. Take the spherical Huygens surface radius to be $a = 0.5$. Define the shadow region to be a spherical cap of observation points at radius $r_{\\mathrm{obs}} > a$ with small polar angle, specifically $\\theta \\in [0,\\theta_{\\max}]$ with $\\theta_{\\max} = 0.35$ radians. Use two disjoint point sets in this cap:\n- A training set at radius $r_{\\mathrm{train}} = 0.70$ consisting of $N_{\\theta,\\mathrm{train}} = 4$ equally spaced polar angles in $[0,\\theta_{\\max}]$ and $N_{\\phi,\\mathrm{train}} = 6$ equally spaced azimuthal angles in $[0,2\\pi)$, for a total of $N_{\\mathrm{train}} = 24$ points.\n- A test set at radius $r_{\\mathrm{test}}$ consisting of $N_{\\theta,\\mathrm{test}} = 5$ equally spaced polar angles in $[0,\\theta_{\\max}]$ and $N_{\\phi,\\mathrm{test}} = 8$ equally spaced azimuthal angles in $[0,2\\pi)$, for a total of $N_{\\mathrm{test}} = 40$ points.\n\nAt the training points, solve the least-squares problem for the magnetic surface current coefficients that minimize the Euclidean norm of the residual of the total field,\n$$\\min_{\\mathbf{m}} \\left\\| \\mathbf{A}_{\\mathrm{train}} \\mathbf{m} - \\mathbf{b}_{\\mathrm{train}} \\right\\|_2,$$\nwhere $\\mathbf{b}_{\\mathrm{train}}$ is the negated incident field stacked over all training points, and $\\mathbf{A}_{\\mathrm{train}}$ is the discretized operator constructed in item 2. Then, evaluate the total field on the test set,\n$$\\mathbf{E}_{\\mathrm{tot}}(\\mathbf{r}) = \\mathbf{E}_{\\mathrm{inc}}(\\mathbf{r}) + \\mathbf{E}_M(\\mathbf{r}),$$\nand compute the following scalar performance metrics over the test points:\n- The maximum relative magnitude\n$$\\eta_{\\max} = \\max_{q=1,\\dots,N_{\\mathrm{test}}} \\frac{ \\lVert \\mathbf{E}_{\\mathrm{tot}}(\\mathbf{r}_q)\\rVert_2 }{ \\lVert \\hat{\\mathbf{x}} \\rVert_2 },$$\n- The root-mean-square relative magnitude\n$$\\eta_{\\mathrm{rms}} = \\sqrt{ \\frac{1}{N_{\\mathrm{test}}} \\sum_{q=1}^{N_{\\mathrm{test}}} \\left( \\frac{ \\lVert \\mathbf{E}_{\\mathrm{tot}}(\\mathbf{r}_q)\\rVert_2 }{ \\lVert \\hat{\\mathbf{x}} \\rVert_2 } \\right)^2 }.$$\nNote that $\\lVert \\hat{\\mathbf{x}} \\rVert_2 = 1$, so these metrics are dimensionless. All angles in this problem must be treated in radians.\n\n4) Quantify robustness to discretization by repeating the above design-evaluate procedure for the following test suite of parameter tuples $(N_\\theta, N_\\phi, r_{\\mathrm{test}})$:\n- Case A (coarse, boundary-like): $(2, 4, 0.70)$,\n- Case B (coarse): $(4, 8, 0.70)$,\n- Case C (happy path): $(8, 16, 0.70)$,\n- Case D (edge, near-surface evaluation): $(8, 16, 0.55)$.\n\nFor each case, report the pair $(\\eta_{\\max}, \\eta_{\\mathrm{rms}})$ computed on its corresponding test set.\n\n5) Final output format. Your program must produce a single line of output containing a list with one entry per case, where each entry is a two-element list $[\\eta_{\\max}, \\eta_{\\mathrm{rms}}]$ with each float rounded to six decimal places, aggregated in the order A, B, C, D. For example, an acceptable output format is\n$$[\\,[0.123456,0.012345],[\\dots],[\\dots],[\\dots]\\,].$$\n\nNo external input should be read by the program. All computations must be performed in normalized units as described, and all angles must be in radians. The output is dimensionless and therefore requires no physical units in the final answer.",
            "solution": "The problem is subjected to a rigorous validation process.\n\n### Step 1: Extract Givens\n- **Fundamental Equations**:\n  - Time-harmonic Maxwell's equations (with $\\exp(-i \\omega t)$): $\\nabla \\times \\mathbf{E} = i \\omega \\mu \\,\\mathbf{H}$, $\\nabla \\times \\mathbf{H} = -i \\omega \\varepsilon \\,\\mathbf{E}$, $\\nabla \\cdot \\mathbf{E} = 0$, $\\nabla \\cdot \\mathbf{H} = 0$.\n  - Scalar Green's function: $g(\\mathbf{r},\\mathbf{r}') = \\frac{e^{i k \\lvert \\mathbf{r} - \\mathbf{r}' \\rvert}}{4 \\pi \\lvert \\mathbf{r} - \\mathbf{r}' \\rvert}$, with $k = \\omega \\sqrt{\\mu \\varepsilon}$.\n  - Dyadic Green's function definition: $(\\nabla \\times \\nabla \\times - k^2 \\overline{\\overline{I}})\\,\\overline{\\overline{G}}(\\mathbf{r},\\mathbf{r}') = \\overline{\\overline{I}} \\,\\delta(\\mathbf{r}-\\mathbf{r}')$.\n- **Task 1: Derivation**:\n  - Derive the surface integral for the electric field $\\mathbf{E}_M(\\mathbf{r})$ from a magnetic surface current $\\mathbf{M}_s(\\mathbf{r}')$ on a closed surface $S$.\n  - Show $\\mathbf{E}_M(\\mathbf{r}) = - \\nabla \\times \\int_S g(\\mathbf{r},\\mathbf{r}') \\,\\mathbf{M}_s(\\mathbf{r}') \\, \\mathrm{d}S' = - \\int_S \\nabla g(\\mathbf{r},\\mathbf{r}') \\times \\mathbf{M}_s(\\mathbf{r}') \\,\\mathrm{d}S'$.\n  - Derive the expression for $\\nabla g(\\mathbf{r},\\mathbf{r}')$.\n- **Task 2: Discretization**:\n  - Geometry: Spherical Huygens surface of radius $a$, centered at origin.\n  - Discretization: $N_\\theta \\times N_\\phi$ patches from uniform partition of $\\theta \\in (0,\\pi)$ and $\\phi \\in (0,2\\pi)$.\n  - Patch properties: Centroid $(\\theta_c,\\phi_c)$, area $A = a^2 \\sin\\theta_c\\, (\\pi/N_\\theta) \\,(2\\pi/N_\\phi)$.\n  - Basis functions: Piecewise-constant tangential currents, $\\mathbf{M}_s(\\mathbf{r}') \\approx \\sum_{p=1}^{P} \\left(m_{p,1}\\, \\hat{\\boldsymbol{\\theta}}_p + m_{p,2}\\, \\hat{\\boldsymbol{\\phi}}_p\\right)\\, \\chi_p(\\mathbf{r}')$.\n  - Discretized field expression: $\\mathbf{E}_M(\\mathbf{r}) \\approx - \\sum_{p=1}^{P} A_p \\Big( \\nabla g(\\mathbf{r},\\mathbf{r}_p) \\times \\hat{\\boldsymbol{\\theta}}_p \\Big)\\, m_{p,1} - \\sum_{p=1}^{P} A_p \\Big( \\nabla g(\\mathbf{r},\\mathbf{r}_p) \\times \\hat{\\boldsymbol{\\phi}}_p \\Big)\\, m_{p,2}$.\n  - Formulate linear system $\\mathbf{A}\\,\\mathbf{m} \\approx \\mathbf{b}$.\n- **Task 3: Numerical Setup**:\n  - Incident field: $\\mathbf{E}_{\\mathrm{inc}}(\\mathbf{r}) = \\hat{\\mathbf{x}}\\, e^{i k z}$.\n  - Parameters: $k = 2 \\pi$, $a = 0.5$.\n  - Shadow region: Spherical cap with $r_{\\mathrm{obs}} > a$, $\\theta \\in [0,0.35]$.\n  - Training set: $r_{\\mathrm{train}}=0.70$, $N_{\\theta,\\mathrm{train}}=4$, $N_{\\phi,\\mathrm{train}}=6$ ($24$ points).\n  - Test set: $r_{\\mathrm{test}}$ (variable), $N_{\\theta,\\mathrm{test}}=5$, $N_{\\phi,\\mathrm{test}}=8$ ($40$ points).\n  - Solution method: Solve $\\min_{\\mathbf{m}} \\left\\| \\mathbf{A}_{\\mathrm{train}} \\mathbf{m} - \\mathbf{b}_{\\mathrm{train}} \\right\\|_2$.\n  - Performance metrics: $\\eta_{\\max}$ (max relative magnitude) and $\\eta_{\\mathrm{rms}}$ (RMS relative magnitude) of the total field $\\mathbf{E}_{\\mathrm{tot}} = \\mathbf{E}_{\\mathrm{inc}} + \\mathbf{E}_M$ on the test set.\n- **Task 4: Test Suite**:\n  - Case A: $(N_\\theta, N_\\phi, r_{\\mathrm{test}}) = (2, 4, 0.70)$\n  - Case B: $(N_\\theta, N_\\phi, r_{\\mathrm{test}}) = (4, 8, 0.70)$\n  - Case C: $(N_\\theta, N_\\phi, r_{\\mathrm{test}}) = (8, 16, 0.70)$\n  - Case D: $(N_\\theta, N_\\phi, r_{\\mathrm{test}}) = (8, 16, 0.55)$\n- **Task 5: Output Format**: A list of $[\\eta_{\\max}, \\eta_{\\mathrm{rms}}]$ pairs for cases A-D, with floats rounded to six decimal places.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is grounded in the standard theory of electromagnetic radiation and scattering, specifically using the surface equivalence principle (Huygens' principle) and the Method of Moments for numerical solution. All physical quantities, equations, and parameters are well-defined, consistent, and scientifically sound. The problem is a non-trivial but standard exercise in computational electromagnetics, testing both theoretical derivation and numerical implementation skills. The numerical parameters for discretization and evaluation points are clearly specified. The problem is well-posed; the use of a least-squares solver correctly handles both overdetermined and underdetermined systems that arise from different discretization levels.\n\n### Step 3: Verdict and Action\nThe problem is deemed **valid**. A full solution will be provided.\n\n### Solution\n\n#### Part 1: Derivation of the Surface Integral Representation\n\nWe begin with the representation of the electric field from sources. In a source-free region of space $V$, the electric field can be determined by the fields on its boundary surface $S$. The Stratton-Chu formulas provide such a representation. A simplified version, derived from the surface equivalence principle, states that the field radiated by equivalent electric and magnetic surface currents, $\\mathbf{J}_s$ and $\\mathbf{M}_s$, on a closed surface $S$ is given by:\n$$ \\mathbf{E}(\\mathbf{r}) = - \\int_S \\left[ i\\omega\\mu \\, \\overline{\\overline{G}}(\\mathbf{r}, \\mathbf{r}') \\cdot \\mathbf{J}_s(\\mathbf{r}') + \\nabla' \\times \\overline{\\overline{G}}(\\mathbf{r}, \\mathbf{r}') \\cdot \\mathbf{M}_s(\\mathbf{r}') \\right] \\mathrm{d}S' $$\nThe problem specifies a purely magnetic current source, so $\\mathbf{J}_s = 0$. The dyadic Green's function for the free-space vector Helmholtz equation can be expressed in terms of the scalar Green's function $g(\\mathbf{r}, \\mathbf{r}')$:\n$$ \\overline{\\overline{G}}(\\mathbf{r}, \\mathbf{r}') = \\left(\\overline{\\overline{I}} + \\frac{1}{k^2} \\nabla \\nabla \\right) g(\\mathbf{r}, \\mathbf{r}') $$\nThe electric field is thus represented by an integral involving $\\mathbf{M}_s$. A more direct approach uses the electric vector potential $\\mathbf{A}_e$:\n$$ \\mathbf{E}_M(\\mathbf{r}) = -\\nabla \\times \\mathbf{A}_e(\\mathbf{r}) $$\nwhere $\\mathbf{A}_e$ for a magnetic surface current is defined as:\n$$ \\mathbf{A}_e(\\mathbf{r}) = \\int_S g(\\mathbf{r},\\mathbf{r}') \\,\\mathbf{M}_s(\\mathbf{r}') \\, \\mathrm{d}S' $$\nSubstituting the potential into the expression for the field gives the first required identity:\n$$ \\mathbf{E}_M(\\mathbf{r}) = - \\nabla \\times \\int_S g(\\mathbf{r},\\mathbf{r}') \\,\\mathbf{M}_s(\\mathbf{r}') \\, \\mathrm{d}S' $$\nThe curl operator $\\nabla$ acts on the observation coordinate $\\mathbf{r}$, while the integral is over the source coordinate $\\mathbf{r}'$. Since these are independent, we can move the operator inside the integral:\n$$ \\mathbf{E}_M(\\mathbf{r}) = - \\int_S \\nabla \\times \\Big(g(\\mathbf{r},\\mathbf{r}') \\,\\mathbf{M}_s(\\mathbf{r}')\\Big) \\, \\mathrm{d}S' $$\nUsing the vector calculus identity $\\nabla \\times (f\\mathbf{V}) = f(\\nabla \\times \\mathbf{V}) + (\\nabla f) \\times \\mathbf{V}$, we let $f = g(\\mathbf{r},\\mathbf{r}')$ and $\\mathbf{V} = \\mathbf{M}_s(\\mathbf{r}')$. Since $\\mathbf{M}_s(\\mathbf{r}')$ is a function of $\\mathbf{r}'$ only, its curl with respect to $\\mathbf{r}$ is zero, i.e., $\\nabla \\times \\mathbf{M}_s(\\mathbf{r}') = 0$. The expression simplifies to:\n$$ \\nabla \\times \\Big(g(\\mathbf{r},\\mathbf{r}') \\,\\mathbf{M}_s(\\mathbf{r}')\\Big) = \\nabla g(\\mathbf{r},\\mathbf{r}') \\times \\mathbf{M}_s(\\mathbf{r}') $$\nSubstituting this back into the integral yields the second required identity:\n$$ \\mathbf{E}_M(\\mathbf{r}) = - \\int_S \\nabla g(\\mathbf{r},\\mathbf{r}') \\times \\mathbf{M}_s(\\mathbf{r}') \\,\\mathrm{d}S' $$\nNext, we find the gradient of the scalar Green's function, $\\nabla g(\\mathbf{r},\\mathbf{r}')$. Let $R = \\lvert \\mathbf{r} - \\mathbf{r}' \\rvert$. The scalar Green's function is $g(R) = \\frac{e^{i k R}}{4 \\pi R}$. Using the chain rule, $\\nabla g = \\frac{\\mathrm{d}g}{\\mathrm{d}R} \\nabla R$.\nThe gradient of the distance $R$ is $\\nabla R = \\frac{\\mathbf{r} - \\mathbf{r}'}{\\lvert \\mathbf{r} - \\mathbf{r}' \\rvert}$.\nThe derivative of $g$ with respect to $R$ is:\n$$ \\frac{\\mathrm{d}g}{\\mathrm{d}R} = \\frac{1}{4\\pi} \\frac{\\mathrm{d}}{\\mathrm{d}R} \\left( \\frac{e^{i k R}}{R} \\right) = \\frac{1}{4\\pi} \\left( \\frac{i k R e^{i k R} - e^{i k R}}{R^2} \\right) = \\frac{e^{i k R}}{4\\pi R^2} (i k R - 1) $$\nCombining these gives the final expression for the gradient:\n$$ \\nabla g(\\mathbf{r},\\mathbf{r}') = \\frac{e^{i k \\lvert \\mathbf{r} - \\mathbf{r}' \\rvert}}{4 \\pi \\lvert \\mathbf{r} - \\mathbf{r}' \\rvert^2} \\left(i k - \\frac{1}{\\lvert \\mathbf{r} - \\mathbf{r}' \\rvert}\\right) (\\mathbf{r} - \\mathbf{r}') $$\n\n#### Part 2: Discretization and Linear System Formulation\n\nWe discretize the Huygens surface and the integral equation. The magnetic surface current $\\mathbf{M}_s(\\mathbf{r}')$ is approximated by a sum of piecewise-constant basis functions defined on $P=N_\\theta N_\\phi$ patches:\n$$ \\mathbf{M}_s(\\mathbf{r}') \\approx \\sum_{p=1}^{P} \\mathbf{M}_p \\, \\chi_p(\\mathbf{r}') = \\sum_{p=1}^{P} \\left(m_{p,1}\\, \\hat{\\boldsymbol{\\theta}}_p + m_{p,2}\\, \\hat{\\boldsymbol{\\phi}}_p\\right)\\, \\chi_p(\\mathbf{r}') $$\nHere, $\\chi_p(\\mathbf{r}')$ is an indicator function for patch $p$, and $\\hat{\\boldsymbol{\\theta}}_p, \\hat{\\boldsymbol{\\phi}}_p$ are the local tangential unit vectors at the patch centroid $\\mathbf{r}_p$.\nSubstituting this into the derived integral for $\\mathbf{E}_M(\\mathbf{r})$:\n$$ \\mathbf{E}_M(\\mathbf{r}) = - \\sum_{p=1}^{P} \\int_{S_p} \\nabla g(\\mathbf{r},\\mathbf{r}') \\times \\left(m_{p,1}\\, \\hat{\\boldsymbol{\\theta}}_p + m_{p,2}\\, \\hat{\\boldsymbol{\\phi}}_p\\right) \\, \\mathrm{d}S' $$\nUsing the midpoint rule for integration, $\\int_{S_p} F(\\mathbf{r}') \\mathrm{d}S' \\approx F(\\mathbf{r}_p) A_p$, where $A_p$ is the area of patch $p$:\n$$ \\mathbf{E}_M(\\mathbf{r}) \\approx - \\sum_{p=1}^{P} A_p \\, \\nabla g(\\mathbf{r},\\mathbf{r}_p) \\times \\left(m_{p,1}\\, \\hat{\\boldsymbol{\\theta}}_p + m_{p,2}\\, \\hat{\\boldsymbol{\\phi}}_p\\right) $$\nBy distributing the cross product and separating the sums based on the unknown coefficients $m_{p,1}$ and $m_{p,2}$, we arrive at the expression given in the problem:\n$$ \\mathbf{E}_M(\\mathbf{r}) \\approx - \\sum_{p=1}^{P} A_p \\Big( \\nabla g(\\mathbf{r},\\mathbf{r}_p) \\times \\hat{\\boldsymbol{\\theta}}_p \\Big)\\, m_{p,1} - \\sum_{p=1}^{P} A_p \\Big( \\nabla g(\\mathbf{r},\\mathbf{r}_p) \\times \\hat{\\boldsymbol{\\phi}}_p \\Big)\\, m_{p,2} $$\nThis is a linear relationship between the unknown coefficients and the radiated field. To create a system of linear equations, we enforce the condition that the total field should be zero at a set of $N_{\\mathrm{train}}$ observation (training) points $\\mathbf{r}_q$:\n$$ \\mathbf{E}_{\\mathrm{tot}}(\\mathbf{r}_q) = \\mathbf{E}_{\\mathrm{inc}}(\\mathbf{r}_q) + \\mathbf{E}_M(\\mathbf{r}_q) \\approx 0 \\implies \\mathbf{E}_M(\\mathbf{r}_q) \\approx -\\mathbf{E}_{\\mathrm{inc}}(\\mathbf{r}_q) $$\nLet $\\mathbf{m} \\in \\mathbb{C}^{2P}$ be the vector of all unknown coefficients, $\\mathbf{m} = [m_{1,1}, m_{1,2}, \\dots, m_{P,1}, m_{P,2}]^T$. Let $\\mathbf{b} \\in \\mathbb{C}^{3N_{\\mathrm{train}}}$ be the vector of the negated incident electric field components stacked for all training points $\\{ \\mathbf{r}_q \\}$. The relationship can be written as a matrix equation $\\mathbf{A}\\,\\mathbf{m} = \\mathbf{b}$.\nThe matrix $\\mathbf{A}$ has dimensions $(3N_{\\mathrm{train}}) \\times (2P)$. Each training point $\\mathbf{r}_q$ contributes $3$ rows to $\\mathbf{A}$ (for the $x, y, z$ field components). Each current coefficient $m_{p,j}$ corresponds to one column of $\\mathbf{A}$.\nThe column corresponding to $m_{p,1}$ (column index $2(p-1)$) contains the stacked vectors $-A_p (\\nabla g(\\mathbf{r}_q, \\mathbf{r}_p) \\times \\hat{\\boldsymbol{\\theta}}_p)$ for $q=1, \\dots, N_{\\mathrm{train}}$.\nSimilarly, the column for $m_{p,2}$ (column index $2(p-1)+1$) contains the stacked vectors $-A_p (\\nabla g(\\mathbf{r}_q, \\mathbf{r}_p) \\times \\hat{\\boldsymbol{\\phi}}_p)$.\n\n#### Part 3 & 4: Numerical Implementation and Evaluation\n\nThe procedure is implemented as a Python script.\n1.  **Constants and Geometry**: Set $k=2\\pi$, $a=0.5$.\n2.  **Loop over cases**: For each tuple $(N_\\theta, N_\\phi, r_{\\mathrm{test}})$:\n    a. **Generate Surface Mesh**: Create the $P=N_\\theta N_\\phi$ patches on the sphere. For each patch, compute its centroid $\\mathbf{r}_p$, area $A_p$, and local tangential basis vectors $\\hat{\\boldsymbol{\\theta}}_p, \\hat{\\boldsymbol{\\phi}}_p$ in Cartesian coordinates.\n    b. **Generate Training Points**: Create the $N_{\\mathrm{train}}=24$ points at $r_{\\mathrm{train}}=0.70$ in the specified shadow cap.\n    c. **Assemble System**:\n       i. Construct the matrix $\\mathbf{A}_{\\mathrm{train}}$ of size $(3 \\times 24) \\times (2P)$. Each element is calculated from the expression for the discretized field.\n       ii. Construct the vector $\\mathbf{b}_{\\mathrm{train}}$ of size $(3 \\times 24)$ using the incident field $\\mathbf{E}_{\\mathrm{inc}}(\\mathbf{r}) = \\hat{\\mathbf{x}}\\, e^{i k z}$ evaluated at the training points.\n    d. **Solve for Currents**: Solve the least-squares problem $\\min_{\\mathbf{m}} \\| \\mathbf{A}_{\\mathrm{train}} \\mathbf{m} - \\mathbf{b}_{\\mathrm{train}} \\|_2$ to find the optimal current coefficient vector $\\mathbf{m}$. For cases C and D, this system is underdetermined; `numpy.linalg.lstsq` will find the minimum-norm solution.\n    e. **Evaluate Performance**:\n       i. Generate the $N_{\\mathrm{test}}=40$ test points at the specified radius $r_{\\mathrm{test}}$.\n       ii. Construct the matrix $\\mathbf{A}_{\\mathrm{test}}$ for these test points.\n       iii. Calculate the scattered field at the test points: $\\mathbf{E}_M^{\\mathrm{stacked}} = \\mathbf{A}_{\\mathrm{test}} \\mathbf{m}$.\n       iv. Calculate the incident field $\\mathbf{E}_{\\mathrm{inc}}$ at the test points.\n       v. Compute the total field: $\\mathbf{E}_{\\mathrm{tot}} = \\mathbf{E}_{\\mathrm{inc}} + \\mathbf{E}_M$.\n       vi. Calculate the metrics $\\eta_{\\max}$ and $\\eta_{\\mathrm{rms}}$ over all test points. The reference amplitude is $\\|\\hat{\\mathbf{x}}\\|_2 = 1$.\n3.  **Format Output**: Collect the $(\\eta_{\\max}, \\eta_{\\mathrm{rms}})$ pairs for all cases and print them in the specified list format, rounded to six decimal places.\n\nThis structured process ensures that all requirements of the problem are met, combining theoretical derivations with a robust numerical implementation.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the electromagnetics problem by synthesizing surface currents on a\n    Huygens surface to null an incident field in a shadow region.\n    \"\"\"\n\n    # --- Problem Parameters ---\n    k = 2.0 * np.pi  # Wavenumber (lambda = 1)\n    a = 0.5  # Radius of the spherical Huygens surface\n    theta_max = 0.35  # Max polar angle of shadow region in radians\n\n    # Training set parameters\n    r_train = 0.70\n    N_theta_train = 4\n    N_phi_train = 6\n    N_train = N_theta_train * N_phi_train\n\n    # Test set parameters\n    N_theta_test = 5\n    N_phi_test = 8\n    N_test = N_theta_test * N_phi_test\n\n    # Test suite of cases (N_theta, N_phi, r_test)\n    test_cases = [\n        (2, 4, 0.70),   # Case A\n        (4, 8, 0.70),   # Case B\n        (8, 16, 0.70),  # Case C\n        (8, 16, 0.55),  # Case D\n    ]\n\n    # --- Helper Functions ---\n\n    def generate_patches(N_theta, N_phi):\n        \"\"\"Generates patch centroids, areas, and basis vectors.\"\"\"\n        delta_theta = np.pi / N_theta\n        delta_phi = 2 * np.pi / N_phi\n        \n        patches = []\n        for i in range(N_theta):\n            theta_c = (i + 0.5) * delta_theta\n            for j in range(N_phi):\n                phi_c = (j + 0.5) * delta_phi\n                \n                area = a**2 * np.sin(theta_c) * delta_theta * delta_phi\n                \n                # Centroid in Cartesian coordinates\n                r_p = np.array([\n                    a * np.sin(theta_c) * np.cos(phi_c),\n                    a * np.sin(theta_c) * np.sin(phi_c),\n                    a * np.cos(theta_c)\n                ])\n                \n                # Tangential basis vectors in Cartesian coordinates\n                theta_hat = np.array([\n                    np.cos(theta_c) * np.cos(phi_c),\n                    np.cos(theta_c) * np.sin(phi_c),\n                    -np.sin(theta_c)\n                ])\n                phi_hat = np.array([\n                    -np.sin(phi_c),\n                    np.cos(phi_c),\n                    0.0\n                ])\n                \n                patches.append({'r_p': r_p, 'area': area, 'theta_hat': theta_hat, 'phi_hat': phi_hat})\n        return patches\n\n    def generate_observation_points(r_obs, N_theta_obs, N_phi_obs):\n        \"\"\"Generates observation points on a spherical cap.\"\"\"\n        thetas = np.linspace(0, theta_max, N_theta_obs)\n        phis = np.linspace(0, 2 * np.pi, N_phi_obs, endpoint=False)\n        \n        points = []\n        for theta in thetas:\n            for phi in phis:\n                point = np.array([\n                    r_obs * np.sin(theta) * np.cos(phi),\n                    r_obs * np.sin(theta) * np.sin(phi),\n                    r_obs * np.cos(theta)\n                ])\n                points.append(point)\n        return np.array(points)\n\n    def grad_g(r, r_prime):\n        \"\"\"Computes the gradient of the scalar Green's function.\"\"\"\n        R_vec = r - r_prime\n        R = np.linalg.norm(R_vec)\n        if R == 0:\n            return np.zeros(3, dtype=np.complex128)\n        \n        phase_term = np.exp(1j * k * R)\n        magnitude_term = (1j * k * R - 1) / (4 * np.pi * R**3)\n        \n        return phase_term * magnitude_term * R_vec\n\n    def incident_field(r_obs):\n        \"\"\"Computes the incident plane wave field.\"\"\"\n        z = r_obs[2]\n        return np.array([np.exp(1j * k * z), 0.0, 0.0], dtype=np.complex128)\n\n    # --- Main Loop ---\n    \n    results = []\n\n    # Generate training points once\n    training_points = generate_observation_points(r_train, N_theta_train, N_phi_train)\n\n    for case in test_cases:\n        N_theta, N_phi, r_test = case\n        \n        # 1. Generate surface discretization\n        patches = generate_patches(N_theta, N_phi)\n        P = len(patches) # Total number of patches\n        \n        # 2. Assemble training system\n        A_train = np.zeros((3 * N_train, 2 * P), dtype=np.complex128)\n        b_train = np.zeros(3 * N_train, dtype=np.complex128)\n        \n        for q, r_q in enumerate(training_points):\n            # Calculate incident field for b_train\n            b_train[3*q : 3*q+3] = -incident_field(r_q)\n            \n            # Fill A_train matrix\n            for p, patch in enumerate(patches):\n                grad_g_val = grad_g(r_q, patch['r_p'])\n                \n                # Contribution from m_p,1 (theta-directed current)\n                v1 = -patch['area'] * np.cross(grad_g_val, patch['theta_hat'])\n                A_train[3*q : 3*q+3, 2*p] = v1\n\n                # Contribution from m_p,2 (phi-directed current)\n                v2 = -patch['area'] * np.cross(grad_g_val, patch['phi_hat'])\n                A_train[3*q : 3*q+3, 2*p + 1] = v2\n\n        # 3. Solve for current coefficients using least squares\n        m, _, _, _ = np.linalg.lstsq(A_train, b_train, rcond=None)\n        \n        # 4. Evaluate on the test set\n        test_points = generate_observation_points(r_test, N_theta_test, N_phi_test)\n        \n        E_scattered = np.zeros((N_test, 3), dtype=np.complex128)\n        for q, r_q in enumerate(test_points):\n            e_scat_q = np.zeros(3, dtype=np.complex128)\n            for p, patch in enumerate(patches):\n                grad_g_val = grad_g(r_q, patch['r_p'])\n                m_p1 = m[2*p]\n                m_p2 = m[2*p+1]\n                \n                v1 = -patch['area'] * np.cross(grad_g_val, patch['theta_hat'])\n                v2 = -patch['area'] * np.cross(grad_g_val, patch['phi_hat'])\n                \n                e_scat_q += m_p1 * v1 + m_p2 * v2\n            E_scattered[q] = e_scat_q\n\n        E_incident = np.array([incident_field(r_q) for r_q in test_points])\n        E_total = E_incident + E_scattered\n        \n        # 5. Compute performance metrics\n        # The reference amplitude is ||x_hat|| = 1\n        magnitudes_sq = np.sum(np.abs(E_total)**2, axis=1)\n        \n        eta_max = np.sqrt(np.max(magnitudes_sq))\n        eta_rms = np.sqrt(np.mean(magnitudes_sq))\n        \n        results.append([round(eta_max, 6), round(eta_rms, 6)])\n\n    # Final print statement in the exact required format.\n    # Using a simple string replace to achieve the exact format without extra spaces.\n    final_output_str = str(results).replace(\"'\", \"\").replace(\" \", \"\")\n    print(final_output_str)\n\nsolve()\n```"
        }
    ]
}