{
    "hands_on_practices": [
        {
            "introduction": "The surface equivalence principle allows us to replace a scatterer with equivalent currents on its boundary, leading to a surface integral equation formulation. The kernel of this integral involves the free-space Green's function, which contains a singularity of the form $1/|\\mathbf{r}-\\mathbf{r}'|$ that poses a fundamental challenge for numerical methods. This exercise  focuses on this critical issue, guiding you to regularize the singularity by transforming to local coordinates, a foundational skill for any practitioner of boundary element methods.",
            "id": "3352217",
            "problem": "Consider the surface equivalence principle in computational electromagnetics: the fields exterior to a scatterer can be represented in terms of equivalent surface currents on a boundary surface. In the frequency domain, the corresponding integral operators involve the free-space scalar Green’s function of the Helmholtz equation, whose leading-order singular structure near coincident source and observation points is governed by the factor $1/|\\mathbf{r}-\\mathbf{r}'|$. Accurate numerical quadrature for such singular surface integrals requires transforming the integrand to local coordinates on the surface so that the singularity is explicitly handled.\n\nStarting from Maxwell’s equations and the free-space scalar Green’s function definition for the Helmholtz operator, analyze the local singular behavior of the integral\n$$\nI[\\phi](\\mathbf{r}) \\equiv \\int_{S} \\frac{\\phi(\\mathbf{r}')}{|\\mathbf{r}-\\mathbf{r}'|} \\, dS',\n$$\nwhere $S$ is a smooth orientable surface in $\\mathbb{R}^3$ and $\\phi(\\mathbf{r}')$ is a sufficiently smooth scalar weight function induced by an equivalent surface current density on $S$ via the surface equivalence principle. Introduce a local orthonormal tangent frame at a point $\\mathbf{r}_0 \\in S$ and a corresponding local coordinate chart $(u,v)$ in the neighborhood of $\\mathbf{r}_0$, transform the singular part of the integrand to local polar coordinates $(\\rho,\\theta)$ on the tangent plane, and justify how this enables a finite analytic evaluation of the singular contribution.\n\nThen, validate the transformation and its analytic evaluation with a benchmark geometry: let $S$ be a flat circular disk of radius $a0$ lying in the plane $z=0$, centered at the origin, and let the observation point be $\\mathbf{r}=\\mathbf{0}$ at the disk center. Choose the constant weight function $\\phi(\\mathbf{r}') \\equiv 1$, and evaluate the singular integral\n$$\nI(a) \\equiv \\int_{S} \\frac{1}{|\\mathbf{r}'|} \\, dS'\n$$\nexactly by transforming to local polar coordinates on the disk. Provide your final answer as a closed-form analytic expression in terms of $a$. Do not perform any numerical approximation or rounding.",
            "solution": "The problem statement is internally consistent, scientifically grounded in the principles of electromagnetism and potential theory, and well-posed. All data and definitions required for the analysis and the specific calculation are provided. Therefore, the problem is valid.\n\nThe problem asks for two tasks: first, a general analysis of the singular behavior of a specific surface integral operator, and second, an exact evaluation of this integral for a benchmark case.\n\nPart 1: General Analysis of the Singularity\n\nThe integral in question is the single-layer potential operator, given by\n$$\nI[\\phi](\\mathbf{r}) \\equiv \\int_{S} \\frac{\\phi(\\mathbf{r}')}{|\\mathbf{r}-\\mathbf{r}'|} \\, dS'\n$$\nwhere $S$ is a smooth orientable surface in $\\mathbb{R}^3$, $\\phi(\\mathbf{r}')$ is a smooth scalar function, $\\mathbf{r}$ is the observation point, and $\\mathbf{r}'$ is the source point on $S$. This integral operator arises when solving Laplace's or Helmholtz's equation using boundary integral equation methods, which are central to computational electromagnetics via the surface equivalence principle.\n\nThe integrand exhibits a singularity when the observation point $\\mathbf{r}$ coincides with a source point $\\mathbf{r}'$ on the surface $S$. Let us analyze the behavior of the integral when $\\mathbf{r} = \\mathbf{r}_0 \\in S$. The integral becomes an improper integral:\n$$\nI[\\phi](\\mathbf{r}_0) = \\int_{S} \\frac{\\phi(\\mathbf{r}')}{|\\mathbf{r}_0-\\mathbf{r}'|} \\, dS'\n$$\nTo determine if this integral converges and to evaluate it, we must analyze the singularity. This is typically done by transforming to a local coordinate system centered at the point of singularity, $\\mathbf{r}_0$.\n\nLet us introduce a local coordinate system at $\\mathbf{r}_0$. The surface $S$ can be approximated in the neighborhood of $\\mathbf{r}_0$ by its tangent plane at that point. We can define a local orthonormal basis $\\{\\hat{\\mathbf{u}}, \\hat{\\mathbf{v}}, \\hat{\\mathbf{n}}\\}$, where $\\hat{\\mathbf{u}}$ and $\\hat{\\mathbf{v}}$ are tangent vectors spanning the tangent plane at $\\mathbf{r}_0$, and $\\hat{\\mathbf{n}}$ is the unit normal vector. A point $\\mathbf{r}'$ on the surface, close to $\\mathbf{r}_0$, can be approximated by its projection onto the tangent plane:\n$$\n\\mathbf{r}' - \\mathbf{r}_0 \\approx u \\hat{\\mathbf{u}} + v \\hat{\\mathbf{v}}\n$$\nwhere $(u,v)$ are local Cartesian coordinates in the tangent plane. In this approximation, the distance vector is $\\mathbf{r}' - \\mathbf{r}_0$ and its magnitude is $|\\mathbf{r}' - \\mathbf{r}_0| \\approx \\sqrt{u^2+v^2}$. The differential surface element $dS'$ on the curved surface is approximated by the differential area element on the tangent plane, $dS' \\approx du \\, dv$.\n\nSince the scalar weight function $\\phi(\\mathbf{r}')$ is assumed to be sufficiently smooth, in a small neighborhood of $\\mathbf{r}_0$, we can approximate it by its value at $\\mathbf{r}_0$, i.e., $\\phi(\\mathbf{r}') \\approx \\phi(\\mathbf{r}_0)$. The error in this approximation contributes to a regular, non-singular part of the integral. The singular behavior is captured by integrating this leading-order term over a small patch, say a disk $D_\\epsilon$ of radius $\\epsilon$, around $\\mathbf{r}_0$ in the tangent plane. The singular contribution is therefore approximated by:\n$$\n\\int_{D_\\epsilon} \\frac{\\phi(\\mathbf{r}_0)}{\\sqrt{u^2 + v^2}} \\, du \\, dv\n$$\nTo evaluate this integral, we transform the local Cartesian coordinates $(u,v)$ to local polar coordinates $(\\rho, \\theta)$, where $u = \\rho \\cos\\theta$ and $v = \\rho \\sin\\theta$. The radial distance is $\\rho = \\sqrt{u^2+v^2}$. The Jacobian of this transformation is $\\rho$, so the area element becomes $du \\, dv = \\rho \\, d\\rho \\, d\\theta$. The limits of integration for the disk $D_\\epsilon$ are $\\rho \\in [0, \\epsilon]$ and $\\theta \\in [0, 2\\pi]$.\n\nSubstituting these into the integral, we get:\n$$\n\\int_0^{2\\pi} \\int_0^\\epsilon \\frac{\\phi(\\mathbf{r}_0)}{\\rho} (\\rho \\, d\\rho \\, d\\theta) = \\int_0^{2\\pi} \\int_0^\\epsilon \\phi(\\mathbf{r}_0) \\, d\\rho \\, d\\theta\n$$\nThis transformation is the crucial step. The $1/\\rho$ singularity from the Green's function kernel is exactly cancelled by the $\\rho$ factor from the Jacobian of the polar coordinate transformation. The resulting integrand, $\\phi(\\mathbf{r}_0)$, is constant with respect to $\\rho$ and $\\theta$. The integral is now regular and can be evaluated directly:\n$$\n\\phi(\\mathbf{r}_0) \\int_0^{2\\pi} \\left[ \\rho \\right]_0^\\epsilon \\, d\\theta = \\phi(\\mathbf{r}_0) \\int_0^{2\\pi} \\epsilon \\, d\\theta = \\phi(\\mathbf{r}_0) (\\epsilon [ \\theta ]_0^{2\\pi}) = 2\\pi\\epsilon\\phi(\\mathbf{r}_0)\n$$\nThis result is finite, which demonstrates that the singularity is integrable (often called a \"weak singularity\"). The transformation to a local polar coordinate system centered at the singularity explicitly regularizes the integrand, allowing for its analytical or accurate numerical evaluation. This principle is the foundation for singularity subtraction and cancellation techniques used in the numerical solution of boundary integral equations.\n\nPart 2: Benchmark Evaluation\n\nWe are asked to validate this procedure by computing a specific integral for a defined geometry. The integral is:\n$$\nI(a) \\equiv \\int_{S} \\frac{1}{|\\mathbf{r}'|} \\, dS'\n$$\nThe surface $S$ is a flat circular disk of radius $a  0$ lying in the $z=0$ plane and centered at the origin. The observation point is specified as $\\mathbf{r}=\\mathbf{0}$, which is the center of the disk. This means we are evaluating the integral with the observation point at the center of the source distribution, which is a singular case as analyzed above. The problem is set up with $\\phi(\\mathbf{r}') \\equiv 1$ and the observation point $\\mathbf{r}$ at the origin, so the integrand is $\\frac{1}{|\\mathbf{0}-\\mathbf{r}'|} = \\frac{1}{|\\mathbf{r}'|}$.\n\nThis geometry is a direct application of the general principle. The surface $S$ is already a flat plane, so the tangent plane at any point on the disk is the disk's plane itself (the $z=0$ plane). We can immediately apply polar coordinates in this plane to evaluate the integral.\n\nA point $\\mathbf{r}'$ on the disk can be represented in polar coordinates $(\\rho, \\theta)$, where $\\rho$ is the radial distance from the origin and $\\theta$ is the azimuthal angle. The Cartesian coordinates are $x' = \\rho\\cos\\theta$ and $y' = \\rho\\sin\\theta$.\nThe distance from the origin to the point $\\mathbf{r}'$ is $|\\mathbf{r}'| = \\rho$.\nThe differential surface element in polar coordinates is $dS' = \\rho \\, d\\rho \\, d\\theta$.\nThe domain of integration for a disk of radius $a$ is $\\rho \\in [0, a]$ and $\\theta \\in [0, 2\\pi]$.\n\nSubstituting these into the integral expression for $I(a)$:\n$$\nI(a) = \\int_0^{2\\pi} \\int_0^a \\frac{1}{\\rho} (\\rho \\, d\\rho \\, d\\theta)\n$$\nAs in the general analysis, the singularity $1/\\rho$ is cancelled by the Jacobian factor $\\rho$:\n$$\nI(a) = \\int_0^{2\\pi} \\int_0^a 1 \\, d\\rho \\, d\\theta\n$$\nWe evaluate the integral, starting with the inner integral with respect to $\\rho$:\n$$\n\\int_0^a 1 \\, d\\rho = [\\rho]_0^a = a - 0 = a\n$$\nNow, we substitute this result into the outer integral with respect to $\\theta$:\n$$\nI(a) = \\int_0^{2\\pi} a \\, d\\theta = a [\\theta]_0^{2\\pi} = a(2\\pi - 0)\n$$\nThis gives the final exact result:\n$$\nI(a) = 2\\pi a\n$$",
            "answer": "$$\n\\boxed{2\\pi a}\n$$"
        },
        {
            "introduction": "While often associated with frequency-domain integral equations, the equivalence principle is also a key enabler for time-domain methods. In the Finite-Difference Time-Domain (FDTD) method, the principle is realized as the Total-Field/Scattered-Field (TFSF) formulation, which uses a virtual surface to inject an incident wave into the simulation grid. This exercise  will guide you through the derivation of the TFSF source terms from first principles and explore the practical consequences of numerical dispersion, bridging the gap between continuous-space theory and discrete-grid implementation.",
            "id": "3352208",
            "problem": "You are asked to work in the setting of a two-dimensional finite-difference time-domain discretization of Maxwell’s equations in vacuum for the Transverse Electric (TE) polarization with the electric field along the $z$-axis (commonly referred to as $\\text{TE}_z$). The Total-Field/Scattered-Field (TFSF) equivalence principle is to be used to inject a plane wave through a closed rectangular curve separating the total-field region (inside) from the scattered-field region (outside). Your tasks are to derive the discrete update expressions for the TFSF equivalent sources for a TE plane wave and to quantify how numerical dispersion of the Yee scheme impacts the enforcement of the equivalence across the TFSF boundary.\n\nStart from the fundamental base:\n- Faraday’s law and Ampère’s law in vacuum for time-harmonic fields,\n- the Yee grid staggering of the fields in space and time,\n- and the linear constitutive relations in vacuum.\n\nYou must not rely on any pre-tabulated update coefficients beyond what follows from directly discretizing the curl equations. You must derive, from first principles and consistent staggering, the discrete update expressions that correspond to the equivalent electric and magnetic sources needed to enforce the TFSF condition on each segment of the rectangular TFSF boundary for a $\\text{TE}_z$ plane wave with angular frequency $\\omega$ and incidence angle $\\theta$. Assume an incident plane wave in vacuum with electric field $E_z^{\\mathrm{inc}}(x,y,t)$ and magnetic fields $H_x^{\\mathrm{inc}}(x,y,t)$ and $H_y^{\\mathrm{inc}}(x,y,t)$, and express your discrete source terms as additive increments in the Yee update equations on the boundary-adjacent grid lines, explicitly giving their dependence on the grid spacings $\\Delta x$, $\\Delta y$ and time step $\\Delta t$.\n\nThen, analyze the effect of numerical dispersion on the equivalence enforcement by considering two notions of the incident plane wave phase:\n- A “physical” phase using the continuous-space wavenumber components $k_x = (\\omega/c)\\cos\\theta$ and $k_y = (\\omega/c)\\sin\\theta$, with $c$ the speed of light in vacuum.\n- A “numerical” phase adjusted to exactly satisfy the two-dimensional Yee-scheme discrete dispersion relation for the chosen $\\Delta x$, $\\Delta y$, and $\\Delta t$ while preserving the incidence direction $\\theta$.\n\nDefine and compute the following two quantitative measures for each test case:\n1) A relative phase-mismatch residual $r$ obtained by inserting the triplet $(\\omega,\\Delta t,k_x,k_y,\\Delta x,\\Delta y)$ into the discrete dispersion relation of the Yee scheme and normalizing the absolute defect by the left-hand side magnitude. Explicitly, derive the discrete dispersion relation from the discrete curl equations and define $r$ as the normalized nonzero residual when the “physical” $k_x,k_y$ are used, and as the corresponding value when the “numerical” $k_x,k_y$ are used.\n2) A numerical-impedance mismatch reflection estimate $\\Gamma$ at the TFSF boundary based on the ratio between the numerically consistent impedance (constructed from the discrete temporal and spatial difference operators applied to a plane wave) and the vacuum impedance. Your definition must be derived from the discrete update relations and must reduce to zero reflection when the discrete dispersion relation is exactly satisfied. Report $|\\Gamma|$ as a dimensionless float in $[0,1)$.\n\nUse the following physical constants: the speed of light $c = 299\\,792\\,458\\,\\mathrm{m/s}$, the vacuum permeability $\\mu_0 = 4\\pi\\times 10^{-7}\\,\\mathrm{H/m}$, and the vacuum permittivity $\\varepsilon_0 = 1/(\\mu_0 c^2)$.\n\nNumerical specification for all test cases:\n- The frequency is fixed at $f = 10^9\\,\\mathrm{Hz}$ so that $\\omega = 2\\pi f$ and the vacuum wavelength is $\\lambda = c/f$.\n- The Yee grid spacings are $\\Delta x = \\lambda/N_x$ and $\\Delta y = \\lambda/N_y$, where $N_x$ and $N_y$ are the points-per-wavelength in $x$ and $y$, respectively.\n- The time step is chosen as $\\Delta t = s\\,\\Delta t_{\\max}$ where $\\Delta t_{\\max} = 1/\\big(c\\,\\sqrt{(\\Delta x)^{-2}+(\\Delta y)^{-2}}\\big)$ and $s\\in(0,1)$ is a Courant factor.\n- Angles must be interpreted in degrees in the input specifications but converted to radians for any trigonometric evaluations.\n\nTest suite. For each test case below, compute the three floats in the order `[r_phys, r_num, |Gamma_phys|]`:\n- Case A: $N_x=N_y=20$, $\\theta=0^\\circ$, $s=0.99$.\n- Case B: $N_x=N_y=10$, $\\theta=45^\\circ$, $s=0.99$.\n- Case C: $N_x=N_y=20$, $\\theta=80^\\circ$, $s=0.99$.\n- Case D: $N_x=15, N_y=30$, $\\theta=30^\\circ$, $s=0.90$.\n- Case E: $N_x=N_y=40$, $\\theta=33^\\circ$, $s=0.50$.\n\nAll requested outputs are dimensionless floats. Your program must produce a single line of output containing the results as a comma-separated list enclosed in square brackets, with the values for the cases concatenated in the order A,B,C,D,E. Concretely, the output format must be\n“`[r^{(A)}_{\\mathrm{phys}},r^{(A)}_{\\mathrm{num}},|\\Gamma^{(A)}_{\\mathrm{phys}}|,r^{(B)}_{\\mathrm{phys}},r^{(B)}_{\\mathrm{num}},|\\Gamma^{(B)}_{\\mathrm{phys}}|,...,r^{(E)}_{\\mathrm{phys}},r^{(E)}_{\\mathrm{num}},|\\Gamma^{(E)}_{\\mathrm{phys}}|]`”.\nAngles must be interpreted in degrees, and physical units must comply with the definitions above. No other text should be printed.",
            "solution": "The problem posed is a standard, well-defined exercise in computational electromagnetics that requires derivation and numerical evaluation of concepts related to the Finite-Difference Time-Domain (FDTD) method, specifically the Total-Field/Scattered-Field (TFSF) formulation and numerical dispersion. The problem is valid as it is scientifically grounded, self-contained, and algorithmically solvable. We proceed with the solution.\n\n### Part 1: FDTD Formulation for TE$_z$ Waves\n\nWe begin with Maxwell's equations in a source-free, linear, isotropic, and homogeneous medium (vacuum), characterized by permittivity $\\varepsilon_0$ and permeability $\\mu_0$:\n$$ \\nabla \\times \\vec{E} = -\\mu_0 \\frac{\\partial \\vec{H}}{\\partial t} $$\n$$ \\nabla \\times \\vec{H} = \\varepsilon_0 \\frac{\\partial \\vec{E}}{\\partial t} $$\nFor a two-dimensional problem in the $xy$-plane ($\\partial/\\partial z = 0$) with Transverse Electric ($\\text{TE}_z$) polarization, the field components are $E_z$, $H_x$, and $H_y$, while $E_x = E_y = H_z = 0$. The curl equations reduce to a scalar system:\n$$ \\mu_0 \\frac{\\partial H_x}{\\partial t} = -\\frac{\\partial E_z}{\\partial y} $$\n$$ \\mu_0 \\frac{\\partial H_y}{\\partial t} = \\frac{\\partial E_z}{\\partial x} $$\n$$ \\varepsilon_0 \\frac{\\partial E_z}{\\partial t} = \\frac{\\partial H_y}{\\partial x} - \\frac{\\partial H_x}{\\partial y} $$\nThese equations are discretized in space and time using the Yee algorithm. Field components are placed on a staggered grid. Let a grid point be denoted by $(i\\Delta x, j\\Delta y)$ and a time instant by $n\\Delta t$. The fields are located as follows: $E_z$ at $(i, j, n)$, $H_x$ at $(i, j+1/2, n+1/2)$, and $H_y$ at $(i+1/2, j, n+1/2)$. Applying central-difference approximations to the derivatives yields the FDTD update equations:\n$$ H_x\\big|_{i, j+1/2}^{n+1/2} = H_x\\big|_{i, j+1/2}^{n-1/2} - \\frac{\\Delta t}{\\mu_0 \\Delta y} \\left( E_z\\big|_{i, j+1}^{n} - E_z\\big|_{i, j}^{n} \\right) $$\n$$ H_y\\big|_{i+1/2, j}^{n+1/2} = H_y\\big|_{i+1/2, j}^{n-1/2} + \\frac{\\Delta t}{\\mu_0 \\Delta x} \\left( E_z\\big|_{i+1, j}^{n} - E_z\\big|_{i, j}^{n} \\right) $$\n$$ E_z\\big|_{i, j}^{n+1} = E_z\\big|_{i, j}^{n} + \\frac{\\Delta t}{\\varepsilon_0} \\left( \\frac{H_y\\big|_{i+1/2, j}^{n+1/2} - H_y\\big|_{i-1/2, j}^{n+1/2}}{\\Delta x} - \\frac{H_x\\big|_{i, j+1/2}^{n+1/2} - H_x\\big|_{i, j-1/2}^{n+1/2}}{\\Delta y} \\right) $$\n\n### Part 2: Derivation of TFSF Update Expressions\n\nThe TFSF technique partitions the computational domain into a total-field (TF) region, where fields are the sum of incident and scattered components ($\\vec{F}^{\\mathrm{tot}} = \\vec{F}^{\\mathrm{inc}} + \\vec{F}^{\\mathrm{scat}}$), and a scattered-field (SF) region, which contains only the scattered fields. The standard FDTD equations above are used to update either the total or scattered fields within their respective regions. At the boundary between regions, the update equations must be modified to properly connect the two field types. These modifications are equivalent to introducing virtual electric and magnetic surface currents.\n\nWe derive the additive source terms by enforcing field continuity across the boundary. Let the TF region for $E_z$ be defined by grid indices $i \\in [i_0, i_1]$ and $j \\in [j_0, j_1]$.\nConsider the update for a total-field node $E_z^{\\mathrm{tot}}|_{i_0,j}^{n+1}$ on the left boundary of the TF region ($j_0  j  j_1$). The FDTD update requires $H_y|_{i_0-1/2,j}$, which is located in the SF region. The \"correct\" update for a total field uses total fields everywhere:\n$$ E_z^{\\mathrm{tot}}|_{i_0,j} \\text{ update uses } H_y^{\\mathrm{tot}}|_{i_0-1/2,j} $$\nHowever, the grid stores $H_y^{\\mathrm{scat}}|_{i_0-1/2,j}$. We enforce consistency by substituting $H_y^{\\mathrm{tot}} = H_y^{\\mathrm{scat}} + H_y^{\\mathrm{inc}}$:\n$$ E_z^{\\mathrm{tot}}|_{i_0,j}^{n+1} = E_z^{\\mathrm{tot}}|_{i_0,j}^{n} + \\frac{\\Delta t}{\\varepsilon_0 \\Delta x} \\left( H_y^{\\mathrm{tot}}|_{i_0+1/2,j} - H_y^{\\mathrm{tot}}|_{i_0-1/2,j} \\right) - \\dots $$\n$$ E_z^{\\mathrm{tot}}|_{i_0,j}^{n+1} = E_z^{\\mathrm{tot}}|_{i_0,j}^{n} + \\frac{\\Delta t}{\\varepsilon_0 \\Delta x} \\left( H_y^{\\mathrm{tot}}|_{i_0+1/2,j} - (H_y^{\\mathrm{scat}}|_{i_0-1/2,j} + H_y^{\\mathrm{inc}}|_{i_0-1/2,j}) \\right) - \\dots $$\nRearranging gives the update in terms of grid-resident fields plus a correction term:\n$$ E_z^{\\mathrm{tot}}|_{i_0,j}^{n+1} = \\left[ \\text{Standard update using grid fields} \\right] - \\frac{\\Delta t}{\\varepsilon_0 \\Delta x} H_y^{\\mathrm{inc}}|_{i_0-1/2,j}^{n+1/2} $$\nSymmetrically, consider the update for a scattered-field node $H_y^{\\mathrm{scat}}|_{i_0-1/2,j}^{n+1/2}$ just outside the TF region. It requires $E_z|_{i_0,j}$, which is a TF node.\n$$ H_y^{\\mathrm{scat}}|_{i_0-1/2,j} \\text{ update uses } E_z^{\\mathrm{scat}}|_{i_0,j} $$\nWe substitute $E_z^{\\mathrm{scat}} = E_z^{\\mathrm{tot}} - E_z^{\\mathrm{inc}}$:\n$$ H_y^{\\mathrm{scat}}|_{i_0-1/2,j}^{n+1/2} = H_y^{\\mathrm{scat}}|_{i_0-1/2,j}^{n-1/2} + \\frac{\\Delta t}{\\mu_0 \\Delta x} \\left( E_z^{\\mathrm{scat}}|_{i_0,j} - E_z^{\\mathrm{scat}}|_{i_0-1,j} \\right) $$\n$$ H_y^{\\mathrm{scat}}|_{i_0-1/2,j}^{n+1/2} = H_y^{\\mathrm{scat}}|_{i_0-1/2,j}^{n-1/2} + \\frac{\\Delta t}{\\mu_0 \\Delta x} \\left( (E_z^{\\mathrm{tot}}|_{i_0,j} - E_z^{\\mathrm{inc}}|_{i_0,j}) - E_z^{\\mathrm{scat}}|_{i_0-1,j} \\right) $$\nThe additive correction term is:\n$$ H_y^{\\mathrm{scat}}|_{i_0-1/2,j}^{n+1/2} = \\left[ \\text{Standard update using grid fields} \\right] - \\frac{\\Delta t}{\\mu_0 \\Delta x} E_z^{\\mathrm{inc}}|_{i_0,j}^{n} $$\nBy applying this logic to all four sides of the rectangular TFSF boundary, we derive all necessary source terms. For a $\\text{TE}_z$ plane wave $E_z^{\\mathrm{inc}}(x,y,t) = E_0\\cos(\\omega t - k_x x - k_y y)$, the corresponding magnetic fields (in continuous space) are $H_x^{\\mathrm{inc}} = \\frac{k_y}{\\omega\\mu_0}E_z^{\\mathrm{inc}}$ and $H_y^{\\mathrm{inc}} = -\\frac{k_x}{\\omega\\mu_0}E_z^{\\mathrm{inc}}$. The discrete source terms are additive corrections to the FDTD updates, evaluated using the incident plane wave field values at the appropriate Yee grid space-time locations. For example, for the $E_z$ update at $(i_0, j)$, the source is $-\\frac{\\Delta t}{\\varepsilon_0 \\Delta x}H_y^{\\mathrm{inc}}((i_0-1/2)\\Delta x, j\\Delta y, (n+1/2)\\Delta t)$, and for the $H_y$ update at $(i_0-1/2, j)$, the source is $-\\frac{\\Delta t}{\\mu_0 \\Delta x}E_z^{\\mathrm{inc}}(i_0\\Delta x, j\\Delta y, n\\Delta t)$.\n\n### Part 3: Numerical Dispersion and Impedance Analysis\n\nTo analyze the properties of the discrete grid, we substitute a numerical plane wave solution of the form $F(\\vec{r},t) = F_0 e^{j(\\omega t - k_x x - k_y y)}$ into the FDTD update equations. The discrete finite-difference operators effectively transform as follows:\n$$ \\frac{\\partial}{\\partial t} \\rightarrow \\frac{j 2}{\\Delta t} \\sin\\left(\\frac{\\omega \\Delta t}{2}\\right), \\quad \\frac{\\partial}{\\partial x} \\rightarrow \\frac{-j 2}{\\Delta x} \\sin\\left(\\frac{k_x \\Delta x}{2}\\right), \\quad \\frac{\\partial}{\\partial y} \\rightarrow \\frac{-j 2}{\\Delta y} \\sin\\left(\\frac{k_y \\Delta y}{2}\\right) $$\nSubstituting these into Maxwell's equations and eliminating the field amplitudes yields the 2D $\\text{TE}_z$ numerical dispersion relation for the Yee scheme:\n$$ \\left( \\frac{1}{c\\Delta t}\\sin\\frac{\\omega\\Delta t}{2} \\right)^2 = \\left( \\frac{1}{\\Delta x}\\sin\\frac{k_x\\Delta x}{2} \\right)^2 + \\left( \\frac{1}{\\Delta y}\\sin\\frac{k_y\\Delta y}{2} \\right)^2 $$\nIn continuous space, the dispersion relation is $(\\omega/c)^2 = k_x^2 + k_y^2$. The FDTD grid introduces numerical dispersion, meaning that waves of different frequencies, wavelengths, or propagation directions travel at different phase velocities, and this velocity is generally different from $c$.\n\n**1) Relative Phase-Mismatch Residual ($r$)**: This quantity measures how well a given plane wave satisfies the grid's dispersion relation. It is defined as:\n$$ r = \\frac{\\left| \\left( \\frac{\\sin(\\omega\\Delta t/2)}{c\\Delta t} \\right)^2 - \\left[ \\left( \\frac{\\sin(k_x\\Delta x/2)}{\\Delta x} \\right)^2 + \\left( \\frac{\\sin(k_y\\Delta y/2)}{\\Delta y} \\right)^2 \\right] \\right|}{\\left( \\frac{\\sin(\\omega\\Delta t/2)}{c\\Delta t} \\right)^2} $$\nFor the \"physical\" case, we use $k_x = (\\omega/c)\\cos\\theta$ and $k_y = (\\omega/c)\\sin\\theta$. These wavenumbers do not, in general, satisfy the numerical dispersion relation, resulting in a non-zero residual $r_{\\mathrm{phys}}$. For the \"numerical\" case, we find a new wavenumber magnitude $\\tilde{k}$ such that $\\tilde{k}_x = \\tilde{k}\\cos\\theta$ and $\\tilde{k}_y = \\tilde{k}\\sin\\theta$ exactly satisfy the numerical dispersion relation for the given $\\omega$ and $\\theta$. This is achieved by numerically solving a transactional equation for $\\tilde{k}$. By definition, the resulting residual $r_{\\mathrm{num}}$ will be zero (or close to machine precision).\n\n**2) Numerical-Impedance Mismatch ($\\Gamma$)**: The FDTD grid exhibits a numerical wave impedance that depends on frequency and propagation direction. From the discrete versions of Ampere's and Faraday's laws, we can derive the ratio of the electric to magnetic field amplitudes for a numerical plane wave:\n$$ Z_{\\mathrm{num}} = \\frac{|E_z|}{|\\vec{H}|} = \\frac{\\mu_0 \\frac{2}{\\Delta t}\\sin(\\frac{\\omega\\Delta t}{2})}{\\sqrt{\\left(\\frac{2}{\\Delta x}\\sin\\frac{k_x\\Delta x}{2}\\right)^2 + \\left(\\frac{2}{\\Delta y}\\sin\\frac{k_y\\Delta y}{2}\\right)^2}} $$\nThe TFSF source injection implicitly assumes the incident wave has the vacuum impedance $Z_0 = \\sqrt{\\mu_0/\\varepsilon_0} = c\\mu_0$. When $Z_{\\mathrm{num}} \\neq Z_0$, a spurious reflection occurs at the TFSF boundary. The reflection coefficient $\\Gamma$ can be estimated as:\n$$ \\Gamma = \\frac{Z_{\\mathrm{num}} - Z_0}{Z_{\\mathrm{num}} + Z_0} $$\nSubstituting the expressions for $Z_{\\mathrm{num}}$ and $Z_0$ and simplifying, we get:\n$$ \\Gamma = \\frac{ \\frac{\\sin(\\omega\\Delta t/2)}{\\Delta t} - c \\sqrt{\\left(\\frac{\\sin(k_x\\Delta x/2)}{\\Delta x}\\right)^2 + \\left(\\frac{\\sin(k_y\\Delta y/2)}{\\Delta y}\\right)^2} }{ \\frac{\\sin(\\omega\\Delta t/2)}{\\Delta t} + c \\sqrt{\\left(\\frac{\\sin(k_x\\Delta x/2)}{\\Delta x}\\right)^2 + \\left(\\frac{\\sin(k_y\\Delta y/2)}{\\Delta y}\\right)^2} } $$\nThe magnitude $|\\Gamma_{\\mathrm{phys}}|$ quantifies the reflection expected when injecting a physical plane wave into the dispersive FDTD grid. If the dispersion relation were perfectly satisfied, the numerator would be zero, resulting in $\\Gamma=0$.\n\nThe following code implements the calculation of these metrics for the specified test cases.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import brentq\n\ndef solve():\n    \"\"\"\n    Solves for the numerical dispersion metrics for a 2D TEz FDTD scheme.\n    \"\"\"\n    \n    # Define physical constants\n    c = 299792458.0  # Speed of light in vacuum, m/s\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (Nx, Ny, theta_degrees, courant_factor_s)\n        (20, 20, 0., 0.99),\n        (10, 10, 45., 0.99),\n        (20, 20, 80., 0.99),\n        (15, 30, 30., 0.90),\n        (40, 40, 33., 0.50),\n    ]\n\n    all_results = []\n    \n    for case in test_cases:\n        Nx, Ny, theta_deg, s = case\n        \n        # --- Step 1: Calculate simulation parameters ---\n        f = 1e9  # Frequency in Hz\n        omega = 2 * np.pi * f\n        lambda_0 = c / f  # Vacuum wavelength\n        \n        dx = lambda_0 / Nx\n        dy = lambda_0 / Ny\n        \n        dt_max = 1 / (c * np.sqrt(1/dx**2 + 1/dy**2))\n        dt = s * dt_max\n        \n        theta_rad = np.deg2rad(theta_deg)\n        \n        # We can define two key quantities, S_omega and S_k, which simplifies expressions.\n        # S_omega = sin(omega*dt/2) / (c*dt)\n        # S_k = sqrt( (sin(kx*dx/2)/dx)^2 + (sin(ky*dy/2)/dy)^2 )\n        # The dispersion relation is S_omega^2 = S_k^2\n        # The reflection coefficient is |(S_omega - S_k) / (S_omega + S_k)|\n        \n        S_omega = np.sin(omega * dt / 2) / (c * dt)\n        S_omega_sq = S_omega**2\n\n        # --- Step 2: Physical case calculations ---\n        k_phys = omega / c\n        kx_phys = k_phys * np.cos(theta_rad)\n        ky_phys = k_phys * np.sin(theta_rad)\n        \n        S_k_phys_sq = (np.sin(kx_phys * dx / 2) / dx)**2 + (np.sin(ky_phys * dy / 2) / dy)**2\n        \n        # Calculate relative phase-mismatch residual r_phys\n        r_phys = np.abs(S_omega_sq - S_k_phys_sq) / S_omega_sq\n        \n        # Calculate numerical-impedance mismatch reflection |Gamma_phys|\n        S_k_phys = np.sqrt(S_k_phys_sq)\n        Gamma_phys_mag = np.abs((S_omega - S_k_phys) / (S_omega + S_k_phys))\n\n        # --- Step 3: Numerical case calculations ---\n        # Define the residual of the dispersion relation as a function of k_tilde\n        def dispersion_residual_func(k_tilde, theta, dx, dy, S_omega_sq_val):\n            k_tilde_x = k_tilde * np.cos(theta)\n            k_tilde_y = k_tilde * np.sin(theta)\n            \n            S_k_tilde_sq = (np.sin(k_tilde_x * dx / 2) / dx)**2 + (np.sin(k_tilde_y * dy / 2) / dy)**2\n            return S_k_tilde_sq - S_omega_sq_val\n\n        # Numerically solve for k_tilde that satisfies the dispersion relation.\n        # It's known that k_tilde = k_phys.\n        # The residual function is monotonic for k_tilde near k_phys.\n        lower_bound = k_phys\n        upper_bound = k_phys * 2.0  # A reasonable starting upper bound\n        \n        # Ensure the root is bracketed before calling the solver.\n        while dispersion_residual_func(upper_bound, theta_rad, dx, dy, S_omega_sq)  0:\n            upper_bound *= 1.5\n\n        k_num = brentq(dispersion_residual_func, lower_bound, upper_bound, args=(theta_rad, dx, dy, S_omega_sq))\n        \n        # Calculate residual r_num with the solved k_num. Should be near zero.\n        kx_num = k_num * np.cos(theta_rad)\n        ky_num = k_num * np.sin(theta_rad)\n        \n        S_k_num_sq = (np.sin(kx_num * dx / 2) / dx)**2 + (np.sin(ky_num * dy / 2) / dy)**2\n        r_num = np.abs(S_omega_sq - S_k_num_sq) / S_omega_sq\n        \n        all_results.extend([r_phys, r_num, Gamma_phys_mag])\n\n    # --- Step 4: Final print statement in the exact required format ---\n    print(f\"[{','.join(f'{res:.6e}' for res in all_results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Moving beyond surfaces, the volume equivalence principle is essential for modeling fields that penetrate into inhomogeneous or lossy materials. This principle allows us to represent a volumetric scatterer with an equivalent volume current density, leading to a volume integral equation where the local strength of the current is related to physical observables like power dissipation. This advanced practice  demonstrates how to leverage this physical insight to perform model order reduction, a powerful technique for creating computationally efficient models by eliminating regions of low impact.",
            "id": "3352226",
            "problem": "Consider time-harmonic electromagnetic scattering in two spatial dimensions under transverse magnetic (TM) polarization, where the only nonzero electric field component is the out-of-plane scalar field $E_{z}(\\mathbf{r})$ with angular frequency $\\omega$. The computational domain is embedded in free space with permeability $\\mu_{0}$ and permittivity $\\varepsilon_{0}$. A spatially varying electrical conductivity $\\sigma(\\mathbf{r}) \\ge 0$ is present, and there are no impressed sources inside the inhomogeneous region other than the induced currents due to the material. A unit-amplitude plane wave $E_{z}^{\\mathrm{inc}}(\\mathbf{r}) = \\exp\\!\\left(i k_{0} \\hat{\\mathbf{x}}\\cdot \\mathbf{r}\\right)$ is incident from $-\\infty$ along $+\\hat{\\mathbf{x}}$, where $k_{0} = \\omega \\sqrt{\\mu_{0}\\varepsilon_{0}}$.\n\nStarting only from the frequency-domain Maxwell curl equations and the constitutive relations for linear media, derive the following modeling choices that are necessary for a computational realization of the volume equivalence principle in lossy media and for model reduction based on dissipative low-impact regions:\n\n1) Show that the material loss can be represented by an equivalent volume current density $\\mathbf{J}_{v}(\\mathbf{r}) = \\sigma(\\mathbf{r})\\,\\mathbf{E}(\\mathbf{r})$ so that the total field inside the lossy region satisfies a volume integral equation driven by these equivalent currents. Restrict to two-dimensional TM polarization to justify the use of the scalar free-space Green function for the two-dimensional Helmholtz equation.\n\n2) Specialize to the scalar Lippmann–Schwinger equation for $E_{z}$ in two dimensions, expressed over the compact support of $\\sigma(\\mathbf{r})$, where the complex permittivity is $\\varepsilon(\\mathbf{r}) = \\varepsilon_{0} - i \\sigma(\\mathbf{r})/\\omega$ and the contrast is $\\chi(\\mathbf{r}) = \\varepsilon(\\mathbf{r})/\\varepsilon_{0} - 1$. In the computational discretization by collocation on a uniform Cartesian grid of square cells of side length $\\Delta$, describe how to treat the self-interaction of a cell by replacing the singular Green function on the diagonal by a finite self-term that depends on the effective radius $a = \\sqrt{\\Delta^{2}/\\pi}$.\n\n3) Establish a physics-based elimination criterion for model reduction: define the time-average dissipated power in a cell $C_{j}$ as $P_{j} = \\tfrac{1}{2}\\,\\sigma_{j}\\,|E_{j}|^{2}\\,\\Delta^{2}$, where $E_{j}$ is the computed total field at the center of $C_{j}$. Given a tolerance $\\tau \\in [0,1)$, identify the set of “low-impact” cells with smallest $P_{j}$ whose cumulative sum does not exceed $\\tau$ times the total dissipated power $P_{\\mathrm{tot}} = \\sum_{j} P_{j}$. Define the reduced model by eliminating those cells, i.e., setting $\\sigma_{j} \\leftarrow 0$ (equivalently $\\chi_{j}\\leftarrow 0$) for the eliminated cells and recomputing the field.\n\n4) To quantify the impact of elimination, define the relative error using the scattered field sampled at $N_{\\mathrm{obs}}$ observation points $\\{\\mathbf{r}_{m}^{\\mathrm{obs}}\\}_{m=1}^{N_{\\mathrm{obs}}}$ on a circle of radius $R$ centered at the origin. For each observation point,\n$$\nE_{z}^{\\mathrm{sca}}(\\mathbf{r}^{\\mathrm{obs}}) \\;=\\; k_{0}^{2} \\sum_{j} \\chi_{j}\\,E_{j}\\,G(\\mathbf{r}^{\\mathrm{obs}},\\mathbf{r}_{j})\\,\\Delta^{2},\n$$\nwhere $G$ is the two-dimensional free-space scalar Green function, and the sum is over all retained cells. Let $\\mathbf{e}^{\\mathrm{full}}$ and $\\mathbf{e}^{\\mathrm{red}}$ be the vectors of scattered field samples for the full and reduced models, respectively. Define the relative error as\n$$\n\\eta \\;=\\; \\frac{\\left\\|\\mathbf{e}^{\\mathrm{red}} - \\mathbf{e}^{\\mathrm{full}}\\right\\|_{2}}{\\max\\left(\\left\\|\\mathbf{e}^{\\mathrm{full}}\\right\\|_{2},\\,\\epsilon\\right)},\n$$\nwith a small positive $\\epsilon$ to avoid division by zero. Angles must be in radians, and all physical quantities must be in the International System of Units (SI). There is no need to report units in the final numerical outputs, which are dimensionless relative errors.\n\nImplement a program that:\n- Constructs the discretized volume integral equation on the support of $\\sigma(\\mathbf{r})$ and solves for the total field $E_{z}$ inside the lossy region.\n- Computes the equivalent volume currents via $\\mathbf{J}_{v} = \\sigma \\mathbf{E}$ and the per-cell dissipated powers $P_{j}$.\n- Eliminates low-impact cells according to the tolerance $\\tau$ as defined above and recomputes the reduced-model field.\n- Evaluates and returns the relative error $\\eta$ on a circular observation contour.\n\nUse the following standardized modeling details for all test cases:\n- Two-dimensional scalar Green function $G(\\mathbf{r},\\mathbf{r}') = \\dfrac{i}{4} H_{0}^{(1)}\\!\\left(k_{0}\\left\\|\\mathbf{r}-\\mathbf{r}'\\right\\|\\right)$, with $H_{0}^{(1)}$ the Hankel function of the first kind and order zero.\n- Self-term for a square cell of area $\\Delta^{2}$: replace the diagonal Green function by $G_{\\mathrm{self}} = \\dfrac{i}{4} H_{0}^{(1)}\\!\\left(k_{0} a\\right)$ with $a = \\sqrt{\\Delta^{2}/\\pi}$.\n- Incident field $E_{z}^{\\mathrm{inc}}(\\mathbf{r}) = \\exp\\!\\left(i k_{0} x\\right)$.\n- Observation circle radius $R = 1.2\\,L$, where $L$ is the side length of the square computational window.\n- Number of observation samples $N_{\\mathrm{obs}} = 64$, uniformly distributed in angle from $0$ to $2\\pi$.\n- Vacuum constants: $\\varepsilon_{0} = 8.8541878128\\times 10^{-12}$ and $\\mu_{0} = 4\\pi \\times 10^{-7}$.\n\nYour program must evaluate the relative error $\\eta$ for each of the following four test cases and print the list of results on a single line as specified below. Each test case is defined by $(L, M, f, \\sigma(\\mathbf{r}), \\tau)$, where $L$ is the square window side length, $M$ is the number of cells per side, $f$ is the frequency, $\\sigma(\\mathbf{r})$ specifies a piecewise-constant conductivity distribution on the grid, and $\\tau$ is the elimination tolerance:\n\n- Test Case $1$ (mixed lossy inclusions):\n  - $L = 0.6\\,\\mathrm{m}$, $M = 16$, $f = 9.0\\times 10^{8}\\,\\mathrm{Hz}$, $\\tau = 0.1$.\n  - Define two lossy inclusions on the uniform grid with cell centers $(x_{i}, y_{j})$ spanning $[-L/2, L/2]^{2}$:\n    - Rectangle $\\mathcal{R}_{1}$: $x \\in [-0.20, -0.05]$, $y \\in [-0.15, 0.15]$ with $\\sigma = 0.5\\,\\mathrm{S/m}$.\n    - Disk $\\mathcal{D}_{1}$: center $(0.15, 0.0)$, radius $0.08$ with $\\sigma = 0.05\\,\\mathrm{S/m}$.\n    - Elsewhere, $\\sigma = 0$.\n\n- Test Case $2$ (no-loss medium):\n  - $L = 0.6\\,\\mathrm{m}$, $M = 16$, $f = 9.0\\times 10^{8}\\,\\mathrm{Hz}$, $\\tau = 0.5$.\n  - Everywhere $\\sigma = 0$.\n\n- Test Case $3$ (strongly localized hot spot with weak halo):\n  - $L = 0.3\\,\\mathrm{m}$, $M = 18$, $f = 2.4\\times 10^{9}\\,\\mathrm{Hz}$, $\\tau = 0.02$.\n  - Define on $[-L/2, L/2]^{2}$:\n    - Disk $\\mathcal{D}_{2}$: center $(0.0, 0.0)$, radius $0.03$ with $\\sigma = 5.0\\,\\mathrm{S/m}$.\n    - Annulus $\\mathcal{A}_{2}$: $0.03  \\sqrt{x^{2}+y^{2}} \\le 0.10$ with $\\sigma = 0.02\\,\\mathrm{S/m}$.\n    - Elsewhere, $\\sigma = 0$.\n\n- Test Case $4$ (nearly uniform weak loss):\n  - $L = 0.5\\,\\mathrm{m}$, $M = 14$, $f = 1.0\\times 10^{9}\\,\\mathrm{Hz}$, $\\tau = 0.8$.\n  - Everywhere inside $[-L/2, L/2]^{2}$, $\\sigma = 0.01\\,\\mathrm{S/m}$.\n\nNumerical requirements and output format:\n- Solve the discretized volume integral equation on the support of $\\sigma(\\mathbf{r})$ for the total field $E_{z}$, compute the per-cell dissipated powers, perform elimination according to $\\tau$, recompute the reduced model, and evaluate $\\eta$ on the observation circle for each test case.\n- All computations must be in SI units, and all angular quantities in radians.\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each relative error must be rounded to exactly six digits after the decimal point. For example, a valid output format is $[\\eta_{1},\\eta_{2},\\eta_{3},\\eta_{4}]$ with each $\\eta_{k}$ rounded to six decimal places.",
            "solution": "The user has provided a valid, well-posed problem statement in computational electromagnetics. The task involves both theoretical derivation and numerical implementation. The following text provides the requested derivations and an explanation of the computational model, fulfilling the first part of the user's request.\n\nThe problem investigates time-harmonic electromagnetic scattering from a two-dimensional lossy, non-magnetic object under transverse magnetic (TM) polarization. The goal is to derive the governing integral equation, its numerical implementation, a physics-based model reduction scheme, and an error metric to quantify the reduction's impact.\n\n**1. Derivation of the Scalar Volume Integral Equation**\n\nWe begin with the time-harmonic Maxwell's curl equations, assuming an $\\exp(i\\omega t)$ time dependence which is suppressed:\n$$\n\\nabla \\times \\mathbf{E}(\\mathbf{r}) = -i\\omega\\mathbf{B}(\\mathbf{r})\n$$\n$$\n\\nabla \\times \\mathbf{H}(\\mathbf{r}) = \\mathbf{J}_{\\text{total}}(\\mathbf{r})\n$$\nFor a linear, isotropic, non-magnetic medium, the constitutive relations are $\\mathbf{B}(\\mathbf{r}) = \\mu_0\\mathbf{H}(\\mathbf{r})$ and $\\mathbf{D}(\\mathbf{r}) = \\varepsilon(\\mathbf{r})\\mathbf{E}(\\mathbf{r})$. The total current $\\mathbf{J}_{\\text{total}}$ consists of the conduction current $\\mathbf{J}(\\mathbf{r}) = \\sigma(\\mathbf{r})\\mathbf{E}(\\mathbf{r})$ and the displacement current $i\\omega\\mathbf{D}(\\mathbf{r})$. However, it's more convenient to formulate the problem in terms of a single complex permittivity. The second curl equation becomes:\n$$\n\\nabla \\times \\mathbf{H}(\\mathbf{r}) = \\sigma(\\mathbf{r})\\mathbf{E}(\\mathbf{r}) + i\\omega\\varepsilon_0\\mathbf{E}(\\mathbf{r}) = i\\omega \\left(\\varepsilon_0 - \\frac{i\\sigma(\\mathbf{r})}{\\omega}\\right) \\mathbf{E}(\\mathbf{r})\n$$\nHere, we have assumed the background relative permittivity is unity, and all material effects are captured by the conductivity $\\sigma(\\mathbf{r})$. We define the position-dependent complex permittivity as $\\varepsilon_c(\\mathbf{r}) = \\varepsilon_0 - i\\sigma(\\mathbf{r})/\\omega$.\n\nTaking the curl of the first Maxwell equation and substituting the others, we arrive at the vector wave equation:\n$$\n\\nabla \\times \\nabla \\times \\mathbf{E}(\\mathbf{r}) - \\omega^2\\mu_0\\varepsilon_c(\\mathbf{r})\\mathbf{E}(\\mathbf{r}) = 0\n$$\nFor two-dimensional TM polarization, the electric field has only an out-of-plane component, $\\mathbf{E}(\\mathbf{r}) = E_z(x,y)\\hat{\\mathbf{z}}$, and is invariant along $z$. The operator $\\nabla \\times \\nabla \\times$ simplifies. Since $\\nabla \\cdot \\mathbf{E} = 0$ is not generally true in an inhomogeneous medium, we use the identity $\\nabla \\times \\nabla \\times \\mathbf{E} = \\nabla(\\nabla\\cdot\\mathbf{E}) - \\nabla^2\\mathbf{E}$. For a field of the form $E_z(x,y)\\hat{\\mathbf{z}}$, $\\nabla \\cdot \\mathbf{E}=0$ and the vector Laplacian becomes $\\nabla^2\\mathbf{E} = (\\partial_x^2 + \\partial_y^2)E_z \\hat{\\mathbf{z}}$. The vector wave equation thus reduces to the scalar Helmholtz equation:\n$$\n\\nabla^2 E_z(x,y) + k_c^2(x,y)E_z(x,y) = 0\n$$\nwhere $k_c^2(x,y) = \\omega^2\\mu_0\\varepsilon_c(x,y) = k_0^2(1 - i\\sigma(x,y)/(\\omega\\varepsilon_0))$ and $k_0 = \\omega\\sqrt{\\mu_0\\varepsilon_0}$ is the free-space wavenumber.\n\nTo formulate an integral equation, we employ the volume equivalence principle. We rearrange the Helmholtz equation to isolate the free-space wave operator on the left-hand side:\n$$\n\\nabla^2 E_z + k_0^2 E_z = -k_0^2 \\left(\\frac{\\varepsilon_c}{\\varepsilon_0} - 1\\right) E_z\n$$\nThe term in the parenthesis is the material contrast, $\\chi(\\mathbf{r}) = \\varepsilon_c(\\mathbf{r})/\\varepsilon_0 - 1 = -i\\sigma(\\mathbf{r})/(\\omega\\varepsilon_0)$. The equation becomes:\n$$\n(\\nabla^2 + k_0^2) E_z(\\mathbf{r}) = -k_0^2 \\chi(\\mathbf{r}) E_z(\\mathbf{r})\n$$\nThis is an inhomogeneous Helmholtz equation where the right-hand side acts as an equivalent source distribution, which exists only where $\\chi(\\mathbf{r}) \\neq 0$. This source term is directly related to the equivalent volume current density $\\mathbf{J}_v = \\sigma\\mathbf{E}$, as $-k_0^2 \\chi E_z = -\\omega^2\\mu_0\\varepsilon_0 (-i\\sigma/(\\omega\\varepsilon_0)) E_z = i\\omega\\mu_0\\sigma E_z = i\\omega\\mu_0J_{v,z}$. This confirms that the material loss, represented by $\\sigma$, drives the scattering process via an equivalent current.\n\nThe solution to this equation is the sum of a homogeneous solution (the incident field $E_z^{\\text{inc}}$) and a particular solution obtained by convolving the source with the Green's function for the 2D Helmholtz operator. The total field is thus given by the Lippmann-Schwinger equation:\n$$\nE_z(\\mathbf{r}) = E_z^{\\text{inc}}(\\mathbf{r}) + k_0^2 \\iint_{S_\\sigma} \\chi(\\mathbf{r}') E_z(\\mathbf{r}') G(\\mathbf{r}, \\mathbf{r}') \\,dS'\n$$\nwhere $S_\\sigma$ is the support of $\\sigma(\\mathbf{r})$, and $G(\\mathbf{r}, \\mathbf{r}')$ is the 2D scalar Green's function, $G(\\mathbf{r}, \\mathbf{r}') = \\frac{i}{4} H_0^{(1)}(k_0|\\mathbf{r}-\\mathbf{r}'|)$. This is the required volume integral equation.\n\n**2. Discretization and Self-Interaction**\n\nTo solve this integral equation numerically, we use the Method of Moments (MoM) with collocation. The support of the scatterer, $S_\\sigma$, is discretized into $N$ square cells $C_j$ of area $\\Delta^2$. We assume the field $E_z$ and contrast $\\chi$ are constant within each cell, taking the values at the cell centers, $E_j$ and $\\chi_j$. The integral equation becomes an algebraic one by enforcing it at the center $\\mathbf{r}_i$ of each cell:\n$$\nE_z(\\mathbf{r}_i) = E_z^{\\text{inc}}(\\mathbf{r}_i) + k_0^2 \\sum_{j=1}^N \\chi_j E_j \\int_{C_j} G(\\mathbf{r}_i, \\mathbf{r}') \\,dS'\n$$\nWe approximate the integral using a midpoint rule: $\\int_{C_j} G(\\mathbf{r}_i, \\mathbf{r}') \\,dS' \\approx G(\\mathbf{r}_i, \\mathbf{r}_j)\\Delta^2$. Enforcing this for all $i=1,\\dots,N$:\n$$\nE_i = E_i^{\\text{inc}} + k_0^2 \\Delta^2 \\sum_{j=1}^N \\chi_j G_{ij} E_j\n$$\nwhere $G_{ij} = G(\\mathbf{r}_i, \\mathbf{r}_j)$. This can be written as a linear system $\\mathbf{A}\\mathbf{E} = \\mathbf{E}^{\\text{inc}}$, where $\\mathbf{E}$ and $\\mathbf{E}^{\\text{inc}}$ are vectors of the fields at cell centers, and the matrix $\\mathbf{A}$ has elements $A_{ij} = \\delta_{ij} - k_0^2\\Delta^2 \\chi_j G_{ij}$.\n\nA problem arises for the diagonal terms ($i=j$), as the Green's function $G(\\mathbf{r}_i, \\mathbf{r}_i)$ is singular. The simple midpoint approximation is invalid. As prescribed, we replace the singular value $G_{ii}$ with a regularized self-term $G_{\\text{self}}$ obtained by evaluating the Green's function at an effective radius $a=\\sqrt{\\Delta^2/\\pi}$, which corresponds to a circle with the same area as the square cell.\n$$\nG_{ii} \\rightarrow G_{\\text{self}} = \\frac{i}{4} H_0^{(1)}(k_0 a)\n$$\nWith this correction, the matrix $\\mathbf{A}$ is fully defined, and the system can be solved for the unknown fields $E_j$.\n\n**3. Model Reduction by Power Dissipation**\n\nThe computational cost of solving the linear system scales with $N$, the number of lossy cells. Model reduction aims to reduce $N$ by eliminating cells that have a negligible impact on the overall scattered field. A physically motivated criterion for identifying such cells is their dissipated power. The time-averaged power dissipated in cell $C_j$ is:\n$$\nP_j = \\frac{1}{2} \\int_{C_j} \\operatorname{Re}\\left(\\mathbf{E} \\cdot \\mathbf{J}^*\\right) dV = \\frac{1}{2} \\int_{C_j} \\sigma(\\mathbf{r}) |\\mathbf{E}(\\mathbf{r})|^2 dV\n$$\nFor the 2D TM case, considering power per unit length and using our discretized model, this is approximated as:\n$$\nP_j = \\frac{1}{2} \\sigma_j |E_j|^2 \\Delta^2\n$$\nThe total dissipated power is $P_{\\text{tot}} = \\sum_j P_j$. The reduction algorithm proceeds as follows: First, solve the full model to find all $E_j$. Then, calculate $P_j$ for all lossy cells. Given a tolerance $\\tau \\in [0,1)$, we identify the set of \"low-impact\" cells by sorting them by $P_j$ in ascending order and find the largest subset whose cumulative power does not exceed $\\tau P_{\\text{tot}}$. These cells are then eliminated from the model (by setting their $\\sigma_j$ and thus $\\chi_j$ to zero), and the integral equation is re-solved on the smaller, reduced set of cells.\n\n**4. Error Quantification**\n\nTo assess the quality of the reduced model, we compare its predicted scattered field to that of the full model. The scattered field at an observation point $\\mathbf{r}^{\\text{obs}}$ is computed from the solved internal fields $E_j$ using the radiation integral:\n$$\nE_{z}^{\\mathrm{sca}}(\\mathbf{r}^{\\mathrm{obs}}) = k_0^2 \\sum_{j} \\chi_j E_j G(\\mathbf{r}^{\\mathrm{obs}}, \\mathbf{r}_j) \\Delta^2\n$$\nwhere the sum is over the cells retained in the model (full or reduced). We compute this field at $N_{\\text{obs}}$ points on a circle surrounding the scatterer, yielding two complex vectors of samples, $\\mathbf{e}^{\\text{full}}$ and $\\mathbf{e}^{\\text{red}}$. The relative error $\\eta$ is defined as the normalized $L_2$ norm of their difference:\n$$\n\\eta = \\frac{\\|\\mathbf{e}^{\\text{red}} - \\mathbf{e}^{\\text{full}}\\|_2}{\\max(\\|\\mathbf{e}^{\\text{full}}\\|_2, \\epsilon)}\n$$\nwhere $\\|\\mathbf{v}\\|_2 = \\sqrt{\\sum_m |v_m|^2}$ and $\\epsilon$ is a small regularization constant to prevent division by zero in the case of zero scattering. This metric provides a robust measure of the far-field error introduced by eliminating low-power cells.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import hankel1\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the results.\n    \"\"\"\n    # Define physical constants\n    EPS0 = 8.8541878128e-12\n    MU0 = 4 * np.pi * 1e-7\n    C0 = 1 / np.sqrt(EPS0 * MU0)\n    \n    # Epsilon for error normalization stability\n    epsilon_norm = 1e-16\n\n    # Test Case 1 Sigma Distribution\n    def sigma_tc1(x, y):\n        sigma = np.zeros_like(x)\n        rect1 = (-0.20 = x)  (x = -0.05)  (-0.15 = y)  (y = 0.15)\n        disk1 = (x - 0.15)**2 + y**2 = 0.08**2\n        sigma[rect1] = 0.5\n        sigma[disk1] = 0.05\n        return sigma\n\n    # Test Case 2 Sigma Distribution\n    def sigma_tc2(x, y):\n        return np.zeros_like(x)\n\n    # Test Case 3 Sigma Distribution\n    def sigma_tc3(x, y):\n        sigma = np.zeros_like(x)\n        r_sq = x**2 + y**2\n        disk2 = r_sq = 0.03**2\n        annulus2 = (r_sq > 0.03**2)  (r_sq = 0.10**2)\n        sigma[disk2] = 5.0\n        sigma[annulus2] = 0.02\n        return sigma\n\n    # Test Case 4 Sigma Distribution\n    def sigma_tc4(x, y):\n        return np.full(x.shape, 0.01)\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (0.6, 16, 9.0e8, sigma_tc1, 0.1, epsilon_norm),\n        (0.6, 16, 9.0e8, sigma_tc2, 0.5, epsilon_norm),\n        (0.3, 18, 2.4e9, sigma_tc3, 0.02, epsilon_norm),\n        (0.5, 14, 1.0e9, sigma_tc4, 0.8, epsilon_norm),\n    ]\n\n    results = []\n    for case in test_cases:\n        result = calculate_error_for_case(case, C0, EPS0)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.6f}' for r in results)}]\")\n\ndef solve_vie(k0, delta, cell_coords, chi_vec, inc_field_vec, self_term):\n    \"\"\"\n    Solves the volume integral equation for the total field inside the scatterer.\n    \"\"\"\n    N = len(cell_coords)\n    if N == 0:\n        return np.array([])\n    \n    # Build the Green's function matrix G_ij = G(r_i, r_j)\n    G_matrix = np.zeros((N, N), dtype=np.complex128)\n    dists = np.linalg.norm(cell_coords[:, np.newaxis, :] - cell_coords[np.newaxis, :, :], axis=2)\n    \n    with np.errstate(divide='ignore', invalid='ignore'):\n         G_matrix = (1j / 4) * hankel1(0, k0 * dists)\n    \n    np.fill_diagonal(G_matrix, self_term)\n\n    # Construct the system matrix A for (I - K)E = E_inc\n    # A_ij = delta_ij - k0^2 * delta^2 * G_ij * chi_j\n    A = np.identity(N, dtype=np.complex128) - (k0**2 * delta**2) * (G_matrix * chi_vec)\n    \n    total_field_vec = np.linalg.solve(A, inc_field_vec)\n    return total_field_vec\n\ndef calculate_error_for_case(case_params, C0, EPS0):\n    \"\"\"\n    Performs the full simulation pipeline for a single test case.\n    \"\"\"\n    L, M, f, sigma_dist_func, tau, epsilon = case_params\n    \n    # 1. Setup grid and physical parameters\n    omega = 2 * np.pi * f\n    k0 = omega / C0\n    delta = L / M\n\n    cell_centers_1d = np.linspace(-L / 2 + delta / 2, L / 2 - delta / 2, M)\n    xx, yy = np.meshgrid(cell_centers_1d, cell_centers_1d)\n    grid_coords = np.vstack([xx.ravel(), yy.ravel()]).T\n\n    # 2. Define sigma and chi on the grid\n    sigma_grid = sigma_dist_func(grid_coords[:, 0], grid_coords[:, 1])\n    chi_grid = np.zeros_like(sigma_grid, dtype=np.complex128)\n    if omega > 0:\n      non_zero_sigma = sigma_grid > 0\n      chi_grid[non_zero_sigma] = -1j * sigma_grid[non_zero_sigma] / (omega * EPS0)\n\n    full_model_indices = np.where(sigma_grid > 0)[0]\n    \n    if len(full_model_indices) == 0:\n        return 0.0\n\n    # 3. Solve for the full model\n    full_cell_coords = grid_coords[full_model_indices]\n    full_chi_vec = chi_grid[full_model_indices]\n    inc_field_at_cells_full = np.exp(1j * k0 * full_cell_coords[:, 0])\n    a_eff = delta / np.sqrt(np.pi)\n    g_self = (1j / 4) * hankel1(0, k0 * a_eff)\n    e_full_vec = solve_vie(k0, delta, full_cell_coords, full_chi_vec, inc_field_at_cells_full, g_self)\n    \n    # 4. Perform model reduction\n    power_j = 0.5 * sigma_grid[full_model_indices] * np.abs(e_full_vec)**2 * delta**2\n    p_total = np.sum(power_j)\n\n    if p_total == 0:\n        return 0.0\n\n    sorted_power_indices_local = np.argsort(power_j)\n    sorted_powers = power_j[sorted_power_indices_local]\n    cumulative_power = np.cumsum(sorted_powers)\n    power_threshold = tau * p_total\n    num_to_eliminate = np.sum(cumulative_power = power_threshold)\n    elimination_indices_local = sorted_power_indices_local[:num_to_eliminate]\n    eliminated_cell_original_indices = full_model_indices[elimination_indices_local]\n    reduced_model_indices = np.setdiff1d(full_model_indices, eliminated_cell_original_indices, assume_unique=True)\n\n    # 5. Solve for reduced model\n    e_red_vec = np.array([])\n    if len(reduced_model_indices) > 0:\n        red_cell_coords = grid_coords[reduced_model_indices]\n        red_chi_vec = chi_grid[reduced_model_indices]\n        inc_field_at_cells_red = np.exp(1j * k0 * red_cell_coords[:, 0])\n        e_red_vec = solve_vie(k0, delta, red_cell_coords, red_chi_vec, inc_field_at_cells_red, g_self)\n        \n    # 6. Calculate scattered fields\n    N_obs = 64\n    R_obs = 1.2 * L\n    angles = np.linspace(0, 2 * np.pi, N_obs, endpoint=False)\n    obs_coords = R_obs * np.vstack([np.cos(angles), np.sin(angles)]).T\n    \n    # Full model scattered field\n    term_full = full_chi_vec * e_full_vec\n    dist_obs_full = np.linalg.norm(obs_coords[:, np.newaxis, :] - full_cell_coords[np.newaxis, :, :], axis=2)\n    G_obs_full = (1j / 4) * hankel1(0, k0 * dist_obs_full)\n    e_sca_full_vec = (k0**2 * delta**2) * (G_obs_full @ term_full)\n\n    # Reduced model scattered field\n    e_sca_red_vec = np.zeros(N_obs, dtype=np.complex128)\n    if len(reduced_model_indices) > 0:\n        term_red = red_chi_vec * e_red_vec\n        dist_obs_red = np.linalg.norm(obs_coords[:, np.newaxis, :] - red_cell_coords[np.newaxis, :, :], axis=2)\n        G_obs_red = (1j / 4) * hankel1(0, k0 * dist_obs_red)\n        e_sca_red_vec = (k0**2 * delta**2) * (G_obs_red @ term_red)\n    \n    # 7. Compute relative error\n    norm_e_full = np.linalg.norm(e_sca_full_vec)\n    norm_diff = np.linalg.norm(e_sca_red_vec - e_sca_full_vec)\n    eta = norm_diff / max(norm_e_full, epsilon)\n    \n    return eta\n\nif __name__ == \"__main__\":\n    solve()\n```"
        }
    ]
}