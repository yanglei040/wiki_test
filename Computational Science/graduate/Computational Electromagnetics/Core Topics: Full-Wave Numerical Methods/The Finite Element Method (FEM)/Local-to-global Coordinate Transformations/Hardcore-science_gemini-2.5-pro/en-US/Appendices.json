{
    "hands_on_practices": [
        {
            "introduction": "To accurately simulate electromagnetic waves in complex geometries, the Finite Element Method (FEM) relies on mapping operators from a simple reference element (e.g., a unit cube) to the curved elements of a physical mesh. This practice guides you through the essential task of transforming the curl-curl weak form, which is fundamental for electric field ($H(\\mathrm{curl})$) formulations. You will first derive the transformation rules from first principles and then implement a numerical diagnostic to verify that the energy norm is conserved, a critical check for any robust FEM code. ",
            "id": "3324818",
            "problem": "Consider a three-dimensional computational domain obtained by a smooth, orientation-preserving mapping from a unit reference hexahedron. Let the reference coordinates be $\\boldsymbol{\\xi} = (\\xi,\\eta,\\zeta) \\in \\widehat{\\Omega} = [0,1]^3$ and the physical coordinates be $\\mathbf{x} = \\mathbf{X}(\\boldsymbol{\\xi}) \\in \\Omega$. Denote the Jacobian matrix by $J(\\boldsymbol{\\xi}) = \\frac{\\partial \\mathbf{X}}{\\partial \\boldsymbol{\\xi}}$, the Jacobian determinant by $\\det J(\\boldsymbol{\\xi})$, and the symmetric metric tensor by $g(\\boldsymbol{\\xi}) = J(\\boldsymbol{\\xi})^{\\top} J(\\boldsymbol{\\xi})$. Assume a constant magnetic permeability $\\mu > 0$.\n\nIn computational electromagnetics using the Finite Element Method (FEM), the curl-curl weak form for the electric field is the bilinear functional\n$$\na(\\mathbf{E},\\mathbf{v}) = \\int_{\\Omega} \\mu^{-1} \\left(\\nabla_{\\mathbf{x}} \\times \\mathbf{E}\\right)\\cdot\\left(\\nabla_{\\mathbf{x}} \\times \\mathbf{v}\\right)\\,d\\Omega,\n$$\nwhere $\\mathbf{E}$ is the trial field and $\\mathbf{v}$ is the test field, both belonging to the appropriate tangentially conforming function space (for example, the N\\'ed\\'elec $H(\\mathrm{curl})$ space). Under the reference-to-physical mapping, $H(\\mathrm{curl})$ fields are transformed by the covariant Piola transform: if $\\widehat{\\mathbf{E}}(\\boldsymbol{\\xi})$ and $\\widehat{\\mathbf{v}}(\\boldsymbol{\\xi})$ are fields defined on $\\widehat{\\Omega}$, then their physical counterparts are\n$$\n\\mathbf{E}(\\mathbf{x}) = J(\\boldsymbol{\\xi})^{-\\top}\\,\\widehat{\\mathbf{E}}(\\boldsymbol{\\xi}), \\qquad\n\\mathbf{v}(\\mathbf{x}) = J(\\boldsymbol{\\xi})^{-\\top}\\,\\widehat{\\mathbf{v}}(\\boldsymbol{\\xi}),\n$$\nwith $\\mathbf{x}=\\mathbf{X}(\\boldsymbol{\\xi})$.\n\nTask 1 (Derivation): Starting from the change-of-variables theorem for integrals, the chain rule for derivatives, and the covariant Piola transform, derive the transformed reference-domain weak form representation for the curl-curl bilinear functional expressed entirely in terms of the reference fields and the geometric mapping quantities $J$, $\\det J$, and $g=J^{\\top}J$. Your derivation must demonstrate how the physical-domain integral\n$$\n\\int_{\\Omega} \\mu^{-1} \\left(\\nabla_{\\mathbf{x}} \\times \\mathbf{E}\\right)\\cdot\\left(\\nabla_{\\mathbf{x}} \\times \\mathbf{v}\\right)\\,d\\Omega\n$$\nis represented on the reference domain $\\widehat{\\Omega}$ using only $\\widehat{\\mathbf{E}}$, $\\widehat{\\mathbf{v}}$, $J$, $\\det J$, and $g$.\n\nTask 2 (Diagnostic Design and Implementation): Design a numerical diagnostic that verifies energy norm equivalence across mappings. The energy norm of a field is defined by\n$$\n\\left\\|\\mathbf{E}\\right\\|_{\\mu^{-1}\\mathrm{curl}}^2 = \\int_{\\Omega} \\mu^{-1} \\left(\\nabla_{\\mathbf{x}} \\times \\mathbf{E}\\right)\\cdot\\left(\\nabla_{\\mathbf{x}} \\times \\mathbf{E}\\right)\\,d\\Omega.\n$$\nUse the derived transformed reference-domain expression to compute this norm for the mapped field, and also compute the same quantity via the physical-domain expression rewritten through the known curl transform under the mapping. Verify that these two independently computed quantities agree to within numerical quadrature error for a set of curved-element mappings. Quantify the agreement using the relative error\n$$\n\\varepsilon = \\frac{\\left|I_{\\mathrm{phys}} - I_{\\mathrm{ref}}\\right|}{\\max\\left(1,\\left|I_{\\mathrm{ref}}\\right|\\right)},\n$$\nwhere $I_{\\mathrm{phys}}$ is the energy integral computed in the physical-domain form and $I_{\\mathrm{ref}}$ is the transformed reference-domain integral.\n\nImplementation Specifications:\n- Use the following smooth trilinear-plus-bilinear mapping from $\\widehat{\\Omega}$ to $\\Omega$ with parameters $(a,b,c)$:\n$$\n\\begin{aligned}\nX_1(\\xi,\\eta,\\zeta) &= \\xi + a\\,\\xi\\,\\eta,\\\\\nX_2(\\xi,\\eta,\\zeta) &= \\eta + b\\,\\eta\\,\\zeta,\\\\\nX_3(\\xi,\\eta,\\zeta) &= \\zeta + c\\,\\xi\\,\\zeta,\n\\end{aligned}\n$$\nwith the Jacobian\n$$\nJ(\\xi,\\eta,\\zeta) = \n\\begin{bmatrix}\n1+a\\eta & a\\xi & 0\\\\\n0 & 1+b\\zeta & b\\eta\\\\\nc\\zeta & 0 & 1+c\\xi\n\\end{bmatrix}.\n$$\n- Use constant magnetic permeability $\\mu = 2.0$ in SI units; since only dimensionless relative errors are output, numerical values do not require unit annotation.\n- Use the reference field\n$$\n\\widehat{\\mathbf{E}}(\\xi,\\eta,\\zeta) = \\begin{bmatrix}\\xi^2+\\eta\\\\ \\eta^2+\\zeta\\\\ \\zeta^2+\\xi\\end{bmatrix},\n$$\nand for the energy norm diagnostic set the test field equal to the trial field, $\\widehat{\\mathbf{v}}=\\widehat{\\mathbf{E}}$.\n- Implement numerical integration on $\\widehat{\\Omega}$ with tensor-product Gauss–Legendre quadrature of sufficiently high order to capture the mapping nonlinearity. Angles are not involved; no angle units are required.\n\nTest Suite:\nCompute the relative errors $\\varepsilon$ for the following four mappings (each is a triple $(a,b,c)$):\n1. $(0.0,\\,0.0,\\,0.0)$, identity mapping (happy path).\n2. $(0.2,\\,0.1,\\,0.15)$, mildly curved element.\n3. $(0.0,\\,0.6,\\,0.0)$, anisotropic curvature along the $\\eta$–$\\zeta$ direction.\n4. $(0.5,\\,0.4,\\,0.3)$, strongly curved but well-conditioned element (boundary of aggressive curvature without degeneracy).\n\nFinal Output Format:\nYour program should produce a single line of output containing the relative errors for the four test cases as a comma-separated list enclosed in square brackets (e.g., \"[e1,e2,e3,e4]\"). Each $e_i$ must be a floating-point number.",
            "solution": "The problem is assessed to be valid as it is scientifically grounded in the principles of computational electromagnetism, is mathematically well-posed and self-consistent, and is expressed in objective, formal language. The provided data and conditions are complete and sufficient for deriving a unique solution.\n\n### Task 1: Derivation of the Reference-Domain Weak Form\n\nThe objective is to transform the curl-curl bilinear functional from the physical domain $\\Omega$ to the reference domain $\\widehat{\\Omega} = [0,1]^3$. The starting point is the physical-domain expression:\n$$\na(\\mathbf{E},\\mathbf{v}) = \\int_{\\Omega} \\mu^{-1} \\left(\\nabla_{\\mathbf{x}} \\times \\mathbf{E}\\right)\\cdot\\left(\\nabla_{\\mathbf{x}} \\times \\mathbf{v}\\right)\\,d\\Omega\n$$\nThe transformation proceeds in three steps: transforming the integral measure, transforming the curl operator, and assembling the final expression.\n\n1.  **Transformation of the Integral Measure**: The change of variables theorem relates the differential volume element $d\\Omega$ in the physical domain to the differential volume element $d\\widehat{\\Omega}$ in the reference domain via the Jacobian determinant, $\\det J$.\n    $$\n    d\\Omega = \\det J(\\boldsymbol{\\xi}) \\,d\\widehat{\\Omega}\n    $$\n    Applying this to the bilinear form yields:\n    $$\n    a(\\mathbf{E},\\mathbf{v}) = \\int_{\\widehat{\\Omega}} \\mu^{-1} \\left(\\nabla_{\\mathbf{x}} \\times \\mathbf{E}\\right)\\cdot\\left(\\nabla_{\\mathbf{x}} \\times \\mathbf{v}\\right)\\,\\det J(\\boldsymbol{\\xi})\\,d\\widehat{\\Omega}\n    $$\n\n2.  **Transformation of the Curl Operator**: The trial and test fields, $\\mathbf{E}$ and $\\mathbf{v}$, are members of the $H(\\mathrm{curl})$ function space. The problem specifies that fields $\\widehat{\\mathbf{E}}$ and $\\widehat{\\mathbf{v}}$ on the reference domain are mapped to their physical counterparts via the covariant Piola transform:\n    $$\n    \\mathbf{E}(\\mathbf{X}(\\boldsymbol{\\xi})) = J(\\boldsymbol{\\xi})^{-\\top}\\,\\widehat{\\mathbf{E}}(\\boldsymbol{\\xi})\n    $$\n    A fundamental identity in differential geometry for fields transformed in this manner relates the curl in physical coordinates ($\\nabla_{\\mathbf{x}} \\times$) to the curl in reference coordinates ($\\nabla_{\\boldsymbol{\\xi}} \\times$):\n    $$\n    \\left(\\nabla_{\\mathbf{x}} \\times \\mathbf{E}\\right)(\\mathbf{X}(\\boldsymbol{\\xi})) = \\frac{J(\\boldsymbol{\\xi})}{\\det J(\\boldsymbol{\\xi})} \\left(\\nabla_{\\boldsymbol{\\xi}} \\times \\widehat{\\mathbf{E}}(\\boldsymbol{\\xi})\\right)\n    $$\n    The same relation holds for the test function $\\mathbf{v}$ and its reference counterpart $\\widehat{\\mathbf{v}}$.\n\n3.  **Assembly of the Transformed Integrand**: We now substitute the transformed curl expression into the dot product within the integral.\n    $$\n    \\left(\\nabla_{\\mathbf{x}} \\times \\mathbf{E}\\right)\\cdot\\left(\\nabla_{\\mathbf{x}} \\times \\mathbf{v}\\right) = \\left[ \\frac{J}{\\det J} \\left(\\nabla_{\\boldsymbol{\\xi}} \\times \\widehat{\\mathbf{E}}\\right) \\right] \\cdot \\left[ \\frac{J}{\\det J} \\left(\\nabla_{\\boldsymbol{\\xi}} \\times \\widehat{\\mathbf{v}}\\right) \\right]\n    $$\n    This simplifies to:\n    $$\n    = \\frac{1}{(\\det J)^2} \\left[ J \\left(\\nabla_{\\boldsymbol{\\xi}} \\times \\widehat{\\mathbf{E}}\\right) \\right] \\cdot \\left[ J \\left(\\nabla_{\\boldsymbol{\\xi}} \\times \\widehat{\\mathbf{v}}\\right) \\right]\n    $$\n    Using the vector identity $(A\\mathbf{u}) \\cdot (A\\mathbf{w}) = (A\\mathbf{u})^{\\top}(A\\mathbf{w}) = \\mathbf{u}^{\\top} A^{\\top} A \\mathbf{w} = \\mathbf{u} \\cdot (A^{\\top}A\\mathbf{w})$, and recalling the definition of the metric tensor $g = J^{\\top}J$, the dot product becomes:\n    $$\n    = \\frac{1}{(\\det J)^2} \\left[ \\left(\\nabla_{\\boldsymbol{\\xi}} \\times \\widehat{\\mathbf{E}}\\right) \\cdot \\left(g \\left(\\nabla_{\\boldsymbol{\\xi}} \\times \\widehat{\\mathbf{v}}\\right)\\right) \\right]\n    $$\n    Finally, substituting this expression for the dot product and the transformed integral measure into the bilinear form gives the complete reference-domain weak form:\n    $$\n    a(\\mathbf{E},\\mathbf{v}) = \\int_{\\widehat{\\Omega}} \\mu^{-1} \\left\\{ \\frac{1}{(\\det J)^2} \\left[ \\left(\\nabla_{\\boldsymbol{\\xi}} \\times \\widehat{\\mathbf{E}}\\right) \\cdot \\left(g \\left(\\nabla_{\\boldsymbol{\\xi}} \\times \\widehat{\\mathbf{v}}\\right)\\right) \\right] \\right\\} \\det J \\,d\\widehat{\\Omega}\n    $$\n    One factor of $\\det J$ cancels, yielding the final result:\n    $$\n    a(\\mathbf{E},\\mathbf{v}) = \\int_{\\widehat{\\Omega}} \\mu^{-1} \\frac{1}{\\det J} \\left[ \\left(\\nabla_{\\boldsymbol{\\xi}} \\times \\widehat{\\mathbf{E}}\\right) \\cdot \\left(g \\left(\\nabla_{\\boldsymbol{\\xi}} \\times \\widehat{\\mathbf{v}}\\right)\\right) \\right] \\,d\\widehat{\\Omega}\n    $$\n\n### Task 2: Diagnostic Design\n\nThe diagnostic task is to verify the equivalence of the energy norm computation across different but analytically identical formulations. The energy norm squared is given by $\\|\\mathbf{E}\\|_{\\mu^{-1}\\mathrm{curl}}^2 = a(\\mathbf{E},\\mathbf{E})$. We compute this value in two ways.\n\n1.  **Reference-Domain Formulation ($I_{\\mathrm{ref}}$)**: This approach directly implements the derived reference-domain expression with $\\widehat{\\mathbf{v}}=\\widehat{\\mathbf{E}}$:\n    $$\n    I_{\\mathrm{ref}} = \\int_{\\widehat{\\Omega}} \\mu^{-1} \\frac{1}{\\det J} \\left[ \\left(\\nabla_{\\boldsymbol{\\xi}} \\times \\widehat{\\mathbf{E}}\\right) \\cdot \\left(g \\left(\\nabla_{\\boldsymbol{\\xi}} \\times \\widehat{\\mathbf{E}}\\right)\\right) \\right] \\,d\\widehat{\\Omega}\n    $$\n\n2.  **Physical-Domain Formulation ($I_{\\mathrm{phys}}$)**: This approach starts from the physical-domain definition and transforms it for computation on the reference grid:\n    $$\n    I_{\\mathrm{phys}} = \\int_{\\Omega} \\mu^{-1} \\lvert\\nabla_{\\mathbf{x}} \\times \\mathbf{E}\\rvert^2 \\,d\\Omega = \\int_{\\widehat{\\Omega}} \\mu^{-1} \\lvert\\left(\\nabla_{\\mathbf{x}} \\times \\mathbf{E}\\right)(\\mathbf{X}(\\boldsymbol{\\xi}))\\rvert^2 \\det J \\,d\\widehat{\\Omega}\n    $$\n    Using the curl transformation identity, the integrand is computed as:\n    $$\n    \\lvert\\nabla_{\\mathbf{x}} \\times \\mathbf{E}\\rvert^2 = \\left\\lvert \\frac{J}{\\det J} \\left(\\nabla_{\\boldsymbol{\\xi}} \\times \\widehat{\\mathbf{E}}\\right) \\right\\rvert^2 = \\frac{1}{(\\det J)^2} \\left[ J \\left(\\nabla_{\\boldsymbol{\\xi}} \\times \\widehat{\\mathbf{E}}\\right) \\right] \\cdot \\left[ J \\left(\\nabla_{\\boldsymbol{\\xi}} \\times \\widehat{\\mathbf{E}}\\right) \\right] = \\frac{1}{(\\det J)^2} \\left[ \\left(\\nabla_{\\boldsymbol{\\xi}} \\times \\widehat{\\mathbf{E}}\\right) \\cdot \\left(g \\left(\\nabla_{\\boldsymbol{\\xi}} \\times \\widehat{\\mathbf{E}}\\right)\\right) \\right]\n    $$\n    Substituting this back into the expression for $I_{\\mathrm{phys}}$ demonstrates its analytical equivalence to $I_{\\mathrm{ref}}$. The numerical diagnostic computes both $I_{\\mathrm{ref}}$ and $I_{\\mathrm{phys}}$ independently using their distinct computational formulas and verifies their agreement.\n\nFor the specified reference field $\\widehat{\\mathbf{E}}(\\xi,\\eta,\\zeta) = [\\xi^2+\\eta, \\eta^2+\\zeta, \\zeta^2+\\xi]^{\\top}$, its curl in reference coordinates is a constant vector:\n$$\n\\nabla_{\\boldsymbol{\\xi}} \\times \\widehat{\\mathbf{E}} = \\begin{bmatrix} \\frac{\\partial}{\\partial\\eta}(\\zeta^2+\\xi) - \\frac{\\partial}{\\partial\\zeta}(\\eta^2+\\zeta) \\\\ \\frac{\\partial}{\\partial\\zeta}(\\xi^2+\\eta) - \\frac{\\partial}{\\partial\\xi}(\\zeta^2+\\xi) \\\\ \\frac{\\partial}{\\partial\\xi}(\\eta^2+\\zeta) - \\frac{\\partial}{\\partial\\eta}(\\xi^2+\\eta) \\end{bmatrix} = \\begin{bmatrix} 0-1 \\\\ 0-1 \\\\ 0-1 \\end{bmatrix} = \\begin{bmatrix} -1 \\\\ -1 \\\\ -1 \\end{bmatrix}\n$$\nThe integrals for $I_{\\mathrm{ref}}$ and $I_{\\mathrm{phys}}$ are computed numerically over the reference cube $\\widehat{\\Omega}=[0,1]^3$ using a tensor-product Gauss-Legendre quadrature rule. The agreement between the two computed values is measured by the relative error:\n$$\n\\varepsilon = \\frac{\\left|I_{\\mathrm{phys}} - I_{\\mathrm{ref}}\\right|}{\\max\\left(1,\\left|I_{\\mathrm{ref}}\\right|\\right)}\n$$\nA small value of $\\varepsilon$, close to machine precision, confirms the correctness of the implementation of the geometric mapping quantities and the transformation formulas.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the relative error between two methods of calculating the\n    curl-curl energy norm for a set of test cases.\n    \"\"\"\n    \n    # Test cases defined as tuples (a, b, c)\n    test_cases = [\n        (0.0, 0.0, 0.0),\n        (0.2, 0.1, 0.15),\n        (0.0, 0.6, 0.0),\n        (0.5, 0.4, 0.3),\n    ]\n\n    # Global parameters\n    mu = 2.0\n    quad_order = 10  # Sufficiently high for the rational integrand\n\n    # The curl of the reference field is a constant vector.\n    # E_hat = [xi^2+eta, eta^2+zeta, zeta^2+xi]\n    # curl(E_hat) = [d(E3)/d(eta) - d(E2)/d(zeta), d(E1)/d(zeta) - d(E3)/d(xi), d(E2)/d(xi) - d(E1)/d(eta)]\n    #             = [0 - 1, 0 - 1, 0 - 1] = [-1, -1, -1]\n    C_hat = np.array([-1.0, -1.0, -1.0])\n\n    results = []\n    for a, b, c in test_cases:\n        error = compute_error_for_mapping(a, b, c, mu, C_hat, quad_order)\n        results.append(f\"{error:.15e}\")\n\n    print(f\"[{','.join(results)}]\")\n\ndef get_jacobian(xi, eta, zeta, a, b, c):\n    \"\"\"\n    Computes the Jacobian matrix of the mapping at a point (xi, eta, zeta).\n    \"\"\"\n    J = np.zeros((3, 3))\n    J[0, 0] = 1.0 + a * eta\n    J[0, 1] = a * xi\n    J[1, 1] = 1.0 + b * zeta\n    J[1, 2] = b * eta\n    J[2, 0] = c * zeta\n    J[2, 2] = 1.0 + c * xi\n    return J\n\ndef compute_error_for_mapping(a, b, c, mu, C_hat, quad_order):\n    \"\"\"\n    Computes I_ref, I_phys and the relative error for a given mapping.\n    \"\"\"\n    # Get Gauss-Legendre quadrature points and weights for [-1, 1]\n    points, weights = np.polynomial.legendre.leggauss(quad_order)\n    \n    # Scale points and weights for the interval [0, 1]\n    q_points = 0.5 * (points + 1.0)\n    q_weights = 0.5 * weights\n    \n    I_ref = 0.0\n    I_phys = 0.0\n    \n    for i in range(quad_order):\n        xi = q_points[i]\n        wi = q_weights[i]\n        for j in range(quad_order):\n            eta = q_points[j]\n            wj = q_weights[j]\n            for k in range(quad_order):\n                zeta = q_points[k]\n                wk = q_weights[k]\n                \n                # Compute geometric quantities at the quadrature point\n                J = get_jacobian(xi, eta, zeta, a, b, c)\n                detJ = np.linalg.det(J)\n                g = J.T @ J\n\n                # --- Calculation for I_ref ---\n                # Integrand: (1/mu) * (1/detJ) * [ C_hat . (g @ C_hat) ]\n                g_C_hat = g @ C_hat\n                C_g_C = C_hat @ g_C_hat\n                integrand_ref = (1.0 / mu) * (1.0 / detJ) * C_g_C\n                I_ref += integrand_ref * wi * wj * wk\n\n                # --- Calculation for I_phys ---\n                # Integrand: (1/mu) * | (J @ C_hat) / detJ |^2 * detJ\n                C_phys = (1.0 / detJ) * (J @ C_hat)\n                norm_sq_C_phys = C_phys @ C_phys\n                integrand_phys = (1.0 / mu) * norm_sq_C_phys * detJ\n                I_phys += integrand_phys * wi * wj * wk\n\n    # Compute relative error\n    error = np.abs(I_phys - I_ref) / np.max([1.0, np.abs(I_ref)])\n    return error\n\nif __name__ == '__main__':\n    solve()\n\n```"
        },
        {
            "introduction": "Building on the transformation of curl-conforming fields, this practice addresses the different but equally important requirements for divergence-conforming ($H(\\mathrm{div})$) fields, such as the magnetic flux density $\\mathbf{B}$. Preserving the normal flux across element boundaries is paramount for these fields to ensure the solenoidal constraint ($\\nabla \\cdot \\mathbf{B} = 0$) is satisfied discretely. This exercise requires you to derive the correct transformation rule (the Piola transform) and then implement a numerical test that highlights the non-physical divergence error introduced by incorrectly applying the mapping used for $H(\\mathrm{curl})$ fields. ",
            "id": "3324788",
            "problem": "A computational electromagnetics code must correctly map local basis functions in the Sobolev space of square-integrable vector fields with square-integrable divergence (H(div)) from a reference element to a physical element to preserve normal fluxes and elementwise divergence in the sense of Gaussian quadrature. Starting only from the following fundamental base and core definitions, derive the local-to-global field mapping and then implement a numerical verification:\n\n1. The fundamental theorem of calculus for vector fields (divergence theorem) states that for any sufficiently smooth vector field $\\mathbf{v}$ and domain $K$ with boundary $\\partial K$ and outward unit normal $\\mathbf{n}$,\n$$\n\\int_{K} \\nabla \\cdot \\mathbf{v} \\, d\\mathbf{x} = \\int_{\\partial K} \\mathbf{v} \\cdot \\mathbf{n} \\, ds.\n$$\n\n2. Let $\\hat{K}$ be a reference element with coordinates $\\hat{\\mathbf{x}} = (\\hat{\\xi}, \\hat{\\eta})$ and let $F : \\hat{K} \\to K$ be a differentiable bijection to a physical element $K$ with coordinates $\\mathbf{x} = (x, y)$, with Jacobian matrix $J(\\hat{\\mathbf{x}}) = \\frac{\\partial \\mathbf{x}}{\\partial \\hat{\\mathbf{x}}}$ and determinant $\\det J(\\hat{\\mathbf{x}})$. The change-of-variables formula for integrals is\n$$\n\\int_{K} g(\\mathbf{x}) \\, d\\mathbf{x} = \\int_{\\hat{K}} g(F(\\hat{\\mathbf{x}})) \\, \\det J(\\hat{\\mathbf{x}}) \\, d\\hat{\\mathbf{x}}.\n$$\n\n3. For the purpose of curl-conforming fields, one often uses the contravariant mapping involving $J^{-T}$. In this problem, you must analyze the consequences of incorrectly applying such a mapping to a divergence-conforming field.\n\nTasks:\n\nA. Starting from items (1)–(2) and the requirement that the normal flux across any mapped edge or face is preserved under transformation, derive the unique form of the local-to-global mapping for an H(div)-conforming magnetic flux $\\mathbf{B}$ that ensures preservation of discrete normal fluxes and elementwise divergence under mesh mappings. Then, using the divergence theorem and change of variables, derive the corresponding divergence transformation law.\n\nB. Consider the following reference vector field on the unit square reference element $\\hat{K} = [0,1]^2$:\n$$\n\\hat{\\mathbf{B}}(\\hat{\\xi}, \\hat{\\eta}) =\n\\begin{bmatrix}\na \\, \\hat{\\xi} + b \\, \\hat{\\eta} + c \\\\\nd \\, \\hat{\\xi} + e \\, \\hat{\\eta} + f\n\\end{bmatrix},\n$$\nwith parameters\n$$\na = 2.0,\\quad b = 0.1,\\quad c = 0.3,\\quad d = -0.5,\\quad e = -1.0,\\quad f = 0.7.\n$$\nNote that the reference divergence is constant:\n$$\n\\nabla_{\\hat{\\mathbf{x}}} \\cdot \\hat{\\mathbf{B}} = a + e.\n$$\n\nC. You must evaluate, for each physical element, the following two integrals:\n- The elementwise divergence integral computed with the correct H(div) local-to-global mapping from part A, denoted $I_{\\mathrm{correct}}(K) = \\int_{K} \\nabla_{\\mathbf{x}} \\cdot \\mathbf{B}_{\\mathrm{correct}} \\, d\\mathbf{x}$.\n- The elementwise divergence integral computed if one incorrectly uses the contravariant mapping $\\mathbf{B}_{\\mathrm{wrong}} = J^{-T} \\hat{\\mathbf{B}}$ for a divergence-conforming field, denoted $I_{\\mathrm{wrong}}(K) = \\int_{K} \\nabla_{\\mathbf{x}} \\cdot \\mathbf{B}_{\\mathrm{wrong}} \\, d\\mathbf{x}$.\n\nFor numerical evaluation, use tensor-product Gaussian quadrature of sufficiently high order over $\\hat{K}$ and the change-of-variables formula to integrate over $K$.\n\nDefine the per-element divergence error as\n$$\nE_{\\mathrm{correct}}(K) = I_{\\mathrm{correct}}(K) - \\int_{\\hat{K}} \\nabla_{\\hat{\\mathbf{x}}} \\cdot \\hat{\\mathbf{B}} \\, d\\hat{\\mathbf{x}}, \\qquad\nE_{\\mathrm{wrong}}(K) = I_{\\mathrm{wrong}}(K) - \\int_{\\hat{K}} \\nabla_{\\hat{\\mathbf{x}}} \\cdot \\hat{\\mathbf{B}} \\, d\\hat{\\mathbf{x}}.\n$$\n\nD. Use the following test suite of four physical elements $K$ produced by mappings $F$ from $\\hat{K} = [0,1]^2$:\n\n1. Element $K_0$ (affine, isotropic scaling): $\\mathbf{x} = A_0 \\hat{\\mathbf{x}} + \\mathbf{b}_0$ with\n$$\nA_0 = \\begin{bmatrix} s & 0 \\\\ 0 & s \\end{bmatrix},\\quad s = 1.3,\\quad\n\\mathbf{b}_0 = \\begin{bmatrix} 0.2 \\\\ -0.6 \\end{bmatrix}.\n$$\n\n2. Element $K_1$ (affine, anisotropic scaling): $\\mathbf{x} = A_1 \\hat{\\mathbf{x}} + \\mathbf{b}_1$ with\n$$\nA_1 = \\begin{bmatrix} 2.0 & 0.0 \\\\ 0.0 & 0.5 \\end{bmatrix},\\quad\n\\mathbf{b}_1 = \\begin{bmatrix} 0.3 \\\\ -0.2 \\end{bmatrix}.\n$$\n\n3. Element $K_2$ (affine, shear and rotation): $\\mathbf{x} = A_2 \\hat{\\mathbf{x}} + \\mathbf{b}_2$ with\n$$\nA_2 = \\begin{bmatrix} 1.1 & 0.2 \\\\ -0.3 & 1.5 \\end{bmatrix},\\quad\n\\mathbf{b}_2 = \\begin{bmatrix} 0.1 \\\\ 0.5 \\end{bmatrix}.\n$$\n\n4. Element $K_3$ (bilinear quadrilateral mapping). Let the reference nodes of $\\hat{K}$ be at $(0,0)$, $(1,0)$, $(1,1)$, $(0,1)$ with corresponding physical vertices\n$$\n\\mathbf{P}_1 = \\begin{bmatrix} 0.0 \\\\ 0.0 \\end{bmatrix},\\quad\n\\mathbf{P}_2 = \\begin{bmatrix} 1.8 \\\\ 0.2 \\end{bmatrix},\\quad\n\\mathbf{P}_3 = \\begin{bmatrix} 2.2 \\\\ 1.1 \\end{bmatrix},\\quad\n\\mathbf{P}_4 = \\begin{bmatrix} -0.1 \\\\ 0.9 \\end{bmatrix}.\n$$\nUse the standard bilinear shape functions over $\\hat{K}$ to define $F$.\n\nE. Implement a program that:\n- Uses Gaussian quadrature of sufficiently high order over $\\hat{K}$ to compute $I_{\\mathrm{correct}}(K_i)$ and $I_{\\mathrm{wrong}}(K_i)$ for $i \\in \\{0,1,2,3\\}$.\n- Reports the list of eight floating-point numbers\n$$\n\\left[\nE_{\\mathrm{correct}}(K_0),\\, E_{\\mathrm{wrong}}(K_0),\\,\nE_{\\mathrm{correct}}(K_1),\\, E_{\\mathrm{wrong}}(K_1),\\,\nE_{\\mathrm{correct}}(K_2),\\, E_{\\mathrm{wrong}}(K_2),\\,\nE_{\\mathrm{correct}}(K_3),\\, E_{\\mathrm{wrong}}(K_3)\n\\right],\n$$\nrounded to ten decimal places.\n\nAngle units are not applicable, and no physical units are required for this computation.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[r0,r1,r2,r3,r4,r5,r6,r7]\").",
            "solution": "The user requires a derivation of the local-to-global mapping for divergence-conforming (H(div)) vector fields and a numerical verification of its properties compared to an incorrect mapping.\n\n### Part A: Derivation of H(div) Local-to-Global Mapping\n\nThe fundamental requirement for an H(div)-conforming basis function is the preservation of normal flux across element boundaries. Let $\\hat{K}$ be a reference element with coordinates $\\hat{\\mathbf{x}}$, and $K$ be a physical element with coordinates $\\mathbf{x}$. The mapping between them is given by $\\mathbf{x} = F(\\hat{\\mathbf{x}})$. Let $\\hat{\\mathbf{B}}$ be a vector field on $\\hat{K}$, and $\\mathbf{B}$ be the corresponding field on $K$.\n\nThe condition of flux preservation across a corresponding edge/face $\\hat{e} \\subset \\partial\\hat{K}$ and $e = F(\\hat{e}) \\subset \\partial K$ is:\n$$\n\\int_{e} \\mathbf{B} \\cdot \\mathbf{n} \\, ds = \\int_{\\hat{e}} \\hat{\\mathbf{B}} \\cdot \\hat{\\mathbf{n}} \\, d\\hat{s}\n$$\nwhere $\\mathbf{n}$ and $\\hat{\\mathbf{n}}$ are the outward unit normal vectors, and $ds$ and $d\\hat{s}$ are the differential arc lengths/surface areas on $e$ and $\\hat{e}$ respectively.\n\nTo relate the integrals, we use Nanson's formula, which connects the normal vectors and surface elements under the mapping $F$:\n$$\n\\mathbf{n} \\, ds = \\det(J) J^{-T} \\hat{\\mathbf{n}} \\, d\\hat{s}\n$$\nwhere $J = \\frac{\\partial \\mathbf{x}}{\\partial \\hat{\\mathbf{x}}}$ is the Jacobian matrix of the mapping $F$, and $J^{-T} = (J^{-1})^T$.\n\nSubstituting this into the left-hand side of the flux preservation equation and changing variables from $e$ to $\\hat{e}$:\n$$\n\\int_{\\hat{e}} \\mathbf{B}(F(\\hat{\\mathbf{x}})) \\cdot (\\det(J) J^{-T} \\hat{\\mathbf{n}}) \\, d\\hat{s} = \\int_{\\hat{e}} \\hat{\\mathbf{B}}(\\hat{\\mathbf{x}}) \\cdot \\hat{\\mathbf{n}} \\, d\\hat{s}\n$$\nFor this equality to hold for any choice of edge $\\hat{e}$ and field $\\hat{\\mathbf{B}}$, the vector terms inside the dot product with $\\hat{\\mathbf{n}}$ must be equal:\n$$\n\\mathbf{B}(F(\\hat{\\mathbf{x}}))^T \\det(J) J^{-T} = \\hat{\\mathbf{B}}(\\hat{\\mathbf{x}})^T\n$$\nTaking the transpose of both sides gives:\n$$\nJ^{-1} \\det(J) \\mathbf{B}(F(\\hat{\\mathbf{x}})) = \\hat{\\mathbf{B}}(\\hat{\\mathbf{x}})\n$$\nSolving for $\\mathbf{B}$, we obtain the correct local-to-global mapping, known as the **contravariant Piola transformation**:\n$$\n\\mathbf{B}_{\\mathrm{correct}}(\\mathbf{x}) = \\frac{1}{\\det J(\\hat{\\mathbf{x}})} J(\\hat{\\mathbf{x}}) \\hat{\\mathbf{B}}(\\hat{\\mathbf{x}})\n$$\nwhere $\\mathbf{x} = F(\\hat{\\mathbf{x}})$.\n\nNext, we derive the divergence transformation law. We start by applying the divergence theorem to the flux preservation equation:\n$$\n\\int_{K} \\nabla_{\\mathbf{x}} \\cdot \\mathbf{B} \\, d\\mathbf{x} = \\int_{\\partial K} \\mathbf{B} \\cdot \\mathbf{n} \\, ds = \\int_{\\partial \\hat{K}} \\hat{\\mathbf{B}} \\cdot \\hat{\\mathbf{n}} \\, d\\hat{s} = \\int_{\\hat{K}} \\nabla_{\\hat{\\mathbf{x}}} \\cdot \\hat{\\mathbf{B}} \\, d\\hat{\\mathbf{x}}\n$$\nThis establishes the crucial identity that the total divergence is preserved for the entire element.\n$$\n\\int_{K} \\nabla_{\\mathbf{x}} \\cdot \\mathbf{B} \\, d\\mathbf{x} = \\int_{\\hat{K}} \\nabla_{\\hat{\\mathbf{x}}} \\cdot \\hat{\\mathbf{B}} \\, d\\hat{\\mathbf{x}}\n$$\nNow, we apply the change-of-variables formula to the left-hand side integral:\n$$\n\\int_{K} (\\nabla_{\\mathbf{x}} \\cdot \\mathbf{B}) \\, d\\mathbf{x} = \\int_{\\hat{K}} (\\nabla_{\\mathbf{x}} \\cdot \\mathbf{B})(F(\\hat{\\mathbf{x}})) \\det J(\\hat{\\mathbf{x}}) \\, d\\hat{\\mathbf{x}}\n$$\nComparing this with the previous result, we have:\n$$\n\\int_{\\hat{K}} (\\nabla_{\\mathbf{x}} \\cdot \\mathbf{B})(F(\\hat{\\mathbf{x}})) \\det J(\\hat{\\mathbf{x}}) \\, d\\hat{\\mathbf{x}} = \\int_{\\hat{K}} \\nabla_{\\hat{\\mathbf{x}}} \\cdot \\hat{\\mathbf{B}}(\\hat{\\mathbf{x}}) \\, d\\hat{\\mathbf{x}}\n$$\nSince this must hold for any arbitrary sub-domain within $\\hat{K}$, the integrands must be equal. This gives the divergence transformation law:\n$$\n(\\nabla_{\\mathbf{x}} \\cdot \\mathbf{B}_{\\mathrm{correct}})(F(\\hat{\\mathbf{x}})) = \\frac{1}{\\det J(\\hat{\\mathbf{x}})} \\nabla_{\\hat{\\mathbf{x}}} \\cdot \\hat{\\mathbf{B}}(\\hat{\\mathbf{x}})\n$$\n\n### Part B/C: Numerical Evaluation Strategy\n\nWe need to compute two types of integrals, $I_{\\mathrm{correct}}(K)$ and $I_{\\mathrm{wrong}}(K)$, and their errors relative to the reference divergence integral.\n\nThe reference divergence is $\\nabla_{\\hat{\\mathbf{x}}} \\cdot \\hat{\\mathbf{B}} = a + e = 2.0 - 1.0 = 1.0$, which is constant. The reference integral is:\n$$\n\\int_{\\hat{K}} \\nabla_{\\hat{\\mathbf{x}}} \\cdot \\hat{\\mathbf{B}} \\, d\\hat{\\mathbf{x}} = \\int_0^1 \\int_0^1 (a+e) \\, d\\hat{\\xi}d\\hat{\\eta} = a+e = 1.0\n$$\n\nFor the **correct mapping**:\nUsing the derived relations, the integral of the divergence for the correct mapping is:\n$$\nI_{\\mathrm{correct}}(K) = \\int_K \\nabla_{\\mathbf{x}} \\cdot \\mathbf{B}_{\\mathrm{correct}} \\, d\\mathbf{x} = \\int_{\\hat{K}} \\nabla_{\\hat{\\mathbf{x}}} \\cdot \\hat{\\mathbf{B}} \\, d\\hat{\\mathbf{x}} = 1.0\n$$\nTherefore, the error $E_{\\mathrm{correct}}(K) = I_{\\mathrm{correct}}(K) - \\int_{\\hat{K}} \\nabla_{\\hat{\\mathbf{x}}} \\cdot \\hat{\\mathbf{B}} \\, d\\hat{\\mathbf{x}} = 1.0 - 1.0 = 0.0$ analytically for any valid mapping $F$.\n\nFor the **incorrect mapping**, $\\mathbf{B}_{\\mathrm{wrong}} = J^{-T} \\hat{\\mathbf{B}}$:\nThe integral to compute is $I_{\\mathrm{wrong}}(K) = \\int_K \\nabla_{\\mathbf{x}} \\cdot \\mathbf{B}_{\\mathrm{wrong}} \\, d\\mathbf{x}$. A direct calculation of $\\nabla_{\\mathbf{x}} \\cdot \\mathbf{B}_{\\mathrm{wrong}}$ involves derivatives of the Jacobian components, which is complex for non-affine maps. A more elegant method uses the divergence theorem on the reference element.\nFirst, change variables to $\\hat{K}$:\n$$\nI_{\\mathrm{wrong}}(K) = \\int_{\\hat{K}} (\\nabla_{\\mathbf{x}} \\cdot \\mathbf{B}_{\\mathrm{wrong}})(F(\\hat{\\mathbf{x}})) \\det J \\, d\\hat{\\mathbf{x}}\n$$\nThe Piola identity states that for any vector field $\\mathbf{V}$, $(\\nabla_{\\mathbf{x}} \\cdot \\mathbf{V}) \\det J = \\nabla_{\\hat{\\mathbf{x}}} \\cdot ((\\det J) J^{-1} \\mathbf{V})$. Applying this with $\\mathbf{V} = \\mathbf{B}_{\\mathrm{wrong}} = J^{-T} \\hat{\\mathbf{B}}$:\n$$\nI_{\\mathrm{wrong}}(K) = \\int_{\\hat{K}} \\nabla_{\\hat{\\mathbf{x}}} \\cdot \\left( (\\det J) J^{-1} (J^{-T} \\hat{\\mathbf{B}}) \\right) \\, d\\hat{\\mathbf{x}}\n$$\nLet $\\mathbf{W} = (\\det J) J^{-1} J^{-T} \\hat{\\mathbf{B}}$. The integral becomes $\\int_{\\hat{K}} \\nabla_{\\hat{\\mathbf{x}}} \\cdot \\mathbf{W} \\, d\\hat{\\mathbf{x}}$. By the divergence theorem on the reference element $\\hat{K}$:\n$$\nI_{\\mathrm{wrong}}(K) = \\int_{\\partial \\hat{K}} \\mathbf{W} \\cdot \\hat{\\mathbf{n}} \\, d\\hat{s}\n$$\nThis transforms the 2D domain integral into a sum of four 1D line integrals over the edges of the unit square $\\hat{K} = [0,1]^2$. These 1D integrals can be accurately computed using Gaussian quadrature. We will implement this boundary integral method for all four test cases.\n\nThe error for the wrong mapping is then $E_{\\mathrm{wrong}}(K) = I_{\\mathrm{wrong}}(K) - 1.0$.\n\n### Part D/E: Implementation Details\n\nThe implementation will proceed as follows:\n1.  Define the constants and the reference vector field $\\hat{\\mathbf{B}}$.\n2.  Obtain Gaussian quadrature points and weights for the interval $[0,1]$. A sufficiently high order (e.g., $20$ points) is chosen to accurately integrate the rational functions that arise in the bilinear case.\n3.  For each test case, define a function that returns the Jacobian matrix $J(\\hat{\\xi}, \\hat{\\eta})$. For affine maps, this function returns a constant matrix. For the bilinear map, it computes the Jacobian based on the standard bilinear shape functions.\n4.  Implement a function `calculate_I_wrong` that computes the boundary integral $\\int_{\\partial \\hat{K}} \\mathbf{W} \\cdot \\hat{\\mathbf{n}} \\, d\\hat{s}$ by summing the results of Gaussian quadrature over the four edges of the unit square.\n5.  Iterate through the four test cases:\n    -   $E_{\\mathrm{correct}}(K_i)$ is analytically $0.0$.\n    -   Call `calculate_I_wrong` with the appropriate Jacobian function to find $I_{\\mathrm{wrong}}(K_i)$.\n    -   Calculate $E_{\\mathrm{wrong}}(K_i) = I_{\\mathrm{wrong}}(K_i) - 1.0$.\n6.  Collect and format the eight resulting error values as a single list.\n\nThe expected results for the affine cases can be pre-calculated analytically to verify the numerical implementation. For an affine map, $I_{\\mathrm{wrong}}(K) = \\det(A) \\text{Tr}(A^{-1} A^{-T} \\hat{J}_{\\hat{\\mathbf{B}}})$, where $\\hat{J}_{\\hat{\\mathbf{B}}}$ is the Jacobian of $\\hat{\\mathbf{B}}$.\n-   For $K_0$ (isotropic scaling), $\\mathbf{B}_{\\mathrm{wrong}} = \\mathbf{B}_{\\mathrm{correct}}$, so $I_{\\mathrm{wrong}}(K_0)=1.0$ and $E_{\\mathrm{wrong}}(K_0)=0.0$.\n-   For $K_1$ (anisotropic scaling), calculation yields $I_{\\mathrm{wrong}}(K_1) = -3.5$, so $E_{\\mathrm{wrong}}(K_1) = -4.5$.\n-   For $K_2$ (shear), calculation yields $I_{\\mathrm{wrong}}(K_2) \\approx 1.8643603160$, so $E_{\\mathrm{wrong}}(K_2) \\approx 0.8643603160$.\n\nThese values will serve as a cross-check for the general boundary integral implementation.",
            "answer": "```python\nimport numpy as np\nfrom scipy.special import roots_legendre\n\ndef solve():\n    \"\"\"\n    Derives and verifies the local-to-global mapping for H(div) fields.\n    \"\"\"\n    # Part B: Define reference vector field parameters\n    param_a = 2.0\n    param_b = 0.1\n    param_c = 0.3\n    param_d = -0.5\n    param_e = -1.0\n    param_f = 0.7\n\n    def B_hat(xi, eta):\n        \"\"\" The reference vector field on the unit square. \"\"\"\n        return np.array([\n            param_a * xi + param_b * eta + param_c,\n            param_d * xi + param_e * eta + param_f\n        ])\n\n    # The reference divergence is constant\n    ref_divergence_val = param_a + param_e\n    # The integral of the reference divergence over the unit reference element\n    ref_integral = ref_divergence_val * 1.0\n\n    #\n    # --- Numerical Integration Setup ---\n    #\n    N_QUAD_POINTS = 20 # High order for accuracy with rational functions\n    # Get standard Gauss-Legendre points/weights for [-1, 1]\n    gl_points, gl_weights = roots_legendre(N_QUAD_POINTS)\n    # Map points and weights to the integration interval [0, 1]\n    quad_points = 0.5 * (gl_points + 1.0)\n    quad_weights = 0.5 * gl_weights\n\n    #\n    # --- Jacobian Function Definitions ---\n    #\n    def get_affine_jacobian_func(A_mat):\n        \"\"\"Returns a function for the constant Jacobian of an affine map.\"\"\"\n        J_const = np.array(A_mat, dtype=float)\n        def jacobian(xi, eta):\n            return J_const\n        return jacobian\n    \n    def get_bilinear_jacobian_func(P1, P2, P3, P4):\n        \"\"\"Returns a function for the Jacobian of a bilinear map.\"\"\"\n        p1, p2, p3, p4 = map(lambda p: np.array(p, dtype=float), [P1, P2, P3, P4])\n        # Pre-compute constant vectors for efficiency\n        p21 = p2 - p1\n        p34 = p3 - p4\n        p41 = p4 - p1\n        p32 = p3 - p2\n        def jacobian(xi, eta):\n            # First column of Jacobian: dF/d(xi)\n            col1 = (1.0 - eta) * p21 + eta * p34\n            # Second column of Jacobian: dF/d(eta)\n            col2 = (1.0 - xi) * p41 + xi * p32\n            return np.column_stack((col1, col2))\n        return jacobian\n\n    #\n    # --- Main Calculation Logic ---\n    #\n    def calculate_I_wrong(jacobian_func):\n        \"\"\"\n        Calculates I_wrong(K) via a boundary integral on the reference element.\n        This method avoids differentiating the Jacobian.\n        I_wrong(K) = integral_{d_hat_K} [ det(J) J^-1 J^-T B_hat ] . n_hat ds_hat\n        \"\"\"\n        total_integral = 0.0\n        \n        # Edge 1: Bottom (eta=0, xi in [0,1]), n_hat = (0, -1)\n        eta = 0.0\n        n_hat = np.array([0.0, -1.0])\n        for i in range(N_QUAD_POINTS):\n            xi, w = quad_points[i], quad_weights[i]\n            J = jacobian_func(xi, eta)\n            det_J = np.linalg.det(J)\n            J_inv = np.linalg.inv(J)\n            W = det_J * J_inv @ J_inv.T @ B_hat(xi, eta)\n            total_integral += np.dot(W, n_hat) * w\n\n        # Edge 2: Right (xi=1, eta in [0,1]), n_hat = (1, 0)\n        xi = 1.0\n        n_hat = np.array([1.0, 0.0])\n        for i in range(N_QUAD_POINTS):\n            eta, w = quad_points[i], quad_weights[i]\n            J = jacobian_func(xi, eta)\n            det_J = np.linalg.det(J)\n            J_inv = np.linalg.inv(J)\n            W = det_J * J_inv @ J_inv.T @ B_hat(xi, eta)\n            total_integral += np.dot(W, n_hat) * w\n            \n        # Edge 3: Top (eta=1, xi in [0,1]), n_hat = (0, 1)\n        eta = 1.0\n        n_hat = np.array([0.0, 1.0])\n        for i in range(N_QUAD_POINTS):\n            xi, w = quad_points[i], quad_weights[i]\n            J = jacobian_func(xi, eta)\n            det_J = np.linalg.det(J)\n            J_inv = np.linalg.inv(J)\n            W = det_J * J_inv @ J_inv.T @ B_hat(xi, eta)\n            total_integral += np.dot(W, n_hat) * w\n\n        # Edge 4: Left (xi=0, eta in [0,1]), n_hat = (-1, 0)\n        xi = 0.0\n        n_hat = np.array([-1.0, 0.0])\n        for i in range(N_QUAD_POINTS):\n            eta, w = quad_points[i], quad_weights[i]\n            J = jacobian_func(xi, eta)\n            det_J = np.linalg.det(J)\n            J_inv = np.linalg.inv(J)\n            W = det_J * J_inv @ J_inv.T @ B_hat(xi, eta)\n            total_integral += np.dot(W, n_hat) * w\n            \n        return total_integral\n\n    # Part D: Define the test cases\n    test_cases = [\n        # K0: Affine, isotropic scaling\n        {'type': 'affine', 'params': {'A_mat': [[1.3, 0.0], [0.0, 1.3]]}},\n        # K1: Affine, anisotropic scaling\n        {'type': 'affine', 'params': {'A_mat': [[2.0, 0.0], [0.0, 0.5]]}},\n        # K2: Affine, shear and rotation\n        {'type': 'affine', 'params': {'A_mat': [[1.1, 0.2], [-0.3, 1.5]]}},\n        # K3: Bilinear quadrilateral\n        {'type': 'bilinear', 'params': {'P': [[0.0, 0.0], [1.8, 0.2], [2.2, 1.1], [-0.1, 0.9]]}}\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        # Error for the correct H(div) mapping is always zero analytically.\n        E_correct = 0.0\n        \n        # Calculate error for the incorrect contravariant mapping.\n        if case['type'] == 'affine':\n            jac_func = get_affine_jacobian_func(case['params']['A_mat'])\n        else: # bilinear\n            p = case['params']['P']\n            jac_func = get_bilinear_jacobian_func(p[0], p[1], p[2], p[3])\n            \n        I_wrong = calculate_I_wrong(jac_func)\n        E_wrong = I_wrong - ref_integral\n        \n        results.extend([E_correct, E_wrong])\n\n    # Part E: Format the final output\n    formatted_results = [f\"{r:.10f}\" for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "This final practice reveals a profound connection between the geometry of the mesh and the physical properties of the medium, a concept central to transformation optics. You will explore how small errors in the geometric mapping can be interpreted as an effective anisotropic material perturbation. By deriving this relationship and applying first-order perturbation theory, you will be able to analytically predict how mesh approximation errors can cause shifts in the resonant frequencies of an electromagnetic cavity, providing a powerful tool for analyzing numerical accuracy. ",
            "id": "3324727",
            "problem": "Consider the source-free Maxwell curl equations in the frequency domain with time dependence $\\exp(-i \\omega t)$ in a homogeneous, isotropic medium with scalar permittivity $\\varepsilon$ and scalar permeability $\\mu$:\n$$\n\\nabla \\times \\mathbf{E} = i \\omega \\mu \\mathbf{H}, \\quad \\nabla \\times \\mathbf{H} = - i \\omega \\varepsilon \\mathbf{E}, \\quad \\nabla \\cdot (\\varepsilon \\mathbf{E}) = 0, \\quad \\nabla \\cdot (\\mu \\mathbf{H}) = 0.\n$$\nA common computational strategy in curvilinear discretizations is to work in local coordinates $\\boldsymbol{\\xi}$ related to global coordinates $\\mathbf{x}$ by a smooth mapping $\\mathbf{x} = \\mathbf{F}(\\boldsymbol{\\xi})$ with Jacobian matrix $J = \\partial \\mathbf{x}/\\partial \\boldsymbol{\\xi}$. Start from the invariance of Maxwell’s equations under smooth coordinate transforms and the resulting equivalence between geometry and material distributions.\n\nSuppose that the exact geometry is trivial (identity mapping), but the numerical mapping introduces a small constant Jacobian error $J = I + \\eta S$, where $I$ is the identity, $0 < |\\eta| \\ll 1$ is a nondimensional small parameter, and $S$ is a constant diagonal matrix $S = \\mathrm{diag}(\\alpha, \\beta, \\gamma)$ with real entries $\\alpha$, $\\beta$, and $\\gamma$. \n\nTasks:\n1. Using only first principles (the curl equations above and coordinate transformation invariance), demonstrate that the mapping error $J = I + \\eta S$ is equivalent, to first order in $\\eta$, to an effective anisotropic material perturbation $(\\delta \\varepsilon, \\delta \\mu)$ in the original global coordinates. Express $\\delta \\varepsilon$ and $\\delta \\mu$ explicitly to first order in $\\eta$ in terms of $\\varepsilon$, $\\mu$, $\\alpha$, $\\beta$, and $\\gamma$.\n2. Derive a first-order perturbation theory expression for the fractional frequency shift $\\delta \\omega / \\omega$ of a lossless electromagnetic eigenmode due to small material perturbations $(\\delta \\varepsilon, \\delta \\mu)$, starting from the source-free generalized eigenproblem for $\\mathbf{E}$ and using a variational or energy-based argument consistent with Maxwell’s equations.\n3. Apply your result to the following specific eigenmode in a periodic box of volume $V$: a transverse electromagnetic plane wave with wavevector $\\mathbf{k} = (0, 0, k_0)$ and electric-field polarization $\\mathbf{E}(\\mathbf{x}) = E_0 \\hat{\\mathbf{x}} \\exp(i k_0 z)$, with corresponding magnetic field $\\mathbf{H}(\\mathbf{x}) = H_0 \\hat{\\mathbf{y}} \\exp(i k_0 z)$ and dispersion relation $k_0 = \\omega \\sqrt{\\varepsilon \\mu}$. The unperturbed medium is the original homogeneous isotropic medium $(\\varepsilon, \\mu)$, and the perturbation arises solely from the mapping error via your result in part 1.\nProvide the final closed-form analytic expression for the leading-order fractional frequency shift $\\delta \\omega / \\omega$ in terms of $\\eta$, $\\alpha$, $\\beta$, and $\\gamma$. No numerical evaluation is required. Express the final answer as a single closed-form analytic expression. No units are needed since $\\delta \\omega / \\omega$ is dimensionless.",
            "solution": "The user has provided a valid, well-posed problem. The solution will proceed by addressing the three tasks in sequence. The unperturbed medium is characterized by scalar permittivity $\\varepsilon$ and permeability $\\mu$. The perturbation arises from a small error in the coordinate mapping Jacobian.\n\n**Part 1: Effective Anisotropic Material Perturbation**\n\nThe problem states that Maxwell's equations are invariant under a smooth coordinate transformation $\\mathbf{x} = \\mathbf{F}(\\boldsymbol{\\xi})$. This invariance implies that a transformation of the coordinate system is equivalent to a transformation of the material constitutive parameters. For a medium that is isotropic with scalar parameters $(\\varepsilon, \\mu)$ in the original coordinates $\\mathbf{x}$, the effective permittivity and permeability tensors $(\\varepsilon', \\mu')$ in the same coordinate system, corresponding to a mapping from a new coordinate system $\\boldsymbol{\\xi}$ with Jacobian $J = \\partial \\mathbf{x}/\\partial \\boldsymbol{\\xi}$, are given by the well-known transformation optics formulas:\n$$\n\\varepsilon' = \\frac{J J^T}{\\det(J)} \\varepsilon, \\quad \\mu' = \\frac{J J^T}{\\det(J)} \\mu\n$$\nThe problem specifies a perturbed Jacobian $J = I + \\eta S$, where $I$ is the $3 \\times 3$ identity matrix, $\\eta$ is a small parameter, and $S = \\mathrm{diag}(\\alpha, \\beta, \\gamma)$ is a constant diagonal matrix. We are asked to find the material perturbations $\\delta\\varepsilon = \\varepsilon' - \\varepsilon I$ and $\\delta\\mu = \\mu' - \\mu I$ to the first order in $\\eta$.\n\nFirst, we compute the term $J J^T$:\n$$\nJ J^T = (I + \\eta S)(I + \\eta S)^T\n$$\nSince $S$ is a diagonal matrix, it is symmetric, i.e., $S^T = S$.\n$$\nJ J^T = (I + \\eta S)(I + \\eta S) = I + 2\\eta S + \\eta^2 S^2\n$$\nTo first order in $\\eta$, this is:\n$$\nJ J^T \\approx I + 2\\eta S\n$$\nNext, we compute the determinant of $J$:\n$$\n\\det(J) = \\det(I + \\eta S) = \\det(\\mathrm{diag}(1+\\eta\\alpha, 1+\\eta\\beta, 1+\\eta\\gamma))\n$$\n$$\n\\det(J) = (1+\\eta\\alpha)(1+\\eta\\beta)(1+\\eta\\gamma) = 1 + \\eta(\\alpha+\\beta+\\gamma) + O(\\eta^2)\n$$\nThe term $\\alpha+\\beta+\\gamma$ is the trace of $S$, denoted $\\mathrm{Tr}(S)$. So, to first order in $\\eta$:\n$$\n\\det(J) \\approx 1 + \\eta \\mathrm{Tr}(S)\n$$\nThe inverse of the determinant, to first order, is:\n$$\n\\frac{1}{\\det(J)} \\approx \\frac{1}{1 + \\eta \\mathrm{Tr}(S)} \\approx 1 - \\eta \\mathrm{Tr}(S)\n$$\nNow we combine these results to find the effective permittivity tensor $\\varepsilon'$:\n$$\n\\varepsilon' = \\varepsilon \\frac{J J^T}{\\det(J)} \\approx \\varepsilon (I + 2\\eta S)(1 - \\eta \\mathrm{Tr}(S))\n$$\nExpanding this and keeping only terms up to first order in $\\eta$:\n$$\n\\varepsilon' \\approx \\varepsilon (I + 2\\eta S - \\eta \\mathrm{Tr}(S) I) = \\varepsilon I + \\eta\\varepsilon(2S - \\mathrm{Tr}(S)I)\n$$\nThe first-order perturbation to the permittivity is $\\delta\\varepsilon = \\varepsilon' - \\varepsilon I$:\n$$\n\\delta\\varepsilon = \\eta\\varepsilon(2S - \\mathrm{Tr}(S)I)\n$$\nSubstituting $S = \\mathrm{diag}(\\alpha, \\beta, \\gamma)$ and $\\mathrm{Tr}(S) = \\alpha+\\beta+\\gamma$:\n$$\n\\delta\\varepsilon = \\eta\\varepsilon \\left( 2\\begin{pmatrix} \\alpha & 0 & 0 \\\\ 0 & \\beta & 0 \\\\ 0 & 0 & \\gamma \\end{pmatrix} - (\\alpha+\\beta+\\gamma) \\begin{pmatrix} 1 & 0 & 0 \\\\ 0 & 1 & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} \\right)\n$$\n$$\n\\delta\\varepsilon = \\eta\\varepsilon \\begin{pmatrix} \\alpha-\\beta-\\gamma & 0 & 0 \\\\ 0 & \\beta-\\alpha-\\gamma & 0 \\\\ 0 & 0 & \\gamma-\\alpha-\\beta \\end{pmatrix}\n$$\nThe derivation for the permeability perturbation $\\delta\\mu$ is identical:\n$$\n\\delta\\mu = \\eta\\mu(2S - \\mathrm{Tr}(S)I) = \\eta\\mu \\begin{pmatrix} \\alpha-\\beta-\\gamma & 0 & 0 \\\\ 0 & \\beta-\\alpha-\\gamma & 0 \\\\ 0 & 0 & \\gamma-\\alpha-\\beta \\end{pmatrix}\n$$\nThese are the explicit first-order expressions for the effective material perturbations.\n\n**Part 2: First-Order Perturbation Theory for Frequency Shift**\n\nWe start from the source-free Maxwell curl equations, which can be combined into a generalized Hermitian eigenproblem for the electric field $\\mathbf{E}$:\n$$\n\\nabla \\times \\left(\\mu^{-1} \\nabla \\times \\mathbf{E}\\right) = \\omega^2 \\varepsilon \\mathbf{E}\n$$\nLet the unperturbed system be $(\\varepsilon_0, \\mu_0, \\omega_0, \\mathbf{E}_0, \\mathbf{H}_0)$, and the perturbed system be $(\\varepsilon, \\mu, \\omega, \\mathbf{E}, \\mathbf{H})$. For this problem, we will use $(\\varepsilon, \\mu)$ for the unperturbed state to match the problem's notation. The perturbation is thus $(\\delta\\varepsilon, \\delta\\mu)$, leading to a frequency shift $\\delta\\omega$. The perturbed system is $\\varepsilon' = \\varepsilon + \\delta\\varepsilon$ and $\\mu' = \\mu + \\delta\\mu$. The new frequency is $\\omega' = \\omega + \\delta\\omega$.\n\nThe unperturbed eigenproblem is $\\nabla \\times \\left(\\mu^{-1} \\nabla \\times \\mathbf{E}\\right) = \\omega^2 \\varepsilon \\mathbf{E}$.\nThe perturbed eigenproblem is $\\nabla \\times \\left((\\mu+\\delta\\mu)^{-1} \\nabla \\times \\mathbf{E'}\\right) = (\\omega+\\delta\\omega)^2 (\\varepsilon+\\delta\\varepsilon) \\mathbf{E'}$.\nTo first order, $(\\mu+\\delta\\mu)^{-1} \\approx \\mu^{-1} - \\mu^{-1}\\delta\\mu\\mu^{-1}$. Since the unperturbed medium is isotropic, $\\mu$ is a scalar, so this simplifies to $\\mu^{-1}(I - \\mu^{-1}\\delta\\mu) \\approx \\mu^{-1}(1 - \\delta\\mu/\\mu) \\approx \\mu^{-1} - \\mu^{-2}\\delta\\mu$.\n\nLet's use the standard first-order perturbation theory for a generalized eigenproblem $A\\mathbf{x} = \\lambda B\\mathbf{x}$. The frequency shift is given by the Fredholm alternative condition applied to the first-order perturbed equation. This leads to the well-known formula:\n$$\n\\frac{\\delta\\omega}{\\omega} = - \\frac{\\int_V (\\mathbf{E}^* \\cdot \\delta\\varepsilon \\mathbf{E} + \\mathbf{H}^* \\cdot \\delta\\mu \\mathbf{H}) \\, dV}{2 \\int_V (\\mathbf{E}^* \\cdot \\varepsilon \\mathbf{E}) \\, dV}\n$$\nThis formula can also be derived from an energy argument where the fractional frequency shift is equal to the negative of the fractional change in total energy stored in the unperturbed fields due to the perturbation. The time-averaged stored electric energy is $W_e = \\frac{1}{4} \\int_V \\mathbf{E}^* \\cdot (\\varepsilon \\mathbf{E}) \\, dV$ and magnetic energy is $W_m = \\frac{1}{4} \\int_V \\mathbf{H}^* \\cdot (\\mu \\mathbf{H}) \\, dV$. For an eigenmode, $W_e=W_m$. The perturbation in energy is $\\delta W = \\delta W_e + \\delta W_m = \\frac{1}{4} \\int_V (\\mathbf{E}^* \\cdot \\delta\\varepsilon \\mathbf{E} + \\mathbf{H}^* \\cdot \\delta\\mu \\mathbf{H}) \\, dV$. The total unperturbed energy is $U = W_e + W_m = 2W_e = \\frac{1}{2} \\int_V \\mathbf{E}^* \\cdot \\varepsilon \\mathbf{E} \\, dV$. The result follows from $\\delta\\omega/\\omega = -\\delta U / U$. In our notation, this is $\\delta\\omega/\\omega = -(\\delta W_e+\\delta W_m)/(W_e+W_m)$.\n\n**Part 3: Application to a TEM Plane Wave**\n\nWe apply the perturbation formula derived in Part 2 to the specific case given.\nThe unperturbed fields are:\n$\\mathbf{E}(\\mathbf{x}) = E_0 \\hat{\\mathbf{x}} \\exp(i k_0 z)$\n$\\mathbf{H}(\\mathbf{x}) = H_0 \\hat{\\mathbf{y}} \\exp(i k_0 z)$\nwhere $E_0$ and $H_0$ represent the amplitudes. From Maxwell's equations, the amplitudes are related by the intrinsic impedance of the medium $Z = \\sqrt{\\mu/\\varepsilon}$, such that $E_0 = Z H_0$, or $H_0 = E_0/\\sqrt{\\mu/\\varepsilon} = E_0\\sqrt{\\varepsilon/\\mu}$. Assuming $E_0$ is real, $H_0$ is real, and $H_0^2 = (\\varepsilon/\\mu)E_0^2$.\n\nThe denominator of the perturbation formula is:\n$$\n2 \\int_V \\mathbf{E}^* \\cdot \\varepsilon \\mathbf{E} \\, dV = 2 \\int_V (E_0 \\hat{\\mathbf{x}} e^{-ik_0z}) \\cdot (\\varepsilon E_0 \\hat{\\mathbf{x}} e^{ik_0z}) \\, dV = 2 \\int_V \\varepsilon E_0^2 \\, dV\n$$\nSince $\\varepsilon$ and $E_0$ are constants, this integrates to $2 \\varepsilon E_0^2 V$, where $V$ is the volume of the periodic box.\n\nThe numerator requires evaluating the terms $\\mathbf{E}^* \\cdot \\delta\\varepsilon \\mathbf{E}$ and $\\mathbf{H}^* \\cdot \\delta\\mu \\mathbf{H}$.\nThe electric field $\\mathbf{E}$ is polarized in the $\\hat{\\mathbf{x}}$ direction, so it only probes the $\\delta\\varepsilon_{xx}$ component of the permittivity perturbation tensor.\n$\\mathbf{E} = E_0 e^{ik_0z} \\begin{pmatrix} 1 \\\\ 0 \\\\ 0 \\end{pmatrix}$.\n$$\n\\mathbf{E}^* \\cdot \\delta\\varepsilon \\mathbf{E} = (E_0 e^{-ik_0z} \\begin{pmatrix} 1 & 0 & 0 \\end{pmatrix}) (\\delta\\varepsilon) (E_0 e^{ik_0z} \\begin{pmatrix} 1 \\\\ 0 \\\\ 0 \\end{pmatrix}) = E_0^2 \\delta\\varepsilon_{xx}\n$$\nFrom Part 1, $\\delta\\varepsilon_{xx} = \\eta\\varepsilon(\\alpha-\\beta-\\gamma)$. So, $\\mathbf{E}^* \\cdot \\delta\\varepsilon \\mathbf{E} = E_0^2 \\eta\\varepsilon(\\alpha-\\beta-\\gamma)$.\n\nThe magnetic field $\\mathbf{H}$ is polarized in the $\\hat{\\mathbf{y}}$ direction, so it only probes the $\\delta\\mu_{yy}$ component.\n$\\mathbf{H} = H_0 e^{ik_0z} \\begin{pmatrix} 0 \\\\ 1 \\\\ 0 \\end{pmatrix}$.\n$$\n\\mathbf{H}^* \\cdot \\delta\\mu \\mathbf{H} = (H_0 e^{-ik_0z} \\begin{pmatrix} 0 & 1 & 0 \\end{pmatrix}) (\\delta\\mu) (H_0 e^{ik_0z} \\begin{pmatrix} 0 \\\\ 1 \\\\ 0 \\end{pmatrix}) = H_0^2 \\delta\\mu_{yy}\n$$\nFrom Part 1, $\\delta\\mu_{yy} = \\eta\\mu(\\beta-\\alpha-\\gamma)$. So, $\\mathbf{H}^* \\cdot \\delta\\mu \\mathbf{H} = H_0^2 \\eta\\mu(\\beta-\\alpha-\\gamma)$.\nSubstitute $H_0^2 = (\\varepsilon/\\mu)E_0^2$:\n$$\n\\mathbf{H}^* \\cdot \\delta\\mu \\mathbf{H} = \\left(\\frac{\\varepsilon}{\\mu}E_0^2\\right) \\eta\\mu(\\beta-\\alpha-\\gamma) = E_0^2 \\eta\\varepsilon(\\beta-\\alpha-\\gamma)\n$$\nThe integrand of the numerator is the sum of these two terms, which are constant over the volume:\n$$\n\\mathbf{E}^* \\cdot \\delta\\varepsilon \\mathbf{E} + \\mathbf{H}^* \\cdot \\delta\\mu \\mathbf{H} = E_0^2 \\eta\\varepsilon(\\alpha-\\beta-\\gamma) + E_0^2 \\eta\\varepsilon(\\beta-\\alpha-\\gamma)\n$$\n$$\n= E_0^2 \\eta\\varepsilon [(\\alpha-\\beta-\\gamma) + (\\beta-\\alpha-\\gamma)] = E_0^2 \\eta\\varepsilon (-2\\gamma) = -2\\gamma\\eta\\varepsilon E_0^2\n$$\nThe integral in the numerator is then this constant integrand multiplied by the volume $V$:\n$$\n\\int_V (\\mathbf{E}^* \\cdot \\delta\\varepsilon \\mathbf{E} + \\mathbf{H}^* \\cdot \\delta\\mu \\mathbf{H}) \\, dV = -2\\gamma\\eta\\varepsilon E_0^2 V\n$$\nFinally, we compute the fractional frequency shift:\n$$\n\\frac{\\delta\\omega}{\\omega} = - \\frac{-2\\gamma\\eta\\varepsilon E_0^2 V}{2 \\varepsilon E_0^2 V} = \\frac{2\\gamma\\eta\\varepsilon E_0^2 V}{2 \\varepsilon E_0^2 V}\n$$\n$$\n\\frac{\\delta\\omega}{\\omega} = \\eta\\gamma\n$$\nThe result indicates that for a TEM plane wave propagating in the $z$-direction, the leading-order fractional frequency shift due to the specified Jacobian error is directly proportional to the Jacobian error coefficient $\\gamma$ corresponding to the direction of propagation.",
            "answer": "$$\n\\boxed{\\eta \\gamma}\n$$"
        }
    ]
}