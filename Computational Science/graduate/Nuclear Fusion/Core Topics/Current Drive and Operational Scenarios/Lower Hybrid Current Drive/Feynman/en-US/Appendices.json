{
    "hands_on_practices": [
        {
            "introduction": "To effectively drive current, Lower Hybrid waves must first propagate from the plasma edge to the core. This practice explores the wave's journey using Hamiltonian ray tracing, a powerful technique that treats the wave packet as a particle moving in a complex medium . By implementing the ray equations derived from the cold plasma dispersion relation, you will gain hands-on experience modeling how the wave's trajectory is shaped by the plasma's density and magnetic field profiles.",
            "id": "3707271",
            "problem": "Consider the Lower Hybrid Current Drive (LHCD) regime in a magnetized plasma and adopt the cold plasma, quasi-electrostatic, slow wave approximation. In this limit, the wave electric field is parallel to the wavevector and the dispersion is given by the longitudinal condition $L(\\omega,\\mathbf{k},\\mathbf{r}) = \\mathbf{n} \\cdot \\boldsymbol{\\varepsilon}(\\omega,\\mathbf{r}) \\cdot \\mathbf{n} = 0$, where $\\mathbf{n} = (c/\\omega)\\mathbf{k}$ is the refractive index vector, $c$ is the speed of light in vacuum, $\\omega$ is the angular frequency, $\\mathbf{k}$ is the wavevector, and $\\boldsymbol{\\varepsilon}$ is the cold plasma dielectric tensor written in the Stix frame aligned with the magnetic field. In coordinates with the magnetic field along the $y$-axis, and for electrostatic waves with the wavevector confined to the $x$-$z$ plane for the perpendicular components, the longitudinal dispersion reduces to\n$$\nL(\\omega,\\mathbf{k},\\mathbf{r}) = S(\\omega,\\mathbf{r})\\,n_{\\perp}^{2} + P(\\omega,\\mathbf{r})\\,n_{\\parallel}^{2} = 0,\n$$\nwith $n_{\\perp}^{2} = (c/\\omega)^{2}(k_{x}^{2}+k_{z}^{2})$ and $n_{\\parallel}^{2} = (c/\\omega)^{2}k_{y}^{2}$. The Stix parameters $S(\\omega,\\mathbf{r})$ and $P(\\omega,\\mathbf{r})$ for a cold, singly ionized, two-species plasma (electrons $e$, ions $i$) are\n$$\nS(\\omega,\\mathbf{r}) = 1 - \\frac{\\omega_{pe}^{2}(\\mathbf{r})}{\\omega^{2} - \\omega_{ce}^{2}(\\mathbf{r})} - \\frac{\\omega_{pi}^{2}(\\mathbf{r})}{\\omega^{2} - \\omega_{ci}^{2}(\\mathbf{r})},\n$$\n$$\nP(\\omega,\\mathbf{r}) = 1 - \\frac{\\omega_{pe}^{2}(\\mathbf{r})}{\\omega^{2}} - \\frac{\\omega_{pi}^{2}(\\mathbf{r})}{\\omega^{2}},\n$$\nwhere $\\omega_{ps}^{2}(\\mathbf{r}) = n_{s}(\\mathbf{r}) q_{s}^{2}/(\\varepsilon_{0} m_{s})$ is the plasma frequency for species $s$, $\\omega_{cs}(\\mathbf{r}) = |q_{s}| B(\\mathbf{r})/m_{s}$ is the cyclotron frequency, $\\varepsilon_{0}$ is the vacuum permittivity, $q_{s}$ and $m_{s}$ are the species charge and mass, and $B(\\mathbf{r})$ is the magnetic field magnitude.\n\nUsing Hamiltonian ray theory in a stationary medium, the ray equations may be written in the form\n$$\n\\frac{d\\mathbf{r}}{ds} = \\nabla_{\\mathbf{k}} \\omega(\\mathbf{k},\\mathbf{r}), \\quad \\frac{d\\mathbf{k}}{ds} = - \\nabla_{\\mathbf{r}} \\omega(\\mathbf{k},\\mathbf{r}),\n$$\nwith $s$ a ray parameter. In this problem, you must implement these equations using the cold plasma longitudinal dispersion $L(\\omega,\\mathbf{k},\\mathbf{r}) = 0$ as the defining constraint. Since $\\omega(\\mathbf{k},\\mathbf{r})$ is given only implicitly by $L=0$, use implicit differentiation to obtain\n$$\n\\nabla_{\\mathbf{k}} \\omega = - \\frac{\\nabla_{\\mathbf{k}} L}{\\partial L/\\partial \\omega}, \\quad \\nabla_{\\mathbf{r}} \\omega = - \\frac{\\nabla_{\\mathbf{r}} L}{\\partial L/\\partial \\omega},\n$$\nand therefore\n$$\n\\frac{d\\mathbf{r}}{ds} = - \\frac{\\nabla_{\\mathbf{k}} L}{\\partial L/\\partial \\omega}, \\quad \\frac{d\\mathbf{k}}{ds} = \\frac{\\nabla_{\\mathbf{r}} L}{\\partial L/\\partial \\omega}.\n$$\nStart from the fundamental laws and well-tested formulas listed above. Do not introduce any shortcut formulas that bypass the derivation from the cold plasma dielectric model and the implicit function differentiation.\n\nAssume a simple tokamak equilibrium:\n- Major radius $R_{0} = 1.7\\,\\text{m}$, minor radius $a = 0.5\\,\\text{m}$.\n- Toroidal magnetic field magnitude $B(R) = B_{0} R_{0} / R$ with $B_{0} = 5\\,\\text{T}$ at $R_{0}$. The magnetic field direction is purely toroidal (along the $y$-axis in your coordinates).\n- Electron density profile $n_{e}(R,Z) = n_{0} \\exp\\left(-\\frac{(R - R_{0})^{2} + Z^{2}}{a^{2}}\\right)$ with $n_{0} = 5\\times 10^{19}\\,\\text{m}^{-3}$.\n- Quasi-neutrality $n_{i}(R,Z) = n_{e}(R,Z)$ with singly charged ions.\n- Deuterium ions with mass $m_{i} = 3.343\\times 10^{-27}\\,\\text{kg}$ and charge $q_{i} = +e$.\n- Electrons with mass $m_{e} = 9.109\\times 10^{-31}\\,\\text{kg}$ and charge $q_{e} = -e$.\n- Vacuum permittivity $\\varepsilon_{0} = 8.8541878128\\times 10^{-12}\\,\\text{F/m}$ and speed of light $c = 2.99792458\\times 10^{8}\\,\\text{m/s}$.\n- Fixed wave angular frequency $\\omega = 2\\pi f$ with $f = 3.7\\,\\text{GHz}$.\n\nInitialize rays at specified launch points and with perpendicular wavevector components prescribed. To ensure the dispersion constraint $L(\\omega,\\mathbf{k},\\mathbf{r}) = 0$ holds at launch, determine the initial parallel component $k_{y}$ from the longitudinal dispersion relation at the launch location, choosing the sign such that $k_{y} > 0$:\n$$\nk_{y}^{2} = - \\frac{S(\\omega,\\mathbf{r}_{0})}{P(\\omega,\\mathbf{r}_{0})}\\,\\left(k_{x}^{2} + k_{z}^{2}\\right).\n$$\n\nImplement the ray equations using the implicit derivatives above and integrate them numerically for a short interval of the ray parameter $s$ to obtain the ray trajectory in the $(R,Z)$ plane. Use the following three-test-case suite; for each case, the initial conditions are:\n1. Case A (happy path): launch at $\\mathbf{r}_{0A} = (R_{0} + 0.3 a,\\, 0,\\, 0)$ with $\\mathbf{k}_{\\perp A} = (300\\,\\text{m}^{-1},\\,0,\\,0)$.\n2. Case B (oblique launch): launch at $\\mathbf{r}_{0B} = (R_{0} + 0.1 a,\\, 0,\\, 0.2 a)$ with $\\mathbf{k}_{\\perp B} = \\left(\\frac{200}{\\sqrt{2}}\\,\\text{m}^{-1},\\,0,\\,\\frac{200}{\\sqrt{2}}\\,\\text{m}^{-1}\\right)$.\n3. Case C (edge case near low density): launch at $\\mathbf{r}_{0C} = (R_{0} + 0.45 a,\\, 0,\\, 0.4 a)$ with $\\mathbf{k}_{\\perp C} = (100\\,\\text{m}^{-1},\\,0,\\,0)$.\n\nFor each case, compute the corresponding $k_{y}$ at launch from the dispersion relation. Integrate the ray equations for a fixed parameter interval $s \\in [0, s_{\\max}]$ with $s_{\\max} = 1.0\\times 10^{-10}\\,\\text{s}$, and return the final major radius coordinate $R$ for each ray.\n\nRequirements:\n- All calculations must be performed in International System of Units (SI). Express the final major radius outputs in meters, rounded to three decimal places.\n- Angles, where used internally, must be in radians.\n- Your program must produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of the test cases A, B, C, that is, $[R_{A},R_{B},R_{C}]$ with each $R$ rounded to three decimal places.\n- Scientific realism: use the given constants and profiles, and the specified cold plasma model strictly.\n- The code must be self-contained and runnable as is, with no external input.\n\nThe test suite covers:\n- A general case with moderate perpendicular wavenumber and midplane launch.\n- An oblique case to test coupling between radial and vertical gradients.\n- An edge case near low density to test behavior where $P(\\omega,\\mathbf{r})$ changes magnitude significantly.\n\nDesign your algorithm to compute $S$, $P$, their derivatives with respect to $\\omega$, and spatial derivatives through $B(R)$ and $n_{e}(R,Z)$. Then use implicit differentiation of $L(\\omega,\\mathbf{k},\\mathbf{r})=0$ to form $d\\mathbf{r}/ds$ and $d\\mathbf{k}/ds$, integrate the ray equations, and return the required outputs. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $[1.865,1.812,1.903]$).",
            "solution": "The user wants to solve the Hamiltonian ray-tracing equations for Lower Hybrid waves in a simplified tokamak plasma model.\n\n### Step 1: Extract Givens\n\n**Physical Model:**\n- Cold plasma, quasi-electrostatic, slow wave approximation.\n- Longitudinal dispersion relation: $L(\\omega,\\mathbf{k},\\mathbf{r}) = S(\\omega,\\mathbf{r})\\,n_{\\perp}^{2} + P(\\omega,\\mathbf{r})\\,n_{\\parallel}^{2} = 0$.\n- Refractive index components: $n_{\\perp}^{2} = (c/\\omega)^{2}(k_{x}^{2}+k_{z}^{2})$, $n_{\\parallel}^{2} = (c/\\omega)^{2}k_{y}^{2}$.\n- Coordinate system: Magnetic field $\\mathbf{B}$ along the $y$-axis. Wavevector perpendicular components $(k_x, k_z)$ are in the $x$-$z$ plane.\n- Stix parameters for a singly ionized, two-species plasma (electrons $e$, ions $i$):\n  $$S(\\omega,\\mathbf{r}) = 1 - \\frac{\\omega_{pe}^{2}(\\mathbf{r})}{\\omega^{2} - \\omega_{ce}^{2}(\\mathbf{r})} - \\frac{\\omega_{pi}^{2}(\\mathbf{r})}{\\omega^{2} - \\omega_{ci}^{2}(\\mathbf{r})}$$\n  $$P(\\omega,\\mathbf{r}) = 1 - \\frac{\\omega_{pe}^{2}(\\mathbf{r})}{\\omega^{2}} - \\frac{\\omega_{pi}^{2}(\\mathbf{r})}{\\omega^{2}}$$\n- Plasma and cyclotron frequencies: $\\omega_{ps}^{2}(\\mathbf{r}) = n_{s}(\\mathbf{r}) q_{s}^{2}/(\\varepsilon_{0} m_{s})$, $\\omega_{cs}(\\mathbf{r}) = |q_{s}| B(\\mathbf{r})/m_{s}$.\n\n**Ray Equations:**\n- Hamiltonian ray equations with implicit differentiation of $L=0$:\n  $$\\frac{d\\mathbf{r}}{ds} = - \\frac{\\nabla_{\\mathbf{k}} L}{\\partial L/\\partial \\omega}, \\quad \\frac{d\\mathbf{k}}{ds} = \\frac{\\nabla_{\\mathbf{r}} L}{\\partial L/\\partial \\omega}$$\n- $s$ is a ray parameter with units of time.\n\n**Tokamak Equilibrium:**\n- Major radius: $R_{0} = 1.7\\,\\text{m}$.\n- Minor radius: $a = 0.5\\,\\text{m}$.\n- Toroidal magnetic field: $B(R) = B_{0} R_{0} / R$ with $B_{0} = 5\\,\\text{T}$. Direction is purely toroidal ($y$-axis).\n- Electron density: $n_{e}(R,Z) = n_{0} \\exp\\left(-\\frac{(R - R_{0})^{2} + Z^{2}}{a^{2}}\\right)$ with $n_{0} = 5\\times 10^{19}\\,\\text{m}^{-3}$.\n- Quasi-neutrality: $n_{i}(R,Z) = n_{e}(R,Z)$, singly charged ions.\n\n**Physical Constants:**\n- Ion (Deuterium) mass: $m_{i} = 3.343\\times 10^{-27}\\,\\text{kg}$.\n- Ion charge: $q_{i} = +e$.\n- Electron mass: $m_{e} = 9.109\\times 10^{-31}\\,\\text{kg}$.\n- Electron charge: $q_{e} = -e$.\n- Vacuum permittivity: $\\varepsilon_{0} = 8.8541878128\\times 10^{-12}\\,\\text{F/m}$.\n- Speed of light: $c = 2.99792458\\times 10^{8}\\,\\text{m/s}$.\n\n**Wave Parameters & Integration:**\n- Wave frequency: $f = 3.7\\,\\text{GHz}$, so angular frequency $\\omega = 2\\pi f$.\n- Integration interval: $s \\in [0, s_{\\max}]$ with $s_{\\max} = 1.0\\times 10^{-10}\\,\\text{s}$.\n\n**Initial Conditions:**\n- For each case, $k_y$ is determined by $L=0$ at the launch point, with $k_y > 0$.\n- Case A: Launch at $\\mathbf{r}_{0A} = (R_{0} + 0.3 a,\\, 0,\\, 0)$ with $\\mathbf{k}_{\\perp A} = (300\\,\\text{m}^{-1},\\,0,\\,0)$.\n- Case B: Launch at $\\mathbf{r}_{0B} = (R_{0} + 0.1 a,\\, 0,\\, 0.2 a)$ with $\\mathbf{k}_{\\perp B} = \\left(\\frac{200}{\\sqrt{2}}\\,\\text{m}^{-1},\\,0,\\,\\frac{200}{\\sqrt{2}}\\,\\text{m}^{-1}\\right)$.\n- Case C: Launch at $\\mathbf{r}_{0C} = (R_{0} + 0.45 a,\\, 0,\\, 0.4 a)$ with $\\mathbf{k}_{\\perp C} = (100\\,\\text{m}^{-1},\\,0,\\,0)$.\n\n### Step 2: Validate Using Extracted Givens\n\n- **Scientifically Grounded:** The problem describes a standard, albeit simplified, model for Lower Hybrid wave propagation in a tokamak plasma. The cold plasma dielectric tensor, Stix parameters, and Hamiltonian ray tracing are all fundamental concepts in plasma physics. The method of implicit differentiation is a standard technique for this type of problem. The physical parameters and profiles are realistic for a mid-sized tokamak. The problem is scientifically sound.\n- **Well-Posed:** All necessary constants, equations, initial conditions, and parameters are provided. The requirement to solve for the initial $k_y$ from the dispersion relation ensures the initial state is physically valid. The problem specifies a unique positive root for $k_y$, making the initial state unique. The ray equations form a well-defined system of ordinary differential equations (ODEs), which, given an initial condition, has a unique solution for the specified integration interval. The problem is well-posed.\n- **Objective:** The problem is stated in precise, quantitative terms, free from any subjective or ambiguous language.\n\n### Step 3: Verdict and Action\nThe problem is valid. A complete solution will be provided.\n\n### Principle-Based Design\n\nThe solution will be implemented by following the principles of Hamiltonian optics applied to plasma waves. The state of the wave packet is described by its position $\\mathbf{r}=(x, y, z)$ and wavevector $\\mathbf{k}=(k_x, k_y, k_z)$. The evolution of this state is governed by Hamilton's equations, where the Hamiltonian is the wave frequency $\\omega(\\mathbf{k}, \\mathbf{r})$.\n\n**1. Coordinate System Mapping:**\nThe problem is set in a tokamak geometry but uses a local Cartesian frame $(x,y,z)$ for the ray dynamics, where the $y$-axis is aligned with the toroidal magnetic field. The spatial dependence of the plasma is given in macroscopic cylindrical coordinates $(R, Z)$. We establish the mapping:\n- Radial coordinate: $x = R - R_0$\n- Vertical coordinate: $z = Z$\n- Toroidal coordinate: $y$ (not explicitly mapped to an angle, but represents the direction of symmetry).\nThe state vector for integration will be $\\mathbf{Y} = [x, y, z, k_x, k_y, k_z]$.\n\n**2. Dispersion Relation:**\nThe wave's behavior is constrained by the dispersion relation $L(\\omega, \\mathbf{k}, \\mathbf{r}) = 0$. The problem provides the form $S n_{\\perp}^2 + P n_{\\parallel}^2 = 0$. Substituting the definitions of $n_{\\perp}$ and $n_{\\parallel}$, we get:\n$$S(\\mathbf{r}) \\left(\\frac{c}{\\omega}\\right)^2 (k_x^2 + k_z^2) + P(\\mathbf{r}) \\left(\\frac{c}{\\omega}\\right)^2 k_y^2 = 0$$\nThe constant factor $(c/\\omega)^2$ can be dropped, as it does not affect the condition $L=0$. We can work with a simplified dispersion function $L'(\\mathbf{k}, \\mathbf{r}) = S(\\mathbf{r})(k_x^2 + k_z^2) + P(\\mathbf{r}) k_y^2 = 0$. The ray equations derived using $L'$ will be identical to those from the original $L$.\n\n**3. Ray Equations Derivation:**\nThe ray equations are given as:\n$$\\frac{d\\mathbf{r}}{ds} = -\\frac{\\nabla_{\\mathbf{k}} L}{\\partial L/\\partial \\omega}, \\quad \\frac{d\\mathbf{k}}{ds} = \\frac{\\nabla_{\\mathbf{r}} L}{\\partial L/\\partial \\omega}$$\nWe need to compute the various derivatives of $L$.\n- **Gradient in k-space:**\n  $\\nabla_{\\mathbf{k}} L = (\\frac{\\partial L}{\\partial k_x}, \\frac{\\partial L}{\\partial k_y}, \\frac{\\partial L}{\\partial k_z}) = (2Sk_x, 2Pk_y, 2Sk_z)$.\n- **Gradient in r-space:**\n  $\\nabla_{\\mathbf{r}} L = (\\frac{\\partial L}{\\partial x}, \\frac{\\partial L}{\\partial y}, \\frac{\\partial L}{\\partial z})$. Since the equilibrium is axisymmetric (no dependence on $y$), $\\frac{\\partial L}{\\partial y}=0$. The other components are:\n  $$\\frac{\\partial L}{\\partial x} = \\frac{\\partial S}{\\partial x}(k_x^2+k_z^2) + \\frac{\\partial P}{\\partial x} k_y^2$$\n  $$\\frac{\\partial L}{\\partial z} = \\frac{\\partial S}{\\partial z}(k_x^2+k_z^2) + \\frac{\\partial P}{\\partial z} k_y^2$$\n- **Derivative with respect to $\\omega$:**\n  $$\\frac{\\partial L}{\\partial \\omega} = \\frac{\\partial S}{\\partial \\omega}(k_x^2+k_z^2) + \\frac{\\partial P}{\\partial \\omega} k_y^2$$\n\nThe derivatives of $S$ and $P$ with respect to space and frequency are determined using the chain rule, based on their definitions and the spatial profiles of density $n_e(x, z)$ and magnetic field $B(x)$. For example:\n$$\\frac{\\partial P}{\\partial x} = \\frac{\\partial P}{\\partial n_e} \\frac{\\partial n_e}{\\partial x} = \\left( -\\frac{1}{\\omega^2} \\frac{\\omega_{pe}^2+\\omega_{pi}^2}{n_e} \\right) \\left( n_e \\frac{-2x}{a^2} \\right) = (P-1) \\frac{-2x}{a^2}$$\nSimilar derivations apply to all other required derivatives.\n\n**4. Numerical Implementation:**\nThe algorithm proceeds as follows:\n- Define all physical and machine constants.\n- Implement functions to compute $B(x)$, $n_e(x,z)$, and their spatial derivatives.\n- Implement a core function that, for a given state $(\\mathbf{r}, \\mathbf{k})$, calculates the Stix parameters $S$ and $P$, and all the necessary derivatives $(\\nabla_{\\mathbf{k}} L, \\nabla_{\\mathbf{r}} L, \\partial L / \\partial \\omega)$.\n- Define the ODE system $d\\mathbf{Y}/ds = F(\\mathbf{Y}, s)$ based on the ray equations. A key feature is that $dk_y/ds = (\\partial L / \\partial y) / (\\partial L / \\partial \\omega) = 0$, reflecting the conservation of the parallel wave number in an axisymmetric system.\n- For each test case:\n  a. Determine the initial position $(x_0, y_0, z_0)$ and perpendicular wavevector $(k_{x0}, k_{z0})$.\n  b. At $(x_0, z_0)$, calculate $S_0$ and $P_0$.\n  c. Solve the dispersion relation for the initial parallel wavevector: $k_{y0} = \\sqrt{-S_0/P_0 \\cdot (k_{x0}^2 + k_{z0}^2)}$.\n  d. Assemble the initial state vector $\\mathbf{Y}_0 = [x_0, y_0, z_0, k_{x0}, k_{y0}, k_{z0}]$.\n  e. Use a numerical ODE solver (`scipy.integrate.solve_ivp`) to integrate the state vector from $s=0$ to $s=s_{\\max}$.\n  f. Extract the final radial coordinate $x_f$ and compute the final major radius $R_f = R_0 + x_f$.\n- Collect the results and format the final output as specified.\nThis structured approach ensures that the physics is correctly translated into a robust numerical algorithm.",
            "answer": "```python\nimport numpy as np\nfrom scipy.integrate import solve_ivp\n\ndef solve():\n    \"\"\"\n    Solves the LHCD ray tracing problem for the given test cases.\n    \"\"\"\n    # Physical Constants (SI units)\n    e_charge = 1.602176634e-19\n    m_e = 9.109e-31\n    m_i = 3.343e-27\n    eps0 = 8.8541878128e-12\n    c = 2.99792458e8\n\n    # Tokamak Parameters\n    R0 = 1.7\n    a = 0.5\n    B0 = 5.0\n    n0 = 5.0e19\n\n    # Wave Parameters\n    f = 3.7e9\n    omega = 2 * np.pi * f\n    omega_sq = omega**2\n\n    # Species-specific derived constants\n    qe, me = -e_charge, m_e\n    Ce = qe**2 / (eps0 * me)\n    De = np.abs(qe) / me\n\n    qi, mi = e_charge, m_i\n    Ci = qi**2 / (eps0 * mi)\n    Di = np.abs(qi) / mi\n\n    def get_plasma_profiles(x, z):\n        \"\"\"\n        Calculates plasma parameters and their derivatives at position (x, z).\n        x = R - R0, z = Z\n        \"\"\"\n        R = R0 + x\n        if R <= 0: R = 1e-6 # Avoid divergence at R=0\n\n        B = B0 * R0 / R\n        dB_dx = -B0 * R0 / R**2\n\n        exp_arg = -(x**2 + z**2) / a**2\n        ne = n0 * np.exp(exp_arg)\n        if ne < 1e10: ne = 1e10 # Floor density to avoid numerical issues\n\n        dne_dx = ne * (-2 * x / a**2)\n        dne_dz = ne * (-2 * z / a**2)\n\n        return R, B, dB_dx, ne, dne_dx, dne_dz\n\n    def get_dispersion_components(x, z, kx, ky, kz):\n        \"\"\"\n        Calculates Stix parameters S, P, and their derivatives required for ray tracing.\n        \"\"\"\n        _, B, dB_dx, ne, dne_dx, dne_dz = get_plasma_profiles(x, z)\n\n        omega_pe_sq = ne * Ce\n        omega_pi_sq = ne * Ci\n        omega_ce = B * De\n        omega_ci = B * Di\n        omega_ce_sq = omega_ce**2\n        omega_ci_sq = omega_ci**2\n\n        P = 1 - (omega_pe_sq + omega_pi_sq) / omega_sq\n        S_e_term_den = omega_sq - omega_ce_sq\n        S_i_term_den = omega_sq - omega_ci_sq\n        S = 1 - omega_pe_sq / S_e_term_den - omega_pi_sq / S_i_term_den\n\n        dP_domega = 2 * (omega_pe_sq + omega_pi_sq) / omega**3\n        dS_domega = 2 * omega * (omega_pe_sq / S_e_term_den**2 + omega_pi_sq / S_i_term_den**2)\n\n        dP_dx = (P - 1) / ne * dne_dx if ne > 0 else 0\n        dP_dz = (P - 1) / ne * dne_dz if ne > 0 else 0\n        \n        domega_ce_dx = De * dB_dx\n        domega_ci_dx = Di * dB_dx\n        \n        dS_dx = (-Ce * dne_dx / S_e_term_den) - (Ci * dne_dx / S_i_term_den) \\\n                - omega_pe_sq * ( -(-2*omega_ce*domega_ce_dx) / (S_e_term_den**2) ) \\\n                - omega_pi_sq * ( -(-2*omega_ci*domega_ci_dx) / (S_i_term_den**2) )\n\n        dS_dz = (-Ce * dne_dz / S_e_term_den) - (Ci * dne_dz / S_i_term_den)\n\n        k_perp_sq = kx**2 + kz**2\n\n        # L = S*k_perp^2 + P*ky^2 (factor of (c/omega)^2 omitted)\n        dL_dkx = 2 * S * kx\n        dL_dky = 2 * P * ky\n        dL_dkz = 2 * S * kz\n\n        dL_dx = dS_dx * k_perp_sq + dP_dx * ky**2\n        dL_dy = 0\n        dL_dz = dS_dz * k_perp_sq + dP_dz * ky**2\n\n        # Original L has (c/omega)^2. We need dL/d(omega) of that.\n        # L_full = S * (c/omega)^2 * k_perp^2 + P * (c/omega)^2 * ky^2\n        # dL/d(omega) = (dS/domega - 2S/omega)*... + (dP/domega - 2P/omega)*...\n        # Here we use the simplified L' = S k_perp^2 + P k_y^2\n        # So dL'/d(omega) is just dS/domega*k_perp^2 + dP/domega*ky^2\n        \n        dL_domega_prime = dS_domega * k_perp_sq + dP_domega * ky**2\n        \n        # We need d(L_full)/d(omega) for the denominator of the ray equations\n        L_full_norm = S * k_perp_sq + P * ky**2 # This is zero\n        \n        dL_full_domega = dL_domega_prime * (c/omega)**2 + (S*k_perp_sq + P*ky**2)*(-2*c**2/omega**3)\n        # Since L_full_norm is zero, second term is zero. Denominator is just dL_domega_prime * (c/omega)^2\n        # Ray equations: dr/ds = -grad_k(L_full) / (dL_full/domega)\n        # grad_k(L_full) = grad_k(L') * (c/omega)^2\n        # So dr/ds = -grad_k(L') / dL_domega_prime. The (c/omega)^2 terms cancel.\n        # This confirms we can use the simplified dispersion L' and its derivatives.\n\n        return dL_dkx, dL_dky, dL_dkz, dL_dx, dL_dy, dL_dz, dL_domega_prime\n\n    def ray_equations(s, Y):\n        \"\"\"\n        System of ODEs for ray tracing: dY/ds = F(Y).\n        Y = [x, y, z, kx, ky, kz]\n        \"\"\"\n        x, _, z, kx, ky, kz = Y\n        \n        try:\n            dL_dkx, dL_dky, dL_dkz, dL_dx, _, dL_dz, dL_domega = \\\n                get_dispersion_components(x, z, kx, ky, kz)\n        except ZeroDivisionError:\n            return np.zeros(6)\n\n        if dL_domega == 0:\n            return np.zeros(6)\n        \n        inv_dL_domega = 1.0 / dL_domega\n        \n        dYds = np.zeros(6)\n        dYds[0] = -dL_dkx * inv_dL_domega  # dx/ds\n        dYds[1] = -dL_dky * inv_dL_domega  # dy/ds\n        dYds[2] = -dL_dkz * inv_dL_domega  # dz/ds\n        dYds[3] =  dL_dx * inv_dL_domega  # dkx/ds\n        dYds[4] =  0.0                      # dky/ds\n        dYds[5] =  dL_dz * inv_dL_domega  # dkz/ds\n        \n        return dYds\n\n    test_cases = [\n        (R0 + 0.3 * a, 0.0, 300.0, 0.0),\n        (R0 + 0.1 * a, 0.2 * a, 200.0 / np.sqrt(2), 200.0 / np.sqrt(2)),\n        (R0 + 0.45 * a, 0.4 * a, 100.0, 0.0),\n    ]\n\n    s_max = 1.0e-10\n    s_span = [0, s_max]\n    final_R_values = []\n\n    for R_launch, Z_launch, kx0, kz0 in test_cases:\n        x0 = R_launch - R0\n        z0 = Z_launch\n        \n        _, B0_launch, _, n0_launch, _, _ = get_plasma_profiles(x0, z0)\n\n        omega_pe_sq_0 = n0_launch * Ce\n        omega_pi_sq_0 = n0_launch * Ci\n        omega_ce_0 = B0_launch * De\n        omega_ci_0 = B0_launch * Di\n\n        P0 = 1 - (omega_pe_sq_0 + omega_pi_sq_0) / omega_sq\n        S0 = 1 - omega_pe_sq_0 / (omega_sq - omega_ce_0**2) - omega_pi_sq_0 / (omega_sq - omega_ci_0**2)\n        \n        if -S0 / P0 < 0:\n            raise ValueError(f\"Evanescent wave at launch for R={R_launch}, Z={Z_launch}\")\n            \n        ky0 = np.sqrt(-S0 / P0 * (kx0**2 + kz0**2))\n\n        Y0 = np.array([x0, 0.0, z0, kx0, ky0, kz0])\n        \n        sol = solve_ivp(ray_equations, s_span, Y0, method='RK45', rtol=1e-8, atol=1e-10)\n        \n        x_final = sol.y[0, -1]\n        R_final = R0 + x_final\n        \n        final_R_values.append(f\"{R_final:.3f}\")\n\n    print(f\"[{','.join(final_R_values)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Once the wave reaches the target plasma region, it must asymmetrically accelerate electrons to generate a net current. This exercise delves into the fundamental kinetic physics of this process using the Fokker-Planck equation . You will derive a crucial result showing how the symmetry of the launched wave spectrum in parallel refractive index, $n_{\\parallel}$, directly controls the net driven current, providing a clear justification for designing directed wave launchers.",
            "id": "3707389",
            "problem": "Consider a magnetized plasma in a tokamak where Lower Hybrid Current Drive (LHCD) is used to drive a noninductive current by Landau damping of Lower Hybrid waves on electrons. The Lower Hybrid wave spectrum in parallel refractive index $n_{\\parallel} \\equiv c k_{\\parallel}/\\omega$ consists of two discrete components at $n_{\\parallel} = +n_{0}$ and $n_{\\parallel} = -n_{0}$, with total absorbed radio-frequency power $P_{\\mathrm{abs}}$. A fraction $\\epsilon$ of $P_{\\mathrm{abs}}$ is absorbed by the component at $n_{\\parallel} = -n_{0}$, and the remaining fraction $1 - \\epsilon$ is absorbed by the component at $n_{\\parallel} = +n_{0}$. Assume both components have the same magnitude $|n_{0}|$, the same resonance parallel phase speed $v_{\\mathrm{r}} = \\omega/k_{\\parallel}$ in magnitude, and deposit their quasilinear diffusion at $v_{\\parallel} = \\pm v_{\\mathrm{r}}$ symmetrically.\n\nStarting from the following fundamental bases:\n- The one-dimensional, steady-state, parallel-velocity Fokkerâ€“Planck equation for the electron distribution $f(v_{\\parallel})$ under quasilinear diffusion and collisional relaxation,\n- The quasilinear diffusion operator for electrostatic waves, which in the parallel direction can be modeled as a localized diffusion with coefficient $D_{\\parallel}(v_{\\parallel})$ that is proportional to wave spectral intensity and peaked at the Landau resonance $v_{\\parallel} = \\omega/k_{\\parallel}$,\n- Momentum conservation implying that the sign of $k_{\\parallel}$ determines the direction of the induced electron flux in $v_{\\parallel}$-space,\n\nshow that adding the oppositely directed spectral component at negative $n_{\\parallel}$ produces a symmetric diffusion contribution that suppresses the odd part of the response responsible for net current drive. Derive an analytic expression for the suppression factor $S_{\\mathrm{red}}(\\epsilon) \\equiv J_{\\mathrm{net}}/J_{0}$, where $J_{\\mathrm{net}}$ is the net driven current density with both components present, and $J_{0}$ is the current density that would be driven if all the power $P_{\\mathrm{abs}}$ were absorbed at $n_{\\parallel} = +n_{0}$ only.\n\nYour final answer must be a single closed-form expression for $S_{\\mathrm{red}}(\\epsilon)$ in terms of $\\epsilon$. No numerical evaluation is required, and no units are to be included in the final answer.",
            "solution": "The analysis begins with the one-dimensional, steady-state Fokker-Planck equation for the electron distribution function $f(v_{\\parallel})$ in the parallel velocity direction. In the presence of RF waves and collisions, this equation can be written as the sum of a collisional operator, $C(f)$, and a quasilinear (QL) operator, $Q(f)$, equaling zero:\n$$\n\\frac{\\partial f}{\\partial t} = C(f) + Q(f) = 0\n$$\nThe QL operator describes the interaction of electrons with the wave field and is given by:\n$$\nQ(f) = \\frac{\\partial}{\\partial v_{\\parallel}} \\left( D_{\\parallel}(v_{\\parallel}) \\frac{\\partial f}{\\partial v_{\\parallel}} \\right)\n$$\nwhere $D_{\\parallel}(v_{\\parallel})$ is the quasilinear diffusion coefficient.\n\nThe net driven current density, $J_{\\mathrm{net}}$, is given by the first moment of the electron distribution function:\n$$\nJ_{\\mathrm{net}} = -e \\int_{-\\infty}^{\\infty} v_{\\parallel} f(v_{\\parallel}) dv_{\\parallel}\n$$\nwhere $-e$ is the electron charge. We can decompose the distribution function into its even and odd parts with respect to $v_{\\parallel}$:\n$$\nf(v_{\\parallel}) = f_{\\mathrm{even}}(v_{\\parallel}) + f_{\\mathrm{odd}}(v_{\\parallel})\n$$\nwhere $f_{\\mathrm{even}}(v_{\\parallel}) = \\frac{1}{2}[f(v_{\\parallel}) + f(-v_{\\parallel})]$ and $f_{\\mathrm{odd}}(v_{\\parallel}) = \\frac{1}{2}[f(v_{\\parallel}) - f(-v_{\\parallel})]$. Substituting this into the expression for current density:\n$$\nJ_{\\mathrm{net}} = -e \\int_{-\\infty}^{\\infty} v_{\\parallel} (f_{\\mathrm{even}}(v_{\\parallel}) + f_{\\mathrm{odd}}(v_{\\parallel})) dv_{\\parallel}\n$$\nSince the integrand $v_{\\parallel} f_{\\mathrm{even}}(v_{\\parallel})$ is an odd function, its integral over a symmetric domain is zero. Thus, the current is determined solely by the odd part of the distribution function:\n$$\nJ_{\\mathrm{net}} = -e \\int_{-\\infty}^{\\infty} v_{\\parallel} f_{\\mathrm{odd}}(v_{\\parallel}) dv_{\\parallel}\n$$\nThe problem states that adding an oppositely directed wave component suppresses the current drive. This implies that this addition primarily affects $f_{\\mathrm{odd}}(v_{\\parallel})$. To see how, we analyze the source terms in the Fokker-Planck equation. In the linear or weakly non-linear regime, we consider the perturbation $\\delta f = f - f_M$ to the background Maxwellian distribution $f_M$. The linearized Fokker-Planck equation is $C_{lin}[\\delta f] + Q[f_M] = 0$. The collision operator $C$ (and its linearized form $C_{lin}$) is an even operator with respect to $v_{\\parallel}$, meaning it does not mix the parity of functions it acts upon. Consequently, the odd part of the response, $\\delta f_{\\mathrm{odd}}$, is driven exclusively by the odd part of the source term, $Q[f_M]$.\n\nThe total diffusion coefficient $D_{\\parallel}(v_{\\parallel})$ is the sum of contributions from the two wave components: one at $n_{\\parallel} = +n_0$ and one at $n_{\\parallel} = -n_0$. Let $D_0(v_{\\parallel})$ be the diffusion coefficient that would be produced if the total absorbed power $P_{\\mathrm{abs}}$ were deposited by the wave at $n_{\\parallel} = +n_0$. The problem states that the diffusion coefficient is proportional to the wave power. Therefore, a fraction $1 - \\epsilon$ of the power at $+n_0$ corresponds to a diffusion coefficient $(1-\\epsilon) D_0(v_{\\parallel})$. By symmetry, the wave at $n_{\\parallel} = -n_0$ propagating in the opposite direction has a diffusion coefficient profile that is a mirror image of the one at $+n_0$. Thus, the fraction $\\epsilon$ of power at $-n_0$ corresponds to a diffusion coefficient $\\epsilon D_0(-v_{\\parallel})$. The total diffusion coefficient is:\n$$\nD_{\\mathrm{net}}(v_{\\parallel}) = (1 - \\epsilon) D_0(v_{\\parallel}) + \\epsilon D_0(-v_{\\parallel})\n$$\nTo analyze the parity of the source term, we decompose the reference diffusion coefficient $D_0(v_{\\parallel})$ into its even and odd parts about $v_{\\parallel}=0$:\n$$\nD_0(v_{\\parallel}) = D_e(v_{\\parallel}) + D_o(v_{\\parallel})\n$$\nwhere $D_e(v_{\\parallel}) = \\frac{1}{2}[D_0(v_{\\parallel}) + D_0(-v_{\\parallel})]$ and $D_o(v_{\\parallel}) = \\frac{1}{2}[D_0(v_{\\parallel}) - D_0(-v_{\\parallel})]$.\nThen, $D_0(-v_{\\parallel}) = D_e(v_{\\parallel}) - D_o(v_{\\parallel})$. Substituting these into the expression for $D_{\\mathrm{net}}$:\n$$\nD_{\\mathrm{net}}(v_{\\parallel}) = (1 - \\epsilon) [D_e(v_{\\parallel}) + D_o(v_{\\parallel})] + \\epsilon [D_e(v_{\\parallel}) - D_o(v_{\\parallel})]\n$$\n$$\nD_{\\mathrm{net}}(v_{\\parallel}) = (1 - \\epsilon + \\epsilon) D_e(v_{\\parallel}) + (1 - \\epsilon - \\epsilon) D_o(v_{\\parallel}) = D_e(v_{\\parallel}) + (1 - 2\\epsilon) D_o(v_{\\parallel})\n$$\nThe source term for the perturbation is $Q[f_M] = \\frac{\\partial}{\\partial v_{\\parallel}} \\left( D_{\\mathrm{net}}(v_{\\parallel}) \\frac{\\partial f_M}{\\partial v_{\\parallel}} \\right)$. The Maxwellian distribution $f_M$ is an even function of $v_{\\parallel}$, so its derivative $\\frac{\\partial f_M}{\\partial v_{\\parallel}}$ is an odd function.\nLet's find the odd part of the source term. First, we examine the parity of the product inside the derivative:\n$$\nD_{\\mathrm{net}}(v_{\\parallel}) \\frac{\\partial f_M}{\\partial v_{\\parallel}} = \\underbrace{D_e(v_{\\parallel}) \\frac{\\partial f_M}{\\partial v_{\\parallel}}}_{\\text{odd}} + \\underbrace{(1 - 2\\epsilon) D_o(v_{\\parallel}) \\frac{\\partial f_M}{\\partial v_{\\parallel}}}_{\\text{even}}\n$$\nThe operator $\\frac{\\partial}{\\partial v_{\\parallel}}$ reverses parity. Applying it to the expression above, the odd part of the source term $Q[f_M]$ arises from the derivative of the even part of the product:\n$$\n(Q[f_M])_{\\mathrm{odd}} = \\frac{\\partial}{\\partial v_{\\parallel}} \\left( (1 - 2\\epsilon) D_o(v_{\\parallel}) \\frac{\\partial f_M}{\\partial v_{\\parallel}} \\right) = (1 - 2\\epsilon) \\frac{\\partial}{\\partial v_{\\parallel}} \\left( D_o(v_{\\parallel}) \\frac{\\partial f_M}{\\partial v_{\\parallel}} \\right)\n$$\nAs established, $f_{\\mathrm{odd}}$ (and thus the current $J_{\\mathrm{net}}$) is driven by this odd part of the source. Therefore, the resulting current must be proportional to the scaling factor $(1 - 2\\epsilon)$:\n$$\nJ_{\\mathrm{net}} \\propto (1 - 2\\epsilon)\n$$\nThe reference current $J_0$ is defined as the current driven when all power $P_{\\mathrm{abs}}$ is absorbed by the wave at $n_{\\parallel}=+n_0$. This corresponds to the case where $\\epsilon=0$.\n$$\nJ_0 \\propto (1 - 2 \\cdot 0) = 1\n$$\nThe suppression factor $S_{\\mathrm{red}}(\\epsilon)$ is the ratio $J_{\\mathrm{net}}/J_0$. Taking the ratio of the proportionalities:\n$$\nS_{\\mathrm{red}}(\\epsilon) = \\frac{J_{\\mathrm{net}}}{J_0} = \\frac{k(1 - 2\\epsilon)}{k(1)} = 1 - 2\\epsilon\n$$\nwhere $k$ is the constant of proportionality. This derivation shows that the addition of the oppositely directed wave component with power fraction $\\epsilon$ introduces a symmetric part to the diffusion coefficient ($D_e$) and scales down the asymmetric part ($D_o$) by a factor of $(1-2\\epsilon)$. Since only the asymmetric part of the diffusion coefficient can produce a net current, the current is suppressed by this factor. For $\\epsilon = 1/2$, the diffusion coefficient becomes purely symmetric, $D_{\\mathrm{net}} = D_e$, the odd part of the QL source vanishes, and no net current is driven, as expected.",
            "answer": "$$\n\\boxed{1 - 2\\epsilon}\n$$"
        },
        {
            "introduction": "The final step is to design a wave spectrum that optimally balances the competing requirements of wave accessibility and current drive efficiency. This practice challenges you to develop a computational tool to solve this very problem . By implementing a constrained optimization algorithm, you will explore how to design a practical $n_{\\parallel}$ spectrum that maximizes performance while accounting for physical limits and penalizing undesirable components.",
            "id": "3707380",
            "problem": "You are given a simplified, yet scientifically grounded, optimization framework for designing the parallel refractive index spectrum $n_{\\parallel}$ of Lower Hybrid Current Drive (LHCD) in nuclear fusion. The objective is to balance accessibility (wave penetration into the plasma) and efficiency (current drive per unit power), while penalizing counter-propagating components. The optimization is performed over a discrete set of spectral bins.\n\nStart from the following fundamental base.\n\n1. Cold plasma parameters and characteristic frequencies:\n   - The electron plasma frequency is $\\omega_{pe} = \\sqrt{\\frac{n_e e^2}{\\varepsilon_0 m_e}}$, where $n_e$ is the electron number density, $e$ is the elementary charge, $\\varepsilon_0$ is the vacuum permittivity, and $m_e$ is the electron mass.\n   - The electron cyclotron frequency is $\\omega_{ce} = \\frac{e B}{m_e}$, where $B$ is the magnetic field magnitude.\n   - The launched wave angular frequency is $\\omega = 2\\pi f$, where $f$ is the radiofrequency in hertz.\n   - The electron thermal speed is $v_{th} = \\sqrt{\\frac{2 k_B T_e}{m_e}}$, where $k_B$ is the Boltzmann constant and $T_e$ is the electron temperature in joules.\n\n2. Lower hybrid slow-wave accessibility constraint in the regime $\\omega_{ci} \\ll \\omega \\ll \\omega_{ce}$ (quasi-electrostatic, cold plasma, low-beta, edge-limited):\n   - Use the simplified accessibility bound\n     $$n_{\\parallel}^2 \\ge \\frac{\\omega_{pe}^2}{\\omega \\, \\omega_{ce}},$$\n     which enforces that only bins with $|\\lvert n_{\\parallel} \\rvert| \\ge n_{\\mathrm{access}}$, where\n     $$n_{\\mathrm{access}} = \\sqrt{\\frac{\\omega_{pe}^2}{\\omega \\, \\omega_{ce}}},$$\n     are admissible. Bins with $|\\lvert n_{\\parallel} \\rvert| < n_{\\mathrm{access}}$ must be assigned zero weight.\n\n3. Efficiency model:\n   - In the lower hybrid regime, the Fisch quasilinear scaling motivates a current-drive efficiency that increases as $1/n_{\\parallel}^2$ due to the resonant velocity $v_{\\mathrm{res}} = \\omega/k_{\\parallel} \\approx c/n_{\\parallel}$, resulting in reduced collisional drag at higher $v_{\\mathrm{res}}$ for smaller $n_{\\parallel}$. Use the normalized utility\n     $$\\eta(n_{\\parallel}) = \\frac{\\eta_0}{n_{\\parallel}^2} \\, \\mathcal{A}(n_{\\parallel}),$$\n     where $\\eta_0$ is a dimensionless normalization and $\\mathcal{A}(n_{\\parallel})$ is a dimensionless absorption envelope that models coupling reduction when $v_{\\mathrm{res}}$ is far above thermal speeds:\n     $$\\mathcal{A}(n_{\\parallel}) = \\exp\\!\\left(-\\left(\\frac{v_{\\mathrm{res}}}{\\kappa \\, v_{th}}\\right)^2\\right), \\quad v_{\\mathrm{res}} = \\frac{c}{\\lvert n_{\\parallel} \\rvert},$$\n     with $c$ the speed of light and $\\kappa$ a dimensionless shaping parameter.\n\n4. Counter-propagating penalty:\n   - Components with $n_{\\parallel} < 0$ are counter-propagating with respect to the desired current direction. Penalize their inclusion by subtracting a constant $\\lambda_{\\mathrm{neg}}$ from their benefit.\n\nYou will optimize the discrete weights $w_i$ over the set of bins $n_{\\parallel,i}$ to maximize the strictly concave objective\n$$\\max_{w} \\left( \\sum_{i} w_i \\, b_i - \\rho \\sum_i w_i^2 \\right),$$\nsubject to the constraints $w_i \\ge 0$, $\\sum_i w_i = 1$, and $w_i = 0$ if $\\lvert n_{\\parallel,i} \\rvert < n_{\\mathrm{access}}$, where\n$$b_i = \\frac{\\eta_0}{n_{\\parallel,i}^2} \\exp\\!\\left(-\\left(\\frac{c/\\lvert n_{\\parallel,i} \\rvert}{\\kappa \\, v_{th}}\\right)^2\\right) - \\lambda_{\\mathrm{neg}} \\, \\Theta(-n_{\\parallel,i}),$$\nand $\\Theta(\\cdot)$ is the Heaviside step function that equals $1$ for negative argument and $0$ otherwise. The parameter $\\rho > 0$ is a convex regularization coefficient that discourages excessively spiky spectra.\n\nAlgorithmic requirement: The above concave maximization over the probability simplex is equivalent to a convex minimization of $\\rho \\lVert w \\rVert_2^2 - b^{\\top} w$ under the same constraints. The unique optimizer equals the Euclidean projection of $b/(2\\rho)$ onto the probability simplex restricted to indices satisfying $\\lvert n_{\\parallel,i} \\rvert \\ge n_{\\mathrm{access}}$. Use the standard projection formula: for a vector $x$, the simplex projection yields $w_i = \\max(x_i - \\theta, 0)$ where $\\theta$ is chosen so that $\\sum_i w_i = 1$.\n\nDiscrete grid and test suite:\n- Use the fixed discrete grid of dimensionless parallel refractive indices\n  $$\\{n_{\\parallel,i}\\} = \\{-4,-3,-2,-1,1,2,3,4,5\\}.$$\n- For all test cases, the weights $w_i$ are dimensionless. Round each output weight to four decimal places.\n- Evaluate the optimized spectrum weights $w_i$ for the following four test cases, each specified by ($n_e$, $B$, $f$, $T_e$, $\\eta_0$, $\\rho$, $\\lambda_{\\mathrm{neg}}$, $\\kappa$):\n  1. Case A (happy path): $(3.0\\times 10^{19}\\,\\mathrm{m}^{-3}, 5.0\\,\\mathrm{T}, 3.7\\times 10^{9}\\,\\mathrm{Hz}, 5.0\\,\\mathrm{keV}, 1.0, 0.10, 2.0, 3.0)$.\n  2. Case B (lower density, mild penalty): $(1.5\\times 10^{19}\\,\\mathrm{m}^{-3}, 5.0\\,\\mathrm{T}, 3.7\\times 10^{9}\\,\\mathrm{Hz}, 2.0\\,\\mathrm{keV}, 1.0, 0.05, 0.5, 3.0)$.\n  3. Case C (strong field, strong penalty, hotter electrons): $(3.0\\times 10^{19}\\,\\mathrm{m}^{-3}, 7.0\\,\\mathrm{T}, 3.7\\times 10^{9}\\,\\mathrm{Hz}, 10.0\\,\\mathrm{keV}, 1.0, 0.20, 3.0, 2.5)$.\n  4. Case D (edge case with zero counter-propagation penalty and low regularization): $(2.0\\times 10^{19}\\,\\mathrm{m}^{-3}, 2.0\\,\\mathrm{T}, 4.6\\times 10^{9}\\,\\mathrm{Hz}, 12.0\\,\\mathrm{keV}, 1.0, 0.02, 0.0, 3.0)$.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each entry is itself the list of optimized weights, aligned to the grid order $\\{-4,-3,-2,-1,1,2,3,4,5\\}$ and rounded to four decimal places. For example, the printed output should look like\n  $$[[w_{A,-4},\\dots,w_{A,5}],[w_{B,-4},\\dots,w_{B,5}],[w_{C,-4},\\dots,w_{C,5}],[w_{D,-4},\\dots,w_{D,5}]].$$\nAll weights are dimensionless; no physical units are required.",
            "solution": "The user-provided problem statement has been analyzed and is determined to be valid. It is scientifically sound, well-posed, objective, and self-contained. The problem describes a scientifically-grounded optimization task for designing a Lower Hybrid Current Drive (LHCD) spectrum, providing all necessary physical models, parameters, and a specific algorithm for the solution. The parameter values are physically realistic for tokamak fusion plasmas. We may therefore proceed with a full solution.\n\nThe core of the problem is to find a set of discrete weights $w_i$ for a given grid of parallel refractive indices $n_{\\parallel,i}$ that maximizes an objective function representing a trade-off between current drive efficiency and spectral stability, subject to physical and normalization constraints.\n\nThe objective function to maximize is:\n$$\nJ(w) = \\sum_{i} w_i \\, b_i - \\rho \\sum_i w_i^2\n$$\nsubject to the constraints:\n1.  Non-negativity: $w_i \\ge 0$ for all $i$.\n2.  Normalization: $\\sum_i w_i = 1$.\n3.  Accessibility: $w_i = 0$ if $\\lvert n_{\\parallel,i} \\rvert < n_{\\mathrm{access}}$.\n\nThis is a quadratic programming problem over the probability simplex, restricted to a subset of accessible indices. As stated, the unique solution is found by projecting a specific vector onto this restricted simplex. The vector to be projected is $x = \\frac{b}{2\\rho}$, and the projection is performed only on the components of $x$ corresponding to accessible indices.\n\nThe solution process for each test case is as follows:\n\n1.  **Define Constants and Grid**: We begin by defining the necessary physical constants in SI units: the elementary charge $e$, electron mass $m_e$, vacuum permittivity $\\varepsilon_0$, and the speed of light $c$. The electron temperature $T_e$ is given in kilo-electron-volts (keV) and must be converted to Joules ($J$) for consistency ($1\\,\\mathrm{keV} = 1.60217663 \\times 10^{-16}\\,J$). The discrete grid of parallel refractive indices is given as $\\{n_{\\parallel,i}\\} = \\{-4, -3, -2, -1, 1, 2, 3, 4, 5\\}$.\n\n2.  **Calculate Physical Parameters**: For each test case defined by the tuple ($n_e, B, f, T_e, \\eta_0, \\rho, \\lambda_{\\mathrm{neg}}, \\kappa$), we calculate the relevant physical quantities.\n    *   Wave angular frequency: $\\omega = 2\\pi f$\n    *   Electron plasma frequency (squared): $\\omega_{pe}^2 = \\frac{n_e e^2}{\\varepsilon_0 m_e}$\n    *   Electron cyclotron frequency: $\\omega_{ce} = \\frac{e B}{m_e}$\n    *   Electron thermal speed: $v_{th} = \\sqrt{\\frac{2 E_{T_e}}{m_e}}$, where $E_{T_e}$ is the electron temperature in Joules.\n\n3.  **Determine Accessibility**: The simplified accessibility condition is given by $\\lvert n_{\\parallel} \\rvert \\ge n_{\\mathrm{access}}$, where the accessibility threshold is:\n    $$\n    n_{\\mathrm{access}} = \\sqrt{\\frac{\\omega_{pe}^2}{\\omega \\, \\omega_{ce}}}\n    $$\n    We compute $n_{\\mathrm{access}}$ and identify the subset of indices $I_{\\mathrm{acc}}$ from the grid for which this condition holds. For all other indices $i \\notin I_{\\mathrm{acc}}$, the weight $w_i$ is mandated to be $0$.\n\n4.  **Compute the Benefit Vector $b$**: We compute the components $b_i$ of the benefit vector for all accessible indices $i \\in I_{\\mathrm{acc}}$.\n    $$\n    b_i = \\frac{\\eta_0}{n_{\\parallel,i}^2} \\exp\\!\\left(-\\left(\\frac{c/\\lvert n_{\\parallel,i} \\rvert}{\\kappa \\, v_{th}}\\right)^2\\right) - \\lambda_{\\mathrm{neg}} \\, \\Theta(-n_{\\parallel,i})\n    $$\n    Here, $\\Theta(\\cdot)$ is the Heaviside step function, which is $1$ for a negative argument and $0$ otherwise. This term applies a penalty $\\lambda_{\\mathrm{neg}}$ to counter-propagating components ($n_{\\parallel,i} < 0$).\n\n5.  **Simplex Projection**: We form the vector $x$ to be projected, where $x_i = b_i / (2\\rho)$ for $i \\in I_{\\mathrm{acc}}$. Let this sub-vector be $x_{\\mathrm{acc}}$. The optimization problem is solved by finding the Euclidean projection of $x_{\\mathrm{acc}}$ onto the probability simplex. Let the projected vector be $w_{\\mathrm{acc}}$. This is a standard algorithm:\n    a.  Sort the components of $x_{\\mathrm{acc}}$ in descending order to get a vector $u$.\n    b.  Find the largest integer $k$ such that $u_k > \\frac{1}{k} \\left(\\sum_{j=1}^k u_j - 1\\right)$.\n    c.  Compute the value $\\theta = \\frac{1}{k} \\left(\\sum_{j=1}^k u_j - 1\\right)$.\n    d.  The components of the optimized weight vector for accessible indices are then given by $w_i = \\max(x_i - \\theta, 0)$ for each $i \\in I_{\\mathrm{acc}}$.\n\n6.  **Assemble Final Weight Vector**: A full weight vector of size $9$ is initialized to all zeros. The calculated weights $w_i$ for the accessible indices are placed at their corresponding positions in this vector. The weights for inaccessible bins remain $0$.\n\n7.  **Format Output**: The components of the final weight vector for each test case are rounded to four decimal places and formatted as specified.\n\nThis procedure is applied to each of the four test cases provided, yielding four distinct optimized weight spectra. The implementation uses the `numpy` library for efficient vectorized computations.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Calculates the optimized LHCD spectrum weights for four test cases.\n    \"\"\"\n    \n    # Physical constants in SI units\n    E_CHARGE = 1.60217663e-19  # C\n    M_E = 9.1093837e-31       # kg\n    EPSILON_0 = 8.85418781e-12 # F/m\n    C_LIGHT = 299792458.0       # m/s\n    KEV_TO_J = 1.60217663e-16 # J/keV\n\n    # Discrete grid for the parallel refractive index\n    n_par_grid = np.array([-4.0, -3.0, -2.0, -1.0, 1.0, 2.0, 3.0, 4.0, 5.0])\n\n    # Test cases: (n_e, B, f, T_e_keV, eta_0, rho, lambda_neg, kappa)\n    test_cases = [\n        # Case A\n        (3.0e19, 5.0, 3.7e9, 5.0, 1.0, 0.10, 2.0, 3.0),\n        # Case B\n        (1.5e19, 5.0, 3.7e9, 2.0, 1.0, 0.05, 0.5, 3.0),\n        # Case C\n        (3.0e19, 7.0, 3.7e9, 10.0, 1.0, 0.20, 3.0, 2.5),\n        # Case D\n        (2.0e19, 2.0, 4.6e9, 12.0, 1.0, 0.02, 0.0, 3.0),\n    ]\n\n    all_results = []\n    \n    for case in test_cases:\n        n_e, B, f, T_e_keV, eta_0, rho, lambda_neg, kappa = case\n\n        # Convert temperature from keV to Joules\n        T_e_J = T_e_keV * KEV_TO_J\n\n        # Calculate characteristic plasma and wave parameters\n        omega = 2 * np.pi * f\n        omega_pe_sq = (n_e * E_CHARGE**2) / (EPSILON_0 * M_E)\n        omega_ce = (E_CHARGE * B) / M_E\n        v_th = np.sqrt((2 * T_e_J) / M_E)\n\n        # Determine the accessibility threshold\n        n_access_sq = omega_pe_sq / (omega * omega_ce)\n        n_access = np.sqrt(n_access_sq)\n\n        # Find which bins in the grid are accessible\n        accessible_mask = np.abs(n_par_grid) >= n_access\n        \n        # Isolate the accessible part of the grid\n        n_par_acc = n_par_grid[accessible_mask]\n        \n        # Calculate the benefit vector 'b' only for accessible bins\n        if n_par_acc.size > 0:\n            v_res = C_LIGHT / np.abs(n_par_acc)\n            absorption = np.exp(-((v_res / (kappa * v_th))**2))\n            efficiency = eta_0 / (n_par_acc**2)\n            \n            benefit_acc = efficiency * absorption\n            \n            # Apply penalty for counter-propagating waves (n_parallel < 0)\n            penalty_mask = n_par_acc < 0\n            benefit_acc[penalty_mask] -= lambda_neg\n        else:\n            benefit_acc = np.array([])\n        \n        # Form the vector to be projected onto the simplex\n        x_to_project = benefit_acc / (2 * rho)\n        \n        weights_projected = np.zeros_like(x_to_project)\n        if x_to_project.size > 0:\n            # Standard algorithm for projection onto a probability simplex\n            # Sort the vector in descending order\n            u = np.sort(x_to_project)[::-1]\n            cssv = np.cumsum(u)\n            \n            # Find the largest k such that u_k - (1/k) * (sum_{j=1 to k} u_j - 1) > 0\n            indices = np.arange(len(u)) + 1\n            # The condition is u > (cssv - 1) / indices\n            condition_met = u * indices > cssv - 1\n            \n            if np.any(condition_met):\n                k = np.where(condition_met)[0][-1] + 1\n                theta = (cssv[k - 1] - 1) / k\n                weights_projected = np.maximum(x_to_project - theta, 0)\n\n        # Reconstruct the full weight vector, filling in the calculated weights\n        final_weights = np.zeros_like(n_par_grid)\n        final_weights[accessible_mask] = weights_projected\n        \n        # Format the weights for the final output string\n        rounded_weights_str = [f\"{w:.4f}\" for w in final_weights]\n        all_results.append(f\"[{','.join(rounded_weights_str)}]\")\n    \n    # Print the final collated results in the specified format\n    print(f\"[{','.join(all_results)}]\")\n\nsolve()\n```"
        }
    ]
}