{
    "hands_on_practices": [
        {
            "introduction": "要理解仿星器物理，必须掌握用于描述其复杂三维磁场的坐标系。Boozer 坐标系尤为强大，因为它能简化带电粒子的运动方程。这项练习旨在深入探讨在该坐标系下磁场 $\\mathbf{B}$ 的协变与逆变表示之间的基本关系。通过从第一性原理出发推导旋转变换 $\\iota(\\psi)$，您将对支撑仿星器理论和优化的数学结构获得深刻的实践性理解 。",
            "id": "3719637",
            "problem": "考虑一个在 Boozer 直场线坐标系中描述的理想化仿星器，其坐标为 $(\\psi,\\theta,\\phi)$，其中 $\\psi$ 标记嵌套的环形磁通量面，$\\theta$ 是角向角，$\\phi$ 是环向角。假设使用右手坐标系，使得 Levi-Civita 符号满足 $\\varepsilon^{\\psi\\theta\\phi}=+1$。旋转变换 $\\iota(\\psi)$ 由磁力线在 $\\psi=\\text{const}$ 的磁面上沿磁力线的斜率 $d\\theta/d\\phi$ 定义。\n\n给定以下基本要素：\n- 磁场与磁通量面相切，因此 $\\,\\mathbf{B}\\cdot\\nabla\\psi=0$。\n- 在 Boozer 坐标系中，磁场具有逆变（类旋度）表示\n$$\n\\mathbf{B} \\;=\\; \\nabla\\psi \\times \\nabla\\theta \\;+\\; \\iota(\\psi)\\,\\nabla\\phi \\times \\nabla\\psi \\, ,\n$$\n以及协变表示\n$$\n\\mathbf{B} \\;=\\; I(\\psi)\\,\\nabla\\theta \\;+\\; G(\\psi)\\,\\nabla\\phi \\, ,\n$$\n其中 $I(\\psi)$ 和 $G(\\psi)$ 是通量函数。\n- 协变度规系数为 $g_{ij}=\\partial_{\\!i}\\mathbf{r}\\cdot\\partial_{\\!j}\\mathbf{r}$，其中 $\\partial_{\\!i}\\mathbf{r}=\\partial\\mathbf{r}/\\partial x^{i}$，$x^{1}=\\psi$，$x^{2}=\\theta$，$x^{3}=\\phi$。雅可比行列式为 $\\sqrt{g}=\\partial_{\\!\\psi}\\mathbf{r}\\cdot(\\partial_{\\!\\theta}\\mathbf{r}\\times\\partial_{\\!\\phi}\\mathbf{r})$。\n\n仅从这些定义和恒等式出发，推导旋转变换 $\\iota(\\psi)$ 的一个闭式表达式，该表达式用 $I(\\psi)$、$G(\\psi)$ 以及 Boozer 协变度规系数 $g_{\\theta\\theta}$、$g_{\\theta\\phi}$ 和 $g_{\\phi\\phi}$ 表示。你的最终答案必须是 $\\iota(\\psi)$ 的单个解析表达式，且不得包含雅可比行列式 $\\sqrt{g}$。除已声明的假设外，不要引入任何其他假设。不需要进行数值评估，也不需要四舍五入。将你的最终答案表示为一个无量纲量（最终表达式中不提供单位）。",
            "solution": "该问题要求用通量函数 $I(\\psi)$ 和 $G(\\psi)$ 以及协变度规系数 $g_{\\theta\\theta}$、$g_{\\theta\\phi}$ 和 $g_{\\phi\\phi}$ 来推导旋转变换 $\\iota(\\psi)$ 的表达式。推导过程将通过在 Boozer 坐标系 $(\\psi, \\theta, \\phi)$ 中建立磁场 $\\mathbf{B}$ 的两种给定表示之间的关系来进行。\n\n第一种表示是协变形式：\n$$\n\\mathbf{B} = I(\\psi)\\,\\nabla\\theta + G(\\psi)\\,\\nabla\\phi\n$$\n在广义曲线坐标系 $x^i$ 中，矢量 $\\mathbf{B}$ 可以用其协变分量 $B_i$ 和倒易基矢 $\\nabla x^i$ 表示为 $\\mathbf{B} = \\sum_i B_i \\nabla x^i$。通过将此一般形式与给定的协变表示进行比较，我们可以确定 $\\mathbf{B}$ 在 $(\\psi, \\theta, \\phi)$ 坐标系中的协变分量：\n$B_\\psi = 0$\n$B_\\theta = I(\\psi)$\n$B_\\phi = G(\\psi)$\n$B_\\psi = 0$ 的条件与磁力线位于磁通量面上这一事实相符，因此 $\\mathbf{B} \\cdot \\nabla\\psi = 0$。\n\n第二种表示是逆变（类旋度）形式：\n$$\n\\mathbf{B} = \\nabla\\psi \\times \\nabla\\theta + \\iota(\\psi)\\,\\nabla\\phi \\times \\nabla\\psi\n$$\n在广义曲线坐标系中，矢量 $\\mathbf{B}$ 也可以用其逆变分量 $B^i$ 和切向基矢 $\\partial_i\\mathbf{r}$ （其中 $\\mathbf{r}$ 是位置矢量，$\\partial_i \\equiv \\partial/\\partial x^i$）表示为 $\\mathbf{B} = \\sum_i B^i \\partial_i\\mathbf{r}$。为了找到逆变分量，我们必须用切向基矢来表示梯度的叉积。其一般恒等式为：\n$$\n\\nabla x^i \\times \\nabla x^j = \\frac{1}{\\sqrt{g}} \\varepsilon^{ijk} \\partial_k\\mathbf{r}\n$$\n其中 $\\sqrt{g}$ 是坐标变换的雅可比行列式，$\\varepsilon^{ijk}$ 是 Levi-Civita 置换符号。问题指定了一个右手坐标系，$x^1 = \\psi$，$x^2 = \\theta$，$x^3 = \\phi$，并且 $\\varepsilon^{\\psi\\theta\\phi} = +1$。将此恒等式应用于 $\\mathbf{B}$ 的逆变表示中的各项：\n对于第一项：\n$$\n\\nabla\\psi \\times \\nabla\\theta = \\frac{1}{\\sqrt{g}} \\varepsilon^{\\psi\\theta\\phi} \\partial_\\phi\\mathbf{r} = \\frac{1}{\\sqrt{g}} \\partial_\\phi\\mathbf{r}\n$$\n对于第二项：\n$$\n\\nabla\\phi \\times \\nabla\\psi = \\frac{1}{\\sqrt{g}} \\varepsilon^{\\phi\\psi\\theta} \\partial_\\theta\\mathbf{r} = \\frac{1}{\\sqrt{g}} \\partial_\\theta\\mathbf{r}\n$$\n这里使用了 Levi-Civita 符号的轮换性质，$\\varepsilon^{\\phi\\psi\\theta} = \\varepsilon^{\\psi\\theta\\phi} = +1$。\n将这些表达式代回 $\\mathbf{B}$ 的第二种表示中：\n$$\n\\mathbf{B} = \\frac{1}{\\sqrt{g}} \\partial_\\phi\\mathbf{r} + \\iota(\\psi) \\left( \\frac{1}{\\sqrt{g}} \\partial_\\theta\\mathbf{r} \\right) = \\frac{\\iota(\\psi)}{\\sqrt{g}}\\partial_\\theta\\mathbf{r} + \\frac{1}{\\sqrt{g}}\\partial_\\phi\\mathbf{r}\n$$\n通过将其与一般形式 $\\mathbf{B} = B^\\psi \\partial_\\psi\\mathbf{r} + B^\\theta \\partial_\\theta\\mathbf{r} + B^\\phi \\partial_\\phi\\mathbf{r}$ 进行比较，我们可以确定 $\\mathbf{B}$ 的逆变分量：\n$B^\\psi = 0$\n$B^\\theta = \\frac{\\iota(\\psi)}{\\sqrt{g}}$\n$B^\\phi = \\frac{1}{\\sqrt{g}}$\n\n矢量的协变分量和逆变分量通过协变度规张量 $g_{ij}$ 和降指标操作相关联：\n$$\nB_i = \\sum_j g_{ij} B^j\n$$\n我们可以为 $\\theta$ 和 $\\phi$ 分量写出这种关系：\n$$\nB_\\theta = g_{\\theta\\psi}B^\\psi + g_{\\theta\\theta}B^\\theta + g_{\\theta\\phi}B^\\phi\n$$\n$$\nB_\\phi = g_{\\phi\\psi}B^\\psi + g_{\\phi\\theta}B^\\theta + g_{\\phi\\phi}B^\\phi\n$$\n现在，我们代入从 $\\mathbf{B}$ 的两种表示中找到的协变和逆变分量的表达式。使用 $B^\\psi=0$ 和度规张量的对称性 $g_{\\phi\\theta} = g_{\\theta\\phi}$：\n$$\nI(\\psi) = g_{\\theta\\theta}\\left(\\frac{\\iota(\\psi)}{\\sqrt{g}}\\right) + g_{\\theta\\phi}\\left(\\frac{1}{\\sqrt{g}}\\right)\n$$\n$$\nG(\\psi) = g_{\\theta\\phi}\\left(\\frac{\\iota(\\psi)}{\\sqrt{g}}\\right) + g_{\\phi\\phi}\\left(\\frac{1}{\\sqrt{g}}\\right)\n$$\n这两个方程构成了一个关于未知数 $\\iota(\\psi)$ 和 $1/\\sqrt{g}$ 的线性方程组。为了消去 $\\sqrt{g}$，我们可以先将两个方程都乘以 $\\sqrt{g}$：\n1. $\\quad I(\\psi)\\sqrt{g} = g_{\\theta\\theta}\\iota(\\psi) + g_{\\theta\\phi}$\n2. $\\quad G(\\psi)\\sqrt{g} = g_{\\theta\\phi}\\iota(\\psi) + g_{\\phi\\phi}$\n\n为了求解 $\\iota(\\psi)$，我们可以消去 $\\sqrt{g}$。一个更直接的方法是将方程（1）乘以 $G(\\psi)$，将方程（2）乘以 $I(\\psi)$：\n$$\nI(\\psi)G(\\psi)\\sqrt{g} = G(\\psi)(g_{\\theta\\theta}\\iota(\\psi) + g_{\\theta\\phi})\n$$\n$$\nG(\\psi)I(\\psi)\\sqrt{g} = I(\\psi)(g_{\\theta\\phi}\\iota(\\psi) + g_{\\phi\\phi})\n$$\n等式两边的左侧相同，所以我们可以令右侧相等：\n$$\nG(\\psi)(g_{\\theta\\theta}\\iota(\\psi) + g_{\\theta\\phi}) = I(\\psi)(g_{\\theta\\phi}\\iota(\\psi) + g_{\\phi\\phi})\n$$\n展开两侧可得：\n$$\nG(\\psi)g_{\\theta\\theta}\\iota(\\psi) + G(\\psi)g_{\\theta\\phi} = I(\\psi)g_{\\theta\\phi}\\iota(\\psi) + I(\\psi)g_{\\phi\\phi}\n$$\n为了求解 $\\iota(\\psi)$，我们将所有包含 $\\iota(\\psi)$ 的项移到方程的一边，所有其他项移到另一边：\n$$\nG(\\psi)g_{\\theta\\theta}\\iota(\\psi) - I(\\psi)g_{\\theta\\phi}\\iota(\\psi) = I(\\psi)g_{\\phi\\phi} - G(\\psi)g_{\\theta\\phi}\n$$\n提出因子 $\\iota(\\psi)$：\n$$\n\\iota(\\psi) \\left(G(\\psi)g_{\\theta\\theta} - I(\\psi)g_{\\theta\\phi}\\right) = I(\\psi)g_{\\phi\\phi} - G(\\psi)g_{\\theta\\phi}\n$$\n最后，通过除以括号中的项（对于物理磁场，可以证明该项非零）来分离出 $\\iota(\\psi)$，得到闭式表达式：\n$$\n\\iota(\\psi) = \\frac{I(\\psi)g_{\\phi\\phi} - G(\\psi)g_{\\theta\\phi}}{G(\\psi)g_{\\theta\\theta} - I(\\psi)g_{\\theta\\phi}}\n$$\n该表达式用指定的通量函数和度规系数表示了旋转变换 $\\iota(\\psi)$，并且不包含雅可比行列式 $\\sqrt{g}$，满足了问题的所有要求。",
            "answer": "$$\n\\boxed{\\iota(\\psi) = \\frac{I(\\psi)g_{\\phi\\phi} - G(\\psi)g_{\\theta\\phi}}{G(\\psi)g_{\\theta\\theta} - I(\\psi)g_{\\theta\\phi}}}\n$$"
        },
        {
            "introduction": "仿星器优化的主要目标是设计出能够有效约束等离子体的磁场。准对称（Quasi-symmetry, QS）概念是实现这一目标的核心策略，因为它能恢复类似托卡马克轴对称装置的良好约束特性。这项练习要求您将抽象的准对称概念转化为基于磁面上磁场强度 $B$ 的傅里叶谱的具体、可计算的度量标准。通过实现这些度量，您将学会如何量化一个给定位形的“优良”程度，并估算其新经典输运——这是评估和优化仿星器设计的关键技能 。",
            "id": "3719689",
            "problem": "给定磁场强度在单个磁面上的表示，其在Boozer角坐标中被建模为傅里叶级数：$B(\\theta,\\zeta) = B_{00} + \\sum_{(m,n)\\neq(0,0)} B_{mn} \\cos(m \\theta - n \\zeta)$，其中$\\theta$是角向角，$\\zeta$是环向角。角度必须以弧度为单位处理。考虑一个候选的准对称位形，其特征在于由固定的整数$M$和$N$定义的螺旋对称性$\\alpha = M \\theta - N \\zeta$。在一个完美的准对称位形中，场强$B$仅依赖于$\\alpha$，因此非零的傅里叶振幅$B_{mn}$只出现在指标集$S_{\\mathrm{QS}} = \\{(m,n): \\exists k \\in \\mathbb{Z}_{>0} \\text{ such that } m = k M, n = k N\\}$中。\n\n基于强磁场中导心运动的第一性原理，对准对称性的偏离可以通过位于$S_{\\mathrm{QS}}$之外的傅里叶模式的功率来量化，该功率由磁面上$B$变化的总功率进行归一化。此外，在低碰撞区，可以通过对每个非准对称模式按其沿磁力线的平行变化频率的平方进行加权，来构造一个简单的新经典输运代理指标。对于一个无量纲的旋转变换$\\iota$，磁力线遵循$\\theta(s) = \\theta_0 + s$，$\\zeta(s) = \\zeta_0 + \\iota s$，其中$s$是沿磁力线的类弧长坐标。给定傅里叶模式的相位随$s$变化为$\\phi_{mn}(s) = m \\theta(s) - n \\zeta(s)$，因此沿磁力线的变化频率为$\\omega_{mn} = m - \\iota n$。某个模式对径向漂移的弹跳平均贡献与$\\omega_{mn}$成反比，这启发我们构建一个输运代理指标，该指标通过$1/(\\omega_{mn}^2 + \\delta^2)$来对非准对称模式的功率进行加权，其中$\\delta$是一个代表有限碰撞率或非理想平均效应的小正则化参数。\n\n你的任务是实现一个程序，为每个测试用例计算两个量：\n\n1. 归一化的偏离准对称性度量\n$$\nD = \\begin{cases}\n\\displaystyle \\frac{\\sqrt{\\sum\\limits_{(m,n)\\notin S_{\\mathrm{QS}}} \\left(\\frac{B_{mn}}{B_{00}}\\right)^2}}{\\sqrt{\\sum\\limits_{(m,n)\\neq(0,0)} \\left(\\frac{B_{mn}}{B_{00}}\\right)^2}},  \\text{if } \\displaystyle \\sum\\limits_{(m,n)\\neq(0,0)} \\left(\\frac{B_{mn}}{B_{00}}\\right)^2 > 0, \\\\\n0,  \\text{otherwise}.\n\\end{cases}\n$$\n\n2. 新经典输运代理指标\n$$\nT = \\sum_{(m,n)\\notin S_{\\mathrm{QS}}} \\frac{\\left(\\frac{B_{mn}}{B_{00}}\\right)^2}{\\left(m - \\iota n\\right)^2 + \\delta^2}.\n$$\n\n在这两个定义中，常数模式$B_{00}$被排除在对$(m,n)$的求和之外，所有结果必须表示为无量纲浮点数。角度以弧度为单位。正则化参数$\\delta$必须为严格正数以避免奇异点。集合$S_{\\mathrm{QS}}$必须根据给定的$(M,N)$来识别：当且仅当存在一个整数$k \\geq 1$使得$m = k M$和$n = k N$时，$(m,n)$位于$S_{\\mathrm{QS}}$中。对于轴对称性，使用$M=1, N=0$，此时$S_{\\mathrm{QS}} = \\{(m,n): n = 0, m \\in \\mathbb{Z}_{>0}\\}$。\n\n你的推理应基于基本定律和经过充分检验的原理：从洛伦兹力$m \\, d\\mathbf{v}/dt = q (\\mathbf{v} \\times \\mathbf{B} + \\mathbf{E})$推导出的导心理论，强磁场中的磁矩不变性$\\mu = m v_\\perp^2/(2B)$，以及由旋转变换$\\iota$参数化的环形装置中的磁力线几何。除这些原理外，不要使用任何快捷公式。\n\n实现该程序以评估以下测试套件。每个测试用例由$(B_{00}, M, N, \\iota, \\delta, \\mathcal{C})$指定，其中$\\mathcal{C}$是一个由非恒定傅里叶模式的三元组$(m,n,B_{mn})$组成的列表，振幅单位为特斯拉(Tesla)：\n\n- 测试用例1（正常路径，混合准对称和非准对称内容）：\n  - $B_{00} = 5.0$, $M = 1$, $N = 3$, $\\iota = 0.93$, $\\delta = 0.01$,\n  - $\\mathcal{C} = \\{(1,3,0.10), (2,6,0.05), (1,2,0.012), (3,0,0.018), (2,5,0.008), (4,12,0.03)\\}$.\n\n- 测试用例2（边界情况，具有非零变化的完美准对称谱）：\n  - $B_{00} = 4.0$, $M = 2$, $N = 5$, $\\iota = 0.53$, $\\delta = 0.01$,\n  - $\\mathcal{C} = \\{(2,5,0.08), (4,10,0.03)\\}$.\n\n- 测试用例3（边缘情况，导致巨大输运代理指标的近共振非准对称模式）：\n  - $B_{00} = 3.0$, $M = 1$, $N = 2$, $\\iota = 2.99$, $\\delta = 0.001$,\n  - $\\mathcal{C} = \\{(3,1,0.02), (1,2,0.05), (2,4,0.02), (5,2,0.015)\\}$.\n\n- 测试用例4（边界情况，除常数模式外无变化）：\n  - $B_{00} = 5.5$, $M = 1$, $N = 0$, $\\iota = 0.34$, $\\delta = 0.01$,\n  - $\\mathcal{C} = \\{\\}$.\n\n你的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，顺序为$[D_1, T_1, D_2, T_2, D_3, T_3, D_4, T_4]$，其中$D_i$和$T_i$是为测试用例$i$计算出的值，每个值都表示为无量纲的浮点数。",
            "solution": "问题陈述已经过严格审查并被确定为有效。它在科学上基于等离子体物理和磁约束聚变的原理，特别是关于仿星器的优化。这个问题是适定的，所有参数、定义和目标函数都有明确的定义。所提供的数据在物理上是合理的。因此，我们可以着手解决。\n\n任务是为一个给定的仿星器磁场位形计算两个度量：归一化的偏离准对称性度量$D$和一个新经典输运代理指标$T$。这需要对环形磁系统中粒子运动的基本物理有正确的理解。\n\n控制质量为$m_p$、电荷为$q$的带电粒子运动的基本原理是洛伦兹力定律，$\\mathbf{F} = q(\\mathbf{v} \\times \\mathbf{B})$，这里假设电场可忽略不计。在聚变装置典型的强磁场中，粒子围绕磁力线进行快速回旋。这个回旋运动的中心被称为导心，它以速度$\\mathbf{v}_g$移动。对于与回旋运动相比在空间和时间上变化缓慢的磁场，粒子的磁矩$\\mu = m_p v_\\perp^2 / (2B)$是一个绝热不变量，其中$v_\\perp$是垂直于$\\mathbf{B}$的速度分量。\n\n能量守恒定律$E = \\frac{1}{2}m_p(v_\\parallel^2 + v_\\perp^2)$与$\\mu$的不变性相结合，意味着平行速度为$v_\\parallel = \\sqrt{2(E - \\mu B)/m_p}$。当粒子沿磁力线运动时，它会经历磁场强度$B$的变化。这些变化可能导致粒子在低$B$区域（“磁阱”）被反射（捕获）。此外，磁场强度的梯度会导致导心跨越磁力线漂移，其主要分量是梯度B漂移，$\\mathbf{v}_{\\nabla B} \\propto (\\mathbf{B} \\times \\nabla B) / B^2$。在标准环形装置中，这种漂移导致净径向位移，这是粒子和能量损失的主要机制。\n\n在像托卡马克这样的理想轴对称系统中，环向对称性确保了正则角动量的守恒，从而将粒子轨道约束在其初始磁通量面附近。仿星器缺乏这种连续对称性，这在历史上导致了其较差的约束性能。准对称（QS）原理是一个旨在恢复良好约束的复杂设计概念。如果一个磁位形的磁场强度$B$在某个磁通量面上，当用Boozer坐标$(\\theta, \\zeta)$表示时，仅依赖于某个单一的螺旋角$\\alpha = M\\theta - N\\zeta$（其中$M$和$N$为固定整数），则该位形是准对称的。在这样的场中，粒子的导心运动就像在对称系统中一样，其长期径向漂移平均接近于零，从而恢复了良好的约束。\n\n该问题使用磁面上磁场强度的傅里叶级数表示来形式化这个概念：\n$$B(\\theta,\\zeta) = B_{00} + \\sum_{(m,n)\\neq(0,0)} B_{mn} \\cos(m \\theta - n \\zeta)$$\n为了使$B$仅是$\\alpha = M\\theta - N\\zeta$的函数，任何具有非零振幅$B_{mn}$的傅里叶模式$(m,n)$其相位$m\\theta - n\\zeta$必须是$\\alpha$的整数倍。这要求对于某个整数$k$有$m\\theta - n\\zeta = k(M\\theta - N\\zeta)$。通过比较$\\theta$和$\\zeta$的系数，我们必须有$m=kM$和$n=kN$。这些“准对称”模式数的集合表示为$S_{\\mathrm{QS}} = \\{(m,n): \\exists k \\in \\mathbb{Z}_{>0} \\text{ such that } m = k M, n = k N\\}$。任何不在此集合中的模式$(m,n)$都会破坏准对称性并导致新经典输运。\n\n第一个度量$D$量化了这种对称性破缺的程度。它被定义为非准对称模式的均方根振幅与所有变化模式的均方根振幅之比。一个模式的功率可以认为与$(B_{mn})^2$成正比。通过平均场$B_{00}$进行归一化可以创建一个无量纲的量。因此，定义如下：\n$$D = \\begin{cases} \\displaystyle \\frac{\\sqrt{\\sum\\limits_{(m,n)\\notin S_{\\mathrm{QS}}} \\left(\\frac{B_{mn}}{B_{00}}\\right)^2}}{\\sqrt{\\sum\\limits_{(m,n)\\neq(0,0)} \\left(\\frac{B_{mn}}{B_{00}}\\right)^2}},  \\text{if } \\displaystyle \\sum\\limits_{(m,n)\\neq(0,0)} \\left(\\frac{B_{mn}}{B_{00}}\\right)^2 > 0, \\\\ 0,  \\text{otherwise}. \\end{cases}$$\n$D=0$的值表示一个完美的准对称场，而$D=1$表示所有的场变化都破坏了对称性。\n\n第二个度量$T$是低碰撞区新经典输运大小的一个代理指标。输运是由粒子漂移驱动的，对于与磁场结构发生共振的捕获粒子来说，这种漂移尤其大。一个沿磁力线移动的粒子感知到模式$(m,n)$的相位变化为$\\phi_{mn}(s) = m\\theta(s) - n\\zeta(s)$，其中$s$是一个类弧长坐标。对于一个旋转变换$\\iota$，磁力线路径近似为$\\theta(s) \\approx s$和$\\zeta(s) \\approx \\iota s$（忽略常数）。相位沿磁力线的变化率是平行波数，$\\omega_{mn} = d\\phi_{mn}/ds = m - \\iota n$。\n一个模式驱动输运的效率在粒子与其“共振”时最大，这意味着从粒子的角度看，模式的结构变化缓慢。这种情况发生在$|\\omega_{mn}|$很小时。由一个模式产生的输运贡献与该频率的平方成反比。输运代理指标$T$将每个非准对称模式的功率按此共振分母加权求和：\n$$T = \\sum_{(m,n)\\notin S_{\\mathrm{QS}}} \\frac{\\left(\\frac{B_{mn}}{B_{00}}\\right)^2}{\\left(m - \\iota n\\right)^2 + \\delta^2}$$\n参数$\\delta^2$是一个小的正则化项。在物理上，它解释了诸如有限碰撞率或轨道平均等效应，这些效应防止了在完美共振（$\\omega_{mn}=0$）时输运变得无穷大，从而确保模型是良态的。\n\n每个测试用例的计算过程如下：\n1. 对于一个给定的测试用例，其参数为$(B_{00}, M, N, \\iota, \\delta)$以及一组傅里叶系数$\\mathcal{C}$，为总平方变化量、非准对称平方变化量和输运代理指标$T$初始化累加器。\n2. 遍历$\\mathcal{C}$中的每个模式$(m, n, B_{mn})$。\n3. 对于每个模式$(m,n)$，通过检查是否存在整数$k \\ge 1$使得$m = kM$和$n = kN$来判断它是否属于准对称集$S_{\\mathrm{QS}}$。这可以通过检查共线性（$mN=nM$），然后找到$k$并验证它是一个大于等于1的整数来实现。\n4. 计算归一化的振幅平方$b_{mn}^2 = (B_{mn}/B_{00})^2$。将此值加到总平方变化量的累加器中。\n5. 如果模式$(m,n)$不在$S_{\\mathrm{QS}}$中，则将$b_{mn}^2$加到非准对称变化量累加器中。然后，计算其输运贡献$\\frac{b_{mn}^2}{(m-\\iota n)^2 + \\delta^2}$并将其加到$T$的累加器中。\n6. 遍历所有模式后，计算最终的度量。如果总变化量为零，则$D=0$。否则，$D$是非准对称变化量与总变化量之比的平方根。$T$是最终的累加和。对所有测试用例重复此过程。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes quasisymmetry metrics for a set of stellarator configurations.\n    \"\"\"\n    test_cases = [\n        (5.0, 1, 3, 0.93, 0.01, [(1, 3, 0.10), (2, 6, 0.05), (1, 2, 0.012), (3, 0, 0.018), (2, 5, 0.008), (4, 12, 0.03)]),\n        (4.0, 2, 5, 0.53, 0.01, [(2, 5, 0.08), (4, 10, 0.03)]),\n        (3.0, 1, 2, 2.99, 0.001, [(3, 1, 0.02), (1, 2, 0.05), (2, 4, 0.02), (5, 2, 0.015)]),\n        (5.5, 1, 0, 0.34, 0.01, []),\n    ]\n\n    results = []\n\n    def is_quasisymmetric(m, n, M, N):\n        \"\"\"\n        Checks if a mode (m, n) belongs to the quasisymmetric set S_QS\n        defined by the symmetry vector (M, N).\n        S_QS = {(m,n): exists k in Z_{>0} s.t. m=kM, n=kN}.\n        \"\"\"\n        if m == 0 and n == 0:\n            return False\n        \n        # If the symmetry vector is (0,0), S_QS is empty.\n        if M == 0 and N == 0:\n            return False\n\n        # Check for collinearity. If not collinear, not QS.\n        if m * N != n * M:\n            return False\n            \n        # If collinear, find the proportionality constant k and check its properties.\n        if M != 0:\n            # k = m / M. Check if m is a multiple of M and k is a positive integer.\n            if m % M == 0:\n                k = m // M\n                if k >= 1:\n                    return True\n        elif N != 0: # This case is when M=0, so m must be 0 for collinearity.\n            # k = n / N. Check if n is a multiple of N and k is a positive integer.\n            if n % N == 0:\n                k = n // N\n                if k >= 1:\n                    return True\n        \n        return False\n\n    for case in test_cases:\n        B00, M, N, iota, delta, C = case\n        \n        sum_nqs_sq_norm = 0.0\n        sum_total_sq_norm = 0.0\n        transport_proxy_T = 0.0\n\n        if not C: # Handle case with no varying modes\n            results.extend([0.0, 0.0])\n            continue\n\n        for m, n, Bmn in C:\n            b_mn_norm_sq = (Bmn / B00)**2\n            sum_total_sq_norm += b_mn_norm_sq\n\n            if not is_quasisymmetric(m, n, M, N):\n                sum_nqs_sq_norm += b_mn_norm_sq\n                \n                omega_mn = m - iota * n\n                transport_proxy_T += b_mn_norm_sq / (omega_mn**2 + delta**2)\n\n        if sum_total_sq_norm > 0:\n            departure_D = np.sqrt(sum_nqs_sq_norm / sum_total_sq_norm)\n        else:\n            departure_D = 0.0\n\n        results.extend([departure_D, transport_proxy_T])\n\n    # Format the final output as a comma-separated list in brackets.\n    output_str = \"[\" + \",\".join(f\"{res:.8f}\" for res in results) + \"]\"\n    print(output_str)\n\nsolve()\n```"
        },
        {
            "introduction": "当通过物理优化找到一个理想的等离子体边界形状后，最终的工程挑战是设计一套能够产生这一特定位形的外部磁场线圈。这项练习通过使用毕奥-萨伐尔定律，将缠绕面上的电流与它们在等离子体边界产生的磁场联系起来，从而解决这个反问题。通过建立并求解一个正则化最小二乘问题来找出所需的表面电流，您将接触到仿星器线圈设计的核心原理，并理解物理精度与工程复杂性之间的权衡 。",
            "id": "3719714",
            "problem": "给定一对嵌套的环形曲面，分别代表仿星器的等离子体边界和绕组曲面。目标是计算绕组曲面上的面电流，该面电流由一个在选定傅里叶谐波中展开的标量流函数表示，使得由该绕组曲面电流产生的磁场在等离子体边界上的法向分量能够最佳地抵消一个预设的目标法向场。您必须为一小组测试案例提供等离子体边界上的均方根残余法向场。所有角度均以弧度为单位，所有物理量均采用国际单位制（SI）。\n\n从以下基本原理开始：\n\n- 无位移电流的静磁学，磁场通过毕奥-萨伐尔定律计算。对于光滑曲面 $\\mathcal{S}$ 上的面电流密度 $\\mathbf{K}(\\mathbf{r})$，在场点 $\\mathbf{r}_p$ 处的磁场为\n$$\n\\mathbf{B}(\\mathbf{r}_p) = \\frac{\\mu_0}{4\\pi} \\iint_{\\mathcal{S}} \\frac{\\mathbf{K}(\\mathbf{r}) \\times \\left(\\mathbf{r}_p - \\mathbf{r}\\right)}{\\lVert \\mathbf{r}_p - \\mathbf{r} \\rVert^3} \\, \\mathrm{d}S,\n$$\n其中 $\\mu_0$ 是自由空间磁导率。\n\n- 在一个由角向角 $\\theta \\in [0,2\\pi)$ 和环向角 $\\zeta \\in [0,2\\pi)$ 参数化的绕组曲面上，其嵌入由 $\\mathbf{r}_\\mathrm{w}(\\theta,\\zeta)$ 给出，切向量为 $\\mathbf{e}_\\theta = \\partial \\mathbf{r}_\\mathrm{w}/\\partial \\theta$ 和 $\\mathbf{e}_\\zeta = \\partial \\mathbf{r}_\\mathrm{w}/\\partial \\zeta$，定义一个标量流函数 $\\lambda(\\theta,\\zeta)$。面电流密度为\n$$\n\\mathbf{K} = \\hat{\\mathbf{n}}_\\mathrm{w} \\times \\nabla_\\mathrm{s} \\lambda = \\frac{1}{J} \\left( \\frac{\\partial \\lambda}{\\partial \\theta} \\mathbf{e}_\\zeta - \\frac{\\partial \\lambda}{\\partial \\zeta} \\mathbf{e}_\\theta \\right),\n$$\n其中 $J = \\lVert \\mathbf{e}_\\theta \\times \\mathbf{e}_\\zeta \\rVert$，$\\hat{\\mathbf{n}}_\\mathrm{w}$ 是绕组曲面上的单位法向量。使用 $\\mathrm{d}S = J \\,\\mathrm{d}\\theta \\,\\mathrm{d}\\zeta$，毕奥-萨伐尔积分简化为参数空间 $(\\theta,\\zeta)$ 上的积分，无需显式地使用 $J$。\n\n- 等离子体边界成为磁面的条件是，总法向分量 $B_n = \\hat{\\mathbf{n}}_\\mathrm{p} \\cdot \\mathbf{B}$ 在等离子体边界上为零。在本练习中，给定一个预设的目标场 $B_n^\\mathrm{target}(\\theta,\\zeta)$，它代表了需要由绕组曲面电流抵消的法向场。\n\n几何形状。绕组曲面和等离子体边界均以柱坐标系下受扰动的圆形环面的形式给出。设大半径为 $R_0$，绕组小半径为 $a_\\mathrm{w}$，等离子体小半径为 $a_\\mathrm{p}$，以及振幅为 $\\varepsilon_\\mathrm{w}$ 和 $\\varepsilon_\\mathrm{p}$、螺旋度分别为 $(m_\\mathrm{w},n_\\mathrm{w})$ 和 $(m_\\mathrm{p},n_\\mathrm{p})$ 的三维小扰动，定义它们的嵌入如下：\n$$\n\\mathbf{r}_\\mathrm{surf}(\\theta,\\zeta; R_0,a,\\varepsilon,m,n) =\n\\begin{bmatrix}\n\\left(R_0 + a \\cos \\theta + \\varepsilon \\cos(m\\theta - n\\zeta)\\right) \\cos \\zeta \\\\\n\\left(R_0 + a \\cos \\theta + \\varepsilon \\cos(m\\theta - n\\zeta)\\right) \\sin \\zeta \\\\\na \\sin \\theta + \\varepsilon \\sin(m\\theta - n\\zeta)\n\\end{bmatrix}.\n$$\n对于等离子体边界，使用参数 $(R_0,a_\\mathrm{p},\\varepsilon_\\mathrm{p},m_\\mathrm{p},n_\\mathrm{p})$；对于绕组曲面，使用参数 $(R_0,a_\\mathrm{w},\\varepsilon_\\mathrm{w},m_\\mathrm{w},n_\\mathrm{w})$。在 $(\\theta,\\zeta)$ 处的等离子体边界上的单位法向量为\n$$\n\\hat{\\mathbf{n}}_\\mathrm{p}(\\theta,\\zeta) = \\frac{\\frac{\\partial \\mathbf{r}_\\mathrm{p}}{\\partial \\theta} \\times \\frac{\\partial \\mathbf{r}_\\mathrm{p}}{\\partial \\zeta}}{\\left\\lVert \\frac{\\partial \\mathbf{r}_\\mathrm{p}}{\\partial \\theta} \\times \\frac{\\partial \\mathbf{r}_\\mathrm{p}}{\\partial \\zeta} \\right\\rVert }.\n$$\n\n流函数基。绕组流函数在一组选定的整数对 $(m,n)$ 集合 $\\mathcal{H}$ 上展开为实数傅里叶基：\n$$\n\\lambda(\\theta,\\zeta) = \\sum_{(m,n)\\in \\mathcal{H}} \\left[c_{c}^{(m,n)} \\cos(m\\theta - n\\zeta) + c_{s}^{(m,n)} \\sin(m\\theta - n\\zeta)\\right].\n$$\n因此，每对 $(m,n)$ 贡献两个系数，$c_{c}^{(m,n)}$ 和 $c_{s}^{(m,n)}$，其偏导数为\n$$\n\\frac{\\partial}{\\partial \\theta}\\cos(m\\theta - n\\zeta) = -m \\sin(m\\theta - n\\zeta), \\quad\n\\frac{\\partial}{\\partial \\zeta}\\cos(m\\theta - n\\zeta) = n \\sin(m\\theta - n\\zeta),\n$$\n$$\n\\frac{\\partial}{\\partial \\theta}\\sin(m\\theta - n\\zeta) = m \\cos(m\\theta - n\\zeta), \\quad\n\\frac{\\partial}{\\partial \\zeta}\\sin(m\\theta - n\\zeta) = -n \\cos(m\\theta - n\\zeta).\n$$\n\n离散化。使用均匀张量网格进行数值积分：\n\n- 绕组曲面积分网格：在 $\\theta$ 方向上有 $N_\\theta^\\mathrm{w}$ 个点，在 $\\zeta$ 方向上有 $N_\\zeta^\\mathrm{w}$ 个点，使用矩形法则，权重为 $\\Delta \\theta^\\mathrm{w} = 2\\pi/N_\\theta^\\mathrm{w}$ 和 $\\Delta \\zeta^\\mathrm{w} = 2\\pi/N_\\zeta^\\mathrm{w}$。\n\n- 等离子体边搭配点网格：在 $\\theta$ 方向上有 $N_\\theta^\\mathrm{p}$ 个点，在 $\\zeta$ 方向上有 $N_\\zeta^\\mathrm{p}$ 个点。\n\n对于等离子体边界上的每个搭配点 $(\\theta_i^\\mathrm{p},\\zeta_j^\\mathrm{p})$，通过在绕组曲面参数空间上对毕奥-萨伐尔核函数进行数值积分，计算每个基函数对法向场的贡献。积分时使用上述 $\\mathbf{K}$ 的表达式。构建一个矩阵 $\\mathbf{A} \\in \\mathbb{R}^{N \\times K}$，该矩阵将系数向量 $\\mathbf{c} \\in \\mathbb{R}^K$ 映射到 $N = N_\\theta^\\mathrm{p} N_\\zeta^\\mathrm{p}$ 个等离子体点上的法向场。\n\n目标法向场。在等离子体边界上使用一个预设的目标法向场，\n$$\nB_n^\\mathrm{target}(\\theta,\\zeta) = B_0 \\left[\\cos(2\\theta - \\zeta) + 0.3\\,\\sin(\\theta - 2\\zeta)\\right],\n$$\n振幅为 $B_0$。此目标代表一个应由绕组曲面电流抵消的合成法向场。\n\n最优化。通过最小化吉洪诺夫（Tikhonov）正则化二次泛函来计算 $\\mathbf{c}$：\n$$\n\\min_{\\mathbf{c} \\in \\mathbb{R}^K} \\left\\lVert \\mathbf{A}\\mathbf{c} - \\mathbf{b} \\right\\rVert_2^2 + \\alpha \\left\\lVert \\mathbf{W}\\mathbf{c} \\right\\rVert_2^2,\n$$\n其中 $\\mathbf{b} \\in \\mathbb{R}^N$ 是在搭配点上 $B_n^\\mathrm{target}$ 值的向量，$\\alpha > 0$ 是一个正则化参数，$\\mathbf{W}$ 是一个对角粗糙度惩罚矩阵，其对角元 $w_k = \\sqrt{m_k^2 + n_k^2}$ 对应于来自 $(m_k,n_k)$ 的每个基系数。求解正规方程 $(\\mathbf{A}^\\top \\mathbf{A} + \\alpha \\mathbf{W}^\\top \\mathbf{W}) \\mathbf{c} = \\mathbf{A}^\\top \\mathbf{b}$。然后计算残差 $\\mathbf{r} = \\mathbf{A}\\mathbf{c} - \\mathbf{b}$，并通过均方根残差来量化误差\n$$\n\\mathrm{RMS} = \\sqrt{\\frac{1}{N} \\sum_{i=1}^N r_i^2}.\n$$\n为每个测试案例，以特斯拉（T）为单位表示最终的均方根残差值。\n\n测试组。使用以下具有科学合理性的参数值，所有带量纲的量单位为米（m）或特斯拉（T）：\n\n- 所有案例共享的几何与离散化参数：\n  - 大半径 $R_0 = 3.0$。\n  - 等离子体：$a_\\mathrm{p} = 0.5$，$\\varepsilon_\\mathrm{p} = 0.03$，$m_\\mathrm{p} = 2$，$n_\\mathrm{p} = 1$。\n  - 绕组：$a_\\mathrm{w} = 0.9$，$\\varepsilon_\\mathrm{w} = 0.05$，$m_\\mathrm{w} = 2$，$n_\\mathrm{w} = 1$。\n  - 目标振幅 $B_0 = 3.0 \\times 10^{-4}$。\n  - 等离子体网格：$N_\\theta^\\mathrm{p} = 12$，$N_\\zeta^\\mathrm{p} = 12$。\n  - 绕组积分：$N_\\theta^\\mathrm{w} = 20$，$N_\\zeta^\\mathrm{w} = 20$。\n\n- 案例A（理想情况，具有足够的谐波和弱正则化）：\n  - 基组 $\\mathcal{H} = \\{(2,1),(1,2),(1,1)\\}$，每个模式对都使用余弦和正弦。\n  - 正则化 $\\alpha = 10^{-6}$。\n\n- 案例B（强正则化，限制电流复杂度）：\n  - 基组 $\\mathcal{H} = \\{(2,1),(1,2),(1,1)\\}$，每个模式对都使用余弦和正弦。\n  - 正则化 $\\alpha = 10^{-2}$。\n\n- 案例C（谐波受限；模型设定不当）：\n  - 基组 $\\mathcal{H} = \\{(2,1)\\}$，使用余弦和正弦。\n  - 正则化 $\\alpha = 10^{-6}$。\n\n您的任务是实现一个程序，该程序能够：\n\n1. 为每个案例构建几何形状、网格、基函数和传递矩阵 $\\mathbf{A}$。\n2. 使用指定的 $\\alpha$ 和 $\\mathbf{W}$ 求解系数向量 $\\mathbf{c}$。\n3. 计算等离子体边界上的残余均方根法向场（单位：特斯拉）。\n\n最终输出格式。您的程序应生成单行输出，其中包含案例A、B和C的三个残差值，按所述顺序排列，形式为用方括号括起来的逗号分隔列表，并采用六位有效数字的科学记数法格式，例如，“[1.234560e-04,7.890120e-05,3.456780e-04]”。不应打印任何其他文本。",
            "solution": "该问题要求计算环形绕组曲面上的面电流密度，使得该电流产生的磁场能够抵消内部等离子体边界上一个预设的目标法向磁场。这是仿星器设计中的一个经典反问题，通常被称为磁场的边值问题。解决方案将通过离散化问题并求解一个正则化线性最小二乘系统来找到。然后，我们将为三个不同的测试案例计算均方根（RMS）残余法向场。\n\n方法论步骤包括以下几个连续的阶段：\n1. 定义等离子体和绕组曲面的几何形状，并计算必要的几何量。\n2. 将电流流函数的未知系数与等离子体边界上产生的法向磁场之间的关系表达为一个线性系统。\n3. 使用吉洪诺夫（Tikhonov）正则化求解该线性系统，以找到最优系数。\n4. 计算残差以量化所设计电流分布的性能。\n\n**1. 控制方程与物理模型**\n\n由分布在曲面 $\\mathcal{S}_\\mathrm{w}$ 上的面电流密度 $\\mathbf{K}$ 在场点 $\\mathbf{r}_p$ 产生的磁场 $\\mathbf{B}$ 由毕奥-萨伐尔定律给出：\n$$\n\\mathbf{B}(\\mathbf{r}_p) = \\frac{\\mu_0}{4\\pi} \\iint_{\\mathcal{S}_\\mathrm{w}} \\frac{\\mathbf{K}(\\mathbf{r}_\\mathrm{w}) \\times \\left(\\mathbf{r}_p - \\mathbf{r}_\\mathrm{w}\\right)}{\\lVert \\mathbf{r}_p - \\mathbf{r}_\\mathrm{w} \\rVert^3} \\, \\mathrm{d}S\n$$\n其中 $\\mu_0$ 是自由空间磁导率，$\\mathbf{r}_\\mathrm{w}$ 是绕组曲面 $\\mathcal{S}_\\mathrm{w}$ 上的源点，$\\mathrm{d}S$ 是曲面元。\n\n面电流 $\\mathbf{K}$ 通过标量流函数 $\\lambda(\\theta, \\zeta)$ 定义，以确保其无散度。在由 $\\mathbf{r}_\\mathrm{w}(\\theta, \\zeta)$ 参数化、切向量为 $\\mathbf{e}_\\theta = \\partial \\mathbf{r}_\\mathrm{w}/\\partial \\theta$ 和 $\\mathbf{e}_\\zeta = \\partial \\mathbf{r}_\\mathrm{w}/\\partial \\zeta$ 的曲面上，电流密度为：\n$$\n\\mathbf{K} = \\frac{1}{J_\\mathrm{w}} \\left( \\frac{\\partial \\lambda}{\\partial \\theta} \\mathbf{e}_\\zeta - \\frac{\\partial \\lambda}{\\partial \\zeta} \\mathbf{e}_\\theta \\right)\n$$\n其中 $J_\\mathrm{w} = \\lVert \\mathbf{e}_\\theta \\times \\mathbf{e}_\\zeta \\rVert$ 是曲面变换的雅可比行列式。曲面元为 $\\mathrm{d}S = J_\\mathrm{w} \\, \\mathrm{d}\\theta \\, \\mathrm{d}\\zeta$。将此代入毕奥-萨伐尔定律，雅可比行列式 $J_\\mathrm{w}$ 恰好消去：\n$$\n\\mathbf{B}(\\mathbf{r}_p) = \\frac{\\mu_0}{4\\pi} \\int_0^{2\\pi} \\int_0^{2\\pi} \\frac{\\left( \\frac{\\partial \\lambda}{\\partial \\theta} \\mathbf{e}_\\zeta - \\frac{\\partial \\lambda}{\\partial \\zeta} \\mathbf{e}_\\theta \\right) \\times (\\mathbf{r}_p - \\mathbf{r}_\\mathrm{w})}{\\lVert \\mathbf{r}_p - \\mathbf{r}_\\mathrm{w} \\rVert^3} \\, \\mathrm{d}\\theta \\, \\mathrm{d}\\zeta\n$$\n问题的目标是使等离子体边界上总磁场的法向分量 $\\hat{\\mathbf{n}}_\\mathrm{p} \\cdot \\mathbf{B}$ 等于一个目标法向场 $B_n^\\mathrm{target}$。法向量 $\\hat{\\mathbf{n}}_\\mathrm{p}$ 在等离子体曲面 $\\mathcal{S}_\\mathrm{p}$ 的每个点上计算。\n\n流函数 $\\lambda$ 在傅里叶谐波的有限集 $\\mathcal{H}$ 中展开：\n$$\n\\lambda(\\theta,\\zeta) = \\sum_{(m_k,n_k)\\in \\mathcal{H}} \\left[c_{c,k} \\cos(m_k\\theta - n_k\\zeta) + c_{s,k} \\sin(m_k\\theta - n_k\\zeta)\\right]\n$$\n该展开式是基函数的线性组合，其未知系数为 $\\mathbf{c} = \\{c_{c,k}, c_{s,k}\\}$。由于毕奥-萨伐尔定律在 $\\mathbf{K}$ 上是线性的，而 $\\mathbf{K}$ 在 $\\lambda$ 及其导数上是线性的，因此等离子体边界上产生的法向场 $B_n$ 是系数 $\\mathbf{c}$ 的线性函数。\n\n**2. 离散化与线性系统构建**\n\n为了数值求解该问题，我们对两个曲面进行离散化。等离子体边界 $\\mathcal{S}_\\mathrm{p}$ 被离散化为一组 $N = N_\\theta^\\mathrm{p} N_\\zeta^\\mathrm{p}$ 个搭配点 $\\{\\mathbf{r}_{\\mathrm{p},i}\\}_{i=1}^N$。绕组曲面 $\\mathcal{S}_\\mathrm{w}$ 被离散化为一个 $N_\\theta^\\mathrm{w} \\times N_\\zeta^\\mathrm{w}$ 的积分点网格，用于数值积分。\n\n系数 $\\mathbf{c} \\in \\mathbb{R}^K$（其中 $K$ 是基函数的总数，$K = 2|\\mathcal{H}|$）与搭配点处法向场向量 $\\mathbf{b}_\\mathrm{calc} \\in \\mathbb{R}^N$ 之间的线性关系由矩阵方程 $\\mathbf{A}\\mathbf{c} = \\mathbf{b}_\\mathrm{calc}$ 表示。矩阵 $\\mathbf{A}$ 是响应矩阵，其中元素 $A_{ij}$ 是由第 $j$ 个基函数（其系数设为1）在等离子体点 $i$ 处产生的法向磁场。\n\n$\\mathbf{A}$ 中对应于单个基函数 $\\lambda_j$ 的一列通过数值计算毕奥-萨伐尔积分来得到。对于每个等离子体点 $\\mathbf{r}_{\\mathrm{p},i}$ 及其法向量 $\\hat{\\mathbf{n}}_{\\mathrm{p},i}$，矩阵元素为：\n$$\nA_{ij} = \\hat{\\mathbf{n}}_{\\mathrm{p},i} \\cdot \\left( \\frac{\\mu_0}{4\\pi} \\sum_{q=1}^{N_\\theta^\\mathrm{w} N_\\zeta^\\mathrm{w}} \\frac{\\mathbf{K}_j(\\mathbf{r}_{\\mathrm{w},q}) \\times (\\mathbf{r}_{\\mathrm{p},i} - \\mathbf{r}_{\\mathrm{w},q})}{\\lVert \\mathbf{r}_{\\mathrm{p},i} - \\mathbf{r}_{\\mathrm{w},q} \\rVert^3} J_{\\mathrm{w},q} \\Delta\\theta_\\mathrm{w} \\Delta\\zeta_\\mathrm{w} \\right)\n$$\n其中，求和是对绕组曲面上的积分点进行的，$\\mathbf{K}_j$ 是从基函数 $\\lambda_j$ 导出的面电流。使用简化的积分，这变为：\n$$\nA_{ij} = \\hat{\\mathbf{n}}_{\\mathrm{p},i} \\cdot \\left( \\frac{\\mu_0}{4\\pi} \\sum_{q} \\frac{\\left( \\frac{\\partial \\lambda_j}{\\partial \\theta} \\mathbf{e}_{\\zeta,q} - \\frac{\\partial \\lambda_j}{\\partial \\zeta} \\mathbf{e}_{\\theta,q} \\right) \\times (\\mathbf{r}_{\\mathrm{p},i} - \\mathbf{r}_{\\mathrm{w},q})}{\\lVert \\mathbf{r}_{\\mathrm{p},i} - \\mathbf{r}_{\\mathrm{w},q} \\rVert^3} \\Delta\\theta_\\mathrm{w} \\Delta\\zeta_\\mathrm{w} \\right)\n$$\n其中 $\\Delta\\theta_\\mathrm{w} = 2\\pi/N_\\theta^\\mathrm{w}$ 和 $\\Delta\\zeta_\\mathrm{w} = 2\\pi/N_\\zeta^\\mathrm{w}$ 是矩形法则的积分权重。\n\n**3. 几何量**\n\n必须首先实现曲面的几何定义。对于由 $\\mathbf{r}_\\mathrm{surf}(\\theta,\\zeta; R_0,a,\\varepsilon,m,n)$ 给出的曲面，其笛卡尔分量为：\n$$\n\\begin{align*}\nx = (R_0 + a \\cos \\theta + \\varepsilon \\cos(m\\theta - n\\zeta)) \\cos \\zeta \\\\\ny = (R_0 + a \\cos \\theta + \\varepsilon \\cos(m\\theta - n\\zeta)) \\sin \\zeta \\\\\nz = a \\sin \\theta + \\varepsilon \\sin(m\\theta - n\\zeta)\n\\end{align*}\n$$\n通过计算关于 $\\theta$ 和 $\\zeta$ 的解析偏导数，得到切向量 $\\mathbf{e}_\\theta = \\partial \\mathbf{r}/\\partial \\theta$ 和 $\\mathbf{e}_\\zeta = \\partial \\mathbf{r}/\\partial \\zeta$。等离子体边界上未归一化的法向量为 $\\mathbf{n}_\\mathrm{p} = \\mathbf{e}_{\\theta,\\mathrm{p}} \\times \\mathbf{e}_{\\zeta,\\mathrm{p}}$，单位法向量为 $\\hat{\\mathbf{n}}_\\mathrm{p} = \\mathbf{n}_\\mathrm{p} / \\lVert \\mathbf{n}_\\mathrm{p} \\rVert$。这些量都在它们各自的网格上进行评估。\n\n**4. 最优化**\n\n目标是找到系数向量 $\\mathbf{c}$，以最小化计算出的法向场 $\\mathbf{A}\\mathbf{c}$ 与目标法向场向量 $\\mathbf{b}$ 之间的平方差，其中 $\\mathbf{b}$ 是通过在等离子体搭配点上评估 $B_n^\\mathrm{target}$ 得到的。为了处理潜在的病态问题并倾向于物理上更平滑的电流，添加了一个吉洪诺夫（Tikhonov）正则化项。优化问题是：\n$$\n\\min_{\\mathbf{c} \\in \\mathbb{R}^K} \\left\\lVert \\mathbf{A}\\mathbf{c} - \\mathbf{b} \\right\\rVert_2^2 + \\alpha \\left\\lVert \\mathbf{W}\\mathbf{c} \\right\\rVert_2^2\n$$\n此处，$\\alpha > 0$ 是正则化参数。$\\mathbf{W}$ 是一个对角加权矩阵，其中对应于模数 $(m_k, n_k)$ 的基函数的项为 $w_k = \\sqrt{m_k^2 + n_k^2}$。这会惩罚具有较高模数（即更多空间振荡）的谐波，从而促进更平滑的电流分布。这个最小化问题等价于求解以下关于 $\\mathbf{c}$ 的线性正规方程组：\n$$\n(\\mathbf{A}^\\top \\mathbf{A} + \\alpha \\mathbf{W}^\\top \\mathbf{W}) \\mathbf{c} = \\mathbf{A}^\\top \\mathbf{b}\n$$\n该系统使用标准线性代数程序求解。\n\n**5. 误差评估**\n\n一旦找到最优系数向量 $\\mathbf{c}$，就计算残差向量 $\\mathbf{r} = \\mathbf{A}\\mathbf{c} - \\mathbf{b}$。解的总体质量通过该残差的均方根（RMS）来量化：\n$$\n\\mathrm{RMS} = \\sqrt{\\frac{1}{N} \\sum_{i=1}^N r_i^2}\n$$\n此值以特斯拉为单位，表示等离子体边界上未被抵消的法向磁场的平均大小。\n\n**6. 测试案例分析**\n\n- **案例A** 使用基组 $\\mathcal{H} = \\{(2,1),(1,2),(1,1)\\}$，它包含了目标场 $B_n^\\mathrm{target} = B_0 [\\cos(2\\theta - \\zeta) + 0.3\\,\\sin(\\theta - 2\\zeta)]$ 中存在的谐波，外加一个附加谐波 $(1,1)$。使用一个小的正则化参数 $\\alpha = 10^{-6}$，解应该能够精确逼近目标，从而得到较低的RMS误差。\n- **案例B** 使用与案例A相同的完备基组，但正则化参数大得多，$\\alpha = 10^{-2}$。这种对系数大小（按模数加权）的强惩罚将限制电流的复杂度，导致对目标场的抵消效果变差，以及显著更高的RMS误差。\n- **案例C** 涉及模型设定不当。基组 $\\mathcal{H} = \\{(2,1)\\}$ 是不完整的，因为它缺少抵消 $B_n^\\mathrm{target}$ 中第二项所需的 $(1,2)$ 谐波。即使采用弱正则化（$\\alpha = 10^{-6}$），该模型也无法完全表示目标场，这将导致显著的RMS误差，可能主要由未被抵消的 $\\sin(\\theta - 2\\zeta)$ 分量引起。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the stellarator coil design problem for three test cases.\n    \"\"\"\n    # Physical and geometrical constants\n    MU0 = 4 * np.pi * 1e-7  # Permeability of free space (T*m/A)\n    R0 = 3.0  # Major radius (m)\n\n    # Plasma surface parameters\n    a_p = 0.5\n    eps_p = 0.03\n    m_p = 2\n    n_p = 1\n    N_theta_p = 12\n    N_zeta_p = 12\n\n    # Winding surface parameters\n    a_w = 0.9\n    eps_w = 0.05\n    m_w = 2\n    n_w = 1\n    N_theta_w = 20\n    N_zeta_w = 20\n\n    # Target field parameters\n    B0 = 3.0e-4\n\n    # Test cases\n    cases = [\n        {'name': 'A', 'H': [(2, 1), (1, 2), (1, 1)], 'alpha': 1e-6},\n        {'name': 'B', 'H': [(2, 1), (1, 2), (1, 1)], 'alpha': 1e-2},\n        {'name': 'C', 'H': [(2, 1)], 'alpha': 1e-6}\n    ]\n\n    def get_surface_geometry(theta, zeta, R0_val, a, eps, m, n):\n        \"\"\"\n        Computes surface position vector and its derivatives.\n        theta and zeta can be 1D or 2D arrays.\n        \"\"\"\n        R = R0_val + a * np.cos(theta) + eps * np.cos(m * theta - n * zeta)\n        R_d_theta = -a * np.sin(theta) - m * eps * np.sin(m * theta - n * zeta)\n        R_d_zeta = n * eps * np.sin(m * theta - n * zeta)\n\n        cos_zeta = np.cos(zeta)\n        sin_zeta = np.sin(zeta)\n\n        r = np.stack([\n            R * cos_zeta,\n            R * sin_zeta,\n            a * np.sin(theta) + eps * np.sin(m * theta - n * zeta)], axis=-1)\n\n        e_theta = np.stack([\n            R_d_theta * cos_zeta,\n            R_d_theta * sin_zeta,\n            a * np.cos(theta) + m * eps * np.cos(m * theta - n * zeta)], axis=-1)\n        \n        e_zeta = np.stack([\n            R_d_zeta * cos_zeta - R * sin_zeta,\n            R_d_zeta * sin_zeta + R * cos_zeta,\n            -n * eps * np.cos(m * theta - n * zeta)], axis=-1)\n        \n        return r, e_theta, e_zeta\n\n    # --- Pre-computation for Plasma Surface ---\n    theta_p_1d = np.linspace(0, 2 * np.pi, N_theta_p, endpoint=False)\n    zeta_p_1d = np.linspace(0, 2 * np.pi, N_zeta_p, endpoint=False)\n    theta_p_grid, zeta_p_grid = np.meshgrid(theta_p_1d, zeta_p_1d, indexing='ij')\n\n    r_p_grid, e_theta_p, e_zeta_p = get_surface_geometry(\n        theta_p_grid, zeta_p_grid, R0, a_p, eps_p, m_p, n_p)\n    \n    n_p_vec_grid = np.cross(e_theta_p, e_zeta_p, axis=-1)\n    norm_n_p = np.linalg.norm(n_p_vec_grid, axis=-1, keepdims=True)\n    n_p_unit_grid = n_p_vec_grid / norm_n_p\n\n    N_p = N_theta_p * N_zeta_p\n    r_p_flat = r_p_grid.reshape(N_p, 3)\n    n_p_unit_flat = n_p_unit_grid.reshape(N_p, 3)\n\n    # --- Pre-computation for Winding Surface ---\n    d_theta_w = 2 * np.pi / N_theta_w\n    d_zeta_w = 2 * np.pi / N_zeta_w\n    theta_w_1d = np.linspace(0, 2 * np.pi, N_theta_w, endpoint=False)\n    zeta_w_1d = np.linspace(0, 2 * np.pi, N_zeta_w, endpoint=False)\n    theta_w_grid, zeta_w_grid = np.meshgrid(theta_w_1d, zeta_w_1d, indexing='ij')\n\n    r_w_grid, e_theta_w, e_zeta_w = get_surface_geometry(\n        theta_w_grid, zeta_w_grid, R0, a_w, eps_w, m_w, n_w)\n\n    # --- Target Field Vector b ---\n    b_target = B0 * (np.cos(2 * theta_p_grid - zeta_p_grid) + 0.3 * np.sin(theta_p_grid - 2 * zeta_p_grid))\n    b = b_target.flatten()\n\n    results = []\n    for case in cases:\n        harmonics = case['H']\n        alpha = case['alpha']\n        \n        basis_functions = []\n        for m, n in harmonics:\n            basis_functions.append({'m': m, 'n': n, 'type': 'cos'})\n            basis_functions.append({'m': m, 'n': n, 'type': 'sin'})\n        \n        K = len(basis_functions)\n        A = np.zeros((N_p, K))\n        W = np.zeros((K, K))\n\n        for k, basis in enumerate(basis_functions):\n            m, n, f_type = basis['m'], basis['n'], basis['type']\n            W[k, k] = np.sqrt(m**2 + n**2)\n            \n            # Derivatives of the basis stream function lambda_k\n            if f_type == 'cos':\n                # lambda = cos(m*theta - n*zeta)\n                dlambda_dtheta = -m * np.sin(m * theta_w_grid - n * zeta_w_grid)\n                dlambda_dzeta = n * np.sin(m * theta_w_grid - n * zeta_w_grid)\n            else: # sin\n                # lambda = sin(m*theta - n*zeta)\n                dlambda_dtheta = m * np.cos(m * theta_w_grid - n * zeta_w_grid)\n                dlambda_dzeta = -n * np.cos(m * theta_w_grid - n * zeta_w_grid)\n\n            # Surface current density * Jacobian: K*J\n            K_J = (dlambda_dtheta[..., np.newaxis] * e_zeta_w - \n                   dlambda_dzeta[..., np.newaxis] * e_theta_w)\n\n            # Build column k of matrix A\n            for i in range(N_p):\n                r_p = r_p_flat[i]\n                n_p = n_p_unit_flat[i]\n                \n                # Vector from source to field point\n                diff = r_p - r_w_grid\n                dist_cubed = np.linalg.norm(diff, axis=-1)**3\n                \n                # Biot-Savart integrand vector (K*J x diff / |diff|^3)\n                integrand_vec = np.cross(K_J, diff) / dist_cubed[..., np.newaxis]\n\n                # Numerical integration (sum over winding grid)\n                B_vec = np.sum(integrand_vec, axis=(0, 1)) * d_theta_w * d_zeta_w\n                B_vec *= (MU0 / (4 * np.pi))\n\n                # Normal component of the B-field at plasma point i\n                A[i, k] = np.dot(n_p, B_vec)\n\n        # Solve the normal equations\n        AtA = A.T @ A\n        WtW = W.T @ W\n        Atb = A.T @ b\n        \n        # System: (AtA + alpha * WtW) c = Atb\n        # SciPy's linalg.solve is more robust, but numpy's is sufficient here.\n        c = np.linalg.solve(AtA + alpha * WtW, Atb)\n        \n        # Compute residual and RMS error\n        residual = A @ c - b\n        rms_error = np.sqrt(np.mean(residual**2))\n        results.append(rms_error)\n\n    # Format output as specified\n    formatted_results = [f\"{r:.6e}\" for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}