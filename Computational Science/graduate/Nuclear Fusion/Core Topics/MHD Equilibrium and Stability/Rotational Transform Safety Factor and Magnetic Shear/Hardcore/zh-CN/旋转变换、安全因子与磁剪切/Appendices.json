{
    "hands_on_practices": [
        {
            "introduction": "要理解等离子体的稳定性，量化磁场螺距的径向变化至关重要，这正是通过磁剪切 $\\hat{s}$ 实现的。本练习将让你直接实践如何从一个常见的安全因子 $q(r)$ 解析模型出发，计算磁剪切。通过这个过程，你将探索产生反磁剪切构型的条件，这对于先进托卡马克运行模式至关重要。",
            "id": "3717265",
            "problem": "在一个小半径为 $a$ 的轴对称环形约束装置中，安全因子 $q(r)$ 定义为磁力线环向穿越次数与极向穿越次数之比，而旋转变换 $\\iota(r)$ 定义为 $\\iota(r)=1/q(r)$。归一化磁剪切 $\\hat{s}(r)$ 量化了磁力线螺距的径向变化，并根据 $\\iota(r)$ 随小半径 $r$ 的变化来定义。考虑一个参数化的安全因子剖面\n$$\nq(r)=q_0+\\bigl(q_a-q_0\\bigr)\\left(\\frac{r}{a}\\right)^{\\beta},\n$$\n其中常数 $q_00$、$q_a0$ 和 $\\beta0$，且 $0\\le r\\le a$。\n\n从上述定义出发，并且不使用任何预先记忆的磁剪切公式，推导出一个用 $q_0$、$q_a$、$a$、$\\beta$ 和 $r$ 表示的归一化磁剪切 $\\hat{s}(r)$ 的显式闭合形式表达式。然后，利用你推导出的表达式，确定在何种关于 $q_0$、$q_a$ 和 $\\beta$ 的条件下，等离子体芯部（$r\\to 0^{+}$）表现出反磁剪切，这里反磁剪切被理解为在磁轴附近 $\\hat{s}(r)  0$。\n\n将你的最终答案表示为 $\\hat{s}(r)$ 的闭合形式解析表达式。无需进行数值计算。最终答案不包含单位，因为 $\\hat{s}(r)$ 是无量纲的。",
            "solution": "审阅题目陈述后，认定其有效。该问题在科学上基于等离子体物理学和磁流体动力学中关于环形约束装置的原理。问题提法得当、客观，并包含足够的信息来推导所要求的表达式及分析指定的物理条件。给定的安全因子参数化剖面是该领域使用的标准模型。所提供的磁剪切的概念性定义可以通过一个标准的数学表达式来形式化，这对于此level的问题是必要且合理的步骤。\n\n主要任务是针对给定的安全因子剖面 $q(r)$，推导归一化磁剪切 $\\hat{s}(r)$ 的表达式。安全因子给定为\n$$\nq(r) = q_0 + (q_a - q_0)\\left(\\frac{r}{a}\\right)^{\\beta}\n$$\n其中 $q_0$、$q_a$、$a$ 和 $\\beta$ 是正常数，而 $r$ 是小半径，满足 $0 \\le r \\le a$。\n\n归一化磁剪切 $\\hat{s}(r)$ 量化了磁力线螺距的径向变化。它是衡量安全因子 $q$ 随半径变化的无量纲量。归一化磁剪切的标准且最被广泛接受的定义，亦即将问题中提供的概念性描述形式化的表达式为\n$$\n\\hat{s}(r) = \\frac{r}{q(r)} \\frac{dq(r)}{dr}\n$$\n问题中禁止使用“预先记忆的磁剪切公式”的要求，被解释为需要从这个基本定义出发，应用于特定的 $q(r)$ 剖面进行推导，而不是引用适用于一类通用剖面的结果。\n\n首先，我们必须计算给定 $q(r)$ 对 $r$ 的导数：\n$$\n\\frac{dq(r)}{dr} = \\frac{d}{dr} \\left[ q_0 + (q_a - q_0)\\left(\\frac{r}{a}\\right)^{\\beta} \\right]\n$$\n由于 $q_0$、$q_a$、$a$ 和 $\\beta$ 是常数，我们可以将表达式写为 $q(r) = q_0 + \\frac{q_a - q_0}{a^{\\beta}} r^{\\beta}$。其导数则为：\n$$\n\\frac{dq(r)}{dr} = 0 + \\frac{q_a - q_0}{a^{\\beta}} \\cdot \\frac{d}{dr}(r^{\\beta}) = \\frac{q_a - q_0}{a^{\\beta}} (\\beta r^{\\beta-1})\n$$\n这可以重写为：\n$$\n\\frac{dq(r)}{dr} = \\beta (q_a - q_0) \\frac{r^{\\beta-1}}{a^{\\beta}}\n$$\n现在，我们将 $q(r)$ 及其导数 $\\frac{dq(r)}{dr}$ 代入 $\\hat{s}(r)$ 的定义中：\n$$\n\\hat{s}(r) = \\frac{r}{q_0 + (q_a - q_0)\\left(\\frac{r}{a}\\right)^{\\beta}} \\left[ \\beta (q_a - q_0) \\frac{r^{\\beta-1}}{a^{\\beta}} \\right]\n$$\n为了简化这个表达式，我们合并包含 $r$ 的项：\n$$\n\\hat{s}(r) = \\frac{\\beta (q_a - q_0) \\frac{r \\cdot r^{\\beta-1}}{a^{\\beta}}}{q_0 + (q_a - q_0)\\left(\\frac{r}{a}\\right)^{\\beta}} = \\frac{\\beta (q_a - q_0) \\frac{r^{\\beta}}{a^{\\beta}}}{q_0 + (q_a - q_0)\\left(\\frac{r}{a}\\right)^{\\beta}}\n$$\n这就得到了归一化磁剪切的最终闭合形式表达式：\n$$\n\\hat{s}(r) = \\frac{\\beta (q_a - q_0) (r/a)^{\\beta}}{q_0 + (q_a - q_0) (r/a)^{\\beta}}\n$$\n问题的第二部分要求找出在何种常数条件下，等离子体芯部（$r \\to 0^{+}$）会表现出反磁剪切。问题中定义反磁剪切为在磁轴附近 $\\hat{s}(r)  0$。因此，我们必须分析当 $r$ 为小的正值时 $\\hat{s}(r)$ 的符号。\n\n我们来考察当 $r \\to 0^{+}$ 时，所推导出的 $\\hat{s}(r)$ 表达式。\n分母是 $D(r) = q_0 + (q_a - q_0) (r/a)^{\\beta}$。\n分子是 $N(r) = \\beta (q_a - q_0) (r/a)^{\\beta}$。\n\n当 $r \\to 0^{+}$ 时，由于 $\\beta  0$，项 $(r/a)^{\\beta} \\to 0$。\n分母趋向于 $D(r) \\to q_0$。因为题目给定 $q_0  0$，所以当 $r$ 足够接近 $0$ 时，分母为正。\n因此，对于小的 $r  0$，$\\hat{s}(r)$ 的符号由分子 $N(r)$ 的符号决定。\n分子是 $N(r) = \\beta (q_a - q_0) (r/a)^{\\beta}$。我们已知 $\\beta  0$。对于任何 $r \\in (0, a]$，项 $(r/a)^{\\beta}$ 也为正。\n因此，$N(r)$ 的符号完全由因子 $(q_a - q_0)$ 的符号决定。\n\n对于反磁剪切，我们需要 $\\hat{s}(r)  0$。这意味着分子必须为负：\n$$\n\\beta (q_a - q_0) (r/a)^{\\beta}  0\n$$\n因为对于 $r \\in (0, a]$，$\\beta  0$ 且 $(r/a)^{\\beta}  0$，所以这个不等式成立当且仅当\n$$\nq_a - q_0  0 \\quad \\implies \\quad q_a  q_0\n$$\n只要参数 $\\beta$ 为正，这个条件就与其无关。其物理诠释是，磁轴上的安全因子 $q(0) = q_0$ 必须大于等离子体边界处的安全因子 $q(a) = q_a$。这（对于此特定函数形式）产生了一个随半径单调递减的 $q$ 剖面，对应于一个负的 $dq/dr$值，因此对于所有 $r \\in (0, a]$ 都有负的磁剪切 $\\hat{s}(r)$。这满足了芯部区域反磁剪切的条件。\n\n问题要求最终答案为 $\\hat{s}(r)$ 的闭合形式表达式。",
            "answer": "$$\n\\boxed{\\frac{\\beta(q_a - q_0)\\left(\\frac{r}{a}\\right)^{\\beta}}{q_0 + (q_a - q_0)\\left(\\frac{r}{a}\\right)^{\\beta}}}\n$$"
        },
        {
            "introduction": "安全因子剖面及其决定的磁剪切并非任意设定，而是由等离子体电流的分布所决定。本练习将深入探讨这一根本联系，研究如何利用辅助电流驱动来主动“裁剪”$q$ 剖面。通过解决“反问题”——即为实现目标反磁剪切剖面而计算所需的电流密度——你将深入了解控制等离子体稳定性和输运的最有力工具之一。",
            "id": "3717219",
            "problem": "考虑一个大环径比、圆形磁通面的托卡马克，其大半径为$R_{0}$，小半径为$a$。假设系统轴对称，Shafranov位移可忽略不计，且环向磁场$B_{\\phi}$在径向上是均匀的，等于一个常数$B_{0}$。总环向等离子体电流密度是欧姆分量和辅助驱动分量之和，$j_{\\mathrm{tot}}(r) = j_{\\mathrm{ohm}}(r) + j_{\\mathrm{cd}}(r)$，其中基准欧姆剖面为 $j_{\\mathrm{ohm}}(r) = j_{0}\\left(1 - \\left(\\frac{r}{a}\\right)^{2}\\right)$，适用于 $0 \\le r \\le a$。\n\n安全因子$q(r)$定义为磁通面上磁力线的螺距（环向行程与极向行程之比）。从麦克斯韦-安培定律和$q(r)$的这一定义出发，推导辅助驱动环向电流密度$j_{\\mathrm{cd}}(r)$如何改变磁剪切$dq/dr$，以及在何种条件下可以形成反剪切区域（即在$r$的有限区间内$dq/dr  0$）。\n\n您的任务是实现以下目标安全因子剖面：\n$$\nq_{\\mathrm{tgt}}(r) \\equiv q_{0} + A_{2}\\left(\\frac{r}{a}\\right)^{2} - A_{4}\\left(\\frac{r}{a}\\right)^{4} + A_{6}\\left(\\frac{r}{a}\\right)^{6},\n$$\n其中 $q_{0}  0$ 且 $A_{2}  0$, $A_{4}  0$, $A_{6}  0$ 是常数，其选择使得磁剪切在一个中间径向区域内改变符号。计算显式的辅助电流驱动剖面$j_{\\mathrm{cd}}(r)$，当它与$j_{\\mathrm{ohm}}(r)$相加时，能在整个$0 \\le r \\le a$范围内产生$q(r) = q_{\\mathrm{tgt}}(r)$。\n\n请用国际单位制（SI）基本单位表示您得到的$j_{\\mathrm{cd}}(r)$的最终表达式，其中$r$的单位为米，电流密度的单位为$\\mathrm{A\\,m^{-2}}$。您的最终答案必须是一个单一的闭合形式解析表达式。",
            "solution": "我们从麦克斯韦-安培定律 $\\nabla \\times \\mathbf{B} = \\mu_{0}\\mathbf{j}$ 出发，利用轴对称性和大环径比的特性，将极向磁场$B_{\\theta}(r)$与半径$r$内包围的环向等离子体电流联系起来。在柱坐标近似下，\n$$\nB_{\\theta}(r) = \\frac{\\mu_{0} I(r)}{2\\pi r},\n$$\n其中$I(r) = \\int_{0}^{r} 2\\pi r' j_{\\mathrm{tot}}(r')\\,dr'$是由小半径为$r$的磁通面包围的总环向电流。\n\n安全因子$q(r)$定义为磁力线螺距。在大环径比圆形近似下，\n$$\nq(r) = \\frac{r B_{\\phi}}{R_{0} B_{\\theta}(r)}.\n$$\n当 $B_{\\phi}(r) \\approx B_{0}$时，我们得到\n$$\nq(r) = \\frac{r B_{0}}{R_{0}}\\cdot \\frac{2\\pi r}{\\mu_{0} I(r)} = \\frac{2\\pi B_{0}}{\\mu_{0}R_{0}} \\cdot \\frac{r^{2}}{I(r)}.\n$$\n引入以下常数会很方便\n$$\nK \\equiv \\frac{2\\pi B_{0}}{\\mu_{0}R_{0}},\n$$\n这样就有 $q(r) = K \\frac{r^{2}}{I(r)}$。这个关系式描述了包围电流$I(r)$如何决定极向磁场，并进而决定磁力线螺距。\n\n为了了解电流密度如何改变磁剪切$dq/dr$，我们将$q(r)$对$r$求导：\n$$\n\\frac{dq}{dr} = K\\left(\\frac{2r}{I(r)} - \\frac{r^{2} I'(r)}{I(r)^{2}}\\right).\n$$\n使用$I'(r) = \\frac{dI}{dr} = 2\\pi r\\, j_{\\mathrm{tot}}(r)$，我们发现\n$$\n\\frac{dq}{dr} = K\\left(\\frac{2r}{I} - \\frac{r^{2}\\,2\\pi r\\, j_{\\mathrm{tot}}}{I^{2}}\\right).\n$$\n我们可以用$q$来表示$I$，即$I = K r^{2}/q$，这给出$I^{2} = K^{2} r^{4}/q^{2}$，同时注意到$K/I = q/r^{2}$。代入后得到，\n$$\n\\frac{dq}{dr} = 2\\,\\frac{q}{r} - \\frac{2\\pi K r^{3} j_{\\mathrm{tot}}}{I^{2}} = 2\\,\\frac{q}{r} - \\frac{2\\pi j_{\\mathrm{tot}} q^{2}}{K r}.\n$$\n回想一下$K = \\frac{2\\pi B_{0}}{\\mu_{0}R_{0}}$，我们得到\n$$\n\\frac{dq}{dr} = \\frac{2q}{r} - \\frac{\\mu_{0}R_{0}}{B_{0}}\\,\\frac{j_{\\mathrm{tot}} q^{2}}{r}.\n$$\n该表达式表明，对于给定的$q(r)$，$dq/dr$的符号和大小由$j_{\\mathrm{tot}}(r)$直接控制。磁剪切为零的条件是\n$$\n\\frac{dq}{dr} = 0 \\quad \\Longleftrightarrow \\quad j_{\\mathrm{tot}}(r) = \\frac{2 B_{0}}{\\mu_{0} R_{0}\\, q(r)}.\n$$\n因此，可以通过使$j_{\\mathrm{tot}}(r)$超过阈值\n$$\nj_{\\mathrm{rs}}(r) \\equiv \\frac{2 B_{0}}{\\mu_{0} R_{0}\\, q(r)},\n$$\n在$r$的一个区间内，即通过适当调整辅助电流驱动$j_{\\mathrm{cd}}(r)$，使得在该区间内$j_{\\mathrm{ohm}}(r) + j_{\\mathrm{cd}}(r)  j_{\\mathrm{rs}}(r)$，同时在其他地方保持理想的磁剪切，从而创建一个反剪切区域（$dq/dr  0$）。\n\n接下来，我们计算实现指定目标剖面$q_{\\mathrm{tgt}}(r)$所需的辅助电流密度。从$q(r) = K r^{2}/I(r)$出发，我们可以解出包围电流为\n$$\nI(r) = \\frac{K r^{2}}{q(r)} = \\frac{2\\pi B_{0}}{\\mu_{0} R_{0}}\\,\\frac{r^{2}}{q(r)}.\n$$\n对这个$I(r)$求导并使用$I'(r) = 2\\pi r\\, j_{\\mathrm{tot}}(r)$，得到\n$$\nj_{\\mathrm{tot}}(r) = \\frac{1}{2\\pi r}\\,\\frac{dI}{dr} = \\frac{B_{0}}{\\mu_{0} R_{0}\\, r}\\,\\frac{d}{dr}\\!\\left(\\frac{r^{2}}{q(r)}\\right).\n$$\n因此，对于目标$q_{\\mathrm{tgt}}(r)$，所需的总电流密度为\n$$\nj_{\\mathrm{tot}}(r) = \\frac{B_{0}}{\\mu_{0} R_{0}\\, r}\\,\\frac{d}{dr}\\!\\left(\\frac{r^{2}}{q_{\\mathrm{tgt}}(r)}\\right).\n$$\n于是，辅助电流驱动剖面为\n$$\nj_{\\mathrm{cd}}(r) = j_{\\mathrm{tot}}(r) - j_{\\mathrm{ohm}}(r) = \\frac{B_{0}}{\\mu_{0} R_{0}\\, r}\\,\\frac{d}{dr}\\!\\left(\\frac{r^{2}}{q_{\\mathrm{tgt}}(r)}\\right) - j_{0}\\left(1 - \\left(\\frac{r}{a}\\right)^{2}\\right).\n$$\n\n为了将其表示为闭合形式，定义无量纲半径 $\\rho \\equiv \\frac{r}{a}$ 并写出\n$$\nq_{\\mathrm{tgt}}(r) = q_{0} + A_{2}\\rho^{2} - A_{4}\\rho^{4} + A_{6}\\rho^{6}.\n$$\n使用 $\\frac{d}{dr} = \\frac{1}{a}\\frac{d}{d\\rho}$ 和 $r = a\\rho$，我们有\n$$\nj_{\\mathrm{tot}}(r) = \\frac{B_{0}}{\\mu_{0} R_{0}\\, a\\rho}\\cdot a\\,\\frac{d}{d\\rho}\\!\\left(\\frac{\\rho^{2}}{q_{\\mathrm{tgt}}(\\rho)}\\right) = \\frac{B_{0}}{\\mu_{0} R_{0}}\\,\\frac{2 q_{\\mathrm{tgt}}(\\rho) - \\rho\\,\\frac{dq_{\\mathrm{tgt}}}{d\\rho}}{q_{\\mathrm{tgt}}(\\rho)^{2}},\n$$\n其中\n$$\n\\frac{dq_{\\mathrm{tgt}}}{d\\rho} = 2A_{2}\\rho - 4A_{4}\\rho^{3} + 6A_{6}\\rho^{5}.\n$$\n一个显著的简化发生了：\n$$\n2 q_{\\mathrm{tgt}}(\\rho) - \\rho\\,\\frac{dq_{\\mathrm{tgt}}}{d\\rho} = 2q_{0} + 2A_{4}\\rho^{4} - 4A_{6}\\rho^{6}.\n$$\n因此，\n$$\nj_{\\mathrm{tot}}(r) = \\frac{B_{0}}{\\mu_{0} R_{0}}\\,\\frac{2q_{0} + 2A_{4}\\rho^{4} - 4A_{6}\\rho^{6}}{\\left(q_{0} + A_{2}\\rho^{2} - A_{4}\\rho^{4} + A_{6}\\rho^{6}\\right)^{2}},\n$$\n辅助剖面则为\n$$\nj_{\\mathrm{cd}}(r) = \\frac{B_{0}}{\\mu_{0} R_{0}}\\,\\frac{2q_{0} + 2A_{4}\\left(\\frac{r}{a}\\right)^{4} - 4A_{6}\\left(\\frac{r}{a}\\right)^{6}}{\\left(q_{0} + A_{2}\\left(\\frac{r}{a}\\right)^{2} - A_{4}\\left(\\frac{r}{a}\\right)^{4} + A_{6}\\left(\\frac{r}{a}\\right)^{6}\\right)^{2}} - j_{0}\\left(1 - \\left(\\frac{r}{a}\\right)^{2}\\right).\n$$\n\n如果$B_{0}$的单位是$\\mathrm{T}$，$R_{0}$和$a$的单位是$\\mathrm{m}$，$\\mu_{0}$的单位是$\\mathrm{N\\,A^{-2}}$，以及$j_{0}$和$j_{\\mathrm{cd}}$的单位是$\\mathrm{A\\,m^{-2}}$，则该表达式是以国际单位制（SI）基本单位表示的。它明确地展示了辅助电流驱动如何通过$j_{\\mathrm{tot}}$来改变$dq/dr$，并给出了实现预设的反剪切$q$剖面所需的闭合形式驱动电流密度。",
            "answer": "$$\\boxed{\\frac{B_{0}}{\\mu_{0} R_{0}}\\,\\frac{2q_{0} + 2A_{4}\\left(\\frac{r}{a}\\right)^{4} - 4A_{6}\\left(\\frac{r}{a}\\right)^{6}}{\\left(q_{0} + A_{2}\\left(\\frac{r}{a}\\right)^{2} - A_{4}\\left(\\frac{r}{a}\\right)^{4} + A_{6}\\left(\\frac{r}{a}\\right)^{6}\\right)^{2}} - j_{0}\\left(1 - \\left(\\frac{r}{a}\\right)^{2}\\right)}$$"
        },
        {
            "introduction": "尽管解析模型富有洞察力，但真实的聚变等离子体物理研究在很大程度上依赖于数值计算。本练习将理论与实践联系起来，指导你构建一个通过追踪磁力线来计算安全因子 $q$ 的数值方案。通过实现这一定义并将其结果与解析解进行比较，你将对聚变研究核心的计算方法及其数值误差来源有更深刻的理解。",
            "id": "3717228",
            "problem": "给定一个轴对称环形平衡，其在柱坐标 $(R,\\phi,Z)$ 下具有圆形同心磁通面。大半径为 $R_0$，一个磁通面由小半径 $r$ 和角向角 $\\theta$ 参数化，通过 $R(\\theta) = R_0 + r \\cos\\theta$ 和 $Z(\\theta) = r \\sin\\theta$ 定义。磁场 $\\mathbf{B}$ 具有环向和角向分量，它们依赖于 $R$，关系式为 $B_\\phi(R) = B_0 \\, R_0/R$ 和 $B_\\theta(R) = B_{p0} \\, R_0/R$，其中 $B_0$ 和 $B_{p0}$ 是正常数。全文中，角度必须以弧度为单位。\n\n旋转变换 $\\iota(\\psi)$ 和安全因子 $q(\\psi)$ 的关系为 $q(\\psi) = 1/\\iota(\\psi)$。磁通面上的安全因子可以通过沿磁力线追踪来定义，即每经过一个角向周期，环向角的平均前进量，\n$$\nq(\\psi) = \\frac{1}{2\\pi} \\int_0^{2\\pi} \\frac{d\\phi}{d\\theta} \\, d\\theta,\n$$\n其中磁力线在磁通面上遵循 $d\\phi/d\\theta = (\\mathbf{B}\\cdot\\nabla\\phi)/(\\mathbf{B}\\cdot\\nabla\\theta)$。假设存在以下瞬时映射，其中包含一个小的周期性脉动，以模拟度规非均匀性或弱非轴对称效应：\n$$\n\\frac{d\\phi}{d\\theta} = \\left(\\frac{\\mathbf{B}\\cdot\\nabla\\phi}{\\mathbf{B}\\cdot\\nabla\\theta}\\right) + \\varepsilon \\sin(n \\theta),\n$$\n其中 $\\varepsilon$ 是一个小的无量纲振幅，$n$ 是一个正整数。磁剪切定义为\n$$\ns(r) = \\frac{r}{q(r)} \\frac{dq}{dr}.\n$$\n\n从磁力线的基本定义 ($d\\mathbf{x}/ds \\parallel \\mathbf{B}$) 和柱坐标系中的坐标梯度出发，构建一个数值方案，该方案能够：\n- 通过在有限的角向角长度上对 $d\\phi/d\\theta$ 进行积分，并使用 $\\theta$ 的均匀离散化，计算给定磁通面上 $q(r)$ 的数值估计值，\n- 计算旋转变换 $\\iota(r) = 1/q(r)$，\n- 估计由有限积分长度（在积分范围中使用 $2\\pi$ 的非整数倍）和离散化（通过比较两种步长）引入的误差，\n- 通过 $r$ 的中心有限差分计算磁剪切 $s(r)$，并将其与该平衡的解析剪切（您应在解答中推导出来）进行比较，\n- 汇总一组测试用例的数值输出。\n\n您的数值积分必须在所选长度 $L_\\theta = 2\\pi N_{\\mathrm{turns}}$ 上使用角向角 $\\theta$ 的均匀划分，划分为 $N_{\\mathrm{steps}}$ 个子区间。使用中点法则来近似积分，\n$$\n\\int_0^{L_\\theta} f(\\theta)\\,d\\theta \\approx \\sum_{k=0}^{N_{\\mathrm{steps}}-1} f\\!\\left(\\theta_k + \\frac{\\Delta\\theta}{2}\\right)\\Delta\\theta,\\quad \\Delta\\theta = \\frac{L_\\theta}{N_{\\mathrm{steps}}},\n$$\n其中 $f(\\theta) = d\\phi/d\\theta$。瞬时比率必须根据给定的 $\\mathbf{B}$ 和指定磁通面上的坐标梯度来计算。脉动项 $\\varepsilon \\sin(n \\theta)$ 直接加到 $d\\phi/d\\theta$上。\n\n定义以下误差估计：\n- 在整数 $N_{\\mathrm{turns}}$ 时的离散化误差：$e_{\\mathrm{disc}} = | q_{\\mathrm{fine}} - q_{\\mathrm{coarse}} |$，其中 $q_{\\mathrm{fine}}$ 和 $q_{\\mathrm{coarse}}$ 使用相同的 $N_{\\mathrm{turns}}$ 但不同的 $N_{\\mathrm{steps}}$ 计算。\n- 在精细分辨率下的有限长度误差：$e_{\\mathrm{len}} = | q_{\\mathrm{int}} - q_{\\mathrm{nonint}} |$，其中 $q_{\\mathrm{int}}$ 使用整数 $N_{\\mathrm{turns}}$，$q_{\\mathrm{nonint}}$ 使用非整数 $N_{\\mathrm{turns}}$。\n\n使用小的扰动 $\\delta r$，通过中心差分数值计算磁剪切：\n$$\ns_{\\mathrm{num}}(r) = \\frac{r}{q(r)} \\cdot \\frac{q(r+\\delta r) - q(r-\\delta r)}{2\\delta r}.\n$$\n同时，计算指定平衡的解析剪切 $s_{\\mathrm{an}}(r)$，并报告绝对剪切误差 $|s_{\\mathrm{num}}(r) - s_{\\mathrm{an}}(r)|$。\n\n设计您的程序以评估以下三个测试用例。对于所有情况，使用 $B_0 = 5.0$，$B_{p0} = 1.0$，$R_0 = 3.0$。所有角度均使用弧度。使用 $\\delta r = 0.01$。\n\n- 情况 A (理想路径): $r = 0.5$, $\\varepsilon = 0.02$, $n = 3$, $N_{\\mathrm{steps,coarse}} = 256$, $N_{\\mathrm{steps,fine}} = 4096$, $N_{\\mathrm{turns,int}} = 1.0$, $N_{\\mathrm{turns,nonint}} = 1.5$。\n- 情况 B (近轴边界): $r = 0.05$, $\\varepsilon = 0.02$, $n = 3$, $N_{\\mathrm{steps,coarse}} = 256$, $N_{\\mathrm{steps,fine}} = 4096$, $N_{\\mathrm{turns,int}} = 1.0$, $N_{\\mathrm{turns,nonint}} = 1.5$。\n- 情况 C (强角向变化边缘情况): $r = 2.5$, $\\varepsilon = 0.05$, $n = 5$, $N_{\\mathrm{steps,coarse}} = 256$, $N_{\\mathrm{steps,fine}} = 8192$, $N_{\\mathrm{turns,int}} = 1.0$, $N_{\\mathrm{turns,nonint}} = 1.5$。\n\n对于每种情况，您的程序必须生成一个包含六个浮点数的列表：\n1. $q_{\\mathrm{int,fine}}$,\n2. $\\iota_{\\mathrm{int,fine}}$,\n3. $e_{\\mathrm{len}}$,\n4. $e_{\\mathrm{disc}}$,\n5. $s_{\\mathrm{num}}$,\n6. $\\left| s_{\\mathrm{num}} - s_{\\mathrm{an}} \\right|$.\n\n最终输出格式：您的程序应生成单行输出，其中包含一个逗号分隔的列表，该列表包含三个测试用例的结果，每个用例的结果本身也是一个用方括号括起来的逗号分隔列表。例如，一个有效的输出格式是\n$$\n[\\,[q_1,\\iota_1,e_{\\mathrm{len},1},e_{\\mathrm{disc},1},s_{\\mathrm{num},1},e_{s,1}],[q_2,\\iota_2,e_{\\mathrm{len},2},e_{\\mathrm{disc},2},s_{\\mathrm{num},2},e_{s,2}],[q_3,\\iota_3,e_{\\mathrm{len},3},e_{\\mathrm{disc},3},s_{\\mathrm{num},3},e_{s,3}]]\n$$\n不应打印任何额外文本。所有量都是无量纲数，角度必须以弧度为单位。",
            "solution": "经评估，该问题是有效的，因为它科学上基于托卡马克物理学的标准简化模型，问题阐述清晰且提供了所有必要信息，并且表述客观。该问题不符合任何指定的无效标准。因此，我们可以着手解决。\n\n该解决方案需要结合解析推导和数值实现。首先，我们推导理想平衡下安全因子 $q(r)$ 和磁剪切 $s(r)$ 的必要解析表达式。其次，我们根据问题陈述详细说明计算 $q(r)$、$\\iota(r)$、$s(r)$ 及相关误差度量的数值方案。\n\n### 1. 磁力线方程的推导\n\n安全因子 $q$ 是通过对量 $d\\phi/d\\theta$ 的积分来定义的，该量描述了当沿着一条磁力线移动时，环向角 $\\phi$ 相对于角向角 $\\theta$ 的变化率。问题给出了关系式：\n$$\n\\frac{d\\phi}{d\\theta} = \\frac{\\mathbf{B}\\cdot\\nabla\\phi}{\\mathbf{B}\\cdot\\nabla\\theta}\n$$\n我们必须使用给定的柱坐标 $(R, \\phi, Z)$ 和由 $R = R_0 + r \\cos\\theta$ 及 $Z = r \\sin\\theta$ 定义的环形坐标系 $(r, \\theta, \\phi)$ 来计算此表达式中的各项。\n\n磁场 $\\mathbf{B}$ 由其环向和角向分量给出。环向分量是 $B_\\phi \\hat{\\phi}$。角向分量 $\\mathbf{B}_p$ 位于 $(R,Z)$ 平面内，并与圆形磁通面（$r$ 为常数）相切。角向单位矢量 $\\hat{\\mathbf{e}}_\\theta$ 是通过对切向量 $\\partial\\mathbf{x}/\\partial\\theta = (-r\\sin\\theta)\\hat{\\mathbf{R}} + (r\\cos\\theta)\\hat{\\mathbf{Z}}$ 进行归一化得到的，即 $\\hat{\\mathbf{e}}_\\theta = -\\sin\\theta \\hat{\\mathbf{R}} + \\cos\\theta \\hat{\\mathbf{Z}}$。角向磁场的大小由 $B_\\theta(R) = B_{p0} R_0/R$ 给出。因此，磁场矢量为：\n$$\n\\mathbf{B} = B_\\theta(R) \\hat{\\mathbf{e}}_\\theta + B_\\phi(R) \\hat{\\phi} = B_\\theta(R)(-\\sin\\theta \\hat{\\mathbf{R}} + \\cos\\theta \\hat{\\mathbf{Z}}) + B_\\phi(R) \\hat{\\phi}\n$$\n\n角坐标 $\\phi$ 和 $\\theta$ 在柱坐标系中的梯度是：\n$$\n\\nabla\\phi = \\frac{1}{R}\\hat{\\phi}\n$$\n为了找到 $\\nabla\\theta$，我们使用关系式 $\\theta = \\arctan(Z / (R-R_0))$：\n$$\n\\nabla\\theta = \\frac{\\partial\\theta}{\\partial R}\\hat{\\mathbf{R}} + \\frac{1}{R}\\frac{\\partial\\theta}{\\partial\\phi}\\hat{\\phi} + \\frac{\\partial\\theta}{\\partial Z}\\hat{\\mathbf{Z}} = -\\frac{Z}{(R-R_0)^2+Z^2}\\hat{\\mathbf{R}} + 0 \\cdot \\hat{\\phi} + \\frac{R-R_0}{(R-R_0)^2+Z^2}\\hat{\\mathbf{Z}}\n$$\n注意到 $r^2 = (R-R_0)^2+Z^2$，$Z=r\\sin\\theta$ 和 $R-R_0=r\\cos\\theta$：\n$$\n\\nabla\\theta = -\\frac{r\\sin\\theta}{r^2}\\hat{\\mathbf{R}} + \\frac{r\\cos\\theta}{r^2}\\hat{\\mathbf{Z}} = \\frac{1}{r}(-\\sin\\theta \\hat{\\mathbf{R}} + \\cos\\theta \\hat{\\mathbf{Z}}) = \\frac{1}{r}\\hat{\\mathbf{e}}_\\theta\n$$\n\n现在我们计算点积：\n$$\n\\mathbf{B}\\cdot\\nabla\\phi = (B_\\phi(R)\\hat{\\phi}) \\cdot (\\frac{1}{R}\\hat{\\phi}) = \\frac{B_\\phi(R)}{R}\n$$\n$$\n\\mathbf{B}\\cdot\\nabla\\theta = (B_\\theta(R)\\hat{\\mathbf{e}}_\\theta + B_\\phi(R)\\hat{\\phi}) \\cdot (\\frac{1}{r}\\hat{\\mathbf{e}}_\\theta) = \\frac{B_\\theta(R)}{r}\n$$\n比率变为：\n$$\n\\frac{\\mathbf{B}\\cdot\\nabla\\phi}{\\mathbf{B}\\cdot\\nabla\\theta} = \\frac{B_\\phi(R)/R}{B_\\theta(R)/r} = \\frac{r B_\\phi(R)}{R B_\\theta(R)}\n$$\n代入给定的场依赖关系，$B_\\phi(R) = B_0 R_0/R$ 和 $B_\\theta(R) = B_{p0} R_0/R$：\n$$\n\\frac{\\mathbf{B}\\cdot\\nabla\\phi}{\\mathbf{B}\\cdot\\nabla\\theta} = \\frac{r (B_0 R_0/R)}{R (B_{p0} R_0/R)} = \\frac{r B_0}{R B_{p0}}\n$$\n考虑到 $R = R_0 + r \\cos\\theta$，包含脉动项的完整磁力线映射的最终表达式为：\n$$\n\\frac{d\\phi}{d\\theta} = \\frac{r B_0}{B_{p0}(R_0 + r \\cos\\theta)} + \\varepsilon \\sin(n \\theta)\n$$\n这个关于 $\\theta$ 的函数是安全因子计算的被积函数。\n\n### 2. 解析安全因子和磁剪切（理想情况）\n\n为了进行比较，我们推导理想平衡（即 $\\varepsilon=0$）下的解析安全因子 $q_{\\mathrm{an}}(r)$ 和磁剪切 $s_{\\mathrm{an}}(r)$。\n安全因子定义为：\n$$\nq(r) = \\frac{1}{2\\pi} \\int_0^{2\\pi} \\left(\\frac{d\\phi}{d\\theta}\\right)_{\\mathrm{ideal}} d\\theta = \\frac{1}{2\\pi} \\int_0^{2\\pi} \\frac{r B_0}{B_{p0}(R_0 + r \\cos\\theta)} d\\theta\n$$\n$$\nq_{\\mathrm{an}}(r) = \\frac{r B_0}{2\\pi B_{p0}} \\int_0^{2\\pi} \\frac{d\\theta}{R_0 + r \\cos\\theta}\n$$\n这是一个标准的定积分，对于 $R_0  r$，其值为 $\\frac{2\\pi}{\\sqrt{R_0^2 - r^2}}$。\n$$\nq_{\\mathrm{an}}(r) = \\frac{r B_0}{2\\pi B_{p0}} \\cdot \\frac{2\\pi}{\\sqrt{R_0^2 - r^2}} = \\frac{r B_0}{B_{p0}\\sqrt{R_0^2 - r^2}}\n$$\n磁剪切定义为 $s(r) = \\frac{r}{q(r)} \\frac{dq}{dr}$。我们首先计算 $\\frac{dq}{dr}$：\n$$\n\\frac{dq_{\\mathrm{an}}}{dr} = \\frac{B_0}{B_{p0}} \\frac{d}{dr} \\left( \\frac{r}{\\sqrt{R_0^2 - r^2}} \\right) = \\frac{B_0}{B_{p0}} \\left[ \\frac{1}{\\sqrt{R_0^2 - r^2}} - \\frac{r(-\\frac{1}{2})(R_0^2-r^2)^{-3/2}(-2r)}{R_0^2-r^2} \\right]\n$$\n$$\n\\frac{dq_{\\mathrm{an}}}{dr} = \\frac{B_0}{B_{p0}} \\left[ \\frac{R_0^2 - r^2 + r^2}{(R_0^2 - r^2)^{3/2}} \\right] = \\frac{B_0}{B_{p0}} \\frac{R_0^2}{(R_0^2 - r^2)^{3/2}}\n$$\n现在，构建剪切 $s_{\\mathrm{an}}(r)$：\n$$\ns_{\\mathrm{an}}(r) = \\frac{r}{q_{\\mathrm{an}}(r)} \\frac{dq_{\\mathrm{an}}}{dr} = \\frac{r}{\\frac{r B_0}{B_{p0}\\sqrt{R_0^2 - r^2}}} \\left( \\frac{B_0}{B_{p0}} \\frac{R_0^2}{(R_0^2 - r^2)^{3/2}} \\right)\n$$\n$$\ns_{\\mathrm{an}}(r) = \\frac{B_{p0}\\sqrt{R_0^2 - r^2}}{B_0} \\cdot \\frac{B_0 R_0^2}{B_{p0}(R_0^2 - r^2)^{3/2}} = \\frac{R_0^2}{R_0^2 - r^2}\n$$\n这个关于 $s_{\\mathrm{an}}(r)$ 的简单表达式为我们的数值计算提供了基准。\n\n### 3. 数值方案\n\n问题指定使用中点法则进行数值积分。安全因子 $q$ 是每个角向周期的平均环向前进量。对于在总角向角 $L_\\theta = 2\\pi N_{\\mathrm{turns}}$ 上的积分，$d\\phi/d\\theta$ 的平均值即为 $q$。\n$$\nq \\approx \\frac{1}{L_\\theta} \\int_0^{L_\\theta} \\frac{d\\phi}{d\\theta} d\\theta \\approx \\frac{1}{L_\\theta} \\sum_{k=0}^{N_{\\mathrm{steps}}-1} f(\\theta_k^{\\mathrm{mid}}) \\Delta\\theta\n$$\n其中 $f(\\theta) = d\\phi/d\\theta$，$\\Delta\\theta = L_\\theta / N_{\\mathrm{steps}}$，以及 $\\theta_k^{\\mathrm{mid}} = (k+0.5)\\Delta\\theta$。这可以简化为中点处函数值的均值：\n$$\nq \\approx \\frac{1}{N_{\\mathrm{steps}}} \\sum_{k=0}^{N_{\\mathrm{steps}}-1} f(\\theta_k^{\\mathrm{mid}})\n$$\n一个函数 `compute_q(r, params)` 将实现此计算。\n\n对于每个测试用例，所需的输出按如下方式计算：\n1.  $q_{\\mathrm{int,fine}}$: 使用精细步数 $N_{\\mathrm{steps,fine}}$ 和整数圈数 $N_{\\mathrm{turns,int}}$，通过 `compute_q` 计算。\n2.  $\\iota_{\\mathrm{int,fine}}$: 旋转变换，即 $1/q_{\\mathrm{int,fine}}$。\n3.  $e_{\\mathrm{len}}$: 有限长度误差为 $|q_{\\mathrm{int,fine}} - q_{\\mathrm{nonint,fine}}|$。$q_{\\mathrm{nonint,fine}}$ 是在精细分辨率下使用非整数圈数 $N_{\\mathrm{turns,nonint}}$ 计算的。此误差主要源于脉动项 $\\varepsilon\\sin(n\\theta)$ 在非整数个 $2\\pi$ 区间上的平均值不为零。\n4.  $e_{\\mathrm{disc}}$: 离散化误差为 $|q_{\\mathrm{int,fine}} - q_{\\mathrm{int,coarse}}|$。$q_{\\mathrm{int,coarse}}$ 是使用粗略步数 $N_{\\mathrm{steps,coarse}}$ 和整数圈数计算的。此误差反映了中点法则积分器的准确性。\n5.  $s_{\\mathrm{num}}$: 数值剪切使用中心有限差分计算。这需要计算 $r+\\delta r$ 和 $r-\\delta r$ 处的 $q$。为最大化精度，这些 $q$ 值使用高保真度参数（$N_{\\mathrm{steps,fine}}$，$N_{\\mathrm{turns,int}}$）计算。脉动项 $\\varepsilon \\sin(n\\theta)$ 在整数圈数上的平均值几乎为零，因此计算出的 $q$ 值主要由理想平衡结构决定。\n    $$\n    s_{\\mathrm{num}}(r) = \\frac{r}{q_{\\mathrm{int,fine}}(r)} \\frac{q_{\\mathrm{int,fine}}(r+\\delta r) - q_{\\mathrm{int,fine}}(r-\\delta r)}{2\\delta r}\n    $$\n6.  $|s_{\\mathrm{num}} - s_{\\mathrm{an}}|$: 数值计算的剪切与解析推导的剪切 $s_{\\mathrm{an}}(r) = R_0^2 / (R_0^2 - r^2)$ 之间的绝对差。这用于衡量数值微分和底层 $q$ 计算的准确性。请注意，虽然 $s_{\\mathrm{an}}$ 是在 $\\varepsilon=0$ 的条件下推导的，但 $s_{\\mathrm{num}}$ 的计算包含了脉动项。然而，由于用于有限差分的 $q$ 值使用整数圈数，脉动的影响极小，使得该比较有意义。\n\n该实现将包含一个主函数，它会遍历所有测试用例，使用适当的参数调用一个辅助函数来计算 $q$，然后计算并存储每种情况所需的六个量。最终输出将格式化为列表的列表。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for all test cases.\n    \"\"\"\n    \n    # Global constants for all test cases\n    B0 = 5.0\n    Bp0 = 1.0\n    R0 = 3.0\n    delta_r = 0.01\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case A: happy path\n        {'r': 0.5, 'eps': 0.02, 'n': 3, 'N_steps_coarse': 256, 'N_steps_fine': 4096, 'N_turns_int': 1.0, 'N_turns_nonint': 1.5},\n        # Case B: near-axis boundary\n        {'r': 0.05, 'eps': 0.02, 'n': 3, 'N_steps_coarse': 256, 'N_steps_fine': 4096, 'N_turns_int': 1.0, 'N_turns_nonint': 1.5},\n        # Case C: strong poloidal variation edge case\n        {'r': 2.5, 'eps': 0.05, 'n': 5, 'N_steps_coarse': 256, 'N_steps_fine': 8192, 'N_turns_int': 1.0, 'N_turns_nonint': 1.5},\n    ]\n\n    all_results = []\n    \n    for case in test_cases:\n        r = case['r']\n        eps = case['eps']\n        n = case['n']\n        N_steps_coarse = case['N_steps_coarse']\n        N_steps_fine = case['N_steps_fine']\n        N_turns_int = case['N_turns_int']\n        N_turns_nonint = case['N_turns_nonint']\n\n        # 1. Compute q_int_fine and iota_int_fine\n        q_int_fine = compute_q(r, B0, Bp0, R0, eps, n, N_turns_int, N_steps_fine)\n        iota_int_fine = 1.0 / q_int_fine\n\n        # 2. Compute finite-length error e_len\n        q_nonint_fine = compute_q(r, B0, Bp0, R0, eps, n, N_turns_nonint, N_steps_fine)\n        e_len = abs(q_int_fine - q_nonint_fine)\n\n        # 3. Compute discretization error e_disc\n        q_int_coarse = compute_q(r, B0, Bp0, R0, eps, n, N_turns_int, N_steps_coarse)\n        e_disc = abs(q_int_fine - q_int_coarse)\n\n        # 4. Compute numerical shear s_num\n        q_plus = compute_q(r + delta_r, B0, Bp0, R0, eps, n, N_turns_int, N_steps_fine)\n        q_minus = compute_q(r - delta_r, B0, Bp0, R0, eps, n, N_turns_int, N_steps_fine)\n        dq_dr_num = (q_plus - q_minus) / (2.0 * delta_r)\n        s_num = (r / q_int_fine) * dq_dr_num\n        \n        # 5. Compute analytic shear s_an and shear error\n        s_an = R0**2 / (R0**2 - r**2)\n        shear_error = abs(s_num - s_an)\n        \n        # 6. Aggregate results for the current case\n        case_results = [\n            q_int_fine,\n            iota_int_fine,\n            e_len,\n            e_disc,\n            s_num,\n            shear_error,\n        ]\n        all_results.append(case_results)\n\n    # Format the final output as a string.\n    # e.g. [[1.0,2.0],[3.0,4.0]]\n    result_str = \",\".join([f\"[{','.join(map(str, res))}]\" for res in all_results])\n    print(f\"[{result_str}]\")\n\ndef compute_q(r, B0, Bp0, R0, eps, n, N_turns, N_steps):\n    \"\"\"\n    Computes the safety factor q using the midpoint rule for integration.\n\n    Args:\n        r (float): Minor radius of the flux surface.\n        B0 (float): Magnetic field constant (toroidal).\n        Bp0 (float): Magnetic field constant (poloidal).\n        R0 (float): Major radius.\n        eps (float): Ripple amplitude.\n        n (int): Ripple mode number.\n        N_turns (float): Number of poloidal turns for integration.\n        N_steps (int): Number of steps for numerical integration.\n\n    Returns:\n        float: The numerically calculated safety factor q.\n    \"\"\"\n    if r = 0 or r >= R0:\n        # Handle cases outside the valid domain to prevent division by zero or other errors\n        # Note: r=0 is a singularity for some definitions, and r>=R0 is unphysical\n        # This problem's cases are well-behaved.\n        return float('nan')\n        \n    L_theta = 2.0 * np.pi * N_turns\n    delta_theta = L_theta / N_steps\n\n    # Midpoint theta values for integration\n    theta_midpoints = (np.arange(N_steps) + 0.5) * delta_theta\n\n    # Calculate the integrand d(phi)/d(theta) at each midpoint\n    R_vals = R0 + r * np.cos(theta_midpoints)\n    \n    # Ideal part of d(phi)/d(theta)\n    dphi_dtheta_ideal = (r * B0) / (Bp0 * R_vals)\n    \n    # Ripple part\n    dphi_dtheta_ripple = eps * np.sin(n * theta_midpoints)\n    \n    # Total integrand\n    integrand_values = dphi_dtheta_ideal + dphi_dtheta_ripple\n\n    # q is the average value of the integrand over the integration interval\n    q_val = np.mean(integrand_values)\n    \n    return q_val\n\n# Execute the main function\nsolve()\n```"
        }
    ]
}