{
    "hands_on_practices": [
        {
            "introduction": "This first exercise provides a direct, hands-on approach to quantifying the degree of quasi-symmetry in a stellarator. You will work with a synthetic magnetic field to compute its Fourier spectrum in Boozer coordinates and evaluate a key metric that measures the dominance of the desired helical symmetry . This practice builds a foundational skill for analyzing and comparing different magnetic confinement configurations.",
            "id": "3719824",
            "problem": "You are given the task of computing the two-dimensional Fourier spectrum of the magnetic field strength in Boozer coordinates to assess quasi-symmetry (QS) on a selected flux surface. Begin from the magnetic field representation in straight-fieldline coordinates and the definition of Boozer coordinates on a flux surface. Assume the following fundamental relations as the base of your derivation: (i) the magnetic field in straight-fieldline angles has the contravariant representation $\\mathbf{B} = \\nabla \\psi \\times \\nabla \\theta + \\iota(\\psi)\\,\\nabla \\phi \\times \\nabla \\psi$, (ii) in Boozer coordinates the covariant components of $\\mathbf{B}$ are flux functions so that the Boozer Jacobian $J_{\\mathrm{B}}$ satisfies $J_{\\mathrm{B}}(\\psi,\\theta,\\phi) = \\left(G(\\psi)+\\iota(\\psi) I(\\psi)\\right)/B^{2}(\\psi,\\theta,\\phi)$, and (iii) the magnetic field strength on a given surface can be expanded as a double Fourier series in Boozer angles, $B(\\theta,\\phi) = \\sum_{m=-m_{\\max}}^{m_{\\max}} \\sum_{n=-n_{\\max}}^{n_{\\max}} B_{m,n}\\,\\mathrm{e}^{\\mathrm{i}(m\\theta - n\\phi)}$. Quasi-symmetry with integers $M$ and $N$ is characterized by the dominance of modes satisfying the selection rule $mM - nN = 0$, which corresponds to $B(\\theta,\\phi)$ depending primarily on a helical angle combination.\n\nYour program must:\n1. Construct synthetic Boozer-coordinate fields $B(\\theta,\\phi)$ on a specified uniform angle grid using superpositions of a dominant helical mode and several subdominant off-resonant modes. Work in radians for all angles.\n2. Compute the discrete Fourier coefficients $B_{m,n}$ using the standard unweighted double-angle average:\n$$\nB_{m,n} \\approx \\frac{1}{N_{\\theta} N_{\\phi}} \\sum_{j=0}^{N_{\\theta}-1}\\sum_{k=0}^{N_{\\phi}-1} B(\\theta_{j},\\phi_{k})\\,\\mathrm{e}^{-\\mathrm{i}(m\\theta_{j} - n\\phi_{k})},\n$$\nwhere $\\theta_{j} = 2\\pi j/N_{\\theta}$ and $\\phi_{k} = 2\\pi k/N_{\\phi}$. This approximation is exact for the synthetic cosine content defined below on a uniform grid.\n3. Quantify quasi-symmetry by the ratio\n$$\n\\mathcal{R} = \\frac{\\sum_{(m,n)\\in \\mathcal{S}} \\lvert B_{m,n}\\rvert^{2}}{\\sum_{(m,n)\\neq (0,0)} \\lvert B_{m,n}\\rvert^{2}},\n$$\nwhere $\\mathcal{S} = \\{(m,n) \\in \\mathbb{Z}^{2} : mM - nN = 0, (m,n)\\neq(0,0)\\}$. Exclude the mean mode $(0,0)$ from both numerator and denominator. If the denominator vanishes (uniform field), define $\\mathcal{R} = 1$.\n4. Compare $\\mathcal{R}$ to a case-specific threshold $\\tau$ and return a boolean indicating whether $\\mathcal{R} \\ge \\tau$.\n\nYou are provided with a test suite of four cases. In each case, treat $I(\\psi)$ and $G(\\psi)$ as given flux functions (constants on the surface); they are included for completeness from the Variational Moments Equilibrium Code (VMEC) outputs but are not needed to compute the Fourier series from a uniform Boozer grid. All angles must be in radians, and the base magnetic field strength $B_{0}$ must be interpreted in tesla; however, the final outputs are dimensionless booleans and require no units. For each case, synthesize\n$$\nB(\\theta,\\phi) = B_{0}\\left[1 + \\varepsilon \\cos(m_{0}\\theta - n_{0}\\phi)\\right] + \\sum_{\\ell=1}^{L} a_{\\ell}\\cos(m_{\\ell}\\theta - n_{\\ell}\\phi + \\varphi_{\\ell}),\n$$\nwith specified amplitudes and phases $\\varphi_{\\ell}$.\n\nTest suite (each case is a tuple of parameters):\n- Case $1$ (happy path, strong quasi-symmetry):\n    - Grid: $N_{\\theta} = 64$, $N_{\\phi} = 64$.\n    - VMEC-like flux functions: $I(\\psi) = 2.0$, $G(\\psi) = 3.0$.\n    - Symmetry integers: $M=1$, $N=1$.\n    - Base field: $B_{0} = 3.0$ tesla.\n    - Dominant mode: $(m_{0},n_{0}) = (1,1)$ with $\\varepsilon = 0.2$.\n    - Off-resonant modes: $[(2,1,0.02,0.0), (1,0,0.015,0.3), (3,2,0.01,1.0)]$, interpreted as $(m_{\\ell},n_{\\ell},a_{\\ell},\\varphi_{\\ell})$.\n    - Spectral bounds: $m_{\\max}=4$, $n_{\\max}=4$.\n    - Threshold: $\\tau = 0.9$.\n- Case $2$ (near boundary, moderate quasi-symmetry):\n    - Grid: $N_{\\theta} = 64$, $N_{\\phi} = 64$.\n    - VMEC-like flux functions: $I(\\psi) = 1.0$, $G(\\psi) = 2.5$.\n    - Symmetry integers: $M=2$, $N=1$.\n    - Base field: $B_{0} = 2.5$ tesla.\n    - Dominant mode: $(m_{0},n_{0}) = (1,2)$ with $\\varepsilon = 0.05$.\n    - Off-resonant modes: $[(1,0,0.04,0.2), (0,1,0.03,0.5), (3,1,0.03,0.7)]$.\n    - Spectral bounds: $m_{\\max}=4$, $n_{\\max}=4$.\n    - Threshold: $\\tau = 0.6$.\n- Case $3$ (non-quasi-symmetric, failure expected):\n    - Grid: $N_{\\theta} = 64$, $N_{\\phi} = 64$.\n    - VMEC-like flux functions: $I(\\psi) = 0.5$, $G(\\psi) = 3.5$.\n    - Symmetry integers: $M=3$, $N=1$.\n    - Base field: $B_{0} = 2.8$ tesla.\n    - Dominant mode: none (set $\\varepsilon = 0$).\n    - Off-resonant modes: $[(1,0,0.06,0.1), (2,3,0.05,0.4), (3,0,0.04,1.1)]$.\n    - Spectral bounds: $m_{\\max}=5$, $n_{\\max}=5$.\n    - Threshold: $\\tau = 0.5$.\n- Case $4$ (edge case, uniform field):\n    - Grid: $N_{\\theta} = 64$, $N_{\\phi} = 64$.\n    - VMEC-like flux functions: $I(\\psi) = 1.0$, $G(\\psi) = 1.0$.\n    - Symmetry integers: $M=1$, $N=1$.\n    - Base field: $B_{0} = 3.2$ tesla.\n    - Dominant mode: none (set $\\varepsilon = 0$).\n    - Off-resonant modes: empty list.\n    - Spectral bounds: $m_{\\max}=3$, $n_{\\max}=3$.\n    - Threshold: $\\tau = 0.99$.\n\nYour program must:\n- Implement the synthesis of $B(\\theta,\\phi)$ for each case, compute the discrete spectrum $B_{m,n}$ over the prescribed spectral bounds, compute $\\mathcal{R}$, compare to $\\tau$, and output a single line containing a list with four boolean values $[\\text{case1},\\text{case2},\\text{case3},\\text{case4}]$ indicating whether each case satisfies quasi-symmetry under the stated criterion.\n- The final output must be exactly one line, with the list printed in Python boolean literal form enclosed in square brackets.",
            "solution": "The problem is valid as it is scientifically grounded in the principles of plasma physics and stellarator theory, is well-posed with a clear objective and all necessary data, and is expressed in objective, formal language. We can therefore proceed with a solution.\n\nThe objective is to assess the degree of quasi-symmetry (QS) for a synthetically generated magnetic field strength $B$ on a flux surface. Quasi-symmetry is a property of the magnetic field configuration in a stellarator where the magnetic field strength, when expressed in Boozer coordinates $(\\theta, \\phi)$, is a function of a single helical angle, $B = B(m\\theta - n\\phi)$. This implies that the Fourier spectrum of $B$ is dominated by modes $(m, n)$ that satisfy a specific linear relationship, $mM - nN = 0$, for some integers $M$ and $N$.\n\nThe problem provides a synthetic model for the magnetic field strength on a given flux surface:\n$$\nB(\\theta,\\phi) = B_{0}\\left[1 + \\varepsilon \\cos(m_{0}\\theta - n_{0}\\phi)\\right] + \\sum_{\\ell=1}^{L} a_{\\ell}\\cos(m_{\\ell}\\theta - n_{\\ell}\\phi + \\varphi_{\\ell})\n$$\nWe are asked to compute the two-dimensional Fourier spectrum $B_{m,n}$ and use it to calculate a quasi-symmetry metric $\\mathcal{R}$. The magnetic field is represented by the Fourier series:\n$$\nB(\\theta,\\phi) = \\sum_{m,n} B_{m,n}\\,\\mathrm{e}^{\\mathrm{i}(m\\theta - n\\phi)}\n$$\nThe problem states that for the given synthetic form of $B(\\theta,\\phi)$, the provided discrete Fourier transform formula yields exact results. This allows us to determine the coefficients $B_{m,n}$ analytically, which is more precise than a numerical implementation of the DFT.\n\nWe use Euler's formula, $\\cos(x) = \\frac{1}{2}(\\mathrm{e}^{\\mathrm{i}x} + \\mathrm{e}^{-\\mathrm{i}x})$, to decompose each cosine term in the expression for $B(\\theta, \\phi)$.\nA general term of the form $\\alpha \\cos(m_k\\theta - n_k\\phi + \\varphi_k)$ can be written as:\n$$\n\\alpha \\cos(m_k\\theta - n_k\\phi + \\varphi_k) = \\frac{\\alpha}{2}\\left( \\mathrm{e}^{\\mathrm{i}(m_k\\theta - n_k\\phi + \\varphi_k)} + \\mathrm{e}^{-\\mathrm{i}(m_k\\theta - n_k\\phi + \\varphi_k)} \\right)\n$$\n$$\n= \\left(\\frac{\\alpha}{2}\\mathrm{e}^{\\mathrm{i}\\varphi_k}\\right)\\mathrm{e}^{\\mathrm{i}(m_k\\theta - n_k\\phi)} + \\left(\\frac{\\alpha}{2}\\mathrm{e}^{-\\mathrm{i}\\varphi_k}\\right)\\mathrm{e}^{\\mathrm{i}(-m_k\\theta - (-n_k)\\phi)}\n$$\nBy comparing this with the Fourier series definition, we can identify the coefficients:\n- The term $\\mathrm{e}^{\\mathrm{i}(m_k\\theta - n_k\\phi)}$ contributes to the coefficient $B_{m_k,n_k}$.\n- The term $\\mathrm{e}^{\\mathrm{i}(-m_k\\theta - (-n_k)\\phi)}$ contributes to the coefficient $B_{-m_k,-n_k}$.\n\nThus, for each cosine component, we have a pair of non-zero Fourier coefficients:\n- $B_{m_k,n_k} = \\frac{\\alpha}{2}\\mathrm{e}^{\\mathrm{i}\\varphi_k}$\n- $B_{-m_k,-n_k} = \\frac{\\alpha}{2}\\mathrm{e}^{-\\mathrm{i}\\varphi_k} = (B_{m_k,n_k})^*$\n\nThe full set of analytical coefficients for the given $B(\\theta,\\phi)$ is:\n1.  The constant term $B_0$ corresponds to the $(m,n)=(0,0)$ mode: $B_{0,0} = B_0$.\n2.  The \"dominant\" mode with amplitude $\\varepsilon B_0$ and phase $\\varphi_0=0$ gives:\n    $B_{m_0,n_0} = \\frac{\\varepsilon B_0}{2}$ and $B_{-m_0,-n_0} = \\frac{\\varepsilon B_0}{2}$.\n3.  Each \"off-resonant\" mode $\\ell$ with amplitude $a_\\ell$ and phase $\\varphi_\\ell$ gives:\n    $B_{m_\\ell,n_\\ell} = \\frac{a_\\ell}{2}\\mathrm{e}^{\\mathrm{i}\\varphi_\\ell}$ and $B_{-m_\\ell,-n_\\ell} = \\frac{a_\\ell}{2}\\mathrm{e}^{-\\mathrm{i}\\varphi_\\ell}$.\n\nWith these coefficients, we compute the quasi-symmetry ratio $\\mathcal{R}$:\n$$\n\\mathcal{R} = \\frac{\\sum_{(m,n)\\in \\mathcal{S}} \\lvert B_{m,n}\\rvert^{2}}{\\sum_{(m,n)\\neq (0,0)} \\lvert B_{m,n}\\rvert^{2}}\n$$\nwhere $\\mathcal{S} = \\{(m,n) \\in \\mathbb{Z}^{2} : mM - nN = 0, (m,n)\\neq(0,0)\\}$. The numerator is the sum of the squared magnitudes of all non-zero, non-DC Fourier coefficients that satisfy the quasi-symmetry condition. The denominator is the sum of the squared magnitudes of all non-DC Fourier coefficients.\nIf the denominator is zero (i.e., the field is uniform, $B=B_0$), $\\mathcal{R}$ is defined to be $1$.\n\nThe algorithm for each test case is as follows:\n1.  Initialize a dictionary to store the complex Fourier coefficients $B_{m,n}$ for non-zero, non-DC modes.\n2.  Analytically compute the coefficients for the dominant and off-resonant modes and populate the dictionary. For a mode $(m, n, \\alpha, \\varphi)$, we add $\\frac{\\alpha}{2}\\mathrm{e}^{\\mathrm{i}\\varphi}$ to the dictionary entry for $(m,n)$ and $\\frac{\\alpha}{2}\\mathrm{e}^{-\\mathrm{i}\\varphi}$ to the entry for $(-m,-n)$.\n3.  Calculate the denominator term by summing $|B_{m,n}|^2$ over all entries in the dictionary.\n4.  Calculate the numerator term by summing $|B_{m,n}|^2$ only for those entries $(m,n)$ that satisfy the case-specific symmetry condition $mM - nN = 0$.\n5.  Compute $\\mathcal{R}$, handling the special case of a zero denominator.\n6.  Compare $\\mathcal{R}$ with the threshold $\\tau$ and determine the boolean result.\n\nThis analytical method is exact for the given problem structure and avoids the complexities and potential floating-point inaccuracies of a numerical FFT implementation.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom collections import defaultdict\n\ndef solve():\n    \"\"\"\n    Solves the quasi-symmetry problem for a suite of four test cases.\n    \"\"\"\n    test_cases = [\n        # Case 1 (happy path, strong quasi-symmetry)\n        {\n            \"grid\": (64, 64), \"vmec\": (2.0, 3.0), \"symmetry\": (1, 1),\n            \"base_field\": 3.0, \"dominant_mode\": (1, 1, 0.2), \n            \"off_resonant_modes\": [(2, 1, 0.02, 0.0), (1, 0, 0.015, 0.3), (3, 2, 0.01, 1.0)],\n            \"spectral_bounds\": (4, 4), \"threshold\": 0.9\n        },\n        # Case 2 (near boundary, moderate quasi-symmetry)\n        {\n            \"grid\": (64, 64), \"vmec\": (1.0, 2.5), \"symmetry\": (2, 1),\n            \"base_field\": 2.5, \"dominant_mode\": (1, 2, 0.05),\n            \"off_resonant_modes\": [(1, 0, 0.04, 0.2), (0, 1, 0.03, 0.5), (3, 1, 0.03, 0.7)],\n            \"spectral_bounds\": (4, 4), \"threshold\": 0.6\n        },\n        # Case 3 (non-quasi-symmetric, failure expected)\n        {\n            \"grid\": (64, 64), \"vmec\": (0.5, 3.5), \"symmetry\": (3, 1),\n            \"base_field\": 2.8, \"dominant_mode\": (0, 0, 0.0),\n            \"off_resonant_modes\": [(1, 0, 0.06, 0.1), (2, 3, 0.05, 0.4), (3, 0, 0.04, 1.1)],\n            \"spectral_bounds\": (5, 5), \"threshold\": 0.5\n        },\n        # Case 4 (edge case, uniform field)\n        {\n            \"grid\": (64, 64), \"vmec\": (1.0, 1.0), \"symmetry\": (1, 1),\n            \"base_field\": 3.2, \"dominant_mode\": (0, 0, 0.0),\n            \"off_resonant_modes\": [],\n            \"spectral_bounds\": (3, 3), \"threshold\": 0.99\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        M, N = case[\"symmetry\"]\n        B0 = case[\"base_field\"]\n        m0, n0, epsilon = case[\"dominant_mode\"]\n        off_resonant = case[\"off_resonant_modes\"]\n        tau = case[\"threshold\"]\n\n        # Use a defaultdict to store complex Fourier coefficients B_mn\n        # for (m,n) != (0,0)\n        coeffs = defaultdict(complex)\n\n        # Process dominant mode\n        if epsilon > 0.0:\n            m, n = m0, n0\n            alpha = B0 * epsilon\n            # For a cosine term alpha*cos(m*theta - n*phi), the coefficients are\n            # B_mn = alpha/2 and B_-m,-n = alpha/2\n            if m != 0 or n != 0:\n                coeffs[(m, n)] += alpha / 2.0\n                coeffs[(-m, -n)] += alpha / 2.0\n\n        # Process off-resonant modes\n        for m_l, n_l, a_l, phi_l in off_resonant:\n            m, n = m_l, n_l\n            alpha = a_l\n            val = (alpha / 2.0) * np.exp(1j * phi_l)\n            # For a term a*cos(m*theta - n*phi + phi_l), the coefficients are\n            # B_mn = (a/2)*exp(i*phi_l) and B_-m,-n = (a/2)*exp(-i*phi_l)\n            if m != 0 or n != 0:\n                coeffs[(m, n)] += val\n                coeffs[(-m, -n)] += np.conj(val)\n\n        # Calculate the numerator and denominator for the ratio R\n        numerator_sum_sq = 0.0\n        denominator_sum_sq = 0.0\n\n        for (m, n), b_mn in coeffs.items():\n            power = np.abs(b_mn)**2\n            denominator_sum_sq += power\n            \n            # Check for quasi-symmetry condition: mM - nN = 0\n            if m * M - n * N == 0:\n                numerator_sum_sq += power\n\n        # Calculate R\n        if denominator_sum_sq == 0.0:\n            # Uniform field case, as defined in the problem\n            R = 1.0\n        else:\n            R = numerator_sum_sq / denominator_sum_sq\n            \n        results.append(R >= tau)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```"
        },
        {
            "introduction": "While the ideal concept of quasi-symmetry is defined in continuous terms, practical analysis relies on numerical computations on a finite grid, which introduces potential artifacts. This theoretical exercise explores the crucial issue of spectral aliasing, where high-frequency components of the magnetic field can incorrectly appear as low-frequency quasi-symmetry-breaking terms due to insufficient grid resolution . Mastering this concept is essential for correctly interpreting numerical optimization results and designing robust computational tools.",
            "id": "3719835",
            "problem": "Consider a stellarator whose magnetic field strength on a flux surface is represented in Boozer angles as a doubly periodic function $B(\\theta,\\zeta)$ with $(\\theta,\\zeta)\\in[0,2\\pi)\\times[0,2\\pi)$. In a Quasi-Symmetric (QS) configuration specified by coprime integers $(M,N)$, the ideal QS condition implies that the two-dimensional Fourier series coefficients $\\hat{B}_{m,n}$ vanish off the helical line $mN-nM=0$.\n\nIn practice, $B(\\theta,\\zeta)$ is sampled on a uniform grid of $N_{\\theta}$ and $N_{\\zeta}$ points in the poloidal and toroidal angles, respectively, and then a Discrete Fourier Transform (DFT) is computed. The DFT of a doubly periodic signal obeys aliasing exactly: the measured coefficient at $(m,n)$ equals the sum over the true coefficients at all indices congruent to $(m,n)$ modulo $(N_{\\theta},N_{\\zeta})$. The QS residual is then estimated by summing the measured amplitudes at indices with $mN-nM\\neq 0$ within a retained spectral set.\n\nAssume:\n- The true $B(\\theta,\\zeta)$ is exactly QS, so that $\\hat{B}_{m,n}=0$ whenever $mN-nM\\neq 0$.\n- There exists a physically small, smooth modeling error that introduces non-QS content only at high spectral indices with amplitudes that decay isotropically as $|\\hat{B}_{m,n}|\\leq C\\,(m^{2}+n^{2})^{-p/2}$ for some constants $C>0$ and $p>2$.\n- The retained spectral set is the disk $\\{(m,n):\\sqrt{m^{2}+n^{2}}\\leq K\\}$ for some cutoff radius $K\\in\\mathbb{N}$, and $N_{\\theta},N_{\\zeta}$ are large enough to resolve all retained modes without undersampling (you may assume $N_{\\theta},N_{\\zeta}\\geq 2K+1$).\n\nStarting from the exact aliasing property of the DFT on a two-torus, show that finite resolution produces an apparent QS residual by folding high-index non-QS coefficients into the retained low-index coefficients, thereby creating nonzero measured amplitudes at $(m,n)$ with $mN-nM\\neq 0$. Then, by bounding this leakage in terms of the decay law above and replacing the tail sum by a continuum integral in $(m,n)$-space, derive a de-aliasing criterion on the maximum retained index $K$ such that the worst-case apparent residual amplitude contributed by aliased high-index content is bounded above by a prescribed tolerance $\\epsilon>0$.\n\nYour final answer must be a single closed-form analytic expression for the minimal cutoff $K_{\\min}$ in terms of $C$, $p$, and $\\epsilon$. No numerical evaluation is required, and no units are involved. If you introduce any additional quantities, define them clearly. The angles are dimensionless and periodic, so no angle unit specification is required. Express the final result as a symbolic expression only; do not round.",
            "solution": "The problem as stated is scientifically grounded, self-contained, and well-posed. It presents a theoretical exercise in the application of Fourier analysis and signal processing concepts to a problem in plasma physics, specifically the numerical optimization of stellarator magnetic configurations. All necessary data and conditions are provided. We may therefore proceed with a solution.\n\nThe problem asks us to first explain how finite-resolution sampling of a magnetic field in a stellarator leads to an apparent quasi-symmetry (QS) breaking, and then to derive a criterion for the spectral resolution required to keep this artifact below a specified tolerance.\n\nLet the magnetic field strength on a flux surface be given in Boozer coordinates $(\\theta, \\zeta)$ by the function $B(\\theta, \\zeta)$, which is periodic in both angles with period $2\\pi$. Its Fourier series expansion is\n$$B(\\theta,\\zeta) = \\sum_{m,n \\in \\mathbb{Z}} \\hat{B}_{m,n} e^{i(m\\theta - n\\zeta)}$$\nwhere $\\hat{B}_{m,n}$ are the Fourier coefficients.\n\nThe problem states that the field is composed of an ideal QS component, $B_{QS}$, and a small, high-wavenumber modeling error, $B_{err}$.\nFor the ideal QS part, the coefficients $\\hat{B}^{QS}_{m,n}$ are non-zero only if they satisfy the helicity condition $mN - nM = 0$ for given coprime integers $(M,N)$.\nThe error part, $B_{err}$, consists of non-QS components. The problem specifies that these error components exist only at \"high spectral indices\". We interpret this to mean that the error coefficients $\\hat{B}^{err}_{m,n}$ are zero within the retained spectral set, which is a disk of radius $K$:\n$$\\hat{B}^{err}_{m,n} = 0 \\quad \\text{for} \\quad \\sqrt{m^2+n^2} \\leq K$$\nOutside this disk, the error coefficients are bounded by an isotropic decay law:\n$$|\\hat{B}^{err}_{m,n}| \\leq C(m^2+n^2)^{-p/2} \\quad \\text{for} \\quad \\sqrt{m^2+n^2} > K$$\nwhere $C>0$ and $p>2$ are constants.\n\nWhen $B(\\theta,\\zeta)$ is sampled on a uniform grid of $N_{\\theta} \\times N_{\\zeta}$ points, the Discrete Fourier Transform (DFT) is computed. The resulting discrete coefficients, which we denote $\\tilde{B}_{m,n}$, are related to the true continuous Fourier series coefficients $\\hat{B}_{m,n}$ by the aliasing formula:\n$$\\tilde{B}_{m,n} = \\sum_{k_\\theta \\in \\mathbb{Z}} \\sum_{k_\\zeta \\in \\mathbb{Z}} \\hat{B}_{m+k_\\theta N_\\theta, n+k_\\zeta N_\\zeta}$$\nEach measured coefficient $\\tilde{B}_{m,n}$ is the sum of the true coefficient $\\hat{B}_{m,n}$ and all its aliases. The total coefficient is $\\hat{B}_{m',n'} = \\hat{B}^{QS}_{m',n'} + \\hat{B}^{err}_{m',n'}$.\n\nThe apparent QS residual arises from measured non-zero amplitudes at indices $(m,n)$ that should ideally be zero. Let's consider a non-QS mode $(m,n)$ within the retained spectral set, meaning $\\sqrt{m^2+n^2} \\leq K$ and $mN-nM \\neq 0$.\nFor such a mode, the true ideal QS coefficient is zero: $\\hat{B}^{QS}_{m,n}=0$. By our interpretation of the error model, the true error coefficient is also zero: $\\hat{B}^{err}_{m,n}=0$. Therefore, the true total coefficient is zero: $\\hat{B}_{m,n}=0$. This corresponds to the term $(k_\\theta, k_\\zeta) = (0,0)$ in the aliasing sum.\n\nThe measured coefficient is thus composed entirely of aliased terms:\n$$\\tilde{B}_{m,n} = \\sum_{(k_\\theta, k_\\zeta) \\neq (0,0)} \\hat{B}_{m+k_\\theta N_\\theta, n+k_\\zeta N_\\zeta}$$\nLet's analyze the aliased indices $(m',n') = (m+k_\\theta N_\\theta, n+k_\\zeta N_\\zeta)$ for non-zero integer pairs $(k_\\theta,k_\\zeta)$. We are given that $N_\\theta, N_\\zeta \\geq 2K+1$. Since $|m| \\leq K$ and $|n| \\leq K$, the magnitude of the aliased index is, for example for $k_\\theta \\neq 0$:\n$$|m'| = |m+k_\\theta N_\\theta| \\geq ||k_\\theta| N_\\theta - |m|| \\geq |N_\\theta - K| \\geq |(2K+1)-K| = K+1$$\nThus, any aliased index $(m',n')$ lies outside the retained disk, i.e., $\\sqrt{(m')^2+(n')^2} > K$. At these high indices, the error coefficients $\\hat{B}^{err}_{m',n'}$ can be non-zero. The QS coefficients $\\hat{B}^{QS}_{m',n'}$ could also be non-zero if $(m+k_\\theta N_\\theta)N - (n+k_\\zeta N_\\zeta)M = 0$. This is a \"resonant aliasing\" which is typically avoided by careful choice of grid resolution $(N_\\theta, N_\\zeta)$. The problem text focuses on the \"folding of high-index non-QS coefficients,\" so we assume the contribution from aliased $\\hat{B}^{QS}$ terms is negligible.\nThe measured amplitude is then:\n$$\\tilde{B}_{m,n} \\approx \\sum_{(k_\\theta, k_\\zeta) \\neq (0,0)} \\hat{B}^{err}_{m+k_\\theta N_\\theta, n+k_\\zeta N_\\zeta}$$\nThis demonstrates that a non-zero amplitude $\\tilde{B}_{m,n}$ is measured for a non-QS mode, creating an apparent QS residual, due to the aliasing of high-frequency error content.\n\nNext, we derive a de-aliasing criterion on the retained index $K$. We need to bound the worst-case apparent residual amplitude and ensure it is less than a tolerance $\\epsilon$. The worst-case amplitude for any single non-QS mode $(m,n)$ in the retained set can be bounded using the triangle inequality:\n$$|\\tilde{B}_{m,n}| \\leq \\sum_{(k_\\theta, k_\\zeta) \\neq (0,0)} |\\hat{B}^{err}_{m+k_\\theta N_\\theta, n+k_\\zeta N_\\zeta}|$$\nThe problem directs us to find a criterion on $K$ by relating this leakage to a \"tail sum\" over the $(m,n)$ spectral space. A simple, albeit conservative, approach is to bound the aliasing error into any single mode by the total magnitude of all possible error coefficients, which are defined as the \"tail\" of the spectrum. This \"tail\" consists of all modes outside the retained set, i.e., all modes $(i,j)$ with $\\sqrt{i^2+j^2}>K$.\nLet the worst-case aliased amplitude be bounded by the sum of magnitudes of all error coefficients:\n$$|\\tilde{B}_{m,n}|_{worst-case} \\leq \\sum_{\\sqrt{i^2+j^2}>K} |\\hat{B}^{err}_{i,j}|$$\nUsing the given decay law, we have:\n$$|\\tilde{B}_{m,n}|_{worst-case} \\leq \\sum_{\\sqrt{i^2+j^2}>K} C(i^2+j^2)^{-p/2}$$\nWe now approximate this sum over the integer lattice with a continuum integral over the 2D plane in polar coordinates $(r,\\phi)$, where $i=r\\cos\\phi$ and $j=r\\sin\\phi$. The differential area element is $dA=di\\,dj = r\\,dr\\,d\\phi$. The summation domain becomes the region of the plane outside a disk of radius $K$.\n$$ \\sum_{\\sqrt{i^2+j^2}>K} C(i^2+j^2)^{-p/2} \\approx \\iint_{r>K} C(r^2)^{-p/2} \\, dA $$\nThe integral is:\n$$ \\int_{K}^{\\infty} \\int_{0}^{2\\pi} C (r^2)^{-p/2} r\\,d\\phi\\,dr = 2\\pi C \\int_{K}^{\\infty} r^{-p} r\\,dr = 2\\pi C \\int_{K}^{\\infty} r^{1-p}\\,dr $$\nSince the problem specifies $p>2$, the exponent $1-p$ is less than $-1$, so the integral converges at infinity.\n$$ 2\\pi C \\left[ \\frac{r^{2-p}}{2-p} \\right]_{K}^{\\infty} = 2\\pi C \\left( \\lim_{r\\to\\infty} \\frac{r^{2-p}}{2-p} - \\frac{K^{2-p}}{2-p} \\right) $$\nAs $2-p  0$, the limit at infinity is $0$.\n$$ = 2\\pi C \\left( 0 - \\frac{K^{2-p}}{2-p} \\right) = \\frac{2\\pi C}{p-2} K^{2-p} $$\nWe require this upper bound on the worst-case aliased amplitude to be smaller than the prescribed tolerance $\\epsilon$:\n$$ \\frac{2\\pi C}{p-2} K^{2-p} \\leq \\epsilon $$\nWe now solve for $K$. This inequality defines the condition on $K$ to ensure the aliasing error is sufficiently small.\n$$ K^{2-p} \\leq \\frac{\\epsilon(p-2)}{2\\pi C} $$\nSince $2-p$ is a negative exponent, we can write this as:\n$$ K^{-(p-2)} \\leq \\frac{\\epsilon(p-2)}{2\\pi C} $$\nTaking the reciprocal of both sides reverses the inequality sign:\n$$ K^{p-2} \\geq \\frac{2\\pi C}{\\epsilon(p-2)} $$\nFinally, taking the $(p-2)$-th root of both sides gives the condition on $K$:\n$$ K \\geq \\left( \\frac{2\\pi C}{\\epsilon(p-2)} \\right)^{1/(p-2)} $$\nThis inequality specifies that the radius of the retained set, $K$, must be at least a certain value to ensure the aliasing error from the unresolved tail is below the tolerance $\\epsilon$. Therefore, the minimal cutoff radius $K_{min}$ is the lower bound of this range.\n$$ K_{min} = \\left( \\frac{2\\pi C}{\\epsilon(p-2)} \\right)^{1/(p-2)} $$\nThis is the required de-aliasing criterion expressed as a minimal value for the retained spectral cutoff $K$.",
            "answer": "$$\\boxed{\\left( \\frac{2\\pi C}{\\epsilon(p-2)} \\right)^{\\frac{1}{p-2}}}$$"
        },
        {
            "introduction": "The ultimate goal of quasi-symmetry studies is to design and optimize stellarator coils to achieve better plasma confinement. This exercise moves from analysis to the core mechanics of optimization, focusing on how a quasi-symmetry metric responds to small changes in the magnetic field spectrum . By deriving and verifying the gradient and Hessian of a quasi-symmetry functional, you will be engaging with the essential mathematical machinery that powers modern, large-scale stellarator optimization codes.",
            "id": "3719834",
            "problem": "Consider a stellarator configuration characterized by a poloidal angle $\\theta$ and a toroidal angle $\\zeta$ (angles must be treated in radians). In quasi-symmetry (QS), the magnitude of the magnetic field $B$ should depend only on a helical angle $\\alpha$ defined by $\\alpha = M \\theta - N \\zeta$, where $M$ and $N$ are fixed integers describing the quasi-symmetric helicity. A fundamental characterization of quasi-symmetry is that departures of $B(\\theta,\\zeta)$ from a univariate dependence on $\\alpha$ are penalized by a functional that measures the component of $\\nabla B$ orthogonal to the direction associated with changes in $\\alpha$.\n\nStart from the following fundamental base:\n- In a toroidal system with periodic angles, any sufficiently smooth $B(\\theta,\\zeta)$ can be represented by a finite Fourier series. The helical harmonics $\\cos(m \\theta - n \\zeta)$ and $\\sin(m \\theta - n \\zeta)$ form an orthogonal basis over the $2\\pi$-periodic torus.\n- If $B(\\theta,\\zeta)$ depends only on $\\alpha = M \\theta - N \\zeta$, then the gradient $\\nabla B$ lies entirely in the span of the vector $(M,-N)$ in the $(\\theta,\\zeta)$ plane, so any component of $\\nabla B$ orthogonal to $(M,-N)$ indicates quasi-symmetry violation.\n- The quasi-symmetry violation functional $\\mathcal{R}_{\\mathrm{QS}}$ can be defined as the area integral over the $2\\pi$-periodic domain of the squared magnitude of the component of $\\nabla B$ that is orthogonal to $(M,-N)$.\n\nLet the magnitude of the magnetic field be approximated by the Fourier series\n$$\nB(\\theta,\\zeta) = B_0 + \\sum_{k=1}^{K} \\left[a_k \\cos(m_k \\theta - n_k \\zeta) + b_k \\sin(m_k \\theta - n_k \\zeta)\\right],\n$$\nwhere $B_0$ is a constant, and $\\{(m_k,n_k)\\}_{k=1}^{K}$ are prescribed integer mode pairs. Let the parameter vector $x \\in \\mathbb{R}^{2K}$ collect the Fourier coefficients as $x = (a_1,\\dots,a_K,b_1,\\dots,b_K)$. Consider a small perturbation of the boundary shape represented by a direction $p \\in \\mathbb{R}^{2K}$ and an amplitude $\\varepsilon \\in \\mathbb{R}$, leading to the perturbed coefficients $x(\\varepsilon) = x_0 + \\varepsilon p$.\n\nTasks:\n1. Using the definitions above, derive from first principles the quadratic form of $\\mathcal{R}_{\\mathrm{QS}}(x)$ in terms of the Fourier coefficients $\\{a_k,b_k\\}$, the helicity $(M,N)$, and the mode integers $(m_k,n_k)$. Then, derive the gradient $\\nabla \\mathcal{R}_{\\mathrm{QS}}(x)$ and the Hessian $H(x)$ with respect to $x$.\n2. For a given $x_0$, direction $p$, and small amplitude $\\varepsilon$, derive the second-order Taylor prediction of the change in $\\mathcal{R}_{\\mathrm{QS}}$:\n$$\n\\Delta^{(2)}(\\varepsilon) = \\frac{1}{2}\\varepsilon^2\\, p^\\top H(x_0)\\, p.\n$$\nAlso derive the finite-difference central second derivative along $p$ at $\\varepsilon = 0$:\n$$\nD^{(2)}_{\\mathrm{FD}}(\\varepsilon) = \\frac{\\mathcal{R}_{\\mathrm{QS}}(x_0+\\varepsilon p) - 2\\,\\mathcal{R}_{\\mathrm{QS}}(x_0) + \\mathcal{R}_{\\mathrm{QS}}(x_0-\\varepsilon p)}{\\varepsilon^2}.\n$$\n3. Verify the quadratic model by checking two conditions for each test case:\n   - The central second derivative $D^{(2)}_{\\mathrm{FD}}(\\varepsilon)$ matches $p^\\top H(x_0)\\, p$ within a specified tolerance.\n   - The actual change $\\mathcal{R}_{\\mathrm{QS}}(x_0+\\varepsilon p) - \\mathcal{R}_{\\mathrm{QS}}(x_0) - \\varepsilon\\, \\nabla \\mathcal{R}_{\\mathrm{QS}}(x_0)^\\top p$ equals $\\Delta^{(2)}(\\varepsilon)$ within the same tolerance.\n\nAll quantities in this problem are dimensionless. Angles must be treated in radians. Your program must implement the derived expressions and perform the verification for the following test suite of parameter values:\n\n- Test case $1$ (general case):\n  - $(M,N) = (1,4)$,\n  - Modes: $[(1,0),(2,1),(3,-2)]$,\n  - $x_0$: $a = [0.3,-0.12,0.05]$, $b = [0.1,0.2,-0.07]$,\n  - $p$: $p_a = [0.05,-0.03,0.02]$, $p_b = [-0.02,0.01,0.04]$,\n  - $\\varepsilon = 10^{-3}$,\n  - Tolerance: $10^{-12}$.\n\n- Test case $2$ (helically aligned, boundary condition):\n  - $(M,N) = (2,3)$,\n  - Modes: $[(2,3)]$,\n  - $x_0$: $a = [0.7]$, $b = [-0.5]$,\n  - $p$: $p_a = [0.1]$, $p_b = [-0.2]$,\n  - $\\varepsilon = 10^{-6}$,\n  - Tolerance: $10^{-18}$.\n\n- Test case $3$ (zero base coefficients):\n  - $(M,N) = (1,1)$,\n  - Modes: $[(1,2),(2,1)]$,\n  - $x_0$: $a = [0.0,0.0]$, $b = [0.0,0.0]$,\n  - $p$: $p_a = [0.2,-0.15]$, $p_b = [0.05,0.1]$,\n  - $\\varepsilon = 10^{-4}$,\n  - Tolerance: $10^{-12}$.\n\n- Test case $4$ (very small perturbation amplitude):\n  - $(M,N) = (3,1)$,\n  - Modes: $[(1,1),(2,3),(4,-1)]$,\n  - $x_0$: $a = [0.25,-0.08,0.12]$, $b = [-0.05,0.06,-0.09]$,\n  - $p$: $p_a = [0.01,0.02,-0.015]$, $p_b = [0.02,-0.01,0.005]$,\n  - $\\varepsilon = 10^{-12}$,\n  - Tolerance: $10^{-18}$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $[result_1,result_2,result_3,result_4]$), where each $result_i$ is a boolean indicating whether both verifications in task $3$ passed for the corresponding test case.",
            "solution": "The problem is assessed to be valid. It is scientifically grounded in the principles of plasma physics and stellarator design, specifically the concept of quasi-symmetry. The problem is well-posed, with all necessary mathematical definitions, parameters, and constraints provided. The language is objective and formal. The tasks constitute a standard exercise in calculus, linear algebra, and numerical verification, which is self-contained and free of contradictions or ambiguities.\n\n### Derivations\n\nThe solution requires the derivation of the quasi-symmetry residual functional $\\mathcal{R}_{\\mathrm{QS}}$, its gradient, and its Hessian, followed by the verification of its quadratic model.\n\n**1. Derivation of the Functional $\\mathcal{R}_{\\mathrm{QS}}(x)$**\n\nThe problem defines the quasi-symmetry violation functional $\\mathcal{R}_{\\mathrm{QS}}$ as the area integral of the squared magnitude of the component of the magnetic field gradient $\\nabla B$ that is orthogonal to the helical direction vector.\n\nThe helical direction in the $(\\theta, \\zeta)$ coordinate plane is given by the vector $v_h = (M, -N)$. A vector orthogonal to $v_h$ is $v_h^{\\perp} = (N, M)$. The squared magnitude of the component of $\\nabla B$ orthogonal to $v_h$ is given by the squared projection of $\\nabla B$ onto $v_h^{\\perp}$:\n$$\n\\left| \\text{proj}_{v_h^{\\perp}}(\\nabla B) \\right|^2 = \\frac{(\\nabla B \\cdot v_h^{\\perp})^2}{\\|v_h^{\\perp}\\|^2} = \\frac{\\left( N \\frac{\\partial B}{\\partial \\theta} + M \\frac{\\partial B}{\\partial \\zeta} \\right)^2}{N^2 + M^2}\n$$\nThe functional $\\mathcal{R}_{\\mathrm{QS}}$ is the integral of this quantity over the toroidal domain, which spans $2\\pi$ in both $\\theta$ and $\\zeta$:\n$$\n\\mathcal{R}_{\\mathrm{QS}} = \\int_0^{2\\pi} \\int_0^{2\\pi} \\frac{1}{M^2+N^2} \\left( N \\frac{\\partial B}{\\partial \\theta} + M \\frac{\\partial B}{\\partial \\zeta} \\right)^2 d\\theta d\\zeta\n$$\nThe magnetic field $B(\\theta, \\zeta)$ is given by the Fourier series:\n$$\nB(\\theta,\\zeta) = B_0 + \\sum_{k=1}^{K} \\left[a_k \\cos(m_k \\theta - n_k \\zeta) + b_k \\sin(m_k \\theta - n_k \\zeta)\\right]\n$$\nIts partial derivatives are:\n$$\n\\frac{\\partial B}{\\partial \\theta} = \\sum_{k=1}^{K} \\left[ -a_k m_k \\sin(m_k \\theta - n_k \\zeta) + b_k m_k \\cos(m_k \\theta - n_k \\zeta) \\right]\n$$\n$$\n\\frac{\\partial B}{\\partial \\zeta} = \\sum_{k=1}^{K} \\left[ a_k n_k \\sin(m_k \\theta - n_k \\zeta) - b_k n_k \\cos(m_k \\theta - n_k \\zeta) \\right]\n$$\nWe form the linear combination inside the integral's parenthesis:\n$$\nN \\frac{\\partial B}{\\partial \\theta} + M \\frac{\\partial B}{\\partial \\zeta} = \\sum_{k=1}^{K} \\left[ (-N m_k a_k + M n_k a_k) \\sin(\\phi_k) + (N m_k b_k - M n_k b_k) \\cos(\\phi_k) \\right]\n$$\nwhere $\\phi_k = m_k \\theta - n_k \\zeta$. Let $\\delta_k = M n_k - N m_k$. The expression simplifies to:\n$$\nN \\frac{\\partial B}{\\partial \\theta} + M \\frac{\\partial B}{\\partial \\zeta} = \\sum_{k=1}^{K} \\delta_k \\left[ a_k \\sin(\\phi_k) - b_k \\cos(\\phi_k) \\right]\n$$\nSubstituting this into the integral and squaring the sum leads to:\n$$\n\\mathcal{R}_{\\mathrm{QS}} = \\frac{1}{M^2+N^2} \\int_0^{2\\pi} \\int_0^{2\\pi} \\left( \\sum_{k=1}^{K} \\delta_k [a_k \\sin(\\phi_k) - b_k \\cos(\\phi_k)] \\right) \\left( \\sum_{j=1}^{K} \\delta_j [a_j \\sin(\\phi_j) - b_j \\cos(\\phi_j)] \\right) d\\theta d\\zeta\n$$\nDue to the orthogonality of the trigonometric basis functions over the domain $[0, 2\\pi] \\times [0, 2\\pi]$, the integrals of cross-terms (where $k \\neq j$) are zero. We use the identities (for non-zero modes $(m_k,n_k)$):\n$$\n\\int_0^{2\\pi} \\int_0^{2\\pi} \\sin^2(\\phi_k) d\\theta d\\zeta = 2\\pi^2, \\quad \\int_0^{2\\pi} \\int_0^{2\\pi} \\cos^2(\\phi_k) d\\theta d\\zeta = 2\\pi^2, \\quad \\int_0^{2\\pi} \\int_0^{2\\pi} \\sin(\\phi_k)\\cos(\\phi_k) d\\theta d\\zeta = 0\n$$\nThe functional thus reduces to a sum over the diagonal terms ($k=j$):\n$$\n\\mathcal{R}_{\\mathrm{QS}} = \\frac{1}{M^2+N^2} \\sum_{k=1}^{K} \\delta_k^2 \\int_0^{2\\pi} \\int_0^{2\\pi} [a_k^2 \\sin^2(\\phi_k) + b_k^2 \\cos^2(\\phi_k)] d\\theta d\\zeta\n$$\n$$\n\\mathcal{R}_{\\mathrm{QS}} = \\frac{1}{M^2+N^2} \\sum_{k=1}^{K} \\delta_k^2 [a_k^2 (2\\pi^2) + b_k^2 (2\\pi^2)]\n$$\nThis gives the final quadratic form for the functional in terms of the coefficients $x = (a_1, \\dots, a_K, b_1, \\dots, b_K)$:\n$$\n\\mathcal{R}_{\\mathrm{QS}}(x) = \\frac{2\\pi^2}{M^2+N^2} \\sum_{k=1}^{K} (M n_k - N m_k)^2 (a_k^2 + b_k^2)\n$$\n\n**2. Derivation of the Gradient $\\nabla \\mathcal{R}_{\\mathrm{QS}}(x)$ and Hessian $H(x)$**\n\nThe gradient $\\nabla \\mathcal{R}_{\\mathrm{QS}}(x)$ is a $2K$-dimensional vector of partial derivatives with respect to the components of $x$. For a given mode index $j \\in \\{1, \\dots, K\\}$:\n$$\n\\frac{\\partial \\mathcal{R}_{\\mathrm{QS}}}{\\partial a_j} = \\frac{\\partial}{\\partial a_j} \\left( \\frac{2\\pi^2}{M^2+N^2} \\sum_{k=1}^{K} \\delta_k^2 (a_k^2 + b_k^2) \\right) = \\frac{2\\pi^2}{M^2+N^2} \\delta_j^2 (2 a_j) = \\frac{4\\pi^2}{M^2+N^2} (M n_j - N m_j)^2 a_j\n$$\nSimilarly, for the coefficient $b_j$:\n$$\n\\frac{\\partial \\mathcal{R}_{\\mathrm{QS}}}{\\partial b_j} = \\frac{4\\pi^2}{M^2+N^2} (M n_j - N m_j)^2 b_j\n$$\nThe Hessian $H(x)$ is the $2K \\times 2K$ matrix of second partial derivatives. Since $\\mathcal{R}_{\\mathrm{QS}}(x)$ is a purely quadratic function with no cross-terms between different modes or between $a_k$ and $b_j$, the Hessian is a constant diagonal matrix. The diagonal elements are:\n$$\nH_{a_j, a_j} = \\frac{\\partial^2 \\mathcal{R}_{\\mathrm{QS}}}{\\partial a_j^2} = \\frac{4\\pi^2}{M^2+N^2} (M n_j - N m_j)^2\n$$\n$$\nH_{b_j, b_j} = \\frac{\\partial^2 \\mathcal{R}_{\\mathrm{QS}}}{\\partial b_j^2} = \\frac{4\\pi^2}{M^2+N^2} (M n_j - N m_j)^2\n$$\nAll off-diagonal elements are zero. The diagonal elements corresponding to $a_k$ and $b_k$ for a given $k$ are identical.\n\n**3. Verification Expressions**\n\nThe problem requires verifying two identities based on a Taylor expansion around $x_0$.\nThe Taylor series of $\\mathcal{R}_{\\mathrm{QS}}(x_0 + \\varepsilon p)$ is:\n$$\n\\mathcal{R}_{\\mathrm{QS}}(x_0 + \\varepsilon p) = \\mathcal{R}_{\\mathrm{QS}}(x_0) + \\varepsilon \\nabla \\mathcal{R}_{\\mathrm{QS}}(x_0)^\\top p + \\frac{1}{2} \\varepsilon^2 p^\\top H(x_0) p + O(\\varepsilon^3)\n$$\nSince $\\mathcal{R}_{\\mathrm{QS}}$ is a quadratic polynomial, the expansion is exact and the terms of order $O(\\varepsilon^3)$ and higher are zero.\n\n- **Condition 1 Verification: $D^{(2)}_{\\mathrm{FD}}(\\varepsilon) = p^\\top H(x_0) p$**\nThe central finite difference formula for the second derivative is:\n$$\nD^{(2)}_{\\mathrm{FD}}(\\varepsilon) = \\frac{\\mathcal{R}_{\\mathrm{QS}}(x_0+\\varepsilon p) - 2\\mathcal{R}_{\\mathrm{QS}}(x_0) + \\mathcal{R}_{\\mathrm{QS}}(x_0-\\varepsilon p)}{\\varepsilon^2}\n$$\nUsing the exact Taylor expansion for $\\mathcal{R}_{\\mathrm{QS}}(x_0 \\pm \\varepsilon p)$:\n$$\n\\mathcal{R}_{\\mathrm{QS}}(x_0 \\pm \\varepsilon p) = \\mathcal{R}_{\\mathrm{QS}}(x_0) \\pm \\varepsilon \\nabla \\mathcal{R}_{\\mathrm{QS}}(x_0)^\\top p + \\frac{1}{2}\\varepsilon^2 p^\\top H(x_0) p\n$$\nSubstituting into the numerator of $D^{(2)}_{\\mathrm{FD}}(\\varepsilon)$:\n$$\n\\text{Numerator} = \\left(\\mathcal{R}_{\\mathrm{QS}}(x_0) + \\dots\\right) - 2\\mathcal{R}_{\\mathrm{QS}}(x_0) + \\left(\\mathcal{R}_{\\mathrm{QS}}(x_0) - \\dots\\right)\n$$\n$$\n= (\\varepsilon \\nabla \\mathcal{R}_{\\mathrm{QS}}(x_0)^\\top p - \\varepsilon \\nabla \\mathcal{R}_{\\mathrm{QS}}(x_0)^\\top p) + (\\frac{1}{2}\\varepsilon^2 p^\\top H p + \\frac{1}{2}\\varepsilon^2 p^\\top H p) = \\varepsilon^2 p^\\top H(x_0) p\n$$\nTherefore, analytically:\n$$\nD^{(2)}_{\\mathrm{FD}}(\\varepsilon) = \\frac{\\varepsilon^2 p^\\top H(x_0) p}{\\varepsilon^2} = p^\\top H(x_0) p\n$$\nThe numerical check verifies $|D^{(2)}_{\\mathrm{FD}}(\\varepsilon) - p^\\top H(x_0) p| \\le \\text{tolerance}$.\n\n- **Condition 2 Verification: $\\mathcal{R}_{\\mathrm{QS}}(x_0+\\varepsilon p) - \\mathcal{R}_{\\mathrm{QS}}(x_0) - \\varepsilon \\nabla \\mathcal{R}_{\\mathrm{QS}}(x_0)^\\top p = \\Delta^{(2)}(\\varepsilon)$**\nThe left-hand side (LHS) represents the actual change minus the first-order Taylor approximation. The right-hand side (RHS) is the second-order term $\\Delta^{(2)}(\\varepsilon) = \\frac{1}{2}\\varepsilon^2 p^\\top H(x_0) p$.\nFrom the exact Taylor expansion:\n$$\n\\mathcal{R}_{\\mathrm{QS}}(x_0+\\varepsilon p) - \\mathcal{R}_{\\mathrm{QS}}(x_0) - \\varepsilon \\nabla \\mathcal{R}_{\\mathrm{QS}}(x_0)^\\top p = \\frac{1}{2}\\varepsilon^2 p^\\top H(x_0) p\n$$\nThis shows that LHS is analytically equal to RHS. The numerical check verifies $| \\text{LHS} - \\text{RHS} | \\le \\text{tolerance}$.\nBoth conditions are identities for a quadratic function, so the verification primarily tests for implementation correctness and assesses floating-point precision.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the verification for all test cases.\n    \"\"\"\n    test_cases = [\n        {\n            \"M\": 1, \"N\": 4,\n            \"modes\": np.array([[1, 0], [2, 1], [3, -2]]),\n            \"x0_a\": np.array([0.3, -0.12, 0.05]),\n            \"x0_b\": np.array([0.1, 0.2, -0.07]),\n            \"p_a\": np.array([0.05, -0.03, 0.02]),\n            \"p_b\": np.array([-0.02, 0.01, 0.04]),\n            \"eps\": 1e-3,\n            \"tol\": 1e-12\n        },\n        {\n            \"M\": 2, \"N\": 3,\n            \"modes\": np.array([[2, 3]]),\n            \"x0_a\": np.array([0.7]),\n            \"x0_b\": np.array([-0.5]),\n            \"p_a\": np.array([0.1]),\n            \"p_b\": np.array([-0.2]),\n            \"eps\": 1e-6,\n            \"tol\": 1e-18\n        },\n        {\n            \"M\": 1, \"N\": 1,\n            \"modes\": np.array([[1, 2], [2, 1]]),\n            \"x0_a\": np.array([0.0, 0.0]),\n            \"x0_b\": np.array([0.0, 0.0]),\n            \"p_a\": np.array([0.2, -0.15]),\n            \"p_b\": np.array([0.05, 0.1]),\n            \"eps\": 1e-4,\n            \"tol\": 1e-12\n        },\n        {\n            \"M\": 3, \"N\": 1,\n            \"modes\": np.array([[1, 1], [2, 3], [4, -1]]),\n            \"x0_a\": np.array([0.25, -0.08, 0.12]),\n            \"x0_b\": np.array([-0.05, 0.06, -0.09]),\n            \"p_a\": np.array([0.01, 0.02, -0.015]),\n            \"p_b\": np.array([0.02, -0.01, 0.005]),\n            \"eps\": 1e-12,\n            \"tol\": 1e-18\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        result = run_verification(case)\n        results.append(result)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef calc_R_QS(M, N, modes, coeffs):\n    \"\"\"\n    Calculates the quasi-symmetry residual R_QS for a given set of coefficients.\n    \n    Args:\n        M, N (int): Helicity integers.\n        modes (np.ndarray): Array of (m_k, n_k) mode pairs, shape (K, 2).\n        coeffs (np.ndarray): Vector of coefficients [a_1,..,a_K, b_1,..,b_K].\n\n    Returns:\n        float: The value of the R_QS functional.\n    \"\"\"\n    K = modes.shape[0]\n    a = coeffs[:K]\n    b = coeffs[K:]\n    \n    m = modes[:, 0]\n    n = modes[:, 1]\n    \n    if M**2 + N**2 == 0:\n        return 0.0\n\n    delta = M * n - N * m\n    delta_sq = delta**2\n    \n    prefactor = (2 * np.pi**2) / (M**2 + N**2)\n    \n    sum_term = np.sum(delta_sq * (a**2 + b**2))\n    \n    return prefactor * sum_term\n\ndef calc_grad_R_QS(M, N, modes, coeffs):\n    \"\"\"\n    Calculates the gradient of R_QS.\n    \"\"\"\n    K = modes.shape[0]\n    a = coeffs[:K]\n    b = coeffs[K:]\n    \n    m = modes[:, 0]\n    n = modes[:, 1]\n    \n    if M**2 + N**2 == 0:\n        return np.zeros_like(coeffs)\n\n    delta = M * n - N * m\n    delta_sq = delta**2\n    \n    prefactor = (4 * np.pi**2) / (M**2 + N**2)\n    \n    grad_a = prefactor * delta_sq * a\n    grad_b = prefactor * delta_sq * b\n    \n    return np.concatenate([grad_a, grad_b])\n\ndef calc_hessian_diag(M, N, modes):\n    \"\"\"\n    Calculates the diagonal of the Hessian of R_QS.\n    \"\"\"\n    K = modes.shape[0]\n    \n    m = modes[:, 0]\n    n = modes[:, 1]\n    \n    if M**2 + N**2 == 0:\n        return np.zeros(2*K)\n    \n    delta = M * n - N * m\n    delta_sq = delta**2\n    \n    prefactor = (4 * np.pi**2) / (M**2 + N**2)\n    \n    h_k = prefactor * delta_sq\n    \n    return np.concatenate([h_k, h_k])\n\ndef run_verification(params):\n    \"\"\"\n    Runs the two verification conditions for a single test case.\n    \n    Args:\n        params (dict): A dictionary containing all parameters for the test case.\n\n    Returns:\n        bool: True if both conditions pass, False otherwise.\n    \"\"\"\n    M, N = params[\"M\"], params[\"N\"]\n    modes = params[\"modes\"]\n    x0_a, x0_b = params[\"x0_a\"], params[\"x0_b\"]\n    p_a, p_b = params[\"p_a\"], params[\"p_b\"]\n    eps, tol = params[\"eps\"], params[\"tol\"]\n\n    x0 = np.concatenate([x0_a, x0_b])\n    p = np.concatenate([p_a, p_b])\n\n    # --- Condition 1 Verification ---\n    # Compare D_FD^{(2)}(eps) with p^T H p\n    \n    # Calculate p^T H p\n    H_diag = calc_hessian_diag(M, N, modes)\n    pT_H_p = np.sum(H_diag * p**2)\n\n    # Calculate D_FD^{(2)}\n    R_plus = calc_R_QS(M, N, modes, x0 + eps * p)\n    R_zero = calc_R_QS(M, N, modes, x0)\n    R_minus = calc_R_QS(M, N, modes, x0 - eps * p)\n    \n    # Avoid division by zero if eps is extremely small\n    if eps**2  1e-30:\n        # For a quadratic, D2_FD is independent of eps and equals pT_H_p\n        D2_FD = pT_H_p \n    else:    \n        D2_FD = (R_plus - 2 * R_zero - R_minus) / eps**2\n    \n    cond1_passed = abs(D2_FD - pT_H_p) = tol\n    \n    # --- Condition 2 Verification ---\n    # Compare actual change minus linear term with the 2nd-order Taylor term\n    \n    # Calculate LHS: actual change - linear term\n    grad_R0 = calc_grad_R_QS(M, N, modes, x0)\n    grad_term = eps * np.dot(grad_R0, p)\n    actual_change = R_plus - R_zero - grad_term\n    \n    # Calculate RHS: 2nd-order Taylor term Delta^(2)\n    taylor_approx = 0.5 * eps**2 * pT_H_p\n    \n    cond2_passed = abs(actual_change - taylor_approx) = tol\n\n    return cond1_passed and cond2_passed\n\nsolve()\n\n```"
        }
    ]
}