{
    "hands_on_practices": [
        {
            "introduction": "尽管超导磁体在“持久模式”下运行，但其磁场并非绝对恒定。一种被称为“磁通蠕动”的物理现象会导致缓慢但可测量的长期磁场漂移。本练习将引导您从基本物理原理推导出经典的对数漂移模型，并利用该模型分析真实数据，从而将基础物理学与实际的磁体性能预测联系起来。",
            "id": "3726334",
            "problem": "用于有机化合物核磁共振 (NMR) 波谱鉴定的一台超导磁体在持续模式下运行，并由液氦 (LHe) 冷却，使用液氮 (LN2) 作为辐射屏。在持续模式下，由于量子化涡旋（磁通蠕变）跨越钉扎位点的热激活运动，磁体孔径内的磁场会缓慢变化。磁场漂移会影响波谱仪的频率锁定，以及用于化学位移定标和匀场的质子共振信号的长期稳定性。\n\n从以下经过充分检验的物理基础和核心定义出发：\n- 磁感应强度与磁体绕组中的输运电流成正比，即 $B \\propto I$。在一个长直螺线管中，$B = \\mu_0 n I$，其中 $\\mu_0$ 是真空磁导率，$n$ 是匝密度，但仅使用该比例关系就足以进行推导。\n- 磁通蠕变是热激活的涡旋运动。在一个具有 Anderson–Kim 势垒的钉扎涡旋晶格中，激活能与电流密度的关系为 $U(J) = U_0 \\left(1 - \\frac{J}{J_c}\\right)$，其中 $U_0$ 是一个特征钉扎能，$J_c$ 是临界电流密度。\n- 蠕变速率遵循阿伦尼乌斯定律：$v \\propto \\exp\\!\\left[-\\frac{U(J)}{k_{\\mathrm{B}} T}\\right]$，其中 $k_{\\mathrm{B}}$ 是玻尔兹曼常数，$T$ 是温度。\n- 由涡旋运动产生的电场为 $E \\sim B v$；输运电流的宏观衰减由 $dJ/dt$ 控制，该衰减通过 $U(J)$ 继承了阿伦尼乌斯因子。\n- 原子核在静磁场 $B$ 中的共振频率 $f$ 由 $f = \\left(\\frac{\\gamma}{2\\pi}\\right) B$ 给出，其中 $\\gamma$ 是旋磁比。对于质子，$\\left(\\frac{\\gamma_H}{2\\pi}\\right) = 42.57747892 \\times 10^6 \\ \\mathrm{Hz/T}$；对于氘核，$\\left(\\frac{\\gamma_D}{2\\pi}\\right) = 6.535902 \\times 10^6 \\ \\mathrm{Hz/T}$。\n\n任务：\n1. 基于上述基础，推导在具有 Anderson–Kim 势垒 $U(J)$ 的热激活磁通蠕变条件下，$B(t)$ 对经过时间 $t$ 的预期函数依赖关系，并明确指出定义初始条件的参考时间 $t_0$ 的作用。证明该依赖关系是关于 $t/t_0$ 的对数关系，并指出需要从数据中估计的自由参数，而不在问题陈述中写出最终的目标公式。\n2. 给定在时间 $t_i$（秒）测得的氘锁频率 $f_D(t_i)$，使用 $B = \\frac{f_D}{\\gamma_D/2\\pi}$ 将这些频率转换为以 $\\mathrm{T}$ 为单位的孔径磁场值 $B(t_i)$，并选择 $t_0 = t_{\\min}$（第一次测量时间），使用最小二乘法拟合对数时间漂移模型。从拟合结果中，提取量化漂移的幅度参数和参考时间的磁场值。使用这些参数预测在未来时间 $t_{\\mathrm{future}} = t_{\\mathrm{last}} + 43200$（即在最后一次测量的基础上增加 $12$ 小时）时，以 $\\mathrm{Hz}$ 为单位的质子共振频率 $f_H$。\n3. 使用预测结果，根据标准 $|\\Delta f_H|  10.0 \\, \\mathrm{Hz}$，将磁体在未来 $12$ 小时内的频率稳定性分类为稳定或不稳定，其中 $\\Delta f_H$ 是在 $t_{\\mathrm{last}}$ 和 $t_{\\mathrm{future}}$ 之间质子频率的预测变化量。\n4. 实现一个程序，为每个测试用例执行转换、拟合和预测，并生成一行输出。该输出包含一个由方括号括起来的逗号分隔列表。每个结果必须是一个包含三个元素的列表：以 $\\mathrm{T}$ 为单位的拟合漂移幅度、在 $t_{\\mathrm{future}}$ 时以 $\\mathrm{Hz}$ 为单位的预测质子频率，以及一个表示稳定性的布尔值。因此，输出必须具有以下形式：$[ [\\text{amp}_1,\\text{fH}_1,\\text{stable}_1], [\\text{amp}_2,\\text{fH}_2,\\text{stable}_2], \\dots ]$。\n\n使用以下测量的氘锁数据测试套件（频率单位为 $\\mathrm{Hz}$，时间单位为 $\\mathrm{s}$）。每个用例代表一个不同的磁体和运行条件：\n- 用例 A（标称 $14.1 \\ \\mathrm{T}$ 级磁体，典型漂移）：时间 $[300, 900, 3600, 14400, 21600]$，对应的 $f_D$ 值为 $[92156218.2, 92156216.2, 92156213.7, 92156211.2, 92156210.5]$。\n- 用例 B（标称 $9.4 \\ \\mathrm{T}$ 级磁体，近乎平坦的漂移）：时间 $[60, 120, 300, 1800, 10800]$，对应的 $f_D$ 值为 $[61437478.8, 61437478.7, 61437478.5, 61437478.1, 61437477.8]$。\n- 用例 C（标称 $18.8 \\ \\mathrm{T}$ 级磁体，较大漂移）：时间 $[600, 1800, 7200, 43200]$，对应的 $f_D$ 值为 $[122874957.6, 122874954.0, 122874949.5, 122874943.6]$。\n\n角度单位不适用。所有输出都必须以指定的物理单位提供。您的程序应生成一行输出，其中包含一个由方括号括起来的逗号分隔列表（例如，$[[0.000001,600000000.0,True], [\\dots], [\\dots]]$）。",
            "solution": "用户提供了一个需要对超导核磁共振磁体中的磁场漂移进行定量分析的问题。解决该问题需要首先推导漂移的理论模型，然后应用该模型拟合实验数据，最后使用拟合模型进行预测和稳定性分类。\n\n### 问题验证\n该问题已根据既定标准进行了验证。\n\n1.  **已知条件提取**：所有物理原理、常数（$\\gamma_H/2\\pi$, $\\gamma_D/2\\pi$）、任务定义、稳定性标准（$|\\Delta f_H|  10.0 \\, \\mathrm{Hz}$）和测试数据集均已逐字提取。\n2.  **验证检查**：该问题在超导物理学（Anderson-Kim 磁通蠕变）和核磁共振方面具有**科学依据**。所提供的关系和常数是标准且正确的。该问题是**适定的**，具有明确的目标、充足的数据和明确的数学流程（最小二乘拟合）。它是**客观的**，使用了精确的定量语言，避免了歧义。问题是自洽的，没有矛盾。所提供的数据是真实的，通过检查标称磁场强度与氘锁频率之间的对应关系（$B = f_D / (\\gamma_D/2\\pi)$）可以证实这一点。例如，对于用例 A，$f_D \\approx 92.156 \\times 10^6 \\ \\mathrm{Hz}$，这给出了 $B \\approx (92.156 \\times 10^6) / (6.535902 \\times 10^6) \\approx 14.1 \\ \\mathrm{T}$，与描述相符。该问题既不琐碎也非无法验证。\n3.  **结论**：该问题被认为是**有效的**。\n\n### 分步解决方案\n\n#### 第 1 部分：对数漂移模型的推导\n\n磁场 $B(t)$ 的时间依赖性是根据热激活磁通蠕变的原理推导出来的。\n\n1.  磁场 $B$ 与超导绕组中的持续电流密度 $J$ 成正比。因此，$B$ 的时间行为遵循 $J$ 的行为。\n2.  电流的衰减是由磁通涡旋运动引起的微小电压造成的。根据法拉第定律，该电压导致电流变化率 $\\frac{dJ}{dt} \\propto -E$，其中 $E$ 是涡旋运动产生的电场。\n3.  电场与涡旋速度 $v$ 成正比，$E \\sim B v$。该速度是热激活的，并遵循阿伦尼乌斯型定律，$v \\propto \\exp\\left[-\\frac{U(J)}{k_{\\mathrm{B}} T}\\right]$。\n4.  激活能 $U(J)$ 由 Anderson-Kim 模型给出，$U(J) = U_0 \\left(1 - \\frac{J}{J_c}\\right)$，其中 $J$ 接近临界电流密度 $J_c$。\n5.  将这些结合起来，我们得到电流密度衰减的微分方程：\n    $$ \\frac{dJ}{dt} \\propto - J \\exp\\left[-\\frac{U_0}{k_{\\mathrm{B}} T} \\left(1 - \\frac{J}{J_c}\\right)\\right] $$\n    对于慢速蠕变，$J$ 几乎是恒定的，可以被吸收到比例常数中。令 $\\alpha = \\frac{U_0}{k_{\\mathrm{B}}T J_c}$。方程简化为：\n    $$ \\frac{dJ}{dt} \\approx -C \\exp(\\alpha J) $$\n    其中 $C$ 是一个常数。\n6.  这个微分方程可以通过分离变量法求解：$e^{-\\alpha J} dJ = -C dt$。一个更直接的、在文献中常见且能证明一致性的方法是检验一个对数解。让我们假设一个形式为 $J(t) = K_1 - K_2 \\ln(t)$ 的解。那么 $\\frac{dJ}{dt} = -\\frac{K_2}{t}$。将此代入微分方程得到：\n    $$ -\\frac{K_2}{t} = -C \\exp[\\alpha(K_1 - K_2 \\ln t)] = -C e^{\\alpha K_1} t^{-\\alpha K_2} $$\n    为了使该等式对所有 $t$ 成立，$t$ 的幂必须相等：$t^{-1} = t^{-\\alpha K_2}$，这意味着 $\\alpha K_2 = 1$，或 $K_2 = 1/\\alpha$。系数也必须匹配。这证实了对时间的对数依赖关系是一个有效的解。\n7.  由于 $B(t) \\propto J(t)$，磁场也必须表现出对数衰减。我们可以相对于参考测量时间 $t_0$ 来表示它：\n    $$ B(t) = B(t_0) - A_m \\ln\\left(\\frac{t}{t_0}\\right) $$\n    这里，$t_0$ 是定义初始条件 $B(t_0)$ 的时间。该模型有两个待从实验数据中估计的自由参数：\n    -   $B(t_0)$：参考时间 $t_0$ 时的磁场。\n    -   $A_m$：漂移幅度，一个正常数，通过 $A_m \\propto 1/\\alpha \\propto \\frac{k_{\\mathrm{B}} T J_c}{U_0}$ 与物理参数相关联。\n\n#### 第 2 部分：数据拟合与预测\n\n推导出的模型 $B(t) = B(t_0) - A_m \\ln\\left(\\frac{t}{t_0}\\right)$，是关于 $\\ln(t/t_0)$ 的线性模型。我们可以将其重写为 $y = p_0 + p_1 x$ 的形式，以进行线性最小二乘拟合，其中：\n-   $y = B(t)$\n-   $x = \\ln(t/t_0)$\n-   $p_0 = B(t_0)$ 是截距，代表参考时间的磁场。\n-   $p_1 = -A_m$ 是斜率。\n\n每个测试用例的流程如下：\n1.  **数据转换**：使用关系式 $B_i = f_{D,i} / (\\gamma_D/2\\pi)$ 将在时间 $t_i$ 测得的氘频率 $f_{D,i}$ 转换为磁场值 $B_i$。\n2.  **变量转换**：选择第一次测量时间作为参考时间，$t_0 = t_{\\min}$。计算用于拟合的自变量，$x_i = \\ln(t_i/t_0)$。\n3.  **最小二乘拟合**：对 $B_i$ 与 $x_i$ 进行线性最小二乘回归，以找到最优参数 $p_0$ 和 $p_1$。这将使用 `numpy.linalg.lstsq` 来完成。\n4.  **参数提取**：漂移幅度为 $A_m = -p_1$。参考时间的拟合磁场为 $p_0$。\n5.  **预测**：\n    -   计算未来时间 $t_{\\mathrm{future}} = t_{\\mathrm{last}} + 43200 \\ \\mathrm{s}$。\n    -   使用拟合模型预测此时间的磁场：$B_{\\mathrm{future}} = p_0 + p_1 \\ln(t_{\\mathrm{future}}/t_0)$。\n    -   将该磁场转换为相应的质子共振频率：$f_{H, \\mathrm{future}} = (\\gamma_H/2\\pi) \\times B_{\\mathrm{future}}$。\n\n#### 第 3 部分：稳定性分类\n\n在从 $t_{\\mathrm{last}}$ 到 $t_{\\mathrm{future}}$ 的 12 小时内评估磁体的稳定性。\n1.  计算质子共振频率的预测变化量，$\\Delta f_H = f_H(t_{\\mathrm{future}}) - f_H(t_{\\mathrm{last}})$。\n2.  使用拟合模型，$f_H(t) = (\\gamma_H/2\\pi) \\times (p_0 + p_1 \\ln(t/t_0))$。\n3.  于是变化量为：\n    $$ \\Delta f_H = \\frac{\\gamma_H}{2\\pi} \\times p_1 \\left( \\ln\\left(\\frac{t_{\\mathrm{future}}}{t_0}\\right) - \\ln\\left(\\frac{t_{\\mathrm{last}}}{t_0}\\right) \\right) = \\frac{\\gamma_H}{2\\pi} p_1 \\ln\\left(\\frac{t_{\\mathrm{future}}}{t_{\\mathrm{last}}}\\right) $$\n4.  如果 $|\\Delta f_H|  10.0 \\, \\mathrm{Hz}$，则稳定性分类为 `True`（稳定），否则为 `False`（不稳定）。\n\n以下 Python 代码实现了这整个过程。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem of analyzing superconducting magnet field drift for NMR.\n\n    This function processes several test cases of magnet drift data. For each case, it:\n    1. Converts measured deuterium lock frequencies to magnetic field values.\n    2. Fits a logarithmic-in-time drift model (B(t) = p0 + p1*ln(t/t0)) using linear least squares.\n    3. Extracts the drift amplitude from the fit.\n    4. Forecasts the proton resonance frequency 12 hours after the last measurement.\n    5. Classifies the magnet's stability based on the forecasted frequency change over that 12-hour period.\n    The results are then printed in the specified format.\n    \"\"\"\n\n    # Define physical constants\n    # Gyromagnetic ratio / 2*pi for Proton in Hz/T\n    GAMMA_H_OVER_2PI = 42.57747892e6\n    # Gyromagnetic ratio / 2*pi for Deuterium in Hz/T\n    GAMMA_D_OVER_2PI = 6.535902e6\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case A (nominal 14.1 T class magnet, typical drift)\n        {\n            \"times\": np.array([300, 900, 3600, 14400, 21600], dtype=np.float64),\n            \"f_D\": np.array([92156218.2, 92156216.2, 92156213.7, 92156211.2, 92156210.5], dtype=np.float64),\n        },\n        # Case B (nominal 9.4 T class magnet, near-flat drift)\n        {\n            \"times\": np.array([60, 120, 300, 1800, 10800], dtype=np.float64),\n            \"f_D\": np.array([61437478.8, 61437478.7, 61437478.5, 61437478.1, 61437477.8], dtype=np.float64),\n        },\n        # Case C (nominal 18.8 T class magnet, larger drift)\n        {\n            \"times\": np.array([600, 1800, 7200, 43200], dtype=np.float64),\n            \"f_D\": np.array([122874957.6, 122874954.0, 122874949.5, 122874943.6], dtype=np.float64),\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        times = case[\"times\"]\n        freq_d = case[\"f_D\"]\n\n        # Task 2: Convert frequency to field and fit the model\n        # B(t) = f_D(t) / (gamma_D/2pi)\n        B_measured = freq_d / GAMMA_D_OVER_2PI\n\n        # The model to fit is B(t) = B(t0) - A_m * ln(t/t0), which is a linear model\n        # y = p0 + p1*x where y=B, x=ln(t/t0), p0=B(t0), p1=-A_m\n        t0 = times[0]\n        x_fit = np.log(times / t0)\n\n        # Set up the design matrix for linear least squares\n        A_matrix = np.vstack([np.ones(len(x_fit)), x_fit]).T\n        \n        # Perform the least-squares fit\n        p, _, _, _ = np.linalg.lstsq(A_matrix, B_measured, rcond=None)\n        p0, p1 = p[0], p[1]\n\n        # Extract the drift amplitude\n        drift_amplitude = -p1\n\n        # Forecast proton frequency at t_future\n        t_last = times[-1]\n        t_future = t_last + 43200.0  # Add 12 hours in seconds\n        \n        # Use the fitted model to predict B at t_future\n        B_future = p0 + p1 * np.log(t_future / t0)\n        \n        # Convert B_future to proton frequency\n        f_H_future = GAMMA_H_OVER_2PI * B_future\n\n        # Task 3: Classify stability\n        # Calculate the change in proton frequency from t_last to t_future\n        # Delta_f_H = f_H(t_future) - f_H(t_last)\n        # Using the model: f_H(t) = GAMMA_H_OVER_2PI * (p0 + p1*ln(t/t0))\n        delta_f_H = GAMMA_H_OVER_2PI * p1 * (np.log(t_future / t0) - np.log(t_last / t0))\n        delta_f_H = GAMMA_H_OVER_2PI * p1 * np.log(t_future / t_last)\n\n        # Stability criterion: |Delta f_H|  10.0 Hz\n        is_stable = abs(delta_f_H)  10.0\n\n        results.append([drift_amplitude, f_H_future, is_stable])\n\n    # Task 4: Final print statement in the exact required format\n    # Build the string representation for the final list of lists\n    result_strings = []\n    for res in results:\n        # Each res is [amplitude, frequency, stability_boolean]\n        # str(value) is used for default representation of floats and booleans.\n        # Python's str(True) is 'True', which matches the example's capitalization.\n        result_strings.append(f\"[{str(res[0])},{str(res[1])},{str(res[2])}]\")\n    \n    print(f\"[{','.join(result_strings)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "了解了长期漂移的存在后，一个自然的问题是：我们如何实时主动补偿这种漂移？答案在于场频锁定系统，这是一个持续监控和校正磁场的反馈回路。本练习将深入探讨该系统的核心，推导所测量的频率漂移与主要的 $Z_0$ 匀场线圈中所需校正电流之间的关系，揭示高分辨率核磁共振谱仪实现超高稳定性的关键。",
            "id": "3726292",
            "problem": "一台用于有机化合物波谱鉴定的高场核磁共振（NMR）谱仪，采用氘（${}^{2}\\mathrm{H}$）锁场在 $92\\ \\mathrm{MHz}$ 下稳定静磁场。在超导磁体中，慢速的磁场漂移由致冷剂相关的热变化和磁通蠕变引起。氘的拉莫尔频率遵循关系式 $f = (\\gamma_{D}/2\\pi)\\,B_{0}$，其中 $\\gamma_{D}$ 是氘的旋磁比，$B_{0}$ 是静磁场。锁场控制器使用中心均匀匀场通道 $Z_{0}$ 来校正 $B_{0}$；$Z_{0}$ 线圈的特性由一个校准常数 $\\beta_{Z0}$ 描述，定义为 $dB_{0} = \\beta_{Z0}\\,dI$，其中 $I$ 是施加的 $Z_{0}$ 电流。\n\n假设锁场通道报告测得的氘频率漂移率为 $\\frac{df}{dt}$（符号约定为正的 $\\frac{df}{dt}$ 表示频率增加）。在每分钟内，控制器施加一次单一的 $Z_{0}$ 电流校正来补偿累积的漂移。在每分钟内漂移是线性的，并且 $Z_{0}$ 场在样品体积内是均匀的假设下，请从第一性原理推导出一个解析表达式，用于表示为了将锁场频率保持在 $92\\ \\mathrm{MHz}$ 的 $\\pm 1\\ \\mathrm{Hz}$ 范围内所必须施加的每分钟的 $Z_{0}$ 电流校正量 $\\Delta I$。将最终答案表示为仅包含 $\\frac{df}{dt}$、$\\gamma_{D}$ 和 $\\beta_{Z0}$ 的闭式表达式。指明校正量相对于 $\\frac{df}{dt}$ 符号的符号。电流校正的单位使用安培/分钟。不允许进行数值代入；不要四舍五入。最终答案必须是单一的解析表达式。",
            "solution": "在尝试求解之前，将首先验证问题的科学合理性、一致性和完整性。\n\n### 问题验证\n\n**步骤 1：提取已知条件**\n-   氘（${}^{2}\\mathrm{H}$）锁场目标频率：$f_{target} = 92\\ \\mathrm{MHz}$。\n-   拉莫尔频率关系：$f = (\\gamma_{D}/2\\pi)\\,B_{0}$。\n-   氘旋磁比：$\\gamma_{D}$。\n-   静磁场：$B_{0}$。\n-   $Z_{0}$ 匀场线圈校准常数：$\\beta_{Z0}$，定义为 $dB_{0} = \\beta_{Z0}\\,dI$。\n-   $Z_{0}$ 电流：$I$。\n-   测得的频率漂移率：$\\frac{df}{dt}$。\n-   符号约定：正的 $\\frac{df}{dt}$ 对应于频率增加。\n-   校正时机：每分钟施加一次单一校正。\n-   假设：每分钟内为线性漂移。\n-   目标：推导“每分钟的电流校正量 $\\Delta I$”的表达式。\n-   约束：$\\Delta I$ 的表达式必须用 $\\frac{df}{dt}$、$\\gamma_{D}$ 和 $\\beta_{Z0}$ 表示。\n-   操作容差：频率必须保持在目标值的 $\\pm 1\\ \\mathrm{Hz}$ 范围内。\n-   单位：结果应表示为“安培/分钟”。\n\n**步骤 2：使用提取的已知条件进行验证**\n该问题具有科学依据，描述了核磁共振谱仪中标准的场频锁定机制。其中的物理原理（拉莫尔方程）和组件（匀场线圈、氘锁场）都得到了准确的表述。\n\n然而，问题陈述中存在一个必须解决的歧义。问题要求一个被指定为 $\\Delta I$ 的量，这通常代表电流的有限变化（单位为安培）。问题还描述校正过程是每分钟应用一次的离散步骤。一个离散电流步长 $\\Delta I_{step}$ 的推导必然会依赖于时间间隔 $\\Delta t = 1\\ \\text{分钟}$。这与最终表达式必须仅用 $\\frac{df}{dt}$、$\\gamma_{D}$ 和 $\\beta_{Z0}$ 表示的明确约束相矛盾。\n\n同时，问题要求答案的单位是“安培/分钟”，这是一个速率单位（电流/时间），而不是电流的变化量。这强烈表明，所要求的量是为持续补偿漂移所需的*电流变化率* $\\frac{dI}{dt}$。这种解释解决了这些矛盾：\n1.  推导速率 $\\frac{dI}{dt}$ 得到一个仅依赖于指定变量的表达式。\n2.  速率 $\\frac{dI}{dt}$ 的单位是电流/时间，与“安培/分钟”一致，前提是所有导数中的时间变量都以分钟为单位。\n\n“每分钟一次单一电流校正”的描述被解释为一个根本上连续的校正模型的实际实现。需要推导的量是理想的电流变化率。因此，符号“$\\Delta I$”被认为是速率 $\\frac{dI}{dt}$ 的一个不精确的符号。$\\pm 1\\ \\mathrm{Hz}$ 的容差是背景信息，不进入旨在实现零误差的理想补偿的推导中。\n\n**步骤 3：结论与行动**\n该问题被认为是**有效的**，但这取决于上述歧义的解决。解题过程将继续推导所需的匀场电流变化率 $\\frac{dI}{dt}$，并假设所有速率的时间基准都是分钟。\n\n### 电流校正率的推导\n\n场频锁定的基本原理是维持一个恒定的拉莫尔频率，这需要维持一个恒定的静磁场 $B_{0}$。磁场中的任何漂移都必须通过校正场来主动抵消。\n\n设总磁场 $B_{0}$ 是一个常数分量、一个随时间变化的漂移分量 $B_{drift}(t)$ 和一个由 $Z_{0}$ 匀场线圈产生的随时间变化的校正分量 $B_{corr}(t)$ 的总和。为了使锁场稳定，总磁场不能随时间变化，因此其时间导数必须为零：\n$$\n\\frac{dB_0}{dt} = \\frac{d}{dt} [B_{main} + B_{drift}(t) + B_{corr}(t)] = 0\n$$\n由于 $B_{main}$ 是常数，这可以简化为：\n$$\n\\frac{dB_{drift}}{dt} + \\frac{dB_{corr}}{dt} = 0 \\quad \\implies \\quad \\frac{dB_{corr}}{dt} = - \\frac{dB_{drift}}{dt}\n$$\n这个方程表明，校正场的变化率必须与漂移场的变化率大小相等、方向相反。\n\n我们可以将这些场漂移率与给定的频率漂移率 $\\frac{df}{dt}$ 联系起来。拉莫尔方程给出为：\n$$\nf = \\frac{\\gamma_{D}}{2\\pi} B_{0}\n$$\n在没有校正的情况下，观测到的频率漂移率是由漂移场引起的。将拉莫尔方程对时间 $t$ 求导，得到频率漂移和磁场漂移之间的关系：\n$$\n\\frac{df}{dt} = \\frac{\\gamma_{D}}{2\\pi} \\frac{dB_{drift}}{dt}\n$$\n我们可以重新整理这个式子，用可测量的频率漂移率来表示场漂移率：\n$$\n\\frac{dB_{drift}}{dt} = \\frac{2\\pi}{\\gamma_{D}} \\frac{df}{dt}\n$$\n接下来，我们将校正场率 $\\frac{dB_{corr}}{dt}$ 与匀场电流的变化率 $\\frac{dI}{dt}$ 联系起来。问题通过微分关系 $dB_{0} = \\beta_{Z0}\\,dI$ 提供了校准常数 $\\beta_{Z0}$。对于由匀场线圈产生的校正场分量，这意味着变化率之间存在如下关系：\n$$\n\\frac{dB_{corr}}{dt} = \\beta_{Z0} \\frac{dI}{dt}\n$$\n现在，我们将场率的表达式代入稳定性条件 $\\frac{dB_{corr}}{dt} = - \\frac{dB_{drift}}{dt}$ 中：\n$$\n\\beta_{Z0} \\frac{dI}{dt} = - \\frac{2\\pi}{\\gamma_{D}} \\frac{df}{dt}\n$$\n解出所需的电流校正率 $\\frac{dI}{dt}$，我们得到：\n$$\n\\frac{dI}{dt} = - \\frac{2\\pi}{\\gamma_{D} \\beta_{Z0}} \\frac{df}{dt}\n$$\n这个表达式代表了所需的 $Z_{0}$ 电流的连续变化率。根据验证分析，我们将题目中对“每分钟的电流校正量 $\\Delta I$”的要求解释为这个量，其中时间导数是隐式地相对于以分钟为单位测量的时间。这确保了单位是“安培/分钟”，并且表达式仅依赖于指定的变量。\n\n校正的符号为负。如果频率漂移率 $\\frac{df}{dt}$ 为正（磁场正在增加），则电流变化率 $\\frac{dI}{dt}$ 必须为负，以产生一个减小的反向场（假设 $\\gamma_D$ 和 $\\beta_{Z0}$ 是正常数，按惯例它们是正的）。这在物理上是正确的。",
            "answer": "$$\n\\boxed{-\\frac{2\\pi}{\\gamma_{D}\\beta_{Z0}}\\frac{df}{dt}}\n$$"
        },
        {
            "introduction": "除了时间上的稳定性，理想的磁场在空间上也必须是均匀的。匀场（Shimming）是校正磁场空间不均匀性的过程，对于获得高分辨率谱图至关重要。本计算练习将揭开匀场过程的神秘面纱，通过一个实际案例，向您展示如何利用线性代数从测量的场图计算出最佳的匀场线圈电流设定，从而将抽象的“匀场”操作转化为具体的数学优化问题。",
            "id": "3726346",
            "problem": "用于有机化合物光谱鉴定的核磁共振（NMR）超导磁体必须具有高度均匀的静磁场。样品磁化率和微小的安装缺陷会引起静磁场的空间变化，这可以通过向匀场线圈施加电流来校正。一阶匀场线圈产生的磁场与笛卡尔坐标成正比，通常称为 $Z_1$（与 $z$ 成正比）和 $X$（与 $x$ 成正比）。考虑在离散位置 $\\mathbf{r}_i=(x_i,y_i,z_i)$ 处测得的静磁场偏差图 $\\Delta B(\\mathbf{r}_i)$，其主要分量是 $Z_1$ 和 $X$。目标是计算能够最小化残余不均匀性的匀场电流，然后以氢核频率偏移的形式，量化施加计算出的匀场电流后的残余均匀性。\n\n基本原理和定义：\n- 磁场叠加原理指出，总磁场是来自独立源贡献的总和。如果匀场线圈产生的磁场与 $z$ 和 $x$ 成正比，其校准常数 $k_{Z_1}$ 和 $k_X$ 定义为场/安培/米，则在点 $(x_i,y_i,z_i)$ 处的匀场校正磁场为 $\\Delta B_{\\text{shim}}(x_i,y_i,z_i) = k_{Z_1} I_{Z_1} z_i + k_X I_X x_i$，其中 $I_{Z_1}$ 和 $I_X$ 是以安培为单位的施加电流。\n- 氢核拉莫尔频率偏移与磁场的关系为 $f = \\left(\\gamma/2\\pi\\right) \\Delta B$，其中 $\\gamma/2\\pi = 42.577\\times 10^6$ Hz/T 是质子的旋磁比。\n- 在每个样本位置匀场后的残余磁场为 $\\Delta B_{\\text{res},i} = \\Delta B(\\mathbf{r}_i) + \\Delta B_{\\text{shim}}(\\mathbf{r}_i)$，要最小化的平方误差目标是 $\\sum_i \\left(\\Delta B_{\\text{res},i}\\right)^2 = \\sum_i \\left(\\Delta B(\\mathbf{r}_i) + k_{Z_1} I_{Z_1} z_i + k_X I_X x_i\\right)^2$。\n- 最小二乘解旨在寻找使上述和最小化的电流 $I_{Z_1}$ 和 $I_X$。由于一阶匀场磁场在 $I_{Z_1}$ 和 $I_X$ 上是线性的，因此该问题可以构建为一个线性最小二乘问题。\n\n你的任务：\n- 对于下面的每个测试用例，使用数值稳定的方法计算两个匀场电流 $I_{Z_1}$ 和 $I_X$（单位为安培），以最小化 $\\sum_i \\left(\\Delta B(\\mathbf{r}_i) + k_{Z_1} I_{Z_1} z_i + k_X I_X x_i\\right)^2$。如果系统是秩亏的，则返回最小范数解。\n- 使用计算出的电流，构建残余磁场列表 $\\{\\Delta B_{\\text{res},i}\\}$，使用 $f_i = \\left(\\gamma/2\\pi\\right) \\Delta B_{\\text{res},i}$（其中 $\\gamma/2\\pi = 42.577\\times 10^6$ Hz/T）将其转换为以赫兹为单位的频率偏移，然后计算：\n    - 残余频率偏移的均方根 $\\text{RMS} = \\sqrt{\\frac{1}{N}\\sum_i f_i^2}$，以赫兹表示。\n    - 峰峰值残余频率展宽 $\\text{P2P} = \\max_i f_i - \\min_i f_i$，以赫兹表示。\n- 所有电流均以安培表示，所有频率量均以赫兹表示。不涉及角度。数值答案必须是浮点数。\n\n测试套件：\n案例 A（理想路径，二维网格，$Z_1$ 和 $X$ 均可观测）：\n- 坐标 $(x_i,z_i)$，单位为米，其中 $y_i=0$：\n    - $(-0.02,-0.015),(0,-0.015),(0.02,-0.015),(-0.02,0),(0,0),(0.02,0),(-0.02,0.015),(0,0.015),(0.02,0.015)$，即 $x$ 值 $[-0.02,0,0.02]$ 与 $z$ 值 $[-0.015,0,0.015]$ 的笛卡尔积。\n- 校准常数（场/安培/米）：\n    - $k_{Z_1} = 5.0\\times 10^{-3}$ T/(A·m), $k_X = 5.0\\times 10^{-3}$ T/(A·m).\n- 在上述各点测得的磁场图 $\\Delta B$，单位为特斯拉（按所列顺序）：\n    - [$-1.0 \\times 10^{-7}$, $-1.85 \\times 10^{-6}$, $-3.32 \\times 10^{-6}$, $1.53 \\times 10^{-6}$, $0$, $-1.54 \\times 10^{-6}$, $3.36 \\times 10^{-6}$, $1.82 \\times 10^{-6}$, $1.1 \\times 10^{-7}$]\n\n案例 B（边界情况，所有 $z_i=0$，仅 $X$ 可观测）：\n- 坐标 $(x_i,z_i)$，单位为米，其中 $y_i=0$：\n    - $(-0.02,0),(-0.01,0),(0,0),(0.01,0),(0.02,0)$。\n- 校准常数：\n    - $k_{Z_1} = 5.0\\times 10^{-3}$ T/(A·m), $k_X = 4.0\\times 10^{-3}$ T/(A·m).\n- 在上述各点测得的磁场图 $\\Delta B$，单位为特斯拉（按所列顺序）：\n    - [$-1.95 \\times 10^{-6}$, $-1.02 \\times 10^{-6}$, $0$, $1.03 \\times 10^{-6}$, $1.96 \\times 10^{-6}$]\n\n案例 C（含离群值的边缘情况，不规则采样）：\n- 坐标 $(x_i,z_i)$，单位为米，其中 $y_i=0$：\n    - $(-0.02,-0.02),(-0.015,-0.01),(-0.005,0),(0,0.01),(0.01,0.02),(0.015,-0.015),(0.02,0),(-0.01,0.02),(0,-0.02),(0.015,0.015)$。\n- 校准常数：\n    - $k_{Z_1} = 6.0\\times 10^{-3}$ T/(A·m), $k_X = 4.0\\times 10^{-3}$ T/(A·m).\n- 在上述各点测得的磁场图 $\\Delta B$，单位为特斯拉（按所列顺序）：\n    - [$0.85 \\times 10^{-6}$, $0.12 \\times 10^{-6}$, $-0.24 \\times 10^{-6}$, $-0.88 \\times 10^{-6}$, $-1.32 \\times 10^{-6}$, $2.90 \\times 10^{-6}$, $0.95 \\times 10^{-6}$, $-2.26 \\times 10^{-6}$, $1.74 \\times 10^{-6}$, $-0.60 \\times 10^{-6}$]\n\n算法说明：\n- 对于每个案例，构建设计矩阵 $\\mathbf{A}\\in\\mathbb{R}^{N\\times 2}$，其列为 $\\left[k_{Z_1} z_i\\right]$ 和 $\\left[k_X x_i\\right]$。令 $\\mathbf{b}=-\\Delta \\mathbf{B}$。\n- 计算最小范数最小二乘解 $\\mathbf{I}=\\left[I_{Z_1},I_X\\right]^T$，该解最小化 $\\|\\mathbf{A}\\mathbf{I}-\\mathbf{b}\\|_2$。\n- 计算残余磁场 $\\Delta \\mathbf{B}_{\\text{res}}=\\Delta \\mathbf{B}+\\mathbf{A}\\mathbf{I}$。\n- 使用 $f_i=\\left(\\gamma/2\\pi\\right)\\Delta B_{\\text{res},i}$（其中 $\\gamma/2\\pi=42.577\\times 10^6$ Hz/T）将残余磁场转换为频率偏移，然后计算 $\\text{RMS}=\\sqrt{\\frac{1}{N}\\sum_i f_i^2}$ 和 $\\text{P2P}=\\max_i f_i-\\min_i f_i$。\n\n最终输出格式：\n- 你的程序应生成单行输出，其中包含所有三个案例的结果，形式为方括号括起来的逗号分隔列表。每个案例的结果本身必须是包含四个浮点数的列表，顺序为 $[I_{Z_1}, I_X, \\text{RMS}, \\text{P2P}]$，其中电流单位为安培，频率度量单位为赫兹。例如，输出必须类似于 $[[i_{A,Z_1},i_{A,X},\\text{rms}_A,\\text{p2p}_A],[i_{B,Z_1},i_{B,X},\\text{rms}_B,\\text{p2p}_B],[i_{C,Z_1},i_{C,X},\\text{rms}_C,\\text{p2p}_C]]$，并用实际数值替换符号。",
            "solution": "超导磁体的静磁场不均匀性在局部可以很好地用球谐函数的线性组合来描述。一阶谐波 $Z_1$ 和 $X$ 分别对应于与 $z$ 和 $x$ 成正比的磁场。由于磁场是线性叠加的，施加匀场电流后的净残余磁场是测量偏差与匀场产生的校正之和。该问题的基本依据是线性叠加和线性最小二乘最小化。\n\n我们从在位置 $\\mathbf{r}_i=(x_i,y_i,z_i)$ 处测得的偏移 $\\Delta B(\\mathbf{r}_i)$ 开始。一阶匀场线圈产生的校正场由 $\\Delta B_{\\text{shim}}(x_i,y_i,z_i)=k_{Z_1} I_{Z_1} z_i + k_X I_X x_i$ 给出，其中 $k_{Z_1}$ 和 $k_X$ 是将电流和空间坐标转换为磁场的校准常数，而 $I_{Z_1}$, $I_X$ 是待确定的电流。样本 $i$ 处的残余磁场则为\n$$\n\\Delta B_{\\text{res},i}=\\Delta B(\\mathbf{r}_i)+k_{Z_1} I_{Z_1} z_i + k_X I_X x_i.\n$$\n为了求得 $I_{Z_1}$ 和 $I_X$，我们最小化残差平方和\n$$\nS(I_{Z_1},I_X)=\\sum_{i=1}^N\\left(\\Delta B(\\mathbf{r}_i)+k_{Z_1} I_{Z_1} z_i + k_X I_X x_i\\right)^2.\n$$\n这是一个线性最小二乘问题。设设计矩阵为\n$$\n\\mathbf{A}=\\begin{bmatrix}\nk_{Z_1} z_1  k_X x_1 \\\\\nk_{Z_1} z_2  k_X x_2 \\\\\n\\vdots  \\vdots \\\\\nk_{Z_1} z_N  k_X x_N\n\\end{bmatrix},\\quad\n\\mathbf{b}=-\\begin{bmatrix}\n\\Delta B(\\mathbf{r}_1) \\\\ \\Delta B(\\mathbf{r}_2) \\\\ \\vdots \\\\ \\Delta B(\\mathbf{r}_N)\n\\end{bmatrix}.\n$$\n我们寻求 $\\mathbf{I}=\\begin{bmatrix}I_{Z_1}\\\\I_X\\end{bmatrix}$ 来最小化 $\\left\\|\\mathbf{A}\\mathbf{I}-\\mathbf{b}\\right\\|_2$。当 $\\mathbf{A}$ 是满列秩时，解满足正规方程\n$$\n(\\mathbf{A}^\\top \\mathbf{A})\\mathbf{I}=\\mathbf{A}^\\top \\mathbf{b},\n$$\n从而得到\n$$\n\\mathbf{I}=(\\mathbf{A}^\\top \\mathbf{A})^{-1}\\mathbf{A}^\\top \\mathbf{b}.\n$$\n如果 $\\mathbf{A}$ 是秩亏的（例如，所有 $z_i=0$，因此 $Z_1$ 列为零），则最小范数解由 Moore–Penrose 伪逆给出，\n$$\n\\mathbf{I}=\\mathbf{A}^+\\mathbf{b},\n$$\n这可以通过奇异值分解等方法或返回最小范数解的专用最小二乘求解器来稳定地计算。\n\n一旦求得 $\\mathbf{I}$，残余磁场矢量为\n$$\n\\Delta \\mathbf{B}_{\\text{res}}=\\Delta \\mathbf{B}+\\mathbf{A}\\mathbf{I}.\n$$\n为了评估光谱域中的均匀性，通过以下公式将每个残余磁场转换为氢核的频率偏移：\n$$\nf_i=\\left(\\frac{\\gamma}{2\\pi}\\right)\\Delta B_{\\text{res},i},\\quad\\frac{\\gamma}{2\\pi}=42.577\\times 10^6\\ \\text{Hz/T}.\n$$\n均方根残余频率是\n$$\n\\text{RMS}=\\sqrt{\\frac{1}{N}\\sum_{i=1}^N f_i^2},\n$$\n而峰峰值展宽是\n$$\n\\text{P2P}=\\max_i f_i - \\min_i f_i.\n$$\n\n从算法上讲，对于每个测试用例，我们：\n- 使用提供的 $k_{Z_1}$、$k_X$ 和坐标构建 $\\mathbf{A}$。\n- 使用能够优雅处理秩亏情况并产生最小范数解的数值稳定的最小二乘求解器计算 $\\mathbf{I}$。\n- 构建 $\\Delta \\mathbf{B}_{\\text{res}}$ 并使用提供的质子旋磁比将其转换为频率偏移。\n- 计算以赫兹为单位的 $\\text{RMS}$ 和 $\\text{P2P}$。\n\n通过使用能够产生物理上合理的电流（对于一阶匀场，量级在几十毫安到几百毫安之间）的校准常数、将厘米转换为米的空间坐标以及以微特斯拉为单位的测量场偏，确保了科学真实性。测试套件探讨了不同的方面：一个同时具有 $z$ 和 $x$ 变化的良态网格、一个仅有 $x$ 变化（对 $Z_1$ 而言是秩亏的）的边界情况，以及一个带有离群值的不规则集合，以观察最小二乘残差的敏感性。输出格式将每个案例的电流和残余均匀性度量聚合成一个单行打印的列表之列表，可与程序的计算结果直接验证。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    # Proton gyromagnetic ratio in Hz/T\n    gamma_hz_per_t = 42.577e6\n\n    # Define the test cases from the problem statement.\n    # Each case: dict with keys: 'x', 'z', 'kz1', 'kx', 'dB'\n    test_cases = [\n        {\n            # Case A\n            \"x\": np.array([-0.02, 0.0, 0.02, -0.02, 0.0, 0.02, -0.02, 0.0, 0.02], dtype=float),\n            \"z\": np.array([-0.015, -0.015, -0.015, 0.0, 0.0, 0.0, 0.015, 0.015, 0.015], dtype=float),\n            \"kz1\": 5.0e-3,\n            \"kx\": 5.0e-3,\n            \"dB\": np.array([-1.0e-7, -1.85e-6, -3.32e-6, 1.53e-6, 0.0, -1.54e-6, 3.36e-6, 1.82e-6, 1.1e-7], dtype=float),\n        },\n        {\n            # Case B\n            \"x\": np.array([-0.02, -0.01, 0.0, 0.01, 0.02], dtype=float),\n            \"z\": np.array([0.0, 0.0, 0.0, 0.0, 0.0], dtype=float),\n            \"kz1\": 5.0e-3,\n            \"kx\": 4.0e-3,\n            \"dB\": np.array([-1.95e-6, -1.02e-6, 0.0, 1.03e-6, 1.96e-6], dtype=float),\n        },\n        {\n            # Case C\n            \"x\": np.array([-0.02, -0.015, -0.005, 0.0, 0.01, 0.015, 0.02, -0.01, 0.0, 0.015], dtype=float),\n            \"z\": np.array([-0.02, -0.01, 0.0, 0.01, 0.02, -0.015, 0.0, 0.02, -0.02, 0.015], dtype=float),\n            \"kz1\": 6.0e-3,\n            \"kx\": 4.0e-3,\n            \"dB\": np.array([0.85e-6, 0.12e-6, -0.24e-6, -0.88e-6, -1.32e-6, 2.90e-6, 0.95e-6, -2.26e-6, 1.74e-6, -0.60e-6], dtype=float),\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        x = case[\"x\"]\n        z = case[\"z\"]\n        kz1 = case[\"kz1\"]\n        kx = case[\"kx\"]\n        dB = case[\"dB\"]\n\n        # Construct design matrix A with columns [kz1 * z, kx * x]\n        A = np.column_stack((kz1 * z, kx * x))\n\n        # Target vector b = -dB\n        b = -dB\n\n        # Compute minimum-norm least-squares solution for currents [I_Z1, I_X]\n        # Using lstsq which handles rank-deficiency and returns the minimum-norm solution.\n        I, residuals, rank, s = np.linalg.lstsq(A, b, rcond=None)\n        I_z1, I_x = float(I[0]), float(I[1])\n\n        # Compute residual magnetic field after applying shim currents\n        dB_res = dB + A @ I  # vector of residuals in Tesla\n\n        # Convert residuals to frequency offsets (Hz)\n        f_res = gamma_hz_per_t * dB_res\n\n        # Compute RMS and Peak-to-Peak in Hz\n        rms_hz = float(np.sqrt(np.mean(f_res**2)))\n        p2p_hz = float(np.max(f_res) - np.min(f_res))\n\n        results.append([I_z1, I_x, rms_hz, p2p_hz])\n\n    # Final print statement in the exact required format.\n    # Print a single line: list of lists, each inner list has four floats.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}