{
    "hands_on_practices": [
        {
            "introduction": "The stability of the static magnetic field, $B_0$, is the bedrock of high-resolution NMR. This exercise delves into the core of this stability: the field-frequency lock system. You will derive, from first principles, the corrective action this crucial feedback loop must take to counteract the slow, inevitable drift of a superconducting magnet, ensuring the spectral frequencies remain constant over long experiments. ",
            "id": "3726292",
            "problem": "A high-field Nuclear Magnetic Resonance (NMR) spectrometer used for spectrometric identification of organic compounds employs a deuterium (${}^{2}\\mathrm{H}$) lock at $92\\ \\mathrm{MHz}$ to stabilize the static magnetic field. In a superconducting magnet, slow magnetic field drift arises from cryogen-related thermal changes and flux creep. The deuterium Larmor frequency obeys the relation $f = (\\gamma_{D}/2\\pi)\\,B_{0}$, where $\\gamma_{D}$ is the deuterium gyromagnetic ratio and $B_{0}$ is the static field. The lock controller uses the central uniform shim channel $Z_{0}$ to correct $B_{0}$; the $Z_{0}$ coil is characterized by a calibration constant $\\beta_{Z0}$ defined by $dB_{0} = \\beta_{Z0}\\,dI$, where $I$ is the applied $Z_{0}$ current.\n\nSuppose the lock channel reports a measured deuterium frequency drift rate $\\frac{df}{dt}$ (with the sign convention that a positive $\\frac{df}{dt}$ indicates increasing frequency). Over each minute, the controller applies a single $Z_{0}$ current correction to compensate the accumulated drift. Under the assumptions of linear drift within each minute and that the $Z_{0}$ field contribution is uniform over the sample volume, derive from first principles an analytic expression for the $Z_{0}$ current correction per minute, $\\Delta I$, that must be applied to keep the lock frequency within $\\pm 1\\ \\mathrm{Hz}$ of $92\\ \\mathrm{MHz}$. Express your final answer as a closed-form expression in terms of $\\frac{df}{dt}$, $\\gamma_{D}$, and $\\beta_{Z0}$. Indicate the sign of the correction relative to the sign of $\\frac{df}{dt}$. Use amperes per minute for the current correction. No numerical substitution is permitted; do not round. Your final answer must be a single analytical expression.",
            "solution": "The problem will first be validated for scientific soundness, consistency, and completeness before a solution is attempted.\n\n### Problem Validation\n\n**Step 1: Extract Givens**\n-   Deuterium (${}^{2}\\mathrm{H}$) lock target frequency: $f_{target} = 92\\ \\mathrm{MHz}$.\n-   Larmor frequency relation: $f = (\\gamma_{D}/2\\pi)\\,B_{0}$.\n-   Deuterium gyromagnetic ratio: $\\gamma_{D}$.\n-   Static magnetic field: $B_{0}$.\n-   $Z_{0}$ shim coil calibration constant: $\\beta_{Z0}$, defined by $dB_{0} = \\beta_{Z0}\\,dI$.\n-   $Z_{0}$ current: $I$.\n-   Measured frequency drift rate: $\\frac{df}{dt}$.\n-   Sign convention: A positive $\\frac{df}{dt}$ corresponds to an increasing frequency.\n-   Correction timing: A single correction is applied each minute.\n-   Assumption: Linear drift within each minute.\n-   Objective: Derive an expression for the \"current correction per minute, $\\Delta I$\".\n-   Constraint: The expression for $\\Delta I$ must be in terms of $\\frac{df}{dt}$, $\\gamma_{D}$, and $\\beta_{Z0}$.\n-   Operational Tolerance: The frequency must be kept within $\\pm 1\\ \\mathrm{Hz}$ of the target.\n-   Units: The result should represent \"amperes per minute\".\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is scientifically grounded, describing a standard field-frequency lock mechanism in an NMR spectrometer. The physical principles (Larmor equation) and components (shim coils, deuterium lock) are accurately represented.\n\nHowever, there is an ambiguity in the problem statement that must be resolved. The problem asks for a quantity designated as $\\Delta I$, which typically represents a finite change in current (units of Amperes). It also describes the correction process as a discrete step applied once per minute. A derivation for a discrete current step, $\\Delta I_{step}$, would necessarily depend on the time interval, $\\Delta t = 1\\ \\text{minute}$. This contradicts the explicit constraint that the final expression must only be in terms of $\\frac{df}{dt}$, $\\gamma_{D}$, and $\\beta_{Z0}$.\n\nSimultaneously, the problem requests the answer in \"amperes per minute,\" which is a unit of rate (current per time), not a change in current. This strongly suggests that the intended quantity is the *rate of change of current*, $\\frac{dI}{dt}$, required to continuously compensate for the drift. This interpretation resolves the contradictions:\n1.  Deriving a rate, $\\frac{dI}{dt}$, results in an expression that depends only on the specified variables.\n2.  A rate $\\frac{dI}{dt}$ has units of current per time, consistent with \"amperes per minute,\" provided the time variable in all derivatives is taken to be in minutes.\n\nThe description of a \"single current correction\" per minute is interpreted as a practical implementation of a fundamentally continuous correction model. The quantity to be derived is the ideal rate of current change. The notation \"$\\Delta I$\" is thus considered an imprecise symbol for the rate $\\frac{dI}{dt}$. The tolerance of $\\pm 1\\ \\mathrm{Hz}$ is contextual and does not enter the derivation for the ideal compensation, which aims for zero error.\n\n**Step 3: Verdict and Action**\nThe problem is deemed **valid**, contingent on the resolution of the ambiguity as described above. The solution will proceed by deriving the required rate of change of the shim current, $\\frac{dI}{dt}$, under the assumption that the time basis for all rates is minutes.\n\n### Derivation of the Current Correction Rate\n\nThe fundamental principle of a field-frequency lock is to maintain a constant Larmor frequency, which requires maintaining a constant static magnetic field, $B_{0}$. Any drift in the magnetic field must be actively canceled by a correcting field.\n\nLet the total magnetic field $B_{0}$ be the sum of a constant component, a time-dependent drift component $B_{drift}(t)$, and a time-dependent correction component $B_{corr}(t)$ generated by the $Z_{0}$ shim coil. For the lock to be stable, the total field must not change with time, so its time derivative must be zero:\n$$\n\\frac{dB_0}{dt} = \\frac{d}{dt} [B_{main} + B_{drift}(t) + B_{corr}(t)] = 0\n$$\nAs $B_{main}$ is constant, this simplifies to:\n$$\n\\frac{dB_{drift}}{dt} + \\frac{dB_{corr}}{dt} = 0 \\quad \\implies \\quad \\frac{dB_{corr}}{dt} = - \\frac{dB_{drift}}{dt}\n$$\nThis equation states that the rate of change of the correction field must be equal and opposite to the rate of change of the drift field.\n\nWe can relate these field drift rates to the given frequency drift rate, $\\frac{df}{dt}$. The Larmor equation is given as:\n$$\nf = \\frac{\\gamma_{D}}{2\\pi} B_{0}\n$$\nThe observed frequency drift rate, in the absence of correction, is due to the drift field. Differentiating the Larmor equation with respect to time $t$ gives the relationship between the frequency drift and the magnetic field drift:\n$$\n\\frac{df}{dt} = \\frac{\\gamma_{D}}{2\\pi} \\frac{dB_{drift}}{dt}\n$$\nWe can rearrange this to express the field drift rate in terms of the measurable frequency drift rate:\n$$\n\\frac{dB_{drift}}{dt} = \\frac{2\\pi}{\\gamma_{D}} \\frac{df}{dt}\n$$\nNext, we relate the correction field rate, $\\frac{dB_{corr}}{dt}$, to the rate of change of the shim current, $\\frac{dI}{dt}$. The problem provides the calibration constant $\\beta_{Z0}$ through the differential relation $dB_{0} = \\beta_{Z0}\\,dI$. For the correction field component generated by the shim, this implies a relationship between the rates of change:\n$$\n\\frac{dB_{corr}}{dt} = \\beta_{Z0} \\frac{dI}{dt}\n$$\nNow, we substitute the expressions for the field rates back into the stability condition $\\frac{dB_{corr}}{dt} = - \\frac{dB_{drift}}{dt}$:\n$$\n\\beta_{Z0} \\frac{dI}{dt} = - \\frac{2\\pi}{\\gamma_{D}} \\frac{df}{dt}\n$$\nSolving for the required rate of current correction, $\\frac{dI}{dt}$, we obtain:\n$$\n\\frac{dI}{dt} = - \\frac{2\\pi}{\\gamma_{D} \\beta_{Z0}} \\frac{df}{dt}\n$$\nThis expression represents the required continuous rate of change of the $Z_{0}$ current. Per the validation analysis, we interpret the prompt's request for the \"current correction per minute, $\\Delta I$\" to be this quantity, where the time derivatives are implicitly taken with respect to time measured in minutes. This ensures the units are \"amperes per minute\" and the expression depends only on the specified variables.\n\nThe sign of the correction is negative. If the frequency drift rate $\\frac{df}{dt}$ is positive (field is increasing), the rate of current change $\\frac{dI}{dt}$ must be negative to generate a decreasing counter-field (assuming $\\gamma_D$ and $\\beta_{Z0}$ are positive constants, which they are by convention). This is physically correct.",
            "answer": "$$\n\\boxed{-\\frac{2\\pi}{\\gamma_{D}\\beta_{Z0}}\\frac{df}{dt}}\n$$"
        },
        {
            "introduction": "Beyond temporal stability, achieving high resolution demands exceptional spatial homogeneity of the magnetic field across the sample. This practice puts you in control of the shimming process, the art of sculpting the magnetic field to iron out imperfections. Using a realistic field map, you will apply the method of least squares to calculate the optimal currents for a set of shim coils, providing a hands-on understanding of how modern spectrometers achieve exquisitely narrow linewidths. ",
            "id": "3726346",
            "problem": "A superconducting magnet used for Nuclear Magnetic Resonance (NMR) in spectrometric identification of organic compounds must have a highly homogeneous static magnetic field. Sample susceptibility and small installation imperfections introduce spatial variation in the static field that can be corrected by applying currents to shim coils. First-order shim coils generate fields proportional to Cartesian coordinates, commonly named $Z_1$ (proportional to $z$) and $X$ (proportional to $x$). Consider a measured static-field deviation map $\\Delta B(\\mathbf{r}_i)$ at discrete locations $\\mathbf{r}_i=(x_i,y_i,z_i)$, where the dominant components are $Z_1$ and $X$. The objective is to compute shim currents that minimize the residual inhomogeneity and then quantify the residual homogeneity after applying the computed shims, expressed as frequency offsets for the hydrogen nucleus.\n\nFundamental base and definitions:\n- The magnetic field superposition principle states that the total field is the sum of contributions from independent sources. If the shim coils produce fields proportional to $z$ and $x$ with calibration constants $k_{Z_1}$ and $k_X$ defined as field per ampere per meter, then the shim correction field at point $(x_i,y_i,z_i)$ is $\\Delta B_{\\text{shim}}(x_i,y_i,z_i) = k_{Z_1} I_{Z_1} z_i + k_X I_X x_i$, where $I_{Z_1}$ and $I_X$ are the applied currents in amperes.\n- The hydrogen nuclear Larmor frequency offset is related to the magnetic field by $f = \\left(\\gamma/2\\pi\\right) \\Delta B$, where $\\gamma/2\\pi = 42.577\\times 10^6$ Hz/T is the gyromagnetic ratio of the proton.\n- The residual field after shimming at each sample location is $\\Delta B_{\\text{res},i} = \\Delta B(\\mathbf{r}_i) + \\Delta B_{\\text{shim}}(\\mathbf{r}_i)$, and the squared-error objective to minimize is $\\sum_i \\left(\\Delta B_{\\text{res},i}\\right)^2 = \\sum_i \\left(\\Delta B(\\mathbf{r}_i) + k_{Z_1} I_{Z_1} z_i + k_X I_X x_i\\right)^2$.\n- The least-squares solution seeks currents $I_{Z_1}$ and $I_X$ that minimize the above sum. Because first-order shim fields are linear in $I_{Z_1}$ and $I_X$, the problem can be cast as a linear least-squares problem.\n\nYour task:\n- For each test case below, compute the two shim currents $I_{Z_1}$ and $I_X$ (in amperes) that minimize $\\sum_i \\left(\\Delta B(\\mathbf{r}_i) + k_{Z_1} I_{Z_1} z_i + k_X I_X x_i\\right)^2$ using a numerically stable method. If the system is rank-deficient, return the minimum-norm solution.\n- Using the computed currents, form the residual field list $\\{\\Delta B_{\\text{res},i}\\}$, convert it to frequency offsets in hertz using $f_i = \\left(\\gamma/2\\pi\\right) \\Delta B_{\\text{res},i}$ with $\\gamma/2\\pi = 42.577\\times 10^6$ Hz/T, and then compute:\n    - The root-mean-square of the residual frequency offsets, $\\text{RMS} = \\sqrt{\\frac{1}{N}\\sum_i f_i^2}$, expressed in hertz.\n    - The peak-to-peak residual frequency spread, $\\text{P2P} = \\max_i f_i - \\min_i f_i$, expressed in hertz.\n- Express all currents in amperes and all frequency quantities in hertz. Angles are not involved. Numerical answers must be floats.\n\nTest suite:\nCase A (happy path, two-dimensional grid, both $Z_1$ and $X$ observable):\n- Coordinates $(x_i,z_i)$ in meters with $y_i=0$:\n    - $(-0.02,-0.015),(0,-0.015),(0.02,-0.015),(-0.02,0),(0,0),(0.02,0),(-0.02,0.015),(0,0.015),(0.02,0.015)$, that is $x$ values $[-0.02,0,0.02]$ crossed with $z$ values $[-0.015,0,0.015]$.\n- Calibration constants (field per ampere per meter):\n    - $k_{Z_1} = 5.0\\times 10^{-3}$ T/(A·m), $k_X = 5.0\\times 10^{-3}$ T/(A·m).\n- Measured field map $\\Delta B$ in tesla at the above points (ordered as listed):\n    - $\\left[-1.0\\times 10^{-7}, -1.85\\times 10^{-6}, -3.32\\times 10^{-6}, 1.53\\times 10^{-6}, 0, -1.54\\times 10^{-6}, 3.36\\times 10^{-6}, 1.82\\times 10^{-6}, 1.1\\times 10^{-7}\\right]$.\n\nCase B (boundary, all $z_i=0$, only $X$ observable):\n- Coordinates $(x_i,z_i)$ in meters with $y_i=0$:\n    - $(-0.02,0),(-0.01,0),(0,0),(0.01,0),(0.02,0)$.\n- Calibration constants:\n    - $k_{Z_1} = 5.0\\times 10^{-3}$ T/(A·m), $k_X = 4.0\\times 10^{-3}$ T/(A·m).\n- Measured field map $\\Delta B$ in tesla at the above points (ordered as listed):\n    - $\\left[-1.95\\times 10^{-6}, -1.02\\times 10^{-6}, 0, 1.03\\times 10^{-6}, 1.96\\times 10^{-6}\\right]$.\n\nCase C (edge case with an outlier, irregular sampling):\n- Coordinates $(x_i,z_i)$ in meters with $y_i=0$:\n    - $(-0.02,-0.02),(-0.015,-0.01),(-0.005,0),(0,0.01),(0.01,0.02),(0.015,-0.015),(0.02,0),(-0.01,0.02),(0,-0.02),(0.015,0.015)$.\n- Calibration constants:\n    - $k_{Z_1} = 6.0\\times 10^{-3}$ T/(A·m), $k_X = 4.0\\times 10^{-3}$ T/(A·m).\n- Measured field map $\\Delta B$ in tesla at the above points (ordered as listed):\n    - $\\left[0.85\\times 10^{-6}, 0.12\\times 10^{-6}, -0.24\\times 10^{-6}, -0.88\\times 10^{-6}, -1.32\\times 10^{-6}, 2.90\\times 10^{-6}, 0.95\\times 10^{-6}, -2.26\\times 10^{-6}, 1.74\\times 10^{-6}, -0.60\\times 10^{-6}\\right]$.\n\nAlgorithmic specification:\n- For each case, construct the design matrix $\\mathbf{A}\\in\\mathbb{R}^{N\\times 2}$ with columns $\\left[k_{Z_1} z_i\\right]$ and $\\left[k_X x_i\\right]$. Let $\\mathbf{b}=-\\Delta \\mathbf{B}$.\n- Compute the minimum-norm least-squares solution $\\mathbf{I}=\\left[I_{Z_1},I_X\\right]^T$ that minimizes $\\|\\mathbf{A}\\mathbf{I}-\\mathbf{b}\\|_2$.\n- Compute the residual field $\\Delta \\mathbf{B}_{\\text{res}}=\\Delta \\mathbf{B}+\\mathbf{A}\\mathbf{I}$.\n- Convert residual field to frequency offsets using $f_i=\\left(\\gamma/2\\pi\\right)\\Delta B_{\\text{res},i}$ with $\\gamma/2\\pi=42.577\\times 10^6$ Hz/T, then compute $\\text{RMS}=\\sqrt{\\frac{1}{N}\\sum_i f_i^2}$ and $\\text{P2P}=\\max_i f_i-\\min_i f_i$.\n\nFinal output format:\n- Your program should produce a single line of output containing the results for all three cases as a comma-separated list enclosed in square brackets. Each case’s result must itself be a list of four floats in the order $[I_{Z_1}, I_X, \\text{RMS}, \\text{P2P}]$, where currents are in amperes and frequency metrics are in hertz. For example, the output must look like $[[i_{A,Z_1},i_{A,X},\\text{rms}_A,\\text{p2p}_A],[i_{B,Z_1},i_{B,X},\\text{rms}_B,\\text{p2p}_B],[i_{C,Z_1},i_{C,X},\\text{rms}_C,\\text{p2p}_C]]$ with actual numeric values replacing the symbols.",
            "solution": "The superconducting magnet’s static field nonuniformity is well described locally by a linear combination of spherical harmonics. The first-order harmonics $Z_1$ and $X$ correspond to fields proportional to $z$ and $x$, respectively. Because magnetic fields superpose linearly, the net residual field after applying shim currents is the sum of the measured deviation and the shim-generated correction. The fundamental basis for this problem is linear superposition and linear least-squares minimization.\n\nWe start with the measured offsets $\\Delta B(\\mathbf{r}_i)$ at positions $\\mathbf{r}_i=(x_i,y_i,z_i)$. First-order shim coils produce correction fields given by $\\Delta B_{\\text{shim}}(x_i,y_i,z_i)=k_{Z_1} I_{Z_1} z_i + k_X I_X x_i$, where $k_{Z_1}$ and $k_X$ are calibration constants converting current and spatial coordinate into magnetic field, and $I_{Z_1}$, $I_X$ are the currents to determine. The residual field at sample $i$ is then\n$$\n\\Delta B_{\\text{res},i}=\\Delta B(\\mathbf{r}_i)+k_{Z_1} I_{Z_1} z_i + k_X I_X x_i.\n$$\nTo find $I_{Z_1}$ and $I_X$, we minimize the sum of squared residuals\n$$\nS(I_{Z_1},I_X)=\\sum_{i=1}^N\\left(\\Delta B(\\mathbf{r}_i)+k_{Z_1} I_{Z_1} z_i + k_X I_X x_i\\right)^2.\n$$\nThis is a linear least-squares problem. Let the design matrix be\n$$\n\\mathbf{A}=\\begin{bmatrix}\nk_{Z_1} z_1  k_X x_1 \\\\\nk_{Z_1} z_2  k_X x_2 \\\\\n\\vdots  \\vdots \\\\\nk_{Z_1} z_N  k_X x_N\n\\end{bmatrix},\\quad\n\\mathbf{b}=-\\begin{bmatrix}\n\\Delta B(\\mathbf{r}_1) \\\\ \\Delta B(\\mathbf{r}_2) \\\\ \\vdots \\\\ \\Delta B(\\mathbf{r}_N)\n\\end{bmatrix}.\n$$\nWe seek $\\mathbf{I}=\\begin{bmatrix}I_{Z_1}\\\\I_X\\end{bmatrix}$ minimizing $\\left\\|\\mathbf{A}\\mathbf{I}-\\mathbf{b}\\right\\|_2$. When $\\mathbf{A}$ has full column rank, the solution satisfies the normal equations\n$$\n(\\mathbf{A}^\\top \\mathbf{A})\\mathbf{I}=\\mathbf{A}^\\top \\mathbf{b},\n$$\nleading to\n$$\n\\mathbf{I}=(\\mathbf{A}^\\top \\mathbf{A})^{-1}\\mathbf{A}^\\top \\mathbf{b}.\n$$\nIf $\\mathbf{A}$ is rank-deficient (e.g., all $z_i=0$ so the $Z_1$ column is zero), then the minimum-norm solution is given by the Moore–Penrose pseudo-inverse,\n$$\n\\mathbf{I}=\\mathbf{A}^+\\mathbf{b},\n$$\nwhich can be computed stably using methods such as Singular Value Decomposition or dedicated least-squares solvers that return the minimum-norm solution.\n\nOnce $\\mathbf{I}$ is obtained, the residual magnetic field vector is\n$$\n\\Delta \\mathbf{B}_{\\text{res}}=\\Delta \\mathbf{B}+\\mathbf{A}\\mathbf{I}.\n$$\nTo assess homogeneity in the spectroscopic domain, convert each residual field into a frequency offset for the hydrogen nucleus via\n$$\nf_i=\\left(\\frac{\\gamma}{2\\pi}\\right)\\Delta B_{\\text{res},i},\\quad\\frac{\\gamma}{2\\pi}=42.577\\times 10^6\\ \\text{Hz/T}.\n$$\nThe root-mean-square residual frequency is\n$$\n\\text{RMS}=\\sqrt{\\frac{1}{N}\\sum_{i=1}^N f_i^2},\n$$\nand the peak-to-peak spread is\n$$\n\\text{P2P}=\\max_i f_i - \\min_i f_i.\n$$\n\nAlgorithmically, for each test case we:\n- Construct $\\mathbf{A}$ using the provided $k_{Z_1}$, $k_X$, and coordinates.\n- Compute $\\mathbf{I}$ using a numerically stable least-squares solver that handles rank-deficiency gracefully, yielding minimum-norm solutions.\n- Form $\\Delta \\mathbf{B}_{\\text{res}}$ and convert to frequency offsets using the provided proton gyromagnetic ratio.\n- Compute $\\text{RMS}$ and $\\text{P2P}$ in hertz.\n\nScientific realism is ensured by using calibration constants that yield physically plausible currents (on the order of tens of milliamperes to a few hundred milliamperes for first-order shims), spatial coordinates in centimeters converted to meters, and measured field deviations in microtesla. The test suite probes distinct facets: a well-conditioned grid with both $z$ and $x$ variation, a boundary case with only $x$ variation (rank-deficient for $Z_1$), and an irregular set with an outlier to observe the sensitivity of least-squares residuals. The output format aggregates each case’s currents and residual homogeneity metrics into a single list of lists printed on one line, directly verifiable against the program’s computations.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    # Proton gyromagnetic ratio in Hz/T\n    gamma_hz_per_t = 42.577e6\n\n    # Define the test cases from the problem statement.\n    # Each case: dict with keys: 'x', 'z', 'kz1', 'kx', 'dB'\n    test_cases = [\n        {\n            # Case A\n            \"x\": np.array([-0.02, 0.0, 0.02, -0.02, 0.0, 0.02, -0.02, 0.0, 0.02], dtype=float),\n            \"z\": np.array([-0.015, -0.015, -0.015, 0.0, 0.0, 0.0, 0.015, 0.015, 0.015], dtype=float),\n            \"kz1\": 5.0e-3,\n            \"kx\": 5.0e-3,\n            \"dB\": np.array([-1.0e-7, -1.85e-6, -3.32e-6, 1.53e-6, 0.0, -1.54e-6, 3.36e-6, 1.82e-6, 1.1e-7], dtype=float),\n        },\n        {\n            # Case B\n            \"x\": np.array([-0.02, -0.01, 0.0, 0.01, 0.02], dtype=float),\n            \"z\": np.array([0.0, 0.0, 0.0, 0.0, 0.0], dtype=float),\n            \"kz1\": 5.0e-3,\n            \"kx\": 4.0e-3,\n            \"dB\": np.array([-1.95e-6, -1.02e-6, 0.0, 1.03e-6, 1.96e-6], dtype=float),\n        },\n        {\n            # Case C\n            \"x\": np.array([-0.02, -0.015, -0.005, 0.0, 0.01, 0.015, 0.02, -0.01, 0.0, 0.015], dtype=float),\n            \"z\": np.array([-0.02, -0.01, 0.0, 0.01, 0.02, -0.015, 0.0, 0.02, -0.02, 0.015], dtype=float),\n            \"kz1\": 6.0e-3,\n            \"kx\": 4.0e-3,\n            \"dB\": np.array([0.85e-6, 0.12e-6, -0.24e-6, -0.88e-6, -1.32e-6, 2.90e-6, 0.95e-6, -2.26e-6, 1.74e-6, -0.60e-6], dtype=float),\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        x = case[\"x\"]\n        z = case[\"z\"]\n        kz1 = case[\"kz1\"]\n        kx = case[\"kx\"]\n        dB = case[\"dB\"]\n\n        # Construct design matrix A with columns [kz1 * z, kx * x]\n        A = np.column_stack((kz1 * z, kx * x))\n\n        # Target vector b = -dB\n        b = -dB\n\n        # Compute minimum-norm least-squares solution for currents [I_Z1, I_X]\n        # Using lstsq which handles rank-deficiency and returns the minimum-norm solution.\n        I, residuals, rank, s = np.linalg.lstsq(A, b, rcond=None)\n        I_z1, I_x = float(I[0]), float(I[1])\n\n        # Compute residual magnetic field after applying shim currents\n        dB_res = dB + A @ I  # vector of residuals in Tesla\n\n        # Convert residuals to frequency offsets (Hz)\n        f_res = gamma_hz_per_t * dB_res\n\n        # Compute RMS and Peak-to-Peak in Hz\n        rms_hz = float(np.sqrt(np.mean(f_res**2)))\n        p2p_hz = float(np.max(f_res) - np.min(f_res))\n\n        results.append([I_z1, I_x, rms_hz, p2p_hz])\n\n    # Final print statement in the exact required format.\n    # Print a single line: list of lists, each inner list has four floats.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "The advent of cryogen-free magnets has introduced new considerations for field stability, primarily mechanical vibrations from cryocoolers. This final practice explores how these subtle vibrations can couple with residual magnetic field gradients to create dynamic field fluctuations, a source of line broadening. By modeling this phenomenon, you will quantify its impact on spectral quality, connecting a macroscopic mechanical effect to its spectroscopic consequence and gaining insight into a key performance limiter in modern NMR systems. ",
            "id": "3726332",
            "problem": "A cryogen-free superconducting magnet used for high-resolution Nuclear Magnetic Resonance (NMR) spectroscopy in the spectrometric identification of organic compounds operates at a static field $B_0$ sufficient to produce a nominal $^1\\mathrm{H}$ resonance near $600$ MHz. Cryocooler-induced vibrations couple to residual field inhomogeneity remaining after shimming and thus modulate the local static field at the sample. Let the dominant axial residual field gradient after shimming be $G_z = 0.25 \\ \\mu\\mathrm{T/mm}$, and let the axial displacement of the sample due to cryocooler harmonics be modeled as\n$$\nz(t) = A_1 \\cos\\!\\big(2\\pi f_1 t + \\phi_1\\big) + A_2 \\cos\\!\\big(2\\pi f_2 t + \\phi_2\\big),\n$$\nwith $A_1 = 12 \\ \\mu\\mathrm{m}$ at $f_1 = 1.5 \\ \\mathrm{Hz}$ and $A_2 = 5 \\ \\mu\\mathrm{m}$ at $f_2 = 3.0 \\ \\mathrm{Hz}$. The local field at the sample is then $B_z(t) = B_0 + G_z z(t)$, and the instantaneous $^1\\mathrm{H}$ Larmor frequency is $\\nu(t) = \\frac{\\gamma}{2\\pi} B_z(t)$, where the proton gyromagnetic ratio is $\\frac{\\gamma}{2\\pi} = 42.577 \\times 10^{6} \\ \\mathrm{Hz/T}$. \n\nAssume the field modulation is sufficiently small to justify linearization, and assume that due to cryocooler cycle fluctuations and microphonics the phases $\\phi_1$ and $\\phi_2$ sample uniformly over $[0,2\\pi)$ across the observation time, so that the resulting instantaneous frequency offsets can be treated as a zero-mean random variable with a well-defined variance. Starting from the Zeeman relation and the definition of a magnetic field gradient, derive a physically justified expression for the root-mean-square (RMS) frequency fluctuation caused by the vibrations, and then estimate the additional Full Width at Half Maximum (FWHM) linewidth broadening in the $^1\\mathrm{H}$ spectrum by modeling the frequency jitter as Gaussian-distributed. Round your final FWHM to three significant figures and express it in Hz.",
            "solution": "The problem asks for an estimation of the additional Full Width at Half Maximum (FWHM) linewidth broadening in a $^1\\mathrm{H}$ NMR spectrum due to cryocooler-induced vibrations. The derivation will proceed from the fundamental principles provided.\n\nFirst, we establish the relationship between the physical quantities. The instantaneous Larmor frequency $\\nu(t)$ is proportional to the local magnetic field experienced by the sample, $B_z(t)$. This is given by the Zeeman relation:\n$$\n\\nu(t) = \\frac{\\gamma}{2\\pi} B_z(t)\n$$\nwhere $\\frac{\\gamma}{2\\pi}$ is the proton gyromagnetic ratio.\n\nThe local field $B_z(t)$ is modulated by the mechanical vibration $z(t)$ within a residual magnetic field gradient $G_z$:\n$$\nB_z(t) = B_0 + G_z z(t)\n$$\nHere, $B_0$ is the static, homogeneous main magnetic field. Substituting this into the frequency expression gives:\n$$\n\\nu(t) = \\frac{\\gamma}{2\\pi} (B_0 + G_z z(t)) = \\frac{\\gamma}{2\\pi} B_0 + \\frac{\\gamma}{2\\pi} G_z z(t)\n$$\nThe first term, $\\nu_0 = \\frac{\\gamma}{2\\pi} B_0$, is the constant, unperturbed Larmor frequency, which is the center of the resonance line. The second term represents the instantaneous frequency fluctuation or offset, $\\Delta\\nu(t)$, due to the vibrations:\n$$\n\\Delta\\nu(t) = \\nu(t) - \\nu_0 = \\frac{\\gamma}{2\\pi} G_z z(t)\n$$\nThe problem provides the explicit form for the axial displacement $z(t)$ as a sum of two harmonic components:\n$$\nz(t) = A_1 \\cos(2\\pi f_1 t + \\phi_1) + A_2 \\cos(2\\pi f_2 t + \\phi_2)\n$$\nSubstituting this into the expression for $\\Delta\\nu(t)$:\n$$\n\\Delta\\nu(t) = \\frac{\\gamma}{2\\pi} G_z \\left[ A_1 \\cos(2\\pi f_1 t + \\phi_1) + A_2 \\cos(2\\pi f_2 t + \\phi_2) \\right]\n$$\nThe problem states that the phases $\\phi_1$ and $\\phi_2$ are random variables uniformly distributed over $[0, 2\\pi)$. This allows us to treat $\\Delta\\nu(t)$ as a zero-mean random variable. The line broadening is related to the variance of this frequency fluctuation, $\\sigma_\\nu^2 = \\langle (\\Delta\\nu(t))^2 \\rangle - \\left(\\langle \\Delta\\nu(t) \\rangle\\right)^2$, where $\\langle \\cdot \\rangle$ denotes the expectation value (average over the random phases).\n\nFirst, let's compute the mean fluctuation $\\langle \\Delta\\nu(t) \\rangle$:\n$$\n\\langle \\Delta\\nu(t) \\rangle = \\frac{\\gamma}{2\\pi} G_z \\left[ A_1 \\langle \\cos(2\\pi f_1 t + \\phi_1) \\rangle + A_2 \\langle \\cos(2\\pi f_2 t + \\phi_2) \\rangle \\right]\n$$\nSince $\\phi_1$ and $\\phi_2$ are uniformly distributed over $[0, 2\\pi)$, the average of any cosine function is zero.\n$$\n\\langle \\cos(2\\pi f t + \\phi) \\rangle = \\frac{1}{2\\pi} \\int_0^{2\\pi} \\cos(2\\pi f t + \\phi) d\\phi = 0\n$$\nThus, $\\langle \\Delta\\nu(t) \\rangle = 0$. This confirms the assertion that the frequency offsets constitute a zero-mean random variable.\n\nNext, we calculate the variance, $\\sigma_\\nu^2$, which for a zero-mean variable is equal to the mean-square value, $\\langle (\\Delta\\nu(t))^2 \\rangle$.\n$$\n\\sigma_\\nu^2 = \\left\\langle \\left( \\frac{\\gamma}{2\\pi} G_z \\left[ A_1 \\cos(2\\pi f_1 t + \\phi_1) + A_2 \\cos(2\\pi f_2 t + \\phi_2) \\right] \\right)^2 \\right\\rangle\n$$\n$$\n\\sigma_\\nu^2 = \\left( \\frac{\\gamma G_z}{2\\pi} \\right)^2 \\left\\langle \\left[ A_1^2 \\cos^2(\\theta_1) + A_2^2 \\cos^2(\\theta_2) + 2 A_1 A_2 \\cos(\\theta_1)\\cos(\\theta_2) \\right] \\right\\rangle\n$$\nwhere $\\theta_1 = 2\\pi f_1 t + \\phi_1$ and $\\theta_2 = 2\\pi f_2 t + \\phi_2$. By linearity of the expectation operator:\n$$\n\\sigma_\\nu^2 = \\left( \\frac{\\gamma G_z}{2\\pi} \\right)^2 \\left[ A_1^2 \\langle \\cos^2(\\theta_1) \\rangle + A_2^2 \\langle \\cos^2(\\theta_2) \\rangle + 2 A_1 A_2 \\langle \\cos(\\theta_1)\\cos(\\theta_2) \\rangle \\right]\n$$\nThe expectation value of $\\cos^2(\\theta)$ is $\\langle \\cos^2(\\theta) \\rangle = \\langle \\frac{1+\\cos(2\\theta)}{2} \\rangle = \\frac{1}{2} + \\frac{1}{2}\\langle \\cos(2\\theta) \\rangle = \\frac{1}{2}$.\nThe cross-term average is $\\langle \\cos(\\theta_1)\\cos(\\theta_2) \\rangle$. Since the phases $\\phi_1$ and $\\phi_2$ are independent, we can average over them independently. The average of $\\cos(\\theta_1)$ over $\\phi_1$ is zero, so the entire cross-term average is zero.\nSubstituting these results:\n$$\n\\sigma_\\nu^2 = \\left( \\frac{\\gamma G_z}{2\\pi} \\right)^2 \\left[ A_1^2 \\left(\\frac{1}{2}\\right) + A_2^2 \\left(\\frac{1}{2}\\right) + 0 \\right] = \\frac{1}{2} \\left( \\frac{\\gamma G_z}{2\\pi} \\right)^2 (A_1^2 + A_2^2)\n$$\nThe root-mean-square (RMS) frequency fluctuation is the square root of the variance, $\\nu_{RMS} = \\sigma_\\nu$.\n$$\n\\nu_{RMS} = \\sqrt{\\frac{1}{2} \\left( \\frac{\\gamma G_z}{2\\pi} \\right)^2 (A_1^2 + A_2^2)} = \\frac{1}{\\sqrt{2}} \\left| \\frac{\\gamma G_z}{2\\pi} \\right| \\sqrt{A_1^2 + A_2^2}\n$$\nThe problem states that the line broadening results from this frequency jitter being modeled as Gaussian-distributed. A Gaussian lineshape is described by $S(\\nu) \\propto \\exp(-(\\nu-\\nu_0)^2 / (2\\sigma_\\nu^2))$. The Full Width at Half Maximum (FWHM), denoted $\\Delta\\nu_{1/2}$, is related to the standard deviation $\\sigma_\\nu$ (which is $\\nu_{RMS}$ for our zero-mean distribution) by the well-known formula:\n$$\n\\Delta\\nu_{1/2} = 2\\sqrt{2 \\ln(2)} \\, \\sigma_\\nu = 2\\sqrt{2 \\ln(2)} \\, \\nu_{RMS}\n$$\nNow we perform the numerical calculation. First, we must ensure all units are in the SI base system.\nThe gyromagnetic ratio is $\\frac{\\gamma}{2\\pi} = 42.577 \\times 10^6 \\ \\mathrm{Hz/T}$.\nThe gradient is $G_z = 0.25 \\ \\mu\\mathrm{T/mm} = 0.25 \\times 10^{-6} \\ \\mathrm{T} / (10^{-3} \\ \\mathrm{m}) = 0.25 \\times 10^{-3} \\ \\mathrm{T/m}$.\nThe amplitudes are $A_1 = 12 \\ \\mu\\mathrm{m} = 12 \\times 10^{-6} \\ \\mathrm{m}$ and $A_2 = 5 \\ \\mu\\mathrm{m} = 5 \\times 10^{-6} \\ \\mathrm{m}$.\n\nWe calculate the term $\\sqrt{A_1^2 + A_2^2}$:\n$$\n\\sqrt{A_1^2 + A_2^2} = \\sqrt{(12 \\times 10^{-6})^2 + (5 \\times 10^{-6})^2} \\ \\mathrm{m} = \\sqrt{(144 + 25) \\times 10^{-12}} \\ \\mathrm{m} = \\sqrt{169 \\times 10^{-12}} \\ \\mathrm{m} = 13 \\times 10^{-6} \\ \\mathrm{m}\n$$\nNext, we calculate $\\nu_{RMS}$:\n$$\n\\nu_{RMS} = \\frac{1}{\\sqrt{2}} (42.577 \\times 10^6 \\ \\mathrm{Hz/T}) (0.25 \\times 10^{-3} \\ \\mathrm{T/m}) (13 \\times 10^{-6} \\ \\mathrm{m})\n$$\n$$\n\\nu_{RMS} = \\frac{1}{\\sqrt{2}} (10644.25 \\ \\mathrm{Hz/m}) (13 \\times 10^{-6} \\ \\mathrm{m}) = \\frac{1}{\\sqrt{2}} (0.13837525 \\ \\mathrm{Hz}) \\approx 0.097846 \\ \\mathrm{Hz}\n$$\nFinally, we calculate the FWHM linewidth broadening, $\\Delta\\nu_{1/2}$:\n$$\n\\Delta\\nu_{1/2} = 2\\sqrt{2 \\ln(2)} \\cdot \\nu_{RMS} \\approx 2.35482 \\times 0.097846 \\ \\mathrm{Hz} \\approx 0.23041 \\ \\mathrm{Hz}\n$$\nRounding the result to three significant figures as requested gives:\n$$\n\\Delta\\nu_{1/2} \\approx 0.230 \\ \\mathrm{Hz}\n$$",
            "answer": "$$\n\\boxed{0.230}\n$$"
        }
    ]
}