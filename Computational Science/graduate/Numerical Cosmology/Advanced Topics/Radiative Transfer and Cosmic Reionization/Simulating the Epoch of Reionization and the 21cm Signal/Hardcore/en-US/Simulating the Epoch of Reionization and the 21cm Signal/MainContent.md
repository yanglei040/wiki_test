## Introduction
Simulating the Epoch of Reionization (EoR) and its characteristic [21cm signal](@entry_id:159055) is a frontier of modern cosmology, offering a unique window into the [cosmic dawn](@entry_id:157658)—the era when the [first stars](@entry_id:158491) and galaxies formed and transformed the universe from a neutral, dark state to the ionized, transparent cosmos we see today. This pivotal transition remains one of the least observed periods in cosmic history, creating a significant knowledge gap between the well-understood Cosmic Microwave Background and the more recent universe. Bridging this gap requires sophisticated numerical simulations that can connect fundamental physical theories to the faint signals sought by next-generation radio telescopes.

This article provides a graduate-level guide to the theory and practice of these simulations. The first chapter, **"Principles and Mechanisms,"** will lay the theoretical groundwork, exploring the physics of the 21cm hyperfine transition, the thermal and ionization dynamics of the [intergalactic medium](@entry_id:157642), and the [numerical algorithms](@entry_id:752770) used to model them. Following this, the **"Applications and Interdisciplinary Connections"** chapter will demonstrate how these principles are put into practice to model the first galaxies, create realistic mock observations, and connect with other [cosmological probes](@entry_id:160927). Finally, **"Hands-On Practices"** will offer concrete computational exercises to solidify the core concepts discussed. Together, these sections will equip you with the foundational knowledge needed to understand and contribute to the exciting field of [21cm cosmology](@entry_id:157922).

## Principles and Mechanisms

### The 21cm Signal: Physics of the Hyperfine Transition

The ability to probe the Epoch of Reionization (EoR) and the Cosmic Dawn rests upon a subtle quantum mechanical transition within [neutral hydrogen](@entry_id:174271) (HI), the most abundant element in the early universe. The ground state of the hydrogen atom exhibits **[hyperfine structure](@entry_id:158349)** due to the interaction between the magnetic moments of the proton and the electron. This interaction splits the ground state into two very closely spaced energy levels: a higher-energy [triplet state](@entry_id:156705) where the spins of the proton and electron are parallel, and a lower-energy [singlet state](@entry_id:154728) where they are anti-parallel. The transition between these states corresponds to a photon with a rest-frame wavelength of approximately $21.1\,\mathrm{cm}$ and a frequency of $\nu_{21} \approx 1420\,\mathrm{MHz}$.

The relative population of these two levels can be described by a characteristic temperature known as the **[spin temperature](@entry_id:159112)**, $T_S$. For a two-level system, $T_S$ is formally defined as the temperature that satisfies the Boltzmann distribution for the observed ratio of number densities of the upper (triplet, $n_1$) and lower (singlet, $n_0$) states:

$$
\frac{n_1}{n_0} = \frac{g_1}{g_0} \exp\left(-\frac{\Delta E}{k_B T_S}\right)
$$

Here, $g_1=3$ and $g_0=1$ are the statistical weights (degeneracies) of the triplet and singlet states, respectively. $\Delta E = h \nu_{21}$ is the energy difference between the levels, and $k_B$ is the Boltzmann constant. It is often convenient to define an equivalent temperature for this transition, $T_\star \equiv \Delta E / k_B \approx 0.068\,\mathrm{K}$ . Thus, the population ratio is given by $n_1/n_0 = 3 \exp(-T_\star/T_S)$.

The [spin temperature](@entry_id:159112) is not a true [thermodynamic temperature](@entry_id:755917) in the same vein as the gas [kinetic temperature](@entry_id:751035). Rather, it is a parameter that quantifies the excitation state of the neutral hydrogen gas. Its value is determined by a competition between three fundamental processes that couple the hyperfine levels to two distinct thermal baths: the ambient gas and the Cosmic Microwave Background (CMB).

1.  **Radiative Coupling to the CMB:** Neutral hydrogen atoms constantly interact with photons from the CMB. Absorption of CMB photons at frequency $\nu_{21}$ excites atoms from the singlet to the [triplet state](@entry_id:156705), while [spontaneous and stimulated emission](@entry_id:148009) cause transitions from the triplet to the singlet state. These processes collectively attempt to drive the level populations into thermal equilibrium with the CMB [radiation field](@entry_id:164265). If radiative coupling were the only process, the population ratio would be dictated by the CMB temperature, $T_\gamma(z) = T_0(1+z)$, leading to $T_S = T_\gamma$.

2.  **Collisional Coupling to the Gas:** Collisions between hydrogen atoms (as well as with free electrons and protons) can also induce transitions between the hyperfine states. During these collisions, kinetic energy is exchanged with the internal energy of the atoms. This process attempts to thermalize the level populations with the kinetic motion of the gas. If collisions were dominant, the [spin temperature](@entry_id:159112) would be driven to match the gas [kinetic temperature](@entry_id:751035), $T_K$, so that $T_S = T_K$.

3.  **Lyman-alpha (Ly$\alpha$) Coupling (the Wouthuysen-Field Effect):** A third, and often dominant, coupling mechanism is the [resonant scattering](@entry_id:185638) of Ly$\alpha$ photons. When a hydrogen atom absorbs a Ly$\alpha$ photon, it is excited to the $n=2$ electronic state. The subsequent radiative cascade back to the ground state can flip the relative spin orientation of the electron and proton, effectively mixing the hyperfine levels. Because the incoming Ly$\alpha$ photons have a [spectral distribution](@entry_id:158779) shaped by scattering within the gas, this process efficiently couples the [spin temperature](@entry_id:159112) to the gas [kinetic temperature](@entry_id:751035), $T_S \to T_K$. This **Wouthuysen-Field (WF) effect** becomes significant with the formation of the [first stars](@entry_id:158491), which produce the requisite UV and Ly$\alpha$ radiation.

The [spin temperature](@entry_id:159112) can thus be expressed as a weighted average of the kinetic and CMB temperatures:
$$ T_S = \frac{T_\gamma + (x_c + x_\alpha) T_K}{1 + x_c + x_\alpha} $$
where $x_c$ and $x_\alpha$ are dimensionless coupling coefficients representing the strength of collisional and Ly$\alpha$ coupling, respectively, relative to the radiative coupling to the CMB.

To appreciate the relative importance of these mechanisms, consider the collisional [coupling coefficient](@entry_id:273384), $x_c$. Through a detailed balance analysis, it can be shown to be related to the total collisional de-excitation rate, $C_{10}$, and the Einstein coefficient for [spontaneous emission](@entry_id:140032), $A_{10} = 2.85 \times 10^{-15}\,\mathrm{s}^{-1}$ . In the relevant regime where $T_\star \ll T_\gamma$, the coefficient is approximately $x_c \approx \frac{C_{10} T_\star}{A_{10} T_\gamma}$. As a concrete example , at a [redshift](@entry_id:159945) of $z=20$, the CMB temperature is $T_\gamma(20) = 2.725 \times 21 \approx 57.2\,\mathrm{K}$. For a typical IGM environment with [kinetic temperature](@entry_id:751035) $T_K=9\,\mathrm{K}$ and a residual free [electron fraction](@entry_id:159166) of $x_e=2\times 10^{-4}$, the total collisional de-excitation rate is dominated by H-H collisions and evaluates to $C_{10} \approx 5.3 \times 10^{-14}\,\mathrm{s}^{-1}$. This yields a collisional [coupling coefficient](@entry_id:273384) of $x_c \approx 0.022$. Since $x_c \ll 1$, collisions are highly inefficient at this epoch. The [spin temperature](@entry_id:159112) remains tightly coupled to the CMB, i.e., $T_S \approx T_\gamma$, and only a very strong Ly$\alpha$ flux (large $x_\alpha$) can decouple them and imprint the gas [kinetic temperature](@entry_id:751035) onto the [21cm signal](@entry_id:159055).

### The 21cm Differential Brightness Temperature

The 21cm line is observed as a differential [brightness temperature](@entry_id:261159), $\delta T_b$, which measures the intensity contrast between the neutral hydrogen gas and the CMB backlight. From the equation of [radiative transfer](@entry_id:158448), for a patch of gas with [spin temperature](@entry_id:159112) $T_S$ and [optical depth](@entry_id:159017) $\tau_{21}$ seen against the CMB with temperature $T_\gamma$, the observed differential [brightness temperature](@entry_id:261159) is:
$$ \delta T_b = (T_S - T_\gamma)(1 - e^{-\tau_{21}}) $$
During the EoR, the IGM is largely optically thin to 21cm radiation, meaning $\tau_{21} \ll 1$. In this limit, we can use the approximation $1 - e^{-\tau_{21}} \approx \tau_{21}$, which simplifies the expression to:
$$ \delta T_b \approx \tau_{21} (T_S - T_\gamma) $$
Since the optical depth $\tau_{21}$ is always a positive quantity, the sign of the [21cm signal](@entry_id:159055) is determined entirely by the difference between the [spin temperature](@entry_id:159112) and the CMB temperature :
-   **Emission ($\delta T_b > 0$):** If $T_S > T_\gamma$, the gas is "brighter" than the CMB background. This occurs when the gas is efficiently heated (e.g., by X-rays) such that $T_K > T_\gamma$, and a strong coupling mechanism (like the WF effect) ensures $T_S \approx T_K$.
-   **Absorption ($\delta T_b  0$):** If $T_S  T_\gamma$, the gas appears as an absorption feature against the CMB. This is expected early in the Cosmic Dawn, when [adiabatic expansion](@entry_id:144584) has cooled the gas to $T_K  T_\gamma$, and the first Ly$\alpha$ photons couple $T_S$ to $T_K$.
-   **No Signal ($\delta T_b = 0$):** If $T_S = T_\gamma$, the gas is in [radiative equilibrium](@entry_id:158473) with the CMB and is therefore invisible. This happens at very high redshifts before the first sources form, and again at the moment when heating raises $T_K$ to be equal to $T_\gamma$.

The full cosmological expression for the sky-averaged differential [brightness temperature](@entry_id:261159), observed today from redshift $z$, accounts for the [number density](@entry_id:268986) of [neutral hydrogen](@entry_id:174271), the [cosmological expansion](@entry_id:161458), and the fundamental atomic physics. A standard derivation  gives:
$$ \overline{\delta T}_b(z) \approx 27 \, \bar{x}_{\mathrm{HI}}(z) \sqrt{\frac{1+z}{10}} \left(1 - \frac{T_\gamma(z)}{T_S(z)}\right) \, \mathrm{mK} $$
where $\bar{x}_{\mathrm{HI}}(z)$ is the sky-averaged neutral fraction. This equation beautifully encapsulates the three key factors that govern the global [21cm signal](@entry_id:159055): the amount of neutral hydrogen (astrophysics), the coupling of temperatures ([atomic physics](@entry_id:140823)), and the underlying cosmology.

This leads to a canonical timeline for the global [21cm signal](@entry_id:159055):
1.  **The Dark Ages ($z \gtrsim 30$):** Before the [first stars](@entry_id:158491), the gas cools adiabatically. Collisional coupling becomes ineffective as density drops, leaving $T_S \approx T_\gamma$. The signal is nearly zero.
2.  **Cosmic Dawn ($z \sim 15-25$):** The first stars ignite, bathing the IGM in Ly$\alpha$ photons. The WF effect becomes active, efficiently coupling $T_S$ to $T_K$. Since $T_K  T_\gamma$ at this time, this drives $T_S  T_\gamma$, creating a characteristic absorption trough in the global signal.
3.  **Epoch of X-ray Heating ($z \sim 12-20$):** The first stellar remnants (X-ray binaries, black holes) produce a background of hard X-rays that heat the IGM over large volumes. As $T_K$ rises past $T_\gamma$, the [21cm signal](@entry_id:159055) transitions from absorption to emission. For a period, the IGM is visible in 21cm emission.
4.  **Epoch of Reionization ($z \sim 6-12$):** A burgeoning population of galaxies produces enough ionizing photons to create large bubbles of ionized gas (HII regions) that grow and overlap. As the neutral fraction $\bar{x}_{\mathrm{HI}}$ plummets towards zero, the [21cm signal](@entry_id:159055) strength diminishes, eventually disappearing by the end of [reionization](@entry_id:158356).

### The Engine of Reionization: Thermal and Ionization Evolution

Simulating the EoR requires tracking the coupled evolution of the [ionization](@entry_id:136315) state and thermal state of the [intergalactic medium](@entry_id:157642) (IGM). For a uniform patch of gas, this is governed by a set of coupled ordinary differential equations that balance the key physical processes .

The evolution of the mean ionized fraction, $x_e$, is governed by the competition between [photoionization](@entry_id:157870) and recombination:
$$ \frac{d x_e}{d t} = \Gamma_{\mathrm{HI}}(1 - x_e) - C\,\alpha_B(T_K)\,n_{\mathrm{H}}\,x_e^2 $$
The first term represents the [ionization](@entry_id:136315) of [neutral hydrogen](@entry_id:174271) (fraction $1-x_e$) by the ionizing photon background, with a rate per atom of $\Gamma_{\mathrm{HI}}$. The second term describes the recombination of free electrons and protons (density $n_e = n_p = x_e n_H$), with a case-B recombination coefficient $\alpha_B(T_K)$ that is weakly dependent on temperature.

Crucially, the [recombination rate](@entry_id:203271) is quadratic in density. This means that unresolved density fluctuations within a simulation cell can significantly boost the mean recombination rate. This effect is captured by the **[clumping factor](@entry_id:747398)**, $C \equiv \frac{\langle n_e^2 \rangle}{\langle n_e \rangle^2}$ . By Jensen's inequality, $C \ge 1$ for any inhomogeneous medium. If the subgrid density distribution is modeled, for instance, by a lognormal PDF with variance $\sigma_s^2$, the [clumping factor](@entry_id:747398) becomes $C = \exp(\sigma_s^2)$. Since coarser simulation grids leave more small-scale density variance unresolved (larger $\sigma_s^2$), the required subgrid [clumping factor](@entry_id:747398) increases with cell size. Prescribing a constant, resolution-independent $C$ can lead to spurious numerical artifacts in simulation results .

The evolution of the gas [kinetic temperature](@entry_id:751035), $T_K$, is governed by a balance of cosmic expansion and various heating and cooling processes:
$$ \frac{d T_K}{d t} = -2H T_K + \frac{8 \sigma_T a_R T_\gamma^4}{3 m_e c} \frac{x_e}{1 + f_{\mathrm{He}} + x_e} (T_\gamma - T_K) + \frac{2}{3 k_B} \frac{\epsilon_X}{n_{\mathrm{tot}}} $$
Here, the first term represents adiabatic cooling due to the Hubble expansion ($H(z)$ is the Hubble parameter). The second term describes **Compton scattering**, where free electrons (fraction $x_e$ of all particles) exchange energy with CMB photons, either heating or cooling the gas towards $T_\gamma$. The final term represents the net heating rate per particle from external sources, primarily X-rays, where $\epsilon_X$ is the volumetric heating rate and $n_{\text{tot}} = n_H(1+f_{\text{He}}+x_e)$ is the total number density of particles (H, He nuclei, and electrons) . Together, these equations form the backbone of semi-numerical and one-zone models of [reionization](@entry_id:158356).

### The Morphology of Reionization: From Strömgren Spheres to Cosmic Percolation

Reionization is not a uniform process. It proceeds through the formation and growth of ionized bubbles (HII regions) around sources of [ionizing radiation](@entry_id:149143). The simplest model for such a region is the idealized **Strömgren sphere**. For a source emitting ionizing photons at a constant rate $Q$ into a static, uniform hydrogen gas of density $n_H$, the growth of the ionized volume $V_I$ is governed by photon conservation: the source photons must both ionize new gas at the expanding front and compensate for recombinations within the already ionized volume. This leads to the differential equation :
$$ Q = n_H \frac{dV_I}{dt} + \alpha_B n_H^2 V_I $$
The solution shows that the ionized radius $R_I(t)$ initially grows rapidly and then asymptotically approaches the static **Strömgren radius**, $R_S = \left(\frac{3Q}{4\pi \alpha_B n_H^2}\right)^{1/3}$, at which point recombinations inside the bubble exactly balance the source's photon output.

In a cosmological context, the IGM is not uniform, and sources are clustered. Reionization proceeds by the growth and eventual overlap of these individual HII regions. The global completion of [reionization](@entry_id:158356) can be viewed as a [geometric phase](@entry_id:138449) transition, a problem well-suited to the language of **[percolation theory](@entry_id:145116)** . In a simplified lattice model, one can ask: what is the critical ionized fraction, $x_{i, \text{crit}}$, at which an "infinite" ionized cluster first appears, connecting one side of the universe to the other? Using a [mean-field approximation](@entry_id:144121) (equivalent to a branching process on a Bethe lattice), one finds that [percolation](@entry_id:158786) occurs when the average number of newly connected ionized neighbors for any given ionized cell reaches one. If we introduce a more physical connection criterion, where the bond between two cells is traversable only if the [optical depth](@entry_id:159017) across their interface is below a threshold $\tau_c$, the critical ionized fraction becomes a function of the lattice connectivity and the optical depth distribution. For a cubic lattice ($z=6$) and an exponential distribution of optical depths, this threshold is $x_{i,\text{crit}} = \frac{1}{5(1 - \exp(-\tau_c/\bar{\tau}))}$ . This illustrates how the "overlap" phase is sensitive to both the [filling factor](@entry_id:146022) and the [opacity](@entry_id:160442) of the intervening medium.

The clustering of galaxies in overdense regions of the [cosmic web](@entry_id:162042) leads to the standard **inside-out** model of [reionization](@entry_id:158356), where dense regions ionize first and expand into the surrounding voids. However, alternative **outside-in** scenarios, where voids ionize first, are also physically plausible under certain assumptions (e.g., if dense regions are self-shielding). These different topologies leave distinct imprints on the statistical properties of the [21cm signal](@entry_id:159055). A powerful diagnostic is the cross-[power spectrum](@entry_id:159996) between the neutral fraction fluctuation field, $\delta_x$, and the neutral gas temperature fluctuation field, $\delta_T$ .
- In an **inside-out** scenario, overdense regions are hotter (more sources, $\delta_T > 0$) but also more ionized (lower neutral fraction, $\delta_x  0$). This creates an anti-correlation, leading to a negative cross-power spectrum, $P_{xT}(k)  0$.
- In an **outside-in** scenario, overdense regions are still hotter ($\delta_T > 0$), but now they are also more neutral ($\delta_x > 0$). This creates a positive correlation, leading to a positive cross-power spectrum, $P_{xT}(k) > 0$.
Thus, the sign of the large-scale 21cm-temperature [cross-correlation](@entry_id:143353) is a direct probe of the [reionization](@entry_id:158356) topology.

### Numerical Techniques for Simulating Reionization

Accurately simulating the process of [reionization](@entry_id:158356) is a formidable computational challenge, dominated by the need to solve the equation of radiative transfer (RT) for ionizing photons. A variety of approximations and algorithms have been developed, each with its own trade-offs between accuracy and computational cost.

A first step is to assess the validity of common physical approximations . The **optically thin approximation** ($\tau_\nu \ll 1$) is often used. To test this, consider a simulation cell of size $L_{\mathrm{phys}} \approx 56\,\mathrm{kpc}$ at $z=8$.
- In the neutral IGM ($x_{\mathrm{HI}} \approx 1$), the optical depth to ionizing photons across the cell is $\tau_\nu = n_{\mathrm{HI}} \sigma_\nu L_{\mathrm{phys}} \approx 160$. This is extremely optically thick, and the approximation fails catastrophically.
- Inside a highly ionized bubble ($x_{\mathrm{HI}} = 10^{-4}$), the optical depth is $\tau_\nu \approx 0.016 \ll 1$. Here, the optically thin approximation is excellent for describing the transport of photons from a source across the cell.

Another common simplification is the **on-the-spot (OTS) approximation**, which assumes that photons produced by recombinations to the ground state are reabsorbed locally. The validity of OTS requires the [photon mean free path](@entry_id:753417), $\ell_\nu = 1/(n_{\mathrm{HI}} \sigma_\nu)$, to be short. In the same highly ionized bubble ($x_{\mathrm{HI}} = 10^{-4}$), the mean free path is $\ell_\nu \approx 3.4\,\mathrm{Mpc}$. This is vastly larger than the cell size, meaning recombination photons travel cosmologically significant distances before being reabsorbed. Therefore, the OTS approximation is invalid in the low-density, ionized IGM .

Given these constraints, a full RT solver is necessary. The main families of algorithms are :

-   **Ray-Tracing Methods:** These methods directly integrate the RT equation along characteristics (rays).
    -   **Long-characteristics (LC):** Trace rays from each source to every cell in the domain. This is extremely accurate and provides the sharpest geometric shadows, but its computational cost scales linearly with the number of sources, $\mathcal{O}(N_{\rm src})$, making it prohibitively expensive for simulations with many thousands of galaxies.
    -   **Short-characteristics (SC):** Integrate cell-by-cell, interpolating the intensity from upwind neighbors. This is a field-based method whose cost is independent of the number of sources, but the interpolation step introduces numerical diffusion, which can smear sharp shadow boundaries.

-   **Moment Methods (e.g., M1 Closure):** These methods do not solve for the full angular dependence of the [radiation field](@entry_id:164265), but instead evolve its low-order angular moments (energy density and flux). The system is closed with an approximate local relation for the radiation pressure tensor. This makes the method very fast and independent of the number of sources. However, its fundamental limitation is an inability to correctly handle crossing beams of light from multiple sources, which leads to unphysical merging and washing out of shadows.

-   **Monte Carlo (MC) Methods:** These methods track the stochastic paths of a large number of discrete photon packets. MC methods are exceptionally accurate, free from the numerical diffusion of SC and the closure problems of moment methods. They can produce arbitrarily sharp shadows and correctly handle any geometric complexity. The primary drawback is computational cost: to maintain a fixed signal-to-noise ratio for each source, the cost scales linearly with the number of sources, $\mathcal{O}(N_{\rm src})$.

The choice of RT algorithm for an EoR simulation thus represents a critical compromise between the physical fidelity required to capture the essential [morphology](@entry_id:273085) of [reionization](@entry_id:158356) and the computational resources available.