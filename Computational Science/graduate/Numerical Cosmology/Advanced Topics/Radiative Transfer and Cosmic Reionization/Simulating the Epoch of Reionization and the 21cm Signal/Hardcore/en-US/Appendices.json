{
    "hands_on_practices": [
        {
            "introduction": "The 21cm brightness temperature is not merely a map of neutral hydrogen; its observability is governed by the spin temperature, $T_S$. This exercise explores the core physics of spin temperature coupling, where $T_S$ is determined by a competition between radiative coupling to the CMB, collisional coupling to the gas, and Lyman-$\\alpha$ pumping (the Wouthuysen-Field effect). By systematically activating and deactivating these coupling mechanisms in a controlled numerical experiment , you will gain crucial insight into how the microphysics of hydrogen translates directly into the amplitude and character of the observable 21cm power spectrum.",
            "id": "3488955",
            "problem": "You are asked to design and implement a minimal, self-consistent numerical experiment to assess the sensitivity of the three-dimensional 21 centimeter brightness temperature power spectrum to different spin temperature coupling prescriptions during the epoch of reionization. The study is limited to a toy model that is scientifically plausible, isolates the effect of spin temperature coupling, and is explicitly testable.\n\nFundamental base and definitions:\n- The 21 centimeter differential brightness temperature is modeled as $T_{\\mathrm{b}}(\\mathbf{x}) \\approx 27\\,\\mathrm{mK}\\,x_{\\mathrm{HI}}(\\mathbf{x})\\left[1+\\delta(\\mathbf{x})\\right]\\left(1 - \\frac{T_{\\gamma}}{T_{\\mathrm{S}}(\\mathbf{x})}\\right)\\sqrt{\\frac{1+z}{10}}$, where $x_{\\mathrm{HI}}(\\mathbf{x})$ is the neutral hydrogen fraction, $\\delta(\\mathbf{x})$ is the matter overdensity, $T_{\\gamma}$ is the Cosmic Microwave Background (CMB) temperature, $T_{\\mathrm{S}}(\\mathbf{x})$ is the spin temperature, and $z$ is redshift.\n- The spin temperature coupling is given by the Wouthuysen-Field relation, $T_{\\mathrm{S}}^{-1} = \\dfrac{T_{\\gamma}^{-1} + x_{c}\\,T_{\\mathrm{K}}^{-1} + x_{\\alpha}\\,T_{\\alpha}^{-1}}{1 + x_{c} + x_{\\alpha}}$, where $x_{c}$ is the collisional coupling coefficient, $x_{\\alpha}$ is the Lyman-Alpha (Ly$\\alpha$) coupling coefficient, $T_{\\mathrm{K}}$ is the kinetic temperature of the gas, and $T_{\\alpha}$ is the Ly$\\alpha$ color temperature. Assume $T_{\\alpha} = T_{\\mathrm{K}}$.\n- The three-dimensional power spectrum $P_{21}(k)$ of the brightness temperature fluctuations is defined by the Fourier transform convention of the Fast Fourier Transform (FFT) used in discrete periodic boxes, and operationally estimated by binning $|\\tilde{\\Delta}_{21}(\\mathbf{k})|^{2}$ into spherical $k$-shells and dividing by the box volume, where $\\Delta_{21}(\\mathbf{x}) \\equiv T_{\\mathrm{b}}(\\mathbf{x}) - \\langle T_{\\mathrm{b}}\\rangle$.\n\nPhysical and numerical setup:\n- Domain: a periodic cube of comoving side length $L = 200\\,\\mathrm{Mpc}\\,h^{-1}$ uniformly discretized into $N = 32$ cells along each dimension.\n- Redshift: $z = 10$, so $T_{\\gamma} = 2.725\\,(1+z)\\,\\mathrm{K}$.\n- Neutral fraction: choose a spatially uniform value $x_{\\mathrm{HI}}(\\mathbf{x}) = 1$ to isolate spin temperature effects.\n- Kinetic temperature: choose a spatially uniform value $T_{\\mathrm{K}} = 5\\,\\mathrm{K}$ and set $T_{\\alpha} = T_{\\mathrm{K}}$.\n- Coupling coefficients when “on”: $x_{c,\\mathrm{on}} = 0.1$ and $x_{\\alpha,\\mathrm{on}} = 2.0$. When a coupling is “off,” set it to zero.\n- Overdensity field: construct a statistically homogeneous and isotropic Gaussian random overdensity field $\\delta(\\mathbf{x})$ by:\n  1. Sampling a zero-mean, unit-variance Gaussian white noise field on the grid in real space.\n  2. Transforming to Fourier space and applying a spherically symmetric transfer function $T(k) = \\left(\\dfrac{k}{k_{0}}\\right)^{n/2}\\exp\\left[-\\dfrac{1}{2}\\left(\\dfrac{k}{k_{c}}\\right)^{2}\\right]$ to shape the field, with $n = -2.5$, $k_{0} = 0.1\\,h\\,\\mathrm{Mpc}^{-1}$, and $k_{c} = 0.8\\,h\\,\\mathrm{Mpc}^{-1}$, and setting the zero mode to zero. Then inverse transform to real space and subtract any residual mean to ensure $\\langle \\delta\\rangle = 0$.\n\nTarget quantity:\n- For each spin temperature coupling prescription, compute the binned $P_{21}(k)$ by:\n  1. Building $T_{\\mathrm{b}}(\\mathbf{x})$ in milliKelvin using the formula above with $x_{\\mathrm{HI}}=1$ and the chosen $T_{\\mathrm{S}}$ prescription.\n  2. Subtracting the spatial mean to obtain $\\Delta_{21}(\\mathbf{x})$.\n  3. Computing the Fourier transform and binning $|\\tilde{\\Delta}_{21}(\\mathbf{k})|^{2}$ into spherical shells in $k$-space of width $\\Delta k$, and dividing by the box volume $L^{3}$ to obtain an estimate of $P_{21}(k)$ in $\\mathrm{mK}^{2}\\,(\\mathrm{Mpc}\\,h^{-1})^{3}$.\n- Use three disjoint $k$-bins centered at $k \\in \\{0.1,\\,0.3,\\,0.5\\}\\,h\\,\\mathrm{Mpc}^{-1}$, each with half-width $\\Delta k/2 = 0.05\\,h\\,\\mathrm{Mpc}^{-1}$; that is, bins $[0.05,0.15)$, $[0.25,0.35)$, and $[0.45,0.55)$.\n\nSpin temperature test suite:\n- Evaluate four coupling prescriptions by “toggling” $x_{c}$ and $x_{\\alpha}$:\n  1. Case A (baseline): $x_{c} = x_{c,\\mathrm{on}}$, $x_{\\alpha} = x_{\\alpha,\\mathrm{on}}$.\n  2. Case B (collisions only): $x_{c} = x_{c,\\mathrm{on}}$, $x_{\\alpha} = 0$.\n  3. Case C (Ly$\\alpha$ only): $x_{c} = 0$, $x_{\\alpha} = x_{\\alpha,\\mathrm{on}}$.\n  4. Case D (neither): $x_{c} = 0$, $x_{\\alpha} = 0$.\n\nRequired outputs:\n- For each case, compute the fractional change in the binned power spectrum relative to the baseline, $\\Delta_{\\mathrm{frac}}(k) = \\dfrac{P_{21}^{\\mathrm{case}}(k) - P_{21}^{\\mathrm{A}}(k)}{P_{21}^{\\mathrm{A}}(k)}$, evaluated at the three $k$-bins defined above. Express these fractional changes as dimensionless decimals.\n- Your program must use the random seed $42$ to ensure reproducibility, implement all steps described above, and produce the results in a single line of output as a comma-separated list of lists in the following order of cases: A, B, C, D. For example, the output must have the form [[a1,a2,a3],[b1,b2,b3],[c1,c2,c3],[d1,d2,d3]] where each entry is a floating-point number corresponding to the fractional change at the three bins. The baseline case A should therefore yield approximately [0,0,0].\n\nAngle units are not used. All physical units appearing in the calculation must be consistent: temperatures in Kelvin, $T_{\\mathrm{b}}$ in milliKelvin, wave numbers in $h\\,\\mathrm{Mpc}^{-1}$, volume in $(\\mathrm{Mpc}\\,h^{-1})^{3}$, and $P_{21}$ in $\\mathrm{mK}^{2}\\,(\\mathrm{Mpc}\\,h^{-1})^{3}$. The final requested fractional changes are unitless. The program must be self-contained, require no input, and print exactly one line in the format specified above.",
            "solution": "The problem statement poses a well-defined and scientifically grounded numerical experiment in physical cosmology. It provides a clear, self-contained set of instructions and parameters to construct a toy model of the 21 centimeter brightness temperature field during the epoch of reionization. The objective is to quantify the sensitivity of the 21cm power spectrum to different physical coupling mechanisms governing the hydrogen spin temperature. All provided definitions, equations, and numerical values are consistent with standard literature and practices for simplified models in this field. The problem is free of scientific flaws, contradictions, or ambiguities that would prevent a unique and meaningful solution. The specified simplifications, such as a uniform neutral fraction and kinetic temperature, are appropriate for the stated goal of isolating the effects of spin temperature coupling. Therefore, a valid solution can be constructed.\n\nThe solution proceeds by implementing the numerical simulation exactly as described. The core steps are: 1) setting up the computational domain and physical constants; 2) generating a Gaussian random overdensity field $\\delta(\\mathbf{x})$ with the specified statistical properties; 3) for each of the four spin temperature coupling cases, calculating the 21cm brightness temperature field $T_{\\mathrm{b}}(\\mathbf{x})$; 4) for each case, computing the binned power spectrum $P_{21}(k)$ of the brightness temperature fluctuations; and 5) calculating the fractional change of the power spectrum in each bin relative to the baseline case.\n\nFirst, we define the physical and numerical constants based on the problem statement.\nThe simulation domain is a periodic cube of side length $L=200\\,\\mathrm{Mpc}\\,h^{-1}$ on a grid of $N^3=32^3$ cells.\nThe redshift is $z=10$, yielding a Cosmic Microwave Background (CMB) temperature of $T_{\\gamma} = 2.725(1+z) = 29.975\\,\\mathrm{K}$.\nWe are given a uniform neutral hydrogen fraction $x_{\\mathrm{HI}}=1$ and a uniform gas kinetic temperature $T_{\\mathrm{K}}=5\\,\\mathrm{K}$. The Lyman-Alpha (Ly$\\alpha$) color temperature is set equal to the kinetic temperature, $T_{\\alpha}=T_{\\mathrm{K}}$.\n\nThe overdensity field $\\delta(\\mathbf{x})$ is generated in Fourier space. A grid of wavevectors $\\mathbf{k}$ is constructed, with components given by $k_i = 2\\pi m_i/L$ for integers $m_i \\in [-N/2, N/2-1]$. We generate a field of complex Gaussian white noise $\\tilde{w}(\\mathbf{k})$ in Fourier space. This is equivalent to generating real-space white noise and then transforming it. The field is then shaped by applying the specified transfer function $T(k)$:\n$$\n\\tilde{\\delta}(\\mathbf{k}) = \\tilde{w}(\\mathbf{k}) T(k)\n$$\nwhere $k=|\\mathbf{k}|$ and the transfer function is\n$$\nT(k) = \\left(\\frac{k}{k_{0}}\\right)^{n/2}\\exp\\left[-\\frac{1}{2}\\left(\\frac{k}{k_{c}}\\right)^{2}\\right]\n$$\nwith parameters $n=-2.5$, $k_0 = 0.1\\,h\\,\\mathrm{Mpc}^{-1}$, and $k_c = 0.8\\,h\\,\\mathrm{Mpc}^{-1}$. The DC mode $\\tilde{\\delta}(\\mathbf{k}=0)$ is set to zero. An inverse Fast Fourier Transform (FFT) yields the real-space field $\\delta(\\mathbf{x})$. Any residual numerical mean is subtracted to ensure $\\langle\\delta\\rangle=0$. This same density field is used for all four cases.\n\nFor each test case (A, B, C, D), we calculate the corresponding spatially uniform spin temperature, $T_{\\mathrm{S}}$. The Wouthuysen-Field relation is given as:\n$$\nT_{\\mathrm{S}}^{-1} = \\frac{T_{\\gamma}^{-1} + x_{c}\\,T_{\\mathrm{K}}^{-1} + x_{\\alpha}\\,T_{\\alpha}^{-1}}{1 + x_{c} + x_{\\alpha}}\n$$\nThe coupling coefficients $(x_c, x_\\alpha)$ are set according to the case: A $(x_{c,\\mathrm{on}}, x_{\\alpha,\\mathrm{on}})$, B $(x_{c,\\mathrm{on}}, 0)$, C $(0, x_{\\alpha,\\mathrm{on}})$, and D $(0,0)$, with $x_{c,\\mathrm{on}}=0.1$ and $x_{\\alpha,\\mathrm{on}}=2.0$.\n\nThe brightness temperature field $T_{\\mathrm{b}}(\\mathbf{x})$ for each case is then computed. Since $x_{\\mathrm{HI}}$, $z$, $T_{\\gamma}$, and $T_{\\mathrm{S}}$ (within a given case) are all spatially uniform, the expression simplifies to a linear function of the overdensity:\n$$\nT_{\\mathrm{b}}(\\mathbf{x}) = C \\cdot (1 + \\delta(\\mathbf{x}))\n$$\nwhere the constant $C$ is given by\n$$\nC = 27\\,\\mathrm{mK} \\cdot x_{\\mathrm{HI}} \\cdot \\left(1 - \\frac{T_{\\gamma}}{T_{\\mathrm{S}}}\\right) \\cdot \\sqrt{\\frac{1+z}{10}}\n$$\nThe fluctuation field is $\\Delta_{21}(\\mathbf{x}) = T_{\\mathrm{b}}(\\mathbf{x}) - \\langle T_{\\mathrm{b}} \\rangle$. Since $\\langle\\delta\\rangle=0$, we have $\\langle T_{\\mathrm{b}}\\rangle = C$, and thus $\\Delta_{21}(\\mathbf{x}) = C \\cdot \\delta(\\mathbf{x})$.\n\nThe power spectrum $P_{21}(k)$ is estimated numerically. We compute the discrete Fourier transform $\\tilde{\\Delta}_{21}(\\mathbf{k}) = \\mathrm{FFT}[\\Delta_{21}(\\mathbf{x})]$. The power in each mode is $|\\tilde{\\Delta}_{21}(\\mathbf{k})|^2$. These power values are then averaged in three spherical shells in $k$-space, defined by the intervals $[0.05, 0.15)$, $[0.25, 0.35)$, and $[0.45, 0.55)$, all in units of $h\\,\\mathrm{Mpc}^{-1}$. The problem asks for a fractional change, which is a ratio of power spectra. Any normalization constant (like the volume factors relating discrete and continuous Fourier transforms) will cancel out. Therefore, we may simply average the raw $|\\tilde{\\Delta}_{21}(\\mathbf{k})|^2$ values within each bin to obtain a quantity proportional to the binned power spectrum.\n\nFinally, for cases B, C, and D, the fractional change relative to the baseline Case A is computed for each of the three $k$-bins:\n$$\n\\Delta_{\\mathrm{frac}}(k) = \\frac{P_{21}^{\\mathrm{case}}(k) - P_{21}^{\\mathrm{A}}(k)}{P_{21}^{\\mathrm{A}}(k)}\n$$\nSince $\\Delta_{21}(\\mathbf{x}) \\propto \\delta(\\mathbf{x})$, the power spectrum $P_{21}(k) \\propto P_{\\delta}(k)$, where $P_{\\delta}(k)$ is the power spectrum of the overdensity field. Specifically, $P_{21}^{\\text{case}}(k) = C_{\\text{case}}^2 P_{\\delta}(k)$. The fractional change thus simplifies to $\\Delta_{\\mathrm{frac}} = (C_{\\text{case}}/C_{\\text{A}})^2 - 1$, which is independent of the wavenumber $k$. Our numerical simulation will explicitly demonstrate this consequence of the model's simplifications by yielding nearly identical values for the fractional change in all three $k$-bins for any given case.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the sensitivity of the 21cm power spectrum to spin temperature\n    coupling prescriptions in a toy model of the epoch of reionization.\n    \"\"\"\n    \n    # 1. Define constants and parameters\n    L = 200.0  # Box side length in Mpc/h\n    N = 32     # Grid size along each dimension\n    z = 10.0   # Redshift\n    x_HI = 1.0 # Uniform neutral hydrogen fraction\n    T_K = 5.0  # Uniform gas kinetic temperature in K\n    T_alpha = T_K # Ly-alpha color temperature in K\n    x_c_on = 0.1\n    x_alpha_on = 2.0\n    n = -2.5   # Power spectrum spectral index parameter\n    k0 = 0.1   # Power spectrum pivot scale in h/Mpc\n    kc = 0.8   # Power spectrum cutoff scale in h/Mpc\n    T_CMB_0 = 2.725 # CMB temperature at z=0 in K\n    seed = 42\n\n    T_gamma = T_CMB_0 * (1.0 + z)\n    \n    # Define the four test cases\n    cases = {\n        'A': (x_c_on, x_alpha_on),    # Baseline\n        'B': (x_c_on, 0.0),           # Collisions only\n        'C': (0.0, x_alpha_on),       # Ly-alpha only\n        'D': (0.0, 0.0)              # Neither\n    }\n    case_order = ['A', 'B', 'C', 'D']\n\n    # 2. Set up Fourier space grid\n    k_vec = 2 * np.pi * np.fft.fftfreq(N, d=L/N)\n    kx, ky, kz = np.meshgrid(k_vec, k_vec, k_vec, indexing='ij')\n    k_mag = np.sqrt(kx**2 + ky**2 + kz**2)\n\n    # 3. Generate the overdensity field delta(x)\n    np.random.seed(seed)\n    # Generate Gaussian white noise in real space and transform\n    white_noise = np.random.randn(N, N, N)\n    white_noise_k = np.fft.fftn(white_noise)\n    \n    # Define transfer function T(k)\n    T_k = np.zeros_like(k_mag, dtype=np.float64)\n    non_zero_k = k_mag > 0\n    k_mag_safe = k_mag[non_zero_k]\n    T_k[non_zero_k] = np.power(k_mag_safe / k0, n / 2.0) * np.exp(-0.5 * np.power(k_mag_safe / kc, 2))\n    \n    # Apply transfer function to shape the field\n    delta_k = white_noise_k * T_k\n    delta_k[0, 0, 0] = 0.0  # Set mean to zero\n\n    # Transform back to real space and ensure mean is zero\n    delta_r = np.real(np.fft.ifftn(delta_k))\n    delta_r -= np.mean(delta_r)\n\n    # 4. Define binning scheme and a function to compute binned power spectrum\n    k_bins = [\n        (0.05, 0.15),\n        (0.25, 0.35),\n        (0.45, 0.55)\n    ]\n\n    def get_binned_power_spectrum(delta_21_field):\n        \"\"\"Computes the binned power spectrum of a given field.\"\"\"\n        delta_21_k = np.fft.fftn(delta_21_field)\n        power_modes = np.abs(delta_21_k)**2\n        \n        binned_P = []\n        for k_min, k_max in k_bins:\n            mask = (k_mag >= k_min)  (k_mag  k_max)\n            modes_in_bin = np.sum(mask)\n            if modes_in_bin > 0:\n                # Average power of modes in the k-shell\n                p_k = np.mean(power_modes[mask])\n                binned_P.append(p_k)\n            else:\n                binned_P.append(0.0) # No modes in this bin\n        return np.array(binned_P)\n\n    # 5. Calculate power spectrum for each case\n    all_power_spectra = {}\n    prefactor_Tb = 27.0 * x_HI * np.sqrt((1.0 + z) / 10.0)\n\n    for name, (xc, xa) in cases.items():\n        # Calculate spin temperature T_S\n        denominator = 1.0 + xc + xa\n        if np.isclose(denominator, 0): # Should not happen for problem cases\n            T_S = T_gamma\n        else:\n            T_S_inv = (T_gamma**-1 + xc * T_K**-1 + xa * T_alpha**-1) / denominator\n            T_S = 1.0 / T_S_inv if T_S_inv > 0 else np.inf\n\n        # Calculate the scaling constant C for the brightness temperature\n        if np.isclose(T_S, T_gamma):\n            C = 0.0\n        else:\n            C = prefactor_Tb * (1.0 - T_gamma / T_S)\n        \n        # Fluctuation field is C * delta_r\n        delta_21 = C * delta_r\n\n        # Compute and store binned power spectrum\n        all_power_spectra[name] = get_binned_power_spectrum(delta_21)\n\n    # 6. Compute and format fractional changes\n    P_A_binned = all_power_spectra['A']\n    final_results = []\n\n    for name in case_order:\n        P_case_binned = all_power_spectra[name]\n        \n        # Calculate fractional change, handling potential division by zero\n        frac_change = np.zeros_like(P_A_binned)\n        valid_bins = P_A_binned > 1e-12 # Use a small threshold for float comparison\n        \n        frac_change[valid_bins] = (P_case_binned[valid_bins] - P_A_binned[valid_bins]) / P_A_binned[valid_bins]\n        \n        # Handle case where P_A(k) is zero but P_case(k) is not (very unlikely)\n        # In this specific problem, it indicates P_case(k) must also be zero\n        \n        final_results.append(list(frac_change))\n\n    # Print in the required format\n    print(str(final_results).replace(\" \", \"\"))\n\nsolve()\n```"
        },
        {
            "introduction": "At the heart of simulating cosmic reionization lies the challenge of accurately tracking ionizing photons as they propagate from galaxies and carve out HII regions in the neutral intergalactic medium. The bedrock physical principle is the conservation of photon number, which demands that any numerical scheme precisely balance photon emission, absorption, and transport between grid cells. This exercise  provides hands-on experience in constructing a finite-volume scheme that is explicitly photon-conserving, a critical feature for ensuring the physical fidelity and numerical robustness of any serious radiative transfer simulation.",
            "id": "3488852",
            "problem": "Consider the numerical transport of hydrogen-ionizing photons during the Epoch of Reionization (EoR). A photon-conserving finite-volume discretization should advance the photon count in each control volume such that the global photon budget exactly balances source emission, boundary fluxes, and absorptions. Start from the photon number conservation law in integral form over a Cartesian control volume, which follows from the radiative transfer equation in the grey (single-frequency-bin) approximation: the time rate of change of photons inside a cell equals the net photon inflow through the faces plus in-cell emission minus absorptions. Let the speed of light be $c$ in $\\mathrm{m\\,s^{-1}}$, let the absorption coefficient be $\\kappa$ in $\\mathrm{m^{-1}}$, let the photon source rate density be $S$ in $\\mathrm{photons\\,m^{-3}\\,s^{-1}}$, and let the photon number density be $n_{\\gamma}$ in $\\mathrm{photons\\,m^{-3}}$. The sink rate density is $c\\,\\kappa\\,n_{\\gamma}$ in $\\mathrm{photons\\,m^{-3}\\,s^{-1}}$. For a uniform Cartesian mesh with cell volume $V$ and faces of area $A$, define the per-cell photon count $N_i = \\int_{V_i} n_{\\gamma}\\,\\mathrm{d}V$ in $\\mathrm{photons}$ and the face photon rate $\\Phi_{i\\pm\\frac{1}{2}} = \\int_{A_{i\\pm\\frac{1}{2}}} \\boldsymbol{F}\\cdot\\mathrm{d}\\boldsymbol{A}$ in $\\mathrm{photons\\,s^{-1}}$, where $\\boldsymbol{F}$ is the photon number flux density in $\\mathrm{photons\\,m^{-2}\\,s^{-1}}$. Assume a one-dimensional mesh along $x$ with uniform cells indexed by $i \\in \\{0,\\dots,N_x-1\\}$ and faces at $i\\pm\\frac{1}{2}$; the outward normal at the right face is in the $+\\hat{x}$ direction, so a positive $\\Phi$ transports photons to increasing $x$. Let the volume-integrated source in cell $i$ be $S_i V$ in $\\mathrm{photons\\,s^{-1}}$, denoted by $Q_i$.\n\nYour task:\n\n1) Derive a discrete, photon-conserving, finite-volume update rule for the per-cell photon counts over a time step $\\Delta t$ in $\\mathrm{s}$ that is fully implicit in the absorption sink term to ensure positivity and robustness for stiff absorption. The update must be expressed in terms of cell-wise quantities $N_i^n$ and $N_i^{n+1}$ in $\\mathrm{photons}$, face photon rates $\\Phi_{i\\pm\\frac{1}{2}}$ in $\\mathrm{photons\\,s^{-1}}$, cell-integrated source rates $Q_i$ in $\\mathrm{photons\\,s^{-1}}$, the speed of light $c$ in $\\mathrm{m\\,s^{-1}}$, and the absorption coefficient $\\kappa_i$ in $\\mathrm{m^{-1}}$.\n\n2) Implement the derived update rule for a one-dimensional mesh where the geometry is absorbed into the definitions of $N_i$ and $\\Phi_{i\\pm\\frac{1}{2}}$ as above, so that the flux contribution to $N_i$ over $\\Delta t$ is $-\\Delta t\\,(\\Phi_{i+\\frac{1}{2}}-\\Phi_{i-\\frac{1}{2}})$ in $\\mathrm{photons}$.\n\n3) For each test case below, perform one time step and compute the absolute global conservation residual $R$ in $\\mathrm{photons}$ defined by\n$$\nR \\equiv \\left|\\left(\\sum_{i=0}^{N_x-1} N_i^{n+1}-\\sum_{i=0}^{N_x-1} N_i^{n}\\right) - \\left(-\\Delta t\\,\\big(\\Phi_{N_x-\\frac{1}{2}}-\\Phi_{-\\frac{1}{2}}\\big) + \\Delta t\\,\\sum_{i=0}^{N_x-1} Q_i - \\Delta t\\,\\sum_{i=0}^{N_x-1} c\\,\\kappa_i\\,N_i^{n+1}\\right)\\right| ,\n$$\nwhere $\\Phi_{-\\frac{1}{2}}$ and $\\Phi_{N_x-\\frac{1}{2}}$ are the left and right boundary face photon rates, respectively. A photon-conserving scheme should yield $R$ that is compatible with roundoff.\n\nExpress the final answers for the residuals $R$ in $\\mathrm{photons}$ using scientific notation with six significant figures.\n\nTest suite (all quantities are to be interpreted in the units specified above):\n\n- Case A (happy path): $N_x = 4$, initial per-cell photon counts $[N_0^n,N_1^n,N_2^n,N_3^n] = [10^6, 2\\times 10^6, 5\\times 10^5, 1.5\\times 10^6]$, face photon rates $[\\Phi_{-\\frac{1}{2}},\\Phi_{\\frac{1}{2}},\\Phi_{\\frac{3}{2}},\\Phi_{\\frac{5}{2}},\\Phi_{\\frac{7}{2}}] = [10^5, 5\\times 10^4, -2\\times 10^4, 0, -5\\times 10^4]$, cell-integrated source rates $[Q_0,Q_1,Q_2,Q_3] = [10^4, 0, 2\\times 10^4, 0]$, uniform absorption coefficient $\\kappa_i = 10^{-10}$ for all $i$, $\\Delta t = 10^{-1}$, $c = 2.99792458\\times 10^8$.\n\n- Case B (zero-flux boundaries, sources and absorption only): $N_x = 3$, initial $[N_0^n,N_1^n,N_2^n] = [0,0,0]$, faces $[\\Phi_{-\\frac{1}{2}},\\Phi_{\\frac{1}{2}},\\Phi_{\\frac{3}{2}},\\Phi_{\\frac{5}{2}}] = [0,0,0,0]$, sources $[Q_0,Q_1,Q_2] = [10^5,10^5,10^5]$, $\\kappa_i = 10^{-9}$ for all $i$, $\\Delta t = 1$, $c = 2.99792458\\times 10^8$.\n\n- Case C (vacuum, check strict conservation with sources and balanced boundary fluxes): $N_x = 2$, initial $[N_0^n,N_1^n] = [10^3, 2\\times 10^3]$, faces $[\\Phi_{-\\frac{1}{2}},\\Phi_{\\frac{1}{2}},\\Phi_{\\frac{3}{2}}] = [10^2,10^2,10^2]$, sources $[Q_0,Q_1] = [0,10^2]$, $\\kappa_i = 0$ for all $i$, $\\Delta t = 10$, $c = 2.99792458\\times 10^8$.\n\n- Case D (stiff absorption, positivity under implicit sink): $N_x = 1$, initial $[N_0^n] = [10^9]$, faces $[\\Phi_{-\\frac{1}{2}},\\Phi_{\\frac{1}{2}}] = [0,0]$, sources $[Q_0] = [10^8]$, $\\kappa_0 = 1$, $\\Delta t = 10^{-9}$, $c = 2.99792458\\times 10^8$.\n\n- Case E (net inflow from boundaries, no sources, no absorption): $N_x = 3$, initial $[N_0^n,N_1^n,N_2^n] = [10^4,2\\times 10^4,3\\times 10^4]$, faces $[\\Phi_{-\\frac{1}{2}},\\Phi_{\\frac{1}{2}},\\Phi_{\\frac{3}{2}},\\Phi_{\\frac{5}{2}}] = [5\\times 10^3,0,0,-5\\times 10^3]$, sources $[Q_0,Q_1,Q_2] = [0,0,0]$, $\\kappa_i = 0$ for all $i$, $\\Delta t = 1$, $c = 2.99792458\\times 10^8$.\n\nYour program should produce a single line of output containing the residuals as a comma-separated list enclosed in square brackets (e.g., $[r_A,r_B,r_C,r_D,r_E]$), where each $r$ is the absolute residual $R$ for the corresponding case formatted in scientific notation with six significant figures. All residuals must be reported in $\\mathrm{photons}$.",
            "solution": "The user's request is to derive a photon-conserving finite-volume update rule for radiative transfer and apply it to a series of test cases, reporting the global conservation residual for each.\n\nThe problem is valid as it is scientifically grounded in the principles of radiative transfer, mathematically well-posed, objective, and provides a complete and consistent set of data and definitions. The task is a standard exercise in numerical methods for conservation laws. I will now proceed with the derivation and implementation.\n\n**1. Derivation of the Finite-Volume Update Rule**\n\nThe fundamental principle is the conservation of photon number within a control volume $V_i$. The time rate of change of the number of photons in $V_i$ equals the net rate of photons entering the volume plus the rate of internal emission, minus the rate of internal absorption. This is expressed by the integral form of the transport equation:\n$$\n\\frac{\\mathrm{d}}{\\mathrm{d}t} \\int_{V_i} n_{\\gamma}\\,\\mathrm{d}V = -\\oint_{\\partial V_i} \\boldsymbol{F}\\cdot\\mathrm{d}\\boldsymbol{A} + \\int_{V_i} S\\,\\mathrm{d}V - \\int_{V_i} c\\,\\kappa\\,n_{\\gamma}\\,\\mathrm{d}V\n$$\nHere, $n_{\\gamma}$ is the photon number density, $\\boldsymbol{F}$ is the photon number flux density, $S$ is the source rate density, $c$ is the speed of light, and $\\kappa$ is the absorption coefficient.\n\nWe translate this into the problem's discrete quantities:\n- The per-cell photon count in cell $i$ is $N_i(t) = \\int_{V_i} n_{\\gamma}\\,\\mathrm{d}V$.\n- The cell-integrated source rate is $Q_i = \\int_{V_i} S\\,\\mathrm{d}V$.\n- Assuming the absorption coefficient $\\kappa_i$ is constant within a cell, the volume-integrated absorption rate is $\\int_{V_i} c\\,\\kappa\\,n_{\\gamma}\\,\\mathrm{d}V = c\\,\\kappa_i \\int_{V_i} n_{\\gamma}\\,\\mathrm{d}V = c\\,\\kappa_i N_i(t)$.\n- In one dimension, the surface integral $\\oint_{\\partial V_i} \\boldsymbol{F}\\cdot\\mathrm{d}\\boldsymbol{A}$ represents the net flux out of the cell. The problem defines the face photon rate $\\Phi_{i \\pm \\frac{1}{2}}$ as the rate of photons crossing the face in the $+\\hat{x}$ direction. The net flux out of cell $i$ is the outflow rate at the right face ($i+\\frac{1}{2}$) minus the inflow rate at the left face ($i-\\frac{1}{2}$). This corresponds to $\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}$.\n\nSubstituting these discrete quantities into the conservation law gives the semi-discrete ordinary differential equation for $N_i$:\n$$\n\\frac{\\mathrm{d}N_i}{\\mathrm{d}t} = -(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}) + Q_i - c\\,\\kappa_i N_i\n$$\nTo discretize in time over a step $\\Delta t$ from $t^n$ to $t^{n+1}$, we approximate the derivative as $\\frac{N_i^{n+1} - N_i^n}{\\Delta t}$. The problem requires the absorption sink term to be treated implicitly, meaning it is evaluated at the new time level $t^{n+1}$. The source and flux terms are treated as constant over the time step. This mixed explicit-implicit (IMEX) scheme is written as:\n$$\n\\frac{N_i^{n+1} - N_i^n}{\\Delta t} = -(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}) + Q_i - c\\,\\kappa_i N_i^{n+1}\n$$\nTo find the update rule, we solve for $N_i^{n+1}$. First, multiply by $\\Delta t$:\n$$\nN_i^{n+1} - N_i^n = \\Delta t \\left[ -(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}) + Q_i \\right] - \\Delta t\\,c\\,\\kappa_i N_i^{n+1}\n$$\nNext, group all terms involving $N_i^{n+1}$ on the left-hand side:\n$$\nN_i^{n+1} + \\Delta t\\,c\\,\\kappa_i N_i^{n+1} = N_i^n - \\Delta t(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}) + \\Delta t\\,Q_i\n$$\nFactor out $N_i^{n+1}$:\n$$\nN_i^{n+1}(1 + c\\,\\kappa_i\\,\\Delta t) = N_i^n + \\Delta t\\,Q_i - \\Delta t(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}})\n$$\nFinally, dividing by the term in parentheses yields the explicit update rule for $N_i^{n+1}$:\n$$\nN_i^{n+1} = \\frac{N_i^n + \\Delta t\\,Q_i - \\Delta t\\,(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}})}{1 + c\\,\\kappa_i\\,\\Delta t}\n$$\nThis equation is implemented for each cell $i=0, \\dots, N_x-1$ to compute the state at time $t^{n+1}$. This implicit treatment of the sink term guarantees positivity of $N_i^{n+1}$ for non-negative inputs.\n\n**2. Global Conservation and the Residual R**\n\nThe problem defines the absolute global conservation residual $R$ to verify the scheme. By summing our update rule over all cells, we can show that the scheme is perfectly conserving by construction. Rearranging our time-discrete equation before solving for $N_i^{n+1}$:\n$$\n(N_i^{n+1} - N_i^n) - \\left[ -\\Delta t(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}) + \\Delta t\\,Q_i - \\Delta t\\,c\\,\\kappa_i N_i^{n+1} \\right] = 0\n$$\nSumming over all cells $i=0, \\dots, N_x-1$:\n$$\n\\sum_{i=0}^{N_x-1}(N_i^{n+1} - N_i^n) - \\left[ -\\Delta t \\sum_{i=0}^{N_x-1}(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}) + \\Delta t \\sum_{i=0}^{N_x-1} Q_i - \\Delta t \\sum_{i=0}^{N_x-1} c\\,\\kappa_i N_i^{n+1} \\right] = 0\n$$\nThe sum over fluxes forms a telescoping series:\n$$\n\\sum_{i=0}^{N_x-1}(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}) = (\\Phi_{\\frac{1}{2}} - \\Phi_{-\\frac{1}{2}}) + (\\Phi_{\\frac{3}{2}} - \\Phi_{\\frac{1}{2}}) + \\dots + (\\Phi_{N_x-\\frac{1}{2}} - \\Phi_{N_x-\\frac{3}{2}}) = \\Phi_{N_x-\\frac{1}{2}} - \\Phi_{-\\frac{1}{2}}\n$$\nSubstituting this back gives the global conservation equation:\n$$\n\\left(\\sum_{i=0}^{N_x-1}N_i^{n+1} - \\sum_{i=0}^{N_x-1}N_i^{n}\\right) - \\left[ -\\Delta t (\\Phi_{N_x-\\frac{1}{2}} - \\Phi_{-\\frac{1}{2}}) + \\Delta t \\sum_{i=0}^{N_x-1} Q_i - \\Delta t \\sum_{i=0}^{N_x-1} c\\,\\kappa_i N_i^{n+1} \\right] = 0\n$$\nThe expression inside the absolute value for the residual $R$ is precisely this equation. Therefore, if the update rule is implemented correctly, $R$ will be zero up to floating-point roundoff error. The implementation below calculates $N_i^{n+1}$ for all cells according to the derived formula and then evaluates $R$ to confirm this property.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Derives and implements a photon-conserving finite-volume update rule for \n    radiative transfer, calculates the global conservation residual for a suite \n    of test cases, and prints the results in the specified format.\n    \"\"\"\n    \n    # Define the speed of light, c, in m/s\n    c = 2.99792458e8\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case A: Happy path\n        {'Nx': 4, 'Nn': np.array([1e6, 2e6, 5e5, 1.5e6], dtype=np.float64),\n         'Phi': np.array([1e5, 5e4, -2e4, 0, -5e4], dtype=np.float64),\n         'Q': np.array([1e4, 0, 2e4, 0], dtype=np.float64),\n         'kappa': np.full(4, 1e-10, dtype=np.float64), 'dt': 1e-1},\n        \n        # Case B: Zero-flux boundaries, sources and absorption only\n        {'Nx': 3, 'Nn': np.array([0., 0., 0.], dtype=np.float64),\n         'Phi': np.array([0., 0., 0., 0.], dtype=np.float64),\n         'Q': np.array([1e5, 1e5, 1e5], dtype=np.float64),\n         'kappa': np.full(3, 1e-9, dtype=np.float64), 'dt': 1.0},\n        \n        # Case C: Vacuum, check strict conservation with sources and balanced boundary fluxes\n        {'Nx': 2, 'Nn': np.array([1e3, 2e3], dtype=np.float64),\n         'Phi': np.array([100., 100., 100.], dtype=np.float64),\n         'Q': np.array([0., 100.], dtype=np.float64),\n         'kappa': np.full(2, 0.0, dtype=np.float64), 'dt': 10.0},\n        \n        # Case D: Stiff absorption, positivity under implicit sink\n        {'Nx': 1, 'Nn': np.array([1e9], dtype=np.float64),\n         'Phi': np.array([0., 0.], dtype=np.float64),\n         'Q': np.array([1e8], dtype=np.float64),\n         'kappa': np.array([1.0], dtype=np.float64), 'dt': 1e-9},\n        \n        # Case E: Net inflow from boundaries, no sources, no absorption\n        {'Nx': 3, 'Nn': np.array([1e4, 2e4, 3e4], dtype=np.float64),\n         'Phi': np.array([5e3, 0., 0., -5e3], dtype=np.float64),\n         'Q': np.array([0., 0., 0.], dtype=np.float64),\n         'kappa': np.full(3, 0.0, dtype=np.float64), 'dt': 1.0}\n    ]\n\n    residuals = []\n    for case in test_cases:\n        # Unpack parameters for the current test case\n        Nx = case['Nx']\n        Nn = case['Nn']\n        Phi = case['Phi']\n        Q = case['Q']\n        kappa = case['kappa']\n        dt = case['dt']\n\n        # Array to store the new photon counts\n        Nn_plus_1 = np.zeros(Nx, dtype=np.float64)\n\n        # Apply the update rule for each cell\n        for i in range(Nx):\n            # Flux divergence for cell i\n            flux_diff = Phi[i+1] - Phi[i]\n            \n            # Numerator of the update rule\n            numerator = Nn[i] + dt * Q[i] - dt * flux_diff\n            \n            # Denominator of the update rule (implicit sink term)\n            denominator = 1.0 + c * kappa[i] * dt\n            \n            Nn_plus_1[i] = numerator / denominator\n\n        # Calculate the absolute global conservation residual R\n        \n        # Total change in photon number in the domain\n        total_change_N = np.sum(Nn_plus_1) - np.sum(Nn)\n        \n        # Total contribution from boundary fluxes\n        # The term phi_Nx-1/2 corresponds to Phi[Nx] and phi_-1/2 to Phi[0]\n        boundary_flux_term = -dt * (Phi[Nx] - Phi[0])\n        \n        # Total contribution from internal sources\n        source_term = dt * np.sum(Q)\n        \n        # Total contribution from absorption sinks (using new state Nn+1)\n        sink_term = -dt * c * np.sum(kappa * Nn_plus_1)\n        \n        # Sum of all photon changes due to fluxes, sources, and sinks\n        total_contributions = boundary_flux_term + source_term + sink_term\n        \n        # The residual is the absolute difference, which should be near zero\n        residual = abs(total_change_N - total_contributions)\n        residuals.append(residual)\n\n    # Format the final results as specified: scientific notation with six significant figures\n    # The format specifier '.5e' gives one digit before the decimal and five after.\n    formatted_results = [f\"{r:.5e}\" for r in residuals]\n    \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Our view of the cosmic 21cm signal is necessarily seen through the lens of redshift space, where peculiar velocities distort the inferred spatial distribution of neutral hydrogen. While linear theory for redshift-space distortions (RSDs) is a powerful tool in large-scale structure, it breaks down in the presence of the large velocity gradients and sharp ionization fronts that characterize reionization. This advanced practice  challenges you to model these non-linear effects, calibrating a corrected distortion model that better captures the physics of infall and outflow around HII bubbles, a crucial step in bridging the gap between theoretical simulations and real-world observations.",
            "id": "3488873",
            "problem": "Consider the high spin-temperature limit of the redshifted hydrogen $21\\,\\mathrm{cm}$ signal during the Epoch of Reionization, such that the brightness temperature contrast obeys the proportionality $\\delta T_{b} \\propto x_{\\mathrm{HI}} (1 + \\delta)$ in real space, where $x_{\\mathrm{HI}}$ is the neutral fraction and $\\delta$ is the matter overdensity. In redshift space, the mapping along the line of sight $s = r + v_{\\parallel}/(aH)$ implies a Jacobian factor $\\mathrm{d}s/\\mathrm{d}r = 1 + (1/(aH))\\,\\partial v_{\\parallel}/\\partial r$, which modulates the brightness temperature via mass conservation. Define the dimensionless velocity gradient parameter $\\eta \\equiv (1+z)H^{-1}\\,\\partial v_{\\parallel}/\\partial r_{\\parallel}$, so that the exact Jacobian factor, expressed in terms of $\\eta$, is $J_{\\mathrm{exact}}(\\eta) = 1/(1 - \\eta)$ under the usual sign convention for infall. The linear redshift-space distortion approximation expands this as $J_{\\mathrm{lin}}(\\eta) \\approx 1 + \\eta$ for small $|\\eta|$.\n\nNear ionized bubbles, where sharp ionization fronts and nonlinear flows produce large $|\\eta|$, the linear approximation fails and $J_{\\mathrm{exact}}(\\eta)$ can become singular as $\\eta \\to 1$. To address this, adopt a physically motivated regularization that approximates small-scale velocity dispersion and finite thickness effects by replacing $J_{\\mathrm{exact}}(\\eta)$ with a clipped form\n$$\nJ_{\\mathrm{clip}}(\\eta;\\epsilon) \\equiv \\frac{1}{\\max(1 - \\eta, \\epsilon)} \\, ,\n$$\nwhere $\\epsilon$ is a small positive constant that prevents divergence and emulates unresolved dispersion smoothing. Use $\\epsilon = 0.05$.\n\nYour task is to analyze how the nonlinearity in the velocity gradient term modulates $\\delta T_{b}$ near ionized bubbles and to propose a beyond-linear correction. Concretely, consider the one-parameter rational family\n$$\nJ_{\\mathrm{corr}}(\\eta;\\beta) \\equiv \\frac{1}{1 - \\eta + \\beta \\eta^{2}} \\, ,\n$$\nwhich is constructed to reproduce the correct linear behavior as $\\eta \\to 0$ while allowing controlled nonlinear regularization via $\\beta \\ge 0$. You must calibrate $\\beta$ by minimizing a neutral-fraction and density weighted squared error between $J_{\\mathrm{corr}}$ and $J_{\\mathrm{clip}}$ across a thin shell around the ionization front.\n\nModel the ionization front as a spherically symmetric, smoothed step at radius $R_{\\mathrm{b}}$, and approximate the line-of-sight profiles near the bubble edge by the following one-dimensional functions of radius $r$:\n- Neutral fraction:\n$$\nx_{\\mathrm{HI}}(r) = \\frac{1}{2}\\left[1 + \\tanh\\left(\\frac{r - R_{\\mathrm{b}}}{w}\\right)\\right] \\, .\n$$\n- Overdensity:\n$$\n\\delta(r) = \\delta_{0} \\exp\\left(-\\frac{(r - R_{\\mathrm{b}})^{2}}{2\\sigma^{2}}\\right) \\, .\n$$\n- Dimensionless velocity gradient:\n$$\n\\eta(r) = \\eta_{0}\\,\\mathrm{sech}^{2}\\!\\left(\\frac{r - R_{\\mathrm{b}}}{w}\\right) \\, .\n$$\n\nAssume a brightness normalization $T_{0} = 27\\,\\text{mK}$ for definiteness, and take the high spin-temperature limit so that the redshift dependence in the normalization can be neglected for the present toy model. For each parameter set, evaluate $r$ on a uniform grid over the interval $[R_{\\mathrm{b}} - 3w,\\, R_{\\mathrm{b}} + 3w]$ with $N = 4001$ points. Define the three model predictions for the brightness temperature in milliKelvin (mK):\n$$\n\\delta T_{b}^{\\mathrm{lin}}(r) = T_{0}\\,x_{\\mathrm{HI}}(r)\\,[1 + \\delta(r)]\\,[1 + \\eta(r)] \\, ,\n$$\n$$\n\\delta T_{b}^{\\mathrm{clip}}(r) = T_{0}\\,x_{\\mathrm{HI}}(r)\\,[1 + \\delta(r)]\\,J_{\\mathrm{clip}}(\\eta(r);\\epsilon) \\, ,\n$$\n$$\n\\delta T_{b}^{\\mathrm{corr}}(r;\\beta) = T_{0}\\,x_{\\mathrm{HI}}(r)\\,[1 + \\delta(r)]\\,J_{\\mathrm{corr}}(\\eta(r);\\beta) \\, .\n$$\n\nCalibrate $\\beta$ by minimizing the neutral-fraction and density weighted normalized root-mean-square error with respect to $\\delta T_{b}^{\\mathrm{clip}}(r)$:\n$$\n\\mathrm{NRMSE}(\\beta) \\equiv \\sqrt{\\frac{\\int_{r_{-}}^{r_{+}}\\left[\\delta T_{b}^{\\mathrm{corr}}(r;\\beta) - \\delta T_{b}^{\\mathrm{clip}}(r)\\right]^{2}\\,\\mathrm{d}r}{\\int_{r_{-}}^{r_{+}}\\left[\\delta T_{b}^{\\mathrm{clip}}(r)\\right]^{2}\\,\\mathrm{d}r}} \\, ,\n$$\nwith $r_{-} = R_{\\mathrm{b}} - 3w$ and $r_{+} = R_{\\mathrm{b}} + 3w$. Report also the corresponding error for the linear approximation:\n$$\n\\mathrm{NRMSE}_{\\mathrm{lin}} \\equiv \\sqrt{\\frac{\\int_{r_{-}}^{r_{+}}\\left[\\delta T_{b}^{\\mathrm{lin}}(r) - \\delta T_{b}^{\\mathrm{clip}}(r)\\right]^{2}\\,\\mathrm{d}r}{\\int_{r_{-}}^{r_{+}}\\left[\\delta T_{b}^{\\mathrm{clip}}(r)\\right]^{2}\\,\\mathrm{d}r}} \\, .\n$$\n\nImplement a program that, for each parameter set below, performs the calibration by minimizing $\\mathrm{NRMSE}(\\beta)$ over a bounded interval $\\beta \\in [0, 2]$ and returns three quantities per test case: the linear error $\\mathrm{NRMSE}_{\\mathrm{lin}}$, the optimal $\\beta^{\\star}$, and the corrected error $\\mathrm{NRMSE}(\\beta^{\\star})$. Use numerical quadrature by the composite trapezoidal rule on the specified grid, and a one-dimensional search over a sufficiently fine grid in $\\beta$ to approximate the minimizer.\n\nUse the following test suite of parameter values, which probe a moderate nonlinearity case, a near-divergent inflow case, an outflow case, and a sharp-front case, respectively:\n- Case $1$: $R_{\\mathrm{b}} = 5.0$ (comoving megaparsecs), $w = 0.5$ (comoving megaparsecs), $\\eta_{0} = 0.4$, $\\delta_{0} = 0.3$, $\\sigma = 0.6$ (comoving megaparsecs).\n- Case $2$: $R_{\\mathrm{b}} = 10.0$ (comoving megaparsecs), $w = 0.4$ (comoving megaparsecs), $\\eta_{0} = 0.95$, $\\delta_{0} = 0.2$, $\\sigma = 0.5$ (comoving megaparsecs).\n- Case $3$: $R_{\\mathrm{b}} = 8.0$ (comoving megaparsecs), $w = 0.7$ (comoving megaparsecs), $\\eta_{0} = -0.6$, $\\delta_{0} = 0.25$, $\\sigma = 0.8$ (comoving megaparsecs).\n- Case $4$: $R_{\\mathrm{b}} = 12.0$ (comoving megaparsecs), $w = 0.2$ (comoving megaparsecs), $\\eta_{0} = 0.8$, $\\delta_{0} = 0.15$, $\\sigma = 0.3$ (comoving megaparsecs).\n\nPhysical and numerical unit requirements:\n- The intermediate brightness temperatures $\\delta T_{b}$ are in milliKelvin. Errors $\\mathrm{NRMSE}$ and the parameter $\\beta$ are dimensionless. There are no angles. No percentages are to be reported.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. The list must contain, in order and grouped by case, the triplets $\\left[\\mathrm{NRMSE}_{\\mathrm{lin}}, \\beta^{\\star}, \\mathrm{NRMSE}(\\beta^{\\star})\\right]$ for Cases $1$ through $4$, flattened into a single list. For example, the output should look like $[\\text{c1\\_lin},\\text{c1\\_beta},\\text{c1\\_corr},\\text{c2\\_lin},\\text{c2\\_beta},\\text{c2\\_corr},\\ldots]$, where each entry is a floating-point number.",
            "solution": "The user-provided problem is assessed to be valid.\n\n### Step 1: Extract Givens\n- **Physical Proportionality**: The $21\\,\\mathrm{cm}$ brightness temperature contrast $\\delta T_{b}$ is proportional to $x_{\\mathrm{HI}} (1 + \\delta)$, where $x_{\\mathrm{HI}}$ is the neutral fraction and $\\delta$ is the matter overdensity.\n- **Redshift-Space Jacobian**: The line-of-sight velocity gradient modulates the signal via a Jacobian factor. The dimensionless velocity gradient is $\\eta \\equiv (1+z)H^{-1}\\,\\partial v_{\\parallel}/\\partial r_{\\parallel}$.\n- **Jacobian Models**:\n    - Linear Approximation: $J_{\\mathrm{lin}}(\\eta) \\approx 1 + \\eta$.\n    - Clipped \"Truth\" Model: $J_{\\mathrm{clip}}(\\eta;\\epsilon) \\equiv \\frac{1}{\\max(1 - \\eta, \\epsilon)}$, with $\\epsilon = 0.05$. This model regularizes the singularity of the exact Jacobian $J_{\\mathrm{exact}}(\\eta) = 1/(1 - \\eta)$.\n    - Corrected Model: $J_{\\mathrm{corr}}(\\eta;\\beta) \\equiv \\frac{1}{1 - \\eta + \\beta \\eta^{2}}$, where $\\beta \\ge 0$ is a calibration parameter.\n- **1D Radial Profiles**:\n    - Neutral Fraction: $x_{\\mathrm{HI}}(r) = \\frac{1}{2}\\left[1 + \\tanh\\left(\\frac{r - R_{\\mathrm{b}}}{w}\\right)\\right]$.\n    - Overdensity: $\\delta(r) = \\delta_{0} \\exp\\left(-\\frac{(r - R_{\\mathrm{b}})^{2}}{2\\sigma^{2}}\\right)$.\n    - Velocity Gradient: $\\eta(r) = \\eta_{0}\\,\\mathrm{sech}^{2}\\!\\left(\\frac{r - R_{\\mathrm{b}}}{w}\\right)$.\n- **Brightness Temperature Models**:\n    - Linear: $\\delta T_{b}^{\\mathrm{lin}}(r) = T_{0}\\,x_{\\mathrm{HI}}(r)\\,[1 + \\delta(r)]\\,[1 + \\eta(r)]$.\n    - Clipped: $\\delta T_{b}^{\\mathrm{clip}}(r) = T_{0}\\,x_{\\mathrm{HI}}(r)\\,[1 + \\delta(r)]\\,J_{\\mathrm{clip}}(\\eta(r);\\epsilon)$.\n    - Corrected: $\\delta T_{b}^{\\mathrm{corr}}(r;\\beta) = T_{0}\\,x_{\\mathrm{HI}}(r)\\,[1 + \\delta(r)]\\,J_{\\mathrm{corr}}(\\eta(r);\\beta)$.\n- **Constants and Numerical Parameters**:\n    - Brightness normalization: $T_{0} = 27\\,\\text{mK}$.\n    - Clipping parameter: $\\epsilon = 0.05$.\n    - Spatial grid: $N = 4001$ points uniformly spaced over $[R_{\\mathrm{b}} - 3w, R_{\\mathrm{b}} + 3w]$.\n    - Calibration range for $\\beta$: $[0, 2]$.\n- **Error Metrics**:\n    - Corrected Model Error: $\\mathrm{NRMSE}(\\beta) \\equiv \\sqrt{\\frac{\\int_{r_{-}}^{r_{+}}\\left[\\delta T_{b}^{\\mathrm{corr}}(r;\\beta) - \\delta T_{b}^{\\mathrm{clip}}(r)\\right]^{2}\\,\\mathrm{d}r}{\\int_{r_{-}}^{r_{+}}\\left[\\delta T_{b}^{\\mathrm{clip}}(r)\\right]^{2}\\,\\mathrm{d}r}}$, with $r_{\\pm} = R_{\\mathrm{b}} \\pm 3w$.\n    - Linear Model Error: $\\mathrm{NRMSE}_{\\mathrm{lin}}$ is defined analogously, replacing $\\delta T_{b}^{\\mathrm{corr}}$ with $\\delta T_{b}^{\\mathrm{lin}}$.\n- **Numerical Procedures**: Integrals are to be computed using the composite trapezoidal rule. Minimization of $\\mathrm{NRMSE}(\\beta)$ is to be done via a grid search.\n- **Test Cases**: Four sets of parameters $(R_{\\mathrm{b}}, w, \\eta_{0}, \\delta_{0}, \\sigma)$ are provided.\n    1. $(5.0, 0.5, 0.4, 0.3, 0.6)$\n    2. $(10.0, 0.4, 0.95, 0.2, 0.5)$\n    3. $(8.0, 0.7, -0.6, 0.25, 0.8)$\n    4. $(12.0, 0.2, 0.8, 0.15, 0.3)$\n\n### Step 2: Validate Using Extracted Givens\nThe problem is scientifically grounded in the cosmology of the Epoch of Reionization, specifically the modeling of the $21\\,\\mathrm{cm}$ signal and redshift-space distortions. The provided equations are physically motivated simplifications common in the field. The problem is well-posed, providing all necessary functions, parameters, and a clear computational objective with specified numerical methods. It contains no contradictions, ambiguities, or subjective claims. The problem is a standard computational physics exercise in model validation and parameter calibration.\n\n### Step 3: Verdict and Action\nThe problem is **valid**. A solution will be provided.\n\n### Principle-Based Design of the Solution\nThe objective is to find an optimal parameter $\\beta^{\\star}$ for the corrected Jacobian model, $J_{\\mathrm{corr}}(\\eta; \\beta)$, by minimizing its deviation from a physically regularized \"truth\" model, $J_{\\mathrm{clip}}(\\eta; \\epsilon)$. This is quantified by the normalized root-mean-square error ($\\mathrm{NRMSE}$) of the resulting brightness temperature signals. We will also compute the error of the standard linear approximation, $\\mathrm{NRMSE}_{\\mathrm{lin}}$, for comparison.\n\nFirst, we observe that the brightness temperature models share a common multiplicative factor, $A(r) \\equiv T_{0}\\,x_{\\mathrm{HI}}(r)\\,[1 + \\delta(r)]$. The $\\mathrm{NRMSE}$ expression for the corrected model is:\n$$\n\\mathrm{NRMSE}(\\beta) = \\sqrt{\\frac{\\int_{r_{-}}^{r_{+}}\\left[A(r) J_{\\mathrm{corr}}(\\eta(r);\\beta) - A(r) J_{\\mathrm{clip}}(\\eta(r);\\epsilon)\\right]^{2}\\,\\mathrm{d}r}{\\int_{r_{-}}^{r_{+}}\\left[A(r) J_{\\mathrm{clip}}(\\eta(r);\\epsilon)\\right]^{2}\\,\\mathrm{d}r}}\n$$\nThis expression simplifies considerably. The factor $A(r)^2$ appears in both the numerator and denominator integrals and can be factored out of the squared difference. The constant $T_0^2$ from $A(r)^2$ cancels, leaving:\n$$\n\\mathrm{NRMSE}(\\beta)^{2} = \\frac{\\int_{r_{-}}^{r_{+}} \\left[J_{\\mathrm{corr}}(\\eta(r);\\beta) - J_{\\mathrm{clip}}(\\eta(r);\\epsilon)\\right]^{2} W(r) \\,\\mathrm{d}r}{\\int_{r_{-}}^{r_{+}} \\left[J_{\\mathrm{clip}}(\\eta(r);\\epsilon)\\right]^{2} W(r) \\,\\mathrm{d}r}\n$$\nwhere the weighting function is $W(r) = \\left(x_{\\mathrm{HI}}(r)\\,[1 + \\delta(r)]\\right)^2$. This formulation clarifies that we are minimizing the squared difference between Jacobian models, weighted by a factor that emphasizes regions where the neutral hydrogen density is high. A similar simplification applies to $\\mathrm{NRMSE}_{\\mathrm{lin}}$.\n\nThe algorithm proceeds as follows for each test case:\n1.  **Grid and Profile Generation**: A uniform spatial grid $r$ is created over the interval $[R_{\\mathrm{b}} - 3w, R_{\\mathrm{b}} + 3w]$ with $N=4001$ points. The profiles for the neutral fraction $x_{\\mathrm{HI}}(r)$, overdensity $\\delta(r)$, and velocity gradient $\\eta(r)$ are calculated and stored as arrays.\n2.  **Jacobian Calculation**: The different Jacobian models are evaluated on the grid: the linear model $J_{\\mathrm{lin}}(\\eta(r))$, the clipped model $J_{\\mathrm{clip}}(\\eta(r);\\epsilon)$, and the corrected model $J_{\\mathrm{corr}}(\\eta(r);\\beta)$.\n3.  **Numerical Integration Setup**: The weighting function $W(r)$ is calculated. The denominator of the $\\mathrm{NRMSE}$, which is constant for a given test case, is computed by applying the trapezoidal rule to the integrand $\\left[J_{\\mathrm{clip}}\\right]^2 W(r)$.\n4.  **Linear Error Calculation**: The numerator of $\\mathrm{NRMSE}_{\\mathrm{lin}}$ is computed by numerically integrating $\\left[J_{\\mathrm{lin}} - J_{\\mathrm{clip}}\\right]^2 W(r)$. $\\mathrm{NRMSE}_{\\mathrm{lin}}$ is then the square root of the ratio of the two integrals.\n5.  **Calibration of $\\beta$**: A fine grid of $\\beta$ values is created in the interval $[0, 2]$. For each $\\beta$ in this grid:\n    a. The corrected Jacobian $J_{\\mathrm{corr}}(\\eta(r);\\beta)$ is computed.\n    b. The numerator for $\\mathrm{NRMSE}(\\beta)$ is calculated by integrating $\\left[J_{\\mathrm{corr}} - J_{\\mathrm{clip}}\\right]^2 W(r)$.\n    c. $\\mathrm{NRMSE}(\\beta)$ is calculated as the square root of the ratio of the numerator to the pre-computed denominator.\n6.  **Optimal Parameter Identification**: The value $\\beta^{\\star}$ that yields the minimum $\\mathrm{NRMSE}(\\beta)$ on the grid is identified. This $\\beta^{\\star}$ is our approximation of the optimal parameter. The corresponding minimum error is $\\mathrm{NRMSE}(\\beta^{\\star})$.\n7.  **Result Aggregation**: The three calculated values—$\\mathrm{NRMSE}_{\\mathrm{lin}}$, $\\beta^{\\star}$, and $\\mathrm{NRMSE}(\\beta^{\\star})$—are collected for the current test case.\n\nThis procedure is repeated for all four test cases, and the final results are formatted into a single list as required.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem of calibrating a redshift-space distortion model\n    for the 21cm signal near an ionization bubble.\n    \"\"\"\n    # Define constants and numerical parameters from the problem statement.\n    epsilon = 0.05\n    N_r = 4001\n    beta_min = 0.0\n    beta_max = 2.0\n    N_beta = 1001  # Grid size for beta search, sufficiently fine as requested.\n\n    # Test cases as tuples of (Rb, w, eta0, d0, sigma)\n    test_cases = [\n        # Case 1: Moderate nonlinearity\n        (5.0, 0.5, 0.4, 0.3, 0.6),\n        # Case 2: Near-divergent inflow\n        (10.0, 0.4, 0.95, 0.2, 0.5),\n        # Case 3: Outflow\n        (8.0, 0.7, -0.6, 0.25, 0.8),\n        # Case 4: Sharp front\n        (12.0, 0.2, 0.8, 0.15, 0.3),\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        Rb, w, eta0, d0, sigma = case\n\n        # 1. Setup the spatial grid and radial profiles\n        r_min, r_max = Rb - 3 * w, Rb + 3 * w\n        r = np.linspace(r_min, r_max, N_r)\n        \n        # Dimensionless radial coordinate for profile functions\n        x_rel = (r - Rb) / w\n        \n        # Neutral fraction profile\n        x_HI = 0.5 * (1.0 + np.tanh(x_rel))\n        \n        # Overdensity profile\n        delta = d0 * np.exp(-(r - Rb)**2 / (2.0 * sigma**2))\n        \n        # Dimensionless velocity gradient profile\n        eta = eta0 * (1.0 / np.cosh(x_rel))**2\n\n        # 2. Define the Jacobian factor models\n        # Clipped model (the \"truth\" to be fitted)\n        J_clip = 1.0 / np.maximum(1.0 - eta, epsilon)\n        # Linear approximation model\n        J_lin = 1.0 + eta\n        \n        # 3. Calculate the common weighting factor for the integrals.\n        # The normalization T0 cancels in the NRMSE ratio.\n        weight = (x_HI * (1.0 + delta))**2\n        \n        # 4. Calculate the denominator for NRMSE, which is constant for a given case.\n        # This is the integral over the squared \"truth\" signal.\n        integrand_den = (J_clip**2) * weight\n        integral_den = np.trapz(integrand_den, r)\n\n        # 5. Calculate NRMSE for the linear model\n        integrand_num_lin = ((J_lin - J_clip)**2) * weight\n        integral_num_lin = np.trapz(integrand_num_lin, r)\n        nrmse_lin = np.sqrt(integral_num_lin / integral_den)\n        \n        # 6. Find optimal beta and the corresponding minimum NRMSE via grid search\n        beta_grid = np.linspace(beta_min, beta_max, N_beta)\n        nrmse_corr_values = np.zeros_like(beta_grid)\n        \n        for i, b in enumerate(beta_grid):\n            # Corrected model with the current beta value\n            J_corr = 1.0 / (1.0 - eta + b * eta**2)\n            \n            # Calculate the numerator of NRMSE for this beta\n            integrand_num_corr = ((J_corr - J_clip)**2) * weight\n            integral_num_corr = np.trapz(integrand_num_corr, r)\n            \n            # Store the resulting NRMSE\n            nrmse_corr_values[i] = np.sqrt(integral_num_corr / integral_den)\n            \n        # Find the minimum NRMSE and the beta that produced it\n        min_idx = np.argmin(nrmse_corr_values)\n        beta_star = beta_grid[min_idx]\n        nrmse_corr_star = nrmse_corr_values[min_idx]\n        \n        # 7. Append the results for the current case to the main list\n        all_results.extend([nrmse_lin, beta_star, nrmse_corr_star])\n\n    # 8. Format and print the final output as a single line\n    print(f\"[{','.join(f'{x:.6f}' for x in all_results)}]\")\n\nsolve()\n```"
        }
    ]
}