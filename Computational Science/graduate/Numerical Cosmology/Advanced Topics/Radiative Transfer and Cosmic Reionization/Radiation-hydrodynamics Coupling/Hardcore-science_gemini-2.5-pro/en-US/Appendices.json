{
    "hands_on_practices": [
        {
            "introduction": "The tight coupling between radiation and matter is a source of extreme numerical stiffness. In dense regions, the timescale for gas to reach thermal equilibrium with the radiation field can be many orders of magnitude shorter than the dynamical or light-crossing timescales. This practice guides you through the construction of an L-stable implicit solver , a cornerstone technique for handling such stiff source terms without being constrained by prohibitively small time steps.",
            "id": "3482949",
            "problem": "Consider grey radiation-hydrodynamics coupling in a homogeneous cell in numerical cosmology, where the radiation energy density $E_r$ and the matter internal energy density $u$ exchange energy through isotropic emission and absorption. Assume the grey (frequency-integrated) Planck mean opacity $\\kappa_P$ and adopt an ideal-gas closure for the matter such that $u = \\rho c_v T$, where $\\rho$ is the mass density, $c_v$ is the specific heat at constant volume, and $T$ is the temperature. The radiation energy density $E_r$ obeys the coupling through the Planck source proportional to $a_r T^4$, where $a_r$ is the radiation constant, and the coupling is scaled by the speed of light $c$. The fundamental continuous coupling laws are\n$$\n\\frac{dE_r}{dt} = c\\,\\kappa_P\\left(a_r T^4 - E_r\\right) + \\text{(non-stiff terms)},\n$$\n$$\n\\frac{du}{dt} = -\\,c\\,\\kappa_P\\left(a_r T^4 - E_r\\right) + \\text{(non-stiff terms)},\n$$\nwith $T = \\frac{u}{\\rho c_v}$.\n\nYour task is to construct a time integrator that treats the stiff radiation-matter source term implicitly and the remaining non-stiff terms explicitly, i.e., an Implicit-Explicit (IMEX) method. The implicit part must be $L$-stable. You shall:\n\n- Start from the above laws and split the right-hand side into a stiff source $S(\\cdot)$ and a non-stiff part $N(\\cdot)$, each defined in terms of the variables $E_r$ and $u$ and parameters $\\rho$, $c_v$, $\\kappa_P$, $a_r$, and $c$.\n- Design a single-step IMEX time discretization that is $L$-stable on the implicit part (the stiff source $S(\\cdot)$), and explain how $L$-stability is ensured in the implicit sub-step for linearized dynamics.\n- Derive the nonlinear algebraic system for the stiff sub-step over one time step of size $\\Delta t$ when the non-stiff part is set to zero (i.e., for this exercise, the explicit term $N(\\cdot)$ is zero), and outline a Newton–Raphson iteration to solve this system. In particular, provide a linearization of the Planck source $a_r T^4$ with respect to $E_r$ and $u$ and construct the associated Jacobian entries needed by Newton’s method.\n\nYou must implement a self-contained program that performs one IMEX step for the stiff source-only coupling (i.e., with the explicit part set to zero) using your derived $L$-stable implicit method and Newton linearization for the Planck source. Use dimensionless code units (no physical units) and ensure positivity of $E_r$ and $u$ in the iteration. The program must compute and return the updated values $\\left[E_r^{n+1},u^{n+1}\\right]$ for each test case below.\n\nTest suite (each tuple lists $\\left(\\rho, c_v, \\kappa_P, a_r, c, \\Delta t, E_r^n, u^n\\right)$):\n\n- Case $1$ (equilibrium consistency): $\\left(1.0, 1.0, 100.0, 1.0, 1.0\\times 10^5, 1.0\\times 10^{-3}, 1.0, 1.0\\right)$.\n- Case $2$ (stiff relaxation, radiation-dominated initial state): $\\left(1.0, 1.0, 1000.0, 1.0, 1.0\\times 10^5, 1.0\\times 10^{-3}, 10.0, 0.1\\right)$.\n- Case $3$ (weak coupling, near-non-stiff): $\\left(1.0, 1.0, 1.0\\times 10^{-3}, 1.0, 10.0, 1.0\\times 10^{-2}, 1.5, 1.0\\right)$.\n- Case $4$ (zero opacity, no change): $\\left(1.0, 1.0, 0.0, 1.0, 1.0\\times 10^5, 1.0\\times 10^{-3}, 2.0, 3.0\\right)$.\n- Case $5$ (extremely stiff step, large $\\Delta t$): $\\left(1.0, 1.0, 100.0, 1.0, 1.0\\times 10^5, 1.0\\times 10^{-1}, 0.2, 5.0\\right)$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each element is the list $\\left[E_r^{n+1},u^{n+1}\\right]$ for the corresponding test case in the order given above. For example, the output format must be\n$$\n\\left[\\left[E_1,u_1\\right],\\left[E_2,u_2\\right],\\left[E_3,u_3\\right],\\left[E_4,u_4\\right],\\left[E_5,u_5\\right]\\right],\n$$\nwith each $E_i$ and $u_i$ represented as floating-point numbers in code units. No angles are involved. Express all quantities in dimensionless code units.",
            "solution": "The problem requires the design and implementation of a numerical method to solve the stiff coupling equations for radiation energy density, $E_r$, and matter internal energy density, $u$, in a homogeneous cell. The method must be an Implicit-Explicit (IMEX) scheme where the stiff source terms are handled implicitly with an $L$-stable method.\n\n### Step 1: Problem Validation\n\n**Extraction of Givens:**\n*   **State Variables**: Radiation energy density $E_r$, matter internal energy density $u$.\n*   **Parameters**: Constant mass density $\\rho$, constant specific heat at constant volume $c_v$, grey Planck mean opacity $\\kappa_P$, radiation constant $a_r$, and the speed of light $c$.\n*   **Equation of State / Closure**: The matter is an ideal gas, so its temperature $T$ is related to its internal energy density $u$ by $u = \\rho c_v T$, which gives $T = u / (\\rho c_v)$.\n*   **Continuous Coupling Laws**: The time evolution of the state variables is governed by the system of ordinary differential equations (ODEs):\n    $$\n    \\frac{dE_r}{dt} = c\\,\\kappa_P\\left(a_r T^4 - E_r\\right) + \\text{(non-stiff terms)}\n    $$\n    $$\n    \\frac{du}{dt} = -\\,c\\,\\kappa_P\\left(a_r T^4 - E_r\\right) + \\text{(non-stiff terms)}\n    $$\n\n**Validation Using Extracted Givens:**\n1.  **Scientifically Grounded**: The problem describes the fundamental process of energy exchange between matter and radiation via thermal emission and absorption, a core concept in radiation hydrodynamics and astrophysics. The use of the Planck function $a_r T^4$ as the source for thermal radiation and the ideal gas law are standard, well-established physical models. The problem is scientifically sound.\n2.  **Well-Posed**: This is a standard initial value problem for a system of two coupled ODEs. The coupling term ensures energy conservation ($d(E_r+u)/dt=0$ for the stiff part), which leads to a stable physical equilibrium. The problem is well-posed.\n3.  **Objective**: The problem is stated in precise, formal, and unbiased scientific language.\n4.  **Complete and Consistent**: All necessary parameters ($\\rho, c_v, \\kappa_P, a_r, c$) and initial conditions ($E_r^n, u^n$) are provided for solving the specified task. The task specifically instructs to set the \"non-stiff terms\" to zero, resolving any ambiguity. No contradictions are present.\n\n**Verdict:** The problem is valid and self-contained. A solution can be constructed.\n\n### Step 2: Design of an L-Stable Implicit-Explicit (IMEX) Time Integrator\n\n**Splitting the System into Stiff and Non-Stiff Parts**\n\nLet the state vector be $\\mathbf{Y} = [E_r, u]^T$. The system of ODEs can be written in the form $\\frac{d\\mathbf{Y}}{dt} = \\mathbf{S}(\\mathbf{Y}) + \\mathbf{N}(\\mathbf{Y})$. The stiff source term, $\\mathbf{S}(\\mathbf{Y})$, arises from the matter-radiation coupling, which can occur on very short timescales when the opacity $\\kappa_P$ is large. The non-stiff part, $\\mathbf{N}(\\mathbf{Y})$, comprises all other terms, which for this problem are set to zero.\n\nThe stiff source term is:\n$$\n\\mathbf{S}(\\mathbf{Y}) = \\begin{pmatrix} S_1(E_r, u) \\\\ S_2(E_r, u) \\end{pmatrix} = \\begin{pmatrix} c\\,\\kappa_P\\left(a_r T(u)^4 - E_r\\right) \\\\ -c\\,\\kappa_P\\left(a_r T(u)^4 - E_r\\right) \\end{pmatrix}\n$$\nwhere $T(u) = u / (\\rho c_v)$. The non-stiff part is $\\mathbf{N}(\\mathbf{Y}) = \\mathbf{0}$.\n\nA crucial property of the source term is that it conserves total energy: $S_1 + S_2 = 0$, which implies $\\frac{d}{dt}(E_r + u) = 0$ for the stiff exchange part.\n\n**IMEX Discretization and L-Stability**\n\nA first-order IMEX scheme (IMEX-Euler) discretizes the system as:\n$$\n\\frac{\\mathbf{Y}^{n+1} - \\mathbf{Y}^n}{\\Delta t} = \\mathbf{S}(\\mathbf{Y}^{n+1}) + \\mathbf{N}(\\mathbf{Y}^n)\n$$\nSince $\\mathbf{N}(\\mathbf{Y})$ is set to zero, this reduces to the fully implicit Backward Euler method for the stiff source term:\n$$\n\\mathbf{Y}^{n+1} = \\mathbf{Y}^n + \\Delta t \\, \\mathbf{S}(\\mathbf{Y}^{n+1})\n$$\nThis choice of implicit method must be $L$-stable. To verify this, we consider the linear test equation $\\dot{y} = \\lambda y$, where $\\lambda \\in \\mathbb{C}$ and $\\text{Re}(\\lambda)  0$. The Backward Euler method gives $y^{n+1} = y^n + \\Delta t \\lambda y^{n+1}$, leading to the amplification factor $R(z) = y^{n+1}/y^n = (1-z)^{-1}$, where $z = \\lambda \\Delta t$. $L$-stability requires that $\\lim_{\\text{Re}(z) \\to -\\infty} |R(z)| = 0$. For the Backward Euler method,\n$$\n\\lim_{z \\to -\\infty} \\left| \\frac{1}{1-z} \\right| = 0\n$$\nThus, the Backward Euler method is $L$-stable. This property guarantees that for very stiff components (where $|\\lambda \\Delta t| \\gg 1$), the numerical solution is strongly damped towards equilibrium, preventing spurious oscillations and allowing for large time steps $\\Delta t$.\n\n### Step 3: Newton-Raphson Iteration for the Implicit Sub-step\n\nThe Backward Euler step requires solving the following nonlinear algebraic system for the unknown state $\\mathbf{Y}^{n+1} = [E_r^{n+1}, u^{n+1}]^T$:\n$$\n\\mathbf{F}(\\mathbf{Y}^{n+1}) \\equiv \\mathbf{Y}^{n+1} - \\mathbf{Y}^n - \\Delta t \\, \\mathbf{S}(\\mathbf{Y}^{n+1}) = \\mathbf{0}\n$$\nWe solve this system using the Newton-Raphson method. Let $\\mathbf{Y}_k$ be the $k$-th iterative guess for $\\mathbf{Y}^{n+1}$. The update $\\Delta \\mathbf{Y}_k = \\mathbf{Y}_{k+1} - \\mathbf{Y}_k$ is found by solving the linear system:\n$$\n\\mathbf{J}(\\mathbf{Y}_k) \\Delta\\mathbf{Y}_k = -\\mathbf{F}(\\mathbf{Y}_k)\n$$\nwhere $\\mathbf{J}(\\mathbf{Y}_k)$ is the Jacobian matrix of $\\mathbf{F}$ evaluated at $\\mathbf{Y}_k$. The Jacobian is given by $\\mathbf{J} = \\frac{\\partial \\mathbf{F}}{\\partial \\mathbf{Y}} = \\mathbf{I} - \\Delta t \\frac{\\partial \\mathbf{S}}{\\partial \\mathbf{Y}}$, where $\\mathbf{I}$ is the $2 \\times 2$ identity matrix.\n\n**Linearization of the Planck Source and Jacobian Construction**\n\nTo find the Jacobian of the source, $\\mathbf{J}_S = \\frac{\\partial \\mathbf{S}}{\\partial \\mathbf{Y}}$, we linearize the Planck source term $a_r T^4$ with respect to $E_r$ and $u$.\nThe Planck source $B(T) = a_r T^4$ depends only on $u$ through $T(u) = u/(\\rho c_v)$.\n*   Linearization with respect to $E_r$:\n    $$\n    \\frac{\\partial B(T(u))}{\\partial E_r} = 0\n    $$\n*   Linearization with respect to $u$:\n    $$\n    \\frac{\\partial B(T(u))}{\\partial u} = \\frac{dB}{dT} \\frac{\\partial T}{\\partial u} = \\left(4 a_r T^3\\right) \\left(\\frac{1}{\\rho c_v}\\right) = \\frac{4 a_r T^3}{\\rho c_v}\n    $$\nThe partial derivatives of the source vector $\\mathbf{S}$ are:\n$$\n\\frac{\\partial S_1}{\\partial E_r} = \\frac{\\partial}{\\partial E_r} \\left[c\\,\\kappa_P\\left(a_r T^4 - E_r\\right)\\right] = -c\\,\\kappa_P\n$$\n$$\n\\frac{\\partial S_1}{\\partial u} = \\frac{\\partial}{\\partial u} \\left[c\\,\\kappa_P\\left(a_r T^4 - E_r\\right)\\right] = c\\,\\kappa_P \\frac{\\partial (a_r T^4)}{\\partial u} = \\frac{4 c\\,\\kappa_P a_r T^3}{\\rho c_v}\n$$\nSince $S_2 = -S_1$, we have $\\frac{\\partial S_2}{\\partial E_r} = c\\,\\kappa_P$ and $\\frac{\\partial S_2}{\\partial u} = -\\frac{4 c\\,\\kappa_P a_r T^3}{\\rho c_v}$.\nLet's define the term $\\alpha = \\frac{4 c\\,\\kappa_P a_r T^3}{\\rho c_v}$. The Jacobian of the source is:\n$$\n\\mathbf{J}_S = \\frac{\\partial \\mathbf{S}}{\\partial \\mathbf{Y}} = \\begin{pmatrix} -c\\,\\kappa_P  \\alpha \\\\ c\\,\\kappa_P  -\\alpha \\end{pmatrix}\n$$\nThe full Jacobian for the Newton iteration is:\n$$\n\\mathbf{J} = \\mathbf{I} - \\Delta t \\, \\mathbf{J}_S = \\begin{pmatrix} 1 + \\Delta t c\\,\\kappa_P  -\\Delta t \\alpha \\\\ -\\Delta t c\\,\\kappa_P  1 + \\Delta t \\alpha \\end{pmatrix}\n$$\n\n**Simplified 1D Newton-Raphson Solver**\n\nAs noted, the stiff source conserves total energy. Summing the two equations in the Backward Euler system gives:\n$(E_r^{n+1} - E_r^n) + (u^{n+1} - u^n) = \\Delta t (S_1 + S_2) = 0$.\nThis implies $E_r^{n+1} + u^{n+1} = E_r^n + u^n$. Let $C_{tot} = E_r^n + u^n$ be the constant total energy.\nWe can eliminate $E_r^{n+1} = C_{tot} - u^{n+1}$ and reduce the $2 \\times 2$ system to a single non-linear equation for $x = u^{n+1}$:\n$$\ng(x) \\equiv x - u^n - \\Delta t \\left[-c\\,\\kappa_P\\left(a_r \\left(\\frac{x}{\\rho c_v}\\right)^4 - (C_{tot} - x)\\right)\\right] = 0\n$$\n$$\ng(x) = x - u^n + \\Delta t \\, c\\,\\kappa_P\\left(a_r \\left(\\frac{x}{\\rho c_v}\\right)^4 + x - C_{tot}\\right) = 0\n$$\nThis scalar equation can be solved efficiently with Newton's method: $x_{k+1} = x_k - g(x_k)/g'(x_k)$. The derivative $g'(x)$ is:\n$$\ng'(x) = 1 + \\Delta t \\, c\\,\\kappa_P\\left(a_r \\frac{4 x^3}{(\\rho c_v)^4} + 1\\right) = 1 + \\Delta t \\left(\\frac{4 c\\,\\kappa_P a_r T^3}{\\rho c_v} + c\\,\\kappa_P\\right) = 1 + \\Delta t(\\alpha + c\\,\\kappa_P)\n$$\n(Note: $T$ is computed using $x$). This is precisely the determinant of the $2 \\times 2$ Jacobian $\\mathbf{J}$, highlighting the equivalence of the methods.\nThe iteration starts with an initial guess $x_0 = u^n$. To ensure physical solutions, we enforce positivity for $u$ and $E_r$. Since $u^{n+1} \\in (0, C_{tot})$, if a Newton step $x_{k+1}$ falls outside this range, a backtracking line search (e.g., step halving) is applied to the update until the new guess is valid.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve the radiation-matter coupling problem\n    for a suite of test cases.\n    \"\"\"\n\n    # Test suite from the problem statement.\n    # Each tuple: (rho, cv, kappa_P, ar, c, dt, Er_n, u_n)\n    test_cases = [\n        (1.0, 1.0, 100.0, 1.0, 1.0e5, 1.0e-3, 1.0, 1.0),\n        (1.0, 1.0, 1000.0, 1.0, 1.0e5, 1.0e-3, 10.0, 0.1),\n        (1.0, 1.0, 1.0e-3, 1.0, 10.0, 1.0e-2, 1.5, 1.0),\n        (1.0, 1.0, 0.0, 1.0, 1.0e5, 1.0e-3, 2.0, 3.0),\n        (1.0, 1.0, 100.0, 1.0, 1.0e5, 1.0e-1, 0.2, 5.0),\n    ]\n\n    results = []\n    for case in test_cases:\n        rho, cv, kappa_P, ar, c, dt, Er_n, u_n = case\n        Er_np1, u_np1 = perform_implicit_step(rho, cv, kappa_P, ar, c, dt, Er_n, u_n)\n        results.append([Er_np1, u_np1])\n\n    # Custom string formatting to match the required output format.\n    result_str = \"[\" + \",\".join([f\"[{e:.7e},{u:.7e}]\" for e, u in results]) + \"]\"\n    print(result_str)\n\n\ndef perform_implicit_step(rho, cv, kappa_P, ar, c, dt, Er_n, u_n):\n    \"\"\"\n    Performs one implicit Backward Euler step for the stiff source term\n    using a 1D Newton-Raphson solver.\n\n    Args:\n        rho (float): Mass density.\n        cv (float): Specific heat at constant volume.\n        kappa_P (float): Planck mean opacity.\n        ar (float): Radiation constant.\n        c (float): Speed of light.\n        dt (float): Time step size.\n        Er_n (float): Radiation energy density at time n.\n        u_n (float): Matter internal energy density at time n.\n\n    Returns:\n        tuple[float, float]: The updated state (Er_np1, u_np1).\n    \"\"\"\n\n    # If opacity is zero, there is no coupling, so no change.\n    if kappa_P == 0.0:\n        return Er_n, u_n\n\n    # Total energy is conserved by the source term.\n    total_energy = Er_n + u_n\n\n    # Initial guess for u_np1 is u_n.\n    u_k = float(u_n)\n\n    # Newton-Raphson solver parameters\n    max_iter = 50\n    tol = 1.0e-12\n\n    for _ in range(max_iter):\n        # Ensure positivity of u_k. This should be handled by the line search,\n        # but as a safeguard, we floor it at a small positive number.\n        if u_k = 0:\n            u_k = tol * 1e-3 # small positive value\n\n        # The state at iteration k must be within physical bounds\n        # u must be positive, and Er = total_energy - u must be positive.\n        u_k = min(max(u_k, tol), total_energy - tol)\n\n        # Calculate a_r * T^4 and its derivative with respect to u.\n        # T = u / (rho * cv)\n        # Using np.isclose to handle potential zero denominators safely.\n        if np.isclose(rho * cv, 0.0):\n            temp_term_u = 0.0\n            deriv_term_u = 0.0\n        else:\n            inv_rho_cv = 1.0 / (rho * cv)\n            T_k = u_k * inv_rho_cv\n            T_k_3 = T_k**3\n            T_k_4 = T_k * T_k_3\n            \n            temp_term_u = ar * T_k_4\n            deriv_term_u = 4.0 * ar * T_k_3 * inv_rho_cv\n\n        # Define the residual function g(u_k) for the 1D Newton solver.\n        # g(x) = x - u_n + dt*c*kappa_P*(ar*(x/(rho*cv))^4 + x - total_energy) = 0\n        g = u_k - u_n + dt * c * kappa_P * (temp_term_u + u_k - total_energy)\n        \n        # Check for convergence based on the residual norm\n        if abs(g)  tol:\n            break\n\n        # Define the derivative of the residual function, g'(u_k).\n        # g'(x) = 1 + dt*c*kappa_P*(4*ar*x^3/(rho*cv)^4 + 1)\n        g_prime = 1.0 + dt * c * kappa_P * (deriv_term_u + 1.0)\n        \n        # Calculate Newton step\n        delta_u = -g / g_prime\n\n        # Backtracking line search to enforce positivity of u and Er\n        lambda_step = 1.0\n        while True:\n            u_trial = u_k + lambda_step * delta_u\n            if u_trial > 0 and u_trial  total_energy:\n                u_k = u_trial\n                break\n            lambda_step *= 0.5\n            if lambda_step  1.0e-8: # Failsafe to prevent infinite loops\n                # If step is too small, just accept the last valid state\n                break\n        \n        if abs(lambda_step * delta_u)  tol * (1.0 + abs(u_k)):\n             break\n    \n    # After convergence, u_np1 is u_k\n    u_np1 = u_k\n    # Er_np1 is determined by energy conservation\n    Er_np1 = total_energy - u_np1\n\n    return Er_np1, u_np1\n\nif __name__ == '__main__':\n    solve()\n```"
        },
        {
            "introduction": "While implicit methods solve the stiffness of local source terms, explicit radiative transport schemes face another hurdle: the Courant-Friedrichs-Lewy (CFL) condition imposed by the speed of light, $c$. The reduced speed-of-light approximation (RSLA) is a widely used technique to relax this constraint by replacing $c$ with a smaller $c_{\\rm red}$. This exercise  provides a quantitative exploration of the errors introduced by RSLA, helping you build an intuition for its impact on I-front propagation and radiation pressure in both optically thin and thick regimes.",
            "id": "3482963",
            "problem": "You are to quantify the numerical error introduced by the reduced speed-of-light approximation, defined by a reduced speed $c_{\\rm red}$ with $0  c_{\\rm red}  c$, on three coupled radiation-hydrodynamics observables central to numerical cosmology: the ionization front speed, the radiation pressure, and a radiation-modified shock indicator, across optically thin (streaming) and optically thick (diffusive) regimes. Your derivation and implementation must start from first principles and well-tested formulas and be scientifically consistent.\n\nStart from the following fundamentals, definitions, and closures in one spatial dimension under gray radiation:\n- Radiation energy density $E$ and radiation flux $F$ satisfy the moment equations closed by the Eddington factor. In the optically thin streaming limit, $F$ approaches $c E$ along the ray direction and the radiation pressure $P_r$ approaches $E$. In the optically thick diffusive limit, flux follows Fick’s law $F \\approx -D \\,\\partial_x E$ with diffusion coefficient $D = \\frac{c}{3 \\kappa \\rho}$ for absorption opacity $\\kappa$ and mass density $\\rho$, and the radiation pressure closure is $P_r \\approx \\frac{E}{3}$.\n- The ionization front (I-front) speed $v_I$ in a uniform hydrogen medium with number density $n_{\\rm H}$ can be estimated at early times by balancing the photon number flux $\\Phi_\\gamma$ against the rate of ionizations required per unit area, with an upper bound set by the finite propagation speed. The photon number flux is $\\Phi_\\gamma = \\frac{F}{\\epsilon}$ where $\\epsilon$ is the mean ionizing photon energy. The reduced speed-of-light (RSLA) replaces $c$ by $c_{\\rm red}$ in the radiative transport terms.\n- Gas pressure is $P_g = n_g k_{\\rm B} T$ for gas number density $n_g$, Boltzmann constant $k_{\\rm B}$, and temperature $T$. For pure atomic hydrogen gas, take $n_g = n_{\\rm H}$ and $\\rho = n_{\\rm H} m_p$ with proton mass $m_p$.\n- Define an upstream radiation-modified shock indicator $\\Theta$ as the fraction of total upstream pressure due to radiation, $\\Theta = \\frac{P_r}{P_r + P_g}$, which is a dimensionless measure of the relative importance of radiation pressure in modifying shock structure.\n\nYour tasks:\n- Derive, from the above fundamentals, formulas for the streaming and diffusive regimes that allow computing:\n  - The true ionization front speed $v_I^{\\rm true}$ with $c$, and the RSLA ionization front speed $v_I^{\\rm red}$ with $c_{\\rm red}$.\n  - The true radiation pressure $P_r^{\\rm true}$ and RSLA radiation pressure $P_r^{\\rm red}$ in both regimes.\n  - The upstream shock indicator $\\Theta^{\\rm true}$ and $\\Theta^{\\rm red}$.\n- From these, compute three fractional errors for each case:\n  - The fractional error in ionization front speed $\\delta_{v_I} = \\frac{v_I^{\\rm red} - v_I^{\\rm true}}{v_I^{\\rm true}}$.\n  - The fractional error in radiation pressure $\\delta_{P_r} = \\frac{P_r^{\\rm red} - P_r^{\\rm true}}{P_r^{\\rm true}}$.\n  - The fractional error in the shock indicator $\\delta_{\\Theta} = \\frac{\\Theta^{\\rm red} - \\Theta^{\\rm true}}{\\Theta^{\\rm true}}$.\n\nUse the International System of Units (SI) throughout. Velocities must be in meters per second (m/s), fluxes in watts per square meter (W/m$^2$), energies in joules (J), pressures in pascals (Pa), densities in kilograms per cubic meter (kg/m$^3$), opacities in square meters per kilogram (m$^2$/kg), lengths in meters (m), and temperatures in kelvin (K). The final outputs are dimensionless fractional errors. Use the constants $c = 2.99792458 \\times 10^8$ (m/s), $k_{\\rm B} = 1.380649 \\times 10^{-23}$ (J/K), $m_p = 1.67262192369 \\times 10^{-27}$ (kg), and $\\epsilon = 20 \\times 1.602176634 \\times 10^{-19}$ (J).\n\nImplement the following test suite of parameter sets to ensure coverage of streaming and diffusive regimes, including happy path and boundary cases. For each case, the medium is pure hydrogen so $n_g = n_{\\rm H}$ and $\\rho = n_{\\rm H} m_p$, and regime classification should be based on the optical depth $\\tau = \\kappa \\rho L$:\n- Case $1$ (streaming, saturation by $c$): $n_{\\rm H} = 10^6$ (m$^{-3}$), $F = 1.024 \\times 10^{-1}$ (W/m$^2$), $\\kappa = 4.0 \\times 10^{-2}$ (m$^2$/kg), $L = 10^9$ (m), $T = 10^4$ (K), $c_{\\rm red}/c = 10^{-2}$.\n- Case $2$ (streaming, photon-limited): $n_{\\rm H} = 10^{10}$ (m$^{-3}$), $F = 10^{-3}$ (W/m$^2$), $\\kappa = 4.0 \\times 10^{-2}$ (m$^2$/kg), $L = 10^9$ (m), $T = 10^4$ (K), $c_{\\rm red}/c = 10^{-1}$.\n- Case $3$ (diffusion, high optical depth): $n_{\\rm H} = 10^{16}$ (m$^{-3}$), $F = 10$ (W/m$^2$), $\\kappa = 4.0 \\times 10^{-2}$ (m$^2$/kg), $L = 10^{13}$ (m), $T = 10^5$ (K), $c_{\\rm red}/c = 10^{-2}$.\n- Case $4$ (streaming, boundary $\\Phi_\\gamma/n_{\\rm H} = c$): $n_{\\rm H} = 10^8$ (m$^{-3}$), $F = c \\, n_{\\rm H} \\, \\epsilon$ (W/m$^2$), $\\kappa = 4.0 \\times 10^{-2}$ (m$^2$/kg), $L = 10^9$ (m), $T = 10^4$ (K), $c_{\\rm red}/c = 3 \\times 10^{-2}$.\n\nRegime use in computation:\n- If $\\tau  10^{-2}$, treat as streaming.\n- Otherwise, treat as diffusive.\n\nYour program must compute the three fractional errors $\\delta_{v_I}$, $\\delta_{P_r}$, and $\\delta_{\\Theta}$ for each case and output them in a single line as a comma-separated list enclosed in square brackets, in the order of cases $1$ through $4$, with each case contributing three numbers in the order listed, and each number rounded to six decimal places. For example, an output format like $[x_1,y_1,z_1,x_2,y_2,z_2,x_3,y_3,z_3,x_4,y_4,z_4]$ is required on a single line with no additional text.",
            "solution": "The problem requires a quantitative analysis of the numerical error introduced by the reduced speed-of-light approximation (RSLA) in a one-dimensional radiation-hydrodynamics context. We must derive expressions for the fractional errors in three key observables—ionization front speed ($v_I$), radiation pressure ($P_r$), and a radiation-modified shock indicator ($\\Theta$)—for both optically thin (streaming) and optically thick (diffusive) regimes. The derivation will be based on the provided first principles, followed by a numerical implementation for a specified set of test cases.\n\nFirst, we establish the physical and computational framework. The system is governed by the moment equations for radiation energy density, $E$, and flux, $F$. The RSLA consists of replacing the true speed of light, $c$, with a reduced value, $c_{\\rm red}$, where $0  c_{\\rm red}  c$, in the radiative transport terms. We will denote quantities calculated with $c$ as `true` (e.g., $v_I^{\\rm true}$) and those with $c_{\\rm red}$ as `red` (e.g., $v_I^{\\rm red}$).\n\nThe regime is determined by the optical depth, $\\tau = \\kappa \\rho L$, where $\\kappa$ is the mass absorption opacity, $\\rho$ is the mass density, and $L$ is a characteristic length scale. The medium is pure hydrogen, so $\\rho = n_{\\rm H} m_p$, where $n_{\\rm H}$ is the hydrogen number density and $m_p$ is the proton mass. Per the problem specification, the streaming regime applies if $\\tau  10^{-2}$, and the diffusive regime applies otherwise.\n\nThe gas pressure is given by the ideal gas law, $P_g = n_g k_{\\rm B} T$. For a pure hydrogen gas, the gas number density $n_g$ is identical to $n_{\\rm H}$, so $P_g = n_{\\rm H} k_{\\rm B} T$. This quantity is unaffected by the RSLA.\n\nLet us derive the necessary formulas for each regime.\n\n**1. Optically Thin (Streaming) Regime ($\\tau  10^{-2}$)**\n\nIn the streaming limit, radiation propagates freely. The closure relations are $F = cE$ and $P_r = E$.\nCombining these gives a direct relationship between radiation pressure and flux: $P_r = F/c$.\n\nTrue Quantities (using $c$):\n- Radiation Pressure: $P_r^{\\rm true} = \\frac{F}{c}$. The flux $F$ is a given parameter.\n- Ionization Front Speed: The speed of an R-type ionization front, $v_I$, is determined by the balance between the supply of ionizing photons and the speed limit of light. The photon number flux is $\\Phi_\\gamma = F/\\epsilon$, where $\\epsilon$ is the mean energy per ionizing photon. Balancing this with the rate of ionization, $v_I n_{\\rm H}$, gives a photon-limited speed of $v_{phot} = \\frac{F}{\\epsilon n_{\\rm H}}$. The front cannot outrun the photons, so its speed is capped by $c$. Thus, $v_I^{\\rm true} = \\min\\left(\\frac{F}{\\epsilon n_{\\rm H}}, c\\right)$.\n- Shock Indicator: $\\Theta^{\\rm true} = \\frac{P_r^{\\rm true}}{P_r^{\\rm true} + P_g} = \\frac{F/c}{F/c + n_{\\rm H} k_{\\rm B} T}$.\n\nRSLA-affected Quantities (using $c_{\\rm red}$):\nThe RSLA modifies the transport relation to $F = c_{\\rm red}E$. The closure $P_r = E$ is a property of anisotropic radiation and is retained.\n- RSLA Radiation Pressure: $P_r^{\\rm red} = \\frac{F}{c_{\\rm red}}$.\n- RSLA Ionization Front Speed: The photon flux is unchanged, but the propagation speed limit is now $c_{\\rm red}$. Thus, $v_I^{\\rm red} = \\min\\left(\\frac{F}{\\epsilon n_{\\rm H}}, c_{\\rm red}\\right)$.\n- RSLA Shock Indicator: $\\Theta^{\\rm red} = \\frac{P_r^{\\rm red}}{P_r^{\\rm red} + P_g} = \\frac{F/c_{\\rm red}}{F/c_{\\rm red} + n_{\\rm H} k_{\\rm B} T}$.\n\n**2. Optically Thick (Diffusive) Regime ($\\tau \\ge 10^{-2}$)**\n\nIn the diffusive limit, radiation transport is described by Fick's law, $F \\approx -D \\nabla E$, with a diffusion coefficient $D = \\frac{c\\lambda}{3} = \\frac{c}{3\\kappa\\rho}$. The closure for nearly isotropic radiation is $P_r \\approx E/3$.\nIn one dimension, we approximate the gradient as $|\\nabla E| \\approx E/L$, where $L$ is the characteristic length scale. The flux magnitude is then $F \\approx \\frac{c E}{3 \\kappa \\rho L} = \\frac{c E}{3\\tau}$. We can express the energy density in terms of the flux: $E \\approx \\frac{3 \\tau F}{c}$.\n\nTrue Quantities (using $c$):\n- Radiation Pressure: $P_r^{\\rm true} \\approx \\frac{E}{3} \\approx \\frac{\\tau F}{c}$.\n- Ionization Front Speed: The photon supply rate $v_{phot} = \\frac{F}{\\epsilon n_{\\rm H}}$ remains a key factor. However, the effective propagation speed of the radiation front is the diffusion speed, $v_{diff} \\approx D/L = \\frac{c}{3\\kappa\\rho L} = \\frac{c}{3\\tau}$. This serves as the upper bound. So, $v_I^{\\rm true} = \\min\\left(\\frac{F}{\\epsilon n_{\\rm H}}, \\frac{c}{3\\tau}\\right)$.\n- Shock Indicator: $\\Theta^{\\rm true} = \\frac{P_r^{\\rm true}}{P_r^{\\rm true} + P_g} = \\frac{\\tau F / c}{\\tau F / c + n_{\\rm H} k_{\\rm B} T}$.\n\nRSLA-affected Quantities (using $c_{\\rm red}$):\nThe RSLA modifies the diffusion coefficient to $D_{\\rm red} = \\frac{c_{\\rm red}}{3\\kappa\\rho}$.\n- RSLA Radiation Pressure: The flux-energy relation becomes $F \\approx \\frac{c_{\\rm red} E}{3\\tau}$, leading to $E \\approx \\frac{3\\tau F}{c_{\\rm red}}$. The pressure is then $P_r^{\\rm red} \\approx \\frac{E}{3} \\approx \\frac{\\tau F}{c_{\\rm red}}$.\n- RSLA Ionization Front Speed: The propagation speed limit is now the reduced diffusion speed, $v_{diff}^{\\rm red} \\approx \\frac{c_{\\rm red}}{3\\tau}$. Thus, $v_I^{\\rm red} = \\min\\left(\\frac{F}{\\epsilon n_{\\rm H}}, \\frac{c_{\\rm red}}{3\\tau}\\right)$.\n- RSLA Shock Indicator: $\\Theta^{\\rm red} = \\frac{P_r^{\\rm red}}{P_r^{\\red} + P_g} = \\frac{\\tau F / c_{\\rm red}}{\\tau F / c_{\\rm red} + n_{\\rm H} k_{\\rm B} T}$.\n\n**3. Fractional Errors**\n\nFor each case, we compute the following fractional errors:\n- $\\delta_{v_I} = \\frac{v_I^{\\rm red} - v_I^{\\rm true}}{v_I^{\\rm true}}}$\n- $\\delta_{P_r} = \\frac{P_r^{\\rm red} - P_r^{\\rm true}}{P_r^{\\rm true}}}$\n- $\\delta_{\\Theta} = \\frac{\\Theta^{\\rm red} - \\Theta^{\\rm true}}{\\Theta^{\\rm true}}}$\n\nBy inspection, the fractional error in radiation pressure is independent of the regime. Let $f = c/c_{\\rm red}$.\nIn the streaming regime, $P_r^{\\rm red} = F/c_{\\rm red} = (c/c_{\\rm red})(F/c) = f P_r^{\\rm true}$.\nIn the diffusive regime, $P_r^{\\rm red} = \\tau F/c_{\\rm red} = (c/c_{\\rm red})(\\tau F/c) = f P_r^{\\rm true}$.\nIn both regimes, we find the same simple relation for the pressure error:\n$\\delta_{P_r} = \\frac{f P_r^{\\rm true} - P_r^{\\rm true}}{P_r^{\\rm true}} = f - 1 = \\frac{c}{c_{\\rm red}} - 1$.\n\nThe error in the shock indicator can be expressed analytically as well. Let $X = P_r^{\\rm true}$ and $Y = P_g$.\n$\\Theta^{\\rm true} = \\frac{X}{X+Y}$ and $\\Theta^{\\rm red} = \\frac{fX}{fX+Y}$.\nThe fractional error is:\n$\\delta_{\\Theta} = \\frac{\\Theta^{\\rm red}}{\\Theta^{\\rm true}} - 1 = \\left(\\frac{fX}{fX+Y}\\right) \\left(\\frac{X+Y}{X}\\right) - 1 = \\frac{f(X+Y)}{fX+Y} - 1 = \\frac{fX + fY - fX - Y}{fX+Y} = \\frac{(f-1)Y}{fX+Y}$.\nThis can be rewritten in terms of $\\Theta^{\\rm true}$ as $\\delta_{\\Theta} = \\frac{(f-1)(1-\\Theta^{\\rm true})}{1+(f-1)\\Theta^{\\rm true}}$.\n\nThe error in the I-front speed, $\\delta_{v_I}$, is more complex due to the `min` function and must be evaluated on a case-by-case basis.\n\n**4. Computational Procedure for Test Cases**\n\nFor each set of parameters ($n_{\\rm H}$, $F$, $\\kappa$, $L$, $T$, $c_{\\rm red}/c$):\n1.  Define physical constants: $c = 2.99792458 \\times 10^8$ m/s, $k_{\\rm B} = 1.380649 \\times 10^{-23}$ J/K, $m_p = 1.67262192369 \\times 10^{-27}$ kg, $\\epsilon = 20 \\times 1.602176634 \\times 10^{-19}$ J.\n2.  Calculate derived parameters: $\\rho = n_{\\rm H} m_p$, $\\tau = \\kappa \\rho L$, $P_g = n_{\\rm H} k_{\\rm B} T$, and $c_{\\rm red} = (c_{\\rm red}/c) \\times c$. For case $4$, the flux $F$ must be calculated first as $F = c n_{\\rm H} \\epsilon$.\n3.  Determine the regime by comparing $\\tau$ to $10^{-2}$.\n4.  Apply the appropriate set of formulas (streaming or diffusive) to calculate $P_r^{\\rm true}$, $P_r^{\\rm red}$, $v_I^{\\rm true}$, $v_I^{\\rm red}$, $\\Theta^{\\rm true}$, and $\\Theta^{\\rm red}$.\n5.  Compute the three fractional errors $\\delta_{P_r}$, $\\delta_{v_I}$, and $\\delta_{\\Theta}$. The denominators for these fractions must be non-zero, which is guaranteed by the problem parameters.\n6.  The results are then aggregated and formatted as required.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the fractional numerical error introduced by the reduced\n    speed-of-light approximation (RSLA) on key radiation-hydrodynamics\n    observables in numerical cosmology.\n    \"\"\"\n    # Physical Constants in SI units\n    C = 2.99792458e8  # Speed of light (m/s)\n    K_B = 1.380649e-23  # Boltzmann constant (J/K)\n    M_P = 1.67262192369e-27  # Proton mass (kg)\n    EPSILON_eV = 20.0  # Mean ionizing photon energy in eV\n    e_charge = 1.602176634e-19 # Elementary charge in C\n    EPSILON = EPSILON_eV * e_charge # Mean ionizing photon energy (J)\n\n    # Test cases from the problem statement\n    # Each case is a tuple: (n_H, F_or_calc_flag, kappa, L, T, c_red_ratio)\n    # F_or_calc_flag is either the flux F or a string 'calc' for Case 4\n    test_cases = [\n        # Case 1 (streaming, saturation by c)\n        (1e6, 1.024e-1, 4.0e-2, 1e9, 1e4, 1e-2),\n        # Case 2 (streaming, photon-limited)\n        (1e10, 1e-3, 4.0e-2, 1e9, 1e4, 1e-1),\n        # Case 3 (diffusion, high optical depth)\n        (1e16, 10.0, 4.0e-2, 1e13, 1e5, 1e-2),\n        # Case 4 (streaming, boundary phi/n_H = c)\n        (1e8, 'calc', 4.0e-2, 1e9, 1e4, 3e-2),\n    ]\n\n    results = []\n\n    for case in test_cases:\n        n_H, F_val, kappa, L, T, c_red_ratio = case\n\n        # Calculate flux for Case 4\n        if F_val == 'calc':\n            F = C * n_H * EPSILON\n        else:\n            F = F_val\n\n        # Preliminiary calculations\n        rho = n_H * M_P\n        tau = kappa * rho * L\n        P_g = n_H * K_B * T\n        c_red = c_red_ratio * C\n\n        # Determine regime\n        is_streaming = tau  1e-2\n\n        if is_streaming:\n            # --- Streaming Regime ---\n            # I-front Speed\n            v_phot = F / (EPSILON * n_H)\n            v_I_true = min(v_phot, C)\n            v_I_red = min(v_phot, c_red)\n            \n            # Radiation Pressure\n            P_r_true = F / C\n            P_r_red = F / c_red\n        else:\n            # --- Diffusive Regime ---\n            # I-front Speed\n            v_phot = F / (EPSILON * n_H)\n            v_diff_true = C / (3 * tau)\n            v_diff_red = c_red / (3 * tau)\n            v_I_true = min(v_phot, v_diff_true)\n            v_I_red = min(v_phot, v_diff_red)\n\n            # Radiation Pressure\n            P_r_true = tau * F / C\n            P_r_red = tau * F / c_red\n\n        # Shock indicator (calculation is the same form for both regimes)\n        # Avoid division by zero if P_r_true + P_g is zero\n        denom_true = P_r_true + P_g\n        Theta_true = P_r_true / denom_true if denom_true != 0 else 0.0\n\n        denom_red = P_r_red + P_g\n        Theta_red = P_r_red / denom_red if denom_red != 0 else 0.0\n\n        # Calculate fractional errors\n        # Avoid division by zero if true values are zero\n        delta_vI = (v_I_red - v_I_true) / v_I_true if v_I_true != 0 else 0.0\n        delta_Pr = (P_r_red - P_r_true) / P_r_true if P_r_true != 0 else 0.0\n        delta_Theta = (Theta_red - Theta_true) / Theta_true if Theta_true != 0 else 0.0\n\n        results.extend([delta_vI, delta_Pr, delta_Theta])\n\n    # Format the final output string\n    formatted_results = [f\"{r:.6f}\" for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Practical radiation-hydrodynamics simulations involve coupling multiple physical processes, which are often handled sequentially using operator splitting. However, the discrete operators for different physics do not generally commute, leading to a splitting error that depends on the order of operations. This final practice  delves into this fundamental numerical issue by having you compare a 'Hydro→RT' scheme with an 'RT→Hydro' scheme, allowing you to directly measure the divergence in ionization fronts and energy budgets caused by the choice of operator ordering.",
            "id": "3482929",
            "problem": "Consider a one-dimensional slab of hydrogen gas of length $L$ with a monochromatic ionizing photon source at the left boundary ($x=0$). The hydrogen number density is $n_{\\mathrm{H}}(x,t)$ and the hydrogen ionized fraction is $x_{\\mathrm{HII}}(x,t) \\in [0,1]$, so the neutral fraction is $x_{\\mathrm{HI}}(x,t)=1-x_{\\mathrm{HII}}(x,t)$. The problem explores the sensitivity of operator-splitting order between the hydrodynamics and radiative transfer updates on the evolution of the ionization front and energy budgets, in the context of radiation-hydrodynamics coupling for numerical cosmology.\n\nFundamental base:\n- Radiative transfer (RT): In the gray, absorption-only limit with no scattering and a collimated beam along $+x$, the photon flux $F(x)$ satisfies the Beer–Lambert law\n$$\n\\frac{dF}{dx} = -n_{\\mathrm{HI}}(x)\\,\\sigma\\,F(x),\\quad F(0)=F_0,\n$$\nwhere $\\sigma$ is the photoionization cross section and $F_0$ is the incoming photon flux at $x=0$ in $\\mathrm{photons}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$. The solution is $F(x) = F_0 \\exp(-\\tau(x))$ with $\\tau(x) = \\int_0^x n_{\\mathrm{HI}}(x')\\,\\sigma\\,dx'$.\n- Photoionization and recombination kinetics: For hydrogen in the on-the-spot (Case B) approximation, the ionized fraction evolves via\n$$\n\\frac{dx_{\\mathrm{HII}}}{dt} = (1-x_{\\mathrm{HII}})\\,\\Gamma(x) - \\alpha_B\\,n_{\\mathrm{H}}\\,x_{\\mathrm{HII}}^2,\n$$\nwhere $\\Gamma(x)=\\sigma F(x)$ is the photoionization rate per neutral hydrogen and $\\alpha_B$ is the Case B recombination coefficient in $\\mathrm{m}^3\\,\\mathrm{s}^{-1}$.\n- Hydrodynamics (HD): Assume a prescribed velocity field with constant divergence $\\partial u/\\partial x = k$ (a uniform Hubble-like expansion if $k>0$ or compression if $k0$), so the continuity equation implies\n$$\n\\frac{dn_{\\mathrm{H}}}{dt} = -n_{\\mathrm{H}}\\,\\frac{\\partial u}{\\partial x} = -k\\,n_{\\mathrm{H}},\n$$\nyielding $n_{\\mathrm{H}}(t+\\Delta t) = n_{\\mathrm{H}}(t)\\,\\exp(-k\\,\\Delta t)$ for a time step $\\Delta t$.\n- Energy budget: Each photoionization event removes approximately the ionization energy $E_i$ from the radiation field and deposits it into the gas (neglect secondary processes), with $E_i=13.6\\,\\mathrm{eV}$ expressed in Joules as $E_i = 2.179872\\times 10^{-18}\\,\\mathrm{J}$.\n\nYou must implement a discrete operator-splitting scheme on a uniform grid with $N$ cells and spacing $\\Delta x = L/N$. At each time step $\\Delta t$, compare two operator orderings:\n1. Hydro→RT ordering: update $n_{\\mathrm{H}}$ using hydrodynamics, then update $x_{\\mathrm{HII}}$ using radiative transfer and kinetics.\n2. RT→Hydro ordering: update $x_{\\mathrm{HII}}$ using radiative transfer and kinetics, then update $n_{\\mathrm{H}}$ using hydrodynamics.\n\nThe discrete RT update should compute the optical depth in each cell via a left-to-right cumulative sum using the current $n_{\\mathrm{HI}}=n_{\\mathrm{H}}(1-x_{\\mathrm{HII}})$, then update $x_{\\mathrm{HII}}$ by explicit time stepping. Constrain $x_{\\mathrm{HII}}$ to the interval $[0,1]$ after each update. The energy deposited into the gas per time step is computed as the number of photoionizations times $E_i$, approximating the number of photoionizations per unit area in cell $i$ as\n$$\n\\Delta N_{\\mathrm{ion},i} = \\min\\left[(1-x_{\\mathrm{HII},i}),\\,\\Delta t\\,(1-x_{\\mathrm{HII},i})\\,\\Gamma_i\\right]\\, n_{\\mathrm{H},i}\\,\\Delta x,\n$$\nand the total deposited energy is $E_{\\mathrm{dep}} = \\sum_i \\Delta N_{\\mathrm{ion},i}\\,E_i$ accumulated over all steps. You may assume unit cross-sectional area for the slab.\n\nDefine the following diagnostics at the end time $T_{\\mathrm{end}}=N_{\\mathrm{steps}}\\,\\Delta t$:\n- Ionization-front morphology difference: Define the ionization front position as the largest $x$ such that $x_{\\mathrm{HII}}(x) \\ge 0.5$. If no cell reaches $x_{\\mathrm{HII}}\\ge 0.5$, take the front position as $0$. Report the absolute difference (in meters) between the two orderings.\n- $x_{\\mathrm{HII}}$ topology difference: Using a threshold $x_{\\mathrm{th}}$, form a binary mask of cells where $x_{\\mathrm{HII}}\\ge x_{\\mathrm{th}}$ and count the number of connected components (contiguous runs of True) along the one-dimensional grid for each ordering. Report the absolute difference of these component counts as an integer.\n- Energy budget divergence: Compute the relative difference in total deposited energy between the orderings,\n$$\n\\Delta_E = \\frac{\\left|E_{\\mathrm{dep}}^{\\mathrm{(Hydro\\rightarrow RT)}} - E_{\\mathrm{dep}}^{\\mathrm{(RT\\rightarrow Hydro)}}\\right|}{\\max\\left(E_{\\mathrm{dep}}^{\\mathrm{(Hydro\\rightarrow RT)}},\\,E_{\\mathrm{dep}}^{\\mathrm{(RT\\rightarrow Hydro)}}\\right)},\n$$\nreported as a dimensionless float.\n\nImplement the program to run the following test suite, with parameters specified in International System of Units (SI):\n\n- Common geometry and initial conditions for all tests:\n    - Grid cells: $N=128$\n    - Domain length: $L=1.0\\times 10^{15}\\,\\mathrm{m}$\n    - Initial hydrogen number density: $n_{\\mathrm{H},0}=1.0\\times 10^{6}\\,\\mathrm{m}^{-3}$\n    - Initial ionized fraction: $x_{\\mathrm{HII},0}=0$\n    - Ionization energy per event: $E_i=2.179872\\times 10^{-18}\\,\\mathrm{J}$\n    - Ionization-front threshold: $x_{\\mathrm{IF}}=0.5$\n    - Topology threshold: $x_{\\mathrm{th}}=0.1$\n\n- Test case A (moderate regime):\n    - Photon flux: $F_0=1.0\\times 10^{13}\\,\\mathrm{photons}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$\n    - Cross section: $\\sigma=6.0\\times 10^{-22}\\,\\mathrm{m}^2$\n    - Recombination coefficient: $\\alpha_B=2.6\\times 10^{-19}\\,\\mathrm{m}^3\\,\\mathrm{s}^{-1}$\n    - Velocity divergence: $k=1.0\\times 10^{-15}\\,\\mathrm{s}^{-1}$\n    - Time step: $\\Delta t=1.0\\times 10^{7}\\,\\mathrm{s}$\n    - Steps: $N_{\\mathrm{steps}}=500$\n\n- Test case B (large time step near stiffness):\n    - Photon flux: $F_0=1.0\\times 10^{13}\\,\\mathrm{photons}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$\n    - Cross section: $\\sigma=6.0\\times 10^{-22}\\,\\mathrm{m}^2$\n    - Recombination coefficient: $\\alpha_B=2.6\\times 10^{-19}\\,\\mathrm{m}^3\\,\\mathrm{s}^{-1}$\n    - Velocity divergence: $k=1.0\\times 10^{-15}\\,\\mathrm{s}^{-1}$\n    - Time step: $\\Delta t=5.0\\times 10^{8}\\,\\mathrm{s}$\n    - Steps: $N_{\\mathrm{steps}}=40$\n\n- Test case C (strong recombination):\n    - Photon flux: $F_0=1.0\\times 10^{13}\\,\\mathrm{photons}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$\n    - Cross section: $\\sigma=6.0\\times 10^{-22}\\,\\mathrm{m}^2$\n    - Recombination coefficient: $\\alpha_B=1.0\\times 10^{-16}\\,\\mathrm{m}^3\\,\\mathrm{s}^{-1}$\n    - Velocity divergence: $k=5.0\\times 10^{-15}\\,\\mathrm{s}^{-1}$\n    - Time step: $\\Delta t=1.0\\times 10^{8}\\,\\mathrm{s}$\n    - Steps: $N_{\\mathrm{steps}}=200$\n\n- Test case D (optically thinner, lower flux):\n    - Photon flux: $F_0=1.0\\times 10^{12}\\,\\mathrm{photons}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$\n    - Cross section: $\\sigma=1.0\\times 10^{-23}\\,\\mathrm{m}^2$\n    - Recombination coefficient: $\\alpha_B=2.6\\times 10^{-19}\\,\\mathrm{m}^3\\,\\mathrm{s}^{-1}$\n    - Velocity divergence: $k=1.0\\times 10^{-15}\\,\\mathrm{s}^{-1}$\n    - Time step: $\\Delta t=2.0\\times 10^{8}\\,\\mathrm{s}$\n    - Steps: $N_{\\mathrm{steps}}=300$\n\nYour program must compute, for each test case, the triplet:\n- Ionization-front position difference in meters (float),\n- Topology component count difference (integer),\n- Energy budget relative difference (float).\n\nFinal output format: Your program should produce a single line of output containing the results as a comma-separated Python-style list of lists, one per test case, in the order A, B, C, D. For example, the output should have the form\n$$\n\\big[ [d_{\\mathrm{IF},A},\\,\\Delta N_{\\mathrm{comp},A},\\,\\Delta_{E,A}],\\,[d_{\\mathrm{IF},B},\\,\\Delta N_{\\mathrm{comp},B},\\,\\Delta_{E,B}],\\,[d_{\\mathrm{IF},C},\\,\\Delta N_{\\mathrm{comp},C},\\,\\Delta_{E,C}],\\,[d_{\\mathrm{IF},D},\\,\\Delta N_{\\mathrm{comp},D},\\,\\Delta_{E,D}] \\big]\n$$\nwhere $d_{\\mathrm{IF}}$ is in meters, $\\Delta N_{\\mathrm{comp}}$ is an integer, and $\\Delta_E$ is dimensionless. The single-line print must exactly be this bracketed list representation.",
            "solution": "The user has provided a problem in numerical cosmology, requiring the implementation of a one-dimensional radiation-hydrodynamics simulation to study the effects of operator-splitting order.\n\n### Problem Validation\n\n**Step 1: Extract Givens**\n\n- **Physical System**: 1D slab of hydrogen gas of length $L$.\n- **Photon Source**: Monochromatic, at $x=0$, with flux $F_0$ [photons m⁻² s⁻¹].\n- **State Variables**: Hydrogen number density $n_{\\mathrm{H}}(x,t)$, ionized fraction $x_{\\mathrm{HII}}(x,t)$.\n- **Radiative Transfer (RT)**: $\\frac{dF}{dx} = -n_{\\mathrm{H}}(1-x_{\\mathrm{HII}})\\,\\sigma\\,F(x)$ with $F(0)=F_0$.\n- **Kinetics**: $\\frac{dx_{\\mathrm{HII}}}{dt} = (1-x_{\\mathrm{HII}})\\,\\Gamma(x) - \\alpha_B\\,n_{\\mathrm{H}}\\,x_{\\mathrm{HII}}^2$, where $\\Gamma(x)=\\sigma F(x)$ and $\\alpha_B$ is the recombination coefficient.\n- **Hydrodynamics (HD)**: Prescribed velocity divergence $\\frac{\\partial u}{\\partial x} = k$. Continuity equation $\\frac{dn_{\\mathrm{H}}}{dt} = -k\\,n_{\\mathrm{H}}$, which integrates to $n_{\\mathrm{H}}(t+\\Delta t) = n_{\\mathrm{H}}(t)\\,\\exp(-k\\,\\Delta t)$.\n- **Energy Budget**: Each photoionization deposits $E_i = 2.179872\\times 10^{-18}\\,\\mathrm{J}$.\n- **Numerical Method**: Operator-splitting on a uniform grid of $N$ cells with spacing $\\Delta x = L/N$.\n  - **Ordering 1**: Hydro→RT. Update $n_{\\mathrm{H}}$, then update $x_{\\mathrm{HII}}$.\n  - **Ordering 2**: RT→Hydro. Update $x_{\\mathrm{HII}}$, then update $n_{\\mathrm{H}}$.\n- **Discretization Details**:\n  - **RT**: Left-to-right cumulative sum for optical depth. Explicit time stepping for $x_{\\mathrm{HII}}$, clipped to $[0,1]$.\n  - **Energy Deposition**: Number of photoionizations per unit area in cell $i$ is $\\Delta N_{\\mathrm{ion},i} = \\min\\left[(1-x_{\\mathrm{HII},i}),\\,\\Delta t\\,(1-x_{\\mathrm{HII},i})\\,\\Gamma_i\\right]\\, n_{\\mathrm{H},i}\\,\\Delta x$. Total deposited energy is $E_{\\mathrm{dep}} = \\sum_i \\Delta N_{\\mathrm{ion},i}\\,E_i$.\n- **Diagnostics**:\n  - **Ionization Front Position Difference**: Absolute difference in the largest coordinate $x$ where $x_{\\mathrm{HII}}(x) \\ge 0.5$.\n  - **Topology Difference**: Absolute difference in the number of connected components where $x_{\\mathrm{HII}} \\ge x_{\\mathrm{th}}$.\n  - **Energy Budget Divergence**: $\\Delta_E = \\frac{\\left|E_{\\mathrm{dep}}^{\\mathrm{(Hydro\\rightarrow RT)}} - E_{\\mathrm{dep}}^{\\mathrm{(RT\\rightarrow Hydro)}}\\right|}{\\max\\left(E_{\\mathrm{dep}}^{\\mathrm{(Hydro\\rightarrow RT)}},\\,E_{\\mathrm{dep}}^{\\mathrm{(RT\\rightarrow Hydro)}}\\right)}$.\n- **Common Parameters**: $N=128$, $L=1.0\\times 10^{15}\\,\\mathrm{m}$, $n_{\\mathrm{H},0}=1.0\\times 10^{6}\\,\\mathrm{m}^{-3}$, $x_{\\mathrm{HII},0}=0$, $E_i=2.179872\\times 10^{-18}\\,\\mathrm{J}$, $x_{\\mathrm{IF}}=0.5$, $x_{\\mathrm{th}}=0.1$.\n- **Test Cases**: Four distinct sets (A, B, C, D) of parameters ($F_0, \\sigma, \\alpha_B, k, \\Delta t, N_{\\mathrm{steps}}$) are provided.\n- **Output Format**: A single-line Python-style list of lists: `[[d_IF,A, dN_comp,A, d_E,A], ...]`\n\n**Step 2: Validate Using Extracted Givens**\n\n1.  **Scientific Grounding**: The problem is well-grounded in the fundamental equations of radiation-hydrodynamics used in astrophysics, including standard models for radiative transfer, ionization kinetics, and fluid dynamics. The operator-splitting approach is a cornerstone of modern numerical methods in this field. All equations and constants are physically sound.\n2.  **Formalizability and Relevance**: The problem is precisely specified and directly pertains to a key numerical issue in computational cosmology: the impact of operator-splitting order on simulation accuracy.\n3.  **Completeness and Consistency**: The problem is self-contained. It provides all necessary initial conditions, boundary conditions ($F_0$ at $x=0$), physical constants, and numerical parameters. The discretization rules, while requiring careful interpretation, are unambiguous. For instance, the expression for $\\Delta N_{\\mathrm{ion},i}$, while complex, is equivalent to $(1-x_{\\mathrm{HII},i})\\min[1, \\Delta t \\Gamma_i] n_{\\mathrm{H},i} \\Delta x$, which is a physically motivated sub-timestep cap on ionizations. All aspects are consistent.\n4.  **Feasibility**: The parameters are within astrophysically plausible ranges, and the specified time steps, while large in some cases relative to the ionization timescale (as noted in Test Case B), are intentionally chosen to probe the robustness and error properties of the numerical scheme. This is a standard practice in numerical methods testing.\n5.  **Well-Posedness**: The problem describes an initial value problem with well-defined evolution equations. The discrete implementation is deterministic, ensuring a unique numerical solution for each splitting order, which allows for a meaningful comparison.\n6.  **Depth**: The problem is not trivial. It requires careful implementation of a coupled system and addresses a genuine challenge in computational physics concerning the non-commutativity of discrete operators, whose effects ($\\mathcal{O}(\\Delta t)$ errors) are expected to be non-zero and parameter-dependent.\n\n**Step 3: Verdict and Action**\n\nThe problem statement is **valid**. It is a well-posed, scientifically grounded, and computationally concrete task. A solution can be constructed.\n\n---\n\n### Principled Solution Design\n\nThe solution involves implementing a time-dependent simulation on a one-dimensional grid. The core of the problem is to compare two different sequences of updates—'Hydro→RT' and 'RT→Hydro'—within each time step, a technique known as operator splitting. The difference in results for the two orderings reveals the \"splitting error,\" which is a measure of how much the discretized operators fail to commute.\n\n**1. Simulation Setup**\n- A uniform grid of $N=128$ cells is defined over the domain length $L=1.0\\times 10^{15}\\,\\mathrm{m}$, yielding a cell size $\\Delta x = L/N$.\n- Two state arrays are initialized: `n_H` for hydrogen number density and `x_HII` for the ionized fraction, populated with their initial values $n_{\\mathrm{H},0}$ and $x_{\\mathrm{HII},0}$.\n\n**2. Operator Definitions**\nTwo primary operators are defined, corresponding to the physical processes:\n- **Hydrodynamics Update**: This operator evolves the hydrogen number density $n_{\\mathrm{H}}$ over a time step $\\Delta t$ according to the analytic solution of the continuity equation with constant velocity divergence $k$: $n_{\\mathrm{H}}(t+\\Delta t) = n_{\\mathrm{H}}(t)\\exp(-k\\Delta t)$.\n- **Radiative Transfer and Kinetics (RT-Kinetics) Update**: This is a composite operator that updates the ionized fraction $x_{\\mathrm{HII}}$. It involves several steps:\n    a. **Radiative Transfer**: Using the current state ($n_{\\mathrm{H}}$, $x_{\\mathrm{HII}}$), the neutral hydrogen density $n_{\\mathrm{HI}} = n_{\\mathrm{H}}(1-x_{\\mathrm{HII}})$ is computed for each cell. The optical depth of each cell, $\\tau_i = n_{\\mathrm{HI},i} \\sigma \\Delta x$, is then calculated. The photon flux $F_i$ entering each cell $i$ is found by attenuating the source flux $F_0$ by the cumulative optical depth of all preceding cells: $F_i = F_0 \\exp(-\\sum_{j=0}^{i-1} \\tau_j)$. This is efficiently done using `numpy.cumsum`.\n    b. **Rate Calculation**: The photoionization rate per neutral atom in each cell is then $\\Gamma_i = \\sigma F_i$.\n    c. **Kinetics Update**: The ionized fraction is updated using an explicit Euler step on the kinetics equation: $x_{\\mathrm{HII}}(t+\\Delta t) = x_{\\mathrm{HII}}(t) + \\Delta t \\, [ (1-x_{\\mathrm{HII}}(t))\\Gamma - \\alpha_B n_{\\mathrm{H}}(t) x_{\\mathrm{HII}}(t)^2 ]$. To ensure physical validity, the resulting $x_{\\mathrm{HII}}$ value is clipped to the interval $[0, 1]$.\n    d. **Energy Deposition Calculation**: Concurrently, the energy deposited during the time step is calculated. The number of photoionizations per unit area in each cell is limited by both the number of available neutral atoms and the ionization rate integrated over $\\Delta t$. This is captured by the given formula $\\Delta N_{\\mathrm{ion},i} = \\min\\left[1, \\Delta t \\Gamma_i\\right] (1-x_{\\mathrm{HII},i}) n_{\\mathrm{H},i} \\Delta x$. The total energy deposited in the step is $\\Delta E_{\\mathrm{dep}} = \\sum_i \\Delta N_{\\mathrm{ion},i} E_i$.\n\n**3. Time Evolution Loop**\nThe simulation proceeds for $N_{\\mathrm{steps}}$. In each step, the operators are applied based on the specified `ordering`:\n- **For `Hydro→RT`**:\n  1. Apply the hydrodynamics update to $n_{\\mathrm{H}}$.\n  2. Apply the RT-Kinetics update, using the *new* hydro-updated $n_{\\mathrm{H}}$, to find the new $x_{\\mathrm{HII}}$ and the energy deposited in the step.\n- **For `RT→Hydro`**:\n  1. Apply the RT-Kinetics update, using the *old* $n_{\\mathrm{H}}$ from the previous time step, to find the new $x_{\\mathrm{HII}}$ and energy deposition.\n  2. Apply the hydrodynamics update to the *old* $n_{\\mathrm{H}}$.\n\nThe non-commutativity arises because the density $n_{\\mathrm{H}}$ used in the RT-Kinetics update differs between the two orderings. This affects the optical depth, recombination rate, and energy deposition calculation, leading to divergent evolution paths for $x_{\\mathrm{HII}}$ and the total energy budget.\n\n**4. Diagnostics Calculation**\nAfter completing all time steps, the final state for each ordering is analyzed using the prescribed diagnostics:\n- **Ionization Front Position**: The grid cells are scanned from left to right. The position of the right edge of the last cell `i` satisfying $x_{\\mathrm{HII},i} \\ge 0.5$ is reported as the front position.\n- **Topology**: A binary mask is created by thresholding the final $x_{\\mathrm{HII}}$ profile at $x_{\\mathrm{th}}=0.1$. The number of contiguous blocks of `True` values (connected components) in this 1D mask is counted.\n- **Energy Budget**: The total accumulated deposited energy, $E_{\\mathrm{dep}}$, is used for each ordering.\n\nFinally, the absolute differences for the front position and component count, and the relative difference for the energy budget, are computed and assembled into the final output format.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef _count_components(binary_mask: np.ndarray) -> int:\n    \"\"\"\n    Counts the number of connected components (contiguous runs of True)\n    in a 1D boolean numpy array.\n    \"\"\"\n    if not np.any(binary_mask):\n        return 0\n    # Pad with False at both ends to correctly handle components at the array boundaries.\n    padded_mask = np.concatenate(([False], binary_mask, [False]))\n    # A component starts where the value changes from False to True.\n    # The difference of the integer-casted array will be +1 at these locations.\n    return int(np.sum(np.diff(padded_mask.astype(np.int8)) == 1))\n\ndef _run_simulation(params: dict, ordering: str) -> tuple[float, int, float]:\n    \"\"\"\n    Runs the 1D radiation-hydrodynamics simulation for a given operator splitting order.\n    Returns the final diagnostic values:\n    (ionization front position, topology component count, total deposited energy).\n    \"\"\"\n    # Unpack parameters for clarity\n    N, L = params['N'], params['L']\n    n_H_0, x_HII_0 = params['n_H_0'], params['x_HII_0']\n    E_i, x_IF, x_th = params['E_i'], params['x_IF'], params['x_th']\n    F0, sigma, alpha_B = params['F0'], params['sigma'], params['alpha_B']\n    k, dt, N_steps = params['k'], params['dt'], params['N_steps']\n\n    # Grid setup\n    dx = L / N\n    cell_right_edges = (np.arange(N) + 1.0) * dx\n\n    # Initialize state variables\n    n_H = np.full(N, n_H_0, dtype=float)\n    x_HII = np.full(N, x_HII_0, dtype=float)\n    total_E_dep = 0.0\n\n    # Main time evolution loop\n    for _ in range(N_steps):\n        if ordering == 'Hydro->RT':\n            # 1. Hydrodynamics Update\n            n_H_updated = n_H * np.exp(-k * dt)\n            \n            # 2. Radiative Transfer  Kinetics Update (uses hydro-updated density)\n            current_n_H_for_rt = n_H_updated\n            current_x_HII_for_rt = x_HII\n        else:  # RT->Hydro\n            # 1. Radiative Transfer  Kinetics Update (uses density from previous step)\n            current_n_H_for_rt = n_H\n            current_x_HII_for_rt = x_HII\n\n        # --- RT-Kinetics Sub-step ---\n        # Radiative Transfer: calculate photoionization rate Gamma\n        n_HI = current_n_H_for_rt * (1.0 - current_x_HII_for_rt)\n        tau_cell = n_HI * sigma * dx\n        \n        tau_cumulative_at_left_edge = np.zeros_like(tau_cell)\n        tau_cumulative_at_left_edge[1:] = np.cumsum(tau_cell[:-1])\n        \n        F_in = F0 * np.exp(-tau_cumulative_at_left_edge)\n        Gamma = sigma * F_in\n\n        # Energy Deposition: calculate energy deposited in this time step\n        num_ionizations_per_area = current_n_H_for_rt * (1.0 - current_x_HII_for_rt) * dx * np.minimum(1.0, dt * Gamma)\n        E_dep_step = np.sum(num_ionizations_per_area * E_i)\n        total_E_dep += E_dep_step\n\n        # Kinetics: update ionized fraction with explicit Euler\n        dxHII_dt = (1.0 - current_x_HII_for_rt) * Gamma - alpha_B * current_n_H_for_rt * current_x_HII_for_rt**2\n        x_HII_new = current_x_HII_for_rt + dt * dxHII_dt\n        x_HII_new = np.clip(x_HII_new, 0.0, 1.0)\n        # --- End of RT-Kinetics Sub-step ---\n\n        # Update final state for the step based on ordering\n        if ordering == 'Hydro->RT':\n            n_H = n_H_updated\n            x_HII = x_HII_new\n        else: # RT->Hydro\n            n_H = n_H * np.exp(-k * dt)\n            x_HII = x_HII_new\n\n    # --- Post-simulation Diagnostics ---\n    # 1. Ionization-front position\n    i_front_mask = np.where(x_HII >= x_IF)[0]\n    pos_front = cell_right_edges[i_front_mask[-1]] if i_front_mask.size > 0 else 0.0\n\n    # 2. Topology component count\n    num_components = _count_components(x_HII >= x_th)\n\n    return pos_front, num_components, total_E_dep\n\ndef solve():\n    \"\"\"\n    Main solver function to run the test suite and print results.\n    \"\"\"\n    COMMON_PARAMS = {\n        \"N\": 128,\n        \"L\": 1.0e15,\n        \"n_H_0\": 1.0e6,\n        \"x_HII_0\": 0.0,\n        \"E_i\": 2.179872e-18,\n        \"x_IF\": 0.5,\n        \"x_th\": 0.1,\n    }\n\n    TEST_SUITE = [\n        # Test case A (moderate regime)\n        {\"F0\": 1.0e13, \"sigma\": 6.0e-22, \"alpha_B\": 2.6e-19, \"k\": 1.0e-15, \"dt\": 1.0e7, \"N_steps\": 500},\n        # Test case B (large time step near stiffness)\n        {\"F0\": 1.0e13, \"sigma\": 6.0e-22, \"alpha_B\": 2.6e-19, \"k\": 1.0e-15, \"dt\": 5.0e8, \"N_steps\": 40},\n        # Test case C (strong recombination)\n        {\"F0\": 1.0e13, \"sigma\": 6.0e-22, \"alpha_B\": 1.0e-16, \"k\": 5.0e-15, \"dt\": 1.0e8, \"N_steps\": 200},\n        # Test case D (optically thinner, lower flux)\n        {\"F0\": 1.0e12, \"sigma\": 1.0e-23, \"alpha_B\": 2.6e-19, \"k\": 1.0e-15, \"dt\": 2.0e8, \"N_steps\": 300},\n    ]\n\n    results_all_cases = []\n    for case_params in TEST_SUITE:\n        params = {**COMMON_PARAMS, **case_params}\n        \n        # Run simulation for Hydro->RT ordering\n        pos1, comp1, E1 = _run_simulation(params, 'Hydro->RT')\n        \n        # Run simulation for RT->Hydro ordering\n        pos2, comp2, E2 = _run_simulation(params, 'RT->Hydro')\n        \n        # Calculate diagnostics\n        d_IF = abs(pos1 - pos2)\n        dN_comp = abs(comp1 - comp2)\n        \n        max_E = max(E1, E2)\n        d_E = abs(E1 - E2) / max_E if max_E > 0 else 0.0\n        \n        results_all_cases.append([d_IF, dN_comp, d_E])\n\n    # Format output string to match exact requirements (no spaces)\n    formatted_results = [f'[{r[0]},{r[1]},{r[2]}]' for r in results_all_cases]\n    output_str = f\"[{','.join(formatted_results)}]\"\n    print(output_str)\n\nsolve()\n```"
        }
    ]
}