{
    "hands_on_practices": [
        {
            "introduction": "To build a robust numerical solver for the moment equations, we must first understand their fundamental mathematical structure. This practice involves a crucial theoretical derivation of the characteristic wave speeds of the one-dimensional M1 system, which govern how information propagates . Mastering this analysis provides insight into why the M1 closure successfully captures the correct behavior in the optically thin limit and forms the theoretical basis for constructing approximate Riemann solvers.",
            "id": "3479797",
            "problem": "Consider the source-free, absorption-free radiation transport in a local Minkowski patch relevant to numerical cosmology. The angular moment equations obtained by integrating the radiative transfer equation over solid angle are the radiation energy equation and radiation momentum equation,\n$$\\partial_{t} E + \\nabla \\cdot \\boldsymbol{F} = 0,\\qquad \\partial_{t} \\boldsymbol{F} + c^{2} \\nabla \\cdot \\mathsf{P} = 0,$$\nwhere $E$ is the radiation energy density, $\\boldsymbol{F}$ is the radiation flux, $\\mathsf{P}$ is the radiation pressure tensor, and $c$ is the speed of light. In a one-dimensional setting along the $x$-direction, this reduces to\n$$\\partial_{t} E + \\partial_{x} F = 0,\\qquad \\partial_{t} F + c^{2} \\partial_{x} P_{xx} = 0,$$\nwith $F$ the $x$-component of the flux and $P_{xx}$ the $xx$-component of the pressure tensor.\n\nClose the system using the first-order maximum-entropy moment closure (M1), in which the Eddington tensor is\n$$\\mathsf{D} = \\frac{1 - \\chi}{2}\\,\\mathsf{I} + \\frac{3\\chi - 1}{2}\\,\\boldsymbol{n}\\otimes\\boldsymbol{n},$$\nwith $\\mathsf{I}$ the identity tensor, $\\boldsymbol{n} = \\boldsymbol{F}/|\\boldsymbol{F}|$ the unit flux direction, and the Eddington factor $\\chi$ specified as a function of the reduced flux $f$, defined by $f \\equiv |\\boldsymbol{F}|/(c E)$, via the Levermore–Minerbo relation\n$$\\chi(f) = \\frac{3 + 4 f^{2}}{5 + 2\\sqrt{4 - 3 f^{2}}},\\qquad 0 \\le f \\le 1.$$\nIn one dimension along the flux direction, $P_{xx} = \\chi(f)\\,E$.\n\nLinearize the system about a spatially homogeneous, steady background state $(E_{0}, F_{0})$ with reduced flux $f_{0} \\equiv |F_{0}|/(c E_{0}) \\in (0,1]$. Assume small-amplitude plane-wave perturbations and, consistent with analytic linear wave tests used to validate approximate Riemann solvers such as the Harten–Lax–van Leer (HLL) solver, treat the Eddington factor as frozen at its background value, i.e., $\\chi(f) \\approx \\chi(f_{0})$ to leading order. Derive the characteristic speeds of the resulting hyperbolic system and provide them in closed form as functions of $c$ and $f_{0}$.\n\nFinally, in the optically thin limit $f_{0} \\to 1$, discuss the consistency of your characteristic speeds with ray-tracing expectations for free-streaming radiation. Your final answer must be the two characteristic speeds written as a single row matrix. No numerical approximation is required; express your result symbolically with $c$ and $f_{0}$, and do not include units in the final boxed answer.",
            "solution": "The problem requires the derivation of the characteristic speeds for the one-dimensional moment equations of radiation transport under the M1 closure, subject to a specific linearization approximation. The system of equations is given by:\n$$\n\\partial_{t} E + \\partial_{x} F = 0\n$$\n$$\n\\partial_{t} F + c^{2} \\partial_{x} P_{xx} = 0\n$$\nwhere $E$ is the radiation energy density, $F$ is the $x$-component of the radiation flux, and $P_{xx}$ is the $xx$-component of the radiation pressure tensor. This system can be written in conservation law form, $\\partial_{t} \\mathbf{U} + \\partial_{x} \\mathbf{G}(\\mathbf{U}) = 0$, where the state vector $\\mathbf{U}$ and the flux vector $\\mathbf{G}(\\mathbf{U})$ are:\n$$\n\\mathbf{U} = \\begin{pmatrix} E \\\\ F \\end{pmatrix}, \\qquad \\mathbf{G}(\\mathbf{U}) = \\begin{pmatrix} F \\\\ c^{2} P_{xx} \\end{pmatrix}\n$$\nThe system is closed using the M1 closure relation in one dimension, which states $P_{xx} = \\chi(f)E$, where $\\chi$ is the Eddington factor and $f = |F|/(cE)$ is the reduced flux. The flux vector is therefore:\n$$\n\\mathbf{G}(\\mathbf{U}) = \\begin{pmatrix} F \\\\ c^{2} \\chi(f) E \\end{pmatrix}\n$$\nThe problem instructs us to linearize the system about a homogeneous background state $(E_{0}, F_{0})$ and to treat the Eddington factor as frozen at its background value, $\\chi_{0} = \\chi(f_{0})$, where $f_{0} = |F_{0}|/(cE_{0})$. This approximation is commonly used in constructing HLL-type numerical solvers and effectively makes the system linear for the purpose of finding the characteristic speeds. With this approximation, the pressure component becomes $P_{xx} \\approx \\chi_{0}E$. The flux vector simplifies to:\n$$\n\\mathbf{G}(\\mathbf{U}) \\approx \\begin{pmatrix} F \\\\ c^{2} \\chi_{0} E \\end{pmatrix}\n$$\nWith this linearized flux, the system of equations becomes:\n$$\n\\partial_{t} E + \\partial_{x} F = 0\n$$\n$$\n\\partial_{t} F + c^{2} \\chi_{0} \\partial_{x} E = 0\n$$\nThe characteristic speeds, $\\lambda$, of this hyperbolic system are the eigenvalues of the Jacobian matrix $\\mathbf{J} = \\frac{\\partial \\mathbf{G}}{\\partial \\mathbf{U}}$. We compute the components of $\\mathbf{J}$ as:\n$$\n\\mathbf{J} = \\begin{pmatrix} \\frac{\\partial G_{1}}{\\partial E} & \\frac{\\partial G_{1}}{\\partial F} \\\\ \\frac{\\partial G_{2}}{\\partial E} & \\frac{\\partial G_{2}}{\\partial F} \\end{pmatrix} = \\begin{pmatrix} \\frac{\\partial}{\\partial E}(F) & \\frac{\\partial}{\\partial F}(F) \\\\ \\frac{\\partial}{\\partial E}(c^{2} \\chi_{0} E) & \\frac{\\partial}{\\partial F}(c^{2} \\chi_{0} E) \\end{pmatrix}\n$$\nSince $\\chi_{0}$ is treated as a constant, the derivatives are:\n$$\n\\frac{\\partial G_{1}}{\\partial E} = 0, \\qquad \\frac{\\partial G_{1}}{\\partial F} = 1\n$$\n$$\n\\frac{\\partial G_{2}}{\\partial E} = c^{2} \\chi_{0}, \\qquad \\frac{\\partial G_{2}}{\\partial F} = 0\n$$\nThe Jacobian matrix is therefore:\n$$\n\\mathbf{J} = \\begin{pmatrix} 0 & 1 \\\\ c^{2} \\chi_{0} & 0 \\end{pmatrix}\n$$\nThe eigenvalues $\\lambda$ are found by solving the characteristic equation $\\det(\\mathbf{J} - \\lambda \\mathbf{I}) = 0$, where $\\mathbf{I}$ is the identity matrix.\n$$\n\\det \\begin{pmatrix} -\\lambda & 1 \\\\ c^{2} \\chi_{0} & -\\lambda \\end{pmatrix} = (-\\lambda)(-\\lambda) - (1)(c^{2} \\chi_{0}) = \\lambda^{2} - c^{2} \\chi_{0} = 0\n$$\nThis yields $\\lambda^{2} = c^{2} \\chi_{0}$, and the two characteristic speeds are:\n$$\n\\lambda_{\\pm} = \\pm c \\sqrt{\\chi_{0}}\n$$\nTo express these speeds in terms of $c$ and the background reduced flux $f_{0}$, we substitute the given Levermore–Minerbo relation for the Eddington factor evaluated at $f_{0}$:\n$$\n\\chi_{0} = \\chi(f_{0}) = \\frac{3 + 4 f_{0}^{2}}{5 + 2\\sqrt{4 - 3 f_{0}^{2}}}\n$$\nThe characteristic speeds are thus:\n$$\n\\lambda_{\\pm} = \\pm c \\sqrt{\\frac{3 + 4 f_{0}^{2}}{5 + 2\\sqrt{4 - 3 f_{0}^{2}}}}\n$$\nNext, we analyze the optically thin (free-streaming) limit, where $f_{0} \\to 1$. In this limit, the radiation field is maximally anisotropic. We first evaluate the Eddington factor $\\chi_{0}$ as $f_{0} \\to 1$:\n$$\n\\lim_{f_{0} \\to 1} \\chi_{0} = \\lim_{f_{0} \\to 1} \\frac{3 + 4 f_{0}^{2}}{5 + 2\\sqrt{4 - 3 f_{0}^{2}}} = \\frac{3 + 4(1)^{2}}{5 + 2\\sqrt{4 - 3(1)^{2}}} = \\frac{7}{5 + 2\\sqrt{1}} = \\frac{7}{7} = 1\n$$\nSo, in the free-streaming limit, $\\chi_{0} \\to 1$. We can now find the characteristic speeds in this limit:\n$$\n\\lim_{f_{0} \\to 1} \\lambda_{\\pm} = \\pm c \\sqrt{\\lim_{f_{0} \\to 1} \\chi_{0}} = \\pm c \\sqrt{1} = \\pm c\n$$\nThis result is consistent with expectations from ray-tracing methods. Ray-tracing is exact in the geometric optics limit, where radiation propagates along straight lines (rays) at the speed of light, $c$. The characteristic speeds of a system of conservation laws represent the propagation speeds of small disturbances. In the free-streaming limit ($f_{0} \\to 1$), the radiation fluid behaves as a collection of photons all traveling in the same direction (or opposite directions in a 1D context). Any perturbation to this flow must also propagate at the speed of light. The fact that the characteristic speeds of the M1 system become $\\pm c$ in this limit demonstrates that the moment model correctly reproduces the fundamental propagation speed of radiation in the optically thin regime. This is a crucial physical consistency requirement for any moment-based method for radiative transfer, and the analysis confirms that the M1 closure, even with the simplifying \"frozen $\\chi$\" assumption, satisfies this test.\nThe two characteristic speeds are $\\lambda_{-} = -c \\sqrt{\\frac{3 + 4 f_{0}^{2}}{5 + 2\\sqrt{4 - 3 f_{0}^{2}}}}$ and $\\lambda_{+} = c \\sqrt{\\frac{3 + 4 f_{0}^{2}}{5 + 2\\sqrt{4 - 3 f_{0}^{2}}}}$.",
            "answer": "$$\n\\boxed{\\begin{pmatrix} -c \\sqrt{\\frac{3 + 4 f_{0}^{2}}{5 + 2\\sqrt{4 - 3 f_{0}^{2}}}} & c \\sqrt{\\frac{3 + 4 f_{0}^{2}}{5 + 2\\sqrt{4 - 3 f_{0}^{2}}}} \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "While moment-based methods are computationally efficient, they rely on an assumed closure for the radiation field's angular structure. This hands-on coding exercise challenges the M1 closure by comparing its predictions against an exact ray-tracing solution in a scenario with multiple crossing beams—a situation known to produce \"angular caustics\" . Implementing this test will provide a clear, quantitative understanding of the geometric limitations of first-order moment methods and highlight the regimes where more detailed ray-based approaches are essential.",
            "id": "3479787",
            "problem": "You are tasked with constructing and comparing the second-moment radiation anisotropy predicted by a moment-closure and by a ray-based model for three non-collinear radiation sources in vacuum. The goal is to quantify how a first-order moment closure (M1) behaves in the presence of multiple non-collinear beams that generate angular caustics, using the eigen-structure of the Eddington tensor as a diagnostic.\n\nStart from the following fundamental base. Consider the specific intensity $I(\\boldsymbol{n})$ in steady-state, optically thin vacuum. The angular moments are defined by\n$$\nE = \\frac{1}{c} \\int I(\\boldsymbol{n}) \\, d\\Omega, \\quad \\boldsymbol{F} = \\int I(\\boldsymbol{n}) \\boldsymbol{n} \\, d\\Omega, \\quad \\mathsf{P} = \\frac{1}{c} \\int I(\\boldsymbol{n}) \\boldsymbol{n}\\boldsymbol{n} \\, d\\Omega,\n$$\nwhere $E$ is the radiation energy density, $\\boldsymbol{F}$ is the radiation flux, $\\mathsf{P}$ is the radiation pressure tensor, $c$ is the speed of light, and the Eddington tensor is $\\mathsf{D} = \\mathsf{P} / E$. Define the reduced flux $f = \\|\\boldsymbol{F}\\|/(c E) \\in [0,1]$. In the M1 closure (first-order moment closure), one writes\n$$\n\\mathsf{D}_{\\mathrm{M1}} = \\frac{1 - \\chi}{2} \\mathsf{I} + \\frac{3\\chi - 1}{2} \\, \\hat{\\boldsymbol{F}} \\hat{\\boldsymbol{F}},\n$$\nwith $\\hat{\\boldsymbol{F}} = \\boldsymbol{F}/\\|\\boldsymbol{F}\\|$ for $f \\neq 0$, and $\\chi = \\chi(f)$ given by the Levermore–Minerbo expression\n$$\n\\chi(f) = \\frac{3 + 4 f^2}{5 + 2\\sqrt{4 - 3 f^2}}.\n$$\nIn the exact geometric-optics limit in vacuum for $N$ point sources, the specific intensity at a field point due to each source is confined to a delta-function beam along the line of sight, so that the ray-based Eddington tensor at a field point can be computed as\n$$\n\\mathsf{D}_{\\mathrm{ray}} = \\frac{\\sum_{i=1}^{N} w_i \\, \\boldsymbol{n}_i \\boldsymbol{n}_i}{\\sum_{i=1}^{N} w_i},\n$$\nwhere $\\boldsymbol{n}_i$ is the unit vector from the field point to source $i$, and $w_i \\propto L_i / r_i^2$ with $L_i$ the source luminosity and $r_i$ the distance from the field point to source $i$. The corresponding reduced flux can be computed as\n$$\nf = \\frac{\\left\\|\\sum_{i=1}^{N} w_i \\, \\boldsymbol{n}_i \\right\\|}{\\sum_{i=1}^{N} w_i},\n$$\nup to an overall positive constant factor that cancels out exactly in $f$ and in $\\mathsf{D}_{\\mathrm{ray}}$.\n\nYour program must implement the following tasks in strictly dimensionless form (no physical units are to be used anywhere; all quantities are to be treated as unitless):\n\n- Set up three point sources located at positions\n$$\n\\boldsymbol{s}_1 = (-1, 0, 0), \\quad \\boldsymbol{s}_2 = (1, 0, 0), \\quad \\boldsymbol{s}_3 = \\left(0, \\sqrt{3}, 0\\right),\n$$\nwith equal luminosities $L_1 = L_2 = L_3 = 1$. For any field point $\\boldsymbol{x}$, define for each source $i$ the vector $\\boldsymbol{d}_i = \\boldsymbol{s}_i - \\boldsymbol{x}$, the distance $r_i = \\|\\boldsymbol{d}_i\\|$, the unit direction $\\boldsymbol{n}_i = \\boldsymbol{d}_i / r_i$, and the weight $w_i = L_i / r_i^2$.\n\n- For each test field point, compute $\\mathsf{D}_{\\mathrm{ray}}$ and the reduced flux $f$. From $f$ and $\\hat{\\boldsymbol{F}} = \\left(\\sum_i w_i \\boldsymbol{n}_i\\right) / \\left\\|\\sum_i w_i \\boldsymbol{n}_i\\right\\|$ (for $f \\neq 0$), compute $\\mathsf{D}_{\\mathrm{M1}}$ using the M1 formula above. In the special case $f = 0$, define $\\mathsf{D}_{\\mathrm{M1}} = \\mathsf{I}/3$ and do not use $\\hat{\\boldsymbol{F}}$.\n\n- As a diagnostic for angular caustics and beam crossing, for each field point compute the Frobenius-norm discrepancy\n$$\n\\Delta = \\left\\|\\mathsf{D}_{\\mathrm{M1}} - \\mathsf{D}_{\\mathrm{ray}}\\right\\|_{\\mathrm{F}} = \\sqrt{\\mathrm{tr}\\left[\\left(\\mathsf{D}_{\\mathrm{M1}} - \\mathsf{D}_{\\mathrm{ray}}\\right)^{\\mathsf{T}}\\left(\\mathsf{D}_{\\mathrm{M1}} - \\mathsf{D}_{\\mathrm{ray}}\\right)\\right]},\n$$\nand also compute the eigenvalues of $\\mathsf{D}_{\\mathrm{ray}}$ and of $\\mathsf{D}_{\\mathrm{M1}}$, each sorted in non-increasing order.\n\nYour program should implement the above for the following test suite of field points:\n- Case $1$ (symmetric triple-beam crossing at the triangle center): $\\boldsymbol{x}^{(1)} = \\left(0, \\frac{\\sqrt{3}}{3}, 0\\right)$.\n- Case $2$ (near-single-beam dominance): $\\boldsymbol{x}^{(2)} = \\left(-\\frac{1}{2}, 0, 0\\right)$.\n- Case $3$ (two-beam opposition with a third off-axis): $\\boldsymbol{x}^{(3)} = (0, 0, 0)$.\n- Case $4$ (generic off-center point): $\\boldsymbol{x}^{(4)} = (0.2, 0.1, 0)$.\n\nFor each case $k \\in \\{1,2,3,4\\}$, define the scalar result to be the Frobenius-norm discrepancy $\\Delta^{(k)}$ between $\\mathsf{D}_{\\mathrm{M1}}$ and $\\mathsf{D}_{\\mathrm{ray}}$ at $\\boldsymbol{x}^{(k)}$, expressed as a dimensionless floating-point number. Your program must output a single line containing the list of these four results as a comma-separated list enclosed in square brackets, in the order of cases $1$ through $4$, for example $[a,b,c,d]$, where each of $a$, $b$, $c$, $d$ is a decimal representation of a floating-point number. No other text should be printed.\n\nThe test suite is designed to cover:\n- A symmetric angular-caustic case with $f = 0$ (Case $1$),\n- A near free-streaming case with $f \\approx 1$ (Case $2$),\n- A mixed crossing case with partial cancellation (Case $3$),\n- A generic off-axis configuration (Case $4$).\n\nYour implementation must be a complete, runnable program that performs all computations numerically as specified and produces the final output line in the exact format described.",
            "solution": "The problem statement has been validated and found to be scientifically grounded, well-posed, objective, and self-contained. It presents a standard and meaningful task in the field of computational radiative transfer: comparing a moment-based closure approximation (M1) with an exact ray-based solution in the geometric optics limit. All necessary definitions, equations, and parameters are provided, and there are no internal contradictions or ambiguities. The problem is therefore deemed valid, and a solution will be provided.\n\nThe objective is to compute the discrepancy between the Eddington tensor predicted by the first-order moment (M1) closure, $\\mathsf{D}_{\\mathrm{M1}}$, and the exact Eddington tensor in the ray-tracing limit, $\\mathsf{D}_{\\mathrm{ray}}$, for a system of three point sources. This discrepancy serves as a measure of the M1 closure's accuracy in scenarios involving non-collinear radiation beams.\n\nThe overall procedure for a given field point $\\boldsymbol{x}$ is as follows. We are given three sources at positions $\\boldsymbol{s}_1 = (-1, 0, 0)$, $\\boldsymbol{s}_2 = (1, 0, 0)$, and $\\boldsymbol{s}_3 = (0, \\sqrt{3}, 0)$, each with unit luminosity $L_i=1$. For each source $i \\in \\{1, 2, 3\\}$, we first compute the geometric quantities:\nThe vector from the field point to the source is $\\boldsymbol{d}_i = \\boldsymbol{s}_i - \\boldsymbol{x}$.\nThe distance is $r_i = \\|\\boldsymbol{d}_i\\|$.\nThe unit direction vector is $\\boldsymbol{n}_i = \\boldsymbol{d}_i / r_i$.\nThe weight associated with the radiation from source $i$ at point $\\boldsymbol{x}$ is $w_i = L_i / r_i^2 = 1/r_i^2$.\n\nWith these quantities, we can construct the Eddington tensors. The ray-based Eddington tensor, which is exact in this optically thin vacuum scenario, is a weighted average of the outer products of the direction vectors:\n$$\n\\mathsf{D}_{\\mathrm{ray}} = \\frac{\\sum_{i=1}^{3} w_i \\boldsymbol{n}_i \\boldsymbol{n}_i^{\\mathsf{T}}}{\\sum_{i=1}^{3} w_i}\n$$\nwhere $\\boldsymbol{n}_i \\boldsymbol{n}_i^{\\mathsf{T}}$ is the outer product.\n\nTo construct the M1 closure tensor, we first need the reduced flux, $f$. This is computed from the same weights and direction vectors:\n$$\nf = \\frac{\\left\\|\\sum_{i=1}^{3} w_i \\boldsymbol{n}_i \\right\\|}{\\sum_{i=1}^{3} w_i}\n$$\nIf $f > 0$, we define the unit flux vector $\\hat{\\boldsymbol{F}} = \\frac{\\sum w_i \\boldsymbol{n}_i}{\\|\\sum w_i \\boldsymbol{n}_i\\|}$. The M1 tensor is then given by:\n$$\n\\mathsf{D}_{\\mathrm{M1}} = \\frac{1 - \\chi(f)}{2} \\mathsf{I} + \\frac{3\\chi(f) - 1}{2} \\hat{\\boldsymbol{F}} \\hat{\\boldsymbol{F}}^{\\mathsf{T}}\n$$\nwhere $\\mathsf{I}$ is the $3 \\times 3$ identity matrix and $\\chi(f)$ is the Levermore-Minerbo Eddington factor:\n$$\n\\chi(f) = \\frac{3 + 4 f^2}{5 + 2\\sqrt{4 - 3 f^2}}\n$$\nIn the special case where the net flux is zero, i.e., $f=0$, the M1 closure defaults to the isotropic state, $\\mathsf{D}_{\\mathrm{M1}} = \\frac{1}{3}\\mathsf{I}$.\n\nThe discrepancy between the two models is quantified by the Frobenius norm of the difference between the tensors:\n$$\n\\Delta = \\left\\|\\mathsf{D}_{\\mathrm{M1}} - \\mathsf{D}_{\\mathrm{ray}}\\right\\|_{\\mathrm{F}} = \\sqrt{\\mathrm{tr}\\left[\\left(\\mathsf{D}_{\\mathrm{M1}} - \\mathsf{D}_{\\mathrm{ray}}\\right)^{\\mathsf{T}}\\left(\\mathsf{D}_{\\mathrm{M1}} - \\mathsf{D}_{\\mathrm{ray}}\\right)\\right]}\n$$\nWe now apply this procedure to the four specified field points.\n\nCase 1: Symmetric crossing at $\\boldsymbol{x}^{(1)} = \\left(0, \\frac{\\sqrt{3}}{3}, 0\\right)$.\nThis point is the centroid of the equilateral triangle formed by the three sources. The distances to all sources are equal: $r_1=r_2=r_3=2/\\sqrt{3}$. Consequently, the weights are also equal: $w_1=w_2=w_3=3/4$. The direction vectors are $\\boldsymbol{n}_1 = (-\\sqrt{3}/2, -1/2, 0)$, $\\boldsymbol{n}_2 = (\\sqrt{3}/2, -1/2, 0)$, and $\\boldsymbol{n}_3 = (0, 1, 0)$. The sum $\\sum w_i \\boldsymbol{n}_i$ is proportional to $\\sum \\boldsymbol{n}_i = \\boldsymbol{0}$, which means the reduced flux $f=0$.\nFor the ray-based tensor, we find:\n$$\n\\mathsf{D}_{\\mathrm{ray}} = \\frac{1}{3} \\sum_{i=1}^{3} \\boldsymbol{n}_i \\boldsymbol{n}_i^{\\mathsf{T}} = \\frac{1}{3} \\left( \\begin{pmatrix} 3/4 & \\sqrt{3}/4 & 0 \\\\ \\sqrt{3}/4 & 1/4 & 0 \\\\ 0 & 0 & 0 \\end{pmatrix} + \\begin{pmatrix} 3/4 & -\\sqrt{3}/4 & 0 \\\\ -\\sqrt{3}/4 & 1/4 & 0 \\\\ 0 & 0 & 0 \\end{pmatrix} + \\begin{pmatrix} 0 & 0 & 0 \\\\ 0 & 1 & 0 \\\\ 0 & 0 & 0 \\end{pmatrix} \\right) = \\begin{pmatrix} 1/2 & 0 & 0 \\\\ 0 & 1/2 & 0 \\\\ 0 & 0 & 0 \\end{pmatrix}\n$$\nThe eigenvalues of $\\mathsf{D}_{\\mathrm{ray}}$ are $(1/2, 1/2, 0)$, representing a planar-isotropic radiation field confined to the $xy$-plane, which is the correct description for three coplanar beams crossing symmetrically.\nFor the M1 closure, since $f=0$, the tensor is isotropic:\n$$\n\\mathsf{D}_{\\mathrm{M1}} = \\frac{1}{3}\\mathsf{I} = \\begin{pmatrix} 1/3 & 0 & 0 \\\\ 0 & 1/3 & 0 \\\\ 0 & 0 & 1/3 \\end{pmatrix}\n$$\nThe M1 eigenvalues are $(1/3, 1/3, 1/3)$. The M1 model fails to capture the true anisotropy of the field, incorrectly predicting full isotropy. This is a known failing of M1 at angular caustics where fluxes cancel by symmetry.\nThe discrepancy is $\\Delta^{(1)} = \\sqrt{(-1/6)^2 + (-1/6)^2 + (1/3)^2} = \\sqrt{1/36 + 1/36 + 4/36} = \\sqrt{6/36} = 1/\\sqrt{6} \\approx 0.408248$.\n\nCase 2: Near-single-beam dominance at $\\boldsymbol{x}^{(2)} = (-1/2, 0, 0)$.\nThis point is close to source 1. The weights are $w_1=4$, $w_2=4/9 \\approx 0.444$, and $w_3=4/13 \\approx 0.308$. The radiation field is dominated by source 1.\nNumerical calculation gives a reduced flux $f \\approx 0.84078$. This corresponds to a nearly free-streaming regime but with significant contributions from the other two sources.\nThe unit flux direction is $\\hat{\\boldsymbol{F}} \\approx (-0.985, 0.170, 0)$.\nThe ray-based tensor is computed as $\\mathsf{D}_{\\mathrm{ray}} \\approx \\begin{pmatrix} 0.871 & 0.038 & 0 \\\\ 0.038 & 0.036 & 0 \\\\ 0 & 0 & 0 \\end{pmatrix}$. Its eigenvalues are approximately $(0.873, 0.034, 0)$, indicating a highly anisotropic field dominated by one beam, with small perpendicular pressure components.\nWith $f \\approx 0.84078$, we get $\\chi(f) \\approx 0.7678$. The M1 tensor is then $\\mathsf{D}_{\\mathrm{M1}} \\approx \\begin{pmatrix} 0.803 & -0.143 & 0 \\\\ -0.143 & 0.140 & 0 \\\\ 0 & 0 & 0.057 \\end{pmatrix}$. Its eigenvalues, by construction, are $(\\chi, \\frac{1-\\chi}{2}, \\frac{1-\\chi}{2}) \\approx (0.768, 0.116, 0.116)$. The M1 closure correctly captures the strong anisotropy but assumes axial symmetry around the net flux vector, which is not exactly true for the three-beam configuration.\nThe discrepancy is $\\Delta^{(2)} \\approx 0.201089$.\n\nCase 3: Two-beam opposition at $\\boldsymbol{x}^{(3)} = (0, 0, 0)$.\nThis is the origin. The distances are $r_1=1$, $r_2=1$, and $r_3=\\sqrt{3}$. The weights are $w_1=1$, $w_2=1$, and $w_3=1/3$.\nThe flux from sources 1 and 2 cancels exactly along the $x$-axis. The net flux vector is $\\boldsymbol{V} = (0, 1/3, 0)$. The total weight is $W=7/3$. The reduced flux is $f = (1/3)/(7/3) = 1/7 \\approx 0.142857$. The unit flux direction is $\\hat{\\boldsymbol{F}}=(0, 1, 0)$.\nThe ray-based tensor is:\n$$\n\\mathsf{D}_{\\mathrm{ray}} = \\frac{3}{7} \\left( 1 \\cdot \\begin{pmatrix}1&0&0\\\\0&0&0\\\\0&0&0\\end{pmatrix} + 1 \\cdot \\begin{pmatrix}1&0&0\\\\0&0&0\\\\0&0&0\\end{pmatrix} + \\frac{1}{3} \\cdot \\begin{pmatrix}0&0&0\\\\0&1&0\\\\0&0&0\\end{pmatrix} \\right) = \\begin{pmatrix} 6/7 & 0 & 0 \\\\ 0 & 1/7 & 0 \\\\ 0 & 0 & 0 \\end{pmatrix}\n$$\nIts eigenvalues are $(6/7, 1/7, 0)$, representing two strong counter-propagating beams and one weaker perpendicular beam.\nFor the M1 tensor, $f=1/7$ gives $\\chi(1/7) \\approx 0.35996$. The M1 eigenvalues are $(\\chi, \\frac{1-\\chi}{2}, \\frac{1-\\chi}{2}) \\approx (0.360, 0.320, 0.320)$.\n$$\n\\mathsf{D}_{\\mathrm{M1}} = \\frac{1-\\chi}{2}\\mathsf{I} + \\frac{3\\chi-1}{2} \\begin{pmatrix}0&0&0\\\\0&1&0\\\\0&0&0\\end{pmatrix} \\approx \\begin{pmatrix} 0.320 & 0 & 0 \\\\ 0 & 0.360 & 0 \\\\ 0 & 0 & 0.320 \\end{pmatrix}\n$$\nThe M1 tensor is nearly isotropic, failing completely to capture the strong pencil-beam nature of the pressure tensor along the x-axis, where the flux is zero but the pressure is maximal.\nThe discrepancy is $\\Delta^{(3)} = \\sqrt{(6/7-0.320)^2 + (1/7-0.360)^2 + (0-0.320)^2} \\approx 0.643325$.\n\nCase 4: Generic off-center point at $\\boldsymbol{x}^{(4)} = (0.2, 0.1, 0)$.\nThis is a generic point without special symmetries. All calculations must be performed numerically.\nThe weights are $w_1 = 1/1.45 \\approx 0.690$, $w_2 = 1/0.65 \\approx 1.538$, and $w_3 = 1/(0.04 + (\\sqrt{3}-0.1)^2) \\approx 0.369$.\nThe reduced flux is numerically found to be $f \\approx 0.44391$.\nThe ray-based tensor is $\\mathsf{D}_{\\mathrm{ray}} \\approx \\begin{pmatrix} 0.589 & -0.198 & 0 \\\\ -0.198 & 0.339 & 0 \\\\ 0 & 0 & 0 \\end{pmatrix}$, with eigenvalues $(0.690, 0.238, 0)$.\nFor the M1 model, $\\chi(f) \\approx 0.4632$. The M1 tensor is $\\mathsf{D}_{\\mathrm{M1}} \\approx \\begin{pmatrix} 0.390 & -0.192 & 0 \\\\ -0.192 & 0.518 & 0 \\\\ 0 & 0 & 0.268 \\end{pmatrix}$, with eigenvalues $(0.268, 0.297, 0.611)$.\nThe discrepancy is $\\Delta^{(4)} \\approx 0.370535$.\n\nIn all cases involving beam crossing (1, 3, 4), the M1 closure shows significant deviations from the exact solution, with the largest errors occurring where flux cancellation masks strong pressure anisotropy. The model performs best in the near free-streaming case (2), as expected.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the discrepancy between M1 and ray-tracing Eddington tensors\n    for three point sources at four specified field points.\n    \"\"\"\n    # Define source positions (s_1, s_2, s_3) and luminosities\n    s_sources = np.array([\n        [-1.0, 0.0, 0.0],\n        [1.0, 0.0, 0.0],\n        [0.0, np.sqrt(3.0), 0.0]\n    ])\n    L_sources = np.array([1.0, 1.0, 1.0])\n    num_sources = len(L_sources)\n\n    # Define the test suite of field points (x_1, x_2, x_3, x_4)\n    test_points = [\n        np.array([0.0, np.sqrt(3.0) / 3.0, 0.0]),\n        np.array([-0.5, 0.0, 0.0]),\n        np.array([0.0, 0.0, 0.0]),\n        np.array([0.2, 0.1, 0.0])\n    ]\n\n    results = []\n    \n    for x_point in test_points:\n        # Step 1: Compute geometric quantities for each source\n        # d_i = s_i - x\n        d_vectors = s_sources - x_point\n        \n        # r_i = ||d_i||\n        r_distances = np.linalg.norm(d_vectors, axis=1)\n        \n        # n_i = d_i / r_i\n        # Use r_distances[:, np.newaxis] to enable broadcasting for division\n        n_vectors = d_vectors / r_distances[:, np.newaxis]\n        \n        # w_i = L_i / r_i^2\n        w_weights = L_sources / r_distances**2\n\n        # Step 2: Compute the ray-based Eddington tensor D_ray\n        W_total = np.sum(w_weights)\n        \n        D_ray_numerator = np.zeros((3, 3))\n        for i in range(num_sources):\n            D_ray_numerator += w_weights[i] * np.outer(n_vectors[i], n_vectors[i])\n        \n        D_ray = D_ray_numerator / W_total\n\n        # Step 3: Compute the M1 closure Eddington tensor D_m1\n        # V = sum(w_i * n_i)\n        V_flux_vec = np.sum(w_weights[:, np.newaxis] * n_vectors, axis=0)\n        norm_V = np.linalg.norm(V_flux_vec)\n        \n        # f = ||V|| / W_total\n        f_reduced_flux = norm_V / W_total\n        \n        # Check for the isotropic case (f=0)\n        if np.isclose(f_reduced_flux, 0.0):\n            D_m1 = np.identity(3) / 3.0\n        else:\n            # F_hat = V / ||V||\n            F_hat_direction = V_flux_vec / norm_V\n            \n            # chi(f) = (3 + 4f^2) / (5 + 2*sqrt(4 - 3f^2))\n            chi_factor = (3.0 + 4.0 * f_reduced_flux**2) / \\\n                         (5.0 + 2.0 * np.sqrt(4.0 - 3.0 * f_reduced_flux**2))\n            \n            # D_m1 = (1-chi)/2 * I + (3*chi-1)/2 * F_hat F_hat^T\n            D_m1 = (1.0 - chi_factor) / 2.0 * np.identity(3) + \\\n                   (3.0 * chi_factor - 1.0) / 2.0 * np.outer(F_hat_direction, F_hat_direction)\n\n        # Step 4: Compute the Frobenius norm discrepancy\n        # delta = ||D_m1 - D_ray||_F\n        discrepancy = np.linalg.norm(D_m1 - D_ray, 'fro')\n        results.append(discrepancy)\n\n    # Final print statement in the exact required format\n    print(f\"[{','.join(f'{r:.6f}' for r in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "The final step in mastering a numerical technique is to implement it. This practice consolidates your theoretical understanding by guiding you through the construction of a complete one-dimensional finite-volume solver for the M1 equations . You will translate the system's mathematical properties into a practical algorithm, implementing an HLL Riemann solver based on the system's characteristic speeds and confronting essential numerical challenges like stability and positivity preservation.",
            "id": "3479813",
            "problem": "You are asked to design and implement a one-dimensional finite-volume method for the grey first-order moment system (abbreviated as M1) of radiative transfer in numerical cosmology with conserved variables $(E,F)$, where $E$ is the radiation energy density and $F$ is the radiation flux. The method must use a Harten–Lax–van Leer (HLL) approximate Riemann solver with signal speeds obtained from the eigenvalues of the flux Jacobian under a specified closure. You must ensure the update preserves the positivity of $E$ and respects the physical bound $\\lvert F \\rvert \\leq c E$. Throughout, work in dimensionless units with the speed of light set to $c=1$.\n\nBegin from fundamental, well-tested principles:\n- The one-dimensional, source-free, frequency-integrated (grey) radiative moment equations are\n$$\n\\partial_t E + \\partial_x F = 0, \\qquad \\partial_t F + \\partial_x P = 0,\n$$\nwhere $P$ is the radiation pressure.\n- A moment closure is needed to express $P$ as a function of $(E,F)$. In the grey M1 framework, the pressure is given by\n$$\nP = \\chi(f)\\, E, \\qquad f = \\frac{F}{c E},\n$$\nwhere $\\chi(f)$ is the Eddington factor and $f$ is the reduced flux. In this problem $c=1$, so $f=F/E$.\n- Use the Levermore-M1 (also known as maximum-entropy Minerbo) closure, for which the Eddington factor is\n$$\n\\chi(f) = \\frac{3 + 4 f^2}{5 + 2\\sqrt{4 - 3 f^2}}, \\quad \\text{for } \\lvert f \\rvert \\leq 1.\n$$\n\nDerive from these bases the one-dimensional hyperbolic system in conservative form for the state vector $U=(E,F)^\\top$ with flux $F(U)=(F, P)^\\top$. Compute the Jacobian $A(U) = \\partial F/\\partial U$ as a function of $(E,F)$ and derive its eigenvalues $\\lambda_\\pm$ in terms of $E$, $F$, $\\chi(f)$, and $\\mathrm{d}\\chi/\\mathrm{d}f$. Use these eigenvalues to define the left and right signal speeds $(s_L,s_R)$ of the HLL flux between left and right states $(U_L,U_R)$, and assemble the HLL numerical flux. Explicitly address how to ensure the positivity of $E$ and the physical bound $\\lvert F \\rvert \\leq E$ in the discrete scheme. Use a conservative explicit update with a Courant–Friedrichs–Lewy (CFL) condition.\n\nYour program must implement:\n- A uniform grid finite-volume discretization on $[0,1]$ with periodic boundaries for all tests.\n- An explicit forward Euler time integrator with time step $\\Delta t$ satisfying an appropriate CFL condition based on the maximum absolute eigenvalue in the domain.\n- The HLL flux at each interface using signal speeds set to the minimum and maximum of the eigenvalues computed from $U_L$ and $U_R$.\n- A positivity-preserving limiter post-update that enforces $E \\ge \\varepsilon$ for a small floor $\\varepsilon > 0$ and the physical constraint $\\lvert F \\rvert \\leq E$.\n\nScientific and numerical requirements:\n- Use $c=1$ and no physical units; all quantities are dimensionless.\n- Angles do not appear; no angle unit is needed.\n- Design the scheme from first principles and write all formulas explicitly in terms of $E$, $F$, $\\chi(f)$, and $\\mathrm{d}\\chi/\\mathrm{d}f$; do not use any unmotivated shortcut formulas.\n\nTest suite:\nImplement and run the method for the following four test cases on $[0,1]$ with periodic boundaries. For each case, use a uniform grid of $N$ cells, a fixed final time $T$, and a CFL number $\\nu$:\n1. Happy-path smooth pulse:\n   - $N = 200$, $T = 0.10$, $\\nu = 0.40$,\n   - Initial condition: $E(x) = 1 + 0.1 \\exp\\big(-\\frac{(x-0.5)^2}{2 \\sigma^2}\\big)$ with $\\sigma = 0.05$, $F(x) = 0.2\\,E(x)$.\n2. Near-vacuum robustness:\n   - $N = 200$, $T = 0.05$, $\\nu = 0.40$,\n   - Initial condition: $E(x) = 10^{-6} + 10^{-3}\\,\\mathbf{1}_{\\lvert x-0.5 \\rvert < 0.1}$, $F(x) = 0$, where $\\mathbf{1}_S$ is the indicator function of set $S$.\n3. Near free-streaming:\n   - $N = 200$, $T = 0.05$, $\\nu = 0.40$,\n   - Initial condition: $E(x) = 1$, $F(x) = 0.9\\,E(x)$.\n4. Riemann-type discontinuity:\n   - $N = 200$, $T = 0.05$, $\\nu = 0.40$,\n   - Initial condition: $E(x) = 1$ for $x < 0.5$, $E(x) = 0.1$ for $x \\ge 0.5$, and $F(x) = 0$.\n\nFor each test case, run the solver to time $T$ and check both positivity and the flux bound across all cells:\n- Condition $C_1$: $\\min_i E_i(T) \\ge 0$.\n- Condition $C_2$: $\\max_i \\big(\\lvert F_i(T) \\rvert - E_i(T)\\big) \\le 0$.\nYour program must output a single boolean per test case indicating whether both $C_1$ and $C_2$ hold.\n\nFinal output format:\nYour program should produce a single line of output containing the four boolean results in order for the test cases, formatted as a comma-separated list enclosed in square brackets, for example, $[{\\rm True},{\\rm False},{\\rm True},{\\rm True}]$.",
            "solution": "The problem requires the design and implementation of a one-dimensional finite-volume method for the grey first-order moment system (M1) of radiative transfer. The solution will be constructed from first principles, starting with the governing equations and deriving all necessary components for the numerical scheme.\n\n### 1. The Grey M1 System and Closure\nThe governing equations for a source-free, one-dimensional system describe the conservation of radiation energy density $E$ and radiation flux $F$:\n$$\n\\partial_t E + \\partial_x F = 0\n$$\n$$\n\\partial_t F + \\partial_x P = 0\n$$\nwhere $P$ is the radiation pressure. This system of partial differential equations can be expressed in the conservative vector form $\\partial_t U + \\partial_x \\mathcal{F}(U) = 0$, where the state vector $U$ and the flux vector $\\mathcal{F}(U)$ are defined as:\n$$\nU = \\begin{pmatrix} E \\\\ F \\end{pmatrix}, \\qquad \\mathcal{F}(U) = \\begin{pmatrix} F \\\\ P \\end{pmatrix}\n$$\nA closure relation is necessary to express the pressure $P$ as a function of the conservative variables $E$ and $F$. The problem specifies the M1 closure, for which $P = \\chi(f) E$. The quantity $f$ is the reduced flux, defined as $f = F/(cE)$. With the speed of light set to $c=1$, this simplifies to $f=F/E$. The physical domain of the variables is constrained by $E \\ge 0$ and the fact that the flux cannot exceed the energy density, i.e., $|F| \\le E$, which corresponds to $|f| \\le 1$.\n\nThe problem specifies the Levermore-M1 (or Minerbo) closure, where the Eddington factor $\\chi(f)$ is given by:\n$$\n\\chi(f) = \\frac{3 + 4 f^2}{5 + 2\\sqrt{4 - 3 f^2}}, \\quad \\text{for } |f| \\le 1\n$$\nThis closure allows the flux vector $\\mathcal{F}(U)$ to be written solely in terms of the components of the state vector $U$:\n$$\n\\mathcal{F}(U) = \\begin{pmatrix} F \\\\ \\chi(F/E) E \\end{pmatrix}\n$$\n\n### 2. Flux Jacobian and Eigenvalues\nTo analyze the wave structure of the system and construct the Harten–Lax–van Leer (HLL) solver, we must compute the Jacobian matrix of the flux vector, $A(U) = \\partial \\mathcal{F}(U) / \\partial U$.\n$$\nA(U) = \\frac{\\partial \\mathcal{F}(U)}{\\partial U} = \\begin{pmatrix} \\frac{\\partial F}{\\partial E} & \\frac{\\partial F}{\\partial F} \\\\ \\frac{\\partial P}{\\partial E} & \\frac{\\partial P}{\\partial F} \\end{pmatrix}\n$$\nThe components of the Jacobian are calculated as follows. The top row is trivial: $\\partial F/\\partial E = 0$ and $\\partial F/\\partial F = 1$. For the bottom row, we use the chain rule for $P(E,F) = \\chi(F/E)E$. Let $\\chi' = \\mathrm{d}\\chi/\\mathrm{d}f$:\n$$\n\\frac{\\partial P}{\\partial F} = \\frac{\\partial}{\\partial F} \\left( \\chi(f) E \\right) = E \\frac{\\mathrm{d}\\chi}{\\mathrm{d}f} \\frac{\\partial f}{\\partial F} = E \\chi' \\left( \\frac{1}{E} \\right) = \\chi'\n$$\n$$\n\\frac{\\partial P}{\\partial E} = \\frac{\\partial}{\\partial E} \\left( \\chi(f) E \\right) = \\chi(f) \\cdot 1 + E \\frac{\\mathrm{d}\\chi}{\\mathrm{d}f} \\frac{\\partial f}{\\partial E} = \\chi(f) + E \\chi' \\left( -\\frac{F}{E^2} \\right) = \\chi(f) - \\frac{F}{E} \\chi' = \\chi - f \\chi'\n$$\nThus, the Jacobian matrix is:\n$$\nA(U) = \\begin{pmatrix} 0 & 1 \\\\ \\chi - f \\chi' & \\chi' \\end{pmatrix}\n$$\nThe eigenvalues $\\lambda$ of $A(U)$, which represent the characteristic wave speeds of the system, are the roots of the characteristic equation $\\det(A - \\lambda I) = 0$:\n$$\n\\det \\begin{pmatrix} -\\lambda & 1 \\\\ \\chi - f \\chi' & \\chi' - \\lambda \\end{pmatrix} = (-\\lambda)(\\chi' - \\lambda) - (\\chi - f \\chi') = \\lambda^2 - \\chi' \\lambda - (\\chi - f \\chi') = 0\n$$\nSolving this quadratic equation for $\\lambda$ yields the two eigenvalues:\n$$\n\\lambda_{\\pm}(U) = \\frac{\\chi' \\pm \\sqrt{(\\chi')^2 + 4(\\chi - f \\chi')}}{2}\n$$\nThe system is strictly hyperbolic as long as the discriminant $\\Delta = (\\chi')^2 + 4(\\chi - f \\chi')$ is positive. For the given Levermore-M1 closure, this holds for all $|f|<1$. The explicit formula for $\\chi'(f)$ is required for the implementation but is not needed for this symbolic derivation of the eigenvalues.\n\n### 3. Finite-Volume Discretization\nThe spatial domain $[0,1]$ is discretized into $N$ uniform cells of width $\\Delta x = 1/N$. Cell centers are located at $x_i = (i+1/2)\\Delta x$ for $i=0, \\dots, N-1$. Let $U_i(t)$ be the cell-averaged state in cell $i$. By integrating the conservation law over cell $i$, from interface $x_{i-1/2}$ to $x_{i+1/2}$, we obtain the semi-discrete finite-volume formulation:\n$$\n\\frac{\\mathrm{d}U_i}{\\mathrm{d}t} = -\\frac{1}{\\Delta x} \\left( \\mathcal{F}^*_{i+1/2} - \\mathcal{F}^*_{i-1/2} \\right)\n$$\nwhere $\\mathcal{F}^*_{i+1/2}$ is the numerical flux at the interface between cell $i$ and cell $i+1$.\n\n### 4. HLL Approximate Riemann Solver\nThe numerical flux $\\mathcal{F}^*_{i+1/2}$ is computed using the HLL approximate Riemann solver. Given the left state $U_L = U_i$ and the right state $U_R = U_{i+1}$ at an interface, the HLL flux is:\n$$\n\\mathcal{F}^*_{HLL}(U_L, U_R) = \\begin{cases} \\mathcal{F}(U_L) & \\text{if } s_L \\ge 0 \\\\ \\frac{s_R \\mathcal{F}(U_L) - s_L \\mathcal{F}(U_R) + s_L s_R (U_R - U_L)}{s_R - s_L} & \\text{if } s_L < 0 < s_R \\\\ \\mathcal{F}(U_R) & \\text{if } s_R \\le 0 \\end{cases}\n$$\nThe signal speeds, $s_L$ and $s_R$, are estimates for the slowest and fastest waves in the Riemann fan at the interface. As specified, we use the Davis (1988) estimate, based on the minimum and maximum eigenvalues from the left and right states:\n$$\ns_L = \\min(\\lambda_-(U_L), \\lambda_-(U_R))\n$$\n$$\ns_R = \\max(\\lambda_+(U_L), \\lambda_+(U_R))\n$$\nwhere $\\lambda_-(U)$ and $\\lambda_+(U)$ are the smaller and larger eigenvalues, respectively, evaluated for a given state $U$.\n\n### 5. Time Integration and CFL Condition\nAn explicit forward Euler method is used for time integration:\n$$\nU_i^{n+1} = U_i^n - \\frac{\\Delta t}{\\Delta x} \\left( (\\mathcal{F}^*)_{i+1/2}^n - (\\mathcal{F}^*)_{i-1/2}^n \\right)\n$$\nwhere the superscript $n$ denotes the time level. The time step $\\Delta t$ must satisfy the Courant–Friedrichs–Lewy (CFL) condition for stability:\n$$\n\\Delta t = \\nu \\frac{\\Delta x}{\\lambda_{\\text{max}}}\n$$\nwhere $\\nu$ is the CFL number (given as $0.40$), and $\\lambda_{\\text{max}}$ is the maximum absolute wave speed over the entire grid at time $t^n$:\n$$\n\\lambda_{\\text{max}} = \\max_{i=0, \\dots, N-1} \\left( \\max(|\\lambda_-(U_i^n)|, |\\lambda_+(U_i^n)|) \\right)\n$$\n\n### 6. Positivity and Physicality Limiter\nThe forward Euler update does not intrinsically guarantee that the updated state $U_i^{n+1}$ is physical, i.e., that $E_i^{n+1} > 0$ and $|F_i^{n+1}| \\le E_i^{n+1}$. A post-update limiter must be applied. Let the un-limited updated state from the Euler step be $U_i^{\\text{upd}} = (E_i^{\\text{upd}}, F_i^{\\text{upd}})$. The physically valid state $U_i^{n+1}$ is obtained via the following two-step procedure:\n\n1.  **Positivity of Energy Density**: The energy density is forced to be above a small positive floor value $\\varepsilon$:\n    $$ E_i^{n+1} = \\max(E_i^{\\text{upd}}, \\varepsilon) $$\n    A small value such as $\\varepsilon=10^{-12}$ prevents division by zero in subsequent calculations of $f$ and maintains positivity.\n\n2.  **Flux Limiting**: The reduced flux $f_i^{n+1} = F_i^{n+1}/E_i^{n+1}$ must satisfy $|f_i^{n+1}| < 1$ to ensure hyperbolicity and physicality. The updated flux $F_i^{\\text{upd}}$ is adjusted accordingly. We compute a test reduced flux $f_{\\text{test}} = F_i^{\\text{upd}} / E_i^{n+1}$ (using the just-limited energy density). If $|f_{\\text{test}}| \\ge 1$, the flux is scaled back into the physical domain. To avoid the singular boundary at $|f|=1$, we scale it to a value slightly less than $1$, e.g., $1-\\delta$ for a small tolerance $\\delta$.\n    $$\n    F_i^{n+1} = \\begin{cases}\n    (1-\\delta) E_i^{n+1} & \\text{if } f_{\\text{test}} \\ge 1-\\delta \\\\\n    -(1-\\delta) E_i^{n+1} & \\text{if } f_{\\text{test}} \\le -(1-\\delta) \\\\\n    F_i^{\\text{upd}} & \\text{otherwise}\n    \\end{cases}\n    $$\n    This safeguard ensures that the state passed to the next time step is always in the physical, strictly hyperbolic regime.\n\n### 7. Periodic Boundary Conditions\nFor a grid with $N$ cells indexed $i=0, \\dots, N-1$, periodic boundaries imply that the left neighbor of cell $0$ is cell $N-1$, and the right neighbor of cell $N-1$ is cell $0$. This is handled during the computation of the numerical fluxes at the cell interfaces. For example, the flux $(\\mathcal{F}^*)_{-1/2}$ for cell $0$'s update is calculated using states $U_L = U_{N-1}$ and $U_R = U_0$.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\n# A small tolerance to prevent division by zero or other numerical issues.\n# Also used for flux limiting near the |f|=1 boundary.\nTOL = 1e-12\n\ndef levermore_chi(f):\n    \"\"\"\n    Computes the Levermore-M1 Eddington factor chi(f).\n    f is the reduced flux, |f| < 1.\n    \"\"\"\n    f_sq = f**2\n    # The limiter ensures 4 - 3*f^2 > 1, so the sqrt is safe.\n    g = np.sqrt(4.0 - 3.0 * f_sq)\n    return (3.0 + 4.0 * f_sq) / (5.0 + 2.0 * g)\n\ndef levermore_dchi_df(f):\n    \"\"\"\n    Computes the derivative of the Levermore-M1 Eddington factor, d(chi)/df.\n    \"\"\"\n    # The derivative is an odd function, so dchi/df(0) = 0.\n    # We handle f=0 separately to avoid potential 0/0 issues in a naive formula.\n    result = np.zeros_like(f)\n    nonzero_f = np.abs(f) > TOL\n\n    f_nz = f[nonzero_f]\n    f_sq = f_nz**2\n    # The limiter ensures the argument is positive.\n    g = np.sqrt(4.0 - 3.0 * f_sq)\n    \n    # Numerator of the derivative formula derived in the solution text.\n    num = f_nz * (40.0 * g + 82.0 - 24.0 * f_sq)\n    # Denominator of the derivative formula.\n    den = g * (5.0 + 2.0 * g)**2\n    \n    result[nonzero_f] = num / den\n    return result\n\ndef get_eigenvalues(E, F):\n    \"\"\"\n    Computes the eigenvalues of the M1 system Jacobian.\n    \"\"\"\n    # Floor for energy to prevent division by zero for f.\n    E_floor = np.maximum(E, TOL)\n    f = F / E_floor\n    \n    # Clip f to be strictly within (-1, 1) to handle any numerical errors\n    # and satisfy the precondition for the closure functions.\n    f = np.clip(f, -(1.0 - TOL), 1.0 - TOL)\n    \n    chi_val = levermore_chi(f)\n    dchi_df_val = levermore_dchi_df(f)\n    \n    # Discriminant of the characteristic quadratic equation for eigenvalues.\n    discriminant = dchi_df_val**2 + 4.0 * (chi_val - f * dchi_df_val)\n    # Ensure non-negativity due to potential floating-point inaccuracies.\n    sqrt_discriminant = np.sqrt(np.maximum(0.0, discriminant))\n    \n    lambda_p = 0.5 * (dchi_df_val + sqrt_discriminant)\n    lambda_m = 0.5 * (dchi_df_val - sqrt_discriminant)\n    \n    return lambda_m, lambda_p\n\ndef hll_flux(Ul, Ur, Fl, Fr, sL, sR):\n    \"\"\"\n    Computes the HLL numerical flux given left/right states, fluxes, and signal speeds.\n    \"\"\"\n    flux = np.zeros_like(Ul)\n    \n    # Case 1: sL >= 0, the flux is entirely from the left state.\n    mask1 = sL >= 0\n    flux[:, mask1] = Fl[:, mask1]\n    \n    # Case 3: sR <= 0, the flux is entirely from the right state.\n    # This must be checked after case 1 to handle sL=sR=0 correctly if needed,\n    # though it applies to different parts of the array.\n    mask3 = sR <= 0\n    flux[:, mask3] = Fr[:, mask3]\n    \n    # Case 2: sL < 0 < sR, the flux is a mix of left/right states and fluxes.\n    mask2 = (sL < 0) & (sR > 0)\n    \n    num = sR[mask2] * Fl[:, mask2] - sL[mask2] * Fr[:, mask2] + sL[mask2] * sR[mask2] * (Ur[:, mask2] - Ul[:, mask2])\n    den = sR[mask2] - sL[mask2]\n    \n    flux[:, mask2] = num / den\n    \n    return flux\n\ndef run_simulation(N, T, nu, E0_func, F0_func):\n    \"\"\"\n    Runs a single M1 simulation case and checks final state physicality.\n    \"\"\"\n    # Grid setup\n    dx = 1.0 / N\n    x = np.linspace(dx / 2.0, 1.0 - dx / 2.0, N)\n    \n    # Initial conditions\n    E = E0_func(x)\n    F = F0_func(x, E)\n    U = np.array([E, F])\n    \n    t = 0.0\n    while t < T:\n        # 1. Calculate CFL-limited time step\n        lambda_m, lambda_p = get_eigenvalues(U[0, :], U[1, :])\n        max_abs_lambda = np.max(np.maximum(np.abs(lambda_m), np.abs(lambda_p)))\n        \n        if max_abs_lambda < TOL: # Handle static case\n            dt = T - t\n        else:\n            dt = nu * dx / max_abs_lambda\n        \n        dt = min(dt, T - t)\n        \n        # 2. Compute interface fluxes using HLL\n        # Periodic boundaries: roll arrays to get left and right state at interfaces.\n        Ul = U\n        Ur = np.roll(U, -1, axis=1) # U_{i+1} for interface i+1/2\n\n        # Calculate fluxes F(U) for left and right states\n        # Protect against division by zero for f\n        f_l = Ul[1,:] / np.maximum(TOL, Ul[0,:])\n        f_r = Ur[1,:] / np.maximum(TOL, Ur[0,:])\n        Fl = np.array([Ul[1,:], levermore_chi(f_l) * Ul[0,:]])\n        Fr = np.array([Ur[1,:], levermore_chi(f_r) * Ur[0,:]])\n        \n        # Get eigenvalues for left and right states\n        lambda_m_l, lambda_p_l = get_eigenvalues(Ul[0, :], Ul[1, :])\n        lambda_m_r, lambda_p_r = get_eigenvalues(Ur[0, :], Ur[1, :])\n        \n        # Davis (1988) signal speed estimates\n        sL = np.minimum(lambda_m_l, lambda_m_r)\n        sR = np.maximum(lambda_p_l, lambda_p_r)\n        \n        # Compute HLL fluxes at interfaces x_{i+1/2}\n        F_iph = hll_flux(Ul, Ur, Fl, Fr, sL, sR)\n        \n        # Get fluxes at x_{i-1/2} by rolling the array of interface fluxes\n        F_imh = np.roll(F_iph, 1, axis=1)\n        \n        # 3. Update state vector (Forward Euler)\n        U_upd = U - (dt / dx) * (F_iph - F_imh)\n        \n        # 4. Apply post-update limiter for positivity and physicality\n        E_new = np.maximum(U_upd[0, :], TOL)\n        F_new = U_upd[1, :]\n        \n        f_test = F_new / np.maximum(E_new, TOL)\n        \n        # Enforce |f| < 1\n        limit_factor = 1.0 - TOL\n        mask_too_high = f_test > limit_factor\n        mask_too_low = f_test < -limit_factor\n        \n        F_new[mask_too_high] = limit_factor * E_new[mask_too_high]\n        F_new[mask_too_low] = -limit_factor * E_new[mask_too_low]\n        \n        U = np.array([E_new, F_new])\n        \n        # 5. Advance time\n        t += dt\n\n    # Final checks for positivity and physicality\n    E_final = U[0, :]\n    F_final = U[1, :]\n    \n    c1 = np.min(E_final) >= 0.0\n    c2 = np.max(np.abs(F_final) - E_final) <= 0.0 # Will be <= -TOL*E on limited cells\n    \n    return c1 and c2\n\ndef solve():\n    \"\"\"\n    Main function to define test cases, run the simulations, and print results.\n    \"\"\"\n    sigma = 0.05\n    test_cases = [\n        { # 1. Happy-path smooth pulse\n            \"N\": 200, \"T\": 0.10, \"nu\": 0.40,\n            \"E0_func\": lambda x: 1.0 + 0.1 * np.exp(-(x - 0.5)**2 / (2.0 * sigma**2)),\n            \"F0_func\": lambda x, E: 0.2 * E\n        },\n        { # 2. Near-vacuum robustness\n            \"N\": 200, \"T\": 0.05, \"nu\": 0.40,\n            \"E0_func\": lambda x: 1e-6 + 1e-3 * (np.abs(x - 0.5) < 0.1),\n            \"F0_func\": lambda x, E: 0.0 * E\n        },\n        { # 3. Near free-streaming\n            \"N\": 200, \"T\": 0.05, \"nu\": 0.40,\n            \"E0_func\": lambda x: np.ones_like(x),\n            \"F0_func\": lambda x, E: 0.9 * E\n        },\n        { # 4. Riemann-type discontinuity\n            \"N\": 200, \"T\": 0.05, \"nu\": 0.40,\n            \"E0_func\": lambda x: 1.0 * (x < 0.5) + 0.1 * (x >= 0.5),\n            \"F0_func\": lambda x, E: 0.0 * E\n        }\n    ]\n    \n    results = []\n    for case in test_cases:\n        result = run_simulation(case[\"N\"], case[\"T\"], case[\"nu\"], case[\"E0_func\"], case[\"F0_func\"])\n        results.append(result)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}