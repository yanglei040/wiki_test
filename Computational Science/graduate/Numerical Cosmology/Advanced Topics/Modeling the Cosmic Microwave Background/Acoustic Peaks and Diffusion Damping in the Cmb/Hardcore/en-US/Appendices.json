{
    "hands_on_practices": [
        {
            "introduction": "The suppression of small-scale power in the Cosmic Microwave Background (CMB), known as Silk or diffusion damping, is a cornerstone of precision cosmology. To accurately model this effect, we must first compute its characteristic comoving scale, the damping wavenumber $k_D$. This exercise provides a foundational practice in calculating $k_D$ from first principles by tracking its evolution through cosmic history in a realistic cosmological setting . By implementing and comparing two mathematically equivalent methods—direct integration and solving a differential equation—you will not only build a robust numerical tool but also deepen your understanding of the relationship between different formalisms in theoretical physics.",
            "id": "3463818",
            "problem": "You are to compute the comoving photon diffusion damping wavenumber $k_D$ (Silk damping) in the Cosmic Microwave Background (CMB) by two mathematically equivalent routes and benchmark their numerical equivalence, while identifying physically motivated regimes where standard approximations are expected to break down. The two routes are: (i) a direct integral over conformal time $\\eta$, and (ii) a differential evolution equation in $\\eta$ for the quantity $y(\\eta) \\equiv k_D^{-2}(\\eta)$. The physical setup is a tightly coupled photon–baryon fluid in a spatially flat Friedmann–Lemaître–Robertson–Walker (FLRW) Universe with matter and radiation components (neglecting dark energy at early times). Your derivation and implementation must start from the following fundamental base:\n\n- Energy–momentum conservation for a coupled fluid and radiative transport, with Thomson scattering characterized by the Thomson cross section $\\sigma_T$ and electron number density $n_e$.\n- The definition of conformal time $\\eta$ via $d\\eta = dt/a$, where $a$ is the scale factor and $t$ is cosmic time.\n- The Hubble expansion in a spatially flat FLRW Universe with non-relativistic matter energy density parameter $\\Omega_m$ and relativistic energy density parameter $\\Omega_r$, with $H(a) = H_0 \\sqrt{\\Omega_m a^{-3} + \\Omega_r a^{-4}}$.\n- The critical density today $\\rho_{c0} = 3 H_0^2 / (8 \\pi G)$, and the photon energy density today $\\rho_{\\gamma 0} = a_{\\mathrm{rad}} T_0^4 / c^2$ with radiation constant $a_{\\mathrm{rad}}$ and CMB temperature $T_0$.\n- The baryon-to-photon momentum density ratio $R(a) \\equiv 3 \\rho_b / (4 \\rho_\\gamma)$, and the tight-coupling limit in which diffusion damping arises from photon shear viscosity and heat conduction.\n\nFrom these bases, derive the tight-coupling evolution for $y(\\eta) \\equiv k_D^{-2}(\\eta)$ and express it both as:\n- An integral over conformal time from an initial scale factor $a_{\\min}$ to a target $a$,\n- And as a first-order ordinary differential equation (ODE) for $y$ in either $\\eta$ or $a$, showing how the ODE reduces to the same integral upon formal integration.\n\nFor scientific realism, use the following definitions and relations:\n\n- Conformal time–scale factor relation $d\\eta/da = 1/\\left(a^2 H(a)\\right)$, so that $\\eta(a) = \\int_0^a da' / \\left(a'^2 H(a')\\right)$.\n- Electron number density $n_e(a) = x_e(a) n_{b0} a^{-3}$, where $n_{b0} = \\Omega_b \\rho_{c0} / m_p$ is the present-day baryon number density, $\\Omega_b$ is the baryon density parameter, and $m_p$ is the proton mass.\n- Optical depth derivative with respect to conformal time is $d\\tau/d\\eta = a n_e \\sigma_T$. In conformal time units, this has dimensions of inverse length.\n- Photon–baryon ratio $R(a)$ evolves as $R(a) = R_0 a$ with $R_0 = 3 \\Omega_b \\rho_{c0} / \\left(4 \\rho_{\\gamma 0}\\right)$.\n\nImplement a smooth phenomenological recombination history for the free-electron fraction per baryon:\n$$\nx_e(a) = x_{e,\\mathrm{post}} + \\frac{1}{2} \\left(f_e - x_{e,\\mathrm{post}}\\right) \\left[1 - \\tanh\\left(\\frac{a - a_*}{w}\\right)\\right],\n$$\nwhere $f_e = 1 - Y_p/2$, $Y_p$ is the primordial helium mass fraction, $a_*$ is a characteristic recombination scale factor, $w$ is a transition width in scale factor, and $x_{e,\\mathrm{post}}$ is the residual free-electron fraction per baryon after recombination. This parameterization is scientifically plausible and captures the transition from a fully ionized state ($x_e \\approx f_e$) to a mostly neutral state ($x_e \\approx x_{e,\\mathrm{post}}$).\n\nUse the photon diffusion damping rate under the tight-coupling approximation to define the integrand for $y(\\eta)$ in terms of $R(a)$ and $d\\tau/d\\eta$. Derive the evolution equation $dy/d\\eta$ from transport theory in the tight-coupling regime. Do not introduce any ad hoc fitting formulas beyond the tight-coupling framework.\n\nYou must carry out the computation in comoving units where $H(a)$ is expressed in $\\mathrm{Mpc}^{-1}$, conformal time $\\eta$ is in $\\mathrm{Mpc}$, and $k_D$ is in $\\mathrm{Mpc}^{-1}$. Convert $\\sigma_T$ from $\\mathrm{m}^2$ to $\\mathrm{Mpc}^2$ and number densities from $\\mathrm{m}^{-3}$ to $\\mathrm{Mpc}^{-3}$ to keep units consistent. The speed of light $c$ cancels in $d\\tau/d\\eta$, so no explicit $c$ is required in that factor when using conformal time.\n\nNumerical tasks:\n\n1. For each test case below, compute $k_D(a_*)$ twice:\n   - As $k_{D,\\mathrm{int}}(a_*)$ from the integral representation of $y(\\eta)$ over conformal time between $a_{\\min}$ and $a_*$, transformed to an integral over $a$ using $d\\eta/da$.\n   - As $k_{D,\\mathrm{ode}}(a_*)$ by solving the ODE for $y(a)$ from $a_{\\min}$ to $a_*$ and then taking $k_D = y^{-1/2}$.\n\n2. Benchmark the equivalence by computing the dimensionless relative difference\n   $$\n   \\delta \\equiv \\frac{\\left|k_{D,\\mathrm{int}}(a_*) - k_{D,\\mathrm{ode}}(a_*)\\right|}{k_{D,\\mathrm{int}}(a_*)}.\n   $$\n\n3. Diagnose tight-coupling validity at $a_*$ using the ratio\n   $$\n   h \\equiv \\frac{H(a_*)}{d\\tau/d\\eta(a_*)},\n   $$\n   which is dimensionless in comoving units. When $h \\gtrsim 1$, the scattering rate is not fast compared to the expansion, and the tight-coupling approximation is expected to break down. Report a boolean flag $\\mathrm{breakdown}$ set to $\\mathrm{True}$ if $h \\geq 1$, otherwise $\\mathrm{False}$.\n\nPhysical constants for all test cases:\n- $G = 6.67430 \\times 10^{-11}\\ \\mathrm{m}^3\\,\\mathrm{kg}^{-1}\\,\\mathrm{s}^{-2}$,\n- $c = 299792.458\\ \\mathrm{km}\\,\\mathrm{s}^{-1}$,\n- $m_p = 1.67262192369 \\times 10^{-27}\\ \\mathrm{kg}$,\n- $\\sigma_T = 6.6524587321 \\times 10^{-29}\\ \\mathrm{m}^2$,\n- $a_{\\mathrm{rad}} = 7.5657 \\times 10^{-16}\\ \\mathrm{J}\\,\\mathrm{m}^{-3}\\,\\mathrm{K}^{-4}$,\n- $1\\ \\mathrm{Mpc} = 3.0856775814913673 \\times 10^{22}\\ \\mathrm{m}$.\n\nRelativistic density parameter from photon energy density and effective neutrino number:\n$$\n\\Omega_\\gamma = \\frac{\\rho_{\\gamma 0}}{\\rho_{c0}},\\quad \\rho_{\\gamma 0} = \\frac{a_{\\mathrm{rad}} T_0^4}{c^2},\\quad \\Omega_r = \\Omega_\\gamma \\left(1 + 0.2271\\,N_{\\mathrm{eff}}\\right),\n$$\nwith $N_{\\mathrm{eff}}$ the effective number of neutrino species.\n\nExpress all $k_D$ values in $\\mathrm{Mpc}^{-1}$. The relative differences $\\delta$ and ratios $h$ are dimensionless. The final output must be a single line containing a flat comma-separated list enclosed in square brackets.\n\nTest suite:\n- Case $1$: $(H_0, \\Omega_b, \\Omega_m, N_{\\mathrm{eff}}, T_0, Y_p, a_*, w, x_{e,\\mathrm{post}}) = (67.66,\\ 0.049,\\ 0.315,\\ 3.046,\\ 2.725,\\ 0.24,\\ 1/1100,\\ 5\\times 10^{-4},\\ 10^{-4})$.\n- Case $2$: $(H_0, \\Omega_b, \\Omega_m, N_{\\mathrm{eff}}, T_0, Y_p, a_*, w, x_{e,\\mathrm{post}}) = (67.66,\\ 0.049,\\ 0.315,\\ 3.046,\\ 2.725,\\ 0.24,\\ 1/1400,\\ 10^{-4},\\ 10^{-4})$.\n- Case $3$: $(H_0, \\Omega_b, \\Omega_m, N_{\\mathrm{eff}}, T_0, Y_p, a_*, w, x_{e,\\mathrm{post}}) = (67.66,\\ 0.049,\\ 0.315,\\ 3.046,\\ 2.725,\\ 0.24,\\ 1/900,\\ 10^{-3},\\ 10^{-4})$.\n- Case $4$: $(H_0, \\Omega_b, \\Omega_m, N_{\\mathrm{eff}}, T_0, Y_p, a_*, w, x_{e,\\mathrm{post}}) = (67.66,\\ 0.049,\\ 0.315,\\ 3.046,\\ 2.725,\\ 0.24,\\ 1/1100,\\ 10^{-6},\\ 10^{-4})$.\n\nYou must take $a_{\\min} = 10^{-8}$ for the lower bound of integration.\n\nRequired final output format:\nYour program should produce a single line of output containing, for each test case in order, the values $[\\delta_1, h_1, \\mathrm{breakdown}_1, \\delta_2, h_2, \\mathrm{breakdown}_2, \\delta_3, h_3, \\mathrm{breakdown}_3, \\delta_4, h_4, \\mathrm{breakdown}_4]$, i.e., a comma-separated list enclosed in square brackets with floats and booleans in a flat structure.",
            "solution": "The user requires the computation and comparison of the comoving photon diffusion damping wavenumber, $k_D$, calculated via two mathematically equivalent methods: direct integration and solving a first-order ordinary differential equation (ODE). The analysis is performed within the standard cosmological framework of a flat Friedmann–Lemaître–Robertson–Walker (FLRW) universe containing matter and radiation, under the tight-coupling approximation for the photon-baryon fluid.\n\n### Principle-Based Derivation\n\n**1. Photon Diffusion and the Damping Wavenumber $k_D$**\nIn the early universe, before recombination, photons are tightly coupled to baryons via Thomson scattering. However, this coupling is not perfect. Photons have a finite mean free path, allowing them to diffuse out of overdense regions, smoothing out small-scale perturbations. This dissipative process is known as Silk damping or diffusion damping.\n\nThe damping effect on a density perturbation of comoving wavenumber $k$ is typically exponential, scaling as $\\exp(-k^2/k_D^2)$. The quantity $k_D$ is the comoving damping wavenumber, and its inverse, $k_D^{-1}$, represents the comoving photon diffusion length. The squared diffusion length, $\\lambda_D^2 \\equiv k_D^{-2}$, accumulates over time due to the random walk of photons.\n\nWe define the quantity to be solved for as $y(\\eta) \\equiv k_D^{-2}(\\eta)$, where $\\eta$ is the conformal time, defined by $d\\eta = c\\,dt/a(t)$ to have units of length. Here, $c$ is the speed of light, $t$ is cosmic time, and $a(t)$ is the scale factor.\n\n**2. Evolution Equation in the Tight-Coupling Limit**\nThe evolution of $y(\\eta)$ can be derived from the Boltzmann equation for photons in the tight-coupling limit. The rate of change of the squared diffusion length is determined by the photon diffusion coefficient. This coefficient depends on the photon mean free time (in conformal time units, which is related to the inverse of the Thomson scattering rate, $\\dot{\\tau}^{-1}$) and properties of the photon-baryon fluid, namely its shear viscosity and heat conduction.\n\nThe comoving Thomson scattering rate is given by $\\dot{\\tau} \\equiv d\\tau/d\\eta = a n_e \\sigma_T$, where $n_e$ is the proper electron number density and $\\sigma_T$ is the Thomson cross-section.\n\nThe resulting first-order ordinary differential equation for $y(\\eta)$ is:\n$$\n\\frac{dy}{d\\eta} = \\frac{1}{6\\dot{\\tau}(\\eta)} \\left[ \\frac{R(\\eta)^2 + \\frac{16}{15}(1+R(\\eta))}{(1+R(\\eta))^2} \\right]\n$$\nHere, $R(\\eta) \\equiv 3\\rho_b/(4\\rho_\\gamma)$ is the baryon-to-photon momentum density ratio, which quantifies the inertial 'drag' of baryons on the photons. Since $\\rho_b \\propto a^{-3}$ and $\\rho_\\gamma \\propto a^{-4}$, $R$ is proportional to the scale factor, $R(a) = R_0 a$.\n\nThis equation represents the fundamental ODE form required by the problem.\n\n**3. Integral and ODE Representations in Terms of Scale Factor $a$**\nTo implement the computation numerically, it is more convenient to work with the scale factor $a$ as the independent variable.\n\n**Integral Representation:**\nThe total squared diffusion length at a scale factor $a_*$ is obtained by integrating the rate of change from an early time ($a \\to 0$) until $a_*$. With the initial condition $y(a_{\\min}) \\approx 0$ for some very small $a_{\\min}$:\n$$\ny(a_*) = \\int_0^{\\eta(a_*)} d\\eta' \\, \\frac{dy}{d\\eta'}(\\eta')\n$$\nWe change the integration variable from conformal time $\\eta$ to scale factor $a$ using the relation $d\\eta = \\frac{da}{a \\dot{a}} = \\frac{da}{a^2 H(a)/c}$. The problem specifies using $H(a)$ in units of $\\mathrm{Mpc}^{-1}$, which\ncorresponds to $H_{\\text{phys}}/c$. Thus, the relation becomes $d\\eta/da = 1/(a^2 H(a))$.\nSubstituting this into the integral gives the integral formulation:\n$$\ny(a_*) = \\int_{a_{\\min}}^{a_*} da' \\, \\frac{1}{a'^2 H(a')} \\left\\{ \\frac{1}{6\\dot{\\tau}(a')} \\left[ \\frac{R(a')^2 + \\frac{16}{15}(1+R(a'))}{(1+R(a'))^2} \\right] \\right\\}\n$$\n\n**ODE Representation:**\nUsing the chain rule, $\\frac{dy}{da} = \\frac{dy}{d\\eta}\\frac{d\\eta}{da}$, the ODE in terms of the scale factor $a$ is:\n$$\n\\frac{dy}{da} = \\frac{1}{a^2 H(a)} \\left\\{ \\frac{1}{6\\dot{\\tau}(a)} \\left[ \\frac{R(a)^2 + \\frac{16}{15}(1+R(a))}{(1+R(a))^2} \\right] \\right\\}\n$$\nThis is a first-order ODE for $y(a)$ with the initial condition $y(a_{\\min})=0$. Solving this ODE from $a_{\\min}$ to $a_*$ provides an alternative method to compute $y(a_*)$. As demonstrated, formal integration of this ODE yields the exact same integral representation, confirming their mathematical equivalence. The numerical task is to verify this equivalence up to the precision of the numerical solvers.\n\n**4. Numerical Implementation Design**\nThe algorithm will perform the following steps for each test case:\n1.  **Constants and Parameters:** Define all physical constants and convert them to a consistent set of units (Mpc, kg, K). The Hubble constant $H_0$ given in $\\mathrm{km}\\,\\mathrm{s}^{-1}\\,\\mathrm{Mpc}^{-1}$ is converted to $\\mathrm{s}^{-1}$ for calculating $\\rho_{c0}$ and to $\\mathrm{Mpc}^{-1}$ for use in the cosmological functions.\n2.  **Cosmological Functions:** Implement functions for $H(a)$, $R(a)$, $x_e(a)$, and $\\dot{\\tau}(a)$ based on the provided formulae. All units will be handled to ensure that quantities like $H$ and $\\dot{\\tau}$ are in $\\mathrm{Mpc}^{-1}$, and the final computed $y$ is in $\\mathrm{Mpc}^2$.\n3.  **Integrand Definition:** The right-hand side of the ODE, $\\frac{dy}{da}$, serves as the integrand for the integral method.\n4.  **Numerical Solution:**\n    -   **Integral Method ($k_{D,\\mathrm{int}}$):** Use `scipy.integrate.quad` to compute the definite integral of $\\frac{dy}{da}$ from $a_{\\min}$ to $a_*$. This yields $y_{\\mathrm{int}}(a_*)$.\n    -   **ODE Method ($k_{D,\\mathrm{ode}}$):** Use `scipy.integrate.solve_ivp` to solve the ODE $\\frac{dy}{da} = f(a)$ with the initial condition $y(a_{\\min})=0$ over the span $[a_{\\min}, a_*]$. This yields $y_{\\mathrm{ode}}(a_*)$.\n5.  **Final Calculations:**\n    -   Compute the damping wavenumbers: $k_{D,\\mathrm{int}} = y_{\\mathrm{int}}^{-1/2}$ and $k_{D,\\mathrm{ode}} = y_{\\mathrm{ode}}^{-1/2}$.\n    -   Calculate the relative difference $\\delta = |k_{D,\\mathrm{int}} - k_{D,\\mathrm{ode}}| / k_{D,\\mathrm{int}}$.\n    -   Calculate the tight-coupling breakdown diagnostic $h = H(a_*) / \\dot{\\tau}(a_*)$, where both quantities are in $\\mathrm{Mpc}^{-1}$.\n    -   Set the boolean flag `breakdown = True` if $h \\geq 1$, otherwise `False`.\n6.  **Output:** The results for all test cases are collected and formatted into a single flat list as specified.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import integrate\n\ndef solve():\n    \"\"\"\n    Computes the photon diffusion damping wavenumber k_D via two methods\n    (integral and ODE), compares them, and diagnoses tight-coupling validity.\n    \"\"\"\n    # Physical constants\n    G_SI = 6.67430e-11  # m^3 kg^-1 s^-2\n    C_KMS = 299792.458  # km s^-1\n    C_MS = C_KMS * 1000.  # m s^-1\n    M_P_KG = 1.67262192369e-27  # kg\n    SIGMA_T_M2 = 6.6524587321e-29  # m^2\n    A_RAD_SI = 7.5657e-16  # J m^-3 K^-4\n    MPC_M = 3.0856775814913673e22  # m\n\n    # Unit conversions\n    SIGMA_T_MPC2 = SIGMA_T_M2 / (MPC_M**2)\n\n    # Test cases from the problem statement.\n    test_cases = [\n        (67.66, 0.049, 0.315, 3.046, 2.725, 0.24, 1/1100., 5e-4, 1e-4),\n        (67.66, 0.049, 0.315, 3.046, 2.725, 0.24, 1/1400., 1e-4, 1e-4),\n        (67.66, 0.049, 0.315, 3.046, 2.725, 0.24, 1/900., 1e-3, 1e-4),\n        (67.66, 0.049, 0.315, 3.046, 2.725, 0.24, 1/1100., 1e-6, 1e-4)\n    ]\n    \n    a_min = 1e-8\n    results = []\n\n    for case in test_cases:\n        H0_kmsmpc, Omega_b, Omega_m, N_eff, T0, Yp, a_star, w, xe_post = case\n\n        # --- Derived parameters for this case ---\n\n        # Hubble constant in s^-1 for rho_c0 calculation\n        H0_s_inv = H0_kmsmpc * 1000. / MPC_M\n        \n        # Critical density today in kg/m^3\n        rho_c0_si = 3. * H0_s_inv**2 / (8. * np.pi * G_SI)\n        \n        # Photon energy density today in kg/m^3\n        rho_gamma0_si = A_RAD_SI * T0**4 / C_MS**2\n        \n        # Photon density parameter\n        Omega_gamma = rho_gamma0_si / rho_c0_si\n        \n        # Relativistic energy density parameter\n        Omega_r = Omega_gamma * (1. + 0.2271 * N_eff)\n        \n        # Present-day baryon number density in Mpc^-3\n        n_b0_si = Omega_b * rho_c0_si / M_P_KG  # in m^-3\n        n_b0_mpc_inv3 = n_b0_si * MPC_M**3\n        \n        # Baryon-to-photon ratio parameter R0\n        # R(a) = R0 * a\n        # R0 = 3 * rho_b0 / (4 * rho_gamma0) = 3 * Omega_b * rho_c0 / (4 * Omega_gamma * rho_c0)\n        R0 = 3. * Omega_b / (4. * Omega_gamma)\n\n        # Hubble parameter in Mpc^-1\n        H0_mpc_inv = H0_kmsmpc / C_KMS \n        \n        # --- Cosmological Functions ---\n        \n        def H_mpc_inv(a):\n            return H0_mpc_inv * np.sqrt(Omega_m * a**-3 + Omega_r * a**-4)\n\n        def R(a):\n            return R0 * a\n            \n        f_e = 1. - Yp / 2.\n        def x_e(a):\n            return xe_post + 0.5 * (f_e - xe_post) * (1 - np.tanh((a - a_star) / w))\n\n        def dtau_deta_mpc_inv(a):\n            # dtau/deta = a * n_e * sigma_T\n            # n_e(a) = x_e(a) * n_b0 * a^-3\n            # n_b0 is present-day baryon number density.\n            return a * (x_e(a) * n_b0_mpc_inv3 * a**-3) * SIGMA_T_MPC2\n\n        def dydt_integrand(a, y=None):\n            # This is the RHS of the ODE dy/da = f(a)\n            # y is unused, as the ODE is separable, but added for solve_ivp compatibility\n            R_val = R(a)\n            dtau_val = dtau_deta_mpc_inv(a)\n            \n            # Prevent division by zero if dtau is ever zero, though unlikely in practice\n            if dtau_val == 0:\n                return 0.\n                \n            term1 = 1. / (a**2 * H_mpc_inv(a))\n            numerator_bracket = R_val**2 + (16./15.) * (1. + R_val)\n            denominator_bracket = (1. + R_val)**2\n            term2 = 1. / (6. * dtau_val) * (numerator_bracket / denominator_bracket)\n            \n            return term1 * term2\n\n        # --- Numerical Calculation ---\n\n        # 1. Integral method\n        y_int_val, _ = integrate.quad(dydt_integrand, a_min, a_star)\n        k_D_int = y_int_val**-0.5\n\n        # 2. ODE method\n        sol = integrate.solve_ivp(\n            dydt_integrand, \n            [a_min, a_star], \n            [0.], \n            method='RK45', \n            rtol=1e-12, \n            atol=1e-15\n        )\n        y_ode_val = sol.y[0][-1]\n        k_D_ode = y_ode_val**-0.5\n\n        # --- Final Metrics ---\n\n        # Relative difference\n        delta = np.abs(k_D_int - k_D_ode) / k_D_int\n\n        # Tight-coupling breakdown diagnostic\n        h_val = H_mpc_inv(a_star) / dtau_deta_mpc_inv(a_star)\n        \n        # Breakdown flag\n        breakdown_flag = h_val >= 1.0\n\n        results.extend([delta, h_val, breakdown_flag])\n\n    # Final print statement in the exact required format.\n    # Convert booleans to lowercase 'true'/'false' for standard JSON-like output\n    formatted_results = [f'{v}'.lower() if isinstance(v, bool) else f'{v}' for v in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "The standard approach to modeling Silk damping approximates its effect on acoustic oscillations with a simple Gaussian envelope, $\\exp[-(k/k_D)^2]$. This powerful formula is derived under the tight-coupling approximation, which assumes an extremely high photon-baryon scattering rate. This practice challenges you to go beyond this limit by directly solving a more complete set of coupled fluid equations that capture the dynamics as the coupling weakens around recombination . By comparing the amplitude damping from this more rigorous simulation to the standard Silk formula, you will quantify the \"beyond-tight-coupling\" corrections and gain a more nuanced view of the dissipative processes at play.",
            "id": "3463798",
            "problem": "You are asked to implement and analyze a minimal beyond–tight-coupling model of photon–baryon acoustic oscillations with finite photon mean free path, and to quantify corrections to the standard diffusion damping (“Silk damping”) form. Work in linear theory, in Fourier space for a fixed comoving wavenumber $k$, and assume vanishing metric perturbations. Use conformal time $\\eta$ and set the speed of light to $c=1$, so all times and lengths are in conformal units and all quantities in the calculation are dimensionless.\n\nModel assumptions and fundamental base:\n- The photon brightness perturbation is represented by its monopole $\\delta_{\\gamma}$ (proportional to the photon density perturbation), dipole $v_{\\gamma}$ (photon bulk velocity), and quadrupole $F_{\\gamma 2}$ (anisotropic stress). Thomson scattering couples photons to baryons with an optical depth rate $\\dot{\\tau}(\\eta)$.\n- The baryons are treated as a pressureless fluid with density perturbation $\\delta_{b}$ and velocity $v_{b}$. The baryon loading parameter is $R \\equiv 3\\rho_{b}/(4\\rho_{\\gamma})$, taken as a constant in time.\n- The photon–baryon sound speed is $c_{s}^{2} = 1/\\left(3(1+R)\\right)$. You may neglect cosmic expansion drag and gravitational potentials over the short time window of interest.\n- The linearized collisional Boltzmann hierarchy for photons is truncated at $l=2$ and closed by setting $F_{\\gamma 3}=0$. Include an effective collisional damping of the quadrupole by Thomson scattering with a polarization-corrected coefficient.\n- Adopt an adiabatic initial condition at $\\eta=0$ with $\\delta_{\\gamma}(0)=\\delta_{0}$, $\\delta_{b}(0)=\\tfrac{3}{4}\\delta_{0}$, $v_{\\gamma}(0)=v_{b}(0)=0$, and $F_{\\gamma 2}(0)=0$. Use $\\delta_{0}=1$.\n- The Thomson rate $\\dot{\\tau}(\\eta)$ decreases smoothly from a large value before recombination to a small residual value after recombination. Use the parametric form\n$$\n\\dot{\\tau}(\\eta) = \\dot{\\tau}_{\\min} + \\frac{\\dot{\\tau}_{\\max}}{1+\\exp\\!\\left(\\frac{\\eta-\\eta_{\\mathrm{rec}}}{\\Delta}\\right)} \\, ,\n$$\nwith constants $\\dot{\\tau}_{\\max}0$, $\\dot{\\tau}_{\\min}\\ge 0$, $\\eta_{\\mathrm{rec}}0$, and width $\\Delta0$.\n\nGoverning equations to be solved numerically (all in Fourier space for a single $k$):\n- Photons:\n$$\n\\delta_{\\gamma}' = -\\frac{4}{3} k \\, v_{\\gamma} \\, ,\n$$\n$$\nv_{\\gamma}' = k \\left(\\frac{\\delta_{\\gamma}}{4} - \\frac{2}{5} F_{\\gamma 2}\\right) - \\dot{\\tau}(\\eta)\\,\\left(v_{\\gamma}-v_{b}\\right) \\, ,\n$$\n$$\nF_{\\gamma 2}' = \\frac{8}{15} k \\, v_{\\gamma} - \\frac{9}{10}\\,\\dot{\\tau}(\\eta)\\,F_{\\gamma 2} \\, ,\n$$\nwith the closure $F_{\\gamma 3}=0$.\n- Baryons:\n$$\n\\delta_{b}' = -k \\, v_{b} \\, ,\n$$\n$$\nv_{b}' = \\frac{\\dot{\\tau}(\\eta)}{R}\\,\\left(v_{\\gamma}-v_{b}\\right) \\, .\n$$\n\nAmplitude diagnostic and comparison baseline:\n- Define the instantaneous acoustic amplitude of the photon monopole at time $\\eta$ by\n$$\n\\mathcal{A}(\\eta) \\equiv \\sqrt{ \\delta_{\\gamma}(\\eta)^{2} + \\left(\\frac{\\delta_{\\gamma}'(\\eta)}{k\\,c_{s}}\\right)^{2} } \\, ,\n$$\nwith $c_{s}^{2} = 1/\\left(3(1+R)\\right)$.\n- In the ideal undamped acoustic limit (infinite coupling, no anisotropic stress), the photon monopole obeys a harmonic oscillator with constant amplitude. For the given initial data, the undamped amplitude at any time equals $\\delta_{0}$, so the dimensionless numerical damping factor evaluated at recombination is\n$$\nD_{\\mathrm{num}}(k) \\equiv \\frac{\\mathcal{A}(\\eta_{\\mathrm{rec}})}{\\delta_{0}} \\, .\n$$\n\nStandard diffusion damping baseline:\n- The standard “Silk” form is an exponential envelope $D_{\\mathrm{Silk}}(k) = \\exp\\!\\left[-(k/k_{D})^{2}\\right]$, where the diffusion scale $k_{D}$ is set by photon shear viscosity and heat conduction in the tight-coupling regime. Using $c_{s}^{2} = 1/\\left(3(1+R)\\right)$, define the diffusion scale at $\\eta_{\\mathrm{rec}}$ by\n$$\n\\frac{1}{k_{D}^{2}} \\equiv \\int_{0}^{\\eta_{\\mathrm{rec}}} \\frac{1}{6\\,\\dot{\\tau}(\\eta)} \\left( \\frac{16}{15} + \\frac{R^{2}}{1+R} \\right) \\, d\\eta \\, .\n$$\nThis baseline yields\n$$\nD_{\\mathrm{Silk}}(k) \\equiv \\exp\\!\\left[-\\left(\\frac{k}{k_{D}}\\right)^{2}\\right] \\, .\n$$\n\nTask:\n- Implement a program that, for each parameter set below, numerically integrates the coupled system from $\\eta=0$ to $\\eta=\\eta_{\\mathrm{rec}}$, computes $D_{\\mathrm{num}}(k)$ from the amplitude $\\mathcal{A}(\\eta_{\\mathrm{rec}})$, computes $k_{D}$ from the integral above, and then quantifies the beyond–tight-coupling correction as the ratio\n$$\n\\mathcal{C}(k) \\equiv \\frac{D_{\\mathrm{num}}(k)}{D_{\\mathrm{Silk}}(k)} \\, .\n$$\nYour program must output, for each test case, the single float $\\mathcal{C}(k)$.\n\nUnits:\n- All quantities are dimensionless in conformal units with $c=1$. You must output the correction ratios $\\mathcal{C}(k)$ as pure dimensionless floats.\n\nTest suite:\nUse $\\delta_{0}=1$. For each tuple $\\left(k, R, \\dot{\\tau}_{\\max}, \\eta_{\\mathrm{rec}}, \\Delta, \\dot{\\tau}_{\\min}\\right)$ below, compute and output $\\mathcal{C}(k)$ evaluated at $\\eta=\\eta_{\\mathrm{rec}}$:\n- Case $1$: $k=0.05$, $R=0.6$, $\\dot{\\tau}_{\\max}=2000$, $\\eta_{\\mathrm{rec}}=10.0$, $\\Delta=1.0$, $\\dot{\\tau}_{\\min}=0.01$.\n- Case $2$: $k=0.5$, $R=0.6$, $\\dot{\\tau}_{\\max}=800$, $\\eta_{\\mathrm{rec}}=10.0$, $\\Delta=1.0$, $\\dot{\\tau}_{\\min}=0.01$.\n- Case $3$: $k=2.0$, $R=0.6$, $\\dot{\\tau}_{\\max}=800$, $\\eta_{\\mathrm{rec}}=10.0$, $\\Delta=1.0$, $\\dot{\\tau}_{\\min}=0.01$.\n- Case $4$: $k=1.0$, $R=0.2$, $\\dot{\\tau}_{\\max}=800$, $\\eta_{\\mathrm{rec}}=10.0$, $\\Delta=0.5$, $\\dot{\\tau}_{\\min}=0.01$.\n- Case $5$: $k=1.0$, $R=1.0$, $\\dot{\\tau}_{\\max}=800$, $\\eta_{\\mathrm{rec}}=10.0$, $\\Delta=2.0$, $\\dot{\\tau}_{\\min}=0.01$.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the same order as the test suite above. For example: \"[x1,x2,x3,x4,x5]\". Each $x_{i}$ must be a float.",
            "solution": "The user has requested the implementation and analysis of a simplified model of photon-baryon acoustic oscillations, focusing on the calculation of a correction factor to the standard Silk diffusion damping.\n\n### Step 1: Problem Validation\n\nThe problem is first validated against the criteria of scientific soundness, well-posedness, and objectivity.\n\n-   **Givens Extraction**:\n    -   **Model**: A system of five coupled, first-order linear ordinary differential equations (ODEs) for the photon monopole $\\delta_{\\gamma}$, photon dipole $v_{\\gamma}$, photon quadrupole $F_{\\gamma 2}$, baryon density perturbation $\\delta_b$, and baryon velocity $v_b$. All are functions of conformal time $\\eta$ for a fixed comoving wavenumber $k$.\n    -   **Governing Equations**:\n        $$ \\delta_{\\gamma}' = -\\frac{4}{3} k \\, v_{\\gamma} $$\n        $$ v_{\\gamma}' = k \\left(\\frac{\\delta_{\\gamma}}{4} - \\frac{2}{5} F_{\\gamma 2}\\right) - \\dot{\\tau}(\\eta)\\,\\left(v_{\\gamma}-v_{b}\\right) $$\n        $$ F_{\\gamma 2}' = \\frac{8}{15} k \\, v_{\\gamma} - \\frac{9}{10}\\,\\dot{\\tau}(\\eta)\\,F_{\\gamma 2} $$\n        $$ \\delta_{b}' = -k \\, v_{b} $$\n        $$ v_{b}' = \\frac{\\dot{\\tau}(\\eta)}{R}\\,\\left(v_{\\gamma}-v_{b}\\right) $$\n    -   **Parameters and Definitions**:\n        -   Baryon loading: $R \\equiv 3\\rho_{b}/(4\\rho_{\\gamma})$, a constant.\n        -   Sound speed: $c_{s}^{2} = 1/\\left(3(1+R)\\right)$.\n        -   Thomson scattering rate: $\\dot{\\tau}(\\eta) = \\dot{\\tau}_{\\min} + \\frac{\\dot{\\tau}_{\\max}}{1+\\exp\\!\\left(\\frac{\\eta-\\eta_{\\mathrm{rec}}}{\\Delta}\\right)}$.\n    -   **Initial Conditions ($\\eta=0$)**: $\\delta_{\\gamma}(0)=\\delta_{0}$, $\\delta_{b}(0)=\\tfrac{3}{4}\\delta_{0}$, $v_{\\gamma}(0)=0$, $v_{b}(0)=0$, $F_{\\gamma 2}(0)=0$, with $\\delta_{0}=1$.\n    -   **Diagnostics**:\n        -   Instantaneous amplitude: $\\mathcal{A}(\\eta) \\equiv \\sqrt{ \\delta_{\\gamma}(\\eta)^{2} + \\left(\\frac{\\delta_{\\gamma}'(\\eta)}{k\\,c_{s}}\\right)^{2} }$.\n        -   Numerical damping factor: $D_{\\mathrm{num}}(k) = \\mathcal{A}(\\eta_{\\mathrm{rec}})/\\delta_{0}$.\n        -   Silk damping scale: $\\frac{1}{k_{D}^{2}} \\equiv \\int_{0}^{\\eta_{\\mathrm{rec}}} \\frac{1}{6\\,\\dot{\\tau}(\\eta)} \\left( \\frac{16}{15} + \\frac{R^{2}}{1+R} \\right) \\, d\\eta$.\n        -   Silk damping factor: $D_{\\mathrm{Silk}}(k) = \\exp\\!\\left[-(k/k_{D})^{2}\\right]$.\n    -   **Task**: Compute the correction factor $\\mathcal{C}(k) \\equiv D_{\\mathrm{num}}(k) / D_{\\mathrm{Silk}}(k)$ for five specified test cases.\n\n-   **Validation Verdict**:\n    -   **Scientifically Grounded**: The problem is a standard, albeit simplified, treatment of photon-baryon acoustic oscillations and diffusion damping in physical cosmology. The equations represent a truncated Boltzmann hierarchy coupled to baryon fluid equations, which is a foundational topic in the study of the Cosmic Microwave Background (CMB). All equations and definitions are standard in the field.\n    -   **Well-Posed**: The problem is an initial value problem (IVP) for a system of linear ODEs with well-behaved coefficients. This guarantees the existence of a unique, stable solution. The subsequent calculations are arithmetically and analytically well-defined.\n    -   **Objective**: The problem is expressed using precise mathematical formalism and objective physical language, free from ambiguity or subjective claims.\n    -   **Conclusion**: The problem is valid, self-contained, scientifically sound, and well-posed.\n\n### Step 2: Solution Design\n\nThe core task is to solve the system of five coupled ODEs and then compute a ratio of two kinds of damping factors. The overall strategy is as follows:\n\n1.  **Numerical Integration of the ODE System**: The system of five ODEs is solved numerically from $\\eta = 0$ to $\\eta = \\eta_{\\mathrm{rec}}$. The state vector is $y(\\eta) = [\\delta_{\\gamma}(\\eta), v_{\\gamma}(\\eta), F_{\\gamma 2}(\\eta), \\delta_{b}(\\eta), v_{b}(\\eta)]^T$. Due to the large values of $\\dot{\\tau}(\\eta)$ in the tight-coupling epoch ($\\eta \\ll \\eta_{\\text{rec}}$), the system is stiff. The stiffness arises from the large negative eigenvalue, approximately $-\\dot{\\tau}(1+1/R)$, associated with the rapid relaxation of the velocity difference $v_{\\gamma}-v_{b}$. To handle this stiffness efficiently and accurately, a suitable implicit ODE solver is required. The `Radau` method, available in `scipy.integrate.solve_ivp`, is an excellent choice for this purpose. The integration will be performed for each test case, using the provided initial conditions.\n\n2.  **Calculation of the Numerical Damping Factor $D_{\\mathrm{num}}(k)$**: After solving the ODEs to find the state vector $y(\\eta_{\\mathrm{rec}})$, the numerical damping factor is computed. This requires the instantaneous acoustic amplitude $\\mathcal{A}(\\eta_{\\mathrm{rec}})$. Using the first governing equation, $\\delta_{\\gamma}'(\\eta) = -\\frac{4}{3} k v_{\\gamma}(\\eta)$, the amplitude can be expressed in terms of the state variables:\n    $$ \\mathcal{A}(\\eta_{\\mathrm{rec}}) = \\sqrt{ \\delta_{\\gamma}(\\eta_{\\mathrm{rec}})^{2} + \\left(\\frac{-\\frac{4}{3} k v_{\\gamma}(\\eta_{\\mathrm{rec}})}{k\\,c_{s}}\\right)^{2} } = \\sqrt{ \\delta_{\\gamma}(\\eta_{\\mathrm{rec}})^{2} + \\left(\\frac{4 v_{\\gamma}(\\eta_{\\mathrm{rec}})}{3 c_{s}}\\right)^{2} } $$\n    The numerical damping factor is then $D_{\\mathrm{num}}(k) = \\mathcal{A}(\\eta_{\\mathrm{rec}}) / \\delta_{0}$. Since $\\delta_0 = 1$, we have $D_{\\mathrm{num}}(k) = \\mathcal{A}(\\eta_{\\mathrm{rec}})$. The values $\\delta_{\\gamma}(\\eta_{\\mathrm{rec}})$ and $v_{\\gamma}(\\eta_{\\mathrm{rec}})$ are taken directly from the output of the ODE solver.\n\n3.  **Calculation of the Silk Damping Factor $D_{\\mathrm{Silk}}(k)$**: This factor is based on a tight-coupling approximation. Its calculation requires the diffusion wavenumber $k_{D}$. The inverse square of the diffusion scale, $k_{D}^{-2}$, is given by an integral over conformal time:\n    $$ k_{D}^{-2} = \\int_{0}^{\\eta_{\\mathrm{rec}}} \\frac{1}{6\\,\\dot{\\tau}(\\eta)} \\left( \\frac{16}{15} + \\frac{R^{2}}{1+R} \\right) \\, d\\eta $$\n    The term in the parenthesis is constant with respect to $\\eta$. The integral of $1/\\dot{\\tau}(\\eta)$ is computed numerically using a robust quadrature routine, `scipy.integrate.quad`. The integrand is a smooth, well-behaved function, ensuring an accurate result. With $k_D^{-2}$ computed, the Silk damping factor is $D_{\\mathrm{Silk}}(k) = \\exp(-k^2 k_{D}^{-2})$.\n\n4.  **Final Correction Factor Calculation**: For each test case, the final beyond–tight-coupling correction factor $\\mathcal{C}(k)$ is computed as the ratio of the two damping factors:\n    $$ \\mathcal{C}(k) = \\frac{D_{\\mathrm{num}}(k)}{D_{\\mathrm{Silk}}(k)} $$\n\nThis procedure is encapsulated into a program that iterates through the five provided test cases, calculates $\\mathcal{C}(k)$ for each, and prints the results in the specified format.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.integrate import solve_ivp, quad\n\ndef solve():\n    \"\"\"\n    Solves the complete problem by iterating through test cases and\n    calculating the correction factor for each.\n    \"\"\"\n\n    def process_case(params):\n        \"\"\"\n        Processes a single test case to calculate the correction factor C(k).\n\n        Args:\n            params (tuple): A tuple of parameters (k, R, dot_tau_max, eta_rec, Delta, dot_tau_min).\n\n        Returns:\n            float: The calculated correction factor C(k).\n        \"\"\"\n        k, R, dot_tau_max, eta_rec, Delta, dot_tau_min = params\n\n        # --- Define physical and model functions ---\n        \n        def dot_tau(eta):\n            \"\"\"Calculates the Thomson scattering optical depth rate.\"\"\"\n            return dot_tau_min + dot_tau_max / (1.0 + np.exp((eta - eta_rec) / Delta))\n\n        def odes(eta, y):\n            \"\"\"\n            Defines the system of coupled first-order ordinary differential equations.\n            State vector y = [delta_gamma, v_gamma, F_gamma2, delta_b, v_b].\n            \"\"\"\n            delta_gamma, v_gamma, F_gamma2, delta_b, v_b = y\n            \n            tau_dot_val = dot_tau(eta)\n            \n            d_delta_gamma_dt = -4.0/3.0 * k * v_gamma\n            d_v_gamma_dt = k * (delta_gamma / 4.0 - 2.0/5.0 * F_gamma2) - tau_dot_val * (v_gamma - v_b)\n            d_F_gamma2_dt = 8.0/15.0 * k * v_gamma - 9.0/10.0 * tau_dot_val * F_gamma2\n            d_delta_b_dt = -k * v_b\n            d_v_b_dt = (tau_dot_val / R) * (v_gamma - v_b)\n            \n            return [d_delta_gamma_dt, d_v_gamma_dt, d_F_gamma2_dt, d_delta_b_dt, d_v_b_dt]\n\n        # --- Part 1: Numerically integrate the system ---\n        \n        # Constants and initial conditions\n        delta_0 = 1.0\n        cs2 = 1.0 / (3.0 * (1.0 + R))\n        cs = np.sqrt(cs2)\n        \n        y0 = [delta_0, 0.0, 0.0, 0.75 * delta_0, 0.0]\n        eta_span = [0.0, eta_rec]\n\n        # Use `solve_ivp` with the 'Radau' method for stiff ODEs.\n        sol = solve_ivp(\n            odes, \n            eta_span, \n            y0, \n            method='Radau', \n            t_eval=[eta_rec],\n            rtol=1e-8, atol=1e-10\n        )\n        \n        # Extract solution at eta_rec\n        y_rec = sol.y[:, -1]\n        delta_gamma_rec, v_gamma_rec = y_rec[0], y_rec[1]\n\n        # --- Part 2: Calculate the numerical damping factor D_num(k) ---\n        \n        # A(eta_rec) = sqrt( delta_gamma_rec^2 + ((-4/3 * v_gamma_rec) / cs)^2 )\n        A_rec = np.sqrt(delta_gamma_rec**2 + (4.0/3.0 * v_gamma_rec / cs)**2)\n        D_num = A_rec / delta_0\n\n        # --- Part 3: Calculate the Silk damping factor D_Silk(k) ---\n        \n        # Calculate 1/k_D^2 by integrating\n        k_D_const_factor = (1.0 / 6.0) * (16.0/15.0 + R**2 / (1.0 + R))\n\n        # The integrand for numerical integration is 1/dot_tau(eta)\n        integrand = lambda eta: 1.0 / dot_tau(eta)\n        \n        integral_val, _ = quad(integrand, 0, eta_rec, epsabs=1e-10, epsrel=1e-10)\n        \n        k_D_inv_sq = k_D_const_factor * integral_val\n        \n        D_silk = np.exp(-k**2 * k_D_inv_sq)\n        \n        # --- Part 4: Calculate the correction factor C(k) ---\n        \n        C_k = D_num / D_silk\n        \n        return C_k\n\n    # Test suite from the problem statement\n    test_cases = [\n        # (k, R, dot_tau_max, eta_rec, Delta, dot_tau_min)\n        (0.05, 0.6, 2000, 10.0, 1.0, 0.01),\n        (0.5, 0.6, 800, 10.0, 1.0, 0.01),\n        (2.0, 0.6, 800, 10.0, 1.0, 0.01),\n        (1.0, 0.2, 800, 10.0, 0.5, 0.01),\n        (1.0, 1.0, 800, 10.0, 2.0, 0.01),\n    ]\n\n    results = []\n    for case in test_cases:\n        result = process_case(case)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "The physical processes in the primordial plasma, including acoustic oscillations and diffusion damping, leave their final imprint on the observable angular power spectrum of the CMB, the $C_l^{TT}$. The damping of small-scale temperature fluctuations manifests as a characteristic suppression of power in the spectrum's \"damping tail\" for high multipoles (typically $l > 1000$). This culminating exercise guides you through the implementation of the line-of-sight integral, a fundamental calculation connecting theoretical source functions to observable anisotropies . You will learn to manage the numerical challenges of highly oscillatory functions and sharply peaked visibility windows, allowing you to compute the $C_l^{TT}$ values and directly witness the effect of Silk damping on the CMB sky.",
            "id": "3463745",
            "problem": "You are tasked with implementing a numerical integrator for the Cosmic Microwave Background (CMB) temperature anisotropy line-of-sight representation, explicitly capturing highly oscillatory spherical Bessel functions and a sharply peaked visibility function. Your implementation must be used to compute the high-multipole damping tail of the temperature angular power spectrum, and you must test numerical convergence with respect to the quadrature resolution.\n\nThe physical setup is a spatially flat universe in conformal time. The temperature multipole transfer function is defined by the line-of-sight integral\n$$\n\\Delta_l(k) \\equiv \\int d\\eta \\, g(\\eta) \\, F(k,\\eta) \\, j_l\\!\\big(k(\\tau_0 - \\eta)\\big),\n$$\nwhere $l$ is the multipole index, $k$ is the comoving wavenumber, $\\eta$ is the conformal time, $g(\\eta)$ is the visibility function, $F(k,\\eta)$ is a model source function, and $j_l(x)$ is the spherical Bessel function of the first kind. The temperature angular power spectrum is then modeled as\n$$\nC_l^{TT} \\equiv 4\\pi \\int_{k_{\\min}}^{k_{\\max}} d(\\ln k) \\, \\mathcal{P}_{\\mathcal{R}}(k) \\left[\\Delta_l(k)\\right]^2,\n$$\nwhere $\\mathcal{P}_{\\mathcal{R}}(k)$ is the primordial curvature power spectrum. You will assume a Gaussian visibility function centered at recombination and a simplified source function that captures acoustic oscillations and diffusion damping (Silk damping).\n\nUse the following scientifically plausible and self-consistent model definitions and fiducial parameters:\n- Conformal time today: $\\tau_0 = 14000 \\,\\mathrm{Mpc}$.\n- Recombination time: $\\eta_* = 280 \\,\\mathrm{Mpc}$.\n- Visibility function (Gaussian, normalized to unit area):\n$$\ng(\\eta) = \\frac{1}{\\sqrt{2\\pi}\\,\\sigma_\\eta} \\exp\\!\\left[-\\frac{(\\eta-\\eta_*)^2}{2\\sigma_\\eta^2}\\right],\n$$\nwith width $\\sigma_\\eta$ specified per test.\n- Acoustic source factor with diffusion damping:\n$$\nF(k,\\eta) = \\cos\\!\\big(k\\,c_s\\,(\\eta_*-\\eta)\\big)\\,\\exp\\!\\left[-\\left(\\frac{k}{k_D}\\right)^2\\right],\n$$\nwhere $c_s = 1/\\sqrt{3}$ is the sound speed of the tightly coupled baryon–photon fluid and $k_D = 0.15\\,\\mathrm{Mpc}^{-1}$ is a fixed characteristic diffusion damping scale (evaluated at last scattering).\n- Primordial curvature power spectrum (power law):\n$$\n\\mathcal{P}_{\\mathcal{R}}(k) = A_s \\left(\\frac{k}{k_0}\\right)^{n_s - 1},\n$$\nwith amplitude $A_s = 2.1\\times 10^{-9}$, spectral index $n_s = 0.965$, and pivot $k_0 = 0.05\\,\\mathrm{Mpc}^{-1}$.\n- Wavenumber integration limits: $k_{\\min} = 10^{-4}\\,\\mathrm{Mpc}^{-1}$ and $k_{\\max} = 0.5\\,\\mathrm{Mpc}^{-1}$.\n\nNumerical integration requirements:\n- The $\\eta$-integral must be computed using Gauss–Hermite quadrature by exploiting the Gaussian form of $g(\\eta)$. Specifically, perform the change of variables $y = (\\eta - \\eta_*)/(\\sqrt{2}\\,\\sigma_\\eta)$ to rewrite\n$$\n\\Delta_l(k) = \\frac{1}{\\sqrt{\\pi}} \\int_{-\\infty}^{+\\infty} dy \\, e^{-y^2} \\, F\\!\\big(k,\\eta_* + \\sqrt{2}\\,\\sigma_\\eta y\\big) \\, j_l\\!\\Big(k\\big(\\tau_0 - \\eta_* - \\sqrt{2}\\,\\sigma_\\eta y\\big)\\Big),\n$$\nand then apply $N_\\eta$-point Gauss–Hermite quadrature $(x_i,w_i)$:\n$$\n\\Delta_l(k) \\approx \\frac{1}{\\sqrt{\\pi}} \\sum_{i=1}^{N_\\eta} w_i \\, F\\!\\big(k,\\eta_* + \\sqrt{2}\\,\\sigma_\\eta x_i\\big) \\, j_l\\!\\Big(k\\big(\\tau_0 - \\eta_* - \\sqrt{2}\\,\\sigma_\\eta x_i\\big)\\Big).\n$$\n- The $k$-integral must be computed on a logarithmic grid with $N_k$ points, using a stable composite rule on $d(\\ln k)$.\n\nUnits and output:\n- All physical quantities must be in megaparsecs and inverse megaparsecs, as already specified. Your final outputs are dimensionless values of $C_l^{TT}$; express the final results as floating-point numbers with no physical units.\n\nTest suite:\nCompute $C_l^{TT}$ for the following parameter sets to probe the damping tail and test convergence with respect to $N_\\eta$ and $N_k$. Each test case is a tuple $(l,\\sigma_\\eta,N_\\eta,N_k)$:\n1. $(1500, 20, 40, 300)$ — happy path in the damping tail with moderate quadrature.\n2. $(1500, 20, 20, 300)$ — reduced $N_\\eta$ to test sensitivity to $\\eta$ resolution.\n3. $(1500, 20, 80, 300)$ — increased $N_\\eta$ to test improved convergence.\n4. $(2000, 10, 40, 300)$ — deeper damping tail, narrower visibility.\n5. $(2000, 5, 16, 300)$ — very sharp visibility with coarse $N_\\eta$ as an edge case.\n6. $(1500, 20, 40, 150)$ — reduced $N_k$ to test $k$-grid resolution.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (for example, $[r_1,r_2,r_3,r_4,r_5,r_6]$), where each $r_i$ is the computed $C_l^{TT}$ for the corresponding test case, represented as a floating-point number with no physical units.",
            "solution": "The problem requires the numerical computation of the Cosmic Microwave Background (CMB) temperature angular power spectrum, $C_l^{TT}$, for high multipoles $l$. This involves a two-dimensional integration, which must be implemented following a prescribed numerical strategy. The solution involves developing a Python program that correctly applies these numerical methods to the provided physical model.\n\nThe core of the problem lies in evaluating the expression for the angular power spectrum, which is given by:\n$$\nC_l^{TT} \\equiv 4\\pi \\int_{k_{\\min}}^{k_{\\max}} d(\\ln k) \\, \\mathcal{P}_{\\mathcal{R}}(k) \\left[\\Delta_l(k)\\right]^2\n$$\nHere, $\\mathcal{P}_{\\mathcal{R}}(k)$ is the primordial curvature power spectrum, and $\\Delta_l(k)$ is the temperature multipole transfer function, defined by the line-of-sight integral:\n$$\n\\Delta_l(k) \\equiv \\int d\\eta \\, g(\\eta) \\, F(k,\\eta) \\, j_l\\!\\big(k(\\tau_0 - \\eta)\\big)\n$$\nThe problem provides specific functional forms and parameters for all components.\n\nThe primordial power spectrum is a power law:\n$$\n\\mathcal{P}_{\\mathcal{R}}(k) = A_s \\left(\\frac{k}{k_0}\\right)^{n_s - 1}\n$$\nwith amplitude $A_s = 2.1\\times 10^{-9}$, spectral index $n_s = 0.965$, and pivot scale $k_0 = 0.05\\,\\mathrm{Mpc}^{-1}$.\n\nThe source function, $F(k,\\eta)$, models acoustic oscillations and diffusion (Silk) damping:\n$$\nF(k,\\eta) = \\cos\\!\\big(k\\,c_s\\,(\\eta_*-\\eta)\\big)\\,\\exp\\!\\left[-\\left(\\frac{k}{k_D}\\right)^2\\right]\n$$\nwhere the sound speed is $c_s = 1/\\sqrt{3}$ and the damping scale is $k_D = 0.15\\,\\mathrm{Mpc}^{-1}$.\n\nThe visibility function, $g(\\eta)$, which describes the probability density of a photon last scattering at conformal time $\\eta$, is a normalized Gaussian centered at the time of recombination, $\\eta_* = 280\\,\\mathrm{Mpc}$:\n$$\ng(\\eta) = \\frac{1}{\\sqrt{2\\pi}\\,\\sigma_\\eta} \\exp\\!\\left[-\\frac{(\\eta-\\eta_*)^2}{2\\sigma_\\eta^2}\\right]\n$$\nThe width of this function, $\\sigma_\\eta$, varies between test cases.\n\nThe numerical solution is implemented in two nested stages, corresponding to the two integrals for $\\Delta_l(k)$ and $C_l^{TT}$.\n\n**1. Inner Integral: Computation of the Transfer Function $\\Delta_l(k)$**\n\nThe integral for $\\Delta_l(k)$ is evaluated using Gauss–Hermite quadrature. This method is specifically chosen because the visibility function $g(\\eta)$ provides a Gaussian weight. The problem prescribes a change of variables, $y = (\\eta - \\eta_*)/(\\sqrt{2}\\,\\sigma_\\eta)$, which transforms the integral into the standard form for Gauss-Hermite quadrature:\n$$\n\\Delta_l(k) = \\frac{1}{\\sqrt{\\pi}} \\int_{-\\infty}^{+\\infty} dy \\, e^{-y^2} \\, H(y)\n$$\nwhere the function $H(y)$ is the remainder of the integrand:\n$$\nH(y) = F\\!\\big(k,\\eta_* + \\sqrt{2}\\,\\sigma_\\eta y\\big) \\, j_l\\!\\Big(k\\big(\\tau_0 - \\eta_* - \\sqrt{2}\\,\\sigma_\\eta y\\big)\\Big)\n$$\nApplying an $N_\\eta$-point Gauss-Hermite quadrature rule with abscissas $x_i$ and weights $w_i$ yields the approximation:\n$$\n\\Delta_l(k) \\approx \\frac{1}{\\sqrt{\\pi}} \\sum_{i=1}^{N_\\eta} w_i \\, H(x_i)\n$$\nIn the implementation, the required abscissas and weights are obtained using `scipy.special.roots_hermite`. The spherical Bessel function, $j_l(z)$, is computed using `scipy.special.spherical_jn`. The calculation is vectorized over the $N_\\eta$ quadrature points for efficiency.\n\n**2. Outer Integral: Computation of the Power Spectrum $C_l^{TT}$**\n\nThe outer integral for $C_l^{TT}$ is performed over the comoving wavenumber $k$. The problem specifies integration with respect to $d(\\ln k)$ over a logarithmic grid of $N_k$ points from $k_{\\min} = 10^{-4}\\,\\mathrm{Mpc}^{-1}$ to $k_{\\max} = 0.5\\,\\mathrm{Mpc}^{-1}$. We define a grid of $N_k$ points in $\\ln k$ that are uniformly spaced, and then compute the corresponding $k$ values.\n\nLet the integrand be $I(k) = \\mathcal{P}_{\\mathcal{R}}(k) \\left[\\Delta_l(k)\\right]^2$. The integral becomes:\n$$\nC_l^{TT} = 4\\pi \\int_{\\ln k_{\\min}}^{\\ln k_{\\max}} d(\\ln k) \\, I(e^{\\ln k})\n$$\nThis definite integral is computed numerically using the composite trapezoidal rule, which is well-suited for functions sampled on a uniform grid. The `numpy.trapz` function is used for this purpose.\n\n**3. Algorithmic Implementation and Vectorization**\n\nThe overall algorithm is encapsulated within a function `compute_Cl_TT(l, sigma_eta, N_eta, N_k)`. For maximum performance, the entire computation is vectorized using NumPy, avoiding explicit Python loops where possible. A 2D grid is implicitly formed from the $N_k$ wavenumber points and the $N_\\eta$ quadrature points. All terms in the $\\Delta_l(k)$ integrand are computed on this 2D grid using NumPy's broadcasting capabilities. The sum for the Gauss-Hermite quadrature is then performed along the appropriate axis, yielding a vector of $\\Delta_l(k)$ values for all $k$ in a single operation. This vector is then used to compute the integrand for the $C_l^{TT}$ integral, which is subsequently evaluated with `numpy.trapz`.\n\nA main `solve` function iterates through the provided test cases, calls the `compute_Cl_TT` function for each parameter set, and collates the results into a list. Finally, it formats and prints the output string as required. The constants provided, such as $\\tau_0=14000\\,\\mathrm{Mpc}$, are defined globally within the script.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import special\n\ndef solve():\n    \"\"\"\n    Computes the CMB temperature angular power spectrum C_l^{TT} for a set of test cases.\n    \"\"\"\n    # Define physical constants and fiducial cosmological parameters.\n    # All distance units are in Megaparsecs (Mpc).\n    TAU0 = 14000.0  # Conformal time today [Mpc]\n    ETA_STAR = 280.0  # Conformal time at recombination [Mpc]\n    C_S = 1.0 / np.sqrt(3.0)  # Sound speed of the baryon-photon fluid\n    K_D = 0.15  # Diffusion damping scale [Mpc^-1]\n    A_S = 2.1e-9  # Amplitude of the primordial curvature power spectrum\n    N_S = 0.965  # Spectral index of the primordial curvature power spectrum\n    K0 = 0.05  # Pivot scale for the primordial spectrum [Mpc^-1]\n    K_MIN = 1e-4  # Minimum wavenumber for integration [Mpc^-1]\n    K_MAX = 0.5  # Maximum wavenumber for integration [Mpc^-1]\n\n    def P_R(k):\n        \"\"\"\n        Calculates the primordial curvature power spectrum P_R(k).\n        \"\"\"\n        return A_S * (k / K0)**(N_S - 1)\n\n    def compute_Cl_TT(l, sigma_eta, N_eta, N_k):\n        \"\"\"\n        Computes the angular power spectrum C_l^TT using the specified numerical methods.\n        \n        Args:\n            l (int): Multipole index.\n            sigma_eta (float): Width of the Gaussian visibility function [Mpc].\n            N_eta (int): Number of quadrature points for the eta-integral.\n            N_k (int): Number of grid points for the k-integral.\n\n        Returns:\n            float: The computed value of C_l^TT.\n        \"\"\"\n        # 1. Set up the logarithmic wavenumber grid for the outer integral.\n        log_k_grid = np.linspace(np.log(K_MIN), np.log(K_MAX), N_k)\n        k_grid = np.exp(log_k_grid)  # Shape: (N_k,)\n\n        # 2. Set up the Gauss-Hermite quadrature for the inner integral.\n        # roots_hermite returns abscissas x_i and weights w_i for integral e^(-x^2)f(x)dx.\n        x_i, w_i = special.roots_hermite(N_eta)  # Shapes: (N_eta,), (N_eta,)\n\n        # 3. Vectorize the computation of Delta_l(k) over both k and eta grids.\n        # Use NumPy broadcasting to create 2D arrays from 1D grids.\n        # k_grid_2d shape: (N_k, 1), x_i_2d shape: (1, N_eta)\n        k_grid_2d = k_grid[:, np.newaxis]\n        x_i_2d = x_i[np.newaxis, :]\n        \n        # Transform quadrature variable y (our x_i) back to conformal time eta.\n        # eta_i_2d has shape (N_k, N_eta).\n        eta_i_2d = ETA_STAR + np.sqrt(2.0) * sigma_eta * x_i_2d\n\n        # 4. Calculate the components of the Delta_l(k) integrand.\n        \n        # Source function F(k, eta)\n        cos_term = np.cos(k_grid_2d * C_S * (ETA_STAR - eta_i_2d))\n        damping_term = np.exp(-(k_grid_2d / K_D)**2)\n        F_vals_2d = cos_term * damping_term  # Shape: (N_k, N_eta)\n\n        # Spherical Bessel function j_l(k(tau0 - eta))\n        bessel_arg_2d = k_grid_2d * (TAU0 - eta_i_2d)\n        j_l_vals_2d = special.spherical_jn(l, bessel_arg_2d)  # Shape: (N_k, N_eta)\n\n        # 5. Perform the Gauss-Hermite quadrature sum over the eta-axis (axis=1).\n        # w_i is broadcast to shape (1, N_eta).\n        integrand_sum = np.sum(w_i[np.newaxis, :] * F_vals_2d * j_l_vals_2d, axis=1)\n        \n        # The transfer function Delta_l(k) for all k in k_grid.\n        delta_l_k_vals = (1.0 / np.sqrt(np.pi)) * integrand_sum  # Shape: (N_k,)\n\n        # 6. Compute the integrand for the C_l^TT integral.\n        cl_integrand = P_R(k_grid) * (delta_l_k_vals**2)\n\n        # 7. Perform the outer integral over d(ln k) using the trapezoidal rule.\n        cl_integral_val = np.trapz(cl_integrand, x=log_k_grid)\n        \n        return 4.0 * np.pi * cl_integral_val\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (l, sigma_eta, N_eta, N_k)\n        (1500, 20, 40, 300),  # 1. happy path\n        (1500, 20, 20, 300),  # 2. reduced N_eta\n        (1500, 20, 80, 300),  # 3. increased N_eta\n        (2000, 10, 40, 300),  # 4. deeper damping tail\n        (2000, 5, 16, 300),   # 5. sharp visibility, coarse N_eta\n        (1500, 20, 40, 150),  # 6. reduced N_k\n    ]\n\n    results = []\n    for case in test_cases:\n        l, sigma_eta, N_eta, N_k = case\n        result = compute_Cl_TT(l, sigma_eta, N_eta, N_k)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```"
        }
    ]
}