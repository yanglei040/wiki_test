{
    "hands_on_practices": [
        {
            "introduction": "Press-Schechter (PS) 质量函数是预测暗物质晕丰度的核心工具。它的预测对作为输入的物质功率谱极为敏感，而功率谱的形态则直接反映了宇宙的物质组分，特别是暗物质的性质。这个练习将让你亲手计算并体会不同暗物质模型（如温暗物质和有质量中微子）如何通过抑制小尺度上的结构形成，来改变对暗晕数量的预测。通过这个计算，你将更深刻地理解理论预测与宇宙学模型参数之间的直接联系 。",
            "id": "3482256",
            "problem": "考虑物质密度涨落的高斯初始条件，其功率谱为 $P(k)$，并使用一个实空间顶帽滤波器，其拉格朗日半径 $R(M)$ 通过 $M = (4\\pi/3)\\,\\bar{\\rho}_{\\mathrm{m}}\\,R^{3}$ 与质量 $M$ 相关联，其中 $\\bar{\\rho}_{\\mathrm{m}}$ 是共动平均物质密度。在质量标度 $M$ 上平滑后的线性外推密度场的方差为\n$$\n\\sigma^{2}(M) \\equiv \\int_{0}^{\\infty} \\frac{\\mathrm{d}k}{2\\pi^{2}}\\,k^{2}\\,P(k)\\,|W(kR)|^{2},\n$$\n其中 $W(x)$ 是实空间顶帽窗函数的傅里叶变换。在常数阈值漂移集方法（等效于 Press–Schechter 方案）中，红移 $z=0$ 时的坍缩阈值为 $\\delta_{\\mathrm{c}}=1.686$。\n\n现在比较三种在 $z=0$ 时的宇宙学模型：\n- 一个基准冷暗物质（CDM）模型。\n- 一个温暗物质（WDM）模型，由半模波数 $k_{\\mathrm{hm}}$ 定义，满足 $T_{\\mathrm{WDM}}^{2}(k_{\\mathrm{hm}})=1/2$，其中 $T_{\\mathrm{WDM}}(k)$ 是相对于 CDM 的线性理论传递函数比。\n- 一个 WDM 加有质量中微子的组合模型，其中中微子质量分数 $f_{\\nu} \\equiv \\Omega_{\\nu}/\\Omega_{\\mathrm{m}} = 0.010$，自由流标度为 $k_{\\mathrm{fs}}$，满足 $k_{\\mathrm{hm}} \\gg k_{\\mathrm{fs}}$，这使得由中微子引起的总物质传递函数的渐近小尺度抑制在 $k \\simeq k_{\\mathrm{hm}}$ 附近可被视为与标度无关。\n\n采用以下受控且广泛使用的近似，其合理性由 $|W(kR)|^{2}$ 在 $P(k)$ 的准幂律段上关于 $k \\sim R^{-1}$ 的窄 k 响应来证明：\n1. 在对应于 $k \\simeq k_{\\mathrm{hm}}$ 的质量 $M$ 处（即在半模质量 $M_{\\mathrm{hm}}$ 处），通过将 CDM 方差乘以在 $k_{\\mathrm{hm}}$ 处计算的传递函数抑制的乘积，来近似 WDM 加中微子模型中的方差，\n$$\n\\sigma^{2}_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})\\,\\approx\\,T_{\\mathrm{WDM}}^{2}(k_{\\mathrm{hm}})\\,T_{\\nu}^{2}(k_{\\mathrm{hm}})\\,\\sigma^{2}_{\\mathrm{CDM}}(M_{\\mathrm{hm}}).\n$$\n使用小尺度线性理论近似 $T_{\\nu}^{2}(k_{\\mathrm{hm}})\\simeq 1-8f_{\\nu}$。\n2. 在领头阶上，忽略 CDM 模型和 WDM 加中微子模型在 $M_{\\mathrm{hm}}$ 处局域对数斜率 $\\mathrm{d}\\ln \\sigma/\\mathrm{d}\\ln M$ 之间的任何变化，因此在固定质量 $M$ 处，Press–Schechter 晕质量函数的主要变化由 $\\sigma(M)$ 因子和对 $\\delta_{\\mathrm{c}}/\\sigma(M)$ 的指数敏感性控制。\n\n假设对于一个基准 $\\Lambda$CDM 宇宙学模型，其 CDM 功率谱的数值积分得出\n$$\n\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})=1.000.\n$$\n使用漂移集跨越阈值图像和上述近似，推导比值\n$$\n\\mathcal{S}\\,\\equiv\\,\\frac{n_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})}{n_{\\mathrm{CDM}}(M_{\\mathrm{hm}})}\n$$\n的解析表达式，用 $\\delta_{\\mathrm{c}}$、$\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})$ 和 $f_{\\nu}$ 表示。然后，使用 $\\delta_{\\mathrm{c}}=1.686$、$\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})=1.000$、 $f_{\\nu}=0.010$ 和 $T_{\\mathrm{WDM}}^{2}(k_{\\mathrm{hm}})=1/2$ 对其进行数值计算。\n\n将您对 $\\mathcal{S}$ 的最终答案表示为小数，并四舍五入到四位有效数字。",
            "solution": "问题要求计算温暗物质加有质量中微子 (WDM+$\\nu$) 宇宙学模型与标准冷暗物质 (CDM) 宇宙学模型的晕质量函数之比，并在特定质量标度 $M_{\\mathrm{hm}}$ 处进行评估。其理论框架是 Press-Schechter (PS) 模型，该模型等效于问题中提到的常数阈值漂移集理论。\n\nPS 微分晕质量函数 $n(M)$ 给出每单位质量间隔内晕的共动数密度，其表达式为：\n$$\nn(M) = \\frac{\\bar{\\rho}_{\\mathrm{m}}}{M} f(\\sigma) \\left| \\frac{\\mathrm{d}\\sigma}{\\mathrm{d}M} \\right|\n$$\n其中 $\\bar{\\rho}_{\\mathrm{m}}$ 是宇宙的平均共动物质密度，$M$ 是晕质量，$\\sigma(M)$ 是在对应于质量 $M$ 的标度上平滑后的线性密度场的均方根 (rms)。函数 $f(\\sigma)$ 是多重性函数，对于 PS 模型，其形式为：\n$$\nf_{\\mathrm{PS}}(\\sigma) = \\sqrt{\\frac{2}{\\pi}} \\frac{\\delta_{\\mathrm{c}}}{\\sigma} \\exp\\left(-\\frac{\\delta_{\\mathrm{c}}^2}{2\\sigma^2}\\right)\n$$\n此处，$\\delta_{\\mathrm{c}}$ 是线性理论中坍缩的临界超密度，给定值为 $\\delta_{\\mathrm{c}} = 1.686$。\n\n将多重性函数代入 $n(M)$ 的表达式，并使用链式法则 $\\left| \\frac{\\mathrm{d}\\sigma}{\\mathrm{d}M} \\right| = \\frac{\\sigma}{M} \\left| \\frac{\\mathrm{d}\\ln\\sigma}{\\mathrm{d}\\ln M} \\right|$ 重写导数项，我们得到：\n$$\nn(M) = \\frac{\\bar{\\rho}_{\\mathrm{m}}}{M^2} \\sqrt{\\frac{2}{\\pi}} \\frac{\\delta_{\\mathrm{c}}}{\\sigma(M)} \\exp\\left(-\\frac{\\delta_{\\mathrm{c}}^2}{2\\sigma(M)^2}\\right) \\left| \\frac{\\mathrm{d}\\ln\\sigma}{\\mathrm{d}\\ln M} \\right|\n$$\n我们需要求出比值 $\\mathcal{S} \\equiv n_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}}) / n_{\\mathrm{CDM}}(M_{\\mathrm{hm}})$。令 WDM+$\\nu$ 模型的量用下标“WDM+$\\nu$”表示，CDM 模型的量用“CDM”表示。该比值为：\n$$\n\\mathcal{S} = \\frac{n_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})}{n_{\\mathrm{CDM}}(M_{\\mathrm{hm}})} = \\frac{\\frac{\\bar{\\rho}_{\\mathrm{m}}}{M_{\\mathrm{hm}}^2} \\sqrt{\\frac{2}{\\pi}} \\frac{\\delta_{\\mathrm{c}}}{\\sigma_{\\mathrm{WDM}+\\nu}} \\exp\\left(-\\frac{\\delta_{\\mathrm{c}}^2}{2\\sigma_{\\mathrm{WDM}+\\nu}^2}\\right) \\left| \\frac{\\mathrm{d}\\ln\\sigma_{\\mathrm{WDM}+\\nu}}{\\mathrm{d}\\ln M}\\right|_{M_{\\mathrm{hm}}}}\n{\\frac{\\bar{\\rho}_{\\mathrm{m}}}{M_{\\mathrm{hm}}^2} \\sqrt{\\frac{2}{\\pi}} \\frac{\\delta_{\\mathrm{c}}}{\\sigma_{\\mathrm{CDM}}} \\exp\\left(-\\frac{\\delta_{\\mathrm{c}}^2}{2\\sigma_{\\mathrm{CDM}}^2}\\right) \\left| \\frac{\\mathrm{d}\\ln\\sigma_{\\mathrm{CDM}}}{\\mathrm{d}\\ln M}\\right|_{M_{\\mathrm{hm}}}}\n$$\n所有的方差 $\\sigma$ 都在 $M_{\\mathrm{hm}}$ 处计算。许多项会消去：\n$$\n\\mathcal{S} = \\frac{\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})}{\\sigma_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})} \\exp\\left[ \\frac{\\delta_{\\mathrm{c}}^2}{2} \\left( \\frac{1}{\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})^2} - \\frac{1}{\\sigma_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})^2} \\right) \\right] \\frac{\\left| \\frac{\\mathrm{d}\\ln\\sigma_{\\mathrm{WDM}+\\nu}}{\\mathrm{d}\\ln M}\\right|_{M_{\\mathrm{hm}}}}{\\left| \\frac{\\mathrm{d}\\ln\\sigma_{\\mathrm{CDM}}}{\\mathrm{d}\\ln M}\\right|_{M_{\\mathrm{hm}}}}\n$$\n问题陈述要求在领头阶上忽略不同模型在 $M_{\\mathrm{hm}}$ 处局域对数斜率 $\\mathrm{d}\\ln \\sigma/\\mathrm{d}\\ln M$ 的变化。这意味着导数项之比近似为 1。$\\mathcal{S}$ 的表达式简化为：\n$$\n\\mathcal{S} \\approx \\frac{\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})}{\\sigma_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})} \\exp\\left[ \\frac{\\delta_{\\mathrm{c}}^2}{2\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})^2} \\left( 1 - \\frac{\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})^2}{\\sigma_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})^2} \\right) \\right]\n$$\n接下来，我们使用问题给出的 WDM+$\\nu$ 模型中方差的近似：\n$$\n\\sigma^{2}_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})\\,\\approx\\,T_{\\mathrm{WDM}}^{2}(k_{\\mathrm{hm}})\\,T_{\\nu}^{2}(k_{\\mathrm{hm}})\\,\\sigma^{2}_{\\mathrm{CDM}}(M_{\\mathrm{hm}})\n$$\n我们已知 $T_{\\mathrm{WDM}}^{2}(k_{\\mathrm{hm}}) = 1/2$ 以及近似 $T_{\\nu}^{2}(k_{\\mathrm{hm}})\\simeq 1-8f_{\\nu}$。将这些代入，我们得到方差之比：\n$$\n\\frac{\\sigma^{2}_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})}{\\sigma^{2}_{\\mathrm{CDM}}(M_{\\mathrm{hm}})} \\approx \\frac{1}{2}(1-8f_{\\nu})\n$$\n该比值的倒数为：\n$$\n\\frac{\\sigma^{2}_{\\mathrm{CDM}}(M_{\\mathrm{hm}})}{\\sigma^{2}_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})} \\approx \\frac{2}{1-8f_{\\nu}}\n$$\n将此代入 $\\mathcal{S}$ 的表达式中：\n$$\n\\mathcal{S} \\approx \\left(\\frac{\\sigma^{2}_{\\mathrm{CDM}}(M_{\\mathrm{hm}})}{\\sigma^{2}_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})}\\right)^{1/2} \\exp\\left[ \\frac{\\delta_{\\mathrm{c}}^2}{2\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})^2} \\left( 1 - \\frac{\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})^2}{\\sigma_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})^2} \\right) \\right]\n$$\n$$\n\\mathcal{S} \\approx \\sqrt{\\frac{2}{1-8f_{\\nu}}} \\exp\\left[ \\frac{\\delta_{\\mathrm{c}}^2}{2\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})^2} \\left( 1 - \\frac{2}{1-8f_{\\nu}} \\right) \\right]\n$$\n简化指数内的项：\n$$\n1 - \\frac{2}{1-8f_{\\nu}} = \\frac{1-8f_{\\nu}-2}{1-8f_{\\nu}} = -\\frac{1+8f_{\\nu}}{1-8f_{\\nu}}\n$$\n这就得出了用指定参数表示的 $\\mathcal{S}$ 的最终解析表达式：\n$$\n\\mathcal{S} \\approx \\sqrt{\\frac{2}{1-8f_{\\nu}}} \\exp\\left[ -\\frac{\\delta_{\\mathrm{c}}^2}{2\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})^2} \\left( \\frac{1+8f_{\\nu}}{1-8f_{\\nu}} \\right) \\right]\n$$\n现在我们使用给定的值对这个表达式进行数值计算：$\\delta_{\\mathrm{c}} = 1.686$，$\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}}) = 1.000$ 和 $f_{\\nu}=0.010$。\n\n首先，我们计算涉及 $f_{\\nu}$ 的项：\n$$\n1-8f_{\\nu} = 1 - 8(0.010) = 1 - 0.08 = 0.92\n$$\n$$\n1+8f_{\\nu} = 1 + 8(0.010) = 1 + 0.08 = 1.08\n$$\n指前因子为：\n$$\n\\sqrt{\\frac{2}{1-8f_{\\nu}}} = \\sqrt{\\frac{2}{0.92}} \\approx \\sqrt{2.173913...} \\approx 1.4744195...\n$$\n指数的宗量为：\n$$\n-\\frac{\\delta_{\\mathrm{c}}^2}{2\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})^2} \\left( \\frac{1+8f_{\\nu}}{1-8f_{\\nu}} \\right) = -\\frac{(1.686)^2}{2(1.000)^2} \\left( \\frac{1.08}{0.92} \\right)\n$$\n$$\n\\approx -\\frac{2.842596}{2} (1.173913...) \\approx -1.421298 \\times 1.173913... \\approx -1.668541...\n$$\n指数项为：\n$$\n\\exp(-1.668541...) \\approx 0.188518...\n$$\n最后，我们计算 $\\mathcal{S}$：\n$$\n\\mathcal{S} \\approx 1.4744195... \\times 0.188518... \\approx 0.277953...\n$$\n将结果四舍五入到四位有效数字，我们得到 $0.2780$。",
            "answer": "$$\\boxed{0.2780}$$"
        },
        {
            "introduction": "在掌握了如何计算给定时刻的晕质量函数之后，我们将更进一步，探索暗物质晕的形成历史。漂移集理论的真正威力在于它能够描述晕的增长过程，即合并历史，而这一切的核心便是条件质量函数。这个练习要求你从随机游走的基本原理出发，推导出条件首次穿越概率分布，并将其付诸实践，用于计算一个给定暗晕在更早时期的前身天体（progenitor）的统计性质，这是构建合并树（merger tree）的关键一步 。",
            "id": "3482200",
            "problem": "您的任务是在一个科学受控且数值自洽的设定下，推导、实现并验证扩展Press-Schechter框架下漂移集理论中并合树构建所依据的条件质量函数。除非明确指定单位，否则所有物理和数学量都必须视为无量纲量。当指定单位时，请按照指示以该单位报告相应的量。\n\n起点（仅基础理论）：\n\n- 初始密度扰动是一个统计上均匀、各向同性的高斯随机场，其线性功率谱为 $P(k)$。\n- 平滑后的密度扰动 $\\delta(R)$ 是通过在傅里叶空间中与球对称窗口函数 $W(kR)$ 进行卷积得到的。平滑场的方差为 $S(R) \\equiv \\sigma^{2}(R) = \\int_{0}^{\\infty} \\mathrm{d}\\ln k\\, \\Delta^{2}(k)\\, |W(kR)|^{2}$，其中 $\\Delta^{2}(k) \\equiv k^{3} P(k)/(2\\pi^{2})$。\n- 对于无标度功率谱 $P(k) = A k^{n}$（其中 $n \\in (-3,1)$）和 sharp-k 滤波器 $W(kR) = \\Theta(1 - kR)$，可以得到 $S(R) \\propto R^{-(n+3)}$，并且利用 $M \\propto R^{3}$，可得 $S(M) \\propto M^{-(n+3)/3}$。\n- 在 Einstein–de Sitter 背景宇宙中，线性增长因子为 $D(z) = 1/(1+z)$，球坍缩阈值为 $\\delta_{\\mathrm{sc}} \\approx 1.686$，因此作为红移函数的线性壁垒为 $\\delta(z) = \\delta_{\\mathrm{sc}}/D(z)$。\n\n问题要求：\n\n1. 从高斯初始条件下 sharp-k 滤波随机游走 $\\delta(S)$ 的马尔可夫性以及布朗运动首次穿越常数壁垒的反射原理出发，推导一个从 $(S_{0}, \\delta_{0})$ 开始并在 $S_{1}  S_{0}$ 首次穿越常数壁垒 $\\delta_{1}  \\delta_{0}$ 的随机游走的条件首次穿越分布。您的推导必须将结果表示为函数 $f(S_{1}\\,|\\,S_{0};\\,\\delta_{1}-\\delta_{0})$，并证明其在 $S_{1}$ 上从 $S_{0}$ 到 $\\infty$ 的积分为 $1$。\n2. 将情况特化为 $n = -2$，并通过以下归一化定义 $S(M)$\n   $$S(M) = \\left(\\frac{M}{M_{\\star}}\\right)^{-\\alpha}, \\quad \\alpha \\equiv \\frac{n+3}{3} = \\frac{1}{3}, \\quad M_{\\star} = 10^{12}\\, M_{\\odot},$$\n   其中 $M_{\\odot}$ 表示太阳质量。本问题中所有质量都必须以 $M_{\\odot}$ 为单位表示。\n3. 使用您推导的 $f(S_{1}\\,|\\,S_{0})$，为一个在红移 $z_{0}$ 处给定质量为 $M_{0}$ 的子体，在更高红移 $z_{1} \\ge z_{0}$ 处，实现以下物理量的计算：\n   - 在 $z_{1}$ 处，质量超过阈值 $M_{\\min}$ 的前身天体的质量分数，\n     $$F\\big(M_{\\min}\\big) = \\int_{S(M_{0})}^{S(M_{\\min})} f\\!\\left(S\\,\\big|\\,S(M_{0});\\,\\delta(z_{1})-\\delta(z_{0})\\right)\\,\\mathrm{d}S,$$\n     其中 $\\delta(z) = \\delta_{\\mathrm{sc}}/D(z)$，且 $D(z) = 1/(1+z)$，$ \\delta_{\\mathrm{sc}} = 1.686$。将 $F\\big(M_{\\min}\\big)$ 作为无量纲数报告。\n   - 质量超过 $M_{\\min}$ 的前身天体的期望数量，\n     $$N\\big(M_{\\min}\\big) = \\int_{M_{\\min}}^{M_{0}} \\frac{M_{0}}{M}\\, f\\!\\left(S(M)\\,\\big|\\,S(M_{0});\\,\\delta(z_{1})-\\delta(z_{0})\\right)\\, \\left|\\frac{\\mathrm{d}S}{\\mathrm{d}M}\\right|\\, \\mathrm{d}M,$$\n     作为无量纲数报告。\n   - 一个归一化检验，\n     $$E = \\left|\\int_{S(M_{0})}^{\\infty} f\\!\\left(S\\,\\big|\\,S(M_{0});\\,\\delta(z_{1})-\\delta(z_{0})\\right)\\,\\mathrm{d}S - 1\\right|,$$\n     作为无量纲数报告。对于正确的实现，此值在数值上必须接近于 $0$。\n   请根据首次穿越分布的极限情况，一致地处理 $z_{1} = z_{0}$ 的边界情况。\n4. 使用以下测试套件。在每种情况下，取 $M_{\\star} = 10^{12}\\,M_{\\odot}$，$n=-2$，$\\alpha = 1/3$，$\\delta_{\\mathrm{sc}} = 1.686$，以及 $D(z) = 1/(1+z)$：\n   - 情况 A (一般情况): $M_{0} = 10^{12}\\,M_{\\odot}$, $z_{0} = 0$, $z_{1} = 1$, $M_{\\min} = 10^{11}\\,M_{\\odot}$。\n   - 情况 B (边界情况): $M_{0} = 10^{12}\\,M_{\\odot}$, $z_{0} = 0$, $z_{1} = 0$, $M_{\\min} = 10^{11}\\,M_{\\odot}$。\n   - 情况 C (近阈值情况): $M_{0} = 8\\times 10^{11}\\,M_{\\odot}$, $z_{0} = 0$, $z_{1} = 0.5$, $M_{\\min} = 7\\times 10^{11}\\,M_{\\odot}$。\n   - 情况 D (高红移间隔): $M_{0} = 10^{13}\\,M_{\\odot}$, $z_{0} = 0$, $z_{1} = 3$, $M_{\\min} = 10^{12}\\,M_{\\odot}$。\n\n您的程序必须为每种情况计算三元组 $\\big[F(M_{\\min}), N(M_{\\min}), E\\big]$，结果为浮点数。您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果，顺序为\n$$[F_{A}, N_{A}, E_{A}, F_{B}, N_{B}, E_{B}, F_{C}, N_{C}, E_{C}, F_{D}, N_{D}, E_{D}],$$\n四舍五入到六位小数，输出中不含单位。",
            "solution": "该问题是有效的。这是一个来自理论宇宙学领域的、适定的、有科学依据的问题，具体涉及扩展的Press-Schechter形式主义和漂移集理论。所有必要的参数和定义都已提供，问题内部逻辑自洽。\n\n以下是一个完整的、有理据的解答。\n\n### 1. 条件首次穿越分布的推导\n\n问题要求推导马尔可夫随机游走的条件首次穿越分布，该模型用于描述平滑后的密度扰动 $\\delta(S)$。在此背景下，平滑场的方差 $S(R)$ 充当类时变量，而密度扰动 $\\delta$ 则是游走者的位置。如题所述，对于 sharp k 空间滤波器，游走 $\\delta(S)$ 是马尔可夫性的这一论断是成立的。\n\n我们考虑一个从特定状态 $(S_0, \\delta_0)$ 开始的随机游走。我们寻求该游走在“时间” $S_1  S_0$ 首次穿越一个更高的常数壁垒 $\\delta_1  \\delta_0$ 的概率密度函数 $f(S_1\\,|\\,S_0;\\, \\delta_1-\\delta_0)$。\n\n这是一个经典的首次穿越时间问题。我们可以通过平移原点来简化它。设游走的新坐标为：\n$$ S' = S - S_0 $$\n$$ \\delta' = \\delta - \\delta_0 $$\n在这个新坐标系中，游走从 $(S', \\delta') = (0, 0)$ 开始。需要穿越的壁垒高度为 $\\Delta\\delta = \\delta_1 - \\delta_0$。问题现在变为寻找一个从原点开始的游走穿越高度为 $\\Delta\\delta$ 的壁垒的首次穿越分布 $f(S'; \\Delta\\delta)$。\n\n对于标准的布朗运动（对应于高斯随机场），一个从 $(S', \\delta') = (0, 0)$ 开始的游走在时间 $S'$ 位于位置 $\\delta'$ 的概率由高斯分布给出：\n$$ P(\\delta', S') = \\frac{1}{\\sqrt{2\\pi S'}} \\exp\\left(-\\frac{\\delta'^2}{2S'}\\right) $$\n反射原理（或镜像法）被用来寻找首次穿越分布。对于任何在时间 $S'$ 到达位置 $\\delta'  \\Delta\\delta$ 的路径，存在两种可能性：它要么在某个 $S'_{cross}  S'$ 首次穿越了壁垒 $\\Delta\\delta$，要么没有。该原理指出，从原点开始、在时间 $S'$ 到达 $\\delta'  \\Delta\\delta$ 且已穿越壁垒的路径数量，等于从原点开始、在同一时间 $S'$ 到达位置 $2\\Delta\\delta - \\delta'$（$\\delta'$ 关于壁垒的镜像点）的路径数量。\n\n令 $\\mathcal{F}(S'; \\Delta\\delta) dS'$ 为在区间 $[S', S'+dS']$ 内首次穿越壁垒 $\\Delta\\delta$ 的概率。到时间 $S'$ 为止所有曾穿越过壁垒的轨迹的总通量，可以通过考虑所有最终停在壁垒上方的轨迹来得到。一个游走在时间 $\\le S'$ 首次穿越壁垒的概率，是在时间 $S'$ 时所有 $\\delta'  \\Delta\\delta$ 的游走的积分。首次穿越分布 $f(S'; \\Delta\\delta)$ 是已穿越壁垒的累积概率的时间导数。一个更直接的推导（Chandrasekhar, 1943）给出了从0开始穿越壁垒 $\\Delta\\delta$ 的游走的结果：\n$$ f(S'; \\Delta\\delta) = \\frac{\\Delta\\delta}{\\sqrt{2\\pi (S')^3}} \\exp\\left(-\\frac{(\\Delta\\delta)^2}{2S'}\\right) $$\n转换回我们的原始变量 $S_1 = S' + S_0$ 和 $\\Delta\\delta = \\delta_1 - \\delta_0$，我们得到条件首次穿越分布：\n$$ f(S_1\\,|\\,S_0;\\, \\delta_1-\\delta_0) = \\frac{\\delta_1-\\delta_0}{\\sqrt{2\\pi (S_1-S_0)^3}} \\exp\\left(-\\frac{(\\delta_1-\\delta_0)^2}{2(S_1-S_0)}\\right) $$\n此函数定义于 $S_1  S_0$ 且 $\\delta_1  \\delta_0$。\n\n**归一化检验：**\n我们必须验证穿越壁垒的总概率为 $1$。\n$$ \\int_{S_0}^{\\infty} f(S_1\\,|\\,S_0;\\, \\delta_1-\\delta_0) \\, \\mathrm{d}S_1 $$\n令 $x = S_1 - S_0$ 和 $\\Delta\\delta = \\delta_1 - \\delta_0$。积分为：\n$$ \\int_{0}^{\\infty} \\frac{\\Delta\\delta}{\\sqrt{2\\pi x^3}} \\exp\\left(-\\frac{(\\Delta\\delta)^2}{2x}\\right) \\, \\mathrm{d}x $$\n我们进行代换 $y = \\frac{(\\Delta\\delta)^2}{2x}$，这意味着 $x = \\frac{(\\Delta\\delta)^2}{2y}$ 且 $\\mathrm{d}x = -\\frac{(\\Delta\\delta)^2}{2y^2} \\mathrm{d}y$。积分限发生变化：当 $x \\to 0^+$ 时，$y \\to \\infty$；当 $x \\to \\infty$ 时，$y \\to 0$。\n$$ \\int_{\\infty}^{0} \\frac{\\Delta\\delta}{\\sqrt{2\\pi \\left(\\frac{(\\Delta\\delta)^2}{2y}\\right)^3}} e^{-y} \\left(-\\frac{(\\Delta\\delta)^2}{2y^2}\\right) \\mathrm{d}y = \\int_{0}^{\\infty} \\frac{\\Delta\\delta}{\\sqrt{2\\pi} \\frac{(\\Delta\\delta)^3}{(2y)^{3/2}}} e^{-y} \\frac{(\\Delta\\delta)^2}{2y^2} \\mathrm{d}y $$\n$$ = \\int_{0}^{\\infty} \\frac{1}{\\sqrt{2\\pi}} \\frac{2\\sqrt{2} y^{3/2}}{1} \\frac{1}{2y^2} e^{-y} \\mathrm{d}y = \\frac{1}{\\sqrt{\\pi}} \\int_{0}^{\\infty} y^{-1/2} e^{-y} \\mathrm{d}y $$\n这个积分可以被识别为 $\\frac{1}{\\sqrt{\\pi}}\\Gamma(1/2)$，其中 $\\Gamma(z)$ 是伽马函数。由于 $\\Gamma(1/2) = \\sqrt{\\pi}$，积分值为 $1$。该分布已正确归一化。\n\n### 2. 物理应用与特化\n\n我们将此形式体系应用于寻找暗物质晕的前身天体问题。\n在红移 $z_0$ 处识别出的质量为 $M_0$ 的晕，对应于一个密度轨迹 $\\delta(S)$ 在方差 $S_0 = S(M_0)$ 处首次穿越坍缩壁垒 $\\delta(z_0)$。这个晕在更早时间（更高红移 $z_1  z_0$）的前身天体是到 $z_1$ 时已经坍缩的更小质量的晕。这意味着它们对应的轨迹在某个方差 $S  S_0$ 处穿越了更高的壁垒 $\\delta(z_1)$。\n物理参数如下：\n-   方差-质量关系：$S(M) = (M/M_{\\star})^{-\\alpha}$，其中 $\\alpha = 1/3$ 且 $M_{\\star} = 10^{12}\\,M_{\\odot}$。\n-   与红移相关的坍缩壁垒：$\\delta(z) = \\delta_{\\mathrm{sc}}/D(z)$。对于 Einstein-de Sitter 宇宙，增长因子 $D(z) = 1/(1+z)$，因此壁垒变为 $\\delta(z) = \\delta_{\\mathrm{sc}}(1+z)$。\n-   壁垒高度差为 $\\Delta\\delta = \\delta(z_1) - \\delta(z_0) = \\delta_{\\mathrm{sc}}(1+z_1) - \\delta_{\\mathrm{sc}}(1+z_0) = \\delta_{\\mathrm{sc}}(z_1-z_0)$。\n\n### 3. 待实现的物理量\n\n我们需要实现三个物理量：\n\n**a) 质量分数 $F(M_{\\min})$：**\n这由首次穿越分布在相关方差范围内的积分给出。\n$$ F(M_{\\min}) = \\int_{S(M_{0})}^{S(M_{\\min})} f\\left(S\\,\\big|\\,S_0; \\Delta\\delta\\right)\\,\\mathrm{d}S $$\n其中 $S_0 = S(M_0)$。该积分有一个涉及互补误差函数 $\\mathrm{erfc}(x)$ 的解析解：\n$$ \\int_{S_0}^{S'} f\\left(S\\,\\big|\\,S_0; \\Delta\\delta\\right)\\,\\mathrm{d}S = \\mathrm{erfc}\\left(\\frac{\\Delta\\delta}{\\sqrt{2(S'-S_0)}}\\right) $$\n因此，$F(M_{\\min}) = \\mathrm{erfc}\\left(\\frac{\\Delta\\delta}{\\sqrt{2(S(M_{\\min})-S(M_0))}}\\right)$。这种形式在数值上是稳定且高效的。\n\n**b) 前身天体的期望数量 $N(M_{\\min})$：**\n$$ N(M_{\\min}) = \\int_{M_{\\min}}^{M_{0}} \\frac{M_{0}}{M}\\, f\\left(S(M)\\,\\big|\\,S_0; \\Delta\\delta\\right)\\, \\left|\\frac{\\mathrm{d}S}{\\mathrm{d}M}\\right|\\, \\mathrm{d}M $$\n对于数值实现，将积分变量从质量 $M$ 更改为方差 $S$ 更为方便。\n给定 $S(M) = (M/M_{\\star})^{-\\alpha}$，我们有 $M(S) = M_{\\star}S^{-1/\\alpha}$。\n导数为 $\\frac{\\mathrm{d}S}{\\mathrm{d}M} = -\\alpha \\frac{S}{M}$。其绝对值为 $|\\frac{\\mathrm{d}S}{\\mathrm{d}M}| = \\alpha \\frac{S}{M}$。\n代入此式并更换变量（$M$ 从 $M_{\\min}$ 到 $M_0$ 对应于 $S$ 从 $S_{\\min}=S(M_{\\min})$ 到 $S_0=S(M_0)$）：\n$$ N(M_{\\min}) = \\int_{S(M_0)}^{S(M_{\\min})} \\frac{M_0}{M(S)}\\, f(S|S_0; \\Delta\\delta)\\,\\mathrm{d}S = \\int_{S_0}^{S_{\\min}} \\frac{M_0}{M_{\\star}S^{-1/\\alpha}}\\, f(S|S_0; \\Delta\\delta)\\,\\mathrm{d}S $$\n关于 $S$ 的数值积分的被积函数是 $\\frac{M_0}{M_{\\star}}S^{1/\\alpha} f(S|S_0; \\Delta\\delta)$。\n\n**c) 归一化检验 $E$：**\n$$ E = \\left|\\int_{S_0}^{\\infty} f\\left(S\\,\\big|\\,S_0; \\Delta\\delta\\right)\\,\\mathrm{d}S - 1\\right| $$\n如推导所示，该积分的解析值应为 $1$。此检验用于验证积分程序的数值精度。\n\n**边界情况 $z_1 = z_0$：**\n如果 $z_1 = z_0$，则 $\\Delta\\delta = 0$。在此极限下，首次穿越分布变为一个狄拉克δ函数：$f(S|S_0; 0) = \\delta_D(S-S_0)$。\n从物理上讲，如果没有时间流逝，质量为 $M_0$ 的晕的唯一“前身天体”就是它本身。因此，前身天体集合只包含一个质量为 $M_0$ 的天体。\n- 对于 $M_{\\min}  M_0$，所有质量都在一个质量大于 $M_{\\min}$ 的前身天体中。因此，$F(M_{\\min}) = 1$。\n- 恰好有一个质量大于 $M_{\\min}$ 的前身天体，即晕本身。因此，$N(M_{\\min}) = 1$。\n- 归一化积分为 $\\int_{S_0}^{\\infty} \\delta_D(S-S_0)\\,\\mathrm{d}S = 1$，所以 $E = |1-1| = 0$。\n实现时将把这作为一种特殊情况处理。\n$F$ 的解析公式给出 $\\lim_{\\Delta \\delta \\to 0} \\mathrm{erfc}(\\frac{\\Delta\\delta}{\\sqrt{2(S_{\\min}-S_0)}}) = \\mathrm{erfc}(0) = 1$，这与物理上的推理一致。",
            "answer": "```python\nimport numpy as np\nfrom scipy.integrate import quad\nfrom scipy.special import erfc\n\ndef solve():\n    \"\"\"\n    Solves the extended Press-Schechter progenitor problem for the given test cases.\n    \"\"\"\n\n    # Global constants from the problem statement\n    M_STAR = 1.0e12  # solar masses\n    ALPHA = 1.0 / 3.0  # From n = -2\n    DELTA_SC = 1.686\n\n    def calculate_merger_tree_stats(m0, z0, z1, m_min):\n        \"\"\"\n        Calculates F, N, and E for a single test case.\n\n        Args:\n            m0 (float): Descendant mass at z0 in solar masses.\n            z0 (float): Descendant redshift.\n            z1 (float): Progenitor redshift.\n            m_min (float): Minimum progenitor mass threshold in solar masses.\n\n        Returns:\n            tuple: A triplet of floats (F, N, E).\n        \"\"\"\n        # Handle the boundary case where z1 = z0\n        if np.isclose(z1, z0):\n            # Physically, if no time has passed, the only progenitor is M0 itself.\n            # F(M_min) = 1 (all mass is in progenitors  M_min, i.e., in M0).\n            # N(M_min) = 1 (there is one progenitor, M0).\n            # E = 0 (normalization holds trivially).\n            return 1.0, 1.0, 0.0\n\n        # Calculate barrier height difference\n        # delta(z) = DELTA_SC / D(z) = DELTA_SC * (1 + z)\n        # d_delta = delta(z1) - delta(z0) = DELTA_SC * (z1 - z0)\n        d_delta = DELTA_SC * (z1 - z0)\n\n        # Calculate variances\n        # S(M) = (M / M_STAR)^(-ALPHA)\n        s0 = (m0 / M_STAR)**(-ALPHA)\n        s_min = (m_min / M_STAR)**(-ALPHA)\n        \n        # dS = S - s0 must be  0. Since m_min  m0, s_min  s0, this holds.\n        def first_crossing_dist(s, s_0, delta_delta):\n            \"\"\"Conditional first-crossing distribution f(S|S0).\"\"\"\n            ds = s - s_0\n            if ds = 0:\n                return 0.0\n            \n            # f(S|S0) = (d_delta / sqrt(2*pi*(S-S0)^3)) * exp(-(d_delta^2)/(2*(S-S0)))\n            factor1 = delta_delta / np.sqrt(2 * np.pi * ds**3)\n            exponent = - (delta_delta**2) / (2 * ds)\n            return factor1 * np.exp(exponent)\n\n        # 1. Calculate Mass Fraction F(M_min)\n        # F(M_min) = erfc(d_delta / sqrt(2 * (S_min - S0)))\n        arg_erfc = d_delta / np.sqrt(2 * (s_min - s0))\n        f_gt_mmin = erfc(arg_erfc)\n\n        # 2. Calculate Expected Number of Progenitors N(M_min)\n        # The integrand is (M0/M_STAR) * S^(1/ALPHA) * f(S|S0)\n        def integrand_n(s, s_0, delta_delta, m_0, m_star, alpha_inv):\n            return (m_0 / m_star) * (s**alpha_inv) * first_crossing_dist(s, s_0, delta_delta)\n        \n        n_gt_mmin, _ = quad(\n            integrand_n, \n            s0, \n            s_min, \n            args=(s0, d_delta, m0, M_STAR, 1/ALPHA)\n        )\n        \n        # 3. Calculate Normalization Check E\n        # E = |integral(f(S|S0) dS from S0 to inf) - 1|\n        norm_integral, _ = quad(\n            first_crossing_dist,\n            s0,\n            np.inf,\n            args=(s0, d_delta)\n        )\n        e_norm = np.abs(norm_integral - 1.0)\n        \n        return f_gt_mmin, n_gt_mmin, e_norm\n\n    test_cases = [\n        # Case A (general)\n        {'m0': 1.0e12, 'z0': 0.0, 'z1': 1.0, 'm_min': 1.0e11},\n        # Case B (boundary)\n        {'m0': 1.0e12, 'z0': 0.0, 'z1': 0.0, 'm_min': 1.0e11},\n        # Case C (near-threshold)\n        {'m0': 8.0e11, 'z0': 0.0, 'z1': 0.5, 'm_min': 7.0e11},\n        # Case D (high redshift gap)\n        {'m0': 1.0e13, 'z0': 0.0, 'z1': 3.0, 'm_min': 1.0e12},\n    ]\n\n    results = []\n    for case in test_cases:\n        f_val, n_val, e_val = calculate_merger_tree_stats(\n            case['m0'], case['z0'], case['z1'], case['m_min']\n        )\n        results.extend([f_val, n_val, e_val])\n\n    # Format output as specified: comma-separated list in brackets, rounded to 6 decimal places.\n    formatted_results = [f\"{val:.6f}\" for val in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\n```"
        },
        {
            "introduction": "标准的漂移集模型依赖于一个关键的简化假设：一个恒定的球状塌缩过密度阈值 $\\delta_c$。然而，真实的引力塌缩过程远比理想化的球状模型复杂，这导致了有效塌缩阈值在不同暗晕之间存在固有的随机性。这个高级练习将引导你探索如何将这种物理上的复杂性融入理论框架中，通过将塌缩阈值本身视为一个随机变量来扩展基础模型。你将通过对阈值分布进行边缘化积分，来评估这种“阈值散射”（barrier scatter）如何修正对晕丰度的预测，尤其是对稀有高质量暗晕数量的影响 。",
            "id": "3482249",
            "problem": "考虑用于暗物质晕形成的漂移集方法，其中对于选定的滤波函数，平滑线性密度对比 $\\delta_R$ 在平滑方差 $S(M)$ 中进行马尔可夫随机游走，而晕的形成与首次上跨一个塌缩阈值相关联。在恒定阈值理想化中，该阈值由球形塌缩的临界过密度 $\\delta_c$ 设定，由此产生的质量函数的高质量端渐近行为指数依赖于组合项 $\\nu \\equiv \\delta_c^2 / S(M)$。在现实中，晕与晕之间的变异性和非球形性在有效塌缩阈值中引入了随机性，这启发我们将阈值 $\\delta_c$ 视为从一个支撑集在 $\\delta_c  0$ 上的分布 $p(\\delta_c)$ 中抽取。\n\n您的任务是，从漂移集框架的第一性原理和恒定阈值的首次穿越统计出发，推导随机的 $\\delta_c$ 如何修正无条件质量函数的高$\\nu$渐近行为。具体来说，在固定的质量标度 $M$（即固定的 $S$）下，定义一个基准塌缩阈值 $\\bar{\\delta}_c$ 和相应的基准峰高 $\\nu \\equiv \\bar{\\delta}_c^2 / S(M)$。通过从概率分布 $p(\\delta_c)$ 中抽取 $\\delta_c$ 来引入阈值弥散，并确定在相同的 $S(M)$ 下，随机平均后的高$\\nu$尾部与基准恒定阈值结果之间的比率 $R(\\nu,\\sigma_B,p)$。请将此比率表示为一种可以通过对随机变量 $\\delta_c$ 进行边缘化来进行数值计算的形式。\n\n假设 $p(\\delta_c)$ 满足以下条件：\n- 截断高斯分布情况（在 $\\delta_c  0$ 上重归一化）：均值为 $\\bar{\\delta}_c$，标准差为 $\\sigma_B$，其概率密度为\n$$\np_{\\mathrm{G}}(\\delta_c \\mid \\bar{\\delta}_c,\\sigma_B) = \\frac{1}{\\sigma_B \\sqrt{2\\pi}\\,\\Phi\\!\\left(\\frac{\\bar{\\delta}_c}{\\sigma_B}\\right)} \\exp\\!\\left[-\\frac{(\\delta_c - \\bar{\\delta}_c)^2}{2\\sigma_B^2}\\right], \\quad \\delta_c  0,\n$$\n其中 $\\Phi(x) \\equiv \\frac{1}{2}\\left[1+\\mathrm{erf}\\!\\left(\\frac{x}{\\sqrt{2}}\\right)\\right]$ 是 $x$ 处的高斯累积分布函数。\n- 对数正态分布情况：选择参数使得均值为 $\\bar{\\delta}_c$，方差为 $\\sigma_B^2$。如果 $Y \\equiv \\ln \\delta_c$ 是一个均值为 $\\mu_L$、方差为 $\\sigma_L^2$ 的高斯变量，则通过以下方式强制 $\\mathbb{E}[\\delta_c] = \\bar{\\delta}_c$ 和 $\\mathrm{Var}(\\delta_c) = \\sigma_B^2$：\n$$\n\\sigma_L^2 = \\ln\\!\\left(1 + \\frac{\\sigma_B^2}{\\bar{\\delta}_c^2}\\right), \\quad \\mu_L = \\ln \\bar{\\delta}_c - \\frac{1}{2}\\sigma_L^2,\n$$\n以及\n$$\np_{\\mathrm{LN}}(\\delta_c \\mid \\bar{\\delta}_c,\\sigma_B) = \\frac{1}{\\delta_c \\sigma_L \\sqrt{2\\pi}} \\exp\\!\\left[-\\frac{\\left(\\ln \\delta_c - \\mu_L\\right)^2}{2\\sigma_L^2}\\right], \\quad \\delta_c  0.\n$$\n\n使用经典的球形塌缩基准值 $\\bar{\\delta}_c = 1.686$（无量纲）。在整个计算过程中使用无量纲量；不需要物理单位。您必须实现所需的关于 $\\delta_c$ 的边缘化积分的数值计算。\n\n测试套件：\n- 情况1：$\\nu = 4.0$，$\\sigma_B = 0.0$，分布 $p = p_{\\mathrm{G}}$（无弥散边界情况）。\n- 情况2：$\\nu = 9.0$，$\\sigma_B = 0.2$，分布 $p = p_{\\mathrm{G}}$（高$\\nu$值伴随轻微高斯弥散）。\n- 情况3：$\\nu = 16.0$，$\\sigma_B = 0.2$，分布 $p = p_{\\mathrm{G}}$（更高$\\nu$值的尾部）。\n- 情况4：$\\nu = 9.0$，$\\sigma_B = 0.2$，分布 $p = p_{\\mathrm{LN}}$（高$\\nu$值伴随轻微对数正态弥散）。\n- 情况5：$\\nu = 1.0$，$\\sigma_B = 0.5$，分布 $p = p_{\\mathrm{G}}$（较低$\\nu$值伴随较大弥散）。\n- 情况6：$\\nu = 25.0$，$\\sigma_B = 0.5$，分布 $p = p_{\\mathrm{G}}$（极端高$\\nu$值边缘情况）。\n\n您的程序应为每种情况计算 $R(\\nu,\\sigma_B,p)$，结果为浮点数。您的程序应生成单行输出，其中包含用方括号括起来的、以逗号分隔的结果列表（例如，$\\texttt{[result1,result2,result3]}$）。不应打印任何额外文本。如果 $\\sigma_B = 0.0$，则将分布视为在 $\\bar{\\delta}_c$ 处的狄拉克δ函数，并为该情况准确返回 $R = 1.0$。",
            "solution": "用户提供的问题陈述已经过仔细验证，被确定为具有科学依据、问题明确且客观。它提出了宇宙学中晕形成漂移集理论的一个标准但非平凡的扩展。所有必要的参数和分布都得到了精确定义，从而可以进行严格的推导和数值求解。\n\n该问题要求推导随机塌缩阈值下的无条件质量函数的高$\\nu$尾部与恒定基准阈值下的相应部分之间的比率 $R(\\nu, \\sigma_B, p)$。这将通过从第一性原理推导两种情景下的首次穿越分布，然后计算它们的比率来完成。\n\n让我们从漂移集形式主义的基础元素开始：首次穿越分布。在此框架中，平滑线性密度对比 $\\delta_R$ 作为平滑方差 $S(M)$ 的函数进行马尔可夫随机游走，其中 $M$ 是质量标度。质量为 $M$ 的晕与在方差标度 $S(M)$ 处首次穿越塌缩阈值 $\\delta_c$ 的随机游走相关联。\n\n对于恒定的阈值 $\\delta_c$，在方差 $S$ 处首次穿越的概率密度函数，记为 $f(S; \\delta_c)$，是一个在 $\\delta_c$ 处有吸收边界的扩散问题的解。其著名结果是：\n$$\nf(S; \\delta_c) = \\frac{\\delta_c}{\\sqrt{2\\pi S^3}} \\exp\\left(-\\frac{\\delta_c^2}{2S}\\right)\n$$\n无条件晕质量函数的高质量（因此是高$\\nu$）尾部与此首次穿越分布 $f(S)$ 直接成正比。其他因素，如平均物质密度和 $S-M$ 关系的雅可比行列式，在基准模型和随机模型中是共同的，在计算比率时将被抵消。\n\n基准模型采用恒定的塌缩阈值 $\\bar{\\delta}_c = 1.686$。在固定的质量标度 $M$（对应于方差 $S(M)$）下，首次穿越分布为：\n$$\nf_{\\text{base}}(S) = f(S; \\bar{\\delta}_c) = \\frac{\\bar{\\delta}_c}{\\sqrt{2\\pi S^3}} \\exp\\left(-\\frac{\\bar{\\delta}_c^2}{2S}\\right)\n$$\n问题将峰高参数定义为 $\\nu \\equiv \\bar{\\delta}_c^2 / S(M)$。使用此定义，指数项变为 $\\exp(-\\nu/2)$。用 $\\nu$ 表示的基准首次穿越分布为：\n$$\nf_{\\text{base}}(S) = \\frac{\\bar{\\delta}_c}{\\sqrt{2\\pi (\\bar{\\delta}_c^2/\\nu)^3}} \\exp\\left(-\\frac{\\nu}{2}\\right)\n$$\n\n接下来，我们考虑塌缩阈值不是恒定值，而是从一个支撑集在 $\\delta_c  0$ 上的概率分布 $p(\\delta_c)$ 中抽取的随机变量的情况。对于从该分布中抽取的任何特定值 $\\delta_c$，首次穿越分布仍然是 $f(S; \\delta_c)$。为了找到随机平均的首次穿越分布 $\\langle f(S) \\rangle$，我们必须对所有可能的 $\\delta_c$ 值进行边缘化，并以其概率密度 $p(\\delta_c)$ 进行加权：\n$$\n\\langle f(S) \\rangle = \\int_0^\\infty f(S; \\delta_c) \\, p(\\delta_c) \\, d\\delta_c\n$$\n代入 $f(S; \\delta_c)$ 的表达式：\n$$\n\\langle f(S) \\rangle = \\int_0^\\infty \\frac{\\delta_c}{\\sqrt{2\\pi S^3}} \\exp\\left(-\\frac{\\delta_c^2}{2S}\\right) p(\\delta_c) \\, d\\delta_c\n$$\n问题要求的是在相同质量标度（即相同的 $S$ 和相同的 $\\nu$）下，随机平均结果与基准结果的比率 $R$。\n$$\nR(\\nu, \\sigma_B, p) = \\frac{\\langle f(S) \\rangle}{f_{\\text{base}}(S)} = \\frac{\\int_0^\\infty \\frac{\\delta_c}{\\sqrt{2\\pi S^3}} \\exp\\left(-\\frac{\\delta_c^2}{2S}\\right) p(\\delta_c) \\, d\\delta_c}{\\frac{\\bar{\\delta}_c}{\\sqrt{2\\pi S^3}} \\exp\\left(-\\frac{\\bar{\\delta}_c^2}{2S}\\right)}\n$$\n项 $1/\\sqrt{2\\pi S^3}$ 被抵消，表达式简化为：\n$$\nR = \\frac{\\int_0^\\infty \\delta_c \\exp\\left(-\\frac{\\delta_c^2}{2S}\\right) p(\\delta_c) \\, d\\delta_c}{\\bar{\\delta}_c \\exp\\left(-\\frac{\\bar{\\delta}_c^2}{2S}\\right)}\n$$\n为了明确对 $\\nu$ 的依赖关系，我们代入 $S = \\bar{\\delta}_c^2 / \\nu$。被积函数中的指数变为 $-\\frac{\\delta_c^2}{2(\\bar{\\delta}_c^2/\\nu)} = -\\frac{\\nu}{2} \\left(\\frac{\\delta_c}{\\bar{\\delta}_c}\\right)^2$，分母中的指数变为 $-\\frac{\\nu}{2}$。这得出了待求比率的最终表达式：\n$$\nR(\\nu, \\sigma_B, p) = \\frac{\\int_0^\\infty \\delta_c \\exp\\left[-\\frac{\\nu}{2} \\left(\\frac{\\delta_c}{\\bar{\\delta}_c}\\right)^2\\right] p(\\delta_c \\mid \\bar{\\delta}_c, \\sigma_B) \\, d\\delta_c}{\\bar{\\delta}_c \\exp\\left[-\\frac{\\nu}{2}\\right]}\n$$\n这个边缘化积分通常没有闭合形式的解，必须进行数值计算。为了计算稳定性，特别是在大 $\\nu$ 值下 $\\exp(-\\nu/2)$ 可能发生下溢的情况下，将表达式重排为如下形式是有利的：\n$$\nR(\\nu, \\sigma_B, p) = \\frac{e^{\\nu/2}}{\\bar{\\delta}_c} \\int_0^\\infty \\delta_c \\exp\\left[-\\frac{\\nu}{2} \\left(\\frac{\\delta_c}{\\bar{\\delta}_c}\\right)^2\\right] p(\\delta_c \\mid \\bar{\\delta}_c, \\sigma_B) \\, d\\delta_c\n$$\n积分在 $\\delta_c$ 上从 $0$ 到 $\\infty$ 进行。概率密度 $p(\\delta_c \\mid \\bar{\\delta}_c, \\sigma_B)$ 针对两种情况给出：截断高斯分布（$p_{\\mathrm{G}}$）和对数正态分布（$p_{\\mathrm{LN}}$），两者均在问题陈述中定义。数值实现将涉及定义这些概率密度函数，并使用数值积分程序（如 `scipy.integrate.quad`）来计算该定积分。\n\n对于弥散 $\\sigma_B = 0$ 的特殊情况，概率分布 $p(\\delta_c)$ 变为狄拉克δ函数，$p(\\delta_c) = \\delta_D(\\delta_c - \\bar{\\delta}_c)$。利用δ函数的筛选性质计算积分，分子变为 $\\bar{\\delta}_c \\exp\\left[-\\frac{\\nu}{2} \\left(\\frac{\\bar{\\delta}_c}{\\bar{\\delta}_c}\\right)^2\\right] = \\bar{\\delta}_c \\exp(-\\nu/2)$。与分母（与分子相同）的比率恰好为 $R=1$，这符合预期，因为这种情况恢复了基准模型。",
            "answer": "```python\nimport numpy as np\nfrom scipy.integrate import quad\nfrom scipy.special import erf\n\ndef solve():\n    \"\"\"\n    Solves the problem of calculating the ratio of stochastically averaged\n    halo mass function tail to the baseline constant-barrier result.\n    \"\"\"\n\n    # Baseline spherical collapse threshold as a global constant\n    D_C_BAR = 1.686\n\n    def phi_cdf(x):\n        \"\"\"\n        Computes the standard Gaussian cumulative distribution function Phi(x).\n        Phi(x) = 1/2 * [1 + erf(x / sqrt(2))].\n        \"\"\"\n        return 0.5 * (1.0 + erf(x / np.sqrt(2.0)))\n\n    def p_gaussian(delta_c, d_c_bar, sigma_B):\n        \"\"\"\n        Probability density function for the Truncated Gaussian case,\n        renormalized on delta_c  0.\n        \"\"\"\n        # The distribution has support for delta_c  0.\n        if delta_c = 0:\n            return 0.0\n        \n        # Denominator of the PDF, which is the normalization constant.\n        norm_factor = sigma_B * np.sqrt(2.0 * np.pi) * phi_cdf(d_c_bar / sigma_B)\n        \n        if norm_factor == 0.0:\n            return np.inf if delta_c == d_c_bar else 0.0\n        \n        exponent = -((delta_c - d_c_bar)**2) / (2.0 * sigma_B**2)\n        return (1.0 / norm_factor) * np.exp(exponent)\n\n    def p_lognormal(delta_c, d_c_bar, sigma_B):\n        \"\"\"\n        Probability density function for the Lognormal case, with parameters\n        chosen to match mean = d_c_bar and variance = sigma_B^2.\n        \"\"\"\n        # The distribution has support for delta_c  0.\n        if delta_c = 0:\n            return 0.0\n\n        variance_ratio = (sigma_B / d_c_bar)**2\n        sigma_L_sq = np.log(1.0 + variance_ratio)\n        sigma_L = np.sqrt(sigma_L_sq)\n        \n        mu_L = np.log(d_c_bar) - 0.5 * sigma_L_sq\n        \n        if sigma_L == 0.0:\n            return np.inf if np.log(delta_c) == mu_L else 0.0\n        if delta_c == 0.0:\n            return 0.0\n\n        norm_factor = delta_c * sigma_L * np.sqrt(2.0 * np.pi)\n        exponent = -((np.log(delta_c) - mu_L)**2) / (2.0 * sigma_L_sq)\n        return (1.0 / norm_factor) * np.exp(exponent)\n\n    def calculate_ratio(nu, sigma_B, dist_type):\n        \"\"\"\n        Calculates the ratio R(nu, sigma_B, p) by numerical integration.\n        \"\"\"\n        if sigma_B == 0.0:\n            return 1.0\n\n        if dist_type == 'gaussian':\n            pdf_func = lambda dc: p_gaussian(dc, D_C_BAR, sigma_B)\n        elif dist_type == 'lognormal':\n            pdf_func = lambda dc: p_lognormal(dc, D_C_BAR, sigma_B)\n        else:\n            raise ValueError(f\"Unknown distribution type: {dist_type}\")\n\n        def integrand(delta_c):\n            term1 = delta_c\n            term2 = np.exp(-0.5 * nu * (delta_c / D_C_BAR)**2)\n            term3 = pdf_func(delta_c)\n            return term1 * term2 * term3\n\n        integral_val, _ = quad(integrand, 0, np.inf)\n\n        stable_ratio = (1.0 / D_C_BAR) * np.exp(0.5 * nu) * integral_val\n        \n        return stable_ratio\n\n    test_cases = [\n        (4.0, 0.0, 'p_G'),      # Case 1\n        (9.0, 0.2, 'p_G'),      # Case 2\n        (16.0, 0.2, 'p_G'),     # Case 3\n        (9.0, 0.2, 'p_LN'),     # Case 4\n        (1.0, 0.5, 'p_G'),      # Case 5\n        (25.0, 0.5, 'p_G'),     # Case 6\n    ]\n\n    results = []\n    dist_map = {'p_G': 'gaussian', 'p_LN': 'lognormal'}\n\n    for nu_val, sigma_B_val, p_type in test_cases:\n        dist_name = dist_map[p_type]\n        result = calculate_ratio(nu_val, sigma_B_val, dist_name)\n        results.append(result)\n\n    print(f\"[{','.join(f'{r:.8f}' for r in results)}]\")\n\n```"
        }
    ]
}