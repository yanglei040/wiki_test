{
    "hands_on_practices": [
        {
            "introduction": "The power of excursion-set theory lies not just in predicting halo abundances, but in describing their full assembly histories. This exercise leverages the analogy between the growth of density fluctuations and a random walk to derive the conditional mass function, which specifies the distribution of progenitor halos at an early time that merge to form a larger descendant halo later. By implementing this framework from first principles, you will gain a practical understanding of how merger trees, the backbones of semi-analytic models of galaxy formation, are constructed .",
            "id": "3482200",
            "problem": "You are tasked with deriving, implementing, and validating the conditional mass function underlying merger-tree construction in the extended Press-Schechter framework of excursion-set theory, under a scientifically controlled and numerically self-contained setup. All physical and mathematical quantities must be treated as dimensionless unless a unit is explicitly specified. When a unit is specified, express the corresponding reported quantity in that unit as instructed.\n\nStarting point (foundational base only):\n\n- The initial density contrast is a statistically homogeneous, isotropic Gaussian random field with linear power spectrum $P(k)$.\n- The smoothed density contrast $\\delta(R)$ is obtained by convolving with a spherically symmetric window $W(kR)$ in Fourier space. The variance of the smoothed field is $S(R) \\equiv \\sigma^{2}(R) = \\int_{0}^{\\infty} \\mathrm{d}\\ln k\\, \\Delta^{2}(k)\\, |W(kR)|^{2}$, with $\\Delta^{2}(k) \\equiv k^{3} P(k)/(2\\pi^{2})$.\n- For a scale-free power spectrum $P(k) = A k^{n}$ with $n \\in (-3,1)$ and the sharp-$k$ filter $W(kR) = \\Theta(1 - kR)$, one has $S(R) \\propto R^{-(n+3)}$ and, using $M \\propto R^{3}$, $S(M) \\propto M^{-(n+3)/3}$.\n- In an Einstein–de Sitter background, the linear growth factor is $D(z) = 1/(1+z)$, and the spherical-collapse threshold is $\\delta_{\\mathrm{sc}} \\approx 1.686$, so the linear barrier as a function of redshift is $\\delta(z) = \\delta_{\\mathrm{sc}}/D(z)$.\n\nProblem requirements:\n\n1. Starting from the Markovian nature of sharp-$k$ filtered random walks $\\delta(S)$ for Gaussian initial conditions and the reflection principle for first-passage of Brownian motion to a constant barrier, derive the conditional first-crossing distribution for a walk that starts at $(S_{0}, \\delta_{0})$ and first crosses a constant barrier $\\delta_{1}  \\delta_{0}$ at $S_{1}  S_{0}$. Your derivation must express the result as a function $f(S_{1}\\,|\\,S_{0};\\,\\delta_{1}-\\delta_{0})$ and show that the integral over $S_{1}$ from $S_{0}$ to $\\infty$ is $1$.\n2. Specialize to the case $n = -2$ and define $S(M)$ by the normalization\n   $$S(M) = \\left(\\frac{M}{M_{\\star}}\\right)^{-\\alpha}, \\quad \\alpha \\equiv \\frac{n+3}{3} = \\frac{1}{3}, \\quad M_{\\star} = 10^{12}\\, M_{\\odot},$$\n   where $M_{\\odot}$ denotes the solar mass. All masses in this problem must be expressed in units of $M_{\\odot}$.\n3. Using your $f(S_{1}\\,|\\,S_{0})$, implement the following quantities for a given descendant mass $M_{0}$ at redshift $z_{0}$ and a higher redshift $z_{1} \\ge z_{0}$:\n   - The mass fraction in progenitors above a threshold $M_{\\min}$ at $z_{1}$,\n     $$F\\big(M_{\\min}\\big) = \\int_{S(M_{0})}^{S(M_{\\min})} f\\!\\left(S\\,\\big|\\,S(M_{0});\\,\\delta(z_{1})-\\delta(z_{0})\\right)\\,\\mathrm{d}S,$$\n     where $\\delta(z) = \\delta_{\\mathrm{sc}}/D(z)$ with $D(z) = 1/(1+z)$ and $\\delta_{\\mathrm{sc}} = 1.686$. Report $F\\big(M_{\\min}\\big)$ as a dimensionless number.\n   - The expected number of progenitors above $M_{\\min}$,\n     $$N\\big(M_{\\min}\\big) = \\int_{M_{\\min}}^{M_{0}} \\frac{M_{0}}{M}\\, f\\!\\left(S(M)\\,\\big|\\,S(M_{0});\\,\\delta(z_{1})-\\delta(z_{0})\\right)\\, \\left|\\frac{\\mathrm{d}S}{\\mathrm{d}M}\\right|\\, \\mathrm{d}M,$$\n     reported as a dimensionless number.\n   - A normalization check,\n     $$E = \\left|\\int_{S(M_{0})}^{\\infty} f\\!\\left(S\\,\\big|\\,S(M_{0});\\,\\delta(z_{1})-\\delta(z_{0})\\right)\\,\\mathrm{d}S - 1\\right|,$$\n     reported as a dimensionless number. This must be numerically close to $0$ for a correct implementation.\n   Handle the boundary case $z_{1} = z_{0}$ consistently with the limit of the first-crossing distribution.\n4. Use the following test suite. In each case, take $M_{\\star} = 10^{12}\\,M_{\\odot}$, $n=-2$, $\\alpha = 1/3$, $\\delta_{\\mathrm{sc}} = 1.686$, and $D(z) = 1/(1+z)$:\n   - Case A (general): $M_{0} = 10^{12}\\,M_{\\odot}$, $z_{0} = 0$, $z_{1} = 1$, $M_{\\min} = 10^{11}\\,M_{\\odot}$.\n   - Case B (boundary): $M_{0} = 10^{12}\\,M_{\\odot}$, $z_{0} = 0$, $z_{1} = 0$, $M_{\\min} = 10^{11}\\,M_{\\odot}$.\n   - Case C (near-threshold): $M_{0} = 8\\times 10^{11}\\,M_{\\odot}$, $z_{0} = 0$, $z_{1} = 0.5$, $M_{\\min} = 7\\times 10^{11}\\,M_{\\odot}$.\n   - Case D (high redshift gap): $M_{0} = 10^{13}\\,M_{\\odot}$, $z_{0} = 0$, $z_{1} = 3$, $M_{\\min} = 10^{12}\\,M_{\\odot}$.\n\nYour program must compute, for each case, the triplet $\\big[F(M_{\\min}), N(M_{\\min}), E\\big]$ as floating-point numbers. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order\n$$[F_{A}, N_{A}, E_{A}, F_{B}, N_{B}, E_{B}, F_{C}, N_{C}, E_{C}, F_{D}, N_{D}, E_{D}],$$\nrounded to six decimal places, with no units in the output.",
            "solution": "### 1. Derivation of the Conditional First-Crossing Distribution\n\nThe problem requires the derivation of the conditional first-crossing distribution for a Markovian random walk, which is a model for the smoothed density contrast $\\delta(S)$. In this context, the variance of the smoothed field, $S(R)$, acts as the time-like variable, and the density contrast, $\\delta$, is the position of the walker. The assertion that the walk $\\delta(S)$ is Markovian is valid for a sharp $k$-space filter, as given.\n\nWe consider a random walk that starts at a specified state $(S_0, \\delta_0)$. We seek the probability distribution function $f(S_1\\,|\\,S_0;\\, \\delta_1-\\delta_0)$ for the walk to first cross a higher, constant barrier $\\delta_1  \\delta_0$ at the \"time\" $S_1  S_0$.\n\nThis is a classic first-passage time problem. We can simplify it by shifting the origin. Let the new coordinates for the walk be:\n$$ S' = S - S_0 $$\n$$ \\delta' = \\delta - \\delta_0 $$\nIn this new frame, the walk starts at $(S', \\delta') = (0, 0)$. The barrier to be crossed is at a height $\\Delta\\delta = \\delta_1 - \\delta_0$. The problem is now to find the first-crossing distribution $f(S'; \\Delta\\delta)$ for a walk starting at the origin to cross a barrier at $\\Delta\\delta$.\n\nFor a standard Brownian motion (which corresponds to a Gaussian random field), the probability for a walk starting at $(S', \\delta') = (0, 0)$ to be at a position $\\delta'$ at time $S'$ is given by the Gaussian distribution:\n$$ P(\\delta', S') = \\frac{1}{\\sqrt{2\\pi S'}} \\exp\\left(-\\frac{\\delta'^2}{2S'}\\right) $$\nThe reflection principle (or method of images) is used to find the first-crossing distribution. For any path that reaches a position $\\delta'  \\Delta\\delta$ at time $S'$, there are two possibilities: either it has crossed the barrier $\\Delta\\delta$ for the first time at some $S'_{cross}  S'$, or it has not. The principle states that the number of paths starting at the origin that reach $\\delta'  \\Delta\\delta$ at time $S'$ having crossed the barrier is equal to the number of paths starting at the origin that reach the position $2\\Delta\\delta - \\delta'$ (the reflection of $\\delta'$ about the barrier) at the same time $S'$.\n\nLet $\\mathcal{F}(S'; \\Delta\\delta) dS'$ be the probability of first crossing the barrier $\\Delta\\delta$ in the interval $[S', S'+dS']$. The total probability of being at any position $\\delta'  \\Delta\\delta$ at time $S'$ is the sum of probabilities of paths that arrived there without ever dropping below $\\Delta\\delta$ and paths that crossed back and forth. By the reflection principle, the total flux of trajectories that have ever crossed the barrier up to time $S'$ is given by considering all trajectories ending up above the barrier. The probability of a walk first crossing the barrier at a time $\\le S'$ is the integral of all walks having $\\delta'  \\Delta\\delta$ at time $S'$.\nThe distribution of first-crossings, $f(S'; \\Delta\\delta)$, is the time derivative of the cumulative probability of having crossed the barrier. A more direct derivation (Chandrasekhar, 1943) yields the result for a walk starting at $0$ crossing a barrier $\\Delta\\delta$:\n$$ f(S'; \\Delta\\delta) = \\frac{\\Delta\\delta}{\\sqrt{2\\pi (S')^3}} \\exp\\left(-\\frac{(\\Delta\\delta)^2}{2S'}\\right) $$\nTranslating back to our original variables $S_1 = S' + S_0$ and $\\Delta\\delta = \\delta_1 - \\delta_0$, we get the conditional first-crossing distribution:\n$$ f(S_1\\,|\\,S_0;\\, \\delta_1-\\delta_0) = \\frac{\\delta_1-\\delta_0}{\\sqrt{2\\pi (S_1-S_0)^3}} \\exp\\left(-\\frac{(\\delta_1-\\delta_0)^2}{2(S_1-S_0)}\\right) $$\nThis function is defined for $S_1  S_0$ and $\\delta_1  \\delta_0$.\n\n**Normalization Check:**\nWe must verify that the total probability of crossing the barrier is $1$.\n$$ \\int_{S_0}^{\\infty} f(S_1\\,|\\,S_0;\\, \\delta_1-\\delta_0) \\, \\mathrm{d}S_1 $$\nLet $x = S_1 - S_0$ and $\\Delta\\delta = \\delta_1 - \\delta_0$. The integral becomes:\n$$ \\int_{0}^{\\infty} \\frac{\\Delta\\delta}{\\sqrt{2\\pi x^3}} \\exp\\left(-\\frac{(\\Delta\\delta)^2}{2x}\\right) \\, \\mathrm{d}x $$\nLet's substitute $y = \\frac{(\\Delta\\delta)^2}{2x}$, which implies $x = \\frac{(\\Delta\\delta)^2}{2y}$ and $\\mathrm{d}x = -\\frac{(\\Delta\\delta)^2}{2y^2} \\mathrm{d}y$. The integration limits change: as $x \\to 0^+$, $y \\to \\infty$; as $x \\to \\infty$, $y \\to 0$.\n$$ \\int_{\\infty}^{0} \\frac{\\Delta\\delta}{\\sqrt{2\\pi \\left(\\frac{(\\Delta\\delta)^2}{2y}\\right)^3}} e^{-y} \\left(-\\frac{(\\Delta\\delta)^2}{2y^2}\\right) \\mathrm{d}y = \\int_{0}^{\\infty} \\frac{\\Delta\\delta}{\\sqrt{2\\pi} \\frac{(\\Delta\\delta)^3}{(2y)^{3/2}}} e^{-y} \\frac{(\\Delta\\delta)^2}{2y^2} \\mathrm{d}y $$\n$$ = \\int_{0}^{\\infty} \\frac{1}{\\sqrt{2\\pi}} \\frac{2\\sqrt{2} y^{3/2}}{1} \\frac{1}{2y^2} e^{-y} \\mathrm{d}y = \\frac{1}{\\sqrt{\\pi}} \\int_{0}^{\\infty} y^{-1/2} e^{-y} \\mathrm{d}y $$\nThis integral is recognized as $\\frac{1}{\\sqrt{\\pi}}\\Gamma(1/2)$, where $\\Gamma(z)$ is the Gamma function. Since $\\Gamma(1/2) = \\sqrt{\\pi}$, the integral evaluates to $1$. The distribution is correctly normalized.\n\n### 2. Physical Application and Specialization\n\nWe apply this formalism to the problem of finding progenitors of a dark matter halo.\nA halo of mass $M_0$ identified at redshift $z_0$ corresponds to a density trajectory $\\delta(S)$ that first crosses the collapse barrier $\\delta(z_0)$ at variance $S_0 = S(M_0)$. The progenitors of this halo at an earlier time (higher redshift $z_1  z_0$) are smaller halos that have already collapsed by $z_1$. This means their corresponding trajectories have crossed the higher barrier $\\delta(z_1)$ at some variance $S  S_0$.\nThe physical parameters are:\n-   Variance-mass relation: $S(M) = (M/M_{\\star})^{-\\alpha}$ with $\\alpha = 1/3$ and $M_{\\star} = 10^{12}\\,M_{\\odot}$.\n-   Redshift-dependent collapse barrier: $\\delta(z) = \\delta_{\\mathrm{sc}}/D(z)$. With the growth factor $D(z) = 1/(1+z)$ for an Einstein-de Sitter universe, this becomes $\\delta(z) = \\delta_{\\mathrm{sc}}(1+z)$.\n-   The barrier height difference is $\\Delta\\delta = \\delta(z_1) - \\delta(z_0) = \\delta_{\\mathrm{sc}}(1+z_1) - \\delta_{\\mathrm{sc}}(1+z_0) = \\delta_{\\mathrm{sc}}(z_1-z_0)$.\n\n### 3. Quantities for Implementation\n\nWe need to implement three quantities:\n\n**a) Mass Fraction $F(M_{\\min})$:**\nThis is given by the integral of the first-crossing distribution over the relevant range of variances.\n$$ F(M_{\\min}) = \\int_{S(M_{0})}^{S(M_{\\min})} f\\left(S\\,\\big|\\,S_0; \\Delta\\delta\\right)\\,\\mathrm{d}S $$\nwhere $S_0 = S(M_0)$. This integral has an analytical solution involving the complementary error function, $\\mathrm{erfc}(x)$:\n$$ \\int_{S_0}^{S'} f\\left(S\\,\\big|\\,S_0; \\Delta\\delta\\right)\\,\\mathrm{d}S = \\mathrm{erfc}\\left(\\frac{\\Delta\\delta}{\\sqrt{2(S'-S_0)}}\\right) $$\nThus, $F(M_{\\min}) = \\mathrm{erfc}\\left(\\frac{\\Delta\\delta}{\\sqrt{2(S(M_{\\min})-S(M_0))}}\\right)$. This form is numerically stable and efficient.\n\n**b) Expected Number of Progenitors $N(M_{\\min})$:**\n$$ N(M_{\\min}) = \\int_{M_{\\min}}^{M_{0}} \\frac{M_{0}}{M}\\, f\\left(S(M)\\,\\big|\\,S_0; \\Delta\\delta\\right)\\, \\left|\\frac{\\mathrm{d}S}{\\mathrm{d}M}\\right|\\, \\mathrm{d}M $$\nFor numerical implementation, it is more convenient to change the integration variable from mass $M$ to variance $S$.\nGiven $S(M) = (M/M_{\\star})^{-\\alpha}$, we have $M(S) = M_{\\star}S^{-1/\\alpha}$.\nThe derivative is $\\frac{\\mathrm{d}S}{\\mathrm{d}M} = -\\alpha \\frac{S}{M}$. Its absolute value is $|\\frac{\\mathrm{d}S}{\\mathrm{d}M}| = \\alpha \\frac{S}{M}$.\nSubstituting this and changing variables ($M$ from $M_{\\min}$ to $M_0$ corresponds to $S$ from $S_{\\min}=S(M_{\\min})$ to $S_0=S(M_0)$):\n$$ N(M_{\\min}) = \\int_{S(M_0)}^{S(M_{\\min})} \\frac{M_0}{M(S)}\\, f(S|S_0; \\Delta\\delta)\\,\\mathrm{d}S = \\int_{S_0}^{S_{\\min}} \\frac{M_0}{M_{\\star}S^{-1/\\alpha}}\\, f(S|S_0; \\Delta\\delta)\\,\\mathrm{d}S $$\nThe integrand for the numerical integration over $S$ is $\\frac{M_0}{M_{\\star}}S^{1/\\alpha} f(S|S_0; \\Delta\\delta)$.\n\n**c) Normalization Check $E$:**\n$$ E = \\left|\\int_{S_0}^{\\infty} f\\left(S\\,\\big|\\,S_0; \\Delta\\delta\\right)\\,\\mathrm{d}S - 1\\right| $$\nAs shown in the derivation, the integral should analytically be $1$. This check serves to verify the numerical accuracy of the integration routine.\n\n**Boundary Case $z_1 = z_0$:**\nIf $z_1 = z_0$, then $\\Delta\\delta = 0$. In this limit, the first-crossing distribution becomes a Dirac delta function: $f(S|S_0; 0) = \\delta_D(S-S_0)$.\nPhysically, if no time has passed, the only \"progenitor\" of a halo of mass $M_0$ is the halo itself. Therefore, the set of progenitors consists of a single object of mass $M_0$.\n-   For $M_{\\min}  M_0$, all the mass is in a progenitor with mass greater than $M_{\\min}$. Thus, $F(M_{\\min}) = 1$.\n-   There is exactly one progenitor with mass greater than $M_{\\min}$, which is the halo itself. Thus, $N(M_{\\min}) = 1$.\n-   The normalization integral is $\\int_{S_0}^{\\infty} \\delta_D(S-S_0)\\,\\mathrm{d}S = 1$, so $E = |1-1| = 0$.\nThe implementation will handle this as a special case.\nThe analytical formula for $F$ gives $\\lim_{\\Delta \\delta \\to 0} \\mathrm{erfc}(\\frac{\\Delta\\delta}{\\sqrt{2(S_{\\min}-S_0)}}) = \\mathrm{erfc}(0) = 1$, consistent with this physical reasoning.",
            "answer": "```python\nimport numpy as np\nfrom scipy.integrate import quad\nfrom scipy.special import erfc\n\ndef solve():\n    \"\"\"\n    Solves the extended Press-Schechter progenitor problem for the given test cases.\n    \"\"\"\n\n    # Global constants from the problem statement\n    M_STAR = 1.0e12  # solar masses\n    ALPHA = 1.0 / 3.0  # From n = -2\n    DELTA_SC = 1.686\n\n    def calculate_merger_tree_stats(m0, z0, z1, m_min):\n        \"\"\"\n        Calculates F, N, and E for a single test case.\n\n        Args:\n            m0 (float): Descendant mass at z0 in solar masses.\n            z0 (float): Descendant redshift.\n            z1 (float): Progenitor redshift.\n            m_min (float): Minimum progenitor mass threshold in solar masses.\n\n        Returns:\n            tuple: A triplet of floats (F, N, E).\n        \"\"\"\n        # Handle the boundary case where z1 = z0\n        if np.isclose(z1, z0):\n            # Physically, if no time has passed, the only progenitor is M0 itself.\n            # F(M_min) = 1 (all mass is in progenitors  M_min, i.e., in M0).\n            # N(M_min) = 1 (there is one progenitor, M0).\n            # E = 0 (normalization holds trivially).\n            return 1.0, 1.0, 0.0\n\n        # Calculate barrier height difference\n        # delta(z) = DELTA_SC / D(z) = DELTA_SC * (1 + z)\n        # d_delta = delta(z1) - delta(z0) = DELTA_SC * (z1 - z0)\n        d_delta = DELTA_SC * (z1 - z0)\n\n        # Calculate variances\n        # S(M) = (M / M_STAR)^(-ALPHA)\n        s0 = (m0 / M_STAR)**(-ALPHA)\n        s_min = (m_min / M_STAR)**(-ALPHA)\n        \n        # dS = S - s0 must be  0. Since m_min  m0, s_min  s0, this holds.\n        # The argument to the exponential can be large and negative, leading to underflow.\n        # The (dS)**(-1.5) term can lead to overflow if dS is small.\n        # numpy and scipy handle these cases gracefully.\n        def first_crossing_dist(s, s_0, delta_delta):\n            \"\"\"Conditional first-crossing distribution f(S|S0).\"\"\"\n            ds = s - s_0\n            if ds = 0:\n                return 0.0\n            \n            # This is the formula from the derivation\n            # f(S|S0) = (d_delta / sqrt(2*pi*(S-S0)^3)) * exp(-(d_delta^2)/(2*(S-S0)))\n            factor1 = delta_delta / np.sqrt(2 * np.pi * ds**3)\n            exponent = - (delta_delta**2) / (2 * ds)\n            return factor1 * np.exp(exponent)\n\n        # 1. Calculate Mass Fraction F(M_min)\n        # We use the analytical form derived from the first-crossing distribution integral.\n        # F(M_min) = erfc(d_delta / sqrt(2 * (S_min - S0)))\n        arg_erfc = d_delta / np.sqrt(2 * (s_min - s0))\n        f_gt_mmin = erfc(arg_erfc)\n\n        # 2. Calculate Expected Number of Progenitors N(M_min)\n        # The integrand is (M0/M_STAR) * S^(1/ALPHA) * f(S|S0)\n        def integrand_n(s, s_0, delta_delta, m_0, m_star, alpha_inv):\n            return (m_0 / m_star) * (s**alpha_inv) * first_crossing_dist(s, s_0, delta_delta)\n        \n        n_gt_mmin, _ = quad(\n            integrand_n, \n            s0, \n            s_min, \n            args=(s0, d_delta, m0, M_STAR, 1/ALPHA)\n        )\n        \n        # 3. Calculate Normalization Check E\n        # E = |integral(f(S|S0) dS from S0 to inf) - 1|\n        # The integral should be 1 analytically. This checks numerical precision.\n        norm_integral, _ = quad(\n            first_crossing_dist,\n            s0,\n            np.inf,\n            args=(s0, d_delta)\n        )\n        e_norm = np.abs(norm_integral - 1.0)\n        \n        return f_gt_mmin, n_gt_mmin, e_norm\n\n    test_cases = [\n        # Case A (general)\n        {'m0': 1.0e12, 'z0': 0.0, 'z1': 1.0, 'm_min': 1.0e11},\n        # Case B (boundary)\n        {'m0': 1.0e12, 'z0': 0.0, 'z1': 0.0, 'm_min': 1.0e11},\n        # Case C (near-threshold)\n        {'m0': 8.0e11, 'z0': 0.0, 'z1': 0.5, 'm_min': 7.0e11},\n        # Case D (high redshift gap)\n        {'m0': 1.0e13, 'z0': 0.0, 'z1': 3.0, 'm_min': 1.0e12},\n    ]\n\n    results = []\n    for case in test_cases:\n        f_val, n_val, e_val = calculate_merger_tree_stats(\n            case['m0'], case['z0'], case['z1'], case['m_min']\n        )\n        results.extend([f_val, n_val, e_val])\n\n    # Format output as specified: comma-separated list in brackets, rounded to 6 decimal places.\n    formatted_results = [f\"{val:.6f}\" for val in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n\n```"
        },
        {
            "introduction": "The halo mass function is a powerful probe of cosmology, as its shape and amplitude are highly sensitive to the underlying matter power spectrum $P(k)$. This practice applies the Press-Schechter formalism to quantify how non-standard models, such as those with Warm Dark Matter (WDM) or massive neutrinos, suppress the formation of low-mass halos. You will analytically calculate the change in the halo mass function at a characteristic mass scale, connecting modifications to $P(k)$ directly to observable halo statistics .",
            "id": "3482256",
            "problem": "Consider Gaussian initial conditions for matter density fluctuations with power spectrum $P(k)$ and a real-space top-hat filter of Lagrangian radius $R(M)$ associated with mass $M$ through $M = (4\\pi/3)\\,\\bar{\\rho}_{\\mathrm{m}}\\,R^{3}$, where $\\bar{\\rho}_{\\mathrm{m}}$ is the comoving mean matter density. The variance of the linearly extrapolated density field smoothed on mass scale $M$ is\n$$\n\\sigma^{2}(M) \\equiv \\int_{0}^{\\infty} \\frac{\\mathrm{d}k}{2\\pi^{2}}\\,k^{2}\\,P(k)\\,|W(kR)|^{2},\n$$\nwith $W(x)$ the Fourier transform of the real-space top-hat window. In the constant-barrier excursion-set approach (equivalent to the Press–Schechter prescription), the collapse threshold at redshift $z=0$ is $\\delta_{\\mathrm{c}}=1.686$.\n\nNow compare three cosmologies at $z=0$:\n- A baseline Cold Dark Matter (CDM) model.\n- A Warm Dark Matter (WDM) model defined by a half-mode wavenumber $k_{\\mathrm{hm}}$ satisfying $T_{\\mathrm{WDM}}^{2}(k_{\\mathrm{hm}})=1/2$, where $T_{\\mathrm{WDM}}(k)$ is the linear-theory transfer function ratio relative to CDM.\n- A combined WDM plus massive-neutrino model, with neutrino mass fraction $f_{\\nu} \\equiv \\Omega_{\\nu}/\\Omega_{\\mathrm{m}} = 0.010$ and a free-streaming scale $k_{\\mathrm{fs}}$ such that $k_{\\mathrm{hm}} \\gg k_{\\mathrm{fs}}$, allowing the asymptotic small-scale suppression of the total-matter transfer function due to neutrinos to be taken as scale independent near $k \\simeq k_{\\mathrm{hm}}$.\n\nAdopt the following controlled and widely used approximations, justified by the narrow-$k$ response of $|W(kR)|^{2}$ about $k \\sim R^{-1}$ on quasi power-law segments of $P(k)$:\n1. At $M$ corresponding to $k \\simeq k_{\\mathrm{hm}}$ (that is, at the half-mode mass $M_{\\mathrm{hm}}$), approximate the variance in the WDM-plus-neutrino model by multiplying the CDM variance by the product of transfer-function suppressions evaluated at $k_{\\mathrm{hm}}$,\n$$\n\\sigma^{2}_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})\\,\\approx\\,T_{\\mathrm{WDM}}^{2}(k_{\\mathrm{hm}})\\,T_{\\nu}^{2}(k_{\\mathrm{hm}})\\,\\sigma^{2}_{\\mathrm{CDM}}(M_{\\mathrm{hm}}).\n$$\nUse the small-scale, linear-theory approximation $T_{\\nu}^{2}(k_{\\mathrm{hm}})\\simeq 1-8f_{\\nu}$.\n2. Neglect, to leading order, any change in the local logarithmic slope $\\mathrm{d}\\ln \\sigma/\\mathrm{d}\\ln M$ between the CDM and the WDM-plus-neutrino models at $M_{\\mathrm{hm}}$ so that the dominant change in the Press–Schechter halo mass function at fixed $M$ is controlled by the factors of $\\sigma(M)$ and the exponential sensitivity to $\\delta_{\\mathrm{c}}/\\sigma(M)$.\n\nSuppose a numerical integration of the CDM power spectrum for a fiducial $\\Lambda$CDM cosmology yields\n$$\n\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})=1.000.\n$$\nUsing the excursion-set barrier crossing picture and the approximations above, derive an analytic expression for the ratio\n$$\n\\mathcal{S}\\,\\equiv\\,\\frac{n_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})}{n_{\\mathrm{CDM}}(M_{\\mathrm{hm}})}\n$$\nin terms of $\\delta_{\\mathrm{c}}$, $\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})$, and $f_{\\nu}$, then evaluate it numerically at $f_{\\nu}=0.010$ and $T_{\\mathrm{WDM}}^{2}(k_{\\mathrm{hm}})=1/2$ with $\\delta_{\\mathrm{c}}=1.686$ and $\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})=1.000$.\n\nExpress your final answer for $\\mathcal{S}$ as a decimal and round to four significant figures.",
            "solution": "The problem asks for the ratio of the halo mass functions of a Warm Dark Matter plus massive neutrinos (WDM+$\\nu$) cosmology and a standard Cold Dark Matter (CDM) cosmology, evaluated at a specific mass scale $M_{\\mathrm{hm}}$. The theoretical framework is the Press-Schechter (PS) model, which is equivalent to the constant-barrier excursion-set theory mentioned in the problem.\n\nThe PS differential halo mass function, $n(M)$, which gives the comoving number density of halos per unit mass interval, is given by:\n$$\nn(M) = \\frac{\\bar{\\rho}_{\\mathrm{m}}}{M} f(\\sigma) \\left| \\frac{\\mathrm{d}\\sigma}{\\mathrm{d}M} \\right|\n$$\nwhere $\\bar{\\rho}_{\\mathrm{m}}$ is the mean comoving matter density of the universe, $M$ is the halo mass, and $\\sigma(M)$ is the root-mean-square (rms) of the linear density field smoothed on the scale corresponding to mass $M$. The function $f(\\sigma)$ is the multiplicity function, which for the PS model is:\n$$\nf_{\\mathrm{PS}}(\\sigma) = \\sqrt{\\frac{2}{\\pi}} \\frac{\\delta_{\\mathrm{c}}}{\\sigma} \\exp\\left(-\\frac{\\delta_{\\mathrm{c}}^2}{2\\sigma^2}\\right)\n$$\nHere, $\\delta_{\\mathrm{c}}$ is the linear theory critical overdensity for collapse, given as $\\delta_{\\mathrm{c}} = 1.686$.\n\nSubstituting the multiplicity function into the expression for $n(M)$ and rewriting the derivative term using the chain rule, $\\left| \\frac{\\mathrm{d}\\sigma}{\\mathrm{d}M} \\right| = \\frac{\\sigma}{M} \\left| \\frac{\\mathrm{d}\\ln\\sigma}{\\mathrm{d}\\ln M} \\right|$, we obtain:\n$$\nn(M) = \\frac{\\bar{\\rho}_{\\mathrm{m}}}{M^2} \\sqrt{\\frac{2}{\\pi}} \\frac{\\delta_{\\mathrm{c}}}{\\sigma(M)} \\exp\\left(-\\frac{\\delta_{\\mathrm{c}}^2}{2\\sigma(M)^2}\\right) \\left| \\frac{\\mathrm{d}\\ln\\sigma}{\\mathrm{d}\\ln M} \\right|\n$$\nWe need to find the ratio $\\mathcal{S} \\equiv n_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}}) / n_{\\mathrm{CDM}}(M_{\\mathrm{hm}})$. Let the quantities for the WDM+$\\nu$ model be denoted by the subscript 'WDM+$\\nu$' and for the CDM model by 'CDM'. The ratio is:\n$$\n\\mathcal{S} = \\frac{n_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})}{n_{\\mathrm{CDM}}(M_{\\mathrm{hm}})} = \\frac{\\frac{\\bar{\\rho}_{\\mathrm{m}}}{M_{\\mathrm{hm}}^2} \\sqrt{\\frac{2}{\\pi}} \\frac{\\delta_{\\mathrm{c}}}{\\sigma_{\\mathrm{WDM}+\\nu}} \\exp\\left(-\\frac{\\delta_{\\mathrm{c}}^2}{2\\sigma_{\\mathrm{WDM}+\\nu}^2}\\right) \\left| \\frac{\\mathrm{d}\\ln\\sigma_{\\mathrm{WDM}+\\nu}}{\\mathrm{d}\\ln M}\\right|_{M_{\\mathrm{hm}}}}\n{\\frac{\\bar{\\rho}_{\\mathrm{m}}}{M_{\\mathrm{hm}}^2} \\sqrt{\\frac{2}{\\pi}} \\frac{\\delta_{\\mathrm{c}}}{\\sigma_{\\mathrm{CDM}}} \\exp\\left(-\\frac{\\delta_{\\mathrm{c}}^2}{2\\sigma_{\\mathrm{CDM}}^2}\\right) \\left| \\frac{\\mathrm{d}\\ln\\sigma_{\\mathrm{CDM}}}{\\mathrm{d}\\ln M}\\right|_{M_{\\mathrm{hm}}}}\n$$\nAll variances $\\sigma$ are evaluated at $M_{\\mathrm{hm}}$. Many terms cancel out:\n$$\n\\mathcal{S} = \\frac{\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})}{\\sigma_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})} \\exp\\left[ \\frac{\\delta_{\\mathrm{c}}^2}{2} \\left( \\frac{1}{\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})^2} - \\frac{1}{\\sigma_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})^2} \\right) \\right] \\frac{\\left| \\frac{\\mathrm{d}\\ln\\sigma_{\\mathrm{WDM}+\\nu}}{\\mathrm{d}\\ln M}\\right|_{M_{\\mathrm{hm}}}}{\\left| \\frac{\\mathrm{d}\\ln\\sigma_{\\mathrm{CDM}}}{\\mathrm{d}\\ln M}\\right|_{M_{\\mathrm{hm}}}}\n$$\nThe problem states to neglect, to leading order, any change in the local logarithmic slope $\\mathrm{d}\\ln \\sigma/\\mathrm{d}\\ln M$ between the models at $M_{\\mathrm{hm}}$. This means the ratio of the derivative terms is approximately $1$. The expression for $\\mathcal{S}$ simplifies to:\n$$\n\\mathcal{S} \\approx \\frac{\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})}{\\sigma_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})} \\exp\\left[ \\frac{\\delta_{\\mathrm{c}}^2}{2\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})^2} \\left( 1 - \\frac{\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})^2}{\\sigma_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})^2} \\right) \\right]\n$$\nNext, we use the provided approximation for the variance in the WDM+$\\nu$ model:\n$$\n\\sigma^{2}_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})\\,\\approx\\,T_{\\mathrm{WDM}}^{2}(k_{\\mathrm{hm}})\\,T_{\\nu}^{2}(k_{\\mathrm{hm}})\\,\\sigma^{2}_{\\mathrm{CDM}}(M_{\\mathrm{hm}})\n$$\nWe are given $T_{\\mathrm{WDM}}^{2}(k_{\\mathrm{hm}}) = 1/2$ and the approximation $T_{\\nu}^{2}(k_{\\mathrm{hm}})\\simeq 1-8f_{\\nu}$. Substituting these in, we get the ratio of the variances:\n$$\n\\frac{\\sigma^{2}_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})}{\\sigma^{2}_{\\mathrm{CDM}}(M_{\\mathrm{hm}})} \\approx \\frac{1}{2}(1-8f_{\\nu})\n$$\nThe reciprocal of this ratio is:\n$$\n\\frac{\\sigma^{2}_{\\mathrm{CDM}}(M_{\\mathrm{hm}})}{\\sigma^{2}_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})} \\approx \\frac{2}{1-8f_{\\nu}}\n$$\nSubstituting this into the expression for $\\mathcal{S}$:\n$$\n\\mathcal{S} \\approx \\left(\\frac{\\sigma^{2}_{\\mathrm{CDM}}(M_{\\mathrm{hm}})}{\\sigma^{2}_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})}\\right)^{1/2} \\exp\\left[ \\frac{\\delta_{\\mathrm{c}}^2}{2\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})^2} \\left( 1 - \\frac{\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})^2}{\\sigma_{\\mathrm{WDM}+\\nu}(M_{\\mathrm{hm}})^2} \\right) \\right]\n$$\n$$\n\\mathcal{S} \\approx \\sqrt{\\frac{2}{1-8f_{\\nu}}} \\exp\\left[ \\frac{\\delta_{\\mathrm{c}}^2}{2\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})^2} \\left( 1 - \\frac{2}{1-8f_{\\nu}} \\right) \\right]\n$$\nSimplifying the term inside the exponent:\n$$\n1 - \\frac{2}{1-8f_{\\nu}} = \\frac{1-8f_{\\nu}-2}{1-8f_{\\nu}} = -\\frac{1+8f_{\\nu}}{1-8f_{\\nu}}\n$$\nThis yields the final analytic expression for $\\mathcal{S}$ in terms of the specified parameters:\n$$\n\\mathcal{S} \\approx \\sqrt{\\frac{2}{1-8f_{\\nu}}} \\exp\\left[ -\\frac{\\delta_{\\mathrm{c}}^2}{2\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})^2} \\left( \\frac{1+8f_{\\nu}}{1-8f_{\\nu}} \\right) \\right]\n$$\nNow we evaluate this expression numerically using the provided values: $\\delta_{\\mathrm{c}} = 1.686$, $\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}}) = 1.000$, and $f_{\\nu}=0.010$.\n\nFirst, we calculate the terms involving $f_{\\nu}$:\n$$\n1-8f_{\\nu} = 1 - 8(0.010) = 1 - 0.08 = 0.92\n$$\n$$\n1+8f_{\\nu} = 1 + 8(0.010) = 1 + 0.08 = 1.08\n$$\nThe pre-exponential factor is:\n$$\n\\sqrt{\\frac{2}{1-8f_{\\nu}}} = \\sqrt{\\frac{2}{0.92}} \\approx \\sqrt{2.173913...} \\approx 1.4744195...\n$$\nThe argument of the exponent is:\n$$\n-\\frac{\\delta_{\\mathrm{c}}^2}{2\\sigma_{\\mathrm{CDM}}(M_{\\mathrm{hm}})^2} \\left( \\frac{1+8f_{\\nu}}{1-8f_{\\nu}} \\right) = -\\frac{(1.686)^2}{2(1.000)^2} \\left( \\frac{1.08}{0.92} \\right)\n$$\n$$\n\\approx -\\frac{2.842596}{2} (1.173913...) \\approx -1.421298 \\times 1.173913... \\approx -1.668541...\n$$\nThe exponential term is:\n$$\n\\exp(-1.668541...) \\approx 0.188518...\n$$\nFinally, we compute $\\mathcal{S}$:\n$$\n\\mathcal{S} \\approx 1.4744195... \\times 0.188518... \\approx 0.277953...\n$$\nRounding the result to four significant figures, we get $0.2780$.",
            "answer": "$$\\boxed{0.2780}$$"
        },
        {
            "introduction": "The standard excursion-set model relies on the idealized assumption of spherical collapse, which corresponds to a single, constant density barrier $\\delta_c$. This advanced exercise explores a more realistic scenario where the collapse threshold is a stochastic variable, reflecting the complex, non-spherical nature of gravitational collapse in a cosmological context. By numerically marginalizing over a distribution of collapse thresholds, you will learn how to relax core theoretical assumptions and assess their impact on the predicted abundance of rare, massive halos—a crucial skill in modern theoretical cosmology .",
            "id": "3482249",
            "problem": "Consider the excursion-set approach to dark matter halo formation where a smoothed linear density contrast $\\delta_R$ performs a Markovian random walk in smoothing variance $S(M)$ for a chosen filter, and halo formation is associated with a first up-crossing of a collapse barrier. In the constant-barrier idealization, the barrier is set by a critical overdensity $\\delta_c$ for spherical collapse, and the resulting high-mass asymptotics of the mass function depend exponentially on the combination $\\nu \\equiv \\delta_c^2 / S(M)$. In reality, halo-to-halo variability and non-sphericity introduce stochasticity in the effective collapse threshold, motivating a barrier $\\delta_c$ drawn from a distribution $p(\\delta_c)$ with support on $\\delta_c  0$.\n\nYour task is to derive, from first principles of the excursion-set framework and the first-crossing statistics for a constant barrier, how a stochastic $\\delta_c$ modifies the high-$\\nu$ asymptotics of the unconditional mass function. Specifically, at fixed mass scale $M$ (i.e., at fixed $S$), define a baseline collapse threshold $\\bar{\\delta}_c$ and the corresponding baseline peak-height $\\nu \\equiv \\bar{\\delta}_c^2 / S(M)$. Introduce barrier scatter by drawing $\\delta_c$ from a probability distribution $p(\\delta_c)$, and determine the ratio $R(\\nu,\\sigma_B,p)$ between the stochastically averaged high-$\\nu$ tail and the baseline constant-barrier result at the same $S(M)$. Express this ratio in a form that can be evaluated numerically by marginalizing over the random $\\delta_c$.\n\nAssume the following for $p(\\delta_c)$:\n- Truncated Gaussian case (renormalized on $\\delta_c  0$): mean $\\bar{\\delta}_c$ and standard deviation $\\sigma_B$, with probability density\n$$\np_{\\mathrm{G}}(\\delta_c \\mid \\bar{\\delta}_c,\\sigma_B) = \\frac{1}{\\sigma_B \\sqrt{2\\pi}\\,\\Phi\\!\\left(\\frac{\\bar{\\delta}_c}{\\sigma_B}\\right)} \\exp\\!\\left[-\\frac{(\\delta_c - \\bar{\\delta}_c)^2}{2\\sigma_B^2}\\right], \\quad \\delta_c  0,\n$$\nwhere $\\Phi(x) \\equiv \\frac{1}{2}\\left[1+\\mathrm{erf}\\!\\left(\\frac{x}{\\sqrt{2}}\\right)\\right]$ is the Gaussian cumulative distribution function at $x$.\n- Lognormal case: choose parameters such that the mean is $\\bar{\\delta}_c$ and the variance is $\\sigma_B^2$. If $Y \\equiv \\ln \\delta_c$ is Gaussian with mean $\\mu_L$ and variance $\\sigma_L^2$, enforce $\\mathbb{E}[\\delta_c] = \\bar{\\delta}_c$ and $\\mathrm{Var}(\\delta_c) = \\sigma_B^2$ by\n$$\n\\sigma_L^2 = \\ln\\!\\left(1 + \\frac{\\sigma_B^2}{\\bar{\\delta}_c^2}\\right), \\quad \\mu_L = \\ln \\bar{\\delta}_c - \\frac{1}{2}\\sigma_L^2,\n$$\nand\n$$\np_{\\mathrm{LN}}(\\delta_c \\mid \\bar{\\delta}_c,\\sigma_B) = \\frac{1}{\\delta_c \\sigma_L \\sqrt{2\\pi}} \\exp\\!\\left[-\\frac{\\left(\\ln \\delta_c - \\mu_L\\right)^2}{2\\sigma_L^2}\\right], \\quad \\delta_c  0.\n$$\n\nUse the canonical spherical-collapse baseline $\\bar{\\delta}_c = 1.686$ (dimensionless). Work in dimensionless quantities throughout; no physical units are required. You must implement the numerical evaluation of the required marginalization integral(s) with respect to $\\delta_c$.\n\nTest suite:\n- Case $1$: $\\nu = 4.0$, $\\sigma_B = 0.0$, distribution $p = p_{\\mathrm{G}}$ (no scatter boundary case).\n- Case $2$: $\\nu = 9.0$, $\\sigma_B = 0.2$, distribution $p = p_{\\mathrm{G}}$ (high-$\\nu$ with mild Gaussian scatter).\n- Case $3$: $\\nu = 16.0$, $\\sigma_B = 0.2$, distribution $p = p_{\\mathrm{G}}$ (higher-$\\nu$ tail).\n- Case $4$: $\\nu = 9.0$, $\\sigma_B = 0.2$, distribution $p = p_{\\mathrm{LN}}$ (high-$\\nu$ with mild lognormal scatter).\n- Case $5$: $\\nu = 1.0$, $\\sigma_B = 0.5$, distribution $p = p_{\\mathrm{G}}$ (lower $\\nu$ with larger scatter).\n- Case $6$: $\\nu = 25.0$, $\\sigma_B = 0.5$, distribution $p = p_{\\mathrm{G}}$ (extreme high-$\\nu$ edge case).\n\nYour program should compute $R(\\nu,\\sigma_B,p)$ for each case as a floating-point number. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (for example, `[result1,result2,result3]`). No additional text should be printed. If $\\sigma_B = 0.0$, treat the distribution as a Dirac delta at $\\bar{\\delta}_c$ and return $R = 1.0$ exactly for that case.",
            "solution": "The problem requires the derivation of the ratio, $R(\\nu, \\sigma_B, p)$, between the high-$\\nu$ tail of the unconditional mass function for a stochastic collapse barrier and that for a constant baseline barrier. This will be accomplished by deriving the first-crossing distributions for both scenarios and then computing their ratio.\n\nLet us begin with the foundational element of the excursion-set formalism: the first-crossing distribution. In this framework, the smoothed linear density contrast, $\\delta_R$, undergoes a Markovian random walk as a function of the smoothing variance $S(M)$, where $M$ is the mass scale. Halos of mass $M$ are associated with random walks that cross a collapse threshold $\\delta_c$ for the first time at the variance scale $S(M)$.\n\nFor a constant barrier $\\delta_c$, the probability density function for a first crossing at variance $S$, denoted $f(S; \\delta_c)$, is the solution to a diffusion problem with an absorbing boundary at $\\delta_c$. The well-known result is:\n$$\nf(S; \\delta_c) = \\frac{\\delta_c}{\\sqrt{2\\pi S^3}} \\exp\\left(-\\frac{\\delta_c^2}{2S}\\right)\n$$\nThe high-mass (and thus high-$\\nu$) tail of the unconditional halo mass function is directly proportional to this first-crossing distribution, $f(S)$. Other factors, such as the mean matter density and the Jacobian of the $S-M$ relation, are common to both the baseline and the stochastic models and will cancel when we compute the ratio.\n\nThe baseline model employs a constant collapse threshold $\\bar{\\delta}_c = 1.686$. At a fixed mass scale $M$, corresponding to a variance $S(M)$, the first-crossing distribution is:\n$$\nf_{\\text{base}}(S) = f(S; \\bar{\\delta}_c) = \\frac{\\bar{\\delta}_c}{\\sqrt{2\\pi S^3}} \\exp\\left(-\\frac{\\bar{\\delta}_c^2}{2S}\\right)\n$$\nThe problem defines the peak-height parameter as $\\nu \\equiv \\bar{\\delta}_c^2 / S(M)$. Using this definition, the exponential term becomes $\\exp(-\\nu/2)$. The baseline first-crossing distribution, expressed in terms of $\\nu$, is:\n$$\nf_{\\text{base}}(S) = \\frac{\\bar{\\delta}_c}{\\sqrt{2\\pi (\\bar{\\delta}_c^2/\\nu)^3}} \\exp\\left(-\\frac{\\nu}{2}\\right)\n$$\n\nNext, we consider the case where the collapse threshold is not constant but is a random variable drawn from a probability distribution $p(\\delta_c)$ with support on $\\delta_c  0$. For any specific value of $\\delta_c$ drawn from this distribution, the first-crossing distribution remains $f(S; \\delta_c)$. To find the stochastically averaged first-crossing distribution, $\\langle f(S) \\rangle$, we must marginalize over all possible values of $\\delta_c$, weighted by their probability density $p(\\delta_c)$:\n$$\n\\langle f(S) \\rangle = \\int_0^\\infty f(S; \\delta_c) \\, p(\\delta_c) \\, \\mathrm{d}\\delta_c\n$$\nSubstituting the expression for $f(S; \\delta_c)$:\n$$\n\\langle f(S) \\rangle = \\int_0^\\infty \\frac{\\delta_c}{\\sqrt{2\\pi S^3}} \\exp\\left(-\\frac{\\delta_c^2}{2S}\\right) p(\\delta_c) \\, \\mathrm{d}\\delta_c\n$$\nThe problem asks for the ratio $R$ of the stochastically averaged result to the baseline result at the same mass scale (i.e., same $S$ and same $\\nu$).\n$$\nR(\\nu, \\sigma_B, p) = \\frac{\\langle f(S) \\rangle}{f_{\\text{base}}(S)} = \\frac{\\int_0^\\infty \\frac{\\delta_c}{\\sqrt{2\\pi S^3}} \\exp\\left(-\\frac{\\delta_c^2}{2S}\\right) p(\\delta_c) \\, \\mathrm{d}\\delta_c}{\\frac{\\bar{\\delta}_c}{\\sqrt{2\\pi S^3}} \\exp\\left(-\\frac{\\bar{\\delta}_c^2}{2S}\\right)}\n$$\nThe term $1/\\sqrt{2\\pi S^3}$ cancels, simplifying the expression to:\n$$\nR = \\frac{\\int_0^\\infty \\delta_c \\exp\\left(-\\frac{\\delta_c^2}{2S}\\right) p(\\delta_c) \\, \\mathrm{d}\\delta_c}{\\bar{\\delta}_c \\exp\\left(-\\frac{\\bar{\\delta}_c^2}{2S}\\right)}\n$$\nTo make the dependence on $\\nu$ explicit, we substitute $S = \\bar{\\delta}_c^2 / \\nu$. The exponent in the integrand becomes $-\\frac{\\delta_c^2}{2(\\bar{\\delta}_c^2/\\nu)} = -\\frac{\\nu}{2} \\left(\\frac{\\delta_c}{\\bar{\\delta}_c}\\right)^2$, and the exponent in the denominator becomes $-\\frac{\\nu}{2}$. This yields the final expression for the ratio to be evaluated:\n$$\nR(\\nu, \\sigma_B, p) = \\frac{\\int_0^\\infty \\delta_c \\exp\\left[-\\frac{\\nu}{2} \\left(\\frac{\\delta_c}{\\bar{\\delta}_c}\\right)^2\\right] p(\\delta_c \\mid \\bar{\\delta}_c, \\sigma_B) \\, \\mathrm{d}\\delta_c}{\\bar{\\delta}_c \\exp\\left[-\\frac{\\nu}{2}\\right]}\n$$\nThis marginalization integral is generally not solvable in closed form and must be evaluated numerically. For computational stability, particularly at large $\\nu$ where $\\exp(-\\nu/2)$ can underflow, it is advantageous to rearrange the expression as:\n$$\nR(\\nu, \\sigma_B, p) = \\frac{e^{\\nu/2}}{\\bar{\\delta}_c} \\int_0^\\infty \\delta_c \\exp\\left[-\\frac{\\nu}{2} \\left(\\frac{\\delta_c}{\\bar{\\delta}_c}\\right)^2\\right] p(\\delta_c \\mid \\bar{\\delta}_c, \\sigma_B) \\, \\mathrm{d}\\delta_c\n$$\nThe integration is performed over $\\delta_c$ from $0$ to $\\infty$. The probability density $p(\\delta_c \\mid \\bar{\\delta}_c, \\sigma_B)$ is given for two cases: a truncated Gaussian ($p_{\\mathrm{G}}$) and a lognormal distribution ($p_{\\mathrm{LN}}$), both of which are defined in the problem statement. The numerical implementation will involve defining these probability density functions and using a numerical quadrature routine, such as `scipy.integrate.quad`, to compute the definite integral.\n\nFor the special case where the scatter $\\sigma_B = 0$, the probability distribution $p(\\delta_c)$ becomes a Dirac delta function, $p(\\delta_c) = \\delta_D(\\delta_c - \\bar{\\delta}_c)$. Evaluating the integral with the sifting property of the delta function, the numerator becomes $\\bar{\\delta}_c \\exp\\left[-\\frac{\\nu}{2} \\left(\\frac{\\bar{\\delta}_c}{\\bar{\\delta}_c}\\right)^2\\right] = \\bar{\\delta}_c \\exp(-\\nu/2)$. The ratio to the denominator, which is identical, is exactly $R=1$, as expected since this case recovers the baseline model.",
            "answer": "```python\nimport numpy as np\nfrom scipy.integrate import quad\nfrom scipy.special import erf\n\ndef solve():\n    \"\"\"\n    Solves the problem of calculating the ratio of stochastically averaged\n    halo mass function tail to the baseline constant-barrier result.\n    \"\"\"\n\n    # Baseline spherical collapse threshold as a global constant\n    D_C_BAR = 1.686\n\n    def phi_cdf(x):\n        \"\"\"\n        Computes the standard Gaussian cumulative distribution function Phi(x).\n        Phi(x) = 1/2 * [1 + erf(x / sqrt(2))].\n        \"\"\"\n        return 0.5 * (1.0 + erf(x / np.sqrt(2.0)))\n\n    def p_gaussian(delta_c, d_c_bar, sigma_B):\n        \"\"\"\n        Probability density function for the Truncated Gaussian case,\n        renormalized on delta_c  0.\n        \"\"\"\n        # The distribution has support for delta_c  0.\n        if delta_c = 0:\n            return 0.0\n        \n        # Denominator of the PDF, which is the normalization constant.\n        norm_factor = sigma_B * np.sqrt(2.0 * np.pi) * phi_cdf(d_c_bar / sigma_B)\n        \n        # Avoid division by zero in the unlikely case of a zero norm.\n        if norm_factor == 0.0:\n            return 0.0\n        \n        exponent = -((delta_c - d_c_bar)**2) / (2.0 * sigma_B**2)\n        return (1.0 / norm_factor) * np.exp(exponent)\n\n    def p_lognormal(delta_c, d_c_bar, sigma_B):\n        \"\"\"\n        Probability density function for the Lognormal case, with parameters\n        chosen to match mean = d_c_bar and variance = sigma_B^2.\n        \"\"\"\n        # The distribution has support for delta_c  0.\n        if delta_c = 0:\n            return 0.0\n\n        # Calculate lognormal parameters mu_L and sigma_L from the mean and variance.\n        # sigma_L^2 = ln(1 + Var(X) / E[X]^2)\n        variance_ratio = (sigma_B / d_c_bar)**2\n        sigma_L_sq = np.log(1.0 + variance_ratio)\n        sigma_L = np.sqrt(sigma_L_sq)\n        \n        # mu_L = ln(E[X]) - 1/2 * sigma_L^2\n        mu_L = np.log(d_c_bar) - 0.5 * sigma_L_sq\n        \n        # Avoid division by zero if delta_c or sigma_L is zero.\n        if sigma_L == 0.0 or delta_c == 0.0:\n            return 0.0\n\n        norm_factor = delta_c * sigma_L * np.sqrt(2.0 * np.pi)\n        exponent = -((np.log(delta_c) - mu_L)**2) / (2.0 * sigma_L_sq)\n        return (1.0 / norm_factor) * np.exp(exponent)\n\n    def calculate_ratio(nu, sigma_B, dist_type):\n        \"\"\"\n        Calculates the ratio R(nu, sigma_B, p) by numerical integration.\n        \n        R = [e^(nu/2) / d_c_bar] * integral_0^inf [\n                delta_c * exp(-nu/2 * (delta_c/d_c_bar)^2) * p(delta_c)\n            ] d(delta_c)\n        \"\"\"\n        # Per problem specification, if sigma_B=0, R=1.0 exactly.\n        # This corresponds to p(delta_c) being a Dirac delta function at d_c_bar.\n        if sigma_B == 0.0:\n            return 1.0\n\n        if dist_type == 'gaussian':\n            pdf_func = lambda dc: p_gaussian(dc, D_C_BAR, sigma_B)\n        elif dist_type == 'lognormal':\n            pdf_func = lambda dc: p_lognormal(dc, D_C_BAR, sigma_B)\n        else:\n            raise ValueError(f\"Unknown distribution type: {dist_type}\")\n\n        # Define the integrand for the numerator of the original R expression.\n        # This function will be integrated from 0 to infinity.\n        def integrand(delta_c):\n            # Term 1 from the integral expression\n            term1 = delta_c\n            # Term 2 is the exponential factor\n            term2 = np.exp(-0.5 * nu * (delta_c / D_C_BAR)**2)\n            # Term 3 is the probability density of delta_c\n            term3 = pdf_func(delta_c)\n            return term1 * term2 * term3\n\n        # Numerator: Integrate the function from 0 to infinity.\n        # quad returns a tuple (result, estimated_error).\n        integral_val, _ = quad(integrand, 0, np.inf)\n\n        # Denominator of the original R expression can cause underflow for large nu.\n        # We use the rearranged expression to maintain numerical stability.\n        # R = (exp(nu/2) / D_C_BAR) * integral_val\n        stable_ratio = (1.0 / D_C_BAR) * np.exp(0.5 * nu) * integral_val\n        \n        return stable_ratio\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (4.0, 0.0, 'p_G'),      # Case 1\n        (9.0, 0.2, 'p_G'),      # Case 2\n        (16.0, 0.2, 'p_G'),     # Case 3\n        (9.0, 0.2, 'p_LN'),     # Case 4\n        (1.0, 0.5, 'p_G'),      # Case 5\n        (25.0, 0.5, 'p_G'),     # Case 6\n    ]\n\n    results = []\n    dist_map = {'p_G': 'gaussian', 'p_LN': 'lognormal'}\n\n    for nu_val, sigma_B_val, p_type in test_cases:\n        dist_name = dist_map[p_type]\n        result = calculate_ratio(nu_val, sigma_B_val, dist_name)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.8f}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}