{
    "hands_on_practices": [
        {
            "introduction": "The simple geometric opening criterion, $s/r \\lt \\theta$, is a cornerstone of many tree codes, but its effectiveness is not uniform. This exercise explores the limitations of this isotropic criterion by examining a highly anisotropic mass distribution—a thin filament. By calculating the quadrupole moment and the resulting error in the gravitational potential, you will discover how the truncation error depends critically on the orientation of the mass distribution relative to the observer, a factor the simple geometric test ignores .",
            "id": "3480592",
            "problem": "Consider a homogeneous, thin mass filament aligned with the $z$-axis, of total length $L$ and linear mass density $\\lambda$, centered at the origin so that its endpoints lie at $z=-L/2$ and $z=+L/2$. Let the total mass be $M=\\lambda L$. The gravitational interaction is Newtonian with gravitational constant $G$. For distances $r$ large compared to $L$, the gravitational potential of an extended mass distribution can be represented by a multipole expansion about the center of mass. The trace-free mass quadrupole tensor is defined by\n$$\nQ_{ij}=\\int \\rho(\\mathbf{r}')\\left(3 x'_i x'_j - r'^2 \\delta_{ij}\\right)\\,\\mathrm{d}^3\\mathbf{r}' \\, ,\n$$\nwith $\\delta_{ij}$ the Kronecker delta, and the far-field potential includes a quadrupole contribution proportional to $n_i n_j Q_{ij}$, where $\\mathbf{n}=\\mathbf{r}/r$ is the line-of-sight unit vector.\n\nA Barnes–Hut (BH) tree code uses the geometric opening criterion $s/r<\\theta$ with a prescribed tolerance $\\theta$, where $s$ is a characteristic size of the cell. In this problem, take $s=L$ for the filament. Work in the limit $r\\gg L$ and place the origin at the center of mass so that the dipole contribution vanishes.\n\nTasks:\n- Using the quadrupole definition above, derive the dominant nonzero components $Q_{xx}$, $Q_{yy}$, and $Q_{zz}$ for the filament.\n- Using the multipole expansion logic based on Newtonian gravity, express the leading fractional error of the monopole-only approximation to the potential, defined as the magnitude of the omitted quadrupole term divided by the monopole term, in terms of $\\mathbf{n}$, $Q_{ij}$, $M$, and $r$.\n- Evaluate this fractional error for two viewing directions: $\\mathbf{n}$ parallel to the filament axis (the $z$-axis) and $\\mathbf{n}$ perpendicular to it (the $x$-axis). Show how the error depends on $\\theta$ when $s=L$, and explain why the geometric acceptance $s/r<\\theta$ can underpredict errors for certain viewing angles.\n\nAnswer specification: Provide as the final answer the analytic expression for the worst-case fractional error as a function of $\\theta$. No numerical rounding is required. The final answer must be a single closed-form expression with no units.",
            "solution": "The problem statement is assessed to be valid. It is scientifically grounded in Newtonian mechanics and computational astrophysics, well-posed with a clear objective and sufficient data, and formulated with objective and precise language. There are no contradictions, ambiguities, or factual unsoundness. We may therefore proceed with a full solution.\n\nThe problem asks for an analysis of the leading-order error in the monopole approximation of the gravitational potential for a thin mass filament, specifically in the context of a Barnes-Hut tree code's opening criterion.\n\nFirst, we calculate the components of the trace-free mass quadrupole tensor $Q_{ij}$ for the specified filament. The filament has a constant linear mass density $\\lambda$, a total length $L$, and is aligned with the $z$-axis, centered at the origin. Its total mass is $M = \\lambda L$. The three-dimensional mass density $\\rho(\\mathbf{r}')$ can be represented using Dirac delta functions as:\n$$\n\\rho(\\mathbf{r}') = \\lambda \\, \\delta(x') \\, \\delta(y') \\, \\Pi(z'/L)\n$$\nwhere $\\Pi(u)$ is the rectangular function, equal to $1$ for $|u| \\le 1/2$ and $0$ otherwise. Here, the position vector within the mass distribution is $\\mathbf{r}' = (x', y', z')$. For the filament, $x'=0$ and $y'=0$, while $z'$ ranges from $-L/2$ to $L/2$. Consequently, $|\\mathbf{r}'|^2 = r'^2 = z'^2$.\n\nThe definition of the quadrupole tensor is:\n$$\nQ_{ij} = \\int \\rho(\\mathbf{r}') \\left(3 x'_i x'_j - r'^2 \\delta_{ij}\\right) \\, \\mathrm{d}^3\\mathbf{r}'\n$$\nSubstituting the density for the filament, the volume integral reduces to a one-dimensional integral along the $z'$-axis:\n$$\nQ_{ij} = \\lambda \\int_{-L/2}^{L/2} \\left(3 x'_i x'_j - z'^2 \\delta_{ij}\\right) \\, \\mathrm{d}z'\n$$\nwhere $x'_1=x'=0$, $x'_2=y'=0$, and $x'_3=z'$.\n\nDue to the axial symmetry and the fact that $x'=y'=0$ along the filament, any off-diagonal component $Q_{ij}$ with $i \\neq j$ must contain a factor of $x_i'$ or $x_j'$ (or both) that is zero. For example, $Q_{12} = \\lambda \\int (3x'y' - ...) = 0$. Thus, all off-diagonal components are zero.\n\nWe now compute the diagonal components:\nFor $Q_{zz}$ ($i=j=3$):\n$$\nQ_{zz} = \\lambda \\int_{-L/2}^{L/2} (3(z')^2 - (z')^2 \\delta_{33}) \\, \\mathrm{d}z' = 2\\lambda \\int_{-L/2}^{L/2} (z')^2 \\, \\mathrm{d}z'\n$$\nThe integral evaluates to $\\int_{-L/2}^{L/2} (z')^2 \\, \\mathrm{d}z' = \\left[\\frac{(z')^3}{3}\\right]_{-L/2}^{L/2} = \\frac{(L/2)^3}{3} - \\frac{(-L/2)^3}{3} = 2 \\frac{L^3/8}{3} = \\frac{L^3}{12}$.\nSo, $Q_{zz} = 2\\lambda \\left(\\frac{L^3}{12}\\right) = \\frac{\\lambda L^3}{6}$. Substituting $M = \\lambda L$, we get:\n$$\nQ_{zz} = \\frac{ML^2}{6}\n$$\nFor $Q_{xx}$ ($i=j=1$):\n$$\n$Q_{xx} = \\lambda \\int_{-L/2}^{L/2} (3(x')^2 - (z')^2 \\delta_{11}) \\, \\mathrm{d}z' = \\lambda \\int_{-L/2}^{L/2} (0 - (z')^2) \\, \\mathrm{d}z' = -\\lambda \\left(\\frac{L^3}{12}\\right)$\n$$\nSubstituting $M = \\lambda L$, we find:\n$$\nQ_{xx} = -\\frac{ML^2}{12}\n$$\nBy symmetry, $Q_{yy} = Q_{xx}$:\n$$\nQ_{yy} = -\\frac{ML^2}{12}\n$$\nAs a check, the tensor must be trace-free: $\\sum_i Q_{ii} = Q_{xx} + Q_{yy} + Q_{zz} = -\\frac{ML^2}{12} - \\frac{ML^2}{12} + \\frac{ML^2}{6} = 0$, which is correct.\n\nNext, we formulate the fractional error. The multipole expansion of the gravitational potential $\\Phi(\\mathbf{r})$ for a mass distribution centered at the origin (so the dipole moment is zero) is:\n$$\n\\Phi(\\mathbf{r}) = -\\frac{GM}{r} - \\frac{G}{2r^3} \\sum_{i,j} Q_{ij} n_i n_j + \\mathcal{O}(r^{-4})\n$$\nwhere $\\mathbf{n} = \\mathbf{r}/r$ is the unit vector pointing to the observation point. The monopole term is $\\Phi_0 = -GM/r$, and the leading-order correction is the quadrupole term, $\\Phi_2 = -\\frac{G}{2r^3} \\sum_{i,j} Q_{ij} n_i n_j$. The fractional error $\\epsilon$ of the monopole-only approximation is the magnitude of the ratio of the quadrupole to the monopole term:\n$$\n\\epsilon = \\left| \\frac{\\Phi_2}{\\Phi_0} \\right| = \\left| \\frac{-\\frac{G}{2r^3} \\sum_{i,j} Q_{ij} n_i n_j}{-\\frac{GM}{r}} \\right| = \\frac{1}{2Mr^2} \\left| \\sum_{i,j} Q_{ij} n_i n_j \\right|\n$$\nThe sum $\\sum Q_{ij} n_i n_j$ for our filament is:\n$$\n\\sum_{i,j} Q_{ij} n_i n_j = Q_{xx}n_x^2 + Q_{yy}n_y^2 + Q_{zz}n_z^2 = -\\frac{ML^2}{12}n_x^2 - \\frac{ML^2}{12}n_y^2 + \\frac{ML^2}{6}n_z^2\n$$\n$$\n= \\frac{ML^2}{12} (-n_x^2 - n_y^2 + 2n_z^2)\n$$\nUsing the identity $n_x^2+n_y^2+n_z^2 = 1$, we have $n_x^2+n_y^2 = 1-n_z^2$. Substituting this gives:\n$$\n\\sum_{i,j} Q_{ij} n_i n_j = \\frac{ML^2}{12} \\left(-(1-n_z^2) + 2n_z^2\\right) = \\frac{ML^2}{12}(3n_z^2 - 1)\n$$\nSubstituting this back into the expression for $\\epsilon$:\n$$\n\\epsilon = \\frac{1}{2Mr^2} \\left| \\frac{ML^2}{12}(3n_z^2 - 1) \\right| = \\frac{L^2}{24 r^2} |3n_z^2 - 1|\n$$\nNow, we evaluate this error for two specific viewing directions.\n1.  Parallel to the filament axis ($\\mathbf{n}$ is along the $z$-axis): Here $n_z^2 = 1$.\n    $$\n    \\epsilon_{\\parallel} = \\frac{L^2}{24 r^2} |3(1) - 1| = \\frac{2L^2}{24r^2} = \\frac{L^2}{12r^2}\n    $$\n2.  Perpendicular to the filament axis ($\\mathbf{n}$ is in the $xy$-plane): Here $n_z^2 = 0$.\n    $$\n    \\epsilon_{\\perp} = \\frac{L^2}{24 r^2} |3(0) - 1| = \\frac{L^2}{24r^2}\n    $$\nThe Barnes-Hut opening criterion is $s/r < \\theta$, where $s$ is the cell size. The problem sets $s=L$. The force from the cell is approximated by a monopole when $L/r < \\theta$. The largest error for a given tolerance $\\theta$ occurs at the boundary of this condition, i.e., at $L/r = \\theta$. From this, we have $(L/r)^2 = \\theta^2$. We can express the errors in terms of $\\theta$:\n$$\n\\epsilon_{\\parallel} = \\frac{1}{12} \\left(\\frac{L}{r}\\right)^2 = \\frac{\\theta^2}{12}\n$$\n$$\n\\epsilon_{\\perp} = \\frac{1}{24} \\left(\\frac{L}{r}\\right)^2 = \\frac{\\theta^2}{24}\n$$\nThe error depends on the viewing angle. The geometric criterion $L/r < \\theta$ is isotropic; it depends only on the ratio of size to distance, not on the orientation of the mass distribution relative to the observer. For a fixed ratio $L/r$ (and thus fixed $\\theta$), the true fractional error $\\epsilon = \\frac{1}{24}(L/r)^2 |3n_z^2 - 1|$ can vary. The error is smallest, $\\epsilon_{\\perp}$, when viewing the filament broadside ($n_z=0$), and largest, $\\epsilon_{\\parallel} = 2 \\epsilon_{\\perp}$, when viewing it end-on ($n_z=1$). A simple geometric opening criterion thus fails to provide a uniform error bound. If $\\theta$ is chosen to satisfy a certain error tolerance for an \"average\" orientation, it will significantly underestimate the error for the worst-case orientation, which for the filament is along its axis.\n\nFinally, to find the worst-case fractional error, we must maximize the expression $\\epsilon = \\frac{\\theta^2}{24} |3n_z^2 - 1|$ with respect to the viewing direction, which is parametrized by $n_z$. Since $0 \\le n_z^2 \\le 1$, the term $|3n_z^2 - 1|$ is maximized when $n_z^2=1$. In this case, the factor is $|3(1)-1|=2$.\nThe worst-case fractional error, $\\epsilon_{\\text{max}}$, at the acceptance boundary $L/r = \\theta$ is:\n$$\n\\epsilon_{\\text{max}} = \\frac{\\theta^2}{24} \\times 2 = \\frac{\\theta^2}{12}\n$$",
            "answer": "$$\n\\boxed{\\frac{\\theta^2}{12}}\n$$"
        },
        {
            "introduction": "To ensure a desired level of accuracy, a tree code's opening criterion must be quantitatively linked to the underlying physics of the multipole expansion. This practice moves beyond simple geometric arguments to a rigorous, error-based approach. You will derive an orientation-agnostic bound on the acceleration error from the leading neglected term—the quadrupole—and use it to determine the precise value of the opening parameter $\\alpha$ required to keep the fractional error below a specified tolerance $\\varepsilon$ .",
            "id": "3480580",
            "problem": "A Barnes–Hut (BH) tree code in a Newtonian $N$-body cosmology simulation approximates the gravitational influence of a distant cell by truncating the multipole expansion at the monopole, placing the total mass at the cell’s center of mass. Consider one such cell with total mass $M$, center-of-mass at the origin, and all its constituent masses lying within a sphere of radius $s/2$ (so the cell has characteristic size $s$). A target particle lies at distance $r$ from the origin, with unit direction vector $\\mathbf{n} = \\mathbf{r}/r$. Assume the dipole term vanishes because the expansion is taken about the center of mass.\n\nThe leading neglected term is the quadrupole. The mass quadrupole tensor is defined by\n$$\nQ_{ij} \\equiv \\sum_{a} m_{a} \\left( 3 x_{a,i} x_{a,j} - |\\mathbf{x}_{a}|^{2} \\delta_{ij} \\right),\n$$\nwhere $\\mathbf{x}_{a}$ are positions of particles within the cell relative to the center of mass, $m_{a}$ are their masses, and $\\delta_{ij}$ is the Kronecker delta. The target particle has a current estimate of the total acceleration magnitude $|\\mathbf{a}_{\\text{ref}}|$ from already-accepted interactions.\n\nThe tree uses the following acceptance test, parameterized by a dimensionless threshold $\\alpha$: a cell is accepted at monopole order for the target particle if\n$$\n\\frac{G M s^{2}}{r^{4}} \\leq \\alpha \\, |\\mathbf{a}_{\\text{ref}}|,\n$$\nwhere $G$ is the gravitational constant. Under the worst-case orientation of the cell’s internal mass distribution relative to $\\mathbf{n}$, require that the total fractional error in the target’s acceleration induced by accepting a single cell (i.e., the ratio of the magnitude of the cell’s leading neglected contribution to $|\\mathbf{a}_{\\text{ref}}|$) remains strictly below a specified tolerance $\\varepsilon$.\n\nStarting only from Newtonian gravity and the definition of the quadrupole moment above, derive the tightest orientation-agnostic bound on the quadrupole acceleration contribution from the cell and determine $\\alpha$ such that the worst-case fractional error bound from any accepted single cell is $\\leq \\varepsilon$. Express your final answer for $\\alpha$ as a closed-form analytic expression in terms of $\\varepsilon$ only. No rounding is required, and $\\alpha$ is dimensionless.",
            "solution": "The Newtonian gravitational potential at field point $\\mathbf{r}$ due to a localized mass distribution with center of mass at the origin admits a multipole expansion. With the dipole term vanishing (centered at the center of mass), the potential up to quadrupole order can be written as\n$$\n\\Phi(\\mathbf{r}) = - \\frac{G M}{r} - \\frac{G}{2 r^{3}} \\, T(\\mathbf{n}) + \\mathcal{O}\\!\\left(\\frac{1}{r^{4}}\\right),\n$$\nwhere $r = |\\mathbf{r}|$, $\\mathbf{n} = \\mathbf{r}/r$, and\n$$\nT(\\mathbf{n}) \\equiv n_{i} n_{j} Q_{ij} = \\mathbf{n}^{\\mathsf{T}} Q \\, \\mathbf{n}.\n$$\nThe corresponding acceleration is $\\mathbf{a}(\\mathbf{r}) = - \\nabla \\Phi(\\mathbf{r})$, so the quadrupole contribution to the acceleration is\n$$\n\\mathbf{a}^{(2)}(\\mathbf{r}) = - \\nabla \\left( - \\frac{G}{2 r^{3}} \\, T(\\mathbf{n}) \\right) = \\nabla \\left( \\frac{G}{2 r^{3}} \\, T(\\mathbf{n}) \\right).\n$$\nTo bound $|\\mathbf{a}^{(2)}|$, separate the gradient into radial and angular parts:\n$$\n\\nabla \\left( r^{-3} T(\\mathbf{n}) \\right) = \\left( \\frac{\\partial}{\\partial r} r^{-3} \\right) T(\\mathbf{n}) \\, \\hat{\\mathbf{r}} + r^{-3} \\, \\nabla_{\\Omega} T(\\mathbf{n}),\n$$\nwhere $\\nabla_{\\Omega}$ denotes the angular gradient on the unit sphere and $\\hat{\\mathbf{r}} = \\mathbf{n}$ is the radial unit vector. The radial derivative factor is $\\partial (r^{-3})/\\partial r = -3 r^{-4}$, so the radial component is\n$$\n\\mathbf{a}^{(2)}_{\\mathrm{rad}}(\\mathbf{r}) = \\frac{G}{2} \\left( -3 r^{-4} \\right) T(\\mathbf{n}) \\, \\hat{\\mathbf{r}} = - \\frac{3 G}{2 r^{4}} \\, T(\\mathbf{n}) \\, \\hat{\\mathbf{r}}.\n$$\nThe angular component is\n$$\n\\mathbf{a}^{(2)}_{\\mathrm{tan}}(\\mathbf{r}) = \\frac{G}{2} \\, r^{-3} \\, \\nabla_{\\Omega} T(\\mathbf{n}).\n$$\nWe now seek the worst-case orientation that maximizes $|\\mathbf{a}^{(2)}|$. Note that $T(\\mathbf{n}) = \\mathbf{n}^{\\mathsf{T}} Q \\, \\mathbf{n}$ is a quadratic form on the unit sphere. Its extrema under the constraint $|\\mathbf{n}| = 1$ occur when $\\mathbf{n}$ is an eigenvector of the symmetric tensor $Q$, with values equal to the corresponding eigenvalues. At such extrema, the angular gradient $\\nabla_{\\Omega} T$ vanishes, so the quadrupole acceleration is purely radial and its magnitude is\n$$\n\\left| \\mathbf{a}^{(2)}(\\mathbf{r}) \\right| = \\frac{3 G}{2 r^{4}} \\, \\lambda_{\\max},\n$$\nwhere $\\lambda_{\\max}$ is the largest eigenvalue of $Q$.\n\nIt remains to bound $\\lambda_{\\max}$ from the geometric constraints of the cell. For a single point mass $m$ at position $\\mathbf{x}$ with $|\\mathbf{x}| = r_{x}$, the contribution to $Q$ is $m \\left( 3 \\mathbf{x} \\mathbf{x}^{\\mathsf{T}} - r_{x}^{2} I \\right)$. The maximal eigenvalue of this rank-one update occurs along the direction of $\\mathbf{x}$ and equals $2 m r_{x}^{2}$ (the perpendicular directions have eigenvalues $- m r_{x}^{2}$). Therefore, for the entire cell,\n$$\n\\lambda_{\\max} \\leq \\sum_{a} 2 m_{a} r_{a}^{2} = 2 \\sum_{a} m_{a} r_{a}^{2}.\n$$\nGiven that all masses are contained within a sphere of radius $s/2$, we have $r_{a} \\leq s/2$ for every $a$, hence\n$$\n\\sum_{a} m_{a} r_{a}^{2} \\leq \\sum_{a} m_{a} \\left( \\frac{s}{2} \\right)^{2} = M \\left( \\frac{s}{2} \\right)^{2} = \\frac{M s^{2}}{4}.\n$$\nThus,\n$$\n\\lambda_{\\max} \\leq 2 \\cdot \\frac{M s^{2}}{4} = \\frac{M s^{2}}{2}.\n$$\nThis upper bound is tight: it is attained, for example, by placing equal mass at $\\pm \\frac{s}{2}$ along a common axis through the center, which aligns all eigenvectors and saturates the sum of maximal eigenvalues.\n\nSubstituting this bound into the quadrupole acceleration magnitude yields the worst-case orientation-agnostic bound\n$$\n\\left| \\mathbf{a}^{(2)}(\\mathbf{r}) \\right| \\leq \\frac{3 G}{2 r^{4}} \\cdot \\frac{M s^{2}}{2} = \\frac{3}{4} \\, \\frac{G M s^{2}}{r^{4}}.\n$$\nThe fractional error induced by accepting the cell at monopole order, relative to the current total acceleration estimate magnitude $|\\mathbf{a}_{\\text{ref}}|$, is then bounded as\n$$\n\\frac{\\left| \\mathbf{a}^{(2)}(\\mathbf{r}) \\right|}{|\\mathbf{a}_{\\text{ref}}|} \\leq \\frac{3}{4} \\, \\frac{G M s^{2}}{r^{4} \\, |\\mathbf{a}_{\\text{ref}}|}.\n$$\nBy the acceptance test,\n$$\n\\frac{G M s^{2}}{r^{4}} \\leq \\alpha \\, |\\mathbf{a}_{\\text{ref}}|,\n$$\nso any accepted cell satisfies\n$$\n\\frac{\\left| \\mathbf{a}^{(2)}(\\mathbf{r}) \\right|}{|\\mathbf{a}_{\\text{ref}}|} \\leq \\frac{3}{4} \\, \\alpha.\n$$\nTo guarantee that this worst-case fractional error is no larger than the specified tolerance $\\varepsilon$, choose $\\alpha$ such that\n$$\n\\frac{3}{4} \\, \\alpha \\leq \\varepsilon \\quad \\Rightarrow \\quad \\alpha = \\frac{4}{3} \\, \\varepsilon,\n$$\nwhich saturates the bound and thus is the largest permissible choice consistent with the requirement. This $\\alpha$ is dimensionless and depends only on $\\varepsilon$.",
            "answer": "$$\\boxed{\\frac{4}{3}\\,\\varepsilon}$$"
        },
        {
            "introduction": "A robust algorithm must perform reliably even in worst-case scenarios. This advanced practice challenges you to design \"adversarial\" mass arrangements that maximize the quadrupole moment for a given mass $M$ and size $s$, thereby stress-testing various Multipole Acceptance Criteria (MACs). By analyzing how different MACs—from the simple Barnes-Hut criterion to sophisticated, shape-aware versions based on the inertia tensor—perform against these challenging configurations, you will gain insight into designing more accurate and efficient tree codes .",
            "id": "3480537",
            "problem": "You are given a node in a gravitational tree code that aggregates a finite set of point masses. The node is characterized by a total mass $M$ and a bounding radius $s$ such that all point masses lie within a sphere of radius $s$ centered at the node's center. The gravitational interaction is governed by Newtonian gravity, and the monopole approximation uses only the node's total mass $M$ at its center to approximate the force on a distant target. In practice, Multipole Acceptance Criteria (MACs) determine whether a node is sufficiently far from the target to be treated by an approximation instead of opening the node.\n\nStarting from the Newtonian gravitational potential and its multipole expansion, construct adversarial point-mass arrangements that cancel the dipole moment but maximize the quadrupole amplitude, and use these to stress-test MACs. Then, derive and implement shape-aware MACs informed by the inertia tensor. Proceed according to the following directives.\n\n1. Fundamental base:\n   - Use Newtonian gravity and the multipole expansion of the gravitational potential for a compact source. Consider only point masses and assume $N$ point masses $\\{m_a\\}_{a=1}^N$ at positions $\\{\\boldsymbol{x}_a\\}_{a=1}^N$ within the node, with $\\lVert \\boldsymbol{x}_a \\rVert \\le s$ for all $a$, and total mass $M = \\sum_a m_a$.\n   - Define the second mass moment (sometimes referred to as inertia moment in astrophysical N-body practice) $S_{ij} = \\sum_a m_a x_{a,i} x_{a,j}$, its trace $t = \\mathrm{tr}(S) = \\sum_a m_a \\lVert \\boldsymbol{x}_a \\rVert^2$, and the traceless quadrupole tensor $Q_{ij} = 3 S_{ij} - t \\,\\delta_{ij}$.\n   - Ensure the center of mass is at the origin, i.e., the dipole moment vanishes: $\\sum_a m_a \\boldsymbol{x}_a = \\boldsymbol{0}$.\n\n2. Adversarial arrangement design:\n   - Under the constraints of fixed $M$ and $s$, construct explicit point-mass configurations that satisfy the dipole cancellation and maximize a scalar quadrupole amplitude $Q_2$. Use the Frobenius norm of the traceless quadrupole tensor as the scalar amplitude, $Q_2 = \\lVert Q \\rVert_F = \\sqrt{\\mathrm{tr}(Q^T Q)}$.\n   - Provide at least one arrangement achieving maximal $Q_2$ and at least two non-maximal but dipole-free arrangements with differing shapes (e.g., colinear, planar, and approximately isotropic), all with the same $M$ and $s$.\n\n3. MAC stress tests:\n   - Consider a target at distance $r$ from the node center with a line-of-sight unit vector $\\hat{\\boldsymbol{n}}$ from the node to the target. Implement the following MACs:\n     - Barnes–Hut Multipole Acceptance Criterion (BH MAC): accept the node if $s/r \\le \\theta$, where $\\theta$ is a user-specified opening parameter.\n     - Shape-aware quadrupole-norm MAC: accept the node if a conservative bound on the fractional acceleration error due to the quadrupole term satisfies $\\alpha \\, Q_2 / (M r^2) \\le \\varepsilon$, where $\\varepsilon$ is a user-specified tolerance and $\\alpha$ is a constant obtained from bounding the acceleration contribution of the quadrupole.\n     - Directional shape-aware MAC using the inertia tensor: compute $q_{\\mathrm{dir}} = \\lvert \\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}} \\rvert$ and accept the node if a directional bound on the fractional acceleration error satisfies $\\beta \\, q_{\\mathrm{dir}} / (M r^2) \\le \\varepsilon$. Additionally, compute the mass-weighted variance along the sightline $\\sigma_n^2 = \\hat{\\boldsymbol{n}}^T (S/M) \\hat{\\boldsymbol{n}}$ and accept if $\\sqrt{\\sigma_n^2}/r \\le \\theta$.\n   - Your derivations must be principled and start from the potential and its gradient. Explicitly justify the constants $\\alpha$ and $\\beta$ used in these bounds from first principles.\n\n4. Required units and outputs:\n   - Work in dimensionless units with $M$ and $s$ treated as pure numbers and distances in the same unit as $s$, so no physical unit conversion is required. Angles are not required.\n   - Implement a program that constructs the adversarial arrangements, computes $S_{ij}$, $Q_{ij}$, $Q_2$, $q_{\\mathrm{dir}}$, and the MAC decisions for each test case specified below.\n   - The final output must be a single line containing a list of results for all test cases. Each test case result must be a list of four booleans in the order $[$BH\\_accept, Qnorm\\_accept, Qdir\\_accept, Sigma\\_accept$]$. The entire output must be a comma-separated list of these lists enclosed in square brackets, for example: $[[\\text{true},\\text{false},\\text{true},\\text{true}],[...],...]$. Use lowercase for booleans.\n\n5. Test suite:\n   - Use $M = 1$ and $s = 1$ for all cases. Use $\\theta = 0.5$ and $\\varepsilon = 0.3$.\n   - Provide at least six test cases to cover different facets:\n     1. A maximal-quadrupole rod-like arrangement with two equal masses at positions $\\pm s$ along the $x$-axis, target direction $\\hat{\\boldsymbol{n}}$ parallel to the rod, and $r = 3$.\n     2. The same rod-like arrangement with $\\hat{\\boldsymbol{n}}$ perpendicular to the rod (e.g., along the $y$-axis) and $r = 3$.\n     3. A planar disk-like arrangement with four equal masses at positions $(\\pm s, 0, 0)$ and $(0, \\pm s, 0)$, $\\hat{\\boldsymbol{n}}$ along the $z$-axis, and $r = 3$.\n     4. An approximately isotropic arrangement with six equal masses at positions $(\\pm s, 0, 0)$, $(0, \\pm s, 0)$, and $(0, 0, \\pm s)$, $\\hat{\\boldsymbol{n}}$ along an arbitrary axis (e.g., $x$-axis), and $r = 3$.\n     5. A boundary case for the rod-like arrangement with $\\hat{\\boldsymbol{n}}$ parallel to the rod and $r = 2$.\n     6. A far-field case for the rod-like arrangement with $\\hat{\\boldsymbol{n}}$ parallel to the rod and $r = 10$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[[true,false,true,true],[...],...]\").",
            "solution": "The problem requires the derivation and implementation of several Multipole Acceptance Criteria (MACs) used in gravitational tree codes, and an analysis of their performance on adversarially designed mass configurations. I will first derive the necessary physical and mathematical formulae, then outline the computation for the specified test cases. Throughout this analysis, we assume the gravitational constant $G=1$ as we are working in a dimensionless system.\n\n### 1. Gravitational Potential and Multipole Expansion\n\nThe Newtonian gravitational potential at a target position $\\boldsymbol{r}$ due to a collection of source masses $\\{m_a\\}$ at positions $\\{\\boldsymbol{x}_a\\}$ is:\n$$\n\\Phi(\\boldsymbol{r}) = - \\sum_a \\frac{m_a}{\\lVert \\boldsymbol{r} - \\boldsymbol{x}_a \\rVert}\n$$\nFor a distant target, where $\\lVert \\boldsymbol{x}_a \\rVert \\ll \\lVert \\boldsymbol{r} \\rVert$, we can expand the denominator. Let $r = \\lVert \\boldsymbol{r} \\rVert$ and $\\hat{\\boldsymbol{n}} = \\boldsymbol{r}/r$. The expansion to the quadrupole order is:\n$$\n\\frac{1}{\\lVert \\boldsymbol{r} - \\boldsymbol{x}_a \\rVert} \\approx \\frac{1}{r} + \\frac{\\boldsymbol{r} \\cdot \\boldsymbol{x}_a}{r^3} + \\frac{3(\\boldsymbol{r} \\cdot \\boldsymbol{x}_a)^2 - r^2 \\lVert \\boldsymbol{x}_a \\rVert^2}{2r^5}\n$$\nSubstituting this into the potential sum gives:\n$$\n\\Phi(\\boldsymbol{r}) \\approx - \\frac{1}{r}\\sum_a m_a - \\frac{1}{r^3}\\sum_a m_a (\\boldsymbol{r} \\cdot \\boldsymbol{x}_a) - \\frac{1}{2r^5}\\sum_a m_a (3(\\boldsymbol{r} \\cdot \\boldsymbol{x}_a)^2 - r^2 \\lVert \\boldsymbol{x}_a \\rVert^2)\n$$\nThese are the monopole, dipole, and quadrupole terms.\n- **Monopole Potential:** $\\Phi_M(\\boldsymbol{r}) = -\\frac{M}{r}$, where $M = \\sum_a m_a$ is the total mass.\n- **Dipole Potential:** The problem states the center of mass is at the origin, so the dipole moment $\\boldsymbol{d} = \\sum_a m_a \\boldsymbol{x}_a = \\boldsymbol{0}$. Thus, the dipole term is zero.\n- **Quadrupole Potential:** Let's rewrite this term using the defined tensors. Let $x_{a,i}$ be the components of $\\boldsymbol{x}_a$. The quadrupole term is:\n$$\n\\Phi_Q(\\boldsymbol{r}) = -\\frac{1}{2r^3} \\sum_a m_a \\left(3(\\hat{\\boldsymbol{n}} \\cdot \\boldsymbol{x}_a)^2 - \\lVert \\boldsymbol{x}_a \\rVert^2\\right) = -\\frac{1}{2r^3} \\sum_a m_a \\left(3 \\hat{n}_i x_{a,i} \\hat{n}_j x_{a,j} - \\lVert \\boldsymbol{x}_a \\rVert^2 \\hat{n}_k \\hat{n}_k \\right)\n$$\nUsing $\\hat{n}_k \\hat{n}_k = \\sum_k \\hat{n}_k^2 = 1 = \\hat{n}_i \\hat{n}_j \\delta_{ij}$:\n$$\n\\Phi_Q(\\boldsymbol{r}) = -\\frac{1}{2r^3} \\hat{n}_i \\hat{n}_j \\sum_a m_a (3 x_{a,i} x_{a,j} - \\lVert \\boldsymbol{x}_a \\rVert^2 \\delta_{ij})\n$$\nThe quantity in the sum is the traceless quadrupole tensor, $Q_{ij} = 3 S_{ij} - t \\delta_{ij}$, where $S_{ij} = \\sum_a m_a x_{a,i} x_{a,j}$ is the second mass moment tensor and $t = \\mathrm{tr}(S) = \\sum_a m_a \\lVert \\boldsymbol{x}_a \\rVert^2$.\nThus, the potential up to quadrupole order is:\n$$\n\\Phi(\\boldsymbol{r}) \\approx \\Phi_M(\\boldsymbol{r}) + \\Phi_Q(\\boldsymbol{r}) = -\\frac{M}{r} - \\frac{1}{2r^3} (\\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}})\n$$\n\n### 2. Gravitational Acceleration and Error Bounds\n\nThe gravitational acceleration is $\\boldsymbol{a} = -\\nabla\\Phi$.\n- **Monopole Acceleration:** $\\boldsymbol{a}_M = -\\nabla\\Phi_M = -\\nabla(-\\frac{M}{r}) = M\\nabla(\\frac{1}{r}) = -\\frac{M}{r^2}\\hat{\\boldsymbol{n}}$. The magnitude is $\\lVert\\boldsymbol{a}_M\\rVert = \\frac{M}{r^2}$.\n- **Quadrupole Acceleration:** $\\boldsymbol{a}_Q = -\\nabla\\Phi_Q = \\frac{1}{2}\\nabla\\left(\\frac{1}{r^3} \\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}}\\right) = \\frac{1}{2}\\nabla\\left(\\frac{\\boldsymbol{r}^T Q \\boldsymbol{r}}{r^5}\\right)$.\nThe evaluation of this gradient yields the standard result:\n$$\n\\boldsymbol{a}_Q = \\frac{1}{r^4} \\left( Q\\hat{\\boldsymbol{n}} - \\frac{5}{2}(\\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}})\\hat{\\boldsymbol{n}} \\right)\n$$\nThe acceptance criteria are based on bounding the fractional error $\\lVert \\boldsymbol{a}_Q \\rVert / \\lVert \\boldsymbol{a}_M \\rVert$.\n\n#### Derivation of Constant $\\alpha$ for the Quadrupole-Norm MAC\nThe criterion is $\\alpha \\, Q_2 / (M r^2) \\le \\varepsilon$, where $\\varepsilon$ bounds the fractional error. We need to find a conservative value for $\\alpha$ by bounding $\\lVert\\boldsymbol{a}_Q\\rVert$.\nUsing the triangle inequality on the expression for $\\boldsymbol{a}_Q$:\n$$\n\\lVert\\boldsymbol{a}_Q\\rVert \\le \\frac{1}{r^4} \\left( \\lVert Q\\hat{\\boldsymbol{n}} \\rVert + \\frac{5}{2} \\lvert \\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}} \\rvert \\right)\n$$\nFor any vector $\\hat{\\boldsymbol{n}}$ with $\\lVert\\hat{\\boldsymbol{n}}\\rVert=1$, we have $\\lVert Q\\hat{\\boldsymbol{n}} \\rVert \\le \\lVert Q \\rVert_2$ and $\\lvert \\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}} \\rvert \\le \\lVert Q \\rVert_2$, where $\\lVert Q \\rVert_2$ is the spectral norm of $Q$ (maximum absolute eigenvalue).\n$$\n\\lVert\\boldsymbol{a}_Q\\rVert \\le \\frac{1}{r^4} \\left( \\lVert Q \\rVert_2 + \\frac{5}{2} \\lVert Q \\rVert_2 \\right) = \\frac{7}{2r^4} \\lVert Q \\rVert_2\n$$\nThe spectral norm is related to the Frobenius norm $Q_2 = \\lVert Q \\rVert_F$ by $\\lVert Q \\rVert_2 \\le \\lVert Q \\rVert_F$. Thus, a looser but more convenient bound is:\n$$\n\\lVert\\boldsymbol{a}_Q\\rVert \\le \\frac{7}{2r^4} Q_2\n$$\nThe fractional error is then bounded by:\n$$\n\\frac{\\lVert\\boldsymbol{a}_Q\\rVert}{\\lVert\\boldsymbol{a}_M\\rVert} \\le \\frac{7 Q_2 / (2r^4)}{M/r^2} = \\frac{7}{2} \\frac{Q_2}{Mr^2}\n$$\nRequiring this to be less than or equal to a tolerance $\\varepsilon$ gives the MAC with $\\alpha = 7/2 = 3.5$.\n\n#### Derivation of Constant $\\beta$ for the Directional MAC\nThe criterion is $\\beta \\, q_{\\mathrm{dir}} / (M r^2) \\le \\varepsilon$, where $q_{\\mathrm{dir}} = \\lvert \\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}} \\rvert$. This criterion often focuses on the error component along the line of sight, $\\Delta a_n = \\boldsymbol{a}_Q \\cdot \\hat{\\boldsymbol{n}}$.\n$$\n\\Delta a_n = \\left(\\frac{1}{r^4} Q\\hat{\\boldsymbol{n}} - \\frac{5}{2r^4}(\\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}})\\hat{\\boldsymbol{n}}\\right) \\cdot \\hat{\\boldsymbol{n}} = \\frac{1}{r^4} (\\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}}) - \\frac{5}{2r^4} (\\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}}) (\\hat{\\boldsymbol{n}} \\cdot \\hat{\\boldsymbol{n}})\n$$\nSince $\\hat{\\boldsymbol{n}} \\cdot \\hat{\\boldsymbol{n}} = 1$:\n$$\n\\Delta a_n = -\\frac{3}{2r^4} (\\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}})\n$$\nThe fractional error in the radial acceleration component is:\n$$\n\\frac{\\lvert\\Delta a_n\\rvert}{\\lVert\\boldsymbol{a}_M\\rVert} = \\frac{\\frac{3}{2r^4} \\lvert\\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}}\\rvert}{M/r^2} = \\frac{3}{2} \\frac{q_{\\mathrm{dir}}}{Mr^2}\n$$\nRequiring this to be $\\le \\varepsilon$ gives the MAC with $\\beta = 3/2 = 1.5$.\n\n### 3. Other MACs\n\n- **Barnes-Hut (BH) MAC:** $s/r \\le \\theta$. This is a simple, shape-agnostic criterion comparing the node's bounding radius $s$ to its distance $r$.\n- **Sigma MAC:** $\\sqrt{\\sigma_n^2}/r \\le \\theta$. Here $\\sigma_n^2 = \\hat{\\boldsymbol{n}}^T (S/M) \\hat{\\boldsymbol{n}} = \\frac{1}{M}\\sum_a m_a (\\boldsymbol{x}_a \\cdot \\hat{\\boldsymbol{n}})^2$ is the mass-weighted variance of the particle positions along the line of sight $\\hat{\\boldsymbol{n}}$. This criterion refines the BH MAC by using a directional measure of size, $\\sqrt{\\sigma_n^2}$, instead of the overall isotropic size $s$. It correctly identifies that a flattened system viewed \"face-on\" appears smaller.\n\n### 4. Adversarial Mass Configurations\n\nTo maximize the quadrupole amplitude $Q_2 = \\sqrt{\\mathrm{tr}(Q^T Q)}$ for a fixed mass $M$ and bounding radius $s$, while keeping the dipole moment zero, we must arrange the masses to be as non-spherical as possible.\n$Q_2^2 = 9 \\lVert S \\rVert_F^2 - 3 t^2$. For all mass placed on the boundary sphere, $t = \\sum m_a \\lVert \\boldsymbol{x}_a \\rVert^2 = \\sum m_a s^2 = Ms^2$, which is constant and maximal. The task reduces to maximizing $\\lVert S \\rVert_F^2 = \\sum_{ij} S_{ij}^2$. This is achieved by concentrating the mass along a single axis.\nThe **rod-like arrangement** with two masses $m=M/2$ at $\\boldsymbol{x} = \\pm s\\hat{\\boldsymbol{e}}_1$ achieves this. Here, $S_{11} = M s^2$ and all other $S_{ij}=0$. This makes $S$ diagonal with eigenvalues $(Ms^2, 0, 0)$ and gives $Q_2 = \\sqrt{6}Ms^2$. Any other distribution, like the planar or quasi-isotropic ones, will distribute the second moments more evenly among the diagonal entries of $S$, reducing $\\lVert S \\rVert_F^2$ and thus $Q_2$. For instance, the specified \"isotropic\" arrangement leads to $S_{ij} = (Ms^2/3)\\delta_{ij}$, resulting in $Q=\\boldsymbol{0}$ and $Q_2 = 0$.\n\n### 5. Implementation Plan for Test Cases\n\nThe program will implement these derivations for the six specified test cases.\n- **Parameters:** $M=1$, $s=1$, $\\theta=0.5$, $\\varepsilon=0.3$.\n- **Constants:** $\\alpha=3.5$, $\\beta=1.5$.\nFor each case, we will:\n1. Define the mass positions $\\{\\boldsymbol{x}_a\\}$ and masses $\\{m_a\\}$.\n2. Compute the tensors $S_{ij} = \\sum_a m_a x_{a,i} x_{a,j}$ and $Q_{ij} = 3S_{ij} - (\\mathrm{tr}(S))\\delta_{ij}$.\n3. Compute the scalar amplitudes $Q_2 = \\sqrt{\\sum_{ij} Q_{ij}^2}$ and $q_{\\mathrm{dir}} = |\\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}}|$.\n4. Compute the directional variance $\\sigma_n^2 = \\hat{\\boldsymbol{n}}^T (S/M) \\hat{\\boldsymbol{n}}$.\n5. Evaluate the four boolean MAC conditions based on the given parameters $r$ and $\\hat{\\boldsymbol{n}}$ for the test case.\n6. Collect and format the results as specified.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem by constructing mass arrangements, computing quadrupole\n    tensors, and evaluating multiple acceptance criteria (MACs) for a set\n    of test cases.\n    \"\"\"\n    \n    # Global parameters for all test cases\n    M_global = 1.0\n    s_global = 1.0\n    theta = 0.5\n    epsilon = 0.3\n    \n    # Derived constants for MACs\n    alpha = 3.5  # 7.0 / 2.0\n    beta = 1.5   # 3.0 / 2.0\n\n    # Define test cases\n    test_cases = [\n        {\n            \"name\": \"Rod, n parallel to rod\",\n            \"masses\": [0.5, 0.5],\n            \"positions\": np.array([[1., 0., 0.], [-1., 0., 0.]]),\n            \"r\": 3.0,\n            \"n_hat\": np.array([1., 0., 0.])\n        },\n        {\n            \"name\": \"Rod, n perpendicular to rod\",\n            \"masses\": [0.5, 0.5],\n            \"positions\": np.array([[1., 0., 0.], [-1., 0., 0.]]),\n            \"r\": 3.0,\n            \"n_hat\": np.array([0., 1., 0.])\n        },\n        {\n            \"name\": \"Planar disk, n perpendicular to disk\",\n            \"masses\": [0.25, 0.25, 0.25, 0.25],\n            \"positions\": np.array([[1., 0., 0.], [-1., 0., 0.], [0., 1., 0.], [0., -1., 0.]]),\n            \"r\": 3.0,\n            \"n_hat\": np.array([0., 0., 1.])\n        },\n        {\n            \"name\": \"Isotropic, n along x-axis\",\n            \"masses\": [1./6.] * 6,\n            \"positions\": np.array([[1., 0., 0.], [-1., 0., 0.],\n                                   [0., 1., 0.], [0., -1., 0.],\n                                   [0., 0., 1.], [0., 0., -1.]]),\n            \"r\": 3.0,\n            \"n_hat\": np.array([1., 0., 0.])\n        },\n        {\n            \"name\": \"Boundary rod, n parallel\",\n            \"masses\": [0.5, 0.5],\n            \"positions\": np.array([[1., 0., 0.], [-1., 0., 0.]]),\n            \"r\": 2.0,\n            \"n_hat\": np.array([1., 0., 0.])\n        },\n        {\n            \"name\": \"Far-field rod, n parallel\",\n            \"masses\": [0.5, 0.5],\n            \"positions\": np.array([[1., 0., 0.], [-1., 0., 0.]]),\n            \"r\": 10.0,\n            \"n_hat\": np.array([1., 0., 0.])\n        },\n    ]\n\n    results = []\n\n    for case in test_cases:\n        masses = np.array(case[\"masses\"])\n        positions = case[\"positions\"]\n        r = case[\"r\"]\n        n_hat = case[\"n_hat\"]\n\n        # 1. Compute Tensors S and Q\n        S = np.zeros((3, 3))\n        for m, pos in zip(masses, positions):\n            S += m * np.outer(pos, pos)\n        \n        t = np.trace(S)\n        Q = 3 * S - t * np.identity(3)\n\n        # 2. Compute scalar amplitudes\n        # Frobenius norm of Q\n        Q2 = np.sqrt(np.sum(Q**2))\n        \n        # Directional quadrupole amplitude\n        q_dir = np.abs(n_hat.T @ Q @ n_hat)\n        \n        # Mass-weighted variance along line of sight\n        sigma_n_sq = n_hat.T @ (S / M_global) @ n_hat\n        \n        # 3. Evaluate MACs\n        \n        # BH MAC: s/r <= theta\n        bh_accept = (s_global / r) <= theta\n\n        # Quadrupole-norm MAC: alpha * Q2 / (M*r^2) <= epsilon\n        qnorm_accept = (alpha * Q2 / (M_global * r**2)) <= epsilon\n        \n        # Directional shape-aware MAC: beta * q_dir / (M*r^2) <= epsilon\n        qdir_accept = (beta * q_dir / (M_global * r**2)) <= epsilon\n        \n        # Sigma MAC: sqrt(sigma_n^2)/r <= theta\n        # Handle sigma_n_sq being slightly negative due to float precision\n        sigma_n_sq = max(0, sigma_n_sq)\n        sigma_accept = (np.sqrt(sigma_n_sq) / r) <= theta\n\n        results.append([\n            \"true\" if bh_accept else \"false\",\n            \"true\" if qnorm_accept else \"false\",\n            \"true\" if qdir_accept else \"false\",\n            \"true\" if sigma_accept else \"false\",\n        ])\n\n    # Format the final output string\n    output_str = \"[\" + \",\".join([f\"[{','.join(res)}]\" for res in results]) + \"]\"\n    print(output_str)\n\nsolve()\n```"
        }
    ]
}