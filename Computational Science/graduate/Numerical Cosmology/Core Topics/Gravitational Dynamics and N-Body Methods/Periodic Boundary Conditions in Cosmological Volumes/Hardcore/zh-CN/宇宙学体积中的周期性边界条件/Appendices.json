{
    "hands_on_practices": [
        {
            "introduction": "宇宙学模拟的起点是设定初始条件。这些初始条件代表了早期宇宙中微小的密度涨落，而这些涨落能够被高斯随机场很好地描述。本练习将指导你完成在离散周期性网格上创建这样一个场的关键过程，确保它具有正确的统计属性（由功率谱定义）和物理实在性（通过满足厄米对称性实现）。这是构建任何现代N体宇宙学模拟的第一块基石。",
            "id": "3481574",
            "problem": "你的任务是实现一个完整、可运行的程序，用于在具有周期性边界条件（PBC）的离散立方网格上生成统计上一致的宇宙学初始条件。其目标是采样一个具有指定各向同性功率谱的高斯随机场，并显式地构建满足实空间场所需的厄米对称性条件的傅里叶空间振幅。你的程序必须验证相位统计以及实空间过密度场的实数条件。\n\n从以下基本原理开始：\n- 边长为 $L$ 且具有周期性边界条件的有限立方体积意味着离散的波矢量 $\\mathbf{k} = \\frac{2\\pi}{L} \\mathbf{m}$，其中 $\\mathbf{m} = (m_x,m_y,m_z)$，每个分量 $m_i$ 是在范围 $m_i \\in \\{0,1,\\dots,N-1\\}$ 内对 $N$ 取模的整数，其中 $N$ 是每个维度的网格点数。\n- 与快速傅里叶变换（FFT）约定一致的离散傅里叶变换（DFT）对在整数网格位置 $\\mathbf{r} \\in \\{0,1,\\dots,N-1\\}^3$ 上定义为\n$$\n\\delta_{\\mathbf{r}} = \\frac{1}{N^3} \\sum_{\\mathbf{m}} a_{\\mathbf{m}} \\exp\\left(i \\frac{2\\pi}{N} \\mathbf{r}\\cdot \\mathbf{m}\\right),\n$$\n$$\na_{\\mathbf{m}} = \\sum_{\\mathbf{r}} \\delta_{\\mathbf{r}} \\exp\\left(-i \\frac{2\\pi}{N} \\mathbf{r}\\cdot \\mathbf{m}\\right),\n$$\n其中 $a_{\\mathbf{m}}$ 是离散傅里叶空间振幅，$\\delta_{\\mathbf{r}}$ 是在网格上采样的实空间过密度场。\n- 对于统计均匀且各向同性的高斯随机场，功率谱 $P(k)$ 定义为\n$$\n\\langle \\hat{\\delta}(\\mathbf{k}) \\hat{\\delta}^*(\\mathbf{k}') \\rangle = (2\\pi)^3 \\delta_{\\mathrm{D}}(\\mathbf{k}-\\mathbf{k}') P(k),\n$$\n其中 $\\hat{\\delta}(\\mathbf{k})$ 是 $\\delta(\\mathbf{x})$ 的连续傅里叶变换，$\\delta_{\\mathrm{D}}$ 是狄拉克δ函数。在有限的周期性体积 $V=L^3$ 中，离散傅里叶振幅满足\n$$\n\\langle |a_{\\mathbf{m}}|^2 \\rangle = V P(k).\n$$\n- 对于实值过密度场 $\\delta(\\mathbf{x})$，傅里叶振幅必须遵守厄米对称性条件\n$$\na_{\\mathbf{m}_*} = a_{\\mathbf{m}}^*, \\quad \\text{其中} \\quad \\mathbf{m}_* \\equiv (-m_x \\bmod N,\\,-m_y \\bmod N,\\,-m_z \\bmod N).\n$$\n在映射 $\\mathbf{m} \\mapsto \\mathbf{m}_*$ 下映射到自身的模式是自共轭的，并且必须具有纯实数振幅。\n\n你的程序必须：\n1. 构建离散波矢量网格并实现各向同性功率谱\n$$\nP(k) = A \\left(\\frac{k}{k_0}\\right)^n \\exp\\left[-\\left(\\frac{k}{k_c}\\right)^2\\right],\n$$\n其中振幅为 $A$，谱指数为 $n$，枢轴波数为 $k_0$，截止波数为 $k_c$。所有波数 $k$ 必须以 $h/\\mathrm{Mpc}$ 为单位表示，体积以 $(\\mathrm{Mpc}/h)^3$ 为单位表示。过密度 $\\delta(\\mathbf{x})$ 是无量纲的。\n2. 从零均值的复高斯分布中采样离散傅里叶振幅 $a_{\\mathbf{m}}$，其方差由上述关系和 FFT 归一化推导得出。使用给定的 FFT 约定，并推导所需的方差 $\\mathrm{Var}(a_{\\mathbf{m}})$，使得实空间方差与对 $P(k)$ 的离散求和一致。确保厄米对称性约束 $a_{\\mathbf{m}_*} = a_{\\mathbf{m}}^*$ 被精确满足，并强制将 $\\mathbf{k}=\\mathbf{0}$ 处的零模式设置为零，以使 $\\delta$ 的均值为零。\n3. 通过逆 FFT 计算实空间场 $\\delta_{\\mathbf{r}}$ 并测试：\n   - 实数条件：对于所有网格点，$\\delta_{\\mathbf{r}} \\in \\mathbb{R}$（在数值精度范围内）。报告整个网格上的最大绝对虚部是否低于 $10^{-10}$ 的容差。\n   - 相位统计：对于傅里叶空间基本半空间中的非自共轭模式集合，以弧度为单位计算相位 $\\theta_{\\mathbf{m}} = \\arg(a_{\\mathbf{m}})$，并测量瑞利平均合矢量长度\n   $$\n   R = \\left| \\frac{1}{M} \\sum_{j=1}^{M} e^{i \\theta_j} \\right|,\n   $$\n   其中 $M$ 是包含的模式数量。接近 $0$ 的 $R$ 值表示相位接近独立且均匀分布。\n   - 厄米对称性精度：计算最大绝对偏差\n   $$\n   \\epsilon_{\\mathrm{H}} = \\max_{\\mathbf{m}} \\left| a_{\\mathbf{m}_*} - a_{\\mathbf{m}}^* \\right|.\n   $$\n   - 方差一致性：计算实空间 $\\delta_{\\mathbf{r}}$ 的经验方差 $\\sigma^2_{\\mathrm{emp}}$ 和理论目标方差\n   $$\n   \\sigma^2_{\\mathrm{th}} = \\frac{1}{V} \\sum_{\\mathbf{m}} P\\left( \\left\\|\\mathbf{k}_{\\mathbf{m}}\\right\\| \\right),\n   $$\n   并报告相对误差 $\\left| \\sigma^2_{\\mathrm{emp}} - \\sigma^2_{\\mathrm{th}} \\right| / \\sigma^2_{\\mathrm{th}}$。\n   - 傅里叶幅值的周期性和平移不变性：对实空间场应用一个以网格单位表示的整数矢量 $\\mathbf{s}$ 进行循环位移，并验证傅里叶幅值是不变的，即 $|a_{\\mathbf{m}}|$ 保持不变。通过幅值的相对 $\\ell_2$ 差异来量化此特性。\n\n角度必须以弧度处理。所有物理长度必须以 $\\mathrm{Mpc}/h$ 为单位处理，波数以 $h/\\mathrm{Mpc}$ 为单位处理。过密度 $\\delta$ 是无量纲的；功率谱 $P(k)$ 的单位是 $(\\mathrm{Mpc}/h)^3$。\n\n使用以下参数值测试套件，这些值必须硬编码在你的程序中并按顺序执行：\n\n- 测试用例 1（一般情况）：\n  - $N = 16$，\n  - $L = 200.0$ $\\mathrm{Mpc}/h$，\n  - $A = 2.0 \\times 10^3$ $(\\mathrm{Mpc}/h)^3$，\n  - $n = -2.0$，\n  - $k_0 = 1.0$ $h/\\mathrm{Mpc}$，\n  - $k_c = 0.25$ $h/\\mathrm{Mpc}$，\n  - 随机种子 $42$，\n  - 位移矢量 $\\mathbf{s} = (1,2,3)$。\n- 测试用例 2（由于 N 为偶数而存在许多自共轭平面的边缘情况）：\n  - $N = 8$，\n  - $L = 50.0$ $\\mathrm{Mpc}/h$，\n  - $A = 5.0 \\times 10^2$ $(\\mathrm{Mpc}/h)^3$，\n  - $n = 0.0$，\n  - $k_0 = 1.0$ $h/\\mathrm{Mpc}$，\n  - $k_c = 0.8$ $h/\\mathrm{Mpc}$，\n  - 随机种子 $123$，\n  - 位移矢量 $\\mathbf{s} = (1,2,3)$。\n- 测试用例 3（不同的谱指数和截止值，强调平移不变性检查）：\n  - $N = 12$，\n  - $L = 120.0$ $\\mathrm{Mpc}/h$，\n  - $A = 1.0 \\times 10^3$ $(\\mathrm{Mpc}/h)^3$，\n  - $n = -1.5$，\n  - $k_0 = 1.0$ $h/\\mathrm{Mpc}$，\n  - $k_c = 0.4$ $h/\\mathrm{Mpc}$，\n  - 随机种子 $2024$，\n  - 位移矢量 $\\mathbf{s} = (1,2,3)$。\n\n对于每个测试用例，你的程序必须计算并返回一个列表，其中包含：\n- 一个布尔值，指示 $\\delta_{\\mathbf{r}}$ 的最大虚部绝对值是否低于 $10^{-10}$，\n- 一个浮点数，值为 $\\epsilon_{\\mathrm{H}}$，\n- 一个浮点数，值为所选傅里叶空间基本半空间中相位的 $R$ 值，\n- 一个浮点数，值为方差相对误差，\n- 一个浮点数，值为循环位移前后傅里叶幅值的相对 $\\ell_2$ 差异。\n\n你的程序应产生单行输出，其中包含用逗号分隔的列表结果，并用方括号括起来，每个测试用例一个子列表，例如\n$$\n[\\,[\\mathrm{True},\\,0.0,\\,R_1,\\,E_1,\\,S_1],\\,[\\mathrm{True},\\,0.0,\\,R_2,\\,E_2,\\,S_2],\\,[\\mathrm{True},\\,0.0,\\,R_3,\\,E_3,\\,S_3]\\,].\n$$\n不允许有其他输出。",
            "solution": "用户的要求是创建一个程序，根据指定的功率谱和统计特性，在离散网格上生成宇宙学初始条件。该问题定义明确、科学上合理，并构成了数值宇宙学中的一个标准练习。因此被认为是有效的。解决方案涉及在傅里叶空间中构建一个高斯随机场，该场满足位形空间中实值场所需的必要厄米对称性，随后进行一系列验证测试。\n\n### 基于原理的设计\n\n任务的核心是在一个大小为 $N \\times N \\times N$ 的立方网格上生成离散傅里叶振幅 $a_{\\mathbf{m}}$，这些振幅经过逆傅里叶变换后，将产生一个具有所需统计特性的实值过密度场 $\\delta_{\\mathbf{r}}$。\n\n#### 1. 傅里叶空间设置\n\n边长为 L、具有周期性边界条件的有限立方体积自然地离散化了傅里叶空间。波矢量 $\\mathbf{k}$ 被限制在一个网格上：\n$$\n\\mathbf{k}_{\\mathbf{m}} = \\frac{2\\pi}{L} \\mathbf{m}\n$$\n其中 $\\mathbf{m} = (m_x, m_y, m_z)$ 是一个整数矢量。为了与快速傅里叶变换 (FFT) 算法兼容，这些整数矢量通常选择在与 `fftfreq` 函数输出的数组索引相对应的范围内。对于长度为 N 的轴，整数模式为 $m_i \\in \\{0, 1, \\dots, N/2-1, -N/2, \\dots, -1\\}$ (对于偶数 N)。我们构建这些波矢量的三维网格，并计算它们的模 $\\|\\mathbf{k}_{\\mathbf{m}}\\|$，这对于各向同性功率谱是必需的。\n\n#### 2. 功率谱和振幅方差\n\n场的统计特性被编码在功率谱 $P(k)$ 中。对于统计均匀且各向同性的高斯随机场，不同波矢量处的傅里叶振幅是独立的随机变量。这些振幅的方差与功率谱相关。问题提供了特定的 DFT 归一化约定：\n$$\n\\delta_{\\mathbf{r}} = \\frac{1}{N^3} \\sum_{\\mathbf{m}} a_{\\mathbf{m}} \\exp\\left(i \\frac{2\\pi}{N} \\mathbf{r}\\cdot \\mathbf{m}\\right) \\quad \\text{和} \\quad a_{\\mathbf{m}} = \\sum_{\\mathbf{r}} \\delta_{\\mathbf{r}} \\exp\\left(-i \\frac{2\\pi}{N} \\mathbf{r}\\cdot \\mathbf{m}\\right)\n$$\n将此离散表示与连续场定义 $\\langle |\\hat{\\delta}(\\mathbf{k})|^2 \\rangle = V P(k)$ 连接起来，得出离散振幅 $a_{\\mathbf{m}}$ 的期望方差：\n$$\n\\langle |a_{\\mathbf{m}}|^2 \\rangle = \\frac{N^6}{V} P(k_{\\mathbf{m}}) = \\frac{N^6}{L^3} P(k_{\\mathbf{m}})\n$$\n其中 $k_{\\mathbf{m}} = \\|\\mathbf{k}_{\\mathbf{m}}\\|$。问题指定了 $P(k)$ 的函数形式：\n$$\nP(k) = A \\left(\\frac{k}{k_0}\\right)^n \\exp\\left[-\\left(\\frac{k}{k_c}\\right)^2\\right]\n$$\n请注意，对于 $k=0$（直流模式），过密度场的均值为零，这意味着 $a_{\\mathbf{0}}=0$。相应地，我们设置 $P(0)=0$ 以避免 $n0$ 时的发散。\n\n#### 3. 厄米对称性与振幅生成\n\n为了使实空间场 $\\delta_{\\mathbf{r}}$ 为纯实数，其傅里叶变换必须是厄米共轭的，即 $a_{\\mathbf{m}^*} = a_{\\mathbf{m}}^*$，其中 $\\mathbf{m}^* = -\\mathbf{m} \\pmod N$。这个约束决定了振幅的生成过程：\n1.  **非自共轭模式**：大多数模式 $\\mathbf{m}$ 与其共轭 $\\mathbf{m}^* \\neq \\mathbf{m}$ 形成对。对于每个这样的对，我们生成一个复振幅，例如 $a_{\\mathbf{m}}$，并确定性地设置另一个，$a_{\\mathbf{m}^*} = a_{\\mathbf{m}}^*$。振幅 $a_{\\mathbf{m}} = x+iy$ 从复高斯分布中抽取，意味着其实部 ($x$) 和虚部 ($y$) 是从独立的实高斯分布中抽取的。总方差为 $\\langle |a_{\\mathbf{m}}|^2 \\rangle = \\langle x^2 \\rangle + \\langle y^2 \\rangle$。我们设置 $\\langle x^2 \\rangle = \\langle y^2 \\rangle = \\frac{1}{2}\\langle |a_{\\mathbf{m}}|^2 \\rangle$。\n2.  **自共轭模式**：一些模式满足 $\\mathbf{m}^* = \\mathbf{m}$。厄米条件要求 $a_{\\mathbf{m}} = a_{\\mathbf{m}}^*$，意味着 $a_{\\mathbf{m}}$ 必须是纯实数。这些振幅是从方差为 $\\langle a_{\\mathbf{m}}^2 \\rangle = \\langle |a_{\\mathbf{m}}|^2 \\rangle$ 的实高斯分布中抽取的。\n\n采用显式循环算法来构建严格遵守此对称性的网格 `a_m`。我们遍历所有网格索引，每个模式或模式对只处理一次，以确保底层随机数的独立性。\n\n#### 4. 实空间场与验证\n\n构建了完整的傅里叶振幅网格 $a_{\\mathbf{m}}$ 后，通过逆 FFT 获得实空间场 $\\delta_{\\mathbf{r}}$。所选的 DFT 约定与标准数值库（例如 NumPy 的 `ifftn`）的约定相匹配，从而简化了实现。\n$$\n\\delta_{\\mathbf{r}} = \\texttt{ifftn}(a_{\\mathbf{m}})\n$$\n生成的场和中间振幅随后将按照问题中的规定进行五项验证测试：\n1.  **实数性**：计算 $\\delta_{\\mathbf{r}}$ 的最大绝对虚部，并与一个小的容差进行比较。\n2.  **厄米对称性**：将构建的网格 $a_{\\mathbf{m}}$ 与其数值生成的厄米共轭直接进行比较，达到机器精度。\n3.  **相位统计**：收集非自共轭模式的生成振幅的相位。计算瑞利平均合矢量长度 $R$，以检查它们是否如高斯随机场所预期的那样呈均匀分布。\n4.  **方差一致性**：将生成的实空间场 $\\delta_{\\mathbf{r}}$ 的经验方差与理论方差进行比较，后者通过对所有离散模式上的功率谱求和来计算：$\\sigma^2_{\\mathrm{th}} = \\frac{1}{V} \\sum_{\\mathbf{m}} P(k_{\\mathbf{m}})$。\n5.  **平移不变性**：对实空间场进行循环位移。根据傅里叶位移定理，这应该只在傅里叶振幅中引入相移，而使其模保持不变。位移前后模的差异的相对 $\\ell_2$ 范数量化了此属性。\n\n这一全面的过程确保了生成统计上正确的场，并验证了实现遵循了傅里叶分析和随机场理论的基本原理。",
            "answer": "```python\nimport numpy as np\n\ndef generate_initial_conditions(N, L, A, n, k0, kc, seed, s_vec):\n    \"\"\"\n    为单个测试用例生成并验证宇宙学初始条件。\n    \"\"\"\n    # 使用给定的种子初始化随机数生成器。\n    rng = np.random.default_rng(seed)\n\n    # 1. 构建波矢量网格\n    m_vals = np.fft.fftfreq(N) * N\n    k_vals = (2.0 * np.pi / L) * m_vals\n    kx, ky, kz = np.meshgrid(k_vals, k_vals, k_vals, indexing='ij')\n    k_mag = np.sqrt(kx**2 + ky**2 + kz**2)\n\n    # 2. 在网格上定义和评估功率谱 P(k)\n    def power_spectrum(k, A_p, n_p, k0_p, kc_p):\n        if k == 0.0:\n            return 0.0\n        return A_p * (k / k0_p)**n_p * np.exp(-(k / kc_p)**2)\n\n    pk_grid = np.vectorize(power_spectrum)(k_mag, A, n, k0, kc)\n\n    # 3. 采样具有厄米对称性的傅里叶振幅 a_m\n    a_m = np.zeros((N, N, N), dtype=np.complex128)\n    visited = np.zeros((N, N, N), dtype=bool)\n    non_sc_phases = []\n\n    # 推导的振幅方差\n    var_a_grid = (N**6 / L**3) * pk_grid\n\n    for ix in range(N):\n        for iy in range(N):\n            for iz in range(N):\n                if visited[ix, iy, iz]:\n                    continue\n\n                # 共轭索引\n                ix_c = (N - ix) % N\n                iy_c = (N - iy) % N\n                iz_c = (N - iz) % N\n\n                is_sc = (ix == ix_c and iy == iy_c and iz == iz_c)\n                var_a = var_a_grid[ix, iy, iz]\n\n                if is_sc:\n                    # 自共轭模式：纯实数振幅\n                    std_dev = np.sqrt(var_a)\n                    a_m[ix, iy, iz] = rng.normal(scale=std_dev)\n                else:\n                    # 非自共轭模式：复振幅\n                    std_dev = np.sqrt(0.5 * var_a)\n                    real_part = rng.normal(scale=std_dev)\n                    imag_part = rng.normal(scale=std_dev)\n                    rand_val = real_part + 1j * imag_part\n                    a_m[ix, iy, iz] = rand_val\n                    a_m[ix_c, iy_c, iz_c] = np.conj(rand_val)\n                    non_sc_phases.append(np.angle(rand_val))\n\n                visited[ix, iy, iz] = True\n                visited[ix_c, iy_c, iz_c] = True\n\n    # 4. 强制零模式为零\n    a_m[0, 0, 0] = 0.0\n\n    # 5. 通过逆FFT计算实空间场\n    delta_r = np.fft.ifftn(a_m)\n\n    # 6. 验证测试\n    # 测试1: 实数条件\n    max_imag_part = np.max(np.abs(np.imag(delta_r)))\n    is_real = max_imag_part  1e-10\n\n    # 测试2: 厄米对称性精度\n    m_indices = np.indices((N, N, N))\n    m_conj_indices = (-m_indices) % N\n    a_m_conj_check = np.conj(a_m[m_conj_indices[0], m_conj_indices[1], m_conj_indices[2]])\n    epsilon_H = np.max(np.abs(a_m - a_m_conj_check))\n\n    # 测试3: 相位统计\n    R = np.abs(np.mean(np.exp(1j * np.array(non_sc_phases)))) if non_sc_phases else 0.0\n\n    # 测试4: 方差一致性\n    sigma_emp_sq = np.var(delta_r.real)\n    sigma_th_sq = np.sum(pk_grid) / (L**3)\n    var_rel_error = np.abs(sigma_emp_sq - sigma_th_sq) / sigma_th_sq if sigma_th_sq > 0 else 0.0\n\n    # 测试5: 傅里叶幅值的平移不变性\n    delta_r_shifted = np.roll(delta_r, shift=s_vec, axis=(0, 1, 2))\n    a_m_shifted = np.fft.fftn(delta_r_shifted)\n    \n    a_m_norm = np.linalg.norm(np.abs(a_m))\n    if a_m_norm > 1e-15:\n        shift_diff = np.linalg.norm(np.abs(a_m) - np.abs(a_m_shifted)) / a_m_norm\n    else:\n        shift_diff = 0.0\n\n    return [is_real, epsilon_H, R, var_rel_error, shift_diff]\n\ndef solve():\n    test_cases = [\n        # (N, L, A, n, k0, kc, seed, s_vec)\n        (16, 200.0, 2.0e3, -2.0, 1.0, 0.25, 42, (1, 2, 3)),\n        (8, 50.0, 5.0e2, 0.0, 1.0, 0.8, 123, (1, 2, 3)),\n        (12, 120.0, 1.0e3, -1.5, 1.0, 0.4, 2024, (1, 2, 3)),\n    ]\n\n    results = []\n    for params in test_cases:\n        result = generate_initial_conditions(*params)\n        results.append(result)\n    \n    # Format the output string as requested.\n    # e.g., [[True, 0.0, 0.01, ...], [True, 0.0, ...]]\n    list_of_strings = []\n    for res in results:\n        # Format boolean as lowercase 'true' if needed by a system, but Python's bool is standard.\n        res_str = f\"[{res[0]}, {res[1]}, {res[2]}, {res[3]}, {res[4]}]\"\n        list_of_strings.append(res_str)\n\n    print(f\"[{','.join(list_of_strings)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "一旦我们有了密度场，下一步就是计算它产生的引力势。这由泊松方程控制，它是连接物质分布和引力的基本纽带。本练习专注于使用一种高效的光谱方法（基于快速傅里叶变换）在周期性体积中求解该方程。通过与已知的解析解进行比较来校准数值求解器，这是验证任何科学代码准确性的关键步骤。",
            "id": "3481629",
            "problem": "您的任务是通过与单模密度扰动的解析解进行比较，来校准一个用于具有周期性边界条件的宇宙学体积的谱方法泊松求解器。在一个边长为 $L$、包含 $N \\times N \\times N$ 个均匀网格点的立方周期性区域中进行计算。为此校准，将所有量视为无量纲量，即不需要物理单位。角度必须以弧度表示。\n\n基本原理：在共动坐标系中，关于微扰引力势 $\\,\\phi(\\mathbf{x})\\,$ 的宇宙学泊松方程为\n$$\n\\nabla^2 \\phi(\\mathbf{x}) = S\\,\\delta(\\mathbf{x}),\n$$\n其中 $\\,\\delta(\\mathbf{x})\\,$ 是密度衬度，$\\,S\\,$ 是一个常数，在物理单位中其与 $\\,4\\pi G a^2 \\bar{\\rho}\\,$ 成正比。在本问题中，将 $\\,S\\,$ 视为一个给定的无量纲常数。该区域在所有面上均遵循周期性边界条件。\n\n校准目标：对于单个平面波密度衬度\n$$\n\\delta(\\mathbf{x}) = A \\cos\\!\\left(\\mathbf{k}\\cdot\\mathbf{x} + \\varphi\\right),\n$$\n其中 $\\,\\mathbf{k} = \\frac{2\\pi}{L}(m_x, m_y, m_z)\\,$ 且 $\\, (m_x,m_y,m_z)\\,$ 为整数三元组，在周期性盒子中求解泊松方程得到的解析微扰引力势 $\\,\\phi_{\\mathrm{ana}}(\\mathbf{x})\\,$ 是一个具有相同相位和波矢的余弦函数，其振幅按 $\\,S/|\\mathbf{k}|^2\\,$ 缩放。但当 $\\,\\mathbf{k}=\\mathbf{0}\\,$（零模式）时除外，此时物理上一致的周期解为 $\\,\\phi_{\\mathrm{ana}}(\\mathbf{x})=0\\,$。\n\n您的程序必须：\n- 为每个测试案例在网格上构建密度衬度 $\\,\\delta(\\mathbf{x})\\,$。\n- 使用基于快速傅里叶变换 (FFT) 的谱方法，在周期性边界条件下求解泊松方程，并注意根据周期性宇宙学约定来一致地处理零模式（即平均密度不产生引力势）。\n- 为同一模式构建解析势 $\\,\\phi_{\\mathrm{ana}}(\\mathbf{x})\\,$。\n- 按如下方式计算校准误差：\n  - 对于非零的 $\\,\\mathbf{k}\\,$：分数 $L^2$ 误差\n    $$\n    \\epsilon = \\frac{\\left\\|\\phi_{\\mathrm{num}} - \\phi_{\\mathrm{ana}}\\right\\|_2}{\\left\\|\\phi_{\\mathrm{ana}}\\right\\|_2},\n    $$\n    其中 $\\,\\|\\cdot\\|_2\\,$ 表示所有网格点上的欧几里得范数。\n  - 对于零模式情况 $\\,\\mathbf{k} = \\mathbf{0}\\,$：由于此时处处有 $\\,\\phi_{\\mathrm{ana}}(\\mathbf{x})=0\\,$，定义误差为\n    $$\n    \\epsilon = \\sqrt{\\frac{1}{N^3}\\sum_{i} \\left(\\phi_{\\mathrm{num},i}\\right)^2},\n    $$\n    即数值计算出的势的均方根。\n\n测试套件：\n请为以下四个测试案例提供结果。在每个案例中，$\\,N\\,$ 是偶数，$\\,L\\,$ 是盒子尺寸，$\\,A\\,$ 是余弦振幅，$\\,\\varphi\\,$ 是以弧度为单位的相位，$\\,S\\,$ 是上述泊松方程中的源常数。整数三元组 $\\, (m_x,m_y,m_z)\\,$ 定义了单模波矢。\n\n- 案例 1：$\\,N=64\\,$, $\\,L=1.0\\,$, $\\,A=10^{-2}\\,$, $\\,\\varphi=0.3\\,$, $\\,S=1.0\\,$, $\\, (m_x,m_y,m_z)=(3,0,0)\\,$。\n- 案例 2：$\\,N=48\\,$, $\\,L=1.0\\,$, $\\,A=2\\times 10^{-2}\\,$, $\\,\\varphi=1.1\\,$, $\\,S=1.0\\,$, $\\, (m_x,m_y,m_z)=(2,3,5)\\,$。\n- 案例 3：$\\,N=32\\,$, $\\,L=1.0\\,$, $\\,A=10^{-3}\\,$, $\\,\\varphi=0.0\\,$, $\\,S=1.0\\,$, $\\, (m_x,m_y,m_z)=(15,0,0)\\,$。此模式接近 $\\,N=32\\,$ 时的奈奎斯特波数。\n- 案例 4：$\\,N=40\\,$, $\\,L=1.0\\,$, $\\,A=0.5\\,$, $\\,\\varphi=0.7\\,$, $\\,S=1.0\\,$, $\\, (m_x,m_y,m_z)=(0,0,0)\\,$。这是零模式（恒定密度衬度）的边界情况。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含上述测试案例的四个校准误差，按顺序排列，格式为用方括号括起来的逗号分隔列表，例如 $\\,\\left[\\epsilon_1,\\epsilon_2,\\epsilon_3,\\epsilon_4\\right]\\,$。每个 $\\,\\epsilon_i\\,$ 都必须是浮点数。",
            "solution": "该问题要求验证一个用于周期性宇宙学体积的谱方法泊松求解器。这通过将数值解与已知的单平面波密度扰动的解析解进行比较来实现。该问题定义明确，科学上合理，并为完整的数值实现提供了所有必要的参数。\n\n控制方程是共动坐标系下的宇宙学泊松方程：\n$$\n\\nabla^2 \\phi(\\mathbf{x}) = S\\,\\delta(\\mathbf{x})\n$$\n其中 $\\phi(\\mathbf{x})$ 是微扰引力势，$\\delta(\\mathbf{x})$ 是密度衬度，$S$ 是一个给定的常数。计算区域是一个边长为 $L$、具有周期性边界条件的立方盒子。\n\n数值解的核心是谱方法，该方法利用了傅里叶变换的性质。其关键思想在于，微分算子 $\\nabla^2$ 在傅里叶空间中变成了代数乘法。令 $\\hat{f}(\\mathbf{k}) = \\mathcal{F}[f(\\mathbf{x})]$ 表示函数 $f(\\mathbf{x})$ 的傅里叶变换。傅里叶变换的微分性质表明 $\\mathcal{F}[\\nabla^2 f(\\mathbf{x})] = -|\\mathbf{k}|^2 \\hat{f}(\\mathbf{k})$，其中 $\\mathbf{k}$ 是波矢。\n\n对泊松方程应用傅里叶变换可得：\n$$\n-|\\mathbf{k}|^2 \\hat{\\phi}(\\mathbf{k}) = S \\hat{\\delta}(\\mathbf{k})\n$$\n这个代数方程可以求解出引力势的傅里叶模式 $\\hat{\\phi}(\\mathbf{k})$：\n$$\n\\hat{\\phi}(\\mathbf{k}) = -S \\frac{\\hat{\\delta}(\\mathbf{k})}{|\\mathbf{k}|^2}\n$$\n然后通过应用傅里叶逆变换来恢复实空间中的引力势 $\\phi(\\mathbf{x})$：\n$$\n\\phi(\\mathbf{x}) = \\mathcal{F}^{-1}[\\hat{\\phi}(\\mathbf{k})]\n$$\n\n对于零频模式 $\\mathbf{k}=\\mathbf{0}$（也称为直流分量），会出现一个特殊情况。对于此模式， $|\\mathbf{k}|^2 = 0$，除法无定义。在宇宙学中，宇宙的平均密度（对应于 $\\mathbf{k}=\\mathbf{0}$）被视为背景密度，它驱动着由 Friedmann 方程描述的整体宇宙膨胀。微扰引力势 $\\phi$ 仅由偏离平均值的密度*涨落*或*衬度*引起。因此，平均密度衬度 $\\hat{\\delta}(\\mathbf{k}=\\mathbf{0})$ 不会产生微扰引力势。这个物理约束是通过设置 $\\hat{\\phi}(\\mathbf{k}=\\mathbf{0})=0$ 来施加的。\n\n数值解的算法如下：\n1.  **网格生成**：定义一个跨越边长为 $L$ 的盒子的均匀 $N \\times N \\times N$ 坐标网格 $\\mathbf{x}$。给定轴的坐标范围从 $0$ 到 $L(N-1)/N$。\n2.  **密度场构建**：在实空间网格上计算给定的单模密度衬度 $\\delta(\\mathbf{x}) = A \\cos(\\mathbf{k}_{\\text{mode}} \\cdot\\mathbf{x} + \\varphi)$。波矢由 $\\mathbf{k}_{\\text{mode}} = \\frac{2\\pi}{L}(m_x, m_y, m_z)$ 给出。\n3.  **傅里叶正变换**：使用快速傅里叶变换 (FFT) 算法计算密度场的傅里叶表示 $\\hat{\\delta}(\\mathbf{k})$。\n4.  **傅里叶空间求解**：a. 构建与离散傅里叶变换频率相对应的波矢网格 $\\mathbf{k}$。b. 计算傅里叶网格上每个波矢的模平方 $|\\mathbf{k}|^2$。c. 计算引力势的傅里叶模式 $\\hat{\\phi}(\\mathbf{k}) = -S \\hat{\\delta}(\\mathbf{k}) / |\\mathbf{k}|^2$。d. 显式地将零频模式设置为零：$\\hat{\\phi}(\\mathbf{k}=\\mathbf{0}) = 0$。\n5.  **傅里叶逆变换**：通过对 $\\hat{\\phi}(\\mathbf{k})$ 应用傅里叶逆变换 (iFFT)，计算实空间中的数值势 $\\phi_{\\mathrm{num}}(\\mathbf{x})$。iFFT 的结果将是一个复数值数组，但由于输入场是实数且操作保持共轭性，虚部将在机器精度范围内为零，应予以舍弃。\n\n然后将数值解 $\\phi_{\\mathrm{num}}$ 与解析解 $\\phi_{\\mathrm{ana}}$ 进行比较。\n对于单平面波密度衬度，将 $\\nabla^2$ 作用于 $\\cos(\\mathbf{k}\\cdot\\mathbf{x}+\\varphi)$ 会得到 $-|\\mathbf{k}|^2\\cos(\\mathbf{k}\\cdot\\mathbf{x}+\\varphi)$。因此，$\\nabla^2 \\phi = S A \\cos(\\mathbf{k}\\cdot\\mathbf{x}+\\varphi)$ 的解析解为：\n$$\n\\phi_{\\mathrm{ana}}(\\mathbf{x}) = -A \\frac{S}{|\\mathbf{k}|^2} \\cos(\\mathbf{k}\\cdot\\mathbf{x} + \\varphi), \\quad \\text{for } \\mathbf{k} \\neq \\mathbf{0}\n$$\n对于零模式 $\\mathbf{k}=\\mathbf{0}$，密度衬度 $\\delta(\\mathbf{x}) = A\\cos(\\varphi)$ 是一个常数。根据物理学惯例，这种均匀的偏移不会产生微扰引力势，因此 $\\phi_{\\mathrm{ana}}(\\mathbf{x})=0$。\n\n最后，计算校准误差 $\\epsilon$。\n- 对于 $\\mathbf{k} \\neq \\mathbf{0}$，我们使用分数 $L^2$ 误差：$\\epsilon = \\frac{\\|\\phi_{\\mathrm{num}} - \\phi_{\\mathrm{ana}}\\|_2}{\\|\\phi_{\\mathrm{ana}}\\|_2}$，其中 $\\|\\cdot\\|_2$ 是所有网格点上的欧几里得范数。\n- 对于 $\\mathbf{k} = \\mathbf{0}$，$\\phi_{\\mathrm{ana}}$ 恒为零，因此分子和分母都将为零或接近零。此时，误差被定义为数值势的均方根 (RMS)：$\\epsilon = \\sqrt{\\frac{1}{N^3}\\sum_i (\\phi_{\\mathrm{num},i})^2}$。\n\n由于输入密度场是一个单一的、纯粹的傅里叶模式，可以被网格的基函数完美表示（因为模式数 $m_x, m_y, m_z$ 是整数），因此谱方法应能产生一个在机器精度上与解析解相匹配的解。因此，计算出的误差 $\\epsilon$ 预计会非常小，量级在 $10^{-15}$ 或 $10^{-16}$ 左右。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the Poisson equation for several single-mode test cases\n    and computes the calibration error against the analytic solution.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (N, L, A, phi, S, (mx, my, mz))\n        (64, 1.0, 1e-2, 0.3, 1.0, (3, 0, 0)),\n        (48, 1.0, 2e-2, 1.1, 1.0, (2, 3, 5)),\n        (32, 1.0, 1e-3, 0.0, 1.0, (15, 0, 0)),\n        (40, 1.0, 0.5, 0.7, 1.0, (0, 0, 0)),\n    ]\n\n    results = []\n    for case in test_cases:\n        N, L, A, phi_phase, S, m_tuple = case\n        m = np.array(m_tuple, dtype=float)\n\n        # --- 1. Construct the real-space grid and density field ---\n        \n        # Grid coordinates\n        grid_pts = np.linspace(0.0, L, N, endpoint=False)\n        x, y, z = np.meshgrid(grid_pts, grid_pts, grid_pts, indexing='ij')\n\n        # Wavevector for the single mode\n        k_mode = (2.0 * np.pi / L) * m\n        \n        # Density contrast field delta(x)\n        k_dot_x = k_mode[0] * x + k_mode[1] * y + k_mode[2] * z\n        delta_real = A * np.cos(k_dot_x + phi_phase)\n\n        # --- 2. Solve for the potential phi_num using spectral method ---\n\n        # Forward FFT of the density field\n        delta_fourier = np.fft.fftn(delta_real)\n\n        # Construct the grid of wavevectors in Fourier space\n        k_freq = np.fft.fftfreq(N, d=1.0/N) * (2.0 * np.pi / L)\n        kx, ky, kz = np.meshgrid(k_freq, k_freq, k_freq, indexing='ij')\n        \n        # k_squared = kx^2 + ky^2 + kz^2\n        k_squared = kx**2 + ky**2 + kz**2\n\n        # Solve for phi in Fourier space, handling the k=0 mode\n        phi_fourier = np.zeros_like(delta_fourier)\n        with np.errstate(divide='ignore', invalid='ignore'):\n            # Select non-zero k modes to perform division\n            non_zero_k = k_squared > 0\n            phi_fourier[non_zero_k] = -S * delta_fourier[non_zero_k] / k_squared[non_zero_k]\n        \n        # Explicitly set the k=0 (DC) component to zero\n        phi_fourier[0, 0, 0] = 0.0\n\n        # Inverse FFT to get the numerical solution for the potential\n        phi_num = np.real(np.fft.ifftn(phi_fourier))\n\n        # --- 3. Construct the analytic solution phi_ana ---\n        \n        is_zero_mode = np.all(m == 0)\n        \n        if is_zero_mode:\n            phi_ana = np.zeros_like(phi_num)\n        else:\n            k_mode_mag_sq = np.sum(k_mode**2)\n            phi_ana = -A * S / k_mode_mag_sq * np.cos(k_dot_x + phi_phase)\n\n        # --- 4. Compute the calibration error epsilon ---\n        \n        if is_zero_mode:\n            # For the zero mode, use RMS of the numerical potential\n            epsilon = np.sqrt(np.mean(phi_num**2))\n        else:\n            # For non-zero modes, use fractional L2 error\n            norm_ana = np.linalg.norm(phi_ana)\n            if norm_ana  1e-15:\n                epsilon = np.linalg.norm(phi_num)\n            else:\n                norm_diff = np.linalg.norm(phi_num - phi_ana)\n                epsilon = norm_diff / norm_ana\n        \n        results.append(epsilon)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "知道了引力势（或位移场），我们就可以移动粒子来模拟宇宙结构的形成。本练习采用了泽尔多维奇近似，这是一种描述引力坍缩早期阶段的强大分析工具。你将根据一个单一模式的扰动来移动粒子，然后分析由此产生的密度场，并将其与涉及非线性模式耦合的理论预测进行比较。这个实践练习将线性理论、准线性演化与完整的数值模拟联系起来，揭示了结构形成过程中模式耦合的起源。",
            "id": "3481632",
            "problem": "你需要实现、验证并诊断一个一维周期性的数值宇宙学实验。该实验比较了在周期性边界条件下单个平面波密度模式的演化与泽尔多维奇近似的结果，并使用模式耦合来诊断当波数大小与基模相当时的有限盒效应和离散化误差。该实验必须从第一性原理出发，使用质量守恒和泽尔多维奇映射进行设计，不得使用问题陈述中提供的简化公式。\n\n构建一个长度为 $L$ 的一维周期性区域，其中包含 $N_{\\mathrm{p}}$ 个等质量粒子，其初始拉格朗日坐标 $q \\in [0,L)$ 均匀分布。施加一个与周期性边界条件一致的单平面波位移场，其波矢量为 $k = 2\\pi n_0/L$，其中 $n_0 \\in \\mathbb{Z}^+$ 是模式指数，振幅参数为 $\\nu = A k$，满足 $0  \\nu  1$（以避免壳层交叉）。泽尔多维奇映射定义为：\n- 欧拉位置 $x(q) = q + \\Psi(q)$，\n- 一个由标量势导出的无旋位移 $\\Psi(q)$，该标量势产生一个纵向平面波。\n\n利用质量守恒和区域的周期性，从第一性原理推导出欧拉密度对比 $\\delta(x)$ 在种子模式谐波处（即波数为 $k' = m k$，其中 $m$ 为正整数）的傅里叶级数振幅的解析预测。你的推导必须从质量守恒 $[1+\\delta(x)]\\,dx = dq$ 和单模位移的泽尔多维奇映射开始，并且可以在推导过程中自然出现标准特殊函数时使用它们。不要先验地假设任何目标公式。\n\n数值上实现以下算法以完成实验：\n- 初始化 $N_{\\mathrm{p}}$ 个粒子，其拉格朗日位置为 $q_i = (i + 1/2)\\Delta q$，其中 $i \\in \\{0,\\dots,N_{\\mathrm{p}}-1\\}$，$\\Delta q = L/N_{\\mathrm{p}}$。\n- 设置位移为与周期性边界条件一致的纵向单模波：$\\Psi(q) = -A \\sin(k q)$，其中 $A = \\nu/k$，$k = 2\\pi n_0/L$。\n- 使用周期性边界条件映射到欧拉位置：$x_i = \\big(q_i + \\Psi(q_i)\\big) \\bmod L$。\n- 使用 Cloud-In-Cell (CIC) 分配方案，将粒子质量分配到具有 $N_{\\mathrm{g}}$ 个单元的欧拉网格上。该网格是均匀的，间距为 $\\Delta x = L/N_{\\mathrm{g}}$。将分配的质量转换为网格单元 $j \\in \\{0,\\dots,N_{\\mathrm{g}}-1\\}$ 上的超密度场 $\\delta_j = \\rho_j/\\bar{\\rho} - 1$。\n- 在周期性区域上计算 $\\delta_j$ 的离散傅里叶变换，以获得在离散波数指数 $n \\in \\{0,\\dots,\\lfloor N_{\\mathrm{g}}/2 \\rfloor\\}$ 处的复傅里叶系数，这些指数对应于 $k_n = 2\\pi n/L$。\n\n由于通过 Cloud-In-Cell 进行的质量分配会将傅里叶振幅乘以分配窗口函数，因此需要将每个测量的傅里叶振幅除以一维 CIC 窗口函数：\n$$\nW_{\\mathrm{CIC}}(k_n) = \\left[\\frac{\\sin\\big(k_n \\Delta x/2\\big)}{k_n \\Delta x/2}\\right]^2 = \\left[\\operatorname{sinc}\\left(\\frac{\\pi n}{N_{\\mathrm{g}}}\\right)\\right]^2,\n$$\n其中 $\\operatorname{sinc}(y) = \\sin(y)/y$。使用此反卷积方法，将去除窗口效应后的测量振幅与你的解析泽尔多维奇预测在前三个谐波 $m \\in \\{1,2,3\\}$ 处进行比较，前提是谐波指数 $m n_0$ 不超过可用的奈奎斯特指数 $\\lfloor N_{\\mathrm{g}}/2 \\rfloor$。\n\n为每个实验定义两个定量诊断指标：\n- 前三个谐波的最大相对振幅误差，\n$$\n\\varepsilon_{\\max} = \\max_{m \\in \\{1,2,3\\} \\,:\\, m n_0 \\le \\lfloor N_{\\mathrm{g}}/2 \\rfloor} \\frac{\\left|\\,\\widehat{\\delta}_{m n_0}^{\\mathrm{(meas)}}/W_{\\mathrm{CIC}}(k_{m n_0}) - \\widehat{\\delta}_{m n_0}^{\\mathrm{(theory)}}\\,\\right|}{\\left|\\widehat{\\delta}_{m n_0}^{\\mathrm{(theory)}}\\right|},\n$$\n其中 $\\widehat{\\delta}_n$ 表示指数为 $n$ 的傅里叶系数，上标表示测量值与理论（泽尔多维奇）预测值。如果理论振幅小到可以忽略不计，你必须稳健地处理除以接近零的值的情况。\n- 一个模式耦合泄漏指数，它通过量化泄漏到谐波阶梯 $\\{m n_0\\}$ 之外的功率来诊断有限盒效应和离散化误差，\n$$\n\\mathcal{L} = \\frac{\\sum_{n=1}^{\\lfloor N_{\\mathrm{g}}/2 \\rfloor} \\left|\\widehat{\\delta}_n^{\\mathrm{(meas)}}\\right|^2 - \\sum_{m \\in \\mathcal{M}} \\left|\\widehat{\\delta}_{m n_0}^{\\mathrm{(meas)}}\\right|^2}{\\sum_{n=1}^{\\lfloor N_{\\mathrm{g}}/2 \\rfloor} \\left|\\widehat{\\delta}_n^{\\mathrm{(meas)}}\\right|^2},\n$$\n其中 $\\mathcal{M} = \\{m \\in \\{1,2,3\\} \\,|\\, m n_0 \\le \\lfloor N_{\\mathrm{g}}/2 \\rfloor\\}$，并且求和排除了零模，以避免对平均密度约束的敏感性。将 $\\varepsilon_{\\max}$ 和 $\\mathcal{L}$ 表示为小数。\n\n测试套件：\n- 使用三个测试用例来探测在基准波数和非线性强度附近的不同区域，盒子长度 $L$ 固定：\n  1. $N_{\\mathrm{g}} = 64$, $N_{\\mathrm{p}} = 64$, $L = 1$, $n_0 = 1$, $\\nu = 0.3$.\n  2. $N_{\\mathrm{g}} = 64$, $N_{\\mathrm{p}} = 64$, $L = 1$, $n_0 = 2$, $\\nu = 0.3$.\n  3. $N_{\\mathrm{g}} = 64$, $N_{\\mathrm{p}} = 64$, $L = 1$, $n_0 = 1$, $\\nu = 0.9$.\n- 在此问题中，所有量都是无量纲的。\n\n你的程序必须：\n- 为三个测试用例实现周期性映射和质量分配。\n- 从第一性原理计算解析的泽尔多维奇谐波振幅，并将其与去除窗口效应后的测量振幅进行比较，以获得每种情况下的 $\\varepsilon_{\\max}$。\n- 计算每种情况下的模式耦合泄漏指数 $\\mathcal{L}$。\n- 生成一行输出，包含六个结果，顺序为 $[\\varepsilon_{\\max}^{(1)}, \\mathcal{L}^{(1)}, \\varepsilon_{\\max}^{(2)}, \\mathcal{L}^{(2)}, \\varepsilon_{\\max}^{(3)}, \\mathcal{L}^{(3)}]$，其中上标指的是测试用例编号。将每个值打印为四舍五入到六位小数，不含任何附加文本。\n\n角度单位是弧度。此问题中没有物理单位，因为所有量都是通过构造无量纲的。你的推导必须从质量守恒和泽尔多维奇映射开始，并为你用于解析振幅的任何特殊函数表示提供理由。数值实现必须通过在 $[0,L)$ 上的模运算来精确执行周期性边界条件，并且必须使用如上所述的 Cloud-In-Cell 方案。",
            "solution": "该问题要求对一维周期性宇宙学中，根据泽尔多维奇近似产生的单个平面波扰动所产生的密度场进行理论推导和数值验证。我们必须推导密度对比的解析傅里叶振幅，实现一个数值粒子模拟，并计算两个指定的诊断指标。\n\n**第一部分：傅里叶振幅的解析推导**\n\n欧拉密度对比 $\\widehat{\\delta}_{m n_0}^{\\mathrm{(theory)}}$ 的理论傅里叶振幅的推导，按要求从质量守恒原理开始。在一维中，该原理将均匀拉格朗日（初始）坐标 $q$ 中的无穷小质量元与其在欧拉（演化后）坐标 $x$ 中的对应元联系起来。质量是守恒的，因此 $\\bar{\\rho}\\,dq = \\rho(x)\\,dx$，其中 $\\bar{\\rho}$ 是平均密度，$\\rho(x)$ 是欧拉密度。欧拉密度对比定义为 $\\delta(x) = \\rho(x)/\\bar{\\rho} - 1$。代入此定义得到 $(1+\\delta(x))\\,dx = dq$。这意味着密度对比可以用从 $q$ 到 $x$ 的坐标变换的雅可比行列式来表示：\n$$\n1 + \\delta(x) = \\left(\\frac{dx}{dq}\\right)^{-1} \\implies \\delta(x(q)) = \\left(\\frac{dx}{dq}\\right)^{-1} - 1\n$$\n问题指定了泽尔多维奇映射 $x(q) = q + \\Psi(q)$，其中包含一个单模位移场 $\\Psi(q) = -A \\sin(k q)$，基波矢为 $k = 2\\pi n_0 / L$，模式指数为 $n_0 \\in \\mathbb{Z}^+$。其导数为：\n$$\n\\frac{dx}{dq} = 1 - A k \\cos(k q) = 1 - \\nu \\cos(k q)\n$$\n其中 $\\nu = A k$ 是无量纲振幅参数，被限制在 $0  \\nu  1$ 以防止壳层交叉（即确保 $dx/dq > 0$，从而使映射是一对一的）。\n\n周期函数 $\\delta(x)$ 在区域 $[0, L)$ 上的傅里叶系数 $\\widehat{\\delta}_n$ 由下式给出：\n$$\n\\widehat{\\delta}_n = \\frac{1}{L} \\int_0^L \\delta(x) e^{-i k_n x} dx\n$$\n其中 $k_n = 2\\pi n / L$。为了计算这个积分，我们将积分变量从 $x$ 更改为 $q$。\n$$\n\\widehat{\\delta}_n = \\frac{1}{L} \\int_0^L \\delta(x(q)) e^{-i k_n x(q)} \\frac{dx}{dq} dq\n$$\n代入 $\\delta(x(q)) = (dx/dq)^{-1} - 1$，我们得到：\n$$\n\\widehat{\\delta}_n = \\frac{1}{L} \\int_0^L \\left(\\left(\\frac{dx}{dq}\\right)^{-1} - 1\\right) e^{-i k_n x(q)} \\frac{dx}{dq} dq = \\frac{1}{L} \\int_0^L \\left(1 - \\frac{dx}{dq}\\right) e^{-i k_n x(q)} dq\n$$\n一个更直接得到相同积分的方法是注意到对于 $n \\ne 0$，$\\int_0^L e^{-ik_n x} dx / L = 0$。这意味着 $\\int_0^L e^{-ik_n x(q)} (dx/dq) dq = 0$。因此，对于 $n \\ne 0$：\n$$\n\\int_0^L e^{-i k_n x(q)} dq = \\int_0^L e^{-i k_n x(q)} dq - \\int_0^L e^{-i k_n x(q)} \\frac{dx}{dq} dq = \\int_0^L \\left(1 - \\frac{dx}{dq}\\right) e^{-i k_n x(q)} dq\n$$\n这证实了密度对比 $\\delta(x)$ 的傅里叶系数可以通过计算 $\\widehat{\\delta}_n = \\frac{1}{L} \\int_0^L e^{-i k_n x(q)} dq$（对于 $n \\ne 0$）来找到。此表达式代表了离散求和 $\\frac{1}{N_p} \\sum_i e^{-ik_n x_i}$ 的连续极限，也就是粒子数密度的傅里叶变换。\n\n我们感兴趣的是基模的谐波，其中波数指数为 $n = m n_0$，$m$ 为正整数。相应的波矢为 $k_{m n_0} = m k$。代入 $x(q) = q - A \\sin(kq)$：\n$$\n\\widehat{\\delta}_{m n_0} = \\frac{1}{L} \\int_0^L e^{-i k_{m n_0} (q - A \\sin(kq))} dq = \\frac{1}{L} \\int_0^L e^{-i m k q} e^{i m k A \\sin(kq)} dq\n$$\n使用 $k A = \\nu$，我们有：\n$$\n\\widehat{\\delta}_{m n_0} = \\frac{1}{L} \\int_0^L e^{-i m k q} e^{i m \\nu \\sin(kq)} dq\n$$\n我们进行变量替换 $\\theta = kq$。那么 $d\\theta = k\\,dq$，积分范围 $q \\in [0,L)$ 变为 $\\theta \\in [0, kL) = [0, 2\\pi n_0)$。积分变为：\n$$\n\\widehat{\\delta}_{m n_0} = \\frac{1}{L} \\int_0^{2\\pi n_0} e^{-i m \\theta} e^{i m \\nu \\sin(\\theta)} \\frac{d\\theta}{k} = \\frac{1}{kL} \\int_0^{2\\pi n_0} e^{i (m \\nu \\sin\\theta - m \\theta)} d\\theta\n$$\n由于 $kL = 2\\pi n_0$ 并且被积函数是 $2\\pi$-周期的，因此在 $n_0$ 个周期上的积分是单个周期 $[0, 2\\pi)$ 上积分的 $n_0$ 倍：\n$$\n\\widehat{\\delta}_{m n_0} = \\frac{n_0}{2\\pi n_0} \\int_0^{2\\pi} e^{i (m \\nu \\sin\\theta - m \\theta)} d\\theta = \\frac{1}{2\\pi} \\int_0^{2\\pi} e^{i (m \\nu \\sin\\theta - m \\theta)} d\\theta\n$$\n这是第一类贝塞尔函数 $J_m(z)$ 的积分表示：\n$$\nJ_m(z) = \\frac{1}{2\\pi} \\int_0^{2\\pi} e^{i(z\\sin\\theta - m\\theta)} d\\theta\n$$\n通过辨认出 $z = m \\nu$，我们得到了理论傅里叶系数的最终解析表达式：\n$$\n\\widehat{\\delta}_{m n_0}^{\\mathrm{(theory)}} = J_m(m\\nu)\n$$\n这个结果非常简洁：密度对比的第 $m$ 次谐波的振幅仅取决于阶数 $m$ 和乘积 $m\\nu$。\n\n**第二部分：数值实现与诊断**\n\n问题的数值部分包括以下步骤：\n\n1.  **粒子初始化**：将 $N_{\\mathrm{p}}$ 个粒子放置在拉格朗日坐标 $q_i = (i + 1/2) (L/N_{\\mathrm{p}})$ 处，其中 $i=0, \\dots, N_{\\mathrm{p}}-1$。\n2.  **泽尔多维奇映射**：将每个粒子移动到其欧拉位置 $x_i = (q_i - A \\sin(k q_i)) \\pmod L$，其中 $k=2\\pi n_0/L$，$A=\\nu/k$。模运算确保周期性边界条件被正确处理。\n3.  **质量分配**：使用 Cloud-In-Cell (CIC) 方案将粒子质量分配到一个具有 $N_{\\mathrm{g}}$ 个单元的均匀欧拉网格上。对于每个位置为 $x_i$ 的粒子，其质量在两个最近的网格单元之间进行线性分配。以网格单位表示的位置是 $u_i = x_i / \\Delta x$，其中 $\\Delta x = L/N_{\\mathrm{g}}$。左侧单元的索引是 $j_1=\\lfloor u_i \\rfloor$，右侧是 $j_2 = (j_1+1) \\pmod{N_{\\mathrm{g}}}$。分配给单元 $j_2$ 的权重是 $w_2 = u_i - j_1$，分配给单元 $j_1$ 的权重是 $w_1 = 1 - w_2$。\n4.  **密度对比**：将网格上的质量转换为密度对比场 $\\delta_j = \\rho_j/\\bar{\\rho} - 1$，其中 $\\rho_j$ 是单元 $j$ 中的质量，$\\bar{\\rho}$ 是每个单元的平均质量。对于给定的测试用例，$N_{\\mathrm{p}}=N_{\\mathrm{g}}$，因此平均值是每个单元 1 个粒子，$\\delta_j$ 就是单元 $j$ 中的粒子数减 1。\n5.  **傅里叶分析**：使用 FFT 算法（`numpy.fft.rfft`）计算实值场 $\\delta_j$ 的离散傅里叶变换，在通过 $N_{\\mathrm{g}}$ 进行归一化后，得到复系数 $\\widehat{\\delta}_n^{\\mathrm{(meas, raw)}}$。\n6.  **反卷积**：CIC 方案在傅里叶空间中具有已知的滤波效应，通过将测量系数除以 CIC 窗口函数 $W_{\\mathrm{CIC}}(k_n) = [\\operatorname{sinc}(\\pi n/N_{\\mathrm{g}})]^2$ 来进行校正。\n7.  **诊断**：\n    *   **$\\varepsilon_{\\max}$**：通过比较反卷积后的测量系数 $|\\widehat{\\delta}_{m n_0}^{\\mathrm{(meas)}}|$ 与理论预测值 $|\\widehat{\\delta}_{m n_0}^{\\mathrm{(theory)}}| = |J_m(m\\nu)|$ 来计算最大相对振幅误差。此比较针对前三个在网格上可分辨的谐波（即 $m n_0 \\le \\lfloor N_{\\mathrm{g}}/2 \\rfloor$，$m \\in \\{1,2,3\\}$）。\n    *   **$\\mathcal{L}$**：模式耦合泄漏指数，量化了傅里叶谱中“泄漏”出预期谐波阶梯 $\\{m n_0\\}$ 之外的功率部分。它被计算为非谐波功率与总功率（不包括 $n=0$ 模式）之比。\n\n对三个测试用例中的每一个都执行这些步骤，这些用例探测了基准波数和非线性强度的不同区域。",
            "answer": "```python\nimport numpy as np\nfrom scipy.special import jv\n\ndef solve():\n    \"\"\"\n    Main function to run the simulation and analysis for all test cases and print\n    the final results in the specified format.\n    \"\"\"\n    test_cases = [\n        # (N_g, N_p, L, n_0, nu)\n        (64, 64, 1.0, 1, 0.3),\n        (64, 64, 1.0, 2, 0.3),\n        (64, 64, 1.0, 1, 0.9),\n    ]\n\n    all_results = []\n    for params in test_cases:\n        epsilon_max, leakage = run_simulation(*params)\n        all_results.extend([epsilon_max, leakage])\n\n    print(f\"[{','.join(f'{v:.6f}' for v in all_results)}]\")\n\ndef run_simulation(N_g, N_p, L, n_0, nu):\n    \"\"\"\n    Executes one test case of the numerical experiment.\n    \"\"\"\n    # 1. Initialization\n    k = 2.0 * np.pi * n_0 / L\n    A = nu / k if k != 0 else 0.0\n        \n    delta_q = L / N_p\n    q_i = (np.arange(N_p, dtype=np.float64) + 0.5) * delta_q\n\n    # 2. Zel'dovich Mapping\n    psi_i = -A * np.sin(k * q_i)\n    x_i = np.mod(q_i + psi_i, L)\n\n    # 3. Mass Deposition (Cloud-In-Cell)\n    delta_x = L / N_g\n    mass_grid = np.zeros(N_g, dtype=np.float64)\n    u_i = x_i / delta_x\n    j1 = np.floor(u_i).astype(int)\n    w2 = u_i - j1\n    w1 = 1.0 - w2\n    j2 = np.mod(j1 + 1, N_g)\n    np.add.at(mass_grid, j1, w1)\n    np.add.at(mass_grid, j2, w2)\n\n    # 4. Overdensity and Fourier Analysis\n    mean_density_per_cell = float(N_p) / float(N_g)\n    delta_j = mass_grid / mean_density_per_cell - 1.0\n    \n    delta_k_hat_raw = np.fft.rfft(delta_j)\n    \n    # 5. Deconvolution and Diagnostic Calculation\n    errors = []\n    harmonics_to_check = [1, 2, 3]\n    nyquist_idx = N_g // 2\n    \n    # Get Fourier series coefficients from FFT output\n    d_meas_raw = delta_k_hat_raw / N_g\n    # For rfft, non-zero/non-nyquist modes represent twice the power\n    # But for coefficients, we need to handle them differently if we want to match a_n, b_n.\n    # The problem compares coefficients directly, so let's stick to that.\n    \n    k_indices = np.arange(len(d_meas_raw))\n    \n    # CIC window function\n    win_cic = np.sinc(k_indices / N_g)**2\n    win_cic[win_cic == 0] = 1e-30 # Avoid division by zero\n    \n    d_meas_deconv = d_meas_raw / win_cic\n\n    for m in harmonics_to_check:\n        n = m * n_0\n        if n = nyquist_idx:\n            d_theory = jv(m, m * nu)\n            \n            # The numerical coefficient from rfft is c_n = (a_n - i*b_n)/2 for n>0.\n            # The full coefficient should be considered.\n            # However, the problem formulation implies a direct comparison with `widehat{delta}`.\n            # The python rfft is just `sum x_j exp(-2pi i j n / N)`.\n            # So `d_meas_raw` is the correct numerical analogue of `widehat{delta}_n`.\n            d_meas = d_meas_deconv[n]\n            \n            # For rfft output, the amplitude of a mode is 2*|c_n|/N.\n            # The theoretical coefficient is for the full complex series.\n            # To match, we need to handle this.\n            # If delta(x) = C_n*exp(iknx)+C_-n*exp(-iknx), C_-n=C_n^*.\n            # Then delta(x) = 2*Re(C_n*exp(iknx)).\n            # The theory gives a real coefficient for `exp(-ikx)`, but doesn't specify phase.\n            # Let's assume we compare magnitudes.\n            # Problem formula compares complex values.\n            numerator = np.abs(d_meas - d_theory)\n            denominator = np.abs(d_theory)\n            \n            if denominator  1e-15:\n                rel_error = 0.0 if numerator  1e-15 else np.inf\n            else:\n                rel_error = numerator / denominator\n            errors.append(rel_error)\n\n    epsilon_max = np.max(errors) if errors else 0.0\n\n    # -- L: Mode-coupling leakage index --\n    power_spectrum_raw = np.abs(delta_k_hat_raw)**2\n    total_power = np.sum(power_spectrum_raw[1:])\n    \n    harmonic_indices = []\n    for m in harmonics_to_check:\n        n = m * n_0\n        if n = nyquist_idx:\n            harmonic_indices.append(n)\n            \n    harmonic_power = np.sum(power_spectrum_raw[harmonic_indices])\n    \n    if total_power  1e-15:\n        leakage = 0.0\n    else:\n        leakage = (total_power - harmonic_power) / total_power\n        \n    return epsilon_max, leakage\n\nif __name__ == '__main__':\n    solve()\n```"
        }
    ]
}