{
    "hands_on_practices": [
        {
            "introduction": "谐振子是分析数值积分器性能的经典模型。通过将其应用于这个简单系统，我们可以揭示积分器最核心的性质。本练习旨在推导蛙跳格式下的“修正”频率，这个过程将帮助你理解该格式如何以及为何会轻微地改变系统的固有周期，这是理解其作为辛积分器长期保真性的关键一步。",
            "id": "3501415",
            "problem": "在宇宙学 $N$ 体计算中，诸如“踢-漂-踢”（Kick–Drift–Kick, KDK）蛙跳法之类的辛分裂积分器被用于在不依赖于时间的力作用下推进轨迹。考虑一个一维谐振子，其哈密顿量为 $H(x,p)=\\frac{1}{2}\\left(p^{2}+\\omega^{2}x^{2}\\right)$，作为一个与引力势能极小值附近的小振荡相关的线性测试平台。在此系统中，质量已归一化为 $m=1$，$x$ 是共动坐标，$p$ 是正则动量，$\\omega0$ 是精确角频率。运动方程为 $\\ddot{x}+\\omega^{2}x=0$，由 $H$ 生成的连续时间流是一个旋转角为 $\\omega t$ 的相空间旋转。\n\n设时间步长为 $h0$。KDK蛙跳法包括：由势能梯度驱动、跨越半个步长的动量“踢”；由动能项驱动、跨越一个完整步长的位置“漂”；以及最后一次跨越半个步长的动量“踢”。从定义 $H$ 的基本定律、正则方程和 KDK 组合出发，推导单步线性更新映射 $(x_{n},p_{n})\\mapsto(x_{n+1},p_{n+1})$，并分析其特征值以推断出相应相空间旋转的角度。该离散映射精确地保持一个修正（影子）哈密顿量守恒，该哈密顿量是二次的，并以一个依赖于 $h$ 和 $\\omega$ 的修正角频率 $\\tilde{\\omega}$ 生成谐波旋转。\n\n计算由 KDK 蛙跳法的修正哈密顿量所隐含的修正角频率 $\\tilde{\\omega}$ 的闭式解析表达式，该表达式应纯粹用 $h$ 和 $\\omega$ 表示。在你的推导过程中，请在小 $h$ 极限下简要比较 $\\tilde{\\omega}$ 和精确值 $\\omega$，但最终答案只需提供 $\\tilde{\\omega}$ 的解析表达式。不需要进行数值取整，最终答案中也不应包含任何单位。",
            "solution": "问题陈述经过严格验证，被证实是有效的。其科学基础在于哈密顿力学和数值积分理论，问题是适定的、客观的且内部一致的。因此，我们可以开始推导。\n\n该系统是一个质量 $m=1$ 的一维谐振子，由哈密顿量 $H(x,p) = T(p) + V(x)$ 描述，其中动能为 $T(p) = \\frac{1}{2}p^2$，势能为 $V(x) = \\frac{1}{2}\\omega^2 x^2$。哈密顿正则运动方程为：\n$$\n\\dot{x} = \\frac{\\partial H}{\\partial p} = p\n$$\n$$\n\\dot{p} = -\\frac{\\partial H}{\\partial x} = -\\omega^2 x\n$$\n\n“踢-漂-踢”（KDK）蛙跳积分器是一种二阶辛分裂方法，它通过动能部分和势能部分算符的组合来近似精确的时间演化算符 $\\exp(h\\mathcal{L}_H)$，其中 $\\mathcal{L}_H = \\{ \\cdot, H \\}$ 是泊松括号算符。对于一个时间步长 $h$，KDK 格式由以下组合给出：\n$$\n\\Phi_h = \\Phi_V^{h/2} \\circ \\Phi_T^{h} \\circ \\Phi_V^{h/2}\n$$\n在此，$\\Phi_V^{\\Delta t}$ 表示仅在势能部分 $V(x)$ 的作用下将系统演化时间 $\\Delta t$，而 $\\Phi_T^{\\Delta t}$ 表示仅在动能部分 $T(p)$ 的作用下将其演化时间 $\\Delta t$。\n\n让我们推导每个分量的映射。\n1.  **“踢”步 ($\\Phi_V^{\\Delta t}$)**：在 $V(x)$ 作用下的演化遵循方程 $\\dot{x}=0$ 和 $\\dot{p}=-\\frac{\\partial V}{\\partial x} = -\\omega^2 x$。由于在此步骤中 $x$ 是恒定的，因此在一个时间间隔 $\\Delta t$ 内，从 $(x, p)$ 到 $(x', p')$ 的更新为：\n    $$\n    x' = x\n    $$\n    $$\n    p' = p - (\\omega^2 x) \\Delta t\n    $$\n\n2.  **“漂”步 ($\\Phi_T^{\\Delta t}$)**：在 $T(p)$ 作用下的演化遵循方程 $\\dot{x}=\\frac{\\partial T}{\\partial p} = p$ 和 $\\dot{p}=0$。由于在此步骤中 $p$ 是恒定的，因此在一个时间间隔 $\\Delta t$ 内，从 $(x, p)$ 到 $(x', p')$ 的更新为：\n    $$\n    x' = x + p \\Delta t\n    $$\n    $$\n    p' = p\n    $$\n\n现在，我们组合这些步骤来构建在时间步长 $h$ 上从 $(x_n, p_n)$ 到 $(x_{n+1}, p_{n+1})$ 的完整 KDK 积分器映射。\n\n**第一次“踢”（半步，$\\Delta t = h/2$）**：\n设中间状态为 $(x_\\text{mid1}, p_\\text{mid1})$。\n$$\nx_\\text{mid1} = x_n\n$$\n$$\np_\\text{mid1} = p_n - \\frac{h}{2}\\omega^2 x_n\n$$\n\n**“漂”（整步，$\\Delta t = h$）**：\n设下一个中间状态为 $(x_\\text{mid2}, p_\\text{mid2})$。我们将“漂”步应用于 $(x_\\text{mid1}, p_\\text{mid1})$。\n$$\nx_\\text{mid2} = x_\\text{mid1} + h \\cdot p_\\text{mid1} = x_n + h\\left(p_n - \\frac{h}{2}\\omega^2 x_n\\right) = \\left(1 - \\frac{h^2\\omega^2}{2}\\right)x_n + h p_n\n$$\n$$\np_\\text{mid2} = p_\\text{mid1} = p_n - \\frac{h}{2}\\omega^2 x_n\n$$\n\n**第二次“踢”（半步，$\\Delta t = h/2$）**：\n最终状态 $(x_{n+1}, p_{n+1})$ 是通过将“踢”步应用于 $(x_\\text{mid2}, p_\\text{mid2})$ 得到的。\n$$\nx_{n+1} = x_\\text{mid2} = \\left(1 - \\frac{h^2\\omega^2}{2}\\right)x_n + h p_n\n$$\n$$\np_{n+1} = p_\\text{mid2} - \\frac{h}{2}\\omega^2 x_\\text{mid2} = \\left(p_n - \\frac{h}{2}\\omega^2 x_n\\right) - \\frac{h}{2}\\omega^2 \\left[ \\left(1 - \\frac{h^2\\omega^2}{2}\\right)x_n + h p_n \\right]\n$$\n展开 $p_{n+1}$ 的表达式：\n$$\np_{n+1} = p_n - \\frac{h\\omega^2}{2}x_n - \\frac{h\\omega^2}{2}\\left(1 - \\frac{h^2\\omega^2}{2}\\right)x_n - \\frac{h^2\\omega^2}{2}p_n\n$$\n$$\np_{n+1} = \\left(1 - \\frac{h^2\\omega^2}{2}\\right)p_n - \\left[\\frac{h\\omega^2}{2} + \\frac{h\\omega^2}{2} - \\frac{h^3\\omega^4}{4}\\right]x_n\n$$\n$$\np_{n+1} = \\left(1 - \\frac{h^2\\omega^2}{2}\\right)p_n - \\left(h\\omega^2 - \\frac{h^3\\omega^4}{4}\\right)x_n\n$$\n$$\np_{n+1} = -\\omega^2 h\\left(1 - \\frac{h^2\\omega^2}{4}\\right)x_n + \\left(1 - \\frac{h^2\\omega^2}{2}\\right)p_n\n$$\n\n单步线性更新可以写成矩阵形式 $\\begin{pmatrix} x_{n+1} \\\\ p_{n+1} \\end{pmatrix} = M \\begin{pmatrix} x_n \\\\ p_n \\end{pmatrix}$，其中转移矩阵 $M$ 为：\n$$\nM = \\begin{pmatrix}\n1 - \\frac{h^2\\omega^2}{2}  h \\\\\n-\\omega^2 h\\left(1 - \\frac{h^2\\omega^2}{4}\\right)  1 - \\frac{h^2\\omega^2}{2}\n\\end{pmatrix}\n$$\n这个离散映射对应于相空间中角度为 $\\theta = \\tilde{\\omega}h$ 的旋转，其中 $\\tilde{\\omega}$ 是我们寻求的修正角频率。一个 $2 \\times 2$ 旋转矩阵的特征值为 $e^{\\pm i\\theta}$。这种矩阵的迹为 $e^{i\\theta} + e^{-i\\theta} = 2\\cos(\\theta)$。因此，我们可以通过计算转移矩阵 $M$ 的迹来求得该角度。\n$$\n\\text{Tr}(M) = \\left(1 - \\frac{h^2\\omega^2}{2}\\right) + \\left(1 - \\frac{h^2\\omega^2}{2}\\right) = 2 - h^2\\omega^2\n$$\n将其与旋转矩阵的迹相等，可得：\n$$\n2\\cos(\\tilde{\\omega}h) = 2 - h^2\\omega^2\n$$\n$$\n\\cos(\\tilde{\\omega}h) = 1 - \\frac{h^2\\omega^2}{2}\n$$\n问题现在是求解 $\\tilde{\\omega}$。\n$$\n\\tilde{\\omega}h = \\arccos\\left(1 - \\frac{h^2\\omega^2}{2}\\right)\n$$\n这个表达式可以使用三角恒等式 $\\cos(2\\alpha) = 1 - 2\\sin^2(\\alpha)$ 来简化。令 $\\tilde{\\omega}h = 2\\alpha$。那么 $\\cos(2\\alpha) = 1 - \\frac{h^2\\omega^2}{2}$。将其与恒等式比较可得：\n$$\n2\\sin^2(\\alpha) = \\frac{h^2\\omega^2}{2} \\implies \\sin^2(\\alpha) = \\frac{h^2\\omega^2}{4}\n$$\n对于稳定积分（$h\\omega \\le 2$），我们可以取主根：\n$$\n\\sin(\\alpha) = \\frac{h\\omega}{2} \\implies \\alpha = \\arcsin\\left(\\frac{h\\omega}{2}\\right)\n$$\n将 $\\alpha = \\frac{\\tilde{\\omega}h}{2}$ 代回：\n$$\n\\frac{\\tilde{\\omega}h}{2} = \\arcsin\\left(\\frac{h\\omega}{2}\\right)\n$$\n求解 $\\tilde{\\omega}$：\n$$\n\\tilde{\\omega} = \\frac{2}{h}\\arcsin\\left(\\frac{h\\omega}{2}\\right)\n$$\n这就是修正角频率的闭式解析表达式。\n\n为了在小 $h$ 极限下比较 $\\tilde{\\omega}$ 和 $\\omega$，我们使用 $\\arcsin(z) = z + \\frac{z^3}{6} + O(z^5)$ 的泰勒级数展开，其中 $z = \\frac{h\\omega}{2}$：\n$$\n\\tilde{\\omega} = \\frac{2}{h}\\left[ \\left(\\frac{h\\omega}{2}\\right) + \\frac{1}{6}\\left(\\frac{h\\omega}{2}\\right)^3 + O(h^5) \\right]\n$$\n$$\n\\tilde{\\omega} = \\frac{2}{h}\\left[ \\frac{h\\omega}{2} + \\frac{h^3\\omega^3}{48} + O(h^5) \\right]\n$$\n$$\n\\tilde{\\omega} = \\omega + \\frac{h^2\\omega^3}{24} + O(h^4) = \\omega\\left(1 + \\frac{h^2\\omega^2}{24} + O(h^4)\\right)\n$$\n当 $h \\to 0$ 时，修正频率 $\\tilde{\\omega}$ 收敛于真实频率 $\\omega$。领头阶误差项 $\\frac{h^2\\omega^3}{24}$ 是正的，这表明数值振子的频率略高（周期缩短），这是蛙跳积分器的一个已知特性。误差与 $h^2$ 成比例，这与该方法是二阶精度的结论相一致。",
            "answer": "$$\\boxed{\\frac{2}{h}\\arcsin\\left(\\frac{h\\omega}{2}\\right)}$$"
        },
        {
            "introduction": "蛙跳积分器的一个标志性特征是其“交错”时间网格，即位置和动量在相差半个时间步长的时刻进行评估。这就带来了一个实际问题：如何从在同一初始时刻给定的位置和速度开始积分？本练习将指导你构建一个保持二阶精度的初始“半步踢”，这是正确启动任何蛙跳格式模拟的必要步骤。",
            "id": "3501379",
            "problem": "考虑一个无碰撞的非相对论性粒子，在一个空间平坦的 Friedmann–Lemaître–Robertson–Walker (FLRW) 宇宙中演化，其尺度因子为 $a(t)$。在共动坐标 $\\boldsymbol{x}(t)$ 中进行计算，并假设引力势 $\\phi(\\boldsymbol{x}, t)$ 是满足共动 Poisson 方程且随时间平滑变化的奇特势。使用单位质量的拉格朗日量 $L = a(t)^{2} |\\dot{\\boldsymbol{x}}|^{2} / 2 - \\phi(\\boldsymbol{x}, t)$，因此正则动量为 $\\boldsymbol{p} = a(t)^{2} \\dot{\\boldsymbol{x}}$。相关的哈密顿量为 $H(\\boldsymbol{x}, \\boldsymbol{p}, t) = |\\boldsymbol{p}|^{2} / \\left(2 a(t)^{2}\\right) + \\phi(\\boldsymbol{x}, t)$，Hamilton 方程给出 $\\dot{\\boldsymbol{x}} = \\boldsymbol{p}/a(t)^{2}$ 以及 $\\dot{\\boldsymbol{p}} = - \\nabla_{\\boldsymbol{x}} \\phi(\\boldsymbol{x}, t)$。\n\n你计划使用一个时间对称的蛙跳积分器，以踢-漂移-踢（kick–drift–kick）的形式，和一个均匀的宇宙时间步长 $\\Delta t$ 来积分运动方程。在初始时刻 $t_{0}$，给定共动位置 $\\boldsymbol{x}(t_{0})$ 和共动速度 $\\boldsymbol{v}(t_{0}) = \\dot{\\boldsymbol{x}}(t_{0})$，但蛙跳方案需要一个位于半时间步 $t_{0} + \\Delta t/2$ 处的动量 $\\boldsymbol{p}^{1/2}$ 来启动。构建一个初始的半步“踢”（half-kick），利用给定数据生成 $\\boldsymbol{p}^{1/2}$，并且不降低蛙跳方案的二阶精度。你的构建过程必须从上面给出的基本定义和方程出发，并且必须证明为何所得到的初始化方法是二阶精确的。\n\n将你的最终答案表示为 $\\boldsymbol{p}^{1/2}$ 的一个单一闭式解析表达式，用 $a(t_{0})$、$\\boldsymbol{v}(t_{0})$、$\\nabla_{\\boldsymbol{x}} \\phi(\\boldsymbol{x}(t_{0}), t_{0})$ 和 $\\Delta t$ 来表示。",
            "solution": "题目要求构建正则动量 $\\boldsymbol{p}^{1/2}$ 在半时间步 $t_{1/2} = t_{0} + \\Delta t/2$ 时的初始条件，而已知初始时刻 $t_{0}$ 的共动位置 $\\boldsymbol{x}_{0} = \\boldsymbol{x}(t_0)$ 和共动速度 $\\boldsymbol{v}_{0} = \\dot{\\boldsymbol{x}}(t_0)$。这个初始化是为时间对称的蛙跳积分器准备的，并且不得降低其固有的二阶精度。\n\n首先，我们建立给定的初始速度 $\\boldsymbol{v}(t_0)$ 和初始正则动量 $\\boldsymbol{p}(t_0)$ 之间的关系。题目将正则动量定义为 $\\boldsymbol{p} = a(t)^{2} \\dot{\\boldsymbol{x}}$，其中 $\\dot{\\boldsymbol{x}} = \\boldsymbol{v}$ 是共动速度。因此，在初始时刻 $t_0$，正则动量为：\n$$\n\\boldsymbol{p}(t_0) = a(t_0)^{2} \\boldsymbol{v}(t_0)\n$$\n蛙跳积分器在其标准的、内存高效的形式中，要求相空间变量在交错的时间网格上是已知的：位置 $\\boldsymbol{x}_{n}$ 在整数时间步 $t_n = t_0 + n \\Delta t$ 上，动量 $\\boldsymbol{p}_{n+1/2}$ 在半整数时间步 $t_{n+1/2} = t_0 + (n+1/2) \\Delta t$ 上。初始条件 $(\\boldsymbol{x}(t_0), \\boldsymbol{v}(t_0))$ 是在同一时刻 $t_0$ 同步的。为了启动蛙跳积分循环，我们必须从 $t_0$ 时刻的状态生成一个在半步处的动量 $\\boldsymbol{p}^{1/2} = \\boldsymbol{p}(t_0 + \\Delta t/2)$。\n\n正则动量的演化由 Hamilton 方程决定，如问题陈述中所提供：\n$$\n\\dot{\\boldsymbol{p}} = \\frac{d\\boldsymbol{p}}{dt} = - \\nabla_{\\boldsymbol{x}} \\phi(\\boldsymbol{x}, t)\n$$\n为了求出在时刻 $t_0 + \\Delta t/2$ 的动量，我们可以形式上将此运动方程从 $t_0$ 积分到 $t_0 + \\Delta t/2$：\n$$\n\\boldsymbol{p}(t_0 + \\Delta t/2) = \\boldsymbol{p}(t_0) + \\int_{t_0}^{t_0 + \\Delta t/2} \\dot{\\boldsymbol{p}}(t) dt = \\boldsymbol{p}(t_0) - \\int_{t_0}^{t_0 + \\Delta t/2} \\nabla_{\\boldsymbol{x}} \\phi(\\boldsymbol{x}(t), t) dt\n$$\n这个关系是精确的。然而，这个积分无法被精确计算，因为对于 $t \\in (t_0, t_0 + \\Delta t/2]$ 的轨迹 $\\boldsymbol{x}(t)$ 不是先验已知的。因此，我们必须对该积分进行近似。这个步骤就是问题中所指的“初始半步踢”。\n\n蛙跳方法达到二阶精度，意味着其在固定积分区间上的全局误差与 $\\mathcal{O}((\\Delta t)^2)$ 成正比。为确保初始化不降低此精度，这第一步引入的误差必须与整个方案的阶数相符。具体来说，在 $\\boldsymbol{p}^{1/2}$ 中引入的误差不能是 $\\mathcal{O}(\\Delta t)$ 阶的，因为这将主导全局误差，并将方法降至一阶。初始化误差必须是 $\\mathcal{O}((\\Delta t)^2)$ 或更高阶。\n\n让我们分析一个简单积分近似的误差。我们可以用被积函数 $\\nabla_{\\boldsymbol{x}} \\phi(\\boldsymbol{x}(t), t)$ 在积分区间起点 $t_0$ 的值来近似它。这对应于在长度为 $\\Delta t / 2$ 的区间上进行一阶 Euler 步（或数值积分中的左端点矩形法则）：\n$$\n\\int_{t_0}^{t_0 + \\Delta t/2} \\nabla_{\\boldsymbol{x}} \\phi(\\boldsymbol{x}(t), t) dt \\approx \\left(\\frac{\\Delta t}{2}\\right) \\nabla_{\\boldsymbol{x}} \\phi(\\boldsymbol{x}(t_0), t_0)\n$$\n这个积分近似的局部截断误差是 $\\mathcal{O}((\\Delta t)^2)$ 阶的。将此近似代入精确关系式，得到我们的 $\\boldsymbol{p}^{1/2}$ 表达式：\n$$\n\\boldsymbol{p}^{1/2} \\approx \\boldsymbol{p}(t_0) - \\frac{\\Delta t}{2} \\nabla_{\\boldsymbol{x}} \\phi(\\boldsymbol{x}(t_0), t_0)\n$$\n这个计算出的 $\\boldsymbol{p}^{1/2}$ 相对于真实值 $\\boldsymbol{p}(t_0 + \\Delta t/2)$ 的误差是 $\\mathcal{O}((\\Delta t)^2)$ 阶的。正则变量中的这个初始误差会导致哈密顿量（或任何影子哈密顿量）中出现 $\\mathcal{O}((\\Delta t)^2)$ 阶的初始误差。这与二阶积分器的全局误差是一致的，后者在固定时间内累积到 $\\mathcal{O}((\\Delta t)^2)$。因此，一个局部误差为 $\\mathcal{O}((\\Delta t)^2)$ 的初始化步骤不会降低蛙跳方案的整体二阶精度。这个过程对于启动交错时间步积分器是标准操作。\n\n最后，我们用问题陈述中指定的量来表示结果：$a(t_{0})$、$\\boldsymbol{v}(t_{0})$、$\\nabla_{\\boldsymbol{x}} \\phi(\\boldsymbol{x}(t_{0}), t_{0})$ 和 $\\Delta t$。将 $\\boldsymbol{p}(t_0) = a(t_0)^{2} \\boldsymbol{v}(t_0)$ 代入我们的 $\\boldsymbol{p}^{1/2}$ 表达式，得到最终答案。\n$$\n\\boldsymbol{p}^{1/2} = a(t_0)^{2} \\boldsymbol{v}(t_0) - \\frac{\\Delta t}{2} \\nabla_{\\boldsymbol{x}} \\phi(\\boldsymbol{x}(t_0), t_0)\n$$\n这就是所求的初始半步动量的闭式解析表达式。",
            "answer": "$$\n\\boxed{a(t_{0})^{2} \\boldsymbol{v}(t_{0}) - \\frac{\\Delta t}{2} \\nabla_{\\boldsymbol{x}} \\phi(\\boldsymbol{x}(t_{0}), t_{0})}\n$$"
        },
        {
            "introduction": "在宇宙学背景下，由于宇宙膨胀，引力通常显式地依赖于时间。本练习通过一个具体的编码任务，揭示了在处理这种时变力时正确实现蛙跳格式的重要性。你将通过构建一个反例来量化一个“幼稚”的、非时间对称的力计算方法所引入的系统性偏差，从而深刻理解为何时间中心化的“踢”对于获得准确的宇宙学演化至关重要。",
            "id": "3501452",
            "problem": "考虑一个在共动坐标系下的 Einstein–de Sitter 宇宙（仅含物质，宇宙学常数为零），并使用标度因子 $a$ 作为自变量。哈勃参数的标度关系为 $H(a) = H_0 a^{-3/2}$，其中 $H_0$ 是一个常数。考虑一个单一平面波密度微扰的线性区域，其密度对比为 $\\delta(\\boldsymbol{x},a) = \\delta_0 D(a) \\cos(k x)$，其中 $D(a)$ 是线性增长因子，$k$ 是波数。在这样的宇宙中，线性理论增长因子为 $D(a) = a$，共动引力势 $\\Phi$ 满足泊松方程 $\\nabla^2 \\Phi = 4 \\pi G a^2 \\bar{\\rho}(a) \\delta(\\boldsymbol{x},a)$。在梯度大小最大的固定空间相位处，共动引力加速度大小的标度关系为 $|\\nabla \\Phi|(a) \\propto a^2 D(a) = a^3$。\n\n在标准的宇宙学 $N$ 体构想中，可以采用由标度因子 $a$ 上的一阶系统所控制的正则动量 $p$ 和共动位置 $x$：\n$$\\frac{dx}{da} = \\frac{p}{a^3 H(a)}, \\qquad \\frac{dp}{da} = -\\frac{|\\nabla \\Phi|(a)}{a H(a)}.$$\n根据 Einstein–de Sitter 标度关系 $H(a) = H_0 a^{-3/2}$ 和 $|\\nabla \\Phi|(a) \\propto a^3$，踢（kick）权重函数的大小为\n$$W(a) \\equiv \\frac{|\\nabla \\Phi|(a)}{a H(a)} \\propto \\frac{a^3}{a \\cdot a^{-3/2}} = a^{7/2}.$$\n为了本题的目的，我们将所有常数（$H_0$、振幅和比例因子）归一化为1，从而得到 $W(a) = a^{7/2}$ 和 $H(a) = a^{-3/2}$。这种归一化使所有量都无量纲化；你的程序应报告无量纲浮点数。\n\n我们研究在有限区间 $[a_0,a_f]$ 上的踢-漂移-踢（KDK）形式的蛙跳格式，该区间被划分为 $N$ 个大小为 $\\Delta a = (a_f - a_0)/N$ 的均匀步长。记步长端点为 $a_n = a_0 + n \\Delta a$，中点为 $a_{n+1/2} = (a_n + a_{n+1})/2$。对于每一步，正则动量通过两次踢（kick）更新，位置通过一次漂移（drift）更新：\n- 踢-1：将 $p$ 推进 $\\frac{\\Delta a}{2} W(a_{\\mathrm{eval},1})$，\n- 漂移：将 $x$ 推进 $\\mathcal{F}_{\\mathrm{drift}}(a_n,a_{n+1}) \\, p_{\\text{half}}$，其中\n$$\\mathcal{F}_{\\mathrm{drift}}(a_n,a_{n+1}) = \\int_{a_n}^{a_{n+1}} \\frac{da}{a^3 H(a)} = \\int_{a_n}^{a_{n+1}} a^{-3/2} \\, da = 2\\left(a_n^{-1/2} - a_{n+1}^{-1/2}\\right),$$\n- 踢-2：将 $p$ 推进 $\\frac{\\Delta a}{2} W(a_{\\mathrm{eval},2})$。\n\n我们比较两种 KDK 变体：\n1. 朴素的步初作用力：两次踢都在步长的开始处计算作用力，即 $a_{\\mathrm{eval},1} = a_n$ 和 $a_{\\mathrm{eval},2} = a_n$。\n2. 时间中心（对称）：两次踢分别在步长的开始和结束处计算作用力，即 $a_{\\mathrm{eval},1} = a_n$ 和 $a_{\\mathrm{eval},2} = a_{n+1}$。\n\n我们构建一个反例初始条件，在该条件下，朴素的步初作用力 KDK 会以一个可预测的因子低估线性增长。在势梯度大小最大的空间位置初始化一个粒子，其初始条件为\n$$x(a_0) = 0, \\quad p\\left(a_0 - \\frac{\\Delta a}{2}\\right) = 0.$$\n在这些条件下，$[a_0,a_f]$ 区间上 $x$ 的全部增长都源于累积的踢和随后的漂移。由于 $W(a) = a^{7/2}$ 随 $a$ 单调递增，与时间中心格式相比，朴素的步初作用力 KDK 低估了每一步的平均踢。每一步的动量增量比率为\n$$R_n = \\frac{\\Delta a \\, W(a_n)}{\\frac{\\Delta a}{2}\\left[W(a_n) + W(a_{n+1})\\right]} = \\frac{2}{1 + \\left(\\frac{a_{n+1}}{a_n}\\right)^{7/2}},$$\n并且累积动量的总低估因子为 $\\prod_{n=0}^{N-1} R_n$。由于两种格式都使用相同的精确漂移积分，且 $x$ 对半步动量是线性的，最终位置 $x(a_f)$ 实质上继承了相同的乘性偏差，使得该比率\n$$\\mathcal{B}(a_0,a_f,N) \\equiv \\frac{x_{\\text{naive}}(a_f)}{x_{\\text{centered}}(a_f)} \\approx \\prod_{n=0}^{N-1} \\frac{2}{1 + \\left(\\frac{a_{n+1}}{a_n}\\right)^{7/2}}.$$\n你的任务：\n- 针对具有 $W(a) = a^{7/2}$ 和 $H(a) = a^{-3/2}$ 的归一化模型，实现上述两种 KDK 变体，使用精确的漂移积分 $\\mathcal{F}_{\\mathrm{drift}}(a_n,a_{n+1})$ 以及每步两次踢（含 $\\frac{\\Delta a}{2}$ 因子）的规则。\n- 使用指定的初始条件 $x(a_0) = 0$ 和 $p\\left(a_0 - \\frac{\\Delta a}{2}\\right) = 0$。\n- 对于每个测试用例，计算并返回无量纲浮点数 $\\mathcal{B}(a_0,a_f,N) = x_{\\text{naive}}(a_f) / x_{\\text{centered}}(a_f)$。\n\n测试套件：\n- 用例 1（正常路径）：$a_0 = 0.1$，$a_f = 1.0$，$N = 10$。\n- 用例 2（单个大步长边界）：$a_0 = 0.1$，$a_f = 1.0$，$N = 1$。\n- 用例 3（多个小步长边缘）：$a_0 = 0.1$，$a_f = 1.0$，$N = 1000$。\n- 用例 4（短最终区间）：$a_0 = 0.9$，$a_f = 1.0$，$N = 10$。\n- 用例 5（小区间）：$a_0 = 0.1$，$a_f = 0.2$，$N = 10$。\n\n最终输出格式：\n你的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，按测试用例的顺序排列结果：$[\\mathcal{B}_1,\\mathcal{B}_2,\\mathcal{B}_3,\\mathcal{B}_4,\\mathcal{B}_5]$。每个条目必须是一个无量纲浮点数。",
            "solution": "该问题是有效的。它提出了一个定义明确的数值任务，该任务基于物理宇宙学中一个简化但标准的模型。控制方程、数值格式和初始条件都得到了完整且一致的指定，从而可以得到唯一解。关于动量微分方程 $\\frac{dp}{da} = -\\frac{|\\nabla \\Phi|(a)}{a H(a)}$ 中符号的微妙歧义，通过“将 $p$ 推进”一个正量的明确无误的算法规则得以解决，该规则将此问题的动力学定义为 $\\frac{dp}{da} = W(a)$。\n\n该问题要求为膨胀宇宙中的一个粒子实现并比较两种踢-漂移-踢（KDK）蛙跳积分格式的变体。粒子的动力学由一个关于标度因子 $a$ 的一阶常微分方程组描述：\n$$\n\\frac{dx}{da} = \\frac{p}{a^3 H(a)}\n$$\n$$\n\\frac{dp}{da} = W(a)\n$$\n根据为哈勃参数 $H(a)$ 和踢权重函数 $W(a)$ 指定的归一化，这些方程变为：\n$$\n\\frac{dx}{da} = \\frac{p}{a^3 a^{-3/2}} = \\frac{p}{a^{3/2}}\n$$\n$$\n\\frac{dp}{da} = a^{7/2}\n$$\nKDK 蛙跳算法是一种二阶精确的辛积分器，适用于哈密顿系统。它在交错时间网格上运行，其中位置 $x$ 在整数步 $a_n$ 上已知，正则动量 $p$ 在半整数步 $a_{n \\pm 1/2}$ 上已知。区间 $[a_0, a_f]$ 被划分为 $N$ 个大小为 $\\Delta a = (a_f - a_0) / N$ 的步长。从 $a_n$ 到 $a_{n+1}$ 的一个积分步将状态 $(x_n, p_{n-1/2})$ 更新为 $(x_{n+1}, p_{n+1/2})$，过程如下：\n\n1. **第一次踢（半步）：** 动量从时间 $a_{n-1/2} = a_n - \\Delta a / 2$ 推进到整数步时间 $a_n$。这对应于对 $\\frac{dp}{da}$ 进行半步积分。更新规则是：\n$$p_n = p_{n-1/2} + \\frac{\\Delta a}{2} W(a_{\\text{eval},1})$$\n其中 $p_n$ 是时间 $a_n$ 处的动量。\n\n2. **漂移（全步）：** 位置从 $a_n$ 推进到 $a_{n+1}$。这涉及到在整个步长上对 $\\frac{dx}{da}$ 进行积分，使用区间时间中点的动量 $p_n$。问题提供了漂移方程中随时间变化部分的精确积分：\n$$\n\\mathcal{F}_{\\text{drift}}(a_n, a_{n+1}) = \\int_{a_n}^{a_{n+1}} \\frac{da}{a^3 H(a)} = \\int_{a_n}^{a_{n+1}} a^{-3/2} \\, da = 2\\left(a_n^{-1/2} - a_{n+1}^{-1/2}\\right)\n$$\n那么位置更新为：\n$$x_{n+1} = x_n + p_n \\mathcal{F}_{\\text{drift}}(a_n, a_{n+1})$$\n\n3. **第二次踢（半步）：** 动量从 $a_n$ 推进到下一个半步 $a_{n+1/2}$。这完成了从 $a_{n-1/2}$ 到 $a_{n+1/2}$ 整个步长的动量更新：\n$$p_{n+1/2} = p_n + \\frac{\\Delta a}{2} W(a_{\\text{eval},2})$$\n\nKDK 格式的两种变体通过其对踢函数 $W(a)$ 求值点的选择来区分：\n- **朴素的步初作用力：** 此格式在步长开始时为两次踢计算踢权重函数 $W(a)$：$a_{\\text{eval},1} = a_n$ 和 $a_{\\text{eval},2} = a_n$。这使得该步长的总动量更新为 $\\Delta p_n = p_{n+1/2} - p_{n-1/2} = \\Delta a \\cdot W(a_n)$。\n- **时间中心（对称）：** 此格式分别在步长区间的开始和结束处计算踢权重函数：$a_{\\text{eval},1} = a_n$ 和 $a_{\\text{eval},2} = a_{n+1}$。总动量更新为 $\\Delta p_n = \\frac{\\Delta a}{2} [W(a_n) + W(a_{n+1})]$。这是对踢的梯形法则积分，并保持二阶精度。\n\n初始条件给出为 $x(a_0) = 0$ 和 $p(a_0 - \\Delta a / 2) = 0$。在我们的离散形式中，这些对应于 $x_0 = 0$ 和 $p_{-1/2} = 0$。\n\n计算比率 $\\mathcal{B}(a_0, a_f, N) = x_{\\text{naive}}(a_f) / x_{\\text{centered}}(a_f)$ 的算法如下：\n对于每个测试用例 $(a_0, a_f, N)$：\n1. 实现一个执行 KDK 积分的函数。此函数以 $a_0, a_f, N$ 和格式类型（‘naive’ 或 ‘centered’）作为输入。\n2. 在函数内部，初始化 $x = 0$ 和半步动量 $p_{\\text{half}} = 0$。\n3. 对 $n$ 从 $0$ 到 $N-1$ 进行循环：\n    a. 计算当前和下一个标度因子，$a_n = a_0 + n \\Delta a$ 和 $a_{n+1} = a_n + \\Delta a$。\n    b. 根据格式设置求值点 $a_{\\text{eval},1}$ 和 $a_{\\text{eval},2}$。\n    c. 执行第一次踢以获得 $p_n$。\n    d. 执行全步漂移以将 $x$ 更新为 $x_{n+1}$。\n    e. 执行第二次踢以将 $p_{\\text{half}}$ 更新为 $p_{n+1/2}$。\n4. 循环结束后，$x$ 的最终值就是该格式的结果 $x(a_f)$。\n5. 对‘naive’格式调用一次此函数以获得 $x_{\\text{naive}}(a_f)$，对‘centered’格式调用一次以获得 $x_{\\text{centered}}(a_f)$。\n6. 计算并存储比率 $\\mathcal{B} = x_{\\text{naive}}(a_f) / x_{\\text{centered}}(a_f)$。\n7. 收集所有测试用例的比率，并按指定格式化输出。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem by implementing two variants of the KDK leapfrog scheme\n    and computing the ratio of their final positions for a set of test cases.\n    \"\"\"\n\n    def W(a):\n        \"\"\"\n        The normalized kick weight function W(a) = a^(7/2).\n        \"\"\"\n        return a**3.5\n\n    def F_drift(a_n, a_np1):\n        \"\"\"\n        The exact drift factor integral from a_n to a_{n+1}.\n        \"\"\"\n        return 2.0 * (a_n**-0.5 - a_np1**-0.5)\n\n    def kdk_integrator(a0, af, N, scheme):\n        \"\"\"\n        Performs the KDK integration for a given scheme.\n\n        Args:\n            a0 (float): The initial scale factor.\n            af (float): The final scale factor.\n            N (int): The number of integration steps.\n            scheme (str): The integration scheme, either 'naive' or 'centered'.\n\n        Returns:\n            float: The final position x(af).\n        \"\"\"\n        delta_a = (af - a0) / N\n\n        # Initial conditions: x(a0) = 0, p(a0 - delta_a/2) = 0\n        x = 0.0\n        p_half_step = 0.0\n\n        for n in range(N):\n            a_n = a0 + n * delta_a\n            a_np1 = a_n + delta_a\n\n            # Determine evaluation points for the kick function W(a)\n            if scheme == 'naive':\n                a_eval1 = a_n\n                a_eval2 = a_n\n            elif scheme == 'centered':\n                a_eval1 = a_n\n                a_eval2 = a_np1\n            else:\n                raise ValueError(\"Unknown scheme specified.\")\n\n            # 1. First Kick (advances p from a_{n-1/2} to a_n)\n            p_full_step = p_half_step + (delta_a / 2.0) * W(a_eval1)\n\n            # 2. Drift (advances x from a_n to a_{n+1} using p at a_n)\n            x = x + F_drift(a_n, a_np1) * p_full_step\n\n            # 3. Second Kick (advances p from a_n to a_{n+1/2})\n            p_half_step = p_full_step + (delta_a / 2.0) * W(a_eval2)\n\n        return x\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (a0, af, N)\n        (0.1, 1.0, 10),     # Case 1\n        (0.1, 1.0, 1),      # Case 2\n        (0.1, 1.0, 1000),   # Case 3\n        (0.9, 1.0, 10),     # Case 4\n        (0.1, 0.2, 10),     # Case 5\n    ]\n\n    results = []\n    for a0, af, N in test_cases:\n        x_naive = kdk_integrator(a0, af, N, 'naive')\n        x_centered = kdk_integrator(a0, af, N, 'centered')\n\n        # The problem setup ensures x_centered is non-zero.\n        ratio = x_naive / x_centered\n        results.append(ratio)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}