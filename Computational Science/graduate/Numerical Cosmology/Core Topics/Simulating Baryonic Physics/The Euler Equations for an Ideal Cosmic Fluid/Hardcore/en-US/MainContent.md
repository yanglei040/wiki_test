## Introduction
The evolution of matter in the universe, from a smooth early state to the intricate [cosmic web](@entry_id:162042) we see today, is largely governed by the interplay of gravity and fluid dynamics. The Euler equations for an [ideal fluid](@entry_id:272764) provide a powerful and essential framework for modeling the behavior of cosmic gas and dark matter on vast scales. However, applying these classical equations to an expanding cosmological background presents unique challenges and introduces new physical phenomena not seen in terrestrial settings. This article serves as a comprehensive guide to understanding and applying the Euler equations in modern [numerical cosmology](@entry_id:752779).

We will begin in the "Principles and Mechanisms" chapter by deriving the fundamental equations and transforming them into the [comoving coordinates](@entry_id:271238) essential for cosmology, revealing the effects of Hubble expansion. We will then explore the key physical outcomes, such as the Jeans instability that drives [structure formation](@entry_id:158241), and discuss the core principles of numerical implementation. Next, the "Applications and Interdisciplinary Connections" chapter will demonstrate how this framework is used to explain observable phenomena, including [the thermal history of the universe](@entry_id:204719), the coupled evolution of baryons and dark matter, and the physics of [astrophysical shocks](@entry_id:184006). Finally, in "Hands-On Practices", you will have the opportunity to engage with the material directly through targeted computational problems that build practical skills in [numerical hydrodynamics](@entry_id:752794). By the end, you will have a robust understanding of the theory, application, and numerical practice behind one of the cornerstones of [computational cosmology](@entry_id:747605).

## Principles and Mechanisms

This chapter elucidates the fundamental principles and governing mechanisms of an ideal cosmic fluid. We begin by formulating the Euler equations in a standard inertial frame, establishing the physical basis of the model. We then undertake the crucial transformation of these equations into [comoving coordinates](@entry_id:271238), which are naturally suited to an expanding cosmological background. This transformation reveals new terms that account for the effects of [cosmic expansion](@entry_id:161002), such as Hubble drag and the work done by the expansion. With the governing equations in place, we will explore the key physical phenomena they describe, including the Jeans instability—the primary engine of [structure formation](@entry_id:158241)—and the decay of [vorticity](@entry_id:142747). Subsequently, we will bridge the gap between continuum theory and numerical practice, discussing the principles of [discretization](@entry_id:145012), the choice of variables, boundary conditions, and the critical concept of a well-balanced numerical scheme. Finally, we will place the ideal fluid model in a broader context by connecting it to the more fundamental description of a collisionless gas provided by kinetic theory, thereby clarifying the model's domain of validity and the physical nature of its parameters.

### The Euler Equations for a Self-Gravitating Ideal Fluid

The starting point for describing a cosmic fluid in the Newtonian approximation is the set of Euler equations for a self-gravitating, compressible, and non-viscous fluid. These equations represent [local conservation](@entry_id:751393) laws for mass and momentum, supplemented by a law for the gravitational field. In physical (non-comoving) coordinates $\boldsymbol{r}$, for a fluid with mass density $\rho$, velocity $\boldsymbol{v}$, and [isotropic pressure](@entry_id:269937) $P$, the equations are as follows :

1.  **Continuity Equation (Mass Conservation):**
    $$ \frac{\partial \rho}{\partial t} + \boldsymbol{\nabla} \cdot (\rho \boldsymbol{v}) = 0 $$
    This equation states that the local rate of change of mass density is balanced by the divergence of the mass flux, $\rho \boldsymbol{v}$.

2.  **Momentum Equation (Euler's Equation):**
    $$ \frac{\partial (\rho \boldsymbol{v})}{\partial t} + \boldsymbol{\nabla} \cdot (\rho \boldsymbol{v} \otimes \boldsymbol{v} + P \mathbf{I}) = -\rho \boldsymbol{\nabla} \Phi $$
    This is Newton's second law applied to a fluid element. The left-hand side describes the rate of change of momentum density. The term $\boldsymbol{\nabla} \cdot (\rho \boldsymbol{v} \otimes \boldsymbol{v})$ represents the advection of momentum, while $\boldsymbol{\nabla} \cdot (P \mathbf{I}) = \boldsymbol{\nabla} P$ is the force due to pressure gradients. The right-hand side, $-\rho \boldsymbol{\nabla} \Phi$, is the gravitational force density, where $\Phi$ is the [gravitational potential](@entry_id:160378).

3.  **Poisson's Equation (Gravitational Field):**
    $$ \nabla^2 \Phi = 4 \pi G \rho $$
    This equation provides the gravitational closure, stating that the mass density $\rho$ acts as the source for the Newtonian gravitational potential $\Phi$, with $G$ being the [gravitational constant](@entry_id:262704).

These equations describe an **ideal fluid**. This idealization is based on two critical assumptions: the absence of viscous stresses and the absence of [heat conduction](@entry_id:143509). In a real fluid, the internal forces are described by the Cauchy stress tensor, which can be decomposed into an [isotropic pressure](@entry_id:269937) part and a [viscous stress](@entry_id:261328) tensor that depends on velocity gradients. The ideal fluid model assumes this [viscous stress](@entry_id:261328) is zero. Similarly, it assumes the heat flux vector is zero, meaning there is no thermal energy transfer via conduction. For the large scales and low densities typical of cosmic fluids, these assumptions are often an excellent approximation, as collisional mean free paths are extremely long .

To close this system of equations, a relationship between pressure and density is required, known as the **equation of state**. For many cosmological applications, an ideal gas law is assumed, where the pressure is related to the internal energy density $e$ by $P = (\gamma - 1)e$, with $\gamma$ being the **adiabatic index**. For an [adiabatic process](@entry_id:138150) (one with no heat exchange with the surroundings), this leads to a simple power-law relationship between pressure and density: $P = K \rho^\gamma$, where $K$ is a constant determined by the specific entropy of the fluid. A fluid for which pressure is solely a function of density, $P = P(\rho)$, is called **barotropic**. The adiabatic relation is a specific case of a [barotropic equation of state](@entry_id:746677). The speed at which pressure waves propagate through the fluid, the **adiabatic sound speed** $c_s$, is then given by $c_s^2 = (\partial P / \partial \rho)_s = \gamma P / \rho$ .

The barotropic assumption, while powerful, breaks down in the presence of [non-adiabatic processes](@entry_id:164915). Shock waves, which are common during [gravitational collapse](@entry_id:161275), are inherently entropy-generating and thus non-adiabatic. Likewise, radiative processes such as cooling from atomic [line emission](@entry_id:161645) or heating from a background of ultraviolet photons change the entropy of the fluid. In realistic simulations of galaxy formation, these effects are crucial, and the fluid is decidedly non-barotropic. In such cases, one cannot rely on a simple $P(\rho)$ relation and must explicitly solve an [energy conservation equation](@entry_id:748978) .

### The Comoving Frame: Adapting Equations for Cosmic Expansion

While the physical Euler equations are fundamental, they are inconvenient for cosmology because they do not explicitly account for the homogeneous [expansion of the universe](@entry_id:160481). To study the growth of structures relative to the general expansion, we transform the equations into a **comoving coordinate system**. A comoving coordinate $\boldsymbol{x}$ is related to the physical coordinate $\boldsymbol{r}$ by the cosmological [scale factor](@entry_id:157673) $a(t)$:
$$ \boldsymbol{r} = a(t) \boldsymbol{x} $$
A fluid element's physical velocity $\boldsymbol{v} = \dot{\boldsymbol{r}}$ can be decomposed into the **Hubble flow**, $H\boldsymbol{r}$, and a **[peculiar velocity](@entry_id:157964)**, $\boldsymbol{u}$, which represents motion relative to the Hubble flow. The Hubble parameter is $H(t) = \dot{a}(t)/a(t)$. This decomposition is:
$$ \boldsymbol{v}(t) = H(t)\boldsymbol{r}(t) + \boldsymbol{u}(\boldsymbol{x}, t) = \dot{a}(t)\boldsymbol{x} + a(t)\dot{\boldsymbol{x}} $$
From this, we see the peculiar velocity is related to the time derivative of the comoving coordinate by $\boldsymbol{u} = a \dot{\boldsymbol{x}}$.

To formulate a conservative numerical scheme, it is advantageous to define comoving density and energy variables. The **comoving mass density** $\rho_c$ and **physical mass density** $\rho_p$ are related by $\rho_c = a^3 \rho_p$, which keeps the mass in a comoving volume constant. For clarity, we will hereafter drop the subscripts and use $\rho$ for the comoving density and $P$ for the corresponding comoving pressure. The vector of [conserved variables](@entry_id:747720) in one dimension is $U = (\rho, \rho u, E)$, where $E$ is the comoving total energy density, $E = \rho e + \frac{1}{2}\rho u^2$, with $e$ being the specific internal energy.

Transforming the conservation laws into these comoving variables is a detailed but essential exercise. The result is a system of equations in the form $\partial_t U + \frac{1}{a} \partial_x F(U) = S(U, t)$, where $F(U)$ is the flux vector and $S(U, t)$ is a vector of source terms arising from the expansion and gravity. In one dimension, these are :

-   **State Vector:** $U = \begin{pmatrix} \rho \\ \rho u \\ E \end{pmatrix}$

-   **Flux Vector:** $F(U) = \begin{pmatrix} \rho u \\ \rho u^2 + P \\ u(E+P) \end{pmatrix}$

-   **Source Vector:** $S(U, t) = \begin{pmatrix} 0 \\ -H \rho u - \frac{\rho}{a} \frac{\partial \Phi}{\partial x} \\ -H(3E+P) - \frac{\rho u}{a} \frac{\partial \Phi}{\partial x} \end{pmatrix}$

Several crucial features emerge from this transformation. The continuity equation for the comoving density has no [source term](@entry_id:269111), reflecting [mass conservation](@entry_id:204015) in a comoving volume. The momentum equation acquires a **Hubble drag** term, $-H\rho u$, which acts to damp peculiar velocities as the universe expands. The [energy equation](@entry_id:156281) gains a source term, $-H(3E+P)$, which accounts for the [thermodynamic work](@entry_id:137272) done by the fluid as it expands, and a term for the work done by gravity. The spatial derivatives of fluxes are scaled by $1/a$, which arises from the transformation of the [divergence operator](@entry_id:265975) from physical to [comoving coordinates](@entry_id:271238).

### Gravitational Closure and Perturbation Growth

The [gravitational force](@entry_id:175476) in the [comoving frame](@entry_id:266800) is sourced by density inhomogeneities. We describe the density field as a homogeneous background density $\bar{\rho}_p(t)$ plus a perturbation $\delta\rho_p$. The dimensionless **[density contrast](@entry_id:157948)** is $\delta = \delta\rho_p / \bar{\rho}_p = (\rho_p - \bar{\rho}_p)/\bar{\rho}_p$. This [density contrast](@entry_id:157948) sources a peculiar gravitational potential $\phi$. The standard physical Poisson equation, $\nabla_r^2 \phi = 4\pi G \delta\rho_p$, must be transformed into [comoving coordinates](@entry_id:271238). Using the relation between physical and comoving Laplacians, $\nabla_r^2 = a^{-2} \nabla_x^2$, we arrive at the **comoving Poisson equation** :
$$ \nabla_x^2 \phi = 4\pi G a^2 \bar{\rho}_p(t) \delta(\boldsymbol{x}, t) $$
The factor of $a^2$ is a critical consequence of the [coordinate transformation](@entry_id:138577). In Fourier space, where a field is decomposed into [plane waves](@entry_id:189798) $e^{i\boldsymbol{k}\cdot\boldsymbol{x}}$, the Laplacian becomes multiplication by $-k^2$, where $k=|\boldsymbol{k}|$ is the comoving [wavenumber](@entry_id:172452). The Poisson equation then becomes an algebraic relation:
$$ \phi_{\boldsymbol{k}}(t) = -\frac{4\pi G a^2 \bar{\rho}_p(t)}{k^2} \delta_{\boldsymbol{k}}(t) $$
This form is exceptionally useful for both theoretical analysis and numerical methods that employ Fourier transforms.

With the full set of comoving equations, we can analyze the behavior of small perturbations. By linearizing the continuity, Euler, and Poisson equations, one can derive a single second-order ordinary differential equation for the evolution of a single Fourier mode of the [density contrast](@entry_id:157948), $\delta_{\boldsymbol{k}}$ :
$$ \ddot{\delta}_{\boldsymbol{k}} + 2H \dot{\delta}_{\boldsymbol{k}} + \left( \frac{c_s^2 k^2}{a^2} - 4\pi G \bar{\rho}_p \right) \delta_{\boldsymbol{k}} = 0 $$
This is the [master equation](@entry_id:142959) for the [growth of structure](@entry_id:158527) in a cosmic fluid. It describes a damped harmonic oscillator. The $2H\dot{\delta}_{\boldsymbol{k}}$ term is the Hubble friction, which slows down the growth of perturbations. The final term encapsulates the competition between pressure and gravity.
-   The term $\frac{c_s^2 k^2}{a^2}$ represents a restoring force due to pressure gradients. Note that $k/a$ is the physical [wavenumber](@entry_id:172452).
-   The term $-4\pi G \bar{\rho}_p$ represents the destabilizing force of self-gravity, which seeks to amplify [density fluctuations](@entry_id:143540).

The behavior of a perturbation depends on the sign of the effective frequency term in the parenthesis. The scale that separates these two regimes is the **Jeans scale**. The corresponding comoving [wavenumber](@entry_id:172452), the **Jeans [wavenumber](@entry_id:172452)** $k_J$, is found by setting the term to zero:
$$ k_J(a) = a \sqrt{\frac{4\pi G \bar{\rho}_p}{c_s^2}} $$
For modes with $k  k_J$ (wavelengths larger than the Jeans length $\lambda_J = 2\pi/k_J$), the gravitational term dominates, the effective frequency is imaginary, and perturbations experience exponential growth. This is the **Jeans instability**. For modes with $k > k_J$ (wavelengths smaller than the Jeans length), the pressure term dominates, and the perturbations propagate as stable **[acoustic oscillations](@entry_id:161154)** . This mechanism is the foundation of [cosmic structure formation](@entry_id:137761), explaining how small primordial [density fluctuations](@entry_id:143540) grow into the large-scale structures we observe today.

Another important physical consequence of the comoving equations is the evolution of **[vorticity](@entry_id:142747)**, $\boldsymbol{\omega} = \boldsymbol{\nabla} \times \boldsymbol{u}$. In the linear regime, where non-[linear advection](@entry_id:636928) is negligible, the [vorticity](@entry_id:142747) of an ideal barotropic fluid evolves simply according to $\partial_t \boldsymbol{\omega} + H(t) \boldsymbol{\omega} = 0$. In a matter-dominated (Einstein-de Sitter) universe, where $a(t) \propto t^{2/3}$ and $H(t) = 2/(3t)$, this equation can be solved to show that the magnitude of the vorticity decays as $\omega \propto a^{-1}$ . This demonstrates that cosmic expansion effectively [damps](@entry_id:143944) [rotational motion](@entry_id:172639), a result of [angular momentum conservation](@entry_id:156798) in an expanding frame. This is why large-scale cosmic flows are expected to be nearly irrotational.

### Principles of Numerical Implementation

Solving the comoving Euler equations for realistic structure formation requires numerical methods. Modern cosmological codes, particularly those using finite-volume or finite-difference methods, evolve a set of variables on a discrete grid.

A key practical aspect is the choice of variables. The equations are often solved for the **conservative variables** $(\rho, \boldsymbol{m}, E)$, where $\boldsymbol{m}=\rho\boldsymbol{u}$ is the momentum density, because this formulation naturally ensures that mass, momentum, and energy are conserved at the discrete level. However, to calculate the fluxes (e.g., $P$) and source terms, one needs the **primitive variables** $(\rho, \boldsymbol{u}, P)$. This necessitates efficient and robust algebraic transformations between the two sets of variables at every step of a simulation . For example, given the conservative state $(\rho, m, E)$, one can recover the primitive variables via:
$$ u = \frac{m}{\rho} $$
$$ P = (\gamma-1) \left( E - \frac{1}{2}\frac{m^2}{\rho} \right) $$

A standard **[finite-volume method](@entry_id:167786)** updates the average value of a conserved quantity $U_i$ in a grid cell $i$ based on the fluxes across its faces and the action of source terms. For the comoving Euler equations on a 1D grid with spacing $\Delta x$, a simple first-order update from time $t^n$ to $t^{n+1}=t^n+\Delta t$ takes the form :
$$ \mathbf{U}_i^{n+1} = \mathbf{U}_i^n - \frac{\Delta t}{a^n \Delta x} \left( \mathbf{F}_{i+1/2}^n - \mathbf{F}_{i-1/2}^n \right) + \Delta t \, \mathbf{S}_i^n $$
Here, $\mathbf{F}_{i \pm 1/2}$ are the [numerical fluxes](@entry_id:752791) at the cell interfaces, often computed using a Riemann solver, and $\mathbf{S}_i^n$ is the discretized source term. The factor of $1/a^n$ in the flux term arises from the transformation of the spatial derivative from physical to [comoving coordinates](@entry_id:271238) ($\partial/\partial r = a^{-1} \partial/\partial x$).

Cosmological simulations typically model a representative volume of the universe. To avoid [edge effects](@entry_id:183162) and mimic an infinite universe, **[periodic boundary conditions](@entry_id:147809)** are employed. This means the simulation domain (e.g., a cube of side length $L$) is treated as a torus, where a fluid element exiting one face immediately re-enters through the opposite face with the same properties. Mathematically, this requires all fluid fields to be periodic: $\rho(\boldsymbol{x}+L\boldsymbol{e}_i, t) = \rho(\boldsymbol{x}, t)$, and similarly for $\boldsymbol{u}$ and $P$. When the Euler equations are integrated over the entire domain, the [divergence theorem](@entry_id:145271) implies that the rate of change of a globally conserved quantity (like total mass or momentum) is equal to the net flux through the boundary. With periodic conditions, the flux out of one face is precisely canceled by the flux into the opposite face, guaranteeing that global mass and momentum are conserved by the numerical scheme in the absence of external sources .

A critical challenge in [numerical cosmology](@entry_id:752779) is the accurate evolution of small perturbations on top of a dominant, evolving background. The homogeneous universe ($\boldsymbol{u}=\mathbf{0}, \delta=0$) is an exact solution to the comoving Euler equations. A numerical scheme is called **well-balanced** if it can preserve this exact solution to machine precision, without generating spurious velocities or density fluctuations due to [discretization errors](@entry_id:748522). This is not a trivial property. A naive discretization of fluxes and source terms will typically produce small but non-zero errors that can be amplified by [gravitational instability](@entry_id:160721), eventually overwhelming the true physical perturbations. Achieving a [well-balanced scheme](@entry_id:756693) requires a careful, consistent [discretization](@entry_id:145012) of fluxes and source terms so that they exactly cancel in the homogeneous case .

Finally, [numerical stability](@entry_id:146550) must also be ensured. The Jeans instability analysis provides a physical criterion that translates directly into a numerical one. To prevent artificial fragmentation—spurious collapse on the grid scale due to under-resolved pressure gradients—the local Jeans length must be resolved by a sufficient number of grid cells. This is known as the **Truelove condition**, which typically requires $\lambda_J / \Delta x \gtrsim 4$. Violating this condition means the numerical scheme cannot capture the pressure support that would physically prevent collapse, leading to unphysical results .

### Beyond the Ideal Fluid: A Kinetic Theory Perspective

The Euler equations provide a powerful macroscopic model, but their validity can be better understood by tracing their origins to the microscopic physics of the fluid particles. For cold dark matter (CDM), which is assumed to be collisionless, the fundamental description is not a fluid model but the **collisionless Boltzmann equation** (or Vlasov equation). This equation describes the evolution of the one-particle [phase-space distribution](@entry_id:151304) function, $f(\boldsymbol{x}, \boldsymbol{v}, t)$.

The fluid equations can be derived by taking velocity moments of the Vlasov equation. The zeroth moment (integrating $f$ over velocity) yields the continuity equation. The first moment (integrating $\boldsymbol{v}f$ over velocity) yields the momentum equation . This procedure reveals a profound connection: the term in the momentum equation corresponding to the pressure gradient emerges from the divergence of the [second central moment](@entry_id:200758) of the distribution function. This moment is the **velocity dispersion tensor**, $\sigma_{ij}^2$, which measures the spread of particle velocities around the mean [fluid velocity](@entry_id:267320).
$$ \Pi_{ij} = \rho \sigma_{ij}^2 $$
This tensor, $\Pi_{ij}$, is the kinetic [pressure tensor](@entry_id:147910). The full [momentum equation](@entry_id:197225) derived from the Vlasov equation includes a term $-\frac{1}{\rho}\boldsymbol{\nabla}\cdot\boldsymbol{\Pi}$.

This derivation clarifies the limitations of the [pressureless dust](@entry_id:269682) model ($P=0$) often used for CDM. This model is equivalent to assuming that the velocity distribution is a Dirac [delta function](@entry_id:273429) at every point—a "single-stream" flow with zero velocity dispersion. In the early universe, this is a good approximation. However, as structures collapse, different streams of dark matter particles begin to interpenetrate. At a single physical location, there can be multiple streams with different velocities. This "multi-stream" region is characterized by a non-zero velocity dispersion, $\sigma_{ij}^2 > 0$. Consequently, the effective [pressure tensor](@entry_id:147910) $\boldsymbol{\Pi}$ is non-zero, and its divergence provides a force that is absent in the simple pressureless model. In the case of an isotropic velocity distribution, this effective pressure becomes a scalar, $P_{\text{eff}} = \rho \sigma^2$, where $\sigma^2$ is the one-dimensional velocity dispersion. This "pressure" is not thermal; it is purely kinetic, arising from the [momentum transport](@entry_id:139628) of particles with random motions. The failure of the pressureless fluid model after shell-crossing is precisely its inability to account for this effective pressure from velocity dispersion .