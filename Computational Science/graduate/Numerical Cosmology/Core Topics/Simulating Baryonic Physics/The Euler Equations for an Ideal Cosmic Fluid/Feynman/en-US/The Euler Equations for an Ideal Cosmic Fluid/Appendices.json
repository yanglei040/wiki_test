{
    "hands_on_practices": [
        {
            "introduction": "Finite-volume hydrodynamics codes evolve a set of conserved quantities—mass, momentum, and total energy—within each grid cell. To compute the fluxes between cells and to understand the physical state of the fluid, however, we must convert these conserved variables into primitive variables like velocity and pressure. This first exercise provides practice in this fundamental transformation, which lies at the heart of every numerical solver for the Euler equations, and introduces the crucial check for physical admissibility of the resulting state .",
            "id": "3495179",
            "problem": "Consider a local finite-volume cell in a cosmological hydrodynamics simulation of an ideal cosmic fluid, advanced in physical time over a sufficiently small interval that Hubble expansion source terms can be neglected for the purpose of reconstructing primitive variables. The state is represented by the conserved variables mass density $\\rho$, momentum density $m$, and total energy density $E$, together with a constant adiabatic index $\\gamma$ appropriate for a monatomic ideal gas. You are provided the following physically plausible values at a given epoch: $\\rho = 1.0 \\times 10^{-24}\\ \\mathrm{g\\,cm^{-3}}$, $m = 3.0 \\times 10^{-17}\\ \\mathrm{g\\,cm^{-2}\\,s^{-1}}$, $E = 1.45 \\times 10^{-9}\\ \\mathrm{erg\\,cm^{-3}}$, and $\\gamma = 5/3$.\n\nStarting from the fundamental definitions in compressible fluid dynamics and thermodynamics suitable for the Euler equations:\n- Momentum density equals mass density times bulk velocity.\n- Total energy density equals the sum of internal energy density and kinetic energy density.\n- An ideal-gas closure relates pressure to internal energy density.\n- The adiabatic sound speed arises from small, isentropic compressions.\n\nDerive expressions for the bulk velocity $u$, internal energy density $e$, pressure $P$, and adiabatic sound speed $c_s$ in terms of the conserved variables $(\\rho, m, E)$ and $\\gamma$. Then evaluate these expressions using the provided numerical values. Finally, assess the physical admissibility of the state by checking the positivity of pressure through the condition $P > 0$.\n\nExpress $u$ and $c_s$ in $\\mathrm{cm\\,s^{-1}}$, and $e$ and $P$ in $\\mathrm{erg\\,cm^{-3}}$. Round your final numerical values for $(u, e, P, c_s)$ to four significant figures. The final answer must contain only the quartet $(u, e, P, c_s)$ presented together.",
            "solution": "The primitive variables $(u, e, P, c_s)$ are derived from the conserved variables $(\\rho, m, E)$ and the adiabatic index $\\gamma$ by inverting their fundamental definitions.\n\n**Derivation of Primitive Variables**\n\n1.  **Bulk Velocity ($u$)**: From the definition of momentum density, $m = \\rho u$, the velocity is:\n    $$u = \\frac{m}{\\rho}$$\n\n2.  **Internal Energy Density ($e$)**: The total energy density is the sum of internal and kinetic energy densities, $E = e + E_k$, where $E_k = \\frac{1}{2}\\rho u^2$. Substituting the expression for $u$ yields the kinetic energy density in terms of conserved variables: $E_k = \\frac{m^2}{2\\rho}$. Solving for the internal energy density gives:\n    $$e = E - E_k = E - \\frac{m^2}{2\\rho}$$\n\n3.  **Pressure ($P$)**: The ideal-gas equation of state (or closure relation) links pressure to internal energy: $P = (\\gamma - 1)e$. Substituting the expression for $e$:\n    $$P = (\\gamma - 1)\\left(E - \\frac{m^2}{2\\rho}\\right)$$\n\n4.  **Adiabatic Sound Speed ($c_s$)**: The sound speed is defined by $c_s^2 = \\frac{\\gamma P}{\\rho}$. Substituting the expression for $P$ gives:\n    $$c_s = \\sqrt{\\frac{\\gamma P}{\\rho}} = \\sqrt{\\frac{\\gamma(\\gamma-1)}{\\rho}\\left(E - \\frac{m^2}{2\\rho}\\right)}$$\n\n**Numerical Evaluation**\n\nWe substitute the provided values into these expressions:\n- $\\rho = 1.0 \\times 10^{-24}\\ \\mathrm{g\\,cm^{-3}}$\n- $m = 3.0 \\times 10^{-17}\\ \\mathrm{g\\,cm^{-2}\\,s^{-1}}$\n- $E = 1.45 \\times 10^{-9}\\ \\mathrm{erg\\,cm^{-3}}$\n- $\\gamma = 5/3$\n\n1.  **Calculate $u$**:\n    $$u = \\frac{3.0 \\times 10^{-17}}{1.0 \\times 10^{-24}} = 3.0 \\times 10^7\\ \\mathrm{cm\\,s^{-1}}$$\n\n2.  **Calculate $e$**: First, we find the kinetic energy density:\n    $$E_k = \\frac{(3.0 \\times 10^{-17})^2}{2(1.0 \\times 10^{-24})} = \\frac{9.0 \\times 10^{-34}}{2.0 \\times 10^{-24}} = 4.5 \\times 10^{-10}\\ \\mathrm{erg\\,cm^{-3}}$$\n    Then, we find the internal energy density:\n    $$e = E - E_k = (1.45 \\times 10^{-9}) - (4.5 \\times 10^{-10}) = 1.0 \\times 10^{-9}\\ \\mathrm{erg\\,cm^{-3}}$$\n\n3.  **Calculate $P$ and Assess Admissibility**:\n    $$P = \\left(\\frac{5}{3} - 1\\right) \\times (1.0 \\times 10^{-9}) = \\frac{2}{3} \\times 10^{-9} \\approx 6.667 \\times 10^{-10}\\ \\mathrm{erg\\,cm^{-3}}$$\n    Since $P > 0$, the state is physically admissible. This is equivalent to checking that total energy exceeds kinetic energy ($E > E_k$), which is true.\n\n4.  **Calculate $c_s$**:\n    $$c_s = \\sqrt{\\frac{(5/3) \\times (\\frac{2}{3} \\times 10^{-9})}{1.0 \\times 10^{-24}}} = \\sqrt{\\frac{10}{9} \\times 10^{15}} = \\frac{10}{3} \\times 10^7 \\approx 3.333 \\times 10^7\\ \\mathrm{cm\\,s^{-1}}$$\n\nRounding to four significant figures, the final results are:\n$u = 3.000 \\times 10^7\\ \\mathrm{cm\\,s^{-1}}$\n$e = 1.000 \\times 10^{-9}\\ \\mathrm{erg\\,cm^{-3}}$\n$P = 6.667 \\times 10^{-10}\\ \\mathrm{erg\\,cm^{-3}}$\n$c_s = 3.333 \\times 10^7\\ \\mathrm{cm\\,s^{-1}}$",
            "answer": "$$\\boxed{\\begin{pmatrix} 3.000 \\times 10^7  1.000 \\times 10^{-9}  6.667 \\times 10^{-10}  3.333 \\times 10^7 \\end{pmatrix}}$$"
        },
        {
            "introduction": "While the conversion from conserved to primitive variables is straightforward analytically, it is numerically fragile in certain physical regimes, such as the near-vacuum conditions found in cosmic voids. In these low-density, high-velocity environments, the total energy $E$ may be only slightly larger than the kinetic energy $\\frac{1}{2}\\rho u^2$, leading to catastrophic cancellation when calculating the small internal energy. This coding practice demonstrates how to build a robust recovery scheme using density and pressure floors to guarantee positivity and ensure the stability of a simulation in these challenging, yet common, cosmological scenarios .",
            "id": "3495161",
            "problem": "Consider a one-dimensional ideal cosmic fluid in comoving coordinates, modeled by the Euler equations for a compressible gas with a gamma-law Equation of State (EOS). The primitive variables are the comoving mass density $\\rho$, the peculiar velocity $u$, and the thermal pressure $P$. The conserved variables are defined by $D=\\rho$, $S=\\rho u$, and $E$, the total comoving energy density, which includes internal and kinetic contributions. The gamma-law EOS for an ideal gas states $P=(\\gamma-1)U$, where $U$ is the internal energy density and $\\gamma$ is the adiabatic index. In the Euler system, the conserved total energy density satisfies $E=U+\\frac{1}{2}\\rho u^2$.\n\nIn numerical cosmology, near-vacuum regions can form due to cosmic void expansion, often characterized by an extreme negative density contrast $\\delta\\to -1$, where $\\delta$ is defined as $\\delta = (\\rho - \\bar{\\rho})/\\bar{\\rho}$ and $\\bar{\\rho}$ is the background density. In such regimes, robust recovery of primitive variables from conserved variables must ensure $\\rho0$ and $P0$, despite extreme round-off and cancellation in $E - \\frac{1}{2}\\rho u^2$.\n\nStarting from the fundamental definitions above and the gamma-law EOS for an ideal gas, derive a positivity-preserving primitive-variable recovery mapping from conserved variables $(D,S,E)$ to primitives $(\\rho,u,P)$ that guarantees strictly positive $\\rho$ and $P$ even when numerical artifacts make the internal energy $U$ nonpositive. Work in dimensionless code units: set $\\bar{\\rho}=1$ and treat all quantities as dimensionless. Assume a one-dimensional flow and adopt an adiabatic index $\\gamma = 5/3$. Let the density floor be $\\rho_{\\min}=10^{-12}$ and the pressure floor be $P_{\\min}=10^{-12}$.\n\nYour program must implement the following recovery logic, justified by your derivation:\n- Compute $\\rho = \\max(D,\\rho_{\\min})$.\n- Compute $u = S/\\rho$.\n- Compute the kinetic energy density $K = \\frac{1}{2}\\rho u^2$ and the internal energy density candidate $U^\\ast = E - K$.\n- If $U^\\ast \\le \\frac{P_{\\min}}{\\gamma-1}$, replace $U^\\ast$ by $U = \\frac{P_{\\min}}{\\gamma-1}$ and reset $E$ to $E = U + K$; otherwise set $U=U^\\ast$.\n- Compute $P = (\\gamma-1)U$.\n\nUse the background density $\\bar{\\rho}=1$ to construct conserved variables $D$, $S$, and $E$ for a given density contrast $\\delta$, velocity $u$, and internal specific energy $e$ (internal energy per unit mass), via:\n- $\\rho_{\\mathrm{input}} = \\bar{\\rho}(1+\\delta)$,\n- $D = \\rho_{\\mathrm{input}}$,\n- $S = D \\, u$,\n- $E = D \\, e + \\frac{1}{2} D \\, u^2$.\n\nNote that due to severe cancellation at extreme voids, $e$ may be zero or slightly negative, representing plausible numerical artifacts in near-vacuum machine precision regimes; the recovery should remain robust and ensure $P0$.\n\nTest Suite:\nImplement and evaluate the recovery on the following five test cases, each provided as a tuple $(\\delta, u, e)$:\n1. $(\\delta, u, e) = (-0.9, 0.0, 10^{-6})$.\n2. $(\\delta, u, e) = (-1 + 10^{-12}, 0.0, 10^{-24})$.\n3. $(\\delta, u, e) = (-0.999999999999, 10^{-3}, 10^{-30})$.\n4. $(\\delta, u, e) = (-0.99, 10.0, 0.0)$.\n5. $(\\delta, u, e) = (-0.999, 1.0, -10^{-16})$.\n\nAll quantities are dimensionless. For each case, construct $(D,S,E)$ as above, recover $(\\rho,u,P)$ using the positivity-preserving mapping, and verify strict positivity of $\\rho$ and $P$.\n\nFinal Output Format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each result should be a boolean indicating whether both recovered $\\rho$ and $P$ are strictly positive for the corresponding test case, in the order listed above, e.g., \"[True,True,False,...]\".",
            "solution": "We consider an ideal cosmic fluid in comoving coordinates, with primitive variables $(\\rho,u,P)$ and conserved variables $(D,S,E)$. The gamma-law Equation of State (EOS) is $P=(\\gamma-1)U$ with internal energy density $U$. The total energy density is $E=U+\\frac{1}{2}\\rho u^2$. The fluid is one-dimensional, and the adiabatic index is $\\gamma=5/3$.\n\nThe fundamental base is the Euler system's definitions and the gamma-law EOS. We aim to recover $(\\rho,u,P)$ from the conserved $(D,S,E)$ while ensuring positivity in near-vacuum, where $\\delta\\to -1$. In cosmology, the density contrast $\\delta$ is $\\delta=(\\rho-\\bar{\\rho})/\\bar{\\rho}$, so given $\\bar{\\rho}=1$ in code units, the input density is $\\rho_{\\mathrm{input}}=1+\\delta$. Constructing conserved variables for a test with given $(\\delta,u,e)$, where $e$ is the internal energy per unit mass, follows:\n$$\nD=\\rho_{\\mathrm{input}},\\quad S=D\\,u,\\quad E=D\\,e+\\frac{1}{2}D\\,u^2.\n$$\n\nThe primitive recovery from $(D,S,E)$ is derived by inverting the definitions:\n1. From mass conservation, the primitive density is $D=\\rho$. However, in near-vacuum regions, numerical round-off or model floors are used to avoid nonphysical zero or negative density. Therefore, impose a density floor:\n$$\n\\rho = \\max(D,\\rho_{\\min}),\n$$\nwith $\\rho_{\\min}=10^{-12}$ in code units. This ensures strict positivity $\\rho0$.\n2. The velocity recovers from momentum:\n$$\nu = \\frac{S}{\\rho}.\n$$\nThis uses the floored $\\rho$ to avoid division by zero. Note $S$ is conserved, so if $\\rho$ is increased by the floor, $u$ is reduced accordingly, which is consistent with conserving $S$.\n3. The kinetic energy density is defined from primitives:\n$$\nK = \\frac{1}{2}\\rho u^2.\n$$\n4. The internal energy density candidate is the difference between total energy density and kinetic energy:\n$$\nU^\\ast = E - K.\n$$\nIn extreme voids with $\\delta\\to -1$, $D$ can be very small and $E$ can be nearly equal to $K$, so $U^\\ast$ may be nonpositive due to cancellation or round-off, especially if the provided $e$ is zero or slightly negative as a plausible numerical artifact. To ensure nonnegative and strictly positive pressure, enforce a pressure floor $P_{\\min}=10^{-12}$ and its corresponding internal energy floor:\n$$\nU_{\\min} = \\frac{P_{\\min}}{\\gamma-1}.\n$$\nThe positivity-preserving rule is:\n$$\nU = \\begin{cases}\nU^\\ast,  \\text{if } U^\\ast  U_{\\min},\\\\\nU_{\\min},  \\text{otherwise}.\n\\end{cases}\n$$\nIf the floor is applied, reset the total energy to be consistent,\n$$\nE \\leftarrow U + K,\n$$\nso the conserved energy remains a valid sum of internal and kinetic components post-fix.\n5. Finally, recover pressure via the gamma-law EOS:\n$$\nP = (\\gamma-1)U.\n$$\n\nThis mapping guarantees $\\rho0$ by construction via the density floor and $P0$ via the pressure floor. It is a standard positivity-preserving primitive recovery used in numerical cosmology and computational fluid dynamics under extreme low-density conditions.\n\nAlgorithmic design integrating principles:\n- Inputs are $(\\delta,u,e)$ for each test. Using $\\bar{\\rho}=1$, set $D=1+\\delta$, $S=D\\,u$, and $E=D\\,e+\\frac{1}{2}D\\,u^2$.\n- Apply the recovery mapping:\n  - Compute $\\rho=\\max(D,\\rho_{\\min})$.\n  - Compute $u=S/\\rho$.\n  - Compute $K=\\frac{1}{2}\\rho u^2$.\n  - Compute $U^\\ast=E-K$.\n  - If $U^\\ast\\le U_{\\min}$, set $U=U_{\\min}$ and reset $E=U+K$, else set $U=U^\\ast$.\n  - Compute $P=(\\gamma-1)U$.\n- Validate positivity by checking $(\\rho0)$ and $(P0)$ strictly.\n- Aggregate the positivity checks as booleans for the test suite.\n\nTest suite coverage rationale:\n- Case 1 uses a strong void but not extreme, zero velocity, and small internal energy, a \"happy path\" with positive $U^\\ast$.\n- Case 2 probes $\\delta$ very close to $-1$ with minuscule internal energy, relying on floors.\n- Case 3 combines extreme $\\delta$ with small nonzero velocity, testing cancellation in $E-K$.\n- Case 4 sets $e=0$ and large $u$ relative to density, so $E=K$ and the pressure floor must activate.\n- Case 5 introduces a slight negative $e$, a realistic numerical artifact, ensuring the floor rectifies $U^\\ast\\le 0$.\n\nOutput specification:\nProduce a single line: a comma-separated list enclosed in square brackets of five booleans, each indicating whether both recovered $\\rho$ and $P$ are strictly positive for the corresponding test case, ordered as listed.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef recover_primitives(D, S, E, gamma, rho_floor, P_floor):\n    \"\"\"\n    Positivity-preserving primitive-variable recovery for 1D gamma-law ideal gas.\n    Inputs:\n        D: conserved density (dimensionless)\n        S: conserved momentum density (dimensionless)\n        E: conserved total energy density (dimensionless)\n        gamma: adiabatic index\n        rho_floor: minimum allowed density\n        P_floor: minimum allowed pressure\n    Returns:\n        rho: recovered density (0)\n        u: recovered velocity\n        P: recovered pressure (0)\n    \"\"\"\n    # Density floor\n    rho = max(D, rho_floor)\n\n    # Velocity from momentum and floored density\n    # If rho is extremely small, this keeps u finite given S.\n    u = S / rho\n\n    # Kinetic energy density\n    K = 0.5 * rho * u * u\n\n    # Internal energy candidate\n    U_star = E - K\n\n    # Internal energy floor corresponding to pressure floor\n    U_min = P_floor / (gamma - 1.0)\n\n    if not np.isfinite(U_star) or U_star = U_min:\n        U = U_min\n        # Reset E to keep consistency E = U + K\n        E = U + K\n    else:\n        U = U_star\n\n    # Pressure from EOS\n    P = (gamma - 1.0) * U\n\n    return rho, u, P\n\ndef construct_conserved(delta, u, e, rho_bg=1.0):\n    \"\"\"\n    Construct conserved variables from (delta, u, e) in code units with rho_bg = 1.\n    D = rho_input = rho_bg * (1 + delta)\n    S = D * u\n    E = D * e + 0.5 * D * u^2\n    \"\"\"\n    D = rho_bg * (1.0 + delta)\n    S = D * u\n    E = D * e + 0.5 * D * u * u\n    return D, S, E\n\ndef solve():\n    # Constants in code units\n    gamma = 5.0 / 3.0\n    rho_floor = 1e-12\n    P_floor = 1e-12\n\n    # Define the test cases from the problem statement.\n    # Each tuple is (delta, u, e)\n    test_cases = [\n        (-0.9, 0.0, 1e-6),\n        (-1.0 + 1e-12, 0.0, 1e-24),\n        (-0.999999999999, 1e-3, 1e-30),\n        (-0.99, 10.0, 0.0),\n        (-0.999, 1.0, -1e-16),\n    ]\n\n    results = []\n    for delta, u, e in test_cases:\n        D, S, E = construct_conserved(delta, u, e, rho_bg=1.0)\n        rho, u_rec, P = recover_primitives(D, S, E, gamma, rho_floor, P_floor)\n        # Check strict positivity\n        ok = (rho  0.0) and (P  0.0) and np.isfinite(rho) and np.isfinite(P)\n        results.append(ok)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "This final practice integrates the preceding concepts into a complete, one-dimensional cosmological hydrodynamics solver. You will implement a conservative finite-volume scheme that couples hyperbolic flux updates with cosmological source terms via operator splitting, a standard technique in modern astrophysics codes. The central goal is to perform rigorous code verification, a critical step in computational science, by demonstrating that the implementation discretely conserves energy and correctly reproduces known analytic solutions in simplified test cases .",
            "id": "3495173",
            "problem": "Implement a one-dimensional finite-volume solver for the Euler equations of an ideal gas in a spatially flat expanding Friedmann–Lemaître–Robertson–Walker (FLRW) background using comoving coordinates. You must design a conservative formulation for the total comoving energy density that explicitly includes the cosmological expansion work term $-3 H P$, and verify discrete conservation in isolated periodic domains. The derivation and algorithm must start from fundamental conservation laws and well-tested facts, and your implementation must exactly respect periodic boundary conditions and finite-volume conservation properties.\n\nStart from the Newtonian Euler equations in comoving coordinates $\\boldsymbol{x}$ for an ideal gas with adiabatic index $\\gamma$, scale factor $a(t)$, Hubble parameter $H(t) \\equiv \\dot{a}(t)/a(t)$, peculiar velocity $u(x,t)$, comoving mass density $\\rho(x,t)$, comoving momentum density $m(x,t) \\equiv \\rho u$, and comoving total energy density\n$$\nE(x,t) \\equiv \\rho e + \\tfrac{1}{2} \\rho u^2,\n$$\nwhere $e$ is the specific internal energy. The ideal-gas equation of state relates the comoving thermal pressure:\n$$\nP(x,t) = (\\gamma - 1) \\left[E - \\tfrac{1}{2}\\frac{m^2}{\\rho}\\right].\n$$\nIn one spatial dimension with periodic boundaries and neglecting self-gravity, the comoving Euler system is\n$$\n\\partial_t \\rho + \\frac{1}{a}\\partial_x(\\rho u) = 0,\n$$\n$$\n\\partial_t m + \\frac{1}{a}\\partial_x(\\rho u^2 + P) = - H m,\n$$\n$$\n\\partial_t E + \\frac{1}{a}\\partial_x\\left(u(E+P)\\right) = - 2 H \\left(\\tfrac{1}{2}\\rho u^2\\right) - 3 H P.\n$$\nThese follow from conservation of mass, momentum, and energy in an expanding background, combined with the thermodynamic work $-P \\nabla \\cdot \\boldsymbol{v}_{\\text{phys}}$ with $\\nabla \\cdot \\boldsymbol{v}_{\\text{phys}} = 3 H$ for the homogeneous Hubble flow.\n\nAlgorithmic goals:\n- Use a finite-volume discretization on a uniform mesh with cell-averaged conservative variables $U_j \\equiv [\\rho_j, m_j, E_j]$.\n- Compute numerical fluxes $F_{j+1/2}$ at interfaces using a consistent Riemann-solver-like method with wave-speed estimate. The comoving hyperbolic flux for ideal gas is\n$$\nF(U) = \\frac{1}{a}\\begin{bmatrix} \\rho u \\\\ \\rho u^2 + P \\\\ u(E+P) \\end{bmatrix}.\n$$\n- Enforce periodic boundary conditions exactly so that, in the absence of source terms, the discrete volume integral of every conserved quantity is invariant to within roundoff. In a finite-volume method, the semi-discrete update\n$$\n\\frac{d}{dt} U_j = - \\frac{1}{\\Delta x} \\left[ F_{j+1/2} - F_{j-1/2} \\right] + S_j\n$$\nensures telescoping cancellation of fluxes in the global sum under periodic boundaries, i.e., the spatial sum of $F_{j+1/2}$ equals the sum of $F_{j-1/2}$.\n- Include the cosmological expansion source terms\n$$\nS_\\rho = 0,\\quad S_m = - H m,\\quad S_E = - 2 H \\left(\\tfrac{1}{2}\\rho u^2\\right) - 3 H P.\n$$\n- For constant $H$, integrate the source terms exactly over a time step using the known analytic scaling under pure expansion:\n  - $a(t) = a_0 \\exp(H (t - t_0))$,\n  - $m \\propto a^{-1}$, thus $m_{\\text{new}} = m_{\\text{old}}/c$,\n  - $K \\equiv \\tfrac{1}{2}\\rho u^2 \\propto a^{-2}$, thus $K_{\\text{new}} = K_{\\text{old}}/c^2$,\n  - $U_{\\text{th}} \\equiv \\rho e \\propto a^{-3(\\gamma-1)}$, thus $U_{\\text{th,new}} = U_{\\text{th,old}}/c^{3(\\gamma-1)}$,\n  where $c \\equiv a_{\\text{new}}/a_{\\text{old}}$.\n- Use Strang splitting: apply a half-step source update using the analytic scaling, then a full hyperbolic step with $a$ frozen at the midpoint, then a second half-step source update.\n\nVerification objectives:\n- Demonstrate that for $H = 0$, the discrete volume integral of the total comoving energy,\n$$\n\\mathcal{E}(t) \\equiv \\int E(x,t)\\,dx,\n$$\nis conserved to within numerical roundoff when using periodic boundaries.\n- Demonstrate that for $H  0$ with uniform initial conditions, the discrete $\\mathcal{E}(t)$ evolves exactly according to the analytic source-only scaling. For a uniform static gas with $u = 0$, this implies\n$$\n\\mathcal{E}(t) = \\mathcal{E}(0)\\,\\exp\\left(-3(\\gamma-1) H t\\right).\n$$\nFor a uniform moving gas with constant initial $u \\neq 0$, the exact analytic evolution of the volume-integrated total comoving energy is\n$$\n\\mathcal{E}(t) = \\mathcal{U}_{\\text{th}}(0)\\,\\exp\\left(-3(\\gamma-1) H t\\right) + \\mathcal{K}(0)\\,\\exp\\left(-2 H t\\right),\n$$\nwhere $\\mathcal{U}_{\\text{th}}(0) = \\int P/(\\gamma-1)\\,dx$ and $\\mathcal{K}(0) = \\int \\tfrac{1}{2}\\rho u^2\\,dx$.\n\nYour program must:\n- Implement the described scheme in one spatial dimension with a Rusanov flux for the hyperbolic step, an ideal-gas equation of state, and exact source-step scaling for constant $H$.\n- Use the following test suite, which covers conservation, analytic source evolution, and periodic boundary correctness. Domain length is $L = 1$ for all tests. All quantities are dimensionless.\n  1. Test A (Happy path conservation): $\\gamma = 5/3$, $H = 0$, $a_0 = 1$, $N_x = 256$, initial conditions\n     - $\\rho(x) = 1 + 0.2 \\sin(2\\pi x)$,\n     - $u(x) = 0.3 \\sin(4\\pi x)$,\n     - $P(x) = 1 + 0.1 \\cos(2\\pi x)$.\n     Evolve to final time $T = 0.1$ with Courant–Friedrichs–Lewy (CFL) number $0.4$. Output the relative change\n     $$\n     \\varepsilon_A \\equiv \\frac{|\\mathcal{E}(T) - \\mathcal{E}(0)|}{\\mathcal{E}(0)}.\n     $$\n  2. Test B (Uniform static source scaling): $\\gamma = 5/3$, $H = 0.01$, $a_0 = 1$, $N_x = 64$, initial conditions\n     - $\\rho(x) = 1$,\n     - $u(x) = 0$,\n     - $P(x) = 2$.\n     Evolve to $T = 2$ with CFL $0.4$. Compute the analytic expected\n     $$\n     \\mathcal{E}_{\\text{exp}}(T) = \\mathcal{E}(0)\\,\\exp\\left(-3(\\gamma-1) H T\\right),\n     $$\n     and output\n     $$\n     \\varepsilon_B \\equiv \\frac{|\\mathcal{E}(T) - \\mathcal{E}_{\\text{exp}}(T)|}{\\mathcal{E}_{\\text{exp}}(T)}.\n     $$\n  3. Test C (Uniform moving source scaling): $\\gamma = 5/3$, $H = 0.05$, $a_0 = 1$, $N_x = 64$, initial conditions\n     - $\\rho(x) = 1$,\n     - $u(x) = 0.2$,\n     - $P(x) = 1$.\n     Evolve to $T = 2$ with CFL $0.4$. Compute the analytic expected\n     $$\n     \\mathcal{E}_{\\text{exp}}(T) = \\mathcal{U}_{\\text{th}}(0)\\,\\exp\\left(-3(\\gamma-1) H T\\right) + \\mathcal{K}(0)\\,\\exp\\left(-2 H t\\right),\n     $$\n     where $\\mathcal{U}_{\\text{th}}(0) = \\int P/(\\gamma-1)\\,dx$ and $\\mathcal{K}(0) = \\int \\tfrac{1}{2}\\rho u^2\\,dx$. Output\n     $$\n     \\varepsilon_C \\equiv \\frac{|\\mathcal{E}(T) - \\mathcal{E}_{\\text{exp}}(T)|}{\\mathcal{E}_{\\text{exp}}(T)}.\n     $$\n- Final Output Format: Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[resultA,resultB,resultC]\"), where each result is a floating-point number corresponding to $[\\varepsilon_A, \\varepsilon_B, \\varepsilon_C]$ in this order.\n\nAll quantities are dimensionless; do not attach units. Implement the complete algorithm and produce the required single-line output exactly as specified.",
            "solution": "The problem requires the implementation of a one-dimensional finite-volume numerical solver for the Euler equations of an ideal gas within an expanding Friedmann–Lemaître–Robertson–Walker (FLRW) cosmological background. The solver must use comoving coordinates, employ a conservative finite-volume discretization, handle cosmological source terms via Strang splitting with an exact analytic update for constant Hubble parameter $H$, and utilize a Rusanov-type flux for the hyperbolic part.\n\nThe governing equations in one spatial dimension for the comoving mass density $\\rho$, comoving momentum density $m = \\rho u$, and comoving total energy density $E$ are given as:\n$$\n\\partial_t \\rho + \\frac{1}{a}\\partial_x(\\rho u) = 0\n$$\n$$\n\\partial_t m + \\frac{1}{a}\\partial_x(\\rho u^2 + P) = - H m\n$$\n$$\n\\partial_t E + \\frac{1}{a}\\partial_x\\left(u(E+P)\\right) = - 2 H \\left(\\tfrac{1}{2}\\rho u^2\\right) - 3 H P\n$$\nThese can be written in a compact conservative vector form, $\\partial_t U + \\frac{1}{a}\\partial_x F_{\\text{hydro}}(U) = S(U, H)$, where:\n- The state vector of conserved quantities is $U = [\\rho, m, E]^T$.\n- The hydrodynamic flux vector is $F_{\\text{hydro}}(U) = [\\rho u, \\rho u^2 + P, u(E+P)]^T$.\n- The cosmological source term vector is $S(U, H) = [0, -H m, -2H K - 3HP]^T$, where $K = \\frac{1}{2}\\rho u^2 = \\frac{1}{2}m^2/\\rho$ is the kinetic energy density.\nThe pressure $P$ is determined by the ideal gas equation of state: $P = (\\gamma - 1)(E - K)$.\n\nA finite-volume method is employed on a uniform grid of $N_x$ cells, each of width $\\Delta x = L/N_x$. The state vector $U_j(t)$ represents the cell-averaged value of $U(x, t)$ over cell $j$. The semi-discrete form of the equations is:\n$$\n\\frac{d U_j}{dt} = - \\frac{1}{\\Delta x} \\left( F_{j+1/2} - F_{j-1/2} \\right) + S_j\n$$\nwhere $F_{j+1/2}$ is the numerical flux at the interface between cells $j$ and $j+1$, and $S_j$ is the source term evaluated for cell $j$.\n\nThe evolution from time $t_n$ to $t_{n+1} = t_n + \\Delta t$ is performed using a second-order Strang splitting scheme. This operator splitting method treats the hyperbolic advection part and the source term part separately, which is effective for handling the different characters and timescales of these physical processes. The update proceeds in three steps:\n$$\nU^{n+1} = \\mathcal{O}_{\\text{src}}(\\Delta t/2) \\circ \\mathcal{O}_{\\text{hyp}}(\\Delta t) \\circ \\mathcal{O}_{\\text{src}}(\\Delta t/2) \\, U^n\n$$\nwhere $\\mathcal{O}_{\\text{src}}(\\delta t)$ is the operator that evolves the state under the source term alone for a duration $\\delta t$, and $\\mathcal{O}_{\\text{hyp}}(\\Delta t)$ is the operator for the hyperbolic part.\n\nThe source step, $\\mathcal{O}_{\\text{src}}(\\delta t)$, solves the system of ordinary differential equations $\\frac{dU}{dt} = S(U, H)$. For a constant Hubble parameter $H$, these equations have an exact analytic solution based on the physical scaling of quantities in an expanding universe. Over a time step $\\delta t$, the scale factor evolves as $a_{\\text{new}} = a_{\\text{old}} \\exp(H \\delta t)$. Let $c = a_{\\text{new}}/a_{\\text{old}} = \\exp(H\\delta t)$. The conserved variables are updated as follows:\n- The comoving mass density $\\rho$ is conserved by the source term: $\\rho_{\\text{new}} = \\rho_{\\text{old}}$.\n- The peculiar velocity scales as $u \\propto a^{-1}$, so the comoving momentum density $m = \\rho u$ scales as $m_{\\text{new}} = m_{\\text{old}} / c = m_{\\text{old}} \\exp(-H \\delta t)$.\n- The total energy $E$ is decomposed into its kinetic part $K = \\frac{1}{2} m^2/\\rho$ and its thermal part $U_{\\text{th}} = E - K$. Each part scales differently:\n    - $K \\propto a^{-2}$, so $K_{\\text{new}} = K_{\\text{old}} / c^2 = K_{\\text{old}} \\exp(-2H \\delta t)$.\n    - $U_{\\text{th}} \\propto a^{-3(\\gamma-1)}$, so $U_{\\text{th,new}} = U_{\\text{th,old}} / c^{3(\\gamma-1)} = U_{\\text{th,old}} \\exp(-3(\\gamma-1)H \\delta t)$.\n- The new total energy is reconstituted as $E_{\\text{new}} = K_{\\text{new}} + U_{\\text{th,new}}$.\n\nThe hyperbolic step, $\\mathcal{O}_{\\text{hyp}}(\\Delta t)$, solves the homogeneous conservation law $\\partial_t U + \\partial_x F(U) = 0$, where the flux is $F(U) = \\frac{1}{a} F_{\\text{hydro}}(U)$. As per the Strang splitting prescription, the scale factor $a$ is held constant at its midpoint value, $a_{\\text{mid}} = a(t_n + \\Delta t/2) = a_n \\exp(H \\Delta t/2)$, throughout this step. A first-order explicit Euler method is used for this sub-step:\n$$\nU_{j}^{**} = U_{j}^{*} - \\frac{\\Delta t}{\\Delta x} \\left( F_{j+1/2} - F_{j-1/2} \\right)\n$$\nwhere $U^{*}$ is the state after the first half source step. The numerical flux $F_{j+1/2}$ is computed using the Rusanov (or local Lax-Friedrichs) scheme. For states $U_L=U_j$ and $U_R=U_{j+1}$ at the left and right of the interface $x_{j+1/2}$:\n$$\nF_{j+1/2} = \\frac{1}{2} \\left( F(U_L) + F(U_R) \\right) - \\frac{s_{\\max}}{2} (U_R - U_L)\n$$\nThe maximum signal speed at the interface, $s_{\\max}$, is given by the largest absolute eigenvalue of the flux Jacobian:\n$$\ns_{\\max} = \\frac{1}{a_{\\text{mid}}} \\max \\left( |u_L| + c_{s,L}, |u_R| + c_{s,R} \\right)\n$$\nwhere $c_s = \\sqrt{\\gamma P/\\rho}$ is the adiabatic sound speed.\n\nPeriodic boundary conditions are crucial for verifying conservation properties. They are implemented by creating ghost cells such that the state in cell $-1$ is a copy of cell $N_x-1$, and the state in cell $N_x$ is a copy of cell $0$. This ensures that the sum of flux differences over all cells is a telescoping sum that cancels to zero, $\\sum_{j=0}^{N_x-1} (F_{j+1/2} - F_{j-1/2}) = 0$, guaranteeing discrete conservation of total mass, momentum, and energy for the hyperbolic step.\n\nThe time step $\\Delta t$ is dynamically adjusted to satisfy the Courant–Friedrichs–Lewy (CFL) stability condition:\n$$\n\\Delta t = \\text{CFL} \\times \\frac{\\Delta x}{\\max_j \\left( (|u_j| + c_{s,j})/a \\right)}\n$$\nwhere the maximum is taken over all cells in the domain and $a$ is the scale factor at the beginning of the complete time step.\n\nThe implementation is validated against three test cases: Test A checks energy conservation for $H=0$, where numerical errors should be the only source of non-conservation. Test B and Test C verify the correctness of the source term integration against exact analytic solutions for uniform initial conditions, where the hyperbolic update should be zero and the numerical solution should match the analytic one to machine precision.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the hydro-solver for the specified test cases.\n    \"\"\"\n\n    class HydroSolver1D:\n        \"\"\"\n        A 1D finite-volume solver for cosmological Euler equations.\n        \"\"\"\n        def __init__(self, Nx, L, gamma, H, a0, CFL, U0):\n            self.Nx = Nx\n            self.L = L\n            self.gamma = gamma\n            self.H = H\n            self.a = float(a0)\n            self.CFL = CFL\n            self.dx = L / Nx\n            self.x = (np.arange(Nx) + 0.5) * self.dx\n            # State vector U is shape (3, Nx) for [rho, m, E]\n            self.U = np.copy(U0)\n            self.t = 0.0\n\n        def get_primitives(self, U):\n            \"\"\"Computes primitive variables [rho, u, P] from conserved state U.\"\"\"\n            rho = U[0]\n            m = U[1]\n            E = U[2]\n            \n            # Floor for density to avoid division by zero\n            rho = np.maximum(rho, 1e-12)\n            \n            u = m / rho\n            \n            # Kinetic energy density\n            K = 0.5 * m**2 / rho\n            \n            # Pressure, with a floor\n            P = (self.gamma - 1) * (E - K)\n            P = np.maximum(P, 1e-12)\n            \n            return rho, u, P\n\n        def get_flux(self, U, a_val):\n            \"\"\"Computes the hyperbolic flux vector F(U).\"\"\"\n            rho, u, P = self.get_primitives(U)\n            E = U[2]\n            \n            F = np.zeros_like(U)\n            F[0] = rho * u\n            F[1] = rho * u**2 + P\n            F[2] = u * (E + P)\n            \n            return F / a_val\n\n        def source_step(self, dt):\n            \"\"\"Applies the analytic source term update over a timestep dt.\"\"\"\n            if self.H == 0.0:\n                return\n\n            rho, m, E = self.U[0], self.U[1], self.U[2]\n            c = np.exp(self.H * dt)\n\n            # Update momentum\n            m_new = m / c\n\n            # Decompose energy and update its components\n            K_old = 0.5 * m**2 / np.maximum(rho, 1e-12)\n            U_th_old = E - K_old\n            \n            K_new = K_old / c**2\n            U_th_new = U_th_old / c**(3 * (self.gamma - 1))\n            \n            E_new = U_th_new + K_new\n\n            # Update state vector and scale factor\n            self.U[1] = m_new\n            self.U[2] = E_new\n            self.a *= c\n\n        def hyperbolic_step(self, dt):\n            \"\"\"Applies the hyperbolic update using a Rusanov flux.\"\"\"\n            # States at cell centers\n            U_c = self.U\n\n            # Reconstruct states at interfaces (first-order)\n            # U_R is the state in the cell to the right of each interface\n            U_R = np.roll(U_c, -1, axis=1)\n            U_L = U_c\n\n            # Primitives for left and right states\n            rho_L, u_L, P_L = self.get_primitives(U_L)\n            rho_R, u_R, P_R = self.get_primitives(U_R)\n\n            # Sound speeds\n            cs_L = np.sqrt(self.gamma * P_L / rho_L)\n            cs_R = np.sqrt(self.gamma * P_R / rho_R)\n\n            # Max signal speed at interfaces (Rusanov wave speed)\n            # self.a is a_mid at this point in the Strang split\n            s_max = (np.maximum(np.abs(u_L) + cs_L, np.abs(u_R) + cs_R)) / self.a\n\n            # Central fluxes\n            F_L = self.get_flux(U_L, self.a)\n            F_R = self.get_flux(U_R, self.a)\n\n            # Rusanov flux at interfaces\n            # Note: s_max has shape (Nx,), broadcasting to (3, Nx)\n            F_rusanov = 0.5 * (F_L + F_R) - 0.5 * s_max[:, np.newaxis].T * (U_R - U_L)\n\n            # Finite volume update\n            # F_left_of_cell is the flux at the j-1/2 interface for cell j\n            F_left_of_cell = np.roll(F_rusanov, 1, axis=1)\n            self.U -= (dt / self.dx) * (F_rusanov - F_left_of_cell)\n\n        def get_dt(self):\n            \"\"\"Calculates the stable time step dt via CFL condition.\"\"\"\n            rho, u, P = self.get_primitives(self.U)\n            cs = np.sqrt(self.gamma * P / rho)\n            max_speed = np.max((np.abs(u) + cs) / self.a)\n            \n            if max_speed == 0:\n                return 1e-4 # Default for static case\n            \n            return self.CFL * self.dx / max_speed\n\n        def evolve(self, T_final):\n            \"\"\"Evolves the system to final time T_final.\"\"\"\n            while self.t  T_final:\n                dt = self.get_dt()\n                if self.t + dt  T_final:\n                    dt = T_final - self.t\n\n                # Strang splitting\n                # 1. Half source step\n                self.source_step(dt / 2.0)\n\n                # 2. Full hyperbolic step (self.a is now at t + dt/2)\n                self.hyperbolic_step(dt)\n\n                # 3. Half source step\n                self.source_step(dt / 2.0)\n\n                self.t += dt\n\n    test_cases = [\n        # Test A: Conservation for H=0\n        {'name': 'A', 'gamma': 5/3, 'H': 0.0, 'a0': 1.0, 'Nx': 256, 'L': 1.0, 'T': 0.1, 'CFL': 0.4,\n         'ic': {'type': 'sine'}},\n        # Test B: Uniform static gas scaling\n        {'name': 'B', 'gamma': 5/3, 'H': 0.01, 'a0': 1.0, 'Nx': 64, 'L': 1.0, 'T': 2.0, 'CFL': 0.4,\n         'ic': {'type': 'uniform', 'rho': 1.0, 'u': 0.0, 'P': 2.0}},\n        # Test C: Uniform moving gas scaling\n        {'name': 'C', 'gamma': 5/3, 'H': 0.05, 'a0': 1.0, 'Nx': 64, 'L': 1.0, 'T': 2.0, 'CFL': 0.4,\n         'ic': {'type': 'uniform', 'rho': 1.0, 'u': 0.2, 'P': 1.0}},\n    ]\n\n    results = []\n    for params in test_cases:\n        # Set up initial conditions\n        Nx = params['Nx']\n        L = params['L']\n        dx = L / Nx\n        x = (np.arange(Nx) + 0.5) * dx\n        gamma = params['gamma']\n        ic_params = params['ic']\n\n        if ic_params['type'] == 'sine':\n            rho0 = 1.0 + 0.2 * np.sin(2 * np.pi * x)\n            u0 = 0.3 * np.sin(4 * np.pi * x)\n            P0 = 1.0 + 0.1 * np.cos(2 * np.pi * x)\n        else:  # uniform\n            rho0 = np.full(Nx, ic_params['rho'])\n            u0 = np.full(Nx, ic_params['u'])\n            P0 = np.full(Nx, ic_params['P'])\n            \n        m0 = rho0 * u0\n        E0 = P0 / (gamma - 1) + 0.5 * rho0 * u0**2\n        U0 = np.array([rho0, m0, E0])\n\n        total_E0 = np.sum(E0) * dx\n\n        # Initialize and run the solver\n        solver = HydroSolver1D(Nx, L, gamma, params['H'], params['a0'], params['CFL'], U0)\n        solver.evolve(params['T'])\n\n        # Get final state and calculate total energy\n        U_final = solver.U\n        total_E_final = np.sum(U_final[2]) * dx\n\n        # Calculate error metric for the test case\n        if params['name'] == 'A':\n            error = np.abs(total_E_final - total_E0) / total_E0\n            results.append(error)\n        elif params['name'] == 'B':\n            E_expected = total_E0 * np.exp(-3 * (gamma - 1) * params['H'] * params['T'])\n            error = np.abs(total_E_final - E_expected) / E_expected\n            if E_expected == 0: error = 0.0\n            results.append(error)\n        elif params['name'] == 'C':\n            total_U_th0 = np.sum(P0 / (gamma - 1)) * dx\n            total_K0 = np.sum(0.5 * rho0 * u0**2) * dx\n            \n            E_expected = total_U_th0 * np.exp(-3 * (gamma - 1) * params['H'] * params['T']) + \\\n                         total_K0 * np.exp(-2 * params['H'] * params['T'])\n            \n            error = np.abs(total_E_final - E_expected) / E_expected\n            if E_expected == 0: error = 0.0\n            results.append(error)\n\n    # Format and print the final output\n    print(f\"[{','.join(f'{r:.15e}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}