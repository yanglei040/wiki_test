{
    "hands_on_practices": [
        {
            "introduction": "当目标分布的逆累积分布函数难以求得时，拒绝采样法提供了一种强大而灵活的替代方案。本练习  将带你实践拒绝采样的核心思想，我们将为一个在粒子物理中至关重要的截断布莱特-维格纳（Breit-Wigner）分布设计一个采样方案。通过使用简单的均匀分布作为“包络”函数并分析其接收率，你将深刻理解采样效率的来源以及它在不同区域的变化，为设计更高效的采样器打下基础。",
            "id": "3512597",
            "problem": "在高能物理（HEP）的蒙特卡洛（MC）模拟中，对于一个极点质量为 $m$、宽度为 $\\Gamma$ 的窄共振，其目标采样密度取为限制在区间 $\\left[m - \\Delta, m + \\Delta\\right]$ 上的截断 Breit–Wigner 分布（也称为柯西/洛伦兹分布）。在此区间上的截断概率密度函数（PDF）定义为\n$$\nf(x) \\equiv \\frac{C}{(x - m)^{2} + \\frac{\\Gamma^{2}}{4}}, \\quad x \\in [m - \\Delta, m + \\Delta],\n$$\n在其他情况下 $f(x) = 0$，其中归一化常数 $C$ 的选取需满足 $\\int_{m - \\Delta}^{m + \\Delta} f(x)\\,\\mathrm{d}x = 1$。\n\n你的任务是设计一个拒绝采样器，该采样器通过使用一个支撑集恰好为该截断区间的提议包络来遵循此截断。考虑在 $\\left[m - \\Delta, m + \\Delta\\right]$ 上的均匀提议密度，\n$$\ng(x) \\equiv \\frac{1}{2\\Delta}, \\quad x \\in [m - \\Delta, m + \\Delta],\n$$\n在其他情况下 $g(x) = 0$。请确定最小包络常数 $M$，使得对于所有 $x \\in [m - \\Delta, m + \\Delta]$ 都有 $f(x) \\leq M\\,g(x)$，并从第一性原理出发，计算基于此包络的拒绝算法的全局平均接受概率 $\\alpha$。\n\n然后，分析由接受-拒绝步骤所引出的接受概率（作为 $x$ 的函数，记为 $a(x)$），并评估其在截断边界 $x = m \\pm \\Delta$ 处的极限值，以描述边缘效应。\n\n你的推导必须从接受-拒绝采样的核心定义和概率密度的归一化出发。请将最终答案表示为全局平均接受概率 $\\alpha$ 的单个闭式解析表达式，该表达式仅包含 $\\Gamma$ 和 $\\Delta$。无需进行数值舍入。",
            "solution": "我们从核心定义开始。目标截断 Breit–Wigner PDF 为\n$$\nf(x) = \\frac{C}{(x - m)^{2} + \\frac{\\Gamma^{2}}{4}}, \\quad x \\in [m - \\Delta, m + \\Delta],\n$$\n其中 $C$ 由在截断区间上的归一化条件确定。提议 PDF 在同一区间上是均匀的，\n$$\ng(x) = \\frac{1}{2\\Delta}, \\quad x \\in [m - \\Delta, m + \\Delta].\n$$\n在接受-拒绝采样中，需要一个包络常数 $M \\geq 1$，使得对于支撑集中的所有 $x$ 都有 $f(x) \\leq M\\,g(x)$。由于 $g(x)$ 在该区间上是常数，最小的可行 $M$ 满足\n$$\nM = \\frac{\\max_{x \\in [m - \\Delta, m + \\Delta]} f(x)}{g(x)} = \\frac{\\max_{x \\in [m - \\Delta, m + \\Delta]} f(x)}{\\frac{1}{2\\Delta}} = 2\\Delta \\,\\max_{x \\in [m - \\Delta, m + \\Delta]} f(x).\n$$\n函数 $f(x)$ 在极点 $x = m$ 处达到其最大值，所以\n$$\n\\max f(x) = f(m) = \\frac{C}{\\frac{\\Gamma^{2}}{4}} = \\frac{4C}{\\Gamma^{2}}.\n$$\n因此，\n$$\nM = 2\\Delta \\cdot \\frac{4C}{\\Gamma^{2}} = \\frac{8\\Delta\\,C}{\\Gamma^{2}}.\n$$\n\n为了计算 $C$，我们在截断区间上施加归一化条件：\n$$\n\\int_{m - \\Delta}^{m + \\Delta} f(x)\\,\\mathrm{d}x = \\int_{m - \\Delta}^{m + \\Delta} \\frac{C}{(x - m)^{2} + \\frac{\\Gamma^{2}}{4}}\\,\\mathrm{d}x = 1.\n$$\n令 $y = x - m$。则积分变为\n$$\nC \\int_{-\\Delta}^{\\Delta} \\frac{\\mathrm{d}y}{y^{2} + \\left(\\frac{\\Gamma}{2}\\right)^{2}} = 1.\n$$\n使用标准公式 $\\int \\frac{\\mathrm{d}y}{y^{2} + a^{2}} = \\frac{1}{a}\\arctan\\!\\left(\\frac{y}{a}\\right)$，并令 $a = \\frac{\\Gamma}{2}$，我们得到\n$$\n\\int_{-\\Delta}^{\\Delta} \\frac{\\mathrm{d}y}{y^{2} + \\left(\\frac{\\Gamma}{2}\\right)^{2}} = \\left.\\frac{2}{\\Gamma}\\arctan\\!\\left(\\frac{2y}{\\Gamma}\\right)\\right|_{-\\Delta}^{\\Delta} = \\frac{2}{\\Gamma}\\left(\\arctan\\!\\left(\\frac{2\\Delta}{\\Gamma}\\right) - \\arctan\\!\\left(-\\frac{2\\Delta}{\\Gamma}\\right)\\right) = \\frac{4}{\\Gamma}\\arctan\\!\\left(\\frac{2\\Delta}{\\Gamma}\\right).\n$$\n因此，\n$$\nC \\cdot \\frac{4}{\\Gamma}\\arctan\\!\\left(\\frac{2\\Delta}{\\Gamma}\\right) = 1 \\quad \\Rightarrow \\quad C = \\frac{\\Gamma}{4\\,\\arctan\\!\\left(\\frac{2\\Delta}{\\Gamma}\\right)}.\n$$\n\n将 $C$ 代入 $M$ 得到\n$$\nM = \\frac{8\\Delta}{\\Gamma^{2}} \\cdot \\frac{\\Gamma}{4\\,\\arctan\\!\\left(\\frac{2\\Delta}{\\Gamma}\\right)} = \\frac{2\\Delta}{\\Gamma} \\cdot \\frac{1}{\\arctan\\!\\left(\\frac{2\\Delta}{\\Gamma}\\right)}.\n$$\n\n对于使用归一化的 $f$ 和 $g$ 的接受-拒绝采样，全局平均接受概率 $\\alpha$ 可计算并简化如下：\n$$\n\\alpha = \\int_{m - \\Delta}^{m + \\Delta} \\frac{f(x)}{M\\,g(x)}\\,g(x)\\,\\mathrm{d}x = \\frac{1}{M}\\int_{m - \\Delta}^{m + \\Delta} f(x)\\,\\mathrm{d}x = \\frac{1}{M},\n$$\n因为 $f$ 在截断区间上是归一化的。因此，\n$$\n\\alpha = \\frac{1}{M} = \\frac{\\Gamma}{2\\Delta}\\,\\arctan\\!\\left(\\frac{2\\Delta}{\\Gamma}\\right).\n$$\n\n接下来，我们分析在接受-拒绝步骤中使用的逐点接受概率 $a(x)$。从 $g$ 中抽取的样本 $x$ 被接受的概率为\n$$\na(x) = \\frac{f(x)}{M\\,g(x)}.\n$$\n由于 $g(x) = \\frac{1}{2\\Delta}$ 且 $M = 2\\Delta\\,\\max f(x) = 2\\Delta\\,f(m)$，我们有\n$$\na(x) = \\frac{f(x)}{(2\\Delta\\,f(m))\\,\\frac{1}{2\\Delta}} = \\frac{f(x)}{f(m)}.\n$$\n因此，逐点接受概率是在 $x$ 处的 Breit–Wigner 值与其在 $x = m$ 处的峰值之比，即，\n$$\na(x) = \\frac{\\frac{C}{(x - m)^{2} + \\frac{\\Gamma^{2}}{4}}}{\\frac{C}{\\frac{\\Gamma^{2}}{4}}} = \\frac{\\frac{\\Gamma^{2}}{4}}{(x - m)^{2} + \\frac{\\Gamma^{2}}{4}} = \\frac{\\Gamma^{2}}{4(x - m)^{2} + \\Gamma^{2}}.\n$$\n在截断边界 $x = m \\pm \\Delta$ 处，该概率变为\n$$\na(m \\pm \\Delta) = \\frac{\\Gamma^{2}}{4\\Delta^{2} + \\Gamma^{2}}.\n$$\n这量化了边缘效应：与极点 $x=m$ 附近（此处 $a(m) = 1$）的提议样本相比，边界附近的提议样本被接受的概率较低。当 $\\Gamma$ 固定而 $\\Delta$ 增大时，边界接受概率 $a(m \\pm \\Delta)$ 减小，这反映了对于更宽的提议区间，其边缘处的效率损失更为急剧。相反，当 $\\Delta$ 相对于 $\\Gamma$ 非常小时，$a(m \\pm \\Delta) \\approx 1$，此时包络紧密地贴合目标分布，从而在整个区间上产生一致的高接受概率。\n\n总而言之，对于截断区间上的均匀包络，最小包络常数和全局平均接受概率由归一化条件和极点处的最大值确定，而边缘效应则通过逐点接受概率比来体现。所要求的全局平均接受概率的最终闭式解析表达式为\n$$\n\\alpha = \\frac{\\Gamma}{2\\Delta}\\,\\arctan\\!\\left(\\frac{2\\Delta}{\\Gamma}\\right).\n$$",
            "answer": "$$\\boxed{\\frac{\\Gamma}{2\\Delta}\\,\\arctan\\!\\left(\\frac{2\\Delta}{\\Gamma}\\right)}$$"
        },
        {
            "introduction": "对于具有多个峰（如包含重叠共振态的散射截面）的复杂分布，简单的拒绝采样往往效率低下。多通道采样是解决这一问题的标准高级技术，它将复杂目标分解为多个更易处理的“通道”之和。本练习  是一个综合性的实践，它模拟了一个真实的 $2 \\to 4$ 粒子散射过程，要求你通过凸优化方法来确定各通道的最优权重，并最终实现一个完整、高效的多通道采样器，这正是现代高能物理事件生成器的核心技术之一。",
            "id": "3512593",
            "problem": "考虑一个高能散射的玩具参数化，其中有两个初始粒子产生四个末态粒子（$2\\to 4$）。在此类过程中，矩阵元平方通常表现出多个共振分母，这些分母可以通过类布莱特-维格纳（Breit–Wigner）峰的叠加来建模。设目标非负形状为定义在方形域 $\\mathbf{x}=(u,v)\\in[0,1]^2$ 上的 $f(\\mathbf{x})$，其定义为各道贡献之和 $f(\\mathbf{x})=\\sum_{i=1}^{M} f_i(\\mathbf{x}) + f_{\\mathrm{bg}}$，其中每个 $f_i$ 是代表一个共振的局域峰，而 $f_{\\mathrm{bg}}$ 是一个常数本底。使用接受-拒绝（AR）法的蒙特卡洛（MC）事件生成需要一个包络 $g(\\mathbf{x})$，使得对于所有 $\\mathbf{x}$，都有 $C\\,g(\\mathbf{x})\\ge f(\\mathbf{x})$，其中 $C0$ 是一个有限界。一个标准的多通道构造使用\n$$\ng(\\mathbf{x})=\\sum_{i=1}^{M} w_i\\,g_i(\\mathbf{x}),\n$$\n其中 $w_i\\ge 0$ 是权重，满足 $\\sum_{i=1}^{M} w_i=1$，而 $g_i(\\mathbf{x})$ 是在 $[0,1]^2$ 上归一化的提议概率密度函数。通过最小化最坏情况比率，即通过选择权重 $w_i$ 来最小化以下表达式，可以提高多通道AR的接受率：\n$$\n\\max_{\\mathbf{x}\\in[0,1]^2}\\,\\frac{f(\\mathbf{x})}{\\sum_{i=1}^{M} w_i\\,g_i(\\mathbf{x})}.\n$$\n\n您需要实现一个完整的、自包含的程序，从第一性原理出发执行以下步骤：\n\n1.  为每个共振道 $i$ 定义提议密度 $g_i(\\mathbf{x})$，其形式为在 $[0,1]$ 上的两个截断柯西（类布莱特-维格纳）因子的乘积，\n    $$\n    g_i(\\mathbf{x})=g_{i,u}(u)\\,g_{i,v}(v),\n    $$\n    其中对于坐标 $x\\in[0,1]$，\n    $$\n    g_{i,\\bullet}(x)=\\frac{1}{Z_{i,\\bullet}}\\,\\frac{1}{\\pi}\\,\\frac{\\gamma_{i,\\bullet}}{(x-c_{i,\\bullet})^2+\\gamma_{i,\\bullet}^2},\n    $$\n    具有位置 $c_{i,\\bullet}\\in(0,1)$、宽度 $\\gamma_{i,\\bullet}0$ 以及截断归一化子\n    $$\n    Z_{i,\\bullet}=F_{i,\\bullet}(1)-F_{i,\\bullet}(0),\\quad F_{i,\\bullet}(x)=\\frac{1}{\\pi}\\arctan\\!\\left(\\frac{x-c_{i,\\bullet}}{\\gamma_{i,\\bullet}}\\right)+\\frac{1}{2}.\n    $$\n    包含一个额外的均匀本底道，其提议密度在 $[0,1]^2$ 上为 $g_{\\mathrm{bg}}(\\mathbf{x})=1$。目标函数为\n    $$\n    f(\\mathbf{x})=\\sum_{i=1}^{M} A_i\\,g_i(\\mathbf{x}) + A_{\\mathrm{bg}},\n    $$\n    其中振幅 $A_i\\ge 0$ 且 $A_{\\mathrm{bg}}\\ge 0$。这个玩具构造通过将主要的不变质量结构映射到 $(u,v)$ 来近似 $2\\to 4$ 过程中的重叠共振。\n\n2.  优化道权重 $w_i$（包括本底），以最小化上确界\n    $$\n    C^\\star=\\inf_{\\{w_i\\}}\\;\\max_{\\mathbf{x}\\in[0,1]^2}\\;\\frac{f(\\mathbf{x})}{\\sum_{i} w_i\\,g_i(\\mathbf{x})},\n    $$\n    约束条件为 $w_i\\ge 0$ 和 $\\sum_i w_i=1$。您必须在 $[0,1]^2$ 的离散网格上，通过有原则地简化为凸问题来数值求解此问题；不要依赖绕过从AR包络和混合的基本定义进行推导的临时启发式方法。\n\n3.  使用优化后的权重，实现多通道AR采样以生成 $N$ 个独立样本，并估计经验接受效率\n    $$\n    \\varepsilon=\\frac{\\text{接受的样本数}}{N}.\n    $$\n    对于每次提议抽取，以概率 $w_i$ 选择道 $i$，然后使用截断柯西因子的精确逆变换采样从 $g_i(\\mathbf{x})$ 中抽取 $(u,v)$，并以概率 $p_{\\mathrm{acc}}(\\mathbf{x})=f(\\mathbf{x})/[C^\\star\\,g(\\mathbf{x})]$ 接受，其中 $g(\\mathbf{x})=\\sum_i w_i\\,g_i(\\mathbf{x})$。\n\n4.  测试套件。对以下四个参数集评估上述过程（每个参数集代表一个不同的 $2\\to 4$ 重叠共振场景；在所有情况下，都将均匀本底道作为一个额外的提议道）：\n\n    -   情况1（良好分离的峰，小本底）：$M=3$，振幅 $(A_1,A_2,A_3)=(1.0,0.9,0.6)$，本底振幅 $A_{\\mathrm{bg}}=0.02$，中心和宽度\n        $$\n        (c_{1,u},\\gamma_{1,u})=(0.25,0.02),\\quad (c_{1,v},\\gamma_{1,v})=(0.70,0.02),\n        $$\n        $$\n        (c_{2,u},\\gamma_{2,u})=(0.75,0.03),\\quad (c_{2,v},\\gamma_{2,v})=(0.30,0.025),\n        $$\n        $$\n        (c_{3,u},\\gamma_{3,u})=(0.45,0.04),\\quad (c_{3,v},\\gamma_{3,v})=(0.50,0.04).\n        $$\n\n    -   情况2（强重叠的峰，微小本底）：$M=3$，振幅 $(A_1,A_2,A_3)=(1.0,0.8,0.7)$，本底振幅 $A_{\\mathrm{bg}}=0.01$，\n        $$\n        (c_{1,u},\\gamma_{1,u})=(0.40,0.03),\\quad (c_{1,v},\\gamma_{1,v})=(0.60,0.03),\n        $$\n        $$\n        (c_{2,u},\\gamma_{2,u})=(0.45,0.025),\\quad (c_{2,v},\\gamma_{2,v})=(0.55,0.025),\n        $$\n        $$\n        (c_{3,u},\\gamma_{3,u})=(0.50,0.035),\\quad (c_{3,v},\\gamma_{3,v})=(0.50,0.035).\n        $$\n\n    -   情况3（窄峰，无本底）：$M=3$，振幅 $(A_1,A_2,A_3)=(1.0,1.0,0.9)$，本底振幅 $A_{\\mathrm{bg}}=0.0$，\n        $$\n        (c_{1,u},\\gamma_{1,u})=(0.30,0.008),\\quad (c_{1,v},\\gamma_{1,v})=(0.70,0.008),\n        $$\n        $$\n        (c_{2,u},\\gamma_{2,u})=(0.70,0.008),\\quad (c_{2,v},\\gamma_{2,v})=(0.30,0.008),\n        $$\n        $$\n        (c_{3,u},\\gamma_{3,u})=(0.50,0.006),\\quad (c_{3,v},\\gamma_{3,v})=(0.50,0.006).\n        $$\n\n    -   情况4（中度重叠，强本底）：$M=3$，振幅 $(A_1,A_2,A_3)=(0.8,0.8,0.4)$，本底振幅 $A_{\\mathrm{bg}}=0.20$，\n        $$\n        (c_{1,u},\\gamma_{1,u})=(0.35,0.025),\\quad (c_{1,v},\\gamma_{1,v})=(0.65,0.025),\n        $$\n        $$\n        (c_{2,u},\\gamma_{2,u})=(0.65,0.025),\\quad (c_{2,v},\\gamma_{2,v})=(0.35,0.025),\n        $$\n        $$\n        (c_{3,u},\\gamma_{3,u})=(0.50,0.040),\\quad (c_{3,v},\\gamma_{3,v})=(0.50,0.040).\n        $$\n\n使用大小为 $G_u\\times G_v$ 的均匀优化网格，其中 $G_u=50$ 且 $G_v=50$，并为每种情况使用 $N=20000$ 个MC样本进行AR效率估计。此问题中不出现角度。所有量均为无量纲量。\n\n您的程序应生成单行输出，其中包含四个情况的结果，格式为用方括号括起来的逗号分隔列表。列表中的每一项本身必须是 $[C^\\star,\\varepsilon,w_1,w_2,w_3,w_4]$ 形式的列表，包含优化的上确界 $C^\\star$、表示为小数的经验接受效率 $\\varepsilon$，以及三个共振道和均匀本底道的优化权重，按此顺序排列。例如，输出必须如下所示：\n$$\n[[C^\\star_1,\\varepsilon_1,w_{1,1},w_{1,2},w_{1,3},w_{1,4}],[C^\\star_2,\\varepsilon_2,w_{2,1},w_{2,2},w_{2,3},w_{2,4}],[C^\\star_3,\\varepsilon_3,w_{3,1},w_{3,2},w_{3,3},w_{3,4}],[C^\\star_4,\\varepsilon_4,w_{4,1},w_{4,2},w_{4,3},w_{4,4}]].\n$$",
            "solution": "该问题要求为一个 $2 \\to 4$ 粒子散射过程的玩具模型实现一个优化的多通道接受-拒绝（AR）采样算法。这项任务涉及三个主要阶段：定义目标和提议分布，优化采样策略，以及执行蒙特卡洛模拟以估计效率。该解决方案从第一性原理出发进行开发。\n\n首先，我们定义模型的数学组件。采样空间是单位正方形 $\\mathbf{x}=(u,v) \\in [0,1]^2$。目标分布 $f(\\mathbf{x})$ 是一个非负函数，代表矩阵元平方。它被构造为来自 $M$ 个共振道和一个均匀本底道的贡献之和。设索引 $i \\in \\{1, \\dots, M\\}$ 表示共振道，索引 $i=M+1$ 表示本底道。\n\n每个共振道 $i \\in \\{1, \\dots, M\\}$ 的提议概率密度函数（PDF）被给出为两个独立的截断柯西分布的乘积：\n$$\ng_i(\\mathbf{x}) = g_{i,u}(u) \\, g_{i,v}(v)\n$$\n其中对于坐标 $x \\in [0,1]$（代表 $u$ 或 $v$），截断柯西PDF为\n$$\ng_{i,\\bullet}(x) = \\frac{1}{Z_{i,\\bullet}} \\, \\frac{1}{\\pi} \\, \\frac{\\gamma_{i,\\bullet}}{(x-c_{i,\\bullet})^2 + \\gamma_{i,\\bullet}^2}.\n$$\n这里，$c_{i,\\bullet} \\in (0,1)$ 是位置参数（峰中心），$\\gamma_{i,\\bullet}  0$ 是尺度参数（与峰宽相关）。归一化常数 $Z_{i,\\bullet}$ 确保 $\\int_0^1 g_{i,\\bullet}(x) dx = 1$。它是根据标准柯西分布的累积分布函数（CDF）$F(x; c, \\gamma) = \\frac{1}{\\pi}\\arctan(\\frac{x-c}{\\gamma}) + \\frac{1}{2}$ 计算的。因此，在截断域 $[0,1]$ 上的归一化为：\n$$\nZ_{i,\\bullet} = \\int_0^1 \\frac{1}{\\pi} \\, \\frac{\\gamma_{i,\\bullet}}{(x-c_{i,\\bullet})^2 + \\gamma_{i,\\bullet}^2} dx = F(1; c_{i,\\bullet}, \\gamma_{i,\\bullet}) - F(0; c_{i,\\bullet}, \\gamma_{i,\\bullet}).\n$$\n本底道的提议PDF，表示为 $g_{M+1}(\\mathbf{x})$，是单位正方形上的均匀分布：\n$$\ng_{M+1}(\\mathbf{x}) = g_{\\mathrm{bg}}(\\mathbf{x}) = 1, \\quad \\text{for } \\mathbf{x} \\in [0,1]^2.\n$$\n目标分布 $f(\\mathbf{x})$ 被构造为这些提议PDF的线性组合：\n$$\nf(\\mathbf{x}) = \\sum_{i=1}^{M} A_i g_i(\\mathbf{x}) + A_{\\mathrm{bg}} g_{M+1}(\\mathbf{x}) = \\sum_{i=1}^{M+1} A_i g_i(\\mathbf{x}),\n$$\n其中 $A_i \\ge 0$ 是给定的振幅，且 $A_{M+1} \\equiv A_{\\mathrm{bg}}$。\n\n多通道AR方法的核心是使用提议PDF的混合作为总体的提议分布：\n$$\ng(\\mathbf{x}) = \\sum_{i=1}^{M+1} w_i g_i(\\mathbf{x}),\n$$\n其中 $w_i \\ge 0$ 是满足归一化条件 $\\sum_{i=1}^{M+1} w_i = 1$ 的权重。目标是找到一个包络函数 $h(\\mathbf{x}) = C g(\\mathbf{x})$，使得对于所有 $\\mathbf{x} \\in [0,1]^2$，都有 $h(\\mathbf{x}) \\ge f(\\mathbf{x})$，其中常数 $C$ 尽可能小。这可以最小化拒绝率。对于给定的权重集合 $\\{w_i\\}$，最优常数是 $C = \\max_{\\mathbf{x}} \\frac{f(\\mathbf{x})}{g(\\mathbf{x})}$。问题在于找到最小化这个最大值的权重 $\\{w_i\\}$，即找到最优上确界 $C^\\star$：\n$$\nC^\\star = \\inf_{\\{w_i\\}} \\max_{\\mathbf{x} \\in [0,1]^2} \\frac{f(\\mathbf{x})}{\\sum_{i=1}^{M+1} w_i g_i(\\mathbf{x})}.\n$$\n这是一个极小化极大问题。它可以转化为一个更易处理的凸优化问题。令 $C$ 为最大值。该问题等价于：\n$$\n\\text{最小化 } C \\quad \\text{约束条件为} \\quad C \\sum_{i=1}^{M+1} w_i g_i(\\mathbf{x}) \\ge f(\\mathbf{x}) \\text{ for all } \\mathbf{x} \\in [0,1]^2, \\text{ and } \\sum_{i=1}^{M+1} w_i = 1, w_i \\ge 0.\n$$\n我们引入变量代换：$v_i = C w_i$。非负性约束 $w_i \\ge 0$ 意味着 $v_i \\ge 0$。求和约束变为 $\\sum_{i=1}^{M+1} v_i = \\sum_{i=1}^{M+1} C w_i = C \\sum_{i=1}^{M+1} w_i = C \\cdot 1 = C$。因此，最小化 $C$ 等价于最小化 $\\sum v_i$。不等式变为 $\\sum_{i=1}^{M+1} v_i g_i(\\mathbf{x}) \\ge f(\\mathbf{x})$。优化问题现在是一个线性规划（LP）问题：\n$$\n\\text{最小化 } \\sum_{i=1}^{M+1} v_i \\quad \\text{约束条件为} \\quad \\sum_{i=1}^{M+1} v_i g_i(\\mathbf{x}) \\ge f(\\mathbf{x}) \\text{ for all } \\mathbf{x} \\in [0,1]^2, \\text{ and } v_i \\ge 0.\n$$\n为了数值求解这个问题，我们将连续域 $[0,1]^2$ 离散化为一个包含 $N_{\\text{grid}} = G_u \\times G_v$ 个点的有限网格 $\\{\\mathbf{x}_k\\}_{k=1}^{N_{\\text{grid}}}$。无限个约束条件被一个有限集合所取代：\n$$\n\\sum_{i=1}^{M+1} v_i g_i(\\mathbf{x}_k) \\ge f(\\mathbf{x}_k), \\quad \\text{for } k=1, \\dots, N_{\\text{grid}}.\n$$\n这是一个可以使用数值库求解的标准LP问题。设最优解为 $\\{v_i^\\star\\}$。最优上确界是 $C^\\star = \\sum_i v_i^\\star$，最优权重是 $w_i^\\star = v_i^\\star / C^\\star$。\n\n一旦找到了最优权重 $w_i^\\star$ 和上确界 $C^\\star$，我们就可以实现多通道AR采样器。生成一个样本的算法是：\n1.  以概率 $w_j^\\star$ 选择一个道 $j \\in \\{1, \\dots, M+1\\}$。\n2.  从对应的提议PDF $g_j(\\mathbf{x})$ 中生成一个随机变量 $\\mathbf{x} = (u,v)$。\n3.  计算接受概率 $p_{\\mathrm{acc}}(\\mathbf{x}) = \\frac{f(\\mathbf{x})}{C^\\star g(\\mathbf{x})}$，其中 $g(\\mathbf{x}) = \\sum_i w_i^\\star g_i(\\mathbf{x})$。\n4.  生成一个均匀随机数 $r \\sim U(0,1)$。如果 $r  p_{\\mathrm{acc}}(\\mathbf{x})$，接受样本 $\\mathbf{x}$。否则，拒绝它并重复此过程。\n\n为了从截断柯西分布 $g_{i,\\bullet}(x)$ 中生成样本，我们使用逆变换采样法。截断分布的CDF是 $P(x) = (F(x) - F(0))/(F(1) - F(0)) = (F(x) - F_0)/Z$。将其等于一个均匀随机数 $y \\sim U(0,1)$ 并求解 $x$ 可得：\n$F(x) = y Z + F_0$。代入 $F(x)$ 的表达式：\n$$\n\\frac{1}{\\pi}\\arctan\\left(\\frac{x-c}{\\gamma}\\right) + \\frac{1}{2} = y Z + F_0.\n$$\n求解 $x$ 得到采样公式：\n$$\nx = c + \\gamma \\tan\\left( \\pi \\left( y Z + F_0 - \\frac{1}{2} \\right) \\right).\n$$\n由于 $g_i(u,v)=g_{i,u}(u)g_{i,v}(v)$，我们可以使用此公式及其各自的参数独立地对 $u$ 和 $v$ 进行采样。对于本底道，我们从 $[0,1]^2$ 中均匀采样 $(u,v)$。\n\n最后，我们通过生成 $N$ 个提议并计算接受的样本数 $N_{\\text{acc}}$ 来估计经验接受效率 $\\varepsilon$：\n$$\n\\varepsilon = \\frac{N_{\\text{acc}}}{N}.\n$$\n这个经验值应接近于理论效率，后者由目标函数和包络函数的总积分之比给出：\n$$\n\\varepsilon_{\\text{theory}} = \\frac{\\int_{[0,1]^2} f(\\mathbf{x}) d\\mathbf{x}}{\\int_{[0,1]^2} C^\\star g(\\mathbf{x}) d\\mathbf{x}} = \\frac{\\sum_{i=1}^{M+1} A_i}{C^\\star}.\n$$\n这对 $C^\\star$ 的数值结果提供了一个有价值的交叉检验。程序将对提供的四个测试案例中的每一个执行这整个过程。",
            "answer": "```python\nimport numpy as np\nfrom scipy.optimize import linprog\n\nclass TruncatedCauchy:\n    \"\"\"Represents a truncated Cauchy distribution on [0, 1].\"\"\"\n    def __init__(self, c, gamma):\n        self.c = float(c)\n        self.gamma = float(gamma)\n        \n        # Pre-calculate CDF values and normalization constant\n        self.F0 = (1.0 / np.pi) * np.arctan(-self.c / self.gamma) + 0.5\n        self.F1 = (1.0 / np.pi) * np.arctan((1.0 - self.c) / self.gamma) + 0.5\n        self.Z = self.F1 - self.F0\n\n    def pdf(self, x):\n        \"\"\"Calculates the PDF value(s). Vectorized.\"\"\"\n        cauchy_unnorm = (1.0 / np.pi) * self.gamma / ((x - self.c)**2 + self.gamma**2)\n        return cauchy_unnorm / self.Z\n\n    def sample(self, u_rand):\n        \"\"\"Generates a random sample using inverse transform sampling.\"\"\"\n        arg = np.pi * (u_rand * self.Z + self.F0 - 0.5)\n        return self.c + self.gamma * np.tan(arg)\n\nclass ResonanceChannel:\n    \"\"\"Represents a 2D resonance proposal channel.\"\"\"\n    def __init__(self, c_u, gamma_u, c_v, gamma_v):\n        self.dist_u = TruncatedCauchy(c_u, gamma_u)\n        self.dist_v = TruncatedCauchy(c_v, gamma_v)\n\n    def pdf(self, u, v):\n        \"\"\"Calculates the 2D PDF value(s). Vectorized.\"\"\"\n        return self.dist_u.pdf(u) * self.dist_v.pdf(v)\n    \n    def sample(self):\n        \"\"\"Generates a 2D random sample.\"\"\"\n        u = self.dist_u.sample(np.random.rand())\n        v = self.dist_v.sample(np.random.rand())\n        return u, v\n\nclass BackgroundChannel:\n    \"\"\"Represents the uniform background proposal channel.\"\"\"\n    def pdf(self, u, v):\n        \"\"\"Calculates the 2D PDF value. Vectorized.\"\"\"\n        if isinstance(u, np.ndarray):\n            return np.ones_like(u)\n        return 1.0\n    \n    def sample(self):\n        \"\"\"Generates a 2D random sample.\"\"\"\n        return np.random.rand(), np.random.rand()\n\ndef solve_case(params):\n    \"\"\"Solves one complete test case.\"\"\"\n    M, amplitudes, bg_amplitude, resonances_params = params\n    \n    # 1. Define channels and target function\n    channels = []\n    for p in resonances_params:\n        channels.append(ResonanceChannel(p['u'][0], p['u'][1], p['v'][0], p['v'][1]))\n    channels.append(BackgroundChannel()) # M+1-th channel is background\n    \n    all_amplitudes = np.append(amplitudes, bg_amplitude)\n    num_channels = M + 1\n\n    def f_target(u, v):\n        total = 0.0\n        for i in range(num_channels):\n            total += all_amplitudes[i] * channels[i].pdf(u, v)\n        return total\n\n    # 2. Optimize weights via Linear Programming\n    Gu, Gv = 50, 50\n    u_grid = np.linspace(0.0, 1.0, Gu)\n    v_grid = np.linspace(0.0, 1.0, Gv)\n    uu, vv = np.meshgrid(u_grid, v_grid)\n    grid_u, grid_v = uu.ravel(), vv.ravel()\n    \n    f_vals = f_target(grid_u, grid_v)\n    g_vals_list = [chan.pdf(grid_u, grid_v) for chan in channels]\n    \n    # LP setup: min c^T v s.t. A_ub v = b_ub\n    # Our problem: min sum(v_i) s.t. sum(v_i * g_i(x_k)) >= f(x_k) for all k\n    # which is -sum(v_i * g_i(x_k)) = -f(x_k)\n    c_lp = np.ones(num_channels)\n    A_ub_lp = -np.stack(g_vals_list, axis=1) # (N_grid, N_channels)\n    b_ub_lp = -f_vals\n\n    res = linprog(c_lp, A_ub=A_ub_lp, b_ub=b_ub_lp, bounds=(0, None), method='highs')\n    \n    v_opt = res.x\n    C_star = np.sum(v_opt)\n    w_opt = v_opt / C_star\n\n    # 3. Multi-channel Accept-Reject Sampling\n    N_samples = 20000\n    accepted_count = 0\n    channel_indices = np.arange(num_channels)\n\n    for _ in range(N_samples):\n        # Choose a channel\n        chosen_idx = np.random.choice(channel_indices, p=w_opt)\n        \n        # Generate a proposal (u,v) from the chosen channel\n        u_prop, v_prop = channels[chosen_idx].sample()\n        \n        # Check bounds (sampler can sometimes be slightly outside due to precision)\n        if not (0.0 = u_prop = 1.0 and 0.0 = v_prop = 1.0):\n            continue\n\n        # Calculate acceptance probability\n        f_val_prop = f_target(u_prop, v_prop)\n        \n        g_val_prop = 0.0\n        for i in range(num_channels):\n            g_val_prop += w_opt[i] * channels[i].pdf(u_prop, v_prop)\n        \n        p_accept = f_val_prop / (C_star * g_val_prop)\n\n        if np.random.rand()  p_accept:\n            accepted_count += 1\n            \n    efficiency = accepted_count / N_samples\n    \n    # Pack results\n    return [C_star, efficiency, *w_opt]\n\n\ndef solve():\n    \"\"\"Main function to run all test cases and print results.\"\"\"\n    test_cases = [\n        # Case 1\n        (3, (1.0, 0.9, 0.6), 0.02, [\n            {'u': (0.25, 0.02), 'v': (0.70, 0.02)},\n            {'u': (0.75, 0.03), 'v': (0.30, 0.025)},\n            {'u': (0.45, 0.04), 'v': (0.50, 0.04)},\n        ]),\n        # Case 2\n        (3, (1.0, 0.8, 0.7), 0.01, [\n            {'u': (0.40, 0.03), 'v': (0.60, 0.03)},\n            {'u': (0.45, 0.025), 'v': (0.55, 0.025)},\n            {'u': (0.50, 0.035), 'v': (0.50, 0.035)},\n        ]),\n        # Case 3\n        (3, (1.0, 1.0, 0.9), 0.0, [\n            {'u': (0.30, 0.008), 'v': (0.70, 0.008)},\n            {'u': (0.70, 0.008), 'v': (0.30, 0.008)},\n            {'u': (0.50, 0.006), 'v': (0.50, 0.006)},\n        ]),\n        # Case 4\n        (3, (0.8, 0.8, 0.4), 0.20, [\n            {'u': (0.35, 0.025), 'v': (0.65, 0.025)},\n            {'u': (0.65, 0.025), 'v': (0.35, 0.025)},\n            {'u': (0.50, 0.040), 'v': (0.50, 0.040)},\n        ]),\n    ]\n\n    all_results = []\n    for case in test_cases:\n        result = solve_case(case)\n        all_results.append(f\"[{','.join(map(str, result))}]\")\n\n    print(f\"[{','.join(all_results)}]\")\n\nsolve()\n```"
        }
    ]
}