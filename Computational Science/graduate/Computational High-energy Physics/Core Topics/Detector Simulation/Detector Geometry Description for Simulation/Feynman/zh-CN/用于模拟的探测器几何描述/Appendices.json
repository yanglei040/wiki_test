{
    "hands_on_practices": [
        {
            "introduction": "粒子探测器模拟依赖于一个层级化的嵌套体结构。本练习将提供一项基本实践：计算一个在此层级结构深处定义的点的全局坐标。掌握这种正向坐标变换是构建和可视化复杂探测器几何模型的第一步。",
            "id": "3510869",
            "problem": "在计算高能物理（HEP）中，探测器模拟依赖于对嵌套体积及其刚性放置的精确分层描述。考虑一个右手笛卡尔世界坐标系 $\\mathcal{W}$，其中放置了一个桶状体积 $\\mathcal{B}$；在 $\\mathcal{B}$ 中放置了一个模块体积 $\\mathcal{M}$；在 $\\mathcal{M}$ 中放置了一个传感器体积 $\\mathcal{S}$。每次放置都是一个由旋转和平移定义的刚性变换，它作用于被放置（子）坐标系的坐标，以生成在放置（母）坐标系中的坐标。使用以下从局部坐标系到其母坐标系的刚性放置的核心定义：如果 $\\mathbf{x}_{\\text{local}}$ 是局部坐标，那么母坐标系坐标为 $\\mathbf{x}_{\\text{mother}} = R \\,\\mathbf{x}_{\\text{local}} + \\mathbf{t}$，其中 $R$ 是一个正常正交旋转矩阵，$\\mathbf{t}$ 是在母坐标系中表示的平移向量。\n\n所有旋转都定义为围绕在母坐标系中表示的轴的右手旋转，所有角度均以弧度为单位。设 $\\hat{n}_0 = \\frac{1}{\\sqrt{3}}(1,1,1)$ 和 $\\theta_0 = \\frac{\\pi}{3}$ 通过 Rodrigues 旋转公式定义了从 $\\mathcal{W}$ 到 $\\mathcal{B}$ 的旋转，随后是平移 $\\mathbf{t}_0 = (100,-50,20)$，单位为毫米（mm）。从 $\\mathcal{B}$ 到 $\\mathcal{M}$ 的放置是围绕 $\\mathcal{B}$ 的 $\\hat{y}$ 轴旋转 $\\theta_1 = \\frac{\\pi}{4}$，随后是平移 $\\mathbf{t}_1 = (30,10,-40)$，单位为毫米（mm）。从 $\\mathcal{M}$ 到 $\\mathcal{S}$ 的放置是围绕 $\\mathcal{M}$ 的 $\\hat{x}$ 轴旋转 $\\theta_2 = \\frac{\\pi}{6}$，随后是平移 $\\mathbf{t}_2 = (-5,25,15)$，单位为毫米（mm）。在局部传感器坐标系中指定一个点为 $\\mathbf{p}_{\\mathcal{S}} = (12,-8,5)$，单位为毫米（mm）。\n\n使用刚性旋转和平移的基本定义，并仔细遵守每层局部到母坐标系映射所隐含的运算顺序，计算点 $\\mathbf{p}_{\\mathcal{S}}$ 的世界坐标系坐标 $\\mathbf{x}_{\\mathcal{W}}$。将您的最终答案表示为一个包含三个分量的行向量，单位为毫米（mm），并四舍五入到四位有效数字。",
            "solution": "该问题要求将给定在局部传感器坐标系 $\\mathcal{S}$ 中的点 $\\mathbf{p}_{\\mathcal{S}}$ 的坐标，计算到全局世界坐标系 $\\mathcal{W}$ 中。该坐标系遵循嵌套体积的分层结构：传感器体积 $\\mathcal{S}$ 放置在模块体积 $\\mathcal{M}$ 中，$\\mathcal{M}$ 放置在桶状体积 $\\mathcal{B}$ 中，而 $\\mathcal{B}$ 本身又放置在世界坐标系 $\\mathcal{W}$ 中。每次放置都是从局部（子）坐标系到母（放置）坐标系的刚性变换，由关系式 $\\mathbf{x}_{\\text{mother}} = R \\,\\mathbf{x}_{\\text{local}} + \\mathbf{t}$ 定义，其中 $R$ 是旋转矩阵，$\\mathbf{t}$ 是平移向量。\n\n我们将通过顺序应用变换 $\\mathcal{S} \\to \\mathcal{M} \\to \\mathcal{B} \\to \\mathcal{W}$，来找到该点在世界坐标系中的坐标，记为 $\\mathbf{p}_{\\mathcal{W}}$。\n\n设 $\\mathbf{p}_{\\mathcal{S}}$、$\\mathbf{p}_{\\mathcal{M}}$、$\\mathbf{p}_{\\mathcal{B}}$ 和 $\\mathbf{p}_{\\mathcal{W}}$ 分别是该点在坐标系 $\\mathcal{S}$、$\\mathcal{M}$、$\\mathcal{B}$ 和 $\\mathcal{W}$ 中的坐标向量。给定的点是 $\\mathbf{p}_{\\mathcal{S}} = (12, -8, 5)^T$。所有坐标单位均为毫米（mm）。\n\n变换如下：\n1. 从 $\\mathcal{S}$ 到 $\\mathcal{M}$：$\\mathbf{p}_{\\mathcal{M}} = R_2 \\mathbf{p}_{\\mathcal{S}} + \\mathbf{t}_2$\n2. 从 $\\mathcal{M}$ 到 $\\mathcal{B}$：$\\mathbf{p}_{\\mathcal{B}} = R_1 \\mathbf{p}_{\\mathcal{M}} + \\mathbf{t}_1$\n3. 从 $\\mathcal{B}$ 到 $\\mathcal{W}$：$\\mathbf{p}_{\\mathcal{W}} = R_0 \\mathbf{p}_{\\mathcal{B}} + \\mathbf{t}_0$\n\n我们将逐步计算这些变换。\n\n**步骤1：从传感器坐标系 $\\mathcal{S}$ 到模块坐标系 $\\mathcal{M}$ 的变换**\n\n$\\mathcal{S}$ 在 $\\mathcal{M}$ 中的放置由一个旋转 $R_2$ 定义，该旋转是围绕 $\\mathcal{M}$ 的 $\\hat{x}$ 轴旋转角度 $\\theta_2 = \\frac{\\pi}{6}$，然后进行平移 $\\mathbf{t}_2 = (-5, 25, 15)^T$。\n\n围绕 $\\hat{x}$ 轴旋转的旋转矩阵 $R_2$ 为：\n$$R_2 = R_x(\\theta_2) = \\begin{pmatrix} 1  0  0 \\\\ 0  \\cos\\theta_2  -\\sin\\theta_2 \\\\ 0  \\sin\\theta_2  \\cos\\theta_2 \\end{pmatrix}$$\n当 $\\theta_2 = \\frac{\\pi}{6}$ 时，我们有 $\\cos(\\frac{\\pi}{6}) = \\frac{\\sqrt{3}}{2}$ 和 $\\sin(\\frac{\\pi}{6}) = \\frac{1}{2}$。\n$$R_2 = \\begin{pmatrix} 1  0  0 \\\\ 0  \\frac{\\sqrt{3}}{2}  -\\frac{1}{2} \\\\ 0  \\frac{1}{2}  \\frac{\\sqrt{3}}{2} \\end{pmatrix}$$\n\n现在我们计算 $\\mathbf{p}_{\\mathcal{M}}$：\n$$\\mathbf{p}_{\\mathcal{M}} = R_2 \\mathbf{p}_{\\mathcal{S}} + \\mathbf{t}_2 = \\begin{pmatrix} 1  0  0 \\\\ 0  \\frac{\\sqrt{3}}{2}  -\\frac{1}{2} \\\\ 0  \\frac{1}{2}  \\frac{\\sqrt{3}}{2} \\end{pmatrix} \\begin{pmatrix} 12 \\\\ -8 \\\\ 5 \\end{pmatrix} + \\begin{pmatrix} -5 \\\\ 25 \\\\ 15 \\end{pmatrix}$$\n$$\\mathbf{p}_{\\mathcal{M}} = \\begin{pmatrix} 12 \\\\ -4\\sqrt{3} - \\frac{5}{2} \\\\ -4 + \\frac{5\\sqrt{3}}{2} \\end{pmatrix} + \\begin{pmatrix} -5 \\\\ 25 \\\\ 15 \\end{pmatrix} = \\begin{pmatrix} 7 \\\\ 25 - 4\\sqrt{3} - 2.5 \\\\ 15 - 4 + 2.5\\sqrt{3} \\end{pmatrix} = \\begin{pmatrix} 7 \\\\ 22.5 - 4\\sqrt{3} \\\\ 11 + 2.5\\sqrt{3} \\end{pmatrix}$$\n\n**步骤2：从模块坐标系 $\\mathcal{M}$ 到桶状坐标系 $\\mathcal{B}$ 的变换**\n\n$\\mathcal{M}$ 在 $\\mathcal{B}$ 中的放置是围绕 $\\mathcal{B}$ 的 $\\hat{y}$ 轴旋转 $R_1$，角度为 $\\theta_1 = \\frac{\\pi}{4}$，然后进行平移 $\\mathbf{t}_1 = (30, 10, -40)^T$。\n\n围绕 $\\hat{y}$ 轴旋转的旋转矩阵 $R_1$ 为：\n$$R_1 = R_y(\\theta_1) = \\begin{pmatrix} \\cos\\theta_1  0  \\sin\\theta_1 \\\\ 0  1  0 \\\\ -\\sin\\theta_1  0  \\cos\\theta_1 \\end{pmatrix}$$\n当 $\\theta_1 = \\frac{\\pi}{4}$ 时，我们有 $\\cos(\\frac{\\pi}{4}) = \\frac{\\sqrt{2}}{2}$ 和 $\\sin(\\frac{\\pi}{4}) = \\frac{\\sqrt{2}}{2}$。\n$$R_1 = \\begin{pmatrix} \\frac{\\sqrt{2}}{2}  0  \\frac{\\sqrt{2}}{2} \\\\ 0  1  0 \\\\ -\\frac{\\sqrt{2}}{2}  0  \\frac{\\sqrt{2}}{2} \\end{pmatrix}$$\n\n现在我们计算 $\\mathbf{p}_{\\mathcal{B}}$：\n$$\\mathbf{p}_{\\mathcal{B}} = R_1 \\mathbf{p}_{\\mathcal{M}} + \\mathbf{t}_1 = \\begin{pmatrix} \\frac{\\sqrt{2}}{2}  0  \\frac{\\sqrt{2}}{2} \\\\ 0  1  0 \\\\ -\\frac{\\sqrt{2}}{2}  0  \\frac{\\sqrt{2}}{2} \\end{pmatrix} \\begin{pmatrix} 7 \\\\ 22.5 - 4\\sqrt{3} \\\\ 11 + 2.5\\sqrt{3} \\end{pmatrix} + \\begin{pmatrix} 30 \\\\ 10 \\\\ -40 \\end{pmatrix}$$\n我们来计算 $R_1 \\mathbf{p}_{\\mathcal{M}}$ 的分量：\n$$(R_1 \\mathbf{p}_{\\mathcal{M}})_x = \\frac{7\\sqrt{2}}{2} + \\frac{\\sqrt{2}}{2}(11 + 2.5\\sqrt{3}) = \\frac{\\sqrt{2}}{2}(18 + 2.5\\sqrt{3}) = 9\\sqrt{2} + 1.25\\sqrt{6}$$\n$$(R_1 \\mathbf{p}_{\\mathcal{M}})_y = 22.5 - 4\\sqrt{3}$$\n$$(R_1 \\mathbf{p}_{\\mathcal{M}})_z = -\\frac{7\\sqrt{2}}{2} + \\frac{\\sqrt{2}}{2}(11 + 2.5\\sqrt{3}) = \\frac{\\sqrt{2}}{2}(4 + 2.5\\sqrt{3}) = 2\\sqrt{2} + 1.25\\sqrt{6}$$\n加上平移 $\\mathbf{t}_1$：\n$$\\mathbf{p}_{\\mathcal{B}} = \\begin{pmatrix} 30 + 9\\sqrt{2} + 1.25\\sqrt{6} \\\\ 10 + 22.5 - 4\\sqrt{3} \\\\ -40 + 2\\sqrt{2} + 1.25\\sqrt{6} \\end{pmatrix} = \\begin{pmatrix} 30 + 9\\sqrt{2} + 1.25\\sqrt{6} \\\\ 32.5 - 4\\sqrt{3} \\\\ -40 + 2\\sqrt{2} + 1.25\\sqrt{6} \\end{pmatrix}$$\n\n**步骤3：从桶状坐标系 $\\mathcal{B}$ 到世界坐标系 $\\mathcal{W}$ 的变换**\n\n$\\mathcal{B}$ 在 $\\mathcal{W}$ 中的放置是通过 Rodrigues 公式定义的旋转 $R_0$，其旋转轴为 $\\hat{n}_0 = \\frac{1}{\\sqrt{3}}(1,1,1)$，旋转角为 $\\theta_0 = \\frac{\\pi}{3}$，然后进行平移 $\\mathbf{t}_0 = (100, -50, 20)^T$。\n\n对于给定的旋转轴 $\\hat{n}$ 和旋转角 $\\theta$，Rodrigues 公式的旋转矩阵 $R$ 为 $R = I + (\\sin\\theta)K + (1-\\cos\\theta)K^2$，其中 $K$ 是 $\\hat{n}=(n_x, n_y, n_z)^T$ 的叉积矩阵。\n$$K = \\begin{pmatrix} 0  -n_z  n_y \\\\ n_z  0  -n_x \\\\ -n_y  n_x  0 \\end{pmatrix}$$\n对于 $\\hat{n}_0 = \\frac{1}{\\sqrt{3}}(1,1,1)$，我们有 $K_0 = \\frac{1}{\\sqrt{3}}\\begin{pmatrix} 0  -1  1 \\\\ 1  0  -1 \\\\ -1  1  0 \\end{pmatrix}$。\n然后 $K_0^2 = \\frac{1}{3}\\begin{pmatrix} -2  1  1 \\\\ 1  -2  1 \\\\ 1  1  -2 \\end{pmatrix}$。\n对于 $\\theta_0 = \\frac{\\pi}{3}$，我们有 $\\sin\\theta_0 = \\frac{\\sqrt{3}}{2}$ 和 $\\cos\\theta_0 = \\frac{1}{2}$，所以 $1-\\cos\\theta_0 = \\frac{1}{2}$。\n\n代入 Rodrigues 公式：\n$$R_0 = I + \\frac{\\sqrt{3}}{2} K_0 + \\frac{1}{2} K_0^2$$\n$$R_0 = \\begin{pmatrix} 1  0  0 \\\\ 0  1  0 \\\\ 0  0  1 \\end{pmatrix} + \\frac{1}{2}\\begin{pmatrix} 0  -1  1 \\\\ 1  0  -1 \\\\ -1  1  0 \\end{pmatrix} + \\frac{1}{6}\\begin{pmatrix} -2  1  1 \\\\ 1  -2  1 \\\\ 1  1  -2 \\end{pmatrix}$$\n$$R_0 = \\begin{pmatrix} 1-\\frac{1}{3}  -\\frac{1}{2}+\\frac{1}{6}  \\frac{1}{2}+\\frac{1}{6} \\\\ \\frac{1}{2}+\\frac{1}{6}  1-\\frac{1}{3}  -\\frac{1}{2}+\\frac{1}{6} \\\\ -\\frac{1}{2}+\\frac{1}{6}  \\frac{1}{2}+\\frac{1}{6}  1-\\frac{1}{3} \\end{pmatrix} = \\begin{pmatrix} \\frac{2}{3}  -\\frac{1}{3}  \\frac{2}{3} \\\\ \\frac{2}{3}  \\frac{2}{3}  -\\frac{1}{3} \\\\ -\\frac{1}{3}  \\frac{2}{3}  \\frac{2}{3} \\end{pmatrix} = \\frac{1}{3}\\begin{pmatrix} 2  -1  2 \\\\ 2  2  -1 \\\\ -1  2  2 \\end{pmatrix}$$\n\n最后，我们计算 $\\mathbf{p}_{\\mathcal{W}}$：\n$$\\mathbf{p}_{\\mathcal{W}} = R_0 \\mathbf{p}_{\\mathcal{B}} + \\mathbf{t}_0 = \\frac{1}{3}\\begin{pmatrix} 2  -1  2 \\\\ 2  2  -1 \\\\ -1  2  2 \\end{pmatrix} \\begin{pmatrix} 30 + 9\\sqrt{2} + 1.25\\sqrt{6} \\\\ 32.5 - 4\\sqrt{3} \\\\ -40 + 2\\sqrt{2} + 1.25\\sqrt{6} \\end{pmatrix} + \\begin{pmatrix} 100 \\\\ -50 \\\\ 20 \\end{pmatrix}$$\n我们来计算矩阵-向量乘积，记为 $\\mathbf{v} = R_0 \\mathbf{p}_{\\mathcal{B}}$：\n$$3v_x = 2(30 + 9\\sqrt{2} + 1.25\\sqrt{6}) - (32.5 - 4\\sqrt{3}) + 2(-40 + 2\\sqrt{2} + 1.25\\sqrt{6})$$\n$$3v_x = 60 + 18\\sqrt{2} + 2.5\\sqrt{6} - 32.5 + 4\\sqrt{3} - 80 + 4\\sqrt{2} + 2.5\\sqrt{6} = -52.5 + 22\\sqrt{2} + 4\\sqrt{3} + 5\\sqrt{6}$$\n$$3v_y = 2(30 + 9\\sqrt{2} + 1.25\\sqrt{6}) + 2(32.5 - 4\\sqrt{3}) - (-40 + 2\\sqrt{2} + 1.25\\sqrt{6})$$\n$$3v_y = 60 + 18\\sqrt{2} + 2.5\\sqrt{6} + 65 - 8\\sqrt{3} + 40 - 2\\sqrt{2} - 1.25\\sqrt{6} = 165 + 16\\sqrt{2} - 8\\sqrt{3} + 1.25\\sqrt{6}$$\n$$3v_z = -(30 + 9\\sqrt{2} + 1.25\\sqrt{6}) + 2(32.5 - 4\\sqrt{3}) + 2(-40 + 2\\sqrt{2} + 1.25\\sqrt{6})$$\n$$3v_z = -30 - 9\\sqrt{2} - 1.25\\sqrt{6} + 65 - 8\\sqrt{3} - 80 + 4\\sqrt{2} + 2.5\\sqrt{6} = -45 - 5\\sqrt{2} - 8\\sqrt{3} + 1.25\\sqrt{6}$$\n使用数值 $\\sqrt{2} \\approx 1.41421$, $\\sqrt{3} \\approx 1.73205$, $\\sqrt{6} \\approx 2.44949$：\n$$3v_x \\approx -52.5 + 22(1.41421) + 4(1.73205) + 5(2.44949) = -52.5 + 31.11262 + 6.92820 + 12.24745 = -2.21173$$\n$$v_x \\approx -0.73724$$\n$$3v_y \\approx 165 + 16(1.41421) - 8(1.73205) + 1.25(2.44949) = 165 + 22.62736 - 13.85640 + 3.06186 = 176.83282$$\n$$v_y \\approx 58.94427$$\n$$3v_z \\approx -45 - 5(1.41421) - 8(1.73205) + 1.25(2.44949) = -45 - 7.07105 - 13.85640 + 3.06186 = -62.86559$$\n$$v_z \\approx -20.95520$$\n\n最后，我们加上平移 $\\mathbf{t}_0$：\n$$\\mathbf{p}_{\\mathcal{W}} = \\mathbf{v} + \\mathbf{t}_0 \\approx \\begin{pmatrix} -0.73724 \\\\ 58.94427 \\\\ -20.95520 \\end{pmatrix} + \\begin{pmatrix} 100 \\\\ -50 \\\\ 20 \\end{pmatrix} = \\begin{pmatrix} 99.26276 \\\\ 8.94427 \\\\ -0.95520 \\end{pmatrix}$$\n将每个分量四舍五入到四位有效数字：\n$p_{\\mathcal{W},x} \\approx 99.26$\n$p_{\\mathcal{W},y} \\approx 8.944$\n$p_{\\mathcal{W},z} \\approx -0.9552$\n\n该点的世界坐标系坐标约为 $(99.26, 8.944, -0.9552)$。",
            "answer": "$$ \\boxed{ \\begin{pmatrix} 99.26  8.944  -0.9552 \\end{pmatrix} } $$"
        },
        {
            "introduction": "在模拟粒子相互作用后，我们通常会得到一个全局坐标下的“击中”（hit），为了进行数据分析，必须将其映射回特定的传感器通道。本练习将解决这个关键的逆向问题：将全局坐标转换到探测器模块的局部坐标系中，以确定哪个像素被激活。这个过程对于探测器模拟和事件重建都至关重要。",
            "id": "3510927",
            "problem": "在一个计算高能物理模拟中，一个平面像素传感器模块通过一个从其局部坐标系 $(u,v,w)$ 到实验室全局坐标系 $(x,y,z)$ 的刚体变换来描述。该变换由一个正常正交旋转矩阵 $R$ 和一个平移向量 $\\mathbf{t}$ 组成，遵循标准刚体变换法则 $\\mathbf{x}_{\\mathrm{global}} = R \\, \\mathbf{x}_{\\mathrm{local}} + \\mathbf{t}$，其中 $R^{\\top} R = I$ 且 $\\det R = 1$。该模块的局部坐标轴定义为，$w$ 是表面法线，敏感平面位于 $w=0$。该像素传感器具有非方形像素间距：它沿 $u$ 轴分割为 $N_u$ 列，间距为 $p_u$；沿 $v$ 轴分割为 $N_v$ 行，间距为 $p_v$。有效区域以 $(u,v)=(0,0)$ 为中心，沿 $u$ 轴覆盖闭区间 $[-\\frac{N_u p_u}{2}, \\frac{N_u p_u}{2}]$，沿 $v$ 轴覆盖闭区间 $[-\\frac{N_v p_v}{2}, \\frac{N_v p_v}{2}]$。像素由整数对 $(i,j)$ 索引，$i \\in \\{0,1,\\ldots,N_u-1\\}$ 随 $u$ 递增，$j \\in \\{0,1,\\ldots,N_v-1\\}$ 随 $v$ 递增，其中 $(i,j)=(0,0)$ 对应于其左下角位于 $(u_{\\min}, v_{\\min}) = \\left(-\\frac{N_u p_u}{2}, -\\frac{N_v p_v}{2}\\right)$ 的像素。\n\n对于一个特定模块，从局部到全局的旋转是绕全局 $z$ 轴的一个纯旋转，旋转角度为 $\\theta$，其中 $\\cos\\theta = 0.8$ 且 $\\sin\\theta = 0.6$，因此\n$$\nR = \\begin{pmatrix}\n0.8  -0.6  0 \\\\\n0.6  \\phantom{-}0.8  0 \\\\\n0  0  1\n\\end{pmatrix},\n$$\n平移向量为\n$$\n\\mathbf{t} = \\begin{pmatrix} 10 \\\\ 5 \\\\ 2 \\end{pmatrix}~\\mathrm{mm}.\n$$\n该传感器有 $N_u = 800$ 列，间距 $p_u = 0.025~\\mathrm{mm}$；$N_v = 400$ 行，间距 $p_v = 0.150~\\mathrm{mm}$，以局部坐标系原点为中心。\n\n一个模拟的粒子击中被记录在全局坐标\n$$\n\\mathbf{x}_{\\mathrm{global}} = \\begin{pmatrix} 15 \\\\ 10 \\\\ 2 \\end{pmatrix}~\\mathrm{mm}.\n$$\n\n从刚体变换和正交旋转的定义出发，推导该击中的局部坐标 $(u,v)$，并确定该击中落入的离散像素索引 $(i,j)$，以及由行主序 $c = j \\, N_u + i$ 定义的单通道标识符 $c$。将最终答案以行矩阵 $\\big(u, v, i, j, c\\big)$ 的形式报告，$u$ 和 $v$ 以 $\\mathrm{mm}$ 为单位表示并四舍五入到四位有效数字，$i$、$j$ 和 $c$ 为无单位的整数。",
            "solution": "从局部到全局的映射由刚体变换法则 $\\mathbf{x}_{\\mathrm{global}} = R \\, \\mathbf{x}_{\\mathrm{local}} + \\mathbf{t}$ 给出，其中 $R$ 是正交矩阵，满足 $R^{\\top} R = I$ 且 $\\det R = 1$。对于一个正交矩阵 $R$，其逆变换为 $\\mathbf{x}_{\\mathrm{local}} = R^{\\top} \\left( \\mathbf{x}_{\\mathrm{global}} - \\mathbf{t} \\right)$，这是由 $R^{-1} = R^{\\top}$ 推导出来的。\n\n给定\n$$\nR = \\begin{pmatrix}\n0.8  -0.6  0 \\\\\n0.6  \\phantom{-}0.8  0 \\\\\n0  0  1\n\\end{pmatrix}, \\quad\n\\mathbf{t} = \\begin{pmatrix} 10 \\\\ 5 \\\\ 2 \\end{pmatrix}~\\mathrm{mm}, \\quad\n\\mathbf{x}_{\\mathrm{global}} = \\begin{pmatrix} 15 \\\\ 10 \\\\ 2 \\end{pmatrix}~\\mathrm{mm}.\n$$\n首先计算全局偏移向量\n$$\n\\Delta \\mathbf{x} = \\mathbf{x}_{\\mathrm{global}} - \\mathbf{t} = \\begin{pmatrix} 15-10 \\\\ 10-5 \\\\ 2-2 \\end{pmatrix} = \\begin{pmatrix} 5 \\\\ 5 \\\\ 0 \\end{pmatrix}~\\mathrm{mm}.\n$$\n接着使用逆变换\n$$\n\\mathbf{x}_{\\mathrm{local}} = R^{\\top} \\, \\Delta \\mathbf{x}.\n$$\n因为 $R$ 是绕 $z$ 轴的旋转，其转置为\n$$\nR^{\\top} = \\begin{pmatrix}\n0.8  \\phantom{-}0.6  0 \\\\\n-0.6  0.8  0 \\\\\n0  0  1\n\\end{pmatrix}.\n$$\n因此\n$$\n\\begin{pmatrix} u \\\\ v \\\\ w \\end{pmatrix}\n= \n\\begin{pmatrix}\n0.8  \\phantom{-}0.6  0 \\\\\n-0.6  0.8  0 \\\\\n0  0  1\n\\end{pmatrix}\n\\begin{pmatrix} 5 \\\\ 5 \\\\ 0 \\end{pmatrix}\n=\n\\begin{pmatrix}\n0.8 \\cdot 5 + 0.6 \\cdot 5 \\\\\n-0.6 \\cdot 5 + 0.8 \\cdot 5 \\\\\n0\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n4 + 3 \\\\\n-3 + 4 \\\\\n0\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n7 \\\\ 1 \\\\ 0\n\\end{pmatrix}~\\mathrm{mm}.\n$$\n所以，传感器平面上的局部击中坐标为 $(u,v) = (7~\\mathrm{mm}, 1~\\mathrm{mm})$，且如预期那样 $w=0$。\n\n为了分配像素索引，我们从分割的定义开始。有效区域以原点为中心，\n$$\nu_{\\min} = -\\frac{N_u p_u}{2}, \\quad u_{\\max} = \\frac{N_u p_u}{2}, \\quad v_{\\min} = -\\frac{N_v p_v}{2}, \\quad v_{\\max} = \\frac{N_v p_v}{2}.\n$$\n给定 $N_u = 800$ 和 $p_u = 0.025~\\mathrm{mm}$，我们有\n$$\nN_u p_u = 800 \\times 0.025~\\mathrm{mm} = 20~\\mathrm{mm}, \\quad u_{\\min} = -10~\\mathrm{mm}, \\quad u_{\\max} = 10~\\mathrm{mm}.\n$$\n给定 $N_v = 400$ 和 $p_v = 0.150~\\mathrm{mm}$，我们有\n$$\nN_v p_v = 400 \\times 0.150~\\mathrm{mm} = 60~\\mathrm{mm}, \\quad v_{\\min} = -30~\\mathrm{mm}, \\quad v_{\\max} = 30~\\mathrm{mm}.\n$$\n从左下角 $(u_{\\min}, v_{\\min})$ 开始保持一致分箱的连续到离散映射为\n$$\ni = \\left\\lfloor \\frac{u - u_{\\min}}{p_u} \\right\\rfloor, \\qquad\nj = \\left\\lfloor \\frac{v - v_{\\min}}{p_v} \\right\\rfloor,\n$$\n其中向下取整函数 $\\lfloor \\cdot \\rfloor$ 产生像素的唯一整数索引，该像素的左下角在每个维度上界定该击中。对于 $(u,v) = (7~\\mathrm{mm}, 1~\\mathrm{mm})$，\n$$\n\\frac{u - u_{\\min}}{p_u} = \\frac{7 - (-10)}{0.025} = \\frac{17}{0.025} = 680, \\quad \\Rightarrow \\quad i = \\lfloor 680 \\rfloor = 680,\n$$\n$$\n\\frac{v - v_{\\min}}{p_v} = \\frac{1 - (-30)}{0.150} = \\frac{31}{0.150} \\approx 206.666\\ldots, \\quad \\Rightarrow \\quad j = \\lfloor 206.666\\ldots \\rfloor = 206.\n$$\n两个索引都满足 $0 \\leq i \\leq N_u - 1$ 和 $0 \\leq j \\leq N_v - 1$，这确认了击中位于有效区域内。行主序中的单通道标识符是\n$$\nc = j \\, N_u + i = 206 \\times 800 + 680 = 164{,}800 + 680 = 165{,}480.\n$$\n最后，按要求将 $u$ 和 $v$ 四舍五入到四位有效数字并以 $\\mathrm{mm}$ 表示。由于 $u=7~\\mathrm{mm}$ 和 $v=1~\\mathrm{mm}$ 在所要求的精度下是精确值，当写成四位有效数字时，它们变为 $u = 7.000$ 和 $v = 1.000$。组合所要求的行矩阵 $(u, v, i, j, c)$。",
            "answer": "$$\\boxed{\\begin{pmatrix}7.000  1.000  680  206  165480\\end{pmatrix}}$$"
        },
        {
            "introduction": "任何粒子输运模拟的核心都是确定粒子径迹与探测器材料的交点。本练习将引导你完成射线-圆柱体相交这一基本计算，这是粒子穿过桶状径迹探测器时的常见情景。从第一性原理出发推导此过程，并考虑其数值稳定性，可以让你深入了解驱动现代模拟工具包的核心算法。",
            "id": "3510886",
            "problem": "在高能物理（HEP）模拟中，一个圆柱形径迹探测器桶部被建模为一个与 $z$ 轴对齐的无限长圆柱体的侧面，由方程 $x^{2} + y^{2} = r^{2}$ 描述。一个带电粒子的轨迹在局部坐标系中作为一条直线射线进行传播，其方程为 $\\mathbf{x}(t) = \\mathbf{x}_{0} + t\\,\\mathbf{d}$，其中 $\\mathbf{x}_{0} = (x_{0}, y_{0}, z_{0})$ 是圆柱体内部的起始点，$\\mathbf{d} = (d_{x}, d_{y}, d_{z})$ 是一个单位方向向量，而 $t \\geq 0$ 是以米为单位测量的路径长度参数。\n\n从圆柱体和参数化直线的定义出发，并且不假设任何预先推导出的交点公式，通过施加轨迹位于圆柱体表面上的几何约束，来推导交点参数 $t$ 的解析表达式。然后将你的结果具体化，以选择最小的正交点 $t$（即沿射线的第一个击中点/出射点）。\n\n在推导出通用表达式后，针对以下代表一个硅径迹探测器桶部层的物理上合理的配置，对其进行数值计算：\n- 圆柱体半径 $r = 1.3\\,\\mathrm{m}$，\n- 起始点 $\\mathbf{x}_{0} = (0.5,\\,-0.6,\\,2.0)\\,\\mathrm{m}$，\n- 单位方向向量 $\\mathbf{d} = \\bigl(0.4,\\,0.5,\\,\\sqrt{0.59}\\bigr)$，其中选择 $\\sqrt{0.59}$ 以使 $\\mathbf{d}$ 被归一化。\n\n将你的最终数值答案四舍五入到四位有效数字，并以米为单位表示。\n\n最后，作为你推导过程的一部分，简要讨论浮点实现应如何稳健地处理掠射（近切向相交）情况，包括判别式、数值公差以及一个数值稳定的求根策略的作用。你最终报告的量必须仅为如上所述的最小正值 $t$。",
            "solution": "首先对问题进行验证，以确保其是适定的、有科学依据的并且是自洽的。\n\n**步骤1：提取已知条件**\n- 圆柱面方程：$x^{2} + y^{2} = r^{2}$，在 $z$ 方向上无限延伸。\n- 粒子轨迹（参数化直线）：$\\mathbf{x}(t) = \\mathbf{x}_{0} + t\\,\\mathbf{d}$，对于 $t \\geq 0$。\n- 起始点：$\\mathbf{x}_{0} = (x_{0}, y_{0}, z_{0})$，位于圆柱体内部。\n- 方向向量：$\\mathbf{d} = (d_{x}, d_{y}, d_{z})$，一个单位向量 ($|\\mathbf{d}|=1$)。\n- 用于评估的数值：\n  - 半径：$r = 1.3\\,\\mathrm{m}$。\n  - 起始点：$\\mathbf{x}_{0} = (0.5,\\,-0.6,\\,2.0)\\,\\mathrm{m}$。\n  - 方向向量：$\\mathbf{d} = \\bigl(0.4,\\,0.5,\\,\\sqrt{0.59}\\bigr)$。\n- 要求输出：最小的正交点参数 $t$，四舍五入到四位有效数字。\n- 附加要求：讨论在浮点实现中如何稳健处理掠射情况。\n\n**步骤2：使用提取的已知条件进行验证**\n- **科学依据**：该问题描述了直线与圆柱体的相交，这是计算几何和高能物理中使用的粒子径迹追踪模拟中的一个基本问题。直线近似在短距离或无场区域内是有效的。该设置在科学上和数学上都是合理的。\n- **适定性**：问题定义清晰。我们可以检查给定的起始点是否确实在圆柱体内：$x_{0}^{2} + y_{0}^{2} = (0.5)^{2} + (-0.6)^{2} = 0.25 + 0.36 = 0.61$。圆柱半径的平方为 $r^{2} = (1.3)^{2} = 1.69$。由于 $0.61  1.69$，该点在内部。我们还验证方向向量是否归一化：$|\\mathbf{d}|^2 = d_{x}^{2} + d_{y}^{2} + d_{z}^{2} = (0.4)^{2} + (0.5)^{2} + (\\sqrt{0.59})^{2} = 0.16 + 0.25 + 0.59 = 1.00$。所有条件都满足，问题是适定的，并且存在唯一、有意义的解。\n- **客观性**：问题使用精确的数学语言陈述，没有歧义或主观论断。\n\n**步骤3：结论与行动**\n问题有效。将提供完整的推导和解答。\n\n**交点参数的推导**\n\n轨迹由参数方程给出 $\\mathbf{x}(t) = \\mathbf{x}_{0} + t\\mathbf{d}$。其分量形式为：\n$$x(t) = x_{0} + t d_{x}$$\n$$y(t) = y_{0} + t d_{y}$$\n$$z(t) = z_{0} + t d_{z}$$\n\n圆柱面由方程 $x^{2} + y^{2} = r^{2}$ 定义。请注意，该方程与 $z$ 坐标无关，因此我们只需要考虑轨迹在 $xy$ 平面上的投影。\n\n为了找到交点，我们将 $x(t)$ 和 $y(t)$ 的参数表达式代入圆柱体方程：\n$$ (x_{0} + t d_{x})^{2} + (y_{0} + t d_{y})^{2} = r^{2} $$\n\n展开各项，我们得到：\n$$ (x_{0}^{2} + 2 t x_{0} d_{x} + t^{2} d_{x}^{2}) + (y_{0}^{2} + 2 t y_{0} d_{y} + t^{2} d_{y}^{2}) = r^{2} $$\n\n我们通过按 $t$ 的幂次对各项进行分组，将其重新排列成 $At^{2} + Bt + C = 0$ 形式的标准二次方程：\n$$ t^{2}(d_{x}^{2} + d_{y}^{2}) + t(2x_{0}d_{x} + 2y_{0}d_{y}) + (x_{0}^{2} + y_{0}^{2} - r^{2}) = 0 $$\n\n因此，系数 $A$、$B$ 和 $C$ 分别为：\n$$ A = d_{x}^{2} + d_{y}^{2} $$\n$$ B = 2(x_{0}d_{x} + y_{0}d_{y}) $$\n$$ C = x_{0}^{2} + y_{0}^{2} - r^{2} $$\n\n这些可以用向量符号更简洁地表示 $xy$ 平面中的分量。设 $\\mathbf{x}_{0, \\perp} = (x_{0}, y_{0})$ 和 $\\mathbf{d}_{\\perp} = (d_{x}, d_{y})$。系数变为：\n$$ A = \\mathbf{d}_{\\perp} \\cdot \\mathbf{d}_{\\perp} = |\\mathbf{d}_{\\perp}|^{2} $$\n$$ B = 2(\\mathbf{x}_{0, \\perp} \\cdot \\mathbf{d}_{\\perp}) $$\n$$ C = \\mathbf{x}_{0, \\perp} \\cdot \\mathbf{x}_{0, \\perp} - r^{2} = |\\mathbf{x}_{0, \\perp}|^{2} - r^{2} $$\n\n$t$ 的解由二次公式给出：\n$$ t = \\frac{-B \\pm \\sqrt{B^{2} - 4AC}}{2A} $$\n\n问题规定粒子从圆柱体内部开始，这意味着 $|\\mathbf{x}_{0, \\perp}|^{2}  r^{2}$。这表明系数 $C = |\\mathbf{x}_{0, \\perp}|^{2} - r^{2}$ 是负的。系数 $A = |\\mathbf{d}_{\\perp}|^{2}$ 是非负的。对于任何不平行于 $z$ 轴的轨迹（即 $\\mathbf{d}_{\\perp} \\neq \\mathbf{0}$），我们有 $A > 0$。\n\n判别式为 $\\Delta = B^{2} - 4AC$。由于 $A>0$ 和 $C0$，项 $-4AC$ 是正的。因此，$\\Delta = B^{2} - 4AC > B^2 \\geq 0$，这保证了 $t$ 有两个不同的实数根。\n\n根据韦达定理，两根之积为 $t_{1}t_{2} = C/A$。由于 $A>0$ 和 $C0$，乘积 $t_{1}t_{2}$ 是负的。这意味着一个根必须是正的，另一个必须是负的。\n\n两个根是 $t_{\\pm} = \\frac{-B \\pm \\sqrt{\\Delta}}{2A}$。由于 $\\sqrt{\\Delta} > 0$，带加号的根总是大于带减号的根。因为一个根必须是正的，另一个是负的，所以正根必须是较大的那个：\n$$ t = \\frac{-B + \\sqrt{B^{2} - 4AC}}{2A} $$\n这是满足相交条件的最小正值 $t$，代表粒子路径第一次与圆柱壁相交。\n\n**数值计算**\n\n我们已知：\n- $r = 1.3$\n- $\\mathbf{x}_{0} = (0.5, -0.6, 2.0)$\n- $\\mathbf{d} = (0.4, 0.5, \\sqrt{0.59})$\n\n根据这些，我们计算系数 $A$、$B$ 和 $C$：\n$$ A = d_{x}^{2} + d_{y}^{2} = (0.4)^{2} + (0.5)^{2} = 0.16 + 0.25 = 0.41 $$\n$$ B = 2(x_{0}d_{x} + y_{0}d_{y}) = 2((0.5)(0.4) + (-0.6)(0.5)) = 2(0.2 - 0.3) = 2(-0.1) = -0.2 $$\n$$ C = x_{0}^{2} + y_{0}^{2} - r^{2} = (0.5)^{2} + (-0.6)^{2} - (1.3)^{2} = 0.25 + 0.36 - 1.69 = 0.61 - 1.69 = -1.08 $$\n\n接下来，我们计算判别式 $\\Delta = B^{2} - 4AC$：\n$$ \\Delta = (-0.2)^{2} - 4(0.41)(-1.08) = 0.04 + 1.7712 = 1.8112 $$\n\n现在我们计算最小的正根 $t$：\n$$ t = \\frac{-(-0.2) + \\sqrt{1.8112}}{2(0.41)} = \\frac{0.2 + \\sqrt{1.8112}}{0.82} $$\n$$ t \\approx \\frac{0.2 + 1.3458083}{0.82} = \\frac{1.5458083}{0.82} \\approx 1.88513207... $$\n\n四舍五入到四位有效数字，我们得到 $t = 1.885\\,\\mathrm{m}$。\n\n**关于浮点稳健性的讨论**\n\n在浮点实现中，对于掠射（轨迹几乎与圆柱体相切）的情况需要特别小心。\n$1$. **判别式：** 掠射对应于判别式 $\\Delta = B^{2} - 4AC$ 接近于零。由于有限精度，$\\Delta = 0$（相切）的真实值可能被计算为一个小的负数，从而导致没有交点的错误结论。一个稳健的实现应该使用一个公差 $\\epsilon$。如果计算出的 $\\Delta$ 是负的，但其绝对值小于 $\\epsilon$（即 $-\\epsilon  \\Delta  0$），则应通过设置 $\\Delta = 0$ 将其视为切向相交。\n$2$. **数值公差：** $\\epsilon$ 的选择至关重要，它取决于浮点精度（例如，单精度或双精度）和问题的几何尺度。它可以防止对近切向路径的错误“未击中”分类。对于切向击中（$\\Delta=0$），存在唯一的解 $t = -B/(2A)$。\n$3$. **数值稳定的求根方法：** 标准的二次公式在减去两个几乎相等的数时可能会遭受灾难性抵消误差。为了找到正根 $t = (-B + \\sqrt{\\Delta})/(2A)$，如果 $B$ 是正的且 $B \\approx \\sqrt{\\Delta}$，则可能发生抵消。一种更稳定的方法是首先计算分子中涉及加法的根（从而避免减去几乎相等的浮点数），然后使用韦达定理（$t_{1}t_{2} = C/A$）找到另一个根。更稳健计算出的根是 $t_{\\text{stable}} = \\frac{-B - \\operatorname{sgn}(B)\\sqrt{B^{2}-4AC}}{2A}$。另一个根则是 $t_{\\text{other}} = C/(A \\cdot t_{\\text{stable}})$。对于圆柱体内部的起始点，这两个根中一个将是正的，另一个是负的。实现应选择正的那个。无论系数的符号和大小如何，此策略都能避免精度损失。",
            "answer": "$$\\boxed{1.885}$$"
        }
    ]
}