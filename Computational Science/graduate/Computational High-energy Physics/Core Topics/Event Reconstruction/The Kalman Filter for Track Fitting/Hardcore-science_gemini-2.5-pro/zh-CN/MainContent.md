## 引言
在高能物理实验中，精确重建[带电粒子](@entry_id:160311)在探测器中穿行的轨迹——即“[径迹拟合](@entry_id:756088)”——是理解对撞事件、测量粒子动量和识别新物理现象的基石。这些径迹的测量本质上是离散和不精确的，并且受到粒子与探测器材料复杂相互作用的干扰，这对重建算法提出了严峻的挑战。卡尔曼滤波器作为一种强大的递归状态估计算法，为这一问题提供了统计上最优且计算高效的解决方案。然而，要有效地应用它，需要对底层的数学原理、物理模型的构建以及实际应用中的各种复杂情况有深刻的理解。本文旨在系统性地填补这一知识空白，为读者提供一个从理论到实践的完整指南。

在接下来的内容中，我们将分三个章节深入探索。第一章，“原理与机制”，将详细拆解卡尔曼滤波器的核心数学框架，包括如何用状态向量描述粒子径迹、如何对径迹传播（包括[随机过程](@entry_id:159502)）进行建模，以及递归更新的核心方程。第二章，“应用与交叉学科联系”，将展示该方法在真实物理分析中的强大威力，例如通过平滑算法融合未来信息、利用统计检验拒绝离群点，以及其在探测器对准和顶点拟合中的系统级应用，并揭示其与机器人学等领域的深刻联系。最后，第三章，“动手实践”，将通过具体的编程练习，帮助您应对实现过程中的关键挑战。

让我们从构建卡尔曼滤波器[径迹拟合](@entry_id:756088)的基础开始，深入探讨其核心的原理与机制。

## 原理与机制

[卡尔曼滤波器](@entry_id:145240)是一种强大的[递归估计](@entry_id:169954)算法，它为[线性高斯系统](@entry_id:200183)提供了最优的状态估计。在粒子物理中，[带电粒子](@entry_id:160311)的运动轨迹（径迹）通常是[非线性](@entry_id:637147)的，并且受到与探测器材料的随机相互作用的影响。因此，我们通常采用[扩展卡尔曼滤波器](@entry_id:199333)（Extended Kalman Filter, EKF），它通过在当前状态估计处对系统进行线性化来处理[非线性](@entry_id:637147)问题。本章将系统地阐述构成[径迹拟合](@entry_id:756088)[卡尔曼滤波器](@entry_id:145240)的核心原理与机制。

### 粒子径迹的[状态空间](@entry_id:177074)表述

为了应用卡尔曼滤波器，我们首先必须将被估计的物理系统——即粒子径迹——用**状态向量** (state vector) 来描述。[状态向量](@entry_id:154607) $\mathbf{x}$ 是一个包含了在某一特定时刻（或位置）完全确定粒子运动轨迹所需的最少参数的集合。选择合适的参数化方式对于滤波器的性能和数值稳定性至关重要。

一个在[计算高能物理](@entry_id:747619)中广泛应用的例子是在均匀[螺线管磁场](@entry_id:264987)（即[磁场](@entry_id:153296) $\mathbf{B}$ 平行于束流轴，例如 $z$ 轴）中运动的[带电粒子](@entry_id:160311)的**近地点参数**（perigee parameters）表示法 。近地点被定义为径迹在横向平面（$xy$ 平面）上最接近束流轴（$z$ 轴）的点。一个典型的五参数状态向量可以定义为 $\mathbf{x} = (d_0, \phi_0, \omega, z_0, \tan\lambda)^T$，其中：

-   $d_0$：带符号的横向冲击参数（transverse impact parameter），即近地点处径迹到 $z$ 轴的距离。其符号通常由径迹的角动量方向决定。
-   $\phi_0$：近地点处横向动量 $\mathbf{p}_T$ 的[方位角](@entry_id:164011)。
-   $\omega$：带符号的曲率（curvature），定义为 $\omega = q / p_T$，其中 $q$ 是粒子[电荷](@entry_id:275494)，$p_T$ 是横向动量的大小。曲率的符号取决于[电荷](@entry_id:275494)，其[绝对值](@entry_id:147688)是横向平面内圆形轨迹半径 $R$ 的倒数，即 $R=1/|\omega|$。因此，$p_T = |q|/|\omega|$。（注：在[高能物理](@entry_id:181260)单位制中，通常设[磁场](@entry_id:153296) $B$ 的值为常数并吸收到定义中，或者 $p_T$ 的单位是 $\text{GeV}/c$ 而 $\omega$ 的单位是 $(\text{GeV}/c)^{-1}$）。
-   $z_0$：近地点处的 $z$ 坐标。
-   $\tan\lambda$：倾角（dip angle）$\lambda$ 的正切。倾角是动量向量 $\mathbf{p}$ 与横向平面之间的夹角，因此 $\tan\lambda = p_z / p_T$，其中 $p_z$ 是纵向动量。

根据这些定义，我们可以在近地点的参考平面上，将状态向量 $\mathbf{x}$ 映射回笛卡尔坐标系下的位置 $\mathbf{r}=(x,y,z)$ 和动量 $\mathbf{p}=(p_x,p_y,p_z)$。在近地点，横向位置向量 $\mathbf{r}_T=(x,y)$ 必须与横向动量向量 $\mathbf{p}_T=(p_x,p_y)$ 正交。这导致了如下的映射关系 ：

位置：
$x = -d_0 \sin\phi_0$
$y = d_0 \cos\phi_0$
$z = z_0$

动量：
$p_x = p_T \cos\phi_0$
$p_y = p_T \sin\phi_0$
$p_z = p_T \tan\lambda$

这种参数化方式非常优雅，因为它将径迹的几何特性和物理特性（如动量）清晰地分离开来。然而，在滤波器的序贯处理中，将状态从一个测量层传播到下一个测量层时，使用其他参数化方式可能更为方便，例如使用[局部坐标](@entry_id:181200)和斜率  。

### 状态转移模型：传播

状态转移模型描述了状态向量如何从一个测量层 $k-1$ 演化到下一个测量层 $k$。这个过程通常分为两个部分：由物理定律（如[洛伦兹力](@entry_id:145104)）决定的**确定性传播**，以及由粒子与物质相互作用引起的**[随机过程](@entry_id:159502)**。

#### 确定性传播 (System Model)

在没有与物质相互作用的理想情况下，[带电粒子](@entry_id:160311)在[磁场中的运动](@entry_id:261998)由[洛伦兹力定律](@entry_id:270735)决定。我们可以将状态向量的演化表示为一个关于路径长度 $s$ 的[微分方程组](@entry_id:148215) $\frac{d\mathbf{x}}{ds} = \mathbf{f}(\mathbf{x}, s)$。

考虑一个简化的状态向量 $\mathbf{x} = (x, y, t_x, t_y, u)^T$，其中 $(x,y)$ 是横向坐标，$t_x = dx/ds$ 和 $t_y = dy/ds$ 是路径在横向平面上的[方向余弦](@entry_id:170591)，而 $u=q/p$ 是带符号的逆动量。在一个沿 $z$ 轴的均匀[磁场](@entry_id:153296) $\mathbf{B} = (0, 0, B)$ 中，运动方程可以从洛伦兹力 $\frac{d\mathbf{p}}{d\tau} = q(\mathbf{v} \times \mathbf{B})$ 导出。通过将[自变量](@entry_id:267118)从时间 $t$ 切换到路径长度 $s$，并假设动量大小 $p$ 恒定（即无能量损失），我们得到 ：
$$
\frac{d\mathbf{t}}{ds} = u B (\mathbf{t} \times \hat{\mathbf{z}})
$$
其中 $\mathbf{t}=(t_x, t_y, t_z)$ 是轨迹的[单位切向量](@entry_id:262985)，$\hat{\mathbf{z}}$ 是z轴[单位向量](@entry_id:165907)。这给出了状态向量各分量的[微分方程](@entry_id:264184)：
$$
\frac{d}{ds} \begin{pmatrix} x \\ y \\ t_x \\ t_y \\ u \end{pmatrix} = \mathbf{f}(\mathbf{x}) = \begin{pmatrix} t_x \\ t_y \\ u B t_y \\ -u B t_x \\ 0 \end{pmatrix}
$$
对于[扩展卡尔曼滤波器](@entry_id:199333)，我们需要将这个[非线性](@entry_id:637147)（尽管在此例中是线性）系统在每一步进行线性化。对于一个小步长 $\Delta s$，[状态传播](@entry_id:634773)可以近似为：
$$
\mathbf{x}_k \approx \mathbf{x}_{k-1} + \mathbf{f}(\mathbf{x}_{k-1}) \Delta s
$$
状态的[协方差矩阵](@entry_id:139155) $P$ 的传播则需要**传播[雅可比矩阵](@entry_id:264467)**（Propagation Jacobian） $F_k$：
$$
P_{k|k-1} = F_k P_{k-1|k-1} F_k^T + Q_k
$$
其中 $P_{k-1|k-1}$ 是在 $k-1$ 层的更新后协[方差](@entry_id:200758)，$P_{k|k-1}$ 是传播到 $k$ 层后的预测协[方差](@entry_id:200758)，$Q_k$ 是我们稍后将讨论的[过程噪声协方差](@entry_id:186358)。[雅可比矩阵](@entry_id:264467) $F_k$ 通过对动力学方程进行泰勒展开得到，对于小步长，可以近似为 $F_k \approx I + J_{k-1} \Delta s$，其中 $J = \frac{\partial \mathbf{f}}{\partial \mathbf{x}}$。例如，对于上述系统，$(J)_{3,5} = \frac{\partial (uBt_y)}{\partial u} = B t_y$ 。

这种方法可以推广到更复杂的情况，例如在缓变[磁场](@entry_id:153296) $\mathbf{B}(\mathbf{r})$ 中运动 。在这种情况下，雅可比矩阵 $J$ 将包含[磁场](@entry_id:153296)的空间导数（梯度），例如 $\partial B_i / \partial x_j$，从而捕捉到由于场不均匀性引起的一阶效应。

#### [随机过程](@entry_id:159502) (Process Noise)

当粒子穿过探测器材料（如硅传感器、支撑结构、冷却管等）时，它会经历随机的物理过程，这些过程偏离了纯粹由[磁场](@entry_id:153296)决定的理想轨迹。这些随机效应被建模为**过程噪声**（process noise）$\mathbf{w}_k$，其统计特性由[过程噪声协方差](@entry_id:186358)矩阵 $Q_k$ 描述。

最重要的两个[随机过程](@entry_id:159502)是：

1.  **[多重库仑散射](@entry_id:752317) (Multiple Coulomb Scattering, MCS)**：粒子因与材料中[原子核](@entry_id:167902)的电[磁相](@entry_id:161372)互作用而发生多次小角度散射，导致其运动方向发生随机变化。对于一个小厚度的材料层，这种效应可以被建模为一个瞬时的角度“踢”。其角度[分布](@entry_id:182848)的[方差](@entry_id:200758) $\sigma_{\theta,i}^2$ 可以由海兰德公式（Highland's formula）等经验公式描述，它依赖于粒子的动量 $p_i$、速度 $\beta_i$ 以及材料的厚度 $t_i$ 和辐射长度 $X_{0,i}$ 。

2.  **能量损失波动 (Energy Loss Straggling)**：粒子通过电离作用损失能量。虽然平均能量损失是确定性的（由[Bethe-Bloch公式](@entry_id:746772)描述），但实际的能量损失是一个[随机过程](@entry_id:159502)，存在涨落。这种能量（动量）的随机变化被称为“straggling”。对于不太薄的吸收层，[能量损失](@entry_id:159152)的[方差](@entry_id:200758) $\mathrm{Var}(\Delta E_i)$ 近似与层厚度 $t_i$ 成正比。

这些随机“踢”会影响状态向量。一个角度上的踢 $\delta\theta_i$ 会直接改变状态中的方向分量。通过[误差传播](@entry_id:147381)，能量的随机变化 $\delta E_i$ 会导致逆动量分量 $\eta = q/p$ 的变化，其[方差](@entry_id:200758) $\sigma_{\eta,i}^2 \approx (\frac{d\eta}{dE})^2 \mathrm{Var}(\Delta E_i)$ 。

更重要的是，这些发生在 $s_i$ 层的随机踢，其影响会通过**[杠杆臂](@entry_id:162693)效应**（lever arm effect）传播到后续的所有测量层。例如，在 $s_i$ 处的一个角度踢 $\delta\theta_i$，会在下游的 $s_N$ 处产生一个横向位置的偏移 $\Delta x(s_N) = (s_N - s_i) \delta\theta_i$。因此，[过程噪声协方差](@entry_id:186358)矩阵 $Q_k$ 不仅包含对角线上的角度和动量[方差](@entry_id:200758)，还包含由于这种传播效应引起的非对角相关项。假设各层之间的[随机过程](@entry_id:159502)是独立的，总的过程噪声矩阵是在一个步长内所有薄散射层贡献的总和 ：
$$
Q(s_N) = \sum_{i=1}^{N} J_i \begin{pmatrix} \sigma_{\theta,i}^2 & 0 \\ 0 & \sigma_{\eta,i}^2 \end{pmatrix} J_i^T
$$
其中 $J_i$ 是将第 $i$ 层的随机踢（角度和动量）传播到目标平面 $N$ 的[雅可比矩阵](@entry_id:264467)。对于一个简化的模型，这可以近似为：
$$
Q(s_N) \approx \sum_{i=1}^{N} \begin{pmatrix} L_i^2\sigma_{\theta,i}^2 & L_i\sigma_{\theta,i}^2 & \dots \\ L_i\sigma_{\theta,i}^2 & \sigma_{\theta,i}^2 & \dots \\ \dots & \dots & \sigma_{\eta,i}^2 \end{pmatrix}
$$
其中 $L_i = s_N - s_i$ 是从散射层 $i$ 到目标平面 $N$ 的[杠杆臂](@entry_id:162693)。

### 测量模型

当粒子穿过一个探测器层时，探测器会提供关于其位置的信息。**测量模型**（measurement model）将抽象的[状态向量](@entry_id:154607) $\mathbf{x}_k$ 与具体的测量值 $\mathbf{y}_k$ 联系起来。这个关系通常表示为：
$$
\mathbf{y}_k = h(\mathbf{x}_k) + \mathbf{v}_k
$$
其中 $h(\cdot)$ 是（可能[非线性](@entry_id:637147)的）测量函数，$\mathbf{v}_k$ 是**[测量噪声](@entry_id:275238)**（measurement noise），通常假设为零均值的高斯分布，其协方差矩阵为 $R_k$。$R_k$ 的对角线元素代表了探测器空间分辨率的平方。

以一个位于特定平面上的硅微条探测器为例，它测量粒子穿过该平面时沿某一方向的[局部坐标](@entry_id:181200)。为了构建测量函数 $h(\mathbf{x}_k)$，我们需要首先计算出由[状态向量](@entry_id:154607) $\mathbf{x}_k$ 所描述的径迹与探测器平面的交点，然后将该交点投影到测量方向上 。

与[状态传播](@entry_id:634773)类似，如果 $h(\cdot)$ 是[非线性](@entry_id:637147)的，我们需要在当前预测状态 $\mathbf{x}_{k|k-1}$ 附近对其进行线性化。这引入了**测量[雅可比矩阵](@entry_id:264467)**（Measurement Jacobian） $H_k$：
$$
H_k = \left. \frac{\partial h}{\partial \mathbf{x}} \right|_{\mathbf{x}_{k|k-1}}
$$
例如，对于一个在 $z=z_c$ 平面、测量 $u$ 坐标的探测器，其状态由 $(x_0, y_0, t_x, t_y)^T$（$z=0$ 处的截距和斜率）描述，经过几何推导，我们可以得到 $H_k$ 的显式表达式 。这个矩阵 $H_k$ 捕捉了[状态向量](@entry_id:154607)各分量的微小变化将如何影响测量值。

### 递归更新

递归更新是卡尔曼滤波器的核心，它将来自[状态传播](@entry_id:634773)的**预测**（prior）与来自探测器的**测量**（measurement）融合在一起，以获得对状态的**更新估计**（posterior）。这个过程可以从贝叶斯定理的角度来理解：后验概率 $\propto$ [似然](@entry_id:167119) $\times$ 先验概率。对于[线性高斯系统](@entry_id:200183)，这意味着我们将两个[高斯分布](@entry_id:154414)（代表预测[状态和](@entry_id:193625)测量信息）相乘以得到一个新的高斯分布（代表更新后的状态）。

这个更新过程由以下几个关键步骤和量来定义 ：

1.  **新息 (Innovation) 或残差 (Residual)**：
    $$
    \mathbf{\nu}_k = \mathbf{y}_k - h(\mathbf{x}_{k|k-1})
    $$
    新息代表了实际测量值与基于先前信息预测的测量值之间的差异。它是进入系统的新信息。

2.  **新息协[方差](@entry_id:200758) (Innovation Covariance)**：
    $$
    S_k = H_k P_{k|k-1} H_k^T + R_k
    $$
    新息的协[方差](@entry_id:200758)由两部分组成：一部分是来自预测状态不确定性（$P_{k|k-1}$）传播到测量空间的不确定性（$H_k P_{k|k-1} H_k^T$），另一部分是测量本身的不确定性（$R_k$）。

3.  **最优[卡尔曼增益](@entry_id:145800) (Optimal Kalman Gain)**：
    $$
    K_k = P_{k|k-1} H_k^T S_k^{-1}
    $$
    [卡尔曼增益](@entry_id:145800)是一个矩阵，它决定了我们应该在多大程度上相信新息并用它来修正我们的预测。它的值在 0 和 1 之间（在多维情况下是矩阵形式），是预测不确定性和测量不确定性之间的一种权衡。

4.  **状态更新 (State Update)**：
    $$
    \mathbf{x}_{k|k} = \mathbf{x}_{k|k-1} + K_k \mathbf{\nu}_k
    $$
    更新后的状态 $\mathbf{x}_{k|k}$ 是在预测状态的基础上，加上按[卡尔曼增益](@entry_id:145800)加权的新息。

5.  **协[方差](@entry_id:200758)更新 (Covariance Update)**：
    $$
    P_{k|k} = (I - K_k H_k) P_{k|k-1}
    $$
    更新后的协[方差](@entry_id:200758) $P_{k|k}$ 会比预测协[方差](@entry_id:200758) $P_{k|k-1}$ 更小（在半正定的意义上），因为我们已经融合了新的测量信息，从而减少了不确定性。

这个[更新过程](@entry_id:273573)的直观行为可以通过分析极限情况来理解 ：
-   当测量极其精确时（$R_k \to 0$），$S_k \to H_k P_{k|k-1} H_k^T$，[卡尔曼增益](@entry_id:145800)趋向于“最大化”，使得更新后的状态很大程度上由测量决定。
-   当测量极其不精确时（$R_k \to \infty$），$S_k \to \infty$，[卡尔曼增益](@entry_id:145800) $K_k \to 0$。滤波器基本上会忽略这个测量，更新后的[状态和](@entry_id:193625)协[方差](@entry_id:200758)将与预测值几乎相同。

### 平滑：融合未来信息

标准的卡尔曼滤波器是一个**前向**过程：在第 $k$ 步的估计只使用了直到第 $k$ 步（包括第 $k$ 步）的测量信息。在许多离线径迹重建应用中，我们可以获得一条径迹上的所有测量点，并希望在每一点上得到利用了**全部**测量信息（包括“未来”的测量点）的最佳估计。这个过程被称为**平滑**（smoothing）。

最常用的平滑算法是**Rauch-Tung-Striebel (RTS) 平滑器**。它在前向[卡尔曼滤波](@entry_id:145240)过程完成之后，再进行一次**后向**传递。在前向传递中，我们存储了所有的预测协[方差](@entry_id:200758) $P_{k+1|k}$ 和滤波协[方差](@entry_id:200758) $P_{k|k}$。

[RTS平滑器](@entry_id:142379)的[后向传递](@entry_id:199535)从最后一个测量点 $N$ 开始，逆向递推至第一个点。其初始化为：
$$
\mathbf{x}_{N|N} = \mathbf{x}_{N|N}, \quad P_{N|N} = P_{N|N}
$$
即在最后一个点，平滑估计等于滤波估计。然后，对于 $k = N-1, \dots, 0$，平滑状态 $\mathbf{x}_{k|N}$ 和协[方差](@entry_id:200758) $P_{k|N}$ 通过以下公式计算：
$$
C_k = P_{k|k} F_k^T (P_{k+1|k})^{-1}
$$
$$
\mathbf{x}_{k|N} = \mathbf{x}_{k|k} + C_k (\mathbf{x}_{k+1|N} - \mathbf{x}_{k+1|k})
$$
$$
P_{k|N} = P_{k|k} + C_k (P_{k+1|N} - P_{k+1|k}) C_k^T
$$
其中 $C_k$ 被称为**[平滑器](@entry_id:636528)增益**（smoother gain）。

直观地看，平滑过程是在滤波估计的基础上，加上一个修正项。这个修正项正比于**后续**的平滑估计 $\mathbf{x}_{k+1|N}$ 与其预测值 $\mathbf{x}_{k+1|k}$ 之间的差异。由于平滑估计融合了来自 $k+1$ 到 $N$ 的测量信息，这个过程有效地将“未来”的信息传播回了当前点 $k$。

因此，平滑估计的不确定性（由 $P_{k|N}$ 的对角[线元](@entry_id:196833)素反映）总是小于或等于滤波估计的不确定性 。对于径迹中间的点，平滑可以显著提高其位置和动量的估计精度。

### 实践考量与验证

一个理论上完美的卡尔曼滤波器在实际应用中仍面临挑战，包括如何验证模型的正确性以及如何确保数值计算的稳定性。

#### 滤波器验证

我们如何知道我们选择的物理模型（过程噪声 $Q_k$）和探测器模型（测量噪声 $R_k$）是准确的？答案在于检查滤波器的[统计一致性](@entry_id:162814)，这通常通过分析新息（残差）来实现。

如果滤波器模型是正确的，那么经过归一化的[新息序列](@entry_id:181232)应该表现为白噪声。我们定义**拉[分布](@entry_id:182848)**（pull）为逐分量归一化的新息 ：
$$
p_{k,i} = \frac{\nu_{k,i}}{\sqrt{(S_k)_{ii}}}
$$
其中 $i$ 是测量向量的分量索引。对于一个正确建模的滤波器，每个拉[分布](@entry_id:182848)分量 $p_{k,i}$ 都应服从均值为0、[方差](@entry_id:200758)为1的标准正态分布 $\mathcal{N}(0, 1)$。通过绘制大量径迹的拉[分布](@entry_id:182848)[直方图](@entry_id:178776)，并检验其是否符合[标准正态分布](@entry_id:184509)，我们可以全面地验证滤波器的性能。例如，如果拉[分布](@entry_id:182848)的宽度远大于1，这通常意味着我们低估了不确定性（即 $S_k$ 太小，可能是因为 $P_{k|k-1}$ 或 $R_k$ 被低估了）。

另一个强大的验证工具是**归一化新息平方 (Normalized Innovation Squared, NIS)** $\chi^2$ 统计量 ：
$$
\chi^2_{\mathrm{NIS},k} = \mathbf{\nu}_k^T S_k^{-1} \mathbf{\nu}_k
$$
对于一个具有 $d_k$ 维测量的单次更新，这个 $\chi^2_{\mathrm{NIS},k}$ 值应该服从自由度为 $d_k$ 的 $\chi^2$ [分布](@entry_id:182848)。而整条径迹的总 $\chi^2$ 是所有独立更新步骤贡献的总和：
$$
\chi^2_{\text{total}} = \sum_{k=1}^N \mathbf{\nu}_k^T S_k^{-1} \mathbf{\nu}_k
$$
对于一个具有 $D$ 个总测量自由度的径迹，这个 $\chi^2_{\text{total}}$ 值应该服从自由度为 $D$ 的 $\chi^2$ [分布](@entry_id:182848)。因此，其[期望值](@entry_id:153208)为 $D$，而 $\chi^2_{\text{total}}/D$ 的[期望值](@entry_id:153208)为1。通过检验这条规则，可以诊断模型的不一致性：
-   如果 $\chi^2_{\text{total}}/D$ 系统性地大于1，表明新息相对于其预测的协[方差](@entry_id:200758)过大，这通常是由于低估了噪声协[方差](@entry_id:200758)（$R_k$ 或 $Q_k$）。
-   如果 $\chi^2_{\text{total}}/D$ 系统性地小于1，则表明高估了噪声协[方差](@entry_id:200758)。

通过结合NIS检验和对新息自相关性的检验，我们甚至可以区分是测量模型（$R_k$）还是动力学模型（$Q_k$）出了问题 。

#### 数值稳定性

[卡尔曼滤波器](@entry_id:145240)的数学公式在有限精度的计算机上执行时可能会遇到数值问题。一个常见的陷阱是当径迹以非常小的掠射角（grazing incidence）穿过探测器平面时 。

在这种情况下，如果使用[全局坐标系](@entry_id:171029)[参数化](@entry_id:272587)，计算测量[雅可比矩阵](@entry_id:264467) $H_k$ 的某些分量可能涉及除以一个接近于零的数（例如，[方向余弦](@entry_id:170591) $t_z$）。这会导致 $H_k$ 的元素变得非常大，从而在计算新息协[方差](@entry_id:200758) $S_k$ 和[卡尔曼增益](@entry_id:145800) $K_k$ 时引发灾难性的精度损失，导致[滤波器发散](@entry_id:749356)。

为了解决这个问题，稳健的[径迹拟合](@entry_id:756088)实现会避免使用[全局坐标系](@entry_id:171029)进行测量更新。一种标准做法是 ：
1.  将预测的[状态向量](@entry_id:154607)和其协方差矩阵传播到测量平面上。
2.  在该平面上，执行一个到**[局部坐标系](@entry_id:751394)**的坐标变换。这个局部坐标系通常被定义为其中一个轴与测量方向对齐。
3.  在这个局部坐标系中，测量函数变得极其简单，例如 $h(\mathbf{x}^{\mathrm{loc}}) = u$，其中 $u$ 是被测量的坐标。对应的[雅可比矩阵](@entry_id:264467) $H_k^{\mathrm{loc}}$ 也变为简单的形式，如 $[1, 0, \dots]$，完全不含[奇点](@entry_id:137764)。
4.  在局部坐标系中执行卡尔曼更新。
5.  将更新后的[状态和](@entry_id:193625)协[方差](@entry_id:200758)变换回[全局坐标系](@entry_id:171029)，以进行到下一层的传播。

这种方法将几何的复杂性从测量更新步骤中解耦出来，将其移至状态变换步骤，从而确保了整个过程的[数值稳定性](@entry_id:146550)，无论径迹的[入射角](@entry_id:192705)度如何。其他更先进的技术，如使用[正交变换](@entry_id:155650)来对角化测量更新，也能达到类似的效果 。