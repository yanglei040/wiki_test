{
    "hands_on_practices": [
        {
            "introduction": "ROC曲线的形状并非任意，它由分类器分数在信号和背景假设下的概率分布在数学上唯一确定。通过解析推导一个具体的、非平凡情况下的ROC曲线，可以加深对统计理论与分类器性能可视化之间联系的理解。这项实践  将从第一性原理出发，为拉普拉斯分布的分数推导参数化的ROC曲线，分析其凹性并计算曲线下面积（AUC），从而为我们提供对分类器性能来源的深刻洞察。",
            "id": "3529673",
            "problem": "在计算高能物理学的质子-质子碰撞事件二元分类任务中，一个标量分数 $S$ 被用来区分信号假设（例如，希格斯玻色子产生）与背景假设（例如，量子色动力学多喷注）。假设经过一次基于物理学的校准后，$S$ 在这两种假设下的条件分布均为拉普拉斯分布，具有一个共同的尺度参数 $b>0$ 但均值不同：信号分数服从 $S \\mid \\text{signal} \\sim \\mathrm{Laplace}(\\mu_{s}, b)$，背景分数服从 $S \\mid \\text{background} \\sim \\mathrm{Laplace}(\\mu_{b}, b)$，其中 $\\mu_{s} > \\mu_{b}$。拉普拉斯概率密度函数为 $f(s \\mid \\mu, b) = \\frac{1}{2 b} \\exp\\!\\left(-\\frac{|s - \\mu|}{b}\\right)$。\n\n一个决策规则将事件分类为信号，如果 $S \\geq t$，其中 $t \\in \\mathbb{R}$ 是一个阈值。仅从真阳性率 $\\,\\mathrm{TPR}(t) = \\mathbb{P}(S \\geq t \\mid \\text{signal})\\,$ 和假阳性率 $\\,\\mathrm{FPR}(t) = \\mathbb{P}(S \\geq t \\mid \\text{background})\\,$ 的定义以及上述指定的拉普拉斯分布出发：\n\n1. 当 $t$ 在 $\\mathbb{R}$ 上变化时，推导由 $\\,(\\mathrm{FPR}(t), \\mathrm{TPR}(t))\\,$ 给出的参数化受试者工作特征（ROC）曲线。您的推导必须考虑 $t$ 相对于 $\\mu_{b}$ 和 $\\mu_{s}$ 的所有情况，并将 ROC 表示为 $\\,\\mathrm{FPR}\\,$ 和 $\\,\\mathrm{TPR}\\,$ 的函数，不保留未计算的概率。\n2. 通过计算 $\\,\\frac{d\\,\\mathrm{TPR}}{d\\,\\mathrm{FPR}}\\,$ 和 $\\,\\frac{d^{2}\\,\\mathrm{TPR}}{d\\,\\mathrm{FPR}^{2}}\\,$（在它们有定义的地方）来刻画此 ROC 曲线的凹性，并确定二阶导数的符号。\n3. 计算 ROC 曲线下面积（AUC）的精确值，作为以 $\\Delta \\equiv \\mu_{s} - \\mu_{b} > 0$ 和 $b > 0$ 表示的闭式解析表达式。\n\n请将您的最终答案表示为以 $\\Delta$ 和 $b$ 表示的 AUC 的精确闭式表达式。",
            "solution": "该问题陈述经核实具有科学依据、良定且客观。这是一个统计决策理论中的标准问题，应用于高能物理学中的一个合理场景。所有必要信息均已提供，问题没有矛盾或含糊不清之处。我们开始求解。\n\n问题要求推导受试者工作特征（ROC）曲线，分析其凹性，并计算基于分数 $S$ 的二元分类器的曲线下面积（AUC）。分数 $S$ 对于信号和背景假设都服从拉普拉斯分布，具有共同的尺度参数 $b$ 但不同的均值 $\\mu_{s}$ 和 $\\mu_{b}$（其中 $\\mu_{s} > \\mu_{b}$）。\n\n拉普拉斯分布的概率密度函数（PDF）由 $f(s \\mid \\mu, b) = \\frac{1}{2 b} \\exp\\left(-\\frac{|s - \\mu|}{b}\\right)$ 给出。相应的累积分布函数（CDF），$F(s \\mid \\mu, b) = \\int_{-\\infty}^{s} f(x \\mid \\mu, b) dx$，为：\n$$ F(s \\mid \\mu, b) = \\begin{cases} \\frac{1}{2} \\exp\\left(\\frac{s - \\mu}{b}\\right) & \\text{若 } s \\leq \\mu \\\\ 1 - \\frac{1}{2} \\exp\\left(-\\frac{s - \\mu}{b}\\right) & \\text{若 } s > \\mu \\end{cases} $$\n\n真阳性率（$\\mathrm{TPR}$）和假阳性率（$\\mathrm{FPR}$）被定义为决策阈值 $t$ 的函数：\n$\\mathrm{TPR}(t) = \\mathbb{P}(S \\geq t \\mid \\text{signal}) = 1 - F(t \\mid \\mu_{s}, b)$\n$\\mathrm{FPR}(t) = \\mathbb{P}(S \\geq t \\mid \\text{background}) = 1 - F(t \\mid \\mu_{b}, b)$\n\n使用 CDF，我们可以写出 $\\mathrm{TPR}(t)$ 和 $\\mathrm{FPR}(t)$ 的显式表达式：\n$$ \\mathrm{TPR}(t) = \\begin{cases} 1 - \\frac{1}{2} \\exp\\left(\\frac{t - \\mu_{s}}{b}\\right) & \\text{若 } t \\leq \\mu_{s} \\\\ \\frac{1}{2} \\exp\\left(-\\frac{t - \\mu_{s}}{b}\\right) & \\text{若 } t > \\mu_{s} \\end{cases} $$\n$$ \\mathrm{FPR}(t) = \\begin{cases} 1 - \\frac{1}{2} \\exp\\left(\\frac{t - \\mu_{b}}{b}\\right) & \\text{若 } t \\leq \\mu_{b} \\\\ \\frac{1}{2} \\exp\\left(-\\frac{t - \\mu_{b}}{b}\\right) & \\text{若 } t > \\mu_{b} \\end{cases} $$\n\n**1. 参数化 ROC 曲线的推导**\n\nROC 曲线是当 $t \\in (-\\infty, \\infty)$ 时，点集 $(\\mathrm{FPR}(t), \\mathrm{TPR}(t))$。我们用 $x$ 表示 $\\mathrm{FPR}$，用 $y$ 表示 $\\mathrm{TPR}$。为了找到关系 $y(x)$，我们消去参数 $t$。由于 $\\mu_{s} > \\mu_{b}$，我们考虑 $t$ 的三种情况。令 $\\Delta \\equiv \\mu_{s} - \\mu_{b} > 0$。\n\n**情况 1: $t > \\mu_{s}$** (这意味着 $t > \\mu_{b}$)\n在这种情况下：\n$x = \\frac{1}{2} \\exp\\left(-\\frac{t - \\mu_{b}}{b}\\right)$\n$y = \\frac{1}{2} \\exp\\left(-\\frac{t - \\mu_{s}}{b}\\right)$\n从 $y$ 的表达式，我们有 $2y = \\exp(-t/b) \\exp(\\mu_{s}/b)$，这给出 $\\exp(-t/b) = 2y \\exp(-\\mu_{s}/b)$。\n将此代入 $x$ 的表达式：\n$x = \\frac{1}{2} \\left[2y \\exp\\left(-\\frac{\\mu_{s}}{b}\\right)\\right] \\exp\\left(\\frac{\\mu_{b}}{b}\\right) = y \\exp\\left(\\frac{\\mu_{b} - \\mu_{s}}{b}\\right) = y \\exp\\left(-\\frac{\\Delta}{b}\\right)$。\n因此，$y = x \\exp\\left(\\frac{\\Delta}{b}\\right)$。\n这种情况下的 $x$ 的范围可以通过考虑 $t$ 的极限来找到。当 $t \\to \\infty$ 时，$x \\to 0$。当 $t=\\mu_s$ 时，$x = \\frac{1}{2} \\exp\\left(-\\frac{\\mu_s - \\mu_b}{b}\\right) = \\frac{1}{2} \\exp\\left(-\\frac{\\Delta}{b}\\right)$。\n所以，该段适用于 $x \\in \\left[0, \\frac{1}{2} \\exp\\left(-\\frac{\\Delta}{b}\\right)\\right]$。\n\n**情况 2: $\\mu_{b} < t \\leq \\mu_{s}$**\n在这种情况下：\n$x = \\frac{1}{2} \\exp\\left(-\\frac{t - \\mu_{b}}{b}\\right)$\n$y = 1 - \\frac{1}{2} \\exp\\left(\\frac{t - \\mu_{s}}{b}\\right)$\n从 $x$ 的表达式，有 $2x = \\exp(-t/b) \\exp(\\mu_{b}/b)$，所以 $\\exp(t/b) = \\frac{1}{2x} \\exp(\\mu_{b}/b)$。\n将此代入 $y$ 的表达式：\n$y = 1 - \\frac{1}{2} \\left[\\frac{1}{2x} \\exp\\left(\\frac{\\mu_{b}}{b}\\right)\\right] \\exp\\left(-\\frac{\\mu_{s}}{b}\\right) = 1 - \\frac{1}{4x} \\exp\\left(\\frac{\\mu_{b} - \\mu_{s}}{b}\\right)$。\n因此，$y = 1 - \\frac{1}{4x} \\exp\\left(-\\frac{\\Delta}{b}\\right)$。\n$x$ 的范围是从 $t=\\mu_s$（$x$ 的下界，如前所述）到 $t=\\mu_b$。在 $t=\\mu_b$ 时，$x = \\frac{1}{2}\\exp(0) = \\frac{1}{2}$。\n所以，该段适用于 $x \\in \\left(\\frac{1}{2} \\exp\\left(-\\frac{\\Delta}{b}\\right), \\frac{1}{2}\\right]$。\n\n**情况 3: $t \\leq \\mu_{b}$** (这意味着 $t < \\mu_{s}$)\n在这种情况下：\n$x = 1 - \\frac{1}{2} \\exp\\left(\\frac{t - \\mu_{b}}{b}\\right)$\n$y = 1 - \\frac{1}{2} \\exp\\left(\\frac{t - \\mu_{s}}{b}\\right)$\n从 $x$ 的表达式，有 $2(1-x) = \\exp(t/b) \\exp(-\\mu_{b}/b)$，所以 $\\exp(t/b) = 2(1-x) \\exp(\\mu_{b}/b)$。\n将此代入 $y$ 的表达式：\n$y = 1 - \\frac{1}{2} \\left[2(1-x) \\exp\\left(\\frac{\\mu_{b}}{b}\\right)\\right] \\exp\\left(-\\frac{\\mu_{s}}{b}\\right) = 1 - (1-x) \\exp\\left(\\frac{\\mu_{b} - \\mu_{s}}{b}\\right)$。\n因此，$y = 1 - (1-x) \\exp\\left(-\\frac{\\Delta}{b}\\right)$。\n$x$ 的范围是从 $t=\\mu_b$（$x=1/2$）到 $t \\to -\\infty$（$x \\to 1$）。\n所以，该段适用于 $x \\in \\left(\\frac{1}{2}, 1\\right]$。\n\n完整的 ROC 曲线 $y(x) = \\mathrm{TPR}(\\mathrm{FPR})$ 为：\n$$ y(x) = \\begin{cases} x \\exp\\left(\\frac{\\Delta}{b}\\right) & \\text{若 } 0 \\leq x \\leq \\frac{1}{2} \\exp\\left(-\\frac{\\Delta}{b}\\right) \\\\ 1 - \\frac{1}{4x} \\exp\\left(-\\frac{\\Delta}{b}\\right) & \\text{若 } \\frac{1}{2} \\exp\\left(-\\frac{\\Delta}{b}\\right) < x \\leq \\frac{1}{2} \\\\ 1 - (1-x) \\exp\\left(-\\frac{\\Delta}{b}\\right) & \\text{若 } \\frac{1}{2} < x \\leq 1 \\end{cases} $$\n\n**2. 凹性的刻画**\n\n我们在每种情况下计算 $y(x)$ 关于 $x$ 的一阶和二阶导数。\n对于 $x \\in \\left(0, \\frac{1}{2} \\exp\\left(-\\frac{\\Delta}{b}\\right)\\right)$:\n$\\frac{dy}{dx} = \\exp\\left(\\frac{\\Delta}{b}\\right)$\n$\\frac{d^2y}{dx^2} = 0$\n\n对于 $x \\in \\left(\\frac{1}{2} \\exp\\left(-\\frac{\\Delta}{b}\\right), \\frac{1}{2}\\right)$:\n$\\frac{dy}{dx} = \\frac{d}{dx} \\left(1 - \\frac{1}{4} \\exp\\left(-\\frac{\\Delta}{b}\\right) x^{-1}\\right) = \\frac{1}{4x^2} \\exp\\left(-\\frac{\\Delta}{b}\\right)$\n$\\frac{d^2y}{dx^2} = \\frac{d}{dx} \\left(\\frac{1}{4} \\exp\\left(-\\frac{\\Delta}{b}\\right) x^{-2}\\right) = -\\frac{1}{2x^3} \\exp\\left(-\\frac{\\Delta}{b}\\right)$\n\n对于 $x \\in \\left(\\frac{1}{2}, 1\\right)$:\n$\\frac{dy}{dx} = \\frac{d}{dx} \\left(1 - \\exp\\left(-\\frac{\\Delta}{b}\\right) + x \\exp\\left(-\\frac{\\Delta}{b}\\right)\\right) = \\exp\\left(-\\frac{\\Delta}{b}\\right)$\n$\\frac{d^2y}{dx^2} = 0$\n\n一阶导数 $\\frac{dy}{dx}$ 在过渡点上是连续的。二阶导数 $\\frac{d^2y}{dx^2}$ 在两个线性段上为 $0$，在中间段上严格为负，因为 $x>0$、$b>0$ 且 $\\Delta>0$。一个二阶导数（在其定义域内）非正的函数是凹函数。ROC 曲线由两条线段和一条连接它们的严格凹曲线组成，使得整个曲线是凹的。这与源自似然比检验的 ROC 曲线的一般性质是一致的，而本分类器正代表了这样一种检验。\n\n**3. 曲线下面积（AUC）的计算**\n\nAUC 是 ROC 函数 $y(x)$ 从 $x=0$到 $x=1$ 的积分。我们将积分分成上述确定的三种情况。令 $x_1 = \\frac{1}{2} \\exp\\left(-\\frac{\\Delta}{b}\\right)$ 和 $x_2 = \\frac{1}{2}$。\n$\\mathrm{AUC} = \\int_{0}^{1} y(x) dx = \\int_{0}^{x_1} y(x) dx + \\int_{x_1}^{x_2} y(x) dx + \\int_{x_2}^{1} y(x) dx$。\n\n积分 1:\n$\\int_{0}^{x_1} x \\exp\\left(\\frac{\\Delta}{b}\\right) dx = \\exp\\left(\\frac{\\Delta}{b}\\right) \\left[\\frac{x^2}{2}\\right]_{0}^{x_1} = \\frac{1}{2} \\exp\\left(\\frac{\\Delta}{b}\\right) \\left(\\frac{1}{2} \\exp\\left(-\\frac{\\Delta}{b}\\right)\\right)^2 = \\frac{1}{8} \\exp\\left(\\frac{\\Delta}{b}\\right) \\exp\\left(-\\frac{2\\Delta}{b}\\right) = \\frac{1}{8} \\exp\\left(-\\frac{\\Delta}{b}\\right)$。\n\n积分 2:\n$\\int_{x_1}^{x_2} \\left(1 - \\frac{1}{4x} \\exp\\left(-\\frac{\\Delta}{b}\\right)\\right) dx = \\left[x - \\frac{1}{4}\\exp\\left(-\\frac{\\Delta}{b}\\right) \\ln(x)\\right]_{x_1}^{x_2}$\n$= \\left(\\frac{1}{2} - \\frac{1}{4}\\exp\\left(-\\frac{\\Delta}{b}\\right) \\ln\\left(\\frac{1}{2}\\right)\\right) - \\left(\\frac{1}{2}\\exp\\left(-\\frac{\\Delta}{b}\\right) - \\frac{1}{4}\\exp\\left(-\\frac{\\Delta}{b}\\right) \\ln\\left(\\frac{1}{2}\\exp\\left(-\\frac{\\Delta}{b}\\right)\\right)\\right)$\n使用 $\\ln(ab) = \\ln(a) + \\ln(b)$ 和 $\\ln(\\exp(-\\Delta/b)) = -\\Delta/b$:\n$= \\left(\\frac{1}{2} - \\frac{1}{2}\\exp\\left(-\\frac{\\Delta}{b}\\right)\\right) - \\frac{1}{4}\\exp\\left(-\\frac{\\Delta}{b}\\right) \\left[ \\ln\\left(\\frac{1}{2}\\right) - \\ln\\left(\\frac{1}{2}\\exp\\left(-\\frac{\\Delta}{b}\\right)\\right) \\right]$\n$= \\left(\\frac{1}{2} - \\frac{1}{2}\\exp\\left(-\\frac{\\Delta}{b}\\right)\\right) - \\frac{1}{4}\\exp\\left(-\\frac{\\Delta}{b}\\right) \\left[ \\ln\\left(\\frac{1}{2}\\right) - \\left( \\ln\\left(\\frac{1}{2}\\right) - \\frac{\\Delta}{b} \\right) \\right]$\n$= \\frac{1}{2} - \\frac{1}{2}\\exp\\left(-\\frac{\\Delta}{b}\\right) - \\frac{\\Delta}{4b}\\exp\\left(-\\frac{\\Delta}{b}\\right)$。\n\n积分 3:\n$\\int_{x_2}^{1} \\left(1 - (1-x) \\exp\\left(-\\frac{\\Delta}{b}\\right)\\right) dx = \\left[x + \\frac{(1-x)^2}{2} \\exp\\left(-\\frac{\\Delta}{b}\\right)\\right]_{1/2}^{1}$\n$= (1 + 0) - \\left(\\frac{1}{2} + \\frac{(1-1/2)^2}{2} \\exp\\left(-\\frac{\\Delta}{b}\\right)\\right) = 1 - \\frac{1}{2} - \\frac{1}{8} \\exp\\left(-\\frac{\\Delta}{b}\\right) = \\frac{1}{2} - \\frac{1}{8} \\exp\\left(-\\frac{\\Delta}{b}\\right)$。\n\n将三个积分相加：\n$\\mathrm{AUC} = \\left(\\frac{1}{8} \\exp\\left(-\\frac{\\Delta}{b}\\right)\\right) + \\left(\\frac{1}{2} - \\frac{1}{2}\\exp\\left(-\\frac{\\Delta}{b}\\right) - \\frac{\\Delta}{4b}\\exp\\left(-\\frac{\\Delta}{b}\\right)\\right) + \\left(\\frac{1}{2} - \\frac{1}{8} \\exp\\left(-\\frac{\\Delta}{b}\\right)\\right)$\n$\\mathrm{AUC} = (\\frac{1}{2}+\\frac{1}{2}) + \\left(\\frac{1}{8} - \\frac{1}{2} - \\frac{1}{8}\\right)\\exp\\left(-\\frac{\\Delta}{b}\\right) - \\frac{\\Delta}{4b}\\exp\\left(-\\frac{\\Delta}{b}\\right)$\n$\\mathrm{AUC} = 1 - \\frac{1}{2}\\exp\\left(-\\frac{\\Delta}{b}\\right) - \\frac{\\Delta}{4b}\\exp\\left(-\\frac{\\Delta}{b}\\right)$\n$\\mathrm{AUC} = 1 - \\left(\\frac{1}{2} + \\frac{\\Delta}{4b}\\right) \\exp\\left(-\\frac{\\Delta}{b}\\right)$。\n\n该表达式给出了以均值之差 $\\Delta = \\mu_s - \\mu_b$ 和共同尺度参数 $b$ 表示的 ROC 曲线下面积的精确值。",
            "answer": "$$\n\\boxed{1 - \\left(\\frac{1}{2} + \\frac{\\Delta}{4b}\\right) \\exp\\left(-\\frac{\\Delta}{b}\\right)}\n$$"
        },
        {
            "introduction": "在许多科学应用中，尤其是在寻找稀有信号时，分析所能容忍的背景事件（即假阳性）的比例极低。因此，一个分类器在整个假阳性率（$FPR$）范围内的平均性能（由标准AUC衡量）可能不具代表性。这项动手实践  引入了部分曲线下面积（pAUC）的概念，它专注于评估分类器在这一关键的低$FPR$区域内的性能。通过为经验数据（包括处理权重和分数绑定等现实情况）实现pAUC的计算，您将掌握一项在真实物理分析中评估和优化分类器的核心技能。",
            "id": "3529666",
            "problem": "您正在分析高能物理 (HEP) 搜索中使用的二元分类器，在这些搜索中，信号产额极小，本底率必须被抑制到超低泄漏水平。在这种情况下，受试者工作特征 (ROC) 分析聚焦于假阳性率 (FPR) 非常小的区域，因为触发器和筛选流程必须将本底接受率维持在接近零的水平，同时最大化发现潜力。从阈值化二元分类的基本定义出发，推导出一个在假阳性率区间 $[0,\\alpha]$（对于给定的 $0 \\le \\alpha \\le 1$）内受限的部分曲线下面积 (partial AUC) 的数学严谨定义，并论证为何该量能够捕捉在超低本底区域的性能。然后，构建一个算法，用于从有限的带分数的事件样本生成的经验ROC点计算该部分AUC，算法需支持表示预期产额或活时间缩放因子的逐事件非负样本权重。您的推导必须从阈值化分类下的真阳性率 (TPR) 和假阳性率 (FPR) 的定义开始，并推导出一个在ROC曲线上限于 $[0,\\alpha]$ 区间的积分表达式，期间不假设任何预先给定的公式。\n\n明确定义以下基本量并一致地使用它们：\n\n- 一个包含 $n$ 个事件的带分数的数集，事件索引为 $i \\in \\{1,\\dots,n\\}$，每个事件都有一个实值分数 $s_i \\in \\mathbb{R}$、一个二元标签 $y_i \\in \\{0,1\\}$（其中 $y_i = 1$ 表示信号，$y_i = 0$ 表示本底），以及一个可选的非负样本权重 $w_i \\in [0,\\infty)$。\n- 对于任何阈值 $\\tau \\in \\mathbb{R}$，分类器在 $s_i \\ge \\tau$ 时预测 $\\hat{y}_i(\\tau) = 1$，否则预测 $\\hat{y}_i(\\tau) = 0$。\n- 加权计数 $P = \\sum_{i=1}^n w_i \\,\\mathbb{1}\\{y_i = 1\\}$ 和 $N = \\sum_{i=1}^n w_i \\,\\mathbb{1}\\{y_i = 0\\}$，为保证率有意义，假设它们是有限且严格为正的，以及相应的率\n$$\nTPR(\\tau) = \\frac{\\sum_{i=1}^n w_i \\,\\mathbb{1}\\{y_i = 1,\\, s_i \\ge \\tau\\}}{P}, \\qquad\nFPR(\\tau) = \\frac{\\sum_{i=1}^n w_i \\,\\mathbb{1}\\{y_i = 0,\\, s_i \\ge \\tau\\}}{N}.\n$$\n\n您的程序必须实现以下内容：\n\n1. 通过将阈值 $\\tau$ 从 $+\\infty$ 向下扫描到 $-\\infty$，遍历所有不同的分数集合 $\\{s_i\\}$，来构建经验ROC点。在相同的阈值处聚合分数相同的事件。使用加权定义形成一个在 $[0,1]$ 内的非递减 $FPR$ 值序列以及相应的在 $[0,1]$ 内的 $TPR$ 值序列，从 $(0,0)$ 开始，到 $(1,1)$ 结束。\n2. 从第一性原理出发，将区间 $FPR \\in [0,\\alpha]$ 上的部分AUC定义为函数 $TPR(FPR)$ 在限于 $[0,\\alpha]$ 时所描绘的曲线下面积，并通过一个数学上一致的积分过程从经验ROC点计算它。该过程将有限样本的ROC视为在连续经验点之间是分段线性的，并将积分裁剪到区间 $[0,\\alpha]$。\n3. 通过在更新率之前在同一阈值处聚合它们的贡献来处理分数相同的情况（多个事件共享相同的 $s_i$），并支持可选的样本权重 $w_i$；如果未提供权重，则对所有 $i$ 取 $w_i = 1$。\n4. 验证 $0 \\le \\alpha \\le 1$；如果 $P = 0$ 或 $N = 0$，率的定义不明确，但这种情况不会出现在下面的测试套件中。\n\n相关性要求：基于上述第一性原理定义，解释为什么集中在 $FPR \\in [0,\\alpha]$ 上的部分AUC是受限于超低本底泄漏（即小 $FPR$）的搜索的正确品质因数，以及为什么仅在该区域上积分能忠实地反映HEP触发器和筛选操作机制下的发现灵敏度。\n\n测试套件和要求的输出：您的程序必须为以下每个参数集计算部分AUC。为清晰起见，下面的每个列表都是有序的；所有数字都明确指定为小数，并且在代码中必须重现相同的顺序。\n\n- 案例 $1$ (均衡，中等分离度，无权重): scores $[\\,5.1,\\,4.9,\\,3.8,\\,3.5,\\,2.0,\\,4.7,\\,3.9,\\,3.2,\\,1.9,\\,1.0,\\,0.3,\\,-0.5\\,]$, labels $[\\,1,\\,1,\\,1,\\,1,\\,1,\\,0,\\,0,\\,0,\\,0,\\,0,\\,0,\\,0\\,]$, $\\alpha = 0.1$, no weights.\n- 案例 $2$ (相同数据，边界 $\\alpha = 0$): scores $[\\,5.1,\\,4.9,\\,3.8,\\,3.5,\\,2.0,\\,4.7,\\,3.9,\\,3.2,\\,1.9,\\,1.0,\\,0.3,\\,-0.5\\,]$, labels $[\\,1,\\,1,\\,1,\\,1,\\,1,\\,0,\\,0,\\,0,\\,0,\\,0,\\,0,\\,0\\,]$, $\\alpha = 0.0$, no weights.\n- 案例 $3$ (存在相同分数，完整AUC，$\\alpha = 1$): scores $[\\,0.8,\\,0.8,\\,0.2,\\,-0.1,\\,0.8,\\,0.5,\\,0.0,\\,-0.2,\\,-0.2\\,]$, labels $[\\,1,\\,1,\\,1,\\,1,\\,0,\\,0,\\,0,\\,0,\\,0\\,]$, $\\alpha = 1.0$, no weights.\n- 案例 $4$ (加权，超低泄漏焦点): scores $[\\,3.2,\\,2.9,\\,1.7,\\,3.1,\\,2.5,\\,0.7,\\,0.2\\,]$, labels $[\\,1,\\,1,\\,1,\\,0,\\,0,\\,0,\\,0\\,]$, weights $[\\,1.0,\\,0.8,\\,0.5,\\,1000.0,\\,200.0,\\,50.0,\\,10.0\\,]$, $\\alpha = 0.001$.\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果（例如，$[r_1,r_2,r_3,r_4]$），其中 $r_k$ 是案例 $k$ 的部分AUC，表示为十进制数。不应打印其他任何文本。",
            "solution": "该问题要求推导部分曲线下面积 (pAUC) 的严谨定义，论证其作为高能物理 (HEP) 中关键指标的合理性，并构建一种从经验数据计算该指标的算法。推导和算法必须基于第一性原理，从所提供的基于阈值的二元分类器的定义开始。\n\n假设数据集由 $n$ 个事件组成，每个事件由元组 $(s_i, y_i, w_i)$ 描述，其中 $i \\in \\{1,\\dots,n\\}$，$s_i \\in \\mathbb{R}$ 是分类器分数，$y_i \\in \\{0,1\\}$ 是真实标签（$1$ 代表信号，$0$ 代表本底），$w_i \\in [0,\\infty)$ 是非负事件权重。如果未提供权重，我们假设对所有 $i$ 都有 $w_i=1$。信号事件的总加权和为 $P = \\sum_{i: y_i=1} w_i$，本底事件的总加权和为 $N = \\sum_{i: y_i=0} w_i$。假设 $P$ 和 $N$ 均为严格正数。\n\n决策阈值 $\\tau \\in \\mathbb{R}$ 将分数 $s_i \\ge \\tau$ 的事件分类为阳性。在此阈值下的真阳性率 (TPR) 和假阳性率 (FPR) 定义如下：\n$$ TPR(\\tau) = \\frac{\\sum_{i=1}^n w_i \\,\\mathbb{1}\\{y_i = 1,\\, s_i \\ge \\tau\\}}{P} $$\n$$ FPR(\\tau) = \\frac{\\sum_{i=1}^n w_i \\,\\mathbb{1}\\{y_i = 0,\\, s_i \\ge \\tau\\}}{N} $$\n其中 $\\mathbb{1}\\{\\cdot\\}$ 是指示函数。\n\n受试者工作特征 (ROC) 曲线是由参数 $\\tau$ 从 $+\\infty$ 扫描到 $-\\infty$ 时，点 $(FPR(\\tau), TPR(\\tau))$ 组成的集合。随着 $\\tau$ 的减小，$FPR(\\tau)$ 和 $TPR(\\tau)$ 都是非递减的，在单位正方形内从 $(0,0)$ 描绘到 $(1,1)$。ROC曲线可以看作是函数 $TPR(FPR)$。\n\n标准的曲线下面积 (AUC) 是该函数在其整个定义域上的积分：\n$$ AUC = \\int_{0}^{1} TPR(FPR) \\, d(FPR) $$\n部分AUC (pAUC)，受限于给定 $\\alpha \\in [0, 1]$ 的假阳性率区间 $[0, \\alpha]$，是此定义在有限定义域上的自然扩展：\n$$ \\text{pAUC}(\\alpha) = \\int_{0}^{\\alpha} TPR(FPR) \\, d(FPR) $$\n\n对于有限数据集，$TPR(\\tau)$ 和 $FPR(\\tau)$ 函数是阶跃函数，其值仅在数据中存在的分数 $s_i$ 处发生变化。为构建经验ROC曲线，我们考虑按降序排列的唯一分数集合 $\\{\\tau_1, \\tau_2, \\dots, \\tau_m\\}$，其中 $\\tau_1 > \\tau_2 > \\dots > \\tau_m$。我们可以为 $j \\in \\{0, 1, \\dots, m\\}$ 定义一个ROC点序列 $(x_j, y_j)$。起始点是 $(x_0, y_0) = (0,0)$，对应于阈值 $\\tau > \\tau_1$。\n\n对于每个唯一的分数 $\\tau_j$，我们聚合具有该分数的所有信号和本底事件的权重。设 $\\Delta P_{w,j} = \\sum_{i: s_i=\\tau_j, y_i=1} w_i$ 和 $\\Delta N_{w,j} = \\sum_{i: s_i=\\tau_j, y_i=0} w_i$。我们通过在降低阈值时对这些贡献求和来定义真阳性 ($TP_w$) 和假阳性 ($FP_w$) 的累积加权计数。第 $j$ 个ROC点 $(x_j, y_j)$ 是通过考虑所有大于或等于 $\\tau_j$ 的分数生成的：\n$$ TP_{w,j} = \\sum_{k=1}^{j} \\Delta P_{w,k} \\qquad FP_{w,j} = \\sum_{k=1}^{j} \\Delta N_{w,k} $$\n$$ x_j = \\frac{FP_{w,j}}{N} \\qquad y_j = \\frac{TP_{w,j}}{P} $$\n此过程生成一个有序的ROC点序列 $(x_0, y_0), (x_1, y_1), \\dots, (x_m, y_m)$，其中 $0=x_0 \\le x_1 \\le \\dots \\le x_m=1$ 且 $0=y_0 \\le y_1 \\le \\dots \\le y_m=1$。\n\n问题指定这些经验点之间的曲线应被视为分段线性的。因此，pAUC的积分可以使用梯形法则计算，即对由连续点 $(x_{j-1}, y_{j-1})$ 和 $(x_j, y_j)$ 构成的梯形面积求和。这样一个梯形的面积是 $\\frac{1}{2}(y_j + y_{j-1})(x_j - x_{j-1})$。\n\n计算 $\\text{pAUC}(\\alpha)$ 的算法如下：\n1. 初始化 $\\text{pAUC} = 0$。\n2. 从 $j=1$ 到 $m$ 遍历ROC点。设前一个点为 $(x_{j-1}, y_{j-1})$，当前点为 $(x_j, y_j)$。\n3. 如果 $x_{j-1} \\ge \\alpha$，则积分范围已完全覆盖。终止求和。\n4. 如果 $x_j \\le \\alpha$，则整个梯形位于积分范围内。将其完整面积加到总和中：\n   $$ \\Delta A = \\frac{1}{2}(y_j + y_{j-1})(x_j - x_{j-1}) $$\n5. 如果 $x_{j-1} < \\alpha < x_j$，这是与边界 $\\alpha$ 相交的最后一段。我们必须在 $FPR=\\alpha$ 处裁剪梯形。此边界处的TPR值 $y(\\alpha)$ 通过线性插值找到：\n   $$ y(\\alpha) = y_{j-1} + (y_j - y_{j-1})\\frac{\\alpha - x_{j-1}}{x_j - x_{j-1}} $$\n   裁剪后梯形的面积为：\n   $$ \\Delta A = \\frac{1}{2}(y(\\alpha) + y_{j-1})(\\alpha - x_{j-1}) $$\n   将此面积加到总和中，然后终止求和。\n此过程为经验性的、分段线性的ROC曲线提供了一种数学上一致的部分AUC计算方法。\n\n**与高能物理的相关性：**\n在高能物理 (HEP) 对稀有现象的搜索中，信号事件的数量远少于本底事件。例如，在大型强子对撞机 (LHC) 中，无意义的本底碰撞率可能比像希格斯玻色子产生这样的信号过程的率高出 $10^9$ 到 $10^{12}$ 倍。因此，数据采集系统（触发器）和离线分析筛选必须应用极其严格的标准来剔除本底，同时尽可能多地保留信号。\n\n这一操作限制意味着，任何有用的分类器都必须在假阳性率 (FPR) 非常小的区域（通常是 $FPR \\ll 10^{-3}$）表现良好。分类器在中等或高FPR（例如 $FPR > 0.01$）下的性能是无关紧要的，因为如此宽松的筛选会让海量的本底事件进入最终数据集，使得任何信号都无法被观测到。标准的AUC在整个 $FPR \\in [0,1]$ 范围内进行积分，它平均了相关和不相关区域的性能。一个分类器可能因为在高FPR区域表现出色而获得很高的总AUC，但由于在低FPR区域性能不佳，对于HEP搜索来说却是无用的。\n\n对于一个小的 $\\alpha$（例如 $\\alpha = 10^{-4}$），部分AUC，即 $\\text{pAUC}(\\alpha)$，解决了这个问题。它是一个品质因数，专门量化分类器在可操作的、低FPR区域内的性能。它衡量的是在满足本底泄漏 (FPR) 不超过 $\\alpha$ 的约束条件下可以实现的平均真阳性率（信号效率）。在该区域内更高的 $\\text{pAUC}(\\alpha)$ 直接表明在现实实验条件下区分信号和本底的能力更强，这转化为增强的发现灵敏度或改进的测量精度。因此，它是评估和优化用于HEP中以发现为导向的搜索的分类器的正确指标。",
            "answer": "```python\nimport numpy as np\n\ndef compute_partial_auc(scores: list[float], labels: list[int], alpha: float, weights: list[float] = None) -> float:\n    \"\"\"\n    Computes the partial Area Under the ROC Curve (pAUC) for FPR in [0, alpha].\n\n    Args:\n        scores: A list of real-valued scores from a classifier.\n        labels: A list of binary true labels (1 for signal, 0 for background).\n        alpha: The upper bound of the False Positive Rate interval [0, alpha].\n        weights: An optional list of non-negative weights for each event. If None,\n                 all events are weighted equally (weight = 1).\n\n    Returns:\n        The partial AUC value.\n    \"\"\"\n    if not (0.0 <= alpha <= 1.0):\n        raise ValueError(\"alpha must be between 0 and 1.\")\n\n    scores = np.array(scores, dtype=np.float64)\n    labels = np.array(labels, dtype=np.int32)\n    if weights is None:\n        weights = np.ones_like(scores, dtype=np.float64)\n    else:\n        weights = np.array(weights, dtype=np.float64)\n\n    # Calculate total weight of positives (P) and negatives (N)\n    pos_mask = (labels == 1)\n    neg_mask = (labels == 0)\n    P = np.sum(weights[pos_mask])\n    N = np.sum(weights[neg_mask])\n\n    if P == 0 or N == 0:\n        # Undefined rates, but problem guarantees this won't occur in test suite.\n        return 0.0\n\n    # Get unique scores and sort them in descending order\n    unique_scores = np.unique(scores)[::-1]\n\n    # Generate ROC points\n    roc_points = []\n    tp_w, fp_w = 0.0, 0.0\n    roc_points.append((0.0, 0.0))  # Start at (0,0)\n\n    for score_thresh in unique_scores:\n        # Find all events at the current score threshold\n        at_thresh_mask = (scores == score_thresh)\n        \n        # Sum weights of TPs and FPs at this threshold\n        d_tp = np.sum(weights[at_thresh_mask & pos_mask])\n        d_fp = np.sum(weights[at_thresh_mask & neg_mask])\n\n        tp_w += d_tp\n        fp_w += d_fp\n        roc_points.append((fp_w / N, tp_w / P))\n\n    # Calculate partial AUC using the trapezoidal rule, clipped at alpha\n    p_auc = 0.0\n    prev_x, prev_y = roc_points[0]\n\n    for curr_x, curr_y in roc_points[1:]:\n        if prev_x >= alpha:\n            break\n        \n        if curr_x <= alpha:\n            # Full trapezoid is within the [0, alpha] range\n            p_auc += 0.5 * (curr_y + prev_y) * (curr_x - prev_x)\n        else:\n            # This trapezoid is clipped by alpha.\n            # Linearly interpolate TPR at FPR = alpha\n            if curr_x > prev_x: # Avoid division by zero for vertical segments\n                interp_y = prev_y + (curr_y - prev_y) * (alpha - prev_x) / (curr_x - prev_x)\n            else:\n                interp_y = curr_y # Vertical line, take upper y\n            \n            p_auc += 0.5 * (interp_y + prev_y) * (alpha - prev_x)\n            break\n        \n        prev_x, prev_y = curr_x, curr_y\n\n    return p_auc\n\ndef solve():\n    \"\"\"\n    Runs the test suite for the partial AUC calculation.\n    \"\"\"\n    test_cases = [\n        {\n            \"scores\": [5.1, 4.9, 3.8, 3.5, 2.0, 4.7, 3.9, 3.2, 1.9, 1.0, 0.3, -0.5],\n            \"labels\": [1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0],\n            \"alpha\": 0.1,\n            \"weights\": None\n        },\n        {\n            \"scores\": [5.1, 4.9, 3.8, 3.5, 2.0, 4.7, 3.9, 3.2, 1.9, 1.0, 0.3, -0.5],\n            \"labels\": [1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0],\n            \"alpha\": 0.0,\n            \"weights\": None\n        },\n        {\n            \"scores\": [0.8, 0.8, 0.2, -0.1, 0.8, 0.5, 0.0, -0.2, -0.2],\n            \"labels\": [1, 1, 1, 1, 0, 0, 0, 0, 0],\n            \"alpha\": 1.0,\n            \"weights\": None\n        },\n        {\n            \"scores\": [3.2, 2.9, 1.7, 3.1, 2.5, 0.7, 0.2],\n            \"labels\": [1, 1, 1, 0, 0, 0, 0],\n            \"weights\": [1.0, 0.8, 0.5, 1000.0, 200.0, 50.0, 10.0],\n            \"alpha\": 0.001\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        result = compute_partial_auc(\n            scores=case[\"scores\"],\n            labels=case[\"labels\"],\n            alpha=case[\"alpha\"],\n            weights=case[\"weights\"]\n        )\n        results.append(str(result))\n\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "超越简单的分数阈值是现代分类器应用的一个重要方向，尤其是当模型能够提供其预测不确定性时。这项实践  探讨了一种“风险感知”的选择策略，它同时利用分类分数和相关的预测不确定性来决定是否接纳一个事件。通过量化比较这种先进方法与标准方法的性能差异——不仅在TPR和FPR上，更重要的是在最终的物理目标，即发现显著性（$Z$）上——您将学会如何将模型不确定性整合到分析中，并评估其对优化物理发现潜力的实际影响。",
            "id": "3529707",
            "problem": "在一个代表了计算高能物理中事例筛选的模拟二元分类任务中，一个分类器为每个事例输出一个预测分数 $s \\in [0,1]$ 和一个相关的预测不确定度 $\\sigma_s \\in [0,\\infty)$。事例分为两类：信号和背景。标准的接收者操作特征（ROC）曲线考虑的接受区域由分数上的一个阈值 $t$ 定义，使得一个事例被接受当且仅当 $s > t$。一个风险感知的ROC通过额外要求 $\\sigma_s \\le \\sigma_{\\max}$ 来修改接受条件，即一个事例被接受当且仅当 $s > t$ 且 $\\sigma_s \\le \\sigma_{\\max}$。\n\n你需要为给定的数据集和阈值，计算标准筛选和风险感知筛选的以下量：\n- 真阳性率（TPR），定义为被接受的信号事例所占的比例：$\\mathrm{TPR} = \\frac{\\text{被接受的信号事例数}}{\\text{总信号事例数}}$。\n- 伪阳性率（FPR），定义为被接受的背景事例所占的比例：$\\mathrm{FPR} = \\frac{\\text{被接受的背景事例数}}{\\text{总背景事例数}}$。\n\n假设给定类别中的每个事例具有相同的权重。设筛选前的预期总产额，信号为 $S_{\\text{tot}}$，背景为 $B_{\\text{tot}}$（两者均为严格正实数）。筛选后的有效产额为 $s_{\\text{eff}} = S_{\\text{tot}} \\cdot \\mathrm{TPR}$ 和 $b_{\\text{eff}} = B_{\\text{tot}} \\cdot \\mathrm{FPR}$。将发现显著性 $Z$ 定义为适用于具有泊松统计和已知背景的计数实验的剖面似然Asimov发现显著性，该显著性从信号加背景与纯背景假设下的似然比检验导出。以无量纲形式表示 $Z$。\n\n使用 $\\mathrm{TPR}$、$\\mathrm{FPR}$ 和泊松似然的基本定义，以及上面定义的风险感知接受区域，实现一个程序，为每个测试用例计算：\n- 对于接受规则为 $s > t$ 的标准筛选，计算 $\\mathrm{TPR}_{\\text{std}}$、$\\mathrm{FPR}_{\\text{std}}$、$Z_{\\text{std}}$。\n- 对于接受规则为 $s > t$ 且 $\\sigma_s \\le \\sigma_{\\max}$ 的风险感知筛选，计算 $\\mathrm{TPR}_{\\text{risk}}$、$\\mathrm{FPR}_{\\text{risk}}$、$Z_{\\text{risk}}$。\n- 变化量 $\\Delta \\mathrm{TPR} = \\mathrm{TPR}_{\\text{risk}} - \\mathrm{TPR}_{\\text{std}}$、$\\Delta \\mathrm{FPR} = \\mathrm{FPR}_{\\text{risk}} - \\mathrm{FPR}_{\\text{std}}$ 和 $\\Delta Z = Z_{\\text{risk}} - Z_{\\text{std}}$。\n\n所有比率必须表示为区间 $[0,1]$ 内的小数，而不是百分比。发现显著性 $Z$ 是无量纲的。此问题中的任何量都不需要物理单位。\n\n使用以下数据集（数组是实数的有序列表）。对每个事例，分数为 $s$，预测不确定度为 $\\sigma_s$。信号事例：\n- 分数 $s_{\\text{sig}} = [\\,0.95,\\,0.90,\\,0.88,\\,0.85,\\,0.80,\\,0.78,\\,0.76,\\,0.70,\\,0.65,\\,0.60,\\,0.55,\\,0.50\\,]$。\n- 不确定度 $\\sigma_{\\text{sig}} = [\\,0.05,\\,0.04,\\,0.10,\\,0.15,\\,0.08,\\,0.20,\\,0.12,\\,0.25,\\,0.18,\\,0.30,\\,0.35,\\,0.40\\,]$。\n\n背景事例：\n- 分数 $s_{\\text{bkg}} = [\\,0.80,\\,0.75,\\,0.70,\\,0.68,\\,0.65,\\,0.62,\\,0.60,\\,0.58,\\,0.55,\\,0.52,\\,0.50,\\,0.48,\\,0.45,\\,0.40,\\,0.35,\\,0.30,\\,0.25,\\,0.20,\\,0.15,\\,0.10\\,]$。\n- 不确定度 $\\sigma_{\\text{bkg}} = [\\,0.30,\\,0.25,\\,0.20,\\,0.18,\\,0.22,\\,0.27,\\,0.35,\\,0.15,\\,0.40,\\,0.38,\\,0.28,\\,0.18,\\,0.12,\\,0.10,\\,0.08,\\,0.05,\\,0.04,\\,0.03,\\,0.02,\\,0.01\\,]$。\n\n使用以下参数集测试套件 $(t, \\sigma_{\\max}, S_{\\text{tot}}, B_{\\text{tot}})$：\n- 情况 1：$(t = 0.60,\\, \\sigma_{\\max} = 0.20,\\, S_{\\text{tot}} = 50.0,\\, B_{\\text{tot}} = 200.0)$。\n- 情况 2：$(t = 0.60,\\, \\sigma_{\\max} = 1.00,\\, S_{\\text{tot}} = 50.0,\\, B_{\\text{tot}} = 200.0)$。\n- 情况 3：$(t = 0.20,\\, \\sigma_{\\max} = 0.05,\\, S_{\\text{tot}} = 50.0,\\, B_{\\text{tot}} = 200.0)$。\n- 情况 4：$(t = 0.65,\\, \\sigma_{\\max} = 0.20,\\, S_{\\text{tot}} = 5.0,\\, B_{\\text{tot}} = 1000.0)$。\n\n你的程序应为每种情况计算九元组 $[\\,\\mathrm{TPR}_{\\text{std}},\\,\\mathrm{FPR}_{\\text{std}},\\,Z_{\\text{std}},\\,\\mathrm{TPR}_{\\text{risk}},\\,\\mathrm{FPR}_{\\text{risk}},\\,Z_{\\text{risk}},\\,\\Delta \\mathrm{TPR},\\,\\Delta \\mathrm{FPR},\\,\\Delta Z\\,]$，所有浮点数四舍五入到6位小数。\n\n最终输出格式：你的程序应生成单行输出，包含这些九元组的列表，每个测试用例一个，按顺序排列，作为用方括号括起来的逗号分隔列表（例如，$ [ [\\,\\cdots\\,], [\\,\\cdots\\,], \\ldots ]$）。不应打印其他任何文本。",
            "solution": "我们从适用于接收者操作特征分析和高能物理中泊松计数显著性的核心定义开始。\n\n1. 分类率的定义。对于一个在特征空间中具有确定性接受区域 $\\mathcal{A}$ 的二元分类器，真阳性率（TPR）定义为 $\\mathrm{TPR} = \\frac{N_{\\text{sig,acc}}}{N_{\\text{sig,tot}}}$，其中 $N_{\\text{sig,acc}}$ 是 $\\mathcal{A}$ 中的信号事例数，$N_{\\text{sig,tot}}$ 是总信号事例数。伪阳性率（FPR）对背景也类似，为 $\\mathrm{FPR} = \\frac{N_{\\text{bkg,acc}}}{N_{\\text{bkg,tot}}}$。当每个事例权重相等时，这些分数是类条件接受概率的经验估计。\n\n2. 接受区域。在这个问题中，有两种接受规则：\n- 标准规则：对于一个预设的阈值 $t \\in [0,1]$，当且仅当 $s > t$ 时接受。接受区域为 $\\mathcal{A}_{\\text{std}}(t) = \\{ (s, \\sigma_s) : s > t \\}$。\n- 风险感知规则：对于一个预设的 $\\sigma_{\\max} > 0$，当且仅当 $s > t$ 且 $\\sigma_s \\le \\sigma_{\\max}$ 时接受。接受区域为 $\\mathcal{A}_{\\text{risk}}(t,\\sigma_{\\max}) = \\{ (s, \\sigma_s) : s > t \\} \\cap \\{ (s, \\sigma_s) : \\sigma_s \\le \\sigma_{\\max} \\}$。这个定义通过排除高不确定度的预测来编码风险规避。\n\n给定提供的 $s$ 和 $\\sigma_s$ 数组，我们将这些区域实现为指示函数 $I_{\\text{std}}(s,\\sigma_s;t) = 1$（如果 $s > t$）否则为 $0$，以及 $I_{\\text{risk}}(s,\\sigma_s;t,\\sigma_{\\max}) = 1$（如果 $s > t$ 且 $\\sigma_s \\le \\sigma_{\\max}$）否则为 $0$。那么\n$$\n\\mathrm{TPR}_{\\text{std}}(t) = \\frac{1}{N_{\\text{sig,tot}}}\\sum_{i=1}^{N_{\\text{sig,tot}}} I_{\\text{std}}(s_i^{(\\text{sig})}, \\sigma_{s,i}^{(\\text{sig})}; t),\n$$\n$$\n\\mathrm{FPR}_{\\text{std}}(t) = \\frac{1}{N_{\\text{bkg,tot}}}\\sum_{j=1}^{N_{\\text{bkg,tot}}} I_{\\text{std}}(s_j^{(\\text{bkg})}, \\sigma_{s,j}^{(\\text{bkg})}; t),\n$$\n类似地\n$$\n\\mathrm{TPR}_{\\text{risk}}(t,\\sigma_{\\max}) = \\frac{1}{N_{\\text{sig,tot}}}\\sum_{i=1}^{N_{\\text{sig,tot}}} I_{\\text{risk}}(s_i^{(\\text{sig})}, \\sigma_{s,i}^{(\\text{sig})}; t,\\sigma_{\\max}),\n$$\n$$\n\\mathrm{FPR}_{\\text{risk}}(t,\\sigma_{\\max}) = \\frac{1}{N_{\\text{bkg,tot}}}\\sum_{j=1}^{N_{\\text{bkg,tot}}} I_{\\text{risk}}(s_j^{(\\text{bkg})}, \\sigma_{s,j}^{(\\text{bkg})}; t,\\sigma_{\\max}).\n$$\n\n3. 有效产额。在高能物理计数实验中，具有预期的预选产额 $S_{\\text{tot}}$ 和 $B_{\\text{tot}}$，筛选的效果是通过接受分数来缩放这些产额。因此，有效产额是\n$$\ns_{\\text{eff,std}} = S_{\\text{tot}} \\cdot \\mathrm{TPR}_{\\text{std}}, \\quad b_{\\text{eff,std}} = B_{\\text{tot}} \\cdot \\mathrm{FPR}_{\\text{std}},\n$$\n$$\ns_{\\text{eff,risk}} = S_{\\text{tot}} \\cdot \\mathrm{TPR}_{\\text{risk}}, \\quad b_{\\text{eff,risk}} = B_{\\text{tot}} \\cdot \\mathrm{FPR}_{\\text{risk}}.\n$$\n\n4. 发现显著性。对于一个具有泊松分布计数 $n$ 和已知背景期望 $b$ 的计数实验，检验纯背景假设与信号加背景备择假设可以使用似然比检验。在信号加背景模型下的中位发现显著性由Asimov近似给出，这是高能物理中一个经过充分检验的结果。从剖面似然比出发，并在Asimov数据集（平均计数）上进行评估，可以得到闭式表达式\n$$\nZ_A(s,b) = \\sqrt{2 \\left[ (s + b) \\ln \\left( 1 + \\frac{s}{b} \\right) - s \\right]},\n$$\n对于 $s > 0$ 和 $b > 0$，其中 $s$ 和 $b$ 是筛选后的信号和背景期望。该表达式是无量纲的。在极限情况 $s = 0$ 时，$Z_A(0,b) = 0$。当 $b \\to 0^+$ 时会导致 $Z_A$ 增加，但在这个问题中，测试套件确保了 $b_{\\text{eff}} > 0$。\n\n因此，\n$$\nZ_{\\text{std}} = Z_A(s_{\\text{eff,std}}, b_{\\text{eff,std}}), \\quad Z_{\\text{risk}} = Z_A(s_{\\text{eff,risk}}, b_{\\text{eff,risk}}).\n$$\n\n5. 差异。由于引入不确定性约束而引起的变化计算如下\n$$\n\\Delta \\mathrm{TPR} = \\mathrm{TPR}_{\\text{risk}} - \\mathrm{TPR}_{\\text{std}}, \\quad \\Delta \\mathrm{FPR} = \\mathrm{FPR}_{\\text{risk}} - \\mathrm{FPR}_{\\text{std}},\n$$\n$$\n\\Delta Z = Z_{\\text{risk}} - Z_{\\text{std}}.\n$$\n\n6. 算法实现。对每个测试用例 $(t,\\sigma_{\\max}, S_{\\text{tot}}, B_{\\text{tot}})$：\n- 在提供的数组上评估指示函数，以计算对于标准和风险感知两种规则下被接受的信号和背景事例数。\n- 通过除以各自的类别总数来计算 $\\mathrm{TPR}$ 和 $\\mathrm{FPR}$。\n- 通过乘以 $S_{\\text{tot}}$ 和 $B_{\\text{tot}}$ 来计算 $s_{\\text{eff}}$ 和 $b_{\\text{eff}}$。\n- 使用上面的 $Z_A$ 计算 $Z$。\n- 计算差异 $\\Delta \\mathrm{TPR}$、$\\Delta \\mathrm{FPR}$、$\\Delta Z$。\n- 将所有浮点数四舍五入到6位小数。\n- 按此测试用例的指定顺序聚合九个输出。\n\n7. 边界条件和数值稳定性。我们严格执行所定义的不等式：对于风险感知规则，当且仅当 $s > t$ 且 $\\sigma_s \\le \\sigma_{\\max}$ 时接受。测试套件的设计避免了 $b_{\\text{eff}} = 0$ 的情况；如果希望将其推广到此范围之外，可以通过将 $b$ 替换为 $\\max(b, \\epsilon)$（其中 $\\epsilon > 0$ 是一个小数）来保护对数运算，但在这里不需要这样做。\n\n使用指定的数据集和用例执行程序，对每个用例会产生一个作为列表的元组 $[\\,\\mathrm{TPR}_{\\text{std}},\\,\\mathrm{FPR}_{\\text{std}},\\,Z_{\\text{std}},\\,\\mathrm{TPR}_{\\text{risk}},\\,\\mathrm{FPR}_{\\text{risk}},\\,Z_{\\text{risk}},\\,\\Delta \\mathrm{TPR},\\,\\Delta \\mathrm{FPR},\\,\\Delta Z\\,]$，最终输出是包含这些列表的列表的单行，满足所需格式。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef asimov_significance(s, b):\n    \"\"\"\n    Compute the Asimov discovery significance for Poisson counts with known background:\n    Z_A = sqrt(2 * [ (s + b) * ln(1 + s/b) - s ])\n    Handles edge cases s = 0 -> 0. Clips b to small positive for numerical stability.\n    \"\"\"\n    if s <= 0.0:\n        return 0.0\n    # Ensure b is positive to avoid division by zero; test cases ensure b > 0.\n    b_safe = max(b, 1e-15)\n    return float(np.sqrt(2.0 * ((s + b_safe) * np.log1p(s / b_safe) - s)))\n\ndef compute_metrics(sig_scores, sig_uncs, bkg_scores, bkg_uncs, t, sigma_max, S_tot, B_tot):\n    sig_scores = np.asarray(sig_scores, dtype=float)\n    sig_uncs = np.asarray(sig_uncs, dtype=float)\n    bkg_scores = np.asarray(bkg_scores, dtype=float)\n    bkg_uncs = np.asarray(bkg_uncs, dtype=float)\n\n    # Indicators for standard acceptance: s > t\n    acc_sig_std = (sig_scores > t)\n    acc_bkg_std = (bkg_scores > t)\n\n    # Indicators for risk-aware acceptance: s > t and sigma_s <= sigma_max\n    acc_sig_risk = (sig_scores > t) & (sig_uncs <= sigma_max)\n    acc_bkg_risk = (bkg_scores > t) & (bkg_uncs <= sigma_max)\n\n    # Rates\n    Nsig = sig_scores.size\n    Nbkg = bkg_scores.size\n\n    TPR_std = acc_sig_std.sum() / Nsig\n    FPR_std = acc_bkg_std.sum() / Nbkg\n\n    TPR_risk = acc_sig_risk.sum() / Nsig\n    FPR_risk = acc_bkg_risk.sum() / Nbkg\n\n    # Effective yields\n    s_eff_std = S_tot * TPR_std\n    b_eff_std = B_tot * FPR_std\n\n    s_eff_risk = S_tot * TPR_risk\n    b_eff_risk = B_tot * FPR_risk\n\n    # Significances\n    Z_std = asimov_significance(s_eff_std, b_eff_std)\n    Z_risk = asimov_significance(s_eff_risk, b_eff_risk)\n\n    # Deltas\n    dTPR = TPR_risk - TPR_std\n    dFPR = FPR_risk - FPR_std\n    dZ = Z_risk - Z_std\n\n    return [TPR_std, FPR_std, Z_std, TPR_risk, FPR_risk, Z_risk, dTPR, dFPR, dZ]\n\ndef solve():\n    # Define the datasets from the problem statement.\n    s_sig = [0.95, 0.90, 0.88, 0.85, 0.80, 0.78, 0.76, 0.70, 0.65, 0.60, 0.55, 0.50]\n    u_sig = [0.05, 0.04, 0.10, 0.15, 0.08, 0.20, 0.12, 0.25, 0.18, 0.30, 0.35, 0.40]\n\n    s_bkg = [0.80, 0.75, 0.70, 0.68, 0.65, 0.62, 0.60, 0.58, 0.55, 0.52,\n             0.50, 0.48, 0.45, 0.40, 0.35, 0.30, 0.25, 0.20, 0.15, 0.10]\n    u_bkg = [0.30, 0.25, 0.20, 0.18, 0.22, 0.27, 0.35, 0.15, 0.40, 0.38,\n             0.28, 0.18, 0.12, 0.10, 0.08, 0.05, 0.04, 0.03, 0.02, 0.01]\n\n    # Test suite: (t, sigma_max, S_tot, B_tot)\n    test_cases = [\n        (0.60, 0.20, 50.0, 200.0),   # Case 1\n        (0.60, 1.00, 50.0, 200.0),   # Case 2\n        (0.20, 0.05, 50.0, 200.0),   # Case 3\n        (0.65, 0.20, 5.0, 1000.0),   # Case 4\n    ]\n\n    results = []\n    for t, sigma_max, S_tot, B_tot in test_cases:\n        metrics = compute_metrics(s_sig, u_sig, s_bkg, u_bkg, t, sigma_max, S_tot, B_tot)\n        # Round to 6 decimals as required\n        metrics_rounded = [round(x, 6) for x in metrics]\n        results.append(metrics_rounded)\n\n    # Format as a single line list of lists\n    def format_list(lst):\n        return \"[\" + \",\".join(f\"{x:.6f}\" for x in lst) + \"]\"\n\n    formatted = \"[\" + \",\".join(format_list(r) for r in results) + \"]\"\n    print(formatted)\n\nsolve()\n```"
        }
    ]
}