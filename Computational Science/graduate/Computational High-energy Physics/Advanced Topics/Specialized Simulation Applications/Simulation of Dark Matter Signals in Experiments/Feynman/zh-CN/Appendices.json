{
    "hands_on_practices": [
        {
            "introduction": "暗物质湮灭信号的预期率取决于粒子物理项（湮灭截面 $\\langle \\sigma v \\rangle$）和天体物理项（$J$ 因子）的乘积。本练习  聚焦于后者，要求学生为标准的Navarro-Frenk-White (NFW) 暗物质晕轮廓推导 $J$ 因子。这项解析计算对于预测信号强度和理解其如何依赖于暗物质分布至关重要。",
            "id": "3534035",
            "problem": "一个球对称暗物质晕采用 Navarro-Frenk-White (NFW) 密度剖面进行建模，该剖面由特征密度 $\\rho_{s}$ 和标度半径 $r_{s}$ 定义为 $\\rho(r) = \\rho_{s} \\left[ \\left( \\frac{r}{r_{s}} \\right) \\left( 1 + \\frac{r}{r_{s}} \\right)^{2} \\right]^{-1}$。对于通过粒子湮灭进行的间接探测，天体物理视线 (l.o.s.) $J$ 因子由路径积分 $J = \\int_{\\text{l.o.s.}} \\rho^{2}(s) \\, ds$ 定义，其中 $s$ 是沿视线的坐标。\n\n假设观测者位于距晕中心为 $D \\gg r_{s}$ 的位置，并考虑对应于角间距 $\\psi = 0$ 的中心视线，因此碰撞参数为零。为符合物理真实性，假设密度剖面在一个小半径 $r_{\\min}$ 内被截断为一个常数核心（例如，由于湮灭饱和或重子反馈），因此积分有效地从 $r = r_{\\min} > 0$ 开始。假设视线延伸至无穷远。\n\n仅从上述定义以及球对称系统中视线坐标与径向坐标之间的几何关系出发，推导中心 $J$ 因子 $J_{\\text{NFW}}(\\psi=0; r_{\\min})$ 的一个闭式解析表达式，用 $\\rho_{s}$、$r_{s}$ 和无量纲内截断 $y_{\\min} \\equiv r_{\\min}/r_{s}$ 表示。将你的最终答案表示为单个解析表达式，且不包含任何数值或物理单位。\n\n然后，使用广义 NFW 剖面 $\\rho(r) = \\rho_{s} \\left[ \\left( \\frac{r}{r_{s}} \\right)^{\\gamma} \\left( 1 + \\frac{r}{r_{s}} \\right)^{3-\\gamma} \\right]^{-1}$（其中内斜率参数为 $\\gamma$），定性地解释改变 $\\gamma$ 如何改变 $J_{\\text{NFW}}(\\psi=0; r_{\\min})$ 随 $r_{\\min}$ 变化的标度关系。最后，解释未分辨的子结构如何通过 $\\langle \\rho^{2} \\rangle$ 和 $\\langle \\rho \\rangle^{2}$ 之间的关系来修正信号预测，并定义一个量化此效应的增强因子。\n\n你的最终答案必须是 $J_{\\text{NFW}}(\\psi=0; r_{\\min})$ 的单个闭式解析表达式，用 $\\rho_{s}$、$r_{s}$ 和 $y_{\\min}$ 表示，不带任何单位。不需要四舍五入。",
            "solution": "用于湮灭的天体物理 $J$ 因子由视线积分 $J = \\int_{\\text{l.o.s.}} \\rho^{2}(s)\\, ds$ 定义，其中视线坐标 $s$ 沿着给定方向穿过密度场。对于球对称晕，径向坐标 $r$ 通过 $r = \\sqrt{b^{2} + s^{2}}$ 与碰撞参数 $b$ 和视线坐标 $s$ 相关。对于中心视线，$\\psi = 0$ 意味着 $b = D \\sin \\psi = 0$，所以 $r = |s|$。引入一个具有物理动机的内截断半径 $r_{\\min} > 0$，积分从 $r_{\\min}$ 开始，以避免与 NFW 尖峰相关的发散。\n\n对于 Navarro-Frenk-White 剖面 $\\rho(r) = \\rho_{s}\\left[ \\left( \\frac{r}{r_{s}} \\right) \\left( 1 + \\frac{r}{r_{s}} \\right)^{2} \\right]^{-1}$，密度平方为\n$$\n\\rho^{2}(r) = \\rho_{s}^{2} \\left[ \\left( \\frac{r}{r_{s}} \\right)^{2} \\left( 1 + \\frac{r}{r_{s}} \\right)^{4} \\right]^{-1}.\n$$\n在中心视线上，积分变为\n$$\nJ_{\\text{NFW}}(\\psi=0; r_{\\min}) = \\int_{-\\infty}^{\\infty} \\rho^{2}(|s|)\\, ds = 2 \\int_{r_{\\min}}^{\\infty} \\rho^{2}(r)\\, dr,\n$$\n其中因子 $2$ 考虑了视线的两个对称部分（$s>0$ 和 $s0$）。换元为无量纲径向坐标 $y \\equiv r/r_{s}$，因此 $r = r_{s} y$ 且 $dr = r_{s}\\, dy$，并定义 $y_{\\min} \\equiv r_{\\min}/r_{s}$，我们得到\n$$\nJ_{\\text{NFW}}(\\psi=0; r_{\\min}) = 2 \\rho_{s}^{2} r_{s} \\int_{y_{\\min}}^{\\infty} \\frac{1}{y^{2} (1+y)^{4}}\\, dy.\n$$\n\n我们现在计算积分 $I(y) \\equiv \\int \\frac{dy}{y^{2} (1+y)^{4}}$。一个方便的代换是 $t \\equiv \\frac{1}{1+y}$，这意味着 $y = \\frac{1-t}{t}$ 且 $dy = -\\frac{dt}{t^{2}}$。被积函数简化为\n$$\n\\frac{1}{y^{2} (1+y)^{4}} = \\frac{t^{6}}{(1-t)^{2}},\n$$\n且测度变换为\n$$\n\\frac{t^{6}}{(1-t)^{2}} \\left(-\\frac{dt}{t^{2}}\\right) = - \\frac{t^{4}}{(1-t)^{2}}\\, dt.\n$$\n令 $w \\equiv 1 - t$，我们有 $dt = -dw$ 且 $- \\frac{t^{4}}{(1-t)^{2}}\\, dt = \\frac{(1-w)^{4}}{w^{2}}\\, dw$。展开分子得到\n$$\n\\frac{(1-w)^{4}}{w^{2}} = w^{-2} - 4 w^{-1} + 6 - 4 w + w^{2}.\n$$\n逐项积分，\n$$\nI(y) = \\int \\frac{dy}{y^{2} (1+y)^{4}} = - \\frac{1}{w} - 4 \\ln w + 6 w - 2 w^{2} + \\frac{1}{3} w^{3} + C,\n$$\n其中 $w \\equiv \\frac{y}{1+y}$，$C$ 是积分常数。因此，\n$$\nI(y) = - \\frac{1+y}{y} - 4 \\ln\\!\\left( \\frac{y}{1+y} \\right) + \\frac{6y}{1+y} - \\frac{2 y^{2}}{(1+y)^{2}} + \\frac{1}{3} \\frac{y^{3}}{(1+y)^{3}} + C.\n$$\n\n我们需要从 $y_{\\min}$ 到 $\\infty$ 的定积分。首先计算在无穷远处的极限。当 $y \\to \\infty$ 时，$w \\to 1$，我们发现\n$$\nI(\\infty) = -1 - 4 \\ln(1) + 6 \\cdot 1 - 2 \\cdot 1 + \\frac{1}{3} \\cdot 1 = \\frac{10}{3}.\n$$\n因此，\n$$\n\\int_{y_{\\min}}^{\\infty} \\frac{dy}{y^{2} (1+y)^{4}} = I(\\infty) - I(y_{\\min}) = \\frac{10}{3} + \\frac{1+y_{\\min}}{y_{\\min}} + 4 \\ln\\!\\left( \\frac{y_{\\min}}{1+y_{\\min}} \\right) - \\frac{6 y_{\\min}}{1+y_{\\min}} + \\frac{2 y_{\\min}^{2}}{(1+y_{\\min})^{2}} - \\frac{1}{3} \\frac{y_{\\min}^{3}}{(1+y_{\\min})^{3}}.\n$$\n乘以 $2 \\rho_{s}^{2} r_{s}$ 得到所需的中心 $J$ 因子：\n$$\nJ_{\\text{NFW}}(\\psi=0; r_{\\min}) = 2 \\rho_{s}^{2} r_{s} \\left[ \\frac{10}{3} + \\frac{1+y_{\\min}}{y_{\\min}} + 4 \\ln\\!\\left( \\frac{y_{\\min}}{1+y_{\\min}} \\right) - \\frac{6 y_{\\min}}{1+y_{\\min}} + \\frac{2 y_{\\min}^{2}}{(1+y_{\\min})^{2}} - \\frac{1}{3} \\frac{y_{\\min}^{3}}{(1+y_{\\min})^{3}} \\right].\n$$\n\n我们现在讨论内斜率和子结构的影响。考虑具有内斜率参数 $\\gamma$ 的广义 NFW 剖面，\n$$\n\\rho(r) = \\rho_{s} \\left[ \\left( \\frac{r}{r_{s}} \\right)^{\\gamma} \\left( 1 + \\frac{r}{r_{s}} \\right)^{3-\\gamma} \\right]^{-1}.\n$$\n在中心附近（$r \\ll r_{s}$），其行为类似于 $\\rho(r) \\propto r^{-\\gamma}$，所以 $\\rho^{2}(r) \\propto r^{-2\\gamma}$。在中心视线上，若在 $r_{\\min}$ 处有截断，主导的标度关系是\n$$\nJ(\\psi=0; r_{\\min}) \\sim \\int_{r_{\\min}}^{\\infty} r^{-2\\gamma} \\, dr \\propto\n\\begin{cases}\nr_{\\min}^{1 - 2\\gamma}  \\text{若 } \\gamma \\neq \\frac{1}{2}, \\\\\n\\ln\\!\\left( \\frac{r_{\\text{max}}}{r_{\\min}} \\right)  \\text{若 } \\gamma = \\frac{1}{2},\n\\end{cases}\n$$\n其中 $r_{\\text{max}}$ 是在临界情况 $\\gamma = \\frac{1}{2}$ 下出现在对数项中的一个外标度。因此，更陡的内斜率（更大的 $\\gamma$）增强了 $J$ 对内截断的敏感性，随着 $r_{\\min}$ 的减小而增加中心 $J$ 值。对于经典的 NFW 情况 $\\gamma = 1$，在中心极限下 $J(\\psi=0; r_{\\min}) \\propto r_{\\min}^{-1}$，这与上面推导的显式表达式一致。\n\n未分辨的子结构会修正信号预测，因为湮灭依赖于 $\\langle \\rho^{2} \\rangle$ 而不是 $\\langle \\rho \\rangle^{2}$。对于具有密度涨落的体积元，定义增强因子\n$$\nB \\equiv \\frac{\\langle \\rho^{2} \\rangle}{\\langle \\rho \\rangle^{2}} - 1,\n$$\n这样包含子结构的总 $J$ 因子可以示意性地写为\n$$\nJ_{\\text{tot}} \\simeq J_{\\text{smooth}} \\left( 1 + B \\right).\n$$\n这里的 $B$ 取决于子晕质量函数（例如 $dN/dM \\propto M^{-\\alpha}$）、聚集度-质量关系 $c(M)$、最小团块质量和空间分布以及潮汐演化。通常，$B$ 会增强湮灭信号，通常在子晕受到潮汐破坏较小的大半径处增强得更强，从而与光滑晕模型相比，改变了预测信号的归一化和形态。\n\n所要求的最终答案是如上文推导的、$J_{\\text{NFW}}(\\psi=0; r_{\\min})$ 以 $\\rho_{s}$、$r_{s}$ 和 $y_{\\min}$ 表示的闭式表达式。",
            "answer": "$$\\boxed{2 \\rho_{s}^{2} r_{s} \\left[ \\frac{10}{3} + \\frac{1+y_{\\min}}{y_{\\min}} + 4 \\ln\\!\\left( \\frac{y_{\\min}}{1+y_{\\min}} \\right) - \\frac{6 y_{\\min}}{1+y_{\\min}} + \\frac{2 y_{\\min}^{2}}{(1+y_{\\min})^{2}} - \\frac{1}{3} \\frac{y_{\\min}^{3}}{(1+y_{\\min})^{3}} \\right]}$$"
        },
        {
            "introduction": "在信号预测概念的基础上，本练习  将指导学生完成一次完整的伽马射线线状谱信号搜索模拟。学生将对银河系内和银河系外的信号进行建模，考虑仪器效应和天体物理不确定性，并执行复杂的统计拟合来还原暗物质的属性，例如其质量 $m_\\chi$ 和湮灭截面 $\\langle \\sigma v \\rangle$。此练习浓缩了间接探测中一个真实的数据分析工作流程。",
            "id": "3534024",
            "problem": "您的任务是构建一个独立的程序，用于模拟和拟合暗物质通过过程 $\\chi \\chi \\to \\gamma \\gamma$ 湮灭为两个光子所产生的间接探测伽马射线线状信号，其中要结合子晕增强分布、星系外衰减，以及对使用对数正态先验建模的天体物理 $J$-因子不确定性的模板拟合鲁棒性。推导和实现必须从基本定义和经过充分检验的公式开始。\n\n请从以下关于湮灭流强和似然的基本原理开始：\n\n1. 来自具有天体物理 $J$-因子 $J$ 的单个视线方向感兴趣区域 (ROI) 的暗物质湮灭微分光子流强由下式给出\n$$\n\\frac{d\\Phi_{\\mathrm{gal}}}{dE} = \\frac{\\langle \\sigma v \\rangle}{8 \\pi \\, m_\\chi^2} \\, 2 \\, \\delta(E - m_\\chi) \\, J,\n$$\n其中 $m_\\chi$ 是暗物质粒子质量，$\\langle \\sigma v \\rangle$ 是速度平均的湮灭截面，因子 $2$ 表示每次湮灭产生两个光子。\n\n2. 在平坦的 $\\Lambda$ 冷暗物质宇宙学模型下，对于发射能量为 $E_{\\mathrm{em}} = m_\\chi$ 的单色谱线，单位观测能量 $E$ 的星系外湮灭强度可以表示为对红移 $z$ 的积分，\n$$\n\\frac{d\\Phi_{\\mathrm{ex}}}{dE}(E) = \\frac{c}{8 \\pi} \\frac{\\langle \\sigma v \\rangle}{m_\\chi^2} \\rho_c^2 \\, \\Omega_{\\mathrm{DM}}^2 \\int_0^{z_{\\max}} \\frac{(1+z)^3}{H(z)} e^{-\\tau(E,z)} \\, \\delta\\!\\big(E(1+z) - m_\\chi\\big) \\, dz,\n$$\n其中 $c$ 是光速，$\\rho_c$ 是临界密度，$\\Omega_{\\mathrm{DM}}$ 是暗物质密度参数，$H(z)$ 是哈勃膨胀率，$\\tau(E,z)$ 是星系外背景光的光学深度，$\\delta$ 是狄拉克 $\\delta$ 函数。使用 $H(z) = H_0 \\sqrt{\\Omega_m (1+z)^3 + \\Omega_\\Lambda}$，其中 $\\Omega_m + \\Omega_\\Lambda = 1$。\n\n3. 对银河系谱线的仪器能量响应进行建模，采用具有分数分辨率 $r$ 的高斯能量弥散，使得 $E = m_\\chi$ 处的谱线通过一个宽度为 $\\sigma_E = r \\, m_\\chi$ 且面积为单位 1 的高斯核 $G(E; m_\\chi, \\sigma_E)$ 重建。因此，观测到的银河系谱线强度为\n$$\n\\frac{d\\Phi_{\\mathrm{gal,obs}}}{dE}(E) = \\left(\\frac{\\langle \\sigma v \\rangle}{4 \\pi \\, m_\\chi^2} J\\right) G\\!\\left(E; m_\\chi, \\sigma_E\\right).\n$$\n\n4. 对于光学深度，使用简单的参数化形式\n$$\n\\tau(E,z) = \\tau_0 \\left(\\frac{E}{E_{\\ast}}\\right)^{\\alpha} z,\n$$\n其中 $E_{\\ast} = 100 \\, \\mathrm{GeV}$ 且 $\\alpha = 1.2$。\n\n5. 对于每个 ROI $i$，在能量区间 $j$（中心能量为 $E_j$，宽度为 $\\Delta E$）中预期的观测计数由下式给出：\n$$\n\\mu_{ij} = \\mathcal{E}_i \\, \\Delta E \\left[ \\frac{d\\Phi_{\\mathrm{gal,obs}}}{dE}(E_j; J_i, \\langle \\sigma v \\rangle) + \\Omega_i \\, \\frac{d\\Phi_{\\mathrm{ex}}}{dE}(E_j; \\langle \\sigma v \\rangle) + \\frac{d\\Phi_{\\mathrm{bkg},i}}{dE}(E_j; k_i) \\right],\n$$\n其中 $\\mathcal{E}_i$ 是曝光量（有效面积乘以有效时间），$\\Omega_i$ 是 ROI 的立体角，每个 ROI 的背景谱被建模为具有固定斜率的幂律谱，\n$$\n\\frac{d\\Phi_{\\mathrm{bkg},i}}{dE}(E) = k_i \\left( \\frac{E}{E_0} \\right)^{-\\gamma}.\n$$\n\n6. 观测计数 $n_{ij}$ 被建模为均值为 $\\mu_{ij}$ 的独立泊松随机变量。联合似然函数为\n$$\n\\mathcal{L} = \\prod_{i,j} \\mathrm{Poisson}(n_{ij} \\mid \\mu_{ij}).\n$$\n\n7. 天体物理 $J$-因子存在不确定性。假设每个 ROI 具有独立的对数正态先验，\n$$\n\\ln J_i \\sim \\mathcal{N}(\\ln \\bar{J}_i, \\sigma_{J,\\mathrm{prior}}^2),\n$$\n其中 $\\bar{J}_i$ 是名义估计值，$\\sigma_{J,\\mathrm{prior}}$ 是 $\\ln J$ 的先验宽度。先验密度为：\n$$\np(J_i) = \\frac{1}{J_i \\, \\sigma_{J,\\mathrm{prior}} \\sqrt{2\\pi}} \\exp\\!\\left[-\\frac{(\\ln J_i - \\ln \\bar{J}_i)^2}{2 \\sigma_{J,\\mathrm{prior}}^2}\\right].\n$$\n\n8. 为进行鲁棒性测试，通过应用子晕增强因子 $B_i$ 来生成真实 $J$-因子，即 $J^{\\mathrm{true}}_i = \\bar{J}_i \\, B_i$，其中 $B_i$ 是从一个中位数为 1 的对数正态分布中独立抽取的样本，即 $\\ln B_i \\sim \\mathcal{N}(0, \\sigma_{B}^2)$。\n\n9. 对非负参数 $\\langle \\sigma v \\rangle \\ge 0$ 和 $k_i \\ge 0$ 采用平坦（非正常）先验。\n\n10. 通过最大后验 (MAP) 估计进行拟合，即最大化后验概率：\n$$\n\\mathcal{P}(\\langle \\sigma v \\rangle, \\{k_i\\}, \\{J_i\\} \\mid \\{n_{ij}\\}) \\propto \\mathcal{L} \\times \\prod_i p(J_i).\n$$\n\n您的程序必须：\n\n- 完全按照上述说明实现物理模型，并仔细处理所有常数和单位。\n\n- 使用以下固定的仪器、宇宙学和分析设置：\n  - 暗物质质量 $m_\\chi = 100 \\, \\mathrm{GeV}$。\n  - 能量范围 $E \\in [50 \\, \\mathrm{GeV}, 150 \\, \\mathrm{GeV}]$，包含 $N_{\\mathrm{bins}} = 30$ 个等宽的能量区间，区间宽度为 $\\Delta E = (150 - 50)/30 \\, \\mathrm{GeV}$，中心位于区间中点。\n  - 分数能量分辨率 $r = 0.10$ (即 $\\sigma_E = 0.10 \\, m_\\chi$)。\n  - 固定背景谱指数 $\\gamma = 2.3$，轴心能量 $E_0 = 100 \\, \\mathrm{GeV}$。\n  - 每个 ROI $i$ 的曝光量 $\\mathcal{E}_i = 10^{11} \\, \\mathrm{cm}^2 \\, \\mathrm{s}$。\n  - 每个 ROI $i$ 的立体角 $\\Omega_i = 10^{-4} \\, \\mathrm{sr}$。\n  - 每个 ROI 的名义 $J$-因子：$\\bar{J} = [10^{19}, 3 \\times 10^{19}, 10^{20}, 3 \\times 10^{20}, 10^{21}] \\, \\mathrm{GeV}^2 \\, \\mathrm{cm}^{-5}$。\n  - ROI $i = 1,\\dots,5$ 的真实背景归一化系数 $k^{\\mathrm{true}} = [10^{-12}, 1.5 \\times 10^{-12}, 2 \\times 10^{-12}, 10^{-12}, 3 \\times 10^{-12}] \\, \\mathrm{cm}^{-2} \\, \\mathrm{s}^{-1} \\, \\mathrm{GeV}^{-1}$。\n  - 宇宙学参数：$H_0 = 70 \\, \\mathrm{km} \\, \\mathrm{s}^{-1} \\, \\mathrm{Mpc}^{-1}$，$\\Omega_m = 0.3$，$\\Omega_\\Lambda = 0.7$，$\\Omega_{\\mathrm{DM}} = 0.26$，光速 $c = 2.99792458 \\times 10^{10} \\, \\mathrm{cm} \\, \\mathrm{s}^{-1}$，以及临界密度 $\\rho_c = 1.05375 \\times 10^{-5} h^2 \\, \\mathrm{GeV} \\, \\mathrm{cm}^{-3}$，其中 $h = 0.7$。\n  - 星系外衰减参数化，采用 $E_\\ast = 100 \\, \\mathrm{GeV}$ 和 $\\alpha = 1.2$。\n\n- 通过以下方式生成模拟数据：\n  - 独立抽取 $B_i \\sim \\mathrm{LogNormal}(\\mu=0, \\sigma=\\sigma_B)$ 并设置 $J_i^{\\mathrm{true}} = \\bar{J}_i \\, B_i$。\n  - 使用 $\\langle \\sigma v \\rangle_{\\mathrm{true}}$、$J_i^{\\mathrm{true}}$ 和 $k_i^{\\mathrm{true}}$ 计算预期计数 $\\mu_{ij}$，然后从 $\\mathrm{Poisson}(\\mu_{ij})$ 中抽取 $n_{ij}$。\n  - 使用固定种子 $12345$ 的伪随机数生成器以确保可复现性。\n\n- 对 $\\langle \\sigma v \\rangle \\ge 0$、$k_i \\ge 0$ 和 $J_i  0$ 进行 MAP 拟合，在给定 $J_i$ 宽度为 $\\sigma_{J,\\mathrm{prior}}$ 的对数正态先验和泊松似然的条件下，保持背景谱指数和所有其他常数固定。将星系外分量视为一个各向同性模板，其归一化通过上述宇宙学公式与 $\\langle \\sigma v \\rangle$ 相关联。使用 $z_{\\max} = 5$ 但请注意，$\\delta$ 函数的支撑集强制要求 $z^\\star = m_\\chi/E - 1$。\n\n- 通过使用 $\\delta$ 函数解析地计算红移积分来计算星系外谱线强度：\n  - 对于每个观测能量 $E$，定义 $z^\\star = m_\\chi/E - 1$；如果 $z^\\star  0$ 或 $z^\\star > z_{\\max}$，则将星系外贡献设置为零。\n  - 否则，\n  $$\n  \\frac{d\\Phi_{\\mathrm{ex}}}{dE}(E) = \\frac{c}{8 \\pi} \\frac{\\langle \\sigma v \\rangle}{m_\\chi^2} \\rho_c^2 \\, \\Omega_{\\mathrm{DM}}^2 \\, \\frac{(1+z^\\star)^3}{H(z^\\star)} \\frac{e^{-\\tau(E, z^\\star)}}{E}.\n  $$\n\n- 拟合目标：最大化后验概率的对数（等效于最小化负对数后验概率）。施加正值边界，并使用合适的数值优化器。\n\n测试套件和输出：\n\n对以下三种情况运行上述端到端的模拟和拟合，这些情况探测了不同的鲁棒性区间：\n\n- 情况 A（理想情况）：$\\langle \\sigma v \\rangle_{\\mathrm{true}} = 3 \\times 10^{-26} \\, \\mathrm{cm}^3 \\, \\mathrm{s}^{-1}$，$\\tau_0 = 0.5$，$\\sigma_{J,\\mathrm{prior}} = 0.5$，以及 $\\sigma_B = 0.5$。\n\n- 情况 B（边界低信号，低估的 $J$ 先验宽度）：$\\langle \\sigma v \\rangle_{\\mathrm{true}} = 1 \\times 10^{-27} \\, \\mathrm{cm}^3 \\, \\mathrm{s}^{-1}$，$\\tau_0 = 0.0$，$\\sigma_{J,\\mathrm{prior}} = 0.2$，以及 $\\sigma_B = 0.5$。\n\n- 情况 C（边缘高衰减，高估的 $J$ 先验宽度）：$\\langle \\sigma v \\rangle_{\\mathrm{true}} = 3 \\times 10^{-26} \\, \\mathrm{cm}^3 \\, \\mathrm{s}^{-1}$，$\\tau_0 = 2.0$，$\\sigma_{J,\\mathrm{prior}} = 0.8$，以及 $\\sigma_B = 0.5$。\n\n对每种情况，计算比率\n$$\nR = \\frac{\\langle \\sigma v \\rangle_{\\mathrm{MAP}}}{\\langle \\sigma v \\rangle_{\\mathrm{true}}}.\n$$\n\n最终输出格式：\n\n您的程序应生成单行输出，其中包含三种情况的结果，格式为方括号内由逗号分隔的三个浮点数，具体为 $[R_A, R_B, R_C]$，不含任何其他文本。\n\n输入中的所有物理单位均如上所述。仅报告无量纲的比率 $R$ 作为浮点数。",
            "solution": "该问题被认为是有效的，因为它具有科学依据、问题明确且客观。它为在暗物质间接探测背景下的模拟和拟合练习提供了一个完整且独立的规范，这是计算高能物理中的一个标准课题。所有物理公式、参数和数值步骤都定义清晰，并与已发表的文献一致。\n\n解决方案将通过以下步骤实现：\n1.  **设置和常数**：所有物理常数和分析参数都在一个一致的单位制（GeV, cm, s）中定义。\n2.  **物理建模**：根据提供的公式，实现 a) 银河系信号分量，b) 星系外信号分量，和 c) 天体物理背景分量的函数。\n3.  **数据模拟**：开发一个程序来生成模拟计数数据。这包括设置真实的物理参数，计算每个感兴趣区域 (ROI) 在每个能量区间中的预期计数，并从泊松分布中抽取伪随机数。通过将对数正态分布的增强因子应用于名义值来生成真实的 $J$-因子。\n4.  **统计拟合**：执行最大后验 (MAP) 拟合，从模拟数据中恢复模型参数。需要最小化的目标函数是负对数后验概率，定义为：\n    $$\n    f(\\vec{\\theta}) = -\\ln\\mathcal{P}(\\vec{\\theta} \\mid \\{n_{ij}\\}) = -\\ln\\mathcal{L}(\\{n_{ij}\\} \\mid \\vec{\\theta}) - \\ln p(\\vec{\\theta})\n    $$\n    其中参数向量为 $\\vec{\\theta} = (\\langle \\sigma v \\rangle, \\{k_i\\}, \\{J_i\\})$。\n\n对数似然函数，从泊松概率的乘积推导而来，并忽略常数项，为：\n$$\n-\\ln\\mathcal{L} = \\sum_{i,j} \\left( \\mu_{ij}(\\vec{\\theta}) - n_{ij} \\ln(\\mu_{ij}(\\vec{\\theta})) \\right)\n$$\n对数先验，结合了 $\\langle \\sigma v \\rangle$ 和 $\\{k_i\\}$ 的平坦先验以及 $\\{J_i\\}$ 的对数正态先验，其贡献为：\n$$\n-\\ln p(\\vec{\\theta}) = \\sum_i \\left( \\frac{(\\ln J_i - \\ln \\bar{J}_i)^2}{2\\sigma_{J,\\mathrm{prior}}^2} + \\ln J_i \\right) + \\text{const.}\n$$\n这两项之和构成了用于最小化的目标函数。拟合针对 11 个参数进行：全局湮灭截面 $\\langle \\sigma v \\rangle$ 以及每个 ROI 的背景归一化系数 $\\{k_i\\}_{i=1..5}$ 和 $J$-因子 $\\{J_i\\}_{i=1..5}$。\n\n物理模型的关键组成部分实现如下：\n\n-   **能量区间**：从 $E_{\\min} = 50 \\, \\mathrm{GeV}$ 到 $E_{\\max} = 150 \\, \\mathrm{GeV}$ 的能量范围被划分为 $N_{\\mathrm{bins}} = 30$ 个区间。区间宽度为 $\\Delta E = (E_{\\max} - E_{\\min})/N_{\\mathrm{bins}}$，区间中心 $E_j$ 位于中点。\n\n-   **银河系信号**：考虑能量弥散后，观测到的银河系信号流强为：\n    $$\n    \\frac{d\\Phi_{\\mathrm{gal,obs}}}{dE}(E; J_i, \\langle \\sigma v \\rangle) = \\frac{\\langle \\sigma v \\rangle}{4 \\pi m_\\chi^2} J_i \\cdot G(E; m_\\chi, \\sigma_E)\n    $$\n    其中 $G(E; m_\\chi, \\sigma_E)$ 是一个正态分布的概率密度函数，其均值为 $m_\\chi = 100 \\, \\mathrm{GeV}$，标准差为 $\\sigma_E = r \\cdot m_\\chi = 0.1 \\cdot 100 \\, \\mathrm{GeV} = 10 \\, \\mathrm{GeV}$。\n\n-   **星系外信号**：通过使用狄拉克 $\\delta$ 函数的性质解析求解红移积分来计算星系外信号强度：\n    $$\n    \\frac{d\\Phi_{\\mathrm{ex}}}{dE}(E) = \\frac{c}{8 \\pi} \\frac{\\langle \\sigma v \\rangle}{m_\\chi^2} (\\rho_c \\Omega_{\\mathrm{DM}})^2 \\frac{(1+z^\\star)^3}{H(z^\\star)} \\frac{e^{-\\tau(E, z^\\star)}}{E}\n    $$\n    此公式在 $z^\\star = m_\\chi/E - 1$ 位于 $[0, z_{\\max}]$ 范围内有效，否则为零。哈勃率为 $H(z) = H_0 \\sqrt{\\Omega_m(1+z)^3 + \\Omega_\\Lambda}$，光学深度为 $\\tau(E, z) = \\tau_0 (E/E_\\ast)^\\alpha z$。\n\n-   **背景**：天体物理背景是一个简单的幂律谱：\n    $$\n    \\frac{d\\Phi_{\\mathrm{bkg},i}}{dE}(E) = k_i \\left( \\frac{E}{E_0} \\right)^{-\\gamma}\n    $$\n    其中 $\\gamma = 2.3$ 且 $E_0 = 100 \\, \\mathrm{GeV}$。\n\n-   **预期计数**：ROI $i$ 在能量区间 $j$ 中的预期计数值 $\\mu_{ij}$ 是这些流强分量之和，再乘以曝光量 $\\mathcal{E}_i$ 和区间宽度 $\\Delta E$。星系外强度还需乘以 ROI 的立体角 $\\Omega_i$。\n\n使用一个数值优化算法，具体是在 `scipy.optimize.minimize` 中实现的 L-BFGS-B 算法，来找到最小化负对数后验概率的参数值，同时满足正值约束 $\\langle \\sigma v \\rangle \\ge 0$，$k_i \\ge 0$ 和 $J_i > 0$。\n\n整个过程针对三个测试用例执行，每个用例具有不同的真实参数和先验假设，以测试拟合程序的鲁棒性。最终输出是每个用例的 MAP 拟合截面与其真实值之比，即 $R = \\langle \\sigma v \\rangle_{\\mathrm{MAP}} / \\langle \\sigma v \\rangle_{\\mathrm{true}}$。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import minimize\nfrom scipy.stats import norm\n\n#\n# Execution Environment:\n# language: Python\n# version: 3.12\n# libraries:\n#   - name: numpy, version: 1.23.5\n#   - name: scipy, version: 1.11.4\n#\n\ndef solve():\n    \"\"\"\n    Main function to run the simulation and fitting for all test cases.\n    \"\"\"\n\n    # --- Physical Constants ---\n    C_LIGHT = 2.99792458e10  # cm/s\n    H0_KM_S_MPC = 70.0  # km/s/Mpc\n    KM_PER_MPC = 3.08567758e19\n    H0_S_INV = H0_KM_S_MPC / KM_PER_MPC  # s^-1\n    H_val = 0.7  # H0 / 100\n    RHO_C_PREFACTOR = 1.05375e-5  # h^2 GeV/cm^3\n    RHO_C = RHO_C_PREFACTOR * H_val**2  # GeV/cm^3\n\n    # --- Cosmological Parameters ---\n    OMEGA_M = 0.3\n    OMEGA_L = 0.7\n    OMEGA_DM = 0.26\n    \n    # --- Analysis Settings ---\n    M_CHI = 100.0  # GeV\n    E_MIN, E_MAX, N_BINS = 50.0, 150.0, 30\n    E_BINS = np.linspace(E_MIN, E_MAX, N_BINS + 1)\n    E_CENTERS = (E_BINS[:-1] + E_BINS[1:]) / 2.0\n    DELTA_E = (E_MAX - E_MIN) / N_BINS\n    E_RES = 0.10\n    SIGMA_E = E_RES * M_CHI\n    BKG_GAMMA = 2.3\n    BKG_E0 = 100.0  # GeV\n    Z_MAX = 5.0\n\n    # --- Attenuation Parameters ---\n    ALPHA_TAU = 1.2\n    E_STAR_TAU = 100.0  # GeV\n\n    # --- ROI-specific Settings ---\n    N_ROIS = 5\n    EXPOSURE = 1.0e11  # cm^2 s, same for all ROIs\n    SOLID_ANGLE = 1.0e-4  # sr, same for all ROIs\n    J_BAR = np.array([1e19, 3e19, 1e20, 3e20, 1e21])  # GeV^2 cm^-5\n    K_TRUE = np.array([1e-12, 1.5e-12, 2e-12, 1e-12, 3e-12])  # cm^-2 s^-1 GeV^-1\n\n    # --- Pre-calculate templates ---\n    GAL_TEMPLATE = norm.pdf(E_CENTERS, loc=M_CHI, scale=SIGMA_E)\n    BKG_TEMPLATE = (E_CENTERS / BKG_E0)**(-BKG_GAMMA)\n\n    def hubble_rate(z):\n        return H0_S_INV * np.sqrt(OMEGA_M * (1 + z)**3 + OMEGA_L)\n\n    def optical_depth(E, z, tau_0):\n        return tau_0 * (E / E_STAR_TAU)**ALPHA_TAU * z\n\n    def extragalactic_flux_template(e_array, tau_0):\n        z_star = M_CHI / e_array - 1\n        flux = np.zeros_like(e_array)\n        \n        valid_mask = (z_star >= 0)  (z_star = Z_MAX)\n        if np.any(valid_mask):\n            z_s_valid = z_star[valid_mask]\n            e_valid = e_array[valid_mask]\n            \n            prefactor = (C_LIGHT / (8 * np.pi * M_CHI**2)) * (RHO_C * OMEGA_DM)**2\n            \n            integrand = ((1 + z_s_valid)**3 / hubble_rate(z_s_valid)) \\\n                        * np.exp(-optical_depth(e_valid, z_s_valid, tau_0)) / e_valid\n            \n            flux[valid_mask] = prefactor * integrand\n        return flux\n\n    # --- Main Calculation Functions ---\n    def get_expected_counts(params, tau_0):\n        sv, k_vals, j_vals = params[0], params[1:1+N_ROIS], params[1+N_ROIS:]\n        \n        # Extragalactic flux is common for all ROIs (up to solid angle)\n        exgal_flux_template = extragalactic_flux_template(E_CENTERS, tau_0)\n        exgal_flux_total = sv * exgal_flux_template\n        \n        mu = np.zeros((N_ROIS, N_BINS))\n        for i in range(N_ROIS):\n            gal_flux = (sv / (4 * np.pi * M_CHI**2)) * j_vals[i] * GAL_TEMPLATE\n            bkg_flux = k_vals[i] * BKG_TEMPLATE\n            \n            total_flux = gal_flux + SOLID_ANGLE * exgal_flux_total + bkg_flux\n            mu[i, :] = total_flux * EXPOSURE * DELTA_E\n        \n        return mu\n\n    def neg_log_posterior(params, n_obs, tau_0, sigma_j_prior):\n        # Unpack parameters: sv, k_i, J_i\n        sv, k_vals, j_vals = params[0], params[1:1+N_ROIS], params[1+N_ROIS:]\n        \n        # Ensure parameters are positive\n        if sv  0 or np.any(k_vals  0) or np.any(j_vals = 0):\n            return np.inf\n\n        mu = get_expected_counts(params, tau_0)\n        \n        # Add a small epsilon to avoid log(0)\n        mu[mu = 0] = 1e-30\n        \n        # Poisson log-likelihood part\n        log_likelihood = np.sum(mu - n_obs * np.log(mu))\n        \n        # Lognormal prior on J-factors part\n        log_prior_j = np.sum(\n            (np.log(j_vals) - np.log(J_BAR))**2 / (2 * sigma_j_prior**2) + np.log(j_vals)\n        )\n        \n        return log_likelihood + log_prior_j\n\n    def run_case(sv_true, tau_0, sigma_j_prior, sigma_b):\n        # --- 1. Generate Data ---\n        rng = np.random.default_rng(12345)\n        \n        # Generate true J-factors with boost\n        ln_b_vals = rng.normal(loc=0.0, scale=sigma_b, size=N_ROIS)\n        b_vals = np.exp(ln_b_vals)\n        j_true = J_BAR * b_vals\n        \n        # Calculate true expected counts\n        true_params = np.concatenate(([sv_true], K_TRUE, j_true))\n        mu_true = get_expected_counts(true_params, tau_0)\n        \n        # Generate observed counts\n        n_obs = rng.poisson(lam=mu_true)\n\n        # --- 2. Perform MAP Fit ---\n        # Initial guess for optimization\n        x0 = np.concatenate(([1e-27], K_TRUE, J_BAR))\n        \n        # Parameter bounds\n        bounds = [(1e-30, None)]  # sv >= 0 (small positive num to avoid issues)\n        bounds += [(1e-20, None)] * N_ROIS  # k_i >= 0\n        bounds += [(1e-20, None)] * N_ROIS  # J_i > 0\n\n        # Run optimizer\n        result = minimize(\n            neg_log_posterior,\n            x0,\n            args=(n_obs, tau_0, sigma_j_prior),\n            method='L-BFGS-B',\n            bounds=bounds,\n            options={'ftol': 1e-12, 'gtol': 1e-8}\n        )\n        \n        sv_map = result.x[0]\n        \n        return sv_map / sv_true\n\n    # --- Test Cases Definition ---\n    test_cases = [\n        # Case A: happy path\n        {'sv_true': 3e-26, 'tau_0': 0.5, 'sigma_j_prior': 0.5, 'sigma_b': 0.5},\n        # Case B: low-signal, underestimated J prior\n        {'sv_true': 1e-27, 'tau_0': 0.0, 'sigma_j_prior': 0.2, 'sigma_b': 0.5},\n        # Case C: high attenuation, overestimated J prior\n        {'sv_true': 3e-26, 'tau_0': 2.0, 'sigma_j_prior': 0.8, 'sigma_b': 0.5},\n    ]\n\n    results = []\n    for case in test_cases:\n        ratio = run_case(\n            sv_true=case['sv_true'],\n            tau_0=case['tau_0'],\n            sigma_j_prior=case['sigma_j_prior'],\n            sigma_b=case['sigma_b']\n        )\n        results.append(ratio)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == '__main__':\n    solve()\n```"
        },
        {
            "introduction": "本练习将焦点转向直接探测，探索方向信息的威力。学生将模拟由不同暗物质相互作用类型（如算符 $\\mathcal{O}_1$ 和 $\\mathcal{O}_8$）引起的核反冲事件，并对诸如角弥散和头尾模糊等实际探测器效应进行建模。通过实现一个似然比检验 ，他们将学习到方向探测器不仅可以用于发现暗物质，还能用来探究其相互作用的基本性质。",
            "id": "3534014",
            "problem": "低压四氟化碳时间投影室（CF$_4$ TPC）可测量由暗物质（DM）与靶核的弹性散射引起的核反冲方向。在非相对论有效场论基础上，考虑两个基准的暗物质-核子相互作用算符：$\\mathcal{O}_1$（自旋无关的主导算符）和$\\mathcal{O}_8$（速度垂直耦合）。在方向性探测中，来自麦克斯韦分布的银河系晕的弹性散射会导致各向异性的反冲方向，对于$\\mathcal{O}_1$，其主导项可近似为一个关于暗物质风方向的轴对称分布；对于$\\mathcal{O}_8$，则近似为一个环状分布。在CF$_4$ TPC中进行的实际重建会引入两种主要的性能退化：有限的径迹扩散（角度弥散）和头尾方向不确定性（径迹方向反转），这些都会降低算符的区分能力。\n\n从基本概率定义和单位球面上的归一化出发，推导并实现以下的模拟和似然比检验，须遵循概率公理以及每个概率密度在球面积分后为一的要求：\n\n1. 模型假设：\n   - 设实验室坐标系中暗物质风的方向为$+\\hat{z}$轴。真实反冲方向是一个单位向量 $\\mathbf{x} \\in S^2$，在球坐标中由极角 $\\theta \\in [0,\\pi]$ 和方位角 $\\phi \\in [0,2\\pi)$ 表示，球面上的面积元为 $\\mathrm{d}\\Omega = \\sin\\theta\\,\\mathrm{d}\\theta\\,\\mathrm{d}\\phi$。\n   - 对于 $\\mathcal{O}_1$，将真实方向分布近似为一个在 $S^2$ 上的轴对称 von Mises-Fisher 分布，其集中参数为 $\\kappa_1  0$，平均方向为 $+\\hat{z}$。你必须推导出在 $S^2$ 上正确归一化的三维密度 $f_1(\\mathbf{x}\\,;\\kappa_1)$。\n   - 对于 $\\mathcal{O}_8$，将真实方向分布近似为一个以极角 $\\theta_0 \\in (0,\\pi)$ 为中心、宽度为 $\\sigma_{\\mathrm{ring}}  0$ 的轴对称环状分布，使得三维密度与 $\\phi$ 无关，而对 $\\theta$ 的依赖关系为关于 $\\theta$ 的高斯函数。你必须推导出在 $S^2$ 上正确归一化的三维密度 $f_8(\\theta\\,;\\theta_0,\\sigma_{\\mathrm{ring}})$，其关于 $\\mathrm{d}\\Omega$ 的积分为一。\n   - 有限扩散被建模为真实单位向量 $\\mathbf{x}$ 的一个角度微扰，该微扰由一个绕着与 $\\mathbf{x}$ 正交的随机轴的无穷小旋转产生，旋转角 $\\alpha \\sim \\mathcal{N}(0,\\sigma_{\\mathrm{diff}}^2)$，从而得到一个测量的单位向量 $\\tilde{\\mathbf{x}}$。头尾方向不确定性被建模为对每个事件独立地以概率 $p_{\\mathrm{flip}} \\in [0,1]$ 翻转测量方向，即 $\\tilde{\\mathbf{x}} \\mapsto -\\tilde{\\mathbf{x}}$。\n   - 角度必须以弧度为单位处理和报告。\n\n2. 似然比检验：\n   - 给定一组测量的单位向量 $\\{\\tilde{\\mathbf{x}}_i\\}_{i=1}^N$，定义对数似然比统计量\n     $$S = \\sum_{i=1}^{N} \\ln \\frac{f_1(\\tilde{\\mathbf{x}}_i\\,;\\kappa_1)}{f_8(\\tilde{\\theta}_i\\,;\\theta_0,\\sigma_{\\mathrm{ring}})},$$\n     其中 $\\tilde{\\theta}_i$ 是 $\\tilde{\\mathbf{x}}_i$ 相对于 $+\\hat{z}$ 的极角。使用分类规则：若 $S  0$ 则倾向于 $\\mathcal{O}_1$，若 $S \\le 0$ 则倾向于 $\\mathcal{O}_8$。\n\n3. 模拟任务：\n   - 对每个测试用例，模拟 $M$ 次独立的伪实验。在每次伪实验中：\n     - 从真实算符的方向分布（$\\mathcal{O}_1$ 或 $\\mathcal{O}_8$）中抽取 $N$ 个真实反冲方向 $\\{\\mathbf{x}_i\\}$。\n     - 对每个 $\\mathbf{x}_i$ 应用扩散效应，即绕一个与 $\\mathbf{x}_i$ 正交的随机轴进行角度为 $\\alpha \\sim \\mathcal{N}(0,\\sigma_{\\mathrm{diff}}^2)$ 的无穷小随机旋转，从而产生 $\\tilde{\\mathbf{x}}_i$。\n     - 以概率 $p_{\\mathrm{flip}}$ 独立地将 $\\tilde{\\mathbf{x}}_i$ 翻转为 $-\\tilde{\\mathbf{x}}_i$。\n     - 计算对数似然比 $S$ 并记录在真实算符下分类是否正确。\n   - 对每个测试用例，报告分类准确率，其值为一个浮点数，等于被正确分类的伪实验所占的比例。\n\n4. 单位和数值要求：\n   - 所有角度（$\\theta$, $\\phi$, $\\theta_0$, $\\sigma_{\\mathrm{ring}}$, $\\sigma_{\\mathrm{diff}}$）必须使用弧度。\n   - 输出值必须是 $[0,1]$ 范围内的浮点数。\n   - 你的程序必须产生四舍五入到 $6$ 位小数的结果。\n\n5. 测试集：\n   - 使用以下测试用例，每个用例由 $(N, M, \\kappa_1, \\theta_0, \\sigma_{\\mathrm{ring}}, \\sigma_{\\mathrm{diff}}, p_{\\mathrm{flip}}, \\text{true\\_operator})$ 指定，其中 $\\text{true\\_operator} \\in \\{1,8\\}$ 指定生成数据的算符：\n     - 用例 1：$(N,M,\\kappa_1,\\theta_0,\\sigma_{\\mathrm{ring}},\\sigma_{\\mathrm{diff}},p_{\\mathrm{flip}},\\text{true\\_operator}) = (200,200,6.0,1.20,0.30,0.20,0.10,1)$。\n     - 用例 2（边界情况，无扩散且完美的头尾区分）：$(200,200,6.0,1.20,0.30,0.00,0.00,1)$。\n     - 用例 3（高扩散，中等头尾不确定性）：$(200,200,6.0,1.20,0.30,0.70,0.30,1)$。\n     - 用例 4（极端头尾不确定性）：$(200,200,6.0,1.20,0.30,0.20,0.50,1)$。\n     - 用例 5（真实算符为 $\\mathcal{O}_8$）：$(200,200,6.0,1.20,0.30,0.20,0.10,8)$。\n\n6. 最终输出格式：\n   - 你的程序应产生单行输出，包含一个用方括号括起来的逗号分隔列表，按用例 1 到 5 的顺序列出结果。例如，格式必须为 $[\\text{result}_1,\\text{result}_2,\\text{result}_3,\\text{result}_4,\\text{result}_5]$，每个 $\\text{result}_i$ 都四舍五入到 $6$ 位小数。\n\n你必须通过推导和使用在 $S^2$ 上正确归一化的密度来确保科学真实性，从这些密度中采样以产生 $\\mathbf{x}_i$，按照规定应用扩散和头尾不确定性，并基于你推导的 $f_1$ 和 $f_8$ 计算对数似然比。角度必须使用弧度。不得使用任何外部数据。最终输出必须遵守上述单行格式规定。",
            "solution": "该问题具有科学依据，阐述清晰，并且为完成整个模拟提供了所有必要的参数和定义。它要求推导和实现球面上的概率分布，从这些分布中采样，模拟探测器效应，并使用对数似然比进行假设检验。该问题是有效的，我将着手提供一个完整的解决方案。\n\n解决方案包括三个主要阶段：\n1. 推导两个暗物质信号假设 $\\mathcal{O}_1$ 和 $\\mathcal{O}_8$ 的归一化概率密度函数（PDF）。\n2. 实现一个蒙特卡洛模拟来生成事件样本，包括对实验效应的建模。\n3. 对模拟数据执行对数似然比检验，以确定分类准确率。\n\n**1. 概率密度函数**\n\n单位球面 $S^2$ 上的表面积元是 $\\mathrm{d}\\Omega = \\sin\\theta\\,\\mathrm{d}\\theta\\,\\mathrm{d}\\phi$，其中 $\\theta \\in [0,\\pi]$ 是极角，$\\phi \\in [0,2\\pi)$ 是方位角。球面上任何概率密度函数 $f(\\mathbf{x})$ 都必须满足归一化条件 $\\int_{S^2} f(\\mathbf{x})\\,\\mathrm{d}\\Omega = 1$。暗物质风的方向与 $+\\hat{z}$ 轴对齐。\n\n**1.1. $\\mathcal{O}_1$ 信号模型：von Mises-Fisher 分布**\n$\\mathcal{O}_1$ 算符的方向分布由 von Mises-Fisher (vMF) 分布建模。$S^2$ 上的 vMF 分布的一般 PDF 由 $f(\\mathbf{x} | \\boldsymbol{\\mu}, \\kappa) = C(\\kappa) e^{\\kappa \\boldsymbol{\\mu} \\cdot \\mathbf{x}}$ 给出，其中 $\\boldsymbol{\\mu}$ 是平均方向，$\\kappa$ 是集中参数。\n\n在这个问题中，平均方向是 $\\boldsymbol{\\mu} = \\hat{z} = (0,0,1)$。对于一个极角为 $\\theta$ 的反冲方向向量 $\\mathbf{x}$，点积为 $\\boldsymbol{\\mu} \\cdot \\mathbf{x} = \\hat{z} \\cdot \\mathbf{x} = \\cos\\theta$。因此，PDF 与方位角 $\\phi$ 无关，可以写成 $f_1(\\theta; \\kappa_1) = C_1 e^{\\kappa_1 \\cos\\theta}$。\n\n为了找到归一化常数 $C_1$，我们在球面上积分：\n$$ \\int_{S^2} C_1 e^{\\kappa_1 \\cos\\theta} \\mathrm{d}\\Omega = \\int_0^{2\\pi} \\mathrm{d}\\phi \\int_0^{\\pi} C_1 e^{\\kappa_1 \\cos\\theta} \\sin\\theta\\,\\mathrm{d}\\theta = 1 $$\n对 $\\phi$ 的积分得到 $2\\pi$。对 $\\theta$ 的积分可以通过换元 $u = \\cos\\theta$, $\\mathrm{d}u = -\\sin\\theta\\,\\mathrm{d}\\theta$ 来求解：\n$$ 2\\pi C_1 \\int_{-1}^{1} e^{\\kappa_1 u} \\mathrm{d}u = 2\\pi C_1 \\left[ \\frac{e^{\\kappa_1 u}}{\\kappa_1} \\right]_{-1}^{1} = 2\\pi C_1 \\frac{e^{\\kappa_1} - e^{-\\kappa_1}}{\\kappa_1} = 2\\pi C_1 \\frac{2\\sinh(\\kappa_1)}{\\kappa_1} $$\n令其等于 $1$ 得到归一化常数：\n$$ C_1 = \\frac{\\kappa_1}{4\\pi\\sinh(\\kappa_1)} $$\n因此，$\\mathcal{O}_1$ 假设的归一化 PDF 是：\n$$ f_1(\\mathbf{x}; \\kappa_1) = \\frac{\\kappa_1}{4\\pi\\sinh(\\kappa_1)} e^{\\kappa_1 (\\mathbf{x} \\cdot \\hat{z})} = \\frac{\\kappa_1}{4\\pi\\sinh(\\kappa_1)} e^{\\kappa_1 \\cos\\theta} $$\n\n**1.2. $\\mathcal{O}_8$ 信号模型：环状分布**\n$\\mathcal{O}_8$ 算符的方向分布被建模为一个环状结构，与 $\\phi$ 无关，且在极角 $\\theta$ 上具有以 $\\theta_0$ 为中心、宽度为 $\\sigma_{\\mathrm{ring}}$ 的高斯轮廓。未归一化的密度与 $e^{-(\\theta - \\theta_0)^2 / (2\\sigma_{\\mathrm{ring}}^2)}$ 成正比。设归一化的 PDF 为 $f_8(\\theta; \\theta_0, \\sigma_{\\mathrm{ring}}) = C_8 e^{-(\\theta - \\theta_0)^2 / (2\\sigma_{\\mathrm{ring}}^2)}$。\n\n我们通过在球面上积分来找到归一化常数 $C_8$：\n$$ \\int_{S^2} C_8 e^{-(\\theta - \\theta_0)^2 / (2\\sigma_{\\mathrm{ring}}^2)} \\mathrm{d}\\Omega = \\int_0^{2\\pi} \\mathrm{d}\\phi \\int_0^{\\pi} C_8 e^{-(\\theta - \\theta_0)^2 / (2\\sigma_{\\mathrm{ring}}^2)} \\sin\\theta\\,\\mathrm{d}\\theta = 1 $$\n对 $\\phi$ 的积分得到 $2\\pi$。剩下的对 $\\theta$ 的积分没有简单的解析闭合形式，必须进行数值计算。设此积分为 $I_8^{int}$：\n$$ I_8^{int}(\\theta_0, \\sigma_{\\mathrm{ring}}) = \\int_0^{\\pi} e^{-(\\theta' - \\theta_0)^2 / (2\\sigma_{\\mathrm{ring}}^2)} \\sin\\theta' \\,\\mathrm{d}\\theta' $$\n则归一化常数为 $C_8 = (2\\pi I_8^{int})^{-1}$。$\\mathcal{O}_8$ 假设的最终 PDF 是：\n$$ f_8(\\theta; \\theta_0, \\sigma_{\\mathrm{ring}}) = \\frac{e^{-(\\theta - \\theta_0)^2 / (2\\sigma_{\\mathrm{ring}}^2)}}{2\\pi \\int_0^{\\pi} e^{-(\\theta' - \\theta_0)^2 / (2\\sigma_{\\mathrm{ring}}^2)} \\sin\\theta' \\,\\mathrm{d}\\theta'} $$\n\n**2. 蒙特卡洛模拟**\n\n模拟过程是通过生成 $M$ 个伪实验，每个包含 $N$ 个事件来进行的。\n\n**2.1. 事件采样**\n- **从 $f_1$ 采样**：我们对极角使用逆变换采样法。对于 $u = \\cos\\theta$，其 PDF 为 $p(u) \\propto e^{\\kappa_1 u}$，其中 $u \\in [-1, 1]$。累积分布函数（CDF）是 $F(u) = (e^{\\kappa_1 u} - e^{-\\kappa_1}) / (e^{\\kappa_1} - e^{-\\kappa_1})$。将 $F(u)$ 设为一个均匀随机变量 $y \\in [0,1]$ 并解出 $u$，得到 $u = \\frac{1}{\\kappa_1} \\ln(e^{-\\kappa_1} + y(e^{\\kappa_1} - e^{-\\kappa_1}))$。极角为 $\\theta = \\arccos(u)$。方位角 $\\phi$ 从 $[0, 2\\pi)$ 中均匀采样。\n\n- **从 $f_8$ 采样**：我们对极角 $\\theta$ 使用拒绝采样法。$\\theta$ 的目标 PDF 是 $p(\\theta) \\propto h(\\theta) = e^{-(\\theta - \\theta_0)^2 / (2\\sigma_{\\mathrm{ring}}^2)} \\sin\\theta$，定义在 $[0, \\pi]$ 上。我们使用一个均匀提议分布 $g(\\theta) = 1/\\pi$，定义在 $[0, \\pi]$ 上。算法如下：\n    1.  数值计算 $h(\\theta)$ 在 $[0, \\pi]$ 上的最大值 $h_{max}$。\n    2.  从 $U(0, \\pi)$ 中采样一个候选值 $\\theta_{cand}$。\n    3.  从 $U(0, 1)$ 中采样一个随机变量 $v$。\n    4.  如果 $v \\cdot h_{max} \\le h(\\theta_{cand})$，则接受 $\\theta_{cand}$。否则，从步骤 2 开始重复。\n方位角 $\\phi$ 从 $[0, 2\\pi)$ 中均匀采样。\n\n从采样的 $(\\theta, \\phi)$ 构建真实的反冲向量：$\\mathbf{x} = (\\sin\\theta\\cos\\phi, \\sin\\theta\\sin\\phi, \\cos\\theta)$。\n\n**2.2. 仪器效应**\n1.  **扩散**：真实向量 $\\mathbf{x}$ 被旋转为测量向量 $\\tilde{\\mathbf{x}}$。旋转角度 $\\alpha$ 从正态分布 $\\mathcal{N}(0, \\sigma_{\\mathrm{diff}}^2)$ 中采样，旋转轴 $\\mathbf{k}$ 是一个与 $\\mathbf{x}$ 正交的随机轴。轴 $\\mathbf{k}$ 通过计算 $\\mathbf{x}$ 与一个随机各向同性向量的叉积并归一化来生成。旋转使用 Rodrigues 旋转公式应用：\n    $$ \\tilde{\\mathbf{x}} = \\mathbf{x} \\cos\\alpha + (\\mathbf{k} \\times \\mathbf{x}) \\sin\\alpha $$\n    因为 $\\mathbf{k} \\cdot \\mathbf{x} = 0$。\n\n2.  **头尾翻转**：对每个测量向量 $\\tilde{\\mathbf{x}}_i$，抽取一个随机数 $u_i \\in [0,1]$。如果 $u_i  p_{\\mathrm{flip}}$，则向量被反转：$\\tilde{\\mathbf{x}}_i \\mapsto -\\tilde{\\mathbf{x}}_i$。\n\n**3. 似然比检验与分类**\n\n对于每个伪实验，生成一组 $N$ 个测量向量 $\\{\\tilde{\\mathbf{x}}_i\\}_{i=1}^N$。计算对数似然比统计量 $S$：\n$$ S = \\sum_{i=1}^{N} \\ln \\frac{f_1(\\tilde{\\mathbf{x}}_i\\,;\\kappa_1)}{f_8(\\tilde{\\theta}_i\\,;\\theta_0,\\sigma_{\\mathrm{ring}})} $$\n其中 $\\tilde{\\theta}_i = \\arccos(\\tilde{\\mathbf{x}}_i \\cdot \\hat{z})$ 是测量向量 $\\tilde{\\mathbf{x}}_i$ 的极角。代入推导出的 PDF：\n$$ S = \\sum_{i=1}^{N} \\left( \\ln\\left(\\frac{\\kappa_1}{4\\pi\\sinh(\\kappa_1)}\\right) - \\ln\\left(\\frac{1}{2\\pi I_8^{int}}\\right) + \\kappa_1 \\cos\\tilde{\\theta}_i + \\frac{(\\tilde{\\theta}_i - \\theta_0)^2}{2\\sigma_{\\mathrm{ring}}^2} \\right) $$\n\n分类规则是：\n-   如果 $S > 0$，伪实验被分类为 $\\mathcal{O}_1$。\n-   如果 $S \\le 0$，伪实验被分类为 $\\mathcal{O}_8$。\n\n对于给定的测试用例，分类准确率是 $M$ 次伪实验中分类结果与真实数据生成算符相符的比例。",
            "answer": "```python\nimport numpy as np\nfrom scipy import integrate, optimize\n\ndef solve():\n    \"\"\"\n    解决暗物质方向性探测模拟问题。\n    \"\"\"\n    # 固定随机种子以保证可复现性\n    np.random.seed(42)\n\n    test_cases = [\n        # (N, M, kappa1, theta0, sigma_ring, sigma_diff, p_flip, true_operator)\n        (200, 200, 6.0, 1.20, 0.30, 0.20, 0.10, 1),\n        (200, 200, 6.0, 1.20, 0.30, 0.00, 0.00, 1),\n        (200, 200, 6.0, 1.20, 0.30, 0.70, 0.30, 1),\n        (200, 200, 6.0, 1.20, 0.30, 0.20, 0.50, 1),\n        (200, 200, 6.0, 1.20, 0.30, 0.20, 0.10, 8),\n    ]\n\n    results = []\n\n    for case in test_cases:\n        N, M, kappa1, theta0, sigma_ring, sigma_diff, p_flip, true_operator = case\n\n        # 预计算归一化常数和采样参数\n        \n        # O1 (von Mises-Fisher)\n        log_norm_f1 = np.log(kappa1 / (4 * np.pi * np.sinh(kappa1)))\n\n        # O8 (环形分布)\n        integrand_f8 = lambda theta: np.exp(-(theta - theta0)**2 / (2 * sigma_ring**2)) * np.sin(theta)\n        integral_f8, _ = integrate.quad(integrand_f8, 0, np.pi)\n        log_norm_f8 = -np.log(2 * np.pi * integral_f8)\n        \n        # 用于从f8进行拒绝采样\n        # 找到theta的未归一化PDF的最大值\n        res = optimize.minimize_scalar(lambda t: -integrand_f8(t), bounds=(0, np.pi), method='bounded')\n        h_max_f8 = -res.fun\n\n        correct_classifications = 0\n        for _ in range(M):\n            # --- 为一个伪实验生成N个事件 ---\n            \n            # 1. 采样N个真实反冲方向\n            if true_operator == 1:\n                # 从 von Mises-Fisher 分布中采样\n                y = np.random.rand(N)\n                # 为健壮性起见，处理 kappa1 -> 0 的情况，尽管测试用例中没有\n                if kappa1 > 1e-6:\n                     # 使用稳定的对数公式以避免exp函数中的大数溢出\n                    term1 = np.exp(-kappa1)\n                    term2 = y * (np.exp(kappa1) - term1)\n                    u = (1/kappa1) * np.log(term1 + term2)\n                else: # 各向同性极限\n                    u = 2 * y - 1\n                \n                theta = np.arccos(u)\n                phi = np.random.uniform(0, 2 * np.pi, N)\n            \n            elif true_operator == 8:\n                # 使用拒绝采样从环形分布中采样\n                theta_samples = []\n                while len(theta_samples)  N:\n                    theta_cand = np.random.uniform(0, np.pi)\n                    u_rej = np.random.uniform(0, 1)\n                    if u_rej * h_max_f8 = integrand_f8(theta_cand):\n                        theta_samples.append(theta_cand)\n                theta = np.array(theta_samples)\n                phi = np.random.uniform(0, 2 * np.pi, N)\n\n            # 构建真实的3D向量\n            x_true = np.zeros((N, 3))\n            x_true[:, 0] = np.sin(theta) * np.cos(phi)\n            x_true[:, 1] = np.sin(theta) * np.sin(phi)\n            x_true[:, 2] = np.cos(theta)\n            \n            x_measured = x_true.copy()\n\n            # 2. 应用扩散（角度弥散）\n            if sigma_diff > 0:\n                alpha = np.random.normal(0, sigma_diff, N)\n                \n                # 生成与每个真实向量正交的随机轴\n                v = np.random.randn(N, 3)\n                k_prime = np.cross(x_true, v)\n                k_norm = np.linalg.norm(k_prime, axis=1, keepdims=True)\n                # 处理 v 与 x_true 平行的罕见情况\n                k_norm[k_norm == 0] = 1.0 \n                k = k_prime / k_norm\n\n                # Rodrigues 旋转公式\n                cos_alpha = np.cos(alpha)[:, np.newaxis]\n                sin_alpha = np.sin(alpha)[:, np.newaxis]\n                k_cross_x = np.cross(k, x_true)\n                \n                x_measured = x_true * cos_alpha + k_cross_x * sin_alpha\n\n            # 3. 应用头尾方向不确定性\n            if p_flip > 0:\n                flip_indices = np.random.rand(N)  p_flip\n                x_measured[flip_indices] *= -1\n\n            # --- 计算对数似然比 S ---\n            cos_theta_tilde = np.clip(x_measured[:, 2], -1.0, 1.0)\n            theta_tilde = np.arccos(cos_theta_tilde)\n\n            log_f1_vals = log_norm_f1 + kappa1 * cos_theta_tilde\n            log_f8_vals = log_norm_f8 - (theta_tilde - theta0)**2 / (2 * sigma_ring**2)\n            \n            s_statistic = np.sum(log_f1_vals - log_f8_vals)\n\n            # --- 分类并检查正确性 ---\n            classified_as_1 = s_statistic > 0\n            is_truly_1 = (true_operator == 1)\n            \n            if classified_as_1 == is_truly_1:\n                correct_classifications += 1\n\n        accuracy = correct_classifications / M\n        results.append(round(accuracy, 6))\n        \n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == '__main__':\n    solve()\n```"
        }
    ]
}