{
    "hands_on_practices": [
        {
            "introduction": "A central goal of coarse-graining is to create an effective potential that reproduces key properties of a more detailed atomistic system. This exercise explores a structure-based coarse-graining approach, where the aim is to match a target structure, often represented by the radial distribution function $g(r)$. You will discover a fundamental challenge in coarse-graining—the \"representability problem\"—where a potential that perfectly matches structure may fail to reproduce thermodynamic properties like pressure, and you will implement a standard correction to achieve consistency. ",
            "id": "3500714",
            "problem": "Consider a one-component coarse-grained fluid representing either a United-Atom mapping or a Bead-Spring polymer model, where effective interactions between coarse-grained sites are represented by a spherically symmetric pair potential $U(r)$. In this problem, you will examine whether Iterative Boltzmann Inversion (IBI) reproduces both the radial distribution function $g(r)$ and the thermodynamic pressure $p$, and you will implement a pressure correction of the form $\\Delta U(r) \\propto r$ to remedy any mismatch. Work in Lennard-Jones reduced units: length in units of $σ$, energy in units of $ε$, temperature in units of $ε/k_B$, and pressure in units of $ε/σ^3$. All outputs must be computed and reported in these reduced units.\n\nUse the following foundational bases:\n- Statistical mechanics in the canonical ensemble gives the low-density closure $g(r) \\approx \\exp(-β U(r))$, with $β = 1/(k_B T)$ and $k_B = 1$ in reduced units.\n- The virial theorem for an isotropic pair potential gives the pressure\n$$\np = ρ T - \\frac{2π}{3} ρ^2 \\int_0^{∞} g(r)\\, r^3 \\frac{dU(r)}{dr}\\, dr,\n$$\nwhere $ρ$ is the number density and $T$ is the temperature.\n- The Lennard-Jones (LJ) potential is $U_{\\mathrm{LJ}}(r) = 4 ε \\left[ \\left(\\frac{σ}{r}\\right)^{12} - \\left(\\frac{σ}{r}\\right)^6 \\right]$, and its radial derivative is $\\frac{dU_{\\mathrm{LJ}}}{dr} = 4 ε \\left[ -12 \\frac{σ^{12}}{r^{13}} + 6 \\frac{σ^6}{r^7} \\right]$. In reduced units, take $ε=1$ and $σ=1$.\n\nTarget model and observables:\n- Define a truncated-and-shifted target potential $U_{\\mathrm{true}}(r)$ as $U_{\\mathrm{true}}(r) = U_{\\mathrm{LJ}}(r) - U_{\\mathrm{LJ}}(r_c^{\\mathrm{true}})$ for $r \\le r_c^{\\mathrm{true}}$ and $U_{\\mathrm{true}}(r) = 0$ for $r > r_c^{\\mathrm{true}}$.\n- Define the target radial distribution function $g_{\\mathrm{target}}(r)$ using the low-density closure $g_{\\mathrm{target}}(r) = \\exp(-β U_{\\mathrm{true}}(r))$.\n- Define the target pressure $p_{\\mathrm{target}}$ using the virial expression with $U_{\\mathrm{true}}(r)$ and $g_{\\mathrm{target}}(r)$ integrated up to $r_c^{\\mathrm{true}}$.\n\nIBI-only model:\n- Define the IBI-only coarse-grained potential on $[0, r_c^{\\mathrm{cg}}]$ by $U_{\\mathrm{IBI}}(r) = -T \\ln g_{\\mathrm{target}}(r)$, i.e., by exactly matching $g(r)$ via the low-density closure on the coarse-grained cutoff domain.\n- Compute the IBI-only pressure $p_{\\mathrm{IBI}}$ using the virial expression integrated up to $r_c^{\\mathrm{cg}}$.\n\nPressure correction:\n- Implement a linear pressure correction $\\Delta U(r) = a\\, r$ for $r \\le r_c^{\\mathrm{cg}}$ and $\\Delta U(r) = 0$ for $r > r_c^{\\mathrm{cg}}$, and define $U_{\\mathrm{corr}}(r) = U_{\\mathrm{IBI}}(r) + a r$ on $[0, r_c^{\\mathrm{cg}}]$.\n- Use the virial identity to choose $a$ such that the corrected pressure $p_{\\mathrm{corr}}$ matches $p_{\\mathrm{target}}$. Under the low-density closure $g(r) \\approx \\exp(-β U(r))$ and within the coarse-grained domain, the linear correction changes the virial integral by\n$$\n\\Delta p = -\\frac{2π}{3} ρ^2 a \\int_0^{r_c^{\\mathrm{cg}}} g(r)\\, r^3\\, dr,\n$$\nwhich yields the coefficient\n$$\na = -\\frac{p_{\\mathrm{target}} - p_{\\mathrm{IBI}}}{\\frac{2π}{3} ρ^2 \\int_0^{r_c^{\\mathrm{cg}}} g(r)\\, r^3\\, dr}.\n$$\n\nNumerical implementation details:\n- Discretize $r$ on a uniform grid from $r_{\\min}$ to the relevant cutoff, with $r_{\\min} > 0$ to avoid the singularity at $r=0$. Use $r_{\\min} = 0.80$ and a grid size sufficient to ensure stable quadrature. Use the trapezoidal rule to approximate integrals.\n- Always set $k_B = 1$ in reduced units.\n- Use $g(r) = \\exp(-β U(r))$ wherever $g$ appears.\n\nEvaluation metrics:\n- Structure metric: Compute the root-mean-square deviation of $g(r)$ between the model and target on $[r_{\\min}, r_c^{\\mathrm{cg}}]$,\n$$\n\\mathrm{RMS}_g = \\sqrt{ \\frac{1}{N} \\sum_{i=1}^N \\left( g_{\\mathrm{model}}(r_i) - g_{\\mathrm{target}}(r_i) \\right)^2 },\n$$\nand require $\\mathrm{RMS}_g \\le 0.03$.\n- Pressure metric: Compute $|p_{\\mathrm{model}} - p_{\\mathrm{target}}|$ and require it to be $\\le 0.01$.\n- For the IBI-only model, $g_{\\mathrm{model}}(r)$ is $g_{\\mathrm{target}}(r)$ on $[r_{\\min}, r_c^{\\mathrm{cg}}]$; for the pressure-corrected model, $g_{\\mathrm{model}}(r) = \\exp(-β U_{\\mathrm{corr}}(r))$.\n\nYour program must:\n- For each test case, compute two booleans: one indicating whether IBI-only simultaneously matches both $g(r)$ and $p$ within the tolerances, and one indicating whether the pressure-corrected model simultaneously matches both $g(r)$ and $p$ within the tolerances.\n- Aggregate the booleans for all test cases into a single flat list and print them on one line in the exact format specified below.\n\nTest suite and parameters (all in reduced units):\n- Test case $1$ (happy path, cutoff mismatch): $T = 1.0$, $ρ = 0.2$, $r_c^{\\mathrm{true}} = 3.0$, $r_c^{\\mathrm{cg}} = 2.0$.\n- Test case $2$ (boundary, very low density): $T = 1.0$, $ρ = 0.01$, $r_c^{\\mathrm{true}} = 3.0$, $r_c^{\\mathrm{cg}} = 2.0$.\n- Test case $3$ (edge case, no cutoff mismatch): $T = 1.0$, $ρ = 0.2$, $r_c^{\\mathrm{true}} = 2.0$, $r_c^{\\mathrm{cg}} = 2.0$.\n\nFinal output format:\n- Your program should produce a single line of output containing the six boolean results as a comma-separated list enclosed in square brackets, ordered as $[$case$1$ IBI-only result, case$1$ corrected result, case$2$ IBI-only result, case$2$ corrected result, case$3$ IBI-only result, case$3$ corrected result$]$. For example, $[True,False,True,True,False,True]$.",
            "solution": "The problem requires an analysis of two coarse-graining strategies, Iterative Boltzmann Inversion (IBI) and a pressure-corrected variant, to determine if they can simultaneously reproduce the structure and pressure of a target system. The target system is a fluid whose particles interact via a truncated-and-shifted Lennard-Jones (LJ) potential, and its properties are determined within the low-density approximation where the radial distribution function $g(r)$ is given by the Boltzmann factor of the pair potential $U(r)$.\n\nThe analysis is performed in Lennard-Jones reduced units, where energy is in units of $ε$, length in units of $σ$, temperature $T$ in units of $ε/k_B$, and pressure $p$ in units of $ε/σ^3$. The constants are set to $ε=1$, $σ=1$, and the Boltzmann constant $k_B=1$. The relationship between the potential, structure, and temperature is thus $g(r) \\approx \\exp(-U(r)/T)$.\n\nThe pressure $p$ is calculated using the virial theorem for a spherically symmetric pair potential:\n$$\np = ρ T - \\frac{2π}{3} ρ^2 \\int_0^{∞} g(r)\\, r^3 \\frac{dU(r)}{dr}\\, dr\n$$\nwhere $ρ$ is the number density. Numerically, integrals are performed from a minimum distance $r_{\\min} = 0.80$ to the relevant cutoff radius using the trapezoidal rule, to avoid the singularity at $r=0$.\n\nThe step-by-step procedure for each test case is as follows:\n\n1.  **Define the Target System**:\n    The foundational Lennard-Jones potential is $U_{\\mathrm{LJ}}(r) = 4(r^{-12} - r^{-6})$.\n    The target system is defined by a truncated-and-shifted potential $U_{\\mathrm{true}}(r)$ with a cutoff $r_c^{\\mathrm{true}}$:\n    $$\n    U_{\\mathrm{true}}(r) = \\begin{cases} U_{\\mathrm{LJ}}(r) - U_{\\mathrm{LJ}}(r_c^{\\mathrm{true}}) & \\text{if } r \\le r_c^{\\mathrm{true}} \\\\ 0 & \\text{if } r > r_c^{\\mathrm{true}} \\end{cases}\n    $$\n    The target structure is given by the low-density closure, $g_{\\mathrm{target}}(r) = \\exp(-U_{\\mathrm{true}}(r)/T)$.\n    The target pressure, $p_{\\mathrm{target}}$, is calculated using the virial expression with $U_{\\mathrm{true}}(r)$ and $g_{\\mathrm{target}}(r)$, integrating up to $r_c^{\\mathrm{true}}$. The derivative $\\frac{dU_{\\mathrm{true}}}{dr}$ is equal to $\\frac{dU_{\\mathrm{LJ}}}{dr}$ for $r \\le r_c^{\\mathrm{true}}$ and $0$ otherwise.\n\n2.  **Analyze the IBI-Only Model**:\n    The IBI method aims to reproduce a target structure, $g_{\\mathrm{target}}(r)$. In its simplest, non-iterative form, the potential $U_{\\mathrm{IBI}}(r)$ is obtained by inverting the Boltzmann relation on the coarse-grained domain $[0, r_c^{\\mathrm{cg}}]$:\n    $$\n    U_{\\mathrm{IBI}}(r) = -T \\ln(g_{\\mathrm{target}}(r)) \\quad \\text{for } r \\le r_c^{\\mathrm{cg}}\n    $$\n    Given $g_{\\mathrm{target}}(r) = \\exp(-U_{\\mathrm{true}}(r)/T)$, it follows that $U_{\\mathrm{IBI}}(r) = U_{\\mathrm{true}}(r)$ for all $r \\le r_c^{\\mathrm{cg}}$. By this construction, the RDF of the IBI model, $g_{\\mathrm{IBI}}(r) = \\exp(-U_{\\mathrm{IBI}}(r)/T)$, is identical to $g_{\\mathrm{target}}(r)$ on the domain $[0, r_c^{\\mathrm{cg}}]$. Consequently, the structure-matching metric, $\\mathrm{RMS}_g$, is identically zero for the IBI model.\n    The pressure of the IBI model, $p_{\\mathrm{IBI}}$, is calculated using the virial theorem with $U_{\\mathrm{IBI}}(r)$ and $g_{\\mathrm{IBI}}(r)$, integrating up to the coarse-grained cutoff $r_c^{\\mathrm{cg}}$.\n    The IBI-only model is considered successful if $|p_{\\mathrm{IBI}} - p_{\\mathrm{target}}| \\le 0.01$. The structure metric is met by definition.\n\n3.  **Analyze the Pressure-Corrected Model**:\n    When $p_{\\mathrm{IBI}}$ does not match $p_{\\mathrm{target}}$, a correction term is added to the potential. Here, a linear correction $\\Delta U(r) = a\\,r$ is used for $r \\le r_c^{\\mathrm{cg}}$. The corrected potential is $U_{\\mathrm{corr}}(r) = U_{\\mathrm{IBI}}(r) + a\\,r$.\n    The coefficient $a$ is determined by approximating the required pressure change. The change in the virial contribution due to $\\Delta U(r)$ is approximated as $\\Delta p \\approx -\\frac{2π}{3} ρ^2 \\int_0^{r_c^{\\mathrm{cg}}} g_{\\mathrm{target}}(r)\\, r^3 \\frac{d(\\Delta U(r))}{dr}\\, dr$. Setting $\\Delta p = p_{\\mathrm{target}} - p_{\\mathrm{IBI}}$ and using $\\frac{d(\\Delta U(r))}{dr} = a$, we solve for $a$:\n    $$\n    a = -\\frac{p_{\\mathrm{target}} - p_{\\mathrm{IBI}}}{\\frac{2π}{3} ρ^2 \\int_0^{r_c^{\\mathrm{cg}}} g_{\\mathrm{target}}(r)\\, r^3\\, dr}\n    $$\n    This one-shot correction defines the new potential $U_{\\mathrm{corr}}(r)$. The corresponding new structure is $g_{\\mathrm{corr}}(r) = \\exp(-U_{\\mathrm{corr}}(r)/T)$. The corrected pressure, $p_{\\mathrm{corr}}$, is calculated from the virial theorem using $U_{\\mathrm{corr}}(r)$ and $g_{\\mathrm{corr}}(r)$, integrating up to $r_c^{\\mathrm{cg}}$.\n    The corrected model is successful if it satisfies two conditions simultaneously:\n    a. Structure match: $\\mathrm{RMS}_g = \\sqrt{ \\frac{1}{N} \\sum_{i=1}^N \\left( g_{\\mathrm{corr}}(r_i) - g_{\\mathrm{target}}(r_i) \\right)^2 } \\le 0.03$ on the domain $[r_{\\min}, r_c^{\\mathrm{cg}}]$.\n    b. Pressure match: $|p_{\\mathrm{corr}} - p_{\\mathrm{target}}| \\le 0.01$.\n\nThis procedure is applied to each test case to generate the required boolean evaluation results.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.integrate import trapezoid\n\ndef solve():\n    \"\"\"\n    Solves the coarse-graining problem for the specified test cases.\n\n    This function implements the IBI and pressure-correction models for a coarse-grained\n    fluid. It evaluates whether each model can simultaneously reproduce the target\n    structure (radial distribution function) and pressure within given tolerances.\n    \"\"\"\n    \n    # Define problem constants and tolerances\n    r_min = 0.80\n    rms_g_tol = 0.03\n    p_tol = 0.01\n    \n    # In reduced units, epsilon, sigma, and k_B are 1.\n    epsilon = 1.0\n    sigma = 1.0\n    k_B = 1.0\n    \n    # Define a numerical grid. The maximum r_c_true is 3.0, so this range is sufficient.\n    num_points = 4001 # A fine grid for stable quadrature\n    r_grid = np.linspace(r_min, 3.0, num_points)\n\n    # Define the Lennard-Jones potential and its derivative in reduced units\n    def U_lj(r):\n        r_inv = sigma / r\n        r_inv6 = r_inv**6\n        return 4.0 * epsilon * (r_inv6**2 - r_inv6)\n\n    def dU_lj_dr(r):\n        r_inv = sigma / r\n        r_inv7 = r_inv**7\n        r_inv13 = r_inv**13\n        return 4.0 * epsilon * (-12.0 * r_inv13 / sigma + 6.0 * r_inv7 / sigma)\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (T, ρ, r_c^true, r_c^cg)\n        (1.0, 0.2, 3.0, 2.0),\n        (1.0, 0.01, 3.0, 2.0),\n        (1.0, 0.2, 2.0, 2.0),\n    ]\n\n    results = []\n    \n    for T, rho, r_c_true, r_c_cg in test_cases:\n        beta = 1.0 / (k_B * T)\n        \n        # --- 1. Target Model Calculation ---\n        \n        # Define the truncated-and-shifted target potential U_true(r)\n        U_lj_at_rc_true = U_lj(r_c_true)\n        U_true = np.where(r_grid = r_c_true, U_lj(r_grid) - U_lj_at_rc_true, 0.0)\n        \n        # Define the target radial distribution function g_target(r)\n        g_target = np.exp(-beta * U_true)\n        \n        # Define the derivative of the target potential\n        dU_true_dr = np.where(r_grid = r_c_true, dU_lj_dr(r_grid), 0.0)\n        \n        # Calculate the target pressure p_target\n        integrand_target = g_target * r_grid**3 * dU_true_dr\n        mask_true = r_grid = r_c_true\n        integral_target = trapezoid(integrand_target[mask_true], r_grid[mask_true])\n        p_target = rho * T - (2.0 * np.pi / 3.0) * rho**2 * integral_target\n        \n        # --- 2. IBI-Only Model Calculation  Evaluation ---\n        \n        # By definition, U_ibi(r) = U_true(r) and g_ibi(r) = g_target(r) for r = r_c_cg.\n        # Thus, the RMS_g for the IBI-only model is 0 and always meets the criterion.\n        rms_g_ibi_ok = True\n        \n        # Calculate the IBI-only pressure p_ibi\n        dU_ibi_dr = np.where(r_grid = r_c_cg, dU_lj_dr(r_grid), 0.0)\n        integrand_ibi = g_target * r_grid**3 * dU_ibi_dr\n        mask_cg = r_grid = r_c_cg\n        integral_ibi = trapezoid(integrand_ibi[mask_cg], r_grid[mask_cg])\n        p_ibi = rho * T - (2.0 * np.pi / 3.0) * rho**2 * integral_ibi\n        \n        # Evaluate if p_ibi meets the pressure criterion\n        p_ibi_ok = abs(p_ibi - p_target) = p_tol\n        results.append(rms_g_ibi_ok and p_ibi_ok)\n\n        # --- 3. Pressure-Corrected Model Calculation  Evaluation ---\n        \n        # Calculate the pressure correction coefficient 'a'\n        p_diff = p_target - p_ibi\n        integrand_a_denom = g_target[mask_cg] * r_grid[mask_cg]**3\n        integral_a_denom = trapezoid(integrand_a_denom, r_grid[mask_cg])\n        \n        denom_const = (2.0 * np.pi / 3.0) * rho**2\n        if abs(denom_const * integral_a_denom)  1e-15:\n            a = 0.0\n        else:\n            a = -p_diff / (denom_const * integral_a_denom)\n            \n        # Define the corrected potential and its corresponding RDF\n        U_corr = np.where(mask_cg, U_true + a * r_grid, 0.0)\n        g_corr = np.exp(-beta * U_corr)\n        \n        # Evaluate structure metric for the corrected model\n        g_corr_on_cg = g_corr[mask_cg]\n        g_target_on_cg = g_target[mask_cg]\n        rms_g_corr = np.sqrt(np.mean((g_corr_on_cg - g_target_on_cg)**2))\n        rms_g_corr_ok = rms_g_corr = rms_g_tol\n        \n        # Evaluate pressure metric for the corrected model\n        dU_corr_dr = np.where(mask_cg, dU_lj_dr(r_grid) + a, 0.0)\n        integrand_corr = g_corr * r_grid**3 * dU_corr_dr\n        integral_corr = trapezoid(integrand_corr[mask_cg], r_grid[mask_cg])\n        p_corr = rho * T - (2.0 * np.pi / 3.0) * rho**2 * integral_corr\n        p_corr_ok = abs(p_corr - p_target) = p_tol\n        \n        results.append(rms_g_corr_ok and p_corr_ok)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "To make simulations computationally feasible, coarse-grained potentials are almost always truncated at a finite cutoff distance. This practical simplification, however, introduces artifacts, including a discontinuity in the force and errors in calculated thermodynamic properties like pressure. This practice guides you through deriving analytical \"tail corrections\" to account for neglected long-range interactions and designing a smooth \"switching function\" to eliminate force discontinuities, providing a robust understanding of how to obtain accurate results from truncated potentials. ",
            "id": "3500778",
            "problem": "Consider a coarse-grained (CG) fluid of identical spherical sites modeled by the Lennard-Jones (LJ) pair potential with a finite cutoff. In the united-atom or bead-spring coarse-grain representation, the effective pair potential between sites is often represented by the LJ form truncated at a cutoff radius $r_c$ to reduce computational cost. Let the LJ potential be given by $u(r) = 4 \\varepsilon \\left[\\left(\\dfrac{\\sigma}{r}\\right)^{12} - \\left(\\dfrac{\\sigma}{r}\\right)^6\\right]$, truncated to zero for $r \\ge r_c$, with no shifting. Work in reduced LJ units where the energy scale is $\\varepsilon = 1$, the length scale is $\\sigma = 1$, and the Boltzmann constant is $k_{\\mathrm{B}} = 1$, so that temperature $T$ and number density $\\rho$ are dimensionless and pressure is expressed in units of $\\varepsilon / \\sigma^3$.\n\nStarting from fundamental statistical mechanics, the pressure $P$ of an isotropic, homogeneous fluid with pairwise interactions can be written via the virial route as\n$$\nP = \\rho T - \\frac{2 \\pi}{3} \\rho^2 \\int_{0}^{\\infty} r^3 \\, u'(r) \\, g(r) \\, dr,\n$$\nwhere $u'(r) = \\dfrac{d u(r)}{dr}$ and $g(r)$ is the radial distribution function. In the low-density limit, one may take the well-tested approximation $g(r) \\approx \\exp\\left[-u(r)/T\\right]$.\n\nBecause the LJ potential is truncated at $r_c$ in the CG simulation, the virial integral is evaluated only up to $r_c$, which changes the computed pressure. A common remedy is to add a “tail correction” to the equation of state that accounts for the neglected long-range contribution beyond $r_c$ by assuming $g(r) \\approx 1$ for $r > r_c$ and using the fundamental virial expression for $P$. In addition, to mitigate artifacts from a sharp cutoff (force discontinuity), it is customary to introduce a smooth switching function $S(r)$ that modulates the force near $r_c$ so that the effective force smoothly goes to zero at $r_c$.\n\nYour tasks are:\n\n1) Using the virial expression and the low-density approximation for $g(r)$, compute the truncated virial pressure\n$$\nP_{\\mathrm{trunc}}(\\rho, T, r_c) = \\rho T - \\frac{2 \\pi}{3} \\rho^2 \\int_{0}^{r_c} r^3 \\, u'(r) \\, \\exp\\left[-\\frac{u(r)}{T}\\right] \\, dr.\n$$\n\n2) Derive, from first principles, the tail correction for the pressure\n$$\nP_{\\mathrm{tail}}(\\rho, r_c) = - \\frac{2 \\pi}{3} \\rho^2 \\int_{r_c}^{\\infty} r^3 \\, u'(r) \\, dr,\n$$\nunder the assumption $g(r) \\approx 1$ for $r > r_c$. Express $P_{\\mathrm{tail}}$ in reduced LJ units in terms of $\\rho$ and $r_c$, and use this to define the tail-corrected equation-of-state pressure $P_{\\mathrm{eos}} = P_{\\mathrm{trunc}} + P_{\\mathrm{tail}}$.\n\n3) Propose a smooth switching function $S(r)$ with the following properties:\n- $S(r) = 1$ for $r \\le r_s$, where $r_s  r_c$ is the switching-start radius.\n- $S(r) = 0$ for $r \\ge r_c$.\n- $S(r)$, $S'(r)$, and $S''(r)$ are continuous on $[0, \\infty)$, with $S'(r_s) = S''(r_s) = 0$ and $S'(r_c) = S''(r_c) = 0$.\nFind the minimal-degree polynomial form on $[r_s, r_c]$ that satisfies these constraints, and provide explicit coefficients in terms of $r_s$ and $r_c$.\n\n4) Using $S(r)$, define the switched truncated virial pressure\n$$\nP_{\\mathrm{switch}}(\\rho, T, r_s, r_c) = \\rho T - \\frac{2 \\pi}{3} \\rho^2 \\left[ \\int_{0}^{r_s} r^3 \\, u'(r) \\, \\exp\\left(-\\frac{u(r)}{T}\\right) \\, dr \\;+\\; \\int_{r_s}^{r_c} r^3 \\, S(r) \\, u'(r) \\, \\exp\\left(-\\frac{u(r)}{T}\\right) \\, dr \\right].\n$$\nForm the tail-corrected switched pressure $P_{\\mathrm{switch+tail}} = P_{\\mathrm{switch}} + P_{\\mathrm{tail}}$. Compare $P_{\\mathrm{eos}}$ to both $P_{\\mathrm{trunc}}$ and $P_{\\mathrm{switch+tail}}$.\n\n5) For each test case in the suite below, evaluate whether introducing the switching function decreases the absolute error relative to the tail-corrected equation of state. Concretely, report the boolean value of the predicate\n$$\n\\left| P_{\\mathrm{eos}} - P_{\\mathrm{switch+tail}} \\right|  \\left| P_{\\mathrm{eos}} - P_{\\mathrm{trunc}} \\right|.\n$$\n\nAll computations must be performed in reduced LJ units, and the final program output must be a single line containing the results for all test cases as a comma-separated list enclosed in square brackets, with entries being boolean values.\n\nTest suite (each tuple is $(\\rho, T, r_s, r_c)$ in reduced LJ units):\n- $(0.8, 1.2, 2.0, 2.5)$\n- $(0.05, 1.0, 2.0, 2.5)$\n- $(1.2, 0.8, 2.2, 2.5)$\n- $(0.8, 1.2, 1.6, 2.0)$\n- $(0.8, 1.2, 2.5, 2.5)$\n- $(0.8, 1.2, 0.0, 2.5)$\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,...]\").",
            "solution": "The problem is scientifically grounded, well-posed, and objective. It is based on standard principles of statistical mechanics and computational materials science, specifically concerning the calculation of pressure in coarse-grained simulations using the Lennard-Jones potential. All necessary functions, parameters, and constants are provided, and the tasks are clearly defined and computationally feasible. The problem is valid.\n\nThe solution proceeds by addressing each task in order. All calculations are performed in reduced Lennard-Jones units, where the energy scale $\\varepsilon=1$, the length scale $\\sigma=1$, and the Boltzmann constant $k_{\\mathrm{B}}=1$.\n\n**Theoretical Framework**\n\nThe Lennard-Jones (LJ) potential in reduced units is given by:\n$$ u(r) = 4 \\left( r^{-12} - r^{-6} \\right) $$\nIts derivative with respect to $r$ is:\n$$ u'(r) = \\frac{du}{dr} = 4 \\left( -12r^{-13} - (-6)r^{-7} \\right) = 24 \\left( r^{-7} - 2r^{-13} \\right) $$\n\nThe problem asks to evaluate several forms of the pressure equation and compare them. The core of the comparison is the predicate:\n$$ \\left| P_{\\mathrm{eos}} - P_{\\mathrm{switch+tail}} \\right|  \\left| P_{\\mathrm{eos}} - P_{\\mathrm{trunc}} \\right| $$\nUsing the definitions $P_{\\mathrm{eos}} = P_{\\mathrm{trunc}} + P_{\\mathrm{tail}}$ and $P_{\\mathrm{switch+tail}} = P_{\\mathrm{switch}} + P_{\\mathrm{tail}}$, the inequality simplifies.\nThe left-hand side (LHS) becomes:\n$$ \\text{LHS} = \\left| (P_{\\mathrm{trunc}} + P_{\\mathrm{tail}}) - (P_{\\mathrm{switch}} + P_{\\mathrm{tail}}) \\right| = \\left| P_{\\mathrm{trunc}} - P_{\\mathrm{switch}} \\right| $$\nThe right-hand side (RHS) becomes:\n$$ \\text{RHS} = \\left| (P_{\\mathrm{trunc}} + P_{\\mathrm_tail}) - P_{\\mathrm{trunc}} \\right| = \\left| P_{\\mathrm{tail}} \\right| $$\nSo, the predicate to evaluate is $\\left| P_{\\mathrm{trunc}} - P_{\\mathrm{switch}} \\right|  \\left| P_{\\mathrm{tail}} \\right|$.\n\nLet us express $P_{\\mathrm{trunc}} - P_{\\mathrm{switch}}$ and $P_{\\mathrm{tail}}$ using their integral definitions.\nLet $I(r, T) = r^3 u'(r) \\exp(-u(r)/T)$.\n$$ P_{\\mathrm{trunc}} = \\rho T - \\frac{2\\pi}{3}\\rho^2 \\int_0^{r_c} I(r, T) dr = \\rho T - \\frac{2\\pi}{3}\\rho^2 \\left( \\int_0^{r_s} I(r, T) dr + \\int_{r_s}^{r_c} I(r, T) dr \\right) $$\n$$ P_{\\mathrm{switch}} = \\rho T - \\frac{2\\pi}{3}\\rho^2 \\left( \\int_0^{r_s} I(r, T) dr + \\int_{r_s}^{r_c} S(r) I(r, T) dr \\right) $$\nThe difference is:\n$$ P_{\\mathrm{trunc}} - P_{\\mathrm{switch}} = -\\frac{2\\pi}{3}\\rho^2 \\left( \\int_{r_s}^{r_c} I(r, T) dr - \\int_{r_s}^{r_c} S(r) I(r, T) dr \\right) = -\\frac{2\\pi}{3}\\rho^2 \\int_{r_s}^{r_c} (1-S(r)) I(r, T) dr $$\nThe tail pressure is defined as:\n$$ P_{\\mathrm{tail}} = - \\frac{2\\pi}{3}\\rho^2 \\int_{r_c}^{\\infty} r^3 u'(r) dr $$\nSubstituting these into the inequality $\\left| P_{\\mathrm{trunc}} - P_{\\mathrm{switch}} \\right|  \\left| P_{\\mathrm{tail}} \\right|$ and canceling the common factor $\\frac{2\\pi}{3}\\rho^2$ (since $\\rho > 0$) yields:\n$$ \\left| \\int_{r_s}^{r_c} (1-S(r)) r^3 u'(r) \\exp(-u(r)/T) dr \\right|  \\left| \\int_{r_c}^{\\infty} r^3 u'(r) dr \\right| $$\n\n**Task 2: Pressure Tail Correction**\n\nWe first evaluate the integral for the tail correction analytically.\n$$ \\int r^3 u'(r) dr = \\int r^3 \\cdot 24(r^{-7} - 2r^{-13}) dr = 24 \\int (r^{-4} - 2r^{-10}) dr $$\n$$ = 24 \\left( \\frac{r^{-3}}{-3} - 2\\frac{r^{-9}}{-9} \\right) + C = 24 \\left( -\\frac{1}{3}r^{-3} + \\frac{2}{9}r^{-9} \\right) + C = -8r^{-3} + \\frac{16}{3}r^{-9} + C $$\nEvaluating the definite integral from $r_c$ to $\\infty$:\n$$ \\int_{r_c}^{\\infty} r^3 u'(r) dr = \\left[ -8r^{-3} + \\frac{16}{3}r^{-9} \\right]_{r_c}^{\\infty} = (0-0) - \\left(-8r_c^{-3} + \\frac{16}{3}r_c^{-9}\\right) = 8r_c^{-3} - \\frac{16}{3}r_c^{-9} $$\nThus, the analytical expression for the tail pressure is:\n$$ P_{\\mathrm{tail}}(\\rho, r_c) = - \\frac{2\\pi}{3}\\rho^2 \\left( 8r_c^{-3} - \\frac{16}{3}r_c^{-9} \\right) $$\nThe right-hand side of our simplified inequality is the absolute value of this integral: $\\left| 8r_c^{-3} - \\frac{16}{3}r_c^{-9} \\right|$.\n\n**Task 3: Switching Function**\n\nWe need to find a polynomial $P(x)$ on $x \\in [0, 1]$ where $x = (r-r_s)/(r_c-r_s)$ that satisfies six boundary conditions: $P(0)=1$, $P(1)=0$, $P'(0)=0$, $P'(1)=0$, $P''(0)=0$, $P''(1)=0$. This requires a polynomial of at least degree $5$. Let $P(x) = ax^5 + bx^4 + cx^3 + dx^2 + ex + f$.\nThe conditions at $x=0$ give:\n$P(0)=f=1$\n$P'(0)=e=0$\n$P''(0)=2d=0 \\implies d=0$.\nSo, $P(x) = ax^5 + bx^4 + cx^3 + 1$.\nThe conditions at $x=1$ give a system of linear equations for $a, b, c$:\n1. $P(1) = a + b + c + 1 = 0$\n2. $P'(1) = 5a + 4b + 3c = 0$\n3. $P''(1) = 20a + 12b + 6c = 0 \\implies 10a + 6b + 3c = 0$\nSolving this system yields $a=-6$, $b=15$, and $c=-10$.\nThe switching polynomial is $P(x) = -6x^5 + 15x^4 - 10x^3 + 1$.\nThe switching function $S(r)$ is defined on $[r_s, r_c]$ as $S(r) = P\\left(\\frac{r-r_s}{r_c-r_s}\\right)$.\n\n**Final Evaluation**\n\nThe task reduces to numerically evaluating, for each test case, the inequality:\n$$ \\left| \\int_{r_s}^{r_c} (1 - S(r)) r^3 u'(r) \\exp\\left(-\\frac{u(r)}{T}\\right) dr \\right|  \\left| 8r_c^{-3} - \\frac{16}{3}r_c^{-9} \\right| $$\nThe integral on the left must be computed numerically. The expression on the right is computed analytically. For the special case where $r_s \\geq r_c$, the integration interval is empty, so the integral is $0$. The inequality becomes $0  \\left| 8r_c^{-3} - \\frac{16}{3}r_c^{-9} \\right|$, which is true for any finite, non-zero $r_c$ where the argument is non-zero (true for all $r_c > 0$ in this problem).\n\nThe algorithm is as follows:\n1. For each test case $(\\rho, T, r_s, r_c)$:\n2. Calculate the value of the RHS: $V_{RHS} = \\left| 8r_c^{-3} - \\frac{16}{3}r_c^{-9} \\right|$.\n3. If $r_s \\geq r_c$, the LHS integral is $0$. The result is $0  V_{RHS}$.\n4. If $r_s  r_c$, numerically compute the LHS integral: $V_{LHS} = \\left| \\int_{r_s}^{r_c} (1-S(r)) r^3 u'(r) \\exp(-u(r)/T) dr \\right|$.\n5. Compare $V_{LHS}  V_{RHS}$ and record the boolean result.",
            "answer": "```python\nimport numpy as np\nfrom scipy import integrate\n\ndef u_lj(r):\n    \"\"\"\n    Calculates the Lennard-Jones potential in reduced units (epsilon=1, sigma=1).\n    u(r) = 4 * (r^-12 - r^-6)\n    \"\"\"\n    if not np.isfinite(r) or r = 0:\n        return np.inf\n    r_inv = 1.0 / r\n    r_inv6 = r_inv**6\n    return 4.0 * (r_inv6**2 - r_inv6)\n\ndef du_lj_dr(r):\n    \"\"\"\n    Calculates the derivative of the Lennard-Jones potential w.r.t. r.\n    u'(r) = 24 * (r^-7 - 2*r^-13)\n    \"\"\"\n    if not np.isfinite(r) or r = 0:\n        return -np.inf\n    r_inv = 1.0 / r\n    r_inv7 = r_inv**7\n    return 24.0 * (r_inv7 - 2.0 * r_inv7 * r_inv**6)\n\ndef switching_function(r, rs, rc):\n    \"\"\"\n    Calculates the value of the 5th-degree polynomial switching function.\n    \"\"\"\n    if r = rs:\n        return 1.0\n    if r >= rc:\n        return 0.0\n    \n    # This case is handled by the integration limits, but as a safeguard:\n    if np.isclose(rc, rs):\n        return 0.0\n\n    x = (r - rs) / (rc - rs)\n    # P(x) = a*x^5 + b*x^4 + c*x^3 + 1, with a=-6, b=15, c=-10\n    # Implemented using Horner's method for efficiency.\n    P_x = 1.0 + x**3 * (-10.0 + x * (15.0 - 6.0 * x))\n    return P_x\n\ndef solve():\n    \"\"\"\n    Solves the problem for the given test suite.\n    \"\"\"\n    test_cases = [\n        # (rho, T, rs, rc)\n        (0.8, 1.2, 2.0, 2.5),\n        (0.05, 1.0, 2.0, 2.5),\n        (1.2, 0.8, 2.2, 2.5),\n        (0.8, 1.2, 1.6, 2.0),\n        (0.8, 1.2, 2.5, 2.5),\n        (0.8, 1.2, 0.0, 2.5),\n    ]\n\n    results = []\n    \n    for rho, T, rs, rc in test_cases:\n        # The inequality to check is:\n        # | integral from rs to rc of (1-S(r)) * integrand |  | analytical tail integral |\n        # where integrand is r^3 * u'(r) * exp(-u(r)/T).\n\n        # Calculate the RHS: | integral of r^3 * u'(r) from rc to infinity |\n        # This is | 8*rc^-3 - (16/3)*rc^-9 |\n        if rc = 0:\n            rhs_val = np.inf\n        else:\n            rc_inv3 = rc**(-3)\n            rc_inv9 = rc**(-9)\n            rhs_val = abs(8.0 * rc_inv3 - (16.0 / 3.0) * rc_inv9)\n\n        # Calculate the LHS: | integral from rs to rc of (1-S(r)) * integrand |\n        lhs_val = 0.0\n        if rs  rc:\n            def lhs_integrand(r):\n                S_val = switching_function(r, rs, rc)\n                u_val = u_lj(r)\n                \n                # The LJ potential is repulsive at short distances, so u(r) is large\n                # and exp(-u(r)/T) is very small. For attractive part, u_min = -1,\n                # so no overflow/underflow issues are expected for typical T.\n                exp_term = np.exp(-u_val / T)\n                \n                return (1.0 - S_val) * (r**3) * du_lj_dr(r) * exp_term\n            \n            # Use SciPy's quad integrator.\n            integral_val, _ = integrate.quad(lhs_integrand, rs, rc, limit=200)\n            lhs_val = abs(integral_val)\n\n        # For rs >= rc, the integral is 0, so lhs_val remains 0.0.\n        \n        # Perform the comparison and store the boolean result.\n        results.append(lhs_val  rhs_val)\n        \n    # Format the final output string as required.\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == \"__main__\":\n    solve()\n\n```"
        },
        {
            "introduction": "Coarse-grained simulations provide powerful insights into large-scale phenomena, but we often need to reconstruct atomistic detail from the simplified CG representation—a process called \"backmapping.\" This exercise explores how stochastic backmapping procedures can introduce structural biases, altering key conformational distributions. You will implement a backmapping protocol, quantify the resulting bias using the Kullback–Leibler divergence, and assess its impact on thermodynamically important free energy differences between molecular states. ",
            "id": "3500691",
            "problem": "You are tasked with formalizing and quantifying how stochastic backmapping from coarse-grained bead-spring representations to atomistic or united-atom structures introduces structural bias in dihedral angle distributions, and how this bias affects free energy differences between predefined macrostates. Consider a single torsional degree of freedom represented by a dihedral angle $\\varphi \\in [-\\pi,\\pi)$ on the unit circle. The system has an atomistic (united-atom) target torsional potential $U_{\\mathrm{AT}}(\\varphi)$ and a simplified coarse-grained bead-spring torsional potential $U_{\\mathrm{CG}}(\\varphi)$. Stochastic backmapping constructs atomistic dihedral angles from the coarse-grained angle distribution via a wrapped Gaussian kernel, introducing a tunable bias.\n\nFundamental base:\n- The Boltzmann distribution for a torsional coordinate at absolute temperature $T$ is $p(\\varphi) = Z^{-1} \\exp(-\\beta U(\\varphi))$ where $\\beta = 1/(R T)$, $R$ is the ideal gas constant in $\\mathrm{kJ\\,mol^{-1}\\,K^{-1}}$, and $Z = \\int_{-\\pi}^{\\pi} \\exp(-\\beta U(\\varphi))\\,d\\varphi$ is the partition function.\n- The free energy of a macrostate $M \\subset [-\\pi,\\pi)$ is $F_M = - R T \\ln Z_M$ with $Z_M = \\int_M p(\\varphi)\\,d\\varphi$, and the free energy difference between two macrostates $A$ and $B$ is $\\Delta F = F_B - F_A = -R T \\ln\\left(\\frac{Z_B}{Z_A}\\right)$.\n- A stochastic backmapping kernel on a circle is modeled by a wrapped normal distribution. For a given mean bias $b$ and standard deviation $\\sigma$, the kernel is\n$$\nW(\\Delta\\varphi; b, \\sigma) = \\sum_{k=-\\infty}^{\\infty} \\frac{1}{\\sqrt{2\\pi}\\sigma} \\exp\\left(-\\frac{(\\Delta\\varphi - b + 2\\pi k)^2}{2\\sigma^2}\\right),\n$$\nwhich ensures $\\int_{-\\pi}^{\\pi} W(\\Delta\\varphi; b, \\sigma)\\,d\\Delta\\varphi = 1$.\n- Macrostates are defined by angle intervals: $A$ (cis-like) is $\\{\\varphi: |\\varphi| \\le \\varphi_c\\}$ and $B$ (trans-like) is $\\{\\varphi: \\min(|\\varphi - \\pi|, |\\varphi + \\pi|) \\le \\varphi_c\\}$.\n\nYour program must implement the following, strictly using the definitions above and numerical quadrature on a uniform grid over $[-\\pi,\\pi)$:\n\n1. Construct the atomistic target potential\n$$\nU_{\\mathrm{AT}}(\\varphi) = k_1(1 - \\cos\\varphi) + k_3(1 - \\cos(3\\varphi)),\n$$\nand the coarse-grained potential\n$$\nU_{\\mathrm{CG}}(\\varphi) = k_{\\mathrm{CG}}(1 - \\cos\\varphi),\n$$\nwith all $k$ parameters in $\\mathrm{kJ\\,mol^{-1}}$.\n\n2. Compute the normalized atomistic torsional probability density $P_{\\mathrm{AT}}(\\varphi) \\propto \\exp(-\\beta U_{\\mathrm{AT}}(\\varphi))$ and the normalized coarse-grained torsional density $P_{\\mathrm{CG}}(\\varphi) \\propto \\exp(-\\beta U_{\\mathrm{CG}}(\\varphi))$ on a uniform grid.\n\n3. Define the wrapped Gaussian kernel $W(\\Delta\\varphi; b, \\sigma)$ on the grid and compute the stochastically backmapped (biased) atomistic reconstruction density by circular convolution\n$$\nQ(\\varphi) = \\int_{-\\pi}^{\\pi} P_{\\mathrm{CG}}(\\psi)\\, W(\\varphi - \\psi; b, \\sigma)\\, d\\psi,\n$$\nnormalized so that $\\int_{-\\pi}^{\\pi} Q(\\varphi)\\,d\\varphi = 1$.\n\n4. Compute three free energy differences:\n   - The true atomistic $\\Delta F_{\\mathrm{true}} = -R T \\ln\\left(\\frac{\\int_B P_{\\mathrm{AT}}(\\varphi)\\,d\\varphi}{\\int_A P_{\\mathrm{AT}}(\\varphi)\\,d\\varphi}\\right)$.\n   - The measured from biased reconstruction $\\Delta F_{\\mathrm{meas}} = -R T \\ln\\left(\\frac{\\int_B Q(\\varphi)\\,d\\varphi}{\\int_A Q(\\varphi)\\,d\\varphi}\\right)$.\n   - An approximate reweighting estimate that uses the ratio of atomistic to coarse-grained Boltzmann weights,\n$$\nw(\\varphi) = \\frac{P_{\\mathrm{AT}}(\\varphi)}{P_{\\mathrm{CG}}(\\varphi)},\n$$\nto define\n$$\n\\Delta F_{\\mathrm{rw}} = -R T \\ln\\left(\\frac{\\int_B w(\\varphi)\\, Q(\\varphi)\\, d\\varphi}{\\int_A w(\\varphi)\\, Q(\\varphi)\\, d\\varphi}\\right).\n$$\n\n5. Quantify the structural bias using the Kullback–Leibler divergence (relative entropy)\n$$\nD_{\\mathrm{KL}}(Q\\Vert P_{\\mathrm{AT}}) = \\int_{-\\pi}^{\\pi} Q(\\varphi)\\, \\ln\\left(\\frac{Q(\\varphi)}{P_{\\mathrm{AT}}(\\varphi)}\\right)\\, d\\varphi.\n$$\n\nImplementation notes:\n- Use a uniform $N$-point grid over $[-\\pi,\\pi)$ with $N$ sufficiently large to accurately resolve the integrals; use the trapezoidal rule equivalent to a Riemann sum on the uniform grid. Circular convolution must respect periodic boundary conditions; implement it via the discrete Fourier transform for efficiency or direct circular summation. Ensure all densities are normalized.\n- To maintain numerical stability, when forming ratios $\\frac{P_{\\mathrm{AT}}(\\varphi)}{P_{\\mathrm{CG}}(\\varphi)}$ and logarithms in $D_{\\mathrm{KL}}$, add a small positive constant $\\varepsilon$ to denominators and densities to avoid division by zero and undefined logarithms, while keeping $\\varepsilon$ negligible compared to unity.\n- All free energies must be expressed in $\\mathrm{kJ\\,mol^{-1}}$ and computed using $R = 8.314462618\\times 10^{-3}\\ \\mathrm{kJ\\,mol^{-1}\\,K^{-1}}$. Angles are in radians.\n\nTest suite:\nFor each parameter set $(T, k_1, k_3, k_{\\mathrm{CG}}, b, \\sigma, \\varphi_c)$ below, compute $[D_{\\mathrm{KL}}(Q\\Vert P_{\\mathrm{AT}}),\\ \\Delta F_{\\mathrm{meas}},\\ \\Delta F_{\\mathrm{rw}},\\ \\Delta F_{\\mathrm{true}}]$ with free energies in $\\mathrm{kJ\\,mol^{-1}}$, and aggregate results as specified.\n\n- Case 1 (baseline, mild noise, no bias): $T = 300$, $k_1 = 2.5$, $k_3 = 1.0$, $k_{\\mathrm{CG}} = 2.0$, $b = 0.0$, $\\sigma = 0.2$, $\\varphi_c = 0.3$.\n- Case 2 (positive mean bias, moderate noise): $T = 300$, $k_1 = 2.5$, $k_3 = 1.0$, $k_{\\mathrm{CG}} = 1.5$, $b = 0.4$, $\\sigma = 0.3$, $\\varphi_c = 0.3$.\n- Case 3 (negative mean bias, larger noise): $T = 300$, $k_1 = 2.5$, $k_3 = 1.0$, $k_{\\mathrm{CG}} = 2.5$, $b = -0.6$, $\\sigma = 0.5$, $\\varphi_c = 0.3$.\n- Case 4 (strong smoothing, small macrostate width): $T = 300$, $k_1 = 2.5$, $k_3 = 1.0$, $k_{\\mathrm{CG}} = 2.0$, $b = 0.0$, $\\sigma = 1.0$, $\\varphi_c = 0.1$.\n- Case 5 (higher temperature, moderate bias): $T = 500$, $k_1 = 2.5$, $k_3 = 1.0$, $k_{\\mathrm{CG}} = 2.0$, $b = 0.2$, $\\sigma = 0.4$, $\\varphi_c = 0.3$.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each element is itself a comma-separated list in square brackets corresponding to one test case in the same order as given above. For example,\n$[ [d_1, f^{\\mathrm{meas}}_1, f^{\\mathrm{rw}}_1, f^{\\mathrm{true}}_1], [d_2, f^{\\mathrm{meas}}_2, f^{\\mathrm{rw}}_2, f^{\\mathrm{true}}_2], \\dots ]$,\nwith all numbers in floating-point representation and free energies in $\\mathrm{kJ\\,mol^{-1}}$.",
            "solution": "The user has provided a well-defined computational problem in the domain of statistical mechanics and coarse-grained modeling, which requires validation before proceeding to a solution.\n\n### Step 1: Problem Validation\n\nThe problem statement is critically evaluated against the specified criteria.\n\n-   **Extracted Givens**:\n    -   **System**: A single torsional degree of freedom $\\varphi \\in [-\\pi, \\pi)$.\n    -   **Physical Model**: Boltzmann statistics with probability density $p(\\varphi) \\propto \\exp(-\\beta U(\\varphi))$, where $\\beta = 1/(R T)$ and $R = 8.314462618 \\times 10^{-3} \\ \\mathrm{kJ\\ mol^{-1}\\ K^{-1}}$.\n    -   **Potentials**: Atomistic potential $U_{\\mathrm{AT}}(\\varphi) = k_1(1 - \\cos\\varphi) + k_3(1 - \\cos(3\\varphi))$ and coarse-grained potential $U_{\\mathrm{CG}}(\\varphi) = k_{\\mathrm{CG}}(1 - \\cos\\varphi)$.\n    -   **Backmapping**: A stochastic process modeled by a wrapped normal kernel $W(\\Delta\\varphi; b, \\sigma) = \\sum_{k=-\\infty}^{\\infty} \\frac{1}{\\sqrt{2\\pi}\\sigma} \\exp\\left(-\\frac{(\\Delta\\varphi - b + 2\\pi k)^2}{2\\sigma^2}\\right)$. The backmapped distribution is $Q(\\varphi) = \\int_{-\\pi}^{\\pi} P_{\\mathrm{CG}}(\\psi)\\, W(\\varphi - \\psi; b, \\sigma)\\, d\\psi$.\n    -   **Macrostates**: $A = \\{\\varphi: |\\varphi| \\le \\varphi_c\\}$, $B = \\{\\varphi: \\min(|\\varphi - \\pi|, |\\varphi + \\pi|) \\le \\varphi_c\\}$.\n    -   **Observables**:\n        1.  Free energy difference: $\\Delta F = F_B - F_A = -R T \\ln(\\int_B p(\\varphi)d\\varphi / \\int_A p(\\varphi)d\\varphi)$, computed for $p=P_{\\mathrm{AT}}$ ($\\Delta F_{\\mathrm{true}}$) and $p=Q$ ($\\Delta F_{\\mathrm{meas}}$).\n        2.  Reweighted free energy difference: $\\Delta F_{\\mathrm{rw}} = -R T \\ln(\\int_B w(\\varphi)Q(\\varphi)d\\varphi / \\int_A w(\\varphi)Q(\\varphi)d\\varphi)$, with $w(\\varphi) = P_{\\mathrm{AT}}(\\varphi)/P_{\\mathrm{CG}}(\\varphi)$.\n        3.  Kullback-Leibler divergence: $D_{\\mathrm{KL}}(Q\\Vert P_{\\mathrm{AT}}) = \\int_{-\\pi}^{\\pi} Q(\\varphi)\\, \\ln(Q(\\varphi)/P_{\\mathrm{AT}}(\\varphi))\\, d\\varphi$.\n    -   **Numerical Method**: Uniform grid on $[-\\pi, \\pi)$, trapezoidal rule for integration, circular convolution, and use of a small constant $\\varepsilon$ for numerical stability.\n    -   **Test Data**: Five sets of parameters $(T, k_1, k_3, k_{\\mathrm{CG}}, b, \\sigma, \\varphi_c)$ are provided.\n\n-   **Validation Verdict**:\n    1.  **Scientifically Grounded**: The problem is based on fundamental principles of statistical mechanics (Boltzmann distribution, free energy) and standard techniques in computational chemistry (coarse-graining, reweighting). The potential forms and backmapping kernel are standard. The problem is scientifically sound.\n    2.  **Well-Posed**: The problem is mathematically well-defined. All quantities are specified by explicit formulas. Given the input parameters, a unique and meaningful solution exists.\n    3.  **Objective**: The language is precise and unbiased. All terms are formally defined.\n    4.  **Complete and Consistent**: All necessary constants, formulas, and parameters are provided. While numerical details like the grid size $N$ and the truncation of the infinite sum for $W$ are left to the implementer, this is standard for numerical problems and does not constitute incompleteness. The problem is self-contained and consistent.\n\nThe problem is deemed **valid**. A solution will be developed.\n\n### Step 2: Solution Design\n\nThe solution involves numerically computing the specified physical quantities. This requires discretization of the continuous degree of freedom $\\varphi$ and implementation of numerical algorithms for integration and convolution.\n\n1.  **Discretization**: The continuous domain $\\varphi \\in [-\\pi, \\pi)$ is discretized into a uniform grid of $N$ points. Let $\\varphi_j = -\\pi + j \\cdot \\Delta\\varphi$ for $j = 0, \\dots, N-1$, where the grid spacing is $\\Delta\\varphi = 2\\pi/N$. A sufficiently large $N$ (e.g., $N=4096$) is chosen for accuracy. For a periodic function on a uniform grid, the trapezoidal rule for integration over the full period simplifies to a sum of the function values multiplied by $\\Delta\\varphi$.\n\n2.  **Probability Densities**:\n    -   The potentials $U_{\\mathrm{AT}}(\\varphi_j)$ and $U_{\\mathrm{CG}}(\\varphi_j)$ are evaluated at each grid point.\n    -   The corresponding unnormalized Boltzmann probability densities are calculated: $p'_{\\mathrm{AT}}(\\varphi_j) = \\exp(-\\beta U_{\\mathrm{AT}}(\\varphi_j))$ and $p'_{\\mathrm{CG}}(\\varphi_j) = \\exp(-\\beta U_{\\mathrm{CG}}(\\varphi_j))$, with $\\beta = 1/(RT)$.\n    -   The normalization constant (partition function) is computed via numerical integration, e.g., $Z_{\\mathrm{AT}} = \\sum_{j=0}^{N-1} p'_{\\mathrm{AT}}(\\varphi_j) \\Delta\\varphi$.\n    -   The normalized probability densities are then $P_{\\mathrm{AT}}(\\varphi_j) = p'_{\\mathrm{AT}}(\\varphi_j) / Z_{\\mathrm{AT}}$ and $P_{\\mathrm{CG}}(\\varphi_j) = p'_{\\mathrm{CG}}(\\varphi_j) / Z_{\\mathrm{CG}}$.\n\n3.  **Backmapped Density $Q(\\varphi)$**:\n    -   The backmapped density $Q(\\varphi)$ is obtained by the circular convolution of the coarse-grained density $P_{\\mathrm{CG}}(\\varphi)$ with the wrapped normal kernel $W(\\varphi; b, \\sigma)$.\n    -   First, the kernel $W(\\varphi_j; b, \\sigma)$ is evaluated on the grid. The infinite sum in its definition is truncated to a finite range, e.g., $k \\in \\{-5, \\dots, 5\\}$, which provides sufficient accuracy for the given $\\sigma$ values. The discretized kernel is also normalized to ensure its integral is unity.\n    -   The circular convolution is most efficiently performed using the Fast Fourier Transform (FFT) via the convolution theorem: $\\mathcal{F}\\{f * g\\} = \\mathcal{F}\\{f\\} \\cdot \\mathcal{F}\\{g\\}$. The discrete convolution integral $Q(\\varphi_i) \\approx \\sum_j P_{\\mathrm{CG}}(\\varphi_j) W(\\varphi_i - \\varphi_j) \\Delta\\varphi$ is calculated as $Q = \\text{IDFT}(\\text{DFT}(P_{\\mathrm{CG}}) \\cdot \\text{DFT}(W)) \\cdot \\Delta\\varphi$, where IDFT and DFT denote the inverse and forward discrete Fourier transforms, respectively. The result $Q$ is a normalized probability density on the grid.\n\n4.  **Numerical Integration and Macrostates**:\n    -   The macrostates $A$ and $B$ are represented by boolean masks on the grid.\n        -   $A$: `mask_A` is true where $|\\varphi_j| \\le \\varphi_c$.\n        -   $B$: `mask_B` is true where $|\\varphi_j| \\ge \\pi - \\varphi_c$. This is equivalent to the distance on the circle to $\\pi$ being less than or equal to $\\varphi_c$.\n    -   Integrals over a macrostate $M$ are computed by summing the values of the integrand at the grid points within $M$ and multiplying by $\\Delta\\varphi$. For example, $\\int_A P_{\\mathrm{AT}}(\\varphi)d\\varphi \\approx \\sum_{j \\in A} P_{\\mathrm{AT}}(\\varphi_j) \\Delta\\varphi$.\n\n5.  **Free Energy and KL Divergence Calculation**:\n    -   **$\\Delta F_{\\mathrm{true}}$ and $\\Delta F_{\\mathrm{meas}}$**: The integrated probabilities for states $A$ and $B$, denoted $Z_{A}$ and $Z_{B}$, are calculated for both $P_{\\mathrm{AT}}$ and $Q$. The free energy differences are then computed using the formula $\\Delta F = -RT\\ln(Z_B/Z_A)$. A small constant $\\varepsilon$ is added to the arguments of the logarithm to prevent numerical errors if a state has zero probability.\n    -   **$\\Delta F_{\\mathrm{rw}}$**: The reweighting factor $w(\\varphi_j) = P_{\\mathrm{AT}}(\\varphi_j) / (P_{\\mathrm{CG}}(\\varphi_j) + \\varepsilon)$ is computed. Then, the integrals of the product $w(\\varphi)Q(\\varphi)$ over macrostates $A$ and $B$ are calculated. $\\Delta F_{\\mathrm{rw}}$ is found using these integrated values in the free energy formula.\n    -   **$D_{\\mathrm{KL}}(Q\\Vert P_{\\mathrm{AT}})$**: The KL divergence is computed by numerically integrating the expression $Q(\\varphi_j)\\ln((Q(\\varphi_j)+\\varepsilon)/(P_{\\mathrm{AT}}(\\varphi_j)+\\varepsilon))$ over the entire grid.\n\nThis structured numerical procedure provides a robust method for computing all required quantities for each test case.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test cases.\n    It iterates through each parameter set, computes the specified quantities,\n    and prints the formatted results.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (T, k1, k3, k_CG, b, sigma, phi_c)\n        (300.0, 2.5, 1.0, 2.0, 0.0, 0.2, 0.3),\n        (300.0, 2.5, 1.0, 1.5, 0.4, 0.3, 0.3),\n        (300.0, 2.5, 1.0, 2.5, -0.6, 0.5, 0.3),\n        (300.0, 2.5, 1.0, 2.0, 0.0, 1.0, 0.1),\n        (500.0, 2.5, 1.0, 2.0, 0.2, 0.4, 0.3),\n    ]\n\n    results = []\n    for case in test_cases:\n        result = _calculate_observables(case)\n        results.append(result)\n\n    # Format the final output string as a list of lists.\n    # Each sublist is a comma-separated string of numbers.\n    # The final string is a comma-separated list of these sublists.\n    sub_lists_as_strings = []\n    for res in results:\n        sub_list_str = f\"[{','.join([f'{x:.6f}' for x in res])}]\"\n        sub_lists_as_strings.append(sub_list_str)\n    \n    final_output = f\"[{','.join(sub_lists_as_strings)}]\"\n    print(final_output)\n\ndef _wrapped_normal(delta_phi, b, sigma, n_points):\n    \"\"\"\n    Computes the wrapped normal distribution on a grid.\n    The infinite sum is truncated to k in [-5, 5].\n    \"\"\"\n    # Truncation range for the sum\n    k_range = np.arange(-5, 6)\n    \n    # Use broadcasting for efficient computation over the grid and k-range\n    # delta_phi shape: (n_points,) -> (n_points, 1)\n    # k_range shape: (11,) -> (1, 11)\n    numerator = -(delta_phi[:, None] - b + 2.0 * np.pi * k_range[None, :])**2\n    denominator = 2.0 * sigma**2\n    gaussians = np.exp(numerator / denominator)\n    \n    # Sum over the k-dimension\n    summed_gaussians = np.sum(gaussians, axis=1)\n    prefactor = 1.0 / (np.sqrt(2.0 * np.pi) * sigma)\n    \n    return prefactor * summed_gaussians\n\ndef _calculate_observables(params):\n    \"\"\"\n    Performs the full calculation for a single parameter set.\n    \"\"\"\n    T, k1, k3, k_CG, b, sigma, phi_c = params\n    \n    # Constants and numerical parameters\n    R = 8.314462618e-3  # kJ mol^-1 K^-1\n    N = 4096              # Number of grid points\n    epsilon = 1e-16       # Small constant for numerical stability\n\n    beta = 1.0 / (R * T)\n\n    # 1. Discretize the domain\n    phi = np.linspace(-np.pi, np.pi, N, endpoint=False)\n    d_phi = 2.0 * np.pi / N\n\n    # 2. Compute potentials and probability densities\n    # Atomistic (AT) model\n    U_at = k1 * (1.0 - np.cos(phi)) + k3 * (1.0 - np.cos(3.0 * phi))\n    boltz_at = np.exp(-beta * U_at)\n    Z_at_total = np.sum(boltz_at) * d_phi\n    P_at = boltz_at / Z_at_total\n\n    # Coarse-grained (CG) model\n    U_cg = k_CG * (1.0 - np.cos(phi))\n    boltz_cg = np.exp(-beta * U_cg)\n    Z_cg_total = np.sum(boltz_cg) * d_phi\n    P_cg = boltz_cg / Z_cg_total\n\n    # 3. Compute backmapped density Q via circular convolution\n    W_kernel = _wrapped_normal(phi, b, sigma, N)\n    # Ensure kernel is normalized on the discrete grid\n    W_kernel /= (np.sum(W_kernel) * d_phi)\n\n    # FFT-based circular convolution\n    Q_unnormalized = np.real(np.fft.ifft(np.fft.fft(P_cg) * np.fft.fft(W_kernel)))\n    Q = Q_unnormalized * d_phi\n    # Re-normalize Q to be safe against minor numerical drift\n    Q /= (np.sum(Q) * d_phi)\n\n    # 4. Define macrostates and compute integrals for free energies\n    mask_A = np.abs(phi) = phi_c\n    mask_B = np.abs(phi) >= np.pi - phi_c\n\n    # For Delta F_true (from P_at)\n    prob_A_at = np.sum(P_at[mask_A]) * d_phi\n    prob_B_at = np.sum(P_at[mask_B]) * d_phi\n    \n    # For Delta F_meas (from Q)\n    prob_A_q = np.sum(Q[mask_A]) * d_phi\n    prob_B_q = np.sum(Q[mask_B]) * d_phi\n    \n    # For Delta F_rw (reweighting)\n    w = P_at / (P_cg + epsilon)\n    prob_A_rw = np.sum(w[mask_A] * Q[mask_A]) * d_phi\n    prob_B_rw = np.sum(w[mask_B] * Q[mask_B]) * d_phi\n\n    # Compute free energy differences\n    delta_F_true = -R * T * np.log((prob_B_at + epsilon) / (prob_A_at + epsilon))\n    delta_F_meas = -R * T * np.log((prob_B_q + epsilon) / (prob_A_q + epsilon))\n    delta_F_rw = -R * T * np.log((prob_B_rw + epsilon) / (prob_A_rw + epsilon))\n\n    # 5. Compute Kullback-Leibler divergence\n    integrand_kl = Q * np.log((Q + epsilon) / (P_at + epsilon))\n    D_kl = np.sum(integrand_kl) * d_phi\n\n    return [D_kl, delta_F_meas, delta_F_rw, delta_F_true]\n\nif __name__ == \"__main__\":\n    solve()\n```"
        }
    ]
}