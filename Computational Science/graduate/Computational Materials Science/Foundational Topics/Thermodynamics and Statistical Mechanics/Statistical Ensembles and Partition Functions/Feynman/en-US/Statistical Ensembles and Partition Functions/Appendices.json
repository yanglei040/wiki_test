{
    "hands_on_practices": [
        {
            "introduction": "The theoretical definition of the partition function, $Z = \\sum_i g_i \\exp(-\\beta E_i)$, presents a significant numerical challenge in practice. The exponential terms can span many orders of magnitude, easily causing overflow or underflow errors in standard floating-point arithmetic. This first exercise  introduces an essential stabilization technique: reformulating the sum by factoring out the ground-state energy, which guarantees that all remaining exponential terms are less than or equal to one. Mastering this approach is a prerequisite for nearly all reliable calculations in statistical mechanics.",
            "id": "3260986",
            "problem": "In the canonical ensemble of statistical mechanics, the partition function is defined by $Z = \\sum_{i} g_{i} \\exp\\!\\big(-E_{i}/(k_B T)\\big)$, where $g_{i}$ is the degeneracy of level $i$, $E_{i}$ is its energy, $T$ is the absolute temperature, and $k_B$ is the Boltzmann constant ($k_B$). In finite-precision floating-point arithmetic, direct evaluation of the sum can suffer from overflow or underflow when some $\\exp\\!\\big(-E_{i}/(k_B T)\\big)$ are extremely large or small in magnitude.\n\nStarting from the definition of $Z$ and basic properties of the exponential function, derive a reformulation of $Z$ obtained by factoring out the ground-state energy $E_{0}$ so that the remaining sum is composed of terms that are at most of order unity in magnitude. Explain why this reformulation alleviates overflow and underflow when computing $\\ln Z$.\n\nThen apply your reformulation to a three-level system at temperature $T$ with degeneracies and energies specified in the following dimensionless form, using $\\beta \\equiv 1/(k_B T)$:\n- $\\beta E_{0} = -1000$, $g_{0} = 1$,\n- $\\beta E_{1} = \\beta E_{0} + 500 \\ln 10$, $g_{1} = 10^{500}$,\n- $\\beta E_{2} = \\beta E_{0} + 1200 \\ln 10$, $g_{2} = 10^{900}$.\n\nCompute $\\ln Z$ for this system using your stabilized expression. Round your final numerical result for $\\ln Z$ to $6$ significant figures. The answer is dimensionless; report only the number.",
            "solution": "The problem statement is scientifically grounded, well-posed, and requires the application of a standard numerical stabilization technique. Thus, a solution will be provided.\n\nThe canonical partition function $Z$ is given by\n$$\nZ = \\sum_{i} g_{i} \\exp\\left(-\\frac{E_{i}}{k_B T}\\right)\n$$\nUsing the definition $\\beta \\equiv 1/(k_B T)$, this becomes\n$$\nZ = \\sum_{i} g_{i} \\exp(-\\beta E_{i})\n$$\n\n**Part 1: Reformulation of Z**\n\nTo stabilize the calculation, we identify the ground-state energy $E_{0}$, which is the minimum energy in the system ($E_{0} \\le E_{i}$ for all $i$). We can factor out the term corresponding to this energy from the sum. We rewrite the exponent by adding and subtracting $E_0$:\n$$\n-\\beta E_{i} = -\\beta (E_{i} - E_{0} + E_{0}) = -\\beta(E_{i} - E_{0}) - \\beta E_{0}\n$$\nSubstituting this into the expression for $Z$:\n$$\nZ = \\sum_{i} g_{i} \\exp\\big(-\\beta(E_{i} - E_{0}) - \\beta E_{0}\\big)\n$$\nUsing the property of the exponential function, $\\exp(a+b) = \\exp(a)\\exp(b)$, we can separate the terms:\n$$\nZ = \\sum_{i} g_{i} \\exp\\big(-\\beta(E_{i} - E_{0})\\big) \\exp(-\\beta E_{0})\n$$\nSince the term $\\exp(-\\beta E_{0})$ is a common factor for every term in the summation over the index $i$, it can be factored out of the sum:\n$$\nZ = \\exp(-\\beta E_{0}) \\sum_{i} g_{i} \\exp\\big(-\\beta(E_{i} - E_{0})\\big)\n$$\nThis is the desired reformulation of the partition function. Let $\\Delta E_{i} = E_{i} - E_{0}$ be the energy of state $i$ relative to the ground state. Then the expression is:\n$$\nZ = \\exp(-\\beta E_{0}) \\sum_{i} g_{i} \\exp(-\\beta \\Delta E_{i})\n$$\n\n**Part 2: Alleviation of Overflow and Underflow in computing $\\ln Z$**\n\nTo compute $\\ln Z$, we take the natural logarithm of the reformulated expression:\n$$\n\\ln Z = \\ln \\left( \\exp(-\\beta E_{0}) \\sum_{i} g_{i} \\exp\\big(-\\beta(E_{i} - E_{0})\\big) \\right)\n$$\nUsing the property $\\ln(ab) = \\ln(a) + \\ln(b)$:\n$$\n\\ln Z = \\ln\\big(\\exp(-\\beta E_{0})\\big) + \\ln\\left( \\sum_{i} g_{i} \\exp\\big(-\\beta(E_{i} - E_{0})\\big) \\right)\n$$\n$$\n\\ln Z = -\\beta E_{0} + \\ln\\left( \\sum_{i} g_{i} \\exp\\big(-\\beta(E_{i} - E_{0})\\big) \\right)\n$$\nThis form avoids numerical overflow and underflow for the following reasons:\n1.  **Overflow Prevention**: The original expression for $Z$ involves terms like $\\exp(-\\beta E_i)$. If an energy level $E_i$ is highly negative, the argument $-\\beta E_i$ becomes a large positive number, causing $\\exp(-\\beta E_i)$ to overflow the limits of standard floating-point representations. In the reformulated expression, the arguments of the exponentials inside the sum are $-\\beta (E_{i} - E_{0})$. Since $E_{0}$ is the ground-state energy, we have $E_{i} \\ge E_{0}$ for all $i$, which implies $(E_{i} - E_{0}) \\ge 0$. Given that $\\beta = 1/(k_B T) > 0$, the argument is always non-positive: $-\\beta(E_{i} - E_{0}) \\le 0$. Consequently, the value of the exponential term $\\exp(-\\beta(E_i-E_0))$ is always in the range $(0, 1]$. This prevents any individual exponential term from overflowing.\n2.  **Underflow Prevention**: In the original expression, if all energies $E_i$ are large and positive, all terms $\\exp(-\\beta E_i)$ could be extremely small and underflow to $0$ in finite precision. This could lead to an incorrect calculation of $Z=0$ and $\\ln Z = -\\infty$. In the reformulated sum, the term for the ground state ($i=0$) is $g_{0} \\exp(-\\beta(E_{0} - E_{0})) = g_{0}\\exp(0) = g_{0}$. Since the degeneracy $g_0$ is typically a positive integer (in this problem, $g_0=1$), the sum is guaranteed to be at least $g_0$. This prevents the entire sum from underflowing to zero, ensuring a valid argument for the logarithm.\n\nThe technique transforms the numerically unstable task of computing the logarithm of a sum of exponentials (a \"log-sum-exp\" operation) into the sum of a large term ($-\\beta E_0$) and the logarithm of a well-behaved sum, thus ensuring numerical stability.\n\n**Part 3: Application to the Three-Level System**\n\nWe apply the stabilized formula for $\\ln Z$ to the given system:\n$$\n\\ln Z = -\\beta E_{0} + \\ln\\Big(g_{0} \\exp\\big(-\\beta(E_{0}-E_{0})\\big) + g_{1} \\exp\\big(-\\beta(E_{1}-E_{0})\\big) + g_{2} \\exp\\big(-\\beta(E_{2}-E_{0})\\big)\\Big)\n$$\nThe given values are:\n- $-\\beta E_{0} = 1000$\n- $g_{0} = 1$\n- $g_{1} = 10^{500}$ and $\\beta(E_{1} - E_{0}) = 500 \\ln 10$\n- $g_{2} = 10^{900}$ and $\\beta(E_{2} - E_{0}) = 1200 \\ln 10$\n\nLet's evaluate the terms inside the logarithm:\n- Term 0: $g_{0} \\exp(0) = 1 \\cdot 1 = 1$.\n- Term 1: $g_{1} \\exp(-\\beta(E_{1}-E_{0})) = 10^{500} \\exp(-500 \\ln 10)$. Using the identity $a \\exp(b \\ln c) = a \\exp(\\ln(c^b)) = a c^b$, we have:\n  $$\n  10^{500} \\exp(-500 \\ln 10) = 10^{500} \\exp\\big(\\ln(10^{-500})\\big) = 10^{500} \\cdot 10^{-500} = 10^{0} = 1\n  $$\n- Term 2: $g_{2} \\exp(-\\beta(E_{2}-E_{0})) = 10^{900} \\exp(-1200 \\ln 10)$. Similarly:\n  $$\n  10^{900} \\exp(-1200 \\ln 10) = 10^{900} \\exp\\big(\\ln(10^{-1200})\\big) = 10^{900} \\cdot 10^{-1200} = 10^{-300}\n  $$\n\nThe sum inside the logarithm is therefore:\n$$\n\\text{Sum} = 1 + 1 + 10^{-300} = 2 + 10^{-300}\n$$\nNow, we compute $\\ln Z$:\n$$\n\\ln Z = 1000 + \\ln(2 + 10^{-300})\n$$\nThe term $10^{-300}$ is an extremely small positive number. For any small $x$, the Taylor expansion of $\\ln(a+x)$ around $a$ is $\\ln(a) + x/a + O(x^2)$. Here, $a=2$ and $x=10^{-300}$.\n$$\n\\ln(2 + 10^{-300}) \\approx \\ln(2) + \\frac{10^{-300}}{2}\n$$\nThe value of $\\ln(2)$ is approximately $0.69314718$. The correction term $0.5 \\times 10^{-300}$ is far smaller than the precision required for the final answer. Therefore, for the purpose of rounding to $6$ significant figures, we can approximate $\\ln(2 + 10^{-300})$ as $\\ln(2)$.\n$$\n\\ln Z \\approx 1000 + \\ln(2) \\approx 1000 + 0.6931471805... = 1000.6931471805...\n$$\nThe problem requires rounding the final result to $6$ significant figures. The first six significant digits of $1000.693147...$ are $1, 0, 0, 0, 6, 9$. The seventh significant digit is $3$, which is less than $5$, so we round down (i.e., we truncate).\n$$\n\\ln Z \\approx 1000.69\n$$",
            "answer": "$$\n\\boxed{1000.69}\n$$"
        },
        {
            "introduction": "With a robust method for computing partition functions, we can now use it to verify fundamental physical principles that underpin our thermodynamic models. This practice  guides you through a numerical validation of size extensivity, a crucial property stating that the free energy of a system of non-interacting parts is the sum of their individual free energies. You will confirm the relationship $\\phi_{A \\cdot B} = \\phi_A + \\phi_B$ by explicitly constructing the partition function for a composite system and comparing its resulting free energy to the sum of its components, reinforcing the link between the mathematics of $Z$ and physical reality.",
            "id": "2805747",
            "problem": "You are asked to construct a numerical validation of size consistency and size extensivity at finite temperature for noninteracting fragments within the canonical ensemble. Work entirely with the dimensionless Helmholtz free energy, defined as $\\phi \\equiv \\beta F = -\\ln Z$, where $F$ is the Helmholtz free energy, $Z$ is the canonical partition function, $\\beta \\equiv 1/(k_B T)$, $k_B$ is the Boltzmann constant, and $T$ is the absolute temperature. For a system with discrete energy levels $\\{E_i\\}$ and degeneracies $\\{g_i\\}$, the partition function is $Z = \\sum_i g_i \\exp(-\\beta E_i)$. For two noninteracting fragments $A$ and $B$ with Hamiltonians that commute and add, the composite system $A \\cdot B$ has product-form partition function $Z_{A \\cdot B} = Z_A Z_B$, implying size consistency via $\\phi_{A \\cdot B} = \\phi_A + \\phi_B$.\n\nYour task is to implement a program that, for each provided test case, does the following:\n- Given energies $\\{E_i^A\\}$ and degeneracies $\\{g_i^A\\}$ for fragment $A$, energies $\\{E_j^B\\}$ and degeneracies $\\{g_j^B\\}$ for fragment $B$, and an inverse temperature $\\beta$, compute:\n  1. $\\ln Z_A$ and $\\ln Z_B$ by numerically stabilizing the sum $\\sum_i g_i^A \\exp(-\\beta E_i^A)$ and $\\sum_j g_j^B \\exp(-\\beta E_j^B)$, respectively.\n  2. $\\ln Z_{A \\cdot B}$ by explicitly enumerating the composite spectrum with energies $\\{E_i^A + E_j^B\\}$ and degeneracies $\\{g_i^A g_j^B\\}$ and stabilizing the corresponding sum.\n  3. The dimensionless free energies $\\phi_A = -\\ln Z_A$, $\\phi_B = -\\ln Z_B$, and $\\phi_{A \\cdot B} = -\\ln Z_{A \\cdot B}$.\n  4. A boolean indicating whether the size-consistency condition holds within a numerical tolerance: $\\lvert \\phi_{A \\cdot B} - (\\phi_A + \\phi_B) \\rvert \\le \\epsilon$, with $\\epsilon = 10^{-12}$.\n- All energies are to be treated in arbitrary consistent units, and the outputs are the dimensionless free energies. Angles do not appear. No physical units are required in the output because $\\phi$ is dimensionless.\n\nUse the following test suite. Each test case is a tuple $(\\beta, \\{E_i^A\\}, \\{g_i^A\\}, \\{E_j^B\\}, \\{g_j^B\\})$:\n- Case $1$: $\\beta = 0.7$, $\\{E_i^A\\} = [0.0, 1.0, 2.0]$, $\\{g_i^A\\} = [1, 2, 1]$, $\\{E_j^B\\} = [0.0, 0.5]$, $\\{g_j^B\\} = [1, 3]$.\n- Case $2$ (high temperature limit): $\\beta = 10^{-6}$, $\\{E_i^A\\} = [0.0, 10.0, 20.0]$, $\\{g_i^A\\} = [1, 1, 1]$, $\\{E_j^B\\} = [0.0, 30.0]$, $\\{g_j^B\\} = [2, 1]$.\n- Case $3$ (low temperature limit with ground-state degeneracy): $\\beta = 100.0$, $\\{E_i^A\\} = [0.0, 0.01]$, $\\{g_i^A\\} = [2, 1]$, $\\{E_j^B\\} = [0.0, 0.02]$, $\\{g_j^B\\} = [3, 5]$.\n- Case $4$ (negative and positive levels, single-level partner): $\\beta = 2.3$, $\\{E_i^A\\} = [-0.5, 0.0, 0.5]$, $\\{g_i^A\\} = [1, 3, 2]$, $\\{E_j^B\\} = [1.23456]$, $\\{g_j^B\\} = [7]$.\n- Case $5$ (large energy offsets to test numerical stability): $\\beta = 0.4$, $\\{E_i^A\\} = [50.2, 51.9]$, $\\{g_i^A\\} = [4, 1]$, $\\{E_j^B\\} = [0.3, 0.9, 2.1]$, $\\{g_j^B\\} = [1, 2, 1]$.\n\nAlgorithmic requirements:\n- Implement a numerically stable computation of $\\ln Z$ using a log-sum-exp transformation: if $a_k = \\ln g_k - \\beta E_k$, then $\\ln Z = m + \\ln \\sum_k \\exp(a_k - m)$ with $m = \\max_k a_k$.\n- Use the composite energy-degeneracy enumeration for $A \\cdot B$ explicitly, i.e., enumerate all pairs $(i,j)$ to form energies $E_i^A + E_j^B$ and degeneracies $g_i^A g_j^B$. Do not compute $\\ln Z_{A \\cdot B}$ by simply adding $\\ln Z_A$ and $\\ln Z_B$, because the purpose is to validate this equality numerically.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, for example, $[ \\text{result1}, \\text{result2}, \\text{result3}, \\ldots ]$.\n- Each result is a boolean indicating whether $\\lvert \\phi_{A \\cdot B} - (\\phi_A + \\phi_B) \\rvert \\le 10^{-12}$ for the corresponding test case.",
            "solution": "We begin from the canonical ensemble definition for a discrete spectrum with degeneracies. For a system with energy levels $\\{E_i\\}$ and degeneracies $\\{g_i\\}$ at inverse temperature $\\beta \\equiv 1/(k_B T)$, the canonical partition function is\n$$\nZ = \\sum_{i} g_i \\exp(-\\beta E_i).\n$$\nThe Helmholtz free energy is $F = -k_B T \\ln Z$. The dimensionless Helmholtz free energy is defined by $\\phi \\equiv \\beta F = - \\ln Z$. Therefore, if we can compute $\\ln Z$ in a numerically stable way, then $\\phi = -\\ln Z$ follows directly.\n\nFor two noninteracting fragments $A$ and $B$, with Hamiltonian operators $\\hat{H}_A$ and $\\hat{H}_B$ that commute and add for the composite system, the energy levels of the composite system $A \\cdot B$ are all pairwise sums $E_{ij}^{A \\cdot B} = E_i^A + E_j^B$, and the corresponding degeneracies are products $g_{ij}^{A \\cdot B} = g_i^A g_j^B$. The partition function of the composite is then\n$$\nZ_{A \\cdot B} = \\sum_{i,j} g_i^A g_j^B \\exp\\!\\left(-\\beta (E_i^A + E_j^B)\\right) \n= \\left(\\sum_i g_i^A \\exp(-\\beta E_i^A)\\right)\\left(\\sum_j g_j^B \\exp(-\\beta E_j^B)\\right) = Z_A Z_B.\n$$\nTaking logarithms and using the definition of $\\phi$, we have\n$$\n\\phi_{A \\cdot B} = -\\ln Z_{A \\cdot B} = -\\ln(Z_A Z_B) = -\\ln Z_A - \\ln Z_B = \\phi_A + \\phi_B.\n$$\nThis additivity embodies size consistency and size extensivity in the thermodynamic, finite-temperature context: for noninteracting fragments, the free energy of the total system is the sum of the free energies of the fragments.\n\nAlgorithmic design:\n- Directly summing $\\sum_i g_i \\exp(-\\beta E_i)$ can suffer from underflow or overflow, especially for large $\\beta$ or large energy offsets. To ensure numerical stability, we use a log-sum-exp transformation. Define $a_i \\equiv \\ln g_i - \\beta E_i$. Then\n$$\n\\ln Z = \\ln \\sum_i \\exp(a_i) = m + \\ln \\sum_i \\exp(a_i - m),\n$$\nwhere $m \\equiv \\max_i a_i$. This shifts the exponentials so that the largest exponent is zero, keeping the sum within a numerically safe range.\n- For the composite system $A \\cdot B$, we explicitly enumerate all pairs $(i,j)$ to form the composite energies $E_{ij} = E_i^A + E_j^B$ and degeneracies $g_{ij} = g_i^A g_j^B$, then apply the same log-sum-exp method to compute $\\ln Z_{A \\cdot B}$. This avoids trivially enforcing the equality via $\\ln Z_{A \\cdot B} = \\ln Z_A + \\ln Z_B$ and instead validates it numerically.\n- Having computed $\\ln Z_A$, $\\ln Z_B$, and $\\ln Z_{A \\cdot B}$, we compute $\\phi_A = -\\ln Z_A$, $\\phi_B = -\\ln Z_B$, and $\\phi_{A \\cdot B} = -\\ln Z_{A \\cdot B}$, and test whether $\\lvert \\phi_{A \\cdot B} - (\\phi_A + \\phi_B) \\rvert \\le \\epsilon$ with $\\epsilon = 10^{-12}$.\n\nTest coverage rationale:\n- Case $1$ provides a general mixture of energies and degeneracies at a moderate $\\beta$ to test the general case.\n- Case $2$ uses a very small $\\beta$ (high temperature) so that many states contribute almost equally; this tests stability when exponentials are near unity.\n- Case $3$ uses a very large $\\beta$ (low temperature) to ensure ground states dominate and to test the role of degeneracies in the low-temperature limit.\n- Case $4$ includes negative energies and a single-level partner to test behavior with energy shifts and asymmetry in spectrum sizes.\n- Case $5$ includes large positive energy offsets to stress-test the log-sum-exp stabilization and avoid underflow in naive summation.\n\nThe program implements a function to compute $\\ln Z$ robustly and then applies it to the fragments $A$ and $B$ and to the composite system constructed by explicit enumeration. For each case, it outputs a boolean indicating whether the size-consistency condition holds within the prescribed numerical tolerance. The final output is a single line containing the list of booleans in the specified format.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef log_partition(energies, degeneracies, beta):\n    \"\"\"\n    Compute ln Z for a discrete spectrum using a numerically stable log-sum-exp.\n    energies: 1D array-like of energy levels E_i\n    degeneracies: 1D array-like of positive degeneracies g_i (integers)\n    beta: float inverse temperature\n    \"\"\"\n    E = np.array(energies, dtype=float).ravel()\n    g = np.array(degeneracies, dtype=float).ravel()\n    if E.size != g.size:\n        raise ValueError(\"Energies and degeneracies must have the same length.\")\n    if np.any(g <= 0):\n        raise ValueError(\"Degeneracies must be positive.\")\n    a = np.log(g) - beta * E\n    m = np.max(a)\n    # log-sum-exp\n    logZ = m + np.log(np.sum(np.exp(a - m)))\n    return logZ\n\ndef composite_spectrum(energies_A, degeneracies_A, energies_B, degeneracies_B):\n    \"\"\"\n    Enumerate composite spectrum energies and degeneracies for noninteracting A and B.\n    Returns flattened arrays of composite energies and degeneracies.\n    \"\"\"\n    E_A = np.array(energies_A, dtype=float).ravel()\n    g_A = np.array(degeneracies_A, dtype=float).ravel()\n    E_B = np.array(energies_B, dtype=float).ravel()\n    g_B = np.array(degeneracies_B, dtype=float).ravel()\n    # Pairwise sums via broadcasting\n    E_AB = (E_A[:, None] + E_B[None, :]).reshape(-1)\n    # Pairwise degeneracy products via outer product\n    g_AB = (g_A[:, None] * g_B[None, :]).reshape(-1)\n    return E_AB, g_AB\n\ndef dimensionless_free_energy_logZ(logZ):\n    \"\"\"\n    Convert ln Z to the dimensionless Helmholtz free energy phi = - ln Z.\n    \"\"\"\n    return -logZ\n\ndef validate_case(beta, E_A, g_A, E_B, g_B, tol=1e-12):\n    \"\"\"\n    For a single test case, compute phi_A, phi_B, phi_AB and check size consistency:\n    |phi_AB - (phi_A + phi_B)| <= tol\n    \"\"\"\n    # ln Z for A and B\n    lnZ_A = log_partition(E_A, g_A, beta)\n    lnZ_B = log_partition(E_B, g_B, beta)\n\n    # Composite by explicit enumeration\n    E_AB, g_AB = composite_spectrum(E_A, g_A, E_B, g_B)\n    lnZ_AB = log_partition(E_AB, g_AB, beta)\n\n    # Dimensionless Helmholtz free energies\n    phi_A = dimensionless_free_energy_logZ(lnZ_A)\n    phi_B = dimensionless_free_energy_logZ(lnZ_B)\n    phi_AB = dimensionless_free_energy_logZ(lnZ_AB)\n\n    diff = abs(phi_AB - (phi_A + phi_B))\n    return diff <= tol\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each case: (beta, energies_A, degeneracies_A, energies_B, degeneracies_B)\n    test_cases = [\n        (0.7, [0.0, 1.0, 2.0], [1, 2, 1], [0.0, 0.5], [1, 3]),\n        (1e-6, [0.0, 10.0, 20.0], [1, 1, 1], [0.0, 30.0], [2, 1]),\n        (100.0, [0.0, 0.01], [2, 1], [0.0, 0.02], [3, 5]),\n        (2.3, [-0.5, 0.0, 0.5], [1, 3, 2], [1.23456], [7]),\n        (0.4, [50.2, 51.9], [4, 1], [0.3, 0.9, 2.1], [1, 2, 1]),\n    ]\n\n    results = []\n    for case in test_cases:\n        beta, E_A, g_A, E_B, g_B = case\n        result = validate_case(beta, E_A, g_A, E_B, g_B, tol=1e-12)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```"
        },
        {
            "introduction": "We now advance to a powerful method for computing free energy differences, a central task in determining the relative stability of materials phases. This practice  explores the isothermal-isobaric (NPT) ensemble to calculate the change in Gibbs free energy, $G$, as a function of pressure. You will implement thermodynamic integration, a technique based on the relation $\\frac{\\partial G}{\\partial P} = \\langle V \\rangle$, and cross-validate the result against an exact analytical solution for a tractable model, a hallmark of rigorous computational science.",
            "id": "3489844",
            "problem": "You are tasked with constructing and validating two independent computational routes for the Gibbs free energy in the isothermal-isobaric (NPT) ensemble, using a mathematically well-defined toy model that allows analytic control. Work entirely in reduced, dimensionless units where the Boltzmann constant (k_B) is set to unity and all energies, pressures, and volumes are dimensionless. All final results must be reported as dimensionless numbers. Angles are not involved. Do not include any physical units.\n\nFundamental base and model assumptions:\n- The isothermal-isobaric (NPT) ensemble has the isothermal-isobaric partition function defined by\n$$\n\\Delta(\\beta,P) = \\int_{-\\infty}^{\\infty} dV \\, \\exp \\left( -\\beta \\left[ F(V) + P V \\right] \\right),\n$$\nwhere $\\beta = 1/(k_B T)$, $P$ is the pressure, and $F(V)$ is the Helmholtz free energy at fixed volume $V$ for a coarse-grained description of the material. We deliberately extend the integration to all real $V$ to enable Gaussian integration in the harmonic approximation; this is a standard tractable approximation for analytical benchmarking.\n- The Gibbs free energy is defined as\n$$\nG(P) = -\\frac{1}{\\beta} \\ln \\Delta(\\beta,P).\n$$\n- The ensemble-average of any observable $\\langle A \\rangle_{NPT}$ is obtained by averaging over the isothermal-isobaric ensemble with the measure implied by the above integrand.\n\nModel specification for $F(V)$:\n- Consider a single-parameter compressible material described by a quadratic Helmholtz free energy as a function of volume,\n$$\nF(V) = \\frac{k}{2} \\left( V - V_{\\mathrm{ref}} \\right)^2 - f\\, V,\n$$\nwith stiffness $k > 0$, reference volume $V_{\\mathrm{ref}}$, and a linear coupling $f$. All quantities are dimensionless, and $F(V)$ is measured in units of $k_B T$ if $\\beta = 1$.\n\nYour tasks:\n1) Principle-based derivation and algorithm design:\n- Starting from the above definitions, use first principles to establish the thermodynamic relationship between the derivative of the Gibbs free energy with respect to pressure and the isothermal-isobaric average volume at fixed temperature $T$ and fixed system size. Do not assume any shortcut relations not derivable from the stated definitions.\n- Using this relationship, design a numerical procedure to compute the Gibbs free energy difference between two pressures $P_0$ and $P$ by integrating the ensemble-averaged volume along a pressure path at fixed $\\beta$. The numerical procedure must use the composite Simpson rule on a uniform pressure grid of $N_{\\mathrm{grid}} = 1001$ points between $P_0$ and $P$ (inclusive). The integrand must be the ensemble-average volume evaluated at the corresponding pressure grid points, using the model specified above.\n- Independently, starting from the definition of $\\Delta(\\beta,P)$ above and the specified quadratic $F(V)$, derive a closed-form expression for $\\Delta(\\beta,P)$ and compute the Gibbs free energy difference between $P_0$ and $P$ using $G(P) = -\\beta^{-1} \\ln \\Delta(\\beta,P)$. Eliminate any pressure-independent normalization constant by forming the difference $G(P) - G(P_0)$.\n\n2) Cross-validation:\n- For each parameter set in the test suite below, compute the Gibbs free energy difference between $P_0$ and $P$ using both routes:\n  a) Thermodynamic integration along pressure via the ensemble-averaged volume and Simpsonâ€™s rule on the specified grid.\n  b) Direct evaluation from the analytic expression of the isothermal-isobaric partition function and $G(P) = -\\beta^{-1} \\ln \\Delta(\\beta,P)$, as derived from the model.\n- Compute, for each case, the absolute value of the difference between the two independently obtained Gibbs free energy differences. This is your reported scalar for each test case.\n\nTest suite (each test case is a tuple specifying $(\\beta, k, V_{\\mathrm{ref}}, f, P_0, P)$):\n- Case $1$: $(\\beta = 1.0, \\; k = 10.0, \\; V_{\\mathrm{ref}} = 2.0, \\; f = 0.3, \\; P_0 = 1.0, \\; P = 4.0)$.\n- Case $2$: $(\\beta = 1.2, \\; k = 5.0, \\; V_{\\mathrm{ref}} = 1.5, \\; f = -0.2, \\; P_0 = 2.5, \\; P = 2.5)$.\n- Case $3$: $(\\beta = 0.8, \\; k = 3.0, \\; V_{\\mathrm{ref}} = 1.0, \\; f = 0.0, \\; P_0 = 3.0, \\; P = 1.0)$.\n- Case $4$: $(\\beta = 2.0, \\; k = 50.0, \\; V_{\\mathrm{ref}} = 1.2, \\; f = 0.5, \\; P_0 = 0.1, \\; P = 10.0)$.\n\nNumerical and output requirements:\n- All computations must be carried out in dimensionless reduced units as specified above.\n- For the thermodynamic integration, use exactly $N_{\\mathrm{grid}} = 1001$ uniformly spaced pressure points between $P_0$ and $P$ (inclusive), and apply the composite Simpson rule.\n- Your program must produce a single line of output containing a Python-style list with the four floats corresponding to the absolute cross-validation differences for the four test cases, in order. Format each float to exactly $12$ digits after the decimal point. Example format: $[0.000000000000,0.123456789012, \\ldots]$.",
            "solution": "The problem statement is evaluated to be **valid**. It is scientifically grounded in the principles of statistical mechanics, specifically the isothermal-isobaric (NPT) ensemble. The model provided, a quadratic Helmholtz free energy, is a standard harmonic approximation used for creating analytically tractable theoretical benchmarks. The problem is well-posed, with all necessary parameters, definitions, and numerical procedures explicitly defined. It is objective and free of ambiguity. The tasks require the derivation and comparison of two distinct but thermodynamically equivalent computational routes for the Gibbs free energy difference, which represents a rigorous and meaningful exercise in computational science.\n\nHerein, we present the step-by-step derivation for both routes.\n\n### Route 1: Thermodynamic Integration of Ensemble-Averaged Volume\n\nThe first route computes the Gibbs free energy difference via thermodynamic integration. The fundamental relationship is derived from the definitions of the Gibbs free energy $G(P)$ and the NPT partition function $\\Delta(\\beta,P)$.\n\nThe Gibbs free energy is defined as:\n$$\nG(P) = -\\frac{1}{\\beta} \\ln \\Delta(\\beta,P)\n$$\nwhere $\\Delta(\\beta,P)$ is the isothermal-isobaric partition function:\n$$\n\\Delta(\\beta,P) = \\int_{-\\infty}^{\\infty} dV \\, \\exp \\left( -\\beta \\left[ F(V) + P V \\right] \\right)\n$$\nTo find the relationship between $G(P)$ and the ensemble-averaged volume $\\langle V \\rangle_{NPT}$, we differentiate $G(P)$ with respect to pressure $P$ at constant inverse temperature $\\beta$:\n$$\n\\frac{\\partial G}{\\partial P} = -\\frac{1}{\\beta} \\frac{1}{\\Delta(\\beta,P)} \\frac{\\partial \\Delta(\\beta,P)}{\\partial P}\n$$\nUsing Leibniz's rule to differentiate under the integral sign for $\\Delta(\\beta,P)$:\n$$\n\\frac{\\partial \\Delta(\\beta,P)}{\\partial P} = \\int_{-\\infty}^{\\infty} dV \\, \\frac{\\partial}{\\partial P} \\exp \\left( -\\beta \\left[ F(V) + P V \\right] \\right) = \\int_{-\\infty}^{\\infty} dV \\, (-\\beta V) \\exp \\left( -\\beta \\left[ F(V) + P V \\right] \\right)\n$$\n$$\n\\frac{\\partial \\Delta(\\beta,P)}{\\partial P} = -\\beta \\int_{-\\infty}^{\\infty} dV \\, V \\exp \\left( -\\beta \\left[ F(V) + P V \\right] \\right)\n$$\nSubstituting this into the expression for $\\frac{\\partial G}{\\partial P}$:\n$$\n\\frac{\\partial G}{\\partial P} = -\\frac{1}{\\beta} \\frac{1}{\\Delta(\\beta,P)} \\left( -\\beta \\int_{-\\infty}^{\\infty} dV \\, V \\exp \\left( -\\beta \\left[ F(V) + P V \\right] \\right) \\right)\n$$\n$$\n\\frac{\\partial G}{\\partial P} = \\frac{\\int_{-\\infty}^{\\infty} dV \\, V \\exp \\left( -\\beta \\left[ F(V) + P V \\right] \\right)}{\\int_{-\\infty}^{\\infty} dV \\, \\exp \\left( -\\beta \\left[ F(V) + P V \\right] \\right)}\n$$\nThe right-hand side is the definition of the ensemble average of the volume, $\\langle V \\rangle_{NPT}$. Thus, we have the thermodynamic relation:\n$$\n\\frac{\\partial G}{\\partial P} = \\langle V \\rangle_{NPT}\n$$\nIntegrating this from a reference pressure $P_0$ to a final pressure $P$ yields the Gibbs free energy difference:\n$$\nG(P) - G(P_0) = \\int_{P_0}^{P} \\langle V \\rangle_{NPT}(P') dP'\n$$\nFor the specified model $F(V) = \\frac{k}{2} (V - V_{\\mathrm{ref}})^2 - fV$, the argument of the exponent in the NPT probability distribution is $-\\beta \\phi(V)$, where $\\phi(V) = F(V) + PV$.\n$$\n\\phi(V) = \\frac{k}{2}V^2 - (k V_{\\mathrm{ref}} + f - P)V + \\frac{k}{2}V_{\\mathrm{ref}}^2\n$$\nSince this is a quadratic function of $V$ with a positive leading coefficient (as $k>0$), the NPT probability distribution for volume is a Gaussian. The ensemble average $\\langle V \\rangle_{NPT}$ corresponds to the value of $V$ that minimizes $\\phi(V)$. This is found by setting the derivative to zero:\n$$\n\\frac{d\\phi}{dV} = kV - (k V_{\\mathrm{ref}} + f - P) = 0\n$$\nSolving for $V$ gives the ensemble-averaged volume as a function of pressure:\n$$\n\\langle V \\rangle_{NPT}(P) = \\frac{k V_{\\mathrm{ref}} + f - P}{k} = V_{\\mathrm{ref}} + \\frac{f - P}{k}\n$$\nThe Gibbs free energy difference $\\Delta G_{\\text{TI}} = G(P) - G(P_0)$ is then computed by numerically integrating this expression for $\\langle V \\rangle_{NPT}(P')$ from $P_0$ to $P$ using the composite Simpson's rule over a uniform grid of $N_{\\mathrm{grid}} = 1001$ pressure points.\n\n### Route 2: Analytic Evaluation of Partition Function\n\nThe second route involves deriving a closed-form expression for the Gibbs free energy difference directly from the partition function. We start with the expression for $\\Delta(\\beta,P)$ and the quadratic form of $\\phi(V)$. By completing the square for $\\phi(V)$, we can evaluate the integral analytically.\nLet $\\bar{V}(P) = V_{\\mathrm{ref}} + \\frac{f - P}{k}$, which is the value of $V$ that minimizes $\\phi(V)$. We rewrite $\\phi(V)$ as:\n$$\n\\phi(V) = \\frac{k}{2}(V - \\bar{V}(P))^2 + \\phi_{min}(P)\n$$\nwhere $\\phi_{min}(P)$ is the minimum value of $\\phi(V)$, evaluated at $\\bar{V}(P)$:\n$$\n\\phi_{min}(P) = \\frac{k}{2}(\\bar{V} - V_{\\mathrm{ref}})^2 - f\\bar{V} + P\\bar{V} = \\frac{k}{2}\\left(\\frac{f-P}{k}\\right)^2 - (f-P)\\left(V_{\\mathrm{ref}} + \\frac{f-P}{k}\\right)\n$$\n$$\n\\phi_{min}(P) = \\frac{(f-P)^2}{2k} - V_{\\mathrm{ref}}(f-P) - \\frac{(f-P)^2}{k} = -V_{\\mathrm{ref}}(f-P) - \\frac{(f-P)^2}{2k}\n$$\nThe partition function becomes:\n$$\n\\Delta(\\beta,P) = \\int_{-\\infty}^{\\infty} dV \\, \\exp\\left(-\\beta\\left[\\frac{k}{2}(V - \\bar{V})^2 + \\phi_{min}(P)\\right]\\right) = \\exp(-\\beta \\phi_{min}(P)) \\int_{-\\infty}^{\\infty} dV \\, \\exp\\left(-\\frac{\\beta k}{2}(V - \\bar{V})^2\\right)\n$$\nThe integral is a standard Gaussian integral with the value $\\sqrt{\\frac{2\\pi}{\\beta k}}$.\n$$\n\\Delta(\\beta,P) = \\sqrt{\\frac{2\\pi}{\\beta k}} \\exp(-\\beta \\phi_{min}(P))\n$$\nThe Gibbs free energy is then:\n$$\nG(P) = -\\frac{1}{\\beta}\\ln\\Delta(\\beta,P) = -\\frac{1}{\\beta}\\left[ \\frac{1}{2}\\ln\\left(\\frac{2\\pi}{\\beta k}\\right) - \\beta \\phi_{min}(P) \\right] = -\\frac{1}{2\\beta}\\ln\\left(\\frac{2\\pi}{\\beta k}\\right) + \\phi_{min}(P)\n$$\nThe Gibbs free energy difference between $P$ and $P_0$ is:\n$$\n\\Delta G_{\\text{analytic}} = G(P) - G(P_0) = \\left( C + \\phi_{min}(P) \\right) - \\left( C + \\phi_{min}(P_0) \\right) = \\phi_{min}(P) - \\phi_{min}(P_0)\n$$\nwhere $C = -\\frac{1}{2\\beta}\\ln\\left(\\frac{2\\pi}{\\beta k}\\right)$ is a pressure-independent constant that cancels out.\nSubstituting the expression for $\\phi_{min}(P)$:\n$$\n\\Delta G_{\\text{analytic}} = \\left(-V_{\\mathrm{ref}}(f-P) - \\frac{(f-P)^2}{2k}\\right) - \\left(-V_{\\mathrm{ref}}(f-P_0) - \\frac{(f-P_0)^2}{2k}\\right)\n$$\n$$\n\\Delta G_{\\text{analytic}} = V_{\\mathrm{ref}}(P-P_0) - \\frac{1}{2k}\\left[(f-P)^2 - (f-P_0)^2\\right]\n$$\nThis expression can be expanded to $V_{\\mathrm{ref}}(P-P_0) + \\frac{f}{k}(P-P_0) - \\frac{1}{2k}(P^2-P_0^2)$, which is identical to the analytical integral of $\\langle V \\rangle_{NPT}(P')$ from Route 1.\n\n### Cross-Validation\n\nThe analytic expression for $\\langle V \\rangle_{NPT}(P)$ is a linear function of pressure. The composite Simpson's rule is known to be exact for polynomials of degree up to $3$. Therefore, the numerical integration in Route 1 should yield a result that is identical to the analytic evaluation from Route 2, up to the limits of floating-point precision. The cross-validation task thus becomes a check on the numerical accuracy of the implementation. The absolute difference between the two methods is expected to be virtually zero for all test cases.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import integrate\n\ndef solve():\n    \"\"\"\n    Computes the Gibbs free energy difference G(P) - G(P0) for a toy model\n    using two independent routes and reports the absolute difference between them.\n    Route 1: Thermodynamic integration via Simpson's rule.\n    Route 2: Direct evaluation from the analytic partition function.\n    \"\"\"\n\n    # Test suite: (beta, k, V_ref, f, P0, P)\n    test_cases = [\n        (1.0, 10.0, 2.0, 0.3, 1.0, 4.0),\n        (1.2, 5.0, 1.5, -0.2, 2.5, 2.5),\n        (0.8, 3.0, 1.0, 0.0, 3.0, 1.0),\n        (2.0, 50.0, 1.2, 0.5, 0.1, 10.0),\n    ]\n\n    cross_validation_differences = []\n    \n    # Number of points for Simpson's rule, as specified in the problem\n    N_grid = 1001\n\n    for case in test_cases:\n        beta, k, V_ref, f, P0, P = case\n\n        # --- Route 1: Thermodynamic Integration via Simpson's Rule ---\n        # The integrand is the ensemble-average volume <V>_NPT(P').\n        # For the given quadratic model, <V>(P') = V_ref + (f - P') / k.\n        \n        # Handle the trivial case to avoid division by zero range in linspace.\n        if P == P0:\n            delta_G_ti = 0.0\n        else:\n            # Create the uniform pressure grid for integration\n            pressure_grid = np.linspace(P0, P, N_grid)\n            \n            # Evaluate the integrand <V>(P') on the grid\n            avg_volume_grid = V_ref + (f - pressure_grid) / k\n            \n            # Perform numerical integration using the composite Simpson's rule\n            delta_G_ti = integrate.simpson(avg_volume_grid, x=pressure_grid)\n\n        # --- Route 2: Analytic Evaluation ---\n        # The Gibbs free energy difference is G(P) - G(P0) = phi_min(P) - phi_min(P0),\n        # where phi_min(P) = -V_ref*(f-P) - (f-P)**2 / (2*k).\n        # This simplifies to: V_ref*(P-P0) + (f/k)*(P-P0) - (1/(2*k))*(P**2 - P0**2)\n        \n        term1 = V_ref * (P - P0)\n        term2 = (f / k) * (P - P0)\n        term3 = (1.0 / (2.0 * k)) * (P**2 - P0**2)\n        \n        delta_G_analytic = term1 + term2 - term3\n\n        # --- Cross-Validation ---\n        # Compute the absolute difference between the two routes.\n        # This is expected to be zero to machine precision, as Simpson's rule\n        # is exact for polynomials of degree <= 3, and our integrand is linear.\n        difference = abs(delta_G_ti - delta_G_analytic)\n        cross_validation_differences.append(difference)\n\n    # Final print statement in the exact required format.\n    # Each float is formatted to exactly 12 digits after the decimal point.\n    output_str = f\"[{','.join(f'{d:.12f}' for d in cross_validation_differences)}]\"\n    print(output_str)\n\nsolve()\n```"
        }
    ]
}