{
    "hands_on_practices": [
        {
            "introduction": "Understanding the vibrational modes of a crystal, known as phonons, is fundamental to predicting material properties like thermal conductivity and specific heat. This first exercise provides a cornerstone derivation using the Lagrangian formalism. By modeling a one-dimensional diatomic crystal, you will apply the Euler-Lagrange equations to derive the phonon dispersion relation from first principles, revealing the physical origins of the distinct acoustic and optical branches found in many materials . This practice solidifies the connection between abstract analytical mechanics and tangible solid-state phenomena.",
            "id": "3432860",
            "problem": "Consider a one-dimensional centrosymmetric diatomic chain that models longitudinal lattice vibrations in an ionic crystal relevant to computational materials science. The chain consists of a periodic alternation of two atom types with masses $m_{1}$ and $m_{2}$, respectively. Nearest neighbors are coupled by identical harmonic springs of stiffness $K$. The equilibrium spacing between adjacent atoms is $a/2$, so the primitive unit cell of length $a$ contains two atoms. Let $u_{n}(t)$ denote the small longitudinal displacement of the mass $m_{1}$ in unit cell $n$ from its equilibrium position, and let $v_{n}(t)$ denote the corresponding displacement of the mass $m_{2}$ in the same cell.\n\nUsing the Lagrangian formalism for small oscillations and assuming only nearest-neighbor harmonic interactions, derive the linear equations of motion for $u_{n}(t)$ and $v_{n}(t)$ and obtain the dispersion relations by seeking normal-mode solutions with Bloch form characterized by wave number $k$ in the first Brillouin zone $[-\\pi/a,\\pi/a]$. Identify the acoustic and optical branches from first principles. In your reasoning, start from the fundamental definition of the Lagrangian $L = T - V$ for this chain, write down the kinetic and potential energies in terms of $\\{u_{n},v_{n}\\}$, and apply the Euler–Lagrange equations to obtain the eigenvalue problem that yields the dispersion relations. Briefly justify which sign corresponds to the acoustic versus optical branch by examining the long-wavelength limit and comment on the behavior at the Brillouin zone center $k=0$ and boundary $k=\\pi/a$.\n\nProvide as your final answer the two analytic dispersion relations $\\omega_{\\mathrm{ac}}(k)$ and $\\omega_{\\mathrm{op}}(k)$ as explicit closed-form expressions in terms of $k$, $a$, $m_{1}$, $m_{2}$, and $K$. Express your final result as two functions of $k$ without any units. No numerical evaluation is required.",
            "solution": "The user wants me to solve a classic solid-state physics problem: deriving the dispersion relation for a 1D diatomic lattice.\n\nHere's my plan:\n1.  **Validate the problem:**\n    *   **Step 1: Extract Givens:** I'll list all the provided parameters and definitions:\n        *   1D centrosymmetric diatomic chain.\n        *   Masses: $m_1$ and $m_2$.\n        *   Nearest-neighbor coupling: harmonic springs with stiffness $K$.\n        *   Equilibrium spacing: $a/2$.\n        *   Primitive unit cell length: $a$.\n        *   Displacement of mass $m_1$ in cell $n$: $u_n(t)$.\n        *   Displacement of mass $m_2$ in cell $n$: $v_n(t)$.\n        *   Task: Use Lagrangian formalism ($L=T-V$) to find equations of motion.\n        *   Task: Seek normal-mode solutions (Bloch form) with wave number $k$ in the first Brillouin zone $[-\\pi/a, \\pi/a]$.\n        *   Task: Derive dispersion relations $\\omega(k)$.\n        *   Task: Identify acoustic and optical branches.\n        *   Task: Justify by examining the long-wavelength limit ($k \\to 0$) and behavior at $k=0$ and $k=\\pi/a$.\n        *   Final Answer: Explicit closed-form expressions for $\\omega_{\\mathrm{ac}}(k)$ and $\\omega_{\\mathrm{op}}(k)$.\n\n    *   **Step 2: Validate:** I need to check the problem against my validation criteria.\n        *   **Scientifically Grounded:** Yes, this is a standard, fundamental problem in solid-state physics and materials science. It's a textbook example of lattice dynamics.\n        *   **Well-Posed:** Yes, the problem is clearly defined. It specifies the model, the method (Lagrangian), and the desired output. A unique solution exists.\n        *   **Objective:** Yes, the language is precise and technical. No subjective elements.\n        *   **Other Flaws:**\n            *   **Scientific Unsoundness:** None. The model is a well-established physical approximation.\n            *   **Non-Formalizable/Irrelevant:** The problem is highly formalizable and directly relevant to the stated topic of analytical mechanics in computational materials science.\n            *   **Incomplete/Contradictory:** The setup is complete. All necessary parameters ($m_1, m_2, K, a$) and variables ($u_n, v_n$) are defined.\n            *   **Unrealistic/Infeasible:** The model is an idealization, but it's a standard and physically meaningful one.\n            *   **Ill-Posed/Poorly Structured:** The structure is clear and leads to a unique solution.\n            *   **Pseudo-Profound/Trivial:** This is a non-trivial, canonical problem that requires a solid understanding of mechanics and wave physics.\n            *   **Outside Verifiability:** The results are standard and verifiable.\n\n    *   **Step 3: Verdict:** The problem is **Valid**. I will proceed to the solution.\n\n2.  **Solve the problem:**\n    *   **Step 1: Define the system and coordinates.**\n        *   The atoms are located at equilibrium positions.\n        *   In cell $n$, mass $m_1$ is at $x_{n,1}^{(0)} = na$.\n        *   In cell $n$, mass $m_2$ is at $x_{n,2}^{(0)} = na + a/2$.\n        *   The displacements are $u_n(t)$ for $m_1$ in cell $n$ and $v_n(t)$ for $m_2$ in cell $n$.\n        *   The actual positions are:\n            *   $x_{n,1}(t) = na + u_n(t)$\n            *   $x_{n,2}(t) = na + a/2 + v_n(t)$\n\n    *   **Step 2: Write the Lagrangian $L = T - V$.**\n        *   **Kinetic Energy (T):** Sum of the kinetic energies of all atoms in the chain. We can consider the kinetic energy per unit cell and then sum over all $n$.\n            *   $T = \\sum_n \\left( \\frac{1}{2} m_1 \\dot{u}_n^2 + \\frac{1}{2} m_2 \\dot{v}_n^2 \\right)$\n        *   **Potential Energy (V):** Sum of the potential energies stored in the springs. Each spring connects two adjacent atoms. We need to be careful with the indexing.\n            *   Let's consider the springs *within* and *between* unit cells.\n            *   The spring between mass $m_2$ of cell $n-1$ and mass $m_1$ of cell $n$.\n                *   Equilibrium position of $m_2$ in cell $n-1$: $(n-1)a + a/2$.\n                *   Equilibrium position of $m_1$ in cell $n$: $na$.\n                *   Equilibrium separation: $na - ((n-1)a + a/2) = a/2$.\n                *   Actual position of $m_2$ in cell $n-1$: $(n-1)a + a/2 + v_{n-1}$.\n                *   Actual position of $m_1$ in cell $n$: $na + u_n$.\n                *   Stretching of this spring: $(na + u_n) - ((n-1)a + a/2 + v_{n-1}) - a/2 = u_n - v_{n-1}$.\n                *   Potential energy: $\\frac{1}{2} K (u_n - v_{n-1})^2$.\n            *   The spring between mass $m_1$ of cell $n$ and mass $m_2$ of cell $n$.\n                *   Equilibrium separation: $a/2$.\n                *   Actual positions: $na + u_n$ and $na + a/2 + v_n$.\n                *   Stretching of this spring: $(na + a/2 + v_n) - (na + u_n) - a/2 = v_n - u_n$.\n                *   Potential energy: $\\frac{1}{2} K (v_n - u_n)^2$.\n            *   Total potential energy is the sum over all such springs. Let's sum over the two springs associated with cell $n$.\n            *   $V = \\sum_n \\left( \\frac{1}{2} K (v_n - u_n)^2 + \\frac{1}{2} K (u_n - v_{n-1})^2 \\right)$. Wait, if I sum this, I double count. Let's be more precise. Let's sum over the springs.\n            *   $V = \\sum_n \\left( \\frac{1}{2} K (v_n - u_n)^2 + \\frac{1}{2} K (u_{n+1} - v_n)^2 \\right)$. This is a better way to write it. The two springs connected to mass $v_n$ are to its left (with $u_n$) and to its right (with $u_{n+1}$).\n            *   So, $V = \\frac{1}{2} K \\sum_n \\left( (v_n - u_n)^2 + (u_{n+1} - v_n)^2 \\right)$. This looks correct. It's the sum of potential energies of all springs in the chain.\n\n        *   **Lagrangian (L):**\n            *   $L = T - V = \\sum_n \\left[ \\frac{1}{2} m_1 \\dot{u}_n^2 + \\frac{1}{2} m_2 \\dot{v}_n^2 - \\frac{1}{2} K (v_n - u_n)^2 - \\frac{1}{2} K (u_{n+1} - v_n)^2 \\right]$.\n\n    *   **Step 3: Apply the Euler-Lagrange equations.**\n        *   The equations are:\n            *   $\\frac{d}{dt} \\left( \\frac{\\partial L}{\\partial \\dot{u}_n} \\right) - \\frac{\\partial L}{\\partial u_n} = 0$\n            *   $\\frac{d}{dt} \\left( \\frac{\\partial L}{\\partial \\dot{v}_n} \\right) - \\frac{\\partial L}{\\partial v_n} = 0$\n\n        *   **For $u_n$:**\n            *   $\\frac{\\partial L}{\\partial \\dot{u}_n} = m_1 \\dot{u}_n$\n            *   $\\frac{d}{dt} \\left( \\frac{\\partial L}{\\partial \\dot{u}_n} \\right) = m_1 \\ddot{u}_n$\n            *   $\\frac{\\partial L}{\\partial u_n}$ comes from three terms in the sum for $V$. The term with $(v_n - u_n)^2$, the term with $(u_n - v_{n-1})^2$. Let's use my second form of V: $V = \\frac{1}{2} K \\sum_j \\left( (v_j - u_j)^2 + (u_{j+1} - v_j)^2 \\right)$.\n            *   The terms in $L$ containing $u_n$ are: $-\\frac{1}{2}K(v_n-u_n)^2$ and $-\\frac{1}{2}K(u_n - v_{n-1})^2$. The second term comes from the $j=n-1$ term in the sum for V, which contains $(u_{n} - v_{n-1})^2$.\n            *   $\\frac{\\partial L}{\\partial u_n} = - \\frac{1}{2} K \\frac{\\partial}{\\partial u_n} (v_n - u_n)^2 - \\frac{1}{2} K \\frac{\\partial}{\\partial u_n} (u_n - v_{n-1})^2$\n            *   $\\frac{\\partial L}{\\partial u_n} = -K(v_n - u_n)(-1) - K(u_n - v_{n-1})(1) = K(v_n - u_n) - K(u_n - v_{n-1}) = K(v_n + v_{n-1} - 2u_n)$.\n            *   So, the first equation of motion is: $m_1 \\ddot{u}_n = K (v_n + v_{n-1} - 2u_n)$.\n\n        *   **For $v_n$:**\n            *   $\\frac{\\partial L}{\\partial \\dot{v}_n} = m_2 \\dot{v}_n$\n            *   $\\frac{d}{dt} \\left( \\frac{\\partial L}{\\partial \\dot{v}_n} \\right) = m_2 \\ddot{v}_n$\n            *   The terms in $L$ containing $v_n$ are: $-\\frac{1}{2}K(v_n-u_n)^2$ and $-\\frac{1}{2}K(u_{n+1} - v_n)^2$.\n            *   $\\frac{\\partial L}{\\partial v_n} = - \\frac{1}{2} K \\frac{\\partial}{\\partial v_n} (v_n - u_n)^2 - \\frac{1}{2} K \\frac{\\partial}{\\partial v_n} (u_{n+1} - v_n)^2$\n            *   $\\frac{\\partial L}{\\partial v_n} = -K(v_n - u_n)(1) - K(u_{n+1} - v_n)(-1) = -K(v_n - u_n) + K(u_{n+1} - v_n) = K(u_n + u_{n+1} - 2v_n)$.\n            *   So, the second equation of motion is: $m_2 \\ddot{v}_n = K (u_{n+1} + u_n - 2v_n)$.\n\n        *   Equations of Motion:\n            *   $m_1 \\ddot{u}_n = K(v_n + v_{n-1} - 2u_n)$\n            *   $m_2 \\ddot{v}_n = K(u_{n+1} + u_n - 2v_n)$\n        *   This seems correct. This is the coupled system of differential-difference equations.\n\n    *   **Step 4: Seek normal-mode solutions.**\n        *   We assume a plane wave solution (Bloch form) due to the periodicity of the lattice. The displacements in cell $n$ are related to those in cell $0$ by a phase factor. The equilibrium position of cell $n$ is $na$.\n        *   $u_n(t) = U \\exp[i(k(na) - \\omega t)]$\n        *   $v_n(t) = V \\exp[i(k(na+a/2) - \\omega t)]$. No, the problem statement defines $u_n$ and $v_n$ as belonging to the *same* unit cell $n$. The phase should depend on the cell index.\n        *   Correct form of ansatz:\n            *   $u_n(t) = U \\exp[i(kna - \\omega t)]$\n            *   $v_n(t) = V \\exp[i(kna - \\omega t)]$\n            *   $U$ and $V$ are the complex amplitudes for the two atoms in the unit cell. The position dependence is correctly captured by the cell index $n$.\n\n        *   Let's calculate the time derivatives and the shifted terms:\n            *   $\\ddot{u}_n = -\\omega^2 u_n = -\\omega^2 U \\exp[i(kna - \\omega t)]$\n            *   $\\ddot{v}_n = -\\omega^2 v_n = -\\omega^2 V \\exp[i(kna - \\omega t)]$\n            *   $v_{n-1} = V \\exp[i(k(n-1)a - \\omega t)] = V \\exp[i(kna - \\omega t)] \\exp[-ika] = v_n \\exp[-ika]$.\n            *   $u_{n+1} = U \\exp[i(k(n+1)a - \\omega t)] = U \\exp[i(kna - \\omega t)] \\exp[ika] = u_n \\exp[ika]$.\n\n        *   Substitute these into the equations of motion:\n            *   $-m_1 \\omega^2 U \\exp[i(kna - \\omega t)] = K(V \\exp[i(kna - \\omega t)] + V \\exp[i(kna - \\omega t)]\\exp[-ika] - 2U \\exp[i(kna - \\omega t)])$\n            *   $-m_2 \\omega^2 V \\exp[i(kna - \\omega t)] = K(U \\exp[i(kna - \\omega t)]\\exp[ika] + U \\exp[i(kna - \\omega t)] - 2V \\exp[i(kna - \\omega t)])$\n\n        *   Cancel the common factor $\\exp[i(kna - \\omega t)]$ on both sides:\n            *   $-m_1 \\omega^2 U = K(V (1 + \\exp[-ika]) - 2U)$\n            *   $-m_2 \\omega^2 V = K(U (1 + \\exp[ika]) - 2V)$\n\n        *   Rearrange into a matrix equation for the amplitudes $(U, V)$:\n            *   $(2K - m_1 \\omega^2) U - K(1 + \\exp[-ika]) V = 0$\n            *   $-K(1 + \\exp[ika]) U + (2K - m_2 \\omega^2) V = 0$\n\n        *   This is a homogeneous linear system of the form $M \\begin{pmatrix} U \\\\ V \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ 0 \\end{pmatrix}$. For a non-trivial solution $(U, V) \\neq (0, 0)$, the determinant of the coefficient matrix must be zero.\n        *   $\\det \\begin{pmatrix} 2K - m_1 \\omega^2  -K(1 + \\exp[-ika]) \\\\ -K(1 + \\exp[ika])  2K - m_2 \\omega^2 \\end{pmatrix} = 0$\n\n    *   **Step 5: Solve the determinant equation (secular equation).**\n        *   $(2K - m_1 \\omega^2)(2K - m_2 \\omega^2) - K^2(1 + \\exp[-ika])(1 + \\exp[ika]) = 0$\n        *   Let's expand the terms:\n            *   The second term is $K^2 (1 + \\exp[ika] + \\exp[-ika] + \\exp[ika]\\exp[-ika])$.\n            *   Using $\\exp[ika] + \\exp[-ika] = 2\\cos(ka)$, this becomes $K^2 (1 + 2\\cos(ka) + 1) = K^2(2 + 2\\cos(ka)) = 2K^2(1 + \\cos(ka))$.\n            *   Using the half-angle identity $1 + \\cos(2\\theta) = 2\\cos^2(\\theta)$, we have $1 + \\cos(ka) = 2\\cos^2(ka/2)$.\n            *   So, the term is $2K^2(2\\cos^2(ka/2)) = 4K^2\\cos^2(ka/2)$.\n            *   Aha, maybe let's check the product directly: $(1 + \\exp[-ika])(1 + \\exp[ika]) = |\\exp[-ika/2](\\exp[ika/2] + \\exp[-ika/2])|^2 = |\\exp[-ika/2](2\\cos(ka/2))|^2 = (2\\cos(ka/2))^2 = 4\\cos^2(ka/2)$. This simplifies things.\n            *   Wait, $(1+e^{-i\\theta})(1+e^{i\\theta}) = 1+e^{i\\theta}+e^{-i\\theta}+1 = 2+2\\cos\\theta$.\n            *   $2+2\\cos(ka) = 2(1+\\cos(ka)) = 2(2\\cos^2(ka/2)) = 4\\cos^2(ka/2)$. Yes, this is correct.\n\n        *   The secular equation is:\n            *   $(2K - m_1 \\omega^2)(2K - m_2 \\omega^2) - 4K^2 \\cos^2(ka/2) = 0$\n\n        *   Expand the first part:\n            *   $4K^2 - 2K(m_1+m_2)\\omega^2 + m_1 m_2 \\omega^4 - 4K^2 \\cos^2(ka/2) = 0$\n\n        *   Rearrange as a quadratic equation in $\\omega^2$:\n            *   $m_1 m_2 (\\omega^2)^2 - 2K(m_1+m_2)\\omega^2 + 4K^2 - 4K^2 \\cos^2(ka/2) = 0$\n            *   $m_1 m_2 (\\omega^2)^2 - 2K(m_1+m_2)\\omega^2 + 4K^2 (1 - \\cos^2(ka/2)) = 0$\n            *   Using $1 - \\cos^2(x) = \\sin^2(x)$:\n            *   $m_1 m_2 (\\omega^2)^2 - 2K(m_1+m_2)\\omega^2 + 4K^2 \\sin^2(ka/2) = 0$\n\n        *   Let $x = \\omega^2$. The equation is $Ax^2 + Bx + C = 0$ with:\n            *   $A = m_1 m_2$\n            *   $B = -2K(m_1+m_2)$\n            *   $C = 4K^2 \\sin^2(ka/2)$\n\n        *   The solutions are $x = \\frac{-B \\pm \\sqrt{B^2 - 4AC}}{2A}$:\n            *   $\\omega^2 = \\frac{2K(m_1+m_2) \\pm \\sqrt{(-2K(m_1+m_2))^2 - 4(m_1 m_2)(4K^2 \\sin^2(ka/2))}}{2 m_1 m_2}$\n            *   $\\omega^2 = \\frac{2K(m_1+m_2) \\pm \\sqrt{4K^2(m_1+m_2)^2 - 16 K^2 m_1 m_2 \\sin^2(ka/2)}}{2 m_1 m_2}$\n            *   Factor out $4K^2$ from the square root:\n            *   $\\omega^2 = \\frac{2K(m_1+m_2) \\pm 2K \\sqrt{(m_1+m_2)^2 - 4 m_1 m_2 \\sin^2(ka/2)}}{2 m_1 m_2}$\n            *   $\\omega^2 = \\frac{K(m_1+m_2) \\pm K \\sqrt{m_1^2 + 2m_1m_2 + m_2^2 - 4 m_1 m_2 \\sin^2(ka/2)}}{m_1 m_2}$\n            *   This is one form of the solution. Let's try to simplify the term under the square root. It doesn't look like it simplifies further in a nice way.\n            *   Let's check with a known form. The usual form is $\\omega^2 = K( \\frac{1}{m_1} + \\frac{1}{m_2} ) \\pm K \\sqrt{ ( \\frac{1}{m_1} + \\frac{1}{m_2} )^2 - \\frac{4\\sin^2(ka/2)}{m_1 m_2} }$.\n            *   Let me divide my expression by $m_1 m_2$:\n            *   $\\omega^2 = \\frac{K(m_1+m_2)}{m_1 m_2} \\pm \\frac{K}{m_1 m_2} \\sqrt{(m_1+m_2)^2 - 4 m_1 m_2 \\sin^2(ka/2)}$\n            *   $\\omega^2 = K(\\frac{1}{m_2} + \\frac{1}{m_1}) \\pm K \\sqrt{\\frac{(m_1+m_2)^2}{(m_1 m_2)^2} - \\frac{4 m_1 m_2 \\sin^2(ka/2)}{(m_1 m_2)^2}}$\n            *   $\\omega^2 = K(\\frac{1}{m_1} + \\frac{1}{m_2}) \\pm K \\sqrt{(\\frac{m_1+m_2}{m_1 m_2})^2 - \\frac{4 \\sin^2(ka/2)}{m_1 m_2}}$\n            *   $\\omega^2 = K(\\frac{1}{m_1} + \\frac{1}{m_2}) \\pm K \\sqrt{(\\frac{1}{m_1} + \\frac{1}{m_2})^2 - \\frac{4 \\sin^2(ka/2)}{m_1 m_2}}$\n            *   This matches the standard form. The derivation is correct.\n\n    *   **Step 6: Identify acoustic and optical branches.**\n        *   The two solutions correspond to the plus and minus signs in the expression for $\\omega^2$.\n        *   Let's analyze the long-wavelength limit, i.e., $k \\to 0$. In this limit, $\\sin(ka/2) \\approx ka/2$.\n        *   The term $\\frac{4 \\sin^2(ka/2)}{m_1 m_2} \\approx \\frac{4 (ka/2)^2}{m_1 m_2} = \\frac{k^2 a^2}{m_1 m_2}$. This term is small.\n        *   The expression becomes: $\\omega^2 \\approx K(\\frac{1}{m_1} + \\frac{1}{m_2}) \\pm K \\sqrt{(\\frac{1}{m_1} + \\frac{1}{m_2})^2 - \\frac{k^2 a^2}{m_1 m_2}}$.\n        *   Let's use the approximation $\\sqrt{A^2 - \\epsilon} = A \\sqrt{1 - \\epsilon/A^2} \\approx A(1 - \\epsilon/(2A^2)) = A - \\epsilon/(2A)$.\n        *   Here $A = (\\frac{1}{m_1} + \\frac{1}{m_2})$ and $\\epsilon = \\frac{k^2 a^2}{m_1 m_2}$.\n        *   So, $\\sqrt{(\\frac{1}{m_1} + \\frac{1}{m_2})^2 - \\frac{k^2 a^2}{m_1 m_2}} \\approx (\\frac{1}{m_1} + \\frac{1}{m_2}) - \\frac{k^2 a^2 / (m_1 m_2)}{2(\\frac{1}{m_1} + \\frac{1}{m_2})}$.\n\n        *   **Case 1: Plus sign (Optical branch)**\n            *   $\\omega^2_{\\mathrm{op}} \\approx K(\\frac{1}{m_1} + \\frac{1}{m_2}) + K \\left[ (\\frac{1}{m_1} + \\frac{1}{m_2}) - \\dots \\right]$.\n            *   Let's evaluate it at exactly $k=0$. Then $\\sin(ka/2) = 0$.\n            *   $\\omega^2(k=0) = K(\\frac{1}{m_1} + \\frac{1}{m_2}) \\pm K \\sqrt{(\\frac{1}{m_1} + \\frac{1}{m_2})^2} = K(\\frac{1}{m_1} + \\frac{1}{m_2}) \\pm K(\\frac{1}{m_1} + \\frac{1}{m_2})$.\n            *   Plus sign: $\\omega^2_{\\mathrm{op}}(k=0) = 2K(\\frac{1}{m_1} + \\frac{1}{m_2}) = 2K \\frac{m_1+m_2}{m_1 m_2}$. This is a non-zero frequency. This corresponds to the **optical branch**.\n                *   At $k=0$ for the optical branch, let's examine the motion. The equations of motion become:\n                    * $(2K - m_1 \\omega^2) U - 2K V = 0$\n                    * $-2K U + (2K - m_2 \\omega^2) V = 0$\n                * Substitute $\\omega^2 = \\omega^2_{\\mathrm{op}}(0)$:\n                    * $(2K - m_1 [2K(\\frac{1}{m_1} + \\frac{1}{m_2})]) U - 2K V = 0$\n                    * $(2K - 2K - 2K\\frac{m_1}{m_2}) U - 2K V = 0$\n                    * $-2K\\frac{m_1}{m_2} U - 2K V = 0 \\Rightarrow m_1 U = -m_2 V$.\n                * This means the two atoms in the unit cell move in opposite directions. The center of mass of the unit cell, $m_1 U + m_2 V$, is stationary. This is the characteristic of an optical mode. It can be excited by an electric field (light) if the atoms are charged (ionic crystal, as stated).\n\n        *   **Case 2: Minus sign (Acoustic branch)**\n            *   Minus sign at $k=0$: $\\omega^2_{\\mathrm{ac}}(k=0) = K(\\frac{1}{m_1} + \\frac{1}{m_2}) - K(\\frac{1}{m_1} + \\frac{1}{m_2}) = 0$. So $\\omega_{\\mathrm{ac}}(0)=0$. This is the characteristic of the **acoustic branch**.\n            *   Let's find the slope at $k=0$. For small $k$:\n            *   $\\omega^2_{\\mathrm{ac}} \\approx K(\\frac{1}{m_1} + \\frac{1}{m_2}) - K \\left[ (\\frac{1}{m_1} + \\frac{1}{m_2}) - \\frac{k^2 a^2 / (m_1 m_2)}{2(\\frac{1}{m_1} + \\frac{1}{m_2})} \\right]$\n            *   $\\omega^2_{\\mathrm{ac}} \\approx K \\frac{k^2 a^2 / (m_1 m_2)}{2(\\frac{m_1+m_2}{m_1 m_2})} = K \\frac{k^2 a^2}{2(m_1+m_2)}$\n            *   $\\omega_{\\mathrm{ac}}(k) \\approx \\sqrt{\\frac{K a^2}{2(m_1+m_2)}} |k|$.\n            *   This is a linear dispersion relation $\\omega = v_s |k|$ for small $k$, where $v_s$ is the speed of sound. This confirms it is the acoustic branch. The atoms in the unit cell move in phase for long wavelengths.\n            *   Let's check the motion at $k=0$. The equations are $(2K - m_1 \\omega^2) U - 2K V = 0$. With $\\omega=0$, this becomes $2K U - 2K V = 0$, which means $U=V$. The two atoms in the cell move together, which corresponds to a uniform translation of the crystal. For $k \\to 0$, $U \\approx V$, so adjacent cells move nearly in phase as well. This is a long-wavelength sound wave.\n\n    *   **Justification summary:**\n        *   The branch where $\\omega \\to 0$ as $k \\to 0$ is the acoustic branch. It describes long-wavelength vibrations analogous to sound waves, where atoms in a unit cell move in phase. This corresponds to the minus sign in the solution for $\\omega^2$.\n        *   The branch where $\\omega$ is finite and non-zero at $k=0$ is the optical branch. It describes vibrations where the two sublattices (atoms of type $m_1$ and $m_2$) oscillate against each other. This corresponds to the plus sign.\n\n    *   **Step 7: Behavior at the Brillouin Zone boundary ($k = \\pi/a$).**\n        *   At $k = \\pi/a$, we have $ka = \\pi$, so $ka/2 = \\pi/2$.\n        *   $\\sin(ka/2) = \\sin(\\pi/2) = 1$.\n        *   The term in the determinant equation $4K^2 \\sin^2(ka/2)$ becomes $4K^2$.\n        *   The quadratic equation is $m_1 m_2 (\\omega^2)^2 - 2K(m_1+m_2)\\omega^2 + 4K^2 = 0$.\n        *   Let's solve this for $\\omega^2$.\n        *   $\\omega^2 = \\frac{2K(m_1+m_2) \\pm \\sqrt{4K^2(m_1+m_2)^2 - 16K^2 m_1 m_2}}{2m_1 m_2}$\n        *   $\\omega^2 = \\frac{K(m_1+m_2) \\pm K \\sqrt{(m_1+m_2)^2 - 4m_1 m_2}}{m_1 m_2}$\n        *   $\\omega^2 = \\frac{K(m_1+m_2) \\pm K \\sqrt{m_1^2 + 2m_1m_2 + m_2^2 - 4m_1 m_2}}{m_1 m_2}$\n        *   $\\omega^2 = \\frac{K(m_1+m_2) \\pm K \\sqrt{(m_1-m_2)^2}}{m_1 m_2} = \\frac{K(m_1+m_2) \\pm K |m_1-m_2|}{m_1 m_2}$.\n\n        *   Let's assume $m_1  m_2$ without loss of generality. Then $|m_1-m_2| = m_1-m_2$.\n        *   The two frequencies are:\n            *   $\\omega^2_{\\mathrm{op}}(\\pi/a) = \\frac{K(m_1+m_2) + K(m_1-m_2)}{m_1 m_2} = \\frac{2Km_1}{m_1 m_2} = \\frac{2K}{m_2}$.\n            *   $\\omega^2_{\\mathrm{ac}}(\\pi/a) = \\frac{K(m_1+m_2) - K(m_1-m_2)}{m_1 m_2} = \\frac{2Km_2}{m_1 m_2} = \\frac{2K}{m_1}$.\n        *   At the zone boundary, the higher frequency (optical) corresponds to the vibration of the lighter mass ($m_2$ in this case), and the lower frequency (acoustic) corresponds to the vibration of the heavier mass ($m_1$). This makes physical sense: at $k=\\pi/a$, the phase difference between adjacent cells is $\\exp(i\\pi)=-1$. For the acoustic mode (lower energy), the heavier atoms are vibrating while the lighter ones are stationary. For the optical mode (higher energy), the lighter atoms are vibrating while the heavier ones are stationary. Let's verify this from the equations of motion.\n        * At $k=\\pi/a$, $1+e^{-i\\pi} = 1-1=0$, and $1+e^{i\\pi}=1-1=0$.\n        * The equations of motion decouple!\n            * $(2K - m_1 \\omega^2) U = 0$\n            * $(2K - m_2 \\omega^2) V = 0$\n        * This gives two independent solutions:\n            * Solution 1: $U \\ne 0, V = 0$. Then $\\omega^2 = 2K/m_1$.\n            * Solution 2: $U = 0, V \\ne 0$. Then $\\omega^2 = 2K/m_2$.\n        * The solution with frequency $\\omega = \\sqrt{2K/m_1}$ corresponds to the sublattice of $m_1$ atoms oscillating, while the $m_2$ sublattice is at rest.\n        * The solution with frequency $\\omega = \\sqrt{2K/m_2}$ corresponds to the sublattice of $m_2$ atoms oscillating, while the $m_1$ sublattice is at rest.\n        * The higher frequency belongs to the optical branch, and the lower frequency to the acoustic branch.\n        * So if $m_1  m_2$, then $2K/m_1  2K/m_2$.\n        * $\\omega^2_{\\text{ac}}(\\pi/a) = 2K/m_1$ (heavier mass vibrates).\n        * $\\omega^2_{\\text{op}}(\\pi/a) = 2K/m_2$ (lighter mass vibrates).\n        * This matches the result from the full solution. The logic is sound.\n\n    *   **Final Answer Formulation:**\n        *   The problem asks for $\\omega_{\\mathrm{ac}}(k)$ and $\\omega_{\\mathrm{op}}(k)$.\n        *   I derived $\\omega^2$. I need to take the square root.\n        *   $\\omega^2_{\\pm} = K\\left(\\frac{1}{m_1} + \\frac{1}{m_2}\\right) \\pm K\\sqrt{\\left(\\frac{1}{m_1} + \\frac{1}{m_2}\\right)^2 - \\frac{4\\sin^2(ka/2)}{m_1 m_2}}$.\n        *   Optical branch corresponds to the plus sign:\n            *   $\\omega_{\\mathrm{op}}(k) = \\sqrt{K\\left(\\frac{1}{m_1} + \\frac{1}{m_2}\\right) + K\\sqrt{\\left(\\frac{1}{m_1} + \\frac{1}{m_2}\\right)^2 - \\frac{4\\sin^2(ka/2)}{m_1 m_2}}}$\n        *   Acoustic branch corresponds to the minus sign:\n            *   $\\omega_{\\mathrm{ac}}(k) = \\sqrt{K\\left(\\frac{1}{m_1} + \\frac{1}{m_2}\\right) - K\\sqrt{\\left(\\frac{1}{m_1} + \\frac{1}{m_2}\\right)^2 - \\frac{4\\sin^2(ka/2)}{m_1 m_2}}}$\n        *   This is the final analytical expression. It needs to be written in LaTeX according to the rules.\n\n    *   **Review of reasoning and steps:**\n        1.  **Lagrangian:** $L = T - V$.\n            *   $T = \\sum_n (\\frac{1}{2}m_1\\dot{u}_n^2 + \\frac{1}{2}m_2\\dot{v}_n^2)$. Correct.\n            *   $V = \\frac{1}{2}K \\sum_n ((v_n-u_n)^2 + (u_{n+1}-v_n)^2)$. Correct.\n        2.  **Euler-Lagrange Equations:**\n            *   $m_1 \\ddot{u}_n = K (v_n + v_{n-1} - 2u_n)$. My derivation was $m_1 \\ddot{u}_n = K(v_n - u_n) - K(u_n - v_{n-1}) = K(v_n+v_{n-1}-2u_n)$. Looks correct. Force on $m_1$ at $na$ is from $m_2$ at $na+a/2-a=na-a/2$ (i.e. $v_{n-1}$) and $m_2$ at $na+a/2$ (i.e. $v_n$). No, that's not right. The equilibrium positions are $na$ for $m_1$ and $na+a/2$ for $m_2$. The interacting neighbors of $u_n$ are $v_{n-1}$ and $v_n$.\n            *   Let's check forces directly. Force on $m_1$ in cell $n$:\n                *   Spring to the right (with $m_2$ of cell $n$): $F_{\\text{right}} = K((x_{n,2}-x_{n,1})-a/2) = K((na+a/2+v_n)-(na+u_n)-a/2) = K(v_n-u_n)$.\n                *   Spring to the left (with $m_2$ of cell $n-1$): Equilibrium pos of $m_2$ in cell $n-1$ is $(n-1)a+a/2$. So its position is $(n-1)a+a/2+v_{n-1}$.\n                *   $F_{\\text{left}} = -K( (x_{n,1}-x_{n-1,2}) - a/2) = -K( (na+u_n) - ((n-1)a+a/2+v_{n-1}) - a/2) = -K(u_n - v_{n-1})$.\n                *   Total force: $m_1 \\ddot{u}_n = F_{\\text{right}} + F_{\\text{left}} = K(v_n-u_n) - K(u_n-v_{n-1}) = K(v_n+v_{n-1}-2u_n)$. This confirms the Lagrangian-derived EOM.\n            *   $m_2 \\ddot{v}_n = K (u_{n+1} + u_n - 2v_n)$.\n                *   Force on $m_2$ in cell $n$: Neighbors are $m_1$ in cell $n$ and $m_1$ in cell $n+1$.\n                *   Spring to the left (with $m_1$ of cell $n$): $F_{\\text{left}} = -K((x_{n,2}-x_{n,1})-a/2) = -K(v_n-u_n)$.\n                *   Spring to the right (with $m_1$ of cell $n+1$): Equilibrium pos of $m_1$ in cell $n+1$ is $(n+1)a$. Position is $(n+1)a+u_{n+1}$.\n                *   $F_{\\text{right}} = K((x_{n+1,1}-x_{n,2})-a/2) = K(((n+1)a+u_{n+1})-(na+a/2+v_n)-a/2) = K(u_{n+1}-v_n)$.\n                *   Total force: $m_2 \\ddot{v}_n = F_{\\text{left}} + F_{\\text{right}} = -K(v_n-u_n) + K(u_{n+1}-v_n) = K(u_{n+1}+u_n-2v_n)$. This also confirms the EOM.\n        3.  **Plane Wave Ansatz:**\n            *   $u_n = U e^{i(kna-\\omega t)}$, $v_n = V e^{i(kna-\\omega t)}$.\n            *   $v_{n-1} = V e^{i(k(n-1)a-\\omega t)} = v_n e^{-ika}$. This is correct.\n            *   $u_{n+1} = U e^{i(k(n+1)a-\\omega t)} = u_n e^{ika}$. This is correct.\n        4.  **Substitution and characteristic equation:**\n            *   $-m_1 \\omega^2 U = K(V + V e^{-ika} - 2U)$\n            *   $-m_2 \\omega^2 V = K(U e^{ika} + U - 2V)$\n            *   $(2K-m_1\\omega^2)U - K(1+e^{-ika})V = 0$\n            *   $-K(1+e^{ika})U + (2K-m_2\\omega^2)V = 0$\n            *   Determinant gives: $(2K-m_1\\omega^2)(2K-m_2\\omega^2) - K^2(1+e^{-ika})(1+e^{ika})=0$.\n            *   $(1+e^{-ika})(1+e^{ika}) = 2+2\\cos(ka) = 4\\cos^2(ka/2)$. This is correct.\n            *   The derivation yielding $m_1 m_2 (\\omega^2)^2 - 2K(m_1+m_2)\\omega^2 + 4K^2 \\sin^2(ka/2) = 0$ is correct.\n        5.  **Solution of quadratic equation:** The quadratic formula application and subsequent simplification to the standard form is correct.\n        6.  **Branch Identification:** The analysis at $k \\to 0$ correctly identifies the acoustic ($-$ sign, $\\omega \\to 0$) and optical ($+$ sign, $\\omega \\to \\text{const}$) branches.\n        7.  **Final Expression:** The final expressions for $\\omega_{\\mathrm{ac}}(k)$ and $\\omega_{\\mathrm{op}}(k)$ are correct.\n\nEverything seems to be in order. I will now write the solution following all the formatting rules.\nI must be careful with LaTeX formatting. All math entities, including single-letter variables and numbers, must be in LaTeX.\nThe final answer must be a `pmatrix` environment with the two expressions. The problem asks for `\\omega_{\\mathrm{ac}}(k)` and `\\omega_{\\mathrm{op}}(k)`. I can put them in a row matrix as requested. `\\omega_{\\mathrm{ac}}(k)` first, then `\\omega_{\\mathrm{op}}(k)`, corresponding to the minus and plus signs, respectively.\nThe solution part should be a single continuous block of text, starting from first principles as requested. I've laid out the steps for this.\nI'll use `\\ddot{u}_n` for second derivatives, `\\exp(...)` for exponentials, `\\sin` for sine, etc. as instructed.\nThe final answer box must contain only the LaTeX expression.\nThe final expressions are quite long. I should double check the parentheses and square roots.\n$\\omega_{\\mathrm{ac}}(k) = \\sqrt{K\\left(\\frac{1}{m_1} + \\frac{1}{m_2}\\right) - K\\sqrt{\\left(\\frac{1}{m_1} + \\frac{1}{m_2}\\right)^2 - \\frac{4}{m_1 m_2}\\sin^2\\left(\\frac{ka}{2}\\right)}}$\n$\\omega_{\\mathrm{op}}(k) = \\sqrt{K\\left(\\frac{1}{m_1} + \\frac{1}{m_2}\\right) + K\\sqrt{\\left(\\frac{1}{m_1} + \\frac{1}{m_2}\\right)^2 - \\frac{4}{m_1 m_2}\\sin^2\\left(\\frac{ka}{2}\\right)}}$\nLooks good. I have to be careful not to write `sin^2(x)` as `\\sin^2(x)` in LaTeX but `\\sin^{2}(x)`. This is a common mistake. Let's check the rules again. `x^{a+b}`. So it should be `\\sin^{2}(...)`. Okay.\nThe problem statement requests the final answer as `\\omega_{\\mathrm{ac}}(k)` and `\\omega_{\\mathrm{op}}(k)`. My two expressions are exactly that. I will list them in a `pmatrix` as a row vector.",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\sqrt{K\\left(\\frac{1}{m_{1}} + \\frac{1}{m_{2}}\\right) - K\\sqrt{\\left(\\frac{1}{m_{1}} + \\frac{1}{m_{2}}\\right)^{2} - \\frac{4}{m_{1}m_{2}}\\sin^{2}\\left(\\frac{ka}{2}\\right)}}  \\sqrt{K\\left(\\frac{1}{m_{1}} + \\frac{1}{m_{2}}\\right) + K\\sqrt{\\left(\\frac{1}{m_{1}} + \\frac{1}{m_{2}}\\right)^{2} - \\frac{4}{m_{1}m_{2}}\\sin^{2}\\left(\\frac{ka}{2}\\right)}}\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "While direct derivation is insightful, computational methods require a more general and automatable approach to finding vibrational modes. This practice transitions from the Lagrangian to the Hamiltonian framework to develop a computational tool for diagonalizing the dynamics of any coupled oscillator system . You will implement a canonical transformation—a cornerstone of Hamiltonian mechanics—to systematically decouple the system into a set of independent normal modes, a procedure that forms the basis of modern phonon calculation software.",
            "id": "3432798",
            "problem": "Consider a one-dimensional alloy lattice modeled as a finite chain of point masses connected by linear springs with nearest-neighbor interactions. Let the generalized coordinates be the displacements collected in a vector $\\boldsymbol{x} \\in \\mathbb{R}^N$, with $N$ the number of masses, and let the conjugate momenta be $\\boldsymbol{p} \\in \\mathbb{R}^N$. The mass matrix is diagonal, $\\mathbf{M} = \\mathrm{diag}(m_1, \\dots, m_N)$ with $m_i \\gt 0$ in kilograms, and the stiffness matrix $\\mathbf{K} \\in \\mathbb{R}^{N \\times N}$ is symmetric, built from nearest-neighbor springs of stiffness $k$ in newtons per meter. The Lagrangian is $L = T - V$ with kinetic energy $T = \\tfrac{1}{2} \\dot{\\boldsymbol{x}}^\\top \\mathbf{M} \\dot{\\boldsymbol{x}}$ and potential energy $V = \\tfrac{1}{2} \\boldsymbol{x}^\\top \\mathbf{K} \\boldsymbol{x}$. The conjugate momentum is $\\boldsymbol{p} = \\partial L / \\partial \\dot{\\boldsymbol{x}} = \\mathbf{M} \\dot{\\boldsymbol{x}}$, and the Hamiltonian is $H(\\boldsymbol{x}, \\boldsymbol{p}) = \\tfrac{1}{2} \\boldsymbol{p}^\\top \\mathbf{M}^{-1} \\boldsymbol{p} + \\tfrac{1}{2} \\boldsymbol{x}^\\top \\mathbf{K} \\boldsymbol{x}$.\n\nTask: Starting from these fundamental definitions, derive and implement a real linear canonical transformation (a symplectic map on phase space) that decouples the Hamiltonian into a sum of independent harmonic oscillators with nonnegative angular frequencies, suitable for phonon calculations in computational materials science. Your implementation must:\n- Construct $\\mathbf{M}$ and $\\mathbf{K}$ from a given chain specification with either free or fixed boundary conditions, where free ends are not attached to walls and fixed ends are attached to walls with springs of stiffness $k$.\n- Produce a symplectic transformation matrix $\\mathbf{S}$ that maps $(\\boldsymbol{x}, \\boldsymbol{p})$ to new canonical coordinates $(\\boldsymbol{Q}, \\boldsymbol{P})$ in which the Hamiltonian takes the decoupled quadratic form $H = \\tfrac{1}{2} \\sum_i \\left(P_i^2 + \\omega_i^2 Q_i^2\\right)$ with $\\omega_i \\ge 0$ the angular frequencies in radians per second.\n- Verify symplecticity by computing the Frobenius norm of the deviation from the symplectic condition, namely $\\left\\| \\mathbf{S}^\\top \\mathbf{J} \\mathbf{S} - \\mathbf{J} \\right\\|_F$, where $\\mathbf{J} = \\begin{bmatrix} \\mathbf{0}  \\mathbf{I} \\\\ -\\mathbf{I}  \\mathbf{0} \\end{bmatrix}$ and $\\mathbf{I}$ is the $N \\times N$ identity matrix.\n- Quantify decoupling quality by computing, in the transformed coordinates, the maximum absolute off-diagonal entries of the transformed potential metric and the transformed kinetic metric. Specifically, if the transformation is $(\\boldsymbol{Q}, \\boldsymbol{P}) = \\mathbf{S} (\\boldsymbol{x}, \\boldsymbol{p})$, then the quadratic Hamiltonian matrix transforms as $\\mathbf{H}' = \\mathbf{S}^{-\\top} \\,\\mathrm{diag}(\\mathbf{K}, \\mathbf{M}^{-1})\\, \\mathbf{S}^{-1}$; extract from $\\mathbf{H}'$ the upper-left $N \\times N$ block (potential metric in $\\boldsymbol{Q}$) and the lower-right $N \\times N$ block (kinetic metric in $\\boldsymbol{P}$), and report the maximum absolute value of their off-diagonal entries.\n\nPhysical and numerical units:\n- Masses $m_i$ must be specified in kilograms.\n- Spring constants $k$ must be specified in newtons per meter.\n- Angular frequencies $\\omega_i$ must be expressed in radians per second as real-valued floats.\n\nAngle unit:\n- Any angular quantity must use radians.\n\nYour program must implement the above and apply it to the following test suite. For each case, construct $\\mathbf{M}$ and $\\mathbf{K}$ as described, compute the canonical decoupling, and return the specified outputs.\n\nTest Suite:\n- Case A (happy path with acoustic zero mode): $N = 3$, masses $[1.0, 2.0, 1.5]$ kilograms, spring stiffness $k = 100.0$ newtons per meter, boundary condition free at both ends.\n- Case B (fixed ends, no zero mode): $N = 3$, masses $[1.0, 2.0, 1.5]$ kilograms, spring stiffness $k = 100.0$ newtons per meter, boundary condition fixed at both ends (each end attached to a wall by a spring of stiffness $k$).\n- Case C (near-degenerate alloy): $N = 4$, masses $[1.0, 1.01, 0.99, 1.0]$ kilograms, spring stiffness $k = 50.0$ newtons per meter, boundary condition fixed at both ends.\n\nRequired outputs per test case:\n- A list of the $N$ angular frequencies $\\omega_i$ in ascending order in radians per second.\n- A single float equal to the Frobenius norm $\\left\\| \\mathbf{S}^\\top \\mathbf{J} \\mathbf{S} - \\mathbf{J} \\right\\|_F$.\n- A single float equal to the maximum absolute off-diagonal entry of the transformed potential metric (upper-left block of $\\mathbf{H}'$).\n- A single float equal to the maximum absolute off-diagonal entry of the transformed kinetic metric (lower-right block of $\\mathbf{H}'$).\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each test case contributes a sublist of the form $[\\text{frequencies}, \\text{symplectic\\_error}, \\text{max\\_offdiag\\_potential}, \\text{max\\_offdiag\\_kinetic}]$. For example, an output with three test cases should have the form $[[\\cdots], [\\cdots], [\\cdots]]$ where each inner list matches the specified structure.",
            "solution": "We start from the fundamental definitions of Analytical Mechanics applied to a coupled mass-spring system. The generalized coordinates $\\boldsymbol{x} \\in \\mathbb{R}^N$ collect the displacements of the $N$ masses, with diagonal mass matrix $\\mathbf{M} = \\mathrm{diag}(m_1, \\dots, m_N)$ and symmetric stiffness matrix $\\mathbf{K}$. The Lagrangian is $L = T - V$ with $T = \\tfrac{1}{2} \\dot{\\boldsymbol{x}}^\\top \\mathbf{M} \\dot{\\boldsymbol{x}}$ and $V = \\tfrac{1}{2} \\boldsymbol{x}^\\top \\mathbf{K} \\boldsymbol{x}$. The conjugate momentum is $\\boldsymbol{p} = \\partial L / \\partial \\dot{\\boldsymbol{x}} = \\mathbf{M} \\dot{\\boldsymbol{x}}$, and the Hamiltonian is $H(\\boldsymbol{x}, \\boldsymbol{p}) = \\tfrac{1}{2} \\boldsymbol{p}^\\top \\mathbf{M}^{-1} \\boldsymbol{p} + \\tfrac{1}{2} \\boldsymbol{x}^\\top \\mathbf{K} \\boldsymbol{x}$.\n\nOur goal is to find a real linear canonical transformation that decouples the Hamiltonian into a sum of uncoupled harmonic oscillators. A real linear canonical transformation on phase space $\\mathbb{R}^{2N}$ is represented by a symplectic matrix $\\mathbf{S} \\in \\mathbb{R}^{2N \\times 2N}$ satisfying $\\mathbf{S}^\\top \\mathbf{J} \\mathbf{S} = \\mathbf{J}$ with $\\mathbf{J} = \\begin{bmatrix} \\mathbf{0}  \\mathbf{I} \\\\ -\\mathbf{I}  \\mathbf{0} \\end{bmatrix}$. We seek $\\mathbf{S}$ such that, in new canonical coordinates $(\\boldsymbol{Q}, \\boldsymbol{P}) = \\mathbf{S} (\\boldsymbol{x}, \\boldsymbol{p})$, the Hamiltonian becomes\n$$\nH = \\tfrac{1}{2} \\sum_{i=1}^N \\left( P_i^2 + \\omega_i^2 Q_i^2 \\right),\n$$\nwith nonnegative angular frequencies $\\omega_i$.\n\nPrincipled construction from first principles:\n- Step one (mass normalization): Define the mass-weighted coordinates via a canonical, block-diagonal scaling. Consider the transformation $(\\boldsymbol{y}, \\boldsymbol{\\pi}_y) = (\\mathbf{M}^{1/2} \\boldsymbol{x}, \\mathbf{M}^{-1/2} \\boldsymbol{p})$. This is generated by the block-diagonal matrix $\\mathbf{S}_1 = \\mathrm{diag}(\\mathbf{M}^{1/2}, \\mathbf{M}^{-1/2})$. To verify symplecticity, for a block-diagonal transformation $\\mathrm{diag}(\\mathbf{A}, \\mathbf{B})$, the condition $\\mathbf{S}_1^\\top \\mathbf{J} \\mathbf{S}_1 = \\mathbf{J}$ holds if and only if $\\mathbf{A}^\\top \\mathbf{B} = \\mathbf{I}$. Here $\\mathbf{A} = \\mathbf{M}^{1/2}$ and $\\mathbf{B} = \\mathbf{M}^{-1/2}$ satisfy $\\mathbf{A}^\\top \\mathbf{B} = \\mathbf{M}^{1/2} \\mathbf{M}^{-1/2} = \\mathbf{I}$. In these coordinates, the Hamiltonian becomes\n$$\nH = \\tfrac{1}{2} \\boldsymbol{\\pi}_y^\\top \\boldsymbol{\\pi}_y + \\tfrac{1}{2} \\boldsymbol{y}^\\top \\mathbf{C} \\boldsymbol{y},\n$$\nwhere $\\mathbf{C} = \\mathbf{M}^{-1/2} \\mathbf{K} \\mathbf{M}^{-1/2}$ is symmetric and positive semidefinite for stable systems.\n\n- Step two (orthogonal decoupling): Diagonalize $\\mathbf{C}$ with an orthogonal matrix $\\mathbf{O}$, $\\mathbf{O}^\\top \\mathbf{C} \\mathbf{O} = \\boldsymbol{\\Omega}^2 = \\mathrm{diag}(\\omega_1^2, \\dots, \\omega_N^2)$, with $\\omega_i \\ge 0$. Perform the rotation $(\\boldsymbol{Q}, \\boldsymbol{P}) = (\\mathbf{O}^\\top \\boldsymbol{y}, \\mathbf{O}^\\top \\boldsymbol{\\pi}_y)$. This second transformation is symplectic with $\\mathbf{S}_2 = \\mathrm{diag}(\\mathbf{O}^\\top, \\mathbf{O}^\\top)$ because $\\mathbf{O}$ is orthogonal and again $\\mathbf{A}^\\top \\mathbf{B} = \\mathbf{I}$ holds. The composed transformation $\\mathbf{S} = \\mathbf{S}_2 \\mathbf{S}_1$ is therefore symplectic and yields the decoupled Hamiltonian\n$$\nH = \\tfrac{1}{2} \\boldsymbol{P}^\\top \\boldsymbol{P} + \\tfrac{1}{2} \\boldsymbol{Q}^\\top \\boldsymbol{\\Omega}^2 \\boldsymbol{Q} = \\tfrac{1}{2} \\sum_{i=1}^N \\left( P_i^2 + \\omega_i^2 Q_i^2 \\right).\n$$\n\nExplicitly, the full symplectic map $\\mathbf{S}$ that sends $(\\boldsymbol{x}, \\boldsymbol{p})$ to $(\\boldsymbol{Q}, \\boldsymbol{P})$ is\n$$\n\\mathbf{S} = \\begin{bmatrix}\n\\mathbf{O}^\\top \\mathbf{M}^{1/2}  \\mathbf{0} \\\\\n\\mathbf{0}  \\mathbf{O}^\\top \\mathbf{M}^{-1/2}\n\\end{bmatrix},\n$$\nwhich satisfies $\\mathbf{S}^\\top \\mathbf{J} \\mathbf{S} = \\mathbf{J}$ since $(\\mathbf{O}^\\top \\mathbf{M}^{1/2})^\\top (\\mathbf{O}^\\top \\mathbf{M}^{-1/2}) = \\mathbf{M}^{1/2} \\mathbf{O} \\mathbf{O}^\\top \\mathbf{M}^{-1/2} = \\mathbf{I}$.\n\nAlgorithmic realization:\n- Construct $\\mathbf{K}$ for the one-dimensional chain with spring constant $k$ by assembling nearest-neighbor contributions. For each neighboring pair $(i, i+1)$, add $k$ to the diagonal entries $(i,i)$ and $(i+1,i+1)$, and add $-k$ to the off-diagonals $(i,i+1)$ and $(i+1,i)$. For fixed boundary conditions, add an additional $k$ to the $(1,1)$ and $(N,N)$ entries to represent the end springs connected to rigid walls. For free boundary conditions, no wall springs are added.\n- Set $\\mathbf{M} = \\mathrm{diag}(m_1, \\dots, m_N)$ with given masses in kilograms.\n- Form $\\mathbf{C} = \\mathbf{M}^{-1/2} \\mathbf{K} \\mathbf{M}^{-1/2}$ using the diagonal square roots of the masses. Diagonalize $\\mathbf{C}$ with a symmetric eigenvalue solver to obtain eigenpairs $(\\omega_i^2, \\boldsymbol{v}_i)$ and orthogonal eigenvector matrix $\\mathbf{O} = [\\boldsymbol{v}_1, \\dots, \\boldsymbol{v}_N]$. Sort the eigenvalues in ascending order and compute $\\omega_i = \\sqrt{\\max(0, \\omega_i^2)}$ to ensure nonnegativity.\n- Build the symplectic matrix $\\mathbf{S}$ as above and verify symplecticity by computing the Frobenius norm $\\left\\| \\mathbf{S}^\\top \\mathbf{J} \\mathbf{S} - \\mathbf{J} \\right\\|_F$.\n- Quantify decoupling by transforming the quadratic Hamiltonian matrix $\\mathrm{diag}(\\mathbf{K}, \\mathbf{M}^{-1})$ into $\\mathbf{H}' = \\mathbf{S}^{-\\top} \\,\\mathrm{diag}(\\mathbf{K}, \\mathbf{M}^{-1})\\, \\mathbf{S}^{-1}$; then extract the upper-left block $\\mathbf{H}'_{QQ}$ and lower-right block $\\mathbf{H}'_{PP}$. In exact arithmetic, $\\mathbf{H}'_{QQ} = \\boldsymbol{\\Omega}^2$ and $\\mathbf{H}'_{PP} = \\mathbf{I}$. Compute the maximum absolute off-diagonal entries of these blocks to assess numerical decoupling.\n- Units: masses in kilograms, spring constants in newtons per meter, and angular frequencies in radians per second.\n\nCoverage of the test suite:\n- Case A exercises a free boundary chain with an acoustic zero mode ($\\omega = 0$) typical of translational invariance, ensuring the implementation handles semidefinite stiffness properly.\n- Case B uses fixed boundary conditions to remove the zero mode, producing strictly positive frequencies and testing the transformation in a positive definite setting.\n- Case C uses nearly equal masses to induce near-degeneracy, probing numerical stability of the orthogonal diagonalization and the symplectic construction.\n\nThe code implements the above derivation, constructs $\\mathbf{M}$ and $\\mathbf{K}$ as specified, computes $\\boldsymbol{\\omega}$, the symplectic deviation norm, and the maximum off-diagonal magnitudes of the transformed potential and kinetic metrics, and prints the results in the required single-line list-of-lists format.",
            "answer": "```python\nimport numpy as np\n\ndef build_chain_matrices(N, masses, k, boundary):\n    \"\"\"\n    Build mass matrix M (diagonal) and stiffness matrix K for a 1D chain.\n    boundary: 'free' or 'fixed'\n    \"\"\"\n    M = np.diag(masses)\n    K = np.zeros((N, N), dtype=float)\n    # Nearest-neighbor springs\n    for i in range(N - 1):\n        K[i, i] += k\n        K[i + 1, i + 1] += k\n        K[i, i + 1] -= k\n        K[i + 1, i] -= k\n    # Boundary springs to walls if fixed\n    if boundary == 'fixed':\n        K[0, 0] += k\n        K[-1, -1] += k\n    elif boundary == 'free':\n        pass\n    else:\n        raise ValueError(\"boundary must be 'free' or 'fixed'\")\n    return M, K\n\ndef symplectic_decouple(M, K, atol_clip=1e-12):\n    \"\"\"\n    Compute symplectic transformation S that decouples the Hamiltonian:\n    H = 1/2 p^T M^{-1} p + 1/2 x^T K x\n    Returns frequencies (ascending), symplectic error, max offdiag of transformed\n    potential metric, max offdiag of transformed kinetic metric.\n    \"\"\"\n    N = M.shape[0]\n    # Mass square roots\n    masses = np.diag(M)\n    Msqrt = np.diag(np.sqrt(masses))\n    Minv = np.diag(1.0 / masses)\n    Minv_sqrt = np.diag(1.0 / np.sqrt(masses))\n\n    # Mass-weighted stiffness\n    C = Minv_sqrt @ K @ Minv_sqrt\n    # Symmetric eigen-decomposition\n    w2, O = np.linalg.eigh(C)  # ascending eigenvalues\n    # Clip small negative eigenvalues from numerical noise\n    w2_clipped = np.maximum(w2, 0.0)\n    w = np.sqrt(w2_clipped)\n\n    # Build symplectic matrix S = diag(O^T Msqrt, O^T Minv_sqrt)\n    A = O.T @ Msqrt\n    B = O.T @ Minv_sqrt\n    zero = np.zeros_like(A)\n    S = np.block([[A, np.zeros((N, N))],\n                  [np.zeros((N, N)), B]])\n\n    # Symplectic check: || S^T J S - J ||_F\n    I = np.eye(N)\n    J = np.block([[np.zeros((N, N)), I],\n                  [-I, np.zeros((N, N))]])\n    symp_err = np.linalg.norm(S.T @ J @ S - J, ord='fro')\n\n    # Transform Hamiltonian quadratic form Hmat = diag(K, M^{-1})\n    Hmat = np.block([[K, np.zeros((N, N))],\n                     [np.zeros((N, N)), Minv]])\n    # Compute S^{-1} via block diagonal inverse\n    # Since S is block diagonal with invertible blocks A and B:\n    # S^{-1} = diag(A^{-1}, B^{-1})\n    A_inv = np.linalg.inv(A)\n    B_inv = np.linalg.inv(B)\n    S_inv = np.block([[A_inv, np.zeros((N, N))],\n                      [np.zeros((N, N)), B_inv]])\n    S_inv_T = S_inv.T\n    Hprime = S_inv_T @ Hmat @ S_inv\n\n    # Extract transformed potential and kinetic metric blocks\n    Hqq = Hprime[:N, :N]\n    Hpp = Hprime[N:, N:]\n\n    # Compute maximum absolute off-diagonal entries\n    def max_offdiag_abs(Mblock):\n        Moff = Mblock - np.diag(np.diag(Mblock))\n        if Moff.size == 0:\n            return 0.0\n        return float(np.max(np.abs(Moff)))\n\n    pot_off = max_offdiag_abs(Hqq)\n    kin_off = max_offdiag_abs(Hpp)\n\n    return w.tolist(), float(symp_err), float(pot_off), float(kin_off)\n\ndef solve():\n    # Define test cases as per the problem statement\n    test_cases = [\n        # Case A: N=3, masses [1.0, 2.0, 1.5], k=100.0, boundary='free'\n        {\"N\": 3, \"masses\": [1.0, 2.0, 1.5], \"k\": 100.0, \"boundary\": \"free\"},\n        # Case B: N=3, masses [1.0, 2.0, 1.5], k=100.0, boundary='fixed'\n        {\"N\": 3, \"masses\": [1.0, 2.0, 1.5], \"k\": 100.0, \"boundary\": \"fixed\"},\n        # Case C: N=4, masses [1.0, 1.01, 0.99, 1.0], k=50.0, boundary='fixed'\n        {\"N\": 4, \"masses\": [1.0, 1.01, 0.99, 1.0], \"k\": 50.0, \"boundary\": \"fixed\"},\n    ]\n\n    results = []\n    for case in test_cases:\n        N = case[\"N\"]\n        masses = np.array(case[\"masses\"], dtype=float)\n        k = float(case[\"k\"])\n        boundary = case[\"boundary\"]\n        M, K = build_chain_matrices(N, masses, k, boundary)\n        freqs, symp_err, pot_off, kin_off = symplectic_decouple(M, K)\n        results.append([freqs, symp_err, pot_off, kin_off])\n\n    # Final print statement in the exact required format.\n    # Ensure deterministic float formatting via default repr; lists-of-lists printed as requested.\n    print(str(results).replace(' ', ''))\n\nif __name__ == \"__main__\":\n    solve()\n```"
        },
        {
            "introduction": "Beyond lattice vibrations, many molecular dynamics simulations involve geometric constraints, such as rigid bonds, which are challenging to incorporate into standard Hamiltonian dynamics. This advanced practice introduces Dirac's powerful formalism for handling constrained systems, a topic of great importance in modern simulation algorithms . By implementing the theory for a simple molecular model, you will construct the Dirac bracket and see how it correctly projects the dynamics onto the constrained phase-space manifold, a technique essential for building robust and accurate molecular simulation tools.",
            "id": "3432820",
            "problem": "Implement a complete, runnable program that, for small molecular models with rigid bond constraints, constructs constrained Hamiltonian dynamics using Dirac’s theory for second-class constraints and quantitatively compares the uncorrected and corrected phase-space measures. Your implementation must start from first principles and definitions only, without using pre-derived shortcut formulas that are the target of the derivation.\n\nYou must adhere to the following definitions and requirements.\n\n1) Fundamental modeling definitions.\n\n- Consider a system of $N$ point particles in $d$ spatial dimensions with generalized coordinates $\\mathbf{q} \\in \\mathbb{R}^{n_q}$ and canonical momenta $\\mathbf{p} \\in \\mathbb{R}^{n_q}$, where $n_q = dN$ and $\\mathbf{q} = (q_1,\\ldots,q_{n_q})$, $\\mathbf{p} = (p_1,\\ldots,p_{n_q})$.\n- Let the Hamiltonian be $H(\\mathbf{q},\\mathbf{p}) = \\frac{1}{2}\\mathbf{p}^\\mathsf{T} M^{-1} \\mathbf{p} + V(\\mathbf{q})$, where $M$ is a constant, diagonal, positive-definite mass matrix of shape $n_q \\times n_q$ and $V(\\mathbf{q})$ is a smooth potential.\n- The canonical Poisson bracket of two smooth functions $f(\\mathbf{q},\\mathbf{p})$ and $g(\\mathbf{q},\\mathbf{p})$ is $\\{f,g\\} = \\sum_{i=1}^{n_q} \\left( \\frac{\\partial f}{\\partial q_i}\\frac{\\partial g}{\\partial p_i} - \\frac{\\partial f}{\\partial p_i}\\frac{\\partial g}{\\partial q_i} \\right)$.\n- A set of $m$ holonomic bond constraints is given by $g_j(\\mathbf{q})=0$, $j=1,\\ldots,m$, which are second-class when combined with their time derivatives. Define the primary constraints $\\phi^{(1)}_j(\\mathbf{q},\\mathbf{p}) = g_j(\\mathbf{q})$ and the secondary constraints $\\phi^{(2)}_j(\\mathbf{q},\\mathbf{p}) = \\dot g_j(\\mathbf{q},\\mathbf{p})$ obtained by differentiating $g_j(\\mathbf{q})$ along Hamiltonian flow.\n- For rigid bonds between particles $a$ and $b$ with target length $\\ell_j$, define $g_j(\\mathbf{q}) = \\frac{1}{2}\\left\\|\\mathbf{r}_b - \\mathbf{r}_a\\right\\|^2 - \\frac{1}{2}\\ell_j^2$, where $\\mathbf{r}_k \\in \\mathbb{R}^d$ is the position of particle $k$. Let $J(\\mathbf{q}) \\in \\mathbb{R}^{m \\times n_q}$ be the constraint Jacobian with rows $J_j(\\mathbf{q}) = \\nabla_{\\mathbf{q}} g_j(\\mathbf{q})$, and let $H_j(\\mathbf{q}) \\in \\mathbb{R}^{n_q \\times n_q}$ be the Hessian of $g_j$.\n\n2) Dirac theory.\n\n- Collect the $2m$ constraints into the vector $\\boldsymbol{\\phi} = (\\phi^{(1)}_1,\\ldots,\\phi^{(1)}_m,\\phi^{(2)}_1,\\ldots,\\phi^{(2)}_m)^\\mathsf{T}$. The constraint matrix $C(\\mathbf{q},\\mathbf{p}) \\in \\mathbb{R}^{2m \\times 2m}$ has entries $C_{ab}(\\mathbf{q},\\mathbf{p}) = \\{\\phi_a,\\phi_b\\}$.\n- The Dirac bracket of $f$ and $g$ is $\\{f,g\\}_D = \\{f,g\\} - \\sum_{a,b=1}^{2m} \\{f,\\phi_a\\} \\left(C^{-1}\\right)_{ab} \\{\\phi_b,g\\}$.\n- Constrained time evolution is generated by $\\frac{d}{dt} f = \\{f,H\\}_D$, which preserves all constraints $\\phi_a=0$.\n\n3) Phase-space measure modification.\n\n- The invariant phase-space measure on the constrained manifold is $\\delta(\\boldsymbol{\\phi}) \\sqrt{\\left|\\det C\\right|}\\, d\\mathbf{q}\\, d\\mathbf{p}$, where $\\delta(\\boldsymbol{\\phi})$ is the product of Dirac delta functions enforcing all $2m$ constraints.\n- After integrating out momenta under the secondary constraints, the induced configuration-space marginal contains a factor known as the Fixman correction, which depends on the constraint geometry through the Gram matrix $G(\\mathbf{q}) = J(\\mathbf{q}) M^{-1} J(\\mathbf{q})^\\mathsf{T} \\in \\mathbb{R}^{m \\times m}$.\n\n4) Tasks to perform in code.\n\nFor each test case, your program must:\n\n- Construct $J(\\mathbf{q})$ and the set of Hessians $\\{H_j(\\mathbf{q})\\}_{j=1}^m$ for the specified rigid bonds. Use $d=2$ and dimensionless units throughout this problem.\n- Build the $2m \\times 2m$ Dirac matrix $C(\\mathbf{q},\\mathbf{p})$ by evaluating Poisson brackets among all primary and secondary constraints, using only the definitions given above.\n- Compute $G(\\mathbf{q}) = J(\\mathbf{q}) M^{-1} J(\\mathbf{q})^\\mathsf{T}$, the determinant $\\det G(\\mathbf{q})$, and $\\sqrt{|\\det C(\\mathbf{q},\\mathbf{p})|}$. Quantify the phase-space measure modification and its relationship to the constraint geometry by reporting the ratio $R = \\sqrt{|\\det C|}/\\det G$ and the Fixman factor $F = \\sqrt{\\det G}$.\n- Implement the constrained equations of motion implied by the Dirac bracket in the equivalent Lagrange multiplier form. Using $J(\\mathbf{q})$, $H_j(\\mathbf{q})$, $M^{-1}$, and $\\nabla V(\\mathbf{q})$, compute the multipliers that enforce the constraints and evaluate the instantaneous primary and secondary constraint derivatives, reporting a violation metric $V_{\\max}$ defined as the maximum absolute value across all components of $\\dot{\\mathbf{g}}$ and $\\ddot{\\mathbf{g}}$ under the constrained dynamics at the given state.\n- All computations must be performed in double precision. All outputs must be real-valued scalars.\n\n5) Test suite.\n\nUse the following three test cases. All quantities are dimensionless and must be treated as such.\n\n- Test A (two particles, one bond, harmonic trap):\n  - $N=2$, $d=2$, $m_1 = 1$, $m_2 = 2$.\n  - $\\mathbf{r}_1 = (0,0)$, $\\mathbf{r}_2 = (1,0)$, $\\ell_1 = 1$.\n  - $\\mathbf{p}_1 = (0,0.3)$, $\\mathbf{p}_2 = (0,-0.4)$.\n  - $V(\\mathbf{q}) = \\frac{1}{2}k\\left(\\left\\|\\mathbf{r}_1\\right\\|^2 + \\left\\|\\mathbf{r}_2\\right\\|^2\\right)$ with $k=0.7$.\n\n- Test B (three particles, two bonds, free):\n  - $N=3$, $d=2$, $m_1 = 1$, $m_2 = 1$, $m_3 = 1$.\n  - $\\mathbf{r}_1 = (0,0)$, $\\mathbf{r}_2 = (1,0.5)$, $\\mathbf{r}_3 = (2.1,0.1)$.\n  - $\\ell_1 = \\left\\|\\mathbf{r}_2 - \\mathbf{r}_1\\right\\|$, $\\ell_2 = \\left\\|\\mathbf{r}_3 - \\mathbf{r}_2\\right\\|$.\n  - $\\mathbf{p}_1 = (0,1)$, $\\mathbf{p}_2 = (0,1)$, $\\mathbf{p}_3 = (0,1)$.\n  - $V(\\mathbf{q}) \\equiv 0$.\n\n- Test C (two particles, one bond, extreme mass ratio, free):\n  - $N=2$, $d=2$, $m_1 = 1$, $m_2 = 10^6$.\n  - $\\mathbf{r}_1 = (0,0)$, $\\mathbf{r}_2 = (1,0)$, $\\ell_1 = 1$.\n  - $\\mathbf{p}_1 = (0,0.2)$, $\\mathbf{p}_2 = (0,-0.2)$.\n  - $V(\\mathbf{q}) \\equiv 0$.\n\n6) Required outputs and final output format.\n\nFor each test case, compute and return the three scalars:\n- $R = \\sqrt{|\\det C|}/\\det G$,\n- $F = \\sqrt{\\det G}$,\n- $V_{\\max}$, the maximum absolute violation of the primary and secondary constraint time derivatives under the constrained dynamics at the given state.\n\nYour program should produce a single line of output containing all nine results for the three test cases as a comma-separated Python list of floats in the order $[R_A,F_A,V_{\\max,A}, R_B,F_B,V_{\\max,B}, R_C,F_C,V_{\\max,C}]$, for example, $[1.0,0.5,0.0, \\ldots]$.\n\nUse only dimensionless quantities. Angles, if any appear, must be in radians. No user input is allowed, and all data must be hard-coded from the test suite above.",
            "solution": "The problem statement is assessed to be valid. It is scientifically grounded in the principles of analytical mechanics, specifically the Dirac-Bergmann theory for constrained Hamiltonian systems. The problem is well-posed, with all necessary data and definitions provided for a unique, computable solution. The language is objective and the requirements are formalizable into a concrete algorithm.\n\n### Theoretical Formulation\n\nThe system under consideration consists of $N$ particles in $d$ dimensions, described by generalized coordinates $\\mathbf{q} \\in \\mathbb{R}^{n_q}$ and momenta $\\mathbf{p} \\in \\mathbb{R}^{n_q}$, with $n_q=dN$. The dynamics are governed by the Hamiltonian $H(\\mathbf{q},\\mathbf{p}) = \\frac{1}{2}\\mathbf{p}^\\mathsf{T} M^{-1} \\mathbf{p} + V(\\mathbf{q})$, where $M$ is a constant diagonal mass matrix.\n\nThe system is subject to $m$ holonomic constraints of the form $g_j(\\mathbf{q})=0$. For rigid bonds, these are $g_j(\\mathbf{q}) = \\frac{1}{2}(\\|\\mathbf{r}_b - \\mathbf{r}_a\\|^2 - \\ell_j^2) = 0$. These constraints lead to a set of $2m$ second-class constraints in phase space:\n1.  **Primary Constraints**: $\\phi^{(1)}_j \\equiv g_j(\\mathbf{q}) = 0$.\n2.  **Secondary Constraints**: $\\phi^{(2)}_j \\equiv \\dot{g}_j = \\{g_j, H\\} = (\\nabla_{\\mathbf{q}} g_j)^\\mathsf{T} M^{-1} \\mathbf{p} = J_j(\\mathbf{q}) M^{-1} \\mathbf{p} = 0$, where $J_j(\\mathbf{q})$ is the $j$-th row of the constraint Jacobian matrix $J(\\mathbf{q})$.\n\nThe full set of constraints is denoted by the vector $\\boldsymbol{\\phi} = (\\phi^{(1)}_1, \\dots, \\phi^{(1)}_m, \\phi^{(2)}_1, \\dots, \\phi^{(2)}_m)^\\mathsf{T}$.\n\n**1. Dirac Matrix and Phase-Space Measure**\n\nThe core of Dirac's theory is the constraint matrix $C$, with elements $C_{ab} = \\{\\phi_a, \\phi_b\\}$, where $\\{\\cdot,\\cdot\\}$ is the canonical Poisson bracket: $\\{f,g\\} = (\\nabla_{\\mathbf{q}} f)^\\mathsf{T} (\\nabla_{\\mathbf{p}} g) - (\\nabla_{\\mathbf{p}} f)^\\mathsf{T} (\\nabla_{\\mathbf{q}} g)$. To construct $C$, we need the phase-space gradients of the constraints:\n-   For primary constraints $\\phi^{(1)}_j = g_j$:\n    $$ \\nabla_{\\mathbf{q}} \\phi^{(1)}_j = J_j^\\mathsf{T}, \\quad \\nabla_{\\mathbf{p}} \\phi^{(1)}_j = \\mathbf{0} $$\n-   For secondary constraints $\\phi^{(2)}_j = J_j M^{-1} \\mathbf{p}$:\n    $$ \\nabla_{\\mathbf{q}} \\phi^{(2)}_j = H_j M^{-1} \\mathbf{p}, \\quad \\nabla_{\\mathbf{p}} \\phi^{(2)}_j = M^{-1} J_j^\\mathsf{T} $$\n    where $H_j = \\nabla_{\\mathbf{q}} \\nabla_{\\mathbf{q}}^\\mathsf{T} g_j$ is the Hessian matrix of $g_j$.\n\nThe invariant phase-space measure on the constraint surface is modified by a factor $\\sqrt{|\\det C|}$. This factor is related to the constraint geometry in configuration space, which is characterized by the Gram matrix $G(\\mathbf{q}) = J(\\mathbf{q}) M^{-1} J(\\mathbf{q})^\\mathsf{T}$. A key theoretical result, which this problem asks us to verify numerically, is that for this class of constraints, $\\det C = (\\det G)^2$. This implies that the ratio $R = \\sqrt{|\\det C|} / \\det G$ should be equal to $1$. The Fixman correction factor is defined as $F = \\sqrt{\\det G}$.\n\n**2. Constrained Equations of Motion**\n\nThe time evolution under constraints can be equivalently described using Lagrange multipliers. The equations of motion are:\n$$ \\dot{\\mathbf{q}} = M^{-1}\\mathbf{p} $$\n$$ \\dot{\\mathbf{p}} = -\\nabla_{\\mathbf{q}} V - J^\\mathsf{T} \\boldsymbol{\\lambda} $$\nThe multipliers $\\boldsymbol{\\lambda} \\in \\mathbb{R}^m$ are determined by requiring the constraints to be preserved over time, specifically $\\ddot{g}_j = 0$ for all $j=1,\\ldots,m$. Differentiating $\\dot{g}_j = J_j \\dot{\\mathbf{q}}$ with respect to time yields:\n$$ \\ddot{g}_j = \\dot{J}_j \\dot{\\mathbf{q}} + J_j \\ddot{\\mathbf{q}} = \\dot{\\mathbf{q}}^\\mathsf{T} H_j \\dot{\\mathbf{q}} + J_j M^{-1} \\dot{\\mathbf{p}} = 0 $$\nSubstituting the expression for $\\dot{\\mathbf{p}}$ leads to a linear system for $\\boldsymbol{\\lambda}$:\n$$ \\dot{\\mathbf{q}}^\\mathsf{T} H_j \\dot{\\mathbf{q}} + J_j M^{-1} (-\\nabla_{\\mathbf{q}} V - J^\\mathsf{T} \\boldsymbol{\\lambda}) = 0 $$\nThis can be written in matrix form as $G \\boldsymbol{\\lambda} = \\mathbf{b}$, where the components of vector $\\mathbf{b}$ are $b_j = \\dot{\\mathbf{q}}^\\mathsf{T} H_j \\dot{\\mathbf{q}} - J_j M^{-1} \\nabla_{\\mathbf{q}} V$. Solving this system yields the unique multipliers $\\boldsymbol{\\lambda}$ that enforce the constraints. The violation metric $V_{\\max}$ is the maximum absolute value of the computed constraint time derivatives $\\dot{g}_j$ and $\\ddot{g}_j$ at the given state. By construction, these should be zero up to numerical precision.\n\n### Algorithmic Design\n\nThe solution is implemented by a Python function that processes each test case according to the following steps:\n\n1.  **Initialization**: For a given test case ($N, d,$ masses, positions $\\mathbf{r}_i$, momenta $\\mathbf{p}_i$, constraints), the global phase-space vectors $\\mathbf{q}, \\mathbf{p}$ and the inverse mass matrix $M^{-1}$ are constructed.\n\n2.  **Geometric Object Construction**:\n    -   For each rigid bond constraint $g_j$ between particles $a$ and $b$, the corresponding row $J_j$ of the Jacobian is computed from $J_j = \\nabla_{\\mathbf{q}} g_j$. The particle-specific gradients are $\\nabla_{\\mathbf{r}_a} g_j = -(\\mathbf{r}_b - \\mathbf{r}_a)$ and $\\nabla_{\\mathbf{r}_b} g_j = (\\mathbf{r}_b - \\mathbf{r}_a)$.\n    -   The Hessian matrix $H_j = \\nabla_{\\mathbf{q}}\\nabla_{\\mathbf{q}}^\\mathsf{T} g_j$ is constructed. It consists of $d \\times d$ identity blocks $I_d$ and $-I_d$ at the blocks corresponding to particles $a$ and $b$.\n    -   The full Jacobian $J$ is assembled by stacking the rows $J_j$.\n\n3.  **Phase-Space Factor Calculation ($R, F$)**:\n    -   The Gram matrix is computed as $G = J M^{-1} J^\\mathsf{T}$.\n    -   Its determinant $\\det G$ is calculated, and the Fixman factor is found as $F = \\sqrt{\\det G}$.\n    -   The $2m \\times 2m$ Dirac matrix $C$ is built from first principles. The gradients of all $2m$ primary and secondary constraints are computed analytically. A nested loop iterates through all pairs $(\\phi_a, \\phi_b)$ and calculates $C_{ab} = \\{\\phi_a, \\phi_b\\}$ using the definition of the Poisson bracket.\n    -   The determinant $\\det C$ is computed, and the ratio $R = \\sqrt{|\\det C|} / \\det G$ is determined. This value is expected to be $1.0$.\n\n4.  **Constraint Violation Calculation ($V_{\\max}$)**:\n    -   The gradient of the potential $\\nabla_{\\mathbf{q}} V$ is evaluated at the given configuration $\\mathbf{q}$.\n    -   The vector $\\mathbf{b}$ for the Lagrange multiplier system is computed, with elements $b_j = (M^{-1}\\mathbf{p})^\\mathsf{T} H_j (M^{-1}\\mathbf{p}) - J_j M^{-1} \\nabla_{\\mathbf{q}} V$.\n    -   The linear system $G \\boldsymbol{\\lambda} = \\mathbf{b}$ is solved for the Lagrange multipliers $\\boldsymbol{\\lambda}$.\n    -   The primary constraint time derivatives $\\dot{\\mathbf{g}} = J M^{-1} \\mathbf{p}$ and secondary constraint time derivatives $\\ddot{\\mathbf{g}} = \\mathbf{b} - G \\boldsymbol{\\lambda}$ are computed.\n    -   The violation metric $V_{\\max}$ is the maximum absolute value found among all components of $\\dot{\\mathbf{g}}$ and $\\ddot{\\mathbf{g}}$.\n\nThis procedure is applied to each of the three test cases, and the resulting nine scalar values ($R, F, V_{\\max}$ for each case) are collected and formatted into the final output. The use of double-precision floating-point arithmetic and `numpy` for linear algebra ensures numerical stability and accuracy.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef compute_case_outputs(N, d, masses, r_coords, p_coords, constraints_info, potential_grad_func):\n    \"\"\"\n    Computes R, F, and V_max for a single test case.\n    \"\"\"\n    n_q = N * d\n    m = len(constraints_info)\n\n    # 1. Setup q, p, M_inv\n    q = np.array(r_coords, dtype=float).flatten()\n    p = np.array(p_coords, dtype=float).flatten()\n    \n    mass_vec = np.repeat(np.array(masses, dtype=float), d)\n    M_inv = np.diag(1.0 / mass_vec)\n\n    # 2. Build J and Hessians\n    J = np.zeros((m, n_q))\n    Hessians = []\n    \n    Id = np.eye(d)\n\n    for i, (p_a_idx, p_b_idx) in enumerate(constraints_info):\n        # Jacobian row for constraint i\n        r_a = q[d*p_a_idx : d*(p_a_idx+1)]\n        r_b = q[d*p_b_idx : d*(p_b_idx+1)]\n        r_ba = r_b - r_a\n        J[i, d*p_a_idx : d*(p_a_idx+1)] = -r_ba\n        J[i, d*p_b_idx : d*(p_b_idx+1)] = r_ba\n\n        # Hessian for constraint i\n        H = np.zeros((n_q, n_q))\n        H[d*p_a_idx:d*(p_a_idx+1), d*p_a_idx:d*(p_a_idx+1)] = Id\n        H[d*p_b_idx:d*(p_b_idx+1), d*p_b_idx:d*(p_b_idx+1)] = Id\n        H[d*p_a_idx:d*(p_a_idx+1), d*p_b_idx:d*(p_b_idx+1)] = -Id\n        H[d*p_b_idx:d*(p_b_idx+1), d*p_a_idx:d*(p_a_idx+1)] = -Id\n        Hessians.append(H)\n    \n    # 3. Calculate G, det_G, F\n    if m == 0:\n        det_G = 1.0\n    else:\n        G = J @ M_inv @ J.T\n        det_G = np.linalg.det(G)\n    \n    F = np.sqrt(det_G)\n    \n    # 4. Build Dirac Matrix C\n    C = np.zeros((2*m, 2*m))\n    \n    if m > 0:\n        grad_q_list = []\n        grad_p_list = []\n        \n        # Primary constraints (g_j)\n        for i in range(m):\n            grad_q_list.append(J[i].reshape(-1, 1))\n            grad_p_list.append(np.zeros((n_q, 1)))\n\n        # Secondary constraints (dg_j/dt)\n        for i in range(m):\n            grad_q_list.append(Hessians[i] @ M_inv @ p.reshape(-1, 1))\n            grad_p_list.append(M_inv @ J[i].reshape(-1, 1))\n            \n        for i in range(2*m):\n            for j in range(2*m):\n                grad_q_i = grad_q_list[i]\n                grad_p_i = grad_p_list[i]\n                grad_q_j = grad_q_list[j]\n                grad_p_j = grad_p_list[j]\n                \n                # C_ij = {phi_i, phi_j}\n                C[i, j] = (grad_q_i.T @ grad_p_j - grad_p_i.T @ grad_q_j)[0, 0]\n            \n    # 5. Calculate det_C and R\n    if m == 0:\n        det_C = 1.0\n        R = 1.0\n    else:\n        det_C = np.linalg.det(C)\n        if np.abs(det_G)  1e-15: # Avoid division by zero\n             R = np.inf if np.abs(det_C) > 1e-15 else 1.0\n        else:\n             R = np.sqrt(np.abs(det_C)) / det_G\n\n    # 6. Calculate V_max\n    if m == 0:\n        V_max = 0.0\n        return R, F, V_max\n\n    grad_V = potential_grad_func(q)\n    \n    b = np.zeros(m)\n    vel = M_inv @ p\n    for i in range(m):\n        term1 = vel.T @ Hessians[i] @ vel\n        term2 = J[i] @ M_inv @ grad_V\n        b[i] = term1 - term2\n    \n    lambdas = np.linalg.solve(G, b)\n    \n    # 7. Compute violations\n    g_dot = J @ M_inv @ p\n    g_ddot = b - G @ lambdas\n    \n    V_max = np.max(np.abs(np.concatenate((g_dot, g_ddot))))\n\n    return R, F, V_max\n\ndef solve():\n    \"\"\"\n    Defines test cases and computes the required outputs for each.\n    \"\"\"\n    d = 2\n\n    test_cases = [\n        {\n            \"name\": \"A\",\n            \"N\": 2,\n            \"masses\": [1.0, 2.0],\n            \"r_coords\": [[0.0, 0.0], [1.0, 0.0]],\n            \"p_coords\": [[0.0, 0.3], [0.0, -0.4]],\n            \"constraints_info\": [(0, 1)], # particle indices\n            \"potential_grad_func\": lambda q: 0.7 * q\n        },\n        {\n            \"name\": \"B\",\n            \"N\": 3,\n            \"masses\": [1.0, 1.0, 1.0],\n            \"r_coords\": [[0.0, 0.0], [1.0, 0.5], [2.1, 0.1]],\n            \"p_coords\": [[0.0, 1.0], [0.0, 1.0], [0.0, 1.0]],\n            \"constraints_info\": [(0, 1), (1, 2)],\n            \"potential_grad_func\": lambda q: np.zeros_like(q)\n        },\n        {\n            \"name\": \"C\",\n            \"N\": 2,\n            \"masses\": [1.0, 1e6],\n            \"r_coords\": [[0.0, 0.0], [1.0, 0.0]],\n            \"p_coords\": [[0.0, 0.2], [0.0, -0.2]],\n            \"constraints_info\": [(0, 1)],\n            \"potential_grad_func\": lambda q: np.zeros_like(q)\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        R, F, V_max = compute_case_outputs(\n            case[\"N\"],\n            d,\n            case[\"masses\"],\n            case[\"r_coords\"],\n            case[\"p_coords\"],\n            case[\"constraints_info\"],\n            case[\"potential_grad_func\"]\n        )\n        results.extend([R, F, V_max])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{x:.16e}' for x in results)}]\")\n\nsolve()\n```"
        }
    ]
}