{
    "hands_on_practices": [
        {
            "introduction": "Estimating the diffusion coefficient from a finite-length trajectory is a foundational task in molecular dynamics, yet it is fraught with statistical challenges. A naive Mean Squared Displacement (MSD) calculation using a single time origin is statistically inefficient. This practice delves into the \"multiple time origin\" method, a standard technique to improve the precision of MSD estimates by averaging over all possible starting points in a trajectory . By analytically deriving the reduction in variance, you will gain a deeper understanding of the trade-off between statistical accuracy and the length of the lag time, a crucial consideration for any diffusion analysis.",
            "id": "3408216",
            "problem": "Consider a single particle undergoing overdamped Langevin dynamics in $d$ spatial dimensions, sampled at discrete times $t_{n} = n \\Delta t$ for $n = 0, 1, \\dots, N$. The position $\\mathbf{r}_{n}$ evolves according to $\\mathbf{r}_{n} = \\mathbf{r}_{n-1} + \\boldsymbol{\\xi}_{n}$, where the increments $\\boldsymbol{\\xi}_{n}$ are independent and identically distributed Gaussian random vectors with zero mean and covariance $\\langle \\boldsymbol{\\xi}_{n} \\boldsymbol{\\xi}_{n}^{\\top} \\rangle = 2 D \\Delta t \\, \\mathbf{I}_{d}$, with $D$ the diffusion coefficient and $\\mathbf{I}_{d}$ the $d \\times d$ identity matrix. For a fixed lag time $\\tau = k \\Delta t$ with a positive integer $k$, define the displacement over $k$ steps started at frame $i$ as $\\Delta \\mathbf{r}_{i,k} = \\mathbf{r}_{i+k} - \\mathbf{r}_{i}$ and its squared magnitude $S_{i} = \\|\\Delta \\mathbf{r}_{i,k}\\|^{2}$. The Mean Squared Displacement (MSD) at lag $\\tau$ is estimated in two ways:\n\n- Single-origin estimator: $\\widehat{\\mathrm{MSD}}_{1}(\\tau) = S_{0}$.\n- Multiple time origin estimator: $\\widehat{\\mathrm{MSD}}_{M}(\\tau) = \\frac{1}{M} \\sum_{i=0}^{M-1} S_{i}$, where $M = N - k + 1$ and the sum runs over all valid time origins.\n\nStarting only from the definitions above and standard properties of Gaussian random variables, do the following:\n\n1. Explain the rationale behind the multiple time origin averaging in terms of variance reduction for the MSD at fixed lag time $\\tau$.\n2. Derive, in closed form, the ratio of variances $\\mathrm{Var}[\\widehat{\\mathrm{MSD}}_{M}(\\tau)] / \\mathrm{Var}[\\widehat{\\mathrm{MSD}}_{1}(\\tau)]$ under the stated model assumptions, carefully accounting for the correlation between overlapping time windows. Assume $M \\geq k$ so that all lags considered overlap with the initial window.\n3. Discuss, based on your derivation, the trade-off between increasing the lag time (larger $k$) and the number of available time origins $M$ for the precision of MSD estimation, and the implications for estimating the diffusion coefficient via the Einstein relation $\\widehat{D}(\\tau) = \\widehat{\\mathrm{MSD}}(\\tau)/(2 d \\tau)$.\n\nYour final answer must be the single analytic expression you obtain for the variance ratio in item 2. No numerical evaluation is required. Do not include any units in the final expression.",
            "solution": "This problem requires a multi-part analysis of Mean Squared Displacement (MSD) estimators for a particle undergoing discrete-time Brownian motion. We will first explain the rationale for multiple time origin averaging, then derive the variance ratio of two MSD estimators, and finally discuss the trade-offs involved in choosing the lag time.\n\n### Part 1: Rationale for Multiple Time Origin Averaging\n\nThe Mean Squared Displacement (MSD) at a lag time $\\tau$ is formally the expectation of the squared displacement, $\\mathrm{MSD}(\\tau) = \\mathbb{E}[S_i]$. Both estimators, $\\widehat{\\mathrm{MSD}}_{1}$ and $\\widehat{\\mathrm{MSD}}_{M}$, are designed to estimate this quantity from a finite-time trajectory.\n\nThe displacement vector $\\Delta \\mathbf{r}_{i,k}$ is a sum of i.i.d. zero-mean Gaussian variables, and thus is itself a zero-mean Gaussian variable. Its covariance is $\\mathbb{E}[\\Delta \\mathbf{r}_{i,k} \\Delta \\mathbf{r}_{i,k}^\\top] = 2D\\tau \\mathbf{I}_d$. The expectation of the squared displacement $S_i$ is identical for all starting times $i$: $\\mathbb{E}[S_i] = \\mathbb{E}[\\|\\Delta \\mathbf{r}_{i,k}\\|^2] = \\mathrm{Tr}(2D\\tau \\mathbf{I}_d) = 2dD\\tau = \\mathrm{MSD}(\\tau)$.\nConsequently, both estimators are unbiased:\n$$ \\mathbb{E}[\\widehat{\\mathrm{MSD}}_{1}(\\tau)] = \\mathbb{E}[S_0] = \\mathrm{MSD}(\\tau) $$\n$$ \\mathbb{E}[\\widehat{\\mathrm{MSD}}_{M}(\\tau)] = \\mathbb{E}\\left[\\frac{1}{M} \\sum_{i=0}^{M-1} S_i\\right] = \\frac{1}{M} \\sum_{i=0}^{M-1} \\mathbb{E}[S_i] = \\frac{1}{M} (M \\cdot \\mathrm{MSD}(\\tau)) = \\mathrm{MSD}(\\tau) $$\nSince both estimators are unbiased, their quality is compared based on their variance, which measures the spread of the estimates around the true mean. A smaller variance indicates higher precision.\n\nThe single-origin estimator $\\widehat{\\mathrm{MSD}}_{1} = S_0$ uses only one realization of the random variable $S_i$. The multiple time origin estimator $\\widehat{\\mathrm{MSD}}_{M}$ is a sample mean of $M$ such random variables, $S_0, S_1, \\dots, S_{M-1}$. According to the principles of statistical estimation (related to the Law of Large Numbers), averaging over multiple samples of a random process provides a better estimate of its mean. Even though the samples $S_i$ are not independent (due to overlapping time windows for $\\Delta \\mathbf{r}_{i,k}$ and $\\Delta \\mathbf{r}_{j,k}$ when $|i-j|k$), the averaging process still reduces the variance of the estimator as long as the samples are not perfectly correlated. By using all possible time origins in the trajectory, one leverages the available data maximally to reduce the statistical uncertainty (variance) of the estimate.\n\n### Part 2: Derivation of the Variance Ratio\n\nWe aim to compute the ratio $R = \\mathrm{Var}[\\widehat{\\mathrm{MSD}}_{M}(\\tau)] / \\mathrm{Var}[\\widehat{\\mathrm{MSD}}_{1}(\\tau)]$.\n\n**Denominator: $\\mathrm{Var}[\\widehat{\\mathrm{MSD}}_{1}(\\tau)] = \\mathrm{Var}[S_0]$**\nThe displacement $\\Delta \\mathbf{r}_{0,k}$ is a $d$-dimensional Gaussian vector with mean $\\mathbf{0}$ and covariance matrix $2D\\tau \\mathbf{I}_d$. Let its components be $X_p \\sim \\mathcal{N}(0, 2D\\tau)$ for $p=1, \\dots, d$.\n$S_0 = \\|\\Delta \\mathbf{r}_{0,k}\\|^2 = \\sum_{p=1}^d X_p^2$.\nSince the components $X_p$ are independent, the variance of the sum is the sum of the variances:\n$\\mathrm{Var}[S_0] = \\sum_{p=1}^d \\mathrm{Var}[X_p^2]$.\nFor a centered Gaussian variable $X$ with variance $\\sigma^2$, $\\mathrm{Var}[X^2] = \\mathbb{E}[X^4] - (\\mathbb{E}[X^2])^2 = 3(\\sigma^2)^2 - (\\sigma^2)^2 = 2(\\sigma^2)^2$.\nHere, $\\sigma^2 = 2D\\tau$. Thus, $\\mathrm{Var}[X_p^2] = 2(2D\\tau)^2$.\nTherefore, the variance of the single-origin estimator is:\n$$ \\mathrm{Var}[\\widehat{\\mathrm{MSD}}_{1}(\\tau)] = \\mathrm{Var}[S_0] = \\sum_{p=1}^d 2(2D\\tau)^2 = 2d(2D\\tau)^2 $$\n\n**Numerator: $\\mathrm{Var}[\\widehat{\\mathrm{MSD}}_{M}(\\tau)]$**\nThe variance of the multiple time origin estimator is:\n$$ \\mathrm{Var}[\\widehat{\\mathrm{MSD}}_{M}(\\tau)] = \\mathrm{Var}\\left[\\frac{1}{M} \\sum_{i=0}^{M-1} S_i\\right] = \\frac{1}{M^2} \\sum_{i=0}^{M-1} \\sum_{j=0}^{M-1} \\mathrm{Cov}(S_i, S_j) $$\nThe covariance can be expressed using the property for quadratic forms of zero-mean Gaussian vectors: $\\mathrm{Cov}(\\|\\mathbf{X}\\|^2, \\|\\mathbf{Y}\\|^2) = 2 \\mathrm{Tr}(\\mathrm{Cov}(\\mathbf{X}, \\mathbf{Y})^2)$.\nLet $\\mathbf{C}_{ij} = \\mathbb{E}[\\Delta \\mathbf{r}_{i,k} \\Delta \\mathbf{r}_{j,k}^\\top]$. Then $\\mathrm{Cov}(S_i, S_j) = 2 \\mathrm{Tr}(\\mathbf{C}_{ij}^2)$.\nLet's compute $\\mathbf{C}_{ij}$:\n$\\Delta \\mathbf{r}_{i,k} = \\sum_{p=i+1}^{i+k} \\boldsymbol{\\xi}_p$.\n$\\mathbf{C}_{ij} = \\mathbb{E}\\left[ \\left(\\sum_{p=i+1}^{i+k} \\boldsymbol{\\xi}_p\\right) \\left(\\sum_{q=j+1}^{j+k} \\boldsymbol{\\xi}_q^\\top\\right) \\right] = \\sum_{p=i+1}^{i+k} \\sum_{q=j+1}^{j+k} \\mathbb{E}[\\boldsymbol{\\xi}_p \\boldsymbol{\\xi}_q^\\top]$.\nUsing $\\mathbb{E}[\\boldsymbol{\\xi}_p \\boldsymbol{\\xi}_q^\\top] = \\delta_{pq} (2D\\Delta t \\mathbf{I}_d)$, the sum is non-zero only for common indices $p=q$. The number of overlapping steps for windows starting at $i$ and $j$ (let $m=|i-j|  k$) is $k-m$.\n$$ \\mathbf{C}_{ij} = (k - |i-j|) (2D\\Delta t) \\mathbf{I}_d = \\frac{k - |i-j|}{k} (2Dk\\Delta t) \\mathbf{I}_d = \\left(1-\\frac{|i-j|}{k}\\right) (2D\\tau) \\mathbf{I}_d $$\nfor $|i-j|  k$, and $\\mathbf{C}_{ij}=0$ otherwise.\nNow we compute $\\mathrm{Cov}(S_i, S_j)$:\n$$ \\mathrm{Cov}(S_i, S_j) = 2 \\mathrm{Tr}\\left( \\left(1-\\frac{|i-j|}{k}\\right)^2 (2D\\tau)^2 \\mathbf{I}_d \\right) = 2d(2D\\tau)^2 \\left(1-\\frac{|i-j|}{k}\\right)^2 $$\nThis is the covariance for a lag $m=|i-j|k$. Note that for $m=0$, this gives $\\mathrm{Var}(S_i) = 2d(2D\\tau)^2$, matching our earlier result.\n\nThe double summation for the variance can be converted to a single sum over the lag $m=j-i$:\n$$ \\mathrm{Var}[\\widehat{\\mathrm{MSD}}_{M}] = \\frac{1}{M^2} \\sum_{m=-(M-1)}^{M-1} (M-|m|) \\mathrm{Cov}(S_0, S_m) $$\nSince the covariance is zero for $|m|\\geq k$, and we assumed $M \\geq k$, the sum runs from $m=-(k-1)$ to $k-1$:\n$$ \\mathrm{Var}[\\widehat{\\mathrm{MSD}}_{M}] = \\frac{1}{M^2} \\left( M \\cdot \\mathrm{Var}(S_0) + 2 \\sum_{m=1}^{k-1} (M-m) \\mathrm{Cov}(S_0, S_m) \\right) $$\nThe ratio $R$ is:\n$$ R = \\frac{\\mathrm{Var}[\\widehat{\\mathrm{MSD}}_{M}]}{\\mathrm{Var}[S_0]} = \\frac{1}{M} + \\frac{2}{M^2} \\sum_{m=1}^{k-1} (M-m) \\frac{\\mathrm{Cov}(S_0, S_m)}{\\mathrm{Var}(S_0)} $$\nThe correlation coefficient is $\\rho(m) = \\frac{\\mathrm{Cov}(S_0, S_m)}{\\mathrm{Var}(S_0)} = \\left(1-\\frac{m}{k}\\right)^2$.\n$$ R = \\frac{1}{M} \\left( 1 + \\frac{2}{M} \\sum_{m=1}^{k-1} (M-m) \\left(1-\\frac{m}{k}\\right)^2 \\right) = \\frac{1}{M} \\left( 1 + 2 \\sum_{m=1}^{k-1} \\left(1-\\frac{m}{M}\\right) \\left(1-\\frac{m}{k}\\right)^2 \\right) $$\nLet's evaluate the sum $S' = \\sum_{m=1}^{k-1} (1-\\frac{m}{M})(1-\\frac{m}{k})^2$:\n$$ S' = \\sum_{m=1}^{k-1} \\left( 1 - \\left(\\frac{2}{k} + \\frac{1}{M}\\right)m + \\left(\\frac{1}{k^2} + \\frac{2}{Mk}\\right)m^2 - \\frac{1}{Mk^2}m^3 \\right) $$\nUsing Faulhaber's formulas for sums of powers up to $n=k-1$: $\\sum 1 = k-1$, $\\sum m = \\frac{(k-1)k}{2}$, $\\sum m^2 = \\frac{(k-1)k(2k-1)}{6}$, $\\sum m^3 = \\frac{(k-1)^2k^2}{4}$.\nSubstituting and simplifying leads to:\n$$ S' = (k-1) - \\left(\\frac{2}{k} + \\frac{1}{M}\\right)\\frac{(k-1)k}{2} + \\left(\\frac{1}{k^2} + \\frac{2}{Mk}\\right)\\frac{(k-1)k(2k-1)}{6} - \\frac{1}{Mk^2}\\frac{(k-1)^2k^2}{4} $$\nAfter careful algebraic simplification, this becomes:\n$$ S' = \\frac{(k-1)(2k-1)}{6k} - \\frac{k^2-1}{12M} $$\nNow we substitute $S'$ back into the expression for the ratio $R$:\n$$ R = \\frac{1}{M} \\left( 1 + 2S' \\right) = \\frac{1}{M} \\left( 1 + 2\\left[ \\frac{(k-1)(2k-1)}{6k} - \\frac{k^2-1}{12M} \\right] \\right) $$\n$$ R = \\frac{1}{M} \\left( 1 + \\frac{(k-1)(2k-1)}{3k} - \\frac{k^2-1}{6M} \\right) $$\nCombining the first two terms in the parenthesis:\n$ 1 + \\frac{2k^2-3k+1}{3k} = \\frac{3k + 2k^2-3k+1}{3k} = \\frac{2k^2+1}{3k} $.\nSo the ratio becomes:\n$$ R = \\frac{1}{M} \\left( \\frac{2k^2+1}{3k} - \\frac{k^2-1}{6M} \\right) = \\frac{2k^2+1}{3kM} - \\frac{k^2-1}{6M^2} $$\nThis is the final closed-form expression for the variance ratio.\n\n### Part 3: Discussion of Trade-offs\n\nThe precision of the diffusion coefficient estimate, $\\widehat{D}(\\tau) = \\widehat{\\mathrm{MSD}}(\\tau)/(2d\\tau)$, is inversely related to its variance, $\\mathrm{Var}[\\widehat{D}(\\tau)]$.\n$$ \\mathrm{Var}[\\widehat{D}(\\tau)] = \\frac{\\mathrm{Var}[\\widehat{\\mathrm{MSD}}(\\tau)]}{(2d\\tau)^2} = \\frac{\\mathrm{Var}[\\widehat{\\mathrm{MSD}}_1(\\tau)]}{(2d k \\Delta t)^2} \\times R = \\frac{2d(2Dk\\Delta t)^2}{(2dk\\Delta t)^2} \\times R = \\frac{2D^2}{d} R $$\nThus, minimizing the variance of the $\\widehat{D}$ estimate is equivalent to minimizing the ratio $R(k, M)$, where $M = N-k+1$.\n$$ R(k) = \\frac{2k^2+1}{3k(N-k+1)} - \\frac{k^2-1}{6(N-k+1)^2} $$\nThe choice of the lag time parameter $k$ involves a critical trade-off:\n\n1.  **Effect of Increasing $k$ (Longer Lag Times)**:\n    -   It reduces the number of available time origins, $M=N-k+1$, which tends to increase statistical error.\n    -   It increases the correlation between subsequent squared displacements $S_i$ and $S_{i+1}$, as the fractional overlap of their time windows, $(k-1)/k$, approaches $1$. This makes the multiple-origin averaging less effective at reducing variance.\n    -   For $k \\ll N$, $M \\approx N$, and the ratio $R \\approx \\frac{2k^2+1}{3kN} \\approx \\frac{2k}{3N}$. In this limit, the variance of $\\widehat{D}$ is proportional to $k$. This suggests that for purely statistical reasons within this idealized model, one should choose the smallest possible $k$ to achieve the highest precision.\n\n2.  **Effect of Decreasing $k$ (Shorter Lag Times)**:\n    -   It maximizes the number of statistical samples, $M$, enhancing the variance reduction from averaging. For $k=1$, the displacements are i.i.d., and $R = 1/M$, yielding the standard variance for the mean of independent samples.\n    -   This leads to the most statistically precise estimate of the diffusion coefficient *for the given model*.\n\n**The Trade-off and Practical Implications**:\nThe derived result, showing that the variance of $\\widehat{D}$ is minimized at small $k$, is specific to the idealized model of pure Brownian motion where the Einstein relation holds for all $\\tau  0$. In real physical systems studied via molecular dynamics, this is often not the case.\n\n-   **Short-time non-diffusive behavior**: At very short times, particle motion can be \"ballistic\" (MSD $\\propto t^2$) due to inertia, or \"caged\" by surrounding particles. The linear, diffusive regime (MSD $\\propto t$) only emerges at longer lag times. Therefore, $k$ must be chosen large enough so that $\\tau = k\\Delta t$ falls within this scientifically relevant diffusive regime. Using a very small $k$ would lead to a systematic error, calculating a \"diffusion coefficient\" from a non-diffusive part of the trajectory.\n-   **Statistical Precision vs. Systematic Accuracy**: There is a conflict between statistical precision (which favors small $k$) and systematic accuracy (which requires $k$ to be large enough to probe the correct physical regime). A common practice is to calculate $\\widehat{D}(\\tau)$ for a range of $\\tau$ values and identify a \"plateau\" where $\\widehat{D}(\\tau)$ is reasonably constant. The optimal estimate for $D$ is then taken from this plateau region. The optimal choice of $k$ would be the smallest value that is clearly in this diffusive plateau, as this provides the best compromise between minimizing systematic and statistical errors.\n\nIn summary, while the pure mathematical model suggests using the smallest possible $k$, physical reality dictates that $k$ must be large enough to avoid modeling artifacts from short-time dynamics. The optimal strategy balances these competing requirements.",
            "answer": "$$ \\boxed{\\frac{2k^2+1}{3kM} - \\frac{k^2-1}{6M^2}} $$"
        },
        {
            "introduction": "The classic linear relationship, $\\langle \\Delta x^2 \\rangle(t) = 2Dt$, holds true for unrestricted diffusion in an infinite medium, but physical systems are often confined. In environments like nanopores, particle motion is restricted by boundaries, causing the MSD to saturate and deviate from linear growth, which obscures the intrinsic bulk diffusion coefficient. This exercise demonstrates how to overcome this challenge by applying the method of images—a powerful analytical tool—to model diffusion with reflecting walls . You will derive a correction for these boundary effects and use it to recover the true bulk diffusion coefficient from early-time simulation data, a common task in the study of transport in nanomaterials.",
            "id": "3464978",
            "problem": "A molecular dynamics simulation tracks the one-dimensional coordinate $x$ of a tracer molecule across a slit nanopore of width $L$, with reflecting walls at $x=0$ and $x=L$. Along the confined direction, the long-time Mean Squared Displacement (MSD) saturates to $\\langle \\Delta x^{2} \\rangle \\to L^{2}/6$ due to confinement. You are asked to recover the bulk diffusion coefficient $D$ (that would be measured in the absence of confinement) from early-time data, when $t \\ll L^{2}/D$.\n\nStarting from the diffusion equation $\\partial_{t} P(x,t|x_{0}) = D \\partial_{x}^{2} P(x,t|x_{0})$ with reflecting (Neumann) boundary conditions at $x=0$ and $x=L$, use the method of images to derive the early-time asymptotic expansion of the ensemble-averaged MSD across the slit, defined as $\\langle \\Delta x^{2} \\rangle(t) = \\langle \\left(x(t)-x(0)\\right)^{2} \\rangle$ with the average taken over a uniform initial distribution of $x(0)$ in $[0,L]$. Retain terms through the first nontrivial correction beyond free diffusion and explicitly identify the scaling with $D$, $t$, and $L$.\n\nThen, using your asymptotic form, construct a two-time combination of MSD values that eliminates the leading-order boundary correction and yields an estimator for $D$ in terms of two measured early-time MSDs, $\\langle \\Delta x^{2} \\rangle(t_{1})$ and $\\langle \\Delta x^{2} \\rangle(t_{2})$, at times $t_{1}$ and $t_{2}$.\n\nFinally, evaluate $D$ numerically from the following early-time data obtained along the confined direction in a slit of width $L=20\\,\\mathrm{nm}$:\n- $t_{1} = 1.0\\,\\mathrm{ns}$ with $\\langle \\Delta x^{2} \\rangle(t_{1}) = 0.44340468\\,\\mathrm{nm}^{2}$,\n- $t_{2} = 4.0\\,\\mathrm{ns}$ with $\\langle \\Delta x^{2} \\rangle(t_{2}) = 1.70723656\\,\\mathrm{nm}^{2}$.\n\nRound your final numerical value of $D$ to four significant figures. Express the final answer in $\\mathrm{nm}^{2}\\,\\mathrm{ns}^{-1}$.",
            "solution": "## Solution\nThe problem requires deriving the bulk diffusion coefficient $D$ from early-time Mean Squared Displacement (MSD) data in a confined system. This is achieved by first deriving the early-time asymptotic form of the MSD, then constructing an estimator for $D$, and finally applying this estimator to the given data.\n\n### Part 1: Early-Time Asymptotic Expansion of the MSD\nThe MSD, averaged over a uniform initial distribution of starting positions $x_0 = x(0)$ in the interval $[0,L]$, is given by\n$$ \\langle \\Delta x^{2} \\rangle(t) = \\int_0^L \\frac{1}{L} \\langle(x(t)-x_0)^2\\rangle_{x_0} dx_0 $$\nwhere $\\langle(\\cdot)\\rangle_{x_0}$ denotes the average over all trajectories starting from $x_0$.\n\nFor a particle undergoing diffusion in one dimension bounded by a single reflecting wall at $x=0$, the MSD for a trajectory starting at $x_0$ is known to be:\n$$ \\langle(x(t)-x_0)^2\\rangle_{x_0, \\text{wall at 0}} = 2Dt - 2\\sqrt{4Dt} \\cdot x_0 \\cdot \\text{ierfc}\\left(\\frac{x_0}{\\sqrt{4Dt}}\\right) $$\nwhere $\\text{ierfc}(z) = \\int_z^\\infty \\text{erfc}(y)dy = \\frac{1}{\\sqrt{\\pi}}\\exp(-z^2) - z \\cdot \\text{erfc}(z)$ is the integrated complementary error function.\n\nIn the early-time regime ($t \\ll L^2/D$), the diffusion length $\\sqrt{Dt}$ is much smaller than the slit width $L$. In this limit, the effects of the two walls at $x=0$ and $x=L$ on a particle starting at $x_0$ can be treated as additive. The effect of the wall at $x=L$ is equivalent to that of a wall at $x=0$ for a particle starting at a distance $L-x_0$. Therefore, the conditional MSD in the slit is approximated by:\n$$ \\langle(x(t)-x_0)^2\\rangle_{x_0} \\approx 2Dt - 2\\sqrt{4Dt} \\left[ x_0 \\cdot \\text{ierfc}\\left(\\frac{x_0}{\\sqrt{4Dt}}\\right) + (L-x_0) \\cdot \\text{ierfc}\\left(\\frac{L-x_0}{\\sqrt{4Dt}}\\right) \\right] $$\nTo find the ensemble-averaged MSD, we integrate this expression over $x_0$ from $0$ to $L$:\n$$ \\langle \\Delta x^{2} \\rangle(t) \\approx 2Dt - \\frac{2\\sqrt{4Dt}}{L} \\int_0^L \\left[ x_0 \\cdot \\text{ierfc}\\left(\\frac{x_0}{\\sqrt{4Dt}}\\right) + (L-x_0) \\cdot \\text{ierfc}\\left(\\frac{L-x_0}{\\sqrt{4Dt}}\\right) \\right] dx_0 $$\nBy a change of variables $y_0 = L-x_0$, the second part of the integral is shown to be identical to the first:\n$$ \\int_0^L (L-x_0) \\cdot \\text{ierfc}\\left(\\frac{L-x_0}{\\sqrt{4Dt}}\\right) dx_0 = \\int_0^L y_0 \\cdot \\text{ierfc}\\left(\\frac{y_0}{\\sqrt{4Dt}}\\right) dy_0 $$\nThus, the expression simplifies to:\n$$ \\langle \\Delta x^{2} \\rangle(t) \\approx 2Dt - \\frac{4\\sqrt{4Dt}}{L} \\int_0^L x_0 \\cdot \\text{ierfc}\\left(\\frac{x_0}{\\sqrt{4Dt}}\\right) dx_0 $$\nWe evaluate the integral in the early-time limit. Let $z = x_0/\\sqrt{4Dt}$, so $x_0 = z\\sqrt{4Dt}$ and $dx_0 = \\sqrt{4Dt} dz$. The upper integration limit becomes $L/\\sqrt{4Dt}$, which goes to $\\infty$ as $t \\to 0$.\n$$ \\int_0^L x_0 \\cdot \\text{ierfc}\\left(\\frac{x_0}{\\sqrt{4Dt}}\\right) dx_0 \\approx \\int_0^\\infty (z\\sqrt{4Dt}) \\cdot \\text{ierfc}(z) \\cdot (\\sqrt{4Dt} dz) = 4Dt \\int_0^\\infty z \\cdot \\text{ierfc}(z) dz $$\nThe definite integral $\\int_0^\\infty z \\cdot \\text{ierfc}(z) dz$ can be solved using integration by parts, noting that $\\frac{d}{dz}\\text{ierfc}(z) = -\\text{erfc}(z)$:\n$$ \\int_0^\\infty z \\cdot \\text{ierfc}(z) dz = \\int_0^\\infty z \\left(\\int_z^\\infty \\text{erfc}(y) dy\\right) dz $$\nChanging the order of integration:\n$$ \\int_0^\\infty \\text{erfc}(y) \\left(\\int_0^y z dz\\right) dy = \\frac{1}{2} \\int_0^\\infty y^2 \\text{erfc}(y) dy $$\nThis integral is a known result, $\\int_0^\\infty y^2 \\text{erfc}(y) dy = 1/(3\\sqrt{\\pi})$.\nTherefore, $\\int_0^\\infty z \\cdot \\text{ierfc}(z) dz = \\frac{1}{6\\sqrt{\\pi}}$.\nSubstituting this back, we get:\n$$ \\int_0^L x_0 \\cdot \\text{ierfc}\\left(\\frac{x_0}{\\sqrt{4Dt}}\\right) dx_0 \\approx 4Dt \\cdot \\frac{1}{6\\sqrt{\\pi}} = \\frac{2Dt}{3\\sqrt{\\pi}} $$\nThe correction term in the MSD is:\n$$ - \\frac{4\\sqrt{4Dt}}{L} \\left(\\frac{2Dt}{3\\sqrt{\\pi}}\\right) = -\\frac{8 \\cdot 2\\sqrt{Dt}}{L} \\frac{Dt}{3\\sqrt{\\pi}} = - \\frac{16 (Dt)^{3/2}}{3L\\sqrt{\\pi}} $$\nThe early-time asymptotic expansion for the MSD is thus:\n$$ \\langle \\Delta x^{2} \\rangle(t) = 2Dt - \\frac{16 D^{3/2}}{3L\\sqrt{\\pi}} t^{3/2} + \\dots $$\nThis expression has the form $\\langle \\Delta x^{2} \\rangle(t) = At - Bt^{3/2}$, where the leading term $At = 2Dt$ corresponds to free diffusion and the term $-Bt^{3/2}$ is the first nontrivial correction due to boundary reflections. The scaling is explicitly $D^{3/2}$, $t^{3/2}$, and $L^{-1}$.\n\n### Part 2: Construction of the Estimator for D\nWe have two measurements, $f(t_1) = \\langle \\Delta x^{2} \\rangle(t_{1})$ and $f(t_2) = \\langle \\Delta x^{2} \\rangle(t_{2})$, at two different early times $t_1$ and $t_2$. Using the derived asymptotic form:\n$$ f(t_1) = 2Dt_1 - B t_1^{3/2} \\quad (1) $$\n$$ f(t_2) = 2Dt_2 - B t_2^{3/2} \\quad (2) $$\nwhere $B = \\frac{16 D^{3/2}}{3L\\sqrt{\\pi}}$. Our goal is to eliminate $B$ and solve for $D$.\nFrom equation (1), we can express $B$ as:\n$$ B = \\frac{2Dt_1 - f(t_1)}{t_1^{3/2}} $$\nSubstitute this into equation (2):\n$$ f(t_2) = 2Dt_2 - \\left(\\frac{2Dt_1 - f(t_1)}{t_1^{3/2}}\\right) t_2^{3/2} $$\n$$ f(t_2) = 2Dt_2 - (2Dt_1 - f(t_1)) \\left(\\frac{t_2}{t_1}\\right)^{3/2} $$\nNow, we group terms with $D$:\n$$ f(t_2) - f(t_1) \\left(\\frac{t_2}{t_1}\\right)^{3/2} = 2Dt_2 - 2Dt_1 \\left(\\frac{t_2}{t_1}\\right)^{3/2} $$\n$$ f(t_2) - f(t_1) \\left(\\frac{t_2}{t_1}\\right)^{3/2} = 2D \\left[t_2 - t_1 \\left(\\frac{t_2}{t_1}\\right)^{3/2}\\right] $$\nSolving for $D$ gives the estimator:\n$$ D = \\frac{f(t_2) - f(t_1) \\left(\\frac{t_2}{t_1}\\right)^{3/2}}{2 \\left[t_2 - t_1 \\left(\\frac{t_2}{t_1}\\right)^{3/2}\\right]} $$\n\n### Part 3: Numerical Evaluation of D\nWe now apply this formula to the given data:\n- $t_{1} = 1.0\\,\\mathrm{ns}$\n- $f(t_{1}) = 0.44340468\\,\\mathrm{nm}^{2}$\n- $t_{2} = 4.0\\,\\mathrm{ns}$\n- $f(t_{2}) = 1.70723656\\,\\mathrm{nm}^{2}$\n\nFirst, we compute the time ratio-dependent term:\n$$ \\left(\\frac{t_2}{t_1}\\right)^{3/2} = \\left(\\frac{4.0}{1.0}\\right)^{3/2} = 4^{3/2} = (4^{1/2})^3 = 2^3 = 8 $$\nNow, substitute the values into the estimator for $D$:\n$$ D = \\frac{1.70723656 - (0.44340468) \\cdot 8}{2 [4.0 - (1.0) \\cdot 8]} $$\n$$ D = \\frac{1.70723656 - 3.54723744}{2 [4.0 - 8.0]} $$\n$$ D = \\frac{-1.84000088}{2(-4.0)} $$\n$$ D = \\frac{-1.84000088}{-8.0} $$\n$$ D = 0.23000011\\,\\mathrm{nm}^{2}\\,\\mathrm{ns}^{-1} $$\nRounding the result to four significant figures, we get:\n$$ D \\approx 0.2300\\,\\mathrm{nm}^{2}\\,\\mathrm{ns}^{-1} $$\nAll units are consistent, so no conversion is needed.",
            "answer": "$$\n\\boxed{0.2300}\n$$"
        },
        {
            "introduction": "In many materials, particularly crystals with low symmetry, assuming diffusion is isotropic (the same in all directions) is an oversimplification. Transport properties are often directional, requiring a more sophisticated description than a single scalar diffusion coefficient, $D$. This hands-on computational problem guides you through the process of calculating the full anisotropic diffusion tensor, $\\mathbf{D}$ . By analyzing simulated trajectories within a non-orthogonal crystal basis and transforming the results back to a Cartesian frame, you will learn to determine the principal axes and coefficients of diffusion, providing a complete picture of transport in complex, anisotropic media.",
            "id": "3465044",
            "problem": "Consider a crystalline solid with low symmetry, where diffusion is anisotropic. Let the anisotropic diffusion be modeled as a stationary Gaussian process for particle displacements in three-dimensional Cartesian space, with a positive-definite diffusion tensor $\\mathbf{D}$ such that the displacement increments over a time step $\\Delta t$ are independent and identically distributed across steps and particles, and the second-moment tensor of total displacements grows linearly in time. You will compute the anisotropic diffusion tensor $\\mathbf{D}$ from the time-dependent second moment of displacements, but crucially, you must perform the estimation in a non-orthogonal crystal lattice basis and then rotate back to Cartesian coordinates to obtain principal axes. You will also test the frame-invariance of the estimated $\\mathbf{D}$ under a change of measurement frame.\n\nFundamental base: Begin from the definition of the mean squared displacement in three dimensions as the second moment of the displacement $\\Delta \\mathbf{r}(t)$, and the observation that for diffusion processes described by the diffusion equation in three dimensions, the growth of the second-moment tensor is linear in time for sufficiently large $t$. For anisotropic diffusion, the symmetric diffusion tensor $\\mathbf{D}$ characterizes this linear growth. You must not assume any shortcut formulas in your implementation; instead, directly estimate the linear time dependence from the trajectory data by regressing the second moment tensor components on time. Use the non-orthogonal lattice basis to form displacement coefficients and then transform back to Cartesian space to obtain $\\mathbf{D}$ and its principal axes.\n\nCoordinate conventions:\n- Let $\\mathbf{U} \\in \\mathbb{R}^{3 \\times 3}$ be the matrix whose columns are the crystal lattice vectors $\\mathbf{a}_1$, $\\mathbf{a}_2$, $\\mathbf{a}_3$ expressed in Cartesian coordinates and measured in meters. These vectors need not be orthogonal.\n- Given a Cartesian displacement vector $\\Delta \\mathbf{r}(t) \\in \\mathbb{R}^3$, define the lattice-basis coefficients $\\Delta \\mathbf{c}(t)$ by solving $\\Delta \\mathbf{r}(t) = \\mathbf{U}\\,\\Delta \\mathbf{c}(t)$, so $\\Delta \\mathbf{c}(t) = \\mathbf{U}^{-1} \\Delta \\mathbf{r}(t)$.\n- The second-moment tensor in the lattice-basis coefficient space is $\\mathbf{C}_{\\text{lat}}(t) = \\langle \\Delta \\mathbf{c}(t)\\,\\Delta \\mathbf{c}(t)^\\top \\rangle$, and in Cartesian space is $\\mathbf{C}_{\\text{car}}(t) = \\langle \\Delta \\mathbf{r}(t)\\,\\Delta \\mathbf{r}(t)^\\top \\rangle$.\n- The Cartesian tensor relates to the lattice-basis tensor via $\\mathbf{C}_{\\text{car}}(t) = \\mathbf{U}\\,\\mathbf{C}_{\\text{lat}}(t)\\,\\mathbf{U}^\\top$.\n\nEstimation protocol:\n- For each test case, generate synthetic trajectories of $M$ independent particles undergoing anisotropic diffusion characterized by a known set of principal diffusion coefficients and an orientation in space. The simulation must use time step $\\Delta t$ and number of steps $N$, with initial positions at $\\mathbf{r}(0)=\\mathbf{0}$. Displacements are accumulated by summing independent zero-mean Gaussian increments at each time step.\n- For each time $t_k = k \\Delta t$ with $k \\in \\{1,2,\\dots,N\\}$, compute $\\mathbf{C}_{\\text{lat}}(t_k)$ by averaging over the $M$ particles.\n- Estimate the linear coefficient of $\\mathbf{C}_{\\text{lat}}(t)$ with respect to $t$ by performing a least-squares linear regression of each tensor component as a function of time $t$. Transform this linear coefficient back to Cartesian coordinates to obtain an estimate of the diffusion tensor $\\widehat{\\mathbf{D}}$ in Cartesian coordinates.\n- Diagonalize $\\widehat{\\mathbf{D}}$ to obtain its principal axes (eigenvectors) and principal diffusion coefficients (eigenvalues). Report the eigenvalues in meters squared per second (m$^2$/s).\n- Frame invariance test: Rotate the entire trajectory dataset by a given rotation $\\mathbf{R}$ and simultaneously rotate the lattice matrix $\\mathbf{U}$ to $\\mathbf{U}' = \\mathbf{R}\\,\\mathbf{U}$. Recompute the estimate $\\widehat{\\mathbf{D}}'$ from the rotated data using the same lattice-basis regression method. Compare $\\widehat{\\mathbf{D}}'$ with the similarity transform $\\mathbf{R}\\,\\widehat{\\mathbf{D}}\\,\\mathbf{R}^\\top$ by computing the maximum absolute element-wise difference. Define a boolean flag that is $\\text{True}$ if this difference is less than a tolerance equal to $0.02$ times the largest principal diffusion coefficient in the original estimate, and $\\text{False}$ otherwise. This tests frame invariance.\n\nRotation convention: Use active rotations applied to vectors in the order $\\mathbf{R} = \\mathbf{R}_z(\\alpha)\\,\\mathbf{R}_y(\\beta)\\,\\mathbf{R}_x(\\gamma)$, where $\\alpha$, $\\beta$, and $\\gamma$ are angles in radians.\n\nUnits:\n- All lattice vector components are in meters.\n- Time step $\\Delta t$ is in seconds.\n- Principal diffusion coefficients are in meters squared per second.\n- The output principal diffusion coefficients must be expressed in meters squared per second (m$^2$/s).\n- Angles are specified in radians.\n\nTest suite:\nProvide three test cases with parameters as follows. In each case, the synthetic truth defines the principal diffusion coefficients and an orientation of principal axes; the crystal lattice is defined by $\\mathbf{U}$; and a measurement-frame rotation $\\mathbf{R}$ is provided to test frame invariance. Use $M$ particles, $N$ steps, and time step $\\Delta t$ as specified. The random number generator seed must be fixed per case to ensure reproducibility.\n\n- Case $1$:\n  - $M = 200$, $N = 2000$, $\\Delta t = 1.0 \\times 10^{-12}\\ \\mathrm{s}$.\n  - Principal diffusion coefficients $(d_1,d_2,d_3) = (1.0 \\times 10^{-10},\\,3.0 \\times 10^{-10},\\,5.0 \\times 10^{-10})\\ \\mathrm{m}^2/\\mathrm{s}$.\n  - Orientation angles $(\\alpha,\\beta,\\gamma) = (0.7,\\,1.1,\\,0.3)$ radians.\n  - Lattice matrix $\\mathbf{U}$ with columns:\n    - $\\mathbf{a}_1 = (5.0 \\times 10^{-10},\\,0.0,\\,0.0)\\ \\mathrm{m}$,\n    - $\\mathbf{a}_2 = (1.0 \\times 10^{-10},\\,7.0 \\times 10^{-10},\\,0.0)\\ \\mathrm{m}$,\n    - $\\mathbf{a}_3 = (2.0 \\times 10^{-10},\\,1.0 \\times 10^{-10},\\,6.0 \\times 10^{-10})\\ \\mathrm{m}$.\n  - Measurement-frame rotation angles $(\\alpha',\\beta',\\gamma') = (0.5,\\,-0.4,\\,0.9)$ radians.\n\n- Case $2$ (near-isotropic boundary):\n  - $M = 200$, $N = 2000$, $\\Delta t = 1.0 \\times 10^{-12}\\ \\mathrm{s}$.\n  - Principal diffusion coefficients $(d_1,d_2,d_3) = (2.00 \\times 10^{-10},\\,2.10 \\times 10^{-10},\\,2.05 \\times 10^{-10})\\ \\mathrm{m}^2/\\mathrm{s}$.\n  - Orientation angles $(\\alpha,\\beta,\\gamma) = (0.2,\\,0.6,\\,-0.3)$ radians.\n  - Lattice matrix $\\mathbf{U}$ with columns:\n    - $\\mathbf{a}_1 = (4.0 \\times 10^{-10},\\,0.5 \\times 10^{-10},\\,0.0)\\ \\mathrm{m}$,\n    - $\\mathbf{a}_2 = (0.3 \\times 10^{-10},\\,5.5 \\times 10^{-10},\\,0.4 \\times 10^{-10})\\ \\mathrm{m}$,\n    - $\\mathbf{a}_3 = (0.2 \\times 10^{-10},\\,0.1 \\times 10^{-10},\\,5.8 \\times 10^{-10})\\ \\mathrm{m}$.\n  - Measurement-frame rotation angles $(\\alpha',\\beta',\\gamma') = (-0.1,\\,0.8,\\,0.4)$ radians.\n\n- Case $3$ (strong anisotropy, highly skewed lattice):\n  - $M = 200$, $N = 2000$, $\\Delta t = 1.0 \\times 10^{-12}\\ \\mathrm{s}$.\n  - Principal diffusion coefficients $(d_1,d_2,d_3) = (0.5 \\times 10^{-10},\\,4.0 \\times 10^{-10},\\,8.0 \\times 10^{-10})\\ \\mathrm{m}^2/\\mathrm{s}$.\n  - Orientation angles $(\\alpha,\\beta,\\gamma) = (1.0,\\,-0.7,\\,0.4)$ radians.\n  - Lattice matrix $\\mathbf{U}$ with columns:\n    - $\\mathbf{a}_1 = (3.5 \\times 10^{-10},\\,0.6 \\times 10^{-10},\\,0.2 \\times 10^{-10})\\ \\mathrm{m}$,\n    - $\\mathbf{a}_2 = (0.9 \\times 10^{-10},\\,6.2 \\times 10^{-10},\\,0.7 \\times 10^{-10})\\ \\mathrm{m}$,\n    - $\\mathbf{a}_3 = (1.3 \\times 10^{-10},\\,0.8 \\times 10^{-10},\\,6.5 \\times 10^{-10})\\ \\mathrm{m}$.\n  - Measurement-frame rotation angles $(\\alpha',\\beta',\\gamma') = (0.3,\\,1.2,\\,-0.5)$ radians.\n\nYour program must:\n- Simulate trajectories consistent with the specified principal diffusion coefficients and orientation for each case.\n- Estimate $\\widehat{\\mathbf{D}}$ in Cartesian coordinates by:\n  - Computing lattice-basis coefficients $\\Delta \\mathbf{c}(t)$ using $\\mathbf{U}^{-1}$,\n  - Regressing each component of $\\mathbf{C}_{\\text{lat}}(t)$ versus $t$ to obtain the linear coefficient,\n  - Transforming back to Cartesian coordinates to obtain $\\widehat{\\mathbf{D}}$,\n  - Diagonalizing $\\widehat{\\mathbf{D}}$ to obtain principal diffusion coefficients (eigenvalues).\n- Perform the frame-invariance test by rotating the data and lattice according to $\\mathbf{R}$ and recomputing $\\widehat{\\mathbf{D}}'$, and then report the maximum absolute element-wise difference between $\\widehat{\\mathbf{D}}'$ and $\\mathbf{R}\\,\\widehat{\\mathbf{D}}\\,\\mathbf{R}^\\top$ in meters squared per second, and the boolean flag defined above.\n\nOutput specification:\n- Express all principal diffusion coefficients in meters squared per second (m$^2$/s).\n- For each test case, output a list with three entries:\n  - A list of the three principal diffusion coefficients (eigenvalues) of $\\widehat{\\mathbf{D}}$, sorted in ascending order, in m$^2$/s.\n  - A floating-point value equal to the maximum absolute element-wise difference between $\\widehat{\\mathbf{D}}'$ and $\\mathbf{R}\\,\\widehat{\\mathbf{D}}\\,\\mathbf{R}^\\top$ in m$^2$/s.\n  - A boolean indicating whether the frame-invariance criterion (difference less than $0.02$ times the largest principal diffusion coefficient) is satisfied.\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, with one sublist per test case, in the order of the cases above. For example, a valid output format is $[\\,[\\dots],\\,[\\dots],\\,[\\dots]\\,]$.\n\nNo user input is allowed; all parameters must be hard-coded from the test suite above. Use a fixed random number generator seed per case to ensure reproducibility.",
            "solution": "This solution describes the method used to estimate the anisotropic diffusion tensor $\\mathbf{D}$ from simulated particle trajectories, based on principles of statistical mechanics and linear algebra.\n\n#### 1. Theoretical Foundation: Anisotropic Diffusion\n\nFor a particle undergoing anisotropic diffusion (a Wiener process) in three dimensions, the mean displacement is zero, $\\langle \\Delta \\mathbf{r}(t) \\rangle = \\mathbf{0}$, while the second moment of the displacement vector, $\\Delta \\mathbf{r}(t) = \\mathbf{r}(t) - \\mathbf{r}(0)$, grows linearly with time $t$. This relationship is described by a symmetric, positive-definite diffusion tensor $\\mathbf{D}$:\n$$\n\\langle \\Delta \\mathbf{r}(t) \\Delta \\mathbf{r}(t)^\\top \\rangle = 2\\mathbf{D}t\n$$\nHere, $\\langle \\cdot \\rangle$ denotes an ensemble average over many independent particles, and the matrix $\\langle \\Delta \\mathbf{r}(t) \\Delta \\mathbf{r}(t)^\\top \\rangle$ is the second-moment tensor in Cartesian coordinates, $\\mathbf{C}_{\\text{car}}(t)$. The eigenvalues of $\\mathbf{D}$ are the principal diffusion coefficients, and its eigenvectors define the principal axes of diffusion.\n\n#### 2. Trajectory Simulation\n\nSynthetic trajectories are generated by modeling diffusion as a random walk. The total displacement $\\Delta \\mathbf{r}(t_k)$ at time $t_k = k\\Delta t$ is the sum of $k$ independent, identically distributed displacement increments $\\delta \\mathbf{r}_j$. Each increment is drawn from a zero-mean multivariate normal distribution whose covariance matrix is $\\mathbf{C}_{\\text{step}} = 2\\mathbf{D}\\Delta t$.\n\nThe simulation procedure is as follows:\n1.  The ground-truth Cartesian diffusion tensor, $\\mathbf{D}_{\\text{true}}$, is constructed from its specified principal coefficients ($d_1, d_2, d_3$) and an orientation matrix $\\mathbf{P}$ formed from the given Euler angles, such that $\\mathbf{D}_{\\text{true}} = \\mathbf{P} \\text{diag}(d_1, d_2, d_3) \\mathbf{P}^\\top$.\n2.  The step covariance matrix $\\mathbf{C}_{\\text{step}} = 2\\mathbf{D}_{\\text{true}}\\Delta t$ is computed.\n3.  A Cholesky decomposition, $\\mathbf{C}_{\\text{step}} = \\mathbf{L}\\mathbf{L}^\\top$, yields a matrix $\\mathbf{L}$ that is used to generate correlated random increments from standard normal deviates $\\mathbf{z}$ via $\\delta \\mathbf{r} = \\mathbf{L}\\mathbf{z}$.\n4.  These increments are summed over time for $M$ particles to produce the full displacement trajectories $\\Delta \\mathbf{r}_i(t_k)$.\n\n#### 3. Estimation in a Non-Orthogonal Basis\n\nThe estimation is performed in a non-orthogonal lattice basis defined by the matrix $\\mathbf{U}$.\n1.  A Cartesian displacement $\\Delta \\mathbf{r}(t)$ is transformed into its lattice-basis coefficient vector $\\Delta \\mathbf{c}(t)$ via $\\Delta \\mathbf{c}(t) = \\mathbf{U}^{-1}\\Delta \\mathbf{r}(t)$.\n2.  For each time step $t_k$, the second-moment tensor in the lattice basis, $\\mathbf{C}_{\\text{lat}}(t_k)$, is estimated by averaging over all $M$ particles: $\\mathbf{C}_{\\text{lat}}(t_k) = \\frac{1}{M} \\sum_{i=1}^{M} \\Delta \\mathbf{c}_i(t_k) \\Delta \\mathbf{c}_i(t_k)^\\top$.\n3.  The relationship between the Cartesian and lattice-basis second-moment tensors, $\\mathbf{C}_{\\text{car}}(t) = \\mathbf{U}\\mathbf{C}_{\\text{lat}}(t)\\mathbf{U}^\\top$, implies that $\\mathbf{C}_{\\text{lat}}(t)$ also grows linearly with time: $\\mathbf{C}_{\\text{lat}}(t) \\approx \\mathbf{L}_{\\text{lat}}t$.\n4.  To find the matrix of growth rates $\\mathbf{L}_{\\text{lat}}$, a linear regression is performed for each of the six unique components of the symmetric tensor $\\mathbf{C}_{\\text{lat}}(t_k)$ against time $t_k$. The slope of each regression provides the corresponding element of the estimated matrix $\\widehat{\\mathbf{L}}_{\\text{lat}}$.\n\n#### 4. Recovering the Cartesian Diffusion Tensor\n\nOnce $\\widehat{\\mathbf{L}}_{\\text{lat}}$ is known, the Cartesian diffusion tensor estimate $\\widehat{\\mathbf{D}}$ is recovered by transforming back:\n$$\n2\\widehat{\\mathbf{D}}t = \\mathbf{U}(\\widehat{\\mathbf{L}}_{\\text{lat}}t)\\mathbf{U}^\\top \\implies \\widehat{\\mathbf{D}} = \\frac{1}{2} \\mathbf{U}\\widehat{\\mathbf{L}}_{\\text{lat}}\\mathbf{U}^\\top\n$$\nThe eigenvalues of this estimated tensor $\\widehat{\\mathbf{D}}$ are the estimated principal diffusion coefficients.\n\n#### 5. Frame Invariance Test\n\nThis test verifies a fundamental property of tensors: a physical quantity must transform predictably under a change of coordinate system. If the measurement frame is rotated by a matrix $\\mathbf{R}$, a second-rank tensor like $\\mathbf{D}$ must transform as $\\mathbf{D}'=\\mathbf{R}\\mathbf{D}\\mathbf{R}^\\top$. The test proceeds by:\n1.  Rotating the simulated Cartesian trajectories: $\\Delta \\mathbf{r}'(t) = \\mathbf{R}\\Delta \\mathbf{r}(t)$.\n2.  Rotating the lattice vectors: $\\mathbf{U}' = \\mathbf{R}\\mathbf{U}$.\n3.  Re-running the entire estimation pipeline using the rotated data ($\\Delta \\mathbf{r}'$) and rotated lattice ($\\mathbf{U}'$) to obtain a new estimate, $\\widehat{\\mathbf{D}}'$.\n4.  This numerically computed $\\widehat{\\mathbf{D}}'$ is then compared to the analytically transformed original estimate, $\\mathbf{R}\\widehat{\\mathbf{D}}\\mathbf{R}^\\top$. A small difference between them confirms the tensor nature of the calculation and the correctness of the implementation.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Simulates anisotropic diffusion, estimates the diffusion tensor via regression\n    in a non-orthogonal basis, and tests for frame invariance.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"M\": 200, \"N\": 2000, \"dt\": 1.0e-12,\n            \"d_principal\": (1.0e-10, 3.0e-10, 5.0e-10),\n            \"orientation_angles\": (0.7, 1.1, 0.3),\n            \"U_cols\": [(5.0e-10, 0.0, 0.0), (1.0e-10, 7.0e-10, 0.0), (2.0e-10, 1.0e-10, 6.0e-10)],\n            \"frame_rotation_angles\": (0.5, -0.4, 0.9),\n            \"seed\": 0\n        },\n        {\n            \"M\": 200, \"N\": 2000, \"dt\": 1.0e-12,\n            \"d_principal\": (2.00e-10, 2.10e-10, 2.05e-10),\n            \"orientation_angles\": (0.2, 0.6, -0.3),\n            \"U_cols\": [(4.0e-10, 0.5e-10, 0.0), (0.3e-10, 5.5e-10, 0.4e-10), (0.2e-10, 0.1e-10, 5.8e-10)],\n            \"frame_rotation_angles\": (-0.1, 0.8, 0.4),\n            \"seed\": 1\n        },\n        {\n            \"M\": 200, \"N\": 2000, \"dt\": 1.0e-12,\n            \"d_principal\": (0.5e-10, 4.0e-10, 8.0e-10),\n            \"orientation_angles\": (1.0, -0.7, 0.4),\n            \"U_cols\": [(3.5e-10, 0.6e-10, 0.2e-10), (0.9e-10, 6.2e-10, 0.7e-10), (1.3e-10, 0.8e-10, 6.5e-10)],\n            \"frame_rotation_angles\": (0.3, 1.2, -0.5),\n            \"seed\": 2\n        }\n    ]\n\n    results = []\n\n    def get_rotation_matrix(alpha, beta, gamma):\n        \"\"\"Constructs a 3D rotation matrix R = Rz(alpha)Ry(beta)Rx(gamma).\"\"\"\n        c1, s1 = np.cos(gamma), np.sin(gamma)\n        c2, s2 = np.cos(beta), np.sin(beta)\n        c3, s3 = np.cos(alpha), np.sin(alpha)\n        Rx = np.array([[1, 0, 0], [0, c1, -s1], [0, s1, c1]])\n        Ry = np.array([[c2, 0, s2], [0, 1, 0], [-s2, 0, c2]])\n        Rz = np.array([[c3, -s3, 0], [s3, c3, 0], [0, 0, 1]])\n        return Rz @ Ry @ Rx\n\n    def analyze_trajectories(disp_car, U, M, N, dt):\n        \"\"\"\n        Analyzes trajectories to estimate the diffusion tensor D.\n        - disp_car: Cartesian displacements (M, N, 3)\n        - U: Lattice matrix (3, 3)\n        - M, N, dt: simulation parameters\n        \"\"\"\n        U_inv = np.linalg.inv(U)\n        times = (np.arange(N) + 1) * dt\n        \n        # Transform to lattice-basis coefficients, shape (M, N, 3)\n        disp_lat = disp_car @ U_inv.T\n        \n        # Compute second-moment tensor C_lat(t) for each time step\n        # Transpose to (N, M, 3) to easily operate over particles for each time step\n        disp_lat_T = np.transpose(disp_lat, (1, 0, 2))\n        # C_lat_series[k] = mean(c_i(t_k) @ c_i(t_k).T) over i=1..M\n        C_lat_series = np.einsum('kim,kin-kmn', disp_lat_T, disp_lat_T) / M\n        \n        # Perform linear regression for each component of C_lat\n        L_lat_hat = np.zeros((3, 3))\n        A = np.vstack([times, np.ones(N)]).T\n        \n        for i in range(3):\n            for j in range(i, 3):\n                y = C_lat_series[:, i, j]\n                slope, _ = np.linalg.lstsq(A, y, rcond=None)[0]\n                L_lat_hat[i, j] = L_lat_hat[j, i] = slope\n        \n        # Transform back to Cartesian to get diffusion tensor\n        D_hat = 0.5 * (U @ L_lat_hat @ U.T)\n        return D_hat\n\n    for case in test_cases:\n        M, N, dt = case[\"M\"], case[\"N\"], case[\"dt\"]\n        d_principal = case[\"d_principal\"]\n        orientation_angles = case[\"orientation_angles\"]\n        U = np.array(case[\"U_cols\"]).T\n        frame_rotation_angles = case[\"frame_rotation_angles\"]\n        seed = case[\"seed\"]\n\n        # --- 1. Trajectory Generation ---\n        rng = np.random.default_rng(seed)\n        \n        # Construct true diffusion tensor D_true\n        D_diag = np.diag(d_principal)\n        R_orient = get_rotation_matrix(*orientation_angles)\n        D_true = R_orient @ D_diag @ R_orient.T\n        \n        # Covariance of a single step\n        cov_step = 2 * D_true * dt\n        L_chol = np.linalg.cholesky(cov_step)\n        \n        # Generate N steps for M particles\n        Z = rng.standard_normal(size=(M, N, 3))\n        delta_r = Z @ L_chol.T\n        \n        # Accumulate displacements\n        disp_car = np.cumsum(delta_r, axis=1)\n\n        # --- 2. Estimate D_hat from original data ---\n        D_hat = analyze_trajectories(disp_car, U, M, N, dt)\n        \n        # Get principal diffusion coefficients (eigenvalues)\n        eigvals = np.linalg.eigh(D_hat)[0]\n        sorted_eigvals = np.sort(eigvals)\n\n        # --- 3. Frame Invariance Test ---\n        R_measure = get_rotation_matrix(*frame_rotation_angles)\n        \n        # Rotate data and lattice\n        disp_car_rot = disp_car @ R_measure.T\n        U_prime = R_measure @ U\n        \n        # Recompute D_hat' from rotated data\n        D_hat_prime = analyze_trajectories(disp_car_rot, U_prime, M, N, dt)\n        \n        # Expected transformed tensor\n        D_expected = R_measure @ D_hat @ R_measure.T\n        \n        # Compare and check tolerance\n        max_diff = np.max(np.abs(D_hat_prime - D_expected))\n        invariance_tolerance = 0.02 * np.max(eigvals)\n        is_invariant = max_diff  invariance_tolerance\n        \n        # Store results\n        results.append([sorted_eigvals.tolist(), max_diff, bool(is_invariant)])\n\n    # --- 4. Final Output ---\n    # The string representation of a list of lists matches the required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}