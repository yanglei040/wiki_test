{
    "hands_on_practices": [
        {
            "introduction": "伪势的核心思想是用一个更简单的有效势来替代复杂的原子核和内层电子势，同时精确地再现价电子在原子核区域外的散射行为。本练习  提供了一个直接的、动手的经验来理解这一基本原理。通过求解一个简化方势阱的深度，您将亲身体会到，在一个选定的截断半径处匹配波函数的对数微商，对于构建一个物理上合理的伪势是何等关键。",
            "id": "3481321",
            "problem": "在冻芯近似下的保范赝势理论中，离子实和紧束缚的核心电子被一个有效势所替代，该有效势在选定的能量下再现了全电子参考体系的价电子散射。Hamann构造法和Troullier–Martins构造法都要求在核心截断半径处径向波函数的对数导数相等，而Troullier–Martins构造法还额外施加了高阶平滑性约束。考虑一个价电子最简单的 s 通道（$l=0$）散射，该过程由原子单位制（其中 $\\hbar = 1$ 和 $m_{e} = 1$）下的径向Kohn–Sham方程描述：\n$$\n- \\frac{1}{2} \\frac{d^{2} u(r)}{d r^{2}} + V(r)\\, u(r) = E\\, u(r),\n$$\n其正则边界条件为 $u(0) = 0$。在一个用于赝势的Hamann类型的最小局域模型中，设\n$$\nV(r) = \\begin{cases}\nV_{0}, & 0 \\le r  r_{c}, \\\\\n0,  r \\ge r_{c},\n\\end{cases}\n$$\n其中 $V_{0}$ 是一个待定常数，$r_{c}$ 是核心截断半径。全电子参考计算提供了在截断半径处的目标对数导数，\n$$\nD_{\\text{AE}}(E_{\\text{ref}}) \\equiv \\left.\\frac{u_{\\text{AE}}^{\\prime}(r)}{u_{\\text{AE}}(r)}\\right|_{r=r_{c}} \\quad \\text{at energy } E_{\\text{ref}}.\n$$\n假设来自全电子计算的以下实际输入：参考能量为 $E_{\\text{ref}} = 0.5$ Hartree原子单位，在截断半径处的目标对数导数为 $D_{\\text{AE}}(E_{\\text{ref}}) = 0$。设核心截断半径为 $r_{c} = 2$ 玻尔。仅从上述径向方程、其在常数势区域的通解以及在 $r=r_{c}$ 处对数导数的连续性出发，推导出决定 $V_{0}$ 的标量方程，并求解该方程以获得 $V_{0}$ 的数值。以Hartree为单位表示最终能量，并将您的答案四舍五入到四位有效数字。",
            "solution": "该问题要求找到一个简化局域赝势的恒定势阱深度 $V_{0}$，使得在特定的能量和截断半径下，相应径向波函数的对数导数与目标值相匹配。\n\n控制方程是原子单位制下 s 通道（$l=0$）的径向Kohn-Sham方程：\n$$\n- \\frac{1}{2} \\frac{d^{2} u(r)}{d r^{2}} + V(r)\\, u(r) = E\\, u(r)\n$$\n在原点的边界条件是 $u(0)=0$。赝势 $V(r)$ 是一个简单的方势阱：\n$$\nV(r) = \\begin{cases}\nV_{0},  0 \\le r  r_{c} \\\\\n0,  r \\ge r_{c}\n\\end{cases}\n$$\n我们已知参考能量 $E = E_{\\text{ref}} = 0.5$ Hartree，核心截断半径 $r_{c} = 2$ Bohr，以及目标全电子对数导数 $D_{\\text{AE}}(E_{\\text{ref}}) = 0$。这种赝势构造的基本条件是，赝波函数 $u(r)$ 在 $r=r_{c}$ 处的对数导数必须与全电子目标值相匹配：\n$$\n\\left.\\frac{u'(r)}{u(r)}\\right|_{r=r_{c}} = D_{\\text{AE}}(E_{\\text{ref}}) = 0\n$$\n为了找到 $V_{0}$，我们必须求解 $r  r_{c}$ 时的径向方程，应用边界条件，然后在 $r=r_{c}$ 处施加对数导数条件。\n\n在区域 $0 \\le r  r_{c}$ 中，势为 $V(r) = V_{0}$。径向方程变为：\n$$\n- \\frac{1}{2} \\frac{d^{2} u(r)}{d r^{2}} + V_{0}\\, u(r) = E_{\\text{ref}}\\, u(r)\n$$\n整理各项，我们得到：\n$$\n\\frac{d^{2} u(r)}{d r^{2}} = -2(E_{\\text{ref}} - V_{0}) u(r)\n$$\n解的性质取决于项 $(E_{\\text{ref}} - V_{0})$ 的符号。让我们考虑两种情况。\n\n情况1：$E_{\\text{ref}}  V_{0}$。\n在这种情况下，$(E_{\\text{ref}} - V_{0})$ 为负。我们定义一个实常数 $\\kappa$，使得 $\\kappa^2 = 2(V_{0} - E_{\\text{ref}})$。微分方程变为：\n$$\n\\frac{d^{2} u(r)}{d r^{2}} = \\kappa^2 u(r)\n$$\n通解是双曲函数的线性组合：\n$$\nu(r) = A \\sinh(\\kappa r) + B \\cosh(\\kappa r)\n$$\n应用边界条件 $u(0)=0$：\n$$\nu(0) = A \\sinh(0) + B \\cosh(0) = A(0) + B(1) = B = 0\n$$\n因此，该区域的解必须是 $u(r) = A \\sinh(\\kappa r)$ 的形式。其导数为 $u'(r) = A \\kappa \\cosh(\\kappa r)$。对数导数为：\n$$\n\\frac{u'(r)}{u(r)} = \\frac{A \\kappa \\cosh(\\kappa r)}{A \\sinh(\\kappa r)} = \\kappa \\coth(\\kappa r)\n$$\n在 $r=r_{c}$ 处计算该式，并将其设为目标值 $0$：\n$$\n\\kappa \\coth(\\kappa r_{c}) = 0\n$$\n对于非平凡解，我们需要 $\\kappa \\neq 0$，这意味着 $V_{0} \\neq E_{\\text{ref}}$。双曲余切函数 $\\coth(x)$ 对于任何有限的、非零的实数自变量 $x$ 都不为零。因此，对于 $\\kappa \\neq 0$，该方程无解。这意味着假设 $E_{\\text{ref}}  V_{0}$ 与所需条件不一致。\n\n情况2：$E_{\\text{ref}}  V_{0}$。\n在这种情况下，$(E_{\\text{ref}} - V_{0})$ 为正。我们定义一个实常数 $k$，使得 $k^2 = 2(E_{\\text{ref}} - V_{0})$。微分方程变为：\n$$\n\\frac{d^{2} u(r)}{d r^{2}} = -k^2 u(r)\n$$\n通解是三角函数的线性组合：\n$$\nu(r) = C \\sin(k r) + D \\cos(k r)\n$$\n应用边界条件 $u(0)=0$：\n$$\nu(0) = C \\sin(0) + D \\cos(0) = C(0) + D(1) = D = 0\n$$\n因此，该区域的解为 $u(r) = C \\sin(k r)$。其导数为 $u'(r) = C k \\cos(k r)$。对数导数为：\n$$\n\\frac{u'(r)}{u(r)} = \\frac{C k \\cos(k r)}{C \\sin(k r)} = k \\cot(k r)\n$$\n现在，我们在 $r=r_{c}$ 处施加匹配条件：\n$$\n\\left.\\frac{u'(r)}{u(r)}\\right|_{r=r_{c}} = k \\cot(k r_{c}) = 0\n$$\n由于 $E_{\\text{ref}}  V_{0}$，$k$ 不能为零（除非 $V_0 = E_{\\text{ref}}$，这将导致 $u(r)=Cr$ 和对数导数 $1/r_c \\neq 0$）。因此，我们必须有 $\\cot(k r_{c}) = 0$。当余切函数的自变量是 $\\frac{\\pi}{2}$ 的奇数倍时，该条件成立：\n$$\nk r_{c} = n \\frac{\\pi}{2}, \\quad \\text{for odd integer } n = \\pm 1, \\pm 3, \\dots\n$$\n赝势的一个关键要求是，赝波函数在核心半径 $r_{c}$ 内部不应有节点，以避免产生赝生的、深度束缚的类核态。波函数为 $u(r) = C \\sin(k r)$。为使其在区间 $(0, r_{c})$ 内无节点，对于所有 $r \\in (0, r_{c})$，自变量 $kr$ 必须在范围 $(0, \\pi)$ 内。这意味着 $k r_{c} \\le \\pi$。满足此无节点条件的唯一解是 $n=1$：\n$$\nk r_{c} = \\frac{\\pi}{2}\n$$\n现在我们可以求解 $V_{0}$。代入 $k$ 的定义：\n$$\n\\sqrt{2(E_{\\text{ref}} - V_{0})} \\cdot r_{c} = \\frac{\\pi}{2}\n$$\n两边平方得到：\n$$\n2(E_{\\text{ref}} - V_{0}) r_{c}^{2} = \\frac{\\pi^2}{4}\n$$\n求解 $V_{0}$：\n$$\nE_{\\text{ref}} - V_{0} = \\frac{\\pi^2}{8 r_{c}^{2}}\n$$\n$$\nV_{0} = E_{\\text{ref}} - \\frac{\\pi^2}{8 r_{c}^{2}}\n$$\n这就是推导出的关于 $V_{0}$ 的标量方程。现在，我们代入给定的数值：$E_{\\text{ref}} = 0.5$ 和 $r_{c} = 2$。\n$$\nV_{0} = 0.5 - \\frac{\\pi^2}{8 (2)^{2}} = 0.5 - \\frac{\\pi^2}{32}\n$$\n使用 $\\pi$ 的值 $\\approx 3.14159265$：\n$$\n\\pi^2 \\approx 9.8696044\n$$\n$$\nV_{0} \\approx 0.5 - \\frac{9.8696044}{32} \\approx 0.5 - 0.3084251\n$$\n$$\nV_{0} \\approx 0.1915749\n$$\n问题要求将最终答案四舍五入到四位有效数字。\n$$\nV_{0} \\approx 0.1916\n$$\n最终的势以Hartree为单位给出，因为所有输入都是原子单位。",
            "answer": "$$\n\\boxed{0.1916}\n$$"
        },
        {
            "introduction": "在了解了如何构建伪势之后，一个关键的问题是“它为何有效？”。这个练习  深入探讨了“可移植性”（transferability）这一核心概念，即可移植性是指伪势在不同化学环境中保持可靠性的能力。您将从第一性原理出发，推导范数守恒（norm conservation）这一数学条件如何确保伪势对环境变化的响应，在一阶近似下，能够精确模仿全电子势的行为。",
            "id": "3481296",
            "problem": "考虑一个原子单位制下球对称环境中的单价电子问题，其中全电子 (AE) 处理和赝势 (PS) 处理仅在核半径 $r_c$ 内部不同，而在 $r_c$ 外部则完全相同。以径向薛定谔方程为出发点，其中角动量为 $l$ 的分波通道遵循包含有效球对称势的单粒子方程。假设采用冻结核近似，这意味着核电荷分布对环境变化不产生响应，并且构建 AE 到 PS 的映射是为了在 $r_c$ 外部重现价电子的散射特性。模守恒条件定义为\n$$\n\\int_0^{r_c} \\left|\\phi_l^{\\text{PS}}(r)\\right|^2 \\, dr = \\int_0^{r_c} \\left|\\phi_l^{\\text{AE}}(r)\\right|^2 \\, dr,\n$$\n对于每个角动量通道 $l$，其中 $\\phi_l^{\\text{AE}}(r)$ 和 $\\phi_l^{\\text{PS}}(r)$ 分别表示核区域内的 AE 和 PS 径向解。\n\n从应用于球对称势散射的一阶不含时微扰理论出发，并利用分波相移表示散射特性，请从第一性原理推导，为何当环境引起的势移 $\\Delta V(r)$ 在核区域内缓慢变化或在 $0 \\le r \\le r_c$ 内为常数时，模守恒条件能够确保散射特性相对于该势移的一阶可移植性。明确证明，对于 $\\Delta V(r) = \\Delta V_0$（核内常数），由于模守恒，AE 与 PS 散射响应的一阶差异完全抵消。然后，通过在 $r=0$ 附近展开 $\\Delta V(r)$，将可移植性误差与 AE 和 PS 概率的径向矩差相关联，来量化当 $\\Delta V(r)$ 在核内平滑变化时的领头修正项。\n\n为了使该推导可用算法检验，为给定的通道 $l$ 定义一个无量纲的可移植性误差代理指标：\n$$\nT_l \\equiv \\int_0^{r_c} w(r)\\left(\\rho_l^{\\text{PS}}(r) - \\rho_l^{\\text{AE}}(r)\\right)\\, dr,\n$$\n其中 $\\rho_l^{X}(r) \\equiv \\left|\\phi_l^{X}(r)\\right|^2$ 对于 $X \\in \\{\\text{AE}, \\text{PS}\\}$，以及 $w(r) \\equiv \\Delta V(r)/\\overline{\\Delta V}$，其中\n$$\n\\overline{\\Delta V} \\equiv \\frac{1}{r_c}\\int_0^{r_c} \\Delta V(r)\\, dr.\n$$\n根据构造，由于模守恒，对于 $\\Delta V(r)=\\text{常数}$ 的情况，$T_l = 0$；而当 $\\Delta V(r)$ 存在空间变化时，$T_l \\ne 0$ 用于量化偏差。为了便于数值处理，将通道 $l$ 中 AE 和 PS 核区径向概率密度建模为\n$$\n\\rho_l^{\\text{AE}}(r) = r^{2l} e^{-\\lambda r}, \\quad \\rho_l^{\\text{PS,raw}}(r) = r^{2l} e^{-\\mu r},\n$$\n其中 $\\lambda$ 和 $\\mu$ 为正衰减参数，并通过一个因子 $s$ 缩放原始 PS 模型以强制实现模守恒，使得\n$$\ns \\int_0^{r_c} r^{2l} e^{-\\mu r} \\, dr = \\int_0^{r_c} r^{2l} e^{-\\lambda r} \\, dr,\n$$\n并设在 $0 \\le r \\le r_c$ 区间内 $\\rho_l^{\\text{PS}}(r) = s\\, r^{2l} e^{-\\mu r}$。环境引起的势移 $\\Delta V(r)$ 是球对称的，并且仅在 $0 \\le r \\le r_c$ 内有定义。所有长度均以玻尔半径为原子单位，能量以哈特里为单位，但根据构造，输出量 $T_l$ 是无量纲的。\n\n您的程序必须使用数值积分计算以下每个测试用例的 $T_l$，并生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果。对于所有测试用例，在打印输出时使用四舍五入保留 $6$ 位小数。测试套件如下：\n\n- 情况 $1$（恒定势移，抵消检验）：$l=0$，$r_c=1.0$，$\\lambda=4.0$，$\\mu=2.0$，且 $\\Delta V(r) = \\Delta V_0$，其中 $\\Delta V_0 = 0.5$。\n- 情况 $2$（平滑二次变化，理想情况）：$l=1$，$r_c=1.0$，$\\lambda=3.0$，$\\mu=2.5$，且 $\\Delta V(r) = \\Delta V_0 + \\alpha r^2$，其中 $\\Delta V_0=0.2$，$\\alpha=0.1$。\n- 情况 $3$（高离子性环境，强核区局域峰）：$l=0$，$r_c=0.6$，$\\lambda=6.0$，$\\mu=2.0$，且 $\\Delta V(r) = \\Delta V_0 + A e^{-r/\\xi}$，其中 $\\Delta V_0=1.0$，$A=5.0$，$\\xi=0.2$。\n- 情况 $4$（较高角动量抑制核区敏感度）：$l=3$，$r_c=1.2$，$\\lambda=3.0$，$\\mu=2.0$，且 $\\Delta V(r) = \\Delta V_0 + \\alpha r^2$，其中 $\\Delta V_0=0.3$，$\\alpha=0.2$。\n\n程序应：\n- 实现带有上述定义的模守恒缩放因子 $s$ 的 $\\rho_l^{\\text{AE}}(r)$ 和 $\\rho_l^{\\text{PS}}(r)$。\n- 实现指定的 $\\Delta V(r)$ 函数并计算 $\\overline{\\Delta V}$。\n- 对每个案例，使用在 $r \\in [0, r_c]$ 上的数值积分计算 $T_l$。\n- 输出单行结果，格式为逗号分隔的 Python 列表，每个值四舍五入至 $6$ 位小数，例如 `\"[x_1,x_2,x_3,x_4]\"`。\n\n您的解决方案必须推导在 $\\Delta V(r)$ 为常数情况下模守恒的保证，并解释当 $\\Delta V(r)$ 在核内变化时的一阶偏差。最终答案必须是一个完整的、可运行的 Python 程序，执行时能精确地按指定格式打印出所需输出。",
            "solution": "本解答旨在从第一性原理出发，阐明模守恒条件如何保证赝势在一阶近似下的可移植性。\n\n我们使用一阶不含时微扰理论来分析当化学环境改变时，赝势（PS）相对于全电子（AE）势的表现。环境的改变可以被建模为一个微扰势 $\\Delta V(r)$。\n\n对于球对称势中的散射问题，每个角动量通道 $l$ 的散射特性由相移 $\\delta_l(E)$ 描述。根据一阶微扰理论，微扰势 $\\Delta V(\\mathbf{r})$ 引起的相移变化为：\n$$\n\\Delta \\delta_l \\propto \\int_0^\\infty \\rho_l(r) \\Delta V(r) \\, dr\n$$\n其中 $\\rho_l(r) = |\\phi_l(r)|^2$ 是径向概率密度，$\\phi_l(r)$ 是径向薛定谔方程的解。\n\n赝势的可移植性误差可以定义为在相同微扰下，PS 和 AE 模型预测的相移变化之差：\n$$\n\\text{误差} \\propto \\Delta \\delta_l^{\\text{PS}} - \\Delta \\delta_l^{\\text{AE}} \\propto \\int_0^\\infty \\rho_l^{\\text{PS}}(r) \\Delta V(r) \\, dr - \\int_0^\\infty \\rho_l^{\\text{AE}}(r) \\Delta V(r) \\, dr\n$$\n这可以合并为一个积分：\n$$\n\\text{误差} \\propto \\int_0^\\infty \\left( \\rho_l^{\\text{PS}}(r) - \\rho_l^{\\text{AE}}(r) \\right) \\Delta V(r) \\, dr\n$$\n根据赝势的构造，在截断半径 $r_c$ 之外，赝波函数与全电子波函数相同，即对于 $r \\ge r_c$，有 $\\rho_l^{\\text{PS}}(r) = \\rho_l^{\\text{AE}}(r)$。因此，上述积分的非零贡献完全来自于核区域内部：\n$$\n\\text{误差} \\propto \\int_0^{r_c} \\left( \\rho_l^{\\text{PS}}(r) - \\rho_l^{\\text{AE}}(r) \\right) \\Delta V(r) \\, dr\n$$\n\n现在我们分析两种情况：\n\n**1. 恒定势移**\n若微扰势在核区域内为常数，即 $\\Delta V(r) = \\Delta V_0$ for $r \\in [0, r_c]$，则可将其从积分中提出：\n$$\n\\text{误差} \\propto \\Delta V_0 \\int_0^{r_c} \\left( \\rho_l^{\\text{PS}}(r) - \\rho_l^{\\text{AE}}(r) \\right) \\, dr = \\Delta V_0 \\left( \\int_0^{r_c} \\rho_l^{\\text{PS}}(r) \\, dr - \\int_0^{r_c} \\rho_l^{\\text{AE}}(r) \\, dr \\right)\n$$\n根据**模守恒条件**的定义，$\\int_0^{r_c} \\rho_l^{\\text{PS}}(r) \\, dr = \\int_0^{r_c} \\rho_l^{\\text{AE}}(r) \\, dr$。这意味着括号内的项为零，因此整个误差为零。这证明了对于核区域内的恒定势移，模守恒赝势具有完美的一阶可移植性。\n\n**2. 平滑变化的势移**\n若 $\\Delta V(r)$ 在核区域内不是常数，而是平滑变化的，我们可以将其在 $r=0$ 附近进行泰勒展开：\n$$\n\\Delta V(r) = \\Delta V(0) + r \\Delta V'(0) + \\frac{r^2}{2!} \\Delta V''(0) + \\dots\n$$\n代入误差积分中，我们得到：\n$$\n\\text{误差} \\propto \\Delta V(0) \\int_0^{r_c} (\\rho_l^{\\text{PS}} - \\rho_l^{\\text{AE}}) dr + \\Delta V'(0) \\int_0^{r_c} r (\\rho_l^{\\text{PS}} - \\rho_l^{\\text{AE}}) dr + \\dots\n$$\n由于模守恒，第一项（零阶矩）为零。因此，领头阶的误差取决于 $\\Delta V(r)$ 的一阶导数以及核内电荷密度的一阶径向矩之差。更高阶的误差项则与更高阶的矩差相关。\n$$\n\\text{误差} \\propto \\Delta V'(0) \\left( \\langle r \\rangle_{\\text{PS}} - \\langle r \\rangle_{\\text{AE}} \\right)_{\\text{core}} + \\frac{\\Delta V''(0)}{2} \\left( \\langle r^2 \\rangle_{\\text{PS}} - \\langle r^2 \\rangle_{\\text{AE}} \\right)_{\\text{core}} + \\dots\n$$\n这表明，一个高质量的赝势不仅需要满足模守恒，其赝电荷密度的低阶径向矩也应尽可能地与全电子电荷密度匹配，以保证在不同化学环境中的高可移植性。问题中定义的代理指标 $T_l$ 正是该误差积分的归一化形式，用于定量评估这种偏差。",
            "answer": "```python\nimport numpy as np\nfrom scipy.integrate import quad\n\ndef solve():\n    \"\"\"\n    Solves the problem for all test cases and prints the final result.\n    \"\"\"\n\n    def calculate_transferability_error(l, rc, lam, mu, delta_v_func):\n        \"\"\"\n        Calculates the transferability error proxy T_l for a single case.\n\n        Args:\n            l (int): Angular momentum channel.\n            rc (float): Core radius.\n            lam (float): Decay parameter for the AE model.\n            mu (float): Decay parameter for the PS model.\n            delta_v_func (callable): Function for the potential shift Delta V(r).\n\n        Returns:\n            float: The calculated value of T_l.\n        \"\"\"\n        \n        # Define the functional form of the unscaled probability densities.\n        # integrand_ae_norm corresponds to rho_l^AE(r).\n        # integrand_ps_raw_norm corresponds to the unscaled rho_l^PS,raw(r).\n        integrand_ae_norm = lambda r: r**(2 * l) * np.exp(-lam * r)\n        integrand_ps_raw_norm = lambda r: r**(2 * l) * np.exp(-mu * r)\n\n        # 1. Calculate the norm-conserving scaling factor 's'.\n        # The norm is the integral of the probability density from 0 to rc.\n        norm_ae, _ = quad(integrand_ae_norm, 0, rc)\n        norm_ps_raw, _ = quad(integrand_ps_raw_norm, 0, rc)\n\n        # s scales the raw PS density to match the AE norm inside the core.\n        if np.isclose(norm_ps_raw, 0):\n            # This case implies the PS density is zero, making 's' ill-defined.\n            # Based on the problem's models, this should not occur for positive parameters.\n            # If it did, and AE norm is also zero, s=1 would be fine. If not, error is infinite.\n            # For robustness, we check, but don't expect it to be triggered.\n            s = 1.0 if np.isclose(norm_ae, 0) else np.inf\n        else:\n            s = norm_ae / norm_ps_raw\n\n        # 2. Define the final, scaled probability densities.\n        rho_ae = integrand_ae_norm\n        rho_ps = lambda r: s * integrand_ps_raw_norm(r)\n        \n        # 3. Calculate the average of the potential shift, Delta V_bar.\n        dv_integral, _ = quad(delta_v_func, 0, rc)\n        if np.isclose(rc, 0):\n            dv_bar = 0.0\n        else:\n            dv_bar = dv_integral / rc\n\n        # 4. Calculate the transferability error proxy T_l.\n        # The weight function w(r) = Delta V(r) / Delta V_bar.\n        # The integrand for T_l is w(r) * (rho_ps(r) - rho_ae(r)).\n        if np.isclose(dv_bar, 0):\n            # This can happen if Delta V(r) averages to zero.\n            # If Delta V(r) is constant and zero, the error is zero.\n            # The problem defines T_l via a ratio, so if dv_bar is zero,\n            # T_l is only well-defined if the numerator integral is also zero.\n            # We explicitly check for this, although not expected for the given test cases.\n            numerator_integrand = lambda r: delta_v_func(r) * (rho_ps(r) - rho_ae(r))\n            numerator, _ = quad(numerator_integrand, 0, rc)\n            return 0.0 if np.isclose(numerator, 0) else np.nan\n\n        # Regular case where dv_bar is non-zero.\n        integrand_tl = lambda r: (delta_v_func(r) / dv_bar) * (rho_ps(r) - rho_ae(r))\n        Tl, _ = quad(integrand_tl, 0, rc)\n        \n        return Tl\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {'l': 0, 'rc': 1.0, 'lam': 4.0, 'mu': 2.0, 'dv_func': lambda r: 0.5},\n        {'l': 1, 'rc': 1.0, 'lam': 3.0, 'mu': 2.5, 'dv_func': lambda r: 0.2 + 0.1 * r**2},\n        {'l': 0, 'rc': 0.6, 'lam': 6.0, 'mu': 2.0, 'dv_func': lambda r: 1.0 + 5.0 * np.exp(-r / 0.2)},\n        {'l': 3, 'rc': 1.2, 'lam': 3.0, 'mu': 2.0, 'dv_func': lambda r: 0.3 + 0.2 * r**2},\n    ]\n\n    results = []\n    for case in test_cases:\n        Tl = calculate_transferability_error(\n            case['l'], case['rc'], case['lam'], case['mu'], case['dv_func']\n        )\n        results.append(Tl)\n\n    # Format the final output string as required.\n    # Each value is formatted to 6 decimal places.\n    output_str = f\"[{','.join([f'{r:.6f}' for r in results])}]\"\n    print(output_str)\n\nsolve()\n```"
        },
        {
            "introduction": "在实际计算中，研究者常常面临一些会考验伪势可移植性极限的选择。本练习  模拟了一个常见的情景：在一个使用特定交换关联泛函（如GGA）的计算中，却使用了基于另一种泛函（如LDA）生成的伪势。通过运用微扰理论，您将量化这种不一致性所引入的能量误差，从而深刻理解伪势可移植性的实际限制。",
            "id": "3481336",
            "problem": "要求您构建一个基于原理的定量模型，用于描述在使用一种交换关联泛函（例如，局域密度近似（LDA））生成的模守恒赝势时，若将其用于采用不同交换关联泛函（例如，广义梯度近似（GGA））的 Kohn–Sham (KS) 密度泛函理论 (DFT) 计算中所产生的不一致性。在冻芯近似中，这种不一致性可以被建模为一个有效的局域径向失配势 $\\Delta V_{\\text{xc}}(r)$，该势是短程的且集中在原子核区域附近。全文使用原子单位（长度单位为 Bohr，能量单位为 Hartree）。\n\n从 Kohn–Sham 单粒子本征值问题和一阶非简并微扰理论出发，推导一个自洽的算法，用以计算在局域径向微扰 $\\Delta V_{\\text{xc}}(r)$ 作用下，球对称价态的一阶能量移动，并同时计算一个定量的失配范数。为确保自洽性和普适性，请使用以下建模假设：\n\n- 未受微扰的价 KS 轨道由一个归一化的类氢 $1s$ 径向概率密度建模，其有效 Bohr 半径为 $a$，\n  $$\\rho_v(r;a) = \\frac{1}{\\pi a^3} \\exp\\!\\left(-\\frac{2r}{a}\\right),$$\n  该密度满足 $\\int_0^\\infty 4\\pi r^2 \\rho_v(r;a)\\,dr = 1$。\n\n- 交换关联失配被建模为一个高斯型核区局域势，\n  $$\\Delta V_{\\text{xc}}(r;A,r_0) = A \\exp\\!\\left(-\\left(\\frac{r}{r_0}\\right)^2\\right),$$\n  其中 $A$ 是以 Hartree 为单位的能量标度，$r_0$ 是以 Bohr 为单位的作用范围参数。这反映了赝势生成所用泛函与固态计算所用泛函之间的主要不一致性局域在离子实附近。\n\n根据上述基本定义以及 Kohn–Sham 密度泛函理论 (DFT) 和一阶微扰理论的原理，推导适用于对以下两个量进行数值计算的表达式：\n\n- 价态的一阶能量移动，\n  $$\\Delta E = \\int_0^\\infty 4\\pi r^2\\, \\rho_v(r;a)\\, \\Delta V_{\\text{xc}}(r;A,r_0)\\, dr,$$\n  以 Hartree 表示。\n\n- 势的 $L^2$ 失配范数的平方，\n  $$M_2 = \\int_0^\\infty 4\\pi r^2\\, \\left[\\Delta V_{\\text{xc}}(r;A,r_0)\\right]^2\\, dr,$$\n  以 Hartree$^2$·Bohr$^3$ 表示。\n\n您的程序必须使用收敛方法在 $[0,\\infty)$ 上实现这些积分的稳健数值求积。所有输出必须以浮点数形式返回，并四舍五入到8位小数。\n\n测试套件：\n按以下顺序，为下列三组参数集 $(A, r_0, a)$ 中的每一组计算数值对 $\\left[\\Delta E, M_2\\right]$：\n\n- 情况1（边界一致性检查）：$(A, r_0, a) = (0.0, 1.0, 1.0)$。\n- 情况2（短程正失配）：$(A, r_0, a) = (0.5, 0.5, 1.0)$。\n- 情况3（具有更弥散价态的长程负失配）：$(A, r_0, a) = (-0.3, 2.0, 1.5)$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个含三个数值对的列表，每个数值对本身是一个双元素列表 $[\\Delta E, M_2]$，顺序与测试用例相同。外层列表打印时不得有空格，每个浮点数必须四舍五入到8位小数。例如，一个可接受的输出形状是\n$$[[x_{11},x_{12}],[x_{21},x_{22}],[x_{31},x_{32}]],$$\n其中 $x_{i1}$ 是情况 $i$ 的 $\\Delta E$（以 Hartree 为单位），$x_{i2}$ 是情况 $i$ 的 $M_2$（以 Hartree$^2$·Bohr$^3$ 为单位）。",
            "solution": "本解答旨在推导计算一阶能量移动 $\\Delta E$ 和失配范数平方 $M_2$ 的表达式。所有计算均在原子单位制下进行。\n\n### 1. 一阶能量移动 ($\\Delta E$) 推导\n\n根据一阶微扰理论，能量移动 $\\Delta E$ 是微扰势 $\\Delta V_{\\text{xc}}$ 相对于未受微扰价态的期望值，其价态概率密度为 $\\rho_v$。根据问题定义，其表达式为：\n$$ \\Delta E = \\int_0^\\infty 4\\pi r^2\\, \\rho_v(r;a)\\, \\Delta V_{\\text{xc}}(r;A,r_0)\\, dr $$\n将问题中给定的 $\\rho_v(r;a)$ 和 $\\Delta V_{\\text{xc}}(r;A,r_0)$ 的具体形式代入：\n$$ \\Delta E = \\int_0^\\infty 4\\pi r^2\\, \\left(\\frac{1}{\\pi a^3} \\exp\\!\\left(-\\frac{2r}{a}\\right)\\right) \\left(A \\exp\\!\\left(-\\left(\\frac{r}{r_0}\\right)^2\\right)\\right)\\, dr $$\n合并常数项并简化被积函数，我们得到：\n$$ \\Delta E = \\frac{4A}{a^3} \\int_0^\\infty r^2 \\exp\\!\\left(-\\frac{r^2}{r_0^2} - \\frac{2r}{a}\\right)\\, dr $$\n该积分没有简单的解析解，因此最适合通过数值方法（如 `scipy.integrate.quad`）进行计算。被积函数光滑且在 $r \\to \\infty$ 时快速趋于零，保证了数值积分的收敛性和准确性。\n\n### 2. $L^2$ 失配范数平方 ($M_2$) 推导\n\n$L^2$ 范数的平方 $M_2$ 定义为微扰势平方在整个空间上的积分，由球体积元 $4\\pi r^2$ 加权：\n$$ M_2 = \\int_0^\\infty 4\\pi r^2\\, \\left[\\Delta V_{\\text{xc}}(r;A,r_0)\\right]^2\\, dr $$\n代入 $\\Delta V_{\\text{xc}}(r;A,r_0)$ 的表达式：\n$$ M_2 = \\int_0^\\infty 4\\pi r^2\\, \\left[A \\exp\\!\\left(-\\left(\\frac{r}{r_0}\\right)^2\\right)\\right]^2\\, dr $$\n简化后得到：\n$$ M_2 = 4\\pi A^2 \\int_0^\\infty r^2 \\exp\\!\\left(-\\frac{2r^2}{r_0^2}\\right)\\, dr $$\n这是一个可以解析求解的标准高斯积分。令积分部分为 $I$，并设 $\\alpha = 2/r_0^2$。\n$$ I = \\int_0^\\infty r^2 \\exp(-\\alpha r^2)\\, dr $$\n我们可以通过对基本高斯积分关于参数 $\\alpha$ 求导来求解。从基本高斯积分开始：\n$$ \\int_0^\\infty \\exp(-\\alpha r^2)\\, dr = \\frac{1}{2}\\sqrt{\\frac{\\pi}{\\alpha}} $$\n两边对 $\\alpha$ 求导，得到：\n$$ \\frac{d}{d\\alpha} \\int_0^\\infty \\exp(-\\alpha r^2)\\, dr = \\int_0^\\infty (-r^2) \\exp(-\\alpha r^2)\\, dr = -I $$\n因此，$I$ 是基本积分结果的负导数：\n$$ I = -\\frac{d}{d\\alpha} \\left( \\frac{1}{2}\\sqrt{\\pi} \\alpha^{-1/2} \\right) = -\\frac{\\sqrt{\\pi}}{2} \\left(-\\frac{1}{2} \\alpha^{-3/2}\\right) = \\frac{\\sqrt{\\pi}}{4\\alpha^{3/2}} $$\n将 $\\alpha = 2/r_0^2$ 代回：\n$$ I = \\frac{\\sqrt{\\pi}}{4(2/r_0^2)^{3/2}} = \\frac{\\sqrt{\\pi}}{4(2\\sqrt{2}/r_0^3)} = \\frac{\\sqrt{\\pi} r_0^3}{8\\sqrt{2}} $$\n最后，将 $I$ 的结果代入 $M_2$ 的表达式中：\n$$ M_2 = 4\\pi A^2 I = 4\\pi A^2 \\left( \\frac{\\sqrt{\\pi} r_0^3}{8\\sqrt{2}} \\right) = A^2 r_0^3 \\frac{\\pi^{3/2}}{2\\sqrt{2}} $$\n这个解析表达式为 $M_2$ 的计算提供了精确且高效的方法。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.integrate import quad\n\ndef solve():\n    \"\"\"\n    Computes the first-order energy shift (Delta E) and the squared L2 mismatch norm (M2) \n    for given sets of parameters based on a model of pseudopotential inconsistency in DFT.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    # Each case is a tuple (A, r0, a) in atomic units.\n    # A: energy scale (Hartree)\n    # r0: range parameter (Bohr)\n    # a: effective Bohr radius (Bohr)\n    test_cases = [\n        (0.0, 1.0, 1.0),   # Case 1: boundary consistency check\n        (0.5, 0.5, 1.0),   # Case 2: short-range positive mismatch\n        (-0.3, 2.0, 1.5),  # Case 3: longer-range negative mismatch\n    ]\n\n    results = []\n    for A, r0, a in test_cases:\n        # Trivial case: if the perturbation amplitude A is zero, both quantities are zero.\n        if A == 0.0:\n            delta_E = 0.0\n            m2 = 0.0\n        else:\n            # 1. Compute the first-order energy shift Delta E via numerical quadrature.\n            # The integrand for Delta E is: (4*A/a^3) * r^2 * exp(-(r/r0)^2 - 2*r/a)\n            # The constant prefactor is included in the lambda function.\n            def integrand_delta_E(r, A_val, r0_val, a_val):\n                return (4 * A_val / a_val**3) * r**2 * np.exp(-(r/r0_val)**2 - 2*r/a_val)\n\n            # Perform the numerical integration from 0 to infinity.\n            # quad returns a tuple (integral_value, error_estimate). We only need the value.\n            delta_E, _ = quad(integrand_delta_E, 0, np.inf, args=(A, r0, a))\n            \n            # 2. Compute the squared L2 mismatch norm M2 using its analytical solution.\n            # M2 = A^2 * r0^3 * pi^(3/2) / (2 * sqrt(2))\n            m2 = (A**2 * r0**3 * np.pi**(3.0/2.0)) / (2.0 * np.sqrt(2.0))\n\n        # Round the results to the specified precision of 8 decimal places.\n        rounded_delta_E = round(delta_E, 8)\n        rounded_m2 = round(m2, 8)\n\n        results.append([rounded_delta_E, rounded_m2])\n\n    # Final print statement in the exact required format: [[x11,x12],[x21,x22],...]\n    # We construct the string carefully to ensure no extraneous whitespace is introduced,\n    # which can happen when using str() on Python lists.\n    # For example, f'[{e:.8f},{m:.8f}]' creates a string like '[0.12345678,9.87654321]'\n    # without space after the comma.\n    results_str_list = [f'[{e:.8f},{m:.8f}]' for e, m in results]\n    final_output_string = f\"[{','.join(results_str_list)}]\"\n                           \n    print(final_output_string)\n\nsolve()\n\n```"
        }
    ]
}