## 引言
在生命科学研究中，理解细胞在其原生组织环境中的功能、[状态和](@entry_id:193625)相互作用是揭示复杂生物过程的关键。[单细胞组学](@entry_id:151015)技术以前所未有的分辨率剖析了异质组织中的细胞类型和状态，但丢失了至关重要的空间信息。相反，[空间组学](@entry_id:156223)技术保留了组织结构，却往往牺牲了单细胞级别的分辨率。因此，如何将这两种强大的技术产生的数据进行有效整合，以重建高分辨率、空间解析的[细胞图谱](@entry_id:270083)，成为了[计算系统生物学](@entry_id:747636)领域一个核心且亟待解决的挑战。

本文旨在系统性地介绍和剖析解决这一挑战的关键计算策略。通过阅读本文，您将掌握从基础原理到前沿应用的全方位知识。我们将首先在“原理与机制”一章中，深入探讨整合算法的核心，包括[数据表示](@entry_id:636977)、[批次效应校正](@entry_id:269846)和概率反卷积的数学基础。接着，在“应用与[交叉](@entry_id:147634)学科联系”一章中，我们将展示这些方法如何应用于发育生物学、[肿瘤学](@entry_id:272564)等多个领域，并与最优传输、[拓扑数据分析](@entry_id:154661)等数学框架相结合。最后，“动手实践”部分将提供具体的计算练习，帮助您巩固所学。让我们从理解整合任务背后的基本原理和机制开始，为构建精确的空间[细胞图谱](@entry_id:270083)奠定坚实的基础。

## 原理与机制

在“引言”章节中，我们概述了整合单细胞和[空间组学](@entry_id:156223)数据的目标及其在生物学发现中的变革性潜力。本章将深入探讨实现这一整合所需的计算原理和核心机制。我们将从数据的[基本表示](@entry_id:157678)法开始，剖析整合过程中固有的挑战，然后系统地阐述用于解决这些挑战的关键算法框架，包括概率[反卷积](@entry_id:141233)、[批次效应校正](@entry_id:269846)和空间上下文建模。

### [数据表示](@entry_id:636977)与核心挑战

任何计算分析的起点都是对所处理数据的精确数学描述。单细胞和[空间组学](@entry_id:156223)数据的整合涉及至少两种不同但相关的数据模态。

**[数据结构](@entry_id:262134)**

典型的整合任务涉及以下核心数据对象 ：
1.  **[单细胞RNA测序 (scRNA-seq)](@entry_id:754902) 数据**：通常表示为一个计数矩阵 $X \in \mathbb{N}^{n \times g}$，其中 $n$ 是从组织中解离出来的单细胞数量，$g$ 是测量的基因数量。矩阵中的每个元素 $X_{ic}$ 代表在细胞 $i$ 中检测到的基因 $c$ 的转录本数量（通常以[唯一分子标识符](@entry_id:192673) UMI 计数）。
2.  **空间转录组学 (ST) 数据**：这通常也表示为一个计数矩阵 $Y \in \mathbb{N}^{s \times g}$，其中 $s$ 是空间测量点（spot）的数量，$g$ 是与[scRNA-seq](@entry_id:155798)数据相同的基因集。$Y_{jg}$ 代表在空间点 $j$ 观察到的基因 $g$ 的UMI计数。
3.  **空间坐标**：一个坐标矩阵 $C \in \mathbb{R}^{s \times d}$，其中第 $j$ 行 $C_j$ 提供了空间点 $j$ 在组织切片上的物理位置。对于二维组织切片，通常 $d=2$。

这些[数据结构](@entry_id:262134)本身就预示了整合所面临的根本挑战。我们的目标是利用细胞分辨率的[scRNA-seq](@entry_id:155798)数据 $X$ 来解析空间分辨率的ST数据 $Y$，最终将每个单细胞的身份和状态映射回其在组织坐标 $C$ 中的原始位置。然而，原始计数数据并不能直接进行比较或建模，必须首先解决几个关键的技术变异来源。

**技术变异与归一化**

一个核心挑战是，原始UMI计数不仅反映了生物学上的基因表达水平，还受到技术因素的强烈影响，其中最主要的是 **[测序深度](@entry_id:178191)**（或称 **文库大小**）。不同细胞或空间点的[测序深度](@entry_id:178191)可能相差几个[数量级](@entry_id:264888)，这并非源于生物学差异，而是随机的mRNA捕获和测序过程所致。

为了纠正这种影响，标准做法是进行 **深度归一化**。一种常见的方法是将每个观测值（细胞或空间点）的计数按比例缩放到一个共同的总数，例如每$10^4$个计数（CP10k）。对于一个观测值 $i$（其原始计数向量为 $\mathbf{X}_{i,\cdot}$），其总UMI计数（文库大小）为 $D_i = \sum_j X_{ij}$。归一化后的计数值 $\tilde{X}_{ij}$ 计算如下：

$$ \tilde{X}_{ij} = \frac{X_{ij}}{D_i} \times 10^4 $$

例如，考虑两个基因表达谱不同的单细胞 ：
-   细胞1: $\mathbf{X}_{1,\cdot} = (100, 50, 0, 350)$，其总计数 $D_1 = 500$。
-   细胞2: $\mathbf{X}_{2,\cdot} = (20, 20, 10, 50)$，其总计数 $D_2 = 100$。

对它们进行CP10k归一化，我们得到：
-   细胞1中基因4的归一化值：$\tilde{X}_{1,4} = \frac{350}{500} \times 10^4 = 7,000$。
-   细胞2中基因3的归一化值：$\tilde{X}_{2,3} = \frac{10}{100} \times 10^4 = 1,000$。

这种归一化方法的核心假设是，观测值之间总UMI计数的差异主要反映了技术采样深度，而非生物学上的总RNA含量的差异。当这个假设成立时，归一化能够有效地使相对表达谱具有可比性 。

然而，在整合任务中，盲目应用此方法可能会产生误导：
-   **掩盖生物信号**：在空间转录组学中，一个空间点的总UMI计数与其捕获的细胞数量（即细胞密度）密切相关。一个包含8个细胞的点（如Spot A）的总UMI可能远高于一个只包含1个细胞的点（如Spot B）。将它们归一化到相同的总数会消除这种反映[组织结构](@entry_id:146183)关键特征（细胞密度）的生物学信号 。
-   **引入人为变异**：如果组织中存在空间变化的 **环境RNA污染**，或者某些细胞（如受胁迫的细胞）的 **线粒体基因转录本比例** 异常升高，这些因素会不成比例地增加某些观测值的总UMI计数。简单的深度归一化会人为地压低这些观测值中其他（核编码）基因的相对表达值，从而引入虚假的空间模式或细胞状态差异 。因此，更复杂的整合模型通常会直接在原始计数空间中操作，或在模型内部显式地对这些混杂因素进行建模。

**[批次效应](@entry_id:265859)**

另一个主要的挑战是 **[批次效应](@entry_id:265859)**，这是指源于不同实验条件（例如，[scRNA-seq](@entry_id:155798)与ST是两种根本不同的实验流程）的系统性、非生物学差异。即使测量的是同一组基因，两种技术平台的捕获效率、扩增偏好和噪声特性也大相径庭。

严谨地讲，批次效应可以被定义为与我们关心的生物学信号正交的非期望变异 。假设已知的生物学变化（如细胞类型差异、发育轨迹）发生在基因表达空间的一个[子空间](@entry_id:150286) $S$ 中，那么批次效应就可以被认为是发生在其[正交补](@entry_id:149922)空间 $S^\perp$ 中的变异。整合的目标是找到一种校正方法，能够对齐不同批次（数据集）的数据[分布](@entry_id:182848)，同时 **保留** 生物[子空间](@entry_id:150286) $S$ 内的真实变异。这可以通过构建一个优化目标函数来实现，该函数一方面最小化校正后数据集之间的[分布](@entry_id:182848)差异（例如，均值和协[方差](@entry_id:200758)的差异），另一方面惩罚对原始生物学[方差](@entry_id:200758)的任何改变 。我们将在后续章节探讨实现这一目标的具体算法。

### 整合目标：从对齐到反卷积

根据空间技术的分辨率与组织中细胞大小的相对关系，整合的基本目标会发生质的变化。我们可以通过一个思想实验来理解这一点，其中空间测量点的直径为 $d$，而细胞的平均直径为 $d_c$ 。

1.  **亚细胞分辨率 ($d \ll d_c$)**：当测量点远小于单个细胞时，一个完整的细胞会被多个点覆盖。此时，每个点内部几乎不含多细胞混合，但来自单个细胞的信号却被分割到多个点上。整合的目标不再是反卷积，而是首先通过 **分割或聚合** 相邻的点来重建出单个细胞的表达谱，然后再将这些重建的细胞谱与scRNA-seq参考进行 **直接对齐**。

2.  **单细胞分辨率 ($d \approx d_c$)**：当测量点的大小与细胞大小相当，我们处于一个“甜蜜点”。在这种情况下，很大一部分点可能恰好只包含一个细胞。整合的主要目标是 **直接对齐** 或 **[一对一映射](@entry_id:183792)**，即将每个空间点与scRNA-seq参考中最匹配的单个细胞进行匹配。当然，由于细胞[排列](@entry_id:136432)不规则，仍会有一些点包含部分细胞或多个细胞，因此采用概率性的软分[配方法](@entry_id:265480)通常比硬性的一对一匹配更为稳健。

3.  **多细胞分辨率 ($d \gg d_c$)**：当测量点远大于单个细胞时，每个点都会捕获来自多个（可能属于不同类型）细胞的转录本混合物。这是诸如[10x Genomics Visium](@entry_id:181467)等常用平台的典型情况。此时，整合的核心任务是 **[反卷积](@entry_id:141233) (deconvolution)**：即利用scRNA-seq参考中纯细胞类型的表达谱，来推断每个空间点中不同细胞类型的构成比例。

现实世界中的技术横跨了这些不同的分辨率[范式](@entry_id:161181) 。例如，[单分子荧光原位杂交](@entry_id:180372) ([smFISH](@entry_id:180372)) 能够达到亚细胞或单细胞分辨率，但通常只能测量少量基因（低通量）。而像Visium这样的技术是全转录组范围的（高通量），但分辨率是多细胞级别的。[成像质谱流式细胞术](@entry_id:186913) (IMC) 则提供了高分辨率的蛋白质测量（一种不同的分子模态）。因此，选择何种整合策略，从根本上取决于所用空间技术的数据特性：其分辨率决定了整合目标是反卷积还是直接对齐，其分子通量（基因或蛋白质数量）和模态决定了[特征空间](@entry_id:638014)是否可以直接比较，而其特有的噪声[分布](@entry_id:182848)（如泊松、负二项或对数正态）则决定了应采用何种统计似然模型。

### 机制 I：概率反卷积与生成模型

鉴于多细胞分辨率技术（如Visium）的广泛应用，[反卷积](@entry_id:141233)是[空间组学](@entry_id:156223)整合中最核心和最普遍的计算任务之一。其基本思想是将空间点的基因表达谱建模为多种单细胞表达谱的加权平均。

**混合模型**

一个空间点 $j$ 的表达谱 $Y_{j,\cdot}$ 被认为是一个混合物。其期望表达值 $\mathbb{E}[Y_{jg}]$ 可以表示为：

$$ \mathbb{E}[Y_{jg}] \propto \sum_{i=1}^{n} w_{ij} \cdot \mu_{ig} $$

其中，$\mu_{ig}$ 是单细胞参考 $X$ 中细胞（或细胞类型）$i$ 的基因 $g$ 的归一化表达丰度，$w_{ij}$ 是细胞 $i$ 对空间点 $j$ 的贡献权重。这些权重必须满足非负性 ($w_{ij} \ge 0$) 和某种归一化约束（例如，$\sum_i w_{ij} = 1$），代表了相对组成成分 。

**[生成模型](@entry_id:177561)与似然**

为了构建一个完整的概率模型，我们需要为观察到的UMI计数指定一个数据生成过程。由于UMI计数是离散的随机事件，通常采用 **[泊松分布](@entry_id:147769)** 或 **负二项 (NB) [分布](@entry_id:182848)** 来建模。负二项分布由于包含一个额外的[离散度](@entry_id:168823)参数，能够更好地捕捉测序数据中普遍存在的 **过离散** 现象（即[方差](@entry_id:200758)大于均值），因此更为常用。

一个典型的生成模型如下 ：
对于每个空间点 $s$ 和每个基因 $g$，其UMI计数 $Y_{sg}$ 被假定服从一个负二项分布：
$$ Y_{sg} \sim \mathrm{NB}(\mu_{sg}, \theta_g) $$
其中，$\mu_{sg}$ 是期望（均值），$\theta_g$ 是基因特异性的[离散度](@entry_id:168823)参数。模型的均值 $\mu_{sg}$ 被构建为[scRNA-seq](@entry_id:155798)参考的[线性组合](@entry_id:154743)：
$$ \mu_{sg} = \lambda_s \sum_{t=1}^{T} \pi_{st} M_{tg} $$
这里的参数具有清晰的物理解释：
-   $M \in \mathbb{R}_{\ge 0}^{T \times G}$：一个细胞类型-基因表达参考矩阵，其中 $M_{tg}$ 代表细胞类型 $t$ 中基因 $g$ 的平均表达水平。这通常从scRNA-seq数据预先计算得到。
-   $\boldsymbol{\pi}_s = (\pi_{s1}, \dots, \pi_{sT})^\top$：一个非负的比例向量，其元素和为1 ($\sum_t \pi_{st} = 1$)，代表点 $s$ 中各种细胞类型 $T$ 的混合比例。这是我们希望推断的核心目标之一。
-   $\lambda_s$：一个点特异性的缩放因子，可以解释为该点的总捕获效率或细胞总数，它解释了总UMI计数的差异。

通过最大化观测数据 $Y$ 在此模型下的联合[对数似然函数](@entry_id:168593)，就可以同时估计出每个空间点的细胞类型比例 $\boldsymbol{\pi}_s$ 和其他模型参数。

**模型的可识别性 (Identifiability)**

在构建这类复杂模型时，一个至关重要的理论问题是 **可识别性**：我们能否从数据中唯一地确定模型的参数？如果不同的参数组合能够产生完全相同的观测数据[分布](@entry_id:182848)，那么这些参数就是不可识别的。

在反卷积模型中，可识别性依赖于几个关键条件  ：
1.  **特征数量**：为了区分 $T$ 种细胞类型，我们通常需要测量足够多的、在这些细胞类型间存在[差异表达](@entry_id:748396)的基因。一般来说，基因数量 $G$ 必须大于或等于细胞类型数量 $T$。如果 $G  T$，则[反卷积](@entry_id:141233)问题在数学上是欠定的，无法得到唯一解。
2.  **参考矩阵的线性无关性**：参考矩阵 $M$ 的行（即细胞类型的表达谱）必须是[线性无关](@entry_id:148207)的。如果一种细胞类型的表达谱可以表示为其他几种类型的[线性组合](@entry_id:154743)，那么模型就无法区分它们。
3.  **“锚点”的存在**：可识别性在理论和实践上都极大地受益于数据中“锚点”的存在。例如，如果对于每种细胞类型 $t$，都存在一个只被该细胞类型占据的“纯”空间点（即 **锚点**），或者存在一个只被该细胞类型特异性表达的 **锚基因**，那么反卷积问题就变得良定，参数可以被唯一确定（在不考虑细胞类型标签[置换](@entry_id:136432)和全局缩放的情况下）。
4.  **约束的作用**：模型中的约束，如比例向量 $\boldsymbol{\pi}_s$ 的元素和为1，也对可识别性至关重要。例如，这个约束使得我们能够将点特异性的缩放因子 $\lambda_s$ 与比例向量 $\boldsymbol{\pi}_s$ [解耦](@entry_id:637294)和区分开来 。

### 机制 II：[批次效应校正](@entry_id:269846)

如前所述，scRNA-seq和ST数据之间存在显著的[批次效应](@entry_id:265859)。如果忽略这些效应，直接将两者进行比较或整合，会导致严重的系统性偏差。

**互近邻 (Mutual Nearest Neighbors, MNN)**

一种直观且强大的批次校正方法是 **互近邻 (MNN)** 法 。其核心思想是，尽管[批次效应](@entry_id:265859)会扭曲整个表达空间，但它通常是局部平滑的，因此细胞在表达空间中的局部邻域结构得以保留。这意味着，如果两个细胞在各自的数据集中对应于相同的生物学状态，它们在批次效应扭曲后的空间中也应保持相对接近。

然而，简单地为每个细胞寻找其在另一个数据集中的最近邻（NN）是不可靠的，因为它对数据集间的细胞类型组成和采样密度差异非常敏感。MNN通过增加一个 **互惠性 (reciprocity)** 条件来解决这个问题。

形式上，在一个共享的低维特征空间中，对于来自[scRNA-seq](@entry_id:155798)数据集的一个细胞 $x$ 和来自ST数据集的一个点 $y$，如果满足以下两个条件，它们就构成一个MNN对：
1.  点 $y$ 是细胞 $x$ 在ST数据集中的 $k$-近邻之一。
2.  细胞 $x$ 是点 $y$ 在scRNA-seq数据集中的 $k$-近邻之一。

这个双向的“互惠”要求非常关键。它能够有效地过滤掉由数据密度差异引起的“单向”匹配，只保留那些在两个数据集中都互为最佳匹配的、高[置信度](@entry_id:267904)的对应关系。这些MNN对就像是连接两个数据集的“锚点”，可以用来估计局部的、[非线性](@entry_id:637147)的校正向量，从而将一个数据集逐步对齐到另一个数据集上。

**基于子[空间分解](@entry_id:755142)的校正**

更具形式化的方法是将批次效应视为与生物学信号正交的变异。我们可以定义一个目标函数，旨在学习一个[线性变换](@entry_id:149133)（校[正矩阵](@entry_id:149490)）$C^{(d)}$，将原始数据 $X^{(d)}$ 转换为校正后的数据 $Z^{(d)} = X^{(d)} C^{(d)}$。这个目标函数可以被设计为同时实现多个目标 ：
-   **对齐**：最小化校正后数据集 $Z^{(1)}$ 和 $Z^{(2)}$ 之间[分布](@entry_id:182848)的差异，例如，它们的[均值向量](@entry_id:266544)和协方差矩阵之间的差异。
-   **保留生物信号**：如果已知的生物学变异方向（如代表细胞类型的基因模块）由一组正交基向量 $G$ 张成的[子空间](@entry_id:150286) $S$ 所描述，那么校正过程不应改变数据在 $S$ [子空间](@entry_id:150286)内的[方差](@entry_id:200758)结构。这可以通过一个惩罚项来实现，该惩罚项惩罚校正后数据在 $S$ 上的协[方差](@entry_id:200758)与原始协[方差](@entry_id:200758)的任何偏差。
-   **限制校正范围**：将校正操作限制在与生物信号正交的[子空间](@entry_id:150286) $S^{\perp}$ 内，即批次效应所在的[子空间](@entry_id:150286)。

通过求解这个复杂的[优化问题](@entry_id:266749)，可以得到一个能够精确移除[批次效应](@entry_id:265859)，同时最大限度保留真实生物信号的校正变换。

### 机制 III：整合空间上下文

许多早期的整合方法仅仅利用了基因表达谱，而忽略了空间数据最宝贵的资产：空间坐标 $C$。先进的模型通过将组织的空间结构明确地纳入模型来克服这一局限。

**构建组织空间图**

第一步是将离散的空间测量点转化为一个连续的数学对象—— **图 (graph)**。在这个 **组织空间图** 中，每个空间点 $i$ 是一个节点。如果两个点 $i$ 和 $j$ 在物理上是相邻的，就在它们之间连接一条边 。邻接关系可以通过两种常见方式定义：
-   **半径邻居**：如果两点之间的[欧几里得距离](@entry_id:143990) $d_{ij} = \|C_i - C_j\|_2$ 小于某个半径阈值 $r$，则连接它们。
-   **$k$-近邻 (kNN)**：对于每个点，连接其最近的 $k$ 个邻居。为了确保图是无向的，通常采用互惠kNN或将单向连接对称化。

边的权重 $w_{ij}$ 被设计用来表示邻居之间的“连接强度”或“相似性”。一个符合物理直觉的权重设计应遵循以下原则：
-   **距离衰减**：权重应随物理距离的增加而减小。高斯[核函数](@entry_id:145324) $w_{ij} = \exp(-d_{ij}^2 / 2\sigma^2)$ 是一个常见的选择，其中 $\sigma$ 控制了衰减的速度。
-   **[组织学](@entry_id:147494)边界**：细胞间的相互作用和信号[扩散](@entry_id:141445)通常受到解剖学边界（如不同组织层之间的界限）的限制。如果[组织学](@entry_id:147494)图像可用，我们可以估计一条边跨越这种边界的概率 $\beta_{ij}$，并用它来相应地降低边的权重，例如，将权重乘以 $(1 - \beta_{ij})$。这使得图能够编码真实的[组织结构](@entry_id:146183)。

**[高斯马尔可夫随机场](@entry_id:749746) (GMRF) 先验**

构建了空间图之后，我们就可以利用它来为一个旨在捕捉[空间平滑](@entry_id:202768)效应的潜在变量 $z \in \mathbb{R}^N$ 定义一个 **[先验分布](@entry_id:141376)**。$z_i$可以代表点$i$的某种未被细胞类型解释的残差表达模式、微[环境因子](@entry_id:153764)或细胞状态。我们期望这些[空间效应](@entry_id:148138)是平滑的，即相邻点的 $z_i$ 和 $z_j$ 的值应该相似。

**[高斯马尔可夫随机场](@entry_id:749746) (GMRF)** 是实现这一目标的标准工具 。GMRF先验的概率密度函数形式如下：
$$ p(z) \propto \exp\left(-\frac{\tau}{2} z^{\top} L z\right) $$
这里的关键组成部分是：
-   $L = D - W$：图的 **[拉普拉斯矩阵](@entry_id:152110)**，其中 $W$ 是图的权重矩阵，$D$ 是对角线的度矩阵 ($D_{ii} = \sum_j W_{ij}$)。
-   $z^{\top} L z$：这个二次型可以被展开为 $\sum_{i,j} w_{ij} (z_i - z_j)^2$，即所有相邻点对 $(i,j)$ 上 $z$ 值差异的加权平方和。
-   $\tau$：一个超参数，称为 **精度**，它控制了平滑的强度。$\tau$越大，对邻居间差异的惩罚就越强，得到的潜在变量 $z$ 就越平滑。

这个GMRF先验的本质是，它在统计上“偏爱”那些在图上表现平滑的潜在变量 $z$。在进行联合推断时（例如，寻找[最大后验概率估计](@entry_id:751774)），这个先验项会增加一个梯度项 $-\tau L z$，它会直接将每个 $z_i$ 拉向其邻居的加权平均值。通过这种方式，GMRF先验将空间图的拓扑结构无缝地整合到统计模型中，使得模型能够学习到空间上连续变化的生物学模式，从而极大地丰富了我们从整合分析中获得的生物学洞见。