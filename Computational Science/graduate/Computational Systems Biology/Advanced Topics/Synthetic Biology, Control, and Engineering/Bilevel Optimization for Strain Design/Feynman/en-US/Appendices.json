{
    "hands_on_practices": [
        {
            "introduction": "To effectively apply bilevel optimization, it is essential to first grasp its mathematical underpinnings. This foundational exercise guides you through the formulation of OptKnock, a classic strain design framework, as a bilevel program . You will then learn the critical technique of converting this nested problem into a single-level Mixed-Integer Linear Program (MILP) using linear programming duality, making it solvable with standard optimization software.",
            "id": "3339859",
            "problem": "Consider a small, steady-state metabolic network modeled by constraint-based modeling with Flux Balance Analysis (FBA). Let the internal metabolites be substrate $S$ and precursor $D$, and let the external substrate $S_{\\mathrm{ex}}$, product $P$, and biomass be exchange sinks. The reaction set consists of four irreversible reactions with fluxes $v_1, v_2, v_3, v_4$ defined as follows (all stoichiometric coefficients are integers and all fluxes are nonnegative):\n- $v_1$: import, $S_{\\mathrm{ex}} \\rightarrow S$, with bound $0 \\le v_1 \\le 10$;\n- $v_2$: route A to precursor, $S \\rightarrow D$, with bound $0 \\le v_2 \\le 10$;\n- $v_3$: route B to precursor and product, $2 S \\rightarrow D + P$, with bound $0 \\le v_3 \\le 10$;\n- $v_4$: biomass formation, $D \\rightarrow \\text{Biomass}$, with bound $0 \\le v_4$ and no explicit upper bound.\n\nAt steady state, the internal mass balances for $S$ and $D$ imply the equalities\n$$\nv_1 - v_2 - 2 v_3 = 0, \\quad v_2 + v_3 - v_4 = 0.\n$$\nThe inner (cellular) problem is standard FBA that maximizes growth, i.e., maximizes the biomass flux $v_4$, subject to the steady-state equalities and the given bounds on reaction fluxes. The outer (strain design) problem selects reaction knockouts to maximize product formation $v_3$ at the inner problem’s optimal growth state, allowing at most one knockout chosen from the set $\\{v_2, v_3\\}$.\n\nYou are asked to formulate OptKnock as a bilevel optimization and then derive a single-level Mixed-Integer Linear Programming (MILP) reformulation using linear programming duality of the inner FBA problem. Perform the following:\n\n1. Write the bilevel optimization mathematically. Introduce binary variables $y_2, y_3 \\in \\{0,1\\}$ for the activity of reactions $v_2$ and $v_3$ (with $y_j = 1$ meaning the reaction is present and $y_j = 0$ meaning it is knocked out) and enforce the knockout limit by $(1 - y_2) + (1 - y_3) \\le 1$. Link the reaction activity to flux upper bounds via $v_2 \\le 10\\, y_2$ and $v_3 \\le 10\\, y_3$. Reaction $v_1$ is not knockable and has $y_1 = 1$ implicitly, and reaction $v_4$ is not knockable and has no explicit upper bound.\n\n2. Derive the MILP reformulation by replacing the inner LP with its primal feasibility, dual feasibility, and strong duality conditions. Let the stoichiometric matrix for the internal metabolites be $S \\in \\mathbb{R}^{2 \\times 4}$ with columns corresponding to $(v_1,v_2,v_3,v_4)$, and let the growth objective be $c^\\top v$ with $c = (0,0,0,1)^\\top$. Introduce dual variables $\\pi \\in \\mathbb{R}^2$ for the steady-state equalities (unrestricted in sign), $\\alpha_j \\ge 0$ for the upper bound constraints on $v_j$ where applicable, and $\\beta_j \\ge 0$ for the nonnegativity constraints $v_j \\ge 0$ for $j \\in \\{1,2,3,4\\}$. Explicitly write the dual feasibility conditions, and the strong duality equality that links $v_4$ to the dual variables and reaction upper bounds and activities.\n\n3. Solve the resulting MILP to obtain the outer objective’s optimal value, i.e., the maximum feasible $v_3$ at the inner problem’s optimal growth state, under the knockout limit of at most one reaction from $\\{v_2,v_3\\}$. Provide the single numerical value of this optimal $v_3$. No rounding is required.\n\nYour final answer must be the single real-valued number requested in part $3$.",
            "solution": "The user-provided problem is a well-posed optimization task from the field of computational systems biology. It is scientifically grounded in the principles of Flux Balance Analysis (FBA) and OptKnock, a bilevel optimization framework for metabolic strain design. The problem statement is self-contained, with all necessary reactions, constraints, and objectives clearly defined. The numerical values and stoichiometric coefficients are consistent. Therefore, the problem is valid, and I will proceed with a full solution.\n\nThe solution is presented in three parts as requested by the problem statement.\n\n### Part 1: Bilevel Optimization Formulation\n\nThe problem describes a bilevel optimization scenario. The outer (strain design) problem seeks to maximize the production of $P$, which is measured by the flux $v_3$, by selecting an optimal reaction knockout strategy. The inner (cellular objective) problem describes the cell's behavior, which is assumed to maximize its own growth rate, represented by the biomass flux $v_4$, for a given knockout strategy.\n\nLet $y_2, y_3 \\in \\{0, 1\\}$ be binary variables representing the state of reactions $v_2$ and $v_3$, where $y_j = 1$ indicates the reaction is active and $y_j = 0$ indicates it is knocked out. The constraint that at most one knockout is allowed is formulated as $(1 - y_2) + (1 - y_3) \\le 1$, which simplifies to $y_2 + y_3 \\ge 1$.\n\nThe reaction flux bounds depend on these binary variables. The irreversible reactions $v_2$ and $v_3$ have upper bounds that are switched on or off by their respective $y_j$ variables:\n- $v_2 \\le 10 y_2$\n- $v_3 \\le 10 y_3$\nSince all fluxes must be non-negative ($v_j \\ge 0$), if $y_j=0$, the flux $v_j$ is forced to be $0$. If $y_j=1$, the original bound $v_j \\le 10$ is active. Reaction $v_1$ has a fixed bound $0 \\le v_1 \\le 10$, and $v_4$ has no upper bound, $v_4 \\ge 0$.\n\nThe bilevel formulation is as follows:\n\n**Outer Problem:** Maximize product flux $v_3$ over the choice of knockouts.\n$$\n\\max_{y_2, y_3, v} \\quad v_3\n$$\nsubject to:\n$$\ny_2 + y_3 \\ge 1\n$$\n$$\ny_2, y_3 \\in \\{0, 1\\}\n$$\nwhere the flux vector $v = (v_1, v_2, v_3, v_4)^\\top$ is an optimal solution to the following inner FBA problem, parameterized by $y_2$ and $y_3$:\n\n**Inner Problem:** Maximize biomass flux $v_4$.\n$$\n\\max_{\\bar{v}} \\quad \\bar{v}_4\n$$\nsubject to:\n$$\n\\bar{v}_1 - \\bar{v}_2 - 2 \\bar{v}_3 = 0 \\quad (\\text{Metabolite } S)\n$$\n$$\n\\bar{v}_2 + \\bar{v}_3 - \\bar{v}_4 = 0 \\quad (\\text{Metabolite } D)\n$$\n$$\n0 \\le \\bar{v}_1 \\le 10\n$$\n$$\n0 \\le \\bar{v}_2 \\le 10 y_2\n$$\n$$\n0 \\le \\bar{v}_3 \\le 10 y_3\n$$\n$$\n\\bar{v}_4 \\ge 0\n$$\nThe notation with $\\bar{v}$ for the inner problem is used to distinguish its variables from the variables of the outer problem. The solution $v$ to the bilevel problem must be one of the optimal solutions $\\bar{v}$ of the inner problem.\n\n### Part 2: MILP Reformulation using Duality\n\nTo convert the bilevel program into a single-level Mixed-Integer Linear Program (MILP), the inner linear program is replaced by its Karush-Kuhn-Tucker (KKT) conditions. For an LP, these conditions are primal feasibility, dual feasibility, and strong duality.\n\n**Primal Feasibility:** The constraints of the inner problem must be satisfied. These are already listed above and become constraints in the final MILP.\n\n**Inner Primal in Matrix Form:**\nThe inner problem for a fixed $y$ is:\n$$\n\\max_{v} \\quad c^\\top v \\quad \\text{s.t.} \\quad Sv = 0, \\quad v_{lb} \\le v \\le v_{ub}\n$$\nwhere\n- Flux vector: $v = (v_1, v_2, v_3, v_4)^\\top$\n- Stoichiometric matrix: $S = \\begin{pmatrix} 1 & -1 & -2 & 0 \\\\ 0 & 1 & 1 & -1 \\end{pmatrix}$\n- Objective vector: $c = (0, 0, 0, 1)^\\top$\n- Lower bounds: $v_{lb} = (0, 0, 0, 0)^\\top$\n- Upper bounds: $v_{ub} = (10, 10y_2, 10y_3, \\infty)^\\top$\n\n**Dual Feasibility:** The dual of the inner LP provides the next set of constraints. Let $\\pi = (\\pi_S, \\pi_D)^\\top \\in \\mathbb{R}^2$ be the dual variables for the two equality constraints ($Sv=0$). Let $\\alpha_j \\ge 0$ be the dual variables for the upper bound constraints $v_j \\le v_{j,ub}$, and $\\beta_j \\ge 0$ be the dual variables for the non-negativity constraints $v_j \\ge 0$ (or $-v_j \\le 0$). The dual constraints are given by $S^\\top \\pi + \\alpha - \\beta = c$.\nSince $v_4$ has no finite upper bound, its corresponding dual variable $\\alpha_4$ must be $0$.\n\nThe specific dual feasibility constraints are:\n1. For $v_1$:  $1 \\cdot \\pi_S + 0 \\cdot \\pi_D + \\alpha_1 - \\beta_1 = 0 \\implies \\pi_S + \\alpha_1 - \\beta_1 = 0$\n2. For $v_2$: $-1 \\cdot \\pi_S + 1 \\cdot \\pi_D + \\alpha_2 - \\beta_2 = 0 \\implies -\\pi_S + \\pi_D + \\alpha_2 - \\beta_2 = 0$\n3. For $v_3$: $-2 \\cdot \\pi_S + 1 \\cdot \\pi_D + \\alpha_3 - \\beta_3 = 0 \\implies -2\\pi_S + \\pi_D + \\alpha_3 - \\beta_3 = 0$\n4. For $v_4$:  $0 \\cdot \\pi_S - 1 \\cdot \\pi_D + \\alpha_4 - \\beta_4 = 1 \\implies -\\pi_D - \\beta_4 = 1$ (since $\\alpha_4=0$)\nwith $\\pi_S, \\pi_D$ unrestricted in sign and $\\alpha_1, \\alpha_2, \\alpha_3 \\ge 0$ and $\\beta_1, \\beta_2, \\beta_3, \\beta_4 \\ge 0$.\n\n**Strong Duality:** For LPs, strong duality states that at optimality, the primal objective value equals the dual objective value.\n$$\nc^\\top v = v_{ub}^\\top \\alpha - v_{lb}^\\top \\beta\n$$\nSince $v_{lb}=0$, the term $v_{lb}^\\top \\beta$ is zero. The upper bounds are $(10, 10y_2, 10y_3, \\infty)$. The strong duality equation is:\n$$\nv_4 = 10 \\alpha_1 + (10 y_2) \\alpha_2 + (10 y_3) \\alpha_3\n$$\nThe terms $y_2 \\alpha_2$ and $y_3 \\alpha_3$ are nonlinear. In a full MILP formulation, they would be linearized, for example by introducing new variables $w_j = y_j \\alpha_j$ and adding constraints like $w_j \\le M y_j$, $w_j \\le \\alpha_j$, $w_j \\ge \\alpha_j - M(1-y_j)$, and $w_j \\ge 0$ for a sufficiently large constant $M$.\n\nCombining these components yields a single-level MILP that is equivalent to the original bilevel problem.\n\n### Part 3: Solving for the Optimal Product Flux\n\nThe outer problem involves selecting from a small set of knockout strategies. We can solve the problem by enumerating all valid strategies, solving the resulting optimization problem for each, and choosing the strategy that yields the maximum $v_3$. The valid strategies are:\n- Case 1: No knockouts ($y_2=1, y_3=1$)\n- Case 2: Knockout $v_2$ ($y_2=0, y_3=1$)\n- Case 3: Knockout $v_3$ ($y_2=1, y_3=0$)\n\nFor each case, we first find the maximum biomass flux ($v_4^{max}$) and then find the maximum product flux ($v_3$) achievable while maintaining this maximal growth.\n\n**Case 1: No Knockouts ($y_2=1, y_3=1$)**\nThe FBA problem is to maximize $v_4$ subject to:\n$v_1 - v_2 - 2 v_3 = 0$\n$v_2 + v_3 - v_4 = 0 \\implies v_4 = v_2 + v_3$\n$0 \\le v_1 \\le 10$\n$0 \\le v_2 \\le 10$\n$0 \\le v_3 \\le 10$\nSubstituting $v_1$ from the first equation into its bound: $0 \\le v_2 + 2v_3 \\le 10$.\nWe maximize $v_4 = v_2 + v_3$ over the feasible region in $(v_2, v_3)$ space defined by $v_2 \\ge 0$, $v_3 \\ge 0$, $v_2 \\le 10$, $v_3 \\le 10$, and $v_2 + 2v_3 \\le 10$.\nThe vertices of the feasible region are $(0,0)$, $(10,0)$, and $(0,5)$.\n- At $(v_2, v_3)=(0,0)$, $v_4 = 0$.\n- At $(v_2, v_3)=(10,0)$, $v_4 = 10$.\n- At $(v_2, v_3)=(0,5)$, $v_4 = 5$.\nThe maximum growth is $v_4^{max} = 10$, uniquely achieved at the flux distribution where $v_2=10$ and $v_3=0$.\nSince the state of maximum growth is unique, the product flux is uniquely determined to be $v_3=0$.\n\n**Case 2: Knockout $v_2$ ($y_2=0, y_3=1$)**\nWith $v_2=0$, the constraints become:\n$v_1 - 2 v_3 = 0 \\implies v_1 = 2 v_3$\n$v_3 - v_4 = 0 \\implies v_4 = v_3$\n$0 \\le v_1 \\le 10$\n$0 \\le v_3 \\le 10$\nTo maximize growth $v_4$, we maximize $v_3$. The constraint on $v_1$ gives $0 \\le 2v_3 \\le 10$, which implies $0 \\le v_3 \\le 5$. This is more restrictive than $v_3 \\le 10$.\nThe maximum possible value for $v_3$ is $5$, so the maximum growth is $v_4^{max} = 5$.\nThis maximum growth is achieved for $v_3=5$. Thus, at the optimal growth state, the product flux is $v_3=5$.\n\n**Case 3: Knockout $v_3$ ($y_2=1, y_3=0$)**\nWith $v_3=0$, the constraints become:\n$v_1 - v_2 = 0 \\implies v_1 = v_2$\n$v_2 - v_4 = 0 \\implies v_4 = v_2$\n$0 \\le v_1 \\le 10$\n$0 \\le v_2 \\le 10$\nTo maximize growth $v_4$, we maximize $v_2$. The constraints imply $0 \\le v_2 \\le 10$.\nThe maximum growth is $v_4^{max} = 10$, achieved at $v_2=10$.\nThe flux $v_3$ is constrained to be $0$ by the knockout. So, at the optimal growth state, the product flux is $v_3=0$.\n\n**Conclusion**\nWe compare the maximum achievable $v_3$ values from each valid knockout strategy:\n- Wild type (no KO): $v_3 = 0$\n- $v_2$ knockout: $v_3 = 5$\n- $v_3$ knockout: $v_3 = 0$\nThe maximum value for the outer objective (maximum $v_3$) is $5$. This is achieved by knocking out reaction $v_2$.",
            "answer": "$$\\boxed{5}$$"
        },
        {
            "introduction": "After understanding the theory, the next step is to translate the bilevel concept into a working program. This practice challenges you to implement a complete bilevel optimization algorithm for a toy metabolic network by enumerating all possible knockout strategies . This hands-on coding task reinforces the nested structure of the problem, where an outer-level engineering choice (gene knockouts) is evaluated by solving an inner-level cellular optimization problem (maximization of growth followed by a worst-case product assessment).",
            "id": "3290717",
            "problem": "You are given a toy case study in bilevel optimization for strain design framed in Flux Balance Analysis (FBA). The organism is represented by a minimal metabolic network with steady-state mass balance and irreversible reaction bounds. The bilevel design problem models an upper-level engineer choosing reaction knockouts to maximize worst-case product formation at the lower-level organism’s optimal growth. You must implement a complete, runnable program that evaluates the worst-case product formation under all allowable knockout sets and returns the best choice.\n\nFundamental base and assumptions:\n- Flux Balance Analysis (FBA) uses the steady-state approximation for intracellular metabolites, which yields linear equalities of the form $S\\,\\mathbf{v}=\\mathbf{0}$, where $S$ is the stoichiometric matrix and $\\mathbf{v}$ is the vector of reaction fluxes.\n- Reaction fluxes are bounded by irreversible constraints $\\ell_i \\le v_i \\le u_i$ for each reaction $i$.\n- The organism’s growth is modeled by a biomass reaction flux $v_2$, which the organism maximizes at steady-state.\n- The lower-level organism is assumed to potentially choose among multiple growth-optimal flux distributions; here, we evaluate the pessimistic case in which, among all flux vectors that achieve maximum growth, the organism chooses one that minimizes product secretion flux $v_3$. This corresponds to a lexicographic bilevel: first maximize $v_2$, then minimize $v_3$ subject to the same constraints and with the additional equality $v_2=v_2^\\star$, where $v_2^\\star$ is the optimal growth obtained from the first step.\n\nNetwork definition:\n- Reactions indexed as $R_0, R_1, R_2, R_3, R_4$ with fluxes $v_0, v_1, v_2, v_3, v_4$ respectively:\n  - $R_0$: Glucose uptake $G_{\\mathrm{ext}} \\rightarrow G$.\n  - $R_1$: Oxygen uptake $O_{\\mathrm{ext}} \\rightarrow O$.\n  - $R_2$: Biomass growth $G + 2\\,O \\rightarrow \\mathrm{Biomass}$.\n  - $R_3$: Product formation $G \\rightarrow P_{\\mathrm{ext}}$.\n  - $R_4$: Waste formation $G \\rightarrow W_{\\mathrm{ext}}$.\n- Internal steady-state mass balance equalities on intracellular glucose $G$ and oxygen $O$:\n  - $v_0 - v_2 - v_3 - v_4 = 0$,\n  - $v_1 - 2\\,v_2 = 0$.\n- Bounds:\n  - Fixed glucose uptake: $v_0 \\in [G_{\\mathrm{fixed}},\\,G_{\\mathrm{fixed}}]$, where $G_{\\mathrm{fixed}}$ is a specified nonnegative number.\n  - Oxygen uptake: $v_1 \\in [0,\\,O_{\\max}]$, where $O_{\\max}$ is a specified nonnegative number.\n  - Biomass growth minimum viability: $v_2 \\in [\\gamma,\\,U_2]$ with $\\gamma \\ge 0$ and $U_2$ a large upper bound (you may choose $U_2=100$).\n  - Product and waste fluxes: $v_3 \\in [0,\\,U_3]$, $v_4 \\in [0,\\,U_4]$ with large bounds (you may choose $U_3=U_4=100$).\n- Candidate knockouts are restricted to the set $\\{R_3, R_4\\}$. A knockout of reaction $R_i$ implements $v_i=0$ via bounds $[0,0]$.\n\nBilevel optimization definition:\n- Upper level chooses a knockout set $\\mathcal{K} \\subseteq \\{3,4\\}$ with $|\\mathcal{K}| \\le K$ to maximize the worst-case product flux at lower-level optimum growth:\n  1. Lower-level step $1$: maximize $v_2$ subject to mass balances and bounds with knockouts in $\\mathcal{K}$ applied.\n  2. Lower-level step $2$: among solutions that achieve the optimal growth $v_2^\\star$, minimize $v_3$ with the same constraints and with the additional equality $v_2=v_2^\\star$.\n- The upper-level objective is the minimal product flux $v_3^{\\min}(\\mathcal{K})$ returned by step $2$; the engineer selects $\\mathcal{K}$ that maximizes this value.\n\nBitmask encoding of knockout sets:\n- Reactions are indexed $0,1,2,3,4$ corresponding to $R_0,R_1,R_2,R_3,R_4$.\n- A knockout set $\\mathcal{K}$ is encoded as an integer bitmask $M$ where bit $i$ is $1$ if reaction $R_i$ is knocked out and $0$ otherwise. For example, knocking out only $R_4$ corresponds to $M=2^4=16$, knocking out only $R_3$ corresponds to $M=2^3=8$, and no knockouts corresponds to $M=0$.\n\nYour task:\n- Implement a program in the specified environment that:\n  - Enumerates all knockout sets $\\mathcal{K} \\subseteq \\{3,4\\}$ with $|\\mathcal{K}| \\le K$.\n  - For each $\\mathcal{K}$, solves the lower-level step $1$ (maximize $v_2$). If infeasible, discard $\\mathcal{K}$.\n  - For feasible $\\mathcal{K}$, solves the lower-level step $2$ (minimize $v_3$ with $v_2=v_2^\\star$). If infeasible, discard $\\mathcal{K}$.\n  - Selects $\\mathcal{K}$ that maximizes the worst-case product flux $v_3^{\\min}(\\mathcal{K})$. In case of ties, choose the smallest bitmask $M$.\n- For any test case where no knockout set yields feasibility in step $1$, return the sentinel pair $[-1,-1.0]$.\n\nTest suite:\n- You must implement the following test cases as a list, each defined by $[G_{\\mathrm{fixed}},\\,O_{\\max},\\,\\gamma,\\,K]$:\n  1. $[10,\\,6,\\,2.5,\\,1]$: happy path with oxygen limiting growth and one allowed knockout.\n  2. $[10,\\,6,\\,2.5,\\,0]$: boundary with no knockouts allowed.\n  3. $[5,\\,6,\\,2.0,\\,1]$: reduced glucose forcing less leftover carbon.\n  4. $[10,\\,6,\\,2.5,\\,2]$: up to two knockouts allowed; the set knocking out both product and waste may become infeasible.\n  5. $[10,\\,4,\\,2.5,\\,1]$: oxygen too low to meet minimum growth, making all sets infeasible.\n\nRequired final output format:\n- Your program should produce a single line of output containing the results for the test suite as a comma-separated list enclosed in square brackets, where each element is a two-element list $[M, v_3]$ for the selected knockout bitmask $M$ and the corresponding worst-case product flux $v_3$, in the order of the test cases. For example, $[[M_1,v_{3,1}], [M_2,v_{3,2}], \\dots]$.\n- Express each $v_3$ as a floating-point number. No physical units are required for this toy model.",
            "solution": "The problem presents a valid, well-posed bilevel optimization task for metabolic strain design. The objective is to determine an optimal set of reaction knockouts to maximize the worst-case formation of a target product. The problem is framed within Flux Balance Analysis (FBA), a standard constraint-based modeling approach in computational systems biology. The solution requires iteratively solving a series of Linear Programming (LP) problems.\n\nThe core of the problem consists of a two-level optimization structure:\n1.  An **upper level**, representing an engineer, chooses a knockout strategy $$\\mathcal{K}$$ from a set of allowed modifications.\n2.  A **lower level**, representing the cell's metabolism, optimizes its own objective (growth) given the genetic modifications imposed by the upper level.\n\nWe assume a pessimistic or worst-case scenario for the lower level: among all possible metabolic states (flux distributions) that achieve maximum growth, the cell will adopt one that minimizes the production of the desired compound.\n\nThe overall algorithm proceeds by enumerating all permissible knockout strategies, evaluating the outcome of each, and selecting the best one according to the engineer's objective.\n\n**Mathematical Formulation**\n\nThe metabolic network is described by a system of linear equations and inequalities. Let the vector of reaction fluxes be $$\\mathbf{v} = [v_0, v_1, v_2, v_3, v_4]^T$$.\n\nThe steady-state mass balance constraints are given as $$S\\mathbf{v}=\\mathbf{0}$$. For this specific network, the explicit equations are:\n$$v_0 - v_2 - v_3 - v_4 = 0$$\n$$v_1 - 2v_2 = 0$$\n\nThese two equations can be written in matrix form as $$A_{eq}\\mathbf{v}=\\mathbf{b}_{eq}$$, where:\n$$\nA_{eq} = \\begin{pmatrix}\n1 & 0 & -1 & -1 & -1 \\\\\n0 & 1 & -2 & 0 & 0\n\\end{pmatrix}\n, \\quad \\mathbf{b}_{eq} = \\begin{pmatrix} 0 \\\\ 0 \\end{pmatrix}\n$$\n\nThe flux for each reaction $$i$$ is also constrained by lower and upper bounds, $$\\ell_i \\le v_i \\le u_i$$. For a given test case with parameters $$G_{\\mathrm{fixed}}$$, $$O_{\\max}$$, and $$\\gamma$$, the base bounds are:\n- $$v_0 \\in [G_{\\mathrm{fixed}}, G_{\\mathrm{fixed}}]$$\n- $$v_1 \\in [0, O_{\\max}]$$\n- $$v_2 \\in [\\gamma, 100]$$\n- $$v_3 \\in [0, 100]$$\n- $$v_4 \\in [0, 100]$$\n\nA reaction knockout of $$R_i$$ is implemented by setting its bounds to $$[0, 0]$$. The candidate reactions for knockout are $$R_3$$ and $$R_4$$.\n\n**Bilevel Optimization Algorithm**\n\nFor each test case, we must consider all valid knockout sets $$\\mathcal{K} \\subseteq \\{3, 4\\}$$ where the number of knockouts $$|\\mathcal{K}|$$ does not exceed the given limit $$K$$. Each set $$\\mathcal{K}$$ is encoded by an integer bitmask $$M$$. We evaluate each valid mask $$M$$.\n\nFor a given mask $$M$$:\n1.  **Lower-Level Step 1: Maximize Growth**\n    We first solve for the maximum possible biomass flux $$v_2$$. This is a Linear Programming (LP) problem:\n    $$\n    \\begin{align*}\n    v_2^\\star = \\max_{\\mathbf{v}} \\quad & v_2 \\\\\n    \\text{subject to} \\quad & A_{eq}\\mathbf{v} = \\mathbf{b}_{eq} \\\\\n    & \\ell_i(M) \\le v_i \\le u_i(M) \\quad \\text{for } i=0, \\dots, 4\n    \\end{align*}\n    $$\n    The bounds $$\\ell_i(M)$$ and $$u_i(M)$$ are the base bounds modified according to the knockouts in $$M$$. If this LP is infeasible (i.e., no flux vector can satisfy all constraints, such as the minimum growth requirement $$\\gamma$$), the knockout strategy $$M$$ is discarded.\n\n2.  **Lower-Level Step 2: Minimize Product Flux (Worst-Case)**\n    If Step 1 is feasible, we find the worst-case product flux by minimizing $$v_3$$ while constraining the growth rate to its maximum achievable value, $$v_2^\\star$$. This is a second LP problem:\n    $$\n    \\begin{align*}\n    v_3^{\\min}(M) = \\min_{\\mathbf{v}} \\quad & v_3 \\\\\n    \\text{subject to} \\quad & A_{eq}\\mathbf{v} = \\mathbf{b}_{eq} \\\\\n    & \\ell_i(M) \\le v_i \\le u_i(M) \\quad \\text{for } i=0, \\dots, 4 \\\\\n    & v_2 = v_2^\\star\n    \\end{align*}\n    $$\n    The value $$v_3^{\\min}(M)$$ is the guaranteed minimum product yield for the knockout strategy $$M$$.\n\n**Upper-Level Decision**\n\nAfter evaluating $$v_3^{\\min}(M)$$ for all feasible and permissible masks $$M$$, the upper-level problem is to select the mask $$M^\\star$$ that maximizes this value:\n$$ M^\\star = \\arg\\max_{M} \\{v_3^{\\min}(M)\\} $$\nIn case of a tie in $$v_3^{\\min}$$ values, the mask with the smallest integer value $$M$$ is chosen. If no knockout strategy results in a feasible model, the sentinel value $$[-1, -1.0]$$ is returned for that test case.\n\n**Implementation Details**\n\nThe described algorithm is implemented using Python with the `scipy.optimize.linprog` function, which solves standard-form LP problems.\n- Maximization of $$v_2$$ is achieved by minimizing $$-v_2$$, i.e., using an objective vector $$c = [0, 0, -1, 0, 0]^T$$.\n- The constraint $v_2 = v_2^\\star$ in the second LP is implemented by setting the bounds for the variable $v_2$ to `[v_2_star, v_2_star]`.\n- The program iterates through the provided test cases, applies the bilevel algorithm for each, and reports the optimal mask and corresponding worst-case product flux.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import linprog\n\ndef solve_case(G_fixed, O_max, gamma, K):\n    \"\"\"\n    Solves the bilevel optimization problem for a single test case.\n    \n    Args:\n        G_fixed (float): The fixed glucose uptake rate.\n        O_max (float): The maximum oxygen uptake rate.\n        gamma (float): The minimum required biomass flux for viability.\n        K (int): The maximum number of allowed knockouts.\n\n    Returns:\n        list: A list containing the best knockout mask and the corresponding\n              worst-case product flux, e.g., [mask, v3_min].\n              Returns [-1, -1.0] if no feasible strategy is found.\n    \"\"\"\n    # Stoichiometric matrix for equality constraints v0-v2-v3-v4=0, v1-2v2=0\n    A_eq = np.array([\n        [1, 0, -1, -1, -1],  # Glucose balance\n        [0, 1, -2, 0, 0]     # Oxygen balance\n    ])\n    b_eq = np.array([0, 0])\n    \n    # Large upper bound for unconstrained fluxes\n    U_large = 100.0\n    \n    # Base bounds for the fluxes [v0, v1, v2, v3, v4]\n    base_bounds = [\n        (G_fixed, G_fixed),   # v0: Glucose uptake\n        (0, O_max),           # v1: Oxygen uptake\n        (gamma, U_large),     # v2: Biomass growth\n        (0, U_large),         # v3: Product formation\n        (0, U_large)          # v4: Waste formation\n    ]\n\n    # Define all possible knockout strategies (mask, number of knockouts)\n    # R3 knockout corresponds to bit 3 (2^3=8)\n    # R4 knockout corresponds to bit 4 (2^4=16)\n    knockout_options = [\n        (0, 0),    # No knockouts\n        (8, 1),    # Knockout R3\n        (16, 1),   # Knockout R4\n        (24, 2)    # Knockout R3 and R4\n    ]\n    \n    # Filter for strategies that are permissible under the K limit\n    masks_to_test = [m for m, k_count in knockout_options if k_count = K]\n    \n    best_mask = -1\n    best_v3_min = -1.0\n\n    for M in masks_to_test:\n        bounds = base_bounds.copy()\n        \n        # Apply knockouts by setting the bounds of the flux to [0, 0]\n        if M  8:  # Test bit 3 for R3 knockout\n            bounds[3] = (0, 0)\n        if M  16: # Test bit 4 for R4 knockout\n            bounds[4] = (0, 0)\n        \n        # --- Lower-Level Step 1: Maximize v2 ---\n        # Objective: max(v2) is equivalent to min(-v2)\n        c1 = np.array([0, 0, -1, 0, 0])\n        res1 = linprog(c=c1, A_eq=A_eq, b_eq=b_eq, bounds=bounds, method='highs')\n        \n        if not res1.success:\n            continue  # This knockout strategy is infeasible.\n        \n        v2_star = -res1.fun\n\n        # --- Lower-Level Step 2: Minimize v3 at optimal growth ---\n        bounds_step2 = bounds.copy()\n        # Enforce v2 = v2_star by setting the bounds for v2\n        bounds_step2[2] = (v2_star, v2_star)\n        \n        # Objective: min(v3)\n        c2 = np.array([0, 0, 0, 1, 0])\n        res2 = linprog(c=c2, A_eq=A_eq, b_eq=b_eq, bounds=bounds_step2, method='highs')\n        \n        if not res2.success:\n            # This would be an unexpected failure, but we handle it defensively.\n            continue\n            \n        v3_min = res2.fun\n\n        # --- Upper-Level: Update best result ---\n        if best_mask == -1:\n            best_mask = M\n            best_v3_min = v3_min\n        else:\n            # Update if current v3_min is better, or if it's a tie and the mask is smaller\n            # Using a tolerance for robust float comparison\n            if v3_min > best_v3_min + 1e-9:\n                best_v3_min = v3_min\n                best_mask = M\n            elif abs(v3_min - best_v3_min)  1e-9 and M  best_mask:\n                best_mask = M\n    \n    return [best_mask, float(best_v3_min)]\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # [G_fixed, O_max, gamma, K]\n        [10, 6, 2.5, 1],\n        [10, 6, 2.5, 0],\n        [5, 6, 2.0, 1],\n        [10, 6, 2.5, 2],\n        [10, 4, 2.5, 1],\n    ]\n\n    results = []\n    for case in test_cases:\n        result = solve_case(*case)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    # The default str() representation of a list includes a space, e.g., '[16, 7.0]',\n    # which is consistent with the problem's example format of `[M, v_3]`.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "A key goal of metabolic engineering is to create strains that perform reliably under diverse conditions. This practice moves beyond single-condition optimization to the more realistic challenge of robust strain design . You will tackle a multi-scenario bilevel problem where a single genetic design must be effective across several distinct environments, each with its own constraints, aiming to maximize the guaranteed worst-case product yield.",
            "id": "3290694",
            "problem": "Consider a multi-scenario bilevel strain design problem based on steady-state Flux Balance Analysis (FBA). The intracellular steady-state condition is represented by the linear constraint $S v^{(k)} = 0$ for each scenario index $k$, where $S \\in \\mathbb{R}^{m \\times n}$ is a stoichiometric matrix, $v^{(k)} \\in \\mathbb{R}^n$ is the reaction flux vector for scenario $k$, and bounds $l^{(k)} \\le v^{(k)} \\le u^{(k)}$ are imposed componentwise. The inner problem in each scenario $k$ selects a flux vector $v^{(k)}$ that maximizes a growth objective $c_{\\mu}^\\top v^{(k)}$, where $c_{\\mu} \\in \\mathbb{R}^n$. To make the product flux uniquely defined at optimal growth, a lexicographic criterion is used: first solve the growth maximization to obtain the optimal growth value $\\mu^{*(k)}$, then, among all flux vectors that achieve growth at least $\\mu^{*(k)}$, select the one that maximizes a product objective $c_{p}^\\top v^{(k)}$. The outer problem selects a single design $x$ from a finite catalog $\\mathcal{X}$ that modifies the bounds $(l^{(k)}, u^{(k)})$ in a design-dependent manner, with the goal of maximizing the worst-case product flux across all scenarios, while ensuring scenario-wise viability thresholds on the optimal growth values. Formally, for a given $x \\in \\mathcal{X}$ and scenario $k$, define the design-modified bounds as $l^{(k)}(x), u^{(k)}(x)$ and define the inner growth optimum as\n$$\n\\mu^{*(k)}(x) \\;=\\; \\max_{v \\in \\mathbb{R}^n} \\;\\; c_{\\mu}^\\top v \\quad \\text{subject to} \\quad S v = 0,\\;\\; l^{(k)}(x) \\le v \\le u^{(k)}(x).\n$$\nImpose a viability requirement $\\mu^{*(k)}(x) \\ge \\underline{\\mu}^{(k)}$ for each scenario $k$, where $\\underline{\\mu}^{(k)} \\in \\mathbb{R}_{\\ge 0}$ is given. Then define the product-yielding lexicographic step for each $k$ as\n$$\nv_{p}^{(k)}(x) \\;=\\; \\max_{v \\in \\mathbb{R}^n} \\;\\; c_{p}^\\top v \\quad \\text{subject to} \\quad S v = 0,\\;\\; l^{(k)}(x) \\le v \\le u^{(k)}(x),\\;\\; c_{\\mu}^\\top v \\ge \\mu^{*(k)}(x) - \\tau,\n$$\nwith a small tolerance $\\tau \\in \\mathbb{R}_{0}$ to avoid numerical issues. The outer problem chooses $x \\in \\mathcal{X}$ to maximize the worst-case product,\n$$\n\\max_{x \\in \\mathcal{X}} \\;\\; \\min_{k} \\; v_{p}^{(k)}(x) \\qquad \\text{subject to} \\qquad \\mu^{*(k)}(x) \\ge \\underline{\\mu}^{(k)} \\;\\; \\text{for all}\\; k.\n$$\nYou must implement a program that, for the following test suite of three cases, computes the optimal outer objective value as a real number for each case and outputs the results as a single line.\n\nAll three cases use the same stoichiometric matrix $S \\in \\mathbb{R}^{2 \\times 5}$ with $n = 5$ reactions and $m = 2$ intracellular metabolites. The reactions are ordered as follows: $v_1$ is glucose uptake, $v_2$ is biomass formation (growth), $v_3$ is precursor formation, $v_4$ is product formation, and $v_5$ is a competing waste route. The metabolites are ordered as intracellular glucose and the intracellular precursor. The stoichiometric matrix $S$ is\n$$\nS \\;=\\; \\begin{bmatrix}\n1  -1  -1  0  -1\\\\\n0  0  1  -1  0\n\\end{bmatrix}.\n$$\nThe growth objective vector is $c_{\\mu} = \\begin{bmatrix}0  1  0  0  0\\end{bmatrix}^\\top$, and the product objective vector is $c_{p} = \\begin{bmatrix}0  0  0  1  0\\end{bmatrix}^\\top$. All lower bounds are $0$ unless otherwise modified by the design. Each scenario $k$ has its own upper bounds $u^{(k)}$ as specified below, with common lower bounds $l^{(k)} = \\begin{bmatrix}0  0  0  0  0\\end{bmatrix}^\\top$ before design modifications.\n\nA single design $x$ must be selected from the discrete set $\\mathcal{X} = \\{x^{(0)}, x^{(1)}, x^{(2)}, x^{(3)}\\}$. The design-dependent bound modifications are defined as follows. For any scenario $k$, let $u^{(k)}_{\\text{base}}$ denote the base upper bounds before design; then:\n1. Baseline design $x^{(0)}$ imposes no changes, that is, $u^{(k)}(x^{(0)}) = u^{(k)}_{\\text{base}}$ and $l^{(k)}(x^{(0)}) = l^{(k)}$.\n2. Waste knockout design $x^{(1)}$ eliminates the competing route by setting the upper bound of $v_5$ to $0$ in every scenario, that is, $u^{(k)}(x^{(1)})_5 = 0$ with all other components equal to $u^{(k)}_{\\text{base}}$.\n3. Growth cap design $x^{(2)}$ imposes an upper bound cap on $v_2$ of $4$, that is, $u^{(k)}(x^{(2)})_2 = \\min\\{u^{(k)}_{\\text{base},2}, 4\\}$ in every scenario, with all other components equal to $u^{(k)}_{\\text{base}}$.\n4. Product overexpression design $x^{(3)}$ increases the product capacity by a factor of $3$, that is, $u^{(k)}(x^{(3)})_4 = 3 \\, u^{(k)}_{\\text{base},4}$ in every scenario, with all other components equal to $u^{(k)}_{\\text{base}}$.\n\nIn all cases, use the lexicographic tolerance $\\tau = 10^{-9}$. Each case consists of three scenarios with specified base upper bounds $u^{(k)}_{\\text{base}}$ and viability thresholds $\\underline{\\mu}^{(k)}$ as follows.\n\nCase A:\nThe three scenarios have base upper bounds\n$$\nu^{(1)}_{\\text{base}} = \\begin{bmatrix}10  100  100  3  8\\end{bmatrix}^\\top,\\quad\nu^{(2)}_{\\text{base}} = \\begin{bmatrix}5  100  100  1.5  4\\end{bmatrix}^\\top,\\quad\nu^{(3)}_{\\text{base}} = \\begin{bmatrix}8  100  100  2  7\\end{bmatrix}^\\top.\n$$\nThe viability thresholds are\n$$\n\\underline{\\mu}^{(1)} = 0.5,\\quad \\underline{\\mu}^{(2)} = 0.2,\\quad \\underline{\\mu}^{(3)} = 0.2.\n$$\n\nCase B:\nThe base upper bounds are the same as in Case A. The viability thresholds are stricter,\n$$\n\\underline{\\mu}^{(1)} = 6,\\quad \\underline{\\mu}^{(2)} = 4.5,\\quad \\underline{\\mu}^{(3)} = 4.\n$$\n\nCase C:\nThe base upper bounds are the same as in Case A except that the third scenario has a tighter product capacity,\n$$\nu^{(3)}_{\\text{base}} = \\begin{bmatrix}8  100  100  0.5  7\\end{bmatrix}^\\top.\n$$\nThe viability thresholds are the same as in Case A,\n$$\n\\underline{\\mu}^{(1)} = 0.5,\\quad \\underline{\\mu}^{(2)} = 0.2,\\quad \\underline{\\mu}^{(3)} = 0.2.\n$$\n\nFor each case, the task is to compute the optimal outer objective value, namely the maximum over $x \\in \\mathcal{X}$ of the minimum across $k$ of the lexicographic product flux $v_{p}^{(k)}(x)$, subject to the viability constraints $\\mu^{*(k)}(x) \\ge \\underline{\\mu}^{(k)}$ for all scenarios $k$. Your program must solve the inner problems as described and enumerate the finite design set to determine the best $x$ for each case.\n\nAngle units are not used. There are no physical units in the numerical output. The required final output format is a single line containing a Python-style list of three floating-point numbers, one per case in the order A, B, C. Each number must be rounded to exactly six decimal places. For example, the format must be like $[a,b,c]$ where $a$, $b$, and $c$ are floats with six digits after the decimal point and no spaces after commas, such as $[1.234000,0.000100,5.600000]$.",
            "solution": "The problem statement describes a multi-scenario bilevel optimization problem for metabolic strain design. The task is to identify an optimal design strategy from a finite catalog that maximizes the worst-case product yield across several environmental scenarios, subject to viability constraints on cellular growth. The problem is well-posed, scientifically grounded in the principles of Flux Balance Analysis (FBA), and provides all necessary data for a unique solution. We can therefore proceed with a full solution.\n\nThe overall problem can be formulated as:\n$$\n\\max_{x \\in \\mathcal{X}} \\left( \\min_{k} v_{p}^{(k)}(x) \\right)\n$$\nsubject to the viability constraint that for each scenario $k$, the maximal growth rate $\\mu^{*(k)}(x)$ must satisfy $\\mu^{*(k)}(x) \\ge \\underline{\\mu}^{(k)}$. A design $x$ that fails this condition for any scenario $k$ is considered non-viable and is excluded from the set of candidate solutions for the outer maximization problem.\n\nThe core of the problem lies in solving the inner lexicographic optimization for each design $x \\in \\mathcal{X}$ and scenario $k$. This involves two sequential Linear Programs (LPs).\n\n**Step 1: Analytical Simplification of the Metabolic Model**\n\nFirst, we analyze the steady-state mass balance constraint $S v = 0$, where $v = [v_1, v_2, v_3, v_4, v_5]^\\top$. The stoichiometric matrix is given as:\n$$\nS = \\begin{bmatrix}\n1  -1  -1  0  -1 \\\\\n0  0  1  -1  0\n\\end{bmatrix}\n$$\nThis matrix equation corresponds to two linear equations:\n1. $v_1 - v_2 - v_3 - v_5 = 0$\n2. $v_3 - v_4 = 0$\n\nFrom the second equation, we directly obtain $v_3 = v_4$. Substituting this into the first equation yields $v_1 = v_2 + v_4 + v_5$.\nThese two relations show that the $5$-dimensional flux vector $v$ is determined by three independent fluxes. We can choose the growth flux $v_2$, the product flux $v_4$, and the waste flux $v_5$ as our independent variables. The remaining fluxes, precursor formation $v_3$ and glucose uptake $v_1$, are dependent.\n\nThe full set of constraints for the LPs can be reformulated in terms of these independent fluxes. For any given design $x$ and scenario $k$, let the bounds be $l^{(k)}(x) \\le v \\le u^{(k)}(x)$. Given that all base lower bounds are $l_i = 0$, we have $v_i \\ge 0$ for all reactions $i \\in \\{1, \\dots, 5\\}$. The upper bounds $u_i$ on the dependent fluxes impose constraints on the independent ones:\n- $v_1 \\le u_1 \\implies v_2 + v_4 + v_5 \\le u_1$\n- $v_3 \\le u_3 \\implies v_4 \\le u_3$\n\nCombining these with the direct bounds on the independent fluxes, the feasible space for $(v_2, v_4, v_5)$ is defined by:\n- $v_2 + v_4 + v_5 \\le u_1$\n- $0 \\le v_2 \\le u_2$\n- $0 \\le v_4 \\le \\min(u_3, u_4)$\n- $0 \\le v_5 \\le u_5$\n\n**Step 2: Solving the Inner Optimization Problems**\n\nWith the simplified constraints, we can find analytical solutions for the two inner LPs. For a given design $x$ and scenario $k$, the bounds $(u_1, u_2, u_3, u_4, u_5)$ are fixed.\n\n**LP 1: Growth Maximization**\nThe first objective is to maximize the growth flux, $c_\\mu^\\top v = v_2$.\n$$\n\\mu^{*(k)}(x) = \\max_{v_2, v_4, v_5} v_2\n$$\nsubject to the simplified constraints. To maximize $v_2$, we must choose the smallest possible non-negative values for $v_4$ and $v_5$ in the constraint $v_2 + v_4 + v_5 \\le u_1$. The minimum values are $v_4=0$ and $v_5=0$. This reduces the constraints on $v_2$ to $v_2 \\le u_1$ and $v_2 \\le u_2$. Therefore, the optimal growth rate is:\n$$\n\\mu^{*(k)}(x) = \\min(u_1, u_2)\n$$\n\n**LP 2: Product Maximization (Lexicographic Step)**\nThe second objective is to maximize the product flux, $c_p^\\top v = v_4$, subject to achieving a growth rate of at least $\\mu^{*(k)}(x) - \\tau$.\n$$\nv_p^{(k)}(x) \\text{ value} = \\max_{v_2, v_4, v_5} v_4\n$$\nsubject to the simplified constraints and the additional lexicographic constraint:\n$$\nv_2 \\ge \\mu^{*(k)}(x) - \\tau\n$$\nTo maximize $v_4$, we must choose the smallest possible values for $v_2$ and $v_5$ in the constraint $v_2 + v_4 + v_5 \\le u_1$. The minimum allowed value for $v_2$ is $\\mu^{*(k)}(x) - \\tau$. The minimum value for $v_5$ is $0$. Substituting these into the inequality gives:\n$$\n(\\mu^{*(k)}(x) - \\tau) + v_4 + 0 \\le u_1 \\implies v_4 \\le u_1 - \\mu^{*(k)}(x) + \\tau\n$$\nThe final maximal product flux is also limited by its own capacity, $v_4 \\le \\min(u_3, u_4)$. Thus, the solution is:\n$$\nv_p^{(k)}(x) \\text{ value} = \\min(\\min(u_3, u_4), u_1 - \\mu^{*(k)}(x) + \\tau)\n$$\nSubstituting the expression for $\\mu^{*(k)}(x) = \\min(u_1, u_2)$:\n$$\nv_p^{(k)}(x) \\text{ value} = \\min(\\min(u_3, u_4), u_1 - \\min(u_1, u_2) + \\tau)\n$$\n\n**Step 3: Algorithmic Evaluation of Designs**\n\nWith these analytical solutions, we can implement the full procedure by iterating through the finite set of designs for each case. For each case (A, B, C):\n1. Initialize the maximum worst-case product, $P_{\\text{opt}}$, to a very small number (e.g., $-\\infty$).\n2. For each design $x \\in \\{x^{(0)}, x^{(1)}, x^{(2)}, x^{(3)}\\}$:\n   a. Initialize a flag, `is_viable`, to `true` and a list, `product_fluxes`, to store results for the scenarios.\n   b. For each scenario $k \\in \\{1, 2, 3\\}$:\n      i. Determine the upper bounds $u^{(k)}(x)$ by applying the modification rule for design $x$ to the base upper bounds $u^{(k)}_{\\text{base}}$.\n      ii. Calculate the maximal growth rate $\\mu^{*(k)}(x) = \\min(u_1, u_2)$.\n      iii. Check for viability: If $\\mu^{*(k)}(x)  \\underline{\\mu}^{(k)}$, set `is_viable` to `false` and break from the scenario loop, as this design is invalid.\n      iv. If viable, calculate the maximal product flux $v_p^{(k)}(x)$ using the derived formula. Append this value to `product_fluxes`.\n   c. If `is_viable` remains `true` after checking all scenarios:\n      i. Find the worst-case (minimum) product flux for this design: $P_{\\text{worst}}(x) = \\min(\\text{product\\_fluxes})$.\n      ii. Update the overall optimum: $P_{\\text{opt}} = \\max(P_{\\text{opt}}, P_{\\text{worst}}(x))$.\n3. The final value $P_{\\text{opt}}$ is the answer for the case. If no design is viable, the maximum is taken over an empty set, conventionally $-\\infty$. In this problem, at least one design proves viable for each case.\n\nBy applying this algorithm to the data supplied for Cases A, B, and C, we can compute the required optimal objective values. For example, in Case A with design $x^{(2)}$, the growth is capped at $u_2=4$. For scenario $1$, the new bounds are $[10, 4, 100, 3, 8]^\\top$. The growth is $\\mu^* = \\min(10, 4) = 4$, which exceeds the threshold $\\underline{\\mu}^{(1)}=0.5$. The product flux is $\\min(\\min(100, 3), 10 - 4 + \\tau) = \\min(3, 6+\\tau) = 3$. This process is repeated for all designs and scenarios to find the final optimum. For Case B, the stricter viability thresholds $\\underline{\\mu}^{(k)}$ render design $x^{(2)}$ non-viable because its capped growth of $4$ is less than $\\underline{\\mu}^{(1)}=6$ and $\\underline{\\mu}^{(2)}=4.5$. The final optimal values are derived from the best-performing viable design for each case.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the multi-scenario bilevel strain design problem for three given cases.\n    \"\"\"\n    \n    # Global parameters from the problem statement\n    tau = 1e-9\n    designs = ['baseline', 'waste_ko', 'growth_cap', 'product_over']\n\n    def solve_case(base_upper_bounds, viability_thresholds):\n        \"\"\"\n        Calculates the optimal outer objective value for a single case.\n\n        This involves iterating through all possible designs, checking their viability\n        across all scenarios, and finding the design that maximizes the worst-case\n        product flux.\n        \"\"\"\n        max_worst_case_product = -np.inf\n\n        for design in designs:\n            scenario_product_fluxes = []\n            design_is_viable = True\n\n            for k in range(3):  # Iterate through the three scenarios\n                u_base = base_upper_bounds[k]\n                u_mod = u_base.copy()\n\n                # Apply design modifications to the base upper bounds\n                if design == 'waste_ko':\n                    # Design x^(1): Waste knockout\n                    u_mod[4] = 0.0\n                elif design == 'growth_cap':\n                    # Design x^(2): Growth cap\n                    u_mod[1] = min(u_base[1], 4.0)\n                elif design == 'product_over':\n                    # Design x^(3): Product overexpression\n                    u_mod[3] = 3.0 * u_base[3]\n\n                u1, u2, u3, u4, u5 = u_mod\n\n                # Analytically solve the inner optimization problems\n                \n                # LP1: Maximize growth (v_2)\n                # mu_star = min(u_1, u_2)\n                mu_star = min(u1, u2)\n\n                # Check viability constraint for the current scenario\n                if mu_star  viability_thresholds[k]:\n                    design_is_viable = False\n                    break  # This design is not viable, no need to check other scenarios\n\n                # LP2: Maximize product (v_4) subject to near-optimal growth\n                # vp = min(min(u_3, u_4), u_1 - min(u_1, u_2) + tau)\n                u4_prime = min(u3, u4)\n                if u1 = u2:\n                    # In this case, u_1 - min(u_1, u_2) = u_1 - u_1 = 0\n                    vp = min(u4_prime, tau)\n                else: # u1 > u2\n                    # In this case, u_1 - min(u_1, u_2) = u_1 - u_2\n                    vp = min(u4_prime, u1 - u2 + tau)\n                \n                scenario_product_fluxes.append(vp)\n            \n            # If the design was viable across all scenarios, evaluate its performance\n            if design_is_viable:\n                worst_case_product = min(scenario_product_fluxes)\n                if worst_case_product > max_worst_case_product:\n                    max_worst_case_product = worst_case_product\n\n        # If no design was viable, the result is -inf.\n        # The problem setup ensures at least one design is viable.\n        if max_worst_case_product == -np.inf:\n            return 0.0\n        \n        return max_worst_case_product\n\n    # Define the test cases from the problem statement.\n    case_A_ubs = [\n        np.array([10., 100., 100., 3., 8.]),\n        np.array([5., 100., 100., 1.5, 4.]),\n        np.array([8., 100., 100., 2., 7.])\n    ]\n    case_A_mus = [0.5, 0.2, 0.2]\n\n    # Case B uses the same bounds as Case A but with stricter viability thresholds.\n    case_B_ubs = case_A_ubs\n    case_B_mus = [6.0, 4.5, 4.0]\n\n    # Case C modifies the bounds of the third scenario from Case A.\n    case_C_ubs = [\n        np.array([10., 100., 100., 3., 8.]),\n        np.array([5., 100., 100., 1.5, 4.]),\n        np.array([8., 100., 100., 0.5, 7.])\n    ]\n    case_C_mus = case_A_mus\n\n    test_cases = [\n        (case_A_ubs, case_A_mus),\n        (case_B_ubs, case_B_mus),\n        (case_C_ubs, case_C_mus),\n    ]\n\n    results = []\n    for ubs, mus in test_cases:\n        result = solve_case(ubs, mus)\n        results.append(result)\n\n    # Format the final output string as specified.\n    formatted_results = [f\"{r:.6f}\" for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}