{
    "hands_on_practices": [
        {
            "introduction": "第一反应法是随机模拟的核心方法之一。本练习提供了一个动手实践的机会，让您从基本原理出发，手动执行一个完整的模拟步骤。通过推导候选反应时间的计算公式，并将其应用于一个具体的数值案例，您将深刻体会到该算法如何将随机数转化为下一次生化事件发生的精确时间和具体类型 。",
            "id": "3351938",
            "problem": "考虑一个处于固定离散状态 $x$ 的充分混合反应系统，该系统有 $M=3$ 个反应通道。在此状态下，（时齐）反应倾向分别为 $a_1(x)=2$、$a_2(x)=5$ 和 $a_3(x)=3$，单位为 $\\mathrm{s}^{-1}$。在 Gillespie 随机模拟算法（SSA）的“第一反应”法中，我们为每个通道抽取一个独立的均匀分布随机变量 $r_i \\sim \\mathrm{Uniform}(0,1)$，并将其映射为每个通道的候选反应发生时间。假设抽取的独立随机数为 $r_1=0.2$、$r_2=0.7$ 和 $r_3=0.9$。\n\n从化学主方程（CME）下反应 $i$ 的瞬时风险率这一定义出发，仅使用指数等待时间和逆变换采样的基本性质，推导从每个 $r_i$ 到其对应候选等待时间的映射关系。然后，明确确定“第一反应”法的结果 $(\\tau,J)$，其中 $\\tau$ 是下一次反应发生的时间，而 $J$ 是发生反应的索引。\n\n请以自然对数形式给出 $\\tau$ 的精确表达式，并以整数形式给出 $J$。时间单位为秒。如果您选择报告 $\\tau$ 的数值近似值，请四舍五入至六位有效数字。",
            "solution": "此问题经核实具有科学依据、提法明确且客观。所有必要信息均已提供，所要求的任务是计算系统生物学中随机模拟算法背后理论的标准应用。\n\n解答过程分为两部分。首先，我们推导将均匀分布随机数映射到候选反应时间的通用公式。其次，我们将此公式应用于所提供的具体数据，以确定“第一反应”法的结果。\n\n**第 1 部分：候选等待时间公式的推导**\n\n随机模拟算法（SSA）的基本前提是，对于处于给定状态 $x$ 的充分混合系统，每个反应通道 $i$ 的行为都像一个独立的泊松过程。该过程的参数是反应倾向 $a_i(x)$。反应倾向 $a_i(x)$ 的定义是：在时间 $t$ 系统处于状态 $x$ 的条件下，反应 $i$ 在无穷小时间间隔 $[t, t+dt)$ 内发生的概率为 $a_i(x)dt$。这使得 $a_i(x)$ 成为反应 $i$ 的瞬时风险率。\n\n设 $\\tau_i$ 为随机变量，表示在没有其他反应发生的情况下，等待反应 $i$ 下一次发生的时间。设 $P_i(t')$ 为到时间 $t'$ 时反应 $i$ 尚未发生的概率。这个生存概率的下降速率与该概率本身成正比，比例常数即为风险率 $a_i(x)$。这给出了微分方程：\n$$\n\\frac{dP_i(t')}{dt'} = -a_i(x) P_i(t')\n$$\n这是一个一阶线性常微分方程。在初始条件 $P_i(0)=1$（即在时间 $t'=0$ 时，反应肯定尚未发生）下，解为：\n$$\nP_i(t') = \\exp(-a_i(x) t')\n$$\n这就是随机变量 $\\tau_i$ 的生存函数。累积分布函数（CDF）$F_i(t')$ 给出到时间 $t'$ 时反应 $i$ *已经*发生的概率，其表达式为：\n$$\nF_i(t') = 1 - P_i(t') = 1 - \\exp(-a_i(x) t')\n$$\n这是速率参数为 $a_i(x)$ 的指数分布的累积分布函数。\n\n为了从该分布中生成一个样本变量 $\\tau_i$，我们使用逆变换采样法。我们从区间 $(0,1)$ 上的均匀分布中抽取一个随机数 $r_i$，即 $r_i \\sim \\mathrm{Uniform}(0,1)$，并令其等于在所需时间 $\\tau_i$ 处计算的累积分布函数值：\n$$\nr_i = F_i(\\tau_i) = 1 - \\exp(-a_i(x) \\tau_i)\n$$\n我们现在求解此方程以得到 $\\tau_i$：\n$$\n\\exp(-a_i(x) \\tau_i) = 1 - r_i\n$$\n对两边取自然对数：\n$$\n-a_i(x) \\tau_i = \\ln(1 - r_i)\n$$\n$$\n\\tau_i = -\\frac{1}{a_i(x)} \\ln(1 - r_i)\n$$\n由于 $r_i$ 是 $(0,1)$ 上的均匀分布随机变量，因此 $(1 - r_i)$ 也是 $(0,1)$ 上的均匀分布随机变量。因此，为了简化和提高计算效率，我们可以将 $(1 - r_i)$ 替换为另一个均匀分布随机变量，在不失一般性的情况下，我们也可以称之为 $r_i$。这就得到了标准公式：\n$$\n\\tau_i = -\\frac{1}{a_i(x)} \\ln(r_i) = \\frac{1}{a_i(x)} \\ln\\left(\\frac{1}{r_i}\\right)\n$$\n这就是从均匀分布随机数 $r_i$ 到反应通道 $i$ 的候选等待时间 $\\tau_i$ 的所需映射关系。\n\n**第 2 部分：确定“第一反应”法的结果 $(\\tau, J)$**\n\n“第一反应”法包括为 $M$ 个反应通道中的每一个计算一个候选时间 $\\tau_i$，然后选择具有最小候选时间的反应作为下一个发生的反应。下一次反应发生的时间 $\\tau$ 是这些候选时间中的最小值，而反应的索引 $J$ 是对应于此最小时间的索引。\n$$\n\\tau = \\min_{i=1,..,M} \\{\\tau_i\\}\n$$\n$$\nJ = \\arg\\min_{i=1,..,M} \\{\\tau_i\\}\n$$\n我们已知以下值：\n反应通道数：$M=3$。\n反应倾向：$a_1(x) = 2 \\, \\mathrm{s}^{-1}$、$a_2(x) = 5 \\, \\mathrm{s}^{-1}$ 和 $a_3(x) = 3 \\, \\mathrm{s}^{-1}$。\n随机数：$r_1=0.2$、$r_2=0.7$ 和 $r_3=0.9$。\n\n使用推导出的公式 $\\tau_i = \\frac{1}{a_i(x)} \\ln\\left(\\frac{1}{r_i}\\right)$，我们计算每个通道的候选时间：\n对于通道 1：\n$$\n\\tau_1 = \\frac{1}{a_1(x)} \\ln\\left(\\frac{1}{r_1}\\right) = \\frac{1}{2} \\ln\\left(\\frac{1}{0.2}\\right) = \\frac{1}{2} \\ln(5)\n$$\n对于通道 2：\n$$\n\\tau_2 = \\frac{1}{a_2(x)} \\ln\\left(\\frac{1}{r_2}\\right) = \\frac{1}{5} \\ln\\left(\\frac{1}{0.7}\\right) = \\frac{1}{5} \\ln\\left(\\frac{10}{7}\\right)\n$$\n对于通道 3：\n$$\n\\tau_3 = \\frac{1}{a_3(x)} \\ln\\left(\\frac{1}{r_3}\\right) = \\frac{1}{3} \\ln\\left(\\frac{1}{0.9}\\right) = \\frac{1}{3} \\ln\\left(\\frac{10}{9}\\right)\n$$\n现在我们必须找到 $\\{\\tau_1, \\tau_2, \\tau_3\\}$ 的最小值。由于 $\\ln(z)$ 是一个单调递增函数，比较 $\\tau_i = \\frac{1}{k_i} \\ln(z_i)$ 等价于比较 $\\ln(z_i^{1/k_i})$。因此，我们需要比较以下参数：\n$z_1^{1/a_1} = 5^{1/2} = \\sqrt{5}$\n$z_2^{1/a_2} = \\left(\\frac{10}{7}\\right)^{1/5}$\n$z_3^{1/a_3} = \\left(\\frac{10}{9}\\right)^{1/3}$\n\n让我们来计算这些参数的值：\n$\\sqrt{5} \\approx 2.236$\n$\\left(\\frac{10}{7}\\right)^{1/5} \\approx (1.42857)^{0.2} \\approx 1.0738$\n$\\left(\\frac{10}{9}\\right)^{1/3} \\approx (1.11111)^{0.333...} \\approx 1.0358$\n\n比较这些值，我们发现 $\\left(\\frac{10}{9}\\right)^{1/3}$ 是最小的。\n$$\n\\left(\\frac{10}{9}\\right)^{1/3}  \\left(\\frac{10}{7}\\right)^{1/5}  5^{1/2}\n$$\n因此，根据自然对数的单调性：\n$$\n\\ln\\left(\\left(\\frac{10}{9}\\right)^{1/3}\\right)  \\ln\\left(\\left(\\frac{10}{7}\\right)^{1/5}\\right)  \\ln\\left(5^{1/2}\\right)\n$$\n化简后得到：\n$$\n\\frac{1}{3} \\ln\\left(\\frac{10}{9}\\right)  \\frac{1}{5} \\ln\\left(\\frac{10}{7}\\right)  \\frac{1}{2} \\ln(5)\n$$\n这表明 $\\tau_3  \\tau_2  \\tau_1$。\n\n下一次反应发生的时间 $\\tau$ 是这些时间的最小值，而发生反应的索引 $J$ 是该最小时间对应的索引。\n$$\n\\tau = \\min\\{\\tau_1, \\tau_2, \\tau_3\\} = \\tau_3 = \\frac{1}{3} \\ln\\left(\\frac{10}{9}\\right) \\text{ 秒}\n$$\n$$\nJ = \\arg\\min\\{\\tau_1, \\tau_2, \\tau_3\\} = 3\n$$\n问题要求给出 $\\tau$ 的精确表达式。$\\tau$ 的数值近似值，四舍五入到六位有效数字，约为 $0.0351202 \\, \\mathrm{s}$。要求的输出是精确的解析表达式和整数索引。\n\n“第一反应”法的结果是 $(\\tau, J) = \\left(\\frac{1}{3} \\ln\\left(\\frac{10}{9}\\right), 3\\right)$。",
            "answer": "$$\n\\boxed{\\begin{pmatrix} \\frac{1}{3}\\ln\\left(\\frac{10}{9}\\right)  3 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "虽然直接法和下一反应法在数学上是等价的，但它们的计算性能可能存在显著差异。本练习将引导您从第一性原理出发，对这两种方法的效率进行分析，特别是关注每步事件所消耗的随机数数量。对于处理大型复杂生物网络而言，理解这些算法之间的权衡是选择最优模拟策略的关键 。",
            "id": "3351967",
            "problem": "考虑一个充分混合的化学反应网络，该网络被建模为一个具有 $M$ 个反应通道 $\\{R_{i}\\}_{i=1}^{M}$ 和状态依赖的倾向函数 $\\{a_{i}(\\boldsymbol{x})\\}_{i=1}^{M}$ 的连续时间跳跃过程。令 $a_{0}(\\boldsymbol{x}) = \\sum_{i=1}^{M} a_{i}(\\boldsymbol{x})$ 表示总倾向。在整个过程中，假设系统在一个状态空间中演化，其中所有倾向都保持严格为正，即对于轨迹上的所有 $i$ 和所有时间 $t$，都有 $a_{i}(\\boldsymbol{x}(t))  0$，因此没有任何反应通道被禁用。该演化过程使用随机模拟算法 (SSA) 进行模拟，该算法在每个事件中，将时间推进一个随机增量，并选择一个通道发生反应。\n\n从以下基本原理出发：\n- 随机时间变换表示：每个反应通道 $R_{i}$ 都可以表示为一个单位速率泊松过程，该过程通过积分风险率 $\\int_{0}^{t} a_{i}(\\boldsymbol{x}(s)) \\,\\mathrm{d}s$ 进行时间变换。\n- 逆变换采样原理：速率为 $a$ 的指数分布等待时间可以通过单个均匀分布 $U(0,1)$ 的随机变量 $r$ 经由 $\\tau = -\\frac{1}{a} \\ln(r)$ 获得，并且在具有概率 $\\{p_{i}\\}_{i=1}^{M}$ 的 $M$ 个结果中进行分类选择，可以使用单个 $U(0,1)$ 随机变量和累积阈值来完成。\n\n对于两种 SSA 变体：\n1. 直接法，该方法对下一个反应时间进行采样，然后根据当前状态下的瞬时概率 $a_{i}(\\boldsymbol{x})/a_{0}(\\boldsymbol{x})$ 选择反应索引。\n2. 下一反应法 (Gibson–Bruck)，该方法为每个通道 $i$ 维护一个预定的发生时间，该时间由指数分布的内部时间导出，并在倾向发生变化时确定性地更新预定时间，仅在一个通道发生反应时才抽取新的随机变量。\n\n根据所述假设，从第一性原理出发，推导直接法和下一反应法在每个已执行的反应事件中消耗的独立 $U(0,1)$ 随机变量的期望数量。然后，基于你的推导，讨论当 $M$ 变大时对计算性能的渐近影响，特别关注随机数生成在每事件成本中的作用，并将其与每种方法固有的其他算法成本进行对比。将你的最终答案以行矩阵的形式报告，其中依次包含直接法和下一反应法的期望计数。无需四舍五入，最终答案中不包含任何单位。",
            "solution": "该问题是有效的，因为它在科学上基于随机化学动力学的既定理论，问题设定良好，目标明确，并且使用客观、无歧义的语言表述。它提出了计算系统生物学中两种基石算法的标准且非平凡的比较。\n\n此问题要求推导两种不同的随机模拟算法 (SSA)：直接法 (DM) 和下一反应法 (NRM)，在每个反应事件中消耗的随机变量的期望数量。该分析基于逆变换采样原理，用于从指定分布生成随机变量。\n\n设系统在时间 $t$ 的状态由物种种群数量向量 $\\boldsymbol{x}(t)$ 描述。系统有 $M$ 个反应通道，反应 $R_i$ 的倾向由 $a_i(\\boldsymbol{x})$ 给出。总倾向为 $a_0(\\boldsymbol{x}) = \\sum_{i=1}^{M} a_i(\\boldsymbol{x})$。我们已知对于所有 $i$ 和 $t$，都有 $a_i(\\boldsymbol{x}(t))  0$。\n\n**1. 直接法 (DM)**\n\n由 Gillespie 开发的直接法通过在每一步重复回答两个问题来模拟系统的轨迹：(1) 下一个反应何时发生？以及 (2) 它将是哪个反应？\n\n*   **步骤 1：对到下一个事件的时间进行采样。**\n    直到下一个反应事件（任何类型）发生的时间 $\\tau$ 是一个随机变量，服从速率参数等于总倾向 $a_0(\\boldsymbol{x})$ 的指数分布。使用所提供的逆变换采样原理，我们可以从一个均匀分布的随机变量 $r_1 \\sim U(0,1)$ 生成 $\\tau$ 的值。\n    $$ \\tau = -\\frac{1}{a_0(\\boldsymbol{x})} \\ln(r_1) $$\n    此步骤恰好消耗**一个**独立的随机变量 $r_1$。\n\n*   **步骤 2：对下一个反应的索引进行采样。**\n    给定一个反应在时间 $t+\\tau$ 发生，它是反应 $R_i$ 的概率由其倾向与总倾向之比给出，即 $p_i = a_i(\\boldsymbol{x})/a_0(\\boldsymbol{x})$。因此，选择反应索引 $\\mu \\in \\{1, \\dots, M\\}$ 是从具有概率 $\\{p_i\\}_{i=1}^{M}$ 的分类分布中进行的一次抽样。这可以通过使用第二个独立的均匀随机变量 $r_2 \\sim U(0,1)$ 来完成。我们寻找满足以下条件的索引 $\\mu$：\n    $$ \\sum_{i=1}^{\\mu-1} a_i(\\boldsymbol{x})  r_2 \\cdot a_0(\\boldsymbol{x}) \\le \\sum_{i=1}^{\\mu} a_i(\\boldsymbol{x}) $$\n    此步骤恰好消耗**一个**独立的随机变量 $r_2$。\n\n在这两个采样步骤之后，算法根据反应 $R_\\mu$ 的化学计量将时间更新为 $t+\\tau$ 并更新状态向量 $\\boldsymbol{x}$。这些更新是确定性的。\n\n由于直接法中的每个反应事件都需要执行步骤 1 和步骤 2，因此每个事件消耗的独立 $U(0,1)$ 随机变量的总数是恒定的。\nDM 的期望数量 = $1$ (用于时间) + $1$ (用于反应索引) = $2$。\n\n**2. 下一反应法 (NRM)**\n\n下一反应法（也称为 Gibson-Bruck 算法）重新构建了模拟过程以避免冗余计算。它为 $M$ 个反应通道中的每一个都维护一个预定的绝对发生时间 $T_i$。这些时间存储在一个数据结构中，通常是一个优先队列，以便高效地检索最小时间。\n\n设系统在时间 $t$ 处于状态 $\\boldsymbol{x}$，预定的发生时间集合为 $\\{T_i\\}_{i=1}^{M}$。单个事件按以下方式进行：\n\n*   **步骤 1：识别下一个事件。**\n    下一个要发生的反应 $R_\\mu$ 是具有最小预定发生时间的反应。算法找到索引 $\\mu$ 使得 $T_\\mu = \\min_{j \\in \\{1, \\dots, M\\}} \\{T_j\\}$。事件的时间是 $t_{event} = T_\\mu$。此步骤是一个确定性搜索，消耗**零个**随机变量。\n\n*   **步骤 2：更新状态和时间。**\n    模拟时间前进到 $t_{event}$，状态向量 $\\boldsymbol{x}$ 根据反应 $R_\\mu$ 的化学计量更新为 $\\boldsymbol{x}'$。这是一个确定性更新。\n\n*   **步骤 3：更新预定的发生时间。**\n    这一步是 NRM 效率的核心。\n    *   **对于刚刚发生反应的通道 ($R_\\mu$)：** 必须安排一个新的发生时间。这需要从速率为新倾向 $a_\\mu(\\boldsymbol{x}')$ 的指数分布中生成一个新的随机等待时间 $\\Delta T_\\mu$。使用逆变换采样和一个新的随机变量 $r' \\sim U(0,1)$：\n        $$ \\Delta T_\\mu = -\\frac{1}{a_\\mu(\\boldsymbol{x}')} \\ln(r') $$\n        通道 $\\mu$ 的新的绝对预定时间是 $T_\\mu^{\\text{new}} = t_{event} + \\Delta T_\\mu$。此子步骤恰好消耗**一个**随机变量。\n    *   **对于所有其他通道 ($R_i$，其中 $i \\neq \\mu$)：** 由于状态从 $\\boldsymbol{x}$ 变为 $\\boldsymbol{x}'$，倾向 $a_i$ 可能会改变。NRM 利用随机时间变换表示来确定性地更新它们的预定时间，而无需新的随机数。其关键洞见在于，底层的“随机性”（先前抽取的随机数中未实现的部分）被保留了下来。剩余的发生时间 $(T_i - t_{event})$，它被旧倾向 $a_i(\\boldsymbol{x})$ 隐式缩放，现在被新倾向 $a_i(\\boldsymbol{x}')$ 重新缩放。新的预定时间 $T_i^{\\text{new}}$ 计算如下：\n        $$ T_i^{\\text{new}} = t_{event} + \\frac{a_i(\\boldsymbol{x})}{a_i(\\boldsymbol{x}')} (T_i - t_{event}) $$\n        此更新是完全确定性的，消耗**零个**随机变量。假设 $a_i  0$ 确保了分母不为零。\n\n因此，对于每个已执行的反应事件，NRM 恰好抽取一个新随机数，用于安排刚刚发生反应的通道的下一次发生。\nNRM 的期望数量 = $1$。\n\n**3. 对计算性能的渐近影响**\n\n上述分析表明，直接法每个事件消耗 $2$ 个随机变量，而下一反应法消耗 $1$ 个。仅基于随机数生成 (RNG) 的成本，NRM 的效率是前者的两倍。然而，对于大的 $M$，RNG 成本的作用与其他算法成本相比变得可以忽略不计。\n\n*   **随机数生成的作用：** 生成随机数的成本是每次调用 $O(1)$。对于 DM 和 NRM，专门用于 RNG 的总每事件成本因此相对于 $M$ 是 $O(1)$。虽然 NRM 有一个更好的常数因子（$1$ 对比 $2$），但这种差异不影响算法的渐近标度。在现代计算机体系结构中，高质量的伪随机数生成器速度极快，使得这种常数因子的差异成为总执行时间的一个次要组成部分。\n\n*   **其他内在算法成本：** 对于大的 $M$，性能的主导因素是算法中非 RNG 组件的标度。\n    *   **直接法：** 在每一步，DM 必须计算所有 $M$ 个倾向以求其总和 $a_0$，这是一个 $O(M)$ 的操作。随后，它执行线性搜索来选择反应通道，这也是一个 $O(M)$ 的操作。因此，DM 的每事件总复杂度为 $O(M)$。\n    *   **下一反应法：** NRM 的性能在很大程度上取决于用于优先队列的数据结构以及反应网络的依赖结构。\n        *   使用二叉堆查找最小时间是 $O(1)$。\n        *   更新时间是主要成本。对于已发生反应，更新堆的成本是 $O(\\log M)$。对于其他倾向发生变化的反应（假设有 $N_{dep}$ 个这样的反应），每次更新的成本也是 $O(\\log M)$。因此，总成本为 $O((1+N_{dep})\\log M)$。\n        *   在**稀疏网络**中，每个反应只影响少量、恒定数量的其他倾向，$N_{dep}$ 很小，每事件成本为 $O(\\log M)$。这种对数标度是 NRM 的标志性优势，使其在大型稀疏系统中远优于 DM。\n        *   在**密集网络**中，单个反应几乎可以影响所有其他倾向，$N_{dep}$ 趋近于 $M$，每事件成本变为 $O(M \\log M)$。在这种情况下，NRM 在渐近意义上比 $O(M)$ 的直接法慢。\n\n*   **性能结论：** 渐近性能不是由随机数生成的 $O(1)$ 成本决定的，而是由事件发生后更新系统状态的算法复杂度决定的。NRM 的真正优势在于其在稀疏网络中的 $O(\\log M)$ 标度，这源于它能够在每一步避免重新评估每个通道的能力。每个事件节省一个随机数是一个次要的好处，在渐近意义上是微不足道的。\n\n推导出的每个事件消耗的随机变量的期望数量，直接法为 $2$，下一反应法为 $1$。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n2  1\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "随机模拟算法不仅是强大的预测工具，也是进行模型推断的利器。这个实践性的编程练习旨在连接模拟与数据分析，引导您解决系统生物学中的一个核心问题：如何从观测到的反应轨迹中估计模型参数。您将通过实现最大似然估计来求解反应速率常数，并利用这些估计值构建潜在化学主方程的生成元矩阵，从而将微观的模拟事件与宏观的系统动力学联系起来 。",
            "id": "3351918",
            "problem": "考虑一个通过连续时间马尔可夫链 (CTMC) 建模的充分混合反应网络，其中随机模拟算法 (SSA) 的直接法和第一反应法变体均基于依赖于状态的反应倾向。设反应集合由 $j \\in \\{1,\\dots,R\\}$ 索引。在状态 $x$ 下，反应 $j$ 的倾向为 $a_j(x)$。总倾向为 $a_0(x) = \\sum_{j=1}^{R} a_j(x)$。在直接法中，从状态 $x$ 到下一个事件的等待时间呈指数分布，速率为 $a_0(x)$，下一个反应以概率 $a_j(x)/a_0(x)$ 被选中。在第一反应法中，为每个反应启动速率为 $a_j(x)$ 的独立指数时钟；最小的时钟决定下一个事件。这两种方法是等价的，并从同一个 CTMC 生成样本路径。\n\n您将通过最大似然法从观测到的 SSA 事件序列中估计反应参数，并构建化学主方程 (CME) 的生成元。假设参数化形式为 $a_j(x) = \\theta_j h_j(x)$，其中 $h_j(x)$ 是一个已知的非负函数，而 $\\theta_j$ 是一个待估计的未知非负参数。一条观测到的轨迹包括一个初始状态 $x(0)$、一个事件时间序列 $0  t_1  \\cdots  t_N \\le T$（单位为秒）、相关的反应索引 $j_1,\\dots,j_N$ 以及状态更新 $x(t_n^+) = x(t_n^-) + \\nu_{j_n}$，其中 $\\nu_j$ 是反应 $j$ 的化学计量变化向量。在事件之间，状态是恒定的。似然函数是利用马尔可夫跳跃过程的基本性质构建的：等待时间服从速率为 $a_0(x)$ 的指数分布，并且在发生跳跃的条件下，反应 $j$ 以概率 $a_j(x)/a_0(x)$ 被选择。请利用这一点，从观测到的轨迹中推导并实现对每个反应 $j$ 的 $\\theta_j$ 的最大似然估计。然后，使用您的估计值，在一个指定的有限状态集 $\\mathcal{X}$上构建一个截断的生成元矩阵 $Q$，其非对角线项为 $Q_{x,y} = a_j(x)$（如果对于某个 $j$ 有 $y = x + \\nu_j \\in \\mathcal{X}$），对角线项为 $Q_{x,x} = -\\sum_{y \\ne x} Q_{x,y}$。将您的 $\\hat{\\theta}_j$ 估计值与生成元项关联起来，并验证 $Q$ 的行和为零。\n\n所有时间都必须以秒为单位处理。您的实现必须计算每个测试用例在最大似然估计值下的对数似然。如果一个反应的总暴露度（即 $\\int_0^T h_j(x(t)) \\, dt = 0$）和事件数均为零，则按照约定将其最大似然估计值定义为 $0$。如果一个反应的暴露度为零但事件数大于零，则数据不一致；您可以假设在提供的测试套件中不会发生这种情况。\n\n测试套件规范：\n提供代码以解决以下三个测试用例（时间单位为秒，单个物种数量表示为 $x$）：\n- 测试用例 1：两个反应，$R = 2$。\n  - 反应 1：$X \\rightarrow 2X$，化学计量 $\\nu_1 = +1$，倾向 $a_1(x) = \\theta_1 h_1(x)$，其中 $h_1(x) = x$。\n  - 反应 2：$X \\rightarrow \\varnothing$，化学计量 $\\nu_2 = -1$，倾向 $a_2(x) = \\theta_2 h_2(x)$，其中 $h_2(x) = x$。\n  - 初始状态 $x(0) = 2$。\n  - 事件时间与反应索引：$(t_1,j_1) = (0.5,1)$、$(t_2,j_2) = (1.4,2)$、$(t_3,j_3) = (2.0,1)$、$(t_4,j_4) = (3.2,2)$、$(t_5,j_5) = (4.0,1)$。\n  - 结束时间 $T = 5.0$。\n  - 生成元的截断集：$\\mathcal{X} = \\{0,1,2,3,4,5\\}$。\n- 测试用例 2：两个反应，$R = 2$。\n  - 反应 1：$X \\rightarrow \\varnothing$，$\\nu_1 = -1$，$a_1(x) = \\theta_1 h_1(x)$，其中 $h_1(x) = x$。\n  - 反应 2：$\\varnothing \\rightarrow X$，$\\nu_2 = +1$，$a_2(x) = \\theta_2 h_2(x)$，其中 $h_2(x) = 1$。\n  - 初始状态 $x(0) = 1$。\n  - 事件时间与反应索引：$(t_1,j_1) = (1.0,2)$、$(t_2,j_2) = (1.7,2)$、$(t_3,j_3) = (2.2,1)$、$(t_4,j_4) = (2.9,1)$。\n  - 结束时间 $T = 4.0$。\n  - 生成元的截断集：$\\mathcal{X} = \\{0,1,2,3,4,5\\}$。\n- 测试用例 3：两个反应，$R = 2$。\n  - 反应 1：$2X \\rightarrow \\varnothing$，$\\nu_1 = -2$，$a_1(x) = \\theta_1 h_1(x)$，其中 $h_1(x) = x(x-1)/2$。\n  - 反应 2：$\\varnothing \\rightarrow X$，$\\nu_2 = +1$，$a_2(x) = \\theta_2 h_2(x)$，其中 $h_2(x) = 1$。\n  - 初始状态 $x(0) = 0$。\n  - 事件时间与反应索引：$(t_1,j_1) = (0.8,2)$、$(t_2,j_2) = (1.6,2)$、$(t_3,j_3) = (2.4,2)$。\n  - 结束时间 $T = 3.0$。\n  - 生成元的截断集：$\\mathcal{X} = \\{0,1,2,3\\}$。\n\n实现要求：\n- 对于每个测试用例，计算所有 $j$ 的最大似然估计值 $\\hat{\\theta}_j$、在 $\\hat{\\theta}$ 处的对数似然，并构建在指定 $\\mathcal{X}$ 上的截断生成元矩阵 $Q$。验证 $Q$ 的每一行在数值容差范围内和为零。\n- 您的程序应生成单行输出，包含所有测试用例的结果，形式为用方括号括起来的逗号分隔列表，其中每个测试用例的结果本身是一个格式为 $[\\hat{\\theta}_1,\\hat{\\theta}_2,\\dots,\\text{row\\_sums\\_zero},\\text{logL}]$ 的列表。布尔值 $\\text{row\\_sums\\_zero}$ 必须是 $\\text{True}$ 或 $\\text{False}$。所有浮点数表示为四舍五入到 $6$ 位小数。输出行内任何地方都不允许有空格。例如，最终输出应类似于 $[[\\cdots],[\\cdots],[\\cdots]]$。",
            "solution": "该问题要求推导并实现随机反应网络参数的最大似然估计 (MLE)，该网络被建模为连续时间马尔可夫链 (CTMC)。从观测到的轨迹进行参数估计后，必须构建相关的化学主方程 (CME) 的截断生成元矩阵。\n\n该过程始于构建单个观测轨迹的似然函数。一条轨迹由时间 $t=0$ 时的初始状态 $x(0)$ 和在 $0  t_1  t_2  \\dots  t_N \\le T$ 时间点发生的 $N$ 个反应事件序列定义，其中 $T$ 是总观测时间。设在时间 $t_n$ 发生的反应为 $j_n$。系统状态 $x(t)$ 是一个分段常数函数。我们将第 $n$ 个事件发生前的状态表示为 $x_{n-1} = x(t_n^-)$，并约定 $t_0=0$ 和 $x_0 = x(0)$。\n\n观测到特定轨迹的似然是从马尔可夫跳跃过程的基本性质推导出来的。在状态 $x$ 中等待时间 $\\tau$ แล้ว反应 $j$ 发生的概率密度为 $a_j(x) e^{-a_0(x)\\tau}$，其中 $a_j(x)$ 是反应 $j$ 的倾向，$a_0(x) = \\sum_{k=1}^{R} a_k(x)$ 是总倾向。\n\n整个观测路径的似然是每个事件间间隔的概率与从最后一次事件时间 $t_N$ 到 $T$ 的存活概率的乘积。\n似然函数 $L(\\theta)$ 由下式给出：\n$$ L(\\theta) = \\left( \\prod_{n=1}^{N} a_{j_n}(x_{n-1}) e^{-a_0(x_{n-1})(t_n - t_{n-1})} \\right) \\cdot e^{-a_0(x_N)(T-t_N)} $$\n其中 $x_N$ 是第 $N$ 个事件后的状态。这可以更紧凑地重写为：\n$$ L(\\theta) = \\left( \\prod_{n=1}^{N} a_{j_n}(x(t_n^-)) \\right) \\exp\\left( - \\int_0^T a_0(x(t)) dt \\right) $$\n\n为了最大化，使用对数似然 $\\mathcal{L}(\\theta) = \\ln L(\\theta)$ 更为方便：\n$$ \\mathcal{L}(\\theta) = \\sum_{n=1}^{N} \\ln a_{j_n}(x(t_n^-)) - \\int_0^T a_0(x(t)) dt $$\n\n问题指定了倾向形式 $a_j(x) = \\theta_j h_j(x)$，其中 $\\theta_j$ 是未知的非负参数，$h_j(x)$ 是已知的非负函数。总倾向为 $a_0(x) = \\sum_{k=1}^{R} \\theta_k h_k(x)$。将其代入对数似然方程，得到：\n$$ \\mathcal{L}(\\theta) = \\sum_{n=1}^{N} \\ln(\\theta_{j_n} h_{j_n}(x(t_n^-))) - \\int_0^T \\sum_{k=1}^{R} \\theta_k h_k(x(t)) dt $$\n让我们按反应索引 $j$ 对各项进行分组。设 $N_j$ 是反应 $j$ 在轨迹中发生的总次数，即 $N_j = \\sum_{n=1}^N \\mathbb{I}(j_n = j)$，其中 $\\mathbb{I}$ 是指示函数。设 $E_j$ 是反应 $j$ 的总积分“暴露度”，定义为 $E_j = \\int_0^T h_j(x(t)) dt$。那么对数似然可以表示为：\n$$ \\mathcal{L}(\\theta) = \\sum_{j=1}^{R} \\left( N_j \\ln \\theta_j - \\theta_j E_j \\right) + \\sum_{n=1}^{N} \\ln h_{j_n}(x(t_n^-)) $$\n对数似然是各项之和，每一项仅依赖于一个 $\\theta_j$。我们可以通过对 $\\theta_j$ 求偏导数并将其设为零来找到每个 $\\theta_j$ 的 MLE：\n$$ \\frac{\\partial \\mathcal{L}}{\\partial \\theta_j} = \\frac{N_j}{\\theta_j} - E_j = 0 $$\n解出 $\\theta_j$ 得到最大似然估计值 $\\hat{\\theta}_j$：\n$$ \\hat{\\theta}_j = \\frac{N_j}{E_j} $$\n这个结果很直观：估计的速率常数是观测到的事件数除以观测期内的总暴露度。如果 $E_j = 0$ 且 $N_j = 0$，问题指定使用约定 $\\hat{\\theta}_j=0$。这与似然函数在这种情况下与 $\\theta_j$ 无关是一致的。如果 $E_j=0$ 但 $N_j0$，则似然是无界的，表明数据不一致，假设这种情况不会发生。\n\n为了计算 MLE 处的对数似然 $\\mathcal{L}(\\hat{\\theta})$，我们将 $\\hat{\\theta}_j$ 代回对数似然公式。一个方便计算的形式是：\n$$ \\mathcal{L}(\\hat{\\theta}) = \\sum_{n=1}^{N} \\ln(\\hat{a}_{j_n}(x(t_n^-))) - \\int_0^T \\hat{a}_0(x(t)) dt $$\n其中 $\\hat{a}_j(x) = \\hat{\\theta}_j h_j(x)$。积分项可以简化：\n$$ \\int_0^T \\hat{a}_0(x(t)) dt = \\int_0^T \\sum_{j=1}^{R} \\hat{\\theta}_j h_j(x(t)) dt = \\sum_{j=1}^{R} \\hat{\\theta}_j \\int_0^T h_j(x(t)) dt = \\sum_{j=1}^{R} \\hat{\\theta}_j E_j = \\sum_{j=1}^{R} \\frac{N_j}{E_j} E_j = \\sum_{j=1}^{R} N_j $$\n总事件数是 $N = \\sum_{j=1}^{R} N_j$。所以积分项等于 $N$。MLE 处对数似然的最终表达式是：\n$$ \\mathcal{L}(\\hat{\\theta}) = \\left( \\sum_{n=1}^{N} \\ln(\\hat{\\theta}_{j_n} h_{j_n}(x(t_n^-))) \\right) - N $$\n\n问题的第二部分是构建在给定有限状态集 $\\mathcal{X}$ 上 CME 的截断生成元矩阵 $Q$。生成元矩阵描述了状态之间的转移速率。非对角元素 $Q_{x,y}$ 给出了从状态 $x$ 转移到状态 $y \\ne x$ 的速率。如果存在反应 $j$ 使得 $y = x + \\nu_j$，其中 $\\nu_j$ 是化学计量向量，则会发生从 $x$ 到 $y$ 的转移。此转移的速率是倾向 $a_j(x)$。使用我们的估计参数，这是 $\\hat{a}_j(x) = \\hat{\\theta}_j h_j(x)$。\n因此，对于 $x, y \\in \\mathcal{X}$ 和 $y \\ne x$：\n$$ Q_{x,y} = \\sum_{j: x+\\nu_j = y} \\hat{a}_j(x) $$\n对角元素 $Q_{x,x}$ 的定义使得矩阵的每一行和为零。这反映了对角项表示离开状态 $x$ 的总速率的负值：\n$$ Q_{x,x} = - \\sum_{y \\in \\mathcal{X}, y \\ne x} Q_{x,y} $$\n\n实现将对每个测试用例按以下步骤进行：\n1. 解析给定的反应网络结构、初始状态 $x(0)$、事件序列和观测时间 $T$。\n2. 重构 $t \\in [0, T]$ 上的分段常数状态轨迹 $x(t)$。\n3. 从事件序列中，计算每个反应 $j$ 的发生次数 $N_j$。\n4. 通过对状态轨迹 $x(t)$ 积分，计算暴露度积分 $E_j = \\int_0^T h_j(x(t)) dt$。\n5. 计算每个参数的 MLE $\\hat{\\theta}_j = N_j / E_j$，应用指定的关于零计数和零暴露度的约定。\n6. 使用推导出的公式计算对数似然 $\\mathcal{L}(\\hat{\\theta})$。\n7. 在截断状态空间 $\\mathcal{X}$ 上构建生成元矩阵 $Q$。遍历每个状态 $x \\in \\mathcal{X}$ 以填充 $Q$ 的相应行。对于每个反应 $j$，计算目标状态 $y=x+\\nu_j$。如果 $y \\in \\mathcal{X}$，则将速率 $\\hat{a}_j(x) = \\hat{\\theta}_j h_j(x)$ 加到非对角项 $Q_{x,y}$ 上。\n8. 计算对角元素 $Q_{x,x}$ 以确保行和为零。\n9. 验证构建的矩阵 $Q$ 的所有行和在数值上都接近于零。\n10. 将估计的参数 $\\hat{\\theta}_j$、行和验证结果以及对数似然值整理成所需的输出格式。",
            "answer": "[[0.229008,0.152672,True,-8.904323],[0.312500,0.517241,True,-5.244304],[0.000000,1.250000,True,-3.000000]]"
        }
    ]
}