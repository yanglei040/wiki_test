{
    "hands_on_practices": [
        {
            "introduction": "The first step in analyzing any numerical scheme is to assess its consistency, which quantifies how well the discrete equations represent the continuous partial differential equation as the grid spacing shrinks. The primary tool for this analysis is the Taylor series expansion, which allows us to express the local truncation error—the residual left when the exact solution is plugged into the discrete scheme—in terms of grid spacing and higher-order derivatives. This fundamental exercise provides first-principles practice in deriving the truncation error, revealing how the choice of a finite-difference stencil directly determines a scheme's order of accuracy. ",
            "id": "3373307",
            "problem": "Consider a sufficiently smooth function $u(x,t)$ with $u(\\cdot,t) \\in C^{6}(\\mathbb{R})$ for each fixed time $t$. Let $\\{x_i\\}_{i \\in \\mathbb{Z}}$ be a uniform spatial grid with step size $\\Delta x > 0$, and consider a $q$-point centered finite-difference stencil, with $q = 2m + 1$ and $m \\in \\mathbb{N}$, that approximates the second spatial derivative $u_{xx}(x_i,t)$ by\n$$\nD_{xx}^{(q)} u(x_i,t) \\equiv \\frac{1}{\\Delta x^{2}} \\sum_{j=-m}^{m} a_j\\, u(x_i + j \\Delta x, t),\n$$\nwhere the coefficients are symmetric $a_{-j} = a_j$ for all $j$, and are chosen to reproduce constants and quadratics exactly, namely\n$$\n\\sum_{j=-m}^{m} a_j = 0, \\quad \\sum_{j=-m}^{m} a_j\\, j = 0, \\quad \\sum_{j=-m}^{m} a_j\\, j^{2} = 2.\n$$\nUsing Taylor expansions in $x$ about $x_i$ at fixed time $t$, derive from first principles the local truncation error of $D_{xx}^{(q)}$ for approximating $u_{xx}(x_i,t)$ on the uniform grid, and prove that, under the above moment conditions and without imposing any additional higher-degree exactness conditions, the truncation error is $O(\\Delta x^{2})$ as $\\Delta x \\to 0$. Identify the leading error term coefficient multiplying $u_{xxxx}(x_i,t)\\, \\Delta x^{2}$ in closed form as a function of $\\{a_j\\}_{j=-m}^{m}$ and $m$. Express your final answer as a single analytic expression.",
            "solution": "The task is to derive the local truncation error for a given finite-difference stencil, prove its order of accuracy, and identify the coefficient of the leading error term. The derivation will proceed from first principles using Taylor series expansions. For notational clarity, the explicit dependence on time $t$ will be suppressed, as all spatial derivatives are evaluated at a fixed time $t$. We denote $u(x,t)$ by $u(x)$ and let $u^{(k)}(x_i)$ represent $\\frac{\\partial^k u}{\\partial x^k}(x_i, t)$.\n\nThe local truncation error, $\\tau_i$, at the grid point $x_i$ is defined as the result of applying the finite-difference operator to the exact solution minus the exact derivative it approximates:\n$$\n\\tau_i \\equiv D_{xx}^{(q)} u(x_i) - u_{xx}(x_i) = \\frac{1}{\\Delta x^{2}} \\sum_{j=-m}^{m} a_j\\, u(x_i + j \\Delta x) - u^{(2)}(x_i)\n$$\nThe function $u$ is given to be sufficiently smooth, specifically $u(\\cdot, t) \\in C^{6}(\\mathbb{R})$. This allows us to use a Taylor series expansion for each term $u(x_i + j \\Delta x)$ around the point $x_i$:\n$$\nu(x_i + j \\Delta x) = \\sum_{k=0}^{\\infty} \\frac{(j \\Delta x)^k}{k!} u^{(k)}(x_i)\n$$\nSince $u \\in C^{6}$, we can write this expansion with an explicit remainder term. For our purpose, expanding up to the sixth derivative is sufficient:\n$$\nu(x_i + j \\Delta x) = u(x_i) + j \\Delta x u^{(1)}(x_i) + \\frac{(j \\Delta x)^2}{2!} u^{(2)}(x_i) + \\frac{(j \\Delta x)^3}{3!} u^{(3)}(x_i) + \\frac{(j \\Delta x)^4}{4!} u^{(4)}(x_i) + \\frac{(j \\Delta x)^5}{5!} u^{(5)}(x_i) + \\frac{(j \\Delta x)^6}{6!} u^{(6)}(x_i) + O(\\Delta x^7)\n$$\nSubstituting this expansion into the formula for $D_{xx}^{(q)} u(x_i)$:\n$$\nD_{xx}^{(q)} u(x_i) = \\frac{1}{\\Delta x^{2}} \\sum_{j=-m}^{m} a_j \\left( \\sum_{k=0}^{6} \\frac{(j \\Delta x)^k}{k!} u^{(k)}(x_i) + O(\\Delta x^7) \\right)\n$$\nWe can interchange the order of summation and regroup the terms by the order of the derivative of $u$:\n$$\nD_{xx}^{(q)} u(x_i) = \\sum_{k=0}^{6} \\frac{\\Delta x^{k-2}}{k!} u^{(k)}(x_i) \\left( \\sum_{j=-m}^{m} a_j j^k \\right) + O(\\Delta x^5)\n$$\nLet's examine the first few terms of this sum:\n\\begin{itemize}\n    \\item For $k=0$: $\\frac{1}{\\Delta x^{2}} u(x_i) \\left(\\sum_{j=-m}^{m} a_j\\right)$\n    \\item For $k=1$: $\\frac{1}{\\Delta x} u^{(1)}(x_i) \\left(\\sum_{j=-m}^{m} a_j j\\right)$\n    \\item For $k=2$: $\\frac{1}{2} u^{(2)}(x_i) \\left(\\sum_{j=-m}^{m} a_j j^2\\right)$\n    \\item For $k=3$: $\\frac{\\Delta x}{6} u^{(3)}(x_i) \\left(\\sum_{j=-m}^{m} a_j j^3\\right)$\n    \\item For $k=4$: $\\frac{\\Delta x^2}{24} u^{(4)}(x_i) \\left(\\sum_{j=-m}^{m} a_j j^4\\right)$\n\\end{itemize}\nThe problem provides three moment conditions on the coefficients $\\{a_j\\}$, which ensure the stencil exactly reproduces polynomials of degree up to $2$:\n\\begin{enumerate}\n    \\item $\\sum_{j=-m}^{m} a_j = 0$\n    \\item $\\sum_{j=-m}^{m} a_j j = 0$\n    \\item $\\sum_{j=-m}^{m} a_j j^{2} = 2$\n\\end{enumerate}\nApplying these conditions, the first three terms of the expansion become:\n\\begin{itemize}\n    \\item The $k=0$ term is $\\frac{1}{\\Delta x^{2}} u(x_i) \\cdot 0 = 0$.\n    \\item The $k=1$ term is $\\frac{1}{\\Delta x} u^{(1)}(x_i) \\cdot 0 = 0$.\n    \\item The $k=2$ term is $\\frac{1}{2} u^{(2)}(x_i) \\cdot 2 = u^{(2)}(x_i)$.\n\\end{itemize}\nSubstituting these back into the expression for the operator, we get:\n$$\nD_{xx}^{(q)} u(x_i) = u^{(2)}(x_i) + \\frac{\\Delta x}{6} u^{(3)}(x_i) \\left(\\sum_{j=-m}^{m} a_j j^3\\right) + \\frac{\\Delta x^2}{24} u^{(4)}(x_i) \\left(\\sum_{j=-m}^{m} a_j j^4\\right) + \\frac{\\Delta x^3}{120} u^{(5)}(x_i) \\left(\\sum_{j=-m}^{m} a_j j^5\\right) + O(\\Delta x^4)\n$$\nNow, we consider the symmetry of the coefficients, $a_{-j} = a_j$. This property simplifies sums involving odd powers of $j$. For any odd integer $p \\ge 1$:\n$$\n\\sum_{j=-m}^{m} a_j j^p = a_0 \\cdot 0^p + \\sum_{j=1}^{m} (a_j j^p + a_{-j} (-j)^p) = \\sum_{j=1}^{m} (a_j j^p - a_{-j} j^p)\n$$\nUsing $a_{-j} = a_j$, the term in the parenthesis becomes $a_j j^p - a_j j^p = 0$. Therefore, for any odd $p$:\n$$\n\\sum_{j=-m}^{m} a_j j^p = 0\n$$\nThis applies to the terms for $k=3$ and $k=5$ in our expansion. The coefficient of $u^{(3)}(x_i)$ is zero, and the coefficient of $u^{(5)}(x_i)$ is zero. The expansion for the operator simplifies to:\n$$\nD_{xx}^{(q)} u(x_i) = u^{(2)}(x_i) + \\frac{\\Delta x^2}{24} u^{(4)}(x_i) \\left(\\sum_{j=-m}^{m} a_j j^4\\right) + \\frac{\\Delta x^4}{720} u^{(6)}(x_i) \\left(\\sum_{j=-m}^{m} a_j j^6\\right) + O(\\Delta x^6)\n$$\nThe local truncation error $\\tau_i$ is then:\n$$\n\\tau_i = D_{xx}^{(q)} u(x_i) - u^{(2)}(x_i) = \\frac{\\Delta x^2}{24} u^{(4)}(x_i) \\left(\\sum_{j=-m}^{m} a_j j^4\\right) + O(\\Delta x^4)\n$$\nThe problem states that no additional higher-degree exactness conditions are imposed. This means we do not assume $\\sum a_j j^4 = 0$. In general, this sum is non-zero for a second-order accurate stencil.\nThis result proves that the truncation error is $O(\\Delta x^2)$, as the leading term is proportional to $\\Delta x^2$. The coefficient of the error term $u_{xxxx}(x_i,t)\\,\\Delta x^2$ (which is notation for $u^{(4)}(x_i)\\,\\Delta x^2$) is the factor multiplying it in the leading term of the truncation error.\nFrom the expression for $\\tau_i$, the leading error term is $\\left(\\frac{1}{24} \\sum_{j=-m}^{m} a_j j^4 \\right) u^{(4)}(x_i) \\Delta x^2$.\nThus, the requested coefficient is:\n$$\n\\frac{1}{24} \\sum_{j=-m}^{m} a_j j^4\n$$\nThis expression is in closed form as a function of the set of coefficients $\\{a_j\\}_{j=-m}^{m}$, as required.",
            "answer": "$$\\boxed{\\frac{1}{24} \\sum_{j=-m}^{m} a_j j^{4}}$$"
        },
        {
            "introduction": "While consistency ensures local accuracy, the ultimate goal of a numerical simulation is convergence, meaning the global error should vanish upon grid refinement. The celebrated Lax-Richtmyer equivalence theorem provides the crucial link, stating that for a well-posed linear problem, a scheme converges if and only if it is both consistent and stable. This practice guides you through the construction of a scheme that is perfectly stable but fails the consistency test, providing a powerful and concrete demonstration of why consistency is an indispensable requirement for convergence. ",
            "id": "3394996",
            "problem": "Consider the periodic linear advection initial value problem $u_{t} + a\\,u_{x} = 0$ for $x \\in [0,2\\pi]$ and $t \\ge 0$, with periodic boundary conditions and zero initial data $u(x,0) = 0$. This problem is well-posed in the sense that for any admissible initial data in a suitable normed space, there exists a unique solution that depends continuously on the initial data. In the context of spectral methods and Discontinuous Galerkin (DG) methods, a linear scheme is called stable if its homogeneous part generates a bounded evolution in the chosen norm and is called consistent if the discrete operator applied to sufficiently smooth exact solutions yields a residual that tends to zero under refinement.\n\nConstruct the following Fourier spectral semi-discrete scheme with $N$ modes (labeled by integers $k$ with $|k| \\le K$ where $N = 2K+1$): expand $u_{N}(x,t) = \\sum_{|k| \\le K} \\hat{u}_{k}(t)\\,\\exp(i k x)$ and evolve the modal coefficients according to\n$$\n\\frac{d}{dt}\\,\\hat{u}_{k}(t) \\;=\\; -\\,i\\,a\\,k\\,\\hat{u}_{k}(t) \\;+\\; \\gamma\\,\\delta_{k,0},\n$$\nwith parameter $a = 1$, forcing amplitude $\\gamma = 1$, and Kronecker delta $\\delta_{k,0}$. Assume exact time integration of this semi-discrete system. This scheme is linear and its homogeneous part corresponds to the standard Fourier spectral discretization of the skew-adjoint advection operator, which is norm-preserving in the $L^{2}$ norm. However, the added zero-mode forcing makes the scheme inconsistent with the original homogeneous problem.\n\nUsing first-principles reasoning starting from the definitions above and the exact evolution of the semi-discrete system, show that the scheme is stable (in the sense that the homogeneous evolution preserves the $L^{2}$ norm) yet inconsistent, and explain why it does not converge to the exact solution $u \\equiv 0$. Then, compute the limit of the $L^{2}$ error at time $t = 1$ as the number of modes $N \\to \\infty$:\n$$\n\\lim_{N \\to \\infty} \\,\\left\\| u_{N}(\\cdot,1) - 0 \\right\\|_{L^{2}(0,2\\pi)}.\n$$\nProvide your final answer as a single closed-form analytic expression. No rounding is required. Angles, if any, must be expressed in radians.",
            "solution": "The problem is first validated to ensure it is scientifically grounded, well-posed, and objective.\n\nThe givens are:\n1.  The partial differential equation (PDE) is the linear advection equation: $u_{t} + a\\,u_{x} = 0$.\n2.  The spatial domain is $x \\in [0,2\\pi]$ with periodic boundary conditions.\n3.  The temporal domain is $t \\ge 0$.\n4.  The initial condition is $u(x,0) = 0$.\n5.  A Fourier spectral semi-discrete scheme is proposed for a numerical solution $u_{N}(x,t) = \\sum_{|k| \\le K} \\hat{u}_{k}(t)\\,\\exp(i k x)$, where $N = 2K+1$.\n6.  The evolution of the modal coefficients $\\hat{u}_{k}(t)$ is given by the ordinary differential equation (ODE) system: $\\frac{d}{dt}\\,\\hat{u}_{k}(t) \\;=\\; -\\,i\\,a\\,k\\,\\hat{u}_{k}(t) \\;+\\; \\gamma\\,\\delta_{k,0}$.\n7.  The initial conditions for the scheme are consistent with $u(x,0)=0$, which implies $\\hat{u}_{k}(0)=0$ for all $k$.\n8.  The parameters are specified as $a = 1$ and $\\gamma = 1$.\n9.  The exact solution to the initial value problem is $u(x,t) = 0$ for all $x$ and $t$.\n10. The task is to show the scheme is stable but inconsistent, explain the resulting non-convergence, and compute the limit of the $L^{2}$ error at $t=1$ as $N \\to \\infty$.\n\nThe problem is mathematically well-defined, internally consistent, and directly pertains to the analysis of numerical methods for PDEs, specifically the interplay of stability, consistency, and convergence as described by the Lax equivalence theorem. The constructed scheme is a textbook example used to illustrate the importance of consistency. The problem is therefore valid.\n\nWe proceed with the solution, which consists of three parts: analysis of stability and consistency, explanation of non-convergence, and computation of the error.\n\nFirst, we analyze the stability of the scheme. According to the problem statement, stability is determined by the behavior of the homogeneous part of the scheme. The given semi-discrete scheme is:\n$$\n\\frac{d}{dt}\\,\\hat{u}_{k}(t) \\;=\\; -\\,i\\,a\\,k\\,\\hat{u}_{k}(t) \\;+\\; \\gamma\\,\\delta_{k,0}\n$$\nThe homogeneous part is obtained by removing the forcing term $\\gamma\\,\\delta_{k,0}$:\n$$\n\\frac{d}{dt}\\,\\hat{u}_{k}^{h}(t) \\;=\\; -\\,i\\,a\\,k\\,\\hat{u}_{k}^{h}(t)\n$$\nwhere $\\hat{u}_{k}^{h}(t)$ denotes the coefficients of the homogeneous evolution. The solution to this linear ODE is $\\hat{u}_{k}^{h}(t) = \\hat{u}_{k}^{h}(0) \\exp(-iakt)$. The $L^{2}$ norm of the numerical solution $u_{N}(x,t)$ is related to its Fourier coefficients by Parseval's theorem:\n$$\n\\left\\| u_{N}(\\cdot, t) \\right\\|_{L^{2}(0,2\\pi)}^{2} = \\int_{0}^{2\\pi} |u_{N}(x,t)|^{2} dx = 2\\pi \\sum_{|k| \\le K} |\\hat{u}_{k}(t)|^{2}\n$$\nFor the homogeneous evolution, we examine the squared magnitude of the coefficients:\n$$\n|\\hat{u}_{k}^{h}(t)|^{2} = \\left| \\hat{u}_{k}^{h}(0) \\exp(-iakt) \\right|^{2} = |\\hat{u}_{k}^{h}(0)|^{2} |\\exp(-iakt)|^{2} = |\\hat{u}_{k}^{h}(0)|^{2}\n$$\nsince $|\\exp(i\\theta)|=1$ for any real $\\theta$. Summing over all modes, we find:\n$$\n\\sum_{|k| \\le K} |\\hat{u}_{k}^{h}(t)|^{2} = \\sum_{|k| \\le K} |\\hat{u}_{k}^{h}(0)|^{2}\n$$\nThis implies that $\\left\\| u_{N}^{h}(\\cdot, t) \\right\\|_{L^{2}}^{2} = \\left\\| u_{N}^{h}(\\cdot, 0) \\right\\|_{L^{2}}^{2}$. The $L^{2}$ norm of the solution to the homogeneous scheme is conserved for all time. An evolution that preserves the norm is bounded (with an operator norm of $1$). Therefore, by the definition provided, the scheme is stable.\n\nSecond, we analyze the consistency. A scheme is consistent with a PDE if the truncation error—the residual obtained by substituting the exact solution of the PDE into the numerical scheme—tends to zero as the discretization is refined ($N \\to \\infty$). The exact solution to $u_{t} + a u_{x} = 0$ with $u(x,0)=0$ is $u(x,t) = 0$ for all $t \\ge 0$. The Fourier coefficients of the exact solution are $\\hat{u}_{k,exact}(t) = 0$ for all $k$ and $t$.\nWe substitute these exact solution coefficients into the full numerical scheme to find the residual for each mode, $\\tau_k(t)$:\n$$\n\\tau_k(t) = \\frac{d}{dt}\\hat{u}_{k,exact}(t) - \\left( -iak\\,\\hat{u}_{k,exact}(t) + \\gamma\\,\\delta_{k,0} \\right)\n$$\nPlugging in $\\hat{u}_{k,exact}(t) = 0$ and its time-derivative $\\frac{d}{dt}(0)=0$:\n$$\n\\tau_k(t) = 0 - \\left( -iak \\cdot 0 + \\gamma\\,\\delta_{k,0} \\right) = -\\gamma\\,\\delta_{k,0}\n$$\nWith $\\gamma=1$, the residual is $\\tau_k(t) = -\\delta_{k,0}$. For the mode $k=0$, the residual is $\\tau_0 = -1$, while for all other modes $k \\neq 0$, the residual is $\\tau_k = 0$. The residual for the zeroth mode is a constant nonzero value. It does not depend on the number of modes $N$ and thus does not tend to zero as $N \\to \\infty$. Therefore, the scheme is inconsistent with the homogeneous PDE $u_t + a u_x = 0$.\n\nThe failure to converge is a direct consequence of this inconsistency, as explained by the Lax-Richtmyer equivalence theorem. The theorem states that for a well-posed linear initial value problem, a consistent linear finite-difference scheme is convergent if and only if it is stable. Here, the scheme is stable but not consistent. The conditions of the theorem for convergence are not met. The scheme is actually a consistent discretization of a different PDE: $u_t + a u_x = F(x)$, where $F(x)$ is a function whose Fourier coefficients are $\\gamma\\,\\delta_{k,0}$. This corresponds to a spatially constant forcing term $F(x) = \\gamma=1$. The numerical scheme is solving the wrong problem, so its solution does not converge to the solution of the intended problem. The source term $\\gamma\\,\\delta_{k,0}$ continuously injects a non-physical signal into the zeroth mode, causing the numerical solution to diverge from the true solution $u=0$.\n\nFinally, we compute the limit of the $L^{2}$ error at $t=1$. We must find the exact solution to the semi-discrete system with the specified parameters $a=1$, $\\gamma=1$ and initial conditions $\\hat{u}_k(0)=0$. The system of ODEs is:\n$$\n\\frac{d}{dt}\\hat{u}_{k}(t) = -ik\\hat{u}_{k}(t) + \\delta_{k,0}\n$$\nWe solve this for two cases.\nCase 1: $k \\neq 0$. The equation is $\\frac{d}{dt}\\hat{u}_{k}(t) = -ik\\hat{u}_{k}(t)$. With the initial condition $\\hat{u}_k(0)=0$, the unique solution is $\\hat{u}_{k}(t)=0$ for all $t$.\nCase 2: $k=0$. The equation is $\\frac{d}{dt}\\hat{u}_{0}(t) = -i(0)\\hat{u}_{0}(t) + 1$, which simplifies to $\\frac{d}{dt}\\hat{u}_{0}(t) = 1$. Integrating from $0$ to $t$ gives $\\hat{u}_{0}(t) - \\hat{u}_{0}(0) = \\int_0^t 1 ds = t$. Since $\\hat{u}_{0}(0)=0$, we have $\\hat{u}_{0}(t)=t$.\n\nThe coefficients of the numerical solution are thus $\\hat{u}_{k}(t) = t\\,\\delta_{k,0}$. The numerical solution in physical space is:\n$$\nu_{N}(x,t) = \\sum_{|k| \\le K} \\hat{u}_{k}(t)\\,\\exp(ikx) = \\hat{u}_{0}(t)\\exp(i \\cdot 0 \\cdot x) = t\n$$\nThe solution $u_{N}(x,t)=t$ is a spatially constant function that grows linearly in time. This solution is valid for any $N \\ge 1$ (i.e., $K \\ge 0$).\n\nThe error is $e_{N}(x,t) = u_{N}(x,t) - u(x,t) = t - 0 = t$.\nWe are asked to compute the $L^{2}$ norm of the error at time $t=1$. The error at this time is $e_N(x,1) = 1$.\nThe squared $L^{2}$ norm of the error is:\n$$\n\\left\\| e_{N}(\\cdot,1) \\right\\|_{L^{2}(0,2\\pi)}^{2} = \\int_{0}^{2\\pi} |e_{N}(x,1)|^{2} dx = \\int_{0}^{2\\pi} |1|^{2} dx = \\int_{0}^{2\\pi} 1 dx = 2\\pi\n$$\nThus, the $L^{2}$ norm of the error at $t=1$ is $\\left\\| e_{N}(\\cdot,1) \\right\\|_{L^{2}(0,2\\pi)} = \\sqrt{2\\pi}$.\n\nThis result is independent of $N$. Therefore, the limit as $N \\to \\infty$ is the same value:\n$$\n\\lim_{N \\to \\infty} \\,\\left\\| u_{N}(\\cdot,1) - 0 \\right\\|_{L^{2}(0,2\\pi)} = \\sqrt{2\\pi}\n$$\nThis nonzero limit confirms that the scheme does not converge to the exact solution.",
            "answer": "$$\n\\boxed{\\sqrt{2\\pi}}\n$$"
        },
        {
            "introduction": "In advanced methods for solving PDEs on complex geometries, the concept of consistency evolves beyond simple truncation error to include compatibility with the underlying geometric structure. For physical systems governed by conservation laws, a high-fidelity scheme must be \"mimetic,\" meaning it inherits the fundamental symmetries and conservation properties of the continuous system. This practice explores this idea using the shallow water equations on a sphere, a cornerstone of geophysical fluid dynamics, where consistency is linked to satisfying discrete geometric identities. By comparing a scheme that respects these identities with one that does not, you will see how abstract principles of consistency translate directly into the preservation of critical physical invariants like energy, which is key to long-term simulation stability and accuracy. ",
            "id": "3373426",
            "problem": "Construct a self-contained spectral element discretization on one panel of a cubed-sphere using Gauss–Lobatto–Legendre (GLL) collocation, and use it to test how discrete metric identities control kinetic energy and enstrophy stability in the vorticity–divergence form of the shallow water equations. Work entirely in mathematical terms without physical units. The tasks and formulas below must be implemented exactly and consistently.\n\nDefinitions and foundational base:\n\n- The unit sphere is parameterized on the $+x$ face of the cubed sphere by the gnomonic mapping from local panel coordinates $(a,b)\\in[-1,1]\\times[-1,1]$ to the sphere,\n  $$\n  s(a,b) = \\sqrt{1+a^2+b^2},\\quad\n  \\boldsymbol{r}(a,b) = \\frac{1}{s(a,b)}\\big(1,\\,a,\\,b\\big),\n  $$\n  with covariant basis vectors $\\boldsymbol{r}_a=\\partial_a\\boldsymbol{r}$ and $\\boldsymbol{r}_b=\\partial_b\\boldsymbol{r}$.\n\n- The covariant metric tensor $g_{ij}$ and its contravariant inverse $g^{ij}$ are defined by $g_{ij} = \\boldsymbol{r}_i \\cdot \\boldsymbol{r}_j$ and $g^{ik}g_{kj}=\\delta^i_j$, with indices $i,j\\in\\{a,b\\}$. For the gnomonic panel mapping,\n  $$\n  g_{aa}=\\frac{1+b^2}{s^4},\\quad g_{bb}=\\frac{1+a^2}{s^4},\\quad g_{ab}=g_{ba}=-\\frac{ab}{s^4},\n  $$\n  $$\n  g^{aa}=s^2(1+a^2),\\quad g^{bb}=s^2(1+b^2),\\quad g^{ab}=g^{ba}=s^2 ab.\n  $$\n  The surface Jacobian is $J=\\sqrt{\\det g}=1/s^3$.\n\n- The contravariant basis vectors $\\boldsymbol{e}^i$ are defined by raising indices of the covariant basis, $\\boldsymbol{e}^i = g^{ij}\\boldsymbol{r}_j$, satisfying $\\boldsymbol{e}^i\\cdot \\boldsymbol{r}_j=\\delta^i_j$.\n\n- The Gauss–Lobatto–Legendre (GLL) nodes and weights of order $N$ on $[-1,1]$ are the endpoints $\\pm 1$ together with the $N-2$ roots of the derivative of the Legendre polynomial of degree $N-1$. The associated GLL differentiation matrix $D$ is the unique matrix such that, for any polynomial $p$ of degree at most $N-1$, the vector $Dp$ of nodal values equals the nodal values of $p'$.\n\n- On a tensor-product grid $(a_i,b_j)$ of GLL nodes with weights $w_i$ and $w_j$, define discrete derivatives $\\partial_a$ and $\\partial_b$ by left-multiplication by $D$ along the corresponding axis, and approximate integrals by the GLL quadrature on $[-1,1]^2$ weighted by $J(a,b)$:\n  $$\n  \\int_{-1}^1 \\int_{-1}^1 f(a,b)\\,J(a,b)\\,\\mathrm{d}a\\,\\mathrm{d}b \\approx \\sum_{i=0}^{N-1}\\sum_{j=0}^{N-1} f(a_i,b_j)\\,J(a_i,b_j)\\,w_i w_j.\n  $$\n\n- The linearized, inviscid shallow water system about a rest state with constant reference height $H>0$ and gravity $g>0$, in vorticity–divergence form on a fixed metric, reduces to the coupled equations for the height perturbation $\\eta$ and contravariant velocity $U^i$:\n  $$\n  \\partial_t \\eta = -\\frac{H}{J}\\,\\partial_i\\big(J\\,U^i\\big),\\quad\n  \\partial_t U^i = -g\\,g^{ij}\\,\\partial_j \\eta,\n  $$\n  where repeated indices imply summation and $i\\in\\{a,b\\}$, and $\\partial_i$ is the coordinate derivative.\n\n- The discrete kinetic energy plus potential energy at a fixed time, approximated by GLL quadrature, is\n  $$\n  \\mathcal{E} = \\sum_{i,j} \\Big(\\tfrac{1}{2} H\\, g_{pq}\\,U^p U^q + \\tfrac{1}{2} g\\, \\eta^2\\Big)\\, J\\, w_i w_j,\n  $$\n  and its instantaneous discrete rate of change at $t=0$ is\n  $$\n  \\frac{\\mathrm{d}\\mathcal{E}}{\\mathrm{d}t}\\Big|_{t=0} =\n  \\sum_{i,j} \\Big( H\\, g_{pq}\\,U^p\\,\\partial_t U^q + g\\, \\eta\\,\\partial_t \\eta \\Big)\\, J\\, w_i w_j.\n  $$\n\n- The scalar vorticity $\\omega$ (normal component of curl for tangential flow) can be computed in the 2D coordinate basis using the antisymmetric Levi–Civita tensor on the parameter domain. Using covariant velocity components $u_j=g_{jk}U^k$, the coordinate expression is\n  $$\n  \\omega = \\frac{1}{J}\\big(\\partial_a u_b - \\partial_b u_a\\big),\n  $$\n  and the enstrophy is approximated by\n  $$\n  \\mathcal{Z} = \\sum_{i,j} \\omega^2\\,J\\, w_i w_j.\n  $$\n\nExperiments to implement:\n\n1. Construct the spectral element discretization on a single gnomonic panel using $N$ GLL nodes per direction. Compute $J$, $g_{ij}$, $g^{ij}$, $\\boldsymbol{r}_a$, $\\boldsymbol{r}_b$, and $\\boldsymbol{e}^i$ exactly from the mapping and the formulas above at all nodes.\n\n2. Define initial fields\n   $$\n   \\eta(a,b) = (1-a^2)(1-b^2),\\qquad \\Phi(a,b) = (1-a^2)(1-b^2),\n   $$\n   and initialize velocity from the scalar potential by\n   $$\n   U^i = g^{ij}\\,\\partial_j \\Phi.\n   $$\n\n3. Form two discrete operators:\n   - A consistent operator using the exact $g^{ij}$ above.\n   - An intentionally inconsistent operator using perturbed contravariant metric coefficients $\\tilde{g}^{ij}$ defined by\n     $$\n     \\tilde{g}^{aa} = g^{aa}(1+\\epsilon),\\quad \\tilde{g}^{bb} = g^{bb}(1-0.5\\,\\epsilon),\\quad \\tilde{g}^{ab} = g^{ab}(1+0.3\\,\\epsilon),\n     $$\n     with a given perturbation magnitude $\\epsilon\\ge 0$.\n\n   Use each operator to compute $\\partial_t \\eta$ and $\\partial_t U^i$ from the linear shallow water equations for the same initial fields.\n\n4. Discrete metric identity residuals: For the Cartesian components $m\\in\\{x,y,z\\}$ of the contravariant basis vectors $\\boldsymbol{e}^a$ and $\\boldsymbol{e}^b$, compute\n   $$\n   R_m = \\max_{i,j} \\left| \\partial_a\\!\\big(J e^a_m\\big) + \\partial_b\\!\\big(J e^b_m\\big) \\right|,\n   $$\n   once using the consistent $g^{ij}$ in $\\boldsymbol{e}^i=g^{ij}\\boldsymbol{r}_j$ and once using the perturbed $\\tilde{g}^{ij}$, and report the maximum over $m$.\n\n5. Energy rate at $t=0$: Compute $\\mathrm{d}\\mathcal{E}/\\mathrm{d}t$ for both the consistent and inconsistent operators using the formula above.\n\n6. Enstrophy for irrotational flow consistency: Build the covariant velocity $u_j=g_{jk}\\,U^k$ from the potential-generated $U^i$, compute $\\omega$ and $\\mathcal{Z}$ for both the consistent and inconsistent operators. For consistent metrics, the discrete $\\mathcal{Z}$ should be close to zero because $\\boldsymbol{u}=\\nabla \\Phi$ is irrotational and mixed derivatives commute on a tensor grid; with inconsistent metrics $\\tilde{g}^{ij}$, the discrete duality is broken and $\\mathcal{Z}$ becomes nonzero.\n\nConstants to use:\n\n- $H=1$ and $g=1$.\n\nDiscrete derivative implementation details:\n\n- Use the exact GLL differentiation matrix $D$ in each coordinate. For a 2D field $f(a_i,b_j)$, compute $\\partial_a f$ by left-multiplying with $D$ along the $a$-axis and $\\partial_b f$ by right-multiplying with $D^\\top$ along the $b$-axis.\n\nTest suite:\n\n- Use the following parameter pairs $(N,\\epsilon)$:\n  1. $(6,\\,0.0)$: Baseline consistent case.\n  2. $(6,\\,0.02)$: Moderate perturbation.\n  3. $(4,\\,0.05)$: Coarse grid with stronger perturbation.\n\nFinal output format:\n\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each test case must produce a list of six floats in the order\n  $$\n  \\big[R_{\\text{cons}},\\;R_{\\text{incons}},\\;|\\mathrm{d}\\mathcal{E}/\\mathrm{d}t|_{\\text{cons}},\\;|\\mathrm{d}\\mathcal{E}/\\mathrm{d}t|_{\\text{incons}},\\;\\mathcal{Z}_{\\text{cons}},\\;\\mathcal{Z}_{\\text{incons}}\\big],\n  $$\n  and the final output should be a list of these lists in the same order as the test suite examples; for example\n  $$\n  \\big[ [\\dots], [\\dots], [\\dots] \\big].\n  $$",
            "solution": "The user-provided problem statement has been validated and is found to be scientifically sound, well-posed, and complete. We now proceed with a detailed solution.\n\nThe problem requires the construction of a spectral element discretization for the shallow water equations on a single panel of a cubed-sphere grid. We will use this framework to investigate the effect of discrete metric consistency on the conservation of energy and the generation of spurious vorticity.\n\n### 1. Discretization Framework: Gauss–Lobatto–Legendre Collocation\n\nThe spatial domain is a square panel $(a,b) \\in [-1,1] \\times [-1,1]$. We discretize this panel using a tensor-product grid of Gauss–Lobatto–Legendre (GLL) points. For a polynomial order $N-1$, there are $N$ GLL nodes in each direction.\n\nLet $\\{x_i\\}_{i=0}^{N-1}$ be the $N$ GLL nodes on $[-1,1]$, which are the roots of the polynomial $(1-\\xi^2)P'_{N-1}(\\xi)$, where $P_{N-1}$ is the Legendre polynomial of degree $N-1$. The endpoints are $x_0=-1$ and $x_{N-1}=1$. The interior nodes are the roots of $P'_{N-1}(\\xi)$, which are also the roots of the Jacobi polynomial $P_{N-2}^{(1,1)}(\\xi)$.\n\nAssociated with these nodes are quadrature weights $\\{w_i\\}_{i=0}^{N-1}$ that satisfy\n$$\nw_i = \\frac{2}{(N-1)N [P_{N-1}(x_i)]^2}.\n$$\nThe 2D grid is formed by the tensor product $(a_i, b_j) = (x_i, x_j)$, with quadrature weights $W_{ij} = w_i w_j$.\n\nThe derivative of a function represented by its nodal values on this grid is computed via a differentiation matrix $D$. For a function $f(a,b)$ represented by a matrix of nodal values $F_{ij} = f(a_i, b_j)$, the partial derivatives are computed as:\n$$\n(\\partial_a F)_{ij} \\approx \\sum_{k=0}^{N-1} D_{ik} F_{kj} \\quad (\\text{matrix form: } D F),\n$$\n$$\n(\\partial_b F)_{ij} \\approx \\sum_{k=0}^{N-1} F_{ik} D_{jk} \\quad (\\text{matrix form: } F D^\\top).\n$$\nThe entries of the $N \\times N$ differentiation matrix $D$ are given by\n$$\nD_{ij} = \n\\begin{cases}\n\\frac{L_{N-1}(x_i)}{(x_i-x_j)L_{N-1}(x_j)} & i \\ne j \\\\\n-\\frac{(N-1)N}{4} & i=j=0 \\\\\n\\frac{(N-1)N}{4} & i=j=N-1 \\\\\n0 & \\text{otherwise}\n\\end{cases}\n$$\n\n### 2. Geometric Setup on the Gnomonic Panel\n\nThe mapping from the computational panel $(a,b)$ to the unit sphere in $\\mathbb{R}^3$ is given by\n$$\n\\boldsymbol{r}(a,b) = \\frac{1}{\\sqrt{1+a^2+b^2}}(1, a, b).\n$$\nWe define $s(a,b) = \\sqrt{1+a^2+b^2}$. The covariant basis vectors $\\boldsymbol{r}_a = \\partial_a \\boldsymbol{r}$ and $\\boldsymbol{r}_b = \\partial_b \\boldsymbol{r}$ are computed by direct differentiation:\n$$\n\\boldsymbol{r}_a = s^{-3}(-a, 1+b^2, -ab), \\quad \\boldsymbol{r}_b = s^{-3}(-b, -ab, 1+a^2).\n$$\nThe covariant metric tensor components are $g_{ij} = \\boldsymbol{r}_i \\cdot \\boldsymbol{r}_j$, and the surface Jacobian is $J = \\sqrt{\\det g}$. For this specific mapping, the components are given as:\n$$\ng_{aa}=\\frac{1+b^2}{s^4},\\quad g_{bb}=\\frac{1+a^2}{s^4},\\quad g_{ab}=-\\frac{ab}{s^4}, \\quad J=\\frac{1}{s^3}.\n$$\nThe contravariant metric tensor $g^{ij}$ is the matrix inverse of $g_{ij}$:\n$$\ng^{aa}=s^2(1+a^2),\\quad g^{bb}=s^2(1+b^2),\\quad g^{ab}=s^2 ab.\n$$\nAll these geometric quantities are evaluated at each node $(a_i, b_j)$ of the GLL grid.\n\n### 3. Shallow Water Equations and Initial Conditions\n\nThe linearized shallow water equations in vorticity-divergence form for height perturbation $\\eta$ and contravariant velocity components $U^i$ are:\n$$\n\\partial_t \\eta = -\\frac{H}{J}\\,\\partial_i\\big(J\\,U^i\\big) = -\\frac{H}{J} \\left[ \\partial_a(J U^a) + \\partial_b(J U^b) \\right],\n$$\n$$\n\\partial_t U^i = -g\\,g^{ij}\\,\\partial_j \\eta.\n$$\nWe set the constants $H=1$ and $g=1$. The initial conditions are defined by\n$$\n\\eta(a,b) = (1-a^2)(1-b^2), \\quad \\Phi(a,b) = (1-a^2)(1-b^2).\n$$\nThe initial velocity is irrotational, derived from the potential $\\Phi$:\n$$\nU^i = g^{ij}\\,\\partial_j \\Phi.\n$$\nThis gives\n$$\nU^a = g^{aa} \\partial_a \\Phi + g^{ab} \\partial_b \\Phi, \\quad U^b = g^{ab} \\partial_a \\Phi + g^{bb} \\partial_b \\Phi.\n$$\nAll derivatives are computed using the spectral differentiation matrices.\n\n### 4. Experimental Setup and Diagnostics\n\nWe perform two parallel computations: a **consistent** one using the exact metric $g^{ij}$ as defined above, and an **inconsistent** one where the contravariant metric used for the velocity evolution is perturbed:\n$$\n\\tilde{g}^{aa} = g^{aa}(1+\\epsilon),\\quad \\tilde{g}^{bb} = g^{bb}(1-0.5\\,\\epsilon),\\quad \\tilde{g}^{ab} = g^{ab}(1+0.3\\,\\epsilon).\n$$\nThe velocity initialization and the time evolution step for the inconsistent case use this $\\tilde{g}^{ij}$:\n$$\nU^i_{\\text{incons}} = \\tilde{g}^{ij}\\,\\partial_j \\Phi, \\quad (\\partial_t U^i)_{\\text{incons}} = -g\\,\\tilde{g}^{ij}\\,\\partial_j \\eta.\n$$\n\nWe compute three diagnostic quantities for both cases:\n\n**A. Metric Identity Residual ($R_m$)**: This measures how well the discrete operators preserve the geometric identity $\\nabla \\cdot \\boldsymbol{e}^i = \\partial_i(J \\boldsymbol{e}^i)/J=0$, where $\\boldsymbol{e}^i = g^{ij}\\boldsymbol{r}_j$ are the contravariant basis vectors. The residual is computed for each Cartesian component $m \\in \\{x,y,z\\}$ of $\\boldsymbol{e}^i$:\n$$\nR_m = \\max_{i,j} \\left| \\partial_a\\!\\big(J e^a_m\\big) + \\partial_b\\!\\big(J e^b_m\\big) \\right|.\n$$\nThe reported value is $\\max(R_x, R_y, R_z)$. For the consistent case, $\\boldsymbol{e}^i$ is computed using $g^{ij}$. For the inconsistent case, it is computed using $\\tilde{g}^{ij}$.\n\n**B. Rate of Change of Energy ($d\\mathcal{E}/dt$)**: The total (kinetic + potential) energy is\n$$\n\\mathcal{E} = \\sum_{i,j} \\Big(\\tfrac{1}{2} H\\, g_{pq}\\,U^p U^q + \\tfrac{1}{2} g\\, \\eta^2\\Big)\\, J\\, w_i w_j.\n$$\nIts instantaneous rate of change at $t=0$ is\n$$\n\\frac{\\mathrm{d}\\mathcal{E}}{\\mathrm{d}t}\\Big|_{t=0} = \\sum_{i,j} \\Big( H\\, g_{pq}\\,U^p\\,\\partial_t U^q + g\\, \\eta\\,\\partial_t \\eta \\Big)\\, J\\, w_i w_j.\n$$\nThis is computed for both consistent and inconsistent initial fields and their time derivatives. Note that the energy definition always uses the true covariant metric $g_{pq}$. For a consistent discretization, we expect this rate to be near zero, indicating energy conservation.\n\n**C. Enstrophy ($\\mathcal{Z}$)**: Enstrophy is the integrated squared vorticity. We first compute the covariant velocity components $u_j = g_{jk}U^k$. The vorticity is then\n$$\n\\omega = \\frac{1}{J}\\big(\\partial_a u_b - \\partial_b u_a\\big).\n$$\nThe enstrophy is the discrete integral of $\\omega^2$:\n$$\n\\mathcal{Z} = \\sum_{i,j} \\omega^2\\,J\\, w_i w_j.\n$$\nFor the consistent case, the initial velocity is derived from a potential $\\Phi$, so $u_j = \\partial_j \\Phi$. Because discrete mixed partial derivatives commute on a tensor product grid, $\\partial_a(\\partial_b \\Phi) - \\partial_b(\\partial_a \\Phi) = 0$, so we expect $\\mathcal{Z}_{\\text{cons}} \\approx 0$. In the inconsistent case, $U^i_{\\text{incons}} = \\tilde{g}^{ij} \\partial_j \\Phi$, which means $u_k = g_{ki}\\tilde{g}^{ij}\\partial_j \\Phi \\neq \\partial_k \\Phi$. This artificially generated velocity field is rotational, and we expect $\\mathcal{Z}_{\\text{incons}} > 0$.\n\nBy running these computations for the specified parameters $(N, \\epsilon)$, we can numerically demonstrate how breaking metric consistency (i.e., the discrete duality between covariant and contravariant forms) leads to violations of fundamental conservation properties.",
            "answer": "```python\nimport numpy as np\nfrom scipy.special import roots_jacobi, eval_legendre, legendre\nimport json\n\ndef get_gll_data(N):\n    \"\"\"\n    Computes GLL nodes, weights, and differentiation matrix for a given order N.\n    \"\"\"\n    if N == 1:\n        return np.array([0.0]), np.array([2.0]), np.array([[0.0]])\n    \n    # N points, polynomial degree N-1\n    # Interior nodes are roots of P'_{N-1}, which are roots of Jacobi P_{N-2}^{(1,1)}\n    nodes_interior, _ = roots_jacobi(N - 2, 1, 1)\n    nodes = np.concatenate(([-1.0], np.sort(nodes_interior), [1.0]))\n\n    # Weights\n    P_N_minus_1 = legendre(N - 1)\n    weights = 2 / ((N - 1) * N * P_N_minus_1(nodes)**2)\n\n    # Differentiation matrix\n    L_vals = eval_legendre(N - 1, nodes)\n    D = np.zeros((N, N))\n    for i in range(N):\n        for j in range(N):\n            if i != j:\n                D[i, j] = L_vals[i] / (L_vals[j] * (nodes[i] - nodes[j]))\n    \n    D[0, 0] = - (N - 1) * N / 4.0\n    D[N - 1, N - 1] = (N - 1) * N / 4.0\n    \n    return nodes, weights, D\n\ndef solve():\n    test_cases = [\n        (6, 0.0),\n        (6, 0.02),\n        (4, 0.05),\n    ]\n\n    results = []\n    H_const, g_const = 1.0, 1.0\n\n    for N, epsilon in test_cases:\n        # Step 1: Discretization and Grid\n        x, w, D = get_gll_data(N)\n        a, b = np.meshgrid(x, x, indexing='ij')\n        W = np.outer(w, w)\n\n        # Step 2: Geometric quantities\n        s_sq = 1 + a**2 + b**2\n        s = np.sqrt(s_sq)\n        s_cubed_inv = 1.0 / (s**3)\n        s_fourth_inv = 1.0 / (s**4)\n        \n        J = s_cubed_inv\n\n        # Covariant metric g_ij\n        g_aa = (1 + b**2) * s_fourth_inv\n        g_bb = (1 + a**2) * s_fourth_inv\n        g_ab = -a * b * s_fourth_inv\n\n        # Contravariant metric g^ij\n        g_sup_aa = s_sq * (1 + a**2)\n        g_sup_bb = s_sq * (1 + b**2)\n        g_sup_ab = s_sq * a * b\n\n        # Perturbed contravariant metric\n        g_sup_tilde_aa = g_sup_aa * (1 + epsilon)\n        g_sup_tilde_bb = g_sup_bb * (1 - 0.5 * epsilon)\n        g_sup_tilde_ab = g_sup_ab * (1 + 0.3 * epsilon)\n        \n        # Basis vectors\n        r_a_x = -a * s_cubed_inv\n        r_a_y = (1 + b**2) * s_cubed_inv\n        r_a_z = -a * b * s_cubed_inv\n        \n        r_b_x = -b * s_cubed_inv\n        r_b_y = -a * b * s_cubed_inv\n        r_b_z = (1 + a**2) * s_cubed_inv\n\n        # Step 3: Initial conditions\n        eta = (1 - a**2) * (1 - b**2)\n        Phi = (1 - a**2) * (1 - b**2)\n\n        # Discrete derivatives of Phi\n        dPhi_da = D @ Phi\n        dPhi_db = Phi @ D.T\n\n        # --- Consistent Case ---\n        Ua_cons = g_sup_aa * dPhi_da + g_sup_ab * dPhi_db\n        Ub_cons = g_sup_ab * dPhi_da + g_sup_bb * dPhi_db\n\n        # Time derivatives at t=0\n        div_J_U_cons = D @ (J * Ua_cons) + (J * Ub_cons) @ D.T\n        dt_eta_cons = -H_const / J * div_J_U_cons\n        \n        deta_da = D @ eta\n        deta_db = eta @ D.T\n        dt_Ua_cons = -g_const * (g_sup_aa * deta_da + g_sup_ab * deta_db)\n        dt_Ub_cons = -g_const * (g_sup_ab * deta_da + g_sup_bb * deta_db)\n\n        # --- Inconsistent Case ---\n        Ua_incons = g_sup_tilde_aa * dPhi_da + g_sup_tilde_ab * dPhi_db\n        Ub_incons = g_sup_tilde_ab * dPhi_da + g_sup_tilde_bb * dPhi_db\n\n        # Time derivatives at t=0\n        div_J_U_incons = D @ (J * Ua_incons) + (J * Ub_incons) @ D.T\n        dt_eta_incons = -H_const / J * div_J_U_incons\n                \n        dt_Ua_incons = -g_const * (g_sup_tilde_aa * deta_da + g_sup_tilde_ab * deta_db)\n        dt_Ub_incons = -g_const * (g_sup_tilde_ab * deta_da + g_sup_tilde_bb * deta_db)\n\n\n        # Step 4: Metric Identity Residuals\n        # Consistent\n        e_sup_a_cons_x = g_sup_aa * r_a_x + g_sup_ab * r_b_x\n        e_sup_a_cons_y = g_sup_aa * r_a_y + g_sup_ab * r_b_y\n        e_sup_a_cons_z = g_sup_aa * r_a_z + g_sup_ab * r_b_z\n        e_sup_b_cons_x = g_sup_ab * r_a_x + g_sup_bb * r_b_x\n        e_sup_b_cons_y = g_sup_ab * r_a_y + g_sup_bb * r_b_y\n        e_sup_b_cons_z = g_sup_ab * r_a_z + g_sup_bb * r_b_z\n        \n        div_x_cons = D @ (J * e_sup_a_cons_x) + (J * e_sup_b_cons_x) @ D.T\n        div_y_cons = D @ (J * e_sup_a_cons_y) + (J * e_sup_b_cons_y) @ D.T\n        div_z_cons = D @ (J * e_sup_a_cons_z) + (J * e_sup_b_cons_z) @ D.T\n        R_cons = np.max([np.max(np.abs(div_x_cons)), np.max(np.abs(div_y_cons)), np.max(np.abs(div_z_cons))])\n\n        # Inconsistent\n        e_sup_a_incons_x = g_sup_tilde_aa * r_a_x + g_sup_tilde_ab * r_b_x\n        e_sup_a_incons_y = g_sup_tilde_aa * r_a_y + g_sup_tilde_ab * r_b_y\n        e_sup_a_incons_z = g_sup_tilde_aa * r_a_z + g_sup_tilde_ab * r_b_z\n        e_sup_b_incons_x = g_sup_tilde_ab * r_a_x + g_sup_tilde_bb * r_b_x\n        e_sup_b_incons_y = g_sup_tilde_ab * r_a_y + g_sup_tilde_bb * r_b_y\n        e_sup_b_incons_z = g_sup_tilde_ab * r_a_z + g_sup_tilde_bb * r_b_z\n        \n        div_x_incons = D @ (J * e_sup_a_incons_x) + (J * e_sup_b_incons_x) @ D.T\n        div_y_incons = D @ (J * e_sup_a_incons_y) + (J * e_sup_b_incons_y) @ D.T\n        div_z_incons = D @ (J * e_sup_a_incons_z) + (J * e_sup_b_incons_z) @ D.T\n        R_incons = np.max([np.max(np.abs(div_x_incons)), np.max(np.abs(div_y_incons)), np.max(np.abs(div_z_incons))])\n\n        # Step 5: Energy Rate\n        # Consistent\n        dKE_dt_term = H_const * (g_aa * Ua_cons * dt_Ua_cons + g_bb * Ub_cons * dt_Ub_cons + g_ab * (Ua_cons * dt_Ub_cons + Ub_cons * dt_Ua_cons))\n        dPE_dt_term = g_const * eta * dt_eta_cons\n        integrand_cons = (dKE_dt_term + dPE_dt_term) * J\n        dE_dt_cons = np.sum(integrand_cons * W)\n\n        # Inconsistent\n        dKE_dt_term_incons = H_const * (g_aa * Ua_incons * dt_Ua_incons + g_bb * Ub_incons * dt_Ub_incons + g_ab * (Ua_incons * dt_Ub_incons + Ub_incons * dt_Ua_incons))\n        dPE_dt_term_incons = g_const * eta * dt_eta_incons\n        integrand_incons = (dKE_dt_term_incons + dPE_dt_term_incons) * J\n        dE_dt_incons = np.sum(integrand_incons * W)\n        \n        # Step 6: Enstrophy\n        # Consistent\n        ua_cons = g_aa * Ua_cons + g_ab * Ub_cons\n        ub_cons = g_ab * Ua_cons + g_bb * Ub_cons\n        omega_cons = (1.0 / J) * (D @ ub_cons - (ua_cons @ D.T))\n        Z_cons = np.sum(omega_cons**2 * J * W)\n        \n        # Inconsistent\n        ua_incons = g_aa * Ua_incons + g_ab * Ub_incons\n        ub_incons = g_ab * Ua_incons + g_bb * Ub_incons\n        omega_incons = (1.0 / J) * (D @ ub_incons - (ua_incons @ D.T))\n        Z_incons = np.sum(omega_incons**2 * J * W)\n        \n        case_results = [\n            R_cons, R_incons, \n            np.abs(dE_dt_cons), np.abs(dE_dt_incons),\n            Z_cons, Z_incons\n        ]\n        results.append(case_results)\n    \n    # Format the final output as a single-line JSON string representing a list of lists.\n    print(json.dumps(results))\n\nsolve()\n```"
        }
    ]
}