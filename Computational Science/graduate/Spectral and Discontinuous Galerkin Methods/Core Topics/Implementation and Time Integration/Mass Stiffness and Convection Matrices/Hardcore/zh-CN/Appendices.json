{
    "hands_on_practices": [
        {
            "introduction": "掌握这些概念的第一步是亲手计算一个简单的矩阵。本练习要求计算一个低阶多项式基的局部刚度矩阵$K$。通过将抽象的定义 $K_{ij} = \\int_{-1}^{1} \\frac{d \\phi_{i}}{d x} \\frac{d \\phi_{j}}{d x} \\, dx$ 与弱形式及基函数的导数直接联系起来，这个实践旨在揭示矩阵的内在结构，并为更复杂的分析奠定基础。",
            "id": "3398573",
            "problem": "考虑在参考单元 $[-1,1]$ 上具有单位扩散系数的一维泊松算子。在谱方法/间断 Galerkin 公式中，与多项式基 $\\{\\phi_{i}(x)\\}_{i=0}^{p}$ 相关的局部刚度矩阵 $\\mathbf{K}$ 由弱形式的双线性形式定义为 $K_{ij} = \\int_{-1}^{1} \\frac{d \\phi_{i}}{d x}(x) \\frac{d \\phi_{j}}{d x}(x) \\, dx$。设 $\\{\\phi_{0}, \\phi_{1}, \\phi_{2}\\}$ 为 $[-1,1]$ 上次数为 $p=2$ 的勒让德基，其中 $\\phi_{n}(x) = P_{n}(x)$，$P_{n}(x)$ 表示 $[-1,1]$ 上的 $n$ 次标准勒让德多项式，满足正交关系 $\\int_{-1}^{1} P_{m}(x) P_{n}(x) \\, dx = \\frac{2}{2n+1} \\delta_{mn}$。使用精确求积（即，精确计算定义积分），计算局部刚度矩阵 $\\mathbf{K}$，并按 $\\{P_{0}, P_{1}, P_{2}\\}$ 的顺序列出其元素。你的最终答案必须是完整的 $3 \\times 3$ 矩阵，以单一闭式解析表达式的形式给出。不需要四舍五入。",
            "solution": "该问题是有效的，因为它具有科学依据、提法恰当、客观，并包含唯一解所需的所有必要信息。这是偏微分方程数值方法领域的一个标准问题。我们开始求解。\n\n任务是计算参考单元 $[-1, 1]$ 上一维泊松算子的局部刚度矩阵 $\\mathbf{K}$。刚度矩阵的元素由以下积分定义：\n$$\nK_{ij} = \\int_{-1}^{1} \\frac{d \\phi_{i}}{d x}(x) \\frac{d \\phi_{j}}{d x}(x) \\, dx\n$$\n基函数 $\\{\\phi_{i}\\}_{i=0}^{2}$ 选择为区间 $[-1, 1]$ 上的标准勒让德多项式 $\\{P_{i}\\}_{i=0}^{2}$。我们考虑的是 $p=2$ 的基组，它由 $\\{P_{0}(x), P_{1}(x), P_{2}(x)\\}$ 组成。\n\n首先，我们列出所需的勒让德多项式及其导数。前三个标准勒让德多项式是：\n$$\n\\phi_{0}(x) = P_{0}(x) = 1\n$$\n$$\n\\phi_{1}(x) = P_{1}(x) = x\n$$\n$$\n\\phi_{2}(x) = P_{2}(x) = \\frac{1}{2}(3x^2 - 1)\n$$\n接下来，我们计算这些基函数关于 $x$ 的导数：\n$$\n\\frac{d \\phi_{0}}{d x} = \\frac{d P_{0}}{d x} = 0\n$$\n$$\n\\frac{d \\phi_{1}}{d x} = \\frac{d P_{1}}{d x} = 1\n$$\n$$\n\\frac{d \\phi_{2}}{d x} = \\frac{d P_{2}}{d x} = \\frac{d}{dx} \\left( \\frac{1}{2}(3x^2 - 1) \\right) = \\frac{1}{2}(6x) = 3x\n$$\n\n现在，我们可以使用积分定义来计算刚度矩阵 $\\mathbf{K}$ 的 $3 \\times 3$ 个元素。该矩阵是对称的，即 $K_{ij} = K_{ji}$，所以我们只需要计算上三角部分的元素。\n\n对于 $i=0$：\n由于 $\\frac{d \\phi_{0}}{dx} = 0$，矩阵的第一行和第一列的所有元素都将为零。\n$$\nK_{00} = \\int_{-1}^{1} (0)(0) \\, dx = 0\n$$\n$$\nK_{01} = \\int_{-1}^{1} (0)(1) \\, dx = 0\n$$\n$$\nK_{02} = \\int_{-1}^{1} (0)(3x) \\, dx = 0\n$$\n根据对称性，$K_{10} = K_{01} = 0$ 且 $K_{20} = K_{02} = 0$。\n\n对于 $i=1$：\n$$\nK_{11} = \\int_{-1}^{1} \\left( \\frac{d \\phi_{1}}{d x} \\right)^2 \\, dx = \\int_{-1}^{1} (1)^2 \\, dx = \\int_{-1}^{1} 1 \\, dx = [x]_{-1}^{1} = 1 - (-1) = 2\n$$\n$$\nK_{12} = \\int_{-1}^{1} \\frac{d \\phi_{1}}{d x} \\frac{d \\phi_{2}}{d x} \\, dx = \\int_{-1}^{1} (1)(3x) \\, dx = 3 \\int_{-1}^{1} x \\, dx = 3 \\left[ \\frac{x^2}{2} \\right]_{-1}^{1} = 3 \\left( \\frac{1^2}{2} - \\frac{(-1)^2}{2} \\right) = 0\n$$\n根据对称性，$K_{21} = K_{12} = 0$。\n\n对于 $i=2$：\n$$\nK_{22} = \\int_{-1}^{1} \\left( \\frac{d \\phi_{2}}{d x} \\right)^2 \\, dx = \\int_{-1}^{1} (3x)^2 \\, dx = 9 \\int_{-1}^{1} x^2 \\, dx = 9 \\left[ \\frac{x^3}{3} \\right]_{-1}^{1} = 9 \\left( \\frac{1^3}{3} - \\frac{(-1)^3}{3} \\right) = 9 \\left( \\frac{1}{3} - \\left(-\\frac{1}{3}\\right) \\right) = 9 \\left( \\frac{2}{3} \\right) = 6\n$$\n另外，对于 $K_{22}$，我们可以使用勒让德多项式的正交性。注意 $\\frac{d \\phi_{2}}{dx} = 3x = 3P_{1}(x)$。\n$$\nK_{22} = \\int_{-1}^{1} (3 P_{1}(x))(3 P_{1}(x)) \\, dx = 9 \\int_{-1}^{1} P_{1}(x) P_{1}(x) \\, dx\n$$\n使用给定的正交关系 $\\int_{-1}^{1} P_{m}(x) P_{n}(x) \\, dx = \\frac{2}{2n+1} \\delta_{mn}$，其中 $m=n=1$：\n$$\n\\int_{-1}^{1} P_{1}(x) P_{1}(x) \\, dx = \\frac{2}{2(1)+1} = \\frac{2}{3}\n$$\n因此，$K_{22} = 9 \\times \\frac{2}{3} = 6$，这证实了我们直接积分的结果。\n\n将计算出的元素组装成矩阵 $\\mathbf{K}$：\n$$\n\\mathbf{K} =\n\\begin{pmatrix}\nK_{00} & K_{01} & K_{02} \\\\\nK_{10} & K_{11} & K_{12} \\\\\nK_{20} & K_{21} & K_{22}\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n0 & 0 & 0 \\\\\n0 & 2 & 0 \\\\\n0 & 0 & 6\n\\end{pmatrix}\n$$\n这就是基 $\\{P_0, P_1, P_2\\}$ 的局部刚度矩阵。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n0 & 0 & 0 \\\\\n0 & 2 & 0 \\\\\n0 & 0 & 6\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "从精确计算过渡到数值近似的世界，我们会遇到新的挑战。本练习演示了一种称为“求积混叠”的关键现象，即使用不足的求积点来组装对流矩阵会破坏离散算子应有的 $M$-斜对称性质，进而破坏能量守恒定律。这个实践突出了选择恰当数值参数的重要性，它直接关系到模拟结果的物理一致性和数值稳定性。",
            "id": "3398522",
            "problem": "考虑区间 $[-1,1]$ 上带有周期性边界条件的一维线性平流方程，\n$$\n\\partial_t u(x,t) + \\partial_x u(x,t) = 0,\n$$\n及其在模态 Legendre 基 $\\{\\phi_i(x)\\}_{i=0}^p$ 中的谱 Galerkin 半离散化，其中 $\\phi_i(x)$ 是区间 $[-1,1]$ 上的第 $i$ 个 Legendre 多项式。令 $u_h(x,t) = \\sum_{j=0}^p \\hat{u}_j(t)\\,\\phi_j(x)$ 表示谱近似，其系数为 $\\hat{u}_j(t)$。\n\n通过 Galerkin 弱形式定义质量矩阵 $M \\in \\mathbb{R}^{(p+1)\\times(p+1)}$ 和对流（刚度）矩阵 $K\\in \\mathbb{R}^{(p+1)\\times(p+1)}$\n$$\nM_{ij} = \\int_{-1}^{1} \\phi_i(x)\\,\\phi_j(x)\\,dx,\\qquad\nK_{ij} = \\int_{-1}^{1} \\phi_i(x)\\,\\partial_x \\phi_j(x)\\,dx,\n$$\n并设置半离散算子 $C = M^{-1}K$。该半离散系统为\n$$\n\\frac{d\\hat{\\mathbf{u}}}{dt} + C\\,\\hat{\\mathbf{u}} = 0,\\quad \\hat{\\mathbf{u}}(0) = \\hat{\\mathbf{u}}_0.\n$$\n\n在精确算术和对 $M$ 与 $K$ 进行精确积分的情况下，周期性边界条件意味着 $M$-斜对称性质\n$$\nM C + C^\\top M = \\mathbf{0},\n$$\n因此，离散 $L^2$ 能量 $E(t) = \\tfrac{1}{2}\\,\\hat{\\mathbf{u}}(t)^\\top M\\,\\hat{\\mathbf{u}}(t)$ 是守恒的，即 $\\frac{dE}{dt} = 0$。然而，如果使用非精确求积法则组装 $K$，则 $M$-斜对称性质通常不成立，这可能导致离散能量的虚假增长或衰减。\n\n你的任务是通过以下方式在谱 Galerkin 方法中演示求积混叠：使用阶数为 $Q_M = p+1$ 的精确求积法则（Gauss–Legendre）组装 $M$，并使用阶数为 $Q_K \\in \\mathbb{N}$ 的可能非精确的求积法则组装 $K$。请使用以下步骤：\n\n- 使用阶数为 $Q$ 的 Gauss–Legendre 求积法，通过 $\\sum_{q=1}^{Q} w_q\\,f(x_q)$ 来近似任何积分 $\\int_{-1}^1 f(x)\\,dx$，其中 $\\{x_q,w_q\\}_{q=1}^Q$ 是 Gauss–Legendre 节点和权重。\n- 使用 $Q_M = p+1$ 组装 $M$，以确保多项式质量积分的精确性。\n- 使用可变法则 $Q_K$（其可能小于 $p+1$）组装 $K$，以在对流算子中故意引入非精确性，从而产生混叠。\n- 定义 $C = M^{-1}K$。\n- 选择初始条件 $u(x,0) = \\sin(\\pi x)$，并通过求解 $M\\,\\hat{\\mathbf{u}}_0 = \\mathbf{b}$ 来计算其 $L^2$ 投影系数 $\\hat{\\mathbf{u}}_0$，其中 $b_i = \\int_{-1}^1 \\phi_i(x)\\,u(x,0)\\,dx$。使用足够高的求积阶数 $Q_{\\text{proj}} = 2p+5$ 来近似这些投影积分。\n- 使用显式四阶 Runge–Kutta（4 阶 Runge–Kutta (RK)）方法对常微分方程组进行时间演化，直至最终时间 $T$。根据谱半径 $\\rho(C)$ 选择时间步长 $\\Delta t$，使得 $\\Delta t = \\text{CFL}/\\max(\\rho(C),\\varepsilon)$，其中 $\\text{CFL} = 0.1$ 且 $\\varepsilon = 10^{-14}$；使用固定步数 $N = \\lceil T/\\Delta t \\rceil$ 并调整 $\\Delta t$ 以精确达到 $T$。\n- 使用以 $Q_{\\text{en}}=2p+5$ 组装的高阶能量评估质量矩阵 $M_{\\text{en}}$ 和以下公式，测量在时间 $T$ 的相对能量误差\n$$\n\\mathcal{E}_{\\text{rel}} = \\frac{\\tfrac{1}{2}\\,\\hat{\\mathbf{u}}(T)^\\top M_{\\text{en}}\\,\\hat{\\mathbf{u}}(T) - \\tfrac{1}{2}\\,\\hat{\\mathbf{u}}(0)^\\top M_{\\text{en}}\\,\\hat{\\mathbf{u}}(0)}{\\tfrac{1}{2}\\,\\hat{\\mathbf{u}}(0)^\\top M_{\\text{en}}\\,\\hat{\\mathbf{u}}(0)}.\n$$\n\n实现一个程序，对于下面的每个测试用例 $(p,Q_K,T)$，用 $Q_M=p+1$ 构建 $M$，用指定的 $Q_K$ 构建 $K$，形成 $C=M^{-1}K$，投影初始数据，用四阶 Runge–Kutta 方法将系统推进到时间 $T$，并返回 $\\mathcal{E}_{\\text{rel}}$ 作为浮点数。\n\n使用以下测试套件：\n- 测试 $1$：$(p,Q_K,T) = (0,1,0.1)$。\n- 测试 $2$：$(p,Q_K,T) = (3,2,0.2)$。\n- 测试 $3$：$(p,Q_K,T) = (7,5,0.2)$。\n- 测试 $4$：$(p,Q_K,T) = (7,8,0.2)$。\n- 测试 $5$：$(p,Q_K,T) = (9,6,0.15)$。\n\n你的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果，例如 $[\\text{result}_1,\\text{result}_2,\\dots]$，其中每个条目是按顺序列出的相应测试用例的 $\\mathcal{E}_{\\text{rel}}$ 值。不应打印任何其他文本。",
            "solution": "我们从区间 $[-1,1]$ 上带有周期性边界条件的一维平流方程 $\\partial_t u + \\partial_x u = 0$ 的 Galerkin 弱形式开始。使用模态 Legendre 基 $\\{\\phi_i\\}_{i=0}^p$，半离散近似 $u_h(x,t) = \\sum_{j=0}^p \\hat{u}_j(t)\\,\\phi_j(x)$ 强制要求\n$$\n\\int_{-1}^{1} \\phi_i(x)\\,\\partial_t u_h(x,t)\\,dx + \\int_{-1}^{1} \\phi_i(x)\\,\\partial_x u_h(x,t)\\,dx = 0,\\quad \\forall i\\in\\{0,\\dots,p\\}.\n$$\n利用线性和定义质量矩阵与对流矩阵，\n$$\nM_{ij} = \\int_{-1}^{1} \\phi_i(x)\\,\\phi_j(x)\\,dx,\\qquad\nK_{ij} = \\int_{-1}^{1} \\phi_i(x)\\,\\partial_x \\phi_j(x)\\,dx,\n$$\n我们得到系数向量 $\\hat{\\mathbf{u}}(t)$ 的常微分方程：\n$$\nM\\,\\frac{d\\hat{\\mathbf{u}}}{dt} + K\\,\\hat{\\mathbf{u}} = 0\\quad\\Longleftrightarrow\\quad \\frac{d\\hat{\\mathbf{u}}}{dt} + C\\,\\hat{\\mathbf{u}} = 0,\\quad C = M^{-1}K.\n$$\n当 $M$ 和 $K$ 通过精确积分和周期性边界条件计算时，分部积分得出 $K = -S$，其中 $S_{ij}=\\int_{-1}^1 \\partial_x \\phi_i(x)\\,\\phi_j(x)\\,dx$，因此\n$$\n(M C + C^\\top M) = (K + K^\\top) = \\left(\\int \\phi_i\\,\\partial_x\\phi_j + \\int \\phi_j\\,\\partial_x\\phi_i\\right)_{ij} = \\left(\\int \\partial_x(\\phi_i\\,\\phi_j)\\right)_{ij} = \\mathbf{0},\n$$\n这意味着 $C$ 的 $M$-斜伴随性以及在 $M$-内积下的离散能量守恒。离散能量 $E(t) = \\tfrac{1}{2}\\hat{\\mathbf{u}}^\\top M \\hat{\\mathbf{u}}$ 于是满足\n$$\n\\frac{dE}{dt} = \\hat{\\mathbf{u}}^\\top M \\frac{d\\hat{\\mathbf{u}}}{dt} = -\\hat{\\mathbf{u}}^\\top M C \\hat{\\mathbf{u}} = -\\tfrac{1}{2}\\,\\hat{\\mathbf{u}}^\\top (M C + C^\\top M)\\,\\hat{\\mathbf{u}} = 0.\n$$\n然而，如果 $K$ 是用非精确求积组装的，$K$ 会被扰动为 $\\tilde{K}$，$C$ 会被扰动为 $\\tilde{C} = M^{-1}\\tilde{K}$；精确的 $M$-斜对称性质通常会丢失：\n$$\nM \\tilde{C} + \\tilde{C}^\\top M = \\tilde{K} + \\tilde{K}^\\top \\neq \\mathbf{0},\n$$\n于是\n$$\n\\frac{dE}{dt} = -\\tfrac{1}{2}\\,\\hat{\\mathbf{u}}^\\top \\left(M \\tilde{C} + \\tilde{C}^\\top M\\right)\\,\\hat{\\mathbf{u}} \\neq 0,\n$$\n这导致了能量的虚假增长或衰减。这就是求积混叠的本质：用不充分的求积计算的非线性或混合乘积，会将分量注入到有限维多项式空间之外，这些分量在投影时会错误地重新进入离散空间，从而破坏了与精确伴随性或对称性相关的不变量。\n\n算法构造：\n\n- 基和求积。我们选择 Legendre 基 $\\phi_i = P_i$，其中 $P_i$ 是 $[-1,1]$ 上的第 $i$ 个 Legendre 多项式。对于任意求积阶数 $Q$，Gauss–Legendre 节点和权重 $\\{x_q,w_q\\}_{q=1}^Q$ 能精确积分最高 $2Q-1$ 次的多项式。\n\n- 质量矩阵。为确保质量矩阵可逆且精确，我们用 $Q_M = p+1$ 组装 $M$，这样任何乘积 $\\phi_i\\,\\phi_j$（次数最多为 $2p$）都能被精确积分。数值上，\n$$\nM_{ij} \\approx \\sum_{q=1}^{Q_M} w_q\\,\\phi_i(x_q)\\,\\phi_j(x_q).\n$$\n\n- 对流矩阵。我们通过使用可能较低的求积阶数 $Q_K$ 组装 $K$ 来引入非精确性：\n$$\nK_{ij} \\approx \\sum_{q=1}^{Q_K} w_q\\,\\phi_i(x_q)\\,\\partial_x \\phi_j(x_q).\n$$\n如果 $Q_K  p+1$，那么 $K$ 中次数为 $2p-1$ 的被积函数就不会被精确积分，从而产生混叠误差。\n\n- 半离散算子。我们通过求解 $M C = K$ 来形成 $C = M^{-1}K$。\n\n- 初始条件和投影。我们设置 $u(x,0)=\\sin(\\pi x)$ 并计算其在 $\\{\\phi_i\\}_{i=0}^p$ 生成空间上的 $L^2$ 投影：\n$$\nb_i = \\int_{-1}^1 \\phi_i(x)\\,u(x,0)\\,dx\\approx \\sum_{q=1}^{Q_{\\text{proj}}} w_q\\,\\phi_i(x_q)\\,u(x_q,0),\n$$\n其中 $Q_{\\text{proj}}=2p+5$，然后求解 $M\\,\\hat{\\mathbf{u}}_0 = \\mathbf{b}$。\n\n- 时间步进。我们使用四阶显式 Runge–Kutta 方法求解 $\\frac{d\\hat{\\mathbf{u}}}{dt} = -C\\,\\hat{\\mathbf{u}}$。为减小时间离散误差并避免不稳定性，我们根据谱半径 $\\rho(C)$ 选择步长：\n$$\n\\Delta t = \\frac{\\text{CFL}}{\\max(\\rho(C),\\varepsilon)},\\quad \\text{CFL} = 0.1,\\ \\varepsilon=10^{-14},\n$$\n取 $N=\\lceil T/\\Delta t\\rceil$ 步，并调整 $\\Delta t=T/N$ 以精确达到最终时间。\n\n- 能量测量。为稳健地量化能量漂移，我们使用以 $Q_{\\text{en}}=2p+5$ 组装的高阶质量矩阵 $M_{\\text{en}}$ 来评估能量：\n$$\nE(0) = \\tfrac{1}{2}\\,\\hat{\\mathbf{u}}_0^\\top M_{\\text{en}}\\,\\hat{\\mathbf{u}}_0,\\quad E(T) = \\tfrac{1}{2}\\,\\hat{\\mathbf{u}}(T)^\\top M_{\\text{en}}\\,\\hat{\\mathbf{u}}(T),\n$$\n并报告相对误差 $\\mathcal{E}_{\\text{rel}} = \\frac{E(T)-E(0)}{E(0)}$。\n\n测试设计和覆盖范围：\n\n- 测试 1：$(p,Q_K,T)=(0,1,0.1)$。这里 $\\phi_0$ 是常数，$\\partial_x \\phi_0=0$，因此无论 $Q_K$ 如何，$K=\\mathbf{0}$，$\\mathcal{E}_{\\text{rel}}=0$（在舍入误差范围内），这是一个边界情况。\n\n- 测试 2：$(p,Q_K,T)=(3,2,0.2)$。质量矩阵是精确的，而 $K$ 是欠积分的（$Q_K",
            "answer": "```python\nimport numpy as np\n\ndef gauss_legendre(n):\n    # Gauss-Legendre nodes and weights on [-1,1]\n    x, w = np.polynomial.legendre.leggauss(n)\n    return x, w\n\ndef legendre_and_derivative_values(p, x):\n    # Evaluate Legendre polynomials P_0..P_p and their derivatives at points x\n    # Returns arrays of shape (p+1, len(x))\n    x = np.asarray(x)\n    vals = np.zeros((p + 1, x.size))\n    ders = np.zeros((p + 1, x.size))\n    for i in range(p + 1):\n        P = np.polynomial.legendre.Legendre.basis(i)\n        dP = P.deriv()\n        vals[i, :] = P(x)\n        ders[i, :] = dP(x)\n    return vals, ders\n\ndef assemble_mass(p, Q):\n    # Assemble mass matrix M using Gauss-Legendre quadrature of order Q\n    xq, wq = gauss_legendre(Q)\n    V, _ = legendre_and_derivative_values(p, xq)\n    # M = V W V^T\n    M = V @ (wq[:, None] * V.T)\n    return M\n\ndef assemble_stiffness_K(p, QK):\n    # Assemble convection (stiffness) matrix K_ij = ∫ phi_i * d(phi_j)/dx dx\n    xq, wq = gauss_legendre(QK)\n    V, dV = legendre_and_derivative_values(p, xq)\n    K = V @ (wq[:, None] * dV.T)\n    return K\n\ndef project_initial_condition(p, Qproj, u_func):\n    # Compute L2 projection coefficients of u_func onto span{phi_0..phi_p}\n    xq, wq = gauss_legendre(Qproj)\n    V, _ = legendre_and_derivative_values(p, xq)\n    uvals = u_func(xq)\n    # b_i = ∫ phi_i * u dx ≈ sum wq * phi_i(xq) * u(xq)\n    b = V @ (wq * uvals)\n    # Mass matrix for projection (exact for polynomials if Qproj large)\n    Mproj = V @ (wq[:, None] * V.T)\n    coeffs = np.linalg.solve(Mproj, b)\n    return coeffs\n\ndef rk4_linear(C, u0, dt, nsteps):\n    u = u0.copy()\n    for _ in range(nsteps):\n        k1 = -C @ u\n        k2 = -C @ (u + 0.5 * dt * k1)\n        k3 = -C @ (u + 0.5 * dt * k2)\n        k4 = -C @ (u + dt * k3)\n        u = u + (dt / 6.0) * (k1 + 2*k2 + 2*k3 + k4)\n    return u\n\ndef energy(u, M):\n    return 0.5 * float(u.T @ (M @ u))\n\ndef solve_case(p, QK, T):\n    # Assemble mass with exact quadrature QM = p+1\n    QM = p + 1\n    M = assemble_mass(p, QM)\n    # Assemble stiffness with possibly inexact quadrature QK\n    K = assemble_stiffness_K(p, QK)\n    # Operator C = M^{-1} K\n    C = np.linalg.solve(M, K)\n    # Initial condition u(x,0) = sin(pi x)\n    u_func = lambda x: np.sin(np.pi * x)\n    Qproj = max(2 * p + 5, 10)\n    u0 = project_initial_condition(p, Qproj, u_func)\n    # Energy evaluation mass matrix with high-order quadrature\n    Men = assemble_mass(p, Qproj)\n    E0 = energy(u0, Men)\n    # Time step based on spectral radius\n    if p == 0:\n        rho = 0.0\n    else:\n        eigvals = np.linalg.eigvals(C)\n        rho = float(np.max(np.abs(eigvals))) if eigvals.size  0 else 0.0\n    CFL = 0.1\n    eps = 1e-14\n    dt = CFL / max(rho, eps)\n    nsteps = max(1, int(np.ceil(T / dt)))\n    dt = T / nsteps\n    # Time integration\n    uT = rk4_linear(C, u0, dt, nsteps)\n    ET = energy(uT, Men)\n    rel_err = (ET - E0) / E0 if E0 != 0.0 else 0.0\n    return rel_err\n\ndef solve():\n    # Define the test cases (p, QK, T)\n    test_cases = [\n        (0, 1, 0.1),\n        (3, 2, 0.2),\n        (7, 5, 0.2),\n        (7, 8, 0.2),\n        (9, 6, 0.15),\n    ]\n    results = []\n    for p, QK, T in test_cases:\n        rel_err = solve_case(p, QK, T)\n        results.append(rel_err)\n    # Print in exact required format\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```"
        },
        {
            "introduction": "在了解了如何构建这些矩阵之后，一个核心问题是如何高效地应用它们，尤其是在三维等高维问题中。本练习通过分析计算复杂度，对比了朴素的密集矩阵向量乘法与利用张量积结构的高效“求和因式分解”方法。理解这种巨大的性能差异对于开发可扩展的现代谱元和间断Galerkin方法至关重要。",
            "id": "3398537",
            "problem": "考虑在谱元法 (SEM) 和间断伽辽金 (DG) 离散化中，将在单个参考六面体单元 $\\hat{\\Omega}=[-1,1]^{3}$ 上由拉普拉斯算子弱形式产生的刚度算子 $K$ 的应用。设标量试探空间和检验空间由在三个坐标方向上每个方向的 $p+1$ 个高斯-洛巴托-勒让德 (GLL) 节点上构建的张量积拉格朗日基函数张成，因此每个单元的自由度数为 $N=(p+1)^{3}$。假设采用配置公式，其中质量矩阵在 GLL 求积下是对角的，几何是具有单位雅可比矩阵和常系数的仿射映射，因此度量项是平凡的，单元级别的刚度算子简化为三个可分离的一维贡献之和。\n\n定义一维微分矩阵 $D\\in\\mathbb{R}^{n\\times n}$，其中 $n=p+1$，其元素为 $D_{ij}=l_{j}'(\\xi_{i})$，其中 $l_{j}$ 是 GLL 节点 $\\{\\xi_{i}\\}_{i=1}^{n}$ 上的拉格朗日基多项式。设 $\\{w_{i}\\}_{i=1}^{n}$ 为一维 GLL 求积权重，并设张量积节点 $(i,j,k)$ 处的三维求积权重为 $w_{i}w_{j}w_{k}$。根据这些定义，单元刚度算子可以写成张量积形式，即对所有坐标方向上的一维微分转置、对角加权和一维微分应用求和。\n\n考虑两种应用策略：\n- 一种无矩阵求和分解应用，它利用张量积可分性，沿每个坐标方向的线执行一系列一维矩阵向量乘积，并结合对角缩放和累加。\n- 一种与完全组装的 $N\\times N$ 刚度矩阵进行的朴素稠密矩阵向量乘积。\n\n假设以下浮点运算 (flop) 模型：一次标量乘法或一次标量加法各计为一次 flop；一次稠密的 $n\\times n$ 矩阵向量乘法花费 $2n^{2}$ 次 flops (输出向量的每个条目一次乘法和一次加法)；对长度为 $n$ 的向量进行对角缩放花费 $n$ 次 flops；对三个逐单元贡献求和每个自由度花费 $2$ 次加法。忽略通量、罚项和边界项，以及除上述对角求积权重之外的任何几何因子收缩。\n\n从可分离弱形式和这些运算假设出发，推导：\n1. 对 $K$ 进行求和分解应用时，每个单元的总 flop 次数，作为 $p$ 的函数。\n2. 进行朴素稠密矩阵向量应用时，每个单元的总 flop 次数，作为 $p$ 的函数。\n3. 朴素稠密 flop 次数与求和分解 flop 次数的比值，作为 $p$ 的闭式解析表达式。\n\n将您的最终答案表示为关于 $p$ 的单一比率。不需要四舍五入，也没有物理单位。首次使用时请定义并使用任何首字母缩写词，包括间断伽辽金 (DG) 和谱元法 (SEM)。",
            "solution": "该问题要求推导在参考六面体上应用谱元刚度算子的两种方法的浮点运算 (flop) 次数，并求出这些次数的比值。\n\n首先，我们建立数学背景和符号表示。该离散化在三个空间方向 $\\xi$、$\\eta$ 和 $\\zeta$ 上，均使用基于 $n=p+1$ 个高斯-洛巴托-勒让德 (GLL) 节点的 $p$ 次张量积拉格朗日多项式作为基。每个单元的总自由度 (DoF) 数为 $N = n^3 = (p+1)^3$。单元上的解向量 $u$ 可以表示为一个大小为 $n \\times n \\times n$ 的三维数组。\n\n刚度算子 $K$ 来自负拉普拉斯算子 $-\\nabla^2$ 的弱形式，对于参考单元 $\\hat{\\Omega}=[-1,1]^3$ 上的检验函数 $v$ 和试探函数 $u$，它由积分 $\\int_{\\hat{\\Omega}} \\nabla v \\cdot \\nabla u \\, d\\hat{\\Omega}$ 给出。在单位雅可比矩阵的假设下，这可以分解为三个项：\n$$ \\int_{\\hat{\\Omega}} \\frac{\\partial v}{\\partial \\xi}\\frac{\\partial u}{\\partial \\xi} \\, d\\hat{\\Omega} + \\int_{\\hat{\\Omega}} \\frac{\\partial v}{\\partial \\eta}\\frac{\\partial u}{\\partial \\eta} \\, d\\hat{\\Omega} + \\int_{\\hat{\\Omega}} \\frac{\\partial v}{\\partial \\zeta}\\frac{\\partial u}{\\partial \\zeta} \\, d\\hat{\\Omega} $$\n当使用 GLL 基函数并在 GLL 节点上进行配置（这使得质量矩阵对角化）进行离散化时，算子作用 $Ku$ 可以写成三个分量的和，$Ku = K_\\xi u + K_\\eta u + K_\\zeta u$。每个分量对应一个空间方向。\n\n$\\xi$-方向的算子可以表示为张量积形式 $K_\\xi = (D_\\xi)^T M D_\\xi$，其中 $D_\\xi = D \\otimes I_n \\otimes I_n$ 是离散微分算子，$D \\in \\mathbb{R}^{n \\times n}$ 是一维微分矩阵，$I_n$ 是 $n \\times n$ 单位矩阵，而 $M$ 是 $N \\times N$ 对角质量矩阵。$M$ 的对角元素中，对应于节点 $(\\xi_i, \\eta_j, \\zeta_k)$ 的是三维求积权重 $w_i w_j w_k$。$\\eta$ 和 $\\zeta$ 方向的算子是类似的：$K_\\eta = (D_\\eta)^T M D_\\eta$ 和 $K_\\zeta = (D_\\zeta)^T M D_\\zeta$，其中 $D_\\eta = I_n \\otimes D \\otimes I_n$ 和 $D_\\zeta = I_n \\otimes I_n \\otimes D$。\n\n1.  **求和分解应用的 Flop 次数 ($C_{SF}$)**\n求和分解方法在不组装完整矩阵 $K$ 的情况下计算算子作用 $Ku$。它分别计算每个方向的贡献然后将结果相加：$v = (K_\\xi u) + (K_\\eta u) + (K_\\zeta u)$。让我们分析其中一项 $v_\\xi = (D_\\xi)^T M (D_\\xi u)$ 的 flop 次数。\n\n-   **第 1 步：应用 $D_\\xi$。** 操作 $u' = D_\\xi u$ 对应于将一维微分矩阵 $D$ 应用于沿 $\\xi$-纤维的数据。共有 $n^2$ 条这样的纤维（每个 $(\\eta_j, \\zeta_k)$ 索引对一条），每条长度为 $n$。一次稠密的 $n \\times n$ 矩阵向量乘积的成本为 $2n^2$ flops。\n    -   $D_\\xi u$ 的成本：$n^2 \\times (2n^2) = 2n^4$ flops。\n\n-   **第 2 步：应用 $M$。** 操作 $u'' = M u'$ 是用对角质量矩阵 $M$ 进行缩放。这对应于将长度为 $N=n^3$ 的向量 $u'$ 与 $M$ 的对角元素进行逐元素相乘。\n    -   $M u'$ 的成本：$N = n^3$ flops。\n\n-   **第 3 步：应用 $(D_\\xi)^T$。** 操作 $v_\\xi = (D_\\xi)^T u''$ 与第 1 步类似，即沿 $\\xi$-纤维应用转置微分矩阵 $D^T$。\n    -   $(D_\\xi)^T u''$ 的成本：$n^2 \\times (2n^2) = 2n^4$ flops。\n\n计算一个方向贡献 ($v_\\xi$) 的总成本是这三个步骤成本的总和：$4n^4 + n^3$ flops。\n根据对称性，计算 $v_\\eta$ 和 $v_\\zeta$ 的成本是相同的。计算所有三个贡献的总成本为 $3 \\times (4n^4 + n^3) = 12n^4 + 3n^3$ flops。\n\n-   **第 4 步：累加结果。** 最终结果是 $v = v_\\xi + v_\\eta + v_\\zeta$。这涉及将三个长度为 $N=n^3$ 的向量相加。这需要两次向量加法。问题规定，每个自由度花费 $2$ 次加法。\n    -   累加成本：$2N = 2n^3$ flops。\n\n求和分解应用的总 flop 次数是所有步骤的总和：\n$$C_{SF} = (12n^4 + 3n^3) + 2n^3 = 12n^4 + 5n^3$$\n代入 $n=p+1$，我们得到 $C_{SF} = 12(p+1)^4 + 5(p+1)^3$。\n\n2.  **朴素稠密应用的 Flop 次数 ($C_{Naive}$)**\n朴素方法涉及构造完整的 $N \\times N$ 刚度矩阵 $K$ 并执行标准的矩阵向量乘积 $Ku$。\n-   矩阵的大小是 $N \\times N$，其中 $N=n^3 = (p+1)^3$。\n-   问题指出，一次稠密的 $M \\times M$ 矩阵向量乘法花费 $2M^2$ 次 flops。在我们的情况下，大小为 $N$。\n-   因此成本为 $2N^2$。\n$$C_{Naive} = 2N^2 = 2(n^3)^2 = 2n^6$$\n代入 $n=p+1$，我们得到 $C_{Naive} = 2(p+1)^6$。\n\n3.  **Flop 次数的比值**\n朴素稠密 flop 次数与求和分解 flop 次数的比值为：\n$$ \\text{Ratio} = \\frac{C_{Naive}}{C_{SF}} = \\frac{2n^6}{12n^4 + 5n^3} $$\n对于任何有效的离散化，$p \\ge 1$ 因而 $n \\ge 2$，所以我们可以通过用 $n^3$ 除以分子和分母来化简表达式：\n$$ \\text{Ratio} = \\frac{2n^3}{12n + 5} $$\n最后，我们通过代入 $n=p+1$ 将该比值表示为多项式阶数 $p$ 的函数：\n$$ \\text{Ratio} = \\frac{2(p+1)^3}{12(p+1) + 5} = \\frac{2(p+1)^3}{12p + 12 + 5} = \\frac{2(p+1)^3}{12p + 17} $$\n该表达式量化了求和分解技术相对于朴素稠密矩阵方法的显著计算优势，这一优势随着多项式阶数 $p$ 的增加而迅速增长。",
            "answer": "$$ \\boxed{\\frac{2(p+1)^3}{12p+17}} $$"
        }
    ]
}