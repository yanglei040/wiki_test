{
    "hands_on_practices": [
        {
            "introduction": "在间断 Galerkin (DG) 方法中，将控制方程的弱形式转化为单元上的积分是其核心步骤。为了保证数值解的精度，精确地计算这些积分至关重要。本实践聚焦于弱形式中的体积积分项，通过一个基础但关键的计算，我们将确定为避免在此项中引入求积误差所需的最小数值求积阶数 。这个练习是任何 DG 程序正确实现的第一步，它确保了方法的基本代数精度。",
            "id": "3376150",
            "problem": "考虑在一个被剖分为不重叠单纯元的区域上，以守恒形式写出的可压缩欧拉方程：\n$$\n\\partial_{t} \\boldsymbol{u} + \\nabla \\cdot \\boldsymbol{f}(\\boldsymbol{u}) = \\boldsymbol{0},\n$$\n其中 $\\boldsymbol{u}$ 汇集了守恒变量，$\\boldsymbol{f}(\\boldsymbol{u})$ 是通量。在一个单元 $K$ 上，间断伽辽金（DG）方法（其中 DG 代表 Discontinuous Galerkin）使用一个总次数至多为 $p$ 的局部多项式试验空间，记为 $\\mathbb{P}^{p}(K)$，以及检验函数 $v_{h} \\in \\mathbb{P}^{p}(K)$。假设如下：\n- 守恒未知量 $\\boldsymbol{u}_{h}$ 由 $\\mathbb{P}^{p}(K)$ 中的多项式表示。\n- 通量由一个多项式投影 $\\boldsymbol{f}_{h}(\\boldsymbol{u}_{h})$ 近似，其分量属于 $\\mathbb{P}^{p}(K)$；也就是说，通量是以 $p$ 阶近似的。\n- 体项在弱形式下计算为\n$$\n\\int_{K} \\boldsymbol{f}_{h}(\\boldsymbol{u}_{h}) \\cdot \\nabla v_{h} \\, \\mathrm{d}\\boldsymbol{x}.\n$$\n如果一个在 $K$ 上的求积法则对 $K$ 上所有总次数至多为 $m$ 的多项式都是精确的，则称该求积法则的阶为 $m$。\n\n请确定所需的最小求积阶 $m$（用 $p$ 表示），使得对于所有 $v_{h} \\in \\mathbb{P}^{p}(K)$ 的选择和所有多项式通量近似 $\\boldsymbol{f}_{h}(\\boldsymbol{u}_{h}) \\in \\left(\\mathbb{P}^{p}(K)\\right)^{d}$，上述体积分都能被精确计算。请用一个关于 $p$ 的单独的闭式表达式来表示您的最终答案。",
            "solution": "该问题要求确定一个求积法则的最小阶数，记为 $m$，该阶数是为可压缩欧拉方程的间断伽辽金（DG）离散化精确计算体积分的弱形式所必需的。\n\n所讨论的积分是：\n$$\nI = \\int_{K} \\boldsymbol{f}_{h}(\\boldsymbol{u}_{h}) \\cdot \\nabla v_{h} \\, \\mathrm{d}\\boldsymbol{x}\n$$\n其中 $K$ 是区域中的一个单纯元。\n\n根据问题陈述，一个 $m$ 阶求积法则对 $K$ 上所有总次数至多为 $m$ 的多项式都是精确的。为了找到所需的最小阶 $m$，我们必须确定被积函数（即标量函数 $\\boldsymbol{f}_{h}(\\boldsymbol{u}_{h}) \\cdot \\nabla v_{h}$）的最大可能总次数。\n\n让我们根据所提供的信息分析被积函数中每一项的多项式次数：\n\n1.  **检验函数 $v_{h}$**：问题陈述指出检验函数 $v_{h}$ 选自局部多项式空间 $\\mathbb{P}^{p}(K)$。该空间由总次数至多为 $p$ 的多项式组成。我们可以将其写为 $\\text{deg}(v_{h}) \\le p$。\n\n2.  **检验函数的梯度 $\\nabla v_{h}$**：梯度算子 $\\nabla$ 应用于一个多项式会使其总次数减少一。由于 $v_{h}$ 是一个次数至多为 $p$ 的多项式，其梯度 $\\nabla v_{h}$ 是一个向量，其分量是总次数至多为 $p-1$ 的多项式。$\\nabla v_{h}$ 的每个分量都属于空间 $\\mathbb{P}^{p-1}(K)$。如果我们将 $\\nabla v_{h}$ 的分量表示为 $(\\nabla v_{h})_i$，那么对于每个 $i \\in \\{1, \\dots, d\\}$，都有 $\\text{deg}((\\nabla v_{h})_i) \\le p-1$，其中 $d$ 是空间维度。\n\n3.  **近似通量 $\\boldsymbol{f}_{h}(\\boldsymbol{u}_{h})$**：问题明确指出“通量由一个多项式投影 $\\boldsymbol{f}_{h}(\\boldsymbol{u}_{h})$ 近似，其分量属于 $\\mathbb{P}^{p}(K)$”。这是一条关键信息。这意味着无论真实通量 $\\boldsymbol{f}(\\boldsymbol{u})$ 的非线性如何，积分中使用的近似 $\\boldsymbol{f}_{h}$ 是一个向量，其分量是总次数至多为 $p$ 的多项式。如果我们将 $\\boldsymbol{f}_{h}$ 的分量表示为 $(\\boldsymbol{f}_{h})_i$，那么 $\\text{deg}((\\boldsymbol{f}_{h})_i) \\le p$。\n\n现在，我们可以确定被积函数的次数。被积函数是两个向量场 $\\boldsymbol{f}_{h}$ 和 $\\nabla v_{h}$ 的点积：\n$$\n\\boldsymbol{f}_{h} \\cdot \\nabla v_{h} = \\sum_{i=1}^{d} (\\boldsymbol{f}_{h})_i \\, (\\nabla v_{h})_i\n$$\n对于这个求和中的每一项，我们将 $\\boldsymbol{f}_{h}$ 的一个分量乘以 $\\nabla v_{h}$ 的一个对应分量。让我们分析这样一个乘积 $(\\boldsymbol{f}_{h})_i \\, (\\nabla v_{h})_i$ 的次数。两个多项式乘积的次数是它们各自次数的和。\n$$\n\\text{deg}((\\boldsymbol{f}_{h})_i \\, (\\nabla v_{h})_i) = \\text{deg}((\\boldsymbol{f}_{h})_i) + \\text{deg}((\\nabla v_{h})_i)\n$$\n为了找到这个乘积的最大可能次数，我们使用这些因子的最大次数：\n$$\n\\max \\left( \\text{deg}((\\boldsymbol{f}_{h})_i \\, (\\nabla v_{h})_i) \\right) \\le p + (p-1) = 2p-1.\n$$\n多项式和的次数不大于和中任何多项式的最大次数。由于和 $\\sum_{i=1}^{d} (\\boldsymbol{f}_{h})_i \\, (\\nabla v_{h})_i$ 中的每一项都是次数至多为 $2p-1$ 的多项式，因此整个被积函数也是一个次数至多为 $2p-1$ 的多项式。\n$$\n\\text{deg}(\\boldsymbol{f}_{h} \\cdot \\nabla v_{h}) \\le 2p-1.\n$$\n为了让求积法则能精确计算积分 $I$，它必须对所有可能的被积函数都精确。这意味着该法则必须对次数高达被积函数最大可能次数（即 $2p-1$）的任何多项式都精确。\n\n根据所给的定义，一个 $m$ 阶求积法则对所有总次数至多为 $m$ 的多项式都精确。因此，我们必须有：\n$$\nm \\ge 2p-1.\n$$\n问题要求的是所需的最小求积阶。这对应于对所有有效的 $\\boldsymbol{f}_{h}$ 和 $v_{h}$ 选择都满足条件的最小整数值 $m$。因此，当等号成立时，达到最小值。\n$$\nm_{\\text{min}} = 2p-1.\n$$\n这确保了对于 $\\mathbb{P}^p(K)$ 中的任何选择 $v_h$ 和 $(\\mathbb{P}^p(K))^d$ 中的任何通量近似 $\\boldsymbol{f}_h$，得到的被积多项式（其次数可高达 $2p-1$）都能被精确积分。",
            "answer": "$$\\boxed{2p-1}$$"
        },
        {
            "introduction": "间断 Galerkin 方法的“间断”特性要求在单元交界面处进行特殊处理，这通常通过引入数值通量来实现，以耦合相邻单元的解。不同的数值通量方案对解的质量有显著影响，尤其是在处理复杂流动现象时。本实践将引导你动手实现并评估几种经典的 Riemann 求解器，包括 Roe 通量、HLLC 通量和 Lax-Friedrichs 通量，并检验它们精确保持接触间断物理特性的能力 。这项技能对于开发能够准确模拟可压缩流动的稳健求解器至关重要。",
            "id": "3376114",
            "problem": "考虑比热比为 $\\gamma$ 的理想气体的守恒形式可压缩欧拉方程，写作 $\\partial_t \\boldsymbol{U} + \\nabla \\cdot \\boldsymbol{F}(\\boldsymbol{U}) = \\boldsymbol{0}$，其中守恒变量为 $\\boldsymbol{U} = [\\rho, \\rho \\boldsymbol{u}, E]^\\top$，物理通量为 $\\boldsymbol{F}(\\boldsymbol{U}) = [\\rho \\boldsymbol{u}, \\rho \\boldsymbol{u} \\otimes \\boldsymbol{u} + p \\boldsymbol{I}, (E + p) \\boldsymbol{u}]$。这里，$\\rho$ 是密度，$\\boldsymbol{u} \\in \\mathbb{R}^3$ 是速度，$E$ 是总能量，$p$ 是压力，且 $p = (\\gamma - 1)\\left(E - \\tfrac{1}{2} \\rho \\|\\boldsymbol{u}\\|^2\\right)$。在间断伽辽金 (DG) 方法中，界面耦合通过作用于每个面上的数值通量 $\\widehat{\\boldsymbol{F}}_n(\\boldsymbol{U}_L, \\boldsymbol{U}_R; \\boldsymbol{n})$ 来实现，其中 $\\boldsymbol{n}$ 为单位法向量。该数值通量近似于法向通量 $\\boldsymbol{F}_n(\\boldsymbol{U}) := \\boldsymbol{F}(\\boldsymbol{U}) \\cdot \\boldsymbol{n} = [\\rho u_n, \\rho \\boldsymbol{u} u_n + p \\boldsymbol{n}, (E + p) u_n]^\\top$，其中 $u_n := \\boldsymbol{u} \\cdot \\boldsymbol{n}$。\n\n欧拉方程的平面接触间断的特征是，界面两侧的压力和法向速度相等，但密度和切向速度可能不同。具体来说，对于左右状态 $(\\rho_L, \\boldsymbol{u}_L, p_L)$ 和 $(\\rho_R, \\boldsymbol{u}_R, p_R)$ 以及单位法向量 $\\boldsymbol{n}$，一个平面接触间断满足 $p_L = p_R$ 和 $u_{n,L} = u_{n,R}$，其中 $u_{n,\\star} := \\boldsymbol{u}_\\star \\cdot \\boldsymbol{n}$。穿过这样一个间断的精确黎曼解会根据相对于共同法向速度 $u_n$ 的迎风侧，得出一个唯一的界面通量：如果 $u_n > 0$，则 $\\boldsymbol{F}_{n,\\mathrm{exact}} = \\boldsymbol{F}_n(\\boldsymbol{U}_L)$；如果 $u_n  0$，则 $\\boldsymbol{F}_{n,\\mathrm{exact}} = \\boldsymbol{F}_n(\\boldsymbol{U}_R)$；如果 $u_n = 0$，则界面通量为 $\\boldsymbol{F}_{n,\\mathrm{exact}} = [0, p \\boldsymbol{n}, 0]^\\top$。\n\n任务：从以上定义和守恒律的朗金-雨贡纽条件出发，推导在单位法向量为 $\\boldsymbol{n}$ 的面上，三种数值通量的可实现公式：\n- 由单一特征速度界定义的局部 Lax–Friedrichs (Rusanov) 通量，\n- 由沿 $\\boldsymbol{n}$ 方向的 Roe 线性化构建的 Roe 通量，\n- 沿 $\\boldsymbol{n}$ 方向的 Harten–Lax–van Leer–Contact (HLLC) 通量。\n\n然后，对于一组专门用于测试平面接触间断（$p_L = p_R$ 和 $u_{n,L} = u_{n,R}$，但允许 $\\rho$ 和切向速度 $\\boldsymbol{u}_t := \\boldsymbol{u} - u_n \\boldsymbol{n}$ 存在跳跃）的测试用例，计算每种通量的数值界面通量 $\\widehat{\\boldsymbol{F}}_n$，并将其与保持接触间断的精确界面通量 $\\boldsymbol{F}_{n,\\mathrm{exact}}$ 进行比较。当且仅当通量误差的欧几里得范数 $\\|\\widehat{\\boldsymbol{F}}_n - \\boldsymbol{F}_{n,\\mathrm{exact}}\\|_2$ 小于或等于容差 $\\varepsilon$ 乘以 $(1 + \\|\\boldsymbol{F}_{n,\\mathrm{exact}}\\|_2)$ 时，才宣布该通量在给定测试中是“保持接触间断的”，其中 $\\varepsilon = 10^{-8}$。\n\n所有量均为无量纲。在所有情况下使用 $\\gamma = 1.4$。使用以下测试套件，每个测试用例由 $(\\boldsymbol{n}, \\rho_L, \\boldsymbol{u}_L, p_L, \\rho_R, \\boldsymbol{u}_R, p_R)$ 指定，其中 $\\boldsymbol{n}$ 是单位向量，$\\boldsymbol{u}_\\star = (u_x, u_y, u_z)$：\n\n- 案例 A (静止平面接触间断，法向轴对齐): $\\boldsymbol{n} = (1, 0, 0)$, $\\rho_L = 1.0$, $\\boldsymbol{u}_L = (0, 0.5, 0)$, $p_L = 10^5$, $\\rho_R = 2.0$, $\\boldsymbol{u}_R = (0, -0.5, 0)$, $p_R = 10^5$。\n- 案例 B (正法向速度移动的平面接触间断): $\\boldsymbol{n} = (1, 0, 0)$, $\\rho_L = 0.8$, $\\boldsymbol{u}_L = (100, 20, 0)$, $p_L = 10^5$, $\\rho_R = 1.2$, $\\boldsymbol{u}_R = (100, -30, 0)$, $p_R = 10^5$。\n- 案例 C (负法向速度移动的平面接触间断): $\\boldsymbol{n} = (1, 0, 0)$, $\\rho_L = 1.5$, $\\boldsymbol{u}_L = (-50, 10, 0)$, $p_L = 10^5$, $\\rho_R = 0.7$, $\\boldsymbol{u}_R = (-50, -10, 0)$, $p_R = 10^5$。\n- 案例 D (正法向速度移动的斜向平面接触间断): $\\boldsymbol{n} = \\frac{1}{\\sqrt{2}}(1, 1, 0)$, $\\rho_L = 1.0$, $\\boldsymbol{u}_L = 30 \\boldsymbol{n} + 15 \\boldsymbol{t}$, $p_L = 10^5$, $\\rho_R = 0.9$, $\\boldsymbol{u}_R = 30 \\boldsymbol{n} - 20 \\boldsymbol{t}$, $p_R = 10^5$，其中 $\\boldsymbol{t} = \\frac{1}{\\sqrt{2}}(1, -1, 0)$。\n\n对于每个案例，计算三个布尔值，分别表示每种数值通量（按 Roe、Harten–Lax–van Leer–Contact 和 Lax–Friedrichs 的顺序）是否根据上述准则保持接触间断。您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果（例如，“[result1,result2,result3,...]”）。每个结果是一个布尔值，对应于单个案例上的单个通量，按顺序排列为：案例 A Roe、案例 A Harten–Lax–van Leer–Contact、案例 A Lax–Friedrichs、案例 B Roe、案例 B Harten–Lax–van Leer–Contact、案例 B Lax–Friedrichs，依此类推，直到案例 D。",
            "solution": "该问题陈述具有科学依据，是适定、客观且自洽的。它提出了一个分析双曲守恒律（特别是可压缩欧拉方程）数值通量的标准练习。物理模型、数学方程以及数值格式（Lax-Friedrichs、Roe、HLLC）的定义在计算流体力学领域都是标准的。测试用例被正确地构建以表示平面接触间断。因此，该问题是有效的，并将提供一个解决方案。\n\n任务是推导 Lax-Friedrichs (或 Rusanov)、Roe 和 HLLC 数值通量的公式，然后评估它们在处理可压缩欧拉方程的接触间断时的保持能力。如果数值通量与接触波的精确通量之间的误差的欧几里得范数低于指定的容差，则该通量被视为“保持接触间断的”。\n\n令守恒变量的状态向量为 $\\boldsymbol{U} = [\\rho, \\rho u_x, \\rho u_y, \\rho u_z, E]^\\top \\in \\mathbb{R}^5$。可压缩欧拉方程由 $\\partial_t \\boldsymbol{U} + \\nabla \\cdot \\boldsymbol{F}(\\boldsymbol{U}) = \\boldsymbol{0}$ 给出。压力 $p$ 由理想气体的状态方程 $p = (\\gamma-1)(E - \\frac{1}{2} \\rho \\|\\boldsymbol{u}\\|^2)$ 给出，其中 $\\gamma$ 是比热比。声速为 $c = \\sqrt{\\gamma p / \\rho}$。\n\n在单位法向量为 $\\boldsymbol{n}$ 的界面处，通量沿法向投影：\n$\\boldsymbol{F}_n(\\boldsymbol{U}) = \\boldsymbol{F}(\\boldsymbol{U}) \\cdot \\boldsymbol{n} = [\\rho u_n, \\rho u_x u_n + p n_x, \\rho u_y u_n + p n_y, \\rho u_z u_n + p n_z, (E+p)u_n]^\\top$，其中 $u_n = \\boldsymbol{u} \\cdot \\boldsymbol{n}$ 是法向速度。\n\n左状态 $(\\rho_L, \\boldsymbol{u}_L, p_L)$ 和右状态 $(\\rho_R, \\boldsymbol{u}_R, p_R)$ 之间的平面接触间断的特征是恒定的压力 $p_L = p_R = p$ 和恒定的法向速度 $u_{n,L} = u_{n,R} = u_n$。此类波的朗金-雨贡纽条件为 $\\boldsymbol{F}_n(\\boldsymbol{U}_R) - \\boldsymbol{F}_n(\\boldsymbol{U}_L) = u_n(\\boldsymbol{U}_R - \\boldsymbol{U}_L)$。以速度 $u_n$ 移动的界面上的精确通量由迎风状态给出：\n$$\n\\boldsymbol{F}_{n,\\mathrm{exact}} =\n\\begin{cases}\n    \\boldsymbol{F}_n(\\boldsymbol{U}_L)   \\text{若 } u_n  0 \\\\\n    \\boldsymbol{F}_n(\\boldsymbol{U}_R)   \\text{若 } u_n  0 \\\\\n    [0, p n_x, p n_y, p n_z, 0]^\\top   \\text{若 } u_n = 0\n\\end{cases}\n$$\n我们现在推导所要求的三种数值通量的公式。\n\n### 数值通量的推导\n\n#### 1. 局部 Lax–Friedrichs (Rusanov) 通量\n局部 Lax–Friedrichs 通量，也称为 Rusanov 通量，是一种简单、鲁棒但耗散的格式。它是通过对物理通量进行平均，并添加一个与守恒变量跳跃成正比的数值耗散项来构造的。\n$$\n\\widehat{\\boldsymbol{F}}_n^{LF}(\\boldsymbol{U}_L, \\boldsymbol{U}_R) = \\frac{1}{2} \\left[ \\boldsymbol{F}_n(\\boldsymbol{U}_L) + \\boldsymbol{F}_n(\\boldsymbol{U}_R) \\right] - \\frac{\\alpha}{2} \\left[ \\boldsymbol{U}_R - \\boldsymbol{U}_L \\right]\n$$\n耗散系数 $\\alpha$ 必须是离界面传播的最快信号速度的上限。通量雅可比矩阵 $\\boldsymbol{A}_n = \\partial \\boldsymbol{F}_n / \\partial \\boldsymbol{U}$ 的特征值为 $\\{u_n, u_n, u_n, u_n+c, u_n-c\\}$。$\\alpha$ 的一个合适选择（Rusanov 速度）是为左右状态计算的特征值绝对值的最大值：\n$$\n\\alpha = \\max(|u_{n,L}| + c_L, |u_{n,R}| + c_R)\n$$\n对于接触间断，$u_{n,L} = u_{n,R} = u_n$，所以 $\\alpha = |u_n| + \\max(c_L, c_R)$。该通量引入了与 $\\alpha$ 成正比的耗散，即使只有密度或切向速度发生跳跃，该耗散项也不为零。对于 $u_n  0$ 的接触间断，误差项为 $\\widehat{\\boldsymbol{F}}_n^{LF} - \\boldsymbol{F}_{n,\\mathrm{exact}} = \\frac{1}{2}(u_n(\\boldsymbol{U}_R-\\boldsymbol{U}_L)) - \\frac{\\alpha}{2}(\\boldsymbol{U}_R-\\boldsymbol{U}_L) = \\frac{1}{2}(u_n - \\alpha)(\\boldsymbol{U}_R-\\boldsymbol{U}_L) = -\\frac{1}{2}\\max(c_L, c_R)(\\boldsymbol{U}_R-\\boldsymbol{U}_L)$。该误差通常不为零，表明 LF/Rusanov 通量不保持接触间断。\n\n#### 2. Roe 通量\nRoe 通量被设计为对孤立间断是精确的。其定义为：\n$$\n\\widehat{\\boldsymbol{F}}_n^{Roe}(\\boldsymbol{U}_L, \\boldsymbol{U}_R) = \\frac{1}{2} \\left[ \\boldsymbol{F}_n(\\boldsymbol{U}_L) + \\boldsymbol{F}_n(\\boldsymbol{U}_R) \\right] - \\frac{1}{2} |\\hat{\\boldsymbol{A}}_n|(\\boldsymbol{U}_R - \\boldsymbol{U}_L)\n$$\n其中 $\\hat{\\boldsymbol{A}}_n = \\boldsymbol{A}_n(\\hat{\\boldsymbol{U}})$ 是在特殊构造的 Roe 平均状态 $\\hat{\\boldsymbol{U}}$ 下计算的通量雅可比矩阵。Roe 平均状态满足性质 $\\boldsymbol{F}_n(\\boldsymbol{U}_R) - \\boldsymbol{F}_n(\\boldsymbol{U}_L) = \\hat{\\boldsymbol{A}}_n(\\boldsymbol{U}_R - \\boldsymbol{U}_L)$。比焓 $h=(E+p)/\\rho$、速度 $\\boldsymbol{u}$ 和密度 $\\rho$ 的 Roe 平均值为：\n$$\n\\hat{\\rho} = \\sqrt{\\rho_L \\rho_R}, \\quad \\hat{\\boldsymbol{u}} = \\frac{\\sqrt{\\rho_L} \\boldsymbol{u}_L + \\sqrt{\\rho_R} \\boldsymbol{u}_R}{\\sqrt{\\rho_L} + \\sqrt{\\rho_R}}, \\quad \\hat{h} = \\frac{\\sqrt{\\rho_L} h_L + \\sqrt{\\rho_R} h_R}{\\sqrt{\\rho_L} + \\sqrt{\\rho_R}}\n$$\n对于接触间断，朗金-雨贡纽条件给出 $\\boldsymbol{F}_n(\\boldsymbol{U}_R) - \\boldsymbol{F}_n(\\boldsymbol{U}_L) = u_n(\\boldsymbol{U}_R - \\boldsymbol{U}_L)$。将其与 Roe 性质结合，我们得到 $\\hat{\\boldsymbol{A}}_n(\\boldsymbol{U}_R - \\boldsymbol{U}_L) = u_n(\\boldsymbol{U}_R - \\boldsymbol{U}_L)$。这表明对于接触间断，跳跃向量 $\\Delta\\boldsymbol{U} = \\boldsymbol{U}_R - \\boldsymbol{U}_L$ 是 Roe 矩阵 $\\hat{\\boldsymbol{A}}_n$ 的一个特征向量，其特征值为 $u_n$。此外，对于接触间断，Roe 平均法向速度为 $\\hat{u}_n = \\hat{\\boldsymbol{u}} \\cdot \\boldsymbol{n} = u_n$。耗散项变为：\n$$\n|\\hat{\\boldsymbol{A}}_n|(\\boldsymbol{U}_R - \\boldsymbol{U}_L) = |u_n|(\\boldsymbol{U}_R - \\boldsymbol{U}_L)\n$$\n将此代入 Roe 通量的定义：\n$$\n\\widehat{\\boldsymbol{F}}_n^{Roe} = \\frac{1}{2} \\left[ \\boldsymbol{F}_n(\\boldsymbol{U}_L) + \\boldsymbol{F}_n(\\boldsymbol{U}_R) \\right] - \\frac{1}{2} |u_n|(\\boldsymbol{U}_R - \\boldsymbol{U}_L)\n$$\n如果 $u_n  0$，我们使用 $|u_n| = u_n$ 和 $\\boldsymbol{F}_n(\\boldsymbol{U}_R) = \\boldsymbol{F}_n(\\boldsymbol{U}_L) + u_n(\\boldsymbol{U}_R - \\boldsymbol{U}_L)$:\n$\\widehat{\\boldsymbol{F}}_n^{Roe} = \\frac{1}{2}(\\boldsymbol{F}_n(\\boldsymbol{U}_L) + \\boldsymbol{F}_n(\\boldsymbol{U}_L) + u_n(\\boldsymbol{U}_R - \\boldsymbol{U}_L)) - \\frac{1}{2}u_n(\\boldsymbol{U}_R - \\boldsymbol{U}_L) = \\boldsymbol{F}_n(\\boldsymbol{U}_L)$，这是精确通量。\n如果 $u_n  0$，我们使用 $|u_n| = -u_n$ 和 $\\boldsymbol{F}_n(\\boldsymbol{U}_L) = \\boldsymbol{F}_n(\\boldsymbol{U}_R) - u_n(\\boldsymbol{U}_R - \\boldsymbol{U}_L)$:\n$\\widehat{\\boldsymbol{F}}_n^{Roe} = \\frac{1}{2}(\\boldsymbol{F}_n(\\boldsymbol{U}_R) - u_n(\\boldsymbol{U}_R - \\boldsymbol{U}_L) + \\boldsymbol{F}_n(\\boldsymbol{U}_R)) + \\frac{1}{2}u_n(\\boldsymbol{U}_R - \\boldsymbol{U}_L) = \\boldsymbol{F}_n(\\boldsymbol{U}_R)$，这是精确通量。\n如果 $u_n = 0$，耗散为零，且 $\\widehat{\\boldsymbol{F}}_n^{Roe} = \\frac{1}{2}(\\boldsymbol{F}_n(\\boldsymbol{U}_L) + \\boldsymbol{F}_n(\\boldsymbol{U}_R))$。由于 $u_n=0$，$\\boldsymbol{F}_n(\\boldsymbol{U}_L) = \\boldsymbol{F}_n(\\boldsymbol{U}_R) = [0, p\\boldsymbol{n}, 0]^\\top$，所以 Roe 通量是精确的。\n因此，Roe 通量在理论上对于接触间断是精确的。\n\n#### 3. Harten–Lax–van Leer–Contact (HLLC) 通量\nHLLC 通量是 HLL 通量的扩展，它重新引入了缺失的接触波结构。它假设一个黎曼扇由三道速度为 $S_L$ (最左)、$S_M$ (中间/接触) 和 $S_R$ (最右) 的波组成，分隔开四个常数状态：$\\boldsymbol{U}_L, \\boldsymbol{U}_L^*, \\boldsymbol{U}_R^*, \\boldsymbol{U}_R$。\n波速 $S_L$ 和 $S_R$ 是被估计的。一个常见的选择（Davis 的估计）是：\n$$\nS_L = \\min(u_{n,L}, u_{n,R}) - \\max(c_L, c_R), \\quad S_R = \\max(u_{n,L}, u_{n,R}) + \\max(c_L, c_R)\n$$\n接触波速度 $S_M$ 是通过将朗金-雨贡纽条件应用于整个系统推导出来的：\n$$\nS_M = \\frac{p_R - p_L + \\rho_L u_{n,L}(S_L - u_{n,L}) - \\rho_R u_{n,R}(S_R - u_{n,R})}{\\rho_L(S_L - u_{n,L}) - \\rho_R(S_R - u_{n,R})}\n$$\n对于接触间断，$p_L=p_R$ 且 $u_{n,L}=u_{n,R}=u_n$，这使得 $S_M$ 简化为：\n$$\nS_M = \\frac{\\rho_L u_n(S_L - u_n) - \\rho_R u_n(S_R - u_n)}{\\rho_L(S_L - u_n) - \\rho_R(S_R - u_n)} = u_n\n$$\n然后根据界面位置 ($x/t=0$) 相对于波速来选择 HLLC 通量：\n$$\n\\widehat{\\boldsymbol{F}}_n^{HLLC} = \\begin{cases}\n    \\boldsymbol{F}_n(\\boldsymbol{U}_L)   \\text{若 } 0 \\le S_L \\\\\n    \\boldsymbol{F}_L^* = \\boldsymbol{F}_n(\\boldsymbol{U}_L) + S_L(\\boldsymbol{U}_L^* - \\boldsymbol{U}_L)   \\text{若 } S_L  0 \\le S_M \\\\\n    \\boldsymbol{F}_R^* = \\boldsymbol{F}_n(\\boldsymbol{U}_R) + S_R(\\boldsymbol{U}_R^* - \\boldsymbol{U}_R)   \\text{若 } S_M  0  S_R \\\\\n    \\boldsymbol{F}_n(\\boldsymbol{U}_R)   \\text{若 } 0 \\ge S_R\n\\end{cases}\n$$\n中间状态 $\\boldsymbol{U}_k^*$ ($k=L,R$) 是通过在 $S_L$ 和 $S_R$ 波上应用朗金-雨贡纽条件找到的。可以证明，对于接触间断，$\\boldsymbol{U}_L^* = \\boldsymbol{U}_L$ 和 $\\boldsymbol{U}_R^* = \\boldsymbol{U}_R$。我们来验证 $\\boldsymbol{U}_L^*$。星区中的压力和法向速度为 $p^*$ 和 $S_M$。对于接触间断，$p^* = p_L + \\rho_L(u_{n,L}-S_L)(u_{n,L}-S_M) = p_L + \\rho_L(u_n-S_L)(u_n-u_n) = p_L=p$。并且 $u_{n,L}^*=S_M=u_n$。切向速度不变，$\\boldsymbol{u}_{t,L}^*=\\boldsymbol{u}_{t,L}$。密度为 $\\rho_L^* = \\rho_L \\frac{S_L-u_{n,L}}{S_L-S_M} = \\rho_L \\frac{S_L-u_n}{S_L-u_n} = \\rho_L$。由于 $(\\rho_L, \\boldsymbol{u}_L, p_L)$ 与 $(\\rho_L^*, \\boldsymbol{u}_L^*, p_L^*)$ 完全相同，我们有 $\\boldsymbol{U}_L^* = \\boldsymbol{U}_L$。类似地，$\\boldsymbol{U}_R^* = \\boldsymbol{U}_R$。\n- 如果 $u_n  0$ 且为亚声速 ($S_L  0  S_R$)，那么 $S_M=u_n0$。通量为 $\\widehat{\\boldsymbol{F}}_n^{HLLC} = \\boldsymbol{F}_L^* = \\boldsymbol{F}_n(\\boldsymbol{U}_L) + S_L(\\boldsymbol{U}_L-\\boldsymbol{U}_L) = \\boldsymbol{F}_n(\\boldsymbol{U}_L)$。\n- 如果 $u_n  0$ 且为亚声速，那么 $S_M=u_n0$。通量为 $\\widehat{\\boldsymbol{F}}_n^{HLLC} = \\boldsymbol{F}_R^* = \\boldsymbol{F}_n(\\boldsymbol{U}_R) + S_R(\\boldsymbol{U}_R-\\boldsymbol{U}_R) = \\boldsymbol{F}_n(\\boldsymbol{U}_R)$。\n- 如果 $u_n = 0$，那么 $S_M=0$。通量为 $\\boldsymbol{F}_L^*$ 或 $\\boldsymbol{F}_R^*$。两者都计算为 $[0, p\\boldsymbol{n}, 0]^\\top$。\n在所有情况下，HLLC 通量都与精确通量匹配。因此，HLLC 在理论上也是保持接触间断的。\n\n下面的实现将为给定的测试用例计算这些通量，并以数值方式验证这些理论性质。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Derives and computes numerical fluxes for the Euler equations,\n    testing their contact-preserving properties.\n    \"\"\"\n    gamma = 1.4\n    epsilon = 1e-8\n\n    test_cases = [\n        # Case A\n        {'n': np.array([1.0, 0.0, 0.0]),\n         'rho_L': 1.0, 'u_L': np.array([0.0, 0.5, 0.0]), 'p_L': 1e5,\n         'rho_R': 2.0, 'u_R': np.array([0.0, -0.5, 0.0]), 'p_R': 1e5},\n        # Case B\n        {'n': np.array([1.0, 0.0, 0.0]),\n         'rho_L': 0.8, 'u_L': np.array([100.0, 20.0, 0.0]), 'p_L': 1e5,\n         'rho_R': 1.2, 'u_R': np.array([100.0, -30.0, 0.0]), 'p_R': 1e5},\n        # Case C\n        {'n': np.array([1.0, 0.0, 0.0]),\n         'rho_L': 1.5, 'u_L': np.array([-50.0, 10.0, 0.0]), 'p_L': 1e5,\n         'rho_R': 0.7, 'u_R': np.array([-50.0, -10.0, 0.0]), 'p_R': 1e5},\n        # Case D\n        {'n': np.array([1.0/np.sqrt(2), 1.0/np.sqrt(2), 0.0]),\n         'rho_L': 1.0, 'p_L': 1e5,\n         'rho_R': 0.9, 'p_R': 1e5,\n         'u_L': 30 * np.array([1.0/np.sqrt(2), 1.0/np.sqrt(2), 0.0]) + 15 * np.array([1.0/np.sqrt(2), -1.0/np.sqrt(2), 0.0]),\n         'u_R': 30 * np.array([1.0/np.sqrt(2), 1.0/np.sqrt(2), 0.0]) - 20 * np.array([1.0/np.sqrt(2), -1.0/np.sqrt(2), 0.0])\n        }\n    ]\n\n    def get_conservative_state(rho, u, p, gamma_val):\n        \"\"\"Computes conservative state U from primitive variables.\"\"\"\n        E = p / (gamma_val - 1.0) + 0.5 * rho * np.dot(u, u)\n        return np.array([rho, rho * u[0], rho * u[1], rho * u[2], E])\n\n    def get_physical_flux(rho, u, p, n, E, gamma_val):\n        \"\"\"Computes the physical flux vector F_n.\"\"\"\n        u_n = np.dot(u, n)\n        return np.array([\n            rho * u_n,\n            rho * u[0] * u_n + p * n[0],\n            rho * u[1] * u_n + p * n[1],\n            rho * u[2] * u_n + p * n[2],\n            (E + p) * u_n\n        ])\n\n    def flux_lf(U_L, U_R, F_n_L, F_n_R, u_n_L, c_L, u_n_R, c_R):\n        alpha = max(abs(u_n_L) + c_L, abs(u_n_R) + c_R)\n        return 0.5 * (F_n_L + F_n_R) - 0.5 * alpha * (U_R - U_L)\n\n    def flux_roe(U_L, U_R, F_n_L, F_n_R, u_n_L):\n        # For a contact, the Roe flux simplifies significantly\n        F_roe = 0.5 * (F_n_L + F_n_R) - 0.5 * abs(u_n_L) * (U_R - U_L)\n        return F_roe\n\n    def flux_hllc(n, rho_L, u_L, p_L, E_L, c_L, U_L, F_n_L,\n                  rho_R, u_R, p_R, E_R, c_R, U_R, F_n_R, gamma_val):\n        u_n_L = np.dot(u_L, n)\n        u_n_R = np.dot(u_R, n)\n\n        # Wave speed estimates (Davis)\n        S_L = min(u_n_L, u_n_R) - max(c_L, c_R)\n        S_R = max(u_n_L, u_n_R) + max(c_L, c_R)\n        \n        # S_M based on pressure equality in the star region\n        num = p_R - p_L + rho_L * u_n_L * (S_L - u_n_L) - rho_R * u_n_R * (S_R - u_n_R)\n        den = rho_L * (S_L - u_n_L) - rho_R * (S_R - u_n_R)\n        S_M = num / den\n\n        if S_L >= 0:\n            return F_n_L\n        elif S_R = 0:\n            return F_n_R\n        else: # S_L  0 and S_R > 0\n            if S_M >= 0:\n                p_star = p_L + rho_L * (u_n_L - S_L) * (u_n_L - S_M)\n                rho_star_L = rho_L * (S_L - u_n_L) / (S_L - S_M)\n                u_t_L = u_L - u_n_L * n\n                u_star_L = S_M * n + u_t_L\n                \n                E_star_L = (p_star / (gamma_val - 1.0)) + 0.5 * rho_star_L * np.dot(u_star_L, u_star_L)\n                U_star_L = np.array([rho_star_L, rho_star_L * u_star_L[0], rho_star_L * u_star_L[1], rho_star_L * u_star_L[2], E_star_L])\n\n                return F_n_L + S_L * (U_star_L - U_L)\n            else: # S_M  0\n                p_star = p_R + rho_R * (u_n_R - S_R) * (u_n_R - S_M)\n                rho_star_R = rho_R * (S_R - u_n_R) / (S_R - S_M)\n                u_t_R = u_R - u_n_R * n\n                u_star_R = S_M * n + u_t_R\n                \n                E_star_R = (p_star / (gamma_val - 1.0)) + 0.5 * rho_star_R * np.dot(u_star_R, u_star_R)\n                U_star_R = np.array([rho_star_R, rho_star_R * u_star_R[0], rho_star_R * u_star_R[1], rho_star_R * u_star_R[2], E_star_R])\n\n                return F_n_R + S_R * (U_star_R - U_R)\n\n    def check_preservation(F_num, F_exact, tol):\n        error_norm = np.linalg.norm(F_num - F_exact)\n        f_norm = np.linalg.norm(F_exact)\n        return error_norm = tol * (1.0 + f_norm)\n\n    results = []\n\n    for case in test_cases:\n        n = case['n']\n        rho_L, u_L, p_L = case['rho_L'], case['u_L'], case['p_L']\n        rho_R, u_R, p_R = case['rho_R'], case['u_R'], case['p_R']\n        \n        # Left state properties\n        E_L = p_L / (gamma - 1.0) + 0.5 * rho_L * np.dot(u_L, u_L)\n        U_L = get_conservative_state(rho_L, u_L, p_L, gamma)\n        c_L = np.sqrt(gamma * p_L / rho_L)\n        u_n_L = np.dot(u_L, n)\n        F_n_L = get_physical_flux(rho_L, u_L, p_L, n, E_L, gamma)\n\n        # Right state properties\n        E_R = p_R / (gamma - 1.0) + 0.5 * rho_R * np.dot(u_R, u_R)\n        U_R = get_conservative_state(rho_R, u_R, p_R, gamma)\n        c_R = np.sqrt(gamma * p_R / rho_R)\n        u_n_R = np.dot(u_R, n)\n        F_n_R = get_physical_flux(rho_R, u_R, p_R, n, E_R, gamma)\n        \n        # Exact flux for contact\n        if u_n_L > 0:\n            F_exact = F_n_L\n        elif u_n_L  0:\n            F_exact = F_n_R\n        else:\n            F_exact = np.array([0.0, p_L * n[0], p_L * n[1], p_L * n[2], 0.0])\n            \n        # Roe Flux\n        F_roe_val = flux_roe(U_L, U_R, F_n_L, F_n_R, u_n_L)\n        results.append(check_preservation(F_roe_val, F_exact, epsilon))\n\n        # HLLC Flux\n        F_hllc_val = flux_hllc(n, rho_L, u_L, p_L, E_L, c_L, U_L, F_n_L,\n                               rho_R, u_R, p_R, E_R, c_R, U_R, F_n_R, gamma)\n        results.append(check_preservation(F_hllc_val, F_exact, epsilon))\n        \n        # LF Flux\n        F_lf_val = flux_lf(U_L, U_R, F_n_L, F_n_R, u_n_L, c_L, u_n_R, c_R)\n        results.append(check_preservation(F_lf_val, F_exact, epsilon))\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "高阶方法（如 DG）在模拟含有激波等强间断的流动时，容易在间断附近产生非物理的数值振荡。为了解决这一问题，通常采用混合格式，首先使用问题单元指示器（troubled-cell indicator, TCI）定位这些包含间断的“问题”单元，然后对其进行局部处理（如斜率限制或人工粘性）。本实践提供了一个实际的编程练习，你将实现并检验基于不同物理量（密度与压力）的 TCI，并比较它们在区分激波和光滑高频波时的性能优劣 。掌握 TCI 的设计与评估是使 DG 方法在激波问题中实用化的关键环节。",
            "id": "3376102",
            "problem": "考虑一维可压缩欧拉方程，用于比热比为 $\\gamma$ 的理想气体，其形式为\n$$\n\\partial_t \\mathbf{U} + \\partial_x \\mathbf{F}(\\mathbf{U}) = 0,\n$$\n其中守恒变量为 $\\mathbf{U} = (\\rho, \\rho u, E)$，包含密度 $\\rho$、速度 $u$ 和总能量 $E$。通量函数为\n$$\n\\mathbf{F}(\\mathbf{U}) = \\left( \\rho u, \\rho u^2 + p, u(E + p) \\right).\n$$\n压力 $p$ 满足理想气体关系式\n$$\np = (\\gamma - 1)\\left(E - \\tfrac{1}{2}\\rho u^2\\right).\n$$\n在间断伽辽金（Discontinuous Galerkin, DG）格式中，每个网格内的场由参考区间 $\\xi \\in [-1,1]$ 上的勒让德基 $\\{P_n(\\xi)\\}_{n=0}^p$ 中的多项式表示。对于一个标量场 $f(x)$，其在网格 $K_i = [x_i, x_{i+1}]$ 中到 $p$ 阶勒让德多项式上的 $L^2$ 投影为\n$$\nf(x(\\xi)) \\approx \\sum_{n=0}^{p} a_n^{(i)} P_n(\\xi), \\quad \\xi = \\frac{2(x - x_i)}{h_i} - 1, \\quad h_i = x_{i+1} - x_i,\n$$\n其模态系数为\n$$\na_n^{(i)} = \\frac{2n+1}{2} \\int_{-1}^{1} f\\big(x(\\xi)\\big) P_n(\\xi)\\, d\\xi,\n$$\n这里利用了正交性 $\\int_{-1}^{1} P_m(\\xi) P_n(\\xi)\\, d\\xi = \\frac{2}{2n+1}\\delta_{mn}$。\n\n问题网格指示器（troubled-cell indicator, TCI）旨在通过测量最高阶多项式模态中的相对能量来检测非光滑网格（例如，包含激波的网格）。对于场 $f$ 在网格 $i$ 中的 Persson–Peraire 型传感器定义为\n$$\nS_f^{(i)} := \\log_{10}\\left( \\frac{\\left(a_p^{(i)}\\right)^2}{\\sum_{n=0}^{p} \\left(a_n^{(i)}\\right)^2 + \\varepsilon} \\right),\n$$\n其中 $p$ 是多项式阶数，$\\varepsilon$ 是一个为避免除零而引入的小正数。如果 $S_f^{(i)}  \\tau_f$（其中 $\\tau_f$ 是一个阈值），则网格 $i$ 就被标记为场 $f$ 的问题网格。\n\n您将为一个合成的一维激波-密度波构型比较一个基于密度的指示器 $S_\\rho^{(i)}$ 和一个基于压力的指示器 $S_p^{(i)}$。计算域为 $[0,1]$，被划分为 $N$ 个均匀网格，网格尺寸为 $h=1/N$。固定时间下的合成场构造如下。设激波位置为 $x_s \\in (0,1)$，左侧状态为 $(\\rho_L, p_L)$，右侧状态为 $(\\rho_R, p_R)$，密度波振幅为 $a \\ge 0$，整数波频率为 $f_{\\text{w}} \\in \\mathbb{N}$。定义\n$$\nu(x) = 0, \\quad\n(\\rho(x), p(x)) = \\begin{cases}\n(\\rho_L, p_L),  x  x_s, \\\\\n\\left(\\rho_R\\left[1 + a \\sin\\left(2\\pi f_{\\text{w}} (x - x_s)\\right)\\right],\\ p_R\\right),  x \\ge x_s,\n\\end{cases}\n$$\n并根据 $p(x) = (\\gamma - 1)\\left(E(x) - \\tfrac{1}{2}\\rho(x) u(x)^2\\right)$ 和 $\\gamma=1.4$ 计算 $E(x)$。这定义了物理上合理（$\\rho(x)  0$, $p(x)  0$）但在此刻不必满足演化方程的守恒变量 $\\mathbf{U}(x)$。\n\n基准真相问题网格是相对于 $x_s$ 处的间断来定义的：一个网格 $K_i = [x_i, x_{i+1}]$ 如果其闭包与激波位置相交，即 $x_i \\le x_s \\le x_{i+1}$，则该网格是一个真实的问题网格。如果 $x_s$ 与某个网格界面 $x_j$ 重合，则相邻的两个网格 $[x_{j-1}, x_j]$ 和 $[x_j, x_{j+1}]$ 都是真实的问题网格。\n\n对于每个指示器（基于 $\\rho$ 和基于 $p$），计算其相对于此基准真相的假正率和假负率，定义为\n$$\n\\text{FPR}_f = \\frac{\\text{FP}_f}{\\text{FP}_f + \\text{TN}_f}, \\qquad\n\\text{FNR}_f = \\frac{\\text{FN}_f}{\\text{FN}_f + \\text{TP}_f},\n$$\n其中 $\\text{TP}_f$、$\\text{FP}_f$、$\\text{TN}_f$ 和 $\\text{FN}_f$ 分别表示场 $f \\in \\{\\rho, p\\}$ 的真阳性、假阳性、真阴性和假阴性的计数。如果分母为零，则将相应的比率定义为 $0$。\n\n使用高斯-勒让德积分实现 $L^2$ 投影，每个网格至少使用 $2p+6$ 个点来计算 $\\rho(x)$ 和 $p(x)$ 的模态系数 $\\{a_n^{(i)}\\}_{n=0}^{p}$。使用上面定义的传感器 $S_f^{(i)}$，其中 $\\varepsilon = 10^{-16}$。\n\n您的程序必须在以下测试套件上评估这些指示器，涵盖典型、极端和边界情况：\n\n- 测试用例 1（正常情况）：$N = 40$, $p = 3$, $x_s = 0.33$, $\\rho_L = 1.0$, $p_L = 1.0$, $\\rho_R = 0.125$, $p_R = 0.1$, $a = 0.2$, $f_{\\text{w}} = 10$, $\\tau_\\rho = -2.5$, $\\tau_p = -2.5$。\n- 测试用例 2（极端阈值，无标记）：$N = 40$, $p = 3$, $x_s = 0.33$, $\\rho_L = 1.0$, $p_L = 1.0$, $\\rho_R = 0.125$, $p_R = 0.1$, $a = 0.2$, $f_{\\text{w}} = 10$, $\\tau_\\rho = 1.0$, $\\tau_p = 1.0$。\n- 测试用例 3（激波位于界面上，零波幅）：$N = 40$, $p = 3$, $x_s = 0.5$, $\\rho_L = 1.0$, $p_L = 1.0$, $\\rho_R = 0.125$, $p_R = 0.1$, $a = 0.0$, $f_{\\text{w}} = 10$, $\\tau_\\rho = -4.0$, $\\tau_p = -4.0$。\n- 测试用例 4（更高多项式阶数，更强波和非对称阈值）：$N = 60$, $p = 5$, $x_s = 0.7$, $\\rho_L = 1.0$, $p_L = 1.0$, $\\rho_R = 0.125$, $p_R = 0.1$, $a = 0.3$, $f_{\\text{w}} = 15$, $\\tau_\\rho = -3.0$, $\\tau_p = -2.0$。\n\n在这个合成设置中，所有量都是无量纲的。请将假正率和假负率表示为小数。\n\n您的程序应生成单行输出，其中包含一个逗号分隔的列表，用方括号括起来，按顺序汇总每个测试用例的四个率，顺序为测试用例 1 到 4 的 $(\\text{FPR}_\\rho, \\text{FNR}_\\rho, \\text{FPR}_p, \\text{FNR}_p)$。例如，输出格式必须为\n$$\n[\\text{FPR}_\\rho^{(1)}, \\text{FNR}_\\rho^{(1)}, \\text{FPR}_p^{(1)}, \\text{FNR}_p^{(1)}, \\ldots, \\text{FPR}_\\rho^{(4)}, \\text{FNR}_\\rho^{(4)}, \\text{FPR}_p^{(4)}, \\text{FNR}_p^{(4)}],\n$$\n程序最终打印输出时，每个小数都四舍五入到六位小数。",
            "solution": "该问题要求在间断伽辽金（DG）方法的框架内，实现并比较两种问题网格指示器（TCI），一种基于密度（$\\rho$），另一种基于压力（$p$）。此比较将在一个涉及激波和叠加密度波的合成一维问题上进行。每个指示器的性能将通过其相对于已定义基准真相的假正率（FPR）和假负率（FNR）来量化。\n\n物理模型是一维可压缩欧拉方程组，由 $\\partial_t \\mathbf{U} + \\partial_x \\mathbf{F}(\\mathbf{U}) = 0$ 给出，其中守恒变量向量为 $\\mathbf{U} = (\\rho, \\rho u, E)^T$，通量向量为 $\\mathbf{F}(\\mathbf{U}) = (\\rho u, \\rho u^2 + p, u(E+p))^T$。变量 $\\rho$、$u$、$E$ 和 $p$ 分别代表流体密度、速度、单位体积总能量和压力。该系统通过理想气体状态方程 $p = (\\gamma - 1)(E - \\frac{1}{2}\\rho u^2)$ 封闭，其中比热比给定为 $\\gamma=1.4$。\n\n在 DG 方法中，每个计算网格 $K_i = [x_i, x_{i+1}]$ 内的解由一个 $p$ 阶多项式逼近。通过使用线性映射 $\\xi(x) = \\frac{2(x - x_i)}{h_i} - 1$（其中 $h_i = x_{i+1} - x_i$ 是网格宽度），在参考单元 $\\xi \\in [-1, 1]$ 上进行操作会很方便。一个标量场 $f(x)$ 表示为一个正交基（通常是勒让德多项式 $\\{P_n(\\xi)\\}_{n=0}^p$）的有限展开式：\n$$\nf(x(\\xi)) \\approx \\sum_{n=0}^{p} a_n^{(i)} P_n(\\xi).\n$$\n系数 $a_n^{(i)}$ 是网格 $i$ 的模态自由度。它们通过函数 $f$ 到基函数上的 $L^2$ 投影来确定：\n$$\na_n^{(i)} = \\frac{\\int_{K_i} f(x) P_n(\\xi(x)) dx}{\\int_{K_i} P_n(\\xi(x))^2 dx} = \\frac{\\frac{h_i}{2} \\int_{-1}^{1} f(x(\\xi)) P_n(\\xi) d\\xi}{\\frac{h_i}{2} \\int_{-1}^{1} P_n(\\xi)^2 d\\xi} = \\frac{2n+1}{2} \\int_{-1}^{1} f(x(\\xi)) P_n(\\xi) d\\xi,\n$$\n这里我们使用了正交性质 $\\int_{-1}^{1} P_m(\\xi) P_n(\\xi) d\\xi = \\frac{2}{2n+1}\\delta_{mn}$。\n\nPersson–Peraire 问题网格指示器基于这样一个原理：对于光滑函数，其模态能量集中在低阶多项式中，而间断（如激波）会将能量散射到所有模态中，包括最高阶模态。场 $f$ 在网格 $i$ 中的传感器定义为：\n$$\nS_f^{(i)} := \\log_{10}\\left( \\frac{\\left(a_p^{(i)}\\right)^2}{\\sum_{n=0}^{p} \\left(a_n^{(i)}\\right)^2 + \\varepsilon} \\right).\n$$\n此表达式给出了最高阶模态（$n=p$）中的能量与所有模态总能量之比的对数。为了数值稳定性，加入了一个小的正数 $\\varepsilon = 10^{-16}$。如果一个网格 $i$ 的传感器值超过预设阈值，$S_f^{(i)}  \\tau_f$，则该网格被标记为“问题网格”。\n\n任务的核心是为一个合成数据剖面实现此过程。计算域为 $[0, 1]$，离散为 $N$ 个均匀网格，因此 $h=1/N$ 且 $x_i = i/N$ (对于 $i=0, 1, \\dots, N$)。合成场定义为零速度 $u(x)=0$，以及密度和压力的分段函数：\n$$\n(\\rho(x), p(x)) = \\begin{cases}\n(\\rho_L, p_L),  x  x_s \\\\\n\\left(\\rho_R\\left[1 + a \\sin\\left(2\\pi f_{\\text{w}} (x - x_s)\\right)\\right],\\ p_R\\right),  x \\ge x_s\n\\end{cases}\n$$\n该剖面在激波位置 $x_s$ 处存在一个间断，并且当 $a  0$ 时，在激波右侧存在一个光滑的高频密度波。压力剖面是一个简单的阶跃函数。\n\n数值算法如下：\n1.  对于每个测试用例，定义参数 $N, p, x_s, \\rho_L, p_L, \\rho_R, p_R, a, f_{\\text{w}}, \\tau_\\rho, \\tau_p$。\n2.  定义网格，其边界为 $x_i = i/N$，其中 $i=0, \\dots, N$。\n3.  建立基准真相：如果网格 $K_i=[x_i, x_{i+1}]$ 的闭包包含激波，即 $x_i \\le x_s \\le x_{i+1}$，则该网格为真实的问题网格。\n4.  对于每个网格 $K_i$：\n    a.  $\\rho(x)$ 和 $p(x)$ 的模态系数 $\\{a_n^{(i)}\\}_{n=0}^p$ 通过数值积分计算。$a_n^{(i)}$ 的积分使用具有 $N_q = 2p+6$ 个点 $(\\xi_k, w_k)$ 的高斯-勒让德积分来近似：\n       $$\n       a_n^{(i)} \\approx \\frac{2n+1}{2} \\sum_{k=1}^{N_q} w_k f\\big(x_i + \\tfrac{h}{2}(\\xi_k+1)\\big) P_n(\\xi_k).\n       $$\n       勒让德多项式集合 $P_n(\\xi_k)$（对于 $n=0, \\dots, p$）在积分节点 $\\xi_k$ 处预先求值。\n    b.  使用计算出的系数，计算传感器值 $S_\\rho^{(i)}$ 和 $S_p^{(i)}$。\n5.  对于每个场 $f \\in \\{\\rho, p\\}$，对所有网格进行分类：\n    -   如果 $S_f^{(i)}  \\tau_f$，则该网格被标记。\n    -   将标记的网格与基准真相进行比较，以计算真阳性（TP）、假阳性（FP）、真阴性（TN）和假阴性（FN）的数量。\n6.  计算性能指标。假正率是 $\\text{FPR}_f = \\frac{\\text{FP}_f}{\\text{FP}_f + \\text{TN}_f}$，假负率是 $\\text{FNR}_f = \\frac{\\text{FN}_f}{\\text{FN}_f + \\text{TP}_f}$。如果分母为零，则相应的比率定义为 0。\n7.  将每个测试用例的结果 $(\\text{FPR}_\\rho, \\text{FNR}_\\rho, \\text{FPR}_p, \\text{FNR}_p)$ 收集起来，并格式化为最终输出。\n\n对所有四个测试用例重复此过程，这些用例旨在探测指示器在不同条件下的鲁棒性，例如光滑波的存在、激波相对于网格界面的位置，以及多项式阶数和阈值的选择。",
            "answer": "```python\nimport numpy as np\nfrom scipy.special import eval_legendre\n\ndef solve():\n    \"\"\"\n    Computes false positive and false negative rates for density- and pressure-based\n    troubled-cell indicators for a synthetic 1D shock-density-wave problem.\n    \"\"\"\n    test_cases = [\n        {'N': 40, 'p': 3, 'xs': 0.33, 'rho_L': 1.0, 'p_L': 1.0, 'rho_R': 0.125, 'p_R': 0.1, 'a': 0.2, 'fw': 10, 'tau_rho': -2.5, 'tau_p': -2.5},\n        {'N': 40, 'p': 3, 'xs': 0.33, 'rho_L': 1.0, 'p_L': 1.0, 'rho_R': 0.125, 'p_R': 0.1, 'a': 0.2, 'fw': 10, 'tau_rho': 1.0, 'tau_p': 1.0},\n        {'N': 40, 'p': 3, 'xs': 0.5, 'rho_L': 1.0, 'p_L': 1.0, 'rho_R': 0.125, 'p_R': 0.1, 'a': 0.0, 'fw': 10, 'tau_rho': -4.0, 'tau_p': -4.0},\n        {'N': 60, 'p': 5, 'xs': 0.7, 'rho_L': 1.0, 'p_L': 1.0, 'rho_R': 0.125, 'p_R': 0.1, 'a': 0.3, 'fw': 15, 'tau_rho': -3.0, 'tau_p': -2.0},\n    ]\n\n    gamma = 1.4\n    epsilon = 1e-16\n    all_results = []\n\n    for params in test_cases:\n        N, p, xs = params['N'], params['p'], params['xs']\n        rho_L, p_L = params['rho_L'], params['p_L']\n        rho_R, p_R = params['rho_R'], params['p_R']\n        a, fw = params['a'], params['fw']\n        tau_rho, tau_p = params['tau_rho'], params['tau_p']\n\n        def rho_func(x):\n            val = np.piecewise(x, [x  xs],\n                               [rho_L, lambda v: rho_R * (1 + a * np.sin(2 * np.pi * fw * (v - xs)))])\n            return val\n        \n        def p_func(x):\n            val = np.piecewise(x, [x  xs], [p_L, p_R])\n            return val\n\n        h = 1.0 / N\n        cell_boundaries = np.linspace(0, 1, N + 1)\n\n        # Determine ground truth troubled cells\n        true_troubled = (cell_boundaries[:-1] = xs)  (xs = cell_boundaries[1:])\n        \n        # Quadrature setup\n        Nq = 2 * p + 6\n        xi_q, w_q = np.polynomial.legendre.leggauss(Nq)\n        \n        # Pre-evaluate Legendre polynomials at quadrature points\n        P_vals = np.array([eval_legendre(n, xi_q) for n in range(p + 1)])\n\n        S_rho = np.zeros(N)\n        S_p = np.zeros(N)\n\n        for i in range(N):\n            x_i = cell_boundaries[i]\n            \n            # Map reference quadrature points to physical cell\n            x_q = x_i + h / 2.0 * (xi_q + 1.0)\n            \n            # Evaluate fields at physical quadrature points\n            rho_vals_q = rho_func(x_q)\n            p_vals_q = p_func(x_q)\n            \n            # Calculate modal coefficients\n            coeffs_rho = np.zeros(p + 1)\n            coeffs_p = np.zeros(p + 1)\n            \n            for n in range(p + 1):\n                # Using P_vals pre-computation for efficiency\n                integral_rho = np.sum(w_q * rho_vals_q * P_vals[n])\n                integral_p = np.sum(w_q * p_vals_q * P_vals[n])\n                \n                coeffs_rho[n] = (2 * n + 1) / 2.0 * integral_rho\n                coeffs_p[n] = (2 * n + 1) / 2.0 * integral_p\n\n            # Calculate sensor values\n            total_energy_sq_rho = np.sum(coeffs_rho**2)\n            S_rho[i] = np.log10((coeffs_rho[p]**2) / (total_energy_sq_rho + epsilon))\n            \n            total_energy_sq_p = np.sum(coeffs_p**2)\n            S_p[i] = np.log10((coeffs_p[p]**2) / (total_energy_sq_p + epsilon))\n\n        # Classify cells and calculate metrics\n        predicted_troubled_rho = S_rho > tau_rho\n        predicted_troubled_p = S_p > tau_p\n\n        # For rho\n        TP_rho = np.sum(predicted_troubled_rho  true_troubled)\n        FP_rho = np.sum(predicted_troubled_rho  ~true_troubled)\n        TN_rho = np.sum(~predicted_troubled_rho  ~true_troubled)\n        FN_rho = np.sum(~predicted_troubled_rho  true_troubled)\n\n        # Denominators for rates\n        denom_fpr_rho = FP_rho + TN_rho\n        denom_fnr_rho = FN_rho + TP_rho\n        \n        FPR_rho = FP_rho / denom_fpr_rho if denom_fpr_rho > 0 else 0.0\n        FNR_rho = FN_rho / denom_fnr_rho if denom_fnr_rho > 0 else 0.0\n\n        # For p\n        TP_p = np.sum(predicted_troubled_p  true_troubled)\n        FP_p = np.sum(predicted_troubled_p  ~true_troubled)\n        TN_p = np.sum(~predicted_troubled_p  ~true_troubled)\n        FN_p = np.sum(~predicted_troubled_p  true_troubled)\n\n        # Denominators for rates\n        denom_fpr_p = FP_p + TN_p\n        denom_fnr_p = FN_p + TP_p\n        \n        FPR_p = FP_p / denom_fpr_p if denom_fpr_p > 0 else 0.0\n        FNR_p = FN_p / denom_fnr_p if denom_fnr_p > 0 else 0.0\n        \n        all_results.extend([FPR_rho, FNR_rho, FPR_p, FNR_p])\n\n    print(f\"[{','.join(f'{r:.6f}' for r in all_results)}]\")\n\nsolve()\n```"
        }
    ]
}