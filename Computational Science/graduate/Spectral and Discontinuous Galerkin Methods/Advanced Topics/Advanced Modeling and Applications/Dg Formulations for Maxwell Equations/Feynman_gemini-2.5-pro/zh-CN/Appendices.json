{
    "hands_on_practices": [
        {
            "introduction": "一个强大的数值方法必须能够应对复杂的物理环境。本练习将从麦克斯韦方程组出发，系统性地推导在各向异性介质中传播的DG公式，其中介电常数和磁导率均为张量。通过这个推导，你将掌握处理复杂材料本构关系的核心技巧，并学会如何通过特征分析来确定保证数值格式稳定性的上风通量 ()。",
            "id": "3375459",
            "problem": "考虑由 Maxwell 方程组所描述的，在线性、非均匀、各向异性介质中的时域电磁波传播。本构关系为 $\\boldsymbol{D} = \\boldsymbol{\\epsilon}(\\boldsymbol{x}) \\boldsymbol{E}$ 和 $\\boldsymbol{B} = \\boldsymbol{\\mu}(\\boldsymbol{x}) \\boldsymbol{H}$，其中 $\\boldsymbol{\\epsilon}(\\boldsymbol{x})$ 和 $\\boldsymbol{\\mu}(\\boldsymbol{x})$ 是空间变化的对称正定张量。Maxwell 方程组为\n$$\n\\partial_{t} \\boldsymbol{D} = \\nabla \\times \\boldsymbol{H} - \\boldsymbol{J}, \\qquad\n\\partial_{t} \\boldsymbol{B} = - \\nabla \\times \\boldsymbol{E},\n$$\n其中 $\\boldsymbol{J}(\\boldsymbol{x},t)$ 是给定的源。\n\n将注意力限制在二维横磁（TM）极化上，其非零场分量为 $E_{x}(\\boldsymbol{x},t)$、$E_{y}(\\boldsymbol{x},t)$ 和 $H_{z}(\\boldsymbol{x},t)$。假设各向异性介电常数为 $\\boldsymbol{\\epsilon}(\\boldsymbol{x}) = \\mathrm{diag}(\\epsilon_{x}(\\boldsymbol{x}), \\epsilon_{y}(\\boldsymbol{x}))$，各向异性磁导率为 $\\boldsymbol{\\mu}(\\boldsymbol{x}) = \\mathrm{diag}(0,0,\\mu_{z}(\\boldsymbol{x}))$。令 $\\boldsymbol{J} = \\boldsymbol{0}$。\n\n从上述基本定律和本构关系出发，执行以下操作：\n\n- 在此各向异性介质中，写出关于 $E_{x}$、$E_{y}$ 和 $H_{z}$ 的强形式偏微分方程。\n\n- 推导适用于间断 Galerkin (DG) 方法的单元弱形式，包括在体积分中处理空间变化的 $\\epsilon_{x}(\\boldsymbol{x})$、$\\epsilon_{y}(\\boldsymbol{x})$ 和 $\\mu_{z}(\\boldsymbol{x})$。明确说明由分部积分产生的边界（面）项，并解释必须如何调整数值通量以考虑各向异性和非均匀性。\n\n- 使用能量方法和局部于一个面的法向一维模态分析，确定沿具有单位外法向量 $\\boldsymbol{n} = (n_{x}, n_{y})$ 的面上的特征波速，该波速决定了此各向异性介质中 TM 系统的迎风数值通量和 Courant–Friedrichs–Lewy (CFL) 时间步长限制。\n\n- 以闭合形式给出该面法向特征波速 $c(\\boldsymbol{n})$ 的最终表达式，其为 $\\epsilon_{x}$、$\\epsilon_{y}$、$\\mu_{z}$、$n_{x}$ 和 $n_{y}$ 的函数，所有这些量都在面所在位置进行求值。\n\n将最终答案表示为单个闭合形式的解析表达式。不要代入数值。如果该表达式需要进行数值计算，速度应以米/秒表示，但在此问题中，您必须仅在最终的方框答案中呈现不带单位的解析表达式。",
            "solution": "所述问题具有科学依据，是自洽且适定的。它基于 Maxwell 方程组的基本原理，并使用标准模型和简化方法来分析各向异性介质中的波传播。这些任务是计算电磁学和间断 Galerkin 方法领域的标准推导。因此，该问题是有效的，下面提供了完整的解答。\n\n解答按要求分为三部分：强形式偏微分方程（PDEs）的推导、单元弱形式的推导以及特征波速的确定。\n\n**第 1 部分：强形式偏微分方程**\n\n我们从无源（$\\boldsymbol{J}=\\boldsymbol{0}$）介质中的 Maxwell 方程组开始：\n$$ \\partial_{t} \\boldsymbol{D} = \\nabla \\times \\boldsymbol{H} $$\n$$ \\partial_{t} \\boldsymbol{B} = - \\nabla \\times \\boldsymbol{E} $$\n线性、非均匀、各向异性介质的本构关系为 $\\boldsymbol{D} = \\boldsymbol{\\epsilon}(\\boldsymbol{x}) \\boldsymbol{E}$ 和 $\\boldsymbol{B} = \\boldsymbol{\\mu}(\\boldsymbol{x}) \\boldsymbol{H}$。\n\n对于二维横磁（TM）情况，场被限制为 $\\boldsymbol{E}(\\boldsymbol{x},t) = (E_{x}(x,y,t), E_{y}(x,y,t), 0)$ 和 $\\boldsymbol{H}(\\boldsymbol{x},t) = (0, 0, H_{z}(x,y,t))$。空间变化仅限于 $xy$ 平面，因此所有关于 $z$ 的偏导数都为零，即 $\\partial_z \\equiv 0$。\n\n介电常数张量为 $\\boldsymbol{\\epsilon}(\\boldsymbol{x}) = \\mathrm{diag}(\\epsilon_{x}(\\boldsymbol{x}), \\epsilon_{y}(\\boldsymbol{x}))$。在三维情况下，这意味着完整的张量是 $\\boldsymbol{\\epsilon}(\\boldsymbol{x}) = \\mathrm{diag}(\\epsilon_{x}(\\boldsymbol{x}), \\epsilon_{y}(\\boldsymbol{x}), \\epsilon_{z}(\\boldsymbol{x}))$。电位移矢量 $\\boldsymbol{D}$ 为：\n$$ \\boldsymbol{D} = \\begin{pmatrix} \\epsilon_x & 0 & 0 \\\\ 0 & \\epsilon_y & 0 \\\\ 0 & 0 & \\epsilon_z \\end{pmatrix} \\begin{pmatrix} E_x \\\\ E_y \\\\ 0 \\end{pmatrix} = \\begin{pmatrix} \\epsilon_x E_x \\\\ \\epsilon_y E_y \\\\ 0 \\end{pmatrix} $$\n磁导率张量为 $\\boldsymbol{\\mu}(\\boldsymbol{x}) = \\mathrm{diag}(0,0,\\mu_{z}(\\boldsymbol{x}))$。磁感应强度矢量 $\\boldsymbol{B}$ 为：\n$$ \\boldsymbol{B} = \\begin{pmatrix} 0 & 0 & 0 \\\\ 0 & 0 & 0 \\\\ 0 & 0 & \\mu_z \\end{pmatrix} \\begin{pmatrix} 0 \\\\ 0 \\\\ H_z \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ 0 \\\\ \\mu_z H_z \\end{pmatrix} $$\n这种形式的 $\\boldsymbol{\\mu}$ 确保了对于 TM 模式，$B_x=B_y=0$。\n\n现在，我们展开 Maxwell 方程组中的旋度算子。根据 Faraday 定律，$\\partial_{t} \\boldsymbol{B} = -\\nabla \\times \\boldsymbol{E}$：\n$$ \\nabla \\times \\boldsymbol{E} = \\begin{pmatrix} \\partial_y E_z - \\partial_z E_y \\\\ \\partial_z E_x - \\partial_x E_z \\\\ \\partial_x E_y - \\partial_y E_x \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ 0 \\\\ \\partial_x E_y - \\partial_y E_x \\end{pmatrix} $$\n因为 $E_z=0$ 且 $\\partial_z = 0$。通过令 $\\partial_t \\boldsymbol{B} = -\\nabla \\times \\boldsymbol{E}$ 的各分量相等：\n$$ \\partial_t B_x = 0 $$\n$$ \\partial_t B_y = 0 $$\n$$ \\partial_t B_z = -(\\partial_x E_y - \\partial_y E_x) $$\n将 $B_z = \\mu_z H_z$ 代入第三个方程，我们得到第一个偏微分方程：\n$$ \\mu_z(\\boldsymbol{x}) \\frac{\\partial H_z}{\\partial t} = \\partial_y E_x - \\partial_x E_y $$\n\n根据 Ampère 定律，$\\partial_{t} \\boldsymbol{D} = \\nabla \\times \\boldsymbol{H}$：\n$$ \\nabla \\times \\boldsymbol{H} = \\begin{pmatrix} \\partial_y H_z - \\partial_z H_y \\\\ \\partial_z H_x - \\partial_x H_z \\\\ \\partial_x H_y - \\partial_y H_x \\end{pmatrix} = \\begin{pmatrix} \\partial_y H_z \\\\ -\\partial_x H_z \\\\ 0 \\end{pmatrix} $$\n因为 $H_x=H_y=0$ 且 $\\partial_z=0$。通过令 $\\partial_t \\boldsymbol{D} = \\nabla \\times \\boldsymbol{H}$ 的各分量相等：\n$$ \\partial_t D_x = \\partial_y H_z $$\n$$ \\partial_t D_y = -\\partial_x H_z $$\n$$ \\partial_t D_z = 0 $$\n代入 $D_x = \\epsilon_x E_x$ 和 $D_y = \\epsilon_y E_y$，我们得到另外两个偏微分方程：\n$$ \\epsilon_x(\\boldsymbol{x}) \\frac{\\partial E_x}{\\partial t} = \\frac{\\partial H_z}{\\partial y} $$\n$$ \\epsilon_y(\\boldsymbol{x}) \\frac{\\partial E_y}{\\partial t} = -\\frac{\\partial H_z}{\\partial x} $$\n\n对于非零场分量 $E_x$、$E_y$ 和 $H_z$ 的强形式偏微分方程组为：\n$$ \\epsilon_x(\\boldsymbol{x}) \\frac{\\partial E_x}{\\partial t} = \\frac{\\partial H_z}{\\partial y} $$\n$$ \\epsilon_y(\\boldsymbol{x}) \\frac{\\partial E_y}{\\partial t} = -\\frac{\\partial H_z}{\\partial x} $$\n$$ \\mu_z(\\boldsymbol{x}) \\frac{\\partial H_z}{\\partial t} = \\partial_y E_x - \\partial_x E_y $$\n\n**第 2 部分：间断 Galerkin 弱形式**\n\n为了推导弱形式，我们考虑将空间域离散化的网格中的单个单元 $K$。我们将每个偏微分方程乘以一个来自适当函数空间的测试函数 $\\psi(\\boldsymbol{x})$，并在单元 $K$ 上积分。设离散解场由 $E_x^h, E_y^h, H_z^h$ 表示，它们是 $K$ 上的多项式。\n\n对于第一个方程：\n$$ \\int_K \\epsilon_x(\\boldsymbol{x}) \\frac{\\partial E_x^h}{\\partial t} \\psi \\, d\\boldsymbol{x} = \\int_K \\frac{\\partial H_z^h}{\\partial y} \\psi \\, d\\boldsymbol{x} $$\n对右侧应用分部积分（Green 第一恒等式）：\n$$ \\int_K \\frac{\\partial H_z^h}{\\partial y} \\psi \\, d\\boldsymbol{x} = \\oint_{\\partial K} (H_z^h \\psi) n_y \\, ds - \\int_K H_z^h \\frac{\\partial \\psi}{\\partial y} \\, d\\boldsymbol{x} $$\n其中 $\\boldsymbol{n} = (n_x, n_y)$ 是单元边界 $\\partial K$ 的单位外法向量。在 DG 方法中，边界上的状态变量 $H_z^h$ 被替换为数值通量，记为 $H_z^*$。通量 $H_z^*$ 是面两侧状态的函数，即 $H_z^*$ 取决于内部状态（$H_z^h, E_x^h, E_y^h$）和相邻单元的外部状态。这给出了弱形式：\n$$ \\int_K \\epsilon_x(\\boldsymbol{x}) \\frac{\\partial E_x^h}{\\partial t} \\psi \\, d\\boldsymbol{x} + \\int_K H_z^h \\frac{\\partial \\psi}{\\partial y} \\, d\\boldsymbol{x} - \\oint_{\\partial K} H_z^* \\psi n_y \\, ds = 0 $$\n\n对于第二个方程：\n$$ \\int_K \\epsilon_y(\\boldsymbol{x}) \\frac{\\partial E_y^h}{\\partial t} \\psi \\, d\\boldsymbol{x} = - \\int_K \\frac{\\partial H_z^h}{\\partial x} \\psi \\, d\\boldsymbol{x} $$\n类似地，通过分部积分并引入数值通量 $H_z^*$：\n$$ \\int_K \\frac{\\partial H_z^h}{\\partial x} \\psi \\, d\\boldsymbol{x} = \\oint_{\\partial K} (H_z^h \\psi) n_x \\, ds - \\int_K H_z^h \\frac{\\partial \\psi}{\\partial x} \\, d\\boldsymbol{x} $$\n弱形式为：\n$$ \\int_K \\epsilon_y(\\boldsymbol{x}) \\frac{\\partial E_y^h}{\\partial t} \\psi \\, d\\boldsymbol{x} + \\int_K H_z^h \\frac{\\partial \\psi}{\\partial x} \\, d\\boldsymbol{x} - \\oint_{\\partial K} H_z^* \\psi n_x \\, ds = 0 $$\n\n对于第三个方程：\n$$ \\int_K \\mu_z(\\boldsymbol{x}) \\frac{\\partial H_z^h}{\\partial t} \\psi \\, d\\boldsymbol{x} = \\int_K \\left(\\frac{\\partial E_x^h}{\\partial y} - \\frac{\\partial E_y^h}{\\partial x}\\right) \\psi \\, d\\boldsymbol{x} $$\n对右侧的两项进行分部积分，并引入数值通量 $E_x^*$ 和 $E_y^*$：\n$$ \\int_K \\mu_z(\\boldsymbol{x}) \\frac{\\partial H_z^h}{\\partial t} \\psi \\, d\\boldsymbol{x} + \\int_K \\left(E_x^h \\frac{\\partial \\psi}{\\partial y} - E_y^h \\frac{\\partial \\psi}{\\partial x}\\right) \\, d\\boldsymbol{x} - \\oint_{\\partial K} (E_x^* n_y - E_y^* n_x) \\psi \\, ds = 0 $$\n空间变化的材料参数 $\\epsilon_x(\\boldsymbol{x})$、$\\epsilon_y(\\boldsymbol{x})$ 和 $\\mu_z(\\boldsymbol{x})$ 仅作为被积函数的一部分保留在体积分中。在实际实现中，这些积分使用数值求积法进行计算，并在求积点上计算系数的值。\n\n数值通量 $E_x^*, E_y^*, H_z^*$ 对 DG 格式的稳定性和准确性至关重要。对于像 Maxwell 方程组这样的双曲系统，通常使用迎风偏置通量。迎风方向由系统垂直于单元面的特征波速确定。介质的各向异性和非均匀性通过使用面上 $\\epsilon_x, \\epsilon_y, \\mu_z$ 的局部值来计算这些特征波速，进而定义数值通量。\n\n**第 3 部分：特征波速**\n\n为了找到沿法向量为 $\\boldsymbol{n}=(n_x, n_y)$ 的面上的特征波速 $c(\\boldsymbol{n})$，我们分析将偏微分方程投影到该法向方向上得到的一维系统。首先，我们将系统写成守恒律形式 $\\boldsymbol{M}(\\boldsymbol{x}) \\partial_t \\boldsymbol{U} + \\partial_x \\boldsymbol{F}_x(\\boldsymbol{U}) + \\partial_y \\boldsymbol{F}_y(\\boldsymbol{U}) = 0$。令状态向量为 $\\boldsymbol{U} = (E_x, E_y, H_z)^T$。系统方程为：\n$$ \\epsilon_x \\partial_t E_x - \\partial_y H_z = 0 $$\n$$ \\epsilon_y \\partial_t E_y + \\partial_x H_z = 0 $$\n$$ \\mu_z \\partial_t H_z + \\partial_x E_y - \\partial_y E_x = 0 $$\n我们可以定义通量向量 $\\boldsymbol{F}_x = (0, -H_z, -E_y)^T$ 和 $\\boldsymbol{F}_y = (H_z, 0, E_x)^T$。\n通量雅可比矩阵为 $\\boldsymbol{A}' = \\partial \\boldsymbol{F}_x / \\partial \\boldsymbol{U}$ 和 $\\boldsymbol{B}' = \\partial \\boldsymbol{F}_y / \\partial \\boldsymbol{U}$，给出：\n$$ \\boldsymbol{A}' = \\begin{pmatrix} 0 & 0 & 0 \\\\ 0 & 0 & -1 \\\\ 0 & -1 & 0 \\end{pmatrix}, \\qquad \\boldsymbol{B}' = \\begin{pmatrix} 0 & 0 & 1 \\\\ 0 & 0 & 0 \\\\ 1 & 0 & 0 \\end{pmatrix} $$\n因此，系统可以写为 $\\boldsymbol{M} \\partial_t \\boldsymbol{U} + \\boldsymbol{A}' \\partial_x \\boldsymbol{U} + \\boldsymbol{B}' \\partial_y \\boldsymbol{U} = 0$，其中 $\\boldsymbol{M}(\\boldsymbol{x}) = \\mathrm{diag}(\\epsilon_x(\\boldsymbol{x}), \\epsilon_y(\\boldsymbol{x}), \\mu_z(\\boldsymbol{x}))$。\n\n对于垂直于一个面的法向一维分析，我们只考虑沿方向 $\\eta = \\boldsymbol{n} \\cdot \\boldsymbol{x} = n_x x + n_y y$ 的变化。因此，$\\partial_x \\rightarrow n_x \\frac{d}{d\\eta}$ 和 $\\partial_y \\rightarrow n_y \\frac{d}{d\\eta}$。系统变为：\n$$ \\boldsymbol{M} \\partial_t \\boldsymbol{U} + (n_x \\boldsymbol{A}' + n_y \\boldsymbol{B}') \\frac{d\\boldsymbol{U}}{d\\eta} = 0 $$\n定义通量雅可比矩阵在法向 $\\boldsymbol{n}$ 上的投影为 $\\boldsymbol{K}(\\boldsymbol{n}) = n_x \\boldsymbol{A}' + n_y \\boldsymbol{B}'$。\n$$ \\boldsymbol{K}(\\boldsymbol{n}) = n_x \\begin{pmatrix} 0 & 0 & 0 \\\\ 0 & 0 & -1 \\\\ 0 & -1 & 0 \\end{pmatrix} + n_y \\begin{pmatrix} 0 & 0 & 1 \\\\ 0 & 0 & 0 \\\\ 1 & 0 & 0 \\end{pmatrix} = \\begin{pmatrix} 0 & 0 & n_y \\\\ 0 & 0 & -n_x \\\\ n_y & -n_x & 0 \\end{pmatrix} $$\n特征速度 $c$ 是广义特征值问题 $\\boldsymbol{K}(\\boldsymbol{n}) \\boldsymbol{v} = c \\boldsymbol{M} \\boldsymbol{v}$ 的特征值。它们是特征方程 $\\det(\\boldsymbol{K}(\\boldsymbol{n}) - c\\boldsymbol{M}) = 0$ 的根。\n$$ \\det \\begin{pmatrix} -c\\epsilon_x & 0 & n_y \\\\ 0 & -c\\epsilon_y & -n_x \\\\ n_y & -n_x & -c\\mu_z \\end{pmatrix} = 0 $$\n计算行列式：\n$$ (-c\\epsilon_x) \\left[(-c\\epsilon_y)(-c\\mu_z) - (-n_x)(-n_x)\\right] - (0) + (n_y) \\left[(0)(-n_x) - (-c\\epsilon_y)(n_y)\\right] = 0 $$\n$$ (-c\\epsilon_x) (c^2 \\epsilon_y \\mu_z - n_x^2) + n_y (c\\epsilon_y n_y) = 0 $$\n$$ -c^3 \\epsilon_x \\epsilon_y \\mu_z + c \\epsilon_x n_x^2 + c \\epsilon_y n_y^2 = 0 $$\n$$ c (-c^2 \\epsilon_x \\epsilon_y \\mu_z + \\epsilon_x n_x^2 + \\epsilon_y n_y^2) = 0 $$\n这个方程有三个关于 $c$ 的根。一个根是 $c=0$。另外两个根由下式给出：\n$$ c^2 \\epsilon_x \\epsilon_y \\mu_z = \\epsilon_x n_x^2 + \\epsilon_y n_y^2 $$\n$$ c^2 = \\frac{\\epsilon_x n_x^2 + \\epsilon_y n_y^2}{\\epsilon_x \\epsilon_y \\mu_z} $$\n非零特征速度为 $c = \\pm \\sqrt{\\frac{\\epsilon_x n_x^2 + \\epsilon_y n_y^2}{\\epsilon_x \\epsilon_y \\mu_z}}$。\n特征波速是最大特征值的模，它控制着垂直于面的信息流动。此速度用于在迎风通量中设置数值耗散，并通过 CFL 条件确定最大稳定时间步长。\n因此，面法向特征波速 $c(\\boldsymbol{n})$ 是非零根的绝对值：\n$$ c(\\boldsymbol{n}) = \\sqrt{\\frac{\\epsilon_x n_x^2 + \\epsilon_y n_y^2}{\\epsilon_x \\epsilon_y \\mu_z}} $$\n$\\epsilon_x, \\epsilon_y, \\mu_z, n_x, n_y$ 的值都在单元面上的位置进行计算。",
            "answer": "$$\n\\boxed{\\sqrt{\\frac{\\epsilon_{x} n_{x}^{2} + \\epsilon_{y} n_{y}^{2}}{\\epsilon_{x} \\epsilon_{y} \\mu_{z}}}}\n$$"
        },
        {
            "introduction": "理论的正确性最终需要在计算中得到验证。本编程练习旨在揭示数值通量设计的微妙之处：即使是看似微小的错误选择，也可能导致灾难性的非物理结果。你将通过编写代码来对比两种处理电介质界面的通量方案，并亲眼见证不恰当的通量（如直接平均电场 $\\boldsymbol{E}$）如何在界面上催生出虚假的电荷，从而违背了离散形式的高斯定律 ()。",
            "id": "3375389",
            "problem": "考虑一个非均匀各向同性介质中的无源静态麦克斯韦方程组，其中电位移矢量和电场通过 $\\mathbf{D} = \\epsilon(\\mathbf{x}) \\mathbf{E}$ 相关联，且在没有自由电荷的情况下，高斯定律为 $\\nabla \\cdot \\mathbf{D} = 0$。对于一个二维方形区域 $[0,1] \\times [0,1]$，我们通过引入一个标量流函数 $\\psi(x,y)$ 并定义 $\\mathbf{D}(x,y) = \\nabla \\times \\left( \\psi(x,y) \\hat{\\mathbf{z}} \\right) = \\left( \\partial_y \\psi(x,y), -\\partial_x \\psi(x,y) \\right)$ 来构造一个无散的电位移矢量，这能精确地确保 $\\nabla \\cdot \\mathbf{D} = 0$。此时电场为 $\\mathbf{E}(x,y) = \\mathbf{D}(x,y) / \\epsilon(x,y)$。当 $\\epsilon$ 不连续时，$\\mathbf{E}$ 通常会发生跳变，而 $\\mathbf{D}$ 在没有自由电荷的情况下保持连续。\n\n我们将对比测试两种离散化方法，这两种方法分别模拟了间断 Galerkin (DG) 和 Nédélec (基于边的 $H(\\mathrm{curl})$-conforming) 格式，主要关注它们在介电常数 $\\epsilon$ 存在急剧跳变的界面上离散地执行高斯定律的能力。这两种离散化方法定义在一个具有周期性边界条件的均匀 $N_x \\times N_y$ 单元网格上：\n\n1. 一种类 DG 通量，使用电场平均（在电介质界面上执行高斯定律是错误的）：在每个面上，通过对相邻单元中心的值进行平均来定义面上的电场，即 $\\mathbf{E}_f = \\tfrac{1}{2}\\left( \\mathbf{E}_L + \\mathbf{E}_R \\right)$，并通过算术平均来定义面上的介电常数，即 $\\epsilon_f = \\tfrac{1}{2}\\left( \\epsilon_L + \\epsilon_R \\right)$。然后，面法向通量为 $D_{n,f}^{\\mathrm{DG}} = \\epsilon_f \\, (\\mathbf{E}_f \\cdot \\mathbf{n}_f)$。这种选择倾向于强制电场的连续性，而不是 $\\mathbf{D}$ 的法向分量的连续性，这会在 $\\epsilon$ 发生跳变的材料界面上产生伪离散电荷。\n\n2. 一种类 Nédélec 边通量，使用电通量平均（与在无源介质中强制 $\\mathbf{D}$ 法向分量连续性相一致）：在每个面上，通过对相邻的法向通量进行平均来定义面法向通量，即 $D_{n,f}^{\\mathrm{NED}} = \\tfrac{1}{2}\\left( \\mathbf{D}_L \\cdot \\mathbf{n}_f + \\mathbf{D}_R \\cdot \\mathbf{n}_f \\right)$。这种选择遵循了 $\\mathbf{D}$ 的法向分量在电介质界面上的物理连续性，并能更好地在离散层面保持 $\\nabla \\cdot \\mathbf{D} = 0$。\n\n给定面法向通量 $D_{n,f}$，每个单元中的离散散度残差（用于衡量对高斯定律的违背程度）由有限体积平衡定义为\n$$\nr_{i,j} = \\frac{D_{x,\\mathrm{right}} - D_{x,\\mathrm{left}}}{\\Delta x} + \\frac{D_{y,\\mathrm{top}} - D_{y,\\mathrm{bottom}}}{\\Delta y},\n$$\n其中 $\\Delta x = 1/N_x$ 和 $\\Delta y = 1/N_y$，$D_{x,\\mathrm{right}}$ 表示通过右侧面（外法线为 $\\mathbf{n} = (1,0)$）的通量，$D_{x,\\mathrm{left}}$ 表示通过左侧面（外法线为 $\\mathbf{n} = (-1,0)$）的通量，$y$ 方向的面也类似。全局误差度量是 $L^2$ 范数\n$$\n\\| \\nabla \\cdot \\mathbf{D} \\|_{L^2} \\approx \\left( \\sum_{i=1}^{N_x} \\sum_{j=1}^{N_y} r_{i,j}^2 \\, \\Delta x \\Delta y \\right)^{1/2},\n$$\n分别对类 DG 和类 Nédélec 通量进行计算。\n\n取流函数\n$$\n\\psi(x,y) = \\sin(2\\pi x)\\sin(2\\pi y),\n$$\n于是\n$$\n\\partial_x \\psi = 2\\pi \\cos(2\\pi x)\\sin(2\\pi y), \\quad \\partial_y \\psi = 2\\pi \\sin(2\\pi x)\\cos(2\\pi y),\n$$\n因此\n$$\n\\mathbf{D}(x,y) = \\left(2\\pi \\sin(2\\pi x)\\cos(2\\pi y), \\; -2\\pi \\cos(2\\pi x)\\sin(2\\pi y)\\right).\n$$\n令介电常数为分段常数，在位于 $x = s$ 的垂直界面处有急剧跳变，\n$$\n\\epsilon(x,y) = \n\\begin{cases}\n\\epsilon_{\\mathrm{L}} & \\text{if } x < s, \\\\\n\\epsilon_{\\mathrm{R}} & \\text{if } x \\ge s,\n\\end{cases}\n$$\n其中 $\\epsilon_{\\mathrm{L}} > 0$ 且 $\\epsilon_{\\mathrm{R}} > 0$。\n\n你的任务是编写一个程序，该程序：\n- 构建网格，在单元中心计算 $\\mathbf{D}$ 和 $\\epsilon$，并计算 $\\mathbf{E} = \\mathbf{D}/\\epsilon$。\n- 对类 DG 和类 Nédélec 两种通量定义，使用双向周期性边界条件，计算离散散度残差 $r_{i,j}$ 和全局 $L^2$ 范数。\n- 对每个测试用例，报告范数对 $\\left( \\| \\nabla \\cdot \\mathbf{D} \\|_{L^2}^{\\mathrm{DG}}, \\| \\nabla \\cdot \\mathbf{D} \\|_{L^2}^{\\mathrm{NED}} \\right)$，其结果为无量纲量。\n\n测试套件：\n- 情况1（对齐界面，中等对比度）：$N_x = 50$, $N_y = 50$, $\\epsilon_{\\mathrm{L}} = 1.0$, $\\epsilon_{\\mathrm{R}} = 10.0$, $s = 0.5$。\n- 情况2（未对齐界面，中等对比度）：$N_x = 51$, $N_y = 51$, $\\epsilon_{\\mathrm{L}} = 1.0$, $\\epsilon_{\\mathrm{R}} = 10.0$, $s = 0.47$。\n- 情况3（对齐界面，极端对比度）：$N_x = 50$, $N_y = 50$, $\\epsilon_{\\mathrm{L}} = 1.0$, $\\epsilon_{\\mathrm{R}} = 1000.0$, $s = 0.5$。\n- 情况4（对齐界面，无对比度）：$N_x = 50$, $N_y = 50$, $\\epsilon_{\\mathrm{L}} = 1.0$, $\\epsilon_{\\mathrm{R}} = 1.0$, $s = 0.5$。\n\n最终输出格式：\n你的程序应生成单行输出，其中包含一个由方括号括起来的、逗号分隔的八个浮点数列表，顺序为：情况1的 $[\\| \\nabla \\cdot \\mathbf{D} \\|_{L^2}^{\\mathrm{DG}}, \\| \\nabla \\cdot \\mathbf{D} \\|_{L^2}^{\\mathrm{NED}}]$，随后是情况2、情况3和情况4的相同范数对。例如：“[dg1,ned1,dg2,ned2,dg3,ned3,dg4,ned4]”。所有值都是无量纲的，并应报告为不带单位的原始十进制数。",
            "solution": "我们从非均匀介质中的无源静态麦克斯韦方程组开始。电位移矢量与电场之间的基本关系是 $\\mathbf{D} = \\epsilon(\\mathbf{x}) \\mathbf{E}$，并且在没有自由电荷的情况下，高斯定律表述为 $\\nabla \\cdot \\mathbf{D} = 0$。为了构造一个无散的 $\\mathbf{D}$，我们使用一个标量流函数。定义\n$$\n\\psi(x,y) = \\sin(2\\pi x)\\sin(2\\pi y).\n$$\n那么矢量场\n$$\n\\mathbf{D}(x,y) = \\nabla \\times (\\psi \\hat{\\mathbf{z}}) = \\left(\\partial_y \\psi, -\\partial_x \\psi\\right)\n$$\n是精确无散的，因为任何旋度的散度都为零。具体来说，通过\n$$\n\\partial_x \\psi = 2\\pi \\cos(2\\pi x)\\sin(2\\pi y), \\quad \\partial_y \\psi = 2\\pi \\sin(2\\pi x)\\cos(2\\pi y),\n$$\n我们得到\n$$\n\\mathbf{D}(x,y) = \\left(2\\pi \\sin(2\\pi x)\\cos(2\\pi y), \\; -2\\pi \\cos(2\\pi x)\\sin(2\\pi y)\\right),\n$$\n事实上\n$$\n\\nabla \\cdot \\mathbf{D} = \\partial_x D_x + \\partial_y D_y = \\partial_x \\partial_y \\psi - \\partial_y \\partial_x \\psi = 0.\n$$\n由于 $\\mathbf{D}$ 是无散的，选择 $\\mathbf{E} = \\mathbf{D}/\\epsilon$ 在连续统中精确满足 $\\nabla \\cdot \\epsilon \\mathbf{E} = \\nabla \\cdot \\mathbf{D} = 0$。然而，如果介电常数 $\\epsilon$ 有急剧跳变，那么 $\\mathbf{E}$ 通常会在材料界面上不连续，而 $\\mathbf{D}$ 的法向分量在没有自由电荷的情况下保持连续。\n\n为了设计一个能够凸显伪电荷的基准测试，我们在覆盖单位正方形的均匀 $N_x \\times N_y$ 单元网格上进行离散化，并采用周期性边界条件。我们在单元中心计算 $\\mathbf{D}$ 和 $\\epsilon$ 的值，并在单元中心定义 $\\mathbf{E} = \\mathbf{D}/\\epsilon$。材料本构关系为\n$$\n\\epsilon(x,y) =\n\\begin{cases}\n\\epsilon_{\\mathrm{L}}, & x < s, \\\\\n\\epsilon_{\\mathrm{R}}, & x \\ge s,\n\\end{cases}\n$$\n代表在 $x = s$ 处的一个尖锐垂直界面。\n\n为了衡量高斯定律的离散执行情况，我们计算每个单元中的有限体积散度残差。对于一个宽度为 $\\Delta x = 1/N_x$、高度为 $\\Delta y = 1/N_y$ 的给定单元 $(i,j)$，其散度残差为\n$$\nr_{i,j} = \\frac{D_{x,\\mathrm{right}} - D_{x,\\mathrm{left}}}{\\Delta x} + \\frac{D_{y,\\mathrm{top}} - D_{y,\\mathrm{bottom}}}{\\Delta y},\n$$\n其中 $D_{x,\\mathrm{right}}$ 表示通过右侧面（外法线为 $\\mathbf{n} = (1,0)$）的法向通量，$D_{x,\\mathrm{left}}$ 表示通过左侧面（外法线为 $\\mathbf{n} = (-1,0)$）的通量，对于法线为 $(0,1)$ 和 $(0,-1)$ 的顶面和底面也类似。在周期性边界条件下，面的邻居会环绕整个计算域。全局误差度量是残差的 $L^2$ 范数，\n$$\n\\| \\nabla \\cdot \\mathbf{D} \\|_{L^2} \\approx \\left( \\sum_{i=1}^{N_x} \\sum_{j=1}^{N_y} r_{i,j}^2 \\, \\Delta x \\Delta y \\right)^{1/2}.\n$$\n\n我们定义两种面通量构造策略：\n\n1. 类 DG（电场平均）通量。面上的电场通过相邻单元的值平均得到，\n$$\n\\mathbf{E}_f = \\tfrac{1}{2}\\left(\\mathbf{E}_L + \\mathbf{E}_R\\right),\n$$\n面上的介电常数使用算术平均，\n$$\n\\epsilon_f = \\tfrac{1}{2}\\left(\\epsilon_L + \\epsilon_R\\right),\n$$\n面法向通量通过\n$$\nD_{n,f}^{\\mathrm{DG}} = \\epsilon_f \\, (\\mathbf{E}_f \\cdot \\mathbf{n}_f).\n$$\n计算。这种选择倾向于强制跨面的电场连续性，在电介质界面处，这会过度平滑 $\\mathbf{E}$，同时未能保持 $\\mathbf{D}$ 法向分量的连续性，从而产生伪离散散度（可解释为伪电荷）。\n\n2. 类 Nédélec（电通量平均）通量。面法向通量通过直接平均相邻单元 $\\mathbf{D}$ 的法向分量来计算，\n$$\nD_{n,f}^{\\mathrm{NED}} = \\tfrac{1}{2}\\left((\\mathbf{D}_L \\cdot \\mathbf{n}_f) + (\\mathbf{D}_R \\cdot \\mathbf{n}_f)\\right).\n$$\n这遵循了无源介质中 $\\mathbf{D}$ 法向分量连续的物理界面条件，从而在离散层面保持了 $\\nabla \\cdot \\mathbf{D} = 0$。\n\n算法步骤：\n- 构建单元中心网格 $(x_i, y_j)$，其中 $i=0,\\dots,N_x-1$ 且 $j=0,\\dots,N_y-1$，坐标为 $x_i = (i + \\tfrac{1}{2})/N_x$ 和 $y_j = (j + \\tfrac{1}{2})/N_y$。\n- 使用 $x_i$ 和界面 $s$ 通过分段定义计算 $\\epsilon_{i,j}$。\n- 在单元中心计算 $\\partial_x \\psi$ 和 $\\partial_y \\psi$，并设置 $\\mathbf{D}_{i,j} = \\left(\\partial_y \\psi, -\\partial_x \\psi\\right)$。\n- 计算 $\\mathbf{E}_{i,j} = \\mathbf{D}_{i,j}/\\epsilon_{i,j}$。\n- 对每个面，如前所述计算 $D_{n,f}^{\\mathrm{DG}}$ 和 $D_{n,f}^{\\mathrm{NED}}$。对于周期性边界，邻居索引以 $N_x$ 和 $N_y$ 为模进行环绕。\n- 使用有限体积散度公式，根据面法向通量组合得到 $r_{i,j}^{\\mathrm{DG}}$ 和 $r_{i,j}^{\\mathrm{NED}}$。\n- 计算全局范数 $\\| \\nabla \\cdot \\mathbf{D} \\|_{L^2}^{\\mathrm{DG}}$ 和 $\\| \\nabla \\cdot \\mathbf{D} \\|_{L^2}^{\\mathrm{NED}}$。\n\n伪电荷识别条件：\n- 当界面与单元面对齐且介电常数对比度为中等或较大时，类 DG 通量（使用算术介电常数平均的电场平均）会比类 Nédélec 通量产生更大的离散散度，因为它强制的是 $\\mathbf{E}$ 的连续性而非 $\\mathbf{D} \\cdot \\mathbf{n}$ 的连续性，这违背了物理界面条件。\n- 当界面与网格未对齐时（即界面落在单元内部），基于 $\\mathbf{E}$ 的不正确通量的影响会被加剧，离散散度范数会增大，尤其是在更高对比度下。\n- 当没有对比度时（$\\epsilon_{\\mathrm{L}} = \\epsilon_{\\mathrm{R}}$），两种方法重合，并产生最小的散度，因为对 $\\epsilon$ 进行平均没有影响，并且 $\\mathbf{D}$ 和 $\\mathbf{E}$ 之间是平滑相关的。\n\n测试套件包括四种情景：对齐与未对齐的界面、中等与极端的介电常数对比度，以及无对比度的基准情况。程序输出八个无量纲浮点数：每个情况对应的一对 $\\left( \\| \\nabla \\cdot \\mathbf{D} \\|_{L^2}^{\\mathrm{DG}}, \\| \\nabla \\cdot \\mathbf{D} \\|_{L^2}^{\\mathrm{NED}} \\right)$，并按指定格式单行输出。",
            "answer": "```python\nimport numpy as np\n\ndef compute_divergence_norms(Nx, Ny, eps_L, eps_R, s):\n    # Grid spacings\n    dx = 1.0 / Nx\n    dy = 1.0 / Ny\n\n    # Cell-center coordinates\n    x = (np.arange(Nx) + 0.5) * dx\n    y = (np.arange(Ny) + 0.5) * dy\n    X, Y = np.meshgrid(x, y, indexing='ij')\n\n    # Permittivity field with sharp interface at x = s\n    eps = np.where(X  s, eps_L, eps_R)\n\n    # Stream function derivatives and D field at cell centers\n    # psi = sin(2πx) sin(2πy)\n    # dpsi_dx = 2π cos(2πx) sin(2πy)\n    # dpsi_dy = 2π sin(2πx) cos(2πy)\n    two_pi = 2.0 * np.pi\n    dpsi_dx = two_pi * np.cos(two_pi * X) * np.sin(two_pi * Y)\n    dpsi_dy = two_pi * np.sin(two_pi * X) * np.cos(two_pi * Y)\n\n    # D = (dpsi_dy, -dpsi_dx)\n    D_x = dpsi_dy\n    D_y = -dpsi_dx\n\n    # E = D / eps\n    E_x = D_x / eps\n    E_y = D_y / eps\n\n    # Periodic neighbor indices\n    ip = (np.arange(Nx) + 1) % Nx  # i+1\n    im = (np.arange(Nx) - 1) % Nx  # i-1\n    jp = (np.arange(Ny) + 1) % Ny  # j+1\n    jm = (np.arange(Ny) - 1) % Ny  # j-1\n\n    # Precompute shifted arrays for neighbors\n    # Right neighbor in x-direction\n    D_x_right_neighbor = D_x[ip, :]\n    E_x_right_neighbor = E_x[ip, :]\n    eps_right_neighbor = eps[ip, :]\n    # Left neighbor in x-direction\n    D_x_left_neighbor = D_x[im, :]\n    E_x_left_neighbor = E_x[im, :]\n    eps_left_neighbor = eps[im, :]\n\n    # Top neighbor in y-direction\n    D_y_top_neighbor = D_y[:, jp]\n    E_y_top_neighbor = E_y[:, jp]\n    eps_top_neighbor = eps[:, jp]\n    # Bottom neighbor in y-direction\n    D_y_bottom_neighbor = D_y[:, jm]\n    E_y_bottom_neighbor = E_y[:, jm]\n    eps_bottom_neighbor = eps[:, jm]\n\n    # Face fluxes: DG-like (E-averaged with arithmetic epsilon) and Nedelec-like (D-averaged)\n\n    # X-faces: right face fluxes\n    # DG-like: epsilon_f * average(E_x)\n    E_x_face_right = 0.5 * (E_x + E_x_right_neighbor)\n    eps_face_right = 0.5 * (eps + eps_right_neighbor)\n    Dn_DG_right = eps_face_right * E_x_face_right\n\n    # Nedelec-like: average(D_x)\n    Dn_NED_right = 0.5 * (D_x + D_x_right_neighbor)\n\n    # X-faces: left face fluxes (or equivalently flux through right face of left neighbor)\n    E_x_face_left = 0.5 * (E_x + E_x_left_neighbor)\n    eps_face_left = 0.5 * (eps + eps_left_neighbor)\n    Dn_DG_left = eps_face_left * E_x_face_left\n    Dn_NED_left = 0.5 * (D_x + D_x_left_neighbor)\n\n    # Y-faces: top face fluxes\n    E_y_face_top = 0.5 * (E_y + E_y_top_neighbor)\n    eps_face_top = 0.5 * (eps + eps_top_neighbor)\n    Dn_DG_top = eps_face_top * E_y_face_top\n    Dn_NED_top = 0.5 * (D_y + D_y_top_neighbor)\n\n    # Y-faces: bottom face fluxes\n    E_y_face_bottom = 0.5 * (E_y + E_y_bottom_neighbor)\n    eps_face_bottom = 0.5 * (eps + eps_bottom_neighbor)\n    Dn_DG_bottom = eps_face_bottom * E_y_face_bottom\n    Dn_NED_bottom = 0.5 * (D_y + D_y_bottom_neighbor)\n\n    # Divergence residuals per cell\n    r_DG = (Dn_DG_right - Dn_DG_left) / dx + (Dn_DG_top - Dn_DG_bottom) / dy\n    r_NED = (Dn_NED_right - Dn_NED_left) / dx + (Dn_NED_top - Dn_NED_bottom) / dy\n\n    # Global L2 norms (dimensionless)\n    area = dx * dy\n    norm_DG = np.sqrt(np.sum(r_DG**2) * area)\n    norm_NED = np.sqrt(np.sum(r_NED**2) * area)\n\n    return float(norm_DG), float(norm_NED)\n\ndef solve():\n    # Define the test cases: (Nx, Ny, eps_L, eps_R, s)\n    test_cases = [\n        (50, 50, 1.0, 10.0, 0.5),   # Case 1: aligned interface, moderate contrast\n        (51, 51, 1.0, 10.0, 0.47),  # Case 2: misaligned interface, moderate contrast\n        (50, 50, 1.0, 1000.0, 0.5), # Case 3: aligned interface, extreme contrast\n        (50, 50, 1.0, 1.0, 0.5),    # Case 4: aligned interface, no contrast\n    ]\n\n    results = []\n    for Nx, Ny, eps_L, eps_R, s in test_cases:\n        norm_DG, norm_NED = compute_divergence_norms(Nx, Ny, eps_L, eps_R, s)\n        results.append(norm_DG)\n        results.append(norm_NED)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```"
        },
        {
            "introduction": "为了高效地求解多尺度问题，现代数值方法必须支持非协调网格。本练习将带你进入自适应网格加密（AMR）的核心技术之一：处理悬挂节点。你将实现一种“砂浆法”（mortar method），通过在不同尺寸的单元面之间建立精确的数学桥梁，来确保通量的守恒与稳定。完成这个练习意味着你向着构建能够将计算资源动态聚焦于关键区域的高性能DG求解器迈出了坚实的一步 ()。",
            "id": "3375457",
            "problem": "考虑麦克斯韦方程组在均匀、无量纲介质中的二维横电场（transverse electric）公式，该介质的介电常数和磁导率均为单位1。电磁场由电场分量 $E_x$ 和 $E_y$ 以及磁场分量 $H_z$ 组成。在这种情况下，麦克斯韦方程组为以下守恒律：\n$$\n\\frac{\\partial E_x}{\\partial t} = \\frac{\\partial H_z}{\\partial y}, \\qquad \\frac{\\partial E_y}{\\partial t} = -\\frac{\\partial H_z}{\\partial x}, \\qquad \\frac{\\partial H_z}{\\partial t} = \\frac{\\partial E_y}{\\partial x} - \\frac{\\partial E_x}{\\partial y}.\n$$\n我们关注一个与 $y$ 轴对齐的垂直界面 $\\Gamma$，不连续伽辽金（DG, Discontinuous Galerkin）方法通过该界面交换通量。沿着垂直界面，左侧单元的向外法线为 $n=(1,0)$，切线方向沿着 $y$ 轴。界面通量耦合了切向场 $E_y$ 和 $H_z$。假设一个渐变网格配置，带有一个非协调（悬挂节点）界面：左侧一个长度为 $L_c$ 的粗单元面与右侧两个总长度也为 $L_c$ 的细单元面相邻。具体来说，取 $L_c$ 为 $2$，右侧为两个堆叠的细单元面，每个长度为 $1$，通过子区间 $[0,1]$ 和 $[1,2]$ 覆盖了 $y$ 轴上的区间 $[0,2]$。\n\n从基本动力学方程和电磁能量守恒定律出发，推导跨越界面 $\\Gamma$ 的切向场的能量稳定上风（upwind）界面通量，用 $E_y$ 和 $H_z$ 的左右迹（trace）表示。解释为什么上风格式的选择会耗散跳跃能量，从而保证半离散DG格式的能量稳定性。然后，实现一种基于砂浆（mortar）的非协调界面处理方法：对于右侧的每个细分段，定义一个局部砂浆积分，评估限制在该分段上的左侧粗单元面迹，评估同一分段上的右侧细单元面迹，应用上风通量获得耗散被积函数，然后积分以产生净界面能量速率贡献。沿面使用正交多项式表示：将每个面上的迹表示为相应区间上的勒让德（Legendre）多项式级数，使用 $P_n(\\xi)$，其中 $\\xi\\in[-1,1]$ 通过 $y=\\frac{1}{2}\\left((b-a)\\xi+(b+a)\\right)$ 从物理分段 $[a,b]$ 映射而来。使用足够阶数的高斯-勒让德（Gauss-Legendre）求积法，通过精确的 $L^2$ 投影计算投影系数。\n\n你的程序必须：\n- 对于给定的解析面迹函数 $E_y(y)$ 和 $H_z(y)$，在指定的区间和阶数上，通过 $L^2$ 投影构建勒让德多项式系数，使用阶数至少为 $2p+2$ 的高斯-勒让德求积法，以精确积分至 $2p+1$ 次，其中 $p$ 是多项式阶数。\n- 在相同的局部砂浆求积节点上，评估限制在每个细分段上的左侧粗单元面迹 $(E_y^L,H_z^L)$ 和右侧细单元面迹 $(E_y^R,H_z^R)$。\n- 应用麦克斯韦方程组的能量稳定上风界面通量，计算相应的半离散界面能量速率密度。将此密度沿界面积分，以获得该界面的单个标量能量速率值。变量是无量纲的，因此能量速率应报告为无量纲实数。\n\n测试套件和参数规范：\n- 使用三个测试用例，所有用例中左侧粗单元面覆盖 $y\\in[0,2]$，右侧细单元面覆盖 $y\\in[0,1]$ 和 $y\\in[1,2]$。\n\n- 用例 1（理想情况，界面上精确匹配）：\n  - 粗单元面阶数 $p_c = 3$。定义全局粗单元面解析多项式 $f(y) = 0.5 + y - 0.75 y^2 + 0.25 y^3$。在 $[0,2]$ 上设置 $E_y^L(y)=f(y)$ 和 $H_z^L(y)=f(y)$，并投影到3阶勒让德基上。\n  - 两个细单元面分段的阶数均为 $p_f = 3$。在 $[0,1]$ 和 $[1,2]$ 上定义 $E_y^R(y)=f(y)$ 和 $H_z^R(y)=f(y)$，并在每个分段上投影到3阶勒让德基上。\n  - 预期的界面能量速率应精确为 $0$。\n\n- 用例 2（分段细单元面迹不匹配）：\n  - 粗单元面阶数 $p_c = 0$。在 $[0,2]$ 上定义 $E_y^L(y)=1$ 和 $H_z^L(y)=-1$，并投影到0阶勒让德基上。\n  - 细单元面分段 $[0,1]$：阶数 $p_f=2$，$E_y^R(y)=y$，$H_z^R(y)=-0.5\\, y$ 投影到 $[0,1]$ 上的2阶勒让德基上。\n  - 细单元面分段 $[1,2]$：阶数 $p_f=0$，$E_y^R(y)=0$，$H_z^R(y)=0$ 投影到 $[1,2]$ 上的0阶勒让德基上。\n  - 计算出的界面能量速率必须为非正值（能量稳定）。\n\n- 用例 3（阶数不匹配，一般多项式）：\n  - 粗单元面阶数 $p_c = 5$。在 $[0,2]$ 上定义 $E_y^L(y)=y^5 - 2 y^3 + 0.5 y$ 和 $H_z^L(y)=-y^4 + y$，并投影到5阶勒让德基上。\n  - 细单元面分段 $[0,1]$：阶数 $p_f=2$，$E_y^R(y)=y^2 - y$，$H_z^R(y)=y - 0.5$ 投影到2阶。\n  - 细单元面分段 $[1,2]$：阶数 $p_f=2$，$E_y^R(y)=1 - y$，$H_z^R(y)=0.25 y^2$ 投影到2阶。\n  - 计算出的界面能量速率必须为非正值（能量稳定）。\n\n最终输出格式：\n- 你的程序应生成单行输出，其中包含三个测试用例的结果，形式为方括号内的逗号分隔列表（例如，“[result1,result2,result3]”），其中每个结果是代表在 $y\\in[0,2]$ 上积分的无量纲界面能量速率值的单个浮点数。角度单位不适用。百分比不适用。不需要物理单位；报告无量纲值。",
            "solution": "所提出的问题是计算电磁学领域一个有效且定义明确的练习，特别关注不连续伽辽金（DG）方法在非协调网格上对麦克斯韦方程组的应用。该问题具有科学依据，客观，并包含获得唯一解所需的所有信息。我们将首先推导能量稳定数值通量的理论基础，然后描述非协调界面的计算实现。\n\n### 基于原理的推导和方法\n\n#### 1. 电磁能量守恒与DG公式\n\n能量分析的起点是坡印亭定理。对于给定的二维横电（TE）系统，其单位介电常数（$\\epsilon=1$）和单位磁导率（$\\mu=1$），电磁能量密度为 $\\mathcal{E} = \\frac{1}{2}(E_x^2 + E_y^2 + H_z^2)$。域 $\\Omega$ 内能量的变化率由下式给出：\n$$\n\\frac{d}{dt}\\int_\\Omega \\mathcal{E} \\, dV = \\int_\\Omega \\left(E_x \\frac{\\partial E_x}{\\partial t} + E_y \\frac{\\partial E_y}{\\partial t} + H_z \\frac{\\partial H_z}{\\partial t}\\right) dV.\n$$\n代入给定的麦克斯韦方程组：\n$$\n\\frac{d}{dt}\\int_\\Omega \\mathcal{E} \\, dV = \\int_\\Omega \\left(E_x \\frac{\\partial H_z}{\\partial y} - E_y \\frac{\\partial H_z}{\\partial x} + H_z \\left(\\frac{\\partial E_y}{\\partial x} - \\frac{\\partial E_x}{\\partial y}\\right)\\right) dV.\n$$\n被积函数可以被识别为坡印亭矢量 $\\mathbf{S} = \\mathbf{E} \\times \\mathbf{H} = (E_y H_z, -E_x H_z, 0)$ 的负散度。因此，\n$$\n\\frac{d}{dt}\\int_\\Omega \\mathcal{E} \\, dV = -\\int_\\Omega \\nabla \\cdot \\mathbf{S} \\, dV = -\\oint_{\\partial\\Omega} \\mathbf{S} \\cdot \\mathbf{n} \\, dS,\n$$\n其中 $\\mathbf{n}$ 是边界 $\\partial\\Omega$ 的向外法线。此方程表明，体积内的能量变化由穿过其边界的能量通量平衡。\n\n在DG方法中，域被划分为单元 $K$。在每个单元内，能量平衡成立。对所有单元求和，总能量变化率是所有单元边界贡献的总和。对于两个单元 $K^L$（左）和 $K^R$（右）之间的内部面 $\\Gamma$，其向外法线分别为 $\\mathbf{n}^L$ 和 $\\mathbf{n}^R = -\\mathbf{n}^L$，对能量速率的贡献是数值能量通量跳跃在面上的积分。为保证稳定性，此贡献必须为非正，表示能量耗散。\n$$\n\\frac{dE_{total}}{dt} = -\\sum_{\\text{faces } \\Gamma} \\int_\\Gamma \\left( (\\mathbf{S} \\cdot \\mathbf{n}^L)^* + (\\mathbf{S} \\cdot \\mathbf{n}^R)^* \\right) dS \\le 0\n$$\n数值通量，用星号（$*$）表示，必须仔细选择以确保满足此条件。\n\n#### 2. 能量稳定的上风通量\n\n通量的选择基于系统的特征分解。对于法线为 $\\mathbf{n} = (1,0)$ 的垂直界面，系统的相关部分是 $x$ 方向的通量。该系统可以写成 $\\partial_t \\mathbf{q} + \\mathbf{A}_x \\partial_x \\mathbf{q} + \\dots = 0$，其中 $\\mathbf{q} = (E_x, E_y, H_z)^T$，通量雅可比矩阵为\n$$\n\\mathbf{A}_x = \\begin{pmatrix} 0  0  0 \\\\ 0  0  -1 \\\\ 0  -1  0 \\end{pmatrix}.\n$$\n$\\mathbf{A}_x$ 的特征值为 $\\lambda_1 = 0$, $\\lambda_2 = -1$ 和 $\\lambda_3 = 1$，对应于以不同速度传播的波。切向场 $E_y$ 和 $H_z$ 是耦合的，并与非零速度特征值相关。相应的左特征向量定义了沿 $x$ 方向传播的特征变量：\n- $w_1 = E_x$ (静止, $\\lambda=0$)\n- $w_2 = E_y+H_z$ (向左传播, $\\lambda=-1$)\n- $w_3 = H_z-E_y$ (向右传播, $\\lambda=1$)\n\n上风通量是通过从每个特征变量传播出来的单元中选择其值来构造的。在界面处，对于向左传播的波（从右到左），我们使用右侧的状态。对于向右传播的波，我们使用左侧的状态。这导致了特征变量的以下数值通量：\n$$\n(E_y+H_z)^* = E_y^R+H_z^R\n$$\n$$\n(H_z-E_y)^* = H_z^L-E_y^L\n$$\n求解该系统以获得场变量的数值通量 $\\hat{E}_y$ 和 $\\hat{H}_z$，我们得到：\n$$\n\\hat{E}_y = \\frac{1}{2}\\left((E_y^L+E_y^R) - (H_z^L-H_z^R)\\right) = \\{E_y\\} - \\frac{1}{2Z_0}[[\\mathbf{n} \\times \\mathbf{H}]]\n$$\n$$\n\\hat{H}_z = \\frac{1}{2}\\left((H_z^L+H_z^R) - (E_y^L-E_y^R)\\right) = \\{H_z\\} + \\frac{1}{2Z_0}[[\\mathbf{n} \\times \\mathbf{E}]]\n$$\n其中 $\\{u\\} = (u^L+u^R)/2$ 是平均值， $[[u]] = u^L - u^R$ 是跳跃，阻抗 $Z_0=\\sqrt{\\mu/\\epsilon}=1$。\n\n当这些场的上风通量用于DG弱形式时，产生的跨界面能量变化率是纯耗散的。能量速率密度，即界面能量速率贡献的被积函数，由下式给出：\n$$\nd(y) = -\\frac{1}{2} \\left( \\frac{1}{Z_0} (E_y^L - E_y^R)^2 + Z_0 (H_z^L - H_z^R)^2 \\right)\n$$\n当 $Z_0=1$时，简化为：\n$$\nd(y) = -\\frac{1}{2} \\left( (E_y^L(y) - E_y^R(y))^2 + (H_z^L(y) - H_z^R(y))^2 \\right)\n$$\n此量显然是非正的。当且仅当切向场在界面上连续时（$[[E_y]] = 0$ 和 $[[H_z]] = 0$），它才为零。这一性质保证了半离散化不会在单元界面上虚假地产生能量，从而形成一个鲁棒且稳定的数值格式。来自界面的总能量速率贡献是此密度的积分：$Q = \\int_\\Gamma d(y) dy$。\n\n#### 3. 基于砂浆（Mortar）的非协调界面\n\n问题描述了一个非协调网格，其中左侧的一个粗糙面，$y \\in [0,2]$，与右侧的两个精细面，$\\gamma_1 = y \\in [0,1]$ 和 $\\gamma_2 = y \\in [1,2]$ 相邻。砂浆法通过将整个界面上的积分分解为在更细的“砂浆”分段上的积分之和来处理这个问题。\n$$\nQ = \\int_0^2 d(y) dy = \\int_0^1 d(y) dy + \\int_1^2 d(y) dy\n$$\n在每个砂浆分段 $\\gamma_i$ 上，跳跃是在粗糙面解的迹（限制在$\\gamma_i$上）与该段上的精细面解之间计算的。例如，在 $\\gamma_1=[0,1]$ 上：\n$$\nQ_1 = \\int_0^1 -\\frac{1}{2} \\left( (E_y^L(y) - E_y^{R1}(y))^2 + (H_z^L(y) - H_z^{R1}(y))^2 \\right) dy\n$$\n在 $\\gamma_2 = [1,2]$ 上有类似的表达式 $Q_2$。总能量速率为 $Q = Q_1 + Q_2$。\n\n#### 4. 数值实现\n\n- **多项式表示与投影**：面上的迹被表示为给定阶数 $p$ 的勒让德多项式级数。对于区间 $[a,b]$ 上的函数 $f(y)$，我们寻找逼近 $f_h(y) = \\sum_{k=0}^p c_k P_k(\\xi)$ 的系数 $c_k$，其中 $\\xi=\\frac{2y-(a+b)}{b-a}$。系数通过 $L^2$ 投影确定，这需要计算形如 $\\int_a^b f(y) P_k(\\xi(y)) dy$ 的积分。这些积分使用高阶高斯-勒让德求积法则进行数值计算，如规范所述。\n\n- **能量速率积分**：总能量速率 $Q$ 是通过在每个砂浆分段上对耗散密度 $d(y)$ 进行数值积分来计算的。由于场迹是最高阶为 $p_{\\max} = \\max(p_c, p_f)$ 的多项式，被积函数 $d(y)$ 是一个最高阶为 $2p_{\\max}$ 的多项式。一个具有 $p_{\\max}+1$ 个点的高斯-勒让德求积法则足以精确地积分此式。我们在每个砂浆分段上根据该分段上涉及的迹的最大多项式阶数选择求积法则。我们在求积节点上评估左右迹的多项式表示，计算耗散密度，并进行加权求和以获得该分段的积分能量速率。",
            "answer": "```python\nimport numpy as np\nfrom numpy.polynomial.legendre import legval, legfit, leggauss\n\ndef project_on_legendre(func, interval, p):\n    \"\"\"\n    Projects an analytic function onto the Legendre basis of degree p on a given interval.\n\n    Args:\n        func (callable): The analytic function to project.\n        interval (tuple): The interval [a, b] for the projection.\n        p (int): The degree of the polynomial basis.\n\n    Returns:\n        numpy.ndarray: The array of Legendre coefficients.\n    \"\"\"\n    a, b = interval\n    # Use a high-order Gauss-Legendre quadrature for an accurate L2 projection.\n    # The problem specifies a rule of order at least 2p+2, which means it should integrate\n    # polynomials up to degree 2p+1 exactly. This requires at least p+1 points.\n    # We use p+10 points for high accuracy, well above the minimum requirement.\n    n_points = p + 10\n    xi_nodes, weights = leggauss(n_points)\n\n    # Map nodes from [-1, 1] to [a, b]\n    y_nodes = 0.5 * (b - a) * xi_nodes + 0.5 * (a + b)\n\n    # Evaluate the function at these nodes\n    y_values = func(y_nodes)\n\n    # Use weighted least squares fit, which is equivalent to L2 projection\n    # when the nodes and weights are from a Gaussian quadrature.\n    # legfit minimizes sum(w[i] * (y[i] - p(x[i]))**2).\n    # For L2 proj, we want to minimize integral((f-p)^2), which is approx\n    # sum(w_quad * (f-p)^2). So the weights for legfit should be the quad weights.\n    coeffs = legfit(xi_nodes, y_values, p, w=weights)\n    return coeffs\n\ndef evaluate_poly(coeffs, interval, y_points):\n    \"\"\"\n    Evaluates a Legendre series at given points.\n\n    Args:\n        coeffs (numpy.ndarray): The Legendre coefficients.\n        interval (tuple): The original interval [a, b] of the polynomial basis.\n        y_points (numpy.ndarray): Points at which to evaluate the polynomial.\n\n    Returns:\n        numpy.ndarray: The evaluated polynomial values.\n    \"\"\"\n    a, b = interval\n    # Map evaluation points from [a, b] to the reference interval [-1, 1]\n    xi_points = (2.0 * y_points - (a + b)) / (b - a)\n    return legval(xi_points, coeffs)\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for all test cases.\n    \"\"\"\n\n    test_cases = [\n        # Case 1: Happy path, continuous fields\n        {\n            \"p_c\": 3,\n            \"L_funcs\": {\"E\": lambda y: 0.5 + y - 0.75 * y**2 + 0.25 * y**3,\n                        \"H\": lambda y: 0.5 + y - 0.75 * y**2 + 0.25 * y**3},\n            \"fine_faces\": [\n                {\"p_f\": 3, \"interval\": [0.0, 1.0],\n                 \"R_funcs\": {\"E\": lambda y: 0.5 + y - 0.75 * y**2 + 0.25 * y**3,\n                             \"H\": lambda y: 0.5 + y - 0.75 * y**2 + 0.25 * y**3}},\n                {\"p_f\": 3, \"interval\": [1.0, 2.0],\n                 \"R_funcs\": {\"E\": lambda y: 0.5 + y - 0.75 * y**2 + 0.25 * y**3,\n                             \"H\": lambda y: 0.5 + y - 0.75 * y**2 + 0.25 * y**3}},\n            ]\n        },\n        # Case 2: Mismatch with piecewise constants/linear traces\n        {\n            \"p_c\": 0,\n            \"L_funcs\": {\"E\": lambda y: np.ones_like(y), \"H\": lambda y: -np.ones_like(y)},\n            \"fine_faces\": [\n                {\"p_f\": 2, \"interval\": [0.0, 1.0],\n                 \"R_funcs\": {\"E\": lambda y: y, \"H\": lambda y: -0.5 * y}},\n                {\"p_f\": 0, \"interval\": [1.0, 2.0],\n                 \"R_funcs\": {\"E\": lambda y: np.zeros_like(y), \"H\": lambda y: np.zeros_like(y)}},\n            ]\n        },\n        # Case 3: Degree mismatch, general polynomials\n        {\n            \"p_c\": 5,\n            \"L_funcs\": {\"E\": lambda y: y**5 - 2*y**3 + 0.5*y, \"H\": lambda y: -y**4 + y},\n            \"fine_faces\": [\n                {\"p_f\": 2, \"interval\": [0.0, 1.0],\n                 \"R_funcs\": {\"E\": lambda y: y**2 - y, \"H\": lambda y: y - 0.5}},\n                {\"p_f\": 2, \"interval\": [1.0, 2.0],\n                 \"R_funcs\": {\"E\": lambda y: 1 - y, \"H\": lambda y: 0.25 * y**2}},\n            ]\n        },\n    ]\n\n    results = []\n    \n    coarse_interval = [0.0, 2.0]\n\n    for case in test_cases:\n        # Project coarse face traces\n        p_c = case[\"p_c\"]\n        coeffs_EL = project_on_legendre(case[\"L_funcs\"][\"E\"], coarse_interval, p_c)\n        coeffs_HL = project_on_legendre(case[\"L_funcs\"][\"H\"], coarse_interval, p_c)\n\n        total_energy_rate = 0.0\n\n        for fine_face in case[\"fine_faces\"]:\n            p_f = fine_face[\"p_f\"]\n            fine_interval = fine_face[\"interval\"]\n            a_f, b_f = fine_interval\n\n            # Project fine face traces\n            coeffs_ER = project_on_legendre(fine_face[\"R_funcs\"][\"E\"], fine_interval, p_f)\n            coeffs_HR = project_on_legendre(fine_face[\"R_funcs\"][\"H\"], fine_interval, p_f)\n\n            # Setup quadrature for integrating the dissipation over this fine segment\n            p_max = max(p_c, p_f)\n            # Integrand degree is 2*p_max, requires p_max+1 GL points for exactness\n            n_quad_pts = p_max + 1\n            xi_quad, w_quad_ref = leggauss(n_quad_pts)\n            \n            # Map quadrature nodes and weights to the fine interval\n            y_quad = 0.5 * (b_f - a_f) * xi_quad + 0.5 * (a_f + b_f)\n            w_quad = 0.5 * (b_f - a_f) * w_quad_ref\n\n            # Evaluate all polynomial traces at the quadrature nodes\n            EL_vals = evaluate_poly(coeffs_EL, coarse_interval, y_quad)\n            HL_vals = evaluate_poly(coeffs_HL, coarse_interval, y_quad)\n            ER_vals = evaluate_poly(coeffs_ER, fine_interval, y_quad)\n            HR_vals = evaluate_poly(coeffs_HR, fine_interval, y_quad)\n\n            # Compute jump^2 terms at quadrature nodes\n            jump_E_sq = (EL_vals - ER_vals)**2\n            jump_H_sq = (HL_vals - HR_vals)**2\n\n            # Dissipation integrand at quadrature nodes (with Z=1)\n            dissipation_density = -0.5 * (jump_E_sq + jump_H_sq)\n\n            # Integrate over the fine segment and add to total\n            segment_energy_rate = np.sum(w_quad * dissipation_density)\n            total_energy_rate += segment_energy_rate\n\n        results.append(total_energy_rate)\n    \n    # Format the final output string\n    # For case 1, the result could be a very small float due to precision, so we round to 0\n    if abs(results[0])  1e-14:\n        results[0] = 0.0\n    \n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```"
        }
    ]
}