## 引言
在[计算地球物理学](@entry_id:747618)领域，精确模拟地震波在地球内部的传播路径是理解地球结构、勘探资源和评估地震灾害的基础。打靶法（Shooting Method）与弯曲法（Bending Method）是解决这一问题的两种最基本且功能强大的数值算法。它们的核心任务是求解连接已知震源和接收点的地震射线路径，这在数学上是一个典型的[两点边值问题](@entry_id:272616)。尽管目标相同，这两种方法却采用了截然不同的计算哲学，各自拥有独特的优势、局限性以及适用场景。

本文旨在为读者提供一个关于打靶法和弯曲法的全面而深入的指南。通过本文的学习，您将不仅理解这两种方法的基本工作原理，还将掌握它们在面对真实世界复杂性时的行为模式，并了解如何将它们应用于实际的科学与工程问题中。

为实现这一目标，文章将分为三个核心部分。在第一章 **“原理与机制”** 中，我们将从[费马原理](@entry_id:175608)这一第一性原理出发，系统地构建这两种方法的数学框架，深入剖析其算法核心，并探讨它们在处理多路径、焦散和阴影区等复杂情况时的内在机制。随后的 **“应用与[交叉](@entry_id:147634)学科联系”** 章节将视野从理论转向实践，展示这些算法如何在从全球地震学到[各向异性介质](@entry_id:187796)成像，乃至[医学超声](@entry_id:270486)等[交叉](@entry_id:147634)学科领域中发挥关键作用，并介绍[混合方法](@entry_id:163463)等先进计算策略。最后，在 **“动手实践”** 部分，我们通过一系列精心设计的计算练习，引导您亲手实现和分析这些算法的关键环节，将理论知识转化为实践技能。

## 原理与机制

本章深入探讨了用于求解地震射线路径的两种核心计算方法——打靶法和弯曲法——的根本原理与内在机制。作为前一章“引言”的延续，我们假定读者已对[射线理论](@entry_id:754096)在[地震学](@entry_id:203510)中的重要性有了初步认识。本章的目标是，从变分原理的第一性原理出发，系统地构建起这两种方法的数学框架，剖析其算法核心，并揭示它们在面对[复杂介质](@entry_id:164088)时所表现出的不同特性、优势与局限性。

### [射线理论](@entry_id:754096)的变分基础

[地震射线追踪](@entry_id:754644)的理论基石是 **[费马原理](@entry_id:175608)**（Fermat's Principle），或更准确地说，是 **[平稳时间原理](@entry_id:173756)**（Principle of Stationary Time）。该原理指出，在频率足够高的近似下（即几何光学的范畴），连接两个[固定点](@entry_id:156394)（例如，震源与接收点）的物理射线路径，是使总传播时间为 **平稳值** 的那条路径。此处的“平稳”是一个比“最小”更宽泛的概念，它包括了时间的局部最小值、局部最大值或[鞍点](@entry_id:142576)。

在一个各向同性、非均匀的介质中，波的局部速度是空间位置 $\mathbf{x}$ 的函数，记为 $c(\mathbf{x})$。我们定义 **慢度**（slowness）为速度的倒数，即 $s(\mathbf{x}) = 1/c(\mathbf{x})$。波沿着一条微元弧长 $d\ell$ 传播所需的时间 $dt$ 为 $dt = d\ell / c(\mathbf{x}) = s(\mathbf{x}) d\ell$。因此，沿任意一条连接点 $\mathbf{x}_A$ 和 $\mathbf{x}_B$ 的路径 $\gamma$ 的总传播时间，可以通过一个积分来计算。这个积分定义了一个 **传播时间泛函**（travel-time functional）$T[\gamma]$，它将一条路径映射为一个标量传播时间：

$$
T[\gamma] = \int_{\gamma} s(\mathbf{x}) \, d\ell
$$

[费马原理](@entry_id:175608)的数学表述就是，物理射线路径 $\gamma$ 使得该泛函的一阶变分为零，即 $\delta T[\gamma] = 0$。慢度场 $s(\mathbf{x})$ 在此扮演了关键角色，它为几何路径的每个微元赋予了物理权重（时间），从而决定了最终的物理路径 。从[变分法](@entry_id:163656)可知，满足此条件的路径 $\gamma$ 是该泛函对应的 **欧拉-拉格朗日方程**（Euler-Lagrange equations）的解。这些[二阶常微分方程](@entry_id:204212)构成了射线路径的[动力学方程](@entry_id:751029)，而打靶法和弯曲法正是求解这些方程的不同策略。

值得注意的是，[费马原理](@entry_id:175608)与 **惠更斯原理**（Huygens' Principle）在概念上截然不同。惠更斯原理是一种几何构建方法，而非变分原理。它描述了[波前](@entry_id:197956)的演化：[波前](@entry_id:197956)上的每一点都可被视为一个新的子波源，这些子波以当地速度 $c(\mathbf{x})$ 向外传播，新的[波前](@entry_id:197956)便是所有这些子波的包络面 。虽然两种原理都能描述波的传播，但[费马原理](@entry_id:175608)为射线路径提供了全局的、基于优化的定义，是计算射线路径的出发点。

这个变分框架具有高度的灵活性。我们可以构造不同的[拉格朗日量](@entry_id:174593) $L$ 来定义[作用量泛函](@entry_id:169216) $J[\gamma] = \int_{\gamma} L \, ds$，其平稳路径将优化不同的物理量。例如，如果我们选择一个与[声阻抗](@entry_id:267232)或能量密度相关的场 $n(\mathbf{x})$ 作为[拉格朗日量](@entry_id:174593)，那么得到的路径将不再是时间最短的路径，而是某个能量相关的作用量取平稳值的路径。在穿越两种介质的界面时，这个广义的变分原理会导出广义的斯涅耳定律：$n_1 \sin \theta_1 = n_2 \sin \theta_2$。只有当拉格朗日量 $L$ 与慢度 $v^{-1}$ 成正比时，例如 $n(\mathbf{x}) = k \cdot v^{-1}(\mathbf{x})$（其中 $k$ 为正常数），其平稳路径才是时间平稳路径，广义斯涅耳定律才会退化为标准[地震学](@entry_id:203510)中的形式 $\sin\theta_1 / v_1 = \sin\theta_2 / v_2$ 。

与[作用量泛函](@entry_id:169216)相伴的是 **程函方程**（Eikonal equation）。对于一个作用量场 $\Psi(\mathbf{x}) = \int_{\mathbf{x}_0}^{\mathbf{x}} L \, ds$，程函方程的一般形式为 $\|\nabla \Psi(\mathbf{x})\| = L(\mathbf{x})$。当 $L=v^{-1}$ 时，作用量场就是传播时间场 $T(\mathbf{x})$，我们得到标准的程函方程 $\|\nabla T(\mathbf{x})\| = s(\mathbf{x})$ 。

### 射线：一个[两点边值问题](@entry_id:272616)

在计算地球物理中，寻找连接已知震源 $\mathbf{x}_s$ 和接收点 $\mathbf{x}_r$ 之间射线路径的核心任务，被构建为一个 **[两点边值问题](@entry_id:272616)**（Two-Point Boundary Value Problem, BVP）。这意味着我们需要求解描述射线路径的[常微分方程](@entry_id:147024)（ODEs），同时满足路径在起点和终点的两个位置约束。这些射线方程可以有多种等价的参数化形式 。

**[弧长参数化](@entry_id:634139)**：
以弧长 $s$ 为参数，状态变量为位置 $\mathbf{x}(s)$ 和[单位切向量](@entry_id:262985) $\hat{\mathbf{t}}(s) = d\mathbf{x}/ds$。源于欧拉-拉格朗日方程的射线方程可写作：
$$
\frac{d}{ds}(n(\mathbf{x}) \hat{\mathbf{t}}) = \nabla n(\mathbf{x})
$$
其中 $n(\mathbf{x})$ 为慢度。边值条件为 $\mathbf{x}(0) = \mathbf{x}_s$ 和 $\mathbf{x}(s_f) = \mathbf{x}_r$，其中总[弧长](@entry_id:191173) $s_f$ 是未知的。

**传播时间[参数化](@entry_id:272587)**：
以传播时间 $t$ 为参数，[状态变量](@entry_id:138790)为 $\mathbf{x}(t)$ 和 $\hat{\mathbf{t}}(t)$。利用关系 $dt = n(\mathbf{x}) ds$，可将射线方程重写为关于 $t$ 的[一阶系统](@entry_id:147467)。边值条件为 $\mathbf{x}(0) = \mathbf{x}_s$ 和 $\mathbf{x}(T) = \mathbf{x}_r$，其中总传播时间 $T$ 是未知的。

**[哈密顿表述](@entry_id:276227)**：
这是一个尤为深刻和强大的表述。我们将问题置于相空间 $(\mathbf{x}, \mathbf{p})$ 中，其中 $\mathbf{p}$ 是[正则动量](@entry_id:155151)（或称射线慢度矢量）。一个恰当的[哈密顿量](@entry_id:172864)为 $H(\mathbf{x}, \mathbf{p}) = \frac{1}{2}(\|\mathbf{p}\|^2 - n(\mathbf{x})^2)$。物理射线存在于 $H=0$ 的能量壳层上，这等价于程函方程 $\|\mathbf{p}\|^2 = n(\mathbf{x})^2$。射线路径由哈密顿方程描述：
$$
\frac{d\mathbf{x}}{d\sigma} = \frac{\partial H}{\partial \mathbf{p}} = \mathbf{p}, \quad \frac{d\mathbf{p}}{d\sigma} = -\frac{\partial H}{\partial \mathbf{x}} = n(\mathbf{x})\nabla n(\mathbf{x})
$$
其中 $\sigma$ 是一个辅助参数。边值条件为 $\mathbf{x}(0) = \mathbf{x}_s$ 和 $\mathbf{x}(\sigma_f) = \mathbf{x}_r$。$H=0$ 的约束固定了初始动量的大小 $\|\mathbf{p}(0)\| = n(\mathbf{x}_s)$，但其初始方向是未知的。

针对这个[两点边值问题](@entry_id:272616)，打靶法和弯曲法提供了两种截然不同的求解哲学。

### 打靶法：初值问题的求解策略

**打靶法**（Shooting Method）将[两点边值问题](@entry_id:272616)转化为一个 **初值问题**（Initial Value Problem, IVP）的[求根](@entry_id:140351)过程。其核心思想是：

1.  在震源 $\mathbf{x}_s$ 处，猜测一个初始的射线出射方向（例如，一个二维平面中的[出射角](@entry_id:264341) $\alpha$，或三维空间中的两个角度）。这个初始方向以及已知的初始慢度大小 $n(\mathbf{x}_s)$ 唯一确定了初始慢度矢量 $\mathbf{p}(0)$。
2.  将 $(\mathbf{x}(0)=\mathbf{x}_s, \mathbf{p}(0))$作为初值，利用[数值积分方法](@entry_id:141406)（如[龙格-库塔法](@entry_id:140014)）求解射线方程（通常是哈密顿形式），得到一条完整的射线轨迹 $\mathbf{x}(\sigma)$。
3.  检查该轨迹在某个参数值 $\sigma_f$ 处是否击中接收点 $\mathbf{x}_r$。通常，第一次猜测会存在一个 **失靶量**（misfit vector），即射线终点与接收点之差 $\mathbf{g}(\alpha) = \mathbf{x}_{\text{end}}(\alpha) - \mathbf{x}_r$。
4.  我们的目标是调整初始参数 $\alpha$，使得失靶量 $\mathbf{g}(\alpha)$ 为零。这本质上是一个多元非线性方程[求根问题](@entry_id:174994)。

通常采用牛顿法来迭代更新初始参数。[牛顿法](@entry_id:140116)的更新公式为 $\alpha_{k+1} = \alpha_k - J^{-1}\mathbf{g}(\alpha_k)$，其中 $J = \partial\mathbf{g}/\partial\alpha$ 是失靶量对初始参数的雅可比矩阵，也称为 **敏感度矩阵**。计算这个雅可比矩阵是打靶法的关键。在很多实际情况中，积分的终点（例如总传播时间或总[弧长](@entry_id:191173)）本身也依赖于初始参数，这使得求导过程更为复杂。

例如，在一个二维问题中，我们寻找初始角 $\alpha$ 使得射线在到达接收点深度 $z_r$ 时，其水平位置恰好是 $x_r$。这意味着我们要解方程 $g(\alpha) \equiv x(\alpha, \tau_r(\alpha)) - x_r = 0$，其中积分终点 $\tau_r$ 是由隐式条件 $z(\alpha, \tau_r(\alpha)) = z_r$ 决定的。使用链式法则，我们可以推导出 $g(\alpha)$ 的[全导数](@entry_id:137587) ：
$$
\frac{dg}{d\alpha} = \frac{\partial x}{\partial \alpha} - \frac{\partial x}{\partial \tau} \frac{\partial z / \partial \alpha}{\partial z / \partial \tau}
$$
其中各项偏导数（射线位置对初始角和对路径参数的敏感度）都需要通过求解沿射线路径的[变分方程](@entry_id:635018)来获得。

打靶法的 **搜索空间** 维度很低（二维问题中为1维，三维问题中为2维），这使得在没有复杂性的情况下，可以使用高效的牛顿类方法实现快速的局部收敛 。

### 弯曲法：全局[变分方法](@entry_id:163656)

与打靶法相反，**弯曲法**（Bending Method）直接从[费马原理](@entry_id:175608)的[变分形式](@entry_id:166033)入手。它将连续的[路径优化](@entry_id:637933)问题离散化，从而将其转化为一个高维的[非线性优化](@entry_id:143978)问题。其核心思想是：

1.  用一系列离散的节点 $(\mathbf{x}_0, \mathbf{x}_1, \dots, \mathbf{x}_N)$ 来表示射线路径，其中首末节点固定为震源和接收点，即 $\mathbf{x}_0 = \mathbf{x}_s$ 和 $\mathbf{x}_N = \mathbf{x}_r$。
2.  将传播时间泛函 $T[\gamma]$ 离散化。例如，可以通过对连接相邻节点的线段上的慢度进行平均，并乘以线段长度，然后求和得到总时间的近似值：
    $$
    T_{\text{discrete}}(\{\mathbf{x}_k\}) = \sum_{k=0}^{N-1} \left( \frac{s(\mathbf{x}_k) + s(\mathbf{x}_{k+1})}{2} \right) \|\mathbf{x}_{k+1} - \mathbf{x}_k\|
    $$
3.  将离散的传播时间 $T_{\text{discrete}}$ 视为所有内部节点 $(\mathbf{x}_1, \dots, \mathbf{x}_{N-1})$ 坐标的函数。
4.  使用标准的[优化算法](@entry_id:147840)（如最速下降法、[共轭梯度法](@entry_id:143436)或拟牛顿法）来调整内部节点的位置，以最小化（或寻找平稳点）$T_{\text{discrete}}$。这个过程形象地表现为不断“弯曲”初始的猜测路径，使其逐渐趋向于一条物理射线路径。

弯曲法的 **搜索空间** 是所有内部节点坐标构成的空间，其维度为 $d \times (N-2)$（$d$ 为空间维度），这是一个高维空间 。这通常意味着[收敛速度](@entry_id:636873)可能比打靶法慢，且对优化算法的选择和参数（如步长）较为敏感。然而，由于它直接处理整个路径，因此在某些复杂情况下（如下文将讨论的焦散区）表现得比打靶法更为稳健。

### 射线追踪中的复杂性与失效模式

在均匀介质中，射线是直线，问题是平凡的。然而，在真实的非均匀地球介质中，射线追踪会遇到多种复杂情况，这些情况揭示了打靶法和弯曲法的深层特性与局限性。

#### A. 多路径与传播时间的非[凸性](@entry_id:138568)

在[非均匀介质](@entry_id:750241)中，连接两个[固定点](@entry_id:156394)的物理射线路径可能不止一条，这种现象称为 **多路径传播**（Multipathing）。例如，当声波遇到一个低速透镜体时，除了绕过透镜体的射线，还可能存在穿过透镜体中心而被聚焦的射线。

从变分原理的角度看，多路径现象的根本原因是 **传播时间泛函 $T[\gamma]$ 的非[凸性](@entry_id:138568)** 。一个凸泛函最多只有一个平稳点（即全局最小值）。而一个非凸泛函可以拥有多个平稳点，包括多个局部最小值和[鞍点](@entry_id:142576)，每一个都对应一条物理上可能的射线路径。介质的非均匀性（特别是低速异常）可以引入正的几何曲率（见下文），导致泛函景观变得复杂，从而产生多路径。

反之，如果介质的速度结构能保证相应的黎曼度量（见后文）具有[非正曲率](@entry_id:203441)，那么根据 **Cartan-Hadamard 定理**，连接任意两点的[测地线](@entry_id:269969)（射线）是唯一的，此时不会出现多路径现象 。

多路径对计算方法提出了挑战。打靶法每次迭代只能逼近一个解，最终找到哪条路径取决于初始猜测的角度。要找到所有路径，需要从多个不同的初始角度进行搜索 。弯曲法同样只能收敛到其初始猜测路径所在的吸引盆内的局部最小值，也无法保证一次性找到所有路径或全局最短时间路径 。

#### B. 焦散、共轭点与打靶法的失效

**焦散**（Caustic）是射线族的一个包络面，是射线能量高度集中的区域。从几何上看，它是相邻射线相交汇形成的面。一个更精确的概念是 **[共轭点](@entry_id:160335)**（Conjugate Point）。对于从点 $\mathbf{x}_s$ 出发的一族射线，如果沿某条中心射线的路径上存在一点 $\mathbf{x}_c$，使得从 $\mathbf{x}_s$ 出发的无限邻近的射线在此点重新聚焦，那么 $\mathbf{x}_c$ 就被称为 $\mathbf{x}_s$ 的一个[共轭点](@entry_id:160335)。

在数学上，共轭点与打靶法中的敏感度矩阵直接相关。回忆一下，打靶法的牛顿更新依赖于[雅可比矩阵](@entry_id:264467) $J(T) = \partial \mathbf{X} / \partial \boldsymbol{\theta}$，它描述了射线终点位置 $\mathbf{X}$ 对初始发射角 $\boldsymbol{\theta}$ 的敏感度。[共轭点](@entry_id:160335)的出现，恰恰对应于这个 **雅可比[矩阵的[行列](@entry_id:148198)式](@entry_id:142978)为零**，即 $\det(J) = 0$ 。

这个奇异性有三个紧密相关的物理和计算后果：
1.  **[几何光学](@entry_id:175509)振幅发散**：在[WKB近似](@entry_id:756741)下，射线振幅 $A$ 与几何[扩散](@entry_id:141445)因子 $\mathcal{J}$ 的平方根成反比，而 $\mathcal{J}$ 正比于 $|\det(J)|$。因此，在焦散处，$\det(J) \to 0$，导致理论上的几何光学振幅趋于无穷大，预示着简单[射线理论](@entry_id:754096)的失效。
2.  **打靶法牛顿迭代失效**：牛顿法需要计算 $J^{-1}$。当 $\det(J) \to 0$ 时，矩阵 $J$ 变得奇[异或](@entry_id:172120)极端 **病态**（ill-conditioned），其[逆矩阵](@entry_id:140380)不存在或其元素变得极大。这导致牛顿更新步骤要么无法计算，要么产生一个巨大且无意义的步长，使得算法发散或跳到完全不相关的解上 。
3.  **[鲁棒算法](@entry_id:145345)的应对**：在实践中，当接收点位于焦散区附近时，为避免上述问题，需要采用更鲁棒的算法。**信赖域**（Trust-Region）或 **Levenberg-Marquardt** (LM) 算法通过引入一个阻尼项 $\lambda$ 来正则化牛顿系统，求解 $(\mathbf{J}^{\top} \mathbf{J} + \lambda \mathbf{I})\delta \boldsymbol{\theta} = -\mathbf{J}^{\top}\mathbf{r}$。当检测到 $J$ 病态时（[线性模型](@entry_id:178302)预测效果差），算法会自动 **增大阻尼 $\lambda$ 并缩小信赖域半径**。这会使更新步骤变得更小，并且其方向会从不稳定的牛顿方向偏向更稳健的最速下降方向，从而在恶劣的条件下艰难前行 。

#### C. 阴影区与[射线理论](@entry_id:754096)的局限

**阴影区**（Shadow Zone）是指介质中某些无法被特定射线族（如直达波）的几何射线所到达的区域。这与焦散区的“不稳定”问题不同，这是一个解的 **不存在性** 问题。典型的例子是地球模型中，一个足够强的低速核的存在，会使得从地表某点出发的直达[P波](@entry_id:178440)无法到达某个特定的震中距范围 。这是因为射线在进入低速核时会向外偏折，导致其出射点跳过一个角度区间。

对于阴影区内的接收点：
-   **打靶法** 注定会失败，因为它试图寻找一个存在的解，但这个解在几何[射线理论](@entry_id:754096)的框架内根本不存在。
-   **弯曲法** 同样会失败，因为它寻找的是连接源和接收点的传播时间泛函的平稳路径。如果这样的路径不存在，[优化算法](@entry_id:147840)自然也找不到解 。

要处理阴影区问题，必须超越传统的射线追踪方法。
-   **波前构造法**（Wavefront Construction Methods）：像 **[快速行进法](@entry_id:749232)**（Fast Marching Method, FMM）这类算法直接在网格上求解程函方程，计算出传播时间场 $T(\mathbf{x})$ 的全局首达时。这种方法不依赖于单一射线族，如果存在其他射线分支（如反射波）可以到达阴影区，FMM能够正确计算出其首达时。计算完成后，可以通过求解 $\nabla T$ 的梯度线来反演射线路径 。
-   **波动理论**：几何[射线理论](@entry_id:754096)是波动方程的[高频近似](@entry_id:750288)，它无法描述 **衍射**（Diffraction）现象。波的能量实际上可以衍射进入几何阴影区。要准确预测阴影区内的波场（通常很微弱），必须使用更高阶的[渐近理论](@entry_id:162631)（如一致[渐近理论](@entry_id:162631)）或直接数值求解完整的[波动方程](@entry_id:139839) 。

### 高级视角：作为[测地线](@entry_id:269969)的射线

最后，我们可以从[微分几何](@entry_id:145818)的视角来统一和深化对[射线理论](@entry_id:754096)的理解。[费马原理](@entry_id:175608)寻找的是最小化 $\int s(\mathbf{x}) d\ell$ 的路径。这个积分形式与黎曼几何中计算曲线长度的公式惊人地相似。

我们可以定义一个 **黎曼度规**（Riemannian metric） $g_{ij}(\mathbf{x})$，使得物理空间变成一个黎曼流形。如果我们选择一个与欧氏度规 $\delta_{ij}$ 共形的度规：
$$
g_{ij}(\mathbf{x}) = s(\mathbf{x})^2 \delta_{ij}
$$
那么，在这个黎曼空间中，一条曲线 $\gamma$ 的“长度”为：
$$
L_g[\gamma] = \int_{\gamma} \sqrt{g_{ij} dx^i dx^j} = \int_{\gamma} \sqrt{s(\mathbf{x})^2 \delta_{ij} \frac{dx^i}{d\sigma}\frac{dx^j}{d\sigma}} \, d\sigma = \int_{\gamma} s(\mathbf{x}) \|\dot{\mathbf{x}}\| \, d\sigma = T[\gamma]
$$
这表明，[地震波](@entry_id:164985)的 **传播时间等于该共形度规下的几何长度**。

因此，[费马原理](@entry_id:175608)等价于寻找这个黎曼空间中的 **[测地线](@entry_id:269969)**（Geodesic）——即局部最短的路径。地震射线就是这个由介质慢度场定义的弯曲空间中的“直线” 。

这个视角极为深刻：
-   **统一性**：它将[费马原理](@entry_id:175608)（物理）、射线方程（[微分方程](@entry_id:264184)）和哈密顿力学（相空间流）统一在[测地线](@entry_id:269969)（几何）这一核心概念之下。
-   **直观性**：射线的弯曲不再是某种神秘的作用力，而仅仅是空间本身因慢度场梯度而产生的 **[内蕴曲率](@entry_id:161701)**（intrinsic curvature）的体现。
-   **计算洞见**：它解释了为什么哈密顿射线追踪和测地线方程[积分器](@entry_id:261578)能产生相同的路径。[求解测地线](@entry_id:180752)方程（涉及[克里斯托费尔符号](@entry_id:159831) $\Gamma^i_{jk}$）是另一种（尽管不常用）实现射线追踪的方式 。

综上所述，打靶法和弯曲法虽然在计算策略上大相径庭，但它们都是求解同一个深刻物理原理——[费马原理](@entry_id:175608)——的数值实现。理解它们的机制、优缺点以及在面对多路径、焦散和阴影区等复杂现象时的行为，对于在计算地球物理中准确、鲁棒地模拟[地震波传播](@entry_id:165726)至关重要。