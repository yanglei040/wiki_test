{
    "hands_on_practices": [
        {
            "introduction": "在开发任何基于梯度的优化算法时，验证所计算梯度的正确性是至关重要的一步。泰勒测试，或称梯度检验，是验证数值梯度的黄金标准。本练习  将指导您完成这一关键实践，通过将伴随状态法计算的方向导数与有限差分近似进行比较，来验证梯度计算的准确性。掌握如何正确选择扰动步长 $\\epsilon$ 以平衡截断误差和舍入误差，是确保任何复杂反演代码可靠性的核心技能。",
            "id": "3574132",
            "problem": "考虑一个在带有吸收边界的有界域 $\\Omega \\subset \\mathbb{R}^3$ 中的各向同性声波传播模型。受时间强迫的压力场 $u(\\mathbf{x}, t)$ 满足以下形式的偏微分方程 (PDE)：\n$$\n\\partial_t^2 u(\\mathbf{x}, t) - \\nabla \\cdot \\left( c^2(\\mathbf{x}) \\nabla u(\\mathbf{x}, t) \\right) = s(\\mathbf{x}, t), \\quad \\mathbf{x} \\in \\Omega, \\; t \\in [0, T],\n$$\n并带有适当的初始和边界条件，其中 $c(\\mathbf{x})$ 是空间变化的波速，$s(\\mathbf{x}, t)$ 是已知源。令模型参数为 $m(\\mathbf{x}) = c^{-2}(\\mathbf{x})$，并用 $R$ 表示在接收点位置提取合成数据的采样算子，因此预测数据为 $d_{\\text{pred}}(t) = R u(m; t)$。一个标准的最小二乘失配泛函是\n$$\nJ(m) = \\frac{1}{2} \\sum_{r=1}^{N_r} \\int_0^T \\left( R u(m; t; \\mathbf{x}_r) - d_{\\text{obs}}(t; \\mathbf{x}_r) \\right)^2 \\, dt,\n$$\n其中 $d_{\\text{obs}}$ 是观测数据，$N_r$ 是接收点的数量。关于 $m$ 的梯度 $\\nabla J(m)$ 通过伴随状态法计算，并通过欧几里得内积 $\\langle \\nabla J(m), p \\rangle$ 定义了在 $m$ 点沿方向 $p$ 的方向导数。\n\n您希望通过有限差分方向导数检验来验证所计算梯度的正确性。定义中心有限差分量\n$$\n\\Delta(\\epsilon, p) = \\frac{J(m + \\epsilon p) - J(m - \\epsilon p)}{2 \\epsilon},\n$$\n并将其与伴随状态内积 $G(p) = \\langle \\nabla J(m), p \\rangle$ 进行比较。在 $J$ 光滑的条件下，当 $\\epsilon \\to 0$ 时，$\\Delta(\\epsilon, p)$ 收敛到 $G(p)$ 的预期收敛阶是二阶。\n\n在实际的计算地球物理学场景中，哪个选项正确地阐述了该检验，并指定了 $\\epsilon$ 和 $p$ 的选择，从而能够稳健地展示预期的二阶收敛性？\n\nA. 使用如上定义的中心有限差分 $\\Delta(\\epsilon, p)$，并将其与 $G(p) = \\langle \\nabla J(m), p \\rangle$ 进行比较。选择 $p$ 作为参数空间中的单位范数随机向量，即 $\\|p\\|_2 = 1$，其分量与 $m$ 的单位保持一致地缩放。在一个几何序列上扫描 $\\epsilon$，例如 $\\epsilon \\in \\{10^{-1}, 10^{-2}, \\dots, 10^{-8}\\}$，同时保持正向和伴随偏微分方程求解器的容差固定且足够小，以至于在该 $\\epsilon$ 范围内，离散化误差相对于截断误差 $\\mathcal{O}(\\epsilon^2)$ 可以忽略不计。绘制相对误差 $\\left| \\Delta(\\epsilon, p) - G(p) \\right| / \\left| G(p) \\right|$ 相对于 $\\epsilon$ 的曲线，并验证其斜率近似为 $2$（二次衰减），直到由于舍入误差出现平台期。或者，在平衡点 $\\epsilon \\approx \\sqrt{\\epsilon_{\\text{mach}}} \\, (1 + \\|m\\|_2) / \\|p\\|_2$ 附近选择 $\\epsilon$，以确保截断误差主导舍入误差，其中 $\\epsilon_{\\text{mach}}$ 是机器精度。\n\nB. 使用中心有限差分 $\\Delta(\\epsilon, p)$，但为了强调沿最速下降方向的灵敏度，设置 $p = \\nabla J(m)$ 并选择 $\\epsilon = 10^{-16}$（双精度机器精度），以确保扰动尽可能小。依赖最小的 $\\epsilon$ 来揭示最高阶的一致性，并将任何偏差视为求解器噪声。\n\nC. 用单边有限差分 $[J(m + \\epsilon p) - J(m)]/\\epsilon$ 替换中心有限差分，以避免加倍计算成本。选择一个适度小的 $\\epsilon$，例如 $\\epsilon = 10^{-6}$，并选择一个在接收点周围局部化的稀疏扰动 $p$ 以增强灵敏度。因为 $J$ 是光滑的，所以期望二阶收敛。\n\nD. 使用中心有限差分 $\\Delta(\\epsilon, p)$，但选择一个非归一化的 $p$，使其在波场能量低的区域具有大振幅，并固定 $\\epsilon = 10^{-3}$ 以在多次运行中保持一致。如果误差不随 $\\epsilon$ 减小，则增加正向求解器的时间步长以进行补偿，并依赖于 $\\Delta(\\epsilon, p)$ 和 $G(p)$ 之间的视觉一致性，而不是定量的误差缩放。",
            "solution": "用户希望对一个关于计算地球物理学中伴随状态梯度验证的问题陈述进行严格验证，然后提供详细的解决方案和选项评估。\n\n### 问题验证\n\n#### 步骤1：提取已知条件\n\n-   **偏微分方程模型**：一个在带有吸收边界的有界域 $\\Omega \\subset \\mathbb{R}^3$ 中的各向同性声波方程。\n    $$\n    \\partial_t^2 u(\\mathbf{x}, t) - \\nabla \\cdot \\left( c^2(\\mathbf{x}) \\nabla u(\\mathbf{x}, t) \\right) = s(\\mathbf{x}, t), \\quad \\mathbf{x} \\in \\Omega, \\; t \\in [0, T]\n    $$\n-   **场和参数**：\n    -   $u(\\mathbf{x}, t)$：受时间强迫的压力场。\n    -   $c(\\mathbf{x})$：空间变化的波速。\n    -   $s(\\mathbf{x}, t)$：已知源项。\n    -   $m(\\mathbf{x}) = c^{-2}(\\mathbf{x})$：模型参数。\n-   **数据和失配**：\n    -   $R$：接收点位置的采样算子。\n    -   $d_{\\text{pred}}(t) = R u(m; t)$：预测数据。\n    -   $d_{\\text{obs}}(t; \\mathbf{x}_r)$：在 $N_r$ 个接收点观测到的数据。\n    -   $J(m) = \\frac{1}{2} \\sum_{r=1}^{N_r} \\int_0^T \\left( R u(m; t; \\mathbf{x}_r) - d_{\\text{obs}}(t; \\mathbf{x}_r) \\right)^2 \\, dt$：最小二乘失配泛函。\n-   **梯度验证**：\n    -   $\\nabla J(m)$：失配泛函关于 $m$ 的梯度，通过伴随状态法计算。\n    -   $G(p) = \\langle \\nabla J(m), p \\rangle$：使用伴随状态梯度计算的在方向 $p$ 上的方向导数。\n    -   $\\Delta(\\epsilon, p) = \\frac{J(m + \\epsilon p) - J(m - \\epsilon p)}{2 \\epsilon}$：方向导数的中心有限差分近似。\n-   **预期**：在 $J$ 光滑的条件下，当 $\\epsilon \\to 0$ 时，$\\Delta(\\epsilon, p)$ 收敛到 $G(p)$ 的预期收敛阶是二阶。\n-   **问题**：确定哪个选项正确地阐述了验证检验，并指定了 $\\epsilon$ 和 $p$ 的选择，以便在实际场景中稳健地展示预期的二阶收敛性。\n\n#### 步骤2：使用提取的已知条件进行验证\n\n问题陈述在科学上是合理的、适定的和客观的。\n1.  **科学基础**：该设置是全波形反演 (FWI) 的标准表示，这是现代计算地震学和地球物理学的基石。声波方程、最小二乘泛函以及使用伴随状态法计算梯度都是基本且广泛使用的概念。通过有限差分检验（通常称为“泰勒检验”或“梯度检验”）来验证计算出的梯度，是数值优化和科学计算中一个关键且标准的程序。\n2.  **适定性**：该问题要求验证一个数值计算量的正确*程序*。这是一个关于数值分析方法论的问题。鉴于数值微分的既定原则，存在一个明确定义的最佳实践程序，这使得该问题是适定的。\n3.  **客观性**：该问题使用来自物理学和数值分析的精确数学符号和术语陈述。它不含主观或模糊的语言。\n\n问题陈述没有列出的缺陷。它并非不科学、不完整、矛盾或不适定。它描述了一个相关科学领域中现实且不平凡的任务。\n\n#### 步骤3：结论和行动\n\n问题陈述是**有效的**。开始解决问题。\n\n### 解题推导\n\n问题的核心是验证等式 $\\langle \\nabla J(m), p \\rangle = \\lim_{\\epsilon \\to 0} \\frac{J(m + \\epsilon p) - J(m - \\epsilon p)}{2 \\epsilon}$。这涉及到理解中心有限差分近似的行为。\n\n假设泛函 $J(m)$ 在 $m$ 附近足够光滑（至少三阶连续可微），我们可以对 $J(m + \\delta m)$ 使用泰勒级数展开，其中扰动为 $\\delta m = \\epsilon p$：\n$$\nJ(m + \\epsilon p) = J(m) + \\epsilon \\langle \\nabla J(m), p \\rangle + \\frac{\\epsilon^2}{2} \\langle p, H(m) p \\rangle + \\frac{\\epsilon^3}{6} T_m(p, p, p) + \\mathcal{O}(\\epsilon^4)\n$$\n其中 $H(m)$ 是海森算子，$T_m$ 是在 $m$ 点作用于 $p$ 的三阶导数张量。\n\n类似地，对于扰动 $-\\epsilon p$：\n$$\nJ(m - \\epsilon p) = J(m) - \\epsilon \\langle \\nabla J(m), p \\rangle + \\frac{\\epsilon^2}{2} \\langle p, H(m) p \\rangle - \\frac{\\epsilon^3}{6} T_m(p, p, p) + \\mathcal{O}(\\epsilon^4)\n$$\n\n将这些代入 $\\Delta(\\epsilon, p)$ 的定义中：\n$$\n\\Delta(\\epsilon, p) = \\frac{ (J(m) + \\epsilon \\langle \\nabla J(m), p \\rangle + \\dots) - (J(m) - \\epsilon \\langle \\nabla J(m), p \\rangle + \\dots) }{2 \\epsilon}\n$$\n$$\n\\Delta(\\epsilon, p) = \\frac{2 \\epsilon \\langle \\nabla J(m), p \\rangle + 2 \\frac{\\epsilon^3}{6} T_m(p, p, p) + \\mathcal{O}(\\epsilon^5)}{2 \\epsilon}\n$$\n$$\n\\Delta(\\epsilon, p) = \\langle \\nabla J(m), p \\rangle + \\frac{\\epsilon^2}{6} T_m(p, p, p) + \\mathcal{O}(\\epsilon^4)\n$$\n\n这证实了截断误差 $\\Delta(\\epsilon, p) - G(p)$ 是 $\\mathcal{O}(\\epsilon^2)$ 阶的，这意味着二阶收敛。\n\n在实际的计算环境中，我们还必须考虑另外两个误差来源：\n1.  **数值偏微分方程求解器误差**：$J(m)$ 的评估需要数值求解波动方程。这会引入一个离散化误差，比如 $\\delta_{\\text{PDE}}$。这个误差必须远小于我们试图测量的量，即 $\\delta_{\\text{PDE}} \\ll |\\Delta(\\epsilon,p) - G(p)|$。这要求使用足够精细的网格和足够小的时间步长（严格的求解器容差）。\n2.  **舍入误差**：数字计算机使用有限精度算术（例如，IEEE 754 双精度，机器精度 $\\epsilon_{\\text{mach}} \\approx 10^{-16}$）。当 $\\epsilon$ 非常小时，差值 $J(m+\\epsilon p) - J(m-\\epsilon p)$ 变成两个几乎相等的数相减，导致有效数字的灾难性损失。分子中的绝对误差大致与 $|J| \\epsilon_{\\text{mach}}$ 成正比。除以 $2\\epsilon$ 后，$\\Delta(\\epsilon, p)$ 中的舍入误差按 $\\mathcal{O}(\\epsilon_{\\text{mach}}/\\epsilon)$ 的比例缩放。\n\n总误差是这些效应的总和：$E(\\epsilon) \\approx C_1 \\epsilon^2 + C_2 \\frac{\\epsilon_{\\text{mach}}}{\\epsilon} + E_{\\text{PDE}}$。为了观察到 $\\mathcal{O}(\\epsilon^2)$ 收敛，我们需要 $E_{\\text{PDE}}$ 可忽略不计，并在一个截断误差 $C_1 \\epsilon^2$ 主导舍入误差 $C_2 \\frac{\\epsilon_{\\text{mach}}}{\\epsilon}$ 的 $\\epsilon$ 范围内操作。这导致在总误差对 $\\epsilon$ 的对数-对数图上出现一个特有的 V 形曲线。对于大的 $\\epsilon$，误差以斜率 2 下降。随着 $\\epsilon$ 变小，误差达到最小值，然后随着舍入误差的接管而以斜率 -1 增加。一个稳健的验证程序必须展示这种行为。\n\n关于扰动方向 $p$ 的选择：为确保验证不是由于特殊选择的方向（例如，海森算子零空间中的方向）而产生偏差或偶然成功，应选择一个通用的方向。从标准分布中抽样的随机向量是这种通用方向的绝佳选择。将其范数归一化是保证缩放一致性的良好实践。\n\n### 逐项分析选项\n\n**A. 使用如上定义的中心有限差分 $\\Delta(\\epsilon, p)$，并将其与 $G(p) = \\langle \\nabla J(m), p \\rangle$ 进行比较。选择 $p$ 作为参数空间中的单位范数随机向量，即 $\\|p\\|_2 = 1$，其分量与 $m$ 的单位保持一致地缩放。在一个几何序列上扫描 $\\epsilon$，例如 $\\epsilon \\in \\{10^{-1}, 10^{-2}, \\dots, 10^{-8}\\}$，同时保持正向和伴随偏微分方程求解器的容差固定且足够小，以至于在该 $\\epsilon$ 范围内，离散化误差相对于截断误差 $\\mathcal{O}(\\epsilon^2)$ 可以忽略不计。绘制相对误差 $\\left| \\Delta(\\epsilon, p) - G(p) \\right| / \\left| G(p) \\right|$ 相对于 $\\epsilon$ 的曲线，并验证其斜率近似为 $2$（二次衰减），直到由于舍入误差出现平台期。或者，在平衡点 $\\epsilon \\approx \\sqrt{\\epsilon_{\\text{mach}}} \\, (1 + \\|m\\|_2) / \\|p\\|_2$ 附近选择 $\\epsilon$，以确保截断误差主导舍入误差，其中 $\\epsilon_{\\text{mach}}$ 是机器精度。**\n这个选项描述了梯度检验的黄金标准。\n-   它正确地使用了二阶精度的中心差分。\n-   它正确地提倡使用随机、归一化的向量 $p$ 以确保通用性测试。\n-   它正确地建议在一个几何序列上扫描 $\\epsilon$ 以观察收敛率，这是最严谨的方法。\n-   它正确地指出了需要严格的求解器容差以使 PDE 离散化误差可忽略不计。\n-   它正确地描述了预期的结果：误差对 $\\epsilon$ 的对数-对数图显示出大约为 2 的斜率，直到舍入误差占主导地位。\n可选部分关于最优 $\\epsilon$ 的公式通常与*一阶*前向/后向差分相关，其最优 $\\epsilon$ 平衡了 $\\mathcal{O}(\\epsilon)$ 和 $\\mathcal{O}(\\epsilon_{\\text{mach}}/\\epsilon)$，得出 $\\epsilon_{\\text{opt}} \\sim \\sqrt{\\epsilon_{\\text{mach}}}$。对于二阶中心差分，误差平衡是在 $\\mathcal{O}(\\epsilon^2)$ 和 $\\mathcal{O}(\\epsilon_{\\text{mach}}/\\epsilon)$ 之间，这得出 $\\epsilon_{\\text{opt}} \\sim (\\epsilon_{\\text{mach}})^{1/3}$。然而，这只是陈述中可选部分的一个小不准确之处。所描述的主要程序（扫描 $\\epsilon$ 并绘制收敛图）是明确正确和稳健的。\n结论：**正确**。\n\n**B. 使用中心有限差分 $\\Delta(\\epsilon, p)$，但为了强调沿最速下降方向的灵敏度，设置 $p = \\nabla J(m)$ 并选择 $\\epsilon = 10^{-16}$（双精度机器精度），以确保扰动尽可能小。依赖最小的 $\\epsilon$ 来揭示最高阶的一致性，并将任何偏差视为求解器噪声。**\n这个选项存在根本性缺陷。\n-   选择 $p = \\nabla J(m)$ 是一个有效但并非最通用的选择。\n-   选择 $\\epsilon = 10^{-16}$ 是灾难性的。如前所述，这将计算完全置于由舍入误差主导的区域。分子 $J(m+\\epsilon p) - J(m-\\epsilon p)$ 由于相减抵消将产生几乎纯粹的数值噪声，然后被微小的 $2\\epsilon$ 除法放大。\n-   认为最小的 $\\epsilon$ 能揭示“最高阶一致性”是对浮点运算的严重误解。它揭示的是机器精度的限制，而不是泰勒级数的行为。\n结论：**不正确**。\n\n**C. 用单边有限差分 $[J(m + \\epsilon p) - J(m)]/\\epsilon$ 替换中心有限差分，以避免加倍计算成本。选择一个适度小的 $\\epsilon$，例如 $\\epsilon = 10^{-6}$，并选择一个在接收点周围局部化的稀疏扰动 $p$ 以增强灵敏度。因为 $J$ 是光滑的，所以期望二阶收敛。**\n这个选项包含多个错误。\n-   单边有限差分 $[J(m + \\epsilon p) - J(m)]/\\epsilon$ 的截断误差为 $\\mathcal{O}(\\epsilon)$，意味着它只是一阶近似。从中“期望二阶收敛”是不正确的。\n-   虽然它确实节省了计算成本，但牺牲了测试本身的准确性。\n-   选择在接收点周围局部化的稀疏 $p$ 是一种糟糕的测试策略。梯度 $\\nabla J(m)$ 通过波传播的整个模型空间都有贡献。仅测试一个小的、局部化的子空间不是对完整梯度的稳健验证。随机、稠密的扰动要优越得多。\n结论：**不正确**。\n\n**D. 使用中心有限差分 $\\Delta(\\epsilon, p)$，但选择一个非归一化的 $p$，使其在波场能量低的区域具有大振幅，并固定 $\\epsilon = 10^{-3}$ 以在多次运行中保持一致。如果误差不随 $\\epsilon$ 减小，则增加正向求解器的时间步长以进行补偿，并依赖于 $\\Delta(\\epsilon, p)$ 和 $G(p)$ 之间的视觉一致性，而不是定量的误差缩放。**\n这个选项推荐了一系列不科学的做法。\n-   $p$ 的选择是临时的，没有任何数值分析原则的支持。\n-   使用单个固定的 $\\epsilon$ 无法验证收敛*率*，而这正是测试的主要目的。\n-   建议*增加*时间步长来“补偿”误差是荒谬的。增加时间步长会增加 PDE 求解器的数值误差，从而进一步污染梯度检验。人们必须*减少*求解器误差。\n-   依赖“视觉一致性”而不是对误差缩放进行定量分析，放弃了定义科学验证的严谨性。\n结论：**不正确**。",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "在验证了梯度计算的数值正确性之后，下一步是深入理解梯度（即敏感度核）的物理意义。敏感度核揭示了模型在特定位置的微小变化将如何影响数据失配。本练习  探讨了测量系统的设计——例如，使用点式检波器与空间平均检波器——如何直接影响伴随源的形态，进而改变敏感度核的空间分辨率和结构。这为地球物理勘探设计提供了宝贵的见解，并加深了对伴随物理过程的理解。",
            "id": "3574116",
            "problem": "考虑一个由域 $\\Omega \\subset \\mathbb{R}^2$ 表示的具有吸收边界的二维合成沉积盆地。声压场 $u(\\mathbf{x}, t)$ 服从常密度声波方程\n$$\n\\partial_t^2 u(\\mathbf{x}, t) - m(\\mathbf{x}) \\nabla^2 u(\\mathbf{x}, t) = f(\\mathbf{x}, t),\n$$\n其中 $m(\\mathbf{x}) = c(\\mathbf{x})^2$ 是空间变化的波速平方，$f(\\mathbf{x}, t) = s(t)\\,\\delta(\\mathbf{x} - \\mathbf{x}_s)$ 是位于 $\\mathbf{x}_s$ 的点源，其震源时间函数为 $s(t)$，峰值频率为 $f_0$。拟合泛函定义为\n$$\nJ(u) = \\frac{1}{2} \\int_0^T \\| B u(t) - d(t) \\|_{\\mathbf{W}}^2 \\, dt,\n$$\n其中 $B$ 是一个将波场映射到检波器系统处观测数据的线性观测算子，$d(t)$ 是观测到的时间序列，$\\mathbf{W}$ 是一个对称正定加权，且 $\\|\\mathbf{y}\\|_{\\mathbf{W}}^2 = \\mathbf{y}^\\top \\mathbf{W} \\mathbf{y}$。考虑 $B$ 的两种选择：\n\n$1.$ 在 $N$ 个检波点位置 $\\{\\mathbf{x}_r\\}_{r=1}^N$ 进行点采样：\n$$\n(B_{\\mathrm{pt}} u)_r(t) = u(\\mathbf{x}_r, t), \\quad r = 1, \\dots, N.\n$$\n\n$2.$ 在检波器片元 $\\{\\Gamma_r\\}_{r=1}^N$ 上进行空间平均，其非负归一化权重 $w_r(\\mathbf{x})$ 支撑在 $\\Gamma_r$ 上：\n$$\n(B_{\\mathrm{avg}} u)_r(t) = \\int_{\\Gamma_r} w_r(\\mathbf{x})\\, u(\\mathbf{x}, t)\\, d\\mathbf{x}, \\quad \\int_{\\Gamma_r} w_r(\\mathbf{x})\\, d\\mathbf{x} = 1.\n$$\n\n假设 $\\mathbf{W}$ 是对角矩阵，其元素为 $W_r > 0$，时间窗口 $[0, T]$ 足够长以捕捉波形，并且分部积分后边界项消失。盆地的波速 $c_{\\mathrm{basin}}$ 比周围基底的波速 $c_{\\mathrm{basement}}$ 慢，其中 $c_{\\mathrm{basin}} = 2\\,\\mathrm{km/s}$，$c_{\\mathrm{basement}} = 4\\,\\mathrm{km/s}$，且 $f_0 = 5\\,\\mathrm{Hz}$。检波器片元宽度满足 $a \\approx 0.2\\,\\mathrm{km}$，而盆地内的特征波长为 $\\lambda_{\\mathrm{basin}} \\approx c_{\\mathrm{basin}}/f_0$。\n\n任务：\n$1.$ 从给定的控制方程和拟合泛函的定义出发，推导伴随状态方程以及关于 $m(\\mathbf{x})$ 的梯度 $\\nabla J(\\mathbf{x})$，其中 $B$ 为一个通用线性算子。然后，通过写出相应的时空伴随源，将你的结果具体化到每种观测算子 $B_{\\mathrm{pt}}$ 和 $B_{\\mathrm{avg}}$。\n\n$2.$ 基于推导出的形式，分析观测算子的选择如何影响盆地内 $\\nabla J(\\mathbf{x})$ 的空间分辨率。使用给定的数值尺度，论证解析特征尺寸小于或约等于 $a$ 和 $\\lambda_{\\mathrm{basin}}$ 的相对能力。\n\n下列哪个陈述与推导和分辨率分析最一致？\n\nA. 对于点采样，伴随源是位于检波点位置、由残差加权的空间狄拉克分布之和，即 $r_{\\mathrm{pt}}(\\mathbf{x}, t) = \\sum_{r=1}^N W_r\\,[u(\\mathbf{x}_r, t) - d_r(t)]\\,\\delta(\\mathbf{x} - \\mathbf{x}_r)$。对于在权重为 $w_r(\\mathbf{x})$ 的片元上进行空间平均，伴随源是 $r_{\\mathrm{avg}}(\\mathbf{x}, t) = \\sum_{r=1}^N W_r\\left[\\int_{\\Gamma_r} w_r(\\mathbf{y})\\,u(\\mathbf{y}, t)\\, d\\mathbf{y} - d_r(t)\\right] w_r(\\mathbf{x})$。在这两种情况下，梯度均为 $\\nabla J(\\mathbf{x}) = -\\int_0^T \\nabla u(\\mathbf{x}, t)\\cdot \\nabla \\lambda(\\mathbf{x}, t)\\, dt$。空间平均展宽了伴随场，因此在近似平均窗口尺度 $a$ 上对梯度进行低通滤波，所以在盆地内部，当 $\\lambda_{\\mathrm{basin}} \\approx 0.4\\,\\mathrm{km}$ 且 $a \\approx 0.2\\,\\mathrm{km}$ 时，与点采样相比，尺寸小于 $a$ 的特征更难解析。\n\nB. 观测算子不影响伴随源，伴随源始终是 $r(\\mathbf{x}, t) = \\sum_{r=1}^N W_r[u(\\mathbf{x}, t) - d_r(t)]$，在 $\\Omega$ 上均匀分布，因此对于点采样和空间平均，$\\nabla J(\\mathbf{x})$ 的分辨率是相同的。\n\nC. 空间平均在伴随源中引入了一个额外的拉普拉斯算子，$r_{\\mathrm{avg}}(\\mathbf{x}, t) = \\nabla^2\\left(\\sum_{r=1}^N W_r[(B_{\\mathrm{avg}} u)_r(t) - d_r(t)]\\right)$，这增加了 $\\nabla J(\\mathbf{x})$ 中的高频成分，并提高了盆地内的分辨率。\n\nD. 对于点采样，梯度简化为 $\\nabla J(\\mathbf{x}) = -\\int_0^T u(\\mathbf{x}, t)\\,\\lambda(\\mathbf{x}, t)\\, dt$，而对于空间平均，它仍然是 $\\nabla J(\\mathbf{x}) = -\\int_0^T \\nabla u(\\mathbf{x}, t)\\cdot \\nabla \\lambda(\\mathbf{x}, t)\\, dt$，这意味着空间平均能产生更清晰的灵敏度局部化。\n\nE. 由于终端条件，两种观测算子产生的伴随源都仅在 $t = T$ 时非零，因此任何分辨率差异仅取决于震源带宽，而不取决于 $B$ 的空间支撑。",
            "solution": "该问题要求在两种不同的观测场景下，推导和分析声波方程的伴随状态灵敏度核。我们将首先验证问题陈述，然后基于变分法和伴随状态法进行严格推导。\n\n### 问题验证\n\n**步骤1：提取已知条件**\n- **控制方程**：$\\partial_t^2 u(\\mathbf{x}, t) - m(\\mathbf{x}) \\nabla^2 u(\\mathbf{x}, t) = f(\\mathbf{x}, t)$，在域 $\\Omega \\subset \\mathbb{R}^2$ 中，有吸收边界。\n- **模型参数**：$m(\\mathbf{x}) = c(\\mathbf{x})^2$。\n- **震源项**：$f(\\mathbf{x}, t) = s(t)\\,\\delta(\\mathbf{x} - \\mathbf{x}_s)$。\n- **拟合泛函**：$J(u) = \\frac{1}{2} \\int_0^T \\| B u(t) - d(t) \\|_{\\mathbf{W}}^2 \\, dt$。\n- **加权**：$\\mathbf{W}$ 是一个对角矩阵，其元素为 $W_r > 0$。范数为 $\\|\\mathbf{y}\\|_{\\mathbf{W}}^2 = \\mathbf{y}^\\top \\mathbf{W} \\mathbf{y}$。\n- **观测算子**：\n    1.  点采样：$(B_{\\mathrm{pt}} u)_r(t) = u(\\mathbf{x}_r, t)$。\n    2.  空间平均：$(B_{\\mathrm{avg}} u)_r(t) = \\int_{\\Gamma_r} w_r(\\mathbf{x})\\, u(\\mathbf{x}, t)\\, d\\mathbf{x}$，其中 $\\int_{\\Gamma_r} w_r(\\mathbf{x})\\, d\\mathbf{x} = 1$。\n- **假设**：分部积分后边界项消失。时间窗口 $[0, T]$ 足够长。\n- **物理参数**：$c_{\\mathrm{basin}} = 2\\,\\mathrm{km/s}$，$c_{\\mathrm{basement}} = 4\\,\\mathrm{km/s}$，$f_0 = 5\\,\\mathrm{Hz}$，检波器片元宽度 $a \\approx 0.2\\,\\mathrm{km}$。\n- **导出参数**：$\\lambda_{\\mathrm{basin}} \\approx c_{\\mathrm{basin}}/f_0$。\n\n**步骤2：使用提取的已知条件进行验证**\n问题陈述具有科学依据，描述了地球物理学中全波形反演（FWI）的标准设置。控制方程、拟合泛函和观测算子都有明确的定义。所有提供的参数对于盆地尺度的地震成像问题都是物理上现实的。假设标准隐式初始条件（例如，震源作用前介质处于静止状态），该问题是客观且适定的。\n\n问题陈述中存在一个微妙的歧义。“常密度声波方程”这一术语最准确地对应于形式 $\\partial_t^2 u - \\nabla \\cdot (m(\\mathbf{x}) \\nabla u) = f$。问题提供了简化形式 $\\partial_t^2 u - m(\\mathbf{x}) \\nabla^2 u = f$，这仅在 $m(\\mathbf{x})$ 是常数时才等价。由于上下文是空间变化的波速，这种简化使得空间算子非自伴。然而，这在一些文献中是常见的简化。与非均匀介质中波传播的物理学一致的严格处理应从 $\\nabla \\cdot (m(\\mathbf{x}) \\nabla u)$ 形式开始。尽管如此，所陈述的问题在数学上仍然是有效的，但我们将假设采用物理上更准确的形式进行推导，因为它能导出该领域所使用并在选项中呈现的标准梯度表达式。这并不会使问题无效，但需要对数学模型进行澄清。\n\n**步骤3：结论与行动**\n该问题是**有效的**。我们通过采用物理标准形式的波动方程来着手求解。\n\n### 任务1：伴随方程和梯度的推导\n\n为了找到拟合泛函 $J$ 关于模型参数 $m(\\mathbf{x})$ 的梯度，我们使用伴随状态法。我们通过用控制偏微分方程（PDE）来增广泛函 $J$ 来构造拉格朗日量 $\\mathcal{L}$，该方程由一个拉格朗日乘子场 $\\lambda(\\mathbf{x}, t)$（伴随场）强制执行：\n$$\n\\mathcal{L}(u, \\lambda, m) = J(u) - \\int_0^T \\int_\\Omega \\lambda \\left[ \\partial_t^2 u - \\nabla \\cdot (m \\nabla u) - f \\right] d\\mathbf{x} dt\n$$\n我们考虑模型中的一个小扰动 $m \\to m + \\delta m$，它会引起波场的一个扰动 $u \\to u + \\delta u$。在驻点处，拉格朗日量的一阶变化为零，即 $\\delta \\mathcal{L} = 0$。\n总变分为 $\\delta \\mathcal{L} = \\frac{\\partial \\mathcal{L}}{\\partial u} \\delta u + \\frac{\\partial \\mathcal{L}}{\\partial m} \\delta m + \\frac{\\partial \\mathcal{L}}{\\partial \\lambda} \\delta \\lambda$。\n$\\delta \\lambda$ 的项恢复了正演偏微分方程。我们关注关于 $u$ 和 $m$ 的变分。\n\n关于 $u$ 的变分由两部分组成：\n1.  来自泛函 $J$：$\\delta_u J = \\int_0^T (B u - d)^\\top \\mathbf{W} (B \\delta u) \\, dt$。使用伴随算子 $B^\\dagger$ 的定义，这可以写成在场域上的积分：$\\delta_u J = \\int_0^T \\int_\\Omega [B^\\dagger (\\mathbf{W}(Bu - d))] \\delta u \\, d\\mathbf{x} dt$。\n2.  来自PDE约束项：$-\\int_0^T \\int_\\Omega \\lambda \\left[ \\partial_t^2 \\delta u - \\nabla \\cdot (m \\nabla \\delta u) \\right] d\\mathbf{x} dt$。\n我们对该项进行分部积分。利用所述假设，即边界项消失（在空间和时间上，具有终端条件 $\\lambda(T)=0, \\partial_t \\lambda(T)=0$ 和初始条件 $u(0)=0, \\partial_t u(0)=0$），我们将微分算子从 $\\delta u$ 转移到 $\\lambda$：\n$$\n-\\int_0^T \\int_\\Omega \\delta u \\left[ \\partial_t^2 \\lambda - \\nabla \\cdot (m \\nabla \\lambda) \\right] d\\mathbf{x} dt\n$$\n伴随状态法将 $\\delta u$ 的总系数设为零。这定义了**伴随方程**：\n$$\n\\partial_t^2 \\lambda(\\mathbf{x}, t) - \\nabla \\cdot (m(\\mathbf{x}) \\nabla \\lambda(\\mathbf{x}, t)) = r_\\lambda(\\mathbf{x}, t)\n$$\n其终端条件为 $\\lambda(\\mathbf{x}, T) = 0$ 和 $\\partial_t\\lambda(\\mathbf{x}, T) = 0$。右边的项是**伴随源** $r_\\lambda(\\mathbf{x}, t)$：\n$$\nr_\\lambda(\\mathbf{x}, t) = B^\\dagger (\\mathbf{W}(B u(t) - d(t)))\n$$\n消除 $\\delta u$ 项后，剩余的变分 $\\delta \\mathcal{L}$ 给出梯度。关于 $m$ 的变分为：\n$$\n\\delta_m \\mathcal{L} = - \\int_0^T \\int_\\Omega \\lambda \\left[ - \\nabla \\cdot (\\delta m \\nabla u) \\right] d\\mathbf{x} dt = \\int_0^T \\int_\\Omega \\lambda \\nabla \\cdot (\\delta m \\nabla u) d\\mathbf{x} dt\n$$\n再次分部积分：\n$$\n\\delta_m \\mathcal{L} = - \\int_0^T \\int_\\Omega \\nabla \\lambda \\cdot (\\delta m \\nabla u) d\\mathbf{x} dt = \\int_\\Omega \\delta m(\\mathbf{x}) \\left( -\\int_0^T \\nabla u(\\mathbf{x}, t) \\cdot \\nabla \\lambda(\\mathbf{x}, t) dt \\right) d\\mathbf{x}\n$$\n根据定义，Fréchet导数（梯度）$\\nabla J(\\mathbf{x}) = \\frac{\\delta J}{\\delta m(\\mathbf{x})}$ 是该积分的核：\n$$\n\\nabla J(\\mathbf{x}) = -\\int_0^T \\nabla u(\\mathbf{x}, t) \\cdot \\nabla \\lambda(\\mathbf{x}, t) dt\n$$\n该表达式是正演波场和伴随波场梯度的相关。\n\n**对观测算子的具体化**\n现在我们通过找到每个算子 $B$ 的伴随算子 $B^\\dagger$ 来求出伴随源 $r_\\lambda$ 的显式形式。\n\n1.  **点采样 ($B_{\\mathrm{pt}}$)**：\n    定义的内积关系为 $\\int_0^T \\langle B_{\\mathrm{pt}}^\\dagger \\mathbf{y}, u \\rangle_{\\Omega} dt = \\int_0^T \\langle \\mathbf{y}, B_{\\mathrm{pt}} u \\rangle_N dt$。\n    $$ \\int_0^T \\sum_{r=1}^N y_r(t) (B_{\\mathrm{pt}} u)_r(t) dt = \\int_0^T \\sum_{r=1}^N y_r(t) u(\\mathbf{x}_r, t) dt $$\n    $$ = \\int_0^T \\int_\\Omega \\left( \\sum_{r=1}^N y_r(t) \\delta(\\mathbf{x} - \\mathbf{x}_r) \\right) u(\\mathbf{x}, t) d\\mathbf{x} dt $$\n    因此，$(B_{\\mathrm{pt}}^\\dagger \\mathbf{y})(\\mathbf{x}, t) = \\sum_{r=1}^N y_r(t) \\delta(\\mathbf{x} - \\mathbf{x}_r)$。通过设置 $\\mathbf{y}(t) = \\mathbf{W}(B_{\\mathrm{pt}}u(t) - d(t))$ 得到伴随源，其分量为 $y_r(t) = W_r(u(\\mathbf{x}_r, t) - d_r(t))$。\n    $$ r_{\\mathrm{pt}}(\\mathbf{x}, t) = \\sum_{r=1}^N W_r [u(\\mathbf{x}_r, t) - d_r(t)] \\delta(\\mathbf{x} - \\mathbf{x}_r) $$\n\n2.  **空间平均 ($B_{\\mathrm{avg}}$)**：\n    类似地，\n    $$ \\int_0^T \\sum_{r=1}^N y_r(t) (B_{\\mathrm{avg}} u)_r(t) dt = \\int_0^T \\sum_{r=1}^N y_r(t) \\left( \\int_{\\Gamma_r} w_r(\\mathbf{x'}) u(\\mathbf{x'}, t) d\\mathbf{x'} \\right) dt $$\n    $$ = \\int_0^T \\int_\\Omega \\left( \\sum_{r=1}^N y_r(t) w_r(\\mathbf{x}) \\right) u(\\mathbf{x}, t) d\\mathbf{x} dt $$\n    因此，$(B_{\\mathrm{avg}}^\\dagger \\mathbf{y})(\\mathbf{x}, t) = \\sum_{r=1}^N y_r(t) w_r(\\mathbf{x})$。通过设置 $y_r(t) = W_r((B_{\\mathrm{avg}}u)_r(t) - d_r(t))$ 得到伴随源。\n    $$ r_{\\mathrm{avg}}(\\mathbf{x}, t) = \\sum_{r=1}^N W_r \\left[ \\int_{\\Gamma_r} w_r(\\mathbf{y}) u(\\mathbf{y}, t) d\\mathbf{y} - d_r(t) \\right] w_r(\\mathbf{x}) $$\n\n### 任务2：分辨率分析\n\n梯度 $\\nabla J(\\mathbf{x})$ 的空间特性由正演场 $u$ 和伴随场 $\\lambda$ 的相互作用决定。伴随场 $\\lambda$ 是一个以 $r_\\lambda(\\mathbf{x},t)$ 为源项并进行时间反向传播的波动方程的解。伴随源的空间结构直接影响最终梯度的空间分辨率。\n\n-   对于**点采样 ($B_{\\mathrm{pt}}$)**，伴随源 $r_{\\mathrm{pt}}$ 是位于检波点位置 $\\{\\mathbf{x}_r\\}$ 的一系列空间狄拉克δ函数。因此，伴随场 $\\lambda$ 从这些点产生。$\\lambda$ 的空间频率内容很宽，主要受限于数据残差的时间频率内容和波传播效应（衍射、散射）。\n\n-   对于**空间平均 ($B_{\\mathrm{avg}}$)**，伴随源 $r_{\\mathrm{avg}}$ 是空间分布的。对于每个检波器分量 $r$，源的形状为权重函数 $w_r(\\mathbf{x})$，其特征宽度为 $a$。这等效于将一个点源响应与函数 $w_r(\\mathbf{x})$ 进行卷积。在空间频率域（波数域）中，这种卷积对应于乘以 $w_r(\\mathbf{x})$ 的傅里叶变换。一个空间支撑尺寸为 $a$ 的函数，其变换相当于一个低通滤波器，其截止尺度与 $1/a$ 相关。因此，伴随场 $\\lambda$ 内在地比点采样情况下更平滑，因为高空间频率在源处就被抑制了。\n\n**数值评估**：\n问题提供：\n- 盆地内的特征波长：$\\lambda_{\\mathrm{basin}} \\approx c_{\\mathrm{basin}}/f_0 = (2\\,\\mathrm{km/s}) / (5\\,\\mathrm{Hz}) = 0.4\\,\\mathrm{km}$。\n- 检波器片元宽度：$a \\approx 0.2\\,\\mathrm{km}$。\n\n片元宽度 $a$ 是特征波长的一半 ($a = 0.5 \\lambda_{\\mathrm{basin}}$)。空间平均在尺度 $a$ 上引入了平滑效应。这对梯度起到了低通滤波的作用，降低了其解析小于 $a$ 的特征的能力。由于点采样没有这种内在平滑，它允许潜在的更高分辨率，该分辨率受 $\\lambda_{\\mathrm{basin}}$ 和采集几何的限制。因此，与点采样相比，空间平均算子降低了解析尺寸与 $a$ 相当或更小的特征的能力。\n\n### 选项评估\n\n**A. 对于点采样，伴随源是位于检波点位置、由残差加权的空间狄拉克分布之和，即 $r_{\\mathrm{pt}}(\\mathbf{x}, t) = \\sum_{r=1}^N W_r\\,[u(\\mathbf{x}_r, t) - d_r(t)]\\,\\delta(\\mathbf{x} - \\mathbf{x}_r)$。对于在权重为 $w_r(\\mathbf{x})$ 的片元上进行空间平均，伴随源是 $r_{\\mathrm{avg}}(\\mathbf{x}, t) = \\sum_{r=1}^N W_r\\left[\\int_{\\Gamma_r} w_r(\\mathbf{y})\\,u(\\mathbf{y}, t)\\, d\\mathbf{y} - d_r(t)\\right] w_r(\\mathbf{x})$。在这两种情况下，梯度均为 $\\nabla J(\\mathbf{x}) = -\\int_0^T \\nabla u(\\mathbf{x}, t)\\cdot \\nabla \\lambda(\\mathbf{x}, t)\\, dt$。空间平均展宽了伴随场，因此在近似平均窗口尺度 $a$ 上对梯度进行低通滤波，所以在盆地内部，当 $\\lambda_{\\mathrm{basin}} \\approx 0.4\\,\\mathrm{km}$ 且 $a \\approx 0.2\\,\\mathrm{km}$ 时，与点采样相比，尺寸小于 $a$ 的特征更难解析。**\n- 两种伴随源 $r_{\\mathrm{pt}}$ 和 $r_{\\mathrm{avg}}$ 的表达式根据我们的推导是正确的。\n- 梯度 $\\nabla J(\\mathbf{x})$ 的表达式对于物理标准波动方程是正确的。\n- 分辨率分析是正确的：空间平均在尺度 $a$ 上起到低通滤波的作用，降低了对小于 $a$ 的特征的分辨率。\n- 数值计算 $\\lambda_{\\mathrm{basin}} \\approx 0.4\\,\\mathrm{km}$ 是正确的。\n- 结论：**正确**。\n\n**B. 观测算子不影响伴随源，伴随源始终是 $r(\\mathbf{x}, t) = \\sum_{r=1}^N W_r[u(\\mathbf{x}, t) - d_r(t)]$，在 $\\Omega$ 上均匀分布，因此对于点采样和空间平均，$\\nabla J(\\mathbf{x})$ 的分辨率是相同的。**\n- “观测算子不影响伴随源”这一说法从根本上是错误的。伴随源由 $B^\\dagger(\\dots)$ 明确给出。\n- 所提供的源的公式毫无意义且不正确。\n- 结论：**不正确**。\n\n**C. 空间平均在伴随源中引入了一个额外的拉普拉斯算子，$r_{\\mathrm{avg}}(\\mathbf{x}, t) = \\nabla^2\\left(\\sum_{r=1}^N W_r[(B_{\\mathrm{avg}} u)_r(t) - d_r(t)]\\right)$，这增加了 $\\nabla J(\\mathbf{x})$ 中的高频成分，并提高了盆地内的分辨率。**\n- 推导出的空间平均的伴随源不包含拉普拉斯算子。这种说法是错误的。拉普拉斯算子会增强高频，这与平均效应相反。\n- 结论：**不正确**。\n\n**D. 对于点采样，梯度简化为 $\\nabla J(\\mathbf{x}) = -\\int_0^T u(\\mathbf{x}, t)\\,\\lambda(\\mathbf{x}, t)\\, dt$，而对于空间平均，它仍然是 $\\nabla J(\\mathbf{x}) = -\\int_0^T \\nabla u(\\mathbf{x}, t)\\cdot \\nabla \\lambda(\\mathbf{x}, t)\\, dt$，这意味着空间平均能产生更清晰的灵敏度局部化。**\n- 梯度核的形式取决于被反演的参数（$m$）和偏微分方程的形式，而不是观测算子 $B$。梯度公式在不同算子之间会改变的说法是错误的。\n- $-\\int u \\lambda dt$ 的形式是针对不同类型参数（例如，势能项）的梯度，而不是拉普拉斯项系数的梯度。\n- 结论：**不正确**。\n\n**E. 由于终端条件，两种观测算子产生的伴随源都仅在 $t = T$ 时非零，因此任何分辨率差异仅取决于震源带宽，而不取决于 $B$ 的空间支撑。**\n- 这混淆了伴随源与伴随场的终端条件。伴随场 $\\lambda$ 在 $t=T$ 时为零，但只要数据残差不为零，其源 $r_\\lambda$ 就在 $t \\in [0,T]$ 期间是活动的。该陈述从根本上是错误的。\n- 结论：**不正确**。",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "为大规模地球物理模型计算梯度是一项计算密集型任务，通常需要使用分布式内存的超级计算机。本章的最终实践将理论知识应用于大规模实现。本练习  要求您设计一个高效的并行工作流，通过合理调度震源级并行、用于检查点的异步输入/输出（I/O）以及将通信与计算重叠，来解决实际的性能挑战。完成此练习将帮助您掌握最小化计算时间、使大规模反演变得切实可行的关键策略。",
            "id": "3574197",
            "problem": "考虑在带吸收边界的有界域上，由变系数声波方程控制的时域全波形反演问题。对于每个震源索引 $s \\in \\{1,\\dots,N_s\\}$，正演场 $u_s(\\mathbf{x},t)$ 满足以下形式的线性偏微分方程\n$$\n\\mathcal{L}(m)\\,u_s(\\mathbf{x},t)=f_s(\\mathbf{x},t), \\quad u_s(\\mathbf{x},0)=0, \\quad \\partial_t u_s(\\mathbf{x},0)=0,\n$$\n其中 $m(\\mathbf{x})$ 是模型参数（例如，慢度平方），$\\mathcal{L}(m)$ 是一个关于 $u_s$ 线性且平滑依赖于 $m$ 的微分算子，而 $f_s$ 是一个已知的震源项。对于每个 $s$，在 $N_r$ 个接收点观测到的数据为 $d_s^{\\mathrm{obs}}(t)$。一个标准的最小二乘残差函数为\n$$\nJ(m)=\\frac{1}{2}\\sum_{s=1}^{N_s}\\sum_{r=1}^{N_r}\\int_{0}^{T}\\left(u_s(\\mathbf{x}_r,t;m)-d_{s,r}^{\\mathrm{obs}}(t)\\right)^2\\,\\mathrm{d}t,\n$$\n其中 $\\mathbf{x}_r$ 为接收点位置。假设伴随状态法适用，并且 $J$ 的梯度可以表示为一个正演场与一个对数据残差呈线性的伴随场之间的时空双线性相互作用。该计算任务必须在一个分布式内存的高性能计算 (HPC) 系统上执行，该系统具有以下规格和约束：\n\n- 全程可使用 $P=64$ 个相同的计算节点（处理器）。\n- 每个节点拥有 $128\\,\\mathrm{GB}$ 内存和一个节点本地固态硬盘，其持续读写带宽为 $2\\,\\mathrm{GB/s}$。\n- 在分配给一个节点的子域上，单个正演或伴随时间步的计算时间成本为 $t_{\\mathrm{step}}=0.012\\,\\mathrm{s}$。总时间步数为 $T_{\\mathrm{steps}}=8000$。\n- 为通过伴随状态法计算梯度而无需完全重新计算正演场，使用了检查点技术：对每个震源，每 $k=100$ 个时间步存储一次正演状态的快照。每个节点上存储的每个检查点大小为 $1\\,\\mathrm{GB}$。\n- 检查点被写入和读取于节点本地存储。输入/输出 (I/O) 可以同步（阻塞）或异步（非阻塞）发起，并且在不受带宽限制的情况下可以与计算重叠。\n- 梯度是一个分布在所有节点上的空间场。其在每个节点上的局部部分大小为 $2\\,\\mathrm{GB}$。需要一个跨所有节点的全局求和来组装完整的梯度。互连支持基于树的 all-reduce 操作，有效带宽为 $10\\,\\mathrm{GB/s}$，延迟与批量传输相比可以忽略不计。\n\n要求您从以下选项中选择一个工作流，该工作流既能 (i) 通过伴随状态法为给定的残差和正演模型生成数学上正确的梯度，又能 (ii) 通过利用震源并行、批处理、异步检查点 I/O 和高效的部分梯度规约，在给定约束下最小化墙上时钟时间。您可以假设以下额外细节用于时间估算：\n\n- 使用大小为 $G$ 个节点的子通信域，可以作为一个批次并发模拟 $K=\\lfloor P/G \\rfloor$ 个震源。对于固定的全局网格大小，计算时间与 $G$ 成反比（在这些限制内为理想的强扩展）。\n- 在两个检查点之间，每个节点的计算时间为 $t_{\\mathrm{comp,int}}=k \\, t_{\\mathrm{step}}=1.2\\,\\mathrm{s}$。\n- 每个节点写入或读取单个检查点需要 $t_{\\mathrm{io,cp}}=0.5\\,\\mathrm{s}$，如果与持续时间至少为 $t_{\\mathrm{io,cp}}$ 的计算重叠，则可以完全隐藏此开销。\n\n选项：\n\nA. 顺序地对每个震源使用所有 $P$ 个节点。对每个震源，运行正演模拟，将检查点同步写入并行文件系统，使得模拟在每个检查点处阻塞 $t_{\\mathrm{io,cp}}$ 的时间。然后运行伴随模拟，使用同步读取，在每个检查点处阻塞 $t_{\\mathrm{io,cp}}$ 的时间。每个震源的伴随模拟完成后，对 $2\\,\\mathrm{GB}$ 的局部梯度在所有 $P$ 个节点上执行一次阻塞式 all-reduce 操作，以累加到全局梯度中。逐个震源处理，直到处理完 $N_s$ 个震源。\n\nB. 将 $P$ 个节点划分为 $K=P/G$ 个子通信域，每个子通信域大小为 $G=8$ 个节点，以批处理方式并发处理 $K=8$ 个震源。对于每个批次，在每个子通信域上并为每个分配的震源：运行正演模拟，并每 $k$ 步异步、非阻塞地将检查点写入节点本地存储，将 I/O 与检查点之间的计算 $t_{\\mathrm{comp,int}}$ 重叠。该批次的正演运行结束后，对于其子通信域上的每个震源，逆时运行伴随模拟，在对当前时间窗进行互相关以累积该震源的局部梯度时，异步预取下一个所需的检查点。将 $K$ 个单源局部梯度在每个子通信域内求和，得到一个单一的子通信域局部部分梯度。在批次结束时，启动一个非阻塞的基于树的 all-reduce 操作，将 $K$ 个子通信域局部部分梯度在所有 $P$ 个节点上求和，得到全局梯度，同时立即开始下一批次的正演运行，以将规约操作与计算重叠。对所有 $\\lceil N_s/K \\rceil$ 个批次重复此过程。\n\nC. 对所有震源，使用全部 $P$ 个节点运行一次正演模拟，但不使用检查点技术，而是将每个震源在所有时间步的完整时间历史正演场流式传输到磁盘。在所有正演模拟完成后，通过对所有震源和接收点的残差求和，形成一个单一的复合伴随源，并运行一次单一的伴随模拟。将该单一伴随场与一个由平均“复合”震源计算出的单一正演场进行互相关，以一次性生成梯度。在最后执行一次单一的 all-reduce 操作。\n\nD. 将 $P$ 个节点划分为大小为 $G=8$ 的子通信域，并以批处理方式并发处理 $K=8$ 个震源。像选项 B 一样，对检查点使用异步 I/O。在伴随反向传播期间，为减少规约成本，在每个子通信域内，于每个网格点上，保留 $K$ 个震源的局部梯度贡献中的最大值（按绝对值），而不是它们的和。在每个批次结束时，对这些各子通信域的最大值执行一次阻塞式 all-reduce 操作以形成全局梯度，然后继续处理下一个批次。\n\n哪个选项同时满足数学正确性和所述的性能目标？\n\n选项：\n- A. 顺序、同步 I/O 的工作流，带每震源阻塞式规约。\n- B. 批处理、子通信域的工作流，带完全重叠的异步检查点 I/O 和每批次一次与计算重叠的非阻塞 all-reduce。\n- C. 写入完整时间历史，使用单一复合伴随源和单次正演互相关。\n- D. 批处理、异步工作流，在全局规约前用逐点最大值替换单源求和。",
            "solution": "用户要求对四种用于计算全波形反演 (FWI) 问题中梯度的不同计算工作流进行评估。评估标准是 (i) 数学正确性和 (ii) 在给定的高性能计算 (HPC) 系统上最小化墙上时钟时间。\n\n### 问题验证\n\n首先，我将验证问题陈述。\n\n**步骤 1：提取给定条件**\n-   控制物理：变系数声波方程的时域 FWI。\n-   正演问题：对于 $s \\in \\{1,\\dots,N_s\\}$，$\\mathcal{L}(m)\\,u_s(\\mathbf{x},t)=f_s(\\mathbf{x},t)$，其中 $u_s(\\mathbf{x},0)=0$ 且 $\\partial_t u_s(\\mathbf{x},0)=0$。\n-   残差泛函：$J(m)=\\frac{1}{2}\\sum_{s=1}^{N_s}\\sum_{r=1}^{N_r}\\int_{0}^{T}\\left(u_s(\\mathbf{x}_r,t;m)-d_{s,r}^{\\mathrm{obs}}(t)\\right)^2\\,\\mathrm{d}t$。\n-   梯度方法：伴随状态法，梯度表示为时空双线性相互作用。\n-   HPC 系统：$P=64$ 个节点，$128\\,\\mathrm{GB}$ 内存/节点，$2\\,\\mathrm{GB/s}$ 节点本地 I/O 带宽。\n-   模拟参数：$t_{\\mathrm{step}}=0.012\\,\\mathrm{s}$ (每节点时间步成本)，$T_{\\mathrm{steps}}=8000$ (总时间步数)。\n-   检查点技术：每 $k=100$ 步一次，每节点大小 $1\\,\\mathrm{GB}$，存放在节点本地存储。\n-   梯度数据：每节点局部部分为 $2\\,\\mathrm{GB}$，通过有效带宽为 $10\\,\\mathrm{GB/s}$ 的 all-reduce 进行全局求和。\n-   性能模型：强扩展（时间 $\\propto 1/G$，对于 $G$ 个节点）。$t_{\\mathrm{comp,int}}=k \\, t_{\\mathrm{step}}=1.2\\,\\mathrm{s}$（检查点之间的计算时间）。$t_{\\mathrm{io,cp}}=0.5\\,\\mathrm{s}$（一个检查点的 I/O 时间）。\n\n**步骤 2：使用提取的给定条件进行验证**\n-   **科学基础**：该问题在计算地震学和科学计算领域有坚实的基础。它描述了标准的 L2 范数 FWI 问题，使用伴随状态法求解，这是一种基础且广泛应用的技术。使用检查点技术来处理时间可逆伴随计算中的内存-计算权衡也是一种标准且正确的实践。HPC 概念（域分解、震源级并行、异步 I/O、集体通信）的表述是准确的。\n-   **适定性**：目标清晰：识别出既在数学上正确又在计算上最快的工作流。所提供的参数虽然经过简化，但足以比较所提出工作流的相对性能。\n-   **客观性**：问题以精确、客观的语言陈述。\n\n**步骤 3：结论与行动**\n问题陈述在科学上是合理的、适定的且内部一致的。它呈现了一个计算科学中的有效场景。我将继续进行求解。\n\n### 推导与选项分析\n\n数学正确性检查的核心在于总梯度 $\\nabla J(m)$ 是如何计算的。给定残差泛函 $J(m) = \\sum_{s=1}^{N_s} J_s(m)$，微分算子线性的一个直接结果是，总梯度必须是各单源梯度的和：\n$$\n\\nabla J(m) = \\frac{\\delta J}{\\delta m} = \\sum_{s=1}^{N_s} \\frac{\\delta J_s}{\\delta m} = \\sum_{s=1}^{N_s} \\nabla J_s(m)\n$$\n每个单源梯度 $\\nabla J_s(m)$ 是通过伴随状态法计算的，该方法涉及为震源 $s$ 运行正演模拟以生成 $u_s$，然后为伴随场 $\\lambda_s$（由震源 $s$ 的数据残差驱动）运行伴随模拟，最后通过这两个场的时间积分互相关来形成梯度。任何不计算这个和的工作流在数学上都是不正确的。\n\n性能分析的核心是找出一个能够最大化并行度，并重叠计算、I/O 和通信以最小化总墙上时钟时间的工作流。\n\n**选项 A：顺序、同步 I/O 的工作流，带每震源阻塞式规约。**\n\n-   **数学正确性**：此工作流按顺序计算每个震源 $s$ 的梯度，并将其结果累加到一个运行总和中。这等同于计算 $\\nabla J(m) = \\sum_{s=1}^{N_s} \\nabla J_s(m)$。此方法在数学上是**正确**的。\n-   **性能分析**：此方法效率极低。\n    1.  **无震源并行**：它顺序处理 $N_s$ 个震源，未能利用最明显、最大粒度的可用并行性。\n    2.  **同步 I/O**：模拟在 $N_{cp} = T_{\\text{steps}}/k = 8000/100 = 80$ 个检查点间隔中的每一个处都会阻塞。正演运行的时间约为 $N_{cp} \\times (t_{\\mathrm{comp,int}} + t_{\\mathrm{io,cp}}) = 80 \\times (1.2\\,\\mathrm{s} + 0.5\\,\\mathrm{s}) = 136\\,\\mathrm{s}$。伴随运行也是如此。这为每个震源引入了 $80 \\times 0.5\\,\\mathrm{s} \\times 2 = 80\\,\\mathrm{s}$ 的空闲时间。\n    3.  **阻塞式通信**：在每个震源之后执行阻塞式 all-reduce，意味着整个系统在开始下一个震源之前等待通信完成。\n-   **结论**：**不满足要求**。虽然在数学上是合理的，但由于其顺序性和使用阻塞操作，它违反了最小化墙上时钟时间的标准。\n\n**选项 B：批处理、子通信域的工作流，带完全重叠的异步检查点 I/O 和每批次一次与计算重叠的非阻塞 all-reduce。**\n\n-   **数学正确性**：此工作流通过将 $P=64$ 个节点分成 $K=8$ 组，每组 $G=8$ 个节点，来并行化震源的计算。每组为一个震源计算梯度 $\\nabla J_s(m)$。在一批 $K$ 个震源处理完毕后，它们的梯度通过全局 all-reduce 求和。总梯度逐批累积。这正确地计算了 $\\sum_{s} \\nabla J_s(m)$。此方法在数学上是**正确**的。\n-   **性能分析**：该方法代表了一种先进的、高度优化的工作流。\n    1.  **震源并行**：它并发处理 $K=8$ 个震源，从而实现高吞吐量。\n    2.  **重叠的 I/O**：它使用异步 I/O。由于检查点之间的计算时间 ($t_{\\mathrm{comp,int}}=1.2\\,\\mathrm{s}$) 大于每个检查点的 I/O 时间 ($t_{\\mathrm{io,cp}}=0.5\\,\\mathrm{s}$)，I/O 成本可以被计算完全隐藏。正演和伴随运行的墙上时钟时间仅由计算决定，即 $2 \\times N_{cp} \\times t_{\\mathrm{comp,int}}$。扩展规则意味着对于 $G=8$ 的 $t_{\\mathrm{comp,int}}$ 会比 $G=64$ 的长，但由于 I/O 隐藏和通信开销的减少，每个震源的摊销时间明显优于选项 A。对于一批 $K=8$ 个震源，墙上时钟时间主要由一个震源在 $G=8$ 个节点上的计算决定。\n    3.  **重叠的通信**：一个批次的梯度规约使用非阻塞 all-reduce 执行，并与下一批次的正演模拟重叠。这隐藏了通信延迟。\n-   **结论**：**正确**。此选项既在数学上正确，又描述了一种最优的性能策略，符合所有陈述的目标。\n\n**选项 C：写入完整时间历史，使用单一复合伴随源和单次正演互相关。**\n\n-   **数学正确性**：该工作流建议通过将单个“复合”伴随场 $\\lambda_{\\text{total}} = \\sum_s \\lambda_s$ 与单个“复合”正演场 $u_{\\text{composite}}$ 互相关来计算梯度。真实的梯度是 $\\sum_s \\int \\lambda_s \\cdot (\\partial_m \\mathcal{L}) u_s \\, dt$。建议的计算是 $\\int (\\sum_s \\lambda_s) \\cdot (\\partial_m \\mathcal{L}) u_{\\text{composite}} \\, dt$。这两个表达式不相等。此过程错误地混合了来自不同震源和接收点的贡献，导致数学上不正确的梯度。此方法在数学上是**不正确**的。\n-   **性能分析**：将完整的 4-D 波场流式传输到磁盘的提议对于实际问题在计算上是不可行的。每个震源所需的存储将是 $T_{\\text{steps}} \\times P \\times (\\text{检查点大小}) = 8000 \\times 64 \\times 1\\,\\mathrm{GB} = 512\\,\\mathrm{TB}$。写入然后读取这些数据的 I/O 时间将是巨大的，远远超过使用检查点和重计算的方法。检查点技术正是为了克服这种高昂的成本而被发明的。\n-   **结论**：**不满足要求**。此选项在数学和性能两方面都有缺陷。\n\n**选项 D：批处理、异步工作流，在全局规约前用逐点最大值替换单源求和。**\n\n-   **数学正确性**：该工作流建议通过在每个网格点取绝对值最大值来组合批次内的单源梯度，而不是将它们相加。也就是说，它计算的量与 $\\max_{s \\in \\text{batch}} |\\nabla J_s(\\mathbf{x})|$ 成比例，而不是正确的 $\\sum_{s \\in \\text{batch}} \\nabla J_s(\\mathbf{x})$。这从根本上偏离了函数和的梯度的定义。产生的方向将不是残差 $J(m)$ 的下降方向，整个优化过程将失效。此方法在数学上是**不正确**的。\n-   **性能分析**：所述的动机是“减少规约成本”。然而，执行 max-reduction 与 sum-reduction 具有相同的通信量和模式。计算成本的差异也可以忽略不计。因此，这种修改在破坏梯度数学完整性的同时，并没有带来任何性能优势。\n-   **结论**：**不满足要求**。此选项在数学上不合理，其性能理由也毫无根据。\n\n### 结论\n\n只有选项 B 提出了一个既在数学上正确（计算 FWI 残差泛函的真实梯度），又在计算上最优（通过正确利用震源并行、异步 I/O 隐藏数据移动成本以及非阻塞集体通信重叠通信与计算）的工作流。选项 A 正确但效率低下。选项 C 和 D 在数学上不正确。",
            "answer": "$$\\boxed{B}$$"
        }
    ]
}