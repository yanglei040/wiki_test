{
    "hands_on_practices": [
        {
            "introduction": "逆时偏移（RTM）的基石是互相关成像条件。第一个练习将此原理解析为其数学本质，通过一个简化的单色波场景，揭示了最终的成像振幅如何关键性地依赖于源波场和接收波场的相位对齐关系。通过这个练习，你将巩固对互相关方法为何能有效成像的根本理解。",
            "id": "3603913",
            "problem": "在逆时偏移（RTM, Reverse Time Migration）中，一个常见的成像条件是通过在每个空间位置对震源波场和接收点波场进行零延迟互相关来形成图像。考虑一个固定空间点的单频场景，其中震源波场和接收点波场在足够长的、覆盖多个完整周期的记录时间内被建模为正弦函数。具体来说，设震源和接收点波场由下式给出\n$$\ns(\\mathbf{x},t)=A_{s}(\\mathbf{x})\\cos\\!\\big(\\omega t\\big),\\quad r(\\mathbf{x},t)=A_{r}(\\mathbf{x})\\cos\\!\\big(\\omega t+\\phi\\big),\n$$\n其中 $A_{s}(\\mathbf{x})$ 和 $A_{r}(\\mathbf{x})$ 是相对于振荡周期缓慢变化的实数振幅，$\\omega$ 是一个严格为正的角频率，$\\phi$ 是一个恒定的相位差，它编码了在给定位置外推的震源波场和接收点波场之间的运动学失配。假设在包含整数个周期的有限窗口 $[0,T]$ 上进行连续时间采集，或在多个周期上以采样间隔 $\\Delta t$ 进行等效的均匀采样离散时间采集。\n\n将 $\\mathbf{x}$ 处的零延迟互相关成像条件定义为\n$$\nI(\\mathbf{x})=\\int_{0}^{T}s(\\mathbf{x},t)\\,r(\\mathbf{x},t)\\,\\mathrm{d}t,\n$$\n或者，在离散情况下，为记录区间上相应的黎曼和近似。计算 $I(\\mathbf{x})$，忽略一个可能依赖于记录时长和采样的比例常数，并将您的最终答案表示为以 $A_{s}(\\mathbf{x})$、$A_{r}(\\mathbf{x})$ 和 $\\phi$ 表示的闭式解析表达式。然后，简要解释 $I(\\mathbf{x})$ 如何依赖于相位 $\\phi$。您的最终答案必须仅为所要求的解析表达式，不带单位，也无额外评注。不要四舍五入；不需要进行数值计算。",
            "solution": "该问题陈述经核实具有科学依据、问题适定且客观。它提供了一个标准的简化模型，用以分析地震成像中的一个基本概念——逆时偏移（RTM）中的零延迟互相关成像条件。所有必要元素都已提供，可得唯一解。\n\n成像条件 $I(\\mathbf{x})$ 定义为震源波场 $s(\\mathbf{x},t)$ 和接收点波场 $r(\\mathbf{x},t)$ 在时间区间 $[0,T]$ 上的零延迟互相关。在固定的空间点 $\\mathbf{x}$ 处，这由以下积分给出：\n$$\nI(\\mathbf{x}) = \\int_{0}^{T} s(\\mathbf{x},t) \\, r(\\mathbf{x},t) \\, \\mathrm{d}t\n$$\n问题给出了波场的单频形式：\n$$\ns(\\mathbf{x},t) = A_{s}(\\mathbf{x})\\cos(\\omega t)\n$$\n$$\nr(\\mathbf{x},t) = A_{r}(\\mathbf{x})\\cos(\\omega t + \\phi)\n$$\n其中 $A_{s}(\\mathbf{x})$ 和 $A_{r}(\\mathbf{x})$ 是振幅，$\\omega$ 是角频率，$\\phi$ 是相位差。将这些表达式代入 $I(\\mathbf{x})$ 的积分中，得到：\n$$\nI(\\mathbf{x}) = \\int_{0}^{T} \\left[ A_{s}(\\mathbf{x})\\cos(\\omega t) \\right] \\left[ A_{r}(\\mathbf{x})\\cos(\\omega t + \\phi) \\right] \\mathrm{d}t\n$$\n振幅 $A_{s}(\\mathbf{x})$ 和 $A_{r}(\\mathbf{x})$ 仅是空间坐标 $\\mathbf{x}$ 的函数。由于积分是关于时间 $t$ 的，这些振幅可以视为常数并移到积分符号外：\n$$\nI(\\mathbf{x}) = A_{s}(\\mathbf{x}) A_{r}(\\mathbf{x}) \\int_{0}^{T} \\cos(\\omega t) \\cos(\\omega t + \\phi) \\, \\mathrm{d}t\n$$\n为计算该积分，我们使用积化和差三角恒等式 $\\cos(A)\\cos(B) = \\frac{1}{2}[\\cos(A-B) + \\cos(A+B)]$。令 $A = \\omega t$ 和 $B = \\omega t + \\phi$。则被积函数变为：\n$$\n\\cos(\\omega t) \\cos(\\omega t + \\phi) = \\frac{1}{2} \\left[ \\cos(\\omega t - (\\omega t + \\phi)) + \\cos(\\omega t + (\\omega t + \\phi)) \\right]\n$$\n$$\n= \\frac{1}{2} \\left[ \\cos(-\\phi) + \\cos(2\\omega t + \\phi) \\right]\n$$\n由于余弦函数是偶函数，$\\cos(-\\phi) = \\cos(\\phi)$。被积函数简化为：\n$$\n\\frac{1}{2} \\left[ \\cos(\\phi) + \\cos(2\\omega t + \\phi) \\right]\n$$\n现在，我们将其代回 $I(\\mathbf{x})$ 的表达式中：\n$$\nI(\\mathbf{x}) = A_{s}(\\mathbf{x}) A_{r}(\\mathbf{x}) \\int_{0}^{T} \\frac{1}{2} \\left[ \\cos(\\phi) + \\cos(2\\omega t + \\phi) \\right] \\mathrm{d}t\n$$\n我们可以将其分解为两个独立的积分：\n$$\nI(\\mathbf{x}) = \\frac{A_{s}(\\mathbf{x}) A_{r}(\\mathbf{x})}{2} \\left[ \\int_{0}^{T} \\cos(\\phi) \\, \\mathrm{d}t + \\int_{0}^{T} \\cos(2\\omega t + \\phi) \\, \\mathrm{d}t \\right]\n$$\n第一个积分很简单，因为 $\\cos(\\phi)$ 是关于 $t$ 的常数：\n$$\n\\int_{0}^{T} \\cos(\\phi) \\, \\mathrm{d}t = \\cos(\\phi) [t]_{0}^{T} = T\\cos(\\phi)\n$$\n第二个积分是：\n$$\n\\int_{0}^{T} \\cos(2\\omega t + \\phi) \\, \\mathrm{d}t = \\left[ \\frac{\\sin(2\\omega t + \\phi)}{2\\omega} \\right]_{0}^{T} = \\frac{1}{2\\omega} \\left[ \\sin(2\\omega T + \\phi) - \\sin(\\phi) \\right]\n$$\n问题陈述指出积分区间 $T$ 包含整数个周期。波的周期为 $T_{p} = \\frac{2\\pi}{\\omega}$。因此，对于某个整数 $n \\ge 1$，有 $T = n T_{p} = n \\frac{2\\pi}{\\omega}$。我们使用此条件来简化第二个积分的结果。项 $2\\omega T$ 变为：\n$$\n2\\omega T = 2\\omega \\left( n \\frac{2\\pi}{\\omega} \\right) = 4n\\pi\n$$\n由于正弦函数是 $2\\pi$ 周期的，$\\sin(4n\\pi + \\phi) = \\sin(\\phi)$。第二个积分的值为零：\n$$\n\\frac{1}{2\\omega} \\left[ \\sin(4n\\pi + \\phi) - \\sin(\\phi) \\right] = \\frac{1}{2\\omega} \\left[ \\sin(\\phi) - \\sin(\\phi) \\right] = 0\n$$\n这个结果是将一个正弦函数在其整数个周期上积分的结果。函数 $\\cos(2\\omega t + \\phi)$ 的周期是 $\\frac{2\\pi}{2\\omega} = \\frac{\\pi}{\\omega}$。由于 $T = n \\frac{2\\pi}{\\omega}$，它包含了 $2n$ 个 $\\cos(2\\omega t + \\phi)$ 的完整周期，因此其在 $[0,T]$ 上的积分恰好为零。\n\n结合这些结果，$I(\\mathbf{x})$ 的表达式为：\n$$\nI(\\mathbf{x}) = \\frac{A_{s}(\\mathbf{x}) A_{r}(\\mathbf{x})}{2} [T\\cos(\\phi) + 0] = \\frac{T}{2} A_{s}(\\mathbf{x}) A_{r}(\\mathbf{x}) \\cos(\\phi)\n$$\n问题要求结果忽略一个可能依赖于记录时长 $T$ 的比例常数。项 $\\frac{T}{2}$ 就是这样一个常数。因此，成像条件与振幅的乘积以及相位差的余弦成正比：\n$$\nI(\\mathbf{x}) \\propto A_{s}(\\mathbf{x}) A_{r}(\\mathbf{x}) \\cos(\\phi)\n$$\n表示此关系的解析表达式是 $A_{s}(\\mathbf{x}) A_{r}(\\mathbf{x}) \\cos(\\phi)$。\n\n图像 $I(\\mathbf{x})$ 对相位 $\\phi$ 的依赖性至关重要。项 $\\cos(\\phi)$ 起到相干因子的作用。当对于任意整数 $k$ 有 $\\phi = 2k\\pi$ 时，图像达到最大正值，这表明震源波场和接收点波场完全同相。在RTM中，这对应于 $\\mathbf{x}$ 位于反射界面上的高可能性，在该点，正向传播的震源场和反向传播的接收场在时间上重合。当 $\\phi = \\frac{\\pi}{2} + k\\pi$ 时，图像为零，意味着波场是正交的（相位相差90度），它们随时间的互相关为零。当 $\\phi = \\pi + 2k\\pi$ 时，图像的幅度最大但为负值，此时波场完全反相。因此，成像条件选择性地增强了波场发生相长干涉的位置。",
            "answer": "$$\n\\boxed{A_{s}(\\mathbf{x})A_{r}(\\mathbf{x})\\cos(\\phi)}\n$$"
        },
        {
            "introduction": "虽然互相关成像功能强大，但它也可能将任何恰好在时空上重合的波场相关起来，从而产生伪影。本练习引入了一个更智能的成像条件，通过检查波场的局部传播方向来滤除非物理的互相关，特别是反向散射能量。这个练习演示了如何通过融入更多的物理约束来提高成像质量。",
            "id": "3603875",
            "problem": "给定一个二维常密度声学介质，其波速 $c$ 为常数。您需要设计并评估一种逆时偏移的成像条件，该条件利用基于局部波数矢量点积的极性测试来消除反向散射能量。设震源波场表示为 $u_s(\\mathbf{x},t)$，接收点波场表示为 $u_r(\\mathbf{x},t)$。考虑标准的零延迟互相关成像条件 $I_0(\\mathbf{x})=\\int u_s(\\mathbf{x},t)\\,u_r(\\mathbf{x},t)\\,dt$ 以及经过极性测试滤波的成像条件\n$$\nI(\\mathbf{x})=\\int \\chi\\Big[(\\mathbf{k}_s(\\mathbf{x},t)\\cdot \\mathbf{k}_r(\\mathbf{x},t))>0\\Big]\\;u_s(\\mathbf{x},t)\\,u_r(\\mathbf{x},t)\\,dt,\n$$\n其中 $\\chi[\\cdot]$ 是指示函数，当其参数为真时取值为 1，否则为 0；$\\mathbf{k}_s(\\mathbf{x},t)$ 和 $\\mathbf{k}_r(\\mathbf{x},t)$ 分别是震源波场和接收点波场的局部波数矢量，通过局部位相梯度定义。\n\n假设在一个均匀介质中，自由表面 $z=0$ 下方深度 $z>0$ 处有一个水平反射体，一个点源位于表面坐标 $x=-H/2$ 处，一个接收器位于表面坐标 $x=+H/2$ 处，其中 $H\\ge 0$ 是炮检距。在这些假设下，设成像点位于镜反射点 $(x=0,z)$。对于每个测试用例，假设在成像点处，震源波场和反向传播的接收点波场是窄带单色信号，具有相等的角频率 $\\omega=2\\pi f$ 和相对相位 $\\phi$，即：\n$$\nu_s(\\mathbf{x},t)=\\cos(\\omega t),\\qquad u_r(\\mathbf{x},t)=\\cos(\\omega t+\\phi),\n$$\n并且成像积分在 $N$ 个完整周期上进行计算，即 $t\\in[0,NT]$，其中 $T=2\\pi/\\omega$ 且整数 $N\\ge 1$。角度必须以弧度为单位。距离必须以米为单位。频率必须以赫兹为单位。时间必须以秒为单位。\n\n您的任务是：\n- 从声波方程和标准零延迟成像条件的定义出发，通过比较由 $\\mathbf{k}_s(\\mathbf{x},t)$ 和 $\\mathbf{k}_r(\\mathbf{x},t)$ 编码的局部传播方向，论证极性测试滤波成像条件作为一种反向散射抑制机制的合理性。\n- 对于所描述的均匀水平分层几何结构，根据第一性原理，推导出成像点 $(x=0,z)$ 处 $\\mathbf{k}_s$ 和 $\\mathbf{k}_r$ 的单位方向矢量（用 $z$ 和 $H$ 表示），并用 $z$ 和 $H$ 表示它们的点积。\n- 利用以上结果，确定使 $\\chi[(\\mathbf{k}_s\\cdot\\mathbf{k}_r)>0]$ 等于 1 时 $z$ 和 $H$ 需要满足的条件，并分析其对 $z$ 相对于 $H$ 较小的浅层反射体的影响。\n- 对于指定的单色信号，计算 $I(\\mathbf{x})$ 在 $N$ 个完整周期上的积分，并报告由下式定义的归一化滤波成像振幅\n$$\nA=\\frac{I(\\mathbf{x})}{(NT)/2},\n$$\n作为极性测试和相位 $\\phi$ 的函数。请注意，在给定假设下，$A$ 是无量纲的，并且仅取决于指示函数的结果和 $\\phi$。\n\n实现一个程序，针对以下测试套件，为每个用例计算 $A$ 的值（单个浮点数）：\n- 案例 1（理想情况，深层反射体）：一次反射几何结构，$z=1000\\,\\text{m}$，$H=1000\\,\\text{m}$，$f=10\\,\\text{Hz}$，$N=10$，$\\phi=0\\,\\text{rad}$。\n- 案例 2（浅层反射体，大炮检距）：一次反射几何结构，$z=100\\,\\text{m}$，$H=1000\\,\\text{m}$，$f=10\\,\\text{Hz}$，$N=10$，$\\phi=0\\,\\text{rad}$。\n- 案例 3（边界条件）：一次反射几何结构，$z=250\\,\\text{m}$，$H=500\\,\\text{m}$，$f=10\\,\\text{Hz}$，$N=10$，$\\phi=0\\,\\text{rad}$。\n- 案例 4（零炮检距）：一次反射几何结构，$z=500\\,\\text{m}$，$H=0\\,\\text{m}$，$f=10\\,\\text{Hz}$，$N=10$，$\\phi=0\\,\\text{rad}$。\n- 案例 5（显式反向散射抑制）：成像点处的非镜面反射、反向散射波对，具有相反的垂直极性（模型中 $\\mathbf{k}_s$ 垂直下行，$\\mathbf{k}_r$ 垂直上行），$z=500\\,\\text{m}$，$H=500\\,\\text{m}$，$f=10\\,\\text{Hz}$，$N=10$，$\\phi=0\\,\\text{rad}$。\n- 案例 6（相位敏感性）：与案例 1 相同，但 $\\phi=\\pi\\,\\text{rad}$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，$[a_1,a_2,\\dots]$），列表中的每个条目是按上述顺序列出的相应案例计算出的 $A$ 值。$A$ 的值必须报告为浮点数（无量纲）。角度输入和输出必须使用弧度。距离必须以米为单位。频率必须以赫兹为单位。时间必须以秒为单位。不应打印任何额外文本。",
            "solution": "该问题是有效的，因为它在科学上基于波传播和地震成像的原理，问题陈述清晰，提供了所有必要信息，并以客观、正式的语言表述。我们可以着手提供完整的解决方案。\n\n解决方案分为四个部分，对应问题陈述中列出的任务。\n\n### 1. 极性测试滤波器的合理性论证\n\n常密度声波方程控制着震源波场 $u_s(\\mathbf{x},t)$ 和接收点波场 $u_r(\\mathbf{x},t)$ 的传播。在均匀介质中，解可以表示为形如 $\\exp[i(\\mathbf{k}\\cdot\\mathbf{x} - \\omega t)]$ 的平面波的叠加。这种波的相位是 $\\Phi(\\mathbf{x},t) = \\mathbf{k}\\cdot\\mathbf{x} - \\omega t$。局部波数矢量 $\\mathbf{k}$ 定义为相位的空间梯度，即 $\\mathbf{k} = \\nabla\\Phi$，它指向波的传播方向。其大小通过频散关系 $|\\mathbf{k}| = \\omega/c$ 与角频率 $\\omega$ 和介质波速 $c$ 相关。\n\n地震成像的基本原理，通常称为成像原理，指出在地下某一点，当一个下行波转换为一个上行波时，该点存在一个反射体。逆时偏移（RTM）通过将正向传播的震源波场 $u_s$ 与时间反转、反向传播的接收点波场 $u_r$ 进行互相关来实现这一原理。\n\n- 震源波场 $u_s(\\mathbf{x},t)$ 从震源正向时间传播。在反射体处，它是一个下行波（在典型的地面勘探几何中）。因此，其局部波数矢量 $\\mathbf{k}_s$ 将有一个指向深度增加方向的分量。\n- 接收点波场 $u_r(\\mathbf{x},t)$ 是由向上反射的波在地面记录得到的。在RTM中，这个记录的场被用作边界条件并进行反向时间传播。一个物理上的上行波在反向时间传播时会变成一个下行波。因此，在反射体处，反向传播的接收点波场也是一个下行波，其局部波数矢量 $\\mathbf{k}_r$ 也指向深度增加的方向。\n\n对于一次反射，成像点处的 $\\mathbf{k}_s$ 和 $\\mathbf{k}_r$ 都代表下行场，因此指向相似的方向（即，指向同一个半空间）。它们之间的夹角是锐角，这意味着它们的点积为正：$\\mathbf{k}_s \\cdot \\mathbf{k}_r > 0$。\n\n相反，偏移假象可能源于在成像点处不对应于一次反射事件的波的互相关。这类假象的一个常见来源是下行波与恰好同时穿过同一点的上行波的相关。在这种情况下，$\\mathbf{k}_s$ 会指向下方，而波场中物理上的上行部分的传播矢量会指向上方。RTM算法将 $u_s$ 与时间反转的 $u_r$ 进行相关，但局部传播方向矢量 $\\mathbf{k}_r$ 通常是在其自身传播时间线上根据时间反转的场计算的。如果这对应于一个物理上的上行波，其方向矢量将与下行震源波的方向相反。因此，$\\mathbf{k}_s$ 和 $\\mathbf{k}_r$ 将指向相反方向，导致点积为负：$\\mathbf{k}_s \\cdot \\mathbf{k}_r < 0$。\n\n指示函数 $\\chi[(\\mathbf{k}_s \\cdot \\mathbf{k}_r) > 0]$ 充当一个滤波器。它保留了传播方向相似（反射的特征）的波场对图像的贡献，并抑制了传播方向相反（偏移假象的特征）的波场的贡献。这种方法是实现角度域成像条件的一种方式，可以有效消除反向散射噪声和由伪相关引起的其他假象。\n\n### 2. 单位方向矢量及其点积的推导\n\n几何结构包括一个位于 $\\mathbf{x}_s = (-H/2, 0)$ 的震源，一个位于 $\\mathbf{x}_r = (H/2, 0)$ 的接收器，以及一个位于 $\\mathbf{x} = (0, z)$ 的成像点。介质是均匀的。\n\n震源波场从震源 $\\mathbf{x}_s$ 传播到成像点 $\\mathbf{x}$。传播方向由矢量 $\\vec{v}_s = \\mathbf{x} - \\mathbf{x}_s = (0 - (-H/2), z - 0) = (H/2, z)$ 给出。单位方向矢量 $\\hat{\\mathbf{k}}_s$ 为：\n$$\n\\hat{\\mathbf{k}}_s = \\frac{\\vec{v}_s}{|\\vec{v}_s|} = \\frac{(H/2, z)}{\\sqrt{(H/2)^2 + z^2}}\n$$\n接收点波场从接收器 $\\mathbf{x}_r$ 反向传播到成像点 $\\mathbf{x}$。此反向传播场的传播方向由矢量 $\\vec{v}_r = \\mathbf{x} - \\mathbf{x}_r = (0 - H/2, z - 0) = (-H/2, z)$ 给出。单位方向矢量 $\\hat{\\mathbf{k}}_r$ 为：\n$$\n\\hat{\\mathbf{k}}_r = \\frac{\\vec{v}_r}{|\\vec{v}_r|} = \\frac{(-H/2, z)}{\\sqrt{(-H/2)^2 + z^2}}\n$$\n这些单位方向矢量的点积为：\n$$\n\\hat{\\mathbf{k}}_s \\cdot \\hat{\\mathbf{k}}_r = \\frac{(H/2, z) \\cdot (-H/2, z)}{(\\sqrt{(H/2)^2 + z^2})^2} = \\frac{(H/2)(-H/2) + z \\cdot z}{(H/2)^2 + z^2} = \\frac{z^2 - H^2/4}{z^2 + H^2/4}\n$$\n局部波数矢量为 $\\mathbf{k}_s = |\\mathbf{k}_s|\\hat{\\mathbf{k}}_s$ 和 $\\mathbf{k}_r = |\\mathbf{k}_r|\\hat{\\mathbf{k}}_r$。由于波场是单色的，在恒定速度 $c$ 的介质中具有相同的频率 $\\omega$，因此它们的波数大小相等：$|\\mathbf{k}_s| = |\\mathbf{k}_r| = \\omega/c$。因此，它们的点积为：\n$$\n\\mathbf{k}_s \\cdot \\mathbf{k}_r = \\left(\\frac{\\omega}{c}\\right)^2 (\\hat{\\mathbf{k}}_s \\cdot \\hat{\\mathbf{k}}_r) = \\left(\\frac{\\omega}{c}\\right)^2 \\frac{z^2 - H^2/4}{z^2 + H^2/4}\n$$\n\n### 3. 极性测试的条件及其影响\n\n极性测试条件是 $(\\mathbf{k}_s \\cdot \\mathbf{k}_r) > 0$。根据上面推导的表达式，项 $(\\omega/c)^2$ 是严格为正的，对于任何物理配置（$z>0$），分母 $(z^2 + H^2/4)$ 也是严格为正的。因此，点积的符号仅由分子决定：\n$$\nz^2 - \\frac{H^2}{4} > 0\n$$\n该不等式可以重新排列为 $z^2 > H^2/4$。由于深度 $z$ 和炮检距 $H$ 是非负的，这等效于：\n$$\nz > \\frac{H}{2}\n$$\n当 $z > H/2$ 时，指示函数 $\\chi[(\\mathbf{k}_s\\cdot \\mathbf{k}_r)>0]$ 等于 1，否则为 0。\n\n这个条件对成像有重要影响，特别是对于浅层反射体。成像点处相对于垂直方向的反射角 $\\theta$ 由 $\\tan(\\theta) = (H/2)/z$ 给出。条件 $z > H/2$ 等价于 $(H/2)/z < 1$，这意味着 $\\tan(\\theta) < 1$，即 $\\theta < \\pi/4$ ($45^\\circ$）。\n\n对于相对于炮检距（大 $H$）而言的浅层反射体（小 $z$），可能会出现 $z \\le H/2$ 的情况。在这种情况下，反射角很大（$\\theta \\ge 45^\\circ$），点积变为非正值，指示函数计算结果为 0。极性测试充当大角度滤波器或“切除”，自动将大角度反射的贡献置零。这有助于防止与回转波和假频相关的成像假象（这些假象在大角度时更普遍），但也可能导致长炮检距数据在浅层部分丢失图像信息。\n\n### 4. 归一化成像振幅的评估\n\n经过滤波的成像条件由下式给出：\n$$\nI(\\mathbf{x})=\\int_0^{NT} \\chi\\Big[(\\mathbf{k}_s(\\mathbf{x},t)\\cdot \\mathbf{k}_r(\\mathbf{x},t))>0\\Big]\\;u_s(\\mathbf{x},t)\\,u_r(\\mathbf{x},t)\\,dt\n$$\n对于给定的成像点几何结构 $(z, H)$，指示函数 $\\chi$ 的值在积分时间内是恒定的。波场由 $u_s(\\mathbf{x},t)=\\cos(\\omega t)$ 和 $u_r(\\mathbf{x},t)=\\cos(\\omega t+\\phi)$ 给出。\n$$\nI(\\mathbf{x}) = \\chi \\int_0^{NT} \\cos(\\omega t) \\cos(\\omega t+\\phi) \\,dt\n$$\n使用积化和差三角恒等式 $\\cos A \\cos B = \\frac{1}{2}[\\cos(A-B) + \\cos(A+B)]$，被积函数变为：\n$$\n\\cos(\\omega t) \\cos(\\omega t+\\phi) = \\frac{1}{2}[\\cos(-\\phi) + \\cos(2\\omega t + \\phi)] = \\frac{1}{2}[\\cos(\\phi) + \\cos(2\\omega t + \\phi)]\n$$\n积分为：\n$$\nI(\\mathbf{x}) = \\frac{\\chi}{2} \\int_0^{NT} [\\cos(\\phi) + \\cos(2\\omega t + \\phi)] \\,dt = \\frac{\\chi}{2} \\left[ t\\cos(\\phi) + \\frac{1}{2\\omega}\\sin(2\\omega t + \\phi) \\right]_0^{NT}\n$$\n在积分上下限处求值，注意 $T=2\\pi/\\omega$，所以 $\\omega T = 2\\pi$：\n$$\nI(\\mathbf{x}) = \\frac{\\chi}{2} \\left\\{ \\left( NT\\cos(\\phi) + \\frac{1}{2\\omega}\\sin(2\\omega NT + \\phi) \\right) - \\left( 0 + \\frac{1}{2\\omega}\\sin(\\phi) \\right) \\right\\}\n$$\n项 $2\\omega NT = 2(2\\pi/T) NT = 4\\pi N$。由于 $\\sin$ 函数是 $2\\pi$ 周期的，且 $N$ 是整数，因此 $\\sin(4\\pi N + \\phi) = \\sin(\\phi)$。正弦项相互抵消。\n$$\nI(\\mathbf{x}) = \\frac{\\chi}{2} (NT \\cos(\\phi)) = \\chi \\left( \\frac{NT}{2} \\right) \\cos(\\phi)\n$$\n归一化滤波成像振幅 $A$ 定义为 $A = I(\\mathbf{x}) / (NT/2)$。\n$$\nA = \\frac{\\chi \\left( \\frac{NT}{2} \\right) \\cos(\\phi)}{ \\frac{NT}{2} } = \\chi \\cos(\\phi)\n$$\n其中对于一次反射，如果 $z > H/2$，则 $\\chi = 1$；如果 $z \\le H/2$，则 $\\chi = 0$。对于明确定义的反向散射情况，根据定义，点积为负，所以 $\\chi=0$。$A$ 的计算与 $f$ 和 $N$ 无关。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the normalized imaging amplitude A for a series of test cases\n    based on a polarity-filtered imaging condition in reverse-time migration.\n    \"\"\"\n\n    test_cases = [\n        # (z, H, phi, is_backscatter)\n        # Case 1: happy path, deep reflector\n        (1000.0, 1000.0, 0.0, False),\n        # Case 2: shallow reflector, large offset\n        (100.0, 1000.0, 0.0, False),\n        # Case 3: boundary condition\n        (250.0, 500.0, 0.0, False),\n        # Case 4: zero-offset\n        (500.0, 0.0, 0.0, False),\n        # Case 5: explicit backscatter rejection\n        # z, H values are for context; the backscatter flag dictates the result.\n        (500.0, 500.0, 0.0, True),\n        # Case 6: phase sensitivity\n        (1000.0, 1000.0, np.pi, False),\n    ]\n\n    results = []\n    for case in test_cases:\n        z, H, phi, is_backscatter = case\n        \n        # The indicator function chi determines if the imaging condition contributes.\n        # chi is 1 if (k_s . k_r) > 0, and 0 otherwise.\n        \n        chi = 0.0\n        if is_backscatter:\n            # For the backscatter case, k_s and k_r are defined to be in\n            # opposite directions, so their dot product is negative. \n            # The condition (k_s . k_r) > 0 is false.\n            chi = 0.0\n        else:\n            # For primary reflections, the condition (k_s . k_r) > 0 simplifies\n            # to the geometric condition z > H/2.\n            # The problem statement implies a strict inequality > 0.\n            if z > H / 2.0:\n                chi = 1.0\n            else:\n                chi = 0.0\n        \n        # The normalized amplitude A is given by A = chi * cos(phi).\n        # The parameters f (frequency) and N (number of periods) cancel out\n        # in the normalization.\n        A = chi * np.cos(phi)\n        results.append(A)\n\n    # Format the output as a comma-separated list in square brackets.\n    # Using 'g' format specifier to handle floating point representation neatly.\n    formatted_results = [f\"{r:.1f}\" for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "正如第一个练习所揭示的，传统成像方法对相位高度敏感。真实世界的波在穿过复杂介质时会产生相位畸变，这会降低标准互相关成像的质量。最后一个练习探索了一种先进的相位自适应成像条件，该条件利用信号处理技术来应对这类畸变，从而保持成像的稳健性。这个练习将让你亲手体验用于增强复杂地质环境下成像效果的现代方法。",
            "id": "3603940",
            "problem": "在计算地球物理学中偏移成像条件的背景下，您需要处理以下问题：地下图像是通过在每个候选成像点组合震源传播的波场和检波器传播的波场而形成的。从偏移依赖于震源波场和检波器波场相干性这一原理出发，您必须推导、实现并测试一个对由各向异性和衰减引起的相位畸变具有稳健性的相位自适应成像条件。\n\n基本原理：\n- 标准互相关成像条件使用成像点处的震源波场 $u_s(t)$ 和检波器波场 $u_r(t)$，通过对它们的乘积进行时间积分来计算成像值。当两个波场相位对齐时，该方法可以捕捉到相干到达。\n- 实值时间序列 $u(t)$ 的解析信号为 $a(t) = u(t) + i \\,\\mathcal{H}\\{u(t)\\}$，其中 $\\mathcal{H}\\{\\cdot\\}$ 表示希尔伯特变换。瞬时振幅（包络）为 $|a(t)|$，瞬时相位为 $\\phi(t) = \\arg(a(t))$，两者都是逐时间点定义的。\n- 数值计算用离散时间求和乘以采样间隔 $\\Delta t$ 来代替连续时间积分。\n\n任务：\n1. 基于上述原理，推导一个成像条件。该条件利用震源波场和检波器波场之间的瞬时相位差，对每个时间样本的贡献进行自适应加权，确保在相位匹配时实现相长累加，在相位不同时抑制相消干涉。您的推导必须明确使用解析信号中的瞬时相位和振幅概念，并且必须表示为采样间隔为 $\\Delta t$ 的关于 $t$ 的离散时间求和形式。\n2. 实现一个合成测试，其中单个成像点处的震源波场 $u_s(t)$ 被建模为一个由高斯调制的余弦函数给出的带限脉冲：\n   $$u_s(t) = \\exp\\!\\Big(-\\frac{(t - t_0)^2}{2\\sigma^2}\\Big)\\,\\cos\\!\\big(2\\pi f_0 (t - t_0)\\big),$$\n   其中 $t$ 是时间（秒），$t_0$ 是脉冲中心（秒），$\\sigma$ 是包络宽度（秒），$f_0$ 是中心频率（赫兹）。\n3. 通过对 $u_s(t)$ 施加受控畸变来构造检波器波场 $u_r(t)$，以模拟各向异性和衰减：\n   - 各向异性引起的相位扭曲：定义一个时间重映射 $t' = t + a\\,(t - t_0)^2$，其中 $a$ 的单位是 $\\text{s}^{-1}$，并使用离散网格上的插值设置 $u_r(t) = u_s(t')$。这模拟了与方向相关的相速度变化。\n   - 衰减和频散：在频域（通过快速傅里叶变换 (FFT)），应用一个振幅滤波器 $A(f) = \\exp(-\\alpha |f|)$ 和一个频散相位滤波器 $\\Psi(f) = \\exp\\!\\big(i\\,2\\pi \\kappa f^2\\big)$，其中 $f$ 是频率（赫兹），$\\alpha$ 是一个单位为 $\\text{Hz}^{-1}$ 的非负衰减参数，$\\kappa$ 是一个单位为 $\\text{s}^2$ 的非负频散参数。再变换回时域以获得衰减和频散后的 $u_r(t)$。\n4. 对于每个测试用例，计算单个成像点处的两个标量成像值：\n   - 标准互相关成像：\n     $$I_{\\text{cc}} = \\sum_{n=0}^{N-1} u_s(t_n)\\,u_r(t_n)\\,\\Delta t,$$\n     其中 $t_n$ 表示采样时间，$N$ 是样本数。\n   - 在任务1中推导的相位自适应成像，必须使用通过希尔伯特变换提取的瞬时相位和包络。\n5. 为每个测试用例定义并计算一个无量纲性能指标：\n   $$M = \\frac{|I_{\\text{adaptive}}|}{|I_{\\text{cc}}| + \\varepsilon},$$\n   其中 $I_{\\text{adaptive}}$ 是您的相位自适应成像值，$I_{\\text{cc}}$ 是标准互相关成像值，$\\varepsilon$ 是一个用于防止除以零的微小正常数。角度必须使用弧度；时间单位为秒；频率单位为赫兹；最终的 $M$ 是无单位的。\n6. 对所有测试用例使用以下固定的信号参数：总时长 $T = 1.0$ 秒，采样间隔 $\\Delta t = 0.001$ 秒，脉冲中心 $t_0 = 0.50$ 秒，包络宽度 $\\sigma = 0.05$ 秒，以及中心频率 $f_0 = 25$ 赫兹。\n7. 评估以下畸变参数 $(a,\\alpha,\\kappa)$ 的测试套件：\n   - 用例1（基准线，理想情况）：$(a = 0.0\\,\\text{s}^{-1},\\;\\alpha = 0.0\\,\\text{Hz}^{-1},\\;\\kappa = 0.0\\,\\text{s}^2)$。\n   - 用例2（仅各向异性）：$(a = 0.4\\,\\text{s}^{-1},\\;\\alpha = 0.0\\,\\text{Hz}^{-1},\\;\\kappa = 0.0\\,\\text{s}^2)$。\n   - 用例3（衰减和频散）：$(a = 0.0\\,\\text{s}^{-1},\\;\\alpha = 0.008\\,\\text{Hz}^{-1},\\;\\kappa = 8\\times 10^{-7}\\,\\text{s}^2)$。\n   - 用例4（组合畸变）：$(a = 0.5\\,\\text{s}^{-1},\\;\\alpha = 0.010\\,\\text{Hz}^{-1},\\;\\kappa = 1.5\\times 10^{-6}\\,\\text{s}^2)$。\n8. 您的程序必须：\n   - 计算每个用例的 $I_{\\text{cc}}$ 和 $I_{\\text{adaptive}}$。\n   - 计算每个用例的性能指标 $M$，其中 $\\varepsilon$ 选择一个固定的微小常数（例如，$\\varepsilon = 10^{-12}$）。\n   - 生成单行输出，其中包含四个性能指标，按上述用例的顺序排列，以逗号分隔并用方括号括起来，四舍五入到六位小数，例如 $[m_1,m_2,m_3,m_4]$。\n\n角度单位要求：所有相位和三角函数必须使用弧度。\n时间和频率单位：时间以秒为单位，频率以赫兹为单位。\n最终输出格式要求：您的程序应生成单行输出，其中包含结果，格式为逗号分隔的列表并用方括号括起来（例如 $[m_1,m_2,m_3,m_4]$）。",
            "solution": "该问题是有效的。它在科学上基于应用于地球物理成像的波传播和信号处理原理，是适定的，提供了所有必要的数据和约束条件，并以客观、可形式化的语言陈述。\n\n解决方案分两个阶段进行：首先，推导相位自适应成像条件；其次，为指定的测试用例设计数值实现。\n\n**1. 相位自适应成像条件的推导**\n\n地震偏移的基本原理是通过量化地下每一点处正向传播的震源波场 $u_s(t)$ 和反向传播的检波器波场 $u_r(t)$ 之间的相干性来形成图像。标准互相关成像条件 $I_{\\text{cc}}$ 通过对两个实值波场的乘积进行积分来实现这一点：\n$$I_{\\text{cc}} = \\int u_s(t) u_r(t) dt$$\n当两个波场完全同相时，该积分值最大；而任何由各向异性或衰减等物理效应引起的相位失配都会使其劣化。\n\n为了推导出一个更稳健的条件，我们使用解析信号来表示波场。实值波场 $u(t)$ 的解析信号是一个复值信号 $a(t)$，由下式给出：\n$$a(t) = u(t) + i\\,\\mathcal{H}\\{u(t)\\}$$\n其中 $\\mathcal{H}\\{\\cdot\\}$ 是希尔伯特变换。这使我们能够以极坐标形式表示 $a(t)$，从而分离出其瞬时振幅（包络）$A(t)$ 和瞬时相位 $\\phi(t)$：\n$$a(t) = A(t) e^{i\\phi(t)}$$\n其中 $A(t) = |a(t)|$，$\\phi(t) = \\arg(a(t))$。\n\n因此，震源和检波器波场可以写为：\n$$a_s(t) = A_s(t) e^{i\\phi_s(t)}$$\n$$a_r(t) = A_r(t) e^{i\\phi_r(t)}$$\n实值波场是这些信号的实部：$u_s(t) = \\Re\\{a_s(t)\\} = A_s(t)\\cos(\\phi_s(t))$ 和 $u_r(t) = \\Re\\{a_r(t)\\} = A_r(t)\\cos(\\phi_r(t))$。\n\n问题要求一个成像条件，该条件能基于瞬时相位差 $\\Delta\\phi(t) = \\phi_s(t) - \\phi_r(t)$ 自适应地对贡献进行加权。一个能够捕捉相位相干性的自然选择是加权因子 $\\cos(\\Delta\\phi(t))$。对于完美的相位对齐，该因子为 $1$；对于反相对齐（相消干涉），该因子为 $-1$；对于正交相位，该因子为 $0$。通过将信号包络的乘积 $A_s(t)A_r(t)$ 乘以该相干性因子，我们构成了一个直接测量经过相位校正的相干性的被积函数。\n\n由此产生的相位自适应成像条件 $I_{\\text{adaptive}}$ 是该量的积分：\n$$I_{\\text{adaptive}} = \\int A_s(t) A_r(t) \\cos(\\phi_s(t) - \\phi_r(t)) dt$$\n该公式等效于对解析信号互相关的实部进行积分，即 $\\int \\Re\\{a_s(t) a_r^*(t)\\} dt$，其中 $a_r^*(t)$ 是 $a_r(t)$ 的复共轭。这是因为 $a_s(t) a_r^*(t) = A_s(t)A_r(t)e^{i(\\phi_s(t) - \\phi_r(t))}$。这种形式是稳健的，因为它结合了同相相关（$u_s u_r$）和正交相相关（$\\mathcal{H}\\{u_s\\} \\mathcal{H}\\{u_r\\}$），从而即使相干能量因传播效应在同相和正交分量之间发生了转移，也能被捕捉到。\n\n对于数值实现，积分被替换为在 $N$ 个样本上、时间间隔为 $\\Delta t$ 的离散时间求和。推导出的成像条件是：\n$$I_{\\text{adaptive}} = \\sum_{n=0}^{N-1} A_s(t_n) A_r(t_n) \\cos(\\phi_s(t_n) - \\phi_r(t_n)) \\Delta t$$\n其中 $t_n = n\\Delta t$，瞬时振幅 $A(t_n)$ 和相位 $\\phi(t_n)$ 从 $u_s(t_n)$ 和 $u_r(t_n)$ 的离散解析信号中提取。\n\n**2. 实现策略**\n\n对于每个测试用例，数值解遵循一系列步骤。\n\n**信号生成：**\n- 创建一个离散时间向量 $t$，范围从 $t=0$ 到 $T=1.0$ 秒，采样间隔为 $\\Delta t = 0.001$ 秒。\n- 使用指定的高斯调制余弦函数生成震源波场 $u_s(t)$，参数为 $t_0=0.50$ s, $\\sigma=0.05$ s, and $f_0=25$ Hz。\n- 通过对 $u_s(t)$ 应用指定的畸变来合成检波器波场 $u_r(t)$。这是按顺序完成的：首先应用各向异性引起的时间扭曲，然后进行频域衰减和频散滤波。\n  - **各向异性扭曲**：对于非零参数 $a$，计算一个扭曲的时间向量 $t' = t + a(t - t_0)^2$。然后使用线性插值构造扭曲信号 $u_r(t) = u_s(t')$，因为 $t'$ 中的点通常不会与原始采样时间重合。\n  - **衰减和频散**：对于非零参数 $\\alpha$ 或 $\\kappa$，将（可能经过时间扭曲的）信号使用快速傅里叶变换 (FFT) 转换到频域。构造一个复数滤波器 $H(f) = \\exp(-\\alpha |f|) \\exp(i 2\\pi \\kappa f^2)$ 并与信号的频谱相乘。然后执行逆 FFT，并取其实部以获得最终的畸变时域信号 $u_r(t)$。\n\n**成像值计算：**\n- 标准互相关成像值 $I_{\\text{cc}}$ 通过离散求和计算：$I_{\\text{cc}} = \\sum u_s(t_n) u_r(t_n) \\Delta t$。\n- 相位自适应成像值 $I_{\\text{adaptive}}$ 的计算如下：\n  1. 使用希尔伯特变换从 $u_s(t_n)$ 和 $u_r(t_n)$ 计算解析信号 $a_s(t_n)$ 和 $a_r(t_n)$。\n  2. 通过取解析信号的绝对值找到瞬时振幅 $A_s(t_n)$ 和 $A_r(t_n)$。\n  3. 通过取解析信号的辐角找到瞬时相位 $\\phi_s(t_n)$ 和 $\\phi_r(t_n)$。应用 `unwrap` 函数对相位进行处理以校正 2π 不连续性。\n  4. 然后评估 $I_{\\text{adaptive}}$ 的推导公式。\n\n**性能指标：**\n- 对于每个测试用例，无量纲性能指标 $M$ 按 $M = |I_{\\text{adaptive}}| / (|I_{\\text{cc}}| + \\varepsilon)$ 计算，稳定化常数 $\\varepsilon = 10^{-12}$。\n\n对四个测试用例中的每一个执行此过程，并收集得到的 $M$ 值作为最终输出。对于基准情况（用例1），其中 $u_r(t) = u_s(t)$，预期 $I_{\\text{cc}} \\approx \\frac{1}{2} I_{\\text{adaptive}}$，从而导致 $M \\approx 2$。对于畸变情况，预期 $I_{\\text{cc}}$ 的劣化程度会比 $I_{\\text{adaptive}}$ 更严重，从而导致更高的 $M$ 值。",
            "answer": "```python\nimport numpy as np\nfrom scipy.signal import hilbert\nfrom scipy.fft import fft, ifft, fftfreq\n\ndef solve():\n    \"\"\"\n    Derives, implements, and tests a phase-adaptive imaging condition\n    for seismic migration against a standard cross-correlation condition.\n    \"\"\"\n    \n    # Task 6: Fixed signal parameters\n    T = 1.0  # Total duration in seconds\n    dt = 0.001  # Sample interval in seconds\n    t0 = 0.50  # Pulse center in seconds\n    sigma = 0.05  # Envelope width in seconds\n    f0 = 25.0  # Central frequency in Hertz\n    epsilon = 1e-12 # Stabilization constant\n    \n    # Time vector\n    n_samples = int(T / dt)\n    t = np.arange(n_samples) * dt\n\n    # Task 2: Generate the source wavefield u_s(t)\n    gauss_envelope = np.exp(-((t - t0)**2) / (2 * sigma**2))\n    u_s = gauss_envelope * np.cos(2 * np.pi * f0 * (t - t0))\n\n    # Task 7: Test suite of distortion parameters (a, alpha, kappa)\n    test_cases = [\n        # Case 1 (baseline, happy path)\n        (0.0, 0.0, 0.0),\n        # Case 2 (anisotropy-only)\n        (0.4, 0.0, 0.0),\n        # Case 3 (attenuation and dispersion)\n        (0.0, 0.008, 8e-7),\n        # Case 4 (combined distortions)\n        (0.5, 0.010, 1.5e-6),\n    ]\n\n    performance_metrics = []\n\n    for a, alpha, kappa in test_cases:\n        # Task 3: Construct the receiver wavefield u_r(t)\n        u_r_intermediate = u_s.copy()\n        \n        # Apply anisotropy-induced phase warp\n        if a != 0.0:\n            t_prime = t + a * (t - t0)**2\n            # Interpolate u_s at the warped time coordinates t'\n            # u_r(t) = u_s(t')\n            u_r_intermediate = np.interp(t_prime, t, u_s)\n        \n        u_r = u_r_intermediate\n\n        # Apply attenuation and dispersion in the frequency domain\n        if alpha != 0.0 or kappa != 0.0:\n            # FFT of the (potentially warped) signal\n            U_r_intermediate = fft(u_r_intermediate)\n            \n            # Frequency vector\n            f = fftfreq(n_samples, dt)\n            \n            # Amplitude and phase filters\n            A_f = np.exp(-alpha * np.abs(f))\n            Psi_f = np.exp(1j * 2 * np.pi * kappa * f**2)\n            \n            # Combine filters and apply\n            H_f = A_f * Psi_f\n            U_r = U_r_intermediate * H_f\n            \n            # Inverse FFT to get the final receiver wavefield\n            u_r = np.real(ifft(U_r))\n\n        # Task 4: Compute the two scalar image values\n        \n        # Standard cross-correlation image\n        I_cc = np.sum(u_s * u_r) * dt\n\n        # Phase-adaptive image\n        # Compute analytic signals using Hilbert transform\n        analytic_s = hilbert(u_s)\n        analytic_r = hilbert(u_r)\n\n        # Extract instantaneous amplitudes (envelopes)\n        A_s = np.abs(analytic_s)\n        A_r = np.abs(analytic_r)\n\n        # Extract instantaneous phases (unwrapped)\n        phi_s = np.unwrap(np.angle(analytic_s))\n        phi_r = np.unwrap(np.angle(analytic_r))\n        \n        # Compute the phase-adaptive integrand\n        integrand_adaptive = A_s * A_r * np.cos(phi_s - phi_r)\n        I_adaptive = np.sum(integrand_adaptive) * dt\n\n        # Task 5: Compute the performance metric\n        M = np.abs(I_adaptive) / (np.abs(I_cc) + epsilon)\n        performance_metrics.append(f\"{M:.6f}\")\n\n    # Task 8: Produce the final output in the specified format\n    print(f\"[{','.join(performance_metrics)}]\")\n\nsolve()\n```"
        }
    ]
}