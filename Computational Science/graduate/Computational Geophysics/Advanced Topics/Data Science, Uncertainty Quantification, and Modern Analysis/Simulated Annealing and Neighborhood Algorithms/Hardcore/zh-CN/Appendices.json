{
    "hands_on_practices": [
        {
            "introduction": "本章节的第一个练习将带您深入模拟退火算法的核心。通过一个简化的地球物理模型，您将亲手计算模型参数的改变如何影响数据失配，以及这如何根据Metropolis准则转化为一个具体的接受概率。这项练习旨在阐明模型扰动、能量变化和退火温度三者之间的相互作用，这是理解和实现模拟退火算法的基石 ()。",
            "id": "3614462",
            "problem": "一条笔直的地震射线穿过水平分层计算域中的两个均匀介质单元。对于具有单元速度 $\\{v_{1},v_{2}\\}$ 和路径长度 $\\{\\ell_{1},\\ell_{2}\\}$ 的模型 $\\mathbf{m}$，其预测走时由基本运动学关系 $t(\\mathbf{m})=\\sum_{i=1}^{2}\\ell_{i}/v_{i}$ 给出。一个提议的模型 $\\mathbf{m}'$ 将单元速度修改为 $\\{v_{1}',v_{2}'\\}$。预测走时的变化量定义为 $\\Delta t \\equiv t(\\mathbf{m}')-t(\\mathbf{m})$。\n\n假设单个观测数据 $d$ 受到标准差为 $\\sigma$ 的独立、零均值高斯噪声的干扰，因此似然函数正比于 $\\exp\\!\\left(-\\frac{(t(\\mathbf{m})-d)^{2}}{2\\sigma^{2}}\\right)$。在使用温度为 $T$ 的 Metropolis 准则的模拟退火算法中，将能量定义为负对数似然函数 $E(\\mathbf{m})=\\frac{(t(\\mathbf{m})-d)^{2}}{2\\sigma^{2}}$。对于提议 $\\mathbf{m}\\to\\mathbf{m}'$ 的接受概率为 $p_{\\mathrm{acc}}=\\min\\!\\left(1,\\exp\\!\\left(-\\frac{\\Delta E}{T}\\right)\\right)$，其中 $\\Delta E=E(\\mathbf{m}')-E(\\mathbf{m})$。假设当前模型 $\\mathbf{m}$ 完全拟合数据，因此 $t(\\mathbf{m})-d=0$。\n\n给定 $\\ell_{1}=3\\,\\mathrm{km}$，$\\ell_{2}=2\\,\\mathrm{km}$，$(v_{1},v_{2})=(2,4)\\,\\mathrm{km/s}$，$(v_{1}',v_{2}')=(2.2,3.8)\\,\\mathrm{km/s}$，$\\sigma=0.05\\,\\mathrm{s}$以及 $T=0.5$，完成以下操作：\n\n- 计算精确的 $\\Delta t=\\ell_{1}\\!\\left(\\frac{1}{v_{1}'}-\\frac{1}{v_{1}}\\right)+\\ell_{2}\\!\\left(\\frac{1}{v_{2}'}-\\frac{1}{v_{2}}\\right)$，并以秒为单位报告结果。将 $\\Delta t$ 四舍五入到六位有效数字。\n- 使用上述统计力学公式，计算此单个数据的 Metropolis 接受概率 $p_{\\mathrm{acc}}$。将 $p_{\\mathrm{acc}}$ 四舍五入到四位有效数字，以纯小数形式表示（非百分比）。\n\n将最终答案表示为一个二元行向量 $\\big(\\Delta t,\\;p_{\\mathrm{acc}}\\big)$。",
            "solution": "该问题经验证是自洽、客观的，并且其科学基础在于计算地球物理学和统计力学的原理。所有必要的数据和定义均已提供，不存在内部矛盾或违反科学原理之处。因此，我们可以着手求解。\n\n问题要求计算两个量：走时变化量 $\\Delta t$ 和 Metropolis 接受概率 $p_{\\mathrm{acc}}$。\n\n首先，我们计算预测走时的变化量 $\\Delta t$。对于具有速度 $\\{v_1, v_2\\}$ 和路径长度 $\\{\\ell_1, \\ell_2\\}$ 的模型 $\\mathbf{m}$，其走时为 $t(\\mathbf{m}) = \\frac{\\ell_1}{v_1} + \\frac{\\ell_2}{v_2}$。对于具有速度 $\\{v_1', v_2'\\}$ 的提议模型 $\\mathbf{m}'$，其走时为 $t(\\mathbf{m}') = \\frac{\\ell_1}{v_1'} + \\frac{\\ell_2}{v_2'}$。变化量 $\\Delta t$ 定义为 $t(\\mathbf{m}') - t(\\mathbf{m})$。\n\n$\\Delta t$ 的表达式如下：\n$$\n\\Delta t = \\ell_{1}\\!\\left(\\frac{1}{v_{1}'}-\\frac{1}{v_{1}}\\right)+\\ell_{2}\\!\\left(\\frac{1}{v_{2}'}-\\frac{1}{v_{2}}\\right)\n$$\n我们代入给定值：$\\ell_1=3\\,\\mathrm{km}$，$\\ell_2=2\\,\\mathrm{km}$， $v_1=2\\,\\mathrm{km/s}$， $v_2=4\\,\\mathrm{km/s}$， $v_1'=2.2\\,\\mathrm{km/s}$以及 $v_2'=3.8\\,\\mathrm{km/s}$。每一项 $\\ell/v$ 的单位是 $\\mathrm{km} / (\\mathrm{km/s}) = \\mathrm{s}$，因此得到的 $\\Delta t$ 的单位是秒。\n$$\n\\Delta t = 3 \\left(\\frac{1}{2.2} - \\frac{1}{2}\\right) + 2 \\left(\\frac{1}{3.8} - \\frac{1}{4}\\right)\n$$\n我们先进行括号内的计算：\n$$\n\\frac{1}{2.2} - \\frac{1}{2} = \\frac{1}{11/5} - \\frac{1}{2} = \\frac{5}{11} - \\frac{1}{2} = \\frac{10-11}{22} = -\\frac{1}{22}\n$$\n$$\n\\frac{1}{3.8} - \\frac{1}{4} = \\frac{1}{19/5} - \\frac{1}{4} = \\frac{5}{19} - \\frac{1}{4} = \\frac{20-19}{76} = \\frac{1}{76}\n$$\n将这些分数代回到 $\\Delta t$ 的表达式中：\n$$\n\\Delta t = 3 \\left(-\\frac{1}{22}\\right) + 2 \\left(\\frac{1}{76}\\right) = -\\frac{3}{22} + \\frac{2}{76} = -\\frac{3}{22} + \\frac{1}{38}\n$$\n为了合并这些分数，我们找到公分母，即 $22 \\times 19 = 418$。\n$$\n\\Delta t = -\\frac{3 \\times 19}{22 \\times 19} + \\frac{1 \\times 11}{38 \\times 11} = \\frac{-57}{418} + \\frac{11}{418} = -\\frac{46}{418} = -\\frac{23}{209}\n$$\n将这个精确分数转换为小数，得到：\n$$\n\\Delta t = -\\frac{23}{209} \\approx -0.11004784688... \\,\\mathrm{s}\n$$\n按照要求四舍五入到六位有效数字，我们得到 $\\Delta t = -0.110048\\,\\mathrm{s}$。\n\n接下来，我们计算 Metropolis 接受概率 $p_{\\mathrm{acc}}$。其定义为：\n$$\np_{\\mathrm{acc}} = \\min\\!\\left(1, \\exp\\!\\left(-\\frac{\\Delta E}{T}\\right)\\right)\n$$\n其中 $\\Delta E = E(\\mathbf{m}') - E(\\mathbf{m})$，$T$ 是温度。能量函数由负对数似然函数给出：\n$$\nE(\\mathbf{m}) = \\frac{(t(\\mathbf{m}) - d)^2}{2\\sigma^2}\n$$\n我们得到了一个关键信息，即当前模型 $\\mathbf{m}$ 完全拟合数据 $d$，这意味着 $t(\\mathbf{m}) - d = 0$。这使得当前模型的能量简化为：\n$$\nE(\\mathbf{m}) = \\frac{(0)^2}{2\\sigma^2} = 0\n$$\n提议模型 $\\mathbf{m}'$ 的能量是：\n$$\nE(\\mathbf{m}') = \\frac{(t(\\mathbf{m}') - d)^2}{2\\sigma^2}\n$$\n我们可以将分子中的项重写为 $t(\\mathbf{m}') - d = (t(\\mathbf{m}')-t(\\mathbf{m}))+(t(\\mathbf{m})-d)$。由于 $t(\\mathbf{m}') - t(\\mathbf{m}) = \\Delta t$ 且 $t(\\mathbf{m}) - d = 0$，我们有 $t(\\mathbf{m}') - d = \\Delta t$。\n因此，新状态的能量为：\n$$\nE(\\mathbf{m}') = \\frac{(\\Delta t)^2}{2\\sigma^2}\n$$\n所以，能量的变化量为：\n$$\n\\Delta E = E(\\mathbf{m}') - E(\\mathbf{m}) = \\frac{(\\Delta t)^2}{2\\sigma^2} - 0 = \\frac{(\\Delta t)^2}{2\\sigma^2}\n$$\n现在我们代入 $\\sigma=0.05\\,\\mathrm{s}$ 和 $\\Delta t = -23/209\\,\\mathrm{s}$ 的精确值，以避免过早的舍入误差。\n$$\n\\Delta E = \\frac{\\left(-\\frac{23}{209}\\right)^2}{2(0.05)^2} = \\frac{\\frac{529}{43681}}{2(0.0025)} = \\frac{\\frac{529}{43681}}{0.005} = \\frac{529}{43681 \\times 0.005} = \\frac{529}{218.405} \\approx 2.4221057...\n$$\n现在我们计算指数函数的参数 $-\\frac{\\Delta E}{T}$，其中 $T=0.5$：\n$$\n-\\frac{\\Delta E}{T} = -\\frac{2.4221057...}{0.5} = -4.8442114...\n$$\n最后，我们计算接受概率：\n$$\np_{\\mathrm{acc}} = \\min\\!\\left(1, \\exp(-4.8442114...)\\right) = \\min\\!\\left(1, 0.0078740...\\right) = 0.0078740...\n$$\n按照要求四舍五入到四位有效数字，我们得到 $p_{\\mathrm{acc}} = 0.007874$。\n\n最终答案是二元行向量 $(\\Delta t, p_{\\mathrm{acc}})$。",
            "answer": "$$\\boxed{\\begin{pmatrix} -0.110048  0.007874 \\end{pmatrix}}$$"
        },
        {
            "introduction": "在掌握了单步计算之后，这项练习将引导您探索算法的长期行为和性能调优。您将推导随机游走Metropolis算法的平均接受率，这是一个关键的性能指标。这项理论练习揭示了在选择提议步长时所面临的关键权衡，并为如何调整算法以实现最高效的模型空间探索提供了明确的理论指导和目标 ()。",
            "id": "3614457",
            "problem": "在一个双参数线性化地球物理反演问题中，退火后验概率的负对数可以局部地由一个具有对称正定Hessian矩阵 $A \\succ 0$ 的二次型来近似。在退火温度 $T  0$ 时，目标密度为 $ \\pi_{T}(m) \\propto \\exp\\!\\big(-\\tfrac{1}{2} m^{\\top} A m / T\\big) $，这是一个均值为零、协方差为 $T A^{-1}$ 的高斯分布。在马尔可夫链蒙特卡洛 (MCMC) 方案中，一个随机游走Metropolis (RWM) 提议会提出 $ m' = m + \\varepsilon $，其中 $ \\varepsilon \\sim \\mathcal{N}(0, \\sigma^{2} I) $ 位于 $ \\mathbb{R}^{2} $ 中。由于提议是对称的，从 $m$ 移动到 $m'$ 的接受概率为 $ \\alpha(m,m') = \\min\\{ 1, \\pi_{T}(m')/\\pi_{T}(m) \\} $。假设马尔可夫链在 $ \\pi_{T} $ 下处于平稳状态，并且局部曲率是各向同性的，因此 $ A = a I $，其中 $ a  0 $。\n\n仅使用Metropolis接受准则的定义、高斯分布的性质以及高斯函数的标准积分恒等式，推导在 $ d = 2 $ 和 $ A = a I $ 的情况下，维度平均接受率 $ \\bar{\\alpha}(\\sigma) $ 作为 $ \\sigma $ 的函数。然后，确定能够产生0.3的期望接受率的 $ \\sigma $ 的值（以闭式形式），并用 $a$ 和 $T$ 表示。将你最终的 $ \\sigma $ 以包含 $a$ 和 $T$ 的单一符号表达式的形式报告。不要进行四舍五入。",
            "solution": "该问题要求在特定设置下，推导随机游走Metropolis (RWM) 算法的维度平均接受率，然后找出能使目标接受率达到0.3的提议步长 $\\sigma$。\n\n期望接受率 $\\bar{\\alpha}(\\sigma)$ 是接受概率 $\\alpha(m, m')$ 在状态 $m$ 的平稳分布和扰动 $\\varepsilon$ 的提议分布上的期望。鉴于马尔可夫链处于平稳状态，当前状态 $m$ 从目标分布中抽取，即 $m \\sim \\pi_T(m)$。提议的状态为 $m' = m + \\varepsilon$，其中 $\\varepsilon \\sim \\mathcal{N}(0, \\sigma^2 I)$。\n$$ \\bar{\\alpha}(\\sigma) = \\mathbb{E}_{m \\sim \\pi_T, \\varepsilon \\sim \\mathcal{N}(0, \\sigma^2 I)}[\\alpha(m, m+\\varepsilon)] $$\n对称RWM提议的接受概率由下式给出：\n$$ \\alpha(m, m') = \\min\\left\\{ 1, \\frac{\\pi_T(m')}{\\pi_T(m)} \\right\\} $$\n目标密度为 $\\pi_T(m) \\propto \\exp(-\\frac{1}{2T} m^{\\top} A m)$。对于给定的各向同性Hessian矩阵 $A = aI$（其中 $a0$ 且 $I$ 是 $2 \\times 2$ 的单位矩阵），密度比为：\n$$ \\frac{\\pi_T(m')}{\\pi_T(m)} = \\frac{\\exp(-\\frac{a}{2T} (m')^{\\top}m')}{\\exp(-\\frac{a}{2T} m^{\\top}m)} = \\exp\\left(-\\frac{a}{2T}(\\|m'\\|^2 - \\|m\\|^2)\\right) $$\n代入 $m' = m + \\varepsilon$：\n$$ \\|m'\\|^2 - \\|m\\|^2 = \\|m+\\varepsilon\\|^2 - \\|m\\|^2 = (m+\\varepsilon)\\cdot(m+\\varepsilon) - \\|m\\|^2 = \\|m\\|^2 + 2m\\cdot\\varepsilon + \\|\\varepsilon\\|^2 - \\|m\\|^2 = 2m\\cdot\\varepsilon + \\|\\varepsilon\\|^2 $$\n设指数参数的变化量为 $\\Delta E = \\frac{a}{2T}(2m\\cdot\\varepsilon + \\|\\varepsilon\\|^2)$。接受概率为 $\\alpha(m, \\varepsilon) = \\min\\{1, \\exp(-\\Delta E)\\}$。平均接受率为 $\\bar{\\alpha}(\\sigma) = \\mathbb{E}[\\min\\{1, \\exp(-\\Delta E)\\}]$。\n\n为计算此期望，我们首先确定随机变量 $\\Delta E$ 的分布。该期望是针对 $m \\sim \\pi_T(m) = \\mathcal{N}(0, TA^{-1}) = \\mathcal{N}(0, \\frac{T}{a}I)$ 和 $\\varepsilon \\sim \\mathcal{N}(0, \\sigma^2 I)$ 计算的，其中 $m, \\varepsilon \\in \\mathbb{R}^2$。\n\n我们定义归一化随机向量 $\\hat{m} = \\sqrt{\\frac{a}{T}}m$ 和 $\\hat{\\varepsilon} = \\frac{1}{\\sigma}\\varepsilon$。$\\hat{m}$ 和 $\\hat{\\varepsilon}$ 都由独立的标准正态随机变量组成，即对于 $i=1,2$，有 $\\hat{m}_i, \\hat{\\varepsilon}_i \\sim \\mathcal{N}(0,1)$。\n我们可以用这些归一化变量来表示 $\\Delta E$：\n$m\\cdot\\varepsilon = (\\sqrt{\\frac{T}{a}}\\hat{m}) \\cdot (\\sigma\\hat{\\varepsilon}) = \\sigma\\sqrt{\\frac{T}{a}} (\\hat{m}\\cdot\\hat{\\varepsilon})$\n$\\|\\varepsilon\\|^2 = \\|\\sigma\\hat{\\varepsilon}\\|^2 = \\sigma^2\\|\\hat{\\varepsilon}\\|^2$\n所以，$\\Delta E = \\frac{a}{2T}\\left(2\\sigma\\sqrt{\\frac{T}{a}}(\\hat{m}\\cdot\\hat{\\varepsilon}) + \\sigma^2\\|\\hat{\\varepsilon}\\|^2\\right) = \\sigma\\sqrt{\\frac{a}{T}}(\\hat{m}\\cdot\\hat{\\varepsilon}) + \\frac{a\\sigma^2}{2T}\\|\\hat{\\varepsilon}\\|^2$。\n\n设 $V = \\hat{m}\\cdot\\hat{\\varepsilon}$ 和 $W = \\|\\hat{\\varepsilon}\\|^2 = \\hat{\\varepsilon}_1^2 + \\hat{\\varepsilon}_2^2$。\n在给定 $\\hat{\\varepsilon}$ 的条件下，$V$ 是独立同分布的标准正态变量 $\\hat{m}_i$ 的线性组合。\n$\\mathbb{E}[V|\\hat{\\varepsilon}] = \\mathbb{E}[\\hat{m}_1\\hat{\\varepsilon}_1 + \\hat{m}_2\\hat{\\varepsilon}_2 | \\hat{\\varepsilon}] = \\hat{\\varepsilon}_1\\mathbb{E}[\\hat{m}_1] + \\hat{\\varepsilon}_2\\mathbb{E}[\\hat{m}_2] = 0$。\n$\\text{Var}(V|\\hat{\\varepsilon}) = \\text{Var}(\\hat{m}_1\\hat{\\varepsilon}_1 + \\hat{m}_2\\hat{\\varepsilon}_2 | \\hat{\\varepsilon}) = \\hat{\\varepsilon}_1^2\\text{Var}(\\hat{m}_1) + \\hat{\\varepsilon}_2^2\\text{Var}(\\hat{m}_2) = \\hat{\\varepsilon}_1^2(1) + \\hat{\\varepsilon}_2^2(1) = W$。\n因此，在给定 $W=w$ 的条件下，$V$ 的条件分布为 $V|W=w \\sim \\mathcal{N}(0, w)$。\n$W$ 的分布是 $d=2$ 个标准正态变量的平方和，所以 $W \\sim \\chi^2_2$。一个 $\\chi^2_2$ 分布的概率密度函数 (PDF) 与率为 $1/2$ 的指数分布相同，即对于 $w \\ge 0$，有 $f_W(w) = \\frac{1}{2}\\exp(-w/2)$。\n\n让我们用 $V$ 和 $W$ 表示 $\\Delta E$：$\\Delta E = k V + c W$，其中 $k=\\sigma\\sqrt{a/T}$ 且 $c = a\\sigma^2/(2T)$。注意 $c=k^2/2$。\n在给定 $W=w$ 的条件下，$\\Delta E$ 服从正态分布，其参数为：\n$\\mu_{\\Delta E|w} = \\mathbb{E}[\\Delta E | W=w] = k\\mathbb{E}[V|w] + cw = cw = \\frac{a\\sigma^2}{2T}w$。\n$\\sigma^2_{\\Delta E|w} = \\text{Var}(\\Delta E | W=w) = k^2\\text{Var}(V|w) = k^2w = \\frac{a\\sigma^2}{T}w$。\n\n条件接受率为 $\\bar{\\alpha}(w) = \\mathbb{E}[\\min\\{1, \\exp(-\\Delta E)\\} | W=w]$。\n对于一个随机变量 $X \\sim \\mathcal{N}(\\mu, \\sigma^2)$，其期望 $\\mathbb{E}[\\min\\{1, \\exp(X)\\}]$ 由 $\\Phi(\\mu/\\sigma) + \\exp(\\mu+\\sigma^2/2)\\Phi(-\\sigma - \\mu/\\sigma)$ 给出。\n在我们的情况中，我们需要计算 $\\mathbb{E}[\\min\\{1, \\exp(-\\Delta E)\\}]$，所以我们设 $X = -\\Delta E$。其条件分布为 $X|W=w \\sim \\mathcal{N}(-\\mu_{\\Delta E|w}, \\sigma^2_{\\Delta E|w})$。\n设 $\\mu_X = -\\mu_{\\Delta E|w}$ 和 $\\sigma_X^2 = \\sigma^2_{\\Delta E|w}$。\n在计算 $\\mu_X + \\sigma_X^2/2$ 时，出现了一个关键的简化：\n$\\mu_X + \\frac{\\sigma_X^2}{2} = -\\mu_{\\Delta E|w} + \\frac{\\sigma^2_{\\Delta E|w}}{2} = -\\frac{a\\sigma^2}{2T}w + \\frac{1}{2}\\left(\\frac{a\\sigma^2}{T}w\\right) = 0$。\n该期望接受率的公式简化为：\n$\\bar{\\alpha}(w) = \\Phi(\\mu_X/\\sigma_X) + \\exp(0)\\Phi(-\\sigma_X - \\mu_X/\\sigma_X) = \\Phi(\\mu_X/\\sigma_X) + \\Phi(-\\sigma_X - \\mu_X/\\sigma_X)$。\n我们来计算标准正态累积分布函数 $\\Phi(\\cdot)$ 的参数。\n$\\frac{\\mu_X}{\\sigma_X} = \\frac{-\\mu_{\\Delta E|w}}{\\sigma_{\\Delta E|w}} = \\frac{-a\\sigma^2 w/(2T)}{\\sqrt{a\\sigma^2 w/T}} = -\\frac{\\sqrt{a\\sigma^2 w}}{2\\sqrt{T}} = -\\frac{\\sigma}{2}\\sqrt{\\frac{aw}{T}}$。\n$-\\sigma_X - \\frac{\\mu_X}{\\sigma_X} = -\\sqrt{\\frac{a\\sigma^2w}{T}} - \\left(-\\frac{\\sigma}{2}\\sqrt{\\frac{aw}{T}}\\right) = -\\sigma\\sqrt{\\frac{aw}{T}} + \\frac{\\sigma}{2}\\sqrt{\\frac{aw}{T}} = -\\frac{\\sigma}{2}\\sqrt{\\frac{aw}{T}}$。\n两个参数是相同的。因此，条件接受率为：\n$\\bar{\\alpha}(w) = 2\\Phi\\left(-\\frac{\\sigma}{2}\\sqrt{\\frac{aw}{T}}\\right)$。\n\n为了得到总平均接受率 $\\bar{\\alpha}(\\sigma)$，我们将 $\\bar{\\alpha}(w)$ 对 $W$ 的分布进行积分：\n$$ \\bar{\\alpha}(\\sigma) = \\int_0^\\infty \\bar{\\alpha}(w) f_W(w) dw = \\int_0^\\infty 2\\Phi\\left(-\\frac{\\sigma}{2}\\sqrt{\\frac{aw}{T}}\\right) \\frac{1}{2}\\exp(-w/2) dw $$\n设 $k_0 = \\frac{\\sigma}{2}\\sqrt{\\frac{a}{T}}$。积分为：\n$$ \\bar{\\alpha}(\\sigma) = \\int_0^\\infty \\Phi(-k_0\\sqrt{w}) \\exp(-w/2) dw $$\n我们使用 $\\Phi(x) = \\frac{1}{\\sqrt{2\\pi}}\\int_{-\\infty}^x \\exp(-t^2/2) dt$ 的定义，并交换积分顺序（Fubini定理）：\n$$ \\bar{\\alpha}(\\sigma) = \\int_0^\\infty \\left( \\frac{1}{\\sqrt{2\\pi}} \\int_{-\\infty}^{-k_0\\sqrt{w}} \\exp(-t^2/2) dt \\right) \\exp(-w/2) dw $$\n积分区域为 $w \\in [0, \\infty)$ 和 $t \\in (-\\infty, -k_0\\sqrt{w}]$。这等价于 $t \\in (-\\infty, 0]$ 和 $0 \\le w \\le t^2/k_0^2$。\n$$ \\bar{\\alpha}(\\sigma) = \\frac{1}{\\sqrt{2\\pi}} \\int_{-\\infty}^0 \\left( \\int_0^{t^2/k_0^2} \\exp(-w/2) dw \\right) \\exp(-t^2/2) dt $$\n内层积分为 $\\int_0^{t^2/k_0^2} \\exp(-w/2) dw = [-2\\exp(-w/2)]_0^{t^2/k_0^2} = 2(1 - \\exp(-t^2/(2k_0^2)))$。\n将此结果代回：\n$$ \\bar{\\alpha}(\\sigma) = \\frac{2}{\\sqrt{2\\pi}} \\int_{-\\infty}^0 \\left( 1 - \\exp(-t^2/(2k_0^2)) \\right) \\exp(-t^2/2) dt $$\n$$ \\bar{\\alpha}(\\sigma) = \\sqrt{\\frac{2}{\\pi}} \\left( \\int_{-\\infty}^0 \\exp(-t^2/2) dt - \\int_{-\\infty}^0 \\exp\\left(-\\frac{t^2}{2}\\left(1+\\frac{1}{k_0^2}\\right)\\right) dt \\right) $$\n第一个积分是 $\\sqrt{2\\pi} P(Z \\le 0) = \\sqrt{2\\pi}(1/2) = \\sqrt{\\pi/2}$，其中 $Z \\sim \\mathcal{N}(0,1)$。\n第二个积分是方差为 $s^2 = (1+1/k_0^2)^{-1} = k_0^2/(k_0^2+1)$ 的零均值高斯积分的一半。该积分的值为 $\\frac{1}{2}\\sqrt{2\\pi s^2} = \\sqrt{\\pi/2} s = \\sqrt{\\pi/2} \\frac{k_0}{\\sqrt{k_0^2+1}}$。\n$$ \\bar{\\alpha}(\\sigma) = \\sqrt{\\frac{2}{\\pi}} \\left( \\sqrt{\\frac{\\pi}{2}} - \\sqrt{\\frac{\\pi}{2}}\\frac{k_0}{\\sqrt{k_0^2+1}} \\right) = 1 - \\frac{k_0}{\\sqrt{k_0^2+1}} $$\n这就是推导出的维度平均接受率。\n\n最后，我们必须找到使 $\\bar{\\alpha}(\\sigma) = 0.3$ 成立的 $\\sigma$：\n$$ 1 - \\frac{k_0}{\\sqrt{k_0^2+1}} = 0.3 \\implies \\frac{k_0}{\\sqrt{k_0^2+1}} = 0.7 $$\n两边平方：\n$$ \\frac{k_0^2}{k_0^2+1} = 0.7^2 = 0.49 $$\n$$ k_0^2 = 0.49(k_0^2+1) \\implies k_0^2 = 0.49k_0^2 + 0.49 $$\n$$ (1-0.49)k_0^2 = 0.49 \\implies 0.51k_0^2 = 0.49 \\implies k_0^2 = \\frac{49}{51} $$\n现在，我们将 $k_0$ 的定义代回：\n$$ k_0^2 = \\left(\\frac{\\sigma}{2}\\sqrt{\\frac{a}{T}}\\right)^2 = \\frac{\\sigma^2 a}{4T} $$\n$$ \\frac{\\sigma^2 a}{4T} = \\frac{49}{51} \\implies \\sigma^2 = \\frac{4T}{a}\\frac{49}{51} $$\n对 $\\sigma > 0$ 取平方根：\n$$ \\sigma = \\sqrt{\\frac{4T \\cdot 49}{a \\cdot 51}} = 2\\cdot 7 \\sqrt{\\frac{T}{a \\cdot 51}} = \\frac{14}{\\sqrt{51}}\\sqrt{\\frac{T}{a}} $$",
            "answer": "$$ \\boxed{\\frac{14}{\\sqrt{51}}\\sqrt{\\frac{T}{a}}} $$"
        },
        {
            "introduction": "最后的这项练习将理论付诸实践，要求您完成一个综合性的编程任务，以应对地球物理反演中的一个常见挑战。您将设计并实现一个混合优化算法，它结合了模拟退火的全局探索能力和LBFGS等局部梯度优化器的高效收敛特性。这个顶点项目专注于开发智能的“交接”准则，从而让您学会如何融合不同的优化思想，以实现稳健而高效的求解策略 ()。",
            "id": "3614454",
            "problem": "您需要设计并实现一个混合全局-局部优化方案，用于一个人工合成但具有地球物理动机、且表现出多峰性的一维慢度反演目标函数。该混合方案将模拟退火 (SA) 与限制内存的 Broyden-Fletcher-Goldfarb-Shanno (LBFGS) 精修相结合，从 SA 到 LBFGS 的切换必须由基于局部曲率、梯度范数和温度阈值的准则控制。您的实现必须遵循精确的数学定义，并为固定的测试套件生成定量指标。\n\n该优化问题使用一个模型向量 $m \\in \\mathbb{R}^d$ 来表示一维慢度剖面。总目标函数为\n$$\n\\Phi(m) \\equiv \\Phi_{\\text{data}}(m) + \\Phi_{\\text{reg}}(m) + \\Phi_{\\text{smooth}}(m),\n$$\n其包含以下组成部分：\n- 数据失配分量为\n$$\n\\Phi_{\\text{data}}(m) = \\frac{1}{2 K \\sigma^2} \\left\\| L m - t^{\\text{obs}} \\right\\|_2^2,\n$$\n其中 $L \\in \\mathbb{R}^{K \\times d}$ 是路径长度矩阵，$t^{\\text{obs}} \\in \\mathbb{R}^K$ 是人工合成的观测值，$K$ 是观测数量，$\\sigma$ 是观测噪声的标准差。\n- 多峰正则化项为\n$$\n\\Phi_{\\text{reg}}(m) = \\beta \\sum_{j=1}^{d} \\left(1 - \\cos(\\omega m_j) \\right),\n$$\n该项引入了许多局部最小值。\n- 二次平滑正则化项为\n$$\n\\Phi_{\\text{smooth}}(m) = \\gamma \\sum_{j=1}^{d-1} (m_{j+1} - m_j)^2.\n$$\n\n使用以下固定配置，您的程序必须精确复现这些配置：\n- 维度: $d = 6$。\n- 观测数量: $K = 12$。\n- 人工合成数据生成：使用以种子 2024 初始化的伪随机数生成器，确定性地创建 $L$ 和 $t^{\\text{obs}}$。具体方法如下：从 $[0.5, 1.5]$ 上的均匀分布中抽取 $L$ 的独立条目，从 $[0.8, 1.2]$ 上的均匀分布中抽取真实模型 $m^{\\star}$，并设置 $t^{\\text{obs}} = L m^{\\star} + \\eta$，其中 $\\eta$ 是标准差为 $\\sigma$ 的独立、零均值高斯噪声，逐项应用于结果。\n- 常数：$\\sigma = 0.02$, $\\beta = 0.02$, $\\omega = 6.0$, $\\gamma = 0.1$。\n- 变量边界 (在精修阶段强制执行，并用于裁剪 SA 的提议)：对所有 $j$，有 $m_j \\in [0.2, 1.8]$。\n- 所有运行的初始模型：$m^{(0)} = \\mathbf{1} \\in \\mathbb{R}^d$。\n\n模拟退火必须使用源于 Boltzmann 分布的 Metropolis 准则来实现。给定在温度 $T$ 下从当前状态 $m$ 生成的提议状态 $m'$，其接受概率为\n$$\np_{\\text{acc}} = \\min\\left(1, \\exp\\left(-\\frac{\\Phi(m') - \\Phi(m)}{T}\\right)\\right).\n$$\n使用一个零均值、各向同性协方差的高斯邻域提议，其标准差随温度缩放，即\n$$\nm' = \\Pi_{[0.2, 1.8]^d}\\left(m + \\delta\\right), \\quad \\delta \\sim \\mathcal{N}\\left(0, \\left(s_{\\text{prop}} T\\right)^2 I_d\\right),\n$$\n其中 $\\Pi$ 表示到边界上的逐分量投影，$s_{\\text{prop}}$ 是一个标量，$I_d$ 是单位矩阵。使用几何降温，\n$$\nT_{k+1} = \\alpha T_k,\n$$\n其中 $\\alpha = 0.98$ 为固定因子。\n\n确定性精修必须使用标准科学计算库中实现的限制内存 Broyden-Fletcher-Goldfarb-Shanno (LBFGS) 算法。您可以提供有限差分梯度，或依赖求解器内部的近似。从 SA 到 LBFGS 的切换必须在一个被接受的 SA 状态 $m$ 上同时使用以下所有准则：\n- 温度阈值：$T \\le \\tau T_{\\text{init}}$。\n- 梯度范数阈值：$\\left\\|\\nabla \\Phi(m)\\right\\|_2 \\le g_{\\text{th}}$，其中 $\\nabla \\Phi(m)$ 通过采用小的对称步长的中心有限差分进行近似。\n- 局部曲率阈值：$\\Phi$ 沿着单位梯度方向 $u = \\nabla \\Phi(m) / \\left\\|\\nabla \\Phi(m)\\right\\|_2$ 的方向二阶导数必须满足\n$$\n\\kappa(m) \\equiv \\frac{\\Phi(m + h u) - 2 \\Phi(m) + \\Phi(m - h u)}{h^2},\n$$\n对于一个小步长 $h$。如果 $\\left\\|\\nabla \\Phi(m)\\right\\|_2 = 0$，则为 $u$ 选择任意单位向量。\n\n如果在规定的 SA 迭代次数内从未满足切换准则，您仍必须从最后一个 SA 状态开始运行 LBFGS。在这种情况下，将 SA 终止时的迭代次数定义为报告的切换迭代次数。\n\n您的程序必须为每个测试用例计算一个包含三个条目的列表：\n- 切换迭代索引（整数）。\n- 精修后的最终目标函数值 $\\Phi(m_{\\text{final}})$（浮点数）。\n- 一个布尔值，指示精修是否使目标函数值相对于切换状态严格减小（即，是否 $\\Phi(m_{\\text{final}})  \\Phi(m_{\\text{handoff}})$）。\n\n所有输出均为无量纲的性能指标。角度（如有）无关紧要。输出中不需要物理单位。\n\n测试套件。在以下四个参数集上运行您的混合算法。对于每个参数集，使用由给定整数作种的独立提议随机数生成器，以使邻域序列可复现：\n- 用例 1：种子 $= 42$, $T_{\\text{init}} = 1.0$, $\\tau = 0.1$, $g_{\\text{th}} = 1.0 \\times 10^{-3}$, $c_{\\text{th}} = 1.0 \\times 10^{-3}$, SA 迭代次数 $N_{\\text{SA}} = 800$, 提议尺度 $s_{\\text{prop}} = 0.1$。\n- 用例 2：种子 $= 7$, $T_{\\text{init}} = 2.5$, $\\tau = 0.2$, $g_{\\text{th}} = 3.0 \\times 10^{-3}$, $c_{\\text{th}} = 5.0 \\times 10^{-4}$, SA 迭代次数 $N_{\\text{SA}} = 800$, 提议尺度 $s_{\\text{prop}} = 0.15$。\n- 用例 3：种子 $= 99$, $T_{\\text{init}} = 0.5$, $\\tau = 0.05$, $g_{\\text{th}} = 1.0 \\times 10^{-4}$, $c_{\\text{th}} = 5.0 \\times 10^{-3}$, SA 迭代次数 $N_{\\text{SA}} = 800$, 提议尺度 $s_{\\text{prop}} = 0.08$。\n- 用例 4：种子 $= 123$, $T_{\\text{init}} = 1.5$, $\\tau = 0.01$, $g_{\\text{th}} = 0.0$, $c_{\\text{th}} = 0.0$, SA 迭代次数 $N_{\\text{SA}} = 500$, 提议尺度 $s_{\\text{prop}} = 0.12$。\n\n最终输出格式。您的程序应生成单行输出，其中包含四个用例的结果，形式为一个用方括号括起来的逗号分隔列表。每个结果本身是一个 Python 风格的列表，格式为 $[\\text{handoff\\_iter}, \\text{final\\_objective}, \\text{improved}]$。例如，一个语法上有效的输出形式为\n$$\n\\left[\\,[10,0.123, \\text{True}],[\\ldots],[\\ldots],[\\ldots]\\,\\right]\n$$\n但其中的占位符需替换为您程序计算出的数字和布尔值。",
            "solution": "用户提供的问题被评估为 **有效** 的。这是一个在计算地球物理学和优化领域内定义明确、有科学依据且客观的问题。它指定了一个完整、确定性的数值实验，涉及设计和实现一个混合模拟退火和 L-BFGS 的优化算法。所有必要的参数、函数和准则都已提供，从而能够得到唯一且可验证的解。\n\n问题的核心是对于模型向量 $m \\in \\mathbb{R}^d$ 最小化一个多峰目标函数 $\\Phi(m) \\in \\mathbb{R}$。该目标函数是三个分量的总和：\n$$\n\\Phi(m) = \\Phi_{\\text{data}}(m) + \\Phi_{\\text{reg}}(m) + \\Phi_{\\text{smooth}}(m)\n$$\n其中：\n1.  数据失配项 $\\Phi_{\\text{data}}(m)$ 量化了模型预测与观测值之间的差异。它是一个标准的最小二乘项：\n    $$\n    \\Phi_{\\text{data}}(m) = \\frac{1}{2 K \\sigma^2} \\left\\| L m - t^{\\text{obs}} \\right\\|_2^2\n    $$\n    此处，$L \\in \\mathbb{R}^{K \\times d}$ 是线性正演算子（路径长度矩阵），$t^{\\text{obs}} \\in \\mathbb{R}^K$ 是观测到的走时，$K=12$ 是观测数量，$d=6$ 是模型维度，$\\sigma=0.02$ 是噪声标准差。\n\n2.  多峰正则化项 $\\Phi_{\\text{reg}}(m)$ 在目标函数景观中引入了大量的局部最小值，这使得纯局部优化器难以求解。其定义为：\n    $$\n    \\Phi_{\\text{reg}}(m) = \\beta \\sum_{j=1}^{d} \\left(1 - \\cos(\\omega m_j) \\right)\n    $$\n    其中 $\\beta = 0.02$ 且 $\\omega = 6.0$。\n\n3.  平滑正则化项 $\\Phi_{\\text{smooth}}(m)$ 惩罚相邻模型参数之间的巨大变化，从而促进产生更平滑的解。它是一个二次惩罚项：\n    $$\n    \\Phi_{\\text{smooth}}(m) = \\gamma \\sum_{j=1}^{d-1} (m_{j+1} - m_j)^2\n    $$\n    其中 $\\gamma = 0.1$。\n\n人工合成数据 $L$ 和 $t^{\\text{obs}}$ 是使用以 2024 为种子的伪随机数生成器确定性地生成的。真实模型 $m^{\\star}$ 从均匀分布中抽取，然后向合成数据 $L m^{\\star}$ 中添加高斯噪声以创建 $t^{\\text{obs}}$。\n\n优化策略是一种混合方法。首先，采用模拟退火（SA）进行全局探索。从初始模型 $m^{(0)} = \\mathbf{1} \\in \\mathbb{R}^d$ 和初始温度 $T_{\\text{init}}$ 开始，算法迭代进行。在每一步 $k$，通过在当前模型 $m$ 上添加一个从高斯分布中抽取的扰动来生成一个候选模型 $m'$，该高斯分布的方差随当前温度 $T_k$ 缩放：\n$$\nm' = \\Pi_{[0.2, 1.8]^d}\\left(m + \\delta\\right), \\quad \\delta \\sim \\mathcal{N}\\left(0, \\left(s_{\\text{prop}} T_k\\right)^2 I_d\\right)\n$$\n其中 $\\Pi$ 是一个强制执行箱式约束 $m_j \\in [0.2, 1.8]$ 的投影。候选模型 $m'$ 以以下概率被接受：\n$$\np_{\\text{acc}} = \\min\\left(1, \\exp\\left(-\\frac{\\Phi(m') - \\Phi(m)}{T_k}\\right)\\right)\n$$\n温度在每一步根据几何降温策略 $T_{k+1} = \\alpha T_k$ 进行降低，其中 $\\alpha = 0.98$。\n\n从全局探索（SA）到局部精修（L-BFGS）的转换由一组在每个被接受的 SA 状态下检查的三个同步准则来控制：\n1.  温度阈值：$T \\le \\tau T_{\\text{init}}$\n2.  梯度范数阈值：$\\left\\|\\nabla \\Phi(m)\\right\\|_2 \\le g_{\\text{th}}$\n3.  曲率阈值：$\\kappa(m) \\ge c_{\\text{th}}$\n\n梯度 $\\nabla \\Phi(m)$ 使用步长为 $h_g$ 的中心有限差分格式计算：\n$$\n\\frac{\\partial \\Phi}{\\partial m_j}(m) \\approx \\frac{\\Phi(m + h_g e_j) - \\Phi(m - h_g e_j)}{2h_g}\n$$\n其中 $e_j$ 是第 $j$ 个标准基向量。将使用步长 $h_g = 10^{-6}$。\n\n曲率 $\\kappa(m)$ 是沿归一化梯度方向 $u = \\nabla \\Phi(m) / \\left\\|\\nabla \\Phi(m)\\right\\|_2$ 的二阶导数。它也通过步长为 $h_c$ 的中心有限差分进行近似：\n$$\n\\kappa(m) \\approx \\frac{\\Phi(m + h_c u) - 2 \\Phi(m) + \\Phi(m - h_c u)}{h_c^2}\n$$\n将使用步长 $h_c = 10^{-5}$。如果梯度范数在数值上为零（例如，小于 $10^{-12}$），则将 $u$ 设置为标准基向量 $[1, 0, \\dots, 0]^T$。\n\n如果满足这些准则，SA 终止，当前模型 $m$ 成为切换模型 $m_{\\text{handoff}}$。如果在达到最大 SA 迭代次数 $N_{\\text{SA}}$ 后准则仍未被满足，则使用 SA 的最终模型作为 $m_{\\text{handoff}}$。\n\n最后，使用限制内存的 Broyden-Fletcher-Goldfarb-Shanno (L-BFGS) 算法，特别是 `SciPy` 库中支持箱式约束的 `L-BFGS-B` 变体，从 $m_{\\text{handoff}}$ 开始对解进行精修。这会得到最终模型 $m_{\\text{final}}$。\n\n该过程针对四个不同的测试用例执行，每个用例都有其自己的一套算法参数和用于 SA 提议序列的随机种子。对于每个用例，我们报告切换迭代次数、最终目标函数值 $\\Phi(m_{\\text{final}})$，以及一个指示目标函数值是否通过 L-BFGS 精修步骤得到严格改善的布尔值。",
            "answer": "```python\nimport numpy as np\nfrom scipy.optimize import minimize\n\ndef solve():\n    \"\"\"\n    Main function to run the hybrid SA-LBFGS optimization for all test cases.\n    \"\"\"\n\n    # --- Problem Constants and Data Generation ---\n    D_DIM = 6\n    K_OBS = 12\n    SIGMA = 0.02\n    BETA = 0.02\n    OMEGA = 6.0\n    GAMMA = 0.1\n    MODEL_BOUNDS = (0.2, 1.8)\n    M_INIT = np.ones(D_DIM)\n\n    # Generate synthetic data deterministically\n    rng_data = np.random.default_rng(2024)\n    L_matrix = rng_data.uniform(0.5, 1.5, size=(K_OBS, D_DIM))\n    m_star = rng_data.uniform(0.8, 1.2, size=D_DIM)\n    noise = rng_data.normal(0, SIGMA, size=K_OBS)\n    t_obs = L_matrix @ m_star + noise\n\n    # --- Objective Function and Derivatives ---\n\n    def get_objective_function(L, t_obs_data, sigma_val, beta_val, omega_val, gamma_val):\n        \"\"\"Returns a callable objective function.\"\"\"\n        data_denom = 2.0 * K_OBS * sigma_val**2\n\n        def phi(m):\n            phi_data = np.sum((L @ m - t_obs_data)**2) / data_denom\n            phi_reg = beta_val * np.sum(1.0 - np.cos(omega_val * m))\n            phi_smooth = gamma_val * np.sum((m[1:] - m[:-1])**2)\n            return phi_data + phi_reg + phi_smooth\n        return phi\n\n    objective_func = get_objective_function(L_matrix, t_obs, SIGMA, BETA, OMEGA, GAMMA)\n\n    def compute_gradient(phi_func, m, h_g=1e-6):\n        \"\"\"Computes gradient via central finite differences.\"\"\"\n        grad = np.zeros_like(m, dtype=float)\n        for i in range(len(m)):\n            m_plus_h = m.copy()\n            m_plus_h[i] += h_g\n            m_minus_h = m.copy()\n            m_minus_h[i] -= h_g\n            grad[i] = (phi_func(m_plus_h) - phi_func(m_minus_h)) / (2.0 * h_g)\n        return grad\n\n    def compute_curvature(phi_func, m, grad, h_c=1e-5):\n        \"\"\"Computes directional second derivative along the gradient.\"\"\"\n        grad_norm = np.linalg.norm(grad)\n        if grad_norm  1e-12:\n            u = np.zeros_like(m)\n            u[0] = 1.0\n        else:\n            u = grad / grad_norm\n        \n        phi_m = phi_func(m)\n        phi_plus = phi_func(m + h_c * u)\n        phi_minus = phi_func(m - h_c * u)\n        \n        kappa = (phi_plus - 2.0 * phi_m + phi_minus) / (h_c**2)\n        return kappa\n\n    # --- Test Suite Definition ---\n    test_cases = [\n        {'seed': 42, 'T_init': 1.0, 'tau': 0.1, 'g_th': 1.0e-3, 'c_th': 1.0e-3, 'N_SA': 800, 's_prop': 0.1},\n        {'seed': 7, 'T_init': 2.5, 'tau': 0.2, 'g_th': 3.0e-3, 'c_th': 5.0e-4, 'N_SA': 800, 's_prop': 0.15},\n        {'seed': 99, 'T_init': 0.5, 'tau': 0.05, 'g_th': 1.0e-4, 'c_th': 5.0e-3, 'N_SA': 800, 's_prop': 0.08},\n        {'seed': 123, 'T_init': 1.5, 'tau': 0.01, 'g_th': 0.0, 'c_th': 0.0, 'N_SA': 500, 's_prop': 0.12},\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        # --- Simulated Annealing ---\n        rng_sa = np.random.default_rng(case['seed'])\n        \n        m_current = M_INIT.copy()\n        cost_current = objective_func(m_current)\n        T = case['T_init']\n        alpha = 0.98\n        \n        m_handoff = None\n        handoff_iter = case['N_SA']\n\n        for k in range(1, case['N_SA'] + 1):\n            # Generate proposal\n            delta = rng_sa.normal(0, case['s_prop'] * T, size=D_DIM)\n            m_proposal = np.clip(m_current + delta, MODEL_BOUNDS[0], MODEL_BOUNDS[1])\n            cost_proposal = objective_func(m_proposal)\n            \n            # Acceptance Criterion\n            if cost_proposal  cost_current or rng_sa.random()  np.exp(-(cost_proposal - cost_current) / T):\n                m_current = m_proposal\n                cost_current = cost_proposal\n                \n                # Check Handoff Criteria\n                if T = case['tau'] * case['T_init']:\n                    grad = compute_gradient(objective_func, m_current)\n                    grad_norm = np.linalg.norm(grad)\n                    \n                    if grad_norm = case['g_th']:\n                        kappa = compute_curvature(objective_func, m_current, grad)\n                        if kappa >= case['c_th']:\n                            m_handoff = m_current.copy()\n                            handoff_iter = k\n                            break\n\n            # Cooling\n            T *= alpha\n\n        if m_handoff is None:\n            m_handoff = m_current.copy()\n        \n        cost_handoff = objective_func(m_handoff)\n\n        # --- L-BFGS Polishing ---\n        bounds = [MODEL_BOUNDS for _ in range(D_DIM)]\n        res = minimize(\n            objective_func,\n            m_handoff,\n            method='L-BFGS-B',\n            bounds=bounds\n        )\n        \n        cost_final = res.fun\n        \n        # --- Collect Results ---\n        improved = cost_final  cost_handoff\n        \n        case_result = [handoff_iter, cost_final, bool(improved)]\n        all_results.append(case_result)\n\n    # --- Final Output Formatting ---\n    # Convert Python list of lists to the required string format\n    result_str = str(all_results)\n    print(result_str)\n\nsolve()\n```"
        }
    ]
}