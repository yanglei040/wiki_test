{
    "hands_on_practices": [
        {
            "introduction": "理论联系实际是掌握计算地球物理学中守恒律的关键。本章的动手实践旨在通过一系列编码练习，将抽象的守恒原理转化为具体的、可验证的数值结果。我们将从最基本的概念开始，逐步深入到模拟复杂物理现象的前沿方法。\n\n### 实践一：验证有限体积法的质量守恒\n\n一维线性平流方程是所有守恒律的原型。有限体积法直接建立在守恒律的积分形式之上，这使得它在代数上具有“显式守恒”的特性。对于一个封闭系统，这意味着离散总质量应保持恒定。\n\n本练习将指导您实现一个为求解双曲型守恒律而设计的、经典的、高分辨率的有限体积格式。通过编码实践，您将能够数值验证模型的离散总质量在整个模拟过程中确实保持不变（直到机器精度），无论使用何种通量限制器。这为理解和信任保守型数值方法奠定了坚实的基础 。",
            "id": "3580957",
            "problem": "考虑一个由守恒律 $\\partial_t q + \\partial_x (u q) = 0$ 控制的被动标量质量密度 $q(x,t)$ 的一维守恒平流，其中 $u$ 是一个恒定的平流速度。一个长度为 $L$ 的均匀周期性区域被离散化为 $N$ 个宽度为 $\\Delta x = L/N$ 的有限体积单元。时间推进采用单步显式有限体积法，该方法包含分段线性重构和一个总变差递减 (TVD) 通量限制器。目标是量化对于一个陡峭前缘的初始条件，不同通量限制器的选择对总质量守恒的影响。\n\n基本设置：\n- 区域长度 $L = 1\\,\\mathrm{m}$，恒定速度 $u = 1\\,\\mathrm{m/s}$，最终时间 $T = L/u = 1\\,\\mathrm{s}$。\n- 初始质量密度分布 $q(x,0)$ 是一个方帽（矩形脉冲）函数，振幅 $q_0 = 3\\,\\mathrm{kg/m}$，起始位置 $x_s = 0.33\\,\\mathrm{m}$，宽度 $W = 0.2\\,\\mathrm{m}$。在此区间外，$q(x,0) = 0\\,\\mathrm{kg/m}$。\n- 在 $x=0$ 和 $x=L$ 处施加周期性边界条件。\n\n数值方法要求：\n- 对单元平均值 $q_i^n$ 使用守恒的有限体积更新格式\n  $q_i^{n+1} = q_i^n - \\frac{\\Delta t}{\\Delta x}\\left(F_{i+1/2}^n - F_{i-1/2}^n\\right)$，\n  其中数值通量对于 $u>0$ 为 $F_{i\\pm 1/2}^n = u\\, q_{i\\pm 1/2}^{-}$，而 $q_{i+1/2}^{-}$ 是总变差递减 (TVD) 格式中界面左側的重构值。\n- 重构必须是分段线性的，使用一个应用于相邻单元平均值计算出的连续单边斜率比值 $r$ 的 TVD 通量限制器 $\\phi(r)$。实现以下经典的 TVD 限制器：Upwind (一阶)、Minmod、Van Leer、Monotonized Central (MC) 和 Superbee。不要使用非守恒修正或任何非守恒滤波；严格执行通量差分形式的守恒性。\n- 时间步进必须遵守指定的 Courant–Friedrichs–Lewy (CFL) 数 $\\mathrm{CFL}$：计算 $\\Delta t_{\\mathrm{CFL}} = \\mathrm{CFL}\\, \\Delta x / |u|$，然后使用 $n = \\lceil T/\\Delta t_{\\mathrm{CFL}} \\rceil$ 个步数，时间步长为 $\\Delta t = T/n$，以确保最终时间恰好为 $T$。这保证了 $\\Delta t \\le \\Delta t_{\\mathrm{CFL}}$。\n\n质量诊断：\n- 在恰好一个完整的穿越时间 $T = L/u$ 后，计算离散的初始总质量 $M(0) = \\sum_i q_i^0\\, \\Delta x$ 和离散的最终总质量 $M(T) = \\sum_i q_i^n\\, \\Delta x$。\n- 对于每个测试用例，报告相对质量误差 $\\varepsilon = \\frac{M(T) - M(0)}{M(0)}$，以无量纲十进制数表示。将 $\\varepsilon$ 表示为浮点数（无单位）。\n\n测试套件：\n使用上面列出的初始条件和物理参数，运行以下测试用例，这些用例改变了网格分辨率 $N$、Courant–Friedrichs–Lewy 数 $\\mathrm{CFL}$ 和限制器的选择。所有量都采用国际单位制 (SI)，本问题中不涉及角度。\n- 测试 1：限制器 = Upwind, $N = 128$, $\\mathrm{CFL} = 0.5$。\n- 测试 2：限制器 = Minmod, $N = 128$, $\\mathrm{CFL} = 0.5$。\n- 测试 3：限制器 = Van Leer, $N = 128$, $\\mathrm{CFL} = 0.5$。\n- 测试 4：限制器 = Monotonized Central, $N = 128$, $\\mathrm{CFL} = 0.5$。\n- 测试 5：限制器 = Superbee, $N = 128$, $\\mathrm{CFL} = 0.5$。\n- 测试 6：限制器 = Minmod, $N = 32$, $\\mathrm{CFL} = 0.95$。\n- 测试 7：限制器 = Superbee, $N = 32$, $\\mathrm{CFL} = 0.95$。\n- 测试 8：限制器 = Van Leer, $N = 64$, $\\mathrm{CFL} = 0.95$。\n\n最终输出规范：\n您的程序应生成单行输出，其中包含测试套件的相对质量误差，格式为方括号内的逗号分隔列表，并严格按照上面列出的测试顺序。例如，输出格式应类似于 [ε₁,ε₂,...,ε₈]，其中每个 εₖ 都是一个浮点数。",
            "solution": "## 问题验证\n\n### 第 1 步：提取已知条件\n\n问题陈述提供了以下信息：\n\n**控制方程：**\n- 一维守恒平流：$\\partial_t q + \\partial_x (u q) = 0$。\n- $q(x,t)$ 是一个被动标量质量密度。\n- $u$ 是一个恒定的平流速度。\n\n**物理参数：**\n- 区域长度：$L = 1\\,\\mathrm{m}$。\n- 恒定速度：$u = 1\\,\\mathrm{m/s}$。\n- 最终时间：$T = L/u = 1\\,\\mathrm{s}$。\n- 区域是均匀且周期性的。\n\n**初始条件：**\n- 质量密度 $q(x,0)$ 的方帽（矩形脉冲）分布。\n- 振幅：$q_0 = 3\\,\\mathrm{kg/m}$。\n- 起始位置：$x_s = 0.33\\,\\mathrm{m}$。\n- 宽度：$W = 0.2\\,\\mathrm{m}$。\n- 在区间 $[x_s, x_s+W]$ 之外，$q(x,0) = 0\\,\\mathrm{kg/m}$。\n\n**数值方法：**\n- 离散化：$N$ 个宽度为 $\\Delta x = L/N$ 的有限体积单元。\n- 更新规则：$q_i^{n+1} = q_i^n - \\frac{\\Delta t}{\\Delta x}\\left(F_{i+1/2}^n - F_{i-1/2}^n\\right)$。\n- 对于 $u>0$ 的数值通量：$F_{i\\pm 1/2}^n = u\\, q_{i\\pm 1/2}^{-}$，其中 $q_{i+1/2}^{-}$ 是界面左侧的重构值。\n- 重构：使用 TVD 通量限制器 $\\phi(r)$ 的分段线性重构。\n- 限制器参数：$r$ 是由相邻单元平均值计算出的连续单边斜率的比值。\n- 限制器选择：Upwind、Minmod、Van Leer、Monotonized Central (MC)、Superbee。\n- 格式必须是严格守恒的（无非守恒修正/滤波）。\n- 时间步进：\n    - $\\Delta t_{\\mathrm{CFL}} = \\mathrm{CFL}\\, \\Delta x / |u|$。\n    - 步数 $n = \\lceil T/\\Delta t_{\\mathrm{CFL}} \\rceil$。\n    - 时间步长 $\\Delta t = T/n$。\n\n**质量诊断：**\n- 初始总质量：$M(0) = \\sum_i q_i^0\\, \\Delta x$。\n- 最终总质量：$M(T) = \\sum_i q_i^n\\, \\Delta x$。\n- 报告量：相对质量误差 $\\varepsilon = \\frac{M(T) - M(0)}{M(0)}$。\n\n**测试套件：**\n- 测试 1：限制器 = Upwind, $N = 128$, $\\mathrm{CFL} = 0.5$。\n- 测试 2：限制器 = Minmod, $N = 128$, $\\mathrm{CFL} = 0.5$。\n- 测试 3：限制器 = Van Leer, $N = 128$, $\\mathrm{CFL} = 0.5$。\n- 测试 4：限制器 = Monotonized Central, $N = 128$, $\\mathrm{CFL} = 0.5$。\n- 测试 5：限制器 = Superbee, $N = 128$, $\\mathrm{CFL} = 0.5$。\n- 测试 6：限制器 = Minmod, $N = 32$, $\\mathrm{CFL} = 0.95$。\n- 测试 7：限制器 = Superbee, $N = 32$, $\\mathrm{CFL} = 0.95$。\n- 测试 8：限制器 = Van Leer, $N = 64$, $\\mathrm{CFL} = 0.95$。\n\n### 第 2 步：使用提取的已知条件进行验证\n\n根据验证标准对问题进行分析：\n\n- **科学基础**：该问题描述了线性平流方程，这是流体动力学和输运现象中的一个基本模型。所指定的数值方法——一种带有 TVD 限制器的有限体积格式——是计算物理学中用于求解双曲守恒律的一种标准且成熟的技术。所有概念都具有科学合理性。\n- **适定性**：周期性区域上的线性平流初边值问题是适定的。所构建的数值格式在指定的 CFL 条件下是稳定的。任务是计算一个明确定义的数值量，即相对质量误差。\n- **客观性**：问题使用了精确、量化且无歧义的术语进行陈述。所有参数和步骤都得到了明确定义。\n- **完整性与一致性**：问题提供了所有必要的信息：偏微分方程、区域、初始和边界条件，对数值算法（包括离散化、通量计算、重构和时间步进）的完整描述，以及要计算的精确诊断量。没有矛盾之处。\n- **核心科学问题**：问题围绕质量守恒的性质展开。指定的有限体积更新规则是“通量差分”或“守恒”形式的。对于周期性区域，所有单元上的通量差分之和通过伸缩求和为零：\n$$ \\sum_{i=1}^{N} \\left(F_{i+1/2}^n - F_{i-1/2}^n\\right) = 0 $$\n这是因为周期性意味着离开最后一个单元的通量 $F_{N+1/2}$ 与进入第一个单元的通量 $F_{1/2}$ 相同。因此，在精确算术中，总离散质量 $M = \\sum_i q_i \\Delta x$ 在每个时间步都应精确守恒。该问题要求计算相对质量误差 $\\varepsilon = (M(T) - M(0))/M(0)$，预期该值仅因计算机算术中固有的浮点舍入误差累积而为非零。这是一个有效的数值验证练习，测试了实现对守恒公式的遵守程度。这并非易事，因为它需要对一个非平凡的数值格式进行正确而仔细的实现。\n\n### 第 3 步：结论与行动\n\n该问题是 **有效的**。它科学合理、适定，并为计算物理学中的一个标准数值实验提供了完整、无歧义的规范。将提供完整的解决方案。\n\n## 解决方案\n\n该问题要求实现一个二阶精度的总变差递减 (TVD) 有限体积格式，以求解周期性区域上的一维线性平流方程 $\\partial_t q + u \\partial_x q = 0$。主要目标是验证数值方法的质量守恒特性。\n\n### 1. 离散化和初始条件\n\n长度为 $L=1$ 的空间区域被离散化为 $N$ 个单元，每个单元的宽度为 $\\Delta x = L/N$。单元中心位于 $x_i = (i + 0.5)\\Delta x$，其中 $i=0, 1, \\dots, N-1$。\n量 $q_i^n$ 表示在时间步 $n$ 时单元 $i$ 中的单元平均质量密度。初始条件 $q(x,0)$ 是一个矩形脉冲。初始单元平均值 $q_i^0$ 通过对每个单元上的 $q(x,0)$进行积分来计算：\n$$ q_i^0 = \\frac{1}{\\Delta x} \\int_{i\\Delta x}^{(i+1)\\Delta x} q(x,0) \\,dx $$\n给定 $q(x,0) = q_0$ 对于 $x \\in [x_s, x_s+W]$ 且在其他地方为 $0$，该积分对应于 $q_0$ 乘以单元 $i$（即 $[i\\Delta x, (i+1)\\Delta x]$）与脉冲区间（即 $[x_s, x_s+W]$）的交集长度。\n\n### 2. 有限体积更新\n\n单元平均值的演化由守恒的有限体积公式决定：\n$$ q_i^{n+1} = q_i^n - \\frac{\\Delta t}{\\Delta x} \\left(F_{i+1/2}^n - F_{i-1/2}^n\\right) $$\n这里，$F_{i+1/2}$ 是单元 $i$ 和单元 $i+1$ 之间界面的数值通量。对于恒定的正速度 $u$，通量由界面上游（即左侧，用上标 $-$ 表示）的流体状态决定。\n$$ F_{i+1/2} = u \\, q_{i+1/2}^{-} $$\nTVD 格式的核心在于界面值 $q_{i+1/2}^{-}$ 的重构。\n\n### 3. 分段线性重构和 TVD 限制器\n\n通过假设每个单元内廓线是线性的，可以实现二阶精度重构。单元 $i$ 右侧界面的值重构为：\n$$ q_{i+1/2}^{-} = q_i^n + \\frac{1}{2} \\sigma_i \\Delta x $$\n其中 $\\sigma_i$ 是单元 $i$ 内的一个受限斜率。为了防止伪振荡并确保 TVD 属性，斜率受到限制。一种如问题所指定的常用方法是使用通量限制器函数 $\\phi(r)$：\n$$ \\sigma_i \\Delta x = \\phi(r_i) (q_i^n - q_{i-1}^n) $$\n比值 $r_i$ 比较了“下游”单元的斜率与“上游”单元的斜率（相对于波传播方向）：\n$$ r_i = \\frac{q_{i+1}^n - q_i^n}{q_i^n - q_{i-1}^n} $$\n将这些结合起来，得到重构公式：\n$$ q_{i+1/2}^{-} = q_i^n + \\frac{1}{2} \\phi(r_i) (q_i^n - q_{i-1}^n) $$\n当 $r_i$ 的分母为零时需要特别处理。在我们的实现中，在这种情况下我们定义 $r_i=0$，这会正确地导致修正项为零，因为对于所有指定的限制器，都有 $\\phi(0)=0$。\n\n问题要求实现五种不同的限制器函数 $\\phi(r)$：\n1.  **Upwind (一阶):** $\\phi(r) = 0$\n2.  **Minmod:** $\\phi(r) = \\max(0, \\min(1, r))$\n3.  **Van Leer:** $\\phi(r) = \\frac{r + |r|}{1 + |r|}$\n4.  **Monotonized Central (MC):** $\\phi(r) = \\max(0, \\min(2r, \\frac{1+r}{2}, 2))$\n5.  **Superbee:** $\\phi(r) = \\max(0, \\min(2r, 1), \\min(r, 2))$\n\n周期性边界条件通过在计算边界附近斜率时使用区域另一端的值来处理（例如，对于单元 $i=0$，“左”邻居 $q_{-1}$ 是 $q_{N-1}$）。\n\n### 4. 时间步进\n\n模拟运行总时间 $T$。选择时间步长 $\\Delta t$ 以满足 CFL 稳定性条件，并确保恰好达到最终时间。给定一个 CFL 数，允许的最大时间步长为 $\\Delta t_{\\mathrm{CFL}} = \\mathrm{CFL} \\frac{\\Delta x}{|u|}$。步数为 $n_{\\text{steps}} = \\lceil T/\\Delta t_{\\mathrm{CFL}} \\rceil$，实际使用的时间步长为 $\\Delta t = T / n_{\\text{steps}}$。\n\n### 5. 质量守恒验证\n\n在任何时间 $t_n$ 的总质量为 $M(t_n) = \\sum_{i=0}^{N-1} q_i^n \\Delta x$。从一个时间步到下一个时间步的总质量变化是：\n$$ M^{n+1} - M^n = \\Delta x \\sum_{i=0}^{N-1} (q_i^{n+1} - q_i^n) = -\\Delta t \\sum_{i=0}^{N-1} (F_{i+1/2} - F_{i-1/2}) $$\n由于周期性边界条件，区域两端的通量是相同的，即 $F_{-1/2} = F_{N-1/2}$。通量差分之和变成一个伸缩求和，其结果为零。因此，$M^{n+1} = M^n$。这对所有时间步都成立，所以在精确算術中 $M(T) = M(0)$。因此，计算出的相对误差 $\\varepsilon = (M(T) - M(0))/M(0)$ 将是对累积浮点舍入误差的度量。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nimport math\n\ndef solve():\n    \"\"\"\n    Main solver function that orchestrates the simulation for all test cases.\n    \"\"\"\n    \n    # --- Limiter Functions (phi(r)) ---\n    def limiter_upwind(r):\n        return np.zeros_like(r)\n\n    def limiter_minmod(r):\n        return np.maximum(0, np.minimum(1, r))\n\n    def limiter_van_leer(r):\n        # This form is safe for all r, including r=-1.\n        return (r + np.abs(r)) / (1 + np.abs(r))\n\n    def limiter_mc(r):\n        # phi(r) = max(0, min(2r, 0.5*(1+r), 2))\n        return np.maximum(0, np.minimum.reduce([2 * r, 0.5 * (1 + r), np.full_like(r, 2)]))\n\n    def limiter_superbee(r):\n        # phi(r) = max(0, min(2r, 1), min(r, 2))\n        return np.maximum(0, np.maximum(np.minimum(2 * r, 1), np.minimum(r, 2)))\n\n    limiter_map = {\n        \"Upwind\": limiter_upwind,\n        \"Minmod\": limiter_minmod,\n        \"Van Leer\": limiter_van_leer,\n        \"Monotonized Central\": limiter_mc,\n        \"Superbee\": limiter_superbee\n    }\n\n    # --- Test Cases ---\n    test_cases = [\n        {\"limiter\": \"Upwind\", \"N\": 128, \"CFL\": 0.5},\n        {\"limiter\": \"Minmod\", \"N\": 128, \"CFL\": 0.5},\n        {\"limiter\": \"Van Leer\", \"N\": 128, \"CFL\": 0.5},\n        {\"limiter\": \"Monotonized Central\", \"N\": 128, \"CFL\": 0.5},\n        {\"limiter\": \"Superbee\", \"N\": 128, \"CFL\": 0.5},\n        {\"limiter\": \"Minmod\", \"N\": 32, \"CFL\": 0.95},\n        {\"limiter\": \"Superbee\", \"N\": 32, \"CFL\": 0.95},\n        {\"limiter\": \"Van Leer\", \"N\": 64, \"CFL\": 0.95},\n    ]\n\n    results = []\n    for case in test_cases:\n        error = run_simulation(limiter_map[case[\"limiter\"]], case[\"N\"], case[\"CFL\"])\n        results.append(error)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.16e}' for r in results)}]\")\n\n\ndef run_simulation(limiter_func, N, CFL):\n    \"\"\"\n    Executes a single finite-volume simulation for a given setup.\n\n    Args:\n        limiter_func: The TVD limiter function phi(r).\n        N: Number of grid cells.\n        CFL: The Courant-Friedrichs-Lewy number.\n\n    Returns:\n        The relative mass error epsilon.\n    \"\"\"\n    # --- Physical Parameters ---\n    L = 1.0   # Domain length (m)\n    u = 1.0   # Advection velocity (m/s)\n    T = 1.0   # Final time (s)\n    q0 = 3.0  # Pulse amplitude (kg/m)\n    x_s = 0.33 # Pulse start position (m)\n    W = 0.2   # Pulse width (m)\n\n    # --- Numerical Parameters ---\n    dx = L / N\n    dt_cfl = CFL * dx / abs(u)\n    num_steps = math.ceil(T / dt_cfl)\n    dt = T / num_steps\n\n    # --- Initial Condition: Cell-Averaged Top-hat ---\n    cell_edges = np.linspace(0, L, N + 1)\n    q = np.zeros(N)\n    pulse_end = x_s + W\n    for i in range(N):\n        cell_start = cell_edges[i]\n        cell_end = cell_edges[i+1]\n        \n        # Calculate overlap between cell and pulse\n        overlap_start = max(cell_start, x_s)\n        overlap_end = min(cell_end, pulse_end)\n        overlap_length = max(0, overlap_end - overlap_start)\n        \n        q[i] = q0 * overlap_length / dx\n\n    # --- Initial Mass Calculation ---\n    M0 = np.sum(q) * dx\n\n    # --- Time Integration Loop ---\n    q_current = q.copy()\n    for _ in range(num_steps):\n        q_old = q_current.copy()\n\n        # Handle periodic boundaries using np.roll\n        q_im1 = np.roll(q_old, 1)  # q_{i-1}\n        q_ip1 = np.roll(q_old, -1) # q_{i+1}\n\n        # Calculate ratio of consecutive slopes r_i\n        # r_i = (q_{i+1} - q_i) / (q_i - q_{i-1})\n        numerator = q_ip1 - q_old\n        denominator = q_old - q_im1\n        \n        # Avoid division by zero. If denominator is zero, the correction term\n        # will be multiplied by it, so it becomes zero. r=0 is a safe choice.\n        r = np.zeros_like(q_old)\n        # Use a small epsilon to handle floating point noise around zero.\n        nonzero_denom_mask = np.abs(denominator) > 1e-15\n        r[nonzero_denom_mask] = numerator[nonzero_denom_mask] / denominator[nonzero_denom_mask]\n        \n        # Apply the chosen limiter function\n        phi_vals = limiter_func(r)\n        \n        # Reconstruct interface values q_{i+1/2}^-\n        # q_{i+1/2}^- = q_i + 0.5 * phi(r_i) * (q_i - q_{i-1})\n        q_interface_m = q_old + 0.5 * phi_vals * (q_old - q_im1)\n        \n        # Calculate fluxes at right-hand interfaces F_{i+1/2}\n        F_ip12 = u * q_interface_m\n        \n        # Fluxes at left-hand interfaces F_{i-1/2} are just rolled F_{i+1/2}\n        F_im12 = np.roll(F_ip12, 1)\n\n        # Update cell averages\n        q_current = q_old - (dt / dx) * (F_ip12 - F_im12)\n\n    # --- Final Mass Calculation and Error ---\n    M_T = np.sum(q_current) * dx\n    \n    # Avoid division by zero if M0 is zero (not the case here)\n    if abs(M0)  1e-15:\n        return 0.0\n    \n    relative_error = (M_T - M0) / M0\n    return relative_error\n\n\nsolve()\n```"
        },
        {
            "introduction": "### 实践二：追踪弹性波PML中的能量平衡\n\n在质量守恒的基础上，我们进一步探讨更复杂的能量守恒，并将研究对象从标量方程扩展到描述弹性波的方程组。在地球物理波传播模拟中，我们常常需要处理开放或无限大的计算域，这就引入了人工边界的问题。完美匹配层（PML）是吸收出射波而不产生虚假反射的标准技术。\n\n一个设计良好的、能量稳定的PML格式能够确保离开物理域的能量在PML内部被有效耗散，而不会被错误地反射或产生。本练习将指导您为弹性波方程实现一个交错网格有限差分格式，并配备一个能量稳定的PML。您将通过数值实验证明，包含PML所做耗散的系统总能量是守恒的，从而验证您实现的吸收边界条件的稳定性和准确性 。",
            "id": "3580942",
            "problem": "你的任务是，从质量、动量和能量守恒定律出发，推导、离散化并验证一个用于一维线性弹性剪切水平波传播的能量稳定的完美匹配层。在长度为 $L$ 的一维区域内进行计算，空间坐标为 $x \\in [0,L]$，时间为 $t \\ge 0$。假设存在一个密度为 $\\rho$、剪切模量为 $\\mu$ 的均匀、各向同性弹性固体，并考虑剪切水平极化，因此唯一非零的运动学场是横向质点速度 $v(x,t)$，唯一非零的应力是剪切应力 $\\tau(x,t)$。控制动量守恒和本构关系的是以下一阶双曲系统\n$$\n\\rho \\,\\partial_t v = \\partial_x \\tau, \\qquad \\partial_t \\tau = \\mu\\, \\partial_x v,\n$$\n其中 $\\partial_t$ 和 $\\partial_x$ 分别表示关于 $t$ 和 $x$ 的偏导数。物理能量密度为\n$$\n\\mathcal{E}(x,t) = \\tfrac{1}{2}\\,\\rho\\, v^2 + \\tfrac{1}{2}\\,\\mu^{-1}\\,\\tau^2,\n$$\n并且在没有源项和外力做功的情况下，总能量 \n$$\nE_{\\mathrm{tot}}(t) = \\int_{0}^{L} \\mathcal{E}(x,t)\\, dx\n$$\n在扣除由机械功率 $\\tau v$ 产生的边界通量后是守恒的。\n\n为了在界面 $x=x_{\\mathrm{p}}$ 处无反射地吸收出射波，引入了一个完美匹配层 (PML)，该层占据区域的最右侧部分 $x \\in [x_{\\mathrm{p}}, L]$，其中 $x_{\\mathrm{p}} \\in (0,L)$。使用通过在 PML 子区域内向一阶系统添加匹配的线性阻尼得到的场分离、能量稳定的 PML：\n$$\n\\rho \\,\\partial_t v + \\rho\\, \\sigma(x)\\, v = \\partial_x \\tau, \\qquad \\partial_t \\tau + \\sigma(x)\\, \\tau = \\mu\\, \\partial_x v,\n$$\n其中阻尼剖面 $\\sigma(x) \\ge 0$ 是光滑的，对于 $x \\in [0,x_{\\mathrm{p}}]$ 满足 $\\sigma(x)=0$，对于 $x \\in (x_{\\mathrm{p}}, L]$ 满足 $\\sigma(x)  0$。物理区域与PML的界面位于 $x=x_{\\mathrm{p}}$，在此处系数是连续的，且没有添加任何惩罚项或源项。\n\n你的任务是：\n\n- 根据上述基本定律，推导 PML 作用下的连续能量平衡，证明\n$$\n\\frac{d}{dt} E_{\\mathrm{tot}}(t) = - \\int_{0}^{L} \\Big( \\rho\\, \\sigma(x)\\, v^2 + \\mu^{-1}\\, \\sigma(x)\\, \\tau^2 \\Big) \\, dx \\;-\\; \\left[\\tau v\\right]_{x=0}^{x=L}.\n$$\n解释为什么 $\\sigma$ 项是非负的，以及为什么在物理区域-PML界面 $x=x_{\\mathrm{p}}$ 处没有出现人为源项。\n\n- 使用具有 $N_x$ 个单元和间距 $\\Delta x = L/N_x$ 的均匀交错网格对空间进行离散化。将 $v$ 放置在单元中心 $x_i = (i+\\tfrac{1}{2}) \\Delta x$ (其中 $i=0,1,\\dots,N_x-1$)，将 $\\tau$ 放置在单元面 $x_{j} = j \\Delta x$ (其中 $j=0,1,\\dots,N_x$)。使用与此交错方式一致的中心差分：\n$$\n\\left(D_x \\tau\\right)_i = \\frac{\\tau_{i+1} - \\tau_i}{\\Delta x}, \\qquad \\left(D_x v\\right)_j = \\frac{v_{j} - v_{j-1}}{\\Delta x},\n$$\n其中索引对应关系是显而易见的。通过施加 $\\tau_{0}(t)=0$ 和 $\\tau_{N_x}(t)=0$ (对所有 $t$) 来使用自由牵引边界。证明半离散（空间离散，时间连续）能量\n$$\nE_h(t) = \\sum_{i=0}^{N_x-1} \\tfrac{1}{2}\\,\\rho\\, v_i(t)^2 \\,\\Delta x \\;+\\; \\sum_{j=0}^{N_x} \\tfrac{1}{2}\\,\\mu^{-1}\\, \\tau_j(t)^2 \\,\\Delta x\n$$\n满足精确的半离散恒等式\n$$\n\\frac{d}{dt} E_h(t) \\;=\\; - \\sum_{i=0}^{N_x-1} \\rho\\, \\sigma_i\\, v_i(t)^2\\, \\Delta x \\;-\\; \\sum_{j=0}^{N_x} \\mu^{-1}\\, \\sigma_j\\, \\tau_j(t)^2\\, \\Delta x,\n$$\n前提是在自由牵引条件下离散边界通量为零，并且其中 $\\sigma_i=\\sigma(x_i)$ 和 $\\sigma_j=\\sigma(x_j)$。\n\n- 对时间进行离散化，对双曲耦合项在交错网格上使用蛙跳格式，对线性阻尼项应用梯形法则 (Crank–Nicolson)。用 $v_i^{n+\\tfrac{1}{2}} \\approx v(x_i, t^{n+\\tfrac{1}{2}})$ 和 $\\tau_j^{n} \\approx \\tau(x_j, t^n)$ 表示，其中 $t^n = n \\Delta t$。更新格式应为\n$$\n\\rho\\, \\frac{v_i^{n+\\tfrac{1}{2}} - v_i^{n-\\tfrac{1}{2}}}{\\Delta t} + \\rho\\, \\sigma_i\\, \\frac{v_i^{n+\\tfrac{1}{2}} + v_i^{n-\\tfrac{1}{2}}}{2} = \\left(D_x \\tau^{n}\\right)_i,\n$$\n$$\n\\frac{\\tau_j^{n+1} - \\tau_j^{n}}{\\Delta t} + \\sigma_j\\, \\frac{\\tau_j^{n+1} + \\tau_j^{n}}{2} = \\mu\\, \\left(D_x v^{n+\\tfrac{1}{2}}\\right)_j,\n$$\n其中对所有 $n$ 都有 $\\tau_0^n = \\tau_{N_x}^n = 0$。定义全离散总能量\n$$\nE_h^n = \\sum_{i=0}^{N_x-1} \\tfrac{1}{2}\\,\\rho\\, \\left(v_i^{n+\\tfrac{1}{2}}\\right)^2 \\,\\Delta x \\;+\\; \\sum_{j=0}^{N_x} \\tfrac{1}{2}\\,\\mu^{-1}\\, \\left(\\tau_j^{n}\\right)^2 \\,\\Delta x\n$$\n以及通过梯形法则定义到时间层 $n$ 的全离散累积 PML 耗散\n$$\n\\mathcal{D}_{\\mathrm{PML}}^{n} = \\sum_{k=0}^{n-1} \\Delta t \\left[ \\sum_{i=0}^{N_x-1} \\rho\\, \\sigma_i\\, \\frac{\\left(v_i^{k+\\tfrac{1}{2}}\\right)^2 + \\left(v_i^{k-\\tfrac{1}{2}}\\right)^2}{2}\\, \\Delta x \\;+\\; \\sum_{j=0}^{N_x} \\mu^{-1}\\, \\sigma_j\\, \\frac{\\left(\\tau_j^{k+1}\\right)^2 + \\left(\\tau_j^{k}\\right)^2}{2}\\, \\Delta x \\right].\n$$\n数值上证明，对于稳定的时间步长，离散能量恒等式\n$$\nE_h^{n} + \\mathcal{D}_{\\mathrm{PML}}^{n} \\approx E_h^{0}\n$$\n在一个很小的容差范围内成立，并且在物理区域-PML界面 $x=x_{\\mathrm{p}}$ 处没有伪源。\n\n- 在单个程序中实现上述格式，通过将 $t=0$ 时的初始场设置为\n$$\nv(x,0) = A \\exp\\!\\left(-\\frac{(x-x_0)^2}{2 s^2}\\right), \\qquad \\tau(x,0) = Z\\, v(x,0), \\qquad Z = \\sqrt{\\rho\\, \\mu},\n$$\n来初始化一个纯右行波，其中 $x_0 \\in (0, x_{\\mathrm{p}})$ 且 $s0$。使用 Courant–Friedrichs–Lewy (CFL) 时间步长 $\\Delta t = \\mathrm{CFL}\\, \\Delta x / c$ (其中 $c = \\sqrt{\\mu/\\rho}$)，以及一个多项式 PML 剖面\n$$\n\\sigma(x) = \\begin{cases}\n0,  x \\le x_{\\mathrm{p}} \\\\[4pt]\n\\sigma_0 \\left( \\dfrac{x - x_{\\mathrm{p}}}{L_{\\mathrm{pml}}} \\right)^m,  x > x_{\\mathrm{p}}\n\\end{cases}\n$$\n其中 $L_{\\mathrm{pml}} = L - x_{\\mathrm{p}}$ 是 PML 厚度，$\\sigma_0  0$ 是峰值阻尼参数，$m \\in \\mathbb{N}$ 是一个小偶数。在所有测试中，施加自由牵引边界 $\\tau(0,t)=0$ 和 $\\tau(L,t)=0$。在最终时刻 $t = n \\Delta t$ 计算残差\n$$\nR = \\left|\\, E_h^n + \\mathcal{D}_{\\mathrm{PML}}^{n} - E_h^{0}\\, \\right|\n$$\n并报告 $R$。\n\n使用以下物理单位和参数值：$\\rho$ 的单位是 $\\mathrm{kg}\\,\\mathrm{m}^{-3}$，$\\mu$ 的单位是 $\\mathrm{Pa}$，距离单位是 $\\mathrm{m}$，时间单位是 $\\mathrm{s}$，速度单位是 $\\mathrm{m}\\,\\mathrm{s}^{-1}$，应力单位是 $\\mathrm{Pa}$。使用 $\\rho = 2500$ 和 $\\mu = 10^{10}$。设置初始振幅 $A = 10^{-3}$，$x_0 = L/4$，$s = 50$。不使用角度。所有数值答案必须是作为实值小数的无量纲残差。\n\n测试套件。你的程序必须对以下四个测试用例运行该格式，并将四个残差 $R$ 作为单个列表输出。\n\n- 案例1（基准PML）：$L=2000$, $N_x=800$, $\\mathrm{CFL}=0.5$, $N_{\\mathrm{pml}} = 200$, $\\sigma_0 = 200$, $m = 2$, $T=0.8$。\n- 案例2（无PML）：$L=2000$, $N_x=800$, $\\mathrm{CFL}=0.5$, $N_{\\mathrm{pml}} = 0$, $\\sigma_0 = 0$, $m = 2$, $T=0.4$。\n- 案例3（强PML）：$L=2000$, $N_x=800$, $\\mathrm{CFL}=0.5$, $N_{\\mathrm{pml}} = 160$, $\\sigma_0 = 800$, $m = 2$, $T=0.6$。\n- 案例4（薄PML层）：$L=2000$, $N_x=800$, $\\mathrm{CFL}=0.5$, $N_{\\mathrm{pml}} = 20$, $\\sigma_0 = 400$, $m = 2$, $T=0.5$。\n\n此处，$N_{\\mathrm{pml}}$ 是 PML 中的网格单元数，因此 $x_{\\mathrm{p}} = L - N_{\\mathrm{pml}} \\Delta x$ 且 $L_{\\mathrm{pml}} = N_{\\mathrm{pml}} \\Delta x$。时间步长为 $\\Delta t = \\mathrm{CFL}\\, \\Delta x / c$，其中 $c=\\sqrt{\\mu/\\rho}$，步数为 $n=\\lfloor T/\\Delta t \\rfloor$。在每个案例中，将残差 $R$ 报告为一个浮点数。\n\n最终输出格式。你的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，顺序为 $[R_1,R_2,R_3,R_4]$，分别对应于案例1到4。",
            "solution": "该问题要求对一维线性弹性剪切水平 (SH) 波的能量稳定完美匹配层 (PML) 进行推导、离散化和验证。此过程分为几个任务，我们将按顺序逐一解决。\n\n### 任务1：连续能量平衡推导\n\n在区域 $[0, L]$ 内系统的总能量由下式给出\n$$\nE_{\\mathrm{tot}}(t) = \\int_{0}^{L} \\mathcal{E}(x,t)\\, dx = \\int_{0}^{L} \\left( \\tfrac{1}{2}\\,\\rho\\, v^2 + \\tfrac{1}{2}\\,\\mu^{-1}\\,\\tau^2 \\right) dx.\n$$\n为求得能量平衡，我们计算 $E_{\\mathrm{tot}}(t)$ 的时间导数。假设场足够光滑，我们可以在积分号下进行微分：\n$$\n\\frac{dE_{\\mathrm{tot}}}{dt} = \\int_{0}^{L} \\partial_t \\mathcal{E}(x,t) dx = \\int_{0}^{L} \\left( \\rho v\\, \\partial_t v + \\mu^{-1} \\tau\\, \\partial_t \\tau \\right) dx.\n$$\n包含 PML 阻尼项 $\\sigma(x)$ 的控制方程为：\n$$\n\\rho \\,\\partial_t v = \\partial_x \\tau - \\rho\\, \\sigma(x)\\, v, \\qquad \\partial_t \\tau = \\mu\\, \\partial_x v - \\sigma(x)\\, \\tau.\n$$\n我们可以将第二个方程重写为 $\\mu^{-1} \\partial_t \\tau = \\partial_x v - \\mu^{-1}\\sigma(x)\\tau$。将 $\\rho\\,\\partial_t v$ 和 $\\mu^{-1}\\,\\partial_t \\tau$ 的这些表达式代入能量变化率的被积函数，可得：\n$$\n\\partial_t \\mathcal{E} = v \\left( \\partial_x \\tau - \\rho\\, \\sigma v \\right) + \\tau \\left( \\partial_x v - \\mu^{-1} \\sigma \\tau \\right)\n$$\n$$\n\\partial_t \\mathcal{E} = (v\\, \\partial_x \\tau + \\tau\\, \\partial_x v) - \\left( \\rho\\, \\sigma v^2 + \\mu^{-1} \\sigma \\tau^2 \\right).\n$$\n使用导数的乘法法则，$v\\, \\partial_x \\tau + \\tau\\, \\partial_x v = \\partial_x(\\tau v)$。因此，能量密度的变化率为：\n$$\n\\partial_t \\mathcal{E} = \\partial_x(\\tau v) - \\left( \\rho\\, \\sigma v^2 + \\mu^{-1} \\sigma \\tau^2 \\right).\n$$\n将此表达式在区域 $[0, L]$ 上积分，得到总能量平衡：\n$$\n\\frac{dE_{\\mathrm{tot}}}{dt} = \\int_{0}^{L} \\partial_x(\\tau v) dx - \\int_{0}^{L} \\left( \\rho\\, \\sigma(x)\\, v^2 + \\mu^{-1}\\, \\sigma(x)\\, \\tau^2 \\right) dx.\n$$\n对第一个积分应用微积分基本定理，我们得到 $\\int_{0}^{L} \\partial_x(\\tau v) dx = [\\tau v]_{x=0}^{x=L}$。项 $-[\\tau v]_{x=0}^{x=L}$ 代表进入区域的净能量通量。标准惯例是将能量平衡写为能量变化率等于净功率输入减去任何耗散。在边界处流出区域的功率通量由机械功率 $\\tau v$ 给出。因此，总能量变化率为：\n$$\n\\frac{dE_{\\mathrm{tot}}}{dt} = - \\int_{0}^{L} \\left( \\rho\\, \\sigma(x)\\, v^2 + \\mu^{-1}\\, \\sigma(x)\\, \\tau^2 \\right) dx - \\left[\\tau v\\right]_{x=0}^{x=L}.\n$$\n这与问题陈述中给出的表达式相匹配。\n\n项 $\\mathcal{W}_{\\mathrm{PML}} = \\rho\\, \\sigma(x)\\, v^2 + \\mu^{-1}\\, \\sigma(x)\\, \\tau^2$ 表示 PML 导致的单位长度能量耗散率。由于材料属性 $\\rho$ 和 $\\mu$ 为正，且阻尼剖面定义为非负 $\\sigma(x) \\ge 0$，因此 $\\mathcal{W}_{\\mathrm{PML}}$ 中的每一项都是非负的。因此，积分 $\\int_0^L \\mathcal{W}_{\\mathrm{PML}}(x, t) dx$ 也是非负的，这证实了 PML 项对应于能量耗散（或在 $\\sigma=0$ 处为零），绝不会产生能量。\n\n在物理区域-PML界面 $x=x_{\\mathrm{p}}$ 处没有出现人为源项，因为控制方程的构建使其在整个区域 $[0,L]$ 上都有效。阻尼剖面 $\\sigma(x)$ 被定义为连续的（实际上是光滑的），因此偏微分方程的系数在 $x=x_{\\mathrm{p}}$ 处是连续的。推导过程涉及标准的微积分运算（乘法法则、分部积分），在函数及其系数连续的界面上，这些运算不会引入任何奇异项或跳跃条件。\n\n### 任务2：半离散能量平衡推导\n\n半离散系统是通过仅在空间上进行离散化得到的。方程为：\n$$\n\\rho \\frac{d v_i}{dt} = \\frac{\\tau_{i+1} - \\tau_i}{\\Delta x} - \\rho \\sigma_i v_i, \\qquad i=0,\\dots,N_x-1\n$$\n$$\n\\frac{d \\tau_j}{dt} = \\mu \\frac{v_j - v_{j-1}}{\\Delta x} - \\sigma_j \\tau_j, \\qquad j=1,\\dots,N_x-1\n$$\n边界条件为 $\\tau_0(t)=\\tau_{N_x}(t)=0$。因此时间导数 $\\dot{\\tau}_0$ 和 $\\dot{\\tau}_{N_x}$ 也为零。\n\n半离散总能量由下式给出：\n$$\nE_h(t) = \\sum_{i=0}^{N_x-1} \\tfrac{1}{2}\\,\\rho\\, v_i^2 \\,\\Delta x + \\sum_{j=0}^{N_x} \\tfrac{1}{2}\\,\\mu^{-1}\\, \\tau_j^2 \\,\\Delta x.\n$$\n对时间求导：\n$$\n\\frac{dE_h}{dt} = \\sum_{i=0}^{N_x-1} \\rho v_i \\frac{dv_i}{dt} \\Delta x + \\sum_{j=0}^{N_x} \\mu^{-1} \\tau_j \\frac{d\\tau_j}{dt} \\Delta x.\n$$\n由于 $\\dot{\\tau}_0=\\dot{\\tau}_{N_x}=0$，第二个求和实际上是从 $j=1$ 到 $N_x-1$。代入半离散方程：\n$$\n\\frac{dE_h}{dt} = \\sum_{i=0}^{N_x-1} v_i (\\tau_{i+1} - \\tau_i) - \\sum_{i=0}^{N_x-1} \\rho \\sigma_i v_i^2 \\Delta x + \\sum_{j=1}^{N_x-1} \\tau_j (v_j - v_{j-1}) - \\sum_{j=1}^{N_x-1} \\mu^{-1} \\sigma_j \\tau_j^2 \\Delta x.\n$$\n让我们使用分部求和法来分析通量项：\n$$\n\\sum_{i=0}^{N_x-1} v_i (\\tau_{i+1} - \\tau_i) = \\sum_{i=0}^{N_x-1} v_i \\tau_{i+1} - \\sum_{i=0}^{N_x-1} v_i \\tau_i.\n$$\n改变第一项中的求和索引 ($k=i+1$)：\n$$\n\\sum_{k=1}^{N_x} v_{k-1} \\tau_k - \\sum_{i=0}^{N_x-1} v_i \\tau_i = (v_{N_x-1}\\tau_{N_x} - v_0\\tau_0) + \\sum_{i=1}^{N_x-1} (v_{i-1} - v_i)\\tau_i = (v_{N_x-1}\\tau_{N_x} - v_0\\tau_0) - \\sum_{i=1}^{N_x-1} \\tau_i (v_i - v_{i-1}).\n$$\n对 $\\frac{dE_h}{dt}$ 的总通量贡献（非耗散部分）是：\n$$\n\\sum_{i=0}^{N_x-1} v_i (\\tau_{i+1} - \\tau_i) + \\sum_{j=1}^{N_x-1} \\tau_j(v_j-v_{j-1}) = (v_{N_x-1}\\tau_{N_x} - v_0\\tau_0) - \\sum_{j=1}^{N_x-1} \\tau_j (v_j - v_{j-1}) + \\sum_{j=1}^{N_x-1} \\tau_j(v_j - v_{j-1}).\n$$\n求和项相互抵消，只剩下离散边界通量：$v_{N_x-1}\\tau_{N_x} - v_0\\tau_0$。给定自由牵引边界条件 $\\tau_0=0$ 和 $\\tau_{N_x}=0$，此边界通量项为零。\n\n于是，完整的能量平衡就是耗散项之和：\n$$\n\\frac{dE_h}{dt} = - \\sum_{i=0}^{N_x-1} \\rho \\sigma_i v_i^2 \\Delta x - \\sum_{j=1}^{N_x-1} \\mu^{-1} \\sigma_j \\tau_j^2 \\Delta x.\n$$\n由于 $\\tau_0 = \\tau_{N_x} = 0$，它们对 $\\tau$ 的耗散求和的贡献将为零。因此，我们可以将求和写成遍历所有应力点 $j=0, \\dots, N_x$ 而不改变结果，从而与所要求的表达式相匹配：\n$$\n\\frac{dE_h}{dt} = - \\sum_{i=0}^{N_x-1} \\rho\\, \\sigma_i\\, v_i^2\\, \\Delta x - \\sum_{j=0}^{N_x} \\mu^{-1}\\, \\sigma_j\\, \\tau_j^2\\, \\Delta x.\n$$\n\n### 任务3和4：全离散格式、能量恒等式与实现\n\n所提供的全离散格式在交错的时间层上更新速度 $v$ 和应力 $\\tau$。实现过程需要谨慎处理蛙跳格式的初始化、主时间步进循环，以及离散能量和耗散项的计算。\n\n**格式重排**：可以对更新方程进行重排，以求解新时间层上的场。\n对于 $v_i^{n+1/2}$：\n$$\nv_i^{n+\\tfrac{1}{2}} = \\frac{ 1 - \\frac{\\sigma_i \\Delta t}{2} }{ 1 + \\frac{\\sigma_i \\Delta t}{2} } v_i^{n-\\tfrac{1}{2}} + \\frac{\\Delta t/\\rho}{ 1 + \\frac{\\sigma_i \\Delta t}{2} } \\left(\\frac{\\tau_{i+1}^{n} - \\tau_i^{n}}{\\Delta x}\\right)\n$$\n对于 $\\tau_j^{n+1}$：\n$$\n\\tau_j^{n+1} = \\frac{1 - \\frac{\\sigma_j \\Delta t}{2}}{1 + \\frac{\\sigma_j \\Delta t}{2}} \\tau_j^n + \\frac{\\mu \\Delta t}{1 + \\frac{\\sigma_j \\Delta t}{2}} \\left(\\frac{v_j^{n+\\tfrac{1}{2}} - v_{j-1}^{n+\\tfrac{1}{2}}}{\\Delta x}\\right)\n$$\n\n**初始化**：对于一个二阶精度的蛙跳格式启动，我们需要 $t=-\\Delta t/2$ 时的 $v$。这可以通过使用泰勒展开从 $t=0$ 的条件来近似：$v(x, -\\Delta t/2) \\approx v(x,0) - \\frac{\\Delta t}{2}\\partial_t v(x,0)$。利用偏微分方程，$\\partial_t v(0) = \\frac{1}{\\rho}\\partial_x \\tau(0)$。这导出了离散初始化 $v_i^{-1/2} = v_i(0) - \\frac{\\Delta t}{2\\rho}(D_x\\tau^0)_i$。\n\n**能量平衡解释**：问题要求在最终时刻验证 $E_h^{n} + \\mathcal{D}_{\\mathrm{PML}}^{n} \\approx E_h^{0}$。$E_h^n$ 和 $\\mathcal{D}_{\\mathrm{PML}}^n$ 的定义虽然有些不寻常，但是是明确的。设总时间步数为 $N_t = \\lfloor T/\\Delta t \\rfloor$。一个一致的解释是在倒数第二个时间步检查该恒等式，即 $n=N_t$。这意味着我们检查：\n$$\nE_h^{N_t} + \\mathcal{D}_{\\mathrm{PML}}^{N_t} \\approx E_h^{0}.\n$$\n各项为：\n- $E_h^0 = \\sum_{i} \\tfrac{1}{2}\\,\\rho\\,(v_i^{1/2})^2 \\Delta x + \\sum_{j} \\tfrac{1}{2}\\,\\mu^{-1}\\,(\\tau_j^0)^2 \\Delta x$。这是在一次速度半步更新后计算的。\n- $E_h^{N_t} = \\sum_{i} \\tfrac{1}{2}\\,\\rho\\,(v_i^{N_t+1/2})^2 \\Delta x + \\sum_{j} \\tfrac{1}{2}\\,\\mu^{-1}\\,(\\tau_j^{N_t})^2 \\Delta x$。这是使用最终可用场计算的能量。\n- $\\mathcal{D}_{\\mathrm{PML}}^{N_t} = \\sum_{k=0}^{N_t-1} \\Delta t \\left[ \\dots \\right]$。这是在 $N_t$ 步内的累积耗散。\n\n数值实现将执行时间步进循环 $N_t$ 次，在每一步计算并累积离散耗散。最后，将初始能量与最终能量和总累积耗散之和进行比较，以求出残差 $R$。",
            "answer": "```python\nimport numpy as np\n\ndef run_simulation(L, Nx, CFL, Npml, sigma0, m, T, rho, mu, A, x0_factor, s):\n    # Numerical and physical parameter setup\n    dx = L / Nx\n    c = np.sqrt(mu / rho)\n    dt = CFL * dx / c\n    Nt = int(T / dt)\n    Z = np.sqrt(rho * mu)\n    x0 = L * x0_factor\n\n    # Staggered grids for velocity (v) and stress (tau)\n    x_v = (np.arange(Nx) + 0.5) * dx\n    x_tau = np.arange(Nx + 1) * dx\n\n    # PML damping profile setup\n    sigma_v = np.zeros(Nx)\n    sigma_tau = np.zeros(Nx + 1)\n    if Npml > 0:\n        xp = L - Npml * dx\n        Lpml = Npml * dx\n        \n        idx_v_pml = np.where(x_v > xp)\n        sigma_v[idx_v_pml] = sigma0 * ((x_v[idx_v_pml] - xp) / Lpml)**m\n\n        idx_tau_pml = np.where(x_tau > xp)\n        sigma_tau[idx_tau_pml] = sigma0 * ((x_tau[idx_tau_pml] - xp) / Lpml)**m\n    \n    # Pre-compute update coefficients for efficiency\n    Cv1 = (1 - sigma_v * dt / 2) / (1 + sigma_v * dt / 2)\n    Cv2 = (dt / rho) / (1 + sigma_v * dt / 2)\n    Ctau1 = (1 - sigma_tau * dt / 2) / (1 + sigma_tau * dt / 2)\n    Ctau2 = (mu * dt) / (1 + sigma_tau * dt / 2)\n\n    # Initialization of fields\n    # v_ic and tau_ic are the fields at t=0\n    v_ic = A * np.exp(-(x_v - x0)**2 / (2 * s**2))\n    tau_ic = Z * A * np.exp(-(x_tau - x0)**2 / (2 * s**2))\n    \n    tau_curr = tau_ic.copy()\n    tau_curr[0] = 0\n    tau_curr[Nx] = 0\n\n    # Leapfrog startup: v_prev is v at t = -dt/2\n    dtau_dx_0 = (tau_curr[1:] - tau_curr[:-1]) / dx\n    v_prev = v_ic - (dt / (2 * rho)) * dtau_dx_0\n\n    # Calculate initial energy E_h^0\n    # First, compute v_curr (v at t = dt/2)\n    dtau_dx = (tau_curr[1:] - tau_curr[:-1]) / dx\n    v_curr = Cv1 * v_prev + Cv2 * dtau_dx\n    \n    KE0 = 0.5 * rho * np.sum(v_curr**2) * dx\n    PE0 = 0.5 / mu * np.sum(tau_curr**2) * dx\n    E_h0 = KE0 + PE0\n    \n    # Main time-stepping loop\n    D_pml_total = 0.0\n    \n    # We loop Nt times to compute fields up to tau^{Nt} and v^{Nt+1/2}\n    for n in range(Nt):\n        # Update tau from time n to n+1\n        dv_dx = (v_curr[1:] - v_curr[:-1]) / dx\n        tau_next = np.zeros_like(tau_curr)\n        # Boundary conditions are handled by not updating tau_next[0] and tau_next[-1]\n        tau_next[1:-1] = Ctau1[1:-1] * tau_curr[1:-1] + Ctau2[1:-1] * dv_dx\n        \n        # Update cumulative dissipation using trapezoidal rule for the step\n        diss_v = rho * sigma_v * (v_curr**2 + v_prev**2) / 2\n        diss_tau = (1/mu) * sigma_tau * (tau_next**2 + tau_curr**2) / 2\n        D_pml_total += dt * dx * (np.sum(diss_v) + np.sum(diss_tau))\n        \n        # Cycle states for the next iteration\n        v_prev = v_curr.copy()\n        tau_curr = tau_next.copy()\n        \n        # Update v from time n+1/2 to n+3/2\n        dtau_dx = (tau_curr[1:] - tau_curr[:-1]) / dx\n        v_curr = Cv1 * v_prev + Cv2 * dtau_dx\n\n    # Calculate final energy and residual\n    # v_curr is now v at t = (Nt+1/2)*dt\n    # tau_curr is now tau at t = Nt*dt\n    KE_final = 0.5 * rho * np.sum(v_curr**2) * dx\n    PE_final = 0.5 / mu * np.sum(tau_curr**2) * dx\n    E_h_final = KE_final + PE_final\n    \n    # R = | E_final + Dissipation - E_initial |\n    residual = np.abs(E_h_final + D_pml_total - E_h0)\n    \n    return residual\n\ndef solve():\n    # Define physical parameters\n    rho = 2500.0  # kg/m^3\n    mu = 1e10    # Pa\n    A = 1e-3     # m/s\n    s = 50.0     # m\n    x0_factor = 0.25 # x0 = L/4\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (L, Nx, CFL, Npml, sigma0, m, T)\n        (2000.0, 800, 0.5, 200, 200.0, 2, 0.8), # Case 1\n        (2000.0, 800, 0.5, 0, 0.0, 2, 0.4),    # Case 2\n        (2000.0, 800, 0.5, 160, 800.0, 2, 0.6), # Case 3\n        (2000.0, 800, 0.5, 20, 400.0, 2, 0.5),  # Case 4\n    ]\n\n    results = []\n    for L, Nx, CFL, Npml, sigma0, m, T in test_cases:\n        residual = run_simulation(L, Nx, CFL, Npml, sigma0, m, T, rho, mu, A, x0_factor, s)\n        results.append(residual)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.15e}' for r in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "### 实践三：模拟弹塑性中的能量耗散\n\n作为一项更高级的实践，我们将处理一个同时包含数值耗散和物理耗散的复杂问题。弹塑性是模拟地质材料（如岩石和土壤）永久变形的关键物理模型。在弹塑性系统中，机械能本身并不守恒，而是在不可逆的塑性变形过程中转化为热能。因此，数值格式必须遵循能量耗散的物理规律，这在数学上表现为一个熵不等式（离散形式的热力学第二定律）。\n\n本练习要求您为一个包含塑性流变的弹塑性动力学系统，实现一个熵稳定格式。您将使用算子分裂法，将双曲部分的演化与塑性“返回映射”算法相结合。最终，您将验证总机械能的减少量与数值耗散和物理塑性功之和精确匹配，从而确保您的模拟既稳定又符合物理现实 。",
            "id": "3580945",
            "problem": "考虑在空间域 $x \\in [0,L]$ 上具有周期性边界条件的一维小应变弹性动力学问题，其中包含弹塑性流变。主要场量为速度 $v(x,t)$ 和 Cauchy 应力 $\\sigma(x,t)$。密度为 $\\rho  0$，弹性模量为 $E  0$。令总应变为 $\\varepsilon(x,t)$，塑性应变为 $\\varepsilon^p(x,t)$。基本原理包括：(i) 线性动量守恒 $ \\rho \\, \\partial_t v = \\partial_x \\sigma$，(ii) 运动学相容性 $\\partial_t \\varepsilon = \\partial_x v$，(iii) 描述弹性响应的 Hooke 定律 $\\sigma = E (\\varepsilon - \\varepsilon^p)$，以及 (iv) 理想塑性，其屈服应力为 $\\sigma_y \\ge 0$，关联流动法则要求 $|\\sigma| \\le \\sigma_y$ 且塑性耗散密度率 $\\mathcal{D} = \\sigma \\, \\dot{\\varepsilon}^p \\ge 0$。结合 (i)-(iii) 可得到带源项的对称双曲一阶系统，\n$$\n\\partial_t \\begin{bmatrix} v \\\\ \\sigma \\end{bmatrix}\n+ \\partial_x \\begin{bmatrix} -\\sigma/\\rho \\\\ -E v \\end{bmatrix}\n= \\begin{bmatrix} 0 \\\\ -E \\, \\dot{\\varepsilon}^p \\end{bmatrix}.\n$$\n定义机械能密度\n$$\n\\eta(v,\\sigma) = \\tfrac{1}{2} \\rho v^2 + \\tfrac{1}{2}\\, \\sigma^2/E,\n$$\n以及相应的能量通量 $g(v,\\sigma) = -\\sigma v$。(i)-(iv) 所蕴含的连续介质能量平衡方程为\n$$\n\\frac{d}{dt} \\int_0^L \\eta \\, dx = \\left[ g \\right]_0^L - \\int_0^L \\sigma \\, \\dot{\\varepsilon}^p \\, dx,\n$$\n对于周期性边界，由于通量项抵消，该式可简化为\n$$\n\\frac{d}{dt} \\int_0^L \\eta \\, dx = - \\int_0^L \\sigma \\, \\dot{\\varepsilon}^p \\, dx \\le 0\n$$\n\n您的任务是构建一种分片常数间断 Galerkin (DG) 方法（该方法等价于一种迎风有限体积格式），该方法需是熵稳定的，即满足能量不等式的离散对应形式：\n$$\n\\frac{d}{dt} E_h(t) \\le - \\sum_{K} \\int_{K} \\sigma \\, \\dot{\\varepsilon}^p \\, dx,\n$$\n其中 $E_h(t)$ 是半离散总能量。您必须基于以下原则构建您的方法，不得使用简化公式：\n\n1. 从上述一阶系统在 $[0,L]$ 上的弱形式出发，该区域被剖分为 $N$ 个大小为 $\\Delta x = L/N$ 的单元，并具有周期性边界。\n2. 每个单元使用单自由度（分片常数基），以及一个双分量状态 $q = [v,\\sigma]^T$。\n3. 推导半离散格式\n$$\n\\frac{d}{dt} q_i(t) = - \\frac{1}{\\Delta x} \\left( f^*_{i+1/2} - f^*_{i-1/2} \\right) + s(q_i),\n$$\n其中 $f(q) = [-\\sigma/\\rho,\\ -E v]^T$，$s(q) = [0,\\ -E \\dot{\\varepsilon}^p]^T$，且 $f^*_{i \\pm 1/2}$ 是相容的数值通量。\n4. 在每个界面上使用局部 Lax-Friedrichs (Rusanov) 通量，其波速界为 $\\alpha \\ge \\sqrt{E/\\rho}$：\n$$\nf^*(q_L,q_R) = \\tfrac{1}{2}\\left(f(q_L) + f(q_R)\\right) - \\tfrac{1}{2}\\, \\alpha \\, (q_R - q_L).\n$$\n5. 证明该系统是对称双曲的，其对称化子为 $H = \\mathrm{diag}(\\rho, 1/E)$，并且上述通量能够导出一个离散能量不等式，形式如下\n$$\n\\frac{d}{dt} E_h(t) + \\sum_{\\text{interfaces}} \\tfrac{1}{2}\\, \\alpha \\, \\| [q] \\|_H^2 \\le - \\sum_{i} \\Delta x \\, \\sigma_i \\, \\dot{\\varepsilon}_i^p,\n$$\n其中 $E_h(t) = \\sum_i \\Delta x \\, \\eta(v_i,\\sigma_i)$，跳跃为 $[q] = q_R - q_L$，并且 $\\|w\\|_H^2 = w^T H w$。\n6. 对于时间离散化，对齐次部分（不考虑塑性）使用强稳定性保持 Runge-Kutta (SSP-RK) 积分器，然后应用局部的、逐单元的塑性返回映射投影，以强制满足 $|\\sigma| \\le \\sigma_y$ 并计入塑性耗散。在一维空间和理想塑性条件下，当 $|\\sigma^{\\mathrm{tr}}|  \\sigma_y$ 时，从试探应力 $\\sigma^{\\mathrm{tr}}$ 到容许应力 $\\sigma^{\\mathrm{ad}} = \\sigma_y \\, \\mathrm{sign}(\\sigma^{\\mathrm{tr}})$ 的一个相容的能量耗散修正确立了塑性应变增量\n$$\n\\Delta \\varepsilon^p = \\frac{|\\sigma^{\\mathrm{tr}}| - \\sigma_y}{E},\n$$\n以及单位体积的塑性耗散增量，其值等于应力沿修正路径的路径积分，\n$$\n\\Delta \\mathcal{D} = \\int \\sigma \\, d\\varepsilon^p = \\tfrac{1}{2}\\left(|\\sigma^{\\mathrm{tr}}|+\\sigma_y\\right)\\Delta \\varepsilon^p = \\frac{|\\sigma^{\\mathrm{tr}}|^2 - \\sigma_y^2}{2E} \\ge 0,\n$$\n该值恰好等于投影过程中弹性势能密度 $\\tfrac{1}{2}(\\sigma^2/E)$ 的减少量。\n\n您必须在单个程序中实现上述方法，以推进具有周期性边界的解。使用满足 Courant-Friedrichs-Lewy (CFL) 条件的显式时间步。通过在每个时间步将每个单元的塑性耗散增量乘以单元体积并求和，来累积总塑性耗散 $D_{\\mathrm{tot}}$。\n\n数值单位与最终输出：\n\n- 使用国际单位制。具体来说，长度 $L$ 以 $\\mathrm{m}$ 为单位，密度 $\\rho$ 以 $\\mathrm{kg/m^3}$ 为单位，弹性模量 $E$ 以 $\\mathrm{Pa}$ 为单位，应力 $\\sigma$ 和屈服应力 $\\sigma_y$ 以 $\\mathrm{Pa}$ 为单位，时间 $t$ 以 $\\mathrm{s}$ 为单位，能量以 $\\mathrm{J}$ 为单位。\n- 程序必须在单行中输出一个用方括号括起来的逗号分隔列表，不含空格，该列表汇总了三个浮点数和三个布尔值：$[e_1,e_2,e_3,b_1,b_2,b_3]$，其中\n  - $e_1$ 是纯弹性测试的最终总能量减去初始总能量 $E_h(T) - E_h(0)$，单位为 $\\mathrm{J}$，\n  - $e_2$ 是弹塑性测试中相对于塑性耗散的最终能量赤字 $E_h(T) - (E_h(0) - D_{\\mathrm{tot}})$，单位为 $\\mathrm{J}$，\n  - $e_3$ 是接近 CFL 极限的弹性测试的最终能量减去初始能量 $E_h(T) - E_h(0)$，单位为 $\\mathrm{J}$，\n  - $b_1$ 是一个布尔值，如果 $e_1 \\le \\tau_1$ 且 $\\tau_1 = 10^{-8} E_h(0)$（无虚假弹性势能增长），则必须为真，\n  - $b_2$ 是一个布尔值，如果 $E_h(T) \\le E_h(0) + \\tau_2$ 且 $e_2 \\le \\tau_2$，其中 $\\tau_2 = 10^{-8} \\max\\{E_h(0), D_{\\mathrm{tot}}, 1\\}$（塑性耗散得到遵守且无虚假增长），则必须为真，\n  - $b_3$ 是一个布尔值，如果 $e_3 \\le \\tau_3$ 且 $\\tau_3 = 10^{-8} E_h(0)$（在稳定性极限附近无虚假增长），则必须为真。\n\n测试套件：\n\n为以下三个具有周期性边界的测试用例实现该方法，并按上述规定报告指标。在所有情况下，设置横截面积等于 $1\\,\\mathrm{m}^2$，以使能量单位为 $\\mathrm{J}$。\n\n- 测试 $1$ (纯弹性，中等 CFL):\n  - $L = 1\\,\\mathrm{m}$,\n  - $N = 200$ 个单元,\n  - $\\rho = 2500\\,\\mathrm{kg/m^3}$,\n  - $E = 10^{10}\\,\\mathrm{Pa}$,\n  - $\\sigma_y = 10^{18}\\,\\mathrm{Pa}$ (等效为弹性),\n  - 初始条件 $v(x,0) = 0$, $\\sigma(x,0) = S_0 \\sin(2\\pi x/L)$，其中 $S_0 = 5 \\times 10^{6}\\,\\mathrm{Pa}$,\n  - CFL 数 $= 0.5$,\n  - 最终时间 $T = 2 \\times 10^{-4}\\,\\mathrm{s}$.\n- 测试 $2$ (弹塑性，中等 CFL):\n  - $L = 1\\,\\mathrm{m}$,\n  - $N = 200$ 个单元,\n  - $\\rho = 2500\\,\\mathrm{kg/m^3}$,\n  - $E = 10^{10}\\,\\mathrm{Pa}$,\n  - $\\sigma_y = 10^{6}\\,\\mathrm{Pa}$,\n  - 初始条件 $v(x,0) = 0$, $\\sigma(x,0) = S_0 \\sin(2\\pi x/L)$，其中 $S_0 = 3 \\times 10^{6}\\,\\mathrm{Pa}$,\n  - CFL 数 $= 0.5$,\n  - 最终时间 $T = 2 \\times 10^{-4}\\,\\mathrm{s}$.\n- 测试 $3$ (纯弹性，接近 CFL 极限):\n  - $L = 1\\,\\mathrm{m}$,\n  - $N = 200$ 个单元,\n  - $\\rho = 2500\\,\\mathrm{kg/m^3}$,\n  - $E = 5 \\times 10^{10}\\,\\mathrm{Pa}$,\n  - $\\sigma_y = 10^{18}\\,\\mathrm{Pa}$,\n  - 初始条件 $v(x,0) = 0$, $\\sigma(x,0) = S_0 \\sin(2\\pi x/L)$，其中 $S_0 = 5 \\times 10^{6}\\,\\mathrm{Pa}$,\n  - CFL 数 $= 0.95$,\n  - 最终时间 $T = 1 \\times 10^{-4}\\,\\mathrm{s}$.\n\n算法要求：\n\n- 如上所述，对齐次部分使用 Rusanov 通量和三阶强稳定性保持 Runge-Kutta 积分器，\n- 在每个完整时间步结束时应用局部塑性投影，并使用上述路径积分表达式累积塑性耗散，\n- 在计算数值通量时，一致地使用周期性边界，\n- 计算并报告单位为 $\\mathrm{J}$ 的 $e_1$、$e_2$、$e_3$ 以及定义好的布尔值 $b_1$、$b_2$、$b_3$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，“[result1,result2,result3]”），不含空格，并严格按照 $[e_1,e_2,e_3,b_1,b_2,b_3]$ 的顺序排列结果。",
            "solution": "该问题是有效的。它提出了一个适定的物理系统，该系统基于连续介质力学的原理，具体来说是一维速率无关塑性的弹性动力学。控制方程、初始条件、边界条件和材料参数都得到了清晰且一致的规定。任务涉及推导和实现一种标准的、熵稳定的数值方法（一种有限体积格式，等价于分片常数间断 Galerkin 方法）来求解该系统，这在计算地球物理学和力学中是一项常见且有意义的练习。所有必要的信息都已提供，问题没有科学缺陷、歧义或矛盾。\n\n我们继续按要求推导数值格式并证明其能量稳定性。\n\n控制方程以带源项的一阶守恒律系统的形式给出：\n$$\n\\partial_t \\mathbf{q} + \\partial_x \\mathbf{f}(\\mathbf{q}) = \\mathbf{s}(\\mathbf{q})\n$$\n其中状态向量为 $\\mathbf{q} = [v, \\sigma]^T$，通量函数为 $\\mathbf{f}(\\mathbf{q}) = [-\\sigma/\\rho, -E v]^T$，模拟塑性效应的源项为 $\\mathbf{s}(\\mathbf{q}) = [0, -E \\dot{\\varepsilon}^p]^T$。\n\n为构建有限体积格式，我们在一个大小为 $\\Delta x$ 的计算单元 $K_i = [x_{i-1/2}, x_{i+1/2}]$ 上对系统进行积分。\n$$\n\\int_{K_i} \\partial_t \\mathbf{q} \\, dx + \\int_{K_i} \\partial_x \\mathbf{f}(\\mathbf{q}) \\, dx = \\int_{K_i} \\mathbf{s}(\\mathbf{q}) \\, dx\n$$\n对通量项使用微积分基本定理，并使用单元平均值 $\\mathbf{q}_i(t) \\approx \\frac{1}{\\Delta x} \\int_{K_i} \\mathbf{q}(x,t) \\, dx$ 来近似单元积分，我们得到：\n$$\n\\Delta x \\frac{d\\mathbf{q}_i}{dt} + \\left( \\mathbf{f}( \\mathbf{q}(x_{i+1/2},t) ) - \\mathbf{f}( \\mathbf{q}(x_{i-1/2},t) ) \\right) = \\Delta x \\, \\mathbf{s}(\\mathbf{q}_i)\n$$\n在单元界面 $x_{i \\pm 1/2}$ 处，状态 $\\mathbf{q}$ 是不连续的。我们用一个相容且稳定的数值通量函数 $\\mathbf{f}^*(\\mathbf{q}_L, \\mathbf{q}_R)$ 来代替精确通量 $\\mathbf{f}$，其中 $\\mathbf{q}_L = \\mathbf{q}_i$ 和 $\\mathbf{q}_R = \\mathbf{q}_{i+1}$ 分别是界面左侧和右侧的状态。这就得到了半离散格式：\n$$\n\\frac{d\\mathbf{q}_i}{dt} = - \\frac{1}{\\Delta x} \\left( \\mathbf{f}^*_{i+1/2} - \\mathbf{f}^*_{i-1/2} \\right) + \\mathbf{s}(\\mathbf{q}_i)\n$$\n其中 $\\mathbf{f}^*_{i+1/2} = \\mathbf{f}^*(\\mathbf{q}_i, \\mathbf{q}_{i+1})$ 且 $\\mathbf{f}^*_{i-1/2} = \\mathbf{f}^*(\\mathbf{q}_{i-1}, \\mathbf{q}_i)$。问题指定了局部 Lax-Friedrichs (Rusanov) 通量：\n$$\n\\mathbf{f}^*(\\mathbf{q}_L, \\mathbf{q}_R) = \\frac{1}{2}\\left(\\mathbf{f}(\\mathbf{q}_L) + \\mathbf{f}(\\mathbf{q}_R)\\right) - \\frac{1}{2}\\, \\alpha \\, (\\mathbf{q}_R - \\mathbf{q}_L)\n$$\n其稳定化参数 $\\alpha$ 必须超过最大波速，即 $\\alpha \\ge c = \\sqrt{E/\\rho}$。\n\n接下来，我们证明该格式的熵稳定性。机械能密度为 $\\eta(\\mathbf{q}) = \\frac{1}{2} \\rho v^2 + \\frac{1}{2} \\sigma^2/E$。我们可以将其写成二次型 $\\eta(\\mathbf{q}) = \\frac{1}{2} \\mathbf{q}^T H \\mathbf{q}$，其中对称化子矩阵为 $H = \\mathrm{diag}(\\rho, 1/E)$。总离散能量为 $E_h(t) = \\sum_i \\Delta x \\, \\eta(\\mathbf{q}_i)$。\n\n通量雅可比矩阵为 $A = \\nabla_\\mathbf{q} \\mathbf{f} = \\begin{bmatrix} 0  -1/\\rho \\\\ -E  0 \\end{bmatrix}$。该系统是对称双曲的，因为矩阵乘积 $HA$ 是对称的：\n$$\nHA = \\begin{bmatrix} \\rho  0 \\\\ 0  1/E \\end{bmatrix} \\begin{bmatrix} 0  -1/\\rho \\\\ -E  0 \\end{bmatrix} = \\begin{bmatrix} 0  -1 \\\\ -1  0 \\end{bmatrix}\n$$\n总离散能量的变化率可以通过对 $E_h(t)$ 求时间导数得到：\n$$\n\\frac{dE_h}{dt} = \\sum_i \\Delta x \\frac{d\\eta_i}{dt} = \\sum_i \\Delta x (\\nabla_\\mathbf{q} \\eta_i)^T \\frac{d\\mathbf{q}_i}{dt}\n$$\n能量的梯度为 $\\nabla_\\mathbf{q} \\eta = H\\mathbf{q}$。代入此式和半离散格式：\n$$\n\\frac{dE_h}{dt} = \\sum_i \\Delta x (H\\mathbf{q}_i)^T \\left[ - \\frac{1}{\\Delta x} \\left( \\mathbf{f}^*_{i+1/2} - \\mathbf{f}^*_{i-1/2} \\right) + \\mathbf{s}(\\mathbf{q}_i) \\right]\n$$\n$$\n\\frac{dE_h}{dt} = \\sum_i -(H\\mathbf{q}_i)^T \\left( \\mathbf{f}^*_{i+1/2} - \\mathbf{f}^*_{i-1/2} \\right) + \\sum_i \\Delta x (H\\mathbf{q}_i)^T \\mathbf{s}(\\mathbf{q}_i)\n$$\n源项的贡献是塑性耗散率：\n$$\n\\sum_i \\Delta x (H\\mathbf{q}_i)^T \\mathbf{s}(\\mathbf{q}_i) = \\sum_i \\Delta x [\\rho v_i, \\sigma_i/E]^T [0, -E \\dot{\\varepsilon}^p_i]^T = - \\sum_i \\Delta x \\, \\sigma_i \\dot{\\varepsilon}^p_i \\le 0\n$$\n通量项可以使用分部求和法进行重排。对于周期性边界，这得到：\n$$\n\\sum_i -(H\\mathbf{q}_i)^T \\left( \\mathbf{f}^*_{i+1/2} - \\mathbf{f}^*_{i-1/2} \\right) = \\sum_{i+1/2} (H\\mathbf{q}_{i+1} - H\\mathbf{q}_i)^T \\mathbf{f}^*_{i+1/2} = \\sum_{i+1/2} (\\mathbf{q}_{i+1} - \\mathbf{q}_i)^T H \\mathbf{f}^*_{i+1/2}\n$$\n这里我们利用了 $H$ 是对称的。令 $[ \\mathbf{q} ] = \\mathbf{q}_{i+1} - \\mathbf{q}_i$。求和项为 $\\sum_{i+1/2} [ \\mathbf{q} ]^T H \\mathbf{f}^*$。代入 Rusanov 通量：\n$$\n[ \\mathbf{q} ]^T H \\mathbf{f}^* = [ \\mathbf{q} ]^T H \\left[ \\frac{1}{2}(\\mathbf{f}_i + \\mathbf{f}_{i+1}) - \\frac{1}{2}\\alpha [ \\mathbf{q} ] \\right] = \\frac{1}{2} [ \\mathbf{q} ]^T H (\\mathbf{f}_i + \\mathbf{f}_{i+1}) - \\frac{1}{2}\\alpha [ \\mathbf{q} ]^T H [ \\mathbf{q} ]\n$$\n由于 $\\mathbf{f}(\\mathbf{q}) = A\\mathbf{q}$ 且 $HA$ 是对称的，我们有 $\\mathbf{q}_i^T H \\mathbf{f}_{i+1} = \\mathbf{q}_i^T H A \\mathbf{q}_{i+1} = (A \\mathbf{q}_i)^T H \\mathbf{q}_{i+1} = \\mathbf{f}_i^T H \\mathbf{q}_{i+1}$。更直接地，$\\mathbf{q}_{i+1}^T H A \\mathbf{q}_i = \\mathbf{q}_i^T (HA)^T \\mathbf{q}_{i+1} = \\mathbf{q}_i^T H A \\mathbf{q}_{i+1}$。第一项展开为 $\\frac{1}{2}(\\mathbf{q}_{i+1}^T H\\mathbf{f}_{i+1} - \\mathbf{q}_i^T H\\mathbf{f}_i)$。对所有界面求和得到一个伸缩级数，由于周期性边界，其和为零。第二项是数值耗散，$-\\frac{1}{2}\\alpha \\|[ \\mathbf{q} ]\\|_H^2$，其中 $\\|\\mathbf{w}\\|_H^2 = \\mathbf{w}^T H \\mathbf{w}$。\n整合所有项，得到半离散能量平衡：\n$$\n\\frac{dE_h}{dt} = - \\sum_{i+1/2} \\frac{1}{2}\\alpha \\|[ \\mathbf{q} ]\\|_H^2 - \\sum_i \\Delta x \\, \\sigma_i \\dot{\\varepsilon}^p_i\n$$\n重新整理并注意到塑性耗散率是非负的，我们得到所期望的不等式：\n$$\n\\frac{dE_h}{dt} + \\sum_{i+1/2} \\frac{1}{2}\\alpha \\|[ \\mathbf{q} ]\\|_H^2 = - \\sum_i \\Delta x \\, \\sigma_i \\dot{\\varepsilon}^p_i \\le 0\n$$\n这证明了该格式是熵稳定的：离散总能量 $E_h$ 只会减少，减少的原因是界面上的数值耗散和塑性产生的物理耗散。\n\n时间积分采用算子分裂法执行。双曲部分使用三阶强稳定性保持 Runge-Kutta (SSP-RK3) 方法进行推进，以获得试探状态 $\\mathbf{q}^{\\mathrm{tr}}$。然后，应用塑性修正步。对于每个试探应力 $|\\sigma_i^{\\mathrm{tr}}|$ 超过屈服应力 $\\sigma_y$ 的单元，应力被投影回屈服面：$\\sigma_i^{\\mathrm{ad}} = \\sigma_y \\, \\mathrm{sign}(\\sigma_i^{\\mathrm{tr}})$。该投影所移除的能量 $\\frac{1}{2E}((\\sigma_i^{\\mathrm{tr}})^2 - \\sigma_y^2)$，恰好等于单位体积的塑性耗散增量，该增量被累加以追踪总耗散 $D_{\\mathrm{tot}}$。",
            "answer": "```python\nimport numpy as np\n\ndef run_simulation(L, N, rho, E, sigma_y, initial_sigma_func, cfl, T, area=1.0):\n    \"\"\"\n    Runs a single simulation for the 1D elastodynamics problem.\n\n    Args:\n        L (float): Length of the domain in meters.\n        N (int): Number of cells.\n        rho (float): Density in kg/m^3.\n        E (float): Elastic modulus in Pa.\n        sigma_y (float): Yield stress in Pa.\n        initial_sigma_func (callable): Function to set initial stress.\n        cfl (float): CFL number for time step calculation.\n        T (float): Final time in seconds.\n        area (float): Cross-sectional area in m^2.\n\n    Returns:\n        tuple: (initial_energy, final_energy, total_plastic_dissipation).\n    \"\"\"\n    # Grid setup\n    dx = L / N\n    x = np.linspace(dx / 2.0, L - dx / 2.0, N)\n\n    # Physical and numerical parameters\n    c_wave = np.sqrt(E / rho)  # Wave speed\n    alpha = c_wave  # Rusanov flux parameter\n    \n    # Time step determined by CFL condition\n    dt = cfl * dx / alpha\n    num_steps = int(np.ceil(T / dt))\n    dt = T / num_steps # Adjust dt to hit T exactly\n\n    # State vector q = [v, sigma], shape (2, N)\n    q = np.zeros((2, N))\n    # q[0, :] is velocity v(x), initially zero\n    q[1, :] = initial_sigma_func(x, L)  # q[1, :] is stress sigma(x)\n\n    def calculate_energy(q_state):\n        v, sigma = q_state[0, :], q_state[1, :]\n        eta_density = 0.5 * rho * v**2 + 0.5 * sigma**2 / E\n        return np.sum(eta_density) * dx * area\n\n    def flux_function(q_state):\n        v, sigma = q_state[0, :], q_state[1, :]\n        f = np.zeros_like(q_state)\n        f[0, :] = -sigma / rho\n        f[1, :] = -E * v\n        return f\n\n    def rhs_hyperbolic(q_state):\n        \"\"\"Computes the spatial part of the semi-discrete scheme (hyperbolic part).\"\"\"\n        # Periodic boundary conditions are handled using np.roll\n        q_L = q_state\n        q_R = np.roll(q_state, -1, axis=1)\n        \n        f_L = flux_function(q_L)\n        f_R = flux_function(q_R)\n        \n        # Rusanov (Lax-Friedrichs) flux at interfaces i+1/2\n        f_star = 0.5 * (f_L + f_R) - 0.5 * alpha * (q_R - q_L)\n        \n        # Flux at interfaces i-1/2 by rolling\n        f_star_left = np.roll(f_star, 1, axis=1)\n        \n        # RHS = - (f*_{i+1/2} - f*_{i-1/2}) / dx\n        return -(f_star - f_star_left) / dx\n\n    e_initial = calculate_energy(q)\n    d_total = 0.0\n    \n    for _ in range(num_steps):\n        # Time integration for the hyperbolic part using SSP-RK3\n        q_n = q.copy()\n        \n        # Stage 1\n        k1 = rhs_hyperbolic(q_n)\n        q1 = q_n + dt * k1\n        \n        # Stage 2\n        k2 = rhs_hyperbolic(q1)\n        q2 = 0.75 * q_n + 0.25 * (q1 + dt * k2)\n        \n        # Stage 3\n        k3 = rhs_hyperbolic(q2)\n        q_trial = (1.0/3.0) * q_n + (2.0/3.0) * (q2 + dt * k3)\n        \n        # Plastic projection step (return mapping)\n        v_trial, sigma_trial = q_trial[0, :], q_trial[1, :]\n        \n        # Identify cells where the trial stress exceeds the yield stress\n        yield_mask = np.abs(sigma_trial) > sigma_y\n        \n        sigma_new = sigma_trial.copy()\n        \n        if np.any(yield_mask):\n            # Calculate dissipation increment per unit volume for yielding cells\n            diss_inc_density = (sigma_trial[yield_mask]**2 - sigma_y**2) / (2.0 * E)\n            \n            # Update total dissipation (integral over volume)\n            d_total += np.sum(diss_inc_density) * dx * area\n            \n            # Project stress back to the yield surface\n            sigma_new[yield_mask] = sigma_y * np.sign(sigma_trial[yield_mask])\n\n        q = np.array([v_trial, sigma_new])\n        \n    e_final = calculate_energy(q)\n    return e_initial, e_final, d_total\n\n\ndef solve():\n    \"\"\"Main function to run test cases and print results.\"\"\"\n    # Define the three test cases from the problem statement.\n    test_cases = {\n        \"case1\": {\n            \"L\": 1.0, \"N\": 200, \"rho\": 2500.0, \"E\": 1e10, \"sigma_y\": 1e18,\n            \"initial_sigma_func\": lambda x, L: 5e6 * np.sin(2 * np.pi * x / L),\n            \"cfl\": 0.5, \"T\": 2e-4\n        },\n        \"case2\": {\n            \"L\": 1.0, \"N\": 200, \"rho\": 2500.0, \"E\": 1e10, \"sigma_y\": 1e6,\n            \"initial_sigma_func\": lambda x, L: 3e6 * np.sin(2 * np.pi * x / L),\n            \"cfl\": 0.5, \"T\": 2e-4\n        },\n        \"case3\": {\n            \"L\": 1.0, \"N\": 200, \"rho\": 2500.0, \"E\": 5e10, \"sigma_y\": 1e18,\n            \"initial_sigma_func\": lambda x, L: 5e6 * np.sin(2 * np.pi * x / L),\n            \"cfl\": 0.95, \"T\": 1e-4\n        }\n    }\n\n    # Run simulations and calculate metrics\n    \n    # Test 1\n    e0_1, ef_1, _ = run_simulation(**test_cases[\"case1\"])\n    e1 = ef_1 - e0_1\n    tau1 = 1e-8 * e0_1\n    b1 = e1 = tau1\n\n    # Test 2\n    e0_2, ef_2, d_tot_2 = run_simulation(**test_cases[\"case2\"])\n    e2 = ef_2 - (e0_2 - d_tot_2)\n    tau2 = 1e-8 * max(e0_2, d_tot_2, 1.0)\n    b2 = (ef_2 = e0_2 + tau2) and (e2 = tau2)\n\n    # Test 3\n    e0_3, ef_3, _ = run_simulation(**test_cases[\"case3\"])\n    e3 = ef_3 - e0_3\n    tau3 = 1e-8 * e0_3\n    b3 = e3 = tau3\n\n    # Aggregate results into the specified order\n    final_results = [e1, e2, e3, b1, b2, b3]\n\n    # Print results in the exact required format\n    print(f\"[{','.join(map(str, final_results))}]\")\n\nsolve()\n```"
        }
    ]
}