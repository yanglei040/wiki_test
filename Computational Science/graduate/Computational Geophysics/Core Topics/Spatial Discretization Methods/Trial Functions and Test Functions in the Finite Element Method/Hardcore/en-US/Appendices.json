{
    "hands_on_practices": [
        {
            "introduction": "To ground our understanding of the finite element method, we begin with a foundational exercise that connects its abstract machinery to the more intuitive world of finite differences. By applying the Galerkin FEM with the simplest continuous basis functions—linear \"hat\" functions—to a steady 1D diffusion problem, you will see how the assembly process naturally recovers the well-known three-point stencil for the second derivative . This practice is invaluable for demystifying the concept of weak forms and basis functions, revealing the underlying unity between different numerical discretization techniques.",
            "id": "3337463",
            "problem": "Consider the one-dimensional steady diffusion model derived from conservation of diffusive flux on a bounded interval with homogeneous Dirichlet boundary conditions: find a function $u$ such that $- \\dfrac{d}{dx} \\left( \\nu \\dfrac{du}{dx} \\right) = s(x)$ on $(0,L)$ with $u(0) = 0$ and $u(L) = 0$, where $\\nu > 0$ is a constant diffusivity and $s(x)$ is a prescribed source. Let the interval be partitioned into $N$ uniform subintervals with nodes $\\{x_i\\}_{i=0}^{N}$, mesh spacing $h = L/N$, and standard linear hat basis functions $\\{\\phi_i\\}$ associated with nodes $\\{x_i\\}$. Using the Galerkin Finite Element Method (FEM), with trial and test spaces spanned by the hat functions satisfying the essential boundary conditions, proceed as follows.\n\nStarting from the weak form obtained by multiplying the strong form by a test function and integrating by parts, compute the element-level bilinear form contributions on a single element $e = [x_{i-1}, x_i]$ in terms of $\\nu$ and $h$ by integrating products of derivatives of the hat functions restricted to $e$. Assemble these element contributions to obtain the discrete equation associated with an interior node $i$ in terms of the unknown nodal values $u_{i-1}$, $u_i$, and $u_{i+1}$ and the load functional evaluated at the test function $\\phi_i$.\n\nThen, specialize to a constant source $s(x) = s_0$ with $s_0$ constant, and compute the scalar $m_i = \\int_{0}^{L} \\phi_i(x)\\,dx$. Divide the assembled FEM equation by $m_i$ to obtain a pointwise form at node $i$ that can be directly compared to the second-order central Finite Difference (FD) discretization for the same strong form. In this way, identify the three-point stencil coefficients on the left-hand side at node $i$ in the order $(i-1,i,i+1)$ expressed as a closed-form function of $\\nu$ and $h$ only.\n\nReport your final answer as a single row vector containing these three coefficients in the order $(i-1,i,i+1)$. Do not include any units. Do not provide intermediate results. The final answer must be a closed-form analytic expression.",
            "solution": "We begin from the strong form $- \\dfrac{d}{dx} \\left( \\nu \\dfrac{du}{dx} \\right) = s(x)$ with $u(0)=0$ and $u(L)=0$. The standard weak form is derived by multiplying by a test function $v \\in H_0^1(0,L)$ and integrating by parts, using the homogeneous essential boundary conditions to eliminate boundary terms:\n$$\n\\int_{0}^{L} \\nu \\dfrac{du}{dx} \\dfrac{dv}{dx}\\,dx = \\int_{0}^{L} s(x)\\, v(x)\\,dx.\n$$\nIn the Galerkin Finite Element Method (FEM) with linear hat functions $\\{\\phi_i\\}$ that vanish at $x=0$ and $x=L$, we seek an approximation $u_h = \\sum_{j=1}^{N-1} u_j \\phi_j$ and choose test functions $v = \\phi_i$. The discrete equation for an interior node $i$ is\n$$\n\\sum_{j} \\left( \\int_{0}^{L} \\nu \\dfrac{d\\phi_j}{dx} \\dfrac{d\\phi_i}{dx}\\,dx \\right) u_j \\;=\\; \\int_{0}^{L} s(x)\\, \\phi_i(x)\\,dx.\n$$\nBecause the mesh is uniform with spacing $h$ and the basis functions are compactly supported, the only nonzero contributions to the row corresponding to node $i$ arise from elements $[x_{i-1},x_i]$ and $[x_i,x_{i+1}]$.\n\nOn a single element $e=[x_{i-1},x_i]$, the local basis restrictions are $\\phi_{i-1}$ and $\\phi_i$. Their derivatives on $e$ are constants: $\\dfrac{d\\phi_{i-1}}{dx} = -\\dfrac{1}{h}$ and $\\dfrac{d\\phi_i}{dx} = \\dfrac{1}{h}$. The element-level bilinear form matrix entries $a_{e,rs} = \\int_{e} \\nu \\dfrac{d\\phi_r}{dx}\\dfrac{d\\phi_s}{dx}\\,dx$ for $r,s \\in \\{i-1,i\\}$ are\n$$\na_{e,11} = \\int_{x_{i-1}}^{x_i} \\nu \\left(-\\dfrac{1}{h}\\right)\\left(-\\dfrac{1}{h}\\right) dx = \\nu \\dfrac{1}{h^2} h = \\dfrac{\\nu}{h}, \n$$\n$$\na_{e,12} = \\int_{x_{i-1}}^{x_i} \\nu \\left(-\\dfrac{1}{h}\\right)\\left(\\dfrac{1}{h}\\right) dx = - \\nu \\dfrac{1}{h^2} h = -\\dfrac{\\nu}{h},\n$$\n$$\na_{e,21} = \\int_{x_{i-1}}^{x_i} \\nu \\left(\\dfrac{1}{h}\\right)\\left(-\\dfrac{1}{h}\\right) dx = - \\dfrac{\\nu}{h}, \\quad\na_{e,22} = \\int_{x_{i-1}}^{x_i} \\nu \\left(\\dfrac{1}{h}\\right)\\left(\\dfrac{1}{h}\\right) dx = \\dfrac{\\nu}{h}.\n$$\nThus the element matrix on $[x_{i-1},x_i]$ is $\\dfrac{\\nu}{h} \\begin{pmatrix} 1 & -1 \\\\ -1 & 1 \\end{pmatrix}$. An identical calculation on the element $[x_i,x_{i+1}]$, with local basis $\\{\\phi_i,\\phi_{i+1}\\}$ and derivatives $\\dfrac{d\\phi_i}{dx} = -\\dfrac{1}{h}$ and $\\dfrac{d\\phi_{i+1}}{dx} = \\dfrac{1}{h}$ on that element, yields the same $2\\times 2$ pattern.\n\nAssembling contributions to the global row for node $i$ from its two adjacent elements produces the stiffness coefficients\n$$\nK_{i,i-1} = -\\dfrac{\\nu}{h}, \\qquad K_{i,i} = \\dfrac{\\nu}{h} + \\dfrac{\\nu}{h} = \\dfrac{2\\nu}{h}, \\qquad K_{i,i+1} = -\\dfrac{\\nu}{h}.\n$$\nTherefore, the FEM discrete equation at the interior node $i$ is\n$$\n-\\dfrac{\\nu}{h} u_{i-1} + \\dfrac{2\\nu}{h} u_i - \\dfrac{\\nu}{h} u_{i+1} \\;=\\; f_i,\n$$\nwhere the load entry is $f_i = \\int_{0}^{L} s(x)\\, \\phi_i(x)\\,dx$. For a constant source $s(x) = s_0$, this becomes $f_i = s_0 \\int_{0}^{L} \\phi_i(x)\\,dx$.\n\nWe now compute the scalar $m_i = \\int_{0}^{L} \\phi_i(x)\\,dx$. On a uniform mesh with linear hat functions, $\\phi_i$ is a triangle supported on $[x_{i-1},x_{i+1}]$ with height $1$ and base length $2h$. Its area is the sum of two right triangles of base $h$ and height $1$, so\n$$\nm_i = \\int_{x_{i-1}}^{x_{i}} \\phi_i(x)\\,dx + \\int_{x_{i}}^{x_{i+1}} \\phi_i(x)\\,dx = \\dfrac{1\\cdot h}{2} + \\dfrac{1\\cdot h}{2} = h.\n$$\nThen $f_i = s_0\\, m_i = s_0\\, h$. Dividing the entire FEM equation by $m_i = h$ yields a pointwise balance at node $i$:\n$$\n-\\dfrac{\\nu}{h^2} u_{i-1} + \\dfrac{2\\nu}{h^2} u_i - \\dfrac{\\nu}{h^2} u_{i+1} \\;=\\; s_0.\n$$\nThis left-hand side is exactly the three-point second-order central Finite Difference (FD) stencil for $-\\nu \\dfrac{d^2 u}{dx^2}$, namely $\\nu \\dfrac{-u_{i-1} + 2u_i - u_{i+1}}{h^2}$. Therefore, the three-point stencil coefficients in the order $(i-1,i,i+1)$ are\n$$\n\\left( -\\dfrac{\\nu}{h^2}, \\; \\dfrac{2\\nu}{h^2}, \\; -\\dfrac{\\nu}{h^2} \\right).\n$$\nThese depend only on $\\nu$ and $h$, as required.",
            "answer": "$$\\boxed{\\begin{pmatrix}-\\dfrac{\\nu}{h^{2}} & \\dfrac{2\\nu}{h^{2}} & -\\dfrac{\\nu}{h^{2}}\\end{pmatrix}}$$"
        },
        {
            "introduction": "Moving from static problems to dynamics, the choice of trial and test spaces gains a new dimension of importance related to stability and energy conservation. This practice explores the 1D elastic wave equation, a cornerstone of computational seismology, to demonstrate how tailoring the inner product of the test space—a Petrov-Galerkin concept—directly impacts the analysis of time-dependent phenomena . You will connect the mathematical definition of energy norms to critical physical quantities like the maximum stable time step for explicit integration and the frequency-dependent quality factor $Q$, providing a concrete link between abstract function spaces and the practical challenge of simulating wave propagation accurately over long durations.",
            "id": "3617857",
            "problem": "Consider one-dimensional linear elasticity for a uniform rod of length $L$ with cross-sectional area $A$, mass density $\\rho$, and Young's modulus $E$. Let $u(x,t)$ denote the displacement field, with fixed Dirichlet boundary conditions $u(0,t)=0$ and $u(L,t)=0$. The fundamental balance of linear momentum and the constitutive law give the strong form\n$$\n\\rho A \\frac{\\partial^2 u}{\\partial t^2}(x,t) - \\frac{\\partial}{\\partial x}\\left(E A \\frac{\\partial u}{\\partial x}(x,t)\\right) = f(x,t),\n$$\nwith the stored elastic energy density defined by $E A\\,\\varepsilon(u)^2$ where $\\varepsilon(u)=\\partial_x u$, and kinetic energy density $\\rho A\\,(\\partial_t u)^2$. In the time-harmonic (frequency-domain) formulation at angular frequency $\\omega$, one seeks $u(x)$ satisfying\n$$\n-\\omega^2 \\rho A\\,u(x) - \\frac{\\partial}{\\partial x}\\left(E A \\frac{\\partial u}{\\partial x}(x)\\right) = g(x),\n$$\nwith complex-valued storage and attenuation modeled by an effective modulus if desired. In the time-domain formulation, stability over long times is controlled by the energy norm induced by the kinetic and potential energies.\n\nIn a finite element approximation on a uniform mesh with $N$ linear elements over $[0,L]$, let $V_h$ denote the trial function space (continuous, piecewise linear functions vanishing at $x=0$ and $x=L$) and let $W_h$ denote the test function space. Define the following symmetric positive-definite inner products for testing:\n- The time-harmonic energy inner product at angular frequency $\\omega$,\n$$\n\\langle w_h,z_h\\rangle_{\\omega} := \\int_0^L E A\\,\\frac{\\mathrm{d} w_h}{\\mathrm{d} x}\\,\\frac{\\mathrm{d} z_h}{\\mathrm{d} x}\\,\\mathrm{d}x \\;+\\; \\omega^2 \\int_0^L \\rho A\\, w_h z_h\\,\\mathrm{d}x,\n$$\nwhich induces the norm $\\|u_h\\|_{\\omega}^2 := \\langle u_h,u_h\\rangle_{\\omega}$.\n- The time-domain graph-energy inner product with a characteristic angular frequency $\\omega_c$,\n$$\n\\langle w_h,z_h\\rangle_{\\mathrm{td}} := \\int_0^L E A\\,\\frac{\\mathrm{d} w_h}{\\mathrm{d} x}\\,\\frac{\\mathrm{d} z_h}{\\mathrm{d} x}\\,\\mathrm{d}x \\;+\\; \\omega_c^2 \\int_0^L \\rho A\\, w_h z_h\\,\\mathrm{d}x,\n$$\nwhich induces the norm $\\|u_h\\|_{\\mathrm{td}}^2 := \\langle u_h,u_h\\rangle_{\\mathrm{td}}$.\n\nIn matrix form, these inner products correspond to $K+\\omega^2 M$ and $K+\\omega_c^2 M$, where $M$ and $K$ are the standard consistent mass and stiffness matrices assembled from the linear finite element basis on the uniform mesh. For long-time stability in explicit time-integration of the semi-discrete system $M \\ddot{u}_h + K u_h = f_h$, a sufficient condition is bounded time step dictated by the largest undamped natural angular frequency, $\\Delta t \\le \\frac{2}{\\sqrt{\\lambda_{\\max}}}$, where $\\lambda_{\\max}$ is the largest generalized eigenvalue of the problem $K \\phi = \\lambda M \\phi$.\n\nAttenuation in geophysical media is commonly characterized by the frequency-dependent Quality factor (Q). Define Quality Factor (Q) by the relation $Q(\\omega)$, which in the small-damping, single-mode setting satisfies $Q(\\omega) \\approx \\frac{1}{2\\zeta(\\omega)}$, where $\\zeta(\\omega)$ is the modal damping ratio. A practical approximation for structural damping in the semi-discrete setting uses Rayleigh damping $C=\\alpha M+\\beta K$, yielding $\\zeta(\\omega) = \\frac{\\alpha}{2\\omega} + \\frac{\\beta \\omega}{2}$. The energy decays per cycle by a factor $\\exp\\!\\left(-\\frac{2\\pi}{Q(\\omega)}\\right)$ at frequency $\\omega$.\n\nYour task is to:\n1. Assemble the one-dimensional linear finite element matrices $M$ and $K$ for the described rod and mesh.\n2. Compute the largest undamped angular frequency $\\sqrt{\\lambda_{\\max}}$ from the generalized eigenproblem $K \\phi = \\lambda M \\phi$, and the corresponding maximum explicit central-difference stable time step $\\Delta t_{\\max} = \\frac{2}{\\sqrt{\\lambda_{\\max}}}$ in seconds.\n3. For a given forcing angular frequency $\\omega_f$ and characteristic time-domain frequency $\\omega_c$ chosen as the largest undamped angular frequency (i.e., $\\omega_c = \\sqrt{\\lambda_{\\max}}$), compute the ratio of test norms\n$$\nR := \\sup_{u_h \\neq 0} \\frac{\\|u_h\\|_{\\omega_f}}{\\|u_h\\|_{\\mathrm{td}}} \\;=\\; \\sqrt{\\lambda_{\\max}\\!\\left((K+\\omega_f^2 M,\\; K+\\omega_c^2 M)\\right)},\n$$\nwhere $\\lambda_{\\max}\\!\\left((A,B)\\right)$ denotes the largest generalized eigenvalue of the symmetric pair $(A,B)$.\n4. For a given $Q(\\omega)$ law, evaluate $Q(\\omega_f)$ and compute the energy decay factor per cycle $D := \\exp\\!\\left(-\\frac{2\\pi}{Q(\\omega_f)}\\right)$ (dimensionless).\n\nConnect the computed $R$ to stability: large $R$ indicates that the time-harmonic test norm at $\\omega_f$ under-penalizes higher-frequency content relative to the time-domain graph-energy norm scaled by $\\omega_c$, suggesting potential long-time growth unless damping (as quantified by $Q(\\omega)$) sufficiently attenuates those modes.\n\nPhysical units must be used as follows: $L$ in meters ($\\mathrm{m}$), $A$ in square meters ($\\mathrm{m}^2$), $\\rho$ in kilograms per cubic meter ($\\mathrm{kg/m^3}$), $E$ in Pascals ($\\mathrm{Pa}$), angular frequencies $\\omega$ in radians per second ($\\mathrm{rad/s}$), and $\\Delta t_{\\max}$ output in seconds ($\\mathrm{s}$). Angles are not used directly except through angular frequencies; no degrees are involved.\n\nUse the Quality Factor law\n$$\nQ(\\omega) = Q_0 \\left(\\frac{\\omega}{\\omega_\\star}\\right)^{p},\n$$\nwith given constants $Q_0$, $\\omega_\\star$, and $p$. For context on Rayleigh damping and its connection to $Q$, you may optionally compute $(\\alpha,\\beta)$ by matching $Q(\\omega)$ at two frequencies $\\omega_a=\\omega_f$ and $\\omega_b=2\\omega_f$ via\n$$\n\\frac{1}{Q(\\omega_a)} = \\frac{\\alpha}{\\omega_a} + \\beta \\,\\omega_a,\\qquad \\frac{1}{Q(\\omega_b)} = \\frac{\\alpha}{\\omega_b} + \\beta \\,\\omega_b,\n$$\nbut you are not required to output $(\\alpha,\\beta)$.\n\nTest Suite:\nProvide the following three parameter sets to probe distinct regimes. For each case, assemble $M$ and $K$, compute $\\Delta t_{\\max}$, $R$, and $D$.\n\n- Case $1$ (moderate frequency, nearly constant $Q$):\n  - $L = 1.0\\times 10^{3}\\ \\mathrm{m}$, $A = 1.0\\ \\mathrm{m}^2$, $\\rho = 2700\\ \\mathrm{kg/m^3}$, $E = 3.0\\times 10^{10}\\ \\mathrm{Pa}$,\n  - $N = 80$ elements,\n  - $\\omega_f = 2\\pi\\cdot 20\\ \\mathrm{rad/s}$,\n  - $Q_0 = 150$, $\\omega_\\star = 2\\pi\\cdot 10\\ \\mathrm{rad/s}$, $p=0$.\n- Case $2$ (higher frequency, decreasing $Q$ with frequency):\n  - $L = 2.0\\times 10^{3}\\ \\mathrm{m}$, $A = 1.0\\ \\mathrm{m}^2$, $\\rho = 2500\\ \\mathrm{kg/m^3}$, $E = 5.0\\times 10^{10}\\ \\mathrm{Pa}$,\n  - $N = 120$ elements,\n  - $\\omega_f = 2\\pi\\cdot 50\\ \\mathrm{rad/s}$,\n  - $Q_0 = 80$, $\\omega_\\star = 2\\pi\\cdot 10\\ \\mathrm{rad/s}$, $p=0.25$.\n- Case $3$ (low frequency, slightly increasing $Q$ at high frequency, represented by negative $p$):\n  - $L = 1.0\\times 10^{3}\\ \\mathrm{m}$, $A = 1.0\\ \\mathrm{m}^2$, $\\rho = 2600\\ \\mathrm{kg/m^3}$, $E = 3.5\\times 10^{10}\\ \\mathrm{Pa}$,\n  - $N = 60$ elements,\n  - $\\omega_f = 2\\pi\\cdot 1\\ \\mathrm{rad/s}$,\n  - $Q_0 = 200$, $\\omega_\\star = 2\\pi\\cdot 1\\ \\mathrm{rad/s}$, $p=-0.2$.\n\nFinal Output Format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each test case result must be a list of three floating-point numbers $[R,\\Delta t_{\\max},D]$ in that order, with $\\Delta t_{\\max}$ in seconds. For example, the output should look like\n$$\n[\\,[R_1,\\Delta t_{\\max,1},D_1],[R_2,\\Delta t_{\\max,2},D_2],[R_3,\\Delta t_{\\max,3},D_3]\\,].\n$$\n\nThe problem requires you to start from fundamental laws and core definitions, derive the relevant weak forms, connect the test norms for trial and test functions to energy principles, and implement the computations for the specified test suite. Ensure scientific realism of parameters and provide results in the exact format specified.",
            "solution": "We begin from the fundamental balance of linear momentum and Hooke's law for a one-dimensional rod. The strong form\n$$\n\\rho A\\,\\frac{\\partial^2 u}{\\partial t^2}(x,t) - \\frac{\\partial}{\\partial x}\\left(E A\\,\\frac{\\partial u}{\\partial x}(x,t)\\right) = f(x,t)\n$$\nunder Dirichlet boundary conditions $u(0,t)=0$ and $u(L,t)=0$ is well-posed for $f\\in L^2(0,L)$. The stored elastic energy and kinetic energy densities are $E A\\,\\varepsilon(u)^2$ and $\\rho A\\,(\\partial_t u)^2$, respectively, where $\\varepsilon(u)=\\partial_x u$.\n\nFor the finite element method, we choose the standard trial function space $V_h \\subset H^1_0(0,L)$ consisting of continuous, piecewise linear functions with nodal basis $\\{\\varphi_i\\}_{i=1}^{n}$ vanishing at $x=0$ and $x=L$, with $n=N-1$ internal degrees of freedom for $N$ elements. The test function space $W_h$ is taken to be $V_h$ (Galerkin) but equipped with inner products tuned to the physics (Petrov-Galerkin through the norm). The canonical bilinear forms are\n$$\nm(w,z) := \\int_0^L \\rho A\\, w z\\,\\mathrm{d}x,\\qquad a(w,z) := \\int_0^L E A\\,\\frac{\\mathrm{d} w}{\\mathrm{d} x}\\,\\frac{\\mathrm{d} z}{\\mathrm{d} x}\\,\\mathrm{d}x.\n$$\nThese assemble to the mass and stiffness matrices $M$ and $K$ via $M_{ij}=m(\\varphi_i,\\varphi_j)$ and $K_{ij}=a(\\varphi_i,\\varphi_j)$.\n\nTime-domain weak form: multiplying the strong form by $w_h\\in W_h$, integrating by parts, and enforcing essential boundary conditions yields\n$$\nm(w_h,\\ddot{u}_h) + a(w_h,u_h) = \\ell(w_h),\n$$\nwith $\\ell(w_h) := \\int_0^L w_h f\\,\\mathrm{d}x$. The natural energy norm for the pair $(u_h,\\dot{u}_h)$ is\n$$\n\\|(u_h,\\dot{u}_h)\\|_{\\mathrm{energy}}^2 := a(u_h,u_h) + m(\\dot{u}_h,\\dot{u}_h),\n$$\nwhich guarantees energy conservation in the undamped case and monotone decay in the presence of dissipation. When designing a test norm purely on $u_h$ for residual minimization (such as in a graph norm context), one introduces a characteristic angular frequency $\\omega_c$ reflecting the fastest undamped dynamics supported by the semi-discrete system. A consistent choice is $\\omega_c := \\sqrt{\\lambda_{\\max}}$, where $\\lambda_{\\max}$ is the largest generalized eigenvalue of $K \\phi = \\lambda M \\phi$; indeed, $\\sqrt{\\lambda_{\\max}}$ is the largest undamped angular frequency of the semi-discrete system. This leads to the time-domain graph-energy inner product\n$$\n\\langle w_h,z_h\\rangle_{\\mathrm{td}} := a(w_h,z_h) + \\omega_c^2\\, m(w_h,z_h),\n$$\nwhich penalizes high-frequency content proportionally to its physical energy footprint across all modes up to $\\omega_c$.\n\nTime-harmonic weak form: at fixed angular frequency $\\omega$, the displacement amplitude $u_h \\in V_h$ satisfies\n$$\n-\\omega^2 m(w_h,u_h) + a(w_h,u_h) = \\ell_\\omega(w_h),\n$$\nwith $\\ell_\\omega$ representing the time-harmonic forcing. In the absence of damping, a natural energy inner product controlling the residual is\n$$\n\\langle w_h,z_h\\rangle_{\\omega} := a(w_h,z_h) + \\omega^2\\, m(w_h,z_h),\n$$\nwhich favors resolution of features near the chosen $\\omega$.\n\nNorm comparison: for symmetric positive-definite matrices $A$ and $B$, the operator norm of the identity map between the Hilbert spaces $(\\mathbb{R}^n,\\langle\\cdot,\\cdot\\rangle_A)$ and $(\\mathbb{R}^n,\\langle\\cdot,\\cdot\\rangle_B)$ equals\n$$\n\\sup_{u\\neq 0} \\frac{\\|u\\|_A}{\\|u\\|_B} = \\sqrt{\\lambda_{\\max}(B^{-1}A)} = \\sqrt{\\lambda_{\\max}((A,B))},\n$$\nwhere $\\lambda_{\\max}((A,B))$ is the largest generalized eigenvalue solving $A v = \\lambda B v$. Applying this to $A=K+\\omega_f^2 M$ and $B=K+\\omega_c^2 M$, we obtain the ratio\n$$\nR := \\sup_{u_h \\neq 0} \\frac{\\|u_h\\|_{\\omega_f}}{\\|u_h\\|_{\\mathrm{td}}} = \\sqrt{\\lambda_{\\max}\\!\\left((K+\\omega_f^2 M,\\; K+\\omega_c^2 M)\\right)}.\n$$\nIf $\\omega_c\\ge \\omega_f$, $R\\le 1$ for modes whose energy concentrates in low frequencies; however, for high-frequency content relative to $\\omega_f$, $R$ grows and indicates that the time-harmonic test norm underweights the response of high-frequency residuals compared to the time-domain norm tuned to $\\omega_c$.\n\nLong-time stability in time domain: for the semi-discrete undamped system $M \\ddot{u}_h + K u_h = f_h$, explicit central difference time stepping is stable provided\n$$\n\\Delta t \\le \\frac{2}{\\sqrt{\\lambda_{\\max}}},\n$$\nwhich follows from the spectral radius of the amplification matrix and the Courant-Friedrichs-Lewy (CFL) condition (derived from the harmonic oscillator $x'' + \\omega^2 x=0$ stability bound). This bound is tight in the undamped case. In damped systems, the region of stability grows modestly, but adopting $\\Delta t_{\\max} = \\frac{2}{\\sqrt{\\lambda_{\\max}}}$ is a conservative, robust criterion.\n\nConnection to attenuation via Quality Factor: Quality Factor (Q), $Q(\\omega)$, encodes relative energy stored versus energy lost per cycle. Under the small damping assumption, a single-mode relation gives $Q(\\omega) \\approx \\frac{1}{2\\zeta(\\omega)}$, where the modal damping ratio for Rayleigh damping $C=\\alpha M + \\beta K$ is\n$$\n\\zeta(\\omega) = \\frac{\\alpha}{2\\omega} + \\frac{\\beta \\omega}{2}.\n$$\nGiven $Q(\\omega)$, the energy decays per cycle by a factor\n$$\nD = \\exp\\!\\left(-\\frac{2\\pi}{Q(\\omega)}\\right).\n$$\nThus, even if $R$ is large (indicating potential underweighting of high-frequency content by the time-harmonic norm), sufficiently small $D$ (strong attenuation) mitigates long-time growth. Conversely, large $Q$ (weak attenuation) necessitates stronger control by the test norm, suggesting that $\\omega_c$ should be chosen near $\\sqrt{\\lambda_{\\max}}$.\n\nAlgorithmic steps:\n1. Build the uniform mesh with $N$ elements on $[0,L]$, node spacing $h = \\frac{L}{N}$, and internal degrees of freedom $n=N-1$ after enforcing Dirichlet boundary conditions. Assemble $M$ and $K$ using the standard one-dimensional linear finite element formulas for each element:\n$$\nK^{(e)} = \\frac{E A}{h} \\begin{bmatrix} 1 & -1 \\\\ -1 & 1 \\end{bmatrix},\\qquad M^{(e)} = \\frac{\\rho A h}{6} \\begin{bmatrix} 2 & 1 \\\\ 1 & 2 \\end{bmatrix}.\n$$\nSum contributions to the global matrices and remove boundary rows and columns.\n2. Compute the generalized eigenvalues of $(K,M)$ and set $\\lambda_{\\max}$ to the largest eigenvalue, then compute $\\Delta t_{\\max} = \\frac{2}{\\sqrt{\\lambda_{\\max}}}$.\n3. Set $\\omega_c = \\sqrt{\\lambda_{\\max}}$. For the given $\\omega_f$, form the generalized eigenproblem $(K+\\omega_f^2 M) v = \\lambda (K+\\omega_c^2 M) v$ and compute its largest eigenvalue $\\lambda_{\\max}^{(\\mathrm{pair})}$. Set $R = \\sqrt{\\lambda_{\\max}^{(\\mathrm{pair})}}$.\n4. Evaluate $Q(\\omega_f) = Q_0 \\left(\\frac{\\omega_f}{\\omega_\\star}\\right)^p$. Compute $D = \\exp\\!\\left(-\\frac{2\\pi}{Q(\\omega_f)}\\right)$.\n5. Output $[R,\\Delta t_{\\max},D]$ for each test case in a single line aggregated list.\n\nScientific realism: The parameter sets use plausible geophysical values for rocks ($E$ in the order of $10^{10}$ to $10^{11}$ $\\mathrm{Pa}$, $\\rho$ around $2500$ to $2700$ $\\mathrm{kg/m^3}$), rod lengths in kilometers, and frequencies in the $1$ to $50$ $\\mathrm{Hz}$ range. The resulting wave speeds $c=\\sqrt{E/\\rho}$ are on the order of $10^{3}$ to $10^{4}$ $\\mathrm{m/s}$, consistent with elastic wave propagation in crustal materials.\n\nThe program implements these steps using symmetric generalized eigenvalue computations to avoid forming matrix inverses, ensuring numerical robustness. The final output provides a quantitative comparison of the time-harmonic and time-domain test norms via $R$, the explicit time-step stability bound $\\Delta t_{\\max}$ in seconds, and the energy decay per cycle $D$ informed by $Q(\\omega_f)$, thereby connecting norm design, stability, and attenuation in a unified computational framework.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import eigh\n\ndef assemble_1d_rod(L, A, rho, E, N):\n    \"\"\"\n    Assemble 1D linear FE mass and stiffness matrices for a uniform rod\n    with Dirichlet boundary conditions at both ends. Uses consistent mass.\n    Returns reduced (interior-DOF) M and K.\n    \"\"\"\n    h = L / N\n    # Element matrices\n    ke = (E * A / h) * np.array([[1.0, -1.0],\n                                 [-1.0, 1.0]])\n    me = (rho * A * h / 6.0) * np.array([[2.0, 1.0],\n                                         [1.0, 2.0]])\n    # Global assembly (full with N+1 nodes)\n    nnodes = N + 1\n    K_full = np.zeros((nnodes, nnodes))\n    M_full = np.zeros((nnodes, nnodes))\n    for e in range(N):\n        # Nodes for element e\n        n1 = e\n        n2 = e + 1\n        # Assemble\n        K_full[n1:n2+1, n1:n2+1] += ke\n        M_full[n1:n2+1, n1:n2+1] += me\n    # Apply Dirichlet BCs at nodes 0 and N: reduce to interior dofs [1..N-1]\n    interior = np.arange(1, nnodes - 1)\n    K = K_full[np.ix_(interior, interior)]\n    M = M_full[np.ix_(interior, interior)]\n    return M, K\n\ndef largest_undamped_freq(M, K):\n    \"\"\"\n    Compute largest undamped angular frequency sqrt(lambda_max)\n    from generalized eigenproblem K v = lambda M v.\n    \"\"\"\n    # eigh for symmetric generalized eigenproblem\n    # Return all eigenvalues; take largest positive\n    evals = eigh(K, M, eigvals_only=True)\n    lam_max = np.max(evals)\n    # Numerical safety\n    lam_max = float(np.real(lam_max))\n    omega_max = np.sqrt(lam_max)\n    return omega_max, lam_max\n\ndef norm_ratio(M, K, omega_f, omega_c):\n    \"\"\"\n    Compute R = sqrt(lambda_max) for generalized eigenproblem\n    (K + omega_f^2 M) v = lambda (K + omega_c^2 M) v.\n    \"\"\"\n    A = K + (omega_f**2) * M\n    B = K + (omega_c**2) * M\n    evals = eigh(A, B, eigvals_only=True)\n    lam_pair_max = np.max(evals)\n    lam_pair_max = float(np.real(lam_pair_max))\n    R = np.sqrt(lam_pair_max)\n    return R\n\ndef quality_factor(omega, Q0, omega_star, p):\n    \"\"\"\n    Frequency-dependent Q law: Q(omega) = Q0 * (omega/omega_star)^p\n    \"\"\"\n    return Q0 * (omega / omega_star) ** p\n\ndef energy_decay_per_cycle(Q):\n    \"\"\"\n    Energy decay factor per cycle: exp(-2*pi / Q)\n    \"\"\"\n    return float(np.exp(-2.0 * np.pi / Q))\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each case: (L [m], A [m^2], rho [kg/m^3], E [Pa], N, omega_f [rad/s], Q0, omega_star [rad/s], p)\n    test_cases = [\n        (1.0e3, 1.0, 2700.0, 3.0e10, 80, 2.0*np.pi*20.0, 150.0, 2.0*np.pi*10.0, 0.0),\n        (2.0e3, 1.0, 2500.0, 5.0e10, 120, 2.0*np.pi*50.0, 80.0, 2.0*np.pi*10.0, 0.25),\n        (1.0e3, 1.0, 2600.0, 3.5e10, 60, 2.0*np.pi*1.0, 200.0, 2.0*np.pi*1.0, -0.2),\n    ]\n\n    results = []\n    for case in test_cases:\n        L, A, rho, E, N, omega_f, Q0, omega_star, p = case\n\n        # Assemble FE matrices\n        M, K = assemble_1d_rod(L, A, rho, E, N)\n\n        # Largest undamped angular frequency and dt_max\n        omega_max, lam_max = largest_undamped_freq(M, K)\n        dt_max = 2.0 / omega_max  # seconds\n\n        # Time-domain characteristic frequency\n        omega_c = omega_max\n\n        # Norm ratio R between time-harmonic and time-domain test norms\n        R = norm_ratio(M, K, omega_f, omega_c)\n\n        # Quality factor at omega_f and energy decay per cycle\n        Qf = quality_factor(omega_f, Q0, omega_star, p)\n        D = energy_decay_per_cycle(Qf)\n\n        results.append([R, dt_max, D])\n\n    # Final print statement in the exact required format.\n    # Convert to string with default float formatting.\n    print(f\"[{','.join('[' + ','.join(map(str, r)) + ']' for r in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "The true power of the finite element framework is realized when we design trial and test spaces independently to overcome specific physical challenges, such as those posed by multiscale phenomena in geophysics. This advanced practice tackles the problem of fluid flow in a highly heterogeneous porous medium, where standard methods often fail to capture fine-scale effects accurately . Here, you will construct specialized trial functions using the Multiscale Finite Element Method (MsFEM) to embed the complex permeability information directly into the basis, while simultaneously generating optimal test functions via the Discontinuous Petrov-Galerkin (DPG) method to ensure stability and accurate flux representation, showcasing a state-of-the-art approach to computational modeling.",
            "id": "3617861",
            "problem": "Consider steady one-dimensional groundwater flow in a heterogeneous porous medium on the interval $\\Omega = (0,1)$ with hydraulic head $p(x)$ governed by conservation of mass and Darcy’s law: $- \\dfrac{\\mathrm{d}}{\\mathrm{d}x}\\left(k(x)\\,\\dfrac{\\mathrm{d}p}{\\mathrm{d}x}\\right) = 0$ on $\\Omega$, with Dirichlet boundary conditions $p(0)=0$ and $p(1)=1$. The permeability field is specified as $k(x) = \\exp\\!\\big(\\beta \\sin(2\\pi f x) + 0.5 \\cos(6\\pi x)\\big)$, where $\\beta > 0$ controls contrast and $f > 0$ controls fine-scale oscillation frequency. The exact constant flux for this source-free problem is $q_{\\mathrm{exact}} = -\\left(\\int_{0}^{1} \\dfrac{1}{k(x)}\\,\\mathrm{d}x\\right)^{-1}$ in units of head per unit length.\n\nYou will construct a multiscale finite element method (MsFEM) for the trial space and a Discontinuous Petrov–Galerkin (DPG) method for the test space, then assess the effect of oversampling in the test-space construction on the accuracy of interfacial fluxes. The trial functions approximate the solution with fine-scale information of $k(x)$ embedded locally, while the test functions are “optimal” in the DPG sense with respect to a specified test norm, computed on oversampled patches that span multiple coarse elements around each target element.\n\nUse the following principles and definitions to design a complete and executable algorithm.\n\n- Governing laws and weak form base:\n  - Darcy’s law in one dimension is $q(x) = -k(x)\\,\\dfrac{\\mathrm{d}p}{\\mathrm{d}x}$, and mass conservation with no sources is $\\dfrac{\\mathrm{d}q}{\\mathrm{d}x}=0$.\n  - The primal variational form for a trial function $u$ and a test function $v$ is based on the bilinear form $b(u,v) = \\int_{K} k(x)\\,\\dfrac{\\mathrm{d}u}{\\mathrm{d}x}\\,\\dfrac{\\mathrm{d}v}{\\mathrm{d}x}\\,\\mathrm{d}x$ on a subdomain $K\\subset\\Omega$.\n\n- Trial space (MsFEM):\n  - Partition $\\Omega$ into $N_c$ coarse elements of equal size. On each coarse element $K=[x_a,x_b]$, define two local trial basis functions by solving the homogeneous local operator $-\\dfrac{\\mathrm{d}}{\\mathrm{d}x}\\left(k(x)\\,\\dfrac{\\mathrm{d}\\phi}{\\mathrm{d}x}\\right)=0$ on $K$, subject to Dirichlet nodal constraints $\\phi_L(x_a)=1$, $\\phi_L(x_b)=0$ and $\\phi_R(x_a)=0$, $\\phi_R(x_b)=1$. Assemble these basis functions in the usual conforming manner to obtain a global trial space.\n  - For computational quadrature of the local harmonic coordinates, approximate integrals of $1/k(x)$ on each coarse element using a composite trapezoidal rule with $N_{\\mathrm{int,per\\,elem}}$ subintervals per coarse element.\n\n- Test space (DPG with optimal tests):\n  - On each coarse element $K$ and for each local trial basis function, define the optimal DPG test function as the Riesz representer on an oversampled patch of coarse elements. The oversampling radius $r\\in\\{0,1,2,\\dots\\}$ determines the patch to be the union of the target element $K$ and $r$ neighbors on each side, clipped to domain boundaries.\n  - Choose the test inner product $(v,w)_V = \\int_{\\mathrm{patch}} \\left(\\dfrac{\\mathrm{d}v}{\\mathrm{d}x}\\,\\dfrac{\\mathrm{d}w}{\\mathrm{d}x} + \\gamma\\,v\\,w\\right)\\mathrm{d}x$ with $\\gamma>0$. Discretize the test space on the patch by continuous, piecewise linear functions on a uniform subgrid with $n_t$ equal-length subintervals per coarse element.\n  - The optimal test function $v^*$ corresponding to a given trial basis $\\phi$ satisfies $(v^*, w)_V = b(\\phi,w)$ for all $w$ in the test space on the patch, which is implemented by solving a symmetric positive-definite linear system for the coefficients of $v^*$ in the chosen test basis.\n\n- Global bilinear form and assembly:\n  - For each coarse element $K$ and each local trial basis, compute the contribution to the global stiffness via the bilinear form $b(u,v)$, with the test function $v$ chosen as the optimal test $v^*$ associated with the trial basis, and restrict the test function to $K$ for the evaluation of $b$.\n  - Assemble the element contributions into a global symmetric matrix for the coarse nodal unknowns, enforce the Dirichlet boundary conditions $p(0)=0$ and $p(1)=1$, and solve the resulting linear system for the interior nodal values.\n\n- Flux evaluation:\n  - On each coarse element $K=[x_i,x_{i+1}]$, compute the numerical element flux $q_h$ consistent with the local MsFEM trial representation. For this one-dimensional, source-free case, the local numerical flux on $K$ is constant and can be written in terms of the nodal solution values and the harmonic integral on $K$.\n  - The exact flux $q_{\\mathrm{exact}}$ is constant across the domain and can be computed from $\\int_{0}^{1} 1/k(x)\\,\\mathrm{d}x$ using the same composite trapezoidal rule with $N_{\\mathrm{int,per\\,elem}}$ subintervals per coarse element (summed over coarse elements for consistency).\n\n- Error metric:\n  - For each interior coarse interface at $x_i$, define the interfacial numerical flux as the arithmetic mean of the constant numerical fluxes in the adjacent coarse elements. Let $q_i^{\\mathrm{avg}}$ denote this average. Compute the absolute relative error $e_i = \\left|q_i^{\\mathrm{avg}} - q_{\\mathrm{exact}}\\right|/\\left|q_{\\mathrm{exact}}\\right|$.\n  - For each parameter set, report the mean of $\\{e_i\\}$ over all interior interfaces as a single floating-point number.\n\nImplementation requirements:\n\n- Fix the test-space parameters to $\\gamma = 1$ and $n_t = 12$ subintervals per coarse element in the test mesh. Fix the quadrature resolution to $N_{\\mathrm{int,per\\,elem}} = 2000$ subintervals per coarse element for integrating $1/k(x)$.\n- For each test case, define $k(x)$ using the given $\\beta$ and $f$, construct the global multiscale-Petrov–Galerkin method as described, solve for the coarse nodal head values, compute interfacial flux errors, and output the mean interfacial absolute relative error.\n\nTest suite:\n\n- The program must evaluate the following six parameter sets, each given as a tuple $\\left(N_c, r, f, \\beta\\right)$:\n  1. $\\left(8, 0, 20, 1.0\\right)$\n  2. $\\left(8, 1, 20, 1.0\\right)$\n  3. $\\left(8, 2, 20, 1.0\\right)$\n  4. $\\left(8, 1, 40, 1.0\\right)$\n  5. $\\left(8, 1, 20, 2.5\\right)$\n  6. $\\left(4, 1, 20, 1.0\\right)$\n\nFinal output format:\n\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the same order as the test cases, where each entry is the mean interfacial absolute relative error for the corresponding test case. For example, the output must have the form $[\\text{result}_1,\\text{result}_2,\\dots,\\text{result}_6]$ with each $\\text{result}_i$ a floating-point number.",
            "solution": "The supplied problem is scientifically grounded, well-posed, and objective. It outlines a comprehensive numerical experiment to evaluate a multiscale finite element method. All procedures, parameters, and definitions are provided, forming a complete and internally consistent set of instructions. The problem is valid and a solution can be constructed.\n\nThe algorithm proceeds by first discretizing the domain $\\Omega = (0,1)$ into $N_c$ coarse elements. For each test case, we construct a global linear system $A\\mathbf{p} = \\mathbf{f}$ for the unknown hydraulic head values $\\mathbf{p}$ at the coarse nodes. The matrix $A$ and vector $\\mathbf{f}$ are assembled from element-level contributions, which are computed using a specialized multiscale Discontinuous Petrov-Galerkin (MsDPG) formulation. Once the nodal head values are found, we compute the numerical flux on each element, determine the flux at interior interfaces, and compare it to the exact flux to quantify the error.\n\n### 1. Preliminaries and Discretization\nThe domain $\\Omega = (0,1)$ is partitioned into $N_c$ coarse elements $K_i = [x_i, x_{i+1}]$ for $i=0, \\dots, N_c-1$. The coarse nodes are $x_i = iH$, where $H=1/N_c$ is the coarse mesh size. The hydraulic permeability $k(x)$ is given by $k(x) = \\exp\\!\\big(\\beta \\sin(2\\pi f x) + 0.5 \\cos(6\\pi x)\\big)$. The boundary conditions are $p(0)=0$ and $p(1)=1$.\n\n### 2. Trial Space (MsFEM Basis Functions)\nThe trial basis functions are constructed locally on each coarse element $K_i=[x_i, x_{i+1}]$ by solving the homogeneous problem $-\\frac{\\mathrm{d}}{\\mathrm{d}x}\\left(k(x)\\frac{\\mathrm{d}\\phi}{\\mathrm{d}x}\\right)=0$ with linear Dirichlet boundary conditions. The two local basis functions, $\\phi_L^{(i)}(x)$ and $\\phi_R^{(i)}(x)$, are defined by the conditions $\\phi_L^{(i)}(x_i)=1, \\phi_L^{(i)}(x_{i+1})=0$ and $\\phi_R^{(i)}(x_i)=0, \\phi_R^{(i)}(x_{i+1})=1$.\n\nThe general solution to the local problem is $\\phi(x) = C_1 \\int_{x_i}^x \\frac{1}{k(s)}\\mathrm{d}s + C_2$. Applying the boundary conditions yields:\n$$\n\\phi_L^{(i)}(x) = 1 - \\frac{\\int_{x_i}^x \\frac{1}{k(s)}\\mathrm{d}s}{\\int_{x_i}^{x_{i+1}} \\frac{1}{k(s)}\\mathrm{d}s}\n\\quad \\text{and} \\quad\n\\phi_R^{(i)}(x) = \\frac{\\int_{x_i}^x \\frac{1}{k(s)}\\mathrm{d}s}{\\int_{x_i}^{x_{i+1}} \\frac{1}{k(s)}\\mathrm{d}s}\n$$\nLet $I_{K_i} = \\int_{x_i}^{x_{i+1}} \\frac{1}{k(s)}\\mathrm{d}s$. The derivatives are:\n$$\n\\frac{\\mathrm{d}\\phi_L^{(i)}}{\\mathrm{d}x} = -\\frac{1}{k(x)I_{K_i}}\n\\quad \\text{and} \\quad\n\\frac{\\mathrm{d}\\phi_R^{(i)}}{\\mathrm{d}x} = \\frac{1}{k(x)I_{K_i}}\n$$\nThe integrals $I_{K_i}$ are computed numerically using a composite trapezoidal rule with $N_{\\mathrm{int,per\\,elem}}=2000$ subintervals on each coarse element $K_i$.\n\n### 3. Test Space (Optimal DPG Functions)\nFor each local trial basis function on an element $K_i$, an optimal test function is computed. This test function is defined on an oversampled patch of elements surrounding $K_i$. The patch for $K_i$ consists of $K_i$ and $r$ coarse elements on each side, clipped to the domain boundaries $[0,1]$.\n\nThe test space on this patch is discretized using continuous, piecewise linear (PWL) functions, denoted $\\psi_j(x)$, on a fine uniform subgrid with $n_t=12$ subintervals per coarse element. The optimal test function $v^*$ for a given trial basis $\\phi$ is found by solving for its coefficients in the PWL basis. It must satisfy $(v^*, w)_V = b(\\phi, w)$ for all PWL functions $w$ on the patch. The bilinear forms are:\n- Test inner product: $(v, w)_V = \\int_{\\mathrm{patch}} \\left(\\frac{\\mathrm{d}v}{\\mathrm{d}x}\\frac{\\mathrm{d}w}{\\mathrm{d}x} + \\gamma vw\\right)\\mathrm{d}x$ with $\\gamma=1$.\n- Primal bilinear form: $b(\\phi, w) = \\int_{K_i} k(x)\\frac{\\mathrm{d}\\phi}{\\mathrm{d}x}\\frac{\\mathrm{d}w}{\\mathrm{d}x}\\mathrm{d}x$.\n\nSubstituting $v^* = \\sum_j c_j \\psi_j$ and $w = \\psi_k$ leads to the linear system $M\\mathbf{c} = \\mathbf{F}$, where $M_{kj} = (\\psi_j, \\psi_k)_V$ and $F_k = b(\\phi, \\psi_k)$.\n\nA crucial simplification arises in the calculation of the right-hand side vector $\\mathbf{F}$. For a trial function $\\phi \\in \\{\\phi_L^{(i)}, \\phi_R^{(i)}\\}$, its derivative is proportional to $1/k(x)$. For example, for $\\phi_L^{(i)}$:\n$$\nF_k = b(\\phi_L^{(i)}, \\psi_k) = \\int_{K_i} k(x) \\left(-\\frac{1}{k(x)I_{K_i}}\\right) \\frac{\\mathrm{d}\\psi_k}{\\mathrm{d}x} \\mathrm{d}x = -\\frac{1}{I_{K_i}} \\int_{K_i} \\frac{\\mathrm{d}\\psi_k}{\\mathrm{d}x} \\mathrm{d}x\n$$\nBy the Fundamental Theorem of Calculus, $\\int_{K_i} \\frac{\\mathrm{d}\\psi_k}{\\mathrm{d}x} \\mathrm{d}x = \\psi_k(x_{i+1}) - \\psi_k(x_i)$. Since $\\psi_k$ is a PWL basis function (a \"hat\" function), it is equal to $1$ at its corresponding fine node and $0$ at all other fine nodes. The coarse nodes $x_i$ and $x_{i+1}$ are also nodes of the fine test grid. Thus, the vector $\\mathbf{F}$ is sparse, with only two non-zero entries corresponding to the test basis functions centered at the endpoints of $K_i$. This avoids the need for numerical quadrature for $\\mathbf{F}$. The matrix $M$ is a standard finite element stiffness+mass matrix for the PWL basis on the patch and is assembled using known analytical formulas.\n\n### 4. Global System Assembly and Solution\nFor each coarse element $K_i$, a $2 \\times 2$ local stiffness matrix $S^{(i)}$ is computed. Its entries are given by applying the bilinear form $b(\\cdot, \\cdot)$ to pairs of local trial and optimal test functions.\n$$\nS^{(i)} = \\begin{pmatrix} b(\\phi_L^{(i)}, v_L^*) & b(\\phi_R^{(i)}, v_L^*) \\\\ b(\\phi_L^{(i)}, v_R^*) & b(\\phi_R^{(i)}, v_R^*) \\end{pmatrix}\n$$\nwhere $v_L^*$ and $v_R^*$ are the optimal tests for $\\phi_L^{(i)}$ and $\\phi_R^{(i)}$, respectively. The expressions for these entries also simplify. For example:\n$$\nb(\\phi_L^{(i)}, v_L^*) = -\\frac{1}{I_{K_i}} \\int_{K_i} \\frac{\\mathrm{d}v_L^*}{\\mathrm{d}x} \\mathrm{d}x = -\\frac{1}{I_{K_i}} \\left(v_L^*(x_{i+1}) - v_L^*(x_i)\\right)\n$$\nThe values $v_L^*(x_{i+1})$ and $v_L^*(x_i)$ are simply specific coefficients from the vector $\\mathbf{c}$ solved for in the previous step. It can be shown that this construction yields a symmetric element matrix $S^{(i)}$, which in turn results in a symmetric global stiffness matrix $A$.\n\nThe global matrix $A$ is assembled by summing the contributions from all $S^{(i)}$. The Dirichlet boundary conditions $p(0)=0$ and $p(1)=1$ are enforced on the resulting system $A\\mathbf{p}=\\mathbf{f}$. The reduced system for the $N_c-1$ interior nodal values is solved to obtain the complete numerical solution $\\mathbf{p} = [p_0, p_1, \\dots, p_{N_c}]^T$.\n\n### 5. Flux and Error Calculation\nThe numerical flux $q_h^{(i)}$ on each element $K_i$ is constant due to the choice of MsFEM basis and a source-free problem. It is given by:\n$$\nq_h^{(i)} = -k(x)\\frac{\\mathrm{d}}{\\mathrm{d}x}\\left(p_i \\phi_L^{(i)}(x) + p_{i+1}\\phi_R^{(i)}(x)\\right) = -k(x)\\left(p_i \\frac{-1}{k(x)I_{K_i}} + p_{i+1}\\frac{1}{k(x)I_{K_i}}\\right) = -\\frac{p_{i+1}-p_i}{I_{K_i}}\n$$\nThe exact constant flux across the domain is $q_{\\mathrm{exact}} = - \\big(\\int_0^1 \\frac{1}{k(x)} \\mathrm{d}x\\big)^{-1}$. For consistency, the integral is computed as $\\sum_{i=0}^{N_c-1} I_{K_i}$.\n\nThe numerical flux at an interior coarse interface $x_i$ is taken as the arithmetic mean of the fluxes in the two adjacent elements: $q_i^{\\mathrm{avg}} = (q_h^{(i-1)} + q_h^{(i)})/2$. The absolute relative error at each interior interface is $e_i = |q_i^{\\mathrm{avg}} - q_{\\mathrm{exact}}|/|q_{\\mathrm{exact}}|$. The final reported value for each test case is the mean of these errors over all $N_c-1$ interior interfaces.",
            "answer": "```python\nimport numpy as np\nimport scipy.linalg\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the results.\n    \"\"\"\n    test_cases = [\n        (8, 0, 20.0, 1.0),\n        (8, 1, 20.0, 1.0),\n        (8, 2, 20.0, 1.0),\n        (8, 1, 40.0, 1.0),\n        (8, 1, 20.0, 2.5),\n        (4, 1, 20.0, 1.0),\n    ]\n\n    # Fixed parameters as specified in the problem\n    gamma = 1.0\n    nt = 12\n    N_int_per_elem = 2000\n\n    results = []\n    for case in test_cases:\n        Nc, r, f, beta = case\n        mean_error = run_case(Nc, r, f, beta, gamma, nt, N_int_per_elem)\n        results.append(mean_error)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef run_case(Nc, r, f, beta, gamma, nt, N_int_per_elem):\n    \"\"\"\n    Executes a single simulation for a given set of parameters.\n    \"\"\"\n    H = 1.0 / Nc\n    x_coarse = np.linspace(0, 1, Nc + 1)\n    k_fn = lambda x: np.exp(beta * np.sin(2 * np.pi * f * x) + 0.5 * np.cos(6 * np.pi * x))\n    \n    # Precompute harmonic integrals I_K for each coarse element\n    I_K = np.zeros(Nc)\n    inv_k_fn = lambda x: 1.0 / k_fn(x)\n    for i in range(Nc):\n        x_quad = np.linspace(x_coarse[i], x_coarse[i+1], N_int_per_elem + 1)\n        k_inv_vals = inv_k_fn(x_quad)\n        I_K[i] = np.trapz(k_inv_vals, x_quad)\n\n    # Assemble global stiffness matrix\n    A = np.zeros((Nc + 1, Nc + 1))\n    for i in range(Nc):\n        S_elem = compute_element_stiffness(i, Nc, r, f, beta, gamma, nt, I_K)\n        A[i:i+2, i:i+2] += S_elem\n    \n    # Solve linear system for interior nodes\n    A_int = A[1:Nc, 1:Nc]\n    b_int = np.zeros(Nc - 1)\n    \n    # Apply Dirichlet boundary conditions p(0)=0, p(1)=1\n    # p(0)=0 doesn't contribute to RHS\n    # p(Nc)=1 contributes -A[Nc-1, Nc] to the last equation\n    b_int[-1] = -A[Nc - 1, Nc]\n    \n    p_int = np.linalg.solve(A_int, b_int)\n    \n    p = np.zeros(Nc + 1)\n    p[0] = 0.0\n    p[1:Nc] = p_int\n    p[Nc] = 1.0\n\n    # Compute exact and numerical fluxes\n    q_exact = -1.0 / np.sum(I_K)\n    q_h = -(p[1:] - p[:-1]) / I_K\n    \n    # Compute interfacial flux errors\n    errors = []\n    for i in range(1, Nc):\n        q_avg = 0.5 * (q_h[i-1] + q_h[i])\n        error = np.abs(q_avg - q_exact) / np.abs(q_exact)\n        errors.append(error)\n        \n    return np.mean(errors)\n\ndef compute_element_stiffness(elem_idx, Nc, r, f, beta, gamma, nt, I_K):\n    \"\"\"\n    Computes the 2x2 element stiffness matrix for a coarse element.\n    \"\"\"\n    i = elem_idx\n    H = 1.0 / Nc\n\n    # Determine patch boundaries for the test space\n    patch_start_elem = max(0, i - r)\n    patch_end_elem = min(Nc - 1, i + r)\n    \n    x_patch_start = patch_start_elem * H\n    x_patch_end = (patch_end_elem + 1) * H\n\n    num_coarse_in_patch = patch_end_elem - patch_start_elem + 1\n    num_test_intervals = num_coarse_in_patch * nt\n    num_test_nodes = num_test_intervals + 1\n    ht = H / nt\n\n    # Assemble M matrix for test space inner product\n    M = np.zeros((num_test_nodes, num_test_nodes))\n    diag_val = 2.0 / ht + 2.0 * gamma * ht / 3.0\n    off_diag_val = -1.0 / ht + gamma * ht / 6.0\n    \n    for k in range(num_test_nodes):\n        if k == 0 or k == num_test_nodes - 1:\n            M[k, k] = 1.0 / ht + gamma * ht / 3.0\n        else:\n            M[k, k] = diag_val\n        if k > 0:\n            M[k, k-1] = off_diag_val\n        if k  num_test_nodes - 1:\n            M[k, k+1] = off_diag_val\n\n    # Create F vector for the phi_L basis function\n    F_L = np.zeros(num_test_nodes)\n    # The coarse element K_i corresponds to a specific range of fine nodes\n    # First node of K_i is at fine node index (i - patch_start_elem) * nt\n    start_fine_node_idx = (i - patch_start_elem) * nt\n    end_fine_node_idx = start_fine_node_idx + nt\n    \n    # F_k = -1/I_K[i] * (psi_k(x_{i+1}) - psi_k(x_i))\n    F_L[start_fine_node_idx] = 1.0 / I_K[i]\n    F_L[end_fine_node_idx] = -1.0 / I_K[i]\n    \n    # Solve for optimal test function coefficients for phi_L\n    v_L_coeffs = scipy.linalg.solve(M, F_L, assume_a='sym')\n    \n    # Since F_R = -F_L, v_R_coeffs = -v_L_coeffs\n    # We only need endpoint coefficients to compute the stiffness entries\n    v_L_start_val = v_L_coeffs[start_fine_node_idx]\n    v_L_end_val = v_L_coeffs[end_fine_node_idx]\n    \n    # Compute element stiffness matrix entries\n    # S_ij = b(phi_j, v_i*)\n    # b(phi_L, v_L*) = (-1/I_K[i]) * (v_L*(x_{i+1}) - v_L*(x_i))\n    S11 = (-1.0 / I_K[i]) * (v_L_end_val - v_L_start_val)\n    # b(phi_R, v_L*) = (1/I_K[i]) * (v_L*(x_{i+1}) - v_L*(x_i))\n    S12 = (1.0 / I_K[i]) * (v_L_end_val - v_L_start_val)\n    \n    # Matrix is symmetric with S22=S11 and S12=S21. Also S11=-S12.\n    # So S has the form c * [[1, -1], [-1, 1]] where c = -S12\n    c = -S12\n    S = c * np.array([[1.0, -1.0], [-1.0, 1.0]])\n\n    return S\n\nif __name__ == \"__main__\":\n    solve()\n\n```"
        }
    ]
}