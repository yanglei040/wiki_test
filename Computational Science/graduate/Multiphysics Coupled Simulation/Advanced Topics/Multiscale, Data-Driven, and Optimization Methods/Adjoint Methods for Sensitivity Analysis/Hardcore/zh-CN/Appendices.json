{
    "hands_on_practices": [
        {
            "introduction": "为深入理解伴随方法，我们首先从基本原理出发，推导其核心方程。本练习  将引导您使用拉格朗日乘子法完成这一过程，揭示如何构造伴随方程以便高效计算通用线性系统的灵敏度。这项基础实践是揭开伴随法“神秘面纱”的关键。",
            "id": "2594547",
            "problem": "考虑一个线性的、参数化的有限元方法 (FEM) 模型，其离散状态向量 $u(p) \\in \\mathbb{R}^{n}$ 由以下平衡方程控制\n$$\nK(p)\\,u(p) \\;=\\; f(p),\n$$\n其中 $K(p) \\in \\mathbb{R}^{n \\times n}$ 是一个与参数相关的刚度矩阵，在感兴趣的参数值范围内非奇异，而 $f(p) \\in \\mathbb{R}^{n}$ 是与参数相关的载荷向量。设输出泛函为\n$$\nJ(u,p) \\;=\\; \\tfrac{1}{2}\\,u^{T}\\,Q(p)\\,u,\n$$\n其中 $Q(p) \\in \\mathbb{R}^{n \\times n}$ 是对称的，并且对于标量参数 $p \\in \\mathbb{R}$ 是充分光滑的。假设所有函数都根据需要是可微的。\n\n仅使用第一性原理（链式法则、状态方程的线性化和拉格朗日乘子法），执行以下操作：\n\n1) 计算偏导数 $\\partial J/\\partial u$。\n\n2) 引入一个伴随向量 $\\lambda(p) \\in \\mathbb{R}^{n}$，以从全导数 $\\mathrm{d}J/\\mathrm{d}p$ 中消除对状态灵敏度 $\\mathrm{d}u/\\mathrm{d}p$ 的依赖。从残差 $R(u,p) = K(p)\\,u - f(p) = 0$ 出发，推导：\n- 一个定义 $\\lambda(p)$ 的伴随方程，以及\n- 一个完全用 $K$, $Q$, $u$ 以及关于 $p$ 的参数导数表示的 $\\mathrm{d}J/\\mathrm{d}p$ 的显式表达式。\n\n不要假设 $K(p)$ 是对称的。您可以使用标准的欧几里得内积来构成对偶配对。\n\n3) 简要解释为什么您最终的梯度表达式不需要求解 $\\mathrm{d}u/\\mathrm{d}p$。\n\n请提供一个关于 $\\mathrm{d}J/\\mathrm{d}p$ 的单一封闭形式解析表达式作为您的最终答案，该表达式用 $K$, $Q$, $u$, $\\tfrac{\\partial K}{\\partial p}$, $\\tfrac{\\partial f}{\\partial p}$, $\\tfrac{\\partial Q}{\\partial p}$ 和满足您的伴随方程的伴随向量 $\\lambda$ 来表示。不需要进行数值代入。您的最终答案必须是一个单一的符号表达式，并且不得包含任何单位。",
            "solution": "在尝试解答之前，对所述问题进行验证。\n\n首先，逐字提取已知条件。\n- 状态方程：$K(p)\\,u(p) \\;=\\; f(p)$，其中 $K(p) \\in \\mathbb{R}^{n \\times n}$ 非奇异，$u(p) \\in \\mathbb{R}^{n}$，$f(p) \\in \\mathbb{R}^{n}$。\n- 输出泛函：$J(u,p) \\;=\\; \\tfrac{1}{2}\\,u^{T}\\,Q(p)\\,u$，其中 $Q(p) \\in \\mathbb{R}^{n \\times n}$ 对称且光滑。\n- 参数：$p \\in \\mathbb{R}$ 是一个标量。\n- 假设：所有函数都根据需要是可微的。矩阵 $K(p)$ 不假设为对称。\n- 任务：$1$) 计算 $\\partial J/\\partial u$。$2$) 推导伴随方程以及一个消除了对 $\\mathrm{d}u/\\mathrm{d}p$ 依赖的 $\\mathrm{d}J/\\mathrm{d}p$ 表达式。$3$) 解释为何消除了 $\\mathrm{d}u/\\mathrm{d}p$ 项。\n\n其次，根据所需标准对问题进行验证。\n- **科学依据**：该问题是使用伴随方法进行灵敏度分析的标准练习，这是优化、最优控制和计算工程中的一项基本技术。它牢固地建立在向量微积分和线性代数的既定原则之上。\n- **适定性**：该问题是适定的。$K(p)$ 非奇异的先验假设确保了状态向量 $u(p)$ 是唯一确定的。在给定的光滑性假设下，所需的泛函导数和伴随系统是唯一可确定的。\n- **客观性**：问题以精确、无歧义的数学语言陈述。\n- **完整性和一致性**：问题提供了所有必要的定义和约束。没有内部矛盾。\n- **可行性和结构**：该问题是一个理论推导，完全可行。其结构逻辑清晰，并指导从第一性原理进行逐步推导。\n\n该问题被认为是有效的，因为它满足所有标准。现在将构建一个解决方案。\n\n**1) 计算 $\\partial J/\\partial u$**\n\n输出泛函由 $J(u,p) = \\frac{1}{2} u^T Q(p) u$ 给出。为了计算标量 $J$ 关于向量 $u$ 的偏导数，我们考虑在固定参数 $p$ 下，对于一个扰动 $\\mathrm{d}u$ 的微分 $\\mathrm{d}J$。\n$$\n\\mathrm{d}J = \\frac{1}{2} (\\mathrm{d}u)^T Q u + \\frac{1}{2} u^T Q (\\mathrm{d}u)\n$$\n由于 $(\\mathrm{d}u)^T Q u$ 是一个标量，它等于其自身的转置：$(\\mathrm{d}u)^T Q u = (u^T Q^T (\\mathrm{d}u))^T = u^T Q^T (\\mathrm{d}u)$。将此代入第一项得到：\n$$\n\\mathrm{d}J = \\frac{1}{2} u^T Q^T (\\mathrm{d}u) + \\frac{1}{2} u^T Q (\\mathrm{d}u) = \\frac{1}{2} u^T (Q^T + Q) \\mathrm{d}u\n$$\n问题陈述矩阵 $Q(p)$ 是对称的，因此 $Q^T = Q$。表达式简化为：\n$$\n\\mathrm{d}J = \\frac{1}{2} u^T (2Q) \\mathrm{d}u = u^T Q \\mathrm{d}u\n$$\n根据定义，微分 $\\mathrm{d}J$ 通过 $\\mathrm{d}J = \\frac{\\partial J}{\\partial u} \\mathrm{d}u$ 与偏导数（一个行向量，或余向量）相关。通过比较，我们确定 $J$ 对 $u$ 的偏导数为：\n$$\n\\frac{\\partial J}{\\partial u} = u^T Q(p)\n$$\n$J$ 关于 $u$ 的梯度，记为 $\\nabla_u J$，是此行向量的转置，即列向量 $Q(p)u$。\n\n**2) 伴随方程和灵敏度表达式的推导**\n\n目标是求全导数 $\\mathrm{d}J/\\mathrm{d}p$。泛函 $J$ 既通过 $Q(p)$ 显式地依赖于 $p$，也通过状态向量 $u(p)$ 隐式地依赖于 $p$。应用多变量链式法则：\n$$\n\\frac{\\mathrm{d}J}{\\mathrm{d}p} = \\frac{\\partial J}{\\partial p} + \\frac{\\partial J}{\\partial u} \\frac{\\mathrm{d}u}{\\mathrm{d}p}\n$$\n第一项，即显式导数，是通过将 $J$ 对 $p$ 求导，同时保持 $u$ 不变来计算的：\n$$\n\\frac{\\partial J}{\\partial p} = \\frac{\\partial}{\\partial p} \\left( \\frac{1}{2} u^T Q(p) u \\right) = \\frac{1}{2} u^T \\frac{\\partial Q}{\\partial p} u\n$$\n将此结果和第 1) 部分的结果代入，得到全导数的表达式，这被称为直接灵敏度公式：\n$$\n\\frac{\\mathrm{d}J}{\\mathrm{d}p} = \\frac{1}{2} u^T \\frac{\\partial Q}{\\partial p} u + u^T Q \\frac{\\mathrm{d}u}{\\mathrm{d}p}\n$$\n这个表达式依赖于状态灵敏度 $\\mathrm{d}u/\\mathrm{d}p$，它的计算成本很高，因为需要为每个参数求解一个线性系统。伴随方法可以规避这个问题。\n\n我们使用拉格朗日乘子法。约束是状态方程，写成残差形式 $R(u,p) = K(p)u - f(p) = 0$。我们通过使用一个拉格朗日乘子向量 $\\lambda \\in \\mathbb{R}^n$（我们称之为伴随向量）将约束附加到原始泛函 $J$ 上，从而构成增广泛函 $\\mathcal{L}$。\n$$\n\\mathcal{L}(u, p, \\lambda) = J(u, p) + \\lambda^T R(u, p) = \\frac{1}{2} u^T Q u + \\lambda^T (Ku - f)\n$$\n由于状态方程总是满足的（$R(u(p), p) = 0$），对于任何 $\\lambda$ 的选择，我们都有 $\\mathcal{L} = J$。因此，它们关于 $p$ 的全导数相等：$\\mathrm{d}J/\\mathrm{d}p = \\mathrm{d}\\mathcal{L}/\\mathrm{d}p$。我们将 $\\mathcal{L}$ 视为 $u$、$p$ 和 $\\lambda$ 的函数，并应用链式法则来计算 $\\mathrm{d}\\mathcal{L}/\\mathrm{d}p$：\n$$\n\\frac{\\mathrm{d}\\mathcal{L}}{\\mathrm{d}p} = \\frac{\\partial \\mathcal{L}}{\\partial p} + \\frac{\\partial \\mathcal{L}}{\\partial u} \\frac{\\mathrm{d}u}{\\mathrm{d}p} + \\frac{\\partial \\mathcal{L}}{\\partial \\lambda} \\frac{\\mathrm{d}\\lambda}{\\mathrm{d}p}\n$$\n伴随方法的核心是选择 $\\lambda$ 以消除包含状态灵敏度 $\\mathrm{d}u/\\mathrm{d}p$ 的项。这通过将其系数设为零来实现：\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial u} = 0\n$$\n我们来计算这个偏导数：\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial u} = \\frac{\\partial}{\\partial u} \\left( \\frac{1}{2} u^T Q u + \\lambda^T K u - \\lambda^T f \\right) = u^T Q + \\lambda^T K\n$$\n将其设为零得到条件 $u^T Q + \\lambda^T K = 0$。对该方程进行转置，得到**伴随方程**的标准形式：\n$$\n(u^T Q + \\lambda^T K)^T = 0^T \\implies Q^T u + K^T \\lambda = 0\n$$\n由于 $Q$ 是对称的（$Q^T = Q$），我们有：\n$$\nK^T \\lambda = -Q u\n$$\n这是一个定义了伴随向量 $\\lambda(p)$ 的线性方程组。注意它涉及刚度矩阵的转置 $K^T$，并且其求解需要状态向量 $u$。\n\n通过对 $\\lambda$ 的这种特定选择，$\\mathrm{d}\\mathcal{L}/\\mathrm{d}p$ 表达式中的项 $\\frac{\\partial \\mathcal{L}}{\\partial u} \\frac{\\mathrm{d}u}{\\mathrm{d}p}$ 变为零。此外，项 $\\frac{\\partial \\mathcal{L}}{\\partial \\lambda}$ 就是 $R^T$。由于状态方程 $R=0$ 必须成立，该项也为零，因此无论 $\\mathrm{d}\\lambda/\\mathrm{d}p$ 是什么，$\\frac{\\partial \\mathcal{L}}{\\partial \\lambda} \\frac{\\mathrm{d}\\lambda}{\\mathrm{d}p} = 0$。\n\n因此，泛函的全导数简化为：\n$$\n\\frac{\\mathrm{d}J}{\\mathrm{d}p} = \\frac{\\mathrm{d}\\mathcal{L}}{\\mathrm{d}p} = \\frac{\\partial \\mathcal{L}}{\\partial p}\n$$\n我们现在计算 $\\mathcal{L}$ 关于 $p$ 的偏导数：\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial p} = \\frac{\\partial}{\\partial p} \\left( \\frac{1}{2} u^T Q(p) u + \\lambda^T (K(p)u - f(p)) \\right) = \\frac{1}{2} u^T \\frac{\\partial Q}{\\partial p} u + \\lambda^T \\left( \\frac{\\partial K}{\\partial p} u - \\frac{\\partial f}{\\partial p} \\right)\n$$\n这就得到了最终的灵敏度表达式：\n$$\n\\frac{\\mathrm{d}J}{\\mathrm{d}p} = \\frac{1}{2} u^T \\frac{\\partial Q}{\\partial p} u + \\lambda^T \\left( \\frac{\\partial K}{\\partial p} u - \\frac{\\partial f}{\\partial p} \\right)\n$$\n\n**3) 关于消除 $\\mathrm{d}u/\\mathrm{d}p$ 的解释**\n\n梯度 $\\mathrm{d}J/\\mathrm{d}p$ 的最终表达式不需要求解状态灵敏度向量 $\\mathrm{d}u/\\mathrm{d}p$，这是因为伴随问题的特殊构造。通过引入拉格朗日乘子（伴随）向量 $\\lambda$ 并构造增广泛函 $\\mathcal{L}$，我们获得了一个额外的自由度。这个自由度被用来施加伴随方程 $K^T\\lambda = -Qu$。这个方程被专门设计为使 $\\mathrm{d}\\mathcal{L}/\\mathrm{d}p$ 链式法则展开式中 $\\mathrm{d}u/\\mathrm{d}p$ 项的系数为零的条件。通过满足这个伴随方程，全导数 $\\mathrm{d}J/\\mathrm{d}p$ 对状态灵敏度 $\\mathrm{d}u/\\mathrm{d}p$ 的依赖性在代数上被消除了，只留下依赖于状态 $u$、伴随状态 $\\lambda$ 以及问题数据（$K$, $f$, $Q$）关于参数 $p$ 的直接偏导数的项。这构成了伴随方法在涉及大量参数的灵敏度分析中的主要优势，因为只需要求解一个状态系统和一个伴随系统，而不需要为每个参数的灵敏度求解一个新的系统。",
            "answer": "$$\n\\boxed{\\frac{\\mathrm{d}J}{\\mathrm{d}p} = \\frac{1}{2} u^T \\frac{\\partial Q}{\\partial p} u + \\lambda^T \\left( \\frac{\\partial K}{\\partial p} u - \\frac{\\partial f}{\\partial p} \\right)}\n$$"
        },
        {
            "introduction": "在掌握理论并完成代码实现后，我们如何确保计算出的梯度是正确的？本练习  介绍了泰勒余项检验，这是一种严谨且标准的验证灵敏度分析代码的技术。通过一个简单的、可解析求解的偏微分方程系统，您将构建并应用此检验来确认伴随法计算导数的准确性。",
            "id": "3495688",
            "problem": "考虑一个定义在空间域 $x \\in [0,1]$ 上的一维多物理场耦合系统，该系统由以下带有齐次狄利克雷边界条件的稳态偏微分方程（PDE）描述：\n$$\n- \\frac{d^{2} T}{dx^{2}} = p, \\quad T(0) = 0, \\quad T(1) = 0,\n$$\n$$\n- \\frac{d^{2} C}{dx^{2}} = \\delta \\, T(x), \\quad C(0) = 0, \\quad C(1) = 0,\n$$\n其中 $T(x)$ 是温度场，$C(x)$ 是浓度场，$p \\in \\mathbb{R}$ 是一个标量参数，$\\delta \\in \\mathbb{R}$ 是一个固定的耦合系数。定义一个PDE约束的泛函\n$$\nJ(T,C) = \\int_{0}^{1} \\left( T(x)^{3} + C(x)^{2} \\right) \\, dx,\n$$\n并考虑由耦合PDE的唯一解 $(T(x;p), C(x;p))$ 导出的其简化形式 $J(p)$。你的任务是使用一阶和二阶泰勒余项检验来验证通过伴随法计算的梯度和Hessian-向量积。\n\n从适用于多物理场耦合模拟中PDE约束优化的基本定义和定律出发，完成以下任务：\n- 求解耦合PDE，显式地表示出 $T(x;p)$ 和 $C(x;p)$。\n- 从第一性原理出发，推导简化泛函 $J(p)$。\n- 针对参数空间中的单位方向，构建一个用于验证伴随梯度的的一阶泰勒余项检验，以及一个用于验证伴随法计算的Hessian-向量积的二阶泰勒余项检验。\n- 在点 $p = 2$ 和耦合系数 $\\delta = 3$ 处，计算这些余项检验的主阶极限值。\n\n答案规格：\n- 以单个行矩阵的形式提供这两个极限值，使用精确分数，不要四舍五入。\n- 参数 $p$ 和耦合系数 $\\delta$ 是无量纲的，因此不需要物理单位。",
            "solution": "我们从控制性的耦合偏微分方程（PDE）开始：\n$$\n- T''(x) = p, \\quad T(0) = 0, \\quad T(1) = 0,\n$$\n$$\n- C''(x) = \\delta \\, T(x), \\quad C(0) = 0, \\quad C(1) = 0.\n$$\n对于每个固定的 $p$ 和 $\\delta$，这些都是具有唯一解的线性边值问题。\n\n步骤 1：求解 $T(x;p)$。温度方程为\n$$\n- T''(x) = p \\quad \\Longrightarrow \\quad T''(x) = -p.\n$$\n积分两次并施加边界条件 $T(0) = T(1) = 0$，对于常数右端项，其解是众所周知的：\n$$\nT(x;p) = \\frac{p}{2} x (1 - x) = \\frac{p}{2} \\left( x - x^{2} \\right).\n$$\n\n步骤 2：求解 $C(x;p)$。浓度方程为\n$$\n- C''(x) = \\delta \\, T(x) = \\delta \\cdot \\frac{p}{2} \\left( x - x^{2} \\right).\n$$\n定义 $a := \\frac{\\delta p}{2}$。那么\n$$\nC''(x) = -a \\left( x - x^{2} \\right) = -a x + a x^{2}.\n$$\n对 $C''(x)$ 积分得到 $C'(x)$：\n$$\nC'(x) = \\int \\left( -a x + a x^{2} \\right) dx = -\\frac{a}{2} x^{2} + \\frac{a}{3} x^{3} + c_{1}.\n$$\n再次积分得到 $C(x)$：\n$$\nC(x) = \\int \\left( -\\frac{a}{2} x^{2} + \\frac{a}{3} x^{3} + c_{1} \\right) dx = -\\frac{a}{6} x^{3} + \\frac{a}{12} x^{4} + c_{1} x + c_{2}.\n$$\n施加 $C(0) = 0$ 得到 $c_{2} = 0$。施加 $C(1) = 0$：\n$$\n0 = -\\frac{a}{6} + \\frac{a}{12} + c_{1} \\quad \\Longrightarrow \\quad c_{1} = \\frac{a}{12}.\n$$\n因此，\n$$\nC(x;p) = -\\frac{a}{6} x^{3} + \\frac{a}{12} x^{4} + \\frac{a}{12} x = a \\left( -\\frac{x^{3}}{6} + \\frac{x^{4}}{12} + \\frac{x}{12} \\right).\n$$\n回忆 $a = \\frac{\\delta p}{2}$，所以\n$$\nC(x;p) = \\frac{\\delta p}{2} \\left( -\\frac{x^{3}}{6} + \\frac{x^{4}}{12} + \\frac{x}{12} \\right) = \\delta p \\left( -\\frac{x^{3}}{12} + \\frac{x^{4}}{24} + \\frac{x}{24} \\right).\n$$\n\n步骤 3：推导简化泛函 $J(p)$。根据定义，\n$$\nJ(p) = \\int_{0}^{1} \\left( T(x;p)^{3} + C(x;p)^{2} \\right) dx.\n$$\n计算 $T(x;p)^{3}$：\n$$\nT(x;p) = \\frac{p}{2} \\left( x - x^{2} \\right) \\quad \\Longrightarrow \\quad T(x;p)^{3} = \\frac{p^{3}}{8} \\left( x - x^{2} \\right)^{3}.\n$$\n使用Beta函数恒等式 $\\int_{0}^{1} x^{m} (1-x)^{n} dx = \\frac{\\Gamma(m+1)\\Gamma(n+1)}{\\Gamma(m+n+2)}$，取 $m=n=3$ 来计算\n$$\n\\int_{0}^{1} \\left( x - x^{2} \\right)^{3} dx = \\int_{0}^{1} x^{3} (1 - x)^{3} dx = \\frac{\\Gamma(4)\\Gamma(4)}{\\Gamma(8)} = \\frac{3! \\cdot 3!}{7!} = \\frac{36}{5040} = \\frac{1}{140}.\n$$\n因此，\n$$\n\\int_{0}^{1} T(x;p)^{3} dx = \\frac{p^{3}}{8} \\cdot \\frac{1}{140} = \\frac{p^{3}}{1120}.\n$$\n计算 $C(x;p)^{2}$。定义\n$$\ng(x) := -\\frac{x^{3}}{12} + \\frac{x^{4}}{24} + \\frac{x}{24} = \\frac{1}{24} \\left( x^{4} - 2 x^{3} + x \\right) = \\frac{h(x)}{24},\n$$\n其中 $h(x) := x^{4} - 2 x^{3} + x$。那么\n$$\nC(x;p) = \\delta p \\, g(x), \\quad C(x;p)^{2} = \\delta^{2} p^{2} \\, g(x)^{2} = \\delta^{2} p^{2} \\frac{h(x)^{2}}{576}.\n$$\n展开 $h(x)^{2}$：\n$$\nh(x)^{2} = \\left( x^{4} - 2 x^{3} + x \\right)^{2} = x^{8} - 4 x^{7} + 4 x^{6} + 2 x^{5} - 4 x^{4} + x^{2}.\n$$\n在 $[0,1]$ 上逐项积分：\n$$\n\\int_{0}^{1} h(x)^{2} dx = \\frac{1}{9} - 4 \\cdot \\frac{1}{8} + 4 \\cdot \\frac{1}{7} + 2 \\cdot \\frac{1}{6} - 4 \\cdot \\frac{1}{5} + \\frac{1}{3}.\n$$\n使用最小公分母 $2520$ 计算精确有理数值：\n$$\n\\frac{1}{9} = \\frac{280}{2520}, \\quad -4 \\cdot \\frac{1}{8} = -\\frac{1260}{2520}, \\quad 4 \\cdot \\frac{1}{7} = \\frac{1440}{2520},\n$$\n$$\n2 \\cdot \\frac{1}{6} = \\frac{840}{2520}, \\quad -4 \\cdot \\frac{1}{5} = -\\frac{2016}{2520}, \\quad \\frac{1}{3} = \\frac{840}{2520}.\n$$\n分子求和：$280 - 1260 + 1440 + 840 - 2016 + 840 = 124$，因此\n$$\n\\int_{0}^{1} h(x)^{2} dx = \\frac{124}{2520} = \\frac{31}{630}.\n$$\n因此，\n$$\n\\int_{0}^{1} C(x;p)^{2} dx = \\delta^{2} p^{2} \\cdot \\frac{1}{576} \\cdot \\frac{31}{630} = \\delta^{2} p^{2} \\cdot \\frac{31}{362880}.\n$$\n汇总两部分的贡献，\n$$\nJ(p) = \\int_{0}^{1} T^{3} dx + \\int_{0}^{1} C^{2} dx = \\frac{p^{3}}{1120} + \\delta^{2} \\frac{31}{362880} p^{2}.\n$$\n便于写作\n$$\nJ(p) = A p^{3} + B p^{2}, \\quad \\text{其中} \\quad A := \\frac{1}{1120}, \\quad B := \\delta^{2} \\frac{31}{362880}.\n$$\n\n步骤 4：通过伴随推理和简化微积分计算梯度和Hessian。在PDE约束优化中，伴随法通过求解从拉格朗日量导出的伴随PDE，可以得到关于参数 $p$ 的梯度，而无需显式计算状态灵敏度。这里，由于我们已经精确地得到了简化泛函 $J(p)$，\n$$\n\\frac{dJ}{dp} = 3 A p^{2} + 2 B p, \\quad \\frac{d^{2} J}{dp^{2}} = 6 A p + 2 B, \\quad \\frac{d^{3} J}{dp^{3}} = 6 A.\n$$\n对于标量参数，沿单位方向的Hessian-向量积等于 $\\frac{d^{2}J}{dp^{2}}$。如果实现正确，通过伴随法计算的量应与这些简化导数相匹配。\n\n步骤 5：构建一阶和二阶泰勒余项检验。令 $g$ 表示在 $p$ 点通过伴随法计算的梯度，令 $H v$ 表示在 $p$ 点沿单位方向 $v=1$ 通过伴随法计算的Hessian-向量积。定义一阶泰勒余项\n$$\nR_{1}(h) := J(p + h) - J(p) - g \\, h,\n$$\n和二阶泰勒余项\n$$\nR_{2}(h) := J(p + h) - J(p) - g \\, h - \\frac{1}{2} h^{2} (H v),\n$$\n对于小步长 $h \\in \\mathbb{R}$。如果 $g$ 和 $H v$ 是正确的，当 $h \\to 0$ 时的渐近极限由下式给出\n$$\n\\lim_{h \\to 0} \\frac{R_{1}(h)}{h^{2}} = \\frac{1}{2} \\frac{d^{2} J}{dp^{2}} = 3 A p + B,\n$$\n$$\n\\lim_{h \\to 0} \\frac{R_{2}(h)}{h^{3}} = \\frac{1}{6} \\frac{d^{3} J}{dp^{3}} = A.\n$$\n这些极限提供了严格的验证标准：由 $h^{2}$ 缩放后的一阶余项收敛于 $3 A p + B$，由 $h^{3}$ 缩放后的二阶余项收敛于 $A$。\n\n步骤 6：在 $p = 2$ 和 $\\delta = 3$ 处求值。首先计算 $A$ 和 $B$：\n$$\nA = \\frac{1}{1120}, \\quad B = \\delta^{2} \\frac{31}{362880} = 9 \\cdot \\frac{31}{362880} = \\frac{31}{40320}.\n$$\n那么极限值为\n$$\n\\lim_{h \\to 0} \\frac{R_{1}(h)}{h^{2}} = 3 A p + B = 3 \\cdot \\frac{1}{1120} \\cdot 2 + \\frac{31}{40320} = \\frac{6}{1120} + \\frac{31}{40320}.\n$$\n通分到共同的分母 $40320$：\n$$\n\\frac{6}{1120} = \\frac{6 \\cdot 36}{1120 \\cdot 36} = \\frac{216}{40320}, \\quad \\Rightarrow \\quad 3 A p + B = \\frac{216 + 31}{40320} = \\frac{247}{40320}.\n$$\n对于二阶极限，\n$$\n\\lim_{h \\to 0} \\frac{R_{2}(h)}{h^{3}} = A = \\frac{1}{1120}.\n$$\n\n因此，这两个精确的极限值分别为 $\\frac{247}{40320}$ 和 $\\frac{1}{1120}$，它们可作为通过一阶和二阶泰勒余项检验来验证伴随法计算的梯度和Hessian-向量积的目标。",
            "answer": "$$\\boxed{\\begin{pmatrix}\\frac{247}{40320} & \\frac{1}{1120}\\end{pmatrix}}$$"
        },
        {
            "introduction": "在计算科学中，一个常见而微妙的挑战是确保正演问题的数值格式与其伴随方程的构建保持一致，对于像流线迎风/Petrov-Galerkin (SUPG) 这样的稳定化方法尤其如此。本实践练习  将指导您实现并比较一个一致的离散伴随方法和一个不一致的方法，从而清晰地揭示当稳定化项未在伴随方程中被正确处理时所产生的误差。",
            "id": "3495786",
            "problem": "您需要为一个简化的单体流固耦合系统实现一个程序，该程序使用三种不同的途径计算和比较一个标量目标函数相对于一个标量参数的敏度：离散伴随法、忽略流线迎风 Petrov-Galerkin (SUPG) 稳定项的连续伴随法，以及复步法参考。目标是揭示当原始（正向）离散残差中存在 SUPG 稳定项但在伴随方程中被忽略时产生的不一致性。所有变量均为无量纲。\n\n从多物理场耦合模拟和伴随方法中的以下基本基础开始：\n- 空间离散化和施加边界条件后的控制代数系统是一个形式为 $R(x,p)=0$ 的残差方程，其中 $x$ 是流体和结构的耦合未知量向量，$p$ 是一个标量参数。在单体 Newton-Krylov 求解中，我们会对 $R(x,p)$ 进行线性化以形成雅可比矩阵 $A=\\partial R/\\partial x$，并使用 Krylov 方法求解 $A \\Delta x = -R$；这里我们考虑的是线性残差，因此一个 Newton 步就足够了。\n- 对于一个可微的标量输出 $J(x)$，离散伴随敏度通过求解伴随方程 $(\\partial R/\\partial x)^{\\top} \\lambda = (\\partial J/\\partial x)^{\\top}$ 获得，然后计算 $\\mathrm{d}J/\\mathrm{d}p = -\\lambda^{\\top} (\\partial R/\\partial p)$。\n- 复步法通过对一个小的实数 $h$ 计算 $J(x(p+\\mathrm{i}h))$ 并计算 $\\mathrm{d}J/\\mathrm{d}p \\approx \\mathrm{Im}(J(x(p+\\mathrm{i}h)))/h$ 来提供参考敏度，对于解析的 $R$，该方法可以精确到机器精度。\n\n定义一个一维、稳态、耦合的系统，该系统建立在具有 $N$ 个流体节点和 $N$ 个结构节点的均匀网格上，未知向量为 $x=[u_{0},\\dots,u_{N-1},d_{0},\\dots,d_{N-1}]^{\\top} \\in \\mathbb{R}^{2N}$，网格间距为 $h=1/(N-1)$，并采用 Dirichlet 边界条件 $u_{0}=u_{N-1}=0$ 和 $d_{0}=d_{N-1}=0$。流体的内部节点残差由下式给出：\n$$\nR^{f}_{i}(x,p) \\;=\\; -\\nu\\,\\frac{u_{i+1}-2u_{i}+u_{i-1}}{h^{2}} \\;+\\; a\\,\\frac{u_{i}-u_{i-1}}{h} \\;+\\; k_{c}\\,(u_{i}-d_{i}) \\;-\\; f_{i} \\;+\\; \\tau\\,a^{2}\\,\\frac{u_{i+1}-2u_{i}+u_{i-1}}{h^{2}},\n$$\n对于 $i=1,\\dots,N-2$，其中 $a=p$ 是对流速度，$\\nu$ 是运动粘度，$k_{c}$ 是耦合刚度，$f_{i}$ 是已知的流体强迫项，$\\tau$ 是流线迎风 Petrov-Galerkin (SUPG) 稳定化参数。结构的内部节点残差为：\n$$\nR^{s}_{i}(x,p) \\;=\\; -k_{s}\\,\\frac{d_{i+1}-2d_{i}+d_{i-1}}{h^{2}} \\;+\\; k_{c}\\,(d_{i}-u_{i}) \\;-\\; g_{i},\n$$\n对于 $i=1,\\dots,N-2$，其中 $k_{s}$ 是结构刚度，$g_{i}$ 是已知的结构载荷。在 Dirichlet 边界节点 $i\\in\\{0,N-1\\}$ 处，施加 $R^{f}_{i}(x,p)=u_{i}-0$ 和 $R^{s}_{i}(x,p)=d_{i}-0$。将这些方程组装成一个单体残差 $R(x,p)=A(p,\\tau)\\,x-b$，其中 $b$ 由强迫项向量构成。\n\n将标量目标函数定义为流体变量的离散空间平均值，\n$$\nJ(x) \\;=\\; \\frac{1}{N}\\sum_{i=0}^{N-1} u_{i}.\n$$\n\n实现三种敏度计算：\n- 复步法参考敏度 $\\mathrm{d}J/\\mathrm{d}p$：通过对一个小的实数步长 $h$ 使用 $p \\leftarrow p+\\mathrm{i}h$ 求解原始系统，并计算 $\\mathrm{Im}(J)/h$。\n- 离散伴随敏度 $\\mathrm{d}J/\\mathrm{d}p$：使用包含 SUPG 稳定化贡献的精确雅可比矩阵 $A(p,\\tau)$ 和精确的偏参数导数 $(\\partial R/\\partial p)(x,p) = (\\partial A/\\partial p)(p,\\tau)\\,x$，其中 $(\\partial A/\\partial p)$ 同时包含对流导数和与 $\\tau\\,2a$ 成正比的稳定化导数。\n- 忽略伴随方程中 SUPG 的类连续伴随敏度：通过构造 $A_{0}(p)=A(p,\\tau=0)$，求解 $A_{0}(p)^{\\top}\\lambda_{c}=(\\partial J/\\partial x)^{\\top}$，并计算 $\\mathrm{d}J/\\mathrm{d}p \\approx -\\lambda_{c}^{\\top} \\left((\\partial A_{0}/\\partial p)(p)\\,x\\right)$，即伴随算子和 $(\\partial R/\\partial p)$ 均不包含稳定化项。\n\n您的程序必须：\n- 对所有内部流体节点使用 $N=10$，$\\nu=0.01$， $k_{c}=5.0$， $k_{s}=10.0$，$f_{i}=1.0$，对所有内部结构节点使用 $g_{i}=0.0$，并使用如上所述的齐次 Dirichlet 边界数据。\n- 将所有量视为无量纲；输出中不需要物理单位。\n- 实现以下参数对 $(p,\\tau)$ 的测试套件：\n    1. $(p,\\tau)=(1.0,0.0)$,\n    2. $(p,\\tau)=(1.0,0.2)$,\n    3. $(p,\\tau)=(0.0,1.0)$,\n    4. $(p,\\tau)=(-0.7,0.5)$,\n    5. $(p,\\tau)=(2.0,1.0)$.\n- 对于每个测试用例，计算相对于复步法敏度的两个绝对误差：离散伴随敏度的绝对误差和类连续伴随敏度的绝对误差。使用复步步长 $h=10^{-30}$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表。该列表包含 10 个浮点数，对应于离散伴随法和类连续伴随法的绝对误差，并按测试用例的顺序排列。例如，输出格式必须与 $[e_{d,1},e_{c,1},e_{d,2},e_{c,2},e_{d,3},e_{c,3},e_{d,4},e_{c,4},e_{d,5},e_{c,5}]$ 完全一致，其中 $e_{d,i}$ 表示测试 $i$ 中离散伴随法的绝对误差，$e_{c,i}$ 表示测试 $i$ 中类连续伴随法的绝对误差。",
            "solution": "该问题要求实现并比较应用于一个简化的、一维、单体流固耦合系统的三种敏度分析方法。问题的核心是展示当数值稳定项 (SUPG) 包含在正向（原始）模型中，但在伴随敏度计算中被省略时所产生的不一致性。这三种方法分别是复步法（用于提供参考解）、离散伴随法（一致的方法）和一种故意省略稳定项的“类连续伴随”方法。\n\n首先，我们对代数系统进行形式化。离散化的控制方程构成一个线性系统 $R(x, p) = A(p, \\tau)x - b = 0$，其中 $x \\in \\mathbb{R}^{2N}$ 是由流体速度 $u_i$ 和结构位移 $d_i$ 组成的状态向量，$p$ 是我们关注的标量参数，即对流速度 $a$。状态向量的顺序为 $x = [u_0, \\dots, u_{N-1}, d_0, \\dots, d_{N-1}]^{\\top}$。该问题通过计算状态 $x = A(p, \\tau)^{-1}b$ 来求解。\n\n系统矩阵 $A(p, \\tau)$ 和强迫向量 $b$ 是根据所提供的残差方程组装的。对于一个有 $N$ 个节点且网格间距为 $h=1/(N-1)$ 的网格，矩阵 $A \\in \\mathbb{R}^{2N \\times 2N}$ 和向量 $b \\in \\mathbb{R}^{2N}$ 的内部节点（$i=1, \\dots, N-2$）的非零项如下：\n\n对于流体残差 $R_i^f$，系统对应的第 $i$ 行为：\n$$\n\\left(\\frac{2(\\nu - \\tau p^2)}{h^2} + \\frac{p}{h} + k_c\\right)u_i + \\left(\\frac{-(\\nu - \\tau p^2)}{h^2} - \\frac{p}{h}\\right)u_{i-1} + \\left(\\frac{-(\\nu - \\tau p^2)}{h^2}\\right)u_{i+1} - k_c d_i = f_i\n$$\n对于结构残差 $R_i^s$，系统对应的第 $N+i$ 行为：\n$$\n\\left(\\frac{2k_s}{h^2} + k_c\\right)d_i + \\left(\\frac{-k_s}{h^2}\\right)d_{i-1} + \\left(\\frac{-k_s}{h^2}\\right)d_{i+1} - k_c u_i = g_i\n$$\n边界条件 $u_0=u_{N-1}=0$ 和 $d_0=d_{N-1}=0$ 是通过将 $A$ 的第 $0, N-1, N, 2N-1$ 行设为单位行，并将 $b$ 中对应的项设为 $0$ 来施加的。\n\n目标函数为 $J(x) = \\frac{1}{N}\\sum_{i=0}^{N-1} u_i$。这是 $x$ 的一个线性函数。它关于 $x$ 的梯度是一个常数向量 $\\frac{\\partial J}{\\partial x}$，其元素为：\n$$\n\\left(\\frac{\\partial J}{\\partial x}\\right)_j = \\begin{cases} 1/N & \\text{for } 0 \\le j < N \\\\ 0 & \\text{for } N \\le j < 2N \\end{cases}\n$$\n\n$J$ 关于 $p$ 的全导数由伴随公式给出：$\\frac{\\mathrm{d}J}{\\mathrm{d}p} = -\\lambda^{\\top}\\frac{\\partial R}{\\partial p}$。这里，$\\frac{\\partial R}{\\partial p} = \\frac{\\partial}{\\partial p}(A(p,\\tau)x-b) = \\frac{\\partial A}{\\partial p}x$，因为 $b$ 与 $p$ 无关。伴随向量 $\\lambda$ 是线性系统 $(\\frac{\\partial R}{\\partial x})^{\\top}\\lambda = (\\frac{\\partial J}{\\partial x})^{\\top}$ 的解，即 $A(p,\\tau)^{\\top}\\lambda = (\\frac{\\partial J}{\\partial x})^{\\top}$。\n\n矩阵 $\\frac{\\partial A}{\\partial p}$ 是通过对 $A$ 的系数关于 $p$ 求导得到的。唯一的非零项来自第 $i=1, \\dots, N-2$ 行中的流体对流项和 SUPG 项：\n$$\n\\frac{\\partial A_{i,i-1}}{\\partial p} = \\frac{2\\tau p}{h^2} - \\frac{1}{h}, \\quad \\frac{\\partial A_{i,i}}{\\partial p} = \\frac{-4\\tau p}{h^2} + \\frac{1}{h}, \\quad \\frac{\\partial A_{i,i+1}}{\\partial p} = \\frac{2\\tau p}{h^2}\n$$\n\n我们现在概述这三种计算过程。\n\n1.  **复步法参考敏度**：该方法提供了一个高精度的参考值。参数 $p$ 被一个小的虚数步长扰动，即 $p_{cs} = p + \\mathrm{i}h_{cs}$。求解系统 $A(p_{cs}, \\tau)x_{cs} = b$ 以获得复数状态向量 $x_{cs}$。计算目标函数 $J_{cs} = J(x_{cs})$。根据 Cauchy-Riemann 方程，敏度可以精确到机器精度，由 $\\frac{\\mathrm{d}J}{\\mathrm{d}p} \\approx \\frac{\\mathrm{Im}(J_{cs})}{h_{cs}}$ 给出。\n\n2.  **离散伴随敏度**：这是一种理论上一致的伴随方法。a. 求解实值原始系统 $A(p, \\tau)x = b$ 以获得状态 $x$。b. 求解离散伴随系统 $A(p, \\tau)^{\\top}\\lambda = (\\frac{\\partial J}{\\partial x})^{\\top}$ 以获得伴随向量 $\\lambda$。该矩阵是原始系统雅可比矩阵的精确转置。c. 计算偏导数项 $\\frac{\\partial R}{\\partial p} = \\frac{\\partial A(p, \\tau)}{\\partial p}x$。d. 敏度为 $\\frac{\\mathrm{d}J}{\\mathrm{d}p} = -\\lambda^{\\top} \\frac{\\partial R}{\\partial p}$。对于解析残差，该结果必须与复步法的结果在机器精度上匹配。\n\n3.  **类连续伴随敏度**：该方法通过在伴随计算中省略所有与 SUPG 相关的项来故意引入不一致性。a. 原始状态 $x$ 与离散伴随法中的相同，即完整系统 $A(p, \\tau)x = b$ 的解。b. 定义一个不一致的伴随算子 $A_0(p) = A(p, \\tau=0)$。求解不一致的伴随系统 $A_0(p)^{\\top}\\lambda_c = (\\frac{\\partial J}{\\partial x})^{\\top}$ 以获得 $\\lambda_c$。c. 计算一个不一致的偏导数项 $\\left(\\frac{\\partial R}{\\partial p}\\right)_c = \\frac{\\partial A_0(p)}{\\partial p}x$。d. 不一致的敏度被评估为 $\\frac{\\mathrm{d}J}{\\mathrm{d}p} \\approx -\\lambda_c^{\\top} \\left(\\frac{\\partial R}{\\partial p}\\right)_c$。\n\n产生不一致性的原因是，当 $\\tau \\neq 0$ 时，伴随算子 $A_0(p)^{\\top}$ 不是正向算子 $A(p, \\tau)$ 的真实转置。这模拟了从缺少稳定项的偏微分方程推导连续伴随方程，然后将其应用于通过稳定化数值格式获得的原始解时所犯的错误。编程实现将计算方法2和方法3相对于复步法参考解的绝对误差，并对几组 $(p, \\tau)$ 进行测试。预期结果将显示，在所有情况下，离散伴随误差都接近于零，而当 SUPG 项被激活时（即 $\\tau \\neq 0$ 且 $p \\neq 0$），“类连续伴随”误差将非常显著。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef assemble_system(p, tau, N, h, nu, kc, ks, f_val):\n    \"\"\"\n    Assembles the monolithic system matrix A and forcing vector b.\n    Handles both real and complex-valued parameters p.\n    \"\"\"\n    dtype = np.complex128 if np.iscomplexobj(p) else np.float64\n    A = np.zeros((2 * N, 2 * N), dtype=dtype)\n    b = np.zeros(2 * N, dtype=dtype)\n    h2 = h * h\n    a = p\n\n    # Boundary conditions\n    A[0, 0] = 1.0\n    A[N - 1, N - 1] = 1.0\n    A[N, N] = 1.0\n    A[2 * N - 1, 2 * N - 1] = 1.0\n    # Forcing b for boundaries is 0, which is the default.\n\n    # Interior nodes\n    for i in range(1, N - 1):\n        # Fluid residual R^f_i = 0 in row i\n        eff_nu = nu - tau * a**2\n        A[i, i - 1] = -eff_nu / h2 - a / h\n        A[i, i]     = 2 * eff_nu / h2 + a / h + kc\n        A[i, i + 1] = -eff_nu / h2\n        A[i, N + i] = -kc\n        b[i] = f_val\n\n        # Structure residual R^s_i = 0 in row N + i\n        A[N + i, i]         = -kc\n        A[N + i, N + i - 1] = -ks / h2\n        A[N + i, N + i]     = 2 * ks / h2 + kc\n        A[N + i, N + i + 1] = -ks / h2\n        # Forcing g_i is 0.0, which is the default for b.\n    \n    return A, b\n\ndef assemble_dA_dp(p, tau, N, h):\n    \"\"\"\n    Assembles the derivative of the system matrix A with respect to the parameter p.\n    \"\"\"\n    dtype = np.float64\n    dA_dp = np.zeros((2 * N, 2 * N), dtype=dtype)\n    h2 = h * h\n    a = p\n\n    # Only fluid interior equations depend on p.\n    for i in range(1, N - 1):\n        dA_dp[i, i - 1] = 2 * tau * a / h2 - 1 / h\n        dA_dp[i, i]     = -4 * tau * a / h2 + 1 / h\n        dA_dp[i, i + 1] = 2 * tau * a / h2\n    \n    return dA_dp\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (1.0, 0.0),\n        (1.0, 0.2),\n        (0.0, 1.0),\n        (-0.7, 0.5),\n        (2.0, 1.0),\n    ]\n\n    # Define constants\n    N = 10\n    nu = 0.01\n    kc = 5.0\n    ks = 10.0\n    f_val = 1.0\n    h_cs = 1e-30  # Complex-step size\n    \n    h = 1.0 / (N - 1)\n\n    # Gradient of the Quantity of Interest J\n    dJ_dx = np.zeros(2 * N)\n    dJ_dx[:N] = 1.0 / N\n    \n    results = []\n    for p_real, tau in test_cases:\n        p = p_real\n\n        # 1. Complex-Step Reference Sensitivity\n        p_cs = p + 1j * h_cs\n        A_cs, b_cs = assemble_system(p_cs, tau, N, h, nu, kc, ks, f_val)\n        x_cs = np.linalg.solve(A_cs, b_cs.astype(np.complex128))\n        J_cs = (1.0 / N) * np.sum(x_cs[:N])\n        sens_ref = J_cs.imag / h_cs\n\n        # --- Primal solve for adjoint methods ---\n        A, b = assemble_system(p, tau, N, h, nu, kc, ks, f_val)\n        x = np.linalg.solve(A, b)\n\n        # 2. Discrete Adjoint Sensitivity\n        dA_dp = assemble_dA_dp(p, tau, N, h)\n        dR_dp = dA_dp @ x\n        adjoint_vec = np.linalg.solve(A.T, dJ_dx)\n        sens_da = -adjoint_vec.T @ dR_dp\n        \n        # 3. \"Continuous-Adjoint-Like\" Sensitivity (inconsistent)\n        A0, _ = assemble_system(p, 0.0, N, h, nu, kc, ks, f_val)\n        dA0_dp = assemble_dA_dp(p, 0.0, N, h)\n        dR0_dp = dA0_dp @ x\n        adjoint_vec_c = np.linalg.solve(A0.T, dJ_dx)\n        sens_ca = -adjoint_vec_c.T @ dR0_dp\n        \n        # 4. Compute and store absolute errors\n        err_da = abs(sens_da - sens_ref)\n        err_ca = abs(sens_ca - sens_ref)\n        \n        results.append(err_da)\n        results.append(err_ca)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.15e}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}