## 引言
[分层抽样](@entry_id:138654)是统计学和[蒙特卡洛方法](@entry_id:136978)中一种旨在提高估计精度的强大技术。其核心在于将[异质性](@entry_id:275678)总体划分为若干个相对同质的[子集](@entry_id:261956)（层），然后在各层内独立抽样。然而，一个关键问题随之而来：如何在这些层之间分配有限的总样本量以获得最精确的结果？成[比例分配](@entry_id:634725)（Proportional Allocation）为这个问题提供了一个直观、常用且理论上稳健的答案。

本文系统地探讨了成[比例分配](@entry_id:634725)的原理、应用与权衡。我们旨在填补从基础概念到高级应用的知识鸿沟，解释为何这种简单的分配策略在许多情况下是有效的，以及在何种条件下它可能不再是最优选择。

读者将通过本文学习到：在第一章“原理与机制”中，我们将深入其理论基础，推导其[方差缩减](@entry_id:145496)的数学原理，并与Neyman最优分配进行比较。第二章“应用与跨学科联系”将通过生态学、公共卫生和[计算模拟](@entry_id:146373)等领域的实例，展示其在真实世界问题中的广泛应用价值。最后，在“动手实践”部分，您将通过具体练习来巩固这些概念，并将理论知识转化为实践技能。

## 原理与机制

在上一章引言的基础上，本章将深入探讨[分层抽样](@entry_id:138654)中成[比例分配](@entry_id:634725)的原理、机制、优势与局限性。我们将从构建分层估计量开始，推导其统计性质，并系统地分析样本分配策略如何影响估计的精度。本章的目标是提供一个严谨的理论框架，使读者能够理解成[比例分配](@entry_id:634725)为何是一种有效的[方差缩减技术](@entry_id:141433)，并明晰其在何种条件下最优，以及在何种情况下可能表现不佳。

### 分层估计量的构建及其基本性质

[分层抽样](@entry_id:138654)的核心思想是将一个复杂的总体（或积分域）划分为若干个互不重叠、联合覆盖全域的[子集](@entry_id:261956)，即**层 (strata)**。这种划分通常基于我们对总体结构的先验知识，旨在使每个层内部的变异性小于整个总体的变异性。

假设一个总体被划分为 $H$ 个层，记为 $U_1, U_2, \dots, U_H$。令 $N_h$ 为第 $h$ 层的单元数，总体规模为 $N = \sum_{h=1}^H N_h$。第 $h$ 层的**权重 (stratum weight)** 定义为该层在总体中所占的比例：
$W_h = \frac{N_h}{N}$
自然地，所有层权重之和为1，即 $\sum_{h=1}^H W_h = 1$。

我们关心的量是[总体均值](@entry_id:175446) $\mu$，它可以表示为各层均值 $\mu_h$ 的加权平均。设 $\mu_h$ 为第 $h$ 层的真实均值，根据[全期望定律](@entry_id:265946)，[总体均值](@entry_id:175446)可以精确地分解为：
$$ \mu = \sum_{h=1}^H W_h \mu_h $$
这个恒等式是[分层抽样](@entry_id:138654)理论的基石。它将一个全局均值的估计问题分解为对多个局部均值的估计问题。

在[蒙特卡洛积分](@entry_id:141042)的背景下，这个框架同样适用。此时，我们估计的量是 $I = \int_{\Omega} f(x) p(x) dx = \mathbb{E}_p[f(X)]$。我们将积分域 $\Omega$ 划分为 $H$ 个不相交的[子域](@entry_id:155812) $\mathcal{S}_h$，其概率测度为 $W_h = \mathbb{P}(X \in \mathcal{S}_h)$。那么，积分 $I$ 可以写作：
$$ I = \sum_{h=1}^H W_h \mathbb{E}[f(X) | X \in \mathcal{S}_h] = \sum_{h=1}^H W_h \mu_h $$
其中 $\mu_h$ 是 $f(X)$ 在子域 $\mathcal{S}_h$ 上的[条件期望](@entry_id:159140)。

为了估计 $\mu$，一个自然的想法是先在每个层 $h$ 内抽取一个样本来估计该层的均值 $\mu_h$，然后将这些估计值按照总体结构中的权重 $W_h$ 重新组合。具体而言，我们在第 $h$ 层内抽取 $n_h$ 个样本，计算其样本均值 $\bar{Y}_h$。然后，我们构造**分层估计量 (stratified estimator)** $\hat{\mu}_{\text{str}}$：
$$ \hat{\mu}_{\text{str}} = \sum_{h=1}^H W_h \bar{Y}_h $$
这种方法被称为“插件原则” (plug-in principle)，即用样本估计量 $\bar{Y}_h$ 替换真实但未知的参数 $\mu_h$ 。

一个至关重要的性质是，只要层内样本均值 $\bar{Y}_h$ 是层均值 $\mu_h$ 的无偏估计（例如，通过简单随机抽样或在[蒙特卡洛](@entry_id:144354)设置中从层内的条件分布中抽样），分层估计量 $\hat{\mu}_{\text{str}}$ 就必然是[总体均值](@entry_id:175446) $\mu$ 的[无偏估计](@entry_id:756289)。这是因为期望算子的线性性：
$$ \mathbb{E}[\hat{\mu}_{\text{str}}] = \mathbb{E}\left[\sum_{h=1}^H W_h \bar{Y}_h\right] = \sum_{h=1}^H W_h \mathbb{E}[\bar{Y}_h] = \sum_{h=1}^H W_h \mu_h = \mu $$
这个结论对于任何满足 $\sum n_h = n$ 的样本分配方案 $(n_1, \dots, n_H)$ 都成立。这解释了为什么估计量中的权重是总体权重 $W_h$，而不是依赖于样本量的其他权重（如 $n_h/n$）。权重 $W_h$ 反映的是总体的内在结构，是确保无偏性的关键  。

### 样本分配与[估计量方差](@entry_id:263211)

尽管任何样本分配方案都能得到[无偏估计](@entry_id:756289)，但不同的分配方案会显著影响估计量的**[方差](@entry_id:200758) (variance)**，从而影响其精度。由于各层之间的抽样是[相互独立](@entry_id:273670)的，分层[估计量的方差](@entry_id:167223)是各层贡献的[方差](@entry_id:200758)之和：
$$ \operatorname{Var}(\hat{\mu}_{\text{str}}) = \operatorname{Var}\left(\sum_{h=1}^H W_h \bar{Y}_h\right) = \sum_{h=1}^H W_h^2 \operatorname{Var}(\bar{Y}_h) $$
若在层 $h$ 内的 $n_h$ 个样本是独立同分布的，其[方差](@entry_id:200758)为 $\sigma_h^2$（即层内[方差](@entry_id:200758)），则 $\operatorname{Var}(\bar{Y}_h) = \sigma_h^2 / n_h$。（在有限总体抽样中，此项会包含一个有限总体修正因子 $(1-f_h)$，其中 $f_h=n_h/N_h$，但为简化分析，我们常在[蒙特卡洛](@entry_id:144354)或大总体背景下忽略它。）因此，[方差](@entry_id:200758)的一般表达式为：
$$ \operatorname{Var}(\hat{\mu}_{\text{str}}) = \sum_{h=1}^H \frac{W_h^2 \sigma_h^2}{n_h} $$
这个公式是所有分配[策略优化](@entry_id:635350)的出发点。我们的目标是在给定的总样本量 $n = \sum n_h$ 或总成本 $C = \sum c_h n_h$ 的约束下，选择一组 $\{n_h\}$ 来最小化这个[方差](@entry_id:200758)。

### 成[比例分配](@entry_id:634725)：原理与[方差缩减](@entry_id:145496)机制

**成[比例分配](@entry_id:634725) (proportional allocation)** 是一种简单、直观且应用广泛的分配策略。其规则是：分配到每个层的样本数量与该层的权重成正比。
$$ n_h = n W_h $$
这种策略的直观吸[引力](@entry_id:175476)在于它“在[质量集中](@entry_id:175432)的地方投入更多抽样精力”。

将 $n_h = n W_h$ 代入一般[方差](@entry_id:200758)公式，我们得到成[比例分配](@entry_id:634725)下分层[估计量的方差](@entry_id:167223)：
$$ \operatorname{Var}(\hat{\mu}_{\text{prop}}) = \sum_{h=1}^H \frac{W_h^2 \sigma_h^2}{n W_h} = \frac{1}{n} \sum_{h=1}^H W_h \sigma_h^2 $$
这个简洁的公式揭示了深刻的机制。为了理解成[比例分配](@entry_id:634725)如何缩减[方差](@entry_id:200758)，我们需要将其与**简单蒙特卡洛 (Crude Monte Carlo, CMC)** 方法进行比较。CMC [估计量的方差](@entry_id:167223)是 $\operatorname{Var}(\hat{\mu}_{\text{CMC}}) = \frac{1}{n}\operatorname{Var}(Y)$，其中 $Y=f(X)$。

借助**[全方差定律](@entry_id:184705) (Law of Total Variance)**，我们可以将总体[方差](@entry_id:200758) $\operatorname{Var}(Y)$ 分解为两个部分：**层内[方差](@entry_id:200758)的期望 (expected within-stratum variance)** 和 **层间均值的[方差](@entry_id:200758) (variance of between-stratum means)**。
$$ \operatorname{Var}(Y) = \mathbb{E}[\operatorname{Var}(Y|H)] + \operatorname{Var}(\mathbb{E}[Y|H]) $$
用我们的符号表示，这等价于：
$$ \operatorname{Var}(Y) = \left(\sum_{h=1}^H W_h \sigma_h^2\right) + \left(\sum_{h=1}^H W_h (\mu_h - \mu)^2\right) $$
现在对比两种方法的[方差](@entry_id:200758)：
- $\operatorname{Var}(\hat{\mu}_{\text{CMC}}) = \frac{1}{n} \left[ \left(\sum_{h=1}^H W_h \sigma_h^2\right) + \left(\sum_{h=1}^H W_h (\mu_h - \mu)^2\right) \right]$
- $\operatorname{Var}(\hat{\mu}_{\text{prop}}) = \frac{1}{n} \left( \sum_{h=1}^H W_h \sigma_h^2 \right)$

对比可见，成比例[分层抽样](@entry_id:138654)精确地消除了总体[方差](@entry_id:200758)中的第二项，即层间均值的[方差](@entry_id:200758)  。这个[方差](@entry_id:200758)项的来源是：在简单[蒙特卡洛](@entry_id:144354)中，落入每个层的样本数是随机的（服从[多项分布](@entry_id:189072)），这种随机性引入了额外的变异。而[分层抽样](@entry_id:138654)通过**预先固定**每个层的样本数 $n_h$，消除了“样本属于哪个层”这一随机性来源，从而实现了[方差缩减](@entry_id:145496)。

因此，只要各层的均值 $\mu_h$ 不完全相等（即 $\operatorname{Var}(\mathbb{E}[Y|H]) > 0$），成比例[分层抽样](@entry_id:138654)就**必定**会比同样样本总量的简单[蒙特卡洛方法](@entry_id:136978)具有更小的[方差](@entry_id:200758) 。[方差缩减](@entry_id:145496)的幅度直接取决于层间均值的差异程度：划分的层越能有效区分出均值显著不同的子总体，[方差缩减](@entry_id:145496)效果就越好。

当所有层均值都相等时（$\mu_h = \mu$ for all $h$），层间[方差](@entry_id:200758)为零，此时成[比例分配](@entry_id:634725)的[方差](@entry_id:200758)与简单[蒙特卡洛](@entry_id:144354)的[方差](@entry_id:200758)相等 。

### 最优分配策略：Neyman-Tschuprow 框架

成[比例分配](@entry_id:634725)虽然有效，但它并非总是最优的。最优分配策略，通常称为**[Neyman分配](@entry_id:634618)**（或考虑不等成本时的Neyman-Tschuprow分配），旨在直接最小化[方差](@entry_id:200758) $\sum \frac{W_h^2 \sigma_h^2}{n_h}$。

#### 情形1：固定总样本量，成本均等
在总样本量 $n$ 固定且各层抽样成本相同的约束下，使用[拉格朗日乘数法](@entry_id:143041)可以求解得到最优分配方案：
$$ n_h^{\text{opt}} \propto W_h \sigma_h $$
具体来说，最优样本量为：
$$ n_h^{\text{opt}} = n \frac{W_h \sigma_h}{\sum_{j=1}^H W_j \sigma_j} $$
此公式的直观意义是：我们应该将更多的样本分配给那些**权重更大 ($W_h$)** 且**内部变异更大 ($\sigma_h$)** 的层 。

#### 情形2：固定总成本，成本不等
在更实际的情形中，不同层的抽样成本 $c_h$ 可能不同。在固定总预算 $C = \sum c_h n_h$ 的约束下，最优分配方案变为：
$$ n_h^{\text{opt}} \propto \frac{W_h \sigma_h}{\sqrt{c_h}} $$
这个更一般的形式表明，最优分配不仅青睐大而多变的层，还倾向于**成本更低 ($\sqrt{c_h}$ 在分母)** 的层。这为在有限资源下进行有效抽样提供了理论指导  。

### 分配策略的比较分析

理解了不同分配策略的定义后，我们可以系统地比较它们的适用条件和相互关系。

| 分配策略 | 分配规则 ($n_h \propto \dots$) | 所需信息 | 最优条件 |
| :--- | :--- | :--- | :--- |
| **均等分配 (Equal)** | $1$ (常数) | 层数 $H$ | $W_h \sigma_h = \text{常数}$ |
| **成[比例分配](@entry_id:634725) (Proportional)** | $W_h$ | 层权重 $W_h$ | $\sigma_h = \text{常数}$ (成本均等时) |
| **[Neyman分配](@entry_id:634618) (Optimal)** | $W_h \sigma_h$ (成本均等时) | $W_h$ 和 $\sigma_h$ | 总是最优 (按定义) |

从上表可以看出：
- **成[比例分配](@entry_id:634725)**在**层内标准差 $\sigma_h$ 均相等**时，与[Neyman分配](@entry_id:634618)重合，因此成为[最优策略](@entry_id:138495)  。这是因为它正确地考虑了层的规模($W_h$)，而在[方差](@entry_id:200758)均等时，规模是唯一需要考虑的优化因素。
- **均等分配** ($n_h = n/H$) 在 **$W_h \sigma_h$ 的乘积为常数**时最优 。这发生在层权重小但[方差](@entry_id:200758)大的情况，反之亦然，二者恰好抵消。
- **成[比例分配](@entry_id:634725)**与**均等分配**重合的条件是 $W_h = 1/H$，即所有层的规模 $N_h$ 都相等 。
- **[Neyman分配](@entry_id:634618)**需要最多的信息，包括对层内[标准差](@entry_id:153618) $\sigma_h$ 的估计，这在实践中可能需要通过预调查或先验知识获得。而成[比例分配](@entry_id:634725)仅需知道层的相对大小，信息要求较低，因此在实践中更为常用。

### 成[比例分配](@entry_id:634725)的陷阱：一个量化实例

成[比例分配](@entry_id:634725)的主要弱点在于它完全忽略了层内[方差](@entry_id:200758) $\sigma_h$ 的差异。当 $\sigma_h$ 在不同层之间剧烈变化时，成[比例分配](@entry_id:634725)可能远非最优。一个典型的例子是**[稀有事件模拟](@entry_id:754079) (rare-event simulation)**，其中大部分[方差](@entry_id:200758)集中在一个[概率测度](@entry_id:190821)很小（即 $W_h$ 很小）的层中。

考虑一个两层模型 ：
- **层1**: $W_1 = 0.99$, $\sigma_1^2 = 0.01$ (大层，低[方差](@entry_id:200758))
- **层2**: $W_2 = 0.01$, $\sigma_2^2 = 100$ (小层，高[方差](@entry_id:200758))

**成[比例分配](@entry_id:634725)**会这样做：$n_1 = 0.99n$, $n_2 = 0.01n$。它将99%的样本投入到几乎没有变异的层1，而只用1%的样本去估计[方差](@entry_id:200758)极高的层2。这显然是低效的。其[方差](@entry_id:200758)为：
$$ \operatorname{Var}_{\text{prop}} = \frac{1}{n}(W_1 \sigma_1^2 + W_2 \sigma_2^2) = \frac{1}{n}(0.99 \times 0.01 + 0.01 \times 100) = \frac{1.0099}{n} $$

**Neyman最优分配**则会平衡权重和[方差](@entry_id:200758)：$n_h^{\text{opt}} \propto W_h \sigma_h$。
- $\sigma_1 = \sqrt{0.01} = 0.1$, $\sigma_2 = \sqrt{100} = 10$
- $W_1 \sigma_1 = 0.99 \times 0.1 = 0.099$
- $W_2 \sigma_2 = 0.01 \times 10 = 0.100$
最优分配因子 $W_h \sigma_h$ 几乎相等，所以最优策略是近似均等地分配样本，即 $n_1 \approx n/2, n_2 \approx n/2$。这与成[比例分配](@entry_id:634725)的99:1比例形成鲜明对比。最优分配下的[方差](@entry_id:200758)为：
$$ \operatorname{Var}_{\text{opt}} = \frac{1}{n}(W_1 \sigma_1 + W_2 \sigma_2)^2 = \frac{1}{n}(0.099 + 0.1)^2 = \frac{0.199^2}{n} \approx \frac{0.0396}{n} $$

**效率比** $R = \operatorname{Var}_{\text{prop}} / \operatorname{Var}_{\text{opt}} \approx 1.0099 / 0.0396 \approx 25.5$。这意味着，在这个例子中，使用成[比例分配](@entry_id:634725)的[方差](@entry_id:200758)是使用最优分配的25.5倍！这个例子清晰地警示我们，当怀疑层内[方差](@entry_id:200758)存在巨大差异时，盲目使用成[比例分配](@entry_id:634725)可能导致严重的效率损失。类似地，当各层抽样成本 $c_h$ 差异巨大时，忽略成本的分配策略（如标准的成[比例分配](@entry_id:634725)或[Neyman分配](@entry_id:634618)）也会导致次优结果 。

### 更广阔的视角与高级主题

#### 与重要性抽样的对比
[分层抽样](@entry_id:138654)和**重要性抽样 (Importance Sampling, IS)** 都是强大的[方差缩减技术](@entry_id:141433)，但它们的机制不同 。
- **[分层抽样](@entry_id:138654)**保持原始概率测度 $p$ 不变，通过在空间的**划分**上确定性地分配样本数来消除层间变异。它利用的是对总体**结构**的知识（$W_h$）。
- **重要性抽样**则是改变抽样测度，从一个提案[分布](@entry_id:182848) $q$ 中抽样，并通过**重加权**（乘以[似然比](@entry_id:170863) $p(x)/q(x)$）来修正估计的偏差。它利用的是对被积函数 $f(x)$ **行为**的知识，旨在将样本集中在对积分贡献大的区域。

两者可以结合使用，例如在每个层内部使用重要性抽样。

#### 高维空间中的分层
当积分维度 $d \gg 1$ 时，[分层抽样](@entry_id:138654)面临**[维度灾难](@entry_id:143920) (curse of dimensionality)** 的挑战 。
- **简单分层策略的失效**：如果仅沿单个坐标 $X_j$ 进行分层，对于一个典型的高维函数，其大部分[方差](@entry_id:200758)来自于多个变量的相互作用，而不是任何单个变量的主效应。因此，条件期望 $\mathbb{E}[f(X)|X_j]$ 几乎不随 $X_j$ 变化，导致层间[方差](@entry_id:200758) $\operatorname{Var}(\mathbb{E}[f(X)|X_j])$ 趋近于零。这意味着[方差缩减](@entry_id:145496)效果微乎其微。
- **寻找有效分层轴**：为了在高维空间中有效分层，关键是找到能最大化层间[方差](@entry_id:200758)的变量或变量组合。一个好的策略是选择能最大化 $\operatorname{Var}(\mathbb{E}[f(X)|Y])$ 的轴 $Y$（$Y$ 可以是 $X_j$ 或 $X$ 的线性组合 $\mathbf{a}^\top X$）。这在[全局敏感性分析](@entry_id:171355)中等价于寻找具有最大一阶**[Sobol'指数](@entry_id:165435)**的方向。更高级的方法，如**活动[子空间](@entry_id:150286) (Active Subspaces)**，通过分析函数梯度的[协方差矩阵](@entry_id:139155) $\mathbb{E}[\nabla f(X)\nabla f(X)^\top]$ 来寻找使函数变化最快的低维[子空间](@entry_id:150286)，为高维分层提供了前沿的解决方案。

#### 结合其他[方差缩减技术](@entry_id:141433)
[分层抽样](@entry_id:138654)通过消除层间[方差](@entry_id:200758)来缩减总[方差](@entry_id:200758)。其最终的误差来源是剩余的层内[方差](@entry_id:200758) $\frac{1}{n} \sum W_h \sigma_h^2$。为了进一步提高效率，我们可以在每个层**内部**应用其他[方差缩减技术](@entry_id:141433)，如对偶变量或**拟[蒙特卡洛](@entry_id:144354) (Quasi-Monte Carlo, QMC)** 方法。例如，通过在每个层内使用独立的（加扰的）[低差异序列](@entry_id:139452)，我们可以以比标准[蒙特卡洛](@entry_id:144354)更快的收敛速度估计层均值 $\mu_h$，从而在保持分层优势的同时，进一步压低层内误差的贡献 。