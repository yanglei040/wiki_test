{
    "hands_on_practices": [
        {
            "introduction": "热力学积分 (Thermodynamic Integration, TI) 等路径采样方法的效率在很大程度上取决于所选路径的“统计长度”。这个长度与积分函数（即期望能量）在路径上的方差有关：方差越大，数值积分所需的样本量就越多。本练习旨在通过一个简单但极具启发性的高斯模型，为“路径稳定性”这一核心概念建立一个坚实的解析基础 ()。通过从第一性原理出发推导一个闭式解，您将深刻理解路径积分方差的来源，以及它如何量化不同概率分布之间的“重叠”程度。",
            "id": "3328156",
            "problem": "考虑实数线上的两个未归一化密度，$q_{0}(x) = \\exp\\!\\big(-x^{2}/(2\\sigma_{0}^{2})\\big)$ 和 $q_{1}(x) = \\exp\\!\\big(-x^{2}/(2\\sigma_{1}^{2})\\big)$，其中 $\\sigma_{0} > 0$ 且 $\\sigma_{1} > 0$。定义几何路径 $\\{p_{t}(x) : t \\in [0,1]\\}$ 为\n$$\np_{t}(x) \\propto q_{0}(x)^{1-t}\\,q_{1}(x)^{t},\n$$\n并将沿此路径的对数密度增量定义为\n$$\nU(x) \\equiv \\ln q_{1}(x) - \\ln q_{0}(x).\n$$\n一个用于量化热力学积分 (TI) 和几何桥路径采样的重叠程度的路径稳定性泛函为\n$$\nS(\\sigma_{0},\\sigma_{1}) \\equiv \\int_{0}^{1} \\mathrm{Var}_{p_{t}}\\!\\big[U(X)\\big] \\,\\mathrm{d}t,\n$$\n其中方差是关于 $p_{t}$ 计算的。仅从上述定义和高斯分布的标准性质出发，推导 $S(\\sigma_{0},\\sigma_{1})$ 的一个仅用 $\\sigma_{0}$ 和 $\\sigma_{1}$ 表示的闭式解析表达式。你的最终答案必须是一个单一的简化解析表达式。不包含任何单位。无需进行数值四舍五入。",
            "solution": "该问题是有效的，因为它具有统计力学中的科学依据，提法明确且包含了所有必要信息，并且陈述客观。我们可以着手推导路径稳定性泛函 $S(\\sigma_{0},\\sigma_{1})$ 的闭式表达式。\n\n推导过程分为三个主要步骤：\n1.  对于任意给定的 $t \\in [0,1]$，确定归一化的概率分布 $p_t(x)$。\n2.  计算对数密度增量的方差 $\\mathrm{Var}_{p_{t}}[U(X)]$，作为 $t$ 的函数。\n3.  将此方差对 $t$ 从 $0$ 到 $1$ 进行积分，以求得 $S(\\sigma_{0},\\sigma_{1})$。\n\n步骤 1：确定概率分布 $p_t(x)$ 的特性。\n未归一化的密度路径由 $p_{t}(x) \\propto q_{0}(x)^{1-t}\\,q_{1}(x)^{t}$ 给出。代入 $q_{0}(x)$ 和 $q_{1}(x)$ 的表达式：\n$$\np_t(x) \\propto \\left(\\exp\\left(-\\frac{x^2}{2\\sigma_0^2}\\right)\\right)^{1-t} \\left(\\exp\\left(-\\frac{x^2}{2\\sigma_1^2}\\right)\\right)^{t}\n$$\n使用性质 $(\\exp(a))^b = \\exp(ab)$，我们合并指数部分：\n$$\np_t(x) \\propto \\exp\\left(-\\frac{(1-t)x^2}{2\\sigma_0^2} - \\frac{tx^2}{2\\sigma_1^2}\\right) = \\exp\\left(-\\frac{x^2}{2}\\left(\\frac{1-t}{\\sigma_0^2} + \\frac{t}{\\sigma_1^2}\\right)\\right)\n$$\n该函数形式是一个零均值高斯分布 $\\mathcal{N}(0, \\sigma_t^2)$ 的形式，其未归一化密度核为 $\\exp(-x^2/(2\\sigma_t^2))$。通过比较指数，我们可以为每个 $t$ 定义分布 $p_t(x)$ 的方差 $\\sigma_t^2$：\n$$\n\\frac{1}{2\\sigma_t^2} = \\frac{1}{2}\\left(\\frac{1-t}{\\sigma_0^2} + \\frac{t}{\\sigma_1^2}\\right) \\implies \\frac{1}{\\sigma_t^2} = \\frac{1-t}{\\sigma_0^2} + \\frac{t}{\\sigma_1^2}\n$$\n因此，归一化的概率密度函数为：\n$$\np_t(x) = \\frac{1}{\\sqrt{2\\pi}\\sigma_t} \\exp\\left(-\\frac{x^2}{2\\sigma_t^2}\\right)\n$$\n\n步骤 2：计算方差 $\\mathrm{Var}_{p_{t}}[U(X)]$。\n首先，我们求出对数密度增量 $U(x)$ 的显式表达式：\n$$\nU(x) = \\ln q_{1}(x) - \\ln q_{0}(x) = \\ln\\left(\\exp\\left(-\\frac{x^2}{2\\sigma_1^2}\\right)\\right) - \\ln\\left(\\exp\\left(-\\frac{x^2}{2\\sigma_0^2}\\right)\\right)\n$$\n$$\nU(x) = -\\frac{x^2}{2\\sigma_1^2} + \\frac{x^2}{2\\sigma_0^2} = x^2 \\left(\\frac{1}{2\\sigma_0^2} - \\frac{1}{2\\sigma_1^2}\\right)\n$$\n让我们定义一个与 $x$ 和 $t$ 无关的常数 $C$：\n$$\nC \\equiv \\frac{1}{2\\sigma_0^2} - \\frac{1}{2\\sigma_1^2} = \\frac{\\sigma_1^2 - \\sigma_0^2}{2\\sigma_0^2\\sigma_1^2}\n$$\n所以，$U(x) = C x^2$。我们需要计算 $U(X)$ 的方差，其中 $X$ 是从 $p_t(x)$ 中抽取的随机变量。\n$$\n\\mathrm{Var}_{p_{t}}[U(X)] = \\mathrm{Var}_{p_{t}}[C X^2] = C^2 \\mathrm{Var}_{p_{t}}[X^2]\n$$\n$X^2$ 的方差由 $\\mathrm{Var}_{p_{t}}[X^2] = \\mathbb{E}_{p_t}[(X^2)^2] - (\\mathbb{E}_{p_t}[X^2])^2 = \\mathbb{E}_{p_t}[X^4] - (\\mathbb{E}_{p_t}[X^2])^2$ 给出。\n对于随机变量 $X \\sim \\mathcal{N}(0, \\sigma_t^2)$，其二阶矩和四阶矩已知为：\n$$\n\\mathbb{E}_{p_t}[X^2] = \\sigma_t^2\n$$\n$$\n\\mathbb{E}_{p_t}[X^4] = 3(\\sigma_t^2)^2 = 3\\sigma_t^4\n$$\n将这些矩代入 $\\mathrm{Var}_{p_{t}}[X^2]$ 的表达式中：\n$$\n\\mathrm{Var}_{p_{t}}[X^2] = 3\\sigma_t^4 - (\\sigma_t^2)^2 = 2\\sigma_t^4\n$$\n现在我们可以用 $C$ 和 $\\sigma_t$ 来表示 $\\mathrm{Var}_{p_{t}}[U(X)]$：\n$$\n\\mathrm{Var}_{p_{t}}[U(X)] = C^2 (2\\sigma_t^4) = 2 \\left(\\frac{\\sigma_1^2 - \\sigma_0^2}{2\\sigma_0^2\\sigma_1^2}\\right)^2 \\sigma_t^4 = \\frac{(\\sigma_1^2 - \\sigma_0^2)^2}{2(\\sigma_0^2\\sigma_1^2)^2}\\sigma_t^4\n$$\n我们使用 $1/\\sigma_t^2$ 的关系式来表示 $\\sigma_t^4$：\n$$\n\\sigma_t^2 = \\left(\\frac{1-t}{\\sigma_0^2} + \\frac{t}{\\sigma_1^2}\\right)^{-1} = \\left(\\frac{(1-t)\\sigma_1^2 + t\\sigma_0^2}{\\sigma_0^2\\sigma_1^2}\\right)^{-1} = \\frac{\\sigma_0^2\\sigma_1^2}{(1-t)\\sigma_1^2 + t\\sigma_0^2}\n$$\n因此，\n$$\n\\sigma_t^4 = \\frac{(\\sigma_0^2\\sigma_1^2)^2}{((1-t)\\sigma_1^2 + t\\sigma_0^2)^2}\n$$\n将此式代入方差的表达式中：\n$$\n\\mathrm{Var}_{p_{t}}[U(X)] = \\frac{(\\sigma_1^2 - \\sigma_0^2)^2}{2(\\sigma_0^2\\sigma_1^2)^2} \\frac{(\\sigma_0^2\\sigma_1^2)^2}{((1-t)\\sigma_1^2 + t\\sigma_0^2)^2} = \\frac{(\\sigma_1^2 - \\sigma_0^2)^2}{2((1-t)\\sigma_1^2 + t\\sigma_0^2)^2}\n$$\n\n步骤 3：将 $\\mathrm{Var}_{p_{t}}[U(X)]$ 在 $t \\in [0,1]$ 上积分。\n路径稳定性泛函为 $S(\\sigma_{0},\\sigma_{1}) = \\int_{0}^{1} \\mathrm{Var}_{p_{t}}[U(X)] \\mathrm{d}t$。\n$$\nS(\\sigma_{0},\\sigma_{1}) = \\int_{0}^{1} \\frac{(\\sigma_1^2 - \\sigma_0^2)^2}{2((1-t)\\sigma_1^2 + t\\sigma_0^2)^2} \\mathrm{d}t\n$$\n分子相对于 $t$ 是常数，所以我们可以将其从积分中提出：\n$$\nS(\\sigma_{0},\\sigma_{1}) = \\frac{(\\sigma_1^2 - \\sigma_0^2)^2}{2} \\int_{0}^{1} \\frac{1}{(\\sigma_1^2 + t(\\sigma_0^2 - \\sigma_1^2))^2} \\mathrm{d}t\n$$\n我们来计算这个积分。令 $u = \\sigma_1^2 + t(\\sigma_0^2 - \\sigma_1^2)$。则 $\\mathrm{d}u = (\\sigma_0^2 - \\sigma_1^2) \\mathrm{d}t$。我们将积分变量从 $t$ 换为 $u$。\n当 $t=0$ 时，$u = \\sigma_1^2$。当 $t=1$ 时，$u = \\sigma_1^2 + (\\sigma_0^2 - \\sigma_1^2) = \\sigma_0^2$。\n积分变为：\n$$\n\\int_{\\sigma_1^2}^{\\sigma_0^2} \\frac{1}{u^2} \\frac{\\mathrm{d}u}{\\sigma_0^2 - \\sigma_1^2} = \\frac{1}{\\sigma_0^2 - \\sigma_1^2} \\int_{\\sigma_1^2}^{\\sigma_0^2} u^{-2} \\mathrm{d}u\n$$\n假设 $\\sigma_0^2 \\neq \\sigma_1^2$：\n$$\n= \\frac{1}{\\sigma_0^2 - \\sigma_1^2} \\left[-\\frac{1}{u}\\right]_{\\sigma_1^2}^{\\sigma_0^2} = \\frac{1}{\\sigma_0^2 - \\sigma_1^2} \\left(-\\frac{1}{\\sigma_0^2} - \\left(-\\frac{1}{\\sigma_1^2}\\right)\\right)\n$$\n$$\n= \\frac{1}{\\sigma_0^2 - \\sigma_1^2} \\left(\\frac{1}{\\sigma_1^2} - \\frac{1}{\\sigma_0^2}\\right) = \\frac{1}{\\sigma_0^2 - \\sigma_1^2} \\left(\\frac{\\sigma_0^2 - \\sigma_1^2}{\\sigma_0^2\\sigma_1^2}\\right) = \\frac{1}{\\sigma_0^2\\sigma_1^2}\n$$\n现在，将此结果代回 $S(\\sigma_{0},\\sigma_{1})$ 的表达式中：\n$$\nS(\\sigma_{0},\\sigma_{1}) = \\frac{(\\sigma_1^2 - \\sigma_0^2)^2}{2} \\left(\\frac{1}{\\sigma_0^2\\sigma_1^2}\\right) = \\frac{(\\sigma_1^2 - \\sigma_0^2)^2}{2\\sigma_0^2\\sigma_1^2}\n$$\n这个表达式可以进一步简化。我们可以将其重写为：\n$$\nS(\\sigma_{0},\\sigma_{1}) = \\frac{1}{2} \\left(\\frac{\\sigma_1^2 - \\sigma_0^2}{\\sigma_0\\sigma_1}\\right)^2 = \\frac{1}{2} \\left(\\frac{\\sigma_1^2}{\\sigma_0\\sigma_1} - \\frac{\\sigma_0^2}{\\sigma_0\\sigma_1}\\right)^2 = \\frac{1}{2} \\left(\\frac{\\sigma_1}{\\sigma_0} - \\frac{\\sigma_0}{\\sigma_1}\\right)^2\n$$\n这就是最终的闭式解析表达式。如果 $\\sigma_0 = \\sigma_1$，则 $U(x)=0$，所以 $\\mathrm{Var}_{p_t}[U(X)]=0$ 且 $S(\\sigma_0, \\sigma_0)=0$，这与推导出的公式一致。",
            "answer": "$$\n\\boxed{\\frac{1}{2}\\left(\\frac{\\sigma_{1}}{\\sigma_{0}} - \\frac{\\sigma_{0}}{\\sigma_{1}}\\right)^{2}}\n$$"
        },
        {
            "introduction": "在理解了路径积分的方差是衡量其难度的关键之后，一个自然的问题就是：我们如何主动设计路径来减小这个方差？标准的幂后验 (power posterior) 路径通过对似然函数进行“退火”来构造，但这并非唯一选择。本练习将引导您探索另一种同样重要的策略：对先验分布进行退火 ()。通过在一个共轭高斯模型中直接推导和比较这两种路径的积分方差，您将学会如何根据模型特性（具体来说，是先验和似然的相对集中程度）来选择更高效的积分路径。",
            "id": "3328093",
            "problem": "您需要在一个贝叶斯共轭高斯模型中，实现并分析两种基于路径的对数证据（log marginal likelihood）估计器，并确定在何种条件下，通过对由 $\\pi_\\beta \\propto p(y \\mid x) \\, p(x)^\\beta$ 定义的路径中的先验进行调温（tempering），可以相对于标准功效后验（power posterior）路径 $\\pi_\\beta \\propto p(y \\mid x)^\\beta \\, p(x)$ 降低热力学积分的蒙特卡洛方差。\n\n考虑一个模型，其先验为 $p(x) = \\mathcal{N}(x; 0, \\tau^2)$，似然为 $p(y \\mid x) = \\mathcal{N}(y; x, \\sigma^2)$，其中 $\\mathcal{N}(a; b, c)$ 表示变量为 $a$、均值为 $b$、方差为 $c$ 的高斯密度。目标是使用热力学积分沿两条不同路径估计 $\\log p(y)$，并计算相应数值求积估计量的渐近蒙特卡洛方差，其中每个逆温度参数 $\\beta$ 处的期望由大小为 $n$ 的独立蒙特卡洛平均值估计。\n\n使用的基本定义：\n- 贝叶斯法则与归一化常数：对于任何未归一化密度 $q_\\beta(x)$，其归一化常数为 $Z(\\beta) = \\int q_\\beta(x) \\, dx$，归一化密度为 $\\pi_\\beta(x) = q_\\beta(x) / Z(\\beta)$。\n- 热力学积分恒等式：如果 $q_\\beta(x)$ 在 $\\beta$ 上可微，且 $\\partial_\\beta \\log q_\\beta(x)$ 存在并具有足够的可积性，则 $\\frac{d}{d\\beta} \\log Z(\\beta) = \\mathbb{E}_{\\pi_\\beta} \\left[ \\partial_\\beta \\log q_\\beta(X) \\right]$，因此 $\\log Z(1) - \\log Z(0) = \\int_0^1 \\mathbb{E}_{\\pi_\\beta} \\left[ \\partial_\\beta \\log q_\\beta(X) \\right] \\, d\\beta$。\n- 对于一个具有节点 $\\{\\beta_j\\}_{j=0}^{K-1}$ 和权重 $\\{w_j\\}_{j=0}^{K-1}$ 的数值求积，近似 $\\int_0^1 g(\\beta) \\, d\\beta \\approx \\sum_{j=0}^{K-1} w_j g(\\beta_j)$，以及独立的蒙特卡洛估计 $\\widehat{g}(\\beta_j)$ 满足 $\\operatorname{Var}(\\widehat{g}(\\beta_j)) = \\operatorname{Var}_{\\pi_{\\beta_j}}(f(X))/n$，求积估计量的渐近方差为 $\\sum_{j=0}^{K-1} w_j^2 \\, \\operatorname{Var}_{\\pi_{\\beta_j}}(f(X))/n$。\n\n待比较的路径：\n- 功效后验路径：$q_\\beta^{\\mathrm{PP}}(x) = p(y \\mid x)^\\beta \\, p(x)$，因此 $\\partial_\\beta \\log q_\\beta^{\\mathrm{PP}}(x) = \\log p(y \\mid x)$ 且 $\\pi_\\beta^{\\mathrm{PP}}(x) \\propto p(y \\mid x)^\\beta \\, p(x)$。\n- 先验调温路径：$q_\\beta^{\\mathrm{PT}}(x) = p(y \\mid x) \\, p(x)^\\beta$，因此 $\\partial_\\beta \\log q_\\beta^{\\mathrm{PT}}(x) = \\log p(x)$ 且 $\\pi_\\beta^{\\mathrm{PT}}(x) \\propto p(y \\mid x) \\, p(x)^\\beta$。\n\n在共轭高斯设定下，对于每个 $\\beta \\in [0,1]$，$\\pi_\\beta^{\\mathrm{PP}}$ 和 $\\pi_\\beta^{\\mathrm{PT}}$ 都是高斯分布。您将利用这一点，推导出相关被积函数 $f_{\\mathrm{PP}}(x) = \\log p(y \\mid x)$ 和 $f_{\\mathrm{PT}}(x) = \\log p(x)$ 在每个 $\\beta$ 处、在 $\\pi_\\beta$ 下的方差的闭式表达式。\n\n任务：\n- 从第一性原理和高斯恒等式出发，推导出 $\\pi_\\beta^{\\mathrm{PP}}$ 和 $\\pi_\\beta^{\\mathrm{PT}}$ 的均值和方差作为 $\\beta$、$y$、$\\tau^2$ 和 $\\sigma^2$ 的函数的显式公式。\n- 基于这些，推导出 $\\operatorname{Var}_{\\pi_\\beta^{\\mathrm{PP}}}(\\log p(y \\mid X))$ 和 $\\operatorname{Var}_{\\pi_\\beta^{\\mathrm{PT}}}(\\log p(X))$ 作为 $\\beta$、$y$、$\\tau^2$ 和 $\\sigma^2$ 的函数。\n- 使用具有 $K$ 个网格点 $\\beta_j = j/(K-1)$（对于 $j \\in \\{0, \\dots, K-1\\}$）和权重 $w_0 = w_{K-1} = \\Delta \\beta / 2$、$w_j = \\Delta \\beta$（对于 $j \\in \\{1, \\dots, K-2\\}$）的均匀梯形法则，其中 $\\Delta \\beta = 1/(K-1)$，计算每条路径的热力学积分估计器的渐近蒙特卡洛方差，假设在每个网格点使用 $n$ 个独立样本，并且各网格点之间相互独立。\n- 陈述在何种关于 $\\sigma^2$、$\\tau^2$ 和 $y$ 的条件下，先验调温路径能比功效后验路径减小方差。您的程序必须为一组有限的参数值实现方差计算，并报告在每种情况下哪条路径更好。必须报告每条路径的渐近方差的数值。\n\n测试套件：\n为以下参数集 $(y, \\tau^2, \\sigma^2, K, n)$ 提供结果：\n- 情况1：$(y, \\tau^2, \\sigma^2, K, n) = (0.5, 1.0, 1.0, 41, 1000)$。\n- 情况2：$(y, \\tau^2, \\sigma^2, K, n) = (3.0, 10.0, 1.0, 41, 1000)$。\n- 情况3：$(y, \\tau^2, \\sigma^2, K, n) = (3.0, 0.2, 5.0, 41, 1000)$。\n- 情况4（边界离散化检查）：$(y, \\tau^2, \\sigma^2, K, n) = (1.0, 1.0, 0.1, 2, 1000)$。\n\n要求的最终输出格式：\n- 您的程序应生成单行输出，包含一个按情况排列的结果列表。每个情况的结果必须是一个包含三个条目的列表：功效后验路径的渐近方差（浮点数），先验调温路径的渐近方差（浮点数），以及一个布尔值，指示先验调温路径的方差是否严格小于功效后验路径的方差。总输出必须是这些按情况排列的列表的单个列表，打印时不应有多余的空格，除了Python默认的列表到字符串转换所包含的空格。\n- 例如，输出必须看起来像 $[[v_{1,\\mathrm{PP}}, v_{1,\\mathrm{PT}}, b_1], [v_{2,\\mathrm{PP}}, v_{2,\\mathrm{PT}}, b_2], [v_{3,\\mathrm{PP}}, v_{3,\\mathrm{PT}}, b_3], [v_{4,\\mathrm{PP}}, v_{4,\\mathrm{PT}}, b_4]]$，其中 $v_{i,\\cdot}$ 是浮点数，$b_i$ 是布尔值。您必须打印最多包含 $6$ 位小数的浮点数。",
            "solution": "该问题要求推导并比较用于估计共轭高斯模型中对数边缘似然 $\\log p(y)$ 的两种热力学积分（TI）路径的渐近蒙特卡洛方差。这两条路径分别是标准功效后验（PP）路径和先验调温（PT）路径。\n\n该模型由一个高斯先验和似然定义：\n- 先验：$p(x) = \\mathcal{N}(x; 0, \\tau^2) = \\frac{1}{\\sqrt{2\\pi\\tau^2}} \\exp\\left(-\\frac{x^2}{2\\tau^2}\\right)$\n- 似然：$p(y \\mid x) = \\mathcal{N}(y; x, \\sigma^2) = \\frac{1}{\\sqrt{2\\pi\\sigma^2}} \\exp\\left(-\\frac{(y-x)^2}{2\\sigma^2}\\right)$\n\n热力学积分的核心是恒等式 $\\log Z(1) - \\log Z(0) = \\int_0^1 \\mathbb{E}_{\\pi_\\beta} \\left[ \\partial_\\beta \\log q_\\beta(X) \\right] \\, d\\beta$，其中 $\\pi_\\beta(x) = q_\\beta(x)/Z(\\beta)$ 是由 $\\beta \\in [0,1]$ 索引的一族分布，它连接了一个易于处理的初始分布（$\\beta=0$）和一个目标分布（$\\beta=1$）。该积分的数值求积估计量的渐近方差为 $\\mathcal{V} = \\frac{1}{n} \\sum_{j=0}^{K-1} w_j^2 \\operatorname{Var}_{\\pi_{\\beta_j}}(f(X))$，其中 $f(X) = \\partial_\\beta \\log q_\\beta(X)$，$n$ 是每个网格点 $\\beta_j$ 的蒙特卡洛样本数。\n\n我们将首先推导中间分布 $\\pi_\\beta(x)$ 的参数以及每条路径的被积函数的方差。一个关键的数学工具是高斯密度乘积会得到另一个（未归一化的）高斯密度的性质。一个形如 $-\\frac{1}{2v}x^2 + \\frac{\\mu}{v}x + C$ 的通用未归一化对数高斯密度对应于一个高斯分布 $\\mathcal{N}(x; \\mu, v)$。\n\n### 1. 功效后验（PP）路径分析\n对于PP路径，未归一化密度为 $q_\\beta^{\\mathrm{PP}}(x) = p(y \\mid x)^\\beta p(x)$。相应的归一化密度为 $\\pi_\\beta^{\\mathrm{PP}}(x)$。其对数密度为：\n$$ \\log q_\\beta^{\\mathrm{PP}}(x) = \\beta \\log p(y \\mid x) + \\log p(x) + C_1 = -\\beta \\frac{(x-y)^2}{2\\sigma^2} - \\frac{x^2}{2\\tau^2} + C_2 $$\n展开并收集关于 $x$ 的项：\n$$ \\log q_\\beta^{\\mathrm{PP}}(x) = -\\frac{1}{2} \\left[ \\left(\\frac{\\beta}{\\sigma^2} + \\frac{1}{\\tau^2}\\right)x^2 - \\frac{2\\beta y}{\\sigma^2} x \\right] + C_3 $$\n这表明 $\\pi_\\beta^{\\mathrm{PP}}(x)$ 是一个高斯分布 $\\mathcal{N}(x; \\mu_\\beta^{\\mathrm{PP}}, v_\\beta^{\\mathrm{PP}})$。通过配方法，我们确定了逆方差和均值-方差乘积：\n$$ \\frac{1}{v_\\beta^{\\mathrm{PP}}} = \\frac{\\beta}{\\sigma^2} + \\frac{1}{\\tau^2} \\implies v_\\beta^{\\mathrm{PP}} = \\frac{\\sigma^2\\tau^2}{\\beta\\tau^2 + \\sigma^2} $$\n$$ \\frac{\\mu_\\beta^{\\mathrm{PP}}}{v_\\beta^{\\mathrm{PP}}} = \\frac{\\beta y}{\\sigma^2} \\implies \\mu_\\beta^{\\mathrm{PP}} = v_\\beta^{\\mathrm{PP}} \\frac{\\beta y}{\\sigma^2} = \\frac{\\beta y \\tau^2}{\\beta\\tau^2 + \\sigma^2} $$\n该路径的TI被积函数是 $f_{\\mathrm{PP}}(x) = \\partial_\\beta \\log q_\\beta^{\\mathrm{PP}}(x) = \\log p(y \\mid x) = -\\frac{(x-y)^2}{2\\sigma^2} - \\frac{1}{2}\\log(2\\pi\\sigma^2)$。我们需要其方差 $\\operatorname{Var}_{\\pi_\\beta^{\\mathrm{PP}}}(f_{\\mathrm{PP}}(X))$。常数项不影响方差。\n$$ \\operatorname{Var}_{\\pi_\\beta^{\\mathrm{PP}}}(\\log p(y \\mid X)) = \\operatorname{Var}_{\\pi_\\beta^{\\mathrm{PP}}}\\left(-\\frac{(X-y)^2}{2\\sigma^2}\\right) = \\frac{1}{4\\sigma^4} \\operatorname{Var}((X-y)^2) $$\n对于 $X \\sim \\mathcal{N}(\\mu, v)$，随机变量 $Y = X-y$ 服从 $\\mathcal{N}(\\mu-y, v)$。$Y^2$ 的方差为 $\\operatorname{Var}(Y^2) = 2v(2(\\mu-y)^2 + v)$。代入 $\\mu = \\mu_\\beta^{\\mathrm{PP}}$ 和 $v = v_\\beta^{\\mathrm{PP}}$：\n$$ \\operatorname{Var}_{\\pi_\\beta^{\\mathrm{PP}}} = \\frac{1}{4\\sigma^4} \\left[ 2v_\\beta^{\\mathrm{PP}} (2(\\mu_\\beta^{\\mathrm{PP}}-y)^2 + v_\\beta^{\\mathrm{PP}}) \\right] = \\frac{v_\\beta^{\\mathrm{PP}}}{2\\sigma^4} (2(\\mu_\\beta^{\\mathrm{PP}}-y)^2 + v_\\beta^{\\mathrm{PP}}) $$\n代入 $\\mu_\\beta^{\\mathrm{PP}}$ 和 $v_\\beta^{\\mathrm{PP}}$ 的表达式并化简，得到PP路径的每层方差：\n$$ V_{\\mathrm{PP}}(\\beta) = \\frac{y^2 \\sigma^2 \\tau^2}{(\\beta\\tau^2 + \\sigma^2)^3} + \\frac{\\tau^4}{2(\\beta\\tau^2 + \\sigma^2)^2} $$\n\n### 2. 先验调温（PT）路径分析\n对于PT路径，$q_\\beta^{\\mathrm{PT}}(x) = p(y \\mid x) p(x)^\\beta$。其对数密度为：\n$$ \\log q_\\beta^{\\mathrm{PT}}(x) = \\log p(y \\mid x) + \\beta \\log p(x) + C_4 = -\\frac{(x-y)^2}{2\\sigma^2} - \\beta\\frac{x^2}{2\\tau^2} + C_5 $$\n$$ \\log q_\\beta^{\\mathrm{PT}}(x) = -\\frac{1}{2} \\left[ \\left(\\frac{1}{\\sigma^2} + \\frac{\\beta}{\\tau^2}\\right)x^2 - \\frac{2y}{\\sigma^2} x \\right] + C_6 $$\n这对应于一个高斯分布 $\\pi_\\beta^{\\mathrm{PT}}(x) = \\mathcal{N}(x; \\mu_\\beta^{\\mathrm{PT}}, v_\\beta^{\\mathrm{PT}})$，其参数为：\n$$ \\frac{1}{v_\\beta^{\\mathrm{PT}}} = \\frac{1}{\\sigma^2} + \\frac{\\beta}{\\tau^2} \\implies v_\\beta^{\\mathrm{PT}} = \\frac{\\sigma^2\\tau^2}{\\tau^2 + \\beta\\sigma^2} $$\n$$ \\frac{\\mu_\\beta^{\\mathrm{PT}}}{v_\\beta^{\\mathrm{PT}}} = \\frac{y}{\\sigma^2} \\implies \\mu_\\beta^{\\mathrm{PT}} = v_\\beta^{\\mathrm{PT}} \\frac{y}{\\sigma^2} = \\frac{y \\tau^2}{\\tau^2 + \\beta\\sigma^2} $$\nTI被积函数是 $f_{\\mathrm{PT}}(x) = \\partial_\\beta \\log q_\\beta^{\\mathrm{PT}}(x) = \\log p(x) = -\\frac{x^2}{2\\tau^2} - \\frac{1}{2}\\log(2\\pi\\tau^2)$。我们需要它在 $\\pi_\\beta^{\\mathrm{PT}}$ 下的方差：\n$$ \\operatorname{Var}_{\\pi_\\beta^{\\mathrm{PT}}}(\\log p(X)) = \\operatorname{Var}_{\\pi_\\beta^{\\mathrm{PT}}}\\left(-\\frac{X^2}{2\\tau^2}\\right) = \\frac{1}{4\\tau^4} \\operatorname{Var}(X^2) $$\n使用恒等式 $\\operatorname{Var}(X^2) = 2v(2\\mu^2+v)$（对于 $X \\sim \\mathcal{N}(\\mu,v)$），其中 $\\mu = \\mu_\\beta^{\\mathrm{PT}}$ 且 $v = v_\\beta^{\\mathrm{PT}}$：\n$$ \\operatorname{Var}_{\\pi_\\beta^{\\mathrm{PT}}} = \\frac{1}{4\\tau^4} \\left[ 2v_\\beta^{\\mathrm{PT}} (2(\\mu_\\beta^{\\mathrm{PT}})^2 + v_\\beta^{\\mathrm{PT}}) \\right] = \\frac{v_\\beta^{\\mathrm{PT}}}{2\\tau^4} (2(\\mu_\\beta^{\\mathrm{PT}})^2 + v_\\beta^{\\mathrm{PT}}) $$\n代入并化简，得到PT路径的每层方差：\n$$ V_{\\mathrm{PT}}(\\beta) = \\frac{y^2 \\sigma^2 \\tau^2}{(\\tau^2 + \\beta\\sigma^2)^3} + \\frac{\\sigma^4}{2(\\tau^2 + \\beta\\sigma^2)^2} $$\n\n### 3. 渐近方差与路径比较\n使用梯形法则的估计器的总渐近方差为：\n$$ \\mathcal{V} = \\frac{1}{n} \\sum_{j=0}^{K-1} w_j^2 V(\\beta_j) = \\frac{(\\Delta\\beta)^2}{n} \\left[ \\frac{V(0)}{4} + \\sum_{j=1}^{K-2} V(\\beta_j) + \\frac{V(1)}{4} \\right] $$\n其中 $\\beta_j = j/(K-1)$，$\\Delta\\beta = 1/(K-1)$，$V(\\beta)$ 是 $V_{\\mathrm{PP}}(\\beta)$ 或 $V_{\\mathrm{PT}}(\\beta)$。\n\n为了确定PT路径何时更优（即具有更低方差），我们比较 $V_{\\mathrm{PP}}(\\beta)$ 和 $V_{\\mathrm{PT}}(\\beta)$。方差表达式很复杂，但在端点 $\\beta=0$ 和 $\\beta=1$ 处的分析具有启发性。\n在 $\\beta=0$ 处：\n$$ V_{\\mathrm{PP}}(0) = \\frac{2y^2\\tau^2 + \\tau^4}{2\\sigma^4}, \\quad V_{\\mathrm{PT}}(0) = \\frac{2y^2\\sigma^2 + \\sigma^4}{2\\tau^4} $$\n$V_{\\mathrm{PT}}(0)  V_{\\mathrm{PP}}(0)$ 当且仅当 $\\tau^4(2y^2\\sigma^2 + \\sigma^4)  \\sigma^4(2y^2\\tau^2 + \\tau^4)$，化简后为 $2y^2\\sigma^6+\\sigma^8  2y^2\\tau^6+\\tau^8$。由于函数 $g(v) = 2y^2v^3 + v^4$ 在 $v  0$ 时单调递增，该不等式成立当且仅当 $\\sigma^2  \\tau^2$。\n\n在 $\\beta=1$ 处：\n$$ V_{\\mathrm{PP}}(1) = \\frac{y^2 \\sigma^2 \\tau^2}{(\\tau^2 + \\sigma^2)^3} + \\frac{\\tau^4}{2(\\tau^2 + \\sigma^2)^2}, \\quad V_{\\mathrm{PT}}(1) = \\frac{y^2 \\sigma^2 \\tau^2}{(\\tau^2 + \\sigma^2)^3} + \\frac{\\sigma^4}{2(\\tau^2 + \\sigma^2)^2} $$\n$V_{\\mathrm{PT}}(1)  V_{\\mathrm{PP}}(1)$ 当且仅当 $\\sigma^4  \\tau^4$，这等价于 $\\sigma^2  \\tau^2$。\n\n由于当且仅当 $\\sigma^2  \\tau^2$ 时，PT路径在两个端点的方差都更低，并且考虑到方差通常由 $\\beta=0$ 附近的行为主导（尤其是在先验和似然不匹配时），先验调温路径比功效后验路径具有更低方差的一般条件是 $\\sigma^2  \\tau^2$。这对应于似然比先验更集中（信息量更大）的情况。PT路径的优势在于它避免了使用来自宽泛先验的样本来评估一个狭窄的似然，而这正是PP路径在 $\\beta=0$ 附近的高方差情景。\n\n该实现将基于推导出的公式和梯形法则求和，为每个路径和每个测试用例计算总渐近方差。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements and compares the asymptotic variance of thermodynamic integration\n    for a conjugate Gaussian model using two different paths: power posterior and\n    prior tempering.\n    \"\"\"\n    test_cases = [\n        # (y, tau^2, sigma^2, K, n)\n        (0.5, 1.0, 1.0, 41, 1000),\n        (3.0, 10.0, 1.0, 41, 1000),\n        (3.0, 0.2, 5.0, 41, 1000),\n        (1.0, 1.0, 0.1, 2, 1000),\n    ]\n\n    def v_pp_func(beta, y, tau2, sigma2):\n        \"\"\"Calculates Var_pi_beta^PP(log p(y|X)) for a given beta.\"\"\"\n        denominator = beta * tau2 + sigma2\n        term1 = (y**2 * sigma2 * tau2) / (denominator**3)\n        term2 = (tau2**2) / (2 * denominator**2)\n        return term1 + term2\n\n    def v_pt_func(beta, y, tau2, sigma2):\n        \"\"\"Calculates Var_pi_beta^PT(log p(X)) for a given beta.\"\"\"\n        denominator = tau2 + beta * sigma2\n        term1 = (y**2 * sigma2 * tau2) / (denominator**3)\n        term2 = (sigma2**2) / (2 * denominator**2)\n        return term1 + term2\n\n    final_results = []\n\n    for case in test_cases:\n        y, tau2, sigma2, K, n = case\n\n        if K  2:\n            # The trapezoidal rule as defined requires at least 2 points (K>=2).\n            # A result of NaN indicates this invalid parameter.\n            final_results.append([np.nan, np.nan, False])\n            continue\n        \n        # Grid points for numerical integration\n        betas = np.linspace(0.0, 1.0, K)\n        \n        # Calculate integrand variances at each grid point\n        V_pp_values = v_pp_func(betas, y, tau2, sigma2)\n        V_pt_values = v_pt_func(betas, y, tau2, sigma2)\n\n        # Calculate total asymptotic variance using trapezoidal rule weights\n        # V_total = (1/n) * sum(w_j^2 * V(beta_j))\n        # w_j = delta_beta for interior, delta_beta/2 for endpoints\n        # So w_j^2 = (delta_beta)^2 for interior, (delta_beta/2)^2 for endpoints\n        delta_beta = 1.0 / (K - 1)\n        \n        if K == 2:\n            # sum over j=1...K-2 is empty\n            sum_V_pp_interior = 0\n            sum_V_pt_interior = 0\n        else:\n            sum_V_pp_interior = np.sum(V_pp_values[1:-1])\n            sum_V_pt_interior = np.sum(V_pt_values[1:-1])\n\n        total_var_pp = (delta_beta**2 / n) * (\n            V_pp_values[0] / 4.0 + sum_V_pp_interior + V_pp_values[-1] / 4.0\n        )\n        total_var_pt = (delta_beta**2 / n) * (\n            V_pt_values[0] / 4.0 + sum_V_pt_interior + V_pt_values[-1] / 4.0\n        )\n\n        is_pt_better = total_var_pt  total_var_pp\n        \n        final_results.append([total_var_pp, total_var_pt, is_pt_better])\n\n    # Format the final output string as specified\n    results_to_print = []\n    for res in final_results:\n        v_pp, v_pt, b = res\n        # Round to 6 decimal places for printing as per instruction \"at most 6\"\n        # str(round(val, 6)) achieves this.\n        results_to_print.append([round(v_pp, 6), round(v_pt, 6), b])\n\n    # Convert list of lists to string and remove spaces\n    print(str(results_to_print).replace(\" \", \"\"))\n\nsolve()\n```"
        },
        {
            "introduction": "在实际应用中，我们常常会遇到先验分布与观测数据所支持的似然函数之间存在冲突的情况，这可能是由于模型设定不当 (misspecification) 造成的。这种冲突会导致标准的热力学积分路径变得极不稳定，尤其是在路径的起点附近，从而产生巨大的数值误差。本练习旨在解决这一高级问题，要求您设计并分析一种“鲁棒”的积分路径，该路径同时对似然函数和先验分布的尺度进行退火 ()。通过处理这个更具挑战性的场景，您将掌握如何为复杂问题量身定制路径采样策略，以确保模型证据估计的准确性和稳定性。",
            "id": "3328132",
            "problem": "考虑一个在可能错误指定的观测噪声方差下进行分析的分层高斯位置模型。令 $y \\in \\mathbb{R}^n$ 表示观测数据向量，其模型为 $y_i \\mid \\theta \\sim \\mathcal{N}(\\theta, \\sigma_{\\mathrm{mis}}^2)$（对于 $i \\in \\{1,\\dots,n\\}$），并带有高斯先验 $\\theta \\sim \\mathcal{N}(0, \\tau^2)$。符号 $\\sigma_{\\mathrm{mis}}^2$ 表示分析模型中使用的方差（该方差可能相对于数据生成过程是错误指定的），$\\tau^2$ 是先验方差。边际似然（也称为证据）为 $Z = \\int L(y \\mid \\theta; \\sigma_{\\mathrm{mis}}^2)\\, p(\\theta; \\tau^2)\\, d\\theta$，其中 $L$ 是似然，$p$ 是先验。\n\n热力学积分（TI）以及更广义的路径采样通过沿一族分布 $\\{\\pi_t: t \\in [0,1]\\}$（其未归一化密度为 $q_t(\\theta)$）的路径对期望进行积分来估计 $\\log Z$。其基本恒等式是，对于任何具有 $q_t(\\theta)$ 和归一化密度 $\\pi_t(\\theta) = q_t(\\theta)/Z_t$ 的平滑路径，我们有\n$$\n\\log Z_1 - \\log Z_0 \\;=\\; \\int_0^1 \\mathbb{E}_{\\pi_t}\\!\\left[ \\frac{\\partial}{\\partial t} \\log q_t(\\theta) \\right] dt,\n$$\n其中 $Z_t = \\int q_t(\\theta)\\, d\\theta$，并且通过适当选择端点可使 $Z_1 = Z$。为了减少在似然-先验冲突（例如，由于错误指定的 $\\sigma_{\\mathrm{mis}}^2$）下被积函数的不稳定性，考虑一条同时对似然尺度和先验尺度进行回火的稳健路径。令未归一化的路径为\n$$\nq_t(\\theta) \\;\\propto\\; L(y \\mid \\theta; \\sigma_{\\mathrm{mis}}^2)^{t}\\; p_t(\\theta),\n$$\n其中 $p_t(\\theta)$ 是一个高斯分布 $\\mathcal{N}(0, \\tau^2(t))$，其依赖于 $t$ 的方差被选择为在 $t=0$ 处的膨胀先验方差和 $t=1$ 处的目标先验之间随 $t$ 线性变化，即\n$$\n\\tau^2(t) \\;=\\; \\tau^2 \\left( c - (c-1) t \\right),\n$$\n其中 $c  1$ 是一个固定的常数。注意，对于所有 $t \\in [0,1]$，$p_t$ 都是归一化的，因此 $Z_0 = \\int L(y \\mid \\theta; \\sigma_{\\mathrm{mis}}^2)^{0} p_0(\\theta)\\, d\\theta = 1$。\n\n任务：\n\n- 仅从边际似然、高斯密度和上述路径采样恒等式的定义出发，推导以下两种路径的TI被积函数的精确形式：\n  - 具有恒定先验方差的标准似然回火路径，即 $q_t^{\\mathrm{std}}(\\theta) \\propto L(y \\mid \\theta; \\sigma_{\\mathrm{mis}}^2)^{t} \\, \\mathcal{N}(0,\\tau^2)$，\n  - 具有指定 $\\tau^2(t)$ 的稳健路径，即 $q_t^{\\mathrm{rob}}(\\theta) \\propto L(y \\mid \\theta; \\sigma_{\\mathrm{mis}}^2)^{t} \\, \\mathcal{N}(0, \\tau^2(t))$。\n- 仅使用高斯共轭性，为每条路径推导闭式高斯后验分布 $\\pi_t(\\theta)$，及其均值和方差，表示为 $t$、$n$、$\\sigma_{\\mathrm{mis}}^2$、$\\tau^2$（或 $\\tau^2(t)$）和样本均值 $\\bar{y}$ 的函数。\n- 将被积函数完全用在 $\\pi_t(\\theta)$ 下关于 $\\theta$ 的二次型的期望来表示，并将这些期望简化为后验均值和方差的函数。对于稳健路径，需包括变化的先验尺度带来的导数贡献。\n- 在分析模型 $\\mathcal{N}(\\theta, \\sigma_{\\mathrm{mis}}^2)$ 和先验 $\\mathcal{N}(0,\\tau^2)$ 下，提供 $\\log Z$ 的闭式表达式，表示为 $y$、$n$、$\\sigma_{\\mathrm{mis}}^2$ 和 $\\tau^2$ 的函数。这将作为误差评估的基准真相。\n\n实现要求：\n\n- 敏感性研究的数据生成：对于每个测试用例，使用固定的随机种子通过模拟 $n$ 个独立抽样 $y_i \\sim \\mathcal{N}(0, \\sigma_{\\mathrm{true}}^2)$ 来生成 $y$。分析模型使用 $\\sigma_{\\mathrm{mis}}^2$ 作为观测方差，并使用给定的 $\\tau^2$ 作为先验方差。参数 $\\sigma_{\\mathrm{true}}^2$ 仅用于数据生成。\n- 数值积分：使用梯形法则在包含 $K$ 个等距点 $t_j = j/(K-1)$（其中 $j \\in \\{0,1,\\dots,K-1\\}$，$K=9$）的网格上近似 $t$ 的积分。\n- 对于每个测试用例，计算 $\\log Z$ 的两个 TI 估计值：一个用于标准路径，另一个用于具有指定膨胀因子 $c$ 的稳健路径。然后计算这两个估计值相对于闭式 $\\log Z$ 的绝对误差。\n- 最终输出格式：您的程序应生成单行文本，其中包含一个逗号分隔的列表表示，该列表由每个用例的三元组构成。每个三元组为 $[\\mathrm{err\\_std}, \\mathrm{err\\_rob}, \\mathrm{robust\\_better}]$，其中 $\\mathrm{err\\_std}$ 和 $\\mathrm{err\\_rob}$ 分别是标准路径和稳健路径 TI 估计的绝对误差（均四舍五入到 $6$ 位小数），$\\mathrm{robust\\_better}$ 是一个布尔值，指示稳健路径的绝对误差是否严格小于标准路径的绝对误差。该行不能有空格。例如，一个包含两个用例的有效输出应如下所示：$[[0.123456,0.012345,True],[0.010000,0.020000,False]]$。\n\n测试套件：\n\n使用以下测试用例，每个用例由 $(n, \\sigma_{\\mathrm{true}}, \\sigma_{\\mathrm{mis}}, \\tau, c, \\mathrm{seed})$ 指定。\n\n- 用例 1：$(20, 1.0, 1.0, 1.5, 5.0, 1)$。\n- 用例 2：$(50, 2.0, 0.5, 1.0, 20.0, 2)$。\n- 用例 3：$(10, 0.5, 2.0, 1.0, 5.0, 3)$。\n- 用例 4：$(2, 1.0, 0.2, 0.5, 10.0, 4)$。\n\n所有角度（如有）必须以弧度解释。本问题中没有物理单位。您的程序必须实现上述完整流程，并严格按照指定格式打印一行输出。",
            "solution": "该问题被评估为有效，因为它具有科学依据，问题陈述清晰且客观，提出了一个计算统计学中的标准问题，没有任何矛盾或歧义。\n\n所需量的推导分四步进行。首先，我们确定热力学积分（TI）被积函数的一般形式。其次，我们推导依赖于路径的后验分布。第三，我们结合这些结果，得到标准路径和稳健路径的被积函数的显式表达式。第四，我们推导边际似然的闭式解，它将作为误差评估的基准真相。\n\n数据 $y = (y_1, \\dots, y_n)$ 的似然和 $\\theta$ 的先验由高斯密度给出：\n$$\nL(y \\mid \\theta; \\sigma_{\\mathrm{mis}}^2) = \\prod_{i=1}^n \\frac{1}{\\sqrt{2\\pi\\sigma_{\\mathrm{mis}}^2}} \\exp\\left(-\\frac{(y_i - \\theta)^2}{2\\sigma_{\\mathrm{mis}}^2}\\right) = (2\\pi\\sigma_{\\mathrm{mis}}^2)^{-n/2} \\exp\\left(-\\frac{1}{2\\sigma_{\\mathrm{mis}}^2}\\sum_{i=1}^n (y_i - \\theta)^2\\right)\n$$\n$$\np(\\theta; \\tau^2) = \\frac{1}{\\sqrt{2\\pi\\tau^2}} \\exp\\left(-\\frac{\\theta^2}{2\\tau^2}\\right)\n$$\n对于稳健路径，先验 $p_t(\\theta)$ 是 $\\mathcal{N}(0, \\tau^2(t))$，其中 $\\tau^2(t) = \\tau^2(c - (c-1)t)$。\n\n沿路径的未归一化密度为 $q_t(\\theta) \\propto L(y \\mid \\theta; \\sigma_{\\mathrm{mis}}^2)^t p_t(\\theta)$。取对数，我们得到：\n$$\n\\log q_t(\\theta) = t \\log L(y \\mid \\theta; \\sigma_{\\mathrm{mis}}^2) + \\log p_t(\\theta) + C\n$$\n其中 $C$ 是一个与 $\\theta$ 和 $t$ 无关的常数。TI 被积函数是 $\\log q_t(\\theta)$ 关于 $t$ 的导数的期望：\n$$\n\\frac{\\partial}{\\partial t}\\log q_t(\\theta) = \\log L(y \\mid \\theta; \\sigma_{\\mathrm{mis}}^2) + \\frac{\\partial}{\\partial t}\\log p_t(\\theta)\n$$\n依赖于路径的先验是 $p_t(\\theta) = (2\\pi\\tau^2(t))^{-1/2} \\exp(-\\frac{\\theta^2}{2\\tau^2(t)})$。其对数导数是：\n$$\n\\frac{\\partial}{\\partial t}\\log p_t(\\theta) = \\frac{\\partial}{\\partial t}\\left(-\\frac{1}{2}\\log(2\\pi\\tau^2(t)) - \\frac{\\theta^2}{2\\tau^2(t)}\\right) = -\\frac{1}{2\\tau^2(t)}\\frac{d\\tau^2(t)}{dt} + \\frac{\\theta^2}{2(\\tau^2(t))^2}\\frac{d\\tau^2(t)}{dt} = \\left(\\frac{\\theta^2}{2\\tau^2(t)} - \\frac{1}{2}\\right)\\frac{1}{\\tau^2(t)}\\frac{d\\tau^2(t)}{dt}\n$$\n因此，完整的 TI 被积函数 $I(t) = \\mathbb{E}_{\\pi_t}[\\frac{\\partial}{\\partial t}\\log q_t(\\theta)]$ 为：\n$$\nI(t) = \\mathbb{E}_{\\pi_t}[\\log L(y \\mid \\theta; \\sigma_{\\mathrm{mis}}^2)] + \\left(\\frac{\\mathbb{E}_{\\pi_t}[\\theta^2]}{2\\tau^2(t)} - \\frac{1}{2}\\right)\\frac{1}{\\tau^2(t)}\\frac{d\\tau^2(t)}{dt}\n$$\n其中 $\\pi_t(\\theta) = q_t(\\theta) / \\int q_t(\\theta') d\\theta'$。\n\n对于**标准路径**，$\\tau^2(t) = \\tau^2$ 是常数，因此 $\\frac{d\\tau^2(t)}{dt} = 0$。第二项消失，被积函数简化为：\n$$\nI_{\\mathrm{std}}(t) = \\mathbb{E}_{\\pi_t^{\\mathrm{std}}}[\\log L(y \\mid \\theta; \\sigma_{\\mathrm{mis}}^2)]\n$$\n对于**稳健路径**，$\\tau^2(t) = \\tau^2(c - (c-1)t)$，因此 $\\frac{d\\tau^2(t)}{dt} = -\\tau^2(c-1)$。被积函数是：\n$$\nI_{\\mathrm{rob}}(t) = \\mathbb{E}_{\\pi_t^{\\mathrm{rob}}}[\\log L(y \\mid \\theta; \\sigma_{\\mathrm{mis}}^2)] - \\frac{\\tau^2(c-1)}{\\tau^2(t)}\\left(\\frac{\\mathbb{E}_{\\pi_t^{\\mathrm{rob}}}[\\theta^2]}{2\\tau^2(t)} - \\frac{1}{2}\\right)\n$$\n\n接下来，我们求解后验分布 $\\pi_t(\\theta)$。由于似然和先验都是高斯分布，后验也是高斯分布。对数后验是 $\\theta$ 的二次函数：\n$$\n\\log \\pi_t(\\theta) \\propto t \\log L(y \\mid \\theta) + \\log p_t(\\theta) \\propto -\\frac{t}{2\\sigma_{\\mathrm{mis}}^2}\\sum_{i=1}^n(y_i - \\theta)^2 - \\frac{\\theta^2}{2\\tau^2(t)}\n$$\n展开求和项并收集关于 $\\theta$ 的项：\n$$\n\\sum(y_i - \\theta)^2 = n\\theta^2 - 2n\\bar{y}\\theta + \\sum y_i^2\n$$\n$$\n\\log \\pi_t(\\theta) \\propto -\\frac{1}{2}\\left(\\frac{nt}{\\sigma_{\\mathrm{mis}}^2} + \\frac{1}{\\tau^2(t)}\\right)\\theta^2 + \\left(\\frac{nt\\bar{y}}{\\sigma_{\\mathrm{mis}}^2}\\right)\\theta + \\mathrm{const}\n$$\n通过配方法，我们将 $\\pi_t(\\theta)$ 识别为 $\\mathcal{N}(\\theta \\mid \\mu_t, V_t)$，其后验精度（方差的倒数）为 $\\frac{1}{V_t} = \\frac{nt}{\\sigma_{\\mathrm{mis}}^2} + \\frac{1}{\\tau^2(t)}$，均值为 $\\mu_t = V_t \\left(\\frac{nt\\bar{y}}{\\sigma_{\\mathrm{mis}}^2}\\right)$。因此后验方差为 $V_t = \\left(\\frac{nt}{\\sigma_{\\mathrm{mis}}^2} + \\frac{1}{\\tau^2(t)}\\right)^{-1}$。所需的期望 $\\mathbb{E}_{\\pi_t}[\\theta^2]$ 由 $V_t + \\mu_t^2$ 给出。\n对于标准路径，$\\tau^2(t)$ 被常数 $\\tau^2$ 替代。对于稳健路径，使用 $\\tau^2(t)$ 的完整表达式。\n\n对数似然项的期望可以用后验矩来表示：\n$$\n\\mathbb{E}_{\\pi_t}[\\log L] = -\\frac{n}{2}\\log(2\\pi\\sigma_{\\mathrm{mis}}^2) - \\frac{1}{2\\sigma_{\\mathrm{mis}}^2}\\mathbb{E}_{\\pi_t}\\left[\\sum(y_i-\\theta)^2\\right]\n$$\n$$\n\\mathbb{E}_{\\pi_t}\\left[\\sum(y_i-\\theta)^2\\right] = \\mathbb{E}_{\\pi_t}\\left[ \\sum y_i^2 - 2n\\bar{y}\\theta + n\\theta^2 \\right] = \\sum y_i^2 - 2n\\bar{y}\\mu_t + n(V_t + \\mu_t^2)\n$$\n这些表达式完全以已知量和路径参数 $t$ 的形式指定了被积函数 $I_{\\mathrm{std}}(t)$ 和 $I_{\\mathrm{rob}}(t)$。\n\n最后，推导精确的边际似然 $Z$。模型指定 $y_i|\\theta \\sim \\mathcal{N}(\\theta, \\sigma_{\\mathrm{mis}}^2)$ 和 $\\theta \\sim \\mathcal{N}(0, \\tau^2)$。这意味着数据向量 $y$ 的边际分布是多元正态分布，$y \\sim \\mathcal{N}(0, \\Sigma_y)$。均值为 $\\mathbb{E}[y] = \\mathbb{E}[\\mathbb{E}[y|\\theta]] = \\mathbb{E}[\\mathbf{1}\\theta]=0$。协方差为 $\\mathrm{Cov}(y) = \\mathbb{E}[\\mathrm{Cov}(y|\\theta)]+\\mathrm{Cov}(\\mathbb{E}[y|\\theta]) = \\sigma_{\\mathrm{mis}}^2 I_n + \\tau^2 J_n$，其中 $I_n$ 是单位矩阵，$J_n$ 是全1矩阵。对数边际似然为 $\\log Z = \\log p(y)$：\n$$\n\\log Z = -\\frac{n}{2}\\log(2\\pi) - \\frac{1}{2}\\log(\\det(\\Sigma_y)) - \\frac{1}{2}y^T\\Sigma_y^{-1}y\n$$\n行列式为 $\\det(\\Sigma_y) = (\\sigma_{\\mathrm{mis}}^2)^{n-1}(\\sigma_{\\mathrm{mis}}^2 + n\\tau^2)$。二次型为 $y^T\\Sigma_y^{-1}y = \\frac{\\sum(y_i-\\bar{y})^2}{\\sigma_{\\mathrm{mis}}^2} + \\frac{n\\bar{y}^2}{\\sigma_{\\mathrm{mis}}^2 + n\\tau^2}$。将这些结合起来，得到基准真相的闭式表达式：\n$$\n\\log Z = -\\frac{n}{2}\\log(2\\pi\\sigma_{\\mathrm{mis}}^2) - \\frac{1}{2}\\log\\left(1 + \\frac{n\\tau^2}{\\sigma_{\\mathrm{mis}}^2}\\right) - \\frac{1}{2}\\left(\\frac{\\sum(y_i-\\bar{y})^2}{\\sigma_{\\mathrm{mis}}^2} + \\frac{n\\bar{y}^2}{\\sigma_{\\mathrm{mis}}^2 + n\\tau^2}\\right)\n$$\n通过从对数行列式项中提出因子 $\\sigma_{\\mathrm{mis}}^2$，可以从一般表达式中简化该公式。有了这些解析结果，我们就可以进行数值实现了。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes and compares thermodynamic integration estimates of marginal likelihood\n    for a hierarchical Gaussian model using standard and robust paths.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (n, sigma_true, sigma_mis, tau, c, seed)\n        (20, 1.0, 1.0, 1.5, 5.0, 1),\n        (50, 2.0, 0.5, 1.0, 20.0, 2),\n        (10, 0.5, 2.0, 1.0, 5.0, 3),\n        (2, 1.0, 0.2, 0.5, 10.0, 4),\n    ]\n\n    results_as_strings = []\n    K = 9  # Number of grid points for trapezoidal rule\n    t_grid = np.linspace(0, 1, K)\n\n    for n, sigma_true, sigma_mis, tau, c, seed in test_cases:\n        # Generate data\n        rng = np.random.default_rng(seed)\n        y = rng.normal(loc=0.0, scale=sigma_true, size=n)\n        \n        # Pre-compute statistics and parameters\n        y_bar = np.mean(y)\n        sum_sq_y = np.sum(y**2)\n        sum_sq_dev_y = np.sum((y - y_bar)**2)\n        s2_mis = sigma_mis**2\n        tau2 = tau**2\n\n        # 1. Ground Truth (Closed-Form) Log Marginal Likelihood\n        log_det_term = np.log(s2_mis + n * tau2) + (n - 1) * np.log(s2_mis)\n        quad_term = sum_sq_dev_y / s2_mis + (n * y_bar**2) / (s2_mis + n * tau2)\n        logZ_true = -n / 2.0 * np.log(2.0 * np.pi) - 0.5 * log_det_term - 0.5 * quad_term\n\n        # 2. Thermodynamic Integration\n        integrand_std = np.zeros(K)\n        integrand_rob = np.zeros(K)\n\n        for i, t in enumerate(t_grid):\n            # --- Standard Path Calculation ---\n            prec_prior_std = 1.0 / tau2\n            prec_lik_std = n * t / s2_mis\n            V_t_std = 1.0 / (prec_lik_std + prec_prior_std)\n            mu_t_std = V_t_std * (n * t * y_bar / s2_mis)\n            \n            # Integrand: E[log L]\n            E_logL_std = -n/2.0 * np.log(2.0 * np.pi * s2_mis) - \\\n                         1.0/(2.0*s2_mis) * (sum_sq_y - 2.0*n*y_bar*mu_t_std + n*(V_t_std + mu_t_std**2))\n            integrand_std[i] = E_logL_std\n\n            # --- Robust Path Calculation ---\n            tau2_t = tau2 * (c - (c - 1) * t)\n            prec_prior_rob = 1.0 / tau2_t\n            prec_lik_rob = n * t / s2_mis\n            V_t_rob = 1.0 / (prec_lik_rob + prec_prior_rob)\n            mu_t_rob = V_t_rob * (n * t * y_bar / s2_mis)\n            \n            # Integrand Part 1: E[log L]\n            E_logL_rob = -n/2.0 * np.log(2.0 * np.pi * s2_mis) - \\\n                         1.0/(2.0*s2_mis) * (sum_sq_y - 2.0*n*y_bar*mu_t_rob + n*(V_t_rob + mu_t_rob**2))\n\n            # Integrand Part 2: Derivative of log prior\n            E_theta2_rob = V_t_rob + mu_t_rob**2\n            prior_deriv_term = -((c - 1) / (c - (c - 1) * t)) * (E_theta2_rob / (2.0 * tau2_t) - 0.5)\n            \n            integrand_rob[i] = E_logL_rob + prior_deriv_term\n            \n        # 3. Numerical Integration (Trapezoidal Rule)\n        logZ_std = np.trapz(integrand_std, t_grid)\n        logZ_rob = np.trapz(integrand_rob, t_grid)\n\n        # 4. Compute Absolute Errors and Compare\n        err_std = abs(logZ_std - logZ_true)\n        err_rob = abs(logZ_rob - logZ_true)\n        robust_better = err_rob  err_std\n\n        # Format results as specified\n        results_as_strings.append(f\"[{err_std:.6f},{err_rob:.6f},{robust_better}]\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results_as_strings)}]\")\n\nsolve()\n```"
        }
    ]
}