{
    "hands_on_practices": [
        {
            "introduction": "在模拟任何随机过程之前，我们必须首先量化每种可能事件发生的可能性。在化学动力学背景下，这是通过计算每个反应通道的倾向性函数 $a_\\mu$ 来实现的。本练习  将指导您从头开始，为一个给定的反应网络计算这些倾向性，从而加深对系统状态与其动态潜力之间联系的理解。",
            "id": "3302951",
            "problem": "考虑一个充分混合的等温系统，该系统由化学主方程建模，并通过随机模拟算法（SSA）进行模拟。系统中有两个物种，$A$ 和 $B$。在时间 $t_{0}$ 时的状态向量为 $x(t_{0}) = (X_{A}, X_{B}) = (7, 4)$。反应网络如下：\n- $R_{1}: A + A \\rightarrow B$，其化学计量变化向量为 $\\nu_{1} = (-2, +1)$，随机速率常数为 $c_{1} = 0.5\\,\\text{s}^{-1}$。\n- $R_{2}: A + B \\rightarrow 2A$，其化学计量变化向量为 $\\nu_{2} = (+1, -1)$，随机速率常数为 $c_{2} = 0.2\\,\\text{s}^{-1}$。\n- $R_{3}: B \\rightarrow A$，其化学计量变化向量为 $\\nu_{3} = (+1, -1)$，随机速率常数为 $c_{3} = 3\\,\\text{s}^{-1}$。\n- $R_{4}: A \\rightarrow \\varnothing$，其化学计量变化向量为 $\\nu_{4} = (-1, 0)$，随机速率常数为 $c_{4} = 1\\,\\text{s}^{-1}$。\n\n从与化学主方程框架下的离散质量作用动力学一致的第一性原理出发，通过枚举状态 $x(t_{0})$ 中存在的不同反应物组合的数量，确定所有反应的倾向 $a_{\\mu}(x(t_{0}))$，然后计算总倾向 $a_{0}(x(t_{0})) = \\sum_{\\mu} a_{\\mu}(x(t_{0}))$。以 $\\text{s}^{-1}$ 为单位，用单个数字给出最终答案 $a_{0}(x(t_{0}))$。给出精确值，不要四舍五入。",
            "solution": "该问题要求在特定状态 $x(t_{0})$ 下，计算给定化学反应网络的总倾向 $a_{0}(x(t_{0}))$。计算需要从第一性原理出发，并与化学主方程（CME）所描述的系统的离散和随机性质保持一致。\n\n反应 $R_{\\mu}$ 的倾向函数 $a_{\\mu}(x)$ 的定义是：在时间 $t$ 系统处于状态 $x$ 的条件下，$a_{\\mu}(x) dt$ 表示在无穷小时间间隔 $[t, t+dt)$ 内反应 $R_{\\mu}$ 发生一次的概率。对于一个充分混合的等温系统中的质量作用动力学，倾向函数是随机速率常数 $c_{\\mu}$ 与当前状态 $x$ 下可用的不同反应物分子组合数量 $h_{\\mu}(x)$ 的乘积。其一般形式为：\n$$a_{\\mu}(x) = c_{\\mu} h_{\\mu}(x)$$\n系统在初始时间 $t_{0}$ 的状态由分子数向量 $x(t_{0}) = (X_{A}, X_{B}) = (7, 4)$ 给出，其中 $X_{A}$ 是物种 $A$ 的分子数，$X_{B}$ 是物种 $B$ 的分子数。我们将计算在此状态下四个指定反应中每个反应的倾向。\n\n**反应 $R_{1}: A + A \\rightarrow B$**\n这是一个双分子反应，涉及两个相同的 $A$ 物种分子。不同反应物组合的数量 $h_{1}(x)$，可以通过从 $X_{A}$ 个分子的总群体中选择 $2$ 个 $A$ 分子的方式数来计算。这由二项式系数给出：\n$$h_{1}(x) = \\binom{X_{A}}{2} = \\frac{X_{A}(X_{A}-1)}{2!}$$\n因此，反应 $R_{1}$ 的倾向为：\n$$a_{1}(x) = c_{1} h_{1}(x) = c_{1} \\frac{X_{A}(X_{A}-1)}{2}$$\n在给定状态 $X_{A} = 7$ 和速率常数 $c_{1} = 0.5\\,\\text{s}^{-1}$ 的条件下，倾向为：\n$$a_{1}(x(t_{0})) = (0.5) \\cdot \\frac{7(7-1)}{2} = (0.5) \\cdot \\frac{7 \\cdot 6}{2} = (0.5) \\cdot 21 = 10.5\\,\\text{s}^{-1}$$\n\n**反应 $R_{2}: A + B \\rightarrow 2A$**\n这是一个双分子反应，涉及两种不同的反应物物种 $A$ 和 $B$。不同反应物组合的数量 $h_{2}(x)$，是从 $X_{A}$ 个可用的 $A$ 分子中选择一个，并从 $X_{B}$ 个可用的 $B$ 分子中选择一个的方式数。这即是它们数量的乘积：\n$$h_{2}(x) = X_{A} \\cdot X_{B}$$\n反应 $R_{2}$ 的倾向为：\n$$a_{2}(x) = c_{2} h_{2}(x) = c_{2} X_{A} X_{B}$$\n在 $X_{A} = 7$，$X_{B} = 4$ 和 $c_{2} = 0.2\\,\\text{s}^{-1}$ 的条件下，倾向为：\n$$a_{2}(x(t_{0})) = (0.2) \\cdot (7 \\cdot 4) = (0.2) \\cdot 28 = 5.6\\,\\text{s}^{-1}$$\n\n**反应 $R_{3}: B \\rightarrow A$**\n这是一个单分子反应，其中单个 $B$ 物种分子是反应物。反应物“组合”的数量 $h_{3}(x)$ 就是物种 $B$ 的分子总数。\n$$h_{3}(x) = X_{B}$$\n反应 $R_{3}$ 的倾向为：\n$$a_{3}(x) = c_{3} h_{3}(x) = c_{3} X_{B}$$\n在 $X_{B} = 4$ 和 $c_{3} = 3\\,\\text{s}^{-1}$ 的条件下，倾向为：\n$$a_{3}(x(t_{0})) = (3) \\cdot 4 = 12\\,\\text{s}^{-1}$$\n\n**反应 $R_{4}: A \\rightarrow \\varnothing$**\n这是一个物种 $A$ 的单分子衰变反应。反应物分子的数量就是组合的数量 $h_{4}(x)$。\n$$h_{4}(x) = X_{A}$$\n反应 $R_{4}$ 的倾向为：\n$$a_{4}(x) = c_{4} h_{4}(x) = c_{4} X_{A}$$\n在 $X_{A} = 7$ 和 $c_{4} = 1\\,\\text{s}^{-1}$ 的条件下，倾向为：\n$$a_{4}(x(t_{0})) = (1) \\cdot 7 = 7\\,\\text{s}^{-1}$$\n\n**总倾向**\n总倾向 $a_{0}(x(t_{0}))$ 是所有单个反应倾向的总和。在Gillespie算法中，它代表了指数分布的速率参数，从该分布中可以抽样得到下一次反应事件发生的时间。\n$$a_{0}(x(t_{0})) = \\sum_{\\mu=1}^{4} a_{\\mu}(x(t_{0})) = a_{1}(x(t_{0})) + a_{2}(x(t_{0})) + a_{3}(x(t_{0})) + a_{4}(x(t_{0}))$$\n代入计算出的值：\n$$a_{0}(x(t_{0})) = 10.5 + 5.6 + 12 + 7$$\n$$a_{0}(x(t_{0})) = 16.1 + 12 + 7$$\n$$a_{0}(x(t_{0})) = 28.1 + 7$$\n$$a_{0}(x(t_{0})) = 35.1\\,\\text{s}^{-1}$$\n在给定状态下，总倾向的精确值为 $35.1\\,\\text{s}^{-1}$。",
            "answer": "$$\\boxed{35.1}$$"
        },
        {
            "introduction": "任何 Gillespie 模拟的核心都是正确地采样到下一个事件发生前的等待时间 $\\tau$。直接法（DM）和第一反应法（FRM）都被设计为从速率为总倾向性 $a_0$ 的指数分布中抽取 $\\tau$。这个编程练习  要求您实现这两种算法，然后使用柯尔莫哥洛夫-斯米尔诺夫（Kolmogorov-Smirnov）统计检验来验证您的实现确实能从正确的理论分布中产生样本。",
            "id": "3302917",
            "problem": "考虑一个连续时间马尔可夫跳跃过程的固定状态，该过程代表了随机化学动力学，其反应通道由 $k \\in \\{1,\\dots,K\\}$ 索引。每个反应通道 $k$ 都有一个在固定状态下为常数的倾向函数 $a_k \\ge 0$，总倾向为 $a_0 = \\sum_{k=1}^{K} a_k$。在固定状态下，到下一个反应事件的等待时间是一个随机变量 $\\tau \\ge 0$。您将实现并比较用于采样 $\\tau$ 的直接法 (DM) 和第一反应法 (FRM)，然后使用柯尔莫哥洛夫-斯米尔诺夫 (KS) 统计量设计一个拟合优度检验，以验证来自 DM 或 FRM 的经验等待时间是否遵循累积分布函数 $F(t) = 1 - e^{-a_0 t}$（对于 $t \\ge 0$）。\n\n从适用于连续时间马尔可夫过程和随机模拟的第一性原理出发，使用关于倾向和事件时间分布的经过充分检验的事实，但除了定义 KS 检验的原假设所需的公式外，不要假定任何快捷公式。柯尔莫哥洛夫-斯米尔诺夫统计量应应用于通过在具有指定倾向的固定状态下使用 DM 或 FRM 模拟等待时间而获得的 $\\tau$ 的经验样本。\n\n您的程序必须：\n- 使用总倾向为 $a_0$ 的直接法 (DM) 和倾向为 $(a_1,\\dots,a_K)$ 的第一反应法 (FRM)，在固定状态下实现对 $\\tau$ 的采样。\n- 对于每个测试用例，使用 DM 或 FRM 生成一个独立的等待时间样本 $\\{\\tau_i\\}_{i=1}^{n}$，根据理论累积分布函数 $F(t) = 1 - e^{-a_0^{\\mathrm{test}} t}$ 计算柯尔莫哥洛夫-斯米尔诺夫统计量，其中 $a_0^{\\mathrm{test}}$ 是真实的 $a_0$ 或指定的备择值。计算 KS 检验对应的 $p$ 值，并在给定的显著性水平 $\\alpha$ 下做出决策。\n- 为每个测试用例返回一个布尔值：如果在指定的 $\\alpha$ 水平下，KS 检验未能拒绝原假设（即，$p$ 值大于或等于 $\\alpha$），则返回 $\\mathrm{True}$，否则返回 $\\mathrm{False}$。\n- 所有等待时间均使用秒作为时间单位，但最终输出应为布尔值，因此无单位。\n- 通过为每个测试用例使用固定的随机种子来确保可复现性。\n\n测试套件：\n- 案例 1（正常路径，DM）：倾向 $(a_1,a_2,a_3) = (0.5, 0.7, 2.3)$，因此 $a_0 = 3.5$；样本大小 $n = 300$；显著性水平 $\\alpha = 0.001$；使用 $a_0^{\\mathrm{test}} = a_0$；随机种子 $12345$。\n- 案例 2（正常路径，FRM）：倾向 $(a_1,a_2,a_3) = (0.5, 0.7, 2.3)$，因此 $a_0 = 3.5$；样本大小 $n = 300$；显著性水平 $\\alpha = 0.001$；使用 $a_0^{\\mathrm{test}} = a_0$；随机种子 $54321$。\n- 案例 3（错误设定边界情况，FRM）：倾向 $(a_1,a_2,a_3) = (0.5, 0.7, 2.3)$，因此 $a_0 = 3.5$；样本大小 $n = 300$；显著性水平 $\\alpha = 0.05$；使用 $a_0^{\\mathrm{test}} = 0.5 a_0$；随机种子 $999$。\n- 案例 4（小倾向的边界条件，DM）：倾向 $(a_1,a_2) = (0.001, 0.002)$，因此 $a_0 = 0.003$；样本大小 $n = 2000$；显著性水平 $\\alpha = 0.001$；使用 $a_0^{\\mathrm{test}} = a_0$；随机种子 $2023$。\n- 案例 5（零倾向的边界情况，FRM）：倾向 $(a_1,a_2) = (0.0, 1.5)$，因此 $a_0 = 1.5$；样本大小 $n = 300$；显著性水平 $\\alpha = 0.001$；使用 $a_0^{\\mathrm{test}} = a_0$；随机种子 $777$。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果，例如 $[\\mathrm{result}_1,\\mathrm{result}_2,\\mathrm{result}_3,\\mathrm{result}_4,\\mathrm{result}_5]$，其中每个 $\\mathrm{result}_i$ 是对应于测试用例 $i$ 的决策的 $\\mathrm{True}$ 或 $\\mathrm{False}$。",
            "solution": "该问题要求实现并统计验证两种用于采样等待时间 $\\tau$ 的方法：直接法 (DM) 和第一反应法 (FRM)，这些方法用于连续时间马尔可夫跳跃过程的随机化学动力学模型。验证将使用柯尔莫哥洛夫-斯米尔诺夫 (KS) 拟合优度检验来执行。\n\n此问题的理论基础在于化学动力学的随机表述，其中系统的状态由每种化学物质的分子数来描述。反应作为离散的随机事件发生。对于处于固定状态的系统，由 $k \\in \\{1, \\dots, K\\}$ 索引的 $K$ 个可能的反应通道中的每一个都被视为一个独立的泊松过程。第 $k$ 个泊松过程的速率由其倾向函数 $a_k$ 给出。由于为了采样下一个事件时间的系统状态被认为是固定的，每个 $a_k$ 都是一个非负常数，$a_k \\ge 0$。\n\n总倾向 $a_0$ 是各个倾向的总和：\n$$\na_0 = \\sum_{k=1}^{K} a_k\n$$\n这个量代表了*任何*反应事件发生的总速率。该模型的一个基本结果是，直到下一个反应事件（无论哪个事件）的等待时间 $\\tau$ 是一个连续随机变量，它遵循速率参数等于总倾向 $a_0$ 的指数分布。$\\tau$ 的概率密度函数 (PDF) 由下式给出：\n$$\np(t; a_0) = a_0 e^{-a_0 t} \\quad \\text{for } t \\ge 0\n$$\n相应的累积分布函数 (CDF)，它给出了等待时间小于或等于某个时间 $t$ 的概率，是：\n$$\nF(t; a_0) = P(\\tau \\le t) = \\int_0^t a_0 e^{-a_0 s} ds = 1 - e^{-a_0 t} \\quad \\text{for } t \\ge 0\n$$\n这个理论 CDF 构成了我们统计检验中原假设的基础。\n\n我们现在描述两种用于采样 $\\tau$ 的模拟方法。\n\n**直接法 (DM)**\n\n直接法是 Gillespie 随机模拟算法 (SSA) 的一个核心组成部分，它直接从其指数分布中采样等待时间 $\\tau$。这可以通过使用逆变换采样法高效地实现。我们从 CDF $F(\\tau) = 1 - e^{-a_0 \\tau}$ 开始。设 $r$ 是从 $(0, 1)$ 区间上的均匀分布中抽取的一个随机数，并设 $r = F(\\tau)$。然后我们求解 $\\tau$：\n$$\nr = 1 - e^{-a_0 \\tau}\n$$\n$$\n1 - r = e^{-a_0 \\tau}\n$$\n$$\n\\ln(1 - r) = -a_0 \\tau\n$$\n$$\n\\tau = -\\frac{1}{a_0} \\ln(1 - r)\n$$\n由于如果 $r$ 在 $(0, 1)$ 上均匀分布，那么 $1-r$ 也在 $(0, 1)$ 上均匀分布。因此，我们可以通过用另一个均匀随机数替换 $1-r$ 来简化表达式，为简单起见，我们也将其表示为 $r$。这导出了众所周知的采样 $\\tau$ 的公式：\n$$\n\\tau = \\frac{1}{a_0} \\ln\\left(\\frac{1}{r}\\right)\n$$\n该方法需要生成一个随机数来确定等待时间。这假设 $a_0 > 0$。如果 $a_0 = 0$，则没有反应可以发生，$\\tau$ 实际上是无限的。\n\n**第一反应法 (FRM)**\n\n第一反应法提供了另一种在数学上等效的采样 $\\tau$ 的方法。我们不考虑总倾向，而是独立地考虑每个反应通道。对于每个倾向为 $a_k > 0$ 的通道 $k$，我们提出了一个假定的等待时间 $\\tau_k$，即假设该特定反应是唯一可能的反应时，它会发生的时间。每个 $\\tau_k$ 都从其自身的速率 $a_k$ 的指数分布中采样：\n$$\n\\tau_k = \\frac{1}{a_k} \\ln\\left(\\frac{1}{r_k}\\right)\n$$\n其中每个 $r_k$ 是来自 $(0, 1)$ 上均匀分布的独立随机数。对于任何 $a_k=0$ 的通道，其等待时间 $\\tau_k$ 是无限的。整个系统中*下一个*反应发生的等待时间是所有这些假定时间的最小值，因为第一个“触发”的反应决定了整个系统的事件时间：\n$$\n\\tau = \\min_{k \\in \\{1,\\dots,K\\}} \\{\\tau_k\\}\n$$\n指数分布的一个关键性质是，一组独立的指数分布随机变量的最小值也服从指数分布。如果 $\\tau_k \\sim \\text{Exponential}(a_k)$，那么 $\\min\\{\\tau_k\\}$ 服从一个指数分布，其速率参数等于各个速率之和，即 $\\sum_k a_k = a_0$。因此，FRM 保证能生成与 DM 相同分布的样本。此方法需要生成 $K$ 个随机数（或每个 $a_k > 0$ 的通道一个随机数）来确定等待时间。\n\n**柯尔莫哥洛夫-斯米尔诺夫 (KS) 拟合优度检验**\n\n为了验证由 DM 或 FRM 生成的样本 $\\{\\tau_i\\}_{i=1}^{n}$ 是否符合理论分布，我们采用 KS 检验。该检验将样本的经验分布函数 (EDF) 与参考分布的累积分布函数 (CDF) 进行比较。EDF，记为 $F_n(t)$，定义为小于或等于 $t$ 的样本点的比例：\n$$\nF_n(t) = \\frac{1}{n} \\sum_{i=1}^n I(\\tau_i \\le t)\n$$\n其中 $I(\\cdot)$ 是指示函数。原假设 $H_0$ 是样本从具有 CDF $F(t) = 1 - e^{-a_0^{\\mathrm{test}} t}$ 的理论分布中抽取。KS 统计量 $D_n$ 是 EDF 和理论 CDF 在所有可能的 $t$ 值上的最大绝对差：\n$$\nD_n = \\sup_{t} |F_n(t) - F(t)|\n$$\n该检验计算一个 $p$ 值，即假设 $H_0$ 为真时，观察到等于或大于从样本中计算出的 $D_n$ 统计量的概率。决策规则基于预定义的显著性水平 $\\alpha$：\n- 如果 $p$ 值 $\\ge \\alpha$，我们未能拒绝原假设 $H_0$。这表明数据与理论分布一致。程序应返回 $\\mathrm{True}$。\n- 如果 $p$ 值 $ \\alpha$，我们拒绝原假设 $H_0$。这表明数据与理论分布之间存在统计上显著的差异。程序应返回 $\\mathrm{False}$。\n\n对于每个测试用例，流程如下：\n1.  为保证可复现性，设置指定的随机种子。\n2.  根据指定的方法（DM 或 FRM），使用给定的倾向 $(a_1, \\dots, a_K)$ 生成一个包含 $n$ 个等待时间的样本。\n3.  按规定计算总倾向 $a_0 = \\sum_k a_k$ 和检验倾向 $a_0^{\\mathrm{test}}$。\n4.  对生成的样本 $\\{\\tau_i\\}$ 与速率为 $a_0^{\\mathrm{test}}$ 的理论指数分布（在 `scipy` 中对应于尺度参数 $1/a_0^{\\mathrm{test}}$）进行双边 KS 检验。\n5.  将得到的 $p$ 值与显著性水平 $\\alpha$ 进行比较，以决定是否拒绝 $H_0$ 并确定布尔输出。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import kstest\n\ndef solve():\n    \"\"\"\n    Implements and validates waiting time sampling for stochastic simulation\n    using the Direct Method (DM) and First Reaction Method (FRM).\n    Uses the Kolmogorov-Smirnov test to check if simulated waiting times\n    follow the theoretical exponential distribution.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"method\": \"DM\",\n            \"propensities\": (0.5, 0.7, 2.3),\n            \"n\": 300,\n            \"alpha\": 0.001,\n            \"a0_test_factor\": 1.0,\n            \"seed\": 12345\n        },\n        {\n            \"method\": \"FRM\",\n            \"propensities\": (0.5, 0.7, 2.3),\n            \"n\": 300,\n            \"alpha\": 0.001,\n            \"a0_test_factor\": 1.0,\n            \"seed\": 54321\n        },\n        {\n            \"method\": \"FRM\",\n            \"propensities\": (0.5, 0.7, 2.3),\n            \"n\": 300,\n            \"alpha\": 0.05,\n            \"a0_test_factor\": 0.5,\n            \"seed\": 999\n        },\n        {\n            \"method\": \"DM\",\n            \"propensities\": (0.001, 0.002),\n            \"n\": 2000,\n            \"alpha\": 0.001,\n            \"a0_test_factor\": 1.0,\n            \"seed\": 2023\n        },\n        {\n            \"method\": \"FRM\",\n            \"propensities\": (0.0, 1.5),\n            \"n\": 300,\n            \"alpha\": 0.001,\n            \"a0_test_factor\": 1.0,\n            \"seed\": 777\n        }\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        # Set seed for reproducibility\n        np.random.seed(case[\"seed\"])\n\n        propensities = np.array(case[\"propensities\"])\n        n = case[\"n\"]\n        alpha = case[\"alpha\"]\n        method = case[\"method\"]\n        a0_test_factor = case[\"a0_test_factor\"]\n\n        # Calculate true total propensity\n        a0_true = np.sum(propensities)\n\n        samples = []\n        if method == \"DM\":\n            if a0_true == 0:\n                # Waiting time is infinite, simulation should stop.\n                # KS test is not meaningful on a sample of infinities.\n                # This case isn't in the test suite, but is a necessary check.\n                # For this problem, we can assume a0_true > 0 based on test cases.\n                pass\n            \n            # Generate n random numbers for inverse transform sampling\n            rand_nums = np.random.uniform(low=0.0, high=1.0, size=n)\n            # Vectorized calculation of waiting times\n            samples = (1.0 / a0_true) * np.log(1.0 / rand_nums)\n\n        elif method == \"FRM\":\n            # Generate n samples one by one\n            for _ in range(n):\n                putative_times = []\n                for a_k in propensities:\n                    if a_k > 0:\n                        rand_num = np.random.uniform(low=0.0, high=1.0)\n                        tau_k = (1.0 / a_k) * np.log(1.0 / rand_num)\n                        putative_times.append(tau_k)\n                \n                if not putative_times:\n                    # All propensities are zero, waiting time is infinite.\n                    # As with DM, this case is not in the test suite.\n                    tau = np.inf\n                else:\n                    tau = min(putative_times)\n                samples.append(tau)\n        \n        # Define the null hypothesis for the KS test\n        a0_test = a0_true * a0_test_factor\n        \n        # The theoretical CDF is F(t) = 1 - exp(-a0_test * t).\n        # scipy.stats.expon uses a scale parameter, where scale = 1/rate.\n        # The rate parameter lambda is a0_test.\n        scale_param = 1.0 / a0_test\n        \n        # Perform the two-sided Kolmogorov-Smirnov test\n        # H0: samples are drawn from an exponential distribution with the specified scale.\n        ks_statistic, p_value = kstest(samples, 'expon', args=(0, scale_param))\n        \n        # Decision: Fail to reject H0 if p-value is greater than or equal to alpha\n        decision = p_value >= alpha\n        results.append(decision)\n\n    # Final print statement in the exact required format.\n    # The boolean values True/False must be capitalized as such in the output string.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "尽管直接法和第一反应法在数学上是等价的，但它们的实际实现可能会带来不同的挑战。第一反应法为每个反应生成一个假定时间，因此容易受到有限精度算术问题的影响，尤其是当两个反应时间几乎相同时。这个思想实验  深入探讨了数值“平局”的问题，并要求您分析不同平局处理策略所引入的统计偏差，这是稳健算法设计中的一个关键考量。",
            "id": "3302938",
            "problem": "考虑一个混合均匀的随机反应网络，其在状态 $\\mathbf{x}$ 时具有状态依赖的反应倾向 $\\{a_{\\mu}(\\mathbf{x})\\}_{\\mu=1}^{M}$。在 Gillespie 随机模拟算法的第一反应法（FRM）中，我们抽取独立的候选反应时间 $T_{\\mu} \\sim \\mathrm{Exp}(a_{\\mu})$，并在时间 $\\tau = \\min_{\\mu} T_{\\mu}$ 执行索引为 $I = \\arg\\min_{\\mu} T_{\\mu}$ 的反应。在精确算术中，FRM 等价于直接法（DM）：下一反应时间服从速率为 $a_{0} = \\sum_{\\mu=1}^{M} a_{\\mu}$ 的指数分布，且反应 $k$ 发生的概率为 $a_{k}/a_{0}$，与 $\\tau$ 无关。\n\n在有限精度浮点运算中，当 $|T_{i} - T_{j}| \\le \\delta$（对于预设容差 $\\delta  0$）时，实现有时会声明通道之间出现“数值平局”。我们将任何解决此类事件以产生一个索引 $I$ 和一个执行时间 $\\tau$ 的程序称为平局处理规则。\n\n从以下基本依据出发：\n- 化学主方程描述了一个连续时间马尔可夫跳跃过程，这意味着无记忆性，并且速率为 $\\{a_{\\mu}\\}$ 的独立指数时钟决定了下一反应时间。\n- 对于独立的指数随机变量，其最小值服从指数分布，速率等于各速率之和，且最小值的身份（即哪个变量是最小值）的分布与其速率成正比。\n\n分析当两个候选时间 $T_{i}$ 和 $T_{j}$ 满足 $|T_{i} - T_{j}| \\le \\delta$ 时，在 FRM 中应如何处理数值平局，以及平局打破规则的选择是否能保持模拟的下一反应分布的无偏性。这里的“无偏性”指的是，对于每个 $k$，模拟的下一反应索引 $I$ 的分布等于 $a_{k}/a_{0}$，并且模拟的时间 $\\tau$ 的分布为 $\\mathrm{Exp}(a_{0})$，误差会在 $\\delta \\to 0$ 时消失。\n\n选择正确的选项。\n\nA. 因为对于独立的指数变量，精确概率 $\\mathbb{P}(T_{i} = T_{j}) = 0$，所以任何确定性的平局打破规则（例如，总是选择较小的索引）都是无偏的，即使在使用非零容差 $\\delta$ 时也是如此。\n\nB. 如果 $|T_{i} - T_{j}| \\le \\delta$，那么在出现平局的通道中均匀随机地选择索引，并设置 $\\tau = \\min\\{T_{i}, T_{j}\\}$，可以在 $\\delta \\to 0$ 的极限情况下保持 $I$ 和 $\\tau$ 的无偏性，并在有限的 $\\delta$ 下产生 $O(\\delta)$ 的误差。\n\nC. 如果 $|T_{i} - T_{j}| \\le \\delta$，那么在出现平局的通道中总是选择具有较大倾向的反应可以避免偏差，因为该反应更可能是真正的最小值。\n\nD. 如果 $|T_{i} - T_{j}| \\le \\delta$，那么以与其倾向成正比的概率在出现平局的通道之间进行选择，即以概率 $a_{i}/(a_{i}+a_{j})$ 选择反应 $i$，可以保证在平局条件下的无偏性，因此也能保证整体的无偏性。",
            "solution": "用户需要对 Gillespie 随机模拟算法（SSA）的第一反应法（FRM）在有限精度算术背景下的平局打破规则进行详细分析。\n\n### 问题验证\n\n**步骤 1：提取已知条件**\n-   **系统：** 一个具有 $M$ 个反应通道的混合均匀的随机反应网络。\n-   **状态：** $\\mathbf{x}$。\n-   **倾向：** 状态依赖的反应倾向 $\\{a_{\\mu}(\\mathbf{x})\\}_{\\mu=1}^{M}$。总倾向为 $a_{0} = \\sum_{\\mu=1}^{M} a_{\\mu}$。\n-   **第一反应法 (FRM)：**\n    -   抽取 $M$ 个独立的候选反应时间 $T_{\\mu} \\sim \\mathrm{Exp}(a_{\\mu})$。\n    -   下一反应为 $I = \\arg\\min_{\\mu} T_{\\mu}$，发生时间为 $\\tau = \\min_{\\mu} T_{\\mu}$。\n-   **精确等价性：** 在精确算术中，这等价于直接法（DM），其中下一反应时间 $\\tau \\sim \\mathrm{Exp}(a_{0})$，反应 $k$ 的概率为 $\\mathbb{P}(I=k) = a_{k}/a_{0}$，与 $\\tau$ 无关。\n-   **基本依据：**\n    1.  该动力学是一个连续时间马尔可夫跳跃过程。\n    2.  给出了独立指数随机变量的性质：最小值服从指数分布，其速率等于各速率之和，且最小值的身份（即哪个变量是最小值）的分布与其速率成正比。\n-   **数值问题：** 当生成的反应时间 $T_i$ 和 $T_j$ 满足 $|T_{i} - T_{j}| \\le \\delta$（对于容差 $\\delta  0$）时，声明通道 $i$ 和 $j$ 之间出现“数值平局”。\n-   **任务：** 分析如何处理此类平局以保持“无偏性”。\n-   **无偏性的定义：** 对于每个 $k$，模拟的下一反应索引 $I$ 的分布等于 $a_{k}/a_{0}$，并且模拟的时间 $\\tau$ 的分布为 $\\mathrm{Exp}(a_{0})$，误差会在 $\\delta \\to 0$ 时消失。\n\n**步骤 2：使用提取的已知条件进行验证**\n问题陈述在科学上和数学上都是合理的。它描述了随机模拟算法实现中一个众所周知且实际存在的问题。所涉及的概念（Gillespie SSA、第一反应法、指数分布）是计算系统生物学和化学物理领域的标准概念。问题提得很好：它为“无偏性”提供了明确的定义，用以评估不同的提议策略（即各个选项）。语言精确客观。该问题未违反任何无效性标准。\n\n**步骤 3：结论与行动**\n问题是**有效的**。将对各选项进行完整的推导和评估。\n\n### 求解推导\n\n问题的核心是确定一个用于反应索引 $I$ 的平局打破规则，该规则能在数值容差 $\\delta \\to 0$ 的极限情况下保持正确的反应概率 $\\mathbb{P}(I=k) = a_k/a_0$。我们来分析两个反应通道 $i$ 和 $j$（倾向分别为 $a_i$ 和 $a_j$）之间出现平局的统计特性。独立的候选时间为 $T_i \\sim \\mathrm{Exp}(a_i)$ 和 $T_j \\sim \\mathrm{Exp}(a_j)$。\n\n在精确算术中，反应 $i$ 在反应 $j$ 之前发生的概率是 $\\mathbb{P}(T_i  T_j) = \\frac{a_i}{a_i+a_j}$。\n使用容差为 $\\delta$ 和平局打破规则 $p_{i|\\text{tie}}$（在 $i$ 和 $j$ 之间出现平局时选择 $i$ 的概率）的 FRM 数值模拟，得出通道 $i$ 的模拟概率为：\n$$ \\mathbb{P}_{\\text{sim}}(I=i) = \\mathbb{P}(T_i  T_j - \\delta) + p_{i|\\text{tie}} \\mathbb{P}(|T_i - T_j| \\le \\delta) $$\n通道 $i$ 的总误差（偏差）为 $\\epsilon_i(\\delta) = \\mathbb{P}_{\\text{sim}}(I=i) - \\mathbb{P}(T_i  T_j)$。\n由于 $\\mathbb{P}(T_i  T_j) = \\mathbb{P}(T_i  T_j - \\delta) + \\mathbb{P}(T_j - \\delta \\le T_i  T_j)$，误差为：\n$$ \\epsilon_i(\\delta) = p_{i|\\text{tie}} \\mathbb{P}(|T_i - T_j| \\le \\delta) - \\mathbb{P}(T_j - \\delta \\le T_i  T_j) $$\n一个理想的规则会将此误差设为零，这意味着选择 $p_{i|\\text{tie}}$ 为精确的条件概率：\n$$ p_{i|\\text{tie}}^{\\text{ideal}} = \\frac{\\mathbb{P}(T_j - \\delta \\le T_i  T_j)}{\\mathbb{P}(|T_i - T_j| \\le \\delta)} = \\mathbb{P}(T_i  T_j \\mid |T_i - T_j| \\le \\delta) $$\n为了计算这些概率，我们可以求出差值 $V = T_i - T_j$ 的概率密度函数。对于独立的指数分布，这是一个非对称拉普拉斯分布：\n$$ f_V(v) = \\begin{cases} \\frac{a_i a_j}{a_i+a_j} e^{-a_i v}  \\text{若 } v > 0 \\\\ \\frac{a_i a_j}{a_i+a_j} e^{a_j v}  \\text{若 } v \\le 0 \\end{cases} $$\n利用这个，我们可以计算所需的概率：\n-   $\\mathbb{P}(T_j - \\delta \\le T_i  T_j) = \\mathbb{P}(-\\delta \\le V  0) = \\int_{-\\delta}^{0} f_V(v) dv = \\frac{a_i}{a_i+a_j}(1 - e^{-a_j \\delta})$。\n-   $\\mathbb{P}(T_i - \\delta \\le T_j  T_i) = \\mathbb{P}(0  V \\le \\delta) = \\int_{0}^{\\delta} f_V(v) dv = \\frac{a_j}{a_i+a_j}(1 - e^{-a_i \\delta})$。\n-   $\\mathbb{P}(|T_i - T_j| \\le \\delta) = \\mathbb{P}(-\\delta \\le V \\le \\delta) = \\frac{a_i}{a_i+a_j}(1 - e^{-a_j \\delta}) + \\frac{a_j}{a_i+a_j}(1 - e^{-a_i \\delta})$。\n\n对于小的 $\\delta > 0$，使用泰勒展开 $e^{-x} \\approx 1 - x + x^2/2$，这些概率近似为：\n-   $\\mathbb{P}(-\\delta \\le V  0) \\approx \\frac{a_i a_j \\delta}{a_i+a_j} - \\frac{a_i a_j^2 \\delta^2}{2(a_i+a_j)}$。\n-   $\\mathbb{P}(0  V \\le \\delta) \\approx \\frac{a_j a_i \\delta}{a_i+a_j} - \\frac{a_j a_i^2 \\delta^2}{2(a_i+a_j)}$。\n-   $\\mathbb{P}(|V| \\le \\delta) \\approx \\frac{2 a_i a_j \\delta}{a_i+a_j} - \\frac{a_i a_j(a_i+a_j) \\delta^2}{2(a_i+a_j)} = \\frac{2 a_i a_j \\delta}{a_i+a_j} + O(\\delta^2)$。这个概率是 $O(\\delta)$ 阶的。\n\n现在我们可以分析每个选项。\n\n**A. 因为对于独立的指数变量，精确概率 $\\mathbb{P}(T_{i} = T_{j}) = 0$，所以任何确定性的平局打破规则（例如，总是选择较小的索引）都是无偏的，即使在使用非零容差 $\\delta$ 时也是如此。**\n\n这个规则是确定性的。假设在 $i$ 和 $j$ 之间出现平局时，我们总是选择 $i$。那么 $p_{i|\\text{tie}} = 1$。误差为：\n$ \\epsilon_i(\\delta) = 1 \\cdot \\mathbb{P}(|V| \\le \\delta) - \\mathbb{P}(-\\delta \\le V  0) = \\mathbb{P}(0  V \\le \\delta) $。\n使用我们的近似，$\\epsilon_i(\\delta) \\approx \\frac{a_i a_j \\delta}{a_i+a_j}$。这个误差是 $O(\\delta)$ 阶的。只有当 $\\delta=0$（或者其中一个倾向为零）时，误差才为零。该规则“即使在使用非零容差 $\\delta$ 时也是无偏的”这一说法是错误的。所提供的理由（$\\mathbb{P}(T_i=T_j)=0$）对于精确数学是正确的，但与有限容差 $\\delta  0$ 的问题无关，因为有限容差将平局定义为一个具有非零概率的事件。\n**结论：错误。**\n\n**B. 如果 $|T_{i} - T_{j}| \\le \\delta$，那么在出现平局的通道中均匀随机地选择索引，并设置 $\\tau = \\min\\{T_{i}, T_{j}\\}$，可以在 $\\delta \\to 0$ 的极限情况下保持 $I$ 和 $\\tau$ 的无偏性，并在有限的 $\\delta$ 下产生 $O(\\delta)$ 的误差。**\n\n这个规则设置 $p_{i|\\text{tie}} = 1/2$。误差为：\n$$ \\epsilon_i(\\delta) = \\frac{1}{2} \\mathbb{P}(|V| \\le \\delta) - \\mathbb{P}(-\\delta \\le V  0) = \\frac{1}{2} [\\mathbb{P}(0  V \\le \\delta) - \\mathbb{P}(-\\delta \\le V  0)] $$\n使用泰勒展开：\n$$ \\epsilon_i(\\delta) \\approx \\frac{1}{2} \\left[ \\left(\\frac{a_i a_j \\delta}{a_i+a_j} - \\frac{a_j a_i^2 \\delta^2}{2(a_i+a_j)}\\right) - \\left(\\frac{a_i a_j \\delta}{a_i+a_j} - \\frac{a_i a_j^2 \\delta^2}{2(a_i+a_j)}\\right) \\right] $$\n$$ \\epsilon_i(\\delta) \\approx \\frac{a_i a_j \\delta^2}{4(a_i+a_j)} (a_j - a_i) $$\n主导误差项是 $O(\\delta^2)$ 阶的。由于误差在 $\\delta \\to 0$ 时消失（且比其他规则消失得更快），该规则“在极限情况下...保持无偏性”。一个 $O(\\delta^2)$ 的误差是 $O(\\delta)$ 误差的子集，因此声称它“产生 $O(\\delta)$ 的误差”是一个正确但不紧密的上界。关于时间 $\\tau$，真实的下一事件时间是 $\\min_{\\mu} T_{\\mu}$。在涉及 $i$ 和 $j$ 的平局情况下，这两个是采样的最小时间，因此将模拟时间设置为 $\\min\\{T_i, T_j\\}$ 是正确的程序。因此，模拟时间 $\\tau$ 的分布在极限情况下将是正确的。该选项中的所有论断因此都是合理的。\n**结论：正确。**\n\n**C. 如果 $|T_{i} - T_{j}| \\le \\delta$，那么在出现平局的通道中总是选择具有较大倾向的反应可以避免偏差，因为该反应更可能是真正的最小值。**\n\n这是一个确定性规则，与选项 A 类似。假设 $a_i  a_j$；那么我们总是选择 $i$，所以 $p_{i|\\text{tie}}=1$。误差为 $\\epsilon_i(\\delta) = \\mathbb{P}(0  V \\le \\delta) \\approx \\frac{a_i a_j \\delta}{a_i+a_j}$，这是 $O(\\delta)$ 阶的。这个规则并不能“避免偏差”。虽然具有较高倾向的通道在平局区域内确实更可能是真正的最小值（因为如果 $a_i  a_j$，则 $p_{i|ij}^{\\text{ideal}}  1/2$），但将其概率设置为 1 是一种过度修正，会引入一个 $O(\\delta)$ 阶的系统性偏差。\n**结论：错误。**\n\n**D. 如果 $|T_{i} - T_{j}| \\le \\delta$，那么以与其倾向成正比的概率在出现平局的通道之间进行选择，即以概率 $a_{i}/(a_{i}+a_{j})$ 选择反应 $i$，可以保证在平局条件下的无偏性，因此也能保证整体的无偏性。**\n\n这个规则设置 $p_{i|\\text{tie}} = \\frac{a_i}{a_i+a_j}$。误差为：\n$$ \\epsilon_i(\\delta) = \\frac{a_i}{a_i+a_j} \\mathbb{P}(|V| \\le \\delta) - \\mathbb{P}(-\\delta \\le V  0) $$\n$$ \\epsilon_i(\\delta) = \\frac{a_i}{a_i+a_j} \\mathbb{P}(0  V \\le \\delta) - \\frac{a_j}{a_i+a_j} \\mathbb{P}(-\\delta \\le V  0) $$\n使用我们的近似：\n$$ \\epsilon_i(\\delta) \\approx \\frac{a_i}{a_i+a_j} \\left(\\frac{a_i a_j \\delta}{a_i+a_j}\\right) - \\frac{a_j}{a_i+a_j} \\left(\\frac{a_i a_j \\delta}{a_i+a_j}\\right) = \\frac{a_i a_j (a_i-a_j)}{(a_i+a_j)^2} \\delta $$\n这个误差是 $O(\\delta)$ 阶的。该规则“保证在平局条件下的无偏性”这一说法是错误的。正确的条件概率 $p_{i|ij}^{\\text{ideal}}$ 不等于无条件的获胜概率 $a_i/(a_i+a_j)$。后者是一个常见但错误的平局打破规则选择。\n**结论：错误。**",
            "answer": "$$\\boxed{B}$$"
        }
    ]
}