{
    "hands_on_practices": [
        {
            "introduction": "我们的第一个练习探讨了模拟随机微分方程最直接的方法：欧拉-丸山（Euler-Maruyama）法。虽然这种方法实现简单，但它可能会产生令人意外的行为。这个问题  要求你为几何布朗运动（GBM）推导该格式，然后计算一个非物理结果的概率——即一个正值过程变为负值——从而突显出这种基本数值技术的一个关键局限性。",
            "id": "3342006",
            "problem": "考虑一个由标准布朗运动 $W_{t}$ 驱动的正值过程 $S_{t}$ 的随机微分方程 (SDE)，\n$$\ndS_{t}=\\mu S_{t}\\,dt+\\sigma S_{t}\\,dW_{t},\n$$\n其中 $\\mu\\in\\mathbb{R}$ 和 $\\sigma>0$ 是常数。您的目标是使用欧拉–丸山方法，在固定步长 $\\Delta t>0$ 的均匀时间网格 $t_{n}=n\\,\\Delta t$ 上模拟此过程。假设布朗增量近似为 $W_{t_{n+1}}-W_{t_{n}}=\\sqrt{\\Delta t}\\,Z_{n}$，其中 $Z_{n}$ 是独立同分布的标准正态随机变量。\n\n从 SDE 以及布朗运动及其增量的定义出发，推导用 $S_{n}$、$\\mu$、$\\sigma$、$\\Delta t$ 和 $Z_{n}$ 表示的 $S_{n+1}$ 的单步欧拉–丸山更新规则。然后，在 $S_{n}>0$ 的条件下，推导此欧拉–丸山格式产生的下一步为负值的概率的闭式解析表达式，即给定 $S_{n}>0$ 时 $S_{n+1}<0$ 的概率。该表达式需用标准正态累积分布函数表示。\n\n您的最终答案必须是单个闭式解析表达式。不要提供数值近似，也不要使用百分号。如果您在推导中引入任何命名函数，请明确定义它。",
            "solution": "所给问题要求推导几何布朗运动过程的单步欧拉-丸山更新规则，并随后推导在给定正初值的情况下，此数值格式单步计算结果为负值的概率的闭式表达式。\n\n过程 $S_t$ 的随机微分方程 (SDE) 如下：\n$$\ndS_{t}=\\mu S_{t}\\,dt+\\sigma S_{t}\\,dW_{t}\n$$\n其中 $S_t>0$，$\\mu$ 是代表漂移的实常数，$\\sigma>0$ 是代表波动率的常数，而 $W_t$ 是标准布朗运动。\n\n首先，我们推导单步欧拉–丸山更新规则。该数值格式在离散时间网格 $t_n = n \\Delta t$ 上近似 SDE 的解。为了得到从 $S_n = S_{t_n}$ 到 $S_{n+1} = S_{t_{n+1}}$ 的更新，我们考虑 SDE 在时间区间 $[t_n, t_{n+1}]$ 上的积分形式：\n$$\nS_{t_{n+1}} - S_{t_n} = \\int_{t_n}^{t_{n+1}} \\mu S_t \\, dt + \\int_{t_n}^{t_{n+1}} \\sigma S_t \\, dW_t\n$$\n欧拉–丸山方法用被积函数在区间起点 $t_n$ 的值来近似它。也就是说，对于 $t \\in [t_n, t_{n+1}]$，我们近似 $S_t \\approx S_{t_n} = S_n$。方程变为：\n$$\nS_{n+1} - S_n \\approx \\mu S_n \\int_{t_n}^{t_{n+1}} dt + \\sigma S_n \\int_{t_n}^{t_{n+1}} dW_t\n$$\n积分计算结果为：\n$$\n\\int_{t_n}^{t_{n+1}} dt = t_{n+1} - t_n = \\Delta t\n$$\n$$\n\\int_{t_n}^{t_{n+1}} dW_t = W_{t_{n+1}} - W_{t_n}\n$$\n问题陈述布朗增量 $W_{t_{n+1}}-W_{t_{n}}$ 被建模为 $\\sqrt{\\Delta t}\\,Z_{n}$，其中 $Z_n$ 是独立同分布的标准正态随机变量，$Z_n \\sim N(0, 1)$。代入这些结果，欧拉-丸山离散化形式为：\n$$\nS_{n+1} - S_n = \\mu S_n \\Delta t + \\sigma S_n \\sqrt{\\Delta t} Z_n\n$$\n重新整理以求解 $S_{n+1}$，得到单步更新规则：\n$$\nS_{n+1} = S_n + \\mu S_n \\Delta t + \\sigma S_n \\sqrt{\\Delta t} Z_n = S_n (1 + \\mu \\Delta t + \\sigma \\sqrt{\\Delta t} Z_n)\n$$\n这完成了推导的第一部分。\n\n接下来，我们推导在当前步 $S_n$ 为正的条件下，下一步 $S_{n+1}$ 为负的概率。我们想要求解概率 $P(S_{n+1}  0 | S_n  0)$。\n使用上面推导的更新规则，条件 $S_{n+1}  0$ 可转化为：\n$$\nS_n (1 + \\mu \\Delta t + \\sigma \\sqrt{\\Delta t} Z_n)  0\n$$\n给定条件 $S_n  0$，我们可以在不等式两边同除以 $S_n$ 而不改变不等号的方向：\n$$\n1 + \\mu \\Delta t + \\sigma \\sqrt{\\Delta t} Z_n  0\n$$\n现在，我们必须分离出随机变量 $Z_n$ 以确定其取值所需满足的条件。\n$$\n\\sigma \\sqrt{\\Delta t} Z_n  -(1 + \\mu \\Delta t)\n$$\n因为给定 $\\sigma  0$ 和 $\\Delta t  0$，所以系数 $\\sigma\\sqrt{\\Delta t}$ 为正。我们可以用它来除不等式两边而不改变不等号的方向：\n$$\nZ_n  -\\frac{1 + \\mu \\Delta t}{\\sigma \\sqrt{\\Delta t}}\n$$\n我们所求的概率即为标准正态随机变量 $Z_n$ 小于此特定值的概率。这个概率由标准正态分布的累积分布函数 (CDF) 给出，我们将其表示为 $\\Phi(x)$。函数 $\\Phi(x)$ 定义为标准正态变量 $Z \\sim N(0,1)$ 小于或等于 $x$ 的概率：\n$$\n\\Phi(x) = P(Z \\le x) = \\int_{-\\infty}^{x} \\frac{1}{\\sqrt{2\\pi}} \\exp\\left(-\\frac{z^2}{2}\\right) dz\n$$\n因此，给定 $S_n  0$ 时 $S_{n+1}  0$ 的概率为：\n$$\nP(S_{n+1}  0 | S_n  0) = P\\left(Z_n  -\\frac{1 + \\mu \\Delta t}{\\sigma \\sqrt{\\Delta t}}\\right) = \\Phi\\left(-\\frac{1 + \\mu \\Delta t}{\\sigma \\sqrt{\\Delta t}}\\right)\n$$\n这就得到了使用欧拉-丸山格式时，过程在一步内变为负值的概率所需的闭式解析表达式。值得注意的是，该 SDE 的真实解 $S_t = S_0 \\exp\\left((\\mu - \\sigma^2/2)t + \\sigma W_t\\right)$，在 $S_00$ 时恒为正。$S_{n+1}0$ 的可能性是这种特定数值离散化方法所产生的人为结果。",
            "answer": "$$\n\\boxed{\\Phi\\left(-\\frac{1 + \\mu \\Delta t}{\\sigma \\sqrt{\\Delta t}}\\right)}\n$$"
        },
        {
            "introduction": "鉴于欧拉-丸山格式可能存在问题，我们通常更倾向于使用几何布朗运动的精确模拟方法，该方法可以避免时间离散化误差。在此基础上，我们的下一个练习  深入研究了一种名为“共同随机数”（Common Random Numbers, CRN）的强大方差缩减技术。你将把此方法应用于两个期权价格差异的实际问题中，并分析在不同模拟中同步随机性如何能显著提高蒙特卡洛估计器的效率。",
            "id": "3341965",
            "problem": "要求您设计、分析并实现一个蒙特卡洛估计量，用于在几何布朗运动 (GBM) 模型下计算两种欧式看涨期权的价格差异，并使用公共随机数 (CRN) 方法来减少方差。标的资产价格过程被建模为几何布朗运动 (GBM)，其随机微分方程 (SDE) 如下\n$$\ndS_t = \\mu S_t \\, dt + \\sigma S_t \\, dB_t,\n$$\n其中 $S_t$ 是时间 $t$ 的资产价格，$\\mu$ 是漂移项，$\\sigma$ 是波动率，$B_t$ 是标准维纳过程。目标量是在固定期限 $T$ 时两种期望收益的差值，即\n$$\n\\Delta P = \\mathbb{E}\\big[(S_T - K_1)^+\\big] - \\mathbb{E}\\big[(S_T - K_2)^+\\big],\n$$\n对于两个执行价格 $K_1$ 和 $K_2$，其中 $(x)^+ = \\max\\{x,0\\}$。\n\n从 SDE 定义和维纳过程的性质出发，推导出一个不依赖于时间离散化的 $S_T$ 的精确时间模拟方案。然后，设计一个使用公共随机数 (CRN) 的蒙特卡洛 (MC) 估计量来计算 $\\Delta P$，这意味着对于每个模拟的终端抽样，您必须使用相同的底层随机性来评估两种收益 $(S_T - K_1)^+$ 和 $(S_T - K_2)^+$。从第一性原理以及方差和协方差的性质出发，推导出在 CRN 方法下和在基准“独立流”方法下估计量的方差形式，其中“独立流”方法是指两种期权收益在总收益评估次数相同的情况下被独立模拟。利用此结果获得方差缩减因子的经验估计值。\n\n您的程序必须：\n- 实现 GBM 下 $S_T$ 的精确模拟。\n- 对于每个测试用例，构建：\n  - 一个 $\\Delta P$ 的 CRN 估计量，使用 $n$ 次独立的终端冲击抽样，并在每次抽样上评估两种收益。\n  - CRN 下每条路径方差的经验估计值，$\\widehat{\\mathrm{Var}}_{\\mathrm{CRN}} = \\widehat{\\mathrm{Var}}\\big((S_T - K_1)^+ - (S_T - K_2)^+\\big)$。\n  - 独立流下每条路径方差的经验估计值，$\\widehat{\\mathrm{Var}}_{\\mathrm{ind}} = \\widehat{\\mathrm{Var}}\\big((S_T - K_1)^+\\big) + \\widehat{\\mathrm{Var}}\\big((S_T - K_2)^+\\big)$，该估计值应从相同的模拟终端值中得出，以使总收益评估次数相匹配。\n  - 经验方差缩减因子 $R = \\widehat{\\mathrm{Var}}_{\\mathrm{ind}} / \\widehat{\\mathrm{Var}}_{\\mathrm{CRN}}$。\n  - 两种收益之间的经验相关系数，$\\widehat{\\rho} \\in [-1,1]$。\n- 在每个测试用例中为伪随机数生成器使用固定的种子，以确保可复现性。\n\n测试套件：\n- 案例 1：$S_0 = 100$, $\\mu = 0.03$, $\\sigma = 0.2$, $T = 1$, $K_1 = 90$, $K_2 = 110$, $n = 200000$, 种子 $= 1729$。\n- 案例 2：$S_0 = 100$, $\\mu = 0.03$, $\\sigma = 0.2$, $T = 1$, $K_1 = 100$, $K_2 = 100.001$, $n = 300000$, 种子 $= 2029$。\n- 案例 3：$S_0 = 100$, $\\mu = 0.0$, $\\sigma = 0.8$, $T = 1$, $K_1 = 100$, $K_2 = 120$, $n = 250000$, 种子 $= 2222$。\n- 案例 4：$S_0 = 100$, $\\mu = 0.03$, $\\sigma = 0.4$, $T = 0.05$, $K_1 = 95$, $K_2 = 105$, $n = 300000$, 种子 $= 3333$。\n\n所有参数都是无量纲的标量。没有物理单位，也没有角度。所有报告的数值结果必须是实数。对于每个测试用例，您的程序必须输出一个包含三个浮点数的列表：\n- $\\Delta P$ 的 CRN 估计值，\n- 方差缩减因子 $R$，\n- 收益相关性估计值 $\\widehat{\\rho}$，\n\n每个值都四舍五入到 $6$ 位小数。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个列表，每个测试用例对应一个条目；每个条目本身应是按上述顺序排列的三元素列表。\n- 例如，整个打印出的对象应如下所示\n$$\n[\\,[\\delta_1, R_1, \\rho_1], [\\delta_2, R_2, \\rho_2], [\\delta_3, R_3, \\rho_3], [\\delta_4, R_4, \\rho_4]\\,],\n$$\n其中每个 $\\delta_i$、$R_i$ 和 $\\rho_i$ 都打印到 $6$ 位小数。",
            "solution": "用户提供了一个计算金融学中定义明确的问题。我将首先验证问题陈述，然后提供一个完整的解决方案。\n\n### 第 1 步：提取已知信息\n- **模型**：标的资产价格 $S_t$ 服从几何布朗运动 (GBM)，其随机微分方程 (SDE) 为：\n$$\ndS_t = \\mu S_t \\, dt + \\sigma S_t \\, dB_t\n$$\n其中 $\\mu$ 是漂移项，$\\sigma$ 是波动率，$B_t$ 是标准维纳过程。\n- **目标量**：两个欧式看涨期权的价格差，$\\Delta P = \\mathbb{E}\\big[(S_T - K_1)^+\\big] - \\mathbb{E}\\big[(S_T - K_2)^+\\big]$，其中 $(x)^+ = \\max\\{x,0\\}$，$T$ 是到期时间，$K_1$、$K_2$ 是执行价格。\n- **方法论**：使用公共随机数 (CRN) 进行方差缩减的蒙特卡洛估计量。\n- **要求推导**：\n    1. $S_T$ 的精确时间模拟方案。\n    2. CRN 和独立流下估计量的方差形式。\n- **每个测试用例的所需输出**：\n    1. $\\Delta P$ 的 CRN 估计值。\n    2. 经验方差缩减因子 $R = \\widehat{\\mathrm{Var}}_{\\mathrm{ind}} / \\widehat{\\mathrm{Var}}_{\\mathrm{CRN}}$。\n    3. 收益之间的经验相关系数 $\\widehat{\\rho}$。\n- **经验估计的定义**：\n    - $\\widehat{\\mathrm{Var}}_{\\mathrm{CRN}} = \\widehat{\\mathrm{Var}}\\big((S_T - K_1)^+ - (S_T - K_2)^+\\big)$。\n    - $\\widehat{\\mathrm{Var}}_{\\mathrm{ind}} = \\widehat{\\mathrm{Var}}\\big((S_T - K_1)^+\\big) + \\widehat{\\mathrm{Var}}\\big((S_T - K_2)^+\\big)$。\n- **测试套件**：\n    - 案例 1：$S_0 = 100$, $\\mu = 0.03$, $\\sigma = 0.2$, $T = 1$, $K_1 = 90$, $K_2 = 110$, $n = 200000$, 种子 $= 1729$。\n    - 案例 2：$S_0 = 100$, $\\mu = 0.03$, $\\sigma = 0.2$, $T = 1$, $K_1 = 100$, $K_2 = 100.001$, $n = 300000$, 种子 $= 2029$。\n    - 案例 3：$S_0 = 100$, $\\mu = 0.0$, $\\sigma = 0.8$, $T = 1$, $K_1 = 100$, $K_2 = 120$, $n = 250000$, 种子 $= 2222$。\n    - 案例 4：$S_0 = 100$, $\\mu = 0.03$, $\\sigma = 0.4$, $T = 0.05$, $K_1 = 95$, $K_2 = 105$, $n = 300000$, 种子 $= 3333$。\n- **输出格式**：单行列表的列表，`[[delta_1, R_1, rho_1], [delta_2, R_2, rho_2], ...]`，每个数字打印到 6 位小数。\n\n### 第 2 步：使用提取的已知信息进行验证\n- **科学依据**：该问题基于金融数学中的标准 GBM 模型，并采用标准的蒙特卡洛模拟技术 (CRN)。所有概念都牢固地植根于随机微积分和统计学。\n- **定义明确**：为每个测试用例提供了所有必要的参数（$S_0, \\mu, \\sigma, T, K_1, K_2, n$, 种子）。目标函数和待计算量都有精确定义。可以计算出唯一的数值解。\n- **客观性**：问题是用精确、客观的数学语言陈述的。\n- **结论**：问题有效。它在科学上是合理的，定义明确，客观，完整且不简单。\n\n### 第 3 步：结论与行动\n问题有效。我将继续提供解决方案。\n\n### 基于原理的设计与推导\n\n#### 1. 几何布朗运动的精确模拟方案\n价格过程 $S_t$ 由以下 SDE 控制：\n$$\ndS_t = \\mu S_t \\, dt + \\sigma S_t \\, dB_t\n$$\n为了找到 $S_T$ 的精确解，我们考虑 $\\ln S_t$ 的过程。设 $f(x) = \\ln x$。其前两阶导数为 $f'(x) = 1/x$ 和 $f''(x) = -1/x^2$。根据 Itô 引理，$f(S_t) = \\ln S_t$ 的动态由以下公式给出：\n$$\nd(\\ln S_t) = f'(S_t) dS_t + \\frac{1}{2} f''(S_t) (dS_t)^2\n$$\n根据 Itô 微积分规则，$(dS_t)^2 = (\\mu S_t dt + \\sigma S_t dB_t)^2 = \\sigma^2 S_t^2 dt$，因为含 $dt^2$ 和 $dt \\, dB_t$ 的项为零。代入导数和 $(dS_t)^2$：\n$$\nd(\\ln S_t) = \\frac{1}{S_t} (\\mu S_t dt + \\sigma S_t dB_t) + \\frac{1}{2} \\left(-\\frac{1}{S_t^2}\\right) (\\sigma^2 S_t^2 dt)\n$$\n$$\nd(\\ln S_t) = (\\mu dt + \\sigma dB_t) - \\frac{1}{2} \\sigma^2 dt = \\left(\\mu - \\frac{1}{2}\\sigma^2\\right) dt + \\sigma dB_t\n$$\n这是一个系数为常数的 SDE。我们可以将其从 $t=0$ 积分到 $t=T$：\n$$\n\\int_0^T d(\\ln S_t) = \\int_0^T \\left(\\mu - \\frac{1}{2}\\sigma^2\\right) dt + \\int_0^T \\sigma dB_t\n$$\n$$\n\\ln S_T - \\ln S_0 = \\left(\\mu - \\frac{1}{2}\\sigma^2\\right) T + \\sigma (B_T - B_0)\n$$\n鉴于 $B_0=0$，增量 $B_T$ 是一个服从均值为 $0$、方差为 $T$ 的正态分布的随机变量，即 $B_T \\sim \\mathcal{N}(0, T)$。我们可以写成 $B_T = \\sqrt{T} Z$，其中 $Z \\sim \\mathcal{N}(0, 1)$ 是一个标准正态随机变量。\n对两边取指数，得到 $S_T$ 的精确解：\n$$\nS_T = S_0 \\exp\\left( \\left(\\mu - \\frac{1}{2}\\sigma^2\\right) T + \\sigma \\sqrt{T} Z \\right)\n$$\n此公式提供了一个“精确时间”模拟方案，因为它允许我们直接从其已知分布中抽取终端价格 $S_T$ 的样本，而无需对时间区间 $[0, T]$ 进行离散化。\n\n#### 2. 蒙特卡洛估计与方差缩减\n设 $Y_1 = (S_T - K_1)^+$ 和 $Y_2 = (S_T - K_2)^+$ 为两个看涨期权的收益。我们感兴趣的量是 $\\Delta P = \\mathbb{E}[Y_1] - \\mathbb{E}[Y_2] = \\mathbb{E}[Y_1 - Y_2]$。\n\n**公共随机数 (CRN) 估计量**\nCRN 技术涉及使用相同的随机数流来模拟要比较的两个量。对于 $n$ 次蒙特卡洛试验中的每一次，我们生成一个独立的标准正态随机变量 $Z_i$，其中 $i=1, \\dots, n$。然后，我们使用上面推导的方案计算单个终端价格 $S_{T,i}$。从这个单一的 $S_{T,i}$，我们评估两种收益，$Y_{1,i} = (S_{T,i} - K_1)^+$ 和 $Y_{2,i} = (S_{T,i} - K_2)^+$。$\\Delta P$ 的 CRN 估计量是差值的样本均值：\n$$\n\\widehat{\\Delta P}_{\\mathrm{CRN}} = \\frac{1}{n} \\sum_{i=1}^n (Y_{1,i} - Y_{2,i})\n$$\n此估计量的方差由下式给出：\n$$\n\\mathrm{Var}(\\widehat{\\Delta P}_{\\mathrm{CRN}}) = \\frac{1}{n} \\mathrm{Var}(Y_1 - Y_2)\n$$\n$\\mathrm{Var}_{\\mathrm{CRN}} \\equiv \\mathrm{Var}(Y_1 - Y_2)$ 项是 CRN 下的每路径方差。\n\n**基准独立流估计量**\n作为比较，考虑一个独立估计 $\\mathbb{E}[Y_1]$ 和 $\\mathbb{E}[Y_2]$ 的估计量。为了与 CRN 方法中使用的总共 $2n$ 次收益评估相匹配，需要为 $Y_1$ 使用 $n$ 条独立路径，为 $Y_2$ 使用另外 $n$ 条独立路径。该估计量将是 $\\widehat{\\Delta P}_{\\mathrm{ind}} = \\frac{1}{n}\\sum_{i=1}^n Y_{1,i} - \\frac{1}{n}\\sum_{j=1}^n Y'_{2,j}$，其中 $Y'$ 基于独立的模拟。该估计量的方差为：\n$$\n\\mathrm{Var}(\\widehat{\\Delta P}_{\\mathrm{ind}}) = \\mathrm{Var}\\left(\\frac{1}{n}\\sum_{i=1}^n Y_{1,i}\\right) + \\mathrm{Var}\\left(\\frac{1}{n}\\sum_{j=1}^n Y'_{2,j}\\right) = \\frac{1}{n}\\mathrm{Var}(Y_1) + \\frac{1}{n}\\mathrm{Var}(Y_2)\n$$\n相应的每路径方差为 $\\mathrm{Var}_{\\mathrm{ind}} \\equiv \\mathrm{Var}(Y_1) + \\mathrm{Var}(Y_2)$。\n\n**方差分析与缩减因子**\n使用属性 $\\mathrm{Var}(X-Y) = \\mathrm{Var}(X) + \\mathrm{Var}(Y) - 2\\mathrm{Cov}(X,Y)$，我们可以将两种方差关联起来：\n$$\n\\mathrm{Var}_{\\mathrm{CRN}} = \\mathrm{Var}_{\\mathrm{ind}} - 2\\mathrm{Cov}(Y_1, Y_2)\n$$\n收益函数 $Y_1 = \\max(S_T - K_1, 0)$ 和 $Y_2 = \\max(S_T - K_2, 0)$ 都是同一基础随机变量 $S_T$ 的非递减函数。因此，$Y_1$ 和 $Y_2$ 是正相关的，即 $\\mathrm{Cov}(Y_1, Y_2)  0$。这意味着 $\\mathrm{Var}_{\\mathrm{CRN}}  \\mathrm{Var}_{\\mathrm{ind}}$，所以 CRN 实现了方差缩减。\n\n方差缩减因子是每路径方差之比：\n$$\nR = \\frac{\\mathrm{Var}_{\\mathrm{ind}}}{\\mathrm{Var}_{\\mathrm{CRN}}} = \\frac{\\mathrm{Var}(Y_1) + \\mathrm{Var}(Y_2)}{\\mathrm{Var}(Y_1 - Y_2)}\n$$\n$R  1$ 的值表示 CRN 是有效的。\n\n**经验量**\n在实践中，我们从模拟样本中计算经验估计值。给定使用 CRN 生成的 $n$ 对收益 $\\{(Y_{1,i}, Y_{2,i})\\}_{i=1}^n$：\n- $\\Delta P$ 的估计值为 $\\widehat{\\Delta P} = \\bar{Y}_1 - \\bar{Y}_2$，其中 $\\bar{Y}_k = \\frac{1}{n}\\sum_{i=1}^n Y_{k,i}$。\n- 经验每路径 CRN 方差是差值的样本方差：\n$\\widehat{\\mathrm{Var}}_{\\mathrm{CRN}} = \\widehat{\\mathrm{Var}}(Y_1 - Y_2) = \\frac{1}{n-1}\\sum_{i=1}^n \\left( (Y_{1,i}-Y_{2,i}) - (\\bar{Y}_1 - \\bar{Y}_2) \\right)^2$。\n- 经验每路径独立方差是各个样本方差之和：\n$\\widehat{\\mathrm{Var}}_{\\mathrm{ind}} = \\widehat{\\mathrm{Var}}(Y_1) + \\widehat{\\mathrm{Var}}(Y_2)$，其中 $\\widehat{\\mathrm{Var}}(Y_k) = \\frac{1}{n-1}\\sum_{i=1}^n (Y_{k,i} - \\bar{Y}_k)^2$。\n- 经验方差缩减因子为 $R = \\widehat{\\mathrm{Var}}_{\\mathrm{ind}} / \\widehat{\\mathrm{Var}}_{\\mathrm{CRN}}$。\n- 经验相关系数计算如下：\n$$\n\\widehat{\\rho} = \\frac{\\widehat{\\mathrm{Cov}}(Y_1, Y_2)}{\\sqrt{\\widehat{\\mathrm{Var}}(Y_1) \\widehat{\\mathrm{Var}}(Y_2)}}\n$$\n其中 $\\widehat{\\mathrm{Cov}}(Y_1, Y_2) = \\frac{1}{n-1}\\sum_{i=1}^n (Y_{1,i} - \\bar{Y}_1)(Y_{2,i} - \\bar{Y}_2)$。\n\n#### 3. 算法实现\n对于每个具有参数 $S_0, \\mu, \\sigma, T, K_1, K_2, n, \\text{seed}$ 的测试用例：\n1. 使用指定的种子初始化伪随机数生成器。\n2. 生成一个包含 $n$ 个独立标准正态随机变量 $Z_i \\sim \\mathcal{N}(0, 1)$ 的向量。\n3. 使用精确公式计算一个包含 $n$ 个终端股票价格 $S_{T,i}$ 的向量：$S_{T,i} = S_0 \\exp\\left( (\\mu - 0.5\\sigma^2)T + \\sigma\\sqrt{T}Z_i \\right)$。\n4. 计算两个收益向量，$Y_{1,i} = \\max(S_{T,i} - K_1, 0)$ 和 $Y_{2,i} = \\max(S_{T,i} - K_2, 0)$。\n5. 计算收益差向量，$\\Delta_i = Y_{1,i} - Y_{2,i}$。\n6. 计算价格差的 CRN 估计值：$\\widehat{\\Delta P} = \\mathrm{mean}(\\Delta_i)$。\n7. 计算经验方差：\n    - $\\widehat{\\mathrm{Var}}_{\\mathrm{CRN}} = \\mathrm{var}(\\Delta_i, \\text{ddof}=1)$。\n    - $\\widehat{\\mathrm{Var}}(Y_1) = \\mathrm{var}(Y_{1,i}, \\text{ddof}=1)$。\n    - $\\widehat{\\mathrm{Var}}(Y_2) = \\mathrm{var}(Y_{2,i}, \\text{ddof}=1)$。\n    - $\\widehat{\\mathrm{Var}}_{\\mathrm{ind}} = \\widehat{\\mathrm{Var}}(Y_1) + \\widehat{\\mathrm{Var}}(Y_2)$。\n8. 计算经验方差缩减因子 $R = \\widehat{\\mathrm{Var}}_{\\mathrm{ind}} / \\widehat{\\mathrm{Var}}_{\\mathrm{CRN}}$。\n9. 计算经验相关系数 $\\widehat{\\rho} = \\mathrm{corrcoef}(Y_{1,i}, Y_{2,i})$。\n10. 存储当前测试用例的结果 $[\\widehat{\\Delta P}, R, \\widehat{\\rho}]$。\n11. 处理完所有案例后，按规定格式化并打印结果。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Designs, analyzes, and implements a Monte Carlo estimator for the price\n    difference of two European call options under a Geometric Brownian Motion\n    (GBM) model, using Common Random Numbers (CRN) to reduce variance.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (S0, mu, sigma, T, K1, K2, n, seed)\n        (100, 0.03, 0.2, 1, 90, 110, 200000, 1729),\n        (100, 0.03, 0.2, 1, 100, 100.001, 300000, 2029),\n        (100, 0.0, 0.8, 1, 100, 120, 250000, 2222),\n        (100, 0.03, 0.4, 0.05, 95, 105, 300000, 3333),\n    ]\n\n    all_results = []\n    for case in test_cases:\n        S0, mu, sigma, T, K1, K2, n, seed = case\n\n        # 1. Initialize a pseudorandom number generator with the specified seed.\n        # Use default_rng for modern, best-practice random number generation.\n        rng = np.random.default_rng(seed)\n\n        # 2. Generate a vector of n independent standard normal random variates.\n        Z = rng.standard_normal(n)\n\n        # 3. Compute a vector of n terminal stock prices using the exact formula.\n        drift = (mu - 0.5 * sigma**2) * T\n        diffusion = sigma * np.sqrt(T) * Z\n        S_T = S0 * np.exp(drift + diffusion)\n\n        # 4. Compute two vectors of payoffs.\n        Y1 = np.maximum(S_T - K1, 0)\n        Y2 = np.maximum(S_T - K2, 0)\n\n        # 5. Calculate the vector of payoff differences.\n        delta_payoffs = Y1 - Y2\n\n        # 6. Calculate the CRN estimate of the price difference.\n        delta_p_crn = np.mean(delta_payoffs)\n\n        # 7. Calculate the empirical variances. ddof=1 for sample variance.\n        # Per-path variance under CRN\n        var_crn = np.var(delta_payoffs, ddof=1)\n        \n        # Individual payoff variances\n        var_y1 = np.var(Y1, ddof=1)\n        var_y2 = np.var(Y2, ddof=1)\n        \n        # Per-path variance under hypothetical independent streams\n        var_ind = var_y1 + var_y2\n\n        # 8. Calculate the empirical variance reduction factor R.\n        # Check for division by zero, though highly unlikely here.\n        if var_crn > 0:\n            R = var_ind / var_crn\n        else:\n            # This case happens if all payoff differences are identical,\n            # indicating perfect correlation and infinite reduction.\n            # R can be set to infinity or a large number.\n            # For this problem, it's safe to assume var_crn will be positive.\n            R = np.inf\n\n\n        # 9. Calculate the empirical correlation coefficient.\n        # np.corrcoef returns a 2x2 matrix. The off-diagonal element is the correlation.\n        # A check is needed for cases where one variance is zero.\n        if var_y1 > 0 and var_y2 > 0:\n            rho = np.corrcoef(Y1, Y2)[0, 1]\n        else:\n            # If one variance is zero, the payoff is constant (likely 0),\n            # and correlation is undefined. Set to 1 as it's the limit.\n            rho = 1.0\n\n        # 10. Store the results for the current test case.\n        all_results.append([delta_p_crn, R, rho])\n\n    # 11. After processing all cases, format and print the results as specified.\n    # The output format requires printing each number to 6 decimal places.\n    # This must be done via string formatting.\n    output_parts = []\n    for result_group in all_results:\n        # result_group is like [delta, R, rho]\n        formatted_group = [f'{val:.6f}' for val in result_group]\n        output_parts.append(f\"[{', '.join(formatted_group)}]\")\n\n    final_output = f\"[{', '.join(output_parts)}]\"\n    print(final_output)\n\nsolve()\n```"
        },
        {
            "introduction": "对于许多复杂模型，精确模拟是不可行的，这迫使我们依赖于离散化格式。这就提出了一个关键问题：我们如何最佳地分配计算资源？最后一个练习  是对这种权衡的理论探索，要求你分析一个估计器的均方误差，该误差结合了统计误差和离散化偏差，然后推导出在固定预算下最小化此误差的最佳时间步长。",
            "id": "3342009",
            "problem": "考虑由随机微分方程 (SDE) $dS_{t} = \\mu S_{t}\\,dt + \\sigma S_{t}\\,dW_{t}$ 定义的几何布朗运动 (GBM)，其中 $t \\in [0,T]$，初始值 $S_{0}  0$，漂移系数 $\\mu \\in \\mathbb{R}$，波动率系数 $\\sigma  0$，$W_{t}$ 为标准布朗运动。设 $g:\\mathbb{R}_{+}\\to\\mathbb{R}$ 为一个支付函数，其具有至少三阶有界连续导数，且增长速度至多为多项式级别。我们通过模拟 $N$ 条时间离散化近似 $S_{T}^{\\Delta t}$ 的独立路径来构造 $\\mathbb{E}[g(S_{T})]$ 的蒙特卡罗 (MC) 估计量。模拟采用均匀时间步长 $\\Delta t$ 和在所述正则性条件下具有一阶弱收敛阶的单步显式格式。假设 $N$ 足够大且 $\\Delta t$ 足够小，使得估计量的主阶弱时间离散化偏差与 $\\Delta t$ 呈线性关系，且主阶抽样方差与 $N$ 成反比。记弱偏差项的主阶常数为 $A  0$（因此偏差的主阶形式为 $A\\,\\Delta t$），记 $g(S_{T})$ 的极限方差为 $V  0$（因此估计量的方差主阶形式为 $V/N$）。\n\n假设每条路径每个时间步长的计算成本是一个固定常数 $\\kappa  0$，可用的总计算预算为 $\\Lambda  0$。那么预算约束意味着路径总数和步数必须满足 $\\kappa\\,N\\,(T/\\Delta t) = \\Lambda$。在这些假设下：\n\n- 从 GBM SDE 和 $g(S_{T})$ 的 MC 估计量的定义出发，推导该估计量均方误差 (MSE) 的主阶表达式。该表达式应结合弱时间离散化误差和抽样误差，并仅用 $\\Delta t$、常数 $A$、$V$ 以及预算参数 $\\kappa$、$\\Lambda$ 和 $T$ 来表示。\n- 使用此表达式，确定在预算约束下最小化主阶 MSE 的 $\\Delta t$ 的选择。\n\n以 $A$、$V$、$\\kappa$、$\\Lambda$ 和 $T$ 表示的最优时间步长 $\\Delta t$ 的单个闭式解析表达式的形式给出你的最终答案。最终答案中不应代入数值，不应包含中间表达式，也无需单位。",
            "solution": "目标是找到在固定计算预算下，使得 $\\mathbb{E}[g(S_{T})]$ 的蒙特卡罗估计量的均方误差 (MSE) 最小化的最优时间步长 $\\Delta t$。随机过程 $S_t$ 服从几何布朗运动 (GBM)，由随机微分方程 (SDE) $dS_{t} = \\mu S_{t}\\,dt + \\sigma S_{t}\\,dW_{t}$ 描述。\n\n设 $I = \\mathbb{E}[g(S_{T})]$ 为我们关心的量。基于 $N$ 条时间步长为 $\\Delta t$ 的时间离散化近似 $S_{T}^{\\Delta t}$ 的独立模拟路径，蒙特卡罗估计量由下式给出：\n$$\n\\hat{I}_{N, \\Delta t} = \\frac{1}{N} \\sum_{i=1}^{N} g(S_{T,i}^{\\Delta t})\n$$\n其中，$S_{T,i}^{\\Delta t}$（$i=1, \\dots, N$）是代表在时间 $T$ 模拟的资产价格的独立同分布随机变量。\n\n该估计量的均方误差 (MSE) 定义为 $\\text{MSE} = \\mathbb{E}[(\\hat{I}_{N, \\Delta t} - I)^2]$。MSE 可以分解为偏差的平方和估计量的方差：\n$$\n\\text{MSE} = \\left(\\mathbb{E}[\\hat{I}_{N, \\Delta t}] - I\\right)^2 + \\text{Var}(\\hat{I}_{N, \\Delta t})\n$$\n\n让我们逐项分析。估计量的偏差为：\n$$\n\\text{Bias} = \\mathbb{E}[\\hat{I}_{N, \\Delta t}] - I = \\mathbb{E}\\left[\\frac{1}{N} \\sum_{i=1}^{N} g(S_{T,i}^{\\Delta t})\\right] - \\mathbb{E}[g(S_T)]\n$$\n由于路径是同分布的，$\\mathbb{E}[g(S_{T,i}^{\\Delta t})]$ 对所有 $i$ 都是相同的。我们将其记为 $\\mathbb{E}[g(S_{T}^{\\Delta t})]$。\n$$\n\\text{Bias} = \\mathbb{E}[g(S_{T}^{\\Delta t})] - \\mathbb{E}[g(S_T)]\n$$\n这就是数值格式的弱时间离散化误差。题目说明，使用的是一阶弱收敛阶的单步显式格式，对于小的 $\\Delta t$，其主阶偏差为 $A\\,\\Delta t$，其中 $A  0$ 是一个常数。因此，在我们的主阶分析中，我们有：\n$$\n\\text{Bias} \\approx A\\,\\Delta t\n$$\n\n估计量的方差为：\n$$\n\\text{Var}(\\hat{I}_{N, \\Delta t}) = \\text{Var}\\left(\\frac{1}{N} \\sum_{i=1}^{N} g(S_{T,i}^{\\Delta t})\\right)\n$$\n由于路径是独立的，和的方差等于方差的和：\n$$\n\\text{Var}(\\hat{I}_{N, \\Delta t}) = \\frac{1}{N^2} \\sum_{i=1}^{N} \\text{Var}(g(S_{T,i}^{\\Delta t})) = \\frac{N}{N^2} \\text{Var}(g(S_{T}^{\\Delta t})) = \\frac{1}{N} \\text{Var}(g(S_{T}^{\\Delta t}))\n$$\n题目说明，对于小的 $\\Delta t$，模拟量的方差趋近于真实方差 $V = \\text{Var}(g(S_T))  0$。因此，主阶抽样方差为：\n$$\n\\text{Variance} \\approx \\frac{V}{N}\n$$\n\n结合这两个部分，MSE 的主阶表达式为：\n$$\n\\text{MSE}(\\Delta t, N) \\approx (A\\,\\Delta t)^2 + \\frac{V}{N} = A^2 (\\Delta t)^2 + \\frac{V}{N}\n$$\n这就完成了推导的第一部分，但该表达式仍然依赖于两个变量 $\\Delta t$ 和 $N$，它们通过预算约束联系在一起。\n\n总计算预算为 $\\Lambda  0$。每条路径每个时间步长的成本为 $\\kappa  0$。模拟一条路径直到时间 $T$ 所需的时间步数为 $T/\\Delta t$。因此，$N$ 条路径的总成本为 $\\kappa \\cdot N \\cdot (T/\\Delta t)$。预算约束为：\n$$\n\\kappa N \\frac{T}{\\Delta t} = \\Lambda\n$$\n我们需要仅用 $\\Delta t$ 和给定的常数来表示 MSE。我们对预算约束求解 $N$：\n$$\nN = \\frac{\\Lambda \\Delta t}{\\kappa T}\n$$\n现在，将 $N$ 的这个表达式代入 MSE 公式：\n$$\n\\text{MSE}(\\Delta t) \\approx A^2 (\\Delta t)^2 + \\frac{V}{\\frac{\\Lambda \\Delta t}{\\kappa T}} = A^2 (\\Delta t)^2 + \\frac{V \\kappa T}{\\Lambda \\Delta t}\n$$\n这就是所要求的 MSE 作为 $\\Delta t$ 函数的主阶表达式。\n\n为了找到最小化此 MSE 的最优时间步长 $\\Delta t$，我们必须找到函数 $f(\\Delta t) = A^2 (\\Delta t)^2 + \\frac{V \\kappa T}{\\Lambda} (\\Delta t)^{-1}$ 在 $\\Delta t  0$ 时的最小值。我们计算其关于 $\\Delta t$ 的一阶导数并令其为零。为方便求导，我们用 $x$ 作为 $\\Delta t$ 的占位符。\n$$\n\\frac{df}{dx} = \\frac{d}{dx} \\left( A^2 x^2 + \\frac{V \\kappa T}{\\Lambda} x^{-1} \\right) = 2 A^2 x - \\frac{V \\kappa T}{\\Lambda} x^{-2}\n$$\n将导数设为零以找到临界点：\n$$\n2 A^2 x - \\frac{V \\kappa T}{\\Lambda x^2} = 0\n$$\n$$\n2 A^2 x = \\frac{V \\kappa T}{\\Lambda x^2}\n$$\n两边乘以 $x^2$（因为 $x=\\Delta t  0$，我们知道 $x \\neq 0$）：\n$$\n2 A^2 x^3 = \\frac{V \\kappa T}{\\Lambda}\n$$\n$$\nx^3 = \\frac{V \\kappa T}{2 A^2 \\Lambda}\n$$\n求解 $x$（即我们的最优 $\\Delta t$）：\n$$\n\\Delta t = \\left( \\frac{V \\kappa T}{2 A^2 \\Lambda} \\right)^{1/3}\n$$\n为了确认这是一个最小值，我们检查二阶导数：\n$$\n\\frac{d^2f}{dx^2} = \\frac{d}{dx} \\left( 2 A^2 x - \\frac{V \\kappa T}{\\Lambda} x^{-2} \\right) = 2 A^2 + 2 \\frac{V \\kappa T}{\\Lambda} x^{-3}\n$$\n题目规定 $A  0, V  0, \\kappa  0, T  0, \\Lambda  0$。同时，$\\Delta t$ 必须为正。因此，二阶导数中的每一项都是正的，这意味着 $\\frac{d^2f}{d(\\Delta t)^2}  0$。这证实了该临界点对应于一个局部最小值，同时也是 $\\Delta t  0$ 上的全局最小值。\n\n因此，在给定预算约束下，最小化主阶 MSE 的最优时间步长 $\\Delta t$ 的选择是 $\\left( \\frac{V \\kappa T}{2 A^2 \\Lambda} \\right)^{1/3}$。",
            "answer": "$$\\boxed{\\left( \\frac{V \\kappa T}{2 A^{2} \\Lambda} \\right)^{1/3}}$$"
        }
    ]
}