{
    "hands_on_practices": [
        {
            "introduction": "为了掌握完美模拟，我们必须首先理解其核心构件：单调更新函数。本练习将通过最简洁的非平凡模型——一个双态马尔可夫链，引导你亲手构建一个单调耦合。通过推导其单步合并概率，你将直观地看到系统参数如何影响CFTP算法的效率，为后续更复杂的应用打下坚实的基础。",
            "id": "3328903",
            "problem": "考虑一个在双态空间 $S=\\{0,1\\}$ 上的时间齐次马尔可夫链，其转移核由 $P(0,1)=a$，$P(0,0)=1-a$，$P(1,0)=b$ 和 $P(1,1)=1-b$ 指定，其中 $a\\in(0,1)$ 和 $b\\in(0,1)$ 满足 $a+b\\leq 1$。条件 $a+b\\leq 1$ 确保了该链相对于自然偏序 $0\\leq 1$ 是随机单调的。设 $\\{U_t\\}_{t\\in\\mathbb{Z}}$ 是一个独立同分布（i.i.d.）的随机变量序列，其中对于每个整数时间 $t$，$U_t\\sim \\mathrm{Unif}(0,1)$。你需要使用过去耦合（CFTP）方法实现一个完美模拟，方法是定义一个更新函数 $F:S\\times(0,1)\\to S$，该函数在其 $S$ 参数上关于 $0\\leq 1$ 是单调的。\n\n从单调更新函数 $F$ 在序 $0\\leq 1$ 下对所有 $u\\in(0,1)$ 满足 $F(0,u)\\leq F(1,u)$ 的基本定义出发，为 $F$ 构造一个显式的基于阈值的规则，该规则能实现给定的转移概率并且是单调的。然后，使用这个 $F$，考虑从两个极端状态 $0$ 和 $1$ 开始的反向耦合，该耦合由一个单一的公共均匀随机变量 $U\\sim \\mathrm{Unif}(0,1)$ 驱动一步。从第一性原理出发，推导精确的一步合并概率 $\\mathbb{P}\\big(F(0,U)=F(1,U)\\big)$ 的闭式解，该解是 $a$ 和 $b$ 的函数。\n\n你的最终答案必须是一步合并概率的闭式解析表达式，并且不得包含任何单位。无需四舍五入。",
            "solution": "我们从双态空间 $S=\\{0,1\\}$ 上的马尔可夫链开始，其转移概率为 $P(0,1)=a$，$P(0,0)=1-a$，$P(1,0)=b$ 和 $P(1,1)=1-b$，参数 $a\\in(0,1)$ 和 $b\\in(0,1)$ 满足 $a+b\\leq 1$。当 $P(0,\\cdot)$ 被 $P(1,\\cdot)$ 随机占优时，该链在偏序 $0\\leq 1$ 下是随机单调的，这在双态情况下简化为要求转移到较高状态的概率随着当前状态的增加而不会减小。特别地，对于单调性，其充分必要条件是，导致从状态0转移到1的随机种子 $u\\in(0,1)$ 的集合，是导致从状态1转移到1的随机种子集合的子集。由于 $P(0,1)=a$ 和 $P(1,1)=1-b$，这个子集关系要求 $a\\leq 1-b$，等价于 $a+b\\leq 1$，这是已知的条件。\n\n过去耦合（CFTP）方法需要一个更新函数 $F:S\\times(0,1)\\to S$，使得对于一个固定的 $u\\in(0,1)$，该函数在状态变量上是单调的。形式上，在序 $0\\leq 1$ 下，单调性意味着\n$$\nF(0,u)\\leq F(1,u)\\quad\\text{对所有 }u\\in(0,1)\\text{ 成立}。\n$$\n我们使用 $(0,1)$ 上的阈值规则来构造 $F$，这些规则实现了所需的转移概率，同时保证了单调性。令 $U\\sim \\mathrm{Unif}(0,1)$ 为一个通用均匀种子。定义集合\n$$\nA:=\\{u\\in(0,1):u  a\\},\\qquad B:=\\{u\\in(0,1):u  1-b\\}。\n$$\n根据假设 $a\\leq 1-b$，我们有 $A\\subseteq B$。我们现在通过以下方式定义 $F$：\n$$\nF(0,u):=\\begin{cases}\n1,  \\text{if } u\\in A,\\\\\n0,  \\text{if } u\\notin A,\n\\end{cases}\n\\qquad\nF(1,u):=\\begin{cases}\n1,  \\text{if } u\\in B,\\\\\n0,  \\text{if } u\\notin B.\n\\end{cases}\n$$\n这是一个有效的更新函数，因为 $\\mathbb{P}(F(0,U)=1)=\\mathbb{P}(U\\in A)=|A|=a$ 且 $\\mathbb{P}(F(1,U)=1)=\\mathbb{P}(U\\in B)=|B|=1-b$，这与所要求的转移概率完全匹配。单调性条件 $F(0,u)\\leq F(1,u)$ 对所有 $u\\in(0,1)$ 均成立，因为 $A\\subseteq B$ 意味着：\n- 如果 $u\\in A$，那么 $u\\in B$，因此 $F(0,u)=1$ 且 $F(1,u)=1$，所以 $F(0,u)\\leq F(1,u)$。\n- 如果 $u\\in B\\setminus A$，那么 $F(0,u)=0$ 且 $F(1,u)=1$，所以 $F(0,u)\\leq F(1,u)$。\n- 如果 $u\\notin B$，那么 $u\\notin A$，因此 $F(0,u)=0$ 且 $F(1,u)=0$，所以 $F(0,u)\\leq F(1,u)$。\n\n构造了 $F$ 之后，我们计算在从两个极端状态 $0$ 和 $1$ 开始，并使用一个公共种子 $U\\sim \\mathrm{Unif}(0,1)$ 的情况下，一步合并的概率。当 $F(0,U)=F(1,U)$ 时，发生一步合并。由于集合 $A\\subseteq B$ 是嵌套的，$F$ 的结果仅在 $U\\in B\\setminus A$ 时不同，此时 $F(0,U)=0$ 且 $F(1,U)=1$。因此，\n$$\n\\mathbb{P}\\big(F(0,U)=F(1,U)\\big)\n=1-\\mathbb{P}\\big(F(0,U)\\neq F(1,U)\\big)\n=1-\\mathbb{P}\\big(U\\in B\\setminus A\\big).\n$$\n由于 $A$ 和 $B$ 是从0开始的区间，其长度分别为 $|A|=a$ 和 $|B|=1-b$，集合差 $B\\setminus A$ 的勒贝格测度为 $|B\\setminus A|=|B|-|A|=(1-b)-a$。因此，\n$$\n\\mathbb{P}\\big(F(0,U)=F(1,U)\\big)=1-\\big((1-b)-a\\big)=a+b.\n$$\n这是一个关于 $a$ 和 $b$ 的闭式表达式，并且根据假设 $a+b\\leq 1$，它是一个有效的概率。",
            "answer": "$$\\boxed{a+b}$$"
        },
        {
            "introduction": "掌握了基本原理后，我们将其应用于统计物理学中的一个经典模型：铁磁伊辛模型。这个练习要求你从理论走向实践，通过编程实现完整的Propp-Wilson CFTP算法。你将利用上下界链和倍增策略，为伊辛模型生成精确的吉布斯分布样本，从而体验完美模拟在解决复杂科学计算问题时的强大威力。",
            "id": "3328974",
            "problem": "您的任务是为小图上的铁磁伊辛模型实现一个单调边界链，并在过去耦合（Coupling From The Past, CFTP）框架内使用它来获得完美样本。该边界链应通过在单一、共同的随机源下，同时更新两个分别初始化为全$-1$和全$+1$构型的极端链来实现。目标是计算两个极端链耦合所需随机位点更新事件的数量，然后根据经验为每个测试用例，确定能以高概率发生耦合所需的最小更新次数。\n\n伊辛模型定义在具有节点集 $\\{0,1,\\dots,n-1\\}$ 和对称边集 $E$ 的有限无向图上。自旋取值于 $\\{-1,+1\\}$。在逆温度 $\\beta \\ge 0$、均匀耦合和零外场条件下，构型 $\\sigma \\in \\{-1,+1\\}^{n}$ 上的铁磁伊辛测度是吉布斯分布，其密度正比于 $\\exp\\left(\\beta \\sum_{(i,j)\\in E}\\sigma_i \\sigma_j\\right)$。单位点热浴动力学过程是：随机均匀地选择一个位点 $i$，然后根据吉布斯测度下给定其邻居的 $\\sigma_i$ 的条件分布，对 $\\sigma_i$ 进行重采样更新。您必须利用构型上的标准偏序关系，以及对于铁磁相互作用，当所有链应用共同的均匀随机变量时，单位点热浴更新对于相邻自旋是单调的这一事实。边界链的实现方式是演化两个链：一个是从全$-1$初始化的下界链，另一个是从全$+1$初始化的上界链，并对两者应用相同的更新序列。当这两个链变得相同时，就发生了耦合。\n\n请使用倍增方案实现Propp–Wilson的过去耦合过程：从长度为 $T=1$ 的随机更新带开始，在同一随机更新带下，将两个极端链从时间 $-T$ 向前模拟到时间 $0$，并检查是否耦合。如果未耦合，则在其前面追加一个相同长度的独立随机更新带（因此总长度加倍），在时间 $-2T$ 重新启动两个极端链，并向前模拟到时间 $0$。重复此过程直到发生耦合。将一次CFTP运行的耦合功定义为首次耦合时的更新带长度 $T$。从离散计算步骤的角度看，这计算的是处理的随机位点更新事件的数量；不要因为将更新应用于两个链而将此计数加倍。\n\n对于以下每个测试用例，请使用固定的随机种子和指定数量的独立CFTP运行来进行一项经验性研究。令 $W$ 表示单次CFTP运行的耦合功（更新带长度）的随机变量。对于每个测试用例，计算满足 $\\mathbb{P}(W \\le T^{\\star}) \\ge q$ 的最小整数 $T^{\\star}$，其中 $q$ 是指定的高概率阈值。通过重复运行得到的经验分位数来估计此值，即通过对观察到的耦合功值进行排序，并选择索引为 $\\lceil q \\cdot m \\rceil - 1$ 的元素，其中 $m$ 是运行次数。所有图的边上都具有单位铁磁耦合和零外场。\n\n使用的基本原理：\n- 伊辛模型的吉布斯分布：一个构型 $\\sigma$ 的概率正比于 $\\exp\\left(\\beta \\sum_{(i,j)\\in E} \\sigma_i \\sigma_j\\right)$。\n- 单位点热浴动力学的定义：通过从吉布斯测度下的条件分布中重新采样来更新一个位点。\n- $\\{-1,+1\\}^{n}$ 上的偏序关系以及铁磁伊辛模型的吸引性（单调性）。\n\n请精确实现以上内容，并为以下测试套件生成结果。每个测试用例是一个元组 $(n, E, \\beta, q, m, s)$，其中 $n$ 是节点数，$E$ 是边列表，$\\beta$ 是逆温度，$q$ 是概率阈值，$m$ 是独立CFTP运行的次数，$s$ 是用于可复现性的伪随机种子。边列表 $E$ 以无序对的形式给出，使用基于0的索引。\n\n- 测试用例 1（一般小图，中等温度）：$n=5$, $E=\\{(0,1),(1,2),(2,3),(3,4)\\}$, $\\beta=0.3$, $q=0.95$, $m=200$, $s=202311$。\n- 测试用例 2（环状图，较低温度区域）：$n=4$, $E=\\{(0,1),(1,2),(2,3),(3,0)\\}$, $\\beta=0.7$, $q=0.95$, $m=200$, $s=202312$。\n- 测试用例 3（星形图，接近有序相变的高温对比，略低的 $q$ 以探测尾部）：$n=5$, $E=\\{(0,1),(0,2),(0,3),(0,4)\\}$, $\\beta=0.9$, $q=0.90$, $m=200$, $s=202313$。\n- 测试用例 4（完全图，中等温度）：$n=4$, $E=\\{(0,1),(0,2),(0,3),(1,2),(1,3),(2,3)\\}$, $\\beta=0.5$, $q=0.95$, $m=200$, $s=202314$。\n- 测试用例 5（边界情况 $\\beta=0$）：$n=3$, $E=\\{(0,1),(1,2)\\}$, $\\beta=0.0$, $q=0.95$, $m=200$, $s=202315$。\n\n您的程序必须：\n- 实现伊辛模型的单调边界链，使用单位点热浴更新。\n- 实现上文所述的、使用倍增方案的Propp-Wilson过去耦合算法。\n- 对于每个测试用例，使用指定的种子（用它来初始化伪随机数生成器）执行 $m$ 次独立的CFTP运行，收集耦合功值 $W$，并计算经验最小整数 $T^{\\star}$，使得满足 $W \\le T^{\\star}$ 的运行次数比例至少为 $q$。\n\n所有计算都是纯数学的，不涉及物理单位。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如：$\"[r_1,r_2,r_3,\\dots]\"$），其中 $r_k$ 是上述顺序中测试用例 $k$ 的整数 $T^{\\star}$。",
            "solution": "问题要求在有限图上为铁磁伊辛模型实现过去耦合（CFTP）算法。目标是确定以指定的高概率实现边界链耦合所需的计算功，该计算功以随机更新事件的数量来衡量。\n\n解决方案分几个步骤进行：首先，我们形式化模型和动力学过程。其次，我们建立单调性原理，这是CFTP算法的基础。第三，我们详细说明使用倍增方案的Propp-Wilson CFTP算法的具体实现。最后，我们描述用于估计所需耦合功的经验性过程。\n\n伊辛模型定义在具有 $n = |V|$ 个位点的图 $G=(V, E)$ 上。系统的构型是一个自旋向量 $\\sigma = (\\sigma_0, \\sigma_1, \\dots, \\sigma_{n-1}) \\in \\{-1, +1\\}^n$。对于一个具有均匀耦合、零外场、逆温度为 $\\beta \\ge 0$ 的铁磁系统，构型 $\\sigma$ 的概率由吉布斯-玻尔兹曼分布给出：\n$$\nP(\\sigma) = \\frac{1}{Z} \\exp\\left(\\beta \\sum_{(i,j) \\in E} \\sigma_i \\sigma_j\\right)\n$$\n其中 $Z$ 是使分布归一化的配分函数。\n\n系统根据单位点热浴动力学进行演化。在每个时间步，从 $V$ 中随机均匀地选择一个位点 $i$。然后，给定其相邻自旋 $\\sigma_{N(i)}$ 的状态，从其条件概率分布中对自旋 $\\sigma_i$ 进行重采样。$\\sigma_i$ 处于特定状态（例如+1）的条件概率为：\n$$\nP(\\sigma_i = +1 | \\sigma_{N(i)}) = \\frac{\\exp\\left(\\beta \\sum_{j \\in N(i)} \\sigma_j\\right)}{\\exp\\left(\\beta \\sum_{j \\in N(i)} \\sigma_j\\right) + \\exp\\left(-\\beta \\sum_{j \\in N(i)} \\sigma_j\\right)}\n$$\n令 $h_i = \\sum_{j \\in N(i)} \\sigma_j$ 为位点 $i$ 处的局部场。该概率简化为：\n$$\np_i^+ \\equiv P(\\sigma_i = +1 | \\sigma_{N(i)}) = \\frac{e^{\\beta h_i}}{e^{\\beta h_i} + e^{-\\beta h_i}} = \\frac{1}{1 + e^{-2\\beta h_i}}\n$$\n单个更新步骤可以通过以下方式实现：随机均匀选择位点 $i$，抽取一个均匀随机数 $U \\in [0, 1]$，如果 $U  p_i^+$ 则将 $\\sigma_i$ 设置为 $+1$，否则设置为 $-1$。\n\nCFTP算法依赖于单调性。我们在构型空间上定义一个偏序关系：$\\sigma \\le \\tau$ 当且仅当对所有位点 $i \\in V$ 都有 $\\sigma_i \\le \\tau_i$。对于铁磁伊辛模型（$\\beta \\ge 0$），热浴动力学是单调的。这意味着，如果我们从满足 $\\sigma \\le \\tau$ 的两个构型 $\\sigma$ 和 $\\tau$ 开始，并对两者应用相同的更新序列（相同的位点 $i$ 选择和随机数 $U$），得到的构型 $\\sigma'$ 和 $\\tau'$ 也将满足 $\\sigma' \\le \\tau'$。要理解这一点，请注意如果 $\\sigma \\le \\tau$，那么局部场满足 $h_i^\\sigma \\le h_i^\\tau$。由于更新概率 $p_i^+$ 是 $h_i$ 的非减函数（对于 $\\beta \\ge 0$），我们有 $p_i^{+,\\sigma} \\le p_i^{+,\\tau}$。对两个系统应用相同的 $U$ 可以确保新的自旋满足 $\\sigma'_i \\le \\tau'_i$，从而保持偏序关系。\n\n这种单调性使我们能够通过仅追踪两个极端链来界定所有可能轨迹的演化：一个下界链 $\\sigma_{\\text{min}}$，初始化为所有自旋为 $-1$ 的状态；一个上界链 $\\sigma_{\\text{max}}$，初始化为所有自旋为 $+1$ 的状态。对于任何构型 $\\sigma$，我们都有 $\\sigma_{\\text{min}} \\le \\sigma \\le \\sigma_{\\text{max}}$。通过使用相同的随机更新序列演化 $\\sigma_{\\text{min}}$ 和 $\\sigma_{\\text{max}}$，我们创建了一个包络，其中包含了从任意构型开始的任何链的演化过程。如果在某个时间 $t$，极端链发生耦合，即 $\\sigma_{\\text{min}}(t) = \\sigma_{\\text{max}}(t)$，这意味着所有可能的链都已耦合到这单一构型。在此过程中于耦合时刻抽取的样本，是来自平稳吉布斯分布的一个完美（精确）样本。\n\nPropp-Wilson CFTP算法将此过程形式化。为了获得时间 $t=0$ 的样本，我们在过去的某个时间 $-T$ 启动链，并向前演化它们。如果它们在时间 $0$ 之前耦合，我们就得到了一个完美样本。如果没有，我们必须从更早的时间开始。倍增方案是找到一个合适的起始时间 $-T$ 的有效方法。该算法流程如下：\n1. 为初次尝试初始化更新带长度 $L=1$。维护一个随机更新列表，即“更新带”（tape），初始为空。\n2. 在一个循环中，生成一个包含 $L$ 个随机更新的新片段。每个更新是一个对 $(i, U)$，其中 $i$ 是从 $\\{0, \\dots, n-1\\}$ 中均匀选择的位点，$U$是从 $\\text{Uniform}[0,1]$ 中抽取的。\n3. 将这个新片段前置拼接到“更新带”上。“更新带”的总长度现在为 $T$。初始化极端链，将 $\\sigma_{\\text{min}}$ 初始化为全-1s，将 $\\sigma_{\\text{max}}$ 初始化为全+1s。\n4. 将“更新带”中的全部 $T$ 个更新序列应用于两个链。\n5. 在结束时检查是否耦合：如果 $\\sigma_{\\text{min}} = \\sigma_{\\text{max}}$，则本次运行的算法终止。耦合功 $W$ 记录为总更新带长度 $T$。\n6. 如果链没有耦合，则设置 $L = T$（下一个要生成的片段的大小是当前更新带的长度）并返回步骤2。这个过程在每次不成功的尝试后，有效地将总模拟时间范围加倍（$T=1, 2, 4, 8, \\dots$）。\n\n对于每个测试用例，此CFTP过程使用由指定种子 $s$ 初始化的独立伪随机数流执行 $m$ 次。这将产生一个包含 $m$ 个耦合功值的样本 $\\{W_1, W_2, \\dots, W_m\\}$。为了找到最小整数 $T^\\star$，使得耦合功不大于 $T^\\star$ 的经验概率至少为 $q$，我们将收集到的功值按非递减顺序排序。所期望的值 $T^\\star$ 随后是已排序、0索引的功值数组中索引为 $k = \\lceil q \\cdot m \\rceil - 1$ 的元素。这对应于经验 $q$-分位数，为高概率耦合所需的时间提供了一个统计估计。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nimport math\n\n# from scipy import ... # No scipy functions are needed.\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the results.\n    \"\"\"\n    # Define test cases as specified in the problem statement.\n    # Each tuple is (n, E, beta, q, m, s).\n    test_cases = [\n        (5, [(0, 1), (1, 2), (2, 3), (3, 4)], 0.3, 0.95, 200, 202311),\n        (4, [(0, 1), (1, 2), (2, 3), (3, 0)], 0.7, 0.95, 200, 202312),\n        (5, [(0, 1), (0, 2), (0, 3), (0, 4)], 0.9, 0.90, 200, 202313),\n        (4, [(0, 1), (0, 2), (0, 3), (1, 2), (1, 3), (2, 3)], 0.5, 0.95, 200, 202314),\n        (3, [(0, 1), (1, 2)], 0.0, 0.95, 200, 202315),\n    ]\n\n    results = []\n    for n, E, beta, q, m, s in test_cases:\n        # Run the experiment for one test case.\n        result = run_cftp_experiment(n, E, beta, q, m, s)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef build_adj_list(n, E):\n    \"\"\"Builds an adjacency list from an edge list.\"\"\"\n    adj = [[] for _ in range(n)]\n    for u, v in E:\n        adj[u].append(v)\n        adj[v].append(u)\n    return adj\n\ndef heat_bath_update(sigma, site_i, U, adj, beta):\n    \"\"\"\n    Performs a single-site heat-bath update for a given spin configuration.\n    \n    Args:\n        sigma (np.ndarray): The current spin configuration.\n        site_i (int): The index of the site to update.\n        U (float): A uniform random number in [0, 1].\n        adj (list): The adjacency list of the graph.\n        beta (float): The inverse temperature.\n\n    Returns:\n        int: The new spin value (+1 or -1).\n    \"\"\"\n    h_i = 0\n    for neighbor in adj[site_i]:\n        h_i += sigma[neighbor]\n    \n    # Probability of spin being +1. For beta=0, this is 0.5.\n    # The expression is numerically stable for the given range of parameters.\n    p_plus = 1.0 / (1.0 + np.exp(-2.0 * beta * h_i))\n\n    if U  p_plus:\n        return 1\n    else:\n        return -1\n\ndef single_cftp_run(n, adj, beta, rng):\n    \"\"\"\n    Performs one complete Coupling From The Past run using a doubling schedule.\n    \n    Returns the coalescence work (the length of the random tape at coalescence).\n    \"\"\"\n    tape = []\n    chunk_size = 1\n\n    while True:\n        # Generate a new chunk of random updates (site index, uniform random number)\n        new_updates = []\n        for _ in range(chunk_size):\n            site = rng.integers(n)\n            u_rand = rng.random()\n            new_updates.append((site, u_rand))\n        \n        # Prepend the new chunk to the tape.\n        tape = new_updates + tape\n        total_length = len(tape)\n\n        # Initialize the extremal chains: all -1s (lower) and all +1s (upper).\n        sigma_min = -np.ones(n, dtype=np.int8)\n        sigma_max = np.ones(n, dtype=np.int8)\n\n        # Evolve both chains from time -T to 0 using the full tape.\n        for site, U in tape:\n            # Update the lower chain\n            sigma_min[site] = heat_bath_update(sigma_min, site, U, adj, beta)\n            # Update the upper chain with the same randomness\n            sigma_max[site] = heat_bath_update(sigma_max, site, U, adj, beta)\n            \n        # Check for coalescence.\n        if np.array_equal(sigma_min, sigma_max):\n            return total_length  # Coalescence work\n\n        # If not coalesced, set the next chunk size to the current tape length.\n        chunk_size = total_length\n\ndef run_cftp_experiment(n, E, beta, q, m, s):\n    \"\"\"\n    Runs m independent CFTP simulations and computes the empirical quantile T*.\n    \"\"\"\n    adj = build_adj_list(n, E)\n    # Initialize the random number generator with the specified seed.\n    rng = np.random.default_rng(s)\n    \n    work_values = []\n    for _ in range(m):\n        work = single_cftp_run(n, adj, beta, rng)\n        work_values.append(work)\n        \n    # Sort the observed coalescence work values.\n    work_values.sort()\n    \n    # Calculate the index for the empirical quantile based on the problem's definition.\n    # The index is ceil(q * m) - 1 for a 0-indexed list.\n    k = math.ceil(q * m) - 1\n    \n    # Ensure the index is within the valid range [0, m-1].\n    # This is a safeguard; with valid q and m, it should be correct.\n    k = max(0, min(k, m - 1))\n        \n    t_star = work_values[k]\n    \n    return t_star\n\nif __name__ == '__main__':\n    solve()\n\n```"
        },
        {
            "introduction": "深刻理解一种方法的标志是了解其适用边界。本练习将引导你探索一个标准单调CFTP方法失效的场景：非二分图上的反铁磁伊辛模型。通过分析“反单调性”和“阻挫”的概念，你将揭示为何优美的上下界链方法在此失效。进而，本练习会引出一种更强大的替代方案——控制CFTP（dominated CFTP），展示完美模拟如何在特定条件下扩展到非单调系统中，从而深化你对高级模拟技术的理解。",
            "id": "3328914",
            "problem": "考虑一个定义在有限、连通、非二分图 $G=(V,E)$ 上的二元伊辛模型，该模型具有成对的反铁磁相互作用且无外部场。自旋构型 $\\sigma \\in \\{-1,+1\\}^{V}$ 上的吉布斯分布为\n$$\n\\pi(\\sigma) \\propto \\exp\\left( \\beta J \\sum_{(i,j)\\in E} \\sigma_i \\sigma_j \\right),\n$$\n其中 $\\beta0$ 且 $J0$。单点热浴马尔可夫链通过以条件概率\n$$\np_i(\\sigma_{N(i)}) \\equiv \\mathbb{P}(\\sigma_i=+1 \\mid \\sigma_{V\\setminus\\{i\\}}) = \\frac{1}{1 + \\exp\\left(-2\\beta J \\sum_{j\\sim i} \\sigma_j\\right)},\n$$\n将均匀选择的位点 $i\\in V$ 的 $\\sigma_i$ 设置为 $+1$ 来进行更新，否则设置为 $-1$。假设更新是使用固定的独立 $\\mathrm{Uniform}[0,1]$ 随机变量序列和位点选择序列进行的，这些序列在耦合链之间共享。\n\n一种用于吸引性自旋系统完美模拟的经典“过去耦合”(CFTP)方法是在 $\\{-1,+1\\}^{V}$ 上使用一个偏序（通常是积序），以及一个相对于该序是单调的更新核。这使得极值界定构造成为可能：在最小和最大构型（全为 $-1$ 和全为 $+1$ 的构型）上启动两个耦合链，在相同随机性下将它们向后演化，并在时间 $0$ 检测是否合并。然而，对于非二分图上的反铁磁伊辛模型，单调极值界定方法会失效。\n\n从以下基本事实出发：(i) 热浴核是吸引性（单调）的，当且仅当在积序下，每个位点的更新概率对于每个相邻自旋都是非递减的；(ii) 一个图是二分图，当且仅当它允许一种2-着色，可以通过翻转一个颜色类的自旋将反铁磁相互作用映射为铁磁相互作用而没有阻挫。请分析为什么对于上述反铁磁模型，单调极值界定方法在非二分图上会失效。然后，确定一种“受控过去耦合”替代方案，该方案在一个明确的高温（或唯一性）条件下，在任意图上都能产生来自 $\\pi$ 的精确样本，并论证其为何能保持正确性。\n\n下列哪个陈述是正确的？\n\nA. 单调极值界定方法在非二分图上仍然适用，如果我们使用积序并且对所有链使用相同的均匀随机数，因为对于反铁磁体，$p_i(\\sigma_{N(i)})$ 对每个邻居 $\\sigma_j$ 是非递减的。\n\nB. 在非二分图上，单调极值界定方法失效，因为当 $J0$ 时，$p_i(\\sigma_{N(i)})$ 对每个邻居是反单调的，并且不存在全局的2-着色来恢复单调性。一个有效的替代方案是通过“祖先族”（clan-of-ancestors）或称“向后勾画”（backward sketch）的受控CFTP：使用一个均匀的 $U\\in[0,1]$ 将每个热浴更新分解为一个与构型无关的部分和一个与构型相关的部分，用一个亚临界分支过程来控制依赖关系的传播，该过程使用 Dobrushin 系数 $c_{ij}=\\sup_{\\sigma,\\sigma':\\,\\sigma_{V\\setminus\\{j\\}}=\\sigma'_{V\\setminus\\{j\\}}}\\|K_i(\\cdot\\mid \\sigma)-K_i(\\cdot\\mid \\sigma')\\|_{\\mathrm{TV}}$，并要求 $\\sup_i \\sum_{j} c_{ij}  1$。这几乎必然会产生一个有限的祖先集，并且当重构终止时，会得到一个来自 $\\pi$ 的精确样本。\n\nC. 使用 Fortuin–Kasteleyn 随机簇表示，其中 $q=2$，边参数为 $p=1-e^{-2\\beta J}$；由于当 $J0$ 时 $p0$，对随机簇模型应用标准的单调CFTP，以获得一个可以映射回反铁磁伊辛模型的精确样本。\n\nD. 附加一个幽灵顶点，它与所有 $i\\in V$ 相连，耦合强度为 $J_{\\text{ghost}}0$ 且足够大以使整个系统具有吸引性，然后在这个增广图上执行单调CFTP并丢弃幽灵自旋；这能精确地在 $V$ 上保留原始目标 $\\pi$，因为对幽灵自旋进行边缘化不会改变伊辛定律。",
            "solution": "首先，我们分析为何标准的单调极值界定CFTP方法会失效。该方法依赖于马尔可夫链更新核的单调性（吸引性）。对于积序，单调性要求在位点 $i$ 的更新概率 $\\mathbb{P}(\\sigma_i=+1 \\mid \\dots)$ 是其每个邻居自旋 $\\sigma_j$ 的非递减函数。然而，对于反铁磁模型（$J0$），更新概率 $p_i = (1 + \\exp(-2\\beta J \\sum_{j\\sim i} \\sigma_j))^{-1}$ 是局部场 $\\sum_{j\\sim i} \\sigma_j$ 的递减函数，因为指数项的系数 $-2\\beta J$ 为正。这意味着 $p_i$ 是其每个邻居自旋 $\\sigma_j$ 的*递减*函数，即更新核是“反单调”的，这违反了标准方法的要求。\n\n虽然在二分图上，可以通过对其中一个划分集进行自旋翻转变换，将反铁磁模型映射为铁磁模型来恢复单调性，但题目明确指出图是*非二分图*。在非二分图上，这种变换无法消除所有反铁磁相互作用，导致“阻挫”（frustration），使得系统从根本上是非单调的。因此，标准的单调极值界定方法会失败。这表明选项A是错误的。\n\n接着，我们评估替代方案。选项B提出的“祖先族”或“向后勾画”方法，是一种受控CFTP（dominated CFTP）技术，专为满足弱依赖条件的非单调系统设计。其核心思想是，要确定时刻0的某个自旋值，只需向后追溯历史上所有影响该自旋的随机事件。在高温或弱耦合条件下（如Dobrushin唯一性条件 $\\sup_i \\sum_{j} c_{ij}  1$ 所保证的），一个位点对另一个位点的长程影响会衰减，保证了“祖先族”几乎必然是有限的。这使得我们能从有限个随机变量中精确重构出自旋值，从而得到一个完美的平稳样本。这个描述是完全正确的，代表了处理此类非单调系统的先进完美模拟方法。\n\n选项C提出的Fortuin-Kasteleyn（FK）表示法，对于反铁磁模型（$J0$）会导致边概率 $p = 1 - e^{-2\\beta J}$ 为负值（因为 $-2\\beta J > 0$，所以 $e^{-2\\beta J} > 1$）。标准的FK框架是基于概率图模型的，不允许负概率，因此该方法不适用。\n\n选项D提出的“幽灵顶点”方法有两个根本缺陷：首先，它不能消除原有的反单调相互作用，系统不会变得具有吸引性；其次，对增广系统进行边缘化会改变原始的目标分布，引入偏差，因为边缘分布会与原始分布乘以一个依赖于构型总磁化强度的因子成正比。\n\n综上所述，选项B准确地解释了标准方法的失效原因，并提出了在高温条件下适用于该问题的正确且先进的完美模拟技术。",
            "answer": "$$\\boxed{B}$$"
        }
    ]
}