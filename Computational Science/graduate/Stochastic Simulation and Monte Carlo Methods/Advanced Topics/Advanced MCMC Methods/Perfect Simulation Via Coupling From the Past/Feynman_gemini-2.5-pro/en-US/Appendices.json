{
    "hands_on_practices": [
        {
            "introduction": "To build a solid understanding of Coupling From The Past (CFTP), we begin with the simplest non-trivial case: a two-state Markov chain. The cornerstone of CFTP for monotone systems is the ability to construct a single update function that preserves the natural ordering of states when driven by a common source of randomness. This exercise provides direct, hands-on practice in creating such a function and then deriving a key performance metric—the one-step coalescence probability—from first principles .",
            "id": "3328903",
            "problem": "Consider a time-homogeneous Markov chain on the two-state space $S=\\{0,1\\}$ with transition kernel specified by $P(0,1)=a$, $P(0,0)=1-a$, $P(1,0)=b$, and $P(1,1)=1-b$, where $a\\in(0,1)$ and $b\\in(0,1)$ satisfy $a+b \\le 1$. The condition $a+b \\le 1$ ensures that the chain is stochastically monotone with respect to the natural partial order $0\\leq 1$. Let $\\{U_t\\}_{t\\in\\mathbb{Z}}$ be an independent and identically distributed (i.i.d.) sequence of random variables with $U_t\\sim \\mathrm{Unif}(0,1)$ for each integer time $t$. You are to implement a perfect simulation using coupling from the past (CFTP) by defining an update function $F:S\\times(0,1)\\to S$ that is monotone in its $S$-argument with respect to $0\\leq 1$.\n\nStarting from the foundational definition that a monotone update function $F$ satisfies $F(0,u)\\leq F(1,u)$ for all $u\\in(0,1)$ under the order $0\\leq 1$, construct an explicit threshold-based rule for $F$ that realizes the given transition probabilities and is monotone. Then, using this $F$, consider the backward coupling initialized at the two extremal states $0$ and $1$, driven by a single common uniform random variable $U\\sim \\mathrm{Unif}(0,1)$ for one step. Derive, from first principles, the exact one-step coalescence probability $\\mathbb{P}\\big(F(0,U)=F(1,U)\\big)$ in closed form as a function of $a$ and $b$.\n\nYour final answer must be the closed-form analytic expression for the one-step coalescence probability and must not include any units. No rounding is required.",
            "solution": "We begin with the two-state Markov chain on $S=\\{0,1\\}$ with transition probabilities $P(0,1)=a$, $P(0,0)=1-a$, $P(1,0)=b$, and $P(1,1)=1-b$, for parameters $a\\in(0,1)$ and $b\\in(0,1)$ satisfying $a+b\\leq 1$. The chain is stochastically monotone under the partial order $0\\leq 1$ when $P(0,\\cdot)$ is stochastically dominated by $P(1,\\cdot)$, which in the two-state case reduces to the requirement that the probability of transitioning to the upper state does not decrease as the current state increases. In particular, for monotonicity it is necessary and sufficient that the set of random seeds $u\\in(0,1)$ that cause a transition to $1$ from state $0$ is a subset of those that cause a transition to $1$ from state $1$. Since $P(0,1)=a$ and $P(1,1)=1-b$, this subset relation requires $a\\leq 1-b$, equivalently $a+b\\leq 1$, which is given.\n\nThe coupling from the past (CFTP) method requires an update function $F:S\\times(0,1)\\to S$ such that, for a fixed $u\\in(0,1)$, the function is monotone in the state variable. Formally, with the order $0\\leq 1$, monotonicity means\n$$\nF(0,u)\\leq F(1,u)\\quad\\text{for all }u\\in(0,1).\n$$\nWe construct $F$ using threshold rules on $(0,1)$ that realize the desired transition probabilities while ensuring monotonicity. Let $U\\sim \\mathrm{Unif}(0,1)$ be a generic uniform seed. Define the sets\n$$\nA:=\\{u\\in(0,1):u< a\\},\\qquad B:=\\{u\\in(0,1):u< 1-b\\}.\n$$\nBy the assumption $a\\leq 1-b$, we have $A\\subseteq B$. We now define $F$ by\n$$\nF(0,u):=\\begin{cases}\n1,& u\\in A,\\\\\n0,& u\\in A^{c},\n\\end{cases}\n\\qquad\nF(1,u):=\\begin{cases}\n1,& u\\in B,\\\\\n0,& u\\in B^{c}.\n\\end{cases}\n$$\nThis is a valid update function because $\\mathbb{P}(F(0,U)=1)=\\mathbb{P}(U\\in A)=|A|=a$ and $\\mathbb{P}(F(1,U)=1)=\\mathbb{P}(U\\in B)=|B|=1-b$, exactly matching the required transition probabilities. The monotonicity condition $F(0,u)\\leq F(1,u)$ holds for all $u\\in(0,1)$ because $A\\subseteq B$ implies:\n- If $u\\in A$, then $u\\in B$, hence $F(0,u)=1$ and $F(1,u)=1$, so $F(0,u)\\leq F(1,u)$.\n- If $u\\in B\\setminus A$, then $F(0,u)=0$ and $F(1,u)=1$, so $F(0,u)\\leq F(1,u)$.\n- If $u\\in B^{c}$, then $u\\notin A$, hence $F(0,u)=0$ and $F(1,u)=0$, so $F(0,u)\\leq F(1,u)$.\n\nHaving constructed $F$, we compute the one-step coalescence probability under a common seed $U\\sim \\mathrm{Unif}(0,1)$, starting from the two extremal states $0$ and $1$. Coalescence after one step occurs when $F(0,U)=F(1,U)$. With the nested sets $A\\subseteq B$, the outcomes of $F$ disagree only when $U\\in B\\setminus A$, where $F(0,U)=0$ and $F(1,U)=1$. Hence,\n$$\n\\mathbb{P}\\big(F(0,U)=F(1,U)\\big)\n=1-\\mathbb{P}\\big(F(0,U)\\neq F(1,U)\\big)\n=1-\\mathbb{P}\\big(U\\in B\\setminus A\\big).\n$$\nSince $A$ and $B$ are intervals from $0$ with lengths $|A|=a$ and $|B|=1-b$, the set difference $B\\setminus A$ has Lebesgue measure $|B\\setminus A|=|B|-|A|=(1-b)-a$. Therefore,\n$$\n\\mathbb{P}\\big(F(0,U)=F(1,U)\\big)=1-\\big((1-b)-a\\big)=a+b.\n$$\nThis is a closed-form expression in $a$ and $b$, and by the assumption $a+b\\leq 1$, it is a valid probability.",
            "answer": "$$\\boxed{a+b}$$"
        },
        {
            "introduction": "After constructing a valid coupling, a crucial question is its efficiency. This practice challenges you to compare a simple, constructive \"pathwise\" coupling against the theoretical optimum known as a \"maximal coupling,\" which achieves the fastest possible rate of coalescence. By analytically deriving the coalescence probabilities for both methods on a two-state chain, you will develop a deeper appreciation for coupling design and uncover a fundamental relationship between practical implementations and theoretical limits .",
            "id": "3328948",
            "problem": "Consider a time-homogeneous, irreducible Markov chain on the two-state space $\\{0,1\\}$ with transition matrix\n$$\nP \\;=\\; \\begin{pmatrix}\n1-\\alpha & \\alpha \\\\\n\\beta & 1-\\beta\n\\end{pmatrix},\n$$\nwhere $\\alpha \\in (0,1)$ and $\\beta \\in (0,1)$. You will compare two couplings for this chain and analyze their coalescence times, with the aim of understanding perfect simulation via Coupling From The Past (CFTP).\n\nStart from foundational principles in Markov chain theory and coupling: the definition of coupling of stochastic processes, the characterization of maximal coupling as one that achieves the largest possible one-step probability of equality given the marginal distributions, and the basic properties of the geometric distribution. For the pathwise coupling, use a shared source of randomness across states, specifically a sequence of independent draws $\\{U_t\\}_{t \\ge 1}$ where each $U_t$ is uniformly distributed on $[0,1]$, and the update function $F:\\{0,1\\} \\times [0,1] \\to \\{0,1\\}$ defined by\n$$\nF(0,u) \\;=\\; \\mathbf{1}\\{u \\leq \\alpha\\}, \\qquad F(1,u) \\;=\\; \\mathbf{1}\\{u \\leq 1-\\beta\\}.\n$$\nAt each time step $t$ and for any current state $x \\in \\{0,1\\}$, the next state is $X_{t+1} = F(x,U_t)$.\n\nSuppose two copies of the chain start at time $t=0$ in different states, one in $0$ and one in $1$. For each of the following couplings, analytically derive the one-step probability that the two chains are equal after one step when they are in different states at the beginning of that step, and then derive the expected coalescence time from the initial pair $(0,1)$:\n1. Maximal coupling: At each step, couple the two transition kernels from the current states $(0,1)$ so as to maximize the probability that the next states are equal while preserving the marginals.\n2. Pathwise coupling: At each step, use the shared uniform random variable $U_t$ and the update function $F$ defined above to generate both chains.\n\nUse these derivations to compute the ratio of expected coalescence times $\\mathbb{E}[T_{\\text{max}}] / \\mathbb{E}[T_{\\text{path}}]$, where $T_{\\text{max}}$ and $T_{\\text{path}}$ denote the forward-in-time coalescence times under maximal and pathwise couplings, respectively, starting from the initial configuration $(0,1)$ at $t=0$.\n\nExpress your final answer as a single real number or a single closed-form symbolic expression. No rounding is necessary.",
            "solution": "The problem asks for the ratio of expected coalescence times for two different couplings of a two-state Markov chain. Let the two coupled chains be $\\{X_t\\}_{t \\geq 0}$ and $\\{Y_t\\}_{t \\geq 0}$, starting from $X_0=0$ and $Y_0=1$. The state space is $S = \\{0,1\\}$, and the transition matrix is\n$$\nP = \\begin{pmatrix} 1-\\alpha & \\alpha \\\\ \\beta & 1-\\beta \\end{pmatrix}\n$$\nwhere $\\alpha \\in (0,1)$ and $\\beta \\in (0,1)$. The conditions on $\\alpha$ and $\\beta$ ensure the chain is irreducible and aperiodic.\n\nA coupling of the Markov chain is a stochastic process $\\{(X_t, Y_t)\\}_{t \\geq 0}$ on the product space $S \\times S$ such that, marginally, both $\\{X_t\\}$ and $\\{Y_t\\}$ evolve according to the transition matrix $P$. Coalescence occurs at the first time $T$ when the two chains meet, i.e., $T = \\inf\\{t \\ge 1 : X_t = Y_t\\}$. We are given the starting configuration $(X_0, Y_0) = (0,1)$.\n\nAs long as the chains have not coalesced, their state is $(X_t, Y_t) = (0,1)$ or $(1,0)$. Due to the symmetry of the problem setup with respect to relabeling states, we only need to consider the case where the chains are in different states, say $(0,1)$. Since the Markov chain is time-homogeneous, the probability of coalescence at the next step, given that the chains are currently in different states, is a constant value $p_{\\text{coal}}$. The coalescence time $T$ is therefore a random variable following a geometric distribution with success parameter $p_{\\text{coal}}$. The expected time to coalescence is given by\n$$\n\\mathbb{E}[T] = \\frac{1}{p_{\\text{coal}}}\n$$\nOur task is to compute this probability $p_{\\text{coal}}$ for two different coupling schemes and then find the ratio of the resulting expected times.\n\n**1. Maximal Coupling**\n\nFor a maximal coupling, we seek to maximize the one-step probability of coalescence, $p_{\\text{coal}} = P(X_{t+1}=Y_{t+1}|X_t=0, Y_t=1)$, while preserving the marginal transition probabilities. The marginal distributions for the next state, given current states $X_t=0$ and $Y_t=1$, are given by the rows of the transition matrix $P$:\n- From state $0$: a transition to $\\{0,1\\}$ with probabilities $(P_{00}, P_{01}) = (1-\\alpha, \\alpha)$.\n- From state $1$: a transition to $\\{0,1\\}$ with probabilities $(P_{10}, P_{11}) = (\\beta, 1-\\beta)$.\n\nAccording to the theory of optimal coupling for discrete distributions, the maximum possible probability of obtaining the same outcome from two different distributions $\\mu_1$ and $\\mu_2$ on the same finite state space $\\mathcal{S}$ is given by the overlap of the distributions: $\\sum_{k \\in \\mathcal{S}} \\min(\\mu_1(k), \\mu_2(k))$.\n\nApplying this principle to our case, the maximum one-step coalescence probability, which we denote as $p_{\\text{coal, max}}$, is:\n$$\np_{\\text{coal, max}} = \\sum_{k \\in \\{0,1\\}} \\min(P(X_{t+1}=k|X_t=0), P(X_{t+1}=k|Y_t=1))\n$$\n$$\np_{\\text{coal, max}} = \\min(P_{00}, P_{10}) + \\min(P_{01}, P_{11})\n$$\nSubstituting the values from the transition matrix:\n$$\np_{\\text{coal, max}} = \\min(1-\\alpha, \\beta) + \\min(\\alpha, 1-\\beta)\n$$\nThe expected coalescence time under maximal coupling, $T_{\\text{max}}$, is therefore:\n$$\n\\mathbb{E}[T_{\\text{max}}] = \\frac{1}{p_{\\text{coal, max}}} = \\frac{1}{\\min(1-\\alpha, \\beta) + \\min(\\alpha, 1-\\beta)}\n$$\n\n**2. Pathwise Coupling**\n\nThis coupling uses a shared sequence of i.i.d. uniform random variables $\\{U_t\\}_{t \\ge 1}$ where $U_t \\sim \\text{Uniform}[0,1]$. The state updates are governed by the function $F(x,u)$:\n$$\nX_{t+1} = F(X_t, U_{t+1}) \\quad \\text{and} \\quad Y_{t+1} = F(Y_t, U_{t+1})\n$$\nwhere $F(0,u) = \\mathbf{1}\\{u \\leq \\alpha\\}$ and $F(1,u) = \\mathbf{1}\\{u \\leq 1-\\beta\\}$. Starting with $(X_t,Y_t)=(0,1)$, the next states are $X_{t+1} = F(0,U_{t+1})$ and $Y_{t+1} = F(1,U_{t+1})$.\n\nThe chains coalesce at step $t+1$ if $X_{t+1} = Y_{t+1}$. This occurs if both chains transition to state $0$ or both transition to state $1$. Let's drop the time index for $U$ for simplicity.\n- Both transition to $1$: $X_{t+1}=1$ and $Y_{t+1}=1$. This requires $F(0, U) = 1$ and $F(1, U) = 1$. This means $\\mathbf{1}\\{U \\leq \\alpha\\} = 1$ and $\\mathbf{1}\\{U \\leq 1-\\beta\\} = 1$, which is equivalent to $U \\leq \\alpha$ and $U \\leq 1-\\beta$. This simplifies to $U \\leq \\min(\\alpha, 1-\\beta)$. The probability of this event is $\\min(\\alpha, 1-\\beta)$.\n- Both transition to $0$: $X_{t+1}=0$ and $Y_{t+1}=0$. This requires $F(0, U) = 0$ and $F(1, U) = 0$. This means $U > \\alpha$ and $U > 1-\\beta$, which simplifies to $U > \\max(\\alpha, 1-\\beta)$. The probability of this event is $1 - \\max(\\alpha, 1-\\beta)$.\n\nThe events $\\{U \\leq \\min(\\alpha, 1-\\beta)\\}$ and $\\{U > \\max(\\alpha, 1-\\beta)\\}$ are disjoint. Therefore, the total one-step coalescence probability for the pathwise coupling, $p_{\\text{coal, path}}$, is the sum of their probabilities:\n$$\np_{\\text{coal, path}} = P(U \\leq \\min(\\alpha, 1-\\beta)) + P(U > \\max(\\alpha, 1-\\beta))\n$$\n$$\np_{\\text{coal, path}} = \\min(\\alpha, 1-\\beta) + 1 - \\max(\\alpha, 1-\\beta)\n$$\nThe expected coalescence time under pathwise coupling, $T_{\\text{path}}$, is:\n$$\n\\mathbb{E}[T_{\\text{path}}] = \\frac{1}{p_{\\text{coal, path}}} = \\frac{1}{\\min(\\alpha, 1-\\beta) + 1 - \\max(\\alpha, 1-\\beta)}\n$$\n\n**Comparison and Ratio**\n\nTo find the ratio $\\mathbb{E}[T_{\\text{max}}] / \\mathbb{E}[T_{\\text{path}}]$, we must compare $p_{\\text{coal, max}}$ and $p_{\\text{coal, path}}$. We have:\n$$\np_{\\text{coal, max}} = \\min(1-\\alpha, \\beta) + \\min(\\alpha, 1-\\beta)\n$$\n$$\np_{\\text{coal, path}} = 1 - \\max(\\alpha, 1-\\beta) + \\min(\\alpha, 1-\\beta)\n$$\nFor these probabilities to be equal, we must show that $\\min(1-\\alpha, \\beta) = 1 - \\max(\\alpha, 1-\\beta)$.\nLet's prove this equality. We consider two cases based on the relationship between $\\alpha$ and $1-\\beta$:\n\nCase 1: $\\alpha \\geq 1-\\beta$. This is equivalent to $\\alpha + \\beta \\geq 1$.\n- In this case, $\\max(\\alpha, 1-\\beta) = \\alpha$.\n- The right-hand side of the equality becomes $1 - \\alpha$.\n- The condition $\\alpha \\geq 1-\\beta$ is also equivalent to $1-\\alpha \\leq \\beta$.\n- Therefore, $\\min(1-\\alpha, \\beta) = 1-\\alpha$.\n- The left-hand side is $1-\\alpha$.\n- Thus, both sides are equal to $1-\\alpha$.\n\nCase 2: $\\alpha < 1-\\beta$. This is equivalent to $\\alpha + \\beta < 1$.\n- In this case, $\\max(\\alpha, 1-\\beta) = 1-\\beta$.\n- The right-hand side of the equality becomes $1 - (1-\\beta) = \\beta$.\n- The condition $\\alpha < 1-\\beta$ is also equivalent to $1-\\alpha > \\beta$.\n- Therefore, $\\min(1-\\alpha, \\beta) = \\beta$.\n- The left-hand side is $\\beta$.\n- Thus, both sides are equal to $\\beta$.\n\nSince the equality $\\min(1-\\alpha, \\beta) = 1 - \\max(\\alpha, 1-\\beta)$ holds for all valid $\\alpha, \\beta \\in (0,1)$, it follows that:\n$$\np_{\\text{coal, max}} = p_{\\text{coal, path}}\n$$\nThis demonstrates that for a two-state Markov chain, the specific pathwise coupling constructed using a shared uniform random variable is, in fact, a maximal coupling.\n\nSince the one-step coalescence probabilities are identical, their corresponding expected coalescence times must also be identical:\n$$\n\\mathbb{E}[T_{\\text{max}}] = \\mathbb{E}[T_{\\text{path}}]\n$$\nTherefore, the ratio of the expected coalescence times is:\n$$\n\\frac{\\mathbb{E}[T_{\\text{max}}]}{\\mathbb{E}[T_{\\text{path}}]} = 1\n$$",
            "answer": "$$\\boxed{1}$$"
        },
        {
            "introduction": "We now transition from foundational toy models to a cornerstone of statistical physics: the ferromagnetic Ising model. For complex systems like this, the power of CFTP is realized through \"bounding chains,\" where we simulate only the extremal configurations (all-spins-down and all-spins-up) to envelop the dynamics of all other states. This computational exercise guides you through implementing the complete Propp-Wilson CFTP algorithm, translating the abstract theory of monotone coupling into a practical tool for generating perfect samples from a significant scientific model .",
            "id": "3328974",
            "problem": "You are given the task of implementing a monotone bounding chain for the ferromagnetic Ising model on small graphs and using it within the Coupling From The Past (CFTP) framework to obtain perfect samples. The bounding chain should be realized by simultaneously updating two extremal chains initialized at the all-$-1$ and all-$+1$ configurations under a single, common source of randomness. The goal is to compute the number of random site-update events required for the two extremal chains to coalesce, and then empirically determine, for each test case, the minimal number of updates needed so that coalescence occurs with high probability.\n\nThe Ising model is defined on a finite, undirected graph with node set $\\{0,1,\\dots,n-1\\}$ and symmetric edge set $E$. Spins take values in $\\{-1,+1\\}$. The ferromagnetic Ising measure on configurations $\\sigma \\in \\{-1,+1\\}^{n}$ at inverse temperature $\\beta \\ge 0$ with uniform coupling and zero external field is the Gibbs distribution with density proportional to $\\exp\\left(\\beta \\sum_{(i,j)\\in E}\\sigma_i \\sigma_j\\right)$. A single-site heat-bath dynamics selects a site $i$ uniformly at random and updates $\\sigma_i$ by drawing from the conditional distribution of $\\sigma_i$ given its neighbors under the Gibbs measure. You must utilize the standard partial order on configurations and the fact that for ferromagnetic interactions the single-site heat-bath update is monotone in the neighboring spins when applied with a common uniform random variable for all chains. The bounding chain is implemented by evolving two chains, a lower chain initialized at all-$-1$ and an upper chain initialized at all-$+1$, applying the same update sequence to both. Coalescence occurs when the two chains become identical.\n\nImplement the Propp–Wilson Coupling From The Past procedure using a doubling schedule: start with a random update tape of length $T=1$, simulate both extremal chains forward from time $-T$ to time $0$ under the same random tape, and check coalescence. If not coalesced, prepend an independent random tape of the same length (so the total length doubles), restart both extremal chains at time $-2T$, and simulate forward to time $0$. Repeat until coalescence occurs. Define the coalescence work for one CFTP run as the tape length $T$ at the time of first coalescence. In terms of discrete computation steps, this counts the number of random site-update events processed; do not double this count to account for applying the updates to both chains.\n\nFor each test case below, perform an empirical study with a fixed random seed and a specified number of independent CFTP runs. Let $W$ denote the random variable equal to the coalescence work (tape length) for a single CFTP run. For each test case, compute the smallest integer $T^{\\star}$ such that $\\mathbb{P}(W \\le T^{\\star}) \\ge q$, where $q$ is the specified high-probability threshold. Estimate this by the empirical quantile from the repeated runs, i.e., by sorting the observed coalescence work values and selecting the element at index $\\lceil q \\cdot m \\rceil - 1$, where $m$ is the number of runs. All graphs have unit ferromagnetic couplings on edges and zero external field.\n\nFundamental base to use:\n- The Gibbs distribution for the Ising model: the probability of a configuration $\\sigma$ is proportional to $\\exp\\left(\\beta \\sum_{(i,j)\\in E} \\sigma_i \\sigma_j\\right)$.\n- The definition of single-site heat-bath dynamics: update a site by resampling from its conditional distribution under the Gibbs measure.\n- The partial order on $\\{-1,+1\\}^{n}$ and the attractiveness (monotonicity) of the ferromagnetic Ising model.\n\nImplement the above precisely and produce results for the following test suite. Each test case is a tuple $(n, E, \\beta, q, m, s)$, where $n$ is the number of nodes, $E$ is the edge list, $\\beta$ is the inverse temperature, $q$ is the probability threshold, $m$ is the number of independent CFTP runs, and $s$ is the pseudorandom seed for reproducibility. The edge list $E$ is given as unordered pairs with $0$-based indices.\n\n- Test case $1$ (general small graph, moderate temperature): $n=5$, $E=\\{(0,1),(1,2),(2,3),(3,4)\\}$, $\\beta=0.3$, $q=0.95$, $m=200$, $s=202311$.\n- Test case $2$ (cycle, lower-temperature regime): $n=4$, $E=\\{(0,1),(1,2),(2,3),(3,0)\\}$, $\\beta=0.7$, $q=0.95$, $m=200$, $s=202312$.\n- Test case $3$ (star, high-temperature contrast near ordering, slightly lower $q$ to probe tail): $n=5$, $E=\\{(0,1),(0,2),(0,3),(0,4)\\}$, $\\beta=0.9$, $q=0.90$, $m=200$, $s=202313$.\n- Test case $4$ (complete graph, moderate temperature): $n=4$, $E=\\{(0,1),(0,2),(0,3),(1,2),(1,3),(2,3)\\}$, $\\beta=0.5$, $q=0.95$, $m=200$, $s=202314$.\n- Test case $5$ (boundary case $\\beta=0$): $n=3$, $E=\\{(0,1),(1,2)\\}$, $\\beta=0.0$, $q=0.95$, $m=200$, $s=202315$.\n\nYour program must:\n- Implement the monotone bounding chains for the Ising model with single-site heat-bath updates.\n- Implement Propp–Wilson Coupling From The Past with the doubling schedule described above.\n- For each test case, perform $m$ independent CFTP runs using the specified seed (use it to initialize the pseudorandom number generator), collect the coalescence work values $W$, and compute the empirical minimal integer $T^{\\star}$ such that the fraction of runs with $W \\le T^{\\star}$ is at least $q$.\n\nAll computations are purely mathematical and do not involve physical units.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $\"[r_1,r_2,r_3,\\dots]\"$), where $r_k$ is the integer $T^{\\star}$ for test case $k$ in the above order.",
            "solution": "The problem requires the implementation of the Coupling From The Past (CFTP) algorithm for the ferromagnetic Ising model on a finite graph. The objective is to determine the computational work, measured in the number of random update events, required to achieve coalescence of bounding chains with a specified high probability.\n\nThe solution proceeds in several steps: first, we formalize the model and the dynamics. Second, we establish the principle of monotonicity, which is the foundation for the CFTP algorithm. Third, we detail the specific implementation of the Propp-Wilson CFTP algorithm with a doubling schedule. Finally, we describe the empirical procedure to estimate the required coalescence work.\n\nThe Ising model is defined on a graph $G=(V, E)$ with $n = |V|$ sites. A configuration of the system is a vector of spins $\\sigma = (\\sigma_0, \\sigma_1, \\dots, \\sigma_{n-1}) \\in \\{-1, +1\\}^n$. For a ferromagnetic system with uniform coupling, zero external field, and at inverse temperature $\\beta \\ge 0$, the probability of a configuration $\\sigma$ is given by the Gibbs-Boltzmann distribution:\n$$\nP(\\sigma) = \\frac{1}{Z} \\exp\\left(\\beta \\sum_{(i,j) \\in E} \\sigma_i \\sigma_j\\right)\n$$\nwhere $Z$ is the partition function that normalizes the distribution.\n\nThe system evolves according to single-site heat-bath dynamics. At each time step, a site $i \\in V$ is chosen uniformly at random. The spin $\\sigma_i$ is then resampled from its conditional probability distribution, given the states of its neighboring spins $\\sigma_{N(i)}$. The conditional probability for $\\sigma_i$ to be in a specific state, say $+1$, is:\n$$\nP(\\sigma_i = +1 | \\sigma_{N(i)}) = \\frac{\\exp\\left(\\beta \\sum_{j \\in N(i)} \\sigma_j\\right)}{\\exp\\left(\\beta \\sum_{j \\in N(i)} \\sigma_j\\right) + \\exp\\left(-\\beta \\sum_{j \\in N(i)} \\sigma_j\\right)}\n$$\nLet $h_i = \\sum_{j \\in N(i)} \\sigma_j$ be the local field at site $i$. The probability simplifies to:\n$$\np_i^+ \\equiv P(\\sigma_i = +1 | \\sigma_{N(i)}) = \\frac{e^{\\beta h_i}}{e^{\\beta h_i} + e^{-\\beta h_i}} = \\frac{1}{1 + e^{-2\\beta h_i}}\n$$\nA single update step can be implemented by selecting site $i$ uniformly at random, drawing a uniform random number $U \\in [0, 1]$, and setting $\\sigma_i$ to $+1$ if $U < p_i^+$ and to $-1$ otherwise.\n\nThe CFTP algorithm relies on the property of monotonicity. We define a partial order on the space of configurations: $\\sigma \\le \\tau$ if and only if $\\sigma_i \\le \\tau_i$ for all sites $i \\in V$. The heat-bath dynamics are monotone for the ferromagnetic Ising model ($\\beta \\ge 0$). This means that if we start with two configurations $\\sigma$ and $\\tau$ such that $\\sigma \\le \\tau$ and apply the same update sequence (same choice of site $i$ and random number $U$) to both, the resulting configurations $\\sigma'$ and $\\tau'$ will also satisfy $\\sigma' \\le \\tau'$. To see this, note that if $\\sigma \\le \\tau$, then the local fields satisfy $h_i^\\sigma \\le h_i^\\tau$. Since the update probability $p_i^+$ is a non-decreasing function of $h_i$ for $\\beta \\ge 0$, we have $p_i^{+,\\sigma} \\le p_i^{+,\\tau}$. Applying the same $U$ to both systems ensures that the new spins satisfy $\\sigma'_i \\le \\tau'_i$, thus preserving the partial order.\n\nThis monotonicity allows us to bound the evolution of all possible trajectories by tracking only two extremal chains: a lower chain, $\\sigma_{\\text{min}}$, initialized to the state where all spins are $-1$, and an upper chain, $\\sigma_{\\text{max}}$, initialized to the state where all spins are $+1$. For any configuration $\\sigma$, we have $\\sigma_{\\text{min}} \\le \\sigma \\le \\sigma_{\\text{max}}$. By evolving $\\sigma_{\\text{min}}$ and $\\sigma_{\\text{max}}$ with the same sequence of random updates, we create an envelope that contains the evolution of any chain started from an arbitrary configuration. If at some time $t$, the extremal chains coalesce, i.e., $\\sigma_{\\text{min}}(t) = \\sigma_{\\text{max}}(t)$, it implies that all possible chains would have coalesced to this single configuration. A sample drawn by this procedure at the time of coalescence is a perfect (exact) sample from the stationary Gibbs distribution.\n\nThe Propp-Wilson CFTP algorithm formalizes this. To obtain a sample at time $t=0$, we start the chains at a time $-T$ in the past and evolve them forward. If they coalesce by time $0$, we have a perfect sample. If not, we must start further back in time. The doubling schedule is an efficient way to find a suitable starting time $-T$. The algorithm proceeds as follows:\n1. Initialize the tape length for the first attempt, $L=1$. Maintain a list of random updates, the `tape`, which is initially empty.\n2. In a loop, generate a new segment of $L$ random updates. Each update is a pair $(i, U)$ where $i$ is a site chosen uniformly from $\\{0, \\dots, n-1\\}$ and $U$ is drawn from $\\text{Uniform}[0,1]$.\n3. Prepend this new segment to the `tape`. The total length of the `tape` is now $T$.\n4. Initialize the extremal chains, $\\sigma_{\\text{min}}$ to all-$-1$s and $\\sigma_{\\text{max}}$ to all-$+1$s.\n5. Apply the entire sequence of $T$ updates from the `tape` to both chains.\n6. Check for coalescence at the end: if $\\sigma_{\\text{min}} = \\sigma_{\\text{max}}$, the algorithm terminates for this run. The coalescence work $W$ is recorded as the total tape length $T$.\n7. If the chains have not coalesced, set $L = T$ (the size of the next segment to generate is the length of the current tape) and return to step 2. This procedure effectively doubles the total simulation time horizon at each unsuccessful attempt ($T=1, 2, 4, 8, \\dots$).\n\nFor each test case, this CFTP procedure is executed $m$ times with an independent pseudorandom number stream for each run, initiated by the specified seed $s$. This yields a sample of $m$ coalescence work values, $\\{W_1, W_2, \\dots, W_m\\}$. To find the minimal integer $T^\\star$ such that the empirical probability of the coalescence work being at most $T^\\star$ is at least $q$, we sort the collected work values in non-decreasing order. The desired value $T^\\star$ is then the element at index $k = \\lceil q \\cdot m \\rceil - 1$ in the sorted, $0$-indexed array of work values. This corresponds to the empirical $q$-quantile, providing a statistical estimate of the time required for coalescence with high probability.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nimport math\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the results.\n    \"\"\"\n    # Define test cases as specified in the problem statement.\n    # Each tuple is (n, E, beta, q, m, s).\n    test_cases = [\n        (5, [(0, 1), (1, 2), (2, 3), (3, 4)], 0.3, 0.95, 200, 202311),\n        (4, [(0, 1), (1, 2), (2, 3), (3, 0)], 0.7, 0.95, 200, 202312),\n        (5, [(0, 1), (0, 2), (0, 3), (0, 4)], 0.9, 0.90, 200, 202313),\n        (4, [(0, 1), (0, 2), (0, 3), (1, 2), (1, 3), (2, 3)], 0.5, 0.95, 200, 202314),\n        (3, [(0, 1), (1, 2)], 0.0, 0.95, 200, 202315),\n    ]\n\n    results = []\n    for n, E, beta, q, m, s in test_cases:\n        # Run the experiment for one test case.\n        result = run_cftp_experiment(n, E, beta, q, m, s)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef build_adj_list(n, E):\n    \"\"\"Builds an adjacency list from an edge list.\"\"\"\n    adj = [[] for _ in range(n)]\n    for u, v in E:\n        adj[u].append(v)\n        adj[v].append(u)\n    return adj\n\ndef heat_bath_update(sigma, site_i, U, adj, beta):\n    \"\"\"\n    Performs a single-site heat-bath update for a given spin configuration.\n    \n    Args:\n        sigma (np.ndarray): The current spin configuration.\n        site_i (int): The index of the site to update.\n        U (float): A uniform random number in [0, 1].\n        adj (list): The adjacency list of the graph.\n        beta (float): The inverse temperature.\n\n    Returns:\n        int: The new spin value (+1 or -1).\n    \"\"\"\n    h_i = 0\n    for neighbor in adj[site_i]:\n        h_i += sigma[neighbor]\n    \n    # Probability of spin being +1. For beta=0, this is 0.5.\n    # The expression is numerically stable for the given range of parameters.\n    p_plus = 1.0 / (1.0 + np.exp(-2.0 * beta * h_i))\n\n    if U < p_plus:\n        return 1\n    else:\n        return -1\n\ndef single_cftp_run(n, adj, beta, rng):\n    \"\"\"\n    Performs one complete Coupling From The Past run using a doubling schedule.\n    \n    Returns the coalescence work (the length of the random tape at coalescence).\n    \"\"\"\n    tape = []\n    chunk_size = 1\n\n    while True:\n        # Generate a new chunk of random updates (site index, uniform random number)\n        new_updates = []\n        for _ in range(chunk_size):\n            site = rng.integers(n)\n            u_rand = rng.random()\n            new_updates.append((site, u_rand))\n        \n        # Prepend the new chunk to the tape.\n        tape = new_updates + tape\n        total_length = len(tape)\n\n        # Initialize the extremal chains: all -1s (lower) and all +1s (upper).\n        sigma_min = -np.ones(n, dtype=np.int8)\n        sigma_max = np.ones(n, dtype=np.int8)\n\n        # Evolve both chains from time -T to 0 using the full tape.\n        for site, U in tape:\n            # Update the lower chain\n            sigma_min[site] = heat_bath_update(sigma_min, site, U, adj, beta)\n            # Update the upper chain with the same randomness\n            sigma_max[site] = heat_bath_update(sigma_max, site, U, adj, beta)\n            \n        # Check for coalescence.\n        if np.array_equal(sigma_min, sigma_max):\n            return total_length  # Coalescence work\n\n        # If not coalesced, set the next chunk size to the current tape length.\n        chunk_size = total_length\n\ndef run_cftp_experiment(n, E, beta, q, m, s):\n    \"\"\"\n    Runs m independent CFTP simulations and computes the empirical quantile T*.\n    \"\"\"\n    adj = build_adj_list(n, E)\n    # Initialize the random number generator with the specified seed.\n    rng = np.random.default_rng(s)\n    \n    work_values = []\n    for _ in range(m):\n        work = single_cftp_run(n, adj, beta, rng)\n        work_values.append(work)\n        \n    # Sort the observed coalescence work values.\n    work_values.sort()\n    \n    # Calculate the index for the empirical quantile based on the problem's definition.\n    # The index is ceil(q * m) - 1 for a 0-indexed list.\n    k = math.ceil(q * m) - 1\n    \n    # Ensure the index is within the valid range [0, m-1].\n    # This is a safeguard; with valid q and m, it should be correct.\n    k = max(0, min(k, m - 1))\n        \n    t_star = work_values[k]\n    \n    return t_star\n\nif __name__ == '__main__':\n    solve()\n\n```"
        }
    ]
}