{
    "hands_on_practices": [
        {
            "introduction": "第一个练习是基础性的。通过为一个简单的二次势能问题解析计算单步 SGHMC 更新的结果，我们得以揭示该算法的内在机制。理解这个基本构建模块如何传播系统的位置和动量状态，并注入随机噪声，是分析算法长期行为的关键第一步。",
            "id": "3349051",
            "problem": "考虑一个一维系统，其在单位温度下具有哈密顿动力学，其二次势能函数为 $U(q) = \\frac{A}{2} q^{2}$，其中 $A > 0$。令 $(q_{k}, p_{k}) \\in \\mathbb{R}^{2}$ 表示在离散时间索引 $k$ 处的位置和动量。在单位质量和单位温度下的涨落耗散条件下，随机梯度哈密顿蒙特卡洛（SGHMC）方法在连续时间上由欠阻尼朗之万随机微分方程建模：$dq = p \\, dt$ 和 $dp = - \\nabla U(q) \\, dt - c \\, p \\, dt + \\sqrt{2 c} \\, dW_{t}$，其中 $c > 0$ 是摩擦系数，$W_{t}$ 是标准维纳过程。考虑应用于该系统的步长为 $h > 0$ 的显式 Euler–Maruyama 离散化：\n$$\np_{k+1} = p_{k} - h \\, \\nabla U(q_{k}) - c \\, h \\, p_{k} + \\sqrt{2 c h} \\, \\xi_{k}, \\quad \\xi_{k} \\sim \\mathcal{N}(0, 1),\n$$\n$$\nq_{k+1} = q_{k} + h \\, p_{k+1},\n$$\n其中 $\\xi_{k}$ 在各步之间独立，并且独立于 $(q_{k}, p_{k})$。仅使用上述定义和高斯随机变量仿射变换的标准性质，推导在二次势能 $U(q) = \\frac{A}{2} q^{2}$ 的情况下，给定 $(q_{k}, p_{k})$ 时 $(q_{k+1}, p_{k+1})$ 的精确条件分布。\n\n请按以下顺序，以条件均值向量和协方差矩阵的六个标量条目的形式提供您的最终答案：\n- 给定 $(q_{k}, p_{k})$ 时 $(q_{k+1}, p_{k+1})$ 的均值向量的两个分量 $(\\mu_{q}, \\mu_{p})$，\n- 接着是给定 $(q_{k}, p_{k})$ 时 $(q_{k+1}, p_{k+1})$ 的条件协方差矩阵的四个条目 $(\\sigma_{qq}, \\sigma_{qp}, \\sigma_{pq}, \\sigma_{pp})$，\n\n以 $\\text{pmatrix}$ 格式列为单行。您的答案必须是关于 $A$、$c$、$h$、$q_{k}$ 和 $p_{k}$ 的单个闭式解析表达式。",
            "solution": "用户希望我解决一个关于随机梯度哈密顿蒙特卡洛的问题。\n\n### 步骤1：问题验证\n\n我将首先对问题陈述进行强制性验证。\n\n#### 步骤1.1：提取已知条件\n\n-   **系统**：一个一维系统。\n-   **势能**：$U(q) = \\frac{A}{2} q^{2}$，常数 $A > 0$。\n-   **状态变量**：在离散时间索引 $k$ 处的位置 $q_{k}$ 和动量 $p_{k}$。\n-   **连续时间动力学**：单位质量 ($m=1$) 和单位温度 ($k_B T = 1$) 下 SGHMC 的欠阻尼朗之万随机微分方程。\n    $dq = p \\, dt$\n    $dp = - \\nabla U(q) \\, dt - c \\, p \\, dt + \\sqrt{2 c} \\, dW_{t}$，其中 $c > 0$ 是摩擦系数，$W_{t}$ 是标准维纳过程。\n-   **离散化**：步长为 $h > 0$ 的显式 Euler–Maruyama 方案。\n    $p_{k+1} = p_{k} - h \\, \\nabla U(q_{k}) - c \\, h \\, p_{k} + \\sqrt{2 c h} \\, \\xi_{k}$\n    $q_{k+1} = q_{k} + h \\, p_{k+1}$\n-   **噪声项**：$\\xi_{k} \\sim \\mathcal{N}(0, 1)$，对于每个步骤 $k$ 独立同分布，并且独立于状态 $(q_{k}, p_{k})$。\n-   **目标**：推导给定 $(q_{k}, p_{k})$ 时 $(q_{k+1}, p_{k+1})$ 的精确条件概率分布。\n-   **输出规格**：最终答案必须是条件均值向量和协方差矩阵的六个标量条目，顺序为 $(\\mu_{q}, \\mu_{p}, \\sigma_{qq}, \\sigma_{qp}, \\sigma_{pq}, \\sigma_{pp})$。\n\n#### 步骤1.2：使用提取的已知条件进行验证\n\n-   **科学基础**：该问题在统计力学和计算统计学领域有坚实的基础。欠阻尼朗之万方程是随机动力学的基本模型，而 SGHMC 算法及其离散化是现代机器学习和贝叶斯推断中广泛使用的标准方法。其数学框架完全有效。\n-   **适定性**：该问题是适定的。状态更新方程已明确给出。唯一的随机性来源是高斯变量 $\\xi_k$。$p_{k+1}$ 和 $q_{k+1}$ 的更新是 $\\xi_k$ 的仿射变换。高斯随机变量的仿射变换结果仍然是高斯随机变量。因此，给定 $(q_{k}, p_{k})$ 时 $(q_{k+1}, p_{k+1})$ 的条件分布将是二元高斯分布，它由其均值向量和协方差矩阵唯一确定。所有必要的参数（$A, c, h$）和初始状态变量（$q_k, p_k$）均已提供。\n-   **客观性**：问题使用精确、无歧义的数学语言陈述。没有主观或非科学的元素。\n-   **结论**：该问题不违反任何无效性标准。它是科学上合理的、适定的和客观的。\n\n#### 步骤1.3：裁决和行动\n\n问题陈述是**有效的**。我将继续构建解决方案。\n\n### 步骤2：求解推导\n\n目标是确定给定状态向量 $X_{k} = \\begin{pmatrix} q_{k} \\\\ p_{k} \\end{pmatrix}$ 时，状态向量 $X_{k+1} = \\begin{pmatrix} q_{k+1} \\\\ p_{k+1} \\end{pmatrix}$ 的条件分布。\n\n首先，我们明确势能函数 $U(q)$ 的梯度。\n对于二次势能 $U(q) = \\frac{A}{2} q^{2}$，其梯度为 $\\nabla U(q) = \\frac{dU}{dq} = A q$。\n\n将此代入给定的离散化方案，我们得到显式更新规则：\n动量 $p_{k+1}$ 的更新为：\n$$p_{k+1} = p_{k} - h (A q_{k}) - c h p_{k} + \\sqrt{2 c h} \\, \\xi_{k}$$\n$$p_{k+1} = (1 - c h) p_{k} - A h q_{k} + \\sqrt{2 c h} \\, \\xi_{k}$$\n位置 $q_{k+1}$ 的更新为：\n$$q_{k+1} = q_{k} + h p_{k+1}$$\n\n这些方程描述了从标准正态随机变量 $\\xi_k$ 到向量 $(q_{k+1}, p_{k+1})$ 的仿射变换。在条件分布的上下文中，$q_k$ 和 $p_k$ 的值被视为固定常数。由于高斯变量的仿射变换结果是高斯分布，因此 $(q_{k+1}, p_{k+1})$ 的条件分布是一个二元正态分布。该分布由其均值向量和协方差矩阵完全表征。\n\n#### 计算条件均值向量\n\n条件均值向量为 $\\mu = E[X_{k+1} | X_{k}] = \\begin{pmatrix} E[q_{k+1} | q_{k}, p_{k}] \\\\ E[p_{k+1} | q_{k}, p_{k}] \\end{pmatrix} = \\begin{pmatrix} \\mu_q \\\\ \\mu_p \\end{pmatrix}$。\n我们使用 $E[\\xi_k] = 0$ 这一事实。\n\n首先，我们计算动量的条件均值 $\\mu_p$：\n$$\\mu_p = E[p_{k+1} | q_{k}, p_{k}] = E[(1 - c h) p_{k} - A h q_{k} + \\sqrt{2 c h} \\, \\xi_{k} | q_{k}, p_{k}]$$\n根据期望的线性性质，并将 $q_k$ 和 $p_k$ 视为常数：\n$$\\mu_p = (1 - c h) p_{k} - A h q_{k} + \\sqrt{2 c h} \\, E[\\xi_{k}]$$\n$$\\mu_p = (1 - c h) p_{k} - A h q_{k}$$\n\n接下来，我们计算位置的条件均值 $\\mu_q$：\n$$\\mu_q = E[q_{k+1} | q_{k}, p_{k}] = E[q_{k} + h p_{k+1} | q_{k}, p_{k}]$$\n使用期望的线性性质和先前求得的 $E[p_{k+1} | q_k, p_k]$ 结果：\n$$\\mu_q = q_{k} + h E[p_{k+1} | q_{k}, p_{k}] = q_{k} + h \\mu_p$$\n$$\\mu_q = q_{k} + h ((1 - c h) p_{k} - A h q_{k})$$\n$$\\mu_q = (1 - A h^{2}) q_{k} + h(1 - c h) p_{k}$$\n\n因此，条件均值向量为：\n$$\\mu = \\begin{pmatrix} (1 - A h^{2}) q_{k} + h(1 - c h) p_{k} \\\\ -A h q_{k} + (1 - c h) p_{k} \\end{pmatrix}$$\n\n#### 计算条件协方差矩阵\n\n条件协方差矩阵为 $\\Sigma = \\text{Cov}(X_{k+1} | X_{k}) = \\begin{pmatrix} \\sigma_{qq}  \\sigma_{qp} \\\\ \\sigma_{pq}  \\sigma_{pp} \\end{pmatrix}$。\n这些条目是通过 $q_{k+1}$ 和 $p_{k+1}$ 与其条件均值的偏差计算得出的。我们来求这些偏差：\n$$p_{k+1} - \\mu_p = \\left( (1 - c h) p_{k} - A h q_{k} + \\sqrt{2 c h} \\, \\xi_{k} \\right) - \\left( (1 - c h) p_{k} - A h q_{k} \\right) = \\sqrt{2 c h} \\, \\xi_{k}$$\n$$q_{k+1} - \\mu_q = (q_{k} + h p_{k+1}) - (q_{k} + h \\mu_p) = h (p_{k+1} - \\mu_p) = h \\sqrt{2 c h} \\, \\xi_{k}$$\n\n现在我们可以使用 $\\text{Var}(\\xi_k) = E[\\xi_k^2] - (E[\\xi_k])^2 = E[\\xi_k^2] = 1$ 这一事实来计算协方差矩阵的元素。\n\n随机变量 $Z$ 的方差为 $\\text{Var}(Z) = E[(Z - E[Z])^2]$。对于我们的条件设置：\n$\\sigma_{pp} = \\text{Var}(p_{k+1} | q_{k}, p_{k}) = E[(p_{k+1} - \\mu_p)^2 | q_k, p_k]$\n$$\\sigma_{pp} = E[(\\sqrt{2 c h} \\, \\xi_{k})^2] = (2 c h) \\, E[\\xi_k^2] = 2 c h$$\n\n$\\sigma_{qq} = \\text{Var}(q_{k+1} | q_{k}, p_{k}) = E[(q_{k+1} - \\mu_q)^2 | q_k, p_k]$\n$$\\sigma_{qq} = E[(h \\sqrt{2 c h} \\, \\xi_{k})^2] = h^2 (2 c h) \\, E[\\xi_k^2] = 2 c h^{3}$$\n\n$\\sigma_{pq} = \\text{Cov}(p_{k+1}, q_{k+1} | q_{k}, p_{k}) = E[(p_{k+1} - \\mu_p)(q_{k+1} - \\mu_q) | q_k, p_k]$\n$$\\sigma_{pq} = E[(\\sqrt{2 c h} \\, \\xi_{k}) (h \\sqrt{2 c h} \\, \\xi_{k})] = h (2 c h) \\, E[\\xi_k^2] = 2 c h^{2}$$\n\n协方差矩阵是对称的，因此 $\\sigma_{qp} = \\sigma_{pq} = 2 c h^{2}$。\n\n条件协方差矩阵为：\n$$\\Sigma = \\begin{pmatrix} 2 c h^{3}  2 c h^{2} \\\\ 2 c h^{2}  2 c h \\end{pmatrix}$$\n\n#### 结果总结\n\n给定 $(q_{k}, p_{k})$ 时，$(q_{k+1}, p_{k+1})$ 的条件分布是一个二元正态分布 $\\mathcal{N}(\\mu, \\Sigma)$。\n\n均值向量的分量是：\n- $\\mu_{q} = (1 - A h^{2}) q_{k} + h(1 - c h) p_{k}$\n- $\\mu_{p} = -A h q_{k} + (1 - c h) p_{k}$\n\n协方差矩阵的条目是：\n- $\\sigma_{qq} = 2 c h^{3}$\n- $\\sigma_{qp} = 2 c h^{2}$\n- $\\sigma_{pq} = 2 c h^{2}$\n- $\\sigma_{pp} = 2 c h$\n\n这六个标量构成了最终答案，并按要求排序。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n(1 - A h^{2}) q_{k} + h(1 - c h) p_{k}  -A h q_{k} + (1 - c h) p_{k}  2 c h^{3}  2 c h^{2}  2 c h^{2}  2 c h\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "在实践中应用 SGHMC 的一个核心挑战是调整其超参数，尤其是在注入的人工噪声与随机梯度产生的内在噪声之间取得平衡。本练习将引导您从统计力学原理出发，推导出一个强大的诊断工具——动能温度。您将探索如何利用这一指标来判断算法是否被正确校准，从而为实际应用提供重要的调试依据。",
            "id": "3349082",
            "problem": "考虑随机梯度哈密顿蒙特卡洛（SGHMC），该方法通过增加摩擦和随机强迫来增强哈密顿蒙特卡洛（HMC），以抵消随机梯度噪声。设位置 $q \\in \\mathbb{R}^d$ 上的目标密度与 $\\exp(-U(q))$ 成正比，哈密顿量为 $H(q,p) = U(q) + \\tfrac{1}{2} p^{\\top} M^{-1} p$，其中 $M \\in \\mathbb{R}^{d \\times d}$ 是对称正定质量矩阵。在连续时间内，动量 $p$ 根据一个随机微分方程（SDE）演化，该方程结合了哈密顿方程、线性摩擦以及来自人工注入噪声和随机梯度误差的随机驱动。为便于分析，假设采用以下各向同性设置：$M = m I_d$（$m > 0$），摩擦 $C = c I_d$（$c > 0$），并且随机梯度噪声可以近似建模为均值为零、单位时间协方差为 $2 b I_d$ 的白噪声，其中 $b \\ge 0$。该算法使用 $b$ 的一个估计值 $\\hat b \\ge 0$ 来设置注入的扩散，使得净扩散旨在重现所需的 $p$ 的正则边缘分布。\n\n受平衡统计力学的启发，将边缘动能温度定义为标量泛函 $\\mathbb{E}\\!\\left[p^{\\top} M^{-1} p\\right]/d$，其中 $d$ 是维度。你需要构建一个基于沿 SGHMC 轨迹对此量进行时间平均的实用诊断方法，并从第一性原理出发，推断其与 $1$ 的偏差如何反映梯度噪声估计 $\\hat b$ 中的校准误差。\n\n从正确校准下动量边缘分布的正则形式出发，并仅使用上述各向同性假设下动量的线性Ornstein–Uhlenbeck动力学的基本性质，判断以下哪个陈述正确地指定了一个一致的诊断方法及其关于 $\\hat b$ 对 $b$ 的低估与高估的解释。\n\nA. 将诊断量定义为沿马尔可夫链收集的移动平均 $\\hat T = \\tfrac{1}{K} \\sum_{k=1}^{K} \\tfrac{1}{d} p_k^{\\top} M^{-1} p_k$。在各向同性设置和小步长极限下，$\\mathbb{E}[\\hat T]$ 等于一个有效温度，该温度随 $b - \\hat b$ 相对于 $c$ 线性增加，因此 $\\hat T > 1$ 表明注入的扩散相对于真实的梯度噪声太小（即 $\\hat b  b$），而 $\\hat T  1$ 表明 $\\hat b > b$。可以调整 $\\hat b$（或增加 $c$）以将 $\\hat T$ 驱动回 $1$。\n\nB. 将诊断量定义为 $\\hat T = \\tfrac{1}{K} \\sum_{k=1}^{K} \\tfrac{1}{d} p_k^{\\top} p_k$，忽略质量矩阵。在正确校准下，它总是等于 $1$，任何与 $1$ 的偏差仅由蒙特卡洛误差引起，并且与 $\\hat b$ 无关。\n\nC. 使用哈密顿量的移动平均 $\\tfrac{1}{K} \\sum_{k=1}^{K} H(q_k,p_k)$ 作为诊断量；如果它大于 $1$，则梯度噪声估计过大（即 $\\hat b > b$），如果小于 $1$，则 $\\hat b  b$。\n\nD. 在类HMC采样器中，无论摩擦 $c$ 和噪声校准如何，边缘动能温度都等于 $1$，因此它不能诊断 $b$ 和 $\\hat b$ 之间的任何不匹配。",
            "solution": "我们从正确校准下的正则动量边缘分布开始。在正确校准的SGHMC中，平稳联合分布与 $\\exp(-H(q,p))$ 成正比，它可以分解为 $q$ 和 $p$ 的乘积形式 $\\exp(-U(q)) \\exp\\!\\left(-\\tfrac{1}{2} p^{\\top} M^{-1} p\\right)$。因此，动量边缘分布是均值为零、协方差为 $M$ 的高斯分布。因此，边缘动能温度等于\n$$\n\\frac{\\mathbb{E}\\!\\left[p^{\\top} M^{-1} p\\right]}{d} \\;=\\; \\frac{\\operatorname{tr}\\!\\left(M^{-1} \\operatorname{Cov}(p)\\right)}{d} \\;=\\; \\frac{\\operatorname{tr}(I_d)}{d} \\;=\\; 1.\n$$\n这提供了基准：在正确校准下，动能温度等于 $1$。\n\n接下来我们考虑校准不当如何改变动量动力学。在各向同性假设 $M = m I_d$，$C = c I_d$ 下，随机梯度噪声建模为单位时间内均值为零、协方差为 $2 b I_d$ 的白噪声，并使用估计值 $\\hat b$ 设置注入的扩散，动量SDE可以写为\n$$\n\\mathrm{d} p \\;=\\; - \\nabla U(q)\\, \\mathrm{d} t \\;-\\; c m^{-1} p\\, \\mathrm{d} t \\;+\\; \\sqrt{2\\,(c - \\hat b)}\\, \\mathrm{d} W_0 \\;+\\; \\sqrt{2\\, b}\\, \\mathrm{d} W_1,\n$$\n其中 $W_0$ 和 $W_1$ 是独立的标准 $d$ 维维纳过程。聚合独立的高斯扰动得到一个等价的表示\n$$\n\\mathrm{d} p \\;=\\; - \\nabla U(q)\\, \\mathrm{d} t \\;-\\; c m^{-1} p\\, \\mathrm{d} t \\;+\\; \\sqrt{2\\,\\big(c + (b - \\hat b)\\big)}\\, \\mathrm{d} \\widetilde{W},\n$$\n其中 $\\widetilde{W}$ 是一个标准的 $d$ 维维纳过程，前提是 $c - \\hat b \\ge 0$ 以确保适定性。项 $- \\nabla U(q)\\, \\mathrm{d} t$ 与 $q$ 耦合，但 $p$ 的线性部分是一个Ornstein–Uhlenbeck（OU）分量。为了分析平稳动量边缘分布，我们利用正则目标中通常的分离特性：期望的动量边缘分布独立于 $q$，而OU分量控制着 $p$ 的协方差。\n\n形式上，在各向同性设置中，OU部分的平稳协方差 $\\Sigma = \\operatorname{Cov}(p)$ 求解连续时间李雅普诺夫方程\n$$\n\\left(c m^{-1}\\right) \\Sigma \\;+\\; \\Sigma \\left(c m^{-1}\\right) \\;=\\; 2\\,\\big(c + (b - \\hat b)\\big)\\, I_d,\n$$\n该方程可简化为\n$$\n\\frac{2 c}{m} \\,\\Sigma \\;=\\; 2\\,\\big(c + (b - \\hat b)\\big)\\, I_d \\quad \\Longrightarrow \\quad \\Sigma \\;=\\; m \\left(1 + \\frac{b - \\hat b}{c}\\right) I_d.\n$$\n因此，有效动量边缘分布是协方差为 $\\Sigma = T_{\\mathrm{eff}}\\, M$ 的高斯分布，其中标量有效温度为\n$$\nT_{\\mathrm{eff}} \\;=\\; 1 + \\frac{b - \\hat b}{c}.\n$$\n边缘动能温度则满足\n$$\n\\frac{\\mathbb{E}\\!\\left[p^{\\top} M^{-1} p\\right]}{d} \\;=\\; \\frac{\\operatorname{tr}\\!\\left(M^{-1} \\Sigma\\right)}{d} \\;=\\; \\frac{\\operatorname{tr}\\!\\left(M^{-1} \\cdot T_{\\mathrm{eff}}\\, M\\right)}{d} \\;=\\; T_{\\mathrm{eff}} \\;=\\; 1 + \\frac{b - \\hat b}{c}.\n$$\n因此：\n- 如果 $\\hat b = b$，则 $\\mathbb{E}\\!\\left[p^{\\top} M^{-1} p\\right]/d = 1$。\n- 如果 $\\hat b  b$，则 $b - \\hat b > 0$ 并且 $\\mathbb{E}\\!\\left[p^{\\top} M^{-1} p\\right]/d > 1$（马尔可夫链太“热”）。\n- 如果 $\\hat b > b$，则 $b - \\hat b  0$ 并且 $\\mathbb{E}\\!\\left[p^{\\top} M^{-1} p\\right]/d  1$（马尔可夫链太“冷”）。\n\n因此，一个一致的经验诊断方法是沿轨迹计算的时间平均值\n$$\n\\hat T \\;=\\; \\frac{1}{K} \\sum_{k=1}^{K} \\frac{1}{d}\\, p_k^{\\top} M^{-1} p_k,\n$$\n在小步长极限和大的 $K$ 值下，$\\hat T$ 集中在 $1 + \\tfrac{b - \\hat b}{c}$ 附近。它与 $1$ 的偏差指示了校准误差相对于摩擦 $c$ 的符号和大小：大于 $1$ 的值意味着对 $b$ 的低估，而小于 $1$ 的值意味着高估。\n\n现在我们来评估每个选项。\n\n选项A：此选项将 $\\hat T$ 定义为 $\\tfrac{1}{K} \\sum_{k=1}^{K} \\tfrac{1}{d} p_k^{\\top} M^{-1} p_k$，并指出，在各向同性假设和小步长极限下，其期望值等于一个有效温度，该温度随 $b - \\hat b$ 对 $c$ 的比值线性增加，并给出了正确的方向解释：当 $\\hat b  b$ 时 $\\hat T > 1$，当 $\\hat b > b$ 时 $\\hat T  1$。它还指出，可以调整 $\\hat b$（或增加 $c$）以使 $\\hat T$ 回到 $1$。这与我们的推导 $T_{\\mathrm{eff}} = 1 + \\tfrac{b - \\hat b}{c}$ 相符。结论：正确。\n\n选项B：此选项使用 $\\hat T = \\tfrac{1}{K} \\sum \\tfrac{1}{d} p_k^{\\top} p_k$，忽略了 $M$，并声称在正确校准下它等于 $1$ 且与 $\\hat b$ 无关。在正确校准下，$\\operatorname{Cov}(p) = M = m I_d$，所以 $\\mathbb{E}\\!\\left[\\tfrac{1}{d} p^{\\top} p\\right] = \\tfrac{1}{d} \\operatorname{tr}(M) = m$，而不是 $1$（除非 $m=1$）。此外，在校准不当的情况下，期望值会按 $1 + \\tfrac{b - \\hat b}{c}$ 比例缩放，因此它并非与 $\\hat b$ 无关。结论：不正确。\n\n选项C：此选项建议使用哈密顿量的移动平均值，并将其与 $1$ 的偏差解释为与推导相反的符号。哈密顿量既不是无量纲的，也没有归一化到 $1$，其在平稳状态下的平均值不是一个普适常数；此外，所提出的符号映射与 $T_{\\mathrm{eff}} = 1 + \\tfrac{b - \\hat b}{c}$ 相矛盾。结论：不正确。\n\n选项D：该选项断言边缘动能温度始终等于 $1$，与摩擦和校准无关。如前所示，除非 $\\hat b = b$，否则校准不当会导致 $T_{\\mathrm{eff}} \\ne 1$。结论：不正确。",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "任何动力学模拟的长期准确性在很大程度上都取决于所选择的数值积分器。在这个最后的动手实践中，您将亲手实现并比较两种方案：一个基础的欧拉-丸山（Euler-Maruyama）方法，以及一个更先进的、在结构上更优越的 BAOAB 分裂积分器。通过模拟一个非线性系统并测量其总能量的数值偏差，您将直观地理解为什么高级几何积分器对于获得稳健和准确的 SGHMC 模拟结果至关重要。",
            "id": "3349100",
            "problem": "考虑以单位质量和单位逆温度的欠阻尼 Langevin 随机微分方程表述的一维 Stochastic Gradient Hamiltonian Monte Carlo (SGHMC) 动力学：\n$$\n\\mathrm{d}q = p\\,\\mathrm{d}t,\\qquad\n\\mathrm{d}p = -\\nabla U(q)\\,\\mathrm{d}t - \\gamma\\, p\\, \\mathrm{d}t + \\sqrt{2\\gamma}\\,\\mathrm{d}W_t,\n$$\n其中 $q \\in \\mathbb{R}$ 表示位置，$p \\in \\mathbb{R}$ 表示动量，$U(q)$ 是一个光滑势，$\\gamma > 0$ 是摩擦系数，$W_t$ 是一个标准 Wiener 过程。该系统对于 Hamiltonian $H(q,p) = U(q) + \\tfrac{1}{2}p^2$ 存在一个单位逆温度下的 Boltzmann–Gibbs 不变分布，其密度正比于 $\\exp(-H(q,p))$。\n\n为模拟小批量梯度中固有的随机梯度噪声，假设动量方程中的总扩散被分解为一个方差参数为 $\\sigma_g^2$ 的名义随机梯度贡献和一个为保持涨落耗散关系而选择的辅助噪声。在连续时间下，该分解保留了总扩散振幅 $\\sqrt{2\\gamma}$，但其离散时间实现会影响数值偏差。\n\n要求您实现并比较两种数值积分器：\n\n1. 一种基于 Euler–Maruyama (EM) 的一阶显式格式，它通过以下方式在时间步长 $h > 0$ 上离散化动力学：\n$$\nq_{n+1} = q_n + h\\,p_n,\n$$\n$$\np_{n+1} = p_n - h\\,\\nabla U(q_n) - \\gamma\\,h\\,p_n + \\sqrt{\\sigma_g^2\\,h}\\,\\xi_n^{(1)} + \\sqrt{(2\\gamma - \\sigma_g^2)\\,h}\\,\\xi_n^{(2)},\n$$\n其中 $\\xi_n^{(1)},\\xi_n^{(2)} \\sim \\mathcal{N}(0,1)$ 是独立的标准正态随机变量。\n\n2. 一种对称随机 Runge–Kutta (SRK) 分裂格式，该格式对于 Hamiltonian 流是辛的，对于 Ornstein–Uhlenbeck (OU) 恒温器是精确的，通常记为 BAOAB。在一个时间步长 $h > 0$ 内，它由以下子流组成：\n- 半步踢（$B$）：$p \\leftarrow p - \\tfrac{h}{2}\\,\\nabla U(q)$。\n- 半步 OU（$O$）：$p \\leftarrow \\mathrm{e}^{-\\gamma h/2}\\,p + \\sqrt{1 - \\mathrm{e}^{-\\gamma h}}\\,\\xi^{(O_1)}$，其中 $\\xi^{(O_1)} \\sim \\mathcal{N}(0,1)$。\n- 漂移（$A$）：$q \\leftarrow q + h\\,p$。\n- 半步 OU（$O$）：$p \\leftarrow \\mathrm{e}^{-\\gamma h/2}\\,p + \\sqrt{1 - \\mathrm{e}^{-\\gamma h}}\\,\\xi^{(O_2)}$，其中 $\\xi^{(O_2)} \\sim \\mathcal{N}(0,1)$。\n- 半步踢（$B$）：$p \\leftarrow p - \\tfrac{h}{2}\\,\\nabla U(q)$。\n该 SRK 格式对于确定性的 Hamiltonian 部分（$A$ 和 $B$ 流）是辛的，并通过 $O$ 流精确地处理 OU 噪声。\n\n设势为非谐双阱类四次势：\n$$\nU(q) = \\frac{k}{2}\\,q^2 + \\frac{\\lambda}{4}\\,q^4,\n$$\n其中 $k > 0$ 且 $\\lambda > 0$。在单位温度下，Hamiltonian 的精确不变期望为\n$$\n\\mathbb{E}[H] = \\mathbb{E}[U(q)] + \\frac{1}{2},\n$$\n其中 $\\mathbb{E}[U(q)] = \\frac{k}{2}\\,\\mathbb{E}[q^2] + \\frac{\\lambda}{4}\\,\\mathbb{E}[q^4]$，并且\n$$\n\\mathbb{E}[q^m] = \\frac{1}{Z}\\int_{-\\infty}^{\\infty} q^m\\,\\exp\\!\\Big(-\\frac{k}{2}q^2 - \\frac{\\lambda}{4}q^4\\Big)\\,\\mathrm{d}q,\\quad\nZ = \\int_{-\\infty}^{\\infty} \\exp\\!\\Big(-\\frac{k}{2}q^2 - \\frac{\\lambda}{4}q^4\\Big)\\,\\mathrm{d}q.\n$$\n这些积分需要通过高精度数值方法计算。\n\n实现这两种积分器以模拟长时间行为，并在“老化”（burn-in）阶段后，对轨迹的最后一部分估计 $H(q,p)$ 的稳态时间平均值。使用带有固定种子的独立高斯随机数以保证可复现性。将 EM 估计和 BAOAB 估计的绝对偏差与精确值 $\\mathbb{E}[H]$ 进行比较，以证明在存在随机梯度噪声（即 $\\sigma_g^2 > 0$）的情况下，辛 SRK BAOAB 格式具有改进的偏差特性。\n\n使用以下参数集测试套件，其设计旨在覆盖一般情况、小步长边界情况和相对大步长的边缘情况：\n- 测试 1：$k = 1$，$\\lambda = 1$，$\\gamma = 1$，$\\sigma_g^2 = 0.5$，$h = 0.01$，$N = 200000$ 步，老化（burn-in）$20000$ 步，初始 $(q_0,p_0) = (0,0)$，随机种子 $123$。\n- 测试 2：$k = 1$，$\\lambda = 1$，$\\gamma = 1$，$\\sigma_g^2 = 0.5$，$h = 0.005$，$N = 200000$ 步，老化（burn-in）$20000$ 步，初始 $(q_0,p_0) = (0,0)$，随机种子 $456$。\n- 测试 3：$k = 1$，$\\lambda = 1$，$\\gamma = 1$，$\\sigma_g^2 = 0.5$，$h = 0.05$，$N = 200000$ 步，老化（burn-in）$20000$ 步，初始 $(q_0,p_0) = (0,0)$，随机种子 $789$。\n\n对于每个测试，通过数值积分计算两个长时间估计值：$\\widehat{E}_{\\mathrm{EM}}[H]$ 和 $\\widehat{E}_{\\mathrm{BAOAB}}[H]$，以及精确值 $\\mathbb{E}[H]$。对于每个测试用例，输出一个布尔值，表示 BAOAB 的绝对偏差是否严格小于 EM 的绝对偏差：\n$$\n\\big|\\widehat{E}_{\\mathrm{BAOAB}}[H] - \\mathbb{E}[H]\\big|  \\big|\\widehat{E}_{\\mathrm{EM}}[H] - \\mathbb{E}[H]\\big|.\n$$\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，$[result_1,result_2,result_3]$），其中每个 $result_i$ 是对应于测试 $i$ 上述比较的布尔值。",
            "solution": "用户问题要求比较两种用于欠阻尼 Langevin 动力学的积分器的数值偏差：一种是为 Stochastic Gradient Hamiltonian Monte Carlo (SGHMC) 定制的 Euler-Maruyama (EM) 格式，另一种是对称分裂格式 (BAOAB)。\n\n### 步骤 1：问题验证\n\n**1.1. 提取已知信息**\n\n*   **系统动力学（欠阻尼 Langevin SDE）：**\n    对于位置 $q \\in \\mathbb{R}$ 和动量 $p \\in \\mathbb{R}$，质量和逆温度均为单位 1：\n    $$\n    \\mathrm{d}q = p\\,\\mathrm{d}t \\\\\n    \\mathrm{d}p = -\\nabla U(q)\\,\\mathrm{d}t - \\gamma\\, p\\, \\mathrm{d}t + \\sqrt{2\\gamma}\\,\\mathrm{d}W_t\n    $$\n    其中 $\\gamma > 0$ 是摩擦系数，$W_t$ 是一个标准 Wiener 过程。\n\n*   **势能与梯度：**\n    $$\n    U(q) = \\frac{k}{2}\\,q^2 + \\frac{\\lambda}{4}\\,q^4 \\quad (k > 0, \\lambda > 0) \\\\\n    \\nabla U(q) = kq + \\lambda q^3\n    $$\n\n*   **不变分布与 Hamiltonian：**\n    该系统的不变分布密度正比于 $\\exp(-H(q,p))$，其中 Hamiltonian 为：\n    $$\n    H(q,p) = U(q) + \\frac{1}{2}p^2\n    $$\n\n*   **随机梯度噪声模型：**\n    总扩散被分解为一个方差参数为 $\\sigma_g^2$ 的随机梯度分量和一个辅助分量。这在 EM 积分器中有明确使用。\n\n*   **积分器 1：Euler-Maruyama (EM)：**\n    对于时间步长 $h > 0$：\n    $$\n    q_{n+1} = q_n + h\\,p_n \\\\\n    p_{n+1} = p_n - h\\,\\nabla U(q_n) - \\gamma\\,h\\,p_n + \\sqrt{\\sigma_g^2\\,h}\\,\\xi_n^{(1)} + \\sqrt{(2\\gamma - \\sigma_g^2)\\,h}\\,\\xi_n^{(2)}\n    $$\n    其中 $\\xi_n^{(1)}, \\xi_n^{(2)} \\sim \\mathcal{N}(0,1)$ 是独立的。\n\n*   **积分器 2：BAOAB 分裂格式：**\n    在一个时间步长 $h > 0$ 内由五个子流组成：\n    1.  **B (半步踢)：** $p \\leftarrow p - \\tfrac{h}{2}\\,\\nabla U(q)$\n    2.  **O (半步 OU)：** $p \\leftarrow \\mathrm{e}^{-\\gamma h/2}\\,p + \\sqrt{1 - \\mathrm{e}^{-\\gamma h}}\\,\\xi^{(O_1)}$，其中 $\\xi^{(O_1)} \\sim \\mathcal{N}(0,1)$\n    3.  **A (漂移)：** $q \\leftarrow q + h\\,p$\n    4.  **O (半步 OU)：** $p \\leftarrow \\mathrm{e}^{-\\gamma h/2}\\,p + \\sqrt{1 - \\mathrm{e}^{-\\gamma h}}\\,\\xi^{(O_2)}$，其中 $\\xi^{(O_2)} \\sim \\mathcal{N}(0,1)$\n    5.  **B (半步踢)：** $p \\leftarrow p - \\tfrac{h}{2}\\,\\nabla U(q)$\n\n*   **Hamiltonian 的精确期望：**\n    $$\n    \\mathbb{E}[H] = \\mathbb{E}[U(q)] + \\frac{1}{2}\n    $$\n    其中 $\\mathbb{E}[q^m] = \\frac{\\int_{-\\infty}^{\\infty} q^m \\exp(-U(q)) \\mathrm{d}q}{\\int_{-\\infty}^{\\infty} \\exp(-U(q)) \\mathrm{d}q}$。这些积分需要通过高精度数值积分计算。\n\n*   **任务：**对于每个测试用例，比较两种积分器估计的 Hamiltonian 期望的绝对偏差：\n    $$\n    \\big|\\widehat{E}_{\\mathrm{BAOAB}}[H] - \\mathbb{E}[H]\\big|  \\big|\\widehat{E}_{\\mathrm{EM}}[H] - \\mathbb{E}[H]\\big|\n    $$\n\n*   **测试用例：**\n    *   **测试 1：**$k = 1, \\lambda = 1, \\gamma = 1, \\sigma_g^2 = 0.5, h = 0.01, N = 200000, \\text{burnin} = 20000, (q_0,p_0) = (0,0), \\text{seed} = 123$。\n    *   **测试 2：**$k = 1, \\lambda = 1, \\gamma = 1, \\sigma_g^2 = 0.5, h = 0.005, N = 200000, \\text{burnin} = 20000, (q_0,p_0) = (0,0), \\text{seed} = 456$。\n    *   **测试 3：**$k = 1, \\lambda = 1, \\gamma = 1, \\sigma_g^2 = 0.5, h = 0.05, N = 200000, \\text{burnin} = 20000, (q_0,p_0) = (0,0), \\text{seed} = 789$。\n\n**1.2. 使用提取的已知信息进行验证**\n\n*   **科学基础：**该问题牢固地植根于统计力学和计算物理学。欠阻尼 Langevin SDE 是一个基本模型。SGHMC 虽然在此处的表述非标准，但是机器学习和统计学中公认的方法。BAOAB 格式是用于此类系统的先进积分器。所有原理都是合理的。\n*   **适定性：**所有参数、初始条件和数值步骤都有明确定义。目标是一个清晰的定量比较。\n*   **客观性：**该问题以精确的数学术语陈述，没有主观论断。\n*   **歧义检查：**一个潜在的歧义源于参数 $\\sigma_g^2$ 出现在 EM 积分器的定义中，但未出现在 BAOAB 积分器的定义中。然而，这可以通过字面解释来解决：问题定义了两种要比较的、截然不同的数值算法。EM 格式是一种特定的 SGHMC 类型积分器，而 BAOAB 格式是一种标准的（且更优越的）Langevin 积分器。这种比较展示了后者即使与一种为特定噪声源建模而明确设计的方法相比，也具有更好的鲁棒性和更低的偏差。在所有情况下，连续时间动力学是等价的，因此比较是有意义的。因此，该问题被认为是自洽的，没有关键性的歧义。\n\n**1.3. 结论与行动**\n\n问题有效。将提供完整的解决方案。\n\n### 步骤 2：解决方案设计\n\n解决方案将按以下结构组织：\n\n1.  **精确的 Hamiltonian 期望：**将创建一个函数来计算精确期望值 $\\mathbb{E}[H]$。这涉及使用数值积分（`scipy.integrate.quad`）来计算 $\\mathbb{E}[q^2]$ 和 $\\mathbb{E}[q^4]$ 所需的积分。势 $U(q)$ 是对称的，这简化了积分过程。最终的精确值为 $\\mathbb{E}[H] = \\frac{k}{2}\\mathbb{E}[q^2] + \\frac{\\lambda}{4}\\mathbb{E}[q^4] + \\frac{1}{2}$。\n\n2.  **EM 模拟器：**将创建一个函数，按规定实现 Euler-Maruyama 积分器。它将接受一组参数，在 $(q_0, p_0)$ 处初始化系统，并使用给定的更新方程演化 $N$ 步。一个带种子的随机数生成器将提供随机项 $\\xi_n^{(1)}$ 和 $\\xi_n^{(2)}$。在“老化”（burn-in）期后，将累加 Hamiltonian $H(q_n, p_n)$ 的值，并将其平均值作为 $\\widehat{E}_{\\mathrm{EM}}[H]$ 返回。\n\n3.  **BAOAB 模拟器：**将创建一个函数来实现 B-O-A-O-B 积分器。它按指定顺序迭代应用五个子步骤。最后一个“B”步骤中的力评估使用“A”步骤更新后的位置。OU 的“O”步骤使用独立的随机数。与 EM 模拟器类似，它将运行 $N$ 步，丢弃一个“老化”（burn-in）期，并计算时间平均的 Hamiltonian $\\widehat{E}_{\\mathrm{BAOAB}}[H]$。对于给定的测试用例，为了公平比较，将使用与 EM 模拟中相同的随机种子。根据所提供的积分器定义，参数 $\\sigma_g^2$ 不被使用。\n\n4.  **主执行循环：**程序的主要部分将遍历三个测试用例。对于每个用例，它将：a. 调用函数计算精确的 $\\mathbb{E}[H]$。b. 运行 EM 和 BAOAB 模拟器以获得各自的估计值。c. 为每个估计值计算绝对偏差：$|\\widehat{E} - \\mathbb{E}[H]|$。d. 按照问题陈述的要求执行布尔比较。e. 存储布尔结果。\n\n5.  **输出格式化：**最终的布尔结果列表将被格式化为指定的字符串格式：`[result_1,result_2,result_3]`。\n\n这种结构化的方法确保了问题的所有组成部分都得到正确处理，并引导至最终的实现。",
            "answer": "```python\nimport numpy as np\nfrom scipy.integrate import quad\n\ndef solve():\n    \"\"\"\n    Implements and compares EM and BAOAB integrators for SGHMC dynamics.\n    \"\"\"\n\n    test_cases = [\n        {'k': 1.0, 'lambda': 1.0, 'gamma': 1.0, 'sigma_g2': 0.5, 'h': 0.01, 'N': 200000, 'burnin': 20000, 'q0': 0.0, 'p0': 0.0, 'seed': 123},\n        {'k': 1.0, 'lambda': 1.0, 'gamma': 1.0, 'sigma_g2': 0.5, 'h': 0.005, 'N': 200000, 'burnin': 20000, 'q0': 0.0, 'p0': 0.0, 'seed': 456},\n        {'k': 1.0, 'lambda': 1.0, 'gamma': 1.0, 'sigma_g2': 0.5, 'h': 0.05, 'N': 200000, 'burnin': 20000, 'q0': 0.0, 'p0': 0.0, 'seed': 789},\n    ]\n\n    results = []\n\n    def calculate_exact_H(k, lamb):\n        \"\"\"Computes the exact expectation of the Hamiltonian via numerical quadrature.\"\"\"\n        \n        def boltzmann_integrand(q, moment):\n            U = 0.5 * k * q**2 + 0.25 * lamb * q**4\n            return q**moment * np.exp(-U)\n\n        # Normalization constant Z\n        Z, _ = quad(boltzmann_integrand, -np.inf, np.inf, args=(0,))\n        \n        # Expectation of q^2\n        I_2, _ = quad(boltzmann_integrand, -np.inf, np.inf, args=(2,))\n        E_q2 = I_2 / Z\n        \n        # Expectation of q^4\n        I_4, _ = quad(boltzmann_integrand, -np.inf, np.inf, args=(4,))\n        E_q4 = I_4 / Z\n        \n        # Expectation of potential energy U\n        E_U = 0.5 * k * E_q2 + 0.25 * lamb * E_q4\n        \n        # Expectation of kinetic energy is 1/2 for unit temperature and mass\n        E_K = 0.5\n        \n        return E_U + E_K\n\n    def em_simulator(params):\n        \"\"\"Simulates the dynamics using the Euler-Maruyama scheme.\"\"\"\n        k, lamb = params['k'], params['lambda']\n        gamma, sigma_g2, h = params['gamma'], params['sigma_g2'], params['h']\n        N, burnin = params['N'], params['burnin']\n        \n        rng = np.random.default_rng(params['seed'])\n        q, p = params['q0'], params['p0']\n        \n        H_sum = 0.0\n        \n        noise_std1 = np.sqrt(sigma_g2 * h)\n        noise_std2 = np.sqrt((2 * gamma - sigma_g2) * h)\n\n        for i in range(N):\n            grad_U = k * q + lamb * q**3\n            \n            p_new = p - h * grad_U - gamma * h * p + \\\n                    noise_std1 * rng.normal() + noise_std2 * rng.normal()\n            q_new = q + h * p\n            \n            q, p = q_new, p_new\n\n            if i >= burnin:\n                U = 0.5 * k * q**2 + 0.25 * lamb * q**4\n                K = 0.5 * p**2\n                H_sum += (U + K)\n                \n        return H_sum / (N - burnin)\n\n    def baoab_simulator(params):\n        \"\"\"Simulates the dynamics using the BAOAB splitting scheme.\"\"\"\n        k, lamb = params['k'], params['lambda']\n        gamma, h = params['gamma'], params['h']\n        N, burnin = params['N'], params['burnin']\n\n        rng = np.random.default_rng(params['seed'])\n        q, p = params['q0'], params['p0']\n        \n        H_sum = 0.0\n        \n        exp_gamma_h2 = np.exp(-gamma * h / 2.0)\n        noise_std = np.sqrt(1.0 - np.exp(-gamma * h))\n\n        for i in range(N):\n            # B: Half kick\n            p = p - 0.5 * h * (k * q + lamb * q**3)\n            \n            # O: Half OU\n            p = exp_gamma_h2 * p + noise_std * rng.normal()\n            \n            # A: Drift\n            q = q + h * p\n            \n            # O: Half OU\n            p = exp_gamma_h2 * p + noise_std * rng.normal()\n            \n            # B: Half kick (using updated q)\n            p = p - 0.5 * h * (k * q + lamb * q**3)\n\n            if i >= burnin:\n                U = 0.5 * k * q**2 + 0.25 * lamb * q**4\n                K = 0.5 * p**2\n                H_sum += (U + K)\n\n        return H_sum / (N - burnin)\n\n    for case in test_cases:\n        E_H_exact = calculate_exact_H(case['k'], case['lambda'])\n        \n        E_H_em = em_simulator(case)\n        E_H_baoab = baoab_simulator(case)\n        \n        bias_em = abs(E_H_em - E_H_exact)\n        bias_baoab = abs(E_H_baoab - E_H_exact)\n        \n        # Append boolean result, converted to lowercase string\n        results.append(str(bias_baoab  bias_em).lower())\n\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        }
    ]
}