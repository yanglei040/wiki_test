{
    "hands_on_practices": [
        {
            "introduction": "这个首个练习将帮助你建立对“弹性粒子采样器”（BPS）的基础理解。通过分析一个二次势能函数（对应于高斯目标分布），我们可以解析地推导出精确的事件时间和速度更新规则。这项实践将在一个清晰、易于处理的环境中，为你构建关于分段确定性马尔可夫过程（PDMP）核心力学的直观认识。",
            "id": "3323706",
            "problem": "考虑在 $\\mathbb{R}^{d}$ 上，针对一个与 $\\exp(-U(x))$ 成正比的目标密度，使用弹跳粒子采样器。其中 $U(x)=\\frac{1}{2}x^{\\top}A x$，且 $A$ 是对称正定矩阵。该采样器是一个分段确定性马尔可夫过程（PDMP），在事件之间，其流（flow）为 $\\dot{x}=v$ 和 $\\dot{v}=0$。事件（弹跳）发生率为 $\\lambda(x,v)=\\max\\{0, v^{\\top}\\nabla U(x)\\}$。在事件发生时，速度会发生镜面反射，反射面是与 $\\nabla U(x)$ 正交的超平面。此反射保留了 $v$ 平行于 $U$ 等值面的分量，并反转了垂直于 $\\nabla U(x)$ 的分量。\n\n1. 仅使用关于法向量为 $\\nabla U(x)$ 的超平面的镜面反射的几何特征，推导弹跳后速度 $v'$ 关于 $x$ 和 $v$ 的显式表达式。\n\n2. 设过程从 $(x(0),v(0))=(x_{0},v)$ 开始，其中 $x_{0}\\in\\mathbb{R}^{d}$，$v\\in\\mathbb{R}^{d}$，且满足 $v^{\\top}A x_{0}>0$ 和 $v^{\\top}A v>0$。利用事件率的定义和确定性流，推导第一次事件时间 $\\tau$ 的显式逆变换采样公式，将其表示为一个关于单位率指数随机变量 $E$ 的确定性函数。你的推导必须从速率为 $t\\mapsto \\lambda(x(t),v(t))$ 的非齐次泊松过程的定义以及积分风险率的基本变量代换原理出发。将 $\\tau$ 的最终公式表示为关于 $A$、$x_{0}$、$v$ 和 $E$ 的闭式解析表达式。\n\n将你的最终答案表述为 $\\tau$ 关于 $A$、$x_{0}$、$v$ 和 $E$ 的单一显式表达式。无需进行数值计算。",
            "solution": "该问题被评定为有效，因为它具有科学依据、提法明确且客观。它包含两个部分，均关于针对多元高斯目标分布的弹跳粒子采样器（BPS）。我们将依次解决这两个部分。\n\n目标概率密度对于 $x \\in \\mathbb{R}^{d}$ 与 $\\exp(-U(x))$ 成正比，其中势能由 $U(x) = \\frac{1}{2}x^{\\top}A x$ 给出。矩阵 $A$ 被指定为对称正定矩阵。势能的梯度为 $\\nabla U(x) = Ax$，这个梯度将频繁使用。BPS 根据状态 $(x(t), v(t))$ 演化，在离散的弹跳事件之间具有确定性动力学。其流定义为 $\\dot{x}(t) = v(t)$ 和 $\\dot{v}(t) = 0$，这意味着在事件之间粒子以恒定速度进行线性运动。这些事件的发生率为 $\\lambda(x,v) = \\max\\{0, v^{\\top}\\nabla U(x)\\}$。\n\n第一部分：推导弹跳后速度。\n问题将弹跳事件描述为速度向量 $v$ 跨越一个与梯度向量 $\\nabla U(x)$ 正交的超平面的镜面反射。这意味着 $v$ 平行于 $\\nabla U(x)$ 的分量被反转，而与 $\\nabla U(x)$ 正交的分量保持不变。\n\n设 $n = \\nabla U(x) = Ax$ 为位置 $x$ 处反射超平面的法向量。我们可以将入射速度向量 $v$ 分解为两个分量：与 $n$ 平行的 $v_{\\parallel}$ 和与 $n$ 垂直的 $v_{\\perp}$。\n$$v = v_{\\parallel} + v_{\\perp}$$\n与 $n$ 平行的分量是 $v$ 在 $n$ 上的正交投影：\n$$v_{\\parallel} = \\frac{v^{\\top}n}{n^{\\top}n} n$$\n与 $n$ 垂直的分量则由下式给出：\n$$v_{\\perp} = v - v_{\\parallel} = v - \\frac{v^{\\top}n}{n^{\\top}n} n$$\n根据镜面反射的规则，弹跳后的速度 $v'$ 是通过反转平行分量并保持垂直分量不变得到的：\n$$v' = v_{\\perp} - v_{\\parallel} = \\left(v - v_{\\parallel}\\right) - v_{\\parallel} = v - 2v_{\\parallel}$$\n代入 $v_{\\parallel}$ 的表达式，我们得到：\n$$v' = v - 2 \\frac{v^{\\top}n}{n^{\\top}n} n$$\n最后，代入 $n = Ax$，我们获得弹跳后速度 $v'$ 关于 $x$、$v$ 和 $A$ 的显式表达式：\n$$v' = v - 2 \\frac{v^{\\top}(Ax)}{(Ax)^{\\top}(Ax)} (Ax) = v - 2 \\frac{v^{\\top}Ax}{x^{\\top}A^{\\top}Ax} Ax$$\n因为 $A$ 是对称的（$A^{\\top}=A$），这可以写作：\n$$v' = v - 2 \\frac{v^{\\top}Ax}{x^{\\top}A^2 x} Ax$$\n至此完成了第一部分的推导。\n\n第二部分：推导第一次事件时间 $\\tau$。\n我们的任务是使用逆变换采样法推导一个用于采样第一次事件时间 $\\tau$ 的公式。过程从 $(x(0), v(0)) = (x_0, v)$ 开始。在事件之间，粒子的位置演化为 $x(t) = x_0 + vt$。速度 $v$ 保持不变。\n\n在时间 $t$ 的事件率为 $\\lambda(t) = \\lambda(x(t), v)$。我们将 $x(t)$ 的表达式代入率函数中：\n$$\\lambda(t) = \\max\\{0, v^{\\top}\\nabla U(x(t))\\} = \\max\\{0, v^{\\top}A(x_0 + vt)\\}$$\n展开最大值函数内的项得到：\n$$\\lambda(t) = \\max\\{0, v^{\\top}Ax_0 + t(v^{\\top}Av)\\}$$\n问题给出的初始条件是 $v^{\\top}Ax_0 > 0$ 和 $v^{\\top}Av > 0$。我们定义常数 $a = v^{\\top}Ax_0$ 和 $b = v^{\\top}Av$。根据这些定义，$a>0$ 且 $b>0$。对于 $t \\ge 0$，率函数简化为：\n$$\\lambda(t) = a + bt$$\n对于一个速率为 $\\lambda(t)$ 的非齐次泊松过程，其第一次事件时间 $\\tau$ 可以使用逆变换法进行采样。其基本原理是，到时间 $\\tau$ 为止的积分风险率 $\\Lambda(\\tau)$ 服从标准指数分布。设 $E$ 是从一个率为 $1$ 的指数分布中抽取的随机变量。那么我们必须解方程 $\\Lambda(\\tau) = E$ 来求 $\\tau$。\n\n积分风险率函数 $\\Lambda(t)$ 是率函数从 $0$ 到 $t$ 的积分：\n$$\\Lambda(t) = \\int_0^t \\lambda(s) ds = \\int_0^t (a + bs) ds = \\left[as + \\frac{1}{2}bs^2\\right]_0^t = at + \\frac{1}{2}bt^2$$\n令 $\\Lambda(\\tau) = E$，我们得到一个关于 $\\tau$ 的二次方程：\n$$a\\tau + \\frac{1}{2}b\\tau^2 = E$$\n整理成标准形式：\n$$\\frac{b}{2}\\tau^2 + a\\tau - E = 0$$\n我们使用二次方程求根公式来解这个关于 $\\tau$ 的方程：\n$$\\tau = \\frac{-a \\pm \\sqrt{a^2 - 4\\left(\\frac{b}{2}\\right)(-E)}}{2\\left(\\frac{b}{2}\\right)} = \\frac{-a \\pm \\sqrt{a^2 + 2bE}}{b}$$\n由于 $\\tau$ 代表时间，它必须是非负的。我们已知 $a > 0$ 和 $b > 0$，且 $E$ 是一个非负随机变量。平方根下的项 $\\sqrt{a^2 + 2bE}$ 总是大于或等于 $\\sqrt{a^2} = a$。\n对应于减号的根 $\\frac{-a - \\sqrt{a^2 + 2bE}}{b}$ 总是非正的。\n对应于加号的根 $\\frac{-a + \\sqrt{a^2 + 2bE}}{b}$ 总是非负的。\n因此，具有物理意义的事件时间 $\\tau$ 的解是：\n$$\\tau = \\frac{-a + \\sqrt{a^2 + 2bE}}{b}$$\n将 $a$ 和 $b$ 的表达式用 $A$、$x_0$ 和 $v$ 代回：\n$$\\tau = \\frac{-(v^{\\top}Ax_0) + \\sqrt{(v^{\\top}Ax_0)^2 + 2(v^{\\top}Av)E}}{v^{\\top}Av}$$\n这就是第一次事件时间 $\\tau$ 的最终闭式表达式。",
            "answer": "$$\n\\boxed{\\frac{-(v^{\\top}Ax_{0}) + \\sqrt{(v^{\\top}Ax_{0})^{2} + 2(v^{\\top}Av)E}}{v^{\\top}Av}}\n$$"
        },
        {
            "introduction": "对于更一般的势能函数，精确地模拟事件时间通常是不可行的。这项实践将介绍一种强大的“稀疏化”（thinning）技术，它允许我们通过从一个更简单、易于处理的真实事件率上界来提议事件，从而实现模拟。我们将推导并实现一个基于梯度利普希茨连续性的线性上界，这是使BPS在实际应用中变得可行的一个基本工具。",
            "id": "3323688",
            "problem": "考虑一个连续可微的势 $U:\\mathbb{R}^d\\to\\mathbb{R}$，其梯度 $\\nabla U$ 是全局利普希茨（Lipschitz）的，利普希茨常数为 $L>0$，意即对所有 $x,y\\in\\mathbb{R}^d$ 都有 $\\|\\nabla U(x)-\\nabla U(y)\\| \\le L\\|x-y\\|$。在弹性粒子采样器（Bouncy Particle Sampler, BPS）中——一种用于非可逆马尔可夫链蒙特卡洛（Markov Chain Monte Carlo, MCMC）的分段确定性马尔可夫过程（Piecewise Deterministic Markov Process, PDMP）——在状态 $(x,v)$ 下的事件发生率为 $\\lambda(x,v)=\\max\\{0,\\,v \\cdot \\nabla U(x)\\}$，其中 $v\\in\\mathbb{R}^d$ 是速度向量。沿着确定性轨迹 $x(t)=x_0+t\\,v$，瞬时事件发生率变为 $\\lambda(t)=\\max\\{0,\\,v \\cdot \\nabla U(x_0+t\\,v)\\}$。\n\n从利普希茨性质和沿直线的微积分基础出发，为发生率 $\\lambda(t)$ 推导一个上包络 $\\bar{r}(t)$，该包络适用于基于标准“稀疏化”（thinning-based）的首次事件时间模拟。具体要求如下：\n\n1. 使用 $\\nabla U$ 的利普希茨性质和方向导数的定义，得到一个形如 $v \\cdot \\nabla U(x_0+t\\,v) \\le a+b\\,t$ 的界。您必须根据 $x_0$、$v$、$L$ 和 $\\nabla U(x_0)$ 明确定义常数 $a$ 和 $b$。然后定义包络函数 $\\bar{r}(t)=\\max\\{0,\\,a+b\\,t\\}$，并根据 $a+b\\,t$ 变号的时间点，精确描述其分段结构。\n\n2. 提供积分包络 $\\bar{R}(t)=\\int_0^t\\bar{r}(s)\\,ds$ 随时间变化的显式公式，强调其分段二次形式，并展示如何通过反解 $\\bar{R}$，在给定指数变量 $E>0$（$E$ 为无量纲）的情况下，求解第一个提议的事件时间 $t$。您的反解公式必须能处理对应于 $a\\ge 0$ 和 $a < 0$ 的两种分支情况。\n\n3. 给出当包络在新的锚点 $x_{\\mathrm{anc}}=x_0+s\\,v$ 处刷新时的界更新区间的显式公式。定义区间长度 $\\delta$，在此区间上 $\\bar{r}$ 在变为正值之前恒为零。用 $L$、$v$ 和 $v \\cdot \\nabla U(x_{\\mathrm{anc}})$ 表示 $\\delta$。\n\n您的程序必须实现这些构造，并在以下 $d=2$ 维的二次势 $U(x)=\\tfrac{1}{2}x^\\top A x$（其中 $A$ 为对称矩阵）的测试套件上验证其正确性：\n\n- 对于每个测试矩阵，利普希茨常数是海森矩阵的算子范数，即 $L=\\|A\\|_2$，对于对称矩阵 $A$，这等于最大绝对值特征值。\n\n使用以下测试用例：\n\n- 测试 1（一般情况）：$A=\\mathrm{diag}(3.0,1.0)$，$x_0=(1.0,-0.5)$，$v=(0.6,-0.8)$。验证对于 101 个均匀分布在 $[0,1]$ 区间内的 $t$，都有 $\\bar{r}(t)\\ge \\lambda(t)$。输出为一个布尔值。\n\n- 测试 2（负截距和界更新区间）：$A=\\mathrm{diag}(2.0,2.0)$，$x_0=(-0.2,0.1)$，$v=(0.5,0.5)$。计算界更新区间长度 $\\delta=\\max\\{0,\\,-a/b\\}$，其中 $a=v \\cdot \\nabla U(x_0)$ 且 $b=L\\|v\\|^2$。输出为一个浮点数。使用与 PDMP 中的时间一致的单位（无量纲）。\n\n- 测试 3（带初始零分支的积分包络反解）：重用测试 2 的设置，并通过求解 $\\bar{R}(t)=E$（其中 $E=0.05$）来计算第一个提议的事件时间。输出为一个浮点数。\n\n- 测试 4（不定二次势但梯度全局利普希茨）：$A=\\mathrm{diag}(3.0,-2.0)$，$x_0=(0.4,0.6)$，$v=(0.5,-0.3)$。验证对于 101 个均匀分布在 $[0,1]$ 区间内的 $t$，都有 $\\bar{r}(t)\\ge \\lambda(t)$。输出为一个布尔值。\n\n- 测试 5（当 $v$ 与最大特征值方向对齐时包络紧密）：$A=\\mathrm{diag}(5.0,1.0)$，$x_0=(0.2,0.1)$，$v=(1.0,0.0)$。计算比率 $\\bar{R}(1)/\\int_0^1\\lambda(s)\\,ds$。输出为一个浮点数。\n\n您的程序应生成单行输出，其中包含用方括号括起来的、以逗号分隔的结果列表（例如，“[result1,result2,result3,result4,result5]”）。",
            "solution": "问题陈述被评估为具有科学依据、问题明确且客观。它基于马尔可夫链蒙特卡洛方法的既定原理，特别是弹性粒子采样器（Bouncy Particle Sampler），以及用于其分析的数学工具，如利普希茨连续性和通过“稀疏化”（thinning）进行的模拟。任务的规定足够详细和严谨，能够得到唯一且可验证的解。因此，我们可以进行推导和实现。\n\n问题的核心是为沿线性轨迹 $x(t) = x_0+tv$ 的 BPS 事件发生率 $\\lambda(t) = \\max\\{0, v \\cdot \\nabla U(x_0+tv)\\}$ 构建一个易于处理的上界。这个记为 $\\bar{r}(t)$ 的界，便于使用“稀疏化”模拟事件时间。\n\n### 第1部分：上包络 $\\bar{r}(t)$ 的推导\n\n我们的目标是为量 $g(t) = v \\cdot \\nabla U(x_0+tv)$ 找到一个线性上界。我们首先将 $g(t)$ 用其在 $t=0$ 处的值来表示：\n$$g(t) = v \\cdot \\nabla U(x_0) + v \\cdot \\left( \\nabla U(x_0+tv) - \\nabla U(x_0) \\right)$$\n通过对第二项应用柯西-施瓦茨（Cauchy-Schwarz）不等式，我们得到：\n$$v \\cdot \\left( \\nabla U(x_0+tv) - \\nabla U(x_0) \\right) \\le \\|v\\| \\cdot \\| \\nabla U(x_0+tv) - \\nabla U(x_0) \\|$$\n问题陈述指出梯度 $\\nabla U$ 是全局利普希茨的，常数为 $L>0$。将此性质应用于位置 $x = x_0+tv$ 和 $y=x_0$，我们有：\n$$\\| \\nabla U(x_0+tv) - \\nabla U(x_0) \\| \\le L \\|(x_0+tv) - x_0\\| = L \\|tv\\| = L|t| \\|v\\|$$\n对于时间正向演化，我们考虑 $t \\ge 0$，因此 $|t|=t$。结合这些不等式，得到：\n$$v \\cdot \\left( \\nabla U(x_0+tv) - \\nabla U(x_0) \\right) \\le \\|v\\| \\cdot (L t \\|v\\|) = L\\|v\\|^2 t$$\n将此代回 $g(t)$ 的表达式：\n$$v \\cdot \\nabla U(x_0+tv) \\le v \\cdot \\nabla U(x_0) + L\\|v\\|^2 t$$\n这就得到了 $v \\cdot \\nabla U(x_0+tv)$ 的一个线性上界。我们定义常数 $a$ 和 $b$ 为：\n$$a = v \\cdot \\nabla U(x_0)$$\n$$b = L\\|v\\|^2$$\n根据这些定义，不等式为 $v \\cdot \\nabla U(x_0+tv) \\le a+bt$。由于事件发生率为 $\\lambda(t) = \\max\\{0, v \\cdot \\nabla U(x_0+tv)\\}$，一个有效的上包络 $\\bar{r}(t)$ 可以通过取我们线性界的正部得到：\n$$\\bar{r}(t) = \\max\\{0, a+bt\\}$$\n此包络具有一个由 $a+bt$ 的符号决定的分段结构。项 $a+bt$ 在 $t=-a/b$ 时为零。由于 $L>0$ 并且我们假设速度 $v$ 非零，我们有 $b>0$。\n\n分段结构如下：\n- 如果 $a \\ge 0$，则 $-a/b \\le 0$。对于所有 $t \\ge 0$，我们有 $a+bt \\ge 0$，所以 $\\bar{r}(t) = a+bt$。\n- 如果 $a  < 0$，则 $-a/b > 0$。令 $\\delta = -a/b$。\n    - 对于 $t \\in [0, \\delta)$，我们有 $a+bt  < 0$，所以 $\\bar{r}(t)=0$。\n    - 对于 $t \\ge \\delta$，我们有 $a+bt \\ge 0$，所以 $\\bar{r}(t)=a+bt$。\n\n### 第2部分：积分包络 $\\bar{R}(t)$ 及其反解\n\n为了使用“稀疏化”模拟事件时间，我们通过反解积分包络 $\\bar{R}(t) = \\int_0^t \\bar{r}(s)ds$ 来生成一个提议的时间 $t$。我们抽取一个标准指数变量 $E \\sim \\mathrm{Exp}(1)$（无量纲），并求解 $\\bar{R}(t)=E$ 得到 $t$。\n\n我们分析 $\\bar{r}(t)$ 结构的两种情况：\n\n**情况1：$a \\ge 0$**\n对于 $t \\ge 0$，$\\bar{r}(t) = a+bt$。积分发生率为：\n$$\\bar{R}(t) = \\int_0^t (a+bs)ds = \\left[as + \\frac{1}{2}bs^2\\right]_0^t = at + \\frac{1}{2}bt^2$$\n为了找到提议的事件时间，我们求解二次方程 $\\frac{1}{2}bt^2 + at - E = 0$ 的正根 $t > 0$。二次公式给出：\n$$t = \\frac{-a \\pm \\sqrt{a^2 - 4(\\frac{1}{2}b)(-E)}}{b} = \\frac{-a \\pm \\sqrt{a^2 + 2bE}}{b}$$\n由于 $t$ 必须为正且 $b>0$，我们取正根：\n$$t = \\frac{-a + \\sqrt{a^2 + 2bE}}{b}$$\n\n**情况2：$a < 0$**\n令 $\\delta = -a/b > 0$。发生率 $\\bar{r}(s)$ 在 $s \\in [0, \\delta)$ 上为 $0$，在 $s \\ge \\delta$ 上为 $a+bs$。\n- 如果 $t \\in [0, \\delta)$，$\\bar{R}(t) = \\int_0^t 0 ds = 0$。\n- 如果 $t \\ge \\delta$，积分发生率为：\n$$\\bar{R}(t) = \\int_0^\\delta 0 ds + \\int_\\delta^t (a+bs)ds = \\left[as+\\frac{1}{2}bs^2\\right]_\\delta^t = (at+\\frac{1}{2}bt^2) - (a\\delta+\\frac{1}{2}b\\delta^2)$$\n代入 $\\delta = -a/b$，第二项为 $a(-a/b) + \\frac{1}{2}b(-a/b)^2 = -a^2/b + a^2/(2b) = -a^2/(2b)$。\n因此，对于 $t \\ge \\delta$，$\\bar{R}(t) = at + \\frac{1}{2}bt^2 + \\frac{a^2}{2b} = \\frac{1}{2b}(2abt+b^2t^2+a^2) = \\frac{(a+bt)^2}{2b}$。\n一个更简单的推导方法是从 $\\delta$ 开始积分：$\\bar{R}(t) = \\int_{\\delta}^t (a+bs)ds$。令 $u=s-\\delta$，则 $s=u+\\delta$ 且 $ds=du$。\n$$\\bar{R}(t) = \\int_0^{t-\\delta} (a+b(u+\\delta))du = \\int_0^{t-\\delta} (a+b\\delta+bu)du$$\n由于 $a+b\\delta=0$，积分变为 $\\int_0^{t-\\delta} bu du = \\frac{1}{2}b(t-\\delta)^2$。\n为了求解 $\\bar{R}(t)=E$，必须有 $t \\ge \\delta$。我们求解 $\\frac{1}{2}b(t-\\delta)^2 = E$：\n$$(t-\\delta)^2 = \\frac{2E}{b} \\implies t-\\delta = \\sqrt{\\frac{2E}{b}} \\quad (\\text{因为 } t \\ge \\delta)$$\n$$t = \\delta + \\sqrt{\\frac{2E}{b}} = -\\frac{a}{b} + \\sqrt{\\frac{2E}{b}}$$\n\n### 第3部分：界更新区间 $\\delta$\n\n当 BPS 模拟在没有事件发生的情况下推进时间时，发生率的线性界可能会变得松弛。通常的做法是在一个新的锚点 $x_{\\mathrm{anc}} = x_0+s v$ 刷新这个界。新的界是针对相对于新锚点的时间 $\\tau = t-s \\ge 0$ 构建的。\n新的发生率线性界基于新的截距 $a_{\\mathrm{new}} = v \\cdot \\nabla U(x_{\\mathrm{anc}})$ 和相同的斜率参数 $b = L\\|v\\|^2$。新的发生率包络是 $\\bar{r}(\\tau) = \\max\\{0, a_{\\mathrm{new}} + b\\tau\\}$。\n如果 $a_{\\mathrm{new}} < 0$，此包络在时间区间 $\\tau \\in [0, -a_{\\mathrm{new}}/b)$ 上恒为零。这个区间的长度，我们称之为界更新区间，是 $\\delta = -a_{\\mathrm{new}}/b$。如果 $a_{\\mathrm{new}} \\ge 0$，则发生率从 $\\tau=0$ 开始就是正的，这个区间的长度为 $0$。\n因此，该区间的长度由下式给出：\n$$\\delta = \\max\\left\\{0, -\\frac{a_{\\mathrm{new}}}{b}\\right\\} = \\max\\left\\{0, -\\frac{v \\cdot \\nabla U(x_{\\mathrm{anc}})}{L\\|v\\|^2}\\right\\}$$\n这个公式与测试2中要求的量完全匹配，其中锚点是 $x_0$。",
            "answer": "```python\nimport numpy as np\nimport math\n\ndef solve():\n    \"\"\"\n    Implements and verifies the BPS rate envelope calculations.\n    \"\"\"\n    results = []\n\n    # ===== Test 1: General case verification =====\n    A1 = np.diag([3.0, 1.0])\n    x0_1 = np.array([1.0, -0.5])\n    v_1 = np.array([0.6, -0.8])\n    \n    L1 = np.max(np.abs(np.linalg.eigvals(A1)))\n    grad_U_x0_1 = A1 @ x0_1\n    a1 = v_1 @ grad_U_x0_1\n    b1 = L1 * (v_1 @ v_1)\n    \n    t_vals = np.linspace(0, 1, 101)\n    lambda_t_1 = np.maximum(0, a1 + t_vals * (v_1 @ A1 @ v_1))\n    r_bar_t_1 = np.maximum(0, a1 + t_vals * b1)\n    \n    # Tiny tolerance for floating point comparisons\n    is_valid_bound_1 = np.all(r_bar_t_1 >= lambda_t_1 - 1e-9)\n    results.append(bool(is_valid_bound_1))\n\n    # ===== Test 2: Negative intercept and bound-update interval =====\n    A2 = np.diag([2.0, 2.0])\n    x0_2 = np.array([-0.2, 0.1])\n    v_2 = np.array([0.5, 0.5])\n    \n    L2 = np.max(np.abs(np.linalg.eigvals(A2)))\n    grad_U_x0_2 = A2 @ x0_2\n    a2 = v_2 @ grad_U_x0_2\n    b2 = L2 * (v_2 @ v_2)\n\n    delta_2 = max(0, -a2 / b2)\n    results.append(delta_2)\n\n    # ===== Test 3: Inversion of integrated envelope (from Test 2) =====\n    E3 = 0.05\n    # Using parameters a2, b2 from Test 2. Since a2 < 0:\n    t3 = (-a2 / b2) + math.sqrt(2 * E3 / b2)\n    results.append(t3)\n    \n    # ===== Test 4: Indefinite quadratic potential =====\n    A4 = np.diag([3.0, -2.0])\n    x0_4 = np.array([0.4, 0.6])\n    v_4 = np.array([0.5, -0.3])\n    \n    L4 = np.max(np.abs(np.linalg.eigvals(A4)))\n    grad_U_x0_4 = A4 @ x0_4\n    a4 = v_4 @ grad_U_x0_4\n    b4 = L4 * (v_4 @ v_4)\n    \n    lambda_t_4 = np.maximum(0, a4 + t_vals * (v_4 @ A4 @ v_4))\n    r_bar_t_4 = np.maximum(0, a4 + t_vals * b4)\n    \n    is_valid_bound_4 = np.all(r_bar_t_4 >= lambda_t_4 - 1e-9)\n    results.append(bool(is_valid_bound_4))\n    \n    # ===== Test 5: Tight envelope case =====\n    A5 = np.diag([5.0, 1.0])\n    x0_5 = np.array([0.2, 0.1])\n    v_5 = np.array([1.0, 0.0])\n    \n    L5 = np.max(np.abs(np.linalg.eigvals(A5)))\n    grad_U_x0_5 = A5 @ x0_5\n    a5 = v_5 @ grad_U_x0_5\n    b5 = L5 * (v_5 @ v_5)\n    \n    # Since a5 > 0, the integrated envelope over [0, 1] is a + b/2.\n    R_bar_1 = a5 * 1.0 + 0.5 * b5 * 1.0**2\n    \n    # The actual rate is lambda(t) = a + t * (v'Av).\n    vTAv5 = v_5 @ A5 @ v_5\n    # Since a5 > 0 and vTAv5 > 0, the max(0, ...) is redundant.\n    # Integrated actual rate over [0, 1] is a + (v'Av)/2.\n    R_actual_1 = a5 * 1.0 + 0.5 * vTAv5 * 1.0**2\n    \n    ratio_5 = R_bar_1 / R_actual_1\n    results.append(ratio_5)\n    \n    # Print the final results in the specified format\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "像Zig-Zag这样的采样器的一个主要优势是它们能够应用于大规模机器学习模型，在这些模型中，势能函数是大量数据点上损失项的总和。本练习将探讨如何利用子采样技术来构建计算高效的事件率上界。你将开发一个几乎必然成立的上界，它结合了在小数据子集上的精确计算和在其余数据上的确定性界限，从而使采样器具有可扩展性。",
            "id": "3323722",
            "problem": "考虑一个分段确定性马尔可夫过程 (PDMP) Zig-Zag 采样器，其目标是一个在 $\\mathbb{R}^d$ 上具有负对数后验势能 $U(x) = \\sum_{n=1}^{N} \\ell_n(x)$ 的可微概率密度，其中 $x \\in \\mathbb{R}^d$ 且每个 $\\ell_n(x)$ 是一个可微损失项。在 Zig-Zag 过程中，速度 $v \\in \\{-1,+1\\}^d$ 在事件之间是恒定的，位置按 $x(t) = x_0 + t v$ 确定性地演化，并且每个坐标 $i \\in \\{1,\\dots,d\\}$ 都有一个事件强度（风险率）$\\lambda_i(x(t), v) = \\max\\{0,\\, v_i \\,\\partial_i U(x(t))\\}$。\n\n要求您为强度 $\\lambda_i(x(t), v)$ 推导并实现一个随机上界函数 $M_i(t)$，该函数适用于精确泊松细化（即，在用于构造 $M_i(t)$ 的随机性下，$M_i(t) \\ge \\lambda_i(x(t), v)$ 对所有 $t \\ge 0$ 几乎必然成立）。该构造必须基于：\n- $\\partial_i U(x)$ 的一个无偏子采样估计量，\n- 应用于有界随机变量的集中不等式，以及\n- 为确保精确性而使用的确定性利普希茨包络界。\n\n为确保科学真实性和具体实例，请使用逻辑回归负对数后验：\n$$\nU(x) \\;=\\; \\sum_{n=1}^{N} \\ell_n(x) \\;+\\; \\frac{\\alpha}{2}\\,\\|x\\|_2^2,\n$$\n其中先验精度为 $\\alpha > 0$ 且\n$$\n\\ell_n(x) \\;=\\; -y_n \\log \\sigma(w_n^\\top x) \\;-\\; (1-y_n)\\,\\log(1-\\sigma(w_n^\\top x)), \\quad \\sigma(a) = \\frac{1}{1+e^{-a}}.\n$$\n此处 $y_n \\in \\{0,1\\}$ 和 $w_n \\in \\mathbb{R}^d$ 是给定数据。对于此模型，\n$$\n\\partial_i \\ell_n(x) \\;=\\; (\\sigma(w_n^\\top x) - y_n)\\,w_{n,i}, \\quad \\partial_i U(x) \\;=\\; \\sum_{n=1}^{N} (\\sigma(w_n^\\top x) - y_n)\\,w_{n,i} \\;+\\; \\alpha\\,x_i.\n$$\n\n您必须：\n1. 从第一性原理出发，推导 $\\partial_i U(x)$ 的一个基于子采样的无偏估计量 $\\widehat{G}_i(x)$，并使用适用于有界加数的集中不等式进行单边上置信度校正。明确指定每个数据点加数的界限，以证明使用该集中不等式的合理性。\n2. 认识到仅有高概率上置信界不足以进行精确细化。利用 $|\\sigma'(a)| \\le \\tfrac{1}{4}$ 和 $|(\\sigma(w_n^\\top x)-y_n)w_{n,i}| \\le |w_{n,i}|$ 这两个事实，沿 Zig-Zag 段为 $|\\partial_i U(x(t))|$ 推导一个确定性利普希茨包络。由此构造一个几乎必然的上界 $M_i(t)$，该上界包含：\n   - 在所选子集 $S \\subset \\{1,\\dots,N\\}$ 上的子采样精确绝对和，\n   - 对未采样补集 $S^c$ 的确定性界，\n   - 以及一个捕捉 $|\\partial_i U(x(t))|$ 沿方向 $v$ 增长的、关于 $t$ 线性的利普希茨包络。\n3. 证明所得的 $M_i(t)$ 对所有 $t \\ge 0$ 以及对子采样随机性的所有实现都满足 $M_i(t) \\ge \\lambda_i(x(t), v)$（即，它适用于精确细化）。\n4. 实现一个程序，对于一个使用固定随机种子生成的合成数据集，在 $[0,T]$ 的均匀时间网格上数值验证您推导的 $M_i(t)$ 大于等于真实的 $\\lambda_i(x(t), v)$。您的验证必须使用完整数据（无近似）计算真实强度 $\\lambda_i(x(t), v)$，并对每个网格点检查 $M_i(t) \\ge \\lambda_i(x(t), v)$。\n5. 程序必须内部生成数据集和参数，并在无外部输入的情况下运行测试。使用以下测试用例集，每个用例由一个元组 $(N, d, m, i, T, \\alpha, \\text{seed})$ 指定，其中 $m$ 是子样本大小， $i$ 是坐标索引（从零开始），$T$ 是时间范围，$\\alpha$ 是先验精度。所有测试的速度 $v$ 都必须是 $v \\in \\{-1,+1\\}^d$，其分量符号交替，从 $+1$ 开始。\n   - 案例 A（正常路径）：$(200, 3, 20, 0, 0.5, 0.1, 123)$。\n   - 案例 B（边界，无子采样）：$(200, 3, 0, 1, 0.25, 0.1, 456)$。\n   - 案例 C（边缘，全子采样）：$(200, 3, 200, 2, 0.1, 0.1, 789)$。\n   - 案例 D（压力测试，更大时间范围）：$(200, 3, 50, 1, 1.0, 0.1, 321)$。\n\n细节和约束：\n- 您的推导必须从 PDMP Zig-Zag 强度的定义开始，并且只能使用 $\\sigma(\\cdot)$ 的基本性质、每个数据点贡献的有界性以及由 $\\sigma'(\\cdot)$ 蕴含的利普希茨连续性。\n- 您必须清晰地定义子采样估计量和集中校正，包括用于不等式中每个加数的界定区间。\n- 不涉及角度。不涉及物理单位。\n- 对于数值验证，在 $[0,T]$ 中使用一个包含 $K=50$ 个点的均匀网格来检查不等式。每个案例的输出必须是一个布尔值，如果对所有网格点 $M_i(t) \\ge \\lambda_i(x(t), v)$ 均成立，则为 true，否则为 false。\n- 最终输出格式：您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果（例如，\"[true,false,true,false]\"）。布尔值必须是 Python 的规范格式（\"True\" 或 \"False\"）。",
            "solution": "用户提供了一个关于为 Zig-Zag 采样器构造随机细化界的有效问题。该问题具有科学依据，提法明确，并指定了其解决方案所需的所有必要组成部分。我将进行完整的推导和实现。\n\n### Zig-Zag 强度的上界推导\n\n问题要求为 Zig-Zag 采样器第 $i$ 个坐标的事件强度 $\\lambda_i(x(t), v)$ 寻找一个几乎必然正确的上界 $M_i(t)$。该过程的目标是一个密度，其负对数后验为 $U(x)$，强度由下式给出：\n$$\n\\lambda_i(x(t), v) = \\max\\{0, v_i \\partial_i U(x(t))\\}\n$$\n其中 $x(t) = x_0 + t v$ 是事件之间的确定性轨迹。寻找一个界 $M_i(t) \\ge \\lambda_i(x(t), v)$ 等价于为量 $h(t) = v_i \\partial_i U(x(t))$ 寻找一个上界。那么强度的最终界将是 $M_i(t) = \\max\\{0, \\text{upper_bound}(h(t))\\}$。\n\n势能由 $U(x) = \\sum_{n=1}^{N} \\ell_n(x) + \\frac{\\alpha}{2}\\|x\\|_2^2$ 给出，其偏导数为：\n$$\n\\partial_i U(x) = \\sum_{n=1}^{N} \\underbrace{(\\sigma(w_n^\\top x) - y_n)w_{n,i}}_{f_{n,i}(x)} + \\alpha x_i\n$$\n\n界的构造将分两个主要步骤进行：\n1. 使用利普希茨常数为 $\\partial_i U(x(t))$ 的时间演化推导一个关于 $t$ 线性的包络。\n2. 使用子采样和确定性界为初始值 $v_i \\partial_i U(x_0)$ 构造一个界。\n\n#### 第 1 部分：高概率界与几乎必然界\n\n提示首先建议对 $\\partial_i U(x)$ 采用无偏子采样估计量并使用集中不等式。设 $S \\subset \\{1, \\dots, N\\}$ 是一个大小为 $m$ 的随机子集。$\\sum_{n=1}^N f_{n,i}(x)$ 的一个无偏估计量是 $\\frac{N}{m}\\sum_{n \\in S} f_{n,i}(x)$。这给出了完整梯度的估计量：\n$$\n\\widehat{G}_i(x) = \\frac{N}{m} \\sum_{n \\in S} f_{n,i}(x) + \\alpha x_i\n$$\n项 $f_{n,i}(x)$ 是有界的：因为 $y_n \\in \\{0,1\\}$ 且 $\\sigma(\\cdot) \\in (0,1)$，我们有 $|\\sigma(w_n^\\top x) - y_n|  < 1$。这意味着 $|f_{n,i}(x)| \\le |w_{n,i}|$。这些项的有界性允许使用集中不等式（例如，Hoeffding 不等式用于无放回抽样）来构造估计量周围的高概率置信区间。这种方法将产生一个界 $B_i(x,S)$，使得对于某个小的 $\\delta > 0$，有 $P(v_i \\partial_i U(x) \\le B_i(x,S)) \\ge 1-\\delta$。\n\n然而，正如问题描述中正确指出的，这样的高概率界不足以通过泊松细化进行*精确*模拟。精确细化算法要求上界 $M_i(t)$ **几乎必然**成立，即对于其构造中使用的任何随机性（此处为子样本 $S$ 的选择），其成立的概率为 1。一个以非零概率失效的界会导致有偏的采样器。因此，我们继续进行一种保证几乎必然界的构造。\n\n#### 第 2 部分：通过确定性界定获得几乎必然界\n\n我们通过将全数据集 $\\{1, \\dots, N\\}$ 上的和分解为子样本 $S$（大小为 $m$）及其补集 $S^c$ 上的和来构造界。对 $S$ 上的项进行精确计算，而对 $S^c$ 上的项则使用确定性界。\n\n**步骤 2.1：时间演化的利普希茨包络**\n\n我们首先为 $\\partial_i U(x(t))$ 的变化率建立一个界。$\\partial_i U(x(t))$ 的时间导数是：\n$$\n\\frac{d}{dt} \\partial_i U(x(t)) = \\nabla(\\partial_i U(x(t)))^\\top \\frac{dx}{dt} = \\sum_{j=1}^d (\\partial_j \\partial_i U(x(t))) v_j\n$$\nHessian 矩阵的元素是 $\\partial_j \\partial_i U(x) = \\sum_{n=1}^N \\sigma'(w_n^\\top x)w_{n,i}w_{n,j} + \\alpha \\delta_{ij}$。代入可得：\n$$\n\\frac{d}{dt} \\partial_i U(x(t)) = \\sum_{j=1}^d v_j \\left(\\sum_{n=1}^N \\sigma'(w_n^\\top x(t))w_{n,i}w_{n,j} + \\alpha \\delta_{ij}\\right) = \\sum_{n=1}^N \\sigma'(w_n^\\top x(t)) w_{n,i} (w_n^\\top v) + \\alpha v_i\n$$\n我们使用性质 $|\\sigma'(a)| \\le 1/4$ 来界定这个导数的绝对值：\n$$\n\\left|\\frac{d}{dt} \\partial_i U(x(t))\\right| \\le \\sum_{n=1}^N \\left|\\sigma'(w_n^\\top x(t))\\right| |w_{n,i}| |w_n^\\top v| + |\\alpha v_i| \\le \\frac{1}{4} \\sum_{n=1}^N |w_{n,i}| |w_n^\\top v| + \\alpha\n$$\n让我们定义常数利普希茨界 $L_i$：\n$$\nL_i := \\frac{1}{4} \\sum_{n=1}^N |w_{n,i}| |w_n^\\top v| + \\alpha\n$$\n这个常数界定了 $\\partial_i U(x(t))$ 变化率的大小，对所有 $t \\ge 0$ 都成立。通过对这个界积分，我们对任意 $t \\ge 0$ 有：\n$$\n|\\partial_i U(x(t)) - \\partial_i U(x_0)| \\le L_i t\n$$\n这意味着 $\\partial_i U(x(t)) \\le \\partial_i U(x_0) + L_i t$。乘以 $v_i \\in \\{-1, 1\\}$，我们得到 $h(t) = v_i \\partial_i U(x(t))$ 的一个上界：\n$$\nv_i \\partial_i U(x(t)) \\le v_i \\partial_i U(x_0) + L_i t\n$$\n\n**步骤 2.2：在 $t=0$ 时基于子采样的界**\n\n剩下的任务是为初始项 $v_i \\partial_i U(x_0)$ 找到一个几乎必然的上界。我们通过将 $\\partial_i U(x_0)$ 中的和式分解到子样本 $S$ 和其补集 $S^c$ 上来实现：\n$$\n\\partial_i U(x_0) = \\sum_{n \\in S} f_{n,i}(x_0) + \\sum_{n \\in S^c} f_{n,i}(x_0) + \\alpha x_{0,i}\n$$\n乘以 $v_i$：\n$$\nv_i \\partial_i U(x_0) = v_i \\left( \\sum_{n \\in S} f_{n,i}(x_0) + \\alpha x_{0,i} \\right) + v_i \\sum_{n \\in S^c} f_{n,i}(x_0)\n$$\n第一部分，涉及在 $S$ 上的和，可以精确计算，因为 $S$ 是已知的。对于第二部分，我们使用一个确定性界。正如问题中所指定的，我们使用 $|f_{n,i}(x_0)| = |(\\sigma(w_n^\\top x_0)-y_n)w_{n,i}| \\le |w_{n,i}|$ 这个事实。\n$$\nv_i \\sum_{n \\in S^c} f_{n,i}(x_0) \\le \\left|v_i \\sum_{n \\in S^c} f_{n,i}(x_0)\\right| \\le \\sum_{n \\in S^c} |f_{n,i}(x_0)| \\le \\sum_{n \\in S^c} |w_{n,i}|\n$$\n这个界对任何 $x_0$ 和任何 $S$ 的选择都成立。将其代回，我们得到 $v_i \\partial_i U(x_0)$ 的一个上界：\n$$\nv_i \\partial_i U(x_0) \\le v_i \\left( \\sum_{n \\in S} f_{n,i}(x_0) + \\alpha x_{0,i} \\right) + \\sum_{n \\in S^c} |w_{n,i}|\n$$\n让我们用 $M_0$ 表示这个初始界：\n$$\nM_0 := v_i \\left( \\sum_{n \\in S} (\\sigma(w_n^\\top x_0) - y_n)w_{n,i} + \\alpha x_{0,i} \\right) + \\sum_{n \\in S^c} |w_{n,i}|\n$$\n注意 $M_0$ 取决于随机样本 $S$ 的具体实现。\n\n**步骤 2.3：最终界 $M_i(t)$**\n\n结合前面步骤的结果，我们得到了 $v_i \\partial_i U(x(t))$ 的一个上界：\n$$\nv_i \\partial_i U(x(t)) \\le v_i \\partial_i U(x_0) + L_i t \\le M_0 + L_i t\n$$\n设 $\\bar{M}_i(t) = M_0 + L_i t$。这个界对所有 $t \\ge 0$ 和任何子样本 $S$ 的选择都成立。最后，为了界定强度 $\\lambda_i(x(t),v) = \\max\\{0, v_i \\partial_i U(x(t))\\}$，我们取我们界的正部：\n$$\nM_i(t) = \\max\\{0, \\bar{M}_i(t)\\} = \\max\\{0, M_0 + L_i t\\}\n$$\n推导到此完成。函数 $M_i(t)$ 满足 $M_i(t) \\ge \\lambda_i(x(t), v)$ 几乎必然成立，正如精确泊松细化所要求的那样。该构造包含了一个在子集 $S$ 上的精确计算，一个在其补集 $S^c$ 上的确定性界，以及一个关于 $t$ 线性的利普希茨包络。\n\n特殊情况被正确处理：\n- 如果 $m=0$，$S$ 为空， $M_0$ 中的第一个和为零。第二个和遍及所有 $n \\in \\{1, \\dots, N\\}$。\n- 如果 $m=N$，$S$ 是全集， $S^c$ 为空。 $M_0$ 中的第二个和为零，且 $M_0 = v_i \\partial_i U(x_0)$ 成为一个精确的计算。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import expit as sigma\n\ndef solve():\n    \"\"\"\n    Derives and verifies a stochastic upper bound for the Zig-Zag sampler intensity\n    in a logistic regression model.\n    \"\"\"\n    # Test cases: (N, d, m, i, T, alpha, seed)\n    test_cases = [\n        (200, 3, 20, 0, 0.5, 0.1, 123),    # Case A: happy path\n        (200, 3, 0, 1, 0.25, 0.1, 456),    # Case B: boundary, no subsampling\n        (200, 3, 200, 2, 0.1, 0.1, 789),   # Case C: edge, full subsample\n        (200, 3, 50, 1, 1.0, 0.1, 321),    # Case D: stress, larger horizon\n    ]\n\n    results = []\n    # Number of grid points for numerical verification\n    K = 50\n\n    for N, d, m, i, T, alpha, seed in test_cases:\n        # Set up RNG for reproducibility\n        rng = np.random.default_rng(seed)\n\n        # Generate synthetic data for logistic regression\n        # Assumes a true parameter vector to generate plausible labels\n        x_true = rng.standard_normal(size=d)\n        w = rng.standard_normal(size=(N, d))\n        # Probabilities for y_n = 1\n        p_y = sigma(w @ x_true)\n        y = rng.binomial(1, p_y)\n\n        # Initial state for the Zig-Zag segment\n        x0 = rng.standard_normal(size=d)\n        # Velocity v has alternating signs: +1, -1, +1, ...\n        v = np.array([(-1)**k for k in range(d)])\n\n        # Select subsample S and its complement Sc\n        if m > N or m < 0:\n            raise ValueError(\"Subsample size m must be between 0 and N.\")\n        \n        S_indices = rng.choice(N, m, replace=False)\n        S_mask = np.zeros(N, dtype=bool)\n        S_mask[S_indices] = True\n        Sc_mask = ~S_mask\n\n        w_S, y_S = w[S_mask], y[S_mask]\n        w_Sc = w[Sc_mask]\n        \n        # --- Bound Construction M_i(t) ---\n\n        # Calculate M_0, the bound at t=0\n        # Term from the subsample S (computed exactly) + prior\n        term_S_part = 0.0\n        if m > 0:\n            f_ni_S = (sigma(w_S @ x0) - y_S) * w_S[:, i]\n            term_S_part = np.sum(f_ni_S)\n        term_prior = alpha * x0[i]\n        M0_S_part = v[i] * (term_S_part + term_prior)\n        \n        # Deterministic bounding term from the complement Sc\n        M0_Sc_part = np.sum(np.abs(w_Sc[:, i]))\n\n        M0 = M0_S_part + M0_Sc_part\n\n        # Calculate the Lipschitz constant L_i\n        w_dot_v = w @ v\n        L_i_sum_term = 0.25 * np.sum(np.abs(w[:, i]) * np.abs(w_dot_v))\n        L_i = L_i_sum_term + alpha\n\n        def bound_M_i(t: float) -> float:\n            \"\"\"Calculates the upper bound M_i(t) on the intensity.\"\"\"\n            m_bar = M0 + L_i * t\n            return np.maximum(0.0, m_bar)\n\n        # --- True Intensity lambda_i(t) ---\n        \n        def true_lambda_i(t: float) -> float:\n            \"\"\"Calculates the true intensity lambda_i(t) using the full dataset.\"\"\"\n            xt = x0 + t * v\n            # Gradient of log-likelihood for coordinate i\n            grad_log_lik_i = np.sum((sigma(w @ xt) - y) * w[:, i])\n            # Gradient of prior for coordinate i\n            grad_prior_i = alpha * xt[i]\n            # Full gradient of negative log-posterior\n            grad_U_i = grad_log_lik_i + grad_prior_i\n            \n            return np.maximum(0.0, v[i] * grad_U_i)\n            \n        # --- Numerical Verification ---\n        \n        t_grid = np.linspace(0.0, T, K)\n        \n        bound_holds = True\n        for t in t_grid:\n            true_val = true_lambda_i(t)\n            bound_val = bound_M_i(t)\n            # Check if the bound holds, with a small tolerance for floating point errors\n            if bound_val < true_val - 1e-9:\n                bound_holds = False\n                break\n        \n        results.append(bound_holds)\n        \n    # Format the final output as specified\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```"
        }
    ]
}