{
    "hands_on_practices": [
        {
            "introduction": "在深入研究复杂的数值积分方案之前，理解我们旨在采样的目标分布至关重要。本练习将连续时间欠阻尼朗之万随机微分方程 (SDE) 与其平稳分布联系起来，让您能够在一个基础模型系统中，直接从势能和温度推导出位置和速度协方差等关键统计特性。通过这个计算，您将巩固对系统在热平衡状态下基本性质的理解 。",
            "id": "3359276",
            "problem": "考虑位置 $x \\in \\mathbb{R}^{d}$ 和速度 $v \\in \\mathbb{R}^{d}$ 的 $d$ 维欠阻尼朗之万随机微分方程（SDE），\n$$\n\\mathrm{d}x_{t} = v_{t}\\,\\mathrm{d}t, \n\\qquad\n\\mathrm{d}v_{t} = -\\gamma\\, v_{t}\\,\\mathrm{d}t - \\nabla U(x_{t})\\,\\mathrm{d}t + \\sqrt{\\frac{2\\gamma}{\\beta}}\\,\\mathrm{d}W_{t},\n$$\n其中 $W_{t}$ 是一个 $d$ 维标准维纳过程，$\\gamma>0$ 是摩擦系数，$\\beta>0$ 是逆温度。假设势能是二次形式，\n$$\nU(x) = \\frac{1}{2}\\, x^{\\top} A x,\n$$\n其中 $A \\in \\mathbb{R}^{d \\times d}$ 是对称正定矩阵。从稳态福克-普朗克方程和上述SDE中蕴含的涨落-耗散平衡出发，确定稳态密度 $\\pi(x,v)$，并用它来计算由 $\\pi$ 所蕴含的稳态协方差 $\\mathrm{Cov}(x)$ 和 $\\mathrm{Cov}(v)$。将你的最终答案表示为一个单行矩阵，其两个条目分别为 $\\mathrm{Cov}(x)$ 和 $\\mathrm{Cov}(v)$ 的闭式表达式。无需进行数值四舍五入。",
            "solution": "此问题有效。这是一个在统计力学和随机微积分中定义明确、有科学依据的问题，并为求得唯一解提供了所有必要信息。\n\n状态向量 $(x_t, v_t)$ 的欠阻尼朗之万动力学由以下随机微分方程（SDE）给出：\n$$\n\\mathrm{d}x_{t} = v_{t}\\,\\mathrm{d}t\n$$\n$$\n\\mathrm{d}v_{t} = -\\gamma\\, v_{t}\\,\\mathrm{d}t - \\nabla U(x_{t})\\,\\mathrm{d}t + \\sqrt{\\frac{2\\gamma}{\\beta}}\\,\\mathrm{d}W_{t}\n$$\n该系统描述了一个单位质量（$m=1$）的粒子在势 $U(x)$ 中的运动，该粒子受到摩擦和随机热涨落的影响。噪声项的形式与涨落-耗散定理一致，该定理保证系统将热化到一个稳态，此稳态由逆温度为 $\\beta$ 的吉布斯-玻尔兹曼分布描述。\n\n系统的总能量由哈密顿量 $H(x, v)$ 给出，它是势能 $U(x)$ 和动能 $K(v)$ 的和。\n势能以二次形式给出：\n$$\nU(x) = \\frac{1}{2}\\, x^{\\top} A x\n$$\n其中 $A$ 是一个对称正定矩阵。\n单位质量粒子的动能为：\n$$\nK(v) = \\frac{1}{2}\\, v^{\\top} v\n$$\n因此，哈密顿量为：\n$$\nH(x,v) = U(x) + K(v) = \\frac{1}{2}\\, x^{\\top} A x + \\frac{1}{2}\\, v^{\\top} v\n$$\n朗之万SDE的稳态分布（或不变测度）$\\pi(x, v)$ 是与此哈密顿量相关的吉布斯-玻尔兹曼分布：\n$$\n\\pi(x, v) = Z^{-1} \\exp(-\\beta H(x, v))\n$$\n其中 $Z$ 是归一化常数，也称为配分函数。代入 $H(x,v)$ 的表达式：\n$$\n\\pi(x, v) = Z^{-1} \\exp\\left(-\\beta \\left(\\frac{1}{2}\\, x^{\\top} A x + \\frac{1}{2}\\, v^{\\top} v\\right)\\right)\n$$\n我们可以分离涉及 $x$ 和 $v$ 的项：\n$$\n\\pi(x, v) = Z^{-1} \\exp\\left(-\\frac{\\beta}{2}\\, x^{\\top} A x\\right) \\exp\\left(-\\frac{\\beta}{2}\\, v^{\\top} v\\right)\n$$\n这表明稳态分布是两个函数的乘积，一个只依赖于 $x$，另一个只依赖于 $v$。这意味着在稳态下，位置 $x$ 和速度 $v$ 是统计独立的随机变量。我们可以写成 $\\pi(x, v) = \\pi(x) \\pi(v)$，其中：\n$$\n\\pi(x) \\propto \\exp\\left(-\\frac{1}{2}\\, x^{\\top} (\\beta A) x\\right)\n$$\n$$\n\\pi(v) \\propto \\exp\\left(-\\frac{1}{2}\\, v^{\\top} (\\beta I) v\\right)\n$$\n其中 $I$ 是 $d \\times d$ 单位矩阵。\n\n$\\pi(x)$ 和 $\\pi(v)$ 都是多元正态分布的概率密度。一个均值为 $\\mu$、协方差矩阵为 $\\Sigma$ 的通用 $d$ 维多元正态分布，其概率密度函数正比于 $\\exp\\left(-\\frac{1}{2} (z - \\mu)^{\\top} \\Sigma^{-1} (z - \\mu)\\right)$。\n对于这两个分布，二次型都是中心化的，这意味着均值向量为零：\n$$\n\\mathbb{E}[x] = \\int_{\\mathbb{R}^d} x \\, \\pi(x) \\, \\mathrm{d}x = 0\n$$\n$$\n\\mathbb{E}[v] = \\int_{\\mathbb{R}^d} v \\, \\pi(v) \\, \\mathrm{d}v = 0\n$$\n协方差矩阵定义为 $\\mathrm{Cov}(x) = \\mathbb{E}[(x - \\mathbb{E}[x])(x - \\mathbb{E}[x])^{\\top}] = \\mathbb{E}[xx^{\\top}]$ 和 $\\mathrm{Cov}(v) = \\mathbb{E}[vv^{\\top}]$。\n\n为了求出 $\\mathrm{Cov}(x)$，我们将 $\\pi(x)$ 中的指数与标准形式进行比较。我们通过以下关系确定 $x$ 的逆协方差矩阵，记为 $\\Sigma_{x}^{-1}$：\n$$\n-\\frac{1}{2}\\, x^{\\top} \\Sigma_{x}^{-1} x = -\\frac{1}{2}\\, x^{\\top} (\\beta A) x\n$$\n这得到 $\\Sigma_{x}^{-1} = \\beta A$。由于 $A$ 是对称正定且 $\\beta > 0$，所以 $\\beta A$ 是可逆的。因此，$x$ 的协方差矩阵为：\n$$\n\\mathrm{Cov}(x) = \\Sigma_x = (\\beta A)^{-1} = \\frac{1}{\\beta} A^{-1}\n$$\n\n类似地，对于 $\\mathrm{Cov}(v)$，我们将 $\\pi(v)$ 中的指数与标准形式进行比较。我们通过以下关系确定 $v$ 的逆协方差矩阵，记为 $\\Sigma_{v}^{-1}$：\n$$\n-\\frac{1}{2}\\, v^{\\top} \\Sigma_{v}^{-1} v = -\\frac{1}{2}\\, v^{\\top} (\\beta I) v\n$$\n这得到 $\\Sigma_{v}^{-1} = \\beta I$。因此，$v$ 的协方差矩阵为：\n$$\n\\mathrm{Cov}(v) = \\Sigma_v = (\\beta I)^{-1} = \\frac{1}{\\beta} I\n$$\n摩擦系数 $\\gamma$ 影响动力学过程（即收敛到稳态分布的速率），但它不影响稳态协方差本身，因为稳态协方差仅由势能 $U(x)$ 和温度 $\\beta^{-1}$ 决定。\n\n稳态协方差为 $\\mathrm{Cov}(x) = \\frac{1}{\\beta} A^{-1}$ 和 $\\mathrm{Cov}(v) = \\frac{1}{\\beta} I$。",
            "answer": "$$\n\\boxed{\\begin{pmatrix} \\frac{1}{\\beta} A^{-1}  \\frac{1}{\\beta} I \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "随机梯度朗之万动力学 (SGLD) 中的“随机梯度”既是计算上的优势，也是统计上的挑战。本练习分离出这一核心部分，要求您量化梯度估计器的方差如何随小批量大小而变化 。在实践中，理解这种关系对于平衡计算速度和模拟准确性至关重要。",
            "id": "3359225",
            "problem": "考虑 $d$ 维空间中目标势 $U(x)$ 的欠阻尼朗之万动力学，其中真实梯度 $\\nabla U(x)$ 在随机梯度朗之万动力学 (SGLD) 中被一个随机小批量估计量所替代。设在固定的 $x$ 处，单个样本对梯度的贡献是一个随机向量 $G(x)$，其均值为 $\\mathbb{E}[G(x)] = \\nabla U(x)$，协方差矩阵为 $\\Sigma(x) = \\operatorname{Cov}(G(x))$。假设通过有放回抽样形成一个大小为 $b$ 的小批量，产生 $b$ 个 $G(x)$ 的独立同分布副本 $\\{G_j(x)\\}_{j=1}^{b}$，并定义小批量梯度估计量为\n$$\n\\widehat{\\nabla U}(x) \\;=\\; \\frac{1}{b}\\sum_{j=1}^{b} G_j(x).\n$$\n将 $x$ 视为固定的，计算 $\\widehat{\\nabla U}(x)$ 的方差（即协方差矩阵），并将其表示为 $b$ 和 $\\Sigma(x)$ 的函数。请将最终答案表示为仅含 $b$ 和 $\\Sigma(x)$ 的单个闭式解析表达式。无需四舍五入，最终答案中不应包含单位。",
            "solution": "该问题要求计算随机小批量梯度估计量 $\\widehat{\\nabla U}(x)$ 的方差，对于向量值随机变量，其方差即为其协方差矩阵。在分析中，位置 $x$ 将被视为一个固定参数。\n\n小批量梯度估计量定义为 $b$ 个独立同分布 (i.i.d.) 的单个样本梯度估计量 $\\{G_j(x)\\}_{j=1}^{b}$ 的平均值：\n$$\n\\widehat{\\nabla U}(x) = \\frac{1}{b}\\sum_{j=1}^{b} G_j(x)\n$$\n我们需要计算 $\\operatorname{Var}(\\widehat{\\nabla U}(x))$，它等价于协方差矩阵 $\\operatorname{Cov}(\\widehat{\\nabla U}(x))$。\n$$\n\\operatorname{Var}(\\widehat{\\nabla U}(x)) = \\operatorname{Cov}\\left( \\frac{1}{b}\\sum_{j=1}^{b} G_j(x) \\right)\n$$\n我们使用协方差算子的一个基本性质。对于一个常数标量 $c$ 和一个随机向量 $X$，有 $\\operatorname{Cov}(cX) = c^2 \\operatorname{Cov}(X)$。在本例中，标量为 $c = \\frac{1}{b}$。因此，我们可以将其从协方差算子中提出：\n$$\n\\operatorname{Cov}\\left( \\frac{1}{b}\\sum_{j=1}^{b} G_j(x) \\right) = \\left(\\frac{1}{b}\\right)^2 \\operatorname{Cov}\\left( \\sum_{j=1}^{b} G_j(x) \\right) = \\frac{1}{b^2} \\operatorname{Cov}\\left( \\sum_{j=1}^{b} G_j(x) \\right)\n$$\n接下来，我们使用协方差的另一个关键性质。对于一组相互独立的随机向量 $\\{X_j\\}_{j=1}^{b}$，它们和的协方差等于它们各自协方差的和：\n$$\n\\operatorname{Cov}\\left(\\sum_{j=1}^{b} X_j\\right) = \\sum_{j=1}^{b} \\operatorname{Cov}(X_j)\n$$\n问题陈述明确指出样本 $\\{G_j(x)\\}_{j=1}^{b}$ 是独立的。因此，我们可以应用此性质：\n$$\n\\operatorname{Cov}\\left( \\sum_{j=1}^{b} G_j(x) \\right) = \\sum_{j=1}^{b} \\operatorname{Cov}(G_j(x))\n$$\n问题还指出样本是同分布的。这意味着每个样本 $G_j(x)$ 的协方差矩阵都是相同的。我们已知单个样本梯度 $G(x)$ 的协方差矩阵为 $\\operatorname{Cov}(G(x)) = \\Sigma(x)$。由于所有 $G_j(x)$ 都是 $G(x)$ 的同分布副本，因此对于任何 $j \\in \\{1, 2, \\ldots, b\\}$，都有：\n$$\n\\operatorname{Cov}(G_j(x)) = \\Sigma(x)\n$$\n将此代入求和式中，我们得到：\n$$\n\\sum_{j=1}^{b} \\operatorname{Cov}(G_j(x)) = \\sum_{j=1}^{b} \\Sigma(x)\n$$\n这是 $b$ 个相同矩阵 $\\Sigma(x)$ 的和，等于 $b\\Sigma(x)$。\n\n最后，我们将所有部分组合起来。\n$$\n\\operatorname{Var}(\\widehat{\\nabla U}(x)) = \\frac{1}{b^2} \\left( \\sum_{j=1}^{b} \\operatorname{Cov}(G_j(x)) \\right) = \\frac{1}{b^2} (b \\Sigma(x))\n$$\n通过消去一个因子 $b$ 来简化表达式，得到最终结果：\n$$\n\\operatorname{Var}(\\widehat{\\nabla U}(x)) = \\frac{1}{b} \\Sigma(x)\n$$\n这个结果表明，小批量梯度估计量的方差与批量大小 $b$ 成反比。增加批量大小可以减少梯度估计中的噪声，这是随机优化方法的一个核心原则。",
            "answer": "$$\\boxed{\\frac{1}{b} \\Sigma(x)}$$"
        },
        {
            "introduction": "一个好的采样器不仅能达到正确的分布，还能高效地完成这一任务，即以最小的计算成本生成非相关的样本。这项动手实践深入探讨了有效样本量 (ESS) 的关键概念，通过分析动量刷新的频率如何影响采样效率 。通过平衡确定性探索与随机化过程，您将学习如何在给定的计算预算下优化采样器的性能。",
            "id": "3359269",
            "problem": "考虑一维欠阻尼朗之万动力学，其逆温度为 $ \\beta = 1 $，目标高斯密度正比于 $ \\exp\\left(-U(x)\\right) $，其中势能为二次型 $ U(x) = \\tfrac{1}{2} x^2 $。设质量 $ m = 1 $，正则哈密顿量为 $ H(x,v) = \\tfrac{1}{2} x^2 + \\tfrac{1}{2} v^2 $。在动量刷新之间，系统在精确的哈密顿流下演化 $ K $ 个微步，每步大小为 $ h  0 $，因此组合的 $ K $ 步流是相空间中一个角度为 $ K h $ 的旋转（角度以弧度为单位）。每 $ K $ 个微步块结束后，执行一次部分动量刷新 $ v \\leftarrow \\rho v + \\sqrt{1 - \\rho^2} \\, \\eta $，其中 $ \\eta \\sim \\mathcal{N}(0,1) $ 是独立的标准高斯噪声，而 $ \\rho \\in [0,1) $ 是一个固定的刷新系数。位置仅在每次动量刷新后立即记录（即在刷新时刻）。假设刷新成本相对于力-梯度评估可忽略不计，并且每个微步恰好消耗 $ 1 $ 次梯度评估。\n\n仅从以下基本原理出发：\n- 在 $ H(x,v) = \\tfrac{1}{2} x^2 + \\tfrac{1}{2} v^2 $ 下，高斯目标的哈密顿方程，这意味着时间 $ t $ 内的精确流是在 $ (x,v) $ 平面中一个角度为 $ t $ 的旋转，并保持具有独立标准正态边缘分布（对于 $ x $ 和 $ v $）的正则测度。\n- 自回归相关性、积分自相关时间和有效样本量 (ESS) 的定义，其中对于一个滞后自相关函数为 $ \\rho_\\ell $ 的平稳标量过程，其积分自相关时间为 $ \\tau_{\\mathrm{int}} = 1 + 2 \\sum_{\\ell=1}^{\\infty} \\rho_\\ell $，而对于 $ N $ 个样本，有效样本量为 $ \\mathrm{ESS} = \\dfrac{N}{\\tau_{\\mathrm{int}}} $。\n\n任务：\n1) 从第一性原理推导记录的位置过程 $ \\{x_n\\} $（在刷新时刻采样的位置）的一步滞后自相关，作为 $ K $ 和 $ h $ 的函数。解释它是否以及为什么依赖于刷新系数 $ \\rho $。\n2) 使用任务1的结果，推导 $ \\{x_n\\} $ 的积分自相关时间 $ \\tau_{\\mathrm{int}}(K,h) $，然后推导每个记录样本的有效样本量 $ \\mathrm{ESS}_{\\mathrm{per\\mbox{-}sample}}(K,h) $。\n3) 将计算成本转换为每次梯度评估的有效样本量 $ \\mathrm{ESS}_{\\mathrm{per\\mbox{-}grad}}(K,h) $，方法是考虑记录样本之间的 $ K $ 个微步。将改进因子 $ I(K,h) $ 定义为比率 $ \\dfrac{\\mathrm{ESS}_{\\mathrm{per\\mbox{-}grad}}(K,h)}{\\mathrm{ESS}_{\\mathrm{per\\mbox{-}grad}}(1,h)} $。\n4) 实现一个程序，为给定的测试套件计算理论改进因子 $ I(K,h) $。角度必须以弧度处理。程序必须将改进因子输出为四舍五入到六位小数的浮点数。最终输出格式必须是单个行，包含一个用方括号括起来的逗号分隔列表。\n\n按此确切顺序评估并报告 $ I(K,h) $ 的测试套件：\n- 情况 1：$ h = 0.2 $，$ K = 1 $。\n- 情况 2：$ h = 0.2 $，$ K = 7 $。\n- 情况 3：$ h = 0.2 $，$ K = 8 $。\n- 情况 4：$ h = 0.2 $，$ K = 16 $。\n- 情况 5：$ h = 0.3 $，$ K = 5 $。\n- 情况 6：$ h = 0.2 $，$ K = 31 $。\n\n您的程序应生成单行输出，其中包含结果，格式为用方括号括起来的逗号分隔列表（例如 $ [r_1,r_2,\\dots,r_6] $），其中每个 $ r_i $ 是相应情况下四舍五入到六位小数的理论改进因子 $ I(K,h) $。不允许有其他输出。",
            "solution": "该问题经评估有效，因为它具有科学依据、问题设定良好且客观。它为随机模拟方法中的一个标准问题提供了完整且一致的设置。因此，我们可以进行形式化推导。\n\n总体任务是确定一个欠阻尼朗之万动力学积分器在简谐振子势下的采样效率，该效率是两次动量刷新之间所采取的哈密顿步数 $K$ 的函数。效率通过单位计算成本的有效样本量 (ESS) 来量化，其中成本以梯度评估的次数来衡量。\n\n设在第 $n$ 步，紧接着动量刷新之后，一维系统的状态由相空间向量 $(x_n, v_n)$ 表示。该动力学的平稳分布是正则分布，对于给定的哈密顿量 $H(x,v) = \\tfrac{1}{2} x^2 + \\tfrac{1}{2} v^2$，在单位质量 $m=1$ 和单位逆温度 $\\beta=1$ 的情况下，它是两个独立标准正态分布的乘积。因此，在平稳状态下，我们有：\n$\\mathbb{E}[x_n] = 0$, $\\mathbb{E}[v_n] = 0$\n$\\mathrm{Var}(x_n) = \\mathbb{E}[x_n^2] = 1$\n$\\mathrm{Var}(v_n) = \\mathbb{E}[v_n^2] = 1$\n$\\mathrm{Cov}(x_n, v_n) = \\mathbb{E}[x_n v_n] = 0$\n\n从 $(x_n, v_n)$ 到 $(x_{n+1}, v_{n+1})$ 的演化包括两个部分：\n1.  **哈密顿流：** 状态 $(x_n, v_n)$ 在哈密顿方程下演化时间 $t = K h$。对于谐波势 $U(x) = \\tfrac{1}{2}x^2$，运动方程为 $\\dot{x} = v$ 和 $\\dot{v} = -x$。其解是 $(x,v)$ 相平面中的一个旋转。设下一次刷新前的状态为 $(x'_{n+1}, v'_{n+1})$。以角度 $\\theta = K h$ 计，变换为：\n$$\n\\begin{pmatrix} x'_{n+1} \\\\ v'_{n+1} \\end{pmatrix} =\n\\begin{pmatrix} \\cos(K h)  \\sin(K h) \\\\ -\\sin(K h)  \\cos(K h) \\end{pmatrix}\n\\begin{pmatrix} x_n \\\\ v_n \\end{pmatrix}\n$$\n2.  **动量刷新：** 应用部分动量刷新。位置不变，$x_{n+1} = x'_{n+1}$，而速度更新为：\n$$\nv_{n+1} = \\rho v'_{n+1} + \\sqrt{1 - \\rho^2} \\, \\eta_n\n$$\n其中 $\\eta_n \\sim \\mathcal{N}(0,1)$ 是一个独立于 $(x_n, v_n)$ 的标准高斯随机变量。\n\n记录的样本是每次刷新后立即获取的位置 $x_n$。\n\n**任务 1：一步滞后自相关**\n\n我们需要计算位置过程 $\\{x_n\\}$ 的滞后-1自相关，定义为 $\\rho_1 = \\mathrm{Corr}(x_{n+1}, x_n)$。由于该过程是平稳的，均值为零，方差为一，因此简化为 $\\rho_1 = \\mathbb{E}[x_{n+1} x_n]$。\n\n第 $n+1$ 步的位置由哈密顿流部分给出：\n$$\nx_{n+1} = x'_{n+1} = x_n \\cos(K h) + v_n \\sin(K h)\n$$\n我们计算乘积 $x_{n+1} x_n$ 的期望：\n$$\n\\mathbb{E}[x_{n+1} x_n] = \\mathbb{E}[(x_n \\cos(K h) + v_n \\sin(K h)) x_n]\n$$\n根据期望的线性性：\n$$\n\\mathbb{E}[x_{n+1} x_n] = \\mathbb{E}[x_n^2] \\cos(K h) + \\mathbb{E}[x_n v_n] \\sin(K h)\n$$\n使用平稳性质 $\\mathbb{E}[x_n^2] = 1$ 和 $\\mathbb{E}[x_n v_n] = 0$：\n$$\n\\rho_1 = (1) \\cos(K h) + (0) \\sin(K h) = \\cos(K h)\n$$\n滞后-1自相关为 $\\rho_1 = \\cos(K h)$。此结果取决于 $K$ 和 $h$，但它不依赖于刷新系数 $\\rho$。这是因为位置 $x_{n+1}$ 完全由状态 $(x_n, v_n)$ 和哈密顿演化决定。涉及 $\\rho$ 的动量刷新仅影响后续的速度 $v_{n+1}$，因此影响滞后为2及更高的相关性，但不影响 $x_n$ 和 $x_{n+1}$ 之间的相关性。\n\n**任务 2：积分自相关时间与每样本有效样本量**\n\n为了推导积分自相关时间 $\\tau_{\\mathrm{int}} = 1 + 2 \\sum_{\\ell=1}^{\\infty} \\rho_\\ell$，我们需要完整的自相关函数 $\\{\\rho_\\ell\\}_{\\ell \\ge 1}$。这需要建立过程 $\\{x_n\\}$ 的时间序列结构。让我们写出完整的更新方程：\n$$\nx_{n+1} = x_n \\cos(K h) + v_n \\sin(K h)\n$$\n$$\nv_{n+1} = \\rho (-x_n \\sin(K h) + v_n \\cos(K h)) + \\sqrt{1 - \\rho^2} \\eta_n\n$$\n这些方程描述了一个1阶向量自回归过程。通过消去速度变量，我们可以找到仅关于位置过程 $\\{x_n\\}$ 的递推关系。从第一个方程，我们可以用位置表示 $v_n$：$v_n \\sin(K h) = x_{n+1} - x_n \\cos(K h)$。将索引前移-1，我们得到 $v_{n-1} \\sin(K h) = x_n - x_{n-1} \\cos(K h)$。$v_n$ 的速度更新为 $v_n = \\rho (-x_{n-1} \\sin(K h) + v_{n-1} \\cos(K h)) + \\sqrt{1 - \\rho^2} \\eta_{n-1}$。代入 $v_n$ 和 $v_{n-1}$ 的表达式，可以得到一个仅关于位置的递推关系。这种代数操作证实了 $\\{x_n\\}$ 服从一个AR(2)过程：\n$$\nx_{n+1} = \\phi_1 x_n + \\phi_2 x_{n-1} + \\text{noise}_n\n$$\n其系数为 $\\phi_1 = (1+\\rho)\\cos(K h)$ 和 $\\phi_2 = -\\rho$。此过程的自相关 $\\rho_\\ell$ 满足Yule-Walker方程：$\\rho_\\ell = \\phi_1 \\rho_{\\ell-1} + \\phi_2 \\rho_{\\ell-2}$ 对于 $\\ell \\ge 2$。将此递推关系从 $\\ell=2$ 到 $\\infty$ 求和，可以找到总和 $S = \\sum_{\\ell=1}^\\infty \\rho_\\ell$：\n$$\nS = \\frac{\\rho_1 + \\phi_2}{1 - \\phi_1 - \\phi_2} = \\frac{\\cos(K h) - \\rho}{1 - (1+\\rho)\\cos(K h) + \\rho} = \\frac{\\cos(K h) - \\rho}{(1+\\rho)(1-\\cos(K h))}\n$$\n于是，积分自相关时间为：\n$$\n\\tau_{\\mathrm{int}}(K, h, \\rho) = 1 + 2 S = 1 + 2 \\frac{\\cos(K h) - \\rho}{(1+\\rho)(1-\\cos(K h))} = \\frac{(1-\\rho)(1+\\cos(K h))}{(1+\\rho)(1-\\cos(K h))}\n$$\n每个记录样本的有效样本量是积分自相关时间的倒数：\n$$\n\\mathrm{ESS}_{\\mathrm{per\\mbox{-}sample}}(K, h, \\rho) = \\frac{1}{\\tau_{\\mathrm{int}}} = \\frac{(1+\\rho)(1-\\cos(K h))}{(1-\\rho)(1+\\cos(K h))}\n$$\n\n**任务 3：每次梯度评估的ESS与改进因子**\n\n生成一个样本 $x_n$ 的计算成本主要由哈密顿积分期间执行的 $K$ 次梯度评估决定。我们被告知此成本恰好为 $K$ 个单位。因此，每次梯度评估的ESS为：\n$$\n\\mathrm{ESS}_{\\mathrm{per\\mbox{-}grad}}(K, h, \\rho) = \\frac{\\mathrm{ESS}_{\\mathrm{per\\mbox{-}sample}}}{K} = \\frac{1}{K \\tau_{\\mathrm{int}}} = \\frac{1}{K} \\frac{(1+\\rho)(1-\\cos(K h))}{(1-\\rho)(1+\\cos(K h))}\n$$\n改进因子 $I(K,h)$ 是给定 $(K,h)$ 的此效率度量与具有相同步长 $h$ 的基准情况 $K=1$ 的比率：\n$$\nI(K, h) = \\frac{\\mathrm{ESS}_{\\mathrm{per\\mbox{-}grad}}(K, h, \\rho)}{\\mathrm{ESS}_{\\mathrm{per\\mbox{-}grad}}(1, h, \\rho)} = \\frac{\\frac{1}{K} \\frac{(1+\\rho)(1-\\cos(K h))}{(1-\\rho)(1+\\cos(K h))}}{\\frac{1}{1} \\frac{(1+\\rho)(1-\\cos(h))}{(1-\\rho)(1+\\cos(h))}}\n$$\n关键的是，因子 $\\frac{1+\\rho}{1-\\rho}$ 被消掉了，使得改进因子与刷新系数 $\\rho$ 无关：\n$$\nI(K, h) = \\frac{1}{K} \\frac{1-\\cos(K h)}{1+\\cos(K h)} \\frac{1+\\cos(h)}{1-\\cos(h)}\n$$\n使用三角半角恒等式 $1-\\cos(\\theta) = 2\\sin^2(\\theta/2)$ 和 $1+\\cos(\\theta) = 2\\cos^2(\\theta/2)$，我们可以简化表达式 $\\frac{1-\\cos(\\theta)}{1+\\cos(\\theta)} = \\tan^2(\\theta/2)$：\n$$\nI(K, h) = \\frac{1}{K} \\frac{\\tan^2(K h/2)}{\\tan^2(h/2)} = \\frac{1}{K} \\left( \\frac{\\tan(K h/2)}{\\tan(h/2)} \\right)^2\n$$\n这是理论改进因子的最终公式。\n\n**任务 4：实现**\n\n推导出的 $I(K,h)$ 公式在一个 Python 程序中实现。该程序为提供的测试套件中的每一对 $(K,h)$ 计算此值。根据标准数值库中三角函数的要求，角度以弧度处理。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the theoretical improvement factor I(K,h) for a series of test cases\n    based on the derived formula for underdamped Langevin dynamics on a quadratic potential.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (h, K)\n        (0.2, 1),\n        (0.2, 7),\n        (0.2, 8),\n        (0.2, 16),\n        (0.3, 5),\n        (0.2, 31),\n    ]\n\n    results = []\n    for h, K in test_cases:\n        # The derived formula for the improvement factor is:\n        # I(K, h) = (1/K) * (tan(K*h/2) / tan(h/2))^2\n        # The problem states angles are in radians, and numpy's trigonometric functions\n        # expect radians by default.\n        # The problem states h  0, so tan(h/2) is not zero.\n        \n        # Calculate arguments for the tan function\n        kh_div_2 = K * h / 2.0\n        h_div_2 = h / 2.0\n        \n        # Compute the ratio of tangents\n        tan_ratio = np.tan(kh_div_2) / np.tan(h_div_2)\n        \n        # Compute the improvement factor\n        improvement_factor = (1.0 / K) * (tan_ratio ** 2)\n        \n        # Round the result to six decimal places as required.\n        results.append(round(improvement_factor, 6))\n\n    # Final print statement in the exact required format.\n    # The map(str, ...) conversion is sufficient as per standard float-to-string conversion.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}