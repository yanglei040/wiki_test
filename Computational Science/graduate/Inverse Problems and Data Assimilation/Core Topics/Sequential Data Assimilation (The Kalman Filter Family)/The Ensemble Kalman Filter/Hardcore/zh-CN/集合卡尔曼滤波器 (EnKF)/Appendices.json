{
    "hands_on_practices": [
        {
            "introduction": "为了巩固对集合卡尔曼滤波器（EnKF）核心机制的理解，我们从一个基础的计算练习开始。这个练习将引导你手动计算EnKF分析步骤中的所有关键量。通过这个具体的小规模算例，你将清楚地看到集合统计量（如样本均值和协方差）是如何被用来近似标准卡尔曼滤波器中的更新方程的，从而将抽象的理论与实际的数值计算联系起来。",
            "id": "3425297",
            "problem": "考虑在集成卡尔曼滤波器（EnKF）中使用的线性高斯数据同化设定，其中状态存在于$\\mathbb{R}^{2}$中，观测空间为$\\mathbb{R}^{1}$。给定一个由$N=4$个状态向量组成的集合\n$$\nx^{(1)}=\\begin{pmatrix}2\\\\0\\end{pmatrix},\\quad\nx^{(2)}=\\begin{pmatrix}0\\\\2\\end{pmatrix},\\quad\nx^{(3)}=\\begin{pmatrix}2\\\\4\\end{pmatrix},\\quad\nx^{(4)}=\\begin{pmatrix}4\\\\2\\end{pmatrix},\n$$\n以及一个线性观测算子\n$$\nH=\\begin{pmatrix}1  1\\end{pmatrix}\\in\\mathbb{R}^{1\\times 2}.\n$$\n假设观测误差$\\eta$是加性的、与状态无关且服从高斯分布，其均值为零，协方差$R\\in\\mathbb{R}^{1\\times 1}$由$R=\\frac{4}{3}$给出。\n\n仅使用样本均值、异常矩阵、样本协方差和线性高斯更新的基本定义，完成以下步骤：\n\n1. 计算样本均值$\\bar{x}\\in\\mathbb{R}^{2}$和异常矩阵$A\\in\\mathbb{R}^{2\\times 4}$，其中第$i$列为$x^{(i)}-\\bar{x}$。\n2. 计算由$P=\\frac{1}{N-1}AA^{\\top}$定义的样本协方差$P\\in\\mathbb{R}^{2\\times 2}$。\n3. 计算由$P^{xy}=\\frac{1}{N-1}AA^{\\top}H^{\\top}$定义的状态-观测交叉协方差$P^{xy}\\in\\mathbb{R}^{2\\times 1}$。\n4. 在线性高斯模型$y=Hx+\\eta$（其中$\\eta\\sim\\mathcal{N}(0,R)$）中，从第一性原理出发，使用标准的线性高斯贝叶斯更新推导新息协方差$S\\in\\mathbb{R}^{1\\times 1}$和卡尔曼增益$K\\in\\mathbb{R}^{2\\times 1}$。然后，根据给定的$H$、$P$和$R$计算$S$和$K$。\n\n您的最终答案必须是卡尔曼增益向量$K$的第一个分量，表示为一个精确的实数。不要四舍五入，最终答案中不要包含任何单位。",
            "solution": "该问题陈述经核实具有科学依据，是适定的、客观的、自洽的且一致的。它展示了集成卡尔曼滤波器框架下的一个标准计算练习，该滤波器是数据同化领域中一种成熟的方法。所有必要的数据、定义和约束均已提供，不存在矛盾或歧义。因此，该问题被认定为有效，并提供解答如下。\n\n解答过程遵循问题陈述中概述的四个步骤。\n\n1. 计算样本均值$\\bar{x}$和异常矩阵$A$。\n样本均值$\\bar{x} \\in \\mathbb{R}^{2}$是$N=4$个集合成员$x^{(i)}$的平均值：\n$$\n\\bar{x} = \\frac{1}{N} \\sum_{i=1}^{N} x^{(i)} = \\frac{1}{4} \\left( x^{(1)} + x^{(2)} + x^{(3)} + x^{(4)} \\right)\n$$\n代入给定的集合向量：\n$$\n\\bar{x} = \\frac{1}{4} \\left( \\begin{pmatrix}2\\\\0\\end{pmatrix} + \\begin{pmatrix}0\\\\2\\end{pmatrix} + \\begin{pmatrix}2\\\\4\\end{pmatrix} + \\begin{pmatrix}4\\\\2\\end{pmatrix} \\right) = \\frac{1}{4} \\begin{pmatrix}2+0+2+4\\\\0+2+4+2\\end{pmatrix} = \\frac{1}{4} \\begin{pmatrix}8\\\\8\\end{pmatrix} = \\begin{pmatrix}2\\\\2\\end{pmatrix}.\n$$\n异常矩阵$A \\in \\mathbb{R}^{2\\times 4}$以异常向量$a^{(i)} = x^{(i)} - \\bar{x}$为其列向量。\n$$\na^{(1)} = x^{(1)} - \\bar{x} = \\begin{pmatrix}2\\\\0\\end{pmatrix} - \\begin{pmatrix}2\\\\2\\end{pmatrix} = \\begin{pmatrix}0\\\\-2\\end{pmatrix}\n$$\n$$\na^{(2)} = x^{(2)} - \\bar{x} = \\begin{pmatrix}0\\\\2\\end{pmatrix} - \\begin{pmatrix}2\\\\2\\end{pmatrix} = \\begin{pmatrix}-2\\\\0\\end{pmatrix}\n$$\n$$\na^{(3)} = x^{(3)} - \\bar{x} = \\begin{pmatrix}2\\\\4\\end{pmatrix} - \\begin{pmatrix}2\\\\2\\end{pmatrix} = \\begin{pmatrix}0\\\\2\\end{pmatrix}\n$$\n$$\na^{(4)} = x^{(4)} - \\bar{x} = \\begin{pmatrix}4\\\\2\\end{pmatrix} - \\begin{pmatrix}2\\\\2\\end{pmatrix} = \\begin{pmatrix}2\\\\0\\end{pmatrix}\n$$\n将这些列向量组合成矩阵$A$：\n$$\nA = \\begin{pmatrix} 0  -2  0  2 \\\\ -2  0  2  0 \\end{pmatrix}.\n$$\n\n2. 计算样本协方差$P$。\n样本协方差矩阵$P \\in \\mathbb{R}^{2\\times 2}$定义为$P=\\frac{1}{N-1}AA^{\\top}$。当$N=4$时，这变为$P=\\frac{1}{3}AA^{\\top}$。\n首先，我们计算乘积$AA^{\\top}$：\n$$\nA A^{\\top} = \\begin{pmatrix} 0  -2  0  2 \\\\ -2  0  2  0 \\end{pmatrix} \\begin{pmatrix} 0  -2 \\\\ -2  0 \\\\ 0  2 \\\\ 2  0 \\end{pmatrix}\n$$\n所得$2 \\times 2$矩阵的各分量为：\n$$\n(AA^{\\top})_{11} = (0)(0) + (-2)(-2) + (0)(0) + (2)(2) = 0 + 4 + 0 + 4 = 8\n$$\n$$\n(AA^{\\top})_{12} = (0)(-2) + (-2)(0) + (0)(2) + (2)(0) = 0 + 0 + 0 + 0 = 0\n$$\n$$\n(AA^{\\top})_{21} = (-2)(0) + (0)(-2) + (2)(0) + (0)(0) = 0 + 0 + 0 + 0 = 0\n$$\n$$\n(AA^{\\top})_{22} = (-2)(-2) + (0)(0) + (2)(2) + (0)(0) = 4 + 0 + 4 + 0 = 8\n$$\n所以，\n$$\nAA^{\\top} = \\begin{pmatrix} 8  0 \\\\ 0  8 \\end{pmatrix}.\n$$\n现在，我们计算$P$：\n$$\nP = \\frac{1}{3} \\begin{pmatrix} 8  0 \\\\ 0  8 \\end{pmatrix} = \\begin{pmatrix} \\frac{8}{3}  0 \\\\ 0  \\frac{8}{3} \\end{pmatrix}.\n$$\n\n3. 计算状态-观测交叉协方差$P^{xy}$。\n状态-观测交叉协方差$P^{xy} \\in \\mathbb{R}^{2\\times 1}$定义为$P^{xy}=\\frac{1}{N-1}AA^{\\top}H^{\\top}$。这等价于$P^{xy} = PH^{\\top}$。\n给定观测算子$H = \\begin{pmatrix} 1  1 \\end{pmatrix}$，其转置为$H^{\\top} = \\begin{pmatrix} 1 \\\\ 1 \\end{pmatrix}$。\n我们现在可以计算$P^{xy}$：\n$$\nP^{xy} = PH^{\\top} = \\begin{pmatrix} \\frac{8}{3}  0 \\\\ 0  \\frac{8}{3} \\end{pmatrix} \\begin{pmatrix} 1 \\\\ 1 \\end{pmatrix} = \\begin{pmatrix} (\\frac{8}{3})(1) + (0)(1) \\\\ (0)(1) + (\\frac{8}{3})(1) \\end{pmatrix} = \\begin{pmatrix} \\frac{8}{3} \\\\ \\frac{8}{3} \\end{pmatrix}.\n$$\n\n4. 推导和计算新息协方差$S$和卡尔曼增益$K$。\n我们在线性高斯设置下从第一性原理推导$S$和$K$的表达式。状态$x$是一个随机变量，其均值为$E[x] = \\bar{x}$，协方差为$\\text{cov}(x) = P$。观测模型为$y = Hx + \\eta$，其中观测误差$\\eta$是一个随机变量，其$E[\\eta]=0$，$\\text{cov}(\\eta)=R$，且$\\eta$独立于$x$。\n\n新息协方差$S \\in \\mathbb{R}^{1\\times 1}$是观测值$y$的协方差，即$S = \\text{cov}(y)$。\n$$\nS = \\text{cov}(Hx + \\eta)\n$$\n由于$x$和$\\eta$是独立的，它们和的协方差等于它们协方差的和：\n$$\nS = \\text{cov}(Hx) + \\text{cov}(\\eta)\n$$\n利用线性变换的协方差性质$\\text{cov}(Ax) = A \\text{cov}(x) A^{\\top}$，我们有$\\text{cov}(Hx) = H \\text{cov}(x) H^{\\top} = HPH^{\\top}$。误差的协方差已知为$\\text{cov}(\\eta)=R$。\n因此，新息协方差为：\n$$\nS = HPH^{\\top} + R.\n$$\n卡尔曼增益$K \\in \\mathbb{R}^{2\\times 1}$是提供状态估计最优更新的线性算子。它由$K = P^{xy}S^{-1}$给出，其中$P^{xy}$是状态$x$和观测$y$之间的交叉协方差。我们来推导$P^{xy}$：\n$$\nP^{xy} = \\text{cov}(x, y) = \\text{cov}(x, Hx + \\eta)\n$$\n根据协方差的线性性质：\n$$\nP^{xy} = \\text{cov}(x, Hx) + \\text{cov}(x, \\eta)\n$$\n由于$x$和$\\eta$是独立的，$\\text{cov}(x, \\eta) = 0$。利用性质$\\text{cov}(x, Ax) = \\text{cov}(x,x)A^{\\top}$，我们得到：\n$$\nP^{xy} = \\text{cov}(x, x)H^{\\top} = PH^{\\top}.\n$$\n这证实了所提供的$P^{xy}$定义与第一性原理推导的一致性。\n综合这些结果，卡尔曼增益为：\n$$\nK = PH^{\\top} (HPH^{\\top} + R)^{-1}.\n$$\n现在我们计算$S$和$K$的数值。\n首先，计算$HPH^{\\top}$：\n$$\nHPH^{\\top} = \\begin{pmatrix} 1  1 \\end{pmatrix} \\begin{pmatrix} \\frac{8}{3}  0 \\\\ 0  \\frac{8}{3} \\end{pmatrix} \\begin{pmatrix} 1 \\\\ 1 \\end{pmatrix} = \\begin{pmatrix} \\frac{8}{3}  \\frac{8}{3} \\end{pmatrix} \\begin{pmatrix} 1 \\\\ 1 \\end{pmatrix} = \\frac{8}{3} + \\frac{8}{3} = \\frac{16}{3}.\n$$\n接下来，计算$S = HPH^{\\top} + R$。已知$R = \\frac{4}{3}$：\n$$\nS = \\frac{16}{3} + \\frac{4}{3} = \\frac{20}{3}.\n$$\n由于$S$是一个标量（$1 \\times 1$矩阵），其逆是它的倒数：\n$$\nS^{-1} = \\left(\\frac{20}{3}\\right)^{-1} = \\frac{3}{20}.\n$$\n最后，我们计算卡尔曼增益$K = P^{xy}S^{-1} = PH^{\\top}S^{-1}$：\n$$\nK = \\begin{pmatrix} \\frac{8}{3} \\\\ \\frac{8}{3} \\end{pmatrix} \\left(\\frac{3}{20}\\right) = \\begin{pmatrix} \\frac{8}{3} \\cdot \\frac{3}{20} \\\\ \\frac{8}{3} \\cdot \\frac{3}{20} \\end{pmatrix} = \\begin{pmatrix} \\frac{8}{20} \\\\ \\frac{8}{20} \\end{pmatrix} = \\begin{pmatrix} \\frac{2}{5} \\\\ \\frac{2}{5} \\end{pmatrix}.\n$$\n问题要求的是卡尔曼增益向量$K$的第一个分量。\n第一个分量是$K_1 = \\frac{2}{5}$。",
            "answer": "$$\\boxed{\\frac{2}{5}}$$"
        },
        {
            "introduction": "在掌握了基本计算之后，下一个练习将引导我们探索EnKF的一个根本性理论问题：集合大小与状态可观测性之间的关系。当观测数据仅能提供系统部分信息时（即观测算子 $H$ 是秩亏的），EnKF能否正确更新那些未被直接观测到的状态分量？这个问题将从第一性原理出发，推导出一个关键结论，即为了让滤波器有能力在所有未观测方向上进行调整，所需的最小集合成员数。",
            "id": "3425309",
            "problem": "考虑一个线性逆问题，其状态向量为 $x \\in \\mathbb{R}^{d}$，观测值为 $y \\in \\mathbb{R}^{r}$，由 $y = H x + v$ 给出。其中，观测算子 $H \\in \\mathbb{R}^{r \\times d}$ 的秩为 $r$ 且 $r  d$，观测噪声 $v$ 服从零均值高斯分布，其协方差 $R \\in \\mathbb{R}^{r \\times r}$ 是对称正定的。使用集成卡尔曼滤波器 (EnKF)，其 $N$ 个集成成员 $\\{x^{f,(i)}\\}_{i=1}^{N}$ 从一个满秩高斯先验分布 $\\mathcal{N}(m^{f}, B)$ 中抽取，其中 $B \\in \\mathbb{R}^{d \\times d}$ 是对称正定的。设集成均值为 $\\bar{x}^{f} = \\frac{1}{N} \\sum_{i=1}^{N} x^{f,(i)}$，扰动矩阵为 $A \\in \\mathbb{R}^{d \\times N}$，其列向量为 $a^{(i)} = x^{f,(i)} - \\bar{x}^{f}$，因此有 $\\sum_{i=1}^{N} a^{(i)} = 0$。样本预报协方差为 $P^{f} = \\frac{1}{N-1} A A^{\\top}$。\n\n假设 EnKF 执行单个线性分析步骤，使用确定性卡尔曼增益，并且所有集成成员使用相同的观测值 $y$。您只能使用以下基本事实：(i) EnKF 的分析增量是预报扰动通过样本协方差 $P^{f}$ 和观测算子 $H$ 的线性映射；(ii) $P^{f}$ 的值域等于 $A$ 的列向量的张成空间；以及 (iii) 零空间 $\\mathcal{N}(H) = \\{ z \\in \\mathbb{R}^{d} : H z = 0 \\}$ 的维数为 $d - r$。不得调用任何其他简便公式。\n\n使用秩亏的 $H$ 进行部分观测会使 $\\mathcal{N}(H)$ 中的方向未被观测到。为了使 EnKF 分析能够在一个分析步骤中表示和调整 $\\mathcal{N}(H)$ 中的任何未被观测到的方向，集成扰动子空间必须能张成 $\\mathcal{N}(H)$。请从第一性原理推导最小集成大小 $N_{\\mathrm{min}}$（作为 $d$ 和 $r$ 的函数），使得在一种集成扰动的构造下，该构造包含 $\\mathcal{N}(H)$ 中的 $d-r$ 个线性无关向量，并满足扰动的零均值约束，扰动的张成空间包含 $\\mathcal{N}(H)$，从而 EnKF 分析增量可以表示所有未被观测到的方向。\n\n请用 $d$ 和 $r$ 的闭式表达式给出您的最终答案 $N_{\\mathrm{min}}$。无需四舍五入，也不涉及单位。",
            "solution": "问题要求的是，为了使集成卡尔曼滤波器（EnKF）的分析更新能够表示观测算子 $H$ 的零空间中的任意方向，所需的最小集成大小 $N_{\\mathrm{min}}$。这种能力取决于由集成扰动所张成的子空间是否包含 $H$ 的零空间。\n\n设 $N$ 个预报集成扰动的集合为 $\\{a^{(1)}, a^{(2)}, \\dots, a^{(N)}\\}$，其中每个 $a^{(i)} \\in \\mathbb{R}^{d}$。根据定义，这些扰动满足零均值约束：\n$$ \\sum_{i=1}^{N} a^{(i)} = 0 $$\n设 $S$ 为这些扰动所张成的子空间，通常称为集成子空间：\n$$ S = \\text{span}\\{a^{(1)}, a^{(2)}, \\dots, a^{(N)}\\} $$\n问题指出，EnKF 的分析增量被限制在该子空间 $S$ 内。状态空间中不受观测 $y$ 约束的方向是观测算子 $H$ 的零空间中的向量，记为 $\\mathcal{N}(H)$。为了使 EnKF 分析能够对这些未被观测到的方向进行校正，集成子空间 $S$ 必须包含零空间 $\\mathcal{N}(H)$。这就给出了基本要求：\n$$ \\mathcal{N}(H) \\subseteq S $$\n这种集合包含关系意味着这两个子空间的维数之间存在一种关系：\n$$ \\dim(\\mathcal{N}(H)) \\le \\dim(S) $$\n我们现在来确定 $\\mathcal{N}(H)$ 和 $S$ 的维数。\n\n首先，我们确定零空间的维数 $\\dim(\\mathcal{N}(H))$。观测算子 $H$ 是一个从 $\\mathbb{R}^{d}$到 $\\mathbb{R}^{r}$ 的线性映射。根据秩-零度定理，$\\text{rank}(H) + \\dim(\\mathcal{N}(H)) = d$。问题指明 $\\text{rank}(H) = r$。因此：\n$$ r + \\dim(\\mathcal{N}(H)) = d $$\n$$ \\dim(\\mathcal{N}(H)) = d - r $$\n\n接下来，我们确定集成子空间维数 $\\dim(S)$ 的一个上界。由于零均值约束 $\\sum_{i=1}^{N} a^{(i)} = 0$，张成 $S$ 的 $N$ 个扰动向量不是线性无关的。这个约束意味着任何一个扰动向量都可以表示为其他向量的线性组合，例如，$a^{(N)} = -\\sum_{i=1}^{N-1} a^{(i)}$。因此，这 $N$ 个扰动的集合最多能张成一个维数为 $N-1$ 的子空间。于是，我们得到不等式：\n$$ \\dim(S) \\le N-1 $$\n\n综合我们的发现，我们得到一个不等式链：\n$$ d-r = \\dim(\\mathcal{N}(H)) \\le \\dim(S) \\le N-1 $$\n由此，我们推导出关于集成大小 $N$ 的一个必要条件：\n$$ d-r \\le N-1 $$\n$$ N \\ge d-r+1 $$\n这就确定了最小集成大小 $N_{\\mathrm{min}}$ 必须至少为 $d-r+1$。\n\n为了证明这个下界是可达到的，我们必须证明可以构造一个大小为 $N = d-r+1$ 的集成来满足问题的所有条件。这些条件是：\n1.  满足零均值约束。\n2.  集成扰动 $\\{a^{(i)}\\}$ 包含 $\\mathcal{N}(H)$ 中 $d-r$ 个线性无关向量的子集。\n3.  扰动的张成空间 $S$ 包含 $\\mathcal{N}(H)$。\n\n让我们构造一个有 $N = d-r+1$ 个成员的这样的集成。\n设 $\\{v_1, v_2, \\dots, v_{d-r}\\}$ 是零空间 $\\mathcal{N}(H)$ 的一个基。这些是 $d-r$ 个线性无关的向量。\n我们将前 $d-r$ 个扰动定义为这些基向量：\n$$ a^{(i)} = v_i \\quad \\text{for } i = 1, 2, \\dots, d-r $$\n根据构造，这满足了条件 (2)。\n\n为了满足零均值约束（条件 1），所有 $N = d-r+1$ 个扰动的和必须为零向量。我们定义最后一个扰动 $a^{(d-r+1)}$ 来确保这一点：\n$$ a^{(d-r+1)} = -\\sum_{i=1}^{d-r} a^{(i)} = -\\sum_{i=1}^{d-r} v_i $$\n根据这个定义，所有扰动的和是：\n$$ \\sum_{i=1}^{d-r+1} a^{(i)} = \\left(\\sum_{i=1}^{d-r} v_i\\right) + \\left(-\\sum_{i=1}^{d-r} v_i\\right) = 0 $$\n零均值约束得到满足。\n\n最后，我们检查我们构造的扰动的张成空间是否包含 $\\mathcal{N}(H)$（条件 3）。集成子空间是：\n$$ S = \\text{span}\\{ a^{(1)}, \\dots, a^{(d-r)}, a^{(d-r+1)} \\} = \\text{span}\\{ v_1, \\dots, v_{d-r}, -\\sum_{i=1}^{d-r} v_i \\} $$\n由于集合中最后一个向量 $-\\sum_{i=1}^{d-r} v_i$ 是前 $d-r$ 个向量的线性组合，它不会扩展张成空间。因此，张成空间仅由 $\\mathcal{N}(H)$ 的基向量决定：\n$$ S = \\text{span}\\{v_1, v_2, \\dots, v_{d-r}\\} = \\mathcal{N}(H) $$\n这表明 $\\mathcal{N}(H) \\subseteq S$ 是满足的（在这种情况下，等号成立）。\n\n我们已经证明，可以构造一个大小为 $N = d-r+1$ 的集成来满足所有要求。由于我们也证明了任何满足要求的集成的大小必须至少为 $d-r+1$，因此我们得出结论，最小集成大小正是这个值。\n$$ N_{\\mathrm{min}} = d-r+1 $$",
            "answer": "$$\n\\boxed{d - r + 1}\n$$"
        },
        {
            "introduction": "理论上的EnKF在应用于复杂的、高维的现实世界问题时，会面临采样误差和模型不完美等挑战。为了应对这些问题，研究人员发展了多种实用技巧，其中最核心的两种是“协方差膨胀”和“协方差局域化”。本练习将经典的洛伦兹-63（Lorenz-63）混沌系统作为背景，要求你推导并实现一个包含这两种技巧的EnKF更新步骤，从而深刻理解它们如何修正滤波器性能，使其在实际应用中更加稳健和准确。",
            "id": "3425319",
            "problem": "给定状态为 $x = (x,y,z)^\\top \\in \\mathbb{R}^3$ 且参数为 $\\sigma>0$, $\\rho>0$, $\\beta>0$ 的洛伦兹-63（Lorenz-63）动力系统：\n$$\n\\dot{x} = \\sigma (y - x), \\quad\n\\dot{y} = x(\\rho - z) - y, \\quad\n\\dot{z} = xy - \\beta z,\n$$\n该系统在时间上以步长 $\\Delta t > 0$ 进行离散化。在给定的同化时刻，你有一个预报集合 $\\{x^{f,(j)} \\in \\mathbb{R}^3\\}_{j=1}^N$，它近似于模型单步之后的状态预报分布。对于第一个分量 $x$，存在一个带噪声的观测，其观测算子为 $H = [1,\\,0,\\,0]$，标量观测误差方差为 $R0$。你需要设计一个集合卡尔曼滤波器（EnKF, Ensemble Kalman Filter），该滤波器使用乘性膨胀和协方差局地化，从给定的预报集合中计算一个同化步骤的新息方差。\n\n假设遵循以下建模原则：\n- 在单步内，模型预报是确定性的，因此在分析时刻，唯一的随机性来源是集合离散度和观测噪声。\n- 新息是观测值与基于预报集合的模型预测观测值之间的差。\n- EnKF 使用集合来近似预报误差协方差。通过将预报集合距平乘以一个因子 $1+\\lambda$ 来应用参数为 $\\lambda \\ge 0$ 的乘性膨胀。\n- 协方差局地化通过与一个局地化相关矩阵 $C \\in \\mathbb{R}^{3 \\times 3}$ 进行舒尔（Hadamard）积来应用。使用一个高斯锥削函数定义如下：\n$$\nC_{ij} \\;=\\; \\begin{cases}\n\\exp\\!\\left(-\\tfrac{1}{2}\\left(\\frac{d_{ij}}{L}\\right)^2\\right),  \\text{若 } L0,\\\\\n1,  \\text{若 } L=0 \\text{ 且 } i=j,\\\\\n0,  \\text{若 } L=0 \\text{ 且 } i\\ne j,\n\\end{cases}\n$$\n其中 $d_{ij}$ 是状态分量 $i$ 和 $j$ 在一个单位间距的直线上的距离，即对于分别对应于 $(x,y,z)$ 的索引 $i,j \\in \\{1,2,3\\}$，$d_{ij} = |i-j|$，$L \\ge 0$ 是局地化半径（以相同的无量纲索引距离度量）。\n\n从这些原则出发，推导并实现一个算法，仅根据提供的预报集合、膨胀参数 $\\lambda$、局地化半径 $L$ 和观测误差方差 $R$ 来计算一个同化步骤的新息方差。该新息方差必须反映来自局地化、膨胀的集合推导预报协方差和观测误差方差的组合不确定性。\n\n计算的定义和约束：\n- 设预报集合矩阵为 $X^f = [x^{f,(1)}, \\dots, x^{f,(N)}] \\in \\mathbb{R}^{3 \\times N}$，其均值为 $\\bar{x}^f = \\frac{1}{N}\\sum_{j=1}^N x^{f,(j)} \\in \\mathbb{R}^3$，其距平为 $A^f = X^f - \\bar{x}^f \\mathbf{1}^\\top \\in \\mathbb{R}^{3 \\times N}$，其中 $\\mathbf{1} \\in \\mathbb{R}^{N}$ 是全一向量。使用因子为 $\\frac{1}{N-1}$ 的无偏样本协方差。\n- 在形成协方差之前，通过将距平替换为 $(1+\\lambda)A^f$ 来应用乘性膨胀。然后通过与 $C$ 的舒尔积应用协方差局地化。\n- 使用线性化观测和高斯误差框架，从局地化、膨胀的协方差和观测误差方差 $R$ 中获得新息方差。\n\n你的程序必须为以下预报集合和参数的测试套件计算新息方差。每个预报集合都以一个 $3 \\times N$ 矩阵的形式给出，其列是集合成员 $(x,y,z)^\\top$：\n\n- 测试用例 1 (正常情况):\n  - 预报集合 $X^f \\in \\mathbb{R}^{3 \\times 6}$:\n    $$\n    X^f = \\begin{bmatrix}\n    1.00  1.20  0.80  1.10  0.90  1.05 \\\\\n    1.00  0.90  1.10  1.05  0.95  1.00 \\\\\n    1.00  1.10  0.90  1.05  0.95  0.98\n    \\end{bmatrix}\n    $$\n  - $R = 0.04$, $L = 1.0$, $\\lambda = 0.10$。\n\n- 测试用例 2 (无膨胀):\n  - 预报集合 $X^f \\in \\mathbb{R}^{3 \\times 6}$ 与测试用例 1 相同。\n  - $R = 0.01$, $L = 0.5$, $\\lambda = 0.0$。\n\n- 测试用例 3 (退化的零离散度集合):\n  - 预报集合 $X^f \\in \\mathbb{R}^{3 \\times 5}$:\n    $$\n    X^f = \\begin{bmatrix}\n    2.00  2.00  2.00  2.00  2.00 \\\\\n    -1.00  -1.00  -1.00  -1.00  -1.00 \\\\\n    3.00  3.00  3.00  3.00  3.00\n    \\end{bmatrix}\n    $$\n  - $R = 0.20$, $L = 2.0$, $\\lambda = 0.50$。\n\n- 测试用例 4 (局地化半径在边界):\n  - 预报集合 $X^f \\in \\mathbb{R}^{3 \\times 4}$:\n    $$\n    X^f = \\begin{bmatrix}\n    -1.00  -1.10  -0.90  -1.05 \\\\\n    0.50  0.45  0.55  0.50 \\\\\n    2.00  2.10  1.90  2.05\n    \\end{bmatrix}\n    $$\n  - $R = 0.50$, $L = 0.0$, $\\lambda = 0.20$。\n\n你的程序应该：\n- 严格遵循上述设计原则，为每个测试用例计算给定输入的新息方差。\n- 生成一行输出，其中包含一个用方括号括起来的逗号分隔列表的结果，按测试用例 1 到 4 的顺序排列，每个条目四舍五入到 $8$ 位小数（例如，$[0.12345678,0.00000000,1.23450000,0.01020304]$）。\n\n本问题不涉及物理单位、角度或百分比。所有数值均为 $\\mathbb{R}$ 中的无量纲标量。",
            "solution": "该问题要求推导并实现一个算法，用于计算集合卡尔曼滤波器（EnKF）单个同化步骤的新息方差。该滤波器集成了乘性膨胀和协方差局地化。状态空间为 $\\mathbb{R}^3$，观测仅包含第一个状态分量。\n\n推导过程从问题陈述中给出的第一性原理出发。\n\n新息方差，记为 $S$，是新息项 $d = y^o - H \\bar{x}^f$ 的方差，其中 $y^o$ 是标量观测，$H$ 是观测算子，$\\bar{x}^f$ 是预报集合的均值。在卡尔曼滤波器所基于的标准线性-高斯框架中，新息协方差由以下公式给出：\n$$\nS = H P^f H^\\top + R_{obs}\n$$\n这里，$P^f$ 是预报误差协方差矩阵，$R_{obs}$ 是观测误差协方差矩阵。\n\n根据问题陈述：\n- 观测是对第一个状态分量的标量测量。因此，观测算子是一个行向量 $H = [1, 0, 0]$。\n- 观测误差方差是一个标量 $R  0$，所以观测误差协方差矩阵就是 $R_{obs} = R$。\n\n将 $H$ 代入 $S$ 的公式中，得到：\n$$\nS = \\begin{bmatrix} 1  0  0 \\end{bmatrix} P^f \\begin{bmatrix} 1 \\\\ 0 \\\\ 0 \\end{bmatrix} + R\n$$\n这个矩阵乘法提取了预报误差协方差矩阵的左上角元素 $(P^f)_{11}$。因此，新息方差为：\n$$\nS = (P^f)_{11} + R\n$$\n问题的核心是根据构造 $P^f$ 的指定步骤来确定 $(P^f)_{11}$。该过程包括三个步骤：从集合距平形成样本协方差，应用乘性膨胀，然后应用协方差局地化。\n\n1.  **集合样本协方差：** 无偏样本协方差矩阵由集合距平 $A^f = X^f - \\bar{x}^f \\mathbf{1}^\\top \\in \\mathbb{R}^{3 \\times N}$ 计算得出，其中 $N$ 是集合成员的数量。未膨胀的样本协方差为 $\\frac{1}{N-1} A^f (A^f)^\\top$。\n\n2.  **乘性膨胀：** 乘性膨胀通过将距平乘以一个因子 $(1+\\lambda)$ 来应用，其中 $\\lambda \\ge 0$ 是膨胀参数。膨胀后的距平为 $A^{f, \\text{inf}} = (1+\\lambda)A^f$。膨胀后的样本协方差矩阵，我们称之为 $P^f_{\\text{inf}}$，则为：\n$$\nP^f_{\\text{inf}} = \\frac{1}{N-1} A^{f, \\text{inf}} (A^{f, \\text{inf}})^\\top = \\frac{(1+\\lambda)^2}{N-1} A^f (A^f)^\\top\n$$\n\n3.  **协方差局地化：** 最终的预报协方差矩阵 $P^f$ 是通过对 $P^f_{\\text{inf}}$ 应用局地化得到的。这是通过与一个局地化矩阵 $C \\in \\mathbb{R}^{3 \\times 3}$ 进行舒尔（逐元素）积来完成的：\n$$\nP^f = C \\circ P^f_{\\text{inf}}\n$$\n这意味着最终协方差矩阵的每个元素为 $(P^f)_{ij} = C_{ij} \\cdot (P^f_{\\text{inf}})_{ij}$。\n\n我们感兴趣的是特定元素 $(P^f)_{11}$。根据舒尔积的定义：\n$$\n(P^f)_{11} = C_{11} \\cdot (P^f_{\\text{inf}})_{11}\n$$\n局地化矩阵 $C$ 是基于高斯锥削函数定义的。对于任何局地化半径 $L  0$，其元素为 $C_{ij} = \\exp(-\\frac{1}{2}(\\frac{d_{ij}}{L})^2)$，其中 $d_{ij} = |i-j|$。对于对角元素 $C_{11}$，距离为 $d_{11} = |1-1| = 0$。因此：\n$$\nC_{11} = \\exp(0) = 1\n$$\n对于边界情况 $L=0$，问题定义了如果 $i=j$ 则 $C_{ij} = 1$，否则为 $0$。所以，在这种情况下 $C_{11}=1$。因此，对于所有 $L \\ge 0$，对角元素 $C_{11}$ 总是 $1$。这是局地化函数的一个基本属性，它们被设计为相关函数，因此对角线上为一，从而保留状态变量的方差。\n\n这意味着局地化对协方差矩阵的对角元素没有影响。所以，$(P^f)_{11} = (P^f_{\\text{inf}})_{11}$。\n\n现在我们评估 $(P^f_{\\text{inf}})_{11}$。这是膨胀后样本协方差矩阵的左上角元素。设 $X^f_1$ 表示集合矩阵 $X^f$ 的第一行，它包含第一个状态分量 $x$ 的集合值。项 $\\frac{1}{N-1} A^f (A^f)^\\top$ 是样本协方差矩阵。其 $(1,1)$ 元素是第一个状态分量的无偏样本方差。我们将其表示为 $\\text{var}(X^f_1)$。\n$$\n(P^f_{\\text{inf}})_{11} = (1+\\lambda)^2 \\cdot \\text{var}(X^f_1) = (1+\\lambda)^2 \\left( \\frac{1}{N-1} \\sum_{j=1}^N (x^{f,(j)}_1 - \\bar{x}^f_1)^2 \\right)\n$$\n其中 $x^{f,(j)}_1$ 是第 $j$ 个集合成员的第一个分量，$\\bar{x}^f_1$ 是这些分量的均值。\n\n综合这些结果，新息方差 $S$ 的最终表达式为：\n$$\nS = (1+\\lambda)^2 \\cdot \\text{var}(X^f_1) + R\n$$\n该公式表明，对于单个状态变量的观测，新息方差仅取决于该特定变量的集合方差（膨胀后）和观测误差方差。局地化半径 $L$ 以及其他状态变量（$y$ 和 $z$）的集合离散度不影响结果。算法就是对每个测试用例应用此公式。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the innovation variance for a series of EnKF test cases.\n    \"\"\"\n    test_cases = [\n        {\n            \"Xf\": np.array([\n                [1.00, 1.20, 0.80, 1.10, 0.90, 1.05],\n                [1.00, 0.90, 1.10, 1.05, 0.95, 1.00],\n                [1.00, 1.10, 0.90, 1.05, 0.95, 0.98]\n            ]),\n            \"R\": 0.04,\n            \"L\": 1.0,\n            \"lambda_\": 0.10\n        },\n        {\n            \"Xf\": np.array([\n                [1.00, 1.20, 0.80, 1.10, 0.90, 1.05],\n                [1.00, 0.90, 1.10, 1.05, 0.95, 1.00],\n                [1.00, 1.10, 0.90, 1.05, 0.95, 0.98]\n            ]),\n            \"R\": 0.01,\n            \"L\": 0.5,\n            \"lambda_\": 0.0\n        },\n        {\n            \"Xf\": np.array([\n                [2.00, 2.00, 2.00, 2.00, 2.00],\n                [-1.00, -1.00, -1.00, -1.00, -1.00],\n                [3.00, 3.00, 3.00, 3.00, 3.00]\n            ]),\n            \"R\": 0.20,\n            \"L\": 2.0,\n            \"lambda_\": 0.50\n        },\n        {\n            \"Xf\": np.array([\n                [-1.00, -1.10, -0.90, -1.05],\n                [0.50, 0.45, 0.55, 0.50],\n                [2.00, 2.10, 1.90, 2.05]\n            ]),\n            \"R\": 0.50,\n            \"L\": 0.0,\n            \"lambda_\": 0.20\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        Xf = case[\"Xf\"]\n        R = case[\"R\"]\n        lambda_ = case[\"lambda_\"]\n\n        # The observation operator H = [1, 0, 0] means we only need the\n        # variance of the first state component.\n        x_component_ensemble = Xf[0, :]\n\n        # Calculate the unbiased sample variance of the first component.\n        # The factor 1/(N-1) is achieved with ddof=1 (delta degrees of freedom).\n        if len(x_component_ensemble) > 1:\n            forecast_variance = np.var(x_component_ensemble, ddof=1)\n        else:\n            forecast_variance = 0.0\n\n        # The forecast error variance from the ensemble is inflated.\n        # This corresponds to P^f_{11}, as localization does not affect\n        # the diagonal elements of the covariance matrix.\n        inflated_forecast_variance = ((1 + lambda_)**2) * forecast_variance\n\n        # The innovation variance S = H P^f H^T + R, which simplifies to\n        # S = P^f_{11} + R for H=[1,0,0].\n        innovation_variance = inflated_forecast_variance + R\n        \n        results.append(f\"{innovation_variance:.8f}\")\n\n    # Print the final result in the specified format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        }
    ]
}