## 引言
[扩展卡尔曼滤波器](@entry_id:199333)（EKF）作为处理[非线性状态估计](@entry_id:269877)问题的基石方法，在工程与科学领域得到了广泛应用。它通过巧妙地将非线性系统[局部线性化](@entry_id:169489)，成功地将线性[卡尔曼滤波器](@entry_id:145240)的最优估计框架推广到更广泛的场景中。然而，这种线性化近似正是EKF力量的源泉，也是其所有固有局限性的根源。

当系统[非线性](@entry_id:637147)程度较强、噪声呈现非高斯特性或状态存在复杂约束时，EKF的性能会显著下降，甚至导致估计结果发散。因此，深刻理解EKF的适用边界和失效模式，是成功应用该滤波器、诊断故障并决定何时转向更高级方法的关键所在。本文旨在系统性地剖析EKF的这些核心局限性。

为实现这一目标，本文将分为三个核心部分展开。在“原理与机制”一章中，我们将深入其数学核心，揭示线性化如何导致均值和[协方差估计](@entry_id:145514)产生系统性偏差。接着，在“应用与交叉学科联系”一章中，我们将通过来自机器人学、[地球科学](@entry_id:749876)和金融等领域的实例，展示这些理论局限性在真实世界复杂问题中的具体表现。最后，在“动手实践”部分，读者将通过编码练习，亲身体验EKF在特定挑战下的行为，并探索[数值稳定性](@entry_id:146550)的解决方案。通过这一结构化的学习路径，读者将对EKF的局限性建立起坚实而直观的理解。

## 原理与机制

在上一章中，我们介绍了[扩展卡尔曼滤波器](@entry_id:199333)（EKF）作为处理非线性动力学和/或观测模型的标准方法。其核心思想是通过在当前最佳估计周围进行一阶泰勒展开，将[非线性](@entry_id:637147)问题[局部线性化](@entry_id:169489)，从而应用标[准线性](@entry_id:637689)卡尔曼滤波器的框架。这种线性化近似虽然在许多情况下都非常有效，但它也是 EKF 所有固有局限性的根源。理解这些局限性的原理和机制对于在实践中成功应用 EKF、诊断其故障以及决定何时需要更先进的滤波技术至关重要。

本章将深入探讨由一阶线性化假设引起的各种基本问题。我们将系统地分析 EKF 在[状态和](@entry_id:193625)[协方差估计](@entry_id:145514)中引入的偏差，探讨其近似有效的条件，并剖析导致滤波器性能严重下降甚至完全失效的病态场景。

### 线性化引入的误差来源

EKF 的性能取决于其[局部线性](@entry_id:266981)模型在多大程度上能够捕捉[非线性](@entry_id:637147)函数在[先验概率](@entry_id:275634)[分布](@entry_id:182848)主要覆盖区域内的行为。当这种近似不准确时，就会产生多种形式的误差。

#### 均值传播：偏差的引入

EKF 的一个核心假设是，[非线性](@entry_id:637147)函数作用于一个[随机变量](@entry_id:195330)期望的结果，可以近似为该函数作用于该[随机变量](@entry_id:195330)期望的结果。具体来说，在预测步骤中，它使用 $f(\hat{x}_k)$ 来近似真实预测均值 $\mathbb{E}[f(x_k)]$；在更新步骤中，它使用 $h(\hat{x}_{k+1}^{-})$ 来近似真实预测观测值 $\mathbb{E}[h(x_{k+1})]$。然而，对于任何[非线性](@entry_id:637147)函数 $g(x)$，著名的**琴生不等式（Jensen's inequality）**告诉我们，通常情况下 $\mathbb{E}[g(x)] \neq g(\mathbb{E}[x])$。这种不等式是 EKF 估计中系统性偏差的根本来源。

考虑一个标量状态 $x \sim \mathcal{N}(\mu, P)$ 和一个指数形式的[观测算子](@entry_id:752875) $h(x) = \exp(\alpha x)$，其中 $\alpha$ 是一个常数。这种情况在许多科学问题中都会出现，例如当观测值与某个过程的强度或速率有关时。EKF 对预测观测均值的估计是 $h(\mathbb{E}[x]) = h(\mu) = \exp(\alpha \mu)$。然而，真实的期望观测值可以通过对高斯[概率密度函数](@entry_id:140610)积分直接计算得出：
$$
\mathbb{E}[h(x)] = \mathbb{E}[\exp(\alpha x)] = \int_{-\infty}^{\infty} \exp(\alpha x) \frac{1}{\sqrt{2\pi P}} \exp\left(-\frac{(x - \mu)^2}{2P}\right) dx
$$
这个积分是高斯[随机变量](@entry_id:195330)矩母函数（Moment-Generating Function）在点 $\alpha$ 处的值，其结果是：
$$
\mathbb{E}[h(x)] = \exp\left(\alpha\mu + \frac{\alpha^2 P}{2}\right)
$$
因此，EKF 在预测观测均值时引入的偏差为：
$$
b(\alpha, \mu, P) = \mathbb{E}[h(x)] - h(\mu) = \exp\left(\alpha\mu + \frac{\alpha^2 P}{2}\right) - \exp(\alpha\mu) = \exp(\alpha\mu) \left( \exp\left(\frac{\alpha^2 P}{2}\right) - 1 \right)
$$
 这个表达式明确地显示，只要[非线性](@entry_id:637147)不为零（$\alpha \neq 0$）且存在先验不确定性（$P > 0$），偏差就必然存在。偏差的大小与[非线性](@entry_id:637147)程度（由 $\alpha^2$ 体现）和先验[方差](@entry_id:200758) $P$ 都成正比。当状态不确定性较大时，EKF 的线性化假设会严重偏离真实情况，导致显著的偏差。

当噪声不是简单的[加性噪声](@entry_id:194447)，而是以状态依赖或乘性方式进入模型时，也会出现类似的偏差。例如，考虑一个模型 $z = \exp(x + \sigma x v)$，其中 $x \sim \mathcal{N}(m, P)$ 和噪声 $v \sim \mathcal{N}(0, 1)$。EKF 的常规做法会忽略噪声结构，并预测观测值为 $\exp(m)$。然而，通过使用迭代期望法则（首先对 $v$ 取期望，然后对 $x$ 取期望），可以计算出真实的期望观测值 $\mathbb{E}[z]$。这个计算过程表明，状态的不确定性与噪声的乘性相互作用会产生一个额外的正项，导致 $\mathbb{E}[z] > \exp(m)$，从而再次产生一个 EKF 无法捕捉的系统性偏差 。

#### [协方差传播](@entry_id:747989)：系统性低估

除了引入均值偏差外，线性化还会对不确定性的传播产生系统性影响。在预测步骤中，EKF 通过[雅可比矩阵](@entry_id:264467) $F_k$ 传播协[方差](@entry_id:200758)：$P_{k+1}^{-} = F_k P_k F_k^T + Q$。这个过程本质上是假设状态的不确定性通过一个线性变换传播，完全忽略了动力学模型 $f(x)$ 的曲率效应。其结果是，EKF 几乎总是低估真实的预测协[方差](@entry_id:200758)，使得滤波器变得**过度自信**。

让我们通过一个具体的例子来量化这种效应。考虑一个具有二次[非线性](@entry_id:637147)的标量动力学模型 $f(x) = \phi x + \gamma x^2$。假设在 $k$ 时刻的状态估计误差 $e_k = x_k - \hat{x}_k$ 服从零均值[高斯分布](@entry_id:154414) $e_k \sim \mathcal{N}(0, P_k)$。真实的预测[误差协[方](@entry_id:194780)差](@entry_id:200758)是 $P_{k+1}^{\mathrm{true}} = \operatorname{Var}(f(x_k) - f(\hat{x}_k) + w_k)$。通过对 $f(x_k)$ 在 $\hat{x}_k$ 附近进行[泰勒展开](@entry_id:145057)并计算其[方差](@entry_id:200758)，可以得到：
$$
\operatorname{Var}(f(x_k) - f(\hat{x}_k)) = (\phi + 2\gamma\hat{x}_k)^2 P_k + 2\gamma^2 P_k^2
$$
其中第一项 $(\phi + 2\gamma\hat{x}_k)^2 P_k$ 正是 EKF 所计算的 $(F_k)^2 P_k$。第二项 $2\gamma^2 P_k^2$ 则完全被 EKF 忽略了。因此，EKF 预测的协[方差](@entry_id:200758)与真实协[方差](@entry_id:200758)之间的差异为：
$$
\Delta P_{k+1} = P_{k+1}^{\mathrm{true}} - P_{k+1}^{\mathrm{EKF}} = 2\gamma^2 P_k^2
$$
 这个结果揭示了几个关键点。首先，协[方差](@entry_id:200758)的低估量与[非线性](@entry_id:637147)程度的平方（$\gamma^2$）和先验[方差](@entry_id:200758)的平方（$P_k^2$）成正比。这意味着当系统高度[非线性](@entry_id:637147)或状态非常不确定时，EKF 的过度自信问题会迅速恶化。其次，这种低估是系统性的，它总是导致预测的不确定性小于真实的不确定性。

这种过度自信会严重损害滤波器的性能。一个过度自信的滤波器会过度相信自己的预测，从而在更新步骤中给予新观测值过低的权重。如果滤波器持续低估其不确定性，它可能会发散，即其估计值与真实状态的偏差会不断增长，而其计算出的协[方差](@entry_id:200758)却显示出极高的[置信度](@entry_id:267904)。

在实践中，这种不一致性可以通过监控**归一化新息平方（Normalized Innovation Squared, NIS）**来诊断。对于一个表现良好的滤波器，NIS 统计量应该服从自由度等于观测维数的卡方分布。在标量情况下，这意味着其[期望值](@entry_id:153208)应为 1。然而，当 EKF 由于协[方差](@entry_id:200758)低估而变得不一致时，其计算出的新息协[方差](@entry_id:200758) $S_k$ 会小于真实的新息[方差](@entry_id:200758)。这会导致 NIS 的[期望值](@entry_id:153208)系统性地大于 1，表明滤波器对其预测的[置信度](@entry_id:267904)过高 。针对这种问题，一种实用的补救措施是“调优”[过程噪声协方差](@entry_id:186358) $Q$，例如，通过向 $Q$ 中增加一个补偿项（如 $2\gamma^2 P_k^2$）来人为地“注入”噪声，以抵消线性化所忽略的[方差](@entry_id:200758)增长项 。

#### 线性化近似的有效性边界

既然我们已经看到线性化会引入偏差和协[方差](@entry_id:200758)低估，一个自然的问题是：这种近似在什么条件下是“足够好”的？直观地说，如果先验分布足够窄，使得[非线性](@entry_id:637147)函数在该[分布](@entry_id:182848)的大部分区域内都近似线性，那么 EKF 的表现就会很好。我们可以将这个直观概念量化。

考虑一个[非线性](@entry_id:637147)观测模型 $y = h(x) + v$。EKF 的有效性取决于泰勒展开中的高阶项相对于观测噪声的[标准差](@entry_id:153618)是否可以忽略不计。我们可以用二阶泰勒余项 $r_2(x) = h(x) - h(m_0) - h'(m_0)(x - m_0)$ 来度量线性化的误差。一个合理的局部有效性判据是，在[先验分布](@entry_id:141376)下，该余项的均方根（RMS）应远小于观测噪声的[标准差](@entry_id:153618) $\sqrt{R}$。

通过将余项近似为其主导项，即二阶项 $\frac{h''(m_0)}{2}(x-m_0)^2$，并利用高斯分布的矩特性（特别是四阶[中心矩](@entry_id:270177) $\mathbb{E}[(x-m_0)^4] = 3P_0^2$），我们可以推导出余项 RMS 的一个保守近似：
$$
\sqrt{\mathbb{E}[r_2(x)^2]} \approx \frac{\sqrt{3}}{2}|h''(m_0)|P_0
$$
这个简单的表达式极具启发性：[线性化误差](@entry_id:751298)与函数的**曲率**（由[二阶导数](@entry_id:144508) $|h''(m_0)|$ 度量）和**先验不确定性**（由先验[方差](@entry_id:200758) $P_0$ 度量）的乘积成正比。

现在，我们可以施加一个明确的有效性准则，例如要求[线性化误差](@entry_id:751298)的贡献不超过观测噪声[标准差](@entry_id:153618)的某个小比例 $\eta$：
$$
\frac{\sqrt{3}}{2}|h''(m_0)|P_0 \le \eta \sqrt{R}
$$
从这个不等式中，我们可以解出满足该条件的**最大允许先验[方差](@entry_id:200758)** $P_0^\star$：
$$
P_0^\star = \frac{2 \eta \sqrt{R}}{\sqrt{3} |h''(m_0)|}
$$
 这个结果为 EKF 的适用性提供了一个定量的指导。它告诉我们，对于给定的观测噪声水平 $R$ 和[非线性](@entry_id:637147)函数 $h(x)$，如果先验不确定性 $P_0$ 超过了某个阈值 $P_0^\star$，那么 EKF 的线性化假设就可能不再成立，其性能可能会严重下降。反之，如果系统的[非线性](@entry_id:637147)很强（即 $|h''(m_0)|$ 很大），则要求先验[方差](@entry_id:200758)非常小才能保证 EKF 的有效性。

### EKF 的病态失效模式

在某些情况下，线性化近似不仅会引入误差，还会导致滤波器完全失效。这些“病态”失效模式通常发生在[非线性](@entry_id:637147)函数的特定区域，或者源于模型本身的结构性问题。

#### 在低敏感度点线性化与非高斯后验

当先验均值（即线性化点）恰好落在[非线性](@entry_id:637147)函数的一个平坦区域（即梯度接近于零的区域）时，EKF 会遇到一个严重的问题。在这种情况下，[雅可比矩阵](@entry_id:264467) $H_k$ 的元素会非常小甚至为零。

考虑一个在能量或强度测量逆问题中常见的场景，其观测模型为 $y = x^2 + v$。假设[先验分布](@entry_id:141376)是以零为中心的，即 $x \sim \mathcal{N}(0, \sigma^2)$。EKF 将围绕先验均值 $\mu^-=0$ 进行线性化。此时的观测[雅可比矩阵](@entry_id:264467)为：
$$
H = \frac{\partial (x^2)}{\partial x}\bigg|_{x=0} = 2x \bigg|_{x=0} = 0
$$
由于[雅可比矩阵](@entry_id:264467)为零，计算出的[卡尔曼增益](@entry_id:145800) $K = P^- H^T (H P^- H^T + r)^{-1}$ 也将为零。这意味着无论观测值 $y_0$ 是多少，状态估计和协[方差](@entry_id:200758)都不会有任何更新：$\hat{x}^+ = \hat{x}^-$ 且 $P^+ = P^-$。滤波器完全“无视”了[观测信息](@entry_id:165764)，因为它在线性化点局部“看不到”状态 $x$ 对观测值 $y$ 的任何影响。

然而，从[贝叶斯推理](@entry_id:165613)的角度来看，观测值 $y_0$ 提供了关于 $x$ 的重要信息。在零观测噪声的极限下（$r \to 0^+$），观测 $y=y_0$ 意味着 $x^2 = y_0$，即 $x$ 必然等于 $\sqrt{y_0}$ 或 $-\sqrt{y_0}$。真实的[后验分布](@entry_id:145605) $p(x|y_0)$ 会变成一个在 $\sqrt{y_0}$ 和 $-\sqrt{y_0}$ 两点处具有相等权重的[双峰分布](@entry_id:166376)。这个[后验分布](@entry_id:145605)显然是高度非高斯的，其[方差](@entry_id:200758)为 $y_0$。相比之下，EKF 的后验[方差](@entry_id:200758)仍然是其先验值 $\sigma^2$，与观测值 $y_0$ 完全无关 。这个例子戏剧性地展示了 EKF 的两个根本性失败：
1.  **信息丢失**：由于在零梯度点线性化，滤波器无法利用有价值的[观测信息](@entry_id:165764)。
2.  **[分布](@entry_id:182848)失配**：EKF 产生的单峰高斯后验完全无法表示真实的双峰[后验分布](@entry_id:145605)。

这种现象被称为**滤波器瘫痪（filter paralysis）**，它也发生在观测函数不可微的情况下，例如常见的[修正线性单元](@entry_id:636721)（ReLU）函数 $h(x) = \max(0, x)$。如果先验均值 $\hat{x}_k^-$ 小于零，那么 $h'(\hat{x}_k^-)=0$，导致雅可比矩阵为零，滤波器再次瘫痪，即使观测值明确表明真实状态是正的 。值得注意的是，即使使用迭代 EKF（IEKF），即在单个时间步内多次重新线性化和更新，也无法解决这个问题。因为第一次迭代的增益为零，估计值不会改变，后续的迭代将卡在同一点上，无法“逃离”这个零敏感度区域 。

#### 结构性缺陷：可观测性与[可辨识性](@entry_id:194150)

EKF 的另一个局限性源于模型本身的结构，这涉及到系统的**[可观测性](@entry_id:152062)**和参数的**可辨识性**。可观测性是指能否仅通过系统的输出（观测值）来唯一确定系统的内部状态。对于 EKF，我们关心的是其线性化版本的局部可观测性。

当需要同时估计[状态和](@entry_id:193625)未知参数时，通常会将参数增广到状态向量中。然而，这可能会导致线性化后的系统失去[可观测性](@entry_id:152062)。考虑一个简单的增长模型 $x_{k+1} = \exp(\theta) x_k$，其中增长率参数 $\theta$ 未知。观测模型为 $y_k = \alpha x_k$，其中测量增益 $\alpha$ 也未知。我们将状态向量增广为 $z_k = (x_k, \alpha, \theta)^T$。通过计算该增广系统在名义轨迹上的局部[可观测性矩阵](@entry_id:165052) $\mathcal{O}$，我们会发现该矩阵是[秩亏](@entry_id:754065)的 。具体来说，其秩为 2，而增广状态的维度为 3。这意味着存在一个一维的[不可观测子空间](@entry_id:176289)。EKF 无法区分状态 $x_k$ 的增加和测量增益 $\alpha$ 的相应减少，因为这两者的乘积 $\alpha x_k$（即观测值）保持不变。因此，滤波器无法独立地辨识出 $x_k$ 和 $\alpha$，只能估计它们的乘积。这是模型固有的结构性问题，线性化使其暴露无遗。

此外，EKF 对可观测性的判断本身也可能具有误导性，因为它只依赖于[一阶导数](@entry_id:749425)。一个[非线性系统](@entry_id:168347)可能在某个点的一阶导数（雅可比矩阵）为零，使得 EKF 认为系统在该点局部不可观测。然而，更高阶的导数可能包含关于状态的非零信息。一个更严谨的[非线性可观测性](@entry_id:167271)分析工具是**[李导数](@entry_id:171745)（Lie derivatives）**。考虑系统 $\dot{x}_1 = x_2, \dot{x}_2 = 0$ 和观测 $y = x_1^2$。在状态点 $x^*=(0, c)^T$（其中 $c>0$），观测雅可比矩阵 $H = (\partial h/\partial x)|_{x^*} = (2x_1, 0)|_{(0,c)} = (0, 0)$。EKF 据此会得出系统局部不可观测的结论。然而，通过计算观测值 $y$ 沿着动力学向量场 $f$ 的李导数，我们会发现[高阶导数](@entry_id:140882)在 $x^*$ 点不为零，这表明系统实际上是局部可观测的 。EKF 无法利用这种由系统动力学揭示的更高阶信息，从而错误地判断了信息内容。

### 超越欧几里得空间：约束的挑战

标准的卡尔曼滤波器及其扩展版本都隐式地假设状态生活在一个无约束的[欧几里得空间](@entry_id:138052) $\mathbb{R}^n$ 中。然而，许多实际问题中的状态天然地受到约束，例如，它们可能存在于一个[非线性](@entry_id:637147)[流形](@entry_id:153038)上。常见的例子包括：
-   [单位四元数](@entry_id:204470)，用于表示三维空间中的姿态，必须满足单位范数约束。
-   [旋转矩阵](@entry_id:140302)，必须是正交的且[行列式](@entry_id:142978)为 1。
-   协方差矩阵，必须是[对称正定](@entry_id:145886)的。

当天真地将 EKF 应用于这些约束状态时，会产生一个根本性的问题：更新步骤会使[状态估计](@entry_id:169668)偏离其所在的[流形](@entry_id:153038)。EKF 的更新公式是 $\hat{x}^+ = \hat{x}^- + K \nu$，这是一个在环境[欧几里得空间](@entry_id:138052)中的线性加法。由于[卡尔曼增益](@entry_id:145800)向量 $K\nu$ 通常不与[流形](@entry_id:153038)在 $\hat{x}^-$ 点的[切空间](@entry_id:199137)正交，这个加法操作会把状态“推离”[流形](@entry_id:153038)。

考虑一个状态被约束在二维[单位圆](@entry_id:267290) $\mathbb{S}^1$ 上的例子。假设先验均值 $\hat{x}^- = (1, 0)^T$ 位于圆上，先验协[方差](@entry_id:200758)为各向同性的 $P^- = \sigma^2 I_2$。观测值是状态的角度。通过 EKF 的标准更新步骤，我们可以计算出[后验均值](@entry_id:173826) $\hat{x}^+$。由于更新量沿 $x_2$ 轴方向（这是[流形](@entry_id:153038)在 $(1,0)^T$ 点的[切线](@entry_id:268870)方向），[后验均值](@entry_id:173826)将变为 $\hat{x}^+ = (1, \delta)^T$ 的形式，其中 $\delta \neq 0$。显然，这个点的范数 $\| \hat{x}^+ \| = \sqrt{1+\delta^2} > 1$，它已经不在单位圆上了。我们可以进一步计算出[后验均值](@entry_id:173826)范数平方的[期望值](@entry_id:153208)：
$$
\mathbb{E}[\|\hat{x}^+\|^2] = 1 + \frac{r \sigma^4}{(\sigma^2 + r)^2}
$$
 由于所有项都为正，这个值严格大于 1。这从数学上证实了，平均而言，EKF 的更新会系统性地违反状态约束。虽然可以通过在每次更新后将结果强行投影回[流形](@entry_id:153038)来缓解这个问题，但这种做法是次优的，并且会破坏滤波器的[统计一致性](@entry_id:162814)。这一局限性激发了专门为[流形](@entry_id:153038)约束状态设计的更先进的滤波方法，如不变[扩展卡尔曼滤波器](@entry_id:199333)（Invariant EKF）和[流形](@entry_id:153038)上的[粒子滤波器](@entry_id:181468)，我们将在后续章节中探讨这些方法。