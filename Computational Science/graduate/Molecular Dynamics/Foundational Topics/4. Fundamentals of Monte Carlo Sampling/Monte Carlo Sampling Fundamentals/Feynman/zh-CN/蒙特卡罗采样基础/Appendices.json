{
    "hands_on_practices": [
        {
            "introduction": "各态历经性是马尔可夫链蒙特卡洛（MCMC）方法的基石，它确保采样器能够遍历所有重要的状态。本练习将通过一个简单直观的模型，演示一个朴素的采样器为何会失效（即非各态历经），以及如何通过设计一个“集体移动”来修正这个问题。这项实践将抽象的理论与具体的算法设计选择联系起来，突出各态历经性在实际模拟中的核心重要性 。",
            "id": "3427345",
            "problem": "考虑一个旨在阐明马尔可夫链蒙特卡洛（MCMC）采样在分子动力学中核心特性的双粒子一维系统。设构型空间为 $\\Omega \\subset \\mathbb{R}^2$，粒子位置为 $(x_1,x_2)$。定义两个势阱和一个硬壁势能函数 $U:\\Omega \\rightarrow \\{0,+\\infty\\}$ 如下。容许势阱为\n$$\n\\mathcal{A} = \\{(x_1,x_2) \\in \\mathbb{R}^2 \\mid -1 \\le x_1 \\le 0,\\,-1 \\le x_2 \\le 0,\\, x_1 \\le x_2\\}\n$$\n和\n$$\n\\mathcal{B} = \\{(x_1,x_2) \\in \\mathbb{R}^2 \\mid 1 \\le x_1 \\le 2,\\,1 \\le x_2 \\le 2,\\, x_1 \\le x_2\\}.\n$$\n若 $(x_1,x_2) \\in \\mathcal{A} \\cup \\mathcal{B}$，则设势能为 $U(x_1,x_2) = 0$，否则 $U(x_1,x_2) = +\\infty$。在逆温度 $\\beta$ 下，Metropolis接受准则应用于提议 $(x_1,x_2) \\mapsto (x_1',x_2')$：以概率 $\\min\\{1, \\exp(-\\beta[U(x_1',x_2') - U(x_1,x_2)])\\}$ 接受。\n\n考虑两种提议移动集：\n\n- 单粒子位移移动：每一步，从 $\\{1,2\\}$ 中均匀选择一个 $i$，并提议 $x_i' = x_i + \\delta$，其中 $\\delta$ 从 $[-d,d]$ 中均匀抽取，同时保持另一坐标不变。如果由于硬壁约束导致 $(x_1',x_2') \\notin \\mathcal{A} \\cup \\mathcal{B}$，则该提议被拒绝。\n\n- 集体平移移动：每一步，以概率 $p_c$ 选择一个集体移动，提议 $(x_1',x_2') = (x_1 + s, x_2 + s)$，其中 $s \\in \\{+2,-2\\}$ 是均匀选择的；以概率 $1 - p_c$ 选择如上所述的单粒子位移移动。\n\n任务：\n\n1. 仅使用MCMC的第一性原理和上述定义，证明仅使用单粒子位移移动时，由 $U$ 约束的 $\\Omega$ 上的马尔可夫链是非遍历的。具体来说，证明任何仅由单粒子位移组成的容许路径都无法从势阱 $\\mathcal{A}$ 跃迁到势阱 $\\mathcal{B}$。\n\n2. 在存在硬壁势能的情况下，确定一种恢复遍历性所必需的集体移动形式，并证明其保持了细致平衡。然后，在宏观态 $\\{\\mathcal{A}, \\mathcal{B}\\}$ 的层面上，对于对称选择 $s \\in \\{+2,-2\\}$ 下产生的两态马尔可夫链，根据 $p_c$ 和总变差阈值 $\\varepsilon$ 推导出混合时间 $t_{\\mathrm{mix}}(\\varepsilon)$。\n\n3. 实现一个执行两项计算的程序：\n   - 使用步长 $h = 0.5$ 构建一个离散化状态图，方法是枚举 $\\mathcal{A}$ 和 $\\mathcal{B}$ 中的容许格点，如果两个状态仅在一个坐标上相差大小为 $h$ 的单粒子位移且保持容许，则用边连接它们。返回一个布尔值以指示非遍历性，此处非遍历性定义为在这些单粒子移动下，图具有多个连通分量。该布尔值必须通过此离散化上的图连通性计算得出，不得硬编码。\n   - 对于集体移动概率 $p_c$ 的四个指定值 $\\{1.0, 0.2, 0.02, 0.0\\}$ 和一个固定的总变差阈值 $\\varepsilon = 10^{-3}$，计算由集体移动引起的宏观两态链 $\\{\\mathcal{A},\\mathcal{B}\\}$ 的混合时间 $t_{\\mathrm{mix}}(\\varepsilon)$。将 $t_{\\mathrm{mix}}(\\varepsilon)$ 表示为整数步数，使用你的解析表达式的向上取整值，除非它是无穷大（对于 $p_c = 0.0$）。在宏观跃迁概率等于 $0.5$ 的特殊情况下，取 $t_{\\mathrm{mix}}(\\varepsilon)$ 为 $1$。\n\n你的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，结果的精确顺序为\n$$\n[\\text{non\\_ergodic\\_boolean},\\, t_{\\mathrm{mix}}(p_c=1.0),\\, t_{\\mathrm{mix}}(p_c=0.2),\\, t_{\\mathrm{mix}}(p_c=0.02),\\, t_{\\mathrm{mix}}(p_c=0.0)]。\n$$\n第一个条目是布尔值，其余条目是整数，除了最后一个在适用时为浮点数 $+\\infty$。不涉及物理单位；所有时间都是无量纲的步数计数。不出现角度。不得使用百分比；概率应视为 $[0,1]$ 内的实数。\n\n覆盖性测试套件：\n- 使用 $h=0.5$ 构建图，以检测单粒子移动下的非遍历性。\n- 在阈值 $\\varepsilon=10^{-3}$ 下，使用集体移动概率 $p_c \\in \\{1.0, 0.2, 0.02, 0.0\\}$ 来探测快速混合、中等混合、慢速混合以及势阱间无混合的边界情况。",
            "solution": "该问题被评估为有效。这是一个统计力学中适定且有科学依据的问题，用于测试马尔可夫链蒙特卡洛（MCMC）采样的基本概念，特别是遍历性、细致平衡和混合时间。所有定义和参数都足以进行严格求解。\n\n### 第1部分：单粒子位移移动的非遍历性\n\n如果一个MCMC采样器能够从构型空间中的任何状态在有限步数内跃迁到任何其他状态，那么它就是遍历的。具有有限势能的构型空间是两个不相交势阱 $\\mathcal{A}$ 和 $\\mathcal{B}$ 的并集。\n$$\n\\mathcal{A} = \\{(x_1,x_2) \\in \\mathbb{R}^2 \\mid -1 \\le x_1 \\le 0,\\,-1 \\le x_2 \\le 0,\\, x_1 \\le x_2\\}\n$$\n$$\n\\mathcal{B} = \\{(x_1,x_2) \\in \\mathbb{R}^2 \\mid 1 \\le x_1 \\le 2,\\,1 \\le x_2 \\le 2,\\, x_1 \\le x_2\\}\n$$\n对于 $(x_1,x_2) \\in \\mathcal{A} \\cup \\mathcal{B}$，势能 $U(x_1,x_2)$ 为 $0$，否则为 $+\\infty$。\n\n设系统的初始状态为 $(x_1, x_2) \\in \\mathcal{A}$。根据 $\\mathcal{A}$ 的定义，这意味着 $-1 \\le x_1 \\le 0$ 和 $-1 \\le x_2 \\le 0$。我们考虑一个单粒子位移移动，它提议一个新状态 $(x_1', x_2')$。从状态 $x$ 到 $x'$ 跃迁的Metropolis接受概率为 $\\min\\{1, \\exp(-\\beta[U(x') - U(x)])\\}$。由于在 $\\mathcal{A}$ 内 $U(x)=0$，任何被接受的移动所达到的新状态 $x'$ 必须满足 $U(x')=0$，即 $x' \\in \\mathcal{A} \\cup \\mathcal{B}$。\n\n对于从 $(x_1, x_2) \\in \\mathcal{A}$ 出发的单粒子移动，有两种情况：\n\n1.  **移动粒子 $1$**：提议的新状态为 $(x_1', x_2') = (x_1 + \\delta, x_2)$，其中 $\\delta$ 是一个随机位移。坐标 $x_2$ 保持不变，因此 $x_2' = x_2 \\in [-1, 0]$。势阱 $\\mathcal{B}$ 中的一个状态 $(y_1, y_2)$ 必须满足 $1 \\le y_2 \\le 2$。由于 $x_2' \\notin [1, 2]$，提议的状态 $(x_1', x_2')$ 不可能在 $\\mathcal{B}$ 中。因此，为了使移动被接受（即势能保持有限），新状态必须位于 $\\mathcal{A}$ 中。\n\n2.  **移动粒子 $2$**：提议的新状态为 $(x_1', x_2') = (x_1, x_2 + \\delta)$。坐标 $x_1$ 保持不变，因此 $x_1' = x_1 \\in [-1, 0]$。势阱 $\\mathcal{B}$ 中的一个状态 $(y_1, y_2)$ 必须满足 $1 \\le y_1 \\le 2$。由于 $x_1' \\notin [1, 2]$，提议的状态 $(x_1', x_2')$ 不可能在 $\\mathcal{B}$ 中。因此，为了使移动被接受，新状态必须位于 $\\mathcal{A}$ 中。\n\n在这两种情况下，任何从 $\\mathcal{A}$ 中状态出发并被接受的单粒子移动，其结果状态也位于 $\\mathcal{A}$ 中。仅使用单粒子位移不可能从 $\\mathcal{A}$ 中的状态生成 $\\mathcal{B}$ 中的状态。类似的论证表明，也无法从 $\\mathcal{B}$ 跃迁到 $\\mathcal{A}$。状态空间被分割成两个不连通的区域。因此，该马尔可夫链是非遍历的。\n\n### 第2部分：恢复遍历性与混合时间的推导\n\n问题提议了一种集体平移移动来恢复遍历性：$(x_1', x_2') = (x_1 + s, x_2 + s)$，其中 $s$ 从 $\\{+2, -2\\}$ 中均匀选择。\n\n**恢复遍历性**：\n- 如果 $(x_1, x_2) \\in \\mathcal{A}$，则 $-1 \\le x_1, x_2 \\le 0$ 且 $x_1 \\le x_2$。应用 $s = +2$ 的平移得到 $(x_1', x_2') = (x_1+2, x_2+2)$。新坐标满足 $1 \\le x_1', x_2' \\le 2$。顺序得以保持：$x_1 \\le x_2 \\implies x_1+2 \\le x_2+2 \\implies x_1' \\le x_2'$。因此，新状态 $(x_1', x_2')$ 保证在 $\\mathcal{B}$ 中。\n- 如果 $(x_1, x_2) \\in \\mathcal{B}$，则 $1 \\le x_1, x_2 \\le 2$ 且 $x_1 \\le x_2$。应用 $s = -2$ 的平移得到 $(x_1', x_2') = (x_1-2, x_2-2)$。新坐标满足 $-1 \\le x_1', x_2' \\le 0$ 且 $x_1' \\le x_2'$。因此，新状态 $(x_1', x_2')$ 保证在 $\\mathcal{A}$ 中。\n此移动成功地连接了两个势阱。当与单粒子移动（确保每个势阱内的遍历性）结合时，整个马尔可夫链变得遍历。\n\n**细致平衡**：\n该系统的稳态分布 $\\pi(x)$ 在容许区域 $\\mathcal{A} \\cup \\mathcal{B}$ 上是均匀的，因为势能 $U(x)$ 在那里是常数（零）。细致平衡要求 $\\pi(x)P(x \\to x') = \\pi(x')P(x' \\to x)$，其中 $P(x \\to x') = T(x \\to x')A(x \\to x')$ 是跃迁概率，由提议概率 $T$ 和接受概率 $A$ 组成。\n对于 $x \\in \\mathcal{A}$ 和 $x' \\in \\mathcal{B}$ 之间的集体移动，由于分布是均匀的，我们有 $\\pi(x) = \\pi(x')$。势能为 $U(x) = U(x') = 0$，因此接受概率为 $A(x \\to x') = \\min\\{1, \\exp(-0)\\} = 1$。从 $x$ 到 $x' = x+(s,s)$ 以及从 $x'$ 到 $x = x'-(s,s)$ 的提议是对称的，因为 $s$ 是从 $\\{+2, -2\\}$ 中均匀选择的。因此，$T(x \\to x') = T(x' \\to x)$。在 $\\pi(x)=\\pi(x')$，$T(x \\to x')=T(x' \\to x)$ 和 $A(x \\to x')=A(x' \\to x)=1$ 的条件下，细致平衡条件得到满足。\n\n**宏观态链的混合时间**：\n我们分析宏观态 $\\{\\mathcal{A}, \\mathcal{B}\\}$ 上的两态马尔可夫链。$\\mathcal{A}$ 的面积是 $\\frac{1}{2}(1 \\times 1) = 1/2$，$\\mathcal{B}$ 的面积也是 $\\frac{1}{2}(1 \\times 1) = 1/2$。因此，稳态概率相等：$\\pi(\\mathcal{A}) = \\pi(\\mathcal{B}) = 1/2$。\n宏观态之间的跃迁仅通过集体移动发生。\n- 在一步之内从 $\\mathcal{A}$ 跃迁到 $\\mathcal{B}$ 的概率为 $P(\\mathcal{A} \\to \\mathcal{B}) = P(\\text{选择集体移动}) \\times P(\\text{选择 } s=+2) = p_c \\times (1/2) = p_c/2$。\n- 从 $\\mathcal{B}$ 跃迁到 $\\mathcal{A}$ 的概率为 $P(\\mathcal{B} \\to \\mathcal{A}) = p_c \\times (1/2) = p_c/2$。\n设 $\\alpha = p_c/2$。宏观态 $(\\mathcal{A}, \\mathcal{B})$ 的跃迁矩阵为：\n$$\nM = \\begin{pmatrix} 1-\\alpha & \\alpha \\\\ \\alpha & 1-\\alpha \\end{pmatrix}\n$$\n特征值为 $\\lambda_1 = 1$ 和 $\\lambda_2 = 1 - 2\\alpha = 1 - p_c$。向稳态分布收敛的速率由第二大特征值模 $|\\lambda_2| = |1 - p_c|$ 决定。对于 $p_c \\in [0, 1]$，此值为 $1-p_c$。\n从纯态（最坏情况）出发，经过 $t$ 步后，与稳态分布 $\\pi_{macro} = [1/2, 1/2]^T$ 的总变差距离 $d_{TV}$ 为 $d_{TV}(t) = \\frac{1}{2}|\\lambda_2|^t = \\frac{1}{2}(1-p_c)^t$。\n我们求解混合时间 $t_{\\mathrm{mix}}(\\varepsilon)$，即满足 $d_{TV}(t) \\le \\varepsilon$ 的最小整数 $t$。\n$$\n\\frac{1}{2}(1-p_c)^t \\le \\varepsilon \\implies (1-p_c)^t \\le 2\\varepsilon\n$$\n取自然对数：\n$$\nt \\ln(1-p_c) \\le \\ln(2\\varepsilon)\n$$\n对于 $p_c \\in (0, 1)$，$\\ln(1-p_c)$ 是负数，所以我们反转不等号：\n$$\nt \\ge \\frac{\\ln(2\\varepsilon)}{\\ln(1-p_c)}\n$$\n混合时间是该值的向上取整：\n$$\nt_{\\mathrm{mix}}(\\varepsilon) = \\left\\lceil \\frac{\\ln(2\\varepsilon)}{\\ln(1-p_c)} \\right\\rceil\n$$\n特殊情况：\n- 如果 $p_c=0$，分母为 $\\ln(1)=0$，因此 $t_{\\mathrm{mix}} = \\infty$。\n- 如果 $p_c=1$，宏观跃迁概率 $\\alpha = 1/2$。根据题目要求，$t_{\\mathrm{mix}}=1$。这与 $\\lambda_2=0$ 的事实一致，表明立即收敛。\n\n### 第3部分：实现计划\n\n1.  **非遍历性测试**：\n    - 用步长 $h=0.5$ 将状态空间离散化。势阱 $\\mathcal{A}$ 的有效坐标为 $\\{-1.0, -0.5, 0.0\\}$，势阱 $\\mathcal{B}$ 的有效坐标为 $\\{1.0, 1.5, 2.0\\}$。\n    - 枚举 $\\mathcal{A} \\cup \\mathcal{B}$ 中所有满足约束（例如，$x_1 \\le x_2$）的状态 $(x_1, x_2)$。这导致 $\\mathcal{A}$ 中有 $6$ 个状态，$\\mathcal{B}$ 中有 $6$ 个状态，总共 $12$ 个状态。\n    - 构建一个图，其中状态是节点。如果两个节点之间可以通过大小为 $h=0.5$ 的单粒子位移从一个到达另一个，则它们之间存在一条边。\n    - 执行图遍历（例如，广度优先搜索或深度优先搜索）来计算连通分量的数量。如果数量大于 $1$，则系统在该离散化上是非遍历的，布尔值为 `True`。\n\n2.  **混合时间计算**：\n    - 使用推导出的公式 $t_{\\mathrm{mix}}(\\varepsilon) = \\lceil \\frac{\\ln(2\\varepsilon)}{\\ln(1-p_c)} \\rceil$，其中 $\\varepsilon = 10^{-3}$。\n    - 对于 $p_c = 1.0$，使用特殊情况规则 $t_{\\mathrm{mix}}=1$。\n    - 对于 $p_c \\in \\{0.2, 0.02\\}$，计算该公式。当 $2\\varepsilon = 0.002$ 时：\n      - $p_c=0.2$: $t = \\ln(0.002)/\\ln(0.8) \\approx 27.85 \\implies \\lceil 27.85 \\rceil = 28$。\n      - $p_c=0.02$: $t = \\ln(0.002)/\\ln(0.98) \\approx 307.65 \\implies \\lceil 307.65 \\rceil = 308$。\n    - 对于 $p_c=0.0$，混合时间为无穷大。\n    - 将收集结果并按指定格式进行格式化。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the two-part problem:\n    1. Determines ergodicity of a discretized system via graph connectivity.\n    2. Calculates MCMC mixing times for a macrostate model.\n    \"\"\"\n\n    # --- Task 1: Check for non-ergodicity on a discretized grid ---\n\n    # Define the step size and coordinate grids for the two basins.\n    h = 0.5\n    coords_A = [-1.0, -0.5, 0.0]\n    coords_B = [1.0, 1.5, 2.0]\n\n    # Enumerate all valid states in basin A satisfying x1 = x2.\n    states_A = []\n    for x1 in coords_A:\n        for x2 in coords_A:\n            if x1 = x2:\n                states_A.append((x1, x2))\n    \n    # Enumerate all valid states in basin B satisfying x1 = x2.\n    states_B = []\n    for x1 in coords_B:\n        for x2 in coords_B:\n            if x1 = x2:\n                states_B.append((x1, x2))\n                \n    # Combine states from both basins and create a mapping for efficient lookup.\n    all_states = states_A + states_B\n    num_states = len(all_states)\n    state_to_idx = {state: i for i, state in enumerate(all_states)}\n\n    # Build an adjacency list for the graph.\n    adj = [[] for _ in range(num_states)]\n    for i, state in enumerate(all_states):\n        x1, x2 = state\n        # Define the four possible single-particle moves of magnitude h.\n        potential_moves = [(h, 0), (-h, 0), (0, h), (0, -h)]\n        for dx, dy in potential_moves:\n            # Calculate the neighbor coordinate.\n            # a direct key lookup will work as coordinates are exact multiples of h=0.5\n            neighbor_coord = (x1 + dx, x2 + dy)\n            if neighbor_coord in state_to_idx:\n                neighbor_idx = state_to_idx[neighbor_coord]\n                adj[i].append(neighbor_idx)\n\n    # Count connected components using Breadth-First Search (BFS) to determine ergodicity.\n    # Non-ergodicity is defined as having more than one connected component.\n    visited = [False] * num_states\n    num_components = 0\n    for i in range(num_states):\n        if not visited[i]:\n            num_components += 1\n            q = [i]\n            visited[i] = True\n            head = 0\n            while head  len(q):\n                u = q[head]\n                head += 1\n                for v in adj[u]:\n                    if not visited[v]:\n                        visited[v] = True\n                        q.append(v)\n    \n    non_ergodic_boolean = (num_components > 1)\n\n    # --- Task 2: Calculate mixing times for the two-state macrochain ---\n\n    pc_values = [1.0, 0.2, 0.02, 0.0]\n    epsilon = 1e-3\n    mixing_times = []\n\n    for pc in pc_values:\n        # The macrostate transition probability p(A->B) is alpha = pc/2.\n        # The problem defines a special case when this probability is 0.5.\n        if pc == 1.0: # Corresponds to macro transition prob = 0.5\n            mixing_times.append(1)\n        elif pc == 0.0: # No collective moves, so basins are disconnected.\n            mixing_times.append(float('inf'))\n        else:\n            # For 0  pc  1, use the derived analytical formula:\n            # t_mix = ceil(ln(2*eps) / ln(1-pc))\n            t_mix_float = np.log(2 * epsilon) / np.log(1 - pc)\n            mixing_times.append(int(np.ceil(t_mix_float)))\n\n    # --- Assemble and print the final output in the required format ---\n    \n    # Combine the boolean result with the list of mixing times.\n    # The boolean is formatted to lowercase as per common data standards.\n    results = [str(non_ergodic_boolean).lower()] + mixing_times\n    \n    # The final print statement must produce a single line in the specified format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "在确保了各态历经性之后，正确实现细致平衡条件对于采样的准确性至关重要。本练习将从简单的坐标空间转向分子模拟中常见的旋转自由度问题 。您将推导当提议分布相对于不变测度不对称时所必需的哈斯廷斯校正因子，这是高级蒙特卡洛方法中一个微妙但关键的细节。",
            "id": "3427343",
            "problem": "在一个刚性非对称分子在外场中的旋转自由度的蒙特卡洛采样中，其朝向的构型空间是特殊正交群 $\\mathrm{SO}(3)$，由 ZYZ 欧拉角 $(\\phi,\\theta,\\psi)$ 参数化，其取值范围为 $\\phi \\in [0,2\\pi)$，$\\theta \\in [0,\\pi]$，以及 $\\psi \\in [0,2\\pi)$。在 $\\mathrm{SO}(3)$ 上的不变体积元，即哈尔测度，在这些坐标下的局部形式为 $d\\mu(\\phi,\\theta,\\psi) = \\sin\\theta\\, d\\phi\\, d\\theta\\, d\\psi$。朝向上的物理目标分布相对于哈尔测度的密度由 $\\pi(R) \\propto \\exp(-\\beta U(R))$ 给出，其中 $R \\in \\mathrm{SO}(3)$ 表示朝向，$U(R)$ 是势能；$\\beta$ 是逆温度，定义为 $\\beta = 1/(k_{B}T)$，其中 $k_{B}$ 是玻尔兹曼常数，$T$ 是绝对温度。\n\n通过一个独立提议来构造 Metropolis-Hastings (MH) 更新，该提议在角度坐标中提议一个新的朝向，从乘积测度中抽取 $(\\phi',\\theta',\\psi')$，其中 $\\phi'$ 和 $\\psi'$ 在 $[0,2\\pi)$ 上均匀分布，$\\theta'$ 在 $[0,\\pi]$ 上均匀分布，且与当前的 $(\\phi,\\theta,\\psi)$ 无关。这个提议相对于 $\\mathrm{SO}(3)$ 上的哈尔测度是非均匀的，因为它在欧拉角上是均匀的，而不是在不变测度上是均匀的。\n\n从 $\\mathrm{SO}(3)$ 上细致平衡的定义出发，并利用变量替换和在坐标映射 $(\\phi,\\theta,\\psi) \\mapsto R(\\phi,\\theta,\\psi)$ 下密度的绝对连续性，推导在角度坐标中将目标密度表示为关于勒贝格测度时，完全由角度测度的雅可比行列式 $\\sin\\theta$ 产生的 Hastings 修正因子。以一个仅依赖于当前极角 $\\theta$ 和提议的极角 $\\theta'$ 的闭式表达式给出最终的 Hastings 因子。不要包含能量、温度或提议密度项；仅分离出用于修正雅可比行列式的因子。最终答案必须是单一的解析表达式。",
            "solution": "该问题要求推导在一个刚性分子的朝向空间 $\\mathrm{SO}(3)$ 上进行 Metropolis-Hastings (MH) 蒙特卡洛更新的 Hastings 修正因子。该修正的出现是因为提议机制在 ZYZ 欧拉角坐标 $(\\phi, \\theta, \\psi)$ 中是均匀的，而群 $\\mathrm{SO}(3)$ 上的不变测度并非如此。\n\nMetropolis-Hastings 算法的核心是细致平衡条件，它确保了所期望的目标概率分布 $\\pi$ 是生成的马尔可夫链的平稳分布。对于任意两个状态 $x$ 和 $x'$，细致平衡要求：\n$$\n\\pi(x) q(x'|x) A(x'|x) = \\pi(x') q(x|x') A(x|x')\n$$\n其中 $q(x'|x)$ 是从状态 $x$ 提议移动到 $x'$ 的密度，$A(x'|x)$ 是接受该移动的概率。接受概率的标准解是：\n$$\nA(x'|x) = \\min\\left(1, \\frac{\\pi(x') q(x|x')}{\\pi(x) q(x'|x)}\\right)\n$$\n项 $\\frac{q(x|x')}{q(x'|x)}$ 被称为 Hastings 修正因子。此形式体系的一个关键要求是，所有概率密度 $\\pi$ 和 $q$ 都必须是相对于同一个基础参考测度来表示的。\n\n令系统的状态为一个朝向 $R \\in \\mathrm{SO}(3)$。这个空间上参考测度的自然且最优雅的选择是不变哈尔测度 $d\\mu(R)$。用 ZYZ 欧拉角 $(\\phi, \\theta, \\psi)$ 表示，该测度的局部表达式为 $d\\mu(R) = \\sin\\theta \\, d\\phi \\, d\\theta \\, d\\psi$。\n\n首先，我们定义相对于此哈尔测度的目标密度。问题指出，物理目标分布相对于哈尔测度的密度 $\\pi(R)$ 由 $\\pi(R) \\propto \\exp(-\\beta U(R))$ 给出。我们可以将其写为 $\\pi(R) = C_{\\pi} \\exp(-\\beta U(R))$，其中 $C_{\\pi}$ 是归一化常数。\n\n接下来，我们必须确定相对于同一个哈尔测度 $d\\mu$ 的提议密度 $q(R'|R)$。问题描述了一个独立提议，其中新的欧拉角 $(\\phi', \\theta', \\psi')$ 是独立于当前状态抽取的。角 $\\phi'$ 和 $\\psi'$ 从 $[0, 2\\pi)$ 中均匀抽取，角 $\\theta'$ 从 $[0, \\pi]$ 中均匀抽取。此提议的概率密度，相对于坐标空间上的勒贝格测度 $d\\lambda = d\\phi' d\\theta' d\\psi'$，是：\n$$\ng_{\\lambda}(\\phi', \\theta', \\psi') = \\frac{1}{2\\pi} \\cdot \\frac{1}{\\pi} \\cdot \\frac{1}{2\\pi} = \\frac{1}{4\\pi^2}\n$$\n这是坐标空间中的提议密度。为了找到相对于哈尔测度 $d\\mu(R')$ 的提议密度 $q_{\\mu}(R'|R)$，我们使用概率守恒原理。在一个无穷小体积中提议一个状态的概率必须与用于描述该体积的坐标系无关。\n$$\nq_{\\mu}(R'|R) \\, d\\mu(R') = g_{\\lambda}(\\phi', \\theta', \\psi') \\, d\\lambda\n$$\n我们知道两个体积元之间的关系是 $d\\mu(R') = \\sin\\theta' \\, d\\lambda$。将 $d\\lambda = d\\mu(R') / \\sin\\theta'$ 代入方程得到：\n$$\nq_{\\mu}(R'|R) \\, d\\mu(R') = g_{\\lambda}(\\phi', \\theta', \\psi') \\, \\frac{d\\mu(R')}{\\sin\\theta'}\n$$\n因此，相对于哈尔测度的提议密度是：\n$$\nq_{\\mu}(R'|R) = \\frac{g_{\\lambda}(\\phi', \\theta', \\psi')}{\\sin\\theta'} = \\frac{1}{4\\pi^2 \\sin\\theta'}\n$$\n这是一个独立采样器，所以提议密度只依赖于提议的状态 $R'$（对应于角度 $(\\phi', \\theta', \\psi')$），而不依赖于当前状态 $R$。因此，$q_{\\mu}(R'|R) = q_{\\mu}(R')$。从 $R'$ 到 $R$ 的逆向提议密度，可以通过将带撇的变量替换为不带撇的变量来找到：\n$$\nq_{\\mu}(R|R') = \\frac{1}{4\\pi^2 \\sin\\theta}\n$$\n现在我们可以计算 Hastings 修正因子，即逆向提议密度与正向提议密度的比值：\n$$\n\\frac{q_{\\mu}(R|R')}{q_{\\mu}(R'|R)} = \\frac{\\frac{1}{4\\pi^2 \\sin\\theta}}{\\frac{1}{4\\pi^2 \\sin\\theta'}} = \\frac{4\\pi^2 \\sin\\theta'}{4\\pi^2 \\sin\\theta} = \\frac{\\sin\\theta'}{\\sin\\theta}\n$$\n这个因子解释了这样一个事实：均匀地提议角度并不等同于在与极角相关的方向球面上均匀地提议朝向。具体来说，在 $\\theta$ 上的均匀提议更有可能在极点（$\\theta=0$ 或 $\\theta=\\pi$）附近生成朝向，而在这些地方不变体积元 $\\sin\\theta \\, d\\theta$ 很小。Hastings 因子正确地补偿了这种偏差。\n\n完整的接受率将是 $\\frac{\\pi(R')}{\\pi(R)} \\frac{q_{\\mu}(R|R')}{q_{\\mu}(R'|R)} = \\exp(-\\beta(U(R')-U(R))) \\frac{\\sin\\theta'}{\\sin\\theta}$。问题要求只分离出 Hastings 修正因子本身，它仅依赖于当前和提议的极角 $\\theta$ 和 $\\theta'$。",
            "answer": "$$\\boxed{\\frac{\\sin\\theta'}{\\sin\\theta}}$$"
        },
        {
            "introduction": "生成有效的马尔可夫链只是成功的一半，同样重要的是正确估计计算平均值的统计不确定性。与独立样本不同，来自马尔可夫链蒙特卡洛（MCMC）的数据存在时间相关性，这使得误差分析变得复杂。本练习将指导您设计一种块状自助法（block bootstrap）程序，这是一种稳健的非参数方法，用于从相关时间序列数据中估计置信区间 。",
            "id": "3427318",
            "problem": "考虑一个标量可观测量 $A$ 的时间序列 $\\{A_t\\}_{t=1}^N$，该序列由分子动力学（MD）或马尔可夫链蒙特卡洛（MCMC）生成的遍历马尔可夫链的单个长轨迹记录得到。目标是估计样本均值 $\\hat{A}_N = \\frac{1}{N}\\sum_{t=1}^N A_t$ 的置信区间 (CI)。该链是平稳的，其平衡均值为 $\\mathbb{E}[A] = \\mu$，自协方差函数为 $C(\\ell) = \\mathbb{E}\\big[(A_t-\\mu)(A_{t+\\ell}-\\mu)\\big]$，并具有归一化自相关函数 $\\rho(\\ell) = C(\\ell)/C(0)$，该函数在一个特征相关尺度上衰减。对于单位时间步长，积分自相关时间 (IAT) 定义为 $\\tau_{\\mathrm{int}} = \\frac{1}{2} + \\sum_{\\ell=1}^{\\infty} \\rho(\\ell)$。几何遍历马尔可夫链的中心极限定理指出，在温和条件下，$\\sqrt{N}\\big(\\hat{A}_N - \\mu\\big)$ 依分布收敛到一个正态随机变量，其方差膨胀由时间相关性决定。\n\n您正在寻找一种非参数重抽样方法，该方法尊重序列依赖性，以近似 $\\hat{A}_N$ 的抽样分布，并生成一个具有科学合理性的置信区间。以下哪个选项最正确地概述了针对相关马尔可夫链数据的块自举（block bootstrap）程序，并证明了所选块长度相对于 $\\tau_{\\mathrm{int}}$ 的合理性？\n\nA. 从时间序列中估计 $\\tau_{\\mathrm{int}}$，选择一个块长度 $L_b$，其量级为 $\\tau_{\\mathrm{int}}$ 的一个小数倍，例如 $L_b \\approx \\alpha\\,\\tau_{\\mathrm{int}}$，其中 $\\alpha$ 在 2 到 10 之间。从 $\\{A_t\\}_{t=1}^N$ 中构建长度为 $L_b$ 的重叠连续块（使用循环包裹以允许块从 $t=N$ 附近开始），有放回地抽取 $K=\\lceil N/L_b \\rceil$ 个块并将它们连接起来，形成一个长度至少为 $N$ 的自举序列，然后截断到恰好为 $N$。对 $B$ 个自举复制中的每一个计算 $\\hat{A}_N^{\\ast}$，并使用 $\\{\\hat{A}_N^{\\ast}\\}_{b=1}^B$ 的经验分位数来形成置信区间。理由：选择与几个 $\\tau_{\\mathrm{int}}$ 相当的 $L_b$ 可以保留大部分块内依赖性，同时允许有足够多的块，从而在自举分布的方差和偏差之间取得平衡。\n\nB. 因为马尔可夫链是遍历的，所以独立有放回地重抽样单个点 $A_t$ ($L_b=1$) 以形成 $B$ 个长度为 $N$ 的自举序列，对每个序列计算 $\\hat{A}_N^{\\ast}$，并使用它们的分位数来构建置信区间。理由：遍历性保证了长期来看的独立性，因此单点重抽样是足够的。\n\nC. 为了避免因破坏相关性而产生的偏差，将块长度设置为完整轨迹的长度，$L_b=N$，并在每次复制中重抽样一个完整的块。计算 $\\hat{A}_N^{\\ast}$ 并使用其经验分布来构建置信区间。理由：使用完整轨迹块可以完美地保留依赖性，从而产生最忠实的自举分布。\n\nD. 将序列划分为长度为 $L_b \\ll \\tau_{\\mathrm{int}}$ 的不重叠连续块，以最大化可用块的数量，有放回地对这些块进行抽样以形成自举序列，并计算 $\\hat{A}_N^{\\ast}$。理由：较短的块通过增加块的数量来减少自举估计量的方差，从而提高置信区间的紧密度。\n\nE. 使用平稳自举法，其块长度服从几何分布，平均块长 $L_b$ 设置得远低于 $\\tau_{\\mathrm{int}}$ 以避免过度平滑。生成 $B$ 个自举序列，计算 $\\hat{A}_N^{\\ast}$ 并从其经验分布中推导置信区间。理由：随机的短块可以防止自举序列中出现人为的远程相关性，从而产生可靠的置信区间。",
            "solution": "...",
            "answer": "$$\\boxed{A}$$"
        }
    ]
}