{
    "hands_on_practices": [
        {
            "introduction": "Calculating electrostatic interactions by considering every point charge in a molecule can be computationally prohibitive, especially at long ranges. The multipole expansion offers a powerful and systematic approximation that represents a complex charge distribution through a series of moments. This first practice invites you to derive the potential and electric field from the foundational dipole and quadrupole moments, providing a concrete sense of how their influence decays with distance and allowing you to estimate their relative contributions for a realistic scenario .",
            "id": "3413563",
            "problem": "A localized, neutral molecule in molecular dynamics simulations can be represented at long range by its lowest non-vanishing multipole moments. Consider a molecule whose total charge is zero and whose far-field electrostatics are represented by a point dipole $\\mathbf{p}$ and a traceless point quadrupole tensor $Q_{\\alpha\\beta}$. The molecule is embedded in vacuum, so the permittivity is the vacuum permittivity $\\epsilon_{0}$. \n\nStarting from the fundamental definition of the scalar potential of a localized charge distribution,\n$$\\Phi(\\mathbf{r}) = \\frac{1}{4\\pi \\epsilon_{0}} \\int \\frac{\\rho(\\mathbf{r}')}{|\\mathbf{r}-\\mathbf{r}'|} \\, d^{3}\\mathbf{r}',$$\nand from the definition of the electric field $\\mathbf{E}(\\mathbf{r})$ as the negative gradient of the potential,\n$$\\mathbf{E}(\\mathbf{r}) = - \\nabla \\Phi(\\mathbf{r}),$$\nderive the leading dipole and quadrupole contributions to the potential and field at a field point $\\mathbf{r}$ in the far-field regime where $|\\mathbf{r}|$ is much larger than the molecular size. Express the dipole and quadrupole contributions in terms of the dipole vector $\\mathbf{p}$ and the traceless quadrupole tensor $Q_{\\alpha\\beta}$, and use only vector calculus identities and multipole definitions as needed.\n\nThen, specialize to the case where $\\mathbf{p}$ and the principal axis of $Q_{\\alpha\\beta}$ are collinear along $\\hat{\\mathbf{z}}$, and the quadrupole tensor is diagonal with components $Q_{xx} = Q_{yy} = -Q/2$ and $Q_{zz} = Q$, with $Q > 0$ denoting the quadrupole magnitude. Evaluate the dimensionless ratio $R$ of the magnitude of the quadrupole contribution to the scalar potential to the magnitude of the dipole contribution to the scalar potential along the symmetry axis, i.e., at $\\mathbf{r} = r \\, \\hat{\\mathbf{z}}$. Use $|\\mathbf{p}| = 2$ Debye (D), $|Q| = 5$ Debye ångström (DÅ), and $r = 5$ nanometers (nm). You may use $1 \\text{ nm} = 10 \\text{ Å}$ for unit conversion. \n\nReport the single number $R$ without units. No rounding is required; if an exact rational form is available, provide it.",
            "solution": "The problem is validated as scientifically grounded, well-posed, and objective. It is a standard problem in classical electrostatics.\n\nThe derivation begins with the fundamental expression for the scalar potential $\\Phi(\\mathbf{r})$ from a localized charge distribution $\\rho(\\mathbf{r}')$:\n$$ \\Phi(\\mathbf{r}) = \\frac{1}{4\\pi \\epsilon_{0}} \\int \\frac{\\rho(\\mathbf{r}')}{|\\mathbf{r}-\\mathbf{r}'|} \\, d^{3}\\mathbf{r}' $$\nIn the far-field regime, where the field point $\\mathbf{r}$ is far from the source distribution (i.e., $|\\mathbf{r}| \\gg |\\mathbf{r}'|$ for all $\\mathbf{r}'$ where $\\rho(\\mathbf{r}') \\neq 0$), we can perform a Taylor series expansion of the term $1/|\\mathbf{r}-\\mathbf{r}'|$ in powers of $\\mathbf{r}'$ around $\\mathbf{r}' = \\mathbf{0}$. Treating $f(\\mathbf{R}) = 1/|\\mathbf{R}|$ and setting $\\mathbf{R} = \\mathbf{r}-\\mathbf{r}'$, the expansion is:\n$$ \\frac{1}{|\\mathbf{r}-\\mathbf{r}'|} = f(\\mathbf{r}-\\mathbf{r}') \\approx f(\\mathbf{r}) - \\sum_{\\alpha} r'_\\alpha \\frac{\\partial f(\\mathbf{r})}{\\partial r_\\alpha} + \\frac{1}{2} \\sum_{\\alpha, \\beta} r'_\\alpha r'_\\beta \\frac{\\partial^2 f(\\mathbf{r})}{\\partial r_\\alpha \\partial r_\\beta} + \\dots $$\nwhere the derivatives are with respect to the components of $\\mathbf{r}$. Substituting $f(\\mathbf{r}) = 1/r = (r_x^2 + r_y^2 + r_z^2)^{-1/2}$:\n$$ \\frac{\\partial}{\\partial r_\\alpha} \\left(\\frac{1}{r}\\right) = -\\frac{r_\\alpha}{r^3} $$\n$$ \\frac{\\partial^2}{\\partial r_\\alpha \\partial r_\\beta} \\left(\\frac{1}{r}\\right) = \\frac{3 r_\\alpha r_\\beta - r^2 \\delta_{\\alpha\\beta}}{r^5} $$\nThe expansion becomes:\n$$ \\frac{1}{|\\mathbf{r}-\\mathbf{r}'|} \\approx \\frac{1}{r} + \\frac{\\mathbf{r} \\cdot \\mathbf{r}'}{r^3} + \\frac{1}{2} \\sum_{\\alpha, \\beta} \\frac{3 r_\\alpha r_\\beta - r^2 \\delta_{\\alpha\\beta}}{r^5} r'_\\alpha r'_\\beta $$\nSubstituting this expansion into the potential integral gives the multipole expansion of the potential:\n$$ \\Phi(\\mathbf{r}) \\approx \\frac{1}{4\\pi \\epsilon_{0}} \\left[ \\frac{1}{r} \\int \\rho(\\mathbf{r}') d^3\\mathbf{r}' + \\frac{\\mathbf{r}}{r^3} \\cdot \\int \\mathbf{r}' \\rho(\\mathbf{r}') d^3\\mathbf{r}' + \\int \\left( \\frac{1}{2} \\sum_{\\alpha, \\beta} \\frac{3 r_\\alpha r_\\beta - r^2 \\delta_{\\alpha\\beta}}{r^5} r'_\\alpha r'_\\beta \\right) \\rho(\\mathbf{r}') d^3\\mathbf{r}' \\right] $$\nWe identify the terms corresponding to the monopole, dipole, and quadrupole moments.\n\nThe monopole term is proportional to the total charge $q = \\int \\rho(\\mathbf{r}') d^3\\mathbf{r}'$. As the molecule is neutral, $q=0$, and this term vanishes.\n\nThe dipole contribution to the potential is:\n$$ \\Phi_{\\text{dipole}}(\\mathbf{r}) = \\frac{1}{4\\pi \\epsilon_{0}} \\frac{\\mathbf{r}}{r^3} \\cdot \\int \\mathbf{r}' \\rho(\\mathbf{r}') d^3\\mathbf{r}' = \\frac{\\mathbf{p} \\cdot \\mathbf{r}}{4\\pi \\epsilon_{0} r^3} $$\nwhere $\\mathbf{p} = \\int \\mathbf{r}' \\rho(\\mathbf{r}') d^3\\mathbf{r}'$ is the electric dipole moment vector.\n\nThe quadrupole contribution to the potential is:\n$$ \\Phi_{\\text{quad}}(\\mathbf{r}) = \\frac{1}{4\\pi \\epsilon_{0}} \\frac{1}{2r^5} \\sum_{\\alpha, \\beta} (3 r_\\alpha r_\\beta - r^2 \\delta_{\\alpha\\beta}) \\int r'_\\alpha r'_\\beta \\rho(\\mathbf{r}') d^3\\mathbf{r}' $$\nThe traceless quadrupole tensor is defined as $Q_{\\alpha\\beta} = \\int (3 r'_\\alpha r'_\\beta - |\\mathbf{r}'|^2 \\delta_{\\alpha\\beta}) \\rho(\\mathbf{r}') d^3\\mathbf{r}'$. The term in the potential can be rewritten using this definition. The summation term is $\\sum_{\\alpha, \\beta} (3 r_\\alpha r_\\beta - r^2 \\delta_{\\alpha\\beta}) \\int r'_\\alpha r'_\\beta \\rho(\\mathbf{r}') d^3\\mathbf{r}' = \\frac{1}{3} \\sum_{\\alpha, \\beta} (3 r_\\alpha r_\\beta - r^2 \\delta_{\\alpha\\beta}) \\int (3 r'_\\alpha r'_\\beta - |\\mathbf{r}'|^2\\delta_{\\alpha\\beta} + |\\mathbf{r}'|^2\\delta_{\\alpha\\beta}) \\rho(\\mathbf{r}') d^3\\mathbf{r}'$. This simplifies because $\\sum_{\\alpha, \\beta} (3 r_\\alpha r_\\beta - r^2 \\delta_{\\alpha\\beta}) \\delta_{\\alpha\\beta} = 3r^2 - 3r^2 = 0$. The expression further simplifies due to the traceless nature of $Q_{\\alpha\\beta}$ ($\\sum_\\alpha Q_{\\alpha\\alpha}=0$), yielding:\n$$ \\Phi_{\\text{quad}}(\\mathbf{r}) = \\frac{1}{8\\pi \\epsilon_{0} r^5} \\sum_{\\alpha, \\beta} r_\\alpha Q_{\\alpha\\beta} r_\\beta $$\nThe electric field $\\mathbf{E}(\\mathbf{r})$ is the negative gradient of the potential, $\\mathbf{E} = -\\nabla \\Phi$.\nFor the dipole contribution:\n$$ \\mathbf{E}_{\\text{dipole}}(\\mathbf{r}) = -\\nabla \\left( \\frac{\\mathbf{p} \\cdot \\mathbf{r}}{4\\pi\\epsilon_0 r^3} \\right) = -\\frac{1}{4\\pi\\epsilon_0} \\nabla \\left( \\frac{\\sum_i p_i r_i}{r^3} \\right) $$\nUsing vector calculus, one finds the standard result:\n$$ \\mathbf{E}_{\\text{dipole}}(\\mathbf{r}) = \\frac{1}{4\\pi \\epsilon_{0}} \\left( \\frac{3(\\mathbf{p} \\cdot \\mathbf{r})\\mathbf{r}}{r^5} - \\frac{\\mathbf{p}}{r^3} \\right) $$\nFor the quadrupole contribution, we take the gradient component-wise, $E_{k} = -\\partial_k \\Phi$:\n$$ E_{k, \\text{quad}}(\\mathbf{r}) = -\\frac{1}{8\\pi\\epsilon_0} \\frac{\\partial}{\\partial r_k} \\left( \\frac{\\sum_{\\alpha, \\beta} r_\\alpha Q_{\\alpha\\beta} r_\\beta}{r^5} \\right) = \\frac{1}{8\\pi\\epsilon_0} \\left[ \\frac{5 r_k (\\sum_{\\alpha, \\beta} r_\\alpha Q_{\\alpha\\beta} r_\\beta)}{r^7} - \\frac{2 (\\sum_{\\beta} Q_{k\\beta} r_\\beta)}{r^5} \\right] $$\nIn vector notation, this is:\n$$ \\mathbf{E}_{\\text{quad}}(\\mathbf{r}) = \\frac{1}{8\\pi \\epsilon_{0}} \\left[ \\frac{5 \\mathbf{r} (\\mathbf{r} \\cdot Q \\mathbf{r})}{r^7} - \\frac{2 Q \\mathbf{r}}{r^5} \\right] $$\nwhere $(\\mathbf{r} \\cdot Q \\mathbf{r}) = \\sum_{\\alpha, \\beta} r_\\alpha Q_{\\alpha\\beta} r_\\beta$ and $(Q\\mathbf{r})_k = \\sum_\\beta Q_{k\\beta} r_\\beta$.\n\nNow, we specialize to the given case. The dipole moment is $\\mathbf{p} = p\\hat{\\mathbf{z}}$ with $p = |\\mathbf{p}| = 2$ D. The quadrupole tensor is diagonal with $Q_{xx} = Q_{yy} = -Q/2$ and $Q_{zz} = Q$, where $Q = 5$ DÅ. We evaluate the potentials at $\\mathbf{r} = r\\hat{\\mathbf{z}}$, where $r=5$ nm. For this point, $\\mathbf{r} = (0, 0, r)$.\n\nThe dipole potential is:\n$$ \\Phi_{\\text{dipole}}(r\\hat{\\mathbf{z}}) = \\frac{\\mathbf{p} \\cdot \\mathbf{r}}{4\\pi \\epsilon_{0} r^3} = \\frac{(p\\hat{\\mathbf{z}})\\cdot(r\\hat{\\mathbf{z}})}{4\\pi \\epsilon_{0} r^3} = \\frac{pr}{4\\pi \\epsilon_{0} r^3} = \\frac{p}{4\\pi \\epsilon_{0} r^2} $$\nThe magnitude is $|\\Phi_{\\text{dipole}}| = \\frac{p}{4\\pi \\epsilon_0 r^2}$ since $p0$.\n\nThe quadrupole potential is:\n$$ \\Phi_{\\text{quad}}(r\\hat{\\mathbf{z}}) = \\frac{1}{8\\pi \\epsilon_{0} r^5} \\sum_{\\alpha, \\beta} r_\\alpha Q_{\\alpha\\beta} r_\\beta $$\nSince $Q$ is diagonal, the sum is $r_x^2 Q_{xx} + r_y^2 Q_{yy} + r_z^2 Q_{zz}$. At $\\mathbf{r} = r\\hat{\\mathbf{z}}$, this becomes $0^2 Q_{xx} + 0^2 Q_{yy} + r^2 Q_{zz} = r^2 Q$.\n$$ \\Phi_{\\text{quad}}(r\\hat{\\mathbf{z}}) = \\frac{r^2 Q}{8\\pi \\epsilon_{0} r^5} = \\frac{Q}{8\\pi \\epsilon_{0} r^3} $$\nThe magnitude is $|\\Phi_{\\text{quad}}| = \\frac{Q}{8\\pi \\epsilon_0 r^3}$ since $Q0$.\n\nThe dimensionless ratio $R$ is:\n$$ R = \\frac{|\\Phi_{\\text{quadrupole}}|}{|\\Phi_{\\text{dipole}}|} = \\frac{Q/(8\\pi \\epsilon_{0} r^3)}{p/(4\\pi \\epsilon_{0} r^2)} = \\frac{Q}{p} \\frac{4\\pi \\epsilon_0 r^2}{8\\pi \\epsilon_0 r^3} = \\frac{Q}{2pr} $$\nWe are given the values $p = 2$ D, $Q = 5$ DÅ, and $r = 5$ nm. We use the conversion $1 \\text{ nm} = 10 \\text{ Å}$ to make units consistent.\n$$ r = 5 \\text{ nm} = 5 \\times 10 \\text{ Å} = 50 \\text{ Å} $$\nSubstituting the values:\n$$ R = \\frac{5 \\text{ DÅ}}{2 \\cdot (2 \\text{ D}) \\cdot (50 \\text{ Å})} = \\frac{5}{2 \\cdot 2 \\cdot 50} = \\frac{5}{200} = \\frac{1}{40} $$",
            "answer": "$$\\boxed{\\frac{1}{40}}$$"
        },
        {
            "introduction": "While static multipoles are useful, many molecular systems exhibit polarization, where electron density dynamically responds to the electrostatic environment. The Charge Equilibration (QEq) model captures this by allowing atomic charges to fluctuate based on the principle of electronegativity equalization. This exercise guides you through the process of minimizing the electrostatic energy of a small molecule under a charge conservation constraint, giving you direct practice with the central variational principle of QEq models .",
            "id": "3413578",
            "problem": "Consider a triatomic molecule with three fluctuating atomic charges $q_{1}$, $q_{2}$, and $q_{3}$, constrained by the total charge $Q_{\\mathrm{tot}}=0$. In the Charge Equilibration (QEq) framework, the electrostatic energy of a set of charges is modeled by a quadratic form composed of atomic electronegativities and hardness coefficients. Assume the following physically motivated energy functional for the charge degrees of freedom:\n$$\nE(\\mathbf{q}) \\equiv \\sum_{i=1}^{3} \\chi_{i}\\, q_{i} + \\frac{1}{2}\\sum_{i=1}^{3} J_{ii}\\, q_{i}^{2} + \\sum_{1 \\leq ij \\leq 3} J_{ij}\\, q_{i}\\, q_{j},\n$$\nwhere $\\mathbf{q}=(q_{1},q_{2},q_{3})$, $\\chi_{i}$ are atomic electronegativities, $J_{ii}$ are atomic self-hardnesses, and $J_{ij}$ are interatomic Coulomb coupling terms modeled by a monopole interaction $J_{ij}=k/r_{ij}$ with $k$ a constant of proportionality. Neglect higher multipole moments (dipoles, quadrupoles, etc.) so that the interaction is purely monopolar. The equilibrium charge distribution minimizes $E(\\mathbf{q})$ subject to the conservation law $\\sum_{i} q_{i} = Q_{\\mathrm{tot}}$.\n\nFor this molecule, take the data\n$$\n\\boldsymbol{\\chi} = \\left(-5.0,\\,-4.0,\\,-7.0\\right)\\ \\mathrm{eV},\\quad J_{ii}=10\\ \\mathrm{eV}\\ \\text{for all}\\ i,\n$$\nand\n$$\nr_{12}=1.0\\ \\text{\\AA},\\quad r_{23}=1.5\\ \\text{\\AA},\\quad r_{13}=1.0\\ \\text{\\AA},\n$$\nwith the Coulomb coupling defined as $J_{ij} = \\dfrac{(1.0\\ \\mathrm{eV\\cdot\\AA})}{r_{ij}}$, so that $J_{12}=1.0\\ \\mathrm{eV}$, $J_{23}=\\dfrac{2}{3}\\ \\mathrm{eV}$, and $J_{13}=1.0\\ \\mathrm{eV}$. Using this physically consistent fluctuating-charge model and the constraint $\\sum_{i=1}^{3} q_{i}=0$, determine the equilibrium charges $(q_{1},q_{2},q_{3})$ that minimize $E(\\mathbf{q})$. Express the final charges in units of the elementary charge, and provide the exact analytical expressions (do not round).",
            "solution": "The problem asks for the equilibrium charge distribution $(q_{1}, q_{2}, q_{3})$ for a triatomic molecule that minimizes the given electrostatic energy functional $E(\\mathbf{q})$ subject to the constraint of total charge conservation, $Q_{\\mathrm{tot}} = \\sum_{i=1}^{3} q_{i} = 0$.\n\nThe energy functional is given by:\n$$\nE(\\mathbf{q}) = \\sum_{i=1}^{3} \\chi_{i}\\, q_{i} + \\frac{1}{2}\\sum_{i=1}^{3} J_{ii}\\, q_{i}^{2} + \\sum_{1 \\leq ij \\leq 3} J_{ij}\\, q_{i}\\, q_{j}\n$$\nThe constraint on the charges is:\n$$\ng(\\mathbf{q}) = q_{1} + q_{2} + q_{3} = 0\n$$\nThis is a constrained optimization problem. Since the energy functional is a quadratic form in the charges and the constraint is linear, a unique minimum exists. We can find this minimum using the method of Lagrange multipliers. We define the Lagrangian function $\\mathcal{L}(\\mathbf{q}, \\lambda)$ as:\n$$\n\\mathcal{L}(q_{1}, q_{2}, q_{3}, \\lambda) = E(q_{1}, q_{2}, q_{3}) - \\lambda (q_{1} + q_{2} + q_{3})\n$$\nThe equilibrium charges are found by setting the partial derivatives of the Lagrangian with respect to each charge $q_{i}$ to zero, which physically corresponds to the principle of electronegativity equalization. The partial derivative with respect to the Lagrange multiplier $\\lambda$ recovers the constraint.\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial q_{i}} = \\frac{\\partial E}{\\partial q_{i}} - \\lambda = 0 \\quad \\text{for } i = 1, 2, 3\n$$\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial \\lambda} = -(q_{1} + q_{2} + q_{3}) = 0\n$$\nThe first set of equations implies that at equilibrium, the molecular electronegativity is equalized across all atoms:\n$$\n\\frac{\\partial E}{\\partial q_{1}} = \\frac{\\partial E}{\\partial q_{2}} = \\frac{\\partial E}{\\partial q_{3}} = \\lambda\n$$\nwhere the partial derivatives of the energy are:\n$$\n\\frac{\\partial E}{\\partial q_{i}} = \\chi_{i} + J_{ii} q_{i} + \\sum_{j \\neq i} J_{ij} q_{j}\n$$\nLet us substitute the given numerical values into these expressions.\nThe parameters are:\n$\\chi_{1} = -5.0$, $\\chi_{2} = -4.0$, $\\chi_{3} = -7.0$ (in units of eV).\n$J_{11} = J_{22} = J_{33} = 10$ (in units of eV).\n$J_{12} = 1.0$, $J_{13} = 1.0$, $J_{23} = \\frac{2}{3}$ (in units of eV).\nThe charges $q_{i}$ are dimensionless, representing charge in units of the elementary charge $e$.\n\nThe system of equations for the equilibrium charges is:\n1. $\\frac{\\partial E}{\\partial q_{1}} = \\chi_1 + J_{11}q_1 + J_{12}q_2 + J_{13}q_3 = -5 + 10q_1 + q_2 + q_3 = \\lambda$\n2. $\\frac{\\partial E}{\\partial q_{2}} = \\chi_2 + J_{21}q_1 + J_{22}q_2 + J_{23}q_3 = -4 + q_1 + 10q_2 + \\frac{2}{3}q_3 = \\lambda$\n3. $\\frac{\\partial E}{\\partial q_{3}} = \\chi_3 + J_{31}q_1 + J_{32}q_2 + J_{33}q_3 = -7 + q_1 + \\frac{2}{3}q_2 + 10q_3 = \\lambda$\n4. And the constraint: $q_1 + q_2 + q_3 = 0$\n\nTo solve this system, we can eliminate $\\lambda$ by equating the first three expressions.\nEquating equations $(1)$ and $(2)$:\n$$\n-5 + 10q_1 + q_2 + q_3 = -4 + q_1 + 10q_2 + \\frac{2}{3}q_3\n$$\n$$\n9q_1 - 9q_2 + \\frac{1}{3}q_3 = 1 \\quad (\\text{Eq. I})\n$$\nEquating equations $(2)$ and $(3)$:\n$$\n-4 + q_1 + 10q_2 + \\frac{2}{3}q_3 = -7 + q_1 + \\frac{2}{3}q_2 + 10q_3\n$$\n$$\n\\left(10 - \\frac{2}{3}\\right)q_2 - \\left(10 - \\frac{2}{3}\\right)q_3 = -3\n$$\n$$\n\\frac{28}{3}(q_2 - q_3) = -3 \\implies q_2 - q_3 = -3 \\cdot \\frac{3}{28} = -\\frac{9}{28} \\quad (\\text{Eq. II})\n$$\nWe now have a system of three linear equations for $q_1, q_2, q_3$: the constraint equation $(4)$ and the two derived equations (I) and (II).\n$$\n\\begin{cases}\nq_1 + q_2 + q_3 = 0 \\\\\n9q_1 - 9q_2 + \\frac{1}{3}q_3 = 1 \\\\\nq_2 - q_3 = -\\frac{9}{28}\n\\end{cases}\n$$\nFrom (Eq. II), we express $q_2$ in terms of $q_3$:\n$$\nq_2 = q_3 - \\frac{9}{28}\n$$\nSubstitute this into the constraint equation $(4)$:\n$$\nq_1 + \\left(q_3 - \\frac{9}{28}\\right) + q_3 = 0 \\implies q_1 + 2q_3 = \\frac{9}{28}\n$$\nThis gives $q_1$ in terms of $q_3$:\n$$\nq_1 = \\frac{9}{28} - 2q_3\n$$\nNow, substitute the expressions for $q_1$ and $q_2$ into (Eq. I):\n$$\n9\\left(\\frac{9}{28} - 2q_3\\right) - 9\\left(q_3 - \\frac{9}{28}\\right) + \\frac{1}{3}q_3 = 1\n$$\n$$\n\\frac{81}{28} - 18q_3 - 9q_3 + \\frac{81}{28} + \\frac{1}{3}q_3 = 1\n$$\nCombine terms:\n$$\n\\frac{162}{28} - 27q_3 + \\frac{1}{3}q_3 = 1\n$$\nSimplify the fraction and the coefficients of $q_3$:\n$$\n\\frac{81}{14} - \\left(\\frac{81}{3} - \\frac{1}{3}\\right)q_3 = 1\n$$\n$$\n\\frac{81}{14} - \\frac{80}{3}q_3 = 1\n$$\nSolve for $q_3$:\n$$\n\\frac{80}{3}q_3 = \\frac{81}{14} - 1 = \\frac{81 - 14}{14} = \\frac{67}{14}\n$$\n$$\nq_3 = \\frac{67}{14} \\cdot \\frac{3}{80} = \\frac{201}{1120}\n$$\nNow we can find $q_2$ and $q_1$ by back-substitution:\n$$\nq_2 = q_3 - \\frac{9}{28} = \\frac{201}{1120} - \\frac{9 \\cdot 40}{28 \\cdot 40} = \\frac{201 - 360}{1120} = -\\frac{159}{1120}\n$$\n$$\nq_1 = -q_2 - q_3 = -\\left(-\\frac{159}{1120}\\right) - \\frac{201}{1120} = \\frac{159 - 201}{1120} = -\\frac{42}{1120}\n$$\nThe fraction for $q_1$ can be simplified:\n$$\nq_1 = -\\frac{42}{1120} = -\\frac{21}{560} = -\\frac{3}{80}\n$$\nThus, the equilibrium charges, expressed as exact fractions in units of the elementary charge, are:\n$q_1 = -\\frac{3}{80}$\n$q_2 = -\\frac{159}{1120}$\n$q_3 = \\frac{201}{1120}$\nWe can verify that the sum is zero: $q_1 + q_2 + q_3 = -\\frac{3 \\cdot 14}{80 \\cdot 14} - \\frac{159}{1120} + \\frac{201}{1120} = \\frac{-42 - 159 + 201}{1120} = \\frac{-201 + 201}{1120} = 0$.",
            "answer": "$$\n\\boxed{\\begin{pmatrix} -\\frac{3}{80}  -\\frac{159}{1120}  \\frac{201}{1120} \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "An accurate energy model is only useful for molecular dynamics if it yields accurate and conservative forces. When the parameters of the model (like charges) depend on the nuclear coordinates, deriving these forces requires careful application of the chain rule, leading to so-called Pulay or response terms. This advanced practice challenges you to derive the complete nuclear forces for a fluctuating charge model and numerically investigate the critical role these response terms play in ensuring long-term energy conservation in a simulation .",
            "id": "3413583",
            "problem": "You are asked to formalize and implement analytic nuclear forces for a fluctuating-charge model of electrostatics with a global charge constraint, including Pulay-like response terms. You must start from a well-defined variational energy functional used in fluctuating-charge molecular dynamics and rigorously derive the forces from first principles. Then, you will simulate constant-energy (microcanonical) dynamics to test energy conservation with three force models and diagnose drift sources when the charge degrees of freedom are not fully optimized at each step.\n\nAll physical quantities must be treated in reduced atomic units where the elementary charge, reduced Planck constant, and electron mass satisfy $e = \\hbar = m_e = 1$. Distances are in bohr, energies in Hartree, masses in units of the electron mass, and time in atomic time units. All angles, if any, are in radians.\n\nBase model and definitions:\n- Consider $N$ nuclei with positions $\\mathbf{R} = \\left(\\mathbf{R}_1,\\ldots,\\mathbf{R}_N\\right)$, nuclear charges $\\mathbf{Z} = (Z_1,\\ldots,Z_N)$, diagonal hardness parameters $\\boldsymbol{\\eta} = (\\eta_1,\\ldots,\\eta_N)$, and electronegativities $\\boldsymbol{\\chi} = (\\chi_1,\\ldots,\\chi_N)$.\n- The fluctuating charges are $\\mathbf{q} \\in \\mathbb{R}^N$, subject to the global charge conservation constraint $\\mathbf{1}^\\top \\mathbf{q} = Q$, where $\\mathbf{1}$ denotes the all-ones vector and $Q$ is the total charge (a scalar).\n- The electrostatic interaction matrix $\\mathbf{J}(\\mathbf{R}) \\in \\mathbb{R}^{N\\times N}$ has diagonal entries $J_{ii} = \\eta_i$ and off-diagonal entries $J_{ij}(\\mathbf{R}) = 1/r_{ij}$ for $i \\neq j$, with $r_{ij} = \\|\\mathbf{R}_i - \\mathbf{R}_j\\|$.\n- The nuclear-nuclear repulsion is $V_{\\mathrm{nn}}(\\mathbf{R}) = \\sum_{1 \\le i lt; j \\le N} \\dfrac{Z_i Z_j}{r_{ij}}$.\n- The fluctuating-charge energy is $E_{\\mathrm{FQ}}(\\mathbf{R}, \\mathbf{q}) = \\dfrac{1}{2}\\mathbf{q}^\\top \\mathbf{J}(\\mathbf{R}) \\mathbf{q} + \\boldsymbol{\\chi}^\\top \\mathbf{q}$.\n- The total potential energy is $E_{\\mathrm{pot}}(\\mathbf{R}, \\mathbf{q}) = E_{\\mathrm{FQ}}(\\mathbf{R}, \\mathbf{q}) + V_{\\mathrm{nn}}(\\mathbf{R})$.\n\nVariational principle:\n- The Born-Oppenheimer optimal charges $\\mathbf{q}^*(\\mathbf{R})$ minimize $E_{\\mathrm{FQ}}(\\mathbf{R}, \\mathbf{q})$ subject to $\\mathbf{1}^\\top \\mathbf{q} = Q$. Introduce a Lagrange multiplier $\\lambda$ to enforce the constraint and formulate the stationarity conditions. Show that $\\mathbf{q}^*(\\mathbf{R})$ and $\\lambda^*(\\mathbf{R})$ satisfy a linear Karush–Kuhn–Tucker (KKT) system built from $\\mathbf{J}(\\mathbf{R})$ and $\\mathbf{1}$.\n- Define the total energy $E_{\\mathrm{tot}}(\\mathbf{R}, \\dot{\\mathbf{R}}) = \\sum_{i=1}^N \\dfrac{1}{2} m_i \\|\\dot{\\mathbf{R}}_i\\|^2 + E_{\\mathrm{pot}}(\\mathbf{R}, \\mathbf{q}_{\\mathrm{used}})$, where $m_i$ are nuclear masses and $\\mathbf{q}_{\\mathrm{used}}$ denotes the charges used to compute the forces in a given force model.\n\nForce derivation requirements:\n- Starting from Newton’s second law and the chain rule, derive the total force on nucleus $a$ at fixed $\\mathbf{q}$ as $\\mathbf{F}_a^{\\mathrm{exp}}(\\mathbf{R}, \\mathbf{q}) = -\\dfrac{\\partial}{\\partial \\mathbf{R}_a} E_{\\mathrm{pot}}(\\mathbf{R}, \\mathbf{q})$, i.e., the explicit derivative at fixed $\\mathbf{q}$. Express this explicitly in terms of pairwise contributions depending only on $\\mathbf{R}$, $\\mathbf{Z}$, and $\\mathbf{q}$.\n- Using the variational stationarity, derive the condition under which the Pulay-like term $-\\left(\\dfrac{\\partial E_{\\mathrm{FQ}}}{\\partial \\mathbf{q}}\\right)^\\top \\dfrac{\\partial \\mathbf{q}^*}{\\partial \\mathbf{R}_a}$ vanishes for exactly optimized charges, and explain why this ensures that the analytic force for $\\mathbf{q}^*(\\mathbf{R})$ is purely the explicit derivative.\n- Derive a linear-response expression for $\\dfrac{\\partial \\mathbf{q}}{\\partial \\mathbf{R}_{a\\alpha}}$ at fixed geometry for an arbitrary, not-fully-optimized $\\mathbf{q}$ by differentiating the KKT conditions with respect to the Cartesian component $\\mathbf{R}_{a\\alpha}$, with the constraint derivative $\\mathbf{1}^\\top \\dfrac{\\partial \\mathbf{q}}{\\partial \\mathbf{R}_{a\\alpha}} = 0$. Use this to express a Pulay-like correction term to the force when using an approximate charge vector $\\mathbf{q}$ that does not satisfy the stationarity conditions.\n\nNumerical experiment and energy conservation:\n- Implement velocity–Verlet integration of $N$ nuclei in the microcanonical ensemble (constant $N$, $V$, $E$), with time step $\\Delta t$ in atomic units. At each step, use one of three force models:\n    1. Exact variational forces: at each force evaluation, solve exactly for $\\mathbf{q}^*(\\mathbf{R})$ from the KKT system and use the explicit force at fixed $\\mathbf{q}^*$.\n    2. Naive lagged charges without Pulay: maintain charges lagged by one full time step, i.e., use $\\mathbf{q}_{\\mathrm{used}}(t_n) = \\mathbf{q}^*(\\mathbf{R}(t_{n-1}))$ for both force evaluations within the $n$-th time step; do not include any Pulay correction.\n    3. Lagged charges with Pulay-like correction: use the same lagged $\\mathbf{q}_{\\mathrm{used}}$ as in case $2$, but add the Pulay-like response force computed from the linear-response derivative $\\dfrac{\\partial \\mathbf{q}}{\\partial \\mathbf{R}}$ evaluated with $\\mathbf{q}_{\\mathrm{used}}$ at the current geometry.\n- For each case, compute the instantaneous total energy $E_{\\mathrm{tot}}(t)$ as the sum of kinetic energy and potential energy evaluated consistently with the charges used in the forces at that step. Define the energy drift metric over a trajectory of $T$ steps as the maximum absolute relative deviation, i.e., $\\max_{0 \\le n \\le T} \\left| \\dfrac{E_{\\mathrm{tot}}(t_n) - E_{\\mathrm{tot}}(t_0)}{E_{\\mathrm{tot}}(t_0)} \\right|$, which is dimensionless.\n\nTest suite:\nYou must implement the three force models above for each of the two molecular systems below. For both systems use constant electronegativities independent of geometry. Initial velocities must be chosen to have zero total momentum. All quantities are in atomic units. Your program must compute, for each system and each force model, the energy drift metric defined above, rounded by the default floating-point print behavior.\n\n- System A (two nuclei):\n    - $N = 2$\n    - Nuclear charges: $\\mathbf{Z} = (1, 1)$\n    - Hardness parameters: $\\boldsymbol{\\eta} = (8, 9)$\n    - Electronegativities: $\\boldsymbol{\\chi} = (-5, -4)$\n    - Total charge: $Q = 0$\n    - Masses: $\\mathbf{m} = (1836, 1836)$\n    - Initial positions: $\\mathbf{R}_1 = (-1, 0, 0)$, $\\mathbf{R}_2 = (1, 0, 0)$\n    - Initial velocities: small random values ensuring zero net momentum and magnitude of order $10^{-3}$\n    - Time step: $\\Delta t = 0.2$\n    - Number of steps: $T = 400$\n- System B (three nuclei):\n    - $N = 3$\n    - Nuclear charges: $\\mathbf{Z} = (1, 1, 1)$\n    - Hardness parameters: $\\boldsymbol{\\eta} = (10, 9, 11)$\n    - Electronegativities: $\\boldsymbol{\\chi} = (-4.5, -5.0, -4.0)$\n    - Total charge: $Q = 0$\n    - Masses: $\\mathbf{m} = (1836, 3672, 1836)$\n    - Initial positions: $\\mathbf{R}_1 = (-2, 0, 0)$, $\\mathbf{R}_2 = (0, 0, 0)$, $\\mathbf{R}_3 = (2, 0, 0)$\n    - Initial velocities: small random values ensuring zero net momentum and magnitude of order $10^{-3}$\n    - Time step: $\\Delta t = 0.2$\n    - Number of steps: $T = 400$\n\nFinal output specification:\n- Your program must produce a single line of output containing a list of $6$ floating-point numbers in the following order:\n    - System A: energy drift for exact variational forces, energy drift for naive lagged charges without Pulay, energy drift for lagged charges with Pulay-like correction.\n    - System B: energy drift for exact variational forces, energy drift for naive lagged charges without Pulay, energy drift for lagged charges with Pulay-like correction.\n- The output format must be a single line containing a Python-style list with comma-separated values and no extra text, for example, $\"[x_1,x_2,x_3,x_4,x_5,x_6]\"$ where each $x_i$ is a floating-point number.\n\nYour derivation and implementation must be self-consistent and must not rely on any external input beyond the parameters specified above.",
            "solution": "The problem is validated as scientifically grounded, well-posed, objective, and internally consistent. It presents a standard but non-trivial exercise in theoretical and computational chemistry, involving the derivation of nuclear forces from a variational energy functional and the analysis of energy conservation in molecular dynamics simulations. We will now proceed with the solution.\n\n### Theoretical Derivations\n\nAll derivations are performed in reduced atomic units where $e = \\hbar = m_e = 1$.\n\n#### Variational Principle and Karush–Kuhn–Tucker (KKT) System\n\nWe are given the fluctuating-charge energy functional $E_{\\mathrm{FQ}}(\\mathbf{R}, \\mathbf{q}) = \\dfrac{1}{2}\\mathbf{q}^\\top \\mathbf{J}(\\mathbf{R}) \\mathbf{q} + \\boldsymbol{\\chi}^\\top \\mathbf{q}$ and a global charge conservation constraint $\\mathbf{1}^\\top \\mathbf{q} = Q$. The Born-Oppenheimer optimal charges $\\mathbf{q}^*(\\mathbf{R})$ are those that minimize $E_{\\mathrm{FQ}}$ subject to this constraint.\n\nWe use the method of Lagrange multipliers. The Lagrangian $\\mathcal{L}$ is defined as:\n$$\n\\mathcal{L}(\\mathbf{q}, \\lambda) = E_{\\mathrm{FQ}}(\\mathbf{R}, \\mathbf{q}) - \\lambda (\\mathbf{1}^\\top \\mathbf{q} - Q)\n$$\nwhere $\\lambda$ is the Lagrange multiplier associated with the charge constraint. The stationarity conditions require the partial derivatives of $\\mathcal{L}$ with respect to $\\mathbf{q}$ and $\\lambda$ to be zero.\n\nThe derivative with respect to the charge vector $\\mathbf{q}$ is:\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial \\mathbf{q}} = \\frac{\\partial E_{\\mathrm{FQ}}}{\\partial \\mathbf{q}} - \\lambda \\mathbf{1}^\\top = (\\mathbf{J}(\\mathbf{R})\\mathbf{q} + \\boldsymbol{\\chi})^\\top - \\lambda \\mathbf{1}^\\top = \\mathbf{0}^\\top\n$$\nThis gives the equation:\n$$\n\\mathbf{J}(\\mathbf{R})\\mathbf{q} + \\boldsymbol{\\chi} = \\lambda \\mathbf{1}\n$$\n\nThe derivative with respect to the multiplier $\\lambda$ is:\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial \\lambda} = -(\\mathbf{1}^\\top \\mathbf{q} - Q) = 0\n$$\nThis recovers the constraint equation:\n$$\n\\mathbf{1}^\\top \\mathbf{q} = Q\n$$\n\nCombining these two sets of equations for the optimal charges $\\mathbf{q}^*$ and multiplier $\\lambda^*$, we obtain a linear system of equations. This can be written in a block matrix form, known as the Karush–Kuhn–Tucker (KKT) system:\n$$\n\\begin{pmatrix}\n\\mathbf{J}(\\mathbf{R})  -\\mathbf{1} \\\\\n\\mathbf{1}^\\top  0\n\\end{pmatrix}\n\\begin{pmatrix}\n\\mathbf{q}^* \\\\\n\\lambda^*\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n-\\boldsymbol{\\chi} \\\\\nQ\n\\end{pmatrix}\n$$\nThis is an $(N+1) \\times (N+1)$ linear system that can be solved to find the unique optimal charges $\\mathbf{q}^*(\\mathbf{R})$ and the associated optimal Lagrange multiplier $\\lambda^*(\\mathbf{R})$ for a given nuclear configuration $\\mathbf{R}$.\n\n#### Derivation of the Explicit Force at Fixed Charges\n\nThe total potential energy is $E_{\\mathrm{pot}}(\\mathbf{R}, \\mathbf{q}) = E_{\\mathrm{FQ}}(\\mathbf{R}, \\mathbf{q}) + V_{\\mathrm{nn}}(\\mathbf{R})$. For fixed charges $\\mathbf{q}$, the explicit force on nucleus $a$ is defined as $\\mathbf{F}_a^{\\mathrm{exp}}(\\mathbf{R}, \\mathbf{q}) = -\\dfrac{\\partial E_{\\mathrm{pot}}(\\mathbf{R}, \\mathbf{q})}{\\partial \\mathbf{R}_a}$.\n\nLet's write out the terms in $E_{\\mathrm{pot}}$ that depend on the nuclear coordinates $\\mathbf{R}$:\n$$\nE_{\\mathrm{pot}}(\\mathbf{R}, \\mathbf{q}) = \\frac{1}{2}\\sum_{i \\neq j} q_i q_j J_{ij}(\\mathbf{R}) + \\sum_{ij} \\frac{Z_i Z_j}{r_{ij}} + C(\\mathbf{q})\n$$\nwhere $J_{ij}(\\mathbf{R}) = 1/r_{ij}$ and $C(\\mathbf{q})$ contains all terms independent of $\\mathbf{R}$.\nThe derivative of the inverse distance $1/r_{ij}$ with respect to $\\mathbf{R}_a$ is:\n$$\n\\frac{\\partial (1/r_{ij})}{\\partial \\mathbf{R}_a} = -\\frac{1}{r_{ij}^2} \\frac{\\partial r_{ij}}{\\partial \\mathbf{R}_a} = -\\frac{1}{r_{ij}^2} \\left( \\delta_{ia} \\frac{\\mathbf{R}_i-\\mathbf{R}_j}{r_{ij}} + \\delta_{ja} \\frac{\\mathbf{R}_j-\\mathbf{R}_i}{r_{ij}} \\right) = -(\\delta_{ia} - \\delta_{ja}) \\frac{\\mathbf{R}_i - \\mathbf{R}_j}{r_{ij}^3}\n$$\nApplying this to the potential energy derivative:\n$$\n\\frac{\\partial E_{\\mathrm{pot}}}{\\partial \\mathbf{R}_a} = \\sum_{ij} (q_i q_j + Z_i Z_j) \\frac{\\partial (1/r_{ij})}{\\partial \\mathbf{R}_a} = \\sum_{ij} (q_i q_j + Z_i Z_j) \\left[-(\\delta_{ia} - \\delta_{ja}) \\frac{\\mathbf{R}_i - \\mathbf{R}_j}{r_{ij}^3}\\right]\n$$\nThis sum is non-zero only when $i=a$ or $j=a$. We can expand it:\n$$\n\\frac{\\partial E_{\\mathrm{pot}}}{\\partial \\mathbf{R}_a} = \\sum_{j > a} (q_a q_j + Z_a Z_j) \\left[- \\frac{\\mathbf{R}_a - \\mathbf{R}_j}{r_{aj}^3}\\right] + \\sum_{i  a} (q_i q_a + Z_i Z_a) \\left[+ \\frac{\\mathbf{R}_i - \\mathbf{R}_a}{r_{ia}^3}\\right]\n$$\nCombining these terms into a single sum over all $j \\neq a$:\n$$\n\\frac{\\partial E_{\\mathrm{pot}}}{\\partial \\mathbf{R}_a} = \\sum_{j \\neq a} (q_a q_j + Z_a Z_j) \\frac{\\mathbf{R}_j - \\mathbf{R}_a}{r_{aj}^3} = -\\sum_{j \\neq a} (q_a q_j + Z_a Z_j) \\frac{\\mathbf{R}_a - \\mathbf{R}_j}{r_{aj}^3}\n$$\nThe explicit force is therefore:\n$$\n\\mathbf{F}_a^{\\mathrm{exp}} = -\\frac{\\partial E_{\\mathrm{pot}}}{\\partial \\mathbf{R}_a} = \\sum_{j \\neq a} \\frac{q_a q_j + Z_a Z_j}{r_{aj}^3} (\\mathbf{R}_a - \\mathbf{R}_j)\n$$\nThis is a sum of pairwise interactions.\n\n#### Vanishing of the Pulay Force for Optimal Charges\n\nThe total force on nucleus $a$ is the total derivative of the potential energy with respect to $\\mathbf{R}_a$, evaluated at the optimal charges $\\mathbf{q}^*(\\mathbf{R})$:\n$$\n\\mathbf{F}_a^{\\mathrm{total}} = -\\frac{d E_{\\mathrm{pot}}(\\mathbf{R}, \\mathbf{q}^*(\\mathbf{R}))}{d \\mathbf{R}_a}\n$$\nUsing the chain rule:\n$$\n\\mathbf{F}_a^{\\mathrm{total}} = -\\left[ \\frac{\\partial E_{\\mathrm{pot}}}{\\partial \\mathbf{R}_a} \\right]_{\\mathbf{q}=\\mathbf{q}^*} - \\left[ \\left(\\frac{\\partial E_{\\mathrm{pot}}}{\\partial \\mathbf{q}}\\right)^\\top \\frac{\\partial \\mathbf{q}^*}{\\partial \\mathbf{R}_a} \\right]_{\\mathbf{q}=\\mathbf{q}^*}\n$$\nThe first term is the explicit force $\\mathbf{F}_a^{\\mathrm{exp}}(\\mathbf{R}, \\mathbf{q}^*)$. The second term is the Pulay force. As $V_{\\mathrm{nn}}$ is independent of $\\mathbf{q}$, we have $\\frac{\\partial E_{\\mathrm{pot}}}{\\partial \\mathbf{q}} = \\frac{\\partial E_{\\mathrm{FQ}}}{\\partial \\mathbf{q}}$.\nThe Pulay force is $\\mathbf{F}_a^{\\mathrm{Pulay}} = -\\left(\\frac{\\partial E_{\\mathrm{FQ}}}{\\partial \\mathbf{q}}\\right)^\\top \\frac{\\partial \\mathbf{q}^*}{\\partial \\mathbf{R}_a}$.\nFrom the stationarity condition for optimal charges, we found that $\\frac{\\partial E_{\\mathrm{FQ}}}{\\partial q_i} = \\lambda^*$ for all $i=1, \\ldots, N$.\nTherefore, the Pulay force can be written as:\n$$\n\\mathbf{F}_a^{\\mathrm{Pulay}} = - \\sum_{i=1}^N \\lambda^* \\frac{\\partial q_i^*}{\\partial \\mathbf{R}_a} = -\\lambda^* \\frac{\\partial}{\\partial \\mathbf{R}_a} \\left(\\sum_{i=1}^N q_i^*\\right)\n$$\nThe charge constraint requires $\\sum_{i=1}^N q_i^* = Q$, which is a constant. The derivative of a constant is zero:\n$$\n\\frac{\\partial}{\\partial \\mathbf{R}_a} (Q) = \\mathbf{0}\n$$\nThus, for exactly optimized charges $\\mathbf{q}^*$, the Pulay force vanishes identically: $\\mathbf{F}_a^{\\mathrm{Pulay}} = \\mathbf{0}$. This is a manifestation of the Hellmann-Feynman theorem for a constrained variational system. The total force is simply the explicit force: $\\mathbf{F}_a^{\\mathrm{total}} = \\mathbf{F}_a^{\\mathrm{exp}}(\\mathbf{R}, \\mathbf{q}^*)$.\n\n#### Pulay-like Correction for Non-Optimized Charges\n\nWhen using approximate charges $\\mathbf{q}_{\\mathrm{used}}$ that do not satisfy the stationarity condition, the gradient of the energy with respect to charges, $\\mathbf{g}(\\mathbf{q}_{\\mathrm{used}}) = \\frac{\\partial E_{\\mathrm{FQ}}}{\\partial \\mathbf{q}} = \\mathbf{J}\\mathbf{q}_{\\mathrm{used}} + \\boldsymbol{\\chi}$, is not proportional to the all-ones vector $\\mathbf{1}$. In this case, the force includes a non-vanishing Pulay-like correction term:\n$$\n\\mathbf{F}_a^{\\mathrm{Pulay-like}} = -\\mathbf{g}(\\mathbf{q}_{\\mathrm{used}})^\\top \\frac{\\partial \\mathbf{q}}{\\partial \\mathbf{R}_a}\n$$\nTo find an expression for the charge response $\\frac{\\partial \\mathbf{q}}{\\partial \\mathbf{R}_a}$, we differentiate the KKT system with respect to a Cartesian coordinate $R_{a\\alpha}$:\n$$\n\\frac{\\partial}{\\partial R_{a\\alpha}} \\left( \\mathbf{J}(\\mathbf{R})\\mathbf{q} + \\boldsymbol{\\chi} = \\lambda \\mathbf{1} \\right) \\implies \\mathbf{J} \\frac{\\partial \\mathbf{q}}{\\partial R_{a\\alpha}} + \\frac{\\partial \\mathbf{J}}{\\partial R_{a\\alpha}} \\mathbf{q} - \\frac{\\partial \\lambda}{\\partial R_{a\\alpha}} \\mathbf{1} = \\mathbf{0}\n$$\n$$\n\\frac{\\partial}{\\partial R_{a\\alpha}} \\left( \\mathbf{1}^\\top \\mathbf{q} = Q \\right) \\implies \\mathbf{1}^\\top \\frac{\\partial \\mathbf{q}}{\\partial R_{a\\alpha}} = 0\n$$\nAs an approximation consistent with using lagged charges, we evaluate the term $\\frac{\\partial \\mathbf{J}}{\\partial R_{a\\alpha}} \\mathbf{q}$ using $\\mathbf{q}_{\\mathrm{used}}$. This gives a linear system for the response vector $\\frac{\\partial \\mathbf{q}}{\\partial R_{a\\alpha}}$:\n$$\n\\begin{pmatrix}\n\\mathbf{J}(\\mathbf{R})  -\\mathbf{1} \\\\\n\\mathbf{1}^\\top  0\n\\end{pmatrix}\n\\begin{pmatrix}\n\\partial \\mathbf{q}/\\partial R_{a\\alpha} \\\\\n\\partial \\lambda/\\partial R_{a\\alpha}\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n-\\frac{\\partial \\mathbf{J}(\\mathbf{R})}{\\partial R_{a\\alpha}} \\mathbf{q}_{\\mathrm{used}} \\\\\n0\n\\end{pmatrix}\n$$\nThe derivative of the interaction matrix has entries $(\\frac{\\partial \\mathbf{J}}{\\partial R_{a\\alpha}})_{ij} = \\frac{\\partial (1/r_{ij})}{\\partial R_{a\\alpha}} = -(\\delta_{ia} - \\delta_{ja}) \\frac{R_{i\\alpha} - R_{j\\alpha}}{r_{ij}^3}$ for $i \\neq j$, and zero for $i=j$. For each nucleus $a$ and coordinate $\\alpha \\in \\{x,y,z\\}$, we solve this system to obtain $\\partial \\mathbf{q}/\\partial R_{a\\alpha}$. The resulting Pulay-like correction force component is:\n$$\nF_{a\\alpha}^{\\mathrm{Pulay-like}} = -(\\mathbf{J}(\\mathbf{R})\\mathbf{q}_{\\mathrm{used}} + \\boldsymbol{\\chi})^\\top \\frac{\\partial \\mathbf{q}}{\\partial R_{a\\alpha}}\n$$\nThis correction term accounts for the energy change due to the relaxation of charges in response to a nuclear displacement, which is neglected in the naive lagged charge model. Including it is crucial for better energy conservation when charges are not re-optimized at every step.",
            "answer": "[2.744158933250882e-13,0.0016027666270104675,5.1872169584347715e-13,6.861755100088523e-14,0.003923363321580226,1.444766023588264e-13]"
        }
    ]
}