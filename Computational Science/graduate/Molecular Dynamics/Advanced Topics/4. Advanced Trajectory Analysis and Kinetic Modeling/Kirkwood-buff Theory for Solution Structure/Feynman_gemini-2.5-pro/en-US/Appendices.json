{
    "hands_on_practices": [
        {
            "introduction": "The Kirkwood-Buff integral, $G_{ij}$, quantifies the net accumulation or depletion of species $j$ around species $i$ over all space. Its computation from a given radial distribution function, $g_{ij}(r)$, is a foundational skill. This first exercise  guides you through the essential task of implementing a numerical estimator for $G_{ij}$, starting from its definition as a three-dimensional integral and correctly specializing it for isotropic systems. You will verify your code against the exact analytical result for an ideal gas, a crucial step in building confidence in any scientific computing tool.",
            "id": "3419765",
            "problem": "Consider a binary mixture in the ideal gas limit, where particles do not interact and the structure is isotropic in three dimensions. Let the Radial Distribution Function (RDF) between species $i$ and $j$ be denoted by $g_{ij}(r)$. In the ideal gas limit, there are no spatial correlations and the RDF satisfies $g_{ij}(r) = 1$ for all $r  0$. The Kirkwood-Buff (KB) integral $G_{ij}$ is defined as the integral over all space of the total correlation function $h_{ij}(\\mathbf{r}) = g_{ij}(\\mathbf{r}) - 1$. In an isotropic fluid, this integral can be expressed in terms of the radial coordinate $r$ and the appropriate spherical measure. \n\nYour task is to derive, implement, and unit test a numerical estimator for $G_{ij}$ based on a discretized RDF sampled on a uniform radial grid. The derivation must start from the definition of the RDF and the definition of the KB integral as a three-dimensional integral of the total correlation function over space, specialized to isotropic systems through the correct spherical measure. Then, design a consistent numerical quadrature to approximate the isotropic three-dimensional integral using a uniform grid with spacing $\\Delta r$ over the interval $[0, R_{\\max}]$. The estimator must support at least two quadrature rules: a composite trapezoidal rule and a composite Simpson’s rule (the latter requiring an odd number of grid points). \n\nIn the ideal gas limit, $g_{ij}(r) = 1$, so the exact integral must be $G_{ij} = 0$. Use this fact to construct a unit test suite that checks whether the numerical estimator yields a value close to $0$ within a specified absolute tolerance. To emulate realistic finite-sampling artifacts from Molecular Dynamics (MD) data without leaving the ideal gas limit, optionally perturb the ideal gas RDF by adding mean-zero Gaussian noise of specified standard deviation $\\sigma$ to $g_{ij}(r)$ prior to integration; this preserves the ideal gas expectation $G_{ij}=0$ but introduces numerical deviations that a robust estimator should keep within a tolerance that you must specify. If noise is used, you must use the provided random seed to ensure reproducibility.\n\nImplementation details and requirements:\n- Construct the uniform grid as $r_k = k\\,\\Delta r$ for $k = 0, 1, \\dots, N$ with $N = R_{\\max}/\\Delta r$ assumed to be an integer, so that the grid includes both $0$ and $R_{\\max}$. Distances $r$ must be in nanometers (nm). The final Kirkwood-Buff integral must be reported and compared in cubic nanometers (nm$^3$).\n- The numerical estimator must implement both a composite trapezoidal rule and a composite Simpson’s rule to approximate the isotropic three-dimensional integral of $g_{ij}(r) - 1$ over space using the correct spherical measure for isotropic systems in three dimensions.\n- For unit testing, use the following test suite. For each case, construct $g_{ij}(r)$ as $1$ plus optional Gaussian noise $\\mathcal{N}(0,\\sigma^2)$ added independently at each grid point, using the provided random seed when $\\sigma  0$. Compute the numerical estimate $\\widehat{G}_{ij}$ and return a boolean indicating whether $|\\widehat{G}_{ij}| \\le \\text{tol}$, where $\\text{tol}$ is the stated absolute tolerance in nm$^3$.\n    1. Case A (happy path, trapezoid, fine grid, no noise): $\\Delta r = 0.01$ nm, $R_{\\max} = 10.0$ nm, quadrature rule = trapezoid, $\\sigma = 0$, tolerance $\\text{tol} = 1.0\\times 10^{-12}$ nm$^3$.\n    2. Case B (happy path, Simpson, fine grid, no noise): $\\Delta r = 0.0025$ nm, $R_{\\max} = 5.0$ nm, quadrature rule = Simpson, $\\sigma = 0$, tolerance $\\text{tol} = 1.0\\times 10^{-12}$ nm$^3$.\n    3. Case C (noisy, moderate grid): $\\Delta r = 0.005$ nm, $R_{\\max} = 5.0$ nm, quadrature rule = trapezoid, $\\sigma = 1.0\\times 10^{-7}$, random seed $12345$, tolerance $\\text{tol} = 1.0\\times 10^{-4}$ nm$^3$.\n    4. Case D (boundary condition, very coarse grid, no noise): $\\Delta r = 1.0$ nm, $R_{\\max} = 1.0$ nm, quadrature rule = trapezoid, $\\sigma = 0$, tolerance $\\text{tol} = 1.0\\times 10^{-12}$ nm$^3$.\n    5. Case E (small cutoff with noise): $\\Delta r = 0.01$ nm, $R_{\\max} = 0.5$ nm, quadrature rule = trapezoid, $\\sigma = 1.0\\times 10^{-6}$, random seed $24680$, tolerance $\\text{tol} = 1.0\\times 10^{-6}$ nm$^3$.\n\nYour program must:\n- Implement the numerical estimator for $G_{ij}$ using the correct three-dimensional isotropic measure and the specified quadrature rule.\n- For each test case, build the grid and $g_{ij}(r)$ as described, compute $\\widehat{G}_{ij}$, compare $|\\widehat{G}_{ij}|$ to the provided tolerance, and collect a boolean result.\n- Produce a single line of output containing the boolean results for Cases A through E as a comma-separated list enclosed in square brackets, for example, $[{\\rm True},{\\rm False},{\\rm True},{\\rm True},{\\rm True}]$.\n\nNote: Ensure that any angles, if they appeared, would be in radians, but no angles are used here. Distances must be in nanometers (nm), and the Kirkwood-Buff integral must be in cubic nanometers (nm$^3$). The final program must run without external input and must print exactly one line in the specified format.",
            "solution": "The problem requires the derivation and implementation of a numerical estimator for the Kirkwood-Buff (KB) integral, $G_{ij}$, for a binary mixture in the ideal gas limit. The validation of this estimator is performed using a unit test suite where the ideal gas condition implies that the theoretical value of the integral is zero.\n\n### Derivation of the Isotropic KB Integral Estimator\n\nThe Kirkwood-Buff integral, $G_{ij}$, is defined as the volume integral of the total correlation function, $h_{ij}(\\mathbf{r})$, over all space. The total correlation function is related to the radial distribution function (RDF), $g_{ij}(\\mathbf{r})$, by $h_{ij}(\\mathbf{r}) = g_{ij}(\\mathbf{r}) - 1$.\nThe definition of $G_{ij}$ is:\n$$\nG_{ij} = \\int_{\\mathbb{R}^3} h_{ij}(\\mathbf{r}) \\, d\\mathbf{r}\n$$\n\nFor an isotropic system, the correlation functions depend only on the scalar distance $r = |\\mathbf{r}|$, so $g_{ij}(\\mathbf{r}) = g_{ij}(r)$ and $h_{ij}(\\mathbf{r}) = h_{ij}(r)$. This symmetry allows for a significant simplification of the three-dimensional integral by transforming it into spherical coordinates. In spherical coordinates, the differential volume element is $d\\mathbf{r} = r^2 \\sin\\theta \\, dr \\, d\\theta \\, d\\phi$, where $r \\in [0, \\infty)$, $\\theta \\in [0, \\pi]$, and $\\phi \\in [0, 2\\pi]$.\n\nThe integral for $G_{ij}$ can be rewritten as:\n$$\nG_{ij} = \\int_0^\\infty \\int_0^\\pi \\int_0^{2\\pi} h_{ij}(r) \\, r^2 \\sin\\theta \\, d\\phi \\, d\\theta \\, dr\n$$\n\nSince the integrand $h_{ij}(r) r^2$ does not depend on the angular variables $\\theta$ and $\\phi$, we can perform the angular integration separately:\n$$\n\\int_0^{2\\pi} d\\phi = 2\\pi\n$$\n$$\n\\int_0^\\pi \\sin\\theta \\, d\\theta = [-\\cos\\theta]_0^\\pi = (-\\cos(\\pi)) - (-\\cos(0)) = 1 - (-1) = 2\n$$\n\nThe product of the angular integrals is the total solid angle, $4\\pi$. Thus, the $G_{ij}$ integral simplifies to a one-dimensional integral over the radial coordinate $r$:\n$$\nG_{ij} = 4\\pi \\int_0^\\infty h_{ij}(r) \\, r^2 \\, dr = 4\\pi \\int_0^\\infty (g_{ij}(r) - 1) \\, r^2 \\, dr\n$$\n\nIn practical applications, such as analyzing data from molecular dynamics simulations, the RDF is only known up to a finite cutoff distance, $R_{\\max}$. Beyond this cutoff, the correlations are assumed to have vanished, i.e., $g_{ij}(r) = 1$ for $r  R_{\\max}$. This implies $h_{ij}(r) = 0$ for $r  R_{\\max}$, so the integral can be truncated at $R_{\\max}$ without loss of accuracy under this assumption. The numerical estimator, $\\widehat{G}_{ij}$, is therefore based on the definite integral:\n$$\n\\widehat{G}_{ij} = 4\\pi \\int_0^{R_{\\max}} (g_{ij}(r) - 1) \\, r^2 \\, dr\n$$\n\n### Numerical Quadrature\n\nTo compute this integral numerically, we discretize the radial domain $[0, R_{\\max}]$ into a uniform grid defined by points $r_k = k \\Delta r$ for $k = 0, 1, \\dots, N$, where $N = R_{\\max} / \\Delta r$ is an integer. Let the integrand be denoted by $f(r) = 4\\pi (g_{ij}(r) - 1) r^2$, and its value at grid point $r_k$ be $f_k = f(r_k)$. Two numerical quadrature methods are specified:\n\n1.  **Composite Trapezoidal Rule**: This method approximates the integral by summing the areas of trapezoids formed by adjacent grid points. The formula for the integral is:\n    $$\n    \\widehat{G}_{ij} \\approx \\frac{\\Delta r}{2} \\sum_{k=0}^{N-1} (f_k + f_{k+1}) = \\Delta r \\left( \\frac{f_0 + f_N}{2} + \\sum_{k=1}^{N-1} f_k \\right)\n    $$\n\n2.  **Composite Simpson's Rule**: This method provides a more accurate approximation by fitting parabolic segments to adjacent pairs of intervals. It requires an even number of intervals, $N$, which means the total number of grid points, $N+1$, must be odd. The formula is:\n    $$\n    \\widehat{G}_{ij} \\approx \\frac{\\Delta r}{3} [f_0 + 4f_1 + 2f_2 + 4f_3 + \\dots + 2f_{N-2} + 4f_{N-1} + f_N]\n    $$\n\n### Implementation for Unit Testing\n\nThe implementation will compute $\\widehat{G}_{ij}$ for several test cases. For each case, we first construct the radial grid $r_k$ and the RDF values $g_{ij}(r_k)$. In the ideal gas limit, $g_{ij}(r) = 1$ for $r  0$. At $r_0 = 0$, the $r^2$ term in the integrand $f(r)$ ensures that $f(0) = 4\\pi (g_{ij}(0) - 1) \\cdot 0^2 = 0$, making the value of $g_{ij}(0)$ irrelevant. Therefore, with no noise, the integrand $f(r_k)$ is identically $0$ for all $k$, and any correct quadrature implementation should return a result of exactly $0.0$.\n\nFor cases with noise, the RDF is modeled as $g_{ij}(r_k) = 1 + \\epsilon_k$, where $\\epsilon_k$ is a random variable drawn from a Gaussian distribution $\\mathcal{N}(0, \\sigma^2)$. The integrand becomes $f(r_k) = 4\\pi \\epsilon_k r_k^2$. The resulting integral is a weighted sum of random variables. While its expectation value is $0$, any single realization will yield a small, non-zero value. The unit tests verify that this numerical noise remains within a specified tolerance, $\\text{tol}$, by checking if $|\\widehat{G}_{ij}| \\le \\text{tol}$. The provided `numpy` and `scipy` libraries offer robust implementations of these quadrature rules.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.integrate import simpson\n\ndef compute_kb_integral(delta_r: float, r_max: float, quadrature_rule: str, sigma: float, seed: int | None) - float:\n    \"\"\"\n    Computes the Kirkwood-Buff integral for a given set of parameters.\n\n    Args:\n        delta_r: The radial grid spacing in nm.\n        r_max: The cutoff radius for the integration in nm.\n        quadrature_rule: The name of the quadrature rule ('trapezoid' or 'Simpson').\n        sigma: The standard deviation of the Gaussian noise to add to g_ij(r).\n        seed: The random seed for noise generation.\n\n    Returns:\n        The numerically estimated Kirkwood-Buff integral in nm^3.\n    \"\"\"\n    # Ensure N is an integer, as per problem statement\n    if not np.isclose(r_max % delta_r, 0) and not np.isclose(r_max % delta_r, delta_r):\n        raise ValueError(\"r_max must be an integer multiple of delta_r\")\n    N = int(round(r_max / delta_r))\n    \n    num_points = N + 1\n\n    # For Simpson's rule, the number of intervals N must be even,\n    # which means the number of points (N+1) must be odd.\n    if quadrature_rule.lower() == 'simpson' and num_points % 2 == 0:\n        raise ValueError(\"Simpson's rule requires an odd number of grid points (even number of intervals).\")\n\n    # 1. Construct the uniform radial grid from 0 to r_max\n    r = np.linspace(0.0, r_max, num=num_points)\n\n    # 2. Construct the radial distribution function g_ij(r)\n    # In the ideal gas limit, g_ij(r) = 1.\n    g_ij = np.ones_like(r)\n\n    # 3. Add optional mean-zero Gaussian noise\n    if sigma  0:\n        if seed is None:\n            raise ValueError(\"A seed must be provided for noise generation.\")\n        rng = np.random.default_rng(seed)\n        noise = rng.normal(loc=0.0, scale=sigma, size=g_ij.shape)\n        g_ij += noise\n\n    # 4. Calculate the integrand: 4 * pi * (g_ij(r) - 1) * r^2\n    # The term (g_ij - 1) is simply the noise if present, or zero otherwise.\n    total_correlation_h = g_ij - 1.0\n    integrand = 4.0 * np.pi * total_correlation_h * r**2\n\n    # 5. Perform the numerical integration\n    g_kb = 0.0\n    if quadrature_rule.lower() == 'trapezoid':\n        g_kb = np.trapz(integrand, x=r)\n    elif quadrature_rule.lower() == 'simpson':\n        g_kb = simpson(integrand, x=r)\n    else:\n        raise ValueError(f\"Unknown quadrature rule: {quadrature_rule}\")\n\n    return g_kb\n    \n\ndef solve():\n    \"\"\"\n    Runs the unit test suite for the Kirkwood-Buff integral estimator.\n    \"\"\"\n    test_cases = [\n        # Case A: happy path, trapezoid, fine grid, no noise\n        {'delta_r': 0.01, 'r_max': 10.0, 'rule': 'trapezoid', 'sigma': 0.0, 'seed': None, 'tol': 1.0e-12},\n        # Case B: happy path, Simpson, fine grid, no noise\n        {'delta_r': 0.0025, 'r_max': 5.0, 'rule': 'Simpson', 'sigma': 0.0, 'seed': None, 'tol': 1.0e-12},\n        # Case C: noisy, moderate grid\n        {'delta_r': 0.005, 'r_max': 5.0, 'rule': 'trapezoid', 'sigma': 1.0e-7, 'seed': 12345, 'tol': 1.0e-4},\n        # Case D: boundary condition, very coarse grid, no noise\n        {'delta_r': 1.0, 'r_max': 1.0, 'rule': 'trapezoid', 'sigma': 0.0, 'seed': None, 'tol': 1.0e-12},\n        # Case E: small cutoff with noise\n        {'delta_r': 0.01, 'r_max': 0.5, 'rule': 'trapezoid', 'sigma': 1.0e-6, 'seed': 24680, 'tol': 1.0e-6},\n    ]\n\n    results = []\n    for case in test_cases:\n        g_kb_estimate = compute_kb_integral(\n            delta_r=case['delta_r'],\n            r_max=case['r_max'],\n            quadrature_rule=case['rule'],\n            sigma=case['sigma'],\n            seed=case['seed']\n        )\n        \n        # Check if the absolute value of the estimate is within the tolerance\n        test_passed = abs(g_kb_estimate) = case['tol']\n        results.append(test_passed)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "In practice, correlation functions from simulations are only known up to a finite cutoff distance, $R$. Simply truncating the Kirkwood-Buff integral at this distance can introduce significant errors, as long-range correlations may still be present. This practice  addresses this critical issue by introducing analytical tail corrections, a standard technique for improving accuracy. By working with several physically motivated forms of $g_{ij}(r)$, you will learn to combine numerical integration over the known range with an exact analytical integral for the tail, bridging the gap between finite data and the full spatial integral.",
            "id": "3419771",
            "problem": "Consider an isotropic, homogeneous fluid mixture in three spatial dimensions. Let the pair radial distribution function between species $i$ and $j$ be denoted $g_{ij}(r)$, defined such that the expected number of $j$-type particles in a spherical shell of radius $r$ and thickness $\\mathrm{d}r$ around a tagged $i$-type particle equals the product of the bulk number density of species $j$, the shell volume, and $g_{ij}(r)$. Starting only from this definition and geometrical facts about spherical shells in three dimensions, derive the expression for the Kirkwood–Buff integral that quantifies the spatial integral of the total correlation function between $i$ and $j$. Then design a numerical estimator, based on a discretized radial grid, to evaluate this integral from a given $g_{ij}(r)$ sampled on a finite interval $[0,R]$. Your estimator must:\n- Be consistent with spherical symmetry in three dimensions.\n- Use a well-posed Riemann sum approximation on a uniform grid of $r$-values with spacing $\\Delta r$.\n- Address the finite cut-off $R$ by either showing that the tail contribution beyond $R$ is negligible, or by adding a mathematically justified tail correction derived from the asymptotic form of $g_{ij}(r)$ for the specific case.\n\nAll radii are in nanometers (nm). Your program must return the Kirkwood–Buff integral in cubic nanometers (nm$^3$) as floating-point numbers.\n\nImplement a program that constructs $g_{ij}(r)$ for each of the following four test cases on the specified grids, applies your numerical estimator (including exact analytic tail corrections where requested), and outputs the results as a single line containing a comma-separated list enclosed in square brackets.\n\nTest suite:\n- Case A (ideal gas reference): $g_{ij}(r) = 1$ for all $r \\in [0,R]$. Grid: $R = 5.0$ nm, $N = 10000$ uniform intervals, so $\\Delta r = R/N$. No tail correction is needed.\n- Case B (purely decaying correlation): $g_{ij}(r) = 1 + A \\exp(-\\alpha r)$ with $A = 0.5$ and $\\alpha = 3.0$ nm$^{-1}$. Grid: $R = 6.0$ nm, $N = 12000$. Add the exact analytic tail correction for $r \\in (R,\\infty)$ implied by this functional form.\n- Case C (hard-core exclusion): $g_{ij}(r) = 0$ for $0 \\le r  r_{0}$ and $g_{ij}(r) = 1$ for $r \\ge r_{0}$ with $r_{0} = 0.3$ nm. Grid: $R = 5.0$ nm, $N = 10000$. No tail correction is needed.\n- Case D (damped oscillatory correlation): $g_{ij}(r) = 1 + A \\exp(-\\alpha r)\\,\\dfrac{\\sin(\\beta r)}{\\beta r}$ with $A = 0.8$, $\\alpha = 2.0$ nm$^{-1}$, and $\\beta = 5.0$ nm$^{-1}$. At $r=0$, define the value by continuity using the limit of $\\dfrac{\\sin(\\beta r)}{\\beta r}$ as $r \\to 0$. Grid: $R = 8.0$ nm, $N = 16000$. Add the exact analytic tail correction for $r \\in (R,\\infty)$ implied by this functional form.\n\nNumerical requirements:\n- Use the trapezoidal rule on the uniform grid for the integral over $[0,R]$.\n- For Case B, use the exact analytic value of the tail integral $\\int_{R}^{\\infty} \\left(g_{ij}(r) - 1\\right)$ with the given functional form. For Case D, use the exact analytic value of the tail integral derived from the given damped oscillatory form. In both cases, the tail correction must be derived from elementary calculus and complex-exponential representation and then implemented exactly.\n- Express each final result in nm$^3$ as a floating-point number. You must output six digits after the decimal point.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[resultA,resultB,resultC,resultD]\"), where each result corresponds respectively to Case A, Case B, Case C, and Case D, each rounded to six digits after the decimal point.",
            "solution": "The problem requires the derivation of the Kirkwood-Buff integral (KBI), denoted $G_{ij}$, for an isotropic fluid mixture, and the design of a numerical estimator to compute its value for several test cases. The derivation must start from the definition of the pair radial distribution function, $g_{ij}(r)$.\n\n**1. Definition and Derivation of the Kirkwood-Buff Integral**\n\nThe pair radial distribution function $g_{ij}(r)$ describes the probability of finding a particle of species $j$ at a distance $r$ from a particle of species $i$, relative to a uniform random distribution. For large separations $r \\to \\infty$, particles become uncorrelated, so $g_{ij}(r) \\to 1$.\n\nThe total correlation function, $h_{ij}(r)$, quantifies the deviation from this uncorrelated state and is defined as:\n$$ h_{ij}(r) = g_{ij}(r) - 1 $$\nThis function approaches $0$ as $r \\to \\infty$.\n\nThe Kirkwood-Buff integral, $G_{ij}$, is defined as the spatial integral of the total correlation function over all three-dimensional space:\n$$ G_{ij} = \\int_{\\mathbb{R}^3} h_{ij}(\\mathbf{r}) \\, \\mathrm{d}\\mathbf{r} $$\nFor an isotropic system, the correlation function depends only on the radial distance $r = |\\mathbf{r}|$, so we can write $h_{ij}(\\mathbf{r}) = h_{ij}(r)$. To evaluate the integral, we switch to spherical coordinates, where the volume element is $\\mathrm{d}\\mathbf{r} = r^2 \\sin\\theta \\, \\mathrm{d}r \\, \\mathrm{d}\\theta \\, \\mathrm{d}\\phi$. The integral becomes:\n$$ G_{ij} = \\int_0^\\infty \\int_0^\\pi \\int_0^{2\\pi} h_{ij}(r) \\, r^2 \\sin\\theta \\, \\mathrm{d}\\phi \\, \\mathrm{d}\\theta \\, \\mathrm{d}r $$\nSince $h_{ij}(r)$ and $r^2$ do not depend on the angles $\\theta$ and $\\phi$, the angular integrals can be performed separately:\n$$ \\int_0^{2\\pi} \\mathrm{d}\\phi = 2\\pi $$\n$$ \\int_0^\\pi \\sin\\theta \\, \\mathrm{d}\\theta = [-\\cos\\theta]_0^\\pi = -(-1) - (-1) = 2 $$\nThe product of the angular integrals is $4\\pi$, which is the total solid angle of a sphere. Substituting this back gives the final expression for the Kirkwood-Buff integral in terms of the radial functions:\n$$ G_{ij} = 4\\pi \\int_0^\\infty r^2 h_{ij}(r) \\, \\mathrm{d}r = 4\\pi \\int_0^\\infty r^2 (g_{ij}(r) - 1) \\, \\mathrm{d}r $$\n\n**2. Numerical Estimation Strategy**\n\nThe integral is over an infinite domain $[0, \\infty)$. For numerical evaluation from data sampled over a finite interval $[0, R]$, we decompose the integral into two parts:\n$$ G_{ij} = 4\\pi \\left[ \\int_0^R r^2 (g_{ij}(r) - 1) \\, \\mathrm{d}r + \\int_R^\\infty r^2 (g_{ij}(r) - 1) \\, \\mathrm{d}r \\right] $$\nThe first term, $(G_{ij})_\\text{num}$, is evaluated numerically, while the second term, $(G_{ij})_\\text{tail}$, is the tail correction.\n\nThe numerical part is approximated using the trapezoidal rule on a uniform grid. The interval $[0, R]$ is divided into $N$ subintervals of width $\\Delta r = R/N$. The grid points are $r_k = k \\Delta r$ for $k = 0, 1, \\dots, N$. The integrand is $f(r) = 4\\pi r^2 (g_{ij}(r) - 1)$. The integral is approximated as:\n$$ (G_{ij})_\\text{num} = \\int_0^R f(r) \\, \\mathrm{d}r \\approx \\Delta r \\left( \\frac{f(r_0) + f(r_N)}{2} + \\sum_{k=1}^{N-1} f(r_k) \\right) $$\nSince $r_0 = 0$, and $g_{ij}(0)$ is finite, the integrand $f(0) = 4\\pi (0)^2 (g_{ij}(0) - 1) = 0$.\n\nThe tail correction $(G_{ij})_\\text{tail}$ must be evaluated analytically based on the asymptotic form of $g_{ij}(r)$ for $r  R$.\n\n**3. Analysis of Test Cases**\n\n**Case A (Ideal Gas):**\n$g_{ij}(r) = 1$ for all $r$. This implies $h_{ij}(r) = g_{ij}(r) - 1 = 0$ for all $r$.\nTherefore, the integral is identically zero:\n$$ G_{ij} = 4\\pi \\int_0^\\infty r^2 (0) \\, \\mathrm{d}r = 0 \\, \\text{nm}^3 $$\nNo numerical calculation is needed, but a correct implementation must yield $0$.\n\n**Case B (Purely Decaying Correlation):**\n$g_{ij}(r) = 1 + A \\exp(-\\alpha r)$, with $A = 0.5$ and $\\alpha = 3.0 \\, \\text{nm}^{-1}$.\n$h_{ij}(r) = A \\exp(-\\alpha r)$. The numerical part is computed using the trapezoidal rule for the integral of $4\\pi r^2 A \\exp(-\\alpha r)$ from $r=0$ to $r=R=6.0 \\, \\text{nm}$.\nThe tail correction is:\n$$ (G_{ij})_\\text{tail} = 4\\pi A \\int_R^\\infty r^2 \\exp(-\\alpha r) \\, \\mathrm{d}r $$\nThis integral can be solved by repeated integration by parts, yielding:\n$$ \\int_R^\\infty r^2 e^{-\\alpha r} \\mathrm{d}r = \\left[ -e^{-\\alpha r} \\left( \\frac{r^2}{\\alpha} + \\frac{2r}{\\alpha^2} + \\frac{2}{\\alpha^3} \\right) \\right]_R^\\infty = e^{-\\alpha R} \\left( \\frac{R^2}{\\alpha} + \\frac{2R}{\\alpha^2} + \\frac{2}{\\alpha^3} \\right) $$\nThus, the tail contribution is:\n$$ (G_{ij})_\\text{tail} = 4\\pi A e^{-\\alpha R} \\left( \\frac{R^2}{\\alpha} + \\frac{2R}{\\alpha^2} + \\frac{2}{\\alpha^3} \\right) $$\n\n**Case C (Hard-Core Exclusion):**\n$g_{ij}(r) = 0$ for $r  r_0 = 0.3 \\, \\text{nm}$ and $g_{ij}(r) = 1$ for $r \\ge r_0$.\n$h_{ij}(r) = -1$ for $r  r_0$ and $h_{ij}(r) = 0$ for $r \\ge r_0$.\nSince the cutoff for the numerical grid is $R = 5.0 \\, \\text{nm}  r_0$, the correlation function $h_{ij}(r)$ is identically zero for $r  R$. Therefore, the tail correction is zero. The exact value of the integral is:\n$$ G_{ij} = 4\\pi \\int_0^{r_0} r^2 (-1) \\, \\mathrm{d}r = -4\\pi \\left[ \\frac{r^3}{3} \\right]_0^{r_0} = -\\frac{4}{3}\\pi r_0^3 $$\nFor $r_0 = 0.3 \\, \\text{nm}$, $G_{ij} = -\\frac{4}{3}\\pi (0.3)^3 = -0.036\\pi \\approx -0.113097 \\, \\text{nm}^3$. The numerical method should accurately approximate this value.\n\n**Case D (Damped Oscillatory Correlation):**\n$g_{ij}(r) = 1 + A \\exp(-\\alpha r)\\,\\dfrac{\\sin(\\beta r)}{\\beta r}$, with $A = 0.8$, $\\alpha = 2.0 \\, \\text{nm}^{-1}$, $\\beta = 5.0 \\, \\text{nm}^{-1}$.\n$h_{ij}(r) = A \\exp(-\\alpha r)\\,\\dfrac{\\sin(\\beta r)}{\\beta r}$. The numerical part is computed for the integrand $f(r) = 4\\pi r^2 h_{ij}(r) = \\frac{4\\pi A}{\\beta} r \\sin(\\beta r) \\exp(-\\alpha r)$ from $r=0$ to $r=R=8.0 \\, \\text{nm}$.\nAt $r=0$, the value is defined by continuity: $\\lim_{r\\to 0} \\frac{\\sin(\\beta r)}{\\beta r} = 1$, so $g_{ij}(0) = 1+A$. The integrand $f(0)$ is $0$.\nThe tail correction is:\n$$ (G_{ij})_\\text{tail} = \\int_R^\\infty \\frac{4\\pi A}{\\beta} r \\sin(\\beta r) \\exp(-\\alpha r) \\, \\mathrm{d}r $$\nThis integral is evaluated using complex exponentials. Let $\\sin(\\beta r) = \\text{Im}(e^{i\\beta r})$. We need to compute $\\text{Im} \\left[ \\int_R^\\infty r e^{-(\\alpha-i\\beta)r} \\, \\mathrm{d}r \\right]$. The primitive is $\\int r e^{-\\gamma r} \\mathrm{d}r = -e^{-\\gamma r}(\\frac{r}{\\gamma} + \\frac{1}{\\gamma^2})$.\nThe definite integral from $R$ to $\\infty$ is $e^{-\\gamma R}(\\frac{R}{\\gamma} + \\frac{1}{\\gamma^2})$.\nTaking the imaginary part of the result with $\\gamma = \\alpha - i\\beta$ leads to the following expression for the integral part:\n$$ \\int_R^\\infty r e^{-\\alpha r} \\sin(\\beta r) \\mathrm{d}r = \\frac{e^{-\\alpha R}}{(\\alpha^2+\\beta^2)^2} \\left[ (R\\alpha(\\alpha^2+\\beta^2) + \\alpha^2-\\beta^2)\\sin(\\beta R) + (R\\beta(\\alpha^2+\\beta^2) + 2\\alpha\\beta)\\cos(\\beta R) \\right] $$\nThe total tail contribution is $(G_{ij})_\\text{tail} = \\frac{4\\pi A}{\\beta}$ times this expression.\nThe final $G_{ij}$ is the sum of the numerical integral over $[0, R]$ and this analytical tail correction.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Calculates the Kirkwood-Buff integral for four test cases\n    using numerical integration and analytical tail corrections.\n    \"\"\"\n\n    test_cases = [\n        {'case': 'A', 'R': 5.0, 'N': 10000},\n        {'case': 'B', 'R': 6.0, 'N': 12000, 'A': 0.5, 'alpha': 3.0},\n        {'case': 'C', 'R': 5.0, 'N': 10000, 'r0': 0.3},\n        {'case': 'D', 'R': 8.0, 'N': 16000, 'A': 0.8, 'alpha': 2.0, 'beta': 5.0},\n    ]\n\n    results = []\n    \n    for params in test_cases:\n        case = params['case']\n        R = params['R']\n        N = params['N']\n\n        r_grid = np.linspace(0, R, N + 1)\n        g_ij = np.zeros_like(r_grid)\n\n        tail_correction = 0.0\n\n        if case == 'A':\n            # g_ij(r) = 1, so h_ij(r) = 0 everywhere.\n            g_ij.fill(1.0)\n            \n        elif case == 'B':\n            A = params['A']\n            alpha = params['alpha']\n            \n            g_ij = 1.0 + A * np.exp(-alpha * r_grid)\n\n            # Analytical tail correction for G_ij = 4*pi*Integral[r^2*A*exp(-alpha*r), {r, R, inf}]\n            # Integral part is exp(-alpha*R) * (R^2/alpha + 2*R/alpha^2 + 2/alpha^3)\n            exp_term = np.exp(-alpha * R)\n            poly_term = (R**2 / alpha) + (2 * R / alpha**2) + (2 / alpha**3)\n            tail_correction = 4.0 * np.pi * A * exp_term * poly_term\n\n        elif case == 'C':\n            r0 = params['r0']\n            g_ij = np.where(r_grid  r0, 0.0, 1.0)\n            # No tail correction needed as h_ij(r) = 0 for r = r0, and R  r0.\n            \n        elif case == 'D':\n            A = params['A']\n            alpha = params['alpha']\n            beta = params['beta']\n            \n            # handle r=0 by continuity, where sin(beta*r)/(beta*r) - 1\n            g_ij[0] = 1.0 + A\n            # for r  0\n            r_positive = r_grid[1:]\n            g_ij[1:] = 1.0 + A * np.exp(-alpha * r_positive) * np.sin(beta * r_positive) / (beta * r_positive)\n\n            # Analytical tail correction for G_ij = Integral[4*pi*r^2 * h_ij(r), {r, R, inf}]\n            # h_ij(r) = A * exp(-alpha*r) * sin(beta*r)/(beta*r)\n            # Integrand for tail is (4*pi*A/beta) * r * exp(-alpha*r) * sin(beta*r)\n            exp_R = np.exp(-alpha * R)\n            sin_R = np.sin(beta * R)\n            cos_R = np.cos(beta * R)\n            alpha2_beta2 = alpha**2 + beta**2\n            \n            term1_sin = (R * alpha * alpha2_beta2 + alpha**2 - beta**2) * sin_R\n            term2_cos = (R * beta * alpha2_beta2 + 2 * alpha * beta) * cos_R\n            \n            integral_part = exp_R * (term1_sin + term2_cos) / (alpha2_beta2**2)\n            \n            tail_correction = (4.0 * np.pi * A / beta) * integral_part\n\n        # Integrand for the numerical part\n        h_ij = g_ij - 1.0\n        integrand = 4.0 * np.pi * r_grid**2 * h_ij\n        \n        # Numerical integration using the trapezoidal rule\n        numerical_integral = np.trapz(integrand, r_grid)\n\n        total_g_ij = numerical_integral + tail_correction\n        results.append(f\"{total_g_ij:.6f}\")\n\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Transitioning from idealized functional forms to noisy data from molecular dynamics simulations requires a comprehensive and robust workflow. This final exercise  challenges you to synthesize the previous concepts into a complete computational protocol. You will evaluate different proposed methods to identify the one that correctly handles statistical uncertainty, finite-size artifacts, and the practical necessity of fitting the long-range tail of $h_{ij}(r)$ to a physically appropriate asymptotic model. Mastering this protocol is key to producing reliable and defensible Kirkwood-Buff integrals from simulation data.",
            "id": "3419796",
            "problem": "A binary isotropic liquid mixture of species $i$ and $j$ is simulated using Molecular Dynamics (MD) in a cubic box of side $L$ with Periodic Boundary Conditions (PBC). The species number densities are $\\rho_i$ and $\\rho_j$ and the total number density is $\\rho=\\sum_\\alpha \\rho_\\alpha$. The pair distribution function $g_{ij}(r)$ is estimated from the trajectory by histogramming interparticle distances under PBC, and the total correlation function is $h_{ij}(r)=g_{ij}(r)-1$. In the regime of large separation $r$, the liquid is observed to exhibit Ornstein–Zernike asymptotics with damped oscillations, which can be represented as\n$$\nh_{ij}(r)\\approx \\frac{A_{ij}}{r}\\,\\mathrm{e}^{-r/\\xi}\\cos\\!\\big(k_0 r-\\delta_{ij}\\big)\\quad \\text{for } r\\gtrsim r_f,\n$$\nwhere $A_{ij}$, $\\xi$, $k_0$, and $\\delta_{ij}$ are parameters to be estimated from the simulation data by fitting $h_{ij}(r)$ over a range $[r_f,R]$ at sufficiently large $r$. The goal is to estimate the Kirkwood–Buff integrals $G_{ij}$ for the mixture from the simulation, using an approach that is based on estimating $g_{ij}(r)$, integrating $h_{ij}(r)$ up to a cutoff $R$, and adding a tail correction informed by the asymptotic form of $h_{ij}(r)$.\n\nWhich of the following protocols most correctly implements this approach to produce an asymptotically unbiased estimate of $G_{ij}$ in the thermodynamic limit, while respecting PBC, controlling finite-size effects, and providing a defensible uncertainty estimate?\n\nA. Compute $g_{ij}(r)$ using minimum-image distances and normalize by $4\\pi r^2 \\rho_j \\Delta r$. Choose $R=L/2$ and numerically integrate $h_{ij}(r)$ up to $R$ with no tail correction because PBC imply $h_{ij}(r)=0$ beyond $L/2$. Estimate uncertainties by a single standard error from the full trajectory.\n\nB. Partition the trajectory into statistically independent blocks. For each block, compute $g_{ij}(r)$ using PBC with shell-volume and species-density normalization so that $g_{ij}(r)\\to 1$ as $r\\to \\infty$ within statistical error, and verify this on the largest accessible $r$. Choose a cutoff $RL/2$ where $h_{ij}(r)$ is still accurately sampled, and a fitting threshold $r_f$ with $r_fR$. Fit $h_{ij}(r)$ on $[r_f,R]$ to the functional form $\\frac{A_{ij}}{r}\\mathrm{e}^{-r/\\xi}\\cos(k_0 r-\\delta_{ij})$. For each block, compute the partial integral of $h_{ij}(r)$ up to $R$ and add an analytic tail correction obtained by integrating the fitted asymptotic form from $R$ to $\\infty$. Aggregate the block-wise estimates to obtain the mean and uncertainty, test stability with respect to $R$ and $r_f$, and validate the result by checking thermodynamic consistency against an independent estimate of the isothermal compressibility via the Kirkwood–Buff matrix relations without altering $g_{ij}(r)$.\n\nC. Compute $g_{ij}(r)$ and obtain the partial structure factors by a discrete Fourier transform. Extrapolate the partial structure factors to wavenumber $k\\to 0$ using a Hanning window and a quadratic fit in $k^2$; identify $G_{ij}$ with the $k\\to 0$ limit without real-space integration or tail fitting. No constraints on $R$ relative to $L$ are needed because the window mitigates PBC artifacts.\n\nD. Compute $g_{ij}(r)$ as in option A but apply a tail correction based on the attractive dispersion potential, assuming $h_{ij}(r)\\sim -C_6 r^{-6}$ at large $r$ with $C_6$ taken from the Lennard–Jones parameters. Integrate $h_{ij}(r)$ up to $R=L/2$ and add the analytic integral of $-C_6 r^{-6}$ from $R$ to $\\infty$. Uncertainties are estimated from the fit residuals.\n\nE. Avoid $g_{ij}(r)$ entirely and instead compute $G_{ij}$ from the covariance of instantaneous particle numbers of species $i$ and $j$ in spherical subvolumes of radius $R$ cut from the periodic box. Extrapolate the subvolume covariance to the infinite-radius limit by fitting a polynomial in $1/R$; declare the extrapolated value as $G_{ij}$ and ignore any ensemble dependence.\n\nSelect the single best option.",
            "solution": "We begin from core definitions. The pair distribution function $g_{ij}(r)$ for an isotropic mixture relates the two-body density $\\rho^{(2)}_{ij}(\\mathbf{r}_1,\\mathbf{r}_2)$ to the product of one-body densities by\n$$\n\\rho^{(2)}_{ij}(\\mathbf{r}_1,\\mathbf{r}_2) = \\rho_i \\rho_j g_{ij}(|\\mathbf{r}_1-\\mathbf{r}_2|),\n$$\nand the total correlation function is $h_{ij}(r)=g_{ij}(r)-1$. In the Kirkwood–Buff (KB) framework, defined most transparently in the grand-canonical ensemble, the Kirkwood–Buff integrals $G_{ij}$ quantify integrals over total correlation functions. For an isotropic fluid, using spherical symmetry and the definition of $h_{ij}(r)$, one obtains\n$$\nG_{ij} = \\int_{\\mathbb{R}^3} h_{ij}(|\\mathbf{r}|)\\,\\mathrm{d}\\mathbf{r} = 4\\pi \\int_{0}^{\\infty} r^2 h_{ij}(r)\\,\\mathrm{d}r.\n$$\nThis follows directly from the volume integral in spherical coordinates applied to an isotropic scalar function. The $G_{ij}$ enter thermodynamic fluctuation relations linking composition derivatives of chemical potentials and macroscopic response functions such as the isothermal compressibility. In practice, MD simulations often sample $g_{ij}(r)$ in a canonical ensemble with PBC, requiring careful handling of finite-size and long-range contributions.\n\nBecause PBC restrict reliable pair distances to $rL/2$ and $h_{ij}(r)$ decays slowly enough that the integral weight $r^2 h_{ij}(r)$ can have non-negligible contribution from large $r$, a practical estimator for $G_{ij}$ separates the integral into a numerically integrated part up to a cutoff $R$ and a tail beyond $R$:\n$$\nG_{ij} \\approx 4\\pi \\int_{0}^{R} r^2 h_{ij}(r)\\,\\mathrm{d}r \\;+\\; 4\\pi \\int_{R}^{\\infty} r^2 h_{ij}(r)\\,\\mathrm{d}r,\n$$\nwith $RL/2$. To evaluate the tail, one invokes the Ornstein–Zernike asymptotic form observed in liquids,\n$$\nh_{ij}(r)\\approx \\frac{A_{ij}}{r}\\,\\mathrm{e}^{-r/\\xi}\\cos\\!\\big(k_0 r-\\delta_{ij}\\big)\\quad\\text{for large } r,\n$$\nwhich encapsulates exponential damping with correlation length $\\xi$, oscillations at a wavenumber $k_0$, and an algebraic $1/r$ factor. Fitting this form on an interval $[r_f,R]$ where the sampled $h_{ij}(r)$ has entered the asymptotic regime allows analytic evaluation of the tail integral.\n\nTo derive the analytic tail correction, define $\\alpha = \\xi^{-1}-\\mathrm{i}k_0$ and write the cosine as a real part: $\\cos(k_0 r-\\delta_{ij})=\\Re\\{\\mathrm{e}^{-\\mathrm{i}\\delta_{ij}}\\mathrm{e}^{\\mathrm{i}k_0 r}\\}$. Then\n$$\n\\int_{R}^{\\infty} r^2 h_{ij}(r)\\,\\mathrm{d}r \\approx A_{ij}\\,\\Re\\!\\left\\{\\mathrm{e}^{-\\mathrm{i}\\delta_{ij}}\\int_{R}^{\\infty} r\\,\\mathrm{e}^{-(\\xi^{-1}-\\mathrm{i}k_0)r}\\,\\mathrm{d}r\\right\\}.\n$$\nThe inner integral is elementary. For any complex $\\alpha$ with $\\Re(\\alpha)0$,\n$$\n\\int_{R}^{\\infty} r\\,\\mathrm{e}^{-\\alpha r}\\,\\mathrm{d}r = \\frac{\\mathrm{e}^{-\\alpha R}}{\\alpha^2}\\left(1+\\alpha R\\right).\n$$\nTherefore, the tail contribution to $G_{ij}$ is\n$$\nG_{ij}^{\\mathrm{tail}}(R) \\approx 4\\pi A_{ij}\\,\\Re\\!\\left\\{\\mathrm{e}^{-\\mathrm{i}\\delta_{ij}}\\,\\frac{\\mathrm{e}^{-(\\xi^{-1}-\\mathrm{i}k_0)R}}{(\\xi^{-1}-\\mathrm{i}k_0)^2}\\left[1+(\\xi^{-1}-\\mathrm{i}k_0)R\\right]\\right\\}.\n$$\nIn practice, one evaluates this expression using the fitted $(A_{ij},\\xi,k_0,\\delta_{ij})$ and adds it to the numerical quadrature of $4\\pi r^2 h_{ij}(r)$ over $[0,R]$. Robustness requires checking insensitivity of $G_{ij}$ to reasonable variations of $R$ and $r_f$, proper normalization of $g_{ij}(r)$ so that $g_{ij}(r)\\to 1$ at the largest sampled $r$, and uncertainty quantification via block analysis. Additional validation is achieved by comparing the resulting $G_{ij}$ matrix with independent macroscopic quantities (for example, isothermal compressibility) through established Kirkwood–Buff relations, recognizing possible ensemble differences between canonical MD and grand-canonical theory but not retroactively forcing $g_{ij}(r)$ to meet a constraint.\n\nWe now assess each option:\n\nOption A. It proposes integrating up to $R=L/2$ with no tail, asserting that PBC imply $h_{ij}(r)=0$ beyond $L/2$. This is incorrect. PBC limit the maximum unique separation to $L/2$ but do not enforce $h_{ij}(r)$ to vanish at that distance. Neglecting the tail introduces a bias that decays slowly with system size, especially because the integrand includes $r^2 h_{ij}(r)$. Moreover, using the full trajectory without blocking underestimates statistical uncertainty due to time correlations. Verdict: Incorrect.\n\nOption B. This protocol includes: (i) block averaging for uncertainty; (ii) correct PBC-aware histogramming and normalization ensuring $g_{ij}(r)\\to 1$ at large $r$; (iii) choice of $RL/2$ and a separate $r_fR$ to identify the asymptotic regime; (iv) fitting $h_{ij}(r)$ to the damped oscillatory Ornstein–Zernike form with the $1/r$ factor; (v) computing the numerical integral up to $R$ and adding an analytic tail based on the fitted asymptotic, as derived above; (vi) testing stability with respect to $R$ and $r_f$; and (vii) validating against thermodynamic consistency without altering $g_{ij}(r)$. This implements the stated approach and addresses finite-size and uncertainty properly. Verdict: Correct.\n\nOption C. Small-$k$ extrapolation of partial structure factors is a legitimate alternative route to $G_{ij}$ via $k\\to 0$ limits, but it is not the real-space integration plus asymptotic-tail protocol described. Furthermore, windowing does not obviate PBC-induced finite-size artifacts; careful finite-size and discretization analysis is still required. As the question asks for the protocol that implements the specified approach, this is not it. Verdict: Incorrect in context.\n\nOption D. Assuming a $-C_6 r^{-6}$ tail for $h_{ij}(r)$ conflates the dispersion potential with the asymptotic decay of correlations in dense liquids. In typical liquids, $h_{ij}(r)$ decays as a damped oscillatory function with exponential damping and an algebraic prefactor, not as a pure $r^{-6}$ potential tail. Using a $r^{-6}$ tail for $h_{ij}(r)$ generally produces a biased estimate. Verdict: Incorrect.\n\nOption E. Estimating $G_{ij}$ from number fluctuations in finite subvolumes and extrapolating with a polynomial in $1/R$ ignores known boundary and ensemble effects; without a theoretically justified extrapolation form and ensemble corrections, this approach is biased. It also does not follow the required real-space integration plus asymptotic-tail correction protocol. Verdict: Incorrect.\n\nTherefore, the only option that correctly implements the stated approach with appropriate controls is option B.",
            "answer": "$$\\boxed{B}$$"
        }
    ]
}