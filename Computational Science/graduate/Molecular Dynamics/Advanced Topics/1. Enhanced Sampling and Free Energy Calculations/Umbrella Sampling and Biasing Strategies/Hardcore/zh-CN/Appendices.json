{
    "hands_on_practices": [
        {
            "introduction": "伞形采样中的偏置势并不仅仅是数学上的抽象概念，它在分子动力学模拟中会转化为作用在原子上的具体作用力。这项练习将引导你完成一个基础但至关重要的计算，将谐波偏置势能的表达式与驱动模拟沿着反应坐标移动的原子间作用力直接联系起来。通过这种方式，你可以更直观地理解偏置策略在原子尺度上的物理实现。",
            "id": "3458759",
            "problem": "在分子动力学 (MD) 的伞形采样模拟中，对一个定义为两个标记为 $1$ 和 $2$ 的原子间距离的集体变量 (CV) $s = |\\mathbf{r}_{1} - \\mathbf{r}_{2}|$ 施加偏置。该偏置势是简谐的，其劲度系数为 $k = 50\\,\\mathrm{kcal\\,mol^{-1}\\,Å^{-2}}$，中心为 $s_{0} = 5\\,\\mathrm{Å}$。在温度 $T = 300\\,\\mathrm{K}$ 时，CV 的瞬时值为 $s = 6\\,\\mathrm{Å}$。利用力与势梯度相关的基本定义以及链式法则，首先确定在该 $s$ 值下作用于 CV 的偏置力的大小。然后，利用 $s$ 相对于原子位置的梯度，将此 CV 力转换为作用于原子 $1$ 和原子 $2$ 的原子力。用 $\\boldsymbol{e}_{12}$ 表示从原子 $2$ 指向原子 $1$ 的单位矢量，即 $\\boldsymbol{e}_{12} = (\\mathbf{r}_{1} - \\mathbf{r}_{2})/|\\mathbf{r}_{1} - \\mathbf{r}_{2}|$。将最终答案表示为包含三个条目的单行：CV 偏置力的标量大小，其后分别是作用于原子 $1$ 的矢量原子力和作用于原子 $2$ 的矢量原子力。以 $\\mathrm{kcal\\,mol^{-1}\\,Å^{-1}}$ 为单位报告力的大小。将标量大小和乘以 $\\boldsymbol{e}_{12}$ 的数值系数四舍五入至四位有效数字。按指定顺序将最终答案表述为单个解析表达式。",
            "solution": "该问题是有效的，因为它具有科学依据，提法明确且客观。它描述了计算化学和分子动力学中的一个标准情景，使用了经典力学的基本原理。所有必要的数据都已提供，且没有矛盾之处。\n\n集体变量 (CV) 定义为原子 $1$ 和 $2$ 之间的距离，$s = |\\mathbf{r}_{1} - \\mathbf{r}_{2}|$。系统受到一个以 $s_{0} = 5\\,\\mathrm{Å}$ 为中心的简谐偏置势的作用，其力常数为 $k = 50\\,\\mathrm{kcal\\,mol^{-1}\\,Å^{-2}}$。该势能的形式为：\n$$V_{bias}(s) = \\frac{1}{2} k (s - s_0)^2$$\nCV 的瞬时值给定为 $s = 6\\,\\mathrm{Å}$。温度 $T = 300\\,\\mathrm{K}$ 是分子动力学模拟中典型的背景信息，但对于从保守势计算瞬时机械力而言并非必需。\n\n首先，我们确定沿集体变量作用的力 $F_s$。这个力是偏置势对 CV $s$ 的负导数：\n$$F_s = -\\frac{dV_{bias}(s)}{ds}$$\n代入简谐势的表达式，我们得到：\n$$F_s = -\\frac{d}{ds} \\left[ \\frac{1}{2} k (s - s_0)^2 \\right] = -k (s - s_0)$$\n现在，我们代入给定的数值：$k = 50\\,\\mathrm{kcal\\,mol^{-1}\\,Å^{-2}}$，$s_0 = 5\\,\\mathrm{Å}$，以及 $s = 6\\,\\mathrm{Å}$。\n$$F_s = -(50\\,\\mathrm{kcal\\,mol^{-1}\\,Å^{-2}}) (6\\,\\mathrm{Å} - 5\\,\\mathrm{Å}) = -(50\\,\\mathrm{kcal\\,mol^{-1}\\,Å^{-2}}) (1\\,\\mathrm{Å})$$\n$$F_s = -50\\,\\mathrm{kcal\\,mol^{-1}\\,Å^{-1}}$$\n问题要求这个力的大小，即：\n$$|F_s| = |-50\\,\\mathrm{kcal\\,mol^{-1}\\,Å^{-1}}| = 50\\,\\mathrm{kcal\\,mol^{-1}\\,Å^{-1}}$$\n按要求四舍五入到四位有效数字，其大小为 $50.00\\,\\mathrm{kcal\\,mol^{-1}\\,Å^{-1}}$。\n\n接下来，我们将 CV 上的这个标量力转换为作用于单个原子 $\\mathbf{F}_1$ 和 $\\mathbf{F}_2$ 的矢量力。由偏置势引起的对原子 $i$ 的力是势能对该原子坐标矢量 $\\mathbf{r}_i$ 的负梯度：\n$$\\mathbf{F}_i = -\\nabla_{\\mathbf{r}_i} V_{bias}(s(\\mathbf{r}_1, \\mathbf{r}_2))$$\n使用链式法则，这可以表示为：\n$$\\mathbf{F}_i = \\left(-\\frac{dV_{bias}}{ds}\\right) (\\nabla_{\\mathbf{r}_i} s) = F_s (\\nabla_{\\mathbf{r}_i} s)$$\n我们需要计算 CV $s = |\\mathbf{r}_1 - \\mathbf{r}_2|$ 相对于 $\\mathbf{r}_1$ 和 $\\mathbf{r}_2$ 的梯度。\n对于原子 $1$：\n$$\\nabla_{\\mathbf{r}_1} s = \\nabla_{\\mathbf{r}_1} |\\mathbf{r}_1 - \\mathbf{r}_2| = \\frac{\\mathbf{r}_1 - \\mathbf{r}_2}{|\\mathbf{r}_1 - \\mathbf{r}_2|}$$\n这是问题描述中提供的单位矢量 $\\boldsymbol{e}_{12}$ 的定义。\n$$\\nabla_{\\mathbf{r}_1} s = \\boldsymbol{e}_{12}$$\n对于原子 $2$：\n$$\\nabla_{\\mathbf{r}_2} s = \\nabla_{\\mathbf{r}_2} |\\mathbf{r}_1 - \\mathbf{r}_2| = -\\frac{\\mathbf{r}_1 - \\mathbf{r}_2}{|\\mathbf{r}_1 - \\mathbf{r}_2|} = -\\boldsymbol{e}_{12}$$\n现在，我们可以写出原子力的表达式：\n$$\\mathbf{F}_1 = F_s (\\nabla_{\\mathbf{r}_1} s) = F_s \\boldsymbol{e}_{12}$$\n$$\\mathbf{F}_2 = F_s (\\nabla_{\\mathbf{r}_2} s) = -F_s \\boldsymbol{e}_{12}$$\n值得注意的是，$\\mathbf{F}_1 + \\mathbf{F}_2 = \\mathbf{0}$，这与 Newton 第三定律关于内力的描述一致，确保没有净力作用于双原子系统的质心。\n\n代入计算出的值 $F_s = -50\\,\\mathrm{kcal\\,mol^{-1}\\,Å^{-1}}$：\n$$\\mathbf{F}_1 = (-50\\,\\mathrm{kcal\\,mol^{-1}\\,Å^{-1}}) \\boldsymbol{e}_{12}$$\n$$\\mathbf{F}_2 = -(-50\\,\\mathrm{kcal\\,mol^{-1}\\,Å^{-1}}) \\boldsymbol{e}_{12} = (50\\,\\mathrm{kcal\\,mol^{-1}\\,Å^{-1}}) \\boldsymbol{e}_{12}$$\n$F_s$ 的负号表示一个恢复力，因为距离 $s=6\\,\\mathrm{Å}$ 大于势能最小值 $s_0=5\\,\\mathrm{Å}$。力 $\\mathbf{F}_1$ 指向与 $\\boldsymbol{e}_{12}$ 相反的方向（从原子 $1$ 指向原子 $2$），力 $\\mathbf{F}_2$ 指向 $\\boldsymbol{e}_{12}$ 的方向（从原子 $2$ 指向原子 $1$），从而将两个原子拉近。\n\n将数值系数四舍五入到四位有效数字，我们得到：\nCV 上的力的大小为 $50.00\\,\\mathrm{kcal\\,mol^{-1}\\,Å^{-1}}$。\n作用于原子 $1$ 的力为 $\\mathbf{F}_1 = -50.00\\,\\boldsymbol{e}_{12}\\,\\mathrm{kcal\\,mol^{-1}\\,Å^{-1}}$。\n作用于原子 $2$ 的力为 $\\mathbf{F}_2 = 50.00\\,\\boldsymbol{e}_{12}\\,\\mathrm{kcal\\,mol^{-1}\\,Å^{-1}}$。\n\n最终答案要求将这三个量以指定的顺序放在一个单行矩阵中，并且不带单位。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n50.00 & -50.00 \\, \\boldsymbol{e}_{12} & 50.00 \\, \\boldsymbol{e}_{12}\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "在理解了单个伞形窗口的工作原理后，下一个实际挑战是如何设计整个系列模拟。这项练习聚焦于一个关键的实践问题：如何确定相邻窗口之间的最佳间距，以确保采样数据有足够的统计重叠。充分的重叠对于使用加权直方图分析方法（WHAM）等技术准确地重构整个自由能曲线至关重要。",
            "id": "3458824",
            "problem": "在采用伞形采样 (US) 的分子动力学 (MD) 模拟中，考虑一个一维反应坐标 $s$，该坐标由中心位于 $\\{s_{0}^{(i)}\\}$ 处、具有相同力常数 $k$ 的一系列相同谐波伞形势进行偏置。系统处于温度为 $T$ 的正则系综中。假设每个窗口沿 $s$ 的采样直方图可以很好地近似为由其谐波偏置确定的平衡概率密度函数 (PDF)，并将两个相邻窗口 $i$ 和 $i+1$ 之间的直方图重叠定义为重叠系数（即两个 PDF 逐点最小值的积分）。从具有 Boltzmann 权重和和谐波偏置结构的正则系综出发，推导单个窗口中分布的标准差 $\\sigma$ 以及相邻窗口中心之间允许的最大间距 $d_{\\max}$，该间距需保证相邻窗口直方图之间的重叠系数至少为 $0.3$。然后，确定当所有中心以 $d \\le d_{\\max}$ 的等间距排列时，完全覆盖区间 $s \\in [3,10]\\,\\mathrm{Å}$ 所需的最小窗口数 $N$。\n\n使用温度 $T = 300\\,\\mathrm{K}$，力常数 $k = 20\\,\\mathrm{kcal\\,mol^{-1}\\,Å^{-2}}$，以及每摩尔 Boltzmann 常数 $k_{B} = 1.9872041 \\times 10^{-3}\\,\\mathrm{kcal\\,mol^{-1}\\,K^{-1}}$。以 $\\mathrm{Å}$ 为单位表示标准差 $\\sigma$，并将其四舍五入至三位有效数字。将窗口数 $N$ 报告为满足重叠标准的最小整数。最终答案必须是按所述顺序写成行矩阵的有序对 $\\big(\\sigma, N\\big)$。",
            "solution": "根据指定标准，该问题被评估为有效。它在科学上基于统计力学和分子动力学的原理，问题设定良好，目标明确，信息充分，并且没有任何不合格的缺陷。我现在开始解答。\n\n问题要求计算单个伞形窗口中采样分布的标准差 $\\sigma$，以及在反应坐标 $s$ 上覆盖指定区间所需的最小窗口数 $N$。\n\n首先，我们确定标准差 $\\sigma$。系统处于温度为 $T$ 的正则系综中。中心位于 $s_{0}^{(i)}$ 的单个伞形窗口 $i$ 的偏置势由以下谐波函数给出：\n$$\nU_{\\text{bias}}^{(i)}(s) = \\frac{1}{2} k \\left(s - s_{0}^{(i)}\\right)^2\n$$\n其中 $k$ 是力常数。沿反应坐标的总势能是无偏势（平均力势，PMF）$U_{0}(s)$ 和偏置势 $U(s) = U_{0}(s) + U_{\\text{bias}}^{(i)}(s)$ 之和。\n\n在此偏置窗口中，于坐标 $s$ 处观察到系统的平衡概率密度函数 (PDF) 由 Boltzmann 分布给出：\n$$\nP_{i}(s) \\propto \\exp\\left(-\\frac{U(s)}{k_{B} T}\\right) = \\exp\\left(-\\frac{U_{0}(s) + \\frac{1}{2} k \\left(s - s_{0}^{(i)}\\right)^2}{k_{B} T}\\right)\n$$\n其中 $k_B$ 是 Boltzmann 常数。问题陈述中指出，我们可以假设采样直方图可以很好地近似为仅由谐波偏置决定的 PDF。这意味着在单个窗口采样的狭窄区域内，底层的 PMF $U_{0}(s)$ 可以被视为近似恒定。在这个标准近似下，$U_0(s) \\approx C$，PDF 简化为：\n$$\nP_{i}(s) \\propto \\exp\\left(-\\frac{k \\left(s - s_{0}^{(i)}\\right)^2}{2 k_{B} T}\\right)\n$$\n这是高斯（正态）分布的函数形式。一个标准的高斯 PDF 写为：\n$$\nf(s; \\mu, \\sigma^2) = \\frac{1}{\\sigma\\sqrt{2\\pi}} \\exp\\left(-\\frac{(s-\\mu)^2}{2\\sigma^2}\\right)\n$$\n通过比较 $P_i(s)$ 和 $f(s; \\mu, \\sigma^2)$ 的指数部分，我们可以确定均值 $\\mu = s_{0}^{(i)}$ 和方差 $\\sigma^2$。\n$$\n\\frac{\\left(s - s_{0}^{(i)}\\right)^2}{2 \\sigma^2} = \\frac{k \\left(s - s_{0}^{(i)}\\right)^2}{2 k_{B} T}\n$$\n这个等式意味着：\n$$\n\\frac{1}{\\sigma^2} = \\frac{k}{k_{B} T} \\quad \\implies \\quad \\sigma^2 = \\frac{k_{B} T}{k}\n$$\n因此，标准差 $\\sigma$ 为：\n$$\n\\sigma = \\sqrt{\\frac{k_{B} T}{k}}\n$$\n给定数值 $T = 300\\,\\mathrm{K}$，$k = 20\\,\\mathrm{kcal\\,mol^{-1}\\,Å^{-2}}$ 和 $k_{B} = 1.9872041 \\times 10^{-3}\\,\\mathrm{kcal\\,mol^{-1}\\,K^{-1}}$。热能为：\n$$\nk_{B} T = (1.9872041 \\times 10^{-3}\\,\\mathrm{kcal\\,mol^{-1}\\,K^{-1}}) \\times (300\\,\\mathrm{K}) \\approx 0.596161\\,\\mathrm{kcal\\,mol^{-1}}\n$$\n现在，我们可以计算 $\\sigma$：\n$$\n\\sigma = \\sqrt{\\frac{0.596161\\,\\mathrm{kcal\\,mol^{-1}}}{20\\,\\mathrm{kcal\\,mol^{-1}\\,Å^{-2}}}} = \\sqrt{0.029808\\,\\mathrm{Å}^2} \\approx 0.17265\\,\\mathrm{Å}\n$$\n按要求四舍五入到三位有效数字，我们得到 $\\sigma \\approx 0.173\\,\\mathrm{Å}$。\n\n接下来，我们确定相邻窗口中心之间的最大允许间距 $d_{\\max}$。两个相邻窗口 $i$ 和 $i+1$（其中心相距为 $d = |s_{0}^{(i+1)} - s_{0}^{(i)}|$）之间的重叠系数 (OC) 是其 PDF $P_i(s)$ 和 $P_{i+1}(s)$ 逐点最小值的积分。两个 PDF 都是具有相同标准差 $\\sigma$ 的高斯分布。为简单起见，设中心位于 $-d/2$ 和 $d/2$。两个高斯函数的交点在 $s=0$ 处。重叠积分是：\n$$\nOC = \\int_{-\\infty}^{\\infty} \\min(P_i(s), P_{i+1}(s)) ds = \\int_{-\\infty}^{0} P_{i+1}(s) ds + \\int_{0}^{\\infty} P_i(s) ds\n$$\n由于对称性，这两个积分是相等的。我们可以写出 $OC = 2 \\int_{0}^{\\infty} P_i(s) ds$。这等同于均值为 $-d/2$ 的高斯分布从 $0$ 到 $\\infty$ 积分的尾部概率的两倍。这个计算是标准的，其结果可以用互补误差函数 $\\text{erfc}(x)$ 表示：\n$$\nOC(d, \\sigma) = \\text{erfc}\\left(\\frac{d}{2\\sqrt{2}\\sigma}\\right)\n$$\n给定要求的最小重叠为 $0.3$。通过设置 $OC = 0.3$ 来找到最大间距 $d_{\\max}$：\n$$\n0.3 = \\text{erfc}\\left(\\frac{d_{\\max}}{2\\sqrt{2}\\sigma}\\right)\n$$\n为了解出 $d_{\\max}$，我们对两边取反互补误差函数 ($\\text{erfc}^{-1}$)：\n$$\n\\text{erfc}^{-1}(0.3) = \\frac{d_{\\max}}{2\\sqrt{2}\\sigma}\n$$\n使用数值库或计算器，可得 $\\text{erfc}^{-1}(0.3) \\approx 0.73287$。\n$$\nd_{\\max} = 2\\sqrt{2}\\sigma \\times \\text{erfc}^{-1}(0.3) \\approx 2\\sqrt{2} \\times (0.17265\\,\\mathrm{Å}) \\times 0.73287 \\approx 0.35787\\,\\mathrm{Å}\n$$\n最后，我们确定覆盖区间 $s \\in [3, 10]\\,\\mathrm{Å}$ 所需的最小窗口数 $N$。需要采样的反应坐标的总长度是 $L = 10\\,\\mathrm{Å} - 3\\,\\mathrm{Å} = 7\\,\\mathrm{Å}$。为了用等间距的窗口完全覆盖该区间，我们将第一个窗口的中心置于 $s_0^{(1)} = 3\\,\\mathrm{Å}$，最后一个窗口的中心置于 $s_0^{(N)} = 10\\,\\mathrm{Å}$。对于 $N$ 个窗口，存在 $N-1$ 个间距为 $d$ 的区间。中心所跨越的总长度是：\n$$\nL = (N-1)d\n$$\n为确保足够的重叠，间距 $d$ 不得超过最大允许间距 $d_{\\max}$：\n$$\nd \\le d_{\\max}\n$$\n将 $d = L/(N-1)$ 代入，我们得到：\n$$\n\\frac{L}{N-1} \\le d_{\\max} \\quad \\implies \\quad N-1 \\ge \\frac{L}{d_{\\max}}\n$$\n这给出了最小窗口数的条件：\n$$\nN \\ge \\frac{L}{d_{\\max}} + 1\n$$\n代入 $L$ 和 $d_{\\max}$ 的值：\n$$\nN \\ge \\frac{7\\,\\mathrm{Å}}{0.35787\\,\\mathrm{Å}} + 1 \\approx 19.5599 + 1 = 20.5599\n$$\n由于 $N$ 必须是整数，满足此条件的最小窗口数是 $N=21$。\n\n所要求的值是四舍五入到三位有效数字的标准差 $\\sigma$ 和最小整数窗口数 $N$。\n$\\sigma = 0.173\\,\\mathrm{Å}$\n$N = 21$",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 0.173 & 21 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "伞形采样流程的最后一步，也是最终目标，便是整合所有偏置窗口的数据以获得无偏的自由能分布。这项编程练习演示了“重加权”这一核心分析原理，通过该原理，我们可以从收集到的偏置直方图中移除人为施加的偏置势的影响。通过这种方法，你将能亲手实践如何从原始模拟数据中恢复出体系真实的自由能形貌。",
            "id": "3458771",
            "problem": "给定离散的反应坐标区间 $\\{s_i\\}_{i=1}^N$、在已知偏置势 $U_b(s_i)$ 下收集到的计数所构成的有偏直方图 $h_b(s_i)$，以及一个以开尔文为单位的恒定温度 $T$。任务是通过对有偏直方图进行适当的重加权，从 Boltzmann 分布下的正则系综和偏置的定义出发，恢复这些区间上的无偏置离散概率质量函数 (PMF) $p(s_i)$。解法必须推导出合适的未归一化估计量，然后生成在离散区间上归一化的 PMF。\n\n基本原理：\n- 在温度为 $T$ 的正则系综中，Boltzmann 分布表明，能量为 $U(x)$ 的微观态 $x$ 出现的概率与 $\\exp(-\\beta U(x))$ 成正比，其中 $\\beta = \\frac{1}{k_\\mathrm{B} T}$ 且 $k_\\mathrm{B}$ 是 Boltzmann 常数。\n- 当沿集体变量 $s$ 施加一个偏置势 $U_b(s)$ 时，在偏置下沿 $s$ 的采样分布会根据 Boltzmann 因子发生改变，并且可以与无偏置分布关联起来。\n\n定义和要求：\n- 设 $k_\\mathrm{B} = 0.00831446261815324$，单位为千焦每摩尔每开尔文 (kJ mol$^{-1}$ K$^{-1}$)，因此如果 $U_b(s)$ 的单位是千焦每摩尔 (kJ mol$^{-1}$)，$T$ 的单位是开尔文，那么 $\\beta$ 的单位就是 mol kJ$^{-1}$。\n- 离散 PMF $p(s_i)$ 必须满足 $\\sum_{i=1}^N p(s_i) = 1$。PMF 是无量纲的（没有物理单位）。\n- 你必须根据给定的 $h_b(s_i)$ 和 $U_b(s_i)$ 计算区间上无偏置分布的未归一化估计，然后将其归一化以得到 $p(s_i)$。\n\n数值和算法约束：\n- 以符合概率论的方式正确处理计数为零 $h_b(s_i) = 0$ 的区间。\n- 在计算指数时避免数值上溢或下溢；设计的算法应对大数量级的 $\\beta U_b(s_i)$ 值保持稳定。\n\n测试套件规范：\n对于每个测试用例，$h_b(s_i)$ 是一个非负整数列表，$U_b(s_i)$ 是一个单位为 kJ mol$^{-1}$ 的实数列表，$T$ 是一个单位为开尔文的正实数。你的程序必须处理所有测试用例并生成它们的 PMF。\n\n- 测试用例 1 (正常路径)：\n  - $T = 300$ K\n  - $h_b(s) = [100, 120, 80, 60, 40, 20]$\n  - $U_b(s) = [5.0, 2.0, 0.0, 2.0, 5.0, 8.0]$ kJ mol$^{-1}$\n\n- 测试用例 2 (包含零计数区间以及正负偏置)：\n  - $T = 300$ K\n  - $h_b(s) = [0, 50, 0, 10, 0]$\n  - $U_b(s) = [-2.0, -1.0, 0.0, 1.0, 2.0]$ kJ mol$^{-1}$\n\n- 测试用例 3 (高温降低偏置的影响)：\n  - $T = 1200$ K\n  - $h_b(s) = [10, 20, 30, 40, 50]$\n  - $U_b(s) = [0.0, 4.0, 8.0, 4.0, 0.0]$ kJ mol$^{-1}$\n\n- 测试用例 4 (低温增加偏置的影响；可能出现极端的重加权)：\n  - $T = 50$ K\n  - $h_b(s) = [500, 10, 10, 500]$\n  - $U_b(s) = [10.0, 0.0, 0.0, 10.0]$ kJ mol$^{-1}$\n\n最终输出格式：\n- 你的程序应生成单行输出，其中包含所有测试用例的 PMF，格式为用方括号括起来的列表的列表，以逗号分隔。每个内部列表按区间顺序包含一个测试用例的 PMF 值。每个 PMF 值必须以浮点数形式打印，并保留 $6$ 位小数，且不得有多余的空格。例如：$[[p_{1,1},p_{1,2},\\dots],[p_{2,1},\\dots],\\dots]$。",
            "solution": "该问题是有效的。它提出了计算统计力学中一个标准的、良构的任务：从有偏模拟数据中恢复无偏概率分布。所有提供的信息在科学上都是合理的、自洽的，并且足以推导出一个唯一且有意义的解。\n\n目标是根据给定的有偏计数直方图 $h_b(s_i)$、每个区间的已知偏置势 $U_b(s_i)$ 和恒定温度 $T$，确定在一组离散反应坐标区间 $\\{s_i\\}_{i=1}^N$ 上的无偏置概率质量函数 (PMF) $p(s_i)$。\n\n推导始于统计力学中正则系综的基本原理。系统处于能量为 $U(x)$ 的特定微观态 $x$ 的概率 $P(x)$ 由 Boltzmann 分布给出：\n$$\nP(x) = \\frac{1}{Z} e^{-\\beta U(x)}\n$$\n其中 $\\beta = \\frac{1}{k_\\mathrm{B} T}$ 是逆热能，$k_\\mathrm{B}$ 是 Boltzmann 常数，$Z$ 是对分布进行归一化的正则配分函数。\n\n找到系统处于集体变量 $s$ 的某个特定区间 $s_i$ 内的概率，是通过对所有满足 $s(x)=s_i$ 的微观态 $x$ 进行积分得到的。因此，无偏置 PMF $p(s_i)$ 与该积分成正比：\n$$\np(s_i) \\propto \\int_{s(x)=s_i} e^{-\\beta U(x)} dx\n$$\n在有偏模拟中，施加了一个外势 $U_b(s)$。微观态 $x$ 的总能量变为 $U_{total}(x) = U(x) + U_b(s(x))$。在这个有偏系综中观察到微观态 $x$ 的概率 $P_b(x)$ 为：\n$$\nP_b(x) \\propto e^{-\\beta (U(x) + U_b(s(x)))} = e^{-\\beta U(x)} e^{-\\beta U_b(s(x))}\n$$\n相应的有偏 PMF $p_b(s_i)$ 是通过对相关微观态进行积分得到的。由于对于任何给定的区间 $s_i$，偏置势 $U_b(s_i)$ 是恒定的，其 Boltzmann 因子可以从积分中提出：\n$$\np_b(s_i) \\propto \\int_{s(x)=s_i} e^{-\\beta U(x)} e^{-\\beta U_b(s_i)} dx = e^{-\\beta U_b(s_i)} \\int_{s(x)=s_i} e^{-\\beta U(x)} dx\n$$\n剩余的积分与无偏置概率 $p(s_i)$ 成正比。这建立了有偏和无偏概率分布之间的核心关系：\n$$\np_b(s_i) \\propto p(s_i) e^{-\\beta U_b(s_i)}\n$$\n为了求得无偏置 PMF $p(s_i)$，我们可以重排这个方程：\n$$\np(s_i) \\propto p_b(s_i) e^{\\beta U_b(s_i)}\n$$\n在分子动力学模拟中，有偏概率 $p_b(s_i)$ 是根据观测到的计数直方图 $h_b(s_i)$ 来估计的。对于足够长的模拟，一个区间中的计数与该区间的概率成正比：$h_b(s_i) \\propto p_b(s_i)$。将此关系代入前面的关系式，我们得到无偏置 PMF 的一个未归一化估计，记作 $\\tilde{p}(s_i)$：\n$$\n\\tilde{p}(s_i) = h_b(s_i) e^{\\beta U_b(s_i)}\n$$\n为了得到最终正确归一化的 PMF $p(s_i)$，我们必须将这个未归一化的估计除以它在所有 $N$ 个区间上的总和。这个总和充当归一化常数 $Z_{norm}$：\n$$\nZ_{norm} = \\sum_{j=1}^{N} \\tilde{p}(s_j) = \\sum_{j=1}^{N} h_b(s_j) e^{\\beta U_b(s_j)}\n$$\n于是，归一化的 PMF 由下式给出：\n$$\np(s_i) = \\frac{\\tilde{p}(s_i)}{Z_{norm}} = \\frac{h_b(s_i) e^{\\beta U_b(s_i)}}{\\sum_{j=1}^{N} h_b(s_j) e^{\\beta U_b(s_j)}}\n$$\n该公式能正确处理计数为零的区间；如果 $h_b(s_i)=0$，则 $p(s_i)=0$，这反映了该状态未被观测到，其概率估计为零。\n\n在数值实现中，如果指数 $\\beta U_b(s_i)$ 是一个大的正数，项 $e^{\\beta U_b(s_i)}$ 可能会导致上溢。为确保数值稳定性，我们可以利用分子和分母同乘以一个常数结果不变的性质。一个标准技巧是平移指数。令 $E_i = \\beta U_b(s_i)$。我们找到在所有实际采样过的区间（即 $h_b(s_i) > 0$ 的区间）上该指数的最大值，称之为 $E_{max} = \\max_{j | h_b(s_j)>0} \\{E_j\\}$。然后我们将计算重构为：\n$$\np(s_i) = \\frac{h_b(s_i) e^{E_i} e^{-E_{max}}}{\\sum_{j=1}^{N} h_b(s_j) e^{E_j} e^{-E_{max}}} = \\frac{h_b(s_i) e^{E_i - E_{max}}}{\\sum_{j=1}^{N} h_b(s_j) e^{E_j - E_{max}}}\n$$\n在这种数值上鲁棒的形式中，对于所有采样过的区间，指数 $E_j - E_{max}$ 总是小于或等于 $0$，这将指数项的值限制在 $(0, 1]$ 范围内，从而有效防止上溢。如果所有直方图计数均为零，则总样本数为零，归一化常数也为零。在这种情况下，PMF 是未定义的，算法应返回一个零向量，因为无法为任何区间分配概率。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves for the unbiased Probability Mass Function (PMF) from biased histograms\n    for a series of test cases.\n    \"\"\"\n    # Define the Boltzmann constant in kJ mol^-1 K^-1\n    K_B = 0.00831446261815324\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"T\": 300, # K\n            \"h_b\": [100, 120, 80, 60, 40, 20],\n            \"U_b\": [5.0, 2.0, 0.0, 2.0, 5.0, 8.0], # kJ mol^-1\n        },\n        {\n            \"T\": 300, # K\n            \"h_b\": [0, 50, 0, 10, 0],\n            \"U_b\": [-2.0, -1.0, 0.0, 1.0, 2.0], # kJ mol^-1\n        },\n        {\n            \"T\": 1200, # K\n            \"h_b\": [10, 20, 30, 40, 50],\n            \"U_b\": [0.0, 4.0, 8.0, 4.0, 0.0], # kJ mol^-1\n        },\n        {\n            \"T\": 50, # K\n            \"h_b\": [500, 10, 10, 500],\n            \"U_b\": [10.0, 0.0, 0.0, 10.0], # kJ mol^-1\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        T = case[\"T\"]\n        h_b = np.array(case[\"h_b\"], dtype=np.float64)\n        U_b = np.array(case[\"U_b\"], dtype=np.float64)\n\n        # If there are no counts at all, the PMF is undefined.\n        # Returning zeros is a consistent interpretation.\n        if np.sum(h_b) == 0:\n            pmf = np.zeros_like(h_b)\n            results.append(pmf.tolist())\n            continue\n\n        # Calculate inverse thermal energy, beta\n        beta = 1.0 / (K_B * T)\n\n        # Calculate the log of the reweighting factors\n        log_reweight_factors = beta * U_b\n\n        # For numerical stability, find the maximum of the log factors\n        # only over the bins that were actually sampled (h_b > 0).\n        sampled_indices = np.where(h_b > 0)\n        max_log_factor = np.max(log_reweight_factors[sampled_indices])\n\n        # Shift the log factors to prevent numerical overflow in the exponentiation.\n        # The largest exponent will now be 0, leading to a max reweighting factor of 1.\n        stable_log_factors = log_reweight_factors - max_log_factor\n\n        # Calculate the final reweighting factors\n        reweighting_factors = np.exp(stable_log_factors)\n\n        # Apply reweighting to get unnormalized unbiased counts/probabilities\n        unbiased_counts = h_b * reweighting_factors\n\n        # Normalize to get the final Probability Mass Function (PMF)\n        total_unbiased_count = np.sum(unbiased_counts)\n        pmf = unbiased_counts / total_unbiased_count\n\n        results.append(pmf.tolist())\n\n    # Format the final output string according to the specified format.\n    # e.g., [[0.123456,0.876544],[...]]\n    outer_list_str = []\n    for res_list in results:\n        inner_list_str = \",\".join([f\"{val:.6f}\" for val in res_list])\n        outer_list_str.append(f\"[{inner_list_str}]\")\n    \n    final_output_str = f\"[{','.join(outer_list_str)}]\"\n    print(final_output_str)\n\nsolve()\n```"
        }
    ]
}