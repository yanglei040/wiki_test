{
    "hands_on_practices": [
        {
            "introduction": "这项练习是一项至关重要的理论推导。它旨在巩固您对蓝月亮系综公式中几何校正项为何必须源自质量加权度规，而非更简单的欧几里得度规的理解。通过一个清晰的例子，您将看到使用错误的度规会得出明显错误的答案，从而更深刻地体会到该自由能项的动能起源 。",
            "id": "3398634",
            "problem": "考虑两个独立的一维粒子，它们的笛卡尔坐标分别为 $x$ 和 $y$，质量分别为 $m_{x}$ 和 $m_{y}$，并通过相同的谐振子势 $U(x,y) = \\tfrac{1}{2} k \\left(x^{2} + y^{2}\\right)$ 与原点相连。该系统在温度为 $T$（玻尔兹曼常数 $k_{B}$）的正则系综中进行采样。定义反应坐标 $\\xi(x,y) = \\arctan\\!\\left(\\tfrac{y}{x}\\right)$，其取值范围为 $(0,\\pi)$，角度以弧度为单位。\n\n你的任务如下。\n\n1.  从正则构型分布出发，通过变量替换到类极坐标 $(r,\\xi)$（其中 $r = \\sqrt{x^{2} + y^{2}}$），并对 $r$ 进行积分，推导出沿着 $\\xi$ 的精确平均力势 $A(\\xi)$ 及其导数 $\\tfrac{dA}{d\\xi}$。不要预先假设任何特定于该坐标的结果；从正则系综的第一性原理和坐标变换的雅可比行列式开始。\n\n2.  接下来，设想在一个约束分子动力学（MD）模拟中计算 $\\tfrac{dA}{d\\xi}$，其中 $\\xi$ 被固定在给定值。使用蓝月亮系综逻辑：超曲面 $\\xi=\\text{const}$ 上的约束平衡测度是由动能度规（质量度规）$M = \\mathrm{diag}(m_{x}, m_{y})$ 导出的，其相应的几何因子为 $g_{M}(x,y) = \\nabla \\xi(x,y)^{\\top} M^{-1} \\nabla \\xi(x,y)$。解释为何恒等式 $\\frac{dA}{d\\xi} \\;=\\; \\left\\langle \\Lambda_{\\xi} \\right\\rangle_{\\xi} \\;-\\; \\frac{k_{B} T}{2} \\,\\frac{d}{d\\xi} \\ln g_{M}$ 成立，其中 $\\Lambda_{\\xi}$ 是在约束 MD 中施加完整约束 $\\xi=\\text{const}$ 的拉格朗日乘子，而 $\\langle \\cdot \\rangle_{\\xi}$ 表示在约束流形上的正则平均。你可以使用一个已广为确立的事实：约束 MD 在 $\\xi=\\text{const}$ 上对蓝月亮系综进行采样，其密度正比于 $\\exp(-\\beta U)\\sqrt{g_{M}}$，其中 $\\beta = 1/(k_{B} T)$。\n\n3.  显式计算梯度 $\\nabla \\xi(x,y)$、正确的质量度规因子 $g_{M}(x,y)$ 以及欧几里得度规因子 $g_{E}(x,y) = \\nabla \\xi(x,y)^{\\top} \\nabla \\xi(x,y)$，并用 $(r,\\xi)$ 表示它们。证明对于这种各向同性势，正确的质量度规公式通过 $\\left\\langle \\Lambda_{\\xi} \\right\\rangle_{\\xi}$ 和 $\\tfrac{k_{B} T}{2} \\tfrac{d}{d\\xi}\\ln g_{M}$ 之间的精确抵消，得到 $\\tfrac{dA}{d\\xi}=0$，而在修正项中用 $g_{E}$ 替换 $g_{M}$ 通常会产生一个非零结果。\n\n作为最终答案，请提供由此产生的伪导数 $\\Delta(\\xi;m_{x},m_{y}) \\;=\\; \\left.\\frac{dA}{d\\xi}\\right|_{\\text{Euclidean correction}} \\;-\\; \\left.\\frac{dA}{d\\xi}\\right|_{\\text{exact}}$ 的闭合形式解析表达式，该表达式是关于 $\\xi$、$m_{x}$ 和 $m_{y}$ 的函数。不要代入数值。将你的最终答案表示为单一的简化解析表达式。",
            "solution": "我们从正则构型系综开始。在笛卡尔坐标系中，正则概率密度为\n$$\n\\pi(x,y) \\;=\\; \\frac{1}{Z} \\exp\\!\\left(-\\beta U(x,y)\\right) \\;=\\; \\frac{1}{Z} \\exp\\!\\left(-\\frac{\\beta k}{2}(x^{2}+y^{2})\\right),\n$$\n其中 $Z$ 是构型配分函数，$\\beta = 1/(k_{B} T)$。引入类极坐标 $(r,\\xi)$，其中 $r=\\sqrt{x^{2}+y^{2}}$ 且 $\\xi = \\arctan(y/x)$ 在 $(0,\\pi)$ 上；该变换的雅可比行列式为 $J = r$，因此面积元变换为 $dx\\,dy = r\\,dr\\,d\\xi$。$\\xi$ 的边缘密度为\n$$\np(\\xi) \\;\\propto\\; \\int_{0}^{\\infty} r \\exp\\!\\left(-\\frac{\\beta k}{2} r^{2}\\right) dr,\n$$\n它与 $\\xi$ 无关，因为被积函数不依赖于 $\\xi$。因此 $p(\\xi)$ 是一个常数（均匀分布），平均力势 (PMF) $A(\\xi)$ 满足\n$$\nA(\\xi) \\;=\\; -k_{B} T \\ln p(\\xi) \\;=\\; \\text{const},\n$$\n所以\n$$\n\\frac{dA}{d\\xi} \\;=\\; 0.\n$$\n\n我们现在转向约束分子动力学 (MD) 和蓝月亮系综。对于一个完整约束 $\\xi(x,y)=\\xi_{0}$，约束 MD 采样的约束平衡密度在约束流形上正比于 $\\exp(-\\beta U)\\sqrt{g_{M}}$，其中蓝月亮因子 $g_{M}$ 定义为\n$$\ng_{M}(x,y) \\;=\\; \\nabla \\xi(x,y)^{\\top} M^{-1} \\nabla \\xi(x,y),\n$$\n而 $M = \\mathrm{diag}(m_{x}, m_{y})$ 是出现在动能 $T = \\tfrac{1}{2} \\dot{\\mathbf{q}}^{\\top} M \\dot{\\mathbf{q}}$ 中的质量度规。蓝月亮系综中一个经过充分检验的恒等式将 PMF 的导数与约束平均联系起来，即\n$$\n\\frac{dA}{d\\xi} \\;=\\; \\left\\langle \\Lambda_{\\xi} \\right\\rangle_{\\xi} \\;-\\; \\frac{k_{B} T}{2} \\frac{d}{d\\xi} \\ln g_{M}.\n$$\n这是通过对约束配分函数 $Z_{\\mathrm{constr}}(\\xi) = \\int \\exp(-\\beta U) \\sqrt{g_{M}} \\,\\delta(\\xi(\\mathbf{q})-\\xi)\\, d\\mathbf{q}$ 关于 $\\xi$ 求导，并从沿约束流形的虚功中识别出拉格朗日乘子贡献 $\\Lambda_{\\xi}$，以及几何因子 $\\sqrt{g_{M}}$ 的导数得出的。\n\n我们计算 $\\xi(x,y) = \\arctan(y/x)$ 的梯度。使用标准求导法则，\n$$\n\\frac{\\partial \\xi}{\\partial x} \\;=\\; -\\frac{y}{x^{2}+y^{2}} \\;=\\; -\\frac{y}{r^{2}}, \n\\qquad\n\\frac{\\partial \\xi}{\\partial y} \\;=\\; \\frac{x}{x^{2}+y^{2}} \\;=\\; \\frac{x}{r^{2}},\n$$\n所以\n$$\n\\nabla \\xi(x,y) \\;=\\; \\begin{pmatrix} -y/r^{2} \\\\ x/r^{2} \\end{pmatrix}.\n$$\n欧几里得度规因子为\n$$\ng_{E}(x,y) \\;=\\; \\nabla \\xi^{\\top} \\nabla \\xi \\;=\\; \\frac{y^{2}}{r^{4}} + \\frac{x^{2}}{r^{4}} \\;=\\; \\frac{x^{2}+y^{2}}{r^{4}} \\;=\\; \\frac{1}{r^{2}}.\n$$\n质量度规因子为\n$$\ng_{M}(x,y) \\;=\\; \\nabla \\xi^{\\top} M^{-1} \\nabla \\xi \\;=\\; \n\\begin{pmatrix} -y/r^{2}  x/r^{2} \\end{pmatrix}\n\\begin{pmatrix} 1/m_{x}  0 \\\\ 0  1/m_{y} \\end{pmatrix}\n\\begin{pmatrix} -y/r^{2} \\\\ x/r^{2} \\end{pmatrix}\n\\;=\\; \\frac{y^{2}}{m_{x} r^{4}} + \\frac{x^{2}}{m_{y} r^{4}}.\n$$\n通过 $x=r\\cos\\xi$，$y=r\\sin\\xi$ 用 $(r,\\xi)$ 表示，上式变为\n$$\ng_{M}(r,\\xi) \\;=\\; \\frac{r^{2}\\sin^{2}\\xi}{m_{x} r^{4}} + \\frac{r^{2}\\cos^{2}\\xi}{m_{y} r^{4}} \\;=\\; \\frac{1}{r^{2}} \\left( \\frac{\\sin^{2}\\xi}{m_{x}} + \\frac{\\cos^{2}\\xi}{m_{y}} \\right).\n$$\n由此可得\n$$\n\\ln g_{M}(r,\\xi) \\;=\\; -2 \\ln r \\;+\\; \\ln\\!\\left( \\frac{\\sin^{2}\\xi}{m_{x}} + \\frac{\\cos^{2}\\xi}{m_{y}} \\right).\n$$\n因此，在固定 $\\xi$ 处（即，沿着约束流形）关于 $\\xi$ 的导数为\n$$\n\\frac{d}{d\\xi} \\ln g_{M} \\;=\\; \\frac{ \\dfrac{d}{d\\xi} \\left( \\dfrac{\\sin^{2}\\xi}{m_{x}} + \\dfrac{\\cos^{2}\\xi}{m_{y}} \\right) }{ \\dfrac{\\sin^{2}\\xi}{m_{x}} + \\dfrac{\\cos^{2}\\xi}{m_{y}} }\n\\;=\\; \\frac{ 2 \\sin\\xi \\cos\\xi \\left( \\dfrac{1}{m_{x}} - \\dfrac{1}{m_{y}} \\right) }{ \\dfrac{\\sin^{2}\\xi}{m_{x}} + \\dfrac{\\cos^{2}\\xi}{m_{y}} }.\n$$\n相比之下，欧几里得因子 $g_{E} = 1/r^{2}$ 得到 $\\dfrac{d}{d\\xi} \\ln g_{E} = 0$。\n\n对于各向同性谐波势 $U=\\tfrac{1}{2}k r^{2}$，如第一部分所示，旋转对称性意味着精确的 PMF 导数为零，即 $\\tfrac{dA}{d\\xi} = 0$。因此，在正确的蓝月亮表达式中，\n$$\n0 \\;=\\; \\left\\langle \\Lambda_{\\xi} \\right\\rangle_{\\xi} \\;-\\; \\frac{k_{B} T}{2} \\frac{d}{d\\xi} \\ln g_{M},\n$$\n所以拉格朗日乘子的约束平均必须是\n$$\n\\left\\langle \\Lambda_{\\xi} \\right\\rangle_{\\xi} \\;=\\; \\frac{k_{B} T}{2} \\frac{d}{d\\xi} \\ln g_{M}.\n$$\n然而，如果错误地用欧几里得度规修正替换质量度规修正，将会计算出\n$$\n\\left.\\frac{dA}{d\\xi}\\right|_{\\text{Euclidean correction}}\n\\;=\\; \\left\\langle \\Lambda_{\\xi} \\right\\rangle_{\\xi} \\;-\\; \\frac{k_{B} T}{2} \\frac{d}{d\\xi} \\ln g_{E}\n\\;=\\; \\left\\langle \\Lambda_{\\xi} \\right\\rangle_{\\xi} \\;-\\; 0\n\\;=\\; \\frac{k_{B} T}{2} \\frac{d}{d\\xi} \\ln g_{M}.\n$$\n由于精确导数为零，因此相对于精确结果的伪导数为\n$$\n\\Delta(\\xi;m_{x},m_{y}) \\;=\\; \\left.\\frac{dA}{d\\xi}\\right|_{\\text{Euclidean correction}} \\;-\\; \\left.\\frac{dA}{d\\xi}\\right|_{\\text{exact}}\n\\;=\\; \\frac{k_{B} T}{2} \\frac{d}{d\\xi} \\ln g_{M}.\n$$\n代入上面找到的 $\\dfrac{d}{d\\xi} \\ln g_{M}$ 的表达式并化简，我们得到闭合形式表达式\n$$\n\\Delta(\\xi;m_{x},m_{y}) \\;=\\; k_{B} T \\,\\frac{ \\sin\\xi \\cos\\xi \\left( \\dfrac{1}{m_{x}} - \\dfrac{1}{m_{y}} \\right) }{ \\dfrac{\\sin^{2}\\xi}{m_{x}} + \\dfrac{\\cos^{2}\\xi}{m_{y}} }.\n$$\n当 $m_{x} \\neq m_{y}$ 且 $\\xi \\notin \\{0,\\tfrac{\\pi}{2},\\pi\\}$ 时，该结果非零，这表明使用欧几里得度规代替质量度规会在 $\\dfrac{dA}{d\\xi}$ 中产生一个人为的、依赖于质量非均匀性的偏差，而正确的质量度规处理方法则能恢复精确的均匀 PMF，其中 $\\dfrac{dA}{d\\xi} = 0$。",
            "answer": "$$\\boxed{k_{B} T\\,\\frac{\\left(\\frac{1}{m_{x}}-\\frac{1}{m_{y}}\\right)\\sin\\xi\\,\\cos\\xi}{\\frac{\\sin^{2}\\xi}{m_{x}}+\\frac{\\cos^{2}\\xi}{m_{y}}}}$$"
        },
        {
            "introduction": "在确立了质量度规行列式的重要性之后，这项练习将从理论转向数值实现。您将开发并比较两种不同的估计量，用于计算此几何校正项的导数，而该导数是总平均力的一个关键组成部分。这项练习提供了将理论公式转化为代码，并评估不同数值方法统计性能（方差）的实践经验 。",
            "id": "3398624",
            "problem": "考虑一个具有两个笛卡尔坐标 $q_1$ 和 $q_2$、一个对角质量矩阵 $M = \\mathrm{diag}(m_1,m_2)$ 和一个谐振子势能 $U(q_1,q_2) = \\frac{k}{2}(q_1^2 + q_2^2)$ 的经典系统。对此位形施加一个完整约束，\n$$\n\\xi(q_1,q_2) = q_1 + \\gamma q_1 q_2^2 = c,\n$$\n其中 $\\gamma$ 是一个控制曲率的实数参数，$c$ 是固定的反应坐标值。这在 $(q_1,q_2)$ 平面中定义了一个一维约束流形。令 $a(q) = \\nabla \\xi(q)$ 表示约束的梯度，$H_\\xi(q)$ 表示约束的 Hessian 矩阵。定义与此单个约束相关的标量度规 $g(q)$ 为\n$$\ng(q) = a(q)^\\top M^{-1} a(q),\n$$\n因此，对于一个约束，菲克斯曼行列式为 $\\det G(\\xi) = g(q)$。\n\n您将基于加速度级约束动力学中拉格朗日乘子的涨落和约束的 Hessian 矩阵，设计并实现导数 $\\partial_\\xi \\ln \\sqrt{\\det G(\\xi)} = \\partial_\\xi \\left(\\frac{1}{2}\\ln g\\right)$ 的一个估计量，并将其方差与沿反应坐标 $\\xi$ 的直接有限差分近似进行比较。本问题中所有量均为无量纲；温度 $T$ 使用的单位中玻尔兹曼常数为 1（即 $k_{\\mathrm{B}}=1$）。\n\n**推导和设计的基本依据：**\n- 带完整约束的牛顿第二定律：对于位置 $q$ 和速度 $v$，使用拉格朗日乘子 $\\lambda$ 强制执行 $\\xi(q)=c$ 的运动方程为\n$$\nM \\ddot{q} = -\\nabla U(q) - a(q)\\,\\lambda,\n$$\n以及用于约束动力学的运动学约束 $\\dot{\\xi}(q,v) = a(q)^\\top v = 0$ 和加速度级约束\n$$\n\\ddot{\\xi}(q,v) = a(q)^\\top \\ddot{q} + v^\\top H_\\xi(q) v = 0.\n$$\n- 在温度为 $T$ 且带有速度约束 $a(q)^\\top v = 0$ 的正则系综中，速度分布是限制在切空间上的高斯分布，其协方差为\n$$\n\\langle v v^\\top \\rangle_q = T\\left[M^{-1} - \\frac{M^{-1} a(q) a(q)^\\top M^{-1}}{g(q)}\\right],\n$$\n其中平均是在约束流形上位形 $q$ 的条件下进行的。\n- 在固定的 $q$ 和 $v$ 下，拉格朗日乘子通过求解加速度级约束得到 $\\lambda$：\n$$\n\\lambda(q,v) = \\frac{a(q)^\\top M^{-1} F(q) + v^\\top H_\\xi(q)\\, v}{g(q)},\n$$\n其中 $F(q) = -\\nabla U(q)$ 是物理力。\n\n**估计量设计：**\n- 在固定位形 $q$ 下，$\\partial_\\xi \\ln \\sqrt{\\det G(\\xi)}$ 的估计量是通过在约束正则速度分布上对 $\\lambda(q,v)$ 中依赖于速度的项进行平均，并消除确定性力投影 $a(q)^\\top M^{-1} F(q)/g(q)$ 来构建的。这产生了一个依赖于位形的估计量\n$$\n\\mathcal{E}_\\lambda(q) = \\frac{1}{T}\\left\\langle \\frac{v^\\top H_\\xi(q)\\, v}{g(q)}\\right\\rangle_q = \\frac{1}{g(q)}\\left[\\mathrm{Tr}\\left(H_\\xi(q)\\, M^{-1}\\right) - \\frac{a(q)^\\top M^{-1} H_\\xi(q) M^{-1} a(q)}{g(q)}\\right],\n$$\n其仅通过 $a(q)$、$H_\\xi(q)$ 和 $g(q)$ 依赖于 $q$。\n- 在固定 $q_2$ 处的直接有限差分估计量通过一个小增量 $\\delta$ 扰动反应坐标，并计算\n$$\n\\mathcal{E}_{\\mathrm{FD}}(q_2) = \\frac{1}{2}\\,\\frac{\\ln g\\left(q_1^+(q_2),q_2\\right) - \\ln g\\left(q_1^-(q_2),q_2\\right)}{\\delta},\n$$\n其中 $q_1^\\pm(q_2) = \\frac{c \\pm \\delta}{1 + \\gamma q_2^2}$ 是具有相同 $q_2$ 且位于相邻约束流形 $\\xi = c \\pm \\delta$ 上的位形点。\n\n**沿约束流形的系综：**\n- 在温度 $T$ 和势能 $U(q)$ 下，以 $\\xi(q)=c$ 为条件的位形 $(q_1,q_2)$ 的约束正则分布，通过余面积公式在 $q_2$ 上导出一个一维分布。使用 $f(q_1,q_2) = q_1 + \\gamma q_1 q_2^2 - c$ 并求解 $q_1(q_2) = \\frac{c}{1 + \\gamma q_2^2}$，得到的 $q_2$ 上的未归一化密度为\n$$\nw(q_2) = \\exp\\!\\left(-\\frac{U\\left(q_1(q_2),q_2\\right)}{T}\\right)\\,\\frac{1}{\\left|\\frac{\\partial f}{\\partial q_1}(q_1(q_2),q_2)\\right|} = \\exp\\!\\left(-\\frac{k}{2T}\\left(q_1(q_2)^2 + q_2^2\\right)\\right)\\,\\frac{1}{1+\\gamma q_2^2}.\n$$\n- 在约束系综上，任何依赖于位形的量 $\\Phi(q_2)$ 的期望值是通过在具有均匀间距 $\\Delta q_2$ 的对称网格 $q_2 \\in [-Q,Q]$ 上进行加权平均来计算的，使用归一化权重 $p_i = w(q_{2,i})/\\sum_j w(q_{2,j})$：\n$$\n\\langle \\Phi \\rangle_{\\xi=c} \\approx \\sum_i p_i\\,\\Phi(q_{2,i}),\n$$\n以及相应的系综方差\n$$\n\\mathrm{Var}_{\\xi=c}[\\Phi] \\approx \\sum_i p_i\\left(\\Phi(q_{2,i}) - \\sum_j p_j \\Phi(q_{2,j})\\right)^2.\n$$\n\n**您的任务：**\n1.  通过在 $q_2$ 值的网格上计算 $a(q)$、$H_\\xi(q)$ 和 $g(q)$ 来实现上面推导的依赖于位形的估计量 $\\mathcal{E}_\\lambda(q)$，其中 $q_1(q_2) = \\frac{c}{1 + \\gamma q_2^2}$。\n2.  使用 $q_1^\\pm(q_2) = \\frac{c \\pm \\delta}{1 + \\gamma q_2^2}$ 实现有限差分估计量 $\\mathcal{E}_{\\mathrm{FD}}(q_2)$。\n3.  对于每个指定的测试用例，计算上述 $q_2$ 约束分布上的系综方差 $\\mathrm{Var}_{\\xi=c}[\\mathcal{E}_\\lambda]$ 和 $\\mathrm{Var}_{\\xi=c}[\\mathcal{E}_{\\mathrm{FD}}]$。\n\n**使用以下参数集测试套件：**\n- 测试 1 (正常路径): $(m_1,m_2,k,T,c,\\gamma,\\delta,Q,N) = (1.0,\\,2.0,\\,1.0,\\,0.5,\\,0.8,\\,0.6,\\,0.01,\\,3.0,\\,2001)$。\n- 测试 2 (近线性约束): $(m_1,m_2,k,T,c,\\gamma,\\delta,Q,N) = (1.0,\\,2.0,\\,1.0,\\,0.5,\\,0.8,\\,0.05,\\,0.01,\\,3.0,\\,2001)$。\n- 测试 3 (强曲率): $(m_1,m_2,k,T,c,\\gamma,\\delta,Q,N) = (1.0,\\,2.0,\\,1.0,\\,0.5,\\,0.8,\\,1.5,\\,0.01,\\,3.0,\\,2001)$。\n\n**最终输出格式：**\n您的程序应生成单行输出，包含六个系综方差，按\n$$\n\\left[\\mathrm{Var}_{\\xi=c}[\\mathcal{E}_\\lambda]_{\\text{Test 1}},\\,\\mathrm{Var}_{\\xi=c}[\\mathcal{E}_{\\mathrm{FD}}]_{\\text{Test 1}},\\,\\mathrm{Var}_{\\xi=c}[\\mathcal{E}_\\lambda]_{\\text{Test 2}},\\,\\mathrm{Var}_{\\xi=c}[\\mathcal{E}_{\\mathrm{FD}}]_{\\text{Test 2}},\\,\\mathrm{Var}_{\\xi=c}[\\mathcal{E}_\\lambda]_{\\text{Test 3}},\\,\\mathrm{Var}_{\\xi=c}[\\mathcal{E}_{\\mathrm{FD}}]_{\\text{Test 3}}\\right],\n$$\n的顺序排列，以逗号分隔的列表形式打印，并用方括号括起来，单位为无量纲单位。",
            "solution": "本题的目标是计算并比较在约束分子动力学中出现的几何校正项 $\\partial_\\xi \\ln \\sqrt{\\det G(\\xi)}$ 的两个估计量 $\\mathcal{E}_\\lambda$ 和 $\\mathcal{E}_{\\mathrm{FD}}$ 的系综方差。计算在由约束 $\\xi(q_1, q_2) = c$ 定义的一维流形上进行。\n\n首先，我们推导问题中定义的量的必要解析表达式。坐标 $q_1$ 通过约束方程被 $q_2$ 参数化：\n$$\nq_1(q_2) = \\frac{c}{1 + \\gamma q_2^2}\n$$\n\n约束函数 $\\xi(q_1, q_2) = q_1(1 + \\gamma q_2^2) - c = 0$ 的梯度是\n$$\na(q) = \\nabla \\xi(q) = \\begin{pmatrix} \\partial\\xi/\\partial q_1 \\\\ \\partial\\xi/\\partial q_2 \\end{pmatrix} = \\begin{pmatrix} 1 + \\gamma q_2^2 \\\\ 2 \\gamma q_1 q_2 \\end{pmatrix}\n$$\n\n约束函数的 Hessian 矩阵是\n$$\nH_\\xi(q) = \\begin{pmatrix} \\partial^2\\xi/\\partial q_1^2  \\partial^2\\xi/\\partial q_1 \\partial q_2 \\\\ \\partial^2\\xi/\\partial q_2 \\partial q_1  \\partial^2\\xi/\\partial q_2^2 \\end{pmatrix} = \\begin{pmatrix} 0  2 \\gamma q_2 \\\\ 2 \\gamma q_2  2 \\gamma q_1 \\end{pmatrix}\n$$\n\n质量矩阵 $M = \\mathrm{diag}(m_1, m_2)$ 的逆是 $M^{-1} = \\mathrm{diag}(1/m_1, 1/m_2)$。\n\n标量度规 $g(q)$ 计算如下：\n$$\ng(q) = a(q)^\\top M^{-1} a(q) = \\frac{(1 + \\gamma q_2^2)^2}{m_1} + \\frac{(2 \\gamma q_1 q_2)^2}{m_2}\n$$\n两个估计量都需要这个函数。\n\n数值步骤如下：\n1.  为坐标 $q_2$ 在对称区间 $[-Q, Q]$ 内生成一个包含 $N$ 个点的均匀网格。\n2.  对于此网格上的每个点 $q_{2,i}$，计算相应的 $q_{1,i}$，从而定义一组位于约束流形 $\\xi=c$ 上的位形 $\\{q_i = (q_{1,i}, q_{2,i})\\}$。\n3.  在每个位形 $q_i$ 处，计算估计量 $\\mathcal{E}_\\lambda(q_i)$。其公式为：\n    $$\n    \\mathcal{E}_\\lambda(q) = \\frac{1}{g(q)}\\left[\\mathrm{Tr}\\left(H_\\xi(q)\\, M^{-1}\\right) - \\frac{a(q)^\\top M^{-1} H_\\xi(q) M^{-1} a(q)}{g(q)}\\right]\n    $$\n    实现时将计算矩阵和向量量 $a(q_i)$、$H_\\xi(q_i)$、$M^{-1}$ 和 $g(q_i)$，并执行指定的矩阵向量运算。\n4.  类似地，在每个点 $q_{2,i}$ 处，计算有限差分估计量 $\\mathcal{E}_{\\mathrm{FD}}(q_{2,i})$。这需要计算在两个相邻点 $(q_1^+(q_{2,i}), q_{2,i})$ 和 $(q_1^-(q_{2,i}), q_{2,i})$ 处的度规 $g(q)$，这两个点位于相邻的约束流形 $\\xi = c \\pm \\delta$ 上。\n    $$\n    \\mathcal{E}_{\\mathrm{FD}}(q_2) = \\frac{1}{2\\delta}\\left[\\ln g\\left(\\frac{c + \\delta}{1 + \\gamma q_2^2}, q_2\\right) - \\ln g\\left(\\frac{c - \\delta}{1 + \\gamma q_2^2}, q_2\\right)\\right]\n    $$\n5.  约束流形上的正则系综平均是作为 $q_2$ 网格上的加权和来计算的。未归一化的权重 $w(q_{2,i})$ 由余面积公式给出：\n    $$\n    w(q_{2,i}) = \\exp\\left(-\\frac{U(q_{1,i}, q_{2,i})}{T}\\right) \\frac{1}{1 + \\gamma q_{2,i}^2}\n    $$\n    其中 $U(q_{1,i}, q_{2,i}) = \\frac{k}{2}(q_{1,i}^2 + q_{2,i}^2)$。然后将这些权重归一化以获得概率 $p_i = w_i / \\sum_j w_j$。\n6.  最后，对于每个估计量 $\\Phi \\in \\{\\mathcal{E}_\\lambda, \\mathcal{E}_{\\mathrm{FD}}\\}$，计算系综平均 $\\langle \\Phi \\rangle = \\sum_i p_i \\Phi_i$ 和系综方差 $\\mathrm{Var}[\\Phi] = \\sum_i p_i (\\Phi_i - \\langle \\Phi \\rangle)^2$。\n\n对所提供的三个测试用例重复此过程。实现将使用 `numpy` 进行向量化计算以提高效率。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test cases.\n    It computes the ensemble variances for two different estimators of a\n    geometric correction term in constrained molecular dynamics.\n    \"\"\"\n\n    # Test cases as tuples of (m1, m2, k, T, c, gamma, delta, Q, N)\n    test_cases = [\n        (1.0, 2.0, 1.0, 0.5, 0.8, 0.6, 0.01, 3.0, 2001),\n        (1.0, 2.0, 1.0, 0.5, 0.8, 0.05, 0.01, 3.0, 2001),\n        (1.0, 2.0, 1.0, 0.5, 0.8, 1.5, 0.01, 3.0, 2001)\n    ]\n\n    def compute_variances(params):\n        \"\"\"\n        Computes the ensemble variances for both estimators for a single\n        set of parameters.\n        \"\"\"\n        m1, m2, k, T, c, gamma, delta, Q, N = params\n        \n        # 1. Create a uniform grid for the q2 coordinate.\n        q2_grid = np.linspace(-Q, Q, N)\n\n        # 2. Compute the corresponding q1 coordinate on the constraint manifold.\n        q1_denom = 1 + gamma * q2_grid**2\n        q1_grid = c / q1_denom\n\n        # Helper function to compute the metric scalar g(q)\n        def compute_g(q1_vals, q2_vals):\n            a1_vals = 1 + gamma * q2_vals**2\n            a2_vals = 2 * gamma * q1_vals * q2_vals\n            return a1_vals**2 / m1 + a2_vals**2 / m2\n\n        # 3. Compute the Lagrange multiplier-based estimator E_lambda.\n        # This is done using vectorized numpy operations for efficiency.\n        \n        # Components of the constraint gradient vector a(q)\n        a1 = 1 + gamma * q2_grid**2\n        a2 = 2 * gamma * q1_grid * q2_grid\n        \n        # The metric scalar g(q) on the grid\n        g_grid = a1**2 / m1 + a2**2 / m2\n\n        # Term 1 of E_lambda: Tr(H * M^-1)\n        # H_22 = 2 * gamma * q1\n        # Tr(H * M^-1) = H_11/m1 + H_22/m2 = 0 + (2*gamma*q1)/m2\n        term1_tr = 2 * gamma * q1_grid / m2\n        \n        # Term 2 of E_lambda numerator: a^T * M^-1 * H * M^-1 * a\n        # This is expanded and vectorized to avoid loops.\n        M_inv_a1 = a1 / m1\n        M_inv_a2 = a2 / m2\n        H_M_inv_a_1 = (2 * gamma * q2_grid) * M_inv_a2\n        H_M_inv_a_2 = (2 * gamma * q2_grid) * M_inv_a1 + (2 * gamma * q1_grid) * M_inv_a2\n        term2_num = M_inv_a1 * H_M_inv_a_1 + M_inv_a2 * H_M_inv_a_2\n\n        E_lambda_values = (1 / g_grid) * (term1_tr - term2_num / g_grid)\n\n        # 4. Compute the finite-difference estimator E_FD.\n        q1_plus = (c + delta) / q1_denom\n        q1_minus = (c - delta) / q1_denom\n        \n        g_plus = compute_g(q1_plus, q2_grid)\n        g_minus = compute_g(q1_minus, q2_grid)\n\n        E_fd_values = (0.5 / delta) * (np.log(g_plus) - np.log(g_minus))\n\n        # 5. Compute the canonical weights for the ensemble average.\n        potential_U = 0.5 * k * (q1_grid**2 + q2_grid**2)\n        weights_unnormalized = np.exp(-potential_U / T) / (1 + gamma * q2_grid**2.0)\n        \n        # Normalize weights to get probabilities p_i\n        p_weights = weights_unnormalized / np.sum(weights_unnormalized)\n\n        # 6. Compute the ensemble variances.\n        avg_E_lambda = np.sum(p_weights * E_lambda_values)\n        var_E_lambda = np.sum(p_weights * (E_lambda_values - avg_E_lambda)**2)\n\n        avg_E_fd = np.sum(p_weights * E_fd_values)\n        var_E_fd = np.sum(p_weights * (E_fd_values - avg_E_fd)**2)\n\n        return var_E_lambda, var_E_fd\n\n    results = []\n    for case in test_cases:\n        var_lam, var_fd = compute_variances(case)\n        results.append(var_lam)\n        results.append(var_fd)\n\n    # Print the final results in the specified format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "蓝月亮系综公式的最后一部分是约束力平均值，其统计收敛可能很慢。这项高级练习介绍了一种强大的方差缩减技术，该技术使用从系统动力学算符导出的控制变量。通过对一个模型系统进行解析求解，您将理解构建高效估计量的原理，这对于实际的自由能计算至关重要 。",
            "id": "3398631",
            "problem": "您将设计并分析一个方差缩减估计量，用于在一个简单但非平凡的、使用蓝月亮系综的分子动力学设置中，计算约束自由能的导数。目标是推导出一个关于自由能对反应坐标导数的估计量，使用局部二次模型构建控制变量，并根据约束动力学生成元的谱性质来量化渐近方差。然后，实现一个程序，为指定的测试套件计算得出的量。\n\n考虑一个二维构型向量 $q = (x,y) \\in \\mathbb{R}^2$，其具有由反应坐标 $\\xi(q) = x$ 定义的可分离完整约束。该约束以 $x = \\xi_0$ 的形式施加，从而将动力学限制在一维流形 $M_{\\xi_0} = \\{(x,y) \\in \\mathbb{R}^2 : x = \\xi_0\\}$ 上。物理系统由一个势能函数 $V(q)$ 描述，该函数二次可微且允许局部二次展开。您将研究由在 $\\xi$ 上的平衡边际分布定义的约束自由能 $A(\\xi)$ 及其在 $x = \\xi_0$ 处求值的导数 $dA/d\\xi$。\n\n**使用以下合法的建模框架：**\n\n- 动力学是过阻尼的，并在恒定温度下发生，玻尔兹曼常数为 $k_B$，绝对温度为 $T$，摩擦系数为 $\\gamma > 0$。\n- 构型被约束在流形 $M_{\\xi_0}$ 上，其中 $x = \\xi_0$，并且动力学仅沿 $y$ 方向演化。\n- 势能被指定为二次模型\n  $$V(x,y) = \\frac{1}{2} k_x x^2 + \\frac{1}{2} k_y y^2 + k_{xy} x y,$$\n  其中 $k_x > 0$，$k_y > 0$，而 $k_{xy}$ 是任意实标量耦合。\n\n**从以下基础出发，不使用任何关于目标量或方差的预先推导出的公式：**\n\n1.  过阻尼极限下的牛顿力学，导出沿约束流形的过阻尼朗之万方程，其漂移项与沿流形的势的负梯度成正比，扩散项与涨落-耗散定理一致。\n2.  约束自由能 $A(\\xi)$ 的统计力学定义，源于在固定 $\\xi$ 下边缘化的玻尔兹曼分布。\n3.  约束动力学的无穷小生成元的定义及其谱性质，包括对线性系统平稳性和自相关衰减的解释。\n\n**任务：**\n\n1.  在此设置中，推导约束自由能的导数 $dA/d\\xi$ 在 $x = \\xi_0$ 处的表达式，表示为关于在 $M_{\\xi_0}$ 上的平稳约束分布的期望值。\n2.  推导沿 $M_{\\xi_0}$ 的约束过阻尼朗之万动力学生成元，并确定其在局部二次势模型下的谱。\n3.  使用通过将生成元应用于从与 $V(q)$ 的局部二次模型和在 $\\xi_0$ 附近的粗粒化自由能 $U_F(\\xi)$ 的二次模型对齐的局部二次函数族中选择的函数 $\\psi(y)$ 所获得的控制变量，构建 $dA/d\\xi$ 的方差缩减估计量。确保该控制变量在平稳约束分布下的期望为零，并确定使渐近方差最小化的系数选择。\n4.  用生成元的谱来表示时间平均估计量和方差缩减估计量的渐近方差。在此二次设置中提供一个闭式量化。\n\n**实现要求：**\n\n- 使用约化单位，其中 $k_B T = 1$，所有物理量均以这些约化单位表示。因此，所有数值输出均报告为无单位量。\n- 对于给定的参数集 $(k_x,k_y,k_{xy},\\gamma,\\xi_0)$，计算并返回：\n  - 在 $x = \\xi_0$ 处 $dA/d\\xi$ 的精确值。\n  - 在约束动力学下，对 $dA/d\\xi$ 的朴素时间平均估计量的渐近方差。\n  - 使用基于生成元的控制变量（其系数由局部二次模型参数确定）的最优方差缩减估计量的渐近方差。\n  - 一个错误指定的方差缩减估计量的渐近方差，其中控制变量使用扰动后的局部二次参数 $(\\widehat{k}_y,\\widehat{k}_{xy})$（在测试套件中提供）。\n\n**您的程序必须在没有任何模拟的情况下，使用推导出的解析关系确定性地实现这些计算，并为以下参数值的测试套件生成输出：**\n\n- 测试用例1（一般情况）：\n  - $k_x = 2.0$, $k_y = 4.0$, $k_{xy} = 1.5$, $\\gamma = 1.0$, $\\xi_0 = 0.3$, $k_B T = 1.0$\n  - 错误指定因子：$\\widehat{k}_y = 0.9\\,k_y$, $\\widehat{k}_{xy} = 1.1\\,k_{xy}$\n- 测试用例2（解耦边界，零耦合）：\n  - $k_x = 3.5$, $k_y = 2.0$, $k_{xy} = 0.0$, $\\gamma = 1.25$, $\\xi_0 = -0.2$, $k_B T = 1.0$\n  - 错误指定因子：$\\widehat{k}_y = 1.2\\,k_y$, $\\widehat{k}_{xy} = 0.8\\,k_{xy}$\n- 测试用例3（刚性横向模式）：\n  - $k_x = 1.0$, $k_y = 100.0$, $k_{xy} = 2.0$, $\\gamma = 0.5$, $\\xi_0 = 0.1$, $k_B T = 1.0$\n  - 错误指定因子：$\\widehat{k}_y = 1.1\\,k_y$, $\\widehat{k}_{xy} = 0.95\\,k_{xy}$\n- 测试用例4（负耦合和较大摩擦）：\n  - $k_x = 0.7$, $k_y = 3.0$, $k_{xy} = -1.0$, $\\gamma = 2.0$, $\\xi_0 = -0.4$, $k_B T = 1.0$\n  - 错误指定因子：$\\widehat{k}_y = 0.85\\,k_y$, $\\widehat{k}_{xy} = 1.05\\,k_{xy}$\n\n对于每个测试用例，您的程序应按上述顺序列出四个计算出的量。您的程序应生成单行输出，其中包含来自四个测试用例的所有结果，连接成一个用方括号括起来的逗号分隔列表。例如，最终输出格式必须是：\n\"[mu1,naive_var1,cv_opt_var1,cv_mis_var1,mu2,naive_var2,cv_opt_var2,cv_mis_var2,mu3,naive_var3,cv_opt_var3,cv_mis_var3,mu4,naive_var4,cv_opt_var4,cv_mis_var4]\"。",
            "solution": "问题是为受完整约束 $x=\\xi_0$ 的、在二维二次势 $V(x,y)$ 中运动的粒子，推导并实现其约束自由能导数 $dA/d\\xi$ 的估计量。该分析植根于蓝月亮系综框架和过阻尼朗之万动力学。我们将使用基于生成元的控制变量来减少估计量的方差。我们在 $k_B T = 1$ 的约化单位下进行操作。\n\n势能由下式给出：\n$$V(x,y) = \\frac{1}{2} k_x x^2 + \\frac{1}{2} k_y y^2 + k_{xy} x y$$\n反应坐标为 $\\xi(q) = x$，系统被约束在流形 $M_{\\xi_0}$ 上，其中 $x = \\xi_0$。\n\n**1. 约束自由能的导数**\n\n约束自由能 $A(\\xi)$ 通过约束流形上的配分函数 $Z(\\xi) = \\int e^{-\\beta V(\\xi, y)} dy$ 定义。\n$$A(\\xi) = -k_B T \\ln Z(\\xi) = -\\frac{1}{\\beta} \\ln \\int e^{-\\beta V(\\xi, y)} dy$$\n使用 $\\beta = 1/(k_B T) = 1$，对 $\\xi$ 的导数通过链式法则求得：\n$$\\frac{dA}{d\\xi} = -\\frac{d}{d\\xi} \\ln \\int e^{-V(\\xi, y)} dy = -\\frac{1}{Z(\\xi)} \\int \\left(-\\frac{\\partial V}{\\partial\\xi}\\right) e^{-V(\\xi, y)} dy$$\n这可以简化为与 $\\xi$ 共轭的广义力的系综平均值：\n$$\\frac{dA}{d\\xi} = \\frac{\\int \\frac{\\partial V(\\xi, y)}{\\partial \\xi} e^{-V(\\xi, y)} dy}{\\int e^{-V(\\xi, y)} dy} = \\left\\langle \\frac{\\partial V}{\\partial \\xi} \\right\\rangle_\\xi$$\n其中 $\\langle \\cdot \\rangle_\\xi$ 表示关于流形 $M_\\xi$ 上的平稳（玻尔兹曼）分布的期望。\n对于我们的系统，$\\xi = x$，所以 $\\partial V/\\partial\\xi = \\partial V/\\partial x = k_x x + k_{xy} y$。\n在流形 $M_{\\xi_0}$ 上，其中 $x=\\xi_0$，自由能导数的表达式为：\n$$\\mu \\equiv \\frac{dA}{d\\xi}\\bigg|_{\\xi_0} = \\langle k_x \\xi_0 + k_{xy} y \\rangle_{\\xi_0} = k_x \\xi_0 + k_{xy} \\langle y \\rangle_{\\xi_0}$$\n要从分子动力学模拟中估计的量是可观测量 $f(y) = k_x \\xi_0 + k_{xy} y$。\n\n为了找到 $\\mu$ 的精确值，我们必须计算 $\\langle y \\rangle_{\\xi_0}$。在 $M_{\\xi_0}$ 上 $y$ 的平稳概率分布为 $p(y|\\xi_0) \\propto e^{-V(\\xi_0, y)}$。限制在流形上的势为：\n$$V(\\xi_0, y) = \\frac{1}{2} k_y y^2 + k_{xy} \\xi_0 y + \\frac{1}{2} k_x \\xi_0^2$$\n这是 $y$ 的二次函数，意味着 $p(y|\\xi_0)$ 是一个高斯分布。均值 $\\langle y \\rangle_{\\xi_0}$ 对应于 $V(\\xi_0, y)$ 的最小值，该值通过设置 $\\partial V(\\xi_0, y) / \\partial y = 0$ 找到。\n$$\\frac{\\partial V}{\\partial y} = k_y y + k_{xy} \\xi_0 = 0 \\implies \\langle y \\rangle_{\\xi_0} = -\\frac{k_{xy} \\xi_0}{k_y}$$\n将此代入 $\\mu$ 的表达式中：\n$$\\mu = k_x \\xi_0 + k_{xy} \\left(-\\frac{k_{xy} \\xi_0}{k_y}\\right) = \\left(k_x - \\frac{k_{xy}^2}{k_y}\\right) \\xi_0$$\n这是在 $\\xi_0$ 处自由能导数的精确解析值。\n\n**2. 约束动力学与生成元**\n\n在 $M_{\\xi_0}$ 上的动力学仅在 $y$ 坐标上进行。过阻尼朗之万方程为：\n$$\\gamma \\dot{y} = F_y + \\sqrt{2\\gamma k_B T} R(t) = -\\frac{\\partial V(\\xi_0, y)}{\\partial y} + \\sqrt{2\\gamma} R(t)$$\n$$\\gamma \\dot{y} = -(k_y y + k_{xy} \\xi_0) + \\sqrt{2\\gamma} R(t)$$\n这描述了一个奥恩斯坦-乌伦贝克过程。相应的福克-普朗克生成元 $\\mathcal{L}$ 作用于一个测试函数 $\\phi(y)$ 上，为：\n$$\\mathcal{L}\\phi(y) = \\left[-\\frac{1}{\\gamma}(k_y y + k_{xy} \\xi_0)\\right] \\frac{d\\phi}{dy} + \\frac{1}{\\gamma} \\frac{d^2\\phi}{dy^2}$$\n中心化坐标 $y_c = y - \\langle y \\rangle_{\\xi_0}$ 的动力学更简单：$\\gamma \\dot{y}_c = -k_y y_c + \\sqrt{2\\gamma} R(t)$。该过程具有单一的弛豫速率 $\\lambda_1 = k_y/\\gamma$，这是 $-\\mathcal{L}$ 的第一个非零特征值。$\\mathcal{L}$ 的谱由 $\\{-n\\lambda_1\\}_{n=0}^\\infty = \\{-n \\frac{k_y}{\\gamma}\\}_{n=0}^\\infty$ 给出。\n\n**3. 估计量的渐近方差**\n\n可观测量 $A$ 的时间平均估计量的渐近方差由其自相关函数的积分给出：$\\sigma^2_{\\bar{A}} = 2 \\int_0^\\infty C_{AA}(\\tau) d\\tau$。\n\n**朴素估计量：**\n可观测量为 $f(y) = k_x \\xi_0 + k_{xy} y$。其涨落部分为 $f(y) - \\mu = k_{xy}(y - \\langle y \\rangle_{\\xi_0}) = k_{xy} y_c$。\n对于奥恩斯坦-乌伦贝克过程，$y_c$ 的自相关函数为 $C_{y_c y_c}(\\tau) = \\langle y_c^2 \\rangle_{\\xi_0} e^{-\\lambda_1 |\\tau|}$。在约束系综中 $y$ 的方差为 $\\langle y_c^2 \\rangle_{\\xi_0} = 1/k_y$。\n$$C_{ff}(\\tau) = \\langle (k_{xy} y_c(\\tau))(k_{xy} y_c(0)) \\rangle = k_{xy}^2 C_{y_c y_c}(\\tau) = \\frac{k_{xy}^2}{k_y} e^{-(k_y/\\gamma)|\\tau|}$$\n朴素估计量的渐近方差为：\n$$\\sigma^2_{\\text{naive}} = 2 \\int_0^\\infty \\frac{k_{xy}^2}{k_y} e^{-(k_y/\\gamma)\\tau} d\\tau = 2 \\frac{k_{xy}^2}{k_y} \\left(\\frac{\\gamma}{k_y}\\right) = \\frac{2\\gamma k_{xy}^2}{k_y^2}$$\n\n**方差缩减估计量：**\n可以构建一个期望为零的控制变量 $g(y)$，其形式为 $g = \\mathcal{L}\\psi$，其中 $\\psi(y)$ 是某个函数。方差缩减的可观测量为 $f^* = f + g = f + \\mathcal{L}\\psi$。目标是选择 $\\psi$ 使 $f^*$ 的方差最小，这通过使 $f+\\mathcal{L}\\psi$ 尽可能接近常数来实现。这导出了关于 $\\psi$ 的泊松方程：$\\mathcal{L}\\psi \\approx -(f - \\mu)$。\n\n对于我们的问题，$f - \\mu = k_{xy} y_c$。我们寻找一个形式为 $\\psi(y) = c y$ 的解。\n$$\\mathcal{L}(cy) = c \\mathcal{L}y = c \\left( -\\frac{1}{\\gamma}(k_y y + k_{xy}\\xi_0) \\cdot 1 + 0 \\right) = -\\frac{c k_y}{\\gamma} (y + \\frac{k_{xy}\\xi_0}{k_y}) = -\\frac{c k_y}{\\gamma} y_c$$\n为了解 $\\mathcal{L}(cy) = -k_{xy} y_c$，我们设置 $-\\frac{c k_y}{\\gamma} y_c = -k_{xy} y_c$，得到 $c = \\frac{k_{xy}\\gamma}{k_y}$。\n因此，最优选择是 $\\psi_{opt}(y) = \\frac{k_{xy}\\gamma}{k_y} y$。\n有了这个 $\\psi_{opt}$，控制变量为 $g_{opt} = \\mathcal{L}\\psi_{opt} = -k_{xy} y_c = -(f-\\mu)$。\n新可观量的涨落部分是 $(f-\\mu) + g_{opt} = (f-\\mu) - (f-\\mu) = 0$。\n这个新可观量的方差为零。因此，渐近方差也为零。这种完全抵消是二次势和线性可观测量的一个特殊特性。\n$$\\sigma^2_{\\text{cv\\_opt}} = 0$$\n\n**错误指定估计量：**\n现在，控制变量是基于一个具有参数 $\\widehat{k}_y$ 和 $\\widehat{k}_{xy}$ 的错误指定模型构建的。我们构建一个对于这个“帽子”模型而言最优的函数 $\\widehat{\\psi}$，然后将真实的生成元 $\\mathcal{L}$ 应用于它。\n与最优情况类比，$\\widehat{\\psi}(y) = \\frac{\\widehat{k}_{xy}\\gamma}{\\widehat{k}_y} y$。\n控制变量为 $g_{mis} = \\mathcal{L}\\widehat{\\psi} = \\mathcal{L}\\left(\\frac{\\widehat{k}_{xy}\\gamma}{\\widehat{k}_y} y\\right) = \\frac{\\widehat{k}_{xy}\\gamma}{\\widehat{k}_y} \\mathcal{L}y$。\n使用 $\\mathcal{L}y = -(k_y/\\gamma)y_c$，我们得到：\n$$g_{mis} = \\frac{\\widehat{k}_{xy}\\gamma}{\\widehat{k}_y} \\left(-\\frac{k_y}{\\gamma} y_c\\right) = -\\frac{\\widehat{k}_{xy} k_y}{\\widehat{k}_y} y_c$$\n估计量 $f_{mis}^* = f + g_{mis}$ 的残余涨落为：\n$$R(y) = (f-\\mu) + g_{mis} = k_{xy} y_c - \\frac{\\widehat{k}_{xy} k_y}{\\widehat{k}_y} y_c = \\left( k_{xy} - \\frac{k_y \\widehat{k}_{xy}}{\\widehat{k}_y} \\right) y_c$$\n这个残差的自相关函数为 $C_{RR}(\\tau) = \\langle R(y(t))R(y(0)) \\rangle = \\left( k_{xy} - \\frac{k_y \\widehat{k}_{xy}}{\\widehat{k}_y} \\right)^2 C_{y_c y_c}(\\tau)$。\n渐近方差为：\n$$\\sigma^2_{\\text{cv\\_mis}} = 2 \\int_0^\\infty C_{RR}(\\tau) d\\tau = \\left( k_{xy} - \\frac{k_y \\widehat{k}_{xy}}{\\widehat{k}_y} \\right)^2 \\left( 2\\int_0^\\infty C_{y_c y_c}(\\tau) d\\tau \\right)$$\n积分项是 $y_c$ 的渐近方差，即 $2 \\text{Var}(y_c) \\tau_c = 2 (1/k_y) (\\gamma/k_y) = 2\\gamma/k_y^2$。\n因此，\n$$\\sigma^2_{\\text{cv\\_mis}} = \\frac{2\\gamma}{k_y^2} \\left( k_{xy} - k_y \\frac{\\widehat{k}_{xy}}{\\widehat{k}_y} \\right)^2$$\n当 $\\widehat{k}_y=k_y$ 和 $\\widehat{k}_{xy}=k_{xy}$ 时，该公式正确地恢复为 $\\sigma^2_{\\text{cv\\_mis}}=0$。\n\n我们现在拥有所有必要的解析表达式，来为测试套件计算所需的量。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n# No other libraries are needed.\n\ndef solve():\n    \"\"\"\n    Computes analytical results for a Blue Moon ensemble problem.\n\n    For a 2D system with a quadratic potential and a linear constraint, this\n    function calculates:\n    1. The exact derivative of the constrained free energy (dA/dxi).\n    2. The asymptotic variance of the naive estimator for dA/dxi.\n    3. The asymptotic variance of the optimally-reduced control variate estimator.\n    4. The asymptotic variance of a mis-specified control variate estimator.\n\n    The calculations are based on derived analytical formulas, not simulations.\n    \"\"\"\n    # Test cases defined in the problem statement.\n    # Each tuple is: (k_x, k_y, k_xy, gamma, xi_0, k_y_hat_factor, k_xy_hat_factor)\n    test_cases = [\n        (2.0, 4.0, 1.5, 1.0, 0.3, 0.9, 1.1),\n        (3.5, 2.0, 0.0, 1.25, -0.2, 1.2, 0.8),\n        (1.0, 100.0, 2.0, 0.5, 0.1, 1.1, 0.95),\n        (0.7, 3.0, -1.0, 2.0, -0.4, 0.85, 1.05)\n    ]\n\n    results = []\n\n    for case in test_cases:\n        k_x, k_y, k_xy, gamma, xi_0, ky_hat_factor, kxy_hat_factor = case\n\n        # 1. Exact value of dA/dxi at xi_0\n        # Formula: mu = (k_x - k_xy^2 / k_y) * xi_0\n        mu = (k_x - k_xy**2 / k_y) * xi_0\n\n        # 2. Asymptotic variance of the naive time-average estimator\n        # Formula: sigma^2_naive = 2 * gamma * k_xy^2 / k_y^2\n        if k_y == 0:\n             # Should not happen based on problem constraints (k_y > 0)\n            naive_var = float('inf')\n        else:\n            naive_var = (2 * gamma * k_xy**2) / k_y**2\n\n        # 3. Asymptotic variance of the optimally variance-reduced estimator\n        # For the quadratic model, this is zero.\n        cv_opt_var = 0.0\n\n        # 4. Asymptotic variance of the mis-specified variance-reduced estimator\n        # Perturbed parameters\n        k_y_hat = ky_hat_factor * k_y\n        k_xy_hat = kxy_hat_factor * k_xy\n        \n        # Formula: sigma^2_mis = (2*gamma/k_y^2) * (k_xy - k_y * k_xy_hat / k_y_hat)^2\n        if k_y == 0 or k_y_hat == 0:\n            # Should not happen\n            cv_mis_var = float('inf')\n        else:\n            residual_coeff = k_xy - k_y * k_xy_hat / k_y_hat\n            cv_mis_var = (2 * gamma / k_y**2) * residual_coeff**2\n            \n        results.extend([mu, naive_var, cv_opt_var, cv_mis_var])\n\n    # Final print statement in the exact required format.\n    # Using np.format_float_positional to avoid scientific notation and trailing zeros.\n    formatted_results = [np.format_float_positional(r, trim='-') for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}