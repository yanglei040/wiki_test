{
    "hands_on_practices": [
        {
            "introduction": "理论学习的最佳方式莫过于从第一性原理出发进行推导。本练习将引导你为最简单的约束系统——由单个键连接的两个原子——推导出SHAKE算法的核心方程。通过运用拉格朗日乘子法，你将亲身体验如何在满足键长约束的同时，最小化原子位置的质量加权位移，从而深刻理解SHAKE算法的精髓。",
            "id": "3444923",
            "problem": "考虑一个分子动力学 (MD) 模拟中的两个原子 $i$ 和 $j$，其质量分别为 $m_i$ 和 $m_j$。在一个时间步长内进行无约束的位置更新后，它们预测的位置为 $\\tilde{\\mathbf{r}}_i$ 和 $\\tilde{\\mathbf{r}}_j$。一个完整的键长约束要求最终的、校正后的位置 $\\mathbf{r}_i = \\tilde{\\mathbf{r}}_i + \\delta \\mathbf{r}_i$ 和 $\\mathbf{r}_j = \\tilde{\\mathbf{r}}_j + \\delta \\mathbf{r}_j$ 满足 $|\\mathbf{r}_i - \\mathbf{r}_j| = d$，其中 $d$ 是一个预设的恒定键长。定义 $\\tilde{\\mathbf{r}}_{ij} \\equiv \\tilde{\\mathbf{r}}_i - \\tilde{\\mathbf{r}}_j$ 并假设 $|\\tilde{\\mathbf{r}}_{ij}| \\neq 0$。\n\n仅使用第一性原理（牛顿力学、完整约束，以及 SHAKE 算法的定义原则，即位置校正量在时间步结束时精确满足约束的条件下，使质量加权位移最小化），推导位置校正量 $\\delta \\mathbf{r}_i$ 和 $\\delta \\mathbf{r}_j$ 的闭式表达式，以精确地对这个单键实施约束。\n\n用 $m_i$、$m_j$、$\\tilde{\\mathbf{r}}_{ij}$ 和 $d$ 来表示您的最终答案。选择能够产生从 $(\\tilde{\\mathbf{r}}_i, \\tilde{\\mathbf{r}}_j)$ 出发的最小质量加权位移、并且保留原始键方向的解，并假设不存在其他约束。\n\n以单行矩阵的形式给出 $\\delta \\mathbf{r}_i$ 和 $\\delta \\mathbf{r}_j$ 对作为最终答案。不需要进行数值计算，且最终答案中不应包含单位。",
            "solution": "问题要求推导质量分别为 $m_i$ 和 $m_j$ 的两个原子的位置校正量 $\\delta \\mathbf{r}_i$ 和 $\\delta \\mathbf{r}_j$，以满足单个键长约束。推导基于 SHAKE 算法的核心原则：校正量必须在精确满足约束的同时，最小化总的质量加权位移平方。\n\n目标是最小化函数 $S$：\n$$S(\\delta \\mathbf{r}_i, \\delta \\mathbf{r}_j) = m_i |\\delta \\mathbf{r}_i|^2 + m_j |\\delta \\mathbf{r}_j|^2$$\n约束条件为原子间的最终距离为恒定距离 $d$ 的完整约束。最终位置由 $\\mathbf{r}_i = \\tilde{\\mathbf{r}}_i + \\delta \\mathbf{r}_i$ 和 $\\mathbf{r}_j = \\tilde{\\mathbf{r}}_j + \\delta \\mathbf{r}_j$ 给出，其中 $\\tilde{\\mathbf{r}}_i$ 和 $\\tilde{\\mathbf{r}}_j$ 是无约束的预测位置。\n\n约束方程为：\n$$\\sigma(\\mathbf{r}_i, \\mathbf{r}_j) = |\\mathbf{r}_i - \\mathbf{r}_j|^2 - d^2 = 0$$\n使用校正后位置的定义，约束方程变为：\n$$|(\\tilde{\\mathbf{r}}_i + \\delta \\mathbf{r}_i) - (\\tilde{\\mathbf{r}}_j + \\delta \\mathbf{r}_j)|^2 - d^2 = 0$$\n令 $\\tilde{\\mathbf{r}}_{ij} = \\tilde{\\mathbf{r}}_i - \\tilde{\\mathbf{r}}_j$。则约束方程为：\n$$|\\tilde{\\mathbf{r}}_{ij} + \\delta \\mathbf{r}_i - \\delta \\mathbf{r}_j|^2 - d^2 = 0$$\n\n这是一个约束优化问题，我们将使用拉格朗日乘数法来求解。我们定义拉格朗日函数 $\\mathcal{L}$：\n$$\\mathcal{L} = m_i |\\delta \\mathbf{r}_i|^2 + m_j |\\delta \\mathbf{r}_j|^2 - \\lambda (|\\tilde{\\mathbf{r}}_{ij} + \\delta \\mathbf{r}_i - \\delta \\mathbf{r}_j|^2 - d^2)$$\n其中 $\\lambda$ 是拉格朗日乘数。为求最小值，我们将 $\\mathcal{L}$ 对优化变量 $\\delta \\mathbf{r}_i$ 和 $\\delta \\mathbf{r}_j$ 的梯度设为零。\n\n对 $\\delta \\mathbf{r}_i$ 求梯度：\n$$\\nabla_{\\delta \\mathbf{r}_i} \\mathcal{L} = 2 m_i \\delta \\mathbf{r}_i - 2 \\lambda (\\tilde{\\mathbf{r}}_{ij} + \\delta \\mathbf{r}_i - \\delta \\mathbf{r}_j) = \\mathbf{0}$$\n对 $\\delta \\mathbf{r}_j$ 求梯度：\n$$\\nabla_{\\delta \\mathbf{r}_j} \\mathcal{L} = 2 m_j \\delta \\mathbf{r}_j - 2 \\lambda (-1) (\\tilde{\\mathbf{r}}_{ij} + \\delta \\mathbf{r}_i - \\delta \\mathbf{r}_j) = \\mathbf{0}$$\n令最终的、校正后的原子间向量为 $\\mathbf{r}_{ij} = \\mathbf{r}_i - \\mathbf{r}_j = \\tilde{\\mathbf{r}}_{ij} + \\delta \\mathbf{r}_i - \\delta \\mathbf{r}_j$。梯度方程简化为：\n$$m_i \\delta \\mathbf{r}_i = \\lambda \\mathbf{r}_{ij}$$\n$$m_j \\delta \\mathbf{r}_j = - \\lambda \\mathbf{r}_{ij}$$\n从这两个方程中，我们可以用 $\\lambda$ 和 $\\mathbf{r}_{ij}$ 解出位置校正量 $\\delta \\mathbf{r}_i$ 和 $\\delta \\mathbf{r}_j$：\n$$\\delta \\mathbf{r}_i = \\frac{\\lambda}{m_i} \\mathbf{r}_{ij}$$\n$$\\delta \\mathbf{r}_j = -\\frac{\\lambda}{m_j} \\mathbf{r}_{ij}$$\n一个直接的推论是 $m_i \\delta \\mathbf{r}_i + m_j \\delta \\mathbf{r}_j = \\mathbf{0}$。这表明校正不会使双原子系统的质心发生位移，这是内力的一个基本性质。\n\n现在，我们将这些表达式代回到 $\\mathbf{r}_{ij}$ 的定义中：\n$$\\mathbf{r}_{ij} = \\tilde{\\mathbf{r}}_{ij} + \\delta \\mathbf{r}_i - \\delta \\mathbf{r}_j = \\tilde{\\mathbf{r}}_{ij} + \\left(\\frac{\\lambda}{m_i} \\mathbf{r}_{ij}\\right) - \\left(-\\frac{\\lambda}{m_j} \\mathbf{r}_{ij}\\right)$$\n$$\\mathbf{r}_{ij} = \\tilde{\\mathbf{r}}_{ij} + \\lambda \\left(\\frac{1}{m_i} + \\frac{1}{m_j}\\right) \\mathbf{r}_{ij}$$\n重新整理各项以求解 $\\mathbf{r}_{ij}$：\n$$\\mathbf{r}_{ij} \\left[1 - \\lambda \\left(\\frac{1}{m_i} + \\frac{1}{m_j}\\right)\\right] = \\tilde{\\mathbf{r}}_{ij}$$\n这个方程表明，最终的原子间向量 $\\mathbf{r}_{ij}$ 必须与无约束的原子间向量 $\\tilde{\\mathbf{r}}_{ij}$ 平行。约束要求 $\\mathbf{r}_{ij}$ 的大小为 $d$，即 $|\\mathbf{r}_{ij}| = d$。问题陈述还指明应保留原始的键方向。这意味着 $\\mathbf{r}_{ij}$ 必须与 $\\tilde{\\mathbf{r}}_{ij}$ 指向相同的方向。因此，我们可以写出：\n$$\\mathbf{r}_{ij} = d \\frac{\\tilde{\\mathbf{r}}_{ij}}{|\\tilde{\\mathbf{r}}_{ij}|}$$\n这是有效的，因为问题陈述中说明了 $|\\tilde{\\mathbf{r}}_{ij}| \\neq 0$。\n\n我们现在可以通过将这个 $\\mathbf{r}_{ij}$ 的表达式代入整理后的方程来确定拉格朗日乘数 $\\lambda$：\n$$\\left(d \\frac{\\tilde{\\mathbf{r}}_{ij}}{|\\tilde{\\mathbf{r}}_{ij}|}\\right) \\left[1 - \\lambda \\left(\\frac{1}{m_i} + \\frac{1}{m_j}\\right)\\right] = \\tilde{\\mathbf{r}}_{ij}$$\n将两边同时除以向量 $\\tilde{\\mathbf{r}}_{ij}$（或者，更正式地说，取两边的模）得到一个标量方程：\n$$\\frac{d}{|\\tilde{\\mathbf{r}}_{ij}|} \\left[1 - \\lambda \\left(\\frac{1}{m_i} + \\frac{1}{m_j}\\right)\\right] = 1$$\n求解 $\\lambda$：\n$$1 - \\lambda \\left(\\frac{1}{m_i} + \\frac{1}{m_j}\\right) = \\frac{|\\tilde{\\mathbf{r}}_{ij}|}{d}$$\n$$\\lambda \\left(\\frac{m_i + m_j}{m_i m_j}\\right) = 1 - \\frac{|\\tilde{\\mathbf{r}}_{ij}|}{d}$$\n$$\\lambda = \\frac{m_i m_j}{m_i+m_j} \\left(1 - \\frac{|\\tilde{\\mathbf{r}}_{ij}|}{d}\\right)$$\n现在我们有了求出 $\\delta \\mathbf{r}_i$ 和 $\\delta \\mathbf{r}_j$ 最终表达式所需的所有组件。将 $\\lambda$ 和 $\\mathbf{r}_{ij}$ 的表达式代入校正方程中：\n对于 $\\delta \\mathbf{r}_i$：\n$$\\delta \\mathbf{r}_i = \\frac{\\lambda}{m_i} \\mathbf{r}_{ij} = \\frac{1}{m_i} \\left[\\frac{m_i m_j}{m_i+m_j} \\left(1 - \\frac{|\\tilde{\\mathbf{r}}_{ij}|}{d}\\right)\\right] \\left(d \\frac{\\tilde{\\mathbf{r}}_{ij}}{|\\tilde{\\mathbf{r}}_{ij}|}\\right)$$\n$$\\delta \\mathbf{r}_i = \\frac{m_j}{m_i+m_j} \\left(\\frac{d - |\\tilde{\\mathbf{r}}_{ij}|}{d}\\right) \\frac{d}{|\\tilde{\\mathbf{r}}_{ij}|} \\tilde{\\mathbf{r}}_{ij}$$\n$$\\delta \\mathbf{r}_i = \\frac{m_j}{m_i+m_j} \\left(\\frac{d - |\\tilde{\\mathbf{r}}_{ij}|}{|\\tilde{\\mathbf{r}}_{ij}|}\\right) \\tilde{\\mathbf{r}}_{ij}$$\n这可以更简洁地写成：\n$$\\delta \\mathbf{r}_i = \\frac{m_j}{m_i+m_j} \\left(\\frac{d}{|\\tilde{\\mathbf{r}}_{ij}|} - 1\\right) \\tilde{\\mathbf{r}}_{ij}$$\n对于 $\\delta \\mathbf{r}_j$：\n$$\\delta \\mathbf{r}_j = -\\frac{\\lambda}{m_j} \\mathbf{r}_{ij} = -\\frac{1}{m_j} \\left[\\frac{m_i m_j}{m_i+m_j} \\left(1 - \\frac{|\\tilde{\\mathbf{r}}_{ij}|}{d}\\right)\\right] \\left(d \\frac{\\tilde{\\mathbf{r}}_{ij}}{|\\tilde{\\mathbf{r}}_{ij}|}\\right)$$\n$$\\delta \\mathbf{r}_j = -\\frac{m_i}{m_i+m_j} \\left(\\frac{d - |\\tilde{\\mathbf{r}}_{ij}|}{d}\\right) \\frac{d}{|\\tilde{\\mathbf{r}}_{ij}|} \\tilde{\\mathbf{r}}_{ij}$$\n$$\\delta \\mathbf{r}_j = -\\frac{m_i}{m_i+m_j} \\left(\\frac{d - |\\tilde{\\mathbf{r}}_{ij}|}{|\\tilde{\\mathbf{r}}_{ij}|}\\right) \\tilde{\\mathbf{r}}_{ij}$$\n它可以写成：\n$$\\delta \\mathbf{r}_j = -\\frac{m_i}{m_i+m_j} \\left(\\frac{d}{|\\tilde{\\mathbf{r}}_{ij}|} - 1\\right) \\tilde{\\mathbf{r}}_{ij}$$\n这些就是位置校正的闭式表达式，它们在最小化质量加权位移的同时，精确地满足键长约束。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{m_j}{m_i+m_j} \\left(\\frac{d}{|\\tilde{\\mathbf{r}}_{ij}|} - 1\\right) \\tilde{\\mathbf{r}}_{ij}  -\\frac{m_i}{m_i+m_j} \\left(\\frac{d}{|\\tilde{\\mathbf{r}}_{ij}|} - 1\\right) \\tilde{\\mathbf{r}}_{ij}\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "在掌握了双原子体系的解析解之后，我们需要将目光投向更真实的复杂分子系统。在这些系统中，众多约束共存，形成一个需要迭代求解的线性方程组。本练习旨在让你推导构成该方程组的关键“积木”——单个约束的梯度向量 $G(q)$ 和质量加权度量 $A(q)$，为理解和实现处理任意约束网络的通用算法奠定基础。",
            "id": "3444945",
            "problem": "考虑一个三维空间中的 $N$ 个点粒子系统，其位置为 $q = (\\mathbf{r}_{1}, \\mathbf{r}_{2}, \\ldots, \\mathbf{r}_{N}) \\in \\mathbb{R}^{3N}$，正质量为 $m_{1}, m_{2}, \\ldots, m_{N}$。粒子 $i$ 和 $j$ 之间的约束是完整约束，由下式给出\n$$\ng(q) = \\|\\mathbf{r}_{i} - \\mathbf{r}_{j}\\|^{2} - d^{2},\n$$\n其中 $d  0$ 是一个给定的距离，$\\|\\cdot\\|$ 表示 $\\mathbb{R}^{3}$ 中的欧几里得范数。设 $G(q)$ 是 $g$ 关于 $q$ 的雅可比行向量，即 $G(q) = \\nabla_{q} g(q)$，并设质量矩阵为\n$$\nM = \\mathrm{diag}(m_{1} I_{3}, m_{2} I_{3}, \\ldots, m_{N} I_{3}) \\in \\mathbb{R}^{3N \\times 3N},\n$$\n其中 $I_{3}$ 是 $3 \\times 3$ 的单位矩阵。在诸如 SHAKE 和 RATTLE 的约束算法族中，标量\n$$\nA(q) = \\nabla g(q)^{\\top} M^{-1} \\nabla g(q)\n$$\n作为约束梯度的质量加权度量出现。\n\n从给定的定义出发，利用标准的多变量微积分以及 $M$ 的块对角结构，计算 $G(q)$ 中对应于粒子 $i$ 和 $j$ 的非零项，并推导出 $A(q)$ 关于 $m_{i}$、$m_{j}$ 和相对向量 $\\mathbf{r}_{i} - \\mathbf{r}_{j}$ 的表达式。\n\n您的最终答案必须按顺序提供：$G(q)$ 在粒子 $i$ 处的 3-维非零向量块，$G(q)$ 在粒子 $j$ 处的 3-维非零向量块，以及标量 $A(q)$ 的闭式解析表达式。不需要四舍五入，最终答案中也不需要报告物理单位。",
            "solution": "该问题被验证为具有科学依据、良态且客观。这是计算化学和分子动力学领域中的一个标准推导，特别与 SHAKE 和 RATTLE 等约束算法相关。所有必要信息均已提供，问题没有会妨碍唯一解的矛盾或模糊之处，但需要注意向量和梯度的表示法。\n\n任务是计算约束函数 $g(q)$ 梯度的非零块，然后推导标量 $A(q)$ 的表达式。\n\n约束函数由下式给出\n$$\ng(q) = \\|\\mathbf{r}_{i} - \\mathbf{r}_{j}\\|^{2} - d^{2}\n$$\n其中 $q = (\\mathbf{r}_{1}, \\ldots, \\mathbf{r}_{N})$ 是所有粒子位置的向量。我们可以将范数的平方写成点积形式：\n$$\ng(q) = (\\mathbf{r}_{i} - \\mathbf{r}_{j}) \\cdot (\\mathbf{r}_{i} - \\mathbf{r}_{j}) - d^{2}\n$$\n问题将 $G(q) = \\nabla_q g(q)$ 定义为雅可比行向量。然而，表达式 $A(q) = \\nabla g(q)^{\\top} M^{-1} \\nabla g(q)$ 是一个二次型，要求 $\\nabla g(q)$ 是一个列向量。这是一种常见的记法差异。我们将把 $\\nabla g(q)$ 解释为标准的 $3N \\times 1$ 维梯度列向量。那么雅可比行向量 $G(q)$ 就是 $G(q) = (\\nabla g(q))^\\top$。问题中对“3-维非零向量块”的要求进一步支持了我们应该计算梯度列向量分量的解释。\n\n$g(q)$ 关于完整位置向量 $q$ 的梯度是一个由块组成的列向量，其中每个块是关于粒子位置向量 $\\mathbf{r}_k$ 的梯度：\n$$\n\\nabla_q g(q) = \\begin{pmatrix} \\nabla_{\\mathbf{r}_1} g(q) \\\\ \\vdots \\\\ \\nabla_{\\mathbf{r}_N} g(q) \\end{pmatrix}\n$$\n函数 $g(q)$ 只依赖于 $\\mathbf{r}_i$ 和 $\\mathbf{r}_j$。因此，对于任何 $k \\neq i$ 且 $k \\neq j$ 的粒子 $k$，其梯度块为零：\n$$\n\\nabla_{\\mathbf{r}_k} g(q) = \\mathbf{0} \\quad \\text{for } k \\neq i, j\n$$\n\n我们现在计算梯度的两个非零块。\n\n首先，对于粒子 $i$，我们使用点积梯度的法则 $\\nabla(\\mathbf{u} \\cdot \\mathbf{u}) = 2(\\nabla \\mathbf{u})^\\top \\mathbf{u}$。这里，我们是关于 $\\mathbf{r}_i$ 求梯度。设 $\\mathbf{v}(\\mathbf{r}_i, \\mathbf{r}_j) = \\mathbf{r}_i - \\mathbf{r}_j$。\n$$\n\\nabla_{\\mathbf{r}_i} g(q) = \\nabla_{\\mathbf{r}_i} (\\mathbf{v} \\cdot \\mathbf{v})\n$$\n$\\mathbf{v}$ 关于 $\\mathbf{r}_i$ 的梯度是 $3 \\times 3$ 的单位矩阵 $I_3$，因为 $\\nabla_{\\mathbf{r}_i} \\mathbf{r}_i = I_3$ 且 $\\nabla_{\\mathbf{r}_i} \\mathbf{r}_j = 0$。\n应用链式法则（或向量微积分的乘积法则）：\n$$\n\\nabla_{\\mathbf{r}_i} g(q) = 2 (\\nabla_{\\mathbf{r}_i} \\mathbf{v})^\\top \\mathbf{v} = 2 I_3^\\top (\\mathbf{r}_i - \\mathbf{r}_j) = 2(\\mathbf{r}_i - \\mathbf{r}_j)\n$$\n这是第一个要求的量：对应于粒子 $i$ 的 3-维非零向量块。\n\n其次，对于粒子 $j$，我们类似地计算梯度。\n$\\mathbf{v}$ 关于 $\\mathbf{r}_j$ 的梯度是负单位矩阵 $-I_3$，因为 $\\nabla_{\\mathbf{r}_j} \\mathbf{r}_i = 0$ 且 $\\nabla_{\\mathbf{r}_j} \\mathbf{r}_j = I_3$。\n$$\n\\nabla_{\\mathbf{r}_j} g(q) = 2 (\\nabla_{\\mathbf{r}_j} \\mathbf{v})^\\top \\mathbf{v} = 2 (-I_3)^\\top (\\mathbf{r}_i - \\mathbf{r}_j) = -2(\\mathbf{r}_i - \\mathbf{r}_j)\n$$\n这是第二个要求的量：对应于粒子 $j$ 的 3-维非零向量块。\n\n接下来，我们推导 $A(q)$ 的表达式。其定义为：\n$$\nA(q) = (\\nabla g(q))^{\\top} M^{-1} \\nabla g(q)\n$$\n质量矩阵 $M$ 及其逆矩阵 $M^{-1}$ 都是块对角矩阵：\n$$\nM = \\mathrm{diag}(m_{1} I_{3}, \\ldots, m_{N} I_{3}) \\implies M^{-1} = \\mathrm{diag}(m_{1}^{-1} I_{3}, \\ldots, m_{N}^{-1} I_{3})\n$$\n用梯度块来表示 $A(q)$ 的二次型：\n$$\nA(q) = \\sum_{k=1}^N (\\nabla_{\\mathbf{r}_k} g(q))^\\top (m_k^{-1} I_3) (\\nabla_{\\mathbf{r}_k} g(q))\n$$\n由于当 $k \\ne i, j$ 时梯度块为零，这个和可以简化为两项：\n$$\nA(q) = (\\nabla_{\\mathbf{r}_i} g(q))^\\top (m_i^{-1} I_3) (\\nabla_{\\mathbf{r}_i} g(q)) + (\\nabla_{\\mathbf{r}_j} g(q))^\\top (m_j^{-1} I_3) (\\nabla_{\\mathbf{r}_j} g(q))\n$$\n代入我们找到的梯度块的表达式：\n$$\nA(q) = \\frac{1}{m_i} (2(\\mathbf{r}_i - \\mathbf{r}_j))^\\top (2(\\mathbf{r}_i - \\mathbf{r}_j)) + \\frac{1}{m_j} (-2(\\mathbf{r}_i - \\mathbf{r}_j))^\\top (-2(\\mathbf{r}_i - \\mathbf{r}_j))\n$$\n提出常数因子：\n$$\nA(q) = \\frac{4}{m_i} (\\mathbf{r}_i - \\mathbf{r}_j)^\\top (\\mathbf{r}_i - \\mathbf{r}_j) + \\frac{4}{m_j} (\\mathbf{r}_i - \\mathbf{r}_j)^\\top (\\mathbf{r}_i - \\mathbf{r}_j)\n$$\n注意到 $(\\mathbf{r}_i - \\mathbf{r}_j)^\\top (\\mathbf{r}_i - \\mathbf{r}_j) = \\|\\mathbf{r}_i - \\mathbf{r}_j\\|^2$：\n$$\nA(q) = \\frac{4}{m_i} \\|\\mathbf{r}_i - \\mathbf{r}_j\\|^2 + \\frac{4}{m_j} \\|\\mathbf{r}_i - \\mathbf{r}_j\\|^2\n$$\n提出公因子得到 $A(q)$ 的最终表达式：\n$$\nA(q) = 4 \\left( \\frac{1}{m_i} + \\frac{1}{m_j} \\right) \\|\\mathbf{r}_i - \\mathbf{r}_j\\|^2\n$$\n这是第三个要求的量。\n这三个结果按指定顺序呈现。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n2(\\mathbf{r}_i - \\mathbf{r}_j)  -2(\\mathbf{r}_i - \\mathbf{r}_j)  4\\left(\\frac{1}{m_i} + \\frac{1}{m_j}\\right) \\|\\mathbf{r}_i - \\mathbf{r}_j\\|^2\n\\end{pmatrix}\n}\n$$"
        }
    ]
}