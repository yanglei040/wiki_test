{
    "hands_on_practices": [
        {
            "introduction": "任何恒温器的首要目标都是正确地对正则系综进行抽样。本练习将通过计算一个关键的统计特性——瞬时温度的方差——来强化这一原则。 这个练习将突显这是一个平衡态性质，与恒温器的动力学参数（如弛豫时间 $\\tau$ 或积分步长 $\\Delta t$）无关，从而加深您对正确抽样和系统动力学之间区别的理解。",
            "id": "3449865",
            "problem": "考虑一个经典的分子动力学 (MD) 系统，其具有 $f$ 个二次方速度自由度，瞬时动能为 $K=\\sum_{i=1}^{f}\\frac{1}{2}m_i v_i^{2}$，目标绝对温度为 $T$。将瞬时温度定义为\n$$\nT_{\\text{inst}}=\\frac{2K}{f k_B},\n$$\n其中 $k_B$ 是玻尔兹曼常数。\n\n假设该系统使用随机速度重缩放 (SVR) 方法进行恒温控制，该方法的特征是弛豫时间参数 $\\tau$ 和积分时间步长 $\\Delta t$。在其稳态下，该恒温器能保持温度 $T$ 下的速度正则分布。从正则系综和速度的麦克斯韦-玻尔兹曼分布的第一性原理出发，推导在稳态下 SVR 控制的 $T_{\\text{inst}}$ 的方差，并评估 $\\tau$ 和 $\\Delta t$ 如何影响 $T_{\\text{inst}}$ 相对于正则目标的涨落。\n\n您的最终结果必须是一个以 $f$ 和 $T$ 表示的单一闭式解析表达式。方差以开尔文平方 ($\\text{K}^2$) 为单位表示。无需进行数值计算。",
            "solution": "问题要求计算在一个随机速度重缩放 (SVR) 恒温器控制下，处于稳态的系统的瞬时温度 $T_{\\text{inst}}$ 的方差。问题陈述提供了一个关键信息：在此稳态下，恒温器在目标温度 $T$ 下保持了速度的正则分布。这意味着任何依赖于速度的物理量（例如动能 $K$ 和瞬时温度 $T_{\\text{inst}}$）的统计特性，都可以直接从统计力学中正则系综的原理推导出来。\n\n瞬时温度定义为：\n$$\nT_{\\text{inst}} = \\frac{2K}{f k_B}\n$$\n其中 $K$ 是瞬时动能，$f$ 是二次方速度自由度的数量，$k_B$ 是玻尔兹曼常数。\n\n我们的目标是计算 $T_{\\text{inst}}$ 的方差，其定义为 $\\text{Var}(T_{\\text{inst}}) = \\langle T_{\\text{inst}}^2 \\rangle - \\langle T_{\\text{inst}} \\rangle^2$。利用方差算符的性质，我们可以将 $T_{\\text{inst}}$ 的方差与动能 $K$ 的方差联系起来：\n$$\n\\text{Var}(T_{\\text{inst}}) = \\text{Var}\\left(\\frac{2K}{f k_B}\\right) = \\left(\\frac{2}{f k_B}\\right)^2 \\text{Var}(K)\n$$\n因此，问题简化为在正则系综中求动能的方差 $\\text{Var}(K)$。\n\n总动能 $K$ 是 $f$ 个独立的二次方自由度的能量之和：\n$$\nK = \\sum_{i=1}^{f} \\frac{1}{2}m_i v_i^{2}\n$$\n在温度为 $T$ 的正则系综中，各速度分量是独立的随机变量，每个都遵循麦克斯韦-玻尔兹曼分布。具体来说，每个速度分量 $v_i$ 是一个高斯随机变量，其均值为 $0$，方差为 $\\langle v_i^2 \\rangle = \\frac{k_B T}{m_i}$。\n\n为了推导 $K$ 的方差，方便的做法是用无量纲的标准正态变量来表示 $K$。我们定义一组变量 $u_i$，使得 $u_i = v_i / \\sqrt{k_B T / m_i}$。每个 $u_i$ 是从标准正态分布 $N(0,1)$ 中抽取的随机变量，意味着 $\\langle u_i \\rangle = 0$ 且 $\\langle u_i^2 \\rangle = 1$。动能可以用这些变量重写为：\n$$\nK = \\sum_{i=1}^{f} \\frac{1}{2}m_i \\left(u_i \\sqrt{\\frac{k_B T}{m_i}}\\right)^2 = \\sum_{i=1}^{f} \\frac{1}{2} m_i u_i^2 \\frac{k_B T}{m_i} = \\frac{1}{2}k_B T \\sum_{i=1}^{f} u_i^2\n$$\n$f$ 个独立标准正态变量的平方和 $X = \\sum_{i=1}^{f} u_i^2$ 是一个随机变量，它遵循具有 $f$ 个自由度的卡方分布，记为 $X \\sim \\chi^2_f$。具有 $f$ 个自由度的卡方分布的均值和方差是众所周知：\n$$\n\\langle X \\rangle = f\n$$\n$$\n\\text{Var}(X) = 2f\n$$\n我们现在可以将动能表示为 $K = \\frac{1}{2}k_B T X$。动能的期望值为：\n$$\n\\langle K \\rangle = \\left\\langle \\frac{1}{2}k_B T X \\right\\rangle = \\frac{1}{2}k_B T \\langle X \\rangle = \\frac{1}{2}k_B T f\n$$\n这个结果与能量均分定理一致，该定理指出每个二次方自由度对平均能量的贡献为 $\\frac{1}{2}k_B T$。\n\n动能的方差是：\n$$\n\\text{Var}(K) = \\text{Var}\\left(\\frac{1}{2}k_B T X\\right) = \\left(\\frac{1}{2}k_B T\\right)^2 \\text{Var}(X) = \\frac{(k_B T)^2}{4} (2f) = \\frac{f}{2} (k_B T)^2\n$$\n现在，我们可以将此结果代回到瞬时温度方差的表达式中：\n$$\n\\text{Var}(T_{\\text{inst}}) = \\left(\\frac{2}{f k_B}\\right)^2 \\text{Var}(K) = \\frac{4}{f^2 k_B^2} \\left[ \\frac{f}{2} (k_B T)^2 \\right] = \\frac{4f k_B^2 T^2}{2f^2 k_B^2}\n$$\n简化此表达式即可得到 $T_{\\text{inst}}$ 方差的最终结果：\n$$\n\\text{Var}(T_{\\text{inst}}) = \\frac{2}{f} T^2\n$$\n该表达式的单位是开尔文平方 ($\\text{K}^2$)，符合要求。\n\n最后，我们必须评估 SVR 参数 $\\tau$ 和 $\\Delta t$ 如何影响 $T_{\\text{inst}}$ 的涨落。推导出的方差 $\\text{Var}(T_{\\text{inst}}) = \\frac{2}{f}T^2$ 仅取决于自由度数 $f$ 和目标温度 $T$。它不依赖于动力学参数 $\\tau$（弛豫时间）或 $\\Delta t$（积分时间步长）。这是问题前提的一个基本推论：系统处于稳态，其中恒温器正确地对正则系综进行抽样。在给定的统计系综中，一个量的方差是该系综的一个平衡性质，并且与用于生成该状态的具体算法无关，前提是该算法是正确的。\n\n然而，参数 $\\tau$ 和 $\\Delta t$ 确实会影响涨落的 *时间特性*。\n- 弛豫时间 $\\tau$ 控制着与热浴耦合的强度。较小的 $\\tau$ 意味着更强的耦合，导致 $T_{\\text{inst}}$ 对 $T$ 的任何偏离都会被更快地修正。这导致温度涨落的自相关时间更短。相反，较大的 $\\tau$ 导致较弱的耦合，涨落会持续更长时间，从而增加了自相关时间。\n- 时间步长 $\\Delta t$ 的选择必须相对于系统的物理时间尺度（包括 $\\tau$）足够小。如果 $\\Delta t$ 过大，运动方程的数值积分会变得不准确，恒温器可能无法保持正则分布。问题中关于保持正则分布的假设意味着 $\\Delta t$ 是被恰当选择的。\n\n总而言之，在指定条件下，即系统处于能正确复现正则系综的稳态，热涨落的幅度（由 $T_{\\text{inst}}$ 的方差量化）是系统统计力学的内在属性，并且与 SVR 参数 $\\tau$ 和 $\\Delta t$ 无关。这些参数决定了这些涨落随时间演化的动力学特性。",
            "answer": "$$\n\\boxed{\\frac{2}{f}T^2}\n$$"
        },
        {
            "introduction": "在理解了恒温器的目标之后，下一步是理解其工作机制。本练习将深入探讨随机速度重缩放（SVR）方法的核心数学原理，要求您推导在单个时间步内更新动能的精确抽样过程。 通过计算缩放因子的短时条件矩，您将洞察恒温器如何推动系统向目标温度演化，并理解其与连续时间随机过程之间的联系。",
            "id": "3449852",
            "problem": "考虑一个经典的分子动力学系统，该系统具有 $f$ 个二次速度自由度，其瞬时动能为 $K = \\frac{1}{2} \\sum_{i=1}^{f} m_{i} v_{i}^{2}$。该系统通过随机速度重标度与热浴耦合，此方法在每个积分步结束时通过统一缩放所有速度 $v_{i} \\mapsto \\alpha v_{i}$ 来实现，使得动能更新为 $K' = \\alpha^{2} K$。目标动能为 $\\bar{K} = \\frac{f}{2} k_{B} T$，其中 $k_{B}$ 是玻尔兹曼常数，$T$ 是热浴温度。随机速度重标度方法的设计目的是使动能 $K$ 的稳态分布是与麦克斯韦-玻尔兹曼速度分布兼容的正则（伽马）分布，并且系统以特征时间尺度 $\\tau$ 向平衡态弛豫。\n\n从这些原理出发，并基于随机映射 $(K \\mapsto K')$ 在弛豫时间 $\\tau$ 内保持正则分布的要求，推导出一个在有限时间步 $\\Delta t$ 上对 $K'$ 进行采样的显式、可实现的、分步的程序，该程序用已知分布的标准随机变量表示。然后，使用您的采样表示，并在 $\\Delta t$ 的一阶上进行一致计算，求出在给定当前动能 $K$ 的条件下，速度缩放因子 $\\alpha$ 的前两个条件矩，即条件均值 $\\mathbb{E}[\\alpha \\mid K]$ 和条件方差 $\\mathrm{Var}(\\alpha \\mid K)$，两者都精确到 $\\mathcal{O}(\\Delta t)$。\n\n您必须：\n- 仅使用标准正态随机变量和卡方随机变量来表达 $K'$ 的采样过程，并包含所有必要的常数，这些常数是 $(f, \\bar{K}, K, \\tau, \\Delta t)$ 的函数。\n- 精确定义您计算的条件矩，并展示它们如何从您的采样表示中在一阶 $\\Delta t$ 下得出。\n- 以 $f, \\bar{K}, K, \\tau, \\Delta t$ 的闭式解析表达式形式，给出 $\\mathbb{E}[\\alpha \\mid K]$ 和 $\\mathrm{Var}(\\alpha \\mid K)$ 的最终表达式。\n\n将最终答案表达为单一的解析表达式。不需要进行数值计算或四舍五入。",
            "solution": "随机速度重标度方法的核心是在离散时间步 $\\Delta t$ 上通过一个公共因子 $\\alpha$ 缩放所有粒子速度 $v_i$ 来修改系统的动能 $K$。新的动能 $K'$ 与旧的动能 $K$ 通过 $K' = \\alpha^2 K$ 相关联。缩放因子 $\\alpha$ 是一个随机变量，其选择方式要使 $K$ 的稳态分布是正则伽马分布，$P(K) \\propto K^{f/2-1} \\exp(-K/\\beta)$，其中 $\\beta=k_B T = 2\\bar{K}/f$，并且系统以特征时间 $\\tau$ 向该分布弛豫。\n\n**第一部分: $K'$ 采样过程的推导**\n\n随机更新规则的设计旨在等效于将系统与热浴弱耦合，这可以通过一个随机微分方程来建模。构建有限时间步更新的一个稳健方法是考虑在质量加权速度空间 $\\mathbf{x} = \\{\\sqrt{m_i}v_i\\}$ 中的演化，这是一个 $f$ 维空间中的向量。动能为 $K = \\frac{1}{2}\\|\\mathbf{x}\\|^2$。在一个时间步 $\\Delta t$ 内的演化可以建模为一个弛豫过程：\n$$ \\mathbf{x}(t+\\Delta t) = \\sqrt{c} \\mathbf{x}(t) + \\sqrt{1-c} \\mathbf{x}_{\\text{ran}} $$\n其中 $c = \\exp(-\\Delta t/\\tau)$ 并且 $\\mathbf{x}_{\\text{ran}}$ 是一个从平衡分布中抽取的随机向量，即其分量是方差为 $k_B T$ 的独立高斯随机变量。新的动能 $K'$ 是 $K'=\\frac{1}{2}\\|\\mathbf{x}(t+\\Delta t)\\|^2$。\n$$ K' = \\frac{1}{2} \\left( \\sqrt{c} \\mathbf{x}(t) + \\sqrt{1-c} \\mathbf{x}_{\\text{ran}} \\right) \\cdot \\left( \\sqrt{c} \\mathbf{x}(t) + \\sqrt{1-c} \\mathbf{x}_{\\text{ran}} \\right) $$\n$$ K' = \\frac{c}{2}\\|\\mathbf{x}(t)\\|^2 + \\frac{1-c}{2}\\|\\mathbf{x}_{\\text{ran}}\\|^2 + \\sqrt{c(1-c)} (\\mathbf{x}(t) \\cdot \\mathbf{x}_{\\text{ran}}) $$\n$$ K' = cK + (1-c)K_{\\text{ran}} + \\sqrt{c(1-c)} (\\mathbf{x} \\cdot \\mathbf{x}_{\\text{ran}}) $$\n为了用标准随机变量来表示，我们分析每一项。$K_{\\text{ran}} = \\frac{1}{2}\\|\\mathbf{x}_{\\text{ran}}\\|^2$ 是从正则系综中抽取的随机系统的动能。它服从伽马分布，该分布可以由高斯变量的平方和构建。具体来说，$K_{\\text{ran}} = \\frac{1}{2}k_B T S_f = \\frac{\\bar{K}}{f}S_f$，其中 $S_f$ 是一个来自具有 $f$ 个自由度的卡方分布的随机变量，$S_f \\sim \\chi^2_f$。\n\n点积项 $\\mathbf{x} \\cdot \\mathbf{x}_{\\text{ran}}$ 可以通过将 $\\mathbf{x}_{\\text{ran}}$ 投影到由单位向量 $\\hat{\\mathbf{u}} = \\mathbf{x}/\\|\\mathbf{x}\\| = \\mathbf{x}/\\sqrt{2K}$ 定义的 $\\mathbf{x}$ 的方向上来简化。\n$$ \\mathbf{x}_{\\text{ran}} = (\\mathbf{x}_{\\text{ran}} \\cdot \\hat{\\mathbf{u}})\\hat{\\mathbf{u}} + \\mathbf{x}_{\\text{ran},\\perp} $$\n平行投影 $\\mathbf{x}_{\\text{ran}} \\cdot \\hat{\\mathbf{u}}$ 是独立高斯变量（$\\mathbf{x}_{\\text{ran}}$ 的分量）的线性组合，因此其本身也是一个高斯变量。其均值为零，方差为 $k_B T$。我们可以将其写为 $\\sqrt{k_B T} Z$，其中 $Z \\sim \\mathcal{N}(0,1)$。正交部分 $\\mathbf{x}_{\\text{ran},\\perp}$ 存在于一个 $(f-1)$ 维子空间中。\n随机向量的动能相应地分解为：\n$$ K_{\\text{ran}} = \\frac{1}{2} (\\mathbf{x}_{\\text{ran}} \\cdot \\hat{\\mathbf{u}})^2 + \\frac{1}{2} \\|\\mathbf{x}_{\\text{ran},\\perp}\\|^2 = \\frac{1}{2}k_B T Z^2 + \\frac{1}{2}k_B T S_{f-1} = \\frac{\\bar{K}}{f}(Z^2 + S_{f-1})$$\n其中 $S_{f-1} \\sim \\chi^2_{f-1}$ 与 $Z$ 独立抽取。这证实了 $Z^2+S_{f-1}$ 是一个 $\\chi^2_f$ 变量，正如所预期的。\n\n$K'$ 表达式中的交叉项变为：\n$$ \\mathbf{x} \\cdot \\mathbf{x}_{\\text{ran}} = \\|\\mathbf{x}\\| (\\hat{\\mathbf{u}} \\cdot \\mathbf{x}_{\\text{ran}}) = \\sqrt{2K} (\\sqrt{k_B T} Z) = Z\\sqrt{2K k_B T} = Z\\sqrt{2K \\frac{2\\bar{K}}{f}} = 2Z\\sqrt{\\frac{K\\bar{K}}{f}} $$\n将这些分量代回 $K'$ 的方程中：\n$$ K' = cK + (1-c)\\frac{\\bar{K}}{f}(Z^2 + S_{f-1}) + \\sqrt{c(1-c)} \\left(2Z\\sqrt{\\frac{K\\bar{K}}{f}}\\right) $$\n这提供了 $K'$ 的显式采样过程。总结如下：\n1.  令 $c = \\exp(-\\Delta t/\\tau)$。\n2.  生成一个标准正态随机变量 $Z \\sim \\mathcal{N}(0,1)$。\n3.  生成一个与 $Z$ 独立的卡方随机变量 $S_{f-1} \\sim \\chi^2_{f-1}$。\n4.  使用以下公式计算新的动能 $K'$：\n    $$ K' = cK + (1-c)\\frac{\\bar K}{f}(Z^2+S_{f-1}) + 2Z\\sqrt{c(1-c)\\frac{K\\bar K}{f}} $$\n\n**第二部分: $\\alpha$ 的条件矩的计算**\n\n我们需要计算条件均值 $\\mathbb{E}[\\alpha \\mid K]$ 和方差 $\\mathrm{Var}(\\alpha \\mid K)$ 至 $\\Delta t$ 的一阶。速度缩放因子 $\\alpha$ 由 $\\alpha = \\sqrt{K'/K}$ 给出。我们首先找到 $\\alpha^2 = K'/K$ 的表达式：\n$$ \\alpha^2 = c + (1-c)\\frac{\\bar K}{fK}(Z^2+S_{f-1}) + 2Z\\sqrt{c(1-c)\\frac{\\bar K}{fK}} $$\n我们对小的 $\\Delta t$ 进行展开。令 $\\gamma = \\sqrt{\\Delta t/\\tau}$。那么 $c = \\exp(-\\Delta t/\\tau) \\approx 1 - (\\Delta t/\\tau) = 1-\\gamma^2$。所以 $1-c \\approx \\gamma^2$ 且 $\\sqrt{c(1-c)} \\approx \\sqrt{1 \\cdot \\gamma^2} = \\gamma$。\n代入这些近似值，我们得到 $\\alpha^2$ 直到 $\\gamma^2 = \\Delta t/\\tau$ 阶：\n$$ \\alpha^2 \\approx (1-\\gamma^2) + \\gamma^2\\frac{\\bar K}{fK}(Z^2+S_{f-1}) + 2\\gamma Z\\sqrt{\\frac{\\bar K}{fK}} $$\n$$ \\alpha^2 \\approx 1 + 2\\gamma Z\\sqrt{\\frac{\\bar K}{fK}} + \\gamma^2 \\left( \\frac{\\bar K}{fK}(Z^2+S_{f-1}) - 1 \\right) $$\n为了求 $\\alpha$，我们取平方根，使用展开式 $\\sqrt{1+x} \\approx 1 + x/2 - x^2/8$。\n令 $A = Z\\sqrt{\\frac{\\bar K}{fK}}$ 且 $B = \\frac{\\bar K}{fK}(Z^2+S_{f-1}) - 1$。\n那么 $\\alpha^2 \\approx 1 + 2\\gamma A + \\gamma^2 B$。\n$$ \\alpha = (1 + 2\\gamma A + \\gamma^2 B)^{1/2} \\approx 1 + \\frac{1}{2}(2\\gamma A + \\gamma^2 B) - \\frac{1}{8}(2\\gamma A)^2 $$\n$$ \\alpha \\approx 1 + \\gamma A + \\frac{1}{2}\\gamma^2 B - \\frac{1}{2}\\gamma^2 A^2 $$\n保留到 $\\mathcal{O}(\\gamma^2) = \\mathcal{O}(\\Delta t)$ 的项：\n$$ \\alpha \\approx 1 + \\gamma Z\\sqrt{\\frac{\\bar K}{fK}} + \\frac{1}{2}\\gamma^2 \\left[ \\left(\\frac{\\bar K}{fK}(Z^2+S_{f-1}) - 1\\right) - Z^2\\frac{\\bar K}{fK} \\right] $$\n$$ \\alpha \\approx 1 + \\sqrt{\\frac{\\Delta t}{\\tau}} Z\\sqrt{\\frac{\\bar K}{fK}} + \\frac{1}{2}\\frac{\\Delta t}{\\tau} \\left( \\frac{\\bar K}{fK}S_{f-1} - 1 \\right) $$\n\n现在我们使用这个展开式来计算条件矩。随机变量是 $Z$ 和 $S_{f-1}$，其矩为 $\\mathbb{E}[Z]=0$, $\\mathbb{E}[Z^2]=1$, $\\mathbb{E}[S_{f-1}]=f-1$, 以及 $\\mathrm{Var}(S_{f-1})=2(f-1)$。\n\n条件均值 $\\mathbb{E}[\\alpha \\mid K]$ 是：\n$$ \\mathbb{E}[\\alpha \\mid K] \\approx \\mathbb{E}\\left[ 1 + \\sqrt{\\frac{\\Delta t}{\\tau}} Z\\sqrt{\\frac{\\bar K}{fK}} + \\frac{1}{2}\\frac{\\Delta t}{\\tau} \\left( \\frac{\\bar K}{fK}S_{f-1} - 1 \\right) \\right] $$\n$$ \\mathbb{E}[\\alpha \\mid K] \\approx 1 + \\sqrt{\\frac{\\Delta t}{\\tau}}\\sqrt{\\frac{\\bar K}{fK}}\\mathbb{E}[Z] + \\frac{1}{2}\\frac{\\Delta t}{\\tau} \\left( \\frac{\\bar K}{fK}\\mathbb{E}[S_{f-1}] - 1 \\right) $$\n$$ \\mathbb{E}[\\alpha \\mid K] \\approx 1 + 0 + \\frac{1}{2}\\frac{\\Delta t}{\\tau} \\left( \\frac{\\bar K}{fK}(f-1) - 1 \\right) = 1 + \\frac{\\Delta t}{2\\tau} \\left( \\frac{\\bar K}{K}\\frac{f-1}{f} - 1 \\right) $$\n这是 $\\Delta t$ 一阶下的条件均值。\n\n条件方差为 $\\mathrm{Var}(\\alpha \\mid K) = \\mathbb{E}[\\alpha^2 \\mid K] - (\\mathbb{E}[\\alpha \\mid K])^2$。\n首先，计算 $\\mathbb{E}[\\alpha^2 \\mid K]$ 到 $\\mathcal{O}(\\Delta t)$:\n$$ \\mathbb{E}[\\alpha^2 \\mid K] = \\mathbb{E}\\left[ c + (1-c)\\frac{\\bar K}{fK}(Z^2+S_{f-1}) + 2Z\\sqrt{c(1-c)\\frac{\\bar K}{fK}} \\right] $$\n$$ \\mathbb{E}[\\alpha^2 \\mid K] = c + (1-c)\\frac{\\bar K}{fK}(\\mathbb{E}[Z^2]+\\mathbb{E}[S_{f-1}]) = c+(1-c)\\frac{\\bar K}{fK}(1+f-1) = c+(1-c)\\frac{\\bar K}{K} $$\n$$ \\mathbb{E}[\\alpha^2 \\mid K] \\approx \\left(1-\\frac{\\Delta t}{\\tau}\\right) + \\frac{\\Delta t}{\\tau}\\frac{\\bar K}{K} = 1 + \\frac{\\Delta t}{\\tau}\\left(\\frac{\\bar K}{K}-1\\right) $$\n接下来，计算 $(\\mathbb{E}[\\alpha \\mid K])^2$ 到 $\\mathcal{O}(\\Delta t)$:\n$$ (\\mathbb{E}[\\alpha \\mid K])^2 \\approx \\left( 1 + \\frac{\\Delta t}{2\\tau} \\left( \\frac{\\bar K}{K}\\frac{f-1}{f} - 1 \\right) \\right)^2 \\approx 1 + 2 \\cdot \\frac{\\Delta t}{2\\tau} \\left( \\frac{\\bar K}{K}\\frac{f-1}{f} - 1 \\right) $$\n$$ (\\mathbb{E}[\\alpha \\mid K])^2 \\approx 1 + \\frac{\\Delta t}{\\tau}\\left(\\frac{\\bar K}{K} - \\frac{\\bar K}{fK} - 1\\right) $$\n最后，方差为：\n$$ \\mathrm{Var}(\\alpha \\mid K) \\approx \\left(1 + \\frac{\\Delta t}{\\tau}\\left(\\frac{\\bar K}{K}-1\\right)\\right) - \\left(1 + \\frac{\\Delta t}{\\tau}\\left(\\frac{\\bar K}{K} - \\frac{\\bar K}{fK} - 1\\right)\\right) $$\n$$ \\mathrm{Var}(\\alpha \\mid K) \\approx \\frac{\\Delta t}{\\tau} \\left( \\left(\\frac{\\bar K}{K}-1\\right) - \\left(\\frac{\\bar K}{K} - \\frac{\\bar K}{fK} - 1\\right) \\right) = \\frac{\\Delta t}{\\tau} \\frac{\\bar K}{fK} $$\n这是 $\\Delta t$ 一阶下的条件方差。请注意，这个结果也可以通过计算 $\\alpha$ 展开式中阶为 $\\sqrt{\\Delta t}$ 的主导随机项的方差来更直接地得到。\n\n$\\alpha$ 的条件均值和方差的最终表达式已汇总在最终答案中。",
            "answer": "$$ \\boxed{ \\begin{pmatrix} 1 + \\frac{\\Delta t}{2\\tau} \\left( \\frac{\\bar{K}}{K}\\frac{f-1}{f} - 1 \\right) \\\\ \\frac{\\Delta t}{\\tau} \\frac{\\bar{K}}{fK} \\end{pmatrix} } $$"
        },
        {
            "introduction": "一个正确的理论公式，只有当它能被实现为稳健的算法时才有用。本练习将解决数值稳定性这一关键问题，尤其是在系统动能很低的情况下。 您将学习如何通过代数变换将更新规则重构为一个平方和的形式，并使用无量纲变量来避免灾难性抵消等常见的数值错误，这是编写可靠科学计算软件的一项至关重要的技能。",
            "id": "3449887",
            "problem": "考虑一个分子动力学系统，该系统具有 $N_f$ 个有效二次自由度，并耦合到一个在温度 $T$ 下保持正则系综的随机速度重标恒温器。设瞬时动能为 $K$，正则系综平均动能为 $\\bar K = \\frac{N_f}{2} k_{\\mathrm B} T$，其中 $k_{\\mathrm B}$ 是玻尔兹曼常数。该恒温器的特征在于一个弛豫时间 $\\tau$ 和一个时间步长 $\\Delta t$。定义 $c = \\exp(-\\Delta t/\\tau)$。在随机速度重标的精确积分器中，恒温步骤之后的动能 $K'$ 通过一个非中心卡方跃迁与 $K$ 相关联，该跃迁可以用一个标准正态随机变量 $R \\sim \\mathcal N(0,1)$ 和一个卡方随机变量 $s \\sim \\chi^2_{N_f - 1}$ 来表示，两者相互独立。重标因子 $\\alpha$ 由 $K' = \\alpha^2 K$ 定义，因此在恒温步骤中，所有速度 $\\mathbf v$ 都被映射到 $\\mathbf v' = \\alpha \\mathbf v$。\n\n当 $K$ 很小时，通过将 $K'$ 的显式公式除以 $K$ 来直接计算 $\\alpha$ 通常会涉及与 $1/K$ 成比例的项，并可能遭受灾难性的精度损失。你的任务是选择一种算法，该算法通过 (i) 使用更新的平方根-平方和表示法，以及 (ii) 在进行除法之前将所有量缩放到一的量级的无量纲单位，从而以数值稳定的方式计算 $\\alpha$，适用于所有 $K \\ge 0$。\n\n下面的哪个选项在实现这一目标的同时，仍然是随机速度重标步骤的精确实现？\n\nA) 计算\n\n$$\n\\alpha^2 \\;=\\; c \\;+\\; (1-c)\\,\\frac{\\bar K}{N_f K}\\,(s + R^2)\\;+\\; 2 R \\sqrt{ \\frac{c (1-c)\\, \\bar K}{N_f K} },\n$$\n\n然后设 $\\alpha = \\sqrt{\\alpha^2}$。\n\nB) 设 $a = \\sqrt{c}$，$b = \\sqrt{1-c}$，并定义无量纲能量幅值 $u = \\sqrt{K/\\bar K}$。抽取 $R \\sim \\mathcal N(0,1)$ 和 $s \\sim \\chi^2_{N_f-1}$。构造\n\n$$\nq \\;=\\; \\sqrt{ \\left( a u + \\frac{b}{\\sqrt{N_f}} R \\right)^2 \\;+\\; \\frac{b^2}{N_f}\\, s },\n$$\n\n使用一个对 $\\sqrt{x^2+y^2}$ 数值鲁棒的例程来计算平方和的平方根。使用稳定的比率求值返回 $\\alpha = q/u$。如果 $u$ 低于某个小阈值 $\\varepsilon$，首先计算 $\\alpha u = q$，并通过 $\\mathbf v' = (\\alpha u/u)\\,\\mathbf v$ 将缩放应用于速度，其中分母经过保护 $u \\leftarrow \\max(u,\\varepsilon)$。\n\nC) 使用动能的奥恩斯坦-乌伦贝克漂移扩散的欧拉-丸山离散化，得到\n\n$$\n\\alpha \\;=\\; 1 \\;+\\; \\frac{\\Delta t}{2 \\tau} \\left( \\frac{\\bar K}{K} - 1 \\right) \\;+\\; \\sqrt{ \\frac{\\Delta t}{\\tau N_f}\\,\\frac{\\bar K}{K} }\\, R.\n$$\n\nD) 将恒温过程近似为确定性弛豫和随机加热的线性组合，并计算\n\n$$\n\\alpha \\;=\\; \\sqrt{c} \\;+\\; \\sqrt{1-c}\\,\\sqrt{ \\frac{\\bar K}{N_f K} }\\, \\sqrt{s + R^2}.\n$$\n\n选择正确的选项，并从第一性原理和随机速度重标跃迁的公认性质出发，推导并证明为何所选算法在 $K$ 很小时既是精确的又是数值稳定的，从而为你的选择提供理由。你的推导必须从正则等分关系、$\\bar K$ 的定义以及 $K$ 的精确非中心卡方跃迁开始，并且只能使用关于高斯和卡方随机变量的经过充分检验的事实、代数操作和无量纲缩放论证。避免引用任何未说明的快捷公式。",
            "solution": "### 推导和选项分析\n\n目标是找到一个用于计算速度缩放因子 $\\alpha$ 的精确且数值稳定的算法。推导将从 SVR 恒温器的基本统计力学出发。\n\n**1. 精确动能跃迁的第一性原理推导**\n\nSVR 恒温器从一个依赖于旧动量 $p_j$ 的条件高斯分布为 $N_f$ 个自由度中的每一个生成新的动量 $p'_j$。此过程正确地传播了正则系综。单个动量的更新规则为：\n$$ p'_j = p_j \\sqrt{c} + \\sqrt{(1-c) m k_{\\mathrm B} T} \\cdot \\eta_j $$\n其中 $c = \\exp(-\\Delta t/\\tau)$ 且 $\\eta_j \\sim \\mathcal{N}(0,1)$ 是独立的标准正态变量。新的总动能 $K'$ 是所有自由度的总和：\n$$ K' = \\sum_{j=1}^{N_f} \\frac{(p'_j)^2}{2m} = \\sum_{j=1}^{N_f} \\frac{1}{2m} \\left( p_j \\sqrt{c} + \\sqrt{(1-c) m k_{\\mathrm B} T} \\cdot \\eta_j \\right)^2 $$\n展开平方项：\n$$ K' = \\sum_{j=1}^{N_f} \\left( \\frac{c p_j^2}{2m} + \\frac{(1-c) m k_{\\mathrm B} T}{2m} \\eta_j^2 + \\frac{2\\sqrt{c(1-c) m k_{\\mathrm B} T}}{2m} p_j \\eta_j \\right) $$\n对 $j$ 求和并识别各项：\n-   $\\sum \\frac{p_j^2}{2m} = K$ （旧动能）。\n-   $\\sum \\eta_j^2$ 是 $N_f$ 个标准正态变量的平方和。\n-   $\\sum p_j \\eta_j$ 是动量向量 $\\mathbf{p}$ 和随机向量 $\\boldsymbol{\\eta}$ 的点积。\n\n向量 $\\boldsymbol{\\eta}$ 可以分解为一个与 $\\mathbf{p}$ 平行的分量和一个与它垂直的分量。设 $\\mathbf{u_p} = \\mathbf{p} / |\\mathbf{p}|$ 是动量向量方向的单位向量。\n-   $\\boldsymbol{\\eta}$ 在 $\\mathbf{u_p}$ 上的投影是 $\\boldsymbol{\\eta} \\cdot \\mathbf{u_p}$。这是一个来自 $\\mathcal{N}(0,1)$ 的标量随机变量，我们将其等同于问题中的 $R$。\n-   点积变为 $\\sum p_j \\eta_j = \\mathbf{p} \\cdot \\boldsymbol{\\eta} = |\\mathbf{p}| (\\mathbf{u_p} \\cdot \\boldsymbol{\\eta}) = |\\mathbf{p}| R$。我们知道 $|\\mathbf{p}| = \\sqrt{2mK}$。\n-   根据 $N_f$ 维空间中的勾股定理，$\\sum \\eta_j^2 = (\\mathbf{u_p} \\cdot \\boldsymbol{\\eta})^2 + |\\boldsymbol{\\eta}_\\perp|^2 = R^2 + s$。这里，$s = |\\boldsymbol{\\eta}_\\perp|^2$ 是 $\\boldsymbol{\\eta}$ 垂直于 $\\mathbf{p}$ 的 $N_f-1$ 个分量的平方和。根据定义，这是一个具有 $N_f-1$ 个自由度的卡方随机变量，$s \\sim \\chi^2_{N_f-1}$，并且它独立于 $R$。\n\n将这些代入 $K'$ 的表达式中：\n$$ K' = c K + (1-c) \\frac{k_{\\mathrm B} T}{2} (s+R^2) + \\sqrt{\\frac{c(1-c)k_{\\mathrm B} T}{m}} ( \\sqrt{2mK} R ) $$\n使用 $\\bar K = \\frac{N_f}{2}k_{\\mathrm B} T \\implies k_{\\mathrm B} T = 2\\bar K/N_f$：\n$$ K' = c K + (1-c) \\frac{\\bar K}{N_f} (s+R^2) + \\sqrt{2c(1-c) k_{\\mathrm B} T K} R $$\n$$ K' = c K + (1-c) \\frac{\\bar K}{N_f} (s+R^2) + \\sqrt{2c(1-c) \\frac{2\\bar K}{N_f} K} R $$\n$$ K' = c K + (1-c) \\frac{\\bar K}{N_f} (s+R^2) + 2R \\sqrt{\\frac{c(1-c) K \\bar K}{N_f}} $$\n这是新动能 $K'$ 的精确表达式。\n\n**2. 选项分析**\n\n**选项 A：**\n该选项提供了 $\\alpha^2 = K'/K$ 的一个公式：\n$$ \\alpha^2 \\;=\\; c \\;+\\; (1-c)\\,\\frac{\\bar K}{N_f K}\\,(s + R^2)\\;+\\; 2 R \\sqrt{ \\frac{c (1-c)\\, \\bar K}{N_f K} } $$\n将我们推导出的 $K'$ 表达式除以 $K$ 即可得到这个精确公式。因此，选项 A 在代数上是正确的。然而，问题要求一个数值稳定的算法。与 $1/K$ 和 $1/\\sqrt{K}$ 成比例的项的存在使得这个公式在 $K \\to 0$ 时高度不稳定。例如，如果 $R$ 是一个大的负数，该公式会涉及两个大数的相减，这是灾难性抵消的典型来源。因此，这个选项不是一个合适的算法。\n**结论：不正确。**\n\n**选项 C：**\n该选项提供了一个基于欧拉-丸山离散化的 $\\alpha$ 表达式。\n$$ \\alpha \\;=\\; 1 \\;+\\; \\frac{\\Delta t}{2 \\tau} \\left( \\frac{\\bar K}{K} - 1 \\right) \\;+\\; \\sqrt{ \\frac{\\Delta t}{\\tau N_f}\\,\\frac{\\bar K}{K} }\\, R $$\n这种离散化是一种近似，仅在小时间步长（$\\Delta t \\ll \\tau$）的极限下有效。问题明确要求 SVR 步骤的*精确*实现。此选项不满足精确性标准。由于存在 $1/K$ 和 $1/\\sqrt{K}$ 项，它也与选项 A 一样存在数值不稳定的问题。\n**结论：不正确。**\n\n**选项 D：**\n该选项提供了 $\\alpha$ 的另一个近似公式：\n$$ \\alpha \\;=\\; \\sqrt{c} \\;+\\; \\sqrt{1-c}\\,\\sqrt{ \\frac{\\bar K}{N_f K} }\\, \\sqrt{s + R^2} $$\n对此表达式求平方得到：\n$$ \\alpha^2 = c + (1-c)\\frac{\\bar K}{N_f K}(s+R^2) + 2\\sqrt{c(1-c)\\frac{\\bar K}{N_f K}(s+R^2)} $$\n这与上面推导出的 $\\alpha^2$ 的精确表达式不符。特别是最后一项不同。精确表达式中有一个与 $R$ 呈线性的项，而这个近似式中有一个与 $\\sqrt{s+R^2}$ 成比例的项。因此，此选项不是一个精确的实现。\n**结论：不正确。**\n\n**选项 B：**\n该选项提出了一个多步算法。让我们通过重新构造我们对 $K'$ 的精确表达式来分析它，以匹配问题的稳定性要求。\n从 $K'$ 的精确表达式开始：\n$$ K' = c K + 2R \\sqrt{\\frac{c(1-c) K \\bar K}{N_f}} + (1-c) \\frac{\\bar K}{N_f} (s+R^2) $$\n我们可以将其重新排列成平方和的形式以提高数值稳定性。让我们将涉及 $R$ 的项组合在一起：\n$$ K' = \\left( cK + 2R \\sqrt{\\frac{c(1-c) K \\bar K}{N_f}} + (1-c) \\frac{\\bar K}{N_f} R^2 \\right) + (1-c) \\frac{\\bar K}{N_f} s $$\n括号中的项可以被识别为一个完全平方：\n$$ K' = \\left( \\sqrt{cK} + R\\sqrt{\\frac{(1-c)\\bar K}{N_f}} \\right)^2 + \\frac{(1-c)\\bar K}{N_f} s $$\n这个 $K'$ 的表达式避免了任何对 $K$ 的除法，并被构造成非负项之和的形式，满足了提示 (i) 的“平方根-平方和”要求。\n\n现在，我们根据提示 (ii) 引入无量纲量。设 $u = \\sqrt{K/\\bar K}$ 为无量纲能量幅值。设 $a = \\sqrt{c}$ 和 $b = \\sqrt{1-c}$。将 $K'$ 的表达式除以 $\\bar K$：\n$$ \\frac{K'}{\\bar K} = \\frac{1}{\\bar K} \\left( \\sqrt{cK} + R\\sqrt{\\frac{(1-c)\\bar K}{N_f}} \\right)^2 + \\frac{1-c}{N_f} s $$\n从平方项中提出因子 $\\bar K$：\n$$ \\frac{K'}{\\bar K} = \\frac{1}{\\bar K} \\left[ \\sqrt{\\bar K} \\left( \\sqrt{c \\frac{K}{\\bar K}} + R\\sqrt{\\frac{1-c}{N_f}} \\right) \\right]^2 + \\frac{(1-c)}{N_f} s $$\n$$ \\frac{K'}{\\bar K} = \\left( \\sqrt{c} u + \\frac{R}{\\sqrt{N_f}}\\sqrt{1-c} \\right)^2 + \\frac{(1-c)}{N_f} s $$\n使用 $a$ 和 $b$ 的定义：\n$$ \\frac{K'}{\\bar K} = \\left( a u + \\frac{b}{\\sqrt{N_f}} R \\right)^2 + \\frac{b^2}{N_f} s $$\n这与选项 B 中给出的 $q^2$ 的表达式完全匹配，其中 $q = \\sqrt{K'/\\bar K}$。对于这种形式，使用一个鲁棒的例程来计算 $\\sqrt{x^2+y^2}$（如 `hypot(x,y)`）是标准做法。\n\n缩放因子 $\\alpha$ 由 $K' = \\alpha^2 K$ 定义。在无量纲项中，$q^2 \\bar K = \\alpha^2 u^2 \\bar K$，这给出 $\\alpha^2 = q^2/u^2$，或 $\\alpha = q/u$。\n当 $K \\to 0$ 时，$u \\to 0$，导致 $\\alpha$ 发散。直接计算 $\\alpha$ 在数值上是不稳定的。速度更新为 $\\mathbf{v}' = \\alpha \\mathbf{v}$。这可以重写为：\n$$ \\mathbf{v}' = \\left(\\frac{q}{u}\\right) \\mathbf{v} = q \\left(\\frac{\\mathbf{v}}{u}\\right) $$\n让我们分析向量 $\\mathbf{w} = \\mathbf{v}/u$。其模长的平方是 $|\\mathbf{w}|^2 = |\\mathbf{v}|^2 / u^2 = |\\mathbf{v}|^2 / (K/\\bar K)$。由于 $K$ 与 $|\\mathbf{v}|^2$ 成正比（即 $K = A|\\mathbf{v}|^2$，对于某个常数 $A$），我们有 $|\\mathbf{w}|^2 = (K/A) / (K/\\bar K) = \\bar K / A$。这是一个常数。因此，向量 $\\mathbf{v}/u$ 的模长不依赖于 $K$，使其在 $K \\to 0$ 时也保持数值上的良好行为。新速度可以计算为 $\\mathbf{v}' = q \\mathbf{w}$，这避免了 problematic 的对小 $u$ 的除法。这与选项 B 的措辞所暗示的稳定求值策略相匹配。对小 $u$ 的显式保护措施提及，是一个实际的实现细节，证实了对该极限的谨慎处理。\n\n因此，选项 B 中的算法是 SVR 更新的一个精确的、经过代数变换的版本，通过使用平方和形式和无量纲缩放来避免被小数字除，从而为最佳的数值稳定性而设计。\n**结论：正确。**",
            "answer": "$$\\boxed{B}$$"
        }
    ]
}