{
    "hands_on_practices": [
        {
            "introduction": "Understanding a thermostat begins with its goal: to correctly sample a target statistical ensemble. This first exercise reinforces this fundamental concept by asking you to calculate an equilibrium property—the variance of the instantaneous temperature—directly from the principles of the canonical ensemble that the Stochastic Velocity Rescaling (SVR) method is designed to reproduce. By showing that this variance is independent of the specific thermostat parameters, this practice  highlights the distinction between equilibrium statistical properties and the dynamics used to generate them.",
            "id": "3449865",
            "problem": "Consider a classical molecular dynamics (MD) system with $f$ quadratic velocity degrees of freedom, instantaneous kinetic energy $K=\\sum_{i=1}^{f}\\frac{1}{2}m_i v_i^{2}$, and target absolute temperature $T$. Define the instantaneous temperature by\n$$\nT_{\\text{inst}}=\\frac{2K}{f k_B},\n$$\nwhere $k_B$ is the Boltzmann constant.\n\nAssume the system is thermostatted using the stochastic velocity rescaling (SVR) method, characterized by a relaxation time parameter $\\tau$ and an integration time step $\\Delta t$. In its stationary regime, this thermostat preserves the canonical distribution for velocities at temperature $T$. Starting from first principles of the canonical ensemble and the Maxwell–Boltzmann distribution for velocities, derive the variance of $T_{\\text{inst}}$ under SVR in the stationary regime, and assess how $\\tau$ and $\\Delta t$ affect the fluctuations of $T_{\\text{inst}}$ relative to the canonical target.\n\nYour final result must be a single closed-form analytic expression in terms of $f$ and $T$. Express the variance in Kelvin squared ($\\text{K}^2$). No numerical evaluation is required.",
            "solution": "The problem asks for the variance of the instantaneous temperature, $T_{\\text{inst}}$, for a system in its stationary state under a stochastic velocity rescaling (SVR) thermostat. The problem statement provides the crucial information that in this regime, the thermostat preserves the canonical distribution for velocities at a target temperature $T$. This means the statistical properties of any quantity dependent on velocity, such as the kinetic energy $K$ and the instantaneous temperature $T_{\\text{inst}}$, can be derived directly from the principles of the canonical ensemble in statistical mechanics.\n\nThe instantaneous temperature is defined as:\n$$\nT_{\\text{inst}} = \\frac{2K}{f k_B}\n$$\nwhere $K$ is the instantaneous kinetic energy, $f$ is the number of quadratic velocity degrees of freedom, and $k_B$ is the Boltzmann constant.\n\nOur goal is to compute the variance of $T_{\\text{inst}}$, which is defined as $\\text{Var}(T_{\\text{inst}}) = \\langle T_{\\text{inst}}^2 \\rangle - \\langle T_{\\text{inst}} \\rangle^2$. Using the properties of the variance operator, we can relate the variance of $T_{\\text{inst}}$ to the variance of the kinetic energy $K$:\n$$\n\\text{Var}(T_{\\text{inst}}) = \\text{Var}\\left(\\frac{2K}{f k_B}\\right) = \\left(\\frac{2}{f k_B}\\right)^2 \\text{Var}(K)\n$$\nThus, the problem reduces to finding the variance of the kinetic energy, $\\text{Var}(K)$, in the canonical ensemble.\n\nThe total kinetic energy $K$ is the sum of energies from $f$ individual quadratic degrees of freedom:\n$$\nK = \\sum_{i=1}^{f} \\frac{1}{2}m_i v_i^{2}\n$$\nIn the canonical ensemble at temperature $T$, the velocity components are independent random variables, each following a Maxwell-Boltzmann distribution. Specifically, each velocity component $v_i$ is a Gaussian random variable with mean $0$ and variance $\\langle v_i^2 \\rangle = \\frac{k_B T}{m_i}$.\n\nTo derive the variance of $K$, it is convenient to express $K$ in terms of dimensionless standard normal variables. Let us define a set of variables $u_i$ such that $u_i = v_i / \\sqrt{k_B T / m_i}$. Each $u_i$ is a random variable drawn from a standard normal distribution, $N(0,1)$, meaning $\\langle u_i \\rangle = 0$ and $\\langle u_i^2 \\rangle = 1$. The kinetic energy can be rewritten in terms of these variables:\n$$\nK = \\sum_{i=1}^{f} \\frac{1}{2}m_i \\left(u_i \\sqrt{\\frac{k_B T}{m_i}}\\right)^2 = \\sum_{i=1}^{f} \\frac{1}{2} m_i u_i^2 \\frac{k_B T}{m_i} = \\frac{1}{2}k_B T \\sum_{i=1}^{f} u_i^2\n$$\nThe sum of the squares of $f$ independent standard normal variables, $X = \\sum_{i=1}^{f} u_i^2$, is a random variable that follows a chi-squared distribution with $f$ degrees of freedom, denoted as $X \\sim \\chi^2_f$. The mean and variance of a chi-squared distribution with $f$ degrees of freedom are well-known:\n$$\n\\langle X \\rangle = f\n$$\n$$\n\\text{Var}(X) = 2f\n$$\nWe can now express the kinetic energy as $K = \\frac{1}{2}k_B T X$. The expected value of the kinetic energy is:\n$$\n\\langle K \\rangle = \\left\\langle \\frac{1}{2}k_B T X \\right\\rangle = \\frac{1}{2}k_B T \\langle X \\rangle = \\frac{1}{2}k_B T f\n$$\nThis result is consistent with the equipartition theorem, which states that each quadratic degree of freedom contributes $\\frac{1}{2}k_B T$ to the average energy.\n\nThe variance of the kinetic energy is:\n$$\n\\text{Var}(K) = \\text{Var}\\left(\\frac{1}{2}k_B T X\\right) = \\left(\\frac{1}{2}k_B T\\right)^2 \\text{Var}(X) = \\frac{(k_B T)^2}{4} (2f) = \\frac{f}{2} (k_B T)^2\n$$\nNow, we can substitute this result back into the expression for the variance of the instantaneous temperature:\n$$\n\\text{Var}(T_{\\text{inst}}) = \\left(\\frac{2}{f k_B}\\right)^2 \\text{Var}(K) = \\frac{4}{f^2 k_B^2} \\left[ \\frac{f}{2} (k_B T)^2 \\right] = \\frac{4f k_B^2 T^2}{2f^2 k_B^2}\n$$\nSimplifying this expression yields the final result for the variance of $T_{\\text{inst}}$:\n$$\n\\text{Var}(T_{\\text{inst}}) = \\frac{2}{f} T^2\n$$\nThe units of this expression are Kelvin squared ($\\text{K}^2$), as required.\n\nFinally, we must assess how the SVR parameters $\\tau$ and $\\Delta t$ affect the fluctuations of $T_{\\text{inst}}$. The derived variance, $\\text{Var}(T_{\\text{inst}}) = \\frac{2}{f}T^2$, depends only on the number of degrees of freedom $f$ and the target temperature $T$. It does not depend on the dynamical parameters $\\tau$ (the relaxation time) or $\\Delta t$ (the integration time step). This is a fundamental consequence of the problem's premise: that the system is in a stationary state where the thermostat correctly samples the canonical ensemble. The variance of a quantity in a given statistical ensemble is an equilibrium property of that ensemble and is independent of the specific algorithm used to generate the state, provided the algorithm is correct.\n\nThe parameters $\\tau$ and $\\Delta t$ do, however, influence the *temporal characteristics* of the fluctuations.\n- The relaxation time $\\tau$ controls the strength of the coupling to the heat bath. A smaller $\\tau$ implies a stronger coupling, causing any deviation of $T_{\\text{inst}}$ from $T$ to be corrected more rapidly. This results in a shorter autocorrelation time for the temperature fluctuations. Conversely, a larger $\\tau$ leads to a weaker coupling, and fluctuations persist for longer, increasing the autocorrelation time.\n- The time step $\\Delta t$ must be chosen to be sufficiently small compared to the physical timescales of the system, including $\\tau$. If $\\Delta t$ is too large, the numerical integration of the equations of motion becomes inaccurate, and the thermostat may fail to preserve the canonical distribution. The problem's assumption that the canonical distribution is preserved implies that $\\Delta t$ is chosen appropriately.\n\nIn summary, under the specified conditions of a stationary state that correctly reproduces the canonical ensemble, the magnitude of the thermal fluctuations, as quantified by the variance of $T_{\\text{inst}}$, is an intrinsic property of the system's statistical mechanics and is independent of the SVR parameters $\\tau$ and $\\Delta t$. These parameters govern the dynamics of how these fluctuations evolve in time.",
            "answer": "$$\n\\boxed{\\frac{2}{f}T^2}\n$$"
        },
        {
            "introduction": "Having established the statistical target, we now turn to the mechanics of the algorithm itself. This practice  guides you through the derivation of the explicit, step-by-step procedure for updating the kinetic energy in an SVR simulation. By constructing the update from standard random variables and analyzing the resulting velocity scaling factor, you will gain a deep, practical understanding of how the thermostat couples the system to a virtual heat bath over a finite time step.",
            "id": "3449852",
            "problem": "Consider a classical molecular dynamics system with $f$ quadratic velocity degrees of freedom and instantaneous kinetic energy $K = \\frac{1}{2} \\sum_{i=1}^{f} m_{i} v_{i}^{2}$. The system is coupled to a thermal bath via stochastic velocity rescaling, implemented at the end of each integration step by uniformly scaling all velocities $v_{i} \\mapsto \\alpha v_{i}$ so that the kinetic energy updates as $K' = \\alpha^{2} K$. The target kinetic energy is $\\bar{K} = \\frac{f}{2} k_{B} T$, where $k_{B}$ is the Boltzmann constant and $T$ is the bath temperature. The stochastic velocity rescaling is designed so that the stationary distribution of the kinetic energy $K$ is the canonical (Gamma) distribution compatible with the Maxwell–Boltzmann velocity distribution, and it relaxes toward equilibrium on a characteristic time scale $\\tau$.\n\nStarting from these principles and the requirement that the stochastic map $(K \\mapsto K')$ preserves the canonical distribution with relaxation time $\\tau$, derive an explicit and implementable, step-by-step sampling procedure for $K'$ over a finite time step $\\Delta t$ in terms of standard random variables with known distributions. Then, using your sampling representation and working consistently to first order in $\\Delta t$, compute the first two conditional moments of the velocity scaling factor $\\alpha$ given the current kinetic energy $K$, namely the conditional mean $\\mathbb{E}[\\alpha \\mid K]$ and the conditional variance $\\mathrm{Var}(\\alpha \\mid K)$, both accurate up to $\\mathcal{O}(\\Delta t)$.\n\nYou must:\n- Express the sampling procedure for $K'$ using only standard normal and chi-square random variables, and include all necessary constants as functions of $(f, \\bar{K}, K, \\tau, \\Delta t)$.\n- Define precisely the conditional moments you compute and show how they result from your sampling representation to first order in $\\Delta t$.\n- Provide your final expressions for $\\mathbb{E}[\\alpha \\mid K]$ and $\\mathrm{Var}(\\alpha \\mid K)$ as closed-form analytic expressions in terms of $f$, $\\bar{K}$, $K$, $\\tau$, and $\\Delta t$.\n\nExpress the final answer as a single analytical expression. No numerical evaluation or rounding is required.",
            "solution": "The core of the stochastic velocity rescaling method is to modify the system's kinetic energy $K$ at discrete time steps $\\Delta t$ by scaling all particle velocities $v_i$ by a common factor $\\alpha$. The new kinetic energy $K'$ is related to the old kinetic energy $K$ by $K' = \\alpha^2 K$. The scaling factor $\\alpha$ is a random variable chosen such that the stationary distribution of $K$ is the canonical Gamma distribution, $P(K) \\propto K^{f/2-1} \\exp(-K/\\beta)$, where $\\beta=k_B T = 2\\bar{K}/f$, and the system relaxes towards this distribution with a characteristic time $\\tau$.\n\n**Part 1: Derivation of the Sampling Procedure for $K'**\n\nThe stochastic update rule is designed to be equivalent to weakly coupling the system to a bath, which can be modeled by a stochastic differential equation. A robust way to construct the finite-time-step update is to consider the evolution in the space of mass-weighted velocities, $\\mathbf{x} = \\{\\sqrt{m_i}v_i\\}$, a vector in an $f$-dimensional space. The kinetic energy is $K = \\frac{1}{2}\\|\\mathbf{x}\\|^2$. The evolution over a time step $\\Delta t$ can be modeled as a relaxation process:\n$$ \\mathbf{x}(t+\\Delta t) = \\sqrt{c} \\mathbf{x}(t) + \\sqrt{1-c} \\mathbf{x}_{\\text{ran}} $$\nwhere $c = \\exp(-\\Delta t/\\tau)$ and $\\mathbf{x}_{\\text{ran}}$ is a random vector drawn from the equilibrium distribution, i.e., its components are independent Gaussian random variables with variance $k_B T$. The new kinetic energy $K'$ is $K'=\\frac{1}{2}\\|\\mathbf{x}(t+\\Delta t)\\|^2$.\n$$ K' = \\frac{1}{2} \\left( \\sqrt{c} \\mathbf{x}(t) + \\sqrt{1-c} \\mathbf{x}_{\\text{ran}} \\right) \\cdot \\left( \\sqrt{c} \\mathbf{x}(t) + \\sqrt{1-c} \\mathbf{x}_{\\text{ran}} \\right) $$\n$$ K' = \\frac{c}{2}\\|\\mathbf{x}(t)\\|^2 + \\frac{1-c}{2}\\|\\mathbf{x}_{\\text{ran}}\\|^2 + \\sqrt{c(1-c)} (\\mathbf{x}(t) \\cdot \\mathbf{x}_{\\text{ran}}) $$\n$$ K' = cK + (1-c)K_{\\text{ran}} + \\sqrt{c(1-c)} (\\mathbf{x} \\cdot \\mathbf{x}_{\\text{ran}}) $$\nTo express this in terms of standard random variables, we analyze each term. $K_{\\text{ran}} = \\frac{1}{2}\\|\\mathbf{x}_{\\text{ran}}\\|^2$ is the kinetic energy of a random system drawn from the canonical ensemble. It follows a Gamma distribution, which can be constructed from a sum of squared Gaussian variables. Specifically, $K_{\\text{ran}} = \\frac{1}{2}k_B T S_f = \\frac{\\bar{K}}{f}S_f$, where $S_f$ is a random variate from a chi-square distribution with $f$ degrees of freedom, $S_f \\sim \\chi^2_f$.\n\nThe dot product term $\\mathbf{x} \\cdot \\mathbf{x}_{\\text{ran}}$ can be simplified by projecting $\\mathbf{x}_{\\text{ran}}$ onto the direction of $\\mathbf{x}$, defined by the unit vector $\\hat{\\mathbf{u}} = \\mathbf{x}/\\|\\mathbf{x}\\| = \\mathbf{x}/\\sqrt{2K}$.\n$$ \\mathbf{x}_{\\text{ran}} = (\\mathbf{x}_{\\text{ran}} \\cdot \\hat{\\mathbf{u}})\\hat{\\mathbf{u}} + \\mathbf{x}_{\\text{ran},\\perp} $$\nThe parallel projection $\\mathbf{x}_{\\text{ran}} \\cdot \\hat{\\mathbf{u}}$ is a linear combination of independent Gaussian variables (the components of $\\mathbf{x}_{\\text{ran}}$), and is thus itself a Gaussian variable. Its mean is zero and its variance is $k_B T$. We can write it as $\\sqrt{k_B T} Z$, where $Z \\sim \\mathcal{N}(0,1)$. The orthogonal part $\\mathbf{x}_{\\text{ran},\\perp}$ lives in an $(f-1)$-dimensional subspace.\nThe kinetic energy of the random vector decomposes accordingly:\n$$ K_{\\text{ran}} = \\frac{1}{2} (\\mathbf{x}_{\\text{ran}} \\cdot \\hat{\\mathbf{u}})^2 + \\frac{1}{2} \\|\\mathbf{x}_{\\text{ran},\\perp}\\|^2 = \\frac{1}{2}k_B T Z^2 + \\frac{1}{2}k_B T S_{f-1} = \\frac{\\bar{K}}{f}(Z^2 + S_{f-1})$$\nwhere $S_{f-1} \\sim \\chi^2_{f-1}$ is drawn independently of $Z$. This confirms that $Z^2+S_{f-1}$ is a $\\chi^2_f$ variate, as expected.\n\nThe cross term in the expression for $K'$ becomes:\n$$ \\mathbf{x} \\cdot \\mathbf{x}_{\\text{ran}} = \\|\\mathbf{x}\\| (\\hat{\\mathbf{u}} \\cdot \\mathbf{x}_{\\text{ran}}) = \\sqrt{2K} (\\sqrt{k_B T} Z) = Z\\sqrt{2K k_B T} = Z\\sqrt{2K \\frac{2\\bar{K}}{f}} = 2Z\\sqrt{\\frac{K\\bar{K}}{f}} $$\nSubstituting these components back into the equation for $K'$:\n$$ K' = cK + (1-c)\\frac{\\bar{K}}{f}(Z^2 + S_{f-1}) + \\sqrt{c(1-c)} \\left(2Z\\sqrt{\\frac{K\\bar{K}}{f}}\\right) $$\nThis provides the explicit sampling procedure for $K'$. In summary:\n1.  Let $c = \\exp(-\\Delta t/\\tau)$.\n2.  Generate a standard normal random variate $Z \\sim \\mathcal{N}(0,1)$.\n3.  Generate a chi-square random variate $S_{f-1} \\sim \\chi^2_{f-1}$, independent of $Z$.\n4.  Calculate the new kinetic energy $K'$ using the formula:\n    $$ K' = cK + (1-c)\\frac{\\bar K}{f}(Z^2+S_{f-1}) + 2Z\\sqrt{c(1-c)\\frac{K\\bar K}{f}} $$\n\n**Part 2: Calculation of the Conditional Moments of $\\alpha$**\n\nWe need to compute the conditional mean $\\mathbb{E}[\\alpha \\mid K]$ and variance $\\mathrm{Var}(\\alpha \\mid K)$ to first order in $\\Delta t$. The velocity scaling factor $\\alpha$ is given by $\\alpha = \\sqrt{K'/K}$. We first find an expression for $\\alpha^2 = K'/K$:\n$$ \\alpha^2 = c + (1-c)\\frac{\\bar K}{fK}(Z^2+S_{f-1}) + 2Z\\sqrt{c(1-c)\\frac{\\bar K}{fK}} $$\nWe expand for small $\\Delta t$. Let $\\gamma = \\sqrt{\\Delta t/\\tau}$. Then $c = \\exp(-\\Delta t/\\tau) \\approx 1 - (\\Delta t/\\tau) = 1-\\gamma^2$. So $1-c \\approx \\gamma^2$ and $\\sqrt{c(1-c)} \\approx \\sqrt{1 \\cdot \\gamma^2} = \\gamma$.\nSubstituting these approximations, we get $\\alpha^2$ up to order $\\gamma^2 = \\Delta t/\\tau$:\n$$ \\alpha^2 \\approx (1-\\gamma^2) + \\gamma^2\\frac{\\bar K}{fK}(Z^2+S_{f-1}) + 2\\gamma Z\\sqrt{\\frac{\\bar K}{fK}} $$\n$$ \\alpha^2 \\approx 1 + 2\\gamma Z\\sqrt{\\frac{\\bar K}{fK}} + \\gamma^2 \\left( \\frac{\\bar K}{fK}(Z^2+S_{f-1}) - 1 \\right) $$\nTo find $\\alpha$, we take the square root, using the expansion $\\sqrt{1+x} \\approx 1 + x/2 - x^2/8$.\nLet $A = Z\\sqrt{\\frac{\\bar K}{fK}}$ and $B = \\frac{\\bar K}{fK}(Z^2+S_{f-1}) - 1$.\nThen $\\alpha^2 \\approx 1 + 2\\gamma A + \\gamma^2 B$.\n$$ \\alpha = (1 + 2\\gamma A + \\gamma^2 B)^{1/2} \\approx 1 + \\frac{1}{2}(2\\gamma A + \\gamma^2 B) - \\frac{1}{8}(2\\gamma A)^2 $$\n$$ \\alpha \\approx 1 + \\gamma A + \\frac{1}{2}\\gamma^2 B - \\frac{1}{2}\\gamma^2 A^2 $$\nKeeping terms up to $\\mathcal{O}(\\gamma^2) = \\mathcal{O}(\\Delta t)$:\n$$ \\alpha \\approx 1 + \\gamma Z\\sqrt{\\frac{\\bar K}{fK}} + \\frac{1}{2}\\gamma^2 \\left[ \\left(\\frac{\\bar K}{fK}(Z^2+S_{f-1}) - 1\\right) - Z^2\\frac{\\bar K}{fK} \\right] $$\n$$ \\alpha \\approx 1 + \\sqrt{\\frac{\\Delta t}{\\tau}} Z\\sqrt{\\frac{\\bar K}{fK}} + \\frac{1}{2}\\frac{\\Delta t}{\\tau} \\left( \\frac{\\bar K}{fK}S_{f-1} - 1 \\right) $$\n\nNow we compute the conditional moments using this expansion. The random variables are $Z$ and $S_{f-1}$, with moments $\\mathbb{E}[Z]=0$, $\\mathbb{E}[Z^2]=1$, $\\mathbb{E}[S_{f-1}]=f-1$, and $\\mathrm{Var}(S_{f-1})=2(f-1)$.\n\nThe conditional mean $\\mathbb{E}[\\alpha \\mid K]$ is:\n$$ \\mathbb{E}[\\alpha \\mid K] \\approx \\mathbb{E}\\left[ 1 + \\sqrt{\\frac{\\Delta t}{\\tau}} Z\\sqrt{\\frac{\\bar K}{fK}} + \\frac{1}{2}\\frac{\\Delta t}{\\tau} \\left( \\frac{\\bar K}{fK}S_{f-1} - 1 \\right) \\right] $$\n$$ \\mathbb{E}[\\alpha \\mid K] \\approx 1 + \\sqrt{\\frac{\\Delta t}{\\tau}}\\sqrt{\\frac{\\bar K}{fK}}\\mathbb{E}[Z] + \\frac{1}{2}\\frac{\\Delta t}{\\tau} \\left( \\frac{\\bar K}{fK}\\mathbb{E}[S_{f-1}] - 1 \\right) $$\n$$ \\mathbb{E}[\\alpha \\mid K] \\approx 1 + 0 + \\frac{1}{2}\\frac{\\Delta t}{\\tau} \\left( \\frac{\\bar K}{fK}(f-1) - 1 \\right) = 1 + \\frac{\\Delta t}{2\\tau} \\left( \\frac{\\bar K}{K}\\frac{f-1}{f} - 1 \\right) $$\nThis is the conditional mean to first order in $\\Delta t$.\n\nThe conditional variance is $\\mathrm{Var}(\\alpha \\mid K) = \\mathbb{E}[\\alpha^2 \\mid K] - (\\mathbb{E}[\\alpha \\mid K])^2$.\nFirst, $\\mathbb{E}[\\alpha^2 \\mid K]$ to $\\mathcal{O}(\\Delta t)$:\n$$ \\mathbb{E}[\\alpha^2 \\mid K] = \\mathbb{E}\\left[ c + (1-c)\\frac{\\bar K}{fK}(Z^2+S_{f-1}) + 2Z\\sqrt{c(1-c)\\frac{\\bar K}{fK}} \\right] $$\n$$ \\mathbb{E}[\\alpha^2 \\mid K] = c + (1-c)\\frac{\\bar K}{fK}(\\mathbb{E}[Z^2]+\\mathbb{E}[S_{f-1}]) = c+(1-c)\\frac{\\bar K}{fK}(1+f-1) = c+(1-c)\\frac{\\bar K}{K} $$\n$$ \\mathbb{E}[\\alpha^2 \\mid K] \\approx \\left(1-\\frac{\\Delta t}{\\tau}\\right) + \\frac{\\Delta t}{\\tau}\\frac{\\bar K}{K} = 1 + \\frac{\\Delta t}{\\tau}\\left(\\frac{\\bar K}{K}-1\\right) $$\nNext, $(\\mathbb{E}[\\alpha \\mid K])^2$ to $\\mathcal{O}(\\Delta t)$:\n$$ (\\mathbb{E}[\\alpha \\mid K])^2 \\approx \\left( 1 + \\frac{\\Delta t}{2\\tau} \\left( \\frac{\\bar K}{K}\\frac{f-1}{f} - 1 \\right) \\right)^2 \\approx 1 + 2 \\cdot \\frac{\\Delta t}{2\\tau} \\left( \\frac{\\bar K}{K}\\frac{f-1}{f} - 1 \\right) $$\n$$ (\\mathbb{E}[\\alpha \\mid K])^2 \\approx 1 + \\frac{\\Delta t}{\\tau}\\left(\\frac{\\bar K}{K} - \\frac{\\bar K}{fK} - 1\\right) $$\nFinally, the variance:\n$$ \\mathrm{Var}(\\alpha \\mid K) \\approx \\left(1 + \\frac{\\Delta t}{\\tau}\\left(\\frac{\\bar K}{K}-1\\right)\\right) - \\left(1 + \\frac{\\Delta t}{\\tau}\\left(\\frac{\\bar K}{K} - \\frac{\\bar K}{fK} - 1\\right)\\right) $$\n$$ \\mathrm{Var}(\\alpha \\mid K) \\approx \\frac{\\Delta t}{\\tau} \\left( \\left(\\frac{\\bar K}{K}-1\\right) - \\left(\\frac{\\bar K}{K} - \\frac{\\bar K}{fK} - 1\\right) \\right) = \\frac{\\Delta t}{\\tau} \\frac{\\bar K}{fK} $$\nThis is the conditional variance to first order in $\\Delta t$. Note that this result could also be found more directly by taking the variance of the leading random term in the expansion of $\\alpha$, which is of order $\\sqrt{\\Delta t}$.\n\nThe final expressions for the conditional mean and variance of $\\alpha$ are collected in the final answer.",
            "answer": "$$ \\boxed{ \\begin{pmatrix} 1 + \\frac{\\Delta t}{2\\tau} \\left( \\frac{\\bar{K}}{K}\\frac{f-1}{f} - 1 \\right) & \\frac{\\Delta t}{\\tau} \\frac{\\bar{K}}{fK} \\end{pmatrix} } $$"
        },
        {
            "introduction": "A correct theoretical formula does not guarantee a successful simulation; its implementation must also be numerically robust. This final hands-on practice  addresses the critical challenge of implementing the SVR update in a way that avoids numerical instabilities, particularly when the system's kinetic energy is low. By reformulating the update rule using dimensionless variables and a sum-of-squares representation, you will learn a vital skill in scientific computing: how to translate mathematical theory into stable and reliable code.",
            "id": "3449887",
            "problem": "Consider a molecular dynamics system with $N_f$ effective quadratic degrees of freedom coupled to a stochastic velocity rescaling thermostat that preserves the canonical ensemble at temperature $T$. Let the instantaneous kinetic energy be $K$, and let $\\bar K = \\frac{N_f}{2} k_{\\mathrm B} T$ be the canonical mean kinetic energy, where $k_{\\mathrm B}$ is Boltzmann’s constant. The thermostat is characterized by a relaxation time $\\tau$ and a time step $\\Delta t$. Define $c = \\exp(-\\Delta t/\\tau)$. In the exact integrator for stochastic velocity rescaling, the kinetic energy after the thermostatting step, $K'$, is related to $K$ through a noncentral chi-square transition that can be written in terms of one standard normal random variable $R \\sim \\mathcal N(0,1)$ and one chi-square random variable $s \\sim \\chi^2_{N_f - 1}$, independent of each other. The rescaling factor $\\alpha$ is defined by $K' = \\alpha^2 K$, so that all velocities $\\mathbf v$ are mapped to $\\mathbf v' = \\alpha \\mathbf v$ during the thermostat step.\n\nA direct computation of $\\alpha$ by dividing an explicit formula for $K'$ by $K$ often involves terms proportional to $1/K$ and can suffer catastrophic loss of significance when $K$ is small. Your task is to select the algorithm that computes $\\alpha$ in a numerically stable way for all $K \\ge 0$ by (i) using a square-root, sum-of-squares representation of the update, and (ii) scaling all quantities to dimensionless units of order unity before forming divisions.\n\nWhich option below achieves this goal while remaining an exact implementation of the stochastic velocity rescaling step?\n\nA) Compute\n\n$$\n\\alpha^2 \\;=\\; c \\;+\\; (1-c)\\,\\frac{\\bar K}{N_f K}\\,(s + R^2)\\;+\\; 2 R \\sqrt{ \\frac{c (1-c)\\, \\bar K}{N_f K} },\n$$\n\nthen set $\\alpha = \\sqrt{\\alpha^2}$.\n\nB) Let $a = \\sqrt{c}$, $b = \\sqrt{1-c}$, and define the dimensionless energy amplitude $u = \\sqrt{K/\\bar K}$. Draw $R \\sim \\mathcal N(0,1)$ and $s \\sim \\chi^2_{N_f-1}$. Form\n\n$$\nq \\;=\\; \\sqrt{ \\left( a u + \\frac{b}{\\sqrt{N_f}} R \\right)^2 \\;+\\; \\frac{b^2}{N_f}\\, s },\n$$\n\nevaluating the square root of the sum of squares using a numerically robust routine for $\\sqrt{x^2+y^2}$. Return $\\alpha = q/u$ using a stable ratio evaluation. If $u$ is below a small threshold $\\varepsilon$, first compute $\\alpha u = q$ and apply the scaling to velocities via $\\mathbf v' = (\\alpha u/u)\\,\\mathbf v$ with a safeguarded denominator $u \\leftarrow \\max(u,\\varepsilon)$.\n\nC) Use an Euler–Maruyama discretization of the kinetic-energy Ornstein–Uhlenbeck drift-diffusion to obtain\n\n$$\n\\alpha \\;=\\; 1 \\;+\\; \\frac{\\Delta t}{2 \\tau} \\left( \\frac{\\bar K}{K} - 1 \\right) \\;+\\; \\sqrt{ \\frac{\\Delta t}{\\tau N_f}\\,\\frac{\\bar K}{K} }\\, R.\n$$\n\n\nD) Approximate the thermostatting as a linear combination of deterministic relaxation and random heating, and compute\n\n$$\n\\alpha \\;=\\; \\sqrt{c} \\;+\\; \\sqrt{1-c}\\,\\sqrt{ \\frac{\\bar K}{N_f K} }\\, \\sqrt{s + R^2}.\n$$\n\n\nSelect the correct option and justify your choice by deriving, from first principles and accepted properties of the exact stochastic velocity rescaling transition, why the chosen algorithm is both exact and numerically stable when $K$ is small. Your derivation must start from the canonical equipartition relation, the definition of $\\bar K$, and the exact noncentral chi-square transition for $K$, and may use only well-tested facts about Gaussian and chi-square random variables, algebraic manipulations, and dimensionless scaling arguments. Avoid any appeal to unstated shortcut formulas.",
            "solution": "### Derivation and Option Analysis\n\nThe goal is to find an exact and numerically stable algorithm for computing the velocity scaling factor $\\alpha$. The derivation will start from the fundamental statistical mechanics of the SVR thermostat.\n\n**1. First-Principles Derivation of the Exact Kinetic Energy Transition**\n\nThe SVR thermostat generates new momenta $p'_j$ for each of the $N_f$ degrees of freedom from a conditional Gaussian distribution that depends on the old momenta $p_j$. This process correctly propagates the canonical ensemble. The update rule for a single momentum is:\n$$ p'_j = p_j \\sqrt{c} + \\sqrt{(1-c) m k_{\\mathrm B} T} \\cdot \\eta_j $$\nwhere $c = \\exp(-\\Delta t/\\tau)$ and $\\eta_j \\sim \\mathcal{N}(0,1)$ are independent standard normal variates. The new total kinetic energy $K'$ is the sum over all degrees of freedom:\n$$ K' = \\sum_{j=1}^{N_f} \\frac{(p'_j)^2}{2m} = \\sum_{j=1}^{N_f} \\frac{1}{2m} \\left( p_j \\sqrt{c} + \\sqrt{(1-c) m k_{\\mathrm B} T} \\cdot \\eta_j \\right)^2 $$\nExpanding the square:\n$$ K' = \\sum_{j=1}^{N_f} \\left( \\frac{c p_j^2}{2m} + \\frac{(1-c) m k_{\\mathrm B} T}{2m} \\eta_j^2 + \\frac{2\\sqrt{c(1-c) m k_{\\mathrm B} T}}{2m} p_j \\eta_j \\right) $$\nSumming over $j$ and identifying terms:\n-   $\\sum \\frac{p_j^2}{2m} = K$ (the old kinetic energy).\n-   $\\sum \\eta_j^2$ is a sum of squares of $N_f$ standard normal variates.\n-   $\\sum p_j \\eta_j$ is the dot product of the momentum vector $\\mathbf{p}$ and the random vector $\\boldsymbol{\\eta}$.\n\nThe vector $\\boldsymbol{\\eta}$ can be decomposed into a component parallel to $\\mathbf{p}$ and a component perpendicular to it. Let $\\mathbf{u_p} = \\mathbf{p} / |\\mathbf{p}|$ be the unit vector in the direction of the momentum vector.\n-   The projection of $\\boldsymbol{\\eta}$ onto $\\mathbf{u_p}$ is $\\boldsymbol{\\eta} \\cdot \\mathbf{u_p}$. This is a scalar random variable from $\\mathcal{N}(0,1)$, which we identify with the problem's $R$.\n-   The dot product becomes $\\sum p_j \\eta_j = \\mathbf{p} \\cdot \\boldsymbol{\\eta} = |\\mathbf{p}| (\\mathbf{u_p} \\cdot \\boldsymbol{\\eta}) = |\\mathbf{p}| R$. We know $|\\mathbf{p}| = \\sqrt{2mK}$.\n-   By the Pythagorean theorem in $N_f$ dimensions, $\\sum \\eta_j^2 = (\\mathbf{u_p} \\cdot \\boldsymbol{\\eta})^2 + |\\boldsymbol{\\eta}_\\perp|^2 = R^2 + s$. Here, $s = |\\boldsymbol{\\eta}_\\perp|^2$ is the sum of squares of the $N_f-1$ components of $\\boldsymbol{\\eta}$ perpendicular to $\\mathbf{p}$. This is, by definition, a chi-square random variable with $N_f-1$ degrees of freedom, $s \\sim \\chi^2_{N_f-1}$, and it is independent of $R$.\n\nSubstituting these into the expression for $K'$:\n$$ K' = c K + (1-c) \\frac{k_{\\mathrm B} T}{2} (s+R^2) + \\sqrt{\\frac{c(1-c)k_{\\mathrm B} T}{m}} ( \\sqrt{2mK} R ) $$\nUsing $\\bar K = \\frac{N_f}{2}k_{\\mathrm B} T \\implies k_{\\mathrm B} T = 2\\bar K/N_f$:\n$$ K' = c K + (1-c) \\frac{\\bar K}{N_f} (s+R^2) + \\sqrt{2c(1-c) k_{\\mathrm B} T K} R $$\n$$ K' = c K + (1-c) \\frac{\\bar K}{N_f} (s+R^2) + \\sqrt{2c(1-c) \\frac{2\\bar K}{N_f} K} R $$\n$$ K' = c K + (1-c) \\frac{\\bar K}{N_f} (s+R^2) + 2R \\sqrt{\\frac{c(1-c) K \\bar K}{N_f}} $$\nThis is the exact expression for the new kinetic energy $K'$.\n\n**2. Analysis of Options**\n\n**Option A:**\nThis option provides a formula for $\\alpha^2 = K'/K$:\n$$ \\alpha^2 \\;=\\; c \\;+\\; (1-c)\\,\\frac{\\bar K}{N_f K}\\,(s + R^2)\\;+\\; 2 R \\sqrt{ \\frac{c (1-c)\\, \\bar K}{N_f K} } $$\nDividing our derived expression for $K'$ by $K$ yields this exact formula. Thus, Option A is algebraically correct. However, the question demands a numerically stable algorithm. The presence of terms proportional to $1/K$ and $1/\\sqrt{K}$ makes this formula highly unstable as $K \\to 0$. For instance, if $R$ is a large negative number, the formula involves the subtraction of two large numbers, a classic source of catastrophic cancellation. Therefore, this option is not a suitable algorithm.\n**Verdict: Incorrect.**\n\n**Option C:**\nThis option provides an expression for $\\alpha$ based on an Euler-Maruyama discretization.\n$$ \\alpha \\;=\\; 1 \\;+\\; \\frac{\\Delta t}{2 \\tau} \\left( \\frac{\\bar K}{K} - 1 \\right) \\;+\\; \\sqrt{ \\frac{\\Delta t}{\\tau N_f}\\,\\frac{\\bar K}{K} }\\, R $$\nSuch a discretization is an approximation, valid only in the limit of small time steps ($\\Delta t \\ll \\tau$). The problem explicitly requires an *exact* implementation of the SVR step. This option fails the exactness criterion. It also suffers from the same numerical instability as Option A due to the $1/K$ and $1/\\sqrt{K}$ terms.\n**Verdict: Incorrect.**\n\n**Option D:**\nThis option provides an alternative approximate formula for $\\alpha$:\n$$ \\alpha \\;=\\; \\sqrt{c} \\;+\\; \\sqrt{1-c}\\,\\sqrt{ \\frac{\\bar K}{N_f K} }\\, \\sqrt{s + R^2} $$\nSquaring this expression gives:\n$$ \\alpha^2 = c + (1-c)\\frac{\\bar K}{N_f K}(s+R^2) + 2\\sqrt{c(1-c)\\frac{\\bar K}{N_f K}(s+R^2)} $$\nThis does not match the exact expression for $\\alpha^2$ derived above. The final term, in particular, is different. The exact expression has a term linear in $R$, while this approximation has a term proportional to $\\sqrt{s+R^2}$. Thus, this option is not an exact implementation.\n**Verdict: Incorrect.**\n\n**Option B:**\nThis option proposes a multi-step algorithm. Let's analyze it by reformulating our exact expression for $K'$ to match the problem's stability requirements.\nStarting from the exact expression for $K'$:\n$$ K' = c K + 2R \\sqrt{\\frac{c(1-c) K \\bar K}{N_f}} + (1-c) \\frac{\\bar K}{N_f} (s+R^2) $$\nWe can rearrange this into a sum of squares to improve numerical stability. Let's group the terms involving $R$:\n$$ K' = \\left( cK + 2R \\sqrt{\\frac{c(1-c) K \\bar K}{N_f}} + (1-c) \\frac{\\bar K}{N_f} R^2 \\right) + (1-c) \\frac{\\bar K}{N_f} s $$\nThe term in parentheses can be recognized as a perfect square:\n$$ K' = \\left( \\sqrt{cK} + R\\sqrt{\\frac{(1-c)\\bar K}{N_f}} \\right)^2 + \\frac{(1-c)\\bar K}{N_f} s $$\nThis expression for $K'$ avoids any division by $K$ and is formulated as a sum of non-negative terms, fulfilling the \"square-root, sum-of-squares\" hint (i).\n\nNow, we introduce dimensionless quantities as per hint (ii). Let $u = \\sqrt{K/\\bar K}$ be the dimensionless energy amplitude. Let $a = \\sqrt{c}$ and $b = \\sqrt{1-c}$. Divide the expression for $K'$ by $\\bar K$:\n$$ \\frac{K'}{\\bar K} = \\frac{1}{\\bar K} \\left( \\sqrt{cK} + R\\sqrt{\\frac{(1-c)\\bar K}{N_f}} \\right)^2 + \\frac{1-c}{N_f} s $$\nFactor out $\\bar K$ from the squared term:\n$$ \\frac{K'}{\\bar K} = \\frac{1}{\\bar K} \\left[ \\sqrt{\\bar K} \\left( \\sqrt{c \\frac{K}{\\bar K}} + R\\sqrt{\\frac{1-c}{N_f}} \\right) \\right]^2 + \\frac{(1-c)}{N_f} s $$\n$$ \\frac{K'}{\\bar K} = \\left( \\sqrt{c} u + \\frac{R}{\\sqrt{N_f}}\\sqrt{1-c} \\right)^2 + \\frac{(1-c)}{N_f} s $$\nUsing the definitions $a$ and $b$:\n$$ \\frac{K'}{\\bar K} = \\left( a u + \\frac{b}{\\sqrt{N_f}} R \\right)^2 + \\frac{b^2}{N_f} s $$\nThis exactly matches the expression for $q^2$ given in Option B, where $q = \\sqrt{K'/\\bar K}$. The use of a robust routine for $\\sqrt{x^2+y^2}$ (like `hypot(x,y)`) is standard practice for this form.\n\nThe scaling factor $\\alpha$ is defined by $K' = \\alpha^2 K$. In dimensionless terms, $q^2 \\bar K = \\alpha^2 u^2 \\bar K$, which gives $\\alpha^2 = q^2/u^2$, or $\\alpha = q/u$.\nAs $K \\to 0$, $u \\to 0$, causing $\\alpha$ to diverge. A direct computation of $\\alpha$ would be numerically unstable. The velocity update is $\\mathbf{v}' = \\alpha \\mathbf{v}$. This can be rewritten as:\n$$ \\mathbf{v}' = \\left(\\frac{q}{u}\\right) \\mathbf{v} = q \\left(\\frac{\\mathbf{v}}{u}\\right) $$\nLet's analyze the vector $\\mathbf{w} = \\mathbf{v}/u$. Its squared magnitude is $|\\mathbf{w}|^2 = |\\mathbf{v}|^2 / u^2 = |\\mathbf{v}|^2 / (K/\\bar K)$. Since $K$ is proportional to $|\\mathbf{v}|^2$ (i.e., $K = A|\\mathbf{v}|^2$ for some constant $A$), we have $|\\mathbf{w}|^2 = (K/A) / (K/\\bar K) = \\bar K / A$. This is a constant. Thus, the vector $\\mathbf{v}/u$ has a magnitude that is independent of $K$, making it numerically well-behaved even as $K \\to 0$. The new velocity can be computed as $\\mathbf{v}' = q \\mathbf{w}$, which avoids the problematic division by small $u$. This matches the stable evaluation strategy implied by Option B's phrasing. The explicit safeguarding mention for small $u$ is a practical implementation detail that confirms the careful handling of this limit.\n\nThus, the algorithm in Option B is an exact, algebraically transformed version of the SVR update, designed for optimal numerical stability by using a sum-of-squares form and dimensionless scaling to avoid divisions by small numbers.\n**Verdict: Correct.**",
            "answer": "$$\\boxed{B}$$"
        }
    ]
}