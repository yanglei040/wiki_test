{
    "hands_on_practices": [
        {
            "introduction": "The reciprocal-space portion of the Ewald sum can seem abstract, but it is directly tied to the geometric arrangement of charges in your system. This practice provides a concrete foundation by having you calculate the structure factor, $S(\\mathbf{k})$, for a classic rock-salt crystal . By deriving the \"selection rules\" that determine which reciprocal vectors contribute to the sum, you will gain a deeper intuition for how the Fourier-space representation reflects the real-space charge distribution.",
            "id": "3422408",
            "problem": "In the reciprocal-space part of Ewald summation for a periodic molecular dynamics simulation, the reciprocal-space structure factor for a set of point charges is defined by $S(\\mathbf{k})=\\sum_{j=1}^{N} q_{j}\\exp(i\\,\\mathbf{k}\\cdot\\mathbf{r}_{j})$, where $q_{j}$ are charges and $\\mathbf{r}_{j}$ are their positions in the unit cell of side length $a$. Consider a conventional rock-salt unit cell constructed as follows: an underlying face-centered cubic lattice with four lattice points at fractional coordinates $(0,0,0)$, $(0,\\tfrac{1}{2},\\tfrac{1}{2})$, $(\\tfrac{1}{2},0,\\tfrac{1}{2})$, $(\\tfrac{1}{2},\\tfrac{1}{2},0)$ in units of $a$, occupied by charges $+q$, and a second, interpenetrating face-centered cubic lattice obtained by a basis shift $\\mathbf{d}=(\\tfrac{1}{2},\\tfrac{1}{2},\\tfrac{1}{2})$ (in units of $a$), occupied by charges $-q$. Thus the unit cell contains $8$ charges at positions $\\mathbf{R}_{\\alpha}$ with $\\alpha=1,\\dots,8$, four with charge $+q$ at $\\mathbf{R}_{1}=(0,0,0)$, $\\mathbf{R}_{2}=(0,\\tfrac{1}{2},\\tfrac{1}{2})$, $\\mathbf{R}_{3}=(\\tfrac{1}{2},0,\\tfrac{1}{2})$, $\\mathbf{R}_{4}=(\\tfrac{1}{2},\\tfrac{1}{2},0)$, and four with charge $-q$ at $\\mathbf{R}_{5}=\\mathbf{R}_{1}+\\mathbf{d}$, $\\mathbf{R}_{6}=\\mathbf{R}_{2}+\\mathbf{d}$, $\\mathbf{R}_{7}=\\mathbf{R}_{3}+\\mathbf{d}$, $\\mathbf{R}_{8}=\\mathbf{R}_{4}+\\mathbf{d}$. The reciprocal lattice vectors of the periodic simulation box are $\\mathbf{k}=\\frac{2\\pi}{a}(h,k,l)$ with integers $h,k,l$.\n\nUsing only the definition of $S(\\mathbf{k})$, compute $S(\\mathbf{k})$ explicitly for the six smallest nonzero reciprocal vectors of the cubic reciprocal lattice, namely $\\mathbf{k}=\\frac{2\\pi}{a}(1,0,0)$, $\\mathbf{k}=\\frac{2\\pi}{a}(-1,0,0)$, $\\mathbf{k}=\\frac{2\\pi}{a}(0,1,0)$, $\\mathbf{k}=\\frac{2\\pi}{a}(0,-1,0)$, $\\mathbf{k}=\\frac{2\\pi}{a}(0,0,1)$, $\\mathbf{k}=\\frac{2\\pi}{a}(0,0,-1)$, and from those results infer the smallest nonzero magnitude $|\\mathbf{k}|$ for which $S(\\mathbf{k})\\neq 0$.\n\nAnswer format requirement: Report the final answer as the single dimensionless number equal to $|\\mathbf{k}_{\\min}|/(2\\pi/a)$. Do not include any units. No rounding is required; provide the exact value.",
            "solution": "The problem asks for the computation of the reciprocal-space structure factor $S(\\mathbf{k})$ for a specific crystal structure and a given set of reciprocal lattice vectors, and then to infer the smallest nonzero magnitude $|\\mathbf{k}|$ for which $S(\\mathbf{k})$ is nonzero.\n\nFirst, we validate the problem statement.\n\n### Step 1: Extract Givens\n-   The structure factor is defined as $S(\\mathbf{k})=\\sum_{j=1}^{N} q_{j}\\exp(i\\,\\mathbf{k}\\cdot\\mathbf{r}_{j})$.\n-   The system is a rock-salt unit cell with side length $a$.\n-   There are $N=8$ point charges in the unit cell.\n-   Four charges of $+q$ are located at positions corresponding to an FCC lattice: $\\mathbf{R}_{1}=a(0,0,0)$, $\\mathbf{R}_{2}=a(0,\\tfrac{1}{2},\\tfrac{1}{2})$, $\\mathbf{R}_{3}=a(\\tfrac{1}{2},0,\\tfrac{1}{2})$, and $\\mathbf{R}_{4}=a(\\tfrac{1}{2},\\tfrac{1}{2},0)$.\n-   Four charges of $-q$ are located at positions shifted by a basis vector $\\mathbf{d}=a(\\tfrac{1}{2},\\tfrac{1}{2},\\tfrac{1}{2})$ from the first set: $\\mathbf{R}_{j+4} = \\mathbf{R}_j + \\mathbf{d}$ for $j=1,2,3,4$.\n-   The reciprocal lattice vectors are given by $\\mathbf{k}=\\frac{2\\pi}{a}(h,k,l)$, where $h, k, l$ are integers.\n-   The specific task is to compute $S(\\mathbf{k})$ for the six vectors: $\\mathbf{k}=\\frac{2\\pi}{a}(\\pm 1,0,0)$, $\\mathbf{k}=\\frac{2\\pi}{a}(0,\\pm 1,0)$, and $\\mathbf{k}=\\frac{2\\pi}{a}(0,0,\\pm 1)$.\n-   From these results, we must infer the smallest nonzero magnitude $|\\mathbf{k}|$ for which $S(\\mathbf{k})\\neq 0$.\n-   The final answer should be the dimensionless value $|\\mathbf{k}_{\\min}|/(2\\pi/a)$.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is scientifically grounded, well-posed, and objective. It describes a standard calculation in solid-state physics for the structure factor of a classic ionic crystal (rock-salt structure). The definitions, positions, and lattice vectors are standard and self-consistent. The total charge of the unit cell is $4(+q) + 4(-q) = 0$, which is a necessary condition for the stability of a periodic ionic system. There are no contradictions, ambiguities, or missing information. The problem is valid.\n\n### Solution Derivation\n\nWe begin by writing out the full expression for the structure factor $S(\\mathbf{k})$ for the $N=8$ charges in the unit cell. We can group the summation into two parts: one for the four positive charges (denoted by positions $\\mathbf{c}_j$) and one for the four negative charges (denoted by positions $\\mathbf{a}_j$).\n$$S(\\mathbf{k}) = \\sum_{j=1}^{4} (+q) \\exp(i\\mathbf{k}\\cdot\\mathbf{c}_j) + \\sum_{j=1}^{4} (-q) \\exp(i\\mathbf{k}\\cdot\\mathbf{a}_j)$$\nwhere $\\mathbf{c}_j$ are the positions $\\mathbf{R}_1, \\dots, \\mathbf{R}_4$ and $\\mathbf{a}_j = \\mathbf{c}_j + \\mathbf{d}$. Substituting this relationship gives:\n$$S(\\mathbf{k}) = q \\sum_{j=1}^{4} \\exp(i\\mathbf{k}\\cdot\\mathbf{c}_j) - q \\sum_{j=1}^{4} \\exp(i\\mathbf{k}\\cdot(\\mathbf{c}_j + \\mathbf{d}))$$\nWe can factor out the term involving $\\mathbf{d}$ from the second sum:\n$$S(\\mathbf{k}) = q \\sum_{j=1}^{4} \\exp(i\\mathbf{k}\\cdot\\mathbf{c}_j) - q \\exp(i\\mathbf{k}\\cdot\\mathbf{d}) \\sum_{j=1}^{4} \\exp(i\\mathbf{k}\\cdot\\mathbf{c}_j)$$\nFactoring out the common summation term yields:\n$$S(\\mathbf{k}) = q \\left( 1 - \\exp(i\\mathbf{k}\\cdot\\mathbf{d}) \\right) \\left( \\sum_{j=1}^{4} \\exp(i\\mathbf{k}\\cdot\\mathbf{c}_j) \\right)$$\nThis expression separates the structure factor into two components:\n1.  A \"basis\" factor, $S_{basis}(\\mathbf{k}) = 1 - \\exp(i\\mathbf{k}\\cdot\\mathbf{d})$.\n2.  A \"geometric\" structure factor for the underlying FCC lattice, $S_{FCC}(\\mathbf{k}) = \\sum_{j=1}^{4} \\exp(i\\mathbf{k}\\cdot\\mathbf{c}_j)$.\n\nLet's analyze each factor in terms of the Miller indices $(h,k,l)$ of the reciprocal lattice vector $\\mathbf{k}=\\frac{2\\pi}{a}(h,k,l)$.\n\nFirst, the geometric structure factor $S_{FCC}(\\mathbf{k})$. The positions are $\\mathbf{c}_1=a(0,0,0)$, $\\mathbf{c}_2=a(0,1/2,1/2)$, $\\mathbf{c}_3=a(1/2,0,1/2)$, $\\mathbf{c}_4=a(1/2,1/2,0)$. The dot products $\\mathbf{k}\\cdot\\mathbf{c}_j$ are:\n$\\mathbf{k}\\cdot\\mathbf{c}_1 = 0$\n$\\mathbf{k}\\cdot\\mathbf{c}_2 = \\frac{2\\pi}{a}(h,k,l) \\cdot a(0,1/2,1/2) = \\pi(k+l)$\n$\\mathbf{k}\\cdot\\mathbf{c}_3 = \\frac{2\\pi}{a}(h,k,l) \\cdot a(1/2,0,1/2) = \\pi(h+l)$\n$\\mathbf{k}\\cdot\\mathbf{c}_4 = \\frac{2\\pi}{a}(h,k,l) \\cdot a(1/2,1/2,0) = \\pi(h+k)$\n\nThus, the geometric structure factor is:\n$$S_{FCC}(\\mathbf{k}) = \\exp(i \\cdot 0) + \\exp(i\\pi(k+l)) + \\exp(i\\pi(h+l)) + \\exp(i\\pi(h+k))$$\n$$S_{FCC}(\\mathbf{k}) = 1 + (-1)^{k+l} + (-1)^{h+l} + (-1)^{h+k}$$\nThis sum is non-zero only if the indices $(h,k,l)$ have unmixed parity (i.e., they are all even or all odd). In that case, $S_{FCC}(\\mathbf{k}) = 1+1+1+1 = 4$. If the parity is mixed, the sum is $0$.\n\nNext, we analyze the basis factor $S_{basis}(\\mathbf{k})$. With $\\mathbf{d} = a(1/2,1/2,1/2)$, the dot product is:\n$$\\mathbf{k}\\cdot\\mathbf{d} = \\frac{2\\pi}{a}(h,k,l) \\cdot a(1/2,1/2,1/2) = \\pi(h+k+l)$$\nSo, the basis factor is:\n$$S_{basis}(\\mathbf{k}) = 1 - \\exp(i\\pi(h+k+l)) = 1 - (-1)^{h+k+l}$$\nThis factor is non-zero only if $h+k+l$ is an odd integer. In this case, $S_{basis}(\\mathbf{k}) = 1 - (-1) = 2$. If $h+k+l$ is an even integer, $S_{basis}(\\mathbf{k}) = 1-1=0$.\n\nFor the total structure factor $S(\\mathbf{k}) = q \\cdot S_{basis}(\\mathbf{k}) \\cdot S_{FCC}(\\mathbf{k})$ to be non-zero, both factors must be non-zero. Let's combine the conditions:\n1.  $S_{FCC}(\\mathbf{k}) \\neq 0$: The indices $(h,k,l)$ must be all even or all odd.\n2.  $S_{basis}(\\mathbf{k}) \\neq 0$: The sum $h+k+l$ must be odd.\n\n-   If $(h,k,l)$ are all even, their sum $h+k+l$ is also even. This makes $S_{basis}(\\mathbf{k}) = 0$, so $S(\\mathbf{k})=0$.\n-   If $(h,k,l)$ are all odd, their sum $h+k+l = (2n_h+1) + (2n_k+1) + (2n_l+1) = 2(n_h+n_k+n_l)+3$ is odd. In this case, $S_{FCC}(\\mathbf{k})=4$ and $S_{basis}(\\mathbf{k})=2$. Both conditions are satisfied, and $S(\\mathbf{k}) = q(2)(4) = 8q \\neq 0$.\n-   If $(h,k,l)$ have mixed parity, $S_{FCC}(\\mathbf{k})=0$, so $S(\\mathbf{k})=0$.\n\nTherefore, the condition for a non-zero structure factor $S(\\mathbf{k})$ for the rock-salt lattice is that the Miller indices $(h,k,l)$ must all be odd integers.\n\nNow, we compute $S(\\mathbf{k})$ for the six specified reciprocal vectors. These vectors correspond to the Miller indices $(\\pm 1,0,0)$, $(0,\\pm 1,0)$, and $(0,0,\\pm 1)$.\nFor $\\mathbf{k}=\\frac{2\\pi}{a}(1,0,0)$, the indices are $(h,k,l)=(1,0,0)$. These indices have mixed parity (one odd, two even). According to our derived selection rule, $S(\\mathbf{k})$ must be $0$. The same logic applies to all six vectors, as each has one index equal to $\\pm 1$ and two indices equal to $0$. Thus, for all six specified vectors, $S(\\mathbf{k})=0$.\n\nThe problem then asks us to infer the smallest nonzero magnitude $|\\mathbf{k}|$ for which $S(\\mathbf{k})\\neq 0$. This requires finding the set of all-odd integers $(h,k,l)$ that minimizes the magnitude of $\\mathbf{k}$. The magnitude squared is given by:\n$$|\\mathbf{k}|^2 = \\left(\\frac{2\\pi}{a}\\right)^2 (h^2+k^2+l^2)$$\nTo minimize $|\\mathbf{k}|$, we must minimize the sum of squares $h^2+k^2+l^2$, under the constraint that $h, k, l$ are all non-zero odd integers. The smallest magnitude odd integers are $\\pm 1$. Choosing $h, k, l$ from the set $\\{\\pm 1\\}$ gives the smallest possible non-zero sum of squares.\nFor example, for $(h,k,l)=(1,1,1)$, the sum is $1^2+1^2+1^2=3$. Any other combination of all-odd integers (e.g., involving $\\pm 3$) would result in a larger sum (e.g., $1^2+1^2+3^2 = 11$).\nThe minimum value of $h^2+k^2+l^2$ subject to the condition is $3$.\n\nThe smallest nonzero magnitude $|\\mathbf{k}_{\\min}|$ is therefore:\n$$|\\mathbf{k}_{\\min}| = \\sqrt{\\left(\\frac{2\\pi}{a}\\right)^2 \\cdot 3} = \\frac{2\\pi}{a}\\sqrt{3}$$\nThe final answer required is the dimensionless number $|\\mathbf{k}_{\\min}|/(2\\pi/a)$:\n$$\\frac{|\\mathbf{k}_{\\min}|}{2\\pi/a} = \\frac{\\frac{2\\pi}{a}\\sqrt{3}}{\\frac{2\\pi}{a}} = \\sqrt{3}$$",
            "answer": "$$\\boxed{\\sqrt{3}}$$"
        },
        {
            "introduction": "While the reciprocal Ewald sum is well-defined for all wavevectors $k \\neq 0$, the $k=0$ term presents a subtle but critical choice that defines the electrostatic potential's absolute reference. This exercise delves into this ambiguity, first through a theoretical derivation and then with a hands-on coding task to solve the Poisson equation for a model water slab . You will directly observe how different treatments of the $k=0$ mode correspond to different physical boundary conditions and shift important observables like the surface potential.",
            "id": "3422400",
            "problem": "Consider a one-dimensional, planar-averaged electrostatic problem representative of a molecular dynamics water slab under Periodic Boundary Conditions (PBC). Let the unit cell of length $L$ along the $z$-axis contain a charge density profile $\\rho(z)$ that is periodic with period $L$, neutral over one period, and localized such that there exist subregions interpretable as \"bulk water\" and \"vacuum gap\". The electrostatic potential $\\phi(z)$ is defined by the Poisson equation\n$$\n\\frac{d^2 \\phi(z)}{dz^2} = -\\frac{\\rho(z)}{\\varepsilon_0},\n$$\nwhere $\\varepsilon_0$ is the vacuum permittivity in the International System of Units (SI). Under PBC, one may represent $\\phi(z)$ and $\\rho(z)$ by their Fourier series. In Ewald summation, the reciprocal-space solution for $\\phi(z)$ involves all wavevectors except the zero-wavevector term $k=0$. The treatment of the $k=0$ term sets the reference of the potential and is physically linked to the macroscopic boundary condition (e.g., conducting \"tin-foil\" boundary versus vacuum boundary).\n\nYour task is to derive, from first principles, the relation between the choice of $k=0$ treatment and the spatial average of the potential $\\langle \\phi \\rangle$, and to demonstrate numerically how this choice shifts the reported \"surface potential of water\", defined here as the bulk-water potential reported relative to a chosen reference. Specifically:\n\n1. Starting from the Fourier representation of the Poisson equation under PBC, show that the Fourier component at $k=0$ corresponds to a constant offset in $\\phi(z)$, and that setting the $k=0$ component to zero enforces $\\langle \\phi \\rangle = 0$. This choice corresponds to the standard \"tin-foil\" convention in Ewald summation.\n\n2. Show that any other choice of the $k=0$ component adds a constant $c$ to $\\phi(z)$, so that $\\langle \\phi \\rangle = c$, and the reported bulk-water potential relative to the chosen reference is shifted by $c$. In a vacuum-referenced convention for a slab with a vacuum gap, one sets $\\phi(z_\\text{vac}) = 0$ in a vacuum subregion $z \\in \\mathcal{V}$ by choosing $c = -\\phi_\\text{tin}(z_\\text{vac})$, where $\\phi_\\text{tin}(z)$ is the potential computed with $k=0$ set to zero.\n\n3. Implement a numerical solver for the one-dimensional periodic Poisson equation using a Fast Fourier Transform (FFT) to compute $\\phi(z)$ from $\\rho(z)$ with the $k=0$ mode excluded (tin-foil). Then form the vacuum-referenced potential by adding a constant chosen to set the mean potential over a designated vacuum window to zero. Your solver must compute the reported bulk-water potential under both references and output the shift between them, which equals the reference constant $c$.\n\nUse the following physically plausible test suite of charge densities, all neutral over the unit cell:\n\n- Test case 1 (balanced double layer, near-symmetric): $L = 5.0 \\times 10^{-9}\\ \\text{m}$, $N = 2048$ grid points, $\\sigma = 0.2 \\times 10^{-9}\\ \\text{m}$, amplitude $A = 1.0 \\times 10^{6}\\ \\text{C/m}^3$, and\n$$\n\\rho(z) = A \\left[ \\exp\\left(-\\frac{(z - z_1)^2}{2\\sigma^2}\\right) - \\exp\\left(-\\frac{(z - z_2)^2}{2\\sigma^2}\\right) \\right],\n$$\nwith $z_1 = 2.0 \\times 10^{-9}\\ \\text{m}$ and $z_2 = 3.0 \\times 10^{-9}\\ \\text{m}$. Define the vacuum window $\\mathcal{V}$ as $z \\in [0.0, 0.5] \\times 10^{-9}\\ \\text{m}$ and the bulk-water window $\\mathcal{B}$ as $z \\in [2.4, 2.6] \\times 10^{-9}\\ \\text{m}$.\n\n- Test case 2 (asymmetric dipole-like slab): Same $L$, $N$, and $\\sigma$, amplitude $A = 1.5 \\times 10^{6}\\ \\text{C/m}^3$, with $z_1 = 1.8 \\times 10^{-9}\\ \\text{m}$ and $z_2 = 3.2 \\times 10^{-9}\\ \\text{m}$. Use $\\mathcal{V}$ as $z \\in [0.0, 0.5] \\times 10^{-9}\\ \\text{m}$ and $\\mathcal{B}$ as $z \\in [2.45, 2.55] \\times 10^{-9}\\ \\text{m}$.\n\n- Test case 3 (no charges, edge case): Same $L$, $N$, and $\\sigma$, amplitude $A = 0\\ \\text{C/m}^3$, with any $z_1$ and $z_2$ (irrelevant). Use the same $\\mathcal{V}$ and $\\mathcal{B}$ windows as in test case 1.\n\nAlgorithmic requirements:\n\n- Compute the discrete Fourier transform of $\\rho(z)$ over the unit cell using the Fast Fourier Transform (FFT), and solve for $\\phi(k)$ in Fourier space via\n$$\n\\phi(k) = \\frac{\\rho(k)}{\\varepsilon_0 k^2},\\quad k \\neq 0,\n$$\nwith $\\phi(k=0) = 0$ for the tin-foil treatment. Then obtain $\\phi(z)$ via inverse FFT. Use $\\varepsilon_0 = 8.854187817 \\times 10^{-12}\\ \\text{F/m}$.\n\n- Construct the vacuum-referenced potential by adding a constant $c$ such that the mean potential over the vacuum window $\\mathcal{V}$ equals zero. The reported bulk-water potential under tin-foil is the mean over $\\mathcal{B}$ of $\\phi_\\text{tin}(z)$, and under vacuum reference it is the mean over $\\mathcal{B}$ of $\\phi_\\text{tin}(z) + c$.\n\n- Your program must compute, for each test case, a single float equal to the difference between the reported bulk-water potential under vacuum reference and under tin-foil reference. This difference equals the constant $c$ and is the shift induced by the $k=0$ treatment.\n\nOutput specification:\n\n- Express all potentials in volts (V), and output the three shifts as floats rounded to six decimal places.\n\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,result3]\").\n\nScientific realism and derivation constraints:\n\n- Begin the derivation from the Poisson equation and the definition of Fourier series under PBC.\n\n- Do not provide shortcut formulas for the answer; the derivation should logically connect the $k=0$ treatment to the spatial average $\\langle \\phi \\rangle$ and to the reported surface potential shift.\n\n- Ensure all entities in the derivation are well-defined within the above physics and mathematics.\n\nYour final submitted answer must be a complete, runnable Python program that implements the solver and produces the specified output format without requiring any user input.",
            "solution": "The problem asks for a derivation of the relationship between the treatment of the $k=0$ Fourier mode in a one-dimensional periodic Poisson problem and the resulting electrostatic potential's spatial average. Further, it requires a numerical implementation to calculate the potential shift for a water slab model under different reference conventions.\n\n**Derivation from First Principles**\n\nWe begin with the one-dimensional Poisson equation for the electrostatic potential $\\phi(z)$ generated by a charge density $\\rho(z)$ in a system with periodic boundary conditions over a domain of length $L$:\n$$\n\\frac{d^2 \\phi(z)}{dz^2} = -\\frac{\\rho(z)}{\\varepsilon_0}\n$$\nwhere $\\varepsilon_0$ is the vacuum permittivity. Since $\\phi(z)$ and $\\rho(z)$ are periodic with period $L$, they can be expressed as Fourier series:\n$$\n\\phi(z) = \\sum_{n=-\\infty}^{\\infty} \\phi_n e^{i k_n z} \\quad \\text{and} \\quad \\rho(z) = \\sum_{n=-\\infty}^{\\infty} \\rho_n e^{i k_n z}\n$$\nThe wavevectors are given by $k_n = \\frac{2\\pi n}{L}$ for integer $n$. The Fourier coefficients, $\\phi_n$ and $\\rho_n$, are defined as:\n$$\n\\phi_n = \\frac{1}{L} \\int_0^L \\phi(z) e^{-i k_n z} dz \\quad \\text{and} \\quad \\rho_n = \\frac{1}{L} \\int_0^L \\rho(z) e^{-i k_n z} dz\n$$\nTo transform the Poisson equation into Fourier space, we find the series representation for the second derivative of $\\phi(z)$:\n$$\n\\frac{d^2 \\phi(z)}{dz^2} = \\frac{d^2}{dz^2} \\left( \\sum_{n=-\\infty}^{\\infty} \\phi_n e^{i k_n z} \\right) = \\sum_{n=-\\infty}^{\\infty} (i k_n)^2 \\phi_n e^{i k_n z} = \\sum_{n=-\\infty}^{\\infty} -k_n^2 \\phi_n e^{i k_n z}\n$$\nSubstituting the series for $\\phi(z)$ and $\\rho(z)$ into the Poisson equation, we obtain:\n$$\n\\sum_{n=-\\infty}^{\\infty} -k_n^2 \\phi_n e^{i k_n z} = -\\frac{1}{\\varepsilon_0} \\sum_{n=-\\infty}^{\\infty} \\rho_n e^{i k_n z}\n$$\nBy the uniqueness of Fourier coefficients, we can equate the terms for each value of $n$:\n$$\n-k_n^2 \\phi_n = -\\frac{\\rho_n}{\\varepsilon_0}\n$$\nFor all non-zero wavevectors, i.e., $k_n \\neq 0$ ($n \\neq 0$), we can solve for the potential coefficients $\\phi_n$:\n$$\n\\phi_n = \\frac{\\rho_n}{\\varepsilon_0 k_n^2} \\quad (n \\neq 0)\n$$\n\n**The Role of the $k=0$ Mode**\n\nNow, we must consider the special case of the $k=0$ mode (i.e., $n=0$). For $n=0$, the wavevector is $k_0 = 0$. The equation becomes:\n$$\n-0^2 \\cdot \\phi_0 = -\\frac{\\rho_0}{\\varepsilon_0} \\implies 0 = \\rho_0\n$$\nThis implies that the Poisson equation is only consistent if the $n=0$ Fourier component of the charge density, $\\rho_0$, is zero. The $\\rho_0$ coefficient represents the average charge density over the unit cell:\n$$\n\\rho_0 = \\frac{1}{L} \\int_0^L \\rho(z) e^{-i (0) z} dz = \\frac{1}{L} \\int_0^L \\rho(z) dz = \\langle \\rho \\rangle\n$$\nThe problem states that the system is charge neutral, $\\int_0^L \\rho(z) dz = 0$, which ensures consistency by making $\\rho_0 = 0$. However, while consistent, the equation $0=0$ provides no information to determine the value of $\\phi_0$.\n\nThe $n=0$ coefficient of the potential, $\\phi_0$, is its spatial average over the unit cell:\n$$\n\\phi_0 = \\frac{1}{L} \\int_0^L \\phi(z) e^{-i (0) z} dz = \\frac{1}{L} \\int_0^L \\phi(z) dz = \\langle \\phi \\rangle\n$$\nThe ambiguity in $\\phi_0$ reflects the fact that the electrostatic potential is only defined up to an arbitrary constant. The choice of $\\phi_0$ sets this constant, thereby fixing the potential reference.\n\n**1. The \"Tin-Foil\" Convention and $\\langle \\phi \\rangle = 0$**\n\nThe standard Ewald summation convention for periodic systems, often called the \"tin-foil\" boundary condition, resolves this ambiguity by setting the $k=0$ component of the potential to zero:\n$$\n\\phi_0 = 0\n$$\nSince $\\phi_0 = \\langle \\phi \\rangle$, this choice is equivalent to enforcing that the average potential over the entire periodic cell is zero:\n$$\n\\langle \\phi \\rangle = 0\n$$\nThis choice defines a unique potential profile, which we denote as $\\phi_\\text{tin}(z)$. This completes the first part of the required demonstration.\n\n**2. General Potential Reference and the Shift Constant**\n\nAny other choice for the potential reference corresponds to choosing a non-zero value for $\\phi_0$. Let us set $\\phi_0 = c$, where $c$ is a constant. The potential $\\phi(z)$ can be written by separating the $n=0$ term from its Fourier series:\n$$\n\\phi(z) = \\phi_0 e^{i(0)z} + \\sum_{n \\neq 0} \\phi_n e^{i k_n z} = c + \\sum_{n \\neq 0} \\frac{\\rho_n}{\\varepsilon_0 k_n^2} e^{i k_n z}\n$$\nThe summation on the right-hand side is precisely the definition of the potential under the tin-foil convention, $\\phi_\\text{tin}(z)$ (for which $\\phi_0=0$). Thus, any general solution is related to the tin-foil solution by a constant shift:\n$$\n\\phi(z) = \\phi_\\text{tin}(z) + c\n$$\nThe spatial average of this potential is $\\langle \\phi \\rangle = \\langle \\phi_\\text{tin}(z) + c \\rangle = \\langle \\phi_\\text{tin}(z) \\rangle + \\langle c \\rangle = 0 + c = c$.\n\nFor slab simulations with a vacuum region, a physically intuitive reference is to set the potential in the vacuum region to zero. This is the \"vacuum-referenced\" convention. To achieve this, we choose the constant $c$ such that the average potential over a designated vacuum window $\\mathcal{V}$ is zero. Let $\\phi_\\text{vac}(z)$ be this potential.\n$$\n\\langle \\phi_\\text{vac}(z) \\rangle_{\\mathcal{V}} = 0\n$$\nUsing the relation $\\phi_\\text{vac}(z) = \\phi_\\text{tin}(z) + c$, we find:\n$$\n\\langle \\phi_\\text{tin}(z) + c \\rangle_{\\mathcal{V}} = \\langle \\phi_\\text{tin}(z) \\rangle_{\\mathcal{V}} + c = 0\n$$\nThis uniquely determines the shift constant $c$:\n$$\nc = - \\langle \\phi_\\text{tin}(z) \\rangle_{\\mathcal{V}}\n$$\nThe \"surface potential\" is the bulk-water potential reported relative to the chosen reference. The shift in this reported value when moving from the tin-foil to the vacuum reference is:\n$$\n\\text{Shift} = \\langle \\phi_\\text{vac} \\rangle_{\\mathcal{B}} - \\langle \\phi_\\text{tin} \\rangle_{\\mathcal{B}} = \\langle \\phi_\\text{tin} + c \\rangle_{\\mathcal{B}} - \\langle \\phi_\\text{tin} \\rangle_{\\mathcal{B}} = (\\langle \\phi_\\text{tin} \\rangle_{\\mathcal{B}} + c) - \\langle \\phi_\\text{tin} \\rangle_{\\mathcal{B}} = c\n$$\nThe shift is therefore equal to the determined constant $c$. This completes the second part of the demonstration.\n\n**3. Numerical Implementation via Fast Fourier Transform (FFT)**\n\nThe numerical solution uses the FFT to implement the derived Fourier-space solution. The steps for the algorithm are:\n1. Discretize the domain $[0, L)$ into $N$ points $z_j$.\n2. Compute the charge density $\\rho(z_j)$ on this grid.\n3. Compute the Discrete Fourier Transform (DFT) of the charge density, $R_n = \\mathcal{F}[\\rho(z_j)]$, using an FFT algorithm.\n4. Determine the discrete wavevectors $k_n$ corresponding to the DFT frequencies.\n5. In Fourier space, compute the DFT of the potential, $\\Phi_n = \\mathcal{F}[\\phi(z_j)]$. As derived from the correspondence between DFT and continuous Fourier series coefficients, the relation is $\\Phi_n = R_n / (\\varepsilon_0 k_n^2)$.\n6. Apply the tin-foil condition by setting the $k=0$ component to zero, $\\Phi_0 = 0$. For all other components where $k_n \\neq 0$, compute $\\Phi_n = R_n / (\\varepsilon_0 k_n^2)$.\n7. Obtain the real-space tin-foil potential $\\phi_\\text{tin}(z_j)$ by applying the inverse FFT: $\\phi_\\text{tin}(z_j) = \\mathcal{F}^{-1}[\\Phi_n]$. Discard any minor imaginary components arising from numerical noise.\n8. Identify grid points within the vacuum window $\\mathcal{V}$ and compute the average potential $\\langle \\phi_\\text{tin} \\rangle_{\\mathcal{V}}$.\n9. The required potential shift is $c = - \\langle \\phi_\\text{tin} \\rangle_{\\mathcal{V}}$. This value is computed for each test case.\nFor the test case where $\\rho(z)=0$, we expect $\\phi_\\text{tin}(z)=0$, resulting in a shift of $c=0$.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test cases.\n    It computes the potential shift between 'tin-foil' and 'vacuum'\n    references for a 1D periodic charge distribution.\n    \"\"\"\n    \n    # Use the exact value for vacuum permittivity as specified in the problem.\n    epsilon_0 = 8.854187817e-12  # F/m\n\n    test_cases = [\n        {\n            \"L\": 5.0e-9, \"N\": 2048, \"sigma\": 0.2e-9, \"A\": 1.0e6,\n            \"z1\": 2.0e-9, \"z2\": 3.0e-9,\n            \"vac_win\": (0.0e-9, 0.5e-9),\n        },\n        {\n            \"L\": 5.0e-9, \"N\": 2048, \"sigma\": 0.2e-9, \"A\": 1.5e6,\n            \"z1\": 1.8e-9, \"z2\": 3.2e-9,\n            \"vac_win\": (0.0e-9, 0.5e-9),\n        },\n        {\n            \"L\": 5.0e-9, \"N\": 2048, \"sigma\": 0.2e-9, \"A\": 0.0,\n            \"z1\": 2.0e-9, \"z2\": 3.0e-9,\n            \"vac_win\": (0.0e-9, 0.5e-9),\n        }\n    ]\n\n    results = []\n    for params in test_cases:\n        shift = calculate_potential_shift(params, epsilon_0)\n        results.append(f\"{shift:.6f}\")\n\n    print(f\"[{','.join(results)}]\")\n\ndef calculate_potential_shift(params, epsilon_0):\n    \"\"\"\n    Calculates the potential shift for a single test case.\n\n    Args:\n        params (dict): A dictionary containing the parameters for the test case.\n        epsilon_0 (float): The vacuum permittivity.\n\n    Returns:\n        float: The calculated potential shift 'c'.\n    \"\"\"\n    L = params[\"L\"]\n    N = params[\"N\"]\n    sigma = params[\"sigma\"]\n    A = params[\"A\"]\n    z1 = params[\"z1\"]\n    z2 = params[\"z2\"]\n    vac_win = params[\"vac_win\"]\n\n    # 1. Define the spatial grid and charge density profile\n    z_grid = np.linspace(0, L, N, endpoint=False)\n    rho_z = A * (np.exp(-(z_grid - z1)**2 / (2 * sigma**2)) - \n                   np.exp(-(z_grid - z2)**2 / (2 * sigma**2)))\n\n    # 2. Solve for the 'tin-foil' potential using an FFT-based Poisson solver\n    phi_tin_z = solve_poisson_1d_pbc(rho_z, L, epsilon_0)\n\n    # 3. Identify indices for the vacuum window\n    vac_indices = np.where((z_grid >= vac_win[0])  (z_grid  vac_win[1]))\n\n    if vac_indices[0].size == 0:\n        # This case should not occur with the problem's parameters\n        return np.nan\n\n    # 4. Calculate the average tin-foil potential in the vacuum window\n    mean_phi_in_vac = np.mean(phi_tin_z[vac_indices])\n\n    # 5. The shift 'c' is the negative of this average\n    c = -mean_phi_in_vac\n\n    return c\n\ndef solve_poisson_1d_pbc(rho_z, L, epsilon_0):\n    \"\"\"\n    Solves the 1D periodic Poisson equation d^2(phi)/dz^2 = -rho/epsilon_0\n    using FFTs, under the 'tin-foil' convention (k=0 mode of potential is zero).\n\n    Args:\n        rho_z (np.ndarray): The charge density on a uniform grid.\n        L (float): The length of the periodic cell.\n        epsilon_0 (float): The vacuum permittivity.\n\n    Returns:\n        np.ndarray: The electrostatic potential phi(z) on the grid.\n    \"\"\"\n    N = len(rho_z)\n    dz = L / N\n\n    # DFT of the charge density\n    rho_k = np.fft.fft(rho_z)\n    \n    # Wavevectors corresponding to the DFT frequencies\n    k = np.fft.fftfreq(N, d=dz) * 2 * np.pi\n    \n    # The DFT of the potential, phi_k, will be stored here.\n    # Initialize with zeros. The k=0 component remains zero ('tin-foil' convention).\n    phi_k = np.zeros_like(rho_k)\n    \n    # Find indices of non-zero wavevectors to avoid division by zero\n    nonzero_k_indices = np.where(k != 0)\n    \n    # Solve for phi_k for all k != 0\n    k_squared = k[nonzero_k_indices]**2\n    phi_k[nonzero_k_indices] = rho_k[nonzero_k_indices] / (epsilon_0 * k_squared)\n    \n    # Inverse DFT to get the potential in real space\n    phi_z = np.fft.ifft(phi_k)\n    \n    # The potential must be real; discard small imaginary parts from numerical error.\n    return phi_z.real\n\nif __name__ == \"__main__\":\n    solve()\n\n```"
        },
        {
            "introduction": "An accurate energy expression is the starting point for deriving all forces and related thermodynamic properties, such as pressure. This practice focuses on a specific shape-dependent energy term that arises in Ewald summation under vacuum boundary conditions and is proportional to the total dipole moment of the simulation cell . By applying the thermodynamic definition of pressure, you will derive the analytical correction to the system's virial, a crucial step for accurate constant-pressure simulations of polar systems.",
            "id": "3422423",
            "problem": "A system of $N$ point charges $\\{q_i\\}_{i=1}^{N}$ in a cubic simulation cell of volume $V$ is simulated using Ewald summation under vacuum boundary conditions, which correspond to embedding the periodically replicated system in a medium of dielectric constant $\\epsilon=1$. It is well established that, for this boundary condition, the shape-dependent surface term contributes an energy shift that depends on the total dipole moment $\\mathbf{M}=\\sum_{i=1}^{N} q_i \\mathbf{r}_i$. In reduced electrostatic units where the Coulomb prefactor is unity, a widely used and experimentally consistent result is that this surface term takes the form of an energy contribution proportional to $|\\mathbf{M}|^{2}$ divided by $V$.\n\nStarting from the thermodynamic definition of isotropic pressure as the negative derivative of the potential energy with respect to volume at fixed fractional coordinates and fixed particle identities, and assuming that during a homogeneous isotropic dilation the particle positions scale affinely so that $\\mathbf{r}_i \\mapsto \\lambda \\mathbf{r}_i$ with $\\lambda \\propto V^{1/3}$, derive the closed-form analytic expression for the pressure correction $\\Delta P$ associated solely with the vacuum surface term mentioned above, expressed in terms of the instantaneous dipole magnitude $M=|\\mathbf{M}|$ and the cell volume $V$.\n\nUse the following as a well-tested input that you may treat as given: in vacuum boundary conditions, the surface-term energy shift has the form $$ \\Delta E = \\frac{2\\pi}{3V} M^{2} $$. Show explicitly how the scaling of $M$ with $V$ under isotropic dilation affects the derivative with respect to $V$, and provide your final result for $\\Delta P$ in reduced electrostatic units. Your final answer must be a single closed-form analytic expression in terms of $M$ and $V$. Do not include units in your final boxed answer.",
            "solution": "The problem as stated is scientifically sound, well-posed, and complete. It describes a standard scenario in molecular simulation involving the calculation of a pressure correction arising from long-range electrostatic interactions under vacuum boundary conditions. The provided energy term and the thermodynamic definition of pressure are correct and sufficient for a rigorous derivation. We may therefore proceed with the solution.\n\nThe pressure correction, $\\Delta P$, associated with a potential energy term, $\\Delta E$, is defined by the thermodynamic relation for isotropic pressure. The pressure is the negative partial derivative of the energy with respect to volume, holding the number of particles and their fractional coordinates constant.\n$$\n\\Delta P = -\\frac{d(\\Delta E)}{dV}\n$$\nThe problem specifies the energy correction term due to the surface effects in vacuum-boundary Ewald summation as:\n$$\n\\Delta E = \\frac{2\\pi}{3V} M^{2}\n$$\nwhere $M=|\\mathbf{M}|$ is the magnitude of the total dipole moment of the simulation cell, $\\mathbf{M} = \\sum_{i=1}^{N} q_i \\mathbf{r}_i$, and $V$ is the cell volume.\n\nCrucially, under a homogeneous isotropic dilation, the particle positions $\\mathbf{r}_i$ are not constant. The problem states they scale affinely with a factor $\\lambda$ proportional to $V^{1/3}$. We can express this scaling relationship as $\\mathbf{r}_i \\propto V^{1/3}$. This implies that the total dipole moment vector $\\mathbf{M}$ also scales with volume:\n$$\n\\mathbf{M} = \\sum_{i=1}^{N} q_i \\mathbf{r}_i \\propto V^{1/3}\n$$\nThe magnitude of the dipole moment, $M = |\\mathbf{M}|$, must therefore exhibit the same scaling behavior:\n$$\nM \\propto V^{1/3}\n$$\nThis can be written as an equation $M(V) = C V^{1/3}$, where $C$ is a constant that depends on the charges $q_i$ and the fixed fractional coordinates of the particles, but not on the volume $V$.\n\nTo calculate the pressure, we must differentiate $\\Delta E$ with respect to $V$. Since $\\Delta E$ is a function of both $V$ explicitly and $M(V)$ implicitly, we must use the product rule and chain rule for differentiation.\n$$\n\\Delta P = -\\frac{d}{dV} \\left( \\frac{2\\pi}{3} V^{-1} M(V)^{2} \\right)\n$$\nApplying the product rule $(fg)' = f'g + fg'$ with $f(V) = V^{-1}$ and $g(V) = M(V)^2$:\n$$\n\\Delta P = -\\frac{2\\pi}{3} \\left[ \\left(\\frac{d(V^{-1})}{dV}\\right) M^{2} + V^{-1} \\left(\\frac{d(M^{2})}{dV}\\right) \\right]\n$$\nThe derivatives are:\n$$\n\\frac{d(V^{-1})}{dV} = -V^{-2}\n$$\nAnd using the chain rule for $\\frac{d(M^2)}{dV}$:\n$$\n\\frac{d(M^{2})}{dV} = 2M \\frac{dM}{dV}\n$$\nSubstituting these into the expression for $\\Delta P$:\n$$\n\\Delta P = -\\frac{2\\pi}{3} \\left[ -V^{-2} M^{2} + V^{-1} \\left(2M \\frac{dM}{dV}\\right) \\right]\n$$\n$$\n\\Delta P = \\frac{2\\pi M^{2}}{3V^{2}} - \\frac{4\\pi M}{3V} \\frac{dM}{dV}\n$$\nTo proceed, we must evaluate the derivative $\\frac{dM}{dV}$. Using the scaling relationship $M(V) = C V^{1/3}$:\n$$\n\\frac{dM}{dV} = \\frac{d}{dV}(C V^{1/3}) = C \\left(\\frac{1}{3} V^{-2/3}\\right)\n$$\nWe can express the constant $C$ in terms of the instantaneous values of $M$ and $V$. From $M = C V^{1/3}$, we have $C = M V^{-1/3}$. Substituting this back into the derivative:\n$$\n\\frac{dM}{dV} = (M V^{-1/3}) \\left(\\frac{1}{3} V^{-2/3}\\right) = \\frac{M}{3} V^{-1/3 - 2/3} = \\frac{M}{3} V^{-1} = \\frac{M}{3V}\n$$\nNow, substitute this expression for $\\frac{dM}{dV}$ into our equation for $\\Delta P$:\n$$\n\\Delta P = \\frac{2\\pi M^{2}}{3V^{2}} - \\frac{4\\pi M}{3V} \\left(\\frac{M}{3V}\\right)\n$$\n$$\n\\Delta P = \\frac{2\\pi M^{2}}{3V^{2}} - \\frac{4\\pi M^{2}}{9V^{2}}\n$$\nTo combine these terms, we find a common denominator:\n$$\n\\Delta P = \\left(\\frac{3}{3}\\right) \\frac{2\\pi M^{2}}{3V^{2}} - \\frac{4\\pi M^{2}}{9V^{2}} = \\frac{6\\pi M^{2}}{9V^{2}} - \\frac{4\\pi M^{2}}{9V^{2}}\n$$\n$$\n\\Delta P = \\frac{(6-4)\\pi M^{2}}{9V^{2}} = \\frac{2\\pi M^{2}}{9V^{2}}\n$$\n\nAlternatively, we can first substitute the scaling of $M$ into the energy expression.\n$$\n\\Delta E(V) = \\frac{2\\pi}{3V} (C V^{1/3})^{2} = \\frac{2\\pi}{3V} C^{2} V^{2/3} = \\frac{2\\pi C^{2}}{3} V^{-1/3}\n$$\nNow, we differentiate this simplified expression for $\\Delta E$ with respect to $V$:\n$$\n\\frac{d(\\Delta E)}{dV} = \\frac{2\\pi C^{2}}{3} \\frac{d}{dV}(V^{-1/3}) = \\frac{2\\pi C^{2}}{3} \\left(-\\frac{1}{3} V^{-4/3}\\right) = -\\frac{2\\pi C^{2}}{9} V^{-4/3}\n$$\nThe pressure correction is $\\Delta P = - \\frac{d(\\Delta E)}{dV}$:\n$$\n\\Delta P = - \\left(-\\frac{2\\pi C^{2}}{9} V^{-4/3}\\right) = \\frac{2\\pi C^{2}}{9} V^{-4/3}\n$$\nFinally, we substitute back $C^{2} = (M V^{-1/3})^{2} = M^{2} V^{-2/3}$:\n$$\n\\Delta P = \\frac{2\\pi}{9} (M^{2} V^{-2/3}) V^{-4/3} = \\frac{2\\pi M^{2}}{9} V^{-2/3 - 4/3} = \\frac{2\\pi M^{2}}{9} V^{-6/3} = \\frac{2\\pi M^{2}}{9V^{2}}\n$$\nBoth methods yield the same, consistent result. The pressure correction is directly proportional to the square of the dipole moment magnitude and inversely proportional to the square of the volume.",
            "answer": "$$\n\\boxed{\\frac{2\\pi M^{2}}{9 V^{2}}}\n$$"
        }
    ]
}