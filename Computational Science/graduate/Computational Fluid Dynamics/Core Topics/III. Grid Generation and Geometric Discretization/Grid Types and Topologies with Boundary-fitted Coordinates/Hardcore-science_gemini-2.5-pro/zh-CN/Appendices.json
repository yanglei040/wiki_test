{
    "hands_on_practices": [
        {
            "introduction": "准确预测物体表面的力，例如阻力和升力，是许多计算流体动力学（CFD）模拟的主要目标。这些力直接关联于壁面切应力，而壁面切应力的计算依赖于壁面附近的速度梯度。这第一个练习 () 提供了一个具体的、解析性的视角，来审视边界处的网格非正交性如何直接影响这一关键物理量的计算精度，帮助你从第一性原理层面理解为何高质量的近壁面网格至关重要。",
            "id": "3327938",
            "problem": "考虑一个近壁区域的二维不可压缩牛顿流体，该区域使用贴体坐标在混合网格上进行离散化，该网格在壁面平行方向上是结构化的，在壁面法向方向上是非结构化的。在计算流体力学（CFD）中，一致的壁面法向扩散通量评估对于精确的粘性应力计算至关重要。在一个完全边界正交的网格中，计算坐标线与壁面的物理切向和法向重合。在非正交网格中，近壁控制体的面法向方向可能与真实的物理法向方向不一致，这会给壁面法向通量引入交叉扩散贡献。\n\n从动力粘度为 $\\mu$ 的流体的牛顿粘性应力定律，即 $\\boldsymbol{\\tau}=\\mu\\left(\\nabla \\boldsymbol{u}+(\\nabla \\boldsymbol{u})^{\\top}\\right)$，以及方向导数作为 $\\nabla(\\cdot)$ 在单位方向上投影的几何定义出发，推导当切向速度的壁面法向导数被一个与真实物理法向偏离角度为 $\\theta$ 的计算面法向的导数近似时，壁面剪切应力误差的主阶表达式。假设在壁面上存在一个由切向 $\\boldsymbol{t}$ 和法向 $\\boldsymbol{n}$ 定义的局部标准正交标架，并设计算面法向单位向量 $\\boldsymbol{\\hat{n}}$ 是通过在壁面平面内将 $\\boldsymbol{n}$ 朝 $\\boldsymbol{t}$ 方向旋转角度 $\\theta$ 得到的。在物理上标准的无滑移边界条件和近壁速度场光滑性的假设下进行推导。\n\n然后，对于一个具体案例，动力粘度 $\\mu=1.8\\times 10^{-5}\\ \\text{kg}\\ \\text{m}^{-1}\\ \\text{s}^{-1}$，切向速度的真实壁面法向梯度 $\\partial u_{t}/\\partial n = 500\\ \\text{s}^{-1}$，切向导数 $\\partial u_{t}/\\partial s = 4000\\ \\text{s}^{-1}$，以及偏离角 $\\theta=5^{\\circ}$，计算用计算面法向导数代替真实壁面法向导数所引起的壁面剪切应力的绝对误差。所有三角函数均使用弧度制，并将最终数值答案四舍五入至四位有效数字。最终答案以帕斯卡（Pa）为单位表示。",
            "solution": "问题要求两个结果：首先，推导由于网格非正交性引起的壁面剪切应力误差的主阶表达式；其次，计算一个具体案例中该误差的绝对值。\n\n### 第一部分：误差表达式的推导\n\n动力粘度为 $\\mu$ 的不可压缩牛顿流体的粘性应力张量 $\\boldsymbol{\\tau}$ 由下式给出：\n$$ \\boldsymbol{\\tau} = \\mu \\left( \\nabla \\boldsymbol{u} + (\\nabla \\boldsymbol{u})^{\\top} \\right) $$\n其中 $\\boldsymbol{u}$ 是速度矢量。\n\n壁面剪切应力 $\\tau_w$ 是流体施加在壁面上的单位面积粘性力的切向分量。这是在壁面上求值的面力矢量 $\\boldsymbol{\\tau} \\cdot \\boldsymbol{n}$ 的切向分量，其中 $\\boldsymbol{n}$ 是指向流体内部的壁面单位法向量。\n$$ \\tau_w = (\\boldsymbol{\\tau} \\cdot \\boldsymbol{n}) \\cdot \\boldsymbol{t} \\big|_{\\text{wall}} $$\n其中 $\\boldsymbol{t}$ 是壁面的单位切向量。\n\n我们建立一个局部二维笛卡尔坐标系，其中壁面为直线 $y=0$。切向对应于 $x$ 轴 ($\\boldsymbol{t}$)，法向对应于 $y$ 轴 ($\\boldsymbol{n}$)。速度矢量为 $\\boldsymbol{u} = u_t \\boldsymbol{t} + u_n \\boldsymbol{n}$。坐标为沿 $\\boldsymbol{t}$ 的 $s$ 和沿 $\\boldsymbol{n}$ 的 $n$。因此，$\\partial/\\partial s$ 是沿 $\\boldsymbol{t}$ 的导数，$\\partial/\\partial n$ 是沿 $\\boldsymbol{n}$ 的导数。\n\n在此标架中，速度梯度张量为：\n$$ \\nabla \\boldsymbol{u} = \\begin{pmatrix} \\frac{\\partial u_t}{\\partial s} & \\frac{\\partial u_t}{\\partial n} \\\\ \\frac{\\partial u_n}{\\partial s} & \\frac{\\partial u_n}{\\partial n} \\end{pmatrix} $$\n应力张量分量为：\n$$ \\boldsymbol{\\tau} = \\mu \\begin{pmatrix} 2\\frac{\\partial u_t}{\\partial s} & \\frac{\\partial u_t}{\\partial n} + \\frac{\\partial u_n}{\\partial s} \\\\ \\frac{\\partial u_t}{\\partial n} + \\frac{\\partial u_n}{\\partial s} & 2\\frac{\\partial u_n}{\\partial n} \\end{pmatrix} $$\n壁面上的面力矢量为 $\\boldsymbol{\\tau} \\cdot \\boldsymbol{n}$，得出：\n$$ \\boldsymbol{\\tau} \\cdot \\boldsymbol{n} = \\mu \\begin{pmatrix} \\frac{\\partial u_t}{\\partial n} + \\frac{\\partial u_n}{\\partial s} \\\\ 2\\frac{\\partial u_n}{\\partial n} \\end{pmatrix} $$\n真实的壁面剪切应力 $\\tau_{w, \\text{true}}$ 是该矢量的切向分量：\n$$ \\tau_{w, \\text{true}} = \\mu \\left( \\frac{\\partial u_t}{\\partial n} + \\frac{\\partial u_n}{\\partial s} \\right) \\bigg|_{\\text{wall}} $$\n无滑移边界条件指出，壁面上所有点的速度 $\\boldsymbol{u} = \\boldsymbol{0}$。这意味着速度分量沿壁面的梯度为零，即在壁面上 $\\frac{\\partial u_t}{\\partial s} = 0$ 和 $\\frac{\\partial u_n}{\\partial s} = 0$。不可压缩条件 $\\nabla \\cdot \\boldsymbol{u} = \\frac{\\partial u_t}{\\partial s} + \\frac{\\partial u_n}{\\partial n} = 0$，结合在壁面上 $\\frac{\\partial u_t}{\\partial s}=0$，意味着在壁面上 $\\frac{\\partial u_n}{\\partial n}=0$。\n应用这些条件，真实壁面剪切应力的表达式简化为：\n$$ \\tau_{w, \\text{true}} = \\mu \\frac{\\partial u_t}{\\partial n} \\bigg|_{\\text{wall}} $$\n这是物理上精确的壁面剪切应力。注意，虽然 $\\frac{\\partial u_t}{\\partial s}|_{\\text{wall}}$ 为零，但问题给出了一个非零值。这意味着导数并非精确地在壁面*上*求值，而是在离壁面非常近的距离处求值，CFD 近似计算在此处进行。我们将遵循 CFD 中的这种标准解释，即梯度在近壁的单元中心或面上求值。\n\n问题指出，壁面法向导数是使用沿一个偏离的计算面法向单位向量 $\\boldsymbol{\\hat{n}}$ 的导数来近似的。近似的壁面剪切应力 $\\tau_{w, \\text{approx}}$ 为：\n$$ \\tau_{w, \\text{approx}} = \\mu \\frac{D u_t}{D \\hat{n}} $$\n其中 $\\frac{D u_t}{D \\hat{n}}$ 是 $u_t$ 在 $\\boldsymbol{\\hat{n}}$ 方向上的方向导数。这被定义为 $\\nabla u_t \\cdot \\boldsymbol{\\hat{n}}$。\n标量场 $u_t$ 的梯度为：\n$$ \\nabla u_t = \\frac{\\partial u_t}{\\partial s} \\boldsymbol{t} + \\frac{\\partial u_t}{\\partial n} \\boldsymbol{n} $$\n向量 $\\boldsymbol{\\hat{n}}$ 是通过将 $\\boldsymbol{n}$ 朝 $\\boldsymbol{t}$ 方向旋转角度 $\\theta$ 形成的。在 $\\{\\boldsymbol{t}, \\boldsymbol{n}\\}$ 基底中，这给出：\n$$ \\boldsymbol{\\hat{n}} = \\sin\\theta \\, \\boldsymbol{t} + \\cos\\theta \\, \\boldsymbol{n} $$\n现在，我们计算方向导数：\n$$ \\frac{D u_t}{D \\hat{n}} = \\left( \\frac{\\partial u_t}{\\partial s} \\boldsymbol{t} + \\frac{\\partial u_t}{\\partial n} \\boldsymbol{n} \\right) \\cdot (\\sin\\theta \\, \\boldsymbol{t} + \\cos\\theta \\, \\boldsymbol{n}) $$\n利用基向量的标准正交性（$\\boldsymbol{t} \\cdot \\boldsymbol{t} = 1$, $\\boldsymbol{n} \\cdot \\boldsymbol{n} = 1$, $\\boldsymbol{t} \\cdot \\boldsymbol{n} = 0$）：\n$$ \\frac{D u_t}{D \\hat{n}} = \\frac{\\partial u_t}{\\partial s} \\sin\\theta + \\frac{\\partial u_t}{\\partial n} \\cos\\theta $$\n因此，近似的壁面剪切应力为：\n$$ \\tau_{w, \\text{approx}} = \\mu \\left( \\frac{\\partial u_t}{\\partial s} \\sin\\theta + \\frac{\\partial u_t}{\\partial n} \\cos\\theta \\right) $$\n误差 $\\Delta \\tau_w$ 是近似值与真实值之差：\n$$ \\Delta \\tau_w = \\tau_{w, \\text{approx}} - \\tau_{w, \\text{true}} = \\mu \\left( \\frac{\\partial u_t}{\\partial s} \\sin\\theta + \\frac{\\partial u_t}{\\partial n} \\cos\\theta \\right) - \\mu \\frac{\\partial u_t}{\\partial n} $$\n$$ \\Delta \\tau_w = \\mu \\left( \\frac{\\partial u_t}{\\partial s} \\sin\\theta + \\frac{\\partial u_t}{\\partial n} (\\cos\\theta - 1) \\right) $$\n为了找到误差的主阶表达式，我们对小的 $\\theta$（以弧度为单位）使用 $\\sin\\theta$ 和 $\\cos\\theta$ 的泰勒级数展开：\n$$ \\sin\\theta = \\theta - \\frac{\\theta^3}{6} + \\mathcal{O}(\\theta^5) $$\n$$ \\cos\\theta = 1 - \\frac{\\theta^2}{2} + \\frac{\\theta^4}{24} + \\mathcal{O}(\\theta^6) \\implies \\cos\\theta - 1 = -\\frac{\\theta^2}{2} + \\mathcal{O}(\\theta^4) $$\n将这些代入误差表达式：\n$$ \\Delta \\tau_w = \\mu \\left( \\frac{\\partial u_t}{\\partial s} \\left(\\theta - \\mathcal{O}(\\theta^3)\\right) + \\frac{\\partial u_t}{\\partial n} \\left(-\\frac{\\theta^2}{2} + \\mathcal{O}(\\theta^4)\\right) \\right) $$\n$$ \\Delta \\tau_w = \\mu \\theta \\frac{\\partial u_t}{\\partial s} - \\mu \\frac{\\theta^2}{2} \\frac{\\partial u_t}{\\partial n} + \\mathcal{O}(\\theta^3) $$\n主阶项是 $\\theta$ 幂次最低的项，即第一项。因此，误差的主阶表达式为：\n$$ \\Delta \\tau_{w, \\text{LO}} = \\mu \\theta \\frac{\\partial u_t}{\\partial s} $$\n\n### 第二部分：绝对误差的数值计算\n\n我们被要求计算给定情况下的绝对误差 $|\\Delta \\tau_w|$。为了准确性，我们将使用上面推导出的完整误差表达式。\n$$ |\\Delta \\tau_w| = \\left| \\mu \\left( \\frac{\\partial u_t}{\\partial s} \\sin\\theta + \\frac{\\partial u_t}{\\partial n} (\\cos\\theta - 1) \\right) \\right| $$\n给定值为：\n- 动力粘度, $\\mu = 1.8 \\times 10^{-5}\\ \\text{kg}\\ \\text{m}^{-1}\\ \\text{s}^{-1}$.\n- 切向速度的真实壁面法向梯度, $\\frac{\\partial u_t}{\\partial n} = 500\\ \\text{s}^{-1}$.\n- 切向速度的切向导数, $\\frac{\\partial u_t}{\\partial s} = 4000\\ \\text{s}^{-1}$.\n- 偏离角, $\\theta = 5^{\\circ}$.\n\n首先，我们必须将角度 $\\theta$ 转换为弧度，这是三角函数的要求：\n$$ \\theta_{\\text{rad}} = 5^{\\circ} \\times \\frac{\\pi}{180^{\\circ}} = \\frac{\\pi}{36}\\ \\text{rad} $$\n现在，我们将数值代入误差表达式：\n$$ \\Delta \\tau_w = (1.8 \\times 10^{-5}) \\left( (4000) \\sin\\left(\\frac{\\pi}{36}\\right) + (500) \\left(\\cos\\left(\\frac{\\pi}{36}\\right) - 1\\right) \\right) $$\n我们来计算各项：\n$$ \\sin\\left(\\frac{\\pi}{36}\\right) \\approx 0.08715574 $$\n$$ \\cos\\left(\\frac{\\pi}{36}\\right) \\approx 0.99619470 $$\n$$ \\cos\\left(\\frac{\\pi}{36}\\right) - 1 \\approx -0.00380530 $$\n将这些值代入表达式：\n$$ \\Delta \\tau_w \\approx (1.8 \\times 10^{-5}) \\left( (4000)(0.08715574) + (500)(-0.00380530) \\right) $$\n$$ \\Delta \\tau_w \\approx (1.8 \\times 10^{-5}) \\left( 348.62296 - 1.90265 \\right) $$\n$$ \\Delta \\tau_w \\approx (1.8 \\times 10^{-5}) (346.72031) $$\n$$ \\Delta \\tau_w \\approx 0.00624096558\\ \\text{Pa} $$\n问题要求的是绝对误差，即 $|\\Delta \\tau_w|$。由于结果是正数，绝对误差是相同的值。\n$$ |\\Delta \\tau_w| \\approx 0.00624096558\\ \\text{Pa} $$\n最后，我们将答案四舍五入至四位有效数字：\n$$ |\\Delta \\tau_w| \\approx 0.006241\\ \\text{Pa} $$\n用标准科学记数法表示，这等于 $6.241 \\times 10^{-3}\\ \\text{Pa}$。",
            "answer": "$$\\boxed{6.241 \\times 10^{-3}}$$"
        },
        {
            "introduction": "在分析单个物理量之外，我们还需要一种系统性的方法来评估数值格式在给定网格上的整体精度。人造解方法（Method of Manufactured Solutions, MMS）是CFD领域中用于代码验证的一种黄金标准技术。在此练习 () 中，你将实施一个MMS测试，通过数值实验量化格式的截断误差如何随着网格非正交性的增加而变化，这为你提供了一种量化分析代码与网格质量相互作用的强大工具。",
            "id": "3327993",
            "problem": "给定一个二维贴体结构化网格，该网格通过一个从计算坐标 $\\left(\\xi,\\eta\\right)\\in[0,1]\\times[0,1]$ 到物理坐标 $\\left(x,y\\right)$ 的平滑映射生成。考虑在没有体积力的情况下，$x$方向动量通量的二维定常Navier–Stokes方程的守恒形式。设密度 $\\rho=1$，动力粘度 $\\mu=1$。该映射定义为\n$$\nx\\left(\\xi,\\eta;\\alpha\\right) = \\xi + \\alpha\\,\\eta,\\qquad y\\left(\\xi,\\eta;\\kappa\\right) = \\eta\\left(1+\\kappa\\sin\\left(2\\pi \\xi\\right)\\right),\n$$\n其中 $\\alpha\\ge 0$ 和 $\\kappa\\ge 0$ 分别是控制扭曲度和边界波纹度的参数。该映射的偏导数为\n$$\nx_\\xi=1,\\quad x_\\eta=\\alpha,\\quad y_\\xi=\\eta\\,\\kappa\\,2\\pi\\cos\\left(2\\pi\\xi\\right),\\quad y_\\eta=1+\\kappa\\sin\\left(2\\pi\\xi\\right),\n$$\n其雅可比行列式为\n$$\nJ = x_\\xi y_\\eta - x_\\eta y_\\xi = \\left(1+\\kappa\\sin\\left(2\\pi\\xi\\right)\\right) - \\alpha\\,\\eta\\,\\kappa\\,2\\pi\\cos\\left(2\\pi\\xi\\right).\n$$\n通过逆雅可比矩阵定义逆度量系数\n$$\n\\begin{pmatrix}\n\\xi_x & \\xi_y\\\\\n\\eta_x & \\eta_y\n\\end{pmatrix}\n= \\frac{1}{J}\n\\begin{pmatrix}\ny_\\eta & -y_\\xi\\\\\n-x_\\eta & x_\\xi\n\\end{pmatrix},\n$$\n并令非对角度量大小为\n$$\nM_{\\text{off}} = \\left\\langle \\sqrt{\\xi_y^2 + \\eta_x^2}\\right\\rangle,\n$$\n其中 $\\langle\\cdot\\rangle$ 表示在内部网格点上的平均值。\n\n考虑制造的不可压缩速度场和压力场\n$$\nu\\left(x,y\\right) = \\sin\\left(\\pi x\\right)\\cos\\left(\\pi y\\right),\\qquad\nv\\left(x,y\\right) = -\\cos\\left(\\pi x\\right)\\sin\\left(\\pi y\\right),\\qquad\np\\left(x,y\\right) = \\cos\\left(\\pi x\\right)\\cos\\left(\\pi y\\right).\n$$\n这些场满足 $\\partial u/\\partial x + \\partial v/\\partial y = 0$。守恒的$x$方向动量通量为\n$$\nF_x = \\rho\\,u\\,u + p - \\tau_{xx},\\qquad G_x = \\rho\\,u\\,v - \\tau_{xy},\n$$\n其中牛顿应力分量为\n$$\n\\tau_{xx} = 2\\mu\\,\\frac{\\partial u}{\\partial x},\\qquad \\tau_{xy} = \\mu\\left(\\frac{\\partial u}{\\partial y} + \\frac{\\partial v}{\\partial x}\\right).\n$$\n在守恒曲线坐标形式中，$x$方向动量通量的散度变换为\n$$\n\\frac{\\partial F_x}{\\partial x} + \\frac{\\partial G_x}{\\partial y} = \\frac{1}{J}\\left(\\frac{\\partial H}{\\partial \\xi} + \\frac{\\partial K}{\\partial \\eta}\\right),\n$$\n其中逆变通量为\n$$\nH = F_x\\,y_\\eta - G_x\\,y_\\xi,\\qquad K = -F_x\\,x_\\eta + G_x\\,x_\\xi.\n$$\n设结构化计算网格是均匀的，在 $\\xi$ 方向上有 $N_\\xi$ 个点，在 $\\eta$ 方向上有 $N_\\eta$ 个点，从而间距为 $\\Delta \\xi = 1/\\left(N_\\xi-1\\right)$ 和 $\\Delta \\eta = 1/\\left(N_\\eta-1\\right)$。在内部点上使用二阶中心差分，离散守恒散度算子为\n$$\n\\left(\\frac{\\partial F_x}{\\partial x} + \\frac{\\partial G_x}{\\partial y}\\right)_{\\text{num}} \\approx \\frac{1}{J}\\left(\\frac{H\\left(\\xi+\\Delta\\xi,\\eta\\right) - H\\left(\\xi-\\Delta\\xi,\\eta\\right)}{2\\,\\Delta\\xi} + \\frac{K\\left(\\xi,\\eta+\\Delta\\eta\\right) - K\\left(\\xi,\\eta-\\Delta\\eta\\right)}{2\\,\\Delta\\eta}\\right).\n$$\n使用解析微分定义精确的物理空间散度，\n$$\n\\left(\\frac{\\partial F_x}{\\partial x} + \\frac{\\partial G_x}{\\partial y}\\right)_{\\text{exact}} = \\frac{\\partial F_x}{\\partial x} + \\frac{\\partial G_x}{\\partial y},\n$$\n其中所需的 $u,v,p$ 关于 $x$ 和 $y$ 的导数均通过解析方式求得。每个内部网格点的局部截断误差为\n$$\n\\text{TE} = \\left(\\frac{\\partial F_x}{\\partial x} + \\frac{\\partial G_x}{\\partial y}\\right)_{\\text{num}} - \\left(\\frac{\\partial F_x}{\\partial x} + \\frac{\\partial G_x}{\\partial y}\\right)_{\\text{exact}},\n$$\n全局度量是内部网格的均方根范数\n$$\n\\left\\|\\text{TE}\\right\\|_2 = \\sqrt{\\left\\langle \\text{TE}^2\\right\\rangle}.\n$$\n\n您的任务是构建可通过参数 $\\alpha$ 和 $\\kappa$ 控制扭曲度的贴体结构化网格，计算逆度量系数 $\\xi_x,\\xi_y,\\eta_x,\\eta_y$，实现守恒离散散度算子，并通过在一组 $(\\alpha,\\kappa)$ 对上拟合幂律 $\\left\\|\\text{TE}\\right\\|_2 \\approx C\\,M_{\\text{off}}^{q}$，来量化 $\\left\\|\\text{TE}\\right\\|_2$ 如何随非对角度量大小 $M_{\\text{off}}$ 变化。通过对 $\\log\\left(\\left\\|\\text{TE}\\right\\|_2\\right)$ 与 $\\log\\left(M_{\\text{off}}\\right)$ 进行最小二乘线性回归来估计标度指数 $q$，排除任何 $M_{\\text{off}}=0$ 的数据对。\n\n实现以下算法：\n- 为每个测试案例生成一个均匀的计算网格。\n- 使用 $x\\left(\\xi,\\eta;\\alpha\\right)$ 和 $y\\left(\\xi,\\eta;\\kappa\\right)$ 映射到物理空间。\n- 解析地计算 $x_\\xi,x_\\eta,y_\\xi,y_\\eta,J$，然后根据逆雅可比公式计算 $\\xi_x,\\xi_y,\\eta_x,\\eta_y$。\n- 在映射点上解析地计算 $u,v,p$ 及其所需的物理导数和二阶导数。\n- 构造 $F_x,G_x$，然后是 $H,K$，并使用中心差分在内部点上近似数值散度。\n- 使用解析表达式计算精确散度，然后计算 $\\text{TE}$ 和 $\\left\\|\\text{TE}\\right\\|_2$。\n- 计算 $M_{\\text{off}}$ 作为 $\\sqrt{\\xi_y^2 + \\eta_x^2}$ 的内部点平均值。\n- 对于每个测试案例，从 $(M_{\\text{off}},\\left\\|\\text{TE}\\right\\|_2)$ 数据对中拟合 $q$。\n\n角度以弧度为单位。所有量均为无量纲。最终输出必须是三个估计的指数 $q$，以浮点数形式表示。\n\n测试套件：\n- 案例1（正常路径）：$N_\\xi=N_\\eta=96$，$\\kappa=0.2$，$(\\alpha,\\kappa)$ 对：$(0.05,0.2)$、$(0.10,0.2)$、$(0.20,0.2)$、$(0.30,0.2)$。\n- 案例2（近正交边界）：$N_\\xi=N_\\eta=64$，$\\alpha=0.0$，$(\\alpha,\\kappa)$ 对：$(0.0,0.05)$、$(0.0,0.10)$、$(0.0,0.20)$、$(0.0,0.30)$。\n- 案例3（边缘扭曲度）：$N_\\xi=N_\\eta=80$，$(\\alpha,\\kappa)$ 对：$(0.05,0.10)$、$(0.10,0.20)$、$(0.20,0.30)$、$(0.25,0.30)$。\n\n您的程序应生成一行输出，其中包含用方括号括起来的逗号分隔的结果列表（例如，\"[result1,result2,result3]\"），其中 result$k$ 是按上述方法计算的案例 $k$ 的估计指数 $q$。不应打印其他任何文本。",
            "solution": "所提出的问题是计算流体力学（CFD）领域的一个有效练习，特别是在结构化网格上偏微分方程的数值分析子领域。它要求在贴体坐标系上实现和分析有限差分格式。该问题具有科学依据，定义明确，并且为解决它提供了所有必要的信息。我们将进行完整求解。\n\n主要目标是量化数值格式的截断误差如何受网格质量影响，在此案例中，即网格的非正交性。该方法涉及制造解、坐标变换和数值误差分析。\n\n### 1. 解析基础：制造解和通量\n\n分析始于一个预定义的、平滑的Navier-Stokes方程解，称为制造解。这使得方程中所有项的精确计算成为可能，这对于量化数值误差至关重要。给定的速度场和压力场是：\n$$\nu(x,y) = \\sin(\\pi x)\\cos(\\pi y)\n$$\n$$\nv(x,y) = -\\cos(\\pi x)\\sin(\\pi y)\n$$\n$$\np(x,y) = \\cos(\\pi x)\\cos(\\pi y)\n$$\n这些场满足不可压缩条件 $\\partial u/\\partial x + \\partial v/\\partial y = 0$。\n\n守恒的$x$方向动量通量 $F_x$ 和 $G_x$ 定义为：\n$$\nF_x = \\rho u^2 + p - \\tau_{xx}\n$$\n$$\nG_x = \\rho u v - \\tau_{xy}\n$$\n在密度 $\\rho=1$ 和动力粘度 $\\mu=1$ 的条件下，必须首先根据速度场确定应力分量 $\\tau_{xx}$ 和 $\\tau_{xy}$。所需的速度导数为：\n$$\n\\frac{\\partial u}{\\partial x} = \\pi \\cos(\\pi x)\\cos(\\pi y)\n$$\n$$\n\\frac{\\partial u}{\\partial y} = -\\pi \\sin(\\pi x)\\sin(\\pi y)\n$$\n$$\n\\frac{\\partial v}{\\partial x} = \\pi \\sin(\\pi x)\\sin(\\pi y)\n$$\n将这些代入牛顿应力的定义中得到：\n$$\n\\tau_{xx} = 2\\mu\\frac{\\partial u}{\\partial x} = 2\\pi \\cos(\\pi x)\\cos(\\pi y)\n$$\n$$\n\\tau_{xy} = \\mu\\left(\\frac{\\partial u}{\\partial y} + \\frac{\\partial v}{\\partial x}\\right) = \\left(-\\pi \\sin(\\pi x)\\sin(\\pi y) + \\pi \\sin(\\pi x)\\sin(\\pi y)\\right) = 0\n$$\n因此，通量分量为：\n$$\nF_x = \\sin^2(\\pi x)\\cos^2(\\pi y) + \\cos(\\pi x)\\cos(\\pi y) - 2\\pi \\cos(\\pi x)\\cos(\\pi y)\n$$\n$$\nG_x = -\\sin(\\pi x)\\cos(\\pi x)\\sin(\\pi y)\\cos(\\pi y) = -\\frac{1}{4}\\sin(2\\pi x)\\sin(2\\pi y)\n$$\n\n### 2. 精确物理空间散度\n\n$x$方向动量通量矢量的精确散度，它在动量方程中充当源项，由 $(\\frac{\\partial F_x}{\\partial x} + \\frac{\\partial G_x}{\\partial y})_{\\text{exact}}$ 给出。我们通过解析方法计算它：\n$$\n\\frac{\\partial F_x}{\\partial x} = 2\\pi\\sin(\\pi x)\\cos(\\pi x)\\cos^2(\\pi y) - \\pi(1-2\\pi)\\sin(\\pi x)\\cos(\\pi y)\n$$\n$$\n\\frac{\\partial G_x}{\\partial y} = -\\frac{1}{4}\\sin(2\\pi x) \\cdot 2\\pi\\cos(2\\pi y) = -\\frac{\\pi}{2}\\sin(2\\pi x)\\cos(2\\pi y)\n$$\n这两个表达式的和给出了在物理域中任意点 $(x,y)$ 处计算的精确散度。\n\n### 3. 网格生成与坐标变换\n\n在计算域 $(\\xi, \\eta) \\in [0,1]\\times[0,1]$ 中生成一个结构化网格。然后，使用以下变换将这个均匀网格映射到物理域 $(x,y)$：\n$$\nx(\\xi,\\eta) = \\xi + \\alpha\\eta\n$$\n$$\ny(\\xi,\\eta) = \\eta(1+\\kappa\\sin(2\\pi \\xi))\n$$\n参数 $\\alpha$ 和 $\\kappa$ 分别控制网格的扭曲度和边界曲率。当 $\\alpha = \\kappa = 0$ 时，映射简化为 $x=\\xi, y=\\eta$，产生一个笛卡尔网格。\n\n为了在计算域中求解控制方程，我们需要从映射中导出的度量项。偏导数为：\n$$\nx_\\xi = 1, \\quad x_\\eta = \\alpha, \\quad y_\\xi = 2\\pi\\kappa\\eta\\cos(2\\pi\\xi), \\quad y_\\eta = 1+\\kappa\\sin(2\\pi\\xi)\n$$\n变换的雅可比行列式是 $J = x_\\xi y_\\eta - x_\\eta y_\\xi$。对于变换导数至关重要的逆度量系数由以下公式给出：\n$$\n\\xi_x = \\frac{y_\\eta}{J}, \\quad \\xi_y = -\\frac{y_\\xi}{J}, \\quad \\eta_x = -\\frac{x_\\eta}{J}, \\quad \\eta_y = \\frac{x_\\xi}{J}\n$$\n问题将非对角度量大小定义为 $M_{\\text{off}} = \\langle \\sqrt{\\xi_y^2 + \\eta_x^2} \\rangle$，作为网格非正交性的度量。对于正交网格，$\\xi_y$ 和 $\\eta_x$ 都将为零。\n\n### 4. 数值离散化与截断误差\n\n散度算子的守恒形式变换为：\n$$\n\\frac{\\partial F_x}{\\partial x} + \\frac{\\partial G_x}{\\partial y} = \\frac{1}{J}\\left(\\frac{\\partial H}{\\partial \\xi} + \\frac{\\partial K}{\\partial \\eta}\\right)\n$$\n其中 $H$ 和 $K$ 是逆变通量：\n$$\nH = J(F_x\\xi_x + G_x\\xi_y) = F_x y_\\eta - G_x y_\\xi\n$$\n$$\nK = J(F_x\\eta_x + G_x\\eta_y) = -F_x x_\\eta + G_x x_\\xi\n$$\n在计算网格的内部点上，使用二阶中心差分格式对散度进行数值近似：\n$$\n\\left(\\frac{\\partial F_x}{\\partial x} + \\frac{\\partial G_x}{\\partial y}\\right)_{\\text{num}} \\approx \\frac{1}{J_{i,j}}\\left(\\frac{H_{i+1,j} - H_{i-1,j}}{2\\Delta\\xi} + \\frac{K_{i,j+1} - K_{i,j-1}}{2\\Delta\\eta}\\right)\n$$\n局部截断误差（$\\text{TE}$）是每个内部网格点上数值近似与精确解析值之间的差异：\n$$\n\\text{TE} = \\left(\\frac{\\partial F_x}{\\partial x} + \\frac{\\partial G_x}{\\partial y}\\right)_{\\text{num}} - \\left(\\frac{\\partial F_x}{\\partial x} + \\frac{\\partial G_x}{\\partial y}\\right)_{\\text{exact}}\n$$\n全局误差由所有内部点上TE的均方根范数量化，$\\|\\text{TE}\\|_2 = \\sqrt{\\langle \\text{TE}^2 \\rangle}$。\n\n### 5. 幂律标度分析\n\n核心任务是确定全局误差 $\\|\\text{TE}\\|_2$ 如何随网格非正交性 $M_{\\text{off}}$ 变化。这通过幂律模型来建模：\n$$\n\\|\\text{TE}\\|_2 \\approx C M_{\\text{off}}^q\n$$\n为了找到指数 $q$，我们通过取两边的对数来线性化关系：\n$$\n\\log(\\|\\text{TE}\\|_2) \\approx \\log(C) + q \\log(M_{\\text{off}})\n$$\n这表示一个线性方程 $Y \\approx A + qX$，其中 $X=\\log(M_{\\text{off}})$，$Y=\\log(\\|\\text{TE}\\|_2)$。对于每个测试案例，我们为几组 $(\\alpha, \\kappa)$ 计算对 $(M_{\\text{off}}, \\|\\text{TE}\\|_2)$。然后，指数 $q$ 被估计为通过所得 $(\\log(M_{\\text{off}}), \\log(\\|\\text{TE}\\|_2))$ 数据点的最佳拟合线的斜率，使用线性最小二乘回归。对于二阶格式，通常期望 $q=2$，这表明误差随与正交性的微小偏差呈二次方增长。\n\n算法通过为每个测试案例迭代指定的 $(\\alpha, \\kappa)$ 对来进行，为每对计算 $M_{\\text{off}}$ 和 $\\|\\text{TE}\\|_2$，最后执行回归以找到 $q$。",
            "answer": "```python\nimport numpy as np\n\ndef process_case(N, pairs):\n    \"\"\"\n    Processes a single test case to find the scaling exponent q.\n    \n    Args:\n        N (int): The number of grid points in each direction (N_xi = N_eta).\n        pairs (list of tuples): A list of (alpha, kappa) parameter pairs to test.\n        \n    Returns:\n        float: The estimated scaling exponent q.\n    \"\"\"\n    log_M_off_list = []\n    log_TE_norm_list = []\n\n    for alpha, kappa in pairs:\n        N_xi = N_eta = N\n        d_xi = 1.0 / (N_xi - 1)\n        d_eta = 1.0 / (N_eta - 1)\n        \n        xi_vec = np.linspace(0, 1, N_xi)\n        eta_vec = np.linspace(0, 1, N_eta)\n        XI, ETA = np.meshgrid(xi_vec, eta_vec, indexing='ij')\n\n        # 1. Map to physical space and compute metrics\n        X = XI + alpha * ETA\n        Y = ETA * (1 + kappa * np.sin(2 * np.pi * XI))\n\n        # Analytic derivatives of the mapping\n        X_xi = np.ones_like(XI)\n        X_eta = alpha * np.ones_like(XI)\n        Y_xi = ETA * kappa * 2 * np.pi * np.cos(2 * np.pi * XI)\n        Y_eta = 1 + kappa * np.sin(2 * np.pi * XI)\n        \n        J = X_xi * Y_eta - X_eta * Y_xi\n        if np.any(J <= 0):\n            raise ValueError(\"Jacobian is non-positive, grid is folded.\")\n\n        # Inverse metric coefficients\n        XI_y = -Y_xi / J\n        ETA_x = -X_eta / J\n        \n        # Off-diagonal metric magnitude (averaged over interior)\n        M_off_field = np.sqrt(XI_y**2 + ETA_x**2)\n        M_off = np.mean(M_off_field[1:-1, 1:-1])\n        \n        # 2. Evaluate manufactured solution and fluxes\n        pi = np.pi\n        u = np.sin(pi * X) * np.cos(pi * Y)\n        v = -np.cos(pi * X) * np.sin(pi * Y)\n        p = np.cos(pi * X) * np.cos(pi * Y)\n        \n        u_x = pi * np.cos(pi * X) * np.cos(pi * Y)\n        tau_xx = 2 * u_x # mu=1\n        \n        F_x = u**2 + p - tau_xx # rho=1\n        G_x = u * v\n\n        # 3. Compute contravariant fluxes\n        H = F_x * Y_eta - G_x * Y_xi\n        K = -F_x * X_eta + G_x * X_xi\n\n        # 4. Compute numerical divergence on interior points\n        H_ip1 = H[2:, 1:-1]\n        H_im1 = H[:-2, 1:-1]\n        K_jp1 = K[1:-1, 2:]\n        K_jm1 = K[1:-1, :-2]\n        J_int = J[1:-1, 1:-1]\n        \n        div_num = (1.0 / J_int) * (\n            (H_ip1 - H_im1) / (2 * d_xi) + \n            (K_jp1 - K_jm1) / (2 * d_eta)\n        )\n\n        # 5. Compute exact divergence on interior points\n        X_int = X[1:-1, 1:-1]\n        Y_int = Y[1:-1, 1:-1]\n        \n        dFx_dx = pi*np.sin(2*pi*X_int)*np.cos(pi*Y_int)**2 - pi*(1-2*pi)*np.sin(pi*X_int)*np.cos(pi*Y_int)\n        dGx_dy = -0.5*pi * np.sin(2*pi*X_int) * np.cos(2*pi*Y_int)\n        div_exact = dFx_dx + dGx_dy\n        \n        # 6. Compute truncation error norm\n        TE = div_num - div_exact\n        TE_norm = np.sqrt(np.mean(TE**2))\n\n        # Store log of values for regression, excluding M_off=0 cases\n        if M_off > 0:\n            log_M_off_list.append(np.log(M_off))\n            log_TE_norm_list.append(np.log(TE_norm))\n\n    # 7. Perform linear regression on log-log data to find the exponent q\n    if len(log_M_off_list) < 2:\n        return 0.0 # Not enough data points to fit a line\n\n    log_M_off_arr = np.array(log_M_off_list)\n    log_TE_norm_arr = np.array(log_TE_norm_list)\n\n    # polyfit returns [slope, intercept]; the slope is our exponent q\n    q = np.polyfit(log_M_off_arr, log_TE_norm_arr, 1)[0]\n    \n    return q\n\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the results.\n    \"\"\"\n    test_cases = [\n        # Case 1\n        {\n            \"N\": 96,\n            \"pairs\": [(0.05, 0.2), (0.10, 0.2), (0.20, 0.2), (0.30, 0.2)]\n        },\n        # Case 2\n        {\n            \"N\": 64,\n            \"pairs\": [(0.0, 0.05), (0.0, 0.10), (0.0, 0.20), (0.0, 0.30)]\n        },\n        # Case 3\n        {\n            \"N\": 80,\n            \"pairs\": [(0.05, 0.10), (0.10, 0.20), (0.20, 0.30), (0.25, 0.30)]\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        q = process_case(case[\"N\"], case[\"pairs\"])\n        results.append(q)\n\n    # Format the final output string exactly as required\n    print(f\"[{','.join(f'{r:.12f}' for r in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "有时候，数值误差并非仅仅表现为精度的降低，它们还可能引入与物理现实完全不符的行为。这最后一个练习 () 聚焦于“几何守恒律”（Geometric Conservation Law, GCL）这一核心概念。你将通过实践探索，在曲线坐标网格上，一个不恰当的离散格式为何无法保持一个简单的物理状态（如均匀旋转流场），从而在流场中产生伪涡量，并学习如何构建诊断程序来识别这类关键的数值错误。",
            "id": "3327956",
            "problem": "给定一个边界拟合的二维结构化曲线网格，它将计算坐标 $(\\xi,\\eta)\\in[0,1]\\times[0,1]$ 映射到物理空间 $(x,y)\\in\\mathbb{R}^2$，由 $x(\\xi,\\eta)$ 和 $y(\\xi,\\eta)$ 定义。同时给定一个刚体旋转场，其切向速度为 $u_\\theta(\\boldsymbol{x})=\\Omega r$，其中 $r=\\sqrt{x^2+y^2}$，$\\Omega$ 是一个恒定的角速度。在笛卡尔分量中，速度为 $(u,v)=(-\\Omega y,\\Omega x)$。对于刚体旋转，物理涡度（二维速度的旋度）定义为 $\\omega=\\partial v/\\partial x - \\partial u/\\partial y$，它是一个空间常数 $\\omega=2\\Omega$。在曲线网格上，$\\omega$ 的离散计算应遵守几何度量恒等式；否则，会产生伪涡。\n\n从涡度的基本定义 $\\omega=\\partial v/\\partial x - \\partial u/\\partial y$ 和光滑映射 $\\boldsymbol{r}(\\xi,\\eta)=(x(\\xi,\\eta),y(\\xi,\\eta))$ 的定义出发，定义切向量 $\\boldsymbol{t}^\\xi=\\partial\\boldsymbol{r}/\\partial\\xi=(x_\\xi,y_\\xi)$ 和 $\\boldsymbol{t}^\\eta=\\partial\\boldsymbol{r}/\\partial\\eta=(x_\\eta,y_\\eta)$，以及雅可比行列式 $J=x_\\xi y_\\eta - x_\\eta y_\\xi$。使用链式法则推导涡度的守恒形式，\n$$\n\\omega = \\frac{1}{J}\\left( \\frac{\\partial}{\\partial \\xi}\\left(u\\,x_\\eta + v\\,y_\\eta\\right) - \\frac{\\partial}{\\partial \\eta}\\left(u\\,x_\\xi + v\\,y_\\xi\\right)\\right),\n$$\n并构造一个离散算子，在结构化网格上用二阶中心差分来近似 $\\xi$ 和 $\\eta$ 中的导数。度量恒等式是指混合偏导数的相等关系（例如 $x_{\\xi\\eta}=x_{\\eta\\xi}$ 和 $y_{\\xi\\eta}=y_{\\eta\\xi}$）。当度量 $(x_\\xi,x_\\eta,y_\\xi,y_\\eta)$ 的离散近似不一致而违反这些恒等式时，即使对于均匀旋转场，也会产生伪涡。\n\n实现以下具有内半径 $r_0$ 和外半径 $r_1$ 的环形区域的边界拟合映射：\n- 令 $\\theta(\\xi,\\eta)=2\\pi \\xi + \\alpha \\sin(2\\pi \\xi)\\sin(2\\pi \\eta)$，\n- 令 $r(\\eta)=r_0 + (r_1-r_0)\\eta + \\beta \\sin(2\\pi \\eta)$，\n- 令 $x(\\xi,\\eta)=r(\\eta)\\cos(\\theta(\\xi,\\eta))$ 和 $y(\\xi,\\eta)=r(\\eta)\\sin(\\theta(\\xi,\\eta))$，\n其中 $\\alpha=0.2 a$ 和 $\\beta=0.1 a$，而 $a\\ge 0$ 是一个控制网格曲率的扭曲振幅参数。\n\n定义一个诊断量，通过离散涡度与精确值 $2\\Omega$ 的相对偏差来量化伪涡：\n$$\nD=\\max_{i,j}\\left|\\frac{\\omega_{i,j}}{2\\Omega}-1\\right|,\n$$\n其中 $\\omega_{i,j}$ 是在内部节点 $(i,j)$ 处计算的离散涡度。用于检测伪涡的布尔值为\n$$\nB=\\begin{cases}\n\\text{True}, & D>\\tau,\\\\\n\\text{False}, & D\\le \\tau,\n\\end{cases}\n$$\n指定阈值为 $\\tau=0.05$（无量纲）。诊断量 $D$ 是无量纲的；角速度 $\\Omega$ 的单位是 $\\text{s}^{-1}$，但要求的输出是无量纲的诊断量和相应的布尔标志，因此无需打印物理单位。\n\n你的程序必须：\n- 为给定的 $(N_\\xi,N_\\eta,a)$ 构建网格，\n- 为给定的 $\\Omega$，根据 $(x,y)$ 计算 $(u,v)$，\n- 使用上述守恒旋度形式计算离散涡度 $\\omega$，并采用以下方法：\n    1. 来自映射公式的解析度量 $(x_\\xi,x_\\eta,y_\\xi,y_\\eta)$，\n    2. 来自 $(x,y)$ 的二阶中心差分的一致离散度量，\n    3. 通过混合使用前向和后向差分格式来计算不同分量，从而违反度量恒等式的不一致离散度量，\n- 为每种情况计算 $D$ 和 $B$。\n\n测试套件：\n使用 $\\Omega=1.0\\,\\text{s}^{-1}$，$r_0=1.0\\,\\text{m}$，$r_1=2.0\\,\\text{m}$ 和阈值 $\\tau=0.05$。评估以下五个测试用例：\n1. $(N_\\xi,N_\\eta,a,\\text{metric})=(64,32,0.10,\\text{analytic})$。\n2. $(N_\\xi,N_\\eta,a,\\text{metric})=(64,32,0.10,\\text{central})$。\n3. $(N_\\xi,N_\\eta,a,\\text{metric})=(64,32,0.10,\\text{broken})$。\n4. $(N_\\xi,N_\\eta,a,\\text{metric})=(64,32,0.30,\\text{broken})$。\n5. $(N_\\xi,N_\\eta,a,\\text{metric})=$(16,8,0.10,$\\text{central}$).\n\n最终输出格式：\n你的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，顺序为 $[D_1,B_1,D_2,B_2,D_3,B_3,D_4,B_4,D_5,B_5]$。每个 $D_k$ 必须是一个十进制数（无量纲），每个 $B_k$ 必须是一个布尔值。例如，一个可接受的输出格式为 `[0.0012,False,0.0034,False,0.1523,True,0.3011,True,0.0221,False]`。",
            "solution": "用户提供了一个科学上合理、适定且完整的问题。所有必要的数据、方程和测试条件都已指定，并且该问题遵循计算流体动力学（CFD）的既定原则。该问题有效，可以按所述方式解决。\n\n该问题要求在变换后的坐标系中推导涡度的守恒形式，然后通过数值实现来诊断由几何度量项的不一致离散近似所产生的伪涡。\n\n**1. 理论基础**\n\n二维笛卡尔坐标 $(x,y)$ 中速度场 $\\boldsymbol{u}=(u,v)$ 的涡度 $\\omega$ 定义为速度场的旋度：\n$$\n\\omega = \\frac{\\partial v}{\\partial x} - \\frac{\\partial u}{\\partial y}\n$$\n给定一个从计算坐标 $(\\xi,\\eta)$ 到物理坐标 $(x,y)$ 的光滑可逆映射，定义为 $x=x(\\xi,\\eta)$ 和 $y=y(\\xi,\\eta)$。链式法则允许我们变换偏导数算子。偏导数之间的关系是：\n$$\n\\frac{\\partial}{\\partial x} = \\frac{\\partial \\xi}{\\partial x}\\frac{\\partial}{\\partial \\xi} + \\frac{\\partial \\eta}{\\partial x}\\frac{\\partial}{\\partial \\eta}\n$$\n$$\n\\frac{\\partial}{\\partial y} = \\frac{\\partial \\xi}{\\partial y}\\frac{\\partial}{\\partial \\xi} + \\frac{\\partial \\eta}{\\partial y}\\frac{\\partial}{\\partial \\eta}\n$$\n逆变换的导数 $(\\xi_x, \\xi_y, \\eta_x, \\eta_y)$ 可以用正变换的导数 $(x_\\xi, x_\\eta, y_\\xi, y_\\eta)$ 通过变换的雅可比矩阵的逆来表示：\n$$\n\\begin{pmatrix} \\xi_x & \\xi_y \\\\ \\eta_x & \\eta_y \\end{pmatrix} = \\begin{pmatrix} x_\\xi & y_\\xi \\\\ x_\\eta & y_\\eta \\end{pmatrix}^{-1} = \\frac{1}{J} \\begin{pmatrix} y_\\eta & -y_\\xi \\\\ -x_\\eta & x_\\xi \\end{pmatrix}\n$$\n其中 $J = x_\\xi y_\\eta - x_\\eta y_\\xi$ 是变换的雅可比行列式。\n\n将这些代入涡度的定义中可得：\n$$\n\\omega = \\left( \\frac{\\partial \\xi}{\\partial x}\\frac{\\partial v}{\\partial \\xi} + \\frac{\\partial \\eta}{\\partial x}\\frac{\\partial v}{\\partial \\eta} \\right) - \\left( \\frac{\\partial \\xi}{\\partial y}\\frac{\\partial u}{\\partial \\xi} + \\frac{\\partial \\eta}{\\partial y}\\frac{\\partial u}{\\partial \\eta} \\right)\n$$\n$$\n\\omega = \\frac{1}{J} \\left( y_\\eta \\frac{\\partial v}{\\partial \\xi} - x_\\eta \\frac{\\partial v}{\\partial \\eta} \\right) - \\frac{1}{J} \\left( -y_\\xi \\frac{\\partial u}{\\partial \\xi} + x_\\xi \\frac{\\partial u}{\\partial \\eta} \\right)\n$$\n$$\nJ\\omega = \\left( y_\\eta v_\\xi - y_\\xi v_\\eta - (-x_\\eta u_\\xi + x_\\xi u_\\eta) \\right) = (x_\\eta u_\\xi + y_\\eta v_\\xi) - (x_\\xi u_\\eta + y_\\xi v_\\eta)\n$$\n这是涡度方程的非守恒形式。问题要求推导守恒形式：\n$$\n\\omega = \\frac{1}{J}\\left( \\frac{\\partial}{\\partial \\xi}\\left(u\\,x_\\eta + v\\,y_\\eta\\right) - \\frac{\\partial}{\\partial \\eta}\\left(u\\,x_\\xi + v\\,y_\\xi\\right)\\right)\n$$\n为了证明它们的等价性，我们使用乘法法则展开右侧：\n$$\nJ\\omega = \\left( u_\\xi x_\\eta + u x_{\\eta\\xi} + v_\\xi y_\\eta + v y_{\\eta\\xi} \\right) - \\left( u_\\eta x_\\xi + u x_{\\xi\\eta} + v_\\eta y_\\xi + v y_{\\xi\\eta} \\right)\n$$\n$$\nJ\\omega = (u_\\xi x_\\eta + v_\\xi y_\\eta) - (u_\\eta x_\\xi + v_\\eta y_\\xi) + u(x_{\\eta\\xi} - x_{\\xi\\eta}) + v(y_{\\eta\\xi} - y_{\\xi\\eta})\n$$\n如果坐标映射足够光滑（二次连续可微），那么根据混合偏导数的相等性（Clairaut 定理），我们有 $x_{\\xi\\eta} = x_{\\eta\\xi}$ 和 $y_{\\xi\\eta} = y_{\\eta\\xi}$。这些被称为几何度量恒等式。在此条件下，最后两项消失，方程简化为先前推导的非守恒形式。\n\n关键的洞见在于，虽然这个恒等式在解析上成立，但其离散近似可能不成立。项 $u(D_\\xi D_\\eta x - D_\\eta D_\\xi x) + v(D_\\xi D_\\eta y - D_\\eta D_\\xi y)$，其中 $D$ 代表离散差分算子，如果度量的离散算子选择不一致，该项可能非零。这个非零项会产生虚假的、非物理的涡度。具有空间恒定物理涡度 $\\omega = 2\\Omega$ 的刚体旋转场是这种“自由流保持”特性的经典测试案例。一个数值格式应该能够精确地保持这种恒定状态，任何偏差都表明离散化存在缺陷，特别是在满足离散几何守恒律方面。\n\n**2. 数值实现策略**\n\n任务的核心是为三种计算度量项 $(x_\\xi, x_\\eta, y_\\xi, y_\\eta)$ 的不同方法计算内部网格节点上的离散涡度 $\\omega_{i,j}$。\n\n**网格与坐标**：在计算域 $[0,1]\\times[0,1]$ 中定义一个具有 $(N_\\xi, N_\\eta)$ 个点的均匀结构化网格。网格间距为 $\\Delta\\xi = 1/(N_\\xi-1)$ 和 $\\Delta\\eta = 1/(N_\\eta-1)$。使用提供的映射公式在每个网格点上计算物理坐标 $(x,y)$。\n\n**速度场**：在每个网格点上计算速度分量 $(u, v) = (-\\Omega y, \\Omega x)$。\n\n**度量项计算**：\n1.  **解析法**：从映射方程解析推导偏导数 $(x_\\xi, y_\\xi, x_\\eta, y_\\eta)$，并在每个网格点上进行计算。此方法完美满足度量恒等式。\n2.  **一致法（中心差分）**：使用 $(x,y)$ 网格上的二阶中心差分来近似度量项。`numpy.gradient` 函数是合适的，因为它对内部点使用中心差分，在边界上使用二阶单边差分，从而确保一致性。均匀网格上的离散中心差分算子是可交换的，因此离散度量恒等式在机器精度范围内得到满足。\n3.  **不一致法（破缺法）**：为了故意违反度量恒等式，我们对不同分量使用不同的有限差分格式。例如，我们使用前向差分计算 $x$ 的导数（$x_\\xi, x_\\eta$），使用后向差分计算 $y$ 的导数（$y_\\xi, y_\\eta$）。这种不一致性导致 $D_\\xi D_\\eta x \\neq D_\\eta D_\\xi x$（对 $y$ 也是如此），从而产生伪涡。\n\n**涡度计算**：\n给定度量后，我们在所有网格点上构建量 $F_\\xi = u x_\\eta + v y_\\eta$ 和 $F_\\eta = u x_\\xi + v y_\\xi$。然后，使用对 $F_\\xi$ 和 $F_\\eta$ 的二阶中心差分来计算内部节点 $(i,j)$（其中 $i \\in [1, N_\\xi-2], j \\in [1, N_\\eta-2]$）的涡度：\n$$\n\\omega_{i,j} = \\frac{1}{J_{i,j}} \\left( \\frac{(F_\\xi)_{i+1,j} - (F_\\xi)_{i-1,j}}{2\\Delta\\xi} - \\frac{(F_\\eta)_{i,j+1} - (F_\\eta)_{i,j-1}}{2\\Delta\\eta} \\right)\n$$\n雅可比行列式 $J_{i,j}$ 也使用计算出的度量在内部节点上进行计算。\n\n**诊断量计算**：\n在所有内部节点上计算相对偏差 $D = \\max_{i,j} \\left| \\omega_{i,j}/(2\\Omega) - 1 \\right|$。如果 $D > \\tau$，则布尔标志 $B$ 设置为真。\n\n该实现将处理五个测试用例中的每一个，为每个用例计算并存储一对 $(D, B)$。",
            "answer": "```python\nimport numpy as np\n\ndef run_case(N_xi, N_eta, a, metric_type, r0, r1, Omega, tau):\n    \"\"\"\n    Computes spurious vorticity for a single test case.\n    \"\"\"\n    # 1. Construct the computational grid\n    xi_1d = np.linspace(0, 1, N_xi)\n    eta_1d = np.linspace(0, 1, N_eta)\n    dxi = 1.0 / (N_xi - 1)\n    deta = 1.0 / (N_eta - 1)\n    XI_m, ETA_m = np.meshgrid(xi_1d, eta_1d, indexing='ij')\n\n    # Parameters for the mapping\n    alpha = 0.2 * a\n    beta = 0.1 * a\n    PI2 = 2.0 * np.pi\n\n    # 2. Compute physical coordinates and analytical metrics if needed\n    theta = PI2 * XI_m + alpha * np.sin(PI2 * XI_m) * np.sin(PI2 * ETA_m)\n    r = r0 + (r1 - r0) * ETA_m + beta * np.sin(PI2 * ETA_m)\n    x = r * np.cos(theta)\n    y = r * np.sin(theta)\n\n    # 3. Evaluate metric terms based on metric_type\n    if metric_type == 'analytic':\n        theta_xi = PI2 * (1.0 + alpha * np.cos(PI2 * XI_m) * np.sin(PI2 * ETA_m))\n        theta_eta = PI2 * alpha * np.sin(PI2 * XI_m) * np.cos(PI2 * ETA_m)\n        r_eta = (r1 - r0) + PI2 * beta * np.cos(PI2 * ETA_m)\n        \n        x_xi = -y * theta_xi\n        y_xi = x * theta_xi\n        x_eta = r_eta * np.cos(theta) - y * theta_eta\n        y_eta = r_eta * np.sin(theta) + x * theta_eta\n\n    elif metric_type == 'central':\n        x_xi, x_eta = np.gradient(x, dxi, deta, axis=(0, 1))\n        y_xi, y_eta = np.gradient(y, dxi, deta, axis=(0, 1))\n\n    elif metric_type == 'broken':\n        # Inconsistent differencing to break GCL\n        # For example, use forward for x-derivatives and backward for y-derivatives\n        # This is just one of many ways to be inconsistent.\n        # d/dxi: forward for x, backward for y\n        x_xi_fwd = np.zeros_like(x)\n        x_xi_fwd[:-1, :] = (x[1:, :] - x[:-1, :]) / dxi\n        x_xi_fwd[-1, :] = (x[-1, :] - x[-2, :]) / dxi\n        x_xi = x_xi_fwd\n\n        y_xi_bwd = np.zeros_like(y)\n        y_xi_bwd[1:, :] = (y[1:, :] - y[:-1, :]) / dxi\n        y_xi_bwd[0, :] = (y[1, :] - y[0, :]) / dxi\n        y_xi = y_xi_bwd\n\n        # d/deta: forward for x, backward for y\n        x_eta_fwd = np.zeros_like(x)\n        x_eta_fwd[:, :-1] = (x[:, 1:] - x[:, :-1]) / deta\n        x_eta_fwd[:, -1] = (x[:, -1] - x[:, -2]) / deta\n        x_eta = x_eta_fwd\n        \n        y_eta_bwd = np.zeros_like(y)\n        y_eta_bwd[:, 1:] = (y[:, 1:] - y[:, :-1]) / deta\n        y_eta_bwd[:, 0] = (y[:, 1] - y[:, 0]) / deta\n        y_eta = y_eta_bwd\n    \n    else:\n        raise ValueError(\"Unknown metric type\")\n\n    # 4. Evaluate velocity field\n    u = -Omega * y\n    v = Omega * x\n\n    # 5. Compute conservative flux-like terms\n    F_xi = u * x_eta + v * y_eta\n    F_eta = u * x_xi + v * y_xi\n\n    # 6. Compute vorticity on interior nodes\n    # Slice to get interior points for the final result\n    # We need a 3-point stencil, so we compute derivatives for [1:-1]\n    # d/dxi needs F_xi[2:, 1:-1] and F_xi[:-2, 1:-1]\n    dFxi_dxi = (F_xi[2:, 1:-1] - F_xi[:-2, 1:-1]) / (2.0 * dxi)\n    # d/deta needs F_eta[1:-1, 2:] and F_eta[1:-1, :-2]\n    dFeta_deta = (F_eta[1:-1, 2:] - F_eta[1:-1, :-2]) / (2.0 * deta)\n    \n    # Jacobian on interior nodes\n    J_interior = (x_xi * y_eta - x_eta * y_xi)[1:-1, 1:-1]\n    \n    # Avoid division by zero, although J should be > 0 for a valid mesh\n    J_interior[J_interior == 0] = 1e-16\n\n    omega_discrete = (1.0 / J_interior) * (dFxi_dxi - dFeta_deta)\n\n    # 7. Compute diagnostics\n    omega_exact = 2.0 * Omega\n    D = np.max(np.abs(omega_discrete / omega_exact - 1.0))\n    B = D > tau\n\n    return D, B\n\n\ndef solve():\n    \"\"\"\n    Main solver function to run all test cases and print the results.\n    \"\"\"\n    # Define test cases from the problem statement.\n    test_cases = [\n        (64, 32, 0.10, 'analytic'),\n        (64, 32, 0.10, 'central'),\n        (64, 32, 0.10, 'broken'),\n        (64, 32, 0.30, 'broken'),\n        (16, 8, 0.10, 'central'),\n    ]\n\n    # Global parameters\n    Omega = 1.0  # s^-1\n    r0 = 1.0     # m\n    r1 = 2.0     # m\n    tau = 0.05   # dimensionless threshold\n\n    results = []\n    for case in test_cases:\n        N_xi, N_eta, a, metric_type = case\n        try:\n            D, B = run_case(N_xi, N_eta, a, metric_type, r0, r1, Omega, tau)\n        except ValueError: # Catch inconsistent metric generation issues\n            D, B = float('inf'), True\n        results.append(D)\n        results.append(B)\n    \n    # Format the final output string exactly as required\n    formatted_results = []\n    for item in results:\n        if isinstance(item, bool):\n            # Python bools 'True'/'False' match required output.\n            formatted_results.append(str(item))\n        else: # float\n            # Using a reasonable precision for floating point numbers\n            formatted_results.append(f\"{item:.12f}\")\n\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}