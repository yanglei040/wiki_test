{
    "hands_on_practices": [
        {
            "introduction": "The heart of the Eulerian-Eulerian model lies in the coupling between phases, with interphase drag being a primary mechanism of momentum exchange. This coupling, while physically crucial, introduces numerical stiffness that can severely restrict the time step size, $\\Delta t$, in explicit simulations. This exercise  guides you through a stability analysis of the drag term, demonstrating how to derive the maximum stable time step from the eigenvalues of the linearized system. Mastering this analysis is fundamental to designing and diagnosing the performance of time integration schemes for two-fluid models.",
            "id": "3315453",
            "problem": "Consider a homogeneous, well-mixed gas–liquid system modeled using the Eulerian–Eulerian two-fluid formulation in Computational Fluid Dynamics (CFD). Focus on a single computational cell in which convective, pressure-gradient, and viscous stresses are negligible compared to interphase drag. The gas phase has density $\\rho_{g} = 1.2$ $\\mathrm{kg/m^{3}}$ and volume fraction $\\alpha_{g} = 0.10$, while the liquid phase has density $\\rho_{\\ell} = 1000$ $\\mathrm{kg/m^{3}}$ and volume fraction $\\alpha_{\\ell} = 0.90$. The interphase momentum exchange coefficient (drag coefficient) is taken as a constant $K = 150$ $\\mathrm{kg/(m^{3}\\,s)}$ over the time step of interest.\n\nStarting from the phase momentum balances per unit volume and Newton’s Third Law for interphase drag, derive the linearized operator for the purely drag-coupled velocity dynamics of the two phases. Determine its eigenvalues and, from these, compute the largest stable time step bound $\\Delta t_{\\max}$ for the explicit Forward Euler time discretization of the drag source term alone, using the spectral radius of the linearized drag coupling operator as the stability-controlling quantity. Express the final time step bound in seconds and round your answer to four significant figures.",
            "solution": "The problem is first validated against the required criteria.\n\n### Problem Validation\n\n**Step 1: Extract Givens**\n\n-   Model: Eulerian–Eulerian two-fluid formulation in Computational Fluid Dynamics (CFD).\n-   System: Homogeneous, well-mixed gas–liquid system in a single computational cell.\n-   Assumptions: Convective, pressure-gradient, and viscous stresses are negligible. Interphase momentum exchange is dominated by drag.\n-   Gas phase density: $\\rho_{g} = 1.2$ $\\mathrm{kg/m^{3}}$.\n-   Gas phase volume fraction: $\\alpha_{g} = 0.10$.\n-   Liquid phase density: $\\rho_{\\ell} = 1000$ $\\mathrm{kg/m^{3}}$.\n-   Liquid phase volume fraction: $\\alpha_{\\ell} = 0.90$.\n-   Interphase momentum exchange coefficient: $K = 150$ $\\mathrm{kg/(m^{3}\\,s)}$.\n-   Numerical scheme: Explicit Forward Euler time discretization for the drag source term.\n-   Objective: Derive the linearized drag-coupling operator, find its eigenvalues, and use the spectral radius to find the largest stable time step $\\Delta t_{\\max}$.\n-   Result specification: Round the final answer to four significant figures.\n\n**Step 2: Validate Using Extracted Givens**\n\n-   **Scientifically Grounded (Critical):** The problem is based on the well-established Eulerian–Eulerian two-fluid model, a standard framework in multiphase CFD. The momentum equations and the interphase drag formulation are rooted in fundamental conservation laws and classical mechanics. The analysis of numerical stability for stiff source terms like drag is a standard and critical topic in computational science. The physical parameters are realistic for an air-water system.\n-   **Well-Posed:** The problem is clearly defined with sufficient and consistent data ($\\alpha_{g} + \\alpha_{\\ell} = 0.10 + 0.90 = 1.0$). The simplifications lead to a solvable system of linear ordinary differential equations, for which a unique stability bound can be determined for the specified numerical scheme.\n-   **Objective (Critical):** The problem is stated in precise, quantitative, and unbiased technical language. It is free of any subjective or opinion-based content.\n\n**Step 3: Verdict and Action**\n\nThe problem is valid as it is scientifically sound, well-posed, and objective. A complete solution will be provided.\n\n### Solution\n\nThe starting point is the phase momentum balance equation for each phase $k$ (where $k$ can be gas $g$ or liquid $\\ell$), simplified according to the problem statement. By neglecting convective, pressure-gradient, and viscous terms, the momentum equation per unit volume for phase $k$ reduces to:\n$$\n\\frac{\\partial}{\\partial t}(\\alpha_{k} \\rho_{k} \\mathbf{u}_{k}) = \\mathbf{M}_{k}\n$$\nwhere $\\alpha_{k}$ is the volume fraction, $\\rho_{k}$ is the density, $\\mathbf{u}_{k}$ is the velocity of phase $k$, and $\\mathbf{M}_{k}$ is the interphase momentum transfer term (drag). Since the properties $\\alpha_{k}$ and $\\rho_{k}$ are constant within the cell over the time step, we can write:\n$$\n\\alpha_{k} \\rho_{k} \\frac{d\\mathbf{u}_{k}}{dt} = \\mathbf{M}_{k}\n$$\nThe interphase momentum transfer is due to drag, and by Newton's Third Law, $\\mathbf{M}_{g} = -\\mathbf{M}_{\\ell}$. The drag force exerted on the gas phase by the liquid phase is given by:\n$$\n\\mathbf{M}_{g} = K (\\mathbf{u}_{\\ell} - \\mathbf{u}_{g})\n$$\nConsequently, the drag force on the liquid phase is:\n$$\n\\mathbf{M}_{\\ell} = K (\\mathbf{u}_{g} - \\mathbf{u}_{\\ell})\n$$\nwhere $K$ is the interphase momentum exchange coefficient.\n\nSubstituting these drag terms into the simplified momentum equations for the gas ($g$) and liquid ($\\ell$) phases, we get:\n$$\n\\alpha_{g} \\rho_{g} \\frac{d\\mathbf{u}_{g}}{dt} = K (\\mathbf{u}_{\\ell} - \\mathbf{u}_{g})\n$$\n$$\n\\alpha_{\\ell} \\rho_{\\ell} \\frac{d\\mathbf{u}_{\\ell}}{dt} = K (\\mathbf{u}_{g} - \\mathbf{u}_{\\ell})\n$$\nThe coupling between velocity components is linear and isotropic, so we can analyze a single velocity component (e.g., in the $x$-direction) without loss of generality. Let $u_g$ and $u_\\ell$ be these components. The system of ordinary differential equations (ODEs) becomes:\n$$\n\\frac{du_{g}}{dt} = \\frac{K}{\\alpha_{g} \\rho_{g}} (u_{\\ell} - u_{g})\n$$\n$$\n\\frac{du_{\\ell}}{dt} = \\frac{K}{\\alpha_{\\ell} \\rho_{\\ell}} (u_{g} - u_{\\ell})\n$$\nThis system can be written in matrix form $\\frac{d\\mathbf{u}}{dt} = \\mathbf{J}\\mathbf{u}$, where $\\mathbf{u} = \\begin{pmatrix} u_g \\\\ u_\\ell \\end{pmatrix}$:\n$$\n\\frac{d}{dt} \\begin{pmatrix} u_g \\\\ u_\\ell \\end{pmatrix} = \n\\begin{pmatrix} \n-\\frac{K}{\\alpha_{g} \\rho_{g}} & \\frac{K}{\\alpha_{g} \\rho_{g}} \\\\\n\\frac{K}{\\alpha_{\\ell} \\rho_{\\ell}} & -\\frac{K}{\\alpha_{\\ell} \\rho_{\\ell}}\n\\end{pmatrix}\n\\begin{pmatrix} u_g \\\\ u_\\ell \\end{pmatrix}\n$$\nThe matrix $\\mathbf{J}$ is the linearized operator for the drag-coupled velocity dynamics:\n$$\n\\mathbf{J} = \\begin{pmatrix} \n-C_g & C_g \\\\\nC_\\ell & -C_\\ell\n\\end{pmatrix}\n$$\nwhere we define the inverse relaxation times $C_g = \\frac{K}{\\alpha_{g} \\rho_{g}}$ and $C_\\ell = \\frac{K}{\\alpha_{\\ell} \\rho_{\\ell}}$.\n\nNext, we determine the eigenvalues $\\lambda$ of the operator $\\mathbf{J}$ by solving the characteristic equation $\\det(\\mathbf{J} - \\lambda \\mathbf{I}) = 0$:\n$$\n\\det \\begin{pmatrix} \n-C_g - \\lambda & C_g \\\\\nC_\\ell & -C_\\ell - \\lambda\n\\end{pmatrix} = 0\n$$\n$$\n(-C_g - \\lambda)(-C_\\ell - \\lambda) - (C_g)(C_\\ell) = 0\n$$\n$$\nC_g C_\\ell + C_g \\lambda + C_\\ell \\lambda + \\lambda^2 - C_g C_\\ell = 0\n$$\n$$\n\\lambda^2 + (C_g + C_\\ell)\\lambda = 0\n$$\n$$\n\\lambda(\\lambda + C_g + C_\\ell) = 0\n$$\nThe eigenvalues are:\n$$\n\\lambda_1 = 0\n$$\n$$\n\\lambda_2 = -(C_g + C_\\ell)\n$$\nThe eigenvalue $\\lambda_1 = 0$ corresponds to the conservation of total momentum in the closed system. The eigenvalue $\\lambda_2$ governs the exponential relaxation of the velocity slip towards a common velocity.\n\nFor an explicit Forward Euler discretization of an ODE system $\\frac{d\\mathbf{u}}{dt} = \\mathbf{J}\\mathbf{u}$, the scheme is $\\mathbf{u}^{n+1} = \\mathbf{u}^{n} + \\Delta t \\mathbf{J} \\mathbf{u}^{n} = (\\mathbf{I} + \\Delta t \\mathbf{J})\\mathbf{u}^{n}$. The condition for numerical stability is that all eigenvalues of the amplification matrix $(\\mathbf{I} + \\Delta t \\mathbf{J})$ must have a magnitude less than or equal to $1$. The eigenvalues of this matrix are $1 + \\Delta t \\lambda_k$, where $\\lambda_k$ are the eigenvalues of $\\mathbf{J}$.\nFor $\\lambda_1 = 0$, the condition is $|1 + \\Delta t \\cdot 0| = 1 \\le 1$, which is always met.\nFor $\\lambda_2 = -(C_g + C_\\ell)$, the condition is $|1 + \\Delta t \\lambda_2| \\le 1$:\n$$\n|1 - \\Delta t (C_g + C_\\ell)| \\le 1\n$$\nSince $\\Delta t$, $C_g$, and $C_\\ell$ are all positive, this expands to:\n$$\n-1 \\le 1 - \\Delta t (C_g + C_\\ell) \\le 1\n$$\nThe right-hand side inequality, $1 - \\Delta t(C_g + C_\\ell) \\le 1$, implies $-\\Delta t(C_g + C_\\ell) \\le 0$, which is always true.\nThe left-hand side inequality gives the stability limit:\n$$\n-1 \\le 1 - \\Delta t (C_g + C_\\ell)\n$$\n$$\n\\Delta t (C_g + C_\\ell) \\le 2\n$$\n$$\n\\Delta t \\le \\frac{2}{C_g + C_\\ell}\n$$\nThe spectral radius of the operator is $\\rho(\\mathbf{J}) = \\max(|\\lambda_1|, |\\lambda_2|) = |-(C_g + C_\\ell)| = C_g + C_\\ell$. Thus, the largest stable time step, $\\Delta t_{\\max}$, is:\n$$\n\\Delta t_{\\max} = \\frac{2}{C_g + C_\\ell} = \\frac{2}{\\frac{K}{\\alpha_{g} \\rho_{g}} + \\frac{K}{\\alpha_{\\ell} \\rho_{\\ell}}}\n$$\nNow, we substitute the given numerical values:\n$\\rho_{g} = 1.2$ $\\mathrm{kg/m^{3}}$, $\\alpha_{g} = 0.10$, so $\\alpha_{g} \\rho_{g} = 0.10 \\times 1.2 = 0.12$ $\\mathrm{kg/m^{3}}$.\n$\\rho_{\\ell} = 1000$ $\\mathrm{kg/m^{3}}$, $\\alpha_{\\ell} = 0.90$, so $\\alpha_{\\ell} \\rho_{\\ell} = 0.90 \\times 1000 = 900$ $\\mathrm{kg/m^{3}}$.\n$K = 150$ $\\mathrm{kg/(m^{3}\\,s)}$.\n\nWe compute $C_g$ and $C_\\ell$:\n$$\nC_g = \\frac{150}{0.12} = 1250 \\text{ s}^{-1}\n$$\n$$\nC_\\ell = \\frac{150}{900} = \\frac{1}{6} \\text{ s}^{-1}\n$$\nThe sum is:\n$$\nC_g + C_\\ell = 1250 + \\frac{1}{6} = \\frac{7500}{6} + \\frac{1}{6} = \\frac{7501}{6} \\text{ s}^{-1}\n$$\nThe maximum stable time step is:\n$$\n\\Delta t_{\\max} = \\frac{2}{C_g + C_\\ell} = \\frac{2}{7501/6} = \\frac{12}{7501} \\text{ s}\n$$\nFinally, we compute the numerical value and round to four significant figures:\n$$\n\\Delta t_{\\max} = \\frac{12}{7501} \\approx 0.0015997867 \\text{ s}\n$$\nRounding to four significant figures, we get $0.001600$ s.",
            "answer": "$$\\boxed{0.001600}$$"
        },
        {
            "introduction": "In many practical applications, such as stratified flows or bubbly columns, the system is dominated by a near-hydrostatic balance between pressure gradients and gravity. A naive discretization can fail to preserve this delicate equilibrium, generating spurious numerical artifacts that corrupt the solution. This practice  challenges you to compare two different finite-volume schemes and discover the principles of a \"well-balanced\" discretization that can maintain hydrostatic conditions to machine precision. Understanding this concept is key to accurately simulating gravity-dominated multiphase systems.",
            "id": "3315457",
            "problem": "Consider a one-dimensional, vertical, Eulerian–Eulerian (EE) two-fluid formulation in Computational Fluid Dynamics (CFD) with two immiscible phases indexed by $k \\in \\{1,2\\}$, occupying volume fractions $\\alpha_k(z,t)$ with $\\alpha_1 + \\alpha_2 = 1$, phasic densities $\\rho_k$ (constant in space and time for each phase), phasic pressures $p_k(z,t)$ (not necessarily equal between phases), and phasic velocities $v_k(z,t)$. Let the vertical coordinate $z$ increase downward from the top boundary $z=0$, and let the gravitational acceleration vector be $\\mathbf{g} = g \\mathbf{e}_z$ with $g>0$ and $\\mathbf{e}_z$ the unit vector in the $+z$ direction. Assume no interfacial momentum exchange and neglect advection and viscous terms so that the $k$-th phasic momentum equation reduces to the source–pressure balance\n$$\n\\frac{\\partial}{\\partial t}\\big(\\alpha_k \\rho_k v_k\\big) = - \\alpha_k \\frac{\\partial p_k}{\\partial z} + \\alpha_k \\rho_k g.\n$$\nA hydrostatic equilibrium for each phase is defined by\n$$\n\\frac{\\partial p_k}{\\partial z} = \\rho_k g, \\quad v_k = 0,\n$$\nwhich must hold for arbitrary $\\alpha_k(z)$ (subject to $0 \\le \\alpha_k \\le 1$ and $\\alpha_1+\\alpha_2=1$). You must construct a finite-volume discretization on a uniform grid that is well-balanced, meaning it exactly preserves the hydrostatic steady state for each phase to machine precision for arbitrary $\\alpha_k(z)$, while being able to handle small perturbations in $\\alpha_k$ without generating spurious velocities.\n\nStarting from the fundamental balance laws above and the hydrostatic relation, derive a consistent semi-discrete scheme on a uniform grid of $N$ cells with spacing $\\Delta z$ that uses second-order centered differences for spatial derivatives. Consider two alternative discretizations of the pressure–source terms at cell centers indexed by $i$:\n\n- A “conservative-like” centered form that approximates the divergence of $\\alpha_k p_k$,\n$$\nR^{\\mathrm{C}}_{k,i} = - \\frac{\\big(\\alpha_{k,i+1} p_{k,i+1} - \\alpha_{k,i-1} p_{k,i-1}\\big)}{2 \\Delta z} + \\alpha_{k,i} \\rho_k g,\n$$\n- A “well-balanced split” centered form that multiplies the discrete pressure gradient by $\\alpha_k$,\n$$\nR^{\\mathrm{WB}}_{k,i} = - \\alpha_{k,i} \\frac{\\big(p_{k,i+1} - p_{k,i-1}\\big)}{2 \\Delta z} + \\alpha_{k,i} \\rho_k g.\n$$\n\nHere $R_{k,i}$ denotes the discrete residual (net source term per unit volume) of the $k$-th phasic momentum equation at cell $i$. The hydrostatic pressure profile is defined by integrating the hydrostatic equation from a specified top boundary value $p_{k,0}$ at $z=0$:\n$$\np_k(z) = p_{k,0} + \\rho_k g z.\n$$\n\nDefine the explicit Euler time update of the phasic velocity $v_{k,i}$ in each cell by\n$$\nv_{k,i}^{n+1} = v_{k,i}^n + \\Delta t \\, \\frac{R_{k,i}}{\\alpha_{k,i} \\rho_k},\n$$\nwhere $\\Delta t$ is the time step. To avoid division by zero when $\\alpha_{k,i}$ is extremely small, use a minimum clipping $\\alpha_{k,i} \\leftarrow \\max(\\alpha_{k,i}, \\alpha_{\\min})$ with $\\alpha_{\\min} = 10^{-6}$ for the purpose of computing the velocity update.\n\nYour program must implement both $R^{\\mathrm{C}}_{k,i}$ and $R^{\\mathrm{WB}}_{k,i}$ and evaluate, for each scheme and each phase, the following quantitative diagnostics on the interior cells $i=1,\\dots,N-2$:\n\n- The discrete $L^2$ norm of the residual,\n$$\n\\|R\\|_2 = \\sqrt{ \\frac{1}{N-2} \\sum_{i=1}^{N-2} R_{k,i}^2 },\n$$\nexpressed in Newton per cubic meter (N/m$^3$).\n- The maximum absolute one-step velocity update magnitude,\n$$\nU_{\\max} = \\max_{1 \\le i \\le N-2} \\left| \\Delta t \\, \\frac{R_{k,i}}{\\alpha_{k,i} \\rho_k} \\right|,\n$$\nexpressed in meters per second (m/s).\n\nUse the following test suite, where all quantities must be interpreted in the International System of Units (SI). For each test, define the grid $z_i = i \\, \\Delta z$ for $i=0,\\dots,N-1$, set $p_{k,i} = p_{k,0} + \\rho_k g z_i$, set $\\alpha_1$ as specified, then set $\\alpha_2 = 1 - \\alpha_1$. In tests with a perturbation, define $\\alpha_1 \\leftarrow \\mathrm{clip}\\big(\\alpha_1 + \\delta \\alpha, \\alpha_{\\min}, 1 - \\alpha_{\\min}\\big)$ where $\\delta \\alpha$ is given.\n\n- Test $1$ (smooth nonuniform $\\alpha_1$ with small perturbation):\n  - $N = 50$, $\\Delta z = 0.1$ m, $\\Delta t = 10^{-3}$ s, $g = 9.81$ m/s$^2$.\n  - $\\rho_1 = 1000$ kg/m$^3$, $\\rho_2 = 1.2$ kg/m$^3$.\n  - $p_{1,0} = 10^5$ Pa, $p_{2,0} = 10^5$ Pa.\n  - Let $H = N \\Delta z$, $z_{\\mathrm{mid}} = H/2$, and $L = 1.0$ m.\n  - Base profile: $\\alpha_1(z) = 0.5 + 0.4 \\tanh\\!\\big((z - z_{\\mathrm{mid}})/L\\big)$.\n  - Perturbation: $\\delta \\alpha(z) = 10^{-6} \\sin\\!\\big(2 \\pi z / H\\big)$.\n\n- Test $2$ (uniform $\\alpha_1$; boundary case with zero gradient):\n  - $N = 64$, $\\Delta z = 0.05$ m, $\\Delta t = 10^{-3}$ s, $g = 9.81$ m/s$^2$.\n  - $\\rho_1 = 1000$ kg/m$^3$, $\\rho_2 = 1.2$ kg/m$^3$.\n  - $p_{1,0} = 10^5$ Pa, $p_{2,0} = 10^5$ Pa.\n  - Base profile: $\\alpha_1(z) = 0.3$ for all $z$.\n  - Perturbation: none, i.e., $\\delta \\alpha(z) = 0$.\n\n- Test $3$ (coarse grid with discontinuous $\\alpha_1$ step; edge case):\n  - $N = 4$, $\\Delta z = 0.5$ m, $\\Delta t = 10^{-3}$ s, $g = 9.81$ m/s$^2$.\n  - $\\rho_1 = 500$ kg/m$^3$, $\\rho_2 = 1500$ kg/m$^3$.\n  - $p_{1,0} = 10^5$ Pa, $p_{2,0} = 10^5$ Pa.\n  - Base profile: $\\alpha_1(z) = 0.9$ for $z < H/2$ and $\\alpha_1(z) = 0.1$ for $z \\ge H/2$, where $H = N \\Delta z$.\n  - Perturbation: none, i.e., $\\delta \\alpha(z) = 0$.\n\nFor each test and each phase $k$, compute the four diagnostics: the $L^2$ residual norm for the conservative-like scheme $\\|R^{\\mathrm{C}}\\|_2$, the $L^2$ residual norm for the well-balanced split scheme $\\|R^{\\mathrm{WB}}\\|_2$, the maximum absolute one-step velocity update $U^{\\mathrm{C}}_{\\max}$ for the conservative-like scheme, and the same $U^{\\mathrm{WB}}_{\\max}$ for the well-balanced split scheme.\n\nFinal output format requirement: Your program should produce a single line of output containing all results as a comma-separated list enclosed in square brackets, in the following order and units: for Test $1$ Phase $1$ output $\\|R^{\\mathrm{C}}\\|_2$ (N/m$^3$), $\\|R^{\\mathrm{WB}}\\|_2$ (N/m$^3$), $U^{\\mathrm{C}}_{\\max}$ (m/s), $U^{\\mathrm{WB}}_{\\max}$ (m/s); then Test $1$ Phase $2$ in the same order; then Test $2$ Phase $1$, Test $2$ Phase $2$, Test $3$ Phase $1$, and Test $3$ Phase $2$. All values must be printed as floating-point numbers in SI units, with no additional text. Example structure (not actual values): \"[rC11,rWB11,uC11,uWB11,rC12,rWB12,uC12,uWB12,rC21, ...]\".",
            "solution": "The problem requires the analysis and implementation of two finite-volume discretization schemes for a simplified one-dimensional, two-fluid momentum equation under hydrostatic conditions. The core task is to evaluate the \"well-balanced\" property of these schemes, which is the ability of a numerical method to exactly preserve a known physical equilibrium state to machine precision. In this context, the equilibrium state is hydrostatic balance, where pressure gradients perfectly counteract gravity, resulting in zero fluid velocity.\n\nFirst, we analyze the two proposed discretizations for the source-pressure term in the phasic momentum equation. The simplified momentum balance for phase $k$ is given by\n$$\n\\frac{\\partial}{\\partial t}\\big(\\alpha_k \\rho_k v_k\\big) = - \\alpha_k \\frac{\\partial p_k}{\\partial z} + \\alpha_k \\rho_k g.\n$$\nA hydrostatic equilibrium is defined by the conditions $v_k = 0$ and $\\frac{\\partial p_k}{\\partial z} = \\rho_k g$, which must hold for any arbitrary, spatially varying volume fraction profile $\\alpha_k(z)$. For a system in hydrostatic equilibrium, the right-hand side (RHS) of the momentum equation must be zero. Substituting the hydrostatic pressure relation into the RHS yields\n$$\nRHS = - \\alpha_k (\\rho_k g) + \\alpha_k \\rho_k g = 0.\n$$\nA well-balanced numerical scheme must replicate this cancellation at the discrete level, ensuring that the computed residual is zero to machine precision for a discrete hydrostatic state.\n\nThe problem specifies a discrete hydrostatic pressure profile on a uniform grid with spacing $\\Delta z$ and cell centers $z_i = i \\Delta z$. The pressure at cell $i$ is $p_{k,i} = p_{k,0} + \\rho_k g z_i$. For this profile, the second-order centered difference approximation of the pressure gradient is exact:\n$$\n\\frac{p_{k,i+1} - p_{k,i-1}}{2 \\Delta z} = \\frac{(p_{k,0} + \\rho_k g z_{i+1}) - (p_{k,0} + \\rho_k g z_{i-1})}{2 \\Delta z} = \\frac{\\rho_k g (z_{i+1} - z_{i-1})}{2 \\Delta z} = \\frac{\\rho_k g (2 \\Delta z)}{2 \\Delta z} = \\rho_k g.\n$$\n\nNow, we examine the two proposed discrete residuals, $R^{\\mathrm{C}}_{k,i}$ and $R^{\\mathrm{WB}}_{k,i}$, at the interior cells $i=1, \\dots, N-2$.\n\nThe \"well-balanced split\" form is given by:\n$$\nR^{\\mathrm{WB}}_{k,i} = - \\alpha_{k,i} \\frac{p_{k,i+1} - p_{k,i-1}}{2 \\Delta z} + \\alpha_{k,i} \\rho_k g.\n$$\nSubstituting the exact discrete pressure gradient, we find:\n$$\nR^{\\mathrm{WB}}_{k,i} = - \\alpha_{k,i} (\\rho_k g) + \\alpha_{k,i} \\rho_k g = 0.\n$$\nThis demonstrates that the residual for the \"well-balanced split\" scheme is analytically zero for any volume fraction profile $\\alpha_{k,i}$, as long as the pressure is hydrostatic. This scheme is therefore well-balanced. We expect computations using this scheme to yield residuals and velocity updates that are zero up to floating-point representation error.\n\nThe \"conservative-like\" form is given by:\n$$\nR^{\\mathrm{C}}_{k,i} = - \\frac{\\alpha_{k,i+1} p_{k,i+1} - \\alpha_{k,i-1} p_{k,i-1}}{2 \\Delta z} + \\alpha_{k,i} \\rho_k g.\n$$\nThis form discretizes the term $-\\frac{\\partial (\\alpha_k p_k)}{\\partial z}$ but does not correctly represent the full source term $-\\alpha_k \\frac{\\partial p_k}{\\partial z}$. Using the product rule, the continuous source term is equivalent to $-\\frac{\\partial (\\alpha_k p_k)}{\\partial z} + p_k \\frac{\\partial \\alpha_k}{\\partial z}$. The \"conservative-like\" form omits the discretization of the term $p_k \\frac{\\partial \\alpha_k}{\\partial z}$. Let's analyze its behavior under hydrostatic conditions. Substituting $p_{k,i} = p_{k,0} + \\rho_k g z_i$:\n$$\nR^{\\mathrm{C}}_{k,i} = - \\frac{\\alpha_{k,i+1}(p_{k,0} + \\rho_k g z_{i+1}) - \\alpha_{k,i-1}(p_{k,0} + \\rho_k g z_{i-1})}{2 \\Delta z} + \\alpha_{k,i} \\rho_k g.\n$$\nRearranging the terms:\n$$\nR^{\\mathrm{C}}_{k,i} = - p_{k,0} \\frac{\\alpha_{k,i+1} - \\alpha_{k,i-1}}{2 \\Delta z} - \\rho_k g \\frac{\\alpha_{k,i+1} z_{i+1} - \\alpha_{k,i-1} z_{i-1}}{2 \\Delta z} + \\alpha_{k,i} \\rho_k g.\n$$\nThe first term is a discrete approximation of $-p_{k,0} \\frac{\\partial \\alpha_k}{\\partial z}$. The second term approximates $-\\rho_k g \\frac{\\partial (\\alpha_k z)}{\\partial z} = -\\rho_k g (\\alpha_k + z \\frac{\\partial \\alpha_k}{\\partial z})$. The resulting expression does not generally cancel to zero unless $\\alpha_k$ is constant, in which case $\\alpha_{k,i+1} = \\alpha_{k,i-1} = \\alpha_{k,i}$, and the expression reduces to the well-balanced form. When $\\alpha_k$ is not constant, this scheme will produce a non-zero residual, a numerical artifact that can generate spurious velocities from a state of rest.\n\nThe implementation will proceed by defining a function to execute a single test case. This function will:\n1.  Construct the one-dimensional grid $z_i$.\n2.  Compute the volume fraction arrays $\\alpha_{1,i}$ and $\\alpha_{2,i}$ according to the test case specification, applying perturbations and clipping where required.\n3.  For each phase $k \\in \\{1,2\\}$, compute the discrete hydrostatic pressure array $p_{k,i}$.\n4.  Calculate the residuals $R^{\\mathrm{C}}_{k,i}$ and $R^{\\mathrm{WB}}_{k,i}$ for all interior cells ($i=1, \\dots, N-2$) using vectorized NumPy operations that correspond to the specified finite difference formulas.\n5.  Compute the two required diagnostics: the discrete $L^2$ norm of the residual, $\\|R\\|_2$, and the maximum absolute one-step velocity update, $U_{\\max}$, for each scheme. The velocity update calculation will use a clipped volume fraction $\\max(\\alpha_{k,i}, 10^{-6})$ in the denominator to ensure stability.\nThe main program will iterate through the three specified test cases, call this function, and collate the results into a single list for the final output. Based on our analysis, we expect the diagnostics for the $R^{\\mathrm{WB}}$ scheme to be near zero for all tests. For the $R^{\\mathrm{C}}$ scheme, we expect near-zero diagnostics for Test 2 (constant $\\alpha_k$) but non-zero diagnostics for Test 1 (smoothly varying $\\alpha_k$) and Test 3 (discontinuous $\\alpha_k$).",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef run_test(N, dz, dt, g, rho1, rho2, p1_0, p2_0, alpha1_func, d_alpha_func=None):\n    \"\"\"\n    Runs a single test case for the well-balanced scheme problem.\n\n    Args:\n        N (int): Number of grid cells.\n        dz (float): Grid spacing.\n        dt (float): Time step.\n        g (float): Gravitational acceleration.\n        rho1 (float): Density of phase 1.\n        rho2 (float): Density of phase 2.\n        p1_0 (float): Pressure of phase 1 at z=0.\n        p2_0 (float): Pressure of phase 2 at z=0.\n        alpha1_func (callable): Function to compute the base alpha1 profile.\n        d_alpha_func (callable, optional): Function for alpha perturbation.\n\n    Returns:\n        list: A list of 8 floating-point numbers representing the diagnostics\n              (R^C_norm, R^WB_norm, U^C_max, U^WB_max) for phase 1, then phase 2.\n    \"\"\"\n    alpha_min = 1e-6\n    \n    # 1. Grid and volume fraction setup\n    z = np.arange(N) * dz\n    \n    alpha1 = alpha1_func(z, N, dz)\n    if d_alpha_func:\n        delta_alpha = d_alpha_func(z, N, dz)\n        alpha1 = np.clip(alpha1 + delta_alpha, alpha_min, 1 - alpha_min)\n        \n    alpha2 = 1.0 - alpha1\n    \n    alphas = {1: alpha1, 2: alpha2}\n    rhos = {1: rho1, 2: rho2}\n    p0s = {1: p1_0, 2: p2_0}\n    \n    results_for_test = []\n    \n    # 2. Loop over phases\n    for k in [1, 2]:\n        rho_k = rhos[k]\n        p_k0 = p0s[k]\n        alpha_k = alphas[k]\n        \n        # 3. Hydrostatic pressure profile\n        p_k = p_k0 + rho_k * g * z\n        \n        # Slicing for interior cells i=1,...,N-2:\n        # i   -> [1:-1]\n        # i+1 -> [2:]\n        # i-1 -> [:-2]\n        num_interior_cells = N - 2\n        \n        if num_interior_cells = 0:\n            results_for_test.extend([0.0, 0.0, 0.0, 0.0])\n            continue\n\n        # 4. Calculate residuals\n        # Conservative-like residual R^C\n        term1_C = -(alpha_k[2:] * p_k[2:] - alpha_k[:-2] * p_k[:-2]) / (2 * dz)\n        term2_C = alpha_k[1:-1] * rho_k * g\n        R_C = term1_C + term2_C\n        \n        # Well-balanced residual R^WB\n        term1_WB = -alpha_k[1:-1] * (p_k[2:] - p_k[:-2]) / (2 * dz)\n        term2_WB = alpha_k[1:-1] * rho_k * g\n        R_WB = term1_WB + term2_WB\n        \n        # 5. Calculate diagnostics\n        # L2 norm of residuals\n        norm_R_C = np.sqrt(np.mean(R_C**2))\n        norm_R_WB = np.sqrt(np.mean(R_WB**2))\n\n        # Max velocity update\n        # Denominator alpha for velocity update is clipped to alpha_min\n        alpha_k_denom = np.maximum(alpha_k[1:-1], alpha_min)\n        \n        # Check for division by zero in case rho_k is zero\n        if rho_k == 0:\n             U_max_C = 0.0\n             U_max_WB = 0.0\n        else:\n             U_max_C = np.max(np.abs(dt * R_C / (alpha_k_denom * rho_k)))\n             U_max_WB = np.max(np.abs(dt * R_WB / (alpha_k_denom * rho_k)))\n            \n        results_for_test.extend([norm_R_C, norm_R_WB, U_max_C, U_max_WB])\n        \n    return results_for_test\n\ndef solve():\n    \"\"\"\n    Main solver function to run all test cases and print results.\n    \"\"\"\n    test_cases = [\n        # Test 1: smooth nonuniform alpha1 with small perturbation\n        {\n            'N': 50, 'dz': 0.1, 'dt': 1e-3, 'g': 9.81,\n            'rho1': 1000.0, 'rho2': 1.2,\n            'p1_0': 1e5, 'p2_0': 1e5,\n            'alpha1_func': lambda z, N, dz: 0.5 + 0.4 * np.tanh((z - (N * dz) / 2) / 1.0),\n            'd_alpha_func': lambda z, N, dz: 1e-6 * np.sin(2 * np.pi * z / (N * dz))\n        },\n        # Test 2: uniform alpha1\n        {\n            'N': 64, 'dz': 0.05, 'dt': 1e-3, 'g': 9.81,\n            'rho1': 1000.0, 'rho2': 1.2,\n            'p1_0': 1e5, 'p2_0': 1e5,\n            'alpha1_func': lambda z, N, dz: 0.3 * np.ones_like(z),\n            'd_alpha_func': None\n        },\n        # Test 3: coarse grid with discontinuous alpha1 step\n        {\n            'N': 4, 'dz': 0.5, 'dt': 1e-3, 'g': 9.81,\n            'rho1': 500.0, 'rho2': 1500.0,\n            'p1_0': 1e5, 'p2_0': 1e5,\n            'alpha1_func': lambda z, N, dz: np.where(z  (N * dz) / 2, 0.9, 0.1),\n            'd_alpha_func': None\n        }\n    ]\n\n    all_results = []\n    for params in test_cases:\n        test_results = run_test(**params)\n        all_results.extend(test_results)\n\n    print(f\"[{','.join(map(str, all_results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "A robust numerical scheme must not only be stable but must also guarantee that the solution remains physically admissible at all times. In compressible two-fluid models, explicit updates can easily lead to unphysical states like negative densities or volume fractions outside the $[0, 1]$ range, especially near shocks or interfaces. This exercise  introduces the concept of a positivity-preserving limiter, a technique that scales the update to enforce these physical constraints. By deriving and implementing this limiter, you will gain hands-on experience with a crucial tool for ensuring the robustness of modern CFD solvers.",
            "id": "3315467",
            "problem": "Consider a one-dimensional, finite-volume explicit update for a compressible gas–liquid mixture modeled by an Eulerian–Eulerian two-fluid formulation in Computational Fluid Dynamics (CFD). For each phase $k\\in\\{g,\\ell\\}$, the phase mass per unit volume is $m_k=\\alpha_k\\rho_k$, where $\\alpha_k$ is the phase volume fraction and $\\rho_k$ the phase density. The explicit update over one time step can be written as a forward Euler step on the conservative variables,\n$$\nm_k^{\\star} \\equiv m_k^{n} + \\Delta m_k, \\quad \\alpha_g^{\\star} \\equiv \\alpha_g^{n} + \\Delta \\alpha_g,\n$$\nwhere $m_k^{n}$ and $\\alpha_g^{n}$ denote the old state, $m_k^{\\star}$ and $\\alpha_g^{\\star}$ the pre-limited new state, and $\\Delta m_k,\\Delta \\alpha_g$ denote the total explicit increment from numerical fluxes and sources (including stiff relaxation). The liquid volume fraction is $\\alpha_{\\ell}=1-\\alpha_g$. The fundamental base is the conservation of phase mass,\n$$\n\\partial_t(\\alpha_k\\rho_k) + \\partial_x(\\alpha_k\\rho_ku_k) = S_{m,k},\n$$\nwith $S_{m,k}$ representing interfacial mass exchange. In an explicit scheme, large fluxes under strong shocks or stiff sources may yield $m_k^{\\star}\\le 0$ or $\\alpha_k^{\\star}\\notin[0,1]$, which is inadmissible. The admissible set is defined by\n$$\n\\mathcal{A}=\\left\\{(\\alpha_g,\\alpha_{\\ell},m_g,m_{\\ell}) \\,\\middle|\\, \\epsilon_{\\alpha}\\le \\alpha_g \\le 1-\\epsilon_{\\alpha},\\ \\alpha_{\\ell}=1-\\alpha_g,\\ m_g\\ge \\epsilon_{m},\\ m_{\\ell}\\ge \\epsilon_{m}\\right\\},\n$$\nwith small floors $\\epsilon_{\\alpha}0$ and $\\epsilon_{m}0$ chosen to avoid division by zero and preserve strict positivity. Densities are recovered from $m_k$ and $\\alpha_k$ via\n$$\n\\rho_k = \\frac{m_k}{\\alpha_k}.\n$$\nYour task is to derive, from the convexity of $\\mathcal{A}$ and the explicit update structure, a single scalar positivity-preserving limiter that constructs a limited update\n$$\nm_k^{n+1} = m_k^{n} + \\theta\\,\\Delta m_k,\\quad \\alpha_g^{n+1} = \\alpha_g^{n} + \\theta\\,\\Delta \\alpha_g,\\quad \\alpha_{\\ell}^{n+1}=1-\\alpha_g^{n+1},\n$$\nwith a scaling factor $0\\le \\theta \\le 1$ such that the limited state lies in $\\mathcal{A}$ and yields strictly positive densities $\\rho_k^{n+1}0$. Starting from the fundamental mass balance and the definition of $\\mathcal{A}$ as a convex constraint set, derive the conditions on $\\theta$ that enforce simultaneously:\n- the lower mass bounds $m_k^{n+1}\\ge \\epsilon_{m}$ for $k\\in\\{g,\\ell\\}$,\n- the lower and upper volume-fraction bounds $\\epsilon_{\\alpha}\\le \\alpha_g^{n+1}\\le 1-\\epsilon_{\\alpha}$,\nand prove that the choice\n$$\n\\theta=\\min\\Big(1,\\ \\theta_{m,g},\\ \\theta_{m,\\ell},\\ \\theta_{\\alpha,\\mathrm{low}},\\ \\theta_{\\alpha,\\mathrm{up}}\\Big)\n$$\nwith appropriately defined constraint-specific scalings $\\theta_{(\\cdot)}\\in[0,1]$ guarantees $m_k^{n+1}\\ge \\epsilon_{m}$ and $\\epsilon_{\\alpha}\\le \\alpha_g^{n+1}\\le 1-\\epsilon_{\\alpha}$, and thus $\\rho_k^{n+1}0$.\n\nThen, implement the derived limiter in a program that, for a given set of test cases, computes the limited update and returns the post-limited $(\\theta,\\alpha_g^{n+1},\\alpha_{\\ell}^{n+1},\\rho_g^{n+1},\\rho_{\\ell}^{n+1})$ and a boolean indicating whether all constraints are satisfied. Use the following physically plausible test suite that stresses different facets of the limiter. Densities must be expressed in $\\mathrm{kg/m^3}$:\n\n- Test case $1$ (happy path, moderate update):\n  - $\\alpha_g^{n}=0.4$, $\\rho_g^{n}=5\\,\\mathrm{kg/m^3}$, $\\rho_{\\ell}^{n}=950\\,\\mathrm{kg/m^3}$,\n  - $\\Delta \\alpha_g=-0.02$, $\\Delta m_g=-0.1\\,\\mathrm{kg/m^3}$, $\\Delta m_{\\ell}=+0.1\\,\\mathrm{kg/m^3}$.\n\n- Test case $2$ (strong shock, gas mass goes negative without limiting):\n  - $\\alpha_g^{n}=0.3$, $\\rho_g^{n}=8\\,\\mathrm{kg/m^3}$, $\\rho_{\\ell}^{n}=1000\\,\\mathrm{kg/m^3}$,\n  - $\\Delta \\alpha_g=-0.05$, $\\Delta m_g=-3.0\\,\\mathrm{kg/m^3}$, $\\Delta m_{\\ell}=+2.0\\,\\mathrm{kg/m^3}$.\n\n- Test case $3$ (stiff relaxation, volume fraction overshoot above unity):\n  - $\\alpha_g^{n}=0.5$, $\\rho_g^{n}=2\\,\\mathrm{kg/m^3}$, $\\rho_{\\ell}^{n}=900\\,\\mathrm{kg/m^3}$,\n  - $\\Delta \\alpha_g=+0.8$, $\\Delta m_g=+0.1\\,\\mathrm{kg/m^3}$, $\\Delta m_{\\ell}=-0.1\\,\\mathrm{kg/m^3}$.\n\n- Test case $4$ (near-vacuum gas fraction, potential underflow):\n  - $\\alpha_g^{n}=10^{-6}$, $\\rho_g^{n}=0.8\\,\\mathrm{kg/m^3}$, $\\rho_{\\ell}^{n}=1000\\,\\mathrm{kg/m^3}$,\n  - $\\Delta \\alpha_g=-10^{-3}$, $\\Delta m_g=-10^{-5}\\,\\mathrm{kg/m^3}$, $\\Delta m_{\\ell}=+10^{-2}\\,\\mathrm{kg/m^3}$.\n\n- Test case $5$ (almost pure liquid, upper bound on gas fraction violated without limiting):\n  - $\\alpha_g^{n}=1-10^{-9}$, $\\rho_g^{n}=10\\,\\mathrm{kg/m^3}$, $\\rho_{\\ell}^{n}=1000\\,\\mathrm{kg/m^3}$,\n  - $\\Delta \\alpha_g=+0.1$, $\\Delta m_g=+1.0\\,\\mathrm{kg/m^3}$, $\\Delta m_{\\ell}=-1.0\\,\\mathrm{kg/m^3}$.\n\nUse floors $\\epsilon_{\\alpha}=10^{-9}$ and $\\epsilon_{m}=10^{-12}\\,\\mathrm{kg/m^3}$. The densities must be computed as $\\rho_k^{n+1}=m_k^{n+1}/\\max(\\alpha_k^{n+1},\\epsilon_{\\alpha})$ to avoid division by zero, and must be reported in $\\mathrm{kg/m^3}$. The boolean must be true if and only if $0\\le \\alpha_g^{n+1}\\le 1$, $0\\le \\alpha_{\\ell}^{n+1}\\le 1$, $\\rho_g^{n+1}0$, and $\\rho_{\\ell}^{n+1}0$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each test case result is itself a list ordered as $[\\theta,\\alpha_g^{n+1},\\alpha_{\\ell}^{n+1},\\rho_g^{n+1},\\rho_{\\ell}^{n+1},\\mathrm{ok}]$. For example, the final output must look like\n$$\n\\big[\\,[\\cdots],\\,[\\cdots],\\,[\\cdots],\\,[\\cdots],\\,[\\cdots]\\,\\big],\n$$\nwith floating-point numbers for $\\theta$, $\\alpha_g^{n+1}$, $\\alpha_{\\ell}^{n+1}$, $\\rho_g^{n+1}$, and $\\rho_{\\ell}^{n+1}$ in $\\mathrm{kg/m^3}$, and a boolean for $\\mathrm{ok}$.",
            "solution": "The problem requires the derivation and implementation of a positivity-preserving limiter for a one-dimensional, compressible two-fluid model using an explicit time-stepping scheme. The goal is to ensure that the updated state variables remain within a physically admissible set $\\mathcal{A}$, defined by lower bounds on phase masses and lower/upper bounds on phase volume fractions.\n\nThe state at the new time level, $n+1$, is constructed from the state at the old time level, $n$, by scaling the explicit increments $(\\Delta m_k, \\Delta \\alpha_g)$ with a single scalar factor $\\theta \\in [0, 1]$. The updated state is given by:\n$$\nm_k^{n+1} = m_k^{n} + \\theta\\,\\Delta m_k, \\quad k \\in \\{g, \\ell\\}\n$$\n$$\n\\alpha_g^{n+1} = \\alpha_g^{n} + \\theta\\,\\Delta \\alpha_g\n$$\n$$\n\\alpha_{\\ell}^{n+1} = 1-\\alpha_g^{n+1} = \\alpha_{\\ell}^{n} - \\theta\\,\\Delta \\alpha_g\n$$\nWe assume the old state $(m_g^n, m_\\ell^n, \\alpha_g^n)$ is in the admissible set $\\mathcal{A}$, meaning $m_k^n \\ge \\epsilon_m$ and $\\epsilon_\\alpha \\le \\alpha_g^n \\le 1-\\epsilon_\\alpha$. Our objective is to find the largest $\\theta \\in [0, 1]$ such that the new state $(m_g^{n+1}, m_\\ell^{n+1}, \\alpha_g^{n+1})$ also lies in $\\mathcal{A}$. This requires satisfying four simultaneous inequality constraints. We derive the condition on $\\theta$ for each constraint individually.\n\n**1. Gas Mass Lower Bound: $m_g^{n+1} \\ge \\epsilon_{m}$**\n\nThe constraint is $m_g^{n} + \\theta\\,\\Delta m_g \\ge \\epsilon_{m}$. Rearranging for $\\theta$, we have $\\theta\\,\\Delta m_g \\ge \\epsilon_{m} - m_g^{n}$. We consider two cases for the increment $\\Delta m_g$:\n- If $\\Delta m_g \\ge 0$, the mass is non-decreasing. Since $m_g^{n} \\ge \\epsilon_{m}$, the constraint is satisfied for all $\\theta \\ge 0$. No upper bound on $\\theta$ is imposed by this constraint.\n- If $\\Delta m_g  0$, the mass is decreasing. Dividing by the negative $\\Delta m_g$ reverses the inequality:\n$$\n\\theta \\le \\frac{\\epsilon_{m} - m_g^{n}}{\\Delta m_g} = \\frac{m_g^{n} - \\epsilon_{m}}{-\\Delta m_g}\n$$\nSince $m_g^{n} \\ge \\epsilon_{m}$, the numerator is non-negative, and with $-\\Delta m_g  0$, the ratio is non-negative. We define a constraint-specific scaling factor $\\theta_{m,g}$ that represents this upper bound:\n$$\n\\theta_{m,g} = \\begin{cases} \\frac{\\epsilon_{m} - m_g^{n}}{\\Delta m_g}  \\text{if } \\Delta m_g  0 \\\\ \\infty  \\text{if } \\Delta m_g \\ge 0 \\end{cases}\n$$\nThe use of $\\infty$ indicates that the constraint is inactive for non-decreasing mass.\n\n**2. Liquid Mass Lower Bound: $m_{\\ell}^{n+1} \\ge \\epsilon_{m}$**\n\nThe derivation is identical to the gas phase. The constraint is $m_{\\ell}^{n} + \\theta\\,\\Delta m_{\\ell} \\ge \\epsilon_{m}$. This leads to the scaling factor $\\theta_{m,\\ell}$:\n$$\n\\theta_{m,\\ell} = \\begin{cases} \\frac{\\epsilon_{m} - m_{\\ell}^{n}}{\\Delta m_{\\ell}}  \\text{if } \\Delta m_{\\ell}  0 \\\\ \\infty  \\text{if } \\Delta m_{\\ell} \\ge 0 \\end{cases}\n$$\n\n**3. Gas Volume Fraction Lower Bound: $\\alpha_g^{n+1} \\ge \\epsilon_{\\alpha}$**\n\nThe constraint is $\\alpha_g^{n} + \\theta\\,\\Delta \\alpha_g \\ge \\epsilon_{\\alpha}$. The analysis is analogous to the mass constraints.\n- If $\\Delta \\alpha_g \\ge 0$, the constraint is satisfied since $\\alpha_g^{n} \\ge \\epsilon_{\\alpha}$.\n- If $\\Delta \\alpha_g  0$, we require an upper bound on $\\theta$:\n$$\n\\theta \\le \\frac{\\epsilon_{\\alpha} - \\alpha_g^{n}}{\\Delta \\alpha_g}\n$$\nThe corresponding scaling factor, $\\theta_{\\alpha,\\mathrm{low}}$, is:\n$$\n\\theta_{\\alpha,\\mathrm{low}} = \\begin{cases} \\frac{\\epsilon_{\\alpha} - \\alpha_g^{n}}{\\Delta \\alpha_g}  \\text{if } \\Delta \\alpha_g  0 \\\\ \\infty  \\text{if } \\Delta \\alpha_g \\ge 0 \\end{cases}\n$$\n\n**4. Gas Volume Fraction Upper Bound: $\\alpha_g^{n+1} \\le 1 - \\epsilon_{\\alpha}$**\n\nThe constraint is $\\alpha_g^{n} + \\theta\\,\\Delta \\alpha_g \\le 1 - \\epsilon_{\\alpha}$. Rearranging yields $\\theta\\,\\Delta \\alpha_g \\le 1 - \\epsilon_{\\alpha} - \\alpha_g^{n}$. Here, the case analysis depends on the sign of $\\Delta \\alpha_g$ differently.\n- If $\\Delta \\alpha_g \\le 0$, the volume fraction is non-increasing. Since $\\alpha_g^{n} \\le 1 - \\epsilon_{\\alpha}$, the constraint is always satisfied for $\\theta \\ge 0$.\n- If $\\Delta \\alpha_g  0$, we must limit $\\theta$:\n$$\n\\theta \\le \\frac{1 - \\epsilon_{\\alpha} - \\alpha_g^{n}}{\\Delta \\alpha_g}\n$$\nThe corresponding scaling factor, $\\theta_{\\alpha,\\mathrm{up}}$, is:\n$$\n\\theta_{\\alpha,\\mathrm{up}} = \\begin{cases} \\frac{1 - \\epsilon_{\\alpha} - \\alpha_g^{n}}{\\Delta \\alpha_g}  \\text{if } \\Delta \\alpha_g  0 \\\\ \\infty  \\text{if } \\Delta \\alpha_g \\le 0 \\end{cases}\n$$\n\n**Synthesis of the Limiter**\n\nTo ensure all four constraints are met simultaneously, $\\theta$ must be less than or equal to each of the derived upper bounds. We also require that the limiter does not amplify the update, so $\\theta \\le 1$. To obtain the largest possible update that remains valid, we choose the most restrictive (i.e., the minimum) of all these bounds. This proves that the correct choice for $\\theta$ is:\n$$\n\\theta = \\min\\Big(1,\\ \\theta_{m,g},\\ \\theta_{m,\\ell},\\ \\theta_{\\alpha,\\mathrm{low}},\\ \\theta_{\\alpha,\\mathrm{up}}\\Big)\n$$\nThis form explicitly constructs the limiter. The set $\\mathcal{A}$ is defined by a set of linear inequalities, making it a convex set. The old state $X^n = (m_g^n, m_\\ell^n, \\alpha_g^n)$ lies in $\\mathcal{A}$, and the limited new state $X^{n+1}$ is a convex combination of $X^n$ and the pre-limited state $X^\\star$, i.e., $X^{n+1} = (1-\\theta)X^n + \\theta X^\\star$. Our construction of $\\theta$ finds the largest value in $[0,1]$ such that $X^{n+1}$ lies on the line segment between $X^n$ and $X^\\star$ and is still inside $\\mathcal{A}$.\n\n**Positivity of Densities**\n\nThe application of the limiter guarantees that the new state lies in $\\mathcal{A}$. Specifically:\n- $m_k^{n+1} \\ge \\epsilon_m  0$ for $k\\in\\{g, \\ell\\}$.\n- $\\epsilon_\\alpha \\le \\alpha_g^{n+1} \\le 1-\\epsilon_\\alpha$. This implies $\\alpha_g^{n+1}  0$ and $\\alpha_\\ell^{n+1} = 1 - \\alpha_g^{n+1} \\ge \\epsilon_\\alpha  0$.\n\nThe phase densities are recovered as $\\rho_k^{n+1} = m_k^{n+1} / \\alpha_k^{n+1}$. Since both the numerator ($m_k^{n+1}$) and the denominator ($\\alpha_k^{n+1}$) are guaranteed to be strictly positive, the resulting densities $\\rho_k^{n+1}$ are also strictly positive. The problem specifies computing density as $\\rho_k^{n+1}=m_k^{n+1}/\\max(\\alpha_k^{n+1},\\epsilon_{\\alpha})$, which reinforces this conclusion, as the denominator is explicitly prevented from being zero or negative and is bounded below by $\\epsilon_\\alpha  0$.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Derives and applies a positivity-preserving limiter for a two-fluid model.\n    \"\"\"\n    \n    # Define physical floors\n    eps_alpha = 1e-9\n    eps_m = 1e-12\n\n    # Test cases: (alpha_g_n, rho_g_n, rho_l_n, delta_alpha_g, delta_m_g, delta_m_l)\n    test_cases = [\n        # Test case 1 (happy path, moderate update)\n        (0.4, 5.0, 950.0, -0.02, -0.1, 0.1),\n        # Test case 2 (strong shock, gas mass goes negative without limiting)\n        (0.3, 8.0, 1000.0, -0.05, -3.0, 2.0),\n        # Test case 3 (stiff relaxation, volume fraction overshoot above unity)\n        (0.5, 2.0, 900.0, 0.8, 0.1, -0.1),\n        # Test case 4 (near-vacuum gas fraction, potential underflow)\n        (1e-6, 0.8, 1000.0, -1e-3, -1e-5, 1e-2),\n        # Test case 5 (almost pure liquid, upper bound on gas fraction violated without limiting)\n        (1.0 - 1e-9, 10.0, 1000.0, 0.1, 1.0, -1.0),\n    ]\n\n    def compute_limited_update(case_params):\n        \"\"\"\n        Computes the limited update for a single test case.\n        \"\"\"\n        alpha_g_n, rho_g_n, rho_l_n, delta_alpha_g, delta_m_g, delta_m_l = case_params\n\n        # 1. Calculate initial conservative variables\n        alpha_l_n = 1.0 - alpha_g_n\n        m_g_n = alpha_g_n * rho_g_n\n        m_l_n = alpha_l_n * rho_l_n\n\n        # 2. Calculate individual theta limiter values\n        # Note: we use (X - X_min) / (-delta_X) instead of (X_min - X) / delta_X\n        # to avoid potential floating point issues with (small_positive - large_positive).\n        \n        # theta for gas mass lower bound\n        if delta_m_g  0:\n            theta_m_g = (m_g_n - eps_m) / (-delta_m_g)\n        else:\n            theta_m_g = np.inf\n\n        # theta for liquid mass lower bound\n        if delta_m_l  0:\n            theta_m_l = (m_l_n - eps_m) / (-delta_m_l)\n        else:\n            theta_m_l = np.inf\n\n        # theta for gas volume fraction lower bound\n        if delta_alpha_g  0:\n            theta_alpha_low = (alpha_g_n - eps_alpha) / (-delta_alpha_g)\n        else:\n            theta_alpha_low = np.inf\n\n        # theta for gas volume fraction upper bound\n        if delta_alpha_g > 0:\n            theta_alpha_up = (1.0 - eps_alpha - alpha_g_n) / delta_alpha_g\n        else:\n            theta_alpha_up = np.inf\n\n        # 3. Calculate the final limiter theta\n        theta = min(1.0, theta_m_g, theta_m_l, theta_alpha_low, theta_alpha_up)\n        \n        # 4. Calculate the limited new state (n+1)\n        alpha_g_n1 = alpha_g_n + theta * delta_alpha_g\n        alpha_l_n1 = 1.0 - alpha_g_n1\n        m_g_n1 = m_g_n + theta * delta_m_g\n        m_l_n1 = m_l_n + theta * delta_m_l\n\n        # 5. Calculate new densities with floor on alpha\n        rho_g_n1 = m_g_n1 / max(alpha_g_n1, eps_alpha)\n        rho_l_n1 = m_l_n1 / max(alpha_l_n1, eps_alpha)\n        \n        # 6. Check validity (ok boolean)\n        ok = (0.0 = alpha_g_n1 = 1.0 and\n              0.0 = alpha_l_n1 = 1.0 and\n              rho_g_n1 > 0.0 and\n              rho_l_n1 > 0.0)\n\n        return [theta, alpha_g_n1, alpha_l_n1, rho_g_n1, rho_l_n1, ok]\n\n    results = []\n    for case in test_cases:\n        result = compute_limited_update(case)\n        results.append(result)\n\n    # Custom formatter to match the requested output style\n    def format_list(lst):\n        items = []\n        for item in lst:\n            if isinstance(item, list):\n                items.append(format_list(item))\n            elif isinstance(item, bool):\n                items.append(str(item).lower())\n            else:\n                items.append(f\"{item}\")\n        return f\"[{','.join(items)}]\"\n        \n    print(format_list(results))\n\nsolve()\n```"
        }
    ]
}