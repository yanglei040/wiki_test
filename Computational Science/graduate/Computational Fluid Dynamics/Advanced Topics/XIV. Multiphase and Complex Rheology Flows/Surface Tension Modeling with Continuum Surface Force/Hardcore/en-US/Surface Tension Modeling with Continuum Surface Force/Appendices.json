{
    "hands_on_practices": [
        {
            "introduction": "A fundamental check for any physics simulation is to verify its behavior in a simple, known equilibrium state. For a static, isolated, and symmetric fluid droplet, the surface tension forces distributed over its interface must sum to zero. The Continuum Surface Force (CSF) model translates the sharp-interface force into a volume integral, which should also result in a zero net force for a closed surface. This exercise  provides a direct, hands-on verification of this principle, guiding you to quantify the \"spurious force\"—the non-zero residual that arises purely from discretization errors—and assess its magnitude against a physically-motivated tolerance.",
            "id": "3368723",
            "problem": "You are tasked with verifying the consistency of the Continuum Surface Force (CSF) model of surface tension for a spherical droplet by computing the net surface force via a volume integral and comparing it with the analytic result. Work in three spatial dimensions and adopt a uniform Cartesian grid. All distances must be in meters, surface tension in Newtons per meter, and forces in Newtons.\n\nStarting from fundamental balance laws for momentum and well-tested interface modeling facts, adopt the following modeling base:\n- The smoothed color function (volume fraction) field is denoted by $\\,\\alpha(\\mathbf{x})\\,$, constructed from a signed distance field $\\,\\phi(\\mathbf{x})\\,$ as a monotone transition between phases.\n- The unit normal is $\\,\\mathbf{n} = \\dfrac{\\nabla \\alpha}{\\lVert \\nabla \\alpha \\rVert}\\,$ where $\\,\\lVert \\cdot \\rVert\\,$ is the Euclidean norm.\n- The curvature is $\\,\\kappa = -\\nabla \\cdot \\mathbf{n}\\,$.\n- The Continuum Surface Force (CSF) body force density is $\\,\\mathbf{f}_\\sigma = \\sigma \\, \\kappa \\, \\nabla \\alpha\\,$, where $\\,\\sigma\\,$ is the surface tension coefficient.\n\nFor a spherical droplet of radius $\\,R\\,$ centered at $\\,\\mathbf{x}_c\\,$ in an otherwise quiescent fluid, the analytic net surface tension force is the surface integral $\\,\\displaystyle \\int_{\\Gamma} \\sigma \\, \\kappa \\, \\mathbf{n} \\, \\mathrm{d}S\\,$ over the closed interface $\\,\\Gamma\\,$. For a perfect sphere, by symmetry and the divergence theorem, this analytic net force equals $\\,\\mathbf{0}\\,$. Your task is to compute the net force predicted by the diffuse CSF model as a volume integral and verify agreement with the analytic result within a tolerance that accounts for discretization.\n\nNumerical specification:\n- Consider a cubic domain $\\,[-L,L]^3\\,$, discretized by a uniform grid of $\\,N \\times N \\times N\\,$ cell centers with grid spacing $\\,\\Delta = \\dfrac{2L}{N}\\,$.\n- Define the signed distance field $\\,\\phi(\\mathbf{x}) = \\lVert \\mathbf{x} - \\mathbf{x}_c \\rVert - R\\,$ and the smoothed color function\n  $$\\alpha(\\mathbf{x}) = \\tfrac{1}{2}\\Big(1 - \\tanh\\Big(\\dfrac{\\phi(\\mathbf{x})}{\\sqrt{2}\\,\\varepsilon}\\Big)\\Big),$$\n  where $\\,\\varepsilon\\,$ is the diffuse interface thickness parameter.\n- Approximate spatial derivatives with second-order central differences, and approximate the net force as the Riemann sum\n  $$\\mathbf{F}_\\mathrm{CSF} \\approx \\sum_{i,j,k} \\sigma \\, \\kappa_{i,j,k} \\, \\nabla \\alpha_{i,j,k}\\, \\Delta^3,$$\n  where $\\,\\kappa_{i,j,k}\\,$ and $\\,\\nabla \\alpha_{i,j,k}\\,$ are the discrete curvature and gradient at grid cell $\\,\\{i,j,k\\}\\,$.\n\nVerification metric and tolerance:\n- The analytic net force magnitude is $\\,\\lVert \\mathbf{F}_\\mathrm{analytic} \\rVert = 0\\,\\mathrm{N}\\,$.\n- Let $\\,A = 4\\pi R^2\\,$ be the droplet surface area. Define the absolute tolerance\n  $$\\mathrm{tol} = C \\,\\sigma \\, A \\, \\dfrac{\\Delta}{\\max(\\varepsilon,\\,\\Delta)},$$\n  where $\\,C\\,$ is a user-specified dimensionless constant set to $\\,C=1\\,$ for this verification.\n- Declare a test as passed if $\\,\\lVert \\mathbf{F}_\\mathrm{CSF} \\rVert \\le \\mathrm{tol}\\,$.\n\nTest suite:\nImplement the computation for the following cases. In each case, report a boolean indicating whether the test passes according to the criterion above.\n\n- Case $\\,1\\,$ (happy path, centered droplet):\n  - $\\,N = 48\\,$, $\\,L = 0.01\\,\\mathrm{m}\\,$, $\\,R = 0.004\\,\\mathrm{m}\\,$, $\\,\\sigma = 0.072\\,\\mathrm{N/m}\\,$,\n    $\\,\\varepsilon = 2.0\\,\\Delta\\,$, $\\,\\mathbf{x}_c = (0,0,0)\\,\\mathrm{m}\\,$.\n- Case $\\,2\\,$ (refined grid, off-centered droplet):\n  - $\\,N = 64\\,$, $\\,L = 0.01\\,\\mathrm{m}\\,$, $\\,R = 0.006\\,\\mathrm{m}\\,$, $\\,\\sigma = 0.03\\,\\mathrm{N/m}\\,$,\n    $\\,\\varepsilon = 1.5\\,\\Delta\\,$, $\\,\\mathbf{x}_c = (1.1\\times 10^{-4},-7.0\\times 10^{-5},5.0\\times 10^{-5})\\,\\mathrm{m}\\,$.\n- Case $\\,3\\,$ (thinner interface):\n  - $\\,N = 56\\,$, $\\,L = 0.01\\,\\mathrm{m}\\,$, $\\,R = 0.005\\,\\mathrm{m}\\,$, $\\,\\sigma = 0.0728\\,\\mathrm{N/m}\\,$,\n    $\\,\\varepsilon = 1.0\\,\\Delta\\,$, $\\,\\mathbf{x}_c = (0,0,0)\\,\\mathrm{m}\\,$.\n- Case $\\,4\\,$ (smaller droplet, coarser grid, off-centered):\n  - $\\,N = 40\\,$, $\\,L = 0.01\\,\\mathrm{m}\\,$, $\\,R = 0.003\\,\\mathrm{m}\\,$, $\\,\\sigma = 0.05\\,\\mathrm{N/m}\\,$,\n    $\\,\\varepsilon = 1.0\\,\\Delta\\,$, $\\,\\mathbf{x}_c = (2.0\\times 10^{-4},2.0\\times 10^{-4},-1.0\\times 10^{-4})\\,\\mathrm{m}\\,$.\n\nProgram requirements:\n- Your program must compute $\\,\\mathbf{F}_\\mathrm{CSF}\\,$ for each case as described, compute $\\,\\mathrm{tol}\\,$, and output for each case a boolean indicating whether $\\,\\lVert \\mathbf{F}_\\mathrm{CSF} \\rVert \\le \\mathrm{tol}\\,$.\n- Final output format: a single line containing a comma-separated list of booleans enclosed in square brackets, for example `[True,False,True,True]`. Produce exactly one such line and no other output.",
            "solution": "The problem requires the verification of the Continuum Surface Force (CSF) model, a cornerstone of multiphase computational fluid dynamics, by testing a fundamental physical principle: the net force on a closed, symmetric interface in a quiescent fluid must be zero. Any non-zero force computed by a numerical model is a discretization artifact, often termed spurious or parasitic force. The task is to compute this numerical force for a spherical droplet and verify that its magnitude is within a specified tolerance that accounts for known sources of discretization error.\n\nThe solution proceeds by implementing the specified numerical algorithm. The process for each test case is as follows:\n\n1.  **Domain Discretization and Grid Generation**\n    A cubic computational domain of $[-L, L]^3$ is discretized into a uniform Cartesian grid of $N \\times N \\times N$ cells. The grid spacing is constant in all three dimensions, given by $\\Delta = \\frac{2L}{N}$. The computational points are located at the cell centers. For a grid with indices $i, j, k$ from $0$ to $N-1$, the coordinates of the cell centers are given by:\n    $$ x_i = -L + (i + 0.5)\\Delta $$\n    $$ y_j = -L + (j + 0.5)\\Delta $$\n    $$ z_k = -L + (k + 0.5)\\Delta $$\n    These coordinates are used to define all physical fields on the discrete grid.\n\n2.  **Scalar Field Computation**\n    The interface between the two fluids is represented by a smoothed scalar field, the volume fraction or color function, $\\alpha(\\mathbf{x})$. This field is constructed from the signed distance function $\\phi(\\mathbf{x})$, which gives the shortest distance from a point $\\mathbf{x}$ to the interface, with the sign indicating whether the point is inside or outside the droplet. For a sphere of radius $R$ centered at $\\mathbf{x}_c = (x_c, y_c, z_c)$, the signed distance is:\n    $$ \\phi(\\mathbf{x}) = \\lVert \\mathbf{x} - \\mathbf{x}_c \\rVert - R = \\sqrt{(x-x_c)^2 + (y-y_c)^2 + (z-z_c)^2} - R $$\n    The color function $\\alpha(\\mathbf{x})$ is then defined as a smooth transition from $1$ (inside the droplet, $\\phi < 0$) to $0$ (outside, $\\phi > 0$):\n    $$ \\alpha(\\mathbf{x}) = \\tfrac{1}{2}\\Big(1 - \\tanh\\Big(\\dfrac{\\phi(\\mathbf{x})}{\\sqrt{2}\\,\\varepsilon}\\Big)\\Big) $$\n    Here, $\\varepsilon$ is a parameter controlling the thickness of the diffuse interface. These functions, $\\phi$ and $\\alpha$, are evaluated at every grid point $(x_i, y_j, z_k)$.\n\n3.  **Gradient of the Color Function ($\\nabla \\alpha$)**\n    The CSF model requires the gradient of the color function, $\\nabla \\alpha$. This vector field is computed numerically using second-order central differences for interior points. For boundary points, a common and robust practice is to use second-order one-sided differences. This procedure is encapsulated within standard numerical library functions, such as `numpy.gradient`, which will be used for this task. The gradient at each grid point $(i,j,k)$ is:\n    $$ \\nabla \\alpha_{i,j,k} \\approx \\left( \\frac{\\alpha_{i+1,j,k} - \\alpha_{i-1,j,k}}{2\\Delta}, \\frac{\\alpha_{i,j+1,k} - \\alpha_{i,j-1,k}}{2\\Delta}, \\frac{\\alpha_{i,j,k+1} - \\alpha_{i,j,k-1}}{2\\Delta} \\right) $$\n    This gradient is non-zero only within the diffuse interface region, correctly localizing the surface tension effects.\n\n4.  **Unit Normal Vector ($\\mathbf{n}$)**\n    The unit normal vector to the interface is directed from the liquid to the gas phase and is defined in terms of the gradient of $\\alpha$:\n    $$ \\mathbf{n} = \\frac{\\nabla \\alpha}{\\lVert \\nabla \\alpha \\rVert} $$\n    Numerically, to prevent division by zero in regions where $\\nabla \\alpha = \\mathbf{0}$ (i.e., far from the interface), a small regularization parameter is added to the denominator. However, since the final force density $\\mathbf{f}_\\sigma$ is proportional to $\\nabla \\alpha$, this regularization has no effect on the final force calculation, as the force is zero wherever $\\nabla \\alpha$ is zero.\n\n5.  **Curvature Calculation ($\\kappa$)**\n    The curvature of the interface, $\\kappa$, is given by the negative divergence of the unit normal vector field:\n    $$ \\kappa = -\\nabla \\cdot \\mathbf{n} = -\\left( \\frac{\\partial n_x}{\\partial x} + \\frac{\\partial n_y}{\\partial y} + \\frac{\\partial n_z}{\\partial z} \\right) $$\n    Similar to the gradient calculation, the divergence is computed numerically using second-order finite differences. For each component of the normal vector, its partial derivative is computed along the corresponding axis, and the results are summed.\n\n6.  **Net Force Integration ($\\mathbf{F}_\\mathrm{CSF}$)**\n    The CSF model approximates the singular surface tension force acting on the interface $\\Gamma$ with a continuous body force density $\\mathbf{f}_\\sigma$ that acts over the finite volume of the diffuse interface region:\n    $$ \\mathbf{f}_\\sigma = \\sigma \\, \\kappa \\, \\nabla \\alpha $$\n    where $\\sigma$ is the surface tension coefficient. The total net force on the droplet, $\\mathbf{F}_\\mathrm{CSF}$, is the volume integral of this force density over the entire domain. This integral is approximated by a Riemann sum over all grid cells:\n    $$ \\mathbf{F}_\\mathrm{CSF} = \\int_{V} \\mathbf{f}_\\sigma \\, dV \\approx \\sum_{i,j,k} \\mathbf{f}_{\\sigma, i,j,k} \\, \\Delta V = \\sum_{i,j,k} (\\sigma \\, \\kappa_{i,j,k} \\, \\nabla \\alpha_{i,j,k}) \\, \\Delta^3 $$\n    The summation is performed for each component of the force vector separately.\n\n7.  **Verification Against Tolerance**\n    Analytically, the net force on the droplet is $\\mathbf{F}_\\mathrm{analytic} = \\mathbf{0}$. The numerically computed force $\\mathbf{F}_\\mathrm{CSF}$ will be non-zero due to discretization errors. The magnitude of this numerical force, $\\lVert \\mathbf{F}_\\mathrm{CSF} \\rVert$, is compared against a pre-defined tolerance, $\\mathrm{tol}$. The test passes if $\\lVert \\mathbf{F}_\\mathrm{CSF} \\rVert \\le \\mathrm{tol}$. The tolerance is defined as:\n    $$ \\mathrm{tol} = C \\,\\sigma \\, A \\, \\frac{\\Delta}{\\max(\\varepsilon, \\Delta)} $$\n    where $C=1$ is a dimensionless constant, $A=4\\pi R^2$ is the droplet surface area. This tolerance structure correctly reflects the expectation that numerical errors increase for sharper interfaces (smaller $\\varepsilon/\\Delta$) and decrease with grid refinement (smaller $\\Delta$).\n\nBy executing these steps for each test case provided, we can systematically verify the consistency of the CSF implementation.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the verification for all test cases.\n    \"\"\"\n    test_cases = [\n        # Case 1 (happy path, centered droplet)\n        {'N': 48, 'L': 0.01, 'R': 0.004, 'sigma': 0.072, 'eps_factor': 2.0, 'x_c': (0.0, 0.0, 0.0)},\n        # Case 2 (refined grid, off-centered droplet)\n        {'N': 64, 'L': 0.01, 'R': 0.006, 'sigma': 0.03, 'eps_factor': 1.5, 'x_c': (1.1e-4, -7.0e-5, 5.0e-5)},\n        # Case 3 (thinner interface)\n        {'N': 56, 'L': 0.01, 'R': 0.005, 'sigma': 0.0728, 'eps_factor': 1.0, 'x_c': (0.0, 0.0, 0.0)},\n        # Case 4 (smaller droplet, coarser grid, off-centered)\n        {'N': 40, 'L': 0.01, 'R': 0.003, 'sigma': 0.05, 'eps_factor': 1.0, 'x_c': (2.0e-4, 2.0e-4, -1.0e-4)},\n    ]\n\n    results = []\n    for case_params in test_cases:\n        passed = run_case(**case_params)\n        results.append(passed)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef run_case(N, L, R, sigma, eps_factor, x_c):\n    \"\"\"\n    Computes the net CSF force for a single case and checks against the tolerance.\n\n    Args:\n        N (int): Number of grid cells along one dimension.\n        L (float): Half-length of the cubic domain [-L, L]^3.\n        R (float): Radius of the spherical droplet.\n        sigma (float): Surface tension coefficient.\n        eps_factor (float): Factor to determine interface thickness, eps = eps_factor * Delta.\n        x_c (tuple): Center of the droplet (x_c, y_c, z_c).\n\n    Returns:\n        bool: True if the test passes (||F_CSF|| <= tol), False otherwise.\n    \"\"\"\n    # 1. Grid and Field Generation\n    Delta = 2.0 * L / N\n    epsilon = eps_factor * Delta\n    \n    # Create grid coordinates for cell centers\n    grid_coords_1d = np.linspace(-L + Delta / 2.0, L - Delta / 2.0, N)\n    x, y, z = np.meshgrid(grid_coords_1d, grid_coords_1d, grid_coords_1d, indexing='ij')\n\n    # Compute signed distance field (phi)\n    phi = np.sqrt((x - x_c[0])**2 + (y - x_c[1])**2 + (z - x_c[2])**2) - R\n\n    # Compute color function (alpha)\n    alpha = 0.5 * (1.0 - np.tanh(phi / (np.sqrt(2.0) * epsilon)))\n\n    # 2. Gradient of the Color Function (nabla alpha)\n    # np.gradient uses 2nd-order central differences for interior points\n    # and 2nd-order one-sided differences for boundary points.\n    # The 'ij' indexing ensures axis 0 is x, 1 is y, 2 is z.\n    grad_alpha = np.gradient(alpha, Delta)\n    grad_alpha_x, grad_alpha_y, grad_alpha_z = grad_alpha[0], grad_alpha[1], grad_alpha[2]\n\n    # 3. Unit Normal Vector (n)\n    norm_grad_alpha = np.sqrt(grad_alpha_x**2 + grad_alpha_y**2 + grad_alpha_z**2)\n    \n    # Regularization to avoid division by zero\n    reg_term = 1e-20\n    \n    n_x = grad_alpha_x / (norm_grad_alpha + reg_term)\n    n_y = grad_alpha_y / (norm_grad_alpha + reg_term)\n    n_z = grad_alpha_z / (norm_grad_alpha + reg_term)\n\n    # 4. Curvature Calculation (kappa)\n    # kappa = -nabla . n\n    # Use axis argument for efficiency to compute derivatives only along the required axes.\n    div_n = (np.gradient(n_x, Delta, axis=0) +\n             np.gradient(n_y, Delta, axis=1) +\n             np.gradient(n_z, Delta, axis=2))\n    \n    kappa = -div_n\n\n    # 5. Net Force Integration (F_CSF)\n    # f_sigma = sigma * kappa * nabla alpha\n    f_sigma_x = sigma * kappa * grad_alpha_x\n    f_sigma_y = sigma * kappa * grad_alpha_y\n    f_sigma_z = sigma * kappa * grad_alpha_z\n\n    # Integrate over the volume by summing and multiplying by cell volume\n    dV = Delta**3\n    F_csf_x = np.sum(f_sigma_x) * dV\n    F_csf_y = np.sum(f_sigma_y) * dV\n    F_csf_z = np.sum(f_sigma_z) * dV\n    \n    F_csf = np.array([F_csf_x, F_csf_y, F_csf_z])\n    F_csf_magnitude = np.linalg.norm(F_csf)\n\n    # 6. Verification Against Tolerance\n    C = 1.0\n    A = 4.0 * np.pi * R**2\n    tol = C * sigma * A * Delta / max(epsilon, Delta)\n\n    return F_csf_magnitude <= tol\n\nif __name__ == '__main__':\n    solve()\n```"
        },
        {
            "introduction": "In simulations with moving interfaces, the accuracy of the results should not depend on the object's arbitrary position relative to the computational grid. This property, known as geometric conservation or Galilean invariance, is often violated by simple numerical schemes, leading to errors that change as the interface moves. This practice  allows you to quantify this geometric conservation error directly by computing key invariants before and after a sub-grid translation of a droplet. This exercise reveals how sensitive the discrete CSF model is to the interface's position, a critical insight for understanding error sources in dynamic multiphase flow simulations.",
            "id": "3368688",
            "problem": "You are given a two-dimensional, incompressible, quiescent fluid domain in which a single circular droplet is represented by a level set signed-distance function. You will quantify geometric conservation error in the Continuum Surface Force (CSF) model under a rigid translation of the droplet. The goal is to determine how discretization on a uniform periodic grid affects numerical invariants of surface tension when the droplet is translated by a constant offset.\n\nStart from the following fundamental base:\n- Newton’s second law for a control volume, where surface tension appears as a body force in the momentum equation.\n- The Continuum Surface Force (CSF) model represents surface tension as a body force density $ \\mathbf{f}_s = \\sigma \\kappa \\delta_s \\mathbf{n} $, where $ \\sigma $ is the surface tension coefficient, $ \\kappa $ is the mean curvature, $ \\delta_s $ is a distribution concentrating the force on the interface, and $ \\mathbf{n} $ is the unit normal to the interface pointing from the droplet interior to the exterior.\n- In the Level Set Method (LSM), the interface is represented as the zero contour of a signed-distance function $ \\phi(\\mathbf{x}) $, and $ \\mathbf{n} = \\nabla \\phi / \\lVert \\nabla \\phi \\rVert $ and $ \\kappa = \\nabla \\cdot \\mathbf{n} $ at the interface.\n\nAssume a square periodic domain of side length $ L $ discretized by a uniform grid with $ N \\times N $ nodes and grid spacing $ h = L/N $. Use periodic boundary conditions for spatial derivatives. The droplet is a circle of radius $ R $ with center $ (c_x, c_y) $. The signed-distance level set is $ \\phi(x,y) = \\sqrt{(x-c_x)^2 + (y-c_y)^2} - R $. The analytic reference curvature for a circle is $ \\kappa_{\\text{exact}} = 1/R $.\n\nYour tasks:\n1. Discretize gradients and divergences with second-order centered finite differences under periodic boundary conditions to compute the discrete unit normal $ \\mathbf{n} $ and curvature $ \\kappa $ from $ \\phi $.\n2. Approximate the interface distribution $ \\delta_s $ by a smooth Dirac delta $ \\delta_\\varepsilon(\\phi) $ supported in a narrow band of half-width $ \\varepsilon $, using the standard mollifier\n   $$ \\delta_\\varepsilon(\\phi) = \\begin{cases}\n   \\dfrac{1}{2\\varepsilon} \\left(1 + \\cos\\left(\\dfrac{\\pi \\phi}{\\varepsilon}\\right)\\right), & |\\phi| \\le \\varepsilon, \\\\\n   0, & \\text{otherwise},\n   \\end{cases} $$\n   with $ \\varepsilon = 1.5 h $.\n3. Compute the CSF body force density field $ \\mathbf{f}_s = \\sigma \\kappa \\delta_\\varepsilon(\\phi) \\mathbf{n} $.\n4. For a given droplet center $ (c_x, c_y) $ located at the domain center $ (L/2, L/2) $, compute two invariants:\n   - The root-mean-square curvature error restricted to the $ \\varepsilon $-narrow band,\n     $$ E_\\kappa = \\sqrt{\\dfrac{1}{N_b} \\sum_{i \\in \\mathcal{B}} \\left(\\kappa_i - \\dfrac{1}{R}\\right)^2}, $$\n     where $ \\mathcal{B} = \\{ i : |\\phi_i| \\le \\varepsilon \\} $ and $ N_b = |\\mathcal{B}| $.\n   - The net CSF force vector integrated over the domain,\n     $$ \\mathbf{F} = \\sum_{\\text{cells}} \\mathbf{f}_{s} \\, \\Delta A, \\quad \\Delta A = h^2, \\quad F_{\\text{mag}} = \\lVert \\mathbf{F} \\rVert_2. $$\n     In the continuum, for a closed circular interface in a periodic domain, the net force should be $ \\mathbf{F} = \\mathbf{0} $.\n5. Apply a rigid translation of the droplet by $ (\\Delta x, \\Delta y) $, keeping the grid fixed. The translation is specified as multiples of the grid spacing: define $ \\Delta x = \\alpha_x h $ and $ \\Delta y = \\alpha_y h $, with periodic wrapping of the center. Recompute $ E_\\kappa $ and $ F_{\\text{mag}} $ after translation.\n6. Quantify geometric conservation error due to translation as the absolute deviations\n   $$ \\Delta E_\\kappa = \\left| E_\\kappa^{\\text{post}} - E_\\kappa^{\\text{pre}} \\right|, \\qquad \\Delta F = \\left| F_{\\text{mag}}^{\\text{post}} - F_{\\text{mag}}^{\\text{pre}} \\right|. $$\n\nPhysical and numerical units:\n- Report $ E_\\kappa $ and $ \\Delta E_\\kappa $ in $ \\text{m}^{-1} $.\n- Report $ F_{\\text{mag}} $ and $ \\Delta F $ in $ \\text{N} $ assuming unit thickness in the out-of-plane direction.\n- All lengths ($ L $, $ R $, $ h $, $ \\Delta x $, $ \\Delta y $, coordinates) are in $ \\text{m} $.\n- Surface tension $ \\sigma $ is in $ \\text{N}/\\text{m} $.\n- Angles are in radians.\n\nNumerical scheme specifications:\n- Use second-order centered finite differences with periodic boundary conditions for $ \\nabla \\phi $ and $ \\nabla \\cdot \\mathbf{n} $.\n- Construct the grid with node coordinates at cell centers $ x_i = (i + 0.5) h $, $ y_j = (j + 0.5) h $ for $ i,j \\in \\{0,\\dots,N-1\\} $.\n- Regularize the normalization $ \\mathbf{n} = \\nabla \\phi / \\lVert \\nabla \\phi \\rVert $ by adding a small parameter $ \\eta $ to the denominator to avoid division by zero, with $ \\eta = 10^{-12} $ in nondimensional magnitude.\n\nTest suite:\nProvide results for the following parameter sets. For each test case, the program must compute $ \\Delta E_\\kappa $ and $ \\Delta F $ as defined above and return them in the specified output format.\n\n- Test $ 1 $ (baseline, no translation):\n  - $ N = 128 $, $ L = 1.0 \\, \\text{m} $, $ R = 0.2 \\, \\text{m} $, $ \\sigma = 0.072 \\, \\text{N}/\\text{m} $, $ \\alpha_x = 0.0 $, $ \\alpha_y = 0.0 $.\n- Test $ 2 $ (integer-cell translation in $ x $):\n  - $ N = 128 $, $ L = 1.0 \\, \\text{m} $, $ R = 0.2 \\, \\text{m} $, $ \\sigma = 0.072 \\, \\text{N}/\\text{m} $, $ \\alpha_x = 1.0 $, $ \\alpha_y = 0.0 $.\n- Test $ 3 $ (half-cell translation in both directions):\n  - $ N = 128 $, $ L = 1.0 \\, \\text{m} $, $ R = 0.2 \\, \\text{m} $, $ \\sigma = 0.072 \\, \\text{N}/\\text{m} $, $ \\alpha_x = 0.5 $, $ \\alpha_y = 0.5 $.\n- Test $ 4 $ (smaller droplet, half-cell translation in $ x $):\n  - $ N = 128 $, $ L = 1.0 \\, \\text{m} $, $ R = 0.08 \\, \\text{m} $, $ \\sigma = 0.072 \\, \\text{N}/\\text{m} $, $ \\alpha_x = 0.5 $, $ \\alpha_y = 0.0 $.\n- Test $ 5 $ (coarser grid, half-cell translation in $ x $):\n  - $ N = 64 $, $ L = 1.0 \\, \\text{m} $, $ R = 0.2 \\, \\text{m} $, $ \\sigma = 0.072 \\, \\text{N}/\\text{m} $, $ \\alpha_x = 0.5 $, $ \\alpha_y = 0.0 $.\n\nRequired final output format:\n- Your program should produce a single line of output containing the results for all test cases as a comma-separated list enclosed in square brackets, where each test case contributes a two-element list $ [\\Delta E_\\kappa, \\Delta F] $. For example,\n  \"[[0.0,0.0],[0.0,0.0]]\"\n- No additional text should be printed.\n\nExpress all numerical answers in International System of Units (SI), with $ \\Delta E_\\kappa $ in $ \\text{m}^{-1} $ and $ \\Delta F $ in $ \\text{N} $.",
            "solution": "The problem requires the quantification of geometric conservation error in the Continuum Surface Force (CSF) model for surface tension when a circular droplet undergoes a rigid translation on a fixed, periodic grid. The error is measured by the change in two numerical invariants: the root-mean-square (RMS) curvature error and the net surface tension force over the domain. The analysis is performed using the level-set method.\n\nThe fundamental principle is Newton's second law for a fluid, where surface tension is modeled as a volumetric force $\\mathbf{f}_s$ concentrated at the fluid-fluid interface. The CSF model defines this force as $\\mathbf{f}_s = \\sigma \\kappa \\delta_s \\mathbf{n}$, where $\\sigma$ is the surface tension coefficient, $\\kappa$ is the interface curvature, $\\mathbf{n}$ is the interface unit normal vector, and $\\delta_s$ is a distribution function that localizes the force to the interface.\n\nIn a continuous, periodic domain containing a single closed interface, the net surface tension force must be zero due to mechanical equilibrium, i.e., $\\oint \\sigma \\kappa \\mathbf{n} \\, dS = \\mathbf{0}$. However, when discretized on a grid, numerical evaluation of $\\kappa$ and $\\mathbf{n}$ introduces errors. A key property of a robust numerical scheme is that its computed invariants should be independent of the object's position on the grid. A failure to maintain this invariance, known as a lack of geometric conservation, manifests as spurious forces and errors that depend on the sub-grid position of the interface. This problem aims to numerically measure this effect.\n\nThe solution is implemented through the following sequence of steps for each test case.\n\nFirst, we establish the computational domain. A square periodic domain of side length $L$ is discretized into a uniform grid of $N \\times N$ cells. The grid spacing is $h=L/N$. The grid nodes are located at cell centers, with coordinates $(x_i, y_j)$ given by:\n$$ x_i = (i + 0.5)h, \\quad y_j = (j + 0.5)h, \\quad \\text{for } i, j \\in \\{0, 1, \\dots, N-1\\} $$\n\nSecond, the circular droplet interface is represented implicitly by a signed-distance level-set function, $\\phi(\\mathbf{x})$. For a circle of radius $R$ centered at $(c_x, c_y)$, this function is defined at each grid node $(x_i, y_j)$ as:\n$$ \\phi_{i,j} = \\sqrt{(x_i - c_x)^2 + (y_j - c_y)^2} - R $$\n\nThird, we compute the geometric properties of the interface—the unit normal vector $\\mathbf{n}$ and the curvature $\\kappa$—from the discrete $\\phi$ field. The gradient of the level-set function, $\\nabla \\phi = (\\frac{\\partial \\phi}{\\partial x}, \\frac{\\partial \\phi}{\\partial y})$, is computed using second-order centered finite differences with periodic boundary conditions. For a discrete field $u_{i,j}$:\n$$ \\left(\\frac{\\partial u}{\\partial x}\\right)_{i,j} \\approx \\frac{u_{i+1,j} - u_{i-1,j}}{2h}, \\quad \\left(\\frac{\\partial u}{\\partial y}\\right)_{i,j} \\approx \\frac{u_{i,j+1} - u_{i,j-1}}{2h} $$\nThe indices are handled periodically, e.g., $u_{N,j} = u_{0,j}$ and $u_{-1,j} = u_{N-1,j}$.\n\nThe unit normal vector $\\mathbf{n}$ is then calculated by normalizing the gradient field. To prevent division by zero in regions where $\\nabla\\phi$ may be close to zero (far from the interface), the denominator is regularized by adding a small parameter $\\eta = 10^{-12}$:\n$$ \\mathbf{n} = \\frac{\\nabla\\phi}{\\lVert\\nabla\\phi\\rVert_2 + \\eta} $$\n\nThe curvature $\\kappa$ is the divergence of the normal vector field, $\\kappa = \\nabla \\cdot \\mathbf{n}$. This is also computed using second-order periodic centered differences on the components of the discrete $\\mathbf{n}$ field:\n$$ \\kappa_{i,j} = \\left(\\frac{\\partial n_x}{\\partial x}\\right)_{i,j} + \\left(\\frac{\\partial n_y}{\\partial y}\\right)_{i,j} $$\n\nFourth, the Dirac delta distribution $\\delta_s$, which concentrates the force onto the interface, is approximated by a smooth mollifier function $\\delta_\\varepsilon(\\phi)$ with a support half-width of $\\varepsilon = 1.5h$:\n$$ \\delta_\\varepsilon(\\phi) = \\begin{cases}\n   \\dfrac{1}{2\\varepsilon} \\left(1 + \\cos\\left(\\dfrac{\\pi \\phi}{\\varepsilon}\\right)\\right), & \\text{if } |\\phi| \\le \\varepsilon \\\\\n   0, & \\text{otherwise}\n   \\end{cases} $$\nThis function is evaluated at each grid node using the corresponding $\\phi_{i,j}$ value.\n\nFifth, having all components, we compute the CSF body force density field $\\mathbf{f}_s = \\sigma \\kappa \\delta_\\varepsilon(\\phi) \\mathbf{n}$ at each grid node.\n\nSixth, we calculate the two specified invariants.\n1. The RMS curvature error, $E_\\kappa$, is computed over the narrow band $\\mathcal{B}$ where $|\\phi| \\le \\varepsilon$. It measures the deviation of the numerical curvature from the exact analytical value $\\kappa_{\\text{exact}} = 1/R$:\n   $$ E_\\kappa = \\sqrt{\\frac{1}{N_b} \\sum_{(i,j) \\in \\mathcal{B}} \\left(\\kappa_{i,j} - \\frac{1}{R}\\right)^2} $$\n   where $N_b$ is the number of grid nodes in the band $\\mathcal{B}$.\n2. The net surface tension force, $\\mathbf{F}$, is computed by integrating the force density field over the entire domain. The integral is approximated by a sum over all grid cells, where each cell has an area $\\Delta A = h^2$:\n   $$ \\mathbf{F} = \\sum_{i=0}^{N-1} \\sum_{j=0}^{N-1} \\mathbf{f}_{s,i,j} \\, h^2 $$\n   The magnitude of this net force is then $F_{\\text{mag}} = \\lVert \\mathbf{F} \\rVert_2$. Theoretically, this should be zero.\n\nFinally, the geometric conservation error is quantified. For each test case, the procedure above is performed twice:\n1.  **Pre-translation**: The droplet is centered at $(c_x^{\\text{pre}}, c_y^{\\text{pre}}) = (L/2, L/2)$. The invariants $E_\\kappa^{\\text{pre}}$ and $F_{\\text{mag}}^{\\text{pre}}$ are computed.\n2.  **Post-translation**: The droplet center is translated by $(\\Delta x, \\Delta y) = (\\alpha_x h, \\alpha_y h)$. The new center is $(c_x^{\\text{post}}, c_y^{\\text{post}}) = ((L/2 + \\Delta x) \\pmod L, (L/2 + \\Delta y) \\pmod L)$, where the modulo operation ensures periodic wrapping. The invariants $E_\\kappa^{\\text{post}}$ and $F_{\\text{mag}}^{\\text{post}}$ are re-computed.\n\nThe geometric conservation errors are the absolute differences between the pre- and post-translation values:\n$$ \\Delta E_\\kappa = \\left| E_\\kappa^{\\text{post}} - E_\\kappa^{\\text{pre}} \\right| $$\n$$ \\Delta F = \\left| F_{\\text{mag}}^{\\text{post}} - F_{\\text{mag}}^{\\text{pre}} \\right| $$\nThese values, $\\Delta E_\\kappa$ and $\\Delta F$, represent the final result for each test case.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef calculate_invariants(N, L, R, sigma, cx, cy):\n    \"\"\"\n    Computes numerical invariants for a circular droplet on a 2D periodic grid.\n    \n    Args:\n        N (int): Number of grid points in each dimension.\n        L (float): Domain side length in meters.\n        R (float): Droplet radius in meters.\n        sigma (float): Surface tension coefficient in N/m.\n        cx (float): x-coordinate of the droplet center.\n        cy (float): y-coordinate of the droplet center.\n        \n    Returns:\n        tuple: (E_kappa, F_mag)\n            E_kappa (float): RMS curvature error in the interface band.\n            F_mag (float): Magnitude of the net surface tension force.\n    \"\"\"\n    # Grid and numerical parameters\n    h = L / float(N)\n    eps = 1.5 * h\n    eta = 1e-12\n\n    # Grid coordinates (cell-centered)\n    i_coords = np.arange(N)\n    x = (i_coords + 0.5) * h\n    y = (i_coords + 0.5) * h\n    xx, yy = np.meshgrid(x, y, indexing='ij')\n\n    # Signed distance function (SDF) phi\n    phi = np.sqrt((xx - cx)**2 + (yy - cy)**2) - R\n\n    # Gradient of phi (2nd-order centered difference with periodic BC)\n    # np.roll provides periodic boundaries\n    phi_x = (np.roll(phi, -1, axis=0) - np.roll(phi, 1, axis=0)) / (2.0 * h)\n    phi_y = (np.roll(phi, -1, axis=1) - np.roll(phi, 1, axis=1)) / (2.0 * h)\n    \n    # Unit normal vector (regularized)\n    mag_grad_phi = np.sqrt(phi_x**2 + phi_y**2)\n    # Adding eta to the denominator as specified\n    denominator = mag_grad_phi + eta\n    nx = phi_x / denominator\n    ny = phi_y / denominator\n\n    # Curvature (divergence of the normal vector)\n    nx_x = (np.roll(nx, -1, axis=0) - np.roll(nx, 1, axis=0)) / (2.0 * h)\n    ny_y = (np.roll(ny, -1, axis=1) - np.roll(ny, 1, axis=1)) / (2.0 * h)\n    kappa = nx_x + ny_y\n\n    # Invariant 1: Root-mean-square curvature error (E_kappa)\n    band_mask = np.abs(phi) <= eps\n    Nb = np.sum(band_mask)\n    \n    if Nb == 0:\n        E_kappa = 0.0\n    else:\n        kappa_band = kappa[band_mask]\n        kappa_exact = 1.0 / R\n        E_kappa = np.sqrt(np.mean((kappa_band - kappa_exact)**2))\n\n    # Smoothed Dirac delta function\n    delta = np.zeros_like(phi)\n    phi_band = phi[band_mask]\n    delta[band_mask] = (1.0 / (2.0 * eps)) * (1.0 + np.cos(np.pi * phi_band / eps))\n\n    # Continuum Surface Force (CSF) body force density\n    fsx = sigma * kappa * delta * nx\n    fsy = sigma * kappa * delta * ny\n\n    # Invariant 2: Net force magnitude (F_mag)\n    dA = h**2\n    Fx = np.sum(fsx) * dA\n    Fy = np.sum(fsy) * dA\n    F_mag = np.sqrt(Fx**2 + Fy**2)\n\n    return E_kappa, F_mag\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (N, L, R, sigma, alpha_x, alpha_y)\n        (128, 1.0, 0.2, 0.072, 0.0, 0.0),    # Test 1\n        (128, 1.0, 0.2, 0.072, 1.0, 0.0),    # Test 2\n        (128, 1.0, 0.2, 0.072, 0.5, 0.5),    # Test 3\n        (128, 1.0, 0.08, 0.072, 0.5, 0.0),   # Test 4\n        (64, 1.0, 0.2, 0.072, 0.5, 0.0),     # Test 5\n    ]\n\n    results = []\n    for case in test_cases:\n        N, L, R, sigma, alpha_x, alpha_y = case\n        h = L / float(N)\n        \n        # Pre-translation calculation\n        cx_pre = L / 2.0\n        cy_pre = L / 2.0\n        E_kappa_pre, F_mag_pre = calculate_invariants(N, L, R, sigma, cx_pre, cy_pre)\n        \n        # Post-translation calculation\n        delta_x = alpha_x * h\n        delta_y = alpha_y * h\n        \n        # New center with periodic wrapping\n        cx_post = (cx_pre + delta_x) % L\n        cy_post = (cy_pre + delta_y) % L\n        \n        E_kappa_post, F_mag_post = calculate_invariants(N, L, R, sigma, cx_post, cy_post)\n        \n        # Compute absolute deviations\n        delta_E_kappa = np.abs(E_kappa_post - E_kappa_pre)\n        delta_F = np.abs(F_mag_post - F_mag_pre)\n        \n        results.append([delta_E_kappa, delta_F])\n\n    # Final print statement in the exact required format.\n    formatted_results = []\n    for res_pair in results:\n        formatted_results.append(f\"[{res_pair[0]},{res_pair[1]}]\")\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "The previous exercises highlight how standard discretizations can generate spurious forces that disrupt equilibrium. A more advanced approach is to design \"well-balanced\" schemes that are built to preserve known steady-state solutions exactly to machine precision. In a static fluid under gravity, the pressure gradient must precisely balance the gravitational and capillary forces. This final exercise  guides you through the derivation and implementation of a scheme for hydrostatic capillarity that achieves this balance at the discrete level. This practice moves beyond simply analyzing errors to engineering a superior numerical method for static multiphase systems.",
            "id": "3368717",
            "problem": "Consider a two-phase, incompressible, viscousless fluid system at static equilibrium under a uniform gravitational field. The governing momentum balance for zero velocity reduces to a balance between the pressure gradient, gravity, and the capillary force modeled by the Continuum Surface Force (CSF). The Continuum Surface Force (CSF) models the surface tension as a volumetric body force concentrated near the interface by using a smooth indicator function. The objective is to derive and implement a discrete, well-balanced condition that exactly preserves hydrostatic equilibrium with surface tension on a uniform one-dimensional vertical grid.\n\nStarting from the steady, incompressible momentum balance, and taking the vertical coordinate to be $z$, the equilibrium requires the discrete pressure gradient to balance gravity and the CSF-induced capillary force. The CSF representation uses a smooth indicator function $C(z)$ that transitions from one phase to the other across a diffuse interface, and a curvature $ \\kappa $ taken as constant for a spherical-cap interface segment. The mixture density is modeled as $\\rho(C) = \\rho_{\\mathrm{g}} + C \\left(\\rho_{\\mathrm{l}} - \\rho_{\\mathrm{g}}\\right)$ where $\\rho_{\\mathrm{l}}$ is the liquid density and $\\rho_{\\mathrm{g}}$ is the gas density, and the gravitational acceleration is $g$ acting in the positive $z$-direction. The well-balanced condition must be derived from first principles of the integral momentum balance over a control volume and expressed on a uniform grid such that the discrete gradient of pressure, evaluated consistently at faces, balances the corresponding discrete face source terms due to gravity and capillarity.\n\nYour tasks are:\n- Derive a face-consistent discrete equilibrium relation on a uniform grid of $N$ points over a domain of height $H$ in the vertical direction $z \\in [0,H]$, such that the discrete pressure gradient at faces balances the discrete face contributions of gravity and capillary CSF, ensuring exact balance (to floating-point round-off) in hydrostatic equilibrium.\n- Implement the derived discrete relation to compute a discrete pressure field $p(z)$ from given parameters and a prescribed diffuse indicator function $C(z)$ representing a curved interface with constant curvature $ \\kappa $. Use a hyperbolic tangent profile for the indicator function $C(z)$ centered at $z_0$ with interfacial thickness parameter $\\varepsilon$: $C(z) = \\tfrac{1}{2}\\left[1 + \\tanh\\left((z - z_0)/(\\sqrt{2}\\,\\varepsilon)\\right)\\right]$. The curvature $ \\kappa $ is treated as constant and the CSF vertical component is induced by the vertical gradient of $C(z)$.\n- For each test case, compute two quantitative metrics:\n    1. The maximum absolute residual $R_{\\max}$ of the discrete vertical momentum balance across the grid, in $\\mathrm{N/m^3}$.\n    2. The absolute capillary pressure-jump error $E_{\\mathrm{jump}}$, computed as the absolute difference between the discrete capillary contribution integrated across the domain and the theoretical jump $ \\sigma \\kappa $, in $\\mathrm{Pa}$.\n- Express $R_{\\max}$ in $\\mathrm{N/m^3}$ and $E_{\\mathrm{jump}}$ in $\\mathrm{Pa}$, both as floating-point numbers.\n\nUse the following scientifically consistent parameter values for the test suite, which includes sessile and pendant drops with gravity, and two edge cases:\n\n- Domain height $H = 0.01\\,\\mathrm{m}$, number of grid points $N = 200$, interfacial thickness $\\varepsilon = 2\\times 10^{-4}\\,\\mathrm{m}$, liquid density $\\rho_{\\mathrm{l}} = 1000\\,\\mathrm{kg/m^3}$, gas density $\\rho_{\\mathrm{g}} = 1\\,\\mathrm{kg/m^3}$, surface tension coefficient $\\sigma$ and curvature $\\kappa$ as specified per case, gravitational acceleration magnitude $g$ as specified per case.\n- Indicator function $C(z)$ is centered at $z_0$ per case.\n\nTest suite:\n1. Sessile drop: $z_0 = 0.003\\,\\mathrm{m}$, $\\sigma = 0.072\\,\\mathrm{N/m}$, $\\kappa = 2000\\,\\mathrm{m^{-1}}$, $g = 9.81\\,\\mathrm{m/s^2}$.\n2. Pendant drop: $z_0 = 0.007\\,\\mathrm{m}$, $\\sigma = 0.072\\,\\mathrm{N/m}$, $\\kappa = 2000\\,\\mathrm{m^{-1}}$, $g = 9.81\\,\\mathrm{m/s^2}$.\n3. Zero gravity edge case: $z_0 = 0.005\\,\\mathrm{m}$, $\\sigma = 0.072\\,\\mathrm{N/m}$, $\\kappa = 2000\\,\\mathrm{m^{-1}}$, $g = 0.0\\,\\mathrm{m/s^2}$.\n4. Zero surface tension edge case: $z_0 = 0.005\\,\\mathrm{m}$, $\\sigma = 0.0\\,\\mathrm{N/m}$, $\\kappa = 2000\\,\\mathrm{m^{-1}}$, $g = 9.81\\,\\mathrm{m/s^2}$.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, ordered as $[R_{\\max}^{(1)},E_{\\mathrm{jump}}^{(1)},R_{\\max}^{(2)},E_{\\mathrm{jump}}^{(2)},R_{\\max}^{(3)},E_{\\mathrm{jump}}^{(3)},R_{\\max}^{(4)},E_{\\mathrm{jump}}^{(4)}]$, where the superscript indicates the test case number. For example, the output should look like $[r_1,e_1,r_2,e_2,r_3,e_3,r_4,e_4]$.",
            "solution": "The analysis and solution of this problem are predicated on the principles of hydrostatic equilibrium in a multi-phase fluid system, where pressure gradients are balanced by body forces, namely gravity and surface tension. The surface tension force is modeled using the Continuum Surface Force (CSF) method, which represents it as a continuous volumetric force acting in the vicinity of the interface. A well-balanced numerical scheme is one that maintains this equilibrium exactly at the discrete level, preventing the generation of spurious numerical artifacts such as non-physical velocities.\n\n### Derivation of the Well-Balanced Condition\n\nThe problem begins with the one-dimensional steady, incompressible, and viscousless momentum equation in the vertical $z$-direction. At static equilibrium ($\\mathbf{v}=0$), the pressure gradient balances the body forces:\n$$\n\\frac{dp}{dz} = F_z\n$$\nwhere $F_z$ is the total vertical component of the body force density. The body forces considered are gravity and surface tension.\n\nThe gravitational body force density is $\\rho \\mathbf{g}$. The problem specifies a uniform gravitational acceleration $g$ acting in the positive $z$-direction, so $\\mathbf{g} = g \\hat{\\mathbf{z}}$. The vertical component of the gravitational force density is thus $\\rho(z) g$. The density $\\rho(z)$ is a function of the indicator function $C(z)$ and is given by the mixture model:\n$$\n\\rho(C) = \\rho_{\\mathrm{g}} + C (\\rho_{\\mathrm{l}} - \\rho_{\\mathrm{g}})\n$$\nwhere $\\rho_{\\mathrm{l}}$ and $\\rho_{\\mathrm{g}}$ are the liquid and gas densities, respectively.\n\nThe surface tension force is modeled using the CSF formulation, expressed as a volume force $\\mathbf{f}_{\\text{CSF}} = \\sigma \\kappa \\nabla C$, where $\\sigma$ is the surface tension coefficient, $\\kappa$ is the interface curvature (assumed constant), and $C$ is the smooth indicator function. The vertical component of this force density is:\n$$\nf_{\\text{CSF}, z} = \\sigma \\kappa \\frac{dC}{dz}\n$$\nCombining these forces, the total force density in the $z$-direction is $F_z = \\rho(C(z)) g + \\sigma \\kappa \\frac{dC}{dz}$. The 1D hydrostatic balance equation is therefore:\n$$\n\\frac{dp}{dz} = g \\left( \\rho_{\\mathrm{g}} + C(z) (\\rho_{\\mathrm{l}} - \\rho_{\\mathrm{g}}) \\right) + \\sigma \\kappa \\frac{dC}{dz}\n$$\nTo derive a well-balanced scheme, we can rearrange this equation by grouping terms that are exact differentials. We can write $\\sigma \\kappa \\frac{dC}{dz}$ as $\\frac{d}{dz}(\\sigma \\kappa C)$. This allows us to rewrite the equation as:\n$$\n\\frac{dp}{dz} - \\frac{d}{dz}(\\sigma \\kappa C) = g \\rho(C(z))\n$$\n$$\n\\frac{d}{dz} \\left( p - \\sigma \\kappa C \\right) = g \\rho(C(z))\n$$\nThis form is highly advantageous for numerical integration. Let's define a modified pressure $p^*(z) = p(z) - \\sigma \\kappa C(z)$. The equation simplifies to $\\frac{dp^*}{dz} = g \\rho(C(z))$.\n\nWe can now integrate this equation from a reference position, say $z=0$, to an arbitrary position $z$:\n$$\n\\int_0^z \\frac{dp^*}{dz'} dz' = \\int_0^z g \\rho(C(z')) dz'\n$$\n$$\np^*(z) - p^*(0) = g \\int_0^z \\rho(C(z')) dz'\n$$\nSubstituting back $p(z)$ and $p(0)$:\n$$\n(p(z) - \\sigma \\kappa C(z)) - (p(0) - \\sigma \\kappa C(0)) = g \\int_0^z \\rho(C(z')) dz'\n$$\nSolving for $p(z)$ gives the hydrostatic pressure field:\n$$\np(z) = p(0) + \\sigma \\kappa (C(z) - C(0)) + g \\int_0^z \\rho(C(z')) dz'\n$$\nBy setting a reference pressure, for instance $p(0)=0$, we can compute the pressure at any point $z$ by numerically evaluating the integral.\n\n### Discrete Implementation\n\nWe discretize the domain $z \\in [0, H]$ using $N$ uniformly spaced points $z_j = j \\Delta z$ for $j=0, 1, \\dots, N-1$, where the grid spacing is $\\Delta z = H / (N-1)$. The discrete pressure at each point $j$ is denoted $p_j = p(z_j)$.\n\nThe pressure field $p_j$ is computed by discretizing the analytical solution. The integral term is approximated using the cumulative trapezoidal rule for high accuracy. Let $G(z) = g \\int_0^z \\rho(C(z')) dz'$. Then the discrete counterpart $G_j = G(z_j)$ can be computed recursively:\n$$\nG_0 = 0\n$$\n$$\nG_j = G_{j-1} + g \\int_{z_{j-1}}^{z_j} \\rho(C(z')) dz' \\approx G_{j-1} + g \\frac{\\rho(C_{j-1}) + \\rho(C_j)}{2} \\Delta z \\quad \\text{for } j \\ge 1\n$$\nwhere $C_j = C(z_j)$ and $\\rho_j = \\rho(C_j)$. The discrete pressure field, with reference pressure $p_0=0$, is then:\n$$\np_j = \\sigma \\kappa (C_j - C_0) + G_j\n$$\nThis method of constructing the pressure field inherently satisfies the integrated form of the hydrostatic balance equation and forms the basis of our well-balanced scheme.\n\n### Calculation of Metrics\n\n**1. Maximum Absolute Residual ($R_{\\max}$)**\n\nThe residual measures how well the computed pressure field satisfies a discrete form of the original differential equation, $\\frac{dp}{dz} = F_z$. A face-consistent finite difference approximation on the staggered grid (with pressures at cell centers $j, j+1$ and the gradient/fluxes at the face $j+1/2$) is:\n$$\n\\left( \\frac{\\delta p}{\\delta z} \\right)_{j+1/2} = (\\text{Source Term})_{j+1/2}\n$$\nThe pressure gradient at face $j+1/2$ is naturally approximated as $\\frac{p_{j+1} - p_j}{\\Delta z}$. The source terms are consistently evaluated at the face by averaging the cell-centered values for gravity and using a difference for the CSF term:\n$$\n\\frac{p_{j+1} - p_j}{\\Delta z} = g \\frac{\\rho_j + \\rho_{j+1}}{2} + \\sigma \\kappa \\frac{C_{j+1} - C_j}{\\Delta z}\n$$\nThe discrete residual at each interior face $j+1/2$ (for $j=0, \\dots, N-2$) is:\n$$\nR_{j+1/2} = \\left(\\frac{p_{j+1} - p_j}{\\Delta z}\\right) - \\left(g \\frac{\\rho_j + \\rho_{j+1}}{2} + \\sigma \\kappa \\frac{C_{j+1} - C_j}{\\Delta z}\\right)\n$$\nBy substituting the expression for $p_j$ derived from the well-balanced construction, we find:\n$$\np_{j+1} - p_j = \\left( \\sigma\\kappa(C_{j+1}-C_0) + G_{j+1} \\right) - \\left( \\sigma\\kappa(C_j-C_0) + G_j \\right) = \\sigma\\kappa(C_{j+1}-C_j) + (G_{j+1}-G_j)\n$$\nFrom the trapezoidal rule definition of $G_j$, we have $G_{j+1}-G_j = g \\frac{\\rho_j + \\rho_{j+1}}{2} \\Delta z$. Substituting this in:\n$$\np_{j+1} - p_j = \\sigma\\kappa(C_{j+1}-C_j) + g \\frac{\\rho_j + \\rho_{j+1}}{2} \\Delta z\n$$\nDividing by $\\Delta z$ shows that this is identical to the discrete momentum balance. Thus, the residual $R_{j+1/2}$ is analytically zero, and will be non-zero only due to floating-point round-off errors. We compute $R_{\\max} = \\max_{j} |R_{j+1/2}|$.\n\n**2. Absolute Capillary Pressure-Jump Error ($E_{\\mathrm{jump}}$)**\n\nThe theoretical pressure jump across an interface due to surface tension is given by the Young-Laplace equation, $\\Delta p = \\sigma \\kappa$. The CSF model approximates this. The total pressure change due to the CSF force across the domain is $\\int_0^H f_{\\text{CSF},z} dz = \\int_0^H \\sigma \\kappa \\frac{dC}{dz} dz$.\n\nThe problem asks for the \"discrete capillary contribution integrated across the domain\". This can be computed by summing the discrete face-based CSF force densities, $F_{\\text{CSF}, j+1/2} = \\sigma \\kappa \\frac{C_{j+1}-C_j}{\\Delta z}$, over the domain, multiplied by the grid spacing $\\Delta z$:\n$$\n\\Delta P_{\\text{cap, discrete}} = \\sum_{j=0}^{N-2} \\left( \\sigma \\kappa \\frac{C_{j+1} - C_j}{\\Delta z} \\right) \\Delta z = \\sigma \\kappa \\sum_{j=0}^{N-2} (C_{j+1} - C_j)\n$$\nThis is a telescoping sum which simplifies to:\n$$\n\\Delta P_{\\text{cap, discrete}} = \\sigma \\kappa (C_{N-1} - C_0)\n$$\nThe error $E_{\\mathrm{jump}}$ is the absolute difference between this discrete integrated value and the theoretical jump $\\sigma \\kappa$:\n$$\nE_{\\mathrm{jump}} = |\\Delta P_{\\text{cap, discrete}} - \\sigma \\kappa| = |\\sigma \\kappa (C_{N-1} - C_0) - \\sigma \\kappa| = \\sigma \\kappa |C_{N-1} - C_0 - 1|\n$$\nThis error arises because the finite domain $[0, H]$ does not span from $-\\infty$ to $+\\infty$, so $C(z=0)$ is not exactly $0$ and $C(z=H)$ is not exactly $1$. The magnitude of this error depends on how close the indicator function values at the boundaries are to their asymptotic limits.\nThe indicator function is given as:\n$$\nC(z) = \\frac{1}{2}\\left[1 + \\tanh\\left(\\frac{z - z_0}{\\sqrt{2}\\,\\varepsilon}\\right)\\right]\n$$\nThis function will be evaluated at each grid point $z_j$ for the specified parameters in each test case.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Derives and implements a discrete, well-balanced condition for hydrostatic\n    equilibrium with surface tension on a 1D vertical grid.\n    \"\"\"\n\n    # --- Problem Parameters ---\n    H = 0.01  # Domain height [m]\n    N = 200   # Number of grid points\n    eps = 2e-4  # Interfacial thickness parameter [m]\n    rho_l = 1000.0  # Liquid density [kg/m^3]\n    rho_g = 1.0  # Gas density [kg/m^3]\n\n    # --- Test Suite ---\n    test_cases = [\n        # (z0 [m], sigma [N/m], kappa [m^-1], g [m/s^2])\n        (0.003, 0.072, 2000.0, 9.81),  # 1. Sessile drop\n        (0.007, 0.072, 2000.0, 9.81),  # 2. Pendant drop\n        (0.005, 0.072, 2000.0, 0.0),   # 3. Zero gravity\n        (0.005, 0.0,   2000.0, 9.81),   # 4. Zero surface tension\n    ]\n\n    results = []\n\n    # --- Grid Setup ---\n    z = np.linspace(0, H, N)\n    delta_z = H / (N - 1)\n\n    # --- Helper Function for Indicator C(z) ---\n    def indicator_function(z, z0, epsilon):\n        arg = (z - z0) / (np.sqrt(2.0) * epsilon)\n        return 0.5 * (1.0 + np.tanh(arg))\n\n    for z0, sigma, kappa, g in test_cases:\n        # --- 1. Compute Base Quantities ---\n        C = indicator_function(z, z0, eps)\n        rho = rho_g + C * (rho_l - rho_g)\n\n        # --- 2. Compute Hydrostatic Pressure Field (Well-Balanced) ---\n        # Compute gravitational potential pressure term G using cumulative trapezoidal rule\n        # G[j] = integral from 0 to z_j of (g * rho(z')) dz'\n        G = np.zeros(N)\n        integrand_g = g * rho\n        # G[j+1] = G[j] + g * (rho[j]+rho[j+1])/2 * delta_z\n        G[1:] = np.cumsum(g * (rho[:-1] + rho[1:]) / 2.0 * delta_z)\n\n        # Compute pressure field p with reference p(0)=0\n        # p[j] = p[0] + sigma*kappa*(C[j]-C[0]) + G[j]\n        # p[0] is reference pressure, let p[0] = 0.\n        # However, the calculation of p[0] itself requires G[0], which is 0.\n        # So p[0] = sigma*kappa*(C[0]-C[0]) + G[0] = 0.\n        # The choice of p_ref=0 is implicitly made here.\n        p = sigma * kappa * (C - C[0]) + G\n\n        # --- 3. Calculate Maximum Absolute Residual (R_max) ---\n        # Residual R at face j+1/2:\n        # R = (p[j+1]-p[j])/dz - (g*(rho[j]+rho[j+1])/2 + sigma*k*(C[j+1]-C[j])/dz)\n        # This will be calculated for all N-1 faces.\n        grad_p_discrete = (p[1:] - p[:-1]) / delta_z\n        source_g_discrete = g * (rho[:-1] + rho[1:]) / 2.0\n        source_csf_discrete = sigma * kappa * (C[1:] - C[:-1]) / delta_z\n\n        residuals = grad_p_discrete - (source_g_discrete + source_csf_discrete)\n        R_max = np.max(np.abs(residuals))\n        results.append(R_max)\n\n        # --- 4. Calculate Absolute Capillary Pressure-Jump Error (E_jump) ---\n        # Theoretical jump (infinite domain) is sigma * kappa\n        theoretical_jump = sigma * kappa\n\n        # Discrete integrated jump (over finite domain [0, H])\n        # sum_{j=0}^{N-2} (sigma*k*(C[j+1]-C[j])/dz) * dz\n        # = sigma * kappa * (C[N-1] - C[0])\n        discrete_jump = sigma * kappa * (C[-1] - C[0])\n\n        E_jump = np.abs(discrete_jump - theoretical_jump)\n        results.append(E_jump)\n\n    # --- Final Output Formatting ---\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}