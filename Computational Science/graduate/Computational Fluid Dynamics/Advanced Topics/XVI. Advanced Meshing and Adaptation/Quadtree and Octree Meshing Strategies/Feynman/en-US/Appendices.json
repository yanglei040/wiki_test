{
    "hands_on_practices": [
        {
            "introduction": "A non-negotiable property of any robust finite volume method is its ability to strictly conserve quantities like mass, momentum, and energy. On adaptive grids, special care must be taken at interfaces between coarse and fine cells, where \"hanging nodes\" appear. This exercise  challenges you to derive a specialized numerical flux formula that maintains discrete conservation to machine precision across these refinement levels, a fundamental technique for building reliable Adaptive Mesh Refinement (AMR) solvers.",
            "id": "3355466",
            "problem": "Consider a two-dimensional Computational Fluid Dynamics (CFD) transport of a passive scalar field $u(x,y,t)$ governed by a linear advection equation with constant velocity field $\\boldsymbol{v} = (v_{n}, 0)$ so that the face-normal advection flux density across a vertical face is $q(y) = v_{n} \\, u(y)$, where $v_{n}$ is the constant normal component of $\\boldsymbol{v}$. In a cell-centered Finite Volume Method (FVM), the flux through a face is the integral of the face-normal flux density along that face. Now consider an Adaptive Mesh Refinement (AMR) quadtree where a single coarse vertical face of length $h$ abuts two fine child cells, so that the coarse face is split into two equal fine subfaces of length $h/2$ each, with hanging nodes at the midpoints of the subfaces. Let the transverse coordinate $y$ be measured along the face with origin at the centroid of the coarse face and bounds $y \\in [-h/2, h/2]$. The centroids of the two fine subfaces are located at $y_{-} = -h/4$ and $y_{+} = +h/4$, and the coarse face centroid is at $y_{0} = 0$.\n\nTo guarantee face-normal flux equality among the two fine siblings and conservation to machine precision across levels, you are tasked to design a single shared normal flux density $q^{\\star}$ to be applied identically to both fine subfaces, such that the total flux through the coarse face equals the sum of the fluxes through the two fine subfaces. Assume a second-order cell-centered reconstruction of $u$ on both levels, and define the samples $u_{-} = u(y_{-})$, $u_{0} = u(y_{0})$, and $u_{+} = u(y_{+})$ as the reconstructed values at the subface centroids and the coarse face centroid, respectively. Your goal is to determine constant dimensionless weights $w_{-}$, $w_{0}$, $w_{+}$ such that the shared flux density\n$$\nq^{\\star} \\;=\\; v_{n} \\,\\big( w_{-}\\,u_{-} \\;+\\; w_{0}\\,u_{0} \\;+\\; w_{+}\\,u_{+} \\big)\n$$\napproximates the face-average of $q(y)$ with an error consistent with a second-order finite-volume scheme, while strictly enforcing a single face-normal flux value for both siblings.\n\nStarting from the integral form of conservation and the definition of face-averaged flux, determine the weights $w_{-}$, $w_{0}$, $w_{+}$ by requiring that $q^{\\star}$ reproduces the exact face-average of $q(y)$ for any polynomial $u(y)$ of degree at most $2$. Express your final answer as a single row matrix containing $(w_{-}, w_{0}, w_{+})$. No rounding is required and no units are needed in the final answer.",
            "solution": "The problem requires the determination of three dimensionless weights, $w_{-}$, $w_{0}$, and $w_{+}$, for constructing a shared face-normal flux density $q^{\\star}$ at an interface between a coarse cell and two fine cells in a quadtree-based adaptive mesh. The construction must ensure flux conservation and maintain a certain order of accuracy.\n\nFirst, we establish the fundamental condition for flux conservation. In a cell-centered Finite Volume Method, the flux through a face is the integral of the face-normal flux density over that face. The problem considers a coarse face of length $h$ subdivided into two fine subfaces, each of length $h/2$. A single shared flux density, $q^{\\star}$, is to be used for both fine subfaces.\n\nThe total flux through the coarse face, $F_{\\text{coarse}}$, is given by the integral of the flux density $q(y) = v_{n} u(y)$ over the coarse face interval $y \\in [-h/2, h/2]$:\n$$\nF_{\\text{coarse}} = \\int_{-h/2}^{h/2} q(y) \\, dy = v_n \\int_{-h/2}^{h/2} u(y) \\, dy\n$$\nThe sum of the fluxes through the two fine subfaces, $F_{\\text{fine}}$, using the shared constant flux density $q^{\\star}$, is:\n$$\nF_{\\text{fine}} = q^{\\star} \\times (\\text{length of subface 1}) + q^{\\star} \\times (\\text{length of subface 2}) = q^{\\star} \\left(\\frac{h}{2}\\right) + q^{\\star} \\left(\\frac{h}{2}\\right) = q^{\\star} h\n$$\nThe principle of conservation requires that the total flux is conserved across the refinement interface, i.e., $F_{\\text{coarse}} = F_{\\text{fine}}$.\n$$\nv_n \\int_{-h/2}^{h/2} u(y) \\, dy = q^{\\star} h\n$$\nThis implies that the shared flux density $q^{\\star}$ must be equal to the face-averaged flux density over the coarse face:\n$$\nq^{\\star} = \\frac{v_n}{h} \\int_{-h/2}^{h/2} u(y) \\, dy\n$$\nThe problem provides an explicit formula for $q^{\\star}$ in terms of three sampled values of the scalar field $u(y)$:\n$$\nq^{\\star} = v_{n} \\left( w_{-}\\,u_{-} + w_{0}\\,u_{0} + w_{+}\\,u_{+} \\right)\n$$\nwhere $u_{-} = u(y_{-}) = u(-h/4)$, $u_{0} = u(y_{0}) = u(0)$, and $u_{+} = u(y_{+}) = u(h/4)$.\n\nCombining these two expressions for $q^{\\star}$ and assuming the advection velocity $v_n$ is non-zero, we obtain the central equation for the weights:\n$$\nw_{-}\\,u(-h/4) + w_{0}\\,u(0) + w_{+}\\,u(h/4) = \\frac{1}{h} \\int_{-h/2}^{h/2} u(y) \\, dy\n$$\nThis equation must hold for any polynomial $u(y)$ of degree at most $2$. To find the three unknown weights $w_{-}$, $w_{0}$, and $w_{+}$, we will enforce this condition for a basis of the vector space of polynomials of degree at most $2$. A convenient basis is $\\{1, y, y^2\\}$.\n\nCase 1: $u(y) = 1$ (degree $0$)\nThe sampled values are $u(-h/4) = 1$, $u(0) = 1$, and $u(h/4) = 1$. The left-hand side (LHS) of the equation becomes:\n$$\n\\text{LHS} = w_{-}(1) + w_{0}(1) + w_{+}(1) = w_{-} + w_{0} + w_{+}\n$$\nThe right-hand side (RHS) is the average of $u(y)=1$ over the interval:\n$$\n\\text{RHS} = \\frac{1}{h} \\int_{-h/2}^{h/2} 1 \\, dy = \\frac{1}{h} [y]_{-h/2}^{h/2} = \\frac{1}{h} \\left(\\frac{h}{2} - \\left(-\\frac{h}{2}\\right)\\right) = 1\n$$\nThis gives our first linear equation:\n$$\nw_{-} + w_{0} + w_{+} = 1 \\quad (1)\n$$\n\nCase 2: $u(y) = y$ (degree $1$)\nThe sampled values are $u(-h/4) = -h/4$, $u(0) = 0$, and $u(h/4) = h/4$. The LHS becomes:\n$$\n\\text{LHS} = w_{-}\\left(-\\frac{h}{4}\\right) + w_{0}(0) + w_{+}\\left(\\frac{h}{4}\\right) = \\frac{h}{4}(-w_{-} + w_{+})\n$$\nThe RHS is the average of the odd function $u(y)=y$ over a symmetric interval, which is zero:\n$$\n\\text{RHS} = \\frac{1}{h} \\int_{-h/2}^{h/2} y \\, dy = \\frac{1}{h} \\left[\\frac{y^2}{2}\\right]_{-h/2}^{h/2} = \\frac{1}{2h} \\left(\\left(\\frac{h}{2}\\right)^2 - \\left(-\\frac{h}{2}\\right)^2\\right) = 0\n$$\nSince $h \\neq 0$, the resulting equation is:\n$$\n-w_{-} + w_{+} = 0 \\implies w_{-} = w_{+} \\quad (2)\n$$\n\nCase 3: $u(y) = y^2$ (degree $2$)\nThe sampled values are $u(-h/4) = (-h/4)^2 = h^2/16$, $u(0) = 0^2 = 0$, and $u(h/4) = (h/4)^2 = h^2/16$. The LHS becomes:\n$$\n\\text{LHS} = w_{-}\\left(\\frac{h^2}{16}\\right) + w_{0}(0) + w_{+}\\left(\\frac{h^2}{16}\\right) = \\frac{h^2}{16}(w_{-} + w_{+})\n$$\nThe RHS is the average of $u(y)=y^2$:\n$$\n\\text{RHS} = \\frac{1}{h} \\int_{-h/2}^{h/2} y^2 \\, dy = \\frac{1}{h} \\left[\\frac{y^3}{3}\\right]_{-h/2}^{h/2} = \\frac{1}{3h} \\left(\\left(\\frac{h}{2}\\right)^3 - \\left(-\\frac{h}{2}\\right)^3\\right) = \\frac{1}{3h} \\left(\\frac{h^3}{8} + \\frac{h^3}{8}\\right) = \\frac{2h^3}{24h} = \\frac{h^2}{12}\n$$\nEquating the LHS and RHS and canceling the $h^2$ term (since $h \\neq 0$):\n$$\n\\frac{1}{16}(w_{-} + w_{+}) = \\frac{1}{12} \\implies w_{-} + w_{+} = \\frac{16}{12} = \\frac{4}{3} \\quad (3)\n$$\n\nNow we solve the system of three linear equations for $w_{-}$, $w_{0}$, and $w_{+}$:\n1. $w_{-} + w_{0} + w_{+} = 1$\n2. $w_{-} = w_{+}$\n3. $w_{-} + w_{+} = 4/3$\n\nSubstitute equation (2) into (3):\n$$\nw_{+} + w_{+} = \\frac{4}{3} \\implies 2w_{+} = \\frac{4}{3} \\implies w_{+} = \\frac{2}{3}\n$$\nFrom equation (2), it follows that:\n$$\nw_{-} = \\frac{2}{3}\n$$\nFinally, substitute the values of $w_{-}$ and $w_{+}$ into equation (1) to find $w_{0}$:\n$$\n\\frac{2}{3} + w_{0} + \\frac{2}{3} = 1 \\implies w_{0} + \\frac{4}{3} = 1 \\implies w_{0} = 1 - \\frac{4}{3} = -\\frac{1}{3}\n$$\nThus, the required weights are $w_{-} = 2/3$, $w_{0} = -1/3$, and $w_{+} = 2/3$. The problem asks for the answer as a single row matrix $(w_{-}, w_{0}, w_{+})$.",
            "answer": "$$\\boxed{\\begin{pmatrix} \\frac{2}{3} & -\\frac{1}{3} & \\frac{2}{3} \\end{pmatrix}}$$"
        },
        {
            "introduction": "While quadtree and octree grids excel at automating mesh generation around complex geometries via cut-cell methods, this flexibility introduces significant challenges for numerical stability. This practice explores the infamous \"small cell problem,\" a severe time-step restriction that can cripple the efficiency of solvers using explicit time integration. By analyzing an idealized cut-cell geometry , you will derive from first principles why the stable time step can become prohibitively small, providing essential insight into a critical limitation of these methods.",
            "id": "3355418",
            "problem": "Consider the two-dimensional constant-coefficient linear advection equation $\\partial_{t} q + \\nabla \\cdot (\\mathbf{u}\\, q) = 0$ with constant velocity $\\mathbf{u} = (u_{x}, u_{y})$ on a quadtree grid. The quadtree leaves are axis-aligned squares of side length $h$. The equation is discretized by a first-order finite volume method with forward Euler time integration and upwind numerical fluxes. It is a well-tested fact that for such explicit finite volume schemes on arbitrary polygonal cells, a local Courant–Friedrichs–Lewy (CFL) stability condition can be expressed as $\\Delta t \\le \\nu \\, V / \\sum_{f} |\\mathbf{u}\\cdot \\mathbf{n}_{f}|\\,A_{f}$, where $V$ is the cell area, the sum is over all faces $f$ of the cell that exchange flux with neighboring fluid, $A_{f}$ is the face length, $\\mathbf{n}_{f}$ is the unit normal to face $f$, and $\\nu \\in (0,1)$ is the Courant number.\n\nFocus on a single quadtree leaf cell that is intersected by a straight impermeable solid boundary. The cut creates a small fluid control volume (a cut-cell) inside the leaf. You may assume that the solid boundary enforces zero normal mass flux across the cut interface so that only faces that abut fluid neighbors contribute to the flux sum.\n\nTask A (stability scaling): Specialize the CFL stability bound to the case where the cut-cell is a thin, face-parallel sliver of fluid of thickness $\\varepsilon \\ll h$, created by a straight boundary parallel to one cell edge. Place coordinates so that the uncut square is $\\{(x,y): 0 \\le x \\le h,\\, 0 \\le y \\le h\\}$ and the impermeable boundary lies along the line $y=\\varepsilon$; the fluid occupies $\\{(x,y): 0 \\le x \\le h,\\, 0 \\le y \\le \\varepsilon\\}$. Starting from the fundamental finite volume CFL bound described above, show from first principles that in this configuration the explicit stability limit scales linearly with the cut-cell area, i.e., $\\Delta t \\propto V_{\\min}$ as $\\varepsilon \\to 0$ at fixed $h$.\n\nTask B (geometric scaling of $V_{\\min}$): Derive the dependence of the cut-cell area $V$ on the relative position of the cutting boundary within a quadtree leaf in two representative cases:\n- Face-parallel sliver: for the configuration described above, express $V$ in terms of $h$ and $\\varepsilon$.\n- Corner-grazing wedge: let the boundary be a straight line at signed normal distance $\\varepsilon$ from the lower-left corner of the cell and let its unit normal make an angle $\\theta \\in (0,\\pi/2)$ with the positive $x$-axis. The fluid cut-cell is then a right triangle whose legs lie along the coordinate axes. Express $V$ as a function of $\\varepsilon$ and $\\theta$.\n\nFinally, for the face-parallel sliver configuration, express the exact maximum stable time step $\\Delta t_{\\max}$ as a closed-form analytic expression in terms of $V_{\\min}$, $h$, $|u_{x}|$, $|u_{y}|$, and $\\nu$. Provide this final expression. No numerical values are required; give the expression symbolically. Express the final answer with no units inside the expression.",
            "solution": "We begin from the explicit finite volume discretization for a hyperbolic conservation law on a polygonal control volume. For first-order upwind fluxes with forward Euler time integration on a control volume of area $V$, a standard form of the local Courant–Friedrichs–Lewy (CFL) time-step restriction is\n$$\n\\Delta t \\le \\nu \\, \\frac{V}{\\sum_{f} |\\lambda_{f}|\\, A_{f}},\n$$\nwhere the sum is over faces $f$, $A_{f}$ is the face length, and $|\\lambda_{f}|$ is the maximum signal speed normal to face $f$. For constant-coefficient linear advection with velocity $\\mathbf{u}=(u_{x},u_{y})$, the characteristic speed normal to face $f$ is $|\\lambda_{f}| = |\\mathbf{u}\\cdot \\mathbf{n}_{f}|$. For an impermeable solid boundary, the normal flux is zero on the cut interface, so cut faces that coincide with the solid boundary do not appear in the flux sum.\n\nTask A: Specialization to a face-parallel sliver cut-cell and scaling of $\\Delta t$ with $V_{\\min}$.\n\nPlace coordinates on a quadtree leaf so that the uncut square cell is $\\{(x,y): 0 \\le x \\le h,\\; 0 \\le y \\le h\\}$ and the impermeable boundary is the line $y=\\varepsilon$, with $0<\\varepsilon \\ll h$. The fluid cut-cell region is then $\\{(x,y): 0\\le x\\le h,\\; 0\\le y\\le \\varepsilon\\}$, which is a rectangle of width $h$ and height $\\varepsilon$.\n\nThe area of the fluid cut-cell is\n$$\nV \\;=\\; h \\,\\varepsilon.\n$$\nThe faces of this fluid sliver that abut fluid neighbors are: the bottom face at $y=0$, with outward normal $\\mathbf{n}=(0,-1)$ and length $A_{\\text{bottom}}=h$; and the two vertical side faces at $x=0$ and $x=h$, with outward normals $\\mathbf{n}=(-1,0)$ and $\\mathbf{n}=(1,0)$, each of length $A_{\\text{side}}=\\varepsilon$. The top face at $y=\\varepsilon$ is impermeable (solid boundary), so it contributes no flux in this linear advection model with wall-normal velocity set to zero.\n\nThus the flux-sum in the denominator of the CFL bound is\n$$\n\\sum_{f} |\\mathbf{u}\\cdot \\mathbf{n}_{f}|\\,A_{f}\n\\;=\\;\n|\\mathbf{u}\\cdot(0,-1)|\\, h \\;+\\; |\\mathbf{u}\\cdot(-1,0)|\\, \\varepsilon \\;+\\; |\\mathbf{u}\\cdot(1,0)|\\, \\varepsilon\n\\;=\\;\n|u_{y}|\\, h \\;+\\; 2\\,|u_{x}|\\, \\varepsilon.\n$$\nTherefore the exact local stability limit for the face-parallel sliver is\n$$\n\\Delta t_{\\max} \\;=\\; \\nu \\, \\frac{V}{|u_{y}|\\, h \\;+\\; 2\\,|u_{x}|\\, \\varepsilon}\n\\;=\\;\n\\nu \\, \\frac{h\\,\\varepsilon}{|u_{y}|\\, h \\;+\\; 2\\,|u_{x}|\\, \\varepsilon}.\n$$\nAs $\\varepsilon \\to 0$ at fixed $h$ and fixed $|u_{x}|,|u_{y}|$, the denominator is dominated by the term $|u_{y}|\\, h$, giving the asymptotic scaling\n$$\n\\Delta t_{\\max} \\;\\sim\\; \\nu \\, \\frac{h\\,\\varepsilon}{|u_{y}|\\, h} \\;=\\; \\nu \\, \\frac{\\varepsilon}{|u_{y}|}.\n$$\nSince $V = h\\,\\varepsilon$, this asymptotic behavior is equivalently\n$$\n\\Delta t_{\\max} \\;\\sim\\; \\nu \\, \\frac{V}{|u_{y}|\\, h},\n$$\nwhich shows that the explicit stability limit is proportional to the cut-cell area $V$ in the thin-sliver limit. This establishes the claim that explicit time stepping can require $\\Delta t \\propto V_{\\min}$ for stability in the presence of face-parallel sliver cut-cells.\n\nTask B: Geometric scaling of $V_{\\min}$ with boundary position within a quadtree leaf.\n\nWe derive the area scaling for two representative placements of a straight boundary within a quadtree square.\n\nFace-parallel sliver: As above, a boundary at distance $\\varepsilon$ from and parallel to a cell edge produces a rectangular fluid region of height $\\varepsilon$ and width $h$, hence\n$$\nV(\\varepsilon; \\text{parallel to face}) \\;=\\; h\\,\\varepsilon,\n$$\nwhich is linear in the distance $\\varepsilon$ to the face.\n\nCorner-grazing wedge: Consider the lower-left corner at the origin $(0,0)$ of the square. Let the boundary be a straight line whose unit normal is $\\mathbf{n}=(\\cos\\theta,\\sin\\theta)$ with $\\theta \\in (0,\\pi/2)$, located at signed normal distance $\\varepsilon>0$ from the origin, so the line is $\\mathbf{n}\\cdot \\mathbf{x} = \\varepsilon$. The intercept of this line with the $x$-axis is found by setting $y=0$, giving $x = \\varepsilon/\\cos\\theta$. Likewise, the intercept with the $y$-axis is at $y=\\varepsilon/\\sin\\theta$. For sufficiently small $\\varepsilon$ these intercepts lie within the square, and the fluid region near the corner is a right triangle with legs of lengths $\\varepsilon/\\cos\\theta$ and $\\varepsilon/\\sin\\theta$ along the coordinate axes. Its area is\n$$\nV(\\varepsilon,\\theta; \\text{near corner}) \\;=\\; \\frac{1}{2}\\,\\frac{\\varepsilon}{\\cos\\theta}\\,\\frac{\\varepsilon}{\\sin\\theta}\n\\;=\\;\n\\frac{\\varepsilon^{2}}{2\\,\\sin\\theta\\,\\cos\\theta},\n$$\nwhich is quadratic in the distance $\\varepsilon$ to the corner along the boundary normal. This demonstrates that, depending on the relative placement of the boundary inside the quadtree cell, the minimal cut-cell area may scale linearly with the distance to a face or quadratically with the distance to a corner.\n\nFinal expression in terms of $V_{\\min}$: For the face-parallel sliver configuration, we may express the exact stability limit directly in terms of $V_{\\min}$. Using $V_{\\min} = h\\,\\varepsilon$, we eliminate $\\varepsilon$ to obtain\n$$\n\\Delta t_{\\max} \\;=\\; \\nu \\, \\frac{V_{\\min}}{|u_{y}|\\, h \\;+\\; 2\\,|u_{x}|\\, V_{\\min}/h}.\n$$\nThis expression is exact for the stated geometry and reduces in the thin-sliver limit $V_{\\min}\\to 0$ to the linear scaling $\\Delta t_{\\max} \\sim \\nu\\, V_{\\min}/(|u_{y}|\\, h)$.",
            "answer": "$$\\boxed{\\Delta t_{\\max} \\;=\\; \\nu \\, \\frac{V_{\\min}}{|u_{y}|\\, h \\;+\\; 2\\,|u_{x}|\\, V_{\\min}/h}}$$"
        },
        {
            "introduction": "Beyond conservation and stability, the ultimate goal of a CFD simulation is to produce physically accurate results. When using immersed boundaries on quadtree grids, the underlying \"staircased\" approximation of a smooth wall can introduce systematic errors in important derived quantities, such as wall shear stress. This hands-on coding problem  uses a manufactured solution to quantify this geometric error and test a correction strategy, demonstrating the crucial link between grid representation and the fidelity of engineering predictions.",
            "id": "3355443",
            "problem": "Consider a two-dimensional laminar flow near a smooth impermeable wall in the context of Computational Fluid Dynamics (CFD). For a Newtonian fluid, the wall shear stress is defined by the constitutive relation $\\boldsymbol{\\tau} = \\mu \\left( \\nabla \\boldsymbol{u} + \\nabla \\boldsymbol{u}^{\\top} \\right)$, where $\\mu$ is the dynamic viscosity and $\\boldsymbol{u}$ is the velocity field. For a smooth wall, the scalar wall shear stress magnitude at a point is $\\tau_w = \\mu \\, \\partial u_t / \\partial n$, where $u_t$ is the tangential component of velocity and $n$ denotes the normal coordinate pointing into the fluid.\n\nIn immersed boundary (IB) methods on quadtree meshes, coarse levels induce staircasing of the geometry: the true wall normal $\\boldsymbol{n}_{\\mathrm{true}}$ and tangent $\\boldsymbol{t}_{\\mathrm{true}}$ are approximated by axis-aligned directions $\\boldsymbol{n}_{\\mathrm{axis}} \\in \\{\\boldsymbol{e}_x, \\boldsymbol{e}_y\\}$ and $\\boldsymbol{t}_{\\mathrm{axis}}$ perpendicular to $\\boldsymbol{n}_{\\mathrm{axis}}$. This quantization produces a geometric bias in estimating $\\tau_w$ that is magnified at coarse levels. In contrast, body-fitted meshes align cell faces with $\\boldsymbol{n}_{\\mathrm{true}}$ and $\\boldsymbol{t}_{\\mathrm{true}}$.\n\nAssume a manufactured local velocity field consistent with no-slip and linear-plus-quadratic normal variation near the wall:\n$$\nu_t(y_{\\mathrm{true}}) = \\gamma \\, y_{\\mathrm{true}} + \\beta \\, y_{\\mathrm{true}}^2,\n$$\nwhere $y_{\\mathrm{true}}$ is the signed distance along the true wall normal $\\boldsymbol{n}_{\\mathrm{true}}$, $\\gamma$ has units $\\mathrm{s}^{-1}$, and $\\beta$ has units $\\mathrm{s}^{-1}\\,\\mathrm{m}^{-1}$. The exact wall shear stress magnitude is\n$$\n\\tau_w^{\\mathrm{true}} = \\mu \\, \\gamma.\n$$\n\nLet the true wall normal be $\\boldsymbol{n}_{\\mathrm{true}} = [\\cos\\phi, \\sin\\phi]$, with $\\phi$ the angle measured in radians from the $x$-axis. The true tangent is $\\boldsymbol{t}_{\\mathrm{true}} = [-\\sin\\phi, \\cos\\phi]$. The quadtree staircased normal $\\boldsymbol{n}_{\\mathrm{axis}}$ is chosen by\n$$\n\\boldsymbol{n}_{\\mathrm{axis}} =\n\\begin{cases}\n\\boldsymbol{e}_x & \\text{if } |\\cos\\phi| \\ge |\\sin\\phi|, \\\\\n\\boldsymbol{e}_y & \\text{otherwise},\n\\end{cases}\n$$\nwith a tie-breaker selecting $\\boldsymbol{e}_x$ when $|\\cos\\phi| = |\\sin\\phi|$. The associated axis tangent is $\\boldsymbol{t}_{\\mathrm{axis}} = \\boldsymbol{e}_y$ if $\\boldsymbol{n}_{\\mathrm{axis}} = \\boldsymbol{e}_x$, and $\\boldsymbol{t}_{\\mathrm{axis}} = \\boldsymbol{e}_x$ if $\\boldsymbol{n}_{\\mathrm{axis}} = \\boldsymbol{e}_y$.\n\nDefine the local mesh size $h$ at the wall-adjacent cell. The first fluid cell center is at a distance $d = h/2$ along the chosen normal direction. The immersed boundary one-point staircased estimate uses a forward difference based on the axis-aligned normal and tangent:\n$$\nf(y) = \\boldsymbol{t}_{\\mathrm{axis}} \\cdot \\boldsymbol{u}\\big(y \\, \\boldsymbol{n}_{\\mathrm{axis}}\\big),\n$$\nand\n$$\n\\tau_w^{\\mathrm{IB,1pt}} = \\mu \\left| \\frac{f(d) - f(0)}{d} \\right|,\n$$\nwith $f(0)=0$ due to no-slip. The body-fitted one-point estimate uses the true normal and tangent:\n$$\n\\tau_w^{\\mathrm{BF,1pt}} = \\mu \\left| \\frac{u_t(d) - u_t(0)}{d} \\right| = \\mu \\left| \\gamma + \\beta d \\right|.\n$$\n\nTo reduce staircasing-induced bias, consider two corrections:\n- Directional projection correction that accounts for the misalignment between $\\boldsymbol{n}_{\\mathrm{axis}}$, $\\boldsymbol{t}_{\\mathrm{axis}}$ and $\\boldsymbol{n}_{\\mathrm{true}}$, $\\boldsymbol{t}_{\\mathrm{true}}$ via the factor\n$$\nr = \\left(\\boldsymbol{t}_{\\mathrm{axis}} \\cdot \\boldsymbol{t}_{\\mathrm{true}}\\right) \\left(\\boldsymbol{n}_{\\mathrm{axis}} \\cdot \\boldsymbol{n}_{\\mathrm{true}}\\right).\n$$\n- Second-order extrapolation to the wall using the polynomial structure and points at $y=0$, $y=d$, and $y=2d$ along $\\boldsymbol{n}_{\\mathrm{axis}}$:\n$$\n\\left.\\frac{\\partial (\\boldsymbol{t}_{\\mathrm{axis}} \\cdot \\boldsymbol{u})}{\\partial y}\\right|_{y=0} \\approx \\frac{4 f(d) - f(2d)}{2 d}.\n$$\n\nCombining these, a corrected immersed boundary estimate is\n$$\n\\tau_w^{\\mathrm{IB,corr}} = \\mu \\, \\left| \\frac{4 f(d) - f(2d)}{2 d} \\right| \\, \\frac{1}{|r|}.\n$$\n\nFrom first principles, derive the expressions required to implement the above estimators and show under the manufactured solution how the staircasing misalignment enters through $r$ and the coarse-level bias enters through the $\\beta d$ term. Then implement a program that computes, for a given set of test cases, the relative errors of each estimator with respect to the exact wall shear stress:\n$$\nE_{\\mathrm{IB}} = \\frac{\\left| \\tau_w^{\\mathrm{IB,1pt}} - \\tau_w^{\\mathrm{true}} \\right|}{\\left| \\tau_w^{\\mathrm{true}} \\right|}, \\quad\nE_{\\mathrm{BF}} = \\frac{\\left| \\tau_w^{\\mathrm{BF,1pt}} - \\tau_w^{\\mathrm{true}} \\right|}{\\left| \\tau_w^{\\mathrm{true}} \\right|}, \\quad\nE_{\\mathrm{corr}} = \\frac{\\left| \\tau_w^{\\mathrm{IB,corr}} - \\tau_w^{\\mathrm{true}} \\right|}{\\left| \\tau_w^{\\mathrm{true}} \\right|}.\n$$\n\nAngles must be in radians. Dynamic viscosity $\\mu$ must be in Pascal-second, distances must be in meters, and the final wall shear stress magnitude is in Pascal. The output must report the three relative errors per test case as decimal fractions (no percentage sign).\n\nUse the following test suite, each parameter set given as $(\\phi, h, \\mu, \\gamma, \\beta)$:\n\n- Case $1$: $\\left( \\frac{\\pi}{12}, \\, 0.1, \\, 1.0 \\times 10^{-3}, \\, 10, \\, 5 \\right)$.\n- Case $2$: $\\left( \\frac{\\pi}{4}, \\, 0.1, \\, 1.0 \\times 10^{-3}, \\, 10, \\, 5 \\right)$.\n- Case $3$: $\\left( \\frac{5\\pi}{12}, \\, 0.1, \\, 1.0 \\times 10^{-3}, \\, 10, \\, 5 \\right)$.\n- Case $4$: $\\left( \\frac{\\pi}{4}, \\, 0.05, \\, 1.0 \\times 10^{-3}, \\, 10, \\, 5 \\right)$.\n- Case $5$: $\\left( \\frac{\\pi}{4}, \\, 0.025, \\, 1.0 \\times 10^{-3}, \\, 10, \\, 5 \\right)$.\n- Case $6$: $\\left( \\frac{\\pi}{4}, \\, 0.1, \\, 1.0 \\times 10^{-3}, \\, 10, \\, 0 \\right)$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, with the entries ordered by case and, within each case, by $(E_{\\mathrm{IB}}, E_{\\mathrm{BF}}, E_{\\mathrm{corr}})$. For example, an output with two cases would be of the form $\\left[ E_{\\mathrm{IB},1}, E_{\\mathrm{BF},1}, E_{\\mathrm{corr},1}, E_{\\mathrm{IB},2}, E_{\\mathrm{BF},2}, E_{\\mathrm{corr},2} \\right]$. The actual output must reflect all six cases specified above.",
            "solution": "The fundamental starting point is the Newtonian constitutive relation connecting stress to velocity gradients. For a Newtonian fluid, the viscous stress tensor is $\\boldsymbol{\\tau} = \\mu \\left( \\nabla \\boldsymbol{u} + \\nabla \\boldsymbol{u}^{\\top} \\right)$. On a smooth wall, the no-slip condition implies $\\boldsymbol{u} = \\boldsymbol{0}$ at the wall, and the scalar wall shear stress magnitude is given by $\\tau_w = \\mu \\, \\partial u_t / \\partial n$, where $u_t$ is the tangential component of velocity and $n$ is the normal coordinate into the fluid.\n\nWe construct a manufactured local solution near the wall,\n$$\nu_t(y_{\\mathrm{true}}) = \\gamma \\, y_{\\mathrm{true}} + \\beta \\, y_{\\mathrm{true}}^2,\n$$\nwith $y_{\\mathrm{true}}$ the signed distance along the true wall normal $\\boldsymbol{n}_{\\mathrm{true}}$. This function is consistent with the no-slip boundary condition $u_t(0) = 0$ and represents a linear shear rate $\\gamma$ with a quadratic correction proportional to $\\beta$ that models coarse-level interpolation or curvature effects. The exact wall shear stress magnitude is\n$$\n\\tau_w^{\\mathrm{true}} = \\mu \\left. \\frac{\\partial u_t}{\\partial y_{\\mathrm{true}}} \\right|_{y_{\\mathrm{true}}=0} = \\mu \\, \\gamma.\n$$\n\nImmersed boundary staircasing in a quadtree replaces the true wall orientation by axis-aligned segments. Define the true normal and tangent by\n$$\n\\boldsymbol{n}_{\\mathrm{true}} = \\begin{bmatrix} \\cos\\phi \\\\ \\sin\\phi \\end{bmatrix}, \\quad\n\\boldsymbol{t}_{\\mathrm{true}} = \\begin{bmatrix} -\\sin\\phi \\\\ \\cos\\phi \\end{bmatrix}.\n$$\nThe quantized staircased normal and tangent are\n$$\n\\boldsymbol{n}_{\\mathrm{axis}} =\n\\begin{cases}\n\\boldsymbol{e}_x & \\text{if } |\\cos\\phi| \\ge |\\sin\\phi|, \\\\\n\\boldsymbol{e}_y & \\text{otherwise},\n\\end{cases}\n\\qquad\n\\boldsymbol{t}_{\\mathrm{axis}} =\n\\begin{cases}\n\\boldsymbol{e}_y & \\text{if } \\boldsymbol{n}_{\\mathrm{axis}} = \\boldsymbol{e}_x, \\\\\n\\boldsymbol{e}_x & \\text{if } \\boldsymbol{n}_{\\mathrm{axis}} = \\boldsymbol{e}_y.\n\\end{cases}\n$$\nThe first interior cell center is a distance $d = h/2$ along the selected normal. A typical immersed boundary one-point estimate computes a forward difference of the velocity component parallel to $\\boldsymbol{t}_{\\mathrm{axis}}$ in the direction $\\boldsymbol{n}_{\\mathrm{axis}}$:\n$$\nf(y) = \\boldsymbol{t}_{\\mathrm{axis}} \\cdot \\boldsymbol{u}\\big(y \\boldsymbol{n}_{\\mathrm{axis}}\\big), \\quad\n\\tau_w^{\\mathrm{IB,1pt}} = \\mu \\left| \\frac{f(d) - f(0)}{d} \\right| = \\mu \\left| \\frac{f(d)}{d} \\right|,\n$$\nsince $f(0)=0$ by no-slip. To express $f(y)$ for our manufactured solution, note that near the wall $\\boldsymbol{u} = u_t \\, \\boldsymbol{t}_{\\mathrm{true}}$ and the true normal coordinate is $y_{\\mathrm{true}} = \\boldsymbol{n}_{\\mathrm{true}} \\cdot \\left( y \\boldsymbol{n}_{\\mathrm{axis}} \\right) = y \\left( \\boldsymbol{n}_{\\mathrm{true}} \\cdot \\boldsymbol{n}_{\\mathrm{axis}} \\right)$. Therefore,\n$$\nf(y) = \\boldsymbol{t}_{\\mathrm{axis}} \\cdot \\left( u_t(y_{\\mathrm{true}}) \\boldsymbol{t}_{\\mathrm{true}} \\right)\n= \\left( \\boldsymbol{t}_{\\mathrm{axis}} \\cdot \\boldsymbol{t}_{\\mathrm{true}} \\right) \\left( \\gamma y_{\\mathrm{true}} + \\beta y_{\\mathrm{true}}^2 \\right)\n= \\left( \\boldsymbol{t}_{\\mathrm{axis}} \\cdot \\boldsymbol{t}_{\\mathrm{true}} \\right) \\left( \\gamma \\left( \\boldsymbol{n}_{\\mathrm{true}} \\cdot \\boldsymbol{n}_{\\mathrm{axis}} \\right) y + \\beta \\left( \\boldsymbol{n}_{\\mathrm{true}} \\cdot \\boldsymbol{n}_{\\mathrm{axis}} \\right)^2 y^2 \\right).\n$$\nDefine\n$$\nr = \\left( \\boldsymbol{t}_{\\mathrm{axis}} \\cdot \\boldsymbol{t}_{\\mathrm{true}} \\right) \\left( \\boldsymbol{n}_{\\mathrm{true}} \\cdot \\boldsymbol{n}_{\\mathrm{axis}} \\right),\n\\qquad\ns = \\left( \\boldsymbol{t}_{\\mathrm{axis}} \\cdot \\boldsymbol{t}_{\\mathrm{true}} \\right) \\left( \\boldsymbol{n}_{\\mathrm{true}} \\cdot \\boldsymbol{n}_{\\mathrm{axis}} \\right)^2,\n$$\nso that $f(y) = \\gamma r \\, y + \\beta s \\, y^2$. The IB one-point estimate then becomes\n$$\n\\tau_w^{\\mathrm{IB,1pt}} = \\mu \\left| \\frac{\\gamma r \\, d + \\beta s \\, d^2}{d} \\right|\n= \\mu \\left| \\gamma r + \\beta s \\, d \\right|.\n$$\nThis exhibits two biases relative to $\\tau_w^{\\mathrm{true}} = \\mu \\gamma$:\n- A geometric misalignment factor $r$, which for $\\boldsymbol{n}_{\\mathrm{axis}} = \\boldsymbol{e}_x$ gives $r = \\cos^2\\phi$ and for $\\boldsymbol{n}_{\\mathrm{axis}} = \\boldsymbol{e}_y$ gives $r = -\\sin^2\\phi$. The magnitude $|r|$ reflects the cosine-square or sine-square attenuation due to staircasing. This is fundamentally tied to projecting the shear-rate dyadic $\\gamma \\, \\boldsymbol{t}_{\\mathrm{true}} \\otimes \\boldsymbol{n}_{\\mathrm{true}}$ onto axis-aligned directions.\n- A coarse-level bias $\\beta s \\, d$ that grows linearly with $d = h/2$, originating from the quadratic term when using a one-point forward difference.\n\nIn body-fitted meshes, the normal and tangent are aligned with the true geometry, so the one-point estimate is\n$$\n\\tau_w^{\\mathrm{BF,1pt}} = \\mu \\left| \\frac{\\gamma d + \\beta d^2}{d} \\right| = \\mu \\left| \\gamma + \\beta d \\right|,\n$$\nwhich contains only the coarse-level bias from the quadratic term and no misalignment factor.\n\nTo reduce the coarse-level bias without changing the mesh, we can use second-order extrapolation exploiting the known boundary value $f(0) = 0$ and the measurements at $y=d$ and $y=2d$. For a quadratic $f(y) = a_1 y + a_2 y^2$, solving for the derivative at the wall gives\n$$\na_1 = \\left. \\frac{d f}{d y} \\right|_{y=0} = \\frac{4 f(d) - f(2d)}{2 d}.\n$$\nApplying this to the staircased measurement $f(y) = \\gamma r \\, y + \\beta s \\, y^2$ yields\n$$\n\\frac{4 f(d) - f(2d)}{2 d} = \\frac{4 (\\gamma r \\, d + \\beta s \\, d^2) - (2 \\gamma r \\, d + 4 \\beta s \\, d^2)}{2 d} = \\gamma r,\n$$\nso the second-order extrapolation exactly removes the $O(d)$ bias from the quadratic term under the manufactured solution. The remaining deviation from $\\gamma$ is the staircasing misalignment factor $r$. If the true wall orientation is available (e.g., from a level-set function), we can correct for this geometric factor by dividing by $|r|$, producing\n$$\n\\tau_w^{\\mathrm{IB,corr}} = \\mu \\, \\left| \\frac{4 f(d) - f(2d)}{2 d} \\right| \\, \\frac{1}{|r|} = \\mu \\, |\\gamma|.\n$$\nThus, under the manufactured solution, the corrected estimate recovers the exact wall shear stress magnitude for any $\\phi$ and $h$.\n\nAlgorithmic steps:\n- For each test case $(\\phi, h, \\mu, \\gamma, \\beta)$, compute $\\boldsymbol{n}_{\\mathrm{true}} = [\\cos\\phi, \\sin\\phi]$ and $\\boldsymbol{t}_{\\mathrm{true}} = [-\\sin\\phi, \\cos\\phi]$.\n- Select $\\boldsymbol{n}_{\\mathrm{axis}}$ and $\\boldsymbol{t}_{\\mathrm{axis}}$ by the rule $|\\cos\\phi| \\ge |\\sin\\phi| \\Rightarrow \\boldsymbol{n}_{\\mathrm{axis}} = \\boldsymbol{e}_x$, else $\\boldsymbol{n}_{\\mathrm{axis}} = \\boldsymbol{e}_y$, and set $\\boldsymbol{t}_{\\mathrm{axis}}$ perpendicular accordingly.\n- Compute $d = h/2$, $r = (\\boldsymbol{t}_{\\mathrm{axis}} \\cdot \\boldsymbol{t}_{\\mathrm{true}})(\\boldsymbol{n}_{\\mathrm{axis}} \\cdot \\boldsymbol{n}_{\\mathrm{true}})$, and $s = (\\boldsymbol{t}_{\\mathrm{axis}} \\cdot \\boldsymbol{t}_{\\mathrm{true}})(\\boldsymbol{n}_{\\mathrm{axis}} \\cdot \\boldsymbol{n}_{\\mathrm{true}})^2$.\n- Evaluate $f(d) = \\gamma r \\, d + \\beta s \\, d^2$ and $f(2d) = \\gamma r \\, 2d + \\beta s \\, (2d)^2$.\n- Compute:\n  - $\\tau_w^{\\mathrm{true}} = \\mu \\, \\gamma$,\n  - $\\tau_w^{\\mathrm{IB,1pt}} = \\mu \\left| f(d)/d \\right| = \\mu \\left| \\gamma r + \\beta s \\, d \\right|$,\n  - $\\tau_w^{\\mathrm{BF,1pt}} = \\mu \\left| \\gamma + \\beta d \\right|$,\n  - $\\tau_w^{\\mathrm{IB,corr}} = \\mu \\left| \\frac{4 f(d) - f(2d)}{2 d} \\right| \\cdot \\frac{1}{|r|}$.\n- Return the relative errors $E_{\\mathrm{IB}}$, $E_{\\mathrm{BF}}$, and $E_{\\mathrm{corr}}$ as decimal fractions.\n\nCoverage analysis of the test suite:\n- Case $1$ uses a small angle $\\phi = \\pi/12$ with coarse $h = 0.1$ to probe mild misalignment and coarse bias.\n- Case $2$ uses the maximally ambiguous angle $\\phi = \\pi/4$ with coarse $h = 0.1$ to probe worst-case misalignment ($|r| = 1/2$) and coarse bias.\n- Case $3$ uses a large angle $\\phi = 5\\pi/12$ with coarse $h = 0.1$ to probe misalignment where $\\boldsymbol{n}_{\\mathrm{axis}} = \\boldsymbol{e}_y$.\n- Cases $4$ and $5$ reduce $h$ at $\\phi = \\pi/4$ to show that body-fitted error scales with $d$ while the IB misalignment persists; the corrected estimate removes both effects under the manufactured solution.\n- Case $6$ sets $\\beta = 0$ to isolate the misalignment effect alone.\n\nThe program aggregates the results in the specified single-line format as a comma-separated list in square brackets, ordered case-by-case with triples $(E_{\\mathrm{IB}}, E_{\\mathrm{BF}}, E_{\\mathrm{corr}})$ per case.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef compute_errors(phi, h, mu, gamma, beta):\n    # True normal and tangent\n    n_true = np.array([np.cos(phi), np.sin(phi)])\n    t_true = np.array([-np.sin(phi), np.cos(phi)])\n\n    # Staircased axis normal selection with tie-breaker to ex\n    if abs(n_true[0]) >= abs(n_true[1]):\n        n_axis = np.array([1.0, 0.0])\n        t_axis = np.array([0.0, 1.0])\n    else:\n        n_axis = np.array([0.0, 1.0])\n        t_axis = np.array([1.0, 0.0])\n\n    # Distances\n    d = h / 2.0\n\n    # Projection factors\n    r = float(np.dot(t_axis, t_true) * np.dot(n_axis, n_true))\n    s = float(np.dot(t_axis, t_true) * (np.dot(n_axis, n_true) ** 2))\n\n    # Manufactured axis-aligned sampling function values\n    # f(y) = gamma * r * y + beta * s * y^2\n    f_d = gamma * r * d + beta * s * d ** 2\n    f_2d = gamma * r * (2.0 * d) + beta * s * (2.0 * d) ** 2\n\n    # Shear stress estimates\n    tau_true = mu * gamma\n    tau_ib_1pt = mu * abs(f_d / d)  # = mu * |gamma * r + beta * s * d|\n    tau_bf_1pt = mu * abs(gamma + beta * d)\n    # Second-order extrapolated derivative at wall along axis:\n    # (4 f(d) - f(2d)) / (2 d) -> equals gamma * r for the manufactured solution\n    deriv_axis_wall = (4.0 * f_d - f_2d) / (2.0 * d)\n    # Correct orientation by dividing by |r| to recover true normal/tangential derivative\n    r_abs = abs(r) if r != 0.0 else np.nan  # handle degenerate case r=0 gracefully\n    if r_abs == 0.0 or np.isnan(r_abs):\n        # If r is exactly zero (pathological orientation), set corrected to NaN to avoid division by zero\n        tau_ib_corr = np.nan\n    else:\n        tau_ib_corr = mu * abs(deriv_axis_wall) / r_abs\n\n    # Relative errors as decimal fractions\n    # If corrected tau is NaN, set error to NaN to reflect inability to correct\n    E_ib = abs(tau_ib_1pt - tau_true) / abs(tau_true)\n    E_bf = abs(tau_bf_1pt - tau_true) / abs(tau_true)\n    E_corr = abs(tau_ib_corr - tau_true) / abs(tau_true) if not np.isnan(tau_ib_corr) else np.nan\n\n    return E_ib, E_bf, E_corr\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each test case: (phi, h, mu, gamma, beta)\n    test_cases = [\n        (np.pi/12.0, 0.1, 1.0e-3, 10.0, 5.0),          # Case 1\n        (np.pi/4.0, 0.1, 1.0e-3, 10.0, 5.0),           # Case 2\n        (5.0*np.pi/12.0, 0.1, 1.0e-3, 10.0, 5.0),      # Case 3\n        (np.pi/4.0, 0.05, 1.0e-3, 10.0, 5.0),          # Case 4\n        (np.pi/4.0, 0.025, 1.0e-3, 10.0, 5.0),         # Case 5\n        (np.pi/4.0, 0.1, 1.0e-3, 10.0, 0.0),           # Case 6\n    ]\n\n    results = []\n    for phi, h, mu, gamma, beta in test_cases:\n        E_ib, E_bf, E_corr = compute_errors(phi, h, mu, gamma, beta)\n        # Append in the required order per case: (E_IB, E_BF, E_CORR)\n        # Format floats in a consistent decimal representation\n        results.extend([E_ib, E_bf, E_corr])\n\n    # Convert potential NaNs to \"nan\" string via str(), preserving single-line format\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}