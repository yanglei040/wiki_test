{
    "hands_on_practices": [
        {
            "introduction": "The foundation of any finite-difference scheme lies in the accurate approximation of derivatives. When implementing black hole excision, this fundamental task is complicated by the presence of the inner boundary, as we can no longer use standard centered stencils that would require points inside the black hole. This practice  guides you through the essential skill of deriving a high-order, one-sided finite-difference stencil from first principles, a necessary tool for handling the boundary of the excised region and ensuring the causality of the numerical scheme.",
            "id": "3465547",
            "problem": "Consider a spherical excision region of radius $R$ centered at the origin in a three-dimensional Cartesian grid with uniform spacing $h$ in each coordinate direction. Let the outward unit normal at a point on the excision surface be $\\mathbf{n} = (n_{x}, n_{y}, n_{z})$ with $|\\mathbf{n}| = 1$. In a first-order symmetric-hyperbolic formulation used in numerical relativity, local outgoing characteristic fields near the excision boundary satisfy a radial advection equation of the form $\\partial_{t} u + c \\,\\partial_{r} u = 0$, where $u(\\mathbf{x},t)$ denotes a scalar characteristic field and $c  0$ is the characteristic speed measured along $\\mathbf{n}$. Because the interior points of the sphere are removed by excision, any finite-difference operator used to approximate spatial derivatives at boundary-adjacent grid points must be one-sided in the outward directions.\n\nStarting from Taylor expansions and the definition of the directional derivative $\\partial_{r} u = \\mathbf{n}\\cdot\\nabla u = n_{x}\\,\\partial_{x} u + n_{y}\\,\\partial_{y} u + n_{z}\\,\\partial_{z} u$, perform the following tasks:\n\n1. Derive a one-dimensional, six-point forward (one-sided) finite-difference stencil on a uniform Cartesian line that approximates $\\partial_{x} u$ at a boundary-adjacent point $x_{0}$ using grid values $\\{u(x_{0}), u(x_{0}+h), \\dots, u(x_{0}+5h)\\}$, with formal accuracy order five. Work from first principles by matching Taylor series coefficients so that the discrete operator reproduces the first derivative of polynomials up to degree five at $x_{0}$.\n\n2. Using the result of part 1 for each Cartesian coordinate direction, write an explicit formula that approximates the radial derivative $\\partial_{r} u$ at a boundary-adjacent grid point as a linear combination of the one-sided operators in the $x$, $y$, and $z$ directions with weights $n_{x}$, $n_{y}$, and $n_{z}$.\n\n3. Determine the leading-order truncation error of the one-dimensional stencil from part 1. Specifically, find the constant multiplying $h^{5} u^{(6)}(x_{0})$ in the error expansion of the discrete approximation to $\\partial_{x} u$, where $u^{(p)}$ denotes the $p$-th derivative with respect to $x$ at $x_{0}$.\n\n4. For the semi-discrete method-of-lines formulation of the linear advection equation $\\partial_{t} u + c \\,\\partial_{r} u = 0$ closed by the one-sided directional operator derived above, integrated in time with the classical fourth-order Runge–Kutta method, provide a sufficient Courant–Friedrichs–Lewy (CFL) stability constraint on the timestep $\\Delta t$ in symbolic form. Express your constraint in terms of $h$, $c$, and the spectral radius of the discrete spatial operator’s Fourier symbol; define any symbols you introduce. Discuss why one-sidedness is mandated by excision and how it affects the spectral properties relevant to stability.\n\nAs your final answer, report only the ordered row of the six stencil weights (from $m=0$ to $m=5$) for the one-dimensional forward approximation to $\\partial_{x} u$ and the leading-order truncation-error constant found in part 3. No rounding is required, and no units should be included in your final answer.",
            "solution": "The problem posed is a well-defined exercise in numerical analysis, specifically in the construction and analysis of finite-difference methods for hyperbolic partial differential equations, framed within the context of numerical relativity. It is scientifically grounded, self-contained, and objective. Therefore, I will proceed with a full solution.\n\n### Part 1: Derivation of the Six-Point, Fifth-Order Forward Difference Stencil\n\nWe seek a finite-difference approximation for the first derivative $\\partial_x u$ at a point $x_0$ of the form:\n$$\nD_x u(x_0) = \\frac{1}{h} \\sum_{m=0}^{5} a_m u(x_0 + m h)\n$$\nThis approximation must have a formal accuracy of order five. This means the operator must be exact for all polynomials of degree up to five. We can achieve this by using Taylor series expansions of $u(x_0 + m h)$ around $x_0$ and matching coefficients.\n\nThe Taylor expansion of $u(x_0 + m h)$ is:\n$$\nu(x_0 + m h) = \\sum_{k=0}^{\\infty} \\frac{(m h)^k}{k!} u^{(k)}(x_0)\n$$\nwhere $u^{(k)}(x_0)$ denotes the $k$-th derivative of $u$ with respect to $x$ evaluated at $x_0$.\n\nSubstituting this into the finite-difference formula:\n\\begin{align*}\nD_x u(x_0) = \\frac{1}{h} \\sum_{m=0}^{5} a_m \\left( \\sum_{k=0}^{\\infty} \\frac{(m h)^k}{k!} u^{(k)}(x_0) \\right) \\\\\n= \\sum_{k=0}^{\\infty} \\frac{h^{k-1}}{k!} \\left( \\sum_{m=0}^{5} a_m m^k \\right) u^{(k)}(x_0) \\\\\n= \\frac{1}{h} \\left( \\sum_{m=0}^{5} a_m \\right) u^{(0)}(x_0) + \\left( \\sum_{m=0}^{5} a_m m \\right) u^{(1)}(x_0) + \\frac{h}{2} \\left( \\sum_{m=0}^{5} a_m m^2 \\right) u^{(2)}(x_0) + \\dots\n\\end{align*}\nFor this expression to approximate $\\partial_x u(x_0) = u^{(1)}(x_0)$ with an error of $\\mathcal{O}(h^5)$, the coefficients of $u^{(k)}(x_0)$ must match those of $u^{(1)}(x_0)$ for $k=0, \\dots, 5$. This leads to the following system of six linear equations for the six coefficients $a_0, \\dots, a_5$:\n\\begin{align*}\n\\sum_{m=0}^{5} a_m m^0 = \\sum_{m=0}^{5} a_m = 0 \\quad (\\text{coefficient of } u^{(0)}) \\\\\n\\sum_{m=0}^{5} a_m m^1 = 1 \\quad (\\text{coefficient of } u^{(1)}) \\\\\n\\sum_{m=0}^{5} a_m m^2 = 0 \\quad (\\text{coefficient of } u^{(2)}) \\\\\n\\sum_{m=0}^{5} a_m m^3 = 0 \\quad (\\text{coefficient of } u^{(3)}) \\\\\n\\sum_{m=0}^{5} a_m m^4 = 0 \\quad (\\text{coefficient of } u^{(4)}) \\\\\n\\sum_{m=0}^{5} a_m m^5 = 0 \\quad (\\text{coefficient of } u^{(5)})\n\\end{align*}\nIn matrix form, this is:\n$$\n\\begin{pmatrix}\n1  1  1  1  1  1 \\\\\n0  1  2  3  4  5 \\\\\n0  1  4  9  16  25 \\\\\n0  1  8  27  64  125 \\\\\n0  1  16  81  256  625 \\\\\n0  1  32  243  1024  3125\n\\end{pmatrix}\n\\begin{pmatrix}\na_0 \\\\ a_1 \\\\ a_2 \\\\ a_3 \\\\ a_4 \\\\ a_5\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n0 \\\\ 1 \\\\ 0 \\\\ 0 \\\\ 0 \\\\ 0\n\\end{pmatrix}\n$$\nSolving this system of linear equations yields the unique set of rational coefficients:\n\\begin{center}\n$a_0 = -\\frac{137}{60}$ \\\\\n$a_1 = 5$ \\\\\n$a_2 = -5$ \\\\\n$a_3 = \\frac{10}{3}$ \\\\\n$a_4 = -\\frac{5}{4}$ \\\\\n$a_5 = \\frac{1}{5}$\n\\end{center}\nThe resulting stencil is:\n$$\nD_x u(x_0) = \\frac{1}{h} \\left( -\\frac{137}{60} u(x_0) + 5 u(x_0+h) - 5 u(x_0+2h) + \\frac{10}{3} u(x_0+3h) - \\frac{5}{4} u(x_0+4h) + \\frac{1}{5} u(x_0+5h) \\right)\n$$\n\n### Part 2: Explicit Formula for the Radial Derivative\n\nThe radial derivative is defined as $\\partial_r u = \\mathbf{n} \\cdot \\nabla u = n_x \\partial_x u + n_y \\partial_y u + n_z \\partial_z u$. We approximate this expression by replacing each partial derivative with its corresponding discrete operator. Let $D_x$, $D_y$, and $D_z$ be the discrete operators for $\\partial_x$, $\\partial_y$, and $\\partial_z$, respectively. A crucial subtlety is that the direction of one-sidedness must be outward from the excision surface. For a normal vector component $n_i  0$, a forward stencil is used; for $n_i  0$, a backward stencil should be used. The problem, however, instructs us to use \"the result of part 1 for each Cartesian coordinate direction,\" which derived a forward stencil. Following this instruction formally, we define the operators at a point $\\mathbf{x}_0 = (x_0, y_0, z_0)$:\n\nLet $D_x^+$, $D_y^+$, and $D_z^+$ be the forward difference operators based on the stencil from Part 1:\n\\begin{align*}\nD_x^+ u(\\mathbf{x}_0) = \\frac{1}{h} \\sum_{m=0}^{5} a_m u(x_0 + m h, y_0, z_0) \\\\\nD_y^+ u(\\mathbf{x}_0) = \\frac{1}{h} \\sum_{m=0}^{5} a_m u(x_0, y_0 + m h, z_0) \\\\\nD_z^+ u(\\mathbf{x}_0) = \\frac{1}{h} \\sum_{m=0}^{5} a_m u(x_0, y_0, z_0 + m h)\n\\end{align*}\nwhere the coefficients $\\{a_m\\}$ are those derived in Part 1.\n\nThe approximation for the radial derivative, $D_r u$, is then constructed as the same linear combination of these discrete operators:\n$$\nD_r u(\\mathbf{x}_0) = n_x D_x^+ u(\\mathbf{x}_0) + n_y D_y^+ u(\\mathbf{x}_0) + n_z D_z^+ u(\\mathbf{x}_0)\n$$\nSubstituting the explicit forms of the operators, we obtain the formula:\n$$\nD_r u(\\mathbf{x}_0) = \\frac{1}{h} \\left( n_x \\sum_{m=0}^{5} a_m u(x_0+mh, y_0, z_0) + n_y \\sum_{m=0}^{5} a_m u(x_0, y_0+mh, z_0) + n_z \\sum_{m=0}^{5} a_m u(x_0, y_0, z_0+mh) \\right)\n$$\nThis formula uses only forward stencils, as per a literal interpretation of the prompt. A correct implementation would select between forward and backward stencils depending on the sign of $n_x$, $n_y$, and $n_z$.\n\n### Part 3: Leading-Order Truncation Error\n\nThe truncation error of the discrete operator $D_x$ is the difference between the operator applied to the exact solution and the exact derivative, $T = D_x u - \\partial_x u$. We find the leading term of this error by extending the Taylor series analysis from Part 1 to the next non-vanishing term. By construction, the terms involving $u^{(0)}, \\dots, u^{(5)}$ cancel out, except for the $u^{(1)}$ term which gives the derivative itself. The first non-vanishing error term will involve $u^{(6)}(x_0)$.\n\nThe expansion from Part 1 is:\n$$\nD_x u(x_0) = \\sum_{k=0}^{\\infty} \\frac{h^{k-1}}{k!} \\left( \\sum_{m=0}^{5} a_m m^k \\right) u^{(k)}(x_0)\n$$\nUsing the properties of our coefficients $a_m$, this becomes:\n$$\nD_x u(x_0) = u^{(1)}(x_0) + \\frac{h^5}{6!} \\left( \\sum_{m=0}^{5} a_m m^6 \\right) u^{(6)}(x_0) + \\mathcal{O}(h^6)\n$$\nThe leading-order truncation error is the second term on the right-hand side. We must calculate the sum $\\sum_{m=0}^{5} a_m m^6$:\n\\begin{align*}\n\\sum_{m=0}^{5} a_m m^6 = (a_0 \\cdot 0^6) + (a_1 \\cdot 1^6) + (a_2 \\cdot 2^6) + (a_3 \\cdot 3^6) + (a_4 \\cdot 4^6) + (a_5 \\cdot 5^6) \\\\\n= \\left(5\\right) \\cdot 1 + \\left(-5\\right) \\cdot 64 + \\left(\\frac{10}{3}\\right) \\cdot 729 + \\left(-\\frac{5}{4}\\right) \\cdot 4096 + \\left(\\frac{1}{5}\\right) \\cdot 15625 \\\\\n= 5 - 320 + (10 \\cdot 243) - (5 \\cdot 1024) + 3125 \\\\\n= 5 - 320 + 2430 - 5120 + 3125 \\\\\n= 5560 - 5440 = 120\n\\end{align*}\nThe coefficient of the leading error term is $\\frac{1}{6!} \\sum_{m=0}^{5} a_m m^6$. Since $6! = 720$, this is:\n$$\nC = \\frac{120}{720} = \\frac{1}{6}\n$$\nThus, the error expansion of the approximation is:\n$$\nD_x u(x_0) - \\partial_x u(x_0) = \\frac{1}{6} h^5 u^{(6)}(x_0) + \\mathcal{O}(h^6)\n$$\nThe constant multiplying $h^5 u^{(6)}(x_0)$ is $\\frac{1}{6}$.\n\n### Part 4: CFL Stability Constraint and Discussion\n\nThe semi-discrete equation is $\\frac{d\\mathbf{u}}{dt} = -c D_r \\mathbf{u}$, where $\\mathbf{u}$ is the vector of field values at grid points and $D_r$ is the matrix representing the discrete spatial operator from Part 2. The stability of the classical fourth-order Runge-Kutta (RK4) method for this system requires that for every eigenvalue $\\lambda$ of the matrix $-c D_r$, the quantity $z = \\Delta t \\lambda$ must lie within the stability region of RK4, denoted $S_{RK4}$.\n\nIn a von Neumann (Fourier) stability analysis, the eigenvalues of the operator $-c D_r$ are approximated by the values of its Fourier symbol, $\\hat{S}(\\mathbf{k}) = -c \\hat{D}_r(\\mathbf{k})$, where $\\mathbf{k}=(k_x, k_y, k_z)$ is the wavevector. The symbol of the radial derivative operator is:\n$$\n\\hat{D}_r(\\mathbf{k}) = n_x \\hat{D}_x(k_x) + n_y \\hat{D}_y(k_y) + n_z \\hat{D}_z(k_z)\n$$\nwhere $\\hat{D}_x(k_x)$, the symbol of the 1D operator, is:\n$$\n\\hat{D}_x(k_x) = \\frac{1}{h} \\sum_{m=0}^{5} a_m \\exp(i m k_x h)\n$$\nThe stability condition is that $-c \\Delta t \\hat{D}_r(\\mathbf{k}) \\in S_{RK4}$ for all $\\mathbf{k}$. This leads to a constraint on the timestep $\\Delta t$ of the form:\n$$\n\\Delta t \\le \\frac{\\mathcal{C}_{RK4}}{\\rho(-c D_r)}\n$$\nwhere $\\rho(-c D_r)$ is the spectral radius of the operator. Following the problem's suggestion, we use the \"spectral radius of the Fourier symbol\", which we define as $\\rho_{FS} = \\max_{\\mathbf{k}} |-c \\hat{D}_r(\\mathbf{k})| = c \\max_{\\mathbf{k}} |\\hat{D}_r(\\mathbf{k})|$. The constant $\\mathcal{C}_{RK4}$ is the maximum extent of the RK4 stability region along the direction of the scaled spectrum.\nA sufficient CFL stability constraint is therefore:\n$$\n\\Delta t \\le \\frac{\\mathcal{C}_{RK4}}{c \\max_{\\mathbf{k}} |\\hat{D}_r(\\mathbf{k})|}\n$$\nThe constant $\\mathcal{C}_{RK4}$ depends on the geometric properties of the spectrum $\\{ \\hat{D}_r(\\mathbf{k}) \\}$ in the complex plane. If the spectrum were purely imaginary (as for centered differences), $\\mathcal{C}_{RK4} = 2\\sqrt{2}$. For one-sided stencils, the spectrum is not purely imaginary, so $\\mathcal{C}_{RK4}$ takes a different value.\n\n**Discussion:**\nOne-sidedness is mandated by the principle of causality in a domain with an excised interior. At a grid point adjacent to the excision boundary, a finite-difference stencil cannot use points from within the excised region, as they are not part of the computational domain. Since the equation $\\partial_t u + c \\partial_r u = 0$ describes an outgoing wave ($c0$), the characteristic information propagates in the direction of increasing $r$ (outward). The numerical domain of dependence must encompass the continuum domain of dependence. Thus, to compute the spatial derivative $\\partial_r u$ needed to evolve the solution, one must use points that are further out, leading to a one-sided stencil pointing away from the origin.\n\nThis one-sidedness fundamentally affects the spectral properties of the discrete operator. Whereas centered-difference approximations to first derivatives are anti-symmetric and have purely imaginary Fourier symbols (and eigenvalues), one-sided stencils are not anti-symmetric and have complex symbols. This introduces a non-zero real part to the eigenvalues of the semi-discrete operator. If this real part is non-positive for all modes, the scheme is dissipative, which can be beneficial for stability. However, standard high-order one-sided stencils derived from Taylor series, such as the one in this problem, are not guaranteed to be dissipative and can possess eigenvalues with positive real parts. Such modes are amplified by any explicit time-stepping scheme, leading to unconditional instability. For this reason, practical implementations often employ specially designed Summation-by-Parts (SBP) operators that, when combined with appropriate boundary conditions, guarantee stability by preventing the growth of a discrete energy norm. The formal stability constraint derived above presumes that the spectrum of the operator $-c D_r$ lies entirely within a region of the left half-plane that can be contained within the RK4 stability domain for a sufficiently small $\\Delta t$.",
            "answer": "$$\n\\boxed{\\begin{pmatrix} -\\frac{137}{60}  5  -5  \\frac{10}{3}  -\\frac{5}{4}  \\frac{1}{5}  \\frac{1}{6} \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "While accuracy is crucial, the long-term stability of a numerical evolution is paramount, as an unstable scheme will produce unphysical, exponentially growing errors that render the simulation useless. This exercise  moves beyond simple stencil construction to the modern and powerful Summation-by-Parts (SBP) and Simultaneous Approximation Term (SAT) framework. It demonstrates how to formally prove the stability of a boundary treatment by constructing a discrete energy estimate, which is a direct analogue to the energy methods used to analyze continuous partial differential equations.",
            "id": "3465576",
            "problem": "Consider a one-dimensional semi-discrete model for a single linearized constraint field $c(r,t)$ of a black hole evolution near an excision surface at $r=r_{\\mathrm{exc}}$, arising for example in the Baumgarte–Shapiro–Shibata–Nakamura (BSSN) or Generalized Harmonic formulations of numerical relativity. Assume the constraint $c$ satisfies a linear constant-coefficient symmetric-hyperbolic advection equation with shift-dominated transport along the radial coordinate $r$ that, near the excision surface, points into the excised region, namely $c_{t} + a\\,c_{r} = 0$ with $a0$. The computational domain is $r \\in [r_{\\mathrm{exc}},r_{\\mathrm{out}}]$, with inner boundary at $r=r_{\\mathrm{exc}}$ and outer boundary at $r=r_{\\mathrm{out}}$. A grid with uniform spacing $h$ is defined by $r_{i} = r_{\\mathrm{exc}} + i h$ for $i=0,1,\\dots,N$.\n\nUse a high-order Summation-By-Parts (SBP) finite difference approximation for the first derivative $c_{r}$, with a diagonal norm matrix $H$ and a semi-discrete derivative operator $D$ of interior order $2p$ and boundary order $p$ for some integer $p \\geq 3$ (i.e., high polynomial order). The SBP property states that $H D + D^{T} H = B$, where $B$ is a symmetric matrix representing a discrete boundary operator consistent with integration by parts, $B = - e_{0} e_{0}^{T} + e_{N} e_{N}^{T}$, and $e_{0}, e_{N}$ are the coordinate vectors selecting the inner and outer boundary grid points, respectively. Near the excision inner boundary ($i=0$), the boundary difference stencil is of width $s$ and is to be constructed to achieve order $p$ consistency while maintaining the SBP property, and similarly for the outer boundary ($i=N$).\n\nA Simultaneous Approximation Term (SAT) weak boundary treatment is employed. For homogeneous constraint-preserving boundary conditions, take $g_{0}=0$ at the inner boundary (excision surface) and $g_{N}=0$ at the outer boundary. The semi-discrete SBP–SAT scheme is\n$$\nc_{t} = - a\\,D\\,c + H^{-1}\\left[a\\,\\sigma_{0}\\,e_{0}\\left(c_{0} - g_{0}\\right) + a\\,\\sigma_{N}\\,e_{N}\\left(c_{N} - g_{N}\\right)\\right],\n$$\nwhere $\\sigma_{0}$ and $\\sigma_{N}$ are constant penalty parameters to be chosen for stability.\n\nTasks:\n- Starting from the continuous energy method for linear symmetric hyperbolic systems and the SBP property, derive a discrete energy estimate for $E(t) = c^{T} H c$ that exhibits the boundary fluxes and SAT contributions.\n- For the excision inner boundary ($i=0$), justify a constraint-preserving choice of SAT consistent with the physical outflow ($a0$) and the absence of incoming characteristics. For the outer boundary ($i=N$), impose the homogeneous constraint $c_{N}=0$ weakly via SAT.\n- Without using any specific closed-form stencil coefficients, but relying on the SBP property and the form of the SAT, determine the minimal value of the outer penalty coefficient $\\sigma_{N}$ that guarantees a non-increasing discrete energy $E(t)$ for all grid functions $c$, at arbitrary high polynomial order $p \\geq 3$. Give your final answer as an exact number.\n\nNote: You may assume the existence of diagonal-norm SBP operators of interior order $2p$ and boundary order $p$ and that the inner boundary lies strictly inside the apparent horizon so that all physical characteristic speeds at $r=r_{\\mathrm{exc}}$ point into the excised region.",
            "solution": "The problem asks for an analysis of the stability of a semi-discrete Summation-By-Parts (SBP) and Simultaneous Approximation Term (SAT) numerical scheme for a linear advection equation, modeling a constraint field in the context of black hole excision. The analysis will proceed in three stages: first, the derivation of a discrete energy estimate; second, the justification of the boundary condition implementation; and third, the determination of the minimal penalty parameter $\\sigma_{N}$ for stability.\n\nWe begin by deriving the discrete energy estimate. The discrete energy of the system is defined as a quadratic form using the SBP norm matrix $H$:\n$$\nE(t) = c(t)^{T} H c(t)\n$$\nwhere $c(t)$ is the vector of the grid function values $c_{i}(t)$. To find the rate of change of energy, we differentiate $E(t)$ with respect to time $t$. Using the product rule for differentiation and noting that the vector $c$ is time-dependent while the matrix $H$ is constant, we get:\n$$\n\\frac{dE}{dt} = \\frac{d}{dt}(c^{T} H c) = \\dot{c}^{T} H c + c^{T} H \\dot{c}\n$$\nSince $H$ is a symmetric matrix ($H = H^{T}$), the two terms are equal: $(\\dot{c}^{T} H c)^{T} = c^{T} H^{T} \\ddot{c} = c^{T} H \\dot{c}$. Therefore, we can write:\n$$\n\\frac{dE}{dt} = 2 c^{T} H \\dot{c}\n$$\nThe problem provides the semi-discrete evolution equation for $\\dot{c}$ (which we denote as $c_{t}$):\n$$\n\\dot{c} = - a\\,D\\,c + H^{-1}\\left[a\\,\\sigma_{0}\\,e_{0}\\left(c_{0} - g_{0}\\right) + a\\,\\sigma_{N}\\,e_{N}\\left(c_{N} - g_{N}\\right)\\right]\n$$\nSubstituting the homogeneous boundary data $g_{0}=0$ and $g_{N}=0$, the equation simplifies to:\n$$\n\\dot{c} = - a\\,D\\,c + a\\,H^{-1}\\left[\\sigma_{0}\\,e_{0}c_{0} + \\sigma_{N}\\,e_{N}c_{N}\\right]\n$$\nNow, substitute this expression for $\\dot{c}$ into the energy rate equation:\n$$\n\\frac{dE}{dt} = 2 c^{T} H \\left( - a\\,D\\,c + a\\,H^{-1}\\left[\\sigma_{0}\\,e_{0}c_{0} + \\sigma_{N}\\,e_{N}c_{N}\\right] \\right)\n$$\nDistributing the term $2c^{T} H$ yields:\n$$\n\\frac{dE}{dt} = -2a\\,c^{T} H D c + 2a\\,c^{T} H H^{-1}\\left[\\sigma_{0}\\,e_{0}c_{0} + \\sigma_{N}\\,e_{N}c_{N}\\right]\n$$\nThe first term involves the expression $c^{T} H D c$. We can use the SBP property to simplify it. The property states $H D + D^{T} H = B$. This allows us to write $2 c^{T} H D c = c^{T} H D c + (c^{T} H D c)^{T} = c^{T} H D c + c^{T} D^{T} H^{T} c$. Since $H=H^{T}$, this becomes $c^{T}(HD + D^{T}H)c = c^{T}Bc$.\nThe second term simplifies as $H H^{-1} = I$, the identity matrix. So, $c^{T} H H^{-1}[\\dots] = c^{T}[\\dots]$. The terms in the bracket involve the boundary selection vectors $e_{0}$ and $e_{N}$. We use the relations $c^{T}e_{0} = c_{0}$ and $c^{T}e_{N} = c_{N}$ to get:\n$$\nc^{T}\\left[\\sigma_{0}\\,e_{0}c_{0} + \\sigma_{N}\\,e_{N}c_{N}\\right] = \\sigma_{0}(c^{T}e_{0})c_{0} + \\sigma_{N}(c^{T}e_{N})c_{N} = \\sigma_{0}c_{0}^{2} + \\sigma_{N}c_{N}^{2}\n$$\nCombining these simplifications, the energy rate becomes:\n$$\n\\frac{dE}{dt} = -a (c^{T} B c) + 2a (\\sigma_{0}c_{0}^{2} + \\sigma_{N}c_{N}^{2})\n$$\nNext, we substitute the given form of the boundary operator matrix $B = - e_{0} e_{0}^{T} + e_{N} e_{N}^{T}$. The quadratic form $c^{T} B c$ evaluates to:\n$$\nc^{T} B c = c^{T}(- e_{0} e_{0}^{T} + e_{N} e_{N}^{T})c = -(c^{T}e_{0})(e_{0}^{T}c) + (c^{T}e_{N})(e_{N}^{T}c) = -c_{0}^{2} + c_{N}^{2}\n$$\nSubstituting this into the energy rate equation gives our final expression for the energy estimate:\n$$\n\\frac{dE}{dt} = -a(-c_{0}^{2} + c_{N}^{2}) + 2a\\sigma_{0}c_{0}^{2} + 2a\\sigma_{N}c_{N}^{2}\n$$\nGrouping the terms corresponding to each boundary, we arrive at the discrete energy estimate, which completes the first task:\n$$\n\\frac{dE}{dt} = a(1+2\\sigma_{0})c_{0}^{2} + a(2\\sigma_{N}-1)c_{N}^{2}\n$$\n\nFor the second task, we justify the choices for the boundary conditions. The governing PDE is $c_{t} + a\\,c_{r} = 0$. The characteristics of this equation are lines satisfying $dr/dt = a$. Since $a0$ is given, information propagates in the direction of decreasing $r$.\nAt the inner (excision) boundary $r=r_{\\mathrm{exc}}$ (corresponding to $i=0$), the characteristics are leaving the computational domain $[r_{\\mathrm{exc}}, r_{\\mathrm{out}}]$. This is an outflow boundary. For such a boundary, the solution is determined by data from within the domain, and no external boundary condition should be imposed. The energy rate contribution from this boundary is $a(1+2\\sigma_{0})c_{0}^{2}$. The SBP operator alone provides the term $ac_{0}^{2}$. Since $a0$, this term is non-positive, representing a physically correct outflow of energy and a stable contribution. The SAT term $2a\\sigma_{0}c_{0}^{2}$ introduces a penalty. To avoid imposing an artificial constraint at this outflow boundary, the most natural and constraint-preserving choice is to make the penalty term vanish. This is achieved by setting $\\sigma_{0}=0$. This choice is stable, as the total contribution $ac_{0}^{2}$ remains non-positive.\n\nAt the outer boundary $r=r_{\\mathrm{out}}$ (corresponding to $i=N$), the characteristics are entering the computational domain. This is an inflow boundary, which requires a boundary condition to be specified for a well-posed problem. The problem specifies imposing the homogeneous constraint $c_{N}=0$, which is done weakly via the SAT term with $g_{N}=0$. The energy rate contribution from this boundary is $a(2\\sigma_{N}-1)c_{N}^{2}$. The term from the SBP stencil alone is $-ac_{N}^{2}$. Since $a0$, this SBP term is positive, representing an influx of energy that can lead to instability. The SAT penalty term $2a\\sigma_{N}c_{N}^{2}$ must be chosen to control this instability.\n\nThis leads to the third task: determining the minimal value of $\\sigma_{N}$ that guarantees stability, i.e., $\\frac{dE}{dt} \\le 0$ for any grid function $c$. With our choice $\\sigma_{0}=0$, the energy rate simplifies to:\n$$\n\\frac{dE}{dt} = a c_{0}^{2} + a(2\\sigma_{N}-1)c_{N}^{2}\n$$\nThe first term, $a c_{0}^{2}$, is always non-positive since $a0$ and $c_{0}^{2} \\ge 0$. To guarantee $\\frac{dE}{dt} \\le 0$, the second term must also be non-positive for any value of $c_{N}$:\n$$\na(2\\sigma_{N}-1)c_{N}^{2} \\le 0\n$$\nSince $a0$ and $c_{N}^{2} \\ge 0$, this inequality holds if and only if the remaining factor is greater than or equal to zero:\n$$\n2\\sigma_{N}-1 \\ge 0\n$$\nSolving for $\\sigma_{N}$ gives the condition:\n$$\n\\sigma_{N} \\ge \\frac{1}{2}\n$$\nThe problem asks for the minimal value of $\\sigma_{N}$ that guarantees non-increasing energy. This corresponds to the lower bound of the derived inequality. Thus, the minimal value is $\\sigma_{N} = \\frac{1}{2}$. It is noteworthy that this result depends only on the fundamental SBP property and the form of the SAT, and is therefore independent of the specific SBP operator or its polynomial order $p$. With this choice, the outer boundary term becomes $a(2(\\frac{1}{2})-1)c_{N}^{2} = 0$, exactly canceling the unstable energy influx from the SBP operator.",
            "answer": "$$\\boxed{\\frac{1}{2}}$$"
        },
        {
            "introduction": "Theoretical tools for stability and accuracy must ultimately confront the realities of a discrete computational grid. On a Cartesian grid, a smooth excision surface like a sphere is approximated by a 'stair-stepped' collection of cubes, introducing geometric errors that can depend on the orientation of the grid relative to the surface. This hands-on coding exercise  challenges you to implement and quantitatively compare different excision mask geometries, providing direct insight into how these practical choices impact the violation of physical constraints and the overall accuracy of a simulation.",
            "id": "3465595",
            "problem": "Consider a time-symmetric initial data slice for a single non-spinning black hole in isotropic Cartesian coordinates, where the physical spatial metric is conformally flat, given by $g_{ij} = \\psi^4 \\delta_{ij}$, and the conformal factor for a Schwarzschild mass $M$ is $\\psi(\\mathbf{x}) = 1 + \\dfrac{M}{2 r}$ with $r = \\sqrt{x^2 + y^2 + z^2}$. On such a slice, the Hamiltonian constraint of General Relativity reduces to the requirement that the Ricci scalar of the conformal metric be zero outside sources, which, for the conformally flat form, implies the flat-space Laplace equation $\\nabla^2 \\psi = 0$ for $r  0$. In numerical relativity with black hole excision, one removes grid points inside an excision mask contained within the event horizon to avoid the physical singularity. On a Cartesian grid, the geometry and orientation of the excision mask can introduce orientation-dependent discretization errors in finite-difference approximations of derivatives near the excision boundary.\n\nYour task is to quantitatively compare spherical versus cubical excision masks on Cartesian grids, at the same proximity to the event horizon, and to report two scalars for each case:\n- A discrete Hamiltonian constraint residual norm computed as the root-mean-square of the discrete Laplacian $\\nabla^2 \\psi$ over all usable points outside the mask.\n- An orientation-dependent metric error computed as the root-mean-square of the mismatch between numerically approximated axial second derivatives $\\partial^2 \\psi / \\partial x^2$, $\\partial^2 \\psi / \\partial y^2$, $\\partial^2 \\psi / \\partial z^2$ and their analytic values, restricted to points that are adjacent to the excision boundary.\n\nFundamental base and definitions to use:\n- The conformal factor is $\\psi(\\mathbf{x}) = 1 + \\dfrac{M}{2 r}$ with $r = \\sqrt{x^2 + y^2 + z^2}$.\n- The event horizon in isotropic coordinates is at radius $r_h = \\dfrac{M}{2}$.\n- The excision mask radius is defined by $r_{\\mathrm{ex}} = r_h - \\Delta$, where $\\Delta  0$ is the prescribed proximity to the horizon. The excision region must satisfy $r_{\\mathrm{ex}}  0$.\n- Spherical mask: excise all points satisfying $r  r_{\\mathrm{ex}}$.\n- Cubical mask: excise all points satisfying $\\max\\left(|x'|,|y'|,|z'|\\right)  r_{\\mathrm{ex}}$, where $(x',y',z')$ are coordinates after an in-plane rotation of angle $\\theta$ about the $z$-axis, given by\n$$\n\\begin{pmatrix}\nx' \\\\ y' \\\\ z'\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n\\cos\\theta  \\sin\\theta  0 \\\\\n-\\sin\\theta  \\cos\\theta  0 \\\\\n0  0  1\n\\end{pmatrix}\n\\begin{pmatrix}\nx \\\\ y \\\\ z\n\\end{pmatrix}.\n$$\nThis choice makes the minimal distance from the origin to the cubical mask equal to $r_{\\mathrm{ex}}$, matching the spherical case, hence ensuring the same horizon proximity.\n\nAnalytic second derivatives of $\\psi$ to be used for error evaluation follow from the Hessian of $1/r$,\n$$\n\\frac{\\partial^2}{\\partial x_i \\partial x_j} \\left(\\frac{1}{r}\\right) = \\frac{3 x_i x_j - r^2 \\delta_{ij}}{r^5}, \\quad r \\neq 0,\n$$\nso that\n$$\n\\frac{\\partial^2 \\psi}{\\partial x^2} = \\frac{M}{2}\\,\\frac{3 x^2 - r^2}{r^5}, \\quad\n\\frac{\\partial^2 \\psi}{\\partial y^2} = \\frac{M}{2}\\,\\frac{3 y^2 - r^2}{r^5}, \\quad\n\\frac{\\partial^2 \\psi}{\\partial z^2} = \\frac{M}{2}\\,\\frac{3 z^2 - r^2}{r^5},\n$$\nand the analytic Laplacian $\\nabla^2 \\psi = 0$ for $r \\neq 0$.\n\nDiscretization rules to implement on a uniform Cartesian grid with spacing $h$:\n- Use the second-order central-difference approximation for second derivatives when both immediate neighbors along an axis are available and not excised:\n$$\n\\left.\\frac{\\partial^2 \\psi}{\\partial x^2}\\right|_{i,j,k} \\approx \\frac{\\psi_{i+1,j,k} - 2 \\psi_{i,j,k} + \\psi_{i-1,j,k}}{h^2},\n$$\nand analogously for the $y$ and $z$ directions.\n- If a central neighbor along an axis is excised or outside the domain, but two consecutive points on the opposite side along that axis are available and not excised, use the one-sided second-order approximation:\n$$\n\\left.\\frac{\\partial^2 \\psi}{\\partial x^2}\\right|_{i,j,k} \\approx \\frac{\\psi_{i,j,k} - 2 \\psi_{i\\pm 1,j,k} + \\psi_{i\\pm 2,j,k}}{h^2},\n$$\nwhere the sign $\\pm$ selects forward ($+$) or backward ($-$) direction depending on which side is available. If neither central nor one-sided stencils can be formed, the derivative at that point is considered unusable.\n- The discrete Laplacian at a point is the sum of the three axial second derivatives, using the above rules, only if all three axial second derivatives are usable.\n- Define a point as “near-boundary” if it is not excised and has at least one immediate neighbor along any axis that is excised.\n\nQuantities to compute and report for each test case:\n- The Hamiltonian constraint residual norm, defined as $\\sqrt{\\dfrac{1}{N}\\sum_{\\mathrm{usable}} \\left(\\nabla^2 \\psi\\right)^2}$ over all points outside the mask where all three axial second derivatives are usable ($N$ is the count of such points).\n- The orientation-dependent metric error, defined as the root-mean-square of the mismatch between numerical and analytic axial second derivatives, restricted to near-boundary points, i.e.,\n$$\n\\sqrt{\\dfrac{1}{N_{\\mathrm{axes}}} \\sum_{\\mathrm{near\\,boundary}} \\sum_{a \\in \\{x,y,z\\}} \\left( D_{aa}^{\\mathrm{num}} - D_{aa}^{\\mathrm{analytic}} \\right)^2 },\n$$\nwhere $D_{aa}^{\\mathrm{num}}$ is the numerical axial second derivative and $D_{aa}^{\\mathrm{analytic}}$ is the corresponding analytic value; sum only includes axes for which the numerical derivative is usable ($N_{\\mathrm{axes}}$ counts such axis contributions).\n\nAngles must be specified in radians. All computed outputs are unitless real numbers. Implement the computation on a cubic domain $[-L,L]^3$ with uniform spacing $h$.\n\nTest suite:\n- Case $1$: spherical mask, $M = 1.0$, $L = 0.6$, $h = 0.02$, $\\Delta = 0.05$, $\\theta = 0.0$ (ignored).\n- Case $2$: cubical mask aligned with grid, $M = 1.0$, $L = 0.6$, $h = 0.02$, $\\Delta = 0.05$, $\\theta = 0.0$.\n- Case $3$: cubical mask rotated, $M = 1.0$, $L = 0.6$, $h = 0.02$, $\\Delta = 0.05$, $\\theta = \\pi/4$.\n\nFinal output format:\nYour program should produce a single line of output containing the six results in the order $[\\text{C}_1,\\text{E}_1,\\text{C}_2,\\text{E}_2,\\text{C}_3,\\text{E}_3]$, where $\\text{C}_i$ is the constraint residual norm and $\\text{E}_i$ is the metric error for case $i$, as a comma-separated list enclosed in square brackets (e.g., $[0.00123,0.00456,0.00101,0.00480,0.00105,0.00490]$). All values must be real numbers without any unit.",
            "solution": "The problem posed is a well-defined exercise in numerical relativity, specifically concerning the implementation and evaluation of black hole excision techniques on a Cartesian grid. It requires a quantitative comparison of two common excision mask geometries—spherical and cubical—by calculating two distinct error metrics: a Hamiltonian constraint residual norm and an orientation-dependent metric error. All physical definitions, mathematical formulas, and numerical rules are provided and are scientifically sound, forming a self-contained and solvable problem. The parameter values given are physically and computationally reasonable. Therefore, the problem is deemed valid and a full solution follows.\n\nThe core of the task is to discretize a known analytic solution—the conformal factor for a Schwarzschild black hole in isotropic coordinates—on a 3D Cartesian grid, apply different excision masks, and then compute errors arising from finite-difference approximations near the created boundaries.\n\n### Principle-Based Design of the Solution\n\nThe solution is structured around a main function that processes each test case by performing a sequence of steps derived from the principles of numerical analysis and computational physics.\n\n1.  **Grid and Field Initialization**: A uniform 3D Cartesian grid is constructed over the domain $[-L, L]^3$ with spacing $h$. On this grid, we evaluate the analytic conformal factor $\\psi(\\mathbf{x}) = 1 + \\frac{M}{2r}$ and its second partial derivatives, $\\frac{\\partial^2 \\psi}{\\partial x_i^2}$. The radial coordinate is $r = \\sqrt{x^2+y^2+z^2}$. To prevent division by zero at the origin ($r=0$), a small epsilon is added to $r$ during computation. This is inconsequential as the origin is always within the excision region ($r_{ex}  0$) and thus excluded from all subsequent calculations.\n\n2.  **Excision Mask Generation**: For each test case, a boolean mask `is_excised` is generated. This 3D array identifies grid points that fall inside the excision region and are to be ignored in derivative calculations.\n    *   **Spherical Mask**: A point at coordinates $(x, y, z)$ is excised if its radial distance $r = \\sqrt{x^2+y^2+z^2}$ is less than the excision radius $r_{\\mathrm{ex}} = \\frac{M}{2} - \\Delta$.\n    *   **Cubical Mask**: A point $(x, y, z)$ is excised if its coordinates, after a rotation by an angle $\\theta$ about the $z$-axis, satisfy $\\max(|x'|, |y'|, |z'|)  r_{\\mathrm{ex}}$. The rotated coordinates are given by $x' = x \\cos\\theta + y \\sin\\theta$ and $y' = -x \\sin\\theta + y \\cos\\theta$.\n\n3.  **Numerical Differentiation with Stencil Hierarchy**: The crucial step is the approximation of second derivatives using finite differences. The problem specifies a hierarchy of stencils to be used, which is a standard practice for handling boundaries in finite-difference methods. For each non-excised point and each spatial direction, we apply the following prioritized sequence:\n    a.  **Second-Order Central Difference**: $\\frac{\\psi_{i+1} - 2\\psi_i + \\psi_{i-1}}{h^2}$. This is the preferred stencil, used whenever both immediate neighbors are available (i.e., within the grid domain and not excised).\n    b.  **One-Sided Difference (Forward)**: If the central difference stencil is unavailable, we attempt to use a one-sided stencil. Following the specified formula, the forward stencil is $\\frac{\\psi_i - 2\\psi_{i+1} + \\psi_{i+2}}{h^2}$. This is attempted if the two forward neighbors are available.\n    c.  **One-Sided Difference (Backward)**: If neither the central nor forward stencil can be applied, we attempt the backward stencil $\\frac{\\psi_i - 2\\psi_{i-1} + \\psi_{i-2}}{h^2}$, provided the two backward neighbors are available.\n    d.  **Unusable Derivative**: If none of these stencils can be formed, the derivative at that point for that axis is considered unusable and marked as such (e.g., with `NaN`).\n\n    This logic is implemented for each of the three spatial derivatives, $\\frac{\\partial^2 \\psi}{\\partial x^2}$, $\\frac{\\partial^2 \\psi}{\\partial y^2}$, and $\\frac{\\partial^2 \\psi}{\\partial z^2}$, resulting in three arrays of numerical derivative values.\n\n4.  **Calculation of Error Metrics**: With both analytic and numerical derivatives computed, we can evaluate the two required error metrics.\n    *   **Hamiltonian Constraint Residual Norm ($C$)**: The discrete Laplacian, $\\nabla^2_h \\psi$, is computed at each point by summing the three numerical second derivatives. A point contributes to this calculation only if all three of its axial derivatives are usable. The norm is then the root-mean-square (RMS) of these Laplacian values over all such usable points. Since the analytic Laplacian is zero, this norm directly measures the discretization error of the Hamiltonian constraint.\n    *   **Orientation-Dependent Metric Error ($E$)**: This error is calculated specifically at points adjacent to the excision boundary. First, we identify all \"near-boundary\" points, defined as non-excised points with at least one immediately adjacent excised neighbor. Then, for this subset of points, we compute the RMS of the difference between the numerical and analytical second derivatives, summed over all three axes where the numerical derivative is usable. This metric is designed to capture the local, orientation-dependent errors introduced by the stencil selection near the jagged, grid-aligned representation of the excision surface.\n\nThe entire procedure is encapsulated and executed for each of the three test cases, and the resulting six scalar values are formatted into the required output.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test suite.\n    \"\"\"\n    test_cases = [\n        {'type': 'spherical', 'M': 1.0, 'L': 0.6, 'h': 0.02, 'Delta': 0.05, 'theta': 0.0},\n        {'type': 'cubical',   'M': 1.0, 'L': 0.6, 'h': 0.02, 'Delta': 0.05, 'theta': 0.0},\n        {'type': 'cubical',   'M': 1.0, 'L': 0.6, 'h': 0.02, 'Delta': 0.05, 'theta': np.pi/4},\n    ]\n\n    results = []\n    for case in test_cases:\n        C, E = solve_case(case)\n        results.extend([C, E])\n\n    # Format the final output string as per problem statement\n    # Example format: [0.00123,0.00456,0.00101,0.00480,0.00105,0.00490]\n    print(f\"[{','.join(f'{x:.7f}' for x in results)}]\")\n\ndef solve_case(params):\n    \"\"\"\n    Solves for a single test case configuration.\n    \"\"\"\n    M, L, h, Delta = params['M'], params['L'], params['h'], params['Delta']\n    mask_type, theta = params['type'], params['theta']\n    \n    r_h = M / 2.0\n    r_ex = r_h - Delta\n\n    # 1. Grid and Field Initialization\n    n_pts = int(round(2 * L / h)) + 1\n    coords_1d = np.linspace(-L, L, n_pts)\n    X, Y, Z = np.meshgrid(coords_1d, coords_1d, coords_1d, indexing='ij')\n\n    # Add a small epsilon to avoid division by zero at r=0.\n    # The origin is always excised as r_ex > 0.\n    R = np.sqrt(X**2 + Y**2 + Z**2)\n    R_safe = R + 1e-15 \n\n    psi = 1.0 + M / (2.0 * R_safe)\n    \n    # Analytic second derivatives\n    R5 = R_safe**5\n    d2psi_dx2_an = (M / 2.0) * (3 * X**2 - R_safe**2) / R5\n    d2psi_dy2_an = (M / 2.0) * (3 * Y**2 - R_safe**2) / R5\n    d2psi_dz2_an = (M / 2.0) * (3 * Z**2 - R_safe**2) / R5\n\n    # 2. Excision Mask Generation\n    if mask_type == 'spherical':\n        is_excised = R  r_ex\n    elif mask_type == 'cubical':\n        cos_t, sin_t = np.cos(theta), np.sin(theta)\n        X_prime = X * cos_t + Y * sin_t\n        Y_prime = -X * sin_t + Y * cos_t\n        Z_prime = Z\n        is_excised = np.maximum(np.abs(X_prime), np.maximum(np.abs(Y_prime), np.abs(Z_prime)))  r_ex\n\n    # 3. Numerical Differentiation\n    d2psi_dx2_num, d2psi_dy2_num, d2psi_dz2_num = compute_numerical_derivatives(psi, h, is_excised)\n\n    # 4. Calculation of Error Metrics\n    \n    # Hamiltonian Constraint Residual Norm (C)\n    laplacian_num = np.full_like(psi, np.nan)\n    valid_lap_mask = ~np.isnan(d2psi_dx2_num)  ~np.isnan(d2psi_dy2_num)  ~np.isnan(d2psi_dz2_num)\n    laplacian_num[valid_lap_mask] = d2psi_dx2_num[valid_lap_mask] + d2psi_dy2_num[valid_lap_mask] + d2psi_dz2_num[valid_lap_mask]\n    \n    usable_laplacians = laplacian_num[~np.isnan(laplacian_num)]\n    if len(usable_laplacians) > 0:\n        constraint_norm = np.sqrt(np.mean(usable_laplacians**2))\n    else:\n        constraint_norm = 0.0\n\n    # Orientation-Dependent Metric Error (E)\n    is_near_boundary = np.zeros_like(psi, dtype=bool)\n    indices = np.argwhere(~is_excised)\n    for i, j, k in indices:\n        for di, dj, dk in [(-1,0,0), (1,0,0), (0,-1,0), (0,1,0), (0,0,-1), (0,0,1)]:\n            ni, nj, nk = i + di, j + dj, k + dk\n            if 0 = ni  n_pts and 0 = nj  n_pts and 0 = nk  n_pts:\n                if is_excised[ni, nj, nk]:\n                    is_near_boundary[i, j, k] = True\n                    break\n\n    sq_errors = []\n    near_boundary_indices = np.argwhere(is_near_boundary)\n    for i, j, k in near_boundary_indices:\n        if not np.isnan(d2psi_dx2_num[i, j, k]):\n            err = d2psi_dx2_num[i, j, k] - d2psi_dx2_an[i, j, k]\n            sq_errors.append(err**2)\n        if not np.isnan(d2psi_dy2_num[i, j, k]):\n            err = d2psi_dy2_num[i, j, k] - d2psi_dy2_an[i, j, k]\n            sq_errors.append(err**2)\n        if not np.isnan(d2psi_dz2_num[i, j, k]):\n            err = d2psi_dz2_num[i, j, k] - d2psi_dz2_an[i, j, k]\n            sq_errors.append(err**2)\n\n    if len(sq_errors) > 0:\n        metric_error = np.sqrt(np.mean(sq_errors))\n    else:\n        metric_error = 0.0\n        \n    return constraint_norm, metric_error\n\n\ndef compute_numerical_derivatives(psi, h, is_excised):\n    \"\"\"\n    Computes all three second partial derivatives using a hierarchical stencil choice.\n    \"\"\"\n    n_pts = psi.shape[0]\n    derivs = []\n    \n    for axis in range(3):  # 0 for x, 1 for y, 2 for z\n        # Create a transposed view of the arrays for generic axis handling\n        psi_ax = np.transpose(psi, (axis, (axis + 1) % 3, (axis + 2) % 3))\n        is_excised_ax = np.transpose(is_excised, (axis, (axis + 1) % 3, (axis + 2) % 3))\n        d2psi_d_axis_2_ax = np.full_like(psi_ax, np.nan)\n        \n        indices = np.argwhere(~is_excised_ax)\n        \n        for i, j, k in indices:\n            # Priority 1: Central difference\n            if 0  i  n_pts - 1 and not is_excised_ax[i-1, j, k] and not is_excised_ax[i+1, j, k]:\n                d2psi_d_axis_2_ax[i,j,k] = (psi_ax[i+1, j, k] - 2 * psi_ax[i, j, k] + psi_ax[i-1, j, k]) / h**2\n                continue\n            \n            # Priority 2: One-sided stencils if central is not possible\n            is_left_excised = (i == 0) or is_excised_ax[i-1, j, k]\n            is_right_excised = (i == n_pts-1) or is_excised_ax[i+1, j, k]\n\n            # Try forward stencil\n            if is_left_excised and not is_right_excised:\n                if i  n_pts - 2 and not is_excised_ax[i+1, j, k] and not is_excised_ax[i+2, j, k]:\n                    d2psi_d_axis_2_ax[i,j,k] = (psi_ax[i, j, k] - 2 * psi_ax[i+1, j, k] + psi_ax[i+2, j, k]) / h**2\n                    continue\n\n            # Try backward stencil\n            if is_right_excised and not is_left_excised:\n                if i > 1 and not is_excised_ax[i-1, j, k] and not is_excised_ax[i-2, j, k]:\n                    d2psi_d_axis_2_ax[i,j,k] = (psi_ax[i, j, k] - 2 * psi_ax[i-1, j, k] + psi_ax[i-2, j, k]) / h**2\n                    continue\n        \n        # Transpose back to original orientation before storing\n        original_axes = np.argsort((axis, (axis + 1) % 3, (axis + 2) % 3))\n        d2psi_d_axis_2 = np.transpose(d2psi_d_axis_2_ax, original_axes)\n        derivs.append(d2psi_d_axis_2)\n        \n    return derivs[0], derivs[1], derivs[2]\n\nif __name__ == '__main__':\n    solve()\n```"
        }
    ]
}