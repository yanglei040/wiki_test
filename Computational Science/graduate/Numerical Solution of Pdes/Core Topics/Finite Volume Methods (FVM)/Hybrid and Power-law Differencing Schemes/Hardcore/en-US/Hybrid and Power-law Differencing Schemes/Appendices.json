{
    "hands_on_practices": [
        {
            "introduction": "To truly grasp the motivation behind hybrid and power-law differencing schemes, it's essential to first experience the problem they were designed to solve. This first practice confronts the fundamental issue of spurious oscillations that arise when using standard central differencing for advection-dominated flows. By simulating the one-dimensional convection-diffusion of a sharp gradient, you will computationally verify the critical role of the cell Péclet number, $Pe$, and witness how the simple switch to an upwind scheme for $Pe \\gt 2$, the core of the hybrid method, effectively suppresses non-physical results at the cost of accuracy. ",
            "id": "3405005",
            "problem": "Consider the one-dimensional linear convection-diffusion equation for a scalar transported quantity $\\,\\phi(x,t)\\,$,\n$$\n\\partial_t \\phi \\;=\\; \\nu\\,\\partial_{xx}\\phi \\;-\\; u\\,\\partial_x \\phi,\n$$\nposed on the periodic domain $[0,1)$ with period $\\,1\\,$, where $\\,\\nu0\\,$ is the kinematic diffusivity and $\\,u\\,$ is a constant advection speed. The initial condition is a step,\n$$\n\\phi(x,0) \\;=\\; \\begin{cases}\n1,  0 \\le x  1/2,\\\\\n0,  1/2 \\le x  1.\n\\end{cases}\n$$\nA periodic boundary condition means $\\,\\phi(0,t)=\\phi(1,t)\\,$ for all $\\,t \\ge 0\\,$. The objective is to demonstrate, from first principles and via computation, how the hybrid differencing switch suppresses spurious oscillations relative to a pure central-differencing discretization in space when advancing this transient solution in time.\n\nStart from the following fundamental base:\n- The equation is linear and its weak formulation admits consistent centered and upwind spatial discretizations.\n- The backward Euler method is unconditionally stable for linear parabolic equations, but it does not by itself enforce a discrete maximum principle; monotonicity depends on the spatial operator’s matrix properties.\n- The cell Peclet number $\\,Pe\\,=\\,|u\\,\\Delta x/\\nu|\\,$ measures the relative strength of advection to diffusion at the grid scale.\n\nDiscretize the spatial domain using a uniform grid with $\\,N\\,$ control volumes of size $\\,\\Delta x \\,=\\, 1/N\\,$. Use backward Euler in time with time step $\\,\\Delta t0\\,$:\n$$\n\\phi^{n+1} \\;-\\; \\phi^{n} \\;=\\; \\Delta t\\;\\Big(\\,\\nu\\,\\partial_{xx}\\phi^{n+1} \\;-\\; u\\,\\partial_x \\phi^{n+1}\\Big),\n$$\nso that\n$$\n\\big(I \\;-\\; \\Delta t\\,L\\big)\\,\\phi^{n+1} \\;=\\; \\phi^{n},\n$$\nwhere $\\,L\\,$ is the discrete spatial operator. For diffusion, use the second-order central difference:\n$$\n\\big(\\partial_{xx}\\phi\\big)_i \\;\\approx\\; \\frac{\\phi_{i+1}-2\\phi_{i}+\\phi_{i-1}}{\\Delta x^2},\n$$\nwith periodic indexing modulo $\\,N\\,$. For advection, compare two spatial discretizations:\n- Central differencing: \n$$\n\\big(\\partial_x \\phi\\big)_i \\;\\approx\\; \\frac{\\phi_{i+1}-\\phi_{i-1}}{2\\Delta x}.\n$$\n- Hybrid differencing switch: define the cell Peclet number $\\,Pe \\,=\\, |u\\,\\Delta x/\\nu|\\,$. If $\\,Pe\\le 2\\,$, use central differencing as above; otherwise, use first-order upwind,\n$$\n\\big(\\partial_x \\phi\\big)_i \\;\\approx\\; \n\\begin{cases}\n\\dfrac{\\phi_{i}-\\phi_{i-1}}{\\Delta x},  u \\ge 0, \\\\[6pt]\n\\dfrac{\\phi_{i+1}-\\phi_{i}}{\\Delta x},  u  0.\n\\end{cases}\n$$\nThis switch is the essence of the hybrid differencing scheme: it reduces to central when $\\,Pe\\,$ is small and switches to upwind when $\\,Pe\\,$ is large to preserve monotonicity.\n\nDefine a quantitative, unitless oscillation metric as the maximal violation of the physically admissible range $[0,1]$ across the grid over the entire simulation:\n$$\n\\mathcal{O} \\;=\\; \\max_{0\\le n\\le n_{\\text{steps}}}\\;\\max\\Big\\{\\;\\max_i \\big(\\phi_i^n - 1\\big)_+,\\;\\max_i \\big(0 - \\phi_i^n\\big)_+\\;\\Big\\},\n$$\nwhere $(z)_+ = \\max\\{z,0\\}$. For each test case, compute two values: $\\,\\mathcal{O}_{\\text{central}}\\,$ and $\\,\\mathcal{O}_{\\text{hybrid}}\\,$.\n\nImplement the algorithm and apply it to the following test suite of parameters, each specified by the tuple $(N,u,\\nu,\\Delta t,n_{\\text{steps}})$:\n- Case A (threshold Peclet): $(\\,N=200,\\;u=2.0,\\;\\nu=0.005,\\;\\Delta t=0.05,\\;n_{\\text{steps}}=40\\,)$, so $\\,Pe = |u\\Delta x/\\nu| = |2\\cdot(1/200)/0.005| = 2$.\n- Case B (advection dominated): $(\\,N=200,\\;u=5.0,\\;\\nu=0.005,\\;\\Delta t=0.05,\\;n_{\\text{steps}}=40\\,)$, so $\\,Pe = 5$.\n- Case C (diffusion dominated): $(\\,N=200,\\;u=2.0,\\;\\nu=0.02,\\;\\Delta t=0.05,\\;n_{\\text{steps}}=40\\,)$, so $\\,Pe = 0.5$.\n- Case D (strong advection, coarser time step): $(\\,N=200,\\;u=10.0,\\;\\nu=0.002,\\;\\Delta t=0.1,\\;n_{\\text{steps}}=20\\,)$, so $\\,Pe = 25$.\n- Case E (advection dominated, fine time step): $(\\,N=200,\\;u=5.0,\\;\\nu=0.005,\\;\\Delta t=0.005,\\;n_{\\text{steps}}=400\\,)$, so $\\,Pe = 5$.\n\nYour program must:\n- Assemble the matrices for $\\,L\\,$ under both spatial choices with periodic indexing.\n- Advance in time using backward Euler, starting from the step initial condition.\n- For each case, compute and store $\\,\\mathcal{O}_{\\text{central}}\\,$ and $\\,\\mathcal{O}_{\\text{hybrid}}\\,$ as real numbers.\n- Produce a single line of output containing the results as a comma-separated list enclosed in square brackets, with entries ordered case-by-case as $[\\mathcal{O}_{\\text{central}}^{(A)},\\mathcal{O}_{\\text{hybrid}}^{(A)},\\mathcal{O}_{\\text{central}}^{(B)},\\mathcal{O}_{\\text{hybrid}}^{(B)},\\ldots]$, rounding each number to $\\,6\\,$ decimal places. For example, an output with three numbers must look like $[\\alpha,\\beta,\\gamma]$ where each of $\\,\\alpha,\\beta,\\gamma\\,$ is written with $\\,6\\,$ decimal places.\n\nAll outputs are dimensionless real numbers; no physical units are required. Angles do not appear. Percentages are not used; do not include any percent signs in your output.",
            "solution": "The supplied problem is a valid exercise in computational fluid dynamics, assessing the behavior of different numerical schemes for the convection-diffusion equation. It is scientifically grounded, well-posed, and all parameters are specified. We will proceed with a solution.\n\nThe problem centers on the one-dimensional linear convection-diffusion equation for a scalar $\\phi(x,t)$:\n$$\n\\partial_t \\phi = \\nu\\,\\partial_{xx}\\phi - u\\,\\partial_x \\phi\n$$\nwhere $\\nu  0$ is the diffusivity and $u$ is a constant advection speed. The equation is posed on a periodic domain $x \\in [0,1)$. By the maximum principle for parabolic partial differential equations, a solution $\\phi(x,t)$ without internal sources or sinks must attain its maximum and minimum values on the boundary of its space-time domain. For a periodic spatial domain, this implies that the solution must remain bounded by the minimum and maximum of its initial values for all time. Given the initial condition\n$$\n\\phi(x,0) = \\begin{cases}\n1,  0 \\le x  1/2,\\\\\n0,  1/2 \\le x  1,\n\\end{cases}\n$$\nthe exact solution must satisfy $0 \\le \\phi(x,t) \\le 1$ for all $x$ and $t \\ge 0$. Numerical solutions may violate these bounds, producing non-physical \"spurious\" oscillations. The objective is to demonstrate how the hybrid differencing scheme suppresses these oscillations compared to a standard central differencing scheme.\n\nWe discretize the spatial domain into $N$ uniform control volumes of width $\\Delta x = 1/N$. The time derivative is discretized using the first-order implicit backward Euler method, which is unconditionally stable for this linear problem:\n$$\n\\frac{\\phi_i^{n+1} - \\phi_i^{n}}{\\Delta t} = \\nu (\\partial_{xx}\\phi^{n+1})_i - u (\\partial_x\\phi^{n+1})_i\n$$\nRearranging terms, we obtain a system of linear equations for the solution vector $\\boldsymbol{\\phi}^{n+1} = (\\phi_0^{n+1}, \\dots, \\phi_{N-1}^{n+1})^T$ at the new time step $n+1$:\n$$\n\\phi_i^{n+1} - \\Delta t \\left( \\nu (\\partial_{xx}\\phi^{n+1})_i - u (\\partial_x\\phi^{n+1})_i \\right) = \\phi_i^n\n$$\nThis system can be written in matrix form as $A \\boldsymbol{\\phi}^{n+1} = \\boldsymbol{\\phi}^n$. The properties of the matrix $A$ are crucial for the monotonicity of the numerical scheme. A sufficient condition for the scheme to be monotonicity-preserving (i.e., to satisfy a discrete maximum principle) is for the matrix $A$ to be an M-matrix. A practical sufficient condition for a matrix to be an M-matrix is that it is irreducibly diagonally dominant, has positive diagonal elements, and non-positive off-diagonal elements.\n\nThe diffusion term is discretized using a standard second-order central difference:\n$$\n(\\partial_{xx}\\phi)_i = \\frac{\\phi_{i+1}-2\\phi_{i}+\\phi_{i-1}}{\\Delta x^2}\n$$\nWe analyze two schemes for the advection term.\n\n**1. Central Differencing (CD) Scheme**\nThe advection term is discretized using a second-order central difference:\n$$\n(\\partial_x \\phi)_i = \\frac{\\phi_{i+1}-\\phi_{i-1}}{2\\Delta x}\n$$\nSubstituting these discretizations into the time-stepped equation and collecting terms for $\\phi_{i-1}^{n+1}$, $\\phi_i^{n+1}$, and $\\phi_{i+1}^{n+1}$ yields the $i$-th row of the linear system:\n$$\n\\left(-\\frac{\\Delta t \\nu}{\\Delta x^2} - \\frac{\\Delta t u}{2\\Delta x}\\right)\\phi_{i-1}^{n+1} + \\left(1 + \\frac{2\\Delta t \\nu}{\\Delta x^2}\\right)\\phi_i^{n+1} + \\left(-\\frac{\\Delta t \\nu}{\\Delta x^2} + \\frac{\\Delta t u}{2\\Delta x}\\right)\\phi_{i+1}^{n+1} = \\phi_i^n\n$$\nDue to the periodic domain, the matrix $A$ is circulant. Its non-zero entries on a typical row $i$ are:\n$$\n\\begin{aligned}\nA_{i,i-1} = -\\frac{\\Delta t \\nu}{\\Delta x^2} \\left(1 + \\frac{u \\Delta x}{2\\nu}\\right) = -\\frac{\\Delta t \\nu}{\\Delta x^2} \\left(1 \\pm \\frac{Pe}{2}\\right) \\\\\nA_{i,i}   = 1 + \\frac{2\\Delta t \\nu}{\\Delta x^2}  0 \\\\\nA_{i,i+1} = -\\frac{\\Delta t \\nu}{\\Delta x^2} \\left(1 - \\frac{u \\Delta x}{2\\nu}\\right) = -\\frac{\\Delta t \\nu}{\\Delta x^2} \\left(1 \\mp \\frac{Pe}{2}\\right)\n\\end{aligned}\n$$\nwhere $Pe = |u|\\Delta x/\\nu$ is the cell Peclet number, and the sign choice depends on the sign of $u$. For the M-matrix condition, all off-diagonal entries must be non-positive. If we assume $u  0$, the term $A_{i,i+1} = -\\frac{\\Delta t \\nu}{\\Delta x^2}(1 - Pe/2)$ becomes positive when $Pe  2$. This violates the condition for being an M-matrix and leads to a loss of diagonal dominance, which is the mathematical origin of the spurious oscillations observed when advection dominates diffusion at the grid scale ($Pe  2$).\n\n**2. Hybrid Differencing Scheme**\nThe hybrid scheme is designed to circumvent this issue. It uses a conditional expression for the advection term based on the cell Peclet number:\n- If $Pe \\le 2$: Use the central difference scheme, as it is non-oscillatory in this regime and offers second-order accuracy. The matrix $A$ is the same as $A_{CD}$.\n- If $Pe  2$: Switch to the first-order upwind (UW) scheme. For $u  0$, the upwind discretization is:\n$$\n(\\partial_x \\phi)_i = \\frac{\\phi_{i}-\\phi_{i-1}}{\\Delta x}\n$$\nThe corresponding row of the system is:\n$$\n\\left(-\\frac{\\Delta t \\nu}{\\Delta x^2} - \\frac{\\Delta t u}{\\Delta x}\\right)\\phi_{i-1}^{n+1} + \\left(1 + \\frac{2\\Delta t \\nu}{\\Delta x^2} + \\frac{\\Delta t u}{\\Delta x}\\right)\\phi_i^{n+1} + \\left(-\\frac{\\Delta t \\nu}{\\Delta x^2}\\right)\\phi_{i+1}^{n+1} = \\phi_i^n\n$$\nThe matrix entries for $u0$ are:\n$$\n\\begin{aligned}\nA_{i,i-1} = -\\frac{\\Delta t \\nu}{\\Delta x^2} (1 + Pe) \\le 0 \\\\\nA_{i,i}   = 1 + \\frac{\\Delta t \\nu}{\\Delta x^2} (2 + Pe)  0 \\\\\nA_{i,i+1} = -\\frac{\\Delta t \\nu}{\\Delta x^2} \\le 0\n\\end{aligned}\n$$\nAll off-diagonal elements are non-positive, and the diagonal element is positive. The matrix is strictly diagonally dominant for any $\\Delta t  0$, as $A_{i,i} - |A_{i,i-1}| - |A_{i,i+1}| = 1  0$. Therefore, it is an M-matrix, and the scheme is unconditionally monotone, guaranteeing that no spurious oscillations will be generated. The trade-off is that the upwind scheme is only first-order accurate, introducing numerical diffusion.\n\nThe algorithm proceeds as follows for each test case $(N, u, \\nu, \\Delta t, n_{\\text{steps}})$:\n1.  Initialize the solution vector $\\boldsymbol{\\phi}^0$ from the given step function.\n2.  Calculate the cell Peclet number $Pe = |u|\\Delta x / \\nu$.\n3.  For the central differencing scheme, assemble the first row of the circulant matrix $A_{CD}$.\n4.  For the hybrid differencing scheme, if $Pe \\le 2$, use $A_{CD}$. If $Pe  2$, assemble the first row of the circulant matrix $A_{UW}$ for the upwind scheme.\n5.  Iterate for $n = 0, \\dots, n_{\\text{steps}}-1$. In each step, solve the circulant linear systems $A_{CD}\\boldsymbol{\\phi}^{n+1}_{CD} = \\boldsymbol{\\phi}^{n}_{CD}$ and $A_{Hybrid}\\boldsymbol{\\phi}^{n+1}_{Hybrid} = \\boldsymbol{\\phi}^{n}_{Hybrid}$. We use `scipy.linalg.solve_circulant` for efficiency.\n6.  At each time step, compute the maximum overshoot $(\\max(\\boldsymbol{\\phi}^n) - 1)$ and undershoot $(-\\min(\\boldsymbol{\\phi}^n))$. The oscillation metric $\\mathcal{O}$ for each scheme is the maximum of these violations (if positive) over all time steps.\n\nThe results from the test cases will demonstrate that for $Pe  2$, $\\mathcal{O}_{\\text{central}}  0$ while $\\mathcal{O}_{\\text{hybrid}} \\approx 0$, confirming the theoretical properties. For $Pe \\le 2$, both schemes are identical, thus $\\mathcal{O}_{\\text{central}} = \\mathcal{O}_{\\text{hybrid}}$.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import solve_circulant\n\ndef solve():\n    \"\"\"\n    Main function to run the simulation for all test cases and print the results.\n    \"\"\"\n    test_cases = [\n        # Case A: Pe = 2\n        (200, 2.0, 0.005, 0.05, 40),\n        # Case B: Pe = 5\n        (200, 5.0, 0.005, 0.05, 40),\n        # Case C: Pe = 0.5\n        (200, 2.0, 0.02, 0.05, 40),\n        # Case D: Pe = 25\n        (200, 10.0, 0.002, 0.1, 20),\n        # Case E: Pe = 5\n        (200, 5.0, 0.005, 0.005, 400),\n    ]\n\n    results = []\n    for case_params in test_cases:\n        O_central, O_hybrid = simulate_case(*case_params)\n        results.append(O_central)\n        results.append(O_hybrid)\n\n    # Format the output as specified.\n    formatted_results = [f\"{r:.6f}\" for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\ndef simulate_case(N, u, nu, dt, n_steps):\n    \"\"\"\n    Solves the convection-diffusion problem for a single test case.\n\n    Args:\n        N (int): Number of control volumes.\n        u (float): Advection speed.\n        nu (float): Kinematic diffusivity.\n        dt (float): Time step size.\n        n_steps (int): Number of time steps.\n\n    Returns:\n        tuple[float, float]: The oscillation metrics (O_central, O_hybrid).\n    \"\"\"\n    dx = 1.0 / N\n\n    # Initialize solution vector phi from the step function initial condition.\n    # phi_i = 1 for 0 = x  1/2, so for i = 0 to N/2 - 1.\n    phi0 = np.zeros(N)\n    phi0[0:N//2] = 1.0\n\n    # Calculate cell Peclet number\n    Pe = np.abs(u * dx / nu)\n\n    # --- Central Differencing Scheme ---\n    # Coefficients for the circulant matrix A_c * phi^{n+1} = phi^{n}\n    c_l_c = -dt * nu / dx**2 - dt * u / (2 * dx)  # Coefficient for phi_{i-1}\n    c_d_c = 1 + 2 * dt * nu / dx**2             # Coefficient for phi_{i}\n    c_u_c = -dt * nu / dx**2 + dt * u / (2 * dx)  # Coefficient for phi_{i+1}\n    \n    # First row of the circulant matrix\n    A_row_c = np.zeros(N)\n    A_row_c[0] = c_d_c\n    A_row_c[1] = c_u_c\n    A_row_c[-1] = c_l_c\n    \n    phi_c = phi0.copy()\n    O_central = 0.0\n    for _ in range(n_steps):\n        phi_c = solve_circulant(A_row_c, phi_c)\n        overshoot = np.max(phi_c) - 1.0\n        undershoot = -np.min(phi_c)\n        current_oscillation = max(0.0, overshoot, undershoot)\n        O_central = max(O_central, current_oscillation)\n\n    # --- Hybrid Differencing Scheme ---\n    phi_h = phi0.copy()\n    O_hybrid = 0.0\n    \n    if Pe = 2:\n        # Hybrid scheme uses central differencing\n        A_row_h = A_row_c\n    else:\n        # Hybrid scheme uses upwind differencing\n        if u = 0:\n            c_l_h = -dt * nu / dx**2 - dt * u / dx\n            c_d_h = 1 + 2 * dt * nu / dx**2 + dt * u / dx\n            c_u_h = -dt * nu / dx**2\n        else: # u  0\n            c_l_h = -dt * nu / dx**2\n            c_d_h = 1 + 2 * dt * nu / dx**2 - dt * u / dx\n            c_u_h = -dt * nu / dx**2 + dt * u / dx\n        \n        A_row_h = np.zeros(N)\n        A_row_h[0] = c_d_h\n        A_row_h[1] = c_u_h\n        A_row_h[-1] = c_l_h\n\n    for _ in range(n_steps):\n        phi_h = solve_circulant(A_row_h, phi_h)\n        overshoot = np.max(phi_h) - 1.0\n        undershoot = -np.min(phi_h)\n        current_oscillation = max(0.0, overshoot, undershoot)\n        O_hybrid = max(O_hybrid, current_oscillation)\n\n    return O_central, O_hybrid\n\nif __name__ == \"__main__\":\n    solve()\n```"
        },
        {
            "introduction": "While the classic hybrid scheme successfully prevents oscillations, its abrupt switch from a second-order accurate scheme to a first-order one is numerically crude and can introduce its own inaccuracies, particularly in flows with stagnation points or regions where the Péclet number hovers near the switching threshold. This practice moves beyond simply applying a scheme to designing a better one. Here, you will analytically derive a *smooth* blending function from first principles, ensuring that the resulting scheme retains second-order accuracy at low Péclet numbers while gracefully transitioning to a stable, upwind-like behavior as convection becomes dominant, laying the groundwork for more sophisticated methods like the power-law scheme. ",
            "id": "3404972",
            "problem": "Consider the one-dimensional steady linear convection–diffusion equation for a passive scalar field $\\,\\phi(x)\\,$,\n$$-\\frac{d}{dx}\\left(\\Gamma \\frac{d\\phi}{dx}\\right) + \\frac{d}{dx}\\left(b(x)\\,\\phi\\right) = 0,\\quad x\\in[-L,L],$$\nwith constant diffusivity $\\,\\Gamma0\\,$ and a stagnation-point velocity field $\\,b(x)=\\beta x\\,$ with $\\,\\beta0\\,$. Impose Dirichlet boundary conditions $\\,\\phi(-L)=1\\,$ and $\\,\\phi(L)=0\\,$ on a uniform mesh with spacing $\\,\\Delta x\\,$. Using the Finite Volume Method (FVM), let the face Péclet number be defined by\n$$Pe \\equiv \\frac{b_f\\,\\Delta x}{\\Gamma},$$\nwhere $\\,b_f\\,$ is the face-normal velocity. The classical hybrid differencing switches discontinuously between central differencing and upwind differencing based on $\\,|Pe|\\,$ (for example, a threshold near $\\,|Pe|\\approx 2\\,$), which can induce nonphysical oscillations when $\\,b(x)\\,$ changes sign at the stagnation point $\\,x=0\\,$.\n\nTo regularize the switching, consider a convex blending of upwind and central differencing at each face using a smooth weight $\\,w(Pe)\\in[0,1]\\,$:\n- $\\,w(Pe)\\,$ multiplies the upwind contribution,\n- $\\,1-w(Pe)\\,$ multiplies the central contribution.\n\nStarting from Taylor expansions of the face interpolation on a uniform mesh and the dimensional analysis of the convective and diffusive fluxes, derive the small-$\\,|Pe|\\,$ constraint on $\\,w(Pe)\\,$ required to retain the second-order accuracy of central differencing near $\\,Pe\\approx 0\\,$. Impose the additional constraints that $\\,w(0)=0\\,$, $\\,w\\,$ is an even and at least once continuously differentiable function of $\\,Pe\\,$, $\\,w\\,$ is nondecreasing in $\\,|Pe|\\,$, and $\\,\\lim_{|Pe|\\to\\infty} w(Pe)=1\\,$ so that upwind is recovered at high $\\,|Pe|\\,$. Among functions satisfying these constraints, choose the simplest rational form in $\\,Pe^2\\,$ that matches the conventional hybrid threshold in the sense that the blending weight attains one-half at $\\,|Pe|=Pe_c\\,$, with $\\,Pe_c=2\\,$.\n\nWhat is the explicit closed-form expression for $\\,w(Pe)\\,$ you obtain? Express your final answer as a symbolic function of $\\,Pe\\,$ with no units. No rounding is required.",
            "solution": "The problem requires the derivation of a smooth blending function, $w(Pe)$, for a hybrid finite volume scheme. This function blends central differencing (CDS) and upwind differencing (UDS) for the convection term in the one-dimensional steady convection-diffusion equation.\n\nThe discretization of the total flux, $F = b\\phi - \\Gamma \\frac{d\\phi}{dx}$, at a control volume face 'f' located between nodes 'P' and 'E' on a uniform mesh with spacing $\\Delta x$ is considered. The diffusive flux is discretized using a second-order central difference: $-\\Gamma \\frac{\\phi_E - \\phi_P}{\\Delta x}$. The convective flux, $b_f \\phi_f$, depends on the interpolated face value $\\phi_f$.\n\nThe blended interpolation for $\\phi_f$ is given by:\n$$ \\phi_f = (1 - w(Pe)) \\phi_f^{CDS} + w(Pe) \\phi_f^{UDS} $$\nwhere $\\phi_f^{CDS} = \\frac{\\phi_P + \\phi_E}{2}$ and $\\phi_f^{UDS}$ is the value at the upwind node. Let us assume $b_f  0$, so the Péclet number $Pe = \\frac{b_f \\Delta x}{\\Gamma}  0$ and $\\phi_f^{UDS} = \\phi_P$. The expression for $\\phi_f$ becomes:\n$$ \\phi_f = (1 - w(Pe)) \\frac{\\phi_P + \\phi_E}{2} + w(Pe)\\phi_P $$\nWe can rewrite this by separating the CDS part and the contribution from the blending:\n$$ \\phi_f = \\frac{\\phi_P + \\phi_E}{2} + w(Pe) \\left( \\phi_P - \\frac{\\phi_P + \\phi_E}{2} \\right) = \\phi_f^{CDS} - w(Pe) \\frac{\\phi_E - \\phi_P}{2} $$\nThe total numerical flux at the face is then:\n$$ F_f = b_f \\phi_f - \\Gamma \\frac{\\phi_E - \\phi_P}{\\Delta x} = b_f \\left( \\phi_f^{CDS} - w(Pe) \\frac{\\phi_E - \\phi_P}{2} \\right) - \\Gamma \\frac{\\phi_E - \\phi_P}{\\Delta x} $$\n$$ F_f = \\left( b_f \\phi_f^{CDS} - \\Gamma \\frac{\\phi_E - \\phi_P}{\\Delta x} \\right) - b_f w(Pe) \\frac{\\phi_E - \\phi_P}{2} $$\nThe term in the parenthesis is the standard second-order central difference discretization of the flux. The additional term represents an artificial diffusion flux. Using a Taylor expansion, $\\phi_E - \\phi_P \\approx \\Delta x (\\frac{d\\phi}{dx})_f$, the additional flux term is:\n$$ - b_f w(Pe) \\frac{\\Delta x}{2} \\left(\\frac{d\\phi}{dx}\\right)_f = - \\left( \\frac{b_f \\Delta x}{\\Gamma} \\right) \\frac{\\Gamma w(Pe)}{2} \\left(\\frac{d\\phi}{dx}\\right)_f = - \\Gamma \\frac{Pe \\, w(Pe)}{2} \\left(\\frac{d\\phi}{dx}\\right)_f $$\nA similar analysis for $b_f  0$ ($Pe  0$), where $\\phi_f^{UDS} = \\phi_E$, yields an artificial diffusion flux of $- \\Gamma \\frac{|Pe| \\, w(Pe)}{2} (\\frac{d\\phi}{dx})_f$. Thus, the scheme is equivalent to adding an artificial diffusivity $\\Gamma_{art}$ to the physical diffusivity $\\Gamma$:\n$$ \\Gamma_{art} = \\Gamma \\frac{|Pe|\\,w(Pe)}{2} $$\nThe central difference scheme is second-order accurate, meaning the truncation error in the discretized conservation equation for a control volume is $O(\\Delta x^2)$. The introduction of the blending term adds an error term equivalent to $-\\frac{d}{dx}(\\Gamma_{art} \\frac{d\\phi}{dx})$. For the overall scheme to retain second-order accuracy, this error term must be at least $O(\\Delta x^2)$.\n$$ -\\frac{d}{dx}\\left(\\Gamma_{art} \\frac{d\\phi}{dx}\\right) = O(\\Delta x^2) $$\nSince differentiation with respect to $x$ scales as $1/\\Delta x$, this requires $\\Gamma_{art}$ to be $O(\\Delta x^3)$.\n$$ \\Gamma_{art} = \\Gamma \\frac{|Pe|\\,w(Pe)}{2} = O(\\Delta x^3) $$\nGiven that $Pe = \\frac{b_f \\Delta x}{\\Gamma}$ is $O(\\Delta x)$, we have $|Pe|\\,w(Pe) = O(\\Delta x^2) = O(Pe^2)$. This implies that for small $|Pe|$, $w(Pe)$ must be $O(|Pe|)$.\n\nHowever, the problem statement imposes additional constraints on $w(Pe)$: it must be an even function ($w(Pe) = w(-Pe)$) and at least once continuously differentiable ($C^1$). For a $C^1$ even function, its derivative is an odd function: $w'(Pe) = -w'(-Pe)$. At $Pe=0$, continuity requires $w'(0) = -w'(0)$, which implies $w'(0) = 0$.\nThe Taylor series expansion of $w(Pe)$ around $Pe=0$ for a $C^1$ even function with $w(0)=0$ and $w'(0)=0$ must begin with a term of order $Pe^2$ or higher:\n$$ w(Pe) = a_2 Pe^2 + a_4 Pe^4 + \\dots $$\nTherefore, for small $|Pe|$, $w(Pe)$ must behave as $O(Pe^2)$. This is a stricter condition than $w(Pe) = O(|Pe|)$, and it is the effective small-$|Pe|$ constraint required by the problem's full set of conditions. This condition is sufficient to preserve second-order accuracy, as it makes $\\Gamma_{art} = \\Gamma \\frac{|Pe| O(Pe^2)}{2} = O(|Pe|^3) = O(\\Delta x^3)$, leading to a truncation error term of $O(\\Delta x^2)$.\n\nNext, we must find the simplest rational form for $w(Pe)$ in terms of $Pe^2$ that satisfies all given constraints. Let $y = Pe^2$. The constraints on $w(y)$ for $y \\ge 0$ are:\n1.  $w(y)$ behaves like $a_2 y$ for small $y$. This ensures $w(0)=0$ and $w'(0)=0$ for $w(Pe)$.\n2.  $w(y)$ is non-decreasing for $y \\ge 0$.\n3.  $\\lim_{y \\to \\infty} w(y) = 1$.\n4.  $w(y_c) = 1/2$ at $y_c = Pe_c^2 = 2^2 = 4$.\n\nWe look for the simplest rational function $w(y) = P(y)/Q(y)$.\nA ratio of first-degree polynomials is $w(y) = \\frac{Ay+B}{Cy+D}$.\nFrom $w(0)=0$, we get $B/D = 0$, which implies $B=0$ (assuming $D \\neq 0$). So, $w(y)=\\frac{Ay}{Cy+D}$.\nFrom $\\lim_{y \\to \\infty} w(y) = 1$, we get $A/C=1$, so we can set $A=C$. The form becomes $w(y) = \\frac{Ay}{Ay+D}$.\nAssuming $A \\neq 0$, we can divide the numerator and denominator by $A$ to get $w(y) = \\frac{y}{y+k}$, where $k=D/A$. This is the simplest rational form in $y$ that satisfies $w(0)=0$ and the limit at infinity.\n\nLet's check the other constraints for $w(y) = \\frac{y}{y+k}$:\n-   Behavior for small $y$: $w(y) = \\frac{y}{k(1+y/k)} \\approx \\frac{y}{k}$. This is linear in $y$, satisfying constraint 1.\n-   Monotonicity: The derivative is $\\frac{dw}{dy} = \\frac{(y+k) \\cdot 1 - y \\cdot 1}{(y+k)^2} = \\frac{k}{(y+k)^2}$. For this to be non-negative for $y \\ge 0$, we need $k \\ge 0$. If $k=0$, $w(y)$ is discontinuous, so we require $k0$.\n\nThe final constraint is the value at the threshold, $w(4) = 1/2$:\n$$ w(4) = \\frac{4}{4+k} = \\frac{1}{2} $$\n$$ 8 = 4+k \\implies k=4 $$\nThus, the constant $k$ is $4$. Substituting this back into the formula for $w(y)$ gives:\n$$ w(y) = \\frac{y}{y+4} $$\nFinally, we substitute $y=Pe^2$ back to obtain the expression for $w(Pe)$:\n$$ w(Pe) = \\frac{Pe^2}{Pe^2+4} $$\nThis function satisfies all the specified conditions. It is a smooth, monotonic ($|Pe| \\ge 0$), even function that blends from CDS ($w=0$) at $Pe=0$ to UDS ($w=1$) as $|Pe| \\to \\infty$, while meeting the specific threshold condition and ensuring second-order accuracy near $Pe=0$.",
            "answer": "$$\n\\boxed{\\frac{Pe^2}{Pe^2+4}}\n$$"
        },
        {
            "introduction": "The final practice synthesizes these concepts by applying a smooth, power-law-based differencing scheme to a more realistic two-dimensional problem within a Finite Volume Method (FVM) framework. You will tackle a convection-diffusion problem featuring a rotating velocity field, a challenging test case where the magnitude and direction of the convective flux vary across the domain. This exercise not only demonstrates how to implement such schemes in a multidimensional context but also introduces the Method of Manufactured Solutions, a powerful and widely-used technique for verifying the accuracy and correctness of a numerical solver. ",
            "id": "3404968",
            "problem": "You are to design and implement a directional hybrid differencing scheme that blends between central differencing and upwind differencing using a smooth, power-law-based weight, explicitly tied to the sign of the face-normal convective flux and the directional Peclet number. The governing equation is the steady two-dimensional convection-diffusion equation for a scalar $\\,\\phi(x,y)\\,$,\n$$\n\\boldsymbol{b}(x,y)\\cdot\\nabla \\phi(x,y) \\;=\\; \\nu \\,\\nabla^2 \\phi(x,y) \\;+\\; s(x,y),\n$$\nwhere $\\boldsymbol{b}(x,y)$ is a prescribed velocity field, $\\nu$ is the diffusion coefficient, and $s(x,y)$ is a source term. Use the Finite Volume Method (FVM) on a uniform Cartesian mesh over the square domain $[0,1]\\times[0,1]$ with Dirichlet boundary conditions. The velocity field is a solid-body rotation about the domain center $(x_0,y_0)=(0.5,0.5)$,\n$$\n\\boldsymbol{b}(x,y) \\;=\\; \\omega\\,\\big(-\\,(y-y_0),\\,x-x_0\\big),\n$$\nwith angular speed $\\,\\omega\\,$. The exact manufactured solution is\n$$\n\\phi_{\\text{exact}}(x,y) \\;=\\; \\cos\\!\\big(2\\pi x\\big)\\,\\cos\\!\\big(2\\pi y\\big),\n$$\nwith gradient and Laplacian\n$$\n\\nabla \\phi_{\\text{exact}}(x,y) \\;=\\; \\Big(-2\\pi\\sin(2\\pi x)\\cos(2\\pi y),\\,-2\\pi\\cos(2\\pi x)\\sin(2\\pi y)\\Big),\n$$\n$$\n\\nabla^2 \\phi_{\\text{exact}}(x,y) \\;=\\; -8\\pi^2\\,\\cos\\!\\big(2\\pi x\\big)\\,\\cos\\!\\big(2\\pi y\\big).\n$$\nDefine the source term by the Method of Manufactured Solutions so that $\\,\\phi_{\\text{exact}}\\,$ satisfies the partial differential equation:\n$$\ns(x,y) \\;=\\; \\boldsymbol{b}(x,y)\\cdot\\nabla \\phi_{\\text{exact}}(x,y) \\;-\\; \\nu \\,\\nabla^2 \\phi_{\\text{exact}}(x,y).\n$$\n\nDiscretize the integral form of the equation over each control volume of size $\\,\\Delta x \\times \\Delta y\\,$. For each control-volume face $\\,f\\,$, let $\\,\\mathbf{n}_f\\,$ be the outward unit normal from the owner cell and $\\,A_f\\,$ the face area. The convective face flux is $\\,F_f = (\\boldsymbol{b}\\cdot\\mathbf{n}_f)\\,A_f\\,$ and the diffusive conductance is $\\,D_f = \\nu\\,A_f/h_f\\,$ where $\\,h_f\\,$ is the cell size in the normal direction (i.e., $\\,h_f=\\Delta x\\,$ for east/west faces and $\\,h_f=\\Delta y\\,$ for north/south faces). The directional Peclet number at the face is\n$$\nP_f \\;=\\; \\frac{\\boldsymbol{b}\\cdot\\mathbf{n}_f}{\\nu}\\,h_f.\n$$\n\nYou must construct a directional hybrid scheme as follows:\n- Define a smooth power-law weight $\\,\\beta(|P_f|)\\in[0,1]\\,$ by\n$$\n\\beta(|P_f|) \\;=\\; 1 \\;-\\; \\max\\!\\Big(0,\\,\\big(1 - 0.1\\,|P_f|\\big)^5\\Big).\n$$\nThis function behaves like central differencing when $\\,|P_f|\\approx 0\\,$ and tends to full upwind as $\\,|P_f|\\,$ grows large, consistent with the classical power-law differencing profile for the one-dimensional convection-diffusion equation.\n- Let $\\,\\phi_{\\text{c}}\\,$ be the central-difference face value, $\\,\\phi_{\\text{c}} = \\tfrac{1}{2}\\big(\\phi_{\\text{owner}}+\\phi_{\\text{neighbor}}\\big)\\,$. Let $\\,\\phi_{\\text{up}}\\,$ be the upwind value chosen by the sign of $\\,F_f\\,$: if $\\,F_f0\\,$, then $\\,\\phi_{\\text{up}}=\\phi_{\\text{owner}}\\,$; if $\\,F_f0\\,$, then $\\,\\phi_{\\text{up}}=\\phi_{\\text{neighbor}}\\,$.\n- Blend directionally:\n$$\n\\phi_f \\;=\\; (1-\\beta(|P_f|))\\,\\phi_{\\text{c}} \\;+\\; \\beta(|P_f|)\\,\\phi_{\\text{up}}.\n$$\nThis must be translated into linear weights on the owner and neighbor values. The resulting face interpolation weights are, for $\\,F_f0\\,$,\n$$\nc_{P,f} \\;=\\; \\frac{1+\\beta(|P_f|)}{2},\\qquad c_{N,f} \\;=\\; \\frac{1-\\beta(|P_f|)}{2},\n$$\nand for $\\,F_f0\\,$,\n$$\nc_{P,f} \\;=\\; \\frac{1-\\beta(|P_f|)}{2},\\qquad c_{N,f} \\;=\\; \\frac{1+\\beta(|P_f|)}{2}.\n$$\nThus $\\,\\phi_f = c_{P,f}\\,\\phi_{\\text{owner}} + c_{N,f}\\,\\phi_{\\text{neighbor}}\\,$. Use these face values $\\,\\phi_f\\,$ to form the convective fluxes, and use two-point central differences for diffusive fluxes.\n\nAssemble the linear system for the unknown interior cell values $\\,\\phi\\,$ with Dirichlet boundary conditions specified by $\\,\\phi_{\\text{exact}}\\,$ on the domain boundary. Solve the resulting sparse linear system to obtain a numerical solution $\\,\\phi_{\\text{num}}\\,$ and evaluate the following quantitative metrics:\n\n- The discrete $L^2$ error over interior cells,\n$$\nE_2 \\;=\\; \\sqrt{ \\frac{\\sum_{P} \\big(\\phi_{\\text{num},P} - \\phi_{\\text{exact},P}\\big)^2\\,\\Delta x\\,\\Delta y}{\\sum_{P} \\Delta x\\,\\Delta y} }.\n$$\n- Upwind consistency boolean $\\,C\\,$: this must be true if, for all interior faces, the upwind side always has the larger interpolation weight, i.e., for each face $\\,f\\,$, $\\,F_f0\\Rightarrow c_{P,f}\\ge c_{N,f}\\,$ and $\\,F_f0\\Rightarrow c_{N,f}\\ge c_{P,f}\\,$.\n- Near-zero-Peclet smoothness boolean $\\,S\\,$: consider all interior faces with $\\,|P_f|\\varepsilon\\,$ where $\\,\\varepsilon=0.2\\,$. Compute $\\,\\delta_f=\\big|c_{P,f}-c_{N,f}\\big|\\,$ and let $\\,\\delta_{\\max}\\,$ be the maximum of $\\,\\delta_f\\,$ over these faces. Set $\\,S\\,$ to true if $\\,\\delta_{\\max}\\le 0.05\\,$.\n\nImplement the above scheme and evaluate it on the following test suite of parameter sets $(N_x,N_y,\\nu,\\omega)$, where $\\,N_x\\,$ and $\\,N_y\\,$ are the number of cells in the $x$ and $y$ directions, respectively:\n- Test $\\,1\\,$ (happy path, moderate directional Peclet): $\\,N_x=N_y=40\\,$, $\\,\\nu=0.02\\,$, $\\,\\omega=10.0\\,$.\n- Test $\\,2\\,$ (convection-dominated, large directional Peclet with sign changes): $\\,N_x=N_y=40\\,$, $\\,\\nu=0.005\\,$, $\\,\\omega=20.0\\,$.\n- Test $\\,3\\,$ (diffusion-dominated, small directional Peclet near zero): $\\,N_x=N_y=40\\,$, $\\,\\nu=1.0\\,$, $\\,\\omega=5.0\\,$.\n- Test $\\,4\\,$ (coarse grid with very large directional Peclet): $\\,N_x=N_y=24\\,$, $\\,\\nu=0.005\\,$, $\\,\\omega=40.0\\,$.\n\nYour program must produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each test case should yield a triple $[E_2,C,S]$. Therefore, the final output should be a single list of four triples with no spaces, e.g.,\n$$\n[ [E_{2,1},C_1,S_1], [E_{2,2},C_2,S_2], [E_{2,3},C_3,S_3], [E_{2,4},C_4,S_4] ].\n$$\nAll quantities are dimensionless; report $\\,E_2\\,$ as a floating-point number and $\\,C,S\\,$ as booleans. The final single-line output must not contain any additional text beyond the specified list.",
            "solution": "The problem requires the implementation of a finite volume method (FVM) to solve the steady two-dimensional convection-diffusion equation on a unit square. The discretization scheme is a specific directional hybrid scheme that blends central and upwind differencing based on a power-law function of the local face Peclet number. The Method of Manufactured Solutions is used for verification.\n\nThe governing equation in integral form over a control volume $V_P$ is\n$$\n\\int_{\\partial V_P} (\\boldsymbol{b}\\phi - \\nu\\nabla\\phi) \\cdot \\mathbf{n} \\, dA = \\int_{V_P} s \\, dV\n$$\nDiscretizing this equation on a Cartesian mesh with cell P and its neighbors (East E, West W, North N, South S) yields a linear algebraic equation. We sum the fluxes over the faces of the control volume:\n$$\nJ_e - J_w + J_n - J_s = \\bar{s}_P \\Delta x \\Delta y\n$$\nwhere $J_f$ is the total flux (convective + diffusive) out of cell P through face $f$, and $\\bar{s}_P$ is the average source term in cell P. The face fluxes are defined in the positive coordinate directions. For instance, the flux through the east face $e$ is\n$$\nJ_e = F_e \\phi_e - D_e (\\phi_E - \\phi_P)\n$$\nHere, $F_e = u_e \\Delta y$ is the convective flux strength, and $D_e = \\nu \\Delta y / \\Delta x$ is the diffusive conductance. The core of the problem lies in defining the face value $\\phi_e$. The problem specifies a directional hybrid scheme:\n$$\n\\phi_f = c_{P,f} \\phi_P + c_{N,f} \\phi_N\n$$\nwhere $P$ is the \"owner\" cell and $N$ is the \"neighbor\". The interpolation weights $c_{P,f}$ and $c_{N,f}$ are functions of the blending factor $\\beta(|P_f|)$, which in turn depends on the face Peclet number $P_f = F_f h_f / (\\nu A_f)$. The definitions are:\n- If $F_f  0$ (flow from P to N): $c_{P,f} = \\frac{1+\\beta}{2}$, $c_{N,f} = \\frac{1-\\beta}{2}$.\n- If $F_f  0$ (flow from N to P): $c_{P,f} = \\frac{1-\\beta}{2}$, $c_{N,f} = \\frac{1+\\beta}{2}$.\nNote that $c_{P,f} + c_{N,f} = 1$.\n\nBy substituting the expression for $\\phi_e$ into the flux equation $J_e$, we can derive the coefficients of the linear system. The flux $J_e$ contributes to the main diagonal coefficient for cell $P$ and the off-diagonal coefficient for cell $E$. The equation for cell $P$ is structured as:\n$$\na_P \\phi_P = a_E \\phi_E + a_W \\phi_W + a_N \\phi_N + a_S \\phi_S + S_u\n$$\nwhere $S_u = \\bar{s}_P \\Delta x \\Delta y$ is the source part. The off-diagonal coefficients are derived from the flux expressions. For example, the flux across face $e$ between $P$ and $E$ is $J_e$. The total contribution of this flux to the balance equation for cell $P$ is $J_e = (F_e c_{P,e} + D_e)\\phi_P - (D_e - F_e c_{E,e})\\phi_E$.\nThis gives the coefficient for neighbor $E$ as $a_E = D_e - F_e c_{E,e}$. Similarly, for the west face $w$ between $W$ and $P$, the flux is $J_w = F_w \\phi_w - D_w(\\phi_P-\\phi_W)$. Its contribution to the balance is $-J_w$. The coefficient for neighbor $W$ is $a_W = D_w + F_w c_{W,w}$. The same logic applies to faces $n$ and $s$.\nThe main diagonal coefficient $a_P$ is the sum of contributions from all faces:\n$$\na_P = (F_e c_{P,e} + D_e) + (D_w - F_w c_{P,w}) + (F_n c_{P,n} + D_n) + (D_s - F_s c_{P,s})\n$$\nThe velocity field $\\boldsymbol{b}$ is divergenceless ($\\nabla \\cdot \\boldsymbol{b} = 0$). For a uniform grid, this implies that the sum of discretized convective fluxes out of a cell, $F_e - F_w + F_n - F_s$, is zero. Using this and $c_{P,f}+c_{N,f}=1$, it can be shown that $a_P = a_E+a_W+a_N+a_S$. This property ensures diagonal dominance of the resulting matrix, which is crucial for the stability and convergence of iterative solvers, although we will use a direct solver.\n\nThe implementation steps are:\n1.  For each test case, set up the grid and physical parameters.\n2.  Define helper functions for the manufactured solution, velocity field, and source term.\n3.  Initialize a sparse matrix `A` and a right-hand-side vector `B` for the linear system $A\\phi=B$.\n4.  Iterate over all interior grid cells $(i, j)$. For each cell, calculate the matrix coefficients $a_P, a_E, a_W, a_N, a_S$.\n5.  Populate the matrix `A` and vector `B`. For neighbors on the boundary, their known $\\phi$ values (from $\\phi_{\\text{exact}}$) contribute to the `B` vector.\n6.  While populating the matrix, evaluate the conditions for the boolean metrics $C$ (upwind consistency) and $S$ (smoothness) on all interior faces.\n7.  Solve the sparse linear system for the unknown interior $\\phi$ values.\n8.  Construct the full numerical solution grid, including boundaries.\n9.  Calculate the $L^2$ error $E_2$ by comparing the numerical solution to the exact solution at interior cell centers.\n10. Finalize the boolean metrics $C$ and $S$ and collect the results.\n\nThis procedure is systematically applied to each test case, and the results are formatted as requested.",
            "answer": "```python\nimport numpy as np\nfrom scipy.sparse import lil_matrix\nfrom scipy.sparse.linalg import spsolve\n\ndef solve():\n    \"\"\"\n    Solves the 2D steady convection-diffusion equation using a finite volume\n    method with a directional power-law hybrid differencing scheme.\n    \"\"\"\n    test_cases = [\n        # (Nx, Ny, nu, omega)\n        (40, 40, 0.02, 10.0),\n        (40, 40, 0.005, 20.0),\n        (40, 40, 1.0, 5.0),\n        (24, 24, 0.005, 40.0),\n    ]\n\n    results = []\n    \n    for Nx, Ny, nu, omega in test_cases:\n        # Domain and Grid Setup\n        Lx, Ly = 1.0, 1.0\n        dx, dy = Lx / Nx, Ly / Ny\n        x_centers = np.linspace(dx/2, Lx - dx/2, Nx)\n        y_centers = np.linspace(dy/2, Ly - dy/2, Ny)\n        x_faces = np.linspace(0, Lx, Nx + 1)\n        y_faces = np.linspace(0, Ly, Ny + 1)\n\n        # Problem-specific functions\n        x0, y0 = 0.5, 0.5\n        \n        def phi_exact(x, y):\n            return np.cos(2 * np.pi * x) * np.cos(2 * np.pi * y)\n\n        def velocity(x, y):\n            u = omega * (-(y - y0))\n            v = omega * (x - x0)\n            return u, v\n\n        def source_term(x, y):\n            # Gradient of phi_exact\n            dphidx = -2 * np.pi * np.sin(2 * np.pi * x) * np.cos(2 * np.pi * y)\n            dphidy = -2 * np.pi * np.cos(2 * np.pi * x) * np.sin(2 * np.pi * y)\n            # Laplacian of phi_exact\n            d2phidx2 = -4 * np.pi**2 * np.cos(2 * np.pi * x) * np.cos(2 * np.pi * y)\n            d2phidy2 = -4 * np.pi**2 * np.cos(2 * np.pi * x) * np.sin(2 * np.pi * y)\n            lap_phi = d2phidx2 + d2phidy2\n            \n            u, v = velocity(x, y)\n            conv_term = u * dphidx + v * dphidy\n            diff_term = nu * lap_phi\n            return conv_term - diff_term\n\n        def beta_func(P_abs):\n            return 1.0 - np.maximum(0.0, (1.0 - 0.1 * P_abs)**5)\n\n        # Assembly of the linear system\n        num_interior_cells = (Nx - 2) * (Ny - 2)\n        A = lil_matrix((num_interior_cells, num_interior_cells), dtype=np.float64)\n        B = np.zeros(num_interior_cells, dtype=np.float64)\n\n        # Metric-related variables\n        is_consistent_C = True\n        max_delta_S = 0.0\n\n        for j in range(1, Ny - 1):\n            for i in range(1, Nx - 1):\n                k_P = (i - 1) + (j - 1) * (Nx - 2)\n                \n                # Cell P information\n                x_P, y_P = x_centers[i], y_centers[j]\n\n                # Source term\n                s_P = source_term(x_P, y_P)\n                Su = s_P * dx * dy\n\n                # Coefficients\n                a_P, a_E, a_W, a_N, a_S = 0.0, 0.0, 0.0, 0.0, 0.0\n\n                # --- East Face (e) ---\n                x_e, y_e = x_faces[i + 1], y_centers[j]\n                u_e, _ = velocity(x_e, y_e)\n                F_e = u_e * dy\n                D_e = nu * dy / dx\n                P_e = u_e * dx / nu\n                beta_e = beta_func(np.abs(P_e))\n                # Weights c_P,f and c_N,f for face e\n                c_Pe = (1 + beta_e * np.sign(F_e)) / 2 if F_e != 0 else 0.5\n                c_Ee = (1 - beta_e * np.sign(F_e)) / 2 if F_e != 0 else 0.5\n                \n                a_E_contr = D_e - F_e * c_Ee\n                a_P += D_e + F_e * c_Pe\n\n                if i == Nx - 2: # Boundary neighbor\n                    phi_E = phi_exact(x_centers[i+1], y_centers[j])\n                    Su += a_E_contr * phi_E\n                else: # Interior neighbor\n                    k_E = (i) + (j - 1) * (Nx - 2)\n                    A[k_P, k_E] = -a_E_contr\n                    # Check metrics C and S for this interior face\n                    if not ((F_e  0 and c_Pe = c_Ee) or (F_e  0 and c_Ee = c_Pe) or F_e == 0):\n                        is_consistent_C = False\n                    if np.abs(P_e)  0.2:\n                        delta_f = np.abs(c_Pe - c_Ee)\n                        max_delta_S = max(max_delta_S, delta_f)\n\n                # --- West Face (w) ---\n                x_w, y_w = x_faces[i], y_centers[j]\n                u_w, _ = velocity(x_w, y_w)\n                F_w = u_w * dy\n                D_w = nu * dy / dx\n                P_w = u_w * dx / nu\n                beta_w = beta_func(np.abs(P_w))\n                # For face w, P is the neighbor and W is the owner\n                c_Ww = (1 + beta_w * np.sign(F_w)) / 2 if F_w != 0 else 0.5\n                c_Pw = (1 - beta_w * np.sign(F_w)) / 2 if F_w != 0 else 0.5\n                \n                a_W_contr = D_w + F_w * c_Ww\n                a_P += D_w - F_w * c_Pw\n\n                if i == 1: # Boundary neighbor\n                    phi_W = phi_exact(x_centers[i-1], y_centers[j])\n                    Su += a_W_contr * phi_W\n                else:\n                    k_W = (i - 2) + (j - 1) * (Nx - 2)\n                    A[k_P, k_W] = -a_W_contr\n                \n                # --- North Face (n) ---\n                x_n, y_n = x_centers[i], y_faces[j + 1]\n                _, v_n = velocity(x_n, y_n)\n                F_n = v_n * dx\n                D_n = nu * dx / dy\n                P_n = v_n * dy / nu\n                beta_n = beta_func(np.abs(P_n))\n                c_Pn = (1 + beta_n * np.sign(F_n)) / 2 if F_n != 0 else 0.5\n                c_Nn = (1 - beta_n * np.sign(F_n)) / 2 if F_n != 0 else 0.5\n\n                a_N_contr = D_n - F_n * c_Nn\n                a_P += D_n + F_n * c_Pn\n\n                if j == Ny - 2: # Boundary neighbor\n                    phi_N = phi_exact(x_centers[i], y_centers[j+1])\n                    Su += a_N_contr * phi_N\n                else:\n                    k_N = (i - 1) + (j) * (Nx - 2)\n                    A[k_P, k_N] = -a_N_contr\n                    # Check metrics C and S for this interior face\n                    if not ((F_n  0 and c_Pn = c_Nn) or (F_n  0 and c_Nn = c_Pn) or F_n == 0):\n                        is_consistent_C = False\n                    if np.abs(P_n)  0.2:\n                        delta_f = np.abs(c_Pn - c_Nn)\n                        max_delta_S = max(max_delta_S, delta_f)\n\n                # --- South Face (s) ---\n                x_s, y_s = x_centers[i], y_faces[j]\n                _, v_s = velocity(x_s, y_s)\n                F_s = v_s * dx\n                D_s = nu * dx / dy\n                P_s = v_s * dy / nu\n                beta_s = beta_func(np.abs(P_s))\n                c_Ss = (1 + beta_s * np.sign(F_s)) / 2 if F_s != 0 else 0.5\n                c_Ps = (1 - beta_s * np.sign(F_s)) / 2 if F_s != 0 else 0.5\n\n                a_S_contr = D_s + F_s * c_Ss\n                a_P += D_s - F_s * c_Ps\n\n                if j == 1: # Boundary neighbor\n                    phi_S = phi_exact(x_centers[i], y_centers[j-1])\n                    Su += a_S_contr * phi_S\n                else:\n                    k_S = (i - 1) + (j - 2) * (Nx - 2)\n                    A[k_P, k_S] = -a_S_contr\n                \n                A[k_P, k_P] = a_P\n                B[k_P] = Su\n\n        # Solve system\n        phi_interior_1d = spsolve(A.tocsc(), B)\n        phi_num_interior = phi_interior_1d.reshape((Ny - 2, Nx - 2))\n\n        # Calculate metrics\n        phi_exact_interior = np.zeros_like(phi_num_interior)\n        for j in range(Ny - 2):\n            for i in range(Nx - 2):\n                phi_exact_interior[j, i] = phi_exact(x_centers[i+1], y_centers[j+1])\n        \n        # E2 error\n        sum_sq_err = np.sum((phi_num_interior - phi_exact_interior)**2)\n        E2 = np.sqrt(sum_sq_err / num_interior_cells)\n\n        # C and S booleans\n        C = is_consistent_C\n        S = max_delta_S = 0.05\n        \n        results.append(f\"[{E2:.10f},{str(C).lower()},{str(S).lower()}]\")\n\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        }
    ]
}