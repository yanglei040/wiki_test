{
    "hands_on_practices": [
        {
            "introduction": "The foundation of structure-preserving methods for conservation laws lies in the \"conservative\" form of the discretization, where the update is expressed in terms of numerical fluxes at cell boundaries. This practice provides a direct, analytical exercise to demonstrate how any scheme written in this flux-difference form naturally conserves the total discrete mass on a periodic domain. By working through this foundational example for the linear advection equation, you will solidify your understanding of how a discrete invariant arises directly from the structure of the numerical method .",
            "id": "3450230",
            "problem": "Consider the linear advection partial differential equation (PDE) $u_{t} + (a u)_{x} = 0$ on the periodic domain $[0, 2\\pi]$ with constant advection speed $a \\in \\mathbb{R}$. Let the domain be partitioned into $N \\in \\mathbb{N}$ uniform control volumes of width $h = \\frac{2\\pi}{N}$, with cell centers $x_{i} = \\left(i + \\frac{1}{2}\\right) h$ for $i = 0, 1, \\dots, N-1$, and denote by $u_{i}^{n}$ the approximation to the cell average of $u$ over cell $i$ at time level $t^{n} = n \\,\\Delta t$, where $\\Delta t > 0$ is a fixed time step.\n\nStarting from the integral conservation form of the PDE and the definition of a conservative flux, construct a numerical flux $F_{i+1/2}$ at each cell interface $x_{i+1/2} = x_{i} + \\frac{h}{2}$ that is consistent with the physical flux $f(u) = a u$ and leads to a conservative fully discrete finite-volume update. Then, using periodic boundary conditions and the discrete update you obtain, derive the evolution law of the discrete mass\n$$\nM^{n} = h \\sum_{i=0}^{N-1} u_{i}^{n}\n$$\nand determine whether $M^{n}$ is invariant in $n$.\n\nFinally, take the sinusoidal initial condition\n$$\nu_{i}^{0} = \\sin\\!\\big(m x_{i}\\big)\n$$\nwith $m \\in \\mathbb{N}$, and compute the value of $M^{n}$ for all $n \\geq 0$ explicitly as a single real number. Assume $N \\geq 1$ is arbitrary but fixed, and that the time integration uses a single-step explicit method consistent with the flux you construct. Express your final answer with no units. No rounding is required; provide the exact value.",
            "solution": "The problem is well-posed and scientifically grounded, providing a standard exercise in the analysis of numerical methods for partial differential equations. All data and conditions are sufficient for a unique solution.\n\nThe linear advection equation is given by $u_{t} + (a u)_{x} = 0$, which can be written in conservation law form as $u_{t} + f(u)_{x} = 0$, where the physical flux is $f(u) = a u$.\n\nWe begin by applying the finite volume method. Integrating the PDE over a control volume $C_{i} = [x_{i-1/2}, x_{i+1/2}]$ from time $t^{n}$ to $t^{n+1}$ yields:\n$$\n\\int_{t^{n}}^{t^{n+1}} \\int_{x_{i-1/2}}^{x_{i+1/2}} u_{t} \\,dx\\,dt + \\int_{t^{n}}^{t^{n+1}} \\int_{x_{i-1/2}}^{x_{i+1/2}} (a u)_{x} \\,dx\\,dt = 0\n$$\nApplying the fundamental theorem of calculus twice gives:\n$$\n\\int_{x_{i-1/2}}^{x_{i+1/2}} \\left( u(x, t^{n+1}) - u(x, t^{n}) \\right) \\,dx + \\int_{t^{n}}^{t^{n+1}} \\left( f(u(x_{i+1/2}, t)) - f(u(x_{i-1/2}, t)) \\right) \\,dt = 0\n$$\nLet $u_{i}(t) = \\frac{1}{h} \\int_{x_{i-1/2}}^{x_{i+1/2}} u(x, t) \\,dx$ be the exact cell average of $u$ over cell $C_i$. The equation becomes:\n$$\nh \\left( u_{i}(t^{n+1}) - u_{i}(t^{n}) \\right) + \\int_{t^{n}}^{t^{n+1}} \\left( f(u(x_{i+1/2}, t)) - f(u(x_{i-1/2}, t)) \\right) \\,dt = 0\n$$\nA fully discrete finite-volume scheme is obtained by approximating the cell average $u_i(t^n)$ by $u_i^n$ and the time integral of the flux difference by $\\Delta t$ times a numerical flux difference evaluated at time $t^n$. A numerical flux $F_{i+1/2}$ is a function that approximates the physical flux $f(u)$ at the cell interface $x_{i+1/2}$. For the scheme to be conservative, it must be expressible in the form:\n$$\nu_{i}^{n+1} = u_{i}^{n} - \\frac{\\Delta t}{h} \\left( F_{i+1/2}^{n} - F_{i-1/2}^{n} \\right)\n$$\nwhere $F_{i+1/2}^{n}$ is the numerical flux at the interface $x_{i+1/2}$ at time $t^n$. The flux is computed using the cell-average data from neighboring cells (e.g., $u_{i}^{n}$ and $u_{i+1}^{n}$). For the flux to be consistent with the physical flux $f(u) = a u$, it must satisfy $F(u, u, \\dots) = f(u) = a u$.\nThe problem does not require specifying the exact form of the flux (e.g., upwind, Lax-Friedrichs, etc.), only that it is consistent and part of a conservative update rule. The analysis of mass conservation relies only on the conservative form of the update and the periodic boundary conditions.\n\nThe total discrete mass at time $t^{n}$ is defined as $M^{n} = h \\sum_{i=0}^{N-1} u_{i}^{n}$.\nTo find the evolution law of $M^{n}$, we compute $M^{n+1}$:\n$$\nM^{n+1} = h \\sum_{i=0}^{N-1} u_{i}^{n+1}\n$$\nSubstituting the conservative update formula for $u_{i}^{n+1}$:\n$$\nM^{n+1} = h \\sum_{i=0}^{N-1} \\left[ u_{i}^{n} - \\frac{\\Delta t}{h} \\left( F_{i+1/2}^{n} - F_{i-1/2}^{n} \\right) \\right]\n$$\nDistributing the summation:\n$$\nM^{n+1} = h \\sum_{i=0}^{N-1} u_{i}^{n} - \\Delta t \\sum_{i=0}^{N-1} \\left( F_{i+1/2}^{n} - F_{i-1/2}^{n} \\right)\n$$\nThe first term is exactly the mass at time $t^n$, $M^n$. The second term is a telescoping sum. Due to periodicity, the flux leaving cell $N-1$ enters cell $0$, so the net sum of fluxes over the whole domain is zero. A more formal way to see this is:\n$$\n\\sum_{i=0}^{N-1} \\left( F_{i+1/2}^{n} - F_{i-1/2}^{n} \\right) = \\sum_{i=0}^{N-1} F_{i+1/2}^{n} - \\sum_{i=0}^{N-1} F_{i-1/2}^{n}\n$$\nBy re-indexing the first sum with $j=i+1$ and the second with $j=i$, and using the periodicity of fluxes (e.g., $F_{N+1/2}=F_{1/2}$), all terms cancel. Thus, the sum is zero.\nThus, the evolution law for the discrete mass is:\n$$\nM^{n+1} = M^{n} - \\Delta t \\cdot 0 = M^{n}\n$$\nThis demonstrates that the discrete mass $M^{n}$ is an invariant of the numerical scheme. This means $M^{n}$ is constant for all $n \\geq 0$, and its value is determined by the initial condition, $M^{n} = M^{0}$.\n\nWe now compute the value of $M^{0}$ for the given initial condition $u_{i}^{0} = \\sin(m x_{i})$, where $m \\in \\mathbb{N}$.\n$$\nM^{0} = h \\sum_{i=0}^{N-1} u_{i}^{0} = h \\sum_{i=0}^{N-1} \\sin(m x_{i})\n$$\nSubstitute the definitions for $x_{i}$ and $h$:\n$x_{i} = \\left(i + \\frac{1}{2}\\right) h$ and $h = \\frac{2\\pi}{N}$.\n$$\nM^{0} = \\frac{2\\pi}{N} \\sum_{i=0}^{N-1} \\sin\\left(m \\left(i + \\frac{1}{2}\\right) \\frac{2\\pi}{N}\\right) = \\frac{2\\pi}{N} \\sum_{i=0}^{N-1} \\sin\\left(\\frac{2\\pi m i}{N} + \\frac{\\pi m}{N}\\right)\n$$\nTo evaluate this sum, we use Euler's formula, $\\sin(\\theta) = \\operatorname{Im}(\\exp(i \\theta))$, where $i^2=-1$.\nLet $S = \\sum_{i=0}^{N-1} \\exp\\left(i \\left(\\frac{2\\pi m i}{N} + \\frac{\\pi m}{N}\\right)\\right)$. The sum of sines is $\\operatorname{Im}(S)$.\n$$\nS = \\sum_{i=0}^{N-1} \\exp\\left(i \\frac{2\\pi m i}{N}\\right) \\exp\\left(i \\frac{\\pi m}{N}\\right) = \\exp\\left(i \\frac{\\pi m}{N}\\right) \\sum_{i=0}^{N-1} \\left(\\exp\\left(i \\frac{2\\pi m}{N}\\right)\\right)^{i}\n$$\nThis is a geometric series with ratio $r = \\exp(i \\frac{2\\pi m}{N})$.\n\nCase 1: $m$ is a multiple of $N$.\nLet $m = k N$ for some integer $k \\in \\mathbb{N}$. Then $r = \\exp(i \\frac{2\\pi k N}{N}) = \\exp(i 2\\pi k) = 1$.\nThe sum becomes $\\sum_{i=0}^{N-1} 1^{i} = N$.\nIn this case, $S = \\exp(i \\frac{\\pi k N}{N}) \\cdot N = N \\exp(i \\pi k) = N (\\cos(k\\pi) + i\\sin(k\\pi)) = N(-1)^{k}$.\nSince $S$ is a real number, its imaginary part is $\\operatorname{Im}(S) = 0$.\n\nCase 2: $m$ is not a multiple of $N$.\nIn this case, $r \\neq 1$. The sum of the geometric series is $\\frac{1-r^{N}}{1-r}$.\nThe term $r^{N}$ is:\n$$\nr^{N} = \\left(\\exp\\left(i \\frac{2\\pi m}{N}\\right)\\right)^{N} = \\exp(i 2\\pi m) = 1\n$$\nsince $m$ is an integer. The numerator is $1 - 1 = 0$, so the sum of the series is $0$.\nThen $S = \\exp(i \\frac{\\pi m}{N}) \\cdot 0 = 0$.\nThe imaginary part is $\\operatorname{Im}(S) = 0$.\n\nIn both cases, the sum of the sine terms is $0$.\n$$\n\\sum_{i=0}^{N-1} \\sin\\left(m \\left(i + \\frac{1}{2}\\right) \\frac{2\\pi}{N}\\right) = 0\n$$\nTherefore, the initial mass is:\n$$\nM^{0} = h \\cdot 0 = 0\n$$\nSince the discrete mass is invariant, $M^{n} = M^{0}$ for all $n \\geq 0$. We conclude that $M^{n} = 0$ for all $n \\geq 0$.",
            "answer": "$$\\boxed{0}$$"
        },
        {
            "introduction": "After establishing the principle of conservation, it is crucial to understand its practical importance, especially for nonlinear problems. This practice offers a compelling numerical experiment comparing a conservative finite-volume method against a non-conservative finite-difference scheme for the viscous Burgers' equation, which is known to develop shock-like structures. You will quantitatively observe how only the conservative scheme correctly handles physical invariants like mass and the energy balance, a critical feature for obtaining physically meaningful solutions when discontinuities are present .",
            "id": "3450238",
            "problem": "Consider the viscous Burgers partial differential equation on the periodic domain $[0,2\\pi]$,\n$$ u_t + \\frac{1}{2}(u^2)_x = \\nu u_{xx}, $$\nwith initial condition $u(x,0)=\\sin(x)$ and viscosity parameter $\\nu>0$. The focus is to compare numerically two spatial discretizations of the advective term on shock-dominated regimes and smooth regimes, and to quantify differences in mass conservation, energy balance, and entropy production. The comparison must be conducted within a consistent time integration framework and under periodic boundary conditions.\n\nThe advective term has two spatial discretization choices:\n\n- A conservative finite-volume discretization using a monotone numerical flux for the physical flux $f(u)=\\frac{1}{2}u^2$, with two reconstruction choices:\n  1. Piecewise constant reconstruction (first order).\n  2. Piecewise linear reconstruction with the minmod slope limiter (MUSCL).\n- A nonconservative finite-difference discretization of the advective term in the nonconservative form $u\\,u_x$, with $u_x$ approximated by a centered difference.\n\nThe viscous term is discretized with a second-order centered difference approximation of $u_{xx}$. Time integration must use the two-stage Strong Stability Preserving (SSP) Runge–Kutta method with a constant time step satisfying explicit stability constraints.\n\nFundamental base for derivation:\n- The viscous Burgers equation admits a mass invariant under periodic boundary conditions, meaning the spatial integral $M(t)=\\int_0^{2\\pi} u(x,t)\\,dx$ is constant in time for sufficiently smooth solutions.\n- The quadratic energy $E(t)=\\int_0^{2\\pi}\\frac{1}{2}u(x,t)^2\\,dx$ satisfies the balance\n$$ \\frac{d}{dt}E(t) = -\\nu \\int_0^{2\\pi} u_x(x,t)^2\\,dx, $$\nunder periodic boundary conditions. This is also an entropy inequality for the convex entropy $\\eta(u)=\\frac{1}{2}u^2$ with entropy flux $q(u)=\\frac{1}{3}u^3$; in particular, entropy production is nonnegative and equals $\\nu\\int_0^{2\\pi}u_x^2\\,dx$.\n- Conservative discretizations of the advective flux preserve a discrete mass invariant and admit a discrete entropy balance when used with consistent numerical fluxes and periodic boundary conditions. Nonconservative discretizations generally do not preserve mass and may corrupt entropy balance near shocks.\n\nYou must design and implement a complete program that:\n1. Discretizes the spatial domain with $N$ uniform cells over $[0,2\\pi]$, with cell centers and periodic indexing.\n2. Implements the conservative finite-volume discretization of the advective term using the Engquist–Osher monotone flux for $f(u)=\\frac{1}{2}u^2$ at cell faces, with two reconstruction choices:\n   - Piecewise constant reconstruction.\n   - Piecewise linear reconstruction with the minmod slope limiter. The minmod limiter is defined by\n     $$ \\operatorname{minmod}(a,b) = \\frac{1}{2}\\left(\\operatorname{sign}(a)+\\operatorname{sign}(b)\\right)\\min\\{|a|,|b|\\}. $$\n     The left and right interface states at face $i+\\frac{1}{2}$ must be reconstructed from neighboring cell averages using this limited slope.\n3. Implements the nonconservative finite-difference discretization of the advective term based on its product form $u\\,u_x$, where $u_x$ is approximated by the centered difference\n   $$ (u_x)_i \\approx \\frac{u_{i+1}-u_{i-1}}{2\\Delta x}. $$\n4. Discretizes the viscous term $u_{xx}$ with the centered second difference\n   $$ (u_{xx})_i \\approx \\frac{u_{i+1}-2u_i+u_{i-1}}{\\Delta x^2}. $$\n5. Advances the solution in time to a final time $T$ using the two-stage Strong Stability Preserving (SSP) Runge–Kutta method with constant time step $\\Delta t$ chosen to satisfy the explicit stability constraints\n   $$ \\Delta t \\le C \\min\\left(\\frac{\\Delta x}{\\max|u|},\\frac{\\Delta x^2}{\\nu}\\right), $$\n   with $C=0.4$, and adjusted to hit $T$ exactly by setting the number of uniform steps and using $\\Delta t=T/\\text{steps}$.\n6. Computes the following diagnostics for each run at the end time $T$:\n   - Discrete mass $M^n=\\Delta x\\sum_i u_i^n$ and the absolute mass error $|M^N - M^0|$.\n   - Discrete energy $E^n=\\Delta x\\sum_i \\frac{1}{2}(u_i^n)^2$.\n   - A numerical approximation of the time-integrated entropy production\n     $$ \\mathcal{D}_{\\text{num}} = \\nu \\int_0^T \\int_0^{2\\pi} u_x(x,t)^2\\,dx\\,dt, $$\n     computed by replacing $u_x$ with the centered difference for $u_x$ and using the trapezoidal rule over each SSP stage within each time step.\n   - The energy balance residual\n     $$ R = \\left(E^0 - E^N\\right) - \\mathcal{D}_{\\text{num}}, $$\n     and the boolean indicating energy monotonicity $E^N \\le E^0$.\n7. Uses periodic boundary conditions in all spatial discretizations.\n\nTest suite and coverage:\n- Case $1$: conservative advective discretization, piecewise constant reconstruction, $N=256$, $\\nu=10^{-3}$, $T=0.4$.\n- Case $2$: conservative advective discretization, piecewise linear MUSCL reconstruction with the minmod limiter, $N=256$, $\\nu=10^{-3}$, $T=0.4$.\n- Case $3$: nonconservative advective discretization ($u\\,u_x$), $N=256$, $\\nu=10^{-3}$, $T=0.4$.\n- Case $4$: nonconservative advective discretization on a coarse grid to test under-resolution near shocks, $N=64$, $\\nu=10^{-3}$, $T=0.4$.\n- Case $5$: conservative advective discretization, piecewise constant reconstruction in a smooth regime, $N=128$, $\\nu=10^{-1}$, $T=0.4$.\n\nFor each case, your program must compute and return a list containing four entries in the order:\n- The absolute mass error $|M^N - M^0|$ as a floating-point number.\n- The energy balance residual $R$ as a floating-point number.\n- The boolean energy monotonicity indicator, equal to $\\text{True}$ if $E^N \\le E^0$ and $\\text{False}$ otherwise.\n- The numerical entropy production $\\mathcal{D}_{\\text{num}}$ as a floating-point number.\n\nFinal output format:\nYour program should produce a single line of output containing the results for all cases as a comma-separated list of per-case result lists enclosed in square brackets, for example, $[\\,[m_1,r_1,b_1,d_1],\\,[m_2,r_2,b_2,d_2],\\,\\dots\\,]$. No other output is permitted. Angles do not appear and no physical units are required, so no unit specification is needed. All returned values must be of fundamental types (floating-point numbers and boolean values) as specified above.",
            "solution": "The problem requires the implementation and comparison of several numerical schemes for the viscous Burgers' equation, $u_t + \\frac{1}{2}(u^2)_x = \\nu u_{xx}$, on a periodic domain $[0, 2\\pi]$ with initial condition $u(x,0)=\\sin(x)$. The comparison focuses on mass conservation, energy balance, and entropy production for different spatial discretizations of the advective term.\n\nFirst, we establish the numerical framework. The spatial domain $[0, 2\\pi]$ is discretized into $N$ uniform cells of width $\\Delta x = 2\\pi/N$. The cell centers are located at $x_i = i \\Delta x$ for $i=0, \\dots, N-1$. The solution is represented by a vector of cell averages, $u = [u_0, u_1, \\dots, u_{N-1}]^T$. Periodic boundary conditions are enforced, meaning indices are treated modulo $N$.\n\nThe semi-discretized form of the PDE is an ordinary differential equation (ODE) system, $\\frac{d\\vec{u}}{dt} = \\vec{L}(\\vec{u})$, where $\\vec{L}$ is the spatial operator. This operator is a sum of the viscous and advective parts: $L(u)_i = L_{visc}(u)_i + L_{adv}(u)_i$.\n\nThe viscous term, $\\nu u_{xx}$, is discretized using a standard second-order centered finite difference approximation, which is consistent for all test cases:\n$$ L_{visc}(u)_i = \\nu \\frac{u_{i+1} - 2u_i + u_{i-1}}{\\Delta x^2} $$\nPeriodicity is handled by taking $u_{N}=u_0$ and $u_{-1}=u_{N-1}$.\n\nThe advective term, $-\\frac{1}{2}(u^2)_x = -u u_x$, is discretized using three different approaches as specified:\n\n1.  **Nonconservative Finite Difference**: The term is treated in its nonconservative form $-u u_x$. The spatial derivative $u_x$ is approximated by a second-order centered difference:\n    $$ L_{adv}(u)_i = -u_i \\frac{u_{i+1} - u_{i-1}}{2\\Delta x} $$\n    This scheme is simple but is known to violate the conservation of mass, which can lead to incorrect shock speeds in the weak solution limit.\n\n2.  **Conservative Finite Volume (Piecewise Constant)**: This first-order scheme is based on the integral form of the conservation law. The update for cell $i$ is driven by the numerical fluxes at its boundaries, $\\hat{f}_{i-1/2}$ and $\\hat{f}_{i+1/2}$:\n    $$ L_{adv}(u)_i = -\\frac{1}{\\Delta x} (\\hat{f}_{i+1/2} - \\hat{f}_{i-1/2}) $$\n    The states to the left and right of the interface $i+1/2$ are $u_L = u_i$ and $u_R = u_{i+1}$. The Engquist–Osher (EO) monotone flux for $f(u)=\\frac{1}{2}u^2$ is used. Since $f'(u)=u$, the flux splits based on the sign of $u$. The EO flux is $\\hat{f}^{EO}(u_L, u_R) = f^+(u_L) + f^-(u_R)$, where $f^+(u) = f(u)$ if $u>0$ and $0$ otherwise, and $f^-(u) = f(u)$ if $u \\le 0$ and $0$ otherwise.\n\n3.  **Conservative Finite Volume (MUSCL)**: This second-order extension uses piecewise linear reconstruction within each cell to achieve higher accuracy. The cell-wise slope $\\delta_i$ is computed using the `minmod` limiter to prevent spurious oscillations near sharp gradients:\n    $$ \\delta_i = \\operatorname{minmod}\\left(\\frac{u_{i+1}-u_i}{\\Delta x}, \\frac{u_i-u_{i-1}}{\\Delta x}\\right) $$\n    where $\\operatorname{minmod}(a,b) = \\frac{1}{2}(\\operatorname{sign}(a)+\\operatorname{sign}(b))\\min(|a|,|b|)$. The reconstructed states at the interface $i+1/2$ are:\n    $$ u^L_{i+1/2} = u_i + \\delta_i \\frac{\\Delta x}{2}, \\quad u^R_{i+1/2} = u_{i+1} - \\delta_{i+1} \\frac{\\Delta x}{2} $$\n    These states are then used in the Engquist–Osher flux calculation as before.\n\nTime integration is performed using the two-stage Strong Stability Preserving (SSP) Runge–Kutta method (also known as Heun's method):\n$$ u^{(1)} = u^n + \\Delta t L(u^n) $$\n$$ u^{n+1} = \\frac{1}{2}u^n + \\frac{1}{2}\\left(u^{(1)} + \\Delta t L(u^{(1)})\\right) $$\nThe time step $\\Delta t$ is constant, chosen at the beginning of the simulation to satisfy the CFL stability condition $\\Delta t \\le C \\min(\\frac{\\Delta x}{\\max|u|}, \\frac{\\Delta x^2}{\\nu})$ with $C=0.4$. Since the maximum principle holds for the viscous Burgers' equation, $\\max|u|$ at any time is bounded by its initial maximum. The number of steps is computed to reach the final time $T$ exactly.\n\nTo evaluate the performance of each scheme, several diagnostics are computed:\n-   **Absolute Mass Error**: $|M^N - M^0|$, where the discrete mass is $M^n = \\Delta x \\sum_i u_i^n$. For the continuous PDE with periodic boundaries, mass $M(t)=\\int_0^{2\\pi} u(x,t) dx$ is conserved. For the initial condition $u(x,0)=\\sin(x)$, the initial mass is $M^0=0$.\n-   **Energy Balance Residual**: $R = (E^0 - E^N) - \\mathcal{D}_{\\text{num}}$. The discrete energy is $E^n = \\Delta x \\sum_i \\frac{1}{2}(u_i^n)^2$. The continuous energy balance is $\\frac{dE}{dt} = - \\nu \\int_0^{2\\pi} u_x^2 dx$. The residual $R$ measures how well the numerical scheme preserves this balance. $\\mathcal{D}_{\\text{num}}$ is the time-integrated numerical entropy production, calculated as:\n    $$ \\mathcal{D}_{\\text{num}} = \\int_0^T \\left( \\nu \\Delta x \\sum_i \\left(\\frac{u_{i+1}(t)-u_{i-1}(t)}{2\\Delta x}\\right)^2 \\right) dt $$\n    This time integral is approximated using a quadrature rule consistent with the SSP-RK2 integrator, applying the trapezoidal rule over the two stages of each time step.\n-   **Energy Monotonicity**: A boolean flag indicating if $E^N \\le E^0$, as expected from the continuous energy balance.\n\nThe implementation is vectorized using NumPy, where periodic indexing is efficiently handled by `np.roll`. A main function iterates through the five specified test cases, runs the simulation for each, computes the diagnostics, and formats the output.",
            "answer": "```python\nimport numpy as np\nimport math\n\ndef minmod(a, b):\n    \"\"\"\n    Implements the minmod function as defined in the problem.\n    minmod(a,b) = 1/2 * (sign(a) + sign(b)) * min(|a|,|b|)\n    This is zero if signs differ, and the value with smaller magnitude if signs are the same.\n    \"\"\"\n    sign_a = np.sign(a)\n    sign_b = np.sign(b)\n    return 0.5 * (sign_a + sign_b) * np.minimum(np.abs(a), np.abs(b))\n\ndef spatial_entropy_integrand(u, dx, nu):\n    \"\"\"\n    Computes the discrete spatial integral of nu * u_x^2.\n    The integral is approximated by a sum, where u_x is a centered difference.\n    integral(nu * u_x^2, dx) approx nu * sum( ( (u_{i+1}-u_{i-1})/(2*dx) )^2 * dx )\n    \"\"\"\n    u_xp = np.roll(u, -1)\n    u_xm = np.roll(u, 1)\n    ux = (u_xp - u_xm) / (2 * dx)\n    return nu * dx * np.sum(ux**2)\n\ndef rhs(u, dx, nu, method, recon):\n    \"\"\"\n    Calculates the right-hand side of the semi-discretized PDE: du/dt = L(u).\n    The operator L(u) is composed of advection and viscous terms.\n    \"\"\"\n    # Periodic shifts for finite differences\n    u_xp = np.roll(u, -1)\n    u_xm = np.roll(u, 1)\n    \n    # Viscous term (common to all methods)\n    # nu * u_xx approx nu * (u_{i+1} - 2u_i + u_{i-1}) / dx^2\n    viscous_term = nu * (u_xp - 2 * u + u_xm) / (dx**2)\n\n    # Advective term\n    if method == 'nonconservative':\n        # -u * u_x approx -u_i * (u_{i+1} - u_{i-1}) / (2*dx)\n        advective_term = u * (u_xp - u_xm) / (2 * dx)\n    elif method == 'conservative':\n        # Split flux functions for Engquist-Osher flux for f(u)=u^2/2\n        def f_plus(val):\n            return 0.5 * np.maximum(val, 0)**2\n\n        def f_minus(val):\n            return 0.5 * np.minimum(val, 0)**2\n\n        if recon == 'const':\n            # Piecewise constant reconstruction\n            u_L = u\n            u_R = u_xp # u_{i+1}\n        elif recon == 'muscl':\n            # MUSCL reconstruction with minmod limiter\n            slope_arg1 = (u - u_xm) / dx\n            slope_arg2 = (u_xp - u) / dx\n            slopes = minmod(slope_arg1, slope_arg2)\n            \n            # Reconstruct interface values from cell i (left) and i+1 (right)\n            u_L = u + slopes * dx / 2.0\n            u_R = u_xp - np.roll(slopes, -1) * dx / 2.0\n        else:\n            raise ValueError(f\"Unknown reconstruction method: {recon}\")\n\n        # Engquist-Osher numerical flux: F_hat(u_L, u_R) = f^+(u_L) + f^-(u_R)\n        flux_hat = f_plus(u_L) + f_minus(u_R)\n        \n        # Finite volume discretization: -(F_{i+1/2} - F_{i-1/2}) / dx\n        flux_hat_m = np.roll(flux_hat, 1)\n        advective_term = (flux_hat - flux_hat_m) / dx\n    else:\n        raise ValueError(f\"Unknown advection method: {method}\")\n\n    return viscous_term - advective_term\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite for the viscous Burgers' equation.\n    \"\"\"\n    test_cases = [\n        # (advection_method, reconstruction, N, nu, T)\n        ('conservative', 'const', 256, 1e-3, 0.4),\n        ('conservative', 'muscl', 256, 1e-3, 0.4),\n        ('nonconservative', None, 256, 1e-3, 0.4),\n        ('nonconservative', None, 64, 1e-3, 0.4),\n        ('conservative', 'const', 128, 1e-1, 0.4),\n    ]\n\n    results = []\n    for advection_method, reconstruction, N, nu, T in test_cases:\n        # 1. Setup grid and initial condition\n        dx = 2 * np.pi / N\n        x = np.linspace(0, 2 * np.pi, N, endpoint=False)\n        u0 = np.sin(x)\n\n        # 2. Initial diagnostics\n        M0 = dx * np.sum(u0) # Should be ~0 due to symmetry\n        E0 = dx * np.sum(0.5 * u0**2)\n\n        # 3. Setup time stepping\n        # The maximum principle for viscous Burgers allows setting dt based on initial data.\n        max_u_abs = np.max(np.abs(u0))\n        if max_u_abs < 1e-12: max_u_abs = 1.0 # Avoid division by zero\n        \n        CFL_const = 0.4\n        dt_adv = CFL_const * dx / max_u_abs\n        dt_visc = CFL_const * (dx**2) / nu\n        dt_max = min(dt_adv, dt_visc)\n        \n        num_steps = int(np.ceil(T / dt_max))\n        dt = T / num_steps\n        \n        # 4. Time integration loop\n        u = u0.copy()\n        D_num = 0.0\n\n        for _ in range(num_steps):\n            # Two-stage SSP Runge-Kutta (SSP-RK2 / Heun's method)\n            L_u = rhs(u, dx, nu, advection_method, reconstruction)\n            u_stage1 = u + dt * L_u\n            \n            # Accumulate numerical entropy production using quadrature consistent with SSP-RK2\n            g_u = spatial_entropy_integrand(u, dx, nu)\n            g_u_stage1 = spatial_entropy_integrand(u_stage1, dx, nu)\n            D_num += 0.5 * dt * (g_u + g_u_stage1)\n            \n            L_u_stage1 = rhs(u_stage1, dx, nu, advection_method, reconstruction)\n            u = 0.5 * u + 0.5 * (u_stage1 + dt * L_u_stage1)\n\n        # 5. Final diagnostics\n        uN = u\n        MN = dx * np.sum(uN)\n        EN = dx * np.sum(0.5 * uN**2)\n\n        mass_error = abs(MN - M0)\n        energy_residual = (E0 - EN) - D_num\n        energy_mono = bool(EN <= E0)\n        \n        results.append([mass_error, energy_residual, energy_mono, D_num])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Beyond conserving simple quantities like mass, a more profound goal is to preserve the energy-flow structure of a complete physical system. This advanced practice introduces the powerful port-Hamiltonian framework, guiding you through the design of a discretization for an Euler-Bernoulli beam that exactly mimics the continuous system's power balance. By implementing a staggered-grid scheme and a compatible time integrator, you will verify that the change in the discrete Hamiltonian (stored energy) perfectly matches the work done at the boundaries (ports), illustrating a systematic approach to building energy-consistent numerical models .",
            "id": "3450190",
            "problem": "Design, analyze, and implement a structure-preserving semi-discretization and time discretization for the one-dimensional Euler–Bernoulli beam in a port-Hamiltonian (pH) formulation, such that the discrete power balance identity holds exactly at the semi-discrete level and matches the midpoint boundary work at the fully discrete level. The goal is to ensure that the discrete Hamiltonian satisfies a balance of the form $\\frac{dH}{dt}=\\text{boundary power}$, with exact exchange at the boundaries via a discrete Dirac structure built from staggered-grid operators satisfying a summation-by-parts identity.\n\nStart from the following fundamental base: the Euler–Bernoulli beam can be written in a pH form using the momentum density $p$ and the curvature $\\kappa$ as state variables, with co-energy variables $v$ (transverse velocity) and $m$ (bending moment) related by $v=\\frac{1}{\\rho A}p$ and $m=EI\\,\\kappa$, where $\\rho A$ is the linear mass density and $EI$ is the bending stiffness. The Hamiltonian is\n$$\nH=\\int_0^L \\frac{1}{2\\rho A}\\,p^2 + \\frac{EI}{2}\\,\\kappa^2 \\, dx,\n$$\nand the pH dynamics (in Stokes–Dirac form) can be written equivalently as the first-order spatial system\n$$\n\\partial_t p = -\\partial_x q,\\quad \\partial_t \\kappa = \\partial_x s,\\quad q=\\partial_x m,\\quad s=\\partial_x v,\n$$\nwhich yields the continuous power balance\n$$\n\\frac{dH}{dt} = \\bigl(m\\,s - v\\,q\\bigr)\\big|_{x=L} - \\bigl(m\\,s - v\\,q\\bigr)\\big|_{x=0}.\n$$\nThe quantity $m\\,s - v\\,q$ is the boundary port power density, with two conjugate pairs at each boundary.\n\nConstruct a one-dimensional staggered-grid semi-discretization that preserves this power identity exactly in space. Use a uniform mesh with $N$ control volumes (cells) of width $h=L/N$, with cell centers at $x_i=(i+\\tfrac{1}{2})h$ for $i=0,\\dots,N-1$ and faces at $x_j=jh$ for $j=0,\\dots,N$. Place the energy variables $p_i$ and $\\kappa_i$ at centers and the flows $s_j$ and $q_j$ at faces. Define the discrete gradient acting from centers to interior faces,\n$$\n(G v)_j=\\frac{v_j - v_{j-1}}{h},\\quad j=1,\\dots,N-1,\n$$\nand the discrete divergence acting from faces to centers,\n$$\n(D f)_i=\\frac{f_{i+1}-f_i}{h},\\quad i=0,\\dots,N-1.\n$$\nYou may regard $G$ as an $(N-1)\\times N$ matrix and $D$ as an $N\\times(N+1)$ matrix. Enforce the kinematic and constitutive laws at the discrete level by $v=\\frac{1}{\\rho A}p$, $m=EI\\,\\kappa$, $s_j=(G v)_j$ for $j=1,\\dots,N-1$, and $q_j=(G m)_j$ for $j=1,\\dots,N-1$, while treating the boundary flows $s_0,s_N,q_0,q_N$ at $j=0$ and $j=N$ as external port variables. The semi-discrete dynamics must be\n$$\n\\dot p = -D q,\\qquad \\dot \\kappa = D s,\n$$\nwith the discrete Hamiltonian\n$$\nH_h = \\frac{h}{2}\\sum_{i=0}^{N-1}\\left(\\frac{1}{\\rho A}p_i^2 + EI\\,\\kappa_i^2\\right).\n$$\nShow, using only discrete summation-by-parts and linearity of $G$ and $D$, that\n$$\n\\frac{dH_h}{dt} = \\bigl(m_{N-1}\\,s_N - v_{N-1}\\,q_N\\bigr) + \\bigl(v_0\\,q_0 - m_0\\,s_0\\bigr),\n$$\nthat is, the semi-discrete energy rate equals the discrete boundary power involving only boundary flows and the adjacent co-energy variables at the nearest cell centers. This is the defining property of a discrete Dirac structure in this setting.\n\nNext, design a time discretization that preserves this power exchange at the time-discrete level for quadratic Hamiltonians. Use the implicit midpoint method applied to the linear time-invariant semi-discrete system with midpoint evaluation of the boundary inputs, i.e., for a time step of size $\\Delta t$, define\n$$\ny^{n+1} = y^n + \\Delta t\\,F\\!\\left(\\tfrac{y^{n+1}+y^n}{2},\\,u^{n+\\frac{1}{2}}\\right),\n$$\nwhere $y=[p;\\kappa]$ collects the center variables, $F$ is the right-hand side induced by $D$ and $G$ with boundary flows included as affine terms, and $u^{n+\\frac{1}{2}}$ denotes the boundary flows evaluated at $t^{n+\\frac{1}{2}}$. For a quadratic Hamiltonian and linear dynamics, this method should preserve the discrete power balance in the sense\n$$\nH_h^{n+1}-H_h^n = \\Delta t\\,P_{\\text{bdry}}^{n+\\frac{1}{2}},\n$$\nwhere $P_{\\text{bdry}}^{n+\\frac{1}{2}}$ is the discrete boundary power computed from midpoint co-energy variables and midpoint boundary flows. Implement this method so that the observable discrepancy\n$$\n\\Delta = H_h(T) - H_h(0) - \\int_0^T P_{\\text{bdry}}(t)\\,dt\n$$\nis numerically negligible, when the integral is approximated consistently by the midpoint rule per time step.\n\nImplementation details and test suite requirements:\n- Use $L=1$ so that $h=1/N$.\n- Use the cell-center initial conditions $p_i(0)=\\sin(\\pi x_i)$ and $\\kappa_i(0)=\\cos(2\\pi x_i)$, with $x_i=(i+\\tfrac{1}{2})h$.\n- Use the following three tests. In all tests, report the single scalar discrepancy\n$$\n\\left|\\;H_h(T) - H_h(0) - \\sum_{n=0}^{M-1} \\Delta t\\;P_{\\text{bdry}}^{n+\\frac{1}{2}}\\;\\right|\n$$\nas a floating-point number, where $M=T/\\Delta t$ is an integer. Express the output values as dimensionless decimals.\n  - Test A (closed boundary, happy path): $N=80$, $\\rho A=1$, $EI=1$, $\\Delta t=10^{-3}$, $T=1$ (so $M=1000$). Boundary flows $s_0(t)=0$, $s_N(t)=0$, $q_0(t)=0$, $q_N(t)=0$.\n  - Test B (one-sided actuation): $N=60$, $\\rho A=2$, $EI=3$, $\\Delta t=5\\times 10^{-4}$, $T=1$ (so $M=2000$). Boundary flows $s_0(t)=\\sin(2\\pi t)$, $s_N(t)=0$, $q_0(t)=0$, $q_N(t)=0.7\\cos(2\\pi t)$.\n  - Test C (all ports excited, edge-case frequencies): $N=40$, $\\rho A=1.5$, $EI=0.8$, $\\Delta t=10^{-3}$, $T=1$ (so $M=1000$). Boundary flows $s_0(t)=\\sin(10 t)$, $s_N(t)=0.3\\cos(6 t)$, $q_0(t)=0.5\\sin(5 t)$, $q_N(t)=0.2\\sin(3 t)$.\n- Your program must assemble the staggered operators $G$ and $D$, construct the linear midpoint step for the state $y=[p;\\kappa]$, evaluate the boundary power at midpoints using the co-energy variables $v=\\frac{1}{\\rho A}p$ and $m=EI\\,\\kappa$ at the adjacent cells, accumulate the midpoint boundary work, and return the final discrepancy for each test.\n- Final output format: Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[resultA,resultB,resultC]\"), in the order Test A, Test B, Test C.\n\nYour solution should justify from first principles why the semi-discrete energy identity holds by a discrete summation-by-parts argument and why the implicit midpoint rule with midpoint boundary evaluation preserves the quadratic power balance at the time-discrete level. Keep all mathematical entities, including numbers, in LaTeX notation. No physical units are required since the outputs are dimensionless discrepancies. The final printed values must be decimals.",
            "solution": "The problem of designing a structure-preserving discretization for the Euler-Bernoulli beam is addressed by first validating the problem statement and then proceeding with a principled derivation and implementation.\n\n### Problem Validation\n\n**Step 1: Extract Givens**\n\n-   **System**: One-dimensional Euler–Bernoulli beam in a port-Hamiltonian (pH) formulation.\n-   **State Variables**: Momentum density $p$, curvature $\\kappa$.\n-   **Co-energy Variables**: Transverse velocity $v$, bending moment $m$.\n-   **Constitutive Relations**: $v=\\frac{1}{\\rho A}p$, $m=EI\\,\\kappa$.\n-   **Parameters**: Linear mass density $\\rho A$, bending stiffness $EI$, length $L=1$.\n-   **Continuous Hamiltonian**: $H=\\int_0^L \\frac{1}{2\\rho A}\\,p^2 + \\frac{EI}{2}\\,\\kappa^2 \\, dx$.\n-   **Continuous Dynamics**: $\\partial_t p = -\\partial_x q$, $\\partial_t \\kappa = \\partial_x s$, with flows $q=\\partial_x m$, $s=\\partial_x v$.\n-   **Continuous Power Balance**: $\\frac{dH}{dt} = \\bigl(m\\,s - v\\,q\\bigr)\\big|_{x=L} - \\bigl(m\\,s - v\\,q\\bigr)\\big|_{x=0}$.\n-   **Discretization**: Uniform staggered grid with $N$ cells of width $h=L/N=1/N$. Cell centers at $x_i=(i+\\tfrac{1}{2})h$ for $i=0,\\dots,N-1$; faces at $x_j=jh$ for $j=0,\\dots,N$.\n-   **Variable Placement**: State variables $p_i, \\kappa_i$ at cell centers; flow variables $s_j, q_j$ at faces.\n-   **Discrete Operators**:\n    -   Gradient (centers to interior faces, $(N-1) \\times N$): $(G v)_j=\\frac{v_j - v_{j-1}}{h}$ for $j=1,\\dots,N-1$.\n    -   Divergence (faces to centers, $N \\times (N+1)$): $(D f)_i=\\frac{f_{i+1}-f_i}{h}$ for $i=0,\\dots,N-1$.\n-   **Discrete Relations**: $v_i=\\frac{1}{\\rho A}p_i$, $m_i=EI\\,\\kappa_i$. Interior flows $s_j=(G v)_j$ and $q_j=(G m)_j$ for $j=1,\\dots,N-1$. Boundary flows $s_0, s_N, q_0, q_N$ are external inputs.\n-   **Semi-discrete Dynamics**: $\\dot p = -D q$, $\\dot \\kappa = D s$.\n-   **Discrete Hamiltonian**: $H_h = \\frac{h}{2}\\sum_{i=0}^{N-1}\\left(\\frac{1}{\\rho A}p_i^2 + EI\\,\\kappa_i^2\\right)$.\n-   **Time Discretization**: Implicit midpoint rule, $y^{n+1} = y^n + \\Delta t\\,F\\!\\left(\\tfrac{y^{n+1}+y^n}{2},\\,u^{n+\\frac{1}{2}}\\right)$.\n-   **Initial Conditions**: $p_i(0)=\\sin(\\pi x_i)$, $\\kappa_i(0)=\\cos(2\\pi x_i)$.\n-   **Task**: 1. Show semi-discrete power balance. 2. Justify fully discrete power balance. 3. Implement and compute the discrepancy $\\left|\\;H_h(T) - H_h(0) - \\sum_{n=0}^{M-1} \\Delta t\\;P_{\\text{bdry}}^{n+\\frac{1}{2}}\\;\\right|$ for three test cases.\n\n**Step 2: Validate Using Extracted Givens**\n\n-   **Scientifically Grounded**: The problem is based on the established port-Hamiltonian framework and structure-preserving discretization techniques (finite differences on staggered grids satisfying summation-by-parts). These are standard and rigorous topics in numerical analysis for partial differential equations. The formulation is scientifically sound.\n-   **Well-Posed**: The problem is clearly defined. The governing equations, discrete operators, initial conditions, boundary conditions (as inputs), and system parameters are all specified. The task is to derive analytical properties and implement a well-defined numerical algorithm. A unique solution to the linear midpoint system exists at each time step.\n-   **Objective**: The problem is expressed entirely in precise mathematical and algorithmic terms. The goal is to compute an objective, verifiable numerical quantity.\n-   **Completeness and Consistency**: The problem is self-contained. All necessary definitions and data for both the analytical derivation and the numerical implementation are provided. There are no contradictions in the provided setup. The definitions of the staggered grid operators and their use in the system dynamics are consistent with the principles of finite volume methods.\n\n**Step 3: Verdict and Action**\n\nThe problem is **valid**. It is a well-posed, scientifically grounded, and complete problem in the field of numerical analysis. We proceed to the solution.\n\n### Analytical Solution\n\n#### Semi-Discrete Power Balance\n\nWe aim to show that the semi-discrete system preserves the power-balanced structure of the continuous pH system. We begin by computing the time derivative of the discrete Hamiltonian, $H_h$.\n\nThe discrete Hamiltonian is given by\n$$\nH_h = \\frac{h}{2}\\sum_{i=0}^{N-1}\\left(\\frac{1}{\\rho A}p_i^2 + EI\\,\\kappa_i^2\\right).\n$$\nApplying the chain rule, its time derivative is\n$$\n\\frac{dH_h}{dt} = \\frac{h}{2}\\sum_{i=0}^{N-1}\\left(\\frac{2}{\\rho A}p_i\\dot{p_i} + 2EI\\,\\kappa_i\\dot{\\kappa_i}\\right) = h\\sum_{i=0}^{N-1}\\left(\\frac{1}{\\rho A}p_i\\dot{p_i} + EI\\,\\kappa_i\\dot{\\kappa_i}\\right).\n$$\nUsing the discrete co-energy relations $v_i = \\frac{1}{\\rho A}p_i$ and $m_i = EI\\,\\kappa_i$, we have\n$$\n\\frac{dH_h}{dt} = h\\sum_{i=0}^{N-1}\\left(v_i\\dot{p_i} + m_i\\dot{\\kappa_i}\\right).\n$$\nWe substitute the semi-discrete dynamics, $\\dot p = -D q$ and $\\dot \\kappa = D s$:\n$$\n\\frac{dH_h}{dt} = h\\sum_{i=0}^{N-1}\\left(v_i(-Dq)_i + m_i(Ds)_i\\right) = -h\\sum_{i=0}^{N-1}v_i(Dq)_i + h\\sum_{i=0}^{N-1}m_i(Ds)_i.\n$$\nThe core of the proof lies in applying a discrete summation-by-parts (SBP) property, which is inherent to the staggered grid operators $G$ and $D$. Let us analyze the first term involving $D q$. Using the definition $(Dq)_i = \\frac{q_{i+1}-q_i}{h}$:\n$$\nh\\sum_{i=0}^{N-1}v_i(Dq)_i = \\sum_{i=0}^{N-1}v_i(q_{i+1} - q_i) = v_0(q_1-q_0) + v_1(q_2-q_1) + \\dots + v_{N-1}(q_N-q_{N-1}).\n$$\nRearranging the terms of the sum by the index of $q$:\n$$\n= -v_0q_0 + (v_0-v_1)q_1 + (v_1-v_2)q_2 + \\dots + (v_{N-2}-v_{N-1})q_{N-1} + v_{N-1}q_N.\n$$\nUsing the definition of the discrete gradient operator, $(Gv)_j = \\frac{v_j-v_{j-1}}{h}$, we can write $v_{j-1}-v_j = -h(Gv)_j$. This allows us to rewrite the sum as:\n$$\n= -v_0q_0 + v_{N-1}q_N + \\sum_{j=1}^{N-1}(v_{j-1}-v_j)q_j = -v_0q_0 + v_{N-1}q_N - h\\sum_{j=1}^{N-1}(Gv)_j q_j.\n$$\nThus, we have the SBP identity for the pair $(D,G)$:\n$$\nh\\sum_{i=0}^{N-1}v_i(Dq)_i = v_{N-1}q_N - v_0q_0 - h\\sum_{j=1}^{N-1}(Gv)_j q_j.\n$$\nBy exact analogy, the SBP identity for the term involving $m_i(Ds)_i$ is:\n$$\nh\\sum_{i=0}^{N-1}m_i(Ds)_i = m_{N-1}s_N - m_0s_0 - h\\sum_{j=1}^{N-1}(Gm)_j s_j.\n$$\nSubstituting these two identities back into the expression for $\\frac{dH_h}{dt}$:\n$$\n\\frac{dH_h}{dt} = -\\left(v_{N-1}q_N - v_0q_0 - h\\sum_{j=1}^{N-1}(Gv)_j q_j\\right) + \\left(m_{N-1}s_N - m_0s_0 - h\\sum_{j=1}^{N-1}(Gm)_j s_j\\right).\n$$\nThe problem specifies that the interior flows are given by $s_j = (Gv)_j$ and $q_j = (Gm)_j$ for $j=1, \\dots, N-1$. Substituting these relations:\n$$\n\\frac{dH_h}{dt} = -v_{N-1}q_N + v_0q_0 + h\\sum_{j=1}^{N-1}s_j q_j + m_{N-1}s_N - m_0s_0 - h\\sum_{j=1}^{N-1}q_j s_j.\n$$\nThe two summation terms are identical and cancel each other out ($h\\sum s_j q_j - h\\sum q_j s_j = 0$). This cancellation represents the internal power conservation, a key feature of the discrete Dirac structure. We are left with only the boundary terms:\n$$\n\\frac{dH_h}{dt} = v_0q_0 - v_{N-1}q_N + m_{N-1}s_N - m_0s_0.\n$$\nRearranging to match the problem statement gives the desired semi-discrete power balance identity:\n$$\n\\frac{dH_h}{dt} = \\bigl(m_{N-1}s_N - v_{N-1}q_N\\bigr) + \\bigl(v_0q_0 - m_0s_0\\bigr) = P_{\\text{bdry}}.\n$$\nThis demonstrates that the rate of change of the discrete Hamiltonian is exactly equal to the power supplied at the boundaries, with no spurious internal energy production or dissipation.\n\n#### Fully-Discrete Power Balance\n\nThe semi-discrete system is a linear time-invariant system of ordinary differential equations of the form $\\dot{y} = Ay + Bu$, where $y=[p;\\kappa]$ is the state vector and $u$ contains the boundary flows. The implicit midpoint rule is applied to this system:\n$$\n\\frac{y^{n+1}-y^n}{\\Delta t} = A\\left(\\frac{y^n+y^{n+1}}{2}\\right) + B u^{n+\\frac{1}{2}}.\n$$\nThe discrete Hamiltonian $H_h$ is a quadratic form in the state variables, $H_h(y) = \\frac{1}{2}y^T Q y$, for a symmetric positive-definite matrix $Q$ ($Q$ is diagonal with entries $\\frac{h}{\\rho A}$ and $hEI$). The semi-discrete system is Hamiltonian, which implies that the matrix $A$ is skew-adjoint with respect to the energy inner product defined by $Q$, i.e., $A^T Q + Q A = 0$.\n\nWe analyze the change in the discrete Hamiltonian over one time step, $H_h(y^{n+1}) - H_h(y^n)$:\n$$\nH_h(y^{n+1}) - H_h(y^n) = \\frac{1}{2}(y^{n+1})^T Q y^{n+1} - \\frac{1}{2}(y^n)^T Q y^n.\n$$\nUsing the algebraic identity $\\frac{1}{2}(a^2-b^2) = \\frac{1}{2}(a-b)(a+b)$, this becomes:\n$$\n= \\frac{1}{2}(y^{n+1}-y^n)^T Q (y^{n+1}+y^n) = (y^{n+1}-y^n)^T Q \\left(\\frac{y^{n+1}+y^n}{2}\\right).\n$$\nLet $y^{n+\\frac{1}{2}} = \\frac{y^n+y^{n+1}}{2}$. From the midpoint rule, $y^{n+1}-y^n = \\Delta t (Ay^{n+\\frac{1}{2}} + Bu^{n+\\frac{1}{2}})$. Substituting this:\n$$\nH_h(y^{n+1}) - H_h(y^n) = \\Delta t (Ay^{n+\\frac{1}{2}} + Bu^{n+\\frac{1}{2}})^T Q y^{n+\\frac{1}{2}} = \\Delta t \\left( (y^{n+\\frac{1}{2}})^T A^T Q y^{n+\\frac{1}{2}} + (u^{n+\\frac{1}{2}})^T B^T Q y^{n+\\frac{1}{2}} \\right).\n$$\nThe term $(y^{n+\\frac{1}{2}})^T A^T Q y^{n+\\frac{1}{2}}$ is a scalar. It is equal to its transpose, $(y^{n+\\frac{1}{2}})^T Q^T A y^{n+\\frac{1}{2}} = (y^{n+\\frac{1}{2}})^T Q A y^{n+\\frac{1}{2}}$ since $Q$ is symmetric. Therefore, we can write:\n$$\n(y^{n+\\frac{1}{2}})^T A^T Q y^{n+\\frac{1}{2}} = \\frac{1}{2}(y^{n+\\frac{1}{2}})^T (A^T Q + QA) y^{n+\\frac{1}{2}}.\n$$\nDue to the skew-adjoint property $A^T Q + QA = 0$, this term is identically zero. This is the key property of energy-preserving schemes for Hamiltonian systems. We are left with the work done by the boundary inputs:\n$$\nH_h(y^{n+1}) - H_h(y^n) = \\Delta t \\, (u^{n+\\frac{1}{2}})^T B^T Q y^{n+\\frac{1}{2}}.\n$$\nThe term $(u^{n+\\frac{1}{2}})^T B^T Q y^{n+\\frac{1}{2}}$ corresponds precisely to the discrete boundary power $P_{\\text{bdry}}$ evaluated with midpoint values for the state and boundary flows. That is, $P_{\\text{bdry}}^{n+\\frac{1}{2}} = P_{\\text{bdry}}(y^{n+\\frac{1}{2}}, u^{n+\\frac{1}{2}})$. Therefore, the fully discrete power balance holds exactly:\n$$\nH_h(y^{n+1}) - H_h(y^n) = \\Delta t P_{\\text{bdry}}^{n+\\frac{1}{2}}.\n$$\nSumming this relation from $n=0$ to $M-1$, we obtain a telescoping sum on the left:\n$$\n\\sum_{n=0}^{M-1} (H_h(y^{n+1}) - H_h(y^n)) = H_h(y^M) - H_h(y^0) = H_h(T) - H_h(0).\n$$\nOn the right, we have the total work done by the boundary ports, approximated by the midpoint rule:\n$$\n\\sum_{n=0}^{M-1} \\Delta t P_{\\text{bdry}}^{n+\\frac{1}{2}} \\approx \\int_0^T P_{\\text{bdry}}(t)\\,dt.\n$$\nEquating the two, we find $H_h(T) - H_h(0) = \\sum_{n=0}^{M-1} \\Delta t P_{\\text{bdry}}^{n+\\frac{1}{2}}$. Consequently, the discrepancy\n$$\n\\Delta = \\left| H_h(T) - H_h(0) - \\sum_{n=0}^{M-1} \\Delta t P_{\\text{bdry}}^{n+\\frac{1}{2}} \\right|\n$$\nmust be zero up to machine precision. The implementation will verify this property numerically.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.sparse import diags, bmat, csc_matrix\nfrom scipy.sparse.linalg import spsolve\n\ndef run_test(N, rhoA, EI, dt, T, s0_func, sN_func, q0_func, qN_func):\n    \"\"\"\n    Runs a single test case for the structure-preserving discretization of the Euler-Bernoulli beam.\n\n    Args:\n        N (int): Number of control volumes.\n        rhoA (float): Linear mass density.\n        EI (float): Bending stiffness.\n        dt (float): Time step size.\n        T (float): Total simulation time.\n        s0_func (callable): Boundary flow s_0(t).\n        sN_func (callable): Boundary flow s_N(t).\n        q0_func (callable): Boundary flow q_0(t).\n        qN_func (callable): Boundary flow q_N(t).\n\n    Returns:\n        float: The absolute numerical discrepancy in the energy balance.\n    \"\"\"\n    # 1. Setup Grid and Parameters\n    L = 1.0\n    h = L / N\n    M = int(round(T / dt))\n\n    # Cell-center coordinates\n    x_centers = (np.arange(N) + 0.5) * h\n\n    # 2. Initial Conditions\n    p_current = np.sin(np.pi * x_centers)\n    kappa_current = np.cos(2 * np.pi * x_centers)\n    \n    # State vector y = [p; kappa]\n    y_current = np.concatenate([p_current, kappa_current])\n\n    def calculate_hamiltonian(p, kappa):\n        energy_p = 0.5 * (1.0 / rhoA) * p**2\n        energy_kappa = 0.5 * EI * kappa**2\n        return h * np.sum(energy_p + energy_kappa)\n\n    H_initial = calculate_hamiltonian(p_current, kappa_current)\n    total_boundary_work = 0.0\n\n    # 3. Assemble System Matrices for Implicit Midpoint Rule\n    # The linear system to be solved at each step is:\n    # [ 2*I    (dt*EI/h^2)*K ] [p_mid] = [RHS_p]\n    # [ -(dt/rhoA/h^2)*K  2*I ] [k_mid] = [RHS_k]\n    # where K is the discrete 2nd derivative operator with Neumann BCs.\n\n    # Construct the NxN matrix K\n    diagonals = [-1 * np.ones(N - 1), 2 * np.ones(N), -1 * np.ones(N - 1)]\n    offsets = [-1, 0, 1]\n    K = diags(diagonals, offsets, shape=(N, N), format='csc')\n    K[0, 0] = 1.0\n    K[0, 1] = -1.0\n    K[N-1, N-2] = -1.0\n    K[N-1, N-1] = 1.0\n\n    # Construct the 2N x 2N LHS matrix for the midpoint solve\n    I_N = csc_matrix(diags([np.ones(N)], [0]))\n    zeros_N = csc_matrix((N, N))\n    \n    A_pk = (dt * EI / h**2) * K\n    A_kp = -(dt / (rhoA * h**2)) * K\n\n    LHS_matrix = bmat([\n        [2 * I_N, A_pk],\n        [A_kp, 2 * I_N]\n    ], format='csc')\n\n    # 4. Time Stepping Loop\n    for n in range(M):\n        t_mid = (n + 0.5) * dt\n\n        # a. Evaluate boundary inputs at midpoint time\n        s0_mid = s0_func(t_mid)\n        sN_mid = sN_func(t_mid)\n        q0_mid = q0_func(t_mid)\n        qN_mid = qN_func(t_mid)\n        \n        # b. Construct RHS vector for the midpoint solve\n        p_n = y_current[:N]\n        kappa_n = y_current[N:]\n        \n        RHS_p = 2 * p_n\n        RHS_p[0] += (dt / h) * q0_mid\n        RHS_p[N - 1] -= (dt / h) * qN_mid\n        \n        RHS_kappa = 2 * kappa_n\n        RHS_kappa[0] -= (dt / h) * s0_mid\n        RHS_kappa[N - 1] += (dt / h) * sN_mid\n        \n        RHS_vector = np.concatenate([RHS_p, RHS_kappa])\n\n        # c. Solve for midpoint state variables y_mid = [p_mid; kappa_mid]\n        y_mid = spsolve(LHS_matrix, RHS_vector)\n        p_mid = y_mid[:N]\n        kappa_mid = y_mid[N:]\n        \n        # d. Calculate co-energy variables at midpoint\n        v_mid = (1.0 / rhoA) * p_mid\n        m_mid = EI * kappa_mid\n        \n        # e. Calculate boundary power at midpoint\n        power_boundary_mid = (m_mid[N-1] * sN_mid - v_mid[N-1] * qN_mid) + \\\n                             (v_mid[0] * q0_mid - m_mid[0] * s0_mid)\n\n        # f. Accumulate boundary work\n        total_boundary_work += dt * power_boundary_mid\n\n        # g. Update state to the next time step y_next = 2*y_mid - y_current\n        y_next = 2 * y_mid - y_current\n        y_current = y_next\n\n    # 5. Final Calculation\n    p_final = y_current[:N]\n    kappa_final = y_current[N:]\n    H_final = calculate_hamiltonian(p_final, kappa_final)\n\n    discrepancy = np.abs(H_final - H_initial - total_boundary_work)\n    \n    return discrepancy\n\ndef solve():\n    \"\"\"\n    Defines and runs the test cases specified in the problem statement.\n    \"\"\"\n    # Test cases: (N, rhoA, EI, dt, T, s0, sN, q0, qN)\n    test_cases = [\n        # Test A: Closed boundary\n        (80, 1.0, 1.0, 1e-3, 1.0,\n         lambda t: 0.0, lambda t: 0.0, lambda t: 0.0, lambda t: 0.0),\n        \n        # Test B: One-sided actuation\n        (60, 2.0, 3.0, 5e-4, 1.0,\n         lambda t: np.sin(2 * np.pi * t), lambda t: 0.0,\n         lambda t: 0.0, lambda t: 0.7 * np.cos(2 * np.pi * t)),\n\n        # Test C: All ports excited\n        (40, 1.5, 0.8, 1e-3, 1.0,\n         lambda t: np.sin(10 * t), lambda t: 0.3 * np.cos(6 * t),\n         lambda t: 0.5 * np.sin(5 * t), lambda t: 0.2 * np.sin(3 * t))\n    ]\n\n    results = []\n    for case in test_cases:\n        N, rhoA, EI, dt, T, s0, sN, q0, qN = case\n        discrepancy = run_test(N, rhoA, EI, dt, T, s0, sN, q0, qN)\n        results.append(discrepancy)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.15e}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}