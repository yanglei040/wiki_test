{
    "hands_on_practices": [
        {
            "introduction": "The journey from the continuous weak formulation of the Stokes equations to a solvable computer model begins with discretization. This foundational exercise guides you through the essential process of translating the abstract variational problem into a concrete block matrix system. By working with the stable Taylor-Hood element pair, you will derive the explicit integral expressions for the matrix and vector entries that form the heart of a finite element solver, connecting the continuous physics to discrete linear algebra.",
            "id": "3395355",
            "problem": "Consider a stationary, incompressible, Newtonian fluid in a polygonal domain $\\Omega \\subset \\mathbb{R}^{2}$ with homogeneous Dirichlet velocity boundary conditions. The governing Partial Differential Equation (PDE) is the Stokes system, which follows from the conservation of linear momentum and mass: find velocity $\\mathbf{u}$ and pressure $p$ such that $-\\nabla \\cdot (2\\mu\\,\\varepsilon(\\mathbf{u})) + \\nabla p = \\mathbf{f}$ in $\\Omega$, $\\nabla \\cdot \\mathbf{u} = 0$ in $\\Omega$, and $\\mathbf{u} = \\mathbf{0}$ on $\\partial \\Omega$, together with the pressure normalization $\\int_{\\Omega} p \\,\\mathrm{d}x = 0$. Here, $\\mu \\in L^{\\infty}(\\Omega)$ is a dynamic viscosity that is piecewise constant with respect to a conforming triangulation $\\mathcal{T}_h$ of $\\Omega$, $\\mathbf{f} \\in [L^{2}(\\Omega)]^{2}$ is a given body force, and $\\varepsilon(\\mathbf{w}) := \\frac{1}{2}\\left(\\nabla \\mathbf{w} + \\nabla \\mathbf{w}^{\\top}\\right)$ denotes the symmetric gradient. Let the test spaces be $[H_{0}^{1}(\\Omega)]^{2}$ for velocity and $L_{0}^{2}(\\Omega)$ for pressure. The Frobenius inner product of matrices is defined by $A:B := \\mathrm{trace}(A^{\\top}B)$.\n\nLet $\\mathcal{T}_h$ be a conforming triangulation of $\\Omega$ into triangles, and consider the Taylor–Hood finite element pair: define the discrete velocity space $V_h := \\{\\mathbf{v}_h \\in [H_{0}^{1}(\\Omega)]^{2} : \\mathbf{v}_h|_{K} \\in [\\mathcal{P}_{2}(K)]^{2} \\ \\forall K \\in \\mathcal{T}_h\\}$ and the discrete pressure space $Q_h := \\{q_h \\in L_{0}^{2}(\\Omega) : q_h|_{K} \\in \\mathcal{P}_{1}(K) \\ \\forall K \\in \\mathcal{T}_h\\}$, where $\\mathcal{P}_{m}(K)$ denotes polynomials of total degree at most $m$ on element $K$. Let $\\{\\boldsymbol{\\varphi}_{i}\\}_{i=1}^{N_u}$ be a basis of $V_h$ and $\\{\\psi_{k}\\}_{k=1}^{N_p}$ be a basis of $Q_h$. The Galerkin method seeks $\\mathbf{u}_h \\in V_h$ and $p_h \\in Q_h$ with coefficient vectors $U \\in \\mathbb{R}^{N_u}$ and $P \\in \\mathbb{R}^{N_p}$ such that the block matrix system $\\begin{pmatrix}A & B^{\\top} \\\\ B & 0\\end{pmatrix}\\begin{pmatrix}U \\\\ P\\end{pmatrix} = \\begin{pmatrix}F \\\\ 0\\end{pmatrix}$ holds, where $A \\in \\mathbb{R}^{N_u \\times N_u}$, $B \\in \\mathbb{R}^{N_p \\times N_u}$, and $F \\in \\mathbb{R}^{N_u}$.\n\nStarting from the fundamental balance laws stated above, derive the weak formulation and use it to assemble this discrete block system. Express the entries $A_{ij}$, $B_{kj}$, and $F_{i}$ explicitly as sums of integrals over elements $K \\in \\mathcal{T}_h$, incorporating the piecewise constant viscosity on each element, denoted $\\mu_{K}$. Your final result must be a single closed-form analytical expression that presents, side-by-side, the three entry formulas $A_{ij}$, $B_{kj}$, and $F_{i}$ as element-integral sums. No numerical evaluation is required.",
            "solution": "The problem is subjected to validation against the established criteria.\n\n### Step 1: Extract Givens\n- **Governing Equations:**\n  - Momentum conservation: $-\\nabla \\cdot (2\\mu\\,\\varepsilon(\\mathbf{u})) + \\nabla p = \\mathbf{f}$ in $\\Omega$\n  - Mass conservation (incompressibility): $\\nabla \\cdot \\mathbf{u} = 0$ in $\\Omega$\n- **Domain and Boundary Conditions:** $\\Omega \\subset \\mathbb{R}^{2}$ is a polygonal domain; $\\mathbf{u} = \\mathbf{0}$ on $\\partial \\Omega$.\n- **Constitutive Relations and Definitions:**\n  - Fluid: Stationary, incompressible, Newtonian.\n  - Symmetric gradient: $\\varepsilon(\\mathbf{w}) := \\frac{1}{2}\\left(\\nabla \\mathbf{w} + \\nabla \\mathbf{w}^{\\top}\\right)$.\n  - Dynamic viscosity: $\\mu \\in L^{\\infty}(\\Omega)$, piecewise constant $\\mu_K$ on each element $K$ of a triangulation $\\mathcal{T}_h$.\n  - Body force: $\\mathbf{f} \\in [L^{2}(\\Omega)]^{2}$.\n  - Frobenius inner product: $A:B := \\mathrm{trace}(A^{\\top}B)$.\n- **Function Spaces:**\n  - Velocity test space: $[H_{0}^{1}(\\Omega)]^{2}$.\n  - Pressure test space and normalization: $L_{0}^{2}(\\Omega) = \\{ q \\in L^2(\\Omega) : \\int_{\\Omega} q \\,\\mathrm{d}x = 0 \\}$.\n- **Finite Element Discretization (Taylor–Hood):**\n  - Conforming triangulation $\\mathcal{T}_h$ of $\\Omega$.\n  - Discrete velocity space: $V_h := \\{\\mathbf{v}_h \\in [H_{0}^{1}(\\Omega)]^{2} : \\mathbf{v}_h|_{K} \\in [\\mathcal{P}_{2}(K)]^{2} \\ \\forall K \\in \\mathcal{T}_h\\}$.\n  - Discrete pressure space: $Q_h := \\{q_h \\in L_{0}^{2}(\\Omega) : q_h|_{K} \\in \\mathcal{P}_{1}(K) \\ \\forall K \\in \\mathcal{T}_h\\}$.\n- **Galerkin Method:**\n  - Velocity basis: $\\{\\boldsymbol{\\varphi}_{i}\\}_{i=1}^{N_u}$ for $V_h$.\n  - Pressure basis: $\\{\\psi_{k}\\}_{k=1}^{N_p}$ for $Q_h$.\n  - Unknowns: $\\mathbf{u}_h \\in V_h$ and $p_h \\in Q_h$, with coefficient vectors $U \\in \\mathbb{R}^{N_u}$ and $P \\in \\mathbb{R}^{N_p}$.\n  - Target discrete system: $\\begin{pmatrix}A & B^{\\top} \\\\ B & 0\\end{pmatrix}\\begin{pmatrix}U \\\\ P\\end{pmatrix} = \\begin{pmatrix}F \\\\ 0\\end{pmatrix}$.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is scientifically grounded, well-posed, and objective. The Stokes equations represent a fundamental model in fluid dynamics. The specified weak formulation and Taylor-Hood finite element method are standard, mathematically rigorous techniques for its numerical solution. The LBB stability condition for this element pair guarantees a well-posed discrete problem. All terms and conditions are precisely defined and self-contained. There are no contradictions, though careful derivation is required to reconcile the given strong form with the specified symmetric block matrix structure. The problem does not violate any of the invalidity criteria.\n\n### Step 3: Verdict and Action\nThe problem is valid. A complete solution will be provided.\n\n### Derivation of the Discrete System\n\nThe derivation begins by establishing the weak formulation of the Stokes problem.\n\n**1. Weak Formulation**\nLet $\\mathbf{v} \\in [H_{0}^{1}(\\Omega)]^{2}$ be a test function for the velocity and $q \\in L_{0}^{2}(\\Omega)$ be a test function for the pressure.\n\nWe multiply the momentum equation by $\\mathbf{v}$ and integrate over the domain $\\Omega$:\n$$\n\\int_{\\Omega} \\left( -\\nabla \\cdot (2\\mu\\,\\varepsilon(\\mathbf{u})) \\right) \\cdot \\mathbf{v} \\, \\mathrm{d}x + \\int_{\\Omega} (\\nabla p) \\cdot \\mathbf{v} \\, \\mathrm{d}x = \\int_{\\Omega} \\mathbf{f} \\cdot \\mathbf{v} \\, \\mathrm{d}x\n$$\nApplying integration by parts (Green's first identity for vector/tensor fields) to the first two terms:\nThe viscous term becomes:\n$$\n\\int_{\\Omega} \\left( -\\nabla \\cdot (2\\mu\\,\\varepsilon(\\mathbf{u})) \\right) \\cdot \\mathbf{v} \\, \\mathrm{d}x = \\int_{\\Omega} 2\\mu\\,\\varepsilon(\\mathbf{u}) : \\nabla \\mathbf{v} \\, \\mathrm{d}x - \\int_{\\partial \\Omega} (2\\mu\\,\\varepsilon(\\mathbf{u})\\mathbf{n}) \\cdot \\mathbf{v} \\, \\mathrm{d}s\n$$\nThe boundary integral vanishes because $\\mathbf{v} \\in [H_{0}^{1}(\\Omega)]^{2}$, which implies $\\mathbf{v} = \\mathbf{0}$ on $\\partial\\Omega$. The term $\\varepsilon(\\mathbf{u}) : \\nabla \\mathbf{v}$ can be simplified. Since $\\varepsilon(\\mathbf{u})$ is a symmetric tensor, its Frobenius inner product with any tensor $\\nabla\\mathbf{v}$ is equal to its inner product with the symmetric part of that tensor, $\\varepsilon(\\mathbf{v})$. Thus, $2\\mu\\,\\varepsilon(\\mathbf{u}) : \\nabla \\mathbf{v} = 2\\mu\\,\\varepsilon(\\mathbf{u}) : \\varepsilon(\\mathbf{v})$.\n\nThe pressure term becomes:\n$$\n\\int_{\\Omega} (\\nabla p) \\cdot \\mathbf{v} \\, \\mathrm{d}x = - \\int_{\\Omega} p (\\nabla \\cdot \\mathbf{v}) \\, \\mathrm{d}x + \\int_{\\partial \\Omega} p (\\mathbf{v} \\cdot \\mathbf{n}) \\, \\mathrm{d}s\n$$\nThe boundary integral vanishes for the same reason.\n\nSubstituting these back yields the first variational equation:\n$$\n\\int_{\\Omega} 2\\mu\\,\\varepsilon(\\mathbf{u}) : \\varepsilon(\\mathbf{v}) \\, \\mathrm{d}x - \\int_{\\Omega} p (\\nabla \\cdot \\mathbf{v}) \\, \\mathrm{d}x = \\int_{\\Omega} \\mathbf{f} \\cdot \\mathbf{v} \\, \\mathrm{d}x\n$$\nNext, we multiply the incompressibility constraint by the pressure test function $q$ and integrate over $\\Omega$:\n$$\n\\int_{\\Omega} q (\\nabla \\cdot \\mathbf{u}) \\, \\mathrm{d}x = 0\n$$\nThe weak formulation is to find $(\\mathbf{u},p) \\in [H_0^1(\\Omega)]^2 \\times L_0^2(\\Omega)$ satisfying these two equations for all $(\\mathbf{v},q) \\in [H_0^1(\\Omega)]^2 \\times L_0^2(\\Omega)$.\n\n**2. Galerkin Discretization**\nWe seek a solution $(\\mathbf{u}_h, p_h)$ in the finite-dimensional subspaces $V_h \\times Q_h$. We expand the unknown functions in terms of the basis functions:\n$$\n\\mathbf{u}_h = \\sum_{j=1}^{N_u} U_j \\boldsymbol{\\varphi}_j \\quad \\text{and} \\quad p_h = \\sum_{l=1}^{N_p} P_l \\psi_l\n$$\nThe Galerkin method requires the weak formulation to hold for all test functions in the discrete spaces. We test against the basis functions $\\mathbf{v} = \\boldsymbol{\\varphi}_i$ for $i=1, \\dots, N_u$ and $q=\\psi_k$ for $k=1, \\dots, N_p$.\n\nSubstituting the expansions into the first variational equation with $\\mathbf{v} = \\boldsymbol{\\varphi}_i$:\n$$\n\\int_{\\Omega} 2\\mu\\,\\varepsilon\\left(\\sum_{j=1}^{N_u} U_j \\boldsymbol{\\varphi}_j\\right) : \\varepsilon(\\boldsymbol{\\varphi}_i) \\, \\mathrm{d}x - \\int_{\\Omega} \\left(\\sum_{l=1}^{N_p} P_l \\psi_l\\right) (\\nabla \\cdot \\boldsymbol{\\varphi}_i) \\, \\mathrm{d}x = \\int_{\\Omega} \\mathbf{f} \\cdot \\boldsymbol{\\varphi}_i \\, \\mathrm{d}x\n$$\nBy linearity of the integral and the gradient operator, this becomes the $i$-th row of the linear system:\n$$\n\\sum_{j=1}^{N_u} \\left( \\int_{\\Omega} 2\\mu\\,\\varepsilon(\\boldsymbol{\\varphi}_j) : \\varepsilon(\\boldsymbol{\\varphi}_i) \\, \\mathrm{d}x \\right) U_j - \\sum_{l=1}^{N_p} \\left( \\int_{\\Omega} \\psi_l (\\nabla \\cdot \\boldsymbol{\\varphi}_i) \\, \\mathrm{d}x \\right) P_l = \\int_{\\Omega} \\mathbf{f} \\cdot \\boldsymbol{\\varphi}_i \\, \\mathrm{d}x\n$$\nSubstituting into the second variational equation with $q = \\psi_k$:\n$$\n\\int_{\\Omega} \\psi_k \\left( \\nabla \\cdot \\sum_{j=1}^{N_u} U_j \\boldsymbol{\\varphi}_j \\right) \\, \\mathrm{d}x = 0\n$$\nThis yields the $k$-th row of the second block of equations:\n$$\n\\sum_{j=1}^{N_u} \\left( \\int_{\\Omega} \\psi_k (\\nabla \\cdot \\boldsymbol{\\varphi}_j) \\, \\mathrm{d}x \\right) U_j = 0\n$$\n\n**3. Assembling the Block Matrix System**\nThe problem specifies the block matrix system as $AU + B^T P = F$ and $BU = 0$.\nThe derived discrete momentum equation is:\n$$\n\\sum_{j=1}^{N_u} A_{ij} U_j + \\sum_{l=1}^{N_p} (B^T)_{il} P_l = F_i\n$$\nThe derived discrete continuity equation is:\n$$\n\\sum_{j=1}^{N_u} B_{kj} U_j = 0\n$$\nComparing the terms, we first identify the matrix $A$ and vector $F$:\n$$\nA_{ij} = \\int_{\\Omega} 2\\mu\\,\\varepsilon(\\boldsymbol{\\varphi}_j) : \\varepsilon(\\boldsymbol{\\varphi}_i) \\, \\mathrm{d}x\n$$\n$$\nF_i = \\int_{\\Omega} \\mathbf{f} \\cdot \\boldsymbol{\\varphi}_i \\, \\mathrm{d}x\n$$\nNow we must consistently define the matrix $B$ for both block equations. From the continuity equation, one might define $B_{kj} = \\int_{\\Omega} \\psi_k (\\nabla \\cdot \\boldsymbol{\\varphi}_j) \\, \\mathrm{d}x$. However, substituting this into the momentum equation yields the term $-\\sum_l B_{li} P_l = -\\sum_l (B^T)_{il} P_l$. This would give the system $AU - B^T P = F$, which contradicts the problem statement.\n\nTo match the specified block system $AU + B^T P = F$, we must define the matrix $B$ such that the pressure term in the momentum equation, $-\\sum_{l} P_l \\int_{\\Omega} \\psi_l (\\nabla \\cdot \\boldsymbol{\\varphi}_i) \\, \\mathrm{d}x$, matches $\\sum_{l} (B^T)_{il} P_l$.\nThis requires $(B^T)_{il} = -\\int_{\\Omega} \\psi_l (\\nabla \\cdot \\boldsymbol{\\varphi}_i) \\, \\mathrm{d}x$.\nBy definition of the transpose, $B_{li} = (B^T)_{il}$, so $B_{li} = -\\int_{\\Omega} \\psi_l (\\nabla \\cdot \\boldsymbol{\\varphi}_i) \\, \\mathrm{d}x$.\nRelabeling the indices ($l \\to k$, $i \\to j$) gives the definition for the entries of matrix $B$:\n$$\nB_{kj} = - \\int_{\\Omega} \\psi_k (\\nabla \\cdot \\boldsymbol{\\varphi}_j) \\, \\mathrm{d}x\n$$\nLet us verify this definition with the second block row, $BU=0$. Our derived equation is $\\sum_j (\\int_{\\Omega} \\psi_k (\\nabla \\cdot \\boldsymbol{\\varphi}_j) \\, \\mathrm{d}x) U_j = 0$. Using our definition of $B_{kj}$, we get $\\sum_j (-B_{kj}) U_j = 0$, which is equivalent to $\\sum_j B_{kj} U_j = 0$. This is consistent.\n\n**4. Final Expressions for Matrix and Vector Entries**\nThe final step is to write the integrals as a sum over the elements $K$ of the triangulation $\\mathcal{T}_h$ and incorporate the piecewise constant viscosity $\\mu_K$.\n\nThe entries of the stiffness matrix $A$ are:\n$$\nA_{ij} = \\int_{\\Omega} 2\\mu\\,\\varepsilon(\\boldsymbol{\\varphi}_j) : \\varepsilon(\\boldsymbol{\\varphi}_i) \\, \\mathrm{d}x = \\sum_{K\\in\\mathcal{T}_h} \\int_K 2\\mu_K\\,\\varepsilon(\\boldsymbol{\\varphi}_j) : \\varepsilon(\\boldsymbol{\\varphi}_i) \\, \\mathrm{d}x\n$$\nThe entries of the divergence matrix $B$ are:\n$$\nB_{kj} = -\\int_{\\Omega} \\psi_k (\\nabla \\cdot \\boldsymbol{\\varphi}_j) \\, \\mathrm{d}x = -\\sum_{K\\in\\mathcal{T}_h} \\int_K \\psi_k (\\nabla \\cdot \\boldsymbol{\\varphi}_j) \\, \\mathrm{d}x\n$$\nThe entries of the load vector $F$ are:\n$$\nF_i = \\int_{\\Omega} \\mathbf{f} \\cdot \\boldsymbol{\\varphi}_i \\, \\mathrm{d}x = \\sum_{K\\in\\mathcal{T}_h} \\int_K \\mathbf{f} \\cdot \\boldsymbol{\\varphi}_i \\, \\mathrm{d}x\n$$\nThese three expressions constitute the final answer.",
            "answer": "$$\n\\boxed{\n\\begin{aligned}\nA_{ij} &= \\sum_{K \\in \\mathcal{T}_h} \\int_{K} 2\\mu_K\\,\\varepsilon(\\boldsymbol{\\varphi}_{j}) : \\varepsilon(\\boldsymbol{\\varphi}_{i}) \\, \\mathrm{d}x \\\\\nB_{kj} &= -\\sum_{K \\in \\mathcal{T}_h} \\int_{K} \\psi_k (\\nabla \\cdot \\boldsymbol{\\varphi}_{j}) \\, \\mathrm{d}x \\\\\nF_{i} &= \\sum_{K \\in \\mathcal{T}_h} \\int_{K} \\mathbf{f} \\cdot \\boldsymbol{\\varphi}_{i} \\, \\mathrm{d}x\n\\end{aligned}\n}\n$$"
        },
        {
            "introduction": "A successful finite element discretization for the Stokes problem requires a careful choice of velocity and pressure spaces to ensure stability. This exercise provides a classic, analytical demonstration of what happens when this stability condition is violated, using the equal-order bilinear element pair. You will discover how a non-physical, oscillatory 'checkerboard' pressure mode can exist undetected by the discrete system, leading to a polluted solution, and then quantify a stabilization term designed to suppress such artifacts.",
            "id": "3395358",
            "problem": "Consider the steady Stokes equations on the unit square domain $\\Omega = (0,1)^{2}$ with homogeneous Dirichlet boundary conditions on velocity,\n$$\n-\\nu \\Delta \\mathbf{u} + \\nabla p = \\mathbf{f} \\quad \\text{in } \\Omega, \n\\qquad \n\\nabla \\cdot \\mathbf{u} = 0 \\quad \\text{in } \\Omega,\n\\qquad \n\\mathbf{u} = \\mathbf{0} \\quad \\text{on } \\partial \\Omega,\n$$\nwhere $\\nu > 0$ is the kinematic viscosity, $\\mathbf{u}$ is the velocity, $p$ is the pressure, and $\\mathbf{f}$ is a given body force. The weak formulation seeks $(\\mathbf{u},p)$ such that\n$$\na(\\mathbf{u},\\mathbf{v}) + b(\\mathbf{v},p) + b(\\mathbf{u},q) = \\ell(\\mathbf{v}) \\quad \\text{for all } (\\mathbf{v},q),\n$$\nwith $a(\\mathbf{u},\\mathbf{v}) = \\nu \\int_{\\Omega} \\nabla \\mathbf{u} : \\nabla \\mathbf{v} \\, dx$, $b(\\mathbf{v},p) = - \\int_{\\Omega} p \\, \\nabla \\cdot \\mathbf{v} \\, dx$, and $\\ell(\\mathbf{v}) = \\int_{\\Omega} \\mathbf{f} \\cdot \\mathbf{v} \\, dx$.\n\nDiscretize $\\Omega$ by a uniform tensor-product mesh of $2 \\times 2$ congruent squares of side length $h = 1/2$, and let the discrete spaces be equal-order, continuous bilinear finite elements for each velocity component and for the pressure. Approximate only the divergence–pressure coupling by reduced integration using a single Gauss point per element (the geometric center) with weight equal to the element area; that is, take\n$$\nb_{h}(\\mathbf{v}_{h},p_{h}) = - \\sum_{K} |K| \\, p_{h}(\\mathbf{x}_{K}) \\, \\nabla \\cdot \\mathbf{v}_{h}(\\mathbf{x}_{K}),\n$$\nwhere $\\mathbf{x}_{K}$ is the center of element $K$ and $|K| = h^{2}$.\n\nDefine the nodal pressure field $p_{h}$ at the $3 \\times 3$ grid nodes $(i/2,j/2)$ for $i,j \\in \\{0,1,2\\}$ by\n$$\np_{h}\\!\\left(\\frac{i}{2},\\frac{j}{2}\\right) = (-1)^{i+j},\n$$\nand let $p_{h}$ on each element be the bilinear interpolant of its four nodal values. This pressure is continuous and oscillatory in a checkerboard pattern. \n\nTasks:\n- Using only the finite element interpolation and the stated one-point quadrature, demonstrate from first principles whether $b_{h}(\\mathbf{v}_{h},p_{h})$ vanishes for all discrete velocity fields $\\mathbf{v}_{h}$. Your argument must not assume any pre-known stability results; it must proceed from the definition of $b_{h}$ and the elementwise bilinear interpolation property.\n- Propose a consistent stabilization that penalizes pressure oscillations without altering the continuous Stokes solution. For the purpose of quantification, consider the Brezzi–Pitkäranta (BP) pressure-gradient stabilization\n$$\ns(p_{h},q_{h}) = \\gamma \\sum_{K} h^{2} \\int_{K} \\nabla p_{h} \\cdot \\nabla q_{h} \\, dx,\n$$\nwith a constant parameter $\\gamma > 0$. Compute, in closed form, the exact value of $\\gamma$ such that the stabilization seminorm of the checkerboard mode satisfies\n$$\ns(p_{h},p_{h}) = 1.\n$$\n\nReport the final $\\gamma$ as a single exact number. No rounding is required, and no units are involved.",
            "solution": "The problem presents two tasks concerning the finite element discretization of the steady Stokes equations using equal-order bilinear elements for velocity and pressure ($Q_1-Q_1$), which is known to be unstable.\n\nFirst, we must demonstrate from first principles whether the one-point quadrature divergence-pressure coupling term, $b_h(\\mathbf{v}_h, p_h)$, vanishes for a specific oscillatory pressure mode, known as a checkerboard mode.\nSecond, we must calculate the parameter $\\gamma$ for a given Brezzi-Pitkäranta pressure stabilization term such that the stabilization seminorm of this checkerboard mode is normalized to $1$.\n\n**Part 1: Analysis of the discrete coupling term $b_h(\\mathbf{v}_h, p_h)$**\n\nThe discrete coupling term with one-point quadrature is given by:\n$$\nb_{h}(\\mathbf{v}_{h},p_{h}) = - \\sum_{K} |K| \\, p_{h}(\\mathbf{x}_{K}) \\, \\nabla \\cdot \\mathbf{v}_{h}(\\mathbf{x}_{K})\n$$\nwhere the sum is over the $4$ elements $K$ of the mesh, $|K|$ is the area of an element, and $\\mathbf{x}_K$ is the geometric center of element $K$. The term $b_h(\\mathbf{v}_h, p_h)$ will vanish for any discrete velocity field $\\mathbf{v}_h$ if and only if $p_h(\\mathbf{x}_K) = 0$ for all elements $K$ in the mesh. We will demonstrate that this is the case for the specified pressure field $p_h$.\n\nThe domain $\\Omega = (0,1)^2$ is discretized into a $2 \\times 2$ uniform mesh of $4$ square elements, each with side length $h=1/2$ and area $|K|=h^2=1/4$. The nodes of the mesh are at coordinates $(i/2, j/2)$ for $i,j \\in \\{0,1,2\\}$.\n\nThe pressure field $p_h$ is a continuous, piecewise bilinear function. Its nodal values are defined by $p_h(i/2, j/2) = (-1)^{i+j}$.\nLet's consider a generic element $K$ whose vertices correspond to the grid indices $(i,j)$, $(i+1,j)$, $(i,j+1)$, and $(i+1,j+1)$. The nodal values of $p_h$ at these vertices are:\n\\begin{itemize}\n    \\item $p_{i,j} = (-1)^{i+j}$\n    \\item $p_{i+1,j} = (-1)^{i+1+j} = -(-1)^{i+j} = -p_{i,j}$\n    \\item $p_{i,j+1} = (-1)^{i+j+1} = -(-1)^{i+j} = -p_{i,j}$\n    \\item $p_{i+1,j+1} = (-1)^{i+1+j+1} = (-1)^{i+j+2} = (-1)^{i+j} = p_{i,j}$\n\\end{itemize}\nThe set of nodal values for any element is thus of the form $\\{P, -P, -P, P\\}$ for $P \\in \\{1, -1\\}$.\n\nA property of bilinear interpolation on a rectangular element is that the value of the interpolant at the element's geometric center is the arithmetic mean of the values at its four vertices. Let $\\mathbf{x}_K$ be the center of element $K$. Then,\n$$\np_{h}(\\mathbf{x}_{K}) = \\frac{1}{4} \\left( p_{i,j} + p_{i+1,j} + p_{i,j+1} + p_{i+1,j+1} \\right)\n$$\nSubstituting the nodal values for the checkerboard mode:\n$$\np_{h}(\\mathbf{x}_{K}) = \\frac{1}{4} \\left( p_{i,j} + (-p_{i,j}) + (-p_{i,j}) + p_{i,j} \\right) = \\frac{1}{4} (0) = 0\n$$\nThis result holds for any element $K$ in the mesh, regardless of the specific indices $i, j \\in \\{0, 1\\}$. Since $p_h(\\mathbf{x}_K)=0$ for every element $K$, the sum defining $b_h$ becomes:\n$$\nb_{h}(\\mathbf{v}_{h},p_{h}) = - \\sum_{K} |K| \\cdot (0) \\cdot \\nabla \\cdot \\mathbf{v}_{h}(\\mathbf{x}_{K}) = 0\n$$\nThis holds for any arbitrary discrete velocity field $\\mathbf{v}_h$. Thus, we have demonstrated from first principles that the given checkerboard pressure mode $p_h$ lies in the kernel of the discrete divergence operator's transpose, making it a spurious pressure mode.\n\n**Part 2: Calculation of the Stabilization Parameter $\\gamma$**\n\nThe problem proposes the Brezzi-Pitkäranta pressure-gradient stabilization, a method known to be consistent because the stabilization term $s(p_h,q_h)$ is of order $h^2$ and vanishes as $h \\to 0$. The stabilization term is:\n$$\ns(p_{h},q_{h}) = \\gamma \\sum_{K} h^{2} \\int_{K} \\nabla p_{h} \\cdot \\nabla q_{h} \\, dx\n$$\nWe need to find the value of the constant $\\gamma > 0$ such that the stabilization seminorm of the given checkerboard mode $p_h$ equals $1$:\n$$\ns(p_{h},p_{h}) = \\gamma \\sum_{K} h^{2} \\int_{K} |\\nabla p_{h}|^2 \\, dx = 1\n$$\nThe sum is over the $4$ elements of the mesh. Let's compute the integral $\\int_K |\\nabla p_h|^2 \\, dx$ for a single element $K$. We can perform this calculation on a reference square element $\\hat{K} = [-1,1]^2$ with coordinates $(\\xi, \\eta)$.\n\nA physical element $K$ with side length $h=1/2$ is mapped from $\\hat{K}$ via the affine transformation $x(\\xi,\\eta) = x_c + \\frac{h}{2}\\xi$ and $y(\\xi,\\eta) = y_c + \\frac{h}{2}\\eta$, where $(x_c, y_c)$ is the center of $K$. The gradient operator transforms as $\\nabla_{\\mathbf{x}} = \\frac{2}{h}\\nabla_{(\\xi,\\eta)}$. The differential area element is $dx \\, dy = \\det(J) \\, d\\xi \\, d\\eta = \\frac{h^2}{4} \\, d\\xi \\, d\\eta$.\nThe integral transforms as follows:\n$$\n\\int_{K} |\\nabla p_{h}|^2 \\, dx \\, dy = \\int_{\\hat{K}} \\left| \\frac{2}{h} \\hat{\\nabla} \\hat{p}_h \\right|^2 \\frac{h^2}{4} \\, d\\xi \\, d\\eta = \\int_{\\hat{K}} \\frac{4}{h^2} |\\hat{\\nabla} \\hat{p}_h|^2 \\frac{h^2}{4} \\, d\\xi \\, d\\eta = \\int_{\\hat{K}} |\\hat{\\nabla} \\hat{p}_h|^2 \\, d\\xi \\, d\\eta\n$$\nwhere $\\hat{p}_h(\\xi, \\eta)$ is the pressure field on the reference element.\n\nFor any element, the nodal values of the checkerboard mode are $\\{P, -P, -P, P\\}$, where $P = \\pm 1$. Let's map these to the vertices of $\\hat{K}$ at $(\\xi,\\eta) = (-1,-1), (1,-1), (-1,1), (1,1)$. Let the values be $p_1, p_2, p_3, p_4$ respectively. For instance, for element $K_1 = [0,1/2]\\times[0,1/2]$, the nodal values are $p(0,0)=1$, $p(1/2,0)=-1$, $p(0,1/2)=-1$, $p(1/2,1/2)=1$. The mapping gives $\\{p_1, p_2, p_3, p_4\\} = \\{1, -1, -1, 1\\}$. The bilinear interpolant on $\\hat{K}$ is $\\hat{p}_h(\\xi, \\eta) = \\sum_{i=1}^4 p_i N_i(\\xi, \\eta)$, where $N_i$ are the standard bilinear basis functions. For this pattern of nodal values, this simplifies to $\\hat{p}_h(\\xi, \\eta) = \\xi\\eta$. For an element with nodal values $\\{-1, 1, 1, -1\\}$, the interpolant is $\\hat{p}_h(\\xi, \\eta) = -\\xi\\eta$.\n\nIn both cases, we compute the gradient and its squared norm:\n$\\hat{\\nabla} \\hat{p}_h = (\\pm \\eta, \\pm \\xi)$.\n$|\\hat{\\nabla} \\hat{p}_h|^2 = (\\pm \\eta)^2 + (\\pm \\xi)^2 = \\xi^2 + \\eta^2$.\n\nThe integral is therefore identical for every element:\n$$\n\\int_K |\\nabla p_h|^2 \\, dx = \\int_{-1}^{1}\\int_{-1}^{1} (\\xi^2 + \\eta^2) \\, d\\xi \\, d\\eta\n$$\nWe evaluate this integral:\n$$\n\\int_{-1}^{1} \\left[ \\frac{\\xi^3}{3} + \\eta^2 \\xi \\right]_{\\xi=-1}^{\\xi=1} \\, d\\eta = \\int_{-1}^{1} \\left( \\left(\\frac{1}{3} + \\eta^2\\right) - \\left(-\\frac{1}{3} - \\eta^2\\right) \\right) \\, d\\eta = \\int_{-1}^{1} \\left( \\frac{2}{3} + 2\\eta^2 \\right) \\, d\\eta\n$$\n$$\n= \\left[ \\frac{2}{3}\\eta + \\frac{2}{3}\\eta^3 \\right]_{-1}^{1} = \\left(\\frac{2}{3} + \\frac{2}{3}\\right) - \\left(-\\frac{2}{3} - \\frac{2}{3}\\right) = \\frac{4}{3} - \\left(-\\frac{4}{3}\\right) = \\frac{8}{3}\n$$\nSo, $\\int_K |\\nabla p_h|^2 \\, dx = 8/3$ for all $4$ elements.\n\nNow we substitute this back into the condition for $s(p_h, p_h)$:\n$$\ns(p_{h},p_{h}) = \\gamma \\sum_{K} h^{2} \\int_{K} |\\nabla p_{h}|^2 \\, dx = 1\n$$\nWith $4$ elements, $h=1/2$ (so $h^2=1/4$), and the integral value of $8/3$:\n$$\n\\gamma \\cdot 4 \\cdot \\left(\\frac{1}{4}\\right) \\cdot \\left(\\frac{8}{3}\\right) = 1\n$$\n$$\n\\gamma \\cdot \\frac{8}{3} = 1\n$$\nSolving for $\\gamma$, we find:\n$$\n\\gamma = \\frac{3}{8}\n$$\nThis is the exact value of the parameter required by the problem.",
            "answer": "$$\n\\boxed{\\frac{3}{8}}\n$$"
        },
        {
            "introduction": "While theoretical analysis provides the foundation for stability, computational verification is a vital tool for the modern numerical analyst. This practice challenges you to design and implement a numerical experiment to probe the stability of several common finite element pairs. By assembling the discrete divergence operator and analyzing its nullspace with the Singular Value Decomposition (SVD), you will learn to computationally detect the presence of the spurious pressure modes discussed previously, providing empirical evidence for the stability (or instability) of a given discretization.",
            "id": "3395389",
            "problem": "Consider the incompressible Stokes equations in two spatial dimensions, with velocity field $u:\\Omega\\to\\mathbb{R}^2$ and pressure field $p:\\Omega\\to\\mathbb{R}$ on a polygonal domain $\\Omega\\subset\\mathbb{R}^2$:\n$$\n-\\nu \\Delta u + \\nabla p = f \\quad \\text{in } \\Omega,\\qquad \\nabla\\cdot u = 0 \\quad \\text{in } \\Omega,\\qquad u=0 \\quad \\text{on } \\partial\\Omega,\n$$\nwhere $\\nu>0$ is the kinematic viscosity and $f$ is a given body force. A classical mixed finite element method for the Stokes problem is based on the bilinear form $b(u,p) = -(\\nabla\\cdot u,p)$, where $(\\cdot,\\cdot)$ denotes the $L^2(\\Omega)$ inner product. For a chosen pair of finite element spaces $(V_h,Q_h)$—with $V_h\\subset [H^1_0(\\Omega)]^2$ for the velocity and $Q_h\\subset L^2_0(\\Omega)$ for the pressure—the discrete divergence coupling is represented by a matrix $B\\in\\mathbb{R}^{n_p\\times n_u}$ such that, for discrete vectors $u\\in\\mathbb{R}^{n_u}$ and $p\\in\\mathbb{R}^{n_p}$,\n$$\np^\\top B\\,u \\approx b(u,p),\n$$\nwith $n_u$ the number of velocity degrees of freedom and $n_p$ the number of pressure degrees of freedom. A pressure mode $p\\in\\mathbb{R}^{n_p}$ is spurious if $b(u,p)=0$ for all $u\\in\\mathbb{R}^{n_u}$ but $p$ is not a constant function. Equivalently, the discrete kernel of the bilinear form with respect to the pressure is the nullspace of $B^\\top$, and the number of spurious pressure modes is the dimension of $\\ker(B^\\top)$ minus one (to exclude the physically admissible constant pressure mode).\n\nStarting from the weak formulation and the definition of the divergence bilinear form, design and implement a numerical experiment that:\n- Constructs conforming triangular meshes of the unit square $\\Omega=[0,1]^2$, with optional geometric distortion applied to interior vertices while keeping boundary vertices fixed.\n- Assembles the discrete divergence coupling matrix $B$ for three standard pairs $(V_h,Q_h)$:\n    1. The continuous piecewise linear velocity space with interior homogeneous Dirichlet restriction paired with the elementwise constant pressure space ($\\text{P}_1/\\text{P}_0$).\n    2. The \"MINI\" element: the continuous piecewise linear velocity space enriched with one cubic bubble function per triangle, paired with the continuous piecewise linear pressure space ($\\text{P}_1^b/\\text{P}_1$).\n    3. The Taylor–Hood element: the continuous piecewise quadratic velocity space, paired with the continuous piecewise linear pressure space ($\\text{P}_2/\\text{P}_1$).\n- Computes the dimension of $\\ker(B^\\top)$ for each pair on specified meshes, and reports the number of spurious pressure modes as $\\max\\{ \\dim\\ker(B^\\top)-1,\\,0\\}$.\n\nUse the following fundamental bases and facts:\n- The bilinear form for the divergence coupling is $b(u,p) = \\int_\\Omega p\\,\\nabla\\cdot u\\,\\mathrm{d}x$.\n- For conforming simplicial meshes and polynomial finite elements, local basis functions and their gradients can be expressed in terms of barycentric coordinates on each triangle.\n- For the $P_1$ (piecewise linear) shape functions $N_i=\\lambda_i$ on a triangle, the gradients $\\nabla N_i$ are constant on that triangle; for $P_2$ (piecewise quadratic) shape functions, gradients are linear in barycentric coordinates; the element bubble function for the MINI element may be taken as $b=27\\,\\lambda_1\\lambda_2\\lambda_3$, with gradient $\\nabla b = 27\\left(\\lambda_2\\lambda_3\\nabla\\lambda_1 + \\lambda_1\\lambda_3\\nabla\\lambda_2 + \\lambda_1\\lambda_2\\nabla\\lambda_3\\right)$.\n- Accurate element integration requires quadrature exact for the polynomial degree of the integrand.\n\nYour program must:\n1. Generate meshes of the unit square with the following settings:\n   - A structured triangulation obtained by splitting each square cell along a fixed diagonal.\n   - Distortion applied to interior vertices only, with displacement bounded by a fraction of the local mesh size, leaving boundary vertices fixed.\n2. Assemble the matrix $B$ for each of the three pairs, enforcing homogeneous Dirichlet boundary conditions by restricting the velocity space to interior degrees of freedom only.\n3. Compute the dimension of the nullspace of $B^\\top$ via singular value decomposition, using a numerically robust threshold for determining rank deficiency.\n4. Produce the number of spurious pressure modes for each test case described below.\n\nTest Suite:\n- Case 1: Pair $\\text{P}_1/\\text{P}_0$, uniform mesh with $N=4$ subdivisions per side ($h=1/N$), no distortion.\n- Case 2: Pair $\\text{P}_1/\\text{P}_0$, mesh with $N=4$, distortion applied to interior vertices with amplitude $0.2\\,h$.\n- Case 3: Pair $\\text{P}_1^b/\\text{P}_1$ (MINI), uniform mesh with $N=4$, no distortion.\n- Case 4: Pair $\\text{P}_2/\\text{P}_1$ (Taylor–Hood), uniform mesh with $N=4$, no distortion.\n- Case 5: Pair $\\text{P}_2/\\text{P}_1$ (Taylor–Hood), coarse mesh with $N=2$, distortion applied with amplitude $0.2\\,h$.\n\nThere are no physical units required in this computation. Angles are not involved. The final outputs are integers.\n\nFinal Output Format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,result3,result4,result5]\"), where each result is the integer number of spurious pressure modes for the corresponding test case in the order listed above.",
            "solution": "The user wants to analyze the stability of several finite element pairs for the incompressible Stokes equations by computing the number of spurious pressure modes. This is a standard problem in the numerical analysis of partial differential equations.\n\n### Step 1: Problem Validation\n\nThe problem description is self-contained, scientifically grounded in the theory of mixed finite element methods, and posed in a clear, objective manner. It requests the implementation of a numerical experiment to compute a well-defined quantity—the number of spurious pressure modes for the Stokes problem—for three classical finite element pairs ($P_1/P_0$, MINI, Taylor-Hood) on specified triangulations of the unit square.\n\n- **Givens**: The Stokes equations, boundary conditions, weak formulation's bilinear form $b(u,p) = \\int_\\Omega p\\,\\nabla\\cdot u\\,\\mathrm{d}x$, definition of spurious pressure modes in relation to the kernel of the discrete divergence operator's transpose ($B^\\top$), definitions of the finite element spaces, basis functions, and mesh configurations are all explicitly provided.\n- **Scientific Soundness**: The problem statement is based on established principles of finite element theory for fluid dynamics. The concepts of inf-sup stability, spurious modes, and the properties of the chosen element pairs are central to this field.\n- **Well-Posedness**: The task is to compute a discrete quantity, $\\max\\{\\dim\\ker(B^\\top) - 1, 0\\}$, through a specified numerical procedure (matrix assembly and singular value decomposition). This is a well-defined computational task that yields a unique, meaningful result.\n- **Completeness and Consistency**: The problem provides all necessary details, including mesh parameters, element definitions, and test cases. The sign of the bilinear form $b(u,p)$ does not affect the kernel of $B^\\top$, so this is not a fatal flaw.\n\nThe problem is valid. The solution will proceed by implementing the specified numerical experiment.\n\n### Step 2: Solution Design\n\nThe core of the problem is to assemble the discrete divergence matrix $B$ and analyze its properties. The matrix entries are given by $B_{ij} = \\int_\\Omega \\psi_i (\\nabla \\cdot \\boldsymbol{\\phi}_j) \\mathrm{d}x$, where $\\{\\psi_i\\}$ are the basis functions for the discrete pressure space $Q_h$ and $\\{\\boldsymbol{\\phi}_j\\}$ are the basis functions for the discrete velocity space $V_h$. Since the velocity is a vector field, $\\boldsymbol{u}_h \\in [H^1_0(\\Omega)]^2$, its basis functions can be written as $\\boldsymbol{\\phi}_{k,x} = (N_k^v, 0)^\\top$ and $\\boldsymbol{\\phi}_{k,y} = (0, N_k^v)^\\top$, where $\\{N_k^v\\}$ are the scalar basis functions for the velocity component space.\n\nThe global matrix $B$ can be partitioned as $B = [B_x, B_y]$, where the entries are:\n$$\n(B_x)_{ik} = \\int_\\Omega \\psi_i \\frac{\\partial N_k^v}{\\partial x} \\mathrm{d}x, \\qquad (B_y)_{ik} = \\int_\\Omega \\psi_i \\frac{\\partial N_k^v}{\\partial y} \\mathrm{d}x\n$$\nThese integrals are assembled element by element. For a triangle $T$, the local contributions are calculated and added to the global matrices. The integrands are polynomials in barycentric coordinates $(\\lambda_1, \\lambda_2, \\lambda_3)$, so their integrals can be computed exactly using the formula:\n$$\n\\int_T \\lambda_1^a \\lambda_2^b \\lambda_3^c \\, \\mathrm{d}x = 2 \\cdot \\text{Area}(T) \\cdot \\frac{a! \\, b! \\, c!}{(a+b+c+2)!}\n$$\nThe gradients of the basis functions are expressed in terms of the constant gradients of the barycentric coordinates, $\\nabla \\lambda_i$, on each triangle. Homogeneous Dirichlet boundary conditions for velocity are enforced by including only basis functions associated with interior degrees of freedom.\n\nThe number of spurious pressure modes is $\\dim(\\ker(B^\\top)) - 1$. The dimension of the nullspace of $B^\\top$ is computed as $n_p - \\text{rank}(B)$, where $n_p$ is the number of pressure degrees of freedom. The rank of $B$ is determined by counting its singular values that are greater than a small numerical tolerance.\n\nThis procedure is implemented for each of the three specified finite element pairs, accounting for their unique basis functions and degrees of freedom:\n-   **$P_1/P_0$**: Continuous linear velocity, discontinuous constant pressure. The integrand $N^p \\nabla N^v$ is constant.\n-   **MINI ($P_1^b/P_1$)**: Continuous linear-plus-bubble velocity, continuous linear pressure. The integrand involves products like $\\lambda_i \\nabla \\lambda_j$ (linear) and $\\lambda_i \\nabla b_T$ (cubic).\n-   **Taylor-Hood ($P_2/P_1$)**: Continuous quadratic velocity, continuous linear pressure. The integrand involves products $\\lambda_i \\nabla N_j^{P_2}$ (quadratic).\n\nAll steps are implemented in a single Python script adhering to the specified environment.",
            "answer": "```python\nimport numpy as np\nfrom scipy.linalg import svd\nfrom math import factorial\n\ndef solve():\n    \"\"\"\n    Main function to run the FEM analysis for spurious pressure modes.\n    \"\"\"\n\n    def generate_mesh(N, distortion_amplitude):\n        \"\"\"\n        Generates structured P1 and P2 meshes of the unit square with optional distortion.\n        P1 nodes are vertices. P2 nodes include vertices and edge midpoints.\n        \"\"\"\n        h = 1.0 / N\n        \n        # 1. P1 nodes (vertices of triangles)\n        p1_nodes = np.array([[i * h, j * h] for j in range(N + 1) for i in range(N + 1)])\n        \n        # Apply distortion to interior P1 nodes\n        np.random.seed(0)\n        is_interior_p1 = np.ones(len(p1_nodes), dtype=bool)\n        for i, node in enumerate(p1_nodes):\n            is_boundary = np.isclose(node[0], 0.0) or np.isclose(node[0], 1.0) or \\\n                          np.isclose(node[1], 0.0) or np.isclose(node[1], 1.0)\n            is_interior_p1[i] = not is_boundary\n            if is_interior_p1[i] and distortion_amplitude > 0:\n                p1_nodes[i] += distortion_amplitude * (2 * np.random.rand(2) - 1)\n\n        # 2. Elements (triangles based on P1 nodes)\n        elements = np.array([[j * (N + 1) + i, j * (N + 1) + i + 1, (j + 1) * (N + 1) + i + 1]\n                             for j in range(N) for i in range(N)] +\n                            [[j * (N + 1) + i, (j + 1) * (N + 1) + i + 1, (j + 1) * (N + 1) + i]\n                             for j in range(N) for i in range(N)])\n\n        # 3. P2 nodes (vertices and edge midpoints)\n        p2_nodes = np.array([[i * h/2, j * h/2] for j in range(2 * N + 1) for i in range(2 * N + 1)])\n        \n        # Apply distortion to P2 mesh, keeping consistency with P1\n        is_interior_p2 = np.ones(len(p2_nodes), dtype=bool)\n        np.random.seed(1)\n        for i, node in enumerate(p2_nodes):\n            is_boundary = np.isclose(node[0], 0.0) or np.isclose(node[0], 1.0) or \\\n                          np.isclose(node[1], 0.0) or np.isclose(node[1], 1.0)\n            is_interior_p2[i] = not is_boundary\n            \n            is_p1_grid_point = (i % (2 * N + 1)) % 2 == 0 and (i // (2 * N + 1)) % 2 == 0\n            if is_interior_p2[i] and not is_p1_grid_point and distortion_amplitude > 0:\n                 p2_nodes[i] += distortion_amplitude * (2 * np.random.rand(2) - 1)\n        \n        # Ensure distorted P1 nodes are correctly placed within the P2 node list\n        for j in range(N + 1):\n           for i in range(N + 1):\n               p1_idx = j * (N + 1) + i\n               p2_idx = (2*j) * (2 * N + 1) + (2*i)\n               p2_nodes[p2_idx] = p1_nodes[p1_idx]\n\n        return p1_nodes, elements, is_interior_p1, p2_nodes, is_interior_p2\n\n    def get_triangle_properties(coords):\n        p1, p2, p3 = coords\n        area = 0.5 * abs(p1[0]*(p2[1]-p3[1]) + p2[0]*(p3[1]-p1[1]) + p3[0]*(p1[1]-p2[1]))\n        grad_l1 = np.array([p2[1] - p3[1], p3[0] - p2[0]]) / (2 * area)\n        grad_l2 = np.array([p3[1] - p1[1], p1[0] - p3[0]]) / (2 * area)\n        grad_l3 = np.array([p1[1] - p2[1], p2[0] - p1[0]]) / (2 * area)\n        return area, [grad_l1, grad_l2, grad_l3]\n\n    def integral_bary(a, b, c, area):\n        return 2 * area * (factorial(a) * factorial(b) * factorial(c)) / factorial(a + b + c + 2)\n\n    def assemble_B_p1p0(p1_nodes, elements, is_interior_p1):\n        num_p_dofs = len(elements)\n        interior_v_nodes = np.where(is_interior_p1)[0]\n        num_v_comp_dofs = len(interior_v_nodes)\n        v_dof_map = {node_idx: i for i, node_idx in enumerate(interior_v_nodes)}\n        \n        Bx = np.zeros((num_p_dofs, num_v_comp_dofs))\n        By = np.zeros((num_p_dofs, num_v_comp_dofs))\n\n        for e, elem_nodes in enumerate(elements):\n            coords = p1_nodes[elem_nodes]\n            area, grads = get_triangle_properties(coords)\n            \n            for i in range(3): # Local velocity basis function (P1)\n                node_idx = elem_nodes[i]\n                if node_idx in v_dof_map:\n                    v_dof = v_dof_map[node_idx]\n                    Bx[e, v_dof] += area * grads[i][0]\n                    By[e, v_dof] += area * grads[i][1]\n        \n        return np.hstack([Bx, By])\n\n    def assemble_B_mini(p1_nodes, elements, is_interior_p1):\n        num_p_dofs = len(p1_nodes)\n        interior_v_nodes = np.where(is_interior_p1)[0]\n        num_v_p1_dofs = len(interior_v_nodes)\n        num_v_bubble_dofs = len(elements)\n        num_v_comp_dofs = num_v_p1_dofs + num_v_bubble_dofs\n\n        v_p1_dof_map = {node_idx: i for i, node_idx in enumerate(interior_v_nodes)}\n\n        Bx = np.zeros((num_p_dofs, num_v_comp_dofs))\n        By = np.zeros((num_p_dofs, num_v_comp_dofs))\n\n        for e, elem_nodes in enumerate(elements):\n            coords = p1_nodes[elem_nodes]\n            area, grads = get_triangle_properties(coords)\n            \n            p_dofs_local = elem_nodes\n            \n            for j in range(3): # local pressure basis lambda_j\n                p_dof = p_dofs_local[j]\n                \n                # 1. Coupling with P1 velocity part\n                for i in range(3): # local velocity basis lambda_i\n                    v_node_idx = elem_nodes[i]\n                    if v_node_idx in v_p1_dof_map:\n                        v_dof = v_p1_dof_map[v_node_idx]\n                        integral_coeff = area / 3.0\n                        Bx[p_dof, v_dof] += integral_coeff * grads[i][0]\n                        By[p_dof, v_dof] += integral_coeff * grads[i][1]\n                        \n                # 2. Coupling with bubble velocity part\n                v_bubble_dof = num_v_p1_dofs + e\n                \n                # Integral of lambda_j * grad(bubble)\n                # grad(b) = 27 * sum_k (l0*l1*l2/lk) * grad(lk)\n                # We need integral of lambda_j * grad(b)\n                bary_powers = []\n                for k_sum in range(3):\n                    powers = [1, 1, 1]\n                    powers[k_sum] = 0\n                    powers[j] += 1\n                    bary_powers.append(powers)\n                \n                integral_coeffs = [integral_bary(p[0],p[1],p[2],area) for p in bary_powers]\n                \n                final_grad_x = 27 * sum(integral_coeffs[k] * grads[k][0] for k in range(3))\n                final_grad_y = 27 * sum(integral_coeffs[k] * grads[k][1] for k in range(3))\n                \n                Bx[p_dof, v_bubble_dof] += final_grad_x\n                By[p_dof, v_bubble_dof] += final_grad_y\n\n        return np.hstack([Bx, By])\n        \n    def assemble_B_th(p1_nodes, elements, p2_nodes, is_interior_p2):\n        num_p_dofs = len(p1_nodes)\n\n        interior_v_nodes_p2_indices = np.where(is_interior_p2)[0]\n        num_v_comp_dofs = len(interior_v_nodes_p2_indices)\n        v_dof_map = {node_idx: i for i, node_idx in enumerate(interior_v_nodes_p2_indices)}\n\n        N = int(0.5 * (np.sqrt(4*len(p2_nodes) - 3) - 1))\n        \n        Bx = np.zeros((num_p_dofs, num_v_comp_dofs))\n        By = np.zeros((num_p_dofs, num_v_comp_dofs))\n\n        for e, elem_nodes in enumerate(elements):\n            coords = p1_nodes[elem_nodes]\n            area, grads = get_triangle_properties(coords)\n            \n            p2_map = np.zeros(6, dtype=int)\n            v_indices = [2*(elem_nodes[i] // (N+1))*(2*N+1) + 2*(elem_nodes[i] % (N+1)) for i in range(3)]\n            p2_map[:3] = v_indices\n            p2_map[3] = (v_indices[0] + v_indices[1])//2\n            p2_map[4] = (v_indices[1] + v_indices[2])//2\n            p2_map[5] = (v_indices[2] + v_indices[0])//2\n\n            for j in range(3): # Local pressure basis lambda_j\n                p_dof = elem_nodes[j]\n                \n                for k in range(6): # Local velocity basis N_k^P2\n                    v_node_idx = p2_map[k]\n                    if v_node_idx in v_dof_map:\n                        v_dof = v_dof_map[v_node_idx]\n                        \n                        gx, gy = 0, 0\n                        I_1 = integral_bary(1,0,0, area)\n                        I_2 = integral_bary(2,0,0, area)\n                        I_11 = integral_bary(1,1,0, area)\n\n                        if k  3: # Vertex functions N_k = l_k(2l_k - 1)\n                            integ_lj_lk = I_2 if j == k else I_11\n                            coeff = 4 * integ_lj_lk - I_1\n                            gx += coeff * grads[k][0]\n                            gy += coeff * grads[k][1]\n                        else: # Edge functions N_k = 4*l_a*l_b\n                            edge_map = {3: (0, 1), 4: (1, 2), 5: (2, 0)}\n                            a, b = edge_map[k]\n                            \n                            integ_lj_lb = I_2 if j == b else I_11\n                            integ_lj_la = I_2 if j == a else I_11\n\n                            coeff_a = 4 * integ_lj_lb\n                            coeff_b = 4 * integ_lj_la\n                            \n                            gx += coeff_a * grads[a][0] + coeff_b * grads[b][0]\n                            gy += coeff_a * grads[a][1] + coeff_b * grads[b][1]\n\n                        Bx[p_dof, v_dof] += gx\n                        By[p_dof, v_dof] += gy\n        \n        return np.hstack([Bx, By])\n        \n    def count_spurious_modes(B, tol=1e-10):\n        if B.size == 0:\n            return 0\n        s = svd(B, compute_uv=False)\n        rank = np.sum(s > tol * s[0]) if s.size > 0 else 0\n        num_p_dofs = B.shape[0]\n        nullity = num_p_dofs - rank\n        return max(0, nullity - 1)\n\n    test_cases = [\n        {'pair': 'P1P0', 'N': 4, 'dist': 0.0},\n        {'pair': 'P1P0', 'N': 4, 'dist': 0.2},\n        {'pair': 'MINI', 'N': 4, 'dist': 0.0},\n        {'pair': 'TH', 'N': 4, 'dist': 0.0},\n        {'pair': 'TH', 'N': 2, 'dist': 0.2},\n    ]\n\n    results = []\n    for case in test_cases:\n        N = case['N']\n        dist = case['dist']\n        h = 1.0 / N\n\n        p1_nodes, elements, is_interior_p1, p2_nodes, is_interior_p2 = generate_mesh(N, dist * h)\n        \n        if case['pair'] == 'P1P0':\n            B = assemble_B_p1p0(p1_nodes, elements, is_interior_p1)\n        elif case['pair'] == 'MINI':\n            B = assemble_B_mini(p1_nodes, elements, is_interior_p1)\n        elif case['pair'] == 'TH':\n            B = assemble_B_th(p1_nodes, elements, p2_nodes, is_interior_p2)\n        \n        num_spurious = count_spurious_modes(B)\n        results.append(int(num_spurious))\n        \n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}