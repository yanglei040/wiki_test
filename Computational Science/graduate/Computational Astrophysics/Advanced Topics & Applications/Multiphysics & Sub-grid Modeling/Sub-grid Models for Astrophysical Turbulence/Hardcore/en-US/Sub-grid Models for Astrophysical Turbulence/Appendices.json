{
    "hands_on_practices": [
        {
            "introduction": "The fundamental challenge in simulating astrophysical turbulence is the immense range of scales between where energy is injected and where it is dissipated by viscosity. A Large-Eddy Simulation (LES) tackles this by resolving the large scales and modeling the small ones. This exercise provides a crucial first step in designing an LES by having you calculate the necessary grid resolution to ensure a clear separation between the resolved and modeled scales, based on the physical properties of the flow .",
            "id": "3537255",
            "problem": "Consider a patch of the Interstellar Medium (ISM) modeled as a compressible fluid obeying the Navier–Stokes equations with an effective kinematic viscosity. In a Large-Eddy Simulation (LES), the grid spacing acts as a spatial filter that limits the highest resolvable wavenumber. You are given the following physically plausible parameters for a driven, approximately isotropic turbulent flow in the warm neutral ISM:\n- Driving (energy injection) scale $L_{\\mathrm{drive}} = 50 \\,\\mathrm{pc}$,\n- One-dimensional turbulent velocity dispersion at the driving scale $U = 10 \\,\\mathrm{km\\,s^{-1}}$,\n- Effective kinematic viscosity $\\nu = 5 \\times 10^{21} \\,\\mathrm{cm^{2}\\,s^{-1}}$.\n\nAssume a Kolmogorov-like inertial cascade in which the mean energy dissipation rate per unit mass satisfies $\\epsilon \\sim U^{3}/L_{\\mathrm{drive}}$, and the smallest physical (dissipation) scale is the Kolmogorov microscale $\\eta$ determined by viscosity and $\\epsilon$. The driving wavenumber is $k_{\\mathrm{drive}}$ and the dissipation wavenumber is $k_{\\mathrm{diss}}$, with the standard relation between a characteristic length scale $\\ell$ and wavenumber $k$ given by $k = 2\\pi/\\ell$. For a uniform Cartesian grid, the highest resolvable (Nyquist) wavenumber is $k_{c} = \\pi/\\Delta x$, where $\\Delta x$ is the grid spacing.\n\nYour task is to determine the smallest grid scale required to separate the driving scale from the dissipation scale by at least one decade in wavenumber for an LES that does not attempt to resolve beyond the physical dissipation wavenumber. Formally, require that $\\min(k_{\\mathrm{diss}},\\,k_{c})/k_{\\mathrm{drive}} \\geq 10$ and choose $\\Delta x$ as large as possible while satisfying this constraint. Express your final $\\Delta x$ in parsecs (pc). Use $1 \\,\\mathrm{pc} = 3.0857 \\times 10^{18} \\,\\mathrm{cm}$ and $1 \\,\\mathrm{km\\,s^{-1}} = 10^{5} \\,\\mathrm{cm\\,s^{-1}}$. Round your answer to four significant figures.",
            "solution": "First, we establish a consistent system of units. The CGS (centimeter-gram-second) system is appropriate. The given parameters are converted as follows:\n- Driving scale: $L_{\\mathrm{drive}} = 50 \\,\\mathrm{pc} = 50 \\times (3.0857 \\times 10^{18} \\,\\mathrm{cm}) = 1.54285 \\times 10^{20} \\,\\mathrm{cm}$.\n- Turbulent velocity dispersion: $U = 10 \\,\\mathrm{km\\,s^{-1}} = 10 \\times (10^{5} \\,\\mathrm{cm\\,s^{-1}}) = 10^{6} \\,\\mathrm{cm\\,s^{-1}}$.\n- Effective kinematic viscosity: $\\nu = 5 \\times 10^{21} \\,\\mathrm{cm^{2}\\,s^{-1}}$.\n\nThe problem states a formal requirement for the scale separation in the simulation:\n$$\n\\frac{\\min(k_{\\mathrm{diss}},\\,k_{c})}{k_{\\mathrm{drive}}} \\geq 10\n$$\nwhere $k_{\\mathrm{drive}}$ is the driving wavenumber, $k_{\\mathrm{diss}}$ is the dissipation wavenumber, and $k_{c}$ is the grid cutoff (Nyquist) wavenumber. We are tasked with finding the largest possible grid spacing $\\Delta x$ that satisfies this constraint.\n\nThe wavenumbers are related to their characteristic length scales. Using the definitions provided:\n- Driving wavenumber: $k_{\\mathrm{drive}} = \\frac{2\\pi}{L_{\\mathrm{drive}}}$.\n- Dissipation wavenumber: $k_{\\mathrm{diss}} = \\frac{2\\pi}{\\eta}$, where $\\eta$ is the Kolmogorov microscale.\n- Nyquist wavenumber: $k_{c} = \\frac{\\pi}{\\Delta x}$.\n\nFrom the definition of $k_c$, we see that $\\Delta x = \\frac{\\pi}{k_c}$. Therefore, maximizing $\\Delta x$ is equivalent to minimizing $k_{c}$. Our objective is to find the minimum value of $k_c$ that satisfies the given constraint.\n\nThe constraint involves the term $\\min(k_{\\mathrm{diss}}, k_{c})$. To evaluate this, we must compare the physical dissipation wavenumber $k_{\\mathrm{diss}}$ with the wavenumber $10 k_{\\mathrm{drive}}$. The problem specifies that the simulation is an LES that \"does not attempt to resolve beyond the physical dissipation wavenumber,\" which implies that the grid cutoff wavenumber will be less than or equal to the dissipation wavenumber, i.e., $k_{c} \\le k_{\\mathrm{diss}}$. If this is the case, the minimum is $k_c$, and the constraint simplifies to $k_c \\geq 10 k_{\\mathrm{drive}}$. This simplification is valid only if the physical scales of the system themselves satisfy $k_{\\mathrm{diss}} \\geq 10 k_{\\mathrm{drive}}$. We must verify this condition.\n\nThe ratio of the dissipation to driving wavenumbers is given by the ratio of the driving scale to the Kolmogorov microscale:\n$$\n\\frac{k_{\\mathrm{diss}}}{k_{\\mathrm{drive}}} = \\frac{2\\pi / \\eta}{2\\pi / L_{\\mathrm{drive}}} = \\frac{L_{\\mathrm{drive}}}{\\eta}\n$$\nThe Kolmogorov microscale $\\eta$ is defined as $\\eta = \\left(\\frac{\\nu^3}{\\epsilon}\\right)^{1/4}$. The mean energy dissipation rate per unit mass, $\\epsilon$, is given by the scaling relation $\\epsilon \\sim U^{3}/L_{\\mathrm{drive}}$. For this calculation, we treat this as an equality, $\\epsilon = U^{3}/L_{\\mathrm{drive}}$, a standard practice in turbulence theory for order-of-magnitude analysis.\n\nSubstituting $\\epsilon$ into the expression for $\\eta$:\n$$\n\\eta = \\left( \\frac{\\nu^3}{U^3 / L_{\\mathrm{drive}}} \\right)^{1/4} = \\left( \\frac{\\nu^3 L_{\\mathrm{drive}}}{U^3} \\right)^{1/4}\n$$\nThe ratio of scales can now be expressed in terms of the driving scale Reynolds number, $Re = \\frac{U L_{\\mathrm{drive}}}{\\nu}$:\n$$\n\\frac{L_{\\mathrm{drive}}}{\\eta} = \\frac{L_{\\mathrm{drive}}}{\\left( \\frac{\\nu^3 L_{\\mathrm{drive}}}{U^3} \\right)^{1/4}} = \\frac{L_{\\mathrm{drive}}}{ \\frac{\\nu^{3/4} L_{\\mathrm{drive}}^{1/4}}{U^{3/4}} } = \\frac{L_{\\mathrm{drive}}^{3/4} U^{3/4}}{\\nu^{3/4}} = \\left( \\frac{U L_{\\mathrm{drive}}}{\\nu} \\right)^{3/4} = Re^{3/4}\n$$\nWe now calculate the Reynolds number using the given parameters in CGS units:\n$$\nRe = \\frac{(10^{6} \\,\\mathrm{cm\\,s^{-1}})(1.54285 \\times 10^{20} \\,\\mathrm{cm})}{5 \\times 10^{21} \\,\\mathrm{cm^{2}\\,s^{-1}}} = \\frac{1.54285 \\times 10^{26}}{5 \\times 10^{21}} = 30857\n$$\nThe ratio of the physical wavenumbers is then:\n$$\n\\frac{k_{\\mathrm{diss}}}{k_{\\mathrm{drive}}} = Re^{3/4} = (30857)^{3/4} \\approx 2303.6\n$$\nSince $2303.6$ is significantly greater than $10$, the condition $k_{\\mathrm{diss}} > 10 k_{\\mathrm{drive}}$ is satisfied. This confirms that the inertial range of the turbulent flow is wide enough to accommodate the required decade of scale separation.\n\nWith this confirmed, for an LES with $k_c \\le k_{\\mathrm{diss}}$, the constraint $\\min(k_{\\mathrm{diss}},\\,k_{c}) \\geq 10 k_{\\mathrm{drive}}$ becomes:\n$$\nk_c \\geq 10 k_{\\mathrm{drive}}\n$$\nTo maximize $\\Delta x$, we must choose the smallest possible value for $k_c$ that satisfies this inequality, which is:\n$$\nk_{c, \\mathrm{min}} = 10 k_{\\mathrm{drive}}\n$$\nThis choice is consistent with the nature of LES, as $k_{c, \\mathrm{min}} = 10 k_{\\mathrm{drive}} \\ll k_{\\mathrm{diss}} \\approx 2303.6 k_{\\mathrm{drive}}$.\n\nNow, we can determine the maximum allowed grid spacing, $\\Delta x_{\\mathrm{max}}$, that corresponds to $k_{c, \\mathrm{min}}$:\n$$\n\\Delta x_{\\mathrm{max}} = \\frac{\\pi}{k_{c, \\mathrm{min}}} = \\frac{\\pi}{10 k_{\\mathrm{drive}}}\n$$\nSubstituting the definition $k_{\\mathrm{drive}} = 2\\pi/L_{\\mathrm{drive}}$ yields a simple relationship:\n$$\n\\Delta x_{\\mathrm{max}} = \\frac{\\pi}{10 \\left(\\frac{2\\pi}{L_{\\mathrm{drive}}}\\right)} = \\frac{\\pi L_{\\mathrm{drive}}}{20\\pi} = \\frac{L_{\\mathrm{drive}}}{20}\n$$\nThe required grid spacing is simply one-twentieth of the driving scale.\n\nUsing the given value $L_{\\mathrm{drive}} = 50 \\,\\mathrm{pc}$:\n$$\n\\Delta x = \\frac{50 \\,\\mathrm{pc}}{20} = 2.5 \\,\\mathrm{pc}\n$$\nThe problem requires the answer to be expressed to four significant figures. Thus, we write $2.5$ as $2.500$.",
            "answer": "$$\\boxed{2.500}$$"
        },
        {
            "introduction": "Once an LES is underway, the sub-grid scale (SGS) model must represent the effects of the unresolved turbulence on the resolved flow, typically as an enhanced 'eddy' viscosity. This practice provides a concrete application of the classic Smagorinsky model, guiding you to calculate the eddy viscosity $\\nu_t$ from the local resolved strain-rate tensor. By comparing your result to the molecular viscosity, you will gain a direct appreciation for how dominant sub-grid effects are in high-Reynolds-number astrophysical flows .",
            "id": "3537221",
            "problem": "Consider a compressible Large Eddy Simulation (LES) of supersonic turbulence in a self-gravitating molecular cloud. At a particular grid point, the filtered strain-rate tensor is defined by $S_{ij} \\equiv \\frac{1}{2}\\left(\\frac{\\partial u_i}{\\partial x_j} + \\frac{\\partial u_j}{\\partial x_i}\\right)$ and its trace-free part by $\\tilde{S}_{ij} \\equiv S_{ij} - \\frac{1}{3} S_{kk} \\delta_{ij}$. The deviatoric sub-grid scale stress is modeled using the Boussinesq eddy-viscosity hypothesis as $\\tau_{ij} - \\frac{1}{3}\\tau_{kk} \\delta_{ij} = -2 \\rho \\nu_t \\tilde{S}_{ij}$, where $\\nu_t$ is the kinematic eddy viscosity. Adopt a mixing-length ansatz with characteristic length $\\ell = C_s \\Delta$, where $\\Delta$ is the local filter length and $C_s$ is the Smagorinsky coefficient, and define the characteristic strain magnitude by $|\\tilde{S}| \\equiv \\sqrt{2 \\tilde{S}_{ij}\\tilde{S}_{ij}}$. \n\nStarting from these assumptions and definitions, derive an expression for $\\nu_t$ in terms of $C_s$, $\\Delta$, and the invariant $\\tilde{S}_{ij}\\tilde{S}_{ij}$, and then evaluate the ratio $R \\equiv \\nu_t / \\nu_{\\mathrm{mol}}$ at the point where:\n- $C_s = 0.17$,\n- $\\Delta = 1.0 \\times 10^{15} \\ \\mathrm{m}$,\n- the nonzero components of the symmetric trace-free tensor $\\tilde{S}_{ij}$ (in $\\mathrm{s}^{-1}$) are:\n  $\\tilde{S}_{11} = 1.2 \\times 10^{-12}$, $\\tilde{S}_{22} = -1.5 \\times 10^{-12}$, $\\tilde{S}_{33} = 0.3 \\times 10^{-12}$, $\\tilde{S}_{12} = \\tilde{S}_{21} = 4.0 \\times 10^{-13}$, $\\tilde{S}_{13} = \\tilde{S}_{31} = -2.5 \\times 10^{-13}$, $\\tilde{S}_{23} = \\tilde{S}_{32} = 3.0 \\times 10^{-13}$,\n- and the local molecular (kinematic) viscosity is $\\nu_{\\mathrm{mol}} = 6.00 \\times 10^{12} \\ \\mathrm{m}^2 \\ \\mathrm{s}^{-1}$.\n\nGive your final answer as the single dimensionless number $R$, rounded to three significant figures. Do not include units in your final answer.",
            "solution": "The kinematic eddy viscosity, $\\nu_t$, is constructed based on a mixing-length model. By dimensional analysis, a kinematic viscosity must have dimensions of $[L]^2[T]^{-1}$. The problem provides a characteristic length scale, $\\ell$, and a characteristic strain rate, $|\\tilde{S}|$, which has dimensions of $[T]^{-1}$. The only combination of the characteristic scales $\\ell$ and $|\\tilde{S}|$ that yields the correct dimensions for a kinematic viscosity is $\\nu_t \\propto \\ell^2 |\\tilde{S}|$. The standard Smagorinsky model formulation uses this relationship.\nTherefore, the expression for $\\nu_t$ is:\n$$ \\nu_t = \\ell^2 |\\tilde{S}| $$\nSubstituting the given definitions for $\\ell = C_s \\Delta$ and $|\\tilde{S}| = \\sqrt{2 \\tilde{S}_{ij}\\tilde{S}_{ij}}$, we obtain:\n$$ \\nu_t = (C_s \\Delta)^2 \\sqrt{2 \\tilde{S}_{ij}\\tilde{S}_{ij}} $$\nThis is the required expression.\n\n**Calculation of the Invariant $\\tilde{S}_{ij}\\tilde{S}_{ij}$**\nThe term $\\tilde{S}_{ij}\\tilde{S}_{ij}$ implies a sum over both indices $i$ and $j$. Since the tensor $\\tilde{S}_{ij}$ is symmetric ($\\tilde{S}_{ij} = \\tilde{S}_{ji}$), the sum of squares of all components is:\n$$ \\tilde{S}_{ij}\\tilde{S}_{ij} = \\sum_{i=1}^3 \\sum_{j=1}^3 (\\tilde{S}_{ij})^2 = \\tilde{S}_{11}^2 + \\tilde{S}_{22}^2 + \\tilde{S}_{33}^2 + 2(\\tilde{S}_{12}^2 + \\tilde{S}_{13}^2 + \\tilde{S}_{23}^2) $$\nWe substitute the given numerical values (in units of $\\mathrm{s}^{-1}$):\n$$ \\tilde{S}_{11}^2 = (1.2 \\times 10^{-12})^2 = 1.44 \\times 10^{-24} $$\n$$ \\tilde{S}_{22}^2 = (-1.5 \\times 10^{-12})^2 = 2.25 \\times 10^{-24} $$\n$$ \\tilde{S}_{33}^2 = (0.3 \\times 10^{-12})^2 = 0.09 \\times 10^{-24} $$\n$$ 2\\tilde{S}_{12}^2 = 2 \\times (4.0 \\times 10^{-13})^2 = 2 \\times (1.6 \\times 10^{-25}) = 0.32 \\times 10^{-24} $$\n$$ 2\\tilde{S}_{13}^2 = 2 \\times (-2.5 \\times 10^{-13})^2 = 2 \\times (6.25 \\times 10^{-26}) = 0.125 \\times 10^{-24} $$\n$$ 2\\tilde{S}_{23}^2 = 2 \\times (3.0 \\times 10^{-13})^2 = 2 \\times (9.0 \\times 10^{-26}) = 0.18 \\times 10^{-24} $$\nSumming these values:\n$$ \\tilde{S}_{ij}\\tilde{S}_{ij} = (1.44 + 2.25 + 0.09 + 0.32 + 0.125 + 0.18) \\times 10^{-24} \\ \\mathrm{s}^{-2} $$\n$$ \\tilde{S}_{ij}\\tilde{S}_{ij} = 4.405 \\times 10^{-24} \\ \\mathrm{s}^{-2} $$\n\n**Calculation of the Characteristic Strain Magnitude $|\\tilde{S}|**\nUsing the definition $|\\tilde{S}| = \\sqrt{2 \\tilde{S}_{ij}\\tilde{S}_{ij}}$:\n$$ |\\tilde{S}| = \\sqrt{2 \\times (4.405 \\times 10^{-24} \\ \\mathrm{s}^{-2})} = \\sqrt{8.81 \\times 10^{-24} \\ \\mathrm{s}^{-2}} = \\sqrt{8.81} \\times 10^{-12} \\ \\mathrm{s}^{-1} $$\n\n**Calculation of the Eddy Viscosity $\\nu_t$**\nNow we compute $\\nu_t$ using the derived formula:\n$$ \\nu_t = (C_s \\Delta)^2 |\\tilde{S}| $$\nGiven $C_s = 0.17$ and $\\Delta = 1.0 \\times 10^{15} \\ \\mathrm{m}$:\n$$ (C_s \\Delta)^2 = (0.17 \\times 1.0 \\times 10^{15} \\ \\mathrm{m})^2 = (0.17)^2 \\times 10^{30} \\ \\mathrm{m}^2 = 0.0289 \\times 10^{30} \\ \\mathrm{m}^2 = 2.89 \\times 10^{28} \\ \\mathrm{m}^2 $$\nSubstituting this and the value for $|\\tilde{S}|$:\n$$ \\nu_t = (2.89 \\times 10^{28} \\ \\mathrm{m}^2) \\times (\\sqrt{8.81} \\times 10^{-12} \\ \\mathrm{s}^{-1}) $$\n$$ \\nu_t = 2.89 \\times \\sqrt{8.81} \\times 10^{16} \\ \\mathrm{m}^2 \\ \\mathrm{s}^{-1} $$\nUsing $\\sqrt{8.81} \\approx 2.968164$:\n$$ \\nu_t \\approx 2.89 \\times 2.968164 \\times 10^{16} \\ \\mathrm{m}^2 \\ \\mathrm{s}^{-1} \\approx 8.5780 \\times 10^{16} \\ \\mathrm{m}^2 \\ \\mathrm{s}^{-1} $$\n\n**Calculation of the Ratio $R$**\nFinally, we calculate the ratio $R = \\nu_t / \\nu_{\\mathrm{mol}}$, with $\\nu_{\\mathrm{mol}} = 6.00 \\times 10^{12} \\ \\mathrm{m}^2 \\ \\mathrm{s}^{-1}$:\n$$ R = \\frac{\\nu_t}{\\nu_{\\mathrm{mol}}} = \\frac{8.5780 \\times 10^{16} \\ \\mathrm{m}^2 \\ \\mathrm{s}^{-1}}{6.00 \\times 10^{12} \\ \\mathrm{m}^2 \\ \\mathrm{s}^{-1}} $$\n$$ R = \\frac{8.5780}{6.00} \\times 10^{16-12} = \\frac{8.5780}{6.00} \\times 10^4 $$\n$$ R \\approx 1.42967 \\times 10^4 $$\nThe problem requires the answer to be rounded to three significant figures.\n$$ R \\approx 1.43 \\times 10^4 $$\nThis can also be written as $14300$.",
            "answer": "$$\\boxed{1.43 \\times 10^{4}}$$"
        },
        {
            "introduction": "While simple, the Smagorinsky model's use of a constant coefficient is a significant limitation, as real turbulence is highly intermittent. The dynamic procedure offers a powerful solution by determining the model coefficient locally from the resolved flow itself. This advanced programming exercise will guide you through the implementation of the dynamic Smagorinsky model, including the use of the Germano identity and handling numerical challenges like model backscatter .",
            "id": "3537227",
            "problem": "Consider a two-dimensional, constant-density resolved velocity field defined on a mathematically periodic grid with spacing $\\Delta x = \\Delta y = \\Delta$. In the Large Eddy Simulation (LES) closure with the Smagorinsky model, the deviatoric subgrid-scale stress at the grid scale is modeled as $\\tau_{ij}^{\\mathrm{dev}} = -2 \\left(C_s \\Delta\\right)^2 \\left\\lvert S \\right\\rvert S_{ij}$, where $S_{ij} = \\frac{1}{2}\\left(\\partial_j u_i + \\partial_i u_j\\right)$ is the resolved strain-rate tensor and $\\left\\lvert S \\right\\rvert = \\sqrt{2 S_{ij} S_{ij}}$. The dynamic procedure uses an additional test filter of width $\\hat{\\Delta}$ and the Germano identity to determine $C_s^2$ from the resolved velocity field only. For constant density and incompressible-like resolved fields, the Germano identity is $L_{ij} = \\widetilde{u_i u_j} - \\widetilde{u_i}\\,\\widetilde{u_j}$, and the model-based approximation gives a tensor proportional to $C_s^2$ constructed from combinations of filtered strain tensors at the grid and test scales. The dynamic coefficient $C_s^2$ must be obtained by minimizing the modeling error in a least-squares sense using only locality-preserving operations (finite differences and discrete box filters), and then any negative values of $C_s^2$ must be handled either by clipping to zero or by localized averaging of the least-squares numerator and denominator before taking their ratio.\n\nStarting from the fundamental definitions of filtering, strain-rate, the deviatoric projection $A_{ij}^{\\mathrm{dev}} = A_{ij} - \\frac{1}{d}\\operatorname{tr}(A)\\delta_{ij}$ in $d$ spatial dimensions, and the Germano identity, derive an algorithm that, for a given resolved velocity field on a periodic grid, computes the local dynamic coefficient $C_s^2$ at every grid point using a discrete top-hat (box) test filter and centered finite differences, and then applies one of the two negativity-handling strategies:\n- clipping: replace any negative $C_s^2$ by $0$,\n- localized averaging: compute a localized box average of the least-squares numerator and denominator over a compact stencil before forming $C_s^2$; if the averaged denominator is smaller than a regularization threshold, set $C_s^2$ to $0$, and if the resulting $C_s^2$ is negative, set it to $0$.\n\nUse $d = 2$, a square domain of side length $L = N \\Delta$ with $N$ grid points per direction and periodic boundary conditions, a grid-filter width $\\Delta = 1$ (nondimensional units), and a test filter width $\\hat{\\Delta} = 2$. Implement centered finite differences with periodic wrapping to compute spatial derivatives, and a discrete top-hat test filter implemented as a $3 \\times 3$ periodic box average. The dynamic least-squares contraction of two symmetric rank-$2$ tensors $A_{ij}$ and $B_{ij}$ should use the full double contraction $A_{ij}B_{ij}$, which in two dimensions equals $A_{xx}B_{xx} + A_{yy}B_{yy} + 2 A_{xy}B_{xy}$. Apply the deviatoric projection consistently to the tensors constructed from the Germano identity and from the model so that the isotropic part does not contaminate the least-squares estimate.\n\nYour program must compute the field $C_s^2(\\mathbf{x})$ for each of the following test cases and return the spatial average of $C_s^2$ over the whole grid for each case. All quantities are nondimensional. Use $N = 32$, $\\Delta = 1$, $\\hat{\\Delta} = 2$, a $3 \\times 3$ box filter for the test filter, and a $3 \\times 3$ box for localized averaging when that option is selected. Use a regularization threshold $\\varepsilon = 10^{-12}$ for denominators that approach zero in the least-squares formula.\n\nTest suite:\n- Case $\\mathrm{A}$ (smooth shear wave; clipping): $u(x,y) = U_0 \\sin\\left(2\\pi y / L\\right)$, $v(x,y) = 0$, with $U_0 = 1$. Use the clipping strategy for negativity handling.\n- Case $\\mathrm{B}$ (Taylor–Green vortex; localized averaging): $u(x,y) = U_0 \\sin\\left(2\\pi x / L\\right)\\cos\\left(2\\pi y / L\\right)$, $v(x,y) = -U_0 \\cos\\left(2\\pi x / L\\right)\\sin\\left(2\\pi y / L\\right)$, with $U_0 = 1$. Use the localized averaging strategy.\n- Case $\\mathrm{C}$ (noisy vortex; localized averaging): same base field as Case $\\mathrm{B}$ but add zero-mean random perturbations of amplitude $A_n = 0.05$ to both components, i.e., $u \\leftarrow u + \\eta_u$, $v \\leftarrow v + \\eta_v$ where $\\eta_u$ and $\\eta_v$ are independent and identically distributed on $\\left[-A_n, A_n\\right]$. Use the localized averaging strategy. Use a fixed pseudorandom seed so the result is deterministic.\n\nImplementation details to respect:\n- Use periodic boundary conditions for all differences and filtering.\n- Use centered finite differences for $\\partial_x$ and $\\partial_y$.\n- Use the deviatoric parts of the tensors in the least-squares estimate.\n- Use the double contraction consistent with two-dimensional symmetry.\n- For localized averaging, average the numerator and denominator separately with the same $3 \\times 3$ box before forming their ratio.\n\nYour program should produce a single line of output containing the three spatially averaged values of $C_s^2$ for Cases $\\mathrm{A}$, $\\mathrm{B}$, and $\\mathrm{C}$, respectively, as a comma-separated list enclosed in square brackets (e.g., $\\left[ r_1, r_2, r_3 \\right]$). The outputs are nondimensional real numbers. Round each reported value to $6$ decimal places in the printed result.",
            "solution": "This problem requires the derivation and implementation of an algorithm to calculate the dynamic Smagorinsky coefficient, $C_s^2$.\nFirst, we define the context. In Large Eddy Simulation (LES), the velocity field $\\mathbf{u}$ is decomposed into a resolved (grid-scale) part, which we denote as $\\mathbf{u}$ in this problem context, and an unresolved (subgrid-scale) part. The effect of the subgrid scales on the resolved scales appears as a subgrid-scale (SGS) stress tensor, $\\tau_{ij}$. The Smagorinsky model provides a closure for this term. For an incompressible flow, the deviatoric part of the SGS stress is modeled as:\n$$\n\\tau_{ij}^{\\mathrm{dev}} = -2 \\nu_{SGS} S_{ij} = -2 (C_s \\Delta)^2 |S| S_{ij}\n$$\nwhere $C_s$ is the Smagorinsky coefficient, $\\Delta$ is the grid filter width, $S_{ij} = \\frac{1}{2}(\\partial_j u_i + \\partial_i u_j)$ is the resolved strain-rate tensor, and $|S| = \\sqrt{2 S_{kl} S_{kl}}$ is the strain-rate magnitude.\n\nThe dynamic procedure, proposed by Germano et al. (1991), avoids choosing a constant value for $C_s$ by calculating it dynamically from the resolved velocity field. This is achieved by introducing a second, wider \"test\" filter, with width $\\hat{\\Delta} > \\Delta$, denoted by a tilde accent ($\\widetilde{\\cdot}$). The core of the procedure is the Germano identity, which relates the stress arising from scales between $\\Delta$ and $\\hat{\\Delta}$ to the SGS stresses at these two scales:\n$$\nL_{ij} = T_{ij} - \\widetilde{\\tau_{ij}}\n$$\nHere, $L_{ij} = \\widetilde{u_i u_j} - \\widetilde{u_i}\\widetilde{u_j}$ is the Leonard stress tensor, representing the resolved turbulent stresses at the test-filter scale. $T_{ij}$ is the SGS stress at the test-filter scale, and $\\widetilde{\\tau_{ij}}$ is the filtered SGS stress from the grid scale.\n\nAssuming the Smagorinsky model holds at both scales with the same coefficient $C_s$, we have:\n$$\nT_{ij} = -2 (C_s \\hat{\\Delta})^2 |\\widetilde{S}| \\widetilde{S}_{ij}\n$$\n$$\n\\tau_{ij} = -2 (C_s \\Delta)^2 |S| S_{ij}\n$$\nwhere $\\widetilde{S}_{ij}$ is the strain-rate tensor computed from the test-filtered velocity field $\\widetilde{u}_i$. Substituting these into the Germano identity and assuming $C_s$ is locally constant such that it can be taken outside the filter operation ($\\widetilde{C_s^2} \\approx C_s^2$), we get:\n$$\nL_{ij} = C_s^2 M_{ij}\n$$\nwhere the model tensor $M_{ij}$ is defined as:\n$$\nM_{ij} = 2 \\left( \\Delta^2 \\widetilde{|S| S_{ij}} - \\hat{\\Delta}^2 |\\widetilde{S}| \\widetilde{S}_{ij} \\right)\n$$\nThis equation is a tensor identity for the single scalar unknown $C_s^2$ at each point in the domain. To solve for $C_s^2$, we minimize the squared error $e_{ij} e_{ij} = (L_{ij} - C_s^2 M_{ij})(L_{ij} - C_s^2 M_{ij})$ in a least-squares sense. As specified, this minimization should be applied to the deviatoric parts of the tensors to remain consistent with the model's formulation for deviatoric stresses. The deviatoric part of a tensor $A_{ij}$ in $d=2$ dimensions is $A_{ij}^{\\mathrm{dev}} = A_{ij} - \\frac{1}{2}\\operatorname{tr}(A)\\delta_{ij}$. The least-squares minimization $\\partial/\\partial(C_s^2) \\left[ (L_{ij}^{\\mathrm{dev}} - C_s^2 M_{ij}^{\\mathrm{dev}})(L_{ij}^{\\mathrm{dev}} - C_s^2 M_{ij}^{\\mathrm{dev}}) \\right] = 0$ yields the solution:\n$$\nC_s^2 = \\frac{L_{ij}^{\\mathrm{dev}} M_{ij}^{\\mathrm{dev}}}{M_{kl}^{\\mathrm{dev}} M_{kl}^{\\mathrm{dev}}}\n$$\nThe tensor contraction $A_{ij}B_{ij}$ for symmetric $2\\mathrm{D}$ tensors is $A_{xx}B_{xx} + A_{yy}B_{yy} + 2A_{xy}B_{xy}$.\n\nThe resulting field of $C_s^2$ can have negative values, which are unphysical for the purely dissipative Smagorinsky model. The problem specifies two methods for handling this:\n1.  **Clipping**: Any negative value of $C_s^2$ is simply set to zero, i.e., $C_s^2 \\leftarrow \\max(0, C_s^2)$.\n2.  **Localized Averaging**: To improve stability, the numerator $N_{LS} = L_{ij}^{\\mathrm{dev}} M_{ij}^{\\mathrm{dev}}$ and denominator $D_{LS} = M_{kl}^{\\mathrm{dev}} M_{kl}^{\\mathrm{dev}}$ are first computed locally, then averaged over a small stencil (a $3 \\times 3$ box filter). The coefficient is then computed as $C_s^2 = \\langle N_{LS} \\rangle / \\langle D_{LS} \\rangle$. A regularization threshold $\\varepsilon$ is used to prevent division by small numbers, and any resultant negative values are clipped to zero.\n\nThe algorithm is implemented numerically on a uniform periodic grid. Spatial derivatives are approximated using second-order centered finite differences with periodic boundary conditions. The grid and test filters are implemented as discrete box averages, also with periodic boundary conditions.\n\nThe overall algorithmic procedure for each test case is as follows:\n1.  Construct the $N \\times N$ grid and initialize the velocity components $u(x,y)$ and $v(x,y)$.\n2.  Compute all required spatial derivatives ($\\partial_x u, \\partial_y u, \\partial_x v, \\partial_y v$) using centered finite differences.\n3.  Compute the grid-scale strain-rate tensor components $S_{xx}, S_{yy}, S_{xy}$ and the strain-rate magnitude $|S|$.\n4.  Apply the $3 \\times 3$ box test filter to the velocity components ($u, v$) to get $\\widetilde{u}, \\widetilde{v}$, and to the required velocity products ($u^2, v^2, uv$) to get $\\widetilde{u^2}, \\widetilde{v^2}, \\widetilde{uv}$.\n5.  Compute the Leonard stress tensor components $L_{ij} = \\widetilde{u_i u_j} - \\widetilde{u_i}\\widetilde{u_j}$.\n6.  Compute the strain-rate tensor of the filtered field, $\\widetilde{S}_{ij}$, and its magnitude, $|\\widetilde{S}|$.\n7.  Apply the test filter to the products $|S|S_{ij}$.\n8.  Assemble the model tensor components $M_{ij} = 2(\\Delta^2\\widetilde{|S|S_{ij}} - \\hat{\\Delta}^2|\\widetilde{S}|\\widetilde{S}_{ij})$.\n9.  Compute the deviatoric parts $L_{ij}^{\\mathrm{dev}}$ and $M_{ij}^{\\mathrm{dev}}$.\n10. Calculate the numerator $N_{LS} = L_{ij}^{\\mathrm{dev}} M_{ij}^{\\mathrm{dev}}$ and denominator $D_{LS} = M_{ij}^{\\mathrm{dev}} M_{ij}^{\\mathrm{dev}}$ of the least-squares formula at every grid point.\n11. Apply the specified negativity handling procedure (clipping or localized averaging) to compute the final $C_s^2$ field.\n12. Calculate and store the spatial average of the resulting $C_s^2$ field.\nThis procedure is repeated for all three test cases to produce the final result.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the spatially averaged dynamic Smagorinsky coefficient C_s^2\n    for three test cases according to the problem specification.\n    \"\"\"\n    N = 32\n    DELTA = 1.0\n    HAT_DELTA = 2.0\n    U0 = 1.0\n    AN = 0.05\n    EPSILON = 1e-12\n    \n    L = N * DELTA\n    x = np.arange(N) * DELTA\n    y = np.arange(N) * DELTA\n    xx, yy = np.meshgrid(x, y)\n\n    def centered_diff_y(field):\n        \"\"\"Computes centered finite difference in y (axis 0) with periodic BCs.\"\"\"\n        return (np.roll(field, -1, axis=0) - np.roll(field, 1, axis=0)) / (2 * DELTA)\n\n    def centered_diff_x(field):\n        \"\"\"Computes centered finite difference in x (axis 1) with periodic BCs.\"\"\"\n        return (np.roll(field, -1, axis=1) - np.roll(field, 1, axis=1)) / (2 * DELTA)\n\n    def box_filter_3x3(field):\n        \"\"\"Applies a 3x3 box filter with periodic BCs.\"\"\"\n        filtered = np.zeros_like(field, dtype=np.float64)\n        for i in [-1, 0, 1]:\n            for j in [-1, 0, 1]:\n                filtered += np.roll(field, (i, j), axis=(0, 1))\n        return filtered / 9.0\n\n    def compute_cs2_field(u, v, negativity_handler):\n        \"\"\"Core logic to compute the C_s^2 field for a given velocity field.\"\"\"\n        # Step 2 & 3: Compute grid-scale strain-rate tensor and magnitude\n        dudx = centered_diff_x(u)\n        dudy = centered_diff_y(u)\n        dvdx = centered_diff_x(v)\n        dvdy = centered_diff_y(v)\n\n        S_xx = dudx\n        S_yy = dvdy\n        S_xy = 0.5 * (dudy + dvdx)\n        S_mag = np.sqrt(2 * (S_xx**2 + S_yy**2 + 2 * S_xy**2))\n\n        # Step 4: Apply test filter\n        u_filt = box_filter_3x3(u)\n        v_filt = box_filter_3x3(v)\n        uu_filt = box_filter_3x3(u * u)\n        uv_filt = box_filter_3x3(u * v)\n        vv_filt = box_filter_3x3(v * v)\n\n        # Step 5: Compute Leonard stress tensor L_ij\n        L_xx = uu_filt - u_filt**2\n        L_yy = vv_filt - v_filt**2\n        L_xy = uv_filt - u_filt * v_filt\n\n        # Step 6: Compute filtered strain-rate tensor and magnitude\n        du_filt_dx = centered_diff_x(u_filt)\n        du_filt_dy = centered_diff_y(u_filt)\n        dv_filt_dx = centered_diff_x(v_filt)\n        dv_filt_dy = centered_diff_y(v_filt)\n        \n        S_filt_xx = du_filt_dx\n        S_filt_yy = dv_filt_dy\n        S_filt_xy = 0.5 * (du_filt_dy + dv_filt_dx)\n        S_filt_mag = np.sqrt(2 * (S_filt_xx**2 + S_filt_yy**2 + 2 * S_filt_xy**2))\n\n        # Step 7 & 8: Assemble model tensor M_ij\n        # M_ij = 2 * (DELTA^2 * ~[|S|S_ij] - HAT_DELTA^2 * |~S|~S_ij)\n        term1_xx = DELTA**2 * box_filter_3x3(S_mag * S_xx)\n        term1_yy = DELTA**2 * box_filter_3x3(S_mag * S_yy)\n        term1_xy = DELTA**2 * box_filter_3x3(S_mag * S_xy)\n        \n        term2_xx = HAT_DELTA**2 * S_filt_mag * S_filt_xx\n        term2_yy = HAT_DELTA**2 * S_filt_mag * S_filt_yy\n        term2_xy = HAT_DELTA**2 * S_filt_mag * S_filt_xy\n        \n        M_xx = 2 * (term1_xx - term2_xx)\n        M_yy = 2 * (term1_yy - term2_yy)\n        M_xy = 2 * (term1_xy - term2_xy)\n\n        # Step 9: Compute deviatoric parts\n        L_tr = L_xx + L_yy\n        L_xx_dev = L_xx - 0.5 * L_tr\n        L_yy_dev = L_yy - 0.5 * L_tr\n        # L_xy is already deviatoric\n\n        M_tr = M_xx + M_yy\n        M_xx_dev = M_xx - 0.5 * M_tr\n        M_yy_dev = M_yy - 0.5 * M_tr\n        # M_xy is already deviatoric\n        \n        # Step 10: Calculate least-squares numerator and denominator\n        # N_LS = L_ij^dev * M_ij^dev, D_LS = M_ij^dev * M_ij^dev\n        num_ls = L_xx_dev * M_xx_dev + L_yy_dev * M_yy_dev + 2 * L_xy * M_xy\n        den_ls = M_xx_dev**2 + M_yy_dev**2 + 2 * M_xy**2\n\n        # Step 11: Apply negativity handling\n        cs2_field = np.zeros_like(u)\n        if negativity_handler == 'clipping':\n            mask = den_ls >= EPSILON\n            cs2_temp = np.zeros_like(den_ls)\n            cs2_temp[mask] = num_ls[mask] / den_ls[mask]\n            cs2_field = np.maximum(0, cs2_temp)\n        elif negativity_handler == 'localized_averaging':\n            num_ls_avg = box_filter_3x3(num_ls)\n            den_ls_avg = box_filter_3x3(den_ls)\n            mask = den_ls_avg >= EPSILON\n            cs2_temp = np.zeros_like(den_ls_avg)\n            cs2_temp[mask] = num_ls_avg[mask] / den_ls_avg[mask]\n            cs2_field = np.maximum(0, cs2_temp)\n        \n        return cs2_field\n\n    results = []\n    \n    # Case A: Shear wave, clipping\n    u_A = U0 * np.sin(2 * np.pi * yy / L)\n    v_A = np.zeros((N, N))\n    cs2_A = compute_cs2_field(u_A, v_A, 'clipping')\n    results.append(np.mean(cs2_A))\n\n    # Case B: Taylor-Green vortex, localized averaging\n    u_B = U0 * np.sin(2 * np.pi * xx / L) * np.cos(2 * np.pi * yy / L)\n    v_B = -U0 * np.cos(2 * np.pi * xx / L) * np.sin(2 * np.pi * yy / L)\n    cs2_B = compute_cs2_field(u_B, v_B, 'localized_averaging')\n    results.append(np.mean(cs2_B))\n\n    # Case C: Noisy Taylor-Green vortex, localized averaging\n    rng = np.random.default_rng(seed=42)\n    eta_u = rng.uniform(-AN, AN, (N, N))\n    eta_v = rng.uniform(-AN, AN, (N, N))\n    u_C = u_B + eta_u\n    v_C = v_B + eta_v\n    cs2_C = compute_cs2_field(u_C, v_C, 'localized_averaging')\n    results.append(np.mean(cs2_C))\n\n    print(f\"[{','.join(f'{r:.6f}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}