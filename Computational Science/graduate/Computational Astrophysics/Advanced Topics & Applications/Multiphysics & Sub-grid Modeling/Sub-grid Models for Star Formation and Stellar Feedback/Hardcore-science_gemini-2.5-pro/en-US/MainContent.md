## Introduction
Simulating the formation and evolution of galaxies is one of the paramount challenges in modern astrophysics. The difficulty arises from the immense range of physical scales involved, from the kiloparsec-scale structure of a galaxy down to the sub-parsec scales of individual star-forming clouds and the stars themselves. It is computationally impossible to resolve this entire [dynamic range](@entry_id:270472) simultaneously in a single simulation. This fundamental resolution barrier necessitates the use of **[sub-grid models](@entry_id:755588)**: physically motivated prescriptions that encapsulate the collective effects of unresolved processes, like star formation and the subsequent feedback from stars, and couple them to the resolved [gas dynamics](@entry_id:147692). These models are not mere numerical conveniences; they are the theoretical and computational bridges that make simulating galaxy formation a tractable problem.

This article delves into the core concepts underpinning these crucial tools of [computational astrophysics](@entry_id:145768). It is structured to guide you from foundational theory to practical application. The first chapter, **"Principles and Mechanisms"**, will lay out the physical and numerical motivations for [sub-grid models](@entry_id:755588), exploring concepts like the Jeans instability, the Truelove criterion, and the core recipes for converting gas into stars and modeling [stellar feedback](@entry_id:755431), including the infamous "overcooling problem." Following this, the chapter on **"Applications and Interdisciplinary Connections"** will demonstrate how these abstract principles are implemented in practice, connecting them to stellar evolution, thermodynamics, and data science, and examining the critical issue of [model validation](@entry_id:141140) and convergence. Finally, **"Hands-On Practices"** will present targeted problems that allow you to apply these concepts, solidifying your understanding of how microphysics shapes macroscopic galactic properties in simulations.

## Principles and Mechanisms

The vast dynamic range of spatial and temporal scales involved in galaxy formation presents a formidable challenge for numerical simulations. It is computationally prohibitive to resolve the evolution of an entire galaxy on kiloparsec scales while simultaneously capturing the physics of individual star formation and death on sub-parsec scales. Consequently, any simulation of galaxy formation or the large-scale [interstellar medium](@entry_id:150031) (ISM) must rely on **[sub-grid models](@entry_id:755588)**. These models are physically-motivated prescriptions that represent the collective effects of unresolved processes, such as star formation and [stellar feedback](@entry_id:755431), through source terms coupled to the resolved gas dynamics. This chapter elucidates the fundamental principles and common mechanisms that underpin these crucial components of modern [computational astrophysics](@entry_id:145768).

### The Necessity of Sub-Grid Models: The Resolution Barrier

The need for [sub-grid models](@entry_id:755588) is not merely a matter of convenience but a direct consequence of fundamental numerical limitations in simulating [self-gravitating fluids](@entry_id:754668). The core physical process leading to [star formation](@entry_id:160356) is the **Jeans instability**, whereby a sufficiently dense region of gas will collapse under its own gravity when its internal pressure can no longer resist the [gravitational force](@entry_id:175476).

The characteristic scale for this instability is the **Jeans length**, $\lambda_J$. For a uniform, isothermal, self-gravitating gas of density $\rho$ and sound speed $c_s$, [linear stability analysis](@entry_id:154985) yields the Jeans length as:
$$ \lambda_J = \sqrt{\frac{\pi c_s^2}{G\rho}} $$
where $G$ is the [gravitational constant](@entry_id:262704). Perturbations on scales larger than $\lambda_J$ are gravitationally unstable and will tend to collapse, while those on smaller scales are stabilized by pressure and propagate as sound waves.

In a grid-based hydrodynamics simulation, a critical numerical issue arises known as artificial fragmentation. If the grid resolution is too coarse to properly capture the pressure gradients that stabilize gas on scales smaller than $\lambda_J$, the simulation can produce spurious, grid-scale clumps that collapse unphysically. To prevent this, the Jeans length must be resolved by a minimum number of grid cells, $N_J$. This condition is known as the **Truelove criterion** , which states:
$$ \Delta x \le \frac{\lambda_J}{N_J} $$
where $\Delta x$ is the linear size of a grid cell. Typically, a value of $N_J \ge 4$ is required.

Consider a typical star-forming region within a galaxy, a molecular cloud with a temperature corresponding to a sound speed of $c_s = 0.2\,\mathrm{km\,s^{-1}}$ and a density of $\rho = 2\times 10^{-21}\,\mathrm{g\,cm^{-3}}$. The Jeans length in such a medium is approximately $\lambda_J \approx 1.0\,\mathrm{pc}$. If a galaxy simulation employs a grid with a resolution of $\Delta x = 0.5\,\mathrm{pc}$, the Truelove criterion requires $\Delta x \le 1.0\,\mathrm{pc} / 4 = 0.25\,\mathrm{pc}$. The simulation's resolution of $\Delta x = 0.5\,\mathrm{pc}$ violates this condition. As collapse proceeds, the density $\rho$ increases, causing $\lambda_J$ to shrink further, exacerbating the violation. The simulation is thus unable to correctly model the physics of gravitational collapse. This unavoidable failure to resolve the Jeans scale in large-volume simulations is the primary motivation for [sub-grid models](@entry_id:755588). We must replace the unresolved physics of collapse and subsequent [star formation](@entry_id:160356) with a prescription that captures its large-scale effects.

### Sub-Grid Star Formation: From Gas to Stars

#### Bridging the Scales: Sink and Star Particles

Once a region of gas is identified as gravitationally unstable and collapsing, we can no longer trust the grid-level hydrodynamics to follow its evolution. The standard approach is to introduce a special type of particle to represent the unresolved collapsing core and the stars that will form from it. This process often involves two distinct but related concepts: **[sink particles](@entry_id:754925)** and **star particles** .

A **sink particle** is a numerical tool designed to handle unresolved gravitational collapse. It is a Lagrangian [control volume](@entry_id:143882) that moves with the gas flow and accretes mass and momentum from the surrounding grid cells. To ensure that this accretion is physically motivated, a set of criteria must be met. For instance, a cell's gas may only be accreted if it is denser than a certain threshold, flowing towards the sink particle, and most importantly, gravitationally bound to it. The condition for being gravitationally bound is that the specific total energy of the gas—the sum of its specific kinetic, thermal, and [gravitational potential](@entry_id:160378) energies relative to the sink particle—must be negative. This prevents the sink from accreting unbound gas that is merely passing by. The implementation must be conservative: the mass and momentum removed from the gas on the grid must be precisely added to the sink particle, ensuring the total mass and momentum of the combined gas-plus-sink system are conserved.

Once a sink particle has accreted sufficient mass, or after a certain time, it is often converted into a **star particle**. A star particle is a collisionless object representing a **coeval simple stellar population (SSP)**—a collection of stars all born at the same time with a distribution of masses. Unlike a sink particle, a star particle does not typically accrete gas via [hydrodynamic interactions](@entry_id:180292). Its purpose is to act as a source of gravity and, crucially, to re-inject energy, momentum, and mass into the surrounding ISM through [sub-grid models](@entry_id:755588) of [stellar feedback](@entry_id:755431). It is the star particle that embodies the long-term impact of the formed stars.

#### Prescriptions for Star Formation

The decision of when and how quickly to convert gas into star particles is governed by a sub-grid **[star formation](@entry_id:160356) prescription** or "law". These prescriptions aim to connect the resolved properties of gas in a grid cell to the unresolved [star formation](@entry_id:160356) rate within that volume.

A widely used and physically intuitive model relates the star formation rate density, $\dot{\rho}_\star$, to the local gas density $\rho$ and the gravitational [free-fall time](@entry_id:261377), $t_{\rm ff} = \sqrt{3\pi/(32 G \rho)}$. The idea is that stars form from dense gas on a dynamical timescale, but not all of the gas is converted to stars in one go. The model introduces a dimensionless **efficiency per [free-fall time](@entry_id:261377)**, $\epsilon_{\rm ff}$, which is typically a few percent:
$$ \dot{\rho}_\star = \epsilon_{\rm ff} \frac{\rho}{t_{\rm ff}} $$
Substituting the expression for $t_{\rm ff}$, we find that this prescription implies a [star formation](@entry_id:160356) rate density that scales with the gas density to the 3/2 power: $\dot{\rho}_\star \propto \epsilon_{\rm ff} \rho^{3/2}$ .

This local, three-dimensional law provides a powerful theoretical bridge to understanding galaxy-scale empirical observations, such as the **Kennicutt-Schmidt (KS) relation**, which relates the [surface density](@entry_id:161889) of star formation, $\Sigma_{\rm SFR}$, to the gas [surface density](@entry_id:161889), $\Sigma$, as $\Sigma_{\rm SFR} \propto \Sigma^n$ with $n \approx 1.4$. The KS law is an emergent property averaged over kiloparsec scales. One can show that if we assume the gas in a galactic disk is a self-gravitating, isothermal slab in vertical hydrostatic equilibrium, integrating the volumetric $\rho^{3/2}$ law over the vertical [density profile](@entry_id:194142) yields a surface-density relation of $\Sigma_{\rm SFR} \propto \Sigma^2$ (assuming constant gas velocity dispersion). While not a perfect match to the observed $n \approx 1.4$, this demonstrates how local sub-grid physics can give rise to galaxy-scale [scaling relations](@entry_id:136850) .

Before this law can be applied, a simulation must first decide *which* gas is eligible to form stars. Several criteria are used:
*   **Density Threshold:** The simplest approach is to permit star formation only in gas cells with a number density $n$ above a fixed threshold, $n_{\rm th}$. For example, one might set $n_{\rm th} = 100\,\mathrm{cm}^{-3}$ . This method is easy to implement but can be unphysical.
*   **Virial/Boundness Criterion:** A more physically robust criterion is to assess whether a region of gas is gravitationally bound and likely to collapse. This can be quantified by the **virial parameter**, $\alpha_{\rm vir}$, defined as the ratio of twice the [internal kinetic energy](@entry_id:167806) to the magnitude of the gravitational potential energy. For a uniform spherical cloud of mass $M$, radius $R$, and one-dimensional velocity dispersion $\sigma$, it is given by:
$$ \alpha_{\rm vir} = \frac{5 \sigma^2 R}{G M} $$
Regions with $\alpha_{\rm vir} < 2$ are considered gravitationally bound and prone to collapse. This criterion has a significant advantage over a simple density threshold. For instance, a strong shock passing through the ISM can transiently compress gas to densities above $n_{\rm th}$, but this gas may be kinematically hot and unbound. A density threshold would trigger spurious [star formation](@entry_id:160356), whereas the virial criterion, by explicitly including the kinetic support term $\sigma^2$, would correctly identify the region as stable ($\alpha_{\rm vir} > 2$) and prevent [star formation](@entry_id:160356) .
*   **Molecular Gas-Based Criterion:** More sophisticated models recognize that stars form in cold, dense [molecular clouds](@entry_id:160702) where molecular hydrogen (H$_2$) is abundant. These models modify the [star formation](@entry_id:160356) law to depend on the local molecular gas fraction, $f_{\rm H_2}$:
$$ \dot{\rho}_\star = \epsilon_{\rm ff} \frac{f_{\rm H_2} \rho}{t_{\rm ff}} $$
The challenge then becomes computing $f_{\rm H_2}$ from resolved quantities. Models such as the **Krumholz-McKee-Tumlinson (KMT) model**  calculate $f_{\rm H_2}$ by balancing the formation rate of H$_2$ on dust grains with its destruction rate by interstellar UV photons. This equilibrium depends critically on shielding from the UV field, which is provided by dust and H$_2$ self-shielding. Both dust abundance and H$_2$ formation scale with the gas metallicity, $Z$, while the amount of shielding depends on the local gas column density, $N_{\rm H}$. In a simulation, $N_{\rm H}$ can be estimated from the local density and its gradient using a Sobolev-like approximation, $N_{\rm H} \approx \rho (\rho/|\nabla\rho|)$. The result is a physically rich model where [star formation](@entry_id:160356) is regulated not just by density, but by the local chemical and radiative environment.

### Sub-Grid Stellar Feedback: The Impact of Stars on Gas

Once formed, stars profoundly influence their surroundings by injecting energy, momentum, mass, and heavy elements into the ISM. This process, known as **[stellar feedback](@entry_id:755431)**, is essential for regulating [star formation](@entry_id:160356) and shaping galaxies.

#### The Initial Mass Function and Sampling

A single star particle represents an entire population of stars born with a range of masses. This distribution of stellar masses is described by the **Initial Mass Function (IMF)**. The IMF is often modeled as a power law, $\phi(m) \propto m^{-\alpha}$, where $\phi(m)\,dm$ is the number of stars with mass between $m$ and $m+dm$. For a star particle of total mass $M_\star$, the IMF must be normalized such that the total mass of all stars in the population equals $M_\star$.

The effects of this population can be implemented in two primary ways :
*   **Continuous Sampling:** This approach is deterministic. The feedback injected over a timestep is calculated from the *expected* number of events based on the IMF and stellar evolution theory. For instance, the expected number of core-collapse supernovae (CCSN) from stars with mass above a threshold $m_{\rm SN}$ is:
$$ \langle N_{\rm SN} \rangle = M_\star \frac{\int_{m_{\rm SN}}^{m_{\rm max}} m^{-\alpha} \,dm}{\int_{m_{\rm min}}^{m_{\rm max}} m^{1-\alpha} \,dm} $$
This number, which is generally not an integer, is used to compute a smooth, continuous rate of energy and momentum injection.
*   **Stochastic Sampling:** This approach is probabilistic. For each star particle, individual stellar masses are randomly drawn from the IMF until the total mass $M_\star$ is accumulated. The feedback is then realized as a series of [discrete events](@entry_id:273637) corresponding to the [massive stars](@entry_id:159884) that were actually drawn. This results in bursty, quantized feedback.

Continuous sampling is computationally efficient, but stochastic sampling is more physical, especially for low-mass star particles (e.g., in dwarf galaxies or individual star clusters) where the assumption of a fully-populated IMF breaks down. The presence or absence of a single very massive star can drastically alter the feedback, an effect that only stochastic sampling can capture. For events that can be modeled as a Poisson process with a mean number of events $\mu = \langle N_{\rm SN} \rangle$, the fractional root-mean-square fluctuation in the injected energy scales as $\mu^{-1/2}$, highlighting the large relative variance when the expected number of events is small .

#### Mechanisms of Stellar Feedback

A comprehensive feedback model includes multiple channels operating on different timescales.

**Pre-Supernova Feedback: Stellar Winds**
Before the most [massive stars](@entry_id:159884) explode as [supernovae](@entry_id:161773), all stars lose mass through [stellar winds](@entry_id:161386). These winds contribute to the pre-processing of the ISM. We distinguish two main types of winds from different evolutionary phases :
*   **OB Winds:** Hot, massive O- and B-type stars have powerful, fast winds driven by [radiation pressure](@entry_id:143156) on [spectral lines](@entry_id:157575) in their atmospheres (**line-driven**). These winds have high terminal velocities ($v_\infty \sim 1000-3000\,\mathrm{km\,s^{-1}}$) but moderate mass-loss rates.
*   **AGB Winds:** Cooler, evolved stars on the Asymptotic Giant Branch (AGB) have slow, dense winds. In their extended atmospheres, dust grains condense and are pushed out by [radiation pressure](@entry_id:143156), dragging the gas along (**dust-driven**). These winds have low terminal velocities ($v_\infty \sim 10-30\,\mathrm{km\,s^{-1}}$) but very high mass-loss rates.

In a sub-grid model, these winds are implemented by injecting mass, momentum, and energy into the surrounding gas cells at rates determined by stellar evolution models. For a wind with mass-loss rate $\dot{M}$ and terminal velocity $v_\infty$, the injection rates are:
*   Mass Rate: $\dot{M}_{\rm inj} = \dot{M}$
*   Momentum Rate: $\dot{p}_{\rm inj} = \dot{M} v_\infty$
*   Kinetic Energy Rate: $\dot{E}_{k, \rm inj} = \frac{1}{2} \dot{M} v_\infty^2$

A key result is that these two wind phases have very different impacts. The fast OB winds, despite their lower mass-loss rates, completely dominate the kinetic energy and momentum injection budget due to the $v_\infty$ and $v_\infty^2$ dependence. The slow AGB winds, in contrast, dominate the total mass returned to the ISM .

**Supernova Feedback: The Overcooling Problem and Its Solutions**
Core-collapse supernovae are the most energetic feedback events. A single SN releases roughly $10^{51}$ ergs of energy. Effectively coupling this energy to the ISM in a simulation is one of the most persistent challenges in the field, leading to the infamous **overcooling problem** .

The physical evolution of a [supernova](@entry_id:159451) remnant (SNR) begins with an energy-conserving phase, described by the **Sedov-Taylor [blast wave](@entry_id:199561) solution**. During this phase, the remnant expands adiabatically, converting the explosion's thermal energy into the kinetic energy of an expanding shell. This phase ends when radiative losses from the hot, shocked gas become significant, at which point the remnant transitions to a momentum-conserving "snowplow" phase. The transition occurs at a "cooling radius," $R_{\rm cool}$, which is typically a few to tens of parsecs.

In many galaxy simulations, the grid resolution $\Delta x$ is larger than $R_{\rm cool}$. If the entire $10^{51}$ ergs is deposited as thermal energy into a single unresolved grid cell, the density in that cell is artificially high. Radiative cooling rates scale strongly with density, so the high density leads to an extremely short cooling time. The injected energy is radiated away almost instantly, before it can perform the mechanical work ($P dV$) needed to drive a [blast wave](@entry_id:199561). The feedback has no dynamical effect. Several classes of [sub-grid models](@entry_id:755588) have been developed to circumvent this problem:
*   **Thermal Feedback:** The naive injection of thermal energy. As described, this model is only effective if the simulation has sufficient resolution to resolve the cooling radius ($\Delta x \ll R_{\rm cool}$) and the post-injection cooling time is longer than the local grid-scale expansion time. Otherwise, it fails due to overcooling.
*   **Kinetic Feedback:** Here, some or all of the SN energy is injected as kinetic energy, by applying "kicks" to the gas in neighboring cells. While this avoids immediate thermal losses at the injection site, it does not fully solve the problem. The high-velocity ejecta will inevitably shock against the ambient medium, converting kinetic energy back into thermal energy. This post-shock thermal energy is still subject to [radiative cooling](@entry_id:754014), so overcooling can still occur if the shock front is not well-resolved .
*   **Mechanical Feedback:** This is a true sub-grid model designed specifically for the unresolved case ($\Delta x > R_{\rm cool}$). Instead of attempting to model the Sedov-Taylor phase, it injects its net effect. Based on high-resolution simulations or analytic models, one can calculate the terminal momentum of an SNR shell at the end of its energy-conserving phase, $p_{\rm sf}(E_{\rm SN}, n_{\rm H})$. The mechanical feedback model simply injects this pre-calculated momentum directly into the grid cells surrounding the star particle. This approach bypasses the unresolved physics entirely, ensuring that the correct amount of momentum is coupled to the ISM.

### Validation and Convergence of Sub-Grid Models

Given the complexity of these models, it is essential to have methods for verifying their implementation and understanding their behavior as numerical parameters, like resolution, are changed.

#### Auditing the Energy and Momentum Budget

A crucial diagnostic is to track the flow of [conserved quantities](@entry_id:148503) like energy and momentum within the simulation. By defining a [control volume](@entry_id:143882) $V$ around a star-forming region, one can write an integral balance equation for the total gas energy, $E_{\rm gas} = \int_V (u + \frac{1}{2}\rho |\mathbf{v}|^2) dV$. The change in this energy over time must equal the sum of all sources, sinks, and fluxes :
$$ \Delta E_{\rm gas} = E_{\rm injected} - E_{\rm radiated} - E_{\rm flux} + W_{\rm grav} $$
where $E_{\rm injected}$ is the total energy injected by feedback sources, $E_{\rm radiated}$ is the energy lost to [radiative cooling](@entry_id:754014), $E_{\rm flux}$ is the net energy advected out of the volume, and $W_{\rm grav}$ is the work done by gravity on the gas.

All terms on the right-hand side represent the "expected" change based on the physical model. The term on the left is the "actual" change measured in the simulation. We can define a diagnostic ratio:
$$ \mathcal{R}_E = \frac{\Delta E_{\rm gas, actual}}{\Delta E_{\rm gas, expected}} $$
In a perfectly conservative numerical scheme, $\mathcal{R}_E=1$. If a simulation suffers from significant numerical overcooling, the actual energy increase will be much smaller than the net input from feedback minus physical losses, resulting in $\mathcal{R}_E \ll 1$. This provides a powerful tool for auditing the effectiveness of feedback implementation .

#### The Challenge of Convergence

The ultimate test for any [numerical simulation](@entry_id:137087) is **convergence**: does the solution approach a fixed, correct answer as the resolution is improved? For simulations with [sub-grid models](@entry_id:755588), this question is subtle.
*   **Strong Convergence** requires that the predicted physical quantities remain invariant as resolution increases while all sub-grid parameters are held fixed. This is the ideal, but it rarely occurs in galaxy formation simulations. As resolution improves, new physical scales are resolved; for instance, the gas can collapse to higher densities. This changes the input to the sub-grid model, which, with fixed parameters, will produce a different result (e.g., a higher star formation rate).
*   **Weak Convergence** is a more practical and achievable goal. It acknowledges that the sub-grid model itself may need to be adjusted with resolution. Weak convergence is achieved if one can obtain resolution-invariant results for macroscopic quantities (like the global star formation rate) by **rescaling sub-grid parameters** as a function of the resolution $\Delta x$ .

For example, if higher resolution leads to more gas reaching higher densities, causing the star formation rate to increase, one can achieve weak convergence by rescaling the efficiency parameter $\epsilon_{\rm ff}$ downwards to compensate. A more physically motivated approach is to rescale the star formation density threshold $\rho_{\rm th}$. By tying $\rho_{\rm th}$ to the Jeans resolution criterion (e.g., setting it to the density at which $\lambda_J = N_J \Delta x$), the threshold increases with resolution as $\rho_{\rm th} \propto (\Delta x)^{-2}$. This enforces a consistent physical condition for collapse across all resolutions and helps to stabilize the amount of star-forming gas, leading to a more convergent global [star formation](@entry_id:160356) rate . Understanding the distinction between [strong and weak convergence](@entry_id:140344) is paramount to correctly interpreting the results of simulations that rely on sub-grid physics.