{
    "hands_on_practices": [
        {
            "introduction": "为了防止在自引力气体的数值模拟中出现被称为“人工碎裂”的非物理性结果，必须确保局部金斯长度在网格上得到充分解析。这个基本要求，即著名的“特鲁洛夫判据”（Truelove criterion），直接为自适应网格加密（AMR）模拟中的最大可解析密度设定了一个上限。本练习 () 将通过一个实际的计算任务，指导您从第一性原理推导出这个密度极限，并将其与恒星形成模拟中引入“汇粒子”（sink particles）的技术联系起来。",
            "id": "3532043",
            "problem": "一个自引力恒星形成气体的自适应网格加密 (AMR) 模拟使用基于金斯长度的加密判据以防止人为碎裂，同时还使用一个激波捕捉判据，在出现强压缩跳跃的地方进行加密。考虑一个温度为 $T$、平均分子量为 $\\mu$ 的等温均匀介质，其中气体遵循等温声速的理想气体关系。AMR 代码强制要求每个局部金斯长度内至少有 $N_{\\rm target}$ 个单元用于加密，其最高加密等级达到最小单元间距 $\\Delta x_{\\min}$。为避免未解析的引力坍缩，一旦密度超过一个阈值，就需要创建汇粒子。该阈值被选为最精细层级上金斯长度判据所能解析的最大密度的 $\\alpha$ 倍。\n\n从均匀、等温、自引力介质的线性色散关系出发，\n$$\\omega^{2} = c_{s}^{2} k^{2} - 4\\pi G \\rho,$$\n其中 $c_{s}$ 是等温声速，$\\rho$ 是质量密度，$G$ 是引力常数，$k$ 是波数，推导出临界稳定性时的临界波数 $k_{J}$ 和对应的金斯长度 $\\lambda_{J}$。然后，利用 AMR 约束条件，即在最精细层级上，金斯长度必须由至少 $N_{\\rm target}$ 个单元解析，即\n$$\\Delta x_{\\min} \\le \\frac{\\lambda_{J}(\\rho_{\\max})}{N_{\\rm target}},$$\n求解以 $c_{s}$、$G$、$N_{\\rm target}$ 和 $\\Delta x_{\\min}$ 表示的可解析的最大密度 $\\rho_{\\max}$。最后，根据以下参数计算汇粒子形成密度 $\\rho_{\\rm sink} = \\alpha\\,\\rho_{\\max}$：\n- $T = 10\\,\\mathrm{K}$，\n- $\\mu = 2.33$，\n- $N_{\\rm target} = 32$，\n- $\\Delta x_{\\min} = 1\\,\\mathrm{AU}$，\n- $\\alpha = 4$。\n\n使用以下基本常数\n- $k_{B} = 1.380649\\times 10^{-16}\\,\\mathrm{erg\\,K^{-1}}$，\n- $m_{H} = 1.6735575\\times 10^{-24}\\,\\mathrm{g}$，\n- $G = 6.67430\\times 10^{-8}\\,\\mathrm{cm^{3}\\,g^{-1}\\,s^{-2}}$，\n以及单位换算\n- $1\\,\\mathrm{AU} = 1.495978707\\times 10^{13}\\,\\mathrm{cm}$。\n\n假设等温声速由理想气体关系式 $c_{s}=\\sqrt{k_{B}T/(\\mu m_{H})}$ 给出。将汇粒子形成密度的最终答案以 $\\mathrm{g\\,cm^{-3}}$ 为单位表示，并四舍五入到四位有效数字。",
            "solution": "首先将对问题陈述的科学合理性、完整性和清晰度进行验证。\n\n### 第一步：提取已知条件\n- **色散关系：** $\\omega^{2} = c_{s}^{2} k^{2} - 4\\pi G \\rho$，其中 $\\omega$ 是角频率，$c_s$ 是等温声速，$k$ 是波数，$G$ 是引力常数，$\\rho$ 是质量密度。\n- **AMR 加密判据：** $\\Delta x_{\\min} \\le \\frac{\\lambda_{J}(\\rho_{\\max})}{N_{\\rm target}}$，其中 $\\Delta x_{\\min}$ 是最小单元间距，$\\lambda_{J}(\\rho_{\\max})$ 是在可解析的最大密度 $\\rho_{\\max}$ 下计算的金斯长度，$N_{\\rm target}$ 是每个金斯长度的目标单元数。\n- **等温声速：** $c_{s}=\\sqrt{k_{B}T/(\\mu m_{H})}$，其中 $k_B$ 是玻尔兹曼常数，$T$ 是温度，$\\mu$ 是平均分子量，$m_H$ 是氢原子质量。\n- **汇粒子形成密度：** $\\rho_{\\rm sink} = \\alpha\\,\\rho_{\\max}$，其中 $\\alpha$ 是一个常数因子。\n- **参数：**\n    - 温度, $T = 10\\,\\mathrm{K}$\n    - 平均分子量, $\\mu = 2.33$\n    - 每个金斯长度的目标单元数, $N_{\\rm target} = 32$\n    - 最小单元间距, $\\Delta x_{\\min} = 1\\,\\mathrm{AU}$\n    - 汇粒子密度因子, $\\alpha = 4$\n- **常数：**\n    - 玻尔兹曼常数, $k_{B} = 1.380649\\times 10^{-16}\\,\\mathrm{erg\\,K^{-1}}$\n    - 氢原子质量, $m_{H} = 1.6735575\\times 10^{-24}\\,\\mathrm{g}$\n    - 引力常数, $G = 6.67430\\times 10^{-8}\\,\\mathrm{cm^{3}\\,g^{-1}\\,s^{-2}}$\n- **单位换算：** $1\\,\\mathrm{AU} = 1.495978707\\times 10^{13}\\,\\mathrm{cm}$\n\n### 第二步：使用提取的已知条件进行验证\n根据验证标准对问题进行评估。\n- **科学依据：** 该问题牢固地植根于引力不稳定性（金斯不稳定性）和计算天体物理学的原理。其色散关系是均匀、等温、自引力介质的标准色散关系。解析金斯长度的概念是引力坍缩模拟中防止人为碎裂的基本要求。使用汇粒子是此类模拟中的标准技术。所有概念都具有科学依据。\n- **良态的：** 提供了所有必要的参数、常数和控制方程。任务是推导一系列量并计算一个最终值，这是一个明确定义的数学过程。预期会有一个唯一的、稳定的解。\n- **客观性：** 问题陈述使用了精确的、定量的语言。没有主观或基于意见的陈述。\n- **完整性与一致性：** 问题是自洽的，并提供了计算所需的所有信息。单位已指定，物理设置是一致的。\n- **真实性：** 给定的参数值（$T = 10\\,\\mathrm{K}$，$\\mu = 2.33$ 等）对于致密分子云核（一个典型的恒星形成场所）来说是物理上真实的。加密判据和汇粒子处方是该领域的标准。\n\n该问题没有表现出验证清单中列出的任何缺陷，例如科学上不合理、模糊不清或自相矛盾。\n\n### 第三步：结论与行动\n该问题被判定为 **有效**。现在将提供一个完整的、有理有据的解答。\n\n推导从所给的均匀、等温、自引力介质的色散关系开始：\n$$ \\omega^{2} = c_{s}^{2} k^{2} - 4\\pi G \\rho $$\n当扰动可以增长时，即 $\\omega^2  0$ 时，会发生引力不稳定性。临界情况，即临界稳定性，发生在 $\\omega^2 = 0$ 时。发生这种情况时的波数是金斯波数 $k_J$。\n$$ 0 = c_{s}^{2} k_{J}^{2} - 4\\pi G \\rho $$\n$$ c_{s}^{2} k_{J}^{2} = 4\\pi G \\rho $$\n解出 $k_J^2$ 然后解出 $k_J$ 可得：\n$$ k_{J}^{2} = \\frac{4\\pi G \\rho}{c_{s}^{2}} \\implies k_{J} = \\sqrt{\\frac{4\\pi G \\rho}{c_{s}^{2}}} = \\frac{\\sqrt{4\\pi G \\rho}}{c_{s}} $$\n波数 $k  k_J$ 的扰动是不稳定的。\n\n金斯长度 $\\lambda_J$ 是对应于金斯波数的波长，定义为 $\\lambda_J = 2\\pi/k_J$。代入 $k_J$ 的表达式：\n$$ \\lambda_J = \\frac{2\\pi}{k_J} = 2\\pi \\frac{c_s}{\\sqrt{4\\pi G \\rho}} = \\frac{2\\pi c_s}{2\\sqrt{\\pi G \\rho}} = c_s \\sqrt{\\frac{\\pi}{G\\rho}} $$\n\nAMR 模拟必须解析局部的金斯长度。条件是在可解析的最大密度下，金斯长度 $\\lambda_J(\\rho_{\\max})$ 必须由至少 $N_{\\rm target}$ 个尺寸为 $\\Delta x_{\\min}$ 的单元覆盖。极限情况由等式给出：\n$$ \\Delta x_{\\min} = \\frac{\\lambda_{J}(\\rho_{\\max})}{N_{\\rm target}} \\implies N_{\\rm target} \\Delta x_{\\min} = \\lambda_{J}(\\rho_{\\max}) $$\n这表明在最高密度下，金斯长度正好由最精细网格上的 $N_{\\rm target}$ 个单元解析。我们代入在 $\\rho = \\rho_{\\max}$ 处计算的 $\\lambda_J$ 表达式：\n$$ N_{\\rm target} \\Delta x_{\\min} = c_s \\sqrt{\\frac{\\pi}{G\\rho_{\\max}}} $$\n为了求出可解析的最大密度 $\\rho_{\\max}$，我们对此方程求解。首先，我们将两边平方：\n$$ (N_{\\rm target} \\Delta x_{\\min})^2 = c_s^2 \\frac{\\pi}{G\\rho_{\\max}} $$\n重新整理以分离出 $\\rho_{\\max}$：\n$$ \\rho_{\\max} = \\frac{\\pi c_s^2}{G (N_{\\rm target} \\Delta x_{\\min})^2} = \\frac{\\pi}{G} \\left( \\frac{c_s}{N_{\\rm target} \\Delta x_{\\min}} \\right)^2 $$\n汇粒子形成密度定义为 $\\rho_{\\rm sink} = \\alpha\\,\\rho_{\\max}$。因此，$\\rho_{\\rm sink}$ 的最终符号表达式为：\n$$ \\rho_{\\rm sink} = \\alpha \\frac{\\pi}{G} \\left( \\frac{c_s}{N_{\\rm target} \\Delta x_{\\min}} \\right)^2 $$\n为了计算数值，我们首先使用给定的参数和常数计算等温声速的平方 $c_s^2$。所有单位都必须转换为一个一致的单位制，本例中为 CGS (厘米-克-秒) 单位制。\n\n声速由 $c_s = \\sqrt{k_B T / (\\mu m_H)}$ 给出。我们计算 $c_s^2$：\n- $T = 10\\,\\mathrm{K}$\n- $\\mu = 2.33$\n- $k_B = 1.380649 \\times 10^{-16}\\,\\mathrm{erg\\,K^{-1}} = 1.380649 \\times 10^{-16}\\,\\mathrm{g\\,cm^2\\,s^{-2}\\,K^{-1}}$\n- $m_H = 1.6735575 \\times 10^{-24}\\,\\mathrm{g}$\n$$ c_s^2 = \\frac{k_B T}{\\mu m_H} = \\frac{(1.380649 \\times 10^{-16}\\,\\mathrm{g\\,cm^2\\,s^{-2}\\,K^{-1}}) (10\\,\\mathrm{K})}{(2.33)(1.6735575 \\times 10^{-24}\\,\\mathrm{g})} $$\n$$ c_s^2 = \\frac{1.380649 \\times 10^{-15}}{3.900189975 \\times 10^{-24}}\\,\\mathrm{cm^2\\,s^{-2}} \\approx 3.5399534 \\times 10^8\\,\\mathrm{cm^2\\,s^{-2}} $$\n\n接下来，我们用 CGS 单位整合 $\\rho_{\\rm sink}$ 计算中的其他项：\n- $\\alpha = 4$\n- $G = 6.67430 \\times 10^{-8}\\,\\mathrm{cm^{3}\\,g^{-1}\\,s^{-2}}$\n- $N_{\\rm target} = 32$\n- $\\Delta x_{\\min} = 1\\,\\mathrm{AU} = 1.495978707 \\times 10^{13}\\,\\mathrm{cm}$\n\n现在，我们将这些数值代入 $\\rho_{\\rm sink}$ 的表达式中：\n$$ \\rho_{\\rm sink} = (4) \\frac{\\pi}{6.67430 \\times 10^{-8}\\,\\mathrm{cm^{3}\\,g^{-1}\\,s^{-2}}} \\left( \\frac{\\sqrt{3.5399534 \\times 10^8\\,\\mathrm{cm^2\\,s^{-2}}}}{(32)(1.495978707 \\times 10^{13}\\,\\mathrm{cm})} \\right)^2 $$\n使用包含 $c_s^2$ 的表达式更简单：\n$$ \\rho_{\\rm sink} = \\frac{4\\pi c_s^2}{G (N_{\\rm target} \\Delta x_{\\min})^2} $$\n让我们先计算分母：\n$$ (N_{\\rm target} \\Delta x_{\\min})^2 = \\left( 32 \\times 1.495978707 \\times 10^{13}\\,\\mathrm{cm} \\right)^2 $$\n$$ (4.7871318624 \\times 10^{14}\\,\\mathrm{cm})^2 \\approx 2.2916616 \\times 10^{29}\\,\\mathrm{cm^2} $$\n现在，完整的表达式为：\n$$ \\rho_{\\rm sink} = \\frac{4\\pi (3.5399534 \\times 10^8\\,\\mathrm{cm^2\\,s^{-2}})}{(6.67430 \\times 10^{-8}\\,\\mathrm{cm^{3}\\,g^{-1}\\,s^{-2}}) (2.2916616 \\times 10^{29}\\,\\mathrm{cm^2})} $$\n$$ \\rho_{\\rm sink} = \\frac{4.4484051 \\times 10^9\\,\\mathrm{cm^2\\,s^{-2}}}{1.5292833 \\times 10^{22}\\,\\mathrm{cm^5\\,g^{-1}\\,s^{-2}}} $$\n$$ \\rho_{\\rm sink} \\approx 2.90884 \\times 10^{-13}\\,\\mathrm{g\\,cm^{-3}} $$\n按要求，将结果四舍五入到四位有效数字，得到：\n$$ \\rho_{\\rm sink} \\approx 2.909 \\times 10^{-13}\\,\\mathrm{g\\,cm^{-3}} $$",
            "answer": "$$\\boxed{2.909 \\times 10^{-13}}$$"
        },
        {
            "introduction": "在许多天体物理场景中，引力坍缩和激波等流体动力学不稳定性同时存在，因此一个稳健的AMR方案必须能够同时响应这两种物理过程。本练习 () 将指导您超越单一判据，设计并实现一个混合加密算法，该算法结合了基于引力稳定性的金斯长度判据和基于气体压缩的激波探测器。通过这个实践，您将学习如何将物理洞察（例如，压缩时间尺度 $\\tau_{\\mathrm{comp}}$ 与声波穿越时间尺度 $\\tau_s$ 的比较）转化为具体的、可执行的数值逻辑。",
            "id": "3532010",
            "problem": "您的任务是为可压缩流体动力学中的自适应网格加密（AMR）设计并实现一个算法加密准则，该准则能够在对激波的加密与对不产生强跳跃的湍流压缩的加密之间取得平衡，同时通过金斯长度来保证对引力坍缩的解析。请在一维空间下进行，并假设气体为量热完全气体。单元的加密决策必须基于一个由守恒律推导出的激波/压缩探测器和一个由金斯准则推导出的引力稳定性探测器的组合。\n\n从以下基本基础开始：\n\n- 质量守恒定律意味着，对于速度为 $v(x,t)$ 的一维流动，其体积压缩率为 $-\\nabla\\cdot\\mathbf{v} = -\\partial v/\\partial x$。压缩时间尺度为 $ \\tau_{\\mathrm{comp}} = 1/|\\nabla\\cdot\\mathbf{v}| $。\n- 穿过宽度为 $\\Delta x$ 的计算单元的声学穿越时间为 $ \\tau_s = \\Delta x / c_s $，其中声速由 $ c_s = \\sqrt{\\gamma p/\\rho} $ 给出，$\\gamma$ 为绝热指数，$p$ 为压力，$\\rho$ 为质量密度。\n- 定义归一化压缩率 $ C = -\\Delta x\\,\\nabla\\cdot\\mathbf{v} / c_s $，它比较了压缩时间尺度与单元声学时间。\n- 对于理想气体中的平面正激波，朗金-雨贡纽关系意味着密度跳跃 $ r = \\rho_2/\\rho_1 $ 取决于上游马赫数 $ M_1 $，即 $ r(M_1,\\gamma) = \\dfrac{(\\gamma+1) M_1^2}{(\\gamma-1) M_1^2 + 2} $。一个具有物理意义的激波探测器应避免仅因产生可忽略跳跃的温和压缩而进行加密；一种形式化的方法是强制要求一个最小跳跃因子 $ r_{\\min} > 1 $。\n- 自引力气体的金斯长度为 $ \\lambda_J = c_s \\sqrt{\\pi/(G \\rho)} $，其中 $G$ 是引力常数。一个常见的分辨率规定是要求每个金斯长度至少有 $N_J$ 个单元，即如果 $ \\lambda_J  N_J \\Delta x $，则进行加密。\n\n您的推导任务：\n\n1. 仅使用上述定义和第一性原理，通过结合 $ C $、马赫数 $ M = |v|/c_s $ 和最小密度跳跃要求 $ r_{\\min} $，推导出一个有原则的激波/压缩加密阈值。解释为什么时间尺度平衡为 $ C $ 的阈值提供了动机，并根据朗金-雨贡纽关系推导马赫数的下界 $ M_{\\min}(r_{\\min},\\gamma) $，使得跳跃 $ r \\ge r_{\\min} $ 成立。\n\n2. 将此激波/压缩准则与金斯长度准则相结合，使得一个单元当且仅当满足以下至少一个条件时被标记为需要加密：\n   - 流动是汇聚的，即 $ \\nabla\\cdot\\mathbf{v}  0 $，并且您推导的激波/压缩阈值被满足。\n   - 金斯长度分辨率要求 $ \\lambda_J  N_J \\Delta x $ 被违反。\n\n实现任务：\n\n- 实现一个程序，为每个测试用例计算：\n  - 由 $ \\gamma $、$ p $ 和 $ \\rho $ 计算的声速 $ c_s $。\n  - 归一化压缩率 $ C $。\n  - 马赫数 $ M = |v|/c_s $。\n  - 金斯长度 $ \\lambda_J $。\n  - 对应于所需最小密度跳跃 $ r_{\\min} $ 的最小马赫数 $ M_{\\min}(r_{\\min},\\gamma) $。\n  - 基于上述组合准则的布尔类型加密决策。\n- 使用一维假设，因此速度的法向分量等于速率 $ |v| $，且 $ \\nabla\\cdot\\mathbf{v} $ 等于 $ \\partial v/\\partial x $。\n- 在所有测试用例中使用以下固定参数：\n  - 绝热指数 $ \\gamma = 5/3 $。\n  - 引力常数 $ G = 6.67430\\times 10^{-11}\\ \\mathrm{m^3\\,kg^{-1}\\,s^{-2}} $。\n  - 目标金斯分辨率 $ N_J = 32 $。\n  - 最小密度跳跃 $ r_{\\min} = 1.2 $。\n  - 由您的推导设定的归一化压缩率 $ C $ 的时间尺度平衡阈值。\n- 所有物理量必须在国际单位制（SI）中处理。报告最终的布尔加密标志，不带单位。\n\n测试套件：\n\n每个测试用例是一个元组 $(\\rho, p, v, \\nabla\\cdot\\mathbf{v}, \\Delta x)$，其值如下，所有值均采用国际单位制：\n\n1. 案例A（强压缩类激波流）：$(\\rho, p, v, \\nabla\\cdot\\mathbf{v}, \\Delta x) = (1\\times 10^{-19}\\ \\mathrm{kg\\,m^{-3}},\\ 5.4\\times 10^{-13}\\ \\mathrm{Pa},\\ 9.0\\times 10^{3}\\ \\mathrm{m\\,s^{-1}},\\ -6.0\\times 10^{-12}\\ \\mathrm{s^{-1}},\\ 1.0\\times 10^{15}\\ \\mathrm{m})$。\n2. 案例B（亚音速压缩，温和）：$(1\\times 10^{-19},\\ 5.4\\times 10^{-13},\\ 1.5\\times 10^{3},\\ -9.0\\times 10^{-13},\\ 1.0\\times 10^{15})$。\n3. 案例C（临界超音速，慢速压缩）：$(1\\times 10^{-19},\\ 5.4\\times 10^{-13},\\ 3.3\\times 10^{3},\\ -2.4\\times 10^{-12},\\ 1.0\\times 10^{15})$。\n4. 案例D（通过金斯准则的引力加密）：$(1\\times 10^{-14},\\ 2.4\\times 10^{-10},\\ 1.0\\times 10^{2},\\ 0.0,\\ 1.0\\times 10^{15})$。\n5. 案例E（热气体，亚音速压缩）：$(1\\times 10^{-20},\\ 2.4\\times 10^{-10},\\ 1.0\\times 10^{5},\\ -1.0\\times 10^{-11},\\ 1.0\\times 10^{15})$。\n6. 案例F（膨胀）：$(1\\times 10^{-19},\\ 5.4\\times 10^{-13},\\ 3.0\\times 10^{3},\\ +5.0\\times 10^{-12},\\ 1.0\\times 10^{15})$。\n\n您的程序应生成单行输出，其中包含上述案例的六个布尔加密决策，形式为方括号内以逗号分隔的列表（例如， $[{\\rm True},{\\rm False},\\dots]$）。不应打印任何其他文本。布尔值必须精确反映您推导的阈值和组合准则。",
            "solution": "我们从第一性原理和经过充分检验的公式出发，推导一个平衡的加密阈值，该阈值能够区分激波和良性压缩，并强制执行引力解析。\n\n基于时间尺度的压缩归一化：\n\n- 一维流动的体积压缩率为 $ -\\nabla\\cdot\\mathbf{v} = -\\partial v/\\partial x $，相关的压缩时间尺度为 $ \\tau_{\\mathrm{comp}} = 1/|\\nabla\\cdot\\mathbf{v}| $。\n- 穿过宽度为 $ \\Delta x $ 的单元的声学穿越时间为 $ \\tau_s = \\Delta x / c_s $，其中 $ c_s = \\sqrt{\\gamma p/\\rho} $ 是绝热声速。\n- 归一化压缩率定义为\n$$\nC \\equiv -\\frac{\\Delta x\\,\\nabla\\cdot\\mathbf{v}}{c_s} = \\frac{\\tau_s}{\\tau_{\\mathrm{comp}}}.\n$$\n- 物理解释：当 $ C \\gtrsim 1 $ 时，压缩时间尺度短于或可比于声音穿越单元的时间，表明流体压缩的速度快于信息通过声学方式在一个单元内传播的速度。这是类激波行为或离散化表示中初生不连续性的特征。相反，$ C \\ll 1 $ 表示相对于声学通信，压缩是缓慢的，这是平滑、近等熵运动（如亚音速湍流）的典型特征。\n\n因此，一个有原则的类激波压缩时间尺度阈值是 $ C \\ge \\theta $，其中 $ \\theta $ 的数量级为1。根据定义，最自然的选择是 $ \\theta = 1 $，这对应于 $ \\tau_{\\mathrm{comp}} \\le \\tau_s $。\n\n最小物理显著性跳跃：\n\n为了避免对不会产生剧烈状态变化的极弱激波或温和压缩进行加密，我们规定了穿过激波的最小密度跳跃 $ r_{\\min} > 1 $。对于理想气体中的平面正激波，朗金-雨贡纽密度比为\n$$\nr(M_1,\\gamma) = \\frac{\\rho_2}{\\rho_1} = \\frac{(\\gamma+1) M_1^2}{(\\gamma-1) M_1^2 + 2},\n$$\n其中 $ M_1 $ 是垂直于激波的上游马赫数。我们要求 $ r(M_1,\\gamma) \\ge r_{\\min} $。求解 $ M_1 $ 可得到产生至少指定跳跃所需的最小马赫数 $ M_{\\min} $：\n$$\nr_{\\min}\\left[(\\gamma-1) M_{\\min}^2 + 2\\right] = (\\gamma+1)M_{\\min}^2 \\quad\\Rightarrow\\quad\n\\left[(\\gamma+1) - r_{\\min}(\\gamma-1)\\right] M_{\\min}^2 = 2 r_{\\min}.\n$$\n假设 $ r_{\\min}  (\\gamma+1)/(\\gamma-1) $（这样右侧在物理上是可达的），我们得到\n$$\nM_{\\min}(r_{\\min},\\gamma) = \\sqrt{\\frac{2 r_{\\min}}{(\\gamma+1) - r_{\\min}(\\gamma-1)}}.\n$$\n这个下界确保了加密不会被那些根据激波跳跃条件不会产生至少 $ r_{\\min} $ 密度增加的压缩所触发。\n\n结合压缩时间尺度和跳跃显著性：\n\n在一维中，流动的法向分量等于速率 $ |v| $，因此马赫数为 $ M = |v|/c_s $。汇聚流具有 $ \\nabla\\cdot\\mathbf{v}  0 $。那么，激波/压缩加密准则为：\n- 汇聚：$ \\nabla\\cdot\\mathbf{v}  0 $。\n- 时间尺度主导：$ C \\equiv -\\Delta x\\,\\nabla\\cdot\\mathbf{v} / c_s \\ge \\theta $，其中 $ \\theta = 1 $。\n- 最小跳跃一致性：$ M = |v|/c_s \\ge M_{\\min}(r_{\\min},\\gamma) $。\n\n如果这三条都成立，则该单元因类激波压缩而被标记为需要加密。这在真激波和良性压缩之间取得了平衡，因为 (i) $ C \\ge 1 $ 过滤掉了慢速压缩，(ii) $ M \\ge M_{\\min} $ 过滤掉了近等熵的亚音速运动，甚至是那些不太可能产生强跳跃的极弱超音速压缩。\n\n金斯长度加密：\n\n对于引力坍缩，金斯长度是\n$$\n\\lambda_J = c_s \\sqrt{\\frac{\\pi}{G \\rho}}.\n$$\n特鲁洛夫类型的分辨率要求是在金斯长度没有被至少 $ N_J $ 个单元解析时进行加密：\n$$\n\\lambda_J  N_J \\Delta x.\n$$\n\n最终组合加密决策：\n\n一个单元在满足以下任一条件时进行加密：\n- 满足激波/压缩准则（汇聚、$ C \\ge 1 $ 和 $ M \\ge M_{\\min} $），或\n- 违反金斯准则（$ \\lambda_J  N_J \\Delta x $）。\n\n每个测试用例的算法步骤 $(\\rho, p, v, \\nabla\\cdot\\mathbf{v}, \\Delta x)$:\n\n1. 计算 $ c_s = \\sqrt{\\gamma p/\\rho} $。\n2. 计算 $ C = -\\Delta x\\,\\nabla\\cdot\\mathbf{v} / c_s $。\n3. 计算 $ M = |v|/c_s $。\n4. 计算 $ \\lambda_J = c_s \\sqrt{\\pi/(G\\rho)} $。\n5. 使用上面的封闭形式表达式计算 $ M_{\\min}(r_{\\min},\\gamma) $。如果 $ r_{\\min} \\ge (\\gamma+1)/(\\gamma-1) $，则设置 $ M_{\\min} \\to +\\infty $ 以确保不会出现错误的加密；这里 $ r_{\\min} = 1.2 $ 和 $ \\gamma = 5/3 $ 会给出一个有限值。\n6. 定义布尔标志：\n   - $ \\mathrm{shock\\_refine} = (\\nabla\\cdot\\mathbf{v}  0) \\land (C \\ge 1) \\land (M \\ge M_{\\min}) $。\n   - $ \\mathrm{jeans\\_refine} = (\\lambda_J  N_J \\Delta x) $。\n   - $ \\mathrm{refine} = \\mathrm{shock\\_refine} \\lor \\mathrm{jeans\\_refine} $。\n\n在测试套件上的评估：\n\n- 案例A：$ \\rho = 1\\times 10^{-19} $，$ p = 5.4\\times 10^{-13} $，$ v = 9.0\\times 10^{3} $，$ \\nabla\\cdot\\mathbf{v} = -6.0\\times 10^{-12} $，$ \\Delta x = 1.0\\times 10^{15} $。当 $ \\gamma = 5/3 $ 时，$ c_s = 3.0\\times 10^{3} $，所以 $ M = 3.0 $，$ C = 2.0 \\ge 1 $，满足汇聚条件，且 $ M_{\\min}(1.2,5/3) \\approx 1.135 $。金斯长度 $ \\lambda_J \\approx 2.06\\times 10^{18} $ 远大于 $ N_J \\Delta x = 3.2\\times 10^{16} $。因激波而加密：${\\rm True}$。\n- 案例B：$ M = 0.5 $，$ C = 0.3  1 $。无激波加密；金斯长度被很好地解析。${\\rm False}$。\n- 案例C：$ M \\approx 1.1  M_{\\min} $，$ C = 0.8  1 $。${\\rm False}$。\n- 案例D：稠密、冷气体：$ c_s = 2.0\\times 10^{2} $，$ \\lambda_J \\approx 4.34\\times 10^{14}  3.2\\times 10^{16} $。金斯准则触发加密。${\\rm True}$。\n- 案例E：热气体，亚音速温和压缩：$ C \\approx 0.05  1 $，$ M = 0.5 $。不加密。${\\rm False}$。\n- 案例F：膨胀：$ \\nabla\\cdot\\mathbf{v} > 0 $。无激波加密；金斯长度被很好地解析。${\\rm False}$。\n\n最终程序实现了这些计算，并以要求的格式打印一个包含六个布尔值的单行列表。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef minimum_mach_from_density_jump(r_min: float, gamma: float) - float:\n    \"\"\"\n    Compute M_min such that the Rankine-Hugoniot density jump r(M,gamma) = r_min.\n    r(M,gamma) = ((gamma+1) M^2) / ((gamma-1) M^2 + 2)\n    Solve analytically for M^2.\n    If r_min is unphysical (= (gamma+1)/(gamma-1)), return +inf.\n    \"\"\"\n    if r_min  1.0:\n        return 0.0\n    if r_min == 1.0:\n        return 1.0\n    r_max = (gamma + 1.0) / (gamma - 1.0)\n    if r_min = r_max:\n        return np.inf\n    denom = (gamma + 1.0) - r_min * (gamma - 1.0)\n    m2 = 2.0 * r_min / denom\n    if m2  0.0:\n        return np.inf\n    return float(np.sqrt(m2))\n\ndef compute_sound_speed(rho: float, p: float, gamma: float) - float:\n    \"\"\"c_s = sqrt(gamma * p / rho)\"\"\"\n    return float(np.sqrt(gamma * p / rho))\n\ndef jeans_length(cs: float, rho: float, G: float) - float:\n    \"\"\"Jeans length: lambda_J = cs * sqrt(pi / (G * rho))\"\"\"\n    return float(cs * np.sqrt(np.pi / (G * rho)))\n\ndef refine_decision(case, gamma: float, G: float, N_J: int, r_min: float, theta_C: float) - bool:\n    \"\"\"\n    Decide refinement for one case.\n    case: tuple (rho, p, v, div_v, dx) with SI units.\n    gamma: adiabatic index\n    G: gravitational constant\n    N_J: target number of cells per Jeans length\n    r_min: minimum desired density jump across shocks\n    theta_C: threshold for normalized compression rate C\n    \"\"\"\n    rho, p, v, div_v, dx = case\n    cs = compute_sound_speed(rho, p, gamma)\n    # Normalized compression rate C = -dx * div_v / cs\n    C = -dx * div_v / cs\n    # Mach number in 1D (normal component equals |v|)\n    M = abs(v) / cs\n    # Jeans length\n    lam_J = jeans_length(cs, rho, G)\n    jeans_refine = lam_J  N_J * dx\n    # Minimum Mach consistent with minimum jump\n    M_min = minimum_mach_from_density_jump(r_min, gamma)\n    # Shock/compression refinement criterion\n    shock_refine = (div_v  0.0) and (C = theta_C) and (M = M_min)\n    return bool(jeans_refine or shock_refine)\n\ndef solve():\n    # Constants\n    gamma = 5.0 / 3.0  # adiabatic index\n    G = 6.67430e-11    # m^3 kg^-1 s^-2\n    N_J = 32           # cells per Jeans length\n    r_min = 1.2        # minimum density jump to consider significant\n    theta_C = 1.0      # timescale-balance threshold for normalized compression rate\n\n    # Define the test cases from the problem statement.\n    # Each tuple: (rho [kg/m^3], p [Pa], v [m/s], div_v [1/s], dx [m])\n    test_cases = [\n        (1.0e-19, 5.4e-13, 9.0e3, -6.0e-12, 1.0e15),   # Case A\n        (1.0e-19, 5.4e-13, 1.5e3, -9.0e-13, 1.0e15),   # Case B\n        (1.0e-19, 5.4e-13, 3.3e3, -2.4e-12, 1.0e15),   # Case C\n        (1.0e-14, 2.4e-10, 1.0e2,  0.0e0,   1.0e15),   # Case D\n        (1.e-20, 2.4e-10, 1.0e5, -1.0e-11, 1.0e15),   # Case E\n        (1.0e-19, 5.4e-13, 3.0e3,  5.0e-12, 1.0e15),   # Case F\n    ]\n\n    results = []\n    for case in test_cases:\n        result = refine_decision(case, gamma=gamma, G=G, N_J=N_J, r_min=r_min, theta_C=theta_C)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```"
        },
        {
            "introduction": "一个高效的AMR算法不仅要能探测到关键的物理特征，还必须能够忽略那些不影响动力学演化的次要结构，以避免不必要的计算开销。简单的激波探测器有时会被密度不连续但压力和速度连续的“接触间断”所误导，从而导致计算资源的浪费。本高级练习 () 将探讨如何设计一个更智能的加密指标，它利用额外的物理信息（如密度梯度 $\\nabla\\rho$ 和速度矢量 $\\mathbf{v}$ 的对齐关系）来区分真实的激波和接触间断，从而显著提升模拟的效率和保真度。",
            "id": "3531996",
            "problem": "请在一维空间中实现一个自适应网格加密 (AMR) 决策逻辑，该逻辑使用基于物理的指标来区分真实激波和接触间断，并确保对自引力气体强制执行金斯长度判据。其目标是比较一个朴素的激波指示器（代表了分段抛物线方法 (PPM) 的趋势，会错误地加密接触间断）与一个受加权基本无振荡 (WENO) 方法启发的改进指示器。该改进指示器通过检查密度梯度和速度之间的对齐性来抑制在接触间断上的加密，同时保持对真实激波的敏感性。您必须生成一个完整的、可运行的程序，该程序在一套固定的测试集上评估这些指示器，并按下文规定输出聚合计数。\n\n从以下基本原理开始：\n\n- 质量守恒得出，压缩区域的特征是速度散度为负，即在一维情况下，$\\partial u / \\partial x  0$。\n- 激波具有有限的压力跳跃，而纯接触间断中不存在这种情况，纯接触间断的压力和速度是连续的，但密度是不连续的。\n- 金斯长度由 $L_J = c_s \\sqrt{\\pi / (G \\rho)}$ 给出，其中对于绝热指数为 $\\gamma$ 的理想气体，声速 $c_s = \\sqrt{\\gamma p / \\rho}$。为防止人为碎裂，需强制每个金斯长度内包含最小数量的单元格 $N_J$ (Truelove 判据)。\n\n您必须在宽度为 $\\Delta x$ 的均匀网格上，为一组给定的状态 $\\{\\rho_i, u_i, p_i\\}_{i=0}^{N-1}$ 实现以下 AMR 逻辑：\n\n1. 定义每个单元格 $i$ 的类 PPM 朴素激波标志为\n   $$\\mathcal{S}_i^{\\mathrm{naive}} = \\begin{cases}\n   1   \\text{如果 } \\left(\\frac{\\partial u}{\\partial x}\\right)_i  -\\tau_{\\mathrm{div}} \\ \\ \\text{或} \\ \\ \\frac{\\left| \\rho_{i+1} - \\rho_{i-1} \\right|}{\\max(\\rho_i, \\epsilon_\\rho)} > \\tau_\\rho,\\\\\n   0   \\text{否则},\n   \\end{cases}$$\n   其中在边界处使用单边差分，即对于 $i=0$ 使用 $\\left| \\rho_{1} - \\rho_{0} \\right|$，对于 $i=N-1$ 使用 $\\left| \\rho_{N-1} - \\rho_{N-2} \\right|$。速度导数 $\\left(\\partial u/\\partial x\\right)_i$ 必须在内部使用中心差分 $(u_{i+1} - u_{i-1})/(2\\Delta x)$，并在边缘使用单边差分。\n\n2. 定义每个单元格 $i$ 的抑制接触间断的改进激波标志为\n   $$\\mathcal{S}_i^{\\mathrm{imp}} = \\begin{cases}\n   1   \\text{如果 } \\left(\\frac{\\partial u}{\\partial x}\\right)_i  -\\tau_{\\mathrm{div}} \\ \\ \\text{并且} \\ \\ \\frac{\\left| p_{i+1} - p_{i-1} \\right|}{\\max(p_i, \\epsilon_p)} > \\tau_p \\ \\ \\text{并且} \\ \\ \\left|\\cos\\theta_i\\right| > \\tau_{\\cos},\\\\\n   0   \\text{否则},\n   \\end{cases}$$\n   其中对齐余弦为\n   $$\\cos\\theta_i = \\frac{\\left(\\frac{\\partial \\rho}{\\partial x}\\right)_i \\, u_i}{\\left(\\left|\\frac{\\partial \\rho}{\\partial x}\\right|_i + \\epsilon_g\\right)\\left(\\left|u_i\\right| + \\epsilon_u\\right)},$$\n   其中 $\\left(\\partial \\rho/\\partial x\\right)_i$ 在内部使用中心差分计算，在边界使用单边差分。压力跳跃在边界处使用与上述密度跳跃相同的单边约定。\n\n3. 定义每个单元格 $i$ 的金斯标志为\n   $$\\mathcal{J}_i = \\begin{cases}\n   1   \\text{如果 } \\dfrac{L_{J,i}}{\\Delta x}  N_J,\\\\\n   0   \\text{否则},\n   \\end{cases}$$\n   其中 $L_{J,i} = \\sqrt{\\gamma p_i / \\rho_i} \\, \\sqrt{\\pi / (G \\rho_i)}$。\n\n4. 定义每个单元格 $i$ 的最终 AMR 加密决策为\n   $$\\mathcal{R}_i = \\mathbb{I}\\left[ \\mathcal{S}_i^{\\mathrm{imp}} = 1 \\ \\ \\text{或} \\ \\ \\mathcal{J}_i = 1 \\right],$$\n   其中 $\\mathbb{I}[\\cdot]$ 表示指示函数。\n\n所有变量必须按以下物理单位处理：密度单位为 $\\mathrm{kg \\ m^{-3}}$，速度单位为 $\\mathrm{m \\ s^{-1}}$，压力单位为 $\\mathrm{Pa}$，单元格宽度单位为 $\\mathrm{m}$，引力常数单位为 $\\mathrm{m^3 \\ kg^{-1} \\ s^{-2}}$。按定义使用无角度的对齐余弦 $\\cos\\theta_i$。使用以下固定常数和阈值：\n- 绝热指数 $\\gamma = 1.4$，\n- 引力常数 $G = 6.67430 \\times 10^{-11} \\ \\mathrm{m^3 \\ kg^{-1} \\ s^{-2}}$，\n- 每个金斯长度的最小单元格数 $N_J = 8$，\n- 散度阈值 $\\tau_{\\mathrm{div}} = 100 \\ \\mathrm{s^{-1}}$，\n- 相对密度跳跃阈值 $\\tau_\\rho = 0.5$，\n- 相对压力跳跃阈值 $\\tau_p = 0.2$，\n- 对齐阈值 $\\tau_{\\cos} = 0.5$，\n- 数值下限 $\\epsilon_\\rho = 10^{-30} \\ \\mathrm{kg \\ m^{-3}}$，$\\epsilon_p = 10^{-30} \\ \\mathrm{Pa}$，$\\epsilon_g = 10^{-30}$，$\\epsilon_u = 10^{-30} \\ \\mathrm{m \\ s^{-1}}$。\n\n测试套件。在三个不同的一维 (1D) 场景上评估该逻辑，每个场景有 $N=8$ 个单元格：\n\n- 场景 A（具有类激波压缩的对撞流）：\n  - 单元格宽度 $\\Delta x = 1.0 \\ \\mathrm{m}$。\n  - 对于索引 $i \\in \\{0,1,2,3\\}$（左侧），设置 $\\rho_i = 1.0 \\ \\mathrm{kg \\ m^{-3}}$，$u_i = 300.0 \\ \\mathrm{m \\ s^{-1}}$，$p_i = 2.0 \\times 10^{5} \\ \\mathrm{Pa}$。\n  - 对于索引 $i \\in \\{4,5,6,7\\}$（右侧），设置 $\\rho_i = 0.2 \\ \\mathrm{kg \\ m^{-3}}$，$u_i = -300.0 \\ \\mathrm{m \\ s^{-1}}$，$p_i = 5.0 \\times 10^{4} \\ \\mathrm{Pa}$。\n\n- 场景 B（平流接触间断）：\n  - 单元格宽度 $\\Delta x = 1.0 \\ \\mathrm{m}$。\n  - 对于索引 $i \\in \\{0,1,2,3\\}$（左侧），设置 $\\rho_i = 1.0 \\ \\mathrm{kg \\ m^{-3}}$，$u_i = 100.0 \\ \\mathrm{m \\ s^{-1}}$，$p_i = 1.0 \\times 10^{5} \\ \\mathrm{Pa}$。\n  - 对于索引 $i \\in \\{4,5,6,7\\}$（右侧），设置 $\\rho_i = 0.2 \\ \\mathrm{kg \\ m^{-3}}$，$u_i = 100.0 \\ \\mathrm{m \\ s^{-1}}$，$p_i = 1.0 \\times 10^{5} \\ \\mathrm{Pa}$。\n\n- 场景 C（无激波的自引力等温核）：\n  - 单元格宽度 $\\Delta x = 1.0 \\times 10^{13} \\ \\mathrm{m}$。\n  - 令 $i \\in \\{0,1,2,3,4,5,6,7\\}$ 且 $x_i = i$（无单位索引位置）。定义一个具有峰值和基值的截断高斯密度分布：\n    $$\\rho_i = \\rho_{\\min} + \\left(\\rho_{\\mathrm{peak}} - \\rho_{\\min}\\right) \\exp\\left(-\\frac{(x_i - 3.5)^2}{2\\sigma^2}\\right),$$\n    其中 $\\rho_{\\mathrm{peak}} = 1.0 \\times 10^{-10} \\ \\mathrm{kg \\ m^{-3}}$，$\\rho_{\\min} = 1.0 \\times 10^{-13} \\ \\mathrm{kg \\ m^{-3}}$，以及 $\\sigma = 1.5$（无单位）。\n  - 对所有 $i$ 设置 $u_i = 0.0 \\ \\mathrm{m \\ s^{-1}}$。\n  - 设置压力，使声速在空间上恒定为 $c_s = 200.0 \\ \\mathrm{m \\ s^{-1}}$，即\n    $$p_i = \\frac{\\rho_i \\, c_s^2}{\\gamma}.$$\n\n离散算子。对内部点 $i \\in \\{1,\\dots,N-1\\}$ 的 $\\partial u/\\partial x$ 和 $\\partial \\rho/\\partial x$ 使用二阶中心差分，在 $i=0$ 和 $i=N-1$ 处使用一阶单边差分。对于相对跳跃 $|q_{i+1}-q_{i-1}|/\\max(q_i,\\epsilon_q)$，其中 $q \\in \\{\\rho,p\\}$，在 $i=0$ 处使用单边形式 $|q_{1}-q_{0}|/\\max(q_0,\\epsilon_q)$，在 $i=N-1$ 处使用 $|q_{N-1}-q_{N-2}|/\\max(q_{N-1},\\epsilon_q)$。\n\n输出规范。对于每个场景，计算四个整数：\n- 被朴素激波指示器标记的单元格总数，$\\sum_i \\mathcal{S}_i^{\\mathrm{naive}}$。\n- 被改进激波指示器标记的单元格总数，$\\sum_i \\mathcal{S}_i^{\\mathrm{imp}}$。\n- 被金斯判据标记的单元格总数，$\\sum_i \\mathcal{J}_i$。\n- 被最终逻辑标记为需要加密的单元格总数，$\\sum_i \\mathcal{R}_i$。\n\n您的程序应生成单行输出，其中包含一个由方括号括起来的、包含三个列表（每个场景一个）的逗号分隔列表。每个内部列表按 $[\\sum \\mathcal{S}^{\\mathrm{naive}}, \\sum \\mathcal{S}^{\\mathrm{imp}}, \\sum \\mathcal{J}, \\sum \\mathcal{R}]$ 的顺序排列。例如：“[[a,b,c,d],[e,f,g,h],[k,l,m,n]]”。所有值都必须是整数。不应打印任何其他文本。",
            "solution": "该问题要求实现一套用于一维空间中自适应网格加密 (AMR) 的判据，这套判据专为涉及自引力气体的计算天体物理学模拟而设计。该逻辑必须能够区分真实激波和接触间断，同时也要确保金斯长度得到充分解析。该过程涉及在一个均匀网格上逐个单元格地评估几个指示函数。\n\n网格由 $N$ 个单元格组成，每个单元格宽度为 $\\Delta x$，流体性质密度 $\\rho_i$、速度 $u_i$ 和压力 $p_i$ 定义在每个单元格 $i \\in \\{0, 1, \\dots, N-1\\}$ 的中心。所有计算都遵循指定的物理单位和常数。\n\n首先，我们严格按照问题陈述定义了空间导数和相对跳跃所需的离散算子。对于一个通用场 $f_i$，其空间导数 $(\\partial f / \\partial x)_i$ 对内部单元格使用二阶中心差分，对边界单元格使用一阶单边差分进行计算：\n$$\n\\left(\\frac{\\partial f}{\\partial x}\\right)_i = \\begin{cases}\n(f_{1} - f_{0}) / \\Delta x   \\text{如果 } i = 0 \\\\\n(f_{i+1} - f_{i-1}) / (2 \\Delta x)   \\text{如果 } i \\in \\{1, \\dots, N-2\\} \\\\\n(f_{N-1} - f_{N-2}) / \\Delta x   \\text{如果 } i = N-1\n\\end{cases}\n$$\n该格式应用于速度场 $u$ 和密度场 $\\rho$。\n\n对于量 $q \\in \\{\\rho, p\\}$ 的相对跳跃也定义了特定的边界处理方式：\n$$\n\\frac{\\Delta q_i}{q_i} = \\begin{cases}\n|q_{1} - q_{0}| / \\max(q_0, \\epsilon_q)   \\text{如果 } i = 0 \\\\\n|q_{i+1} - q_{i-1}| / \\max(q_i, \\epsilon_q)   \\text{如果 } i \\in \\{1, \\dots, N-2\\} \\\\\n|q_{N-1} - q_{N-2}| / \\max(q_{N-1}, \\epsilon_q)   \\text{如果 } i = N-1\n\\end{cases}\n$$\n其中 $\\epsilon_q$ 是一个很小的数值下限，以防止除以零。\n\n有了这些算子，我们就可以构建所需的 AMR 标志。\n\n1.  **朴素激波指示器 ($\\mathcal{S}^{\\mathrm{naive}}$)**：此指示器在检测到强压缩（大的负速度散度）或急剧的密度跳跃时，会标记一个单元格以进行加密。众所周知，这种方法过于激进，常常会标记稳定的接触间断。单元格 $i$ 的标志定义为：\n    $$\\mathcal{S}_i^{\\mathrm{naive}} = \\begin{cases}\n    1   \\text{如果 } \\left(\\frac{\\partial u}{\\partial x}\\right)_i  -\\tau_{\\mathrm{div}} \\ \\ \\text{或} \\ \\ \\frac{|\\Delta \\rho_i|}{\\rho_i} > \\tau_\\rho,\\\\\n    0   \\text{否则},\n    \\end{cases}$$\n    其中 $\\tau_{\\mathrm{div}} = 100 \\ \\mathrm{s^{-1}}$ 是散度阈值，$\\tau_\\rho = 0.5$ 是相对密度跳跃阈值。项 $|\\Delta \\rho_i|/\\rho_i$ 表示上面定义的相对跳跃算子。\n\n2.  **改进激波指示器 ($\\mathcal{S}^{\\mathrm{imp}}$)**：这个经过优化的指示器旨在抑制在接触间断处的加密。它要求同时满足三个条件：强压缩、显著的压力跳跃（理想接触间断中不存在）以及速度矢量与密度梯度之间的非正交对齐。对齐条件有助于区分密度特征的平流（此时速度平行于密度梯度）和激波（此时速度是反平行的）。单元格 $i$ 的标志为：\n    $$\\mathcal{S}_i^{\\mathrm{imp}} = \\begin{cases}\n    1   \\text{如果 } \\left(\\frac{\\partial u}{\\partial x}\\right)_i  -\\tau_{\\mathrm{div}} \\ \\ \\text{并且} \\ \\ \\frac{|\\Delta p_i|}{p_i} > \\tau_p \\ \\ \\text{并且} \\ \\ \\left|\\cos\\theta_i\\right| > \\tau_{\\cos},\\\\\n    0   \\text{否则},\n    \\end{cases}$$\n    这里，$\\tau_p = 0.2$ 是相对压力跳跃阈值，$\\tau_{\\cos} = 0.5$ 是对齐阈值。对齐余弦 $\\cos\\theta_i$ 由以下公式给出：\n    $$\\cos\\theta_i = \\frac{\\left(\\frac{\\partial \\rho}{\\partial x}\\right)_i \\, u_i}{\\left(\\left|\\frac{\\partial \\rho}{\\partial x}\\right|_i + \\epsilon_g\\right)\\left(\\left|u_i\\right| + \\epsilon_u\\right)}$$\n    这个带有小的数值下限 $\\epsilon_g$ 和 $\\epsilon_u$ 的公式可以稳健地处理梯度或速度为零的情况。\n\n3.  **金斯长度判据 ($\\mathcal{J}$)**：为防止人为的引力碎裂，数值模拟必须解析金斯长度，这是自引力流体变得不稳定的特征尺度。Truelove 判据要求金斯长度 $L_J$ 跨越最小数量的网格单元 $N_J$。单元格 $i$ 中的金斯长度为 $L_{J,i} = c_{s,i} \\sqrt{\\pi / (G \\rho_i)}$，其中声速为 $c_{s,i} = \\sqrt{\\gamma p_i / \\rho_i}$。如果违反此条件，则设置单元格 $i$ 的金斯标志：\n    $$\\mathcal{J}_i = \\begin{cases}\n    1   \\text{如果 } \\dfrac{L_{J,i}}{\\Delta x}  N_J,\\\\\n    0   \\text{否则},\n    \\end{cases}$$\n    其中 $N_J = 8$，引力常数 $G = 6.67430 \\times 10^{-11} \\ \\mathrm{m^3 \\ kg^{-1} \\ s^{-2}}$，绝热指数为 $\\gamma = 1.4$。\n\n4.  **最终加密决策 ($\\mathcal{R}$)**：如果改进的激波指示器或金斯判据被触发，则做出加密单元格的最终决定。指示函数 $\\mathbb{I}[\\cdot]$ 用于形式化这个逻辑或条件：\n    $$\\mathcal{R}_i = \\mathbb{I}\\left[ \\mathcal{S}_i^{\\mathrm{imp}} = 1 \\ \\ \\text{或} \\ \\ \\mathcal{J}_i = 1 \\right]$$\n\n实现将首先设置三个指定的测试场景。对于每个场景，定义物理状态向量 $\\{\\rho_i, u_i, p_i\\}$。然后，对每个单元格 $i=0, \\dots, N-1$，根据上述公式计算四个标志（$\\mathcal{S}_i^{\\mathrm{naive}}$、$\\mathcal{S}_i^{\\mathrm{imp}}$、$\\mathcal{J}_i$、$\\mathcal{R}_i$）。最后，通过对指示器值求和来确定每个判据标记的单元格总数：$\\sum_i \\mathcal{S}_i^{\\mathrm{naive}}$、$\\sum_i \\mathcal{S}_i^{\\mathrm{imp}}$、$\\sum_i \\mathcal{J}_i$ 和 $\\sum_i \\mathcal{R}_i$。然后将所有三个场景的这些总和汇总，以生成最终输出。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to implement the AMR decision logic, evaluate it on test cases,\n    and print the results in the specified format.\n    \"\"\"\n    # Fixed constants and thresholds\n    GAMMA = 1.4\n    G = 6.67430e-11\n    N_J = 8.0\n    TAU_DIV = 100.0\n    TAU_RHO = 0.5\n    TAU_P = 0.2\n    TAU_COS = 0.5\n    EPSILON_RHO = 1e-30\n    EPSILON_P = 1e-30\n    EPSILON_G = 1e-30\n    EPSILON_U = 1e-30\n\n    def compute_derivative(field, delta_x):\n        \"\"\"\n        Computes the spatial derivative of a 1D field with specified boundary conditions.\n        \"\"\"\n        n = len(field)\n        deriv = np.zeros(n)\n        if n  2:\n            return deriv\n\n        # Left boundary (i=0): first-order forward difference\n        deriv[0] = (field[1] - field[0]) / delta_x\n        \n        # Interior points (i=1 to n-2): second-order centered difference\n        for i in range(1, n - 1):\n            deriv[i] = (field[i+1] - field[i-1]) / (2.0 * delta_x)\n            \n        # Right boundary (i=n-1): first-order backward difference\n        if n > 1:\n            deriv[n-1] = (field[n-1] - field[n-2]) / delta_x\n        \n        return deriv\n\n    def run_scenario(rho, u, p, delta_x):\n        \"\"\"\n        Runs the AMR logic for a single scenario and returns the counts of flagged cells.\n        \"\"\"\n        n = len(rho)\n        \n        s_naive_flags = np.zeros(n, dtype=int)\n        s_imp_flags = np.zeros(n, dtype=int)\n        j_flags = np.zeros(n, dtype=int)\n        \n        du_dx = compute_derivative(u, delta_x)\n        drho_dx = compute_derivative(rho, delta_x)\n\n        for i in range(n):\n            # --- Naive Shock Flag (S_naive) ---\n            cond1_naive = du_dx[i]  -TAU_DIV\n            \n            if i == 0:\n                rho_jump_num = np.abs(rho[1] - rho[0])\n                rho_jump_den = max(rho[0], EPSILON_RHO)\n            elif i == n - 1:\n                rho_jump_num = np.abs(rho[n-1] - rho[n-2])\n                rho_jump_den = max(rho[n-1], EPSILON_RHO)\n            else:\n                rho_jump_num = np.abs(rho[i+1] - rho[i-1])\n                rho_jump_den = max(rho[i], EPSILON_RHO)\n\n            rel_rho_jump = rho_jump_num / rho_jump_den\n            cond2_naive = rel_rho_jump > TAU_RHO\n            \n            if cond1_naive or cond2_naive:\n                s_naive_flags[i] = 1\n\n            # --- Improved Shock Flag (S_imp) ---\n            cond1_imp = du_dx[i]  -TAU_DIV\n            \n            if i == 0:\n                p_jump_num = np.abs(p[1] - p[0])\n                p_jump_den = max(p[0], EPSILON_P)\n            elif i == n - 1:\n                p_jump_num = np.abs(p[n-1] - p[n-2])\n                p_jump_den = max(p[n-1], EPSILON_P)\n            else:\n                p_jump_num = np.abs(p[i+1] - p[i-1])\n                p_jump_den = max(p[i], EPSILON_P)\n                \n            rel_p_jump = p_jump_num / p_jump_den\n            cond2_imp = rel_p_jump > TAU_P\n\n            cos_theta_num = drho_dx[i] * u[i]\n            cos_theta_den = (np.abs(drho_dx[i]) + EPSILON_G) * (np.abs(u[i]) + EPSILON_U)\n            cos_theta = cos_theta_num / cos_theta_den if cos_theta_den != 0 else 0\n            cond3_imp = np.abs(cos_theta) > TAU_COS\n            \n            if cond1_imp and cond2_imp and cond3_imp:\n                s_imp_flags[i] = 1\n            \n            # --- Jeans Flag (J) ---\n            if rho[i] > 0:\n                # L_J = c_s * sqrt(pi / (G * rho))\n                # c_s = sqrt(gamma * p / rho)\n                # L_J^2 = (gamma * p / rho) * (pi / (G * rho))\n                l_j_sq = (GAMMA * p[i] * np.pi) / (G * rho[i]**2)\n                l_j = np.sqrt(l_j_sq)\n                if (l_j / delta_x)  N_J:\n                    j_flags[i] = 1\n\n        # --- Final Refinement Flag (R) ---\n        r_flags = np.logical_or(s_imp_flags, j_flags).astype(int)\n\n        return [\n            int(np.sum(s_naive_flags)),\n            int(np.sum(s_imp_flags)),\n            int(np.sum(j_flags)),\n            int(np.sum(r_flags))\n        ]\n\n    # --- Define Test Suite ---\n    N_CELLS = 8\n    test_cases = []\n\n    # Scenario A: Colliding flows\n    rho_A = np.zeros(N_CELLS)\n    u_A = np.zeros(N_CELLS)\n    p_A = np.zeros(N_CELLS)\n    rho_A[:4], u_A[:4], p_A[:4] = 1.0, 300.0, 2.0e5\n    rho_A[4:], u_A[4:], p_A[4:] = 0.2, -300.0, 5.0e4\n    dx_A = 1.0\n    test_cases.append((rho_A, u_A, p_A, dx_A))\n    \n    # Scenario B: Advected contact discontinuity\n    rho_B = np.zeros(N_CELLS)\n    u_B = np.zeros(N_CELLS)\n    p_B = np.zeros(N_CELLS)\n    rho_B[:4], u_B[:], p_B[:] = 1.0, 100.0, 1.0e5\n    rho_B[4:] = 0.2\n    dx_B = 1.0\n    test_cases.append((rho_B, u_B, p_B, dx_B))\n\n    # Scenario C: Self-gravitating isothermal core\n    dx_C = 1.0e13\n    rho_peak = 1.0e-10\n    rho_min = 1.0e-13\n    sigma = 1.5\n    cs_const = 200.0\n    \n    indices = np.arange(N_CELLS)\n    x_i = indices\n    rho_C = rho_min + (rho_peak - rho_min) * np.exp(-(x_i - 3.5)**2 / (2 * sigma**2))\n    u_C = np.zeros(N_CELLS)\n    p_C = (rho_C * cs_const**2) / GAMMA\n    test_cases.append((rho_C, u_C, p_C, dx_C))\n\n    # --- Run and collect results ---\n    all_results = []\n    for rho, u, p, dx in test_cases:\n        result = run_scenario(np.array(rho), np.array(u), np.array(p), dx)\n        all_results.append(result)\n\n    # --- Format and print output ---\n    output_str = \"[\" + \",\".join([f\"[{','.join(map(str, res))}]\" for res in all_results]) + \"]\"\n    print(output_str)\n\nsolve()\n```"
        }
    ]
}