{
    "hands_on_practices": [
        {
            "introduction": "在光滑粒子流体动力学（SPH）中，核函数是方法的基石，它决定了物理量如何在粒子间进行平滑。所有核函数都必须满足归一化条件，即其在整个空间上的积分为1。这个条件对于保证质量守恒和准确重现连续介质场的密度等物理量至关重要。本练习将通过对一个广泛应用的三维三次样条核函数进行积分，来推导其归一化常数，从而让您亲手验证这一基本属性。",
            "id": "3534778",
            "problem": "在三维光滑粒子流体动力学（SPH）中，光滑核函数 $W(\\mathbf{r},h)$ 需要满足非负、紧支集、径向对称以及归一化条件，使得其在全空间上的体积积分满足 $\\int W(\\mathbf{r},h)\\,d^{3}\\mathbf{r}=1$。考虑广泛使用的三次样条（也称为 $M_{4}$）核函数，其支撑半径为 $2h$，通过无量纲半径 $q=r/h$ 定义为\n$$\nW(r,h)=\\sigma\\,h^{-3}\\,f(q),\\quad q=\\frac{r}{h},\n$$\n其中分段函数 $f(q)$ 为\n$$\nf(q)=\\begin{cases}\n1-\\frac{3}{2}q^{2}+\\frac{3}{4}q^{3},  0 \\le q  1, \\\\\n\\frac{1}{4}(2-q)^{3},  1 \\le q  2, \\\\\n0,  q \\ge 2.\n\\end{cases}\n$$\n从归一化要求和合适的三维体积积分出发，推导归一化常数 $\\sigma$ 以确保 $\\int W(\\mathbf{r},h)\\,d^{3}\\mathbf{r}=1$。你的推导过程应仅使用基本原理（径向对称性、变量代换和归一化条件），并且必须明确地进行所有必要的积分。明确地验证所得到的核函数对于任意光滑长度 $h$ 都满足归一化条件。请以闭式解析表达式给出 $\\sigma$ 的最终答案。不需要数值近似，也不需要四舍五入。",
            "solution": "在三维空间中，球对称核函数的归一化条件是\n$$\n\\int_{\\mathbb{R}^{3}} W(\\mathbf{r},h)\\,d^{3}\\mathbf{r} \\;=\\; 4\\pi\\int_{0}^{\\infty} W(r,h)\\,r^{2}\\,dr \\;=\\; 1.\n$$\n给定 $W(r,h)=\\sigma\\,h^{-3}\\,f(q)$，其中 $q=r/h$，且对于 $q\\ge 2$ 有 $f(q)=0$，则该径向积分具有紧支集，并变为\n$$\n4\\pi\\int_{0}^{2h} \\sigma\\,h^{-3}\\,f\\!\\left(\\frac{r}{h}\\right)\\,r^{2}\\,dr.\n$$\n引入变量代换 $q=r/h$，则 $r=hq$ 且 $dr=h\\,dq$。于是 $r^{2}=h^{2}q^{2}$，积分变换为\n$$\n4\\pi\\int_{0}^{2} \\sigma\\,h^{-3}\\,f(q)\\,(h^{2}q^{2})\\,(h\\,dq)\n\\;=\\;\n4\\pi\\,\\sigma\\int_{0}^{2} f(q)\\,q^{2}\\,dq.\n$$\n因此，归一化条件简化为\n$$\n4\\pi\\,\\sigma\\int_{0}^{2} f(q)\\,q^{2}\\,dq \\;=\\; 1,\n$$\n所以\n$$\n\\sigma \\;=\\; \\frac{1}{4\\pi}\\left[\\int_{0}^{2} f(q)\\,q^{2}\\,dq\\right]^{-1}.\n$$\n我们现在通过在 $q=1$ 处拆分来计算积分 $I=\\int_{0}^{2} f(q)\\,q^{2}\\,dq$：\n$$\nI \\;=\\; \\int_{0}^{1} \\left(1-\\frac{3}{2}q^{2}+\\frac{3}{4}q^{3}\\right)q^{2}\\,dq\n\\;+\\;\n\\int_{1}^{2} \\frac{1}{4}(2-q)^{3} q^{2}\\,dq.\n$$\n计算第一个积分 $I_{1}$：\n$$\nI_{1} \\;=\\; \\int_{0}^{1}\\left(q^{2}-\\frac{3}{2}q^{4}+\\frac{3}{4}q^{5}\\right)\\,dq\n\\;=\\;\n\\left[\\frac{q^{3}}{3}-\\frac{3}{2}\\cdot\\frac{q^{5}}{5}+\\frac{3}{4}\\cdot\\frac{q^{6}}{6}\\right]_{0}^{1}\n\\;=\\;\n\\frac{1}{3}-\\frac{3}{10}+\\frac{1}{8}.\n$$\n通分后，可得\n$$\nI_{1} \\;=\\; \\frac{40}{120}-\\frac{36}{120}+\\frac{15}{120} \\;=\\; \\frac{19}{120}.\n$$\n通过展开被积函数来计算第二个积分 $I_{2}$：\n$$\n(2-q)^{3}=8-12q+6q^{2}-q^{3},\\quad\n\\frac{1}{4}(2-q)^{3}q^{2}\n=2q^{2}-3q^{3}+\\frac{3}{2}q^{4}-\\frac{1}{4}q^{5}.\n$$\n因此\n$$\nI_{2} \\;=\\; \\int_{1}^{2} \\left(2q^{2}-3q^{3}+\\frac{3}{2}q^{4}-\\frac{1}{4}q^{5}\\right)\\,dq\n\\;=\\;\n\\left[\\frac{2}{3}q^{3}-\\frac{3}{4}q^{4}+\\frac{3}{10}q^{5}-\\frac{1}{24}q^{6}\\right]_{1}^{2}.\n$$\n在 $q=2$ 处求值：\n$$\n\\frac{2}{3}\\cdot 8 - \\frac{3}{4}\\cdot 16 + \\frac{3}{10}\\cdot 32 - \\frac{1}{24}\\cdot 64\n\\;=\\;\n\\frac{16}{3} - 12 + \\frac{48}{5} - \\frac{8}{3}\n\\;=\\;\n\\frac{4}{15}.\n$$\n在 $q=1$ 处求值：\n$$\n\\frac{2}{3} - \\frac{3}{4} + \\frac{3}{10} - \\frac{1}{24}\n\\;=\\;\n\\frac{80}{120}-\\frac{90}{120}+\\frac{36}{120}-\\frac{5}{120}\n\\;=\\;\n\\frac{21}{120} \\;=\\; \\frac{7}{40}.\n$$\n因此\n$$\nI_{2} \\;=\\; \\frac{4}{15} - \\frac{7}{40}\n\\;=\\;\n\\frac{32}{120}-\\frac{21}{120}\n\\;=\\;\n\\frac{11}{120}.\n$$\n合并 $I_{1}$ 和 $I_{2}$：\n$$\nI \\;=\\; \\frac{19}{120}+\\frac{11}{120} \\;=\\; \\frac{30}{120} \\;=\\; \\frac{1}{4}.\n$$\n将 $I=\\frac{1}{4}$ 代入 $\\sigma$ 的表达式中：\n$$\n\\sigma \\;=\\; \\frac{1}{4\\pi}\\left(\\frac{1}{4}\\right)^{-1}\n\\;=\\;\n\\frac{1}{\\pi}.\n$$\n最后，明确地验证归一化：\n$$\n\\int W(\\mathbf{r},h)\\,d^{3}\\mathbf{r}\n\\;=\\;\n4\\pi\\,\\sigma\\int_{0}^{2} f(q)\\,q^{2}\\,dq\n\\;=\\;\n4\\pi\\cdot \\frac{1}{\\pi}\\cdot \\frac{1}{4}\n\\;=\\;\n1,\n$$\n该结果与光滑长度 $h$ 无关。因此，所求的归一化常数为 $\\sigma=\\frac{1}{\\pi}$。",
            "answer": "$$\\boxed{\\frac{1}{\\pi}}$$"
        },
        {
            "introduction": "选择合适的核函数不仅仅是数学上的考量，它对SPH模拟的稳定性和准确性有着深远的影响。一个重要的问题是“配对不稳定性”（pairing instability），它会导致粒子在没有物理原因的情况下发生聚集。本练习探讨了核函数的傅里叶谱特性与其在均匀粒子分布下抵抗配对不稳定性的能力之间的联系。通过定量分析，您将判断在给定的邻居数下，三次样条核与Wendland核哪一个更稳定，从而深刻理解理论性质如何直接转化为实际的模拟表现。",
            "id": "3534793",
            "problem": "在光滑粒子流体动力学 (SPH) 中，配对（或结团）不稳定性与光滑核在离散粒子晶格上可表示的波数处存在负谱功率有关。考虑一个在三维空间中、间距为 $\\Delta x$ 的简单立方晶格上的均匀、等质量粒子分布。光滑长度为 $h$，三次样条核（$M_{4}$ B样条）和 Wendland $C^{4}$ 核的紧支集半径均为 $\\kappa h$，其中 $\\kappa=2$。邻居数定义为 $N_{\\rm ngb} \\equiv n V_{\\rm supp}$，其中数密度为 $n$，支持体积为 $V_{\\rm supp}=\\frac{4}{3}\\pi (\\kappa h)^{3}$。对于简单立方晶格，奈奎斯特波为 $k_{N}=\\pi/\\Delta x$。对于等质量、均匀采样的构型，一个防止配对的充分谱稳定性判据是，核的径向傅里叶变换对于晶格上表示的所有波数 $k$ 都是非负的。等价地，如果核的径向傅里叶变换在 $k h = x_{c}$ 处首次变为负值，那么稳定性要求 $k_{N} h \\le x_{c}$。一个公认的性质是，三次样条核的三维径向傅里叶变换在 $k h = x_{c}=3.8317$（数值确定）处首次变为负值，而 Wendland $C^{4}$ 核在三维空间中对于所有 $k \\ge 0$ 的径向傅里叶变换都是非负的。\n\n给定目标邻居数 $N_{\\rm ngb}=64$，请仅使用上述基本定义，推导出无量纲谱覆盖参数 $k_{N} h$ 作为 $N_{\\rm ngb}$ 和 $\\kappa$ 的函数，计算其在 $\\kappa=2$ 和 $N_{\\rm ngb}=64$ 时的值，然后通过与 $x_{c}$ 进行定量比较，确定每个核在给定晶格上是否对配对稳定。\n\n以行矩阵 $\\bigl[s_{\\rm M4}\\;\\;s_{\\rm WC4}\\bigr]$ 的形式报告你的最终结果，其中 $s_{\\rm M4}$ 对应于三次样条 $M_{4}$ 核，$s_{\\rm WC4}$ 对应于 Wendland $C^{4}$ 核，使用的约定是：如果稳定，$s=1$；如果不稳定，$s=0$。无需单位。请提供唯一的最终答案。没有舍入要求；如果你选择提供中间数值估计，请将其四舍五入到四位有效数字，但最终矩阵的元素必须是精确整数。",
            "solution": "任务是通过首先推导和计算无量纲谱覆盖参数 $k_{N} h$，来确定三次样条核和 Wendland $C^4$ 核在给定构型下的稳定性。\n\n邻居数 $N_{\\rm ngb}$ 定义为数密度 $n$ 与核的支持体积 $V_{\\rm supp}$ 的乘积：\n$$N_{\\rm ngb} = n V_{\\rm supp}$$\n对于粒子间距为 $\\Delta x$ 的简单立方晶格，数密度是单位粒子体积 $V_{\\rm particle} = (\\Delta x)^3$ 的倒数。因此，\n$$n = \\frac{1}{(\\Delta x)^3}$$\n紧支集半径为 $\\kappa h$ 的球形核的支持体积为：\n$$V_{\\rm supp} = \\frac{4}{3}\\pi (\\kappa h)^3$$\n将这些表达式代入 $N_{\\rm ngb}$ 的定义中，得到：\n$$N_{\\rm ngb} = \\frac{1}{(\\Delta x)^3} \\left( \\frac{4}{3}\\pi (\\kappa h)^3 \\right) = \\frac{4\\pi\\kappa^3}{3} \\left( \\frac{h}{\\Delta x} \\right)^3$$\n我们希望求出无量纲谱覆盖参数 $k_N h$。晶格的奈奎斯特波数给定为 $k_N = \\pi / \\Delta x$。因此，该参数为：\n$$k_N h = \\left( \\frac{\\pi}{\\Delta x} \\right) h = \\pi \\left( \\frac{h}{\\Delta x} \\right)$$\n为了用 $N_{\\rm ngb}$ 和 $\\kappa$ 来表示它，我们首先重排 $N_{\\rm ngb}$ 的方程，以求解比率 $h/\\Delta x$：\n$$\\left( \\frac{h}{\\Delta x} \\right)^3 = \\frac{3 N_{\\rm ngb}}{4\\pi\\kappa^3}$$\n$$\\frac{h}{\\Delta x} = \\left( \\frac{3 N_{\\rm ngb}}{4\\pi\\kappa^3} \\right)^{1/3}$$\n现在，我们将此表达式代入 $k_N h$ 的方程中：\n$$k_N h = \\pi \\left( \\frac{3 N_{\\rm ngb}}{4\\pi\\kappa^3} \\right)^{1/3}$$\n通过将因子 $\\pi$ 移入立方根内，可以简化此式：\n$$k_N h = \\left( \\pi^3 \\frac{3 N_{\\rm ngb}}{4\\pi\\kappa^3} \\right)^{1/3} = \\left( \\frac{3\\pi^2 N_{\\rm ngb}}{4\\kappa^3} \\right)^{1/3}$$\n这就是谱覆盖参数 $k_N h$ 作为邻居数 $N_{\\rm ngb}$ 和支持半径参数 $\\kappa$ 的函数的一般表达式。\n\n我们现在针对给定的参数 $N_{\\rm ngb}=64$ 和 $\\kappa=2$ 计算此表达式的值：\n$$k_N h = \\left( \\frac{3\\pi^2 (64)}{4(2)^3} \\right)^{1/3} = \\left( \\frac{192\\pi^2}{4(8)} \\right)^{1/3} = \\left( \\frac{192\\pi^2}{32} \\right)^{1/3} = \\left( 6\\pi^2 \\right)^{1/3}$$\n为了进行稳定性分析，我们需要该值的数值估计。\n使用 $\\pi \\approx 3.14159$，我们有 $\\pi^2 \\approx 9.86960$。\n$$k_N h \\approx (6 \\times 9.86960)^{1/3} = (59.2176)^{1/3} \\approx 3.8978$$\n问题要求将任何中间数值估计四舍五入到四位有效数字，因此我们使用 $k_N h \\approx 3.8978$。\n\n稳定性判据是 $k_N h \\le x_c$，其中 $x_c$ 是核的傅里叶变换首次变为负值时的 $k h$ 值。我们分别分析每个核。\n\n1.  **三次样条 ($M_4$) 核：**\n    问题给出了临界值 $x_{c, M4} = 3.8317$。\n    我们必须将计算出的 $k_N h$ 与此值进行比较。\n    $$3.8978 > 3.8317$$\n    由于 $k_N h > x_{c, M4}$，稳定性判据被违反。这意味着可以在粒子晶格上表示的波数（特别是那些接近奈奎斯特极限的波数）落入了三次样条核的傅里叶变换为负的区域，从而导致配对不稳定性。\n    因此，三次样条核在此构型下是不稳定的。我们为其分配稳定性代码 $s_{\\rm M4}=0$。\n\n2.  **Wendland $C^4$ 核：**\n    问题指出，Wendland $C^4$ 核的径向傅里叶变换对于所有波数 $k \\ge 0$ 都是非负的。这意味着不存在有限的 $k$ 使其变换变为负值。因此，我们可以认为其临界值为无穷大，$x_{c, WC4} = \\infty$。\n    稳定性判据为：\n    $$k_N h  \\infty$$\n    我们计算出的值 $k_N h \\approx 3.8978$ 是一个有限数，因此该条件得到满足。\n    因此，Wendland $C^4$ 核在此构型下是稳定的。我们为其分配稳定性代码 $s_{\\rm WC4}=1$。\n\n最终结果是一个行矩阵，分别包含三次样条核（$s_{\\rm M4}$）和 Wendland $C^4$ 核（$s_{\\rm WC4}$）的稳定性代码。",
            "answer": "$$\\boxed{\\begin{pmatrix} 0  1 \\end{pmatrix}}$$"
        },
        {
            "introduction": "理论知识最终需要通过代码实现来转化为强大的模拟工具。本练习是连接SPH理论与计算实践的关键一步，要求您设计并执行一个收敛性研究，以评估SPH梯度算子的准确性。您将从零开始，在一个二维周期性域上实现粒子采样、密度计算和梯度估计，并将其与解析解进行比较，从而量化误差。这个过程不仅能巩固您对SPH公式的理解，更是培养您进行严谨的数值验证和代码确认这一核心计算科学技能的绝佳机会。",
            "id": "3534781",
            "problem": "设计并实现一个光滑粒子流体动力学 (SPH) 的收敛性研究，重点关注 SPH 梯度算子应用于二维空间中光滑解析标量场的精度。该研究必须基于第一性原理，并评估 SPH 梯度近似的质量加权均方根误差如何随粒子数 $N$ 以及核函数 $W(r,h)$ 的选择而变化。该研究必须以纯数学术语进行阐述，并使用在单位域上定义的无量纲量。\n\n您必须从 SPH 中惯用的连续核函数表示和粒子近似定义开始。考虑一个定义在周期性正方形域 $[0,1]^2$ 上的标量场 $f(\\mathbf{x})$，其粒子位置为 $\\{\\mathbf{x}_i\\}_{i=1}^N$，粒子质量相等，为 $m_i = \\frac{1}{N}$，光滑长度 $h$ 定义为 $h = \\eta \\sqrt{\\frac{1}{N}}$，其中 $\\eta  0$ 是一个无量纲参数。粒子数密度为 $n = \\frac{N}{1} = N$，并且必须在单位环面上使用最小镜像约定来实施周期性边界条件。待采样的解析场为\n$$\nf(x,y) = \\sin(2\\pi x)\\cos(2\\pi y),\n$$\n其精确梯度为\n$$\n\\nabla f(x,y) = \\left(2\\pi \\cos(2\\pi x)\\cos(2\\pi y),\\; -2\\pi \\sin(2\\pi x)\\sin(2\\pi y)\\right).\n$$\n\n在二维空间中使用以下两种各向同性、径向对称、紧支集的 SPH 核函数，每种核函数都经过归一化，使得\n$$\n\\int_{\\mathbb{R}^2} W(r,h)\\,d^2\\mathbf{r} = 1,\n$$\n其支撑半径为 $r \\leq 2h$，并定义 $q \\equiv \\frac{r}{h}$：\n\n- 二维三次样条 (Monaghan-M4) 核函数：\n$$\nW(r,h) = \\frac{\\sigma}{h^2}\\times\n\\begin{cases}\n1 - \\frac{3}{2}q^2 + \\frac{3}{4}q^3,  0 \\le q  1, \\\\\n\\frac{1}{4}(2 - q)^3,  1 \\le q  2, \\\\\n0,  q \\ge 2,\n\\end{cases}\n\\quad \\text{with} \\quad \\sigma = \\frac{10}{7\\pi}.\n$$\n\n- 二维 Wendland $C^2$ 核函数：\n$$\nW(r,h) = \\frac{\\sigma}{h^2}\\times\n\\begin{cases}\n\\left(1 - \\frac{q}{2}\\right)^4(1 + 2q),  0 \\le q \\le 2, \\\\\n0,  q > 2,\n\\end{cases}\n\\quad \\text{with} \\quad \\sigma = \\frac{7}{4\\pi}.\n$$\n\n径向对称核函数 $W(r,h)$ 的梯度必须实现为\n$$\n\\nabla W(\\mathbf{r},h) = \\frac{\\sigma}{h^3}\\,\\frac{dw}{dq}\\,\\frac{\\mathbf{r}}{r},\n$$\n对于 $r  0$，其中 $w(q)$ 是核函数的无量纲核心部分，使得 $W(r,h) = \\frac{\\sigma}{h^2}w(q)$，而 $\\frac{dw}{dq}$ 是其关于 $q$ 的导数。通过取 $\\nabla W(\\mathbf{0},h) = \\mathbf{0}$ 来处理 $r=0$ 的情况。\n\n使用粒子近似定义每个粒子处的 SPH 密度\n$$\n\\rho_i = \\sum_{j=1}^N m_j\\, W(|\\mathbf{x}_i - \\mathbf{x}_j|,h),\n$$\n并定义每个粒子处标量场的 SPH 梯度估计量为\n$$\n\\left(\\nabla f\\right)_i^{\\text{SPH}} = \\sum_{j=1}^N m_j\\,\\frac{f_j}{\\rho_j}\\,\\nabla W(\\mathbf{x}_i - \\mathbf{x}_j,h).\n$$\n每个测试用例需要报告的误差度量是所有粒子的质量加权均方根 $L^2$ 误差，\n$$\nE = \\left[ \\sum_{i=1}^N m_i\\,\\left\\|\\left(\\nabla f\\right)_i^{\\text{SPH}} - \\nabla f(\\mathbf{x}_i)\\right\\|_2^2 \\right]^{1/2}.\n$$\n\n算法要求：\n- 在覆盖 $[0,1]^2$ 的均匀笛卡尔格子上采样粒子位置 $\\mathbf{x}_i$，使用 $N = n_x \\times n_y$ 且 $n_x = n_y = \\sqrt{N}$（选择完全平方数的 $N$ 值）。通过在单位正方形上使用最小镜像约定来实施周期性边界条件。\n- 实现一个元胞链接列表邻居搜索算法，元胞大小等于核函数支撑半径 $2h$，并且只累加 $r \\le 2h$ 的粒子对的贡献。\n- 在给定的测试用例中，对所有粒子使用恒定的 $h$，其值由 $h = \\eta \\sqrt{1/N}$ 设定。\n- 为所有 $j$ 计算 $\\rho_j$，然后使用指定的估计量为所有 $i$ 计算 $\\left(\\nabla f\\right)_i^{\\text{SPH}}$。\n\n测试套件：\n为以下测试用例提供结果，每个用例由核函数类型、粒子数和平滑参数 $\\eta$ 指定：\n- 用例 1：三次样条核函数， $N = 625$ （即 $25 \\times 25$ 网格），$\\eta = 1.5$。\n- 用例 2：三次样条核函数， $N = 2500$ （即 $50 \\times 50$ 网格），$\\eta = 1.5$。\n- 用例 3：Wendland $C^2$ 核函数， $N = 625$，$\\eta = 1.5$。\n- 用例 4：Wendland $C^2$ 核函数， $N = 2500$，$\\eta = 1.5$。\n- 用例 5（邻居较少的边缘情况）：三次样条核函数， $N = 100$ （即 $10 \\times 10$ 网格），$\\eta = 0.8$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含上述测试套件的五个计算出的误差值 $E$，格式为用方括号括起来的逗号分隔列表（例如，$[e_1,e_2,e_3,e_4,e_5]$），其中每个 $e_k$ 是一个无单位的浮点数。不应打印任何其他文本。",
            "solution": "用户提供的问题是计算天体物理学领域一个适定（well-posed）且科学上合理的研究课题，具体涉及光滑粒子流体动力学（SPH）领域。它要求实现一个针对SPH梯度算子的收敛性研究。该问题是自洽的，提供了所有必需的数学定义、无量纲系统中的物理常数以及算法要求。所指定的SPH形式、核函数和误差度量均为该领域的标准方法。因此，该问题被认为是有效的，并将提供完整的解决方案。\n\n问题的核心是使用SPH来近似一个已知标量场 $f(\\mathbf{x})$ 的梯度，并量化该近似的误差。解决方案涉及一个基于SPH第一性原理的多步数值算法。\n\n**1. SPH原理与公式**\n\n光滑粒子流体动力学是一种拉格朗日方法，其中流体或连续场由一组离散粒子表示。在位置 $\\mathbf{x}$ 处任意场 $A(\\mathbf{x})$ 的值，通过使用一个光滑核函数 $W$ 对邻近粒子进行加权平均来近似。\n\n场 $A$ 的SPH表示由以下卷积积分给出：\n$$\n\\langle A(\\mathbf{x}) \\rangle = \\int A(\\mathbf{x'}) W(\\mathbf{x} - \\mathbf{x'}, h) \\,d\\mathbf{x'}\n$$\n其中 $h$ 是光滑长度，它定义了空间平均的范围。在粒子近似中，该积分被离散化为对粒子的求和：\n$$\nA_i = \\sum_{j=1}^N \\frac{m_j}{\\rho_j} A_j W(|\\mathbf{x}_i - \\mathbf{x}_j|, h)\n$$\n此处，$m_j$ 和 $\\rho_j$ 分别是粒子 $j$ 的质量和密度，项 $m_j/\\rho_j$ 近似了与粒子 $j$ 相关的体积元 $d\\mathbf{x'}$。粒子 $i$ 处的SPH密度 $\\rho_i$ 本身通过求和计算：\n$$\n\\rho_i = \\sum_{j=1}^N m_j W(|\\mathbf{x}_i - \\mathbf{x}_j|, h)\n$$\n对于这个问题，所有粒子的质量相等，为 $m_i = m = \\frac{1}{N}$。\n\n场 $f(\\mathbf{x})$ 的梯度通过对卷积积分求梯度来近似，这将导数作用于核函数上：\n$$\n\\langle \\nabla f(\\mathbf{x}) \\rangle = \\int f(\\mathbf{x'}) \\nabla W(\\mathbf{x} - \\mathbf{x'}, h) \\,d\\mathbf{x'}\n$$\n如此问题中所述，相应的粒子近似为：\n$$\n\\left(\\nabla f\\right)_i^{\\text{SPH}} = \\sum_{j=1}^N m_j\\,\\frac{f_j}{\\rho_j}\\,\\nabla_i W(\\mathbf{x}_i - \\mathbf{x}_j,h)\n$$\n其中 $\\nabla_i W$ 表示核函数相对于粒子 $i$ 坐标的梯度。这需要一个两步法：首先，计算所有粒子的密度 $\\rho_j$；其次，使用这些密度计算每个粒子 $i$ 处的梯度。\n\n**2. 核函数及其梯度**\n\n该问题指定了两种定义在 $q = r/h \\le 2$ 上的紧支集核函数，其中 $r = |\\mathbf{x}_i - \\mathbf{x}_j|$。一个径向对称核函数 $W(r,h) = \\frac{\\sigma}{h^d}w(q)$（其中维度 $d=2$）的梯度由下式给出：\n$$\n\\nabla_i W(\\mathbf{x}_i - \\mathbf{x}_j,h) = \\frac{d W}{dr} \\frac{\\mathbf{x}_i - \\mathbf{x}_j}{r} = \\left(\\frac{d W}{dq}\\frac{dq}{dr}\\right) \\frac{\\mathbf{r}_{ij}}{r} = \\left(\\frac{\\sigma}{h^d}\\frac{dw}{dq}\\frac{1}{h}\\right) \\frac{\\mathbf{r}_{ij}}{r} = \\frac{\\sigma}{h^{d+1}}\\frac{dw}{dq}\\frac{\\mathbf{r}_{ij}}{r}\n$$\n其中 $\\mathbf{r}_{ij} = \\mathbf{x}_i - \\mathbf{x}_j$。对于 $d=2$，这与问题中提供的公式 $\\nabla W = \\frac{\\sigma}{h^3}\\frac{dw}{dq}\\frac{\\mathbf{r}}{r}$ 相匹配。\n\n- **三次样条 (M4) 核函数：**\n  - $w(q) = 1 - \\frac{3}{2}q^2 + \\frac{3}{4}q^3$ for $0 \\le q  1$.\n  - $w(q) = \\frac{1}{4}(2 - q)^3$ for $1 \\le q  2$.\n  - 其导数 $\\frac{dw}{dq}$ 为：\n    - $\\frac{dw}{dq} = -3q + \\frac{9}{4}q^2$ for $0 \\le q  1$.\n    - $\\frac{dw}{dq} = -\\frac{3}{4}(2 - q)^2$ for $1 \\le q  2$.\n\n- **Wendland $C^2$ 核函数：**\n  - $w(q) = (1 - \\frac{q}{2})^4(1 + 2q)$ for $0 \\le q \\le 2$.\n  - 其导数 $\\frac{dw}{dq}$ 使用乘法法则求得：\n    - $\\frac{dw}{dq} = 4(1-\\frac{q}{2})^3(-\\frac{1}{2})(1+2q) + (1-\\frac{q}{2})^4(2) = 2(1-\\frac{q}{2})^3 \\left[ -(1+2q) + (1-\\frac{q}{2}) \\right] = -5q(1 - \\frac{q}{2})^3$ for $0 \\le q \\le 2$.\n\n**3. 算法实现**\n\n对于由核函数类型、粒子数 $N$ 和光滑参数 $\\eta$ 定义的每个测试用例，模拟按以下步骤进行。\n\n- **粒子设置：** 粒子被放置在均匀的 $n_x \\times n_y$ 网格上，其中 $n_x = n_y = \\sqrt{N}$。为避免边界效应，位置取在 $[0,1]^2$ 域的元胞中心。光滑长度设置为 $h = \\eta / \\sqrt{N}$。\n\n- **邻居搜索：** 对每个粒子 $i$ 直接遍历所有 $N$ 个粒子进行求和将是一个 $O(N^2)$ 的操作。由于核函数具有紧支集（半径为 $2h$），只有在此距离内的粒子有贡献。使用元胞链接列表算法可实现 $O(N)$ 的复杂度。该域被划分为大小为 $2h \\times 2h$ 的元胞网格。每个粒子被分配到一个元胞中。对于给定粒子，仅通过搜索其自身元胞及相邻的8个元胞来寻找邻居。对元胞索引应用周期性边界条件以处理靠近域边界的粒子。\n\n- **周期性边界条件：** 周期性域是一个二维环面（2-torus）。粒子 $\\mathbf{x}_i$ 和 $\\mathbf{x}_j$ 之间的最短分离矢量 $\\mathbf{r}_{ij}$ 通过最小镜像约定找到。对于大小为 1 的域，矢量差的每个分量（例如 $dx = x_i - x_j$）通过计算 $dx' = dx - \\text{round}(dx)$ 映射到区间 $[-0.5, 0.5]$。\n\n- **计算过程：**\n  1.  **密度计算：** 遍历所有粒子 $i$。对每个 $i$，使用元胞链接列表找到邻居 $j$。计算 $\\mathbf{r}_{ij}$、其大小 $r$ 以及核函数值 $W(r, h)$。对贡献求和以找到 $\\rho_i$。\n  2.  **梯度计算：** 再次遍历所有粒子 $i$。对每个邻居 $j$，使用解析导数 $\\frac{dw}{dq}$ 计算核函数梯度矢量 $\\nabla_i W(\\mathbf{r}_{ij}, h)$。根据 SPH 梯度公式，使用预先计算的密度 $\\rho_j$ 和场值 $f_j$ 对贡献求和。\n\n- **误差评估：** 在每个粒子位置计算解析梯度 $\\nabla f(\\mathbf{x}_i)$。计算 SPH 近似与精确梯度之间的欧几里得距离的平方：$\\|\\left(\\nabla f\\right)_i^{\\text{SPH}} - \\nabla f(\\mathbf{x}_i)\\|_2^2$。最终误差 $E$ 是这些平方误差在所有粒子上的质量加权平均值的平方根。\n\n这个严谨的程序使得能够精确评估 SPH 梯度算子的精度如何作为粒子分辨率和核函数选择的函数而变化。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nimport itertools\n\ndef solve():\n    \"\"\"\n    Main function to run the SPH convergence study for the specified test cases.\n    \"\"\"\n\n    def get_kernel_functions(kernel_type):\n        \"\"\"Returns the kernel value function, its derivative, and sigma.\"\"\"\n        if kernel_type == 'cubic_spline':\n            sigma = 10.0 / (7.0 * np.pi)\n\n            def W_func(q):\n                if 0 = q  1:\n                    return 1.0 - 1.5 * q**2 + 0.75 * q**3\n                elif 1 = q  2:\n                    return 0.25 * (2.0 - q)**3\n                return 0.0\n\n            def dWdq_func(q):\n                if 0 = q  1:\n                    return -3.0 * q + 2.25 * q**2\n                elif 1 = q  2:\n                    return -0.75 * (2.0 - q)**2\n                return 0.0\n\n        elif kernel_type == 'wendland_c2':\n            sigma = 7.0 / (4.0 * np.pi)\n\n            def W_func(q):\n                if 0 = q = 2:\n                    return (1.0 - 0.5 * q)**4 * (1.0 + 2.0 * q)\n                return 0.0\n\n            def dWdq_func(q):\n                if 0 = q = 2:\n                    return -5.0 * q * (1.0 - 0.5 * q)**3\n                return 0.0\n        else:\n            raise ValueError(\"Unknown kernel type\")\n            \n        return W_func, dWdq_func, sigma\n\n    def run_simulation(kernel_type, N, eta):\n        \"\"\"\n        Runs a single SPH simulation case.\n        \"\"\"\n        # 1. Setup\n        nx = int(np.sqrt(N))\n        ny = nx\n        \n        # Create particle positions on a uniform lattice (cell-centered)\n        x = np.linspace(0.5 / nx, 1.0 - 0.5 / nx, nx)\n        y = np.linspace(0.5 / ny, 1.0 - 0.5 / ny, ny)\n        xv, yv = np.meshgrid(x, y)\n        positions = np.vstack([xv.ravel(), yv.ravel()]).T\n\n        mass = 1.0 / N\n        h = eta / np.sqrt(N)\n        support_radius = 2.0 * h\n        support_radius_sq = support_radius**2\n\n        W_func, dWdq_func, sigma = get_kernel_functions(kernel_type)\n\n        # 2. Build Cell-linked List\n        cell_size = support_radius\n        n_cells_dim = int(np.ceil(1.0 / cell_size))\n        \n        grid = [[] for _ in range(n_cells_dim * n_cells_dim)]\n        particle_cell_indices = np.floor(positions / cell_size).astype(int)\n\n        for i in range(N):\n            cx, cy = particle_cell_indices[i]\n            cell_idx = cx * n_cells_dim + cy\n            grid[cell_idx].append(i)\n\n        # 3. Compute Densities\n        rho = np.zeros(N)\n        h_sq = h**2\n        \n        for i in range(N):\n            pos_i = positions[i]\n            cx, cy = particle_cell_indices[i]\n            rho_i = 0.0\n            \n            for dx, dy in itertools.product([-1, 0, 1], repeat=2):\n                ncx = (cx + dx) % n_cells_dim\n                ncy = (cy + dy) % n_cells_dim\n                cell_idx = ncx * n_cells_dim + ncy\n                \n                for j in grid[cell_idx]:\n                    rij_vec = pos_i - positions[j]\n                    rij_vec -= np.round(rij_vec) # Minimum Image Convention\n                    r_sq = np.sum(rij_vec**2)\n\n                    if r_sq  support_radius_sq:\n                        r = np.sqrt(r_sq)\n                        q = r / h\n                        W_val = (sigma / h_sq) * W_func(q)\n                        rho_i += mass * W_val\n            rho[i] = rho_i\n\n        # 4. Compute SPH Gradient\n        f_values = np.sin(2 * np.pi * positions[:, 0]) * np.cos(2 * np.pi * positions[:, 1])\n        grad_sph = np.zeros((N, 2))\n        h_cubed = h**3\n\n        for i in range(N):\n            pos_i = positions[i]\n            cx, cy = particle_cell_indices[i]\n            grad_i = np.zeros(2)\n\n            for dx, dy in itertools.product([-1, 0, 1], repeat=2):\n                ncx = (cx + dx) % n_cells_dim\n                ncy = (cy + dy) % n_cells_dim\n                cell_idx = ncx * n_cells_dim + ncy\n                \n                for j in grid[cell_idx]:\n                    rij_vec = pos_i - positions[j]\n                    rij_vec -= np.round(rij_vec)\n                    r_sq = np.sum(rij_vec**2)\n\n                    if 1e-12  r_sq  support_radius_sq: # r > 0 check\n                        r = np.sqrt(r_sq)\n                        q = r / h\n                        dWdq_val = dWdq_func(q)\n                        grad_W_vec = (sigma / h_cubed) * dWdq_val * (rij_vec / r)\n                        grad_i += mass * (f_values[j] / rho[j]) * grad_W_vec\n            grad_sph[i, :] = grad_i\n\n        # 5. Compute Error\n        grad_exact_x = 2 * np.pi * np.cos(2 * np.pi * positions[:, 0]) * np.cos(2 * np.pi * positions[:, 1])\n        grad_exact_y = -2 * np.pi * np.sin(2 * np.pi * positions[:, 0]) * np.sin(2 * np.pi * positions[:, 1])\n        grad_exact = np.vstack([grad_exact_x, grad_exact_y]).T\n\n        diff_vecs = grad_sph - grad_exact\n        sq_errors = np.sum(diff_vecs**2, axis=1)\n        l2_error = np.sqrt(np.sum(mass * sq_errors))\n        \n        return l2_error\n\n    test_cases = [\n        ('cubic_spline', 625, 1.5),\n        ('cubic_spline', 2500, 1.5),\n        ('wendland_c2', 625, 1.5),\n        ('wendland_c2', 2500, 1.5),\n        ('cubic_spline', 100, 0.8),\n    ]\n\n    results = []\n    for kernel, N_particles, eta_param in test_cases:\n        error = run_simulation(kernel, N_particles, eta_param)\n        results.append(error)\n\n    print(f\"[{','.join(f'{r:.10f}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}