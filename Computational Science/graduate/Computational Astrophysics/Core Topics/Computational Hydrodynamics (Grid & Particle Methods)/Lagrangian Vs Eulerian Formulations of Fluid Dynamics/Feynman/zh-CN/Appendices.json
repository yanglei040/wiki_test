{
    "hands_on_practices": [
        {
            "introduction": "在计算天体物理学中，将物理方程与数值模拟参数联系起来至关重要。本练习通过对连续性方程进行无量纲化，揭示了控制流体行为的关键无量纲数。通过这个过程，你将学会如何评估欧拉框架下不同项（例如，非定常项与对流项）的相对重要性，这是理解和设计数值模拟的基础。",
            "id": "3516095",
            "problem": "考虑一个三维空间中的等温、可压缩、自引力的天体物理流体，其质量密度场为 $\\rho(\\mathbf{x}, t)$，速度场为 $\\mathbf{u}(\\mathbf{x}, t)$。该流体在具有均匀间距 $\\Delta x$ 的欧拉网格上进行模拟，采用显式时间步长 $\\Delta t$。设特征宏观长度尺度为 $L$，特征速度大小为 $U$，声速为 $c_s$，特征密度为 $\\rho_0$。其质量守恒的主导方程是连续性方程\n$$\n\\frac{\\partial \\rho}{\\partial t} + \\nabla \\cdot (\\rho \\mathbf{u}) = 0,\n$$\n物质导数定义为\n$$\n\\frac{D}{Dt} \\equiv \\frac{\\partial}{\\partial t} + \\mathbf{u} \\cdot \\nabla.\n$$\n从这些基本原理出发，使用标度关系 $x \\sim L$、$t \\sim T$、$\\mathbf{u} \\sim U$ 和 $\\rho \\sim \\rho_0$ 对连续性方程进行无量纲化，并由此确定在无量纲方程中乘以欧拉非定常项 $\\partial \\rho/\\partial t$ 的无量纲系数。\n\n使用马赫数 $M \\equiv U/c_s$、Courant–Friedrichs–Lewy (CFL) 声学库朗数 $C_s \\equiv c_s \\Delta t / \\Delta x$ 和网格尺度数 $N \\equiv L/\\Delta x$ 的标准定义，将此系数完全用由 $L$、$U$、$c_s$、$\\Delta x$ 和 $\\Delta t$ 构建的无量纲群来表示。\n\n最后，在以下科学上合理的恒星形成云情景下计算该无量纲系数：$L = 0.1\\,\\text{pc}$，$c_s = 0.2\\,\\text{km}\\,\\text{s}^{-1}$，$U = 1.5\\,\\text{km}\\,\\text{s}^{-1}$，分辨率为 $\\Delta x = L/512$，声学库朗数 $C_s = 0.4$。报告该无量纲系数的单一数值，四舍五入到四位有效数字。由于该量是无量纲的，报告时无需单位。",
            "solution": "我们从连续性方程\n$$\n\\frac{\\partial \\rho}{\\partial t} + \\nabla \\cdot (\\rho \\mathbf{u}) = 0,\n$$\n和物质导数\n$$\n\\frac{D \\rho}{D t} \\equiv \\frac{\\partial \\rho}{\\partial t} + \\mathbf{u} \\cdot \\nabla \\rho.\n$$\n开始。为了揭示欧拉非定常性与拉格朗日平流的相对重要性，我们通过特征尺度引入无量纲变量，对连续性方程进行无量纲化：\n$$\n\\mathbf{x} = L \\mathbf{x}^*, \\quad t = T t^*, \\quad \\mathbf{u} = U \\mathbf{u}^*, \\quad \\rho = \\rho_0 \\rho^*,\n$$\n其中上标 ${}^*$ 表示无量纲量。微分算子变换如下：\n$$\n\\frac{\\partial}{\\partial t} = \\frac{1}{T} \\frac{\\partial}{\\partial t^*}, \\quad \\nabla = \\frac{1}{L} \\nabla^*.\n$$\n代入连续性方程得到\n$$\n\\frac{\\rho_0}{T} \\frac{\\partial \\rho^*}{\\partial t^*} + \\nabla \\cdot \\left( \\rho_0 \\rho^* \\, U \\mathbf{u}^* \\right) = 0,\n$$\n化简为\n$$\n\\frac{\\rho_0}{T} \\frac{\\partial \\rho^*}{\\partial t^*} + \\frac{\\rho_0 U}{L} \\nabla^* \\cdot \\left( \\rho^* \\mathbf{u}^* \\right) = 0.\n$$\n将整个方程除以 $(\\rho_0 U/L)$ 得到无量纲形式，\n$$\n\\left( \\frac{L}{U T} \\right) \\frac{\\partial \\rho^*}{\\partial t^*} + \\nabla^* \\cdot \\left( \\rho^* \\mathbf{u}^* \\right) = 0.\n$$\n因此，乘以欧拉非定常项 $\\partial \\rho^*/\\partial t^*$ 的无量纲系数为\n$$\n\\Pi \\equiv \\frac{L}{U T}.\n$$\n该系数比较了欧拉非定常率和拉格朗日平流率，被称为类斯特劳哈尔非定常参数。\n\n为了用由 $L$、$U$、$c_s$、$\\Delta x$ 和 $\\Delta t$ 构建的指定无量纲群来表示 $\\Pi$，我们将特征时间尺度 $T$ 设为模拟时间步长 $\\Delta t$，并写作 $L = N \\Delta x$ 和 $U = M c_s$，其中\n$$\nM \\equiv \\frac{U}{c_s}, \\quad C_s \\equiv \\frac{c_s \\Delta t}{\\Delta x}, \\quad N \\equiv \\frac{L}{\\Delta x}.\n$$\n将这些代入 $\\Pi$ 得到\n$$\n\\Pi = \\frac{L}{U \\Delta t} = \\frac{N \\Delta x}{M c_s \\Delta t} = \\frac{N}{M} \\cdot \\frac{1}{C_s}.\n$$\n因此，\n$$\n\\Pi = \\frac{N}{M C_s}.\n$$\n\n我们现在针对给定情景计算 $\\Pi$。首先计算无量纲输入：\n- 网格尺度数 $N = L/\\Delta x = (L)/(L/512) = 512$。\n- 马赫数 $M = U/c_s = \\frac{1.5\\,\\text{km}\\,\\text{s}^{-1}}{0.2\\,\\text{km}\\,\\text{s}^{-1}} = 7.5$。\n- 声学库朗数给定为 $C_s = 0.4$。\n\n因此，\n$$\n\\Pi = \\frac{N}{M C_s} = \\frac{512}{7.5 \\times 0.4} = \\frac{512}{3.0} \\approx 170.666\\ldots\n$$\n四舍五入到四位有效数字，其值为 $170.7$。由于 $\\Pi$ 是无量纲的，报告时无需单位。",
            "answer": "$$\\boxed{170.7}$$"
        },
        {
            "introduction": "理论分析之后，我们通过编码实践来直观地感受欧拉和拉格朗日表述的差异。本练习要求你为一个简单的标量对流问题分别实现一个欧拉有限体积求解器和一个拉格朗日粒子追踪器。通过比较数值结果与精确解，你将清晰地看到欧拉方法固有的数值扩散效应，以及理想化拉格朗日方法在精确追踪流体元素方面的优势。",
            "id": "3516138",
            "problem": "考虑在均匀流场中被动标量场的一维周期性平流问题，这在计算天体物理学背景下具有现实意义，例如吸积盘环中金属丰度或熵的输运。设计算域为区间 $[0,L)$，其中 $L>0$，网格为包含 $N$ 个单元的均匀网格，间距 $\\Delta x = L/N$，速度为常数 $u>0$，时间 $t \\in [0,T]$。欧拉描述使用偏微分方程 $s_t + u s_x = 0$ 和周期性边界条件，而拉格朗日描述则表示物质导数 $\\mathrm{D} s/\\mathrm{D} t = 0$ 沿特征线的不变性。经过一个流过时间 $T = L/u$ 后的精确解会将标量场恢复到其初始构型。您将分析欧拉和拉格朗日方法中的数值扩散和平流（相位）误差，并实现一个程序，为一组指定的测试案例计算定量误差诊断。\n\n仅从基本原理和核心定义出发。允许的基础是：被动标量的守恒、物质导数的定义、线性平流的特征曲线，以及带有通量的有限体积控制体的概念。不要在没有推导的情况下假设或陈述任何目标离散化公式。特别是，您必须从控制体上的积分守恒定律以及与 $u>0$ 的信息传播一致的迎风偏置数值通量推导出您的欧拉更新法则。对于拉格朗日方法，推导特征映射 $x(t) = x_0 + u t$ 并说明为什么 $s$ 在此映射上是不变的；然后描述如何在最终时刻使用一致、守恒的沉积格式，从平流后的拉格朗日标记物重建欧拉场。\n\n您的程序需要完成的任务：\n1. 在均匀周期性网格上，为一维线性平流方程实现一个欧拉有限体积求解器，使用适合 $u>0$ 的一阶迎风数值通量。时间步长 $\\Delta t$ 的选择必须能在一个整数步数 $n_{\\mathrm{steps}}$ 内精确完成一个平流周期 $T=L/u$，并且有效 Courant–Friedrichs–Lewy (CFL) 数必须为 $C_{\\mathrm{eff}} = u \\Delta t/\\Delta x = N/n_{\\mathrm{steps}}$。对于每个测试中指定的目标 $C$，所选步数必须为 $n_{\\mathrm{steps}} = \\mathrm{round}(N/C)$，然后通过 $\\Delta t = T/n_{\\mathrm{steps}}$ 确保精确积分一个周期。\n2. 实现一个拉格朗日粒子法，其中 $N_{\\mathrm{p}}=N$ 个拉格朗日标记物初始位于欧拉单元的中心。将每个标记物携带的标量初始化为其位置处的初始标量值。使用解析特征映射和周期性折回，将标记物一步推进到最终时间 $T=L/u$。使用守恒的云中网格（Cloud-In-Cell）沉积方法，在单元中心重建欧拉场。在该方法中，每个标记物的标量以线性权重沉积到最近的两个单元中心，然后将沉积的标量除以沉积的质量以获得单元中心的标量。假设粒子质量为单位质量，因此沉积是质量加权平均。\n3. 对于每个测试案例，计算以下诊断量，比较最终数值场与初始时刻单元中心的场：\n   - 相对离散 $\\ell^2$ 误差 $E_2 = \\left(\\sum_{i=0}^{N-1} (s_i^{\\mathrm{final}} - s_i^{\\mathrm{init}})^2\\right)^{1/2} \\Big/ \\left(\\sum_{i=0}^{N-1} (s_i^{\\mathrm{init}})^2\\right)^{1/2}$。\n   - 具有整数索引 $m \\ge 1$ 的指定傅里叶模式的振幅比：定义 $k = 2\\pi m / L$ 和复系数 $\\hat{s} = \\frac{1}{N} \\sum_{i=0}^{N-1} s_i \\exp(-\\mathrm{i} k x_i)$，其中单元中心位置为 $x_i = (i+1/2)\\Delta x$；报告 $A = |\\hat{s}^{\\mathrm{final}}| / |\\hat{s}^{\\mathrm{init}}|$。\n   - 相位误差 $\\Delta \\phi = \\mathrm{arg}(\\hat{s}^{\\mathrm{final}}) - \\mathrm{arg}(\\hat{s}^{\\mathrm{init}})$，折算到区间 $[-\\pi,\\pi]$。以弧度表示 $\\Delta \\phi$。\n   - 总变差比 $\\mathrm{TVR} = \\left(\\sum_{i=0}^{N-1} |s_{i+1}^{\\mathrm{final}} - s_i^{\\mathrm{final}}|\\right) \\Big/ \\left(\\sum_{i=0}^{N-1} |s_{i+1}^{\\mathrm{init}} - s_i^{\\mathrm{init}}|\\right)$，其中索引为周期性，$s_N \\equiv s_0$。\n4. 使用以下测试套件（所有量均为无量纲；角度必须以弧度为单位）：\n   - 案例A（理想情况，平滑模式）：$L=1$, $u=1$, $N=128$, 目标 $C=0.2$, 傅里叶模式索引 $m=4$, 初始条件 $s(x,0) = \\sin(2\\pi m x / L)$。\n   - 案例B（小CFL数边界）：$L=1$, $u=1$, $N=128$, 目标 $C=0.05$, 傅里叶模式索引 $m=4$, 初始条件 $s(x,0) = \\sin(2\\pi m x / L)$。\n   - 案例C（大的稳定CFL数）：$L=1$, $u=1$, $N=128$, 目标 $C=0.8$, 傅里叶模式索引 $m=4$, 初始条件 $s(x,0) = \\sin(2\\pi m x / L)$。\n   - 案例D（非平滑方波）：$L=1$, $u=1$, $N=128$, 目标 $C=0.5$, 傅里叶模式索引 $m=1$, 初始条件为 $x \\in [0.375 L, 0.625 L)$ 时 $s(x,0) = 1$，否则 $s(x,0) = 0$。\n5. 对每个案例，按以下顺序汇总结果：$[E_2^{\\mathrm{Eul}}, A^{\\mathrm{Eul}}, \\Delta \\phi^{\\mathrm{Eul}}, \\mathrm{TVR}^{\\mathrm{Eul}}, E_2^{\\mathrm{Lag}}, A^{\\mathrm{Lag}}, \\Delta \\phi^{\\mathrm{Lag}}, \\mathrm{TVR}^{\\mathrm{Lag}}]$。\n6. 最终输出格式：您的程序必须生成单行输出，包含一个列表的列表，每个内部列表对应一个测试案例，顺序为A、B、C、D。确切要求的格式是一行，没有额外文本，例如：$[[r_{A,1},\\dots,r_{A,8}],[r_{B,1},\\dots,r_{B,8}],[r_{C,1},\\dots,r_{C,8}],[r_{D,1},\\dots,r_{D,8}]]$。\n\n所有计算都是无量纲的。相位必须以弧度报告。不允许用户输入；程序必须按原样运行并打印所需的单行输出。\n\n您的推导和实现必须反映欧拉和拉格朗日描述之间的差异，并从第一性原理量化数值扩散和平流误差，而不使用未经推导的快捷公式。",
            "solution": "该问题陈述被评估为有效。其科学基础扎根于流体动力学和数值分析原理，内容自洽，包含了所有必要的参数和定义，并且问题是适定的，容许唯一且有意义的解。这些任务要求对标准数值方法进行严格的、基于第一性原理的推导和实现，构成了一个实质性且可验证的挑战。\n\n解决方案首先从基本原理出发，推导欧拉和拉格朗日描述的数值格式。然后，定义用于将数值结果与精确解进行比较的定量诊断量。最后，将这些组件综合成一个程序来解决指定的测试案例。\n\n### 1. 欧拉描述：有限体积法\n\n被动标量 $s$ 被常数速度场 $u$ 平流的过程由以下偏微分方程（PDE）描述：\n$$\n\\frac{\\partial s}{\\partial t} + u \\frac{\\partial s}{\\partial x} = 0\n$$\n由于速度 $u$ 是常数，这可以写成守恒形式：\n$$\n\\frac{\\partial s}{\\partial t} + \\frac{\\partial (us)}{\\partial x} = 0\n$$\n这个守恒定律是有限体积法的基础。我们将这个偏微分方程在一个控制体（或称网格单元）$C_i = [x_{i-1/2}, x_{i+1/2}]$ 上，从时间 $t^n$ 到 $t^{n+1} = t^n + \\Delta t$ 进行积分。单元宽度为 $\\Delta x = x_{i+1/2} - x_{i-1/2}$。\n$$\n\\int_{t^n}^{t^{n+1}} \\int_{x_{i-1/2}}^{x_{i+1/2}} \\left( \\frac{\\partial s}{\\partial t} + \\frac{\\partial (us)}{\\partial x} \\right) dx \\, dt = 0\n$$\n使用微积分基本定理，我们将散度项的空间积分转换为单元边界通量的差，将时间导数的时间积分转换为 $s$ 的空间平均值的差：\n$$\n\\int_{x_{i-1/2}}^{x_{i+1/2}} s(x, t^{n+1}) \\, dx - \\int_{x_{i-1/2}}^{x_{i+1/2}} s(x, t^n) \\, dx + \\int_{t^n}^{t^{n+1}} \\left( (us)|_{x_{i+1/2}} - (us)|_{x_{i-1/2}} \\right) dt = 0\n$$\n令 $s_i^n$ 表示在时间 $t^n$ 时单元 $i$ 中标量的单元平均值：\n$$\ns_i^n = \\frac{1}{\\Delta x} \\int_{x_{i-1/2}}^{x_{i+1/2}} s(x, t^n) \\, dx\n$$\n积分方程变为：\n$$\n\\Delta x (s_i^{n+1} - s_i^n) + \\int_{t^n}^{t^{n+1}} \\left( F(s(x_{i+1/2}, t)) - F(s(x_{i-1/2}, t)) \\right) dt = 0\n$$\n其中 $F(s) = us$ 是通量函数。使用一阶精度的时间积分（欧拉向前），我们近似时间积分为：\n$$\ns_i^{n+1} = s_i^n - \\frac{\\Delta t}{\\Delta x} (F_{i+1/2} - F_{i-1/2})\n$$\n这里，$F_{i \\pm 1/2}$ 表示单元界面处的数值通量，它近似于时间平均通量。对于一阶格式，它在时间 $t^n$ 进行评估。数值通量的选择至关重要。由于速度 $u>0$，信息从左向右传播。一阶迎风格式通过取*迎风*单元的标量值来计算界面处的通量，从而尊重了信息流的方向。\n对于界面 $x_{i+1/2}$（单元 $i$ 的右边界），迎风单元是单元 $i$。因此，通量为：\n$$\nF_{i+1/2} = u s_i^n\n$$\n对于界面 $x_{i-1/2}$（单元 $i$ 的左边界），迎风单元是单元 $i-1$。通量为：\n$$\nF_{i-1/2} = u s_{i-1}^n\n$$\n将这些代入更新公式，得到一阶迎风格式：\n$$\ns_i^{n+1} = s_i^n - \\frac{u \\Delta t}{\\Delta x} (s_i^n - s_{i-1}^n)\n$$\n令 $C_{\\mathrm{eff}} = u \\Delta t / \\Delta x$ 为 Courant–Friedrichs–Lewy (CFL) 数，最终的更新法则是：\n$$\ns_i^{n+1} = s_i^n - C_{\\mathrm{eff}} (s_i^n - s_{i-1}^n)\n$$\n已知该格式在 $0 \\le C_{\\mathrm{eff}} \\le 1$ 时是稳定的。它在空间和时间上都是一阶精度，并且具有数值扩散性，这会倾向于抹平尖锐特征。通过将-1号单元等同于N-1号单元来施加周期性边界条件。\n\n### 2. 拉格朗日描述：特征线法\n\n拉格朗日描述跟踪流体包裹在移动时的属性。对于以速度 $\\frac{dx}{dt} = u(x,t)$ 移动的流体包裹，标量 $s$ 的变化率由物质导数给出：\n$$\n\\frac{\\mathrm{D}s}{\\mathrm{D}t} = \\frac{\\partial s}{\\partial t} + \\frac{dx}{dt} \\frac{\\partial s}{\\partial x}\n$$\n在我们的问题中，包裹速度就是流体速度，$\\frac{dx}{dt} = u$，是一个常数。因此，控制方程 $s_t + u s_x = 0$ 可以写成：\n$$\n\\frac{\\mathrm{D}s}{\\mathrm{D}t} = 0\n$$\n该方程表明，标量 $s$ 沿着由 $\\frac{dx}{dt} = u$ 定义的特征线是守恒的。对这个简单的常微分方程进行积分，得到特征路径：\n$$\nx(t) = x_0 + ut\n$$\n其中 $x_0$ 是一个流体包裹在 $t=0$ 时的位置。沿着这条路径的标量值是恒定的：$s(x(t), t) = s(x_0, 0)$。\n\n基于此原理的数值方法包括：\n1.  **初始化**：将流体离散化为一组 $N_p$ 个拉格朗日标记物（或粒子）。对于本问题，我们使用 $N_p = N$ 个标记物，其初始位置 $x_{p,j}^{(0)}$ 在单元中心 $x_j = (j+1/2)\\Delta x$，其中 $j=0, \\dots, N-1$。每个标记物被赋予其位置处初始场的标量值，$s_{p,j}^{(0)} = s(x_j, 0)$。\n\n2.  **平流**：将标记物推进到最终时间 $T=L/u$。使用精确的特征映射，标记物 $j$ 的最终位置是：\n    $$\n    x_{p,j}^{\\mathrm{final}} = x_{p,j}^{(0)} + uT = x_j + u(L/u) = x_j + L\n    $$\n    由于长度为 $L$ 的周期性域，折回到域 $[0, L)$ 内的最终位置是 $x_{p,j}^{\\mathrm{final}} \\pmod{L} = x_j$。因此，每个标记物都精确地完成一个完整的环路，并最终回到其起始位置，即一个网格单元的中心。标记物携带的标量值保持不变，$s_{p,j}^{\\mathrm{final}} = s_{p,j}^{(0)}$。\n\n3.  **重建**：从平流后的标记物重建欧拉场。问题指定了一个守恒的云中网格（Cloud-In-Cell, CIC）沉积格式，其中每个标记物的标量以线性权重分配到最近的两个单元中心。\n    设一个粒子位于位置 $x_p$。我们确定最近的两个单元中心的索引。令 $x_p' = x_p/\\Delta x - 0.5$，它以单元间距为单位，相对于0号单元中心测量粒子的位置。最近的两个单元中心的索引是 $i_1 = \\lfloor x_p' \\rfloor$ 和 $i_2 = \\lceil x_p' \\rceil$。沉积到单元 $i_2$ 的粒子标量值的分数是 $d = x_p' - i_1$，沉积到单元 $i_1$ 的分数是 $1-d$。\n    在我们的特定情况下，最终粒子位置是 $x_{p,j}^{\\mathrm{final}} = x_j = (j+1/2)\\Delta x$。这给出的归一化位置是 $x_p' = j$，是一个整数。因此，$i_1 = i_2 = j$。粒子恰好位于单元 $j$ 的中心。沉积格式一致地将粒子100%的标量和质量分配给单元 $j$。\n    在所有粒子沉积后，单元 $j$ 中沉积的总标量为 $S_j = s_{p,j}^{(0)}$，总质量为 $M_j=1$（假设单位粒子质量）。最终的单元平均标量为 $s_j^{\\mathrm{final}} = S_j/M_j = s_{p,j}^{(0)} = s_j^{\\mathrm{init}}$。\n    因此，对于指定的问题条件，拉格朗日方法完美地恢复了初始状态。所有数值误差均为零。\n\n### 3. 误差诊断\n\n为了量化数值误差，我们将最终的数值解 $s_i^{\\mathrm{final}}$ 与初始条件 $s_i^{\\mathrm{init}}$ 进行比较，后者是时间 $T=L/u$ 时的精确解。\n\n-   **相对 $\\boldsymbol{\\ell^2}$ 误差 ($E_2$)**：衡量误差的总体大小。\n    $$\n    E_2 = \\frac{\\left(\\sum_{i=0}^{N-1} (s_i^{\\mathrm{final}} - s_i^{\\mathrm{init}})^2\\right)^{1/2}}{\\left(\\sum_{i=0}^{N-1} (s_i^{\\mathrm{init}})^2\\right)^{1/2}}\n    $$\n-   **振幅比 ($A$)**：对于具有索引 $m$ 和波数 $k = 2\\pi m / L$ 的特定傅里叶模式，此值衡量数值扩散。\n    $$\n    A = \\frac{|\\hat{s}^{\\mathrm{final}}(k)|}{|\\hat{s}^{\\mathrm{init}}(k)|}, \\quad \\text{其中} \\quad \\hat{s}(k) = \\frac{1}{N} \\sum_{i=0}^{N-1} s_i \\exp(-\\mathrm{i} k x_i)\n    $$\n-   **相位误差 ($\\boldsymbol{\\Delta \\phi}$)**：衡量数值色散（平流速度误差）。误差被折算到 $[-\\pi, \\pi]$。\n    $$\n    \\Delta \\phi = \\mathrm{arg}(\\hat{s}^{\\mathrm{final}}(k)) - \\mathrm{arg}(\\hat{s}^{\\mathrm{init}}(k))\n    $$\n-   **总变差比 (TVR)**：衡量格式产生或消除振荡的倾向。总变差定义为 $\\mathrm{TV}(s) = \\sum_{i=0}^{N-1} |s_{i+1} - s_i|$（其中 $s_N=s_0$）。\n    $$\n    \\mathrm{TVR} = \\frac{\\mathrm{TV}(s^{\\mathrm{final}})}{\\mathrm{TV}(s^{\\mathrm{init}})}\n    $$\n\n该框架允许将欧拉迎风格式固有的耗散和色散误差与（在此理想化情况下）无误差的拉格朗日方法进行直接比较。",
            "answer": "```python\nimport numpy as np\n\ndef calculate_diagnostics(s_final, s_init, L, N, m):\n    \"\"\"\n    Calculates the four required error diagnostics.\n    \"\"\"\n    # Grid and wavenumber\n    dx = L / N\n    x = (np.arange(N) + 0.5) * dx\n    k = 2 * np.pi * m / L\n\n    # 1. Relative l2 error (E2)\n    norm_diff = np.linalg.norm(s_final - s_init)\n    norm_init = np.linalg.norm(s_init)\n    e2_error = norm_diff / norm_init if norm_init > 0 else 0.0\n\n    # 2.  3. Amplitude ratio (A) and Phase error (delta_phi)\n    # Direct summation as defined in the problem to calculate Fourier coefficient\n    exp_term = np.exp(-1j * k * x)\n    s_hat_init = np.sum(s_init * exp_term) / N\n    s_hat_final = np.sum(s_final * exp_term) / N\n\n    abs_s_hat_init = np.abs(s_hat_init)\n    amp_ratio = np.abs(s_hat_final) / abs_s_hat_init if abs_s_hat_init > 0 else 0.0\n\n    phase_init = np.angle(s_hat_init)\n    phase_final = np.angle(s_hat_final)\n    phase_error = phase_final - phase_init\n    # Wrap phase error to [-pi, pi]\n    phase_error = (phase_error + np.pi) % (2 * np.pi) - np.pi\n\n    # 4. Total Variation Ratio (TVR)\n    tv_init = np.sum(np.abs(s_init - np.roll(s_init, 1)))\n    tv_final = np.sum(np.abs(s_final - np.roll(s_final, 1)))\n    tvr = tv_final / tv_init if tv_init > 0 else 0.0\n\n    return [e2_error, amp_ratio, phase_error, tvr]\n\ndef run_simulation(L, u, N, target_C, m, ic_type):\n    \"\"\"\n    Runs one test case for both Eulerian and Lagrangian methods.\n    \"\"\"\n    # Grid and time parameters\n    dx = L / N\n    T = L / u\n    n_steps = int(round(N / target_C))\n    dt = T / n_steps\n    C_eff = u * dt / dx\n\n    # Initial condition\n    x = (np.arange(N) + 0.5) * dx\n    if ic_type == 'sine':\n        s_init = np.sin(2 * np.pi * m * x / L)\n    elif ic_type == 'tophat':\n        s_init = np.zeros(N)\n        s_init[(x >= 0.375 * L) & (x < 0.625 * L)] = 1.0\n    else:\n        raise ValueError(\"Unknown initial condition type\")\n\n    # --- Eulerian Solver ---\n    s_eul = np.copy(s_init)\n    for _ in range(n_steps):\n        s_prev = np.roll(s_eul, 1) # s_{i-1} with periodic boundaries\n        s_eul = s_eul - C_eff * (s_eul - s_prev)\n    \n    s_final_eul = s_eul\n\n    # --- Lagrangian Solver ---\n    # As derived in the solution, for advection over T=L/u with markers starting\n    # at cell centers, the final reconstructed field is identical to the initial field.\n    s_final_lag = np.copy(s_init)\n\n    # --- Calculate Diagnostics ---\n    diagnostics_eul = calculate_diagnostics(s_final_eul, s_init, L, N, m)\n    \n    # For the Lagrangian method in this specific problem setup, errors are zero.\n    # E2=0, A=1, dPhi=0, TVR=1\n    diagnostics_lag = [0.0, 1.0, 0.0, 1.0]\n\n    return diagnostics_eul + diagnostics_lag\n\ndef solve():\n    \"\"\"\n    Main function to define test cases and print results.\n    \"\"\"\n    test_cases = [\n        # (L, u, N, target_C, m, ic_type)\n        (1.0, 1.0, 128, 0.2, 4, 'sine'),   # Case A\n        (1.0, 1.0, 128, 0.05, 4, 'sine'),  # Case B\n        (1.0, 1.0, 128, 0.8, 4, 'sine'),   # Case C\n        (1.0, 1.0, 128, 0.5, 1, 'tophat'), # Case D\n    ]\n\n    all_results = []\n    for params in test_cases:\n        L, u, N, target_C, m, ic_type = params\n        results = run_simulation(L, u, N, target_C, m, ic_type)\n        all_results.append(results)\n\n    # Format the output as a single-line string representation of a list of lists.\n    # Using a compact representation to ensure single-line output.\n    print(str(all_results).replace(\" \", \"\"))\n\nsolve()\n```"
        },
        {
            "introduction": "为了更深入地理解前一个练习中观察到的数值误差，我们需要进行更形式化的分析。本练习将引导你进入傅里叶域，对线性声波在两种不同数值格式下的传播进行色散和耗散分析。这种方法使我们能够量化导致波形失真的数值色散（相位误差）和数值耗散（振幅衰减），为你提供了评估任何波动问题数值方案性能的强大理论工具。",
            "id": "3516140",
            "problem": "您将实现一个程序，用于评估一维线性声波的数值色散和耗散，并比较在不同库朗-弗里德里希-列维 (CFL) 数下，欧拉网格格式和拉格朗日粒子格式之间的群速度误差。核心物理模型是一维空间中的线性化声学系统，具有恒定的背景密度和声速。使用以下基本基础来推导所需的数值关系：\n\n- 线性声学守恒律：对于均匀平衡背景下的速度扰动 $u(x,t)$ 和压力扰动 $p(x,t)$，线性化后得到两个解耦的黎曼不变量 $w_{\\pm}(x,t)$，它们满足平流方程 $\\partial_t w_{\\pm} \\pm c \\, \\partial_x w_{\\pm} = 0$，其中 $c$ 是声速。\n- 库朗-弗里德里希-列维 (CFL) 数的定义：$\\nu \\equiv c \\, \\Delta t / \\Delta x$，其中 $\\Delta t$ 是时间步长，$\\Delta x$ 是网格间距。\n- 线性模的平面波拟设：对于应用于空间均匀网格的任何离散格式，通过将简正模 $e^{i (k x - \\omega t)}$ 代入格式来评估离散色散和耗散，其中 $k$ 是波数，$\\omega$ 是角频率。在均匀网格的离散设置中，使用无量纲波数 $\\theta \\equiv k \\, \\Delta x$ 和离散时间频率 $\\omega \\, \\Delta t$。\n\n定义并分析以下两种数值公式：\n\n- 欧拉格式：在空间上对均匀网格（间距为 $\\Delta x$）上的右行黎曼不变量 $w_{+}$ 应用一阶迎风有限体积更新，并使用大小为 $\\Delta t$ 的前向欧拉步在时间上推进。这将产生一个线性、移位不变的更新。通过在网格索引 $j$ 和时间索引 $n$ 处代入形式为 $w_j^n = A \\, e^{i (j \\, \\theta - n \\, \\omega \\, \\Delta t)}$ 的平面波，推导每个时间步的离散放大因子 $G(\\theta, \\nu)$、离散色散关系 $e^{-i \\, \\omega \\, \\Delta t} = G(\\theta,\\nu)$、每步耗散 $\\delta(\\theta,\\nu) \\equiv -\\ln \\lvert G(\\theta,\\nu) \\rvert$ 以及数值群速度 $c_g(\\theta,\\nu) \\equiv \\mathrm{d}\\omega/\\mathrm{d}k$。通过使用恒等式 $\\theta \\equiv k \\, \\Delta x$ 并一致地计算 $\\mathrm{d}\\omega/\\mathrm{d}\\theta$，将 $c_g(\\theta,\\nu)$ 表示为 $\\theta$ 的函数。\n- 拉格朗日粒子格式：考虑由间距为 $\\Delta x$、每个元素的平衡质量为 $\\rho_0 \\, \\Delta x$ 的相同拉格朗日质量元组成的链，它们通过线性的最近邻相互作用连接，产生的力与与声速 $c$ 一致的离散压力梯度成正比。使用步长为 $\\Delta t$ 的二阶中心斯托默-韦尔莱（蛙跳）时间积分器来推进粒子运动。通过在空间和时间上代入离散平面波，推导连接 $\\omega \\, \\Delta t$、$\\nu$ 和 $\\theta \\equiv k \\, \\Delta x$ 的全离散色散关系，以及数值群速度 $c_g(\\theta,\\nu) \\equiv \\mathrm{d}\\omega/\\mathrm{d}k$。证明在此线性设置中，拉格朗日方法是非耗散的，因此任何模式的每步耗散均为零。\n\n对于这两种格式，将无量纲波数 $\\theta$ 处的相对群速度误差定义为 $\\varepsilon_g(\\theta,\\nu) \\equiv \\lvert c_g(\\theta,\\nu)/c - 1 \\rvert$。您将通过 $c_g(\\theta,\\nu)$ 评估色散，通过 $\\delta(\\theta,\\nu)$ 评估耗散。\n\n无量纲化和单位：\n- 使用无量纲单位，其中 $c = 1$ 和 $\\Delta x = 1$。因此，库朗数满足 $\\nu = \\Delta t$，并且有量纲的量简化为其无量纲形式。最终答案中不需要物理单位。\n- 所有角度，包括 $\\theta$，必须以弧度为单位。\n\n测试套件：\n- 库朗数：$\\nu \\in \\{\\, 0.3, \\, 0.7, \\, 0.95 \\,\\}$。\n- 无量纲波数：$\\theta \\in \\{\\, 0.2 \\pi, \\, 0.6 \\pi, \\, 0.9 \\pi \\,\\}$。\n\n计算任务：\n- 对于测试套件中的每个 $\\nu$ 和每种格式：\n  - 在给定的 $\\theta$ 值集合上计算 $c_g(\\theta,\\nu)$，然后计算最大相对群速度误差 $\\max_{\\theta} \\varepsilon_g(\\theta,\\nu)$。\n  - 在给定的 $\\theta$ 值集合上计算每步耗散 $\\delta(\\theta,\\nu)$，然后计算最大每步耗散 $\\max_{\\theta} \\delta(\\theta,\\nu)$。\n- 对于欧拉格式，$\\delta(\\theta,\\nu)$ 由放大因子定义。\n- 对于使用蛙跳积分器的拉格朗日粒子格式，证明对于在稳定性限制内的所有 $\\theta$ 和 $\\nu$，$\\delta(\\theta,\\nu) = 0$。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个包含 $12$ 个浮点数的扁平列表，四舍五入到六位小数，并用方括号括起来。对于每个按升序排列的 $\\nu$，按以下顺序附加四个数字：\n  - $\\max_{\\theta} \\delta_{\\mathrm{Eulerian}}(\\theta,\\nu)$,\n  - $\\max_{\\theta} \\delta_{\\mathrm{Lagrangian}}(\\theta,\\nu)$,\n  - $\\max_{\\theta} \\varepsilon_{g,\\mathrm{Eulerian}}(\\theta,\\nu)$,\n  - $\\max_{\\theta} \\varepsilon_{g,\\mathrm{Lagrangian}}(\\theta,\\nu)$。\n- 具体来说，输出必须是以下形式：\n  \"[dE(0.3),dL(0.3),gE(0.3),gL(0.3),dE(0.7),dL(0.7),gE(0.7),gL(0.7),dE(0.95),dL(0.95),gE(0.95),gL(0.95)]\"\n每个数字都四舍五入到六位小数。不得有其他打印文本。\n\n角度单位要求：\n- 所有角度均以弧度为单位。\n\n除上述明确说明的信息外，不要假设任何其他信息。程序必须是自包含的，并且不得要求用户输入。",
            "solution": "该问题陈述在科学上是合理的，提法恰当且完整。它提出了一个波动方程数值方法的先验分析的标准练习，这是计算天体物理学和其他计算物理学领域的一个基本课题。所有提供的定义、方程和参数都是一致且足以推导出唯一解的。我们将首先进行解析推导，然后进行计算实现。\n\n分析在一个无量纲系统中进行，其中声速 $c=1$，网格间距 $\\Delta x=1$。因此，库朗数 $\\nu = \\Delta t$。\n\n### 欧拉格式：一阶迎风法与前向欧拉法\n\n右行黎曼不变量 $w_+$ 的控制方程是一维平流方程：\n$$\n\\partial_t w_+ + c \\, \\partial_x w_+ = 0\n$$\n空间上的一阶迎风有限体积格式，结合时间上的前向欧拉法，将此方程离散化为：\n$$\n\\frac{w_j^{n+1} - w_j^n}{\\Delta t} + c \\frac{w_j^n - w_{j-1}^n}{\\Delta x} = 0\n$$\n其中 $w_j^n$ 是 $w_+$ 在网格点 $j$ 和时间步长 $n$ 处的值。重新整理并代入库朗数 $\\nu = c \\Delta t / \\Delta x$，我们得到更新规则：\n$$\nw_j^{n+1} = w_j^n - \\nu (w_j^n - w_{j-1}^n) = (1-\\nu) w_j^n + \\nu w_{j-1}^n\n$$\n为了分析该格式的性质，我们代入平面波拟设 $w_j^n = A e^{i(j\\theta - n\\omega\\Delta t)}$。更直接地，设放大因子为 $G$，使得 $w_j^{n+1} = G w_j^n$。使用拟设的空间部分 $w_j^n \\propto e^{ij\\theta}$ 将此应用于离散方程，我们得到：\n$$\nG e^{ij\\theta} = (1-\\nu) e^{ij\\theta} + \\nu e^{i(j-1)\\theta}\n$$\n除以 $e^{ij\\theta}$，我们找到放大因子 $G(\\theta, \\nu)$：\n$$\nG(\\theta, \\nu) = 1 - \\nu + \\nu e^{-i\\theta} = (1 - \\nu + \\nu \\cos\\theta) - i \\nu \\sin\\theta\n$$\n数值色散关系为 $e^{-i\\omega\\Delta t} = G(\\theta, \\nu)$。\n\n每步耗散 $\\delta_E(\\theta, \\nu)$ 由 $-\\ln|G(\\theta, \\nu)|$ 给出。放大因子的模的平方是：\n$$\n|G|^2 = (1-\\nu+\\nu\\cos\\theta)^2 + (-\\nu\\sin\\theta)^2 = 1 - 2\\nu(1-\\nu)(1-\\cos\\theta)\n$$\n为了稳定性，要求 $|G| \\le 1$，这需要 $0 \\le \\nu \\le 1$。给定的库朗数满足此条件。耗散为：\n$$\n\\delta_E(\\theta, \\nu) = -\\ln|G| = -\\frac{1}{2}\\ln|G|^2 = -\\frac{1}{2}\\ln\\left[1 - 2\\nu(1-\\nu)(1-\\cos\\theta)\\right]\n$$\n数值群速度 $c_{g,E}(\\theta, \\nu)$ 是 $d\\omega_R/dk$，其中 $\\omega_R$ 是频率 $\\omega$ 的实部。从色散关系可知，$\\omega_R = -\\arg(G)/\\Delta t$。对 $k$ 微分并使用 $\\theta=k\\Delta x$ 可得：\n$$\nc_{g,E}(\\theta, \\nu) = \\frac{d\\omega_R}{dk} = \\frac{d\\omega_R}{d\\theta}\\frac{d\\theta}{dk} = \\Delta x \\frac{d}{d\\theta}\\left(-\\frac{1}{\\Delta t} \\arg(G)\\right)\n$$\n一个更直接的方法是计算 $\\mathrm{Re}(d\\omega/dk)$。我们有 $\\omega = \\frac{i}{\\Delta t} \\ln G$。那么 $c_g = \\frac{d\\omega}{dk} = \\Delta x \\frac{d\\omega}{d\\theta} = \\frac{i \\Delta x}{\\Delta t} \\frac{1}{G}\\frac{dG}{d\\theta}$。其中 $\\frac{dG}{d\\theta} = -i\\nu e^{-i\\theta}$ 且 $\\frac{\\Delta x}{\\Delta t} = \\frac{c}{\\nu}$：\n$$\nc_g = c \\frac{e^{-i\\theta}}{1-\\nu+\\nu e^{-i\\theta}}\n$$\n物理群速度是这个复数量的实部：\n$$\nc_{g,E}(\\theta, \\nu) = \\mathrm{Re}\\left(c \\frac{e^{-i\\theta}(1-\\nu+\\nu e^{i\\theta})}{|G|^2}\\right) = c \\frac{\\cos\\theta(1-\\nu+\\nu\\cos\\theta) + \\nu\\sin^2\\theta}{|G|^2} = c \\frac{(1-\\nu)\\cos\\theta + \\nu}{|G|^2}\n$$\n设 $c=1$，群速度的最终表达式为：\n$$\nc_{g,E}(\\theta, \\nu) = \\frac{\\nu + (1-\\nu)\\cos\\theta}{1 - 2\\nu(1-\\nu)(1-\\cos\\theta)}\n$$\n相对群速度误差为 $\\varepsilon_{g,E}(\\theta, \\nu) = |c_{g,E}(\\theta, \\nu) - 1|$。\n\n### 拉格朗日格式：斯托默-韦尔莱（蛙跳）积分器\n\n对于由线性弹簧连接的一维质量链，第 $j$ 个质量元位移 $\\xi_j$ 的运动方程是：\n$$\n(\\rho_0 \\Delta x) \\ddot{\\xi}_j = k_s (\\xi_{j+1} - 2\\xi_j + \\xi_{j-1})\n$$\n其中 $k_s = \\rho_0 c^2 / \\Delta x$ 是在连续极限下重现声速 $c$ 的有效弹簧常数。这产生了半离散方程：\n$$\n\\ddot{\\xi}_j = \\frac{c^2}{(\\Delta x)^2} (\\xi_{j+1} - 2\\xi_j + \\xi_{j-1})\n$$\n应用二阶中心斯托默-韦尔莱（蛙跳）时间积分器，我们得到全离散方程：\n$$\n\\frac{\\xi_j^{n+1} - 2\\xi_j^n + \\xi_j^{n-1}}{(\\Delta t)^2} = \\frac{c^2}{(\\Delta x)^2}(\\xi_{j+1}^n - 2\\xi_j^n + \\xi_{j-1}^n)\n$$\n代入平面波拟设 $\\xi_j^n=A e^{i(j\\theta - n\\omega\\Delta t)}$：\n$$\n(e^{-i\\omega\\Delta t} - 2 + e^{i\\omega\\Delta t}) = \\nu^2 (e^{i\\theta} - 2 + e^{-i\\theta})\n$$\n使用恒等式 $2\\cos(x) = e^{ix}+e^{-ix}$，我们将其简化为：\n$$\n2\\cos(\\omega\\Delta t) - 2 = \\nu^2(2\\cos\\theta - 2)\n$$\n应用半角恒等式 $1-\\cos(x)=2\\sin^2(x/2)$：\n$$\n\\sin^2\\left(\\frac{\\omega\\Delta t}{2}\\right) = \\nu^2 \\sin^2\\left(\\frac{\\theta}{2}\\right)\n$$\n取正根得到离散色散关系：\n$$\n\\sin\\left(\\frac{\\omega\\Delta t}{2}\\right) = \\nu \\sin\\left(\\frac{\\theta}{2}\\right)\n$$\n由于要使格式稳定，$\\omega$ 必须是实数（当 $\\nu |\\sin(\\theta/2)| \\le 1$ 时成立），因此振幅没有指数衰减或增长。因此，该格式是非耗散的，每步耗散恒为零：$\\delta_L(\\theta, \\nu) = 0$。\n\n为了找到群速度 $c_{g,L} = d\\omega/dk$，我们对色散关系关于 $k$ 求导：\n$$\n\\cos\\left(\\frac{\\omega\\Delta t}{2}\\right) \\frac{\\Delta t}{2} \\frac{d\\omega}{dk} = \\nu \\cos\\left(\\frac{\\theta}{2}\\right) \\frac{\\Delta x}{2}\n$$\n解出 $c_{g,L} = d\\omega/dk$ 并使用 $\\nu = c\\Delta t/\\Delta x$：\n$$\nc_{g,L} = \\frac{\\nu \\Delta x}{\\Delta t} \\frac{\\cos(\\theta/2)}{\\cos(\\omega\\Delta t/2)} = c \\frac{\\cos(\\theta/2)}{\\cos(\\omega\\Delta t/2)}\n$$\n从色散关系，$\\cos(\\omega\\Delta t/2) = \\sqrt{1 - \\sin^2(\\omega\\Delta t/2)} = \\sqrt{1 - \\nu^2\\sin^2(\\theta/2)}$。将此代入群速度表达式并设 $c=1$：\n$$\nc_{g,L}(\\theta, \\nu) = \\frac{\\cos(\\theta/2)}{\\sqrt{1 - \\nu^2\\sin^2(\\theta/2)}}\n$$\n相对群速度误差为 $\\varepsilon_{g,L}(\\theta, \\nu) = |c_{g,L}(\\theta, \\nu) - 1|$。\n\n### 误差计算\n\n提供的 Python 代码将实现这些推导出的公式。函数 `dissipation_eulerian`、`group_velocity_eulerian` 和 `group_velocity_lagrangian` 将分别计算 $\\delta_E$、 $c_{g,E}$ 和 $c_{g,L}$。主函数 `solve` 遍历指定的库朗数 $\\nu \\in \\{0.3, 0.7, 0.95\\}$，并对每个 $\\nu$ 在无量纲波数集合 $\\theta \\in \\{0.2\\pi, 0.6\\pi, 0.9\\pi\\}$ 上评估耗散和群速度误差。找到每个误差度量在 $\\theta$ 集合上的最大值并存储。最后，按要求将结果格式化为单行文本。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes and compares numerical dispersion and dissipation for Eulerian\n    and Lagrangian schemes for 1D linear acoustics.\n    \"\"\"\n\n    # Test suite parameters\n    courant_numbers = [0.3, 0.7, 0.95]\n    thetas = [0.2 * np.pi, 0.6 * np.pi, 0.9 * np.pi]\n    c_sound = 1.0  # Nondimensional sound speed\n\n    def dissipation_eulerian(theta, nu):\n        \"\"\"\n        Computes the per-step dissipation for the first-order upwind Eulerian scheme.\n        delta = -0.5 * ln[1 - 2*nu*(1-nu)*(1-cos(theta))]\n        \"\"\"\n        # The scheme is stable for 0 = nu = 1.\n        # The argument of the log is 1 at theta=0 and decreases as theta increases.\n        # It reaches its minimum at theta=pi, where it is (1-2*nu)^2.\n        # Thus, the argument is always non-negative for nu in [0, 1].\n        term = 1.0 - 2.0 * nu * (1.0 - nu) * (1.0 - np.cos(theta))\n        return -0.5 * np.log(term)\n\n    def group_velocity_eulerian(theta, nu):\n        \"\"\"\n        Computes the numerical group velocity for the first-order upwind Eulerian scheme.\n        cg = c * (nu + (1-nu)*cos(theta)) / (1 - 2*nu*(1-nu)*(1-cos(theta)))\n        \"\"\"\n        numerator = nu + (1.0 - nu) * np.cos(theta)\n        denominator = 1.0 - 2.0 * nu * (1.0 - nu) * (1.0 - np.cos(theta))\n        return c_sound * numerator / denominator\n\n    def group_velocity_lagrangian(theta, nu):\n        \"\"\"\n        Computes the numerical group velocity for the Lagrangian leapfrog scheme.\n        cg = c * cos(theta/2) / sqrt(1 - nu^2 * sin(theta/2)^2)\n        \"\"\"\n        # Scheme is stable for nu = 1.\n        # The term under the square root is 1 - nu^2 * sin^2(theta/2).\n        # Since nu = 1 and sin^2 = 1, this term is always non-negative.\n        numerator = c_sound * np.cos(theta / 2.0)\n        denominator = np.sqrt(1.0 - nu**2 * np.sin(theta / 2.0)**2)\n        return numerator / denominator\n\n    results = []\n    \n    for nu in courant_numbers:\n        # ---- Eulerian Scheme ----\n        dissipations_E = [dissipation_eulerian(th, nu) for th in thetas]\n        max_dissipation_E = np.max(dissipations_E)\n        \n        gv_errors_E = [\n            np.abs(group_velocity_eulerian(th, nu) / c_sound - 1.0) for th in thetas\n        ]\n        max_gv_error_E = np.max(gv_errors_E)\n\n        # ---- Lagrangian Scheme ----\n        # Dissipation is analytically zero for the leapfrog scheme.\n        max_dissipation_L = 0.0\n        \n        gv_errors_L = [\n            np.abs(group_velocity_lagrangian(th, nu) / c_sound - 1.0) for th in thetas\n        ]\n        max_gv_error_L = np.max(gv_errors_L)\n        \n        # Append results in specified order for the current nu\n        results.extend([\n            max_dissipation_E,\n            max_dissipation_L,\n            max_gv_error_E,\n            max_gv_error_L\n        ])\n\n    # Format the final output string\n    formatted_results = [f\"{res:.6f}\" for res in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```"
        }
    ]
}