{
    "hands_on_practices": [
        {
            "introduction": "The conversion from conserved to primitive variables is a routine yet critical operation in computational hydrodynamics. This first exercise  provides practice with the direct algebraic inversion for a simple ideal gas. By starting from the definitions of conserved quantities, you will recover the pressure and sound speed, reinforcing the fundamental relationships and the importance of verifying the physical admissibility of a numerical state.",
            "id": "3530060",
            "problem": "Consider a three-dimensional Newtonian compressible ideal gas governed by the Euler equations. The conserved variables are the mass density, the momentum density vector, and the total energy density, denoted by $U = (\\rho, \\mathbf{m}, E)$. The primitive variables are the mass density, the velocity vector, and the pressure, denoted by $(\\rho, \\mathbf{v}, p)$. For an ideal gas with adiabatic index $\\gamma$, the internal energy per unit mass, $e$, and the pressure, $p$, are related by the ideal gas closure. The adiabatic sound speed $c_{s}$ is determined by local thermodynamic state through linearization of the equations about a uniform state.\n\nYou are given the numerical state\n$$\n\\rho = 3.0 \\times 10^{-19}, \\quad \\mathbf{m} = \\left(6.0 \\times 10^{-15},\\,-4.0 \\times 10^{-15},\\,2.0 \\times 10^{-15}\\right), \\quad E = 6.0 \\times 10^{-10},\n$$\nand the adiabatic index\n$$\n\\gamma = \\frac{5}{3}.\n$$\nAll quantities are in the International System of Units (SI): $\\rho$ in $\\mathrm{kg\\,m^{-3}}$, $\\mathbf{m}$ in $\\mathrm{kg\\,m^{-2}\\,s^{-1}}$, and $E$ in $\\mathrm{J\\,m^{-3}}$. The ideal gas closure and the standard definitions of conserved and primitive variables apply.\n\nTask:\n- Starting from the conservation-law definitions of $U$ and the ideal gas closure between $e$ and $p$, invert to obtain the pressure $p$ and the adiabatic sound speed $c_{s}$ for the given state.\n- Explicitly compute $p$ and $c_{s}$ and verify the positivity and admissibility conditions, including $p > 0$, $\\rho > 0$, and $c_{s}^{2} \\ge 0$; comment on the necessary condition on the total energy density for admissibility in terms of the kinetic energy density.\n- Express $p$ in Pascal and $c_{s}$ in $\\mathrm{km\\,s^{-1}}$, and round each to four significant figures.\n\nYour final reported answer must be the pair $(p, c_{s})$.",
            "solution": "The problem asks for the conversion from conserved variables to primitive variables for a state governed by the Euler equations for a compressible ideal gas. We are given the conserved state vector $U = (\\rho, \\mathbf{m}, E)$ and the adiabatic index $\\gamma$, and are tasked with finding the pressure $p$ and the adiabatic sound speed $c_s$.\n\nThe conserved variables are the mass density $\\rho$, the momentum density vector $\\mathbf{m}$, and the total energy density $E$. The primitive variables are the mass density $\\rho$, the fluid velocity vector $\\mathbf{v}$, and the pressure $p$. The relationship between these sets of variables is defined as follows:\n1.  Mass density $\\rho$ is common to both sets.\n2.  The momentum density is defined as $\\mathbf{m} = \\rho \\mathbf{v}$.\n3.  The total energy density $E$ is the sum of the kinetic energy density and the internal energy density: $E = E_{\\text{kin}} + E_{\\text{int}}$.\n    The kinetic energy density is given by $E_{\\text{kin}} = \\frac{1}{2}\\rho |\\mathbf{v}|^2$.\n    The internal energy density is given by $E_{\\text{int}} = \\rho e$, where $e$ is the specific internal energy (internal energy per unit mass).\n\nFor an ideal gas, the pressure $p$ is related to the internal energy density through the equation of state:\n$p = (\\gamma - 1) E_{\\text{int}} = (\\gamma - 1) \\rho e$.\n\nOur first step is to express the pressure $p$ in terms of the given conserved quantities. From the definition of momentum density, the velocity is $\\mathbf{v} = \\frac{\\mathbf{m}}{\\rho}$. Substituting this into the expression for kinetic energy density gives:\n$$\nE_{\\text{kin}} = \\frac{1}{2}\\rho \\left|\\frac{\\mathbf{m}}{\\rho}\\right|^2 = \\frac{1}{2}\\rho \\frac{|\\mathbf{m}|^2}{\\rho^2} = \\frac{|\\mathbf{m}|^2}{2\\rho}\n$$\nThe internal energy density $E_{\\text{int}}$ can then be found by subtracting the kinetic energy density from the total energy density:\n$$\nE_{\\text{int}} = E - E_{\\text{kin}} = E - \\frac{|\\mathbf{m}|^2}{2\\rho}\n$$\nNow, we can use the ideal gas equation of state to find the pressure:\n$$\np = (\\gamma - 1) E_{\\text{int}} = (\\gamma - 1) \\left(E - \\frac{|\\mathbf{m}|^2}{2\\rho}\\right)\n$$\nThis equation allows us to compute the pressure $p$ from the given conserved variables.\n\nBefore performing the calculation, we address the issue of physical admissibility. A state is considered physically admissible if both the density and pressure are positive: $\\rho > 0$ and $p > 0$. The density is given as $\\rho = 3.0 \\times 10^{-19} \\, \\mathrm{kg\\,m^{-3}}$, which is positive. For the pressure to be positive, since $\\gamma = \\frac{5}{3} > 1$, the term $(\\gamma - 1)$ is positive. Therefore, the condition $p > 0$ requires that the internal energy density be positive, which means $E - \\frac{|\\mathbf{m}|^2}{2\\rho} > 0$. This implies a necessary condition on the total energy density: it must be strictly greater than the kinetic energy density, $E > E_{\\text{kin}}$.\n\nWe now proceed with the numerical calculation. The given values are:\n$\\rho = 3.0 \\times 10^{-19}$\n$\\mathbf{m} = \\left(6.0 \\times 10^{-15},\\,-4.0 \\times 10^{-15},\\,2.0 \\times 10^{-15}\\right)$\n$E = 6.0 \\times 10^{-10}$\n$\\gamma = \\frac{5}{3}$\n\nFirst, we calculate the squared magnitude of the momentum density vector:\n$$\n|\\mathbf{m}|^2 = (6.0 \\times 10^{-15})^2 + (-4.0 \\times 10^{-15})^2 + (2.0 \\times 10^{-15})^2\n$$\n$$\n|\\mathbf{m}|^2 = (36 \\times 10^{-30}) + (16 \\times 10^{-30}) + (4.0 \\times 10^{-30}) = (36 + 16 + 4) \\times 10^{-30} = 56 \\times 10^{-30} = 5.6 \\times 10^{-29}\n$$\nThe units are $(\\mathrm{kg\\,m^{-2}\\,s^{-1}})^2$.\n\nNext, we calculate the kinetic energy density, $E_{\\text{kin}}$:\n$$\nE_{\\text{kin}} = \\frac{|\\mathbf{m}|^2}{2\\rho} = \\frac{5.6 \\times 10^{-29}}{2 \\times (3.0 \\times 10^{-19})} = \\frac{5.6}{6.0} \\times 10^{-10} = \\frac{14}{15} \\times 10^{-10} \\approx 0.9333 \\times 10^{-10} \\, \\mathrm{J\\,m^{-3}}\n$$\nWe check the admissibility condition: $E = 6.0 \\times 10^{-10}$ and $E_{\\text{kin}} \\approx 0.9333 \\times 10^{-10}$. Since $E > E_{\\text{kin}}$, the pressure will be positive, and the state is physically admissible.\n\nNow we compute the pressure $p$:\n$$\np = \\left(\\frac{5}{3} - 1\\right) \\left(6.0 \\times 10^{-10} - \\frac{14}{15} \\times 10^{-10}\\right)\n$$\n$$\np = \\frac{2}{3} \\left(6.0 - \\frac{14}{15}\\right) \\times 10^{-10} = \\frac{2}{3} \\left(\\frac{90 - 14}{15}\\right) \\times 10^{-10} = \\frac{2}{3} \\left(\\frac{76}{15}\\right) \\times 10^{-10}\n$$\n$$\np = \\frac{152}{45} \\times 10^{-10} \\approx 3.3777... \\times 10^{-10} \\, \\mathrm{Pa}\n$$\nRounding to four significant figures, we get $p = 3.378 \\times 10^{-10} \\, \\mathrm{Pa}$.\n\nNext, we calculate the adiabatic sound speed $c_s$. For an ideal gas, the square of the sound speed is given by:\n$$\nc_s^2 = \\frac{\\gamma p}{\\rho}\n$$\nAdmissibility requires $c_s^2 \\ge 0$. Since $\\gamma > 0$, $\\rho > 0$, and we have found $p > 0$, this condition is satisfied.\nSubstituting the values for $\\gamma$, $p$, and $\\rho$:\n$$\nc_s^2 = \\frac{\\frac{5}{3} \\times \\left(\\frac{152}{45} \\times 10^{-10}\\right)}{3.0 \\times 10^{-19}} = \\frac{5 \\times 152}{3 \\times 45 \\times 3.0} \\times 10^9 = \\frac{760}{405} \\times 10^9 = \\frac{152}{81} \\times 10^9\n$$\n$c_s^2 \\approx 1.87654... \\times 10^9 \\, (\\mathrm{m/s})^2$.\n\nThe sound speed $c_s$ is the square root of this value:\n$$\nc_s = \\sqrt{\\frac{152}{81} \\times 10^9} \\approx \\sqrt{1.87654... \\times 10^9} \\approx 43319.086... \\, \\mathrm{m\\,s^{-1}}\n$$\nThe problem asks for $c_s$ in units of $\\mathrm{km\\,s^{-1}}$.\n$$\nc_s \\approx 43.319086... \\, \\mathrm{km\\,s^{-1}}\n$$\nRounding to four significant figures, we get $c_s = 43.32 \\, \\mathrm{km\\,s^{-1}}$.\n\nThe final answer is the pair $(p, c_s)$, with $p$ in Pascals and $c_s$ in $\\mathrm{km\\,s^{-1}}$, rounded to four significant figures.\n$p \\approx 3.378 \\times 10^{-10} \\, \\mathrm{Pa}$\n$c_s \\approx 43.32 \\, \\mathrm{km\\,s^{-1}}$",
            "answer": "$$\n\\boxed{(3.378 \\times 10^{-10}, 43.32)}\n$$"
        },
        {
            "introduction": "While algebraically straightforward, the direct inversion from total energy to pressure is notoriously fragile in high-Mach number flows. This thought experiment  illuminates the problem of catastrophic cancellation, where subtracting two large, nearly-equal numbers (total and kinetic energy) leads to a severe loss of precision in the small remainder (internal energy). By comparing the pressure derived from total energy with a more stable value derived from an entropy tracer, you will diagnose the numerical inconsistency and understand the motivation for advanced 'dual-energy' schemes.",
            "id": "3530106",
            "problem": "Consider a three-dimensional compressible fluid governed by the Euler equations and an ideal-gas equation of state (EOS), with adiabatic index $\\gamma = \\frac{5}{3}$. The conserved state vector is augmented to include an advected entropy tracer, so that the stored variables are\n$$\n\\boldsymbol{U} = \\left( \\rho,\\, \\rho v_{x},\\, \\rho v_{y},\\, \\rho v_{z},\\, E,\\, S \\right),\n$$\nwhere $\\rho$ is the mass density, $\\rho \\boldsymbol{v}$ is the momentum density, $E$ is the total energy density, and $S$ is an entropy-derived scalar tracer consistent with ideal-gas thermodynamics. The tracer $S$ is constructed from the specific entropy per unit mass $s$ via the ideal-gas fundamental relation $s/c_{v} = \\ln(p) - \\gamma \\ln(\\rho) + \\text{constant}$, where $c_{v}$ is the specific heat at constant volume, and the tracer is normalized so that $S = \\exp\\!\\left(s/c_{v}\\right)$ corresponds to $S = p \\rho^{-\\gamma}$ in smooth adiabatic flow.\n\nYou are given the following high-Mach test state (in non-dimensional code units):\n$$\n\\rho = 1,\\quad \\rho v_{x} = 100,\\quad \\rho v_{y} = 0,\\quad \\rho v_{z} = 0,\\quad E = 5004.0,\\quad S = 3.0.\n$$\n\nUsing only fundamental definitions and the ideal-gas EOS, compute the pressure $p$ in two ways:\n1. From the entropy tracer $S$ and density $\\rho$.\n2. From inversion of the total energy $E$ and momentum $\\rho \\boldsymbol{v}$.\n\nThen, quantify the relative discrepancy between the two pressures as\n$$\n\\delta = \\frac{|p_{S} - p_{E}|}{p_{S}},\n$$\nwhere $p_{S}$ is the pressure reconstructed from $S$ and $\\rho$, and $p_{E}$ is the pressure obtained from total-energy inversion. Round your final value of $\\delta$ to four significant figures. Additionally, explain which pressure value should be accepted for this state and why, based on first-principles reasoning and numerical stability considerations, but provide only the numerical value of $\\delta$ in your final answer.",
            "solution": "The problem requires the computation of pressure from a given conserved state vector using two different methods, followed by a comparison of the results and a critical evaluation of their validity. The fluid is governed by the Euler equations with an ideal-gas equation of state.\n\nThe conserved state vector is given as $\\boldsymbol{U} = \\left( \\rho, \\rho v_{x}, \\rho v_{y}, \\rho v_{z}, E, S \\right)$. The given values in non-dimensional code units are:\n- Mass density: $\\rho = 1$\n- Momentum densities: $\\rho v_{x} = 100$, $\\rho v_{y} = 0$, $\\rho v_{z} = 0$\n- Total energy density: $E = 5004.0$\n- Entropy tracer: $S = 3.0$\nThe adiabatic index is given as $\\gamma = \\frac{5}{3}$.\n\nFirst, we will calculate the pressure $p_S$ using the entropy tracer $S$. The problem states that the tracer is normalized such that $S = p \\rho^{-\\gamma}$, where $p$ is the pressure. Rearranging this expression for $p$ gives:\n$$\np_{S} = S \\rho^{\\gamma}\n$$\nSubstituting the given values $\\rho = 1$ and $S = 3.0$, and using $\\gamma = \\frac{5}{3}$:\n$$\np_{S} = (3.0) \\times (1)^{\\frac{5}{3}} = 3.0\n$$\n\nSecond, we will calculate the pressure $p_E$ by inverting the total energy density $E$. The total energy density is the sum of the kinetic energy density and the internal energy density, $e$:\n$$\nE = \\frac{1}{2}\\rho v^2 + e\n$$\nwhere $v^2 = v_x^2 + v_y^2 + v_z^2$ is the square of the fluid velocity. For an ideal gas, the internal energy density is related to the pressure by:\n$$\ne = \\frac{p}{\\gamma - 1}\n$$\nCombining these two equations allows us to express pressure in terms of $E$, $\\rho$, and $\\boldsymbol{v}$:\n$$\np_{E} = (\\gamma - 1) \\left( E - \\frac{1}{2}\\rho v^2 \\right)\n$$\nTo use this formula, we first need to compute the velocity components from the given mass and momentum densities:\n$$\nv_x = \\frac{\\rho v_x}{\\rho} = \\frac{100}{1} = 100\n$$\n$$\nv_y = \\frac{\\rho v_y}{\\rho} = \\frac{0}{1} = 0\n$$\n$$\nv_z = \\frac{\\rho v_z}{\\rho} = \\frac{0}{1} = 0\n$$\nThe squared velocity magnitude is $v^2 = 100^2 + 0^2 + 0^2 = 10000$.\nThe kinetic energy density is therefore:\n$$\nE_{\\text{kin}} = \\frac{1}{2}\\rho v^2 = \\frac{1}{2} \\times 1 \\times 10000 = 5000\n$$\nNow, we find the internal energy density $e$ by subtracting the kinetic energy density from the total energy density:\n$$\ne = E - E_{\\text{kin}} = 5004.0 - 5000 = 4.0\n$$\nFinally, we calculate the pressure $p_E$ using the ideal-gas relation. With $\\gamma = \\frac{5}{3}$, the term $(\\gamma - 1)$ is $(\\frac{5}{3} - 1) = \\frac{2}{3}$.\n$$\np_{E} = e(\\gamma - 1) = 4.0 \\times \\frac{2}{3} = \\frac{8.0}{3}\n$$\n\nThird, we compute the relative discrepancy $\\delta$ between the two pressure values:\n$$\n\\delta = \\frac{|p_{S} - p_{E}|}{p_{S}}\n$$\nSubstituting the calculated values $p_S = 3.0$ and $p_E = \\frac{8.0}{3}$:\n$$\n\\delta = \\frac{\\left| 3.0 - \\frac{8.0}{3} \\right|}{3.0} = \\frac{\\left| \\frac{9.0}{3} - \\frac{8.0}{3} \\right|}{3.0} = \\frac{\\frac{1.0}{3}}{3.0} = \\frac{1}{9}\n$$\nAs a decimal, $\\delta = 0.1111\\overline{1}$. Rounding to four significant figures gives $\\delta = 0.1111$.\n\nFinally, we must determine which pressure value, $p_S$ or $p_E$, should be accepted for this state. The discrepancy between $p_S$ and $p_E$ reveals an internal inconsistency in the provided state vector $\\boldsymbol{U}$ when interpreted under the ideal gas model. Such inconsistencies are common in numerical simulations due to discretization and floating-point arithmetic errors. The core of the question is to identify which calculation is more robust.\n\nThe calculation of $p_E$ involves the subtraction of two large numbers to find a small one: $e = E - E_{\\text{kin}} = 5004.0 - 5000$. The flow is clearly in a high-Mach number regime, where the kinetic energy ($E_{\\text{kin}} = 5000$) vastly dominates the internal energy ($e \\approx 4.0$). In floating-point arithmetic, this subtraction is subject to catastrophic cancellation, which can lead to a severe loss of relative precision in the result for $e$. A minute error in either $E$ or $E_{\\text{kin}}$ (arising from how they are stored or evolved numerically) can translate into a very large relative error in $e$ and, consequently, in $p_E$. This is a well-known problem in computational fluid dynamics, often termed the \"total energy catastrophe.\"\n\nIn contrast, the calculation of $p_S$ uses the formula $p_S = S \\rho^{\\gamma}$. The quantities $S$ and $\\rho$ are advected scalars. For the given state, they are numbers of order unity ($S=3.0$, $\\rho=1$). The calculation involves only multiplication and exponentiation of these well-behaved values, a process that is numerically stable and not prone to catastrophic cancellation.\n\nTherefore, for a high-Mach number state such as this, the pressure $p_S$ derived from the entropy tracer is far more reliable and numerically robust than the pressure $p_E$ derived from the total energy. Modern astrophysical codes often employ \"dual-energy\" schemes for this reason: they evolve both $E$ and an entropy-like variable, using the latter to compute pressure in highly supersonic regions to avoid the precision issues associated with the total energy formulation. Thus, the pressure value $p_S = 3.0$ should be accepted as the more accurate representation for this physical state. The value of $E = 5004.0$ in the state vector is inconsistent with the other variables, as a consistent total energy would be $E' = E_{\\text{kin}} + \\frac{p_S}{\\gamma - 1} = 5000 + \\frac{3.0}{2/3} = 5000 + 4.5 = 5004.5$. The given $E$ is off by approximately $0.01\\%$, but this small error causes an error of over $11\\%$ in the computed pressure $p_E$.",
            "answer": "$$\n\\boxed{0.1111}\n$$"
        },
        {
            "introduction": "Having diagnosed the failure of naive pressure recovery, the next logical step is to implement a solution. This hands-on coding practice  guides you through the construction of a 'dual-energy' safeguard, a cornerstone of modern hydrodynamics codes. You will implement a scheme that dynamically switches between the total-energy-based and entropy-based pressure calculations, learning how to create robust algorithms that maintain accuracy across diverse physical regimes, from subsonic to highly supersonic flows.",
            "id": "3530055",
            "problem": "Consider an ideal, inviscid, non-relativistic hydrodynamic fluid modeled in one spatial dimension with the Euler equations. The standard computational practice in astrophysical simulations uses a set of conserved variables and converts them to primitive variables for reconstructions and flux computations. Let the mass density be denoted by $\\rho$, the velocity by $u$, and the pressure by $p$. The conserved variables are the mass density $D$, the momentum density $S$, and the total energy density $E$. The canonical conversion pathway from conserved to primitive variables for an ideal gas with adiabatic index $\\gamma$ recovers the pressure from total energy by first isolating the internal energy density. The fundamental base to use is the ideal-gas equation of state and the decomposition of the total energy density into internal and kinetic parts. Additionally, the entropy function is defined for adiabatic flows and serves as a potential auxiliary variable in numerical schemes.\n\nYour task is to write a complete and runnable program that, for a given test suite, evaluates the impact of floating-point roundoff on pressure recovery when the kinetic energy dominates the total energy and then implements a dual-energy safeguard that switches to an entropy-based pressure recovery when a certain dimensionless diagnostic indicates that the internal energy is a small fraction of the total. You must proceed from first principles of the decomposition of the total energy density and the ideal-gas law. Explicitly:\n\n- Work in dimensionless code units (that is, all quantities are to be treated as dimensionless).\n- Use double-precision floating-point numbers (IEEE $754$ binary$64$).\n- Base your derivations only on the following fundamental laws and definitions:\n    1. The ideal-gas equation of state: the internal energy density $e$ satisfies $p = (\\gamma - 1) e$.\n    2. The decomposition of total energy density as the sum of internal and kinetic energies: $E = e + E_{\\text{kin}}$, where $E_{\\text{kin}}$ is the kinetic energy density.\n    3. The definitions of conserved variables: $D = \\rho$, $S = \\rho u$, and $E$ as stated above.\n    4. The entropy function $A$ defined for an ideal gas by $A = p \\rho^{-\\gamma}$, which is advected in smooth, adiabatic regions.\n\nYou must not assume nor use any formulas beyond the above foundational definitions in your reasoning to construct your algorithm. The diagnostic to trigger the safeguard must be derived from these definitions to quantify the fraction of the total energy that is internal. Design the safeguard as follows: when the diagnostic falls below a chosen threshold, recover $p$ from the entropy function $A$; otherwise, recover $p$ by subtracting kinetic energy from total energy and applying the ideal-gas relation.\n\nTo assess floating-point roundoff, perturb the total energy $E$ by a multiplicative factor $(1 + \\delta)$ where $\\delta$ is a small prescribed number meant to mimic representation error, and then recover the pressure via both the naive subtraction pathway and the dual-energy safeguard. Quantify the error in the recovered pressure as the absolute relative error, defined as $|p_{\\text{approx}} - p_{\\text{true}}| / p_{\\text{true}}$, where $p_{\\text{true}}$ is the pressure used to construct the conserved state before perturbation.\n\nImplement the following test suite, each case expressed in dimensionless code units with adiabatic index $\\gamma = 5/3$:\n\n- Case $1$ (strong kinetic dominance, small internal fraction):\n    - $\\rho = 1.0$, $u = 1000.0$, $p = 1.0$, $\\gamma = 5/3$, threshold $= 10^{-3}$, perturbation $\\delta = +10^{-15}$.\n- Case $2$ (moderate kinetic energy):\n    - $\\rho = 1.0$, $u = 10.0$, $p = 10.0$, $\\gamma = 5/3$, threshold $= 10^{-3}$, perturbation $\\delta = +10^{-15}$.\n- Case $3$ (boundary triggering value; choose $p$ so that the diagnostic equals the threshold):\n    - $\\rho = 1.0$, $u = 100.0$, $\\gamma = 5/3$, threshold $= 10^{-3}$; choose $p$ such that the internal energy fraction equals $10^{-3}$ using the ideal-gas relation and energy decomposition.\n- Case $4$ (extreme cancellation leading to negative internal energy under perturbation in naive subtraction):\n    - $\\rho = 1.0$, $u = 10^{5}$, choose $p$ such that the internal energy density $e$ is $10^{-3}$, $\\gamma = 5/3$, threshold $= 10^{-3}$, perturbation $\\delta = -10^{-12}$.\n- Case $5$ (low Mach number, internal energy dominance):\n    - $\\rho = 1.0$, $u = 0.01$, $p = 1.0$, $\\gamma = 5/3$, threshold $= 10^{-3}$, perturbation $\\delta = +10^{-15}$.\n\nFor each case:\n- Construct the conserved variables $D$, $S$, and $E$ from the given $\\rho$, $u$, and $p$ using the foundational definitions.\n- Compute the entropy function $A$ from $p$ and $\\rho$.\n- Perturb the total energy to $E_{\\text{pert}} = E (1 + \\delta)$.\n- Recover $p$ naively from $E_{\\text{pert}}$ by subtracting kinetic energy and applying the ideal-gas relation.\n- Derive from first principles a dimensionless diagnostic that quantifies the fraction of the total energy that is internal, and compute it for the perturbed state.\n- Recover $p$ via the dual-energy safeguard: if the diagnostic is below the threshold, use the entropy pathway; otherwise use the naive pathway.\n- Compute the diagnostic value, the naive absolute relative error, the dual-energy absolute relative error, and a boolean indicating whether the entropy pathway was used.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each element corresponds to one case and is itself a list with four entries: the diagnostic value, the naive absolute relative error, the dual-energy absolute relative error, and a boolean indicating whether the entropy pathway was used for that case. The final output should therefore be of the form $[ [d_{1}, r^{\\text{naive}}_{1}, r^{\\text{dual}}_{1}, b_{1}], [d_{2}, r^{\\text{naive}}_{2}, r^{\\text{dual}}_{2}, b_{2}], \\ldots ]$.\n\nAll numerical answers should be floats or booleans. Angle units are not applicable. No physical units are used beyond the declared dimensionless code units. Ensure scientific realism by keeping all values finite and non-negative where physically required. The program must not read external input and must run as-is.",
            "solution": "The problem is validated as scientifically grounded, well-posed, and objective. It addresses a fundamental numerical challenge in computational astrophysicsâ€”the recovery of primitive variables from conserved variables, particularly in flows where kinetic energy vastly exceeds internal energy. The proposed dual-energy formalism is a standard and correct technique for mitigating catastrophic cancellation errors in such regimes. All provided definitions and test cases are internally consistent and sufficient for deriving a unique solution.\n\nThe solution is constructed by first deriving the necessary physical and mathematical relationships from the provided first principles.\n\n**1. Fundamental Quantities and Relationships**\n\nThe state of the fluid is described by primitive variables: mass density $\\rho$, velocity $u$, and pressure $p$. For numerical evolution using finite-volume methods, it is advantageous to use conserved variables: mass density $D$, momentum density $S$, and total energy density $E$. The relationships between these sets of variables are derived from fundamental definitions.\n\n- Mass Density: The conserved mass density is identical to the primitive mass density.\n$$D = \\rho$$\n- Momentum Density: The momentum per unit volume is the product of mass density and velocity.\n$$S = \\rho u$$\n- Total Energy Density: The total energy density $E$ is the sum of the internal energy density $e$ and the kinetic energy density $E_{\\text{kin}}$.\n$$E = e + E_{\\text{kin}}$$\nThe ideal-gas equation of state provides the relationship between internal energy and pressure for an adiabatic index $\\gamma$:\n$$p = (\\gamma - 1)e \\implies e = \\frac{p}{\\gamma-1}$$\nThe kinetic energy density is the kinetic energy per unit volume:\n$$E_{\\text{kin}} = \\frac{1}{2}\\rho u^2$$\nUsing the definitions of $D$ and $S$, we can express $E_{\\text{kin}}$ in terms of conserved variables:\n$$u = \\frac{S}{D} \\implies E_{\\text{kin}} = \\frac{1}{2} D \\left(\\frac{S}{D}\\right)^2 = \\frac{S^2}{2D}$$\nTherefore, the total energy density can be written as:\n$$E = \\frac{p}{\\gamma-1} + \\frac{1}{2}\\rho u^2$$\n\n- Entropy Function: An auxiliary quantity, the entropy function $A$, is defined as:\n$$A = p \\rho^{-\\gamma}$$\nIn smooth, adiabatic flow, $A$ is constant along fluid particle paths and can be advected as if it were a conserved quantity.\n\n**2. Pressure Recovery Algorithms**\n\nThe core task is to recover the primitive variables $(\\rho, u, p)$ from the conserved state $(D, S, E)$. The recovery of $\\rho$ and $u$ is straightforward: $\\rho=D$ and $u=S/D$. The challenge lies in recovering $p$.\n\n**2.1. Naive Pressure Recovery from Total Energy**\n\nThis method directly inverts the definition of total energy.\nFirst, the internal energy density $e_{\\text{naive}}$ is computed by subtracting the kinetic energy density from the total energy density:\n$$e_{\\text{naive}} = E - E_{\\text{kin}} = E - \\frac{S^2}{2D}$$\nThen, the pressure is found using the ideal-gas relation:\n$$p_{\\text{naive}} = (\\gamma - 1) e_{\\text{naive}} = (\\gamma - 1) \\left(E - \\frac{S^2}{2D}\\right)$$\nThe weakness of this method emerges when the flow is kinetically dominated, i.e., $E_{\\text{kin}} \\gg e$. In this case, $E \\approx E_{\\text{kin}}$, and the subtraction $E - S^2/(2D)$ is subject to catastrophic cancellation due to floating-point representation errors. A small relative error in $E$ can become a large relative error in $e$, potentially yielding a non-physical negative pressure.\n\n**2.2. Pressure Recovery from Entropy**\n\nThis method utilizes the advected entropy function $A$. By rearranging its definition, pressure can be recovered directly:\n$$p_{\\text{entropy}} = A \\rho^{\\gamma} = A D^{\\gamma}$$\nThis calculation does not involve the subtraction of two large, nearly equal numbers and is therefore numerically robust even when internal energy is a minute fraction of the total energy.\n\n**3. Dual-Energy Safeguard Design**\n\nThe dual-energy safeguard combines the two methods, applying each in the regime where it is most accurate. A diagnostic trigger is required to select the appropriate method.\n\n**3.1. The Diagnostic Trigger**\n\nThe problem requires a dimensionless diagnostic that quantifies the fraction of total energy that is internal. Given a conserved state $(D, S, E)$, the \"recovered\" internal energy is $e_{\\text{rec}} = E - S^2/(2D)$. The ratio of this internal energy to the total energy provides a suitable diagnostic, which we denote by $\\eta$:\n$$\\eta = \\frac{e_{\\text{rec}}}{E} = \\frac{E - S^2/(2D)}{E}$$\nThis diagnostic can be computed directly from the conserved state at each point in the simulation. When $\\eta$ is small, it indicates that the flow is kinetically dominated and the naive subtraction is unreliable.\n\n**3.2. The Safeguard Algorithm**\n\nGiven a conserved state $(D, S, E)$, the advected entropy function $A$, and a pre-defined threshold $\\theta$:\n1. Compute the diagnostic: $\\eta = (E - S^2/(2D)) / E$.\n2. Compare $\\eta$ with the threshold $\\theta$.\n3. If $\\eta  \\theta$:\n   The flow is kinetically dominated. Use the entropy pathway: $p = A D^{\\gamma}$.\n4. Else:\n   The flow is not kinetically dominated. The naive pathway is safe: $p = (\\gamma - 1)(E - S^2/(2D))$.\n\n**4. Test Suite Analysis and Setup**\n\nThe analysis is performed by first constructing a \"true\" conserved state from given primitive variables $(\\rho_{\\text{true}}, u_{\\text{true}}, p_{\\text{true}})$, perturbing the total energy $E_{\\text{true}}$ to get $E_{\\text{pert}} = E_{\\text{true}}(1+\\delta)$, and then attempting to recover $p$ using both the naive and dual-energy methods. The error is quantified by the absolute relative error: $|p_{\\text{approx}} - p_{\\text{true}}| / p_{\\text{true}}$.\n\nFor each case, we first establish the true state $(\\rho_{\\text{true}}, u_{\\text{true}}, p_{\\text{true}})$ and the adiabatic index $\\gamma = 5/3$.\n\n- **Case 3 Setup**: We are given $\\rho_{\\text{true}}=1.0$, $u_{\\text{true}}=100.0$, and the condition that the true internal energy fraction $e_{\\text{true}}/E_{\\text{true}}$ equals the threshold $\\theta = 10^{-3}$.\nThe kinetic energy density is $E_{\\text{kin,true}} = \\frac{1}{2}\\rho_{\\text{true}} u_{\\text{true}}^2 = \\frac{1}{2}(1.0)(100.0)^2 = 5000.0$.\nThe condition is $e_{\\text{true}} / (e_{\\text{true}} + E_{\\text{kin,true}}) = \\theta$.\n$$ \\frac{e_{\\text{true}}}{e_{\\text{true}} + 5000.0} = 10^{-3} \\implies e_{\\text{true}} = 10^{-3}(e_{\\text{true}} + 5000.0) $$\n$$ e_{\\text{true}}(1 - 10^{-3}) = 5.0 \\implies e_{\\text{true}} = \\frac{5.0}{0.999} $$\nThe pressure is then $p_{\\text{true}} = (\\gamma - 1)e_{\\text{true}} = (5/3 - 1) \\frac{5.0}{0.999} = \\frac{10.0}{2.997}$.\n\n- **Case 4 Setup**: We are given $\\rho_{\\text{true}}=1.0$, $u_{\\text{true}}=10^5$, and $e_{\\text{true}}=10^{-3}$.\nThe pressure is directly computed as $p_{\\text{true}} = (\\gamma - 1)e_{\\text{true}} = (5/3 - 1)(10^{-3}) = \\frac{2}{3} \\times 10^{-3}$.\n\nThe provided Python code will implement this logic for all five test cases, calculating the diagnostic value, the error from the naive method, the error from the dual-energy method, and whether the entropy-based safeguard was triggered for each case.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements and tests a dual-energy safeguard for pressure recovery in\n    computational hydrodynamics based on the Euler equations for an ideal gas.\n    \"\"\"\n    gamma = 5.0 / 3.0\n\n    # Define the test cases. Case 3 and 4 require pre-calculation of pressure.\n    \n    # Case 3: Calculate p_true such that e/E = threshold\n    rho3, u3, threshold3 = 1.0, 100.0, 1e-3\n    e_kin3 = 0.5 * rho3 * u3**2\n    # e / (e + e_kin) = threshold = e = threshold * e_kin / (1 - threshold)\n    e3_true = threshold3 * e_kin3 / (1 - threshold3)\n    p3_true = (gamma - 1) * e3_true\n    \n    # Case 4: Calculate p_true from given e_true\n    e4_true = 1e-3\n    p4_true = (gamma - 1) * e4_true\n\n    test_cases_data = [\n        # Case 1 (strong kinetic dominance)\n        {\"rho\": 1.0, \"u\": 1000.0, \"p\": 1.0, \"threshold\": 1e-3, \"delta\": 1e-15},\n        # Case 2 (moderate kinetic energy)\n        {\"rho\": 1.0, \"u\": 10.0, \"p\": 10.0, \"threshold\": 1e-3, \"delta\": 1e-15},\n        # Case 3 (boundary triggering value)\n        {\"rho\": rho3, \"u\": u3, \"p\": p3_true, \"threshold\": threshold3, \"delta\": 1e-15},\n        # Case 4 (extreme cancellation)\n        {\"rho\": 1.0, \"u\": 1e5, \"p\": p4_true, \"threshold\": 1e-3, \"delta\": -1e-12},\n        # Case 5 (low Mach number)\n        {\"rho\": 1.0, \"u\": 0.01, \"p\": 1.0, \"threshold\": 1e-3, \"delta\": 1e-15},\n    ]\n\n    results = []\n    for case in test_cases_data:\n        rho_true = case[\"rho\"]\n        u_true = case[\"u\"]\n        p_true = case[\"p\"]\n        threshold = case[\"threshold\"]\n        delta = case[\"delta\"]\n\n        # 1. Construct the true conserved state and entropy function\n        e_true = p_true / (gamma - 1.0)\n        e_kin_true = 0.5 * rho_true * u_true**2\n        \n        D = rho_true\n        S = rho_true * u_true\n        E_true = e_true + e_kin_true\n        \n        # The entropy function A = p * rho^(-gamma)\n        A = p_true * rho_true**(-gamma)\n\n        # 2. Perturb the total energy\n        E_pert = E_true * (1.0 + delta)\n\n        # Pre-compute kinetic energy term from conserved state (remains unchanged)\n        S_sq_over_2D = S**2 / (2.0 * D)\n\n        # 3. Naive pressure recovery\n        # e_naive = E_pert - S^2/(2D)\n        # p_naive = (gamma - 1) * e_naive\n        p_naive = (gamma - 1.0) * (E_pert - S_sq_over_2D)\n        \n        # Calculate naive absolute relative error\n        # Ensure p_true is not zero to avoid division by zero\n        r_naive = abs(p_naive - p_true) / p_true if p_true != 0.0 else (0.0 if p_naive == 0.0 else np.inf)\n\n        # 4. Dual-energy safeguard\n        # Calculate diagnostic: fraction of internal energy from the perturbed state\n        # diagnostic = (E_pert - S^2/(2D)) / E_pert\n        diagnostic = (E_pert - S_sq_over_2D) / E_pert\n        \n        entropy_path_used = False\n        p_dual = 0.0\n\n        if diagnostic  threshold:\n            # Use entropy pathway\n            # p_dual = A * D^gamma\n            p_dual = A * D**gamma\n            entropy_path_used = True\n        else:\n            # Use naive pathway (subtraction is safe)\n            p_dual = p_naive\n            entropy_path_used = False\n\n        # Calculate dual-energy absolute relative error\n        r_dual = abs(p_dual - p_true) / p_true if p_true != 0.0 else (0.0 if p_dual == 0.0 else np.inf)\n\n        # 5. Store results\n        results.append([diagnostic, r_naive, r_dual, entropy_path_used])\n\n    # Final print statement in the exact required format.\n    # The default str() for a list includes spaces, which matches the problem description's style.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}