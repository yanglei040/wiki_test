{
    "hands_on_practices": [
        {
            "introduction": "粒子-网格（PM）方法的第一步是将离散粒子的质量分配到网格上，以创建一个可进行傅里叶变换的连续密度场。本练习将通过一个核心计算任务，让你掌握标准的“云中单元”（Cloud-In-Cell, CIC）分配方案，即如何将单个粒子的质量精确地分配到其周围的网格节点上。通过这个基础实践，你将深入理解从离散粒子到网格化表示的转换过程，这是利用快速傅里叶变换求解引力场的基石。",
            "id": "3529293",
            "problem": "考虑在粒子-网格（PM）方法中使用的均匀笛卡尔网格，其网格节点位于位置 $(i h, j h, k h)$，其中 $i$、$j$ 和 $k$ 为整数，$h$ 是均匀的网格间距。在云中单元（CIC）质量分配方案中，粒子质量通过一个可分离、分段线性的形函数分配到网格节点上，该函数质量守恒，并由包含该粒子的单元的8个角节点支持。\n\n一个单位质量的粒子位于位置 $\\boldsymbol{x}_{p} = (0.3 h, 0.7 h, 0.1 h)$，该位置处于由平面 $x=0$、$x=h$、$y=0$、$y=h$、$z=0$ 和 $z=h$ 界定的基本单元内。使用云中单元（CIC）分配规则，按以下固定顺序计算沉积到包围单元的8个相邻角节点的质量分数：\n$(0,0,0)$, $(h,0,0)$, $(0,h,0)$, $(h,h,0)$, $(0,0,h)$, $(h,0,h)$, $(0,h,h)$, $(h,h,h)$。\n\n将每个分数表示为精确有理数，并将最终答案以单个行向量的形式呈现。无需四舍五入。这些分数是无量纲的。",
            "solution": "用户希望解决一个粒子-网格问题。首先对问题进行验证。\n\n### 步骤1：提取已知条件\n-   **网格类型**：均匀笛卡尔网格，网格节点位于位置 $(i h, j h, k h)$，其中 $i$、$j$ 和 $k$ 为整数。\n-   **网格间距**：$h$ 是均匀的网格间距。\n-   **分配方案**：云中单元（CIC），被描述为一种可分离、分段线性的形函数，质量守恒，并由8个角节点支持。\n-   **粒子属性**：单个单位质量的粒子，$m_p = 1$。\n-   **粒子位置**：$\\boldsymbol{x}_{p} = (0.3 h, 0.7 h, 0.1 h)$。\n-   **包围单元**：该单元由平面 $x=0$、$x=h$、$y=0$、$y=h$、$z=0$ 和 $z=h$ 界定。其八个角节点位于 $(ih, jh, kh)$，其中 $i,j,k \\in \\{0,1\\}$。\n-   **任务**：计算沉积到8个相邻角节点的质量分数。\n-   **输出顺序**：分数的顺序必须是针对以下固定顺序的节点：$(0,0,0)$, $(h,0,0)$, $(0,h,0)$, $(h,h,0)$, $(0,0,h)$, $(h,0,h)$, $(0,h,h)$, $(h,h,h)$。\n-   **输出格式**：每个分数必须是精确的有理数，并以单个行向量的形式呈现。\n\n### 步骤2：使用提取的已知条件进行验证\n-   **科学依据**：该问题描述了云中单元（CIC）方案，这是计算天体物理学中用于N体模拟的一种标准且正确的方法。其原理是合理的。\n-   **适定性**：该问题是适定的。粒子的位置在特定单元内有明确定义，并且CIC方法提供了一种唯一且稳定的质量分配算法。\n-   **客观性**：语言精确无歧义。\n-   **完整性**：所有必要信息（粒子位置、质量、单元定义、分配方案）均已提供。\n-   **一致性**：没有内部矛盾。\n\n### 步骤3：结论与行动\n问题有效。将提供解答。\n\n***\n\n云中单元（CIC）质量分配方案将粒子的质量分配给包含它的网格单元的8个顶点。这种分配等效于三线性插值。分配给每个顶点的质量分数与该顶点对角方向的子长方体的体积成正比，该子长方体由穿过粒子位置且平行于单元面的平面构成。\n\n一个单位质量的粒子 $m_p=1$ 位于位置 $\\boldsymbol{x}_{p} = (x_p, y_p, z_p) = (0.3h, 0.7h, 0.1h)$。包含该粒子的基本单元由8个角节点定义，其位置为 $\\boldsymbol{x}_{ijk} = (ih, jh, kh)$，其中 $h$ 是网格间距，$i, j, k \\in \\{0, 1\\}$。\n\n首先，我们定义粒子在该单元内相对于原点 $(0,0,0)$ 处节点的归一化、无量纲坐标：\n$$ t_x = \\frac{x_p - 0}{h} = \\frac{0.3h}{h} = 0.3 $$\n$$ t_y = \\frac{y_p - 0}{h} = \\frac{0.7h}{h} = 0.7 $$\n$$ t_z = \\frac{z_p - 0}{h} = \\frac{0.1h}{h} = 0.1 $$\n粒子位于由归一化坐标定义的单位立方体内的归一化位置 $(t_x, t_y, t_z) = (0.3, 0.7, 0.1)$。\n\nCIC方案使用可分离的分配函数，这意味着一个节点的总权重是一维线性插值权重的乘积。对于给定的维度，例如 $x$ 维，分配给边界节点 $i=0$ 和 $i=1$ 的权重为：\n$$ w_x(0) = 1 - t_x $$\n$$ w_x(1) = t_x $$\n对于 $y$ 和 $z$ 维度也类似：\n$$ w_y(0) = 1 - t_y, \\quad w_y(1) = t_y $$\n$$ w_z(0) = 1 - t_z, \\quad w_z(1) = t_z $$\n分配给节点 $(ih, jh, kh)$ 的质量分数 $f_{ijk}$ 由这些一维权重的乘积给出：\n$$ f_{ijk} = w_x(i) \\cdot w_y(j) \\cdot w_z(k) $$\n由于粒子的质量为 $m_p=1$，这些分数就是沉积在网格节点上的绝对质量。\n\n使用粒子的归一化位置，我们计算一维权重：\n$$ w_x(0) = 1 - 0.3 = 0.7 = \\frac{7}{10} \\quad \\text{and} \\quad w_x(1) = 0.3 = \\frac{3}{10} $$\n$$ w_y(0) = 1 - 0.7 = 0.3 = \\frac{3}{10} \\quad \\text{and} \\quad w_y(1) = 0.7 = \\frac{7}{10} $$\n$$ w_z(0) = 1 - 0.1 = 0.9 = \\frac{9}{10} \\quad \\text{and} \\quad w_z(1) = 0.1 = \\frac{1}{10} $$\n\n现在，我们按指定顺序计算8个节点中每个节点的质量分数。\n\n1.  位于 $(0,0,0)$ 的节点，对应于 $(i,j,k)=(0,0,0)$：\n    $f_{000} = w_x(0) \\cdot w_y(0) \\cdot w_z(0) = \\frac{7}{10} \\times \\frac{3}{10} \\times \\frac{9}{10} = \\frac{189}{1000}$\n\n2.  位于 $(h,0,0)$ 的节点，对应于 $(i,j,k)=(1,0,0)$：\n    $f_{100} = w_x(1) \\cdot w_y(0) \\cdot w_z(0) = \\frac{3}{10} \\times \\frac{3}{10} \\times \\frac{9}{10} = \\frac{81}{1000}$\n\n3.  位于 $(0,h,0)$ 的节点，对应于 $(i,j,k)=(0,1,0)$：\n    $f_{010} = w_x(0) \\cdot w_y(1) \\cdot w_z(0) = \\frac{7}{10} \\times \\frac{7}{10} \\times \\frac{9}{10} = \\frac{441}{1000}$\n\n4.  位于 $(h,h,0)$ 的节点，对应于 $(i,j,k)=(1,1,0)$：\n    $f_{110} = w_x(1) \\cdot w_y(1) \\cdot w_z(0) = \\frac{3}{10} \\times \\frac{7}{10} \\times \\frac{9}{10} = \\frac{189}{1000}$\n\n5.  位于 $(0,0,h)$ 的节点，对应于 $(i,j,k)=(0,0,1)$：\n    $f_{001} = w_x(0) \\cdot w_y(0) \\cdot w_z(1) = \\frac{7}{10} \\times \\frac{3}{10} \\times \\frac{1}{10} = \\frac{21}{1000}$\n\n6.  位于 $(h,0,h)$ 的节点，对应于 $(i,j,k)=(1,0,1)$：\n    $f_{101} = w_x(1) \\cdot w_y(0) \\cdot w_z(1) = \\frac{3}{10} \\times \\frac{3}{10} \\times \\frac{1}{10} = \\frac{9}{1000}$\n\n7.  位于 $(0,h,h)$ 的节点，对应于 $(i,j,k)=(0,1,1)$：\n    $f_{011} = w_x(0) \\cdot w_y(1) \\cdot w_z(1) = \\frac{7}{10} \\times \\frac{7}{10} \\times \\frac{1}{10} = \\frac{49}{1000}$\n\n8.  位于 $(h,h,h)$ 的节点，对应于 $(i,j,k)=(1,1,1)$：\n    $f_{111} = w_x(1) \\cdot w_y(1) \\cdot w_z(1) = \\frac{3}{10} \\times \\frac{7}{10} \\times \\frac{1}{10} = \\frac{21}{1000}$\n\n作为一致性检验，我们验证质量分数的总和是否等于 $1$，这是CIC方案的一个必要属性（质量守恒）。\n$$ \\sum_{i,j,k \\in \\{0,1\\}} f_{ijk} = \\frac{1}{1000} (189 + 81 + 441 + 189 + 21 + 9 + 49 + 21) = \\frac{1000}{1000} = 1 $$\n总和证实了计算的正确性。最终答案是这些分数的有序列表。\n最终的质量分数行向量是：\n$$\n\\begin{pmatrix} \\frac{189}{1000} & \\frac{81}{1000} & \\frac{441}{1000} & \\frac{189}{1000} & \\frac{21}{1000} & \\frac{9}{1000} & \\frac{49}{1000} & \\frac{21}{1000} \\end{pmatrix}\n$$",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{189}{1000} & \\frac{81}{1000} & \\frac{441}{1000} & \\frac{189}{1000} & \\frac{21}{1000} & \\frac{9}{1000} & \\frac{49}{1000} & \\frac{21}{1000}\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "在网格上得到密度和势场后，下一步是计算引力并积分粒子的运动轨迹。这个练习构建了一个完整的PM模拟循环：你将为一个在静态引力势中运动的测试粒子计算轨道，学习如何从网格上插值计算作用力，并使用辛积分器（如蛙跳法）来更新粒子的位置和速度。通过将数值积分的能量误差与时间步长 $\\Delta t$ 关联，你将学会评估和验证N体模拟中能量守恒性的关键技能。",
            "id": "3529327",
            "problem": "考虑一个测试粒子在固定的球对称引力势中运动，该引力势对应于一个 Plummer 球状模型。在一个立方体区域内的均匀笛卡尔网格上，使用质点-网格 (PM) 方法对该势进行离散化，并采用时间对称蛙跳格式对圆形轨道的粒子运动进行精确一个轨道周期的积分。估算长期能量误差作为时间步长 $\\Delta t$ 的函数。所有量均使用无量纲代码单位表示，其中引力常数 $G$ 等于 $1$。\n\nPlummer 球状模型的引力势由以下经过充分检验的公式定义：\n$$\n\\Phi(r) = -\\frac{G M}{\\sqrt{r^2 + a^2}},\n$$\n其中 $r$ 是距原点的径向距离，$M$ 是总质量，$a$ 是软化长度。根据牛顿第二定律和势的梯度，引力加速度由下式给出：\n$$\n\\mathbf{a}(\\mathbf{x}) = -\\nabla \\Phi(\\mathbf{x}).\n$$\n\n您必须通过在均匀网格上对 $\\Phi(\\mathbf{x})$ 进行采样，并使用有限差分计算网格上的 $\\nabla \\Phi(\\mathbf{x})$，来构建该静态势的 PM 表示。使用三线性插值来评估粒子位置处的势及其梯度。然后使用一个遵循牛顿第二定律的蛙跳时间积分器 (kick-drift-kick) 来积分粒子的轨道。\n\n假设在无量纲代码单位下，以下参数是固定的：\n- $G = 1$, $M = 1$, $a = 0.1$。\n- 立方体区域为 $[-L/2, L/2]^3$，其中 $L = 4$。\n- 使用均匀网格，每个维度有 $N = 64$ 个节点。\n- 将粒子初始化于 $\\mathbf{x}_0 = (r_0, 0, 0)$，其中 $r_0 = 1$。选择初始速度 $\\mathbf{v}_0 = (0, v_{\\mathrm{circ}}, 0)$，其中 $v_{\\mathrm{circ}}$ 是通过将向心加速度与 Plummer 势中的引力加速度相等来计算的圆形轨道速度：\n$$\n\\frac{v_{\\mathrm{circ}}^2}{r_0} = \\frac{G M r_0}{(r_0^2 + a^2)^{3/2}}.\n$$\n\n使用圆形轨道周期\n$$\nT = \\frac{2\\pi r_0}{v_{\\mathrm{circ}}},\n$$\n角度以弧度为单位。\n\n将位于位置 $\\mathbf{x}$、速度为 $\\mathbf{v}$ 时的总机械能定义为\n$$\nE = \\frac{1}{2}\\|\\mathbf{v}\\|^2 + \\Phi(\\mathbf{x}),\n$$\n其中 $\\Phi(\\mathbf{x})$ 是通过对网格上的 PM 势进行三线性插值得到的，$\\|\\mathbf{v}\\|$ 是欧几里得范数。积分一个轨道周期后的长期能量误差是绝对分数差\n$$\n\\epsilon = \\left|\\frac{E(T) - E(0)}{E(0)}\\right|.\n$$\n将 $\\epsilon$ 报告为一个无量纲的小数。\n\n实现以下步骤：\n1. 在网格上构建 PM 势 $\\Phi$，并使用内部中心差分和边界单边差分计算网格节点上的梯度 $\\nabla \\Phi$。\n2. 对于给定的 $\\Delta t$，使用蛙跳法和三线性插值计算中间位置的加速度，积分恰好一个周期 $T$。\n3. 使用 PM 插值势计算 $E(0)$ 和 $E(T)$，并计算返回长期能量误差 $\\epsilon$。\n\n测试组：\n对于上述相同的设置，评估以下时间步长的长期能量误差 $\\epsilon$，每个时间步长都被选择为恰好能整除周期：\n- $\\Delta t = T/200$，\n- $\\Delta t = T/100$，\n- $\\Delta t = T/50$，\n- $\\Delta t = T/20$，\n- $\\Delta t = T/8$。\n\n最终输出格式：\n您的程序应产生单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，\"[result1,result2,result3,result4,result5]\"）。每个结果是按上文所列顺序对应于每个 $\\Delta t$ 的 $\\epsilon$ 值。所有输出均为无量纲小数。",
            "solution": "用户提供了一个来自计算天体物理学的问题，要求模拟一个粒子的轨道，并评估一个质点-网格 (PM) 方案的能量守恒性。该问题是有效的，因为它具有科学依据、适定且客观。它为标准的计算实验提供了一套完整且一致的参数、初始条件和数值方法。\n\n解决方案如下：\n\n1.  **系统定义和初始条件：**\n    问题描述了一个测试粒子在 Plummer 球状模型产生的静态引力势作用下的运动，其势为 $\\Phi(r) = -G M / \\sqrt{r^2 + a^2}$。参数在无量纲代码单位下给出，$G=1$，$M=1$，软化长度 $a=0.1$。粒子在 $x-y$ 平面内，以半径 $r_0=1$ 的圆形轨道进行初始化。圆形轨道速度 $v_{\\mathrm{circ}}$ 通过平衡引力与向心力来确定：\n    $$\n    \\frac{v_{\\mathrm{circ}}^2}{r_0} = |\\mathbf{a}(r_0)| = \\left|-\\frac{d\\Phi}{dr}\\right|_{r=r_0} = \\frac{G M r_0}{(r_0^2 + a^2)^{3/2}}\n    $$\n    这给出了初始位置 $\\mathbf{x}_0 = (r_0, 0, 0)$ 和初始速度 $\\mathbf{v}_0 = (0, v_{\\mathrm{circ}}, 0)$。轨道周期，即总积分时间，为 $T = 2\\pi r_0 / v_{\\mathrm{circ}}$。\n\n2.  **质点-网格 (PM) 离散化：**\n    PM方法的核心是在离散网格上表示连续的引力场。模拟在一个以原点为中心、边长为 $L=4$ 的立方体区域内进行。\n    -   **网格生成：** 构建一个每个维度有 $N=64$ 个节点的均匀笛卡尔网格。网格间距为 $h = L / (N-1)$。\n    -   **势采样：** 在每个 $N \\times N \\times N$ 网格节点的坐标处计算解析 Plummer 势 $\\Phi(\\mathbf{x})$，并存储在一个三维数组 $\\Phi_{\\text{grid}}$ 中。\n    -   **力场计算：** 通过对势场网格 $\\Phi_{\\text{grid}}$ 进行数值梯度计算，来得到网格上的引力加速度场 $\\mathbf{a}(\\mathbf{x}) = -\\nabla\\Phi(\\mathbf{x})$。如问题所述，梯度对内部节点使用二阶中心差分计算，对边界节点使用一阶单边差分计算。这会产生三个三维数组 $\\mathbf{a}_{x, \\text{grid}}$、$\\mathbf{a}_{y, \\text{grid}}$ 和 $\\mathbf{a}_{z, \\text{grid}}$，分别表示每个网格节点上加速度场的分量。\n\n3.  **粒子积分：**\n    为了积分粒子的运动方程 $\\ddot{\\mathbf{x}} = \\mathbf{a}(\\mathbf{x})$，我们需要粒子位置处的加速度，而该位置通常不与网格节点重合。\n    -   **场插值：** 使用三线性插值来评估任意粒子位置 $\\mathbf{x}$ 处的势 $\\Phi$ 和加速度分量 $\\mathbf{a}$。这是通过找到包含该粒子的网格单元，并对该单元8个角点的值进行加权平均来实现的。权重由粒子在该单元内的分数位置确定。\n    -   **蛙跳积分 (Kick-Drift-Kick)：** 使用时间对称的蛙跳积分器来推进粒子的状态 $(\\mathbf{x}(t), \\mathbf{v}(t))$。所使用的具体变体是“速度Verlet”算法，它等价于 Kick-Drift-Kick (KDK) 格式。对于单个时间步 $\\Delta t$，从状态 $(\\mathbf{x}_n, \\mathbf{v}_n)$ 到 $(\\mathbf{x}_{n+1}, \\mathbf{v}_{n+1})$ 的更新如下：\n        1.  **踢 (Kick):** $\\mathbf{v}_{n+1/2} = \\mathbf{v}_n + \\mathbf{a}(\\mathbf{x}_n) \\frac{\\Delta t}{2}$\n        2.  **漂移 (Drift):** $\\mathbf{x}_{n+1} = \\mathbf{x}_n + \\mathbf{v}_{n+1/2} \\Delta t$\n        3.  **踢 (Kick):** $\\mathbf{v}_{n+1} = \\mathbf{v}_{n+1/2} + \\mathbf{a}(\\mathbf{x}_{n+1}) \\frac{\\Delta t}{2}$\n    该格式对 $\\Delta t$ 具有二阶精度并且是保辛的，这使其具有出色的长期能量守恒特性（即没有长期能量漂移）。\n\n4.  **能量误差计算：**\n    粒子的总能量是使用 PM 插值势而不是解析势来定义的，以便一致地评估数值方法本身的误差。在给定状态 $(\\mathbf{x}, \\mathbf{v})$ 下的能量为：\n    $$\n    E = \\frac{1}{2}\\|\\mathbf{v}\\|^2 + \\Phi_{\\text{interp}}(\\mathbf{x})\n    $$\n    初始能量 $E(0)$ 使用初始状态 $(\\mathbf{x}_0, \\mathbf{v}_0)$ 计算。最终能量 $E(T)$ 在积分完整一个周期 $T$ 后计算。长期能量误差 $\\epsilon$ 是绝对分数差：\n    $$\n    \\epsilon = \\left|\\frac{E(T) - E(0)}{E(0)}\\right|\n    $$\n    对多个时间步长 $\\Delta t$ 重复此计算，这些步长被选为周期 $T$ 的整数分之一。由于蛙跳积分器的局部截断误差为 $\\mathcal{O}(\\Delta t^3)$ 阶，因此在固定时间间隔内的全局能量误差预计将按 $\\epsilon \\propto \\Delta t^2$ 的比例缩放。",
            "answer": "```python\nimport numpy as np\nfrom scipy.interpolate import RegularGridInterpolator\n\ndef solve():\n    \"\"\"\n    Solves the particle-mesh orbit integration problem.\n    \"\"\"\n    # 1. System Parameters and Initial Conditions\n    G = 1.0\n    M = 1.0\n    a = 0.1\n    L = 4.0\n    N = 64\n    r0 = 1.0\n\n    # Test cases: time step as a fraction of the period T\n    T_divisors = [200, 100, 50, 20, 8]\n\n    # Derived constants and initial conditions\n    h = L / (N - 1)\n    grid_coords = np.linspace(-L / 2, L / 2, N)\n\n    # Circular velocity for a Plummer potential\n    v_circ_sq = (G * M * r0**2) / (r0**2 + a**2)**1.5\n    v_circ = np.sqrt(v_circ_sq)\n    \n    # Orbital period\n    T = 2 * np.pi * r0 / v_circ\n\n    # Initial state vectors\n    x0 = np.array([r0, 0.0, 0.0])\n    v0 = np.array([0.0, v_circ, 0.0])\n\n    # 2. PM Grid Construction\n    # Create grid coordinate arrays\n    X, Y, Z = np.meshgrid(grid_coords, grid_coords, grid_coords, indexing='ij')\n\n    # Compute potential on the grid\n    R_sq = X**2 + Y**2 + Z**2\n    Phi_grid = -G * M / np.sqrt(R_sq + a**2)\n\n    # Compute acceleration field using numerical gradient of the potential field\n    # np.gradient uses 2nd-order central differences for the interior\n    # and 1st-order one-sided differences at boundaries, as required.\n    # The gradient is returned as a list of arrays [d/dx, d/dy, d/dz]\n    # because meshgrid's indexing was 'ij'.\n    grad_Phi = np.gradient(Phi_grid, h)\n    Acc_x_grid = -grad_Phi[0]\n    Acc_y_grid = -grad_Phi[1]\n    Acc_z_grid = -grad_Phi[2]\n\n    # 3. Create Interpolators\n    # Stack all fields for efficient multi-value interpolation\n    values_to_interpolate = np.stack(\n        [Phi_grid, Acc_x_grid, Acc_y_grid, Acc_z_grid], axis=-1\n    )\n    \n    # The interpolator function will be used to get potential and acceleration\n    # at any off-grid particle position. 'linear' corresponds to trilinear.\n    interpolator = RegularGridInterpolator(\n        (grid_coords, grid_coords, grid_coords),\n        values_to_interpolate,\n        method='linear',\n        bounds_error=True  # Ensure particle stays within the simulation box\n    )\n\n    def get_potential_and_accel(pos):\n        # The interpolator expects a (n_points, n_dims) array.\n        # For a single point, we reshape and then squeeze the output.\n        interp_values = interpolator(pos.reshape(1, -1))\n        return interp_values[0] # Returns [phi, ax, ay, az]\n\n    # Calculate initial energy E(0) using the interpolated potential\n    phi0, _, _, _ = get_potential_and_accel(x0)\n    E0 = 0.5 * np.dot(v0, v0) + phi0\n\n    results = []\n    \n    # 4. Integration and Error Calculation Loop\n    for divisor in T_divisors:\n        dt = T / divisor\n        N_steps = int(divisor)\n\n        # Reset particle state for each test run\n        x = np.copy(x0)\n        v = np.copy(v0)\n\n        # KDK Leapfrog / Velocity Verlet Integrator\n        # Get initial acceleration\n        _, ax, ay, az = get_potential_and_accel(x)\n        a_current = np.array([ax, ay, az])\n\n        for _ in range(N_steps):\n            # Kick (half step)\n            v_half_step = v + a_current * dt / 2.0\n            # Drift (full step)\n            x = x + v_half_step * dt\n            # Update acceleration at the new position\n            _, ax_new, ay_new, az_new = get_potential_and_accel(x)\n            a_new = np.array([ax_new, ay_new, az_new])\n            # Kick (second half step)\n            v = v_half_step + a_new * dt / 2.0\n            # Store the new acceleration for the next iteration\n            a_current = a_new\n        \n        # At this point, x and v are the final state at time T\n        x_final = x\n        v_final = v\n\n        # Calculate final energy E(T)\n        phi_final, _, _, _ = get_potential_and_accel(x_final)\n        E_final = 0.5 * np.dot(v_final, v_final) + phi_final\n\n        # Calculate and store the secular energy error\n        error = np.abs((E_final - E0) / E0)\n        results.append(error)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "P³M方法通过将引力分解为由PM处理的长程部分和由直接粒子对粒子（PP）计算的短程部分，从而实现了高精度。这个练习将引导你设计P³M方法中的一个关键算法：用于高效查找短程力计算对象的邻域搜索。你将运用几何和概率推理，为一个基于单元链接列表的方案计算其性能，该方案旨在将邻域搜索的计算复杂度从 $\\mathcal{O}(N^2)$ 降低到 $\\mathcal{O}(N)$。这项实践连接了PM和P³M，让你掌握优化粒子间直接相互作用计算的核心算法思想。",
            "id": "3529362",
            "problem": "在一个使用粒子-粒子 粒子-网格 (P³M) 方法的自引力 $N$体计算中，总牛顿力被分解为一个在截断半径 $r_{c}$ 处截断的短程粒子-粒子分量，以及一个在间距为 $h$ 的网格上计算的长程粒子-网格分量。截断半径由 $r_{c}=\\alpha h$ 定义，其中 $\\alpha>0$ 是一个固定的无量纲常数。为了加速短程粒子-粒子相互作用的评估，你将设计一个单元链表邻居搜索方法。该方法应用于一个三维周期性区域，其中粒子根据数密度为 $n$ 的均匀泊松过程分布。\n\n邻居搜索的设计如下：将空间划分为边长为 $\\ell$ 的立方单元组成的均匀网格，使得任何粒子周围距离 $r_{c}$ 内的真实邻居都必须位于该粒子自身所在的单元，或其面、棱、角相邻的邻居单元之一。为最小化距离检查的次数，选择满足此要求的最小允许值 $\\ell$，并且对于每个粒子，将其候选集限制在它自身单元及这些相邻单元的并集中找到的粒子。假设 $N$ 足够大以至于边界修正是可以忽略的，并且候选集在基于单元的剔除后，会通过与 $r_{c}$ 的精确距离检查进行剪枝。\n\n仅使用基本的几何和概率推理，计算此单元链表过程为每个粒子生成的候选对的期望数，并用 $n$、$\\alpha$ 和 $h$ 以闭合形式表示。你的最终答案必须是单一的解析表达式。在最终方框内的答案中不要包含单位。",
            "solution": "问题要求计算在三维周期性区域中，由一个特定的单元链表过程为每个粒子生成的候选对的期望数。粒子根据数密度为 $n$ 的均匀泊松过程分布。\n\n首先，我们必须确定立方单元的大小，记为 $\\ell$。设计指定了对于任意给定粒子，其搜索区域包括其自身单元和26个相邻单元（共享面、棱或角的单元）。这构成了一个 $3 \\times 3 \\times 3$ 的单元块。关键要求是这个搜索区域必须包含所有“真实”邻居，即任何距离 $r_c$ 内的其他粒子。单元尺寸 $\\ell$ 必须是满足此条件的最小值。\n\n设两个粒子位于位置 $\\vec{x}_1$ 和 $\\vec{x}_2$。设这些向量的笛卡尔分量分别为 $(x_{1,1}, x_{1,2}, x_{1,3})$ 和 $(x_{2,1}, x_{2,2}, x_{2,3})$。单元与坐标轴对齐。位于位置 $\\vec{x}$ 的粒子在第 $k$ 维的单元索引由 $i_k(\\vec{x}) = \\lfloor x_k / \\ell \\rfloor$ 给出。两个粒子位于相同或相邻的单元（即它们是“单元邻居”）当且仅当它们在所有三个维度上的单元索引的绝对差都小于或等于1：\n$$|i_k(\\vec{x}_1) - i_k(\\vec{x}_2)| \\le 1 \\quad \\text{for } k=1, 2, 3$$\n问题的要求可以表述为：如果 $|\\vec{x}_1 - \\vec{x}_2| \\le r_c$，那么这两个粒子必须是单元邻居。\n\n分析其逆否命题更为方便：如果两个粒子*不是*单元邻居，它们的间距必须严格大于 $r_c$。如果至少在一个维度 $k$上，两个粒子的单元索引的绝对差大于或等于2，那么它们就不是单元邻居：\n$$|i_k(\\vec{x}_1) - i_k(\\vec{x}_2)| \\ge 2$$\n让我们分析两个非单元邻居的粒子之间可能的最小距离。考虑它们在第 $k$ 维的间距 $\\Delta x_k = x_{1,k} - x_{2,k}$。单元索引为 $i_k(\\vec{x}_1) = \\lfloor x_{1,k}/\\ell \\rfloor$ 和 $i_k(\\vec{x}_2) = \\lfloor x_{2,k}/\\ell \\rfloor$。\n根据向下取整函数的定义，我们有一般不等式 $q-1  \\lfloor q \\rfloor \\le q$。这意味着：\n$$\\frac{x_{1,k}}{\\ell} - 1  \\lfloor \\frac{x_{1,k}}{\\ell} \\rfloor \\le \\frac{x_{1,k}}{\\ell}$$\n$$-\\frac{x_{2,k}}{\\ell} \\le - \\lfloor \\frac{x_{2,k}}{\\ell} \\rfloor  -\\frac{x_{2,k}}{\\ell} + 1$$\n将这些不等式相加得到：\n$$\\frac{\\Delta x_k}{\\ell} - 1  i_k(\\vec{x}_1) - i_k(\\vec{x}_2)  \\frac{\\Delta x_k}{\\ell} + 1$$\n如果粒子不是单元邻居，则存在某个维度 $k$ 使得 $|i_k(\\vec{x}_1) - i_k(\\vec{x}_2)| \\ge 2$。让我们假设 $i_k(\\vec{x}_1) - i_k(\\vec{x}_2) \\ge 2$。根据上述不等式，这意味着：\n$$2 \\le i_k(\\vec{x}_1) - i_k(\\vec{x}_2)  \\frac{\\Delta x_k}{\\ell} + 1$$\n$$1  \\frac{\\Delta x_k}{\\ell} \\implies \\Delta x_k > \\ell$$\n这表明，如果两个粒子在任何维度上至少相隔一个完整的单元，它们在该维度上的坐标间距必须严格大于 $\\ell$。粒子之间的距离平方为 $|\\vec{x}_1 - \\vec{x}_2|^2 = (\\Delta x_1)^2 + (\\Delta x_2)^2 + (\\Delta x_3)^2$。如果对于某个 $k$，$|\\Delta x_k| > \\ell$，那么 $|\\vec{x}_1 - \\vec{x}_2|^2 \\ge (\\Delta x_k)^2 > \\ell^2$。因此，它们之间的距离必须是 $|\\vec{x}_1 - \\vec{x}_2| > \\ell$。\n\n因此，对于任何一对非单元邻居的粒子，它们的间距严格大于 $\\ell$。为了满足逆否命题的要求，即它们的间距必须大于 $r_c$，我们必须确保 $\\ell \\ge r_c$。如果这个条件成立，那么距离 $ \\ell \\ge r_c$，这就满足了条件。\n问题要求 $\\ell$ 的*最小*允许值。因此，我们必须选择 $\\ell = r_c$。\n\n现在我们计算每个粒子的候选对的期望数。对于一个给定的粒子，候选粒子是位于以该粒子所在单元为中心的 $3 \\times 3 \\times 3$ 单元块中的所有其他粒子。\n单个立方单元的体积是 $V_{cell} = \\ell^3$。\n包含 $3 \\times 3 \\times 3 = 27$ 个单元的搜索区域的总体积是：\n$$V_{search} = 27 V_{cell} = 27 \\ell^3$$\n粒子通过数密度为 $n$ 的均匀泊松过程分布。这种过程的一个基本性质是，任何体积 $V$ 内的粒子数是一个泊松分布的随机变量，其均值为 $n V$。此外，由于泊松过程的独立性（由Slivnyak定理形式化），以特定位置存在一个粒子为条件，并不会改变其他粒子的分布。\n因此，对于任何给定的粒子，其搜索体积 $V_{search}$ 内*其他*粒子的期望数就是密度 $n$ 乘以体积 $V_{search}$。设 $N_{cand}$ 为每个粒子的候选对的期望数。\n$$N_{cand} = n V_{search} = n (27 \\ell^3)$$\n我们已经确定最佳单元尺寸是 $\\ell = r_c$。问题还指出，截断半径 $r_c$ 与网格间距 $h$ 的关系为 $r_c = \\alpha h$，其中 $\\alpha$ 是一个无量纲常数。\n将这些关系代入 $N_{cand}$ 的表达式中：\n$$\\ell = r_c = \\alpha h$$\n$$N_{cand} = 27 n (\\alpha h)^3 = 27 n \\alpha^3 h^3$$\n这就是每个粒子的候选对期望数的最终表达式。",
            "answer": "$$\\boxed{27 n \\alpha^{3} h^{3}}$$"
        }
    ]
}