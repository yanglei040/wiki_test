{
    "hands_on_practices": [
        {
            "introduction": "A fundamental challenge in element design is balancing computational efficiency with numerical stability. This practice uses eigenvalue analysis, a powerful diagnostic tool, to explore the consequences of using reduced integration on a four-node quadrilateral element . You will directly observe the emergence of spurious zero-energy deformations, known as hourglass modes, and then implement a stabilization technique to demonstrate how these instabilities can be precisely eliminated.",
            "id": "3573623",
            "problem": "You are to implement a small-scale eigenvalue analysis that reveals, in a precise and verifiable manner, how reduced numerical integration of a four-node bilinear quadrilateral element in two-dimensional elasticity produces spurious zero-energy patterns (hourglass modes), and how an enhancement that targets only the hourglass subspace restores coercivity without affecting rigid body modes. Your derivation and algorithm must start from the Principle of Virtual Work and the standard isoparametric finite element definitions. The end-product must be a complete program that constructs element stiffness matrices, performs eigenanalysis, identifies spurious zero-energy modes, and demonstrates their removal by a carefully designed enhanced displacement field contribution.\n\nUse the following base and definitions.\n\n- The Principle of Virtual Work for small-strain linear elasticity at the element level reads $\\,\\delta \\Pi_{e} = \\delta \\boldsymbol{u}_{e}^{\\mathsf{T}} \\boldsymbol{K}_{e} \\boldsymbol{u}_{e} - \\delta \\boldsymbol{u}_{e}^{\\mathsf{T}} \\boldsymbol{f}_{e} = 0\\,$ for all admissible virtual displacements $\\,\\delta \\boldsymbol{u}_{e}\\,$, wherein the element stiffness matrix is $\\,\\boldsymbol{K}_{e} = \\int_{\\Omega_{e}} \\boldsymbol{B}^{\\mathsf{T}} \\boldsymbol{C} \\boldsymbol{B} \\,\\mathrm{d}\\Omega\\,$. The strain-displacement matrix is $\\,\\boldsymbol{B}\\,$ and $\\,\\boldsymbol{C}\\,$ is the constitutive (material) matrix.\n- Consider a standard isoparametric four-node bilinear quadrilateral (often abbreviated as $\\,\\mathrm{Q4}\\,$) with nodal coordinates $\\,\\{(x_{i},y_{i})\\}_{i=1}^{4}\\,$ and nodal displacement vector $\\,\\boldsymbol{u}_{e} \\in \\mathbb{R}^{8}\\,$ ordered as $\\,\\boldsymbol{u}_{e} = [u_{1x},u_{1y},u_{2x},u_{2y},u_{3x},u_{3y},u_{4x},u_{4y}]^{\\mathsf{T}}\\,$. The bilinear shape functions in the parent domain $\\,(\\xi,\\eta)\\in[-1,1]^{2}\\,$ are $\\,N_{1}(\\xi,\\eta)=\\tfrac{1}{4}(1-\\xi)(1-\\eta)\\,$, $\\,N_{2}(\\xi,\\eta)=\\tfrac{1}{4}(1+\\xi)(1-\\eta)\\,$, $\\,N_{3}(\\xi,\\eta)=\\tfrac{1}{4}(1+\\xi)(1+\\eta)\\,$, $\\,N_{4}(\\xi,\\eta)=\\tfrac{1}{4}(1-\\xi)(1+\\eta)\\,$. The mapping to physical space is $\\,\\boldsymbol{x}(\\xi,\\eta)=\\sum_{i=1}^{4} N_{i}(\\xi,\\eta)\\,\\boldsymbol{x}_{i}\\,$ with Jacobian $\\,\\boldsymbol{J}=\\partial \\boldsymbol{x}/\\partial(\\xi,\\eta)\\,$ and $\\,\\mathrm{d}\\Omega = \\det(\\boldsymbol{J})\\,\\mathrm{d}\\xi\\,\\mathrm{d}\\eta\\,$. The gradient of shape functions in physical coordinates is obtained by $\\,\\nabla N_{i} = \\boldsymbol{J}^{-1}\\,\\nabla_{\\xi,\\eta} N_{i}\\,$.\n- For two-dimensional plane strain, the constitutive matrix is $\\,\\boldsymbol{C}=\\dfrac{E}{(1+\\nu)(1-2\\nu)}\\begin{bmatrix}1-\\nu & \\nu & 0\\\\ \\nu & 1-\\nu & 0\\\\ 0 & 0 & \\tfrac{1}{2}(1-2\\nu)\\end{bmatrix}\\,$, where $\\,E\\,$ is Young’s modulus and $\\,\\nu\\,$ is Poisson’s ratio. The strain-displacement matrix $\\,\\boldsymbol{B}\\,$ is constructed in the standard manner from $\\,\\partial N_{i}/\\partial x\\,$ and $\\,\\partial N_{i}/\\partial y\\,$ entries.\n\nYou must implement three element stiffness constructions:\n- Reduced integration: a single Gauss point at $ (\\xi,\\eta)=(0,0) $ with weight $ w=4 $ on $\\,[-1,1]^{2}\\,$ so that $\\,\\boldsymbol{K}_{\\mathrm{red}}=\\boldsymbol{B}(0,0)^{\\mathsf{T}}\\boldsymbol{C}\\,\\boldsymbol{B}(0,0)\\,\\det(\\boldsymbol{J}(0,0))\\,w\\,$. This produces rank deficiency beyond rigid body modes and hence spurious zero-energy modes.\n- Full integration: a $ 2 \\times 2 $ Gauss rule with points $ (\\pm 1/\\sqrt{3},\\pm 1/\\sqrt{3}) $ and weight $ w=1 $, summed to obtain $\\,\\boldsymbol{K}_{\\mathrm{full}}\\,$. This eliminates spurious zero-energy modes in regular settings, leaving only rigid body modes.\n- Enhanced displacement stabilization on top of reduced integration: let $\\,\\mathcal{N}(\\boldsymbol{K}_{\\mathrm{red}})\\,$ denote the null space of $\\,\\boldsymbol{K}_{\\mathrm{red}}\\,$. Let $\\,\\mathcal{R}\\,$ be the subspace of rigid body modes spanned by two translations and one in-plane rotation about the centroid $\\,\\boldsymbol{x}_{c}\\,$, i.e., $\\,\\boldsymbol{r}_{1}=[1,0,1,0,1,0,1,0]^{\\mathsf{T}}\\,$, $\\,\\boldsymbol{r}_{2}=[0,1,0,1,0,1,0,1]^{\\mathsf{T}}\\,$, and $\\,\\boldsymbol{r}_{3}=[-y_{1}^{c},x_{1}^{c},-y_{2}^{c},x_{2}^{c},-y_{3}^{c},x_{3}^{c},-y_{4}^{c},x_{4}^{c}]^{\\mathsf{T}}\\,$ with $\\,\\boldsymbol{x}_{i}^{c}=\\boldsymbol{x}_{i}-\\boldsymbol{x}_{c}\\,$ and $\\,\\boldsymbol{x}_{c}=\\tfrac{1}{4}\\sum_{i=1}^{4}\\boldsymbol{x}_{i}\\,$. Define the hourglass subspace $\\,\\mathcal{H}=\\mathcal{N}(\\boldsymbol{K}_{\\mathrm{red}})\\ominus\\mathcal{R}\\,$. Construct an orthonormal basis $\\,\\boldsymbol{H}\\in\\mathbb{R}^{8\\times n_{h}}\\,$ of $\\,\\mathcal{H}\\,$ with $\\,n_{h}\\,$ equal to the dimension of $\\,\\mathcal{H}\\,$. Add an enhanced displacement stabilization $\\,\\boldsymbol{K}_{\\mathrm{enh}}=\\beta\\,\\boldsymbol{H}\\boldsymbol{H}^{\\mathsf{T}}\\,$ with $\\,\\beta=\\alpha\\,\\mu\\,L\\,$, where $\\,\\mu=\\dfrac{E}{2(1+\\nu)}\\,$ is the shear modulus, $\\,L=\\sqrt{A}\\,$ with $\\,A\\,$ the element area, and $\\,\\alpha=1\\,$ a dimensionless scaling. The enhanced stiffness is $\\,\\boldsymbol{K}_{\\mathrm{red+enh}}=\\boldsymbol{K}_{\\mathrm{red}}+\\boldsymbol{K}_{\\mathrm{enh}}\\,$. This construction must leave rigid body modes unpenalized and lift only hourglass modes, thereby eliminating spurious zero-energy patterns.\n\nYou must diagnose spurious zero-energy patterns as follows. Given a symmetric matrix $\\,\\boldsymbol{K}\\,$, compute its eigenvalues $\\,\\{\\lambda_{i}\\}\\,$. Let $\\,\\lambda_{\\max}=\\max_{i}|\\lambda_{i}|\\,$ and define a relative threshold $\\,\\varepsilon=\\max(10^{-8},10^{-8}\\lambda_{\\max})\\,$. Count $\\,n_{0}\\,$, the number of eigenvalues with $\\,|\\lambda_{i}|<\\varepsilon\\,$. The number of spurious zero-energy modes is $\\,n_{\\mathrm{spur}}=\\max(0, n_{0}-3)\\,$, since there are $\\,3\\,$ rigid body modes in two-dimensional elasticity for a free element.\n\nImplement the above and apply it to the following test suite. Use plane strain with $\\,E=210\\times 10^{9}\\,$ and $\\,\\nu=0.30\\,$. Define two geometries:\n- Geometry $\\,\\mathcal{G}_{1}\\,$ (square): nodes at $\\,\\boldsymbol{x}_{1}=(0,0)\\,$, $\\,\\boldsymbol{x}_{2}=(1,0)\\,$, $\\,\\boldsymbol{x}_{3}=(1,1)\\,$, $\\,\\boldsymbol{x}_{4}=(0,1)\\,$ in meters.\n- Geometry $\\,\\mathcal{G}_{2}\\,$ (distorted parallelogram): nodes at $\\,\\boldsymbol{x}_{1}=(0,0)\\,$, $\\,\\boldsymbol{x}_{2}=(2,0)\\,$, $\\,\\boldsymbol{x}_{3}=(2.2,1)\\,$, $\\,\\boldsymbol{x}_{4}=(0.2,1)\\,$ in meters.\n\nForm six cases and, for each, report $\\,n_{\\mathrm{spur}}\\,$ as an integer:\n- Case $\\,1\\,$: reduced integration on $\\,\\mathcal{G}_{1}\\,$.\n- Case $\\,2\\,$: reduced integration plus enhancement on $\\,\\mathcal{G}_{1}\\,$.\n- Case $\\,3\\,$: full integration on $\\,\\mathcal{G}_{1}\\,$.\n- Case $\\,4\\,$: reduced integration on $\\,\\mathcal{G}_{2}\\,$.\n- Case $\\,5\\,$: reduced integration plus enhancement on $\\,\\mathcal{G}_{2}\\,$.\n- Case $\\,6\\,$: full integration on $\\,\\mathcal{G}_{2}\\,$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, i.e., $\\,\\big[ n_{\\mathrm{spur}}^{(1)}, n_{\\mathrm{spur}}^{(2)}, n_{\\mathrm{spur}}^{(3)}, n_{\\mathrm{spur}}^{(4)}, n_{\\mathrm{spur}}^{(5)}, n_{\\mathrm{spur}}^{(6)} \\big]\\,$, where each entry is an integer in the specified order of cases. No physical units are required in the output because the requested final quantities are pure counts.",
            "solution": "The problem requires an implementation and verification of numerical techniques in computational solid mechanics, specifically concerning the four-node bilinear quadrilateral ($\\mathrm{Q4}$) element in two-dimensional linear elasticity. The core task is to demonstrate the emergence of spurious zero-energy modes (hourglassing) under reduced integration and their subsequent elimination using an enhanced displacement field method. The analysis will be performed by computing the eigenvalues of different element stiffness matrices.\n\nThe derivation begins with the Principle of Virtual Work, which states that for a body in equilibrium, the virtual work done by external forces is equal to the change in internal strain energy for any admissible virtual displacement. For a single finite element, this is expressed as $\\delta \\Pi_{e} = \\int_{\\Omega_e} \\delta\\boldsymbol{\\varepsilon}^{\\mathsf{T}}\\boldsymbol{\\sigma} \\,\\mathrm{d}\\Omega - \\delta \\boldsymbol{u}_{e}^{\\mathsf{T}} \\boldsymbol{f}_{e} = 0$, where $\\boldsymbol{\\sigma}$ is the stress tensor, $\\boldsymbol{\\varepsilon}$ is the strain tensor, $\\boldsymbol{u}_e$ is the vector of nodal displacements, and $\\boldsymbol{f}_e$ is the vector of nodal forces.\n\nUsing the linear elastic constitutive relation $\\boldsymbol{\\sigma} = \\boldsymbol{C}\\boldsymbol{\\varepsilon}$ and the strain-displacement relation $\\boldsymbol{\\varepsilon} = \\boldsymbol{B} \\boldsymbol{u}_e$, where $\\boldsymbol{C}$ is the material constitutive matrix and $\\boldsymbol{B}$ is the strain-displacement matrix, the virtual work principle can be rewritten as:\n$$ \\delta \\Pi_{e} = \\int_{\\Omega_e} (\\delta(\\boldsymbol{B}\\boldsymbol{u}_e))^{\\mathsf{T}}\\boldsymbol{C}(\\boldsymbol{B}\\boldsymbol{u}_e) \\,\\mathrm{d}\\Omega - \\delta \\boldsymbol{u}_{e}^{\\mathsf{T}} \\boldsymbol{f}_{e} = 0 $$\n$$ \\delta \\boldsymbol{u}_{e}^{\\mathsf{T}} \\left( \\int_{\\Omega_e} \\boldsymbol{B}^{\\mathsf{T}} \\boldsymbol{C} \\boldsymbol{B} \\,\\mathrm{d}\\Omega \\right) \\boldsymbol{u}_{e} - \\delta \\boldsymbol{u}_{e}^{\\mathsf{T}} \\boldsymbol{f}_{e} = 0 $$\nSince this must hold for any arbitrary virtual displacement $\\delta \\boldsymbol{u}_e$, the element stiffness matrix $\\boldsymbol{K}_e$ is identified as:\n$$ \\boldsymbol{K}_e = \\int_{\\Omega_e} \\boldsymbol{B}^{\\mathsf{T}} \\boldsymbol{C} \\boldsymbol{B} \\,\\mathrm{d}\\Omega $$\nThe integral is over the element's physical domain $\\Omega_e$. For an isoparametric element, we map this integral to a parent domain, typically $(\\xi, \\eta) \\in [-1, 1]^2$, using the Jacobian $\\boldsymbol{J}$ of the geometric mapping: $\\mathrm{d}\\Omega = \\det(\\boldsymbol{J}) \\,\\mathrm{d}\\xi\\,\\mathrm{d}\\eta$. The stiffness matrix becomes:\n$$ \\boldsymbol{K}_e = \\int_{-1}^{1}\\int_{-1}^{1} \\boldsymbol{B}(\\xi, \\eta)^{\\mathsf{T}} \\boldsymbol{C} \\boldsymbol{B}(\\xi, \\eta) \\det(\\boldsymbol{J}(\\xi, \\eta)) \\,\\mathrm{d}\\xi\\,\\mathrm{d}\\eta $$\nThe strain-displacement matrix $\\boldsymbol{B}$ is constructed from the physical gradients of the shape functions $N_i$. For node $i$, the contribution $\\boldsymbol{B}_i$ is $\\boldsymbol{B}_i = \\begin{bmatrix} \\partial N_i/\\partial x & 0 \\\\ 0 & \\partial N_i/\\partial y \\\\ \\partial N_i/\\partial y & \\partial N_i/\\partial x \\end{bmatrix}$. The full matrix is $\\boldsymbol{B} = [\\boldsymbol{B}_1, \\boldsymbol{B}_2, \\boldsymbol{B}_3, \\boldsymbol{B}_4]$. The physical gradients are found from parent-space gradients via the chain rule: $\\nabla_{\\boldsymbol{x}} N_i = \\boldsymbol{J}^{-1} \\nabla_{\\boldsymbol{\\xi}} N_i$.\n\nThis integral for $\\boldsymbol{K}_e$ is computed numerically using Gauss quadrature. The choice of quadrature rule is critical.\n1.  **Full Integration ($\\boldsymbol{K}_{\\mathrm{full}}$)**: A $2\\times 2$ Gauss rule is used. It has $4$ integration points $(\\xi_{gp}, \\eta_{gp})$ with weights $w_{gp}=1$. This order of integration is sufficient to exactly integrate the stiffness matrix for a rectangular or parallelogram element and provides the correct rank for general quadrilaterals, ensuring no spurious zero-energy modes. The matrix rank is $n_{dof} - n_{rbm} = 8 - 3 = 5$, where $n_{dof}$ is the number of degrees of freedom and $n_{rbm}$ is the number of rigid body modes. The null space of $\\boldsymbol{K}_{\\mathrm{full}}$ has dimension $3$ and is spanned by the rigid body modes.\n\n2.  **Reduced Integration ($\\boldsymbol{K}_{\\mathrm{red}}$)**: A single Gauss point at the element center $(\\xi, \\eta) = (0, 0)$ with weight $w=4$ is used. This is computationally efficient. However, the strain-displacement matrix $\\boldsymbol{B}(0,0)$ evaluated at this single point may not capture all possible deformation modes. Certain deformation patterns, known as hourglass modes, produce zero strain at the element center, i.e., $\\boldsymbol{B}(0,0)\\boldsymbol{u}_{hg} = \\boldsymbol{0}$ for an hourglass nodal displacement vector $\\boldsymbol{u}_{hg}$. Consequently, these modes have zero strain energy ($\\frac{1}{2}\\boldsymbol{u}_{hg}^{\\mathsf{T}}\\boldsymbol{K}_{\\mathrm{red}}\\boldsymbol{u}_{hg}=0$) and appear as additional vectors in the null space of $\\boldsymbol{K}_{\\mathrm{red}}$. The rank of $\\boldsymbol{K}_{\\mathrm{red}}$ is lower than $5$, leading to a rank-deficient and overly flexible element formulation that can be unstable in a global analysis. For a rectangular element, two such hourglass modes exist, so $\\mathrm{rank}(\\boldsymbol{K}_{\\mathrm{red}})=3$ and $\\mathrm{dim}(\\mathcal{N}(\\boldsymbol{K}_{\\mathrm{red}}))=5$. For a general parallelogram, one hourglass mode exists, so $\\mathrm{rank}(\\boldsymbol{K}_{\\mathrm{red}})=4$ and $\\mathrm{dim}(\\mathcal{N}(\\boldsymbol{K}_{\\mathrm{red}}))=4$.\n\n3.  **Reduced Integration with Enhancement ($\\boldsymbol{K}_{\\mathrm{red+enh}}$)**: To restore stability to the reduced integration element, a stabilization term $\\boldsymbol{K}_{\\mathrm{enh}}$ is added. This term must only penalize the spurious hourglass modes while leaving the rigid body modes and other valid deformations unaffected. This is achieved by defining a modified potential energy $\\Pi_{e, \\text{enh}} = \\Pi_{e, \\text{red}} + \\Pi_{e, \\text{stab}}$, where $\\Pi_{e, \\text{stab}}$ is a penalty energy associated with hourglass deformations. We define the hourglass subspace $\\mathcal{H}$ as the part of the null space of $\\boldsymbol{K}_{\\mathrm{red}}$ that is orthogonal to the rigid body subspace $\\mathcal{R}$, i.e., $\\mathcal{H} = \\mathcal{N}(\\boldsymbol{K}_{\\mathrm{red}}) \\ominus \\mathcal{R}$. Let $\\boldsymbol{H}$ be a matrix whose columns form an orthonormal basis for $\\mathcal{H}$. The hourglass penalty energy is defined as $\\Pi_{e, \\text{stab}} = \\frac{1}{2}\\beta \\| \\boldsymbol{H}^{\\mathsf{T}}\\boldsymbol{u}_e \\|_2^2 = \\frac{1}{2}\\beta \\boldsymbol{u}_e^{\\mathsf{T}}\\boldsymbol{H}\\boldsymbol{H}^{\\mathsf{T}}\\boldsymbol{u}_e$. Taking the second variation with respect to $\\boldsymbol{u}_e$ gives the stabilization stiffness $\\boldsymbol{K}_{\\mathrm{enh}} = \\beta \\boldsymbol{H}\\boldsymbol{H}^{\\mathsf{T}}$. The total stiffness is $\\boldsymbol{K}_{\\mathrm{red+enh}} = \\boldsymbol{K}_{\\mathrm{red}} + \\boldsymbol{K}_{\\mathrm{enh}}$. The stabilization parameter $\\beta$ is chosen based on material ($\\mu$) and geometric ($L$) properties to provide appropriate stiffness. Crucially, if $\\boldsymbol{u}_e$ is a rigid body mode, it is orthogonal to the columns of $\\boldsymbol{H}$, so $\\boldsymbol{H}^{\\mathsf{T}}\\boldsymbol{u}_e=\\boldsymbol{0}$ and no penalty is applied. If $\\boldsymbol{u}_e$ is an hourglass mode, it lies in the span of $\\boldsymbol{H}$, and the penalty term provides the necessary energy to prevent spurious behavior.\n\nThe algorithm to identify the hourglass basis $\\boldsymbol{H}$ proceeds as follows:\n- Find an orthonormal basis for the null space of $\\boldsymbol{K}_{\\mathrm{red}}$, denoted by the columns of matrix $\\boldsymbol{N}_{\\text{basis}}$.\n- Construct the rigid body modes $\\boldsymbol{r}_1, \\boldsymbol{r}_2, \\boldsymbol{r}_3$ and find an orthonormal basis for the space they span, $\\mathcal{R}$, denoted by the columns of $\\boldsymbol{R}_{\\text{basis}}$.\n- A vector $\\boldsymbol{v}$ is an hourglass mode if it is in $\\mathcal{N}(\\boldsymbol{K}_{\\mathrm{red}})$ and orthogonal to $\\mathcal{R}$. This means $\\boldsymbol{v} = \\boldsymbol{N}_{\\text{basis}}\\boldsymbol{c}$ for some coefficient vector $\\boldsymbol{c}$, and $\\boldsymbol{R}_{\\text{basis}}^{\\mathsf{T}}\\boldsymbol{v} = \\boldsymbol{0}$. This leads to the condition $(\\boldsymbol{R}_{\\text{basis}}^{\\mathsf{T}}\\boldsymbol{N}_{\\text{basis}})\\boldsymbol{c} = \\boldsymbol{0}$.\n- We solve for the null space of the matrix $(\\boldsymbol{R}_{\\text{basis}}^{\\mathsf{T}}\\boldsymbol{N}_{\\text{basis}})$ to find the admissible coefficients $\\boldsymbol{c}$. Let this null space basis be $\\boldsymbol{Z}$.\n- The orthonormal basis for the hourglass subspace is then $\\boldsymbol{H} = \\boldsymbol{N}_{\\text{basis}}\\boldsymbol{Z}$.\n\nThe final step is to diagnose the number of spurious modes, $n_{\\mathrm{spur}}$, for each stiffness matrix. We compute the eigenvalues $\\{\\lambda_i\\}$ of the matrix. The number of zero-energy modes, $n_0$, is the count of eigenvalues smaller than a numerical threshold $\\varepsilon$. Since a free element has $3$ physical zero-energy modes (the rigid body modes), the number of spurious modes is $n_{\\mathrm{spur}}=\\max(0, n_0-3)$. This procedure allows for a quantitative verification of the effectiveness of each integration and stabilization scheme.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import null_space, orth\n\nclass Q4Element:\n    \"\"\"\n    Represents a 4-node bilinear quadrilateral element in 2D elasticity.\n    \"\"\"\n    def __init__(self, nodes, E, nu):\n        \"\"\"\n        Initializes the element.\n        :param nodes: A list of 4 tuples, each with (x, y) coordinates of the nodes.\n        :param E: Young's modulus.\n        :param nu: Poisson's ratio.\n        \"\"\"\n        self.nodes = np.array(nodes)  # 4x2 array of (x,y) coords\n        if self.nodes.shape != (4, 2):\n            raise ValueError(\"Nodes must be a 4x2 array.\")\n        self.E = E\n        self.nu = nu\n        # Pre-compute the constitutive matrix for plane strain\n        self.C = self._get_constitutive_matrix()\n\n    def _get_constitutive_matrix(self):\n        \"\"\"Computes the plane strain constitutive matrix C.\"\"\"\n        factor = self.E / ((1 + self.nu) * (1 - 2 * self.nu))\n        C = factor * np.array([\n            [1 - self.nu, self.nu, 0],\n            [self.nu, 1 - self.nu, 0],\n            [0, 0, (1 - 2 * self.nu) / 2]\n        ])\n        return C\n\n    def get_shape_func_grads_parent(self, xi, eta):\n        \"\"\"Computes gradients of shape functions w.r.t. parent coordinates (xi, eta).\"\"\"\n        dN_dxi = 0.25 * np.array([-(1 - eta), (1 - eta), (1 + eta), -(1 + eta)])\n        dN_deta = 0.25 * np.array([-(1 - xi), -(1 + xi), (1 + xi), (1 - xi)])\n        return dN_dxi, dN_deta\n\n    def get_B_matrix_and_jacobian_det(self, xi, eta):\n        \"\"\"Computes the strain-displacement matrix B and Jacobian determinant.\"\"\"\n        dN_dxi, dN_deta = self.get_shape_func_grads_parent(xi, eta)\n\n        # Jacobian matrix J = [[dx/dxi, dy/dxi], [dx/deta, dy/deta]]\n        J = np.zeros((2, 2))\n        J[0, 0] = np.dot(dN_dxi, self.nodes[:, 0])  # dx/dxi\n        J[0, 1] = np.dot(dN_dxi, self.nodes[:, 1])  # dy/dxi\n        J[1, 0] = np.dot(dN_deta, self.nodes[:, 0]) # dx/deta\n        J[1, 1] = np.dot(dN_deta, self.nodes[:, 1]) # dy/deta\n        \n        detJ = np.linalg.det(J)\n        if detJ <= 0:\n            raise ValueError(\"Jacobian determinant is non-positive, check node ordering.\")\n        \n        invJ = np.linalg.inv(J)\n\n        # Gradients of N w.r.t. physical coordinates (x, y)\n        dN_dxy = invJ @ np.vstack((dN_dxi, dN_deta))\n        dN_dx, dN_dy = dN_dxy[0, :], dN_dxy[1, :]\n\n        # Strain-displacement matrix B\n        B = np.zeros((3, 8))\n        for i in range(4):\n            B[0, 2 * i] = dN_dx[i]\n            B[1, 2 * i + 1] = dN_dy[i]\n            B[2, 2 * i] = dN_dy[i]\n            B[2, 2 * i + 1] = dN_dx[i]\n            \n        return B, detJ\n\n    def get_stiffness_matrix_reduced(self):\n        \"\"\"Computes the stiffness matrix using 1-point reduced integration.\"\"\"\n        xi, eta, w = 0.0, 0.0, 4.0\n        B, detJ = self.get_B_matrix_and_jacobian_det(xi, eta)\n        K = B.T @ self.C @ B * detJ * w\n        return K\n\n    def get_stiffness_matrix_full(self):\n        \"\"\"Computes the stiffness matrix using 2x2 full integration.\"\"\"\n        gp_coord = 1.0 / np.sqrt(3)\n        gauss_points = [(-gp_coord, -gp_coord), (gp_coord, -gp_coord),\n                        (gp_coord, gp_coord), (-gp_coord, gp_coord)]\n        weights = [1.0, 1.0, 1.0, 1.0]\n\n        K = np.zeros((8, 8))\n        for (xi, eta), w in zip(gauss_points, weights):\n            B, detJ = self.get_B_matrix_and_jacobian_det(xi, eta)\n            K += B.T @ self.C @ B * detJ * w\n        return K\n\n    def get_stiffness_matrix_enhanced(self):\n        \"\"\"Computes the stiffness matrix with reduced integration plus hourglass control.\"\"\"\n        K_red = self.get_stiffness_matrix_reduced()\n        \n        # 1. Find an orthonormal basis for the null space of K_red\n        N_basis = null_space(K_red)\n\n        # 2. Construct rigid body modes and find an orthonormal basis for their span\n        centroid = np.mean(self.nodes, axis=0)\n        nodes_c = self.nodes - centroid\n        \n        r1 = np.tile([1, 0], 4)\n        r2 = np.tile([0, 1], 4)\n        r3 = np.zeros(8)\n        for i in range(4):\n            r3[2*i] = -nodes_c[i, 1]\n            r3[2*i+1] = nodes_c[i, 0]\n            \n        R_matrix = np.vstack([r1, r2, r3]).T\n        R_basis = orth(R_matrix)\n        \n        # 3. Find hourglass subspace basis H\n        if N_basis.shape[1] > R_basis.shape[1]:\n            M = R_basis.T @ N_basis\n            Z = null_space(M)\n            H = N_basis @ Z\n        else:\n            # The null space of K_red only contains rigid body modes (or fewer).\n            return K_red\n\n        if H.shape[1] == 0:  # No non-rigid-body modes found in the null space\n            return K_red\n        \n        # 4. Calculate stabilization matrix K_enh\n        # Area A using shoelace formula\n        x, y = self.nodes[:, 0], self.nodes[:, 1]\n        A = 0.5 * np.abs(np.dot(x, np.roll(y, -1)) - np.dot(y, np.roll(x, -1)))\n        \n        L = np.sqrt(A)\n        mu = self.E / (2 * (1 + self.nu))\n        alpha = 1.0\n        beta = alpha * mu * L\n        \n        K_enh = beta * (H @ H.T)\n        \n        return K_red + K_enh\n\ndef count_spurious_modes(K):\n    \"\"\"\n    Counts spurious zero-energy modes from a stiffness matrix K.\n    A mode is considered zero-energy if its eigenvalue is close to zero.\n    There are 3 rigid-body modes, so any zero-energy modes beyond 3 are spurious.\n    \"\"\"\n    # Use eigvalsh for symmetric matrices for better performance and stability\n    eigenvalues = np.linalg.eigvalsh(K)\n    \n    if len(eigenvalues) == 0:\n        return 0\n        \n    lambda_max = np.max(np.abs(eigenvalues))\n    # Epsilon threshold as per problem specification\n    epsilon = max(1e-8, 1e-8 * lambda_max) if lambda_max > 0 else 1e-8\n    \n    # Count eigenvalues whose absolute value is less than the threshold\n    n0 = np.sum(np.abs(eigenvalues) < epsilon)\n    \n    # Number of spurious modes is the number of zero modes minus 3 rigid body modes\n    n_spur = max(0, n0 - 3)\n    return int(n_spur)\n\ndef solve():\n    # Define material properties and test geometries\n    E = 210e9\n    nu = 0.30\n\n    nodes_g1 = [(0, 0), (1, 0), (1, 1), (0, 1)]  # Square\n    nodes_g2 = [(0, 0), (2, 0), (2.2, 1), (0.2, 1)] # Distorted parallelogram\n\n    # Define test cases: (geometry_nodes, stiffness_matrix_method_name)\n    test_cases = [\n        (nodes_g1, 'reduced'),\n        (nodes_g1, 'enhanced'),\n        (nodes_g1, 'full'),\n        (nodes_g2, 'reduced'),\n        (nodes_g2, 'enhanced'),\n        (nodes_g2, 'full'),\n    ]\n\n    results = []\n    for nodes, method in test_cases:\n        element = Q4Element(nodes, E, nu)\n        \n        if method == 'reduced':\n            K = element.get_stiffness_matrix_reduced()\n        elif method == 'enhanced':\n            K = element.get_stiffness_matrix_enhanced()\n        elif method == 'full':\n            K = element.get_stiffness_matrix_full()\n        \n        n_spur = count_spurious_modes(K)\n        results.append(n_spur)\n\n    # Print the final results in the specified format\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```"
        },
        {
            "introduction": "After diagnosing the issue of spurious modes, the next step is to understand the theoretical underpinnings of the solution. This practice focuses on the essential mathematical properties that an \"incompatible\" or enhanced displacement field must satisfy to be physically and mathematically consistent . By analytically proving that a candidate mode vanishes on the element boundary and is orthogonal to rigid body motions, you will build a foundational understanding of the rules that govern the design of robust enhanced elements.",
            "id": "3573667",
            "problem": "Consider a $4$-node isoparametric bilinear quadrilateral element ($Q4$) in the Finite Element Method (FEM) for small-strain, linear elastic analysis. To enhance the element’s bending performance while preserving consistency with the principle of virtual work, an internal (element-level) incompatible displacement field is added to the standard bilinear displacement interpolation. To prevent spurious coupling with rigid body motions and to avoid inter-element incompatibilities, the enhanced displacement field must vanish on the entire element boundary and be $L^{2}$-orthogonal to all rigid body motions over the reference element.\n\nLet the reference domain be $\\Omega = [-1,1] \\times [-1,1]$ with local coordinates $(\\xi,\\eta)$. Define the vector-valued enhanced displacement mode (incompatible mode) using polynomial terms that reflect the structure $\\xi(1-\\eta^{2})$ and $\\eta(1-\\xi^{2})$, but are further multiplied by the element-boundary bubble to enforce vanishing on $\\partial\\Omega$:\n$$\n\\widetilde{\\mathbf{u}}(\\xi,\\eta) \\;=\\; c\n\\begin{pmatrix}\n\\xi\\,(1-\\xi^{2})\\,(1-\\eta^{2}) \\\\\n\\eta\\,(1-\\xi^{2})\\,(1-\\eta^{2})\n\\end{pmatrix},\n$$\nwhere $c>0$ is a scalar normalization constant to be determined.\n\nUse the $L^{2}$ inner product on $\\Omega$ defined by\n$$\n\\langle \\mathbf{a},\\mathbf{b}\\rangle \\;=\\; \\int_{-1}^{1}\\int_{-1}^{1} \\mathbf{a}(\\xi,\\eta)\\cdot\\mathbf{b}(\\xi,\\eta)\\,\\mathrm{d}\\xi\\,\\mathrm{d}\\eta.\n$$\nLet the rigid body motions over $\\Omega$ be represented by the constant translations $\\mathbf{t}_{x} = (1,0)^{\\mathsf{T}}$, $\\mathbf{t}_{y} = (0,1)^{\\mathsf{T}}$, and the in-plane rotation about the origin $\\mathbf{r}(\\xi,\\eta) = (-\\eta,\\xi)^{\\mathsf{T}}$.\n\nStarting only from these definitions and the requirement that incompatible modes contribute no spurious energy under rigid motions, carry out the following:\n\n$1.$ Prove that $\\widetilde{\\mathbf{u}}(\\xi,\\eta)$ vanishes on the entire boundary $\\partial\\Omega$.\n\n$2.$ Prove that the orthogonality conditions\n$$\n\\langle \\widetilde{\\mathbf{u}},\\mathbf{t}_{x}\\rangle \\;=\\; \\langle \\widetilde{\\mathbf{u}},\\mathbf{t}_{y}\\rangle \\;=\\; \\langle \\widetilde{\\mathbf{u}},\\mathbf{r}\\rangle \\;=\\; 0\n$$\nare satisfied.\n\n$3.$ Determine the unique positive normalization factor $c$ such that the enhanced mode has unit $L^{2}$ norm,\n$$\n\\|\\widetilde{\\mathbf{u}}\\|_{L^{2}(\\Omega)} \\;=\\; \\left(\\int_{-1}^{1}\\int_{-1}^{1} \\|\\widetilde{\\mathbf{u}}(\\xi,\\eta)\\|^{2}\\,\\mathrm{d}\\xi\\,\\mathrm{d}\\eta\\right)^{1/2} \\;=\\; 1.\n$$\n\nYour final answer must be the exact closed-form expression for $c$ (no units, no rounding).",
            "solution": "### Solution\n\nThe problem requires proofs of certain properties of the given incompatible displacement mode $\\widetilde{\\mathbf{u}}(\\xi,\\eta)$ and the calculation of its normalization constant $c$. The tasks are addressed in the specified order.\n\n**1. Proof of Vanishing on the Boundary**\n\nThe incompatible displacement field is given by:\n$$\n\\widetilde{\\mathbf{u}}(\\xi,\\eta) = c\n\\begin{pmatrix}\n\\xi\\,(1-\\xi^{2})\\,(1-\\eta^{2}) \\\\\n\\eta\\,(1-\\xi^{2})\\,(1-\\eta^{2})\n\\end{pmatrix}\n$$\nThe reference domain is the square $\\Omega = [-1,1] \\times [-1,1]$. Its boundary, $\\partial\\Omega$, consists of four segments:\n-   The line where $\\xi = 1$ for $\\eta \\in [-1,1]$.\n-   The line where $\\xi = -1$ for $\\eta \\in [-1,1]$.\n-   The line where $\\eta = 1$ for $\\xi \\in [-1,1]$.\n-   The line where $\\eta = -1$ for $\\xi \\in [-1,1]$.\n\nAny point $(\\xi,\\eta) \\in \\partial\\Omega$ must satisfy either $|\\xi| = 1$ or $|\\eta| = 1$.\n\nLet's examine the common factor $(1-\\xi^{2})(1-\\eta^{2})$ in both components of $\\widetilde{\\mathbf{u}}(\\xi,\\eta)$.\n-   If a point lies on the boundary where $|\\xi|=1$, the term $(1-\\xi^{2})$ becomes $(1 - (\\pm 1)^{2}) = 1-1=0$. This makes the entire product $(1-\\xi^{2})(1-\\eta^{2})$ equal to $0$.\n-   If a point lies on the boundary where $|\\eta|=1$, the term $(1-\\eta^{2})$ becomes $(1 - (\\pm 1)^{2}) = 1-1=0$. This also makes the entire product $(1-\\xi^{2})(1-\\eta^{2})$ equal to $0$.\n\nSince for any point on $\\partial\\Omega$ at least one of these conditions holds, the factor $(1-\\xi^{2})(1-\\eta^{2})$ is identically zero for all $(\\xi,\\eta) \\in \\partial\\Omega$. Consequently, both components of $\\widetilde{\\mathbf{u}}(\\xi,\\eta)$ are zero on the boundary.\n$$\n\\widetilde{\\mathbf{u}}(\\xi,\\eta) = \\mathbf{0} \\quad \\forall (\\xi,\\eta) \\in \\partial\\Omega\n$$\nThis completes the proof.\n\n**2. Proof of Orthogonality to Rigid Body Motions**\n\nWe must prove that $\\langle \\widetilde{\\mathbf{u}},\\mathbf{t}_{x}\\rangle = 0$, $\\langle \\widetilde{\\mathbf{u}},\\mathbf{t}_{y}\\rangle = 0$, and $\\langle \\widetilde{\\mathbf{u}},\\mathbf{r}\\rangle = 0$.\n\n-   **Orthogonality to $\\mathbf{t}_{x}$:**\n    The inner product is $\\langle \\widetilde{\\mathbf{u}},\\mathbf{t}_{x}\\rangle = \\int_{-1}^{1}\\int_{-1}^{1} \\widetilde{\\mathbf{u}}(\\xi,\\eta) \\cdot \\mathbf{t}_{x} \\,\\mathrm{d}\\xi\\,\\mathrm{d}\\eta$. The dot product is:\n    $$\n    \\widetilde{\\mathbf{u}} \\cdot \\mathbf{t}_{x} = c \\begin{pmatrix} \\xi(1-\\xi^2)(1-\\eta^2) \\\\ \\eta(1-\\xi^2)(1-\\eta^2) \\end{pmatrix} \\cdot \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix} = c \\xi(1-\\xi^2)(1-\\eta^2)\n    $$\n    The integral is:\n    $$\n    \\langle \\widetilde{\\mathbf{u}},\\mathbf{t}_{x}\\rangle = c \\int_{-1}^{1}\\int_{-1}^{1} \\xi(1-\\xi^2)(1-\\eta^2) \\,\\mathrm{d}\\xi\\,\\mathrm{d}\\eta = c \\left( \\int_{-1}^{1} \\xi(1-\\xi^2)\\,\\mathrm{d}\\xi \\right) \\left( \\int_{-1}^{1} (1-\\eta^2)\\,\\mathrm{d}\\eta \\right)\n    $$\n    The integrand of the first integral, $f(\\xi) = \\xi - \\xi^3$, is an odd function since $f(-\\xi) = (-\\xi) - (-\\xi)^3 = -\\xi + \\xi^3 = -f(\\xi)$. The integral of an odd function over a symmetric interval $[-1,1]$ is zero.\n    $$\n    \\int_{-1}^{1} \\xi(1-\\xi^2)\\,\\mathrm{d}\\xi = 0\n    $$\n    Therefore, $\\langle \\widetilde{\\mathbf{u}},\\mathbf{t}_{x}\\rangle = c \\cdot 0 \\cdot \\left( \\int_{-1}^{1} (1-\\eta^2)\\,\\mathrm{d}\\eta \\right) = 0$.\n\n-   **Orthogonality to $\\mathbf{t}_{y}$:**\n    Similarly, the dot product is:\n    $$\n    \\widetilde{\\mathbf{u}} \\cdot \\mathbf{t}_{y} = c \\begin{pmatrix} \\xi(1-\\xi^2)(1-\\eta^2) \\\\ \\eta(1-\\xi^2)(1-\\eta^2) \\end{pmatrix} \\cdot \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix} = c \\eta(1-\\xi^2)(1-\\eta^2)\n    $$\n    The integral is:\n    $$\n    \\langle \\widetilde{\\mathbf{u}},\\mathbf{t}_{y}\\rangle = c \\int_{-1}^{1}\\int_{-1}^{1} \\eta(1-\\xi^2)(1-\\eta^2) \\,\\mathrm{d}\\xi\\,\\mathrm{d}\\eta = c \\left( \\int_{-1}^{1} (1-\\xi^2)\\,\\mathrm{d}\\xi \\right) \\left( \\int_{-1}^{1} \\eta(1-\\eta^2)\\,\\mathrm{d}\\eta \\right)\n    $$\n    The integrand of the second integral, $g(\\eta) = \\eta - \\eta^3$, is an odd function. Thus, its integral over $[-1,1]$ is zero.\n    $$\n    \\int_{-1}^{1} \\eta(1-\\eta^2)\\,\\mathrm{d}\\eta = 0\n    $$\n    Therefore, $\\langle \\widetilde{\\mathbf{u}},\\mathbf{t}_{y}\\rangle = 0$.\n\n-   **Orthogonality to $\\mathbf{r}$:**\n    The dot product with the rotational mode $\\mathbf{r}(\\xi,\\eta) = (-\\eta, \\xi)^{\\mathsf{T}}$ is:\n    $$\n    \\widetilde{\\mathbf{u}} \\cdot \\mathbf{r} = c \\begin{pmatrix} \\xi(1-\\xi^2)(1-\\eta^2) \\\\ \\eta(1-\\xi^2)(1-\\eta^2) \\end{pmatrix} \\cdot \\begin{pmatrix} -\\eta \\\\ \\xi \\end{pmatrix}\n    $$\n    $$\n    \\widetilde{\\mathbf{u}} \\cdot \\mathbf{r} = c \\left( -\\eta\\xi(1-\\xi^2)(1-\\eta^2) + \\xi\\eta(1-\\xi^2)(1-\\eta^2) \\right) = 0\n    $$\n    Since the integrand is identically zero everywhere in the domain $\\Omega$, the integral is zero.\n    $$\n    \\langle \\widetilde{\\mathbf{u}},\\mathbf{r}\\rangle = \\int_{-1}^{1}\\int_{-1}^{1} 0 \\,\\mathrm{d}\\xi\\,\\mathrm{d}\\eta = 0\n    $$\n    This completes the proof of orthogonality.\n\n**3. Determination of the Normalization Constant $c$**\n\nThe normalization condition is $\\|\\widetilde{\\mathbf{u}}\\|_{L^{2}(\\Omega)} = 1$, which is equivalent to $\\|\\widetilde{\\mathbf{u}}\\|_{L^{2}(\\Omega)}^{2} = 1$.\n$$\n\\int_{-1}^{1}\\int_{-1}^{1} \\|\\widetilde{\\mathbf{u}}(\\xi,\\eta)\\|^{2}\\,\\mathrm{d}\\xi\\,\\mathrm{d}\\eta = 1\n$$\nFirst, calculate the squared Euclidean norm of the vector $\\widetilde{\\mathbf{u}}$:\n$$\n\\|\\widetilde{\\mathbf{u}}\\|^{2} = \\left(c\\xi(1-\\xi^2)(1-\\eta^2)\\right)^2 + \\left(c\\eta(1-\\xi^2)(1-\\eta^2)\\right)^2\n$$\n$$\n\\|\\widetilde{\\mathbf{u}}\\|^{2} = c^2\\xi^2(1-\\xi^2)^2(1-\\eta^2)^2 + c^2\\eta^2(1-\\xi^2)^2(1-\\eta^2)^2\n$$\n$$\n\\|\\widetilde{\\mathbf{u}}\\|^{2} = c^2(\\xi^2 + \\eta^2)(1-\\xi^2)^2(1-\\eta^2)^2\n$$\nNow, we integrate this expression over the domain $\\Omega$:\n$$\n1 = c^2 \\int_{-1}^{1}\\int_{-1}^{1} (\\xi^2 + \\eta^2)(1-\\xi^2)^2(1-\\eta^2)^2 \\,\\mathrm{d}\\xi\\,\\mathrm{d}\\eta\n$$\nWe can split the integral into two parts:\n$$\n\\frac{1}{c^2} = \\int_{-1}^{1}\\int_{-1}^{1} \\xi^2(1-\\xi^2)^2(1-\\eta^2)^2\\,\\mathrm{d}\\xi\\,\\mathrm{d}\\eta + \\int_{-1}^{1}\\int_{-1}^{1} \\eta^2(1-\\xi^2)^2(1-\\eta^2)^2\\,\\mathrm{d}\\xi\\,\\mathrm{d}\\eta\n$$\nThese two integrals can be separated into products of one-dimensional integrals:\n$$\n\\frac{1}{c^2} = \\left( \\int_{-1}^{1} \\xi^2(1-\\xi^2)^2\\,\\mathrm{d}\\xi \\right)\\left( \\int_{-1}^{1} (1-\\eta^2)^2\\,\\mathrm{d}\\eta \\right) + \\left( \\int_{-1}^{1} (1-\\xi^2)^2\\,\\mathrm{d}\\xi \\right)\\left( \\int_{-1}^{1} \\eta^2(1-\\eta^2)^2\\,\\mathrm{d}\\eta \\right)\n$$\nLet's define two helper integrals, noting that the integrands are even functions:\n$$\nJ_1 = \\int_{-1}^{1} (1-x^2)^2\\,\\mathrm{d}x = \\int_{-1}^{1} (1 - 2x^2 + x^4)\\,\\mathrm{d}x = 2 \\left[ x - \\frac{2}{3}x^3 + \\frac{1}{5}x^5 \\right]_0^1 = 2\\left(1 - \\frac{2}{3} + \\frac{1}{5}\\right) = 2\\left(\\frac{15-10+3}{15}\\right) = \\frac{16}{15}\n$$\n$$\nJ_2 = \\int_{-1}^{1} x^2(1-x^2)^2\\,\\mathrm{d}x = \\int_{-1}^{1} (x^2 - 2x^4 + x^6)\\,\\mathrm{d}x = 2 \\left[ \\frac{1}{3}x^3 - \\frac{2}{5}x^5 + \\frac{1}{7}x^7 \\right]_0^1 = 2\\left(\\frac{1}{3} - \\frac{2}{5} + \\frac{1}{7}\\right) = 2\\left(\\frac{35-42+15}{105}\\right) = \\frac{16}{105}\n$$\nSubstituting these results back into the equation for $c$:\n$$\n\\frac{1}{c^2} = (J_2)(J_1) + (J_1)(J_2) = 2 J_1 J_2\n$$\n$$\n\\frac{1}{c^2} = 2 \\left( \\frac{16}{15} \\right) \\left( \\frac{16}{105} \\right) = \\frac{2 \\cdot 256}{15 \\cdot 105} = \\frac{512}{1575}\n$$\nSolving for $c^2$:\n$$\nc^2 = \\frac{1575}{512}\n$$\nSince the problem specifies that $c>0$, we take the positive square root:\n$$\nc = \\sqrt{\\frac{1575}{512}}\n$$\nTo simplify the expression, we find the prime factors:\n$1575 = 3^2 \\cdot 5^2 \\cdot 7 = 225 \\cdot 7$\n$512 = 2^9 = 256 \\cdot 2$\n$$\nc = \\sqrt{\\frac{225 \\cdot 7}{256 \\cdot 2}} = \\frac{\\sqrt{225}\\sqrt{7}}{\\sqrt{256}\\sqrt{2}} = \\frac{15\\sqrt{7}}{16\\sqrt{2}}\n$$\nRationalizing the denominator:\n$$\nc = \\frac{15\\sqrt{7}}{16\\sqrt{2}} \\cdot \\frac{\\sqrt{2}}{\\sqrt{2}} = \\frac{15\\sqrt{14}}{16 \\cdot 2} = \\frac{15\\sqrt{14}}{32}\n$$\nThis is the final expression for the normalization constant $c$.",
            "answer": "$$\\boxed{\\frac{15\\sqrt{14}}{32}}$$"
        },
        {
            "introduction": "The ultimate benchmark for a finite element's correctness is its ability to reproduce fundamental deformation states. This exercise guides you through the numerical implementation of the \"patch test,\" a critical verification standard for an Enhanced Assumed Strain (EAS) element . By confirming that the element can exactly represent a constant strain field without activating parasitic energy modes, you will connect the theoretical design principles of enhanced methods to the practical assurance of a convergent and reliable numerical tool.",
            "id": "3573610",
            "problem": "Design and implement a program that numerically verifies linear completeness for an Enhanced Assumed Strain (EAS) quadrilateral element in small-strain linear elasticity by testing whether enhanced parameters carry zero energy when the nodal displacements correspond to an exact linear displacement field. The check must be performed for a set of prescribed test cases.\n\nBegin from the following fundamental base:\n- In small-strain linear elasticity, the symmetric strain tensor is given by $ \\boldsymbol{\\varepsilon} = \\frac{1}{2}\\left( \\nabla \\mathbf{u} + \\nabla \\mathbf{u}^{T} \\right) $, and the Cauchy stress satisfies the linear constitutive law $ \\boldsymbol{\\sigma} = \\mathbf{C} \\, \\boldsymbol{\\varepsilon} $, where $ \\mathbf{C} $ is the fourth-order elasticity tensor, represented in Voigt form as a symmetric positive definite matrix.\n- For a two-dimensional problem under plane strain conditions with isotropic material, define $ E $ (Young’s modulus, in Pascals) and $ \\nu $ (Poisson’s ratio, dimensionless), and construct the material matrix in Voigt notation $ \\mathbf{C} \\in \\mathbb{R}^{3\\times 3} $ using the Lamé constants $ \\lambda = \\dfrac{E \\nu}{(1+\\nu)(1-2\\nu)} $ and $ \\mu = \\dfrac{E}{2(1+\\nu)} $, as\n$$\n\\mathbf{C} = \\begin{bmatrix}\n\\lambda + 2\\mu & \\lambda & 0 \\\\\n\\lambda & \\lambda + 2 \\mu & 0 \\\\\n0 & 0 & \\mu\n\\end{bmatrix}.\n$$\n- In an Enhanced Assumed Strain formulation, the total strain is decomposed as $ \\boldsymbol{\\varepsilon} = \\boldsymbol{\\varepsilon}^{c} + \\boldsymbol{\\varepsilon}^{E} $, where $ \\boldsymbol{\\varepsilon}^{c} $ is the compatible strain obtained from the displacement interpolation and $ \\boldsymbol{\\varepsilon}^{E} = \\mathbf{G}(\\xi,\\eta) \\, \\boldsymbol{\\alpha} $ is the enhanced strain with internal parameters $ \\boldsymbol{\\alpha} $. For a stationary potential, the first variation with respect to $ \\boldsymbol{\\alpha} $ yields the element-level linear system\n$$\n\\mathbf{H}\\, \\boldsymbol{\\alpha} + \\mathbf{q} = \\mathbf{0}, \\quad \\text{where} \\quad\n\\mathbf{H} = \\int_{\\Omega_e} \\mathbf{G}^{T} \\mathbf{C} \\, \\mathbf{G} \\, \\mathrm{d}\\Omega, \\quad\n\\mathbf{q} = \\int_{\\Omega_e} \\mathbf{G}^{T} \\mathbf{C} \\, \\boldsymbol{\\varepsilon}^{c} \\, \\mathrm{d}\\Omega.\n$$\n- For a linear displacement field in physical coordinates $ u(x,y) = a x + b y $ and $ v(x,y) = c x + d y $, the compatible strain is spatially constant in the element and equals\n$$\n\\boldsymbol{\\varepsilon}^{c} = \\begin{bmatrix}\n\\varepsilon_{xx} \\\\\n\\varepsilon_{yy} \\\\\n\\gamma_{xy}\n\\end{bmatrix} = \\begin{bmatrix}\na \\\\\nd \\\\\nb + c\n\\end{bmatrix}.\n$$\n- Choose an enhanced strain ansatz that is orthogonal to constant compatible strains by construction. Specifically, define a scalar bubble function on the reference square $ (\\xi,\\eta)\\in[-1,1]\\times[-1,1] $ as $ b(\\xi,\\eta) = (1-\\xi^{2})(1-\\eta^{2}) $. Construct a zero-mean function with respect to the physical measure by setting\n$$\n\\psi(\\xi,\\eta) = b(\\xi,\\eta) - \\overline{b}, \\quad \\text{where} \\quad \\overline{b} = \\dfrac{\\int_{-1}^{1}\\int_{-1}^{1} b(\\xi,\\eta)\\, J(\\xi,\\eta)\\, \\mathrm{d}\\xi \\mathrm{d}\\eta}{\\int_{-1}^{1}\\int_{-1}^{1} J(\\xi,\\eta)\\, \\mathrm{d}\\xi \\mathrm{d}\\eta},\n$$\nand $ J(\\xi,\\eta) = \\det \\mathbf{J}(\\xi,\\eta) $ is the Jacobian determinant of the isoparametric bilinear mapping from the reference square to the physical quadrilateral $ \\Omega_e $. Define the enhanced strain matrix as\n$$\n\\mathbf{G}(\\xi,\\eta) = \\psi(\\xi,\\eta) \\, \\mathbf{I}_{3},\n$$\nso that $ \\boldsymbol{\\varepsilon}^{E} = \\psi(\\xi,\\eta)\\, \\boldsymbol{\\alpha} $ with $ \\boldsymbol{\\alpha} \\in \\mathbb{R}^{3} $. This choice guarantees $ \\int_{\\Omega_e} \\mathbf{G} \\, \\mathrm{d}\\Omega = \\mathbf{0} $ and hence $ \\mathbf{q} = \\mathbf{0} $ for any constant compatible strain $ \\boldsymbol{\\varepsilon}^{c} $.\n\nYour task is to implement a program that:\n- Uses isoparametric bilinear shape functions on the reference square $ \\left[-1,1\\right]\\times\\left[-1,1\\right] $ to map to a convex physical quadrilateral element with nodes given in counterclockwise order.\n- Computes the weighted mean $ \\overline{b} $ using tensor-product Gauss–Legendre quadrature of order $ n = 5 $ in each direction (i.e., $ 5\\times 5 $ points), and constructs $ \\psi(\\xi,\\eta) $ accordingly.\n- Assembles $ \\mathbf{H} $ and $ \\mathbf{q} $ numerically using the same quadrature and solves for $ \\boldsymbol{\\alpha} $ from $ \\mathbf{H}\\boldsymbol{\\alpha} + \\mathbf{q} = \\mathbf{0} $.\n- Evaluates the enhanced energy\n$$\n\\mathcal{E}_{E} = \\dfrac{1}{2}\\, \\boldsymbol{\\alpha}^{T} \\mathbf{H}\\, \\boldsymbol{\\alpha}.\n$$\n- Declares the test as passed if $ \\mathcal{E}_{E} $ is numerically negligible relative to a scale set by the element area and the compatible strain energy density. Use the polygon area of the quadrilateral $ A_e $ and the energy density scale $ \\frac{1}{2}\\, \\boldsymbol{\\varepsilon}^{c\\,T} \\mathbf{C} \\boldsymbol{\\varepsilon}^{c} $. Define the tolerance as\n$$\n\\mathrm{tol} = \\max\\!\\left(10^{-12},\\, 10^{-12} \\times \\dfrac{1}{2}\\, A_e\\, \\boldsymbol{\\varepsilon}^{c\\,T} \\mathbf{C} \\boldsymbol{\\varepsilon}^{c}\\right),\n$$\nand report the boolean $ \\left| \\mathcal{E}_{E} \\right| \\le \\mathrm{tol} $.\n\nAssume plane strain with isotropic material properties $ E $ and $ \\nu $ common to all cases, with $ E = 210\\times 10^{9} $ (Pascals) and $ \\nu = 0.3 $ (dimensionless). All physical quantities that are not dimensionless must be in the International System of Units (SI). No angles are involved, and no percentage quantities are required.\n\nThe isoparametric bilinear mapping uses the standard shape functions\n$$\n\\begin{aligned}\n&N_{1}(\\xi,\\eta) = \\tfrac{1}{4}(1-\\xi)(1-\\eta), \\quad\nN_{2}(\\xi,\\eta) = \\tfrac{1}{4}(1+\\xi)(1-\\eta),\\\\\n&N_{3}(\\xi,\\eta) = \\tfrac{1}{4}(1+\\xi)(1+\\eta), \\quad\nN_{4}(\\xi,\\eta) = \\tfrac{1}{4}(1-\\xi)(1+\\eta).\n\\end{aligned}\n$$\n\nFor each test case, apply nodal displacements consistent with the linear displacement field $ u(x,y)=a x + b y $ and $ v(x,y)=c x + d y $ evaluated at the nodal coordinates $ (x_i,y_i) $. Although the computation of $ \\boldsymbol{\\varepsilon}^{c} $ is independent of nodal interpolation for this field, constructing the nodal values ensures the test adheres to the protocol of applying a linear patch.\n\nTest suite:\n- Case $ 1 $: Nodes $ (0,0),(1,0),(1,1),(0,1) $, parameters $ a=1, b=2, c=3, d=4 $.\n- Case $ 2 $: Nodes $ (1,1),(3,1),(3,2.5),(1,2.5) $, parameters $ a=0.5, b=-1.2, c=2.3, d=0.7 $.\n- Case $ 3 $: Nodes $ (0,0),(2,0.2),(2.2,1.8),(0.1,1.6) $, parameters $ a=-1.0, b=0.3, c=0.0, d=1.5 $.\n- Case $ 4 $: Nodes $ (0,0),(1,0),(1.0,0.05),(0.0,0.05) $, parameters $ a=10.0, b=-5.0, c=4.0, d=-2.0 $.\n- Case $ 5 $: Nodes $ (0,0),(2,0),(2.5,1.0),(-0.1,1.2) $, parameters $ a=0, b=0, c=0, d=0 $.\n\nYour program must compute, for each case, the boolean test result indicating whether $ \\mathcal{E}_{E} $ is below the specified tolerance, and produce a single line of output containing the results as a comma-separated list enclosed in square brackets, for example $ [\\mathrm{result1},\\mathrm{result2},\\mathrm{result3},\\mathrm{result4},\\mathrm{result5}] $, where each entry is either $ \\mathrm{True} $ or $ \\mathrm{False} $.",
            "solution": "The user has requested the design and implementation of a program to numerically verify the linear completeness of a specific Enhanced Assumed Strain (EAS) quadrilateral element. This verification is a cornerstone of the patch test in computational mechanics, ensuring that an element formulation can exactly reproduce a constant strain state, which is a necessary condition for convergence. The problem is scientifically valid and well-posed, providing all necessary theoretical foundations and numerical data for a complete solution.\n\nThe verification procedure involves the following structured steps:\n\n1.  **Define Material and Geometric Properties**: For each test case, we establish the material constitutive model and the element's geometry via an isoparametric mapping.\n2.  **Construct Enhanced Strain Field**: We define the enhanced strain field based on a zero-mean function, a critical step for ensuring orthogonality to constant strain fields.\n3.  **Assemble and Solve the EAS System**: We numerically assemble the matrices governing the enhanced parameters and solve for these parameters.\n4.  **Evaluate Energy and Verify**: We calculate the energy contribution from the enhanced strain field and check if it is numerically negligible, as predicted by theory.\n\n### Step 1: Material and Geometric Formulation\n\nThe analysis is performed under two-dimensional plane strain conditions with a linear isotropic elastic material. The material behavior is described by the fourth-order elasticity tensor, which is represented in Voigt notation by a $3 \\times 3$ matrix $ \\mathbf{C} $. Given Young's modulus $ E $ and Poisson's ratio $ \\nu $, we first compute the Lamé constants $ \\lambda $ and $ \\mu $:\n$$\n\\lambda = \\frac{E \\nu}{(1+\\nu)(1-2\\nu)}, \\quad \\mu = \\frac{E}{2(1+\\nu)}\n$$\nThe plane strain constitutive matrix is then:\n$$\n\\mathbf{C} = \\begin{bmatrix}\n\\lambda + 2\\mu & \\lambda & 0 \\\\\n\\lambda & \\lambda + 2 \\mu & 0 \\\\\n0 & 0 & \\mu\n\\end{bmatrix}\n$$\nThe element's geometry is defined by an isoparametric mapping from a parent reference square $ (\\xi, \\eta) \\in [-1, 1] \\times [-1, 1] $ to the physical quadrilateral in the $ (x, y) $ plane. The mapping is given by:\n$$\n\\mathbf{x}(\\xi, \\eta) = \\sum_{i=1}^{4} N_i(\\xi, \\eta) \\mathbf{x}_i,\n$$\nwhere $ \\mathbf{x}_i = (x_i, y_i) $ are the nodal coordinates and $ N_i $ are the standard bilinear shape functions. The transformation's local behavior is captured by the Jacobian matrix $ \\mathbf{J} $:\n$$\n\\mathbf{J}(\\xi, \\eta) = \\frac{\\partial(x, y)}{\\partial(\\xi, \\eta)} = \\begin{bmatrix} \\partial x / \\partial \\xi & \\partial y / \\partial \\xi \\\\ \\partial x / \\partial \\eta & \\partial y / \\partial \\eta \\end{bmatrix} = \\begin{bmatrix}\n\\sum \\frac{\\partial N_i}{\\partial \\xi} x_i & \\sum \\frac{\\partial N_i}{\\partial \\xi} y_i \\\\\n\\sum \\frac{\\partial N_i}{\\partial \\eta} x_i & \\sum \\frac{\\partial N_i}{\\partial \\eta} y_i\n\\end{bmatrix}\n$$\nThe differential area element transforms as $ \\mathrm{d}\\Omega = J(\\xi, \\eta) \\mathrm{d}\\xi \\mathrm{d}\\eta $, where $ J(\\xi, \\eta) = \\det(\\mathbf{J}) $ is the Jacobian determinant. All integrals over the physical element domain $ \\Omega_e $ are evaluated numerically on the reference square using a $ 5 \\times 5 $ tensor-product Gauss-Legendre quadrature rule.\n\n### Step 2: Construction of the Enhanced Strain Field\n\nIn the EAS method, the strain tensor is additively decomposed into a compatible part $ \\boldsymbol{\\varepsilon}^c $ (derived from nodal displacements) and an enhanced part $ \\boldsymbol{\\varepsilon}^E $. A key property for passing the patch test is that for a linear displacement field, the enhanced strain field must carry zero energy. This is achieved by constructing an enhanced interpolation that is orthogonal to constant compatible strains.\n\nA linear displacement field $ u(x,y) = ax+by $, $ v(x,y) = cx+dy $ results in a spatially constant compatible strain field:\n$$\n\\boldsymbol{\\varepsilon}^{c} = \\begin{bmatrix} a \\\\ d \\\\ b+c \\end{bmatrix}.\n$$\nThe enhanced strain field is defined as $ \\boldsymbol{\\varepsilon}^E = \\mathbf{G}(\\xi, \\eta) \\boldsymbol{\\alpha} $, where $ \\boldsymbol{\\alpha} \\in \\mathbb{R}^3 $ are the internal parameters. The chosen interpolation matrix is $ \\mathbf{G}(\\xi, \\eta) = \\psi(\\xi, \\eta) \\mathbf{I}_3 $, where $ \\mathbf{I}_3 $ is the $ 3 \\times 3 $ identity matrix and $ \\psi(\\xi, \\eta) $ is a scalar function designed to be orthogonal to constants over the element domain. We construct $ \\psi $ from a bubble function $ b(\\xi, \\eta) = (1-\\xi^2)(1-\\eta^2) $ by subtracting its weighted mean $ \\overline{b} $:\n$$\n\\psi(\\xi, \\eta) = b(\\xi, \\eta) - \\overline{b}, \\quad \\text{where} \\quad \\overline{b} = \\frac{\\int_{\\Omega_e} b(\\xi, \\eta) \\mathrm{d}\\Omega}{\\int_{\\Omega_e} 1 \\mathrm{d}\\Omega} = \\frac{\\int_{-1}^{1}\\int_{-1}^{1} b(\\xi, \\eta) J(\\xi, \\eta) \\mathrm{d}\\xi \\mathrm{d}\\eta}{\\int_{-1}^{1}\\int_{-1}^{1} J(\\xi, \\eta) \\mathrm{d}\\xi \\mathrm{d}\\eta}.\n$$\nThis construction guarantees that $ \\int_{\\Omega_e} \\psi(\\xi, \\eta) \\mathrm{d}\\Omega = 0 $, which is a crucial property.\n\n### Step 3: Assembly and Solution of the EAS System\n\nThe internal parameters $ \\boldsymbol{\\alpha} $ are determined by solving the local system $ \\mathbf{H} \\boldsymbol{\\alpha} + \\mathbf{q} = \\mathbf{0} $, which arises from the stationarity of the potential energy with respect to $ \\boldsymbol{\\alpha} $. The matrix $ \\mathbf{H} $ and vector $ \\mathbf{q} $ are given by:\n$$\n\\mathbf{H} = \\int_{\\Omega_e} \\mathbf{G}^{T} \\mathbf{C} \\mathbf{G} \\, \\mathrm{d}\\Omega = \\int_{-1}^{1}\\int_{-1}^{1} \\psi^2(\\xi, \\eta) \\mathbf{C} \\, J(\\xi, \\eta) \\mathrm{d}\\xi \\mathrm{d}\\eta\n$$\n$$\n\\mathbf{q} = \\int_{\\Omega_e} \\mathbf{G}^{T} \\mathbf{C} \\boldsymbol{\\varepsilon}^c \\, \\mathrm{d}\\Omega = \\int_{-1}^{1}\\int_{-1}^{1} \\psi(\\xi, \\eta) (\\mathbf{C} \\boldsymbol{\\varepsilon}^c) \\, J(\\xi, \\eta) \\mathrm{d}\\xi \\mathrm{d}\\eta\n$$\nSince $ \\boldsymbol{\\varepsilon}^c $ and $ \\mathbf{C} $ are constant, the vector $ \\mathbf{C} \\boldsymbol{\\varepsilon}^c $ can be factored out of the integral for $ \\mathbf{q} $. Due to the construction of $ \\psi $, the remaining integral $ \\int \\psi J \\mathrm{d}\\xi\\mathrm{d}\\eta $ is zero. Therefore, theory predicts $ \\mathbf{q} = \\mathbf{0} $.\nThe system reduces to $ \\mathbf{H} \\boldsymbol{\\alpha} = \\mathbf{0} $. Since $ \\mathbf{C} $ is positive definite and $ \\psi^2 \\ge 0 $, $ \\mathbf{H} $ is also symmetric and positive definite (for any non-degenerate element). The only solution is therefore $ \\boldsymbol{\\alpha} = \\mathbf{0} $.\n\n### Step 4: Verification via Energy Calculation\n\nThe objective is to numerically verify that $ \\boldsymbol{\\alpha} $ is indeed zero (within numerical precision). We do this by calculating the energy associated with the enhanced strain field:\n$$\n\\mathcal{E}_{E} = \\frac{1}{2} \\boldsymbol{\\alpha}^{T} \\mathbf{H} \\boldsymbol{\\alpha}\n$$\nTheoretically, $ \\mathcal{E}_E $ must be zero. Due to floating-point arithmetic and numerical quadrature, the computed $ \\mathbf{q} $ will be very close to, but not exactly, zero. This leads to a non-zero but very small $ \\boldsymbol{\\alpha} $ and hence a small $ \\mathcal{E}_E $. The test is considered passed if this energy is negligible. The tolerance for this check is defined relative to the compatible strain energy in the element, $ \\mathcal{E}_c = \\frac{1}{2} A_e \\boldsymbol{\\varepsilon}^{c\\,T} \\mathbf{C} \\boldsymbol{\\varepsilon}^c $, where $ A_e $ is the element area.\nThe test passes if $ |\\mathcal{E}_E| \\le \\mathrm{tol} $, where:\n$$\n\\mathrm{tol} = \\max\\left(10^{-12}, 10^{-12} \\times \\mathcal{E}_c\\right)\n$$\nThis relative tolerance handles cases with different strain magnitudes, while the absolute floor of $ 10^{-12} $ addresses the case of zero strain.\n\nThe implementation proceeds by looping through each test case, performing these numerical integrations and matrix operations, and evaluating the final boolean condition.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the verification for all test cases.\n    \"\"\"\n    \n    # Global material parameters: E in Pascals, nu is dimensionless.\n    E = 210e9\n    nu = 0.3\n\n    # Prescribed test cases: (Nodal coordinates, displacement field parameters)\n    test_cases = [\n        {'nodes': np.array([[0.0, 0.0], [1.0, 0.0], [1.0, 1.0], [0.0, 1.0]]),\n         'params': {'a': 1.0, 'b': 2.0, 'c': 3.0, 'd': 4.0}},\n        {'nodes': np.array([[1.0, 1.0], [3.0, 1.0], [3.0, 2.5], [1.0, 2.5]]),\n         'params': {'a': 0.5, 'b': -1.2, 'c': 2.3, 'd': 0.7}},\n        {'nodes': np.array([[0.0, 0.0], [2.0, 0.2], [2.2, 1.8], [0.1, 1.6]]),\n         'params': {'a': -1.0, 'b': 0.3, 'c': 0.0, 'd': 1.5}},\n        {'nodes': np.array([[0.0, 0.0], [1.0, 0.0], [1.0, 0.05], [0.0, 0.05]]),\n         'params': {'a': 10.0, 'b': -5.0, 'c': 4.0, 'd': -2.0}},\n        {'nodes': np.array([[0.0, 0.0], [2.0, 0.0], [2.5, 1.0], [-0.1, 1.2]]),\n         'params': {'a': 0.0, 'b': 0.0, 'c': 0.0, 'd': 0.0}},\n    ]\n\n    results = []\n    for case in test_cases:\n        test_passed = verify_linear_completeness(case['nodes'], case['params'], E, nu)\n        results.append(test_passed)\n    \n    print(f\"[{','.join(map(str, results))}]\")\n\ndef get_material_matrix_plane_strain(E, nu):\n    \"\"\"Computes the plane strain isotropic elasticity matrix in Voigt notation.\"\"\"\n    lame_lambda = E * nu / ((1 + nu) * (1 - 2 * nu))\n    lame_mu = E / (2 * (1 + nu))\n    \n    C = np.array([\n        [lame_lambda + 2 * lame_mu, lame_lambda, 0],\n        [lame_lambda, lame_lambda + 2 * lame_mu, 0],\n        [0, 0, lame_mu]\n    ])\n    return C\n\ndef get_shape_functions(xi, eta):\n    \"\"\"\n    Computes bilinear shape functions and their derivatives at a point (xi, eta).\n    Returns (N, dN_dxi, dN_deta).\n    \"\"\"\n    N = 0.25 * np.array([\n        (1 - xi) * (1 - eta),\n        (1 + xi) * (1 - eta),\n        (1 + xi) * (1 + eta),\n        (1 - xi) * (1 + eta)\n    ])\n    \n    dN_dxi = 0.25 * np.array([\n        -(1 - eta),\n        (1 - eta),\n        (1 + eta),\n        -(1 + eta)\n    ])\n    \n    dN_deta = 0.25 * np.array([\n        -(1 - xi),\n        -(1 + xi),\n        (1 + xi),\n        (1 - xi)\n    ])\n    \n    return N, dN_dxi, dN_deta\n\ndef verify_linear_completeness(nodes, params, E, nu):\n    \"\"\"\n    Performs the numerical verification for a single element case.\n    \"\"\"\n    # 1. Setup material matrix and compatible strain\n    C = get_material_matrix_plane_strain(E, nu)\n    a, b, c, d = params['a'], params['b'], params['c'], params['d']\n    epsilon_c = np.array([a, d, b + c])\n\n    # 2. Get Gauss quadrature points and weights (5x5)\n    n_gauss = 5\n    xi_g, w_g = np.polynomial.legendre.leggauss(n_gauss)\n    gauss_points_2d = []\n    for i in range(n_gauss):\n        for j in range(n_gauss):\n            gauss_points_2d.append(((xi_g[i], xi_g[j]), w_g[i] * w_g[j]))\n\n    # 3. Compute the mean of the bubble function, b_bar\n    integral_bJ = 0.0\n    area = 0.0\n    for (xi, eta), w in gauss_points_2d:\n        _, dN_dxi, dN_deta = get_shape_functions(xi, eta)\n        \n        # Jacobian matrix J_mat = [[dx/dxi, dy/dxi], [dx/deta, dy/deta]]\n        J_mat = np.stack((dN_dxi, dN_deta)) @ nodes\n        \n        J_det = np.linalg.det(J_mat)\n        \n        bubble_func = (1 - xi**2) * (1 - eta**2)\n        integral_bJ += bubble_func * J_det * w\n        area += J_det * w\n\n    if abs(area) < 1e-15: # Avoid division by zero for a collapsed element\n        b_bar = 0.0\n    else:\n        b_bar = integral_bJ / area\n        \n    # 4. Assemble H matrix and q vector\n    H = np.zeros((3, 3))\n    q = np.zeros(3)\n\n    for (xi, eta), w in gauss_points_2d:\n        _, dN_dxi, dN_deta = get_shape_functions(xi, eta)\n        J_mat = np.stack((dN_dxi, dN_deta)) @ nodes\n        J_det = np.linalg.det(J_mat)\n        \n        bubble_func = (1 - xi**2) * (1 - eta**2)\n        psi = bubble_func - b_bar\n        \n        # G(xi, eta) = psi(xi, eta) * I_3\n        # H += G.T @ C @ G * J_det * w = (psi**2 * C) * J_det * w\n        H += (psi**2 * C) * J_det * w\n        # q += G.T @ C @ epsilon_c * J_det * w = (psi * C @ epsilon_c) * J_det * w\n        q += (psi * (C @ epsilon_c)) * J_det * w\n\n    # 5. Solve for alpha and compute enhanced energy\n    try:\n        # H is symmetric positive definite for non-degenerate elements\n        alpha = np.linalg.solve(H, -q)\n    except np.linalg.LinAlgError:\n        # Should not happen for the given test cases\n        return False\n\n    E_e = 0.5 * alpha.T @ H @ alpha\n\n    # 6. Define tolerance and perform the check\n    # Compatible strain energy density\n    if np.allclose(epsilon_c, 0):\n        U_c_density = 0.0\n    else:    \n        U_c_density = 0.5 * epsilon_c.T @ C @ epsilon_c\n    \n    # Total compatible strain energy in the element\n    E_c = area * U_c_density\n    \n    # Tolerance definition from problem statement\n    tol = max(1e-12, 1e-12 * E_c)\n    \n    return abs(E_e) <= tol\n\nif __name__ == '__main__':\n    solve()\n```"
        }
    ]
}