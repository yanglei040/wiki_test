{
    "hands_on_practices": [
        {
            "introduction": "To understand and implement the B-bar method, we must first master the standard finite element formulation from which it derives. This foundational exercise guides you through the derivation of the operator that links nodal displacements to the volumetric strain, a critical first step before any modification can be applied. By explicitly constructing the standard volumetric operator $b_v$, you will solidify your understanding of how continuous strain fields are discretized in the isoparametric framework .",
            "id": "3502454",
            "problem": "In computational geomechanics, alleviating volumetric locking in near-incompressible media often employs the so-called $B$-bar method, which acts on the volumetric strain. Consider the small-strain, isoparametric finite element approximation using a standard $4$-node bilinear quadrilateral element in two-dimensional space with physical coordinates $(x,y)$ and parent coordinates $(\\xi,\\eta) \\in [-1,1] \\times [-1,1]$. Let the nodal degrees of freedom (Degrees of Freedom, DOF) be ordered as the vector $d = (u_{1x},u_{1y},u_{2x},u_{2y},u_{3x},u_{3y},u_{4x},u_{4y})^{\\mathsf{T}}$, where $u_{ix}$ and $u_{iy}$ are the displacement components at node $i$ in the $x$ and $y$ directions, respectively.\n\nAdopt the following foundational bases:\n- Small-strain kinematics, with the engineering strain vector $\\varepsilon = (\\epsilon_{xx},\\epsilon_{yy},\\gamma_{xy})^{\\mathsf{T}}$ defined by $\\epsilon_{xx} = \\partial u/\\partial x$, $\\epsilon_{yy} = \\partial v/\\partial y$, and $\\gamma_{xy} = \\partial u/\\partial y + \\partial v/\\partial x$, where $u(x,y)$ and $v(x,y)$ are the displacement components in the $x$ and $y$ directions.\n- The isoparametric bilinear shape functions on the parent domain, $N_{1}(\\xi,\\eta) = \\frac{1}{4}(1-\\xi)(1-\\eta)$, $N_{2}(\\xi,\\eta) = \\frac{1}{4}(1+\\xi)(1-\\eta)$, $N_{3}(\\xi,\\eta) = \\frac{1}{4}(1+\\xi)(1+\\eta)$, $N_{4}(\\xi,\\eta) = \\frac{1}{4}(1-\\xi)(1+\\eta)$, together with a regular isoparametric mapping with Jacobian matrix $\\mathbf{J} = \\partial(x,y)/\\partial(\\xi,\\eta)$ that is nonsingular over the element so that physical derivatives $\\partial N_{i}/\\partial x$ and $\\partial N_{i}/\\partial y$ are well defined.\n\nStarting from these bases and without invoking any preassembled element matrices, derive the standard strain-displacement matrix $\\mathbf{B}$ in physical coordinates $(x,y)$ such that $\\varepsilon = \\mathbf{B}\\,d$, expressed in terms of the physical derivatives $\\partial N_{i}/\\partial x$ and $\\partial N_{i}/\\partial y$. Then, using the definition of the in-plane volumetric strain $\\epsilon_{v} = \\epsilon_{xx} + \\epsilon_{yy}$, identify the scalar volumetric operator row $b_{v}$ such that $\\epsilon_{v} = b_{v}\\,d$.\n\nExpress your final answer solely as the explicit analytic expression for $b_{v}$ in terms of $\\partial N_{i}/\\partial x$ and $\\partial N_{i}/\\partial y$ with $i \\in \\{1,2,3,4\\}$. No numerical evaluation is required. Do not include any units in your final answer.",
            "solution": "The problem is well-defined, scientifically grounded, and contains sufficient information for a unique analytical solution. It is a standard derivation in the field of computational mechanics and the Finite Element Method (FEM).\n\nThe objective is to derive the volumetric operator row, denoted as $b_v$, which relates the in-plane volumetric strain $\\epsilon_v$ to the nodal displacement vector $d$ for a $4$-node bilinear quadrilateral element. The derivation proceeds from the foundational principles of isoparametric finite element formulation and small-strain kinematics.\n\nThe displacement field $(u, v)$ within the element is interpolated from the nodal displacements using the shape functions $N_i$. For a $4$-node element, this is expressed as:\n$$\nu(x,y) \\approx u^h(\\xi,\\eta) = \\sum_{i=1}^{4} N_i(\\xi,\\eta) u_{ix}\n$$\n$$\nv(x,y) \\approx v^h(\\xi,\\eta) = \\sum_{i=1}^{4} N_i(\\xi,\\eta) u_{iy}\n$$\nHere, $(u_{ix}, u_{iy})$ are the displacement components of node $i$, and $N_i$ are the isoparametric shape functions dependent on the parent coordinates $(\\xi, \\eta)$. The problem statement uses the notation $d$ for the vector of all nodal degrees of freedom, ordered as:\n$$\nd = (u_{1x}, u_{1y}, u_{2x}, u_{2y}, u_{3x}, u_{3y}, u_{4x}, u_{4y})^{\\mathsf{T}}\n$$\n\nThe small-strain components are defined by the partial derivatives of the displacement field with respect to the physical coordinates $(x,y)$. The relevant strain components are:\n$$\n\\epsilon_{xx} = \\frac{\\partial u}{\\partial x}\n$$\n$$\n\\epsilon_{yy} = \\frac{\\partial v}{\\partial y}\n$$\n$$\n\\gamma_{xy} = \\frac{\\partial u}{\\partial y} + \\frac{\\partial v}{\\partial x}\n$$\nTo compute these, we differentiate the interpolated displacement fields. The problem statement permits the direct use of the physical derivatives of the shape functions, $\\partial N_i/\\partial x$ and $\\partial N_i/\\partial y$.\nThe derivatives of the displacement field are:\n$$\n\\frac{\\partial u}{\\partial x} = \\frac{\\partial}{\\partial x} \\left( \\sum_{i=1}^{4} N_i u_{ix} \\right) = \\sum_{i=1}^{4} \\frac{\\partial N_i}{\\partial x} u_{ix}\n$$\n$$\n\\frac{\\partial v}{\\partial y} = \\frac{\\partial}{\\partial y} \\left( \\sum_{i=1}^{4} N_i u_{iy} \\right) = \\sum_{i=1}^{4} \\frac{\\partial N_i}{\\partial y} u_{iy}\n$$\n$$\n\\frac{\\partial u}{\\partial y} = \\frac{\\partial}{\\partial y} \\left( \\sum_{i=1}^{4} N_i u_{ix} \\right) = \\sum_{i=1}^{4} \\frac{\\partial N_i}{\\partial y} u_{ix}\n$$\n$$\n\\frac{\\partial v}{\\partial x} = \\frac{\\partial}{\\partial x} \\left( \\sum_{i=1}^{4} N_i u_{iy} \\right) = \\sum_{i=1}^{4} \\frac{\\partial N_i}{\\partial x} u_{iy}\n$$\nSubstituting these into the strain definitions, we get:\n$$\n\\epsilon_{xx} = \\sum_{i=1}^{4} \\frac{\\partial N_i}{\\partial x} u_{ix}\n$$\n$$\n\\epsilon_{yy} = \\sum_{i=1}^{4} \\frac{\\partial N_i}{\\partial y} u_{iy}\n$$\n$$\n\\gamma_{xy} = \\sum_{i=1}^{4} \\frac{\\partial N_i}{\\partial y} u_{ix} + \\sum_{i=1}^{4} \\frac{\\partial N_i}{\\partial x} u_{iy} = \\sum_{i=1}^{4} \\left( \\frac{\\partial N_i}{\\partial y} u_{ix} + \\frac{\\partial N_i}{\\partial x} u_{iy} \\right)\n$$\nThe relationship between the strain vector $\\varepsilon = (\\epsilon_{xx}, \\epsilon_{yy}, \\gamma_{xy})^{\\mathsf{T}}$ and the nodal displacement vector $d$ is given by the strain-displacement matrix $\\mathbf{B}$, such that $\\varepsilon = \\mathbf{B}d$. By expanding the summations and arranging them in matrix form, we can construct $\\mathbf{B}$. Each node $i$ contributes a $3 \\times 2$ block matrix $\\mathbf{B}_i$:\n$$\n\\mathbf{B}_i = \\begin{bmatrix} \\frac{\\partial N_i}{\\partial x} & 0 \\\\ 0 & \\frac{\\partial N_i}{\\partial y} \\\\ \\frac{\\partial N_i}{\\partial y} & \\frac{\\partial N_i}{\\partial x} \\end{bmatrix}\n$$\nThe full strain-displacement matrix is a concatenation of these blocks:\n$$\n\\mathbf{B} = \\begin{bmatrix} \\mathbf{B}_1 & \\mathbf{B}_2 & \\mathbf{B}_3 & \\mathbf{B}_4 \\end{bmatrix} = \\begin{bmatrix}\n\\frac{\\partial N_1}{\\partial x} & 0 & \\frac{\\partial N_2}{\\partial x} & 0 & \\frac{\\partial N_3}{\\partial x} & 0 & \\frac{\\partial N_4}{\\partial x} & 0 \\\\\n0 & \\frac{\\partial N_1}{\\partial y} & 0 & \\frac{\\partial N_2}{\\partial y} & 0 & \\frac{\\partial N_3}{\\partial y} & 0 & \\frac{\\partial N_4}{\\partial y} \\\\\n\\frac{\\partial N_1}{\\partial y} & \\frac{\\partial N_1}{\\partial x} & \\frac{\\partial N_2}{\\partial y} & \\frac{\\partial N_2}{\\partial x} & \\frac{\\partial N_3}{\\partial y} & \\frac{\\partial N_3}{\\partial x} & \\frac{\\partial N_4}{\\partial y} & \\frac{\\partial N_4}{\\partial x}\n\\end{bmatrix}\n$$\nNow, we address the primary goal: finding the volumetric operator $b_v$. The in-plane volumetric strain $\\epsilon_v$ is defined as the sum of the normal strain components:\n$$\n\\epsilon_v = \\epsilon_{xx} + \\epsilon_{yy}\n$$\nSubstituting the expressions for $\\epsilon_{xx}$ and $\\epsilon_{yy}$:\n$$\n\\epsilon_v = \\left( \\sum_{i=1}^{4} \\frac{\\partial N_i}{\\partial x} u_{ix} \\right) + \\left( \\sum_{i=1}^{4} \\frac{\\partial N_i}{\\partial y} u_{iy} \\right)\n$$\nWe can combine these sums and reorder the terms:\n$$\n\\epsilon_v = \\sum_{i=1}^{4} \\left( \\frac{\\partial N_i}{\\partial x} u_{ix} + \\frac{\\partial N_i}{\\partial y} u_{iy} \\right)\n$$\nThis expression is a linear combination of the nodal displacement components. To write it in the form $\\epsilon_v = b_v d$, we can identify the coefficients of each component in the vector $d$.\n$$\n\\epsilon_v = \\left(\\frac{\\partial N_1}{\\partial x}\\right)u_{1x} + \\left(\\frac{\\partial N_1}{\\partial y}\\right)u_{1y} + \\left(\\frac{\\partial N_2}{\\partial x}\\right)u_{2x} + \\left(\\frac{\\partial N_2}{\\partial y}\\right)u_{2y} + \\left(\\frac{\\partial N_3}{\\partial x}\\right)u_{3x} + \\left(\\frac{\\partial N_3}{\\partial y}\\right)u_{3y} + \\left(\\frac{\\partial N_4}{\\partial x}\\right)u_{4x} + \\left(\\frac{\\partial N_4}{\\partial y}\\right)u_{4y}\n$$\nThis is the dot product of a row vector with the displacement vector $d$. The row vector is precisely the volumetric operator $b_v$:\n$$\nb_v = \\begin{pmatrix} \\frac{\\partial N_1}{\\partial x} & \\frac{\\partial N_1}{\\partial y} & \\frac{\\partial N_2}{\\partial x} & \\frac{\\partial N_2}{\\partial y} & \\frac{\\partial N_3}{\\partial x} & \\frac{\\partial N_3}{\\partial y} & \\frac{\\partial N_4}{\\partial x} & \\frac{\\partial N_4}{\\partial y} \\end{pmatrix}\n$$\nAlternatively, $b_v$ can be obtained by noting that $\\epsilon_v = \\begin{pmatrix} 1 & 1 & 0 \\end{pmatrix} \\varepsilon$. Substituting $\\varepsilon = \\mathbf{B}d$, we get $\\epsilon_v = \\begin{pmatrix} 1 & 1 & 0 \\end{pmatrix} \\mathbf{B} d$, which implies $b_v = \\begin{pmatrix} 1 & 1 & 0 \\end{pmatrix} \\mathbf{B}$. Performing this matrix multiplication yields the sum of the first two rows of $\\mathbf{B}$, which gives the same result. This confirms the derivation.",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix} \\frac{\\partial N_{1}}{\\partial x} & \\frac{\\partial N_{1}}{\\partial y} & \\frac{\\partial N_{2}}{\\partial x} & \\frac{\\partial N_{2}}{\\partial y} & \\frac{\\partial N_{3}}{\\partial x} & \\frac{\\partial N_{3}}{\\partial y} & \\frac{\\partial N_{4}}{\\partial x} & \\frac{\\partial N_{4}}{\\partial y} \\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "The essence of the B-bar method lies in replacing the pointwise, spatially varying volumetric strain with a single, constant value across the entire element. This constant value is the element-wise average of the original strain field. This practice guides you through the explicit derivation of the averaged volumetric operator, $\\bar{b}_v$, for a simple rectangular element, turning the abstract concept of projection into a concrete analytical expression .",
            "id": "3502521",
            "problem": "Consider a four-node bilinear quadrilateral element (Q4) in a small-strain, two-dimensional setting, used in the Finite Element Method (FEM) for computational geomechanics. The element occupies a rectangular physical domain $\\Omega_e$ of side lengths $L_x$ and $L_y$, aligned with the Cartesian axes, with nodes numbered counterclockwise starting at the lower-left corner. Let the isoparametric mapping from the natural coordinates $(\\xi, \\eta) \\in [-1,1] \\times [-1,1]$ to the physical coordinates $(x,y)$ be affine, given by $x = x_c + \\frac{L_x}{2}\\,\\xi$ and $y = y_c + \\frac{L_y}{2}\\,\\eta$, where $(x_c,y_c)$ is the rectangle center. The bilinear shape functions are\n$$\nN_1(\\xi,\\eta) = \\frac{1}{4}(1-\\xi)(1-\\eta),\\quad\nN_2(\\xi,\\eta) = \\frac{1}{4}(1+\\xi)(1-\\eta),\\quad\nN_3(\\xi,\\eta) = \\frac{1}{4}(1+\\xi)(1+\\eta),\\quad\nN_4(\\xi,\\eta) = \\frac{1}{4}(1-\\xi)(1+\\eta).\n$$\nLet the nodal displacement vector be $d = [u_1, v_1, u_2, v_2, u_3, v_3, u_4, v_4]^{\\top}$, and the interpolated displacement field be $u(x,y) = \\sum_{i=1}^{4} N_i(\\xi,\\eta)\\,u_i$, $v(x,y) = \\sum_{i=1}^{4} N_i(\\xi,\\eta)\\,v_i$. Under small-strain kinematics, the volumetric strain is defined as $\\epsilon_v(x,y) = \\frac{\\partial u}{\\partial x} + \\frac{\\partial v}{\\partial y}$.\n\nThe so-called $B$-bar method (also written as $\\,\\bar{B}\\,$ method), which replaces the volumetric strain by its element-wise constant projection to mitigate volumetric locking in nearly incompressible materials, uses the constant volumetric projection vector $\\bar{b}_v$ such that the projected volumetric strain is $\\bar{\\epsilon}_v = \\bar{b}_v\\,d$ with\n$$\n\\bar{b}_v = \\frac{1}{\\Omega_e}\\int_{\\Omega_e} b_v(\\mathbf{x})\\,d\\Omega,\\quad \\Omega_e = L_x L_y,\n$$\nwhere $b_v(\\mathbf{x})$ is the volumetric strain-displacement operator satisfying $\\epsilon_v(\\mathbf{x}) = b_v(\\mathbf{x})\\,d$.\n\nStarting from small-strain kinematics and the above isoparametric interpolation, derive the explicit closed-form expression for the constant volumetric projection vector $\\bar{b}_v$ for this rectangular Q4 element, expressed solely in terms of $L_x$ and $L_y$ and ordered as $[u_1, v_1, u_2, v_2, u_3, v_3, u_4, v_4]$. Then, write the projected volumetric strain in the form $\\bar{\\epsilon}_v = \\bar{b}_v\\,d$. Your final answer must be a single closed-form analytical expression for $\\bar{b}_v$. No numerical approximation is required, and no units should be included in the final boxed expression.",
            "solution": "The user wants to find the constant volumetric projection vector $\\bar{b}_v$ for a rectangular four-node bilinear quadrilateral element.\n\n### Step 1: Extract Givens\n-   **Element Type**: Four-node bilinear quadrilateral (Q4).\n-   **Domain**: Rectangular physical domain $\\Omega_e$ with side lengths $L_x$ and $L_y$.\n-   **Isoparametric Mapping**: $x = x_c + \\frac{L_x}{2}\\,\\xi$ and $y = y_c + \\frac{L_y}{2}\\,\\eta$ for $(\\xi, \\eta) \\in [-1,1] \\times [-1,1]$. This mapping is affine.\n-   **Shape Functions**:\n    $N_1(\\xi,\\eta) = \\frac{1}{4}(1-\\xi)(1-\\eta)$\n    $N_2(\\xi,\\eta) = \\frac{1}{4}(1+\\xi)(1-\\eta)$\n    $N_3(\\xi,\\eta) = \\frac{1}{4}(1+\\xi)(1+\\eta)$\n    $N_4(\\xi,\\eta) = \\frac{1}{4}(1-\\xi)(1+\\eta)$\n-   **Nodal Displacements**: $d = [u_1, v_1, u_2, v_2, u_3, v_3, u_4, v_4]^{\\top}$.\n-   **Interpolated Displacement Field**: $u(x,y) = \\sum_{i=1}^{4} N_i(\\xi,\\eta)\\,u_i$, $v(x,y) = \\sum_{i=1}^{4} N_i(\\xi,\\eta)\\,v_i$.\n-   **Volumetric Strain (Small-Strain)**: $\\epsilon_v(x,y) = \\frac{\\partial u}{\\partial x} + \\frac{\\partial v}{\\partial y}$.\n-   **Strain-Displacement Operator**: $\\epsilon_v(\\mathbf{x}) = b_v(\\mathbf{x})\\,d$.\n-   **Constant Volumetric Projection Vector Definition**: $\\bar{b}_v = \\frac{1}{\\Omega_e}\\int_{\\Omega_e} b_v(\\mathbf{x})\\,d\\Omega$, with element area $\\Omega_e = L_x L_y$.\n\n### Step 2: Validate Using Extracted Givens\n-   **Scientifically Grounded**: The problem is a standard derivation in the context of the Finite Element Method (FEM), specifically for implementing the $\\bar{B}$ method to address volumetric locking. All concepts, including isoparametric mapping, shape functions, strain definitions, and the projection method, are well-established principles in computational mechanics and are mathematically sound.\n-   **Well-Posed**: The problem asks for the derivation of a specific quantity, $\\bar{b}_v$, based on a clear and complete set of definitions and equations. The inputs are sufficient to determine a unique analytical solution.\n-   **Objective**: The problem is stated using precise mathematical language and standard FEM terminology, free from any subjective or ambiguous claims.\n\n### Step 3: Verdict and Action\nThe problem is valid. It is a well-posed, scientifically grounded problem from computational mechanics. I will now proceed with the full derivation.\n\nThe objective is to compute the constant volumetric projection vector $\\bar{b}_v$ defined as:\n$$\n\\bar{b}_v = \\frac{1}{\\Omega_e}\\int_{\\Omega_e} b_v(\\mathbf{x})\\,d\\Omega\n$$\nFirst, we must determine the volumetric strain-displacement operator $b_v(\\mathbf{x})$. The volumetric strain is given by $\\epsilon_v = \\frac{\\partial u}{\\partial x} + \\frac{\\partial v}{\\partial y}$. Substituting the interpolated displacement fields:\n$$\n\\epsilon_v = \\frac{\\partial}{\\partial x}\\left(\\sum_{i=1}^{4} N_i u_i\\right) + \\frac{\\partial}{\\partial y}\\left(\\sum_{i=1}^{4} N_i v_i\\right) = \\sum_{i=1}^{4} \\left(\\frac{\\partial N_i}{\\partial x} u_i + \\frac{\\partial N_i}{\\partial y} v_i\\right)\n$$\nThis can be written in matrix form as $\\epsilon_v = b_v d$, where $d$ is the nodal displacement vector and $b_v$ is a row vector operator:\n$$\nb_v = \\begin{bmatrix} \\frac{\\partial N_1}{\\partial x} & \\frac{\\partial N_1}{\\partial y} & \\frac{\\partial N_2}{\\partial x} & \\frac{\\partial N_2}{\\partial y} & \\frac{\\partial N_3}{\\partial x} & \\frac{\\partial N_3}{\\partial y} & \\frac{\\partial N_4}{\\partial x} & \\frac{\\partial N_4}{\\partial y} \\end{bmatrix}\n$$\nTo find the spatial derivatives of the shape functions, we use the chain rule for the isoparametric mapping:\n$$\n\\begin{Bmatrix} \\frac{\\partial N_i}{\\partial \\xi} \\\\ \\frac{\\partial N_i}{\\partial \\eta} \\end{Bmatrix} = \\begin{bmatrix} \\frac{\\partial x}{\\partial \\xi} & \\frac{\\partial y}{\\partial \\xi} \\\\ \\frac{\\partial x}{\\partial \\eta} & \\frac{\\partial y}{\\partial \\eta} \\end{bmatrix} \\begin{Bmatrix} \\frac{\\partial N_i}{\\partial x} \\\\ \\frac{\\partial N_i}{\\partial y} \\end{Bmatrix} = J \\begin{Bmatrix} \\frac{\\partial N_i}{\\partial x} \\\\ \\frac{\\partial N_i}{\\partial y} \\end{Bmatrix}\n$$\nwhere $J$ is the Jacobian matrix of the transformation. From the given affine mapping, $x = x_c + \\frac{L_x}{2}\\xi$ and $y = y_c + \\frac{L_y}{2}\\eta$, the components of the Jacobian are:\n$$\n\\frac{\\partial x}{\\partial \\xi} = \\frac{L_x}{2}, \\quad \\frac{\\partial y}{\\partial \\xi} = 0\n$$\n$$\n\\frac{\\partial x}{\\partial \\eta} = 0, \\quad \\frac{\\partial y}{\\partial \\eta} = \\frac{L_y}{2}\n$$\nThus, the Jacobian matrix is constant for a rectangular element:\n$$\nJ = \\begin{bmatrix} \\frac{L_x}{2} & 0 \\\\ 0 & \\frac{L_y}{2} \\end{bmatrix}\n$$\nThe spatial derivatives of $N_i$ are found by inverting this relationship:\n$$\n\\begin{Bmatrix} \\frac{\\partial N_i}{\\partial x} \\\\ \\frac{\\partial N_i}{\\partial y} \\end{Bmatrix} = J^{-1} \\begin{Bmatrix} \\frac{\\partial N_i}{\\partial \\xi} \\\\ \\frac{\\partial N_i}{\\partial \\eta} \\end{Bmatrix} = \\begin{bmatrix} \\frac{2}{L_x} & 0 \\\\ 0 & \\frac{2}{L_y} \\end{bmatrix} \\begin{Bmatrix} \\frac{\\partial N_i}{\\partial \\xi} \\\\ \\frac{\\partial N_i}{\\partial \\eta} \\end{Bmatrix}\n$$\nSo, $\\frac{\\partial N_i}{\\partial x} = \\frac{2}{L_x} \\frac{\\partial N_i}{\\partial \\xi}$ and $\\frac{\\partial N_i}{\\partial y} = \\frac{2}{L_y} \\frac{\\partial N_i}{\\partial \\eta}$.\n\nNext, we calculate the derivatives of the shape functions with respect to the natural coordinates $(\\xi, \\eta)$:\n$$\n\\frac{\\partial N_1}{\\partial \\xi} = -\\frac{1}{4}(1-\\eta), \\quad \\frac{\\partial N_1}{\\partial \\eta} = -\\frac{1}{4}(1-\\xi)\n$$\n$$\n\\frac{\\partial N_2}{\\partial \\xi} = \\frac{1}{4}(1-\\eta), \\quad \\frac{\\partial N_2}{\\partial \\eta} = -\\frac{1}{4}(1+\\xi)\n$$\n$$\n\\frac{\\partial N_3}{\\partial \\xi} = \\frac{1}{4}(1+\\eta), \\quad \\frac{\\partial N_3}{\\partial \\eta} = \\frac{1}{4}(1+\\xi)\n$$\n$$\n\\frac{\\partial N_4}{\\partial \\xi} = -\\frac{1}{4}(1+\\eta), \\quad \\frac{\\partial N_4}{\\partial \\eta} = \\frac{1}{4}(1-\\xi)\n$$\nNow we can express the components of $b_v$ in terms of $\\xi$ and $\\eta$:\n-   For node $1$: $\\frac{\\partial N_1}{\\partial x} = -\\frac{1}{2 L_x}(1-\\eta)$, $\\frac{\\partial N_1}{\\partial y} = -\\frac{1}{2 L_y}(1-\\xi)$\n-   For node $2$: $\\frac{\\partial N_2}{\\partial x} = \\frac{1}{2 L_x}(1-\\eta)$, $\\frac{\\partial N_2}{\\partial y} = -\\frac{1}{2 L_y}(1+\\xi)$\n-   For node $3$: $\\frac{\\partial N_3}{\\partial x} = \\frac{1}{2 L_x}(1+\\eta)$, $\\frac{\\partial N_3}{\\partial y} = \\frac{1}{2 L_y}(1+\\xi)$\n-   For node $4$: $\\frac{\\partial N_4}{\\partial x} = -\\frac{1}{2 L_x}(1+\\eta)$, $\\frac{\\partial N_4}{\\partial y} = \\frac{1}{2 L_y}(1-\\xi)$\n\nThe vector $\\bar{b}_v$ is the element-average of $b_v$. The integral over the physical domain $\\Omega_e$ is transformed into an integral over the parent domain $[-1,1] \\times [-1,1]$:\n$$\n\\bar{b}_v = \\frac{1}{\\Omega_e} \\int_{-1}^1 \\int_{-1}^1 b_v(\\xi, \\eta) |J| \\,d\\xi d\\eta\n$$\nThe determinant of the Jacobian is $|J| = (\\frac{L_x}{2})(\\frac{L_y}{2}) = \\frac{L_x L_y}{4} = \\frac{\\Omega_e}{4}$.\nSubstituting $|J|$ into the integral expression:\n$$\n\\bar{b}_v = \\frac{1}{\\Omega_e} \\int_{-1}^1 \\int_{-1}^1 b_v(\\xi, \\eta) \\frac{\\Omega_e}{4} \\,d\\xi d\\eta = \\frac{1}{4} \\int_{-1}^1 \\int_{-1}^1 b_v(\\xi, \\eta) \\,d\\xi d\\eta\n$$\nWe need to integrate each component of $b_v(\\xi, \\eta)$. Since each component is a linear function of $\\xi$ and $\\eta$ of the form $a+b\\xi+c\\eta$, its integral over the symmetric domain $[-1,1] \\times [-1,1]$ is:\n$$\n\\frac{1}{4}\\int_{-1}^1\\int_{-1}^1 (a+b\\xi+c\\eta)\\,d\\xi d\\eta = \\frac{1}{4} (a \\cdot 4 + b \\cdot 0 + c \\cdot 0) = a\n$$\nThis means we only need to find the constant term of each component of $b_v$.\n-   $\\frac{\\partial N_1}{\\partial x} = -\\frac{1}{2L_x} + \\frac{\\eta}{2L_x} \\implies \\text{avg} = -\\frac{1}{2L_x}$\n-   $\\frac{\\partial N_1}{\\partial y} = -\\frac{1}{2L_y} + \\frac{\\xi}{2L_y} \\implies \\text{avg} = -\\frac{1}{2L_y}$\n-   $\\frac{\\partial N_2}{\\partial x} = \\frac{1}{2L_x} - \\frac{\\eta}{2L_x} \\implies \\text{avg} = \\frac{1}{2L_x}$\n-   $\\frac{\\partial N_2}{\\partial y} = -\\frac{1}{2L_y} - \\frac{\\xi}{2L_y} \\implies \\text{avg} = -\\frac{1}{2L_y}$\n-   $\\frac{\\partial N_3}{\\partial x} = \\frac{1}{2L_x} + \\frac{\\eta}{2L_x} \\implies \\text{avg} = \\frac{1}{2L_x}$\n-   $\\frac{\\partial N_3}{\\partial y} = \\frac{1}{2L_y} + \\frac{\\xi}{2L_y} \\implies \\text{avg} = \\frac{1}{2L_y}$\n-   $\\frac{\\partial N_4}{\\partial x} = -\\frac{1}{2L_x} - \\frac{\\eta}{2L_x} \\implies \\text{avg} = -\\frac{1}{2L_x}$\n-   $\\frac{\\partial N_4}{\\partial y} = \\frac{1}{2L_y} - \\frac{\\xi}{2L_y} \\implies \\text{avg} = \\frac{1}{2L_y}$\n\nAssembling these average values into the vector $\\bar{b}_v$ according to the nodal displacement order $[u_1, v_1, u_2, v_2, u_3, v_3, u_4, v_4]$:\n$$\n\\bar{b}_v = \\begin{bmatrix} -\\frac{1}{2L_x} & -\\frac{1}{2L_y} & \\frac{1}{2L_x} & -\\frac{1}{2L_y} & \\frac{1}{2L_x} & \\frac{1}{2L_y} & -\\frac{1}{2L_x} & \\frac{1}{2L_y} \\end{bmatrix}\n$$\nThis expression can be made more compact by factoring out a common term $\\frac{1}{2L_x L_y}$:\n$$\n\\bar{b}_v = \\frac{1}{2L_x L_y} \\begin{bmatrix} -L_y & -L_x & L_y & -L_x & L_y & L_x & -L_y & L_x \\end{bmatrix}\n$$\nThe projected volumetric strain can thus be written as $\\bar{\\epsilon}_v = \\bar{b}_v d$, which represents the constant, element-averaged volumetric strain.\n$$\n\\bar{\\epsilon}_v = \\frac{1}{2L_x}(-u_1+u_2+u_3-u_4) + \\frac{1}{2L_y}(-v_1-v_2+v_3+v_4)\n$$\nThis confirms the components of the derived vector. The final answer is the vector $\\bar{b}_v$.",
            "answer": "$$\n\\boxed{\\frac{1}{2L_x L_y} \\begin{pmatrix} -L_y & -L_x & L_y & -L_x & L_y & L_x & -L_y & L_x \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "Whenever we modify a finite element formulation, we must ensure it remains stable and does not introduce non-physical behaviors, known as spurious zero-energy modes. A valid element must only have zero-energy modes corresponding to rigid body motion. This computational practice challenges you to perform a critical validation of the B-bar method by implementing an eigenanalysis to confirm that it cures volumetric locking without compromising the element's fundamental stability .",
            "id": "3502461",
            "problem": "You are to analyze whether the B-bar (denoted $\\bar{B}$) modification introduces any spurious zero-energy modes in a four-node bilinear quadrilateral element (Q4) under small-strain linear elasticity in plane strain. Your analysis must start from first principles and produce a program that constructs the element stiffness matrix, performs eigenanalysis, and quantitatively compares the nullspace properties of the standard and $\\bar{B}$-modified formulations.\n\nFundamental base and modeling assumptions:\n- Kinematics: small strain, so the symmetric infinitesimal strain tensor $\\boldsymbol{\\varepsilon}$ is defined by $\\varepsilon_{ij} = \\tfrac{1}{2}\\left(u_{i,j} + u_{j,i}\\right)$.\n- Discretization: isoparametric Q4 element with bilinear shape functions on a convex quadrilateral. The displacement field is interpolated as $\\mathbf{u}(\\mathbf{x}) = \\sum_{a=1}^{4} N_a(\\xi,\\eta)\\,\\mathbf{u}_a$, where $(\\xi,\\eta)\\in[-1,1]^2$ are natural coordinates.\n- Numerical integration: standard Gauss quadrature with $2\\times 2$ points.\n- Material: homogeneous, isotropic, linear elastic in plane strain with Young’s modulus $E$ (in Pascals) and Poisson’s ratio $\\nu$. Let the Lamé parameters be $\\lambda = \\dfrac{E\\nu}{(1+\\nu)(1-2\\nu)}$ and $\\mu = \\dfrac{E}{2(1+\\nu)}$. The constitutive matrix in the $(\\sigma_{xx},\\sigma_{yy},\\tau_{xy})$–$(\\varepsilon_{xx},\\varepsilon_{yy},\\gamma_{xy})$ representation is\n$$\n\\mathbf{D} \\;=\\;\n\\begin{bmatrix}\n\\lambda + 2\\mu & \\lambda & 0 \\\\\n\\lambda & \\lambda + 2\\mu & 0 \\\\\n0 & 0 & \\mu\n\\end{bmatrix}.\n$$\n- Standard element stiffness: for each Gauss point $i$ with weight $w_i$ and Jacobian determinant $J_i$, assemble $\\mathbf{K} = \\sum_i w_i\\, J_i\\, \\mathbf{B}_i^\\mathsf{T}\\,\\mathbf{D}\\,\\mathbf{B}_i$, where $\\mathbf{B}_i$ maps nodal displacements to strains $\\boldsymbol{\\varepsilon}_i = \\mathbf{B}_i \\mathbf{u}_e$ with the engineering shear $\\gamma_{xy}$.\n- $\\bar{B}$-modified element stiffness: decompose the in-plane strain into volumetric and deviatoric parts using the in-plane dilatation $e_{\\mathrm{vol}} = \\varepsilon_{xx} + \\varepsilon_{yy}$. Replace the pointwise $e_{\\mathrm{vol}}$ at any Gauss point by its element-wise area-average $\\bar{e}_{\\mathrm{vol}}$ (the $L^2$-projection onto the space of constants over the element), while keeping the deviatoric strain part unchanged. Then assemble the stiffness using the modified strain-displacement operator.\n\nYour program must:\n1. Construct the standard Q4 element stiffness matrix $\\mathbf{K}$ for three separate test cases.\n2. Construct the $\\bar{B}$-modified element stiffness matrix $\\mathbf{K}_{\\bar{B}}$ for the same three test cases by projecting the in-plane volumetric strain $e_{\\mathrm{vol}} = \\varepsilon_{xx} + \\varepsilon_{yy}$ to its element-wise average.\n3. Perform an eigenanalysis of each matrix and determine:\n   - The number of numerically near-zero eigenvalues (interpreted as zero-energy modes). Use a relative threshold defined as follows: let $\\lambda_{\\max}$ be the largest eigenvalue; classify any eigenvalue $\\lambda$ as near-zero if $\\lambda \\le \\max\\left(10^{-8}\\,\\lambda_{\\max},\\,10^{-12}\\right)$.\n   - The largest principal angle (in radians) between the subspace spanned by the three eigenvectors corresponding to the smallest eigenvalues and the rigid body subspace generated by the two translations and one in-plane rotation. The rigid body subspace basis vectors are to be constructed from the nodal coordinates $(x_a,y_a)$ as follows:\n     - Rigid translation in $x$: $\\mathbf{r}_1 = [1,0,1,0,1,0,1,0]^\\mathsf{T}$,\n     - Rigid translation in $y$: $\\mathbf{r}_2 = [0,1,0,1,0,1,0,1]^\\mathsf{T}$,\n     - Rigid rotation about the origin with unit rotation: $\\mathbf{r}_3 = [-y_1,x_1,-y_2,x_2,-y_3,x_3,-y_4,x_4]^\\mathsf{T}$.\n   Compute the largest principal angle between the span of $\\{\\mathbf{r}_1,\\mathbf{r}_2,\\mathbf{r}_3\\}$ and the span of the three smallest-eigenvalue eigenvectors, using the standard Euclidean inner product. Express this angle in radians as a floating-point number.\n\nTest suite:\nProvide results for the following three test cases. In all cases, use plane strain and units of Pascals for $E$.\n- Case A (nominal compressible, undistorted): Node coordinates in meters\n  $$\n  (x_1,y_1)=(0,0),\\quad (x_2,y_2)=(1,0),\\quad (x_3,y_3)=(1,1),\\quad (x_4,y_4)=(0,1),\n  $$\n  with $E = 3.0\\times 10^{7}$ and $\\nu = 0.25$.\n- Case B (nearly incompressible, undistorted): Same coordinates as Case A, with $E = 3.0\\times 10^{7}$ and $\\nu = 0.499999$.\n- Case C (compressible, distorted convex quadrilateral): Node coordinates in meters\n  $$\n  (x_1,y_1)=(0.0,0.0),\\;\n  (x_2,y_2)=(2.0,0.2),\\;\n  (x_3,y_3)=(1.8,1.2),\\;\n  (x_4,y_4)=(-0.1,1.0),\n  $$\n  with $E = 3.0\\times 10^{7}$ and $\\nu = 0.25$.\n\nFor each case, your program must output a list with four entries:\n- The integer number of near-zero eigenvalues for the standard formulation,\n- The integer number of near-zero eigenvalues for the $\\bar{B}$ formulation,\n- The largest principal angle in radians (as a floating-point number) for the standard formulation,\n- The largest principal angle in radians (as a floating-point number) for the $\\bar{B}$ formulation.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list of three lists (one per case) enclosed in square brackets. Each inner list must have the form\n  $[n_{\\mathrm{std}},n_{\\bar{B}},\\theta_{\\mathrm{std}},\\theta_{\\bar{B}}]$,\n  where $n_{\\mathrm{std}}$ and $n_{\\bar{B}}$ are integers and $\\theta_{\\mathrm{std}}$ and $\\theta_{\\bar{B}}$ are floating-point numbers in radians, each formatted in scientific notation with six digits after the decimal (for example, $1.234567\\mathrm{e}{-08}$). For instance:\n  $[[3,3,1.000000\\mathrm{e}{-12},1.000000\\mathrm{e}{-12}],[\\dots],[\\dots]]$.\n\nScientific realism and expectations:\n- The standard Q4 stiffness matrix is symmetric positive semidefinite with exactly three rigid body modes in two dimensions, so its rank is expected to be $5$ for a single unconstrained element. The $\\bar{B}$ modification should not introduce additional spurious zero-energy modes. Your numerical evidence should confirm that both the standard and $\\bar{B}$-modified stiffness matrices possess the same number of near-zero eigenvalues and that the subspace of the three smallest-eigenvalue eigenvectors aligns with the rigid body subspace (small largest principal angle).",
            "solution": "The problem requires an analysis of the B-bar ($\\bar{B}$) method's effect on the stability of a four-node bilinear quadrilateral (Q4) element in plane strain linear elasticity. Specifically, we must determine if this modification introduces non-physical, or \"spurious,\" zero-energy modes. The analysis involves constructing the standard stiffness matrix $\\mathbf{K}$ and the $\\bar{B}$-modified stiffness matrix $\\mathbf{K}_{\\bar{B}}$, performing an eigenvalue analysis on both, and comparing their nullspaces to the subspace of rigid-body motions.\n\n### 1. Isoparametric Q4 Element Formulation\n\nThe foundation of the analysis is the isoparametric Q4 element. The geometry and displacement field within the element are interpolated from the nodal values using the same set of bilinear shape functions, $N_a(\\xi, \\eta)$, where $(\\xi, \\eta)$ are the natural coordinates in the reference square domain $[-1,1]^2$.\n\nThe displacement field $\\mathbf{u}$ at a point $(x,y)$ within the element is given by:\n$$ \\mathbf{u}(x,y) = \\sum_{a=1}^{4} N_a(\\xi,\\eta) \\mathbf{u}_a $$\nwhere $\\mathbf{u}_a = \\{u_{xa}, u_{ya}\\}^T$ is the displacement vector at node $a$. The vector of all $8$ nodal degrees of freedom is denoted by $\\mathbf{u}_e$.\n\nUnder the assumption of small strains, the engineering strain vector $\\boldsymbol{\\varepsilon} = \\{\\varepsilon_{xx}, \\varepsilon_{yy}, \\gamma_{xy}\\}^T$ is related to the nodal displacements by the strain-displacement matrix $\\mathbf{B}$:\n$$ \\boldsymbol{\\varepsilon} = \\mathbf{B} \\mathbf{u}_e $$\nThe matrix $\\mathbf{B}$ is composed of nodal blocks $\\mathbf{B}_a$:\n$$ \\mathbf{B} = [\\mathbf{B}_1, \\mathbf{B}_2, \\mathbf{B}_3, \\mathbf{B}_4], \\quad \\text{with} \\quad \\mathbf{B}_a = \\begin{bmatrix} \\frac{\\partial N_a}{\\partial x} & 0 \\\\ 0 & \\frac{\\partial N_a}{\\partial y} \\\\ \\frac{\\partial N_a}{\\partial y} & \\frac{\\partial N_a}{\\partial x} \\end{bmatrix} $$\nThe derivatives of the shape functions with respect to the physical coordinates $(x,y)$ are obtained from their derivatives with respect to the natural coordinates $(\\xi, \\eta)$ via the inverse of the Jacobian matrix $\\mathbf{J}$.\n\n### 2. Standard Element Stiffness Matrix $\\mathbf{K}$\n\nThe element stiffness matrix $\\mathbf{K}$ relates the nodal forces to the nodal displacements. It is derived from the element's strain energy and is computed by integrating over the element's area $A$:\n$$ \\mathbf{K} = \\int_A \\mathbf{B}^T \\mathbf{D} \\mathbf{B} \\, dA $$\nHere, $\\mathbf{D}$ is the constitutive matrix for plane strain, which relates stresses to strains: $\\boldsymbol{\\sigma} = \\mathbf{D}\\boldsymbol{\\varepsilon}$. The problem provides the matrix for an isotropic material:\n$$ \\mathbf{D} = \\begin{bmatrix} \\lambda + 2\\mu & \\lambda & 0 \\\\ \\lambda & \\lambda + 2\\mu & 0 \\\\ 0 & 0 & \\mu \\end{bmatrix} $$\nwhere $\\lambda$ and $\\mu$ are the Lamé parameters. The integral is evaluated numerically using $2 \\times 2$ Gauss quadrature:\n$$ \\mathbf{K} \\approx \\sum_{i=1}^{4} w_i \\mathbf{B}_i^T \\mathbf{D} \\mathbf{B}_i \\det(\\mathbf{J}_i) $$\nwhere the index $i$ runs over the four Gauss points, $w_i=1$ are the weights, and $\\mathbf{B}_i$ and $\\det(\\mathbf{J}_i)$ are the B-matrix and Jacobian determinant evaluated at the $i$-th Gauss point.\n\n### 3. The $\\bar{B}$ Method for Volumetric Locking\n\nStandard Q4 elements with full ($2 \\times 2$) integration exhibit \"volumetric locking\" when modeling nearly incompressible materials (i.e., Poisson's ratio $\\nu \\to 0.5$). The limited kinematic modes of the bilinear approximation cannot satisfy the constant-volume constraint at every point, leading to a spuriously stiff response.\n\nThe $\\bar{B}$ method alleviates this by modifying how the volumetric part of the strain is computed. The strain tensor is decomposed into a deviatoric (shape-changing) part and a volumetric (volume-changing) part. In 2D, the volumetric strain, or in-plane dilatation, is $e_{\\mathrm{vol}} = \\varepsilon_{xx} + \\varepsilon_{yy}$.\n\nThe core idea is to enforce a weaker, averaged volumetric constraint. Instead of requiring the volumetric strain to be correctly represented at every Gauss point, its element-averaged value $\\bar{e}_{\\mathrm{vol}}$ is used:\n$$ \\bar{e}_{\\mathrm{vol}} = \\frac{1}{A} \\int_A e_{\\mathrm{vol}} \\, dA $$\nThis projection of the volumetric strain onto the space of constant functions over the element is sufficient to capture the dominant volumetric behavior without over-constraining the element. This leads to a modified strain-displacement relationship and, consequently, a modified stiffness matrix $\\mathbf{K}_{\\bar{B}}$.\n\nA computationally efficient way to construct $\\mathbf{K}_{\\bar{B}}$ is by decomposing the constitutive matrix $\\mathbf{D}$ into volumetric and deviatoric parts, $\\mathbf{D} = \\mathbf{D}_{\\mathrm{vol}} + \\mathbf{D}_{\\mathrm{dev}}$. For plane strain, the bulk modulus is $K = \\lambda+\\mu$. The decomposition is:\n$$ \\mathbf{D}_{\\mathrm{vol}} = K \\begin{bmatrix} 1 & 1 & 0 \\\\ 1 & 1 & 0 \\\\ 0 & 0 & 0 \\end{bmatrix}, \\quad \\mathbf{D}_{\\mathrm{dev}} = \\mu \\begin{bmatrix} 1 & -1 & 0 \\\\ -1 & 1 & 0 \\\\ 0 & 0 & 1 \\end{bmatrix} $$\nThe deviatoric part of the stiffness matrix is computed using full integration:\n$$ \\mathbf{K}_{\\mathrm{dev}} = \\int_A \\mathbf{B}^T \\mathbf{D}_{\\mathrm{dev}} \\mathbf{B} \\, dA \\approx \\sum_{i=1}^{4} w_i \\mathbf{B}_i^T \\mathbf{D}_{\\mathrm{dev}} \\mathbf{B}_i \\det(\\mathbf{J}_i) $$\nThe volumetric part is based on the averaged kinematics. Let $\\mathbf{m} = \\{1, 1, 0\\}^T$. The average volumetric strain operator is a column vector $\\bar{\\mathbf{b}}$:\n$$ \\bar{\\mathbf{b}} = \\frac{1}{A} \\int_A \\mathbf{B}^T \\mathbf{m} \\, dA \\approx \\frac{1}{\\sum_j w_j \\det(\\mathbf{J}_j)} \\sum_i w_i (\\mathbf{B}_i^T \\mathbf{m}) \\det(\\mathbf{J}_i) $$\nThe volumetric stiffness is then constructed as:\n$$ \\mathbf{K}_{\\bar{\\mathrm{vol}}} = A \\, K \\, \\bar{\\mathbf{b}} \\bar{\\mathbf{b}}^T $$\nThe total modified stiffness matrix is the sum of these two components:\n$$ \\mathbf{K}_{\\bar{B}} = \\mathbf{K}_{\\mathrm{dev}} + \\mathbf{K}_{\\bar{\\mathrm{vol}}} $$\nThis formulation correctly handles the nearly incompressible case while retaining the correct behavior for compressible materials.\n\n### 4. Stability Analysis: Zero-Energy Modes\n\nThe stability of an element formulation is assessed by examining the eigenvalues of its stiffness matrix. Eigenvectors with zero eigenvalues correspond to \"zero-energy modes\"—patterns of nodal displacement that produce no strain energy. For any unconstrained element in 2D, there must be exactly three such modes, corresponding to rigid-body motions (two translations and one in-plane rotation).\n\nThe presence of more than three zero-energy modes indicates that the element is unstable, as it can deform without resisting, a phenomenon known as \"spurious modes\" or \"mechanisms.\" A crucial test for any new formulation, such as the $\\bar{B}$ method, is to verify that it does not introduce such spurious modes. We perform this test by computing the eigenvalues of $\\mathbf{K}$ and $\\mathbf{K}_{\\bar{B}}$ and counting how many are numerically close to zero.\n\n### 5. Subspace Comparison via Principal Angles\n\nTo confirm that the computed zero-energy modes are indeed the correct rigid-body modes (RBMs), we compare the eigenspace corresponding to the three smallest eigenvalues with the analytically defined RBM subspace. The principal angles between two subspaces provide a measure of their alignment. If the largest principal angle is close to zero, the two subspaces are nearly identical.\n\nThe RBM subspace is spanned by the vectors for x-translation ($\\mathbf{r}_1$), y-translation ($\\mathbf{r}_2$), and rotation about the origin ($\\mathbf{r}_3$). We form an orthonormal basis $\\mathbf{Q}_R$ for this subspace. The eigenvectors corresponding to the three smallest eigenvalues of the stiffness matrix form another orthonormal basis $\\mathbf{Q}_U$. The cosines of the principal angles are the singular values of the matrix product $\\mathbf{Q}_R^T \\mathbf{Q}_U$. The largest principal angle is the arccosine of the smallest singular value. A small value for this angle confirms that the element's nullspace correctly represents the rigid-body motions.\n\nThe following program implements this entire procedure to provide quantitative evidence regarding the stability of the $\\bar{B}$ formulation. Both the standard and modified elements are expected to have exactly three zero-energy modes, which correspond to the RBMs.",
            "answer": "```python\nimport numpy as np\nfrom scipy.linalg import eigh, svd, qr\n\ndef solve():\n    \"\"\"\n    Main function to run the analysis for all test cases.\n    \"\"\"\n    \n    # Test Cases: (node_coords, E, nu)\n    test_cases = [\n        # Case A: Square, compressible\n        (np.array([[0.0, 0.0], [1.0, 0.0], [1.0, 1.0], [0.0, 1.0]]), \n         3.0e7, 0.25),\n        # Case B: Square, nearly incompressible\n        (np.array([[0.0, 0.0], [1.0, 0.0], [1.0, 1.0], [0.0, 1.0]]), \n         3.0e7, 0.499999),\n        # Case C: Distorted, compressible\n        (np.array([[0.0, 0.0], [2.0, 0.2], [1.8, 1.2], [-0.1, 1.0]]), \n         3.0e7, 0.25)\n    ]\n\n    results = []\n    for nodes, E, nu in test_cases:\n        case_results = []\n        \n        # Standard formulation\n        n_std, theta_std = analyze_element(nodes, E, nu, use_b_bar=False)\n        \n        # B-bar formulation\n        n_bbar, theta_bbar = analyze_element(nodes, E, nu, use_b_bar=True)\n        \n        case_results.extend([n_std, n_bbar, theta_std, theta_bbar])\n        results.append(case_results)\n\n    # Format output\n    output_str = \"[\"\n    for i, res in enumerate(results):\n        n_s, n_b, t_s, t_b = res\n        output_str += f\"[{n_s},{n_b},{t_s:.6e},{t_b:.6e}]\"\n        if i < len(results) - 1:\n            output_str += \",\"\n    output_str += \"]\"\n    \n    print(output_str)\n\ndef analyze_element(nodes, E, nu, use_b_bar):\n    \"\"\"\n    Analyzes a single element configuration.\n    \n    Args:\n        nodes: Nodal coordinates (4x2 array).\n        E: Young's modulus.\n        nu: Poisson's ratio.\n        use_b_bar: Boolean flag to use the B-bar method.\n        \n    Returns:\n        A tuple containing:\n        - The number of near-zero eigenvalues.\n        - The largest principal angle with the RBM subspace in radians.\n    \"\"\"\n    K = build_stiffness_matrix(nodes, E, nu, use_b_bar)\n    \n    # Eigenanalysis\n    evals, evecs = eigh(K)\n    \n    # Count near-zero eigenvalues\n    lambda_max = evals[-1]\n    threshold = max(1e-8 * lambda_max, 1e-12)\n    num_zero_modes = np.sum(evals <= threshold)\n    \n    # Principal angle calculation\n    # Subspace from 3 smallest eigenvalues\n    Q_U = evecs[:, :3]\n    \n    # Rigid Body Mode (RBM) subspace\n    r1 = np.array([1, 0, 1, 0, 1, 0, 1, 0], dtype=float)\n    r2 = np.array([0, 1, 0, 1, 0, 1, 0, 1], dtype=float)\n    x, y = nodes.flatten(order='C')[::2], nodes.flatten(order='C')[1::2]\n    r3 = np.ravel(np.vstack([-y, x]).T)\n    \n    RBM_matrix = np.vstack([r1, r2, r3]).T\n    Q_R, _ = qr(RBM_matrix) # Orthonormal basis for RBM subspace\n    \n    # Singular values of the correlation matrix\n    M = Q_U.T @ Q_R\n    s = svd(M, compute_uv=False)\n    \n    # Smallest singular value corresponds to the largest principal angle\n    s_min = s[-1]\n    # np.clip for numerical stability with arccos\n    largest_principal_angle = np.arccos(np.clip(s_min, -1.0, 1.0))\n    \n    return num_zero_modes, largest_principal_angle\n\ndef get_shape_functions_and_derivs(xi, eta):\n    \"\"\"Returns shape functions and their derivatives w.r.t. natural coords.\"\"\"\n    N = 0.25 * np.array([(1-xi)*(1-eta), (1+xi)*(1-eta), (1+xi)*(1+eta), (1-xi)*(1+eta)])\n    \n    dN_dxi = 0.25 * np.array([-(1-eta), (1-eta), (1+eta), -(1+eta)])\n    dN_deta = 0.25 * np.array([-(1-xi), -(1+xi), (1+xi), (1-xi)])\n    \n    return N, np.vstack([dN_dxi, dN_deta])\n\ndef build_stiffness_matrix(nodes, E, nu, use_b_bar):\n    \"\"\"\n    Constructs the 8x8 element stiffness matrix for a Q4 element.\n    \"\"\"\n    # Material properties for plane strain\n    lame_lambda = (E * nu) / ((1 + nu) * (1 - 2 * nu))\n    lame_mu = E / (2 * (1 + nu))\n    \n    if not use_b_bar:\n        D = np.array([\n            [lame_lambda + 2 * lame_mu, lame_lambda, 0],\n            [lame_lambda, lame_lambda + 2 * lame_mu, 0],\n            [0, 0, lame_mu]\n        ])\n    else:\n        # For B-bar, we need D_dev and bulk modulus K\n        K_bulk = lame_lambda + lame_mu\n        D_dev = lame_mu * np.array([[1, -1, 0], [-1, 1, 0], [0, 0, 1]])\n\n    # 2x2 Gauss quadrature\n    gauss_points = 1.0 / np.sqrt(3) * np.array([[-1, -1], [1, -1], [1, 1], [-1, 1]])\n    gauss_weights = np.array([1, 1, 1, 1])\n\n    K = np.zeros((8, 8))\n    \n    # Pre-compute B matrices and Jacobians at all Gauss points\n    B_matrices = []\n    J_dets = []\n    for xi, eta in gauss_points:\n        _, dN_dnat = get_shape_functions_and_derivs(xi, eta)\n        \n        J = dN_dnat @ nodes\n        det_J = np.linalg.det(J)\n        if det_J <= 0:\n            raise ValueError(\"Jacobian is non-positive. Element may be distorted or incorrectly numbered.\")\n        \n        J_inv = np.linalg.inv(J)\n        dN_dxy = J_inv @ dN_dnat\n        \n        B = np.zeros((3, 8))\n        for i in range(4):\n            B[0, 2*i] = dN_dxy[0, i]\n            B[1, 2*i+1] = dN_dxy[1, i]\n            B[2, 2*i] = dN_dxy[1, i]\n            B[2, 2*i+1] = dN_dxy[0, i]\n        \n        B_matrices.append(B)\n        J_dets.append(det_J)\n\n    if not use_b_bar:\n        # Standard formulation\n        for B_i, det_J_i, w_i in zip(B_matrices, J_dets, gauss_weights):\n            K += B_i.T @ D @ B_i * det_J_i * w_i\n    else:\n        # B-bar formulation\n        # K_bbar = K_dev + K_vol_bar\n        # K_dev = sum(w_i * J_i * B_i.T @ D_dev @ B_i)\n        K_dev = np.zeros((8, 8))\n        for B_i, det_J_i, w_i in zip(B_matrices, J_dets, gauss_weights):\n            K_dev += B_i.T @ D_dev @ B_i * det_J_i * w_i\n        \n        # K_vol_bar = A * K * b_bar @ b_bar.T\n        m = np.array([1, 1, 0])\n        element_area = sum(w * J for w, J in zip(gauss_weights, J_dets))\n        \n        b_bar_sum = np.zeros(8)\n        for B_i, det_J_i, w_i in zip(B_matrices, J_dets, gauss_weights):\n            b_bar_sum += m @ B_i * det_J_i * w_i\n        \n        b_bar = (1.0 / element_area) * b_bar_sum\n        \n        K_vol_bar = element_area * K_bulk * np.outer(b_bar, b_bar)\n        \n        K = K_dev + K_vol_bar\n\n    return K\n\nif __name__ == '__main__':\n    solve()\n```"
        }
    ]
}