{
    "hands_on_practices": [
        {
            "introduction": "开发可靠数值求解器的第一步是验证其实现的正确性并量化其精度。人造解方法（Method of Manufactured Solutions, MMS）是完成此任务的黄金标准技术，它允许我们在没有已知解析解的情况下严格评估代码的收敛阶。这个练习将指导你完成MMS中的分析部分：推导出一个必要的源项$S(x,t)$，使得一个我们自行选择的光滑函数成为偏微分方程（PDE）的精确解。这个推导出的源项和精确解随后可用于系统性地测试数值求解器的实现是否达到了其理论精度。",
            "id": "3564425",
            "problem": "在计算核物理的瞬态中子输运建模中，一个标准的简化模型是均匀板中的单群扩散近似，该模型在无量纲化以分离扩散传播后，可由以下抛物型偏微分方程表示：$u_{t} = \\alpha\\,u_{xx} + S(x,t)$，定义在空间域 $x \\in [0,L]$ 和时间 $t \\ge 0$ 上，其中 $u(x,t)$ 代表标度化的中子通量，$\\alpha > 0$ 是一个常数扩散参数，$S(x,t)$ 是一个源项。为了严格验证像克兰克-尼科尔森 (Crank–Nicolson, CN) 方法这样的隐式有限差分求解器的精度阶，可以使用制造解方法 (Method of Manufactured Solutions, MMS)：假设一个光滑、充分可微的解，并推导出使其成为连续模型精确解的强迫项，以及一致的边界和初始数据。\n\n考虑制造解\n$$\nu(x,t) = \\exp(-\\lambda t)\\,\\sin\\!\\left(\\frac{\\pi x}{L}\\right) + t^{3}\\,\\cosh(\\sigma x),\n$$\n其中有固定常数 $\\lambda > 0$，$\\sigma > 0$，$L > 0$ 和 $\\alpha > 0$。该选择在 $[0,L] \\times [0,\\infty)$ 上是光滑的，并且与由 $u(0,t)$ 和 $u(L,t)$ 决定的狄利克雷边界条件以及由 $u(x,0)$ 给出的初始条件相容。\n\n任务：\n- 仅使用控制方程 $u_{t} = \\alpha\\,u_{xx} + S(x,t)$ 和标准微分法则，推导制造源 $S(x,t)$ 的显式解析表达式，使得给定的 $u(x,t)$ 是该抛物型模型的精确解，定义在 $[0,L] \\times [0,\\infty)$ 上。\n- 叙述在 $x=0$ 和 $x=L$ 处的边界条件，以及在 $t=0$ 处的初始条件，这些条件需与所选的 $u(x,t)$ 一致，用于隐式有限差分格式的代码验证。\n- 简要论证如何使用此制造解来评估在均匀网格上采用中心二阶空间差分的克兰克-尼科尔森 (CN) 隐式格式的标称精度阶，方法是讨论在同时加密时间步长 $\\Delta t$ 和网格间距 $\\Delta x$ 时离散误差的渐近行为。\n\n答案规格：\n- 你的最终答案必须是 $S(x,t)$ 关于 $x$、$t$、$\\alpha$、$L$、$\\lambda$ 和 $\\sigma$ 的单一闭式解析表达式。最终答案中不要包含边界或初始条件。\n- 无需进行数值四舍五入。\n- 最终答案中不要包含单位。",
            "solution": "该问题是有效的。这是一个关于制造解方法 (Method of Manufactured Solutions, MMS) 的适定练习，MMS 是计算科学与工程中的一种标准验证技术。该问题具有科学依据，是客观的，并包含了推导所需源项及相关条件的所有必要信息。\n\n目标是找到源项 $S(x,t)$，使得所提出的函数 $u(x,t)$ 成为控制抛物型偏微分方程 (PDE) $u_t = \\alpha u_{xx} + S(x,t)$ 的一个精确解。这可以通过重新整理 PDE 来求解 $S(x,t)$ 实现：\n$$\nS(x,t) = u_t(x,t) - \\alpha\\,u_{xx}(x,t)\n$$\n我们给定的制造解为：\n$$\nu(x,t) = \\exp(-\\lambda t)\\,\\sin\\!\\left(\\frac{\\pi x}{L}\\right) + t^{3}\\,\\cosh(\\sigma x)\n$$\n为求得 $S(x,t)$，我们必须计算 $u$ 对时间的一阶偏导数 ($u_t$) 和对空间的二阶偏导数 ($u_{xx}$)。\n\n首先，我们计算对时间的偏导数 $u_t$：\n$$\nu_t(x,t) = \\frac{\\partial}{\\partial t}\\left[ \\exp(-\\lambda t)\\,\\sin\\!\\left(\\frac{\\pi x}{L}\\right) + t^{3}\\,\\cosh(\\sigma x) \\right]\n$$\n对每一项应用微分法则：\n$$\n\\frac{\\partial}{\\partial t}\\left[ \\exp(-\\lambda t)\\,\\sin\\!\\left(\\frac{\\pi x}{L}\\right) \\right] = -\\lambda\\exp(-\\lambda t)\\,\\sin\\!\\left(\\frac{\\pi x}{L}\\right)\n$$\n$$\n\\frac{\\partial}{\\partial t}\\left[ t^{3}\\,\\cosh(\\sigma x) \\right] = 3t^{2}\\,\\cosh(\\sigma x)\n$$\n合并这些结果，得到 $u_t$ 的表达式：\n$$\nu_t(x,t) = -\\lambda\\exp(-\\lambda t)\\,\\sin\\!\\left(\\frac{\\pi x}{L}\\right) + 3t^{2}\\,\\cosh(\\sigma x)\n$$\n\n接下来，我们计算对空间的二阶偏导数 $u_{xx}$。我们从求一阶导数 $u_x$ 开始：\n$$\nu_x(x,t) = \\frac{\\partial}{\\partial x}\\left[ \\exp(-\\lambda t)\\,\\sin\\!\\left(\\frac{\\pi x}{L}\\right) + t^{3}\\,\\cosh(\\sigma x) \\right]\n$$\n对每一项进行微分：\n$$\n\\frac{\\partial}{\\partial x}\\left[ \\exp(-\\lambda t)\\,\\sin\\!\\left(\\frac{\\pi x}{L}\\right) \\right] = \\exp(-\\lambda t)\\,\\cos\\!\\left(\\frac{\\pi x}{L}\\right) \\cdot \\frac{\\pi}{L}\n$$\n$$\n\\frac{\\partial}{\\partial x}\\left[ t^{3}\\,\\cosh(\\sigma x) \\right] = t^{3}\\,\\sinh(\\sigma x) \\cdot \\sigma\n$$\n因此，一阶空间导数为：\n$$\nu_x(x,t) = \\frac{\\pi}{L}\\exp(-\\lambda t)\\,\\cos\\!\\left(\\frac{\\pi x}{L}\\right) + \\sigma t^{3}\\,\\sinh(\\sigma x)\n$$\n现在，我们将 $u_x$ 对 $x$ 微分以求得 $u_{xx}$：\n$$\nu_{xx}(x,t) = \\frac{\\partial}{\\partial x}\\left[ \\frac{\\pi}{L}\\exp(-\\lambda t)\\,\\cos\\!\\left(\\frac{\\pi x}{L}\\right) + \\sigma t^{3}\\,\\sinh(\\sigma x) \\right]\n$$\n再次逐项微分：\n$$\n\\frac{\\partial}{\\partial x}\\left[ \\frac{\\pi}{L}\\exp(-\\lambda t)\\,\\cos\\!\\left(\\frac{\\pi x}{L}\\right) \\right] = \\frac{\\pi}{L}\\exp(-\\lambda t)\\left(-\\sin\\!\\left(\\frac{\\pi x}{L}\\right) \\cdot \\frac{\\pi}{L}\\right) = -\\frac{\\pi^2}{L^2}\\exp(-\\lambda t)\\,\\sin\\!\\left(\\frac{\\pi x}{L}\\right)\n$$\n$$\n\\frac{\\partial}{\\partial x}\\left[ \\sigma t^{3}\\,\\sinh(\\sigma x) \\right] = \\sigma t^{3}(\\cosh(\\sigma x) \\cdot \\sigma) = \\sigma^2 t^{3}\\,\\cosh(\\sigma x)\n$$\n合并这些结果，得到 $u_{xx}$ 的表达式：\n$$\nu_{xx}(x,t) = -\\frac{\\pi^2}{L^2}\\exp(-\\lambda t)\\,\\sin\\!\\left(\\frac{\\pi x}{L}\\right) + \\sigma^2 t^{3}\\,\\cosh(\\sigma x)\n$$\n\n最后，我们将 $u_t$ 和 $u_{xx}$ 的表达式代入 $S(x,t)$ 的公式中：\n$$\nS(x,t) = \\left[ -\\lambda\\exp(-\\lambda t)\\,\\sin\\!\\left(\\frac{\\pi x}{L}\\right) + 3t^{2}\\,\\cosh(\\sigma x) \\right] - \\alpha\\left[ -\\frac{\\pi^2}{L^2}\\exp(-\\lambda t)\\,\\sin\\!\\left(\\frac{\\pi x}{L}\\right) + \\sigma^2 t^{3}\\,\\cosh(\\sigma x) \\right]\n$$\n为简化起见，我们将包含 $\\sin(\\frac{\\pi x}{L})$ 和 $\\cosh(\\sigma x)$ 的项分组：\n$$\nS(x,t) = \\left(-\\lambda + \\alpha\\frac{\\pi^2}{L^2}\\right)\\exp(-\\lambda t)\\,\\sin\\!\\left(\\frac{\\pi x}{L}\\right) + \\left(3t^2 - \\alpha\\sigma^2 t^3\\right)\\cosh(\\sigma x)\n$$\n可以更简洁地写成：\n$$\nS(x,t) = \\left(\\frac{\\alpha\\pi^2}{L^2} - \\lambda\\right)\\exp(-\\lambda t)\\,\\sin\\!\\left(\\frac{\\pi x}{L}\\right) + (3 - \\alpha\\sigma^2 t)t^2\\,\\cosh(\\sigma x)\n$$\n这就是所要求的制造源项的解析表达式。\n\n对于第二个任务，我们通过在时空域的边界上计算制造解 $u(x,t)$ 的值来确定一致的边界和初始条件。\n$t=0$ 时的初始条件 (IC) 为：\n$$\nu(x,0) = \\exp(-\\lambda \\cdot 0)\\,\\sin\\!\\left(\\frac{\\pi x}{L}\\right) + 0^3\\,\\cosh(\\sigma x) = 1 \\cdot \\sin\\!\\left(\\frac{\\pi x}{L}\\right) + 0 = \\sin\\!\\left(\\frac{\\pi x}{L}\\right)\n$$\n$x=0$ 处的狄利克雷边界条件 (BC) 为：\n$$\nu(0,t) = \\exp(-\\lambda t)\\,\\sin(0) + t^3\\,\\cosh(0) = \\exp(-\\lambda t) \\cdot 0 + t^3 \\cdot 1 = t^3\n$$\n$x=L$ 处的狄利克雷边界条件 (BC) 为：\n$$\nu(L,t) = \\exp(-\\lambda t)\\,\\sin\\!\\left(\\frac{\\pi L}{L}\\right) + t^3\\,\\cosh(\\sigma L) = \\exp(-\\lambda t)\\,\\sin(\\pi) + t^3\\,\\cosh(\\sigma L) = 0 + t^3\\,\\cosh(\\sigma L) = t^3\\,\\cosh(\\sigma L)\n$$\n\n对于第三个任务，我们论证使用此制造解来评估克兰克-尼科尔森 (CN) 格式的精度阶的合理性。当应用于带有中心二阶空间离散的线性抛物型偏微分方程时，CN 格式在时间和空间上名义上都是二阶精度的。其全局截断误差为 $\\mathcal{O}(\\Delta t^2 + \\Delta x^2)$。通过使用推导出的制造源 $S(x,t)$ 和一致的初始条件 (IC) 与边界条件 (BCs) 来实现 PDE $u_t = \\alpha u_{xx} + S(x,t)$ 的求解器，我们可以在一个网格间距为 $\\Delta x$、时间步长为 $\\Delta t$ 的网格上计算出数值解 $u_{num}(x_i, t_n)$。由于我们有精确的解析解 $u_{exact}(x,t) = u(x,t)$，我们可以直接计算每个网格点上的离散误差。可以计算一个全局误差范数，例如离散 $L_2$ 范数：\n$$\nE(\\Delta x, \\Delta t) = \\sqrt{\\frac{1}{N_x}\\sum_{i=1}^{N_x-1} |u_{exact}(x_i, t_{final}) - u_{num}(x_i, t_{final})|^2}\n$$\n为了验证精度阶，我们进行一次网格加密研究。我们在一个由 $k$ 索引的网格序列上计算误差范数 $E_k$，其中每个后续网格都通过一个因子 $r$（通常 $r=2$）进行加密，即 $\\Delta x_{k+1} = \\Delta x_k/r$ 且 $\\Delta t_{k+1} = \\Delta t_k/r$。对于一个 $p$ 阶方法，假设 $\\Delta t$ 和 $\\Delta x$ 按比例加密，误差预计会按 $E \\approx C (\\Delta x^p + \\Delta t^p)$ 的规律变化，其中 $C$ 为某个常数。连续网格之间的误差比应为 $E_k/E_{k+1} \\approx r^p$。然后，观测到的收敛阶可以计算为 $p_{obs} = \\log_r(E_k/E_{k+1})$。当 $\\Delta x, \\Delta t \\to 0$ 时，我们期望 CN 格式的 $p_{obs} \\to 2$。如果观测到的阶数与理论阶数相匹配，这为代码实现正确提供了有力证据。",
            "answer": "$$\n\\boxed{\\left(\\frac{\\alpha\\pi^2}{L^2} - \\lambda\\right)\\exp(-\\lambda t)\\sin\\left(\\frac{\\pi x}{L}\\right) + (3 - \\alpha\\sigma^2 t)t^2\\cosh(\\sigma x)}\n$$"
        },
        {
            "introduction": "除了形式上的精度，一个用于物理问题的稳健数值格式还必须在离散层面遵循基本的守恒律。本练习将探讨扩散方程的离散质量守恒特性，这在模拟中子输运等物理过程中至关重要。通过实现并对比一个基于有限体积思想的守恒格式与一个简单的非守恒的逐点格式，你将亲眼观察到离散化方法的选择如何影响仿真的物理保真度，尤其是在存在非均匀介质（即扩散系数$D(x)$为变量）的情况下。",
            "id": "3564470",
            "problem": "要求您为具有空间变化扩散系数的一维抛物线型偏微分方程 (PDE) 设计并实现一个离散的 Backward Euler 时间积分格式，\n$$\n\\partial_t u(x,t) = \\partial_x\\big(D(x)\\,\\partial_x u(x,t)\\big),\n$$\n该方程在区域的两端满足齐次 Neumann 边界条件（零通量）。具体来说，您将测试两种不同的有限差分格式在 Backward Euler 方法下的离散质量守恒性质，并定量地识别当扩散系数非均匀时导致伪质量损失的条件。\n\n对于齐次 Neumann 边界条件，其连续系统的守恒声明为：总质量，\n$$\nM(t) = \\int_0^1 u(x,t)\\,\\mathrm{d}x,\n$$\n满足 $\\frac{\\mathrm{d}}{\\mathrm{d}t} M(t) = 0$，当 $\\big(D(x)\\,\\partial_x u\\big)\\big|_{x=0,1} = 0$ 时。您的任务是在 Backward Euler 方法下比较两种标准的离散空间算子，并测量其质量漂移。\n\n在一维空间域 $x\\in[0,1]$ 上进行计算，该区域有 $N$ 个均匀分布的单元中心。令 $\\Delta x = 1/N$。以单元为中心的网格点为 $x_i = \\big(i+\\tfrac{1}{2}\\big)\\Delta x$，其中 $i=0,1,\\dots,N-1$。使用无量纲初始条件\n$$\nu_0(x) = 1 + \\sin(\\pi x),\n$$\n该初始条件是严格为正的。所有物理量均为无量纲；报告的数值也应为无量纲数。\n\n您必须实现算子 $L u \\equiv \\partial_x\\big(D(x)\\,\\partial_x u\\big)$ 的两种空间离散化方法：\n\n1. 一种守恒通量形式（基于面）的有限体积/有限差分算子，该算子定义在单元中心上，并在界面处使用以面为中心的扩散系数 $D_{i+\\frac{1}{2}}$，\n   - 对于 $i=1,\\dots,N-2$，\n     $$\n     [L_{\\mathrm{cons}}\\,u]_i = \\frac{D_{i+\\frac{1}{2}}(u_{i+1}-u_i) - D_{i-\\frac{1}{2}}(u_i - u_{i-1})}{\\Delta x^2}.\n     $$\n   - 在左边界（$i=0$），通过 $F_{-\\frac{1}{2}}=0$ 施加零通量条件，因此\n     $$\n     [L_{\\mathrm{cons}}\\,u]_0 = \\frac{D_{\\frac{1}{2}}(u_{1}-u_0)}{\\Delta x^2}.\n     $$\n   - 在右边界（$i=N-1$），通过 $F_{N-\\frac{1}{2}}=0$ 施加零通量条件，因此\n     $$\n     [L_{\\mathrm{cons}}\\,u]_{N-1} = \\frac{D_{N-\\frac{3}{2}}(u_{N-2}-u_{N-1})}{\\Delta x^2}.\n     $$\n   - 通过对相邻单元值的调和平均来定义界面系数，以确保对称性和跨越阶跃的稳健性：\n     $$\n     D_{i+\\frac{1}{2}} = \\frac{2}{\\frac{1}{D_i}+\\frac{1}{D_{i+1}}},\\quad i=0,1,\\dots,N-2.\n     $$\n\n2. 一种非守恒的逐点系数拉普拉斯算子（朴素方法），该方法使用以单元为中心的 $D_i$ 乘以标准的二阶差分，并通过零梯度的虚拟节点闭合来施加齐次 Neumann 条件，\n   - 对于 $i=1,\\dots,N-2$，\n     $$\n     [L_{\\mathrm{naive}}\\,u]_i = \\frac{D_i\\,(u_{i+1} - 2u_i + u_{i-1})}{\\Delta x^2}.\n     $$\n   - 在 $i=0$ 处，使用 $u_{-1}=u_0$ 以实现零梯度，\n     $$\n     [L_{\\mathrm{naive}}\\,u]_0 = \\frac{D_0\\,(u_{1} - u_0)}{\\Delta x^2}.\n     $$\n   - 在 $i=N-1$ 处，使用 $u_{N}=u_{N-1}$ 以实现零梯度，\n     $$\n     [L_{\\mathrm{naive}}\\,u]_{N-1} = \\frac{D_{N-1}\\,(u_{N-2} - u_{N-1})}{\\Delta x^2}.\n     $$\n\n对于时间步进，使用 Backward Euler 方法\n$$\nu^{n+1} - u^n = \\Delta t\\,L\\,u^{n+1},\n$$\n因此对于每个算子 $L$，您必须在每个时间步求解线性系统\n$$\n\\big(I - \\Delta t\\,L\\big)\\,u^{n+1} = u^n\n$$\n。\n\n将给定时间层 $n$ 的离散总质量通过以单元为中心的求积法定义为\n$$\nM^n = \\sum_{i=0}^{N-1} u_i^n\\,\\Delta x.\n$$\n\n对每个测试用例，从在单元中心采样 $u_0(x)$ 得到的 $u^0$ 开始，运行 $K$ 个 Backward Euler 步。对两种算子（$L_{\\mathrm{cons}}$ 和 $L_{\\mathrm{naive}}$）中的每一种，计算最终质量比 $R = M^K/M^0$ 并报告绝对质量误差 $E = |R-1|$。\n\n您的程序必须实现这两种离散化方法，对每个测试用例执行时间步进，并生成所要求的质量误差。所有输出均为无量纲实数。\n\n测试组：\n- 用例 1（基准，常数扩散系数）：$N=128$，$\\Delta t=0.05$， $K=20$，$D(x)=1$。\n- 用例 2（平滑非均匀性）：$N=128$，$\\Delta t=0.05$， $K=20$，$D(x)=1+0.5\\sin(2\\pi x)$。\n- 用例 3（阶跃间断）：$N=128$，$\\Delta t=0.05$， $K=20$，$D(x)=\\begin{cases} 1,  x  0.5 \\\\ 10,  x \\ge 0.5 \\end{cases}$。\n- 用例 4（强梯度，较大时间步长）：$N=64$，$\\Delta t=0.2$， $K=10$，$D(x)=\\exp(5x)$。\n- 用例 5（粗网格，非常强的阶跃，大时间步长）：$N=16$，$\\Delta t=0.5$， $K=4$，$D(x)=\\begin{cases} 1,  x  0.5 \\\\ 100,  x \\ge 0.5 \\end{cases}$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个由方括号括起来的、逗号分隔的列表，列表内含 10 个无量纲浮点数。数字必须按测试用例排序，在每个测试用例中，首先报告守恒通量算子的绝对质量误差 $E_{\\mathrm{cons}}$，然后报告非守恒算子的绝对质量误差 $E_{\\mathrm{naive}}$。例如，输出必须具有以下形式\n$$\n[ E_{\\mathrm{cons}}^{(1)}, E_{\\mathrm{naive}}^{(1)}, E_{\\mathrm{cons}}^{(2)}, E_{\\mathrm{naive}}^{(2)}, E_{\\mathrm{cons}}^{(3)}, E_{\\mathrm{naive}}^{(3)}, E_{\\mathrm{cons}}^{(4)}, E_{\\mathrm{naive}}^{(4)}, E_{\\mathrm{cons}}^{(5)}, E_{\\mathrm{naive}}^{(5)} ].\n$$",
            "solution": "用户提供的问题已经过验证，并被确定为计算物理学中一个适定的、科学上合理的问题。\n\n### **1. 基于原理的设计：扩散问题中的质量守恒**\n\n该问题涉及求解具有空间变化扩散系数 $D(x)$ 的一维抛物线型扩散偏微分方程（PDE）的数值解：\n$$\n\\partial_t u(x,t) = \\partial_x\\left(D(x)\\,\\partial_x u(x,t)\\right)\n$$\n物理量 $u(x,t)$ 可以代表浓度或密度。外部空间导数内的表达式 $F(x,t) = -D(x)\\,\\partial_x u(x,t)$ 是物理通量。因此，该 PDE 具有连续性方程的形式，即 $\\partial_t u + \\partial_x F = 0$。\n\n该系统的一个关键物理原理是总质量（或物质 $u$ 的总量）守恒，其定义为 $M(t) = \\int_0^1 u(x,t)\\,\\mathrm{d}x$。总质量的变化率由下式给出：\n$$\n\\frac{\\mathrm{d}M}{\\mathrm{d}t} = \\int_0^1 \\partial_t u(x,t)\\,\\mathrm{d}x = \\int_0^1 \\partial_x\\left(D(x)\\,\\partial_x u(x,t)\\right)\\,\\mathrm{d}x\n$$\n根据微积分基本定理，该积分等于穿过边界的净通量：\n$$\n\\frac{\\mathrm{d}M}{\\mathrm{d}t} = \\left[D(x)\\,\\partial_x u(x,t)\\right]_0^1 = \\left(D(x)\\,\\partial_x u\\right)\\big|_{x=1} - \\left(D(x)\\,\\partial_x u\\right)\\big|_{x=0}\n$$\n问题指定了齐次 Neumann（零通量）边界条件，即 $\\left(D(x)\\,\\partial_x u\\right)|_{x=0,1}=0$，这意味着 $\\frac{\\mathrm{d}M}{\\mathrm{d}t} = 0$。因此，总质量 $M(t)$ 必须随时间保持恒定。\n\n如果一个数值格式能够保持该性质的离散模拟形式，则该格式是“守恒的”。本问题对比了两种空间离散化方法，以测试它们的离散质量守恒性。\n\n### **2. 离散化与时间积分**\n\n空间域 $x \\in [0,1]$ 被离散为 $N$ 个宽度为 $\\Delta x = 1/N$ 的单元。以单元为中心的网格点为 $x_i = (i+1/2)\\Delta x$，其中 $i=0, \\dots, N-1$。解由一个向量 $\\mathbf{u}(t)$ 表示，其中 $[\\mathbf{u}]_i = u(x_i, t)$。空间算子 $L \\equiv \\partial_x(D(x)\\partial_x \\cdot)$ 由一个 $N \\times N$ 矩阵 $\\mathbf{L}$ 近似。\n\n时间积分使用隐式 Backward Euler 方法进行：\n$$\n\\frac{\\mathbf{u}^{n+1} - \\mathbf{u}^n}{\\Delta t} = \\mathbf{L}\\mathbf{u}^{n+1}\n$$\n其中 $\\mathbf{u}^n$ 是在时间 $t_n = n\\Delta t$ 的解向量。该方程被重排为一个线性系统，在每个时间步为求解未知解 $\\mathbf{u}^{n+1}$ 而求解：\n$$\n(\\mathbf{I} - \\Delta t\\,\\mathbf{L}) \\mathbf{u}^{n+1} = \\mathbf{u}^n\n$$\n其中 $\\mathbf{I}$ 是单位矩阵。\n\n### **3. 空间算子公式**\n\n构建了两个矩阵算子 $\\mathbf{L}_{\\mathrm{cons}}$ 和 $\\mathbf{L}_{\\mathrm{naive}}$。两者均为三对角矩阵。\n\n#### **3.1. 守恒通量差分格式 ($L_{\\mathrm{cons}}$)**\n此方法基于有限体积法，其中算子离散化每个单元的通量散度。单元 $i$ 和 $i+1$ 之间界面处的通量为 $F_{i+1/2} = D_{i+1/2} \\frac{u_{i+1}-u_i}{\\Delta x}$。那么算子就是 $[L_{\\mathrm{cons}} u]_i = \\frac{F_{i+1/2} - F_{i-1/2}}{\\Delta x}$。通过设置 $F_{-1/2}=0$ 和 $F_{N-1/2}=0$ 来施加零通量边界条件。得到的矩阵 $\\mathbf{L}_{\\mathrm{cons}}$ 的构造方式使其任何一列的元素之和为零（在隐式地考虑了边界条件之后），这意味着向量 $\\mathbf{1}^T \\mathbf{L}_{\\mathrm{cons}} = \\mathbf{0}^T$。\n\n让我们证明这个性质。向量 $\\mathbf{L}_{\\mathrm{cons}}\\mathbf{u}$ 中所有项的和是 $\\sum_{i=0}^{N-1} [\\mathbf{L}_{\\mathrm{cons}}\\mathbf{u}]_i$。\n$$\n\\sum_{i=0}^{N-1} \\frac{F_{i+1/2} - F_{i-1/2}}{\\Delta x} = \\frac{1}{\\Delta x} \\left( (F_{1/2}-F_{-1/2}) + (F_{3/2}-F_{1/2}) + \\dots + (F_{N-1/2}-F_{N-3/2}) \\right)\n$$\n这是一个伸缩求和，其结果简化为 $\\frac{1}{\\Delta x} (F_{N-1/2} - F_{-1/2})$。在零通量边界条件下，这个和恰好为零。\n\n因此，对所有 $i$ 求和 Backward Euler 方程：\n$$\n\\sum_i u_i^{n+1} - \\sum_i u_i^n = \\Delta t \\sum_i [\\mathbf{L}_{\\mathrm{cons}}\\mathbf{u}^{n+1}]_i = 0\n$$\n乘以 $\\Delta x$ 表明离散质量 $M^n = \\sum_i u_i^n \\Delta x$ 是守恒的，即 $M^{n+1} = M^n$。因此，计算出的误差 $E_{\\mathrm{cons}}$ 仅由于浮点运算的限制才会非零。\n\n#### **3.2. 非守恒的逐点格式 ($L_{\\mathrm{naive}}$)**\n该格式应用了二阶导数的标准三点模板，并乘以以单元为中心的扩散系数 $D_i$：$[L_{\\mathrm{naive}} u]_i = D_i \\frac{u_{i+1}-2u_i+u_{i-1}}{\\Delta x^2}$。\n虽然这看起来是 $\\partial_x(D\\partial_x u) = D \\partial_x^2 u + (\\partial_x D)(\\partial_x u)$ 的直接离散化，但它仅在 $D$ 为常数时才能正确地表示该算子。乘积法则的展开显示，它遗漏了与 $D(x)$ 的梯度相关的一个项。这一疏忽破坏了守恒性质。\n\n当 $D(x)$ 不是常数时，和 $\\sum_i [\\mathbf{L}_{\\mathrm{naive}}\\mathbf{u}]_i$ 通常不等于零。矩阵 $\\mathbf{L}_{\\mathrm{naive}}$ 的列和不是零向量。对于内部的第 $j$ 列，其列和为 $(D_{j-1} - 2D_j + D_{j+1})/\\Delta x^2$，这近似于 $\\partial_x^2 D$。除非 $D(x)$ 是一个线性函数，否则这个值通常不为零。结果是，$\\mathbf{1}^T\\mathbf{u}^{n+1} \\neq \\mathbf{1}^T\\mathbf{u}^n$，离散质量不守恒。这导致了伪质量漂移，并且误差 $E_{\\mathrm{naive}}$ 将显著大于零，尤其当 $D(x)$ 高度非均匀时。\n\n### **4. 实现与最终度量**\n\n对于每个测试用例和每个格式，首先组装三对角系统矩阵 $\\mathbf{A} = (\\mathbf{I} - \\Delta t \\mathbf{L})$。然后执行一个包含 $K$ 个时间步的循环，在每个时间步中求解线性系统 $\\mathbf{A}\\mathbf{u}^{n+1} = \\mathbf{u}^n$。最后，计算初始离散质量 $M^0 = \\sum_i u_i^0 \\Delta x$ 和最终质量 $M^K = \\sum_i u_i^K \\Delta x$，以求得绝对质量误差 $E = |M^K/M^0 - 1|$。",
            "answer": "```python\nimport numpy as np\nfrom scipy.linalg import solve_banded\n\ndef solve():\n    \"\"\"\n    Solves the 1D diffusion equation with two different spatial discretizations\n    and reports the mass conservation error for a suite of test cases.\n    \"\"\"\n\n    test_cases = [\n        # Case 1: Constant diffusion\n        (128, 0.05, 20, lambda x: np.full_like(x, 1.0)),\n        # Case 2: Smooth heterogeneity\n        (128, 0.05, 20, lambda x: 1.0 + 0.5 * np.sin(2 * np.pi * x)),\n        # Case 3: Jump discontinuity\n        (128, 0.05, 20, lambda x: np.where(x  0.5, 1.0, 10.0)),\n        # Case 4: Strong gradient\n        (64, 0.2, 10, lambda x: np.exp(5 * x)),\n        # Case 5: Coarse grid, strong jump\n        (16, 0.5, 4, lambda x: np.where(x  0.5, 1.0, 100.0))\n    ]\n\n    results = []\n\n    for N, dt, K, D_func in test_cases:\n        dx = 1.0 / N\n        x_centers = (np.arange(N) + 0.5) * dx\n        D_cell = D_func(x_centers)\n        \n        u0 = 1.0 + np.sin(np.pi * x_centers)\n        M0 = np.sum(u0) * dx\n\n        # --- Conservative Scheme ---\n        u_cons = u0.copy()\n        \n        # Harmonic mean for face diffusivities\n        D_face = 2.0 * D_cell[:-1] * D_cell[1:] / (D_cell[:-1] + D_cell[1:])\n        \n        # Assemble tridiagonal system matrix for (I - dt*L_cons)\n        r_cons = dt / (dx**2)\n        \n        main_diag_L = np.zeros(N)\n        main_diag_L[0] = -D_face[0]\n        main_diag_L[1:-1] = -(D_face[1:] + D_face[:-1])\n        main_diag_L[-1] = -D_face[-1]\n        \n        upper_diag_L = D_face\n        lower_diag_L = D_face\n\n        c_cons = 1.0 - r_cons * main_diag_L\n        u_diag_cons = -r_cons * upper_diag_L\n        l_diag_cons = -r_cons * lower_diag_L\n        \n        ab_cons = np.zeros((3, N))\n        ab_cons[0, 1:] = u_diag_cons\n        ab_cons[1, :] = c_cons\n        ab_cons[2, :-1] = l_diag_cons\n        \n        for _ in range(K):\n            u_cons = solve_banded((1, 1), ab_cons, u_cons)\n            \n        MK_cons = np.sum(u_cons) * dx\n        E_cons = np.abs(MK_cons / M0 - 1.0)\n        \n        # --- Non-Conservative (Naive) Scheme ---\n        u_naive = u0.copy()\n        \n        # Assemble tridiagonal system matrix for (I - dt*L_naive)\n        r_naive = dt / (dx**2)\n        \n        main_diag_L_n = np.zeros(N)\n        main_diag_L_n[0] = -D_cell[0]\n        main_diag_L_n[1:-1] = -2.0 * D_cell[1:-1]\n        main_diag_L_n[-1] = -D_cell[-1]\n        \n        upper_diag_L_n = D_cell[:-1]\n        lower_diag_L_n = D_cell[1:]\n        \n        c_naive = 1.0 - r_naive * main_diag_L_n\n        u_diag_naive = -r_naive * upper_diag_L_n\n        l_diag_naive = -r_naive * lower_diag_L_n\n        \n        ab_naive = np.zeros((3, N))\n        ab_naive[0, 1:] = u_diag_naive\n        ab_naive[1, :] = c_naive\n        ab_naive[2, :-1] = l_diag_naive\n        \n        for _ in range(K):\n            u_naive = solve_banded((1, 1), ab_naive, u_naive)\n            \n        MK_naive = np.sum(u_naive) * dx\n        E_naive = np.abs(MK_naive / M0 - 1.0)\n        \n        results.extend([E_cons, E_naive])\n\n    # Format output as a comma-separated list in brackets\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}