{
    "hands_on_practices": [
        {
            "introduction": "掌握费米理论的第一步是推导出发射电子的能量分布。这项练习  将指导你从相空间和库仑修正出发，构建允许跃迁的 β 能谱。你还将学习如何构建和分析著名的库里图（Kurie plot），这是一个从实验上确定衰变终点能量的关键工具。",
            "id": "3559128",
            "problem": "在费米贝塔衰变理论的框架下，考虑一个允许的核贝塔衰变。使用费米黄金定则以及针对电子和反中微子的相对论相空间推理，从以下基本依据出发，推导电子能谱和居里（Kurie）表示法：\n\n- 根据费米黄金定则，跃迁率与跃迁矩阵元的平方和可用相空间成正比。对于允许跃迁，跃迁矩阵元与动量无关。\n- 电子的相对论能量-动量关系为 $E^2 = p^2 + m_e^2$，其中 $E$ 是电子的总能量，$p$ 是电子的动量，$m_e$ 是电子的质量。使用 $c = 1$ 的单位制。\n- 轻子间的能量守恒要求电子和反中微子共享可用的 $Q$ 值。在忽略核反冲的情况下，反中微子的能量为 $E_\\nu = E_0 - E$，其中 $E_0$ 是电子的终点总能量。\n- 出射电子与子核之间的库仑相互作用通过一个称为费米函数的乘法因子来修正电子的状态密度。在点核、索末菲因子近似下，该函数为\n$$\nF(Z, E) = \\frac{2 \\pi \\eta}{1 - e^{-2 \\pi \\eta}}, \\quad \\eta = \\alpha\\, Z\\, \\frac{E}{p},\n$$\n其中 $Z$ 是子核的电荷数，$\\alpha$ 是精细结构常数，$E$ 是电子的总能量，$p$ 是电子的动量。对于 $\\beta^-$ 衰变，取 $\\eta > 0$。\n\n从这些基础出发，推导允许衰变的微分能谱形状与运动学因子和 $F(Z,E)$ 的特定乘积成正比，并且居里图变量可以定义为\n$$\nK(E) \\equiv \\sqrt{\\frac{N(E)}{p\\,E\\,F(Z,E)}},\n$$\n从而对于没有形状因子或辐射修正的允许衰变，$K(E)$ 表现出对 $E$ 的线性依赖关系，其与零点的交点即为终点能量 $E_0$。\n\n您的任务是实现一个程序，对下面的每个测试用例，使用推导出的表达式执行以下计算：\n\n1. 计算未归一化的相空间积分\n$$\nI_0 = \\int_{m_e}^{E_0} p\\,E\\,(E_0 - E)^2\\,F(Z, E)\\,dE,\n$$\n以 $\\mathrm{MeV}^5$ 为单位表示。\n2. 计算归一化常数 $C = 1/I_0$，使得归一化能谱 $N(E)$ 在 $[m_e, E_0]$ 上的积分为1。然后计算平均电子动能\n$$\n\\langle T \\rangle = \\int_{m_e}^{E_0} \\left(E - m_e\\right)\\, N(E)\\, dE,\n$$\n以 $\\mathrm{MeV}$ 为单位表示。\n3. 使用归一化能谱 $N(E)$ 和上面给出的 $K(E)$ 定义构建居里图。在 $[m_e, E_0]$ 区间内的密集网格上，使用 $K(E)$ 对 $E$ 的线性最小二乘回归，将最佳拟合线的零点作为终点能量 $\\widehat{E}_0$ 的估计值，并以 $\\mathrm{MeV}$ 为单位报告。\n\n使用的物理常数：\n- 电子质量 $m_e = 0.51099895\\,\\mathrm{MeV}$。\n- 精细结构常数 $\\alpha = 1/137.035999084$。\n\n数值计算要求：\n- 在 $E \\in [m_e, E_0]$ 上进行所有数值积分。稳健地处理端点行为；您引入的任何内部正则化都不能改变连续极限。使用足够高的求积精度，以确保您的结果至少在六位小数上是稳定的。\n- 对于居里拟合，在开区间 $(m_e, E_0)$ 上使用一个至少包含 $400$ 个点的均匀网格，仅排除端点处为避免浮点奇异性所必需的无穷小邻域，并拟合一条直线 $K(E) \\approx a + b\\,E$。报告 $\\widehat{E}_0 = -a/b$。\n\n测试组（每个案例由子核电荷数 $Z$、质量数 $A$（对于所选的费米函数近似，可以忽略此项）和电子终点总能量 $E_0$（单位为 MeV）指定）：\n- 案例 1：$Z = 1$, $A = 3$, $E_0 = 0.52959895$。\n- 案例 2：$Z = 8$, $A = 14$, $E_0 = 1.50000000$。\n- 案例 3：$Z = 50$, $A = 120$, $E_0 = 3.50000000$。\n\n要求输出：\n- 对于每个案例，按以下顺序输出三个数字：$I_0$（单位 $\\mathrm{MeV}^5$），$\\langle T \\rangle$（单位 $\\mathrm{MeV}$），以及 $\\widehat{E}_0$（单位 $\\mathrm{MeV}$）。\n- 您的程序应生成单行输出，其中包含三个案例的九个结果，四舍五入到六位小数，以逗号分隔列表的形式包含在方括号中，并按上述测试案例的顺序排列。例如：“[I01,meanT1,E0hat1,I02,meanT2,E0hat2,I03,meanT3,E0hat3]”。",
            "solution": "用户提供的问题被评估为**有效**。这是一个形式良好、有科学依据的计算核物理问题，要求基于标准费米$\\beta$衰变理论进行理论推导和数值实现。所有必需的物理常数、函数定义和参数均已提供，任务清晰且计算上可行。\n\n### 理论推导\n\n主要目标是推导允许$\\beta$衰变中电子能谱的形状，并随后证明居里图的线性关系。\n\n**1. 电子能谱**\n\n根据费米黄金定则，衰变过程的微分跃迁率 $d\\lambda$ 与跃迁矩阵元的平方 $|M_{fi}|^2$ 以及末态密度 $d\\rho$ 成正比：\n$$d\\lambda = \\frac{2\\pi}{\\hbar} |M_{fi}|^2 d\\rho$$\n对于允许的$\\beta$衰变，轻子波函数可以近似为平面波，并且跃迁矩阵元 $|M_{fi}|^2$ 可以被认为与轻子动量无关。它通常写为费米常数 $G_F$ 的平方与核矩阵元 $|M_{nucl}|^2$ 的乘积，对于给定的跃迁，这些都是常数。\n\n末态由子核、一个电子（$e^-$）和一个反中微子（$\\bar{\\nu}_e$）组成。忽略重子核的反冲，衰变中释放的总能量（$Q$值）由电子和反中微子共享。轻子可获得的总能量为 $E_0$，即电子的终点能量，其中包括其静止质量能。能量守恒规定：\n$$E_0 = E + E_\\nu$$\n其中 $E$ 是电子的总能量，$E_\\nu$ 是反中微子的能量。相对论能量-动量关系为：电子是 $E^2 = p^2 + m_e^2$（使用 $c=1$ 的单位制），而对于有效无质量的反中微子是 $E_\\nu = p_\\nu$。\n\n末态密度 $d\\rho$ 取决于出射电子和反中微子的动量。动量在 $p$ 到 $p+dp$ 之间的电子和动量在 $p_\\nu$ 到 $p_\\nu+dp_\\nu$ 之间的反中微子的可用量子态数由它们各自的相空间体积的乘积给出（设 $\\hbar=1$）：\n$$d^2N_{states} = \\frac{d^3p}{(2\\pi)^3} \\frac{d^3p_\\nu}{(2\\pi)^3} = \\frac{(4\\pi p^2 dp)}{(2\\pi)^3} \\frac{(4\\pi p_\\nu^2 dp_\\nu)}{(2\\pi)^3}$$\n电子能谱 $N(E)dE$ 是通过对给定电子能量 $E$ 时所有符合能量守恒的反中微子态进行积分得到的。对于固定的电子能量 $E$，可用的状态密度与受 $E_\\nu = E_0 - E$ 约束的反中微子相空间成正比：\n$$d\\rho(E) \\propto d^3p \\int \\delta(E_0 - E - E_\\nu) d^3p_\\nu$$\n对反中微子相空间的积分得到：\n$$\\int \\delta(E_0 - E - p_\\nu) 4\\pi p_\\nu^2 dp_\\nu = 4\\pi(E_0 - E)^2$$\n电子的相空间因子是 $d^3p = 4\\pi p^2 dp$。结合这些因子，动量谱为：\n$$N(p)dp \\propto |M_{fi}|^2 p^2 (E_0-E)^2 dp$$\n为了找到能谱 $N(E)dE$，我们使用关系式 $E^2=p^2+m_e^2 \\implies 2EdE = 2pdp \\implies p dp = E dE$。代入 $dp = (E/p)dE$：\n$$N(E)dE \\propto |M_{fi}|^2 p^2 (E/p) (E_0-E)^2 dE = |M_{fi}|^2 p E (E_0-E)^2 dE$$\n最后，我们必须考虑发射的电子（电荷 $-e$）与子核（电荷 $+Ze$）之间的库仑相互作用。这是通过将能谱乘以费米函数 $F(Z,E)$ 来完成的，该函数修正了原子核处的电子波函数密度。对于允许跃迁，得到的电子能谱形状为：\n$$N(E) \\propto p\\, E\\, (E_0 - E)^2 F(Z,E)$$\n这完成了推导的第一部分。\n\n**2. 居里图**\n\n居里图是用于分析$\\beta$谱并确定终点能量 $E_0$ 的工具。居里变量 $K(E)$ 在问题中定义为：\n$$K(E) \\equiv \\sqrt{\\frac{N(E)}{p\\,E\\,F(Z,E)}}$$\n设能谱的完整表达式为 $N(E) = C_{norm} \\cdot p\\,E\\,(E_0-E)^2 F(Z,E)$，其中 $C_{norm}$ 是一个归一化常数，包含了 $|M_{fi}|^2$ 及其他因子。将此代入 $K(E)$ 的定义中：\n$$K(E) = \\sqrt{\\frac{C_{norm} \\cdot p\\,E\\,(E_0-E)^2 F(Z,E)}{p\\,E\\,F(Z,E)}}$$\n$$K(E) = \\sqrt{C_{norm} (E_0-E)^2} = \\sqrt{C_{norm}} (E_0 - E)$$\n这个方程表明 $K(E)$ 是电子总能量 $E$ 的线性函数：\n$$K(E) = \\sqrt{C_{norm}} E_0 - \\sqrt{C_{norm}} E$$\n$K(E)$ 对 $E$ 的图是一条斜率为负的直线。与能量轴的交点（即 $K(E)=0$ 的地方）出现在 $E=E_0$ 处，这为从实验数据中直接确定终点能量提供了一种方法。\n\n### 计算实现\n\n该问题要求对每个测试用例实现三个计算任务。\n\n**1. 相空间积分 $I_0$**\n\n未归一化的相空间积分为：\n$$I_0 = \\int_{m_e}^{E_0} p\\,E\\,(E_0 - E)^2\\,F(Z, E)\\,dE$$\n被积函数是推导出的谱形因子。费米函数 $F(Z,E)$ 和动量 $p(E)$ 在积分下限 $E=m_e$（此时 $p=0$）处引入了数值计算上的挑战。通过将相空间因子中的 $p$ 与费米函数中 $1/p$ 的依赖项结合，可以使被积函数在数值积分时更加稳健。因子 $p \\cdot F(Z,E)$ 是：\n$$p \\cdot F(Z,E) = p \\cdot \\frac{2\\pi\\eta}{1 - e^{-2\\pi\\eta}} = p \\cdot \\frac{2\\pi(\\alpha Z E/p)}{1 - e^{-2\\pi\\eta}} = \\frac{2\\pi\\alpha Z E}{1 - e^{-2\\pi\\alpha Z E/p(E)}}$$\n当 $E \\to m_e^+$（因为 $p(E) \\to 0^+$）时，这个表达式是有限且行为良好的，其极限为 $2\\pi\\alpha Z m_e$。因此，$I_0$ 的被积函数实现为 $E(E_0-E)^2$ 乘以这个数值稳定的形式。该积分使用 `scipy.integrate.quad` 函数计算，这是一种适用于此类问题的高精度自适应求积方法。\n\n**2. 平均电子动能 $\\langle T \\rangle$**\n\n首先，计算归一化常数 $C = 1/I_0$。电子能量的归一化概率分布为 $N(E) = C \\cdot p E (E_0 - E)^2 F(Z,E)$。然后通过积分计算平均动能 $T = E-m_e$：\n$$\\langle T \\rangle = \\int_{m_e}^{E_0} (E - m_e) N(E) dE = C \\int_{m_e}^{E_0} (E-m_e) p E (E_0-E)^2 F(Z,E) dE$$\n此表达式中的积分使用 `scipy.integrate.quad` 进行数值计算，采用与计算 $I_0$ 时相同的稳定被积函数公式，但额外增加了一个因子 $(E-m_e)$。\n\n**3. 居里图终点能量估计 $\\widehat{E}_0$**\n\n使用归一化能谱 $N(E)$ 来构造居里图变量 $K(E)$。根据我们的推导，$K(E) = \\sqrt{C} (E_0-E)$，其中 $C = 1/I_0$。在开区间 $(m_e, E_0)$ 上生成一个至少包含400个能量点的精细网格。使用一个小的偏移量以避免 $p=0$ 处的任何潜在浮点问题，尽管代数简化使其变得稳健。对于网格上的每个能量 $E_i$，计算相应的 $K_i = \\sqrt{C}(E_0 - E_i)$ 值。\n使用线性最小二乘回归，将线性模型 $K(E) = a + bE$ 拟合到生成的数据点 $(E_i, K_i)$，为此使用了 `numpy.polyfit`。拟合得到的斜率和截距分别表示为 $b$ 和 $a$。根据线性方程，通过设置 $K(E)=0$ 来找到x轴截距，从而得到估计的终点能量 $\\widehat{E}_0 = -a/b$。由于基础模型的精确线性性，预计此计算将以高精度恢复输入的 $E_0$。",
            "answer": "```python\nimport numpy as np\nfrom scipy import integrate\n\n# GLOBAL CONSTANTS (as required by the problem)\n# Electron mass in MeV\nM_E = 0.51099895\n# Fine-structure constant\nALPHA = 1 / 137.035999084\n\ndef calculate_p_times_fermi(E, Z, me, alpha):\n    \"\"\"\n    Calculates the numerically stable product p * F(Z, E).\n    p * F(Z,E) = (2 * pi * alpha * Z * E) / (1 - exp(-2 * pi * alpha * Z * E / p))\n    This form avoids the p/p cancellation issue near E=me.\n    This function is designed to work with scalar E, as expected by scipy.quad.\n    \"\"\"\n    if E == me:\n        return 0.0\n\n    p_val = np.sqrt((E - me) * (E + me))\n    \n    # The limit as E -> me (p -> 0) is finite.\n    if p_val == 0.0:\n        return 2 * np.pi * alpha * Z * me\n\n    exp_arg = -2 * np.pi * alpha * Z * E / p_val\n    \n    # Handle underflow for large negative arguments to exp\n    if exp_arg  -709:  # Below this, np.exp underflows to 0.0\n        denominator = 1.0\n    else:\n        denominator = 1.0 - np.exp(exp_arg)\n        \n    numerator = 2 * np.pi * alpha * Z * E\n    \n    return numerator / denominator\n\ndef integrand_for_i0(E, Z, E0, me, alpha):\n    \"\"\"The integrand for the I_0 integral: E * (E0-E)^2 * (p*F)\"\"\"\n    if E = me or E >= E0:\n        return 0.0\n    pf_val = calculate_p_times_fermi(E, Z, me, alpha)\n    return E * (E0 - E)**2 * pf_val\n\ndef integrand_for_mean_t(E, Z, E0, me, alpha):\n    \"\"\"The integrand for the numerator of the\"\"\"\n```"
        },
        {
            "introduction": "虽然相空间决定了能谱的 *形状*，但总的衰变 *速率* 则由核结构决定，具体来说，是由初始和最终核态之间的重叠决定的。这项练习  提供了一种动手实践的方法，使用简化的壳模型波函数（旋量）来计算基本的费米和伽莫夫-泰勒矩阵元。然后，你将把它们与相空间因子结合起来，预测可观测的衰变速率和分支比。",
            "id": "3559156",
            "problem": "要求您设计并实现一个完整的计算流程。该流程从壳模型波函数出发，计算矢量（费米）和轴矢量（伽莫夫-泰勒）通道的容许β衰变核矩阵元，在容许近似下评估相空间积分，并利用费米理论预测多个衰变通道的分支衰变率、总衰变率和分支比。程序必须完全自洽，并为指定的测试组产生数值输出。\n\n请从适用于弱核β衰变的基本理论出发：使用费米黄金定则和带有单体核算符的有效低能四费米子哈密顿量。在容许近似下，强子流简化为两个主要贡献：费米算符和伽莫夫-泰勒算符。对于一个从初始核态到末态的跃迁，如果这两个态仅在同位旋和自旋量子数上有所不同（这符合容许β衰变的条件），则核矩阵元定义为\n$$\nM_\\mathrm{F} \\equiv \\langle f \\Vert \\sum_{n} \\tau^{(+)}(n) \\Vert i \\rangle,\\quad\n\\vec{M}_\\mathrm{GT} \\equiv \\langle f \\Vert \\sum_{n} \\vec{\\sigma}(n)\\,\\tau^{(+)}(n) \\Vert i \\rangle,\n$$\n其中 $\\tau^{(+)}$ 是同位旋升算符，$\\vec{\\sigma}$ 是作用于核子 $n$ 的泡利自旋算符。在一个简化的计算模型中，假设衰变主要由单个价核子主导，并通过将同位旋变化视为容许并关注自旋空间交叠，从壳模型波函数的旋量分量计算这些矩阵元。将初始和末态的自旋波函数表示为归一化双分量复旋量，\n$$\n\\vert i \\rangle \\equiv \\begin{pmatrix} c_{i,\\uparrow} \\\\ c_{i,\\downarrow} \\end{pmatrix},\\quad\n\\vert f \\rangle \\equiv \\begin{pmatrix} c_{f,\\uparrow} \\\\ c_{f,\\downarrow} \\end{pmatrix},\n$$\n满足 $\\sum_{s\\in\\{\\uparrow,\\downarrow\\}} |c_{i,s}|^2 = \\sum_{s} |c_{f,s}|^2 = 1$。在这种单粒子简化下，计算\n$$\nM_\\mathrm{F} = \\langle f \\vert i \\rangle = c_{f,\\uparrow}^*\\,c_{i,\\uparrow} + c_{f,\\downarrow}^*\\,c_{i,\\downarrow},\n$$\n以及\n$$\n\\vec{M}_\\mathrm{GT} = \\big(\\langle f \\vert \\sigma_x \\vert i \\rangle,\\ \\langle f \\vert \\sigma_y \\vert i \\rangle,\\ \\langle f \\vert \\sigma_z \\vert i \\rangle\\big),\n$$\n使用泡利矩阵 $\\sigma_x$, $\\sigma_y$, $\\sigma_z$。使用模方 $|M_\\mathrm{F}|^2$ 和 $|\\vec{M}_\\mathrm{GT}|^2 \\equiv \\sum_{k=x,y,z} |\\langle f \\vert \\sigma_k \\vert i \\rangle|^2$ 作为进入衰变率计算的核因子。\n\n在β⁻衰变的容许近似范围内，并忽略反冲和辐射修正，微分衰变率与一个相空间因子成正比。该因子涉及电子总能量 $E$、电子动量 $p=\\sqrt{E^2-m_e^2}$、端点能量 $E_0=Q+m_e$（其中 $Q$ 是核的Q值，表示可用于轻子的能量），以及费米函数 $F(Z,E)$，该函数编码了电荷数为 $Z$ 的子核所产生的库仑畸变：\n$$\n\\text{integrand}(E; Z, Q) \\propto p\\,E\\,(E_0 - E)^2\\,F(Z,E).\n$$\n对β⁻衰变中的费米函数使用标准近似，\n$$\nF(Z,E) \\approx \\frac{2\\pi\\eta}{1-e^{-2\\pi\\eta}},\\quad \\eta = \\alpha\\,Z\\,\\frac{E}{p},\n$$\n其中 $\\alpha$ 是精细结构常数。相空间积分在 $E \\in [m_e, E_0]$ 区间上进行，其结果是一个具有能量五次方量纲的量。将其与费米常数的平方以及相应的耦合常数结合，以获得分支衰变率。将矢量耦合 $g_V$ 和轴矢量耦合 $g_A$ 视为常数。在轻子耦合中包含上下夸克对应的Cabibbo–Kobayashi–Maskawa矩阵元 $V_{ud}$。所有常数必须使用一致的单位，最终总衰变率必须以 $\\mathrm{s}^{-1}$ 表示，并作为标准浮点值四舍五入到机器精度。\n\n您的任务：\n\n- 对每个衰变通道，根据提供的初始态和末态的壳模型旋量，实现 $|M_\\mathrm{F}|^2$ 和 $|\\vec{M}_\\mathrm{GT}|^2$ 的计算。\n- 对每个通道，使用给定的Q值和子核电荷数，以及上述定义的费米函数近似，数值评估相空间积分。按规定使用电子静止质量 $m_e$ 和端点能量 $E_0=Q+m_e$。\n- 使用费米理论计算费米和伽莫夫-泰勒分量的分支衰变率，然后将两者相加得到每个通道的总分支衰变率。对所有通道求和得到原子核的总衰变率。计算每个通道的分支比，即该通道的总分支衰变率与总衰变率之比。\n- 物理单位：能量以 $\\mathrm{MeV}$ 表示，$\\alpha$ 为无量纲量，最终总衰变率以 $\\mathrm{s}^{-1}$ 为单位返回。分支比必须是 $[0,1]$ 范围内的十进制小数。\n- 角度单位说明：在测试组中，凡是使用三角函数定义旋量之处，所用角度均以弧度为单位。\n\n使用的常数（所有测试用例通用）：精细结构常数 $\\alpha = 1/137.035999084$，费米常数 $G_\\mathrm{F} = 1.1663787\\times 10^{-5}\\ \\mathrm{GeV}^{-2}$（需一致地转换为 $\\mathrm{MeV}^{-2}$），Cabibbo–Kobayashi–Maskawa矩阵元 $V_{ud}=0.97420$，电子质量 $m_e = 0.51099895\\ \\mathrm{MeV}$，约化普朗克常数 $\\hbar = 6.582119569\\times 10^{-22}\\ \\mathrm{MeV\\cdot s}$，矢量耦合 $g_V = 1.0$，轴矢量耦合 $g_A = 1.2723$。\n\n测试组：\n\n对于每个测试用例，都提供了母核电荷数 $Z_\\mathrm{parent}$、β⁻衰变的子核电荷数 $Z_\\mathrm{daughter}$（$Z_\\mathrm{daughter}=Z_\\mathrm{parent}+1$）、针对不同末态的Q值列表 $[Q_1,Q_2,\\dots]$（单位为 $\\mathrm{MeV}$），以及初始态和每个末态通道的壳模型旋量。所有旋量都已归一化，以下角度均以弧度为单位。\n\n- 测试用例1（费米和伽莫夫-泰勒混合，中等Z值）：\n  - 母核电荷数 $Z_\\mathrm{parent} = 20$，因此 $Z_\\mathrm{daughter}=21$。\n  - Q值：$[3.5,\\ 2.0,\\ 1.0]\\ \\mathrm{MeV}$。\n  - 初始旋量：$\\vert i \\rangle = \\big(\\sqrt{0.6},\\ i\\sqrt{0.4}\\big)$。\n  - 各通道的末态旋量：\n    - 通道1：$\\vert f_1 \\rangle = \\big(\\sqrt{0.5},\\ \\sqrt{0.5}\\big)$。\n    - 通道2：$\\vert f_2 \\rangle = \\big(\\sqrt{0.8},\\ -i\\sqrt{0.2}\\big)$。\n    - 通道3：$\\vert f_3 \\rangle = \\big(\\sqrt{0.3},\\ \\sqrt{0.7}\\big)$。\n\n- 测试用例2（因旋量不匹配导致伽莫夫-泰勒被抑制，低Z值）：\n  - 母核电荷数 $Z_\\mathrm{parent} = 10$，因此 $Z_\\mathrm{daughter}=11$。\n  - Q值：$[2.5,\\ 1.2]\\ \\mathrm{MeV}$。\n  - 初始旋量：$\\vert i \\rangle = \\big(\\cos(0.15),\\ \\sin(0.15)\\big)$。\n  - 各通道的末态旋量：\n    - 通道1：$\\vert f_1 \\rangle = \\big(\\cos(0.10),\\ i\\sin(0.10)\\big)$。\n    - 通道2：$\\vert f_2 \\rangle = \\big(\\cos(0.70),\\ \\sin(0.70)\\big)$。\n\n- 测试用例3（高Z值库仑效应及近阈值分支）：\n  - 母核电荷数 $Z_\\mathrm{parent} = 52$，因此 $Z_\\mathrm{daughter}=53$。\n  - Q值：$[4.0,\\ 0.3]\\ \\mathrm{MeV}$。\n  - 初始旋量：$\\vert i \\rangle = \\big(\\sqrt{0.55},\\ e^{i\\,0.3}\\sqrt{0.45}\\big)$。\n  - 各通道的末态旋量：\n    - 通道1：$\\vert f_1 \\rangle = \\big(e^{i\\,0.2}\\sqrt{0.60},\\ \\sqrt{0.40}\\big)$。\n    - 通道2：$\\vert f_2 \\rangle = \\big(\\sqrt{0.20},\\ e^{i\\,0.5}\\sqrt{0.80}\\big)$。\n\n要求的最终输出格式：\n\n您的程序必须处理所有三个测试用例，并生成单行输出。该输出包含一个含三个子列表的列表，每个子列表对应一个测试用例。每个子列表必须包含以 $\\mathrm{s}^{-1}$ 为单位的总衰变率，其后是该测试用例中每个通道的分支比，顺序与提供的Q值顺序一致。输出必须严格为以下格式的单行文本\n$$\n[\\,[\\lambda_\\mathrm{tot}^{(1)},\\,\\mathrm{BR}_1^{(1)},\\,\\mathrm{BR}_2^{(1)},\\,\\mathrm{BR}_3^{(1)}],\\ [\\lambda_\\mathrm{tot}^{(2)},\\,\\mathrm{BR}_1^{(2)},\\,\\mathrm{BR}_2^{(2)}],\\ [\\lambda_\\mathrm{tot}^{(3)},\\,\\mathrm{BR}_1^{(3)},\\,\\mathrm{BR}_2^{(3)}]\\,],\n$$\n不含任何额外文本。所有数值必须是标准的十进制浮点数。",
            "solution": "用户提供了一个关于计算β衰变率的明确定义的计算物理问题。该问题陈述已经过验证，被认为是科学上合理、内容自洽且定义良好的。它要求基于费米容许β衰变理论实现一个计算流程。我将按步骤进行求解。\n\n### 基于原理的设计\n\n解决方案将基于应用于核β衰变的弱相互作用物理学的基本原理进行设计，并使用问题陈述中要求的特定模型和近似。对于每个衰变通道，该计算流程可以分解为三个主要阶段：\n\n1.  **核矩阵元计算**：核跃迁动力学的核心由费米（矢量）和伽莫夫-泰勒（轴矢量）算符的核矩阵元捕获。按照规定，该问题将复杂的多体核态简化为单粒子双分量旋量。矩阵元即为初始和末态旋量之间的交叠，其中伽莫夫-泰勒部分涉及泡利自旋矩阵 $\\vec{\\sigma}$ 的插入。\n    - 初始和末态旋量 $\\vert i \\rangle$ 和 $\\vert f \\rangle$ 表示为复数的 $2 \\times 1$ 列向量。在Python中，它们将作为 `dtype=complex` 的NumPy数组实现。\n    - 费米矩阵元为 $M_{\\mathrm{F}} = \\langle f \\vert i \\rangle$。左矢 $\\langle f \\vert$ 是右矢 $\\vert f \\rangle$ 的共轭转置。用于衰变率计算的模方是 $|M_{\\mathrm{F}}|^2$。在计算上，这是向量点积的绝对值的平方，具体为 `np.vdot(f, i)`，它能正确处理第一个向量的共轭。\n    - 伽莫夫-泰勒矩阵元为 $\\vec{M}_{\\mathrm{GT}} = (\\langle f \\vert \\sigma_x \\vert i \\rangle, \\langle f \\vert \\sigma_y \\vert i \\rangle, \\langle f \\vert \\sigma_z \\vert i \\rangle)$。泡利矩阵 $\\sigma_k$ 将被定义为 $2 \\times 2$ 的复数NumPy数组。每个分量的计算涉及一个矩阵-向量乘积，然后是一个向量点积，例如 `np.vdot(f, sigma_x @ i)`。其模方是这三个分量绝对值平方的和：$|\\vec{M}_{\\mathrm{GT}}|^2 = \\sum_{k=x,y,z} |\\langle f \\vert \\sigma_k \\vert i \\rangle|^2$。\n\n2.  **相空间积分评估**：衰变率与发射出的轻子（电子和反中微子）的可用相空间成正比。这通过对电子能量 $E$ 的积分来量化。\n    - 我们记为 $f(Z, Q)$ 的相空间积分由下式给出：\n      $$ f(Z, Q) = \\int_{m_e}^{E_0} p E (E_0 - E)^2 F(Z, E) \\, dE $$\n      其中 $p = \\sqrt{E^2 - m_e^2}$ 是电子动量，$E_0 = Q + m_e$ 是端点能量，而 $F(Z, E)$ 是费米函数。所有能量（$E, m_e, Q, E_0$）都以 $\\mathrm{MeV}$ 为单位。\n    - 费米函数 $F(Z, E)$ 描述了发射出的电子与电荷为 $Z$ 的子核之间的库仑相互作用。指定的近似为：\n      $$ F(Z,E) \\approx \\frac{2\\pi\\eta}{1-e^{-2\\pi\\eta}} \\quad \\text{with} \\quad \\eta = \\alpha Z \\frac{E}{p} $$\n      该积分没有简单的解析闭合形式，必须进行数值评估。`scipy.integrate.quad` 函数是完成此任务的理想选择，因为它为数值积分提供了一种稳健而准确的方法。被积函数是良态的，在积分下限 $E=m_e$（此时 $p=0$）处为有限值。\n\n3.  **衰变率和分支比计算**：最后一步是将核矩阵元和相空间因子与基本常数结合起来，以计算衰变率。\n    - 根据费米黄金定则，单个通道的分支衰变率 $\\lambda_{\\text{channel}}$ 由下式给出：\n      $$ \\lambda_{\\text{channel}} = \\frac{(G_\\mathrm{F} V_{ud})^2}{2\\pi^3\\hbar} \\left( g_V^2 |M_\\mathrm{F}|^2 + g_A^2 |\\vec{M}_\\mathrm{GT}|^2 \\right) f(Z, Q) $$\n      所有常数（$G_\\mathrm{F}, V_{ud}, \\hbar, g_V, g_A$）均已提供。必须注意确保单位一致。当 $G_\\mathrm{F}$ 的单位为 $\\mathrm{MeV}^{-2}$，$\\hbar$ 的单位为 $\\mathrm{MeV} \\cdot \\mathrm{s}$，积分 $f(Z,Q)$ 的单位为 $\\mathrm{MeV}^5$ 时，得到的衰变率 $\\lambda$ 的单位将是 $\\mathrm{s}^{-1}$，符合要求。\n    - 母核的总衰变率 $\\lambda_{\\text{tot}}$ 是所有可能衰变通道的分支衰变率之和：$\\lambda_{\\text{tot}} = \\sum_j \\lambda_{\\text{channel}, j}$。\n    - 特定通道 $j$ 的分支比是通过该通道进行的总衰变所占的比例：$\\mathrm{BR}_j = \\lambda_{\\text{channel}, j} / \\lambda_{\\text{tot}}$。\n\n总体算法将通过遍历每个测试用例指定的衰变通道来处理它们。对每个通道，它将计算 $|M_\\mathrm{F}|^2$、 $|\\vec{M}_\\mathrm{GT}|^2$ 和 $f(Z, Q)$，并组合它们以求得分支衰变率。在处理完给定原子核的所有通道后，计算并存储总衰变率和分支比。最终输出将格式化为列表的列表，遵循指定的结构。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import integrate\n\ndef solve():\n    \"\"\"\n    Computes beta-decay rates and branching ratios based on Fermi's theory.\n    \"\"\"\n\n    # Physical Constants based on problem statement\n    # Fine-structure constant\n    ALPHA = 1 / 137.035999084\n    # Fermi constant in GeV^-2\n    G_F_GEV = 1.1663787e-5\n    # Converted Fermi constant to MeV^-2 (1 GeV = 1000 MeV)\n    G_F = G_F_GEV * 1e-6\n    # CKM matrix element\n    V_UD = 0.97420\n    # Electron rest mass in MeV\n    M_E = 0.51099895\n    # Reduced Planck constant in MeV*s\n    HBAR = 6.582119569e-22\n    # Vector and axial-vector coupling constants\n    G_V = 1.0\n    G_A = 1.2723\n\n    # Pauli matrices\n    SIGMA_X = np.array([[0, 1], [1, 0]], dtype=complex)\n    SIGMA_Y = np.array([[0, -1j], [1j, 0]], dtype=complex)\n    SIGMA_Z = np.array([[1, 0], [0, -1]], dtype=complex)\n\n    # Pre-calculated constant factor for the decay rate lambda\n    # lambda = RATE_PREFACTOR * (g_V^2 |M_F|^2 + g_A^2 |M_GT|^2) * f(Z, Q)\n    RATE_PREFACTOR = (G_F * V_UD)**2 / (2 * np.pi**3 * HBAR)\n\n    def calculate_nuclear_matrix_elements(spinor_i, spinor_f):\n        \"\"\"\n        Computes the squared magnitudes of the Fermi and Gamow-Teller matrix elements.\n        \"\"\"\n        # Fermi matrix element: M_F =\n```"
        },
        {
            "introduction": "许多重要的 β 衰变在所谓的“允许近似”下是被“禁戒”的，这意味着它们的能谱形状偏离了标准形式。这项练习  深入探讨了这些被称为“独特禁戒跃迁”的衰变，其能谱形状由一个“形状因子”描述。你将模拟生成合成的实验数据，然后运用最大似然法——这是现代数据科学的基石——从能谱形状中推断出跃迁的多极阶次，从而揭示其背后的物理机制。",
            "id": "3559165",
            "problem": "您需要实现一个完整的程序，该程序使用费米（Fermi）的β衰变理论为唯一禁戒跃迁（其中干涉项消失）生成合成数据集，然后通过对能量依赖性进行拟合来恢复多极阶。该问题以纯数学和算法的形式进行阐述，并给出了明确的物理背景，所有物理量都必须进行一致性处理。使用自然单位制，$c = \\hbar = 1$，因此能量和动量共享相同单位。所有能量必须以兆电子伏特（MeV）表示，所有动量也以兆电子伏特（MeV）表示。电子的静止质量为 $m_e = 0.511\\,\\mathrm{MeV}$，精细结构常数为 $\\alpha = 1/137.036$。\n\n从费米β衰变的基本理论出发，对于电子总能量为 $E$（包括静止质量）的β-衰变，其微分谱具有以下通用形式\n$$\n\\frac{dN}{dE} \\propto F(Z,E)\\, p\\, E\\, (E_0 - E)^2\\, C(E),\n$$\n其中 $Z$ 是子核的电荷数，$E_0$ 是电子的终点能，$p = \\sqrt{E^2 - m_e^2}$ 是电子动量，$E_0 - E$ 是在中微子质量为零的极限下的中微子能量，$F(Z,E)$ 是库仑修正（费米函数）。在对中等 $Z$ 和相对论性轻子有效的领头近似下，取\n$$\nF(Z,E) = \\frac{2\\pi \\eta}{1 - e^{-2\\pi \\eta}}, \\quad \\eta = \\frac{\\alpha Z E}{p}.\n$$\n考虑多极阶为 $L \\in \\{1,2,3\\}$ 的唯一禁戒跃迁，对于此类跃迁，不同核矩阵元之间的干涉消失。在费米理论对轻子运动学的长波极限下，将形状因子建模为\n$$\nC_L(E) = p^{2L} + q^{2L}, \\quad q = E_0 - E,\n$$\n这样能量依赖性就由单一的多极阶 $L$ 决定，而没有交叉项干涉。假设中微子质量为零并忽略反冲。\n\n您的程序必须：\n- 在从 $E_{\\min} = m_e + \\delta$ 到 $E_{\\max} = E_0 - \\delta$ 的均匀能量网格上构建分箱能谱，其中 $E_0 = m_e + Q$，$Q$ 是衰变的 $Q$ 值，$\\delta$ 是一个小的排除边际，以避免端点处的奇异性。使用 $\\delta = 10^{-6}\\,\\mathrm{MeV}$。\n- 对于每个箱的中心 $E_i$，计算未归一化的谱权重\n$$\nw_i = F(Z,E_i)\\, p_i\\, E_i\\, (E_0 - E_i)^2\\, C_L(E_i),\n$$\n其中 $p_i = \\sqrt{E_i^2 - m_e^2}$ 且 $C_L(E_i)$ 如上所示。\n- 归一化权重，使得预期的总计数等于预设的 $N_{\\mathrm{tot}}$，并从均值为 $\\lambda_i = A\\, w_i$ 的泊松分布中抽取合成计数 $y_i$，其中 $A$ 是为满足 $\\sum_i \\lambda_i = N_{\\mathrm{tot}}$ 而选择的总归一化系数。使用固定的随机种子以保证可复现性。\n- 对于模型选择，将计数视为独立的泊松分布。对于每个候选多极阶 $L \\in \\{1,2,3\\}$，在相同的能量网格上计算相应的理论权重 $\\tilde{w}_i^{(L)}$，在泊松模型下估计最大似然归一化系数 $\\hat{A}^{(L)}$，并评估负对数似然\n$$\n\\mathcal{L}^{(L)} = \\sum_i \\left(\\hat{\\lambda}_i^{(L)} - y_i \\ln \\hat{\\lambda}_i^{(L)}\\right),\n$$\n其中 $\\hat{\\lambda}_i^{(L)} = \\hat{A}^{(L)} \\tilde{w}_i^{(L)}$，且 $y_i = 0$ 的箱只贡献 $\\hat{\\lambda}_i^{(L)}$ 项。选择使 $\\mathcal{L}^{(L)}$ 最小的 $L$。\n\n为以下测试套件实现上述过程，涵盖不同的机制和边界条件：\n- 用例 1：$Z = 30$，$Q = 3.5\\,\\mathrm{MeV}$，$L_{\\mathrm{true}} = 1$，$N_{\\mathrm{tot}} = 100000$，$n_{\\mathrm{bins}} = 80$。\n- 用例 2：$Z = 10$，$Q = 1.0\\,\\mathrm{MeV}$，$L_{\\mathrm{true}} = 2$，$N_{\\mathrm{tot}} = 50000$，$n_{\\mathrm{bins}} = 60$。\n- 用例 3：$Z = 50$，$Q = 6.0\\,\\mathrm{MeV}$，$L_{\\mathrm{true}} = 3$，$N_{\\mathrm{tot}} = 200000$，$n_{\\mathrm{bins}} = 100$。\n- 用例 4（近阈值）：$Z = 5$，$Q = 0.2\\,\\mathrm{MeV}$，$L_{\\mathrm{true}} = 1$，$N_{\\mathrm{tot}} = 50000$，$n_{\\mathrm{bins}} = 50$。\n- 用例 5（低统计量）：$Z = 20$，$Q = 2.0\\,\\mathrm{MeV}$，$L_{\\mathrm{true}} = 2$，$N_{\\mathrm{tot}} = 5000$，$n_{\\mathrm{bins}} = 80$。\n\n您的程序应生成一行输出，其中包含所有用例按顺序推断出的多极阶，格式为方括号内以逗号分隔的列表。例如，输出格式必须与以下完全一样\n$$\n[\\ell_1,\\ell_2,\\ell_3,\\ell_4,\\ell_5],\n$$\n其中每个 $\\ell_k$ 是用例 $k$ 的 $L$ 的整数估计值。",
            "solution": "构建和推断过程遵循费米（Fermi）的β衰变理论和标准统计建模。我们从 Enrico Fermi 的基本β谱公式开始，对于β-衰变，在零中微子质量、无反冲、平面波近似下，该公式为\n$$\n\\frac{dN}{dE} \\propto F(Z,E)\\, p\\, E\\, (E_0 - E)^2\\, C(E),\n$$\n其中 $E$ 是电子总能量（包括静止质量），$p = \\sqrt{E^2 - m_e^2}$ 是电子动量，$E_0$ 是电子终点能。当忽略中微子质量时，因子 $(E_0 - E)^2$ 来自中微子的相空间。库仑修正 $F(Z,E)$，称为费米函数，用于解释出射电子与核电荷 $Z$ 之间的相互作用。在对中等 $Z$ 和相对论性电子广泛使用的近似中，\n$$\nF(Z,E) = \\frac{2\\pi \\eta}{1 - e^{-2\\pi \\eta}}, \\quad \\eta = \\frac{\\alpha Z E}{p},\n$$\n其中 $\\alpha$ 是精细结构常数。\n\n对于多极阶为 $L$ 的唯一禁戒跃迁，只有一个核算符对谱有贡献，不同算符之间的干涉项消失。在轻子运动学的长波极限下，形状因子被建模为\n$$\nC_L(E) = p^{2L} + q^{2L}, \\quad q = E_0 - E,\n$$\n该模型通过轻子动量 $p$ 和 $q$ 捕捉了唯一跃迁的特征性能量依赖性。终点能满足 $E_0 = m_e + Q$，其中 $Q$ 是释放给轻子的衰变能。\n\n为了生成合成数据，我们在 $[E_{\\min}, E_{\\max}]$ 上对能量进行均匀离散化，其中 $E_{\\min} = m_e + \\delta$ 和 $E_{\\max} = E_0 - \\delta$，并使用一个小的边际 $\\delta$ 以避免在端点处的奇异行为。在每个箱的中心 $E_i$ 处，我们计算\n$$\nw_i = F(Z,E_i)\\, p_i\\, E_i\\, (E_0 - E_i)^2\\, C_L(E_i), \\quad p_i = \\sqrt{E_i^2 - m_e^2},\n$$\n它提供了该箱中未归一化的期望谱权重。然后我们选择一个归一化系数 $A$，使得期望的总计数等于指定的 $N_{\\mathrm{tot}}$：\n$$\nA = \\frac{N_{\\mathrm{tot}}}{\\sum_i w_i}, \\quad \\lambda_i = A\\, w_i.\n$$\n观测值 $y_i$ 从均值为 $\\lambda_i$ 的泊松分布中独立抽取，这与核实验中的计数统计一致。\n\n为了推断 $L$，我们采用最大似然估计（MLE）。在泊松模型下，给定候选的 $L$ 和相应的理论权重 $\\tilde{w}_i^{(L)}$，对于计数 $\\{y_i\\}$ 的似然函数为\n$$\n\\mathcal{L}(\\{y_i\\}\\,|\\,A,L) = \\prod_i \\frac{(A\\, \\tilde{w}_i^{(L)})^{y_i} e^{-A\\, \\tilde{w}_i^{(L)}}}{y_i!}.\n$$\n对数似然函数为\n$$\n\\ln \\mathcal{L}(A,L) = \\sum_i \\left(y_i \\ln (A\\, \\tilde{w}_i^{(L)}) - A\\, \\tilde{w}_i^{(L)} - \\ln(y_i!)\\right).\n$$\n关于 $A$ 进行最大化可得\n$$\n\\hat{A}^{(L)} = \\frac{\\sum_i y_i}{\\sum_i \\tilde{w}_i^{(L)}},\n$$\n这是已知形状的标准MLE归一化。将 $\\hat{A}^{(L)}$ 代回，并忽略不依赖于 $L$ 的常数项 $\\sum_i \\ln(y_i!)$，我们最小化负对数似然\n$$\n\\mathcal{L}^{(L)} = \\sum_i \\left(\\hat{\\lambda}_i^{(L)} - y_i \\ln \\hat{\\lambda}_i^{(L)}\\right), \\quad \\hat{\\lambda}_i^{(L)} = \\hat{A}^{(L)} \\tilde{w}_i^{(L)}.\n$$\n由于 $y_i \\ln \\hat{\\lambda}_i^{(L)}$ 为零，所以 $y_i = 0$ 的箱只贡献 $\\hat{\\lambda}_i^{(L)}$。我们选择使 $\\mathcal{L}^{(L)}$ 最小化的 $L \\in \\{1,2,3\\}$。\n\n算法步骤：\n- 固定常数 $m_e = 0.511\\,\\mathrm{MeV}$、$\\alpha = 1/137.036$ 和边际 $\\delta = 10^{-6}\\,\\mathrm{MeV}$。\n- 对于每个测试用例 $(Z, Q, L_{\\mathrm{true}}, N_{\\mathrm{tot}}, n_{\\mathrm{bins}})$：\n  - 计算 $E_0 = m_e + Q$ 并定义一个从 $E_{\\min}$ 到 $E_{\\max}$ 的包含 $n_{\\mathrm{bins}}$ 个点的均匀网格。\n  - 使用上述公式计算 $L_{\\mathrm{true}}$ 对应的 $p_i$、$q_i$、$F(Z,E_i)$ 和 $w_i$，并使用固定的随机种子生成泊松计数，其中 $\\sum_i \\lambda_i = N_{\\mathrm{tot}}$。\n  - 对于每个候选 $L \\in \\{1,2,3\\}$，计算 $\\tilde{w}_i^{(L)}$、$\\hat{A}^{(L)}$、$\\hat{\\lambda}_i^{(L)}$ 和 $\\mathcal{L}^{(L)}$。\n  - 选择使 $\\mathcal{L}^{(L)}$ 最小化的 $L$ 作为恢复的多极阶。\n- 按用例顺序汇总恢复的阶数，并以 $[\\ell_1,\\ell_2,\\ell_3,\\ell_4,\\ell_5]$ 的格式打印单行输出。\n\n这个过程测试了不同的区域：中等 $Z$ 和大 $Q$ 值且高统计量（用例1）、较低 $Q$ 值（用例2）、较大 $Z$ 和 $Q$ 值下的强库仑修正（用例3）、近阈值运动学（用例4）以及低统计量条件（用例5）。使用指定的种子和模型，拟合应能通过嵌入在 $C_L(E)$ 中并经由费米函数和相空间因子滤波的特征性能量依赖性，正确识别出唯一禁戒多极阶。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\n# Constants in natural units (c = ħ = 1)\nME = 0.511  # MeV, electron rest mass\nALPHA = 1.0 / 137.036  # fine-structure constant\nDELTA = 1e-6  # MeV, endpoint exclusion margin for numerical stability\nPI = np.pi\n\nrng = np.random.default_rng(seed=123456789)  # fixed seed for reproducibility\n\n\ndef fermi_function(Z: int, E: np.ndarray, p: np.ndarray) -> np.ndarray:\n    \"\"\"\n    Leading-order Fermi function approximation:\n    F(Z,E) = 2*pi*eta / (1 - exp(-2*pi*eta)),  eta = alpha*Z*E/p.\n    Clip p away from zero to avoid division issues at endpoints.\n    \"\"\"\n    p_safe = np.clip(p, 1e-15, None)\n    eta = ALPHA * Z * E / p_safe\n    # Avoid overflow in exp for large eta by clipping\n    x = 2.0 * PI * eta\n    # Use stable computation for 1 - exp(-x)\n    denom = 1.0 - np.exp(-np.clip(x, None, 700.0))\n    # Ensure denom is not zero\n    denom = np.where(denom == 0.0, np.finfo(float).tiny, denom)\n    F = x / denom\n    return F\n\n\ndef shape_factor_unique(L: int, p: np.ndarray, q: np.ndarray) -> np.ndarray:\n    \"\"\"\n    Unique forbidden shape factor (long-wavelength lepton kinematics):\n    C_L(E) = p^{2L} + q^{2L}\n    \"\"\"\n    return np.power(p, 2 * L) + np.power(q, 2 * L)\n\n\ndef compute_energy_grid(E0: float, n_bins: int) -> np.ndarray:\n    \"\"\"\n    Uniform grid in E from E_min to E_max excluding endpoints by DELTA.\n    \"\"\"\n    Emin = ME + DELTA\n    Emax = E0 - DELTA\n    return np.linspace(Emin, Emax, n_bins)\n\n\ndef compute_weights(Z: int, Q: float, L: int, n_bins: int) -> tuple[np.ndarray, np.ndarray]:\n    \"\"\"\n    Compute energy grid and unnormalized spectral weights for given parameters.\n    Returns (E_grid, weights).\n    \"\"\"\n    E0 = ME + Q\n    E = compute_energy_grid(E0, n_bins)\n    p = np.sqrt(np.clip(E**2 - ME**2, 0.0, None))\n    q = E0 - E\n    F = fermi_function(Z, E, p)\n    C = shape_factor_unique(L, p, q)\n    w = F * p * E * (q**2) * C\n    # Clip weights to avoid zeros\n    w = np.clip(w, 1e-300, None)\n    return E, w\n\n\ndef simulate_counts(weights: np.ndarray, N_tot: int) -> np.ndarray:\n    \"\"\"\n    Normalize weights to N_tot and draw Poisson counts.\n    \"\"\"\n    total_w = np.sum(weights)\n    if not np.isfinite(total_w) or total_w == 0.0:\n        raise ValueError(\"Invalid total weight for simulation.\")\n    A = N_tot / total_w\n    lam = A * weights\n    y = rng.poisson(lam)\n    return y\n\n\ndef nll_poisson(y: np.ndarray, lam: np.ndarray) -> float:\n    \"\"\"\n    Negative log-likelihood for independent Poisson counts ignoring constant terms.\n    NLL = sum(lam - y * log(lam)), with convention y*log(lam)=0 for y=0.\n    \"\"\"\n    lam_safe = np.clip(lam, 1e-300, None)\n    term = lam_safe - y * np.log(lam_safe)\n    return float(np.sum(term))\n\n\ndef fit_multipole_order(Z: int, Q: float, y: np.ndarray, E: np.ndarray, candidate_Ls=(1, 2, 3)) -> int:\n    \"\"\"\n    Fit candidate multipole orders by minimizing Poisson NLL and return best L.\n    \"\"\"\n    best_L = candidate_Ls[0]\n    best_nll = np.inf\n    E0 = ME + Q\n    p = np.sqrt(np.clip(E**2 - ME**2, 0.0, None))\n    q = E0 - E\n    F = fermi_function(Z, E, p)\n\n    for L in candidate_Ls:\n        C = shape_factor_unique(L, p, q)\n        w = F * p * E * (q**2) * C\n        w = np.clip(w, 1e-300, None)\n        sum_w = np.sum(w)\n        if not np.isfinite(sum_w) or sum_w == 0.0:\n            nll = np.inf\n        else:\n            A_hat = np.sum(y) / sum_w\n            lam = A_hat * w\n            nll = nll_poisson(y, lam)\n        if nll  best_nll:\n            best_nll = nll\n            best_L = L\n    return best_L\n\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each case: (Z, Q [MeV], L_true, N_tot, n_bins)\n    test_cases = [\n        (30, 3.5, 1, 100000, 80),\n        (10, 1.0, 2, 50000, 60),\n        (50, 6.0, 3, 200000, 100),\n        (5, 0.2, 1, 50000, 50),\n        (20, 2.0, 2, 5000, 80),\n    ]\n\n    results = []\n    for Z, Q, L_true, N_tot, n_bins in test_cases:\n        # Generate synthetic data\n        E, w_true = compute_weights(Z, Q, L_true, n_bins)\n        y = simulate_counts(w_true, N_tot)\n        # Fit candidate L values\n        L_fit = fit_multipole_order(Z, Q, y, E, candidate_Ls=(1, 2, 3))\n        results.append(L_fit)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\n\nif __name__ == \"__main__\":\n    solve()\n```"
        }
    ]
}