{
    "hands_on_practices": [
        {
            "introduction": "在将理论付诸实践时，我们首先遇到的问题是如何处理粒子数投影算子中的连续积分。为了在计算机上进行计算，必须用离散求和来近似这个规范角积分。本练习探讨了这种离散化与离散傅里叶变换（DFT）之间的深刻联系，使我们能够确定精确解析粒子数分布而不产生混叠误差所需的最小离散点数，这是任何实际计算中至关重要的第一步。",
            "id": "3579450",
            "problem": "考虑一个破坏了粒子数对称性的Hartree-Fock-Bogoliubov (HFB) 平均场态。投影到粒子数为 $N$ 的扇区上的粒子数投影算符由规范角积分定义\n$$\n\\hat P_N = \\frac{1}{2\\pi} \\int_{0}^{2\\pi} d\\phi \\, e^{i\\phi(\\hat N - N)},\n$$\n其中 $\\hat N$ 是粒子数算符。对于一个普遍的平均场态 $\\lvert \\Phi \\rangle$，其对应的生成函数\n$$\nG(\\phi) \\equiv \\langle \\Phi \\lvert e^{i\\phi \\hat N} \\rvert \\Phi \\rangle\n$$\n在 $\\phi$ 上是 $2\\pi$ 周期的，并且态 $\\lvert \\Phi \\rangle$ 中粒子数为 $n$ 的概率分布可以通过傅里叶逆变换得到，\n$$\nw_n \\equiv \\langle \\Phi \\lvert \\hat P_n \\rvert \\Phi \\rangle = \\frac{1}{2\\pi} \\int_{0}^{2\\pi} d\\phi \\, e^{-i \\phi n} \\, G(\\phi).\n$$\n在计算中，规范角积分被离散的角度求积所取代。假设 $G(\\phi)$ 在傅里叶空间中是充分带限的，以至于其不可忽略的傅里叶分量 $w_n$ 位于一个连续的整数范围 $n \\in [N_{\\min}, N_{\\max}]$ 内，其跨度为 $L \\equiv N_{\\max} - N_{\\min} + 1$。要求你提出一种用于计算 $\\hat P_N$ 的离散求积方法，并通过诉诸采样后 $G(\\phi)$ 的离散傅里叶变换 (DFT) 来证明解析粒子数分布而不产生混叠所需的最小点数。\n\n哪个选项正确地陈述了一个使用等间距规范角和等权重的离散求积规则，并根据通过 DFT 可解析的最大粒子数范围给出了对求积点数的最小要求，包括对 $N_{\\min} = 116$ 和 $N_{\\max} = 128$ 情况的数值结果？\n\nA. 选择 $M$ 个点 $\\phi_m = \\dfrac{2\\pi m}{M}$（其中 $m = 0,1,\\dots,M-1$），权重相等为 $\\dfrac{1}{M}$，并要求 $M \\geq N_{\\max} - N_{\\min} + 1$ 以避免 $G(\\phi_m)$ 的 DFT 中出现混叠；对于 $N_{\\min} = 116$ 和 $N_{\\max} = 128$，最小的 $M$ 是 $13$。\n\nB. 选择 $M$ 个点 $\\phi_m = \\dfrac{2\\pi m}{M-1}$（其中 $m = 0,1,\\dots,M-1$），权重相等为 $\\dfrac{1}{M}$，并要求 $M \\geq N_{\\max}$ 以避免混叠；对于 $N_{\\min} = 116$ 和 $N_{\\max} = 128$，最小的 $M$ 是 $128$。\n\nC. 选择 $M$ 个点 $\\phi_m = \\dfrac{2\\pi (m + 1/2)}{M}$（其中 $m = 0,1,\\dots,M-1$），权重相等为 $\\dfrac{1}{M}$，并且 $M$ 可以是任意的，因为梯形法则对于周期性解析函数是精确的；对于 $N_{\\min} = 116$ 和 $N_{\\max} = 128$，任何 $M$ 都足够。\n\nD. 选择 $M$ 个点 $\\phi_m = \\dfrac{2\\pi m}{M}$（其中 $m = 0,1,\\dots,M-1$），权重为 $\\dfrac{2\\pi}{M}$，并要求 $M$ 是偶数以正确捕捉偶数粒子数宇称态；对于 $N_{\\min} = 116$ 和 $N_{\\max} = 128$，最小的偶数 $M$ 是 $14$。\n\nE. 选择 $M$ 个点 $\\phi_m = \\dfrac{2\\pi m}{M}$（其中 $m = 0,1,\\dots,M-1$），权重相等为 $\\dfrac{1}{M}$，并根据奈奎斯特准则要求 $M = 2\\big(N_{\\max} - N_{\\min}\\big) + 1$；对于 $N_{\\min} = 116$ 和 $N_{\\max} = 128$，最小的 $M$ 是 $25$。",
            "solution": "按如下方式对问题陈述进行严格验证。\n\n### 步骤1：提取已知条件\n- 粒子数投影算符为 $\\hat P_N = \\frac{1}{2\\pi} \\int_{0}^{2\\pi} d\\phi \\, e^{i\\phi(\\hat N - N)}$。\n- 平均场态为 $\\lvert \\Phi \\rangle$。\n- 生成函数为 $G(\\phi) \\equiv \\langle \\Phi \\lvert e^{i\\phi \\hat N} \\rvert \\Phi \\rangle$，它是 $2\\pi$ 周期的。\n- 粒子数为 $n$ 的概率分布为 $w_n \\equiv \\langle \\Phi \\lvert \\hat P_n \\rvert \\Phi \\rangle = \\frac{1}{2\\pi} \\int_{0}^{2\\pi} d\\phi \\, e^{-i \\phi n} \\, G(\\phi)$。\n- 假设：$G(\\phi)$ 不可忽略的傅里叶分量 $w_n$ 位于一个连续范围 $n \\in [N_{\\min}, N_{\\max}]$ 内。\n- 该范围的跨度为 $L \\equiv N_{\\max} - N_{\\min} + 1$。\n- 任务：为 $\\hat P_N$ 提出一种离散求积方法，并找出避免混叠所需的最小求积点数 $M$。\n- 具体案例：$N_{\\min} = 116$ 和 $N_{\\max} = 128$。\n\n### 步骤2：使用提取的已知条件进行验证\n- **科学依据：** 该问题描述了通过规范角积分进行粒子数投影。这在计算核物理和多体理论中是一种标准、成熟的方法，用于恢复在平均场层面（例如，在Hartree-Fock-Bogoliubov理论中）被破坏的对称性。使用傅里叶积分的数学表述是正确的。该问题在科学上是合理的。\n- **适定性：** 该问题要求计算一个带限周期函数的一组傅里叶系数所需的最小采样点数。这是一个信号处理中的经典问题，基于采样定理有唯一、明确的答案。该问题是适定的。\n- **客观性：** 该问题以精确的数学和物理语言陈述，没有任何主观性或歧义。\n\n### 步骤3：结论与行动\n问题陈述是**有效的**，因为它是科学合理的、适定的和客观的。继续进行求解。\n\n### 推导\n在态 $\\lvert \\Phi \\rangle$ 中找到 $n$ 个粒子的概率 $w_n$ 由以下积分给出\n$$\nw_n = \\frac{1}{2\\pi} \\int_{0}^{2\\pi} d\\phi \\, e^{-i \\phi n} \\, G(\\phi).\n$$\n这个表达式正是 $2\\pi$ 周期生成函数 $G(\\phi)$ 的傅里叶级数展开的第 $n$ 个系数的公式：\n$$\nG(\\phi) = \\sum_{k=-\\infty}^{\\infty} w_k e^{i k \\phi}.\n$$\n问题陈述指出 $G(\\phi)$ 是有效带限的，这意味着其傅里叶系数 $w_n$ 仅在整数范围 $[N_{\\min}, N_{\\max}]$ 内不可忽略。因此，该和可以近似为：\n$$\nG(\\phi) \\approx \\sum_{n=N_{\\min}}^{N_{\\max}} w_n e^{i n \\phi}.\n$$\n为了数值计算系数 $w_n$，我们将积分离散化。我们在 $M$ 个等间距点 $\\phi_m = \\frac{2\\pi m}{M}$（其中 $m = 0, 1, \\dots, M-1$）处对函数 $G(\\phi)$ 进行采样。令样本为 $g_m = G(\\phi_m)$。\n$w_n$ 的积分使用梯形法则近似，对于一个周期函数在其周期上的积分，该法则简化为一个等权重的和：\n$$\nw_n \\approx \\frac{1}{2\\pi} \\sum_{m=0}^{M-1} G(\\phi_m) e^{-i n \\phi_m} \\Delta\\phi,\n$$\n其中步长为 $\\Delta\\phi = \\frac{2\\pi}{M}$。代入 $\\phi_m$ 和 $\\Delta\\phi$：\n$$\nw_n \\approx \\frac{1}{2\\pi} \\sum_{m=0}^{M-1} g_m e^{-i n \\frac{2\\pi m}{M}} \\frac{2\\pi}{M} = \\frac{1}{M} \\sum_{m=0}^{M-1} g_m e^{-i n \\frac{2\\pi m}{M}}.\n$$\n这是序列 $\\{g_m\\}_{m=0}^{M-1}$ 的离散傅里叶变换 (DFT) 的定义，它产生一个近似系数序列 $\\{\\tilde{w}_k\\}_{k=0}^{M-1}$。让我们分析这种离散化的效果。计算出的系数 $\\tilde{w}_k$ 是：\n$$\n\\tilde{w}_k = \\frac{1}{M} \\sum_{m=0}^{M-1} G(\\phi_m) e^{-i k \\frac{2\\pi m}{M}} = \\frac{1}{M} \\sum_{m=0}^{M-1} \\left( \\sum_{n=N_{\\min}}^{N_{\\max}} w_n e^{i n \\frac{2\\pi m}{M}} \\right) e^{-i k \\frac{2\\pi m}{M}}.\n$$\n交换求和顺序：\n$$\n\\tilde{w}_k = \\sum_{n=N_{\\min}}^{N_{\\max}} w_n \\left( \\frac{1}{M} \\sum_{m=0}^{M-1} e^{i (n-k) \\frac{2\\pi m}{M}} \\right).\n$$\n括号中的项是单位根的离散和，如果 $n-k$ 是 $M$ 的整数倍（即 $n \\equiv k \\pmod M$），则其值为 $1$，否则为 $0$。因此，计算出的DFT系数 $\\tilde{w}_k$ 是所有真实傅里叶系数 $w_n$ 的和，这些系数的索引 $n$ 与 $k$ 模 $M$ 同余：\n$$\n\\tilde{w}_k = \\sum_{j=-\\infty}^{\\infty} w_{k+jM}.\n$$\n这种现象被称为混叠。为了避免混叠并恢复 $n \\in [N_{\\min}, N_{\\max}]$ 的真实系数 $w_n$，我们必须选择足够大的 $M$，使得在此范围内的任意两个不同索引 $n_1, n_2$ 模 $M$ 不同余。也就是说，对于所有 $n_1 \\neq n_2$ 且 $n_1, n_2 \\in [N_{\\min}, N_{\\max}]$，$n_1 \\not\\equiv n_2 \\pmod M$。\n这个条件等价于要求对于任何非零整数 $j$，$n_1 - n_2 \\neq jM$。差值 $|n_1 - n_2|$ 的大小最多为 $N_{\\max} - N_{\\min}$。为了防止任何非零差值成为 $M$ 的倍数，我们必须选择 $M$ 大于最大可能差值：\n$$\nM > N_{\\max} - N_{\\min}.\n$$\n或者，考虑我们信号支撑集中的不同整数索引的数量，即 $L = N_{\\max} - N_{\\min} + 1$。如果我们选择 $M  L$，那么根据鸽巢原理，集合 $\\{N_{\\min}, \\dots, N_{\\max}\\}$ 中至少有两个不同的索引必须映射到模 $M$ 的同一个值，从而导致混叠。因此，我们必须有 $M \\geq L$。\n满足此条件的 $M$ 的最小整数值为：\n$$\nM_{\\min} = L = N_{\\max} - N_{\\min} + 1.\n$$\n有了这个选择，对于任何 $n_1, n_2 \\in [N_{\\min}, N_{\\max}]$，如果 $n_1 \\equiv n_2 \\pmod{M_{\\min}}$，那么 $|n_1 - n_2|$ 必须是 $M_{\\min}$ 的倍数。但是 $|n_1 - n_2| \\leq N_{\\max} - N_{\\min} = M_{\\min} - 1$。量级小于 $M_{\\min}$ 的 $M_{\\min}$ 的唯一倍数是 $0$。因此，$n_1-n_2=0$，这意味着 $n_1=n_2$。在期望的分量之间不会发生混叠。\n\n投影算符 $\\hat P_N$ 的离散近似是\n$$\n\\hat P_N \\approx \\frac{1}{M} \\sum_{m=0}^{M-1} e^{i\\phi_m(\\hat N - N)} = \\frac{1}{M} \\sum_{m=0}^{M-1} e^{i\\frac{2\\pi m}{M}(\\hat N - N)}.\n$$\n这对应于一个求积规则，其点为 $\\phi_m = \\frac{2\\pi m}{M}$，权重相等为 $\\frac{1}{M}$。\n\n对于给定的具体情况，$N_{\\min} = 116$ 和 $N_{\\max} = 128$：\n最小求积点数为\n$$\nM_{\\min} = N_{\\max} - N_{\\min} + 1 = 128 - 116 + 1 = 12 + 1 = 13.\n$$\n\n### 逐项分析\n\n**A. 选择 $M$ 个点 $\\phi_m = \\dfrac{2\\pi m}{M}$（其中 $m = 0,1,\\dots,M-1$），权重相等为 $\\dfrac{1}{M}$，并要求 $M \\geq N_{\\max} - N_{\\min} + 1$ 以避免 $G(\\phi_m)$ 的 DFT 中出现混叠；对于 $N_{\\min} = 116$ 和 $N_{\\max} = 128$，最小的 $M$ 是 $13$。**\n- 点的选择对应于周期函数的标准DFT设置。\n- 权重 $\\frac{1}{M}$ 对于离散化算符 $\\hat P_N$ 是正确的，它来自于 $\\frac{1}{2\\pi}$ 的前置因子和梯形法则的步长 $\\Delta\\phi = \\frac{2\\pi}{M}$。\n- 条件 $M \\geq N_{\\max} - N_{\\min} + 1$ 正是我们为避免混叠而推导出的条件。\n- 对最小 $M$ 的计算得出 $128 - 116 + 1 = 13$，与陈述相符。\n- **结论：正确。**\n\n**B. 选择 $M$ 个点 $\\phi_m = \\dfrac{2\\pi m}{M-1}$（其中 $m = 0,1,\\dots,M-1$），权重相等为 $\\dfrac{1}{M}$，并要求 $M \\geq N_{\\max}$ 以避免混叠；对于 $N_{\\min} = 116$ 和 $N_{\\max} = 128$，最小的 $M$ 是 $128$。**\n- 点的选择 $\\phi_m = \\frac{2\\pi m}{M-1}$ 意味着 $\\phi_0 = 0$ 和 $\\phi_{M-1} = 2\\pi$。由于 $G(\\phi)$ 是周期的，$G(\\phi_0) = G(\\phi_{M-1})$，所以这个采样方案是冗余的，并且与标准的 $M$ 点 DFT 不符。\n- 要求 $M \\geq N_{\\max}$ 是不正确的。采样要求取决于带宽（$N_{\\max} - N_{\\min}$），而不是最大频率索引（$N_{\\max}$）。对于一个远离零点的带通信号，这个条件是严重过度的。\n- **结论：错误。**\n\n**C. 选择 $M$ 个点 $\\phi_m = \\dfrac{2\\pi (m + 1/2)}{M}$（其中 $m = 0,1,\\dots,M-1$），权重相等为 $\\dfrac{1}{M}$，并且 $M$ 可以是任意的，因为梯形法则对于周期性解析函数是精确的；对于 $N_{\\min} = 116$ 和 $N_{\\max} = 128$，任何 $M$ 都足够。**\n- 虽然中点法是一种有效的求积规则，但“$M$ 可以是任意的”这一说法是错误的。梯形法则（及相关规则）仅在点数足够多（例如，$M > 2K$）的情况下才对 $K$ 次三角多项式精确。对于带限函数，如果 $M$ 小于非零傅里叶分量的数量，就会发生混叠，积分也无法正确计算。最小点数由带宽决定，如上所述。\n- **结论：错误。**\n\n**D. 选择 $M$ 个点 $\\phi_m = \\dfrac{2\\pi m}{M}$（其中 $m = 0,1,\\dots,M-1$），权重为 $\\dfrac{2\\pi}{M}$，并要求 $M$ 是偶数以正确捕捉偶数粒子数宇称态；对于 $N_{\\min} = 116$ 和 $N_{\\max} = 128$，最小的偶数 $M$ 是 $14$。**\n- 权重 $\\frac{2\\pi}{M}$ 将用于积分本身，但算符 $\\hat P_N$ 包含一个 $\\frac{1}{2\\pi}$ 的前置因子，使得有效权重为 $\\frac{1}{M}$。这是一个次要的歧义。\n- 关键错误在于要求“$M$ 是偶数”。对于粒子数投影没有这样的普遍要求。奇数个点是完全有效的。实际上，对于给定的情况，最小点数是13，是奇数。解析不同粒子数 $n$ 的能力取决于点数 $M$，而不是其奇偶性。\n- **结论：错误。**\n\n**E. 选择 $M$ 个点 $\\phi_m = \\dfrac{2\\pi m}{M}$（其中 $m = 0,1,\\dots,M-1$），权重相等为 $\\dfrac{1}{M}$，并根据奈奎斯特准则要求 $M = 2\\big(N_{\\max} - N_{\\min}\\big) + 1$；对于 $N_{\\min} = 116$ 和 $N_{\\max} = 128$，最小的 $M$ 是 $25$。**\n- 这是对奈奎斯特-香农采样定理的误用。该定理最简单的形式适用于实值低通信号。这里的信号是复数且带通的。需要确定的自由度数量是复傅里叶系数的数量，即 $L = N_{\\max} - N_{\\min} + 1$。这至少需要 $L$ 个复数样本。条件 $M \\geq L$ 是正确的。所提出的条件 $M \\geq 2(N_{\\max} - N_{\\min}) + 1 = 2(L-1)+1 = 2L-1$ 过于严格且不正确。\n- 对于给定的情况，这个不正确的公式得出 $M=2(12)+1 = 25$，而真正的最小值是 $13$。\n- **结论：错误。**",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "拥有了基本的离散化方案后，我们必须面对专业级计算中的现实挑战：数值不稳定性。直接计算投影核函数在物理相关的场景下（例如弱配对体系）极易出现严重的数值误差，如下溢和灾难性抵消。本练习要求我们深入分析这些陷阱，并评估能够确保计算结果稳定和准确的鲁棒算法。",
            "id": "3579469",
            "problem": "考虑一个偶数粒子 Hartree–Fock–Bogoliubov (HFB) 准粒子真空，它在正则基中由时间反演对（索引为 $k$）构成，其 Bogoliubov 振幅 $\\{u_k,v_k\\}$ 满足 $u_k^2+v_k^2=1$。令粒子数算符为 $\\hat{N}$，并通过以下基本投影关系定义规范角生成函数 $G(\\phi)$ 和粒子数概率 $n_N$：\n$$\nG(\\phi)\\equiv \\langle \\Phi \\vert e^{i\\phi \\hat{N}} \\vert \\Phi\\rangle,\\qquad\nn_N\\equiv \\frac{1}{2\\pi}\\int_{0}^{2\\pi} d\\phi\\, e^{-iN\\phi}\\, G(\\phi),\n$$\n其中 $\\vert\\Phi\\rangle$ 是 HFB 真空。假设一个具有 $K$ 个正则对的大系统（这在中重核中很典型），其中许多对是弱配对的，即对于相当一部分的 $k$，有 $v_k\\ll 1$ 或 $u_k\\ll 1$。平均粒子数为 $\\langle \\hat{N}\\rangle = \\sum_k 2 v_k^2$。\n\n你需要分析在双精度下进行数值计算时，$n_N$ 对浮点舍入和相消误差的敏感性，并找出在弱配对情况下能确保粒子数投影稳定性的算法。\n\n仅使用给定的定义和 HFB 正则乘积态的标准性质\n$$\n\\vert \\Phi \\rangle \\propto \\prod_{k} \\left(u_k + v_k\\, a_k^\\dagger a_{\\bar{k}}^\\dagger\\right)\\vert 0\\rangle,\n$$\n其中 $a_k^\\dagger$ 在单粒子态 $k$ 上产生一个粒子，$a_{\\bar{k}}^\\dagger$ 产生其时间反演伴侣，解决以下问题：\n\n1. 从第一性原理出发，推导 $G(\\phi)$ 如何分解为关于正则对的乘积，并用 $\\{u_k,v_k\\}$ 和 $\\phi$ 表示它。利用此结果将 $n_N$ 写为一个关于 $k$ 的乘积的傅里叶系数。\n2. 在弱配对极限下，对于一个 $v_k\\ll 1$ 的对的子集 $\\mathcal{W}$，证明贡献于 $G(\\phi)$ 的每个对因子可以写成 $1+\\epsilon_k(\\phi)$ 的形式，其中 $\\epsilon_k(\\phi)$ 很小。并由此推断，在双精度下直接乘以许多这样接近 1 的复数因子会如何累积量级为 $\\mathcal{O}(K\\,\\epsilon_{\\mathrm{mach}})$ 的相对误差，其中 $\\epsilon_{\\mathrm{mach}}$ 是机器精度。解释为什么随后的对 $\\phi$ 的傅里叶积分会遭受严重的相消，导致 $n_N$ 分布的尾部出现大的相对误差。\n3. 提出并论证能够控制下溢/上溢和相消的算法策略，同时保持归一化 $\\sum_N n_N = 1$ 和平均值 $\\sum_N N\\,n_N = \\langle \\hat{N}\\rangle$。\n\n在弱配对情况下，以下哪些策略能正确地确保 $n_N$ 的数值稳定性，同时保持物理保真度？\n\nA. 在双精度下通过直接乘法计算 $G(\\phi)$，并使用关于 $\\phi$ 的均匀离散傅里叶变换计算 $n_N$，不进行任何缩放，因为所有对因子的模都以 1 为界，所以乘积在数值上保持良好表现。\n\nB. 在对数域中累积 $G(\\phi)$，对每个 $\\phi$ 使用数值稳定的原语（例如对小 $z$ 使用 $\\ln(1+z)$ 和双参数反正切函数）计算总和 $S(\\phi)=\\sum_k \\ln\\!\\left\\lvert u_k^2 + v_k^2 e^{i 2\\phi}\\right\\rvert$ 和 $\\Theta(\\phi)=\\sum_k \\arg\\!\\left(u_k^2 + v_k^2 e^{i 2\\phi}\\right)$，然后重构 $G(\\phi)=\\exp\\!\\big(S(\\phi)\\big)\\,e^{i\\Theta(\\phi)}$，并对缩放后的数组 $\\tilde{G}(\\phi)=G(\\phi)/\\max_{\\phi}\\lvert G(\\phi)\\rvert$ 执行傅里叶变换，以避免下溢/上溢和相消。\n\nC. 将任何满足 $v_k  10^{-12}$ 或 $u_k  10^{-12}$ 的振幅替换为精确的零以消除舍入误差；与机器精度相比，这种阈值处理对 $n_N$ 的影响可以忽略不计，并且能在不引入偏差的情况下提高稳定性。\n\nD. 利用 $n_N$ 与对占据数的生成多项式系数在 $x$ 中的等价性，通过对多项式 $\\prod_k \\left(u_k^2 + v_k^2 x^2\\right)$ 进行稳定的离散卷积来计算 $n_N$，并在每一步进行归一化和补偿求和；这避免了振荡积分，并控制了 $n_N$ 整个支持域上的动态范围。\n\nE. 按模的降序排列对因子并按该顺序相乘；无论 $v_k$ 或 $u_k$ 有多小，这都能保证将浮点舍入误差消除到机器精度水平。\n\n选择所有正确选项。",
            "solution": "用户想要对一个关于计算核物理中粒子数投影数值稳定性的问题进行详细分析，并随后评估所提出的策略。\n\n### 第一步：提取已知条件\n- **态**: 一个偶数粒子 Hartree–Fock–Bogoliubov (HFB) 准粒子真空 $|\\Phi\\rangle$，在正则基中由时间反演对（索引为 $k$）构成。\n- **振幅**: 每个对 $k$ 的 Bogoliubov 振幅 $\\{u_k, v_k\\}$，满足归一化条件 $u_k^2 + v_k^2 = 1$。\n- **算符和定义**:\n    - 粒子数算符: $\\hat{N}$。\n    - 规范角生成函数: $G(\\phi) \\equiv \\langle \\Phi | e^{i\\phi \\hat{N}} | \\Phi\\rangle$。\n    - 粒子数概率: $n_N \\equiv \\frac{1}{2\\pi}\\int_{0}^{2\\pi} d\\phi\\, e^{-iN\\phi}\\, G(\\phi)$。\n- **态结构**: HFB 真空是一个乘积态，形式为 $|\\Phi\\rangle \\propto \\prod_{k} (u_k + v_k a_k^\\dagger a_{\\bar{k}}^\\dagger)|0\\rangle$。\n- **系统性质**: 系统很大，有 $K$ 个正则对。相当一部分对是弱配对的，即 $v_k \\ll 1$ 或 $u_k \\ll 1$。\n- **平均粒子数**: $\\langle \\hat{N}\\rangle = \\sum_k 2 v_k^2$。\n- **精度**: 数值计算在双精度下执行。\n\n### 第二步：使用已知条件进行验证\n1.  **科学或事实上的不合理性**: 该问题牢固地植根于核结构理论，特别是 HFB 多体方法和粒子数投影技术。$G(\\phi)$ 和 $n_N$ 的定义在该领域是标准的。所描述的数值稳定性问题（舍入误差、相消、下溢/上溢）是科学计算中的实际挑战。该问题没有伪科学或事实错误。\n2.  **非形式化或不相关**: 该问题高度形式化，并直接关系到计算核物理中从平均场态进行粒子数投影的课题。\n3.  **不完整或矛盾的设定**: 问题是自洽的。它提供了 HFB 态的显式形式、待计算量的定义以及物理背景（弱配对）。在正则基中，实振幅的归一化条件 $u_k^2+v_k^2=1$ 是标准的。设定是一致的。\n4.  **不切实际或不可行**: 所描述的条件不仅是现实的，而且对于中重核的计算是典型的，在这些计算中，配对相互作用会产生一个弥散的费米面，其特征是许多弱配对态（小的 $v_k$ 或小的 $u_k$）。\n5.  **问题设定不当或结构不良**: 问题设定良好。所提问题精确，并导向对数值算法的明确分析。在计算物理的背景下，术语是标准的且无歧义。\n6.  **故作高深、琐碎或同义反复**: 该问题探讨了计算物理中一个真实而非凡的挑战。要实现稳定而精确的粒子数投影，特别是在粒子数方差大或弱配对的情况下，需要超越朴素实现的复杂数值技术。\n7.  **超出科学可验证性**: 关于算法稳定性的论断可以通过理论误差分析和数值实验进行科学验证。\n\n### 第三步：结论与行动\n问题陈述是有效的。这是一个在计算核物理领域中表述清晰、科学上合理且相关的问题。我将继续进行解答。\n\n### 推导与分析\n\n根据问题提示，在评估选项之前，我将首先推导必要的表达式并分析数值挑战。\n\n#### 1. $G(\\phi)$ 和 $n_N$ 的推导\n正则基中的 HFB 真空态是关于对 $(k, \\bar{k})$ 的乘积态：\n$$|\\Phi\\rangle = \\prod_k |\\Phi_k\\rangle = \\prod_k (u_k + v_k a_k^\\dagger a_{\\bar{k}}^\\dagger) |0\\rangle$$\n假设振幅为实数，归一化条件 $\\langle\\Phi_k|\\Phi_k\\rangle = u_k^2 \\langle 0|0\\rangle + v_k^2 \\langle 0|a_{\\bar{k}} a_k a_k^\\dagger a_{\\bar{k}}^\\dagger|0\\rangle = u_k^2 + v_k^2 = 1$ 确保了总态 $|\\Phi\\rangle$ 是归一化的。\n\n粒子数算符 $\\hat{N} = \\sum_j a_j^\\dagger a_j$ 是可加的，所以其指数是可乘的：$e^{i\\phi \\hat{N}} = \\prod_j e^{i\\phi a_j^\\dagger a_j}$。对于给定的对 $k$，算符为 $e^{i\\phi (\\hat{N}_k + \\hat{N}_{\\bar{k}})}$，其中 $\\hat{N}_k = a_k^\\dagger a_k$。\n\n由于态和算符都具有乘积结构，矩阵元 $G(\\phi)$ 可分解为对的乘积：\n$$G(\\phi) = \\langle \\Phi | e^{i\\phi \\hat{N}} | \\Phi \\rangle = \\prod_k \\langle \\Phi_k | e^{i\\phi (\\hat{N}_k + \\hat{N}_{\\bar{k}})} | \\Phi_k \\rangle$$\n我们来计算单个对 $k$ 的因子。态 $|\\Phi_k\\rangle$ 是一个 0 粒子分量 $u_k|0\\rangle$ 和一个 2 粒子分量 $v_k a_k^\\dagger a_{\\bar{k}}^\\dagger|0\\rangle$ 的叠加。粒子数算符在福克基中是对角的：\n$$e^{i\\phi (\\hat{N}_k + \\hat{N}_{\\bar{k}})} |\\Phi_k\\rangle = e^{i\\phi (\\hat{N}_k + \\hat{N}_{\\bar{k}})} (u_k|0\\rangle + v_k a_k^\\dagger a_{\\bar{k}}^\\dagger|0\\rangle) = u_k e^{i\\phi \\cdot 0} |0\\rangle + v_k e^{i\\phi \\cdot 2} a_k^\\dagger a_{\\bar{k}}^\\dagger|0\\rangle$$\n因此，一个对的矩阵元是：\n$$\\langle \\Phi_k | \\dots | \\Phi_k \\rangle = \\langle 0|(u_k+v_k a_{\\bar{k}}a_k) (u_k|0\\rangle + v_k e^{i2\\phi} a_k^\\dagger a_{\\bar{k}}^\\dagger|0\\rangle) = u_k^2 + v_k^2 e^{i2\\phi}$$\n因此，生成函数是这些对复数因子的乘积：\n$$G(\\phi) = \\prod_{k=1}^K \\left(u_k^2 + v_k^2 e^{i2\\phi}\\right)$$\n粒子数概率 $n_N$ 是此函数的傅里叶系数：\n$$n_N = \\frac{1}{2\\pi}\\int_0^{2\\pi} d\\phi\\, e^{-iN\\phi} \\prod_{k=1}^K \\left(u_k^2 + v_k^2 e^{i2\\phi}\\right)$$\n\n#### 2. 弱配对的数值稳定性分析\n在对 $k$ 的弱配对极限下，我们有 $v_k \\ll 1$（此时 $u_k^2 = 1 - v_k^2 \\approx 1$）或 $u_k \\ll 1$（此时 $v_k^2 = 1 - u_k^2 \\approx 1$）。\n\n情况 1：$v_k \\ll 1$。对因子为 $g_k(\\phi) = u_k^2 + v_k^2 e^{i2\\phi} = (1-v_k^2) + v_k^2 e^{i2\\phi} = 1 + v_k^2(e^{i2\\phi}-1)$。这具有 $1+\\epsilon_k(\\phi)$ 的形式，其中 $|\\epsilon_k(\\phi)| = |v_k^2(e^{i2\\phi}-1)| \\leq 2v_k^2 \\ll 1$。在浮点运算中计算 `1 + term` 这样的表达式，如果 `$term$` 接近或小于机器精度 $\\epsilon_{\\mathrm{mach}}$，可能会遭受有效数字损失。\n\n当乘以许多这样接近 1 的复数因子时，比如 $G_m = \\prod_{k=1}^m g_k(\\phi)$，浮点计算为 $\\tilde{G}_m = \\tilde{G}_{m-1} \\otimes g_m(\\phi) \\approx (G_{m-1} \\prod_{j=1}^{m-1}(1+\\delta_j)) \\times g_m(\\phi) (1+\\delta_m)$，其中 $|\\delta_j| \\le \\epsilon_{\\mathrm{mach}}$。经过 $K$ 次乘法后，累积的相对误差近似为 $\\sum_{j=1}^{K-1} \\delta_j$，在最坏情况下量级为 $\\mathcal{O}(K\\,\\epsilon_{\\mathrm{mach}})$。对于大的 $K$，这可能是显著的。\n\n傅里叶积分 $n_N = \\frac{1}{2\\pi}\\int_0^{2\\pi} d\\phi\\, e^{-iN\\phi} G(\\phi)$ 是通过对一个高度振荡的函数进行积分来计算一个小的数（对于分布尾部的 $N$）。$G(\\phi)$ 的模可以剧烈变化。$|G(\\phi)| = \\prod_k |u_k^2 + v_k^2 e^{i2\\phi}|$。最大值是 $|G(0)|=1$。最小值可能非常小。例如，如果有很多对满足 $u_k \\approx v_k$，则 $|G(\\pi/2)| = \\prod_k |u_k^2-v_k^2|$ 可能很容易下溢。数值计算该积分（例如，通过离散傅里叶变换）涉及对许多模值相当的复数求和，它们相互抵消以产生一个更小的结果。这是灾难性相消的典型例子，导致计算出的 $n_N$ 存在很大的相对误差。\n\n#### 3. 算法策略\n为了解决这些问题，必须采用稳定的算法。\n- **控制乘积中的下溢/上溢和舍入**：与其直接计算乘积 $G(\\phi) = \\prod_k g_k(\\phi)$，不如计算其对数来得稳定得多：$\\ln G(\\phi) = \\sum_k \\ln g_k(\\phi)$。这将一个大动态范围的乘积转换为一个和，后者在数值上是稳定的。\n- **控制因子计算中的相消**：对于小的 $v_k$，要计算 $\\ln g_k(\\phi) = \\ln(1 + v_k^2(e^{i2\\phi}-1))$，应该使用一个稳定的 `log1p(z)` 函数，它能对小的 $|z|$ 精确计算 $\\ln(1+z)$。\n- **避免傅里叶变换的相消**：一个完全不同的方法是认识到 $G(\\phi)$ 是 $z=e^{i\\phi}$ 的多项式。令 $x=z^2=e^{i2\\phi}$。则 $G(\\phi) = \\prod_k (u_k^2 + v_k^2 x)$。概率 $n_N$ 仅对于偶数 $N=2m$ 非零，且 $n_{2m}$ 是此多项式乘积中 $x^m$ 的系数。这些系数可以通过多项式卷积递归计算：\n$$P^{(k)}(x) = P^{(k-1)}(x) \\cdot (u_k^2 + v_k^2 x)$$\n如果 $c_m^{(k)}$ 是 $P^{(k)}(x)$ 中 $x^m$ 的系数，则递推关系为：\n$$c_m^{(k)} = c_m^{(k-1)} u_k^2 + c_{m-1}^{(k-1)} v_k^2$$\n从 $c_0^{(0)}=1$ 开始。这只涉及正实数的和与积，完全避免了振荡积分和复数运算。系数 $c_m^{(k)}$ 的动态范围可以通过在每一步 $k$ 对系数向量进行归一化来控制。这是一个高度稳定和精确的方法。\n\n### 选项评估\n\n**A. 在双精度下通过直接乘法计算 $G(\\phi)$，并使用关于 $\\phi$ 的均匀离散傅里叶变换计算 $n_N$，不进行任何缩放，因为所有对因子的模都以 1 为界，所以乘积在数值上保持良好表现。**\n这描述了最朴素的方法。前提 $|g_k(\\phi)| \\le 1$ 是正确的，这可以防止上溢。但是，它不能防止下溢。对于远离 $0$ 的 $\\phi$， $|G(\\phi)|$ 可能变得比双精度能表示的最小数还小。此外，这种方法忽略了乘积中相对误差的累积以及在计算因子 `1 + small_term` 和最终傅里叶变换中发生的灾难性相消。声称乘积“在数值上保持良好表现”是错误的。\n**结论：错误。**\n\n**B. 在对数域中累积 $G(\\phi)$，对每个 $\\phi$ 使用数值稳定的原语（例如对小 $z$ 使用 $\\ln(1+z)$ 和双参数反正切函数）计算总和 $S(\\phi)=\\sum_k \\ln\\!\\left\\lvert u_k^2 + v_k^2 e^{i 2\\phi}\\right\\rvert$ 和 $\\Theta(\\phi)=\\sum_k \\arg\\!\\left(u_k^2 + v_k^2 e^{i 2\\phi}\\right)$，然后重构 $G(\\phi)=\\exp\\!\\big(S(\\phi)\\big)\\,e^{i\\Theta(\\phi)}$，并对缩放后的数组 $\\tilde{G}(\\phi)=G(\\phi)/\\max_{\\phi}\\lvert G(\\phi)\\rvert$ 执行傅里叶变换，以避免下溢/上溢和相消。**\n该策略正确地解决了几个关键问题。在对数域中累积可以防止乘积计算中的下溢/上溢。使用像 `ln(1+z)`（通常称为 `log1p()`）和 `atan2()` 这样的原语确保了 $\\ln(g_k(\\phi))$ 项的精确计算，避免了对接近 1 的因子的相消问题。最终的重构和傅里叶变换步骤仍然面临固有的相消问题，但这一步的输入是以高保真度计算的。所描述的缩放是平凡的，因为 $\\max_\\phi |G(\\phi)| = |G(0)| = 1$，但整套技术（对数累积、稳定原语）代表了对数值稳定性的有效且显著的改进，并保持了物理保真度。\n**结论：正确。**\n\n**C. 将任何满足 $v_k  10^{-12}$ 或 $u_k  10^{-12}$ 的振幅替换为精确的零以消除舍入误差；与机器精度相比，这种阈值处理对 $n_N$ 的影响可以忽略不计，并且能在不引入偏差的情况下提高稳定性。**\n此策略引入了系统性误差，即偏差。设置 $v_k=0$ 意味着对 $(k,\\bar{k})$ 总是未被占据，从而使平均粒子数减少 $2v_k^2$。设置 $u_k=0$（因此 $v_k=1$）意味着该对总是被占据，人为地将其两个粒子强加到投影波函数的每个分量中。虽然单个对的变化可能很小，但累积效应可能很显著，并且它从根本上改变了 HFB 态的物理性质。一个稳健的数值方法应该在不引入偏差的情况下减少误差。声称这是“不引入偏差”是错误的。\n**结论：错误。**\n\n**D. 利用 $n_N$ 与对占据数的生成多项式系数在 $x$ 中的等价性，通过对多项式 $\\prod_k \\left(u_k^2 + v_k^2 x^2\\right)$ 进行稳定的离散卷积来计算 $n_N$，并在每一步进行归一化和补偿求和；这避免了振荡积分，并控制了 $n_N$ 整个支持域上的动态范围。**\n这描述了一种替代的、高度稳定的算法。通过代数上重构问题，该方法完全绕过了 $G(\\phi)$ 的计算及其振荡傅里叶变换。递归卷积只涉及正数，从而消除了相消误差的主要来源。所提出的技术——每步归一化以控制动态范围和补偿求和以最小化舍入误差——是专业设计的数值算法的标志。众所周知，这种方法在此问题上的稳定性更优。这是一个正确且强大的策略。\n**结论：正确。**\n\n**E. 按模的降序排列对因子并按该顺序相乘；无论 $v_k$ 或 $u_k$ 有多小，这都能保证将浮点舍入误差消除到机器精度水平。**\n这个策略基于一个薄弱的启发式方法，并作出了过分夸大的声明。虽然排序有时有助于减少求和的误差（特别是从小到大求和），但它并非解决乘积问题的万能药，当然也不能“保证消除”舍入误差。乘积的误差是乘法累积的，简单的重排序并不能消除它。此外，该策略未能解决不稳定的根本原因：计算因子 $g_k(\\phi)$ 本身时的减法相消和傅里叶积分中的灾难性相消。这个说法显然是错误的。\n**结论：错误。**",
            "answer": "$$\\boxed{BD}$$"
        },
        {
            "introduction": "最后，我们将理论、算法与实践融为一体，为一个模型哈密顿量完整地实现粒子数投影计算。这个动手练习不仅涉及编写代码，还要求我们系统地测试计算结果相对于数值参数（如规范角点数和模型空间截断）的收敛性。这不仅验证了我们的理论理解，也为我们建立起对数值结果的信心。",
            "id": "3579430",
            "problem": "给定计算核物理中一个独立时间反演共轭正则对系统的平均场准粒子真空，要求评估粒子数投影能量关于两个数值控制参数的收敛性：规范角点的数量和弱占据正则态的截断。您的任务是设计并实现一个程序，对于给定的测试套件，评估投影能量是否在规定的容差内收敛。\n\n物理和数学背景使用以下基本设定：\n\n- 粒子数 $N$ 的粒子数投影算符为\n$$\n\\hat{P}_N \\equiv \\frac{1}{2\\pi} \\int_{0}^{2\\pi} \\mathrm{d}\\varphi \\, e^{i \\varphi (N - \\hat{N})}.\n$$\n- 系统哈密顿量是常数配对哈密顿量\n$$\n\\hat{H} \\equiv \\sum_{i=1}^{\\Omega} 2 \\varepsilon_i \\hat{N}_i - G \\sum_{i=1}^{\\Omega}\\sum_{j=1}^{\\Omega} \\hat{P}_i^\\dagger \\hat{P}_j,\n$$\n其中 $i$ 标记正则时间反演共轭对，$\\hat{N}_i$ 计算对子空间中的粒子数，$\\hat{P}_i^\\dagger$ 在能级 $i$ 上产生一个对。单粒子能量为 $\\varepsilon_i$，单位为兆电子伏特 (MeV)，$G$ 是一个常数配对强度，单位为 MeV。\n- 平均场（巴丁-库珀-施里弗）准粒子真空是\n$$\n\\lvert \\Phi \\rangle \\equiv \\prod_{i=1}^{\\Omega} \\left(u_i + v_i \\, \\hat{P}_i^\\dagger \\right) \\lvert 0 \\rangle,\n$$\n其中 $u_i, v_i \\in \\mathbb{R}$ 且对所有 $i$ 都有 $u_i^2 + v_i^2 = 1$。\n\n基于这些基础，投影能量定义为投影核的比值，\n$$\nE_N \\equiv \\frac{\\langle \\Phi \\lvert \\hat{H} \\hat{P}_N \\rvert \\Phi \\rangle}{\\langle \\Phi \\lvert \\hat{P}_N \\rvert \\Phi \\rangle}.\n$$\n\n您的程序必须实现以下从上述定义推导出的内容：\n\n1. 根据 $\\lvert \\Phi \\rangle$ 的独立对结构和标准的多体收缩，用正则对因子表示模核 $\\langle \\Phi \\lvert e^{-i \\varphi \\hat{N}} \\rvert \\Phi \\rangle$ 和哈密顿量核 $\\langle \\Phi \\lvert \\hat{H} e^{-i \\varphi \\hat{N}} \\rvert \\Phi \\rangle$。角度 $\\varphi$ 使用弧度。\n\n2. 用 $M$ 个等距点 $\\varphi_k \\equiv 2\\pi k/M$（其中 $k=0,\\dots,M-1$）和相等的权重来离散化 $\\varphi \\in [0, 2\\pi)$ 上的规范角积分，以离散求积的方式近似 $E_N$。这是单位圆上的 Fomenko/梯形法则。\n\n3. 通过移除任何占据数 $v_i^2$ 小于指定阈值 $\\eta \\ge 0$ 的能级 $i$ 来实现正则空间截断。所有剩余的能级必须在两个核中一致地使用。\n\n4. 对于每个测试用例，使用一个非常大的 $M_{\\mathrm{ref}}$ 和无截断 $\\eta_{\\mathrm{ref}} = 0$ 计算一个高保真参考投影能量 $E_N^{\\mathrm{ref}}$，然后在一个给定的 $(M,\\eta)$ 网格上评估最大绝对偏差：\n$$\n\\Delta \\equiv \\max_{(M,\\eta)} \\left| E_N(M,\\eta) - E_N^{\\mathrm{ref}} \\right|.\n$$\n如果 $\\,\\Delta \\le \\tau\\,$，则返回布尔值 $\\,\\mathrm{True}\\,$，否则返回 $\\,\\mathrm{False}\\,$，其中 $\\tau$ 是该测试用例的指定容差。\n\n角度单位必须是弧度。能量单位统一按兆电子伏特 (MeV) 处理。布尔结果是无量纲的。\n\n需要实现的测试套件：\n\n- 情况 1：\n  - 单粒子能量 (MeV)：$\\varepsilon = [-6.0, -3.5, -2.0, -1.0, 0.5, 1.2]$。\n  - 正则占据数：$v^2 = [0.98, 0.90, 0.70, 0.30, 0.10, 0.02]$，且 $u^2 = 1 - v^2$。\n  - 配对强度 (MeV)：$G = 0.4$。\n  - 目标粒子数：$N = 6$。\n  - 规范角点数：$M \\in \\{13, 17, 25\\}$。\n  - 截断阈值：$\\eta \\in \\{0.0, 10^{-6}, 10^{-3}, 10^{-2}\\}$。\n  - 容差 (MeV)：$\\tau = 0.02$。\n\n- 情况 2：\n  - 单粒子能量 (MeV)：$\\varepsilon = [-9.0, -7.0, -5.0, -3.0, -1.0, 1.0, 3.0, 5.0, 7.0, 9.0]$。\n  - 正则占据数：$v^2 = [0.995, 0.97, 0.90, 0.75, 0.60, 0.40, 0.25, 0.10, 0.03, 0.001]$，且 $u^2 = 1 - v^2$。\n  - 配对强度 (MeV)：$G = 0.5$。\n  - 目标粒子数：$N = 10$。\n  - 规范角点数：$M \\in \\{21, 33, 65\\}$。\n  - 截断阈值：$\\eta \\in \\{0.0, 10^{-6}, 10^{-4}, 5 \\times 10^{-3}\\}$。\n  - 容差 (MeV)：$\\tau = 0.02$。\n\n- 情况 3：\n  - 单粒子能量 (MeV)：$\\varepsilon = [-4.0, -2.0, -1.0, -0.2, 0.2, 1.0, 2.0, 4.0]$。\n  - 正则占据数：$v^2 = [0.999, 0.99, 0.98, 0.6, 0.4, 0.02, 0.01, 0.001]$，且 $u^2 = 1 - v^2$。\n  - 配对强度 (MeV)：$G = 0.3$。\n  - 目标粒子数：$N = 8$。\n  - 规范角点数：$M \\in \\{17, 33, 65\\}$。\n  - 截断阈值：$\\eta \\in \\{0.0, 10^{-6}, 10^{-4}, 10^{-3}\\}$。\n  - 容差 (MeV)：$\\tau = 0.02$。\n\n参考能量的计算必须使用 $M_{\\mathrm{ref}} = 4096$ 和 $\\eta_{\\mathrm{ref}} = 0$，最终的投影能量必须取离散化后复数比值的实部。\n\n最终输出格式要求：\n- 您的程序应产生单行输出，其中包含三个情况的布尔结果，形式为逗号分隔的列表，并用方括号括起来（例如，$[{\\rm True},{\\rm False},{\\rm True}]$）。不应打印任何其他文本。",
            "solution": "该问题已经过分析，被认为是有效的。它在科学上基于量子多体理论的原理，特别是计算核物理中使用的巴丁-库珀-施里弗（BCS）形式主义和粒子数投影技术。该问题是良定的，所有必要的参数、定义和约束都已提供，以指定一个唯一且可计算的结果。语言是客观的，设置是内部一致的。\n\n任务的核心是为一个由常数配对哈密顿量 $\\hat{H}$ 和一个 BCS 型平均场态 $|\\Phi\\rangle$ 描述的系统计算粒子数投影能量 $E_N$。投影能量由投影的哈密顿量核和模核的比值给出：\n$$\nE_N \\equiv \\frac{\\langle \\Phi \\lvert \\hat{H} \\hat{P}_N \\rvert \\Phi \\rangle}{\\langle \\Phi \\lvert \\hat{P}_N \\rvert \\Phi \\rangle}\n$$\n粒子数投影算符 $\\hat{P}_N$ 通过一个规范角积分定义：\n$$\n\\hat{P}_N = \\frac{1}{2\\pi} \\int_{0}^{2\\pi} \\mathrm{d}\\varphi \\, e^{i \\varphi (N - \\hat{N})}\n$$\n将此代入分子和分母的表达式中，得到：\n$$\n\\langle \\Phi \\lvert \\hat{P}_N \\rvert \\Phi \\rangle = \\frac{1}{2\\pi} \\int_{0}^{2\\pi} \\mathrm{d}\\varphi \\, e^{i\\varphi N} \\langle \\Phi \\lvert e^{-i\\varphi\\hat{N}} \\rvert \\Phi \\rangle = \\frac{1}{2\\pi} \\int_0^{2\\pi} \\mathrm{d}\\varphi \\, e^{i\\varphi N} n(\\varphi)\n$$\n$$\n\\langle \\Phi \\lvert \\hat{H} \\hat{P}_N \\rvert \\Phi \\rangle = \\frac{1}{2\\pi} \\int_{0}^{2\\pi} \\mathrm{d}\\varphi \\, e^{i\\varphi N} \\langle \\Phi \\lvert \\hat{H} e^{-i\\varphi\\hat{N}} \\rvert \\Phi \\rangle = \\frac{1}{2\\pi} \\int_0^{2\\pi} \\mathrm{d}\\varphi \\, e^{i\\varphi N} h(\\varphi)\n$$\n这里我们定义了模核 $n(\\varphi) \\equiv \\langle \\Phi \\lvert e^{-i\\varphi\\hat{N}} \\rvert \\Phi \\rangle$ 和哈密顿量核 $h(\\varphi) \\equiv \\langle \\Phi \\lvert \\hat{H} e^{-i\\varphi\\hat{N}} \\rvert \\Phi \\rangle$。\n\n态 $|\\Phi\\rangle$ 是独立正则对的态的乘积：$|\\Phi\\rangle = \\prod_{i=1}^\\Omega (u_i + v_i \\hat{P}_i^\\dagger) |0\\rangle = \\prod_{i=1}^\\Omega |\\phi_i\\rangle$。数算符也是单对算符的和，$\\hat{N} = \\sum_i \\hat{N}_i$，其中 $\\hat{N}_i$ 的本征值为 0 和 2。这种可分离性使得核可以表示为正则能级的乘积。\n\n首先，我们推导模核 $n(\\varphi)$。由于 $|\\Phi\\rangle$ 和 $e^{-i\\varphi\\hat{N}}$ 的乘积结构，核可以因子化：\n$$\nn(\\varphi) = \\langle \\Phi \\lvert e^{-i\\varphi\\hat{N}} \\rvert \\Phi \\rangle = \\prod_{i=1}^{\\Omega} \\langle \\phi_i \\lvert e^{-i\\varphi\\hat{N}_i} \\rvert \\phi_i \\rangle\n$$\n对于单个能级 $i$，矩阵元为：\n$$\n\\langle \\phi_i \\lvert e^{-i\\varphi\\hat{N}_i} \\rvert \\phi_i \\rangle = \\left( u_i \\langle 0 |_i + v_i \\langle 0 |_i \\hat{P}_i \\right) e^{-i\\varphi\\hat{N}_i} \\left( u_i |0\\rangle_i + v_i \\hat{P}_i^\\dagger |0\\rangle_i \\right) = u_i^2 + v_i^2 e^{-i 2\\varphi}\n$$\n因此，完整的模核是：\n$$\nn(\\varphi) = \\prod_{i=1}^{\\Omega} \\left( u_i^2 + v_i^2 e^{-i 2\\varphi} \\right)\n$$\n\n接下来，我们推导哈密顿量核 $h(\\varphi)$。哈密顿量由单粒子部分 $\\hat{H}_{\\mathrm{sp}} = \\sum_{i} 2\\varepsilon_i \\hat{N}_i$ 和配对部分 $\\hat{H}_{\\mathrm{pair}} = -G \\sum_{i,j} \\hat{P}_i^\\dagger \\hat{P}_j$ 组成。核是这两部分贡献之和，$h(\\varphi) = h_{\\mathrm{sp}}(\\varphi) + h_{\\mathrm{pair}}(\\varphi)$。\n使用所谓的跃迁期望值 $ \\langle \\hat{O} \\rangle_\\varphi \\equiv \\langle \\Phi | \\hat{O} | \\Phi(\\varphi) \\rangle / \\langle \\Phi | \\Phi(\\varphi) \\rangle $ 来表示 $h(\\varphi)$ 很方便，其中 $|\\Phi(\\varphi)\\rangle \\equiv e^{-i\\varphi\\hat{N}}|\\Phi\\rangle$。于是 $h(\\varphi) = n(\\varphi) \\langle \\hat{H} \\rangle_\\varphi$。\n\n对于单粒子部分：\n$$\n\\langle \\hat{H}_{\\mathrm{sp}} \\rangle_\\varphi = \\sum_{j=1}^{\\Omega} 2\\varepsilon_j \\frac{\\langle \\Phi | \\hat{N}_j | \\Phi(\\varphi) \\rangle}{n(\\varphi)} = \\sum_{j=1}^{\\Omega} 2\\varepsilon_j \\frac{\\langle \\phi_j | \\hat{N}_j | \\phi_j(\\varphi) \\rangle}{n_j(\\varphi)}\n$$\n其中 $n_j(\\varphi) = u_j^2 + v_j^2 e^{-i2\\varphi}$ 且 $|\\phi_j(\\varphi)\\rangle = e^{-i\\varphi\\hat{N}_j}|\\phi_j\\rangle$。单能级矩阵元 $\\langle \\phi_j | \\hat{N}_j | \\phi_j(\\varphi) \\rangle$ 的计算结果为 $2 v_j^2 e^{-i2\\varphi}$。这给出：\n$$\n\\langle \\hat{H}_{\\mathrm{sp}} \\rangle_\\varphi = \\sum_{j=1}^{\\Omega} 2\\varepsilon_j \\frac{2 v_j^2 e^{-i2\\varphi}}{u_j^2 + v_j^2 e^{-i2\\varphi}} = \\sum_{j=1}^{\\Omega} \\frac{4 \\varepsilon_j v_j^2 e^{-i2\\varphi}}{u_j^2 + v_j^2 e^{-i2\\varphi}}\n$$\n对于配对部分，相互作用的结构和 BCS 态允许通过广义维克定理进行因子化：\n$$\n\\langle \\hat{H}_{\\mathrm{pair}} \\rangle_\\varphi = -G \\left\\langle \\sum_i \\hat{P}_i^\\dagger \\right\\rangle_\\varphi \\left\\langle \\sum_j \\hat{P}_j \\right\\rangle_\\varphi\n$$\n其中对产生和湮灭算符的跃迁期望值为：\n$$\n\\left\\langle \\hat{P}_j^\\dagger \\right\\rangle_\\varphi = \\frac{\\langle \\phi_j | \\hat{P}_j^\\dagger | \\phi_j(\\varphi) \\rangle}{n_j(\\varphi)} = \\frac{u_j v_j}{u_j^2 + v_j^2 e^{-i2\\varphi}}\n$$\n$$\n\\left\\langle \\hat{P}_j \\right\\rangle_\\varphi = \\frac{\\langle \\phi_j | \\hat{P}_j | \\phi_j(\\varphi) \\rangle}{n_j(\\varphi)} = \\frac{u_j v_j e^{-i2\\varphi}}{u_j^2 + v_j^2 e^{-i2\\varphi}}\n$$\n结合这些结果得到完整的哈密顿量核：\n$$\nh(\\varphi) = n(\\varphi) \\left[ \\sum_j \\frac{4 \\varepsilon_j v_j^2 e^{-i 2\\varphi}}{u_j^2 + v_j^2 e^{-i 2\\varphi}} - G \\left( \\sum_j \\frac{u_j v_j}{u_j^2 + v_j^2 e^{-i 2\\varphi}} \\right) \\left( \\sum_k \\frac{u_k v_k e^{-i 2\\varphi}}{u_k^2 + v_k^2 e^{-i 2\\varphi}} \\right) \\right]\n$$\n\n数值过程包括两个主要部分：\n$1$. **离散化**：规范角积分通过对 $M$ 个等距点 $\\varphi_k = 2\\pi k/M$（其中 $k=0,\\dots,M-1$）求和来近似。积分 $\\frac{1}{2\\pi} \\int_0^{2\\pi} (\\dots) \\mathrm{d}\\varphi$ 变为 $\\frac{1}{M} \\sum_{k=0}^{M-1} (\\dots)$。投影能量则为：\n$$\nE_N(M, \\eta) \\approx \\mathrm{Re}\\left[ \\frac{\\sum_{k=0}^{M-1} e^{i\\varphi_k N} h(\\varphi_k)}{\\sum_{k=0}^{M-1} e^{i\\varphi_k N} n(\\varphi_k)} \\right]\n$$\n根据问题陈述的要求，取其实部。\n\n$2$. **截断**：通过仅包含占据概率 $v_i^2$ 大于或等于阈值 $\\eta$ 的能级 $i$ 来截断正则空间。在 $n(\\varphi)$ 和 $h(\\varphi)$ 的公式中，所有对能级指标 $i, j, k$ 的求和与求积都限制在这个活性（active）能级集合上。\n\n收敛性分析算法如下：\n$1$. 对于每个测试用例，使用大量的规范角点（$M_{\\mathrm{ref}} = 4096$）和无截断（$\\eta_{\\mathrm{ref}} = 0$）来计算一个高保真参考能量 $E_N^{\\mathrm{ref}}$。\n$2$. 对于来自指定测试网格的每对数值控制参数 $(M, \\eta)$，计算投影能量 $E_N(M, \\eta)$。\n$3$. 对每对参数计算与参考值的绝对偏差 $|E_N(M, \\eta) - E_N^{\\mathrm{ref}}|$。\n$4$. 在整个网格上找到最大偏差 $\\Delta$：$\\Delta = \\max_{(M,\\eta)} |E_N(M, \\eta) - E_N^{\\mathrm{ref}}|$。\n$5$. 将此最大偏差与规定的容差 $\\tau$ 进行比较。如果 $\\Delta \\le \\tau$，结果为 True，否则为 False。\n\n这个结构化的过程可靠地评估了投影能量的数值收敛性。",
            "answer": "```python\nimport numpy as np\n\ndef calculate_projected_energy(M, eta, eps, v2, G, N):\n    \"\"\"\n    Calculates the particle-number projected energy for a pairing Hamiltonian.\n\n    Args:\n        M (int): Number of gauge-angle points for discretization.\n        eta (float): Truncation threshold for canonical occupations (v_i^2).\n        eps (np.ndarray): Array of single-particle energies.\n        v2 (np.ndarray): Array of canonical occupations.\n        G (float): Pairing strength constant.\n        N (int): Target particle number to project onto.\n\n    Returns:\n        float: The real part of the projected energy, or NaN if calculation fails.\n    \"\"\"\n    # 1. Apply canonical-space truncation\n    active_indices = np.where(v2 >= eta)[0]\n    \n    if len(active_indices) == 0:\n        return 0.0 if N == 0 else np.nan\n\n    active_eps = eps[active_indices]\n    active_v2 = v2[active_indices]\n    active_u2 = 1.0 - active_v2\n    \n    # Handle potential numerical issues from sqrt(negative) due to precision loss\n    active_u2[active_u2  0] = 0\n    active_v2[active_v2  0] = 0\n    \n    active_u = np.sqrt(active_u2)\n    active_v = np.sqrt(active_v2)\n    \n    # 2. Set up gauge-angle grid\n    phi_grid = 2 * np.pi * np.arange(M) / M\n    \n    projected_norm_sum = 0.0 + 0.0j\n    projected_hamiltonian_sum = 0.0 + 0.0j\n    \n    # 3. Loop over gauge angles and compute kernels\n    for phi in phi_grid:\n        phase_factor = np.exp(1j * phi * N)\n        z = np.exp(-2j * phi) # Complex phase for rotation in kernels\n        \n        # Per-level factors used in both kernels\n        n_i_phi = active_u2 + active_v2 * z\n        \n        # If any factor is zero, the product (norm kernel) is zero.\n        if np.any(np.abs(n_i_phi)  1e-15):\n            continue\n\n        # Norm kernel n(phi)\n        norm_kernel = np.prod(n_i_phi)\n        \n        # Hamiltonian kernel h(phi) terms\n        # Single-particle part\n        h_sp_terms = 4 * active_eps * active_v2 * z / n_i_phi\n        sum_h_sp = np.sum(h_sp_terms)\n        \n        # Pairing part\n        p_dagger_terms = active_u * active_v / n_i_phi\n        p_terms = active_u * active_v * z / n_i_phi\n        h_pair_term = -G * np.sum(p_dagger_terms) * np.sum(p_terms)\n        \n        # Full Hamiltonian kernel h(phi)\n        hamiltonian_kernel = norm_kernel * (sum_h_sp + h_pair_term)\n\n        # 4. Accumulate sums for discrete Fourier transform\n        projected_norm_sum += norm_kernel * phase_factor\n        projected_hamiltonian_sum += hamiltonian_kernel * phase_factor\n        \n    # 5. Compute the final projected energy\n    if np.abs(projected_norm_sum)  1e-12:\n        return np.nan # Division by zero indicates projection to N is zero\n\n    projected_energy = (projected_hamiltonian_sum / projected_norm_sum).real\n    return projected_energy\n\ndef solve():\n    \"\"\"\n    Runs the convergence tests for all three cases and prints the results.\n    \"\"\"\n    test_cases = [\n        # Case 1\n        {\n            \"eps\": np.array([-6.0, -3.5, -2.0, -1.0, 0.5, 1.2]),\n            \"v2\": np.array([0.98, 0.90, 0.70, 0.30, 0.10, 0.02]),\n            \"G\": 0.4, \"N\": 6,\n            \"M_grid\": [13, 17, 25], \"eta_grid\": [0.0, 1e-6, 1e-3, 1e-2],\n            \"tau\": 0.02\n        },\n        # Case 2\n        {\n            \"eps\": np.array([-9.0, -7.0, -5.0, -3.0, -1.0, 1.0, 3.0, 5.0, 7.0, 9.0]),\n            \"v2\": np.array([0.995, 0.97, 0.90, 0.75, 0.60, 0.40, 0.25, 0.10, 0.03, 0.001]),\n            \"G\": 0.5, \"N\": 10,\n            \"M_grid\": [21, 33, 65], \"eta_grid\": [0.0, 1e-6, 1e-4, 5e-3],\n            \"tau\": 0.02\n        },\n        # Case 3\n        {\n            \"eps\": np.array([-4.0, -2.0, -1.0, -0.2, 0.2, 1.0, 2.0, 4.0]),\n            \"v2\": np.array([0.999, 0.99, 0.98, 0.6, 0.4, 0.02, 0.01, 0.001]),\n            \"G\": 0.3, \"N\": 8,\n            \"M_grid\": [17, 33, 65], \"eta_grid\": [0.0, 1e-6, 1e-4, 1e-3],\n            \"tau\": 0.02\n        }\n    ]\n    \n    M_ref = 4096\n    eta_ref = 0.0\n    final_results = []\n\n    for case in test_cases:\n        E_ref = calculate_projected_energy(M_ref, eta_ref, case[\"eps\"], case[\"v2\"], case[\"G\"], case[\"N\"])\n        \n        max_delta = 0.0\n        for M_test in case[\"M_grid\"]:\n            for eta_test in case[\"eta_grid\"]:\n                E_test = calculate_projected_energy(M_test, eta_test, case[\"eps\"], case[\"v2\"], case[\"G\"], case[\"N\"])\n                if not np.isnan(E_test):\n                    delta = np.abs(E_test - E_ref)\n                    if delta > max_delta:\n                        max_delta = delta\n        \n        final_results.append(max_delta = case[\"tau\"])\n\n    print(f\"[{','.join(map(str, final_results))}]\")\n\nsolve()\n```"
        }
    ]
}