{
    "hands_on_practices": [
        {
            "introduction": "在我们进行复杂的数值模拟之前，必须首先理解将连续的物理理论转换到离散格点上会如何影响我们的结果。第一个练习旨在探讨离散化的基本后果，即考察自由粒子的能量。通过推导格点上的色散关系，你将能够量化立方格点如何破坏连续转动对称性，这是发展改进理论的关键第一步。",
            "id": "3567125",
            "problem": "考虑在晶格间距为 $a$ 且满足周期性边界条件 (PBC) 的三维立方空间晶格上，在有效场论 (EFT) 框架下表述的低能核动力学。研究对象为无相互作用的单核子扇区，其动力学由非相对论动能算符决定。连续谱自由粒子哈密顿量为 $H = -(\\hbar^{2}/2m)\\nabla^{2}$，其中 $m$ 是核子质量，$\\hbar$ 是普朗克常数除以 $2\\pi$。在晶格上，动能项由一个离散拉普拉斯算子定义，该算子的构造要求其精度达到 $\\mathcal{O}(a^2)$ 阶并保持立方对称性。\n\n从 $f(\\mathbf{r} \\pm a\\hat{\\mathbf{e}}_{i})$ 关于 $f(\\mathbf{r})$ 的泰勒展开出发，并根据离散拉普拉斯算子以 $\\mathcal{O}(a^2)$ 的截断误差逼近连续拉普拉斯算子 $\\nabla^{2}$ 的要求，构造三维晶格拉普拉斯算子的七点格式，并由此得到相应的晶格动能算符。使用该晶格算符，推导晶格动量为 $\\mathbf{k}$ 的平面波本征态 $\\psi(\\mathbf{r}) = \\exp(i\\mathbf{k}\\cdot\\mathbf{r})$ 的单粒子色散关系 $E(\\mathbf{k})$。\n\n为了量化晶格离散化引起的旋转对称性破缺，考虑两个大小相同（$|\\mathbf{k}| = k$）的动量：一个沿坐标轴方向，$\\mathbf{k}_{\\text{ax}} = (k, 0, 0)$；另一个沿体对角线方向，$\\mathbf{k}_{\\text{bd}} = (k/\\sqrt{3}, k/\\sqrt{3}, k/\\sqrt{3})$。定义无量纲各向异性度量\n$$\nR(x) = \\frac{E(\\mathbf{k}_{\\text{ax}}) - E(\\mathbf{k}_{\\text{bd}})}{E_{\\text{cont}}(k)},\n$$\n其中 $x = k a$，$E_{\\text{cont}}(k) = \\hbar^{2}k^{2}/(2m)$ 是连续谱色散关系。推导 $R(x)$ 的闭式表达式及其在 $x=0$ 附近的小 $x$ 级数展开。将展开式 $R(x) = c\\,x^{2} + \\mathcal{O}(x^4)$ 中的领头阶系数 $c$ 作为最终答案。最终答案应表示为一个无量纲的精确数，无需四舍五入。",
            "solution": "该问题陈述经核实具有科学依据，提法恰当且内容自洽。它描述了晶格场论中一个标准问题，涉及动能算符的离散化以及对由此产生的效应（特别是旋转对称性破缺）的分析。我们可以开始求解。\n\n第一步是构造离散晶格拉普拉斯算子，记为 $\\nabla^2_{\\text{lat}}$，它以 $\\mathcal{O}(a^2)$ 阶的截断误差逼近连续拉普拉斯算子 $\\nabla^2$，其中 $a$ 是晶格间距。我们考虑晶格上的一个标量函数 $f(\\mathbf{r})$，其中 $\\mathbf{r}$ 代表立方网格上的一个点。对于三个空间方向中的任意一个（用 $i \\in \\{1, 2, 3\\}$ 索引），我们在点 $\\mathbf{r}$ 周围对相邻格点 $\\mathbf{r} \\pm a\\hat{\\mathbf{e}}_i$ 处的函数 $f$ 进行泰勒级数展开，其中 $\\hat{\\mathbf{e}}_i$ 是沿第 $i$ 轴的单位向量。\n展开式为：\n$$f(\\mathbf{r} + a\\hat{\\mathbf{e}}_i) = f(\\mathbf{r}) + a \\frac{\\partial f}{\\partial r_i} + \\frac{a^2}{2!} \\frac{\\partial^2 f}{\\partial r_i^2} + \\frac{a^3}{3!} \\frac{\\partial^3 f}{\\partial r_i^3} + \\frac{a^4}{4!} \\frac{\\partial^4 f}{\\partial r_i^4} + \\mathcal{O}(a^5)$$\n$$f(\\mathbf{r} - a\\hat{\\mathbf{e}}_i) = f(\\mathbf{r}) - a \\frac{\\partial f}{\\partial r_i} + \\frac{a^2}{2!} \\frac{\\partial^2 f}{\\partial r_i^2} - \\frac{a^3}{3!} \\frac{\\partial^3 f}{\\partial r_i^3} + \\frac{a^4}{4!} \\frac{\\partial^4 f}{\\partial r_i^4} - \\mathcal{O}(a^5)$$\n将这两个方程相加，消去 $a$ 的奇次幂项：\n$$f(\\mathbf{r} + a\\hat{\\mathbf{e}}_i) + f(\\mathbf{r} - a\\hat{\\mathbf{e}}_i) = 2f(\\mathbf{r}) + a^2 \\frac{\\partial^2 f}{\\partial r_i^2} + \\frac{a^4}{12} \\frac{\\partial^4 f}{\\partial r_i^4} + \\mathcal{O}(a^6)$$\n整理此式以求解二阶偏导数，得到中心差分公式：\n$$\\frac{\\partial^2 f}{\\partial r_i^2} = \\frac{1}{a^2} \\left[ f(\\mathbf{r} + a\\hat{\\mathbf{e}}_i) + f(\\mathbf{r} - a\\hat{\\mathbf{e}}_i) - 2f(\\mathbf{r}) \\right] - \\frac{a^2}{12} \\frac{\\partial^4 f}{\\partial r_i^4} + \\mathcal{O}(a^4)$$\n领头误差项与 $a^2$ 成正比，因此该形式为 $\\frac{\\partial^2 f}{\\partial r_i^2}$ 提供了一个精度为 $\\mathcal{O}(a^2)$ 阶的近似。为了构造三维拉普拉斯算子 $\\nabla^2 = \\sum_{i=1}^3 \\frac{\\partial^2}{\\partial r_i^2}$，我们将 $i=1, 2, 3$ 的中心差分表达式相加：\n$$\\nabla^2 f(\\mathbf{r}) = \\frac{1}{a^2} \\sum_{i=1}^3 \\left[ f(\\mathbf{r} + a\\hat{\\mathbf{e}}_i) + f(\\mathbf{r} - a\\hat{\\mathbf{e}}_i) - 2f(\\mathbf{r}) \\right] + \\mathcal{O}(a^2)$$\n晶格拉普拉斯算子 $\\nabla^2_{\\text{lat}}$ 通过舍去误差项来定义：\n$$\\nabla^2_{\\text{lat}} f(\\mathbf{r}) = \\frac{1}{a^2} \\left( \\sum_{i=1}^3 \\left[ f(\\mathbf{r} + a\\hat{\\mathbf{e}}_i) + f(\\mathbf{r} - a\\hat{\\mathbf{e}}_i) \\right] - 6f(\\mathbf{r}) \\right)$$\n该算子使用中心点 $\\mathbf{r}$ 及其六个最近邻点的函数值，因此构成了所要求的七点格式。\n\n将 $\\nabla^2_{\\text{lat}}$ 代入连续谱表达式 $H = -(\\hbar^2/2m)\\nabla^2$，得到晶格上的非相对论动能算符 $H_{\\text{lat}}$：\n$$H_{\\text{lat}} = -\\frac{\\hbar^2}{2m} \\nabla^2_{\\text{lat}} = -\\frac{\\hbar^2}{2ma^2} \\left( \\sum_{i=1}^3 \\left[ T_i^+ + T_i^- \\right] - 6 \\right)$$\n其中 $T_i^{\\pm}$ 是平移算符，满足 $T_i^{\\pm} f(\\mathbf{r}) = f(\\mathbf{r} \\pm a\\hat{\\mathbf{e}}_i)$。\n\n接下来，我们通过求解平面波态 $\\psi(\\mathbf{r}) = \\exp(i\\mathbf{k}\\cdot\\mathbf{r})$ 下 $H_{\\text{lat}}$ 的本征值来推导单粒子色散关系 $E(\\mathbf{k})$。将平移算符作用于该态，得到：\n$$T_i^{\\pm} \\psi(\\mathbf{r}) = \\exp(i\\mathbf{k}\\cdot(\\mathbf{r} \\pm a\\hat{\\mathbf{e}}_i)) = \\exp(i\\mathbf{k}\\cdot\\mathbf{r}) \\exp(\\pm i a k_i) = \\psi(\\mathbf{r}) \\exp(\\pm i a k_i)$$\n因此，哈密顿量作用于平面波的结果是：\n$$H_{\\text{lat}} \\psi(\\mathbf{r}) = -\\frac{\\hbar^2}{2ma^2} \\left( \\sum_{i=1}^3 \\left[ \\exp(i a k_i) + \\exp(-i a k_i) \\right] - 6 \\right) \\psi(\\mathbf{r})$$\n使用恒等式 $2\\cos\\theta = e^{i\\theta} + e^{-i\\theta}$，我们简化括号中的表达式：\n$$H_{\\text{lat}} \\psi(\\mathbf{r}) = -\\frac{\\hbar^2}{2ma^2} \\left( \\sum_{i=1}^3 2\\cos(a k_i) - 6 \\right) \\psi(\\mathbf{r}) = \\frac{\\hbar^2}{ma^2} \\left( 3 - \\sum_{i=1}^3 \\cos(a k_i) \\right) \\psi(\\mathbf{r})$$\n本征值即为能量 $E(\\mathbf{k})$。使用恒等式 $1 - \\cos\\theta = 2\\sin^2(\\theta/2)$：\n$$E(\\mathbf{k}) = \\frac{\\hbar^2}{ma^2} \\sum_{i=1}^3 \\left(1 - \\cos(a k_i)\\right) = \\frac{2\\hbar^2}{ma^2} \\sum_{i=1}^3 \\sin^2\\left(\\frac{a k_i}{2}\\right)$$\n这就是晶格色散关系。\n\n现在，我们对两个指定的动量矢量 $\\mathbf{k}_{\\text{ax}} = (k, 0, 0)$ 和 $\\mathbf{k}_{\\text{bd}} = (k/\\sqrt{3}, k/\\sqrt{3}, k/\\sqrt{3})$ 计算该色散关系，其中 $|\\mathbf{k}_{\\text{ax}}| = |\\mathbf{k}_{\\text{bd}}| = k$。\n对于轴向动量 $\\mathbf{k}_{\\text{ax}}$，其分量为 $k_1=k, k_2=0, k_3=0$：\n$$E(\\mathbf{k}_{\\text{ax}}) = \\frac{2\\hbar^2}{ma^2} \\left[ \\sin^2\\left(\\frac{ak}{2}\\right) + \\sin^2(0) + \\sin^2(0) \\right] = \\frac{2\\hbar^2}{ma^2} \\sin^2\\left(\\frac{ak}{2}\\right)$$\n对于体对角线动量 $\\mathbf{k}_{\\text{bd}}$，其分量为 $k_1=k_2=k_3=k/\\sqrt{3}$：\n$$E(\\mathbf{k}_{\\text{bd}}) = \\frac{2\\hbar^2}{ma^2} \\sum_{i=1}^3 \\sin^2\\left(\\frac{ak}{2\\sqrt{3}}\\right) = \\frac{6\\hbar^2}{ma^2} \\sin^2\\left(\\frac{ak}{2\\sqrt{3}}\\right)$$\n各向异性度量 $R(x)$ 由 $x=ka$ 和连续谱能量 $E_{\\text{cont}}(k) = \\hbar^2 k^2/(2m) = \\hbar^2 x^2/(2ma^2)$ 定义。\n$$R(x) = \\frac{E(\\mathbf{k}_{\\text{ax}}) - E(\\mathbf{k}_{\\text{bd}})}{E_{\\text{cont}}(k)} = \\frac{\\frac{2\\hbar^2}{ma^2} \\sin^2\\left(\\frac{x}{2}\\right) - \\frac{6\\hbar^2}{ma^2} \\sin^2\\left(\\frac{x}{2\\sqrt{3}}\\right)}{\\frac{\\hbar^2 x^2}{2ma^2}}$$\n简化此表达式，我们得到 $R(x)$ 的闭式形式：\n$$R(x) = \\frac{4}{x^2} \\sin^2\\left(\\frac{x}{2}\\right) - \\frac{12}{x^2} \\sin^2\\left(\\frac{x}{2\\sqrt{3}}\\right) = \\frac{4}{x^2} \\left[ \\sin^2\\left(\\frac{x}{2}\\right) - 3\\sin^2\\left(\\frac{x}{2\\sqrt{3}}\\right) \\right]$$\n为了找到小 $x$ 的领头阶行为，我们展开正弦平方项。$\\sin^2(u)$ 在 $u=0$ 附近的泰勒级数为 $\\sin^2(u) = (u - u^3/6 + \\dots)^2 = u^2 - u^4/3 + \\mathcal{O}(u^6)$。\n对于第一项，令 $u=x/2$：\n$$\\sin^2\\left(\\frac{x}{2}\\right) = \\left(\\frac{x}{2}\\right)^2 - \\frac{1}{3}\\left(\\frac{x}{2}\\right)^4 + \\mathcal{O}(x^6) = \\frac{x^2}{4} - \\frac{x^4}{48} + \\mathcal{O}(x^6)$$\n对于第二项，令 $u=x/(2\\sqrt{3})$：\n$$3\\sin^2\\left(\\frac{x}{2\\sqrt{3}}\\right) = 3\\left[ \\left(\\frac{x}{2\\sqrt{3}}\\right)^2 - \\frac{1}{3}\\left(\\frac{x}{2\\sqrt{3}}\\right)^4 + \\mathcal{O}(x^6) \\right] = 3\\left[ \\frac{x^2}{12} - \\frac{x^4}{3 \\cdot 144} + \\mathcal{O}(x^6) \\right] = \\frac{x^2}{4} - \\frac{x^4}{144} + \\mathcal{O}(x^6)$$\n两者之差为：\n$$\\sin^2\\left(\\frac{x}{2}\\right) - 3\\sin^2\\left(\\frac{x}{2\\sqrt{3}}\\right) = \\left(\\frac{x^2}{4} - \\frac{x^4}{48}\\right) - \\left(\\frac{x^2}{4} - \\frac{x^4}{144}\\right) + \\mathcal{O}(x^6) = \\left(-\\frac{1}{48} + \\frac{1}{144}\\right)x^4 + \\mathcal{O}(x^6)$$\n$$= \\frac{-3+1}{144}x^4 + \\mathcal{O}(x^6) = -\\frac{2}{144}x^4 + \\mathcal{O}(x^6) = -\\frac{1}{72}x^4 + \\mathcal{O}(x^6)$$\n最后，我们将此结果代回 $R(x)$ 的表达式中：\n$$R(x) = \\frac{4}{x^2} \\left[ -\\frac{1}{72}x^4 + \\mathcal{O}(x^6) \\right] = -\\frac{4}{72}x^2 + \\mathcal{O}(x^4) = -\\frac{1}{18}x^2 + \\mathcal{O}(x^4)$$\n问题要求展开式 $R(x) = c\\,x^2 + \\mathcal{O}(x^4)$ 中的系数 $c$。通过比较，我们得到 $c = -1/18$。",
            "answer": "$$\\boxed{-\\frac{1}{18}}$$"
        },
        {
            "introduction": "格点有效场论模拟的核心在于使用诸如 Metropolis 算法之类的方法来生成重要的场构型。本练习聚焦于一个关键组成部分：为 Hubbard-Stratonovich 变换引入的辅助场实现高效的局域更新。你将应用矩阵行列式引理来推导并实现接收概率，这项技术避免了计算成本高昂的行列式，是现代格点量子色动力学和核物理模拟的基础。",
            "id": "3567111",
            "problem": "考虑一个用于原子核的格点有效场论 (EFT) 中的一维空间格点，其具有周期性边界条件和单一欧几里得时间片。具有吸引性接触相互作用的自旋为 $\\frac{1}{2}$ 的核子，通过使用带有连续高斯辅助场的 Hubbard–Stratonovich (HS) 变换进行解耦。辅助场表示为 $\\mathbf{s} = (s_0, s_1, \\dots, s_{L-1})$，其中 $L$ 是格点位置数，HS场的高斯测度导出的作用量形式为 $S_{\\mathrm{aux}}[\\mathbf{s}] = \\sum_{i=0}^{L-1} \\frac{s_i^2}{2\\sigma^2}$，其中 $\\sigma^2$ 是高斯分布的方差。\n\n在此单一时间片上，定义费米子矩阵 $M[\\mathbf{s}] \\in \\mathbb{R}^{L \\times L}$ 为\n$$\nM[\\mathbf{s}] \\equiv I + \\alpha \\Delta + \\lambda\\,\\mathrm{diag}(\\mathbf{s}),\n$$\n其中 $I$ 是 $L \\times L$ 单位矩阵，$\\alpha > 0$ 是一个动能耦合常数，$\\lambda$ 是与辅助场耦合的强度，$\\Delta$ 是具有周期性边界条件的一维离散拉普拉斯算子：\n$$\n\\Delta_{ij} =\n\\begin{cases}\n2  \\text{若 } i=j, \\\\\n-1  \\text{若 } j = i+1 \\mod L, \\\\\n-1  \\text{若 } j = i-1 \\mod L, \\\\\n0  \\text{其他情况}.\n\\end{cases}\n$$\n假设有 $N_f$ 个简并的费米子种类（例如，对于具有相同矩阵的上自旋和下自旋，$N_f = 2$），因此总费米子权重因子为 $\\big(\\det M[\\mathbf{s}]\\big)^{N_f}$。\n\n你将实现一个局域 Metropolis–Hastings (MH) 提议，该提议仅在单个位置 $i$ 处改变辅助场，提议\n$$\ns_i' = s_i + \\delta,\n$$\n而所有其他 $s_j$ 保持不变，其中提议机制关于 $s_i$ 对称（例如，以 $s_i$ 为中心的高斯分布）。接受概率必须从第一性原理出发进行推导，从带有 HS 变换的欧几里得路径积分表示开始，并使用适用于由 $s_i$ 的局域变化引起的对 $M[\\mathbf{s}]$ 的秩-1 更新的有效、通用的线性代数恒等式（例如矩阵行列式引理）。将接受概率用辅助场作用量的局域变化和费米子行列式的比值来表示，确保最终表达式对通用的 $N_f$ 有效，并避免显式计算行列式。\n\n实现的算法要求：\n- 你必须完全按照上面的定义构建 $M[\\mathbf{s}]$。\n- 你必须避免计算完整矩阵的逆或任何行列式。相反，通过求解单个线性系统 $M[\\mathbf{s}]\\,\\mathbf{x} = \\mathbf{e}_i$ 来仅计算所需的费米子格林函数 $G \\equiv M[\\mathbf{s}]^{-1}$ 的标量分量，其中 $\\mathbf{e}_i$ 是位置 $i$ 处的单位向量。使用此结果来表示由局域更新产生的行列式比值。\n- 接受概率必须用 $N_f$、$\\sigma^2$、$\\lambda$、$\\delta$ 以及从 $G$ 中得到的相关标量来表示。\n\n你的程序必须实现上述要求，并对以下每个测试用例评估接受概率。索引从零开始。当出现三角函数时，角度必须以弧度为单位。\n\n测试套件（每个用例定义了 $(L,\\alpha,\\lambda,N_f,\\sigma,\\mathbf{s},i,\\delta)$）：\n1. 正常流程用例：\n   - $L = 6$, $\\alpha = 0.15$, $\\lambda = 0.6$, $N_f = 2$, $\\sigma = 1.0$, $\\mathbf{s} = [0.1,-0.05,0.2,-0.1,0.0,0.05]$, $i = 3$, $\\delta = 0.1$。\n2. 边界动能用例 ($\\alpha = 0$)：\n   - $L = 6$, $\\alpha = 0.0$, $\\lambda = 0.7$, $N_f = 2$, $\\sigma = 1.0$, $\\mathbf{s} = [0.2,0.2,0.2,0.2,0.2,0.2]$, $i = 2$, $\\delta = -0.05$。\n3. 周期性边界的单味用例：\n   - $L = 8$, $\\alpha = 0.05$, $\\lambda = 1.0$, $N_f = 1$, $\\sigma = 1.0$, $\\mathbf{s}$ 由 $s_j = 0.1 \\cos\\!\\left(\\frac{2\\pi j}{L}\\right)$ 给出，其中 $j \\in \\{0,\\dots,7\\}$, $i = 7$, $\\delta = 0.2$。\n4. 零更新用例：\n   - $L = 4$, $\\alpha = 0.2$, $\\lambda = 0.3$, $N_f = 2$, $\\sigma = 1.0$, $\\mathbf{s} = [0.05,-0.05,0.03,-0.02]$, $i = 1$, $\\delta = 0.0$。\n5. 强辅助场惩罚项用例：\n   - $L = 10$, $\\alpha = 0.1$, $\\lambda = 0.9$, $N_f = 2$, $\\sigma = 0.5$, $\\mathbf{s} = [0.1,-0.05,0.08,-0.02,0.03,0.05,-0.04,0.06,-0.01,0.02]$, $i = 5$, $\\delta = -0.4$。\n\n输出规范：\n- 对于每个测试用例，将接受概率计算为浮点数。\n- 你的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，每个浮点数四舍五入到六位小数（例如，$[x_1,x_2,x_3,x_4,x_5]$，其中每个 $x_k$ 都四舍五入到六位小数）。\n\n你的解决方案必须以欧几里得路径积分和 Hubbard–Stratonovich 变换为基础，利用针对局域提议的费米子行列式比值推导出接受概率，然后实现上述算法步骤以生成所需的输出。",
            "solution": "该问题是有效的。它提出了一个在计算核物理领域，特别是格点有效场论中，适定且有科学依据的场景。它要求推导并实现对辅助场进行局域更新的 Metropolis-Hastings 接受概率。所提供的参数和定义清晰、一致且足以获得唯一且有意义的解。尽管一般问题描述中指出 $\\alpha > 0$，但一个测试用例使用了 $\\alpha = 0$。这被解释为探索一个有效的物理极限（静态极限），并不会使问题在数学上或物理上不一致。我们现在可以开始求解。\n\n理论框架始于配分函数 $Z$ 的欧几里得路径积分表示。在对费米子场进行积分并执行 Hubbard–Stratonovich (HS) 变换以解耦核子-核子相互作用后，配分函数表示为对辅助场构型 $\\mathbf{s} = (s_0, s_1, \\dots, s_{L-1})$ 的积分：\n$$\nZ = \\int \\mathcal{D}\\mathbf{s} \\, e^{-S_{\\mathrm{aux}}[\\mathbf{s}]} \\left(\\det M[\\mathbf{s}]\\right)^{N_f}\n$$\n其中 $S_{\\mathrm{aux}}[\\mathbf{s}] = \\sum_{i=0}^{L-1} \\frac{s_i^2}{2\\sigma^2}$ 是辅助场的高斯作用量，$M[\\mathbf{s}]$ 是费米子矩阵，$N_f$ 是简并费米子味的数目。表达式\n$$\nP(\\mathbf{s}) \\propto e^{-S_{\\mathrm{aux}}[\\mathbf{s}]} \\left(\\det M[\\mathbf{s}]\\right)^{N_f}\n$$\n定义了构型 $\\mathbf{s}$ 的平衡概率分布。我们使用 Metropolis–Hastings 算法生成一个对此分布进行抽样的构型马尔可夫链。\n\n对于对称提议分布，即从 $\\mathbf{s}$ 提议移动到 $\\mathbf{s'}$ 的概率与提议反向移动的概率相同，$g(\\mathbf{s} | \\mathbf{s'}) = g(\\mathbf{s'} | \\mathbf{s})$，接受概率 $A(\\mathbf{s} \\to \\mathbf{s'})$ 简化为：\n$$\nA(\\mathbf{s} \\to \\mathbf{s'}) = \\min\\left(1, \\frac{P(\\mathbf{s'})}{P(\\mathbf{s})}\\right)\n$$\n问题的核心是计算比率 $R = P(\\mathbf{s'})/P(\\mathbf{s})$。我们可以将此比率分为两个因子：一个来自辅助场作用量，另一个来自费米子行列式。\n$$\nR = \\frac{e^{-S_{\\mathrm{aux}}[\\mathbf{s'}]} \\left(\\det M[\\mathbf{s'}]\\right)^{N_f}}{e^{-S_{\\mathrm{aux}}[\\mathbf{s}]} \\left(\\det M[\\mathbf{s}]\\right)^{N_f}} = e^{-\\left(S_{\\mathrm{aux}}[\\mathbf{s'}] - S_{\\mathrm{aux}}[\\mathbf{s}]\\right)} \\left(\\frac{\\det M[\\mathbf{s'}]}{\\det M[\\mathbf{s}]}\\right)^{N_f}\n$$\n提议是在单个位置 $i$ 上的局域更新：$s_i' = s_i + \\delta$，而对于 $j \\neq i$，$s_j'=s_j$。\n\n首先，我们计算辅助作用量的变化，$\\Delta S_{\\mathrm{aux}} = S_{\\mathrm{aux}}[\\mathbf{s'}] - S_{\\mathrm{aux}}[\\mathbf{s}]$。\n$$\nS_{\\mathrm{aux}}[\\mathbf{s'}] = \\left(\\sum_{j \\neq i} \\frac{s_j^2}{2\\sigma^2}\\right) + \\frac{(s_i + \\delta)^2}{2\\sigma^2} = S_{\\mathrm{aux}}[\\mathbf{s}] - \\frac{s_i^2}{2\\sigma^2} + \\frac{s_i^2 + 2s_i\\delta + \\delta^2}{2\\sigma^2}\n$$\n因此，作用量的变化为：\n$$\n\\Delta S_{\\mathrm{aux}} = \\frac{2s_i\\delta + \\delta^2}{2\\sigma^2}\n$$\n比率 $R$ 中的第一个因子是 $e^{-\\Delta S_{\\mathrm{aux}}}$。\n\n其次，我们处理费米子行列式的比率。对 $s_i$ 的局域更新引起费米子矩阵 $M[\\mathbf{s}] = I + \\alpha \\Delta + \\lambda\\,\\mathrm{diag}(\\mathbf{s})$ 的变化。新矩阵为：\n$$\nM[\\mathbf{s'}] = I + \\alpha \\Delta + \\lambda\\,\\mathrm{diag}(s_0, \\dots, s_i + \\delta, \\dots, s_{L-1}) = M[\\mathbf{s}] + \\lambda \\delta \\, \\mathbf{e}_i \\mathbf{e}_i^T\n$$\n其中 $\\mathbf{e}_i$ 是在索引 $i$ 处为 1，其他位置为零的标准基列向量。这是一个形式为 $A' = A + \\mathbf{u}\\mathbf{v}^T$ 的秩-1 更新，其中 $A=M[\\mathbf{s}]$，$\\mathbf{u} = \\lambda\\delta\\,\\mathbf{e}_i$，且 $\\mathbf{v} = \\mathbf{e}_i$。\n\n我们应用矩阵行列式引理，该引理指出 $\\det(A + \\mathbf{u}\\mathbf{v}^T) = (1 + \\mathbf{v}^T A^{-1} \\mathbf{u})\\det(A)$。\n$$\n\\det M[\\mathbf{s'}] = \\left(1 + \\mathbf{e}_i^T (M[\\mathbf{s}])^{-1} (\\lambda\\delta\\,\\mathbf{e}_i)\\right) \\det M[\\mathbf{s}]\n$$\n令 $G[\\mathbf{s}] \\equiv (M[\\mathbf{s}])^{-1}$ 为费米子格林函数（传播子）。项 $\\mathbf{e}_i^T G[\\mathbf{s}] \\mathbf{e}_i$ 正是对角元 $G_{ii}[\\mathbf{s}]$。因此，行列式比值为：\n$$\n\\frac{\\det M[\\mathbf{s'}]}{\\det M[\\mathbf{s}]} = 1 + \\lambda\\delta\\,G_{ii}[\\mathbf{s}]\n$$\n这个优雅的结果避免了直接计算行列式这一计算上极为昂贵的任务。\n\n结合这两个部分，完整的比率 $R$ 是：\n$$\nR = e^{-\\frac{2s_i\\delta + \\delta^2}{2\\sigma^2}} \\left(1 + \\lambda\\delta\\,G_{ii}[\\mathbf{s}]\\right)^{N_f}\n$$\n如果项 $1 + \\lambda\\delta\\,G_{ii}[\\mathbf{s}]$ 为负，则表示提议的移动穿过了费米子矩阵的一个奇点，导致行列式符号的改变。在用于概率分布（必须为非负）的标准 Metropolis-Hastings 实现中，这样的移动将被拒绝。因此，如果 $R  0$，接受概率为 0。最终的接受概率是：\n$$\nA(\\mathbf{s} \\to \\mathbf{s'}) = \\min(1, \\max(0, R))\n$$\n根据问题的要求，我们不计算完整的逆矩阵 $G[\\mathbf{s}]$。相反，为了找到单个元素 $G_{ii}[\\mathbf{s}]$，我们求解线性方程组 $M[\\mathbf{s}]\\,\\mathbf{x} = \\mathbf{e}_i$。解向量 $\\mathbf{x}$ 是 $G[\\mathbf{s}]$ 的第 $i$ 列。所需的元素就是该向量的第 $i$ 个分量：$G_{ii}[\\mathbf{s}] = x_i$。\n\n每个测试用例的算法如下：\n1.  使用给定参数构造 $L \\times L$ 矩阵 $M[\\mathbf{s}] = I + \\alpha\\Delta + \\lambda\\,\\mathrm{diag}(\\mathbf{s})$。离散拉普拉斯算子 $\\Delta$ 的元素为 $\\Delta_{jj}=2$, $\\Delta_{j, j\\pm 1 \\pmod L} = -1$。\n2.  定义列向量 $\\mathbf{e}_i$。\n3.  求解线性系统 $M[\\mathbf{s}]\\,\\mathbf{x} = \\mathbf{e}_i$ 以得到 $\\mathbf{x}$。\n4.  提取所需的格林函数元素 $G_{ii}[\\mathbf{s}] = x_i$。\n5.  计算作用量变化 $\\Delta S_{\\mathrm{aux}} = (2s_i\\delta + \\delta^2)/(2\\sigma^2)$。\n6.  计算比率 $R = \\exp(-\\Delta S_{\\mathrm{aux}}) \\times (1 + \\lambda\\delta\\,G_{ii}[\\mathbf{s}])^{N_f}$。\n7.  计算接受概率 $A = \\min(1, \\max(0, R))$。\n\n现在为提供的测试套件实现此过程。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import solve\n\ndef solve_problem():\n    \"\"\"\n    Solves the problem for all test cases and prints the results.\n    \"\"\"\n\n    def construct_fermion_matrix(L, alpha, lam, s_vec):\n        \"\"\"Constructs the fermion matrix M[s].\"\"\"\n        # Initialize with the identity matrix part\n        M = np.identity(L)\n\n        # Add the kinetic term (alpha * Delta)\n        # The 1D Laplacian with periodic boundary conditions\n        if alpha != 0:\n            laplacian = np.zeros((L, L))\n            for i in range(L):\n                laplacian[i, i] = 2\n                laplacian[i, (i + 1) % L] = -1\n                laplacian[i, (i - 1 + L) % L] = -1\n            M += alpha * laplacian\n        \n        # Add the auxiliary field coupling term (lambda * diag(s))\n        M += lam * np.diag(s_vec)\n        \n        return M\n\n    def calculate_acceptance_prob(L, alpha, lam, Nf, sigma, s_vec, i, delta):\n        \"\"\"\n        Calculates the Metropolis-Hastings acceptance probability for a local update.\n        \"\"\"\n        # Handle the trivial case where there is no change.\n        if delta == 0.0:\n            return 1.0\n\n        #  1. Construct the fermion matrix M[s] for the current configuration.\n        M = construct_fermion_matrix(L, alpha, lam, s_vec)\n        \n        #  2. Solve for the required element of the Green's function, G_ii.\n        #  This is done by solving the linear system M*x = e_i.\n        e_i = np.zeros(L)\n        e_i[i] = 1.0\n        \n        try:\n            # The solution vector x is the i-th column of the inverse of M.\n            x = solve(M, e_i, assume_a='gen') \n        except np.linalg.LinAlgError:\n            # If the matrix is singular, the determinant is zero.\n            # The update would result in a det ratio of infinity or be ill-defined.\n            # Such moves are rejected.\n            return 0.0\n\n        # The required element G_ii is the i-th component of the solution vector.\n        G_ii = x[i]\n        \n        #  3. Calculate the ratio R = P(s') / P(s).\n        #  Change in the auxiliary field action.\n        s_i = s_vec[i]\n        delta_S_aux = (2 * s_i * delta + delta**2) / (2 * sigma**2)\n        \n        #  Ratio of fermion determinants.\n        det_ratio_term = 1 + lam * delta * G_ii\n        \n        # If the determinant ratio is negative, it implies a sign problem.\n        # A move from a positive-weight state to a negative-weight state is rejected.\n        if det_ratio_term  0:\n            return 0.0\n            \n        # Full ratio R\n        R = np.exp(-delta_S_aux) * (det_ratio_term ** Nf)\n\n        #  4. The acceptance probability is min(1, R).\n        # We must also ensure R is not negative, though handled above.\n        A = min(1.0, R)\n        \n        return A\n\n    test_cases = [\n        # 1. Happy path case\n        (6, 0.15, 0.6, 2, 1.0, np.array([0.1, -0.05, 0.2, -0.1, 0.0, 0.05]), 3, 0.1),\n        # 2. Boundary kinetic case (alpha = 0)\n        (6, 0.0, 0.7, 2, 1.0, np.array([0.2, 0.2, 0.2, 0.2, 0.2, 0.2]), 2, -0.05),\n        # 3. Single-flavor case with periodic boundary\n        (8, 0.05, 1.0, 1, 1.0, 0.1 * np.cos(2 * np.pi * np.arange(8) / 8), 7, 0.2),\n        # 4. Zero update case\n        (4, 0.2, 0.3, 2, 1.0, np.array([0.05, -0.05, 0.03, -0.02]), 1, 0.0),\n        # 5. Strong auxiliary penalty case\n        (10, 0.1, 0.9, 2, 0.5, np.array([0.1, -0.05, 0.08, -0.02, 0.03, 0.05, -0.04, 0.06, -0.01, 0.02]), 5, -0.4)\n    ]\n    \n    results = []\n    for case in test_cases:\n        L, alpha, lam, Nf, sigma, s_vec, i, delta = case\n        prob = calculate_acceptance_prob(L, alpha, lam, Nf, sigma, s_vec, i, delta)\n        results.append(prob)\n        \n    # Format the final output string\n    formatted_results = [f\"{res:.6f}\" for res in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve_problem()\n```"
        }
    ]
}