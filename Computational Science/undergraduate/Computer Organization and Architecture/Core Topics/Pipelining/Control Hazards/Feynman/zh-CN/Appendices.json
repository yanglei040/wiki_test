{
    "hands_on_practices": [
        {
            "introduction": "为了有效地缓解控制冒险，我们首先必须精确地量化其代价。这个基础练习将引导你分析一个经典的五级流水线，以确定单次分支预测错误所导致的确切周期惩罚。通过追踪预测错误被发现时流水线中的指令状态，你将对为何控制冒险对性能如此有害有一个具体而深刻的理解。",
            "id": "3630214",
            "problem": "一个单发射、五级精简指令集计算机 (RISC) 流水线在指令提取 (IF)、指令译码 (ID)、执行 (EX)、访存 (MEM) 和写回 (WB) 阶段执行指令。控制相关通过一个静态分支预测器来处理，该预测器总是预测分支为“跳转”。一个分支目标缓冲器 (BTB) 在 IF 阶段提供预测为“跳转”的目标地址，因此当预测正确时，指令提取会从目标地址继续进行而无需停顿。分支条件在 EX 阶段被解析，一旦发生预测错误，流水线中所有较新的指令都将被冲刷，并且在下一个周期将取指重定向到正确的路径。不存在架构级分支延迟槽，没有在 EX 之前提前解析目标或条件，也没有其他结构或数据冒险。\n\n考虑一个紧凑循环，其循环体以一个形成循环回边的单一条件后向分支结束。该循环执行 $n \\geq 1$ 次迭代，因此在头 $n-1$ 次迭代中分支结果为“跳转”，而在第 $n$ 次迭代中为“不跳转”以退出循环。在上述总是预测“跳转”的预测器下，唯一的预测错误发生在最后一次迭代中，当分支实际为“不跳转”时。假设循环体内没有其他分支。\n\n仅使用上述关于流水线分级和分支处理的基本原理，确定每个完整循环（即在全部 $n$ 次迭代中）所支付的总控制冒险惩罚（以周期为单位）。将您的答案表示为单个精确的整数周期数，并使用“周期”作为解释单位（不要在最终的方框答案中包含单位）。无需四舍五入。",
            "solution": "首先对问题进行验证，以确保其是自包含的、有科学依据且定义明确的。\n\n### 步骤 1：提取已知条件\n- **流水线结构**：一个单发射、五级 RISC 流水线，包含阶段：指令提取 (IF)、指令译码 (ID)、执行 (EX)、访存 (MEM) 和写回 (WB)。\n- **分支处理**：\n    - **预测器**：静态分支预测器，总是预测分支为“跳转”。\n    - **分支目标缓冲器 (BTB)**：在 IF 阶段提供预测为“跳转”的目标地址。\n    - **正确预测**：当“跳转”预测正确时，没有停顿。\n    - **解析**：分支条件在 EX 阶段被解析。\n    - **预测错误**：发生预测错误时，所有较新的指令都被冲刷，并在下一个周期重定向取指。\n- **排除项**：无架构级分支延迟槽，无 EX 阶段前的提前解析，无其他结构或数据冒险。\n- **场景**：一个执行 $n \\geq 1$ 次迭代的紧凑循环。\n- **循环分支**：循环体末尾的单一条件后向分支。\n- **分支结果**：\n    - 分支在头 $n-1$ 次迭代中为“跳转”。\n    - 分支在第 $n$ 次（最后一次）迭代中为“不跳转”。\n- **目标**：确定一次完整循环执行（即所有 $n$ 次迭代）的总控制冒险惩罚，以周期为单位。\n\n### 步骤 2：使用提取的已知条件进行验证\n- **有科学依据**：该问题描述了一个经典的五级 RISC 流水线，这是计算机组成与体系结构中的一个标准教学模型。静态分支预测、BTB 功能、流水线冲刷以及在 EX 阶段进行分支解析等概念都是基本且符合事实的原理。\n- **定义明确**：问题定义清晰。它提供了流水线和分支处理机制的所有必要参数，以计算一个特定、唯一的惩罚数值。\n- **客观性**：问题使用计算机体系结构领域的精确、标准术语进行陈述，没有任何主观性或模糊性。\n\n### 步骤 3：结论与行动\n该问题有效，因为它具有科学性、定义明确、客观且自包含。可以根据给定信息推导出确切的解决方案。\n\n### 求解过程\n\n整个循环的总控制冒险惩罚是每次分支实例所产生惩罚的总和。该循环包含一个分支，执行 $n$ 次。我们必须分析这 $n$ 次执行中每一次的惩罚。\n\n分支预测器是一个静态的“总是跳转”预测器。我们针对两种类型的分支结果评估其性能。\n\n1.  **头 $n-1$ 次迭代（正确预测的分支）**\n    在头 $n-1$ 次迭代中，后向分支发生跳转以继续循环。\n    - **预测**：总是跳转。\n    - **实际结果**：跳转。\n    - **结果**：预测正确。\n    问题陈述指明，“当预测正确时，指令提取会从目标地址继续进行而无需停顿。”这意味着每次正确预测的惩罚是 $0$ 个周期。\n    头 $n-1$ 次迭代的总惩罚是 $(n-1) \\times 0 = 0$ 个周期。\n\n2.  **第 $n$ 次迭代（预测错误的分支）**\n    在最后一次迭代中，分支不发生跳转以退出循环。\n    - **预测**：总是跳转。\n    - **实际结果**：不跳转。\n    - **结果**：预测不正确，导致预测错误。产生了一次惩罚。\n\n为了计算预测错误的惩罚，我们必须分析流水线的状态。分支指令的结果在 EX 阶段确定。EX 阶段是五级流水线的第 3 个阶段。\n\n设分支指令为 $B$。\n- **周期 $t$**：$B$ 处于 IF 阶段。预测器将其识别为分支并预测为“跳转”。分支目标缓冲器 (BTB) 提供目标地址，程序计数器 (PC) 更新为此目标地址。\n- **周期 $t+1$**：$B$ 进入 ID 阶段。来自（错误）预测的目标路径的第一条指令，我们称之为 $I_1$，进入 IF 阶段。\n- **周期 $t+2$**：$B$ 进入 EX 阶段。$I_1$ 进入 ID 阶段。来自错误路径的第二条指令 $I_2$ 进入 IF 阶段。在此周期结束时，EX 单元解析该分支，发现它实际未跳转。预测是错误的。\n\n在检测到预测错误时（周期 $t+2$ 结束时），流水线中有以下较新的、推测执行的指令必须被冲刷：\n- 处于 ID 阶段的指令 $I_1$。\n- 处于 IF 阶段的指令 $I_2$。\n\n这两条指令被丢弃。用于提取和译码它们所花费的 CPU 时间被浪费了。问题陈述指出，取指在下一个周期（即周期 $t+3$）被重定向到正确的路径。在周期 $t+3$，流水线将提取紧跟在分支指令之后的正确指令 $B+1$。\n\n惩罚是由于在错误路径上提取和处理指令而损失的周期数。这类指令的数量对应于分支解析阶段之前的流水线阶段数。\n- 分支解析阶段：EX（第 3 阶段）。\n- 前序阶段：IF（第 1 阶段）和 ID（第 2 阶段）。\n在 EX 阶段之前有 2 个阶段。因此，有 2 条指令被错误地提取并且必须被冲刷。这导致了 2 个周期的流水线气泡。\n\n单次预测错误的惩罚是 2 个周期。\n\n**总惩罚计算**\n\n整个循环执行的总惩罚是所有 $n$ 次分支执行的惩罚之和。\n$$ \\text{Total Penalty} = \\left( (n-1) \\times \\text{Penalty}_{\\text{correct prediction}} \\right) + \\left( 1 \\times \\text{Penalty}_{\\text{misprediction}} \\right) $$\n代入计算出的值：\n$$ \\text{Total Penalty} = \\left( (n-1) \\times 0 \\right) + \\left( 1 \\times 2 \\right) $$\n$$ \\text{Total Penalty} = 0 + 2 = 2 $$\n每个完整循环所支付的总控制冒险惩罚是 2 个周期，与迭代次数 $n$ 无关（对于 $n \\geq 1$）。",
            "answer": "$$\\boxed{2}$$"
        },
        {
            "introduction": "对于复杂的程序，静态预测器通常是不够的。本练习将深入探讨动态分支预测，通过研究一个广泛使用的预测器设计——2位饱和计数器——的行为。你将追踪该预测器在特定重复分支结果模式下的状态转换，从而计算其稳态下的预测错误率，并领会这些机制是如何随时间“学习”的。",
            "id": "3630181",
            "problem": "一个流水线处理器采用一个双峰$2$位饱和计数器分支预测器，其中单个预测器条目专用于单个静态分支。该预测器有$4$个状态，标记为$0$、$1$、$2$和$3$。当状态为$2$和$3$时，它预测为“跳转”（taken）；当状态为$0$和$1$时，它预测为“不跳转”（not-taken）。对于每个分支结果，如果是“跳转”结果，状态加$1$；如果是“不跳转”结果，状态减$1$，并分别在$3$和$0$处饱和。初始预测器状态是任意的。考虑该分支的一个重复结果模式，该模式包含$(k-2)$个连续的“跳转”结果，后面跟着$2$个连续的“不跳转”结果，以周期$k$重复，其中$k \\ge 2$。令$m(k)$表示稳态错误预测率，定义为在预测器在此重复序列下达到其周期性行为后，一个周期内的错误预测数除以$k$。请推导$m(k)$作为$k$的函数，并以单个闭式解析表达式的形式给出最终答案。无需四舍五入。答案是无量纲的。",
            "solution": "问题要求计算一个特定的双峰2位分支预测器，在一种重复的分支结果模式下的稳态错误预测率$m(k)$。分析过程需要确定预测器状态的周期性行为，并计算在该周期内的错误预测次数。\n\n首先，我们形式化地描述这个2位饱和计数器的模型。\n预测器的状态$S$可以是四个值之一：$S \\in \\{0, 1, 2, 3\\}$。\n预测规则如下：\n- 如果 $S \\in \\{0, 1\\}$，预测‘不跳转’(NT)。\n- 如果 $S \\in \\{2, 3\\}$，预测‘跳转’(T)。\n\n状态转换规则，给定当前状态$S$和分支结果$O$，会产生一个新状态$S'$：\n- 如果结果$O$是‘跳转’(T)，新状态为 $S' = \\min(S+1, 3)$。\n- 如果结果$O$是‘不跳转’(NT)，新状态为 $S' = \\max(S-1, 0)$。\n\n当预测结果与实际结果$O$不匹配时，就会发生错误预测。\n\n分支结果模式是一个周期为 $k \\ge 2$ 的序列，由 $(k-2)$ 个连续的‘跳转’结果和随后的 $2$ 个连续的‘不跳转’结果组成。该模式为 $(\\underbrace{\\text{T}, \\text{T}, \\dots, \\text{T}}_{k-2 \\text{ 次}}, \\text{NT}, \\text{NT})$。\n\n我们关心的是稳态错误预测率 $m(k)$，它等于稳定周期内一个周期中的错误预测次数除以周期长度 $k$。为了找到这个值，我们必须首先确定预测器进入的重复状态周期。设 $S_0$ 为稳态下一个周期开始时的状态。经过 $k$ 个分支后，状态必须返回到 $S_0$。我们将周期中第 $i$ 个分支后的状态表示为 $S_i$。稳态条件是 $S_k = S_0$。我们通过考虑 $k$ 的不同取值情况来分析这个问题。\n\n### 情况 1: $k=2$\n模式周期为 $k=2$。它包含 $(2-2)=0$ 个‘跳转’结果和 $2$ 个‘不跳转’结果。模式为 (NT, NT)。\n这个结果序列将使计数器状态趋向于 $0$。假设系统已达到稳态，该稳态必然是 $S_0=0$。\n- 从 $S_0=0$ 开始。预测为 NT。第一个结果是 NT。这是一个**正确**的预测。新状态是 $S_1 = \\max(0-1, 0) = 0$。\n- 状态是 $S_1=0$。预测为 NT。第二个结果是 NT。这是一个**正确**的预测。新状态是 $S_2 = \\max(0-1, 0) = 0$。\n最终状态是 $S_2=0$，等于初始状态 $S_0=0$。因此，稳态周期是一个恒定的状态 $S=0$。\n此周期内的错误预测次数为 $0$。\n错误预测率为 $m(2) = \\frac{0}{2} = 0$。\n\n### 情况 2: $k=3$\n模式周期为 $k=3$。它包含 $(3-2)=1$ 个‘跳转’结果和 $2$ 个‘不跳转’结果。模式为 (T, NT, NT)。\n该模式中 NT 的数量多于 T，这表明稳态将处于一个较低值的状态。我们来测试从 $S_0=0$ 开始的稳态周期。\n- 从 $S_0=0$ 开始。预测为 NT。第一个结果是 T。这是一个**错误预测**。新状态是 $S_1 = \\min(0+1, 3) = 1$。\n- 状态是 $S_1=1$。预测为 NT。第二个结果是 NT。这是一个**正确**的预测。新状态是 $S_2 = \\max(1-1, 0) = 0$。\n- 状态是 $S_2=0$。预测为 NT。第三个结果是 NT。这是一个**正确**的预测。新状态是 $S_3 = \\max(0-1, 0) = 0$。\n最终状态是 $S_3=0$，等于初始状态 $S_0=0$。这是一个稳定的周期。\n此周期内的错误预测次数为 $1$。\n错误预测率为 $m(3) = \\frac{1}{3}$。\n\n### 情况 3: $k \\ge 4$\n模式周期为 $k$，包含 $(k-2)$ 个‘跳转’结果和 $2$ 个‘不跳转’结果。\n我们来寻找稳态的初始状态 $S_0$。一个周期后的状态 $S_k$ 是 $S_0$ 和 $k$ 的函数。在 $(k-2)$ 个‘跳转’分支之后，状态变为 $S' = \\min(S_0 + k - 2, 3)$。在随后的 $2$ 个‘不跳转’分支之后，最终状态是 $S_k = \\max(S' - 2, 0) = \\max(\\min(S_0 + k - 2, 3) - 2, 0)$。\n对于稳态，我们必须有 $S_k = S_0$。\n我们假设计数器在‘跳转’序列中饱和，即 $S_0 + k - 2 \\ge 3$，这意味着 $S_0 \\ge 5-k$。如果这个条件成立，那么 $S' = 3$。关于 $S_0$ 的方程变为 $S_0 = \\max(3-2, 0) = 1$。\n这个解 $S_0=1$ 是自洽的，如果它满足假设 $S_0 \\ge 5-k$。代入 $S_0=1$，我们得到 $1 \\ge 5-k$，简化后为 $k \\ge 4$。\n因此，对于所有 $k \\ge 4$，存在一个从状态 $S_0=1$ 开始的稳态周期。（对于 $k=4$ 的情况，也存在一个从 $S_0=0$ 开始的周期，但两者都得出相同的错误预测数 $3$）。\n我们来追踪当 $k \\ge 4$ 时，从 $S_0=1$ 开始的一个周期的执行过程：\n- 第一个结果是 T。状态为 $S_0=1$（预测 NT）。这是一个**错误预测**。新状态是 $S_1 = \\min(1+1, 3) = 2$。\n- 第二个结果是 T。状态为 $S_1=2$（预测 T）。这是一个**正确**的预测。新状态是 $S_2 = \\min(2+1, 3) = 3$。\n- 对于接下来的 $(k-2)-2 = k-4$ 个‘跳转’结果，状态保持在 $S=3$（预测 T）。这些都是**正确**的预测。在所有 $(k-2)$ 个‘跳转’结果之后，状态为 $S_{k-2}=3$。\n- 第 $(k-1)$ 个结果是 NT。状态为 $S_{k-2}=3$（预测 T）。这是一个**错误预测**。新状态是 $S_{k-1} = \\max(3-1, 0) = 2$。\n- 第 $k$ 个结果是 NT。状态为 $S_{k-1}=2$（预测 T）。这是一个**错误预测**。新状态是 $S_k = \\max(2-1, 0) = 1$。\n最终状态是 $S_k=1$，等于初始状态 $S_0=1$。这证实了稳定周期的存在。\n一个周期内的错误预测总数是每一步错误预测的总和：$1 + 0 + 1 + 1 = 3$。\n对于 $k \\ge 4$，错误预测率为 $m(k) = \\frac{3}{k}$。\n\n### 结果总结\n综合所有情况的结果，稳态错误预测率 $m(k)$ 是一个关于 $k$ 的分段函数：\n- 当 $k=2$ 时，$m(2) = 0$。\n- 当 $k=3$ 时，$m(3) = \\frac{1}{3}$。\n- 当 $k \\ge 4$ 时，$m(k) = \\frac{3}{k}$。\n\n这可以用分段定义的形式表示为单个解析表达式。\n$$\nm(k) = \\begin{cases} 0  \\text{if } k=2 \\\\ \\frac{1}{k}  \\text{if } k=3 \\\\ \\frac{3}{k}  \\text{if } k \\ge 4 \\end{cases}\n$$\n请注意，当 $k=3$ 时，表达式 $1/k$ 得出 $1/3$，符合要求。",
            "answer": "$$\n\\boxed{\n\\begin{cases} 0 & k=2 \\\\ \\frac{1}{k} & k=3 \\\\ \\frac{3}{k} & k \\ge 4 \\end{cases}\n}\n$$"
        },
        {
            "introduction": "性能提升是硬件和软件协同作用的结果。这最后一个练习将探讨一种旨在降低控制冒险频率的编译器优化技术。通过比较一个含有多个出口分支的循环与一个重构后只含单个分支的版本，你将推导出确切的每指令周期数（CPI）降幅，并理解代码结构如何直接影响流水线效率。",
            "id": "3629874",
            "problem": "在一个标量、顺序、单发射流水线上，当没有提前退出时，一个循环体在每次稳态迭代中有 $n$ 条动态指令。在没有控制冒险的情况下，该流水线的基础每指令周期数 (CPI) 为 $C_{0}$。该循环包含 $k$ 个不同的提前退出测试，每个测试都实现为一个条件分支，分布在整个循环体中。假设退出很少发生，因此在稳态下，每次迭代中所有 $k$ 个分支通常都会在循环继续下一次迭代之前被执行。每个条件分支在每次动态执行时都有一个独立的错误预测概率 $p_{m}$，每次错误预测都会引入一个控制冒险，平均代价为 $C_{m}$ 个停顿周期（当分支被正确预测时，不会产生停顿周期）。不存在其他冒险或缓存未命中。\n\n为了最小化控制冒险，应用了一种转换：将 $k$ 个提前退出的分支替换为计算这 $k$ 个谓词并将其组合的顺序代码，然后在循环体末尾放置一个单一的条件分支，如果任何谓词为真，则执行退出。假设这个单一分支的每次发生错误预测的概率 $p_{m}$ 和错误预测代价 $C_{m}$ 与原始分支中的任何一个相同，并且增加的谓词计算仍在循环的 $n$ 条指令之内（即 $n$ 不变）。\n\n设转换前的每条指令的动态分支频率为 $f_{b} = k/n$，转换后的频率为 $f_{b}^{\\prime} = 1/n$。仅使用关于平均值和期望值的基本原理，推导转换前后的预期 CPI，用 $C_{0}$、$f_{b}$（或 $f_{b}^{\\prime}$）、$p_{m}$ 和 $C_{m}$ 表示。然后，提供 CPI 降低值 $\\Delta \\mathrm{CPI} = \\mathrm{CPI}_{\\text{before}} - \\mathrm{CPI}_{\\text{after}}$ 的单个闭式表达式，作为 $k$、$n$、$p_{m}$ 和 $C_{m}$ 的函数。\n\n你的最终答案必须是 $\\Delta \\mathrm{CPI}$ 的单个闭式解析表达式。不包括单位。无需进行数值四舍五入。",
            "solution": "问题陈述已经过验证，被认为是合理的。它在科学上基于计算机体系结构的原理，特别是流水线性能分析。该问题提法明确、客观，并包含推导唯一解所需的所有信息。\n\n核心任务是确定代码转换前后的预期每指令周期数 (CPI)，然后计算 CPI 的降低值。基本原理是，总 CPI 是基础 CPI 与由流水线停顿贡献的每指令额外周期的总和。\n$$ \\mathrm{CPI} = \\mathrm{CPI}_{\\text{base}} + \\mathrm{CPI}_{\\text{stall}} $$\n在此问题中，基础 CPI 已给出为 $C_{0}$，唯一的停顿来源是来自错误预测的条件分支的控制冒险。\n\n由停顿引起的 CPI 贡献可以从期望值的基本原理计算得出。每条指令的预期停顿周期数是可能导致停顿的事件频率、该事件发生时停顿发生的概率以及停顿的周期成本的乘积。\n对于分支指令，即：\n$$ \\mathrm{CPI}_{\\text{stall}} = (\\text{branch frequency}) \\times (\\text{misprediction probability}) \\times (\\text{misprediction penalty}) $$\n让我们将此原理应用于这两种情况。\n\n首先，我们分析转换*前*的流水线性能。\n循环体由 $n$ 条动态指令组成。\n它包含 $k$ 个不同的条件分支。\n动态分支频率 $f_{b}$ 是动态分支指令与总动态指令的比率。\n$$ f_{b} = \\frac{k}{n} $$\n每个分支的错误预测概率为 $p_{m}$，每次错误预测的惩罚为 $C_{m}$ 个停顿周期。\n对 CPI 的停顿贡献 $\\mathrm{CPI}_{\\text{stall, before}}$ 为：\n$$ \\mathrm{CPI}_{\\text{stall, before}} = f_{b} \\times p_{m} \\times C_{m} $$\n因此，转换前的总预期 CPI $\\mathrm{CPI}_{\\text{before}}$ 为：\n$$ \\mathrm{CPI}_{\\text{before}} = C_{0} + \\mathrm{CPI}_{\\text{stall, before}} = C_{0} + f_{b} p_{m} C_{m} $$\n用给定的变量 $k$ 和 $n$ 表示：\n$$ \\mathrm{CPI}_{\\text{before}} = C_{0} + \\frac{k}{n} p_{m} C_{m} $$\n\n其次，我们分析转换*后*的流水线性能。\n$k$ 个分支被一个单一的条件分支所取代。\n循环体中的动态指令总数 $n$ 保持不变。\n新的动态分支频率 $f_{b}^{\\prime}$ 为：\n$$ f_{b}^{\\prime} = \\frac{1}{n} $$\n这个单一分支具有相同的错误预测概率 $p_{m}$ 和惩罚 $C_{m}$。\n转换后对 CPI 的停顿贡献 $\\mathrm{CPI}_{\\text{stall, after}}$ 为：\n$$ \\mathrm{CPI}_{\\text{stall, after}} = f_{b}^{\\prime} \\times p_{m} \\times C_{m} $$\n因此，转换后的总预期 CPI $\\mathrm{CPI}_{\\text{after}}$ 为：\n$$ \\mathrm{CPI}_{\\text{after}} = C_{0} + \\mathrm{CPI}_{\\text{stall, after}} = C_{0} + f_{b}^{\\prime} p_{m} C_{m} $$\n用 $n$ 表示：\n$$ \\mathrm{CPI}_{\\text{after}} = C_{0} + \\frac{1}{n} p_{m} C_{m} $$\n\n最后，我们需要计算 CPI 降低值 $\\Delta \\mathrm{CPI}$，它被定义为转换前后 CPI 的差值。\n$$ \\Delta \\mathrm{CPI} = \\mathrm{CPI}_{\\text{before}} - \\mathrm{CPI}_{\\text{after}} $$\n代入上面推导出的表达式：\n$$ \\Delta \\mathrm{CPI} = \\left( C_{0} + \\frac{k}{n} p_{m} C_{m} \\right) - \\left( C_{0} + \\frac{1}{n} p_{m} C_{m} \\right) $$\n基础 CPI 项 $C_{0}$ 被消去：\n$$ \\Delta \\mathrm{CPI} = \\frac{k}{n} p_{m} C_{m} - \\frac{1}{n} p_{m} C_{m} $$\n提取公因式 $\\frac{p_{m} C_{m}}{n}$：\n$$ \\Delta \\mathrm{CPI} = \\left( \\frac{k}{n} - \\frac{1}{n} \\right) p_{m} C_{m} $$\n这可以简化为 CPI 降低值关于 $k$、$n$、$p_{m}$ 和 $C_{m}$ 的最终闭式表达式：\n$$ \\Delta \\mathrm{CPI} = \\frac{(k - 1) p_{m} C_{m}}{n} $$\n这个表达式表示由于每次循环迭代中执行的分支数量从 $k$ 个减少到 1 个，每条指令平均节省的停顿周期数。",
            "answer": "$$\\boxed{\\frac{(k-1)p_{m}C_{m}}{n}}$$"
        }
    ]
}