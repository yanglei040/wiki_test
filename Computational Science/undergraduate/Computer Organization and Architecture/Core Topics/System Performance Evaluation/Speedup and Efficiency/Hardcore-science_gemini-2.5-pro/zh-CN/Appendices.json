{
    "hands_on_practices": [
        {
            "introduction": "提升处理器性能的一个基本方法是减少执行程序所需的总时钟周期数。循环展开是一种经典的编译器优化技术，旨在通过减少循环控制分支指令的数量来降低总指令数（Instruction Count, IC）和分支开销。然而，这种优化并非没有代价：它会增加代码体积，可能导致指令缓存（I-cache）的命中率下降，从而增加平均每条指令的时钟周期数（Cycles Per Instruction, CPI）。本练习  提供了一个具体的场景，让您能够运用基本的性能公式 $T = \\text{IC} \\times \\text{CPI}$，量化分析循环展开在指令数、指令组合和缓存性能之间的复杂权衡，从而判断其是否真正带来了性能提升（即加速比 $S \\gt 1$）。",
            "id": "3679725",
            "problem": "一个程序在一个单发射、顺序执行的处理器核心上以固定的时钟频率执行一个包含 $N$ 次迭代的热点循环。每个原始循环迭代执行 $L$ 次加载操作、$A$ 次算术逻辑单元 (ALU) 操作和 $B$ 次分支操作。假设每种指令类型的每指令周期数 (CPI) 是恒定的，分别由 $\\mathrm{CPI}_{\\mathrm{load}}$、$\\mathrm{CPI}_{\\mathrm{ALU}}$ 和 $\\mathrm{CPI}_{\\mathrm{branch}}$ 给出。指令缓存 (I-cache) 会带来每条指令额外的停顿周期，其模型为 $r \\cdot p$，其中 $r$ 是指令缓存的未命中率（单位：每次指令的未命中次数），$p$ 是未命中惩罚（单位：每次未命中的周期数）。假设数据侧的行为以及所有其他微架构特性在不同版本之间保持不变。使用基础定义\n$$\n\\mathrm{CPI}_{\\text{total}} \\;=\\; \\sum_{i \\in \\{\\text{load}, \\text{ALU}, \\text{branch}\\}} f_i \\cdot \\mathrm{CPI}_i \\;+\\; r \\cdot p,\n$$\n其中 $f_i$ 是执行指令组合中指令类型 $i$ 的动态比例，且在固定频率下，执行时间与 $\\text{IC} \\cdot \\mathrm{CPI}_{\\text{total}}$ 成正比，其中 $\\text{IC}$ 是动态指令数。加速比 $S$ 定义为 $S \\;=\\; T_{\\text{original}} / T_{\\text{unrolled}}$。\n\n考虑以下具体场景：\n- 每个原始循环迭代体：$L = 3$，$A = 4$，$B = 1$（因此每次迭代有 8 条指令）。\n- 各指令类型的 CPI：$\\mathrm{CPI}_{\\mathrm{load}} = 1.2$，$\\mathrm{CPI}_{\\mathrm{ALU}} = 1.0$，$\\mathrm{CPI}_{\\mathrm{branch}} = 3.0$。\n- 原始版本的指令缓存未命中率和惩罚：$r_{\\text{orig}} = 0.01$，$p = 10$。\n- 编译器以因子 $U = 4$ 展开循环，复制循环体并将动态分支数减少为原来的 $1/U$，同时保持每个原始迭代的 $L$ 和 $A$ 不变。假设 $N$ 可被 $U$ 整除，并忽略任何余数处理。\n- 由于代码体积增加，展开后版本的指令缓存未命中率上升至 $r_{\\text{unroll}} = 0.03$；$p$ 保持不变。\n\n在这些假设下，并且仅使用上述定义，展开后版本相对于原始版本所实现的加速比 $S$ 最接近以下哪个选项的值？\n\nA. $S \\approx 1.08$\n\nB. $S \\approx 0.95$\n\nC. $S \\approx 1.00$\n\nD. $S \\approx 1.15$",
            "solution": "推导必须从基础定义出发。首先，在固定的时钟频率下，执行时间 $T$ 与 $\\text{IC} \\cdot \\mathrm{CPI}_{\\text{total}}$ 成正比。因此，加速比 $S$ 可以写为\n$$\nS \\;=\\; \\frac{T_{\\text{original}}}{T_{\\text{unrolled}}} \\;=\\; \\frac{\\text{IC}_{\\text{orig}} \\cdot \\mathrm{CPI}_{\\text{orig}}}{\\text{IC}_{\\text{unroll}} \\cdot \\mathrm{CPI}_{\\text{unroll}}}.\n$$\n我们为每个版本计算动态指令混合比例 $f_i$ 和总 CPI，然后计算 $\\text{IC} \\cdot \\mathrm{CPI}$ 的比率。\n\n原始版本：\n- 每次迭代的指令数：加载 $= L = 3$，ALU $= A = 4$，分支 $= B = 1$，总计 $= 3 + 4 + 1 = 8$ 条指令。\n- 比例：$f_{\\text{load,orig}} = 3/8 = 0.375$，$f_{\\text{ALU,orig}} = 4/8 = 0.5$，$f_{\\text{branch,orig}} = 1/8 = 0.125$。\n- 每条指令的指令缓存停顿：$r_{\\text{orig}} \\cdot p = 0.01 \\cdot 10 = 0.1$。\n- 总 CPI：\n$$\n\\mathrm{CPI}_{\\text{orig}} \\;=\\; 0.375 \\cdot 1.2 \\;+\\; 0.5 \\cdot 1.0 \\;+\\; 0.125 \\cdot 3.0 \\;+\\; 0.1 \\;=\\; 0.45 \\;+\\; 0.5 \\;+\\; 0.375 \\;+\\; 0.1 \\;=\\; 1.425.\n$$\n- 每个原始迭代的动态指令数为 $8$。在 $N$ 次迭代中，$\\text{IC}_{\\text{orig}} = 8N$。\n\n展开后版本 ($U = 4$)：\n- 每个原始迭代的加载和 ALU 操作总数保持不变：加载 $= 3$，ALU $= 4$。\n- 每个原始迭代的分支数减少为原来的 $1/U$：分支 $= 1/4 = 0.25$。\n- 展开后每个原始迭代的总指令数：$3 + 4 + 0.25 = 7.25$，因此 $\\text{IC}_{\\text{unroll}} = 7.25N$。\n- 比例：$f_{\\text{load,unroll}} = 3/7.25 \\approx 0.413793$，$f_{\\text{ALU,unroll}} = 4/7.25 \\approx 0.551724$，$f_{\\text{branch,unroll}} = 0.25/7.25 \\approx 0.0344828$。\n- 每条指令的指令缓存停顿：$r_{\\text{unroll}} \\cdot p = 0.03 \\cdot 10 = 0.3$。\n- 总 CPI：\n$$\n\\mathrm{CPI}_{\\text{unroll}} \\;=\\; 0.413793 \\cdot 1.2 \\;+\\; 0.551724 \\cdot 1.0 \\;+\\; 0.0344828 \\cdot 3.0 \\;+\\; 0.3.\n$$\n计算各项：\n$$\n0.413793 \\cdot 1.2 \\approx 0.4965516,\\quad 0.551724 \\cdot 1.0 = 0.551724,\\quad 0.0344828 \\cdot 3.0 \\approx 0.1034484.\n$$\n求和：\n$$\n\\mathrm{CPI}_{\\text{unroll}} \\;\\approx\\; 0.4965516 \\;+\\; 0.551724 \\;+\\; 0.1034484 \\;+\\; 0.3 \\;=\\; 1.451724.\n$$\n\n现在计算加速比：\n$$\nS \\;=\\; \\frac{\\text{IC}_{\\text{orig}} \\cdot \\mathrm{CPI}_{\\text{orig}}}{\\text{IC}_{\\text{unroll}} \\cdot \\mathrm{CPI}_{\\text{unroll}}} \\;=\\; \\frac{8N \\cdot 1.425}{7.25N \\cdot 1.451724} \\;=\\; \\frac{8 \\cdot 1.425}{7.25 \\cdot 1.451724}.\n$$\n计算分子：$8 \\cdot 1.425 = 11.4$。\n计算分母：$7.25 \\cdot 1.451724 \\approx 10.525$。\n因此，\n$$\nS \\;\\approx\\; \\frac{11.4}{10.525} \\;\\approx\\; 1.083.\n$$\n在选项中，这个值最接近 $1.08$。\n\n从第一性原理进行概念性讨论：循环展开减少了动态分支指令，从而降低了动态指令数，并将指令组合的重心转向加载和ALU操作。这减少了分支对 $\\mathrm{CPI}_{\\text{total}}$ 和 $\\text{IC}$ 的贡献，但更大的代码量会增加指令缓存的未命中率，提高了停顿项 $r \\cdot p$，并可能增加 $\\mathrm{CPI}_{\\text{total}}$。在这个模型中，展开能提高速度（即 $S > 1$）的条件是乘积 $\\text{IC}_{\\text{unroll}} \\cdot \\mathrm{CPI}_{\\text{unroll}}$ 小于 $\\text{IC}_{\\text{orig}} \\cdot \\mathrm{CPI}_{\\text{orig}}$。在本例中，这个条件成立，因为虽然 $\\mathrm{CPI}$ 略有增加（从 $1.425$ 增加到 $1.451724$），但动态指令数的减少幅度更大（从 $8N$ 减少到 $7.25N$），最终实现了总周期数的净减少。\n\n逐个选项分析：\n- A. $S \\approx 1.08$。根据计算，$S \\approx 1.083$，因此这个选项是正确的。\n- B. $S \\approx 0.95$。这表示性能下降（$S  1$），与计算出的 $S \\approx 1.083$ 相矛盾。不正确。\n- C. $S \\approx 1.00$。这表示性能没有变化，但计算出的加速比大于 1。不正确。\n- D. $S \\approx 1.15$。这高估了收益；我们计算出的值要低得多。不正确。",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "处理器的实际性能在很大程度上受限于内存访问延迟，而平均内存访问时间（Average Memory Access Time, AMAT）是衡量内存层次结构效率的关键指标。现代处理器使用虚拟内存，这引入了地址转换的开销，而页表大小的选择是影响该开销的核心因素。本练习  引导您探讨使用小页面（如 $4$ KB）与大页面（如 $2$ MB）的性能差异，这正是在操作系统和体系结构设计中面临的真实权衡。通过计算不同工作负载下的AMAT，您将亲身体会到大页面在减少地址转换旁路缓冲（TLB）未命中方面的优势，以及它可能因内部碎片化而导致数据缓存污染的潜在弊端。",
            "id": "3679623",
            "problem": "一个处理器通过转换后备缓冲区 (Translation Lookaside Buffer, TLB) 实现虚拟内存转换。工作负载在两种模式之间交替：一种是顺序扫描数组的流模式，另一种是在大内存占用空间上执行独立随机内存访问的随机模式。您将比较使用大小为 $P_{s} = 4$ KB 的小页面与大小为 $P_{h} = 2$ MB 的大页面对净平均内存访问时间 (Average Memory Access Time, AMAT) 和加速比的影响。\n\n系统参数和假设：\n- 转换后备缓冲区 (TLB) 有 $E = 128$ 个全相联条目。TLB 命中时的查找延迟为 $t_{\\mathrm{TLB}} = 0.5$ ns。TLB 未命中时，硬件页表遍历会产生额外的 $t_{\\mathrm{walk}} = 80$ ns 延迟，并且不发生页面错误。\n- 一级 (L1) 数据缓存的行大小为 $B = 64$ 字节，容量为 $C_{L1} = 64$ KB，命中延迟为 $t_{L1} = 1$ ns。\n- 二级 (L2) 缓存的容量为 $C_{L2} = 8$ MB，命中延迟为 $t_{L2} = 8$ ns。如果 L2 缓存未命中，访问将转到主内存，产生额外的 $t_{\\mathrm{mem}} = 60$ ns 延迟。\n- 缓存是包容性的、全相联的，并使用一种替换策略，在独立均匀随机引用下，其稳态命中概率等于缓存容量与内存占用空间的比率。\n- 在流模式下，程序顺序读取一个大小为 $W_{s} = 64$ MB 的数组，按顺序触及每个缓存行的恰好一个字。假设没有重用；一旦某行被使用，就不会再次引用。\n- 在随机模式下，程序在大小为 $W_{r} = 512$ MB 的内存占用空间上发出独立均匀的随机引用。\n- 对于随机模式下的大页面，由于页面着色约束和内部碎片化导致更集中的组使用，通过将可用 L2 容量有效减少 $20$ 个百分点来模拟缓存污染。对于小页面，使用完整的 L2 容量。\n- 处理器在每次数据访问完成前完全停顿，并且每条引退指令有一次数据访问。\n\n任务：\n1. 计算流模式和随机模式下两种页面大小的净 AMAT（单位：纳秒）。使用从给定假设中推导出的科学合理模型来评估每种情况下的 TLB 未命中率和缓存未命中率。\n2. 将每种模式下大页面相对于小页面的加速比定义为使用小页面的 AMAT 与使用大页面的 AMAT 之比，并将吞吐量视为与 AMAT 成反比。\n\n将每个 AMAT 四舍五入到四位有效数字，并以 ns 表示。将每个加速比四舍五入到三位有效数字，作为一个无单位的小数。在您的最终答案中，按以下顺序提供一个包含六个条目的行矩阵：$\\text{AMAT}_{\\text{stream, small}}, \\text{AMAT}_{\\text{stream, huge}}, \\text{speedup}_{\\text{stream}}, \\text{AMAT}_{\\text{random, small}}, \\text{AMAT}_{\\text{random, huge}}, \\text{speedup}_{\\text{random}}$。",
            "solution": "问题要求在两种不同的虚拟内存页面大小配置（小页面和大页面）下，为两种不同的工作负载（流模式和随机模式）计算平均内存访问时间 (AMAT) 和加速比。\n\n首先，我们建立总 AMAT 的基本模型。问题指出，处理器在每次数据访问时完全停顿。这意味着地址转换时间和数据访问时间是顺序且可相加的。因此，总 AMAT 是转换的 AMAT 与数据访问本身的 AMAT之和。\n$$ \\text{AMAT}_{\\text{total}} = \\text{AMAT}_{\\text{trans}} + \\text{AMAT}_{\\text{data}} $$\n\n地址转换的 AMAT ($\\text{AMAT}_{\\text{trans}}$) 取决于转换后备缓冲区 (TLB)。一次访问可能是 TLB 命中或 TLB 未命中。\n$$ \\text{AMAT}_{\\text{trans}} = t_{\\mathrm{TLB}} + m_{\\mathrm{TLB}} \\times t_{\\mathrm{walk}} $$\n其中 $t_{\\mathrm{TLB}} = 0.5$ ns 是 TLB 查找延迟，$m_{\\mathrm{TLB}}$ 是 TLB 未命中率，$t_{\\mathrm{walk}} = 80$ ns 是页表遍历的未命中惩罚。\n\n数据访问的 AMAT ($\\text{AMAT}_{\\text{data}}$) 取决于缓存层次结构。我们使用标准的基于惩罚的 AMAT 模型。\n$$ \\text{AMAT}_{\\text{data}} = t_{\\mathrm{L1}} + m_{\\mathrm{L1}} \\times (\\text{L1 Miss Penalty}) $$\nL1 未命中惩罚是从内存层次结构的下一级（即 L2 缓存）服务该未命中的时间。这个时间本身也是一个 AMAT，即 $\\text{AMAT}_{\\mathrm{L2}}$。\n$$ \\text{AMAT}_{\\mathrm{L2}} = t_{\\mathrm{L2}} + m_{\\mathrm{L2,local}} \\times (\\text{L2 Miss Penalty}) $$\nL2 未命中惩罚是访问主内存的额外延迟 $t_{\\mathrm{mem}}$。所以，代入回去：\n$$ \\text{AMAT}_{\\text{data}} = t_{\\mathrm{L1}} + m_{\\mathrm{L1}} \\times (t_{\\mathrm{L2}} + m_{\\mathrm{L2,local}} \\times t_{\\mathrm{mem}}) $$\n这里，$t_{\\mathrm{L1}} = 1$ ns，$t_{\\mathrm{L2}} = 8$ ns，$t_{\\mathrm{mem}} = 60$ ns，$m_{\\mathrm{L1}}$ 是 L1 全局未命中率，$m_{\\mathrm{L2,local}}$ 是 L2 局部未命中率（L2 中的未命中次数除以对 L2 的访问次数，即 L1 的未命中次数）。\n\n我们现在将分析四个指定的场景。\n\n**1. 流模式，小页面 ($P_s = 4$ KB)**\n\n在流模式下，程序顺序读取一个大小为 $W_s = 64$ MB ($2^{26}$ 字节) 的数组，每个缓存行 ($B = 64$ 字节，或 $2^6$ 字节) 访问一个字。\n\n*   **TLB 未命中率 ($m_{\\mathrm{TLB},s,s}$):**\n    每次访问都是针对一个新的缓存行。每个小页面 ($P_s = 4$ KB $= 2^{12}$ 字节) 的访问次数是 $P_s / B = 2^{12} / 2^6 = 2^6 = 64$。\n    由于访问模式是线性扫描，并且总页面数 ($W_s / P_s = 2^{26} / 2^{12} = 2^{14} = 16384$) 远超 TLB 容量 ($E = 128$)，因此每个新页面都需要一次新的页面转换。这导致每个新页面都有一次强制性 TLB 未命中。在一个页面内，有 $64$ 次访问。因此，每 $64$ 次访问就有 $1$ 次 TLB 未命中。\n    $$ m_{\\mathrm{TLB},s,s} = \\frac{1}{64} = 0.015625 $$\n*   **缓存未命中率：**\n    访问模式在没有重用的情况下精确地触及每个缓存行一次。这导致 L1 和 L2 缓存中的每一次访问都会发生强制性未命中，因为工作集 ($W_s=64$ MB) 远大于两个缓存的容量 ($C_{L1}=64$ KB, $C_{L2}=8$ MB)。\n    $$ m_{\\mathrm{L1},s,s} = 1 $$\n    由于每次 L1 未命中也是一次 L2 未命中，因此 L2 的局部未命中率也为 $1$。\n    $$ m_{\\mathrm{L2,local},s,s} = 1 $$\n*   **AMAT 计算 ($\\text{AMAT}_{\\text{stream, small}}$):**\n    $$ \\text{AMAT}_{\\text{trans}} = 0.5 + \\frac{1}{64} \\times 80 = 0.5 + 1.25 = 1.75 \\text{ ns} $$\n    $$ \\text{AMAT}_{\\text{data}} = 1 + 1 \\times (8 + 1 \\times 60) = 1 + 8 + 60 = 69 \\text{ ns} $$\n    $$ \\text{AMAT}_{\\text{stream, small}} = 1.75 + 69 = 70.75 \\text{ ns} $$\n\n**2. 流模式，大页面 ($P_h = 2$ MB)**\n\n工作负载相同，但页面大小现在是 $P_h = 2$ MB ($2^{21}$ 字节)。\n\n*   **TLB 未命中率 ($m_{\\mathrm{TLB},s,h}$):**\n    工作负载中的总页面数为 $W_s / P_h = 2^{26} / 2^{21} = 2^5 = 32$。\n    由于这个数量小于 TLB 的容量 $E = 128$，所有页面转换在它们最初的强制性未命中后都将装入 TLB。\n    总访问次数：$W_s / B = 2^{26} / 2^6 = 2^{20}$。\n    总 TLB 未命中次数：$32$。\n    $$ m_{\\mathrm{TLB},s,h} = \\frac{32}{2^{20}} = \\frac{2^5}{2^{20}} = 2^{-15} = \\frac{1}{32768} $$\n*   **缓存未命中率：**\n    在此流模式模型中，缓存性能不受页面大小的影响。\n    $$ m_{\\mathrm{L1},s,h} = 1, \\quad m_{\\mathrm{L2,local},s,h} = 1 $$\n*   **AMAT 计算 ($\\text{AMAT}_{\\text{stream, huge}}$):**\n    $$ \\text{AMAT}_{\\text{trans}} = 0.5 + \\frac{1}{32768} \\times 80 \\approx 0.5 + 0.0024414 = 0.5024414 \\text{ ns} $$\n    $$ \\text{AMAT}_{\\text{data}} = 69 \\text{ ns} $$\n    $$ \\text{AMAT}_{\\text{stream, huge}} = 0.5024414 + 69 = 69.5024414 \\text{ ns} $$\n\n**3. 随机模式，小页面 ($P_s = 4$ KB)**\n\n工作负载由在 $W_r = 512$ MB ($2^{29}$ 字节) 的内存占用空间上的随机访问组成。\n\n*   **TLB 未命中率 ($m_{\\mathrm{TLB},r,s}$):**\n    不同页面的数量为 $N_{\\text{pages}} = W_r / P_s = 2^{29} / 2^{12} = 2^{17} = 131072$。\n    对于一个在随机工作负载下使用随机替换策略的全相联结构，命中概率是容量与内存占用空间大小的比率。TLB 充当页表条目的缓存。\n    $$ P(\\text{TLB hit}) = \\frac{E}{N_{\\text{pages}}} = \\frac{128}{131072} = \\frac{2^7}{2^{17}} = 2^{-10} = \\frac{1}{1024} $$\n    $$ m_{\\mathrm{TLB},r,s} = 1 - P(\\text{TLB hit}) = 1 - \\frac{1}{1024} = \\frac{1023}{1024} $$\n*   **缓存未命中率：**\n    我们对缓存应用相同的容量/内存占用空间比率模型。\n    $$ P(\\text{L1 hit}) = \\frac{C_{\\mathrm{L1}}}{W_r} = \\frac{64 \\text{ KB}}{512 \\text{ MB}} = \\frac{2^{16}}{2^{29}} = 2^{-13} = \\frac{1}{8192} $$\n    $$ m_{\\mathrm{L1},r,s} = 1 - \\frac{1}{8192} = \\frac{8191}{8192} $$\n    由于包容性，L2 未命中意味着 L1 未命中。局部 L2 未命中率是 $m_{\\mathrm{L2,local}} = P(\\text{not in L2} | \\text{not in L1}) = \\frac{P(\\text{not in L2})}{P(\\text{not in L1})}$。\n    $$ P(\\text{not in L2}) = 1 - \\frac{C_{\\mathrm{L2}}}{W_r} = 1 - \\frac{8 \\text{ MB}}{512 \\text{ MB}} = 1 - \\frac{2^{23}}{2^{29}} = 1-\\frac{1}{64} = \\frac{63}{64} $$\n    $$ m_{\\mathrm{L2,local},r,s} = \\frac{1 - C_{\\mathrm{L2}}/W_r}{1 - C_{\\mathrm{L1}}/W_r} = \\frac{63/64}{8191/8192} = \\frac{63}{64} \\times \\frac{8192}{8191} = \\frac{8064}{8191} $$\n*   **AMAT 计算 ($\\text{AMAT}_{\\text{random, small}}$):**\n    $$ \\text{AMAT}_{\\text{trans}} = 0.5 + \\frac{1023}{1024} \\times 80 = 0.5 + 79.921875 = 80.421875 \\text{ ns} $$\n    $$ \\text{AMAT}_{\\text{data}} = 1 + \\frac{8191}{8192} \\times \\left( 8 + \\frac{8064}{8191} \\times 60 \\right) = 1 + \\frac{8191}{8192} \\times 8 + \\frac{8064}{8192} \\times 60 $$\n    $$ \\text{AMAT}_{\\text{data}} = 1 + 7.9990234375 + \\frac{63}{64} \\times 60 = 1 + 7.9990234375 + 59.0625 = 68.0615234375 \\text{ ns} $$\n    $$ \\text{AMAT}_{\\text{random, small}} = 80.421875 + 68.0615234375 = 148.4833984375 \\text{ ns} $$\n\n**4. 随机模式，大页面 ($P_h = 2$ MB)**\n\n工作负载是相同的随机模式，但使用大页面。\n\n*   **TLB 未命中率 ($m_{\\mathrm{TLB},r,h}$):**\n    页面数：$N_{\\text{pages}} = W_r / P_h = 512 \\text{ MB} / 2 \\text{ MB} = 256$。\n    $$ P(\\text{TLB hit}) = \\frac{E}{N_{\\text{pages}}} = \\frac{128}{256} = \\frac{1}{2} $$\n    $$ m_{\\mathrm{TLB},r,h} = 1 - \\frac{1}{2} = \\frac{1}{2} $$\n*   **缓存未命中率：**\n    L1 性能不变：$m_{\\mathrm{L1},r,h} = \\frac{8191}{8192}$。\n    L2 容量有效减少 $20\\%$。$C'_{\\mathrm{L2}} = 0.8 \\times C_{\\mathrm{L2}} = 0.8 \\times 8 \\text{ MB} = 6.4$ MB。\n    $$ P(\\text{not in L2}) = 1 - \\frac{C'_{\\mathrm{L2}}}{W_r} = 1 - \\frac{6.4 \\text{ MB}}{512 \\text{ MB}} = 1 - \\frac{6.4}{512} = 1 - \\frac{1}{80} = \\frac{79}{80} $$\n    $$ m_{\\mathrm{L2,local},r,h} = \\frac{1 - C'_{\\mathrm{L2}}/W_r}{1 - C_{\\mathrm{L1}}/W_r} = \\frac{79/80}{8191/8192} = \\frac{79}{80} \\times \\frac{8192}{8191} = \\frac{8089.6}{8191} $$\n*   **AMAT 计算 ($\\text{AMAT}_{\\text{random, huge}}$):**\n    $$ \\text{AMAT}_{\\text{trans}} = 0.5 + \\frac{1}{2} \\times 80 = 0.5 + 40 = 40.5 \\text{ ns} $$\n    $$ \\text{AMAT}_{\\text{data}} = 1 + \\frac{8191}{8192} \\times \\left( 8 + \\frac{79/80}{8191/8192} \\times 60 \\right) $$\n    $$ \\text{AMAT}_{\\text{data}} = 1 + \\frac{8191}{8192} \\times 8 + \\frac{79/80}{8191/8192} \\times \\frac{8191}{8192} \\times 60 = 1 + (1-\\frac{1}{8192}) \\times 8 + \\frac{79}{80} \\times (1-\\frac{1}{8192}) \\times 60 $$\n    使用 $m_{\\mathrm{L1}} m_{\\mathrm{L2,local}} = m_{\\mathrm{L2,global}}$：\n    $\\text{AMAT}_{\\text{data}} = t_{L1} + m_{\\mathrm{L1}} t_{L2} + m_{\\mathrm{L2,global}} t_{mem} = 1 + \\frac{8191}{8192}\\times 8 + \\frac{79}{80} \\times 60$\n    $$ \\text{AMAT}_{\\text{data}} = 1 + 7.9990234375 + 59.25 = 68.2490234375 \\text{ ns} $$\n    $$ \\text{AMAT}_{\\text{random, huge}} = 40.5 + 68.2490234375 = 108.7490234375 \\text{ ns} $$\n\n**5. 加速比计算**\n加速比是使用小页面的 AMAT 与使用大页面的 AMAT 之比。\n$$ \\text{speedup}_{\\text{stream}} = \\frac{\\text{AMAT}_{\\text{stream, small}}}{\\text{AMAT}_{\\text{stream, huge}}} = \\frac{70.75}{69.5024414...} \\approx 1.017948 $$\n$$ \\text{speedup}_{\\text{random}} = \\frac{\\text{AMAT}_{\\text{random, small}}}{\\text{AMAT}_{\\text{random, huge}}} = \\frac{148.483398...}{108.749023...} \\approx 1.36530 $$\n\n**最终四舍五入值：**\n- $\\text{AMAT}_{\\text{stream, small}} = 70.75$ ns (4 位有效数字)\n- $\\text{AMAT}_{\\text{stream, huge}} = 69.50$ ns (4 位有效数字)\n- $\\text{speedup}_{\\text{stream}} = 1.02$ (3 位有效数字)\n- $\\text{AMAT}_{\\text{random, small}} = 148.5$ ns (4 位有效数字)\n- $\\text{AMAT}_{\\text{random, huge}} = 108.7$ ns (4 位有效数字)\n- $\\text{speedup}_{\\text{random}} = 1.37$ (3 位有效数字)",
            "answer": "$$ \\boxed{ \\begin{pmatrix} 70.75  69.50  1.02  148.5  108.7  1.37 \\end{pmatrix} } $$"
        },
        {
            "introduction": "在多核处理器时代，系统性能的瓶颈往往从单个核心的计算能力转移到多个核心之间的数据共享和通信效率上。缓存一致性协议是确保数据正确性的基础，但其实现方式会对系统总线或互连网络造成不同程度的流量，直接影响整体加速比。本练习  聚焦于写穿透（write-through）和写回（write-back）这两种基本缓存写策略，并要求您在一个多核环境中对它们的性能进行建模和比较。通过量化分析不同工作负载（读密集型与写密集型）下产生的总线流量，您将深入理解底层硬件决策如何决定了并行程序的通信开销，并最终影响系统的可扩展性和效率。",
            "id": "3679713",
            "problem": "考虑一个共享内存多处理器，它有 $N = 8$ 个相同的核心。每个核心都有一个私有的一级（L1）数据缓存。考虑两种可选的缓存写策略：写直通（WT）和写回（WB）。缓存一致性协议是“修改-共享-无效”（MSI）。缓存行大小为 $L = 64$ 字节，机器字长为 $w = 8$ 字节。互连是一个单一的监听总线，其峰值数据带宽为 $R = 25$ GB/s。总线服务时间主要由数据和一致性流量决定；计算、排队和其他延迟可以忽略不计。一次一致性失效广播（包括总线上承载的目录或监听元数据）在总线上消耗 $b_{\\mathrm{inv}} = 16$ 字节。读未命中会获取整个缓存行，在总线上产生 $L$ 字节的成本。在写直通策略下，每次写操作都会将写入的字传输到内存，每次写操作产生 $w$ 字节的成本。在写回策略下，脏行仅在被替换时写回一次，每个脏行产生 $L$ 字节的成本。假设两种策略在写未命中时都采用写分配。\n\n一个并行工作负载按顺序执行两个阶段：\n\n- 阶段 $\\mathcal{R}$（以读为主）：每个核心对一个共享数组执行 $2.0 \\times 10^{6}$ 次字读取，顺序扫描，因此每个核心会接触到 $n_{\\mathrm{R}} = \\frac{2.0 \\times 10^{6}}{8} = 250{,}000$ 个不同的缓存行。为了建模，假设对于每个核心，其 $n_{\\mathrm{R}}$ 个缓存行中的每一个都恰好从内存中调入一次（每个核心的每一行发生一次读未命中），并且与数据移动相比，共享读取导致的一致性开销可以忽略不计。\n\n- 阶段 $\\mathcal{W}$（以写为主）：每个核心对来自同一数组的 $n_{\\mathrm{W}} = 125{,}000$ 个缓存行进行写入。对于每个这样的缓存行，一个核心在该行内执行 $n_{\\mathrm{per\\_line}} = 16$ 次不同的字写入。假设在阶段 $\\mathcal{W}$ 开始时，每个核心要写入的缓存行都不驻留在该核心的缓存中，必须在第一次写入前获取一次，并且平均而言，每个这样的缓存行都恰好有另一个共享者，因此为第一次写入获取独占权限会为每一行生成一次失效广播。在写回策略下，假设每个核心写入的每一行都变脏，并在阶段结束时被替换一次（每个这样的行有一次写回）。不发生缓存到缓存的传输；所有未命中都由主内存服务。\n\n每个阶段的总执行时间被视为总线传输时间，等于总线上总传输字节数除以 $R$。设工作负载的整体执行时间为两个阶段时间之和。使用上述流量模型，计算在整个工作负载中，写回相对于写直通的整体加速比，定义为写直通策略下的总执行时间与写回策略下的总执行时间之比。将您的最终答案四舍五入到四位有效数字。答案是无量纲的。",
            "solution": "用户希望我验证并解决一个计算机体系结构领域的问题。\n\n### 问题验证\n\n**步骤1：提取已知条件**\n\n-   核心数：$N = 8$\n-   用于比较的一级（L1）数据缓存写策略：写直通（WT）和写回（WB）\n-   缓存一致性协议：修改-共享-无效（MSI）\n-   缓存行大小：$L = 64$ 字节\n-   机器字长：$w = 8$ 字节\n-   总线峰值数据带宽：$R = 25$ GB/s\n-   一致性失效广播总线消耗：$b_{\\mathrm{inv}} = 16$ 字节\n-   读未命中流量：获取整个缓存行，成本为 $L$ 字节。\n-   写直通（WT）流量：每次写操作传输一个字，成本为 $w$ 字节。\n-   写回（WB）流量：脏行在被替换时写回，成本为 $L$ 字节。\n-   写未命中策略：WT和WB都采用写分配。\n-   无缓存到缓存的传输；所有未命中均由主内存服务。\n-   阶段 $\\mathcal{R}$（以读为主）：\n    -   每个核心访问 $n_{\\mathrm{R}} = 250{,}000$ 个不同的缓存行。\n    -   每个核心的每一行都恰好从内存中调入一次（每个核心的每一行发生一次读未命中）。\n    -   共享读取的一致性开销可以忽略。\n-   阶段 $\\mathcal{W}$（以写为主）：\n    -   每个核心写入 $n_{\\mathrm{W}} = 125{,}000$ 个缓存行。\n    -   对于每个这样的行，一个核心执行 $n_{\\mathrm{per\\_line}} = 16$ 次不同的字写入。\n    -   在该阶段开始时，要写入的每一行都不驻留在核心的缓存中。\n    -   每一行都有一个其他共享者，需要为每一行进行一次失效广播以获得独占所有权。\n    -   对于WB，每个写入的行都会变脏并被替换一次。\n-   执行时间模型：总线总传输时间，即总传输字节数除以带宽 $R$。\n-   整体执行时间：阶段 $\\mathcal{R}$ 和阶段 $\\mathcal{W}$ 的时间之和。\n-   目标：计算WB相对于WT的整体加速比，定义为 $\\frac{T_{WT}}{T_{WB}}$。\n-   最终答案精度：四舍五入到四位有效数字。\n\n**步骤2：使用提取的已知条件进行验证**\n\n-   **科学依据**：该问题基于计算机组成和体系结构的基本概念，包括缓存写策略（WT、WB）、缓存一致性协议（MSI）以及基于总线流量的性能评估。该模型虽然简化，却是对此类系统进行介绍性分析的标准方法。\n-   **良构问题**：该问题提供了所有必要的参数和一个清晰的、定量的执行时间计算模型。目标定义明确，可以从给定信息中推导出唯一的数值解。\n-   **客观性**：该问题以精确的技术语言陈述，没有歧义或主观论断。\n-   **未发现缺陷**：该问题不违反科学原理，没有规定不足或自相矛盾之处，并且处理的是其领域内一个可形式化的主题。所提供的值对于一个高性能计算系统是现实的。\n\n**步骤3：结论与行动**\n\n问题是有效的。将提供完整的解决方案。\n\n### 解题过程\n\n目标是计算写回（WB）策略相对于写直通（WT）策略的加速比 $S$。加速比定义为总执行时间的比率：\n$$S = \\frac{T_{WT}}{T_{WB}}$$\n问题指出，任何阶段的执行时间仅由其产生的总线流量决定。总执行时间 $T$ 是总线上总传输字节数 $B$ 除以总线带宽 $R$。\n$$T = \\frac{B}{R}$$\n因此，加速比可以表示为每种策略产生的总总线流量的比率：\n$$S = \\frac{B_{WT} / R}{B_{WB} / R} = \\frac{B_{WT}}{B_{WB}}$$\n总流量是阶段 $\\mathcal{R}$ 和阶段 $\\mathcal{W}$ 的流量之和：$B = B_{\\mathcal{R}} + B_{\\mathcal{W}}$。我们现在将为每种策略计算总总线流量。\n\n**1. 阶段 $\\mathcal{R}$ 的总线流量**\n\n在阶段 $\\mathcal{R}$ 中，$N$ 个核心中的每一个在访问其 $n_{\\mathrm{R}}$ 个不同缓存行时都会发生一次读未命中。一次读未命中会从内存中获取一个大小为 $L$ 的完整缓存行。读行为及其产生的流量与写策略无关。因此，阶段 $\\mathcal{R}$ 的流量对于WT和WB是相同的。\n$$B_{\\mathcal{R}, WT} = B_{\\mathcal{R}, WB} = N \\times n_{\\mathrm{R}} \\times L$$\n代入给定值：\n$N = 8$\n$n_{\\mathrm{R}} = 250{,}000 = 2.5 \\times 10^5$\n$L = 64$ 字节\n$$B_{\\mathcal{R}} = 8 \\times (2.5 \\times 10^5) \\times 64 = 20 \\times 10^5 \\times 64 = 1280 \\times 10^5 = 1.28 \\times 10^8 \\text{ 字节}$$\n\n**2. 阶段 $\\mathcal{W}$ 的总线流量**\n\n在阶段 $\\mathcal{W}$ 中，我们分析 $N$ 个核心中每一个在访问其 $n_{\\mathrm{W}}$ 个缓存行时的流量组成部分。对于每一行，以下事件会产生总线流量：\n-   **写未命中**：该行最初不驻留，因此对其的第一次写入会导致写未命中。在写分配策略下，这会触发一个“为获取所有权而读”（RFO）请求，该请求从内存中获取整个缓存行。这会产生 $L$ 字节的流量。\n-   **失效**：为了获得写入的独占所有权，核心必须使其他缓存副本失效。问题指出存在一个其他共享者，因此每行发送一次失效广播，产生 $b_{\\mathrm{inv}}$ 字节的流量。\n-   **写数据传输**：将写入的数据传输到内存的方法取决于策略。\n\n**2a. 写直通（WT）策略下阶段 $\\mathcal{W}$ 的流量**\n\n在WT策略下，每次写操作都会传播到主内存。每个核心对其 $n_{\\mathrm{W}}$ 个缓存行中的每一行执行 $n_{\\mathrm{per\\_line}}$ 次字写入。每次字写入在总线上放置 $w$ 字节。\n在WT策略下，阶段 $\\mathcal{W}$ 的总流量是所有核心的RFO、失效和所有单独写入的流量之和。\n$$B_{\\mathcal{W}, WT} = N \\times n_{\\mathrm{W}} \\times (L + b_{\\mathrm{inv}} + n_{\\mathrm{per\\_line}} \\times w)$$\n代入给定值：\n$N = 8$\n$n_{\\mathrm{W}} = 125{,}000 = 1.25 \\times 10^5$\n$L = 64$ 字节\n$b_{\\mathrm{inv}} = 16$ 字节\n$n_{\\mathrm{per\\_line}} = 16$\n$w = 8$ 字节\n$$B_{\\mathcal{W}, WT} = 8 \\times (1.25 \\times 10^5) \\times (64 + 16 + 16 \\times 8)$$\n$$B_{\\mathcal{W}, WT} = 10^6 \\times (80 + 128) = 10^6 \\times 208 = 2.08 \\times 10^8 \\text{ 字节}$$\n\n**2b. 写回（WB）策略下阶段 $\\mathcal{W}$ 的流量**\n\n在WB策略下，写入仅在本地缓存中进行。总线流量仅在修改过的（“脏”）行被替换并写回内存时发生。问题指出，每个核心写入的 $n_{\\mathrm{W}}$ 个缓存行中的每一行都会变脏并被替换一次，产生一次对整个缓存行的写回。\n在WB策略下，阶段 $\\mathcal{W}$ 的总流量是所有核心的RFO、失效和最终写回的流量之和。\n$$B_{\\mathcal{W}, WB} = N \\times n_{\\mathrm{W}} \\times (L + b_{\\mathrm{inv}} + L) = N \\times n_{\\mathrm{W}} \\times (2L + b_{\\mathrm{inv}})$$\n代入数值：\n$$B_{\\mathcal{W}, WB} = 8 \\times (1.25 \\times 10^5) \\times (2 \\times 64 + 16)$$\n$$B_{\\mathcal{W}, WB} = 10^6 \\times (128 + 16) = 10^6 \\times 144 = 1.44 \\times 10^8 \\text{ 字节}$$\n\n**3. 总流量与加速比计算**\n\n现在我们可以通过将两个阶段的流量相加来计算每种策略的总流量。\n\nWT的总流量：\n$$B_{WT} = B_{\\mathcal{R}} + B_{\\mathcal{W}, WT} = 1.28 \\times 10^8 + 2.08 \\times 10^8 = 3.36 \\times 10^8 \\text{ 字节}$$\n\nWB的总流量：\n$$B_{WB} = B_{\\mathcal{R}} + B_{\\mathcal{W}, WB} = 1.28 \\times 10^8 + 1.44 \\times 10^8 = 2.72 \\times 10^8 \\text{ 字节}$$\n\n最后，我们计算加速比 $S$：\n$$S = \\frac{B_{WT}}{B_{WB}} = \\frac{3.36 \\times 10^8}{2.72 \\times 10^8} = \\frac{3.36}{2.72}$$\n为了简化分数：\n$$S = \\frac{336}{272} = \\frac{168}{136} = \\frac{84}{68} = \\frac{21}{17}$$\n进行除法运算并四舍五入到四位有效数字：\n$$S = \\frac{21}{17} \\approx 1.235294...$$\n$$S \\approx 1.235$$\n写回相对于写直通的整体加速比约为 $1.235$。",
            "answer": "$$\\boxed{1.235}$$"
        }
    ]
}