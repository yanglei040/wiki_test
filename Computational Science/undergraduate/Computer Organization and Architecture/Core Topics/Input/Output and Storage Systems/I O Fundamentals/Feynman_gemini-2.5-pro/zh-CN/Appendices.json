{
    "hands_on_practices": [
        {
            "introduction": "在计算机系统中，数据如何在处理器和 I/O 设备之间传输是一个核心问题。本练习将引导您探索两种基本的数据传输模式：编程 I/O (PIO) 和直接内存访问 (DMA)。通过量化这两种方法的开销——PIO 中与数据量成正比的 CPU 开销和 DMA 中固定的设置开销——您将学会计算一个关键的“盈亏平衡点” ()。这个练习旨在培养您基于工作负载特性做出基本 I/O 架构决策的能力。",
            "id": "3648466",
            "problem": "处理器通过编程输入/输出（PIO）或直接内存访问（DMA）与高级技术附加（ATA）磁盘通信。在编程输入/输出（PIO）中，中央处理器（CPU）主动传输每个数据字，会产生每字 $c_{pio}$ 个CPU周期的开销。在直接内存访问（DMA）中，DMA控制器在CPU执行一次性设置后自主移动数据，会产生一个固定的设置开销 $c_{setup}$ 个CPU周期，在传输过程中没有额外的每字CPU周期开销。假设CPU时钟周期为 $T_{clk}$，并且对于移动数据块，设备到内存的总线传输时间对于PIO和DMA是相同的，并且仅取决于以字为单位的块大小 $S$，而不取决于所用方法；因此，在比较总传输时间时，这个总线传输时间可以被视为一个公共项。\n\n仅使用时间和周期计数的基本原理，即CPU耗时是周期数与CPU时钟周期的乘积，推导出最小的整数块大小 $S^{*}$（以字为单位测量），使得使用DMA的总传输时间严格小于使用PIO的总传输时间。将您的最终答案表示为关于 $c_{setup}$ 和 $c_{pio}$ 的闭式解析表达式。无需四舍五入。以字为单位说明您的答案 $S^{*}$。",
            "solution": "该问题要求推导最小整数块大小，表示为 $S^{*}$，使得使用直接内存访问（DMA）的数据传输严格快于使用编程输入/输出（PIO）。比较的标准是总传输时间。\n\n设 $S$ 是以字为单位的块大小。已知条件如下：\n- $c_{pio}$：PIO的每字CPU开销，单位为周期。\n- $c_{setup}$：DMA的固定CPU设置开销，单位为周期。\n- $T_{clk}$：CPU时钟周期。\n\n问题陈述“CPU耗时是周期数与CPU时钟周期的乘积”。我们可以使用这个原理来为PIO和DMA两种方式中与CPU相关的时间成本建模。问题还指明，两种方法的总线传输时间是相同的，因此在比较总时间时它会抵消掉。\n\n让我们定义PIO传输的总时间 $T_{total, PIO}$ 和DMA传输的总时间 $T_{total, DMA}$。这些时间由CPU时间开销和总线数据传输时间组成。设 $T_{bus}(S)$ 是在总线上传输大小为 $S$ 的块所需的时间。\n\n对于大小为 $S$ 字的块的PIO传输，CPU参与传输每个字。消耗的CPU总周期数是块大小与每字周期开销的乘积。\n$$ N_{cycles, PIO} = S \\cdot c_{pio} $$\nPIO对应的CPU时间 $T_{CPU, PIO}$ 为：\n$$ T_{CPU, PIO} = N_{cycles, PIO} \\cdot T_{clk} = (S \\cdot c_{pio}) \\cdot T_{clk} $$\n因此，PIO传输的总时间为：\n$$ T_{total, PIO} = T_{CPU, PIO} + T_{bus}(S) = (S \\cdot c_{pio}) \\cdot T_{clk} + T_{bus}(S) $$\n\n对于大小为 $S$ 字的块的DMA传输，CPU只执行初始设置。此后，DMA控制器管理传输，CPU可以自由执行其他任务。消耗的CPU周期数是一个固定的设置成本，与块大小无关。\n$$ N_{cycles, DMA} = c_{setup} $$\nDMA对应的CPU时间 $T_{CPU, DMA}$ 为：\n$$ T_{CPU, DMA} = N_{cycles, DMA} \\cdot T_{clk} = c_{setup} \\cdot T_{clk} $$\nDMA传输的总时间为：\n$$ T_{total, DMA} = T_{CPU, DMA} + T_{bus}(S) = c_{setup} \\cdot T_{clk} + T_{bus}(S) $$\n\n我们要寻找的条件是DMA传输严格快于PIO传输。这可以转化为不等式：\n$$ T_{total, DMA}  T_{total, PIO} $$\n代入总时间的表达式：\n$$ c_{setup} \\cdot T_{clk} + T_{bus}(S)  (S \\cdot c_{pio}) \\cdot T_{clk} + T_{bus}(S) $$\n总线传输时间 $T_{bus}(S)$ 是不等式两边的公共项，可以消去。\n$$ c_{setup} \\cdot T_{clk}  (S \\cdot c_{pio}) \\cdot T_{clk} $$\n由于CPU时钟周期 $T_{clk}$ 是一个物理时间长度，它必须是一个正值 ($T_{clk}  0$)。我们可以在不等式两边同时除以 $T_{clk}$ 而不改变不等号的方向。\n$$ c_{setup}  S \\cdot c_{pio} $$\n为了解出 $S$，我们必须考虑 $c_{pio}$ 的值。$c_{pio}$ 项表示每字的CPU周期开销。为了使问题具有物理意义，并且存在一个DMA变得更有优势的交叉点，这个开销必须是正的 ($c_{pio}  0$)。如果 $c_{pio}$ 为零或负数，那么PIO将总是至少和DMA一样快（假设设置成本 $c_{setup}$ 为非负）。假设 $c_{pio}  0$，我们可以用它来除，以分离出 $S$：\n$$ \\frac{c_{setup}}{c_{pio}}  S $$\n或者，将 $S$ 写在左边：\n$$ S  \\frac{c_{setup}}{c_{pio}} $$\n问题要求满足此条件的最小整数块大小 $S^{*}$。令 $R = \\frac{c_{setup}}{c_{pio}}$。条件是 $S  R$。满足此条件的整数集合是 $\\{ k \\in \\mathbb{Z} \\mid k  R \\}$。这个集合中最小的整数是紧跟在 $R$ 值之后的那个整数。这可以用向下取整函数正式表示，该函数给出小于或等于其参数的最大整数。大于 $R$ 的最小整数是 $\\lfloor R \\rfloor + 1$。\n例如，如果 $R = 15.3$，条件是 $S  15.3$。最小整数 $S$ 是 $16$，即 $\\lfloor 15.3 \\rfloor + 1 = 15 + 1$。如果 $R$ 是一个整数，比如 $R = 15$，条件是 $S  15$。最小整数 $S$ 同样是 $16$，即 $\\lfloor 15 \\rfloor + 1 = 15 + 1$。\n因此，最小整数块大小 $S^{*}$ 由下式给出：\n$$ S^{*} = \\left\\lfloor \\frac{c_{setup}}{c_{pio}} \\right\\rfloor + 1 $$\n这个表达式以字为单位，提供了块大小方面的盈亏平衡点。对于任何块大小 $S \\ge S^{*}$，DMA方法的CPU时间成本将更低或相等。由于问题要求时间严格更少，$S^{*}$ 是第一个满足此条件的整数值。",
            "answer": "$$\n\\boxed{\\left\\lfloor \\frac{c_{setup}}{c_{pio}} \\right\\rfloor + 1}\n$$"
        },
        {
            "introduction": "除了数据传输模式外，系统如何感知 I/O 事件（例如，数据准备就绪或传输完成）同样至关重要。本练习聚焦于两种主要的事件通知机制：轮询和中断。轮询通过 CPU 的持续检查实现，简单但可能浪费资源；而中断则允许设备主动通知 CPU，更高效但有上下文切换的开销。通过计算中断驱动策略在 CPU 利用率上优于轮询策略的临界事件率 ()，您将深入理解在不同频率的事件流场景下如何选择最优的 I/O 模型。",
            "id": "3648479",
            "problem": "一个设备生成一个事件流，该事件流可建模为速率为每秒 $\\lambda$ 个事件的泊松过程。一个时钟频率为每秒 $f$ 个周期的中央处理器 (CPU) 必须使用以下两种输入/输出 (I/O) 策略之一来处理每个事件：\n\n- 忙等待轮询：当系统配置为轮询时，CPU 在其他情况下是空闲的，并执行一个重复读取设备状态寄存器的紧凑循环。每次轮询迭代消耗 $c_p$ 个周期。当检测到一个事件时，将执行处理程序代码；假设无论采用何种 I/O 策略，处理程序代码都是相同的，因此任何每个事件的服务周期都是共同的，为了比较开销，无需单独建模。由于当 CPU 被分配用于轮询时，轮询循环会持续运行，因此它在稳态下会消耗可用的指令发射能力，除非被处理程序执行所取代；因此，归因于轮询循环和处理程序调用的总周期消耗不能超过每秒 $f$ 个周期。\n\n- 中断驱动 I/O：当系统配置为中断时，每个事件的到达都会触发一个中断，处理该事件会产生 $c_i$ 个周期的开销，包括上下文保存和处理程序执行。\n\n将 I/O 的 CPU 利用率定义为 I/O 机制（包括处理程序执行）每秒消耗的 CPU 周期期望数除以 $f$。仅使用基本速率论证和上述定义，确定事件到达速率 $\\lambda^{\\star}$，在该速率下，中断驱动策略与轮询策略产生相同的 CPU 利用率。将您的最终答案表示为关于 $f$ 和 $c_i$ 的封闭形式解析表达式。以每秒事件数为单位表示最终速率。无需进行数值代入，也无需四舍五-入。",
            "solution": "问题要求确定事件到达速率 $\\lambda^{\\star}$，在该速率下，中断驱动 I/O 策略的 CPU 利用率等于忙等待轮询策略的 CPU 利用率。我们首先根据所提供的定义，为每种情况下的 CPU 利用率建立正式的数学模型。\n\nI/O 的 CPU 利用率 $U_{I/O}$ 定义为 I/O 机制每秒消耗的 CPU 周期期望数除以每秒可用的总周期数，即 CPU 时钟频率 $f$。\n$$\nU_{I/O} = \\frac{\\text{E}[\\text{Cycles per second for I/O}]}{f}\n$$\n\n我们首先分析中断驱动 I/O 策略。事件以泊松过程的方式到达，平均速率为每秒 $\\lambda$ 个事件。每个事件触发一个中断，处理该中断需要消耗 $c_i$ 个 CPU 周期。因此，中断机制每秒消耗的 CPU 周期期望数是平均事件速率与每个事件的周期成本的乘积。\n$$\n\\text{E}[\\text{Cycles per second for interrupts}] = \\lambda \\cdot c_i\n$$\n中断驱动策略的 CPU 利用率 $U_{int}$ 则由下式给出：\n$$\nU_{int} = \\frac{\\lambda c_i}{f}\n$$\n\n接下来，我们分析忙等待轮询策略。问题陈述，当使用此策略时，“CPU 在其他情况下是空闲的，并执行一个重复读取设备状态寄存器的紧凑循环”以及“当 CPU 被分配用于轮询时，轮询循环会持续运行”。这意味着 CPU 永久性地专用于 I/O 任务。它要么在执行轮询循环，要么在检测到事件时执行事件处理程序。问题明确指出“I/O 的 CPU 利用率定义为 I/O 机制（包括处理程序执行）每秒消耗的 CPU 周期期望数”。由于 CPU 始终忙于轮询或处理，该 I/O 机制每秒消耗的总周期数等于 CPU 每秒可以执行的总周期数，即其频率 $f$。\n$$\n\\text{E}[\\text{Cycles per second for polling}] = f\n$$\n因此，忙等待轮询策略的 CPU 利用率 $U_{poll}$ 为：\n$$\nU_{poll} = \\frac{f}{f} = 1\n$$\n这表明，如上所述，忙等待轮询策略内在地消耗了分配给它的 CPU 容量的 $100\\%$。参数 $c_p$（单次轮询迭代的成本）是计算此总利用率的无关信息，因为这种忙等待实现的定义性特征是其连续、全时运行。\n\n为了找到交叉事件速率 $\\lambda^{\\star}$，我们将两种策略的利用率设为相等：$U_{int} = U_{poll}$。\n$$\n\\frac{\\lambda^{\\star} c_i}{f} = 1\n$$\n对该方程求解 $\\lambda^{\\star}$ 可得出所需的表达式：\n$$\n\\lambda^{\\star} = \\frac{f}{c_i}\n$$\n这个结果具有物理意义。它代表中断驱动系统在饱和（即其自身的 CPU 利用率达到 $100\\%$）之前可以处理的最大事件速率。在这个特定速率下，其利用率变得与忙等待轮询系统的恒定 $100\\%$ 利用率相等。对于任何速率 $\\lambda  \\lambda^{\\star}$，中断驱动方法在 CPU 周期方面更有效率。该表达式的单位是 $\\frac{\\text{周期/秒}}{\\text{周期/事件}}$，这正确地得出了 事件/秒。",
            "answer": "$$\\boxed{\\frac{f}{c_i}}$$"
        },
        {
            "introduction": "在确定了 DMA 在大批量数据传输中的优势后，下一步是优化其性能。本练习将带您深入了解 DMA 突发传输的调优过程，这是一个在实际系统中常见的性能优化任务。虽然更长的突发传输可以通过分摊总线仲裁等固定开销来提高效率，但它也会长时间占用总线，导致 CPU 停顿。这个练习 () 要求您在满足最大 CPU 停顿时间和硬件粒度等现实约束的前提下，通过调整突发大小来最大化吞吐量，从而将理论知识应用于解决实际的系统设计权衡问题。",
            "id": "3648441",
            "problem": "一个片上系统（SoC）采用直接内存访问（DMA）技术，通过共享系统总线将数据从主内存移动到设备。DMA控制器发出重复的突发传输，每次突发传输都按顺序包含三个阶段：持续时间为$\\ell$的总线仲裁阶段，持续时间为$o$的固定控制器开销阶段，以及持续时间等于移动的总字节数$b$除以总线传输速率$\\rho$的数据移动阶段。中央处理器（CPU）只有在DMA未占用总线时才能访问总线；因此，在DMA持有总线期间（即在开销和数据移动阶段），CPU会被阻塞。总线仲裁阶段不会阻塞CPU。\n\n假设系统在连续的DMA突发传输的稳态下运行。使用以下数值：\n- 仲裁延迟 $\\ell = 1$ 微秒，\n- 每次突发传输的开销 $o = 2$ 微秒，\n- 总线传输速率 $\\rho = 1600$ 字节/微秒，\n- 每次突发传输允许的最大CPU阻塞时间 $L_{\\text{stall}} = 20$ 微秒，\n- 总线节拍粒度 $s = 64$ 字节（每次突发传输的大小必须是$s$的整数倍）。\n\n从上面阐述的吞吐量和阻塞约束的定义出发，确定能够最大化稳态DMA吞吐量的突发传输大小$b$（以字节为单位），该大小需满足每次突发传输的最大CPU阻塞时间小于或等于$L_{\\text{stall}}$的要求。你的答案必须是一个数字，并且必须以字节为单位表示。无需按有效数字进行四舍五入；请严格遵守总线粒度$s$。",
            "solution": "问题验证如下：\n\n### 第1步：提取已知条件\n- DMA控制器通过共享系统总线将数据从主内存移动到设备。\n- DMA突发传输包含三个阶段：\n    1. 持续时间为$\\ell$的总线仲裁阶段。\n    2. 持续时间为$o$的固定控制器开销阶段。\n    3. 数据移动阶段，持续时间为 $T_{data} = \\frac{b}{\\rho}$，其中$b$是移动的总字节数，$\\rho$是总线传输速率。\n- CPU在开销和数据移动阶段被阻塞。\n- 总线仲裁阶段不会阻塞CPU。\n- 系统在连续的DMA突发传输的稳态下运行。\n- 仲裁延迟：$\\ell = 1$ 微秒。\n- 每次突发传输的开销：$o = 2$ 微秒。\n- 总线传输速率：$\\rho = 1600$ 字节/微秒。\n- 每次突发传输允许的最大CPU阻塞时间：$L_{\\text{stall}} = 20$ 微秒。\n- 总线节拍粒度：$s = 64$ 字节。突发传输大小$b$必须是$s$的整数倍。\n\n### 第2步：使用提取的已知条件进行验证\n该问题是计算机组成与体系结构领域内一个明确定义的优化任务。\n- **科学依据：**DMA操作模型，包括仲裁、开销和数据传输阶段，是用于分析I/O性能的标准且有效的抽象。总线争用、CPU阻塞和吞吐量等概念是该领域的基本原理。\n- **适定性：**问题提供了一个清晰的目标函数（最大化DMA吞吐量）和一组明确定义的约束条件（最大CPU阻塞和总线粒度）。所有必要的参数都已给出，从而可以得出一个唯一且有意义的解。\n- **客观性：**问题使用精确的技术语言陈述，没有任何主观性或歧义。\n\n该问题不违反任何无效性标准。它是一个基于既定工程原理的可形式化、可解决的问题。\n\n### 第3步：结论与行动\n问题有效。将提供完整解答。\n\n### 解\n目标是找到在给定约束条件下，能够最大化稳态DMA吞吐量的突发传输大小$b$。\n\n首先，我们定义稳态DMA吞吐量，用$\\Theta$表示。吞吐量是单位时间内传输的有效数据量。在连续突发传输的稳态下，一个周期的总时间是单次突发传输的持续时间，$T_{burst}$。\n\n一次突发传输的持续时间是其三个阶段的总和：\n1.  仲裁时间：$T_{arb} = \\ell$\n2.  开销时间：$T_{ovh} = o$\n3.  数据移动时间：$T_{data} = \\frac{b}{\\rho}$\n\n一次突发传输的总时间为：\n$$ T_{burst} = T_{arb} + T_{ovh} + T_{data} = \\ell + o + \\frac{b}{\\rho} $$\n\n一次突发传输的数据量为$b$。因此，稳态吞吐量$\\Theta(b)$作为突发传输大小$b$的函数为：\n$$ \\Theta(b) = \\frac{\\text{Data Transferred}}{\\text{Total Time}} = \\frac{b}{T_{burst}} = \\frac{b}{\\ell + o + \\frac{b}{\\rho}} $$\n\n为了理解吞吐量如何依赖于突发传输大小$b$，我们分析函数$\\Theta(b)$。我们可以将其重写为：\n$$ \\Theta(b) = \\frac{b \\rho}{(\\ell + o)\\rho + b} $$\n为了确定该函数是存在最大值还是单调的，我们计算它关于$b$的导数：\n$$ \\frac{d\\Theta}{db} = \\frac{(\\rho)((\\ell + o)\\rho + b) - (b\\rho)(1)}{((\\ell + o)\\rho + b)^2} = \\frac{(\\ell + o)\\rho^2 + b\\rho - b\\rho}{((\\ell + o)\\rho + b)^2} = \\frac{(\\ell + o)\\rho^2}{((\\ell + o)\\rho + b)^2} $$\n鉴于$\\ell  0$，$o  0$且$\\rho  0$，分子$(\\ell + o)\\rho^2$严格为正。分母是一个平方项，因此对于任何有效的$b$，它也为正。因此，对于所有$b  0$，都有$\\frac{d\\Theta}{db}  0$。这证明了吞吐量$\\Theta(b)$是突发传输大小$b$的一个单调递增函数。\n\n为了最大化吞吐量$\\Theta(b)$，我们必须选择满足问题所有约束条件的$b$的最大可能值。\n\n接下来，我们形式化对$b$的约束。\n\n**约束1：最大CPU阻塞**\n当DMA控制器持有总线时，CPU被阻塞，这种情况发生在开销和数据移动阶段。每次突发传输的总阻塞时间，$T_{stall}$，为：\n$$ T_{stall} = T_{ovh} + T_{data} = o + \\frac{b}{\\rho} $$\n问题规定，此阻塞时间不得超过允许的最大阻塞时间，$L_{\\text{stall}}$：\n$$ o + \\frac{b}{\\rho} \\le L_{\\text{stall}} $$\n求解$b$，我们得到突发传输大小的上限：\n$$ \\frac{b}{\\rho} \\le L_{\\text{stall}} - o $$\n$$ b \\le \\rho (L_{\\text{stall}} - o) $$\n\n**约束2：总线粒度**\n突发传输大小$b$必须是总线节拍粒度$s$的整数倍。\n$$ b = k \\cdot s, \\quad \\text{其中 } k \\text{ 是一个正整数 } (k \\in \\{1, 2, 3, \\dots\\}) $$\n\n为了找到最优突发传输大小$b_{opt}$，我们必须找到满足两个约束条件的$b$的最大值。该值将是从阻塞约束导出的最大值以下$s$的最大整数倍。\n令$b_{max\\_limit} = \\rho(L_{\\text{stall}} - o)$。我们需要找到最大的$b$，使得$b = k \\cdot s$且$b \\le b_{max\\_limit}$。这等价于找到最大的整数$k$，使得$k \\cdot s \\le b_{max\\_limit}$，即$k_{max} = \\left\\lfloor \\frac{b_{max\\_limit}}{s} \\right\\rfloor$。\n那么，最优突发传输大小为：\n$$ b_{opt} = s \\cdot k_{max} = s \\cdot \\left\\lfloor \\frac{\\rho(L_{\\text{stall}} - o)}{s} \\right\\rfloor $$\n\n现在，我们代入给定的数值：\n- $\\rho = 1600$ 字节/$\\mu$s\n- $L_{\\text{stall}} = 20$ $\\mu$s\n- $o = 2$ $\\mu$s\n- $s = 64$ 字节\n\n首先，计算$b$的最大限制：\n$$ b_{max\\_limit} = 1600 \\frac{\\text{字节}}{\\mu s} \\times (20 \\mu s - 2 \\mu s) = 1600 \\frac{\\text{字节}}{\\mu s} \\times 18 \\mu s = 28800 \\text{ 字节} $$\n\n所以，我们必须有$b \\le 28800$字节。\n\n接下来，我们应用粒度约束。我们需要找到小于或等于$28800$字节的$s = 64$字节的最大倍数。\n$$ k_{max} = \\left\\lfloor \\frac{28800}{64} \\right\\rfloor $$\n我们来执行除法：\n$$ \\frac{28800}{64} = \\frac{14400}{32} = \\frac{7200}{16} = \\frac{3600}{8} = \\frac{1800}{4} = 450 $$\n由于结果是整数，所以$\\left\\lfloor 450 \\right\\rfloor = 450$。\n所以，$k_{max} = 450$。\n\n最优突发传输大小$b_{opt}$是：\n$$ b_{opt} = s \\cdot k_{max} = 64 \\text{ 字节} \\times 450 = 28800 \\text{ 字节} $$\n\n此突发传输大小在遵守CPU阻塞限制和总线粒度要求的同时，最大化了DMA吞吐量。",
            "answer": "$$\\boxed{28800}$$"
        }
    ]
}