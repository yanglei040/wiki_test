{
    "hands_on_practices": [
        {
            "introduction": "高效的内存管理是设计专用处理器时的核心考量。本练习旨在通过一个具体计算，揭示数字信号处理器（DSP）和张量处理单元（TPU）在数据布局和内存分配策略上的根本差异。通过量化一个多通道滤波器在两种架构上的内存足迹，包括各自独特的对齐和填充规则，你将亲身体会到不同的内存组织方式——DSP的独立缓冲与TPU的连续张量——是如何直接影响整体资源消耗的。",
            "id": "3634514",
            "problem": "一个实验室正在比较同一种一维有限冲激响应卷积的两种实现，一种在数字信号处理器 (DSP) 上，另一种在张量处理单元 (TPU) 上。该任务是使用重叠保留法对离散时间信号进行实时、多通道的有限冲激响应滤波，帧大小为 $N_{f}$，滤波器长度为 $L$，并独立应用于 $C$ 个通道。每个通道使用一个长度为 $L$ 的共享滤波器，每帧处理 $N_{f}$ 个输出样本。\n\n假设以下经过充分验证的事实和核心定义：\n- 在用于有限冲激响应滤波器的重叠保留法中，每个通道需要访问 $N_{f} + L - 1$ 个最近的输入样本，以产生 $N_{f}$ 个连续的有效输出。\n- 内存占用等于元素数量乘以每个元素的字节数，任何由分配器施加的填充都会将分配向上取整到其所需的对齐粒度。\n- Brain 浮点 16 位 ($bfloat16$) 和定点 $Q1.15$ 每个样本都使用 $16$ 位存储，即每个元素 $2$ 字节。\n\n使用以下特定于场景的细节：\n- DSP 端（定点 $Q1.15$）：\n  1) $C$ 个通道中的每一个都将其输入历史存储在一个独立的循环缓冲区中，长度为 $N_{f}+L-1$ 个样本。\n  2) $C$ 个通道中的每一个都将其输出帧存储在一个独立的缓冲区中，长度为 $N_{f}$ 个样本。\n  3) 滤波器系数在所有通道间共享，并作为 $L$ 个样本存储一次。\n  4) 上述所有三种缓冲区类型都由分配器独立分配和填充，填充到不小于其未填充大小的、最小的 32 字节倍数。\n- TPU 端 ($bfloat16$)：\n  1) 输入激活张量将所有通道连续打包，包含 $C\\,(N_{f}+L-1)$ 个样本。\n  2) 输出激活张量将所有通道连续打包，包含 $C\\,N_{f}$ 个样本。\n  3) 核心张量包含共享的 $L$ 个抽头值。\n  4) TPU 分配器将输入和输出张量的总字节大小向上取整到 256 字节的最小倍数，将核心张量的总字节大小向上取整到 128 字节的最小倍数。\n\n假设除了上述描述的缓冲区和张量之外，没有额外的临时工作空间，并且在两个系统上每个元素都以 $2$ 字节存储。设 $C = 96$，$N_{f} = 1023$，$L = 257$。\n\n定义有符号内存占用差异 $\\Delta$（单位为字节）为\n$$\n\\Delta = \\text{DSP 总字节数} - \\text{TPU 总字节数}。\n$$\n\n精确计算 $\\Delta$。将您的最终答案表示为单个有符号整数字节数。不需要四舍五入。",
            "solution": "该问题要求精确计算数字信号处理器 (DSP) 实现与张量处理单元 (TPU) 实现之间有符号内存占用差异 $\\Delta$。该差异定义为 $\\Delta = M_{DSP} - M_{TPU}$，其中 $M_{DSP}$ 和 $M_{TPU}$ 分别是各自系统的总内存占用（以字节为单位）。\n\n首先，我们确定给定的参数：\n- 通道数，$C = 96$。\n- 帧大小，$N_{f} = 1023$ 个样本。\n- 滤波器长度，$L = 257$ 个样本。\n- 每个样本的字节数，$S_{elem} = 2$。\n\n两个系统的内存占用计算都必须考虑填充。我们定义一个运算符 $P(s, a)$，表示将原始大小 $s$（以字节为单位）向上填充到对齐粒度 $a$（以字节为单位）的下一个倍数。这可以用向上取整函数表示：\n$$\nP(s, a) = a \\cdot \\left\\lceil \\frac{s}{a} \\right\\rceil\n$$\n\n现在我们将计算每个系统的总内存占用。\n\n**1. DSP 内存占用 ($M_{DSP}$)**\n\nDSP 系统使用三种类型的缓冲区，每种都独立分配和填充。\n\n- **输入缓冲区**：有 $C$ 个独立的循环缓冲区用于存储输入历史。每个缓冲区存储 $N_{f} + L - 1$ 个样本。\n  - 每个输入缓冲区的样本数是 $N_{f} + L - 1 = 1023 + 257 - 1 = 1279$。\n  - 一个输入缓冲区的未填充大小（以字节为单位）是 $s_{DSP,in} = (N_{f} + L - 1) \\cdot S_{elem} = 1279 \\cdot 2 = 2558$。\n  - DSP 分配器将每个缓冲区填充到 32 字节的倍数。一个输入缓冲区的填充后大小是 $S_{DSP,in} = P(s_{DSP,in}, 32) = 32 \\cdot \\left\\lceil \\frac{2558}{32} \\right\\rceil = 32 \\cdot \\lceil 79.9375 \\rceil = 32 \\cdot 80 = 2560$ 字节。\n  - 所有 $C$ 个输入缓冲区的总内存是 $M_{DSP,in} = C \\cdot S_{DSP,in} = 96 \\cdot 2560 = 245760$ 字节。\n\n- **输出缓冲区**：有 $C$ 个独立的缓冲区用于存储输出帧。每个缓冲区存储 $N_{f}$ 个样本。\n  - 每个输出缓冲区的样本数是 $N_{f} = 1023$。\n  - 一个输出缓冲区的未填充大小（以字节为单位）是 $s_{DSP,out} = N_{f} \\cdot S_{elem} = 1023 \\cdot 2 = 2046$。\n  - 一个输出缓冲区的填充后大小是 $S_{DSP,out} = P(s_{DSP,out}, 32) = 32 \\cdot \\left\\lceil \\frac{2046}{32} \\right\\rceil = 32 \\cdot \\lceil 63.9375 \\rceil = 32 \\cdot 64 = 2048$ 字节。\n  - 所有 $C$ 个输出缓冲区的总内存是 $M_{DSP,out} = C \\cdot S_{DSP,out} = 96 \\cdot 2048 = 196608$ 字节。\n\n- **滤波器缓冲区**：有一个共享缓冲区用于存储滤波器系数，包含 $L$ 个样本。\n  - 样本数是 $L = 257$。\n  - 滤波器缓冲区的未填充大小（以字节为单位）是 $s_{DSP,filt} = L \\cdot S_{elem} = 257 \\cdot 2 = 514$。\n  - 滤波器缓冲区的填充后大小是 $M_{DSP,filt} = P(s_{DSP,filt}, 32) = 32 \\cdot \\left\\lceil \\frac{514}{32} \\right\\rceil = 32 \\cdot \\lceil 16.0625 \\rceil = 32 \\cdot 17 = 544$ 字节。\n\nDSP 的总内存占用是这些部分的总和：\n$$\nM_{DSP} = M_{DSP,in} + M_{DSP,out} + M_{DSP,filt} = 245760 + 196608 + 544 = 442912 \\text{ 字节}\n$$\n\n**2. TPU 内存占用 ($M_{TPU}$)**\n\nTPU 系统使用三个张量，每个张量都有自己的填充规则。\n\n- **输入激活张量**：这个单独的张量打包了所有通道，包含 $C \\cdot (N_{f} + L - 1)$ 个样本。\n  - 总样本数是 $C \\cdot (N_{f} + L - 1) = 96 \\cdot 1279 = 122784$。\n  - 输入张量的未填充大小（以字节为单位）是 $s_{TPU,in} = C \\cdot (N_{f} + L - 1) \\cdot S_{elem} = 122784 \\cdot 2 = 245568$。\n  - TPU 分配器将此张量填充到 256 字节的倍数。填充后的大小是 $M_{TPU,in} = P(s_{TPU,in}, 256) = 256 \\cdot \\left\\lceil \\frac{245568}{256} \\right\\rceil = 256 \\cdot \\lceil 959.25 \\rceil = 256 \\cdot 960 = 245760$ 字节。\n\n- **输出激活张量**：这个单独的张量打包了所有通道，包含 $C \\cdot N_{f}$ 个样本。\n  - 总样本数是 $C \\cdot N_{f} = 96 \\cdot 1023 = 98208$。\n  - 输出张量的未填充大小（以字节为单位）是 $s_{TPU,out} = C \\cdot N_{f} \\cdot S_{elem} = 98208 \\cdot 2 = 196416$。\n  - 此张量也填充到 256 字节的倍数。填充后的大小是 $M_{TPU,out} = P(s_{TPU,out}, 256) = 256 \\cdot \\left\\lceil \\frac{196416}{256} \\right\\rceil = 256 \\cdot \\lceil 767.25 \\rceil = 256 \\cdot 768 = 196608$ 字节。\n\n- **核心张量**：这个张量存储共享的滤波器系数，包含 $L$ 个样本。\n  - 样本数是 $L = 257$。\n  - 核心张量的未填充大小（以字节为单位）是 $s_{TPU,kern} = L \\cdot S_{elem} = 257 \\cdot 2 = 514$。\n  - TPU 分配器将核心张量填充到 128 字节的倍数。填充后的大小是 $M_{TPU,kern} = P(s_{TPU,kern}, 128) = 128 \\cdot \\left\\lceil \\frac{514}{128} \\right\\rceil = 128 \\cdot \\lceil 4.015625 \\rceil = 128 \\cdot 5 = 640$ 字节。\n\nTPU 的总内存占用是这些部分的总和：\n$$\nM_{TPU} = M_{TPU,in} + M_{TPU,out} + M_{TPU,kern} = 245760 + 196608 + 640 = 443008 \\text{ 字节}\n$$\n\n**3. 内存占用差异 ($\\Delta$)**\n\n最后，我们计算有符号内存占用差异 $\\Delta$。\n$$\n\\Delta = M_{DSP} - M_{TPU} = 442912 - 443008 = -96 \\text{ 字节}\n$$\n结果为负值，表明在这些特定条件下，DSP 实现的总内存占用比 TPU 实现小 $96$ 字节。这种差异纯粹是由两种架构独特的内存分配和填充策略造成的。",
            "answer": "$$\n\\boxed{-96}\n$$"
        },
        {
            "introduction": "处理器性能不仅取决于计算速度，更受到数据访问速度的严重制约。本练习将你的注意力从静态的内存占用转移到动态的数据流和内存带宽上。你将分析一个DSP执行流式卷积和一个TPU执行分块矩阵乘法时的动态随机存取存储器（DRAM）流量，这两种操作模式分别代表了两种架构的典型工作方式。通过计算并比较两种场景下的带宽需求与供给，你将学会如何识别计算瓶颈（是受计算限制还是内存限制），并深入理解数据复用策略（如TPU中的分块技术）对于实现高性能计算的重要性。",
            "id": "3634524",
            "problem": "一个数字信号处理器（DSP）将对一个长输入流进行一维有限脉冲响应（FIR）卷积计算。该 DSP 为输入使用一个长度为 $L$ 的循环缓冲区，并在初始化时将 $L$ 个系数预加载到片上静态随机存取存储器（SRAM）中。输入样本的位宽根据模式为八位（$8$-bit）或十六位（$16$-bit）；对于本问题，假设采用以下稳态模式：输入样本为十六位（$16$-bit），系数为十六位（$16$-bit），输出为三十二位（$32$-bit）。每个输出样本的计算都会从动态随机存取存储器（DRAM）中读取单个最新的输入样本并剔除最旧的样本，以此来维护循环缓冲区，而在稳态期间，所有系数都会被重用，无需进一步访问 DRAM。每个输出样本被写回 DRAM。该 DSP 必须维持 $f_{\\text{DSP}} = 1.5 \\times 10^{9}$ 样本/秒的目标采样率。DSP 可用的 DRAM 带宽为 $B_{\\text{DSP}} = 6.0 \\times 10^{9}$ 字节/秒。\n\n一个张量处理单元（TPU）执行通用矩阵乘法（GEMM）$C = A B$，其中 $A \\in \\mathbb{R}^{M \\times K}$，$B \\in \\mathbb{R}^{K \\times N}$，$C \\in \\mathbb{R}^{M \\times N}$。该 TPU 使用权重固定（weight-stationary）的脉动处理方式，并带有片上累加器和分块（tiling）技术。考虑一个大小为 $T_{m} \\times T_{n}$ 的输出分块（tile），其中 $T_{m} = 128$，$T_{n} = 128$，完整的内积维度 $K = 1024$ 被划分为大小为 $T_{k} = 256$ 的 $K$ 块。对于每个 $K$ 块，TPU 从 DRAM 中将一个激活子分块 $A_{\\text{tile}} \\in \\mathbb{R}^{T_{m} \\times T_{k}}$ 和一个权重子分块 $B_{\\text{tile}} \\in \\mathbb{R}^{T_{k} \\times T_{n}}$ 流式传输到片上 SRAM；$C_{\\text{tile}} \\in \\mathbb{R}^{T_{m} \\times T_{n}}$ 的部分和保存在片上，直到处理完整个 $K$ 维度，此时完整的 $C_{\\text{tile}}$ 会被一次性写入 DRAM。假设 $A$ 和 $B$ 的元素为八位（$8$-bit），最终存储的 $C$ 的元素为十六位（$16$-bit）。TPU 的脉动阵列维持每秒 $P = 4.096 \\times 10^{12}$ 次乘法累加（MAC）运算。TPU 可用的 DRAM 带宽为 $B_{\\text{TPU}} = 3.0 \\times 10^{11}$ 字节/秒。对于本问题，将千兆字节/秒（GB/s）解释为 $10^{9}$ 字节/秒。\n\n仅使用基于卷积的滑动窗口模型和矩阵乘法的三重嵌套循环解释的基本容量和重用论据，完成以下任务：\n\n1. 推导每个 DSP 输出样本的稳态 DRAM 流量（以字节为单位，记为 $T_{\\text{DSP}}$），明确计入每个输出获取的一个新输入样本和每个输出存储的一个输出样本。系数重用不应产生稳态 DRAM 流量。\n2. 推导每个 TPU 输出分块的 DRAM 流量（以字节为单位，记为 $T_{\\text{TPU}}$），计算所有跨 $K$ 块流式传输的激活和权重子分块以及 $C$ 分块的最后一次写入。\n3. 通过计算比率 $r_{\\text{DSP}}$ 和 $r_{\\text{TPU}}$ 来识别带宽瓶颈，其中 $r_{\\text{DSP}}$ 是维持 $f_{\\text{DSP}}$ 所需的 DRAM 带宽除以 $B_{\\text{DSP}}$，而 $r_{\\text{TPU}}$ 是维持计算受限的分块速率所需的 DRAM 带宽除以 $B_{\\text{TPU}}$。\n\n以单行矩阵 $\\begin{pmatrix} T_{\\text{DSP}}  T_{\\text{TPU}}  r_{\\text{DSP}}  r_{\\text{TPU}} \\end{pmatrix}$ 的形式报告你的最终答案。以字节表示 $T_{\\text{DSP}}$ 和 $T_{\\text{TPU}}$，以小数表示 $r_{\\text{DSP}}$ 和 $r_{\\text{TPU}}$。将 $r_{\\text{DSP}}$ 和 $r_{\\text{TPU}}$ 四舍五入到四位有效数字。最终的方框答案中不要包含单位。",
            "solution": "解决方案需要计算四个量：DSP 每个输出样本的稳态 DRAM 流量 $T_{\\text{DSP}}$；TPU 每个输出分块的 DRAM 流量 $T_{\\text{TPU}}$；DSP 所需 DRAM 带宽与可用 DRAM 带宽之比 $r_{\\text{DSP}}$；以及 TPU 的相应比率 $r_{\\text{TPU}}$。\n\n**1. DSP DRAM 流量（$T_{\\text{DSP}}$）的推导**\n\n问题指明，在稳态操作中，每生成一个输出，DSP 就会从 DRAM 中获取一个新的输入样本，并将一个完成的输出样本写入 DRAM。有限脉冲响应（FIR）滤波器的系数被预加载并保存在片上 SRAM 中，因此不会对稳态 DRAM 流量产生贡献。\n\n一个输入样本的大小 $S_{\\text{in}}$ 被给定为十六位（$16$-bit）。以字节为单位的大小是：\n$$S_{\\text{in}} = \\frac{16 \\text{ bits}}{8 \\text{ bits/byte}} = 2 \\text{ bytes}$$\n一个输出样本的大小 $S_{\\text{out}}$ 被给定为三十二位（$32$-bit）。以字节为单位的大小是：\n$$S_{\\text{out}} = \\frac{32 \\text{ bits}}{8 \\text{ bits/byte}} = 4 \\text{ bytes}$$\n每个输出样本的总 DRAM 流量 $T_{\\text{DSP}}$ 是输入读取流量和输出写入流量的总和。\n$$T_{\\text{DSP}} = S_{\\text{in}} + S_{\\text{out}} = 2 \\text{ bytes} + 4 \\text{ bytes} = 6 \\text{ bytes}$$\n\n**2. TPU DRAM 流量（$T_{\\text{TPU}}$）的推导**\n\nTPU 计算输出矩阵 $C$ 的一个分块，大小为 $T_{m} \\times T_{n}$，其中 $T_{m} = 128$，$T_{n} = 128$。这是通过将内积维度 $K=1024$ 分成大小为 $T_{k}=256$ 的块来处理的。对于内积维度的每个块，TPU 从 DRAM 流式传输一个激活子分块和一个权重子分块。完成的输出分块被一次性写入 DRAM。\n\n内积维度的块数 $N_k$ 为：\n$$N_k = \\frac{K}{T_k} = \\frac{1024}{256} = 4$$\n对于这 $N_k$ 个块中的每一个，从 DRAM 读取以下数据：\n- 一个激活子分块 $A_{\\text{sub}}$，大小为 $T_{m} \\times T_{k} = 128 \\times 256$，元素为八位（$8$-bit）（$1$ 字节/元素）。其大小为 $S_{A_{\\text{sub}}} = 128 \\times 256 \\times 1 = 32768$ 字节。\n- 一个权重子分块 $B_{\\text{sub}}$，大小为 $T_{k} \\times T_{n} = 256 \\times 128$，元素为八位（$8$-bit）（$1$ 字节/元素）。其大小为 $S_{B_{\\text{sub}}} = 256 \\times 128 \\times 1 = 32768$ 字节。\n\n总读取流量 $T_{\\text{read}}$ 是所有 $N_k$ 个块中所有子分块的流量总和：\n$$T_{\\text{read}} = N_k \\times (S_{A_{\\text{sub}}} + S_{B_{\\text{sub}}}) = 4 \\times (32768 \\text{ bytes} + 32768 \\text{ bytes}) = 4 \\times 65536 \\text{ bytes} = 262144 \\text{ bytes}$$\n完成的输出分块 $C_{\\text{tile}}$ 被一次性写入 DRAM。其维度为 $T_{m} \\times T_{n} = 128 \\times 128$，元素为十六位（$16$-bit）（$2$ 字节/元素）。写入流量 $T_{\\text{write}}$ 为：\n$$T_{\\text{write}} = T_{m} \\times T_{n} \\times 2 \\text{ bytes} = 128 \\times 128 \\times 2 = 16384 \\times 2 = 32768 \\text{ bytes}$$\n每个输出分块的总流量 $T_{\\text{TPU}}$ 是读取和写入流量的总和。\n$$T_{\\text{TPU}} = T_{\\text{read}} + T_{\\text{write}} = 262144 \\text{ bytes} + 32768 \\text{ bytes} = 294912 \\text{ bytes}$$\n\n**3. DSP 带宽瓶颈比率（$r_{\\text{DSP}}$）的推导**\n\n该比率是所需的 DRAM 带宽（$B_{\\text{req, DSP}}$）除以可用的 DRAM 带宽（$B_{\\text{DSP}}$）。所需的带宽是每个样本的流量（$T_{\\text{DSP}}$）与目标采样率（$f_{\\text{DSP}}$）的乘积。\n$$B_{\\text{req, DSP}} = T_{\\text{DSP}} \\times f_{\\text{DSP}} = (6 \\text{ bytes/sample}) \\times (1.5 \\times 10^{9} \\text{ samples/s}) = 9.0 \\times 10^{9} \\text{ bytes/s}$$\n可用的带宽给定为 $B_{\\text{DSP}} = 6.0 \\times 10^{9}$ 字节/秒。比率 $r_{\\text{DSP}}$ 为：\n$$r_{\\text{DSP}} = \\frac{B_{\\text{req, DSP}}}{B_{\\text{DSP}}} = \\frac{9.0 \\times 10^{9} \\text{ bytes/s}}{6.0 \\times 10^{9} \\text{ bytes/s}} = 1.5$$\n表示为四位有效数字，此值为 $1.500$。\n\n**4. TPU 带宽瓶颈比率（$r_{\\text{TPU}}$）的推导**\n\n该比率是维持计算受限的分块速率所需的 DRAM 带宽（$B_{\\text{req, TPU}}$）除以可用的 DRAM 带宽（$B_{\\text{TPU}}$）。\n\n首先，我们计算每个输出分块的乘法累加（MAC）操作数 $N_{\\text{ops}}$：\n$$N_{\\text{ops}} = T_{m} \\times T_{n} \\times K = 128 \\times 128 \\times 1024 = 2^7 \\times 2^7 \\times 2^{10} = 2^{24} = 16777216 \\text{ MACs}$$\n计算受限的分块速率 $f_{\\text{tile}}$ 是峰值性能 $P = 4.096 \\times 10^{12}$ MACs/s 除以 $N_{\\text{ops}}$：\n$$f_{\\text{tile}} = \\frac{P}{N_{\\text{ops}}} = \\frac{4.096 \\times 10^{12} \\text{ MACs/s}}{16777216 \\text{ MACs/tile}} = 244140.625 \\text{ tiles/s}$$\n所需的带宽是每个分块的流量（$T_{\\text{TPU}}$）与此速率的乘积：\n$$B_{\\text{req, TPU}} = T_{\\text{TPU}} \\times f_{\\text{tile}} = 294912 \\text{ bytes/tile} \\times 244140.625 \\text{ tiles/s}$$\n为保持精度，我们使用精确的表示：$T_{\\text{TPU}} = 9 \\times 2^{15}$ 字节 和 $f_{\\text{tile}} = \\frac{4.096 \\times 10^{12}}{2^{24}} = \\frac{2^{12} \\times 10^9}{2^{24}} = \\frac{10^9}{2^{12}}$ 分块/秒。\n$$B_{\\text{req, TPU}} = (9 \\times 2^{15}) \\times \\left(\\frac{10^9}{2^{12}}\\right) = 9 \\times 2^{3} \\times 10^9 = 72 \\times 10^9 \\text{ bytes/s}$$\n可用的 TPU 带宽给定为 $B_{\\text{TPU}} = 3.0 \\times 10^{11}$ 字节/秒。比率 $r_{\\text{TPU}}$ 为：\n$$r_{\\text{TPU}} = \\frac{B_{\\text{req, TPU}}}{B_{\\text{TPU}}} = \\frac{72 \\times 10^9 \\text{ bytes/s}}{3.0 \\times 10^{11} \\text{ bytes/s}} = \\frac{72}{300} = 0.24$$\n表示为四位有效数字，此值为 $0.2400$。",
            "answer": "$$\\boxed{\\begin{pmatrix} 6  294912  1.500  0.2400 \\end{pmatrix}}$$"
        },
        {
            "introduction": "理想的数学计算与现实世界的硬件实现之间存在一道鸿沟，即有限的数值精度。本练习探讨了量化——将连续或高精度数值映射到有限比特表示的过程——及其对两种不同应用领域性能的影响。你将为DSP的定点运算建立信号噪声比（$SNR$）退化模型，并为TPU的后训练量化（post-training quantization）建立模型，估算其对模型分类准确率的影响。通过这个练习，你将学会如何量化分析数值精度这一底层硬件约束如何转化为高层应用性能的下降，并理解在传统信号处理和现代机器学习中，精度与效率之间的微妙权衡。",
            "id": "3634561",
            "problem": "数字信号处理器 (DSP) 和张量处理单元 (TPU) 都受到有限精度运算的影响。信噪比 (SNR) 和分类准确率是这两个领域中使用的两种不同性能指标。对于 DSP，考虑一个均匀中踏量化器，它在一个已知的动态范围内四舍五入到最近的最低有效位。您可以假设以下基本定义和事实：信噪比 (SNR) 定义为信号功率与噪声功率之比，并且当输入跨越多个量化单元时，均匀量化产生的舍入误差是零均值且与输入无关的。对于 TPU，考虑在最后一个全连接层中对权重和激活进行训练后量化，该层通过乘法累加运算的总和产生单个 logit。\n\n给定以下科学上合理且自洽的场景。\n\n- 数字信号处理器 (DSP) 方面：\n  - 输入信号是零均值的，方差为 $\\sigma_{x}^{2} = 0.10$，并被限制在动态范围 $[-R, R]$ 内，其中 $R = 1$。\n  - 量化器使用 $b_{x} = 12$ 位并采用四舍五入到最近值的方法。\n\n- 张量处理单元 (TPU) 方面：\n  - 最后一层计算一个 logit $y = \\sum_{i=1}^{N} w_{i} x_{i}$，其中有 $N = 1024$ 个独立项。\n  - 训练后量化对激活 $x_{i}$ 使用 $b_{a} = 8$ 位，范围在 $[-R_{a}, R_{a}]$ 之间，其中 $R_{a} = 1$；对权重 $w_{i}$ 使用 $b_{w} = 8$ 位，范围在 $[-R_{w}, R_{w}]$ 之间，其中 $R_{w} = 0.5$。\n  - 量化前的二阶矩为 $E[x_{i}^{2}] = 0.05$ 和 $E[w_{i}^{2}] = 0.02$，并且对于不同的 $i$，权重和激活的量化误差彼此独立，也与 $(w_{i}, x_{i})$ 独立。\n  - 对于一个典型的边界决策，量化前 top-1 和次优的 softmax 前 logit 之间的裕度为 $m_{0} = 0.0552$。量化后，将这两个 logit 的误差建模为独立的零均值高斯变量（通过聚合许多小的独立舍入误差），其方差相同，等于最后一层中 $x_{i}$ 和 $w_{i}$ 的量化所引起的 logit 误差方差。\n  - 量化前的基线 top-1 准确率为 $\\alpha_{0} = 0.92$，并且有 $f = 0.25$ 比例的评估样本是边界样本，即其决策取决于该裕度 $m_{0}$。\n\n使用第一性原理和以上假设：\n1. 推导由于定点舍入导致的 DSP 的 SNR 退化模型，并根据给定参数计算以分贝为单位的舍入噪声限制的 SNR。这仅用于您的推理过程，不是要求的最终数值输出。\n2. 将 TPU 训练后量化噪声通过最后一层传播，以获得 logit 噪声方差，然后在高斯模型下，将边界样本的误分类概率近似为两个 logit 之间的噪声差超过 $m_{0}$ 的尾部概率。\n3. 使用此结果估计量化后的新 top-1 准确率 $\\alpha$，公式为 $\\alpha = \\alpha_{0} - f \\, p$，其中 $p$ 是在推导出的模型下边界样本的误分类概率。\n\n将您最终的 $\\alpha$ 数值答案四舍五入到四位有效数字。以小数形式表示最终准确率。",
            "solution": "该问题要求分析有限精度运算对数字信号处理器 (DSP) 和张量处理单元 (TPU) 性能的影响。最终目标是计算 TPU 模型在训练后量化后的估计 top-1 准确率。解答过程根据问题陈述中概述的步骤进行组织。\n\n首先，我们建立量化误差的基本模型。对于一个在动态范围 $[-R, R]$ 内使用 $b$ 位的均匀量化器，其量化步长 $\\Delta$ 由 $\\Delta = \\frac{2R}{2^b}$ 给出。问题指定了四舍五入到最近的量化级别。相关的量化误差 $e_q$ 通常被建模为一个在区间 $[-\\frac{\\Delta}{2}, \\frac{\\Delta}{2}]$ 上均匀分布的随机变量。该误差的均值为 $E[e_q] = 0$，其方差（代表噪声功率）为 $\\sigma_e^2 = \\frac{\\Delta^2}{12}$。\n\n### 第 1 部分：DSP 信噪比 (SNR) 分析\n\n根据要求，这部分作为推理过程的基础。SNR 是信号功率与噪声功率之比。\n\n输入到 DSP 的信号的方差（功率）为 $\\sigma_x^2 = 0.10$。\n量化器有 $b_x = 12$ 位，工作范围为 $[-R, R]$，其中 $R=1$。\n信号的量化步长为：\n$$ \\Delta_x = \\frac{2R}{2^{b_x}} = \\frac{2 \\times 1}{2^{12}} = \\frac{2}{4096} = \\frac{1}{2048} $$\n量化噪声的方差为：\n$$ \\sigma_e^2 = \\frac{\\Delta_x^2}{12} = \\frac{(1/2048)^2}{12} = \\frac{1}{12 \\cdot (2^{11})^2} = \\frac{1}{12 \\cdot 2^{22}} = \\frac{1}{50331648} $$\n信噪比 (SNR) 是信号功率与噪声功率之比：\n$$ \\text{SNR} = \\frac{\\sigma_x^2}{\\sigma_e^2} = \\frac{0.10}{1/50331648} = 0.10 \\times 50331648 = 5033164.8 $$\n以分贝 (dB) 为单位，SNR 为：\n$$ \\text{SNR}_{\\text{dB}} = 10 \\log_{10}(\\text{SNR}) = 10 \\log_{10}(5033164.8) \\approx 67.02 \\, \\text{dB} $$\n该值表示在给定 DSP 参数下，由于量化导致的信号质量的理论极限。\n\n### 第 2 部分：TPU 量化噪声传播和误分类概率\n\n主要任务是分析量化对 TPU 最后一个全连接层的影响。Logit 计算为 $y = \\sum_{i=1}^{N} w_i x_i$。量化后，权重 $w_i$ 和激活 $x_i$ 分别变为 $w_{q,i} = w_i + e_{w,i}$ 和 $x_{q,i} = x_i + e_{x,i}$。量化后的 logit 为 $y_q = \\sum_{i=1}^{N} w_{q,i} x_{q,i}$。\n\n首先，我们计算激活 ($e_{x,i}$) 和权重 ($e_{w,i}$) 的量化误差的方差。\n对于激活，使用 $b_a=8$ 位，范围为 $[-R_a, R_a]$，其中 $R_a=1$。步长为 $\\Delta_a = \\frac{2R_a}{2^{b_a}} = \\frac{2 \\times 1}{2^8} = \\frac{1}{128}$。\n激活误差方差为：\n$$ \\sigma_{e_a}^2 = \\frac{\\Delta_a^2}{12} = \\frac{(1/128)^2}{12} = \\frac{1}{12 \\cdot 16384} = \\frac{1}{196608} $$\n对于权重，使用 $b_w=8$ 位，范围为 $[-R_w, R_w]$，其中 $R_w=0.5$。步长为 $\\Delta_w = \\frac{2R_w}{2^{b_w}} = \\frac{2 \\times 0.5}{2^8} = \\frac{1}{256}$。\n权重误差方差为：\n$$ \\sigma_{e_w}^2 = \\frac{\\Delta_w^2}{12} = \\frac{(1/256)^2}{12} = \\frac{1}{12 \\cdot 65536} = \\frac{1}{786432} $$\n计算出的 logit 中的误差为 $e_y = y_q - y$。\n$$ e_y = \\sum_{i=1}^{N} (w_i + e_{w,i})(x_i + e_{x,i}) - \\sum_{i=1}^{N} w_i x_i = \\sum_{i=1}^{N} (w_i e_{x,i} + x_i e_{w,i} + e_{w,i} e_{x,i}) $$\n总 logit 误差方差 $\\sigma_{e_y}^2$ 是这个和的方差。由于对于不同的 $i$，误差 $e_{w,i}, e_{x,i}$ 是独立的，并且也与信号 $w_i, x_i$ 独立，所以和的方差是各项方差的和。\n$$ \\sigma_{e_y}^2 = \\text{Var}\\left(\\sum_{i=1}^{N} (w_i e_{x,i} + x_i e_{w,i} + e_{w,i} e_{x,i})\\right) = \\sum_{i=1}^{N} \\text{Var}(w_i e_{x,i} + x_i e_{w,i} + e_{w,i} e_{x,i}) $$\n随机变量 $w_i, x_i, e_{w,i}, e_{x,i}$ 都是独立的并且中心化的（误差是零均值），所以内部和的方差是其各项方差的和：\n$$ \\text{Var}(w_i e_{x,i} + x_i e_{w,i} + e_{w,i} e_{x,i}) = \\text{Var}(w_i e_{x,i}) + \\text{Var}(x_i e_{w,i}) + \\text{Var}(e_{w,i} e_{x,i}) $$\n$$ \\text{Var}(w_i e_{x,i}) = E[w_i^2 e_{x,i}^2] - (E[w_i e_{x,i}])^2 = E[w_i^2] E[e_{x,i}^2] - 0 = E[w_i^2] \\sigma_{e_a}^2 $$\n类似地，$\\text{Var}(x_i e_{w,i}) = E[x_i^2]\\sigma_{e_w}^2$ 并且 $\\text{Var}(e_{w,i} e_{x,i}) = \\sigma_{e_w}^2 \\sigma_{e_a}^2$。问题中的数据表明，对于所有的 $i$，$E[w_i^2]$ 和 $E[x_i^2]$ 是相同的。因此，总方差是单个项方差的 $N$ 倍：\n$$ \\sigma_{e_y}^2 = N \\left( E[w^2]\\sigma_{e_a}^2 + E[x^2]\\sigma_{e_w}^2 + \\sigma_{e_w}^2 \\sigma_{e_a}^2 \\right) $$\n代入给定值 $N=1024$, $E[x^2]=0.05$ 和 $E[w^2]=0.02$：\n$$ \\sigma_{e_y}^2 = 1024 \\left( 0.02 \\cdot \\frac{1}{196608} + 0.05 \\cdot \\frac{1}{786432} + \\frac{1}{196608 \\cdot 786432} \\right) $$\n与前两项相比，第三项可以忽略不计。近似计算如下：\n$$ \\sigma_{e_y}^2 \\approx 1024 \\left( \\frac{0.02}{196608} + \\frac{0.05}{786432} \\right) = 1024 \\left( \\frac{4 \\cdot 0.02 + 0.05}{786432} \\right) = 1024 \\frac{0.08 + 0.05}{786432} = \\frac{1024 \\cdot 0.13}{786432} $$\n由于 $786432 = 768 \\times 1024$，可以简化为：\n$$ \\sigma_{e_y}^2 = \\frac{0.13}{768} = \\frac{13}{76800} \\approx 0.00016927 $$\n对于一个边界决策，如果噪声翻转了 top-1 和次优 logit 的顺序，就会发生误分类。设这两个 logit 中的误差为 $e_1$ 和 $e_2$。它们被建模为独立的 高斯随机变量 $e_1, e_2 \\sim \\mathcal{N}(0, \\sigma_{e_y}^2)$。如果原始裕度 $m_0$ 被误差之差所克服，就会发生翻转。设原始 logit 为 $L_1$ 和 $L_2$，使得 $L_1 - L_2 = m_0$。如果 $L_{1,q}  L_{2,q}$，则发生误分类，这意味着 $L_1 + e_1  L_2 + e_2$，或者 $e_2 - e_1 > L_1 - L_2 = m_0$。\n误差之差 $e_{diff} = e_2 - e_1$ 也是一个高斯随机变量。其均值为 $E[e_{diff}] = 0$，方差为 $\\text{Var}(e_{diff}) = \\text{Var}(e_2) + \\text{Var}(e_1) = 2\\sigma_{e_y}^2$。\n$$ \\text{Var}(e_{diff}) = 2 \\cdot \\frac{13}{76800} = \\frac{26}{76800} = \\frac{13}{38400} $$\n标准差为 $\\sigma_{diff} = \\sqrt{\\frac{13}{38400}} \\approx 0.018399$。\n这些边界情况的误分类概率 $p$ 为：\n$$ p = P(e_{diff} > m_0) $$\n给定 $m_0=0.0552$。我们对变量进行标准化，以从标准正态分布 $Z \\sim \\mathcal{N}(0,1)$ 中找到概率。\n$$ p = P\\left(Z > \\frac{m_0 - 0}{\\sigma_{diff}}\\right) = P\\left(Z > \\frac{0.0552}{\\sqrt{13/38400}}\\right) $$\n尾部概率函数的参数为：\n$$ z = \\frac{0.0552}{\\sqrt{13/38400}} \\approx \\frac{0.0552}{0.01839945} \\approx 3.00008 $$\n这个值非常接近 $3$。我们计算尾部概率，通常用 Q 函数表示，$Q(z) = 1-\\Phi(z)$，其中 $\\Phi$ 是标准正态分布的累积分布函数 (CDF)。\n$$ p = Q(3.00008) \\approx Q(3) = 1 - \\Phi(3) \\approx 1 - 0.99865 = 0.00135 $$\n使用一个更精确的值，$p \\approx 0.0013496$。\n\n### 第 3 部分：新 Top-1 准确率的估计\n\n新的准确率 $\\alpha$ 是通过从基线准确率 $\\alpha_0$ 中减去被错误分类的边界样本的数量来估计的。有 $f=0.25$ 比例的样本是边界样本，它们以概率 $p$ 被错误分类。\n$$ \\alpha = \\alpha_0 - f \\cdot p $$\n代入数值：$\\alpha_0=0.92$，$f=0.25$ 和 $p \\approx 0.0013496$。\n$$ \\alpha = 0.92 - 0.25 \\times 0.0013496 = 0.92 - 0.0003374 = 0.9196626 $$\n问题要求将最终答案四舍五入到四位有效数字。\n$$ \\alpha \\approx 0.9197 $$\n这个结果表明准确率有非常小的下降，从 $92\\%$ 降至约 $91.97\\%$，这证明了对于这个特定的模型和任务，即使在决策裕度很小的样本上，8 位量化也是有效的。",
            "answer": "$$\\boxed{0.9197}$$"
        }
    ]
}