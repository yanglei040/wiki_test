{
    "hands_on_practices": [
        {
            "introduction": "在处理器流水线中引入指令踪迹缓存（Trace Cache, TC）是一项重要的设计决策。虽然踪迹缓存可以通过提供高带宽指令流来提升性能，但它自身也会消耗额外的能量。本练习将指导您进行定量分析，通过计算配备与未配备踪迹缓存两种系统的平均每次取指能耗，学习如何对体系结构增强带来的能效进行建模和评估，从而确定踪迹缓存的能效盈亏平衡点。",
            "id": "3650604",
            "problem": "一个超标量处理器通过在常规指令缓存 (IC) 之上放置一个踪迹缓存 (TC) 来增强其前端。每个指令提取周期首先探测 TC；如果 TC 未命中，则探测 IC；如果 IC 未命中，则访问较低级别的未命中路径（例如，二级缓存和主内存）。设每次访问的动态能耗为：TC 为 $E_{tc}$，IC 为 $E_{ic}$，以及当 IC 未命中时，在 IC 访问之外额外产生的较低级别未命中路径能耗为 $E_{m}$。设 TC 命中率为 $h_{tc}$，IC 命中率（以访问 IC 为条件）为 $h_{ic}$。假设一次尝试性访问，无论命中与否，都会消耗其能量，并且 TC 的存在不会改变那些确实到达 IC 的提取操作的条件 IC 命中率。\n\n仅使用命中率和期望值的定义，完成以下任务：\n\n1. 推导在有 TC 的情况下每次提取的平均能耗的解析表达式，用 $E_{tc}$、$E_{ic}$、$E_{m}$、$h_{tc}$ 和 $h_{ic}$ 表示。\n\n2. 推导在没有 TC（只有 IC 的系统）的情况下每次提取的平均能耗的解析表达式，用 $E_{ic}$、$E_{m}$ 和 $h_{ic}$ 表示。\n\n3. 使用参数值 $E_{tc} = 0.18$ nJ、$E_{ic} = 0.25$ nJ、$E_{m} = 1.20$ nJ、$h_{ic} = 0.95$ 和 $h_{tc} = 0.65$，计算两个系统每次提取的平均能耗数值，单位为纳焦耳 (nJ)。\n\n4. 确定收支平衡的 TC 命中率 $h_{tc}^{\\star}$，在该命中率下，有 TC 时的每次提取平均能耗等于只有 IC 的系统的平均能耗。提供一个用 $E_{tc}$、$E_{ic}$、$E_{m}$ 和 $h_{ic}$ 表示 $h_{tc}^{\\star}$ 的封闭形式表达式，然后根据给定的参数值进行数值计算。\n\n仅报告 $h_{tc}^{\\star}$ 作为您的最终答案，表示为无单位的小数，并四舍五入到四位有效数字。",
            "solution": "经评估，问题陈述有效。它在科学上基于计算机体系结构的原理，具体来说是处理器前端设计和能耗模型。该问题是适定的，所有必要的变量、常数和假设都已明确定义。它是客观且无歧义的，允许通过逻辑和数学推导得出一个唯一的、可验证的解。因此，我们可以进行正式求解。\n\n每次提取的平均能耗是所消耗能量的期望值，通过将每个可能结果的能量与其发生概率的乘积相加来计算。\n\n首先，我们推导存在踪迹缓存 (TC) 时每次提取的平均能耗的解析表达式，我们将其表示为 $E_{\\text{avg, TC}}$。提取过程有三个互斥的结果：\n1.  **TC 命中**：指令提取在 TC 中命中。这发生的概率为 $h_{\\text{tc}}$。消耗的能量是 TC 访问的能量 $E_{\\text{tc}}$。\n2.  **TC 未命中，指令缓存 (IC) 命中**：提取在 TC 中未命中，但在 IC 中命中。只有当 TC 未命中时才会走这条路径，其概率为 $(1 - h_{\\text{tc}})$。在 TC 未命中的情况下，会启动一次 IC 访问。这次 IC 访问命中的概率是 $h_{\\text{ic}}$。这个序列的总概率是 $(1 - h_{\\text{tc}})h_{\\text{ic}}$。消耗的能量是 TC 访问能量和 IC 访问能量之和，$E_{\\text{tc}} + E_{\\text{ic}}$。\n3.  **TC 未命中，IC 未命中**：提取在 TC 中未命中，并且在 IC 中也未命中。TC 未命中的概率是 $(1 - h_{\\text{tc}})$。随后的 IC 未命中的概率是 $(1 - h_{\\text{ic}})$。这个序列的总概率是 $(1 - h_{\\text{tc}})(1 - h_{\\text{ic}})$。消耗的能量是 TC 访问能量、IC 访问能量以及访问较低级别存储器的额外能量之和，$E_{\\text{tc}} + E_{\\text{ic}} + E_{\\text{m}}$。\n\n每次提取的总平均能耗 $E_{\\text{avg, TC}}$ 是每种情况的能耗贡献之和：\n$$E_{\\text{avg, TC}} = (h_{\\text{tc}})(E_{\\text{tc}}) + (1 - h_{\\text{tc}})h_{\\text{ic}}(E_{\\text{tc}} + E_{\\text{ic}}) + (1 - h_{\\text{tc}})(1 - h_{\\text{ic}})(E_{\\text{tc}} + E_{\\text{ic}} + E_{\\text{m}})$$\n这个表达式可以简化，考虑到在该系统中，每次提取访问总是探测 TC，因此总是消耗 $E_{\\text{tc}}$。如果 TC 未命中（概率为 $1 - h_{\\text{tc}}$），则进行一次 IC 访问，消耗 $E_{\\text{ic}}$。如果该 IC 访问也未命中（概率为 $1 - h_{\\text{ic}}$），则会消耗额外的能量 $E_{\\text{m}}$。这导出了一个更直接的公式：\n$$E_{\\text{avg, TC}} = E_{\\text{tc}} + (1 - h_{\\text{tc}})E_{\\text{ic}} + (1 - h_{\\text{tc}})(1 - h_{\\text{ic}})E_{\\text{m}}$$\n这是问题第一部分所要求的表达式。\n\n第二，我们推导只有 IC 的系统 (IC-only system) 的平均能耗 $E_{\\text{avg, IC-only}}$。在这个系统中，每次提取都访问 IC。\n1.  **IC 命中**：提取在 IC 中命中。这发生的概率为 $h_{\\text{ic}}$。消耗的能量是 $E_{\\text{ic}}$。\n2.  **IC 未命中**：提取在 IC 中未命中。这发生的概率为 $(1 - h_{\\text{ic}})$。消耗的能量是 IC 访问的能量加上未命中路径的额外能量，$E_{\\text{ic}} + E_{\\text{m}}$。\n\n平均能耗 $E_{\\text{avg, IC-only}}$ 为：\n$$E_{\\text{avg, IC-only}} = h_{\\text{ic}}(E_{\\text{ic}}) + (1 - h_{\\text{ic}})(E_{\\text{ic}} + E_{\\text{m}})$$\n简化这个表达式：\n$$E_{\\text{avg, IC-only}} = h_{\\text{ic}}E_{\\text{ic}} + E_{\\text{ic}} - h_{\\text{ic}}E_{\\text{ic}} + (1 - h_{\\text{ic}})E_{\\text{m}}$$\n$$E_{\\text{avg, IC-only}} = E_{\\text{ic}} + (1 - h_{\\text{ic}})E_{\\text{m}}$$\n这是问题第二部分所要求的表达式。\n\n第三，我们使用给定的参数计算两个系统的数值平均能耗：$E_{\\text{tc}} = 0.18$ nJ、$E_{\\text{ic}} = 0.25$ nJ、$E_{\\text{m}} = 1.20$ nJ、$h_{\\text{ic}} = 0.95$ 和 $h_{\\text{tc}} = 0.65$。\n对于有 TC 的系统：\n$$E_{\\text{avg, TC}} = 0.18 + (1 - 0.65) \\times 0.25 + (1 - 0.65)(1 - 0.95) \\times 1.20$$\n$$E_{\\text{avg, TC}} = 0.18 + (0.35 \\times 0.25) + (0.35 \\times 0.05 \\times 1.20)$$\n$$E_{\\text{avg, TC}} = 0.18 + 0.0875 + 0.021 = 0.2885 \\text{ nJ}$$\n对于只有 IC 的系统：\n$$E_{\\text{avg, IC-only}} = 0.25 + (1 - 0.95) \\times 1.20$$\n$$E_{\\text{avg, IC-only}} = 0.25 + (0.05 \\times 1.20)$$\n$$E_{\\text{avg, IC-only}} = 0.25 + 0.06 = 0.31 \\text{ nJ}$$\n\n第四，我们确定收支平衡的 TC 命中率 $h_{\\text{tc}}^{\\star}$，此时两个系统的平均能耗相等：\n$$E_{\\text{avg, TC}}|_{h_{\\text{tc}} = h_{\\text{tc}}^{\\star}} = E_{\\text{avg, IC-only}}$$\n代入推导出的解析表达式：\n$$E_{\\text{tc}} + (1 - h_{\\text{tc}}^{\\star})E_{\\text{ic}} + (1 - h_{\\text{tc}}^{\\star})(1 - h_{\\text{ic}})E_{\\text{m}} = E_{\\text{ic}} + (1 - h_{\\text{ic}})E_{\\text{m}}$$\n我们可以将左侧的项 $(1 - h_{\\text{tc}}^{\\star})$ 因子分解出来：\n$$E_{\\text{tc}} + (1 - h_{\\text{tc}}^{\\star}) [E_{\\text{ic}} + (1 - h_{\\text{ic}})E_{\\text{m}}] = E_{\\text{ic}} + (1 - h_{\\text{ic}})E_{\\text{m}}$$\n注意到左边方括号中的项等于右边的整个表达式，即 $E_{\\text{avg, IC-only}}$。为了清晰起见，我们进行代换：\n$$E_{\\text{tc}} + (1 - h_{\\text{tc}}^{\\star}) E_{\\text{avg, IC-only}} = E_{\\text{avg, IC-only}}$$\n现在，我们求解 $h_{\\text{tc}}^{\\star}$：\n$$E_{\\text{tc}} = E_{\\text{avg, IC-only}} - (1 - h_{\\text{tc}}^{\\star}) E_{\\text{avg, IC-only}}$$\n$$E_{\\text{tc}} = E_{\\text{avg, IC-only}} (1 - (1 - h_{\\text{tc}}^{\\star}))$$\n$$E_{\\text{tc}} = E_{\\text{avg, IC-only}} (1 - 1 + h_{\\text{tc}}^{\\star})$$\n$$E_{\\text{tc}} = h_{\\text{tc}}^{\\star} E_{\\text{avg, IC-only}}$$\n$$h_{\\text{tc}}^{\\star} = \\frac{E_{\\text{tc}}}{E_{\\text{avg, IC-only}}}$$\n代入 $E_{\\text{avg, IC-only}}$ 的表达式，得到收支平衡命中率的最终封闭形式表达式：\n$$h_{\\text{tc}}^{\\star} = \\frac{E_{\\text{tc}}}{E_{\\text{ic}} + (1 - h_{\\text{ic}})E_{\\text{m}}}$$\n最后，我们使用提供的参数值对该表达式进行数值计算：\n$$h_{\\text{tc}}^{\\star} = \\frac{0.18}{0.25 + (1 - 0.95) \\times 1.20}$$\n$$h_{\\text{tc}}^{\\star} = \\frac{0.18}{0.25 + 0.05 \\times 1.20} = \\frac{0.18}{0.25 + 0.06} = \\frac{0.18}{0.31}$$\n$$h_{\\text{tc}}^{\\star} \\approx 0.58064516...$$\n四舍五入到四位有效数字，我们得到 $h_{\\text{tc}}^{\\star} \\approx 0.5806$。",
            "answer": "$$\\boxed{0.5806}$$"
        },
        {
            "introduction": "超越抽象的性能模型，架构师必须面对芯片物理设计的现实约束。本练习探讨了踪迹缓存设计中一个关键的权衡：面积（成本）与访问时间（性能）。通过比较将元数据与指令数据存储在一起的单片式（monolithic）设计和将它们分离的分割式（split）设计，您将深入理解物理布局决策如何影响处理器的周期时间和芯片面积，这是微架构设计中的两个基本限制。",
            "id": "3650627",
            "problem": "一个微架构团队正在设计一个指令追踪缓存（Instruction Trace Cache），该缓存用于存储长度不超过固定指令槽数量的追踪。每个追踪条目存储一个指令束和每个追踪的元数据。该团队正在考虑两种存储元数据的组织方式：（i）单片式，元数据与指令束存储在同一个静态随机存取存储器（SRAM）宏单元中；或（ii）分离式，元数据存储在一个并行访问的独立SRAM宏单元中。您必须计算分离式组织的面积开销，并根据以下基于标准面积核算和关键路径时序建模的假设和定义，确定是否需要分离元数据以满足周期时间目标。\n\n假设：\n- 追踪条目数（深度）：$N = 4096$。\n- 每个追踪的指令束位宽：$B_{\\mathrm{inst}} = 512$ 位。\n- 每个追踪的元数据由一个 $flags$ 字段和一个 $branch\\_mask$ 组成，总位宽为 $B_{\\mathrm{meta}} = 32$ 位。\n- SRAM位单元面积为 $a_{\\mathrm{cell}} = 0.07\\,\\mu\\mathrm{m}^{2}$ 每位。\n- 每个SRAM宏单元具有固定的外围电路面积 $A_{\\mathrm{peri}} = 0.015\\,\\mathrm{mm}^{2}$，与位数无关。每个宏单元实例产生一次外围电路面积。\n- 任何SRAM宏单元的阵列访问时间为 $t_{\\mathrm{arr}} = 0.45\\,\\mathrm{ns}$。\n- 读后对齐和导向网络的延迟被建模为输出位宽 $W$（单位为位）的仿射函数。对于单片式组织（指令加元数据的组合位宽 $W_{\\mathrm{mono}} = B_{\\mathrm{inst}} + B_{\\mathrm{meta}}$），延迟为\n$$\nt_{\\mathrm{align,mono}} = t_{0,\\mathrm{mono}} + s_{\\mathrm{mono}} \\cdot W_{\\mathrm{mono}}, \\quad t_{0,\\mathrm{mono}} = 0.12\\,\\mathrm{ns}, \\quad s_{\\mathrm{mono}} = 1.2 \\times 10^{-3}\\,\\mathrm{ns/bit}.\n$$\n- 对于分离式组织，指令和元数据路径各自拥有自己的对齐和导向网络，位宽分别为 $W_{\\mathrm{inst}} = B_{\\mathrm{inst}}$ 和 $W_{\\mathrm{meta}} = B_{\\mathrm{meta}}$，延迟为\n$$\nt_{\\mathrm{align,inst}} = t_{0,\\mathrm{inst}} + s_{\\mathrm{inst}} \\cdot W_{\\mathrm{inst}}, \\quad t_{0,\\mathrm{inst}} = 0.06\\,\\mathrm{ns}, \\quad s_{\\mathrm{inst}} = 1.0 \\times 10^{-3}\\,\\mathrm{ns/bit},\n$$\n$$\nt_{\\mathrm{align,meta}} = t_{0,\\mathrm{meta}} + s_{\\mathrm{meta}} \\cdot W_{\\mathrm{meta}}, \\quad t_{0,\\mathrm{meta}} = 0.03\\,\\mathrm{ns}, \\quad s_{\\mathrm{meta}} = 0.5 \\times 10^{-3}\\,\\mathrm{ns/bit}.\n$$\n- 在分离式组织中，两个SRAM在同一个流水线阶段被并行访问；该阶段的时间是两条路径中延迟的最大值加上一个小的合并开销 $t_{\\mathrm{merge}} = 0.03\\,\\mathrm{ns}$。因此，阶段时间为\n$$\nt_{\\mathrm{split}} = t_{\\mathrm{arr}} + \\max\\!\\big(t_{\\mathrm{align,inst}},\\, t_{\\mathrm{align,meta}}\\big) + t_{\\mathrm{merge}}.\n$$\n- 在单片式组织中，阶段时间为\n$$\nt_{\\mathrm{mono}} = t_{\\mathrm{arr}} + t_{\\mathrm{align,mono}}.\n$$\n- 目标周期时间为 $T_{\\mathrm{target}} = 1.10\\,\\mathrm{ns}$。\n\n将SRAM宏单元的面积定义为位单元面积和外围电路面积之和。在单片式组织中，有一个位宽为 $W_{\\mathrm{mono}}$、深度为 $N$ 的宏单元。在分离式组织中，有两个宏单元（一个用于指令，一个用于元数据），每个都有自己的外围电路面积。\n\n任务：\n1. 计算分离式组织相对于单片式组织的相对面积开销，定义为\n$$\n\\Delta A_{\\mathrm{frac}} = \\frac{A_{\\mathrm{split}} - A_{\\mathrm{mono}}}{A_{\\mathrm{mono}}},\n$$\n其中 $A_{\\mathrm{mono}}$ 和 $A_{\\mathrm{split}}$ 分别是单片式和分离式组织的总面积。面积以 $\\mathrm{mm}^{2}$ 表示，注意 $1\\,\\mathrm{mm}^{2} = 10^{6}\\,\\mu\\mathrm{m}^{2}$。\n2. 通过将 $t_{\\mathrm{mono}}$ 和 $t_{\\mathrm{split}}$ 与 $T_{\\mathrm{target}}$ 进行比较，决定是否应将元数据放置在单独的SRAM中以缓解时序问题。如果单片式组织不满足 $T_{\\mathrm{target}}$ 而分离式组织满足，则需要进行分离。\n\n如果需要分离，报告一个等于 $\\Delta A_{\\mathrm{frac}}$ 值的最终数值答案；否则报告 $0$。将最终值表示为不带百分号的小数，并四舍五入到四位有效数字。",
            "solution": "该问题陈述经核实具有科学依据、问题定义清晰、客观且完整。它使用简化但合理的SRAM面积和时序模型，展示了计算机微架构中一个标准的权衡分析。所有必要的参数和定义都已提供，没有矛盾或含糊之处。该问题是可解的。\n\n任务是确定在一个追踪缓存中，是否需要将元数据存储与指令存储分离以满足时序目标，如果需要，则计算相关的相对面积开销。这需要一个两部分的分析：首先，计算两种配置的面积以找出开销；其次，计算它们各自的访问时间以与目标进行比较。\n\n首先，我们计算面积开销。一个SRAM宏单元的总面积是所有位单元的面积和一个固定的外围电路面积之和。\n设 $N$ 为追踪条目数，$B_{\\mathrm{inst}}$ 为指令束位宽，$B_{\\mathrm{meta}}$ 为元数据位宽，$a_{\\mathrm{cell}}$ 为单位单元面积，$A_{\\mathrm{peri}}$ 为每个宏单元的外围电路面积。\n\n对于单片式组织，有一个SRAM宏单元。其总位宽为 $W_{\\mathrm{mono}} = B_{\\mathrm{inst}} + B_{\\mathrm{meta}}$。\n位单元的总面积为 $A_{\\mathrm{bits,mono}} = N \\cdot (B_{\\mathrm{inst}} + B_{\\mathrm{meta}}) \\cdot a_{\\mathrm{cell}}$。\n单片式组织的总面积为 $A_{\\mathrm{mono}} = A_{\\mathrm{bits,mono}} + A_{\\mathrm{peri}}$。\n\n对于分离式组织，有两个SRAM宏单元，一个用于指令，一个用于元数据。每个宏单元都有自己的外围电路面积。\n指令位单元的面积为 $A_{\\mathrm{bits,inst}} = N \\cdot B_{\\mathrm{inst}} \\cdot a_{\\mathrm{cell}}$。\n元数据位单元的面积为 $A_{\\mathrm{bits,meta}} = N \\cdot B_{\\mathrm{meta}} \\cdot a_{\\mathrm{cell}}$。\n分离式组织的总面积为 $A_{\\mathrm{split}} = (A_{\\mathrm{bits,inst}} + A_{\\mathrm{peri}}) + (A_{\\mathrm{bits,meta}} + A_{\\mathrm{peri}}) = (A_{\\mathrm{bits,inst}} + A_{\\mathrm{bits,meta}}) + 2 \\cdot A_{\\mathrm{peri}}$。\n总位单元面积与单片式情况相同：$A_{\\mathrm{bits,inst}} + A_{\\mathrm{bits,meta}} = N \\cdot (B_{\\mathrm{inst}} + B_{\\mathrm{meta}}) \\cdot a_{\\mathrm{cell}} = A_{\\mathrm{bits,mono}}$。\n因此，$A_{\\mathrm{split}} = A_{\\mathrm{bits,mono}} + 2 \\cdot A_{\\mathrm{peri}}$。\n\n相对面积开销 $\\Delta A_{\\mathrm{frac}}$ 由下式给出：\n$$\n\\Delta A_{\\mathrm{frac}} = \\frac{A_{\\mathrm{split}} - A_{\\mathrm{mono}}}{A_{\\mathrm{mono}}} = \\frac{(A_{\\mathrm{bits,mono}} + 2 \\cdot A_{\\mathrm{peri}}) - (A_{\\mathrm{bits,mono}} + A_{\\mathrm{peri}})}{A_{\\mathrm{bits,mono}} + A_{\\mathrm{peri}}} = \\frac{A_{\\mathrm{peri}}}{A_{\\mathrm{bits,mono}} + A_{\\mathrm{peri}}}\n$$\n我们现在代入给定的数值。首先，我们将所有面积单位转换为 $\\mathrm{mm}^2$。\n$a_{\\mathrm{cell}} = 0.07\\,\\mu\\mathrm{m}^{2} = 0.07 \\times 10^{-6}\\,\\mathrm{mm}^{2} = 7 \\times 10^{-8}\\,\\mathrm{mm}^{2}$。\n给定的值为：$N = 4096$，$B_{\\mathrm{inst}} = 512\\,\\text{bits}$，$B_{\\mathrm{meta}} = 32\\,\\text{bits}$，$A_{\\mathrm{peri}} = 0.015\\,\\mathrm{mm}^{2}$。\n总位单元面积为：\n$$\nA_{\\mathrm{bits,mono}} = 4096 \\cdot (512 + 32) \\cdot (7 \\times 10^{-8}\\,\\mathrm{mm}^{2}) = 4096 \\cdot 544 \\cdot 7 \\times 10^{-8}\\,\\mathrm{mm}^{2} = 2228224 \\cdot 7 \\times 10^{-8}\\,\\mathrm{mm}^{2} = 0.15597568\\,\\mathrm{mm}^{2}\n$$\n单片式组织的总面积为：\n$$\nA_{\\mathrm{mono}} = 0.15597568\\,\\mathrm{mm}^{2} + 0.015\\,\\mathrm{mm}^{2} = 0.17097568\\,\\mathrm{mm}^{2}\n$$\n相对面积开销为：\n$$\n\\Delta A_{\\mathrm{frac}} = \\frac{0.015\\,\\mathrm{mm}^{2}}{0.17097568\\,\\mathrm{mm}^{2}} \\approx 0.0877317\n$$\n\n接下来，我们进行时序分析。目标周期时间为 $T_{\\mathrm{target}} = 1.10\\,\\mathrm{ns}$。\n单片式阶段时间为 $t_{\\mathrm{mono}} = t_{\\mathrm{arr}} + t_{\\mathrm{align,mono}}$。\n对齐和导向延迟为 $t_{\\mathrm{align,mono}} = t_{0,\\mathrm{mono}} + s_{\\mathrm{mono}} \\cdot W_{\\mathrm{mono}}$。\n给定 $t_{\\mathrm{arr}} = 0.45\\,\\mathrm{ns}$，$t_{0,\\mathrm{mono}} = 0.12\\,\\mathrm{ns}$，$s_{\\mathrm{mono}} = 1.2 \\times 10^{-3}\\,\\mathrm{ns/bit}$，以及 $W_{\\mathrm{mono}} = B_{\\mathrm{inst}} + B_{\\mathrm{meta}} = 512 + 32 = 544\\,\\text{bits}$。\n$$\nt_{\\mathrm{align,mono}} = 0.12\\,\\mathrm{ns} + (1.2 \\times 10^{-3}\\,\\mathrm{ns/bit}) \\cdot (544\\,\\text{bits}) = 0.12\\,\\mathrm{ns} + 0.6528\\,\\mathrm{ns} = 0.7728\\,\\mathrm{ns}\n$$\n$$\nt_{\\mathrm{mono}} = 0.45\\,\\mathrm{ns} + 0.7728\\,\\mathrm{ns} = 1.2228\\,\\mathrm{ns}\n$$\n与目标比较，$t_{\\mathrm{mono}} = 1.2228\\,\\mathrm{ns} > T_{\\mathrm{target}} = 1.10\\,\\mathrm{ns}$。单片式组织未能满足时序要求。\n\n分离式阶段时间为 $t_{\\mathrm{split}} = t_{\\mathrm{arr}} + \\max\\!\\big(t_{\\mathrm{align,inst}},\\, t_{\\mathrm{align,meta}}\\big) + t_{\\mathrm{merge}}$。\n我们计算两条并行路径的延迟。\n对于指令路径：$W_{\\mathrm{inst}} = 512\\,\\text{bits}$，$t_{0,\\mathrm{inst}} = 0.06\\,\\mathrm{ns}$，$s_{\\mathrm{inst}} = 1.0 \\times 10^{-3}\\,\\mathrm{ns/bit}$。\n$$\nt_{\\mathrm{align,inst}} = 0.06\\,\\mathrm{ns} + (1.0 \\times 10^{-3}\\,\\mathrm{ns/bit}) \\cdot (512\\,\\text{bits}) = 0.06\\,\\mathrm{ns} + 0.512\\,\\mathrm{ns} = 0.572\\,\\mathrm{ns}\n$$\n对于元数据路径：$W_{\\mathrm{meta}} = 32\\,\\text{bits}$，$t_{0,\\mathrm{meta}} = 0.03\\,\\mathrm{ns}$，$s_{\\mathrm{meta}} = 0.5 \\times 10^{-3}\\,\\mathrm{ns/bit}$。\n$$\nt_{\\mathrm{align,meta}} = 0.03\\,\\mathrm{ns} + (0.5 \\times 10^{-3}\\,\\mathrm{ns/bit}) \\cdot (32\\,\\text{bits}) = 0.03\\,\\mathrm{ns} + 0.016\\,\\mathrm{ns} = 0.046\\,\\mathrm{ns}\n$$\n关键路径是两者中较长的一个：$\\max(t_{\\mathrm{align,inst}}, t_{\\mathrm{align,meta}}) = \\max(0.572\\,\\mathrm{ns}, 0.046\\,\\mathrm{ns}) = 0.572\\,\\mathrm{ns}$。\n在 $t_{\\mathrm{merge}} = 0.03\\,\\mathrm{ns}$ 的情况下，分离式组织的总时间为：\n$$\nt_{\\mathrm{split}} = 0.45\\,\\mathrm{ns} + 0.572\\,\\mathrm{ns} + 0.03\\,\\mathrm{ns} = 1.052\\,\\mathrm{ns}\n$$\n与目标比较，$t_{\\mathrm{split}} = 1.052\\,\\mathrm{ns} \\le T_{\\mathrm{target}} = 1.10\\,\\mathrm{ns}$。分离式组织满足时序要求。\n\n由于单片式组织不满足目标周期时间（$1.2228\\,\\mathrm{ns} > 1.10\\,\\mathrm{ns}$），而分离式组织满足（$1.052\\,\\mathrm{ns} \\le 1.10\\,\\mathrm{ns}$），因此需要将元数据分离到单独的SRAM中。\n\n在这种情况下，问题要求给出 $\\Delta A_{\\mathrm{frac}}$ 的数值。我们计算出该值约等于 $0.0877317$。四舍五入到四位有效数字得到 $0.08773$。\n如果不需要分离，答案将是 $0$。由于需要分离，答案是计算出的相对面积开销。",
            "answer": "$$\\boxed{0.08773}$$"
        },
        {
            "introduction": "踪迹缓存的效率在很大程度上依赖于准确的分支预测，但当预测出错时会发生什么？本练习探讨了处理器如何从已取出的踪迹内的分支预测错误中恢复。通过对比丢弃整个踪迹的朴素策略与保留正确部分的智能策略，您将通过概率分析来量化一个更优化的恢复机制所能带来的性能收益（以节省的取指周期数衡量），从而揭示流水线控制策略对前端组件效率的巨大影响。",
            "id": "3650574",
            "problem": "一个现代的超标量处理器前端采用指令踪迹缓存 (Instruction Trace Cache, ITC)，它存储沿预测的控制流跨越已执行分支的解码指令序列（微操作）。考虑一个长度为 $L = 32$ 条指令的 ITC 踪迹行，其中恰好包含 $b = 4$ 个条件分支，分别出现在指令索引 $8$、$16$、$24$ 和 $32$ 处。前端取指带宽为 $R = 4$ 条指令/周期。踪迹中的每个条件分支都是独立预测的，错误预测概率为 $p = 0.2$。流水线通过冲刷比第一个错误预测的分支更年轻的指令，并将取指程序计数器重定向到正确的目标来处理错误预测。\n\n在一种朴素的踪迹失效策略中，无论在取出的踪迹行中任何位置检测到错误预测，整行都会被置为无效并被视作错误路径上的工作，因此即使是直到（并包括）第一个错误预测分支的架构正确前缀，也需要在稍后的正确路径上重新获取。与此相反，提出一种选择性冲刷前缀保留策略，在取出的踪迹行中检测到第一个错误预测的分支时，该策略会在指令队列中保留该行直到（并包括）该分支的正确前缀，并且只冲刷其后的更年轻指令。这种补救措施避免了在正确路径上重新获取被保留的前缀。\n\n使用分支结果的独立性来建模行内第一个错误预测分支的位置。从第一性原理和明确的概率推理出发，推导在单个 $L = 32$ 指令踪迹行中，相对于朴素策略，选择性冲刷前缀保留策略在每次错误预测事件中节省的取指周期期望数。将最终数值答案四舍五入到四位有效数字，并以周期为单位表示。",
            "solution": "问题陈述经过严格验证，确认有效。该问题在科学上基于计算机组成与体系结构的原理，内容自洽，提法明确，且客观。唯一解所需的所有参数都已提供：踪迹长度 $L=32$ 条指令，分支数量 $b=4$，分支的具体指令索引 ($k_1=8, k_2=16, k_3=24, k_4=32$)，取指带宽 $R=4$ 条指令/周期，以及独立的分支错误预测概率 $p=0.2$。两种策略（朴素失效策略 vs. 选择性冲刷前缀保留策略）定义清晰。目标是推导选择性冲刷策略在每次错误预测事件中节省的取指周期期望数，这是一个定义明确的数学问题。\n\n问题的核心是计算在踪迹行内发生错误预测的条件下，所节省的取指周期的期望值。\n\n首先，我们来量化特定结果下的节省量。节省量是通过选择性冲刷策略无需重新获取直到（并包括）第一个错误预测分支的正确指令前缀而实现的。朴素策略会使整行失效，从而强制后续重新获取这个正确的前缀。\n\n设四个条件分支分别表示为 $B_1, B_2, B_3, B_4$，位于指令索引 $k_1=8, k_2=16, k_3=24$ 和 $k_4=32$ 处。前端取指带宽为 $R=4$ 条指令/周期。\n\n如果第一个错误预测发生在分支 $B_i$（位于索引 $k_i$），那么正确的指令前缀包含 $k_i$ 条指令。获取这 $k_i$ 条指令所需的取指周期数为 $\\lceil \\frac{k_i}{R} \\rceil$。这个值代表了在这种特定结果下，选择性冲刷策略节省的取指周期数 $S_i$。\n\n让我们计算每种可能的首次错误预测所带来的节省：\n- 如果首次错误预测在 $B_1$（索引 $k_1=8$）：$S_1 = \\lceil \\frac{k_1}{R} \\rceil = \\lceil \\frac{8}{4} \\rceil = 2$ 个周期。\n- 如果首次错误预测在 $B_2$（索引 $k_2=16$）：$S_2 = \\lceil \\frac{k_2}{R} \\rceil = \\lceil \\frac{16}{4} \\rceil = 4$ 个周期。\n- 如果首次错误预测在 $B_3$（索引 $k_3=24$）：$S_3 = \\lceil \\frac{k_3}{R} \\rceil = \\lceil \\frac{24}{4} \\rceil = 6$ 个周期。\n- 如果首次错误预测在 $B_4$（索引 $k_4=32$）：$S_4 = \\lceil \\frac{k_4}{R} \\rceil = \\lceil \\frac{32}{4} \\rceil = 8$ 个周期。\n\n接下来，我们为这些结果中的每一个建模其概率。分支是独立的，每个分支的错误预测概率为 $p=0.2$。正确预测的概率是 $1-p = 0.8$。\n\n设 $E_i$ 为首次错误预测发生在分支 $B_i$ 的事件。\n- 要使 $E_1$ 发生，$B_1$ 必须被错误预测。其概率为 $P(E_1) = p$。\n- 要使 $E_2$ 发生，$B_1$ 必须正确预测而 $B_2$ 必须被错误预测。其概率为 $P(E_2) = (1-p)p$。\n- 要使 $E_3$ 发生，$B_1$ 和 $B_2$ 必须正确预测而 $B_3$ 必须被错误预测。其概率为 $P(E_3) = (1-p)^2 p$。\n- 要使 $E_4$ 发生，$B_1, B_2, B_3$ 必须正确预测而 $B_4$ 必须被错误预测。其概率为 $P(E_4) = (1-p)^3 p$。\n\n问题要求的是*每次错误预测事件*节省的周期期望数。这是一个条件期望。设 $S$ 是表示节省周期数的随机变量，设 $M$ 是踪迹中至少发生一次错误预测的事件。我们需要计算 $E[S|M]$。\n\n事件 $M$ 是事件 $E_1, E_2, E_3, E_4$ 的不交并。因此，其概率为：\n$$P(M) = P(E_1) + P(E_2) + P(E_3) + P(E_4)$$\n或者，$M$ 是所有分支都被正确预测的事件的补集。对于 $b=4$ 个分支，没有错误预测的概率是 $(1-p)^b$。\n$$P(M) = 1 - (1-p)^b = 1 - (1-p)^4$$\n\n在发生错误预测事件的条件下，节省的期望值由以下公式给出：\n$$E[S|M] = \\sum_{i=1}^{4} S_i P(\\text{first miss is at } B_i | M)$$\n使用条件概率的定义，$P(E_i|M) = \\frac{P(E_i \\cap M)}{P(M)}$。由于事件 $E_i$ 蕴含事件 $M$，它们的交集就是 $E_i$。因此，$P(E_i|M) = \\frac{P(E_i)}{P(M)}$。\n\n条件期望变为：\n$$E[S|M] = \\sum_{i=1}^{4} S_i \\frac{P(E_i)}{P(M)} = \\frac{1}{P(M)} \\sum_{i=1}^{4} S_i P(E_i)$$\n\n这可以理解为每次踪迹获取节省的总期望周期数，除以一次踪迹获取导致错误预测的概率。\n\n让我们计算分子，即每次踪迹的总期望节省量 $E[S]$：\n$$E[S] = \\sum_{i=1}^{4} S_i P(E_i) = S_1 p + S_2 (1-p)p + S_3 (1-p)^2 p + S_4 (1-p)^3 p$$\n$$E[S] = p \\sum_{i=1}^{4} S_i (1-p)^{i-1}$$\n\n代入给定值 $p=0.2$ 和 $1-p=0.8$：\n$$E[S] = 0.2 \\left( S_1 (0.8)^0 + S_2 (0.8)^1 + S_3 (0.8)^2 + S_4 (0.8)^3 \\right)$$\n$$E[S] = 0.2 \\left( 2 \\cdot 1 + 4 \\cdot 0.8 + 6 \\cdot 0.64 + 8 \\cdot 0.512 \\right)$$\n$$E[S] = 0.2 \\left( 2 + 3.2 + 3.84 + 4.096 \\right)$$\n$$E[S] = 0.2 (13.136) = 2.6272 \\text{ cycles}$$\n\n现在，我们计算分母 $P(M)$：\n$$P(M) = 1 - (0.8)^4 = 1 - 0.4096 = 0.5904$$\n\n最后，我们计算条件期望：\n$$E[S|M] = \\frac{E[S]}{P(M)} = \\frac{2.6272}{0.5904}$$\n$$E[S|M] \\approx 4.4498644986... \\text{ cycles}$$\n\n问题要求将答案四舍五入到四位有效数字。前四位有效数字是 $4, 4, 4, 9$。第五位数字是 $8$，所以我们将第四位数字向上舍入。\n$$E[S|M] \\approx 4.450 \\text{ cycles}$$",
            "answer": "$$\\boxed{4.450}$$"
        }
    ]
}