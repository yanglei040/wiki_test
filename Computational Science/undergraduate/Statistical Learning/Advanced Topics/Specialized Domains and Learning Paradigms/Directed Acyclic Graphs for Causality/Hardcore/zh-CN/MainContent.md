## 引言
在科学研究与数据分析的众多领域，从观测数据中辨别因果关系是核心挑战之一。我们常常观察到变量之间的关联，但“关联不等于因果”这一警句提醒我们，简单的[统计相关性](@entry_id:267552)往往会误导我们对世界运作方式的理解。为了超越关联，我们需要一个能够严谨表达和检验因果假设的框架。[有向无环图](@entry_id:164045)（Directed Acyclic Graphs, DAGs）正是为此而生的强大语言。

传统统计方法在处理混杂、选择偏倚等问题时常常显得力不从心，导致错误的因果结论。本文旨在填补这一知识鸿沟，系统性地介绍如何利用DAGs这一现代因果科学的基石，来构建清晰的因果模型，并从中推导出可靠的因果效应估计。

本文将引导读者分三步深入探索DAGs的世界。在“原则与机制”一章中，我们将学习DAGs的基本语法，包括[d-分离](@entry_id:748152)、[后门准则](@entry_id:637856)和do算子，建立起因果推断的理论基础。接下来，在“应用与跨学科联系”一章，我们将看到这些理论如何在流行病学、经济学和机器学习等真实场景中解决复杂的因果问题。最后，通过“动手实践”部分，读者将有机会亲手解决具体问题，将理论知识转化为实践技能。

## 原则与机制

在上一章引言的基础上，本章将深入探讨有向无环图（Directed Acyclic Graphs, DAGs）作为一种严谨的因果推理语言的核心原则与机制。我们将学习如何利用DAGs来清晰地表达关于世界如何运作的因果假设，并基于这些假设，推导出从观测数据中识别和估计因果效应的系统性方法。我们将从基本构成要素开始，逐步构建一个完整的框架，用以解决从关联中分离出因果的根本性挑战。

### 将因果假设编码为图形语言

DAGs为我们提供了一种精确、直观的方式来形式化我们的因果知识。在一个DAG中，节点（或顶点）代表系统中的变量，而有向边（或箭头）则代表直接的因果关系。例如，一条从变量 $X$ 指向变量 $Y$ 的箭头（$X \to Y$）表示一个假设：$X$ 是 $Y$ 的一个直接原因。缺少从 $X$ 到 $Y$ 的箭头则是一个更强的假设：$X$ 不是 $Y$ 的直接原因。图的“无环”特性——即从任何节点出发，沿着箭头的方向都无法回到该节点——确保了因果关系的非循环性，即一个变量不能成为自身的间接原因。

一个DAG最重要的属性之一是它所蕴含的**马尔可夫性质 (Markov Property)**。该性质指出，图中每个变量的[概率分布](@entry_id:146404)，仅取决于其直接原因，即它的**父节点 (parents)**。这使得我们可以将变量集合的[联合概率分布](@entry_id:171550)分解为一系列条件概率的乘积。对于一个包含变量集合 $V = \{V_1, V_2, \dots, V_n\}$ 的DAG，其[联合概率分布](@entry_id:171550)可以被分解为：

$$P(V_1, V_2, \dots, V_n) = \prod_{i=1}^{n} P(V_i \mid \text{Pa}(V_i))$$

其中 $\text{Pa}(V_i)$ 代表节点 $V_i$ 的父节点集合。

例如，考虑一个涉及三个变量的经典场景：一个[共同原因](@entry_id:266381) $Z$ 同时影响处理变量 $X$ 和结果变量 $Y$，且 $X$ 也直接影响 $Y$。这个因果故事可以被编码为一个DAG：$Z \to X$, $Z \to Y$, $X \to Y$。根据[马尔可夫性质](@entry_id:139474)，这个系统的[联合概率分布](@entry_id:171550)可以被简洁地表示为 $P(Z, X, Y) = P(Z) P(X \mid Z) P(Y \mid X, Z)$ 。这种分解不仅是一种数学上的便利，它本身就是一个关于数据生成过程的深刻断言，构成了后续所有因果推断的基础。

### 关联的来源：图中的路径

统计学的一个核心准则是“关联不等于因果”。DAGs为我们精确地阐明了这一准则的内在机制。在DAG中，两个变量之间的任何[统计关联](@entry_id:172897)都来源于连接它们的路径。然而，并非所有路径都传递因果效应。我们可以将路径分为两大类：

1.  **因果路径 (Causal Paths)**：这是一条从原因到结果的、所有箭头方向一致的有向路径。例如，在图 $X \to M \to Y$ 中，这条路径代表了 $X$ 通过中介变量 $M$ 对 $Y$ 产生的因果效应。

2.  **非因果路径 (Non-causal Paths)**：这些路径同样能产生变量间的[统计关联](@entry_id:172897)，但这种关联并不反映一个变量对另一个变量的因果效应。识别并“阻断”这些非因果路径，是因果推断的核心任务。

为了理解如何处理这些路径，我们需要检视构成任何路径的三种基本结构单元：链、分叉和对撞。

-   **链 (Chains)**：结构为 $A \to B \to C$。这代表了一个中介过程，关联从 $A$ 流向 $C$。如果我们对中间变量 $B$ 进行**控制 (conditioning)**（例如，在数据分析中将其纳入回归模型或进行分层分析），这条关联通路就会被**阻断 (blocked)**。

-   **分叉 (Forks)**：结构为 $A \leftarrow B \to C$。这代表了**混杂 (confounding)**，其中一个[共同原因](@entry_id:266381) $B$ 同时导致了 $A$ 和 $C$，从而在它们之间产生了非因果的“伪”关联。与链结构类似，控制[共同原因](@entry_id:266381) $B$ 可以阻断这条非因果路径。这是我们在因果分析中希望利用的“好的”控制。

-   **对撞 (Colliders)**：结构为 $A \to B \leftarrow C$。这是最特殊也最违反直觉的结构。在这里，两个独立的原因 $A$ 和 $C$ 共同导致了一个结果 $B$。在默认情况下，$A$ 和 $C$ 之间没有关联，这条路径是天然被阻断的。然而，如果我们控制了它们的共同结果——即对撞节点 $B$——一条新的关联路径就会被“打开”，在 $A$ 和 $C$ 之间产生[统计关联](@entry_id:172897)。这种现象被称为**[对撞偏倚](@entry_id:163186) (collider bias)** 或“[解释消除](@entry_id:203703)”效应 (explaining away effect)。这是我们在因果分析中必须避免的“坏的”控制。

这三种结构及其在控制下的行为，构成了 **[d-分离](@entry_id:748152) (d-separation)** 准则的基础，这是一个用于从DAG中读取任何[条件独立性](@entry_id:262650)关系的图形化规则。简而言之，如果连接两个变量 $X$ 和 $Y$ 的所有路径都被一个变量集合 $S$ 所阻断，那么我们就可以断定 $X$ 和 $Y$ 在给定 $S$ 的条件下是独立的，记为 $X \perp Y \mid S$。

### 识别因果效应：do算子与[后门准则](@entry_id:637856)

为了从观测数据中量化因果效应，我们需要一个能够明确区分“观察”与“干预”的数学工具。Judea Pearl 引入了 **do算子 (do-operator)** 来实现这一目标。

-   $P(Y=y \mid X=x)$ 是一个**观测性概率**。它描述的是“在观测到 $X$ 的值为 $x$ 的[子群](@entry_id:146164)体中，$Y$ 取值为 $y$ 的概率”。这个概率混合了 $X$ 对 $Y$ 的真实因果效应以及所有其他可能导致 $X$ 和 $Y$ 相关的非因果路径的影响。

-   $P(Y=y \mid \text{do}(X=x))$ 是一个**干预性概率**。它描述的是“如果我们强制将所有个体的 $X$ 值设定为 $x$，那么 $Y$ 取值为 $y$ 的概率”。这代表了 $X$ 对 $Y$ 的纯粹因果效应。在图形上，$\text{do}(X=x)$ 操作等同于进行一次“图手术”：切断所有指向 $X$ 的箭头，并将 $X$ 的值固定为 $x$。

因果推断的核心问题（即可识别性问题）在于：我们是否能仅用观测数据和观测性概率（如 $P(Y \mid X, Z)$）来计算出干预性概率 $P(Y \mid \text{do}(X=x))$？

**[后门准则](@entry_id:637856) (Backdoor Criterion)** 为此提供了一个强大而实用的图形化工具。它指明了为了识别 $X$ 对 $Y$ 的因果效应，我们需要控制哪些变量。

首先，一条从 $X$ 到 $Y$ 的**后门路径 (backdoor path)** 是一条连接 $X$ 和 $Y$ 但以指向 $X$ 的箭头开始的路径（例如 $X \leftarrow Z \to Y$）。这种路径是非因果的，是混杂的来源。

[后门准则](@entry_id:637856)规定，一个变量集合 $S$ 是一个充分的**调整集 (adjustment set)**，如果它满足以下两个条件：
1.  $S$ 中没有 $X$ 的后代节点。
2.  $S$ 阻断了所有从 $X$ 到 $Y$ 的后门路径。

如果一个集合 $S$ 满足[后门准则](@entry_id:637856)，那么 $X$ 对 $Y$ 的因果效应就是可识别的，并且可以通过**后门调整公式 (backdoor adjustment formula)** 来计算：

$$P(Y=y \mid \text{do}(X=x)) = \sum_{s} P(Y=y \mid X=x, S=s) P(S=s)$$

这个公式的直观含义是：我们在[混杂变量](@entry_id:199777) $S$ 的每个分层内计算 $X$ 对 $Y$ 的关联，然后按照 $S$ 在总人口中的[分布](@entry_id:182848)进行加权平均。这样就消除了 $S$ 所产生的混杂效应。

让我们回到经典的混杂结构 $Z \to X, Z \to Y, X \to Y$ 。这里，$X \leftarrow Z \to Y$ 是一条后门路径。集合 $\{Z\}$ 满足[后门准则](@entry_id:637856)，因为它阻断了这条路径且 $Z$ 不是 $X$ 的后代。因此，我们可以通过调整 $Z$ 来计算 $X$ 对 $Y$ 的因果效应：

$$P(Y=1 \mid \text{do}(X=1)) = \sum_{z \in \{0,1\}} P(Y=1 \mid X=1, Z=z) P(Z=z)$$

与之相对，观测性概率为 $P(Y=1 \mid X=1) = \sum_{z \in \{0,1\}} P(Y=1 \mid X=1, Z=z) P(Z=z \mid X=1)$。由于 $Z \to X$ 的存在， $P(Z=z)$ 和 $P(Z=z \mid X=1)$ 通常不相等，这导致了观测关联与因果效应的差异。例如，在一个具体的数据生成过程中 ，我们可能计算出观测关联 $P(Y=1 \mid X=1) = 0.86$，而真实的因果效应 $P(Y=1 \mid \text{do}(X=1)) = 0.80$。这种差异正是由混杂变量 $Z$ 造成的。当这种关联方向的反转发生时，就产生了著名的**[辛普森悖论](@entry_id:136589) (Simpson's Paradox)**，即在每个[子群](@entry_id:146164)体中 ($Z=0$ 和 $Z=1$)，$X$ 对 $Y$ 都有正向关联，但总体上却呈现负向关联 。

这个框架可以无缝地与**[潜在结果](@entry_id:753644) (potential outcomes)** 框架相结合 。[潜在结果](@entry_id:753644) $Y(a)$ 指的是在处理 $A$ 被设定为 $a$ 时的结果。平均[处理效应](@entry_id:636010) (Average Treatment Effect, ATE) 定义为 $E[Y(1) - Y(0)]$。通过 do算子，我们可以建立连接：$E[Y(a)] = E[Y \mid \text{do}(A=a)]$。因此，ATE 可以表示为 $E[Y \mid \text{do}(A=1)] - E[Y \mid \text{do}(A=0)]$，并且可以使用后门调整公式进行估计。例如，当 $Z$ 满足[后门准则](@entry_id:637856)时，ATE可以被识别为：

$$ATE = \sum_{z} (E[Y \mid A=1, Z=z] - E[Y \mid A=0, Z=z]) P(Z=z)$$

这个公式是[流行病学](@entry_id:141409)和经济学中许多标准化和分层方法的核心。

### 控制的陷阱：[对撞偏倚](@entry_id:163186)的多种形式

[后门准则](@entry_id:637856)告诉我们应该控制什么变量（[混杂变量](@entry_id:199777)），但同样重要的是，它也隐含地告诉我们不应该控制什么变量。错误地控制变量会引入偏倚，其中最常见和最微妙的就是[对撞偏倚](@entry_id:163186)。

**1. 选择偏倚 (Selection Bias)**

当我们的研究样本本身是基于两个或多个变量的共同结果来选择时，就会发生选择偏倚，这是一种典型的[对撞偏倚](@entry_id:163186)。考虑一个简单的DAG：$X \to S \leftarrow Y$，其中 $S$ 是一个选择[指示变量](@entry_id:266428)（例如，$S=1$ 表示个体被纳入研究）。假设在总人口中，$X$ 和 $Y$ 是独立的。然而，如果我们的分析仅限于 $S=1$ 的个体，我们实际上是在对一个对撞节点 $S$ 进行控制。这会打开 $X \to S \leftarrow Y$ 这条路径，从而在 $X$ 和 $Y$ 之间人为地制造出一种伪关联 。这种现象也被称为**伯克森悖论 (Berkson's Paradox)**。例如，在医院的病人中，两种本不相关的疾病可能呈现负相关，因为同时患有两种疾病的病人住院的可能性更高。

**2. M-偏倚 (M-Bias)**

[对撞偏倚](@entry_id:163186)可能以更复杂的形式出现。考虑一个被称为“M-结构”的DAG：$X \leftarrow A \to M \leftarrow B \to Y$，其中 $A$ 和 $B$ 是独立的 。在这个图中，$X$ 和 $Y$ 之间没有因果关系，也没有共同的祖先，因此它们是边缘独立的。然而，变量 $M$ 是一个对撞节点，其父节点是 $A$ 和 $B$。如果我们天真地认为应该控制所有处理前变量，并因此在分析中控制了 $M$，我们就会犯错。控制 $M$ 会打开路径 $X \leftarrow A \to M \leftarrow B \to Y$，在 $X$ 和 $Y$ 之间引入伪关联，从而产生一个有偏的因果效应估计。这凸显了一个重要教训：不是所有与处理和结果相关的变量都是混杂变量，盲目控制[协变](@entry_id:634097)量可能有害。

**3. 对中介变量或结果的后代进行控制**

在估计 $X$ 对 $Y$ 的总因果效应时，我们绝不能控制任何位于 $X$ 到 $Y$ 的因果路径上的变量（即中介变量），也不能控制 $Y$ 的任何后代。考虑这样一个结构：$X \to Y$, $X \to Z$, $Y \to Z$ 。这里的 $Z$ 是 $X$ 和 $Y$ 的共同结果，因此是路径 $X \to Z \leftarrow Y$ 上的一个对撞节点。如果我们为了估计 $X \to Y$ 的效应而在回归模型中加入了 $Z$，就会因[对撞偏倚](@entry_id:163186)而引入偏误。定量分析表明，这种偏倚不仅存在，其大小还可能超过真实的因果效应，甚至导致效应方向的反转。

### 高级主题：处理复杂因果结构

DAGs的威力在于它们能够清晰地处理更复杂的现实世界问题。

**1. 受控直接效应**

有时，我们不仅关心总效应，还想分解直接和间接效应。例如，在一个包含中介变量 $M$ 的图 $X \to M \to Y$ 中，我们可能想知道：如果我们将中介 $M$ 固定在某个水平 $m$，那么 $X$ 对 $Y$ 的剩余效应（即直接效应）是多少？这被称为**受控直接效应 (Controlled Direct Effect, CDE)**，形式化为 $P(Y \mid \text{do}(X=x), \text{do}(M=m))$。识别CDE需要在对 $M$ 进行干预后的新图中应用[后门准则](@entry_id:637856)。有趣的是，即使中介-结果关系存在未观测到的混杂因素（例如，存在 $U$ 使得 $M \leftarrow U \to Y$），CDE仍然可能是可识别的。这是因为干预 $\text{do}(M=m)$ 切断了 $U$ 对 $M$ 的影响，从而消除了这种混杂 。

**2. 时变混杂**

在纵向研究中，我们经常遇到**时变混杂 (time-varying confounding)**，其中一个变量既是过去处理的后果，又是未来处理的原因。考虑一个简化的结构：$X_1 \to L \to X_2 \to Y$，并且 $L$ 也直接影响 $Y$（$L \to Y$）。这里，$L$ 是 $X_2$ 和 $Y$ 之间的一个混杂因素，因此我们需要控制它来得到 $X_2$ 的无偏效应。然而，$L$ 也是 $X_1$ 效应的一个中介。在标准[回归模型](@entry_id:163386)中同时控制 $X_1, X_2, L$ 会导致问题：为了正确估计 $X_2$ 的效应，我们控制了 $L$；但这样做又阻断了 $X_1$ 通过 $L$ 传递的部分因果效应。这种两难困境使得标准方法失效。诸如**边际结构模型 (Marginal Structural Models, MSMs)** 与**[逆概率](@entry_id:196307)加权 (Inverse Probability Weighting, IPW)** 等高级方法被发展出来以解决此类问题。其核心思想是创建一个伪总体，在这个伪总体中，处理变量与过去的混杂因素之间不再有关联，从而可以在不将时变混杂因素放入结果模型的情况下，无偏地估计总因果效应  。

### 结论

本章系统地介绍了使用DAGs进行因果推断的基本原则和机制。我们已经看到，DAGs不仅仅是描述性的图表，而是一种能够表达精确因果假设并据此推导识别策略的强大数学语言。从区分关联与因果的三种基本路径结构，到用于量化因果效应的do算子和[后门准则](@entry_id:637856)，再到对各种[对撞偏倚](@entry_id:163186)的警示，这一框架为我们提供了一套严谨的思维工具。选择控制哪些变量不再是一个依赖于领域直觉的模糊过程，而是可以通过应用清晰的图形规则来解决的正式问题。掌握这些原则是进行可靠、透明和可复制的因果研究的关键一步。