{
    "hands_on_practices": [
        {
            "introduction": "本次练习将作为您应用条件风险价值（CVaR）优化的基础。我们将学习如何将CVaR最小化问题转化为一个标准的线性规划模型，从而找到在给定历史情景下的最优投资组合。通过对比允许和禁止卖空两种不同的约束条件，您将亲身体会到投资组合约束如何直接影响风险管理策略和最终的资产配置决策 。",
            "id": "2382531",
            "problem": "考虑一个有限情景投资组合优化问题，旨在最小化给定置信水平下投资组合损失的经验条件风险价值（CVaR）。存在 $n$ 种风险资产和 $N$ 种总简单回报率情景。令 $\\mathbf{r}_i \\in \\mathbb{R}^n$ 表示情景 $i \\in \\{1,\\dots,N\\}$ 下的资产回报向量，令 $\\mathbf{w} \\in \\mathbb{R}^n$ 表示投资组合权重，满足完全投资预算约束 $\\sum_{j=1}^n w_j = 1$。情景 $i$ 下的投资组合损失为 $\\ell_i(\\mathbf{w}) = - \\mathbf{r}_i^\\top \\mathbf{w}$。对于置信水平 $\\alpha \\in (0,1)$，损失的经验 CVaR 定义为\n$$\n\\operatorname{CVaR}_\\alpha(\\mathbf{w}) \\;=\\; \\min_{t \\in \\mathbb{R}} \\left\\{ t \\;+\\; \\frac{1}{(1-\\alpha)N} \\sum_{i=1}^N \\big(\\ell_i(\\mathbf{w}) - t\\big)_+ \\right\\},\n$$\n其中 $(x)_+ = \\max\\{x,0\\}$。预期回报约束要求投资组合的情景平均回报至少达到目标值 $\\mu_{\\min}$，即 $\\frac{1}{N}\\sum_{i=1}^N \\mathbf{r}_i^\\top \\mathbf{w} \\ge \\mu_{\\min}$。\n\n您必须比较两种机制：\n- 禁止卖空：对于所有 $j \\in \\{1,\\dots,n\\}$，$w_j \\ge 0$。\n- 允许带杠杆卖空：对于给定的 $L \\ge 1$，总杠杆约束 $\\sum_{j=1}^n |w_j| \\le L$ 成立，且 $w_j$ 可以为负。\n\n使用以下数据，$N = 12$ 个情景，$n = 4$ 种资产。情景回报矩阵 $\\mathbf{R} \\in \\mathbb{R}^{12 \\times 4}$ 由下式给出\n$$\n\\mathbf{R} \\;=\\;\n\\begin{bmatrix}\n0.01  0.005  -0.02  0.002 \\\\\n0.015  -0.01  0.03  0.003 \\\\\n-0.02  0.018  0.025  0.0025 \\\\\n0.005  0.004  -0.015  0.002 \\\\\n0.012  -0.005  0.022  0.003 \\\\\n-0.015  0.02  -0.018  0.0025 \\\\\n0.008  0.001  0.027  0.002 \\\\\n0.004  0.003  -0.012  0.003 \\\\\n0.02  -0.012  0.019  0.0025 \\\\\n-0.01  0.017  -0.014  0.002 \\\\\n0.006  -0.004  0.021  0.003 \\\\\n0.007  0.009  -0.016  0.0025\n\\end{bmatrix}.\n$$\n\n对于下述每个测试用例，计算在指定约束下最小化 $\\operatorname{CVaR}_\\alpha(\\mathbf{w})$ 的最优权重 $\\mathbf{w}^\\star$，并报告 $\\mathbf{w}^\\star$ 及对应的最优 CVaR 值。\n\n测试套件：\n- 测试 1（正常路径）：$\\alpha = 0.95$，$\\mu_{\\min} = 0.003$，禁止卖空。\n- 测试 2（与杠杆比较）：$\\alpha = 0.95$，$\\mu_{\\min} = 0.003$，允许卖空，总杠杆 $L = 1.5$。\n- 测试 3（尾部严格边缘用例）：$\\alpha = 0.99$，$\\mu_{\\min} = 0.0038$，允许卖空，总杠杆 $L = 2.0$。\n\n最终输出格式：\n- 您的程序应生成单行输出，包含一个含三个元素的列表，每个元素是包含 5 个浮点数的列表：4 个最优权重，后跟最优 CVaR 值。数字必须四舍五入到 6 位小数。该行必须是方括号括起来的逗号分隔列表，例如 $[\\,[x_1,x_2,x_3,x_4,c]\\, , \\, [\\dots] \\, , \\, [\\dots]\\,]$，其中每个 $x_k$ 和 $c$ 都是四舍五入到 6 位小数的浮点数。\n- 不应打印任何其他文本。",
            "solution": "所提出的问题是在条件风险价值（CVaR）框架下的一个适定（well-posed）的投资组合优化任务。它在科学上基于既定的金融工程原理，并且在数学上是一致的。所有必要的参数和数据均已提供，不存在任何歧义或矛盾。因此，该问题是有效的，我们可以着手解决。\n\n目标是在投资组合权重 $\\mathbf{w} \\in \\mathbb{R}^n$ 的一组约束条件下，最小化投资组合损失的经验 CVaR，即 $\\operatorname{CVaR}_\\alpha(\\mathbf{w})$。该投资组合包含 $n=4$ 种资产，在 $N=12$ 个历史情景下进行评估。这些情景的总简单回报由矩阵 $\\mathbf{R} \\in \\mathbb{R}^{12 \\times 4}$ 给出。令 $\\mathbf{r}_i \\in \\mathbb{R}^n$ 为情景 $i$ 中的资产回报列向量，对应于 $\\mathbf{R}$ 的第 $i$ 行的转置。情景 $i$ 下的投资组合损失定义为 $\\ell_i(\\mathbf{w}) = - \\mathbf{r}_i^\\top \\mathbf{w}$。\n\n问题是求解：\n$$\n\\min_{\\mathbf{w}} \\operatorname{CVaR}_\\alpha(\\mathbf{w})\n$$\n并服从特定问题的约束条件。$\\operatorname{CVaR}_\\alpha(\\mathbf{w})$ 的定义如下：\n$$\n\\operatorname{CVaR}_\\alpha(\\mathbf{w}) \\;=\\; \\min_{t \\in \\mathbb{R}} \\left\\{ t \\;+\\; \\frac{1}{(1-\\alpha)N} \\sum_{i=1}^N \\big(\\ell_i(\\mathbf{w}) - t\\big)_+ \\right\\}\n$$\n其中 $(x)_+ = \\max\\{x,0\\}$。\n\n这个嵌套的最小化问题可以重构为关于 $\\mathbf{w}$ 和辅助变量 $t \\in \\mathbb{R}$ 的联合最小化问题：\n$$\n\\min_{\\mathbf{w}, t} \\left\\{ t \\;+\\; \\frac{1}{(1-\\alpha)N} \\sum_{i=1}^N \\big(-\\mathbf{r}_i^\\top \\mathbf{w} - t\\big)_+ \\right\\}\n$$\n项 $(\\cdot)_+$ 是非线性的。为了创建一个计算上易于处理的问题，特别是线性规划（LP），我们引入一个辅助变量向量 $\\mathbf{u} = [u_1, \\dots, u_N]^\\top$，其中每个 $u_i$ 代表情景 $i$ 中超过风险价值（VaR）的超额损失，而 VaR 由 $t$ 来代理。我们要求 $u_i \\ge (-\\mathbf{r}_i^\\top \\mathbf{w} - t)$ 和 $u_i \\ge 0$。最小化目标将确保 $u_i$ 取尽可能小的值，即 $u_i = \\max(-\\mathbf{r}_i^\\top \\mathbf{w} - t, 0)$。\n\n因此，该优化问题可转化为以下 LP：\n$$\n\\begin{array}{ll}\n\\underset{\\mathbf{w}, t, \\mathbf{u}}{\\text{minimize}}  t + \\frac{1}{(1-\\alpha)N} \\sum_{i=1}^N u_i \\\\\n\\text{subject to}  u_i + \\mathbf{r}_i^\\top \\mathbf{w} + t \\ge 0, \\quad \\forall i \\in \\{1, \\dots, N\\} \\\\\n u_i \\ge 0, \\quad \\forall i \\in \\{1, \\dots, N\\} \\\\\n \\text{以及关于 } \\mathbf{w} \\text{ 的附加投资组合约束。}\n\\end{array}\n$$\n决策变量是权重向量 $\\mathbf{w} \\in \\mathbb{R}^n$、VaR 代理变量 $t \\in \\mathbb{R}$ 和超额损失变量 $\\mathbf{u} \\in \\mathbb{R}^N$。\n\n投资组合约束为：\n1.  完全投资（预算约束）：$\\sum_{j=1}^n w_j = \\mathbf{1}^\\top \\mathbf{w} = 1$。\n2.  最小预期回报：$\\frac{1}{N}\\sum_{i=1}^N \\mathbf{r}_i^\\top \\mathbf{w} \\ge \\mu_{\\min}$。这等价于 $\\bar{\\mathbf{r}}^\\top \\mathbf{w} \\ge \\mu_{\\min}$，其中 $\\bar{\\mathbf{r}} = \\frac{1}{N}\\sum_{i=1}^N \\mathbf{r}_i$ 是情景平均回报向量。\n\n我们分析两种指定的机制。\n\n**机制 1：禁止卖空**\n在此机制下，权重必须为非负数。LP 的完整约束集为：\n$$\n\\begin{array}{ll}\n\\underset{\\mathbf{w}, t, \\mathbf{u}}{\\text{minimize}}  t + \\frac{1}{(1-\\alpha)N} \\sum_{i=1}^N u_i \\\\\n\\text{subject to}  -\\mathbf{r}_i^\\top \\mathbf{w} - t - u_i \\le 0, \\quad i=1, \\dots, N \\\\\n -\\bar{\\mathbf{r}}^\\top \\mathbf{w} \\le -\\mu_{\\min} \\\\\n \\mathbf{1}^\\top \\mathbf{w} = 1 \\\\\n w_j \\ge 0, \\quad j=1, \\dots, n \\\\\n u_i \\ge 0, \\quad i=1, \\dots, N\n\\end{array}\n$$\n这是一个标准的 LP 形式，可通过单纯形法或内点法等算法求解。优化变量为 $[\\mathbf{w}^\\top, t, \\mathbf{u}^\\top]^\\top$。\n\n**机制 2：允许带杠杆卖空**\n在此，权重 $w_j$ 可以为负。对 $\\mathbf{w}$ 的非负性约束被替换为总杠杆约束：$\\sum_{j=1}^n |w_j| \\le L$。绝对值函数是非线性的。我们通过将每个权重 $w_j$ 分解为其正部和负部来将其线性化：$w_j = w_j^+ - w_j^-$，其中 $w_j^+ \\ge 0$ 且 $w_j^- \\ge 0$。那么绝对值就是 $|w_j| = w_j^+ + w_j^-$。\n\n投资组合权重向量变为 $\\mathbf{w} = \\mathbf{w}^+ - \\mathbf{w}^-$，其中 $\\mathbf{w}^+, \\mathbf{w}^- \\in \\mathbb{R}^n$ 是非负变量的向量。此机制的 LP 是基于变量 $\\mathbf{w}^+, \\mathbf{w}^-, t, \\mathbf{u}$ 来构建的：\n$$\n\\begin{array}{ll}\n\\underset{\\mathbf{w}^+, \\mathbf{w}^-, t, \\mathbf{u}}{\\text{minimize}}  t + \\frac{1}{(1-\\alpha)N} \\sum_{i=1}^N u_i \\\\\n\\text{subject to}  -\\mathbf{r}_i^\\top (\\mathbf{w}^+ - \\mathbf{w}^-) - t - u_i \\le 0, \\quad i=1, \\dots, N \\\\\n -\\bar{\\mathbf{r}}^\\top (\\mathbf{w}^+ - \\mathbf{w}^-) \\le -\\mu_{\\min} \\\\\n \\mathbf{1}^\\top (\\mathbf{w}^+ - \\mathbf{w}^-) = 1 \\\\\n \\mathbf{1}^\\top (\\mathbf{w}^+ + \\mathbf{w}^-) \\le L \\\\\n w_j^+ \\ge 0, w_j^- \\ge 0, \\quad j=1, \\dots, n \\\\\n u_i \\ge 0, \\quad i=1, \\dots, N\n\\end{array}\n$$\n优化变量向量为 $[\\mathbf{w}^{+ \\top}, \\mathbf{w}^{- \\top}, t, \\mathbf{u}^\\top]^\\top$。一旦找到最优的 $\\mathbf{w}^{+ \\star}$ 和 $\\mathbf{w}^{- \\star}$，最优投资组合权重可通过 $\\mathbf{w}^\\star = \\mathbf{w}^{+ \\star} - \\mathbf{w}^{- \\star}$ 恢复。\n\n对于每个测试用例，将构建并求解相应的 LP。将报告最优权重 $\\mathbf{w}^\\star$ 和最优目标值，即最小的 $\\operatorname{CVaR}_\\alpha$。\n\n所有测试用例均使用以下数据：$n=4$，$N=12$，以及回报矩阵 $\\mathbf{R}$。\n平均回报向量为 $\\bar{\\mathbf{r}} = [0.004333, 0.004667, 0.004917, 0.0025]^\\top$。\n\n**测试用例 1**：$\\alpha = 0.95$，$\\mu_{\\min} = 0.003$，禁止卖空。\n这使用机制 1 的公式。目标函数中的常数因子为 $1 / ((1-0.95) \\cdot 12) = 1/0.6 = 5/3$。\n\n**测试用例 2**：$\\alpha = 0.95$，$\\mu_{\\min} = 0.003$，允许卖空，$L = 1.5$。\n这使用机制 2 的公式。因子同样是 $5/3$。\n\n**测试用例 3**：$\\alpha = 0.99$，$\\mu_{\\min} = 0.0038$，允许卖空，$L = 2.0$。\n这使用机制 2 的公式。因子为 $1 / ((1-0.99) \\cdot 12) = 1/0.12 = 25/3$。\n\n每个用例的解将使用数值 LP 求解器计算。",
            "answer": "```python\nimport numpy as np\nfrom scipy.optimize import linprog\n\ndef solve_cvar_optimization(R, alpha, mu_min, L=None, short_selling_prohibited=True):\n    \"\"\"\n    Solves the CVaR optimization problem.\n    \"\"\"\n    N, n = R.shape\n    r_bar = R.mean(axis=0)\n    cvar_factor = 1 / ((1 - alpha) * N)\n\n    if short_selling_prohibited:\n        # Decision variables: x = [w_1, ..., w_n, t, u_1, ..., u_N]\n        # Total variables: n + 1 + N\n        \n        # --- Objective function ---\n        # min t + cvar_factor * sum(u_i)\n        c = np.zeros(n + 1 + N)\n        c[n] = 1  # Coefficient for t\n        c[n + 1:] = cvar_factor  # Coefficients for u_i\n        \n        # --- Constraints ---\n        # A_ub * x = b_ub\n        # A_eq * x == b_eq\n\n        # Inequality constraints:\n        # 1. -r_bar.T @ w = -mu_min\n        # 2. -R @ w - t - u = 0 --> -R @ w - t*1 - I @ u = 0\n        A_ub = np.zeros((N + 1, n + 1 + N))\n        b_ub = np.zeros(N + 1)\n        \n        # Expected return constraint\n        A_ub[0, :n] = -r_bar\n        b_ub[0] = -mu_min\n\n        # CVaR constraints\n        A_ub[1:, :n] = -R\n        A_ub[1:, n] = -1\n        A_ub[1:, n + 1:] = -np.eye(N)\n        \n        # Equality constraints (budget):\n        # 1. sum(w_j) = 1\n        A_eq = np.zeros((1, n + 1 + N))\n        A_eq[0, :n] = 1\n        b_eq = np.array([1])\n        \n        # --- Bounds ---\n        # w_j >= 0, u_i >= 0, t is free\n        bounds = [(0, None)] * n + [(None, None)] + [(0, None)] * N\n        \n        res = linprog(c, A_ub=A_ub, b_ub=b_ub, A_eq=A_eq, b_eq=b_eq, bounds=bounds, method='highs')\n        \n        if not res.success:\n            raise RuntimeError(f\"Optimization failed: {res.message}\")\n        \n        w_opt = res.x[:n]\n        cvar_opt = res.fun\n        \n        return w_opt, cvar_opt\n        \n    else:  # Short-selling allowed with leverage\n        # Decision variables: x = [w_p_1, ..., w_p_n, w_m_1, ..., w_m_n, t, u_1, ..., u_N]\n        # Total variables: 2*n + 1 + N\n        \n        # --- Objective function ---\n        c = np.zeros(2 * n + 1 + N)\n        c[2 * n] = 1  # Coefficient for t\n        c[2 * n + 1:] = cvar_factor # Coefficients for u_i\n\n        # --- Constraints ---\n        # Inequality constraints:\n        # 1. Leverage: sum(w_p_j + w_m_j) = L\n        # 2. Expected return: -r_bar.T @ (w_p - w_m) = -mu_min\n        # 3. CVaR: -R @ (w_p - w_m) - t - u = 0\n        A_ub = np.zeros((1 + 1 + N, 2 * n + 1 + N))\n        b_ub = np.zeros(1 + 1 + N)\n        \n        # Leverage constraint\n        A_ub[0, :2 * n] = 1\n        b_ub[0] = L\n\n        # Expected return constraint\n        A_ub[1, :n] = -r_bar\n        A_ub[1, n:2 * n] = r_bar\n        b_ub[1] = -mu_min\n\n        # CVaR constraints\n        A_ub[2:, :n] = -R\n        A_ub[2:, n:2 * n] = R\n        A_ub[2:, 2 * n] = -1\n        A_ub[2:, 2 * n + 1:] = -np.eye(N)\n        \n        # Equality constraints (budget):\n        # 1. sum(w_p_j - w_m_j) = 1\n        A_eq = np.zeros((1, 2 * n + 1 + N))\n        A_eq[0, :n] = 1\n        A_eq[0, n:2 * n] = -1\n        b_eq = np.array([1])\n        \n        # --- Bounds ---\n        # w_p_j >= 0, w_m_j >= 0, u_i >= 0, t is free\n        bounds = [(0, None)] * (2 * n) + [(None, None)] + [(0, None)] * N\n\n        res = linprog(c, A_ub=A_ub, b_ub=b_ub, A_eq=A_eq, b_eq=b_eq, bounds=bounds, method='highs')\n        \n        if not res.success:\n            raise RuntimeError(f\"Optimization failed: {res.message}\")\n\n        w_p = res.x[:n]\n        w_m = res.x[n:2 * n]\n        w_opt = w_p - w_m\n        cvar_opt = res.fun\n        \n        return w_opt, cvar_opt\n\n\ndef solve():\n    R = np.array([\n        [0.01, 0.005, -0.02, 0.002],\n        [0.015, -0.01, 0.03, 0.003],\n        [-0.02, 0.018, 0.025, 0.0025],\n        [0.005, 0.004, -0.015, 0.002],\n        [0.012, -0.005, 0.022, 0.003],\n        [-0.015, 0.02, -0.018, 0.0025],\n        [0.008, 0.001, 0.027, 0.002],\n        [0.004, 0.003, -0.012, 0.003],\n        [0.02, -0.012, 0.019, 0.0025],\n        [-0.01, 0.017, -0.014, 0.002],\n        [0.006, -0.004, 0.021, 0.003],\n        [0.007, 0.009, -0.016, 0.0025]\n    ])\n\n    test_cases = [\n        # alpha, mu_min, L, short_selling_prohibited\n        (0.95, 0.003, None, True),\n        (0.95, 0.003, 1.5, False),\n        (0.99, 0.0038, 2.0, False)\n    ]\n\n    results = []\n    for alpha, mu_min, L, ssp in test_cases:\n        w_opt, cvar_opt = solve_cvar_optimization(R, alpha, mu_min, L, ssp)\n        \n        # Round to 6 decimal places\n        result_list = [round(w, 6) for w in w_opt] + [round(cvar_opt, 6)]\n        results.append(result_list)\n    \n    # Format the output string precisely as required, without extra spaces\n    res_strings = [f\"[{','.join(f'{v:.6f}' for v in r)}]\" for r in results]\n    final_output = f\"[{','.join(res_strings)}]\"\n    print(final_output)\n\nsolve()\n```"
        },
        {
            "introduction": "在掌握了基础之后，我们将进入一个更贴近现实金融应用的场景。本次练习将CVaR优化与现代资产定价理论的基石——线性因子模型相结合，您需要首先基于系统性风险因子和异质性冲击来构建资产的预期回报。这个过程将帮助您理解如何将风险管理框架应用于由模型驱动的回报预测，而不仅仅是依赖于原始历史数据，从而突显CVaR方法的灵活性与实用性 。",
            "id": "2382483",
            "problem": "实现一个完整的程序，从第一性原理出发解决以下优化问题。\n\n给定一个资产回报的线性因子模型。现有 $n = 4$ 种资产和 $k = 3$ 个系统性因子。在情景 $s \\in \\{1,\\dots,S\\}$（其中 $S=12$）下，资产回报被建模为\n$$\nr_{i,s} = \\boldsymbol{b}_i^{\\top} \\boldsymbol{f}_s + e_{i,s},\n$$\n其中 $\\boldsymbol{b}_i \\in \\mathbb{R}^k$ 是资产 $i$ 的因子载荷向量，$\\boldsymbol{f}_s \\in \\mathbb{R}^k$ 是情景 $s$ 下的因子回报向量，而 $e_{i,s} \\in \\mathbb{R}$ 是资产 $i$ 在情景 $s$ 下的特异性残差。预期因子回报向量为 $\\boldsymbol{\\mu}_f \\in \\mathbb{R}^k$，且对所有 $i,s$ 都有 $\\mathbb{E}[e_{i,s}] = 0$。投资组合权重向量为 $\\boldsymbol{w} \\in \\mathbb{R}^n$，受限于只做多和全额投资约束：\n$$\n\\sum_{i=1}^n w_i = 1,\\quad w_i \\ge 0 \\text{ for all } i.\n$$\n情景 $s$ 下的投资组合回报为\n$$\nr_{p,s} = \\sum_{i=1}^n w_i r_{i,s},\n$$\n投资组合的预期回报为\n$$\n\\mathbb{E}[r_p] = \\sum_{i=1}^n w_i \\mathbb{E}[r_i] = \\sum_{i=1}^n w_i \\boldsymbol{b}_i^{\\top} \\boldsymbol{\\mu}_f.\n$$\n定义情景 $s$ 下的投资组合损失为 $L_s = -r_{p,s}$。对于一个置信水平 $\\alpha \\in (0,1)$，风险价值（VaR）是在 $\\alpha$ 水平下 $\\{L_s\\}_{s=1}^S$ 的 $\\alpha$-分位数，而条件风险价值（CVaR）是在 $\\alpha$ 水平下超过VaR的预期损失：\n$$\n\\text{CVaR}_\\alpha(L) = \\mathbb{E}[L \\mid L \\ge \\text{VaR}_\\alpha(L)].\n$$\n您的任务是，对于每个指定的测试用例 $(\\alpha, r_{\\min})$，计算在所有满足约束条件和最低预期回报要求\n$$\n\\mathbb{E}[r_p] \\ge r_{\\min}\n$$\n的可行 $\\boldsymbol{w}$ 中，最小可能达到的 $\\text{CVaR}_\\alpha(L)$。\n使用以下数据，这些数据必须被视为精确值：\n\n- 资产数量 $n = 4$，因子数量 $k = 3$，情景数量 $S = 12$。\n\n- 因子载荷矩阵 $\\mathbf{B} \\in \\mathbb{R}^{n \\times k}$，其行为 $\\boldsymbol{b}_i^{\\top}$：\n$$\n\\mathbf{B} =\n\\begin{bmatrix}\n1.1  0.3  0.2 \\\\\n0.9  0.1  -0.1 \\\\\n1.4  -0.2  0.5 \\\\\n0.7  0.5  0.0\n\\end{bmatrix}.\n$$\n\n- 预期因子回报向量 $\\boldsymbol{\\mu}_f \\in \\mathbb{R}^k$：\n$$\n\\boldsymbol{\\mu}_f = \\begin{bmatrix} 0.004 \\\\ 0.003 \\\\ 0.002 \\end{bmatrix}.\n$$\n\n- 因子回报情景 $\\mathbf{F} \\in \\mathbb{R}^{S \\times k}$，其行为 $\\boldsymbol{f}_s^{\\top}$，其中 $s=1,\\dots,12$：\n$$\n\\mathbf{F} =\n\\begin{bmatrix}\n0.015  0.010  0.005 \\\\\n-0.020  -0.015  -0.010 \\\\\n0.025  0.005  0.000 \\\\\n0.010  -0.005  0.004 \\\\\n-0.030  0.020  -0.005 \\\\\n0.005  0.000  0.007 \\\\\n0.018  -0.012  0.003 \\\\\n-0.012  0.018  0.006 \\\\\n0.022  0.012  -0.004 \\\\\n-0.015  -0.008  0.002 \\\\\n0.008  0.006  -0.006 \\\\\n-0.005  0.004  0.009\n\\end{bmatrix}.\n$$\n\n- 特异性残差矩阵 $\\mathbf{E} \\in \\mathbb{R}^{S \\times n}$，其元素 $e_{i,s}$ 按行 $s=1,\\dots,12$ 和列 $i=1,\\dots,4$ 排列：\n$$\n\\mathbf{E} =\n\\begin{bmatrix}\n0.0010  -0.0010  0.0005  -0.0005 \\\\\n-0.0020  0.0010  -0.0005  0.0005 \\\\\n0.0000  -0.0020  0.0010  -0.0010 \\\\\n0.0010  0.0010  -0.0010  0.0010 \\\\\n-0.0010  0.0020  0.0000  0.0000 \\\\\n0.0000  -0.0010  0.0005  -0.0005 \\\\\n0.0020  0.0000  -0.0005  0.0005 \\\\\n-0.0010  -0.0020  0.0010  -0.0010 \\\\\n0.0010  0.0010  -0.0010  0.0010 \\\\\n-0.0010  0.0000  0.0000  0.0000 \\\\\n0.0000  0.0010  0.0005  -0.0005 \\\\\n0.0010  -0.0010  -0.0005  0.0005\n\\end{bmatrix}.\n$$\n\n对于每个测试用例 $(\\alpha, r_{\\min})$，构建情景资产回报矩阵 $\\mathbf{R} \\in \\mathbb{R}^{S \\times n}$ 为\n$$\n\\mathbf{R} = \\mathbf{F} \\mathbf{B}^{\\top} + \\mathbf{E},\n$$\n计算 $r_{p,s} = \\sum_{i=1}^n w_i R_{s,i}$，定义 $L_s = - r_{p,s}$，并找到在所有满足约束和 $\\mathbb{E}[r_p] \\ge r_{\\min}$ 的 $\\boldsymbol{w}$ 中可实现的最小 $\\text{CVaR}_\\alpha(L)$。\n\n测试套件（四个测试用例），每个用例包含 $(\\alpha, r_{\\min})$：\n- 用例 1：$(0.95,\\ 0.003)$。\n- 用例 2：$(0.99,\\ 0.000)$。\n- 用例 3：$(0.90,\\ 0.004)$。\n- 用例 4：$(0.95,\\ 0.006)$。\n\n您的程序应为每个用例计算最小化的 $\\text{CVaR}_\\alpha(L)$，结果为一个实数。最终输出格式必须是单行输出，结果为一个用方括号括起来的逗号分隔列表，顺序与测试用例相同（例如，$[x_1,x_2,x_3,x_4]$）。不需要单位。所有数值答案必须以十进制小数形式打印。",
            "solution": "用户提供了一个在计算金融领域中明确定义的问题。任务是找到在满足一系列约束条件下，资产投资组合的最小条件风险价值（CVaR）。这是一个经典的投资组合优化问题，可以被构建并作为线性规划（LP）问题来解决。\n\n### 步骤1：问题验证\n\n第一步是验证问题陈述。\n\n**提取的已知条件：**\n- **模型参数**：资产数量 $n = 4$，因子数量 $k = 3$，情景数量 $S = 12$。\n- **资产回报模型**：$r_{i,s} = \\boldsymbol{b}_i^{\\top} \\boldsymbol{f}_s + e_{i,s}$。\n- **数据矩阵和向量**：因子载荷矩阵 $\\mathbf{B} \\in \\mathbb{R}^{4 \\times 3}$，预期因子回报向量 $\\boldsymbol{\\mu}_f \\in \\mathbb{R}^3$，因子回报情景矩阵 $\\mathbf{F} \\in \\mathbb{R}^{12 \\times 3}$，以及特异性残差矩阵 $\\mathbf{E} \\in \\mathbb{R}^{12 \\times 4}$。所有数值均已提供。\n- **投资组合约束**：只做多（$w_i \\ge 0$ for $i=1,\\dots,n$）和全额投资（$\\sum_{i=1}^n w_i = 1$）。\n- **目标**：最小化 $\\text{CVaR}_\\alpha(L)$，其中 $L_s = -r_{p,s} = -\\sum_{i=1}^n w_i r_{i,s}$ 是情景 $s$ 下的投资组合损失。\n- **性能约束**：投资组合的预期回报 $\\mathbb{E}[r_p] = \\sum_{i=1}^n w_i \\boldsymbol{b}_i^{\\top} \\boldsymbol{\\mu}_f$ 必须满足 $\\mathbb{E}[r_p] \\ge r_{\\min}$。\n- **测试用例**：提供了四对 $(\\alpha, r_{\\min})$ 用于计算。\n\n**验证结论：**\n该问题是**有效的**。\n1.  **科学上合理**：该问题基于标准的资产回报线性因子模型，并利用了条件风险价值（CVaR），这是现代投资组合理论中一种连贯且被广泛接受的风险度量。最小化CVaR的任务是金融工程的核心内容之一。\n2.  **定义明确**：该问题被构建为一个凸优化问题，具体来说是一个线性规划问题。约束条件为投资组合权重定义了一个非空、凸且紧凑的可行集。目标函数是线性的。因此，存在一个唯一的稳定解。所有必要的数据都已提供。\n3.  **客观性**：问题陈述使用了精确、无歧义的数学术语，不含任何主观或推测性内容。\n\n该问题是健全的，可以使用已建立的数学方法来解决。\n\n### 步骤2：使用线性规划的原则性解决方案\n\n问题的核心是基于一个包含 $S$ 个情景的离散集合来最小化CVaR。这可以被构建为一个线性规划问题。\n\n**A. 金融数据的预处理**\n\n首先，我们从给定数据中计算两个关键量：\n1.  预期资产回报向量 $\\boldsymbol{\\mu}_r \\in \\mathbb{R}^n$。资产 $i$ 的预期回报为 $\\mathbb{E}[r_i] = \\boldsymbol{b}_i^{\\top} \\boldsymbol{\\mu}_f$，因为 $\\mathbb{E}[e_{i,s}]=0$。用矩阵表示法：\n    $$\n    \\boldsymbol{\\mu}_r = \\mathbf{B} \\boldsymbol{\\mu}_f\n    $$\n2.  基于情景的资产回报矩阵 $\\mathbf{R} \\in \\mathbb{R}^{S \\times n}$。元素 $R_{s,i}$ 是资产 $i$ 在情景 $s$ 下的回报。用矩阵表示法：\n    $$\n    \\mathbf{R} = \\mathbf{F} \\mathbf{B}^{\\top} + \\mathbf{E}\n    $$\n    投资组合在情景 $s$ 下的回报则由 $r_{p,s} = \\boldsymbol{R}_s^{\\top} \\boldsymbol{w}$ 给出，其中 $\\boldsymbol{R}_s^{\\top}$ 是 $\\mathbf{R}$ 的第 $s$ 行。投资组合损失为 $L_s = -r_{p,s}$。\n\n**B. CVaR最小化的线性规划构建**\n\n对于一组具有相等概率 $1/S$ 的 $S$ 个情景，置信水平为 $\\alpha$ 的CVaR可以通过解决以下优化问题找到：\n$$\n\\text{CVaR}_\\alpha(L) = \\min_{\\zeta \\in \\mathbb{R}} \\left( \\zeta + \\frac{1}{S(1-\\alpha)} \\sum_{s=1}^S \\max(0, L_s - \\zeta) \\right)\n$$\n在这里，$\\zeta$ 是一个优化变量，对应于风险价值（VaR）。为了使此问题适用于线性规划求解器，我们引入一个辅助变量向量 $\\boldsymbol{z} \\in \\mathbb{R}^S$，其中每个 $z_s$ 代表超过 $\\zeta$ 的超额损失，即 $z_s \\ge \\max(0, L_s - \\zeta)$。\n\n我们的目标是通过选择投资组合权重 $\\boldsymbol{w}$ 来最小化CVaR。完整的优化问题涉及找到最优的 $\\boldsymbol{w}$、$\\zeta$ 和 $\\boldsymbol{z}$。问题变为：\n\n$$\n\\min_{\\boldsymbol{w}, \\zeta, \\boldsymbol{z}} \\quad \\zeta + \\frac{1}{S(1-\\alpha)} \\sum_{s=1}^S z_s\n$$\n受限于以下线性约束：\n\n1.  **超额损失约束**：对于每个情景 $s=1, \\dots, S$，变量 $z_s$ 必须捕捉超过 $\\zeta$ 的损失：\n    $$\n    z_s \\ge L_s - \\zeta \\implies z_s \\ge -(\\mathbf{R}_s^{\\top} \\boldsymbol{w}) - \\zeta\n    $$\n    这等价于：$-\\boldsymbol{R}_s^{\\top} \\boldsymbol{w} - \\zeta - z_s \\le 0$。\n2.  **超额损失的非负性**：\n    $$\n    z_s \\ge 0\n    $$\n3.  **全额投资约束**：权重之和必须为一。\n    $$\n    \\sum_{i=1}^n w_i = 1\n    $$\n4.  **只做多约束**：所有投资组合权重必须为非负。\n    $$\n    w_i \\ge 0 \\quad \\text{for } i=1, \\dots, n\n    $$\n5.  **最低预期回报约束**：投资组合的预期回报必须满足指定的最小值。\n    $$\n    \\mathbb{E}[r_p] = \\boldsymbol{\\mu}_r^{\\top} \\boldsymbol{w} \\ge r_{\\min}\n    $$\n    这等价于：$-\\boldsymbol{\\mu}_r^{\\top} \\boldsymbol{w} \\le -r_{\\min}$。\n\n**C. 标准LP形式**\n\n这个问题可以转化为标准LP形式 $\\min \\boldsymbol{c}^{\\top}\\boldsymbol{x}$，受限于 $\\mathbf{A}_{ub}\\boldsymbol{x} \\le \\boldsymbol{b}_{ub}$ 和 $\\mathbf{A}_{eq}\\boldsymbol{x} = \\boldsymbol{b}_{eq}$，以及对 $\\boldsymbol{x}$ 的边界。\n\n-   **决策变量向量**：我们定义一个单一的决策变量向量 $\\boldsymbol{x} \\in \\mathbb{R}^{n+1+S}$：\n    $$\n    \\boldsymbol{x} = [\\boldsymbol{w}^{\\top}, \\zeta, \\boldsymbol{z}^{\\top}]^{\\top} = [w_1, \\dots, w_n, \\zeta, z_1, \\dots, z_S]^{\\top}\n    $$\n-   **目标函数向量**：向量 $\\boldsymbol{c} \\in \\mathbb{R}^{n+1+S}$ 定义了目标函数：\n    $$\n    \\boldsymbol{c} = [0, \\dots, 0, 1, \\frac{1}{S(1-\\alpha)}, \\dots, \\frac{1}{S(1-\\alpha)}]^{\\top}\n    $$\n    （其中有 $n$ 个初始零）。\n-   **等式约束**：全额投资约束是唯一的等式：$\\mathbf{A}_{eq}\\boldsymbol{x} = \\boldsymbol{b}_{eq}$，其中：\n    $$\n    \\mathbf{A}_{eq} = [\\underbrace{1, \\dots, 1}_{n}, \\underbrace{0, \\dots, 0}_{1+S}] \\quad \\text{和} \\quad \\boldsymbol{b}_{eq} = [1]\n    $$\n-   **不等式约束**：关于超额损失和最低回报的约束构成了不等式 $\\mathbf{A}_{ub}\\boldsymbol{x} \\le \\boldsymbol{b}_{ub}$。矩阵 $\\mathbf{A}_{ub} \\in \\mathbb{R}^{(S+1) \\times (n+1+S)}$ 和向量 $\\boldsymbol{b}_{ub} \\in \\mathbb{R}^{S+1}$ 的结构如下：\n    - 对于行 $s=1, \\dots, S$（来自约束1）：\n      $$\n      (\\mathbf{A}_{ub})_{s,j} = \\begin{cases} -R_{s,j}  1 \\le j \\le n \\\\ -1  j = n+1 \\\\ -1  j = n+1+s \\\\ 0  \\text{否则} \\end{cases}, \\quad (\\boldsymbol{b}_{ub})_s = 0\n      $$\n    - 对于行 $S+1$（来自约束5）：\n      $$\n      (\\mathbf{A}_{ub})_{S+1,j} = \\begin{cases} -(\\boldsymbol{\\mu}_r)_j  1 \\le j \\le n \\\\ 0  \\text{否则} \\end{cases}, \\quad (\\boldsymbol{b}_{ub})_{S+1} = -r_{\\min}\n      $$\n-   **边界**：$\\boldsymbol{w}$ 和 $\\boldsymbol{z}$ 的非负性约束作为变量的边界来处理：\n    - $0 \\le w_i \\le 1$ for $i=1, \\dots, n$。（上限 $1$ 是隐含的，但对求解器有帮助）。\n    - $-\\infty \\le \\zeta \\le \\infty$（无界）。\n    - $z_s \\ge 0$ for $s=1, \\dots, S$。\n\n通过这种构建，可以使用像 `scipy.optimize.linprog` 这样的标准LP求解器来找到最优解向量 $\\boldsymbol{x}^*$。最小的CVaR值则由最优目标函数值 $\\boldsymbol{c}^{\\top}\\boldsymbol{x}^*$ 给出。对每个测试用例重复此过程。",
            "answer": "```python\nimport numpy as np\nfrom scipy.optimize import linprog\n\ndef solve():\n    \"\"\"\n    Solves the CVaR optimization problem for a series of test cases.\n    \"\"\"\n    # Define given constants and data\n    n = 4  # number of assets\n    k = 3  # number of factors\n    S = 12 # number of scenarios\n\n    B = np.array([\n        [1.1, 0.3, 0.2],\n        [0.9, 0.1, -0.1],\n        [1.4, -0.2, 0.5],\n        [0.7, 0.5, 0.0]\n    ])\n\n    mu_f = np.array([0.004, 0.003, 0.002])\n\n    F = np.array([\n        [0.015, 0.010, 0.005],\n        [-0.020, -0.015, -0.010],\n        [0.025, 0.005, 0.000],\n        [0.010, -0.005, 0.004],\n        [-0.030, 0.020, -0.005],\n        [0.005, 0.000, 0.007],\n        [0.018, -0.012, 0.003],\n        [-0.012, 0.018, 0.006],\n        [0.022, 0.012, -0.004],\n        [-0.015, -0.008, 0.002],\n        [0.008, 0.006, -0.006],\n        [-0.005, 0.004, 0.009]\n    ])\n\n    E = np.array([\n        [0.0010, -0.0010, 0.0005, -0.0005],\n        [-0.0020, 0.0010, -0.0005, 0.0005],\n        [0.0000, -0.0020, 0.0010, -0.0010],\n        [0.0010, 0.0010, -0.0010, 0.0010],\n        [-0.0010, 0.0020, 0.0000, 0.0000],\n        [0.0000, -0.0010, 0.0005, -0.0005],\n        [0.0020, 0.0000, -0.0005, 0.0005],\n        [-0.0010, -0.0020, 0.0010, -0.0010],\n        [0.0010, 0.0010, -0.0010, 0.0010],\n        [-0.0010, 0.0000, 0.0000, 0.0000],\n        [0.0000, 0.0010, 0.0005, -0.0005],\n        [0.0010, -0.0010, -0.0005, 0.0005]\n    ])\n\n    # Test cases: (alpha, r_min)\n    test_cases = [\n        (0.95, 0.003),\n        (0.99, 0.000),\n        (0.90, 0.004),\n        (0.95, 0.006)\n    ]\n\n    # Preprocessing: Calculate scenario returns and expected returns\n    # R has shape (S, n)\n    R = F @ B.T + E\n    # mu_r has shape (n,)\n    mu_r = B @ mu_f\n\n    results = []\n    for alpha, r_min in test_cases:\n        # Formulate the Linear Program for CVaR minimization\n        # Decision variables x = [w_1, ..., w_n, zeta, z_1, ..., z_S]\n        # Total number of variables is n + 1 + S\n        n_vars = n + 1 + S\n\n        # Objective function: min (zeta + 1/(S*(1-alpha)) * sum(z_s))\n        c = np.zeros(n_vars)\n        c[n] = 1.0  # Coefficient for zeta\n        c[n + 1:] = 1.0 / (S * (1 - alpha)) # Coefficients for z_s\n\n        # Inequality constraints: A_ub * x = b_ub\n        # S constraints for z_s >= -r_p,s - zeta and 1 for E[r_p] >= r_min\n        A_ub = np.zeros((S + 1, n_vars))\n        b_ub = np.zeros(S + 1)\n\n        # Constraints: -r_p,s - zeta - z_s = 0  for s = 1,...,S\n        # - (sum_i R_si * w_i) - zeta - z_s = 0\n        for s in range(S):\n            A_ub[s, :n] = -R[s, :]  # Coefficients for w_i\n            A_ub[s, n] = -1.0       # Coefficient for zeta\n            A_ub[s, n + 1 + s] = -1.0 # Coefficient for z_s\n        \n        # Minimum expected return constraint: E[r_p] >= r_min\n        # -E[r_p] = -r_min => -mu_r.T @ w = -r_min\n        A_ub[S, :n] = -mu_r\n        b_ub[S] = -r_min\n        \n        # Equality constraints: A_eq * x == b_eq\n        # Full investment constraint: sum(w_i) = 1\n        A_eq = np.zeros((1, n_vars))\n        A_eq[0, :n] = 1.0\n        b_eq = np.array([1.0])\n\n        # Bounds for variables\n        w_bounds = (0, 1) # Weights are between 0 and 1\n        zeta_bounds = (None, None) # Zeta is unbounded\n        z_bounds = (0, None) # z_s are non-negative\n\n        bounds = [w_bounds] * n + [zeta_bounds] + [z_bounds] * S\n\n        # Solve the linear program\n        res = linprog(c=c, A_ub=A_ub, b_ub=b_ub, A_eq=A_eq, b_eq=b_eq, bounds=bounds, method='highs')\n        \n        if res.success:\n            min_cvar = res.fun\n            results.append(f\"{min_cvar:.10f}\")\n        else:\n            # Handle cases where optimization may fail, though not expected here\n            results.append(\"Error\")\n\n    # Format and print the final output\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "最后，我们将挑战一个涉及金融衍生品的高级应用。本次练习将展示如何对具有非线性收益结构的工具（例如期权）进行CVaR优化。解决此问题的关键在于，通过在一系列离散的资产价格情景下评估这些非线性收益，从而将整个优化问题线性化，并最终构建一个可求解的线性规划模型 。通过完成这个练习，您将学会如何在一个统一的CVaR优化框架内处理复杂的金融产品，从而融合衍生品定价和风险管理的知识。",
            "id": "2382528",
            "problem": "给定一个投资组合选择问题，其中的资产是基于单一底层风险资产的欧式衍生品，其期末价格表示为 $S_T$。每种衍生品的收益 $P(S_T)$ 是 $S_T$ 的一个非线性函数。目标是选择非负的投资组合权重 $w \\in \\mathbb{R}^J_{\\ge 0}$，以最小化在指定置信水平 $0  \\alpha  1$ 下投资组合损失的条件风险价值（Conditional Value at Risk, CVaR），同时满足将给定初始预算完全投资的预算约束。\n\n数据和建模假设如下。\n\n1. 在物理测度下，期末价格 $S_T$ 服从对数正态分布，该分布由一个正态变量 $Z \\sim \\mathcal{N}(0,1)$ 生成，参数为 $S_0  0$（当前价格）、$\\mu_p \\in \\mathbb{R}$（物理漂移率）、$\\sigma  0$（波动率）和期限 $T  0$：\n$$\nS_T = S_0 \\exp\\left( \\left(\\mu_p - \\tfrac{1}{2}\\sigma^2\\right) T + \\sigma \\sqrt{T}\\, Z \\right).\n$$\n为了计算目的，必须使用由等间距概率网格 $u_i = \\tfrac{i - 0.5}{N}$（对于 $i = 1,2,\\dots,N$）生成的 $N$ 个情景来构建 $S_T$ 的经验分布，这些概率通过标准正态累积分布函数 $\\Phi^{-1}$ 的逆函数映射到 $z_i = \\Phi^{-1}(u_i)$，然后映射到\n$$\nS_T^{(i)} = S_0 \\exp\\left( \\left(\\mu_p - \\tfrac{1}{2}\\sigma^2\\right) T + \\sigma \\sqrt{T}\\, z_i \\right).\n$$\n\n2. 该投资组合包含 $J$ 种衍生工具，其在到期日 $T$ 的收益定义如下，并按以下固定顺序排列。令 $K \\in \\mathbb{R}_{0}$ 表示一个行权价参数。这些工具（及其收益函数和行权价）是：\n- 工具 1：行权价 $K = 90$ 的欧式看涨期权，收益 $P_1(S_T) = \\max(S_T - 90, 0)$。\n- 工具 2：行权价 $K = 100$ 的欧式看涨期权，收益 $P_2(S_T) = \\max(S_T - 100, 0)$。\n- 工具 3：行权价 $K = 110$ 的欧式看涨期权，收益 $P_3(S_T) = \\max(S_T - 110, 0)$。\n- 工具 4：行权价 $K = 90$ 的欧式看跌期权，收益 $P_4(S_T) = \\max(90 - S_T, 0)$。\n- 工具 5：行权价 $K = 100$ 的欧式看跌期权，收益 $P_5(S_T) = \\max(100 - S_T, 0)$。\n- 工具 6：行权价 $K = 110$ 的欧式看跌期权，收益 $P_6(S_T) = \\max(110 - S_T, 0)$。\n- 工具 7：行权价 $K = 100$ 的欧式数字看涨期权，收益 $P_7(S_T) = \\mathbf{1}_{\\{S_T  100\\}}$。\n\n3. 对于 $j = 1,\\dots,7$，初始成本 $c_j$ 必须在 Black–Scholes 框架下计算，使用风险中性漂移率 $r$以及相同的波动率 $\\sigma$ 和到期日 $T$。具体来说，使用标准的 Black–Scholes 符号\n$$\nd_1 = \\frac{\\ln\\left(\\frac{S_0}{K}\\right) + \\left(r + \\tfrac{1}{2}\\sigma^2\\right) T}{\\sigma \\sqrt{T}}, \\quad\nd_2 = d_1 - \\sigma \\sqrt{T}, \\quad \\Phi(\\cdot) \\text{ 是标准正态累积分布函数},\n$$\n时间为 $0$ 时的价格是：\n- 欧式看涨期权：$c_{\\text{call}}(S_0,K,\\sigma,r,T) = S_0 \\Phi(d_1) - K e^{-rT} \\Phi(d_2)$。\n- 欧式看跌期权：$c_{\\text{put}}(S_0,K,\\sigma,r,T) = K e^{-rT} \\Phi(-d_2) - S_0 \\Phi(-d_1)$。\n- 欧式数字看涨期权：$c_{\\text{dig}}(S_0,K,\\sigma,r,T) = e^{-rT} \\Phi(d_2)$。\n\n4. 在情景 $i$ 中，对于权重 $w \\in \\mathbb{R}^7_{\\ge 0}$，投资组合的损失定义为\n$$\nL_i(w) = \\sum_{j=1}^{7} w_j \\left( c_j e^{rT} - P_j\\left(S_T^{(i)}\\right) \\right).\n$$\n此损失是在时间 $T$ 测量的，通过将初始成本以连续复利的无风险利率 $r$ 滚算至时间 $T$，然后减去已实现的收益。\n\n5. 对于经验损失分布 $\\{L_i(w)\\}_{i=1}^N$，置信水平为 $\\alpha$ 的条件风险价值被定义为最差的 $(1-\\alpha)$ 部分损失的平均值（即，超出风险价值的尾部均值），使用由 $N$ 个等可能情景引出的经验分布。如果 $(1-\\alpha)N$ 不是整数，则通过带有适当分数加权的标准尾部平均定义来解释该平均值。\n\n6. 优化问题是：\n- 决策变量：$w \\in \\mathbb{R}^7_{\\ge 0}$。\n- 目标：最小化经验损失分布 $\\{L_i(w)\\}_{i=1}^N$ 在置信水平 $\\alpha$ 下的 CVaR。\n- 约束：完全投资预算\n$$\n\\sum_{j=1}^{7} c_j w_j = B,\n$$\n和非负性 $w_j \\ge 0$ 对于 $j = 1,\\dots,7$。\n\n您的任务是实现一个程序，对于下面的每个测试用例，构建 $N$ 个情景 $\\{S_T^{(i)}\\}_{i=1}^N$，计算衍生品价格 $\\{c_j\\}_{j=1}^7$，解决上述 CVaR 最小化问题，并输出与第2点中指定的工具顺序相对应的最优权重向量 $w^\\star$。\n\n测试套件。对于每个测试用例，请使用指定的参数值：\n- 测试用例 1：$S_0 = 100$, $r = 0.02$, $T = 1$, $\\mu_p = 0.05$, $\\sigma = 0.2$, $\\alpha = 0.95$, $B = 10$, $N = 200$。\n- 测试用例 2：$S_0 = 100$, $r = 0.02$, $T = 1$, $\\mu_p = 0.02$, $\\sigma = 0.2$, $\\alpha = 0.99$, $B = 10$, $N = 200$。\n- 测试用例 3：$S_0 = 100$, $r = 0.02$, $T = 1$, $\\mu_p = 0.02$, $\\sigma = 0.01$, $\\alpha = 0.95$, $B = 10$, $N = 200$。\n\n要求的最终输出格式。您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，其中第 $k$ 个元素本身是一个包含7个浮点数（四舍五入到6位小数）的列表，给出测试用例 $k$ 在第2点所述工具顺序下的最优权重。例如，三个测试的输出必须如下所示\n$$\n[[w_{1,1},w_{1,2},\\dots,w_{1,7}],[w_{2,1},\\dots,w_{2,7}],[w_{3,1},\\dots,w_{3,7}]].\n$$\n不得打印任何附加文本。所有数值答案必须是无量纲的实数。",
            "solution": "该问题已经过验证，被认为是科学上合理、适定且完整的。这是计算金融学中的一个标准问题，特别是在投资组合风险管理领域。所提供的模型、公式和参数是一致的，能够得出一个唯一且有意义的解。我们将继续推导和实现解决方案。\n\n该问题要求最小化投资组合损失的条件风险价值（CVaR），并受制于投资组合权重的预算和非负性约束。这可以被表述为一个线性规划（LP）问题，它是一个计算上易于处理的优化问题。\n\n令 $w \\in \\mathbb{R}^J_{\\ge 0}$ 为 $J=7$ 种工具的投资组合权重向量。在情景 $i \\in \\{1, \\dots, N\\}$ 中，投资组合的损失是权重的线性函数：\n$$\nL_i(w) = \\sum_{j=1}^{7} w_j \\left( c_j e^{rT} - P_j\\left(S_T^{(i)}\\right) \\right)\n$$\n其中 $c_j$ 是工具 $j$ 的初始成本，$r$ 是无风险利率，$T$ 是时间期限，$P_j(S_T^{(i)})$ 是在期末资产价格情景 $S_T^{(i)}$ 下工具 $j$ 的收益。初始成本由风险中性测度下的 Black-Scholes 模型确定，而期末价格情景 $S_T^{(i)}$ 则在物理测度下生成。这种区分是标准且恰当的。\n\n对于一个损失分布，置信水平为 $\\alpha \\in (0, 1)$ 的 CVaR 可以通过解决以下优化问题来找到，这是由 Rockafellar 和 Uryasev 建立的：\n$$\n\\text{CVaR}_{\\alpha}(L(w)) = \\min_{v \\in \\mathbb{R}} \\left( v + \\frac{1}{1-\\alpha} \\mathbb{E}[\\max(L(w) - v, 0)] \\right)\n$$\n在这里，$v$ 是一个辅助变量，代表置信水平 $\\alpha$ 下的风险价值（VaR）。对于基于 $N$ 个等可能情景的经验分布，期望被平均值所取代：\n$$\n\\text{CVaR}_{\\alpha}(\\{L_i(w)\\}) = \\min_{v \\in \\mathbb{R}} \\left( v + \\frac{1}{N(1-\\alpha)} \\sum_{i=1}^N \\max(L_i(w) - v, 0) \\right)\n$$\n完整的优化问题是在给定约束条件下，关于 $w$ 和 $v$ 最小化该量。\n$$\n\\min_{w, v} \\quad v + \\frac{1}{N(1-\\alpha)} \\sum_{i=1}^N \\max(L_i(w) - v, 0)\n$$\n约束条件：\n$$\n\\sum_{j=1}^{7} c_j w_j = B\n$$\n$$\nw_j \\ge 0 \\quad \\text{for } j=1, \\dots, 7\n$$\n由于存在 $\\max$ 函数，这是一个凸但非线性的优化问题。通过引入 $N$ 个辅助变量 $u_i \\ge 0$，可以将其转换为一个等价的线性规划（LP），其中每个 $u_i$ 代表损失 $L_i(w)$ 超过 VaR $v$ 的差额。即 $u_i \\ge L_i(w) - v$。\n\n等价的线性规划表述如下：\n- **决策变量**：\n  - $w \\in \\mathbb{R}^7$：投资组合权重。\n  - $v \\in \\mathbb{R}$：风险价值。\n  - $u \\in \\mathbb{R}^N$：每个情景的差额变量。\n\n- **目标函数**：\n  最小化 $v + \\frac{1}{N(1-\\alpha)} \\sum_{i=1}^N u_i$。\n\n- **约束**：\n  1. 对于每个情景 $i=1, \\dots, N$，$L_i(w) - v - u_i \\le 0$。\n  2. $\\sum_{j=1}^{7} c_j w_j = B$（预算约束）。\n  3. 对于 $j=1, \\dots, 7$，$w_j \\ge 0$（权重的非负性）。\n  4. 对于 $i=1, \\dots, N$，$u_i \\ge 0$（差额的非负性）。\n\n由于 $L_i(w)$ 对 $w$ 是线性的，第一个约束也是线性的。因此，整个问题是一个线性规划问题。为了实现解决方案，我们为标准的线性规划求解器构建矩阵。设优化变量的向量为 $\\mathbf{x} = [w_1, \\dots, w_7, v, u_1, \\dots, u_N]^T$，其维度为 $J+1+N = 7+1+N$。\n\n1.  **情景生成**：对于每个测试用例，我们生成 $N$ 个期末价格 $S_T$ 的情景。我们首先创建一个等间距的概率网格 $p_i = (i - 0.5)/N$ 对于 $i=1, \\dots, N$。标准正态变量为 $z_i = \\Phi^{-1}(p_i)$，其中 $\\Phi^{-1}$ 是标准正态累积分布函数的逆函数。然后，计算期末价格：\n    $$\n    S_T^{(i)} = S_0 \\exp\\left( \\left(\\mu_p - \\frac{1}{2}\\sigma^2\\right) T + \\sigma \\sqrt{T}\\, z_i \\right)\n    $$\n\n2.  **衍生品定价**：我们使用提供的 Black-Scholes 公式计算 $J=7$ 种衍生品的初始成本 $c_j$。这些公式需要参数 $S_0, T, r, \\sigma,$ 和各自的行权价 $K$。\n\n3.  **线性规划表述**：\n    - **目标向量 $\\mathbf{c}_{\\text{LP}}$**：目标是最小化 $\\mathbf{c}_{\\text{LP}}^T \\mathbf{x}$。根据目标函数，该向量为：\n      $$\n      \\mathbf{c}_{\\text{LP}} = [\\underbrace{0, \\dots, 0}_{7 \\text{ 次}}, 1, \\underbrace{\\frac{1}{N(1-\\alpha)}, \\dots, \\frac{1}{N(1-\\alpha)}}_{N \\text{ 次}}]^T\n      $$\n    - **等式约束 $\\mathbf{A}_{\\text{eq}}\\mathbf{x} = \\mathbf{b}_{\\text{eq}}$**：这对应于预算约束。\n      $$\n      \\mathbf{A}_{\\text{eq}} = [c_1, \\dots, c_7, 0, 0, \\dots, 0] \\quad (\\text{一个 } 1 \\times (8+N) \\text{ 的矩阵})\n      $$\n      $$\n      \\mathbf{b}_{\\text{eq}} = [B]\n      $$\n    - **不等式约束 $\\mathbf{A}_{\\text{ub}}\\mathbf{x} \\le \\mathbf{b}_{\\text{ub}}$**：这些对应于 $N$ 个差额约束 $L_i(w) - v - u_i \\le 0$。令 $\\mathbf{M}$ 为一个 $N \\times 7$ 矩阵，其中 $M_{ij} = c_j e^{rT} - P_j(S_T^{(i)})$。那么 $L_i(w) = \\sum_j M_{ij} w_j$。这些约束可以用矩阵形式写出。\n      - $\\mathbf{A}_{\\text{ub}}$ 的前 $7$ 列对应于 $w_j$ 的系数，构成了矩阵 $\\mathbf{M}$。\n      - 第 $8$ 列，对于 $v$，是一个由 $-1$ 组成的向量。\n      - 最后 $N$ 列，对于 $u_i$，构成了矩阵 $- \\mathbf{I}_N$，其中 $\\mathbf{I}_N$ 是 $N \\times N$ 的单位矩阵。\n      $$\n      \\mathbf{A}_{\\text{ub}} = [\\mathbf{M} \\quad -\\mathbf{1}_{N \\times 1} \\quad -\\mathbf{I}_N] \\quad (\\text{一个 } N \\times (8+N) \\text{ 的矩阵})\n      $$\n      $$\n      \\mathbf{b}_{\\text{ub}} = \\mathbf{0}_{N \\times 1}\n      $$\n    - **边界**：变量受以下边界约束：$w_j \\ge 0$，$v$ 无限制，以及 $u_i \\ge 0$。\n\n然后使用数值求解器求解此线性规划问题。最优权重 $w^\\star$ 是所得解向量 $\\mathbf{x}^\\star$ 的前7个元素。",
            "answer": "```python\nimport numpy as np\nfrom scipy.stats import norm\nfrom scipy.optimize import linprog\n\ndef black_scholes_pricer(S0, K, T, r, sigma, option_type):\n    \"\"\"\n    Calculates the time-0 price of European options using the Black-Scholes model.\n    \"\"\"\n    if sigma * np.sqrt(T) == 0: # Avoid division by zero\n        if option_type == 'call':\n            return np.maximum(S0 * np.exp(r*T) - K, 0) * np.exp(-r*T)\n        elif option_type == 'put':\n            return np.maximum(K - S0 * np.exp(r*T), 0) * np.exp(-r*T)\n        elif option_type == 'digital_call':\n            return 1.0 * np.exp(-r*T) if S0 * np.exp(r*T) > K else 0.0\n\n    d1 = (np.log(S0 / K) + (r + 0.5 * sigma**2) * T) / (sigma * np.sqrt(T))\n    d2 = d1 - sigma * np.sqrt(T)\n    \n    if option_type == 'call':\n        price = S0 * norm.cdf(d1) - K * np.exp(-r * T) * norm.cdf(d2)\n    elif option_type == 'put':\n        price = K * np.exp(-r * T) * norm.cdf(-d2) - S0 * norm.cdf(-d1)\n    elif option_type == 'digital_call':\n        price = np.exp(-r * T) * norm.cdf(d2)\n    else:\n        raise ValueError(\"Invalid option type. Must be 'call', 'put', or 'digital_call'.\")\n        \n    return price\n\ndef solve():\n    \"\"\"\n    Solves the CVaR optimization problem for the given test cases.\n    \"\"\"\n    test_cases = [\n        {'S0': 100, 'r': 0.02, 'T': 1, 'mu_p': 0.05, 'sigma': 0.2, 'alpha': 0.95, 'B': 10, 'N': 200},\n        {'S0': 100, 'r': 0.02, 'T': 1, 'mu_p': 0.02, 'sigma': 0.2, 'alpha': 0.99, 'B': 10, 'N': 200},\n        {'S0': 100, 'r': 0.02, 'T': 1, 'mu_p': 0.02, 'sigma': 0.01, 'alpha': 0.95, 'B': 10, 'N': 200},\n    ]\n\n    # Instrument definitions\n    J = 7\n    instrument_strikes = np.array([90, 100, 110, 90, 100, 110, 100], dtype=float)\n    instrument_types = ['call', 'call', 'call', 'put', 'put', 'put', 'digital_call']\n\n    final_results = []\n\n    for params in test_cases:\n        S0, r, T, mu_p, sigma, alpha, B, N = \\\n            params['S0'], params['r'], params['T'], params['mu_p'], \\\n            params['sigma'], params['alpha'], params['B'], params['N']\n\n        # Step 1: Scenario Generation\n        u = (np.arange(1, N + 1) - 0.5) / N\n        z = norm.ppf(u)\n        S_T = S0 * np.exp((mu_p - 0.5 * sigma**2) * T + sigma * np.sqrt(T) * z)\n\n        # Step 2: Derivative Pricing\n        costs = np.array([\n            black_scholes_pricer(S0, K, T, r, sigma, opt_type)\n            for K, opt_type in zip(instrument_strikes, instrument_types)\n        ])\n\n        # Step 3: Calculate Payoffs for each scenario\n        payoffs = np.zeros((N, J))\n        payoffs[:, 0] = np.maximum(S_T - 90, 0)\n        payoffs[:, 1] = np.maximum(S_T - 100, 0)\n        payoffs[:, 2] = np.maximum(S_T - 110, 0)\n        payoffs[:, 3] = np.maximum(90 - S_T, 0)\n        payoffs[:, 4] = np.maximum(100 - S_T, 0)\n        payoffs[:, 5] = np.maximum(110 - S_T, 0)\n        payoffs[:, 6] = (S_T > 100).astype(float)\n\n        # Step 4: Construct the Linear Program\n        num_vars = J + 1 + N\n        \n        # Objective function vector\n        c_lp = np.zeros(num_vars)\n        c_lp[J] = 1.0  # Coefficient for v\n        c_lp[J + 1:] = 1.0 / (N * (1 - alpha)) # Coefficients for u_i\n\n        # Equality constraint (budget)\n        A_eq = np.zeros((1, num_vars))\n        A_eq[0, :J] = costs\n        b_eq = np.array([B])\n        \n        # Inequality constraints (loss vs VaR)\n        loss_matrix = costs * np.exp(r * T) - payoffs # Shape (N, J)\n        \n        A_ub = np.zeros((N, num_vars))\n        A_ub[:, :J] = loss_matrix\n        A_ub[:, J] = -1.0 # Coefficients for -v\n        A_ub[:, J + 1:] = -np.eye(N) # Coefficients for -u_i\n        b_ub = np.zeros(N)\n\n        # Bounds for variables\n        bounds = [(0, None)] * J + [(None, None)] + [(0, None)] * N\n\n        # Step 5: Solve the LP\n        res = linprog(c=c_lp, A_ub=A_ub, b_ub=b_ub, A_eq=A_eq, b_eq=b_eq, bounds=bounds, method='highs')\n        \n        optimal_weights = res.x[:J]\n        \n        # Format results\n        formatted_weights = [f\"{w:.6f}\" for w in optimal_weights]\n        final_results.append(f\"[{','.join(formatted_weights)}]\")\n    \n    print(f\"[{','.join(final_results)}]\")\n\nsolve()\n```"
        }
    ]
}