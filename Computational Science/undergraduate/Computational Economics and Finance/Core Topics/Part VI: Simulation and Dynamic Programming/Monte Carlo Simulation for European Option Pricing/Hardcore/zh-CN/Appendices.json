{
    "hands_on_practices": [
        {
            "introduction": "当您编写的模拟器算出的价格与教科书中的Black-Scholes公式不符时，这并不罕见。真正的挑战在于如何系统性地找出问题所在。这个练习  为您提供了一套诊断错误的蓝图，教您如何区分是代码实现中的缺陷（bug）、将连续过程离散化引入的偏差（discretization bias），还是有限样本导致的统计误差（sampling error）。掌握这种严谨的验证方法是进行任何计算科学研究的基石。",
            "id": "2411885",
            "problem": "您实现了一个蒙特卡洛（MC）估计器，用于在 Black-Scholes (BS) 模型下为欧式看涨期权定价。在风险中性测度下，标的资产遵循几何布朗运动（GBM）：$\\,\\mathrm{d}S_t = r S_t \\,\\mathrm{d}t + \\sigma S_t \\,\\mathrm{d}W_t\\,$，其中初始价格为 $\\,S_0\\,$，常数无风险利率为 $\\,r\\,$，波动率为 $\\,\\sigma\\,$，到期日为 $\\,T\\,$。欧式看涨期权的收益为 $\\,\\max(S_T - K, 0)\\,$，执行价为 $\\,K\\,$。您的 MC 定价器使用状态动态的欧拉离散化方法，以大小为 $\\,\\Delta t = T/m\\,$ 的 $\\,m\\,$ 个均匀时间步长模拟 $\\,N\\,$ 条样本路径，并以 $\\,\\exp(-rT)\\,$ 进行贴现。您观察到您的 MC 估计值与 BS 闭式解价格之间存在持续的差异。\n\n您需要确定这种差异是由实现错误、时间离散化偏差还是有限样本抽样误差引起的。以下哪个测试方案最能从第一性原理上可靠地诊断出原因？\n\nA. 固定一个随机种子，并将您的 MC 估计值与使用相同 $\\,m\\,$ 的二叉树价格进行比较；如果它们接近，则断定没有错误。然后将布朗运动增量的标准正态随机数切换为均匀分布随机数；如果价格仅发生轻微变化，则将剩余差异归因于抽样误差。最后，将执行价 $\\,K\\,$ 改变 $\\,10\\%\\,$，看价格敏感性是否与数值微分匹配；如果不匹配，则断定为离散化偏差。\n\nB. 将路径模拟替换为终端分布 $\\,S_T = S_0 \\exp\\!\\big((r - \\tfrac{1}{2}\\sigma^2)T + \\sigma \\sqrt{T}\\, Z\\big)\\,$（其中 $\\,Z \\sim \\mathcal{N}(0,1)\\,$）的精确抽样，保持 $\\,N\\,$ 不变；将得到的 MC 估计值与 BS 价格进行比较，以测试时间离散化偏差。接下来，重复将 $\\,N\\,$ 加倍（例如，$\\,N, 2N, 4N, 8N\\,$），每次计算样本标准误和 $\\,95\\%\\,$ 的置信区间，以测试差异是否按 $\\,N^{-1/2}\\,$ 的比例缩放，以及 BS 价格是否位于区间内（测试抽样误差）。另外，通过从您的模拟中估计 $\\,\\mathbb{E}[e^{-rT} S_T]\\,$ 来进行鞅诊断，并检查其是否在统计上与 $\\,S_0\\,$ 不可区分；如果可以区分，则怀疑存在实现错误（例如，漂移项、贴现或随机数问题）。最后，如果精确终端模拟与 BS 价格一致，而时间步进模拟不一致，则细化 $\\,m\\,$（例如，$\\,m, 2m, 4m\\,$）以验证偏差是否随着 $\\,\\Delta t \\to 0\\,$ 而缩小。\n\nC. 保持 $\\,N\\,$ 和 $\\,m\\,$ 固定，并在一个网格上改变 $\\,S_0\\,$；对于每个 $\\,S_0\\,$，计算看涨和看跌期权的 MC 价格，并精确验证看跌-看涨期权平价关系。如果平价关系对所有网格点都成立，则断定没有错误。然后将您的价格与一个具有 $\\,m\\,$ 步的格子法进行比较，并将任何剩余的差异归因于抽样误差，因为两种方法都是离散近似。\n\nD. 切换到准蒙特卡洛（QMC），使用具有相同 $\\,N\\,$ 和 $\\,m\\,$ 的 Sobol' 序列，并与您的伪随机 MC 价格进行比较。如果 QMC 使估计值更接近 BS 价格，则推断原始差异是抽样误差。如果不是，则将 $\\,m\\,$ 增加一次；如果估计值仍不匹配在从 QMC 复制计算出的单个标准误内的 BS 价格，则宣布该问题为程序错误。\n\n选择最佳答案。",
            "solution": "当前的问题是验证和调试数值模拟中的一个经典练习，这在任何量化领域都是至关重要的任务。我们面对的是一个用于 Black-Scholes 模型下欧式看涨期权的蒙特卡洛定价器，它与已知的解析解之间存在“持续的差异”。我们的目标是确定最科学严谨的方案来诊断此误差的来源，该误差可能是实现错误、时间离散化偏差或有限样本统计误差。\n\n首先，让我们将问题形式化。资产价格 $S_t$ 在风险中性测度 $\\mathbb{Q}$ 下遵循随机微分方程（SDE）：\n$$ \\mathrm{d}S_t = r S_t \\,\\mathrm{d}t + \\sigma S_t \\,\\mathrm{d}W_t $$\n其中 $r$ 是常数无风险利率，$\\sigma$ 是常数波动率，$W_t$ 是标准布朗运动。蒙特卡洛模拟使用 Euler-Maruyama 离散化方案，在 $m$ 个大小为 $\\Delta t = T/m$ 的时间步长上进行：\n$$ S_{t_{i+1}} = S_{t_i} + r S_{t_i} \\Delta t + \\sigma S_{t_i} \\sqrt{\\Delta t} Z_i $$\n其中 $Z_i \\sim \\mathcal{N}(0,1)$ 是独立的标准正态随机变量。看涨期权价格 $C_0$ 的 MC 估计器为：\n$$ \\hat{C}_N = e^{-rT} \\frac{1}{N} \\sum_{j=1}^{N} \\max(S_{T}^{(j)} - K, 0) $$\n其中 $S_T^{(j)}$ 是第 $j$ 次模拟路径的终端价格。\n\nMC 估计值 $\\hat{C}_N$ 与真实的 Black-Scholes 价格 $C_{BS}$ 之间的总误差可以分解为：\n$$ \\text{Error} = \\hat{C}_N - C_{BS} = (\\hat{C}_N - \\mathbb{E}[\\hat{C}_N]) + (\\mathbb{E}[\\hat{C}_N] - C_{BS}) $$\n第一项 $(\\hat{C}_N - \\mathbb{E}[\\hat{C}_N])$ 是**统计抽样误差**，它是随机的，并且随着 $N \\to \\infty$ 其量级减小，具体来说是 $O(N^{-1/2})$ 阶。第二项 $(\\mathbb{E}[\\hat{C}_N] - C_{BS})$ 是**系统性偏差**。这种偏差主要是由 SDE 的时间离散化引起的。对于欧拉方案，这种**离散化偏差**的弱收敛阶为 1，意味着它是 $O(\\Delta t)$ 阶，或 $O(m^{-1})$ 阶。**实现错误**可能表现为额外的、通常占主导地位的系统性偏差来源，或者它可能错误地影响估计的统计属性。\n\n一个稳健的诊断程序必须能够独立地分离和测试这三种潜在的误差来源中的每一种。\n\n让我们评估一下所提出的方案。\n\n**选项 A 的分析：**\n该方案在方法论上不健全，并包含严重缺陷。\n$1$. 将 MC 估计值与二叉树价格进行比较是两种不同数值近似值的比较。它们之间的一致性并不意味着相对于真实连续时间模型的正确性。两者都可能有相似量级的离散化偏差，或者其中一个可能有错误，但巧合地抵消了其偏差。这个测试无法分离任何东西。\n$2$. “将布朗运动增量的标准正态随机数切换为均匀分布随机数”的建议是一个灾难性的推理错误。SDE 是用布朗运动定义的，其增量必须是高斯分布的。用均匀分布的变量替换它们从根本上改变了被模拟的模型。这不是一个诊断测试；这是故意引入一个重大的建模错误。这种程序的结果是毫无意义的。\n$3$. 通过改变执行价 $K$ 来测试价格敏感性（delta）是一种间接测试。数值 delta 的差异可能是三种误差类型中任何一种的症状，并且不允许将它们分离开来。例如，价格估计中的大抽样误差将导致其数值导数的大误差。\n因此，这个方案充满了逻辑谬误和不科学的程序。\n**对 A 的结论：不正确。**\n\n**选项 B 的分析：**\n该方案系统、严谨，并遵循了此类研究的既定最佳实践。每个步骤都旨在分离一个特定的误差来源。\n$1$. **测试离散化偏差：** $S_t$ 的 SDE 有一个已知的解析解：$S_T = S_0 \\exp((r - \\frac{1}{2}\\sigma^2)T + \\sigma W_T)$，其中 $W_T = \\sqrt{T}Z$ 且 $Z \\sim \\mathcal{N}(0,1)$。通过用从这个精确终端分布直接抽样来代替逐步的欧拉模拟，时间离散化误差被完全消除。如果使用这种精确方法的 MC 估计值与 Black-Scholes 价格一致（在统计噪声范围内），而原始基于欧拉的估计值不一致，那么差异就明确地被确定为离散化偏差。这是一个完美的对照实验。\n$2$. **测试抽样误差：** 重复将路径数 $N$ 加倍并构建置信区间的程序是分析统计收敛性的标准方法。中心极限定理规定，MC 均值的标准误应与 $N^{-1/2}$ 成比例缩小。通过验证这种缩放比例并检查真实的 $C_{BS}$ 价格是否落在计算出的置信区间内，可以确定观察到的差异是否与给定样本量 $N$ 的预期统计波动一致。\n$3$. **测试实现错误：** 贴现后资产价格的鞅性质，$\\mathbb{E}_{\\mathbb{Q}}[e^{-rT} S_T] = S_0$，是风险中性定价的一个基本原则。左侧的 MC 估计器，$\\frac{1}{N} \\sum_{j=1}^N e^{-rT} S_T^{(j)}$，应该产生一个在统计上与 $S_0$ 接近的值。显著的偏差指向模拟逻辑中的根本缺陷——例如不正确的漂移项、随机数的不当缩放或贴现因子中的错误——这些可能仅仅通过为期权定价是揭示不出来的。这为核心路径生成器的正确性提供了一个干净、强大且独立的测试。\n$4$. **确认：** 最后一步，细化时间步数 $m$ 并观察偏差向零收敛，作为离散化偏差诊断的确认。它验证了误差的行为符合弱收敛方案的理论预测。\n该方案的每个部分在逻辑上都是健全的，并精确地针对了潜在的误差原因。\n**对 B 的结论：正确。**\n\n**选项 C 的分析：**\n该方案的推理较弱，并包含不切实际的建议。\n$1$. 验证看跌-看涨期权平价关系，$C - P = S_0 - K e^{-rT}$，是一个有效的健全性检查。由于收益线性组合为 $\\max(S_T-K,0) - \\max(K-S_T,0) = S_T - K$，该测试简化为检查 $e^{-rT}\\mathbb{E}[S_T] - e^{-rT}K \\approx S_0 - K e^{-rT}$，即简化为鞅测试 $e^{-rT}\\mathbb{E}[S_T] \\approx S_0$。虽然这是一个有效的检查，但该方案要求“精确验证看跌-看涨期权平价关系”对于像蒙特卡洛这样的统计方法来说是不可能的。总会有抽样误差。\n$2$. 如果平价关系成立就得出“没有错误”的结论是不稳健的。例如，一个使用了不正确波动率 $\\sigma$ 的实现仍然会满足看跌-看涨期权平价关系，因为该关系与 $\\sigma$ 无关。该测试不全面。\n$3$. 将一种离散近似（欧拉 MC）与另一种（格子法）进行比较，和选项 A 一样，不是一个决定性的诊断。它没有使用已知的解析解作为基准。将差异完全归因于“抽样误差”是一个未经证实的跳跃，因为两种方法都有其自身的、可能不同的离散化偏差。\n**对 C 的结论：不正确。**\n\n**选项 D 的分析：**\n该方案依赖于一种复杂的技术，即准蒙特卡洛（QMC），但其应用是启发式的，而不是用于严谨的诊断。\n$1$. QMC 方法使用低差异序列（如 Sobol' 序列），通常能实现比标准 MC 的 $O(N^{-1/2})$ 更快的收敛率（例如，$O(N^{-1}\\log^d N)$）。如果切换到 QMC 显著减少了误差，这表明误差确实与抽样质量有关，指向抽样误差。然而，这不是一个决定性的测试。如果存在大的离散化偏差，MC 和 QMC 都会收敛到同一个错误的、有偏差的值。QMC 只不过是用更少的点数达到那里。它无助于区分相对于真实价格的偏差和抽样误差。\n$2$. 诊断逻辑薄弱：“将 $m$ 增加一次”不足以分析离散化偏差的趋势。基于未能匹配在“单个标准误”内的 BS 价格而得出“程序错误”的结论是武断的，且缺乏统计严谨性。QMC 的标准误估计也非易事，通常需要对序列进行随机化，而该提议并未提及。\n该方案将一种方差缩减技术误用为主要的诊断工具，并采用了有缺陷的、不严谨的逻辑。\n**对 D 的结论：不正确。**\n\n综上所述，选项 B 提出了唯一全面且科学合理的方法论。它使用确定性的、独立的测试系统地分离了每个潜在的误差来源——离散化偏差、抽样误差和实现错误——这些测试是计算金融领域的标准实践。",
            "answer": "$$\\boxed{B}$$"
        },
        {
            "introduction": "拥有一个经过验证的模拟器后，我们就可以将其作为一个计算实验室，来探索金融理论。这项练习  挑战您使用模拟生成的数据来检验著名的买卖权平价关系（put-call parity）。这是关键的一步，它将抽象的理论定理与蒙特卡洛方法固有的统计特性联系起来，让您亲身体会理论在实践中的样子。",
            "id": "2411949",
            "problem": "您正在使用蒙特卡洛（MC）模拟，在风险中性测度下，为基于同一支不支付股息的股票的欧式看涨期权和欧式看跌期权定价。标的股票价格被建模为几何布朗运动（GBM），其参数为 $S_0 = 100$，$K = 100$，$r = 0.05$，$\\sigma = 0.2$，到期时间 $T = 1$。您模拟了 $N = 100{,}000$ 个独立的期末价格，并将期权价格估计为贴现后收益的样本均值。在一次运行中，您得到看涨期权的估计价格为 $\\widehat{C} = 10.46$，估计标准误为 $0.06$；看跌期权的估计价格为 $\\widehat{P} = 5.57$，估计标准误为 $0.06$。基于这些结果，计算出估计的看涨-看跌平价残差 $\\widehat{\\Delta} = \\widehat{C} - \\widehat{P} - \\left(S_0 - K e^{-rT}\\right)$ 约为 $0.01$，其估计标准误（基于对看涨和看跌期权的独立抽样）约为 $0.085$。哪种说法最准确？\nA. 微小的非零 $\\widehat{\\Delta}$ 与抽样变异性是一致的；如果风险中性动态和贴现被正确实施，那么当 $N \\to \\infty$ 时，$\\widehat{\\Delta} \\to 0$。此外，在相同的模拟 $S_T$ 值上计算 $\\widehat{C}$ 和 $\\widehat{P}$ 并形成它们的路径差，通常会增加 $\\widehat{\\Delta}$ 的方差，因为贴现后的看涨和看跌期权收益是负相关的。\nB. 非零的 $\\widehat{\\Delta}$ 表明违反了看涨-看跌平价，这意味着风险中性模拟存在错误设定，除非包含了股息。\nC. 因为模拟中的漂移率被设置为 $r$，所以用 $e^{-rT}$ 进行贴现是不必要的；使用未贴现的收益仍然会得到对任何 $N$ 都无偏的价格和精确的平价关系。\nD. 使用对偶变量会强制使得对任何有限的 $N$，$\\widehat{\\Delta} = 0$，因此任何非零的残差都必定是由于编码错误。",
            "solution": "首先必须验证问题陈述的科学性和逻辑完整性。\n\nA. 问题验证\n\n步骤 1：提取给定信息\n\n- 资产：不支付股息的股票。\n- 模型：几何布朗运动（GBM）。\n- 定价测度：风险中性测度。\n- 数值方法：蒙特卡洛（MC）模拟。\n- 初始股价：$S_0 = 100$。\n- 行权价：$K = 100$。\n- 无风险利率：$r = 0.05$。\n- 波动率：$\\sigma = 0.2$。\n- 到期时间：$T = 1$。\n- 模拟次数：$N = 100,000$。\n- 估计的看涨期权价格：$\\widehat{C} = 10.46$。\n- 看涨期权价格估计量的估计标准误：$SE(\\widehat{C}) \\approx 0.06$。\n- 估计的看跌期权价格：$\\widehat{P} = 5.57$。\n- 看跌期权价格估计量的估计标准误：$SE(\\widehat{P}) \\approx 0.06$。\n- 看涨-看跌平价残差定义：$\\widehat{\\Delta} = \\widehat{C} - \\widehat{P} - \\left(S_0 - K e^{-rT}\\right)$。\n- 观测到的残差值：$\\widehat{\\Delta} \\approx 0.01$。\n- 残差计算中陈述的抽样方法：“对看涨和看跌期权进行独立抽样”。\n- 残差的估计标准误：$SE(\\widehat{\\Delta}) \\approx 0.085$。\n\n步骤 2：使用提取的给定信息进行验证\n\n问题陈述描述了在Black-Scholes-Merton框架内，使用蒙特卡洛模拟为欧式期权定价的一个标准应用。所有概念——GBM、风险中性定价、看涨-看跌平价和蒙特卡洛估计——都具有科学依据，并且是计算金融学的核心内容。\n\n我们必须检查所提供的数值的内部一致性。\n对于不支付股息股票上的欧式期权，其看涨-看跌平价关系为：\n$$C - P = S_0 - K e^{-rT}$$\n其中 $C$ 和 $P$ 是真实的期权价格。\n该平价关系中的确定性部分是：\n$$S_0 - K e^{-rT} = 100 - 100 \\times e^{-0.05 \\times 1} \\approx 100 - 100 \\times 0.9512294 = 4.87706$$\n来自模拟的估计差值为：\n$$\\widehat{C} - \\widehat{P} = 10.46 - 5.57 = 4.89$$\n因此，估计的残差为：\n$$\\widehat{\\Delta} = (\\widehat{C} - \\widehat{P}) - (S_0 - K e^{-rT}) \\approx 4.89 - 4.87706 = 0.01294$$\n问题陈述中指出 $\\widehat{\\Delta} \\approx 0.01$，这是相符的。\n\n问题陈述中指出，残差的标准误 $SE(\\widehat{\\Delta})$ 是在假设对看涨和看跌期权进行独立抽样的情况下估计的。在这种情况下，估计量之差的方差是它们方差的和：\n$$Var(\\widehat{\\Delta}) = Var(\\widehat{C} - \\widehat{P}) = Var(\\widehat{C}) + Var(\\widehat{P})$$\n一个估计量的标准误是其方差的平方根。因此：\n$$SE(\\widehat{\\Delta}) = \\sqrt{SE(\\widehat{C})^2 + SE(\\widehat{P})^2}$$\n使用给定的值：\n$$SE(\\widehat{\\Delta}) \\approx \\sqrt{(0.06)^2 + (0.06)^2} = \\sqrt{0.0036 + 0.0036} = \\sqrt{0.0072} \\approx 0.08485$$\n问题陈述中指出 $SE(\\widehat{\\Delta}) \\approx 0.085$，这也是相符的。\n\n问题陈述是自洽的、客观的、有科学依据且内部一致的。它没有违反任何验证标准。\n\n步骤 3：结论和行动\n\n问题是有效的。我们将继续进行分析。\n\nB. 解答和选项评估\n\n欧式期权的理论价格是在风险中性测度下预期收益的贴现值。对于看涨期权（$C$）和看跌期权（$P$）：\n$$C = E \\left[ e^{-rT} \\max(S_T-K, 0) \\right]$$\n$$P = E \\left[ e^{-rT} \\max(K-S_T, 0) \\right]$$\n在蒙特卡洛模拟中，我们在风险中性动态 $dS_t = rS_t dt + \\sigma S_t dW_t$ 下，生成 $N$ 条独立的期末股价 $S_T^{(i)}$ 路径。估计量是样本均值：\n$$\\widehat{C} = \\frac{1}{N} \\sum_{i=1}^{N} e^{-rT} \\max(S_T^{(i)}-K, 0)$$\n$$\\widehat{P} = \\frac{1}{N} \\sum_{i=1}^{N} e^{-rT} \\max(K-S_T^{(i)}, 0)$$\n由于恒等式 $\\max(x, 0) - \\max(-x, 0) = x$，我们有 $\\max(S_T-K, 0) - \\max(K-S_T, 0) = S_T-K$。如果对两个估计量使用相同的模拟路径 $S_T^{(i)}$，它们的差值为：\n$$\\widehat{C} - \\widehat{P} = \\frac{1}{N} \\sum_{i=1}^{N} e^{-rT} (S_T^{(i)}-K) = e^{-rT} \\left( \\frac{1}{N} \\sum_{i=1}^{N} S_T^{(i)} \\right) - K e^{-rT}$$\n令 $\\widehat{S}_T = \\frac{1}{N} \\sum S_T^{(i)}$。那么估计的差值为 $e^{-rT} \\widehat{S}_T - K e^{-rT}$。看涨-看跌平价残差为：\n$$\\widehat{\\Delta} = (\\widehat{C} - \\widehat{P}) - (S_0 - K e^{-rT}) = (e^{-rT} \\widehat{S}_T - K e^{-rT}) - (S_0 - K e^{-rT}) = e^{-rT} (\\widehat{S}_T - S_0 e^{rT})$$\n因为 $E[S_T] = S_0 e^{rT}$，所以残差的期望值为 $E[\\widehat{\\Delta}] = 0$。然而，对于任何有限的 $N$，$\\widehat{S}_T$ 是一个随机变量，几乎肯定不等于其期望值 $S_0 e^{rT}$。因此，由于抽样变异性，$\\widehat{\\Delta}$ 将会是非零的。根据大数定律，当 $N \\to \\infty$ 时，$\\widehat{S}_T \\to E[S_T]$，所以 $\\widehat{\\Delta} \\to 0$。\n\n现在，我们评估每个选项。\n\n**选项A：** “微小的非零 $\\widehat{\\Delta}$ 与抽样变异性是一致的；如果风险中性动态和贴现被正确实施，那么当 $N \\to \\infty$ 时，$\\widehat{\\Delta} \\to 0$。此外，在相同的模拟 $S_T$ 值上计算 $\\widehat{C}$ 和 $\\widehat{P}$ 并形成它们的路径差，通常会增加 $\\widehat{\\Delta}$ 的方差，因为贴现后的看涨和看跌期权收益是负相关的。”\n\n- **第一部分：** 观测到的残差为 $\\widehat{\\Delta} \\approx 0.01$，标准误为 $SE(\\widehat{\\Delta}) \\approx 0.085$。该残差距离零大约 $0.12$ 个标准误，这在统计上不显著，并且完全与抽样噪音相符。如上所示，当 $N \\to \\infty$ 时，$\\widehat{\\Delta} \\to 0$。这部分是正确的。\n- **第二部分：** 这部分分析了在对看涨和看跌期权使用相同随机数（共同路径）时，差值估计量的方差。两个随机变量 $X$ 和 $Y$ 的差的方差为 $Var(X-Y) = Var(X) + Var(Y) - 2Cov(X,Y)$。令 $X$ 为单条路径的贴现后看涨期权收益， $Y$ 为贴现后看跌期权收益。\n收益的乘积为 $XY = e^{-2rT} \\max(S_T-K, 0) \\max(K-S_T, 0) = 0$，对任何 $S_T$ 值都成立。\n因此，协方差为 $Cov(X,Y) = E[XY] - E[X]E[Y] = 0 - E[X]E[Y]$。由于 $E[X]=C0$ 和 $E[Y]=P0$，它们的协方差为负：$Cov(X,Y) = -CP  0$。看涨和看跌期权的收益是负相关的。\n路径差估计量 $\\widehat{C}-\\widehat{P}$ 的方差是收益之差的方差除以 $N$。\n$$Var(\\widehat{C}-\\widehat{P}) = \\frac{Var(X-Y)}{N} = \\frac{Var(X) + Var(Y) - 2Cov(X,Y)}{N}$$\n由于 $Cov(X,Y)$ 是负的，项 $-2Cov(X,Y)$ 是正的。因此：\n$$Var(\\widehat{C}-\\widehat{P}) = \\frac{Var(X) + Var(Y) + 2|Cov(X,Y)|}{N} > \\frac{Var(X) + Var(Y)}{N}$$\n这意味着，当使用共同路径时，差值 $C-P$ 的估计量的方差要 *大于* 使用独立路径时的方差（此时协方差项为零）。因此，关于“使用共同路径会增加 $\\widehat{\\Delta}$ 的方差，因为收益是负相关的”这一说法在数学上是正确的。\n陈述的两个部分都准确。\n**结论：正确**\n\n**选项B：** “非零的 $\\widehat{\\Delta}$ 表明违反了看涨-看跌平价，这意味着风险中性模拟存在错误设定，除非包含了股息。”\n\n这是不正确的。在蒙特卡洛模拟中，由于统计抽样误差，出现非零残差是预料之中的。残差的量级（$\\approx 0.01$）相对于其标准误（$\\approx 0.085$），意味着它在统计上与零无法区分。将这种噪音归因于诸如缺失股息之类的基本模型错误是一个无效的结论。问题中明确规定了股票不支付股息。\n**结论：不正确**\n\n**选项C：** “因为模拟中的漂移率被设置为 $r$，所以用 $e^{-rT}$ 进行贴现是不必要的；使用未贴现的收益仍然会得到对任何 $N$ 都无偏的价格和精确的平价关系。”\n\n这个陈述有根本性错误。风险中性定价理论将资产价格定义为其未来预期收益的*现值*。期望是在风险中性测度下计算的（在该测度下，资产预期以速率 $r$ 增长），然后使用无风险利率 $r$ 将该期望贴现回今天。省略贴现因子 $e^{-rT}$ 将得到期权在时间 $T$ 的预期未来价值，而不是其在时间 $0$ 的现值（价格）。\n此外，“对任何 $N$ 都精确平价”的说法是错误的。未贴现的差值估计量将是 $\\widehat{C}_{undisc} - \\widehat{P}_{undisc} = \\widehat{S}_T - K$。相应的理论平价关系是 $C e^{rT} - P e^{rT} = S_0 e^{rT} - K$。只有当 $\\widehat{S}_T = S_0 e^{rT}$ 时，这两者才相等，而由于抽样误差，这对于任何有限样本 $N$ 都不成立。\n**结论：不正确**\n\n**选项D：** “使用对偶变量会强制使得对任何有限的 $N$，$\\widehat{\\Delta} = 0$，因此任何非零的残差都必定是由于编码错误。”\n\n对偶变量是一种方差缩减技术，它使用基于标准正态离差 $Z$ 和 $-Z$ 的成对模拟路径。$E[f(Z)]$ 的估计量变为 $\\frac{1}{2N}\\sum_{i=1}^N (f(Z_i) + f(-Z_i))$。看涨-看跌平价残差 $\\widehat{\\Delta}$ 与 $\\widehat{S}_T - E[S_T]$ 成正比。使用对偶变量的 $S_T$ 估计量是：\n$$\\widehat{S}_{T,AV} = \\frac{1}{2N} \\sum_{i=1}^N S_0 \\exp\\left(\\left(r - \\frac{\\sigma^2}{2}\\right)T\\right) \\left[ e^{\\sigma\\sqrt{T}Z_i} + e^{\\sigma\\sqrt{T}(-Z_i)} \\right]$$\n这可以简化为：\n$$\\widehat{S}_{T,AV} = \\frac{S_0}{N} \\exp\\left(\\left(r - \\frac{\\sigma^2}{2}\\right)T\\right) \\sum_{i=1}^N \\cosh(\\sigma\\sqrt{T}Z_i)$$\n项 $\\cosh(\\sigma\\sqrt{T}Z_i)$ 是一个随机变量，不是一个常数。在有限样本 $N$ 上，该项的样本均值不保证等于其期望值。因此，对于有限的 $N$，$\\widehat{S}_{T,AV}$ 不会精确等于 $E[S_T]$，因此残差 $\\widehat{\\Delta}$ 不会被强制为零。对偶变量会减小估计量 $\\widehat{S}_T$（以及 $\\widehat{\\Delta}$）的方差，但不会消除它。\n**结论：不正确**",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "在实际的金融风险管理中，仅仅知道期权的价格是不够的，我们更需要了解其对市场变化的敏感度，即“希腊字母（Greeks）”。这项实践  将指导您完成一项更高级的应用：使用有限差分法来估计期权的“伽马”($\\Gamma$)。这个任务不仅展示了模拟方法在解决复杂问题上的威力，也引入了关于数值稳定性的重要概念。",
            "id": "2411952",
            "problem": "考虑一个基于某标的资产的欧式看跌期权，该资产的价格在风险中性的Black–Scholes–Merton (BSM) 模型下演变。在风险中性概率测度下，资产价格过程 $\\{S_t\\}_{t \\ge 0}$ 满足随机微分方程 $dS_t = r S_t \\, dt + \\sigma S_t \\, dW_t$，其中 $r$ 是连续复利无风险利率，$\\sigma$ 是波动率，$\\{W_t\\}_{t \\ge 0}$ 是一个标准布朗运动。该欧式看跌期权的执行价格为 $K$，到期日为 $T$，其折现后收益价格由风险中性期望 $e^{-r T} \\mathbb{E}[(K - S_T)^+]$ 给出，其中 $(x)^+ = \\max\\{x, 0\\}$。希腊字母$\\Gamma$定义为期权价格关于初始资产价格 $S_0$ 的二阶导数，即 $\\Gamma = \\frac{\\partial^2}{\\partial S_0^2} \\text{Price}(S_0)$。\n\n您的任务是编写一个完整的程序，通过蒙特卡洛 (MC) 模拟来估计欧式看跌期权的$\\Gamma$值。该模拟使用基于三个初始价格 $S_0 - \\varepsilon$、$S_0$ 和 $S_0 + \\varepsilon$ 的对称三点有限差分近似法。对于每个给定的测试用例，请使用两种不同的扰动幅度 $\\varepsilon_{\\text{small}}$ 和 $\\varepsilon_{\\text{large}}$ 两次估计$\\Gamma$。对于每个$\\varepsilon$，通过将每条路径的二阶差分贡献视为独立同分布的观测值，并使用样本标准差除以模拟路径数的平方根，来计算相关的标准误差。在每个测试用例的每次$\\varepsilon$计算中，对三个初始价格使用相同的随机冲击。所有答案均表示为无量纲的小数。\n\n将估计量的稳定性定义如下：设 $\\widehat{\\Gamma}_{\\text{small}}$ 和 $\\widehat{\\Gamma}_{\\text{large}}$ 分别为使用 $\\varepsilon_{\\text{small}}$ 和 $\\varepsilon_{\\text{large}}$ 得到的两个估计值，$\\widehat{\\text{SE}}_{\\text{small}}$ 和 $\\widehat{\\text{SE}}_{\\text{large}}$ 为它们对应的估计标准误差。定义绝对差值 $\\Delta = |\\widehat{\\Gamma}_{\\text{small}} - \\widehat{\\Gamma}_{\\text{large}}|$ 和稳定性阈值 $\\Theta = 2 \\cdot \\max\\{\\widehat{\\text{SE}}_{\\text{small}}, \\widehat{\\text{SE}}_{\\text{large}}\\}$。如果 $\\Delta \\le \\Theta$，则认为该估计量是稳定的。\n\n实现您的程序以处理以下参数集的测试套件。对每个测试用例，使用指定的输入：初始价格 $S_0$、执行价格 $K$、无风险利率 $r$、波动率 $\\sigma$、到期时间 $T$、蒙特卡洛路径数 $N$、小扰动量 $\\varepsilon_{\\text{small}}$ 和大扰动量 $\\varepsilon_{\\text{large}}$。\n\n测试用例A（平价，一年期）：\n- $S_0 = 100.0$，$K = 100.0$，$r = 0.05$，$\\sigma = 0.2$，$T = 1.0$，$N = 200000$，$\\varepsilon_{\\text{small}} = 0.1$，$\\varepsilon_{\\text{large}} = 1.0$。\n\n测试用例B（深度实值看跌，一年期）：\n- $S_0 = 60.0$，$K = 100.0$，$r = 0.01$，$\\sigma = 0.4$，$T = 1.0$，$N = 200000$，$\\varepsilon_{\\text{small}} = 0.2$，$\\varepsilon_{\\text{large}} = 2.0$。\n\n测试用例C（平价，短期限）：\n- $S_0 = 100.0$，$K = 100.0$，$r = 0.0$，$\\sigma = 0.2$，$T = 0.05$，$N = 200000$，$\\varepsilon_{\\text{small}} = 0.05$，$\\varepsilon_{\\text{large}} = 0.5$。\n\n您的程序必须为每个测试用例生成一个包含以下六个值的列表，并按顺序排列：\n- $\\widehat{\\Gamma}_{\\text{small}}$，\n- $\\widehat{\\text{SE}}_{\\text{small}}$，\n- $\\widehat{\\Gamma}_{\\text{large}}$，\n- $\\widehat{\\text{SE}}_{\\text{large}}$，\n- $\\Delta$，\n- 一个布尔稳定性标志，如果 $\\Delta \\le \\Theta$ 则为 $true$，否则为 $false$。\n\n所有浮点数必须四舍五入打印至6位小数。布尔值必须以小写形式打印为 $true$ 或 $false$。\n\n最终输出格式：您的程序应生成单行输出，其中包含三个测试用例各自列表的结果，结果为逗号分隔的列表，并用方括号括起来。例如，结构必须严格遵循 $[[\\cdot,\\cdot,\\cdot,\\cdot,\\cdot,\\cdot],[\\cdot,\\cdot,\\cdot,\\cdot,\\cdot,\\cdot],[\\cdot,\\cdot,\\cdot,\\cdot,\\cdot,\\cdot]]$ 的形式，不含空格。不应打印任何额外文本。",
            "solution": "对所提出的问题进行严格验证。\n\n步骤1：提取已知条件\n- 模型：Black–Scholes–Merton (BSM) 风险中性模型。\n- 资产价格动态：随机微分方程 (SDE) 为 $dS_t = r S_t \\, dt + \\sigma S_t \\, dW_t$，其中 $r$ 是无风险利率，$\\sigma$ 是波动率，$W_t$ 是标准布朗运动。\n- 期权类型：欧式看跌期权。\n- 参数：执行价格 $K$，到期日 $T$，初始资产价格 $S_0$。\n- 到期回报：$(K - S_T)^+ = \\max\\{K - S_T, 0\\}$。\n- 期权价格公式：$\\text{Price}(S_0) = e^{-r T} \\mathbb{E}[(K - S_T)^+]$。\n- 待估计的希腊字母：$\\Gamma = \\frac{\\partial^2}{\\partial S_0^2} \\text{Price}(S_0)$。\n- 估计方法：使用对称三点有限差分近似的蒙特卡洛 (MC) 模拟。\n- 有限差分格式：利用初始价格 $S_0 - \\varepsilon$、$S_0$ 和 $S_0 + \\varepsilon$。\n- 扰动幅度：使用两个值 $\\varepsilon_{\\text{small}}$ 和 $\\varepsilon_{\\text{large}}$ 进行分开估计。\n- 标准误差 (SE) 估计：SE由每条路径的二阶差分贡献的样本标准差除以路径数 $N$ 的平方根计算得出。\n- 方差缩减：在每次估计中，必须对三个价格点 ($S_0 - \\varepsilon$、$S_0$ 和 $S_0 + \\varepsilon$) 使用相同的随机冲击（共同随机数）。\n- 估计量稳定性度量：由 $\\Delta = |\\widehat{\\Gamma}_{\\text{small}} - \\widehat{\\Gamma}_{\\text{large}}|$ 和阈值 $\\Theta = 2 \\cdot \\max\\{\\widehat{\\text{SE}}_{\\text{small}}, \\widehat{\\text{SE}}_{\\text{large}}\\}$ 定义。如果 $\\Delta \\le \\Theta$，则稳定性成立。\n- 测试用例A：$S_0 = 100.0$，$K = 100.0$，$r = 0.05$，$\\sigma = 0.2$，$T = 1.0$，$N = 200000$，$\\varepsilon_{\\text{small}} = 0.1$，$\\varepsilon_{\\text{large}} = 1.0$。\n- 测试用例B：$S_0 = 60.0$，$K = 100.0$，$r = 0.01$，$\\sigma = 0.4$，$T = 1.0$，$N = 200000$，$\\varepsilon_{\\text{small}} = 0.2$，$\\varepsilon_{\\text{large}} = 2.0$。\n- 测试用例C：$S_0 = 100.0$，$K = 100.0$，$r = 0.0$，$\\sigma = 0.2$，$T = 0.05$，$N = 200000$，$\\varepsilon_{\\text{small}} = 0.05$，$\\varepsilon_{\\text{large}} = 0.5$。\n- 每个测试用例的所需输出：一个包含六个值的列表：$[\\widehat{\\Gamma}_{\\text{small}}, \\widehat{\\text{SE}}_{\\text{small}}, \\widehat{\\Gamma}_{\\text{large}}, \\widehat{\\text{SE}}_{\\text{large}}, \\Delta, \\text{稳定性标志}]$。浮点数必须四舍五入到6位小数，布尔值必须为小写（`true`/`false`）。\n\n步骤2：使用提取的已知条件进行验证\n对问题的有效性进行评估。\n- **科学依据充分：** 该问题基于金融工程的基石——经典的Black–Scholes–Merton模型。所规定的方法——蒙特卡洛模拟和有限差分近似——是计算金融学中标准且有效的数值技术。该问题在科学上是合理的。\n- **适定性：** 每个测试用例的所有必要参数 ($S_0, K, r, \\sigma, T$)、数值设置 ($N, \\varepsilon_{\\text{small}}, \\varepsilon_{\\text{large}}$) 和定义（例如，稳定性）都已明确给出。目标陈述清晰。该问题是适定的。\n- **客观性：** 问题陈述以精确的数学和计算术语表述，不含任何主观或基于意见的内容。\n\n步骤3：结论与行动\n该问题有效。它科学依据充分、适定、客观，并包含一个完整且一致的设定。将构建一个解决方案。\n\n基本原理是欧式期权的风险中性定价。在BSM模型下，给定初始价格 $S_0$，到期日 $T$ 的资产价格 $S_T$ 服从对数正态分布。该随机微分方程的显式解为：\n$$ S_T = S_0 \\exp\\left( \\left(r - \\frac{1}{2}\\sigma^2\\right)T + \\sigma\\sqrt{T}Z \\right) $$\n其中 $Z$ 是从标准正态分布 $\\mathcal{N}(0, 1)$ 中抽取的随机变量。\n\n期权的Gamma值，即 $\\Gamma$，是期权价格 $P$ 相对于初始资产价格 $S_0$ 的二阶导数：\n$$ \\Gamma = \\frac{\\partial^2 P(S_0)}{\\partial S_0^2} $$\n我们使用中心有限差分公式来近似该导数：\n$$ \\Gamma \\approx \\frac{P(S_0 + \\varepsilon) - 2P(S_0) + P(S_0 - \\varepsilon)}{\\varepsilon^2} $$\n其中 $\\varepsilon$ 是一个小的扰动量。\n\n期权价格 $P(S_0)$ 是风险中性测度下折现后的期望回报：\n$$ P(S_0) = e^{-rT}\\mathbb{E}\\left[(K - S_T(S_0))^+\\right] $$\n通过将此代入有限差分公式，并利用期望算子的线性性质，我们可以将Gamma的近似表示为单个随机变量的期望：\n$$ \\Gamma \\approx \\mathbb{E}\\left[ \\frac{e^{-rT}(K - S_T(S_0+\\varepsilon))^+ - 2e^{-rT}(K - S_T(S_0))^+ + e^{-rT}(K - S_T(S_0-\\varepsilon))^+}{\\varepsilon^2} \\right] $$\n该公式非常适合蒙特卡洛估计。我们为第 $i$ 条模拟路径定义Gamma的单路径估计量 $\\gamma_i$：\n$$ \\gamma_i(\\varepsilon) = \\frac{p_i(S_0+\\varepsilon) - 2p_i(S_0) + p_i(S_0-\\varepsilon)}{\\varepsilon^2} $$\n其中 $p_i(S)$ 表示从价格 $S$ 开始的第 $i$ 条路径的折现后回报：\n$$ p_i(S) = e^{-rT} \\max\\left(K - S \\exp\\left( \\left(r - \\frac{1}{2}\\sigma^2\\right)T + \\sigma\\sqrt{T}Z_i \\right), 0\\right) $$\n其中 $Z_i$ 是从 $\\mathcal{N}(0, 1)$ 中抽取的第 $i$ 个值。关键在于，在计算 $\\gamma_i$ 的表达式时，对三个回报值使用相同的随机变量值 $Z_i$。这就是共同随机数法，它能显著降低估计量的方差。\n\nGamma的蒙特卡洛估计量 $\\widehat{\\Gamma}$ 是 $N$ 个此类路径估计量的样本均值：\n$$ \\widehat{\\Gamma} = \\frac{1}{N} \\sum_{i=1}^{N} \\gamma_i $$\n该估计量的标准误差 $\\widehat{\\text{SE}}(\\widehat{\\Gamma})$ 由 $\\gamma_i$ 值的样本标准差除以路径数的平方根给出：\n$$ \\widehat{\\text{SE}}(\\widehat{\\Gamma}) = \\frac{s_\\gamma}{\\sqrt{N}} = \\frac{1}{\\sqrt{N}} \\sqrt{\\frac{1}{N-1} \\sum_{i=1}^{N} (\\gamma_i - \\widehat{\\Gamma})^2} $$\n对每个测试用例，整个过程执行两次：一次使用 $\\varepsilon = \\varepsilon_{\\text{small}}$ 以获得 $\\widehat{\\Gamma}_{\\text{small}}$ 和 $\\widehat{\\text{SE}}_{\\text{small}}$，另一次使用 $\\varepsilon = \\varepsilon_{\\text{large}}$ 以获得 $\\widehat{\\Gamma}_{\\text{large}}$ 和 $\\widehat{\\text{SE}}_{\\text{large}}$。\n\n最后，评估估计量相对于扰动大小 $\\varepsilon$ 的稳定性。我们计算估计值的绝对差值 $\\Delta$ 和一个稳定性阈值 $\\Theta$：\n$$ \\Delta = |\\widehat{\\Gamma}_{\\text{small}} - \\widehat{\\Gamma}_{\\text{large}}| $$\n$$ \\Theta = 2 \\cdot \\max\\{\\widehat{\\text{SE}}_{\\text{small}}, \\widehat{\\text{SE}}_{\\text{large}}\\} $$\n2这个选择与构建一个近似 $95\\%$ 的置信区间有关。如果差值 $\\Delta$ 在此阈值之内，即 $\\Delta \\le \\Theta$，则认为估计量是稳定的。然后按规定汇总结果。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n# from scipy is not used but is noted as available.\n\ndef solve():\n    \"\"\"\n    Main function to run the Monte Carlo simulation for all test cases\n    and print the results in the required format.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Test Case A (at-the-money, one year)\n        (100.0, 100.0, 0.05, 0.2, 1.0, 200000, 0.1, 1.0),\n        # Test Case B (deep in-the-money put, one year)\n        (60.0, 100.0, 0.01, 0.4, 1.0, 200000, 0.2, 2.0),\n        # Test Case C (at-the-money, short maturity)\n        (100.0, 100.0, 0.0, 0.2, 0.05, 200000, 0.05, 0.5),\n    ]\n\n    all_results = []\n    \n    # Instantiate a random number generator for reproducibility.\n    rng = np.random.default_rng(seed=42)\n\n    for case in test_cases:\n        s0, k, r, sigma, t, n, eps_small, eps_large = case\n\n        # Generate common random numbers for all subsequent calculations for this case\n        z_shocks = rng.standard_normal(n)\n\n        # --- Calculation for epsilon_small ---\n        gamma_small, se_small = estimate_gamma_and_se(\n            s0, k, r, sigma, t, n, eps_small, z_shocks\n        )\n\n        # --- Calculation for epsilon_large ---\n        gamma_large, se_large = estimate_gamma_and_se(\n            s0, k, r, sigma, t, n, eps_large, z_shocks\n        )\n\n        # --- Stability Analysis ---\n        delta = abs(gamma_small - gamma_large)\n        theta = 2.0 * max(se_small, se_large)\n        is_stable = delta = theta\n\n        all_results.append(\n            [gamma_small, se_small, gamma_large, se_large, delta, is_stable]\n        )\n\n    # Final print statement in the exact required format.\n    print_formatted_results(all_results)\n\ndef estimate_gamma_and_se(s0, k, r, sigma, t, n, epsilon, z_shocks):\n    \"\"\"\n    Estimates Gamma and its standard error for a European put option using\n    Monte Carlo with a three-point finite difference method.\n\n    Args:\n        s0 (float): Initial asset price.\n        k (float): Strike price.\n        r (float): Risk-free interest rate.\n        sigma (float): Volatility.\n        t (float): Time to maturity.\n        n (int): Number of Monte Carlo paths.\n        epsilon (float): Perturbation for finite difference.\n        z_shocks (np.ndarray): Array of standard normal random numbers.\n\n    Returns:\n        tuple[float, float]: Estimated Gamma and its standard error.\n    \"\"\"\n    # Define initial prices for the finite difference scheme\n    s0_plus = s0 + epsilon\n    s0_minus = s0 - epsilon\n\n    # Calculate the common component for asset price simulation\n    drift = (r - 0.5 * sigma**2) * t\n    vol_shock = sigma * np.sqrt(t) * z_shocks\n    \n    # Terminal prices for the three perturbed initial prices\n    # using common random numbers (z_shocks)\n    st_plus = s0_plus * np.exp(drift + vol_shock)\n    st_0 = s0 * np.exp(drift + vol_shock)\n    st_minus = s0_minus * np.exp(drift + vol_shock)\n\n    # Discounted payoffs for the put option\n    discount_factor = np.exp(-r * t)\n    payoff_plus = discount_factor * np.maximum(k - st_plus, 0)\n    payoff_0 = discount_factor * np.maximum(k - st_0, 0)\n    payoff_minus = discount_factor * np.maximum(k - st_minus, 0)\n    \n    # Per-path estimators for Gamma\n    gamma_paths = (payoff_plus - 2 * payoff_0 + payoff_minus) / (epsilon**2)\n\n    # Estimate Gamma (mean of per-path estimators)\n    gamma_hat = np.mean(gamma_paths)\n\n    # Estimate Standard Error\n    # ddof=1 for sample standard deviation\n    se_hat = np.std(gamma_paths, ddof=1) / np.sqrt(n)\n\n    return gamma_hat, se_hat\n\ndef print_formatted_results(results_data):\n    \"\"\"\n    Formats the final results list into the specific string format required by the problem.\n    \"\"\"\n    formatted_cases = []\n    for case_results in results_data:\n        formatted_values = []\n        for value in case_results:\n            if isinstance(value, float):\n                formatted_values.append(f\"{value:.6f}\")\n            elif isinstance(value, (bool, np.bool_)):\n                formatted_values.append(str(value).lower())\n        formatted_cases.append(f\"[{','.join(formatted_values)}]\")\n    \n    final_output_string = f\"[{','.join(formatted_cases)}]\"\n    print(final_output_string)\n\nsolve()\n```"
        }
    ]
}