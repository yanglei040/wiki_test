{
    "hands_on_practices": [
        {
            "introduction": "在选择时间片 $q$ 时，一个最基本的考量是它如何与调度开销 $c$ 共同影响系统的总容量。这个练习将引导你从第一性原理出发，推导在一个有预算限制的周期内，系统可调度的最大任务数。通过这个计算 ，你将直观地理解 $q$ 和 $c$ 的组合成本如何直接决定系统的吞吐量上限，这是进行任何性能调优之前的基础。",
            "id": "3678475",
            "problem": "一个系统使用节流机制来为中央处理器（CPU）强制执行每个周期的执行预算。该机制以固定长度的周期 $T$ 运行，在每个周期内，用户任务消耗的总 CPU 时间加上调度程序开销不得超过预算 $B$，其中 $0 < B \\leq T$。调度程序是时间片轮转（RR）调度，它为每个就绪任务分配一个固定的时间片 $q$。每个长度为 $q$ 的调度时间片都伴随着一个固定的开销成本 $c$（包括上下文切换和簿记），这个成本 $c$ 从同一个预算 $B$ 中扣除。\n\n假设有 $n$ 个相同的 CPU 密集型任务始终处于就绪状态，公平性定义为每个周期为每个任务恰好提供一个长度为 $q$ 的时间片。RR 调度程序在周期内循环地为任务提供服务，使得 $n$ 个任务中的每一个在每个周期内都能获得一次时间片，并且每次调度时间片都会产生相应的开销 $c$。\n\n从第一性原理出发——即时间片轮转调度的固定时间片定义、包括开销在内的总 CPU 使用量不得超过预算 $B$ 的预算规则，以及每个时间片都伴有恒定开销的假设——推导出一个闭式表达式，用于计算在不违反预算的情况下每个周期可以调度的最大整数任务数 $n$。请将最终答案表示为 $B$、$q$ 和 $c$ 的解析表达式。不需要进行数值舍入。",
            "solution": "问题要求在给定 CPU 预算 $B$、时间片 $q$ 和单位时间片开销 $c$ 的情况下，推导出每个周期内可调度的最大整数任务数 $n$ 的闭式表达式。\n\n推导过程从问题陈述中提供的基本约束出发。\n\n1.  **每个周期的总 CPU 消耗**：一个周期内消耗的总 CPU 时间是执行用户任务所用时间与调度程序开销所用时间之和。\n\n2.  **用户任务 CPU 时间**：根据问题对公平性的定义，$n$ 个任务中的每一个在每个周期内恰好获得一个长度为 $q$ 的时间片。因此，在一个周期内分配给用户任务的总 CPU 时间是任务数量乘以每个任务的时间片长度。\n    $$\n    T_{\\text{tasks}} = n \\cdot q\n    $$\n\n3.  **调度程序开销 CPU 时间**：每调度一个时间片，就会产生一个固定的开销成本 $c$。由于有 $n$ 个任务，每个任务被调度一次，因此每个周期总共有 $n$ 次调度事件。总开销成本是调度事件的数量乘以每次事件的成本。\n    $$\n    T_{\\text{overhead}} = n \\cdot c\n    $$\n\n4.  **预算约束**：问题陈述指出，用户任务消耗的总 CPU 时间加上调度程序开销不得超过预算 $B$。这就得出了以下不等式：\n    $$\n    T_{\\text{tasks}} + T_{\\text{overhead}} \\leq B\n    $$\n    将 $T_{\\text{tasks}}$ 和 $T_{\\text{overhead}}$ 的表达式代入，我们得到：\n    $$\n    n \\cdot q + n \\cdot c \\leq B\n    $$\n\n5.  **求解 n**：我们可以从不等式的左侧提出因子 $n$：\n    $$\n    n(q + c) \\leq B\n    $$\n    项 $(q+c)$ 表示为单个任务调度一个时间片所产生的总预算成本。由于 $q$ 是一个时间片，它必须是正数（$q > 0$），并且由于 $c$ 是一个开销成本，它必须是非负数（$c \\geq 0$）。因此，和 $(q+c)$ 是严格正数。我们可以对不等式两边同除以 $(q+c)$，且不等号方向不变：\n    $$\n    n \\leq \\frac{B}{q+c}\n    $$\n    这个不等式定义了任务数 $n$ 的上限。\n\n6.  **整数约束**：问题要求的是*最大整数任务数*。由于 $n$ 必须是整数，其最大值是小于或等于表达式 $\\frac{B}{q+c}$ 的最大整数。根据定义，这就是该表达式的向下取整。向下取整函数，表示为 $\\lfloor x \\rfloor$，其结果为不大于 $x$ 的最大整数。\n\n因此，最大整数任务数 $n$ 由下式给出：\n$$\nn = \\left\\lfloor \\frac{B}{q+c} \\right\\rfloor\n$$\n这是在不违反预算的情况下每个周期可调度的最大任务数的最终闭式表达式，用 $B$、$q$ 和 $c$ 表示。周期长度 $T$ 是一个上下文参数，用于确认预算 $B$ 是总时间的有效部分（$B \\leq T$），但它不参与基于预算约束的 $n$ 的计算。",
            "answer": "$$\n\\boxed{\\left\\lfloor \\frac{B}{q+c} \\right\\rfloor}\n$$"
        },
        {
            "introduction": "现实世界中的系统很少只运行一种类型的任务，通常是计算密集型和I/O密集型任务的混合。这个练习探讨了在这种混合工作负载下，时间片 $q$ 的选择如何影响调度的公平性。你将使用著名的Jain公平性指数来量化当I/O密集型任务无法用尽其完整时间片时，不同任务获得的CPU份额是如何变化的 ，从而揭示一个看似高效的时间片设置可能带来的不公平性。",
            "id": "3678396",
            "problem": "考虑一个使用时间片轮转调度的单处理器系统，其时间片为 $q$ 且上下文切换开销可忽略不计。在时间 $t=0$ 时，有 $N$ 个始终处于就绪状态的计算密集型任务，以及 $M$ 个在消耗一小段中央处理器（CPU）时间后会自愿阻塞以进行输入/输出（I/O）的交互式任务。每个交互式任务一旦被调度，会运行一个固定的时长 $s$（其中 $0<s<q$），然后休眠足够长的时间，以至于在感兴趣的时间区间内不会再次出现。调度器以循环顺序访问每个就绪任务最多一次，允许每个任务运行，直到其执行了 $q$ 个单位时间或自愿放弃 CPU，以先发生者为准。\n\n将任务 $i$ 在所考虑区间内的有效 CPU 份额 $x_i$ 定义为其在该区间内实际的 CPU 运行时间与所有任务累积的总 CPU 运行时间之比：\n$$\nx_i \\;=\\; \\frac{\\text{running time of task } i}{\\sum\\limits_{j=1}^{N+M} \\text{running time of task } j}.\n$$\n使用此定义，推导所得 CPU 份额向量 $x = (x_1,\\dots,x_{N+M})$ 的公平性指数 $J(q)$ 作为时间片 $q$ 的函数，其中公平性指数由著名的 Jain 公平性指数定义：\n$$\nJ(x)\\;=\\;\\frac{\\left(\\sum\\limits_{i=1}^{N+M} x_i\\right)^{2}}{(N+M)\\left(\\sum\\limits_{i=1}^{N+M} x_i^{2}\\right)}.\n$$\n假设 $N\\geq 1$，$M\\geq 1$，$q>0$ 且 $0<s<q$。请将您的最终答案表示为关于 $N$、$M$、$q$ 和 $s$ 的单个闭式解析表达式。无需进行数值计算或四舍五入。",
            "solution": "问题的核心是计算每个任务的 CPU 份额 $x_i$，然后将这些份额代入 Jain 公平性指数的公式。我们分析一个完整的单个调度轮次，在此期间，初始的 $N+M$ 个任务中的每一个都被服务一次。\n\n首先，我们确定在此区间内每种类型的任务所消耗的 CPU 时间。\n有 $N$ 个计算密集型任务。由于它们始终处于就绪状态，每个任务都将被调度并运行其完整的时间片 $q$。这 $N$ 个任务中任何一个的运行时间都是 $q$。\n有 $M$ 个交互式任务。每个任务被规定在阻塞前运行一个时长 $s$。由于问题陈述 $0 < s < q$，每个交互式任务将运行时间 $s$ 然后在其时间片用尽之前自愿放弃 CPU。这 $M$ 个任务中任何一个的运行时间都是 $s$。\n\n在此区间内，所有任务累积的总 CPU 时间 $T_{\\text{total}}$ 是所有 $N$ 个计算密集型任务和 $M$ 个交互式任务的时间之和：\n$$ T_{\\text{total}} = (N \\times q) + (M \\times s) = Nq + Ms $$\n接下来，我们使用其定义 $x_i = (\\text{任务 } i \\text{ 的运行时间}) / T_{\\text{total}}$ 来计算每个任务的 CPU 份额。\n对于 $N$ 个计算密集型任务中的每一个，其份额（我们可记为 $x_{\\text{c}}$）是相同的：\n$$ x_{\\text{c}} = \\frac{q}{Nq + Ms} $$\n对于 $M$ 个交互式任务中的每一个，其份额（我们可记为 $x_{\\text{int}}$）在其组内也是相同的：\n$$ x_{\\text{int}} = \\frac{s}{Nq + Ms} $$\n现在，我们应用 Jain 公平性指数的公式，$J(q)$：\n$$ J(q) = \\frac{\\left(\\sum\\limits_{i=1}^{N+M} x_i\\right)^{2}}{(N+M)\\left(\\sum\\limits_{i=1}^{N+M} x_i^{2}\\right)} $$\n我们计算两个求和项。首先，是分子中各项份额的总和：\n$$ \\sum_{i=1}^{N+M} x_i = N \\cdot x_{\\text{c}} + M \\cdot x_{\\text{int}} = N \\left( \\frac{q}{Nq + Ms} \\right) + M \\left( \\frac{s}{Nq + Ms} \\right) = \\frac{Nq + Ms}{Nq + Ms} = 1 $$\n这证实了所有份额之和为 $1$ 的属性。因此，$J(q)$ 的分子是 $(1)^{2} = 1$。$J(q)$ 的公式简化为：\n$$ J(q) = \\frac{1}{(N+M)\\left(\\sum\\limits_{i=1}^{N+M} x_i^{2}\\right)} $$\n接下来，我们计算分母中各项份额的平方和：\n$$ \\sum_{i=1}^{N+M} x_i^{2} = N \\cdot x_{\\text{c}}^{2} + M \\cdot x_{\\text{int}}^{2} = N \\left( \\frac{q}{Nq + Ms} \\right)^{2} + M \\left( \\frac{s}{Nq + Ms} \\right)^{2} $$\n$$ \\sum_{i=1}^{N+M} x_i^{2} = \\frac{Nq^{2}}{(Nq + Ms)^{2}} + \\frac{Ms^{2}}{(Nq + Ms)^{2}} = \\frac{Nq^{2} + Ms^{2}}{(Nq + Ms)^{2}} $$\n最后，我们将此表达式代入 $J(q)$ 的简化公式中：\n$$ J(q) = \\frac{1}{(N+M) \\left( \\frac{Nq^{2} + Ms^{2}}{(Nq + Ms)^{2}} \\right)} $$\n将分母中的分数求倒数，得到公平性指数的最终闭式表达式：\n$$ J(q) = \\frac{(Nq + Ms)^{2}}{(N+M)(Nq^{2} + Ms^{2})} $$\n此表达式给出了公平性指数作为给定参数 $N$、$M$、$q$ 和 $s$ 的函数。",
            "answer": "$$\n\\boxed{\\frac{(Nq + Ms)^{2}}{(N+M)(Nq^{2} + Ms^{2})}}\n$$"
        },
        {
            "introduction": "时间片 $q$ 的选择本质上是一种权衡。过小的时间片会因频繁的任务碎片化而增加系统开销，而过大的时间片则会损害系统的响应能力。这个综合性练习  将让你置身于操作系统设计者的角色，通过建立一个数学模型来平衡碎片化引起的额外系统调用成本与交互式任务的响应延迟，从而推导出最优时间片 $q^{\\star}$ 的大小。",
            "id": "3678402",
            "problem": "考虑一个分时操作系统 (OS)，它使用轮询 (Round-Robin, RR) 调度算法来管理 $N$ 个可运行的交互式进程。每个进程在短暂的计算突发和向内核发出输入/输出 (I/O) 请求之间交替执行。为减少内核开销，每个进程会尝试批量处理其 I/O：在没有抢占的情况下，一个典型的长度为 $B$（以 CPU 时间秒为单位）的计算突发以单个批处理系统调用结束，其内核执行时间成本为 $c_{sys}$（以 CPU 时间秒为单位）。然而，如果 RR 的时间片 $q$ 短于 $B$，该计算突发会被分割成多个调度切片，并且为了保持及时输出，进程会在每个片段结束时发出一个系统调用。这种碎片化增加了每次突发的系统调用次数，从而增加了在内核中花费的总系统调用时间。\n\n假设以下理想化条件：\n- 与 $c_{sys}$ 相比，上下文切换开销可以忽略不计。\n- 每个长度为 $B$ 的未分片计算突发以一个成本为 $c_{sys}$ 的系统调用结束；如果计算突发被 RR 抢占而分片，则系统调用的数量等于分片的数量。\n- 对于 $q \\leq B$，用 $B/q$ 来近似 $\\lceil B/q \\rceil$ 以获得一个可微的成本模型；在对 $q$ 进行最小化时，与 $q$ 无关的加性常数可以舍去。\n- 给定进程的交互式事件的到达与调度无关，且在 RR 周期内均匀分布。如果事件在进程运行时到达，它可以被立即处理；否则它必须等到该进程的下一个调度切片。\n\n仅使用 RR 的标准定义和均匀到达假设，推导时间片 $q$ 的表达式，以最小化以下复合目标：\n- 在 $q \\leq B$ 时，由分片引起的每单位 CPU 时间的预期额外系统调用时间，以及\n- 一个交互式事件的加权预期启动延迟，权重为 $w$（单位为成本/秒），该权重将预期延迟（秒）转换为与系统调用时间相同的成本单位。\n\n将您的最终答案表示为关于 $N$、$c_{sys}$ 和 $w$ 的单一闭式解析表达式 $q^{\\star}$。无需进行数值计算，也无需四舍五入。最终答案中不要注明单位。",
            "solution": "我们从轮询 (RR) 的核心定义和均匀到达假设开始。在有 $N$ 个可运行进程且开销可忽略不计的 RR 调度中，调度程序循环遍历这些进程，为每个进程分配最多 $q$ 秒的 CPU 时间。一个完整周期的长度是 $N q$ 秒。\n\n首先，我们对分片引起的系统调用成本进行建模。在未分片的情况下，一个长度为 $B$ 的计算突发以一个成本为 $c_{sys}$ 的系统调用结束。如果时间片 $q \\leq B$，那么该突发被分割成大约 $B/q$ 个片段（为保证可微性，用 $B/q$ 替代 $\\lceil B/q \\rceil$），并且在每个片段结束时都会发出一个系统调用。因此，每次突发的系统调用总数约为 $B/q$，每次突发的总系统调用时间约为 $(B/q) c_{sys}$。与未分片的单次调用成本 $c_{sys}$ 相比，由分片引起的每次突发的额外系统调用时间为\n$$\n\\left(\\frac{B}{q} - 1\\right) c_{sys}.\n$$\n为了获得每单位 CPU 时间的成本，我们将其除以突发长度 $B$：\n$$\n\\frac{1}{B} \\left(\\frac{B}{q} - 1\\right) c_{sys} \\;=\\; \\frac{c_{sys}}{q} \\;-\\; \\frac{c_{sys}}{B}.\n$$\n在对 $q$ 进行最小化时，常数项 $-c_{sys}/B$ 不影响最优的 $q$ 值，所以我们将其舍去。因此，由分片引起的每单位 CPU 时间的系统调用成本具有以下形式\n$$\nJ_{\\text{sys}}(q) \\;=\\; \\frac{c_{sys}}{q}.\n$$\n\n其次，我们对均匀到达条件下 RR 调度的预期交互启动延迟进行建模。考虑一个固定的进程。在一个长度为 $N q$ 的 RR 周期内，它自己的时间片占用 $q$ 秒，其他 $N-1$ 个进程占用 $(N-1) q$ 秒。假设该进程的一个交互式事件在周期内均匀到达。如果事件在该进程自己的时间片内到达，它可以被立即处理，所以延迟为 $0$。如果事件在其他 $N-1$ 个时间片中的一个到达，该进程必须等到它的下一个调度切片。以事件在另一个进程的时间片内到达为条件，当前时间片中的预期剩余时间是 $q/2$（根据区间内的均匀性），而在目标进程的下一个切片之前，完整的中间时间片的预期数量在 $\\{0,1,\\dots,N-2\\}$ 上均匀分布，其均值为 $(N-2)/2$。因此，条件预期等待时间是\n$$\n\\frac{q}{2} \\;+\\; \\frac{N-2}{2}\\, q \\;=\\; \\frac{N-1}{2}\\, q.\n$$\n事件在另一个进程的时间片内到达的概率是 $(N-1)/N$，而在该进程自己的时间片内到达的概率是 $1/N$。因此，无条件的预期启动延迟是\n$$\n\\mathbb{E}[T(q)] \\;=\\; \\frac{N-1}{N} \\cdot \\frac{N-1}{2}\\, q \\;=\\; \\frac{(N-1)^{2}}{2N}\\, q.\n$$\n我们使用权重 $w$（单位为成本/秒）将此预期延迟转换为与系统调用时间相同的成本单位。延迟成本为\n$$\nJ_{\\text{lat}}(q) \\;=\\; w \\cdot \\mathbb{E}[T(q)] \\;=\\; w \\cdot \\frac{(N-1)^{2}}{2N}\\, q.\n$$\n\n作为 $q$ 的函数需要最小化的总目标是以下各项之和\n$$\nJ(q) \\;=\\; J_{\\text{sys}}(q) \\;+\\; J_{\\text{lat}}(q) \\;=\\; \\frac{c_{sys}}{q} \\;+\\; w \\cdot \\frac{(N-1)^{2}}{2N}\\, q.\n$$\n当 $q>0$ 时，该函数是严格凸函数，因为它是关于 $q$ 的凸项（$\\propto q$）和关于 $1/q$ 的凸项（$\\propto 1/q$）的和。唯一的最小值点 $q^{\\star}$ 满足一阶最优性条件 $J'(q^{\\star})=0$。\n\n计算导数：\n$$\nJ'(q) \\;=\\; -\\, \\frac{c_{sys}}{q^{2}} \\;+\\; w \\cdot \\frac{(N-1)^{2}}{2N}.\n$$\n令 $J'(q)=0$ 并求解 $q$：\n$$\n-\\, \\frac{c_{sys}}{q^{2}} \\;+\\; w \\cdot \\frac{(N-1)^{2}}{2N} \\;=\\; 0\n\\;\\;\\Longrightarrow\\;\\;\n\\frac{c_{sys}}{q^{2}} \\;=\\; w \\cdot \\frac{(N-1)^{2}}{2N}\n\\;\\;\\Longrightarrow\\;\\;\nq^{2} \\;=\\; \\frac{2N\\, c_{sys}}{w\\, (N-1)^{2}}.\n$$\n取正平方根（因为 $q>0$），最优时间片为\n$$\nq^{\\star} \\;=\\; \\sqrt{\\frac{2N\\, c_{sys}}{w\\, (N-1)^{2}}}.\n$$\n\n在所述的 RR 和均匀到达假设下，这个 $q^{\\star}$ 值在“当 $q$ 较小时由分片导致的系统调用时间随 $1/q$ 增长”与“当 $q$ 较大时预期交互启动延迟随 $q$ 线性增长”之间取得了平衡。",
            "answer": "$$\\boxed{\\sqrt{\\frac{2 N\\, c_{sys}}{w\\, (N-1)^{2}}}}$$"
        }
    ]
}