{
    "hands_on_practices": [
        {
            "introduction": "要真正掌握有效内存访问时间（EMAT）的计算，最好的方法是从一个理想化的场景开始。这个练习将引导我们分析一个具有完美空间局部性的程序，其中所有内存访问都命中同一页面。这使我们能够计算在转译后备缓冲器（TLB）命中率接近100%的最佳情况下的EMAT，从而为性能评估建立一个基准。通过这个实践，我们可以清晰地分离出当TLB发挥最大效率时，构成一次内存访问的基本时间成本。",
            "id": "3638183",
            "problem": "一个系统使用带有转换后备缓冲器（TLB）的分页虚拟内存。TLB 存储最近的虚拟到物理页转换，并在从主存取数据之前进行查询。考虑一个程序，在短暂的预热后，执行许多连续的内存引用，这些引用都落在单个虚拟页内。因此，在第一次成功转换后，后续访问的 TLB 命中率 $h$ 满足 $h \\approx 1$。TLB 查找时间为 $t_{T} = 0.90 \\text{ ns}$，主存访问延迟为 $t_{m} = 72 \\text{ ns}$。\n\n从延迟以 TLB 命中与未命中为条件的期望值的基本原理出发，推导在这种边缘情况下单次内存引用的主导阶有效内存访问时间。对于此计算，假设硬件在命中时不将 TLB 查找与后续的内存访问重叠（也就是说，内存访问仅在 TLB 产生转换后才开始）。将最终数值答案以纳秒表示，并四舍五入到四位有效数字。在你的推理中，明确阐述重叠假设在这种边缘情况下的作用，不要使用任何捷径公式或预先给出的有效内存访问时间表达式。",
            "solution": "转换后备缓冲器（TLB）提供最近的虚拟到物理页转换，因此对页转换存在于 TLB 中的地址的引用是 TLB 命中，而其他的则是未命中。有效内存访问时间是考虑了地址转换和数据访问过程后，每次内存引用的期望延迟。此推导的基本出发点是基于事件条件的随机变量期望的定义。令随机变量 $X$ 表示单次内存引用的延迟。该引用可以是 TLB 命中（概率为 $h$）或 TLB 未命中（概率为 $1 - h$）。因此，\n$$\n\\mathbb{E}[X] = h \\cdot \\mathbb{E}[X \\mid \\text{hit}] + (1 - h) \\cdot \\mathbb{E}[X \\mid \\text{miss}] \\, .\n$$\n\n在所述的情况下，预热后的所有引用都落在单个虚拟页内。在第一次转换被缓存后，这意味着 $h \\approx 1$，所以 $1 - h \\approx 0$。在主导阶上，涉及未命中的项在期望值中可以忽略不计：\n$$\n\\mathbb{E}[X] \\approx \\mathbb{E}[X \\mid \\text{hit}] \\, .\n$$\n\n我们现在在给定的微架构假设下确定 $\\mathbb{E}[X \\mid \\text{hit}]$。问题明确指出，硬件在命中时不将 TLB 查找与后续的内存访问重叠。这意味着在 TLB 命中时，必须首先查询 TLB 以产生物理地址，然后才能开始主存访问。因此，一次命中的延迟是 TLB 查找时间和主存访问时间之和：\n$$\n\\mathbb{E}[X \\mid \\text{hit}] = t_{T} + t_{m} \\, .\n$$\n\n代入给定的数值，$t_{T} = 0.90 \\text{ ns}, \\quad t_{m} = 72 \\text{ ns}$，所以\n$$\n\\mathbb{E}[X] \\approx t_{T} + t_{m} = 0.90 \\text{ ns} + 72 \\text{ ns} = 72.90 \\text{ ns} \\, .\n$$\n\n四舍五入到四位有效数字并以纳秒表示，结果是 $72.90 \\text{ ns}$。\n\n关于重叠假设的讨论：如果硬件能够在命中时将 TLB 查找与内存访问重叠（例如，通过虚拟索引、物理标记的缓存，允许在 TLB 产生标记的同时进行数据访问），那么命中路径的延迟将主要由主存访问时间决定，我们会有 $\\mathbb{E}[X \\mid \\text{hit}] \\approx t_{m}$ 而不是 $t_{T} + t_{m}$。然而，在当前问题中，明确的非重叠假设意味着 TLB 延迟在命中路径延迟中是累加的，从而得出了上述推导的主导阶结果。由于 $h \\approx 1$，在这种边缘情况下，重叠设计和非重叠设计之间的差异恰好是关键路径上增加的 $t_{T}$。",
            "answer": "$$\\boxed{72.90}$$"
        },
        {
            "introduction": "在建立了最佳情况的基准之后，我们来探讨一个更现实的问题：程序员的编码方式如何直接影响系统性能。这个练习将对比两种遍历大型数组的不同访问模式——顺序访问（步长为1）与大步长访问（步长等于页面大小）。通过计算并比较两种模式下的EMAT，你将亲眼见证内存访问模式对TLB命中率的巨大影响，深刻理解“引用局部性”原则在编写高性能代码中的关键作用。",
            "id": "3638194",
            "problem": "一个系统实现了请求分页虚拟内存，并配备了一个全相联的数据转译后备缓冲器 (DTLB)，使用最近最少使用 (LRU) 替换策略。DTLB 有 $N = 64$ 个条目。页面大小为 $S = 4$ KiB。考虑一个长度为 $L = 128$ MiB 的连续数组，其中包含 64 位整数（每个元素大小为 $B = 8$ 字节）。该数组的所有页面都存在于物理内存中；没有缺页中断。每次内存访问都需要先进行 DTLB 查找，然后才能进行物理访问。一次 DTLB 命中会在 $t_{\\mathrm{mem}} = 60 \\text{ ns}$ 的内存访问时间之前，引入 $t_{\\mathrm{TLB}} = 0.5 \\text{ ns}$ 的额外查找开销。一次 DTLB 未命中，除了 $t_{\\mathrm{TLB}}$ 之外，在执行内存访问之前，还会因为页表遍历和 TLB 重填而引入 $t_{\\mathrm{miss}} = 80 \\text{ ns}$ 的额外转换延迟。假设缓存层次结构不改变这些时间，并且成本如上所述可加性地组合。\n\n请比较在以下两种对同一数组的数据访问模式下，每次访问的有效内存访问时间 ($EMAT$)：\n- 模式 $(a)$：步幅为 $1$，即程序按索引递增的顺序依次读取每个元素，顺序访问元素 $0, 1, 2, \\dots$。\n- 模式 $(b)$：步幅等于页面大小 $S$，即程序按页面递增的顺序，只读取每个页面的第一个元素一次，访问元素索引 $0, \\frac{S}{B}, 2\\frac{S}{B}, \\dots$ 直到数组末尾。\n\n你需要分别计算模式 $(a)$ 和模式 $(b)$ 的 $EMAT$ 值。将你的答案四舍五入到四位有效数字。以纳秒为单位表示每个 $EMAT$。",
            "solution": "该问题是有效的，因为它具有科学依据、问题明确且客观。我们可以进行形式化的求解。\n\n有效内存访问时间 ($EMAT$) 是转译后备缓冲器 (TLB) 命中时间和 TLB 未命中时间的加权平均值。设 $h$ 为 TLB 命中率。TLB 命中后的内存访问时间是 TLB 查找时间 $t_{\\mathrm{TLB}}$ 和内存访问时间 $t_{\\mathrm{mem}}$ 的和。\n$$T_{\\mathrm{hit}} = t_{\\mathrm{TLB}} + t_{\\mathrm{mem}}$$\nTLB 未命中后的内存访问时间是 TLB 查找时间 $t_{\\mathrm{TLB}}$、额外的页表遍历惩罚 $t_{\\mathrm{miss}}$ 和内存访问时间 $t_{\\mathrm{mem}}$ 的和。\n$$T_{\\mathrm{miss}} = t_{\\mathrm{TLB}} + t_{\\mathrm{miss}} + t_{\\mathrm{mem}}$$\n$EMAT$ 的通用公式为：\n$$EMAT = h \\cdot T_{\\mathrm{hit}} + (1-h) \\cdot T_{\\mathrm{miss}}$$\n代入 $T_{\\mathrm{hit}}$ 和 $T_{\\mathrm{miss}}$ 的表达式：\n$$EMAT = h \\cdot (t_{\\mathrm{TLB}} + t_{\\mathrm{mem}}) + (1-h) \\cdot (t_{\\mathrm{TLB}} + t_{\\mathrm{miss}} + t_{\\mathrm{mem}})$$\n该表达式可以通过提取公因式来简化：\n$$EMAT = (h + (1-h)) \\cdot (t_{\\mathrm{TLB}} + t_{\\mathrm{mem}}) + (1-h) \\cdot t_{\\mathrm{miss}}$$\n$$EMAT = t_{\\mathrm{TLB}} + t_{\\mathrm{mem}} + (1-h) \\cdot t_{\\mathrm{miss}}$$\n给定以下值：\n$t_{\\mathrm{TLB}} = 0.5 \\text{ ns}$\n$t_{\\mathrm{mem}} = 60 \\text{ ns}$\n$t_{\\mathrm{miss}} = 80 \\text{ ns}$\n\n首先，我们确定系统参数。\n页面大小为 $S = 4 \\text{ KiB} = 4 \\times 2^{10} \\text{ 字节} = 4096 \\text{ 字节}$。\n元素大小为 $B = 8 \\text{ 字节}$。\n单个页面可以容纳的元素数量为：\n$$N_{\\mathrm{elements\\_per\\_page}} = \\frac{S}{B} = \\frac{4096}{8} = 512$$\n数组的总长度为 $L = 128 \\text{ MiB} = 128 \\times 2^{20} \\text{ 字节}$。\n数组跨越的总页面数为：\n$$N_{\\mathrm{pages}} = \\frac{L}{S} = \\frac{128 \\times 2^{20}}{4 \\times 2^{10}} = 32 \\times 2^{10} = 32768$$\n数组中的总元素数量为：\n$$N_{\\mathrm{elements}} = \\frac{L}{B} = \\frac{128 \\times 2^{20}}{8} = 16 \\times 2^{20} = 16777216$$\nDTLB 的条目数为 $N = 64$。由于 $N_{\\mathrm{pages}} \\gg N$，DTLB 在任何给定时间只能容纳数组总页面地址转换的一小部分。\n\n现在，我们分析每种访问模式以确定其 TLB 命中率。\n\n模式 (a)：步幅为 $1$（顺序访问）\n在这种模式下，程序按 $0, 1, 2, \\dots$ 的顺序读取数组元素。这些访问表现出很强的空间局部性。\n对任何给定页面的第一次访问（例如，对页面 $0$ 上的元素 $0$ 的访问）将导致一次强制性 TLB 未命中，因为该页面的地址转换尚未在 DTLB 中。这次未命中导致页面地址转换被加载到 DTLB 中。\n对同一页面的后续 $N_{\\mathrm{elements\\_per\\_page}} - 1 = 512 - 1 = 511$ 次访问都将是 TLB 命中，因为此时地址转换已驻留在 DTLB 中。\n当程序移动到下一个页面时，对这个新页面的第一次访问将再次导致 TLB 未命中，如此循环。\n因为数组是顺序遍历的，所以对于对应一个页面的每 $512$ 次访问块，恰好有 $1$ 次未命中和 $511$ 次命中。LRU 替换策略不会对这种模式产生负面影响，因为当一个页面的地址转换被逐出时，它已不再需要。\n模式 (a) 的命中率 $h_a$ 是在任何给定的页面遍历中，命中次数与总访问次数的比率：\n$$h_a = \\frac{\\text{每个页面的命中次数}}{\\text{每个页面的访问次数}} = \\frac{511}{512}$$\n未命中率为 $1 - h_a = \\frac{1}{512}$。\n我们现在可以计算模式 (a) 的 $EMAT$：\n$$EMAT_a = t_{\\mathrm{TLB}} + t_{\\mathrm{mem}} + (1-h_a) \\cdot t_{\\mathrm{miss}}$$\n$$EMAT_a = 0.5 \\text{ ns} + 60 \\text{ ns} + \\left(\\frac{1}{512}\\right) \\cdot 80 \\text{ ns}$$\n$$EMAT_a = 60.5 + 0.15625 = 60.65625 \\text{ ns}$$\n四舍五入到四位有效数字，我们得到 $EMAT_a = 60.66$ ns。\n\n模式 (b)：步幅等于页面大小 $S$\n在这种模式下，程序按页面递增的顺序读取每个页面的第一个元素。被访问元素的索引是 $0, \\frac{S}{B}, 2\\frac{S}{B}, \\dots$。\n由于 $\\frac{S}{B} = 512$，被访问的元素索引是 $0, 512, 1024, \\dots$。\n元素 $0$ 在页面 $0$ 上。元素 $512$ 在页面 $1$ 上。元素 $1024$ 在页面 $2$ 上，依此类推。\n每一次访问都是针对一个新的、不同的页面。\n页面访问的序列是 $0, 1, 2, \\dots, 32767$。\n让我们追踪 DTLB 的行为：\n- 访问页面 $0$：未命中。DTLB 中填入页面 $0$ 的地址转换。\n- 访问页面 $1$：未命中。DTLB 中填入页面 $1$ 的地址转换。\n- ...\n- 访问页面 $63$：未命中。DTLB 现在已满，包含页面 $0$ 到 $63$ 的地址转换。\n- 访问页面 $64$：未命中。由于 DTLB 已满且使用 LRU 替换策略，页面 $0$（最近最少使用的）的条目被逐出，为页面 $64$ 的地址转换腾出空间。\n对于所有后续访问，这种情况都会持续。每次访问都是针对一个其地址转换不在 DTLB 中的页面，因为页面的访问序列远长于 DTLB 的容量，并且没有重用。因此，每次访问都会导致 DTLB 未命中。\n模式 (b) 的命中率 $h_b$ 为 $0$。\n未命中率为 $1 - h_b = 1$。\n我们现在可以计算模式 (b) 的 $EMAT$：\n$$EMAT_b = t_{\\mathrm{TLB}} + t_{\\mathrm{mem}} + (1-h_b) \\cdot t_{\\mathrm{miss}}$$\n$$EMAT_b = 0.5 \\text{ ns} + 60 \\text{ ns} + (1) \\cdot 80 \\text{ ns}$$\n$$EMAT_b = 60.5 + 80 = 140.5 \\text{ ns}$$\n这个值已经是四位有效数字。\n\n最终值为 $EMAT_a = 60.66$ ns 和 $EMAT_b = 140.5$ ns。",
            "answer": "$$\\boxed{\\begin{pmatrix} 60.66  140.5 \\end{pmatrix}}$$"
        },
        {
            "introduction": "这个最后的练习将引导我们探索一种性能上的“最坏情况”，即当特定的内存访问模式与TLB的硬件结构发生冲突时会发生什么。我们将构建一个访问序列，它巧妙地让所有内存访问都映射到TLB的同一个组中，从而由于“冲突未命中”而导致命中率趋近于零。这个实践不仅揭示了TLB颠簸（thrashing）现象的根本原因，也突显了硬件设计中关联度（associativity）的重要性。",
            "id": "3638178",
            "problem": "一个处理器采用虚拟内存，并使用硬件进行地址翻译。它有一个翻译后备缓冲器（TLB），该TLB是组相联的，相联度为 $A$，并采用最近最少使用（LRU）替换策略。考虑一对不相交的虚拟内存区域，由页面 $\\{P_{0},P_{1},\\dots,P_{A}\\}$ 组成，这些页面的选择使得所有 $A+1$ 个页面都映射到同一个TLB组。处理器无限期地重复发出一个循环引用流，按顺序 $P_{0},P_{1},\\dots,P_{A},P_{0},P_{1},\\dots$ 访问每个页面中的一个字。假设以下时序模型和系统属性。\n\n- 一次TLB探测需要 $t_{\\mathrm{TLB}}=0.5 \\text{ ns}$。如果TLB探测命中，处理器则在一级（L1）数据缓存中执行数据访问，这需要 $t_{\\mathrm{L1}}=1.0 \\text{ ns}$。\n- 如果TLB探测未命中，硬件将遍历一个两级页表（$L=2$），每一级都需要一次主存访问，耗时 $t_{\\mathrm{MEM}}=50 \\text{ ns}$。页表遍历是串行执行的（各级之间没有重叠），其条目不被缓存，并且遍历后TLB会被更新。地址翻译完成后，处理器执行L1数据访问，耗时 $t_{\\mathrm{L1}}=1.0 \\text{ ns}$。\n- 没有页面错误（所有页面都驻留在内存中），并且一旦翻译可用，每次数据访问都会在L1缓存中命中。TLB查找必须在L1访问开始之前完成，因此所选路径上的延迟是相加的。\n- 忽略强制性的预热效应，并假设循环流处于稳态行为。\n\n仅使用命中、未命中和互斥情况下的平均时间的定义，分析给定访问模式相对于TLB组的稳态行为，并计算在此模式下每次内存引用的稳态有效内存访问时间（EMAT）。你的最终答案请以纳秒表示，并四舍五入到四位有效数字。",
            "solution": "问题要求计算给定内存引用模式下的稳态有效内存访问时间（EMAT）。EMAT是翻译后备缓冲器（TLB）命中和TLB未命中的访问时间的加权平均值。EMAT的通用公式是：\n$$\n\\text{EMAT} = (h \\times T_{\\mathrm{hit}}) + (m \\times T_{\\mathrm{miss}})\n$$\n其中，$h$ 是TLB命中率，$m$ 是TLB未命中率，$T_{\\mathrm{hit}}$ 是TLB命中时的内存访问时间，$T_{\\mathrm{miss}}$ 是TLB未命中时的内存访问时间。根据定义，每次访问要么是命中，要么是未命中，所以 $h + m = 1$。\n\n首先，我们根据提供的延迟来确定命中和未命中时的访问时间。\n\nTLB命中的时间 $T_{\\mathrm{hit}}$ 包括TLB探测时间以及随后的一级（L1）数据缓存访问时间。题目说明这些时间是相加的。\n$$\nT_{\\mathrm{hit}} = t_{\\mathrm{TLB}} + t_{\\mathrm{L1}}\n$$\n给定值 $t_{\\mathrm{TLB}} = 0.5 \\text{ ns}$ 和 $t_{\\mathrm{L1}} = 1.0 \\text{ ns}$：\n$$\nT_{\\mathrm{hit}} = 0.5 \\text{ ns} + 1.0 \\text{ ns} = 1.5 \\text{ ns}\n$$\n\nTLB未命中的时间 $T_{\\mathrm{miss}}$ 包括初始的TLB探测时间、硬件页表遍历时间以及最终的L1数据缓存访问时间。页表遍历涉及 $L=2$ 级，每一级都需要一次耗时为 $t_{\\mathrm{MEM}}$ 的主存访问。这些访问是串行执行的。\n$$\nT_{\\mathrm{miss}} = t_{\\mathrm{TLB}} + (L \\times t_{\\mathrm{MEM}}) + t_{\\mathrm{L1}}\n$$\n给定值 $t_{\\mathrm{TLB}} = 0.5 \\text{ ns}$, $L = 2$, $t_{\\mathrm{MEM}} = 50 \\text{ ns}$, 和 $t_{\\mathrm{L1}} = 1.0 \\text{ ns}$：\n$$\nT_{\\mathrm{miss}} = 0.5 \\text{ ns} + (2 \\times 50 \\text{ ns}) + 1.0 \\text{ ns} = 0.5 \\text{ ns} + 100 \\text{ ns} + 1.0 \\text{ ns} = 101.5 \\text{ ns}\n$$\n\n接下来，我们必须确定稳态命中率 $h$ 和未命中率 $m$。这取决于具体的访问模式和TLB的组织结构。该系统有一个组相联TLB，相联度为 $A$，并采用最近最少使用（LRU）替换策略。访问模式是在 $A+1$ 个页面 $\\{P_{0}, P_{1}, \\dots, P_{A}\\}$ 上的循环流，所有这些页面都映射到*同一个*TLB组。\n\n我们来分析这一个TLB组的状态。该组有 $A$ 个槽位（或路）来存储页面翻译。访问流由 $A+1$ 个不同页面引用的重复周期组成。因为我们访问的是 $A+1$ 个映射到只能容纳 $A$ 个条目的组的页面，一旦该组已满，每次访问都保证会发生冲突。\n\n考虑系统处于稳态。我们来跟踪序列中对任意页面 $P_i$ 的访问。要使对 $P_i$ 的访问命中，其翻译必须驻留在TLB组中。根据LRU策略，组中的 $A$ 个条目将是最近使用的 $A$ 个页面的翻译。\n\n访问模式是 $P_{0}, P_{1}, \\dots, P_{A}, P_{0}, \\dots$。紧接在引用页面 $P_i$ 之前的一系列访问由 $A$ 个不同的页面 $\\{P_{i-1}, P_{i-2}, \\dots, P_{i-A}\\}$ 组成（索引对 $A+1$ 取模）。例如，在访问 $P_A$ 之前，最后的 $A$ 次访问是针对 $P_{A-1}, P_{A-2}, \\dots, P_0$。在下一个周期访问 $P_0$ 之前，最后的 $A$ 次访问是针对 $P_A, P_{A-1}, \\dots, P_1$。\n\n总的来说，在访问页面 $P_i$ 时，TLB组中的 $A$ 个槽位被最近引用的 $A$ 个页面的翻译所占据，这些页面是 $\\{P_{i-1}, P_{i-2}, \\dots, P_{i-A}\\}$。页面 $P_i$ 本身的翻译不在此组中。因此，对 $P_i$ 的访问将导致TLB未命中。\n\n在这次未命中时，会获取 $P_i$ 的翻译。由于LRU策略，从组中被替换出去的条目将是对应于最近最少使用的页面，即 $P_{i-A}$。然后加载 $P_i$ 的新条目。这个未命中和替换的循环在序列中的每次访问中都会重复。每次页面访问都会替换掉 $A$ 步之后将需要的翻译，从而保证轮到它时它将不存在。这种现象被称为抖动（thrashing）。\n\n因此，在稳态下，此模式中的每一次内存引用都会导致TLB未命中。\n这导致TLB命中率为 $h=0$，未命中率为 $m=1$。\n\n我们现在可以使用这些比率来计算EMAT：\n$$\n\\text{EMAT} = (0 \\times T_{\\mathrm{hit}}) + (1 \\times T_{\\mathrm{miss}})\n$$\n$$\n\\text{EMAT} = T_{\\mathrm{miss}}\n$$\n代入计算出的 $T_{\\mathrm{miss}}$ 值：\n$$\n\\text{EMAT} = 101.5 \\text{ ns}\n$$\n题目要求答案四舍五入到四位有效数字。数值 $101.5$ 已经有四位有效数字。",
            "answer": "$$\\boxed{101.5}$$"
        }
    ]
}