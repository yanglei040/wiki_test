{
    "hands_on_practices": [
        {
            "introduction": "Page coloring is a powerful technique, but its principles are rooted in the simple arithmetic of physical memory addressing. This first exercise provides a foundational workout, guiding you to calculate a page's color directly from system parameters and then reverse the process to find a physical frame that provides a desired color, revealing how an OS controls cache placement.",
            "id": "3666051",
            "problem": "Consider a physically indexed, set-associative Central Processing Unit (CPU) cache used by a system that performs page coloring to control mapping of physical memory pages to cache sets. The system uses a page size of $P=4\\text{KB}$ and a cache line size of $L=64\\text{B}$. The cache has $S=4096$ sets. An application allocates an array that entirely fits within a single page of size $P$, specifically the array size is $A=3072\\text{B}$. The array currently resides in the page whose Page Frame Number (PFN) is $p=12345$.\n\nUsing only the following foundational facts:\n- A physically indexed cache uses $\\log_{2}(S)$ bits of the physical address as a set index, immediately above the $\\log_{2}(L)$ line-offset bits.\n- A page of size $P$ provides $\\log_{2}(P)$ page-offset bits that are fixed for all addresses within the page.\n- Page coloring partitions the set index space into equivalence classes (“colors”) corresponding to the set-index bits that lie above the page offset, so that each distinct value of these bits defines a color. Two pages have the same color if and only if those bits match.\n\nFirst, determine the color of the page with PFN $p$. Then, to optimize the array’s cache placement, re-map the array to a target color $t=13$ by changing its physical allocation to a different page frame number $\\mathrm{PFN}'$ that yields the target color. Among all page frame numbers that yield color $t$, choose the smallest $\\mathrm{PFN}'$ that is greater than or equal to $p$.\n\nProvide the value of $\\mathrm{PFN}'$ as an exact integer. No rounding is required.",
            "solution": "The problem requires us to determine a new Page Frame Number (PFN), which we will denote as $\\mathrm{PFN}'$, for re-mapping an array to achieve a specific cache placement, also known as page coloring. We are given the initial PFN, $p$, and a target color, $t$. The solution must be the smallest $\\mathrm{PFN}'$ such that $\\mathrm{PFN}' \\ge p$ and the page corresponding to $\\mathrm{PFN}'$ has the color $t$.\n\nFirst, we must understand how a physical address is structured and how its bits are used for cache indexing and page coloring.\n\nThe number of bits for the page offset is determined by the page size, $P$.\nGiven $P = 4 \\text{ KB} = 4 \\times 1024 \\text{ B} = 2^2 \\times 2^{10} \\text{ B} = 2^{12} \\text{ B}$.\nThe number of page offset bits is $\\log_2(P) = \\log_2(2^{12}) = 12$. These are the least significant bits of a physical address, from bit $0$ to bit $11$. A physical address, $\\mathrm{PA}$, can be expressed in terms of its PFN and page offset: $\\mathrm{PA} = (\\mathrm{PFN} \\times P) + \\text{offset_in_page} = (\\mathrm{PFN} \\ll 12) | \\text{offset_in_page}$.\n\nThe number of bits for the cache line offset is determined by the cache line size, $L$.\nGiven $L = 64 \\text{ B} = 2^6 \\text{ B}$.\nThe number of line offset bits is $\\log_2(L) = \\log_2(2^6) = 6$. These are bits $0$ to $5$ of the physical address.\n\nThe number of bits for the cache set index is determined by the number of sets, $S$.\nGiven $S = 4096 = 2^{12}$ sets.\nThe number of set index bits is $\\log_2(S) = \\log_2(2^{12}) = 12$. The problem states that these bits are located immediately above the line-offset bits. Therefore, the set index is determined by bits $6$ to $17$ of the physical address.\n\nThe problem defines the page \"color\" based on the set-index bits that lie \"above the page offset\".\nLet's visualize the low-order bits of the physical address:\n- Page offset bits: $\\{0, 1, 2, ..., 11\\}$\n- Set index bits: $\\{6, 7, 8, ..., 17\\}$\n\nThe set-index bits that are \"above the page offset\" are those with bit indices greater than the maximum page offset bit index, which is $11$. These are the bits from $12$ to $17$. The number of these bits is $17 - 12 + 1 = 6$. These $6$ bits constitute the page color.\n\nThe value of these color bits (bits $12$ through $17$ of the physical address) depends on the PFN. For any address within a page frame, the physical address is $\\mathrm{PA} = (\\mathrm{PFN} \\ll 12) | \\text{offset_in_page}$. The bits $12$ and higher of the physical address are determined solely by the PFN. Specifically, bits $[12, 17]$ of the physical address correspond to bits $[12-12, 17-12] = [0, 5]$ of the PFN.\nThus, the color of a page with PFN $p$ is determined by the 6 least significant bits of $p$.\n$$\n\\text{color}(p) = p \\pmod{2^6} = p \\pmod{64}\n$$\n\nThe problem first asks for the color of the page with the initial PFN, $p = 12345$.\n$$\n\\text{color}(12345) = 12345 \\pmod{64}\n$$\nPerforming the division: $12345 = 192 \\times 64 + 57$.\nThe remainder is $57$. So, the color of the initial page is $57$.\n\nNext, we must find the smallest PFN, $\\mathrm{PFN}'$, that satisfies two conditions:\n1. $\\mathrm{PFN}' \\ge p$, which is $\\mathrm{PFN}' \\ge 12345$.\n2. The page has the target color $t = 13$. This means $\\text{color}(\\mathrm{PFN}') = 13$.\n\nFrom the definition of color, the second condition is:\n$$\n\\mathrm{PFN}' \\pmod{64} = 13\n$$\nThis implies that $\\mathrm{PFN}'$ must be of the form $k \\times 64 + 13$, where $k$ is a non-negative integer.\n\nNow we incorporate the first condition:\n$$\nk \\times 64 + 13 \\ge 12345\n$$\nSolving for $k$:\n$$\nk \\times 64 \\ge 12345 - 13\n$$\n$$\nk \\times 64 \\ge 12332\n$$\n$$\nk \\ge \\frac{12332}{64}\n$$\n$$\nk \\ge 192.6875\n$$\nSince $k$ must be an integer, the smallest possible value for $k$ is $\\lceil 192.6875 \\rceil = 193$.\n\nFinally, we substitute this minimal integer value of $k$ back into the expression for $\\mathrm{PFN}'$:\n$$\n\\mathrm{PFN}' = 193 \\times 64 + 13\n$$\n$$\n\\mathrm{PFN}' = 12352 + 13\n$$\n$$\n\\mathrm{PFN}' = 12365\n$$\nThis value, $\\mathrm{PFN}' = 12365$, is greater than or equal to $p=12345$ and corresponds to the target color $13$. It is the smallest such value because we used the smallest possible integer $k$.",
            "answer": "$$\\boxed{12365}$$"
        },
        {
            "introduction": "Now that you understand the mechanics, let's explore a practical application: using page coloring to improve the performance of concurrent applications. In this scenario, you will analyze a workload with a regular memory access pattern and discover how a clever OS can assign colors to create \"private\" cache regions for different threads, effectively eliminating interference between them.",
            "id": "3666068",
            "problem": "A uniprocessor with a physically indexed, physically tagged Last-Level Cache (LLC) is used to run $N$ concurrent threads that each stream through a large array in main memory. The LLC has capacity $512$ KiB, associativity $8$, and cache line size $L=64$ bytes. The number of sets is thus determined by these parameters. The virtual memory page size is $P=4096$ bytes. The Operating System (OS) can apply page coloring, where colors correspond to distinct assignments of physical page frame numbers that alter the cache set index derived from the physical address. Each thread $t \\in \\{0,1,\\dots,N-1\\}$ reads one cache line per access from its private array using a constant stride of $s_{\\text{stride}} = L \\cdot k$ bytes with $k=1024$. Arrays are page-aligned so that the starting virtual address of each array has page offset $0$, and the OS assigns a single physical page color to all pages used by a given thread’s array.\n\nUsing only core definitions of set-indexed caches and page coloring, do the following:\n\n- Derive the predicted steady-state cache set access pattern for a single thread in terms of the cache parameters and the stride.\n- Determine how page color selection changes the initial cache set index for a thread when arrays are page-aligned.\n- Characterize how many threads can have pairwise-disjoint steady-state set footprints when the OS chooses colors adversarially to maximize disjointness.\n\nAssume $N=24$. As a single final answer, report the maximum number of threads whose set footprints can be made pairwise-disjoint under optimal page coloring for this machine and access pattern. Express your final answer as an integer without units. No rounding is required.",
            "solution": "The problem requires an analysis of cache utilization by multiple threads, considering the effects of page coloring by the operating system. We must determine the maximum number of threads that can operate without interfering with each other in the last-level cache (LLC). This requires a systematic analysis of the cache geometry, the physical address to cache set mapping, the nature of page coloring, and the specific memory access pattern of the threads.\n\nFirst, we establish the parameters of the memory hierarchy.\nThe LLC has a capacity of $C = 512 \\text{ KiB} = 512 \\times 1024 \\text{ bytes} = 2^{19}$ bytes.\nThe associativity is $A = 8$.\nThe cache line size is $L = 64 \\text{ bytes} = 2^6$ bytes.\nThe number of sets, $S$, in a set-associative cache is given by the formula $S = \\frac{C}{A \\times L}$.\nSubstituting the given values:\n$$S = \\frac{2^{19} \\text{ bytes}}{(8) \\times (64 \\text{ bytes})} = \\frac{2^{19}}{2^3 \\times 2^6} = \\frac{2^{19}}{2^9} = 2^{10} = 1024$$\nSo, the LLC has $1024$ sets, indexed from $0$ to $1023$.\n\nFor a physically indexed cache, the set index is determined by a portion of the physical address. The physical address is partitioned into a tag, a set index, and a block offset.\nThe number of bits for the block offset is $b = \\log_2(L) = \\log_2(64) = 6$.\nThe number of bits for the set index is $s = \\log_2(S) = \\log_2(1024) = 10$.\nThe set index is determined by bits $[s+b-1 : b]$, which are bits $[15:6]$ of the physical address. The block offset corresponds to bits $[5:0]$.\n\nThe virtual memory system uses a page size of $P = 4096 \\text{ bytes} = 2^{12}$ bytes.\nA physical address, $p_{addr}$, can be expressed in terms of a physical page number ($PPN$) and a page offset: $p_{addr} = PPN \\times P + \\text{page\\_offset}$. The page offset consists of the lowest $p = \\log_2(P) = \\log_2(4096) = 12$ bits of the physical address.\n\nPage coloring works by controlling the bits of the $PPN$ that influence the cache set index.\nThe set index bits are $[15:6]$. The page offset bits are $[11:0]$.\nLet's analyze the overlap. The lower $p-b = 12-6=6$ bits of the set index (i.e., bits $[11:6]$) are part of the page offset. The upper $s-(p-b) = 10 - 6 = 4$ bits of the set index (i.e., bits $[15:12]$) are determined by the $PPN$. These $4$ bits are the \"color\" bits. The number of available colors is thus $N_{\\text{colors}} = 2^4 = 16$.\n\nLet's formalize the relationship between $PPN$, page offset, and the set index. The set index $I$ for a physical address $p_{addr}$ is:\n$$I(p_{addr}) = \\left\\lfloor \\frac{p_{addr}}{L} \\right\\rfloor \\pmod{S}$$\nSubstituting $p_{addr} = PPN \\times P + \\text{page\\_offset}$:\n$$I(p_{addr}) = \\left\\lfloor \\frac{PPN \\times P + \\text{page\\_offset}}{L} \\right\\rfloor \\pmod{S}$$\nSince division distributes over addition for integers, we can write:\n$$I(p_{addr}) = \\left( PPN \\cdot \\frac{P}{L} + \\left\\lfloor \\frac{\\text{page\\_offset}}{L} \\right\\rfloor \\right) \\pmod{S}$$\nWe have $P/L = 4096/64 = 64$ and $S=1024$.\n$$I(p_{addr}) = \\left( PPN \\cdot 64 + \\left\\lfloor \\frac{\\text{page\\_offset}}{64} \\right\\rfloor \\right) \\pmod{1024}$$\nThe term $(PPN \\cdot 64) \\pmod{1024}$ depends on the $PPN$. Since $\\gcd(64, 1024) = 64$, the number of distinct values this term can take is $1024/64 = 16$. These correspond to the $16$ page colors. A color $c \\in \\{0, 1, \\dots, 15\\}$ can be defined as $c = PPN \\pmod{16}$. The set index contribution from the color is $(c \\cdot 64) \\pmod{1024} = c \\cdot 64$.\nSo, $I(p_{addr}) = \\left(c \\cdot 64 + \\left\\lfloor \\frac{\\text{page\\_offset}}{64} \\right\\rfloor \\right) \\pmod{1024}$.\n\nNow we analyze the access pattern of a single thread. Each thread accesses its array with a constant stride of $s_{\\text{stride}} = L \\cdot k = 64 \\cdot 1024 = 65536$ bytes.\nNote that $s_{\\text{stride}} = 2^{16}$ bytes and the page size is $P=2^{12}$ bytes. The stride is $s_{\\text{stride}} = 16 \\times 2^{12} = 16 \\cdot P$.\nThe arrays are page-aligned, so the starting virtual address of each array has a page offset of $0$. Since the stride is an integer multiple of the page size, every subsequent access by a thread will also be to an address with a page offset of $0$.\n\nWith $\\text{page\\_offset}=0$ for all accesses, the set index calculation for a thread simplifies significantly. Let a thread be assigned a single color $c_j$. For every access made by this thread, the target set index $I_j$ will be:\n$$I_j = \\left(c_j \\cdot 64 + \\left\\lfloor \\frac{0}{64} \\right\\rfloor \\right) \\pmod{1024} = c_j \\cdot 64$$\nThis demonstrates that due to the specific stride, a thread with a given color $c_j$ will *only* access the single cache set with index $c_j \\cdot 64$. The steady-state set footprint for such a thread is a singleton set: $\\{c_j \\cdot 64\\}$.\n\nThe final task is to determine the maximum number of threads that can have pairwise-disjoint set footprints. Let two threads, thread $j$ and thread $k$, be assigned colors $c_j$ and $c_k$ respectively. Their set footprints are $\\{c_j \\cdot 64\\}$ and $\\{c_k \\cdot 64\\}$. For these footprints to be disjoint, we must have:\n$$c_j \\cdot 64 \\neq c_k \\cdot 64$$\nThis implies $c_j \\neq c_k$, as $c_j, c_k \\in \\{0, 1, \\dots, 15\\}$.\nTo maximize the number of threads with disjoint footprints, the OS must assign a unique color to each thread. The number of available unique colors is $16$. Therefore, the OS can ensure disjoint set footprints for a maximum of $16$ threads. The problem states there are $N=24$ threads in total, but asks for the maximum number for which disjointness is possible. This number is limited by the resource, which is the number of distinct page colors.\n\nThe maximum number of threads that can have pairwise-disjoint steady-state set footprints is equal to the number of available page colors, which is $16$.",
            "answer": "$$\\boxed{16}$$"
        },
        {
            "introduction": "An operating system rarely manages just one application; it must balance the demands of many processes to optimize overall system performance. This final practice elevates the challenge by asking you to formulate the system-wide color allocation task as an integer linear program, a powerful mathematical tool for finding the best assignment to minimize the total cache miss rate across all processes.",
            "id": "3666023",
            "problem": "Consider a multicore system with a shared Last-Level Cache (LLC). In set-associative caches, physical memory frames map to cache sets via index bits. In page coloring, the operating system partitions physical memory frames into equivalence classes called colors, where frames of the same color map to the same cache index region. Conflict misses arise when many frames used by active processes map to the same color, so careful allocation of frames across colors can reduce the aggregate miss rate. Assume the following well-tested facts and core definitions: cache set mapping by index bits, the concept of colors as equivalence classes of frames, and that each color has a finite capacity of frames available to be assigned. Empirically, for a given workload, the incremental contribution to the miss rate per page of a process placed in a particular color can be approximated by a constant coefficient that depends on the process and the color.\n\nThere are $I=3$ processes and $K=3$ colors. Each process $i \\in \\{1,2,3\\}$ needs $D_i$ physical frames, and each color $k \\in \\{1,2,3\\}$ can supply at most $C_k$ frames. The aggregate miss rate is modeled as the sum over all processes and colors of per-page coefficients. The system parameters are:\n- Demands: $D_1=5$, $D_2=4$, $D_3=3$.\n- Color capacities: $C_1=5$, $C_2=3$, $C_3=4$.\n- Per-page miss coefficients $\\alpha_{i,k}$ (the incremental miss rate per page of process $i$ placed in color $k$), obtained by profiling under steady-state:\n  - For process $1$: $\\alpha_{1,1}=1$, $\\alpha_{1,2}=4$, $\\alpha_{1,3}=5$.\n  - For process $2$: $\\alpha_{2,1}=3$, $\\alpha_{2,2}=1$, $\\alpha_{2,3}=2$.\n  - For process $3$: $\\alpha_{3,1}=4$, $\\alpha_{3,2}=3$, $\\alpha_{3,3}=1$.\n\nStarting from the foundational definitions above, introduce integer decision variables $x_{i,k}$ representing the number of frames of process $i$ assigned to color $k$. Using only these definitions and the given parameters, derive an optimization problem that assigns frames to colors to minimize the total miss rate under the constraints that each process receives exactly its demand and that each color’s capacity is not exceeded. Formulate the problem as an integer linear program with nonnegativity and integrality of $x_{i,k}$ enforced by constraints. Then, solve this optimization exactly for the given instance and report the minimal achievable total miss rate as a single real number. Provide the final number as an exact value (no rounding), with no units.",
            "solution": "The problem is to determine the number of frames of each process $i$ to assign to each color $k$, denoted by the integer decision variables $x_{i,k}$, to minimize the total aggregate miss rate. This can be formulated as an Integer Linear Program (ILP).\n\nFirst, we define the objective function to minimize. The total miss rate, $Z$, is the sum of miss rate contributions from each assignment, where the contribution from assigning $x_{i,k}$ frames of process $i$ to color $k$ is $\\alpha_{i,k} x_{i,k}$. The objective is to minimize the sum over all processes and colors:\n$$ \\text{Minimize } Z = \\sum_{i=1}^{3} \\sum_{k=1}^{3} \\alpha_{i,k} x_{i,k} $$\nThis objective is subject to several constraints. Each process $i$ must receive exactly its demand $D_i$, and each color $k$'s capacity $C_k$ cannot be exceeded. Also, the number of assigned frames must be a non-negative integer.\n\nSubstituting the given values, the problem is:\nMinimize $Z = 1x_{1,1} + 4x_{1,2} + 5x_{1,3} + 3x_{2,1} + 1x_{2,2} + 2x_{2,3} + 4x_{3,1} + 3x_{3,2} + 1x_{3,3}$\nSubject to:\n- Demand constraints:\n  - $x_{1,1} + x_{1,2} + x_{1,3} = 5$\n  - $x_{2,1} + x_{2,2} + x_{2,3} = 4$\n  - $x_{3,1} + x_{3,2} + x_{3,3} = 3$\n- Capacity constraints:\n  - $x_{1,1} + x_{2,1} + x_{3,1} \\le 5$\n  - $x_{1,2} + x_{2,2} + x_{3,2} \\le 3$\n  - $x_{1,3} + x_{2,3} + x_{3,3} \\le 4$\n- Non-negativity and Integrality constraints:\n  - $x_{i,k} \\ge 0$ and $x_{i,k} \\in \\mathbb{Z}$ for $i,k \\in \\{1,2,3\\}$.\n\nSince total demand ($\\sum D_i = 5+4+3=12$) equals total capacity ($\\sum C_k = 5+3+4=12$), the capacity constraints must hold with equality. This formulation is a classic transportation problem. We can solve it by seeking assignments corresponding to the lowest costs $\\alpha_{i,k}$ first, while respecting the constraints (the Least Cost Method).\n\nThe cost matrix $\\boldsymbol{\\alpha}$, demands $D$, and capacities $C$ are:\n$$ \\boldsymbol{\\alpha} = \\begin{pmatrix} 1  4  5 \\\\ 3  1  2 \\\\ 4  3  1 \\end{pmatrix}, \\quad D = \\begin{pmatrix} 5 \\\\ 4 \\\\ 3 \\end{pmatrix}, \\quad C = \\begin{pmatrix} 5  3  4 \\end{pmatrix} $$\n\n1.  The lowest costs in the $\\boldsymbol{\\alpha}$ matrix are $\\alpha_{1,1}=1$, $\\alpha_{2,2}=1$, and $\\alpha_{3,3}=1$. Let's start with the assignment for cell $(1,1)$, which has a cost of 1. The demand for process 1 is $D_1=5$ and the capacity of color 1 is $C_1=5$. We can make the assignment $x_{1,1} = \\min(5, 5) = 5$. This fully satisfies the demand for process 1 and uses the full capacity of color 1. Thus, $x_{1,2}=0$, $x_{1,3}=0$, $x_{2,1}=0$, and $x_{3,1}=0$.\n\n2.  The remaining problem involves processes 2 and 3 and colors 2 and 3, with demands $D_2=4, D_3=3$ and capacities $C_2=3, C_3=4$. The relevant cost submatrix is $\\begin{pmatrix} 1  2 \\\\ 3  1 \\end{pmatrix}$.\n\n3.  The lowest costs in the subproblem are $\\alpha_{2,2}=1$ and $\\alpha_{3,3}=1$. Let's select cell $(2,2)$. The demand for process 2 is $D_2=4$ and capacity of color 2 is $C_2=3$. We assign $x_{2,2} = \\min(4, 3) = 3$. This exhausts the capacity of color 2, so $x_{3,2}=0$.\n\n4.  Process 2 still has a remaining demand of $4 - 3 = 1$. This must be assigned to the only remaining available color for it, color 3. So, we set $x_{2,3}=1$.\n\n5.  Finally, process 3 needs $D_3=3$ frames. The only color with available capacity is color 3. The capacity of color 3 is $C_3=4$, and 1 frame has already been assigned to process 2 ($x_{2,3}=1$). So, $4-1=3$ frames are available. We assign $x_{3,3}=3$. This satisfies the demand for process 3 and exhausts the capacity of color 3.\n\nThe resulting assignment matrix $X$ is:\n$$ X = \\begin{pmatrix} x_{1,1}  x_{1,2}  x_{1,3} \\\\ x_{2,1}  x_{2,2}  x_{2,3} \\\\ x_{3,1}  x_{3,2}  x_{3,3} \\end{pmatrix} = \\begin{pmatrix} 5  0  0 \\\\ 0  3  1 \\\\ 0  0  3 \\end{pmatrix} $$\nThis solution is feasible as it satisfies all demand and capacity constraints. The greedy approach used here yields an optimal solution for this transportation problem.\n\nWe calculate the value of the objective function $Z$ with this optimal assignment:\n$$ Z = (1 \\times x_{1,1}) + (4 \\times x_{1,2}) + (5 \\times x_{1,3}) + (3 \\times x_{2,1}) + (1 \\times x_{2,2}) + (2 \\times x_{2,3}) + (4 \\times x_{3,1}) + (3 \\times x_{3,2}) + (1 \\times x_{3,3}) $$\n$$ Z = (1 \\times 5) + (4 \\times 0) + (5 \\times 0) + (3 \\times 0) + (1 \\times 3) + (2 \\times 1) + (4 \\times 0) + (3 \\times 0) + (1 \\times 3) $$\n$$ Z = 5 + 0 + 0 + 0 + 3 + 2 + 0 + 0 + 3 $$\n$$ Z = 13 $$\n\nThe minimal achievable total miss rate is 13.",
            "answer": "$$ \\boxed{13} $$"
        }
    ]
}