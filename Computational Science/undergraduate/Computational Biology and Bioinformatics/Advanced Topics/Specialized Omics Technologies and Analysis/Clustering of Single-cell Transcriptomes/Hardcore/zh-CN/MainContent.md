## 引言
单细胞转录组测序（[scRNA-seq](@entry_id:155798)）技术的发展为我们以前所未有的分辨率探索生命系统带来了革命。然而，这项技术产生了海量、高维且充满噪声的数据，如何从中系统性地鉴定细胞类型、状态及其功能，成为了计算生物学面临的一大核心挑战。在缺乏先验知识的情况下，我们如何从数以万计细胞的基因表达谱中，发现其内在的生物学结构？

[聚类分析](@entry_id:637205)作为一种强大的[无监督学习](@entry_id:160566)方法，为解决这一问题提供了关键框架。它通过计算细胞间基因表达模式的相似性，将它们自动划分为不同的群体，从而揭示隐藏在复杂数据集背后的[细胞异质性](@entry_id:262569)。这不仅是一个技术步骤，更是将原始分子测量数据转化为生物学见解的桥梁。

本篇文章将系统性地引导你深入[单细胞聚类](@entry_id:171174)分析的全过程，从理论基础到实际应用。在第一章**“原理与机制”**中，我们将详细剖析从原始数据到可靠聚类结果的每一步，包括[数据预处理](@entry_id:197920)、[降维](@entry_id:142982)以及当前最流行的图[聚类算法](@entry_id:146720)。接下来，在第二章**“应用与交叉学科联系”**中，我们将展示[聚类分析](@entry_id:637205)如何驱动生物学发现，例如注释细胞身份、解析发育过程，并探讨其分析[范式](@entry_id:161181)在其他学科中的广泛应用。最后，**“动手实践”**部分将通过具体问题，让你亲手应用和巩固所学知识。通过这一系列学习，你将能够掌握[单细胞聚类](@entry_id:171174)分析的核心思想与关键技术。

## 原理与机制

### 根本目标：从基因表达中识别细胞身份

单细胞[转录组](@entry_id:274025)测序（scRNA-seq）分析的核心任务之一是细胞[聚类](@entry_id:266727)。这一过程的根本科学目标是将数千个细胞基于其基因表达谱的相似性进行分组，从而推断它们的细胞类型或功能状态 。其基本假设是，具有相似生物学功能、发育起源或响应状态的细胞，会表现出相似的基因表达模式。例如，在发育生物学研究中，研究人员可能希望区分胚胎中的外胚层、中胚层和[内胚层](@entry_id:140421)细胞。尽管在解离实验后，这些细胞的原始空间位置信息已经丢失，但它们各自独特的转录程序得以保留。[聚类算法](@entry_id:146720)作为一种**[无监督学习](@entry_id:160566)**方法，能够在没有先验细胞类型标签的情况下，自动地识别出这些内在的、由基因表达定义的细胞群体。因此，聚类不仅是数据分析流程中的一个技术步骤，更是连接高维分子数据与生物学意义（如细胞身份、谱系或功能）的关键桥梁。

### 为[聚类](@entry_id:266727)准备数据：从原始计数到有意义的表达矩阵

原始的scRNA-seq数据本质上是充满噪声且高度稀疏的，并不能直接用于[聚类](@entry_id:266727)。为了准确地识别生物学上有意义的细胞群体，必须经过一系列严格的预处理步骤，其核心思想是滤除噪声、增强生物学信号。

#### 细胞层面的质量控制

分析流程的第一步是识别并移除低质量的细胞数据。在基于微液滴的[scRNA-seq](@entry_id:155798)实验中，并非每个液滴都完美地捕获了一个健康、完整的细胞。有些液滴可能是空的，只包裹了少量漂浮在溶液中的“环境RNA”；而另一些则可能捕获了濒临死亡或已破损的细胞，其RNA含量和转录谱都不能代表健康的生物学状态 。

为了识别这些情况，我们通常会检查几个关键的质量控制（QC）指标。其中一个核心指标是**每个细胞检测到的基因数量**（通常称为 `nFeatures` 或 `nGenes`）。通过绘制所有细胞（或液滴）的 `nFeatures` [分布](@entry_id:182848)[直方图](@entry_id:178776)，我们通常会观察到一个双峰或明显分离的[分布](@entry_id:182848)：一个峰值位于极低的基因数量（例如，少于200个基因），代表了空液滴或质量极差的细胞；另一个更宽的峰则对应于成功捕获的、具有正常RNA含量的真实细胞。因此，一个标准的QC步骤就是设定一个阈值，过滤掉那些 `nFeatures` 极低的细胞。保留这些低质量数据会向后续分析中引入大量噪声，扭曲归一化结果，并可能导致在[聚类](@entry_id:266727)时形成无意义的“死亡细胞”簇，从而干扰对真实生物学结构的探索。

#### 基因层面的质量控制：[特征选择](@entry_id:177971)

并非所有基因都对定义细胞身份同等重要。为了提高信噪比并聚焦于决定细胞类型的关键转录信号，我们需要进行**特征选择**（feature selection）。

首先，一些基因的表达本质上是技术性噪声或与细胞身份无关的生物学过程的反映。例如，**核糖体RNA（rRNA）**基因的转录本在细胞中极其丰富，但它们的表达水平主要反映细胞的翻译活跃度，而非其特定类型。在标准的[scRNA-seq](@entry_id:155798)建库过程中，这些rRNA转录本的存在通常被视为技术残留或污染。如果不加滤除，它们的高表达量会主导数据中的大部分[方差](@entry_id:200758)，可能导致细胞依据技术性而非生物学因素聚类。同样，**线粒体基因**的表达比例也常被用作一个QC指标。一个细胞中线粒体基因转录本的比例异常高，通常是细胞应激、凋亡或质量差的标志。将这些基因包含在用于聚类的特征集中，可能会导致细胞依据其“健康状态”而非生物学身份聚在一起，这是一个主要的混淆因素。因此，一个严谨的分析流程会基于基因的生物学类型（biotype）注释，在[聚类](@entry_id:266727)前从特征集中排除所有rRNA基因和线粒体编码的基因 。通常，用于定义细胞身份的最佳特征是**蛋白质编码基因**和**[长链非编码RNA](@entry_id:180617)（[lncRNA](@entry_id:194588)）**，因为它们是调控细胞特异性功能的关键执行者和调节者。

其次，特征选择的另一个重要策略是识别**高变基因（Highly Variable Genes, HVGs）**。其逻辑是，在不同细胞类型间表达水平恒定的基因（如管家基因）对于区分这些细胞类型没有帮助。相反，那些在细胞群体中表现出高表达变异的基因，更有可能是驱动[细胞异质性](@entry_id:262569)的生物学关键因子。因此，分析通常仅限于在所有细胞中表现出最高表达[方差](@entry_id:200758)的一部分基因（例如，前2000个HVGs）。

选择信息丰富的基因不仅是实践中的[启发式方法](@entry_id:637904)，也具有深刻的理论依据。假设一个数据集包含$k$个待发现的细胞簇，每个簇可以被建模为一个高维[高斯分布](@entry_id:154414)。为了通过线性方法（如PCA）在数据中区分这$k$个簇，它们的[均值向量](@entry_id:266544)（mean vectors）必须位于一个维度至少为$k-1$的仿射[子空间](@entry_id:150286)中。这意味着，我们需要至少$k-1$个“信息丰富”的基因维度来承载区分这$k$个簇所需的信号。如果信息丰富的基因数量少于$k-1$，那么即使总基因数量$p$再大，也无法从根本上提供足够的信息来分离这$k$个簇。反之，增加非信息丰富的基因（即在所有簇中表达水平都相似的基因）只会向系统引入更多噪声，降低整体信噪比，从而可能使聚类变得更加困难 。

### 驾驭高维空间：归一化与[降维](@entry_id:142982)

经过质量控制和[特征选择](@entry_id:177971)后，我们得到一个“干净”的表达矩阵。然而，在进行聚类之前，还需解决两个核心挑战：[scRNA-seq](@entry_id:155798)数据的技术性变异和其固有的高维度特性。

#### 归一化：校正技术性变异

scRNA-seq数据的一个主要技术性混淆因素是**文库大小（library size）**的差异，即每个细胞最终测得的RNA分子总数不同。这种差异很大程度上源于RNA捕获效率、[逆转录](@entry_id:141572)和PCR扩增效率的随机波动，而非真实的生物学差异。如果不加校正，细胞可能会因为其总RNA含量的高低（一个技术伪影）而非其基因表达谱的“形状”被聚类在一起。

为了更清晰地理解这个问题，我们可以考虑一个简化的模型。假设有两个细胞$x_1$和$x_2$，它们属于同一类型，具有完全相同的相对基因表达谱，用向量$b$表示。但由于技术原因，它们的总RNA含量不同，分别由缩放因子$s_1$和$s_2$表示。因此，它们的观测表达向量可以写成$x_1 = s_1 b$和$x_2 = s_2 b$，其中$s_1 \neq s_2$。

此时，如果我们使用**[欧几里得距离](@entry_id:143990)**$d(x_1, x_2) = \|x_1 - x_2\|_2 = |s_1 - s_2| \|b\|_2$来衡量它们的相似性，只要$s_1 \neq s_2$，这个距离就非零，并且会随着文库大小差异的增大而增大。这会导致仅因技术原因而差异的细胞被错误地判定为不相似。

相比之下，**余弦相似度**$c(x_1, x_2) = \frac{x_1 \cdot x_2}{\|x_1\|_2 \|x_2\|_2}$对向量的尺度不敏感。对于上述模型，我们有$c(s_1 b, s_2 b) = \frac{s_1 s_2 (b \cdot b)}{(s_1 \|b\|_2)(s_2 \|b\|_2)} = 1$。这意味着，余弦相似度能够“看穿”文库大小的差异，正确地识别出两个细胞具有相同的表达谱形状。

在实践中，我们通过**归一化**来解决这个问题。最常用的方法是**$\ell_1$归一化**，即“文库大小归一化”。该方法将每个细胞的基因表达计数除以该细胞的总计数，然后乘以一个固定的缩放因子（例如10,000）。经过$\ell_1$归一化后，上述模型中的两个细胞$x_1$和$x_2$会被变换到同一个向量上。此时，无论使用欧几里得距离还是余弦相似度，它们都将被视为完全相同，从而解决了文库大小的混淆问题 。另一种方法是**$\ell_2$归一化**，即将每个细胞的表达向量缩放至单位[欧几里得范数](@entry_id:172687)。经过$\ell_2$归一化后，所有细胞向量都位于一个高维超球面上。在这个超球面上，欧几里得距离和余弦相似度之间存在单调关系（$d(u,v)^2 = 2 - 2c(u,v)$），因此基于二者的[聚类](@entry_id:266727)结果在许多情况下是等价的 。

#### 使用主成分分析（PCA）进行[降维](@entry_id:142982)

即使经过[特征选择](@entry_id:177971)，基因表达矩阵的维度通常仍在数千维。在如此高的维度下，距离的计算变得不可靠（“[维度灾难](@entry_id:143920)”），且数据中包含了大量随机噪声。**[主成分分析](@entry_id:145395)（Principal Component Analysis, PCA）**是解决这一问题的核心工具。PCA是一种线性[降维技术](@entry_id:169164)，它将数据投影到一个新的、由**主成分（PCs）**构成的低维[正交坐标](@entry_id:166074)系中。这些主成分是原始数据中[方差](@entry_id:200758)最大的方向，前几个PC通常能捕获数据中主要的生物学结构，同时滤除后续PC中包含的随机噪声。

在PCA中，一个至关重要的参数是**保留的主成分数量**。选择过少，可能会丢失重要的生物学信号；选择过多，则会重新引入噪声，影响聚类的准确性。一个常用的[启发式方法](@entry_id:637904)是“[肘部法则](@entry_id:636347)”（Elbow plot），即观察每个PC所解释的[方差](@entry_id:200758)（[特征值](@entry_id:154894)）的[碎石图](@entry_id:143396)，并选择曲线斜率开始变缓的“肘部”点。然而，这种方法主观性强，且无法保证被选中的PC捕获的是生物学变异而非技术变异。

一个更严谨、更具统计学原理的方法是利用已知的细胞[协变](@entry_id:634097)量信息来选择PC 。假设我们有一些已知的**技术协变量**（如细胞批次、总RNA计数）和**生物学[协变](@entry_id:634097)量**（如[细胞周期阶段](@entry_id:170415)、已知的刺激条件）。对于每一个PC，我们可以构建两个嵌套的线性模型来解释其在所有细胞中的得分：一个仅包含技术协变量的简化模型，以及一个同时包含技术和生物学[协变](@entry_id:634097)量的完整模型。通过比较这两个模型，我们可以使用**[偏F检验](@entry_id:164189)（partial F-test）**来评估生物学协变量在解释了技术因素之后，是否还对该PC的变异有显著的贡献。这个过程对所有待选的PC重复进行，并对得到的[p值](@entry_id:136498)进行[多重检验校正](@entry_id:167133)（如[Benjamini-Hochberg程序](@entry_id:171997)）。最终，我们选择那些与生物学[协变](@entry_id:634097)量显著相关，而与技术[协变](@entry_id:634097)量无关或相关性已被校正的PC。这种方法确保了用于下游[聚类](@entry_id:266727)的低维空间富含我们感兴趣的生物学信号，而非技术噪声。

### [聚类算法](@entry_id:146720)：从点到社群

在经过[预处理](@entry_id:141204)、归一化和降维后，每个细胞都被表示为一个低维（通常是10-50维）PCA空间中的向量。下一步就是应用[聚类算法](@entry_id:146720)来识别细胞群体。

#### [基于图的聚类](@entry_id:174462)：共享最近邻（SNN）方法

在[scRNA-seq](@entry_id:155798)领域，目前最流行和最成功的[聚类](@entry_id:266727)[范式](@entry_id:161181)是**[基于图的聚类](@entry_id:174462)**。这种方法的核心思想是，在高维空间中直接定义全局的密度和距离可能很困难，但定义细胞的**局部邻域**结构则相对稳健。

该方法的流程如下：
1.  在PCA空间中，为每个细胞找到其**[k-最近邻](@entry_id:636754)（k-Nearest Neighbors, kNN）**。这会构建一个有向的[kNN图](@entry_id:751051)，其中每个细胞都指向它的$k$个最近邻居。
2.  将[kNN图](@entry_id:751051)转化为一个无向的**共享最近邻（Shared Nearest Neighbor, SNN）**图。在这张图中，两个细胞之间的边权重不再仅仅取决于它们是否是彼此的近邻，而是取决于它们**共享的邻居数量**。如果两个细胞共享了许多相同的邻居，它们之间的SNN边权重就高。这种方法通过引入邻域重叠的概念，有效地增强了数据中密度较高区域的连接，同时削弱了不同密度区域之间或稀疏区域中的连接，从而使[聚类](@entry_id:266727)对噪声和密度的局部变化更加鲁棒。
3.  最后，在构建好的SNN图上运行**社群发现算法**（community detection），如[Louvain算法](@entry_id:270022)或[Leiden算法](@entry_id:751237)。这些算法旨在将[图划分](@entry_id:152532)为多个模块或“社群”，使得社群内部的连接远比社群之间的连接来得密集。这些被识别出的社群，就对应着最终的细胞簇。

这一系列流程的成功，建立在几个关键假设之上 ：
*   **[嵌入空间](@entry_id:637157)的保真性**：经过[预处理](@entry_id:141204)和PCA降维后，细胞在低维空间中的欧几里得距离必须能准确反映它们之间的生物学相似性。
*   **充分的[预处理](@entry_id:141204)**：[批次效应](@entry_id:265859)等主要的技术混淆因素必须已被有效移除或校正，否则细胞将按技术因素而非生物学因素[聚类](@entry_id:266727)。
*   **充分的采样密度**：数据必须足够密集，以便能够稳定地定义局部邻域。在稀疏区域，"最近邻"可能在生物学上相距甚远。
*   **SNN的核心机制**：来自同一个真实生物学群体的细胞，其邻居也大多来自该群体，因此它们之间会共享大量邻居，形成高权重的SNN边。这是社群发现算法能够成功划分簇的根本原因。

#### 算法调优：分辨[率参数](@entry_id:265473)

基于图的社群发现算法通常包含一个关键的可调参数——**分辨率（resolution）**。这个参数控制着聚类的粒度。低分辨率倾向于产生更少、更大的簇，而高分辨率则会产生更多、更小的簇。

选择合适的分辨率是一个需要权衡的艺术，它直接影响生物学结论的解读。以免疫学中的[生发中心](@entry_id:202863)（Germinal Center, GC）[B细胞](@entry_id:203517)为例，GC [B细胞](@entry_id:203517)可分为高度增殖的暗区（Dark Zone, DZ）细胞和进行抗原呈递的亮区（Light Zone, LZ）细胞。这两种细胞状态非常接近，但功能不同。

*   如果使用一个**低分辨率**进行[聚类](@entry_id:266727)，DZ和LZ细胞可能会因为其高度的转录相似性而被合并成一个大的“GC [B细胞](@entry_id:203517)”簇。这种**欠聚类（under-clustering）**虽然能正确识别出大的细胞类别，但会掩盖其中重要的功能[异质性](@entry_id:275678)。
*   相反，如果使用一个**高分辨率**，我们可能成功地将DZ和LZ细胞分到两个不同的簇中，从而发现这种精细的生物学差异。然而，高分辨率也带来了**过[聚类](@entry_id:266727)（over-clustering）**的风险。它可能会将一个本应是均质的细胞群体，因为一些随机的基因表达波动或轻微的技术噪声，而被人为地分割成多个没有生物学意义的碎片化小簇，从而使结果的解释变得复杂和混乱 。

因此，在实际分析中，研究者常常需要尝试一系列不同的分辨率，并结合已知的标记基因来评估哪种聚类粒度最能反映数据的真实生物学结构。

### 评估输出：结果是真实的吗？

[聚类分析](@entry_id:637205)的输出是一组细胞簇，但这只是一个计算得出的假设。我们需要进一步评估这个结果的可靠性和生物学意义。

#### 量化数据结构：离散簇还是连续谱？

一个重要的前提是，并非所有生物学系统都由泾渭分明的、离散的细胞簇构成。例如，[细胞分化](@entry_id:273644)或激活过程往往是一个**连续的轨迹**，细胞状态沿着这个轨迹平滑地变化。将这样的连续过程强行划分为离散的簇可能会产生误导。

因此，在解读聚类结果之前，评估数据本身的内在结构是有益的。我们可以设计一个指标来量化数据集的“离散度”。例如，可以定义一个**[离散指数](@entry_id:262869)（Discreteness Index）** 。这个指[数基](@entry_id:634389)于[kNN图](@entry_id:751051)中相连的两个细胞，计算它们的邻域重叠度（如Jaccard指数）。如果数据由紧密、分离的簇构成，那么在同一个簇内相连的细胞会有非常相似的邻居列表，导致高的邻域重叠度。反之，如果数据是连续的，那么邻居会沿着轨迹平滑地变化，任何两个相连细胞的邻域重叠度都会较低。通过计算整个图中所有连接边的平均邻域重叠度，我们得到的[离散指数](@entry_id:262869)就可以作为一个衡量标准：高指数值表明数据具有强烈的离散簇结构，而低指数值则暗示数据更可能是一个连续谱。

#### 评估[聚类](@entry_id:266727)鲁棒性：稳定性评分

即使[数据结构](@entry_id:262134)适合聚类，得到的特定簇划分也可能不稳定，易受数据中随机噪声或[抽样偏差](@entry_id:193615)的影响。评估[聚类](@entry_id:266727)结果**鲁棒性**的一个强大方法是**自助法（Bootstrap）分析**。

其基本思想是，如果一个簇是真实且稳定的，那么即使我们对数据进行轻微的扰动，它也应该能够被重复地识别出来。具体操作如下：我们从原始的$N$个细胞中进行多次有放回的重抽样，每次生成一个与原始数据集大小相同的自助法样本。在每个样本上独立地重新运行整个聚类流程。

然后，我们可以定义一个**稳定性评分**来量化原始（基准）[聚类](@entry_id:266727)结果的可靠性 。对于原始聚类中的每一个簇$B_k$，我们在每次自助法重[聚类](@entry_id:266727)的结果中，寻找与它最匹配的簇（即Jaccard指数最高的那个簇）。这个最高的Jaccard指数就衡量了在这次重抽样中，$B_k$被恢复得有多好。最后，我们将一个基准簇在所有[自助法](@entry_id:139281)样本中得到的“最佳匹配Jaccard指数”进行平均，就得到了该簇的稳定性评分$s_k$。一个接近1的评分意味着这个簇非常稳定，几乎每次都能被准确地重现；而一个低评分则表明这个簇的边界很模糊，可能是一个不稳定的计算产物。通过对所有簇的稳定性评分进行加权平均（按簇的大小加权），我们可以得到一个评估整个[聚类](@entry_id:266727)方案的总体稳定性分数。这个分数是衡量聚类结果可信度的重要客观标准。