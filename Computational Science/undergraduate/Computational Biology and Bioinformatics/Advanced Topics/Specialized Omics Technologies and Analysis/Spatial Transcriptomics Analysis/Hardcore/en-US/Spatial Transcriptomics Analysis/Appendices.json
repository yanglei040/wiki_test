{
    "hands_on_practices": [
        {
            "introduction": "A fundamental first step in any spatial analysis is to determine whether observed patterns are random or structured. This exercise introduces Moran's $I$, a cornerstone statistic for quantifying spatial autocorrelation, which measures the tendency of nearby locations to have similar values. By calculating Moran's $I$ from first principles on a simplified grid, you will build a concrete understanding of how we can mathematically test if a gene's expression pattern is clustered, dispersed, or random across a tissue .",
            "id": "2430178",
            "problem": "In a simplified Spatial Transcriptomics (ST) assay, consider a tissue section measured at $4$ spatial spots labeled $1, 2, 3, 4$ arranged in a $2 \\times 2$ grid. The undirected spatial adjacency is encoded by the symmetric spatial weights matrix $W$ with zero diagonal:\n$$\nW \\;=\\; \\begin{pmatrix}\n0 & 1 & 1 & 0 \\\\\n1 & 0 & 0 & 1 \\\\\n1 & 0 & 0 & 1 \\\\\n0 & 1 & 1 & 0\n\\end{pmatrix}.\n$$\nA gene set consists of two genes $g_1$ and $g_2$. Their normalized expression values at the $4$ spots are given by\n$$\ng_1: \\;(8,\\;7,\\;2,\\;3), \\qquad g_2: \\;(10,\\;9,\\;1,\\;2).\n$$\nDefine the spot-wise gene set expression $x_i$ to be the arithmetic mean of the two gene expressions at spot $i$, that is $x_i = \\frac{1}{2}\\left(g_1(i) + g_2(i)\\right)$. Let $\\bar{x}$ denote the mean of $x_i$ across all spots. Using the conventional definition of Moran’s $I$ for a single variable on a fixed spatial weights matrix without row-standardization,\n$$\nI \\;=\\; \\frac{n}{S_0} \\cdot \\frac{\\sum_{i=1}^{n}\\sum_{j=1}^{n} w_{ij}\\,\\bigl(x_i - \\bar{x}\\bigr)\\bigl(x_j - \\bar{x}\\bigr)}{\\sum_{i=1}^{n} \\bigl(x_i - \\bar{x}\\bigr)^2},\n$$\nwith $n = 4$ and $S_0 = \\sum_{i=1}^{n}\\sum_{j=1}^{n} w_{ij}$, compute the Moran’s $I$ statistic on the gene set average expression. Provide the final Moran’s $I$ as an exact simplified fraction (dimensionless). Do not round your answer.",
            "solution": "The problem statement has been rigorously validated. It is self-contained, scientifically grounded in the field of spatial statistics as applied to bioinformatics, and mathematically well-posed. All necessary data and definitions are provided without ambiguity or contradiction. Therefore, the problem is valid, and we proceed with the a complete, reasoned solution.\n\nThe task is to compute the Moran's $I$ statistic for a given gene set's average expression across $n=4$ spatial spots. The formula for Moran's $I$ is given as:\n$$\nI \\;=\\; \\frac{n}{S_0} \\cdot \\frac{\\sum_{i=1}^{n}\\sum_{j=1}^{n} w_{ij}\\,\\bigl(x_i - \\bar{x}\\bigr)\\bigl(x_j - \\bar{x}\\bigr)}{\\sum_{i=1}^{n} \\bigl(x_i - \\bar{x}\\bigr)^2}\n$$\n\nFirst, we calculate the spot-wise gene set expression, $x_i$, which is the arithmetic mean of the expressions of genes $g_1$ and $g_2$ at each spot $i$. The gene expression values are given as vectors for spots $1, 2, 3, 4$:\n$$\ng_1: \\;(8,\\;7,\\;2,\\;3) \\\\\ng_2: \\;(10,\\;9,\\;1,\\;2)\n$$\nThe spot-wise average expressions $x_i$ are:\n$$\nx_1 = \\frac{1}{2}(g_1(1) + g_2(1)) = \\frac{1}{2}(8 + 10) = 9 \\\\\nx_2 = \\frac{1}{2}(g_1(2) + g_2(2)) = \\frac{1}{2}(7 + 9) = 8 \\\\\nx_3 = \\frac{1}{2}(g_1(3) + g_2(3)) = \\frac{1}{2}(2 + 1) = \\frac{3}{2} \\\\\nx_4 = \\frac{1}{2}(g_1(4) + g_2(4)) = \\frac{1}{2}(3 + 2) = \\frac{5}{2}\n$$\nThe vector of gene set expressions is $X = \\begin{pmatrix} 9 & 8 & \\frac{3}{2} & \\frac{5}{2} \\end{pmatrix}^T$.\n\nNext, we calculate the mean expression $\\bar{x}$ across all $n=4$ spots:\n$$\n\\bar{x} = \\frac{1}{n} \\sum_{i=1}^{n} x_i = \\frac{1}{4} \\left(9 + 8 + \\frac{3}{2} + \\frac{5}{2}\\right) = \\frac{1}{4} \\left(17 + \\frac{8}{2}\\right) = \\frac{1}{4}(17 + 4) = \\frac{21}{4}\n$$\n\nNow, we compute the deviation of each spot's expression from the mean, $z_i = x_i - \\bar{x}$:\n$$\nz_1 = 9 - \\frac{21}{4} = \\frac{36 - 21}{4} = \\frac{15}{4} \\\\\nz_2 = 8 - \\frac{21}{4} = \\frac{32 - 21}{4} = \\frac{11}{4} \\\\\nz_3 = \\frac{3}{2} - \\frac{21}{4} = \\frac{6 - 21}{4} = -\\frac{15}{4} \\\\\nz_4 = \\frac{5}{2} - \\frac{21}{4} = \\frac{10 - 21}{4} = -\\frac{11}{4}\n$$\nLet $Z$ be the column vector of these deviations: $Z = \\begin{pmatrix} \\frac{15}{4} & \\frac{11}{4} & -\\frac{15}{4} & -\\frac{11}{4} \\end{pmatrix}^T$.\n\nWe then compute the denominator of the Moran's $I$ fraction, which is the sum of squared deviations:\n$$\n\\sum_{i=1}^{4} (x_i - \\bar{x})^2 = \\sum_{i=1}^{4} z_i^2 = \\left(\\frac{15}{4}\\right)^2 + \\left(\\frac{11}{4}\\right)^2 + \\left(-\\frac{15}{4}\\right)^2 + \\left(-\\frac{11}{4}\\right)^2 \\\\\n= \\frac{225}{16} + \\frac{121}{16} + \\frac{225}{16} + \\frac{121}{16} = \\frac{2 \\times (225 + 121)}{16} = \\frac{2 \\times 346}{16} = \\frac{346}{8} = \\frac{173}{4}\n$$\n\nNext, we evaluate the terms in the numerator. First, $S_0$ is the sum of all weights in the matrix $W$:\n$$\nW = \\begin{pmatrix}\n0 & 1 & 1 & 0 \\\\\n1 & 0 & 0 & 1 \\\\\n1 & 0 & 0 & 1 \\\\\n0 & 1 & 1 & 0\n\\end{pmatrix}\n$$\n$$\nS_0 = \\sum_{i=1}^{4}\\sum_{j=1}^{4} w_{ij} = 1+1+1+1+1+1+1+1 = 8\n$$\nThe quadratic form in the numerator can be expressed in matrix notation as $Z^T W Z$:\n$$\n\\sum_{i=1}^{4}\\sum_{j=1}^{4} w_{ij}\\,(x_i - \\bar{x})(x_j - \\bar{x}) = Z^T W Z\n$$\nWe first compute the product $W Z$:\n$$\nW Z = \\begin{pmatrix}\n0 & 1 & 1 & 0 \\\\\n1 & 0 & 0 & 1 \\\\\n1 & 0 & 0 & 1 \\\\\n0 & 1 & 1 & 0\n\\end{pmatrix}\n\\begin{pmatrix}\n15/4 \\\\\n11/4 \\\\\n-15/4 \\\\\n-11/4\n\\end{pmatrix} =\n\\begin{pmatrix}\n(1)(\\frac{11}{4}) + (1)(-\\frac{15}{4}) \\\\\n(1)(\\frac{15}{4}) + (1)(-\\frac{11}{4}) \\\\\n(1)(\\frac{15}{4}) + (1)(-\\frac{11}{4}) \\\\\n(1)(\\frac{11}{4}) + (1)(-\\frac{15}{4})\n\\end{pmatrix} =\n\\begin{pmatrix}\n-4/4 \\\\\n4/4 \\\\\n4/4 \\\\\n-4/4\n\\end{pmatrix} =\n\\begin{pmatrix}\n-1 \\\\\n1 \\\\\n1 \\\\\n-1\n\\end{pmatrix}\n$$\nNow we compute the final quadratic form:\n$$\nZ^T W Z = \\begin{pmatrix} \\frac{15}{4} & \\frac{11}{4} & -\\frac{15}{4} & -\\frac{11}{4} \\end{pmatrix}\n\\begin{pmatrix}\n-1 \\\\\n1 \\\\\n1 \\\\\n-1\n\\end{pmatrix} \\\\\n= \\left(\\frac{15}{4}\\right)(-1) + \\left(\\frac{11}{4}\\right)(1) + \\left(-\\frac{15}{4}\\right)(1) + \\left(-\\frac{11}{4}\\right)(-1) \\\\\n= -\\frac{15}{4} + \\frac{11}{4} - \\frac{15}{4} + \\frac{11}{4} = \\frac{-15+11-15+11}{4} = \\frac{-8}{4} = -2\n$$\n\nFinally, we substitute all computed values into the Moran's $I$ formula:\n$$\nI = \\frac{n}{S_0} \\cdot \\frac{Z^T W Z}{\\sum z_i^2} = \\frac{4}{8} \\cdot \\frac{-2}{173/4} = \\frac{1}{2} \\cdot \\frac{-2 \\times 4}{173} = \\frac{1}{2} \\cdot \\frac{-8}{173} = -\\frac{4}{173}\n$$\nThe result is an exact, simplified fraction as required. The negative value indicates negative spatial autocorrelation for the given gene set expression, meaning that adjacent spots tend to have dissimilar expression values.",
            "answer": "$$\n\\boxed{-\\frac{4}{173}}\n$$"
        },
        {
            "introduction": "Before we can analyze spatial relationships, we must first define them by constructing a neighborhood graph that connects cells. This choice of method is not trivial and can profoundly influence downstream biological conclusions. This exercise challenges you to critically evaluate two common approaches—fixed-radius versus $k$-nearest neighbors—and analyze how they behave in tissues with varying cell densities, revealing potential artifacts that can either obscure or create spurious patterns .",
            "id": "2430183",
            "problem": "A spatial transcriptomics assay yields single-cell positions across a tissue section that is partitioned into $2$ large regions separated by a straight interface: region $\\mathrm{A}$ (dense) and region $\\mathrm{B}$ (sparse). Assume cell centers in each region follow an independent homogeneous Poisson point process with intensities $\\lambda_{\\mathrm{A}}=0.02\\,\\mathrm{cells}/\\mu\\mathrm{m}^{2}$ and $\\lambda_{\\mathrm{B}}=0.005\\,\\mathrm{cells}/\\mu\\mathrm{m}^{2}$, respectively, with no clustering beyond Poisson randomness. Consider constructing a cell–cell neighborhood graph using either:\n- a radius graph $G_{r}$ that connects two cells if their Euclidean distance is at most $r=10\\,\\mu\\mathrm{m}$, producing an undirected simple graph, or\n- a symmetric $k$-nearest neighbors graph $G_{k}$ with $k=6$, defined by connecting two cells $i$ and $j$ with an undirected edge if $i$ is among the $k$ nearest neighbors of $j$ or $j$ is among the $k$ nearest neighbors of $i$.\n\nSuppose a downstream niche analysis uses unnormalized neighbor-sum scores of a binary marker: for each cell $i$, $S_{i}=\\sum_{j\\in \\mathcal{N}(i)} \\mathbf{1}\\{\\text{neighbor } j \\text{ expresses the marker}\\}$, where $\\mathcal{N}(i)$ is the graph neighborhood of $i$ in the constructed graph and the marker is expressed independently in each cell with spatially constant prevalence $p \\in (0,1)$, independent of positions.\n\nIgnoring finite-size boundary effects away from the $\\mathrm{A}$–$\\mathrm{B}$ interface except for edges that may cross the interface, and assuming the observation window is sufficiently large that interior behavior dominates, which of the following statements about the effect of the neighborhood graph construction on downstream niche analysis are correct?\n\nA. In $G_{r}$, the expected degree of a cell in region $\\mathrm{A}$ is approximately $4$ times that in region $\\mathrm{B}$, which inflates unnormalized neighbor-sum niche scores in region $\\mathrm{A}$ relative to region $\\mathrm{B}$ even when marker prevalence $p$ is spatially constant.\n\nB. In $G_{k}$ with $k=6$, the expected undirected degree is exactly $6$ everywhere, ensuring identical metric neighborhood radii across regions and preventing cross-boundary neighbor mixing near the interface.\n\nC. In $G_{k}$ with $k=6$, the typical distance to neighbors is larger in region $\\mathrm{B}$ than in region $\\mathrm{A}$, increasing the chance that neighbors for cells near the interface in region $\\mathrm{B}$ lie across the interface in region $\\mathrm{A}$, which can blur niche contrasts near the boundary.\n\nD. In $G_{r}$ with $r=10\\,\\mu\\mathrm{m}$, a nontrivial fraction of cells in region $\\mathrm{B}$ will be isolated (degree $0$), making graph fragmentation in the sparse region likely and potentially biasing community detection by splitting sparse-region niches.\n\nE. Both $G_{r}$ and $G_{k}$ yield identical expected degree ratios between regions $\\mathrm{A}$ and $\\mathrm{B}$, so any observed difference in niche scores $S_{i}$ between regions must arise solely from gene expression and not from graph construction.",
            "solution": "The problem statement must first be validated for scientific and logical integrity.\n\n**Step 1: Extract Givens**\n- Cell distribution: Independent homogeneous Poisson point processes (HPP).\n- Region A intensity: $\\lambda_{\\mathrm{A}} = 0.02 \\, \\mathrm{cells}/\\mu\\mathrm{m}^2$.\n- Region B intensity: $\\lambda_{\\mathrm{B}} = 0.005 \\, \\mathrm{cells}/\\mu\\mathrm{m}^2$.\n- Graph $1$ ($G_r$): Radius graph with $r = 10 \\, \\mu\\mathrm{m}$. An edge exists if Euclidean distance $\\le r$.\n- Graph $2$ ($G_k$): Symmetric $k$-nearest neighbors graph with $k=6$. An edge exists between cells $i$ and $j$ if $i$ is a $k$-NN of $j$ or $j$ is a $k$-NN of $i$.\n- Niche score: $S_{i}=\\sum_{j\\in \\mathcal{N}(i)} \\mathbf{1}\\{\\text{neighbor } j \\text{ expresses the marker}\\}$.\n- Marker expression: Independent and identically distributed Bernoulli trials with constant probability $p \\in (0, 1)$.\n- Assumptions: Ignore boundary effects away from the A-B interface; large observation window.\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is formulated using standard, well-accepted models in computational biology and spatial statistics. The use of Poisson point processes to model cell locations and the construction of neighborhood graphs via radius or $k$-NN methods are fundamental techniques in spatial transcriptomics analysis. The parameters provided ($\\lambda_{\\mathrm{A}}$, $\\lambda_{\\mathrm{B}}$, $r$, $k$) are physically realistic. The question posed is objective and can be formally analyzed using established mathematical principles of point processes and graph theory. The problem is scientifically grounded, well-posed, and objective. It contains no contradictions, ambiguities, or factual unsoundness.\n\n**Step 3: Verdict and Action**\nThe problem statement is **valid**. Proceeding to solution.\n\nThe analysis will proceed by evaluating each statement based on the provided model. The expected niche score for a cell $i$ is given by $E[S_i] = E[p \\cdot D_i] = p \\cdot E[D_i]$, where $D_i$ is the degree of cell $i$. Thus, the expected score is directly proportional to the expected degree.\n\n**Analysis of Option A**\nThis statement pertains to the radius graph, $G_{r}$. For a homogeneous Poisson point process of intensity $\\lambda$, the expected number of points within a disk of radius $r$ centered on a typical point is $\\lambda \\pi r^2$. This is the expected degree for a cell far from any boundary.\n\n- The radius is $r = 10\\,\\mu\\mathrm{m}$, so the neighborhood area is $A_r = \\pi r^2 = \\pi (10\\,\\mu\\mathrm{m})^2 = 100\\pi\\,\\mu\\mathrm{m}^2$.\n- In region $\\mathrm{A}$, the expected degree $E[D_{\\mathrm{A}}]$ is:\n$$E[D_{\\mathrm{A}}] = \\lambda_{\\mathrm{A}} A_r = (0.02\\,\\mathrm{cells}/\\mu\\mathrm{m}^2) \\cdot (100\\pi\\,\\mu\\mathrm{m}^2) = 2\\pi \\approx 6.28$$\n- In region $\\mathrm{B}$, the expected degree $E[D_{\\mathrm{B}}]$ is:\n$$E[D_{\\mathrm{B}}] = \\lambda_{\\mathrm{B}} A_r = (0.005\\,\\mathrm{cells}/\\mu\\mathrm{m}^2) \\cdot (100\\pi\\,\\mu\\mathrm{m}^2) = 0.5\\pi \\approx 1.57$$\n- The ratio of the expected degrees is:\n$$\\frac{E[D_{\\mathrm{A}}]}{E[D_{\\mathrm{B}}]} = \\frac{2\\pi}{0.5\\pi} = \\frac{\\lambda_{\\mathrm{A}}}{\\lambda_{\\mathrm{B}}} = \\frac{0.02}{0.005} = 4$$\nThe expected degree in region $\\mathrm{A}$ is indeed $4$ times that in region $\\mathrm{B}$. Since $E[S_i] \\propto E[D_i]$ and the marker prevalence $p$ is constant, the expected niche scores will also be in a $4:1$ ratio. This disparity is a direct artifact of using a fixed-radius graph on regions of different densities, which inflates scores in the denser region. The statement is **Correct**.\n\n**Analysis of Option B**\nThis statement pertains to the symmetric $k$-NN graph, $G_k$.\n\n1.  \"the expected undirected degree is exactly $6$ everywhere\": The graph is symmetric, meaning an edge $(i, j)$ exists if $j$ is a $k$-NN of $i$ or $i$ is a $k$-NN of $j$. The degree of a node $i$ is $|\\{j | j \\in \\text{NN}_k(i)\\}| + |\\{j | i \\in \\text{NN}_k(j) \\text{ and } j \\notin \\text{NN}_k(i)\\}|$. While the first term is $k=6$, the second term (the number of reverse-neighbors that are not forward-neighbors) is a random variable. The degree of a node is not fixed at $k$, and neither is its expectation necessarily exactly $k$. For a symmetric graph, the expected degree is typically greater than $k$. The claim of it being *exactly* $6$ is incorrect.\n\n2.  \"ensuring identical metric neighborhood radii across regions\": The $k$-NN method defines neighborhoods by rank (number of neighbors), not by a fixed metric radius. The physical distance to the $k$-th neighbor is adaptive to the local density. In the dense region $\\mathrm{A}$, the distance to the $6$-th neighbor will be small. In the sparse region $\\mathrm{B}$, this distance will be large. The metric radii are fundamentally different, not identical.\n\n3.  \"preventing cross-boundary neighbor mixing\": This follows from the previous point. Because a cell in the sparse region $\\mathrm{B}$ near the interface must search a larger radius to find its $k=6$ neighbors, it is *more* likely, not less, to find neighbors across the boundary in the dense region $\\mathrm{A}$. The method does not prevent mixing; it can induce asymmetric mixing.\n\nAll parts of this statement are factually wrong. The statement is **Incorrect**.\n\n**Analysis of Option C**\nThis statement also pertains to $G_k$.\n\n1.  \"the typical distance to neighbors is larger in region $\\mathrm{B}$ than in region $\\mathrm{A}$\": As explained for option B, to find a fixed number of neighbors $k=6$, one must survey a larger area (and thus a larger distance) in a sparse region than in a dense region. So, $R_{\\text{search}, \\mathrm{B}} > R_{\\text{search}, \\mathrm{A}}$. This is correct.\n\n2.  \"increasing the chance that neighbors for cells near the interface in region $\\mathrm{B}$ lie across the interface in region $\\mathrm{A}$\": A cell in region $\\mathrm{B}$ near the interface has a large search radius. This radius can easily extend into region $\\mathrm{A}$. Since region $\\mathrm{A}$ is $4$ times denser, it is highly probable that some, if not all, of the $6$ nearest neighbors for this cell will be found in region $\\mathrm{A}$. This is correct.\n\n3.  \"which can blur niche contrasts near the boundary\": A niche is defined by the local neighborhood. If a cell from region $\\mathrm{B}$ has its neighborhood composed of cells from region $\\mathrm{A}$, its computed niche characteristics will reflect region $\\mathrm{A}$, not its native region $\\mathrm{B}$. This artifact of graph construction mixes the signals from the two regions at the boundary, an effect correctly described as \"blurring niche contrasts\". This is correct.\n\nThe entire logical chain of the statement is sound. The statement is **Correct**.\n\n**Analysis of Option D**\nThis statement returns to the radius graph, $G_r$.\n\n1.  \"a nontrivial fraction of cells in region $\\mathrm{B}$ will be isolated (degree $0$)\": A cell is isolated if there are no other cells within the disk of radius $r = 10\\,\\mu\\mathrm{m}$. For an HPP, the number of neighbors $N$ in this disk follows a Poisson distribution with mean $\\mu = \\lambda \\pi r^2$. The probability of being isolated is $P(N=0) = e^{-\\mu}$.\n    - For region $\\mathrm{B}$, $\\lambda_{\\mathrm{B}} = 0.005\\,\\mathrm{cells}/\\mu\\mathrm{m}^2$.\n    - The mean number of neighbors is $\\mu_{\\mathrm{B}} = \\lambda_{\\mathrm{B}} \\pi r^2 = 0.005 \\cdot \\pi \\cdot 10^2 = 0.5\\pi \\approx 1.5708$.\n    - The probability of a cell in region $\\mathrm{B}$ being isolated is:\n    $$P(D_{\\mathrm{B}}=0) = e^{-\\mu_{\\mathrm{B}}} = e^{-0.5\\pi} \\approx 0.2078$$\n    A probability of $\\approx 21\\%$ represents a substantial fraction of the cells. This is a \"nontrivial fraction\". This is correct.\n\n2.  \"making graph fragmentation in the sparse region likely\": If over one-fifth of the nodes have degree $0$, the graph is by definition fragmented. The remaining nodes may form other small, disconnected components. This is correct.\n\n3.  \"potentially biasing community detection by splitting sparse-region niches\": Community detection algorithms rely on graph connectivity to group nodes. In a highly fragmented graph, a single, spatially contiguous biological niche will be artificially broken into many disparate communities (many of which would be singletons). This would prevent the algorithm from identifying the true, larger-scale structure of the niche, thus biasing the analysis. This is a correct and direct consequence.\n\nThe statement provides a correct quantitative assessment and a correct interpretation of its downstream effects. The statement is **Correct**.\n\n**Analysis of Option E**\nThis statement compares the two graph construction methods.\n\n1.  \"Both $G_{r}$ and $G_{k}$ yield identical expected degree ratios between regions $\\mathrm{A}$ and $\\mathrm{B}$\":\n    - For $G_r$, we found the ratio of expected degrees is $\\frac{E[D_{\\mathrm{A}}]}{E[D_{\\mathrm{B}}]} = 4$.\n    - For $G_k$, the construction adapts to density. In a large homogeneous region, the expected degree of a symmetric $k$-NN graph is approximately constant, independent of the density $\\lambda$. Therefore, the ratio of expected degrees $\\frac{E[D_{\\mathrm{A}}]}{E[D_{\\mathrm{B}}]}$ is approximately $1$.\n    - Since $4 \\neq 1$, the assertion that the ratios are identical is false.\n\n2.  \"so any observed difference in niche scores...must arise solely from gene expression...\": This conclusion depends on the false premise above. As the choice of graph itself induces profound differences in degree distribution between the regions (especially for $G_r$), it is a major confounding factor in the analysis of niche scores. The statement is fundamentally flawed.\n\nThe statement is **Incorrect**.\n\n**Conclusion**\nStatements A, C, and D accurately describe the consequences and artifacts of the respective graph construction methods in a spatially heterogeneous context. Statements B and E are based on incorrect characterizations of these methods.",
            "answer": "$$\\boxed{ACD}$$"
        },
        {
            "introduction": "With a method for defining cellular neighborhoods, we can begin to ask sophisticated biological questions about how a cell's function relates to its microenvironment. This practice applies the concept of $k$-nearest neighbors to a common and powerful analysis: identifying genes that are differentially expressed in cells at the \"boundary\" of a tissue region versus those in the \"interior\". Implementing this workflow will give you hands-on experience in a complete analysis that integrates spatial location with gene expression to uncover genes mediating tissue structure and cell-cell communication .",
            "id": "2430130",
            "problem": "Given a set of spatially resolved messenger ribonucleic acid (mRNA) expression measurements and two-dimensional (2D) coordinates for individual cells, consider a fixed target cell type labeled by an integer $t^\\star$. Let $X \\in \\mathbb{R}^{n \\times g}$ denote the nonnegative expression matrix with $n$ rows (cells) and $g$ columns (genes), where entry $x_{ij}$ is the expression of gene $j$ in cell $i$. Let $C \\in \\mathbb{R}^{n \\times 2}$ denote the coordinate matrix, where the $i$-th row gives the 2D location of cell $i$. Let $T \\in \\{0,1,2,\\dots\\}^n$ be the vector of integer cell-type labels. All indices are zero-based; genes are indexed by $j \\in \\{0,1,\\dots,g-1\\}$ and cells by $i \\in \\{0,1,\\dots,n-1\\}$.\n\nDefine the $k$-nearest neighbors (KNN) of a cell $i$ to be the set of exactly $k$ distinct indices of other cells that minimize the Euclidean distance in $C$ to cell $i$. The Euclidean distance between cells $i$ and $i'$ is\n$$\nd(i,i') = \\sqrt{(C_{i,0} - C_{i',0})^2 + (C_{i,1} - C_{i',1})^2}.\n$$\nIf there is a tie at the $k$-th smallest distance, break ties deterministically by sorting candidate neighbors by the pair $(d(i,i'), i')$ in ascending lexicographic order (distance first, then index), and then taking the first $k$ indices. For a fixed $t^\\star$, a cell $i$ with $T_i = t^\\star$ is called a boundary cell if at least one of its $k$-nearest neighbors has a label different from $t^\\star$. A cell $i$ with $T_i = t^\\star$ is called an interior cell if all of its $k$-nearest neighbors have label exactly $t^\\star$.\n\nFor each gene $j$, define the boundary set $B = \\{ i \\in \\{0,\\dots,n-1\\} : T_i = t^\\star \\text{ and } i \\text{ is boundary} \\}$ and the interior set $I = \\{ i \\in \\{0,\\dots,n-1\\} : T_i = t^\\star \\text{ and } i \\text{ is interior} \\}$. Let\n$$\n\\mu_B(j) = \\frac{1}{|B|} \\sum_{i \\in B} x_{ij}, \\quad \\mu_I(j) = \\frac{1}{|I|} \\sum_{i \\in I} x_{ij},\n$$\nwhenever $|B| \\ge 1$ and $|I| \\ge 1$. Given a threshold $\\tau > 0$, gene $j$ is called differentially expressed (DE) between boundary and interior cells (within the same type $t^\\star$) if and only if $|B| \\ge 1$, $|I| \\ge 1$, and\n$$\n|\\mu_B(j) - \\mu_I(j)| \\ge \\tau.\n$$\nIf either $|B| = 0$ or $|I| = 0$, then no gene is called DE and the output for that test case must be the empty list.\n\nYour task is to implement a program that, for each provided test case, computes the sorted list of gene indices $j$ that satisfy the DE criterion above. The final program output must aggregate the results for all test cases into a single line containing the lists as a comma-separated sequence enclosed in square brackets, for example, $[ [a], [b], [c] ]$ (without spaces in the actual program output).\n\nTest suite (three test cases):\n\nTest case $1$:\n- Parameters: $t^\\star = 0$, $k = 2$, $\\tau = 3$.\n- Coordinates:\n$$\nC = \\begin{bmatrix}\n0 & 0 \\\\\n1 & 0 \\\\\n2 & 0 \\\\\n1 & 1 \\\\\n2 & 1 \\\\\n3 & 0 \\\\\n0 & 1\n\\end{bmatrix}.\n$$\n- Labels:\n$$\nT = \\begin{bmatrix}\n0 \\\\ 0 \\\\ 0 \\\\ 0 \\\\ 1 \\\\ 1 \\\\ 0\n\\end{bmatrix}.\n$$\n- Expression ($n=7$, $g=3$):\n$$\nX = \\begin{bmatrix}\n2 & 5 & 8 \\\\\n2 & 5 & 8 \\\\\n10 & 5 & 1 \\\\\n9 & 5 & 2 \\\\\n3 & 5 & 7 \\\\\n4 & 5 & 6 \\\\\n2 & 5 & 8\n\\end{bmatrix}.\n$$\n\nTest case $2$:\n- Parameters: $t^\\star = 0$, $k = 2$, $\\tau = 3$.\n- Coordinates:\n$$\nC = \\begin{bmatrix}\n0 & 0 \\\\\n0 & 1 \\\\\n0 & 2 \\\\\n10 & 0 \\\\\n10 & 1 \\\\\n10 & 2\n\\end{bmatrix}.\n$$\n- Labels:\n$$\nT = \\begin{bmatrix}\n0 \\\\ 0 \\\\ 0 \\\\ 1 \\\\ 1 \\\\ 1\n\\end{bmatrix}.\n$$\n- Expression ($n=6$, $g=2$):\n$$\nX = \\begin{bmatrix}\n1 & 1 \\\\\n2 & 2 \\\\\n3 & 3 \\\\\n4 & 4 \\\\\n5 & 5 \\\\\n6 & 6\n\\end{bmatrix}.\n$$\n\nTest case $3$:\n- Parameters: $t^\\star = 0$, $k = 1$, $\\tau = 3$.\n- Coordinates:\n$$\nC = \\begin{bmatrix}\n0 & 0 \\\\\n1 & 0 \\\\\n0 & 1 \\\\\n-1 & 0\n\\end{bmatrix}.\n$$\n- Labels:\n$$\nT = \\begin{bmatrix}\n0 \\\\ 1 \\\\ 0 \\\\ 0\n\\end{bmatrix}.\n$$\n- Expression ($n=4$, $g=2$):\n$$\nX = \\begin{bmatrix}\n9 & 3 \\\\\n4 & 4 \\\\\n1 & 3 \\\\\n1 & 3\n\\end{bmatrix}.\n$$\n\nRequired final output format: Your program must produce exactly one line containing the results as a comma-separated sequence of the per-test-case lists enclosed in square brackets, with no spaces; for example, if the three answers are lists $L_1$, $L_2$, and $L_3$, print $[L_1,L_2,L_3]$. Each $L_i$ must be a list of zero-based gene indices in ascending order.",
            "solution": "The problem is assessed to be **valid**. It is scientifically grounded in the field of computational biology, specifically spatial transcriptomics analysis. The definitions provided are mathematically precise and objective, allowing for a unique and verifiable solution. The problem is well-posed, providing all necessary data and constraints, including a deterministic tie-breaking rule for nearest neighbor identification. There are no contradictions, ambiguities, or factual inaccuracies in the problem statement.\n\nThe solution is implemented by following a sequence of well-defined computational steps. For each test case, we are given a set of cell coordinates $C \\in \\mathbb{R}^{n \\times 2}$, an expression matrix $X \\in \\mathbb{R}^{n \\times g}$, a vector of cell-type labels $T \\in \\{0,1,2,\\dots\\}^n$, a target cell type $t^\\star$, a neighbor count $k$, and a differential expression threshold $\\tau > 0$. The objective is to find all genes that are differentially expressed between boundary and interior cells of type $t^\\star$.\n\nThe algorithm proceeds as follows:\n\n1.  **Identification of Target Cells and Nearest Neighbors**:\n    First, we identify the set of indices for cells of the target type $t^\\star$, i.e., $S_{t^\\star} = \\{ i \\mid T_i = t^\\star \\}$. For each cell $i \\in S_{t^\\star}$, we must find its $k$-nearest neighbors (KNN). This process begins with the computation of the Euclidean distance $d(i,i') = \\sqrt{(C_{i,0} - C_{i',0})^2 + (C_{i,1} - C_{i',1})^2}$ from cell $i$ to every other cell $i' \\neq i$. To do this efficiently for all cells, we can pre-compute an $n \\times n$ matrix of pairwise distances. The problem specifies a deterministic tie-breaking rule: if multiple cells are equidistant at the $k$-th position, candidates are sorted lexicographically by the pair $(d(i,i'), i')$, and the first $k$ are chosen. This ensures a unique set of neighbors for each cell. Computationally, this is achieved by performing a lexicographical sort based on the primary key (distance) and the secondary key (cell index).\n\n2.  **Classification of Target Cells**:\n    Once the $k$-nearest neighbors are identified for a cell $i \\in S_{t^\\star}$, we classify it as either a boundary or an interior cell. Let $N_i$ be the set of indices of the $k$-nearest neighbors for cell $i$.\n    -   If all neighbors $i' \\in N_i$ have the same label as cell $i$ (i.e., $T_{i'} = t^\\star$ for all $i' \\in N_i$), then cell $i$ is classified as an **interior** cell.\n    -   If at least one neighbor $i' \\in N_i$ has a different label (i.e., $T_{i'} \\neq t^\\star$), then cell $i$ is classified as a **boundary** cell.\n    This process partitions the set of target cells $S_{t^\\star}$ into the boundary set $B$ and the interior set $I$.\n\n3.  **Differential Expression Analysis**:\n    The analysis proceeds only if both the boundary set $B$ and the interior set $I$ are non-empty, i.e., $|B| \\ge 1$ and $|I| \\ge 1$. If either set is empty, no genes are considered differentially expressed (DE), and the result is an empty list.\n    If both sets are non-empty, we compute the mean expression for each gene $j \\in \\{0, \\dots, g-1\\}$ across the boundary and interior cell populations:\n    $$\n    \\mu_B(j) = \\frac{1}{|B|} \\sum_{i \\in B} x_{ij}\n    $$\n    $$\n    \\mu_I(j) = \\frac{1}{|I|} \\sum_{i \\in I} x_{ij}\n    $$\n    A gene $j$ is then identified as differentially expressed if the absolute difference between these mean expression values meets or exceeds the given threshold $\\tau$:\n    $$\n    |\\mu_B(j) - \\mu_I(j)| \\ge \\tau\n    $$\n\n4.  **Final Result**:\n    The indices of all genes satisfying the DE criterion are collected. The resulting list of indices for each test case is sorted in ascending order. The final output is an aggregation of these lists.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print the final results.\n    \"\"\"\n    test_cases = [\n        {\n            \"t_star\": 0, \"k\": 2, \"tau\": 3.0,\n            \"C\": np.array([\n                [0, 0], [1, 0], [2, 0], [1, 1], [2, 1], [3, 0], [0, 1]\n            ]),\n            \"T\": np.array([0, 0, 0, 0, 1, 1, 0]),\n            \"X\": np.array([\n                [2, 5, 8], [2, 5, 8], [10, 5, 1], [9, 5, 2],\n                [3, 5, 7], [4, 5, 6], [2, 5, 8]\n            ])\n        },\n        {\n            \"t_star\": 0, \"k\": 2, \"tau\": 3.0,\n            \"C\": np.array([\n                [0, 0], [0, 1], [0, 2], [10, 0], [10, 1], [10, 2]\n            ]),\n            \"T\": np.array([0, 0, 0, 1, 1, 1]),\n            \"X\": np.array([\n                [1, 1], [2, 2], [3, 3], [4, 4], [5, 5], [6, 6]\n            ])\n        },\n        {\n            \"t_star\": 0, \"k\": 1, \"tau\": 3.0,\n            \"C\": np.array([\n                [0, 0], [1, 0], [0, 1], [-1, 0]\n            ]),\n            \"T\": np.array([0, 1, 0, 0]),\n            \"X\": np.array([\n                [9, 3], [4, 4], [1, 3], [1, 3]\n            ])\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        result = analyze_spatial_de(\n            case[\"t_star\"], case[\"k\"], case[\"tau\"],\n            case[\"C\"], case[\"T\"], case[\"X\"]\n        )\n        results.append(result)\n\n    # Format the final output string exactly as required, with no spaces.\n    final_output = str(results).replace(\" \", \"\")\n    print(final_output)\n\ndef analyze_spatial_de(t_star, k, tau, C, T, X):\n    \"\"\"\n    Analyzes a single spatial transcriptomics dataset to find differentially\n    expressed genes between boundary and interior cells of a target type.\n    \"\"\"\n    n, g = X.shape\n    \n    # Compute pairwise Euclidean distance matrix\n    # C is shape (n, 2). Reshape for broadcasting to (n, 1, 2) and (1, n, 2).\n    # The difference is (n, n, 2), representing coordinate differences.\n    # Sum squares along the coordinate axis and take sqrt.\n    diff = C[:, np.newaxis, :] - C[np.newaxis, :, :]\n    dist_matrix = np.sqrt(np.sum(diff**2, axis=-1))\n\n    # Exclude self-neighbors by setting diagonal distance to infinity.\n    np.fill_diagonal(dist_matrix, np.inf)\n\n    target_cell_indices = np.where(T == t_star)[0]\n    \n    boundary_cells = []\n    interior_cells = []\n    \n    all_indices = np.arange(n)\n\n    for i in target_cell_indices:\n        distances_from_i = dist_matrix[i, :]\n        \n        # Lexicographical sort on (distance, index) to break ties deterministically.\n        # np.lexsort sorts by the last key first.\n        sorted_neighbor_indices = np.lexsort((all_indices, distances_from_i))\n        \n        knn_indices = sorted_neighbor_indices[:k]\n        neighbor_labels = T[knn_indices]\n        \n        # If all neighbors have the same label as the target cell, it's interior.\n        if np.all(neighbor_labels == t_star):\n            interior_cells.append(i)\n        else:\n            boundary_cells.append(i)\n            \n    # If either set is empty, no DE genes can be found.\n    if not boundary_cells or not interior_cells:\n        return []\n\n    # Calculate mean expression for boundary and interior cells\n    X_boundary = X[boundary_cells, :]\n    X_interior = X[interior_cells, :]\n    \n    mu_B = np.mean(X_boundary, axis=0)\n    mu_I = np.mean(X_interior, axis=0)\n    \n    # Identify DE genes based on the threshold tau\n    diff_expression = np.abs(mu_B - mu_I)\n    de_gene_indices = np.where(diff_expression >= tau)[0]\n    \n    # The result must be a sorted list of indices. np.where provides this.\n    return de_gene_indices.tolist()\n\nsolve()\n```"
        }
    ]
}