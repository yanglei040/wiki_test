{
    "hands_on_practices": [
        {
            "introduction": "即时 (JIT) 编译器常需处理虚函数调用，而多态内联缓存 (Polymorphic Inline Caches, PICs) 是加速这一过程的关键机制。本练习将运用全期望定律，通过计算不同检查顺序下的预期调用成本，来确定最优的类型守卫 (guard) 排列方式，从而最小化执行开销。这项实践旨在阐明如何利用基础的概率成本模型来指导编译器的核心优化决策 。",
            "id": "3639221",
            "problem": "一个即时 (JIT) 编译器在一个热点虚调用点使用多态内联缓存 (PIC)。PIC 存根会依次测试接收者类型的守卫，若匹配成功，则尾调用一个直接目标；若所有守卫都失败，则转移到一个超多态未命中处理器。考虑一个双条目 PIC，它最多可以容纳两个接收者类型的条目，分别对应类型 $\\mathrm{A}$ 和 $\\mathrm{B}$。所有其他接收者类型被归为“其他”($\\mathrm{Other}$) 类别。\n\n假设使用以下执行和成本模型：\n- 接收者类型为 $\\mathrm{A}$ 的概率为 $p_{\\mathrm{A}} = 0.5$，类型为 $\\mathrm{B}$ 的概率为 $p_{\\mathrm{B}} = 0.3$，类型为“其他”($\\mathrm{Other}$) 的概率为 $p_{\\mathrm{O}} = 0.2$。\n- 每次守卫检查的成本为 $g = 2$ 个周期（包括比较和分支解析）。\n- 守卫匹配成功时，直接调用序列的成本为 $c = 6$ 个周期（包括任何必要的调度和控制转移）。\n- 如果两个守卫都失败，控制将转移到未命中处理器，其成本为 $m = 80$ 个周期（包括查找并调用解析出的目标）。\n- 在未命中时，两个守卫检查都会在未命中处理器之前执行；除了匹配成功时的直接调用外，没有其他提前退出的情况。除了所述成本外，没有额外的开销，并且 $g$、$c$ 和 $m$ 未包含的微架构效应可以忽略。\n\n编译器可以将 PIC 存根中的两个守卫排序为先 $\\mathrm{A}$ 后 $\\mathrm{B}$ 或先 $\\mathrm{B}$ 后 $\\mathrm{A}$。使用概率论中的全期望定律和所述的成本模型，推导出每次调用的期望周期数作为守卫顺序的函数，确定哪种顺序可以最小化期望周期数，并计算最小的每次调用期望周期数。将您的最终数值答案四舍五入到四位有效数字，并以“周期/调用”为单位表示。",
            "solution": "问题要求确定一个双条目多态内联缓存 (PIC) 中接收者类型检查的最佳顺序，以最小化每次调用的期望执行时间（以周期为单位）。分析将基于全期望定律，使用所提供的概率和成本模型。\n\n令 $C$ 为表示单次虚调用所需总周期数的随机变量。$C$ 的期望值，记为 $E[C]$，是需要最小化的量。问题提供了以下参数：\n- 接收者类型的概率：类型 $\\mathrm{A}$、$ \\mathrm{B}$ 和“其他”($\\mathrm{Other}$) 的概率分别为 $p_{\\mathrm{A}} = 0.5$，$p_{\\mathrm{B}} = 0.3$ 和 $p_{\\mathrm{O}} = 0.2$。注意 $p_{\\mathrm{A}} + p_{\\mathrm{B}} + p_{\\mathrm{O}} = 0.5 + 0.3 + 0.2 = 1$。\n- 单次守卫检查的成本：$g = 2$ 个周期。\n- 成功检查后的直接调用成本：$c = 6$ 个周期。\n- 超多态未命中处理器的成本：$m = 80$ 个周期。\n\nPIC 存根的检查有两种可能的顺序：($\\mathrm{A}$, $\\mathrm{B}$) 或 ($\\mathrm{B}$, $\\mathrm{A}$)。我们将为每种顺序计算期望成本。\n\n情况 1：守卫顺序为先 $\\mathrm{A}$ 后 $\\mathrm{B}$\n令 $C_{\\mathrm{A,B}}$ 为此顺序的成本。总期望成本 $E[C_{\\mathrm{A,B}}]$ 是每种可能结果的成本与其概率加权的和。\n- 如果接收者类型为 $\\mathrm{A}$（概率为 $p_{\\mathrm{A}}$），则执行一次守卫检查并成功。总成本为一次守卫检查加上直接调用成本。成本：$g + c$。\n- 如果接收者类型为 $\\mathrm{B}$（概率为 $p_{\\mathrm{B}}$），则对 $\\mathrm{A}$ 的第一次守卫检查失败，而对 $\\mathrm{B}$ 的第二次守卫检查成功。总成本为两次守卫检查加上直接调用成本。成本：$g + g + c = 2g + c$。\n- 如果接收者类型为“其他”($\\mathrm{Other}$)（概率为 $p_{\\mathrm{O}}$），则对 $\\mathrm{A}$ 和 $\\mathrm{B}$ 的两次守卫检查都失败。控制转移到未命中处理器。总成本为两次守卫检查加上未命中处理器成本。成本：$g + g + m = 2g + m$。\n\n根据全期望定律，期望成本为：\n$$ E[C_{\\mathrm{A,B}}] = p_{\\mathrm{A}}(g+c) + p_{\\mathrm{B}}(2g+c) + p_{\\mathrm{O}}(2g+m) $$\n\n情况 2：守卫顺序为先 $\\mathrm{B}$ 后 $\\mathrm{A}$\n令 $C_{\\mathrm{B,A}}$ 为此顺序的成本。其逻辑与第一种情况对称。\n- 如果接收者类型为 $\\mathrm{B}$（概率为 $p_{\\mathrm{B}}$），则执行一次守卫检查并成功。成本：$g + c$。\n- 如果接收者类型为 $\\mathrm{A}$（概率为 $p_{\\mathrm{A}}$），则对 $\\mathrm{B}$ 的第一次检查失败，而对 $\\mathrm{A}$ 的第二次检查成功。成本：$2g + c$。\n- 如果接收者类型为“其他”($\\mathrm{Other}$)（概率为 $p_{\\mathrm{O}}$），则两次检查都失败。成本：$2g + m$。\n\n此顺序的期望成本为：\n$$ E[C_{\\mathrm{B,A}}] = p_{\\mathrm{B}}(g+c) + p_{\\mathrm{A}}(2g+c) + p_{\\mathrm{O}}(2g+m) $$\n\n确定最佳顺序\n为了找到最小化期望周期数的顺序，我们比较 $E[C_{\\mathrm{A,B}}]$ 和 $E[C_{\\mathrm{B,A}}]$。我们来研究它们的差值：\n$$ E[C_{\\mathrm{B,A}}] - E[C_{\\mathrm{A,B}}] = \\left[ p_{\\mathrm{B}}(g+c) + p_{\\mathrm{A}}(2g+c) + p_{\\mathrm{O}}(2g+m) \\right] - \\left[ p_{\\mathrm{A}}(g+c) + p_{\\mathrm{B}}(2g+c) + p_{\\mathrm{O}}(2g+m) \\right] $$\n项 $p_{\\mathrm{O}}(2g+m)$ 在两个表达式中是共有的，因此可以抵消。\n$$ E[C_{\\mathrm{B,A}}] - E[C_{\\mathrm{A,B}}] = (p_{\\mathrm{B}}g + p_{\\mathrm{B}}c + 2p_{\\mathrm{A}}g + p_{\\mathrm{A}}c) - (p_{\\mathrm{A}}g + p_{\\mathrm{A}}c + 2p_{\\mathrm{B}}g + p_{\\mathrm{B}}c) $$\n项 $p_{\\mathrm{A}}c$ 和 $p_{\\mathrm{B}}c$ 也抵消了。\n$$ E[C_{\\mathrm{B,A}}] - E[C_{\\mathrm{A,B}}] = (p_{\\mathrm{B}}g + 2p_{\\mathrm{A}}g) - (p_{\\mathrm{A}}g + 2p_{\\mathrm{B}}g) $$\n$$ E[C_{\\mathrm{B,A}}] - E[C_{\\mathrm{A,B}}] = p_{\\mathrm{B}}g + 2p_{\\mathrm{A}}g - p_{\\mathrm{A}}g - 2p_{\\mathrm{B}}g $$\n$$ E[C_{\\mathrm{B,A}}] - E[C_{\\mathrm{A,B}}] = p_{\\mathrm{A}}g - p_{\\mathrm{B}}g = g(p_{\\mathrm{A}} - p_{\\mathrm{B}}) $$\n由于 $g  0$，差值的符号取决于 $(p_{\\mathrm{A}} - p_{\\mathrm{B}})$ 的符号。如果一个顺序能带来更低的期望成本，那么它就是最优的。\n- 如果 $p_{\\mathrm{A}}  p_{\\mathrm{B}}$，则 $E[C_{\\mathrm{B,A}}] - E[C_{\\mathrm{A,B}}]  0$，这意味着 $E[C_{\\mathrm{B,A}}]  E[C_{\\mathrm{A,B}}]$。先 $\\mathrm{A}$ 后 $\\mathrm{B}$ 的顺序是最优的。\n- 如果 $p_{\\mathrm{B}}  p_{\\mathrm{A}}$，则 $E[C_{\\mathrm{B,A}}] - E[C_{\\mathrm{A,B}}]  0$，这意味着 $E[C_{\\mathrm{B,A}}]  E[C_{\\mathrm{A,B}}]$。先 $\\mathrm{B}$ 后 $\\mathrm{A}$ 的顺序是最优的。\n\n这证实了一个普遍原则：要最小化平均成本，应首先测试最可能发生的结果。\n给定概率 $p_{\\mathrm{A}}=0.5$ 和 $p_{\\mathrm{B}}=0.3$，我们有 $p_{\\mathrm{A}}  p_{\\mathrm{B}}$。因此，最优的守卫顺序是先 $\\mathrm{A}$ 后 $\\mathrm{B}$。\n\n计算最小期望周期数\n我们现在使用给定的值来计算最小期望周期数 $E[C_{\\mathrm{A,B}}]$ 的数值：\n$p_{\\mathrm{A}} = 0.5$, $p_{\\mathrm{B}} = 0.3$, $p_{\\mathrm{O}} = 0.2$\n$g = 2$, $c = 6$, $m = 80$\n\n$$ E[C_{\\mathrm{A,B}}] = p_{\\mathrm{A}}(g+c) + p_{\\mathrm{B}}(2g+c) + p_{\\mathrm{O}}(2g+m) $$\n$$ E[C_{\\mathrm{A,B}}] = 0.5(2+6) + 0.3(2 \\times 2 + 6) + 0.2(2 \\times 2 + 80) $$\n$$ E[C_{\\mathrm{A,B}}] = 0.5(8) + 0.3(4 + 6) + 0.2(4 + 80) $$\n$$ E[C_{\\mathrm{A,B}}] = 0.5(8) + 0.3(10) + 0.2(84) $$\n$$ E[C_{\\mathrm{A,B}}] = 4.0 + 3.0 + 16.8 $$\n$$ E[C_{\\mathrm{A,B}}] = 23.8 $$\n问题要求将最终答案四舍五入到四位有效数字。计算出的值 $23.8$ 可以写成 $23.80$ 来满足此要求。单位是“周期/调用”。\n\n最小的每次调用期望周期数为 $23.80$。",
            "answer": "$$\n\\boxed{23.80}\n$$"
        },
        {
            "introduction": "现代 JIT 编译器通过推测性优化 (speculative optimization) 来移除高频检查，但这带来了推测失败时“去优化” (deoptimization) 的风险。本练习模拟了在推测性空指针检查消除中，优化收益与去优化成本之间的权衡，并引入了如何通过采样数据建立无偏估计量来预测失败频率。通过这项实践，你将亲身体验如何量化一项推测性优化的净收益，这是自适应优化中的一项核心技能 。",
            "id": "3639127",
            "problem": "动态语言运行时中的即时 (JIT) 编译器通过在热循环前提升一个守卫，来执行推测性空值检查消除。守卫是一种运行时检查，用于确保某个假定的属性成立；如果该属性不成立，系统会以固定的成本触发去优化（转换到一个更保守的代码版本）。考虑以下场景。方法的每次调用执行一个包含 $L$ 次迭代的循环。基线机器代码包含每次迭代的空值检查，成本为 $c$ 个周期。推测性版本在循环前提升一个单一守卫，每次调用的成本为 $g$ 个周期。如果守卫成功，则该次调用的循环内部的空值检查被消除。如果守卫失败，则发生去优化，成本为 $D$ 个周期，并且该次调用继续执行基线代码（即，其循环在保留空值检查的情况下执行）。失败是罕见的，运行时会自适应地对调用进行采样，以估计失败频率。\n\n在一个包含 $N$ 次调用的测量窗口内，运行时使用独立的伯努利采样来记录守卫失败：每次调用以概率 $s$ 被采样，并且只有被采样的调用才会记录守卫是否失败。在采样集合中，观察到 $f_s$ 次失败。\n\n从基本概率定义（指示变量、期望和无偏估计）和第一性原理成本模型（期望周期数的期望线性性质）出发，完成以下任务：\n- 推导守卫失败频率 $\\phi$（在没有采样的情况下会失败的调用比例）的无偏估计量，用 $N$、$s$ 和 $f_s$ 表示。\n- 使用 $\\phi$，推导相对于基线代码（保留了每次迭代的空值检查）在 $N$ 次调用中预期的净节省周期数，同时考虑守卫成本和去优化成本。\n\n使用以下测量和架构参数：\n- $L = 8000$\n- $c = 3$ 周期\n- $g = 40$ 周期/次调用\n- $D = 50000$ 周期/次去优化\n- $N = 120000$\n- $s = 0.05$\n- $f_s = 180$\n\n将最终数值答案四舍五入到四位有效数字。将最终量表示为在 $N$ 次调用中预期的总净节省周期数，单位为周期。",
            "solution": "问题陈述已经过验证，被认为是合理的。它在科学上基于编译器设计和性能分析的原理，问题提出得当，数据充分且一致，并且表述客观。该问题要求对估计量进行第一性原理推导和成本效益分析，这是该领域的标准且有意义的任务。\n\n解决方案分为两部分：首先，推导守卫失败频率的无偏估计量；其次，推导预期的净节省周期数，然后进行数值计算。\n\n**第一部分：守卫失败频率 ($\\phi$) 的无偏估计量**\n\n令 $\\phi$ 为任何给定的方法调用中守卫失败的真实概率。我们需要找到该参数的一个无偏估计量 $\\hat{\\phi}$。该估计基于一个包含 $N$ 次调用的测量窗口。\n\n令 $F_i$ 为第 $i$ 次调用的指示随机变量，其中 $i \\in \\{1, 2, \\dots, N\\}$。\n$$\nF_i =\n\\begin{cases}\n1  \\text{如果调用 } i \\text{ 的守卫会失败} \\\\\n0  \\text{如果调用 } i \\text{ 的守卫会成功}\n\\end{cases}\n$$\n根据定义，失败的概率为 $P(F_i=1) = \\phi$，因此 $F_i$ 的期望值为 $E[F_i] = 1 \\cdot P(F_i=1) + 0 \\cdot P(F_i=0) = \\phi$。\n\n运行时以概率 $s$ 独立地对调用进行采样。令 $S_i$ 为采样的指示随机变量。\n$$\nS_i =\n\\begin{cases}\n1  \\text{如果调用 } i \\text{ 被采样} \\\\\n0  \\text{如果调用 } i \\text{ 未被采样}\n\\end{cases}\n$$\n采样的概率为 $P(S_i=1) = s$，所以 $E[S_i] = s$。\n\n只有当一次调用既被采样又会失败时，才会观察到失败。令 $O_i$ 为第 $i$ 次调用观察到失败的指示变量。因此，$O_i = S_i F_i$。观察到的总失败次数 $f_s$ 是这 $N$ 次调用的指示变量之和：\n$$f_s = \\sum_{i=1}^{N} O_i = \\sum_{i=1}^{N} S_i F_i$$\n为了构建一个估计量，我们首先求 $f_s$ 的期望值。利用期望的线性性质：\n$$E[f_s] = E\\left[\\sum_{i=1}^{N} S_i F_i\\right] = \\sum_{i=1}^{N} E[S_i F_i]$$\n采样过程独立于程序的行为（调用是否失败）。因此，随机变量 $S_i$ 和 $F_i$ 是独立的。这使我们可以写出 $E[S_i F_i] = E[S_i]E[F_i]$。\n$$E[S_i F_i] = s \\phi$$\n将此代入 $E[f_s]$ 的表达式中：\n$$E[f_s] = \\sum_{i=1}^{N} s\\phi = Ns\\phi$$\n对于 $\\phi$ 的一个估计量 $\\hat{\\phi}$，如果其期望值等于 $\\phi$（即 $E[\\hat{\\phi}] = \\phi$），则该估计量是无偏的。基于关系式 $E[f_s] = Ns\\phi$，我们可以提出以下 $\\phi$ 的估计量：\n$$\\hat{\\phi} = \\frac{f_s}{Ns}$$\n为了验证该估计量是无偏的，我们求其期望：\n$$E[\\hat{\\phi}] = E\\left[\\frac{f_s}{Ns}\\right] = \\frac{1}{Ns}E[f_s] = \\frac{1}{Ns}(Ns\\phi) = \\phi$$\n因此，$\\hat{\\phi} = \\frac{f_s}{Ns}$ 是守卫失败频率 $\\phi$ 的一个无偏估计量。\n\n**第二部分：预期的净节省周期数**\n\n我们需要推导使用推测性版本的代码相对于基线版本，在 $N$ 次调用中预期的净节省周期数。\n\n在基线代码中，$N$ 次调用中的每一次都在 $L$ 次循环迭代中执行一次空值检查。每次检查的成本为 $c$ 个周期。在 $N$ 次调用中，这些检查的总成本为：\n$$C_{\\text{基线}} = N L c$$\n在推测性版本中，我们分析每次调用的净节省周期数。令此值为 $\\Delta C_{\\text{节省}}$。每次调用有两种情况：\n\n情况 1：守卫成功。这种情况以概率 $1-\\phi$ 发生。\n每次迭代的空值检查（总成本为 $Lc$ 个周期）被消除。这是一种节省。同时引入了一个新的成本，即守卫检查，成本为 $g$ 个周期。\n在这种情况下，净节省的周期数为：$\\Delta C_{\\text{节省, 成功}} = Lc - g$。\n\n情况 2：守卫失败。这种情况以概率 $\\phi$ 发生。\n执行守卫检查，成本为 $g$ 个周期。发生去优化，成本为 $D$ 个周期。然后，调用继续使用基线代码执行，这意味着空值检查的 $Lc$ 成本*没有*被节省。与基线相比，我们*增加*了 $g$ 和 $D$ 的成本。\n在这种情况下，净节省的周期数为负：$\\Delta C_{\\text{节省, 失败}} = -(g+D)$。\n\n每次调用的预期净节省周期数 $E[\\Delta C_{\\text{节省}}]$ 是这两种结果的加权平均值：\n$$E[\\Delta C_{\\text{节省}}] = P(\\text{成功}) \\cdot \\Delta C_{\\text{节省, 成功}} + P(\\text{失败}) \\cdot \\Delta C_{\\text{节省, 失败}}$$\n$$E[\\Delta C_{\\text{节省}}] = (1-\\phi)(Lc - g) + (\\phi)(-(g+D))$$\n展开此表达式：\n$$E[\\Delta C_{\\text{节省}}] = Lc - g - \\phi Lc + \\phi g - \\phi g - \\phi D = Lc - g - \\phi(Lc + D)$$\n在 $N$ 次调用中的总预期净节省周期数 $E[\\text{总节省}]$ 是每次调用节省量的 $N$ 倍：\n$$E[\\text{总节省}] = N \\cdot E[\\Delta C_{\\text{节省}}] = N(Lc - g - \\phi(Lc+D))$$\n为了计算数值，我们使用无偏估计量 $\\hat{\\phi} = \\frac{f_s}{Ns}$ 来代替真实频率 $\\phi$：\n$$E[\\text{总节省}]_{\\text{估计}} = N\\left(Lc - g - \\left(\\frac{f_s}{Ns}\\right)(Lc+D)\\right)$$\n将前面的 $N$ 分配进去可以简化表达式：\n$$E[\\text{总节省}]_{\\text{估计}} = N(Lc-g) - \\frac{f_s}{s}(Lc+D)$$\n现在，我们代入给定的数值：\n$L = 8000$, $c = 3$ 周期, $g = 40$ 周期, $D = 50000$ 周期, $N = 120000$, $s = 0.05$, 以及 $f_s = 180$。\n\n首先，计算总节省项（即没有失败发生时的节省量）：\n$$N(Lc-g) = 120000 \\times (8000 \\times 3 - 40) = 120000 \\times (24000 - 40) = 120000 \\times 23960 = 2875200000 \\text{ 周期}$$\n接下来，计算失败和去优化的总预期成本项：\n$$\\frac{f_s}{s}(Lc+D) = \\frac{180}{0.05} \\times (8000 \\times 3 + 50000) = 3600 \\times (24000 + 50000) = 3600 \\times 74000 = 266400000 \\text{ 周期}$$\n估计的总净节省周期数是这两个量的差值：\n$$E[\\text{总节省}]_{\\text{估计}} = 2875200000 - 266400000 = 2608800000 \\text{ 周期}$$\n这可以用科学记数法写成 $2.6088 \\times 10^9$ 周期。问题要求将最终答案四舍五入到四位有效数字。\n$$2.6088 \\times 10^9 \\approx 2.609 \\times 10^9$$\n在 $N$ 次调用中，预期的总净节省周期数约为 $2.609 \\times 10^9$ 周期。",
            "answer": "$$\\boxed{2.609 \\times 10^9}$$"
        },
        {
            "introduction": "推测性内联 (speculative inlining) 是一项强大但成本高昂的优化。决定内联的深度 $d$ 需要在累积收益与一次性的去优化惩罚之间找到平衡，因为失败可能在任何一次调用中发生。本练习通过一个思想实验，使用几何分布来为推测性代码的“首次失败时间”建模。通过推导收支平衡的内联深度 $d^{\\star}$，你将学会如何构建分析模型，以便在不确定的条件下做出战略性的优化选择 。",
            "id": "3639208",
            "problem": "一台虚拟机采用即时 (JIT) 编译技术，并结合推测性内联来加速一个热循环，该循环重复调用一个函数链。优化器考虑一个内联深度 $d$，意即它将调用链上的 $d$ 个函数内联到调用者中。在内联区域内有一个偏向性的条件分支：其热路径结果在每次调用时独立发生，概率为 $b \\in (0,1)$，其冷路径结果发生的概率为 $1-b$。JIT 会生成推测热路径结果的代码，并安装一个去优化守卫，在推测失败时将控制权转回非推测性基线执行。\n\n假设以下成本模型，以时间单位表示：\n- 每一级内联都消除了调用开销并带来了局部优化，每次调用可节省 $w$ 个时间单位。因此，当推测成功时，归因于内联深度 $d$ 的每次调用运行时节省为 $w d$。\n- 一次性的编译开销随内联深度线性增长，为 $k d$。\n- 当推测首次失败时，去优化过程会重建执行状态并在基线中恢复执行，产生一次性成本 $L$。去优化后，将不再获得任何推测性收益；执行将在基线中继续，没有额外的节省。\n- 分支结果在各次调用之间是独立的。\n\n在分析中，将内联深度 $d$ 视为一个连续决策变量。运用概率和期望值的基本定义，推导出使预期净节省时间为零的盈亏平衡内联深度 $d^{\\star}$。将最终答案表示为关于 $b$、$w$、$k$ 和 $L$ 的单个闭式解析表达式。最终表达式无需四舍五入，也无需单位。",
            "solution": "该问题陈述已经过评估，并被确定为有效。它在科学上基于编译器优化和性能建模的原理，问题设定良好，信息充分，可得出唯一解，并且陈述客观。分析过程如下。\n\n目标是找到盈亏平衡内联深度，记为 $d^{\\star}$，在该深度下，预期的净节省时间为零。净节省时间是成功推测执行所节省的总时间减去编译和去优化的一次性成本。\n\n设 $S(d)$ 为给定内联深度 $d$ 的净节省时间。我们希望找到 $d^{\\star}$ 使得期望值 $E[S(d^{\\star})] = 0$。\n\n问题的核心在于推测执行的概率性质。条件分支的热路径以概率 $b$ 被选择，冷路径以概率 $1-b$ 被选择。JIT 推测热路径将被选择。执行会以推测方式进行，直到第一次选择冷路径，此时发生去优化事件。循环每次调用时的分支结果是独立事件。\n\n设 $I$ 是一个随机变量，表示首次发生推测失败（即首次选择冷路径）的调用次数。这是一个经典的伯努利试验过程。在第 $i$ 次调用时发生失败的事件，需要 $i-1$ 次连续成功（热路径）后跟一次失败（冷路径）。这一系列事件的概率是：\n$$P(I=i) = b^{i-1}(1-b) \\quad \\text{for } i \\in \\{1, 2, 3, \\ldots\\}$$\n这为随机变量 $I$ 定义了一个几何分布，其“成功”参数为 $p = 1-b$（这里的“成功”指停止过程的事件，即一次推测失败）。\n\n如果第一次失败发生在第 $I$ 次调用，那么已经有 $I-1$ 次成功的推测性调用。\n这些成功调用所节省的总时间是每次调用的节省量 $wd$ 乘以成功调用的次数 $I-1$。\n来自推测的总收益 = $(I-1)wd$。\n\n与此推测策略相关的成本有：\n1. 一次性编译开销，它是内联深度的函数：$kd$。\n2. 一次性去优化惩罚，在首次失败时产生：$L$。\n\n因此，净节省时间作为随机变量 $I$ 和决策变量 $d$ 的函数是：\n$$S(d, I) = (I-1)wd - kd - L$$\n\n为了找到盈亏平衡点，我们需要计算预期的净节省时间 $E[S(d,I)]$。根据期望的线性性质：\n$$E[S(d,I)] = E[(I-1)wd - kd - L] = E[(I-1)wd] - E[kd] - E[L]$$\n由于 $w$、$d$、$k$ 和 $L$ 相对于随机过程（分支结果）是常数，我们可以写成：\n$$E[S(d)] = wd \\cdot E[I-1] - kd - L$$\n\n我们需要计算 $E[I-1]$。参数为 $p=1-b$ 的几何随机变量 $I$ 的期望值由 $E[I] = \\frac{1}{p} = \\frac{1}{1-b}$ 给出。\n在第一次失败前成功调用的期望次数是：\n$$E[I-1] = E[I] - 1 = \\frac{1}{1-b} - 1 = \\frac{1 - (1-b)}{1-b} = \\frac{b}{1-b}$$\n\n将此结果代入预期净节省时间的表达式中：\n$$E[S(d)] = wd \\left(\\frac{b}{1-b}\\right) - kd - L$$\n这个表达式表示选择内联深度 $d$ 所带来的预期净收益。正值表示预期的净节省，而负值表示预期的净损失。\n\n盈亏平衡内联深度 $d^{\\star}$ 是预期净节省时间恰好为零时的深度：\n$$E[S(d^{\\star})] = 0$$\n$$w d^{\\star} \\left(\\frac{b}{1-b}\\right) - k d^{\\star} - L = 0$$\n\n现在我们可以解这个关于 $d^{\\star}$ 的线性方程。首先，提出公因子 $d^{\\star}$：\n$$d^{\\star} \\left(w \\frac{b}{1-b} - k\\right) = L$$\n只要括号中的项不为零，我们就可以解出 $d^{\\star}$：\n$$d^{\\star} = \\frac{L}{w \\frac{b}{1-b} - k}$$\n一个非负的盈亏平衡深度的条件是 $w \\frac{b}{1-b} - k  0$，这意味着增加一级内联所带来的预期每次调用节省必须超过其编译成本。\n\n为了将表达式简化为单个分数，我们可以为分母中的各项找到一个公分母：\n$$w \\frac{b}{1-b} - k = \\frac{wb}{1-b} - \\frac{k(1-b)}{1-b} = \\frac{wb - k(1-b)}{1-b}$$\n将此代回 $d^{\\star}$ 的表达式中：\n$$d^{\\star} = \\frac{L}{\\frac{wb - k(1-b)}{1-b}} = \\frac{L(1-b)}{wb - k(1-b)}$$\n这就是盈亏平衡内联深度的最终闭式解析表达式。",
            "answer": "$$\n\\boxed{\\frac{L(1-b)}{wb - k(1-b)}}\n$$"
        }
    ]
}