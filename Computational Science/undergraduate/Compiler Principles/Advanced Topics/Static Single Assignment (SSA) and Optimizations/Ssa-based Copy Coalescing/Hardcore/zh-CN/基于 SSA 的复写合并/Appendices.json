{
    "hands_on_practices": [
        {
            "introduction": "副本合并的主要目标是消除冗余的移动指令，但这种优化并非没有代价。合并两个变量的本质是延长了它们的生命周期，这可能会增加寄存器压力。这个练习要求你在线性扫描寄存器分配的背景下，通过将副本合并建模为生命周期区间的合并，来量化这一成本，并推导出导致寄存器压力超限的精确条件。",
            "id": "3671345",
            "problem": "考虑一个静态单赋值（SSA）形式的单一基本块，其中每个 SSA 变量名 $v$ 在块内有一个活跃区间，表示为线性指令序列上的一个半开区间 $[s_v,e_v)$。在线性扫描寄存器分配中，基本约束是在任何程序点 $t$，同时活跃的 SSA 变量名数量不得超过可用寄存器的数量 $k$。一个副本合并遍旨在通过合并两个副本相关的 SSA 变量名来消除副本。在区间模型中，这种对两个不重叠活跃区间的合并，表现为用它们的并集替换这两个区间，在线性序列上这等同于连接它们端点的凸包区间。\n\n从上述核心定义出发，请提出一个从副本合并到区间合并的精确映射，并仅使用线性扫描约束，推导出一个必要且充分的条件（用块内基线逐点活跃数和 $k$ 表示），该条件能精确地刻画一组此类区间合并何时会违反线性扫描分配器的可行性假设。\n\n然后，将您的条件应用于以下具体实例。该基本块的指令索引沿实线分布，SSA 变量名的基线活跃区间如下：\n- $x_1 : [1,3)$,\n- $x_2 : [2,5)$,\n- $x_3 : [4,7)$,\n- $x_4 : [6,9)$,\n- $x_5 : [8,11)$,\n- $x_6 : [10,13)$,\n- $y_1 : [3,10)$.\n\n假设有 $k = 3$ 个寄存器。唯一符合合并条件的候选副本相关对如下：\n- $(x_1,x_3)$,\n- $(x_2,x_4)$,\n- $(x_3,x_5)$,\n- $(x_4,x_6)$,\n- $(x_1,x_4)$,\n- $(x_2,x_5)$.\n\n所列出的每一对都有不重叠的活跃区间。将每次合并都视为用两个区间的凸包区间替换它们，从而使该变量名在整个凸包区间内都处于活跃状态。使用您推导出的条件，确定上述列表中最多可以同时合并多少对候选对，而不会在有 $k=3$ 个寄存器的情况下违反线性扫描的可行性。最终答案只需说明这个最大值。无需进行四舍五入。",
            "solution": "该问题要求两大部分：首先，推导出一个通用条件，用于判断一组副本合并何时会违反线性扫描寄存器分配的可行性约束；其次，将此条件应用于一个具体实例，以找出有效的同时合并的最大数量。\n\n### 第一部分：通用条件的推导\n\n令 $V$ 为一个基本块中静态单赋值（SSA）变量名的集合。每个 SSA 变量名 $v \\in V$ 都有一个活跃区间 $[s_v, e_v)$。可用物理寄存器的数量为 $k$。\n\n线性扫描寄存器分配的基本约束是，在任何程序点 $t$，同时活跃的变量数量（称为寄存器压力或活跃数）不得超过可用寄存器的数量。令 $L(t)$ 为点 $t$ 的活跃数。\n$$L(t) = \\sum_{v \\in V} \\mathbb{I}(t \\in [s_v, e_v))$$\n其中 $\\mathbb{I}(\\cdot)$ 是指示函数，当其参数为真时值为 $1$，否则为 $0$。\n基线系统是可行的，当且仅当 $\\forall t, L_{base}(t) \\le k$，其中 $L_{base}(t)$ 是进行任何合并之前的活跃数。\n\n副本合并会合并两个由副本指令关联的 SSA 变量名，例如 $u$ 和 $v$。该问题将此操作建模为对其不重叠的活跃区间 $[s_u, e_u)$ 和 $[s_v, e_v)$ 的操作，即用一个对应其凸包的新区间来替换它们。不失一般性地假设 $e_u \\le s_v$，则新区间为 $[\\min(s_u, s_v), \\max(e_u, e_v)) = [s_u, e_v)$。\n\n此操作会影响活跃数。最初，两个变量 $u$ 和 $v$ 仅在它们各自的区间内对活跃数有贡献。合并后，新变量在整个凸包区间 $[s_u, e_v)$ 内都对活跃数有贡献。活跃性的变化发生在原始区间之间的“空洞”或“桥接”区间，即 $[e_u, s_v)$。在这个桥接区间内，活跃数恰好增加 $1$。对于原始区间 $[s_u, e_u)$ 或 $[s_v, e_v)$ 内部的点，活跃数不变，因为一个新的活跃变量取代了一个旧的活跃变量。对于凸包区间 $[s_u, e_v)$ 之外的点，活跃数也保持不变。\n\n现在，考虑一组用于同时合并的候选对 $C = \\{(u_1, v_1), (u_2, v_2), \\dots, (u_m, v_m)\\}$。令每对 $P_i = (u_i, v_i)$ 的桥接区间为 $B_i = [\\min(e_{u_i}, e_{v_i}), \\max(s_{u_i}, s_{v_i}))$。当集合 $C$ 中的所有对都被合并时，在点 $t$ 处活跃数的总增量（记为 $\\Delta_C(t)$）是集合 $\\{B_i\\}_{i=1}^m$ 中包含点 $t$ 的桥接区间的数量。即使 $C$ 中的对共享变量，这一结论也成立，因为合并相应的变量等价类会填补其所有组成区间之间的所有间隙。活跃数的总增量为：\n$$\\Delta_C(t) = \\sum_{P_i = (u_i, v_i) \\in C} \\mathbb{I}(t \\in B_i)$$\n合并 $C$ 中的对之后的新活跃数为 $L_{new}(t) = L_{base}(t) + \\Delta_C(t)$。\n\n这组合并 $C$ 违反线性扫描可行性约束，当且仅当存在至少一个点 $t$，使得新的活跃数超过 $k$。这给出了违规的必要且充分条件：\n$$ \\exists t \\text{ such that } L_{base}(t) + \\sum_{(u,v) \\in C} \\mathbb{I}(t \\in [\\min(e_u, e_v), \\max(s_u, s_v))) > k $$\n等价地，一组合并 $C$ 是有效的，当且仅当对于所有点 $t$：\n$$ L_{base}(t) + \\sum_{(u,v) \\in C} \\mathbb{I}(t \\in [\\min(e_u, e_v), \\max(s_u, s_v))) \\le k $$\n\n### 第二部分：应用于具体实例\n\n我们将推导出的条件应用于给定的问题实例。\n可用寄存器数量为 $k=3$。\n基线活跃区间为：$x_1: [1,3)$, $x_2: [2,5)$, $x_3: [4,7)$, $x_4: [6,9)$, $x_5: [8,11)$, $x_6: [10,13)$, 和 $y_1: [3,10)$。\n\n首先，我们计算相关点的基线活跃数 $L_{base}(t)$。活跃数仅在区间的端点处发生变化。\n- 对于 $t \\in [1,2)$：$\\{x_1\\}$ 是活跃的。$L_{base}(t)=1$。\n- 对于 $t \\in [2,3)$：$\\{x_1, x_2\\}$ 是活跃的。$L_{base}(t)=2$。\n- 对于 $t \\in [3,4)$：$\\{x_2, y_1\\}$ 是活跃的。$L_{base}(t)=2$。\n- 对于 $t \\in [4,5)$：$\\{x_2, y_1, x_3\\}$ 是活跃的。$L_{base}(t)=3$。\n- 对于 $t \\in [5,6)$：$\\{y_1, x_3\\}$ 是活跃的。$L_{base}(t)=2$。\n- 对于 $t \\in [6,7)$：$\\{y_1, x_3, x_4\\}$ 是活跃的。$L_{base}(t)=3$。\n- 对于 $t \\in [7,8)$：$\\{y_1, x_4\\}$ 是活跃的。$L_{base}(t)=2$。\n- 对于 $t \\in [8,9)$：$\\{y_1, x_4, x_5\\}$ 是活跃的。$L_{base}(t)=3$。\n- 对于 $t \\in [9,10)$：$\\{y_1, x_5\\}$ 是活跃的。$L_{base}(t)=2$。\n- 对于 $t \\in [10,11)$：$\\{x_5, x_6\\}$ 是活跃的。$L_{base}(t)=2$。\n- 对于 $t \\in [11,13)$：$\\{x_6\\}$ 是活跃的。$L_{base}(t)=1$。\n\n基线配置是可行的，因为 $\\max_t L_{base}(t) = 3 = k$。\n\n用于合并的候选对及其对应的桥接区间是：\n- $P_1 = (x_1,x_3)$: 桥接区间 $B_1 = [3,4)$。\n- $P_2 = (x_2,x_4)$: 桥接区间 $B_2 = [5,6)$。\n- $P_3 = (x_3,x_5)$: 桥接区间 $B_3 = [7,8)$。\n- $P_4 = (x_4,x_6)$: 桥接区间 $B_4 = [9,10)$。\n- $P_5 = (x_1,x_4)$: 桥接区间 $B_5 = [3,6)$。\n- $P_6 = (x_2,x_5)$: 桥接区间 $B_6 = [5,8)$。\n\n一组合并 $C$ 是有效的，如果 $\\forall t, \\sum_{P_j \\in C} \\mathbb{I}(t \\in B_j) \\le k - L_{base}(t)$。\n项 $R(t) = k - L_{base}(t)$ 表示在点 $t$ 增加寄存器压力的可用“裕量”。\n我们有 $k=3$。关键区域是 $L_{base}(t)=3$ 的地方，因为那里的裕量 $R(t)=0$。任何在这些区域增加活跃性的合并都是无效的。\n高压区间是：\n- $H_1 = [4,5)$，此处 $L_{base}(t)=3$，因此 $R(t)=0$。\n- $H_2 = [6,7)$，此处 $L_{base}(t)=3$，因此 $R(t)=0$。\n- $H_3 = [8,9)$，此处 $L_{base}(t)=3$，因此 $R(t)=0$。\n\n对于任何有效的合并集合 $C$，我们必须有 $\\sum_{P_j \\in C} \\mathbb{I}(t \\in B_j) = 0$ 对于任何 $t \\in H_1 \\cup H_2 \\cup H_3$。这意味着与所选对关联的桥接区间不能与这些高压区域重叠。\n\n让我们检查候选对：\n- $P_5$: 其桥接区间 $B_5 = [3,6)$ 包含区间 $[4,5) = H_1$。因此，合并 $P_5$ 是无效的，因为对于任何 $t \\in [4,5)$，$L_{new}(t) = L_{base}(t) + 1 = 3 + 1 = 4 > k$。所以 $P_5$ 不能在任何有效集合中。\n- $P_6$: 其桥接区间 $B_6 = [5,8)$ 包含区间 $[6,7) = H_2$。因此，合并 $P_6$ 是无效的，因为对于任何 $t \\in [6,7)$，$L_{new}(t) = L_{base}(t) + 1 = 3 + 1 = 4 > k$。所以 $P_6$ 不能在任何有效集合中。\n\n必须排除对 $P_5$ 和 $P_6$。因此，最大合并数至多是剩余集合 $\\{P_1, P_2, P_3, P_4\\}$ 的大小。该集合的大小为 $4$。让我们测试是否可以同时合并所有四对 $P_1, P_2, P_3, P_4$。\n令 $C' = \\{P_1, P_2, P_3, P_4\\}$。桥接区间为 $B_1=[3,4)$, $B_2=[5,6)$, $B_3=[7,8)$, $B_4=[9,10)$。\n\n这四个桥接区间互不相交。因此，对于任何点 $t$，最多只有一个桥接区间是活跃的。这意味着总活跃数增量 $\\Delta_{C'}(t) = \\sum_{j=1}^4 \\mathbb{I}(t \\in B_j)$ 要么是 $0$ 要么是 $1$。\n有效性条件 $L_{base}(t) + \\Delta_{C'}(t) \\le 3$ 仅在存在某个 $t$ 使得 $\\Delta_{C'}(t)=1$ 且 $L_{base}(t)=3$ 时才会被违反。\n这意味着我们需要检查桥接区间 $B_1, B_2, B_3, B_4$ 中是否有任何一个与高压区域 $H_1, H_2, H_3$ 重叠。\n- $B_1 = [3,4)$，不与 $[4,5), [6,7), [8,9)$ 重叠。\n- $B_2 = [5,6)$，不与 $[4,5), [6,7), [8,9)$ 重叠。\n- $B_3 = [7,8)$，不与 $[4,5), [6,7), [8,9)$ 重叠。\n- $B_4 = [9,10)$，不与 $[4,5), [6,7), [8,9)$ 重叠。\n\n集合 $C'$ 中各对的桥接区间均未穿过最大压力的区域。\n为了完全严谨，我们检查每个桥接区间内的压力：\n- 对于 $t \\in B_1=[3,4)$，$L_{base}(t)=2$。$L_{new}(t) = 2+1=3 \\le k$。有效。\n- 对于 $t \\in B_2=[5,6)$，$L_{base}(t)=2$。$L_{new}(t) = 2+1=3 \\le k$。有效。\n- 对于 $t \\in B_3=[7,8)$，$L_{base}(t)=2$。$L_{new}(t) = 2+1=3 \\le k$。有效。\n- 对于 $t \\in B_4=[9,10)$，$L_{base}(t)=2$。$L_{new}(t) = 2+1=3 \\le k$。有效。\n\n由于所有条件都得到满足，集合 $C' = \\{P_1, P_2, P_3, P_4\\}$ 是一个有效的可同时合并的集合。该集合的大小为 $4$。因为我们已经穷尽了所有可能性，并且不能包含 $P_5$ 或 $P_6$，所以可以同时合并的最大对数是 $4$。",
            "answer": "$$\\boxed{4}$$"
        },
        {
            "introduction": "编译器中一个常见的副本指令来源是在解构静态单赋值（SSA）形式时，尤其是在处理控制流汇合点的 $\\phi$ 函数时。这会产生复杂的并行副本集，它们可能形成难以用顺序指令实现的依赖环。本实践问题探讨了如何通过活动性分析指导下的策略性合并来打破这些依赖环，从而简化代码生成，并可能减少对临时变量的需求。",
            "id": "3671347",
            "problem": "您正在优化在控制流连接点消除静态单赋值（SSA）形式的 $\\phi$ 函数时产生的寄存器到寄存器移动。在块边界处的 $\\phi$ 消除会产生一组单一的同时并行拷贝，其精确语义为所有右侧值都从同一抽象点的前状态读取，而所有左侧值都写入后状态，因此：\n- 并行拷贝集为 $P=\\{a \\rightarrow b,\\ b \\rightarrow c,\\ c \\rightarrow a\\}$。\n- 一个合法的实现必须使用一个有限的普通移动序列来实现 $P$，其中每个普通移动 $x \\leftarrow y$ 都会用 $y$ 的当前值破坏性地覆盖 $x$。\n- 由于普通移动不是同时发生的，除非使用新的临时变量进行额外的重命名，否则覆盖操作可能会破坏（clobber）所需的源值。\n\n在对 $P$ 进行线性化之前，您被允许执行拷贝合并（copy coalescing）：\n- 两个名称可以被合并（即合并以分配到相同的位置），当且仅当它们的生存期（live ranges）不重叠，也就是说，它们在干涉图中不干涉。\n- 合并具有传递性：如果 $x$ 与 $y$ 合并，并且 $y$ 与 $z$ 合并，那么 $x$ 也与 $z$ 合并，并且一个合并集内的每一对都必须保持两两不干涉。\n\n假设有以下活性事实（liveness facts），这些事实与 $P$ 执行边界处的标准 SSA 活性相符：\n- 在 $\\{a,b,c\\}$ 中唯一的干涉对是 $\\{a,c\\}$，这意味着 $a$ 和 $c$ 在并行拷贝点之外的某个点具有重叠的生存期。因此 $a$ 和 $c$ 不能被合并。\n- 对 $\\{a,b\\}$ 和 $\\{b,c\\}$ 是不干涉的，因此它们中的任何一个都可以单独合并，但它们不能同时被合并，因为这将意味着 $a$ 和 $c$ 被间接合并，从而违反了传递性的不干涉规则。\n\n您可以根据需要引入任意数量的新临时变量，但您的目标是最小化其数量。在这些约束条件下，在执行您选择的任何合法合并操作后，将并行拷贝集 $P$ 实现为有效的普通移动序列所需的最少新临时变量数量是多少？请以单个整数形式给出答案。不需要四舍五入，也不涉及单位。",
            "solution": "该问题要求找出实现一个给定的并行拷贝集所需的最少新临时变量数量，其中可能在实现前应用了拷贝合并优化。\n\n初始并行拷贝集为 $P = \\{a \\rightarrow b, b \\rightarrow c, c \\rightarrow a\\}$。该表示法意味着我们必须同时执行赋值操作 $b \\leftarrow (\\text{旧 } a)$、$c \\leftarrow (\\text{旧 } b)$ 和 $a \\leftarrow (\\text{旧 } c)$。为了分析依赖关系，我们可以将其建模为一个有向图，其中一条边 $u \\rightarrow v$ 表示变量 $u$ 的值必须被拷贝到变量 $v$。$P$ 的图以变量 $\\{a, b, c\\}$ 为节点，以拷贝关系为边。这形成了一个长度为 3 的有向环：$a \\rightarrow b \\rightarrow c \\rightarrow a$。\n\n编译器理论中关于并行拷贝线性化的一个基本结论指出，任何形成有向无环图（DAG）的拷贝集都可以通过一系列普通移动来实现，而无需任何临时变量。然而，如果图中包含一个或多个环，则每个环至少需要一个临时变量来打破循环依赖。一个长度为 $k \\ge 2$ 的简单环可以使用一个临时变量来打破。\n\n我们将分析在问题陈述所允许的所有合法优化场景下所需的临时变量数量。\n\n情况 1：不执行拷贝合并。\n并行拷贝集保持为 $P = \\{a \\rightarrow b, b \\rightarrow c, c \\rightarrow a\\}$，这是一个 3-环。为了用顺序的、破坏性的移动来实现它，我们必须在其中一个值被覆盖之前保存它。设 $t$ 为一个新的临时变量。一个可能的有效普通移动序列是：\n1. $t \\leftarrow a$（保存 $a$ 的值）\n2. $a \\leftarrow c$（$a$ 的旧值现在被覆盖了，但我们已将其保存在 $t$ 中）\n3. $c \\leftarrow b$\n4. $b \\leftarrow t$（将保存的 $a$ 的值赋给 $b$）\n这个序列正确地实现了 $P$，并且恰好需要一个临时变量。\n\n情况 2：执行合法的拷贝合并。\n问题提供了活性信息，这些信息约束了哪些变量可以被合并。合并意味着两个变量被分配到同一个物理位置（例如，同一个寄存器）。这仅在它们的生存期不重叠，即它们不干涉时才是合法的。\n给定的干涉事实是：\n- 对 $\\{a, c\\}$ 干涉，所以它们不能被合并。\n- 对 $\\{a, b\\}$ 不干涉。\n- 对 $\\{b, c\\}$ 不干涉。\n\n我们还被告知，我们不能同时合并 $\\{a, b\\}$ 和 $\\{b, c\\}$，因为合并是传递性的。如果我们合并了 $\\{a, b\\}$ 和 $\\{b, c\\}$，这将意味着 $a$ 和 $c$ 也被合并，而这是被禁止的。因此，我们有两个不同的合并选择。\n\n子情况 2a：合并对 $\\{a, b\\}$。\n我们将 $a$ 和 $b$ 合并成一个单一变量。这可以通过在并行拷贝集 $P$ 中用 $a$ 替换所有 $b$ 的实例来建模。\n- 拷贝 $a \\rightarrow b$ 变成 $a \\rightarrow a$，这是一个空操作（no-op），因此被消除。\n- 拷贝 $b \\rightarrow c$ 变成 $a \\rightarrow c$。\n- 拷贝 $c \\rightarrow a$ 保持不变。\n结果得到的并行拷贝集是 $P' = \\{a \\rightarrow c, c \\rightarrow a\\}$。这表示 $a$ 和 $c$ 之间的一次交换。依赖图是一个 2-环：$a \\rightarrow c \\rightarrow a$。与任何长度为 $k \\ge 2$ 的环一样，这需要一个临时变量来实现。一个有效的序列是：\n1. $t \\leftarrow a$\n2. $a \\leftarrow c$\n3. $c \\leftarrow t$\n这个实现需要一个临时变量。\n\n子情况 2b：合并对 $\\{b, c\\}$。\n我们合并 $b$ 和 $c$，这可以通过用 $b$ 替换所有 $c$ 的实例来建模。\n- 拷贝 $a \\rightarrow b$ 保持不变。\n- 拷贝 $b \\rightarrow c$ 变成 $b \\rightarrow b$，这是一个空操作，因此被消除。\n- 拷贝 $c \\rightarrow a$ 变成 $b \\rightarrow a$。\n结果得到的并行拷贝集是 $P'' = \\{a \\rightarrow b, b \\rightarrow a\\}$。这表示 $a$ 和 $b$ 之间的一次交换。依赖图是一个 2-环：$a \\rightarrow b \\rightarrow a$。这也需要一个临时变量来实现：\n1. $t \\leftarrow a$\n2. $a \\leftarrow b$\n3. $b \\leftarrow t$\n这个实现也需要一个临时变量。\n\n结果总结：\n- 不进行合并：需要 $1$ 个临时变量。\n- 合并 $\\{a, b\\}$：需要 $1$ 个临时变量。\n- 合并 $\\{b, c\\}$：需要 $1$ 个临时变量。\n\n所有可能的合法选择（包括什么都不做）都导致需要恰好一个临时变量的情况。所需的最少临时变量数量是通过在所有这些结果中取最小值来找到的。由于所有结果都要求 1 个临时变量，所以最小值是 1。循环依赖无法通过允许的合并操作来消除，尽管它可以从一个 3-环减少到一个 2-环。",
            "answer": "$$\n\\boxed{1}\n$$"
        },
        {
            "introduction": "虽然副本合并可以消除移动指令，但延长变量的生命周期也可能带来负面影响，例如导致寄存器溢出。这个练习提出了一个真实的场景，你必须进行成本效益分析，权衡消除热路径上的副本所带来的收益与冷路径上的设置成本以及增加的寄存器压力所导致的溢出开销。它强调了最优编译决策通常依赖于量化的、基于性能剖析的启发式方法，而非一成不变的规则。",
            "id": "3671373",
            "problem": "考虑一个静态单赋值 (SSA) 形式（Static Single Assignment (SSA)）的中间表示 (IR)，其中一个控制流汇合点形成一个 $\\phi$-节点，该节点合并一个常量和一个变量：\n- 前驱 $P_v$（热前驱）计算一个变量 $v$。\n- 前驱 $P_c$（冷前驱）提供一个常量 $c$。\n- 在汇合块 $J$ 中，我们有 $x \\leftarrow \\phi(c, v)$。\n- 块 $J$ 接着执行一个包含 $u$ 次 $x$ 使用的直线序列（无中间的控制流），然后 $x$ 死亡。\n\n假设有以下目标成本和画像 (profile) 模型：\n- 从 $P_v$ 到 $J$ 的边每次运行执行 $f_v$ 次，其中 $f_v = 1000$。\n- 从 $P_c$ 到 $J$ 的边每次运行执行 $f_c$ 次，其中 $f_c = 10$。\n- 汇合块 $J$ 每次运行执行 $f_J = f_v + f_c$ 次，其中 $f_J = 1010$。\n- $J$ 中 $x$ 的使用次数为 $u = 3$。\n- 寄存器到寄存器的复制成本为 $c_{\\mathrm{mov}} = 1$（例如，如果 $x$ 未与 $v$ 合并，则在热边 $v \\to x$ 上降低一个 $\\phi$ 并行副本的成本）。\n- 将 $c$ 物化到寄存器中（立即数移动）的成本为 $c_{\\mathrm{imm}} = 1$。\n- 当值为常量 $c$ 时，$J$ 中每个使用 $x$ 的指令都可以等效地使用立即数形式，相对于使用寄存器操作数，没有额外的延迟或代码大小惩罚，即，与从寄存器使用 $x$ 相比，在一次使用中将 $c$ 作为立即数使用的额外成本为 $0$。\n- 在不合并的情况下，分配器可以在 $J$ 中容纳所有活跃范围而无需溢出。如果我们将 $x$ 与 $v$ 合并，$v$ 的活跃范围将扩展以覆盖 $J$ 中的所有 $u$ 次使用，这将使 $J$ 中的瞬时寄存器压力增加 $1$，并迫使每次执行 $J$ 时都恰好发生一次溢出-重载对；每次溢出-重载对的动态成本为 $c_{\\mathrm{spill}} = 3$。\n\n考虑两种实现策略：\n- 策略 $\\mathsf{COAL}$：基于 SSA 的副本合并将 $x$ 和 $v$ 分配给同一个寄存器（将常量载体与变量合并）。这消除了热边 $P_v \\to J$ 上的副本。在冷边 $P_c \\to J$ 上，我们必须在该边每次执行时将 $c$ 物化到 $v$ 的寄存器中一次。由于 $v$ 在 $J$ 中的活跃范围延长，每次执行 $J$ 都会发生一次溢出-重载对。\n- 策略 $\\mathsf{REMAT}$：不合并 $x$ 和 $v$。通过在热边插入一个副本 $v \\to x$ 来降低 $\\phi$，而在冷边，不将 $c$ 移动到 $x$ 中；相反，在 $J$ 的每次使用时，通过为那些来自 $P_c$ 的动态执行选择指令的立即数操作数形式来重新物化 $c$。在此策略下，$J$ 中的活跃集合相对于基线保持不变，并且不会发生额外的溢出。\n\n根据上述模型，以下哪项是对哪种策略能最小化预期动态成本的正确评估，以及为什么？\n\nA. 选择 $\\mathsf{COAL}$。其总预期成本为 $f_c \\cdot c_{\\mathrm{imm}} = 10$，因为它移除了 $f_v \\cdot c_{\\mathrm{mov}}$ 的热边副本；溢出成本不变，因为 $v$ 在 $J$ 中已经是活跃的。\n\nB. 选择 $\\mathsf{REMAT}$。其总预期成本为 $f_v \\cdot c_{\\mathrm{mov}} = 1000$，没有溢出开销，这小于 $\\mathsf{COAL}$ 的成本 $f_c \\cdot c_{\\mathrm{imm}} + f_J \\cdot c_{\\mathrm{spill}} = 10 + 1010 \\cdot 3$。\n\nC. 当且仅当 $c$ 适合指令的立即数字段时，才选择 $\\mathsf{COAL}$；既然它适合，$\\mathsf{COAL}$ 在这种情况下严格优于 $\\mathsf{REMAT}$。\n\nD. 两种策略的成本基本相等，因为在 $\\phi$-节点之后只有 $u=3$ 次对 $x$ 的使用，因此在任何路径上的差异都可以忽略不计。",
            "solution": "我们从静态单赋值 (SSA) 的核心定义和标准的 $\\phi$-消除开始。在汇合点的 $\\phi$-节点 $x \\leftarrow \\phi(c, v)$ 的语义是，如果控制流来自 $P_c$，则 $x$ 的值等于 $c$；如果控制流来自 $P_v$，则 $x$ 的值等于 $v$。在传统的降低（lowering）中，这变成了一组放置在输入边上的并行副本：在 $P_v \\to J$ 上，是一个副本 $v \\to x$；在 $P_c \\to J$ 上，是一个将 $c$ 产生到 $x$ 中的定义（通常是立即数移动）。基于 SSA 的副本合并尝试将相同的物理寄存器分配给 $x$ 和 $v$ 以消除热边副本，但这会扩展 $v$ 的活跃范围，使其跨越 $J$，从而可能增加干扰并导致溢出。\n\n根据给定的成本模型，我们比较两种策略的预期动态成本。\n\n定义各量：\n- $f_v = 1000$， $f_c = 10$， $f_J = 1010$。\n- $u = 3$。\n- $c_{\\mathrm{mov}} = 1$， $c_{\\mathrm{imm}} = 1$， $c_{\\mathrm{spill}} = 3$。\n\n计算每种策略的成本。\n\n1) 策略 $\\mathsf{COAL}$：\n- 热边副本消除：通过将 $x$ 与 $v$ 合并，边 $P_v \\to J$ 上的副本 $v \\to x$ 被移除。移除的成本是 $f_v \\cdot c_{\\mathrm{mov}} = 1000 \\cdot 1 = 1000$。然而，我们将计算绝对产生的成本并进行比较；在一个策略中消除一个成本等同于在这里不支付它。\n- 冷边物化：为确保 $x$（现在与 $v$ 是同一个寄存器）在冷边上持有 $c$，我们必须在 $P_c \\to J$ 上插入一个将 $c$ 移动到 $v$ 寄存器的立即数移动指令。这产生的成本是 $f_c \\cdot c_{\\mathrm{imm}} = 10 \\cdot 1 = 10$。\n- 因活跃范围扩展导致的溢出-重载：合并将 $v$ 的活跃范围扩展到 $J$ 中的所有 $u$ 次使用，增加了瞬时压力，并且根据前提，每次执行 $J$ 都会强制发生一次溢出-重载对。动态成本为 $f_J \\cdot c_{\\mathrm{spill}} = 1010 \\cdot 3 = 3030$。\n- $\\mathsf{COAL}$ 的总成本：\n$$\nC_{\\mathsf{COAL}} = f_c \\cdot c_{\\mathrm{imm}} + f_J \\cdot c_{\\mathrm{spill}} = 10 + 3030 = 3040.\n$$\n\n2) 策略 $\\mathsf{REMAT}$：\n- 热边副本保留：不进行合并，边 $P_v \\to J$ 必须执行副本 $v \\to x$，成本为 $f_v \\cdot c_{\\mathrm{mov}} = 1000 \\cdot 1 = 1000$。\n- 通过在使用点重新物化来处理冷边：不在 $P_c \\to J$ 上定义 $x$；相反，当动态流来自 $P_c$ 时，$J$ 中的每次使用都选择立即数形式。根据前提，选择立即数形式相对于使用寄存器没有额外的成本，因此冷边的贡献为 $0$，并且除了基本操作外，$J$ 中没有额外的工作。\n- 寄存器压力：由于不将 $v$ 的活跃范围扩展到 $J$ 中，因此没有溢出。因此溢出成本为 $0$。\n- $\\mathsf{REMAT}$ 的总成本：\n$$\nC_{\\mathsf{REMAT}} = f_v \\cdot c_{\\mathrm{mov}} = 1000.\n$$\n\n比较：\n$C_{\\mathsf{REMAT}} = 1000$ 对比 $C_{\\mathsf{COAL}} = 3040$,\n因此在给定模型下，$\\mathsf{REMAT}$ 严格更优。\n\n基于原则的解释：从 SSA 和干扰的第一性原理出发，如果热路径副本节省的成本超过了 (i) 任何冷边常量物化成本和 (ii) 因活跃范围扩展引起的任何溢出开销的总和，那么合并是有益的。用符号代数地表示，\n$$\n\\text{如果} \\quad f_v \\cdot c_{\\mathrm{mov}} > f_c \\cdot c_{\\mathrm{imm}} + f_J \\cdot c_{\\mathrm{spill}} \\quad \\text{则合并是有益的。}\n$$\n在这里，我们有\n$$\nf_v \\cdot c_{\\mathrm{mov}} = 1000, \\quad f_c \\cdot c_{\\mathrm{imm}} + f_J \\cdot c_{\\mathrm{spill}} = 10 + 3030 = 3040,\n$$\n因此不等式不成立，这有利于重新物化。\n\n逐项分析：\n- 选项A：不正确。它忽略了规定的溢出-重载成本 $f_J \\cdot c_{\\mathrm{spill}} = 3030$。声称溢出成本不变与前提相矛盾，前提是合并会提高压力并强制每次执行 $J$ 时都发生一次溢出-重载。\n- 选项B：正确。它正确地计算了 $C_{\\mathsf{REMAT}} = f_v \\cdot c_{\\mathrm{mov}} = 1000$，并将其与 $C_{\\mathsf{COAL}} = f_c \\cdot c_{\\mathrm{imm}} + f_J \\cdot c_{\\mathrm{spill}} = 10 + 1010 \\cdot 3 = 3040$ 进行比较，并得出 $\\mathsf{REMAT}$ 更好的结论。\n- 选项C：不正确。$c$ 是否适合立即数字段会影响重新物化的可行性和成本，但这本身并不意味着合并策略占优。即使立即数可用，溢出项 $f_J \\cdot c_{\\mathrm{spill}}$ 也可能使热边副本节省的成本相形见绌。\n- 选项D：不正确。使用次数 $u$ 不是这个模型中的决定性因素；主导成本是热边副本频率 $f_v$ 和溢出开销 $f_J \\cdot c_{\\mathrm{spill}}$。在这里，尽管 $u = 3$，两种策略的预期动态成本差异巨大。",
            "answer": "$$\\boxed{B}$$"
        }
    ]
}