{
    "hands_on_practices": [
        {
            "introduction": "可极化嵌入方法的核心在于计算分子环境如何响应量子力学（QM）区域的电荷分布而产生自洽的诱导偶极。本次实践将指导你实现一个基础的PE模型，用于计算QM/MM体系中的极化能。通过模拟不同基组对QM区域原子部分电荷的影响，你将亲身体验到QM计算的精度如何直接传递并影响到我们对体系极化相互作用的描述。",
            "id": "2460312",
            "problem": "要求您实现一个最小化可极化嵌入（Polarizable Embedding, PE）模型，以量化当用于量子力学（Quantum Mechanics, QM）区域的基组扩大时，总的量子力学/分子力学（Quantum Mechanics/Molecular Mechanics, QM/MM）极化能如何变化。分子力学（Molecular Mechanics, MM）环境由可极化的点偶极子表示。所有计算都必须以原子单位进行，距离单位为 bohr，能量单位为 Hartree，最终数值答案必须以 Hartree 表示，并四舍五入到六位小数。\n\nQM 区域由两个位于固定位置的点电荷组成，代表一个沿 $x$ 轴的双原子分子。设其位置为 $\\mathbf{R}_\\mathrm{H}=(0.00,0.00,0.00)\\ \\mathrm{bohr}$ 和 $\\mathbf{R}_\\mathrm{Cl}=(2.41,0.00,0.00)\\ \\mathrm{bohr}$。分子力学（MM）环境由三个位于固定位置的可极化位点组成，其位置为 $\\mathbf{r}_1=(0.00,5.00,0.00)\\ \\mathrm{bohr}$、$\\mathbf{r}_2=(5.00,0.00,3.00)\\ \\mathrm{bohr}$ 和 $\\mathbf{r}_3=(-4.00,-3.00,1.00)\\ \\mathrm{bohr}$，各向同性极化率分别为 $\\alpha_1=0.80\\ \\mathrm{bohr}^3$、$\\alpha_2=0.60\\ \\mathrm{bohr}^3$ 和 $\\alpha_3=1.00\\ \\mathrm{bohr}^3$。\n\n由 QM 点电荷在 MM 位点 $i$ 处产生的外部电场为\n$$\n\\mathbf{E}_i^{\\mathrm{ext}}=\\sum_{a=1}^{2} q_a \\frac{\\mathbf{r}_i-\\mathbf{R}_a}{\\lVert \\mathbf{r}_i-\\mathbf{R}_a\\rVert^3},\n$$\n其中 $q_a$ 和 $\\mathbf{R}_a$ 分别是 QM 位点 $a$ 的电荷和位置。\n\n每个 MM 位点 $i$ 带有一个感生偶极子 $\\boldsymbol{\\mu}_i$，它对该位点的总电场作出线性响应：\n$$\n\\boldsymbol{\\mu}_i=\\alpha_i\\,\\mathbf{E}_i^{\\mathrm{tot}}, \\quad \\mathbf{E}_i^{\\mathrm{tot}}=\\mathbf{E}_i^{\\mathrm{ext}}+\\sum_{j\\ne i}\\mathbf{T}_{ij}\\,\\boldsymbol{\\mu}_j,\n$$\n其中偶极-偶极相互作用张量为\n$$\n\\mathbf{T}_{ij}=\\frac{3\\,\\mathbf{r}_{ij}\\mathbf{r}_{ij}^\\top-\\lVert \\mathbf{r}_{ij}\\rVert^2\\mathbf{I}_3}{\\lVert \\mathbf{r}_{ij}\\rVert^5}, \\quad \\mathbf{r}_{ij}=\\mathbf{r}_i-\\mathbf{r}_j,\n$$\n且 $\\mathbf{I}_3$ 是 $3\\times 3$ 单位矩阵。感生偶极子通过这些方程自洽地确定。\n\n一旦确定了感生偶极子，MM 环境在 QM 电荷场中的极化能为\n$$\nE_{\\mathrm{pol}}=-\\frac{1}{2}\\sum_{i=1}^{3}\\boldsymbol{\\mu}_i\\cdot\\mathbf{E}_i^{\\mathrm{ext}} \\quad \\text{(Hartree)}.\n$$\n\n为模拟 QM 基组质量提升带来的效应，请使用以下几组 QM 点电荷 $(q_{\\mathrm{H}},q_{\\mathrm{Cl}})$，它们代表了合理的依赖于基组的电荷划分，同时保持 QM 位置如上所述固定不变：\n- 对于标记为 “STO-3G” 的最小基组：$(q_{\\mathrm{H}},q_{\\mathrm{Cl}})=(+0.10,-0.10)$。\n- 对于标记为 “6-31G*” 的裂价极化基组：$(q_{\\mathrm{H}},q_{\\mathrm{Cl}})=(+0.18,-0.18)$。\n- 对于标记为 “aug-cc-pVDZ” 的增广相关一致性基组：$(q_{\\mathrm{H}},q_{\\mathrm{Cl}})=(+0.24,-0.24)$。\n\n您的程序必须为以下四个测试用例计算 $E_{\\mathrm{pol}}$：\n1. “STO-3G” 电荷，$\\alpha_1=0.80$, $\\alpha_2=0.60$, $\\alpha_3=1.00$。\n2. “6-31G*” 电荷，$\\alpha_1=0.80$, $\\alpha_2=0.60$, $\\alpha_3=1.00$。\n3. “aug-cc-pVDZ” 电荷，$\\alpha_1=0.80$, $\\alpha_2=0.60$, $\\alpha_3=1.00$。\n4. 用于覆盖率的边界情况：“aug-cc-pVDZ” 电荷，但 $\\alpha_1=0.00$, $\\alpha_2=0.00$, $\\alpha_3=0.00$。\n\n所有位置以 bohr 为单位，所有电荷以基本电荷 $e$ 为单位，所有极化率以 $\\mathrm{bohr}^3$ 为单位。请将最终能量以 Hartree 表示，并四舍五入到六位小数。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，顺序与测试用例一致 $\\left[\\text{case }1,\\text{case }2,\\text{case }3,\\text{case }4\\right]$，例如 $[\\dots]$，其中每个条目都是一个以 Hartree 为单位、四舍五入到六位小数的浮点数。\n\n最后，在生成数值输出后，请确保您的实现能够内在地反映并允许解释随基组变化的趋势：随着 QM 部分电荷的量值随基组质量的提高而增加，感生电场以及 $E_{\\mathrm{pol}}$ 的量值预计会相应地发生变化。",
            "solution": "问题陈述已经过严格验证，并被认定为有效。\n\n**1. 已知条件提取：**\n- QM 区域：两个点电荷。\n  - 电荷 $a=1$ (H) 的位置：$\\mathbf{R}_{\\mathrm{H}} = (0.00, 0.00, 0.00)\\ \\mathrm{bohr}$。\n  - 电荷 $a=2$ (Cl) 的位置：$\\mathbf{R}_{\\mathrm{Cl}} = (2.41, 0.00, 0.00)\\ \\mathrm{bohr}$。\n- MM 区域：三个可极化位点。\n  - 位点 $i=1$：$\\mathbf{r}_1 = (0.00, 5.00, 0.00)\\ \\mathrm{bohr}$，$\\alpha_1 = 0.80\\ \\mathrm{bohr}^3$。\n  - 位点 $i=2$：$\\mathbf{r}_2 = (5.00, 0.00, 3.00)\\ \\mathrm{bohr}$，$\\alpha_2 = 0.60\\ \\mathrm{bohr}^3$。\n  - 位点 $i=3$：$\\mathbf{r}_3 = (-4.00, -3.00, 1.00)\\ \\mathrm{bohr}$，$\\alpha_3 = 1.00\\ \\mathrm{bohr}^3$。\n- QM 电荷组：\n  - “STO-3G”：$(q_{\\mathrm{H}}, q_{\\mathrm{Cl}}) = (+0.10, -0.10)\\ e$。\n  - “6-31G*”：$(q_{\\mathrm{H}}, q_{\\mathrm{Cl}}) = (+0.18, -0.18)\\ e$。\n  - “aug-cc-pVDZ”：$(q_{\\mathrm{H}}, q_{\\mathrm{Cl}}) = (+0.24, -0.24)\\ e$。\n- 基本方程（以原子单位，其中 $e=1$, $4\\pi\\epsilon_0=1$）：\n  - 外部电场：$\\mathbf{E}_i^{\\mathrm{ext}} = \\sum_{a=1}^{2} q_a \\frac{\\mathbf{r}_i - \\mathbf{R}_a}{\\lVert \\mathbf{r}_i - \\mathbf{R}_a\\rVert^3}$。\n  - 感生偶极子响应：$\\boldsymbol{\\mu}_i = \\alpha_i \\mathbf{E}_i^{\\mathrm{tot}} = \\alpha_i \\left( \\mathbf{E}_i^{\\mathrm{ext}} + \\sum_{j \\ne i} \\mathbf{T}_{ij} \\boldsymbol{\\mu}_j \\right)$。\n  - 偶极-偶极相互作用张量：$\\mathbf{T}_{ij} = \\frac{3\\,\\mathbf{r}_{ij}\\mathbf{r}_{ij}^\\top - \\lVert \\mathbf{r}_{ij}\\rVert^2\\mathbf{I}_3}{\\lVert \\mathbf{r}_{ij}\\rVert^5}$，其中 $\\mathbf{r}_{ij} = \\mathbf{r}_i - \\mathbf{r}_j$。\n  - 极化能：$E_{\\mathrm{pol}} = -\\frac{1}{2}\\sum_{i=1}^{3}\\boldsymbol{\\mu}_i \\cdot \\mathbf{E}_i^{\\mathrm{ext}}$。\n- 测试用例：\n  1. “STO-3G” 电荷，标准极化率。\n  2. “6-31G*” 电荷，标准极化率。\n  3. “aug-cc-pVDZ” 电荷，标准极化率。\n  4. “aug-cc-pVDZ” 电荷，零极化率 $(\\alpha_1, \\alpha_2, \\alpha_3) = (0.00, 0.00, 0.00)\\ \\mathrm{bohr}^3$。\n- 输出要求：一个用方括号括起来的逗号分隔列表，包含以 Hartree 为单位、四舍五入到六位小数的 $E_{\\mathrm{pol}}$ 值。\n\n**2. 验证结论：**\n该问题是**有效的**。它在科学上基于经典静电学和 QM/MM 可极化嵌入框架的原理。问题提法清晰，提供了一套完整且一致的数据和方程，可以导出一个唯一的解。对于一个简化的分子模型来说，其参数是物理上合理的。该问题是客观且可形式化的。\n\n**3. 求解方法：**\n核心任务是确定三个 MM 位点的自洽感生偶极子 $\\boldsymbol{\\mu}_i$。感生偶极子的控制方程是一个耦合线性方程组。\n对于每个 MM 位点 $i$，我们有：\n$$ \\boldsymbol{\\mu}_i = \\alpha_i \\left( \\mathbf{E}_i^{\\mathrm{ext}} + \\sum_{j \\neq i} \\mathbf{T}_{ij} \\boldsymbol{\\mu}_j \\right) $$\n该方程可以重新排列以分离偶极子项：\n$$ \\frac{1}{\\alpha_i} \\boldsymbol{\\mu}_i - \\sum_{j \\neq i} \\mathbf{T}_{ij} \\boldsymbol{\\mu}_j = \\mathbf{E}_i^{\\mathrm{ext}} $$\n这构成了一个包含 $N_{\\mathrm{MM}} = 3$ 个矢量方程的系统，等价于一个包含 $3 \\times N_{\\mathrm{MM}} = 9$ 个标量线性方程的系统。我们可以将其表示为紧凑的矩阵形式：\n$$ \\mathbf{A} \\boldsymbol{\\mu} = \\mathbf{E}^{\\mathrm{ext}} $$\n这里，$\\boldsymbol{\\mu}$ 和 $\\mathbf{E}^{\\mathrm{ext}}$ 是通过连接每个位点的 $3 \\times 1$ 矢量构建的 $9 \\times 1$ 超矢量：\n$$ \\boldsymbol{\\mu} = \\begin{pmatrix} \\boldsymbol{\\mu}_1 \\\\ \\boldsymbol{\\mu}_2 \\\\ \\boldsymbol{\\mu}_3 \\end{pmatrix}, \\quad \\mathbf{E}^{\\mathrm{ext}} = \\begin{pmatrix} \\mathbf{E}_1^{\\mathrm{ext}} \\\\ \\mathbf{E}_2^{\\mathrm{ext}} \\\\ \\mathbf{E}_3^{\\mathrm{ext}} \\end{pmatrix} $$\n响应矩阵 $\\mathbf{A}$ 是一个 $9 \\times 9$ 的分块矩阵：\n$$ \\mathbf{A} = \\begin{pmatrix}\n\\alpha_1^{-1} \\mathbf{I}_3  & -\\mathbf{T}_{12} & -\\mathbf{T}_{13} \\\\\n-\\mathbf{T}_{21} & \\alpha_2^{-1} \\mathbf{I}_3 & -\\mathbf{T}_{23} \\\\\n-\\mathbf{T}_{31} & -\\mathbf{T}_{32} & \\alpha_3^{-1} \\mathbf{I}_3\n\\end{pmatrix} $$\n其中 $\\mathbf{I}_3$ 是 $3 \\times 3$ 单位矩阵，非对角块 $-\\mathbf{T}_{ij}$ 是偶极-偶极相互作用张量的负值。注意 $\\mathbf{T}_{ij} = \\mathbf{T}_{ji}$，这使得 $\\mathbf{A}$ 成为一个对称矩阵。\n\n求解过程遵循以下步骤：\n1.  **构建相互作用张量：** 对于每对不同的 MM 位点 $(i, j)$，使用给定的公式和位点位置计算 $3 \\times 3$ 张量 $\\mathbf{T}_{ij}$。\n2.  **构建响应矩阵 $\\mathbf{A}$：** 对每个测试用例，组装 $9 \\times 9$ 矩阵 $\\mathbf{A}$。对角线上的 $3 \\times 3$ 块是 $\\alpha_i^{-1} \\mathbf{I}_3$，非对角块是 $-\\mathbf{T}_{ij}$。对于所有 $\\alpha_i = 0$ 的边界情况，该矩阵是病态的。然而，检查原始方程 $\\boldsymbol{\\mu}_i = \\alpha_i \\mathbf{E}_i^{\\mathrm{tot}}$ 可知，如果 $\\alpha_i = 0$，则无论电场如何，$\\boldsymbol{\\mu}_i = \\mathbf{0}$。因此，对于测试用例 4，所有感生偶极子均为零，极化能 $E_{\\mathrm{pol}} = 0$，无需解线性方程组。\n3.  **计算外部电场矢量 $\\mathbf{E}^{\\mathrm{ext}}$：** 对于每个测试用例指定的 QM 电荷 $q_a$，计算每个 MM 位点 $\\mathbf{r}_i$ 处的外部电场矢量 $\\mathbf{E}_i^{\\mathrm{ext}}$。连接这些矢量以形成 $9 \\times 1$ 的超矢量 $\\mathbf{E}^{\\mathrm{ext}}$。\n4.  **求解感生偶极子：** 求解线性系统 $\\mathbf{A} \\boldsymbol{\\mu} = \\mathbf{E}^{\\mathrm{ext}}$ 以找到感生偶极子超矢量 $\\boldsymbol{\\mu}$。这可以使用标准的线性代数求解器高效完成，例如 `numpy.linalg.solve`。\n5.  **计算极化能：** 一旦感生偶极子 $\\boldsymbol{\\mu}$ 和外部电场 $\\mathbf{E}^{\\mathrm{ext}}$ 已知，极化能可作为点积计算：\n    $$ E_{\\mathrm{pol}} = -\\frac{1}{2} \\boldsymbol{\\mu}^\\top \\mathbf{E}^{\\mathrm{ext}} $$\n\n**基组趋势的物理解释：**\n基组序列 “STO-3G” $\\rightarrow$ “6-31G*” $\\rightarrow$ “aug-cc-pVDZ” 对应于量子力学描述灵活性的增加。这种灵活性的增加通常允许更准确地表示电子密度，特别是其响应分子环境和自身内电荷分布而发生的极化。对于如此处所模拟的极性分子，这会导致更大的电荷分离。所提供的电荷量值 $|q|$ 从 $0.10$ 增加到 $0.18$ 再到 $0.24$。\n\n外部电场 $\\mathbf{E}^{\\mathrm{ext}}$ 与 QM 电荷的量值 $|q|$ 成正比。由于响应矩阵 $\\mathbf{A}$ 与 QM 电荷无关，解矢量 $\\boldsymbol{\\mu} = \\mathbf{A}^{-1} \\mathbf{E}^{\\mathrm{ext}}$ 也与 $|q|$ 成正比。\n极化能由 $E_{\\mathrm{pol}} = -\\frac{1}{2} \\boldsymbol{\\mu} \\cdot \\mathbf{E}^{\\mathrm{ext}}$ 给出。由于 $\\boldsymbol{\\mu}$ 和 $\\mathbf{E}^{\\mathrm{ext}}$ 都与 $|q|$ 成正比，因此极化能 $E_{\\mathrm{pol}}$ 与 $|q|^2$ 成正比。\n这种二次方依赖关系意味着，随着 QM 基组的改进和电荷分离 $|q|$ 的增加，极化能的量值 $|E_{\\mathrm{pol}}|$ 将呈二次方增长。这反映了极化程度更高的 QM 区域与可极化 MM 环境之间更强的静电相互作用。计算出的数值结果应证实这一趋势，用例 2 和 3 相对于用例 1 的能量比值应分别近似于 $(0.18/0.10)^2 = 3.24$ 和 $(0.24/0.10)^2 = 5.76$。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements a minimal Polarizable Embedding (PE) model to calculate QM/MM polarization energy.\n    \"\"\"\n    # Define fixed positions for QM and MM sites in bohr.\n    R_qm = np.array([[0.00, 0.00, 0.00], [2.41, 0.00, 0.00]])  # H, Cl\n    r_mm = np.array([\n        [0.00, 5.00, 0.00],   # MM site 1\n        [5.00, 0.00, 3.00],   # MM site 2\n        [-4.00, -3.00, 1.00]  # MM site 3\n    ])\n    num_mm_sites = len(r_mm)\n\n    # Define the four test cases as per the problem statement.\n    test_cases = [\n        {'name': 'STO-3G', 'q': np.array([0.10, -0.10]), 'alpha': np.array([0.80, 0.60, 1.00])},\n        {'name': '6-31G*', 'q': np.array([0.18, -0.18]), 'alpha': np.array([0.80, 0.60, 1.00])},\n        {'name': 'aug-cc-pVDZ', 'q': np.array([0.24, -0.24]), 'alpha': np.array([0.80, 0.60, 1.00])},\n        {'name': 'aug-cc-pVDZ_boundary', 'q': np.array([0.24, -0.24]), 'alpha': np.array([0.00, 0.00, 0.00])}\n    ]\n\n    results = []\n\n    # Pre-calculate the dipole-dipole interaction tensors T_ij, as they are constant.\n    T_tensors = np.zeros((num_mm_sites, num_mm_sites, 3, 3))\n    for i in range(num_mm_sites):\n        for j in range(num_mm_sites):\n            if i == j:\n                continue\n            rij_vec = r_mm[i] - r_mm[j]\n            rij_norm = np.linalg.norm(rij_vec)\n            T_tensors[i, j] = (3 * np.outer(rij_vec, rij_vec) - (rij_norm**2) * np.eye(3)) / (rij_norm**5)\n\n    for case in test_cases:\n        q_qm = case['q']\n        alphas = case['alpha']\n\n        # Handle the boundary case where all polarizabilities are zero.\n        if np.all(alphas == 0):\n            E_pol = 0.0\n            results.append(f\"{E_pol:.6f}\")\n            continue\n\n        # A is a 9x9 matrix for 3 MM sites.\n        dim = num_mm_sites * 3\n        A = np.zeros((dim, dim))\n\n        # Construct the response matrix A.\n        for i in range(num_mm_sites):\n            # Diagonal blocks: alpha_i^-1 * I_3\n            start_row, end_row = i * 3, (i + 1) * 3\n            if alphas[i] == 0:\n                # This case is for mixed polarizabilities (not in this problem)\n                # An infinite diagonal element would force the corresponding dipole components to zero.\n                # Here we assume non-zero alpha if not the all-zero case.\n                pass \n            A[start_row:end_row, start_row:end_row] = (1.0 / alphas[i]) * np.eye(3)\n            \n            # Off-diagonal blocks: -T_ij\n            for j in range(num_mm_sites):\n                if i == j:\n                    continue\n                start_col, end_col = j * 3, (j + 1) * 3\n                A[start_row:end_row, start_col:end_col] = -T_tensors[i, j]\n\n        # Calculate the external electric field vector E_ext (9x1).\n        E_ext_flat = np.zeros(dim)\n        for i in range(num_mm_sites):\n            E_i = np.zeros(3)\n            for a in range(len(R_qm)):\n                ri_Ra = r_mm[i] - R_qm[a]\n                ri_Ra_norm = np.linalg.norm(ri_Ra)\n                E_i += q_qm[a] * ri_Ra / (ri_Ra_norm**3)\n            E_ext_flat[i*3:(i+1)*3] = E_i\n\n        # Solve the linear system A * mu = E_ext for the induced dipoles mu.\n        mu_flat = np.linalg.solve(A, E_ext_flat)\n\n        # Calculate the polarization energy: E_pol = -1/2 * mu . E_ext\n        E_pol = -0.5 * np.dot(mu_flat, E_ext_flat)\n        \n        # Format the result and add to the list.\n        results.append(f\"{E_pol:.6f}\")\n\n    # Print the final result in the specified format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "在分子模拟中，我们常面临模型简化与物理真实性之间的权衡。分子的极化响应并非在所有方向上都相同，它本质上是一个张量属性，但我们有时会使用简化的各向同性（标量）模型。本次实践设计了一个巧妙的场景，突显了这种简化在特定情况下可能导致定性上完全错误的结论，从而深刻揭示了在可极化模型中正确使用张量极化率的重要性。",
            "id": "2460372",
            "problem": "考虑一个由 $N$ 个可极化位点组成的可极化嵌入子系统，这些位点在 $xy$ 平面上形成一个正六边形，模拟一个类苯环结构。每个位点 $i$ 位于位置 $\\mathbf{R}_i \\in \\mathbb{R}^3$ 处，其模长为 $\\lVert \\mathbf{R}_i \\rVert = R$，z 坐标等于 $0$，其中 $N=6$ 且 $R=3.0\\,a_0$。角度必须以弧度表示。全程使用原子单位：距离以玻尔（$a_0$）为单位，电荷以基本电荷为单位，电场以哈特里原子单位为单位，极化率以 $a_0^3$ 为单位。这些位点通过经典的偶极-偶极耦合相互作用，并对施加的电场作出线性响应。\n\n设位点 $i$ 处的感生偶极为 $\\boldsymbol{\\mu}_i \\in \\mathbb{R}^3$。感生偶极满足线性响应定义\n$$\n\\boldsymbol{\\mu}_i \\;=\\; \\boldsymbol{\\alpha}_i \\left( \\mathbf{E}_i^{\\mathrm{ext}} \\;+\\; \\sum_{\\substack{j=1 \\\\ j\\neq i}}^{N} \\mathbf{T}_{ij}\\, \\boldsymbol{\\mu}_j \\right),\n$$\n其中 $\\boldsymbol{\\alpha}_i \\in \\mathbb{R}^{3\\times 3}$ 是位点 $i$ 的极化率，$\\mathbf{E}_i^{\\mathrm{ext}}$ 是位点 $i$ 处的外部电场，$\\mathbf{T}_{ij}$ 是对于向量 $\\mathbf{r}_{ij}=\\mathbf{R}_i-\\mathbf{R}_j$ 的偶极-偶极相互作用张量，由下式给出\n$$\n\\mathbf{T}_{ij} \\;=\\; \\frac{3\\,\\mathbf{r}_{ij}\\mathbf{r}_{ij}^{\\mathsf{T}} - \\lVert \\mathbf{r}_{ij} \\rVert^2 \\mathbf{I}}{\\lVert \\mathbf{r}_{ij} \\rVert^5}, \\quad i\\neq j, \\qquad \\mathbf{T}_{ii}=\\mathbf{0}.\n$$\n总感生偶极为\n$$\n\\mathbf{M} \\;=\\; \\sum_{i=1}^{N} \\boldsymbol{\\mu}_i.\n$$\n考虑每个位点的两种极化率模型：\n1) 张量模型：$\\boldsymbol{\\alpha}_i = \\mathrm{diag}(\\alpha_{\\parallel},\\alpha_{\\parallel},\\alpha_{\\perp})$，其中 $\\alpha_{\\parallel}=8.0\\,a_0^3$ 且 $\\alpha_{\\perp}=0.0\\,a_0^3$。\n2) 各向同性模型：$\\boldsymbol{\\alpha}_i = \\alpha_{\\mathrm{iso}}\\,\\mathbf{I}$，其中 $\\alpha_{\\mathrm{iso}}=8.0\\,a_0^3$。\n\n在所有情况下，环都位于 $xy$ 平面内，并且所有位点张量共享此公共主轴框架。\n\n位点 $i$ 处的外部电场 $\\mathbf{E}_i^{\\mathrm{ext}}$ 定义为位于 $\\mathbf{r}_q$ 的单个点电荷 $q$ 或均匀电场 $\\mathbf{E}_0$ 的贡献的叠加：\n- 对于点电荷，\n$$\n\\mathbf{E}_i^{\\mathrm{ext}} \\;=\\; q \\, \\frac{\\mathbf{R}_i - \\mathbf{r}_q}{\\lVert \\mathbf{R}_i - \\mathbf{r}_q \\rVert^3}.\n$$\n- 对于均匀电场，对所有 $i$ 都有 $\\mathbf{E}_i^{\\mathrm{ext}} = \\mathbf{E}_0$。\n感兴趣方向的单位向量为 $\\hat{\\mathbf{z}}=(0,0,1)^{\\mathsf{T}}$ 和 $\\hat{\\mathbf{x}}=(1,0,0)^{\\mathsf{T}}$。\n\n定义一个布尔指示器，用于判断各向同性模型相对于张量模型在指定方向 $\\hat{\\mathbf{u}}$ 上的定性失效，其定义如下\n$$\n\\text{fail} \\;=\\; \n\\begin{cases}\n\\text{真},  &\\text{若 } \\left|\\mathbf{M}_{\\mathrm{tensor}}\\cdot \\hat{\\mathbf{u}}\\right| \\le \\tau \\text{ 且 } \\left|\\mathbf{M}_{\\mathrm{iso}}\\cdot \\hat{\\mathbf{u}}\\right| > \\tau, \\\\\n\\text{真},  &\\text{若 } \\left(\\mathbf{M}_{\\mathrm{tensor}}\\cdot \\hat{\\mathbf{u}}\\right)\\left(\\mathbf{M}_{\\mathrm{iso}}\\cdot \\hat{\\mathbf{u}}\\right)  0, \\\\\n\\text{假},  \\text{否则},\n\\end{cases}\n$$\n数值容差 $\\tau=1.0\\times 10^{-8}$（原子单位）。\n\n测试套件（三个案例，涵盖一般情况、边界情况和对照情况）：\n- 案例 A（一般情况，平面外点电荷）：$q=+1$，$\\mathbf{r}_q=(0,0,h_1)$，其中 $h_1=4.0\\,a_0$，无均匀电场，方向 $\\hat{\\mathbf{u}}=\\hat{\\mathbf{z}}$。\n- 案例 B（边界情况，平面外均匀电场）：无点电荷，$\\mathbf{E}_0=(0,0,E_0)$，其中 $E_0=5.0\\times 10^{-3}$（原子单位），方向 $\\hat{\\mathbf{u}}=\\hat{\\mathbf{z}}$。\n- 案例 C（对照情况，平面内均匀电场）：无点电荷，$\\mathbf{E}_0=(E_0,0,0)$，其中 $E_0=5.0\\times 10^{-3}$（原子单位），方向 $\\hat{\\mathbf{u}}=\\hat{\\mathbf{x}}$。\n\n对于每种情况，使用上述定义从第一性原理计算 $\\mathbf{M}_{\\mathrm{tensor}}$ 和 $\\mathbf{M}_{\\mathrm{iso}}$，并评估布尔指示器 $\\text{fail}$。\n\n您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果，并使用小写布尔值，按 A、B、C 的顺序排列（例如，“[true,false,true]”）。",
            "solution": "该问题要求计算在不同外部电场下，以及对于两种不同的局域极化率模型，一个由 $N=6$ 个可极化位点组成的六边形排列的总感生偶极矩。需要相对于一个物理上更详细的张量模型来评估各向同性极化率模型的有效性。\n\n控制该系统的基本方程是每个位点 $i$ 处的感生偶极 $\\boldsymbol{\\mu}_i$ 对该位点总电场 $\\mathbf{E}_i^{\\mathrm{tot}}$ 的线性响应：\n$$ \\boldsymbol{\\mu}_i = \\boldsymbol{\\alpha}_i \\mathbf{E}_i^{\\mathrm{tot}} $$\n总电场是外部电场 $\\mathbf{E}_i^{\\mathrm{ext}}$ 与系统中所有其他偶极子感生的电场之和：\n$$ \\mathbf{E}_i^{\\mathrm{tot}} = \\mathbf{E}_i^{\\mathrm{ext}} + \\sum_{\\substack{j=1 \\\\ j\\neq i}}^{N} \\mathbf{E}_j^{\\mathrm{ind}}(\\mathbf{R}_i) = \\mathbf{E}_i^{\\mathrm{ext}} + \\sum_{\\substack{j=1 \\\\ j\\neq i}}^{N} \\mathbf{T}_{ij} \\boldsymbol{\\mu}_j $$\n其中 $\\mathbf{T}_{ij}$ 是偶极-偶极相互作用张量。将总电场代入响应方程，得到一组关于未知感生偶极 $\\boldsymbol{\\mu}_i$ 的耦合线性方程组：\n$$ \\boldsymbol{\\mu}_i = \\boldsymbol{\\alpha}_i \\left( \\mathbf{E}_i^{\\mathrm{ext}} + \\sum_{\\substack{j=1 \\\\ j\\neq i}}^{N} \\mathbf{T}_{ij} \\boldsymbol{\\mu}_j \\right) $$\n为了求解偶极，我们重新整理这个方程组。假设极化率张量 $\\boldsymbol{\\alpha}_i$ 是可逆的，我们有 $\\boldsymbol{\\alpha}_i^{-1}\\boldsymbol{\\mu}_i = \\mathbf{E}_i^{\\mathrm{ext}} + \\sum_{j \\neq i} \\mathbf{T}_{ij} \\boldsymbol{\\mu}_j$。这可以对所有 $i=1, \\dots, N$ 写为：\n$$ \\boldsymbol{\\alpha}_i^{-1}\\boldsymbol{\\mu}_i - \\sum_{\\substack{j=1 \\\\ j\\neq i}}^{N} \\mathbf{T}_{ij} \\boldsymbol{\\mu}_j = \\mathbf{E}_i^{\\mathrm{ext}} $$\n这是一个包含 $N$ 个向量方程的系统，它对应于一个包含 $3N$ 个标量方程的大型系统，用于求解偶极的分量。我们可以将其表示为紧凑的分块矩阵形式 $\\mathbf{A}\\boldsymbol{\\mu} = \\mathbf{E}^{\\mathrm{ext}}$，其中 $\\boldsymbol{\\mu}$ 是一个 $3N$ 维列向量，由所有偶极向量 $\\boldsymbol{\\mu}_i$ 堆叠而成，$\\mathbf{E}^{\\mathrm{ext}}$ 是一个由外部电场 $\\mathbf{E}_i^{\\mathrm{ext}}$ 组成的 $3N$ 维列向量。$3N \\times 3N$ 矩阵 $\\mathbf{A}$ 是一个由 $3 \\times 3$ 子块 $\\mathbf{A}_{ij}$ 组成的分块矩阵：\n$$\n\\mathbf{A}_{ij} =\n\\begin{cases}\n\\boldsymbol{\\alpha}_i^{-1}  \\text{若 } i=j \\\\\n-\\mathbf{T}_{ij} \\text{若 } i\\neq j\n\\end{cases}\n$$\n然后通过求解这个线性系统来找到感生偶极的解：$\\boldsymbol{\\mu} = \\mathbf{A}^{-1} \\mathbf{E}^{\\mathrm{ext}}$。\n\n策略如下：\n1.  通过计算在 $xy$ 平面内形成半径为 $R=3.0\\,a_0$ 的正六边形的 $N=6$ 个位点的坐标 $\\mathbf{R}_i$ 来定义系统的几何结构。\n2.  对于每种极化率模型（张量和各向同性）和每个测试案例（A、B、C），构建矩阵 $\\mathbf{A}$ 和向量 $\\mathbf{E}^{\\mathrm{ext}}$。\n3.  求解线性系统以获得偶极向量 $\\boldsymbol{\\mu}$。\n4.  计算总偶极矩 $\\mathbf{M} = \\sum_{i=1}^{N} \\boldsymbol{\\mu}_i$。\n5.  使用得到的总偶极 $\\mathbf{M}_{\\mathrm{tensor}}$ 和 $\\mathbf{M}_{\\mathrm{iso}}$ 评估布尔失效准则。\n\n让我们分析这两种极化率模型。\n\n**各向同性模型**：\n极化率为 $\\boldsymbol{\\alpha}_i = \\alpha_{\\mathrm{iso}}\\mathbf{I}$，其中 $\\alpha_{\\mathrm{iso}}=8.0\\,a_0^3$。其逆矩阵是良定义的：$\\boldsymbol{\\alpha}_i^{-1} = (1/\\alpha_{\\mathrm{iso}})\\mathbf{I}$。必须构建并求解一个完整的 $18 \\times 18$ 系统。\n\n**张量模型**：\n极化率为 $\\boldsymbol{\\alpha}_i = \\mathrm{diag}(\\alpha_{\\parallel}, \\alpha_{\\parallel}, \\alpha_{\\perp})$，其中 $\\alpha_{\\parallel}=8.0\\,a_0^3$ 且 $\\alpha_{\\perp}=0.0\\,a_0^3$。$\\alpha_{\\perp}=0$ 的一个直接后果是感生偶极的 $z$ 分量必须为零，即 $\\mu_{iz}=0$，因为 $\\mu_{iz} = \\alpha_{\\perp} E_{iz}^{\\mathrm{tot}} = 0$。张量 $\\boldsymbol{\\alpha}_i$ 是奇异的且不可逆。我们必须使用原始方程。\n分量方程为：\n$$ \\mu_{ix} = \\alpha_{\\parallel} \\left( E_{ix}^{\\mathrm{ext}} + \\sum_{j \\neq i} (\\mathbf{T}_{ij}\\boldsymbol{\\mu}_j)_x \\right) $$\n$$ \\mu_{iy} = \\alpha_{\\parallel} \\left( E_{iy}^{\\mathrm{ext}} + \\sum_{j \\neq i} (\\mathbf{T}_{ij}\\boldsymbol{\\mu}_j)_y \\right) $$\n由于位点位于 $xy$ 平面内，向量 $\\mathbf{r}_{ij}$ 没有 $z$ 分量。这意味着相互作用张量 $\\mathbf{T}_{ij}$ 是分块对角矩阵，平面内（$xy$）和平面外（$z$）分量之间没有耦合。此外，我们知道对所有 $j$ 都有 $\\mu_{jz}=0$。因此，平面内分量 $\\mu_{ix}, \\mu_{iy}$ 的方程形成一个封闭的 $2N \\times 2N$ 系统，该系统独立于 $z$ 分量。我们可以定义一个平面内极化率 $\\boldsymbol{\\alpha}^{\\parallel} = \\mathrm{diag}(\\alpha_{\\parallel}, \\alpha_{\\parallel})$ 并求解 $12 \\times 12$ 系统以得到平面内偶极。平面外偶极全部为零。因此，总偶极 $\\mathbf{M}_{\\mathrm{tensor}}$ 的 $z$ 分量将为零。\n\n**对称性考虑和预期结果**：\n-   **案例 A 和 B**：外部电场（来自 $z$ 轴上的点电荷或沿 $z$ 轴的均匀电场）具有绕 $z$ 轴的旋转对称性。位点的六边形排列在 $C_6$ 旋转下也是对称的。因此， $xy$ 平面内的总感生偶极矩 $\\mathbf{M}_{\\parallel} = \\sum_i \\boldsymbol{\\mu}_{i,\\parallel}$ 必须为零，因为任何非零向量都会破坏这种对称性。\n    -   对于张量模型，由于 $\\mu_{iz}=0$，这意味着 $\\mathbf{M}_{\\mathrm{tensor}}=\\mathbf{0}$。沿 $\\hat{\\mathbf{u}}=\\hat{\\mathbf{z}}$ 的分量为 $m_t = 0$。\n    -   对于各向同性模型，平面外电场将感生非零的 $z$ 偶极，导致非零的 $m_i = \\mathbf{M}_{\\mathrm{iso}} \\cdot \\hat{\\mathbf{z}}$。\n    -   失效条件 `abs(m_t) = tau and abs(m_i)  tau` 将被满足。因此，对于案例 A 和 B，我们预期 `fail = true`。\n-   **案例 C**：外部电场沿 $x$ 轴均匀分布。两种模型都将产生非零响应。关键的观察是，因为所有位点都在 $xy$ 平面内，对于两种模型，系统都解耦为独立的平面内和平面外问题。由于在 $z$ 方向没有外部电场，两种模型的 $\\mu_{iz}=0$。平面内问题由以下方程控制：\n    $$ (\\boldsymbol{\\alpha}^{\\parallel})^{-1} \\boldsymbol{\\mu}_{i}^{\\parallel} - \\sum_{j \\neq i} \\mathbf{T}_{ij}^{\\parallel} \\boldsymbol{\\mu}_{j}^{\\parallel} = \\mathbf{E}_i^{\\mathrm{ext},\\parallel} $$\n    对于两种模型，平面内极化率是相同的：$\\alpha_{\\parallel} = \\alpha_{\\mathrm{iso}} = 8.0\\,a_0^3$。由于线性系统是相同的，它们的解也必须相同：$\\mathbf{M}_{\\mathrm{tensor}} = \\mathbf{M}_{\\mathrm{iso}}$。失效条件将不会被满足。因此，对于案例 C，我们预期 `fail = false`。\n\n该算法将使用 NumPy 进行线性代数运算，并按照上述步骤在 Python 脚本中实现。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef calculate_total_dipole(N, R, alpha_diag, e_ext_func):\n    \"\"\"\n    Calculates the total induced dipole moment for a system of N polarizable sites.\n\n    Args:\n        N (int): Number of sites.\n        R (float): Radius of the regular polygon on which sites are located.\n        alpha_diag (tuple): A tuple (alpha_xx, alpha_yy, alpha_zz) for the polarizability.\n        e_ext_func (callable): A function that takes a position vector and returns the external field vector.\n\n    Returns:\n        np.ndarray: The total induced dipole moment vector M.\n    \"\"\"\n    # 1. Generate site positions for a regular hexagon\n    positions = np.zeros((N, 3))\n    for i in range(N):\n        angle = i * 2.0 * np.pi / N\n        positions[i] = np.array([R * np.cos(angle), R * np.sin(angle), 0.0])\n\n    # 2. Handle the tensor model case (alpha_zz = 0) vs. isotropic model\n    is_tensor_model = np.isclose(alpha_diag[2], 0.0)\n\n    # In any case, because all sites are in the xy plane, the T-tensor is block-diagonal\n    # between xy and z components. The system decouples.\n\n    # 2a. Solve for in-plane (xy) components (2N x 2N system)\n    dim_xy = 2 * N\n    A_xy = np.zeros((dim_xy, dim_xy))\n    E_ext_xy = np.zeros(dim_xy)\n    \n    alpha_inv_xy = np.diag([1.0/alpha_diag[0], 1.0/alpha_diag[1]])\n\n    for i in range(N):\n        i_sl = slice(2 * i, 2 * (i + 1))\n        # Diagonal block\n        A_xy[i_sl, i_sl] = alpha_inv_xy\n        \n        # External field\n        E_ext_i = e_ext_func(positions[i])\n        E_ext_xy[i_sl] = E_ext_i[:2]\n        \n        # Off-diagonal blocks\n        for j in range(N):\n            if i == j:\n                continue\n            \n            j_sl = slice(2 * j, 2 * (j + 1))\n            r_ij = positions[i] - positions[j]\n            r_norm = np.linalg.norm(r_ij)\n            r_norm_sq = r_norm**2\n            r_norm5 = r_norm**5\n            \n            # T_ij = (3*r_ij*r_ij^T - |r_ij|^2 * I) / |r_ij|^5\n            # We only need the 2x2 xy-block\n            r_ij_xy = r_ij[:2]\n            T_ij_xy = (3 * np.outer(r_ij_xy, r_ij_xy) - r_norm_sq * np.identity(2)) / r_norm5\n            \n            A_xy[i_sl, j_sl] = -T_ij_xy\n            \n    mu_xy_flat = np.linalg.solve(A_xy, E_ext_xy)\n    mu_xy = mu_xy_flat.reshape(N, 2)\n\n    # 2b. Solve for out-of-plane (z) components (N x N system)\n    mu_z = np.zeros(N)\n    \n    # For the tensor model, alpha_perp=0, so mu_z is identically zero.\n    # For the isotropic model, we solve the decoupled z-system.\n    if not is_tensor_model:\n        dim_z = N\n        A_z = np.zeros((dim_z, dim_z))\n        E_ext_z = np.zeros(dim_z)\n        alpha_inv_z = 1.0 / alpha_diag[2]\n\n        for i in range(N):\n            A_z[i, i] = alpha_inv_z\n            E_ext_z[i] = e_ext_func(positions[i])[2]\n            \n            for j in range(N):\n                if i == j:\n                    continue\n                r_ij = positions[i] - positions[j]\n                r_norm3 = np.linalg.norm(r_ij)**3\n                # T_ij_zz = (3*r_z^2 - |r|^2)/|r|^5 = (0 - |r|^2)/|r|^5 = -1/|r|^3\n                T_ij_zz = -1.0 / r_norm3\n                A_z[i, j] = -T_ij_zz\n        \n        # Only solve if there is a non-zero external field in z.\n        # Otherwise, mu_z=0 is the only solution to the homogeneous equation.\n        if np.any(np.abs(E_ext_z)  1e-15):\n             mu_z = np.linalg.solve(A_z, E_ext_z)\n\n    # 3. Combine dipoles and calculate total dipole moment\n    dipoles = np.hstack([mu_xy, mu_z.reshape(N, 1)])\n    total_dipole = np.sum(dipoles, axis=0)\n    \n    return total_dipole\n\n\ndef solve():\n    # Define problem constants\n    N = 6\n    R = 3.0  # a_0\n    alpha_parallel = 8.0  # a_0^3\n    alpha_perp = 0.0  # a_0^3\n    alpha_iso = 8.0  # a_0^3\n    tau = 1.0e-8  # atomic units\n\n    alpha_tensor_diag = (alpha_parallel, alpha_parallel, alpha_perp)\n    alpha_iso_diag = (alpha_iso, alpha_iso, alpha_iso)\n    \n    # Define External Field functions and test cases\n    test_cases = [\n        {\n            'name': 'A',\n            'e_ext_func': lambda pos: 1.0 * (pos - np.array([0, 0, 4.0])) / np.linalg.norm(pos - np.array([0, 0, 4.0]))**3,\n            'u_vec': np.array([0, 0, 1])\n        },\n        {\n            'name': 'B',\n            'e_ext_func': lambda pos: np.array([0, 0, 5.0e-3]),\n            'u_vec': np.array([0, 0, 1])\n        },\n        {\n            'name': 'C',\n            'e_ext_func': lambda pos: np.array([5.0e-3, 0, 0]),\n            'u_vec': np.array([1, 0, 0])\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        # Calculate total dipole for both models\n        M_tensor = calculate_total_dipole(N, R, alpha_tensor_diag, case['e_ext_func'])\n        M_iso = calculate_total_dipole(N, R, alpha_iso_diag, case['e_ext_func'])\n\n        # Project moments onto the direction of interest\n        u_vec = case['u_vec']\n        m_t = np.dot(M_tensor, u_vec)\n        m_i = np.dot(M_iso, u_vec)\n        \n        # Evaluate failure condition\n        fail = (abs(m_t) = tau and abs(m_i)  tau) or (m_t * m_i  0)\n        results.append(str(fail).lower())\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "可极化模型超越固定电荷模型的关键优势之一，在于其能够自然地描述非加和的多体相互作用。极化效应不是简单的两两相互作用的叠加，一个分子的极化会影响邻近分子的极化，进而再反作用于自身。本次实践将引导你运用包含-排斥原理，对一个包含三个可极化位点的体系进行能量分解，从而精确地分离出纯粹的三体极化贡献，让你对极化相互作用的协作本质有更定量的认识。",
            "id": "2460378",
            "problem": "您将实现一个自洽的可极化嵌入模型，用于计算单个量子力学（QM）水分子的多体极化能分解。该水分子表示为一个永久点偶极，周围环绕着三个分子力学（MM）水分子，后者表示为可极化点偶极。目标是通过对MM位点的子集应用一个数学上明确定义的容斥过程，来分离出三体极化力的独特贡献。\n\n使用的基本定义：\n- 由$i$索引的MM位点带有一个感应偶极$\\boldsymbol{\\mu}_i \\in \\mathbb{R}^3$，它根据$\\boldsymbol{\\mu}_i = \\alpha_i \\,\\mathbf{E}_i^{\\mathrm{loc}}$线性响应于局域电场$\\mathbf{E}_i^{\\mathrm{loc}}$，其中$\\alpha_i$是各向同性极化率。\n- 局域电场满足叠加原理：$\\mathbf{E}_i^{\\mathrm{loc}} = \\mathbf{E}_i^{0} + \\sum_{j \\neq i} \\mathbf{T}(\\mathbf{r}_i - \\mathbf{r}_j)\\,\\boldsymbol{\\mu}_j$，其中$\\mathbf{E}_i^{0}$是由永久源（此处为QM偶极）产生的电场，$\\mathbf{T}(\\mathbf{r})$是原子单位中的偶极-偶极相互作用张量。\n- 在原子单位中，位于原点的点偶极$\\boldsymbol{\\mu}$在位置$\\mathbf{r}$处产生的电场由$\\mathbf{E}(\\mathbf{r}) = \\mathbf{T}(\\mathbf{r})\\,\\boldsymbol{\\mu}$给出，其中\n$$\n\\mathbf{T}(\\mathbf{r}) = \\frac{3\\,\\mathbf{r}\\,\\mathbf{r}^{\\top} - r^2 \\mathbf{I}}{r^5}, \\quad r = \\|\\mathbf{r}\\|.\n$$\n- MM位点子集$S$上的自洽感应偶极解的极化能为\n$$\nU_{\\mathrm{pol}}(S) = -\\frac{1}{2}\\sum_{i \\in S} \\boldsymbol{\\mu}_i \\cdot \\mathbf{E}_i^{\\mathrm{loc}}.\n$$\n\n多体分解要求：\n- 对于MM位点集合$S=\\{1,2,3\\}$，通过仅在$X$中的MM位点上求解自洽线性响应方程来为所有子集$X \\subseteq S$定义$U_{\\mathrm{pol}}(X)$。求解时使用相同的QM永久源，并且叠加仅限于$X$中的那些MM位点。与{1,2,3}相关的唯一三体极化能贡献是通过在子集格上使用容斥原理，在一致地移除所有一体和二体贡献后剩余的项，确保分解对于不相交的并集是可加的，并且在对所有直至三阶的唯一贡献求和时能够恢复$U_{\\mathrm{pol}}(S)$。\n\n您必须实现一个程序，该程序：\n1. 为任意给定的MM位点子集$X$构建并求解自洽感应偶极方程。\n2. 为所有$X \\subseteq \\{1,2,3\\}$计算$U_{\\mathrm{pol}}(X)$。\n3. 使用子集上的容斥原理来分离出完整集合{1,2,3}的唯一三体极化能。\n4. 对每个测试用例重复此过程，并为每个测试用例输出一个以哈特里（Hartree）为单位的浮点数结果。\n\n单位系统和数值约定：\n- 全程使用原子单位：位置以玻尔（$a_0$）为单位，偶极矩以$e\\cdot a_0$为单位，极化率以$a_0^3$为单位，能量以哈特里为单位。\n- QM水分子被建模为一个位于原点的固定永久点偶极$\\boldsymbol{\\mu}_Q$。\n- 最终答案以哈特里为单位表示，并四舍五入到十位小数。\n\n测试套件：\n对于每个案例，使用指定的参数并计算如上定义的唯一三体极化能。\n\n- 案例1（理想情况，$xy$平面内的类等边三角形排列）：\n  - 每个MM位点的$\\alpha = 9.64\\,a_0^3$。\n  - $\\boldsymbol{\\mu}_Q = (0,0,1.3756)\\,e\\cdot a_0$ 位于原点。\n  - MM位置（单位：玻尔）：$\\mathbf{R}_1 = (7,0,0)$, $\\mathbf{R}_2 = (-3.5, 6.062177826, 0)$, $\\mathbf{R}_3 = (-3.5, -6.062177826, 0)$。\n\n- 案例2（边界情况，一个MM位点距离较远）：\n  - 每个MM位点的$\\alpha = 9.64\\,a_0^3$。\n  - $\\boldsymbol{\\mu}_Q = (0,0,1.3756)\\,e\\cdot a_0$ 位于原点。\n  - MM位置（单位：玻尔）：$\\mathbf{R}_1 = (7,0,0)$, $\\mathbf{R}_2 = (-3.5, 6.062177826, 0)$, $\\mathbf{R}_3 = (0,0,30)$。\n\n- 案例3（各向异性排列，探测轴向响应）：\n  - 每个MM位点的$\\alpha = 9.64\\,a_0^3$。\n  - $\\boldsymbol{\\mu}_Q = (0,0,1.3756)\\,e\\cdot a_0$ 位于原点。\n  - MM位置（单位：玻尔）：$\\mathbf{R}_1 = (0,0,7)$, $\\mathbf{R}_2 = (0,0,-7)$, $\\mathbf{R}_3 = (7,0,0)$。\n\n- 案例4（边界条件，极化率为零）：\n  - 每个MM位点的$\\alpha = 0.0\\,a_0^3$。\n  - $\\boldsymbol{\\mu}_Q = (0,0,1.3756)\\,e\\cdot a_0$ 位于原点。\n  - MM位置（单位：玻尔）：$\\mathbf{R}_1 = (7,0,0)$, $\\mathbf{R}_2 = (-3.5, 6.062177826, 0)$, $\\mathbf{R}_3 = (-3.5, -6.062177826, 0)$。\n\n最终输出格式：\n- 您的程序应产生单行输出，其中包含四个结果，格式为逗号分隔的Python浮点数列表，以哈特里为单位，每个结果四舍五入到十位小数，并用方括号括起来。例如，“[x1,x2,x3,x4]”，其中每个$x_k$四舍五入到十位小数，且无额外空格。",
            "solution": "所提出的问题是计算化学领域中一个明确定义的练习，特别是在可极化嵌入模型范畴内。它要求计算一个三体极化能项，该项源自一个QM/MM模型，其中QM部分是一个永久点偶极，MM部分由三个可极化点偶极组成。该问题在科学上是合理的，逻辑上是一致的，并为获得唯一解提供了所有必要的数据和定义。因此，它被认为是有效的。\n\n解决方案分为三个主要阶段：\n1.  为任意给定的MM位点子集建立感应偶极的自洽线性响应方程。\n2.  基于自洽解计算每个子集的极化能。\n3.  应用容斥原理分离出唯一的三体极化能贡献。\n\n设$S = \\{1, 2, 3\\}$为三个MM位点的索引集。我们被要求计算该集合的三体极化能$\\Delta U_{\\text{pol}}^{(3)}$。\n\n**1. 自洽感应偶极**\n\n对于MM位点的任意子集$X \\subseteq S$，每个位点$i \\in X$的感应偶极$\\boldsymbol{\\mu}_i$由线性响应方程给出：\n$$ \\boldsymbol{\\mu}_i = \\alpha_i \\mathbf{E}_i^{\\mathrm{loc}} $$\n其中$\\alpha_i$是各向同性极化率，$\\mathbf{E}_i^{\\mathrm{loc}}$是位点$i$处的局域电场。这个局域电场是来自永久QM偶极的电场$\\mathbf{E}_i^0$与来自同一子集$X$内所有其他感应偶极$\\boldsymbol{\\mu}_j$的电场的叠加：\n$$ \\mathbf{E}_i^{\\mathrm{loc}} = \\mathbf{E}_i^0 + \\sum_{j \\in X, j \\neq i} \\mathbf{T}_{ij} \\boldsymbol{\\mu}_j $$\n此处，$\\mathbf{T}_{ij} = \\mathbf{T}(\\mathbf{R}_i - \\mathbf{R}_j)$是偶极-偶极相互作用张量，定义为：\n$$ \\mathbf{T}(\\mathbf{r}) = \\frac{3 \\mathbf{r} \\mathbf{r}^{\\top} - \\|\\mathbf{r}\\|^2 \\mathbf{I}}{\\|\\mathbf{r}\\|^5} $$\n由位于原点的QM偶极$\\boldsymbol{\\mu}_Q$在位点$i$处产生的永久电场为$\\mathbf{E}_i^0 = \\mathbf{T}(\\mathbf{R}_i)\\boldsymbol{\\mu}_Q$。\n\n将$\\mathbf{E}_i^{\\mathrm{loc}}$的表达式代入响应方程，得到一个关于感应偶极$\\{\\boldsymbol{\\mu}_i\\}_{i \\in X}$的线性方程组：\n$$ \\boldsymbol{\\mu}_i = \\alpha_i \\left( \\mathbf{E}_i^0 + \\sum_{j \\in X, j \\neq i} \\mathbf{T}_{ij} \\boldsymbol{\\mu}_j \\right) $$\n重新排列得到标准形式$\\mathbf{M} \\boldsymbol{x} = \\boldsymbol{b}$：\n$$ \\frac{1}{\\alpha_i} \\mathbf{I} \\boldsymbol{\\mu}_i - \\sum_{j \\in X, j \\neq i} \\mathbf{T}_{ij} \\boldsymbol{\\mu}_j = \\mathbf{E}_i^0 $$\n该系统可以为$X$中的所有位点表示为分块矩阵形式。设$n = |X|$。我们定义一个感应偶极的“超向量”$\\boldsymbol{\\vec{\\mu}} \\in \\mathbb{R}^{3n}$和一个相应的永久电场超向量$\\boldsymbol{\\vec{E}}^0 \\in \\mathbb{R}^{3n}$。则系统为：\n$$ (\\mathbf{A}^{-1} - \\mathbf{T}_{\\text{block}}) \\boldsymbol{\\vec{\\mu}} = \\boldsymbol{\\vec{E}}^0 $$\n其中$\\mathbf{A}^{-1}$是一个分块对角矩阵，其$3 \\times 3$的块为$(\\frac{1}{\\alpha_i})\\mathbf{I}$，而$\\mathbf{T}_{\\text{block}}$是一个分块矩阵，其非对角块为$\\mathbf{T}_{ij}$。我们求解这个$3n \\times 3n$的线性系统以得到$\\boldsymbol{\\vec{\\mu}}$。\n\n对于所有$\\alpha_i = 0$的特殊情况，所有感应偶极$\\boldsymbol{\\mu}_i$必须为零，导致极化能为零。这作为一个特殊情况处理。\n\n**2. 极化能**\n\n问题将子集$X$的极化能定义为：\n$$ U_{\\mathrm{pol}}(X) = -\\frac{1}{2} \\sum_{i \\in X} \\boldsymbol{\\mu}_i \\cdot \\mathbf{E}_i^{\\mathrm{loc}} $$\n根据响应方程，我们有$\\mathbf{E}_i^{\\mathrm{loc}} = \\frac{1}{\\alpha_i} \\boldsymbol{\\mu}_i$。将此代入能量表达式，提供了一个计算上方便的公式：\n$$ U_{\\mathrm{pol}}(X) = -\\frac{1}{2} \\sum_{i \\in X} \\boldsymbol{\\mu}_i \\cdot \\left(\\frac{1}{\\alpha_i}\\boldsymbol{\\mu}_i\\right) = -\\frac{1}{2} \\sum_{i \\in X} \\frac{\\|\\boldsymbol{\\mu}_i\\|^2}{\\alpha_i} $$\n一旦确定了子集$X$的自洽感应偶极$\\boldsymbol{\\mu}_i$，就使用此公式来计算能量。\n\n**3. 多体容斥原理**\n\n三个MM位点完整集合的总极化能$U_{\\mathrm{pol}}(\\{1,2,3\\})$可以分解为一体、二体和三体相互作用的贡献。唯一的三体贡献$\\Delta U_{\\text{pol}}^{(3)}(\\{1,2,3\\})$是使用容斥原理分离出来的。该原理系统地移除了所有低阶效应。对于一个包含三个元素的集合，其公式为：\n$$ \\Delta U_{\\text{pol}}^{(3)} = \\sum_{X \\subseteq \\{1,2,3\\}} (-1)^{3-|X|} U_{\\mathrm{pol}}(X) $$\n假设$U_{\\mathrm{pol}}(\\emptyset) = 0$，这展开为：\n$$ \\Delta U_{\\text{pol}}^{(3)} = U_{\\mathrm{pol}}(\\{1,2,3\\}) - \\left[ U_{\\mathrm{pol}}(\\{1,2\\}) + U_{\\mathrm{pol}}(\\{1,3\\}) + U_{\\mathrm{pol}}(\\{2,3\\}) \\right] + \\left[ U_{\\mathrm{pol}}(\\{1\\}) + U_{\\mathrm{pol}}(\\{2\\}) + U_{\\mathrm{pol}}(\\{3\\}) \\right] $$\n这需要为$\\{1,2,3\\}$的所有$2^3 - 1 = 7$个非空子集计算$U_{\\mathrm{pol}}(X)$。所实现的算法将计算这七个能量值，然后根据上述公式将它们组合起来，以找到每个测试用例的三体能量。\n\n实现过程将首先定义一个函数来求解任意子集$X$的$U_{\\mathrm{pol}}(X)$，然后为所有必要的子集调用此函数，最后应用容斥公式。",
            "answer": "```python\nimport numpy as np\nfrom itertools import chain, combinations\n\ndef solve():\n    \"\"\"\n    Main function to solve for all test cases and print the results.\n    \"\"\"\n    # Case 1: Equilateral-like arrangement\n    case1_params = {\n        \"alpha\": 9.64,\n        \"mu_Q\": np.array([0.0, 0.0, 1.3756]),\n        \"R_mm\": [\n            np.array([7.0, 0.0, 0.0]),\n            np.array([-3.5, 6.062177826, 0.0]),\n            np.array([-3.5, -6.062177826, 0.0])\n        ]\n    }\n\n    # Case 2: One distant MM site\n    case2_params = {\n        \"alpha\": 9.64,\n        \"mu_Q\": np.array([0.0, 0.0, 1.3756]),\n        \"R_mm\": [\n            np.array([7.0, 0.0, 0.0]),\n            np.array([-3.5, 6.062177826, 0.0]),\n            np.array([0.0, 0.0, 30.0])\n        ]\n    }\n\n    # Case 3: Anisotropic axial arrangement\n    case3_params = {\n        \"alpha\": 9.64,\n        \"mu_Q\": np.array([0.0, 0.0, 1.3756]),\n        \"R_mm\": [\n            np.array([0.0, 0.0, 7.0]),\n            np.array([0.0, 0.0, -7.0]),\n            np.array([7.0, 0.0, 0.0])\n        ]\n    }\n\n    # Case 4: Vanishing polarizability\n    case4_params = {\n        \"alpha\": 0.0,\n        \"mu_Q\": np.array([0.0, 0.0, 1.3756]),\n        \"R_mm\": [\n            np.array([7.0, 0.0, 0.0]),\n            np.array([-3.5, 6.062177826, 0.0]),\n            np.array([-3.5, -6.062177826, 0.0])\n        ]\n    }\n\n    test_cases = [case1_params, case2_params, case3_params, case4_params]\n    results = [calculate_3body_energy(**params) for params in test_cases]\n    \n    # Format the final output string\n    formatted_results = [f\"{res:.10f}\" for res in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\ndef get_t_tensor(r_vec):\n    \"\"\"\n    Computes the dipole-dipole interaction tensor T(r).\n    \n    Args:\n        r_vec (np.ndarray): The 3D displacement vector r.\n        \n    Returns:\n        np.ndarray: The 3x3 interaction tensor T.\n    \"\"\"\n    r_norm = np.linalg.norm(r_vec)\n    if r_norm == 0:\n        # This occurs for T_ii, which is zero in the model.\n        # It should not occur for distinct sites i and j.\n        return np.zeros((3, 3))\n    \n    r_sq = r_norm**2\n    r_pow5 = r_norm**5\n    \n    r_outer = np.outer(r_vec, r_vec)\n    \n    tensor = (3.0 * r_outer - r_sq * np.identity(3)) / r_pow5\n    return tensor\n\ndef calculate_U_pol(subset_indices, mu_Q, R_mm, alpha):\n    \"\"\"\n    Calculates the polarization energy U_pol for a given subset of MM sites.\n    \n    Args:\n        subset_indices (tuple): A tuple of original indices (0, 1, or 2) for the MM sites.\n        mu_Q (np.ndarray): The permanent QM dipole moment.\n        R_mm (list of np.ndarray): List of positions of the MM sites.\n        alpha (float): The isotropic polarizability of the MM sites.\n        \n    Returns:\n        float: The calculated polarization energy in Hartree.\n    \"\"\"\n    num_sites = len(subset_indices)\n    if num_sites == 0:\n        return 0.0\n\n    if alpha == 0.0:\n        return 0.0\n\n    # Build the linear system M * mu = E0\n    dim = 3 * num_sites\n    M = np.zeros((dim, dim))\n    E0_vec = np.zeros(dim)\n\n    # 1. Construct the permanent field vector E0\n    for i, orig_idx_i in enumerate(subset_indices):\n        pos_i = R_mm[orig_idx_i]\n        T_qi = get_t_tensor(pos_i)\n        E0_i = T_qi @ mu_Q\n        E0_vec[3*i : 3*i+3] = E0_i\n\n    # 2. Construct the system matrix M\n    for i in range(num_sites):\n        # Diagonal blocks: alpha^-1 * I\n        M[3*i:3*i+3, 3*i:3*i+3] = np.identity(3) / alpha\n        \n        # Off-diagonal blocks: -T_ij\n        for j in range(i + 1, num_sites):\n            orig_idx_i = subset_indices[i]\n            orig_idx_j = subset_indices[j]\n            \n            r_ij = R_mm[orig_idx_i] - R_mm[orig_idx_j]\n            T_ij = get_t_tensor(r_ij)\n            \n            M[3*i:3*i+3, 3*j:3*j+3] = -T_ij\n            M[3*j:3*j+3, 3*i:3*i+3] = -T_ij.T # T is symmetric, but this is safer\n\n    # 3. Solve for the induced dipoles mu\n    mu_vec = np.linalg.solve(M, E0_vec)\n\n    # 4. Calculate polarization energy: U_pol = -1/2 * sum_i( ||mu_i||^2 / alpha )\n    energy = 0.0\n    for i in range(num_sites):\n        mu_i = mu_vec[3*i : 3*i+3]\n        energy += np.dot(mu_i, mu_i)\n        \n    energy *= -0.5 / alpha\n    \n    return energy\n\ndef calculate_3body_energy(mu_Q, R_mm, alpha):\n    \"\"\"\n    Calculates the 3-body polarization energy using inclusion-exclusion.\n    \"\"\"\n    if alpha == 0.0:\n        return 0.0\n\n    indices = (0, 1, 2)\n    \n    # Generate all non-empty subsets of indices\n    subsets = list(chain.from_iterable(combinations(indices, r) for r in range(1, len(indices) + 1)))\n    \n    # Calculate U_pol for all subsets\n    U_pol_values = {subset: calculate_U_pol(subset, mu_Q, R_mm, alpha) for subset in subsets}\n    \n    # Apply inclusion-exclusion formula for 3-body term\n    # Delta_U(1,2,3) = U(1,2,3) - [U(1,2)+U(1,3)+U(2,3)] + [U(1)+U(2)+U(3)]\n    \n    # 3-body term\n    term_3 = U_pol_values[(0, 1, 2)]\n    \n    # 2-body terms\n    term_2 = U_pol_values[(0, 1)] + U_pol_values[(0, 2)] + U_pol_values[(1, 2)]\n    \n    # 1-body terms\n    term_1 = U_pol_values[(0,)] + U_pol_values[(1,)] + U_pol_values[(2,)]\n    \n    delta_U3 = term_3 - term_2 + term_1\n    \n    return delta_U3\n\nif __name__ == \"__main__\":\n    solve()\n```"
        }
    ]
}