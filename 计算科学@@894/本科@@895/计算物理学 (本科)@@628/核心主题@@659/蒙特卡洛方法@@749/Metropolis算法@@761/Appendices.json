{"hands_on_practices": [{"introduction": "在编写 Metropolis 算法时，一个常见的疑问是如何高效地实现其接受准则。这个练习旨在揭示一个简洁代码背后所蕴含的数学逻辑，它将能量增加和减少两种情况统一在了一个表达式中。通过分析这段代码 [@problem_id:1964945]，你将加深对接受概率 $P_{\\text{acc}} = \\min(1, \\exp(-\\Delta E / (k_B T)))$ 的理解，并学会如何编写更精炼的模拟程序。", "problem": "一名学生 Alex 正在为一个简单的二维格点气体模型编写 Metropolis 蒙特卡洛模拟。在这个模型中，粒子占据网格上的格点，系统的总能量 $E$ 根据相邻粒子间的相互作用计算得出。该模拟的目标是在给定温度 $T$ 下从正则系综中抽样构型。\n\nAlex 的模拟按步进行。在每一步中，都会提出一个试探移动（例如，将单个粒子移动到随机的相邻空位）。设当前构型的能量为 $E_{old}$，提议的新构型的能量为 $E_{new}$。能量变化为 $\\Delta E = E_{new} - E_{old}$。\n\nAlex 使用下面这行伪代码实现了核心的接受/拒绝逻辑，其中 `rand()` 是一个返回区间 $[0, 1)$ 上均匀分布的随机浮点数的函数。如果条件为真，则接受该移动。\n\n`if rand() < exp(-ΔE / (k_B * T))`\n\n在这里，$k_B$ 是玻尔兹曼常数。Alex 运行模拟后发现，系统似乎正在达到一个合理的平衡态。然而，他们感到担忧，因为他们的代码中没有包含显式的 `if/else` 结构来区分增加能量的移动（$\\Delta E > 0$）和降低能量的移动（$\\Delta E \\le 0$），而这正是他们教科书中介绍算法的方式。\n\n下列哪个陈述对 Alex 的实现给出了最准确的分析？\n\nA. 该代码存在根本性缺陷，因为它永远不会接受降低系统能量的移动（$\\Delta E \\le 0$）。\n\nB. 该代码存在根本性缺陷，因为它会接受所有提议的移动，无论能量如何变化，从而阻止系统达到热平衡。\n\nC. 该代码能正常工作，因为对于任何降低能量的移动（$\\Delta E \\le 0$），项 $\\exp(-\\Delta E / (k_B T))$ 的值大于或等于 1，从而确保接受条件总是被满足。\n\nD. 该代码仅在高温极限（$k_B T \\gg |\\Delta E|$）下是正确的，此时指数项可以近似为 1，但在低温下会失效。\n\nE. 该代码存在根本性缺陷，因为它没有以 1 的接受概率显式处理 $\\Delta E \\le 0$ 的情况，从而违反了细致平衡原理。", "solution": "令 $\\beta$ 表示逆温度，$\\beta = \\frac{1}{k_{B}T}$。在具有对称提议分布的 Metropolis 算法中，确保从正则系综中抽样并满足细致平衡的接受概率是\n$$\nA(\\Delta E) = \\min\\!\\left(1,\\exp(-\\beta \\Delta E)\\right).\n$$\nAlex 的代码在均匀随机变量 $r \\sim \\text{Uniform}[0,1)$ 满足以下条件时接受移动\n$$\nr < \\exp(-\\beta \\Delta E).\n$$\n此规则实现的接受概率是事件 $\\{r < \\exp(-\\beta \\Delta E)\\}$ 发生的关于 $r$ 的概率。由于 $r$ 在 $[0,1)$ 上是均匀分布的，\n$$\nP(\\text{accept}) = \\int_{0}^{1} \\mathbf{1}\\{r < \\exp(-\\beta \\Delta E)\\} \\, dr.\n$$\n这个积分根据 $\\exp(-\\beta \\Delta E)$ 相对于 $1$ 的值进行分段计算：\n\n1) 如果 $\\Delta E \\le 0$，那么 $-\\beta \\Delta E \\ge 0$，因此\n$$\n\\exp(-\\beta \\Delta E) \\ge 1.\n$$\n因为 $r \\in [0,1)$ 且 $\\exp(-\\beta \\Delta E) \\ge 1$，所以不等式 $r < \\exp(-\\beta \\Delta E)$ 对所有在 $[0,1)$ 中的 $r$ 都成立。因此，\n$$\nP(\\text{accept}) = 1 = \\min\\!\\left(1,\\exp(-\\beta \\Delta E)\\right).\n$$\n特别地，当 $\\Delta E = 0$ 时，$\\exp(0) = 1$，并且由于对于 $r \\in [0,1)$ 几乎必然有 $r < 1$，所以接受以概率 $1$ 发生，正如所要求的那样。\n\n2) 如果 $\\Delta E > 0$，那么 $-\\beta \\Delta E < 0$，因此\n$$\n\\exp(-\\beta \\Delta E) < 1,\n$$\n并且事件 $\\{r < \\exp(-\\beta \\Delta E)\\}$ 发生的概率恰好是 $\\exp(-\\beta \\Delta E)$，因为区间 $\\{r \\in [0,1) : r < \\exp(-\\beta \\Delta E)\\}$ 的长度是 $\\exp(-\\beta \\Delta E)$。于是,\n$$\nP(\\text{accept}) = \\exp(-\\beta \\Delta E) = \\min\\!\\left(1,\\exp(-\\beta \\Delta E)\\right).\n$$\n\n结合这两种情况，\n$$\nP(\\text{accept}) = \\min\\!\\left(1,\\exp(-\\beta \\Delta E)\\right),\n$$\n这正是为对称提议强制执行细致平衡的 Metropolis 接受规则。因此，Alex 的单行条件隐式地实现了 $\\min$ 操作，因为 $r$ 被限制在 $[0,1)$ 区间内。它以概率 $1$ 接受所有降低能量或能量不变的移动，并以概率 $\\exp(-\\beta \\Delta E)$ 接受增加能量的移动。所以：\n- 降低能量的移动不会被拒绝（排除 A）。\n- 它不接受所有的移动（排除 B）。\n- 它不局限于高温区（排除 D）。\n- 它没有违反细致平衡；正确的接受概率得以实现（排除 E）。\n\n因此，最准确的陈述是，该代码在所有温度下都能正常工作，因为当 $\\Delta E \\le 0$ 时，$\\exp(-\\Delta E/(k_{B}T)) \\ge 1$，确保了接受，而当 $\\Delta E > 0$ 时，它产生了正确的概率性接受。", "answer": "$$\\boxed{C}$$", "id": "1964945"}, {"introduction": "理解了接受准则的逻辑后，下一步是亲手执行算法，观察系统状态如何演变。本练习 [@problem_id:2005989] 提供了一个经典的伊辛模型作为“沙盒”，让你逐步追踪两次自旋翻转尝试的全过程。通过精确计算能量变化 $\\Delta E$ 并应用 Metropolis 准则，你将获得关于算法如何具体操作的直观感受。", "problem": "考虑一个磁性材料的简化模型，该模型由一个包含四个经典自旋的 2x2 方形晶格表示。这些自旋位于位置 $(i,j)$ 处，其中 $i,j \\in \\{1, 2\\}$，并记为 $s_{ij}$。每个自旋只能指向两个方向之一，由值 $s_{ij} = +1$ 或 $s_{ij} = -1$ 表示。系统的总能量由铁磁伊辛哈密顿量给出：\n$$H = -J \\sum_{\\langle (ij), (kl) \\rangle} s_{ij} s_{kl}$$\n其中，求和遍历晶格上所有唯一的最近邻自旋对，而 $J$ 是一个正常数耦合常数。系统初始处于铁磁基态，其中所有四个自旋都排列一致：$s_{11} = s_{12} = s_{21} = s_{22} = +1$。\n\n系统通过蒙特卡罗模拟在与恒定温度 $T$ 的热浴接触下进行演化。该模拟以离散的步数进行。在每一步中，选择一个自旋并尝试将其翻转（即改变其符号）。计算由提议的翻转引起的能量变化 $\\Delta E$。\n- 如果 $\\Delta E \\le 0$，则总是接受该翻转。\n- 如果 $\\Delta E > 0$，则以概率 $P = \\exp(-\\Delta E / (k_B T))$ 接受该翻转，其中 $k_B$ 是玻尔兹曼常数。\n\n为使此问题的过程确定化，概率性决策按如下方式处理：对于需要此类决策的第 $k$ 步移动，当且仅当计算出的概率 $P$ 大于提供的比较值 $R_k$ 时，该移动才被接受。\n\n系统所处的温度使得热能由 $k_B T = \\frac{4J}{\\ln 2}$ 给出。模拟根据以下顺序执行两个步骤：\n1.  尝试翻转自旋 $s_{11}$。如果需要，此步骤的比较值为 $R_1 = 0.4$。\n2.  从第一步产生的构型开始，尝试翻转自旋 $s_{22}$。如果需要，此步骤的比较值为 $R_2 = 0.4$。\n\n计算这两步之后系统的最终能量 $H_{final}/J$。你的答案应该是一个单个整数。", "solution": "我们考虑一个具有开放边界条件的 2x2 晶格，因此对唯一的最近邻对的求和恰好包括四个键：$(11)-(12)$、$(11)-(21)$、$(12)-(22)$ 和 $(21)-(22)$。伊辛哈密顿量为 $H=-J\\sum_{\\langle (ij),(kl)\\rangle}s_{ij}s_{kl}$，其中 $J>0$。在完全对齐的初始状态下，每一对都有 $s_{ij}s_{kl}=+1$，因此初始能量为\n$$\nH_{0}=-J\\,(1+1+1+1)=-4J.\n$$\n\n在位点 $p$ 处的单自旋翻转仅改变与该位点相连的键。能量变化的标准结果是\n$$\n\\Delta E=2J\\,s_{p}\\sum_{q\\in \\text{nn}(p)}s_{q},\n$$\n其中求和是针对 $p$ 的最近邻。对于 $\\Delta E>0$，Metropolis 接受概率为 $P=\\exp\\!\\big(-\\Delta E/(k_{B}T)\\big)$，此处的确定性规则是：当且仅当 $P>R_{k}$ 时接受。\n\n步骤1：提议翻转 $s_{11}$。它的邻居是 $s_{12}$ 和 $s_{21}$，初始时都为 $+1$，且 $s_{11}=+1$。因此\n$$\n\\Delta E_{1}=2J\\,(+1)\\big[(+1)+(+1)\\big]=4J>0.\n$$\n在 $k_{B}T=\\frac{4J}{\\ln 2}$ 的条件下，接受概率为\n$$\nP_{1}=\\exp\\!\\left(-\\frac{\\Delta E_{1}}{k_{B}T}\\right)=\\exp\\!\\left(-\\frac{4J}{4J/\\ln 2}\\right)=\\exp(-\\ln 2)=2^{-1}.\n$$\n由于 $2^{-1}=0.5>R_{1}=0.4$，该翻转被接受。新的能量是\n$$\nH_{1}=H_{0}+\\Delta E_{1}=-4J+4J=0.\n$$\n\n步骤2：从此构型开始，提议翻转 $s_{22}$。它的邻居是 $s_{12}=+1$ 和 $s_{21}=+1$，且 $s_{22}=+1$，所以\n$$\n\\Delta E_{2}=2J\\,(+1)\\big[(+1)+(+1)\\big]=4J>0.\n$$\n接受概率与之前相同，\n$$\nP_{2}=\\exp\\!\\left(-\\frac{4J}{4J/\\ln 2}\\right)=2^{-1}.\n$$\n由于 $2^{-1}=0.5>R_{2}=0.4$，此翻转也被接受。因此，最终能量为\n$$\nH_{\\text{final}}=H_{1}+\\Delta E_{2}=0+4J=4J,\n$$\n所以\n$$\n\\frac{H_{\\text{final}}}{J}=4.\n$$", "answer": "$$\\boxed{4}$$", "id": "2005989"}, {"introduction": "Metropolis 算法的最终目标是模拟系统在热平衡状态下的行为，其状态分布遵循玻尔兹曼分布。这个练习 [@problem_id:2005992] 将我们的视角从单步的微观动力学提升到宏观的平衡态性质。你需要在给定的一组离散能级上，运用玻尔兹曼分布的原理来计算系统处于最低能量状态的概率，从而验证 Metropolis 抽样最终能够导向统计力学的理论预测。", "problem": "一个计算模型用于研究单个经典粒子在离散能量景观上的行为。该能量景观由一个立方体的八个顶点组成，标记为 $v_1$ 到 $v_8$。每个顶点 $i$ 都关联着一个特定的恒定能量 $E_i$。这些顶点的能量集合为：\n$\\{E_1, E_2, E_3, E_4, E_5, E_6, E_7, E_8\\} = \\{4.0, 7.0, 1.5, 5.0, 8.0, 3.0, 6.0, 2.5\\}$，能量的任意单位为 $\\epsilon$。\n\n粒子的状态即为其当前所在的顶点。系统在恒定温度下使用 Metropolis 算法进行演化。在模拟的每一步中：\n1. 通过随机选择与粒子当前位置相邻的三个顶点之一来提出一个尝试移动。\n2. 计算能量变化 $\\Delta E = E_{\\text{new}} - E_{\\text{old}}$。\n3. 如果 $\\Delta E \\le 0$，则该移动总是被接受。\n4. 如果 $\\Delta E > 0$，则该移动以概率 $P_{\\text{accept}} = \\exp(-\\Delta E / (k_B T))$ 被接受。\n\n系统经过非常大量的步数模拟，使其达到热平衡。系统的热能保持在 $k_B T = 2.0 \\epsilon$。\n\n计算当系统处于平衡状态时，在能量最低的顶点上找到该粒子的概率。将您的答案表示为四舍五入到三位有效数字的小数。", "solution": "在无向图上使用对称提议（立方体的每个顶点度为3，且向邻居的提议是均匀的）的 Metropolis 算法满足相对于玻尔兹曼分布的细致平衡条件。因此，在平衡状态下，占据顶点 $i$ 的概率为\n$$\np_{i}=\\frac{\\exp\\!\\left(-\\frac{E_{i}}{k_{B}T}\\right)}{Z},\\quad Z=\\sum_{j=1}^{8}\\exp\\!\\left(-\\frac{E_{j}}{k_{B}T}\\right).\n$$\n最低能量为 $E_{\\min}=1.5\\,\\epsilon$（在顶点 $v_{3}$ 处）。当 $k_{B}T=2.0\\,\\epsilon$时，无量纲因子为 $E_{i}/(k_{B}T)=E_{i}/2$，所以\n$$\nZ=\\sum_{j=1}^{8}\\exp\\!\\left(-\\frac{E_{j}}{2}\\right)=\\exp(-2)+\\exp(-3.5)+\\exp(-0.75)+\\exp(-2.5)+\\exp(-4)+\\exp(-1.5)+\\exp(-3)+\\exp(-1.25).\n$$\n数值上，\n$$\nZ\\approx 0.1353352832+0.0301973834+0.4723665527+0.0820849986+0.0183156389+0.2231301601+0.0497870684+0.2865047969\\approx 1.2977218823.\n$$\n在能量最低的顶点处的平衡概率为\n$$\np_{\\min}=\\frac{\\exp(-0.75)}{Z}\\approx \\frac{0.4723665527}{1.2977218823}\\approx 0.363997.\n$$\n四舍五入到三位有效数字，结果为 $0.364$。", "answer": "$$\\boxed{0.364}$$", "id": "2005992"}]}