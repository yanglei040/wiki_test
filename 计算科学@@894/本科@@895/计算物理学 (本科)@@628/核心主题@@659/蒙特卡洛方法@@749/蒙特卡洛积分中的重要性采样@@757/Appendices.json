{"hands_on_practices": [{"introduction": "在重要性采样中，选择一个好的提议分布（proposal distribution）是决定成败的关键。一个设计巧妙的提议分布可以显著减少估计的方差，从而用更少的样本获得更高的精度。本练习旨在通过一个经典的例子，让您亲身体会坐标系选择对采样效率的巨大影响。\n\n我们将分析一个具有径向对称性的二维积分。通过解析推导和比较在笛卡尔坐标系和极坐标系下进行采样的方差，您将清晰地看到，当提议分布的几何结构与被积函数的对称性相匹配时，效率会得到怎样的提升。[@problem_id:2402986]", "problem": "您必须编写一个完整、可运行的程序，以比较两种数学上定义的重要性抽样策略在估计一个径向对称的二维积分时的效率。考虑标量积分\n$$\nI(\\alpha) \\equiv \\int_{\\mathbb{R}^2} \\exp\\!\\left(-\\alpha\\,(x^2+y^2)\\right)\\,\\mathrm{d}x\\,\\mathrm{d}y,\n$$\n其中 $\\alpha>0$ 且 $(x,y)\\in\\mathbb{R}^2$。令 $f(x,y;\\alpha) \\equiv \\exp\\!\\left(-\\alpha\\,(x^2+y^2)\\right)$ 表示被积函数。定义如下两种重要性抽样策略，每种策略都导出一个单样本重要性权重，其方差可以量化抽样效率。\n\n1. 笛卡尔方案 (Cartesian scheme)。从一个二维正态密度函数中抽取 $(X,Y)$，其分量独立且方差为 $\\sigma^2$，即\n$$\nq_{\\mathrm{C}}(x,y;\\sigma) \\equiv \\frac{1}{2\\pi\\,\\sigma^2}\\,\\exp\\!\\left(-\\frac{x^2+y^2}{2\\sigma^2}\\right),\n$$\n其中 $\\sigma>0$。对应的单样本重要性权重为\n$$\nW_{\\mathrm{C}} \\equiv \\frac{f(X,Y;\\alpha)}{q_{\\mathrm{C}}(X,Y;\\sigma)}。\n$$\n\n2. 极坐标方案 (Polar scheme)。在极坐标 $(r,\\theta)$ 下进行计算，使用标准的雅可比因子 $r$，其中 $\\theta$ 是以弧度为单位的角度。从 $[0,2\\pi)$ 上均匀抽取 $\\Theta$，并独立于 $\\Theta$ 从径向密度函数中抽取 $R$\n$$\nq_{r}(r;\\beta) \\equiv 2\\beta\\,r\\,\\exp\\!\\left(-\\beta\\,r^2\\right),\\quad r\\ge 0,\n$$\n其中 $\\beta>0$。联合提议分布为 $q_{\\mathrm{P}}(r,\\theta;\\beta) \\equiv q_{r}(r;\\beta)\\,q_{\\theta}(\\theta)$，其中 $q_{\\theta}(\\theta)\\equiv \\frac{1}{2\\pi}$ 在 $[0,2\\pi)$ 上。对应的极坐标积分\n$$\nI(\\alpha) \\equiv \\int_{0}^{2\\pi}\\!\\int_{0}^{\\infty} \\exp\\!\\left(-\\alpha\\,r^2\\right)\\,r\\,\\mathrm{d}r\\,\\mathrm{d}\\theta\n$$\n的单样本重要性权重为\n$$\nW_{\\mathrm{P}} \\equiv \\frac{\\exp\\!\\left(-\\alpha\\,R^2\\right)\\,R}{q_{r}(R;\\beta)\\,q_{\\theta}(\\Theta)}。\n$$\n\n对于下面测试套件中的每一组参数 $(\\alpha,\\sigma,\\beta)$，在确保两个方差均为有限的条件 $\\alpha>\\frac{1}{4\\sigma^2}$ 和 $0<\\beta<2\\alpha$ 下，计算比率\n$$\n\\rho(\\alpha,\\sigma,\\beta) \\equiv \\frac{\\operatorname{Var}(W_{\\mathrm{C}})}{\\operatorname{Var}(W_{\\mathrm{P}})}。\n$$\n因为对于两种方案，样本均值的方差都与相同的样本量成反比，所以 $\\rho$ 值越大，表示在相同样本数量下，极坐标方案相对于笛卡尔方案的效率越高。\n\n测试套件：对以下参数集（每组均写作 $(\\alpha,\\sigma,\\beta)$）评估并报告 $\\rho(\\alpha,\\sigma,\\beta)$：\n- $(\\alpha,\\sigma,\\beta) = (1.0, 1.0, 0.7)$，\n- $(\\alpha,\\sigma,\\beta) = (0.26, 1.0, 0.1)$，\n- $(\\alpha,\\sigma,\\beta) = (0.55, 0.7, 1.08)$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，“[v1,v2,v3]”），其中每个 $v_i$ 是对应的 $\\rho$ 值，并四舍五入到恰好六位小数。本问题不涉及物理单位，所有角度均以弧度为单位。", "solution": "该问题要求分析计算比率 $\\rho(\\alpha,\\sigma,\\beta) \\equiv \\frac{\\operatorname{Var}(W_{\\mathrm{C}})}{\\operatorname{Var}(W_{\\mathrm{P}})}$，该比率用于比较一个笛卡尔方案和一个极坐标重要性抽样方案在求解特定二维积分时的效率。$\\rho$ 值越高表示极坐标方案效率越高。该问题是适定的、科学上合理的，并且所有参数的定义都确保了方差是有限的。我们着手进行分析推导。\n\n一个重要性权重 $W$ 的方差由 $\\operatorname{Var}(W) = \\mathbb{E}[W^2] - (\\mathbb{E}[W])^2$ 给出。对于任何有效的重要性抽样方案，权重的期望 $\\mathbb{E}[W]$ 等于积分的真实值 $I(\\alpha)$。\n首先，我们计算积分 $I(\\alpha)$：\n$$\nI(\\alpha) \\equiv \\int_{\\mathbb{R}^2} \\exp\\!\\left(-\\alpha\\,(x^2+y^2)\\right)\\,\\mathrm{d}x\\,\\mathrm{d}y\n$$\n通过转换为极坐标 $(r, \\theta)$，其中 $x^2+y^2=r^2$ 且 $\\mathrm{d}x\\,\\mathrm{d}y = r\\,\\mathrm{d}r\\,\\mathrm{d}\\theta$，我们得到：\n$$\nI(\\alpha) = \\int_{0}^{2\\pi} \\mathrm{d}\\theta \\int_{0}^{\\infty} \\exp(-\\alpha r^2) r\\,\\mathrm{d}r = 2\\pi \\left[ -\\frac{1}{2\\alpha} \\exp(-\\alpha r^2) \\right]_{0}^{\\infty} = 2\\pi \\left( 0 - \\left(-\\frac{1}{2\\alpha}\\right) \\right) = \\frac{\\pi}{\\alpha}\n$$\n因此，对于两种方案，$(\\mathbb{E}[W])^2 = (I(\\alpha))^2 = (\\pi/\\alpha)^2$。任务的核心是计算 $\\mathbb{E}[W_{\\mathrm{C}}^2]$ 和 $\\mathbb{E}[W_{\\mathrm{P}}^2]$。这由通用公式 $\\mathbb{E}[W^2] = \\int \\frac{f(z)^2}{q(z)}\\,\\mathrm{d}z$ 给出，其中 $z$ 代表积分变量。\n\n**1. 笛卡尔权重的方差, $\\operatorname{Var}(W_{\\mathrm{C}})$**\n\n被积函数为 $f(x,y;\\alpha) = \\exp(-\\alpha(x^2+y^2))$，提议分布为 $q_{\\mathrm{C}}(x,y;\\sigma) = \\frac{1}{2\\pi\\sigma^2}\\exp(-\\frac{x^2+y^2}{2\\sigma^2})$。权重的二阶矩为：\n$$\n\\mathbb{E}[W_{\\mathrm{C}}^2] = \\int_{\\mathbb{R}^2} \\frac{\\left[ \\exp(-\\alpha(x^2+y^2)) \\right]^2}{\\frac{1}{2\\pi\\sigma^2}\\exp(-\\frac{x^2+y^2}{2\\sigma^2})} \\,\\mathrm{d}x\\,\\mathrm{d}y = 2\\pi\\sigma^2 \\int_{\\mathbb{R}^2} \\exp\\left(-\\left(2\\alpha - \\frac{1}{2\\sigma^2}\\right)(x^2+y^2)\\right) \\,\\mathrm{d}x\\,\\mathrm{d}y\n$$\n这个积分的形式为 $I(\\alpha')$，其中 $\\alpha' = 2\\alpha - \\frac{1}{2\\sigma^2}$。问题给出的条件 $\\alpha > \\frac{1}{4\\sigma^2}$ 确保了 $\\alpha'>0$，因此积分收敛。\n$$\n\\mathbb{E}[W_{\\mathrm{C}}^2] = 2\\pi\\sigma^2 \\cdot I(\\alpha') = 2\\pi\\sigma^2 \\cdot \\frac{\\pi}{\\alpha'} = 2\\pi\\sigma^2 \\frac{\\pi}{2\\alpha - \\frac{1}{2\\sigma^2}} = \\frac{4\\pi^2\\sigma^4}{4\\alpha\\sigma^2 - 1}\n$$\n那么方差为：\n$$\n\\operatorname{Var}(W_{\\mathrm{C}}) = \\mathbb{E}[W_{\\mathrm{C}}^2] - \\left(\\frac{\\pi}{\\alpha}\\right)^2 = \\frac{4\\pi^2\\sigma^4}{4\\alpha\\sigma^2 - 1} - \\frac{\\pi^2}{\\alpha^2} = \\pi^2\\left(\\frac{4\\alpha^2\\sigma^4 - (4\\alpha\\sigma^2-1)}{\\alpha^2(4\\alpha\\sigma^2 - 1)}\\right) = \\pi^2 \\frac{(2\\alpha\\sigma^2 - 1)^2}{\\alpha^2(4\\alpha\\sigma^2 - 1)}\n$$\n\n**2. 极坐标权重的方差, $\\operatorname{Var}(W_{\\mathrm{P}})$**\n\n在极坐标中，包含雅可比因子的被积函数是 $g(r,\\theta) = r\\exp(-\\alpha r^2)$。提议分布为 $q_{\\mathrm{P}}(r,\\theta;\\beta) = q_{r}(r;\\beta)q_{\\theta}(\\theta) = \\left(2\\beta r \\exp(-\\beta r^2)\\right) \\left(\\frac{1}{2\\pi}\\right)$。权重的二阶矩为：\n$$\n\\mathbb{E}[W_{\\mathrm{P}}^2] = \\int_{0}^{2\\pi}\\int_{0}^{\\infty} \\frac{\\left[r\\exp(-\\alpha r^2)\\right]^2}{\\frac{2\\beta r}{2\\pi}\\exp(-\\beta r^2)} \\,\\mathrm{d}r\\,\\mathrm{d}\\theta = \\frac{\\pi}{\\beta} \\int_{0}^{2\\pi}\\mathrm{d}\\theta \\int_{0}^{\\infty} r \\exp\\left(-(2\\alpha-\\beta)r^2\\right)\\,\\mathrm{d}r\n$$\n对 $\\theta$ 的积分得到 $2\\pi$。对 $r$ 的积分是熟悉的形式。令 $\\alpha'' = 2\\alpha - \\beta$。条件 $0 < \\beta < 2\\alpha$ 确保 $\\alpha''>0$。\n$$\n\\mathbb{E}[W_{\\mathrm{P}}^2] = \\frac{\\pi}{\\beta} \\cdot 2\\pi \\cdot \\int_{0}^{\\infty} r \\exp(-\\alpha'' r^2) \\,\\mathrm{d}r = \\frac{2\\pi^2}{\\beta} \\left[ -\\frac{1}{2\\alpha''} \\exp(-\\alpha'' r^2) \\right]_0^\\infty = \\frac{2\\pi^2}{\\beta} \\frac{1}{2\\alpha''} = \\frac{\\pi^2}{\\beta(2\\alpha-\\beta)}\n$$\n那么方差为：\n$$\n\\operatorname{Var}(W_{\\mathrm{P}}) = \\mathbb{E}[W_{\\mathrm{P}}^2] - \\left(\\frac{\\pi}{\\alpha}\\right)^2 = \\frac{\\pi^2}{\\beta(2\\alpha-\\beta)} - \\frac{\\pi^2}{\\alpha^2} = \\pi^2\\left(\\frac{\\alpha^2 - \\beta(2\\alpha-\\beta)}{\\alpha^2\\beta(2\\alpha-\\beta)}\\right) = \\pi^2 \\frac{(\\alpha-\\beta)^2}{\\alpha^2\\beta(2\\alpha-\\beta)}\n$$\n\n**3. 比率 $\\rho(\\alpha,\\sigma,\\beta)$**\n\n最后，我们计算两个方差的比率。公因子 $\\pi^2$ 和 $\\alpha^2$ 会消掉：\n$$\n\\rho(\\alpha,\\sigma,\\beta) = \\frac{\\operatorname{Var}(W_{\\mathrm{C}})}{\\operatorname{Var}(W_{\\mathrm{P}})} = \\frac{\\frac{(2\\alpha\\sigma^2 - 1)^2}{4\\alpha\\sigma^2 - 1}}{\\frac{(\\alpha-\\beta)^2}{\\beta(2\\alpha-\\beta)}} = \\frac{(2\\alpha\\sigma^2 - 1)^2 \\beta (2\\alpha-\\beta)}{(4\\alpha\\sigma^2 - 1) (\\alpha-\\beta)^2}\n$$\n这就是最终的分析公式。我们现在将其应用于测试用例。\n\n对于 $(\\alpha,\\sigma,\\beta) = (1.0, 1.0, 0.7)$:\n$$ \\rho = \\frac{(2(1.0)(1.0)^2 - 1)^2 (0.7) (2(1.0)-0.7)}{(4(1.0)(1.0)^2 - 1) (1.0-0.7)^2} = \\frac{(1)^2 (0.7)(1.3)}{(3)(0.3)^2} = \\frac{0.91}{0.27} \\approx 3.370370 $$\n对于 $(\\alpha,\\sigma,\\beta) = (0.26, 1.0, 0.1)$:\n$$ \\rho = \\frac{(2(0.26)(1.0)^2 - 1)^2 (0.1) (2(0.26)-0.1)}{(4(0.26)(1.0)^2 - 1) (0.26-0.1)^2} = \\frac{(-0.48)^2 (0.1)(0.42)}{(0.04)(0.16)^2} = \\frac{0.0096768}{0.001024} = 9.450000 $$\n对于 $(\\alpha,\\sigma,\\beta) = (0.55, 0.7, 1.08)$:\n$$ \\sigma^2 = 0.49 \\implies \\rho = \\frac{(2(0.55)(0.49) - 1)^2 (1.08) (2(0.55)-1.08)}{(4(0.55)(0.49) - 1) (0.55-1.08)^2} = \\frac{(-0.461)^2 (1.08)(0.02)}{(0.078)(-0.53)^2} \\approx 0.209512 $$\n程序实现将以编程方式计算这些表达式。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Calculates the ratio of variances for two importance sampling schemes\n    for a given set of test parameters.\n    \"\"\"\n    # Define the test cases from the problem statement as tuples (alpha, sigma, beta).\n    test_cases = [\n        (1.0, 1.0, 0.7),\n        (0.26, 1.0, 0.1),\n        (0.55, 0.7, 1.08),\n    ]\n\n    results = []\n    for case in test_cases:\n        alpha, sigma, beta = case\n\n        # The analytical formula for the ratio of variances, rho, is:\n        # rho = [ (2*alpha*sigma^2 - 1)^2 * beta * (2*alpha - beta) ] /\n        #       [ (4*alpha*sigma^2 - 1) * (alpha - beta)^2 ]\n        # This formula was derived by analytically computing Var(W_C) and Var(W_P).\n\n        sigma_sq = sigma**2\n\n        # Numerator calculation\n        term_num_1 = (2 * alpha * sigma_sq - 1)**2\n        term_num_2 = beta * (2 * alpha - beta)\n        numerator = term_num_1 * term_num_2\n\n        # Denominator calculation\n        term_den_1 = (4 * alpha * sigma_sq - 1)\n        term_den_2 = (alpha - beta)**2\n        denominator = term_den_1 * term_den_2\n        \n        # In this problem, the conditions on alpha, sigma, and beta ensure\n        # that the denominator is not zero.\n        rho = numerator / denominator\n        results.append(rho)\n\n    # Format the results to six decimal places and create the output string.\n    formatted_results = [f\"{r:.6f}\" for r in results]\n    \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "2402986"}, {"introduction": "在掌握了如何为单个积分优化提议分布之后，一个非常实际的问题浮出水面：我们能否重用一次昂贵的采样过程生成的样本，来估计其他相关的积分？这个问题的答案凸显了重要性采样的强大灵活性和效率。\n\n本练习将引导您探讨这一核心技巧。您需要分析，在使用为计算积分 $I_f = \\int f(x)dx$ 所生成的样本来估计另一个积分 $J = \\int \\sqrt{f(x)}dx$ 时，如何正确地重新计算权重，并研究这种做法对估计结果方差的影响。[@problem_id:2402977]", "problem": "考虑一个可测域 $D \\subset \\mathbb{R}^d$，其勒贝格测度为 $|D| \\in (0,+\\infty]$。设 $f:D \\to [0,+\\infty)$ 是一个可测函数，在 $D$ 上几乎处处严格为正，并且是可积的，其积分为 $K \\equiv \\int_D f(x)\\,dx < +\\infty$。您已经从一个提议概率密度 $p(x)$ 中生成了 $N$ 个独立同分布的样本 $x_1,\\dots,x_N$。该密度满足在 $f(x) > 0$ 的任意位置都有 $p(x) > 0$。为了估计积分 $I_f \\equiv \\int_D f(x)\\,dx$，您存储了与这些样本相关的常规重要性采样权重 $w_i \\equiv f(x_i)/p(x_i)$。现在，您希望估计 $J \\equiv \\int_D \\sqrt{f(x)}\\,dx$。\n\n哪个选项最能描述您是否可以重用相同的样本和权重来获得对 $J$ 的一个统计上可靠的估计，以及您应该期望得到什么样的方差，特别是在常见的设计选择 $p(x) \\propto f(x)$ 的情况下？\n\nA. 重用样本 $x_i$ 和原始权重 $w_i = f(x_i)/p(x_i)$，不做任何改变。估计量 $\\frac{1}{N}\\sum_{i=1}^N w_i$ 是 $J$ 的无偏估计量，并且当 $p(x) \\propto f(x)$ 时方差最小。\n\nB. 您可以重用相同的样本 $x_i$，但必须重新计算权重为 $w_i' = \\sqrt{f(x_i)}/p(x_i)$。估计量 $\\frac{1}{N}\\sum_{i=1}^N w_i'$ 是 $J$ 的无偏估计量，其方差为 $\\frac{1}{N}\\left(\\int_D \\frac{f(x)}{p(x)}\\,dx - J^2\\right)$。特别地，如果 $p(x) = f(x)/K$ 并且在 $D$ 上几乎处处有 $f(x) > 0$，那么方差 $\\mathrm{Var} = \\frac{1}{N}\\left(K\\,|D| - J^2\\right)$，当 $|D| = +\\infty$ 时，该方差为无穷大。\n\nC. 您完全不能重用样本 $x_i$。为了避免偏差，您必须从一个与 $\\sqrt{f(x)}$ 成正比的提议密度中抽取一组新的样本，任何重用原始样本的尝试都会导致偏差。\n\nD. 将原始权重自归一化为 $\\tilde{w}_i = w_i/\\sum_{j=1}^N w_j$ 并与相同样本一起重用，可以得到一个 $J$ 的无偏估计量，并且无论 $p(x)$ 如何，其方差总是低于未归一化的重要性采样估计量。", "solution": "该问题陈述经核实是科学上合理的、提法得当且客观的。它提出了一个蒙特卡洛积分理论中的标准问题。我们可以开始进行解答。\n\n重要性采样的基本原理是通过将积分 $I_g = \\int_D g(x) \\,dx$ 重写为关于一个提议概率密度 $p(x)$ 的期望来估计该积分。提议密度必须在所有 $g(x) \\neq 0$ 的 $x \\in D$ 处满足 $p(x) > 0$。该积分表示为：\n$$ I_g = \\int_D \\frac{g(x)}{p(x)} p(x) \\,dx = \\mathbb{E}_{X \\sim p} \\left[ \\frac{g(X)}{p(X)} \\right] $$\n给定从 $p(x)$ 中抽取的 $N$ 个独立同分布 (i.i.d.) 样本 $x_1, \\dots, x_N$，$I_g$ 的一个无偏估计量由样本均值给出：\n$$ \\hat{I}_g = \\frac{1}{N} \\sum_{i=1}^N \\frac{g(x_i)}{p(x_i)} $$\n在本问题中，我们希望估计积分 $J \\equiv \\int_D \\sqrt{f(x)}\\,dx$。我们将被积函数确定为 $g(x) = \\sqrt{f(x)}$。问题陈述说明样本 $x_i$ 是从一个提议密度 $p(x)$ 中抽取的，该密度在 $f(x) > 0$ 的任意位置都满足 $p(x) > 0$。由于 $f(x) > 0$ 意味着 $\\sqrt{f(x)} > 0$，因此估计 $J$ 的支撑条件得到满足。所以，我们可以重用现有的样本 $x_i$。\n\n通过设置 $g(x) = \\sqrt{f(x)}$，可以构建出 $J$ 的正确重要性采样估计量：\n$$ \\hat{J} = \\frac{1}{N} \\sum_{i=1}^N \\frac{\\sqrt{f(x_i)}}{p(x_i)} $$\n这个和式中的项 $w_i' \\equiv \\frac{\\sqrt{f(x_i)}}{p(x_i)}$ 是估计 $J$ 所需的新重要性权重。它们不同于用于估计 $I_f = \\int_D f(x)\\,dx$ 的原始权重 $w_i = f(x_i)/p(x_i)$。\n\n必须检验该估计量 $\\hat{J}$ 的统计特性。\n首先是它的期望（偏差）：\n$$ \\mathbb{E}[\\hat{J}] = \\mathbb{E}\\left[\\frac{1}{N} \\sum_{i=1}^N \\frac{\\sqrt{f(X_i)}}{p(X_i)}\\right] = \\frac{1}{N} \\sum_{i=1}^N \\mathbb{E}\\left[\\frac{\\sqrt{f(X_i)}}{p(X_i)}\\right] $$\n由于样本是独立同分布的，每一项的期望都相同：\n$$ \\mathbb{E}\\left[\\frac{\\sqrt{f(X)}}{p(X)}\\right] = \\int_D \\frac{\\sqrt{f(x)}}{p(x)} p(x) \\,dx = \\int_D \\sqrt{f(x)} \\,dx = J $$\n因此，$\\mathbb{E}[\\hat{J}] = \\frac{1}{N} (N \\cdot J) = J$。该估计量是无偏的。\n\n其次是它的方差：\n$N$ 个独立同分布随机变量的样本均值的方差是单个变量方差的 $\\frac{1}{N}$ 倍。\n$$ \\mathrm{Var}[\\hat{J}] = \\frac{1}{N} \\mathrm{Var}\\left[\\frac{\\sqrt{f(X)}}{p(X)}\\right] $$\n使用公式 $\\mathrm{Var}[Y] = \\mathbb{E}[Y^2] - (\\mathbb{E}[Y])^2$ 并设 $Y = \\frac{\\sqrt{f(X)}}{p(X)}$，我们有 $\\mathbb{E}[Y] = J$。二阶矩为：\n$$ \\mathbb{E}[Y^2] = \\mathbb{E}\\left[\\left(\\frac{\\sqrt{f(X)}}{p(X)}\\right)^2\\right] = \\mathbb{E}\\left[\\frac{f(X)}{p(X)^2}\\right] = \\int_D \\frac{f(x)}{p(x)^2} p(x) \\,dx = \\int_D \\frac{f(x)}{p(x)} \\,dx $$\n因此，估计量 $\\hat{J}$ 的方差为：\n$$ \\mathrm{Var}[\\hat{J}] = \\frac{1}{N} \\left( \\int_D \\frac{f(x)}{p(x)} \\,dx - J^2 \\right) $$\n现在，我们考虑特定的设计选择 $p(x) \\propto f(x)$。要使 $p(x)$ 成为一个有效的概率密度，它的积分必须为1。给定 $\\int_D f(x)\\,dx = K$，正确的归一化是 $p(x) = f(x)/K$。将此代入方差表达式中：\n$$ \\int_D \\frac{f(x)}{p(x)} \\,dx = \\int_D \\frac{f(x)}{f(x)/K} \\,dx = \\int_D K \\,dx = K \\int_D 1 \\,dx = K|D| $$\n其中 $|D|$ 是域 $D$ 的勒贝格测度。方差变为：\n$$ \\mathrm{Var}[\\hat{J}] = \\frac{1}{N} \\left( K|D| - J^2 \\right) $$\n这个结果只有在积分 $\\int_D K \\,dx$ 收敛时才有效。如果域 $D$ 的测度是无穷的，即 $|D| = +\\infty$，那么这个积分是发散的，估计量 $\\hat{J}$ 的方差也是无穷的。\n\n通过这些推导，我们来评估每个选项。\n\n**A. 重用样本 $x_i$ 和原始权重 $w_i = f(x_i)/p(x_i)$，不做任何改变。估计量 $\\frac{1}{N}\\sum_{i=1}^N w_i$ 是 $J$ 的无偏估计量，并且当 $p(x) \\propto f(x)$ 时方差最小。**\n提议的估计量是 $\\hat{I}_f = \\frac{1}{N}\\sum_{i=1}^N w_i$。其期望是 $\\mathbb{E}[\\hat{I}_f] = \\int_D f(x)\\,dx = K$。这个估计量是 $I_f$ 的无偏估计量，而不是 $J = \\int_D \\sqrt{f(x)}\\,dx$ 的无偏估计量。声称它是 $J$ 的无偏估计量是错误的。关于当 $p(x)$ 作此选择时方差最小的说法，是针对估计 $I_f$ 而言，而非 $J$。\n结论：**不正确**。\n\n**B. 您可以重用相同的样本 $x_i$，但必须重新计算权重为 $w_i' = \\sqrt{f(x_i)}/p(x_i)$。估计量 $\\frac{1}{N}\\sum_{i=1}^N w_i'$ 是 $J$ 的无偏估计量，其方差为 $\\frac{1}{N}\\left(\\int_D \\frac{f(x)}{p(x)}\\,dx - J^2\\right)$。特别地，如果 $p(x) = f(x)/K$ 并且在 $D$ 上几乎处处有 $f(x) > 0$，那么方差 $\\mathrm{Var} = \\frac{1}{N}\\left(K\\,|D| - J^2\\right)$，当 $|D| = +\\infty$ 时，该方差为无穷大。**\n这个选项正确地指出，可以重用样本，但需要新的权重 $w_i' = \\sqrt{f(x_i)}/p(x_i)$。我们的推导证实了估计量 $\\hat{J} = \\frac{1}{N}\\sum_{i=1}^N w_i'$ 确实是 $J$ 的无偏估计量。其方差的表达式 $\\frac{1}{N}\\left(\\int_D \\frac{f(x)}{p(x)}\\,dx - J^2\\right)$ 与我们推导出的完全一致。随后对特殊情况 $p(x) = f(x)/K$ 的分析，得出方差为 $\\frac{1}{N}\\left(K|D| - J^2\\right)$ 及其在 $|D|=\\infty$ 时发散的结论，也是正确的。该陈述的每一部分都通过我们的严谨分析得到了验证。\n结论：**正确**。\n\n**C. 您完全不能重用样本 $x_i$。为了避免偏差，您必须从一个与 $\\sqrt{f(x)}$ 成正比的提议密度中抽取一组新的样本，任何重用原始样本的尝试都会导致偏差。**\n这个陈述有根本性的错误。重要性采样的一个关键优势是能够重用同一组样本来估计多个不同的积分，只要每个积分的支撑条件都成立。我们对选项 B 的分析表明，通过重新计算权重来重用样本 $x_i$ 可以得到一个可证明的 $J$ 的无偏估计量。声称这个过程会导致偏差是错误的。虽然从 $p(x) \\propto \\sqrt{f(x)}$ 进行采样对于估计 $J$ 是最优的（会产生零方差），但这并不是获得无偏估计的唯一方法。\n结论：**不正确**。\n\n**D. 将原始权重自归一化为 $\\tilde{w}_i = w_i/\\sum_{j=1}^N w_j$ 并与相同样本一起重用，可以得到一个 $J$ 的无偏估计量，并且无论 $p(x)$ 如何，其方差总是低于未归一化的重要性采样估计量。**\n这个选项描述了一种自归一化重要性采样方案。首先，对于与 $I_f$ 不成比例的量，任何此类估计量对于有限样本量 $N$ 通常是有偏的，尽管它通常是渐近无偏的。声称其无偏是错误的。其次，声称其方差*总是*更低的说法也是错误的；虽然自归一化可能是有益的，特别是在提议密度的归一化常数未知时，但它并不能保证在所有情况下都能减小方差。第三，关于如何使用这些归一化权重 $\\tilde{w}_i$ 来构成 $J$ 的估计量的描述是模糊的，并且在标准解释下，并不能得到一个 $J$ 的估计量。\n结论：**不正确**。", "answer": "$$\\boxed{B}$$", "id": "2402977"}, {"introduction": "现在，让我们将前面学到的原理应用到一个来自现代计算科学的前沿问题中：估计稀有事件的概率。在许多物理和工程系统中，我们关心的恰恰是那些虽然罕见但后果重大的事件，而直接的蒙特卡洛模拟在这种情况下效率极低。\n\n本练习要求您编写一个完整的程序，来计算一个随机矩阵接近奇异（即其行列式值非常小）的概率。这需要您设计一个能够有效采样稀有事件区域的提议分布，并在一个高维空间中完整地实现重要性采样的所有步骤，从而体验该方法在解决复杂问题时的威力。[@problem_id:2402958]", "problem": "给定一个随机矩阵模型和一个由行列式大小定义的事件。设 $A \\in \\mathbb{R}^{2 \\times 2}$ 是一个随机矩阵，服从矩阵正态分布，其均值为零，行协方差为 $U \\in \\mathbb{R}^{2 \\times 2}$，列协方差为 $V \\in \\mathbb{R}^{2 \\times 2}$。这记作 $A \\sim \\mathcal{MN}\\!\\left(0, U, V\\right)$，意味着其向量化 $\\operatorname{vec}(A) \\in \\mathbb{R}^{4}$ 服从多元正态分布，均值为零，协方差为 $\\Sigma = V \\otimes U$，其中 $\\otimes$ 表示 Kronecker 积。对于给定的阈值 $\\tau \\ge 0$，定义事件 $E_{\\tau} = \\{A : |\\det(A)| \\le \\tau\\}$ 和目标概率\n$$\nP(\\tau) = \\mathbb{P}\\left(|\\det(A)| \\le \\tau\\right) = \\int_{\\mathbb{R}^{4}} \\mathbf{1}\\left(|\\det(A)| \\le \\tau\\right) \\, p_{\\Sigma}\\!\\left(\\operatorname{vec}(A)\\right) \\, d\\operatorname{vec}(A),\n$$\n其中 $p_{\\Sigma}$ 是多元正态分布 $\\mathcal{N}\\!\\left(0, \\Sigma\\right)$ 的密度。\n\n您将使用蒙特卡洛重要性采样方法计算 $P(\\tau)$。该方法使用一个提议矩阵正态分布 $Q$，其均值为零，协方差为 $U_{q}$ 和 $V_{q}$，由此导出 $\\operatorname{vec}(A)$ 的提议协方差为 $\\Sigma_{q} = V_{q} \\otimes U_{q}$。相应的目标协方差为 $\\Sigma_{p} = V \\otimes U$。\n\n下面使用的所有矩阵都是对称正定的，并明确指定如下：\n$$\nU = \\begin{pmatrix} 1 & 0.8 \\\\ 0.8 & 1 \\end{pmatrix}, \\quad\nV = \\begin{pmatrix} 1 & 0.3 \\\\ 0.3 & 1 \\end{pmatrix},\n$$\n$$\nU_{q} = \\begin{pmatrix} 1 & 0.98 \\\\ 0.98 & 1 \\end{pmatrix}, \\quad\nV_{q} = \\begin{pmatrix} 1 & 0.9 \\\\ 0.9 & 1 \\end{pmatrix}.\n$$\n\n无输入程序要求。您的程序必须在不读取任何输入的情况下，为以下包含阈值、样本量和随机种子的测试套件估计 $P(\\tau)$：\n- 案例 A（边界事件，其测度基本为零）：$\\tau = 0$，$N = 100000$，种子 $= 12345$。\n- 案例 B（典型的中间尺度）：$\\tau = 0.5$，$N = 100000$，种子 $= 24680$。\n- 案例 C（接近确定性的高阈值）：$\\tau = 10$，$N = 100000$，种子 $= 13579$。\n\n在所有案例中，必须从协方差为 $\\Sigma_{q}$ 的提议分布中进行采样，并使用目标分布（协方差为 $\\Sigma_{p}$）相对于提议分布的重要性比率进行加权。每个案例的最终答案是 $P(\\tau)$ 的蒙特卡洛估计值，以实数形式表示。\n\n最终输出格式。您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，按案例 A、案例 B、案例 C 的顺序列出结果，每个数字需精确到小数点后六位（例如，$[0.000000,0.123456,0.999999]$）。不应打印任何额外文本。", "solution": "所述问题是有效的。它具有科学依据、是适定且客观的。它提出了一个统计物理领域的明确计算任务，具体来说，是使用蒙特卡洛重要性采样方法估计一个概率积分。所有参数和分布都得到了严格定义。\n\n目标是计算一个随机矩阵 $A \\in \\mathbb{R}^{2 \\times 2}$ 的概率 $P(\\tau) = \\mathbb{P}(|\\det(A)| \\le \\tau)$，该矩阵从矩阵正态分布 $A \\sim \\mathcal{MN}(0, U, V)$ 中抽取。该概率可以表示为在向量化矩阵空间 $\\mathbb{R}^4$ 上的积分：\n$$\nP(\\tau) = \\int_{\\mathbb{R}^{4}} \\mathbf{1}(|\\det(A)| \\le \\tau) \\, p_{\\Sigma_p}(\\operatorname{vec}(A)) \\, d\\operatorname{vec}(A)\n$$\n其中 $p_{\\Sigma_p}$ 是目标多元正态分布 $\\mathcal{N}(0, \\Sigma_p)$ 的概率密度函数（PDF），其协方差为 $\\Sigma_p = V \\otimes U$。函数 $\\mathbf{1}(\\cdot)$ 是示性函数。\n\n直接蒙特卡洛估计将涉及从 $p_{\\Sigma_p}$ 中采样并计算满足事件条件的样本比例。这种方法可能效率低下，特别是当 $\\tau$ 很小，事件很稀有时。该问题指定使用重要性采样，通过从一个不同的提议分布 $q$ 中采样来提高效率，该分布将样本集中在感兴趣的区域。这里的提议分布是另一个矩阵正态分布 $A_q \\sim \\mathcal{MN}(0, U_q, V_q)$，它导出 $\\operatorname{vec}(A_q) \\sim \\mathcal{N}(0, \\Sigma_q)$ 的 PDF $p_{\\Sigma_q}$，其中 $\\Sigma_q = V_q \\otimes U_q$。\n\n重要性采样的核心原理依赖于将积分改写为关于提议分布的期望：\n$$\nP(\\tau) = \\mathbb{E}_{p_{\\Sigma_p}}[\\mathbf{1}(|\\det(A)| \\le \\tau)] = \\int \\mathbf{1}(|\\det(A)| \\le \\tau) \\frac{p_{\\Sigma_p}(\\operatorname{vec}(A))}{p_{\\Sigma_q}(\\operatorname{vec}(A))} p_{\\Sigma_q}(\\operatorname{vec}(A)) \\, d\\operatorname{vec}(A)\n$$\n这导出了以下表达式：\n$$\nP(\\tau) = \\mathbb{E}_{p_{\\Sigma_q}}\\left[\\mathbf{1}(|\\det(A)| \\le \\tau) \\, w(\\operatorname{vec}(A))\\right]\n$$\n其中 $w(x) = p_{\\Sigma_p}(x) / p_{\\Sigma_q}(x)$ 是状态 $x = \\operatorname{vec}(A)$ 的重要性权重。\n\n$P(\\tau)$ 的蒙特卡洛估计量是通过从提议分布中抽取 $N$ 个独立样本 $A^{(i)}$ 得到的样本均值：\n$$\n\\hat{P}_N(\\tau) = \\frac{1}{N} \\sum_{i=1}^{N} \\mathbf{1}(|\\det(A^{(i)})| \\le \\tau) \\, w(\\operatorname{vec}(A^{(i)}))\n$$\n一个 $k$ 维零均值多元正态分布 $\\mathcal{N}(0, \\Sigma)$ 的 PDF 由 $p_{\\Sigma}(x) = ((2\\pi)^k \\det(\\Sigma))^{-1/2} \\exp(-\\frac{1}{2} x^T \\Sigma^{-1} x)$ 给出。对于我们的 $k=4$ 的情况，重要性权重 $w(x)$ 是目标 PDF 与提议 PDF 的比率：\n$$\nw(x) = \\frac{p_{\\Sigma_p}(x)}{p_{\\Sigma_q}(x)} = \\sqrt{\\frac{\\det(\\Sigma_q)}{\\det(\\Sigma_p)}} \\exp\\left(-\\frac{1}{2} x^T (\\Sigma_p^{-1} - \\Sigma_q^{-1}) x\\right)\n$$\n所需的协方差矩阵是使用 Kronecker 积构建的，即 $\\Sigma_p = V \\otimes U$ 和 $\\Sigma_q = V_q \\otimes U_q$。它们的逆矩阵同样由 $\\Sigma_p^{-1} = V^{-1} \\otimes U^{-1}$ 和 $\\Sigma_q^{-1} = V_q^{-1} \\otimes U_q^{-1}$ 给出。\n\n计算算法的步骤如下：\n1.  定义矩阵 $U$、$V$、$U_q$ 和 $V_q$。\n2.  使用 Kronecker 积构建目标和提议协方差矩阵 $\\Sigma_p$ 和 $\\Sigma_q$。\n3.  预先计算权重的常数部分 $C = \\sqrt{\\det(\\Sigma_q)/\\det(\\Sigma_p)}$ 和指数中二次型的矩阵 $M = \\Sigma_p^{-1} - \\Sigma_q^{-1}$。\n4.  对于每个指定的测试案例 $(\\tau, N, \\text{seed})$：\n    a. 使用给定的种子初始化随机数生成器以确保可复现性。\n    b. 从提议分布 $\\mathcal{N}(0, \\Sigma_q)$ 中生成 $N$ 个样本 $x^{(i)}$。每个 $x^{(i)}$ 是一个 4 元素向量。\n    c. 对于每个样本 $x^{(i)}$，根据 $\\operatorname{vec}(A)$ 是将 $A$ 的列堆叠起来的约定，重构相应的矩阵 $A^{(i)}$。具体来说，如果 $x = [x_0, x_1, x_2, x_3]^T$，那么 $A = \\begin{pmatrix} x_0 & x_2 \\\\ x_1 & x_3 \\end{pmatrix}$。\n    d. 计算行列式 $\\det(A^{(i)}) = x_0^{(i)}x_3^{(i)} - x_1^{(i)}x_2^{(i)}$。\n    e. 如果 $|\\det(A^{(i)})| \\le \\tau$，则计算重要性权重 $w(x^{(i)}) = C \\exp(-\\frac{1}{2} (x^{(i)})^T M x^{(i)})$ 并将其加到一个运行总和中。\n    f. 该案例的估计值是累积的总权重除以 $N$。\n\n对于 $\\tau=0$ 的案例 A，事件是 $|\\det(A)| = 0$。奇异 $2 \\times 2$ 矩阵的集合在 $\\mathbb{R}^4$ 中构成一个低维流形，因此其勒贝格测度为零。一个连续分布的随机变量落在这个集合上的概率是 $0$。因此，理论值为 $P(0)=0$，并且蒙特卡洛估计值也几乎必然是 $0$。\n\n提议分布中 $U_q$ 和 $V_q$ 的相关性高于 $U$ 和 $V$ 中的相关性，其选择是为了生成更频繁“接近奇异”的矩阵。这将采样工作集中在 $\\det(A)$ 较小的区域，这是计算概率最相关的区域，从而提高了估计量的统计效率。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Estimates the probability P(tau) = P(|det(A)| <= tau) for a random matrix A\n    using Monte Carlo importance sampling.\n    \"\"\"\n    # Define covariance matrices from the problem statement.\n    # Target distribution covariances\n    U = np.array([[1.0, 0.8], [0.8, 1.0]], dtype=np.float64)\n    V = np.array([[1.0, 0.3], [0.3, 1.0]], dtype=np.float64)\n    # Proposal distribution covariances\n    U_q = np.array([[1.0, 0.98], [0.98, 1.0]], dtype=np.float64)\n    V_q = np.array([[1.0, 0.9], [0.9, 1.0]], dtype=np.float64)\n\n    # Construct the full 4x4 covariance matrices using the Kronecker product.\n    # Sigma_p for the target distribution p(x)\n    Sigma_p = np.kron(V, U)\n    # Sigma_q for the proposal distribution q(x)\n    Sigma_q = np.kron(V_q, U_q)\n\n    # Pre-compute components of the importance weight w(x) = p(x)/q(x).\n    # The weight is w(x) = sqrt(det(Sigma_q)/det(Sigma_p)) * exp(-0.5 * x^T * (inv(Sigma_p) - inv(Sigma_q)) * x)\n    \n    # Determinants\n    det_p = np.linalg.det(Sigma_p)\n    det_q = np.linalg.det(Sigma_q)\n\n    # Inverses\n    inv_Sigma_p = np.linalg.inv(Sigma_p)\n    inv_Sigma_q = np.linalg.inv(Sigma_q)\n\n    # Constant part of the weight calculation\n    C = np.sqrt(det_q / det_p)\n    \n    # Matrix for the quadratic form in the exponent\n    M = inv_Sigma_p - inv_Sigma_q\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (tau, N, seed)\n        (0.0, 100000, 12345),  # Case A\n        (0.5, 100000, 24680),  # Case B\n        (10.0, 100000, 13579)  # Case C\n    ]\n\n    results = []\n    for tau, N, seed in test_cases:\n        # Set up a random number generator with the specified seed for reproducibility.\n        rng = np.random.default_rng(seed)\n        \n        # Generate N samples from the proposal distribution N(0, Sigma_q).\n        mean = np.zeros(4, dtype=np.float64)\n        samples = rng.multivariate_normal(mean, Sigma_q, size=N, method='cholesky')\n        \n        total_weight_sum = 0.0\n        \n        for x in samples:\n            # The vector x is vec(A), where A = [[x[0], x[2]], [x[1], x[3]]].\n            # Calculate the determinant of the matrix A.\n            det_A = x[0] * x[3] - x[2] * x[1]\n            \n            # Check if the event |det(A)| <= tau occurs.\n            if abs(det_A) <= tau:\n                # If the event occurs, calculate the importance weight.\n                # The exponent is -0.5 * x^T * M * x\n                quad_form = x.T @ M @ x\n                weight = C * np.exp(-0.5 * quad_form)\n                total_weight_sum += weight\n        \n        # The estimate of the probability is the average of the weights.\n        estimate = total_weight_sum / N\n        results.append(estimate)\n\n    # Final print statement in the exact required format.\n    # Format each result to exactly six decimal places.\n    formatted_results = [f\"{r:.6f}\" for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "2402958"}]}