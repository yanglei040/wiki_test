{"hands_on_practices": [{"introduction": "分层抽样是一种直观而强大的方差缩减技术，它通过将积分域划分为若干子域（或“层”），并确保每个子域都有代表性的样本点，来提高蒙特卡洛估计的精度。这个练习将指导你完成一个具体的分层抽样计算，将理论公式应用于一个明确的积分问题。通过这个实践，你将亲身体验如何通过系统性地分配样本来减少估计的随机误差。[@problem_id:1348949]", "id": "1348949", "problem": "一位计算科学家的任务是使用蒙特卡洛模拟来估计定积分 $I = \\int_0^\\pi x \\sin(x) dx$ 的值。为了与简单蒙特卡洛方法相比，减小估计值的方差，我们选择采用分层抽样方法。积分域 $[0, \\pi]$ 被划分为两个等宽的层：$S_1 = [0, \\pi/2]$ 和 $S_2 = [\\pi/2, \\pi]$。\n\n将从每层中抽取两个样本，总共四个样本。从一个标准均匀随机数 $r \\in [0, 1]$ 在层 $[a, b]$ 内生成样本 $u$ 的变换由 $u = a + (b-a)r$ 给出。\n\n假设为该任务生成的四个标准均匀随机数序列为 $0.20$、$0.70$、$0.40$ 和 $0.90$。前两个随机数用于从层 $S_1$ 生成样本，后两个随机数用于层 $S_2$。\n\n计算积分 $I$ 的分层抽样估计值。所有涉及角度的计算都必须以弧度为单位进行。报告你的最终答案，并四舍五入到四位有效数字。", "solution": "我们通过分层抽样来估计 $I=\\int_{0}^{\\pi}x\\sin(x)\\,dx$，其中有两个层 $S_{1}=[0,\\pi/2]$ 和 $S_{2}=[\\pi/2,\\pi]$，每层的宽度均为 $L_{1}=L_{2}=\\pi/2$。每层抽取 $n_{1}=n_{2}=2$ 个样本，分层估计量为\n$$\n\\hat{I}=\\sum_{h=1}^{2}L_{h}\\,\\frac{1}{n_{h}}\\sum_{i=1}^{n_{h}}f(u_{hi})\n=\\frac{\\pi}{2}\\cdot\\frac{1}{2}\\left(\\sum_{i=1}^{2}f(u_{1i})+\\sum_{i=1}^{2}f(u_{2i})\\right)\n=\\frac{\\pi}{4}\\sum_{k=1}^{4}x_{k}\\sin(x_{k}),\n$$\n其中 $f(x)=x\\sin(x)$，$x_{k}$ 是抽样点。\n\n在 $[a,b]$ 内的抽样变换为 $u=a+(b-a)r$。使用给定的 $r$ 值，我们得到：\n$$\n\\begin{aligned}\n&\\text{在 }S_{1}=[0,\\tfrac{\\pi}{2}]\\text{ 中}: &&x_{1}=0+\\tfrac{\\pi}{2}\\cdot 0.20=\\tfrac{\\pi}{10},\\quad x_{2}=0+\\tfrac{\\pi}{2}\\cdot 0.70=\\tfrac{7\\pi}{20},\\\\\n&\\text{在 }S_{2}=[\\tfrac{\\pi}{2},\\pi]\\text{ 中}: &&x_{3}=\\tfrac{\\pi}{2}+\\tfrac{\\pi}{2}\\cdot 0.40=\\tfrac{7\\pi}{10},\\quad x_{4}=\\tfrac{\\pi}{2}+\\tfrac{\\pi}{2}\\cdot 0.90=\\tfrac{19\\pi}{20}.\n\\end{aligned}\n$$\n因此\n$$\n\\hat{I}=\\frac{\\pi}{4}\\left[\\tfrac{\\pi}{10}\\sin\\!\\left(\\tfrac{\\pi}{10}\\right)+\\tfrac{7\\pi}{20}\\sin\\!\\left(\\tfrac{7\\pi}{20}\\right)+\\tfrac{7\\pi}{10}\\sin\\!\\left(\\tfrac{7pi}{10}\\right)+\\tfrac{19\\pi}{20}\\sin\\!\\left(\\tfrac{19\\pi}{20}\\right)\\right].\n$$\n在可能的情况下使用精确的三角函数值，\n$$\n\\sin\\!\\left(\\tfrac{\\pi}{10}\\right)=\\frac{\\sqrt{5}-1}{4},\\qquad \\sin\\!\\left(\\tfrac{7\\pi}{10}\\right)=\\sin\\!\\left(\\tfrac{3\\pi}{10}\\right)=\\frac{\\sqrt{5}+1}{4},\n$$\n并对其余值进行数值计算（以弧度为单位），\n$$\n\\sin\\!\\left(\\tfrac{7\\pi}{20}\\right)\\approx 0.8910065241883679,\\qquad \\sin\\!\\left(\\tfrac{19\\pi}{20}\\right)\\approx 0.1564344650402309.\n$$\n计算函数值：\n$$\n\\begin{aligned}\nf(x_{1})&=\\tfrac{\\pi}{10}\\cdot\\frac{\\sqrt{5}-1}{4}\\approx 0.0970805519362733,\\\\\nf(x_{2})&=\\tfrac{7\\pi}{20}\\cdot 0.8910065241883679\\approx 0.9797128427417635,\\\\\nf(x_{3})&=\\tfrac{7\\pi}{10}\\cdot\\frac{\\sqrt{5}+1}{4}\\approx 1.7791212923103408,\\\\\nf(x_{4})&=\\tfrac{19\\pi}{20}\\cdot 0.1564344650402309\\approx 0.4668824448524499.\n\\end{aligned}\n$$\n将这些值相加得到\n$$\n\\sum_{k=1}^{4}f(x_{k})\\approx 3.3227971318408276,\n$$\n因此\n$$\n\\hat{I}=\\frac{\\pi}{4}\\cdot 3.3227971318408276\\approx 2.609718764690095.\n$$\n四舍五入到四位有效数字得到 $2.610$。（作为参考，该积分的精确值为 $I=\\pi$，因此分层估计值是合理的。）", "answer": "$$\\boxed{2.610}$$"}, {"introduction": "控制变量法通过引入一个与我们目标函数相关且期望已知的辅助变量来降低估计方差。该方法的关键在于确定一个最优权重系数 $b^*$，以最大程度地利用这种相关性。这个练习将引导你从第一性原理出发，通过解析计算来推导这个最优系数，从而加深你对控制变量法背后协方差关系的理解。[@problem_id:1348947]", "id": "1348947", "problem": "在蒙特卡洛方法中，一个常见的任务是估计积分 $I = \\int_a^b g(x) dx$ 的值。这通常通过将该积分重构为一个期望值 $E[f(X)]$ 来实现，其中 $X$ 是一个随机变量，$f$ 是一个相关函数。一个标准的“原始”蒙特卡洛估计量会使用 $N$ 次 $f(X_i)$ 独立抽样的样本均值。\n\n为了在给定样本数量下提高估计的精度，可以采用方差缩减技术。控制变量法就是这样一种技术。该方法需要找到一个与 $f(X)$ 相关且具有已知期望 $\\mu_C = E[C]$ 的随机变量 $C$。然后，可以构建一个新的、改进的估计量 $Z(b) = f(X) - b(C - \\mu_C)$，其中 $b$ 是一个常数系数。选择 $b$ 的值是为了最小化 $Z(b)$ 的方差。这个最优系数记为 $b^*$，由以下公式给出：\n$$b^* = \\frac{\\text{Cov}(f(X), C)}{\\text{Var}(C)}$$\n\n考虑估计积分 $I = \\int_0^1 \\cos\\left(\\frac{\\pi x}{2}\\right) dx$ 的问题。这等价于求 $Y = \\cos\\left(\\frac{\\pi X}{2}\\right)$ 的期望值，其中 $X$ 是一个在区间 $[0, 1]$ 上均匀分布的随机变量。我们将使用随机变量 $C = X$ 作为控制变量，因为它与 $Y$ 相关，且其性质易于确定。\n\n你的任务是计算此控制变量的最优系数 $b^*$ 的精确理论值。请用一个包含 $\\pi$ 的单一闭式解析表达式来表示你的答案。", "solution": "我们有 $X \\sim \\text{Unif}[0,1]$，$Y=\\cos\\left(\\frac{\\pi X}{2}\\right)$ 且 $C=X$。最优控制变量系数为\n$$\nb^{*}=\\frac{\\text{Cov}(Y,C)}{\\text{Var}(C)}.\n$$\n首先计算 $\\text{Var}(C)$。使用 $E[X]=\\int_{0}^{1}x\\,dx=\\frac{1}{2}$ 和 $E[X^{2}]=\\int_{0}^{1}x^{2}\\,dx=\\frac{1}{3}$，我们得到\n$$\n\\text{Var}(C)=E[X^{2}]-\\left(E[X]\\right)^{2}=\\frac{1}{3}-\\frac{1}{4}=\\frac{1}{12}.\n$$\n接下来计算 $E[Y]$：\n$$\nE[Y]=\\int_{0}^{1}\\cos\\left(\\frac{\\pi x}{2}\\right)\\,dx=\\left.\\frac{2}{\\pi}\\sin\\left(\\frac{\\pi x}{2}\\right)\\right|_{0}^{1}=\\frac{2}{\\pi}.\n$$\n现在计算 $E[CY]=E\\!\\left[X\\cos\\left(\\frac{\\pi X}{2}\\right)\\right]$。令 $a=\\frac{\\pi}{2}$。则\n$$\nE[CY]=\\int_{0}^{1}x\\cos(ax)\\,dx.\n$$\n使用分部积分法，令 $u=x$，$dv=\\cos(ax)\\,dx$，于是 $du=dx$ 且 $v=\\frac{1}{a}\\sin(ax)$，我们得到\n$$\n\\int x\\cos(ax)\\,dx=\\frac{x\\sin(ax)}{a}+\\frac{\\cos(ax)}{a^{2}}.\n$$\n从 $0$ 到 $1$ 求定积分，\n$$\n\\int_{0}^{1}x\\cos(ax)\\,dx=\\frac{\\sin(a)}{a}+\\frac{\\cos(a)-1}{a^{2}}.\n$$\n当 $a=\\frac{\\pi}{2}$ 时，我们有 $\\sin(a)=1$ 且 $\\cos(a)=0$，因此\n$$\nE[CY]=\\frac{1}{a}-\\frac{1}{a^{2}}=\\frac{2}{\\pi}-\\frac{4}{\\pi^{2}}.\n$$\n因此，\n$$\n\\text{Cov}(Y,C)=E[CY]-E[Y]E[C]=\\left(\\frac{2}{\\pi}-\\frac{4}{\\pi^{2}}\\right)-\\left(\\frac{2}{\\pi}\\right)\\left(\\frac{1}{2}\\right)=\\frac{1}{\\pi}-\\frac{4}{\\pi^{2}}=\\frac{\\pi-4}{\\pi^{2}}.\n$$\n最后，\n$$\nb^{*}=\\frac{\\text{Cov}(Y,C)}{\\text{Var}(C)}=\\frac{\\frac{\\pi-4}{\\pi^{2}}}{\\frac{1}{12}}=\\frac{12(\\pi-4)}{\\pi^{2}}.\n$$", "answer": "$$\\boxed{\\frac{12(\\pi - 4)}{\\pi^{2}}}$$"}, {"introduction": "重要性抽样是一种极为灵活和强大的技术，它允许我们从一个“更好”的提议分布中抽样来估计目标期望。该方法的成败很大程度上取决于提议分布的选择。这个高级练习将带你深入该方法的核心，你不仅需要应用重要性抽样，还需要通过最小化估计量方差来解析地推导出给定族中的最优提议分布，这揭示了方差缩减的终极潜力。[@problem_id:2446710]", "id": "2446710", "problem": "考虑在与计算经济学和金融学相关的蒙特卡洛设定下，计算一个正态分布随机变量的指数的期望。设 $X \\sim \\mathcal{N}(0, 100)$，并定义 $h(x) = \\exp(x)$。你将使用一个由 $Y \\sim \\mathcal{N}(\\mu, 100)$ 给出的建议分布 $Q$ 通过重要性采样来估计量 $\\mathbb{E}[\\exp(X)]$，其中 $\\mu \\in \\mathbb{R}$ 是一个未知的平移参数。设 $p(x)$ 和 $q_{\\mu}(x)$ 分别表示 $\\mathcal{N}(0, 100)$ 和 $\\mathcal{N}(\\mu, 100)$ 的概率密度函数。基于从 $q_{\\mu}$ 中抽取的 $n$ 个独立同分布样本 $\\{Y_i\\}_{i=1}^{n}$，重要性采样估计量为\n$$\nI_n(\\mu) \\;=\\; \\frac{1}{n}\\sum_{i=1}^{n} h(Y_i)\\, w_{\\mu}(Y_i), \\quad \\text{其中 } w_{\\mu}(y) \\;=\\; \\frac{p(y)}{q_{\\mu}(y)}.\n$$\n从第一性原理出发，不使用任何特定的方差缩减公式，完成以下任务：\n1. 推导 $\\mathbb{E}[\\exp(X)]$ 的闭式表达式。\n2. 推导 $\\operatorname{Var}_{q_{\\mu}}(h(Y)\\,w_{\\mu}(Y))$ 作为 $\\mu$ 的函数，并找出在 $\\mu \\in \\mathbb{R}$ 上使该方差最小化的值 $\\mu^{\\star}$。\n\n你的最终答案应以一个有序对的形式给出，包含 $\\mathbb{E}[\\exp(X)]$ 的精确值和最优平移 $\\mu^{\\star}$。无需数值取整，你的答案应为没有单位的精确值。", "solution": "我们首先回顾一下定义。目标分布为 $X \\sim \\mathcal{N}(0, 100)$，其密度函数为\n$$\np(x) \\;=\\; \\frac{1}{\\sqrt{2\\pi}\\, \\sigma}\\,\\exp\\!\\left(-\\frac{x^{2}}{2\\sigma^{2}}\\right), \\quad \\sigma^{2} = 100,\n$$\n建议分布为 $Y \\sim \\mathcal{N}(\\mu, 100)$，其密度函数为\n$$\nq_{\\mu}(x) \\;=\\; \\frac{1}{\\sqrt{2\\pi}\\, \\sigma}\\,\\exp\\!\\left(-\\frac{(x-\\mu)^{2}}{2\\sigma^{2}}\\right), \\quad \\sigma^{2} = 100.\n$$\n重要性权重为 $w_{\\mu}(x) = p(x)/q_{\\mu}(x)$。\n\n步骤 1：以闭式形式计算 $\\mathbb{E}[\\exp(X)]$。根据定义，\n$$\n\\mathbb{E}[\\exp(X)] \\;=\\; \\int_{-\\infty}^{\\infty} \\exp(x)\\, p(x)\\, dx \\;=\\; \\frac{1}{\\sqrt{2\\pi}\\, \\sigma} \\int_{-\\infty}^{\\infty} \\exp\\!\\left(x - \\frac{x^{2}}{2\\sigma^{2}}\\right) dx.\n$$\n对指数部分进行配方。我们有\n$$\nx - \\frac{x^{2}}{2\\sigma^{2}} \\;=\\; -\\frac{1}{2\\sigma^{2}}\\left(x^{2} - 2\\sigma^{2} x \\right) \\;=\\; -\\frac{1}{2\\sigma^{2}}\\left[(x - \\sigma^{2})^{2} - \\sigma^{4}\\right] \\;=\\; -\\frac{(x - \\sigma^{2})^{2}}{2\\sigma^{2}} + \\frac{\\sigma^{2}}{2}.\n$$\n因此，\n$$\n\\mathbb{E}[\\exp(X)] \\;=\\; \\frac{1}{\\sqrt{2\\pi}\\, \\sigma} \\exp\\!\\left(\\frac{\\sigma^{2}}{2}\\right) \\int_{-\\infty}^{\\infty} \\exp\\!\\left(-\\frac{(x - \\sigma^{2})^{2}}{2\\sigma^{2}}\\right) dx \\;=\\; \\exp\\!\\left(\\frac{\\sigma^{2}}{2}\\right),\n$$\n因为该积分等于 $\\sqrt{2\\pi}\\, \\sigma$。当 $\\sigma^{2} = 100$ 时，可得\n$$\n\\mathbb{E}[\\exp(X)] \\;=\\; \\exp(50).\n$$\n\n步骤 2：推导 $\\operatorname{Var}_{q_{\\mu}}(h(Y)\\, w_{\\mu}(Y))$ 并在 $\\mu$ 上将其最小化。注意到\n$$\n\\operatorname{Var}_{q_{\\mu}}(h(Y)\\, w_{\\mu}(Y)) \\;=\\; \\mathbb{E}_{q_{\\mu}}\\!\\left[h(Y)^{2}\\, w_{\\mu}(Y)^{2}\\right] \\;-\\; \\left(\\mathbb{E}[\\exp(X)]\\right)^{2}.\n$$\n第二项不依赖于 $\\mu$，因此在 $\\mu$ 上最小化方差等价于最小化二阶矩\n$$\nM(\\mu) \\;=\\; \\mathbb{E}_{q_{\\mu}}\\!\\left[h(Y)^{2}\\, w_{\\mu}(Y)^{2}\\right] \\;=\\; \\int_{-\\infty}^{\\infty} \\exp(2x)\\, \\frac{p(x)^{2}}{q_{\\mu}(x)}\\, dx.\n$$\n使用具有相同方差 $\\sigma^{2}$ 的 $p$ 和 $q_{\\mu}$ 的显式形式，\n$$\n\\frac{p(x)^{2}}{q_{\\mu}(x)} \\;=\\; \\frac{\\left(\\frac{1}{\\sqrt{2\\pi}\\,\\sigma}\\exp\\!\\left(-\\frac{x^{2}}{2\\sigma^{2}}\\right)\\right)^{2}}{\\frac{1}{\\sqrt{2\\pi}\\,\\sigma}\\exp\\!\\left(-\\frac{(x-\\mu)^{2}}{2\\sigma^{2}}\\right)} \\;=\\; \\frac{1}{\\sqrt{2\\pi}\\,\\sigma}\\,\\exp\\!\\left(-\\frac{x^{2}}{\\sigma^{2}} + \\frac{(x-\\mu)^{2}}{2\\sigma^{2}}\\right).\n$$\n因此，\n$$\nM(\\mu) \\;=\\; \\frac{1}{\\sqrt{2\\pi}\\,\\sigma} \\int_{-\\infty}^{\\infty} \\exp\\!\\left(2x - \\frac{x^{2}}{\\sigma^{2}} + \\frac{(x-\\mu)^{2}}{2\\sigma^{2}}\\right) dx.\n$$\n合并指数项：\n$$\n2x - \\frac{x^{2}}{\\sigma^{2}} + \\frac{(x-\\mu)^{2}}{2\\sigma^{2}} \\;=\\; -\\frac{x^{2}}{2\\sigma^{2}} + \\left(2 - \\frac{\\mu}{\\sigma^{2}}\\right) x + \\frac{\\mu^{2}}{2\\sigma^{2}}.\n$$\n通过定义\n$$\nm \\;=\\; 2\\sigma^{2} - \\mu,\n$$\n进行配方，使得\n$$\n-\\frac{x^{2}}{2\\sigma^{2}} + \\left(2 - \\frac{\\mu}{\\sigma^{2}}\\right) x \\;=\\; -\\frac{(x - m)^{2}}{2\\sigma^{2}} + \\frac{m^{2}}{2\\sigma^{2}}.\n$$\n因此，\n$$\nM(\\mu) \\;=\\; \\frac{1}{\\sqrt{2\\pi}\\,\\sigma} \\exp\\!\\left(\\frac{m^{2}}{2\\sigma^{2}} + \\frac{\\mu^{2}}{2\\sigma^{2}}\\right) \\int_{-\\infty}^{\\infty} \\exp\\!\\left(-\\frac{(x - m)^{2}}{2\\sigma^{2}}\\right) dx \\;=\\; \\exp\\!\\left(\\frac{m^{2} + \\mu^{2}}{2\\sigma^{2}}\\right).\n$$\n代入 $m = 2\\sigma^{2} - \\mu$，\n$$\nm^{2} + \\mu^{2} \\;=\\; (2\\sigma^{2} - \\mu)^{2} + \\mu^{2} \\;=\\; 4\\sigma^{4} - 4\\mu \\sigma^{2} + 2\\mu^{2},\n$$\n从而\n$$\nM(\\mu) \\;=\\; \\exp\\!\\left(\\frac{4\\sigma^{4} - 4\\mu \\sigma^{2} + 2\\mu^{2}}{2\\sigma^{2}}\\right) \\;=\\; \\exp\\!\\left(2\\sigma^{2} - 2\\mu + \\frac{\\mu^{2}}{\\sigma^{2}}\\right).\n$$\n作为 $\\mu$ 的函数，最小化 $M(\\mu)$ 等价于最小化其指数部分\n$$\ng(\\mu) \\;=\\; \\frac{\\mu^{2}}{\\sigma^{2}} - 2\\mu + 2\\sigma^{2}.\n$$\n这是关于 $\\mu$ 的凸二次函数，其导数为\n$$\ng'(\\mu) \\;=\\; \\frac{2\\mu}{\\sigma^{2}} - 2,\n$$\n该导数在\n$$\n\\mu^{\\star} \\;=\\; \\sigma^{2}\n$$\n处为零。由于 $g''(\\mu) = 2/\\sigma^{2} > 0$，该临界点是唯一的最小值点。当 $\\sigma^{2} = 100$ 时，最优平移为\n$$\n\\mu^{\\star} \\;=\\; 100.\n$$\n在 $\\mu^{\\star} = \\sigma^{2}$ 时，建议密度 $q_{\\mu^{\\star}}$ 与 $h(x)\\, p(x)$ 成正比，这会得到一个零方差的重要性采样估计量，与以下结果一致：\n$$\n\\operatorname{Var}_{q_{\\mu^{\\star}}}(h(Y)\\,w_{\\mu^{\\star}}(Y)) \\;=\\; M(\\mu^{\\star}) - \\left(\\mathbb{E}[\\exp(X)]\\right)^{2} \\;=\\; \\exp(\\sigma^{2}) - \\exp(\\sigma^{2}) \\;=\\; 0.\n$$\n综合所有结果，精确期望为 $\\exp(50)$，最优平移为 $\\mu^{\\star} = 100$。", "answer": "$$\\boxed{\\begin{pmatrix}\\exp(50) & 100\\end{pmatrix}}$$"}]}