## 引言
在现代计算经济学与金融学中，从股票价格波动到信贷违约风险，几乎所有模型都依赖于对遵循特定概率分布的随机变量的精确模拟。然而，计算机本身只能高效生成标准均匀分布的“伪”随机数。这引出了一个核心问题：我们如何利用这个基础构建块，来生成服从正态、指数或任何自定义复杂分布的样本？解决这个问题是所有蒙特卡洛模拟技术的基石。本文旨在系统性地解答这一问题。我们将深入探讨两种最基本且功能强大的随机数生成算法：逆变换采样与拒绝采样。文章将首先阐明逆变换采样的优雅原理及其在连续和离散分布中的应用，并讨论其局限性。随后，我们将介绍更具通用性的拒绝采样方法，解释其“接受-拒绝”机制的巧妙之处，并强调选择合适提议分布的关键性。通过学习这些技术，读者将能够为复杂的模拟任务构建坚实的基础。

## 核心概念

### 引言：从均匀到任意的桥梁

在计算经济学和金融学的世界里，我们经常需要模拟遵循特定概率分布的随机变量，例如股票收益、违约事件或市场冲击。然而，计算机程序能够直接生成的，基本上只有在 $[0, 1]$ 区间上的“伪”均匀分布随机数。那么，我们如何从这一基本构建块出发，生成服从任意复杂分布（如正态分布、指数分布或更奇特的自定义分布）的样本呢？本章将以还原论的风格，深入探讨两种基本且强大的方法：**逆变换采样 (Inverse Transform Sampling)** 和 **拒绝采样 (Rejection Sampling)**。我们将把这些看似复杂的算法分解为它们最基本的原理和因果机制，揭示它们为何以及如何工作。

### 1. 逆变换采样：直接映射的艺术

逆变换采样（ITS）是所有随机数生成技术中最直观、最根本的一种。其核心思想可以用一个惊人简洁的定理来概括。

#### 1.1 基本原理

**定理**：如果一个随机变量 $U$ 服从 $[0, 1]$ 上的标准均匀分布，而 $F(x)$ 是我们目标随机变量 $X$ 的累积分布函数 (Cumulative Distribution Function, CDF)，那么随机变量 $X = F^{-1}(U)$ 就精确地服从由 $F$ 定义的分布。

**为什么这个定理成立？** 让我们来剖析其背后的因果机制。CDF $F(x)$ 的定义是 $P(X \le x)$，其值域恰好是 $[0, 1]$。当我们从 $[0, 1]$ 上均匀地抽取一个值 $u$ 时，我们可以将其视为一个概率值。$X = F^{-1}(u)$ 的操作，本质上是在问：“哪个值 $x$ 使得累积概率恰好为 $u$？”

我们可以通过一个简单的逻辑推导来理解这一点：
$P(X \le x) = P(F^{-1}(U) \le x)$。由于 $F$ 是一个单调不减函数，我们可以将它作用于不等式两边而不改变不等号方向，得到 $P(F(F^{-1}(U)) \le F(x))$，这简化为 $P(U \le F(x))$。因为 $U$ 是在 $[0, 1]$ 上均匀分布的，对于任何 $y \in [0, 1]$，我们都有 $P(U \le y) = y$。因此，$P(U \le F(x)) = F(x)$。我们最终证明了 $P(X \le x) = F(x)$，这正是我们想要的结果。这个过程本质上是将 CDF 图形的纵轴（概率）均匀地映射回横轴（变量值）。

#### 1.2 连续分布的应用：生成指数分布样本

让我们通过一个具体的例子来将理论付诸实践：生成一个服从速率参数为 $\lambda$ 的指数分布的样本 [@problem_id:2403697]。

1.  **第一步：写出 CDF。** 指数分布的概率密度函数 (PDF) 是 $f(x) = \lambda e^{-\lambda x}$ (其中 $x \ge 0$)。其 CDF 是通过对 PDF 积分得到的：
    $$F(x) = \int_0^x \lambda e^{-\lambda t} dt = 1 - e^{-\lambda x}$$

2.  **第二步：求 CDF 的逆函数 $F^{-1}(u)$。** 我们令 $u = F(x)$，然后解出 $x$：
    $$u = 1 - e^{-\lambda x} \implies e^{-\lambda x} = 1 - u \implies -\lambda x = \ln(1 - u) \implies x = -\frac{1}{\lambda} \ln(1 - u)$$
    因此，$F^{-1}(u) = -\frac{1}{\lambda} \ln(1 - u)$。

3.  **第三步：应用变换。** 生成一个均匀随机数 $u \sim \text{Uniform}(0, 1)$，然后计算 $x = -\frac{1}{\lambda} \ln(1 - u)$。这样得到的 $x$ 就是一个服从速率为 $\lambda$ 的指数分布的样本。

一个巧妙的简化是：如果 $u$ 服从 $\text{Uniform}(0,1)$，那么 $1-u$ 也服从 $\text{Uniform}(0,1)$。因此，我们可以直接使用更简洁的公式 $x = -\frac{1}{\lambda} \ln(u)$ 来生成样本 [@problem_id:2403697]。

#### 1.3 离散分布的应用：“轮盘赌”算法

逆变换方法同样优雅地适用于离散分布。假设我们需要根据一个代表信用评级的离散概率质量函数 (PMF) 进行抽样 [@problem_id:2403683]。PMF 形如 $\{p_1, p_2, \dots, p_K\}$，其中 $p_k$ 是状态 $k$ 出现的概率。

在这种情况下，CDF 是一个阶梯函数，$F(k) = \sum_{j=1}^k p_j$。这些 CDF 值，$F(1), F(2), \dots, F(K)=1$，将 $[0,1]$ 区间分割成多个子区间。第 $k$ 个子区间是 $[F(k-1), F(k))$（定义 $F(0)=0$），其长度恰好是 $p_k$。

采样过程就像一个“轮盘赌”：
1.  构建 CDF 数组：$[F(1), F(2), \dots, F(K)]$.
2.  生成一个均匀随机数 $u \sim \text{Uniform}(0, 1)$。
3.  查找 $u$ 所在的子区间。具体来说，找到最小的整数 $k$ 使得 $u < F(k)$。这个 $k$ 就是我们的样本。

因为 $u$ 均匀地落在 $[0, 1]$ 上，它落入长度为 $p_k$ 的第 $k$ 个子区间的概率正好是 $p_k$。这确保了每个状态被抽中的概率完全正确。

#### 1.4 方法的局限性

尽管逆变换采样法原理优美且强大，但它有两个主要的局限性：
1.  **CDF 的可逆性**：此方法要求我们能够解析地写出并计算 $F^{-1}$。对于许多重要的分布，如正态分布或伽马分布，其 CDF 没有简单的闭式逆函数。虽然可以使用数值方法逼近 $F^{-1}$（如正态分布的 probit 函数），但这通常计算成本高昂 [@problem__id:2403624]。
2.  **数值稳定性**：对于具有“重尾”的分布（即极端值以不可忽略的概率出现），逆变换采样可能会遇到数值精度问题。例如，对于帕累托（Pareto）分布，其 CDF 为 $F(x) = 1 - (x_m/x)^\alpha$。其逆变换公式为 $x = x_m (1-u)^{-1/\alpha}$ [@problem_id:2403679]。当我们要生成一个极大的 $x$ 值（来自分布的远右尾）时，需要一个非常接近 $1$ 的 $u$。在浮点数运算中，计算 $1-u$ 会导致“灾难性抵消”（catastrophic cancellation），损失大量有效数字。一个精妙的解决方案是利用 $U=1-u$ 也服从均匀分布的特性，转而使用其等价的生存函数 $S(x) = 1-F(x)$ 进行采样。对于帕累托分布，采样公式变为 $x = x_m U^{-1/\alpha}$ (其中 $U \sim \text{Uniform}(0,1)$)，这样就在 $U \approx 0$ 时进行稳定计算，从而避免了数值问题 [@problem_id:2403679]。

当逆变换法变得不切实际时，我们需要一种更通用的间接方法——拒绝采样。

### 2. 拒绝采样：巧妙的“接受-拒绝”博弈

拒绝采样，又称接受-拒绝采样法，是一种在无法直接使用逆变换法时生成样本的强大工具。它的核心思想是，如果我们不能直接从目标分布 $f(x)$ 中采样，我们可以从一个更容易采样的“提议分布”(proposal distribution) $g(x)$ 中采样，然后通过一个巧妙的概率测试来决定是“接受”还是“拒绝”这个样本。

#### 2.1 基本机制：在曲线下投掷飞镖

让我们从最基本的原理出发，推导出拒绝采样的机制 [@problem_id:2403647]。
假设我们想从目标概率密度函数 (PDF) $f(x)$ 中采样。我们选择另一个我们容易采样的提议 PDF $g(x)$，并找到一个常数 $M$，使得对于所有 $x$，都满足 $M \cdot g(x) \ge f(x)$。这个 $M \cdot g(x)$ 函数被称为“包络函数”，因为它总是在 $f(x)$ 的上方。

采样过程可以想象成一个二维的投掷飞镖游戏：
1.  **第一步：确定投掷区域。** 我们的投掷区域由函数 $M \cdot g(x)$ 的曲线下方面积定义。
2.  **第二步：生成一个随机点。** 我们通过以下方式生成一个点 $(Y, V)$：
    *   从提议分布 $g(x)$ 中抽取一个样本 $Y$。这确定了点的横坐标。
    *   在 $[0, M \cdot g(Y)]$ 区间上均匀地抽取一个随机数 $V$。这确定了点的纵坐标。
    这个过程保证了点 $(Y, V)$ 均匀地分布在 $M \cdot g(x)$ 曲线下方的区域内。
3.  **第三步：接受或拒绝。** 我们检查这个点是否也落在了目标函数 $f(x)$ 的曲线下方。也就是，我们检查是否满足 $V \le f(Y)$。
    *   如果满足，我们**接受**这个样本，令 $X=Y$。
    *   如果不满足，我们**拒绝**这个样本，并从第一步重新开始。

**为什么这个机制有效？** 我们接受的样本 $Y$ 的分布是什么？我们接受 $Y$ 的条件是它通过了随机测试。这些被接受的样本的分布，就是在 $M g(x)$ 曲线下方的点中，也同时落在 $f(x)$ 曲线下方的那些点。由于初始的点是均匀分布的，被接受的点的横坐标的分布就正比于 $f(x)$ 的高度。经过归一化后，这些被接受的样本的分布恰好就是 $f(x)$。

在实际操作中，我们不必生成二维点。上述过程可以简化为等价的算法：
1.  从 $g(x)$ 中抽取一个提议样本 $y$。
2.  生成一个均匀随机数 $u \sim \text{Uniform}(0, 1)$。
3.  如果 $u \le \frac{f(y)}{M g(y)}$，则接受 $y$ 作为来自 $f(x)$ 的一个样本；否则，拒绝它并返回第一步。

#### 2.2 核心优势：处理未归一化密度

拒绝采样最强大的特性之一是，它甚至在我们只知道目标密度函数的一个**未归一化**版本时也同样有效 [@problem_id:2403647]。在许多应用中，特别是贝叶斯统计，我们常常得到一个与真实后验密度成正比的函数 $\tilde{f}(x)$，即 $f(x) = \tilde{f}(x)/Z$，其中归一化常数 $Z = \int \tilde{f}(x) dx$ 难以计算。

让我们看看为什么拒绝采样不需要知道 $Z$。假设我们用未归一化的 $\tilde{f}(x)$ 来构建包络。我们需要找到一个常数 $M'$ 使得 $M' \cdot g(x) \ge \tilde{f}(x)$。此时的接受条件变为：
$$u \le \frac{\tilde{f}(y)}{M' g(y)}$$
注意到，这里的分子和分母都不涉及未知的 $Z$。推导表明，被接受样本的密度仍然是 $f(x)$。$Z$ 被巧妙地“隐藏”在了算法的整体接受率中。总体的接受概率是 $P(\text{accept}) = \frac{\int \tilde{f}(x)dx}{M'} = \frac{Z}{M'}$。因此，即使我们不知道 $Z$，该算法也能够完美地工作，这使得它在实践中极为有用。

### 3. 提议分布的选择：一门艺术与科学

拒绝采样的效率——即接受率——完全取决于我们如何选择提议分布 $g(x)$ 和常数 $M$。一个糟糕的选择可能导致几乎所有的样本都被拒绝，使得算法慢到无法使用。一个好的选择则能让效率大大提高。

#### 3.1 两个基本约束

要使拒绝采样有效，必须满足两个不可违背的条件：

1.  **支撑集覆盖**：提议分布 $g(x)$ 的支撑集（即其密度为正的区域）必须覆盖目标分布 $f(x)$ 的支撑集。换言之，如果 $f(x) > 0$，那么必须有 $g(x) > 0$。如果违反这个条件，提议分布将永远无法生成目标分布有概率质量的某些区域的样本，导致最终得到的样本分布是有偏的，根本不是我们想要的 $f(x)$ [@problem_id:2403695]。例如，如果目标是 $[0, 2]$ 上的分布，而我们的提议只在 $[1, 2]$ 上生成样本，那么我们永远无法得到 $[0, 1)$ 区间内的任何值，这将导致对期望值的估计产生系统性偏差。

2.  **尾部要足够“重”**：包络条件 $f(x) \le M g(x)$ 必须对所有 $x$ 成立。这意味着比率 $f(x)/g(x)$ 必须是有界的。当 $x$ 趋向无穷大时，如果 $g(x)$ 衰减到零的速度比 $f(x)$ 快，那么这个比率就会发散到无穷大，我们无法找到一个有限的常数 $M$ [@problem_id:2403657]。这就是所谓的“提议分布的尾部必须比目标分布的尾部更重（或同样重）”的规则。一个经典的例子是，我们不能使用一个“轻尾”的正态分布（其密度以 $\exp(-x^2)$ 的速度衰减）作为提议来采样一个“重尾”的柯西分布（其密度以 $x^{-2}$ 的速度衰减）。

#### 3.2 效率最大化

算法的效率由接受率 $1/M$（对于归一化的 $f(x)$）决定。为了最大化接受率，我们需要最小化 $M$。而 $M$ 的最小可能值是 $M^* = \sup_{x} \frac{f(x)}{g(x)}$。

这给了我们一个明确的优化目标：选择一个提议分布 $g(x)$，使得它与目标 $f(x)$ 的形状尽可能相似。如果 $g(x)$ 的形状与 $f(x)$ 完全匹配，那么比率 $f(x)/g(x)$ 将是一个常数，接受率会非常高。

一个绝佳的例子是，当目标密度 $\tilde{f}(x) \propto x^7(1-x)^3$（一个Beta分布的核）时，如果我们选择一个形状相似的Beta分布作为提议分布，例如正比于 $x^7(1-x)^3$ 的 $\text{Beta}(8,4)$ 分布，那么比率 $\tilde{f}(x)/g(x)$ 将恒为常数，接受率达到 100% (理论上的最优情况) [@problem_id:2403680]。这说明，在设计拒绝采样器时，对目标分布的洞察可以极大地提升计算效率。

### 4. 综合比较：没有万能的方法

逆变换采样和拒绝采样各有千秋。让我们通过一个案例来比较它们：从半正态分布中采样 [@problem_id:2403705]。

*   **逆变换采样（ITS）**：半正态分布的 CDF 可以通过误差函数(erf)或标准正态CDF($\Phi$)的逆函数来表示。因此，ITS 在理论上是可行的。例如，一个采样公式是 $X = \sigma\sqrt{2}\,\operatorname{erf}^{-1}(U)$。这种方法的优点是**确定性**和**高效性**：每一次均匀随机数的抽取都能精确地生成一个目标样本。缺点是它依赖于我们能否计算一个可能很复杂的特殊函数（如 $\operatorname{erf}^{-1}$）。

*   **拒绝采样（RS）**：我们可以使用一个更简单的分布，比如指数分布，作为半正态分布的提议。通过优化指数分布的速率参数，我们可以找到一个最优的包络常数 $M^*$，从而最大化接受率。这种方法的优点是**通用性**：它不要求 CDF 可逆，只需要能够评估目标 PDF。缺点是它的**随机性**和**潜在的低效率**。每次“尝试”需要两次随机数抽取（一次用于提议，一次用于接受测试），并且我们期望需要 $M^*$ 次尝试才能成功获得一个样本。如果 $M^*$ 很大，这个过程就会非常浪费计算资源。

除了这两种通用方法，对于像标准正态分布这样极其常见的分布，还存在一些高度特化的、极其高效的变换方法，例如**Box-Muller变换** [@problem_id:2403624]。该方法通过巧妙的数学变换，用两个独立的均匀随机数直接生成两个独立的标准正态随机数，避免了计算复杂的逆CDF。

### 结论

理解随机数生成的核心机制，是进行复杂金融与经济模型仿真的基础。**逆变换采样**提供了一条直接、优雅的路径，但要求我们能够“反转”累积分布函数，并注意数值稳定性问题。当这条路走不通时，**拒绝采样**提供了一种灵活而强大的替代方案，它通过“接受-拒绝”的博弈，让我们能够从任何可评估的密度函数（甚至是未归一化的）中采样，但其效率高度依赖于提议分布的设计。最终，选择哪种方法，或是否寻找更专门的技术，取决于目标分布的具体特性以及我们对计算效率和实现复杂性之间的权衡。掌握这些基本原理，将使你能够为任何模拟任务设计出正确且高效的采样策略。

