{"hands_on_practices": [{"introduction": "在量化金融中，我们经常使用概率分布来为资产收益建模。这个练习将帮助你巩固一个基本但至关重要的技能：从累积分布函数（$F(r)$）推导出概率密度函数（$f(r)$）。通过为高斯分布、学生t分布和混合高斯分布等常见模型进行计算，你将加深对这些分布特性的理解，并为后续更复杂的风险分析打下基础。[@problem_id:2415147]", "id": "2415147", "problem": "考虑三个为小数形式的股票收益率分布建模的累积分布函数。对于每种设定，令 $r$ 表示收益率，$F(r)$ 表示其累积分布函数。您的任务是在指定点上数值计算导数 $\\frac{d}{dr}F(r)$，以获得概率密度函数 $f(r)$ 的估计值。\n\n测试套件中 $F(r)$ 的定义如下：\n- 测试用例 $1$ (高斯分布): $F(r) = \\Phi\\!\\left(\\frac{r - \\mu}{\\sigma}\\right)$，参数为 $\\mu = 0.001$ 和 $\\sigma = 0.02$，其中 $\\Phi(\\cdot)$ 表示标准正态分布的累积分布函数。\n- 测试用例 $2$ (Student’s $t$ 分布): $F(r) = T_{\\nu}\\!\\left(\\frac{r - \\mu}{s}\\right)$，参数为 $\\nu = 5$、$\\mu = 0.0$ 和 $s = 0.02$，其中 $T_{\\nu}(\\cdot)$ 表示自由度为 $\\nu$ 的标准化 Student’s $t$ 分布的累积分布函数。\n- 测试用例 $3$ (双组分高斯混合模型): $F(r) = w \\,\\Phi\\!\\left(\\frac{r - 0}{0.015}\\right) + (1-w)\\,\\Phi\\!\\left(\\frac{r - 0}{0.05}\\right)$，其中 $w = 0.9$。\n\n对于每个测试用例，在以下点上估计 $f(r) = \\frac{d}{dr}F(r)$：\n- 测试用例 $1$ 求值点：$\\{-0.05, 0.00, 0.05\\}$。\n- 测试用例 $2$ 求值点：$\\{-0.10, 0.00, 0.10\\}$。\n- 测试用例 $3$ 求值点：$\\{-0.10, -0.02, 0.00, 0.02, 0.10\\}$。\n\n您的程序必须：\n- 通过对所提供的 $F(r)$ 关于 $r$ 求导，计算每个测试用例在所有指定点上的 $f(r)$ 的数值估计。\n- 生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，其顺序为：\n  [测试用例 1 的值（按规定顺序），然后是测试用例 2 的值（按规定顺序），然后是测试用例 3 的值（按规定顺序）]。\n- 将每个报告的值四舍五入到 $6$ 位小数。\n\n程序没有输入，也不需要单位。最终输出应仅包含上述格式的单行内容。", "solution": "对问题陈述进行验证。\n\n**步骤 1：提取已知条件**\n\n- **总体任务**：数值计算导数 $\\frac{d}{dr}F(r)$ 以估计概率密度函数 $f(r)$，其中 $F(r)$ 是小数形式股票收益率 $r$ 的累积分布函数（CDF）。\n\n- **测试用例 1 (高斯分布)**：\n  - CDF: $F(r) = \\Phi\\!\\left(\\frac{r - \\mu}{\\sigma}\\right)$\n  - 参数: $\\mu = 0.001$, $\\sigma = 0.02$。\n  - $\\Phi(\\cdot)$ 是标准正态 CDF。\n  - $r$ 的求值点：$\\{-0.05, 0.00, 0.05\\}$。\n\n- **测试用例 2 (Student’s t 分布)**：\n  - CDF: $F(r) = T_{\\nu}\\!\\left(\\frac{r - \\mu}{s}\\right)$\n  - 参数: $\\nu = 5$, $\\mu = 0.0$, $s = 0.02$。\n  - $T_{\\nu}(\\cdot)$ 是自由度为 $\\nu$ 的标准化 Student's t CDF。\n  - $r$ 的求值点：$\\{-0.10, 0.00, 0.10\\}$。\n\n- **测试用例 3 (双组分高斯混合模型)**：\n  - CDF: $F(r) = w \\,\\Phi\\!\\left(\\frac{r - 0}{0.015}\\right) + (1-w)\\,\\Phi\\!\\left(\\frac{r - 0}{0.05}\\right)$\n  - 参数: $w = 0.9$。这隐含地是一个由两个正态分布组成的混合模型，其均值分别为 $\\mu_1 = 0$、$\\mu_2 = 0$，标准差分别为 $\\sigma_1 = 0.015$、$\\sigma_2 = 0.05$。\n  - $r$ 的求值点：$\\{-0.10, -0.02, 0.00, 0.02, 0.10\\}$。\n\n- **输出要求**：一个用方括号括起来的单行逗号分隔列表，包含所有计算出的导数值，这些值已四舍五入到 $6$ 位小数，并按测试用例和求值点排序。\n\n**步骤 2：使用提取的已知条件进行验证**\n\n1.  **科学依据**：该问题在根本上是合理的。它基于概率论的核心原理，即概率密度函数 (PDF) $f(x)$ 是累积分布函数 (CDF) $F(x)$ 的导数，即 $f(x) = \\frac{d}{dx}F(x)$。所使用的高斯分布、Student's t 分布和高斯混合模型，都是计算金融领域中广泛用于为资产收益率建模的标准模型。该问题在科学和数学上是正确的。\n2.  **适定性**：该问题是适定的。对于每个测试用例，函数 $F(r)$ 都有明确的定义和所有必需的参数。需要计算导数的点也已明确指定。这些函数处处可导。存在唯一且有意义的解。\n3.  **客观性**：该问题使用精确、无歧义的数学语言和客观标准进行陈述。不包含任何主观或基于观点的成分。\n\n**步骤 3：结论与行动**\n\n问题是有效的。它具有科学依据、适定性、客观性并且是完整的。将提供解决方案。\n\n**方法论**\n\n该问题要求对累积分布函数 $F(r)$ 的导数进行数值计算，以获得概率密度函数 $f(r)$。其基本关系是：\n$$f(r) = \\frac{d}{dr}F(r)$$\n虽然可以采用数值近似方案，例如中心有限差分法 $f'(x) \\approx \\frac{f(x+h) - f(x-h)}{2h}$，但这既非必要，其准确性也不如正确的解析方法。对于给定的标准分布，其 CDF 的导数是已知的解析函数——即 PDF 本身。因此，“计算导数”最严谨且精确的方法是计算相应的 PDF。这不是对问题的规避，而是对数学原理的正确应用。\n\n**情况 1：高斯分布**\nCDF 由 $F(r) = \\Phi\\left(\\frac{r - \\mu}{\\sigma}\\right)$ 给出。应用链式法则，导数为：\n$$f(r) = \\frac{dF}{dr} = \\frac{d}{dr}\\Phi\\left(\\frac{r - \\mu}{\\sigma}\\right) = \\phi\\left(\\frac{r - \\mu}{\\sigma}\\right) \\cdot \\frac{d}{dr}\\left(\\frac{r - \\mu}{\\sigma}\\right) = \\frac{1}{\\sigma}\\phi\\left(\\frac{r - \\mu}{\\sigma}\\right)$$\n其中 $\\phi(z) = \\frac{1}{\\sqrt{2\\pi}}e^{-z^2/2}$ 是标准正态分布的 PDF。得到的表达式是均值为 $\\mu$、标准差为 $\\sigma$ 的一般正态分布的 PDF。参数为 $\\mu = 0.001$ 和 $\\sigma = 0.02$。\n\n**情况 2：Student’s t 分布**\nCDF 由 $F(r) = T_{\\nu}\\left(\\frac{r - \\mu}{s}\\right)$ 给出。类似地应用链式法则可得：\n$$f(r) = \\frac{dF}{dr} = \\frac{d}{dr}T_{\\nu}\\left(\\frac{r - \\mu}{s}\\right) = t_{\\nu}\\left(\\frac{r - \\mu}{s}\\right) \\cdot \\frac{1}{s}$$\n其中 $t_{\\nu}(z)$ 是自由度为 $\\nu$ 的标准化 Student's t 分布的 PDF。这是经过位置-尺度变换的 Student's t 分布的 PDF。参数为 $\\nu = 5$、$\\mu = 0.0$ 和 $s = 0.02$。\n\n**情况 3：双组分高斯混合模型**\nCDF 是一个加权和：$F(r) = w_1 F_1(r) + w_2 F_2(r)$，其中 $F_1(r) = \\Phi\\left(\\frac{r - \\mu_1}{\\sigma_1}\\right)$ 且 $F_2(r) = \\Phi\\left(\\frac{r - \\mu_2}{\\sigma_2}\\right)$。和的导数等于导数的和：\n$$f(r) = \\frac{dF}{dr} = w_1 \\frac{dF_1}{dr} + w_2 \\frac{dF_2}{dr}$$\n使用高斯分布情况下的结果，可得：\n$$f(r) = w_1 \\frac{1}{\\sigma_1}\\phi\\left(\\frac{r - \\mu_1}{\\sigma_1}\\right) + w_2 \\frac{1}{\\sigma_2}\\phi\\left(\\frac{r - \\mu_2}{\\sigma_2}\\right)$$\n这是高斯混合模型的 PDF。参数为 $w_1 = 0.9$、$w_2 = 1-w_1 = 0.1$、$\\mu_1 = \\mu_2 = 0$、$\\sigma_1 = 0.015$ 和 $\\sigma_2 = 0.05$。\n\n实现将使用 `scipy.stats` 库，该库为计算这些标准分布的 PDF 提供了数值稳定且精确的函数。这将直接且正确地计算所需的值。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import norm, t\n\ndef solve():\n    \"\"\"\n    Solves the problem by calculating the probability density function (PDF) values,\n    which are the derivatives of the given cumulative distribution functions (CDFs).\n    \"\"\"\n    \n    # This list will store all results in the required order.\n    all_results = []\n\n    # --- Test Case 1: Gaussian Distribution ---\n    mu_1 = 0.001\n    sigma_1 = 0.02\n    r_vals_1 = np.array([-0.05, 0.00, 0.05])\n    \n    # The derivative of the Gaussian CDF is the Gaussian PDF.\n    pdf_vals_1 = norm.pdf(r_vals_1, loc=mu_1, scale=sigma_1)\n    all_results.extend(pdf_vals_1)\n\n    # --- Test Case 2: Student’s t-Distribution ---\n    nu_2 = 5\n    mu_2 = 0.0\n    s_2 = 0.02\n    r_vals_2 = np.array([-0.10, 0.00, 0.10])\n    \n    # The derivative of the location-scale t-CDF is the corresponding t-PDF.\n    # The scipy.stats.t.pdf function correctly handles location and scale parameters.\n    pdf_vals_2 = t.pdf(r_vals_2, df=nu_2, loc=mu_2, scale=s_2)\n    all_results.extend(pdf_vals_2)\n\n    # --- Test Case 3: Two-component Gaussian Mixture ---\n    w_3 = 0.9\n    sigma_3_1 = 0.015\n    sigma_3_2 = 0.05\n    mu_3 = 0.0 # Both components are centered at 0\n    r_vals_3 = np.array([-0.10, -0.02, 0.00, 0.02, 0.10])\n    \n    # The PDF of a mixture is the weighted sum of the component PDFs.\n    pdf_vals_3_comp1 = norm.pdf(r_vals_3, loc=mu_3, scale=sigma_3_1)\n    pdf_vals_3_comp2 = norm.pdf(r_vals_3, loc=mu_3, scale=sigma_3_2)\n    pdf_vals_3 = w_3 * pdf_vals_3_comp1 + (1 - w_3) * pdf_vals_3_comp2\n    all_results.extend(pdf_vals_3)\n\n    # Format the final output string as specified.\n    # Each value is rounded to 6 decimal places.\n    output_str = f\"[{','.join([f'{val:.6f}' for val in all_results])}]\"\n    \n    # Final print statement in the exact required format.\n    print(output_str)\n\nsolve()\n```"}, {"introduction": "现在，让我们将对分布的理解应用于一个实际的风险管理问题。这个练习揭示了正态分布在金融领域的一个关键弱点——它无法解释罕见但巨大的损失，即“崩盘风险”。通过比较基于简单正态模型的风险价值（VaR）与一个更现实的、包含崩盘情景的混合模型的VaR，你将亲身体会到为什么在风险管理中准确捕捉“肥尾”现象至关重要。[@problem_id:2446954]", "id": "2446954", "problem": "一个交易员进行为期一天的货币套利交易，借入低收益的融资货币，并做多高收益的目标货币。设 $S_t$ 表示目标货币以融资货币为单位的即期价格，并设 $s_t=\\log S_t$。该交易员的一日回报率（以融资货币单位计）近似为 $r=\\Delta s + \\delta/252$，其中 $\\Delta s = s_{t+1}-s_t$，$\\delta$ 是年化利率差（目标利率减去融资利率）。投资组合的名义本金为 $V=100{,}000{,}000$ 融资货币单位。\n\n假设如下：\n- 方差-协方差（参数）法将 $\\Delta s$ 建模为均值为零、日标准差为 $\\sigma=0.008$ 的正态分布。因此，模型隐含的一日回报率均值为 $\\mu=\\delta/252$，波动率为 $\\sigma$。\n- 年化利率差为 $\\delta=0.05$。\n- 实际上，套利交易面临罕见的崩盘风险：在任何一天，发生目标货币突然贬值的概率为 $p=0.005$，导致回报率为 $r=-0.10$（亏损 $10\\%$）；否则，在概率为 $1-p$ 的情况下，回报率遵循上述均值为 $\\mu$、波动率为 $\\sigma$ 的正态模型。\n\n使用第一性原理以及在险价值（VaR）作为损失分布的相应分位数的定义，计算以下两种情况下的 $99\\%$ 单日在险价值：\n(i) 方差-协方差正态模型，以及\n(ii) 上述的崩盘混合模型。\n以融资货币单位报告两种VaR值，并找出正确给出两个值并解释方差-协方差法是否以及为何会遗漏崩盘风险的陈述。\n\n选择一项：\n- A. 在正态模型下，$99\\%$ VaR 约为 $1.84\\times 10^6$；在崩盘混合模型下，它增加到约 $2.04\\times 10^6$。方差-协方差法遗漏了崩盘风险，因为它假设回报率为瘦尾、对称的正态分布，这低估了套利交易中的尾部损失。\n- B. 在正态模型下，$99\\%$ VaR 约为 $1.86\\times 10^6$；在崩盘混合模型下，它跃升至约 $1.00\\times 10^7$，因为无论其概率如何，崩盘事件总是决定 $99\\%$ VaR。\n- C. 在正态模型和崩盘混合模型下，$99\\%$ VaR 均约为 $1.84\\times 10^6$；增加一个罕见的崩盘事件不影响此置信度下的 VaR，因为均值很小。\n- D. 在正态模型下，$99\\%$ VaR 约为 $2.04\\times 10^6$；在崩盘混合模型下，它下降到约 $1.84\\times 10^6$，因为将部分概率分配给一个遥远的崩盘事件减少了中心尾部的概率质量。", "solution": "对问题陈述进行验证。\n\n**步骤1：提取已知条件**\n- 一日货币套利交易回报率：$r = \\Delta s + \\delta/252$，其中 $\\Delta s = \\log(S_{t+1}/S_t)$。\n- 投资组合名义本金：$V = 100{,}000{,}000$ 融资货币。\n- 年化利率差：$\\delta = 0.05$。\n- 年交易日：$252$。\n- 模型1（方差-协方差法）：$\\Delta s$ 服从均值为 $0$、标准差为 $\\sigma = 0.008$ 的正态分布。因此，回报率 $r$ 服从均值为 $\\mu = \\delta/252$、标准差为 $\\sigma = 0.008$ 的正态分布。\n- 模型2（崩盘混合模型）：回报率 $r$ 的混合分布。\n  - 发生崩盘的概率为 $p = 0.005$，导致回报率为 $r_c = -0.10$。\n  - 不发生崩盘的概率为 $1-p = 0.995$，回报率 $r_n$ 服从模型1中的正态分布，$r_n \\sim N(\\mu, \\sigma^2)$。\n- 任务：计算两种模型下的 $99\\%$ 单日在险价值（VaR）。VaR 定义为损失分布的相应分位数。\n\n**步骤2：使用提取的已知条件进行验证**\n该问题具有科学依据，属于金融风险管理的标准框架。使用正态模型（方差-协方差法）和混合模型来纳入崩盘风险是标准的教科书示例。所提供的参数（$\\delta$、$\\sigma$、$p$、$V$）是具体的，并且在货币市场的实际范围内。该问题是适定的，因为计算所需量所需的所有信息都已提供。语言客观且明确。问题是自洽且内部一致的。\n\n**步骤3：结论和行动**\n问题陈述有效。将推导解答。\n\n**解答推导**\n\n置信水平为 $c$ 的在险价值（VaR）是损失分布在该水平上对应的分位数。$99\\%$ VaR 是一个值 $v$，使得损失 $L$ 超过 $v$ 的概率为 $1\\%$。损失定义为 $L = -rV$。因此，我们寻求 $v$ 使得 $P(L > v) = 0.01$。这等同于寻找损失分布的第$99$百分位数。\n\n首先，我们计算回报率分布的参数。\n日均回报率为 $\\mu = \\frac{\\delta}{252} = \\frac{0.05}{252} \\approx 0.00019841$。\n日回报率波动率给定为 $\\sigma = 0.008$。\n投资组合名义本金为 $V = 100{,}000{,}000$。\n\n**(i) 方差-协方差（正态）模型下的 VaR**\n\n在此模型下，日回报率 $r$ 服从正态分布：$r \\sim N(\\mu, \\sigma^2)$。\n损失 $L = -rV$ 也服从正态分布。\n损失的均值为 $E[L] = E[-rV] = -V\\mu$。\n损失的标准差为 $\\sigma_L = \\text{StdDev}(-rV) = V\\sigma$。\n因此，$L \\sim N(-V\\mu, (V\\sigma)^2)$。\n\n我们计算数值：\n$V\\mu = 100{,}000{,}000 \\times \\frac{0.05}{252} \\approx 19{,}841.27$。\n$V\\sigma = 100{,}000{,}000 \\times 0.008 = 800{,}000$。\n\n$99\\%$ VaR 是此损失分布的第$99$百分位数。设 $Z$ 为标准正态变量，$Z \\sim N(0,1)$。标准正态分布的第$99$百分位数记为 $z_{0.99}$，该值使得 $P(Z \\le z_{0.99}) = 0.99$。根据统计表，$z_{0.99} \\approx 2.3263$。\n\nVaR 计算如下：\n$$ \\text{VaR}_{0.99}^{(\\text{Normal})} = E[L] + z_{0.99} \\sigma_L = -V\\mu + z_{0.99} V\\sigma $$\n$$ \\text{VaR}_{0.99}^{(\\text{Normal})} \\approx -19{,}841.27 + 2.3263 \\times 800{,}000 $$\n$$ \\text{VaR}_{0.99}^{(\\text{Normal})} \\approx -19{,}841.27 + 1{,}861{,}040 = 1{,}841{,}198.73 $$\n因此，正态模型下的 $99\\%$ VaR 约为 $1.84 \\times 10^6$。\n\n**(ii) 崩盘混合模型下的 VaR**\n\n损失分布 $L$ 是一个混合分布。\n- 发生崩盘的概率为 $p = 0.005$。此时损失为 $L_c = -r_c V = -(-0.10) \\times 100{,}000{,}000 = 10{,}000{,}000$。\n- 不发生崩盘的概率为 $1-p = 0.995$，此时损失 $L_n$ 服从第 (i) 部分的正态分布，$L_n \\sim N(-V\\mu, (V\\sigma)^2)$。\n\n设 $F_L(v)$ 是总损失 $L$ 的累积分布函数（CDF）。设 $F_{L_n}(v)$ 是正态损失分量的CDF。\n混合分布的CDF为 $F_L(v) = P(L \\le v) = (1-p) F_{L_n}(v) + p \\cdot H(v - L_c)$，其中 $H$ 是 Heaviside 阶跃函数。我们寻求值 $v$ 使得 $F_L(v)=0.99$。\n\n我们必须首先确定 VaR 值是小于还是大于崩盘损失 $L_c = 10^7$。我们计算恰好在 $L_c$ 以下的 CDF：\n$$ F_L(L_c^-) = \\lim_{v \\to L_c^-} F_L(v) = (1-p) F_{L_n}(L_c) $$\n在正态分布分量中，对应于损失 $L_c=10^7$ 的z分数为 $z = \\frac{L_c - E[L_n]}{\\sigma_{L_n}} = \\frac{10^7 - (-19841.27)}{800000} \\approx 12.52$。对于如此大的z分数，其CDF值几乎为$1$，所以 $F_{L_n}(L_c) \\approx 1$。\n因此，$F_L(L_c^-) \\approx 1-p = 0.995$。\n\n我们在寻找第$99$百分位数（$0.99$）。由于 $0.99 < F_L(L_c^-) \\approx 0.995$，所以 $99\\%$ VaR 必须是一个值 $v < L_c$。对于任何这样的 $v$，Heaviside 函数项为零，所以 CDF 简化为：\n$$ F_L(v) = (1-p) F_{L_n}(v) = 0.995 \\cdot F_{L_n}(v) $$\n我们将其设为等于 $0.99$：\n$$ 0.995 \\cdot F_{L_n}(v) = 0.99 \\implies F_{L_n}(v) = \\frac{0.99}{0.995} \\approx 0.994975 $$\n我们必须找到正态损失分布 $L_n$ 的第$99.4975$百分位数。这需要z分数 $z_{0.994975} = \\Phi^{-1}(0.994975)$，其中 $\\Phi$ 是标准正态CDF。根据统计软件或详细的表格，$z_{0.994975} \\approx 2.574$。\n\n那么混合模型的 VaR 为：\n$$ \\text{VaR}_{0.99}^{(\\text{Mixture})} = E[L_n] + z_{0.994975} \\sigma_{L_n} = -V\\mu + z_{0.994975} V\\sigma $$\n$$ \\text{VaR}_{0.99}^{(\\text{Mixture})} \\approx -19{,}841.27 + 2.574 \\times 800{,}000 $$\n$$ \\text{VaR}_{0.99}^{(\\text{Mixture})} \\approx -19{,}841.27 + 2{,}059{,}200 = 2{,}039{,}358.73 $$\n因此，崩盘混合模型下的 $99\\%$ VaR 约为 $2.04 \\times 10^6$。\n\n**选项评估**\n\n- **A. 在正态模型下，$99\\%$ VaR 约为 $1.84\\times 10^6$；在崩盘混合模型下，它增加到约 $2.04\\times 10^6$。方差-协方差法遗漏了崩盘风险，因为它假设回报率为瘦尾、对称的正态分布，这低估了套利交易中的尾部损失。**\n  - 计算出的 VaR 值，$1.84 \\times 10^6$ 美元（正态模型）和 $2.04 \\times 10^6$ 美元（混合模型），与我们的推导完全匹配。\n  - 解释也是正确的。基于正态分布的方差-协方差法没有考虑偏度(skewness)和肥尾(leptokurtosis)，而这些是崩盘风险的特征。根据经验，套利交易的回报率表现出这些特征，而正态模型的瘦尾导致对风险的显著低估，正如计算所示。\n  - **结论：正确。**\n\n- **B. 在正态模型下，$99\\%$ VaR 约为 $1.86\\times 10^6$；在崩盘混合模型下，它跃升至约 $1.00\\times 10^7$，因为无论其概率如何，崩盘事件总是决定 $99\\%$ VaR。**\n  - $1.86 \\times 10^6$美元 的正态 VaR 是错误地忽略正均值回报（$\\mu > 0$）时得到的结果。\n  - 混合模型的 VaR 不是 $1.00 \\times 10^7$美元。只有在置信水平高于 $99.5\\%$ 的情况下才会是这个值。关于崩盘“总是”决定 VaR 的断言是错误的；这取决于崩盘概率 $p$ 和 VaR 尾部概率 $\\alpha=1-c$ 之间的关系。\n  - **结论：错误。**\n\n- **C. 在正态模型和崩盘混合模型下，$99\\%$ VaR 均约为 $1.84\\times 10^6$；增加一个罕见的崩盘事件不影响此置信度下的 VaR，因为均值很小。**\n  - 关于混合模型 VaR 也是 $1.84 \\times 10^6$美元 的陈述与我们的计算相矛盾。VaR 明显增加了。\n  - 所提供的理由（“因为均值很小”）不合逻辑，且与崩盘部分对 VaR 的影响无关。\n  - **结论：错误。**\n\n- **D. 在正态模型下，$99\\%$ VaR 约为 $2.04\\times 10^6$；在崩盘混合模型下，它下降到约 $1.84\\times 10^6$，因为将部分概率分配给一个遥远的崩盘事件减少了中心尾部的概率质量。**\n  - 这个选项颠倒了计算出的 VaR 值。\n  - 其推理存在根本性缺陷。在分布的尾部增加一个大的损失事件会增加风险，因此在给定的高置信水平下，不可能降低 VaR。\n  - **结论：错误。**", "answer": "$$\\boxed{A}$$"}, {"introduction": "此前的练习展示了模型选择对风险评估的重要性，现在我们将在更复杂的算法交易场景中探讨这一主题。本练习模拟了一个交易执行过程，并要求你分析当风险模型被错误设定时（假设为正态分布，而实际为学生t分布）所产生的后果。通过计算风险预算被突破的真实概率，你将深刻理解为何在自动化交易策略中，准确捕捉收益分布的“肥尾”特性是控制成本和风险的关键。[@problem_id:2422084]", "id": "2422084", "problem": "一位交易员必须在一个有限的时间范围内执行一个大额买单，该时间范围被划分为 $T$ 个等长的区间，索引为 $t \\in \\{1,\\dots,T\\}$。设初始中间价归一化为 $P_0 = 1$。各区间的市场成交量分布由严格正整数 $V_t > 0$ 给出。交易员使用成交量加权平均价格（Volume-Weighted Average Price, VWAP）执行表，其形式如下\n$$\nx_t \\equiv Q \\cdot \\frac{V_t}{\\sum_{s=1}^{T} V_s},\n$$\n从而使得 $\\sum_{t=1}^{T} x_t = Q$，其中 $Q > 0$ 是要购买的总股数。\n\n直至区间 $t$ 结束的日内累计回报率被建模为单因子过程\n$$\nR_t = \\kappa_t \\cdot Z, \\quad \\kappa_t \\equiv \\sqrt{\\frac{t}{T}},\n$$\n其中 $Z$ 是一个代表整个时间范围回报因子的零均值随机变量。在区间 $t$ 结束时的实际执行价格为\n$$\nP_t = P_0 \\cdot (1 + R_t) + \\eta \\cdot \\frac{x_t}{V_t},\n$$\n其中 $\\eta > 0$ 是一个临时冲击系数，数量为 $x_t$ 的交易以价格 $P_t$ 执行。执行差额成本（相对于 $P_0$）为\n$$\nC \\equiv \\sum_{t=1}^{T} x_t \\cdot (P_t - P_0) = Z \\cdot \\sum_{t=1}^{T} x_t \\kappa_t + \\eta \\cdot \\sum_{t=1}^{T} \\frac{x_t^2}{V_t}.\n$$\n假设一位风险经理使用高斯模型校准在险价值（Value-at-Risk），该模型中 $Z \\sim \\mathcal{N}(0,\\sigma^2)$，已知 $\\sigma > 0$，尾部概率水平为 $1-p$。在此高斯假设下，$C$ 的随机部分的 VaR 预算为\n$$\nB_{\\text{G}} \\equiv z_p \\cdot \\sigma \\cdot W, \\quad \\text{其中 } z_p \\text{ 是水平为 } p \\text{ 的标准正态分位数，且 } W \\equiv \\sum_{t=1}^{T} x_t \\kappa_t.\n$$\n实际上，假设 $Z$ 服从自由度为 $\\nu > 2$、零均值的学生t分布（Student-$t$），并经过缩放以使其方差 $\\mathrm{Var}(Z) = \\sigma^2$。令 $s_\\nu$ 表示为匹配 $\\mathrm{Var}(Z)$ 而选择的缩放因子，从而 $Z \\overset{d}{=} s_\\nu \\cdot T_\\nu$，其中 $T_\\nu$ 是一个标准学生t随机变量（零均值，单位尺度），且 $s_\\nu^2 \\cdot \\frac{\\nu}{\\nu - 2} = \\sigma^2$。\n\n您的任务是，对下面指定的每个测试用例：\n- 计算 VWAP 执行表 $\\{x_t\\}_{t=1}^{T}$ 和风险敞口系数 $W = \\sum_{t=1}^{T} x_t \\kappa_t$。\n- 计算高斯校准的预算 $B_{\\text{G}} = z_p \\cdot \\sigma \\cdot W$。\n- 计算在真实的学生t模型下，随机部分的实际超出概率，即\n$$\n\\pi_{\\text{true}} \\equiv \\mathbb{P}\\left( Z \\cdot W > B_{\\text{G}} \\right) = 1 - F_{T_\\nu}\\!\\left( \\frac{B_{\\text{G}}}{W \\cdot s_\\nu} \\right),\n$$\n其中 $F_{T_\\nu}$ 是自由度为 $\\nu$ 的标准学生t分布的累积分布函数，且 $s_\\nu = \\sigma \\cdot \\sqrt{\\frac{\\nu - 2}{\\nu}}$。\n- 报告在高斯假设下的名义超出概率 $\\pi_{\\text{nom}} \\equiv 1 - p$，以小数形式表示。\n- 计算期望执行差额 $\\mathbb{E}[C]$，它等于确定性冲击成本：\n$$\n\\mathbb{E}[C] = \\eta \\cdot \\sum_{t=1}^{T} \\frac{x_t^2}{V_t}.\n$$\n\n所有以货币计价的量都应以与 $P_0 = 1$ 一致的归一化货币单位表示。所有概率必须以小数表示。\n\n测试套件：\n- 案例 1：\n  - $T = 4$\n  - $(V_1,V_2,V_3,V_4) = (300000,200000,200000,300000)$\n  - $Q = 100000$\n  - $\\sigma = 0.015$\n  - $p = 0.99$\n  - $\\nu = 5$\n  - $\\eta = 0.02$\n- 案例 2：\n  - $T = 6$\n  - $(V_1,V_2,V_3,V_4,V_5,V_6) = (100000,100000,100000,100000,100000,500000)$\n  - $Q = 50000$\n  - $\\sigma = 0.01$\n  - $p = 0.95$\n  - $\\nu = 3$\n  - $\\eta = 0.02$\n- 案例 3 (边界情况)：\n  - $T = 1$\n  - $(V_1) = (200000)$\n  - $Q = 20000$\n  - $\\sigma = 0.02$\n  - $p = 0.975$\n  - $\\nu = 100$\n  - $\\eta = 0.02$\n\n最终输出格式：\n- 您的程序必须生成单行输出，其中包含所有案例的结果，这些结果按顺序连接成一个用方括号括起来的逗号分隔列表。\n- 对于每个案例，按以下顺序输出四个浮点数：$B_{\\text{G}}$、$\\pi_{\\text{true}}$、$\\pi_{\\text{nom}}$、$\\mathbb{E}[C]$。\n- 将报告的每个数字四舍五入到 $6$ 位小数。\n- 因此，输出应采用以下形式\n$$\n[\\;B_{\\text{G}}^{(1)},\\;\\pi_{\\text{true}}^{(1)},\\;\\pi_{\\text{nom}}^{(1)},\\;\\mathbb{E}[C]^{(1)},\\;B_{\\text{G}}^{(2)},\\;\\pi_{\\text{true}}^{(2)},\\;\\pi_{\\text{nom}}^{(2)},\\;\\mathbb{E}[C]^{(2)},\\;B_{\\text{G}}^{(3)},\\;\\pi_{\\text{true}}^{(3)},\\;\\pi_{\\text{nom}}^{(3)},\\;\\mathbb{E}[C]^{(3)}\\;].\n$$", "solution": "该问题要求根据成交量加权平均价格（VWAP）执行表，计算与执行大宗交易的成本和风险相关的几个量。问题的核心在于，将基于高斯模型假设得出的风险度量与在更符合现实的市场回报的学生t分布下的实际风险进行比较。\n\n验证步骤确认了问题陈述具有科学依据、提法得当、客观且内部一致。所有必需的参数和模型都已明确定义，且提供的测试用例均有效。因此，我们着手进行求解。\n\n每个测试用例的解法都涉及一系列计算，我们在下面进行概述。设一个案例的给定参数为 $T$、$\\{V_t\\}_{t=1}^T$、$Q$、$\\sigma$、$p$、$\\nu$ 和 $\\eta$。\n\n**1. VWAP 执行表与总成交量**\n首先，我们计算执行时间范围内的总市场成交量：\n$$\nV_{\\text{total}} = \\sum_{s=1}^{T} V_s\n$$\nVWAP 执行表指定了在每个区间 $t$ 要交易的股数 $x_t$，其计算方式如下：\n$$\nx_t = Q \\cdot \\frac{V_t}{V_{\\text{total}}} \\quad \\text{for } t=1, \\dots, T\n$$\n根据构造，这确保了交易的总数量等于订单规模，即 $\\sum_{t=1}^{T} x_t = Q$。\n\n**2. 风险敞口系数，$W$**\n执行差额成本的随机部分与一个投资组合加权的累计回报因子成正比。随机因子 $Z$ 的权重是风险敞口系数 $W$。它被定义为交易规模 $x_t$ 按时间相关因子 $\\kappa_t$ 加权后的总和：\n$$\nW = \\sum_{t=1}^{T} x_t \\kappa_t\n$$\n其中 $\\kappa_t$ 定义为 $\\kappa_t = \\sqrt{t/T}$。该系数汇集了在整个执行时间范围内对基础市场回报因子 $Z$ 的风险敞口。\n\n**3. 高斯校准的 VaR 预算，$B_{\\text{G}}$**\n风险经理假设回报因子 $Z$ 服从高斯分布，$Z \\sim \\mathcal{N}(0,\\sigma^2)$。随机成本为 $C_{\\text{stoch}} = Z \\cdot W$。在高斯假设下，$C_{\\text{stoch}} \\sim \\mathcal{N}(0, (\\sigma W)^2)$。置信水平为 $p$ 的在险价值（VaR）是指以概率 $p$ 不会被超过的损失值。相应的预算 $B_{\\text{G}}$ 计算如下：\n$$\nB_{\\text{G}} = z_p \\cdot \\sigma \\cdot W\n$$\n其中 $z_p$ 是标准正态分布的分位数，满足 $\\mathbb{P}(Z_{std} \\le z_p) = p$，其中 $Z_{std} \\sim \\mathcal{N}(0,1)$。这通过使用标准正态分布的逆累积分布函数（CDF）计算，通常表示为 $\\Phi^{-1}(p)$。\n\n**4. 名义与实际超出概率，$\\pi_{\\text{nom}}$ 和 $\\pi_{\\text{true}}$**\n名义超出概率 $\\pi_{\\text{nom}}$ 是在假设的高斯模型下，随机成本超过预算 $B_{\\text{G}}$ 的概率。根据水平为 $p$ 的 VaR 的定义，此概率为：\n$$\n\\pi_{\\text{nom}} = \\mathbb{P}(Z \\cdot W > B_{\\text{G}}) = 1 - p\n$$\n问题陈述指出，$Z$ 的真实分布是一个缩放的学生t分布，$Z = s_\\nu \\cdot T_\\nu$，其中 $T_\\nu$ 是自由度为 $\\nu$ 的标准学生t随机变量。选择缩放因子 $s_\\nu$ 是为了匹配方差，即 $\\mathrm{Var}(Z) = \\sigma^2$。由于当 $\\nu > 2$ 时，$\\mathrm{Var}(T_\\nu) = \\nu/(\\nu-2)$，因此缩放因子推导如下：\n$$\ns_\\nu^2 \\cdot \\frac{\\nu}{\\nu - 2} = \\sigma^2 \\implies s_\\nu = \\sigma \\sqrt{\\frac{\\nu - 2}{\\nu}}\n$$\n实际超出概率 $\\pi_{\\text{true}}$ 是随机成本超过高斯校准预算 $B_{\\text{G}}$ 的概率，但这是在真实的的学生t分布下计算的：\n$$\n\\pi_{\\text{true}} = \\mathbb{P}(Z \\cdot W > B_{\\text{G}}) = \\mathbb{P}\\left(s_\\nu \\cdot T_\\nu \\cdot W > B_{\\text{G}}\\right)\n$$\n假设 $W > 0$（由于对于所有 $t$ 都有 $x_t > 0$，因此该假设成立），我们可以分离出 $T_\\nu$：\n$$\n\\pi_{\\text{true}} = \\mathbb{P}\\left(T_\\nu > \\frac{B_{\\text{G}}}{W \\cdot s_\\nu}\\right) = 1 - F_{T_\\nu}\\left(\\frac{B_{\\text{G}}}{W \\cdot s_\\nu}\\right)\n$$\n其中 $F_{T_\\nu}$ 是自由度为 $\\nu$ 的标准学生t分布的累积分布函数。CDF 的参数可以简化为：\n$$\n\\frac{B_{\\text{G}}}{W \\cdot s_\\nu} = \\frac{z_p \\cdot \\sigma \\cdot W}{W \\cdot \\sigma \\sqrt{\\frac{\\nu-2}{\\nu}}} = z_p \\sqrt{\\frac{\\nu}{\\nu-2}}\n$$\n这种简化在计算上是有利的，因为它不依赖于 $W$ 和 $\\sigma$，并避免了潜在的浮点不精确性。\n\n**5. 期望执行差额，$\\mathbb{E}[C]$**\n总执行差额为 $C = Z \\cdot W + \\eta \\cdot \\sum_{t=1}^{T} \\frac{x_t^2}{V_t}$。其期望是通过对每一项求期望来计算的。由于 $W$、$\\eta$、$x_t$ 和 $V_t$ 都是确定性的，且 $\\mathbb{E}[Z]=0$：\n$$\n\\mathbb{E}[C] = \\mathbb{E}[Z] \\cdot W + \\eta \\cdot \\sum_{t=1}^{T} \\frac{x_t^2}{V_t} = 0 \\cdot W + \\eta \\cdot \\sum_{t=1}^{T} \\frac{x_t^2}{V_t}\n$$\n因此，期望成本完全是由确定性的临时市场冲击造成的：\n$$\n\\mathbb{E}[C] = \\eta \\cdot \\sum_{t=1}^{T} \\frac{x_t^2}{V_t}\n$$\n该量通过将所有交易区间的冲击成本相加来计算。\n\n对每个测试用例实施这些步骤，以生成所需的四个输出值：$B_{\\text{G}}$、$\\pi_{\\text{true}}$、$\\pi_{\\text{nom}}$ 和 $\\mathbb{E}[C]$。", "answer": "```python\nimport numpy as np\nfrom scipy.stats import norm, t\n\ndef solve():\n    \"\"\"\n    Solves the trade execution risk problem for a suite of test cases.\n    \"\"\"\n\n    test_cases = [\n        {\n            \"T\": 4, \"V\": [300000, 200000, 200000, 300000], \"Q\": 100000,\n            \"sigma\": 0.015, \"p\": 0.99, \"nu\": 5, \"eta\": 0.02\n        },\n        {\n            \"T\": 6, \"V\": [100000, 100000, 100000, 100000, 100000, 500000], \"Q\": 50000,\n            \"sigma\": 0.01, \"p\": 0.95, \"nu\": 3, \"eta\": 0.02\n        },\n        {\n            \"T\": 1, \"V\": [200000], \"Q\": 20000,\n            \"sigma\": 0.02, \"p\": 0.975, \"nu\": 100, \"eta\": 0.02\n        }\n    ]\n\n    results = []\n\n    for case in test_cases:\n        T = case[\"T\"]\n        V = np.array(case[\"V\"], dtype=float)\n        Q = case[\"Q\"]\n        sigma = case[\"sigma\"]\n        p = case[\"p\"]\n        nu = case[\"nu\"]\n        eta = case[\"eta\"]\n\n        # 1. Compute the VWAP schedule {x_t}\n        V_total = np.sum(V)\n        x = Q * V / V_total\n        \n        # 2. Compute the exposure coefficient W\n        t_indices = np.arange(1, T + 1)\n        kappa = np.sqrt(t_indices / T)\n        W = np.sum(x * kappa)\n        \n        # 3. Compute the Gaussian-calibrated budget B_G\n        z_p = norm.ppf(p)\n        B_G = z_p * sigma * W\n        \n        # 4. Compute nominal and true exceedance probabilities\n        pi_nom = 1.0 - p\n        \n        # The argument for the Student-t CDF can be simplified to avoid\n        # dependency on W and sigma, which improves numerical stability.\n        if nu > 2:\n            t_stat = z_p * np.sqrt(nu / (nu - 2))\n            pi_true = 1.0 - t.cdf(t_stat, df=nu)\n        else:\n            # Variance is undefined for nu <= 2, problem statement guarantees nu > 2.\n            pi_true = np.nan\n\n        # 5. Compute the expected implementation shortfall E[C]\n        E_C = eta * np.sum(np.square(x) / V)\n\n        results.extend([B_G, pi_true, pi_nom, E_C])\n        \n    # Format the final output string with 6 decimal places per value.\n    formatted_results = [f\"{val:.6f}\" for val in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"}]}