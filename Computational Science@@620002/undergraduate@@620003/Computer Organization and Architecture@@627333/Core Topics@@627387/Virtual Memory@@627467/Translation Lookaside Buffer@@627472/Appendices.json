{"hands_on_practices": [{"introduction": "To quantify the performance of a Translation Lookaside Buffer, we must account for its hierarchical structure, a common design in modern processors. This exercise guides you through deriving the expected address translation time, $t_{\\text{AT}}$, for a two-level TLB by combining the probabilities of hits and misses with their respective latencies. Mastering this calculation [@problem_id:3685658] provides a fundamental tool for analyzing the performance of any tiered caching system.", "problem": "A processor implements a 2-level Translation Lookaside Buffer (TLB). Let the Level $1$ TLB (L1) have hit rate $H_1$, and, conditioned on an L1 miss, the Level $2$ TLB (L2) have hit rate $H_2$. Define the translation latency contributions as follows: if L1 hits, the translation latency contribution is $t_1$; if L1 misses and L2 hits, the translation latency contribution is $t_2$; if both L1 and L2 miss, the translation requires a hardware page walk with latency $t_w$. Assume these contributions are mutually exclusive path costs, meaning $t_2$ and $t_w$ already subsume any upstream lookup overhead. Also assume stationarity of the access stream so that $H_1$ and $H_2$ are well-defined probabilities, and apply only foundational probability principles (such as the law of total probability and the definition of expectation).\n\nTask A (derivation): From first principles, derive an analytic expression for the expected address translation time $t_{\\text{AT}}$ in terms of $H_1$, $H_2$, $t_1$, $t_2$, and $t_w$.\n\nTask B (streaming effect): During a streaming access phase, temporal locality at L1 degrades, so $H_1$ decreases by $\\Delta H$ with $0 < \\Delta H < H_1$, while $H_2$ remains unchanged due to larger reach. Let $t_1 = 0.5$ nanoseconds, $t_2 = 3$ nanoseconds, $t_w = 120$ nanoseconds, $H_2 = 0.97$, and $\\Delta H = 0.18$. Using your derived expression, compute the resulting change in expected translation time $\\Delta t_{\\text{AT}} = t_{\\text{AT}}^{\\prime} - t_{\\text{AT}}$, where $t_{\\text{AT}}^{\\prime}$ is the expected translation time after the drop in $H_1$. Express your final numeric answer for $\\Delta t_{\\text{AT}}$ in nanoseconds, rounded to four significant figures.", "solution": "The solution is presented in two parts as requested by the problem statement.\n\nTask A: Derivation of the expected address translation time, $t_{\\text{AT}}$.\n\nAn address translation request can result in one of three mutually exclusive outcomes:\n$1$. A hit in the Level $1$ TLB (L1).\n$2$. A miss in the L1 TLB, followed by a hit in the Level $2$ TLB (L2).\n$3$. A miss in both the L1 TLB and the L2 TLB, requiring a full page walk.\n\nLet us define the probabilities of these events based on the provided parameters. The hit rate of the L1 TLB is given as $H_1$. This is the probability of the first outcome.\n$$P(\\text{L1 hit}) = H_1$$\nThe probability of an L1 miss is therefore $1 - H_1$.\n$$P(\\text{L1 miss}) = 1 - H_1$$\nThe problem states that the L2 hit rate, $H_2$, is conditioned on an L1 miss. This is a conditional probability:\n$$P(\\text{L2 hit} | \\text{L1 miss}) = H_2$$\nThe probability of the second outcome (L1 miss and L2 hit) is found using the definition of conditional probability, $P(A \\cap B) = P(A|B)P(B)$:\n$$P(\\text{L1 miss} \\cap \\text{L2 hit}) = P(\\text{L2 hit} | \\text{L1 miss}) \\times P(\\text{L1 miss}) = H_2 (1 - H_1)$$\nSimilarly, the probability of an L2 miss, conditioned on an L1 miss, is $1 - H_2$.\n$$P(\\text{L2 miss} | \\text{L1 miss}) = 1 - H_2$$\nThe probability of the third outcome (L1 miss and L2 miss) is:\n$$P(\\text{L1 miss} \\cap \\text{L2 miss}) = P(\\text{L2 miss} | \\text{L1 miss}) \\times P(\\text{L1 miss}) = (1 - H_2) (1 - H_1)$$\nThese three events are exhaustive. Their probabilities sum to $1$:\n$$H_1 + H_2(1 - H_1) + (1 - H_2)(1 - H_1) = H_1 + (1 - H_1)(H_2 + 1 - H_2) = H_1 + (1 - H_1) = 1$$\nThe latencies associated with these three outcomes are given as $t_1$, $t_2$, and $t_w$, respectively.\n\nThe expected address translation time, $t_{\\text{AT}}$, is the sum of the products of each outcome's probability and its corresponding latency, based on the definition of expected value:\n$$t_{\\text{AT}} = P(\\text{L1 hit}) \\cdot t_1 + P(\\text{L1 miss} \\cap \\text{L2 hit}) \\cdot t_2 + P(\\text{L1 miss} \\cap \\text{L2 miss}) \\cdot t_w$$\nSubstituting the expressions for the probabilities yields the analytic expression for $t_{\\text{AT}}$:\n$$t_{\\text{AT}} = H_1 t_1 + (1 - H_1) H_2 t_2 + (1 - H_1) (1 - H_2) t_w$$\nThis is the final derived expression for Task A.\n\nTask B: Calculation of the change in expected translation time, $\\Delta t_{\\text{AT}}$.\n\nInitially, the expected translation time is given by the expression derived above. Let us denote this as $t_{\\text{AT}}$.\nDuring the streaming access phase, the L1 hit rate $H_1$ decreases by an amount $\\Delta H$. The new L1 hit rate, $H_1^{\\prime}$, is:\n$$H_1^{\\prime} = H_1 - \\Delta H$$\nThe new expected translation time, $t_{\\text{AT}}^{\\prime}$, is found by substituting $H_1^{\\prime}$ into the expression for $t_{\\text{AT}}$, while all other parameters ($H_2$, $t_1$, $t_2$, $t_w$) remain constant:\n$$t_{\\text{AT}}^{\\prime} = H_1^{\\prime} t_1 + (1 - H_1^{\\prime}) H_2 t_2 + (1 - H_1^{\\prime}) (1 - H_2) t_w$$\nThe change in the expected translation time is $\\Delta t_{\\text{AT}} = t_{\\text{AT}}^{\\prime} - t_{\\text{AT}}$.\n$$\\Delta t_{\\text{AT}} = \\left( H_1^{\\prime} t_1 + (1 - H_1^{\\prime}) H_2 t_2 + (1 - H_1^{\\prime}) (1 - H_2) t_w \\right) - \\left( H_1 t_1 + (1 - H_1) H_2 t_2 + (1 - H_1) (1 - H_2) t_w \\right)$$\nWe can group terms by their respective latencies:\n$$\\Delta t_{\\text{AT}} = (H_1^{\\prime} - H_1) t_1 + ((1 - H_1^{\\prime}) - (1 - H_1)) H_2 t_2 + ((1 - H_1^{\\prime}) - (1 - H_1)) (1 - H_2) t_w$$\nThe difference terms are:\n$$H_1^{\\prime} - H_1 = (H_1 - \\Delta H) - H_1 = -\\Delta H$$\n$$(1 - H_1^{\\prime}) - (1 - H_1) = 1 - (H_1 - \\Delta H) - 1 + H_1 = \\Delta H$$\nSubstituting these back into the expression for $\\Delta t_{\\text{AT}}$:\n$$\\Delta t_{\\text{AT}} = (-\\Delta H) t_1 + (\\Delta H) H_2 t_2 + (\\Delta H) (1 - H_2) t_w$$\nFactoring out $\\Delta H$ gives the final expression for the change, which is independent of the initial hit rate $H_1$:\n$$\\Delta t_{\\text{AT}} = \\Delta H (-t_1 + H_2 t_2 + (1 - H_2) t_w)$$\nNow, we substitute the provided numerical values:\n$\\Delta H = 0.18$\n$H_2 = 0.97$\n$t_1 = 0.5$ nanoseconds\n$t_2 = 3$ nanoseconds\n$t_w = 120$ nanoseconds\n\nPlugging these values into the expression for $\\Delta t_{\\text{AT}}$:\n$$\\Delta t_{\\text{AT}} = 0.18 \\times (-0.5 + (0.97 \\times 3) + (1 - 0.97) \\times 120)$$\n$$\\Delta t_{\\text{AT}} = 0.18 \\times (-0.5 + 2.91 + 0.03 \\times 120)$$\n$$\\Delta t_{\\text{AT}} = 0.18 \\times (-0.5 + 2.91 + 3.6)$$\n$$\\Delta t_{\\text{AT}} = 0.18 \\times (2.41 + 3.6)$$\n$$\\Delta t_{\\text{AT}} = 0.18 \\times 6.01$$\n$$\\Delta t_{\\text{AT}} = 1.0818$$\nThe units are in nanoseconds. The problem requires the answer to be rounded to four significant figures.\n$$1.0818 \\text{ ns} \\approx 1.082 \\text{ ns}$$\nThus, the resulting change in expected translation time is $1.082$ nanoseconds.", "answer": "$$\n\\boxed{1.082}\n$$", "id": "3685658"}, {"introduction": "The effectiveness of a TLB is not just about its access speed, but also the total memory region it can map at one time, a concept known as 'TLB reach'. This problem explores the critical relationship between page size ($P$), the number of TLB entries ($C$), and the resulting reach ($R = C \\cdot P$) needed to cover a program's working set. By analyzing this hypothetical scenario [@problem_id:3685718], you will uncover a key motivation behind the support for 'huge pages' in modern computer architectures.", "problem": "A virtual memory system uses a Translation Lookaside Buffer (TLB) to cache recent virtual-to-physical page translations. Let the TLB have $C$ entries and page size $P$, so its TLB reach is $R = C \\cdot P$ bytes. Consider a program with a stable working set of size $W_s$ bytes and strong temporal locality characterized by the following parametric model: the cumulative fraction of references that fall within the most frequently accessed $x$ bytes of the working set is\n$$\nF(x) = \\left(\\frac{x}{W_s}\\right)^{\\alpha}, \\quad 0 \\le x \\le W_s,\n$$\nwhere $0 < \\alpha \\le 1$ is a given locality parameter. Assume ideal TLB replacement that always retains translations for the most frequently referenced pages, and that $W_s \\gg P$ so that page-boundary effects can be ignored and $C$ can be treated as a real-valued capacity for the purpose of estimation.\n\nYou are asked to provision the TLB to achieve a target TLB hit rate of at least $1 - \\epsilon$ for a given small miss fraction $\\epsilon$. The TLB hit rate $H$ can be approximated by the coverage of the most frequently referenced region of size $R$, that is $H \\approx F(R)$.\n\nTwo page sizes are under consideration: $P_1 = 4\\,\\text{KiB}$ and $P_2 = 2\\,\\text{MiB}$. Let $W_s = 512\\,\\text{MiB}$, $\\alpha = 0.7$, and $\\epsilon = 0.01$.\n\nUsing only the definitions above and the stated model, derive the minimal TLB reach $R^{\\star}$ (in bytes) needed to achieve $H \\approx 1 - \\epsilon$, and from it the minimal real-valued number of TLB entries $C_i^{\\star} = R^{\\star} / P_i$ required under each page size $P_i$. Report as your final answer the ratio $C_1^{\\star} / C_2^{\\star}$ as a single, exact, unitless number. No rounding is required, and you must give a simplified exact value.", "solution": "The problem requires the derivation of the ratio of the minimal number of Translation Lookaside Buffer (TLB) entries, $C_1^{\\star} / C_2^{\\star}$, for two different page sizes, $P_1$ and $P_2$. The derivation must be based on the provided parametric model for temporal locality.\n\nThe TLB hit rate, $H$, is approximated by the cumulative fraction of references falling within the TLB reach, $R$. The reach is defined as the product of the number of TLB entries, $C$, and the page size, $P$, so $R = C \\cdot P$. The locality model is given by the function $F(x)$, where $x$ is the size of the memory region in bytes:\n$$\nF(x) = \\left(\\frac{x}{W_s}\\right)^{\\alpha}\n$$\nHere, $W_s$ is the working set size and $\\alpha$ is the locality parameter. The TLB hit rate is therefore approximated as $H \\approx F(R)$.\n\nThe objective is to provision the TLB to achieve a target hit rate of at least $1 - \\epsilon$, where $\\epsilon$ is the maximum tolerable miss fraction. This implies the condition $H \\ge 1 - \\epsilon$. Using the provided approximation, this translates to:\n$$\nF(R) \\ge 1 - \\epsilon\n$$\nSince the function $F(x)$ is monotonically increasing with $x$ for $x > 0$ and $\\alpha > 0$, the minimal TLB reach, which we denote as $R^{\\star}$, required to satisfy this condition is found by solving the equality:\n$$\nF(R^{\\star}) = 1 - \\epsilon\n$$\nSubstituting the definition of $F(x)$:\n$$\n\\left(\\frac{R^{\\star}}{W_s}\\right)^{\\alpha} = 1 - \\epsilon\n$$\nWe can now solve for $R^{\\star}$. First, we take the $1/\\alpha$ power of both sides:\n$$\n\\frac{R^{\\star}}{W_s} = (1 - \\epsilon)^{1/\\alpha}\n$$\nMultiplying by $W_s$ yields the expression for the minimal required TLB reach:\n$$\nR^{\\star} = W_s (1 - \\epsilon)^{1/\\alpha}\n$$\nThis expression defines the minimal total memory size that must be covered by the TLB to achieve the target hit rate. Notably, $R^{\\star}$ depends on the program's properties ($W_s$, $\\alpha$) and the performance target ($\\epsilon$), but it is independent of the page size $P$.\n\nThe problem defines the number of TLB entries as $C = R/P$. Therefore, the minimal number of entries required for a page size $P_i$, denoted $C_i^{\\star}$, is given by:\n$$\nC_i^{\\star} = \\frac{R^{\\star}}{P_i}\n$$\nUsing this relationship, we can express the minimal number of entries for the two given page sizes, $P_1$ and $P_2$:\n$$\nC_1^{\\star} = \\frac{R^{\\star}}{P_1}\n$$\n$$\nC_2^{\\star} = \\frac{R^{\\star}}{P_2}\n$$\nWe are asked to find the ratio $C_1^{\\star} / C_2^{\\star}$. We can form this ratio using the expressions above:\n$$\n\\frac{C_1^{\\star}}{C_2^{\\star}} = \\frac{\\frac{R^{\\star}}{P_1}}{\\frac{R^{\\star}}{P_2}}\n$$\nThe term $R^{\\star}$ is common to both the numerator and the denominator, so it cancels out:\n$$\n\\frac{C_1^{\\star}}{C_2^{\\star}} = \\frac{1/P_1}{1/P_2} = \\frac{P_2}{P_1}\n$$\nThis result demonstrates that the ratio of required TLB entries is simply the inverse of the ratio of the corresponding page sizes. The specific values of $W_s = 512\\,\\text{MiB}$, $\\alpha = 0.7$, and $\\epsilon = 0.01$ are not needed to determine this ratio.\n\nWe are given the page sizes $P_1 = 4\\,\\text{KiB}$ and $P_2 = 2\\,\\text{MiB}$. To compute the numerical value of the ratio, we must express these sizes in a common unit, such as bytes.\nThe first page size is:\n$$\nP_1 = 4\\,\\text{KiB} = 4 \\times 2^{10}\\,\\text{bytes} = 2^2 \\times 2^{10}\\,\\text{bytes} = 2^{12}\\,\\text{bytes}\n$$\nThe second page size is:\n$$\nP_2 = 2\\,\\text{MiB} = 2 \\times 2^{20}\\,\\text{bytes} = 2^{1} \\times 2^{20}\\,\\text{bytes} = 2^{21}\\,\\text{bytes}\n$$\nNow, we can substitute these values into the expression for the ratio:\n$$\n\\frac{C_1^{\\star}}{C_2^{\\star}} = \\frac{P_2}{P_1} = \\frac{2^{21}\\,\\text{bytes}}{2^{12}\\,\\text{bytes}} = 2^{21-12} = 2^9\n$$\nFinally, we calculate the exact value of $2^9$:\n$$\n2^9 = 512\n$$\nThus, to achieve the same target hit rate, the system with the smaller page size ($P_1$) requires $512$ times as many TLB entries as the system with the larger page size ($P_2$).", "answer": "$$\\boxed{512}$$", "id": "3685718"}, {"introduction": "A TLB with theoretically sufficient capacity can still deliver poor performance if memory accesses systematically collide in a small number of its sets. This practice challenges you to engineer a worst-case scenario where a specific memory access pattern causes relentless conflict misses, a phenomenon known as thrashing. By constructing this pathological case [@problem_id:3685734], you will gain a deeper, more concrete understanding of how software behavior interacts with the hardware's set-associative structure.", "problem": "A Translation Lookaside Buffer (TLB) is a cache of virtual-to-physical page translations used by a processor to accelerate memory address translation. Consider a TLB with total capacity of $C$ entries and $A$-way set associativity, yielding $N_{\\text{sets}} = \\frac{C}{A}$ sets, each holding up to $A$ entries. Assume the TLB uses least recently used (LRU) replacement within each set, and that the set index is computed as the virtual page number modulo the number of sets, that is, $\\text{set\\_index} = \\mathrm{VPN} \\bmod N_{\\text{sets}}$. A program repeatedly accesses $W$ distinct virtual pages in a fixed cyclic order, with the $k$-th page number given by $p_k = p_0 + k S$ for $k = 0, 1, \\dots, W - 1$, where $S$ is an integer stride measured in pages and $p_0$ is an arbitrary base page number.\n\nDesign choices for $W$ and $S$ control how these pages map into TLB sets and therefore how many conflicts occur. Choose integer values for $W$ and $S$ (expressed symbolically in terms of $C$ and $A$ only) that maximize conflict misses caused solely by mapping collisions in the TLB, under the stated model. Then, compute the steady-state TLB hit rate $H$ for the infinite cyclic access stream, defined as the limit of the fraction of TLB hits over total accesses as the number of cycles goes to infinity.\n\nState explicit formulas for $W$, $S$, and $H$ in terms of $C$ and $A$. Provide your final answer as a row matrix containing $W$, $S$, and $H$. No rounding is required, and $H$ must be expressed as a decimal or fraction without a percentage sign.", "solution": "The goal is to select integer parameters $W$ (working set size) and $S$ (stride) to maximize the number of conflict misses in the TLB. A conflict miss occurs when an access maps to a TLB set that is already full of other valid entries, forcing an eviction. The highest possible miss rate is $1$, which corresponds to a hit rate of $0$. We will seek to achieve this condition.\n\nThe set index for the $k$-th page in the access sequence, $p_k$, is given by:\n$$ \\text{set\\_index}(p_k) = p_k \\bmod N_{\\text{sets}} = (p_0 + kS) \\bmod N_{\\text{sets}} $$\nwhere $N_{\\text{sets}} = \\frac{C}{A}$.\n\nTo maximize conflicts, we should arrange for many pages to map to the same set, creating contention for the limited $A$ entries (ways) in that set. The most extreme contention occurs when all $W$ pages in the working set map to a single TLB set.\n\nFor all $W$ pages to map to the same set, their set indices must be identical for all $k \\in \\{0, 1, \\dots, W-1\\}$. Let the set index for $p_0$ be $j = p_0 \\bmod N_{\\text{sets}}$. We require that for all subsequent pages $p_k$, the set index is also $j$.\n$$ (p_0 + kS) \\bmod N_{\\text{sets}} = p_0 \\bmod N_{\\text{sets}} $$\nThis relation holds if and only if $(kS) \\bmod N_{\\text{sets}} = 0$ for all $k \\in \\{1, \\dots, W-1\\}$. For this condition to be true for any choice of $W > 1$, the stride $S$ must be a non-zero integer multiple of $N_{\\text{sets}}$. The simplest and most fundamental choice to ensure this collision is to set $S$ equal to the number of sets.\n$$ S = N_{\\text{sets}} = \\frac{C}{A} $$\nThis choice of $S$ guarantees that all $W$ pages, $p_0, p_1, \\dots, p_{W-1}$, map to the same TLB set, namely the set with index $p_0 \\bmod N_{\\text{sets}}$.\n\nNow that all $W$ pages compete for the same $A$ slots in a single set, we must choose $W$ to maximize misses. The replacement policy is LRU. A set with associativity $A$ can hold up to $A$ distinct page translations. If we cyclically access a number of pages $W$ that is greater than $A$, we will inevitably cause evictions.\n\nTo guarantee a miss on every access in the steady state (a phenomenon known as thrashing), the number of distinct pages in the cyclic working set must be just large enough so that by the time a page is re-referenced, it has already been evicted. With an LRU policy, a set of associativity $A$ stores the $A$ most recently used items. If we access $W$ items in a cycle, an access to item $i$ will be a miss if item $i$ is not among the $A$ most recently accessed items.\n\nConsider a cyclic access pattern of $W$ pages. Before accessing page $p_k$, the $A$ most recent accesses were to pages $p_{k-1}, p_{k-2}, \\dots, p_{k-A}$ (indices are cyclic). If $W$ is chosen such that $p_k$ is not in this group of $A$ pages, the access to $p_k$ will be a miss. The smallest integer $W$ for which this is true is $W = A+1$.\n\nLet's trace the behavior with $W = A+1$. The access pattern is a cycle through $p_0, p_1, \\dots, p_A$.\n1. Access $p_0$: Miss. Set now contains $\\{p_0\\}$.\n2. Access $p_1$: Miss. Set now contains $\\{p_0, p_1\\}$.\n...\nA. Access $p_{A-1}$: Miss. Set now contains $\\{p_0, \\dots, p_{A-1}\\}$.\nA+1. Access $p_A$: Miss. The set is full. $p_0$ is the LRU entry and is evicted. Set now contains $\\{p_1, \\dots, p_A\\}$.\nA+2. Access $p_0$ (cycle repeats): Miss. The set contains $\\{p_1, \\dots, p_A\\}$, so $p_0$ is not present. $p_1$ is now LRU and is evicted.\n\nIn the steady state (after the initial compulsory misses), every access is to a page that has been evicted from the set. For an access to page $p_k$, the set contains the $A$ previously accessed pages, $\\{p_{k-1 \\pmod{A+1}}, \\dots, p_{k-A \\pmod{A+1}}\\}$. Since there are $A+1$ pages in the cycle, the page $p_k$ is guaranteed not to be in the set. Therefore, every access results in a miss.\n\nThis situation yields a miss rate of $1$ and thus a hit rate of $0$. A hit rate of $0$ corresponds to the maximum possible number of misses. Thus, our choices for $W$ and $S$ satisfy the problem's requirement.\n\nThe chosen values are:\n- Working set size: $W = A+1$\n- Stride: $S = \\frac{C}{A}$\n\nThe steady-state hit rate, $H$, is the ratio of hits to total accesses. Since every access in the steady state is a miss, the number of hits is $0$.\n$$ H = \\frac{\\text{Number of Hits}}{\\text{Total Accesses}} = \\frac{0}{W} = 0 $$\n\nThe final answer consists of the symbolic expressions for $W$, $S$, and $H$.\n$W = A+1$\n$S = \\frac{C}{A}$\n$H = 0$", "answer": "$$ \\boxed{\\begin{pmatrix} A+1 & \\frac{C}{A} & 0 \\end{pmatrix}} $$", "id": "3685734"}]}