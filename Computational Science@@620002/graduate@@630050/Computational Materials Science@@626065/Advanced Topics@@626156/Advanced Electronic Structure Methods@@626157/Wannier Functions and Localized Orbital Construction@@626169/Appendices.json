{"hands_on_practices": [{"introduction": "Before we can construct Maximally Localized Wannier Functions (MLWFs), we must first precisely define what we are trying to optimize. This foundational exercise guides you through the derivation of the discrete spread functional, which is the central objective function minimized in all modern MLWF algorithms. By starting from a general, non-orthogonal basis and employing Löwdin orthogonalization, this practice [@problem_id:3502300] reveals the mathematical structure of localization in a discrete Brillouin zone, providing a deep understanding of the theoretical underpinnings of Wannier function construction.", "problem": "Consider a set of non-orthogonal tight-binding Bloch-like states $\\{|\\phi_{m}(\\mathbf{k})\\rangle\\}_{m=1}^{N}$ at crystal momentum $\\mathbf{k}$ spanning a chosen $N$-dimensional subspace. Their overlap matrix is $S_{mn}(\\mathbf{k})=\\langle\\phi_{m}(\\mathbf{k})|\\phi_{n}(\\mathbf{k})\\rangle$, assumed Hermitian and positive definite for each $\\mathbf{k}$. Define the Löwdin orthogonalized Bloch-like states by $|\\tilde{\\phi}_{m}(\\mathbf{k})\\rangle=\\sum_{n}|\\phi_{n}(\\mathbf{k})\\rangle\\left[S^{-1/2}(\\mathbf{k})\\right]_{nm}$, so that $\\langle\\tilde{\\phi}_{m}(\\mathbf{k})|\\tilde{\\phi}_{n}(\\mathbf{k})\\rangle=\\delta_{mn}$. Let $N_{\\mathbf{k}}$ be the number of $\\mathbf{k}$-points in a uniform Brillouin Zone (BZ) mesh, and let $\\{\\mathbf{b}\\}$ denote a symmetric finite-difference neighbor set with weights $\\{w_{\\mathbf{b}}\\}$ satisfying $\\sum_{\\mathbf{b}}w_{\\mathbf{b}}\\mathbf{b}=\\mathbf{0}$ and $\\sum_{\\mathbf{b}}w_{\\mathbf{b}}b_{\\mu}b_{\\nu}=\\delta_{\\mu\\nu}$ for Cartesian components $\\mu,\\nu\\in\\{x,y,z\\}$.\n\nDefine the raw inter-$\\mathbf{k}$ overlap matrices between neighbor points,\n$$\nM^{(0)}_{mn}(\\mathbf{k},\\mathbf{b})=\\langle\\phi_{m}(\\mathbf{k})|\\phi_{n}(\\mathbf{k}+\\mathbf{b})\\rangle,\n$$\nand their Löwdin-orthogonalized counterparts,\n$$\n\\tilde{M}_{mn}(\\mathbf{k},\\mathbf{b})=\\langle\\tilde{\\phi}_{m}(\\mathbf{k})|\\tilde{\\phi}_{n}(\\mathbf{k}+\\mathbf{b})\\rangle.\n$$\nMaximally Localized Wannier Functions (MLWF) are constructed from a smooth gauge of Bloch-like states over the BZ, and their quadratic spread functional is the sum over bands of the second central moment of the position operator. Using only the following fundamental bases: (i) Bloch's theorem and the definition of Wannier functions as Fourier transforms of smooth Bloch-like states, (ii) the definition of the quadratic spread as the variance of position over Wannier states, and (iii) the Löwdin orthogonalization procedure, derive a discrete, periodic-gauge expression for the generalized MLWF spread functional in the Löwdin-orthogonalized space expressed entirely in terms of $S_{mn}(\\mathbf{k})$ and $M^{(0)}_{mn}(\\mathbf{k},\\mathbf{b})$ on the uniform mesh. Use the principal branch of the complex logarithm for phases, that is, for any complex $z\\neq 0$, let $\\arg(z)=\\text{Im}\\ln z\\in(-\\pi,\\pi]$. Your final expression should be a single closed-form analytical expression involving only sums over $\\mathbf{k}$, $\\mathbf{b}$, $S^{-1/2}(\\mathbf{k})$, and $M^{(0)}(\\mathbf{k},\\mathbf{b})$, and should not introduce any quantities undefined by these. No numerical evaluation is required. Express your answer as a single analytical expression. If you need to introduce the Wannier centers, they must be eliminated in favor of a combination of the same inter-$\\mathbf{k}$ phases to produce a closed-form functional on the mesh.", "solution": "The user wants me to act as a meticulous and exacting professor in the STEM fields and solve a problem related to computational materials science.\n\n### Problem Validation\n\n**Step 1: Extract Givens**\n\n*   A set of $N$ non-orthogonal Bloch-like states $\\{|\\phi_{m}(\\mathbf{k})\\rangle\\}$ at crystal momentum $\\mathbf{k}$.\n*   Overlap matrix: $S_{mn}(\\mathbf{k})=\\langle\\phi_{m}(\\mathbf{k})|\\phi_{n}(\\mathbf{k})\\rangle$, which is Hermitian and positive definite.\n*   Löwdin orthogonalized states: $|\\tilde{\\phi}_{m}(\\mathbf{k})\\rangle=\\sum_{n}|\\phi_{n}(\\mathbf{k})\\rangle\\left[S^{-1/2}(\\mathbf{k})\\right]_{nm}$.\n*   Orthogonality of Löwdin states: $\\langle\\tilde{\\phi}_{m}(\\mathbf{k})|\\tilde{\\phi}_{n}(\\mathbf{k})\\rangle=\\delta_{mn}$.\n*   Uniform Brillouin Zone (BZ) mesh with $N_{\\mathbf{k}}$ points.\n*   A symmetric finite-difference neighbor set $\\{\\mathbf{b}\\}$ with weights $\\{w_{\\mathbf{b}}\\}$.\n*   Properties of the neighbor set and weights: $\\sum_{\\mathbf{b}}w_{\\mathbf{b}}\\mathbf{b}=\\mathbf{0}$ and $\\sum_{\\mathbf{b}}w_{\\mathbf{b}}b_{\\mu}b_{\\nu}=\\delta_{\\mu\\nu}$ for Cartesian components $\\mu,\\nu$.\n*   Raw inter-$\\mathbf{k}$ overlap matrices: $M^{(0)}_{mn}(\\mathbf{k},\\mathbf{b})=\\langle\\phi_{m}(\\mathbf{k})|\\phi_{n}(\\mathbf{k}+\\mathbf{b})\\rangle$.\n*   Löwdin-orthogonalized inter-$\\mathbf{k}$ overlap matrices: $\\tilde{M}_{mn}(\\mathbf{k},\\mathbf{b})=\\langle\\tilde{\\phi}_{m}(\\mathbf{k})|\\tilde{\\phi}_{n}(\\mathbf{k}+\\mathbf{b})\\rangle$.\n*   Task: Derive the quadratic spread functional $\\Omega$ in the Löwdin-orthogonalized space, using a discrete BZ representation.\n*   Constraints: The final expression must be a single closed-form expression in terms of $S_{mn}(\\mathbf{k})$ and $M^{(0)}_{mn}(\\mathbf{k},\\mathbf{b})$. Wannier centers must be eliminated. The principal branch of the complex logarithm is to be used for phases, $\\arg(z)=\\text{Im}\\ln z\\in(-\\pi,\\pi]$.\n\n**Step 2: Validate Using Extracted Givens**\n\n*   **Scientifically Grounded:** The problem is firmly rooted in the modern theory of polarization and the method of Maximally Localized Wannier Functions (MLWFs), a cornerstone of computational materials science. All concepts, including Bloch states, Löwdin orthogonalization, and the discrete representation of the spread functional, are standard and well-established.\n*   **Well-Posed:** The problem is well-posed. It asks for a specific derivation of a known physical quantity (the spread functional) under a clear set of definitions and constraints (discrete k-space, specific basis). The existence of a unique analytical expression is expected.\n*   **Objective:** The problem is phrased in a precise and objective technical language, free from ambiguity or subjective content.\n*   **Conclusion:** The problem is scientifically sound, well-posed, objective, and complete.\n\n**Step 3: Verdict and Action**\n\nThe problem is valid. I will proceed with the derivation.\n\n### Solution Derivation\n\nThe total quadratic spread functional $\\Omega$ for a set of $N$ Wannier functions is the sum of the individual spreads (second central moments of the position operator $\\mathbf{r}$):\n$$\n\\Omega = \\sum_{n=1}^{N} \\Omega_n = \\sum_{n=1}^{N} \\left( \\langle w_n | \\mathbf{r}^2 | w_n \\rangle - |\\langle w_n | \\mathbf{r} | w_n \\rangle|^2 \\right)\n$$\nwhere $|w_n\\rangle$ denotes the Wannier function for band $n$ localized at the home unit cell, and $\\langle w_n | \\mathbf{r} | w_n \\rangle = \\bar{\\mathbf{r}}_n$ is the Wannier center. The problem requires an expression for this functional for the Wannier functions constructed directly from the Löwdin-orthogonalized Bloch-like states $|\\tilde{\\phi}_{n}(\\mathbf{k})\\rangle$ on a discrete Brillouin Zone (BZ) mesh.\n\nThe derivation proceeds in several steps:\n1.  Express the two terms in the spread functional, $\\sum_n \\langle r^2 \\rangle_n$ and $\\sum_n |\\bar{\\mathbf{r}}_n|^2$, in terms of k-space quantities.\n2.  Discretize these k-space expressions using the provided finite-difference scheme.\n3.  Express the resulting formulas in terms of the given overlap matrices $S(\\mathbf{k})$ and $M^{(0)}(\\mathbf{k},\\mathbf{b})$.\n\n**1. Sum of Second Moments $\\sum_n \\langle r^2 \\rangle_n$**\n\nThe sum of the second moments of the position operator over all Wannier functions can be related to the trace of the square of the Berry connection matrix. In the continuum, this is:\n$$\n\\sum_{n=1}^{N} \\langle w_n | r^2 | w_n \\rangle = \\frac{V}{(2\\pi)^d} \\int_{\\mathrm{BZ}} d^d k \\, \\sum_{m,n=1}^{N} |\\mathbf{A}_{mn}(\\mathbf{k})|^2\n$$\nwhere $\\mathbf{A}_{mn}(\\mathbf{k}) = \\langle u_{m\\mathbf{k}} | i\\nabla_{\\mathbf{k}} | u_{n\\mathbf{k}} \\rangle$ is the Berry connection, and $|\\psi_{n\\mathbf{k}}\\rangle = e^{i\\mathbf{k}\\cdot\\mathbf{r}}|u_{n\\mathbf{k}}\\rangle$. The states $|\\psi_{n\\mathbf{k}}\\rangle$ are the smooth Bloch states from which the Wannier functions are constructed. In our case, $|\\psi_{n\\mathbf{k}}\\rangle = |\\tilde{\\phi}_{n}(\\mathbf{k})\\rangle$.\n\nIn a discrete BZ, this term is represented by a localization functional based on the matrix logarithm of the inter-$\\mathbf{k}$ overlap matrices $\\tilde{M}(\\mathbf{k}, \\mathbf{b})$. The finite difference representation for the sum of squared Berry connection matrix elements is given by:\n$$\n\\sum_{n=1}^{N} \\langle w_n | r^2 | w_n \\rangle = \\frac{1}{N_{\\mathbf{k}}} \\sum_{\\mathbf{k},\\mathbf{b}} w_{\\mathbf{b}} \\mathrm{Tr}\\left[ \\left(\\log \\tilde{M}(\\mathbf{k},\\mathbf{b})\\right)^\\dagger \\log \\tilde{M}(\\mathbf{k},\\mathbf{b}) \\right]\n$$\nwhere $\\log$ denotes the matrix logarithm. The properties of the weights $\\{w_{\\mathbf{b}}\\}$ ensure this corresponds to the correct continuum limit.\n\n**2. Sum of Squared Wannier Centers $\\sum_n |\\bar{\\mathbf{r}}_n|^2$**\n\nThe Wannier center $\\bar{\\mathbf{r}}_n$ is the expectation value of the position operator in the Wannier state $|w_n\\rangle$. In k-space, this is the BZ average of the diagonal a of the Berry connection:\n$$\n\\bar{\\mathbf{r}}_n = \\frac{1}{N_{\\mathbf{k}}} \\sum_{\\mathbf{k}} \\mathbf{A}_{nn}(\\mathbf{k})\n$$\nThe vector $\\mathbf{A}_{nn}(\\mathbf{k})$ can be obtained from the phases of the diagonal elements of the overlap matrices $\\tilde{M}(\\mathbf{k},\\mathbf{b})$. For a small displacement $\\mathbf{b}$, we have $\\mathbf{b}\\cdot\\mathbf{A}_{nn}(\\mathbf{k}) \\approx \\text{Im} \\ln \\tilde{M}_{nn}(\\mathbf{k},\\mathbf{b}) = \\arg(\\tilde{M}_{nn}(\\mathbf{k},\\mathbf{b}))$. Using the property $\\sum_{\\mathbf{b}} w_{\\mathbf{b}} b_\\mu b_\\nu = \\delta_{\\mu\\nu}$, we can project out the Cartesian components of $\\mathbf{A}_{nn}(\\mathbf{k})$:\n$$\nA_{nn,\\mu}(\\mathbf{k}) = \\sum_{\\nu} \\delta_{\\mu\\nu} A_{nn,\\nu}(\\mathbf{k}) = \\sum_{\\nu} \\left(\\sum_{\\mathbf{b}} w_{\\mathbf{b}} b_\\mu b_\\nu\\right) A_{nn,\\nu}(\\mathbf{k}) = \\sum_{\\mathbf{b}} w_{\\mathbf{b}} b_\\mu (\\mathbf{b}\\cdot\\mathbf{A}_{nn}(\\mathbf{k}))\n$$\nSubstituting the phase approximation, we get the discrete representation for the Berry connection vector:\n$$\n\\mathbf{A}_{nn}(\\mathbf{k}) \\approx \\sum_{\\mathbf{b}} w_{\\mathbf{b}} \\mathbf{b} \\, \\text{Im}\\ln \\left( \\tilde{M}_{nn}(\\mathbf{k},\\mathbf{b}) \\right)\n$$\nTherefore, the Wannier center is:\n$$\n\\bar{\\mathbf{r}}_n = \\frac{1}{N_{\\mathbf{k}}} \\sum_{\\mathbf{k}} \\sum_{\\mathbf{b}} w_{\\mathbf{b}} \\mathbf{b} \\, \\text{Im}\\ln \\left( \\tilde{M}_{nn}(\\mathbf{k},\\mathbf{b}) \\right)\n$$\nThe sum of their squares is:\n$$\n\\sum_{n=1}^{N} |\\bar{\\mathbf{r}}_n|^2 = \\sum_{n=1}^{N} \\left| \\frac{1}{N_{\\mathbf{k}}} \\sum_{\\mathbf{k},\\mathbf{b}} w_{\\mathbf{b}} \\mathbf{b} \\, \\text{Im}\\ln \\left( \\tilde{M}_{nn}(\\mathbf{k},\\mathbf{b}) \\right) \\right|^2\n$$\n\n**3. Final Expression in Terms of $S$ and $M^{(0)}$**\n\nWe combine the expressions for the two terms and substitute the definition of $\\tilde{M}(\\mathbf{k},\\mathbf{b})$. The Löwdin-orthogonalized overlap matrix $\\tilde{M}(\\mathbf{k},\\mathbf{b})$ is related to the raw overlap matrix $M^{(0)}(\\mathbf{k},\\mathbf{b})$ via the Löwdin transformation:\n$$\n|\\tilde{\\phi}_{m}(\\mathbf{k})\\rangle = \\sum_{p} |\\phi_{p}(\\mathbf{k})\\rangle [S(\\mathbf{k})^{-1/2}]_{pm}\n$$\n$$\n\\langle\\tilde{\\phi}_{m}(\\mathbf{k})| = \\sum_{p} \\langle\\phi_{p}(\\mathbf{k})| [S(\\mathbf{k})^{-1/2}]_{mp} \\quad \\text{(since } S^{-1/2} \\text{ is Hermitian)}\n$$\nThus,\n$$\n\\tilde{M}_{mn}(\\mathbf{k},\\mathbf{b}) = \\langle\\tilde{\\phi}_{m}(\\mathbf{k})|\\tilde{\\phi}_{n}(\\mathbf{k}+\\mathbf{b})\\rangle = \\sum_{p,q} [S(\\mathbf{k})^{-1/2}]_{mp} \\langle\\phi_{p}(\\mathbf{k})|\\phi_{q}(\\mathbf{k}+\\mathbf{b})\\rangle [S(\\mathbf{k}+\\mathbf{b})^{-1/2}]_{qn}\n$$\nIn matrix notation, this is:\n$$\n\\tilde{M}(\\mathbf{k},\\mathbf{b}) = S(\\mathbf{k})^{-1/2} M^{(0)}(\\mathbf{k},\\mathbf{b}) S(\\mathbf{k}+\\mathbf{b})^{-1/2}\n$$\nSubstituting this into our expressions for the spread functional components yields the final expression for $\\Omega$.\n\nThe complete quadratic spread functional $\\Omega$ is:\n$$\n\\Omega = \\frac{1}{N_{\\mathbf{k}}} \\sum_{\\mathbf{k},\\mathbf{b}} w_{\\mathbf{b}} \\mathrm{Tr}\\left[ \\left(\\log \\tilde{M}(\\mathbf{k},\\mathbf{b})\\right)^\\dagger \\log \\tilde{M}(\\mathbf{k},\\mathbf{b}) \\right] - \\sum_{n=1}^{N} \\left| \\frac{1}{N_{\\mathbf{k}}} \\sum_{\\mathbf{k},\\mathbf{b}} w_{\\mathbf{b}} \\mathbf{b} \\, \\text{Im}\\ln \\left( \\tilde{M}_{nn}(\\mathbf{k},\\mathbf{b}) \\right) \\right|^2\n$$\nwhere $\\tilde{M}(\\mathbf{k},\\mathbf{b}) = S(\\mathbf{k})^{-1/2} M^{(0)}(\\mathbf{k},\\mathbf{b}) S(\\mathbf{k}+\\mathbf{b})^{-1/2}$. This is the required single, closed-form analytical expression meeting all the problem's criteria.", "answer": "$$\n\\boxed{\\frac{1}{N_{\\mathbf{k}}} \\sum_{\\mathbf{k},\\mathbf{b}} w_{\\mathbf{b}} \\mathrm{Tr}\\left[ \\left(\\log \\tilde{M}(\\mathbf{k},\\mathbf{b})\\right)^\\dagger \\log \\tilde{M}(\\mathbf{k},\\mathbf{b}) \\right] - \\sum_{n=1}^{N} \\left| \\frac{1}{N_{\\mathbf{k}}} \\sum_{\\mathbf{k},\\mathbf{b}} w_{\\mathbf{b}} \\mathbf{b} \\, \\text{Im}\\ln \\left( \\tilde{M}_{nn}(\\mathbf{k},\\mathbf{b}) \\right) \\right|^2 \\quad \\text{where} \\quad \\tilde{M}(\\mathbf{k},\\mathbf{b}) = S(\\mathbf{k})^{-1/2} M^{(0)}(\\mathbf{k},\\mathbf{b}) S(\\mathbf{k}+\\mathbf{b})^{-1/2}}\n$$", "id": "3502300"}, {"introduction": "Moving from theory to computation, this practice provides a direct, hands-on implementation of the Wannierization process for a simple tight-binding model. The quality and utility of the final Wannier functions are critically sensitive to the initial guess of localized trial orbitals, a crucial step in any practical calculation. In this exercise [@problem_id:3502323], you will quantify this dependence by comparing a well-chosen set of atomic-like projections with a less optimal, mixed set, using standard metrics for localization (spread) and Hamiltonian interpolation accuracy.", "problem": "Consider a one-dimensional crystalline lattice with lattice constant $a$ and two orthonormal atomic-like orbitals per unit cell, denoted by $|s\\rangle$ and $|p\\rangle$. Assume a tight-binding description in which the Bloch Hamiltonian $H(k)$ acting in the orbital basis $\\{|s\\rangle,|p\\rangle\\}$ is defined, for crystal momentum $k$ (in radians) in the Brillouin zone $[-\\pi,\\pi)$, by the $2\\times 2$ Hermitian matrix\n$$\nH(k) \\;=\\;\n\\begin{pmatrix}\n\\varepsilon_s + 2 t_s \\cos(k a) & 2 t_{sp} \\, i \\sin(k a) \\\\\n- 2 t_{sp} \\, i \\sin(k a) & \\varepsilon_p + 2 t_p \\cos(k a)\n\\end{pmatrix},\n$$\nwhere $a$ is normalized to $a=1$ in this problem. Use the parameter set\n$$\n\\varepsilon_s = 0,\\quad \\varepsilon_p = 1.5,\\quad t_s = -1.0,\\quad t_p = -0.2,\\quad t_{sp} = 0.4.\n$$\nBy Bloch's theorem and standard linear algebra, for each $k$ there exist $2$ orthonormal eigenvectors $|\\psi_{k,1}\\rangle$ and $|\\psi_{k,2}\\rangle$ of $H(k)$ with corresponding eigenvalues $E_1(k)$ and $E_2(k)$.\n\nMaximally Localized Wannier Functions (MLWF) are constructed by selecting a smooth gauge for the cell-periodic Bloch functions and Fourier transforming them to real space. In practical computation, a common initialization is given by projecting the Bloch eigenstates onto user-defined trial orbitals and performing Löwdin orthonormalization of the resulting projections to obtain a smooth $k$-dependent unitary gauge. The choice of initial trial orbitals affects the smoothness of this gauge, the spatial localization (spread) of the resulting Wannier functions, and the locality of the Hamiltonian in the Wannier basis, which controls interpolation errors when truncating real-space hopping ranges.\n\nYour task is to implement, from first principles, the following pipeline and to compute quantitative diagnostics for different choices of trial orbitals.\n\nFundamental base and definitions to be used:\n- Use Bloch's theorem to diagonalize $H(k)$ and obtain $E_n(k)$ and $|\\psi_{k,n}\\rangle$.\n- Given trial orbitals $\\{|g_m\\rangle\\}_{m=1}^{N_w}$ (with $N_w=2$), define the projection matrix at each $k$ by the entries $A_{n m}(k) = \\langle \\psi_{k,n} | g_m \\rangle$.\n- Define the Löwdin-orthonormalized gauge mixer $U(k)$ of shape $2\\times 2$ by $U(k) = A(k)\\, [A(k)^\\dagger A(k)]^{-1/2}$, where $[\\,\\cdot\\,]^{-1/2}$ denotes the Hermitian inverse square root.\n- The Wannier-gauge cell-periodic Bloch functions are the columns of $|u_{k}^{(m)}\\rangle = \\sum_{n=1}^{2} |\\psi_{k,n}\\rangle \\, U_{n m}(k)$ for $m=1,2$.\n- Define the nearest-neighbor-in-$k$ overlap matrix between adjacent $k$-points on a uniform mesh by $M_{m n}(k) = \\langle u_{k}^{(m)} | u_{k+\\Delta k}^{(n)} \\rangle$ with periodic boundary conditions in $k$.\n- As a quantitative spread measure in one dimension, use the discretized total spread\n$$\n\\Omega \\;=\\; \\sum_{k} \\left[ \\sum_{n=1}^{2} \\left( 1 - |M_{n n}(k)|^2 \\right) \\;+\\; \\sum_{\\substack{m,n=1 \\\\ m\\neq n}}^{2} |M_{m n}(k)|^2 \\right],\n$$\nwhich is dimensionless in units of $a^2$ given $a=1$.\n- The Wannier-gauge Hamiltonian at each $k$ is $H_W(k) = U(k)^\\dagger \\, \\mathrm{diag}(E_1(k), E_2(k)) \\, U(k)$.\n- Define real-space hopping matrices by the discrete Fourier transform $h(R) = \\frac{1}{N_k} \\sum_{j=0}^{N_k-1} H_W(k_j) \\, e^{-i k_j R}$, where $\\{k_j\\}$ is a uniform mesh in $[-\\pi,\\pi)$ of $N_k$ points and $R$ is an integer lattice vector (in units of $a$).\n- For a truncation radius $R_{\\max}$, define the truncated-interpolation Hamiltonian $H_{\\mathrm{interp}}(k) = \\sum_{R=-R_{\\max}}^{R_{\\max}} h(R) \\, e^{i k R}$.\n- Quantify the band interpolation error by\n$$\n\\Delta_{\\mathrm{MAE}} \\;=\\; \\frac{1}{2 N_k} \\sum_{j=0}^{N_k-1} \\sum_{n=1}^{2} \\left| E_n(k_j) - \\widetilde{E}_n(k_j) \\right|,\n$$\nwhere $\\{\\widetilde{E}_n(k_j)\\}$ are the eigenvalues of $H_{\\mathrm{interp}}(k_j)$ sorted in ascending order, and $E_n(k_j)$ are the original eigenvalues of $H(k_j)$ sorted in ascending order. Express angles in radians and treat $a=1$, so that $\\Omega$ is dimensionless and $\\Delta_{\\mathrm{MAE}}$ is in energy units consistent with the parameters above.\n\nImplement this pipeline and evaluate the following test suite, which explores the effect of the choice of trial orbitals and truncation:\n\n- Test case $1$ (happy path): Trial set $\\mathrm{A}$ with $|g_1\\rangle = |s\\rangle$ and $|g_2\\rangle = |p\\rangle$, uniform mesh with $N_k = 201$, truncation radius $R_{\\max} = 1$.\n- Test case $2$ (comparative poor projections): Trial set $\\mathrm{B}$ with $|g_1\\rangle = \\frac{1}{\\sqrt{2}}(|s\\rangle + i\\,|p\\rangle)$ and $|g_2\\rangle = \\frac{1}{\\sqrt{2}}(|s\\rangle - i\\,|p\\rangle)$, uniform mesh with $N_k = 201$, truncation radius $R_{\\max} = 1$.\n- Test case $3$ (boundary truncation): Trial set $\\mathrm{A}$ with $N_k = 201$, truncation radius $R_{\\max} = 0$.\n\nYour program must:\n- Construct $H(k)$, diagonalize it on the specified mesh, form the projection matrices and $U(k)$ via Löwdin orthonormalization for each test case, compute the spread $\\Omega$, form $H_W(k)$, compute $h(R)$, reconstruct $H_{\\mathrm{interp}}(k)$ with the specified $R_{\\max}$, and compute $\\Delta_{\\mathrm{MAE}}$.\n- Produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each test case contributes a list of two floating-point numbers $[\\Omega,\\Delta_{\\mathrm{MAE}}]$ rounded to six decimal places. The final format must be\n$$\n\\text{[[$\\Omega_1$,$\\Delta_{\\mathrm{MAE},1}$],[$\\Omega_2$,$\\Delta_{\\mathrm{MAE},2}$],[$\\Omega_3$,$\\Delta_{\\mathrm{MAE},3}$]]}.\n$$\nAll angles are in radians, and report $\\Omega$ (dimensionless in units of $a^2$) and $\\Delta_{\\mathrm{MAE}}$ (in energy units matching the tight-binding parameters).", "solution": "The problem statement is evaluated to be valid. It is scientifically grounded in the principles of condensed matter physics and computational materials science, specifically tight-binding theory and the construction of Wannier functions. The problem is well-posed, providing a complete and unambiguous set of definitions, parameters, and computational steps required to arrive at a unique numerical solution. The language is objective and precise. Therefore, we proceed with the solution.\n\nThe core of the problem is to implement a numerical pipeline that simulates the initial steps of constructing Maximally Localized Wannier Functions (MLWFs) and to evaluate the quality of different initial projections based on quantitative metrics for localization (spread) and Hamiltonian interpolation accuracy.\n\nThe one-dimensional tight-binding Hamiltonian is given as a $2 \\times 2$ matrix for each crystal momentum $k$ in the first Brillouin zone $[-\\pi, \\pi)$:\n$$\nH(k) =\n\\begin{pmatrix}\n\\varepsilon_s + 2 t_s \\cos(k a) & 2 t_{sp} \\, i \\sin(k a) \\\\\n- 2 t_{sp} \\, i \\sin(k a) & \\varepsilon_p + 2 t_p \\cos(k a)\n\\end{pmatrix}\n$$\nThe parameters are provided as $\\varepsilon_s = 0$, $\\varepsilon_p = 1.5$, $t_s = -1.0$, $t_p = -0.2$, $t_{sp} = 0.4$, and the lattice constant is normalized to $a=1$. The calculations are performed on a uniform discrete mesh of $N_k$ points, $\\{k_j\\}_{j=0}^{N_k-1}$, covering the Brillouin zone.\n\nFor each of the three specified test cases, the following computational procedure is executed:\n\n1.  **Bloch Eigenstate Calculation**: For each $k_j$ on the mesh, the Hermitian Hamiltonian matrix $H(k_j)$ is constructed and numerically diagonalized. This yields two real eigenvalues, $E_n(k_j)$, sorted in ascending order ($n=1, 2$), and a set of corresponding orthonormal eigenvectors, $|\\psi_{k_j,n}\\rangle$. The eigenvectors for a given $k_j$ form the columns of a $2 \\times 2$ unitary matrix $V(k_j)$.\n\n2.  **Projection and Orthonormalization**: A set of two trial orbitals, $\\{|g_m\\rangle\\}_{m=1}^2$, is chosen. These are represented as column vectors in the atomic orbital basis $\\{|s\\rangle, |p\\rangle\\}$. The projection of the Bloch eigenstates onto these trial orbitals is captured by the matrix $A(k_j)$ with entries $A_{nm}(k_j) = \\langle \\psi_{k_j,n} | g_m \\rangle$. If $G$ is the matrix whose columns are the vectors $|g_m\\rangle$, then $A(k_j) = V(k_j)^\\dagger G$.\n    To obtain a smooth, unitary gauge across the Brillouin zone, this projection matrix is subjected to Löwdin orthonormalization, yielding the $k$-dependent unitary gauge-mixing matrix:\n    $$\n    U(k_j) = A(k_j) \\left[A(k_j)^\\dagger A(k_j)\\right]^{-1/2}\n    $$\n    The matrix inverse square root $[ \\cdot ]^{-1/2}$ is computed for the $2 \\times 2$ positive-definite Hermitian matrix $A^\\dagger A$ using standard numerical linear algebra routines.\n\n3.  **Spread Calculation ($\\Omega$)**: The Wannier-gauge cell-periodic Bloch functions are $|u_{k_j}^{(m)}\\rangle = \\sum_{n=1}^2 |\\psi_{k_j,n}\\rangle U_{nm}(k_j)$. To assess the smoothness of this gauge, we compute the nearest-neighbor overlap matrices $M(k_j) = \\langle u_{k_j}^{(m)} | u_{k_j+\\Delta k}^{(n)} \\rangle$. The total spread functional $\\Omega$ is then calculated by summing a specific combination of the elements of these overlap matrices over all $k_j$ in the mesh:\n    $$\n    \\Omega = \\sum_{j=0}^{N_k-1} \\left[ \\sum_{n=1}^{2} \\left( 1 - |M_{nn}(k_j)|^2 \\right) + \\sum_{\\substack{m,n=1 \\\\ m\\neq n}}^{2} |M_{mn}(k_j)|^2 \\right]\n    $$\n    A smaller $\\Omega$ indicates a smoother gauge, which corresponds to more localized Wannier functions in real space.\n\n4.  **Interpolation Error Calculation ($\\Delta_{\\mathrm{MAE}}$)**: The quality of the Wannier representation for interpolating the Hamiltonian is assessed. First, the Hamiltonian is transformed into the Wannier gauge at each $k_j$:\n    $$\n    H_W(k_j) = U(k_j)^\\dagger \\, \\mathrm{diag}(E_1(k_j), E_2(k_j)) \\, U(k_j)\n    $$\n    Next, the real-space hopping matrices $h(R)$ are computed via a discrete inverse Fourier transform over the Brillouin zone:\n    $$\n    h(R) = \\frac{1}{N_k} \\sum_{j=0}^{N_k-1} H_W(k_j) e^{-i k_j R}\n    $$\n    where $R$ is an integer lattice site index. This transform is truncated at a specified radius $R_{\\max}$. The Hamiltonian is then reconstructed (interpolated) at each $k_j$ using the truncated set of hoppings:\n    $$\n    H_{\\mathrm{interp}}(k_j) = \\sum_{R=-R_{\\max}}^{R_{\\max}} h(R) e^{i k_j R}\n    $$\n    Finally, the band interpolation error, $\\Delta_{\\mathrm{MAE}}$, is computed as the mean absolute error between the eigenvalues of the original Hamiltonian, $E_n(k_j)$, and the eigenvalues of the interpolated Hamiltonian, $\\widetilde{E}_n(k_j)$:\n    $$\n    \\Delta_{\\mathrm{MAE}} = \\frac{1}{2 N_k} \\sum_{j=0}^{N_k-1} \\sum_{n=1}^{2} \\left| E_n(k_j) - \\widetilde{E}_n(k_j) \\right|\n    $$\n\nThe three test cases are evaluated as follows:\n-   **Test Case 1**: Trial orbitals are the atomic basis functions, $|g_1\\rangle=|s\\rangle$ and $|g_2\\rangle=|p\\rangle$. Here, $G$ is the identity matrix. The truncation radius is $R_{\\max} = 1$. This represents a standard 'good' choice.\n-   **Test Case 2**: Trial orbitals are a mixture of the atomic basis functions, $|g_1\\rangle = \\frac{1}{\\sqrt{2}}(|s\\rangle + i|p\\rangle)$ and $|g_2\\rangle = \\frac{1}{\\sqrt{2}}(|s\\rangle - i|p\\rangle)$. This case tests the sensitivity of the procedure to the initial projection. $R_{\\max} = 1$.\n-   **Test Case 3**: Same trial orbitals as Case 1, but with a severe truncation radius $R_{\\max} = 0$, meaning only the on-site part of the real-space Hamiltonian is retained for interpolation.\n\nThe provided Python code implements this entire pipeline, calculating the pair of metrics $[\\Omega, \\Delta_{\\mathrm{MAE}}]$ for each of the three cases.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import sqrtm, inv, eigh\n\ndef solve():\n    \"\"\"\n    Main function to run the Wannier function analysis for all test cases.\n    \"\"\"\n\n    def solve_case(trial_G, N_k, R_max):\n        \"\"\"\n        Implements the full pipeline for a single test case.\n\n        Args:\n            trial_G (np.ndarray): 2x2 matrix with trial orbitals as columns.\n            N_k (int): Number of k-points in the mesh.\n            R_max (int): Truncation radius for real-space hopping.\n\n        Returns:\n            list: A list containing [Omega, Delta_MAE].\n        \"\"\"\n        # Define constants from the problem statement\n        eps_s = 0.0\n        eps_p = 1.5\n        t_s = -1.0\n        t_p = -0.2\n        t_sp = 0.4\n        a = 1.0\n\n        # 1. Setup k-mesh\n        k_mesh = np.linspace(-np.pi, np.pi, N_k, endpoint=False)\n        \n        # Lists to store k-dependent quantities\n        E_k_list = []  # Eigenvalues of H(k)\n        V_k_list = []  # Eigenvectors of H(k)\n        U_k_list = []  # Unitary gauge mixer\n\n        # 2. Loop over k to diagonalize H(k) and compute U(k)\n        for k in k_mesh:\n            # Construct H(k)\n            H_k = np.array([\n                [eps_s + 2 * t_s * np.cos(k * a), 2 * t_sp * 1j * np.sin(k * a)],\n                [-2 * t_sp * 1j * np.sin(k * a), eps_p + 2 * t_p * np.cos(k * a)]\n            ], dtype=np.complex128)\n\n            # Diagonalize H(k) using eigh for Hermitian matrices\n            E, V = eigh(H_k)\n            E_k_list.append(E)\n            V_k_list.append(V)\n\n            # Construct projection matrix A(k) = V(k)^dagger @ G\n            A_k = V.conj().T @ trial_G\n            \n            # Löwdin orthonormalization to get U(k)\n            # U(k) = A(k) * [A(k)^dagger A(k)]^(-1/2)\n            A_dagger_A = A_k.conj().T @ A_k\n            # The matrix sqrtm requires its argument to be square.\n            # inv(sqrtm(X)) is a way to compute X**(-1/2)\n            A_dagger_A_inv_sqrt = inv(sqrtm(A_dagger_A))\n            U_k = A_k @ A_dagger_A_inv_sqrt\n            U_k_list.append(U_k)\n\n        # 3. Compute spread Omega\n        omega_sum = 0.0\n        for i in range(N_k):\n            # Wannier-gauge functions u_k = V_k @ U_k\n            u_k = V_k_list[i] @ U_k_list[i]\n            \n            # Next k-point with periodic boundary conditions\n            i_plus_1 = (i + 1) % N_k\n            u_k_plus_dk = V_k_list[i_plus_1] @ U_k_list[i_plus_1]\n            \n            # Overlap matrix M(k) = <u_k|u_{k+dk}> = u_k^dagger @ u_{k+dk}\n            M_k = u_k.conj().T @ u_k_plus_dk\n            \n            # Add to spread sum according to the formula\n            term = (1.0 - np.abs(M_k[0, 0])**2) + (1.0 - np.abs(M_k[1, 1])**2) + \\\n                   np.abs(M_k[0, 1])**2 + np.abs(M_k[1, 0])**2\n            omega_sum += term\n        \n        Omega = omega_sum\n\n        # 4. Compute interpolation error Delta_MAE\n        # Calculate Wannier Hamiltonian H_W(k) for all k\n        H_W_k_list = []\n        for i in range(N_k):\n            E_diag = np.diag(E_k_list[i])\n            U_k = U_k_list[i]\n            H_W_k = U_k.conj().T @ E_diag @ U_k\n            H_W_k_list.append(H_W_k)\n        \n        # Calculate real-space hopping matrices h(R) via inverse DFT\n        h_R = {}\n        R_values = range(-R_max, R_max + 1)\n        for R in R_values:\n            h_R_val = np.zeros((2, 2), dtype=np.complex128)\n            for i in range(N_k):\n                k = k_mesh[i]\n                h_R_val += H_W_k_list[i] * np.exp(-1j * k * R)\n            h_R[R] = h_R_val / N_k\n\n        # Calculate interpolated Hamiltonian H_interp(k) and MAE\n        mae_sum = 0.0\n        for i in range(N_k):\n            k = k_mesh[i]\n            H_interp_k = np.zeros((2, 2), dtype=np.complex128)\n            for R in R_values:\n                H_interp_k += h_R[R] * np.exp(1j * k * R)\n            \n            # Eigenvalues of H_interp(k)\n            E_tilde, _ = eigh(H_interp_k)\n            \n            # Original eigenvalues\n            E_orig = E_k_list[i]\n            \n            # Accumulate absolute error\n            mae_sum += np.sum(np.abs(E_orig - E_tilde))\n\n        Delta_MAE = mae_sum / (2.0 * N_k)\n\n        return [Omega, Delta_MAE]\n\n    # Define test cases from the problem statement.\n    test_cases = [\n        # Case 1: Trial set A, N_k = 201, R_max = 1\n        {'G': np.identity(2, dtype=np.complex128), 'N_k': 201, 'R_max': 1},\n        # Case 2: Trial set B, N_k = 201, R_max = 1\n        {'G': (1/np.sqrt(2)) * np.array([[1, 1], [1j, -1j]], dtype=np.complex128), 'N_k': 201, 'R_max': 1},\n        # Case 3: Trial set A, N_k = 201, R_max = 0\n        {'G': np.identity(2, dtype=np.complex128), 'N_k': 201, 'R_max': 0}\n    ]\n\n    results = []\n    for case in test_cases:\n        result = solve_case(case['G'], case['N_k'], case['R_max'])\n        results.append(result)\n\n    # Format the final output string exactly as specified.\n    formatted_results = []\n    for omega, delta_mae in results:\n        formatted_results.append(f\"[{omega:.6f},{delta_mae:.6f}]\")\n    \n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "3502323"}, {"introduction": "One of the most powerful applications of Wannier functions is in describing the electronic structure of metals, where bands are often entangled and cannot be separated into an isolated group. This advanced practice confronts this challenge directly by implementing the 'disentanglement' procedure. You will explore the stability of the resulting subspace with respect to the initial projections by calculating a 'spillage' metric [@problem_id:3502336], and then implement an adaptive refinement of the energy window to stabilize the procedure, mirroring the sophisticated algorithms used in state-of-the-art computational codes.", "problem": "You are given a computational task to quantify and control the stability of subspace disentanglement for a metallic tight-binding model by monitoring the “spillage” between subspaces obtained from two different sets of initial localized projections, and to implement an adaptive criterion to refine the inner energy window when instability is detected. The derivation and algorithm must begin from the following fundamental bases: the definition of orthogonal projectors onto subspaces, orthonormality of Bloch eigenstates as guaranteed by quantum mechanics, and standard linear algebra characterizations of distances between subspaces.\n\nConsider a one-dimensional tight-binding model with $2$ orbitals per unit cell. For crystal momentum $k$ in the Brillouin zone (BZ), the Hamiltonian is a $2 \\times 2$ Hermitian matrix\n$$\nH(k) \\equiv\n\\begin{pmatrix}\n\\varepsilon_{a} + 2 t_{a} \\cos k & V_{0} + 2 t_{ab} \\cos k \\\\\nV_{0} + 2 t_{ab} \\cos k & \\varepsilon_{b} + 2 t_{b} \\cos k\n\\end{pmatrix},\n$$\nwith fixed parameters $\\varepsilon_{a} = -0.3$, $t_{a} = 1.0$, $\\varepsilon_{b} = 0.2$, $t_{b} = -0.7$, $V_{0} = 0.6$, $t_{ab} = 0.2$, all in dimensionless tight-binding units. Let $E_{\\mathrm{F}} = 0.0$ be the Fermi level. The Brillouin zone is sampled on a uniform grid of $N_{k} = 51$ points, $k_{j}$ equally spaced over $[-\\pi,\\pi]$, with angles measured in radians.\n\nAt each $k_{j}$, let $\\{ \\lvert \\psi_{n}(k_{j}) \\rangle \\}_{n=1}^{2}$ denote the orthonormal eigenvectors of $H(k_{j})$ with corresponding eigenvalues $\\{ E_{n}(k_{j}) \\}_{n=1}^{2}$. For a prescribed inner energy window half-width $w > 0$, define the initial inner-window band index set at $k_{j}$ by selecting all band indices $n$ such that $\\lvert E_{n}(k_{j}) - E_{\\mathrm{F}} \\rvert \\le w$. If this set is empty, select instead the single index $n$ that minimizes $\\lvert E_{n}(k_{j}) - E_{\\mathrm{F}} \\rvert$. Fix the target number of Wannier functions per unit cell to be $M = 1$.\n\nTwo different initial localized projectors are given as column vectors in the orbital basis (of length $2$): the first is $g_{1} = (1, 0)^{\\top}$; the second is $g_{2}(\\alpha) = (\\cos \\alpha, \\sin \\alpha)^{\\top}$, where $\\alpha$ is a specified angle in radians. For each $k_{j}$ and for each initial projector $g_{i}$, construct the disentangled $M$-dimensional subspace inside the span of the eigenstates selected by the inner window at that $k_{j}$, by maximizing the overlap with the span of $g_{i}$ subject to orthonormality, using only the orthonormality of the Bloch eigenvectors, properties of orthogonal projectors, and well-established linear algebra. Denote by $P_{i}(k_{j})$ the orthogonal projector onto the resulting disentangled subspace at $k_{j}$ for $i \\in \\{1,2\\}$.\n\nDefine the normalized subspace spillage at $k_{j}$ between the two disentangled subspaces as a scalar in $[0,1]$ that vanishes if and only if the two subspaces coincide and increases with their mismatch, constructed from first principles using orthogonal projectors and principal angles between subspaces. The $k$-averaged spillage is the arithmetic mean over the $N_{k}$ points.\n\nAdaptive refinement criterion: Given a spillage tolerance $\\tau > 0$ and a nonnegative integer cap on additions $c$, monitor the spillage at each $k_{j}$. If the spillage at $k_{j}$ exceeds $\\tau$, adaptively enlarge the inner energy window at $k_{j}$ by adding the energetically closest excluded band index (that is, the band index not currently in the inner window whose $\\lvert E_{n}(k_{j}) - E_{\\mathrm{F}} \\rvert$ is minimal), thereby increasing the set of bands available for subspace selection at that $k_{j}$. Recompute the disentangled subspaces and the spillage at $k_{j}$ after each addition. Repeat until either the spillage at $k_{j}$ falls below $\\tau$ or the number of additions at that $k_{j}$ reaches $c$, or all bands are included.\n\nYour program must implement the following steps purely numerically for the specified model and test suite, without using any external data:\n\n- Construct $H(k)$ at each $k_{j}$ using the given parameters and diagonalize to obtain $E_{n}(k_{j})$ and $\\lvert \\psi_{n}(k_{j}) \\rangle$.\n- For each test case, for each $k_{j}$, build the inner-window set as prescribed and construct disentangled projectors $P_{1}(k_{j})$ and $P_{2}(k_{j})$ for $M = 1$ from the two initial projectors, using first principles of orthogonal projectors and overlap maximization within the inner window.\n- Compute the normalized spillage at each $k_{j}$ and its average over the Brillouin zone.\n- Apply the adaptive refinement criterion independently at each $k_{j}$ with the given tolerance and cap, and report the final $k$-averaged spillage after refinement.\n\nTest suite and parameters to be used:\n\n- Common model parameters: $\\varepsilon_{a} = -0.3$, $t_{a} = 1.0$, $\\varepsilon_{b} = 0.2$, $t_{b} = -0.7$, $V_{0} = 0.6$, $t_{ab} = 0.2$, $E_{\\mathrm{F}} = 0.0$, $N_{k} = 51$.\n- Target subspace dimension: $M = 1$.\n- Initial projector $g_{1} = (1, 0)^{\\top}$ and $g_{2}(\\alpha) = (\\cos \\alpha, \\sin \\alpha)^{\\top}$.\n\nProvide four test cases, each defined by a tuple $(\\alpha, w, \\tau, c)$:\n- Case $1$: $\\alpha = 0.2$, $w = 1.5$, $\\tau = 0.01$, $c = 0$.\n- Case $2$: $\\alpha = 1.5707963267948966$, $w = 0.2$, $\\tau = 0.2$, $c = 1$.\n- Case $3$: $\\alpha = 1.3$, $w = 0.05$, $\\tau = 0.05$, $c = 0$.\n- Case $4$: $\\alpha = 0.4$, $w = 0.6$, $\\tau = 0.00001$, $c = 2$.\n\nYour program should produce a single line of output containing the final $k$-averaged spillage for each test case, after adaptive refinement completes, as a comma-separated list enclosed in square brackets. Each value must be rounded to six decimal places. For example, an output with three hypothetical results must look like $[\\text{r}_{1},\\text{r}_{2},\\text{r}_{3}]$ with each $\\text{r}_{i}$ shown with six digits after the decimal point. All angles must be in radians, and all quantities are dimensionless.", "solution": "The problem is validated as scientifically grounded, well-posed, and objective. All parameters and procedures are specified sufficiently to construct a unique, stable, and meaningful numerical solution. The physical and mathematical concepts invoked—tight-binding Hamiltonians, Bloch's theorem, subspace projections, and principal angles—are standard in computational solid-state physics. We proceed to a solution.\n\nThe core task is to implement a numerical procedure for subspace disentanglement and to quantify its stability with respect to the choice of initial projections. The method follows the principles established for constructing maximally localized Wannier functions, specialized here for a target subspace dimension of $M=1$.\n\nFirst, we establish the physical model and its properties. The system is a one-dimensional tight-binding model with $2$ orbitals per site. The crystal momentum-dependent Hamiltonian $H(k)$ is a $2 \\times 2$ Hermitian matrix defined as:\n$$\nH(k) =\n\\begin{pmatrix}\n\\varepsilon_{a} + 2 t_{a} \\cos k & V_{0} + 2 t_{ab} \\cos k \\\\\nV_{0} + 2 t_{ab} \\cos k & \\varepsilon_{b} + 2 t_{b} \\cos k\n\\end{pmatrix}\n$$\nThe parameters are given as $\\varepsilon_{a} = -0.3$, $t_{a} = 1.0$, $\\varepsilon_{b} = 0.2$, $t_{b} = -0.7$, $V_{0} = 0.6$, and $t_{ab} = 0.2$. The problem is solved on a discrete grid of $N_{k} = 51$ crystal momentum points $k_{j}$ uniformly spaced in the first Brillouin zone $[-\\pi, \\pi]$. For each $k_j$, we solve the time-independent Schrödinger equation $H(k_j) |\\psi_n(k_j)\\rangle = E_n(k_j) |\\psi_n(k_j)\\rangle$. This eigenvalue problem is solved numerically for $n \\in \\{1, 2\\}$, yielding the band energies $E_n(k_j)$ and the corresponding orthonormal Bloch eigenvectors $|\\psi_n(k_j)\\rangle$. The eigenvectors form a basis for the Hilbert space at each $k_j$.\n\nSecond, we define the subspace of interest. The Wannierization procedure for metals requires disentangling a target number of bands, $M$, from a larger set of bands within an \"inner\" energy window. For a given half-width $w > 0$ and Fermi level $E_{\\mathrm{F}} = 0.0$, the inner-window band-index set at $k_j$, denoted $\\mathcal{I}_{\\text{in}}(k_j)$, consists of all indices $n$ for which $|E_n(k_j) - E_{\\mathrm{F}}| \\le w$. If this set is empty, it is defined to contain the single band index that minimizes $|E_n(k_j) - E_{\\mathrm{F}}|$. The subspace spanned by the Bloch states corresponding to this index set is the \"inner-window subspace\", $\\mathcal{W}_{\\text{in}}(k_j) = \\text{span}\\{|\\psi_n(k_j)\\rangle\\}_{n \\in \\mathcal{I}_{\\text{in}}(k_j)}$. The orthogonal projector onto this subspace is $P_{\\text{in}}(k_j) = \\sum_{n \\in \\mathcal{I}_{\\text{in}}(k_j)} |\\psi_n(k_j)\\rangle \\langle\\psi_n(k_j)|$.\n\nThird, we perform the disentanglement. The goal is to identify an optimal $M$-dimensional subspace within $\\mathcal{W}_{\\text{in}}(k_j)$ that is as \"smooth\" as possible across the Brillouin zone. Smoothness is promoted by maximizing the overlap with a set of fixed trial localized orbitals. Here, the target dimension is $M=1$, and we consider two initial trial orbitals (projectors), $g_1 = (1, 0)^{\\top}$ and $g_2(\\alpha) = (\\cos \\alpha, \\sin \\alpha)^{\\top}$. For each trial orbital $g_i$, we seek a single normalized state $|\\phi_i(k_j)\\rangle \\in \\mathcal{W}_{\\text{in}}(k_j)$ that maximizes the overlap-squared $|\\langle g_i | \\phi_i(k_j) \\rangle|^2$. Since $|\\phi_i(k_j)\\rangle$ lies in $\\mathcal{W}_{\\text{in}}(k_j)$, it can be written as $|\\phi_i(k_j)\\rangle = P_{\\text{in}}(k_j) |\\phi_i(k_j)\\rangle$. By the properties of orthogonal projectors, the vector in $\\mathcal{W}_{\\text{in}}(k_j)$ with the largest projection onto $g_i$ is collinear with the projection of $g_i$ itself onto $\\mathcal{W}_{\\text{in}}(k_j)$. Thus, the optimal state is found by projecting $g_i$ onto the inner-window subspace and normalizing the result:\n$$\n|\\phi_i(k_j)\\rangle = \\frac{P_{\\text{in}}(k_j) |g_i\\rangle}{\\| P_{\\text{in}}(k_j) |g_i\\rangle \\|}\n$$\nThis state $|\\phi_i(k_j)\\rangle$ spans the disentangled $1$-dimensional subspace for the trial orbital $g_i$. The orthogonal projector onto this final subspace is $P_i(k_j) = |\\phi_i(k_j)\\rangle\\langle\\phi_i(k_j)|$.\n\nFourth, we quantify the discrepancy between the two subspaces obtained from $g_1$ and $g_2(\\alpha)$. The \"spillage\" is a measure of the distance between these two $1$-dimensional subspaces, spanned by $|\\phi_1(k_j)\\rangle$ and $|\\phi_2(k_j)\\rangle$, respectively. This distance is defined using the principal angle $\\theta$ between the subspaces, where $\\cos^2\\theta = |\\langle \\phi_1(k_j) | \\phi_2(k_j) \\rangle|^2$. A normalized spillage metric consistent with the problem's requirements is:\n$$\nS(k_j) = \\sin^2\\theta = 1 - |\\langle \\phi_1(k_j) | \\phi_2(k_j) \\rangle|^2\n$$\nThis value lies in $[0, 1]$, is $0$ if the subspaces are identical, and $1$ if they are orthogonal.\n\nFinally, we implement the adaptive refinement procedure. For each $k_j$, if the calculated spillage $S(k_j)$ exceeds a tolerance $\\tau$, the inner-window subspace $\\mathcal{W}_{\\text{in}}(k_j)$ is enlarged. This is done by adding the energetically closest band that was not already in $\\mathcal{I}_{\\text{in}}(k_j)$. The disentanglement and spillage calculation are repeated with the new, larger inner window. This process iterates until $S(k_j) \\le \\tau$, a cap $c$ on the number of band additions is reached, or all available bands are included in the window. The final spillage for each $k_j$ is the value obtained when this loop terminates. The overall figure of merit is the $k$-averaged spillage, $\\bar{S} = \\frac{1}{N_k} \\sum_{j=1}^{N_k} S(k_j)$.\n\nThe algorithm proceeds as follows for each test case $(\\alpha, w, \\tau, c)$:\n1. Loop over each $k_j$ in the Brillouin zone grid.\n2. Construct and diagonalize $H(k_j)$ to obtain eigenvalues $E_n(k_j)$ and eigenvectors $|\\psi_n(k_j)\\rangle$.\n3. Determine the initial inner-window index set $\\mathcal{I}_{\\text{in}}(k_j)$ based on $w$.\n4. Enter an adaptive loop:\n    a. Construct the matrix of inner-window eigenvectors $U_{\\text{in}}$ from the current index set.\n    b. Compute the disentangled vectors $|\\phi_1(k_j)\\rangle$ and $|\\phi_2(k_j)\\rangle$.\n    c. Calculate the spillage $S(k_j)$.\n    d. If $S(k_j) \\le \\tau$, or the addition cap $c$ is met, or all bands are included, exit the loop.\n    e. Otherwise, add the next available band to the index set and continue the loop.\n5. Store the final $S(k_j)$ for the current $k_j$.\n6. After iterating through all $k_j$, compute the average spillage. This procedure is repeated for all test cases.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test suite.\n    It orchestrates the calculation for each case and prints the final result.\n    \"\"\"\n\n    test_cases = [\n        # (alpha, w, tau, c)\n        (0.2, 1.5, 0.01, 0),\n        (1.5707963267948966, 0.2, 0.2, 1),\n        (1.3, 0.05, 0.05, 0),\n        (0.4, 0.6, 0.00001, 2),\n    ]\n\n    results = []\n    for case in test_cases:\n        alpha, w, tau, c = case\n        avg_spillage = calculate_refined_spillage(alpha, w, tau, c)\n        results.append(avg_spillage)\n\n    results_str = [f\"{r:.6f}\" for r in results]\n    print(f\"[{','.join(results_str)}]\")\n\n\ndef calculate_refined_spillage(alpha, w, tau, c):\n    \"\"\"\n    Calculates the k-averaged spillage for a single test case,\n    including the adaptive refinement procedure.\n\n    Args:\n        alpha (float): Angle for the second initial projector g2.\n        w (float): Half-width of the inner energy window.\n        tau (float): Spillage tolerance for adaptive refinement.\n        c (int): Maximum number of band additions per k-point.\n\n    Returns:\n        float: The final k-averaged spillage after refinement.\n    \"\"\"\n    # Fixed model and simulation parameters\n    eps_a, t_a = -0.3, 1.0\n    eps_b, t_b = 0.2, -0.7\n    V0, t_ab = 0.6, 0.2\n    E_F = 0.0\n    N_k = 51\n    NUM_BANDS = 2\n\n    k_grid = np.linspace(-np.pi, np.pi, N_k, dtype=np.float64)\n    g1 = np.array([1.0, 0.0], dtype=np.complex128).reshape(NUM_BANDS, 1)\n    g2 = np.array([np.cos(alpha), np.sin(alpha)], dtype=np.complex128).reshape(NUM_BANDS, 1)\n\n    total_spillage = 0.0\n\n    for k in k_grid:\n        cos_k = np.cos(k)\n        H = np.array([\n            [eps_a + 2 * t_a * cos_k, V0 + 2 * t_ab * cos_k],\n            [V0 + 2 * t_ab * cos_k, eps_b + 2 * t_b * cos_k]\n        ], dtype=np.complex128)\n\n        eigvals, eigvecs = np.linalg.eigh(H)\n\n        # Step 1: Determine initial inner-window band indices\n        abs_energy_diffs = np.abs(eigvals - E_F)\n        initial_indices_mask = abs_energy_diffs = w\n        initial_indices = np.where(initial_indices_mask)[0]\n\n        if initial_indices.size == 0:\n            initial_indices = np.array([np.argmin(abs_energy_diffs)])\n\n        # Step 2: Adaptive refinement loop\n        current_indices = set(initial_indices)\n        num_additions = 0\n        final_k_spillage = 0.0\n\n        while True:\n            # Construct matrix of eigenvectors for the current window\n            U_in = eigvecs[:, sorted(list(current_indices))]\n\n            # Disentangle for g1\n            # Project g1 onto the inner-window subspace\n            proj_g1 = U_in.T.conj() @ g1\n            norm_proj_g1 = np.linalg.norm(proj_g1)\n            # Normalize to get the disentangled state phi_1\n            # A norm of zero is not expected for this problem's parameters\n            if norm_proj_g1  1e-15:\n                # Fallback for the theoretical case of zero projection\n                phi1 = U_in[:, [0]]\n            else:\n                phi1 = U_in @ proj_g1 / norm_proj_g1\n\n            # Disentangle for g2\n            proj_g2 = U_in.T.conj() @ g2\n            norm_proj_g2 = np.linalg.norm(proj_g2)\n            if norm_proj_g2  1e-15:\n                phi2 = U_in[:, [0]]\n            else:\n                phi2 = U_in @ proj_g2 / norm_proj_g2\n\n            # Calculate spillage S = 1 - |phi_1|phi_2|^2\n            overlap_sq = np.abs(np.vdot(phi1, phi2))**2\n            spillage = 1.0 - overlap_sq\n            final_k_spillage = spillage\n\n            # Check stopping conditions for the refinement loop\n            if spillage = tau:\n                break\n            if num_additions >= c:\n                break\n            if len(current_indices) == NUM_BANDS:\n                break\n\n            # If conditions not met, perform one refinement step\n            all_indices = set(range(NUM_BANDS))\n            excluded_indices = list(all_indices - current_indices)\n\n            # Add the energetically closest excluded band\n            # For 2 bands, there is at most one choice.\n            if excluded_indices:\n                idx_to_add = excluded_indices[0] # The only possible choice\n                current_indices.add(idx_to_add)\n                num_additions += 1\n            else: # Should be unreachable due to previous check\n                 break\n\n        total_spillage += final_k_spillage\n\n    return total_spillage / N_k\n\nif __name__ == \"__main__\":\n    solve()\n```", "id": "3502336"}]}