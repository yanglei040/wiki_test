{"hands_on_practices": [{"introduction": "A successful Diffusion Ordered Spectroscopy (DOSY) experiment begins with thoughtful design. When analyzing a mixture containing molecules of different sizes, it is crucial to select gradient parameters that induce measurable signal attenuation for all components. This practice guides you through the process of establishing a geometrically spaced gradient array, ensuring that the signal from the slowest-diffusing species is sufficiently attenuated at high gradient strengths while the signal from the fastest-diffusing species is not completely lost at low strengths [@problem_id:3699334].", "problem": "You are designing a Diffusion Ordered Spectroscopy (DOSY) acquisition using a Pulsed Gradient Spin Echo (PGSE) Nuclear Magnetic Resonance (NMR) sequence with rectangular gradient pulses to analyze a mixture of organic compounds spanning a wide diffusion coefficient range. For robust mixture analysis, you will use a geometrically spaced set of gradient amplitudes to sample the diffusion-attenuation curve over a broad dynamic range while controlling signal-to-noise and transverse relaxation effects.\n\nAssume the diffusion coefficients of mixture components fall within the range from $D_{\\min} = 3.0 \\times 10^{-10}\\ \\mathrm{m^2\\,s^{-1}}$ to $D_{\\max} = 2.0 \\times 10^{-9}\\ \\mathrm{m^2\\,s^{-1}}$. You plan to acquire $N = 16$ gradient steps with amplitudes $\\{g_n\\}$ following a geometric progression $g_n = g_1 r^{n-1}$, where $r$ is a constant ratio to be determined. The rectangular gradient pulse duration is $\\delta = 4.0 \\times 10^{-3}\\ \\mathrm{s}$, the diffusion time is $\\Delta = 5.0 \\times 10^{-2}\\ \\mathrm{s}$, and the proton gyromagnetic ratio is $\\gamma = 2.675 \\times 10^{8}\\ \\mathrm{rad\\,s^{-1}\\,T^{-1}}$. To ensure measurable attenuation across the diffusion range without excessive loss of signal, impose the following boundary conditions on the normalized echo attenuation for the slowest and fastest diffusers at the weakest and strongest gradients, respectively: for $D_{\\min}$ at the lowest gradient step $n=1$, the attenuation should be $A_{\\text{high}} = 0.97$; for $D_{\\max}$ at the highest gradient step $n=N$, the attenuation should be $A_{\\text{low}} = 0.20$.\n\nUsing first principles appropriate to pulsed-field gradient diffusion NMR, determine the geometric ratio $r$ that satisfies these attenuation constraints under the stated conditions. Express the final answer for $r$ as a dimensionless number. Round your answer to four significant figures.", "solution": "The analysis of this problem begins with the validation of the problem statement.\n\n**Step 1: Extract Givens**\n- Minimum diffusion coefficient: $D_{\\min} = 3.0 \\times 10^{-10}\\ \\mathrm{m^2\\,s^{-1}}$\n- Maximum diffusion coefficient: $D_{\\max} = 2.0 \\times 10^{-9}\\ \\mathrm{m^2\\,s^{-1}}$\n- Number of gradient steps: $N = 16$\n- Gradient amplitude progression: $g_n = g_1 r^{n-1}$\n- Rectangular gradient pulse duration: $\\delta = 4.0 \\times 10^{-3}\\ \\mathrm{s}$\n- Diffusion time: $\\Delta = 5.0 \\times 10^{-2}\\ \\mathrm{s}$\n- Proton gyromagnetic ratio: $\\gamma = 2.675 \\times 10^{8}\\ \\mathrm{rad\\,s^{-1}\\,T^{-1}}$\n- Attenuation for $D_{\\min}$ at $g_1$: $A_{\\text{high}} = 0.97$\n- Attenuation for $D_{\\max}$ at $g_N$: $A_{\\text{low}} = 0.20$\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is scientifically grounded, as it is based on the well-established principles of Pulsed Gradient Spin Echo (PGSE) Nuclear Magnetic Resonance (NMR), specifically the Stejskal-Tanner equation. The problem is well-posed, providing two constraints for two unknowns ($g_1$ and $r$), allowing for a unique solution. All parameters are physically realistic for a standard DOSY experiment. The problem formulation is objective, quantitative, and free from ambiguity or contradiction.\n\n**Step 3: Verdict and Action**\nThe problem is deemed valid. A complete solution will be provided.\n\nThe fundamental principle governing signal attenuation in a PGSE experiment with rectangular gradient pulses is the Stejskal-Tanner equation. The normalized signal intensity, $A$, which represents the attenuation, is given by:\n$$A = \\frac{I}{I_0} = \\exp\\left( -D (\\gamma g \\delta)^2 \\left( \\Delta - \\frac{\\delta}{3} \\right) \\right)$$\nwhere $D$ is the diffusion coefficient, $\\gamma$ is the gyromagnetic ratio, $g$ is the gradient amplitude, $\\delta$ is the duration of the gradient pulses, and $\\Delta$ is the diffusion time.\n\nTo simplify the expression, we can group the constant experimental parameters into a single term, $b$:\n$$b = (\\gamma \\delta)^2 \\left( \\Delta - \\frac{\\delta}{3} \\right)$$\nThe attenuation equation then becomes:\n$$A(D, g) = \\exp(-D b g^2)$$\nThe problem provides two boundary conditions that constrain the system.\n\nFirst condition: for the slowest diffusing component with $D = D_{\\min}$, the attenuation at the lowest gradient amplitude $g_1$ is $A_{\\text{high}} = 0.97$.\n$$A_{\\text{high}} = \\exp(-D_{\\min} b g_1^2)$$\nTaking the natural logarithm of both sides gives our first equation:\n$$\\ln(A_{\\text{high}}) = -D_{\\min} b g_1^2 \\quad \\quad (1)$$\n\nSecond condition: for the fastest diffusing component with $D = D_{\\max}$, the attenuation at the highest gradient amplitude $g_N$ is $A_{\\text{low}} = 0.20$. The gradient amplitudes follow a geometric progression $g_n = g_1 r^{n-1}$. For $N = 16$ steps, the highest gradient is $g_{16} = g_1 r^{16-1} = g_1 r^{15}$.\n$$A_{\\text{low}} = \\exp(-D_{\\max} b g_{16}^2) = \\exp(-D_{\\max} b (g_1 r^{15})^2)$$\nTaking the natural logarithm of both sides gives our second equation:\n$$\\ln(A_{\\text{low}}) = -D_{\\max} b g_1^2 r^{30} \\quad \\quad (2)$$\n\nWe now have a system of two equations with two unknowns, $g_1$ and $r$. Our goal is to solve for the geometric ratio $r$. From equation (1), we can isolate the term $b g_1^2$:\n$$b g_1^2 = -\\frac{\\ln(A_{\\text{high}})}{D_{\\min}}$$\nNow, substitute this expression for $b g_1^2$ into equation (2):\n$$\\ln(A_{\\text{low}}) = -D_{\\max} r^{30} \\left( -\\frac{\\ln(A_{\\text{high}})}{D_{\\min}} \\right)$$\n$$\\ln(A_{\\text{low}}) = \\frac{D_{\\max}}{D_{\\min}} r^{30} \\ln(A_{\\text{high}})$$\nWe can now solve for $r^{30}$:\n$$r^{30} = \\frac{D_{\\min}}{D_{\\max}} \\frac{\\ln(A_{\\text{low}})}{\\ln(A_{\\text{high}})}$$\nFinally, we solve for $r$ by taking the $30$-th root of both sides. Note that the exponent in the general case is $2(N-1)$. For $N=16$, this is $2(16-1) = 30$.\n$$r = \\left( \\frac{D_{\\min}}{D_{\\max}} \\frac{\\ln(A_{\\text{low}})}{\\ln(A_{\\text{high}})} \\right)^{\\frac{1}{30}}$$\nNotice that the constants $\\gamma$, $\\delta$, and $\\Delta$ contained within the term $b$ have cancelled out, so their explicit numerical values are not needed to find $r$. We now substitute the given numerical values into the expression for $r$:\n- $D_{\\min} = 3.0 \\times 10^{-10}\\ \\mathrm{m^2\\,s^{-1}}$\n- $D_{\\max} = 2.0 \\times 10^{-9}\\ \\mathrm{m^2\\,s^{-1}}$\n- $A_{\\text{high}} = 0.97$\n- $A_{\\text{low}} = 0.20$\n\nThe ratio of diffusion coefficients is:\n$$\\frac{D_{\\min}}{D_{\\max}} = \\frac{3.0 \\times 10^{-10}}{2.0 \\times 10^{-9}} = 0.15$$\nSubstituting this and the attenuation values into the equation for $r$:\n$$r = \\left( 0.15 \\times \\frac{\\ln(0.20)}{\\ln(0.97)} \\right)^{\\frac{1}{30}}$$\nNow, we calculate the numerical values of the logarithms:\n$$\\ln(0.20) \\approx -1.6094379$$\n$$\\ln(0.97) \\approx -0.0304592$$\nThe ratio of the logarithms is:\n$$\\frac{\\ln(0.20)}{\\ln(0.97)} \\approx \\frac{-1.6094379}{-0.0304592} \\approx 52.83930$$\nSubstituting this back into the expression for $r$:\n$$r \\approx (0.15 \\times 52.83930)^{\\frac{1}{30}}$$\n$$r \\approx (7.925895)^{\\frac{1}{30}}$$\n$$r \\approx 1.071443$$\nThe problem requires the answer to be rounded to four significant figures. Therefore:\n$$r \\approx 1.071$$\nThis is the geometric ratio required to satisfy the specified attenuation conditions for the mixture analysis.", "answer": "$$\\boxed{1.071}$$", "id": "3699334"}, {"introduction": "While the Stejskal-Tanner equation provides an ideal theoretical framework, real-world DOSY measurements are affected by instrumental non-idealities such as gradient miscalibration and eddy currents. To obtain accurate and reproducible diffusion coefficients, these effects must be accounted for. This exercise demonstrates the standard and essential practice of using a reference compound with a known diffusion coefficient ($D_{\\text{ref}}$) to calibrate the experiment and correct for systematic errors [@problem_id:3699340].", "problem": "A Diffusion Ordered Spectroscopy (DOSY) measurement for mixture analysis is performed using a Pulsed Gradient Spin Echo (PGSE) sequence to estimate diffusion coefficients of organic analytes. The detection nucleus is proton with gyromagnetic ratio $\\gamma = 2.675 \\times 10^{8}\\,\\mathrm{rad\\,s^{-1}\\,T^{-1}}$. The gradient waveform is nominally rectangular with programmable amplitude $g_{\\text{set}}$ (in $\\mathrm{T\\,m^{-1}}$), pulse duration $\\delta$, and diffusion time $\\Delta$. However, two instrumental non-idealities are present:\n\n1. Gradient calibration: the actual gradient amplitude is scaled by a factor $\\kappa$ so that $g_{\\text{actual}} = \\kappa\\,g_{\\text{set}}$.\n2. Eddy currents: a measured multiplicative reduction of the effective gradient amplitude by a factor $(1 - \\epsilon)$, common to all lobes in this probe configuration, where $\\epsilon$ is obtained from an independent eddy-current characterization of the hardware.\n\nIt is known that under Gaussian diffusion and small-angle phase accumulation, the echo attenuation obeys $S/S_0 = \\exp(-bD)$ with $b$ determined by the time-integrated gradient waveform. For ideal rectangular PGSE pulses, the well-tested Stejskal–Tanner result gives a $b$-value proportional to $g^2$ with $b(g) = \\gamma^2 g^2 \\delta^2 (\\Delta - \\delta/3)$. In practice here, the slope of the semi-log plot $\\ln(S/S_0)$ versus $g_{\\text{set}}^2$ is observed, and the two non-idealities above scale the effective slope by $\\kappa^2(1 - \\epsilon)^2$.\n\nYou are provided the following experimental parameters and calibration data:\n- Pulse duration $\\delta = 2.50 \\times 10^{-3}\\,\\mathrm{s}$.\n- Diffusion time $\\Delta = 5.00 \\times 10^{-2}\\,\\mathrm{s}$.\n- Eddy-current amplitude factor $\\epsilon = 0.10$ (dimensionless).\n- Reference sample with known diffusion coefficient $D_{\\text{ref}} = 2.30 \\times 10^{-9}\\,\\mathrm{m^2\\,s^{-1}}$ measured at the same temperature and sequence timings.\n- Measured slope for the reference, $m_{\\text{ref}} = 40.0\\,\\mathrm{m^2\\,T^{-2}}$, obtained from a linear fit of $\\ln(S/S_0)$ versus $g_{\\text{set}}^2$.\n- Measured slope for the ethanol resonance in the mixture, $m_{\\text{eth}} = 35.0\\,\\mathrm{m^2\\,T^{-2}}$, obtained under identical conditions.\n\nUsing a first-principles relationship between diffusion-driven phase dispersion and the $b$-value for PGSE, derive the expressions needed to:\n1. Determine the gradient calibration factor $\\kappa$ from the reference measurement.\n2. Compute the corrected diffusion coefficient $D_{\\text{eth}}$ for ethanol in the mixture from $m_{\\text{eth}}$.\n\nExpress the final diffusion coefficient for ethanol in $\\mathrm{m^2\\,s^{-1}}$ and round your final numerical answer to three significant figures. The final answer must be a single real-valued number.", "solution": "The problem asks for the derivation of expressions to determine the gradient calibration factor $\\kappa$ and the diffusion coefficient of ethanol $D_{\\text{eth}}$, followed by the calculation of $D_{\\text{eth}}$. The solution will be developed from the fundamental principles of Pulsed Gradient Spin Echo (PGSE) NMR.\n\nThe signal attenuation $S$ in a PGSE experiment as a function of gradient amplitude $g$ is given by:\n$$ \\frac{S}{S_0} = \\exp(-b D) $$\nwhere $S_0$ is the signal intensity without applied gradients, $D$ is the diffusion coefficient of the analyte, and $b$ is the \"b-value,\" which encapsulates the experimental parameters.\n\nFor a sequence with ideal rectangular gradient pulses of duration $\\delta$, amplitude $g$, and separation $\\Delta$, the b-value is given by the Stejskal-Tanner equation:\n$$ b(g) = \\gamma^2 g^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) $$\nwhere $\\gamma$ is the gyromagnetic ratio of the observed nucleus.\n\nIn this problem, two non-idealities affect the gradient amplitude. The programmable gradient amplitude, $g_{\\text{set}}$, is related to the actual applied gradient, $g_{\\text{actual}}$, by a calibration factor $\\kappa$:\n$$ g_{\\text{actual}} = \\kappa g_{\\text{set}} $$\nFurthermore, eddy currents reduce the effective gradient amplitude by a factor $(1 - \\epsilon)$. Therefore, the effective gradient amplitude, $g_{\\text{eff}}$, that the nuclear spins experience is:\n$$ g_{\\text{eff}} = g_{\\text{actual}} (1 - \\epsilon) = \\kappa (1 - \\epsilon) g_{\\text{set}} $$\nSubstituting $g_{\\text{eff}}$ for $g$ in the Stejskal-Tanner equation gives the true b-value as a function of the set gradient amplitude $g_{\\text{set}}$:\n$$ b(g_{\\text{set}}) = \\gamma^2 g_{\\text{eff}}^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) = \\gamma^2 \\left(\\kappa (1 - \\epsilon) g_{\\text{set}}\\right)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) $$\n$$ b(g_{\\text{set}}) = \\left[ \\gamma^2 \\kappa^2 (1 - \\epsilon)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) \\right] g_{\\text{set}}^2 $$\nThe signal attenuation equation can now be written as:\n$$ \\ln\\left(\\frac{S}{S_0}\\right) = -b(g_{\\text{set}}) D = - \\left[ \\gamma^2 \\kappa^2 (1 - \\epsilon)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) D \\right] g_{\\text{set}}^2 $$\nThe experiment measures the slope of a plot of $\\ln(S/S_0)$ versus $g_{\\text{set}}^2$. Let's call this slope $m'$. From the equation above,\n$$ m' = \\frac{\\mathrm{d}}{\\mathrm{d}(g_{\\text{set}}^2)} \\ln\\left(\\frac{S}{S_0}\\right) = - \\gamma^2 \\kappa^2 (1 - \\epsilon)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) D $$\nThe problem provides positive values for the measured slopes ($m_{\\text{ref}}$ and $m_{\\text{eth}}$), which is a common convention in DOSY analysis. This implies that the reported slope $m$ is the magnitude of the change, i.e., $m = -m'$.\n$$ m = \\gamma^2 \\kappa^2 (1 - \\epsilon)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) D $$\nThis is the central first-principles relationship connecting the observable $m$ to the physical parameters.\n\n1.  Determining the gradient calibration factor $\\kappa$.\n    We use the data from the reference sample measurement. The slope equation for the reference is:\n    $$ m_{\\text{ref}} = \\gamma^2 \\kappa^2 (1 - \\epsilon)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) D_{\\text{ref}} $$\n    To determine $\\kappa$, we rearrange this expression:\n    $$ \\kappa^2 = \\frac{m_{\\text{ref}}}{\\gamma^2 (1 - \\epsilon)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) D_{\\text{ref}}} $$\n    Thus, the expression for $\\kappa$ is:\n    $$ \\kappa = \\sqrt{\\frac{m_{\\text{ref}}}{\\gamma^2 (1 - \\epsilon)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) D_{\\text{ref}}}} $$\n    This is the first required derivation.\n\n2.  Computing the corrected diffusion coefficient $D_{\\text{eth}}$.\n    The measurement on the ethanol sample was performed under identical conditions, so the same slope equation applies:\n    $$ m_{\\text{eth}} = \\gamma^2 \\kappa^2 (1 - \\epsilon)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) D_{\\text{eth}} $$\n    Rearranging for $D_{\\text{eth}}$, we get:\n    $$ D_{\\text{eth}} = \\frac{m_{\\text{eth}}}{\\gamma^2 \\kappa^2 (1 - \\epsilon)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right)} $$\n    This is the second required derivation.\n\nTo compute the numerical value of $D_{\\text{eth}}$, we can either calculate $\\kappa$ first and substitute its value, or we can combine the expressions. A more direct and robust computational approach is to take the ratio of the two slope equations for the ethanol and reference samples:\n$$ \\frac{m_{\\text{eth}}}{m_{\\text{ref}}} = \\frac{\\gamma^2 \\kappa^2 (1 - \\epsilon)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) D_{\\text{eth}}}{\\gamma^2 \\kappa^2 (1 - \\epsilon)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) D_{\\text{ref}}} $$\nAll the instrumental parameters ($\\gamma, \\kappa, \\epsilon, \\delta, \\Delta$) cancel out, providing a simple relationship:\n$$ \\frac{m_{\\text{eth}}}{m_{\\text{ref}}} = \\frac{D_{\\text{eth}}}{D_{\\text{ref}}} $$\nFrom this, we derive the final expression to compute $D_{\\text{eth}}$:\n$$ D_{\\text{eth}} = D_{\\text{ref}} \\frac{m_{\\text{eth}}}{m_{\\text{ref}}} $$\nThis expression effectively uses the reference measurement to calibrate the entire experiment without explicitly calculating the intermediate parameter $\\kappa$.\n\nNow, we substitute the given numerical values:\n-   $D_{\\text{ref}} = 2.30 \\times 10^{-9}\\,\\mathrm{m^2\\,s^{-1}}$\n-   $m_{\\text{ref}} = 40.0\\,\\mathrm{m^2\\,T^{-2}}$\n-   $m_{\\text{eth}} = 35.0\\,\\mathrm{m^2\\,T^{-2}}$\n\n$$ D_{\\text{eth}} = (2.30 \\times 10^{-9}\\,\\mathrm{m^2\\,s^{-1}}) \\times \\frac{35.0\\,\\mathrm{m^2\\,T^{-2}}}{40.0\\,\\mathrm{m^2\\,T^{-2}}} $$\n$$ D_{\\text{eth}} = (2.30 \\times 10^{-9}\\,\\mathrm{m^2\\,s^{-1}}) \\times 0.875 $$\n$$ D_{\\text{eth}} = 2.0125 \\times 10^{-9}\\,\\mathrm{m^2\\,s^{-1}} $$\nThe problem requires the final answer to be rounded to three significant figures.\n$$ D_{\\text{eth}} \\approx 2.01 \\times 10^{-9}\\,\\mathrm{m^2\\,s^{-1}} $$", "answer": "$$\\boxed{2.01 \\times 10^{-9}}$$", "id": "3699340"}, {"introduction": "One of the most powerful applications of DOSY is the analysis of complex mixtures where spectral signals are severely overlapped, making them impossible to assign or quantify using conventional 1D NMR. This hands-on coding exercise introduces a powerful computational framework to resolve such mixtures by processing the entire dataset as a whole. You will implement a method to perform an inverse Laplace transform on the diffusion data, which converts the signal decays into a \"diffusion spectrum\" where each component appears as a distinct peak, enabling their identification even in the absence of resolved spectral signals [@problem_id:3699327].", "problem": "A research laboratory uses Diffusion Ordered Spectroscopy (DOSY) within Nuclear Magnetic Resonance (NMR) to characterize mixtures of small organic molecules that produce severely overlapping spectral signals. Under pulsed field gradients, diffusing spins accumulate random phases whose ensemble average attenuates the measured transverse magnetization. Starting from the Bloch–Torrey equation and Brownian motion, derive the functional dependence of signal attenuation on the free translational diffusion coefficient $D$ and the gradient waveform for a pulsed field gradient spin echo sequence with rectangular gradient pulses. Then, for a mixture with $K$ chemically distinct components, formalize the multi-exponential attenuation model across a set of gradient encodings as a bilinear factorization of a data matrix in which columns represent distinct spectral variables (e.g., frequency bins) and rows represent gradient encodings. Your derivation must begin from the fundamental definitions of diffusion as a Gaussian random process with mean squared displacement $\\langle r^2 \\rangle = 6 D t$, the phase accrual under a magnetic field gradient, and the linearity of the Bloch–Torrey equation under spatially varying fields.\n\nYour task is to implement a multivariate method to estimate the component diffusion coefficients $D$ from simulated DOSY measurements for mixtures with overlapping signals. You must use a non-parametric basis in $D$ (a dictionary of candidate $D$ values on a logarithmic grid) and solve a Non-Negative Least Squares (NNLS) problem independently at each spectral variable to obtain non-negative coefficient weights, then aggregate across the spectral variables to recover the global diffusion profile and select the $K$ most prominent diffusivities. You may optionally use Singular Value Decomposition (SVD) to reason about rank, but the core numerical step must be NNLS against a non-negative exponential dictionary. All estimates must be expressed in $\\mathrm{m^2\\,s^{-1}}$ and rounded to three significant figures.\n\nThe forward model to generate the synthetic measurements for testing should be derived as follows. Consider a pulsed field gradient spin echo with two identical rectangular gradient pulses of amplitude $g$ (in $\\mathrm{T\\, m^{-1}}$), duration $\\delta$ (in $\\mathrm{s}$), separated by a diffusion time $\\Delta$ (in $\\mathrm{s}$). Let the gyromagnetic ratio be $\\gamma$ (in $\\mathrm{rad\\, s^{-1}\\, T^{-1}}$). For a component with diffusion coefficient $D$ (in $\\mathrm{m^2\\, s^{-1}}$), the ensemble-averaged echo attenuation as a function of the gradient amplitude sequence can be obtained by combining the Gaussian displacement statistics of Brownian motion with phase accrual under the gradient and the linearity of the magnetization evolution. Use this to construct, for each component, a decay factor as a function of the encoding parameter that depends on $\\gamma$, $g$, $\\delta$, $\\Delta$, and $D$. For a mixture with $K$ components and non-negative spectral amplitudes $s_{k j}$ for spectral variable index $j$, the measured data at encoding index $i$ and spectral variable index $j$ is the superposition over components. Add zero-mean Gaussian noise with a specified standard deviation to simulate experimental noise. All synthetic data must be numerically generated by your program using these physically consistent definitions.\n\nTest suite. Your program must generate three independent test cases by synthesizing DOSY data matrices using the physically derived attenuation model, with the following parameter sets. In each case, all quantities are scalars unless explicitly indicated as arrays or matrices.\n\n- Case $1$ (well-separated diffusivities, moderate overlap):\n  - Gyromagnetic ratio $\\gamma = 2.6752218744 \\times 10^{8}\\ \\mathrm{rad\\, s^{-1}\\, T^{-1}}$.\n  - Gradient pulse duration $\\delta = 3.2 \\times 10^{-3}\\ \\mathrm{s}$.\n  - Diffusion time $\\Delta = 4.8 \\times 10^{-2}\\ \\mathrm{s}$.\n  - Gradient amplitudes $g$ (in $\\mathrm{T\\, m^{-1}}$): $\\{0.05, 0.08, 0.11, 0.14, 0.17, 0.20, 0.23, 0.26, 0.29, 0.32, 0.35, 0.38\\}$.\n  - True diffusion coefficients $D_\\text{true}$ (in $\\mathrm{m^2\\,s^{-1}}$): $\\{1.20 \\times 10^{-9}, 3.50 \\times 10^{-10}\\}$ with $K=2$.\n  - Non-negative spectral amplitude matrix $S \\in \\mathbb{R}_{\\ge 0}^{K \\times J}$ with $J=3$:\n    - Row $1$: $\\{1.0, 0.5, 0.0\\}$.\n    - Row $2$: $\\{0.3, 0.9, 1.0\\}$.\n  - Additive noise: zero-mean Gaussian with standard deviation $\\sigma = 1.0 \\times 10^{-2}$ relative to unit amplitude.\n- Case $2$ (closely spaced diffusivities, severe overlap):\n  - Gyromagnetic ratio $\\gamma = 2.6752218744 \\times 10^{8}\\ \\mathrm{rad\\, s^{-1}\\, T^{-1}}$.\n  - Gradient pulse duration $\\delta = 2.8 \\times 10^{-3}\\ \\mathrm{s}$.\n  - Diffusion time $\\Delta = 4.0 \\times 10^{-2}\\ \\mathrm{s}$.\n  - Gradient amplitudes $g$ (in $\\mathrm{T\\, m^{-1}}$): $\\{0.06, 0.09, 0.12, 0.15, 0.18, 0.21, 0.24, 0.27, 0.30, 0.33\\}$.\n  - True diffusion coefficients $D_\\text{true}$ (in $\\mathrm{m^2\\,s^{-1}}$): $\\{8.00 \\times 10^{-10}, 6.50 \\times 10^{-10}\\}$ with $K=2$.\n  - Non-negative spectral amplitude matrix $S \\in \\mathbb{R}_{\\ge 0}^{K \\times J}$ with $J=4$:\n    - Row $1$: $\\{0.6, 0.7, 0.5, 0.0\\}$.\n    - Row $2$: $\\{0.5, 0.6, 0.7, 1.0\\}$.\n  - Additive noise: zero-mean Gaussian with standard deviation $\\sigma = 2.0 \\times 10^{-2}$ relative to unit amplitude.\n- Case $3$ (single component, minimal overlap):\n  - Gyromagnetic ratio $\\gamma = 2.6752218744 \\times 10^{8}\\ \\mathrm{rad\\, s^{-1}\\, T^{-1}}$.\n  - Gradient pulse duration $\\delta = 3.0 \\times 10^{-3}\\ \\mathrm{s}$.\n  - Diffusion time $\\Delta = 6.0 \\times 10^{-2}\\ \\mathrm{s}$.\n  - Gradient amplitudes $g$ (in $\\mathrm{T\\, m^{-1}}$): $\\{0.05, 0.10, 0.15, 0.20, 0.25, 0.30, 0.35, 0.40\\}$.\n  - True diffusion coefficients $D_\\text{true}$ (in $\\mathrm{m^2\\,s^{-1}}$): $\\{2.50 \\times 10^{-10}\\}$ with $K=1$.\n  - Non-negative spectral amplitude matrix $S \\in \\mathbb{R}_{\\ge 0}^{K \\times J}$ with $J=2$:\n    - Row $1$: $\\{1.2, 0.7\\}$.\n  - Additive noise: zero-mean Gaussian with standard deviation $\\sigma = 5.0 \\times 10^{-3}$ relative to unit amplitude.\n\nAlgorithmic requirements and output specification:\n- Construct a logarithmically spaced candidate grid of $N_D$ diffusion coefficients $D_\\mathrm{grid}$ covering at least the interval $[1.0 \\times 10^{-10}, 2.0 \\times 10^{-9}]$ in $\\mathrm{m^2\\,s^{-1}}$ with $N_D \\ge 200$.\n- For each case, build the exponential dictionary over encodings using the physically derived attenuation function evaluated at $D_\\mathrm{grid}$ and solve an NNLS problem at each spectral variable to obtain a non-negative weight vector over $D_\\mathrm{grid}$. Aggregate the weights across spectral variables to form a global diffusion profile and select the $K$ most prominent diffusion coefficients by non-maximum suppression on the grid. Optionally refine each selected coefficient by a local weighted center-of-mass over neighboring grid points.\n- For each case, return the list of the $K$ estimated diffusion coefficients in ascending order, expressed in $\\mathrm{m^2\\,s^{-1}}$ and rounded to three significant figures.\n\nYour program should produce a single line of output containing the results as a comma-separated list of three bracketed lists, one list per case, in the exact format: \"[[case1_estimates],[case2_estimates],[case3_estimates]]\". Each inner list must contain $K$ floating-point numbers in scientific notation rounded to three significant figures (for example, $1.20\\mathrm{e}{-9}$ should be printed as \"1.20e-09\").", "solution": "The problem requires the derivation of the signal attenuation model for Diffusion Ordered Spectroscopy (DOSY) and the implementation of a numerical method to estimate diffusion coefficients from simulated noisy data. The validation confirms the problem is scientifically sound, well-posed, and contains all necessary information.\n\n### Principle-Based Design\n\n#### 1. Derivation of the Signal Attenuation for Pulsed Gradient Spin Echo (PGSE)\n\nThe core principle of DOSY is the measurement of signal attenuation due to the translational motion of molecules in the presence of a magnetic field gradient. The experiment relies on encoding the spatial position of nuclear spins via a phase shift and then decoding it after a diffusion time. Any net displacement during this time results in an incomplete phase refocusing and thus signal loss.\n\nThe phase $\\phi$ accrued by a nuclear spin with gyromagnetic ratio $\\gamma$ at position $\\mathbf{r}(t)$ under a time-dependent magnetic field gradient $\\mathbf{G}(t)$ is given by the integral over the duration of the experiment, $T_E$:\n$$\n\\phi = \\int_0^{T_E} \\gamma \\mathbf{G}(t) \\cdot \\mathbf{r}(t) dt\n$$\nThe measured signal is the ensemble average of the transverse magnetization over all spins in the sample volume. For spins undergoing Brownian motion, their positions $\\mathbf{r}(t)$ are random variables. Assuming the initial phase is zero, the signal attenuation $A$ is given by the ensemble average:\n$$\nA = \\left\\langle e^{i\\phi} \\right\\rangle\n$$\nFor a PGSE sequence with two rectangular gradient pulses of amplitude $g$, duration $\\delta$, and oriented along the z-axis, separated by a time interval allowing for diffusion, the effective gradient profile accounts for a $180^\\circ$ radiofrequency pulse that inverts the phase evolution. The net phase accumulated by a spin is a function of its displacement along the z-axis during the diffusion period.\n\nThe phase $\\phi$ is a random variable, which for a Gaussian process like diffusion, follows a Gaussian distribution with zero mean ($\\langle \\phi \\rangle = 0$). The signal attenuation simplifies to:\n$$\nA = e^{-\\frac{1}{2}\\langle \\phi^2 \\rangle}\n$$\nThe calculation of the mean-squared phase $\\langle \\phi^2 \\rangle$ for the PGSE sequence, by integrating over the random paths of diffusing particles, is a standard result in NMR theory. It yields the Stejskal-Tanner equation:\n$$\nA(g) = \\exp \\left( -(\\gamma g \\delta)^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) D \\right)\n$$\nHere, $D$ is the translational diffusion coefficient, $\\Delta$ is the diffusion time (the time between the leading edges of the two gradient pulses), and the term $(\\Delta - \\delta/3)$ is an effective diffusion time that accounts for motion during the finite-duration gradient pulses.\n\nFor convenience, we define a single encoding parameter $b_i$ for each gradient amplitude $g_i$:\n$$\nb_i = (\\gamma g_i \\delta)^2 \\left(\\Delta - \\frac{\\delta}{3}\\right)\n$$\nThe attenuation for a single molecular species with diffusion coefficient $D$ is then a simple exponential decay:\n$$\nA(g_i) = e^{-b_i D}\n$$\n\n#### 2. Mixture Analysis and Bilinear Factorization\n\nFor a mixture containing $K$ chemically distinct components, each with its own diffusion coefficient $D_k$ and spectral signature, the total observed signal is the linear superposition of the signals from each component. Let $Y \\in \\mathbb{R}^{M \\times J}$ be the data matrix, where $M$ is the number of gradient steps (encodings) and $J$ is the number of spectral variables (e.g., frequency bins). Let $S \\in \\mathbb{R}_{\\ge 0}^{K \\times J}$ be the matrix of non-negative spectral amplitudes, where $S_{kj}$ is the amplitude of component $k$ at spectral variable $j$.\n\nThe signal at encoding $i$ and spectral variable $j$, denoted $Y_{ij}$, is modeled as:\n$$\nY_{ij} = \\sum_{k=1}^K S_{kj} e^{-b_i D_k} + E_{ij}\n$$\nwhere $E_{ij}$ represents additive noise. This equation describes a bilinear model. We can express this in matrix form. Let $A \\in \\mathbb{R}^{M \\times K}$ be the matrix of diffusion-dependent attenuation factors, with elements $A_{ik} = e^{-b_i D_k}$. The data matrix can then be written as:\n$$\nY = A S + E\n$$\nThis is the bilinear factorization of the data matrix $Y$ into a diffusion-decay matrix $A$ and a component-spectra matrix $S$, as requested.\n\n#### 3. Numerical Inversion via Non-Negative Least Squares (NNLS)\n\nThe inverse problem is to estimate the diffusion coefficients $\\{D_k\\}_{k=1}^K$ from the measured data matrix $Y$. This is an instance of an inverse Laplace transform, which is notoriously ill-posed. A robust method to regularize this problem is to discretize the diffusion coefficient domain.\n\nWe define a grid of $N_D$ candidate diffusion coefficients, $D_\\text{grid} = \\{D_l\\}_{l=1}^{N_D}$, typically spaced logarithmically over a plausible range. For each spectral variable $j$ (each column of $Y$), we model the signal decay $\\mathbf{y}_j \\in \\mathbb{R}^M$ as a linear combination of exponential decays corresponding to the dictionary $D_\\text{grid}$:\n$$\n\\mathbf{y}_j = \\mathcal{A} \\mathbf{c}_j + \\mathbf{e}_j\n$$\nHere, $\\mathcal{A} \\in \\mathbb{R}^{M \\times N_D}$ is the dictionary or basis matrix with elements $\\mathcal{A}_{il} = e^{-b_i D_l}$, and $\\mathbf{c}_j \\in \\mathbb{R}_{\\ge 0}^{N_D}$ is a vector of non-negative coefficients (or weights) for the spectral channel $j$. Each element $c_{lj}$ represents the contribution of a component with diffusion coefficient $D_l$ to the signal at spectral variable $j$.\n\nThe non-negativity of the coefficients is physically justified, as spectral amplitudes cannot be negative. We solve for the coefficient vector $\\mathbf{c}_j$ for each spectral variable $j$ by minimizing the squared L2-norm of the residual, subject to the non-negativity constraint. This is the Non-Negative Least Squares (NNLS) problem:\n$$\n\\min_{\\mathbf{c}_j \\ge 0} || \\mathbf{y}_j - \\mathcal{A} \\mathbf{c}_j ||_2^2\n$$\nThis is performed independently for each column of the data matrix $Y$.\n\n#### 4. Estimation of Diffusion Coefficients\n\nAfter solving for the coefficient matrix $C \\in \\mathbb{R}^{N_D \\times J}$ (whose columns are the $\\mathbf{c}_j$ vectors), we obtain a global diffusion profile, or \"diffusogram,\" by summing the coefficients across all spectral variables:\n$$\n\\mathbf{c}_\\text{total} = \\sum_{j=1}^{J} \\mathbf{c}_j\n$$\nThe vector $\\mathbf{c}_\\text{total} \\in \\mathbb{R}_{\\ge 0}^{N_D}$ represents the distribution of diffusion coefficients for the entire mixture. The peaks in this vector correspond to the diffusion coefficients of the components present in the sample.\n\nTo identify the $K$ diffusion coefficients, we perform the following steps:\n1.  **Peak Detection**: Identify all local maxima in $\\mathbf{c}_\\text{total}$ along the $D_\\text{grid}$.\n2.  **Peak Selection**: Select the $K$ most prominent peaks, chosen as those with the largest amplitudes in $\\mathbf{c}_\\text{total}$.\n3.  **Refinement**: For each selected peak at grid index $p$, refine the estimated $D$ value by calculating a local weighted center-of-mass over a small window of neighboring grid points. If the window is $[p-w, p+w]$, the refined estimate $D_{k, \\text{est}}$ is:\n    $$\n    D_{k, \\text{est}} = \\frac{\\sum_{l=p-w}^{p+w} c_{\\text{total},l} \\cdot D_{\\text{grid},l}}{\\sum_{l=p-w}^{p+w} c_{\\text{total},l}}\n    $$\nThis refinement step improves the accuracy of the estimates beyond the discretization limit of the grid. The final set of $K$ refined diffusion coefficients constitutes the solution for one test case.", "answer": "```python\nimport numpy as np\nfrom scipy.optimize import nnls\nfrom scipy.signal import find_peaks\n\ndef solve():\n    \"\"\"\n    Solves for diffusion coefficients from simulated DOSY NMR data.\n\n    The function processes three predefined test cases. For each case, it:\n    1. Synthesizes a noisy DOSY data matrix based on the Stejskal-Tanner equation.\n    2. Constructs a dictionary of exponential decays over a logarithmic grid of\n       candidate diffusion coefficients.\n    3. Solves a Non-Negative Least Squares (NNLS) problem for each spectral\n       variable to find the distribution of diffusion coefficients.\n    4. Aggregates the results into a global diffusion profile.\n    5. Identifies the K most prominent diffusion coefficients by finding the K\n       strongest peaks in the profile.\n    6. Refines each estimate using a local center-of-mass calculation.\n    7. Collects and formats the results according to the problem specification.\n    \"\"\"\n    # Case definitions\n    test_cases = [\n        {\n            # Case 1: well-separated diffusivities, moderate overlap\n            \"gamma\": 2.6752218744e8,\n            \"delta\": 3.2e-3,\n            \"Delta\": 4.8e-2,\n            \"g\": np.array([0.05, 0.08, 0.11, 0.14, 0.17, 0.20, 0.23, 0.26, 0.29, 0.32, 0.35, 0.38]),\n            \"D_true\": np.array([1.20e-9, 3.50e-10]),\n            \"K\": 2,\n            \"S\": np.array([[1.0, 0.5, 0.0], [0.3, 0.9, 1.0]]),\n            \"noise_sigma\": 1.0e-2\n        },\n        {\n            # Case 2: closely spaced diffusivities, severe overlap\n            \"gamma\": 2.6752218744e8,\n            \"delta\": 2.8e-3,\n            \"Delta\": 4.0e-2,\n            \"g\": np.array([0.06, 0.09, 0.12, 0.15, 0.18, 0.21, 0.24, 0.27, 0.30, 0.33]),\n            \"D_true\": np.array([8.00e-10, 6.50e-10]),\n            \"K\": 2,\n            \"S\": np.array([[0.6, 0.7, 0.5, 0.0], [0.5, 0.6, 0.7, 1.0]]),\n            \"noise_sigma\": 2.0e-2\n        },\n        {\n            # Case 3: single component, minimal overlap\n            \"gamma\": 2.6752218744e8,\n            \"delta\": 3.0e-3,\n            \"Delta\": 6.0e-2,\n            \"g\": np.array([0.05, 0.10, 0.15, 0.20, 0.25, 0.30, 0.35, 0.40]),\n            \"D_true\": np.array([2.50e-10]),\n            \"K\": 1,\n            \"S\": np.array([[1.2, 0.7]]),\n            \"noise_sigma\": 5.0e-3\n        }\n    ]\n\n    all_results = []\n    \n    # Define the non-parametric basis for diffusion coefficients\n    N_D = 256\n    D_grid = np.logspace(np.log10(1.0e-10), np.log10(2.0e-9), N_D)\n\n    for case in test_cases:\n        gamma = case[\"gamma\"]\n        delta = case[\"delta\"]\n        Delta = case[\"Delta\"]\n        g_array = case[\"g\"]\n        D_true = case[\"D_true\"]\n        K = case[\"K\"]\n        S = case[\"S\"]\n        sigma = case[\"noise_sigma\"]\n\n        # 1. Generate Synthetic Data\n        # Calculate b-values based on the Stejskal-Tanner equation\n        b_values = (gamma * g_array * delta)**2 * (Delta - delta / 3.0)\n\n        # Reshape for broadcasting\n        b_col = b_values[:, np.newaxis]\n        D_row = D_true[np.newaxis, :]\n        \n        # Attenuation matrix A (M x K)\n        A_true = np.exp(-b_col * D_row)\n        \n        # Noiseless data matrix Y = A * S (M x J)\n        Y_noiseless = A_true @ S\n\n        # Add zero-mean Gaussian noise\n        noise = np.random.normal(0, sigma, Y_noiseless.shape)\n        Y_noisy = Y_noiseless + noise\n\n        # 2. Set up the Inverse Problem\n        # Dictionary matrix A_dict (M x N_D)\n        A_dict = np.exp(-b_col * D_grid[np.newaxis, :])\n\n        # 3. Solve NNLS and Aggregate\n        J = S.shape[1] # Number of spectral variables\n        C_matrix = np.zeros((N_D, J))\n        \n        for j in range(J):\n            y_j = Y_noisy[:, j]\n            # Ensure data is non-negative before NNLS, as negative values are unphysical\n            y_j[y_j < 0] = 0\n            c_j, _ = nnls(A_dict, y_j)\n            C_matrix[:, j] = c_j\n\n        # Aggregate to form global diffusion profile\n        c_total = np.sum(C_matrix, axis=1)\n\n        # 4. Peak Picking and Refinement\n        # Find all peaks in the total coefficient vector\n        peak_indices, _ = find_peaks(c_total, prominence=c_total.max()*0.01) # Use small prominence to catch all relevant peaks\n\n        if len(peak_indices) < K:\n            # If not enough peaks found, take the indices with highest values\n            peak_indices = np.argsort(c_total)[-K:]\n        else:\n            # Select K most prominent peaks\n            peak_heights = c_total[peak_indices]\n            top_k_peak_indices = np.argsort(peak_heights)[-K:]\n            peak_indices = peak_indices[top_k_peak_indices]\n        \n        # Refine estimates using a local center-of-mass (3-point window)\n        estimated_D = []\n        refinement_window_half_width = 1\n        for p_idx in peak_indices:\n            start = max(0, p_idx - refinement_window_half_width)\n            end = min(N_D, p_idx + refinement_window_half_width + 1)\n            \n            window_coeffs = c_total[start:end]\n            window_D_values = D_grid[start:end]\n            \n            numerator = np.sum(window_coeffs * window_D_values)\n            denominator = np.sum(window_coeffs)\n            \n            if denominator > 0:\n                refined_d = numerator / denominator\n                estimated_D.append(refined_d)\n            else: # Fallback to grid value if window coefficients are all zero\n                estimated_D.append(D_grid[p_idx])\n\n        # 5. Format Results\n        estimated_D.sort()\n        \n        # Format to 3 significant figures in scientific notation\n        formatted_results = [f\"{d:.2e}\" for d in estimated_D]\n        all_results.append(f\"[{','.join(formatted_results)}]\")\n\n    # Final print statement in the exact required format\n    print(f\"[{','.join(all_results)}]\")\n\nif __name__ == \"__main__\":\n    # Ensure deterministic results for reproducibility\n    np.random.seed(42)\n    solve()\n```", "id": "3699327"}]}