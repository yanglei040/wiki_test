{"hands_on_practices": [{"introduction": "The power of high-resolution mass spectrometry (HRMS) lies in its ability to measure mass-to-charge ratios with extraordinary precision. This precision is what allows us to distinguish between different molecular formulas that have very similar nominal masses. This first exercise [@problem_id:3706955] provides a quantitative look at the relationship between mass accuracy, expressed in parts-per-million (ppm), and the ability to unambiguously identify a compound from a list of candidates.", "problem": "An organic analyte produces a high-resolution monoisotopic peak at mass-to-charge ratio $m/z = 300.0000$ in an Orbitrap mass spectrometer. Two distinct candidate elemental formulas are consistent with the isotopic pattern and yield theoretical exact masses separated by an amount $\\Delta m = 0.0008$ Da around $m/z = 300.0000$. The instrumentâ€™s mass measurement error can be modeled as a symmetric bound of $\\pm \\delta m$ (in Daltons) around the true mass, where $\\delta m$ is the maximum absolute error. Starting from the definition of mass accuracy in parts-per-million (ppm) as $\\mathrm{ppm} = (\\delta m/m) \\times 10^{6}$ and the requirement that confidence intervals around competing exact masses do not overlap, determine the maximum allowable mass accuracy (in ppm) that guarantees unambiguous discrimination between the two candidate formulas based solely on the measured monoisotopic peak at $m/z = 300.0000$. Round your final numeric answer to three significant figures and express it in ppm.", "solution": "The problem requires determining the maximum allowable mass accuracy, expressed in parts-per-million (ppm), that ensures the unambiguous discrimination between two candidate chemical formulas based on a high-resolution mass measurement.\n\nProblem Validation:\nStep 1: Extract Givens\n- Measured mass-to-charge ratio: $m/z = 300.0000$. Assuming a singly charged ion ($z=1$), the measured mass is $m = 300.0000$ Da.\n- Theoretical mass difference between two candidates: $\\Delta m = 0.0008$ Da.\n- Instrument mass measurement error model: A symmetric bound of $\\pm \\delta m$ around the true mass.\n- Definition of mass accuracy: $\\mathrm{ppm} = (\\delta m/m) \\times 10^{6}$.\n- Condition for unambiguous discrimination: The confidence intervals around the competing exact masses must not overlap.\n- Required precision for final answer: Round to three significant figures.\n\nStep 2: Validate Using Extracted Givens\nThe problem is scientifically grounded, deriving from the fundamental principles of high-resolution mass spectrometry for elemental composition analysis. The given values are realistic for organic molecules analyzed on modern instrumentation like an Orbitrap. The problem is well-posed, providing all necessary definitions and constraints to arrive at a unique, meaningful solution. It is stated objectively and contains no internal contradictions or missing information.\n\nStep 3: Verdict and Action\nThe problem is deemed valid. A solution will be formulated.\n\nSolution Formulation:\nLet the theoretical exact masses of the two candidate formulas be $m_1$ and $m_2$. The problem states that they are separated by $\\Delta m = |m_2 - m_1| = 0.0008$ Da.\n\nThe mass measurement for any true mass $m_{true}$ is associated with an uncertainty, resulting in a measured mass that lies within a confidence interval. Based on the given error model, this interval is defined as $[m_{true} - \\delta m, m_{true} + \\delta m]$, where $\\delta m$ is the maximum absolute error. The full width of this interval is $2\\delta m$.\n\nFor the two candidate formulas with masses $m_1$ and $m_2$ to be unambiguously discriminated, their respective confidence intervals must not overlap. Let us assume, without loss of generality, that $m_2 > m_1$.\nThe confidence interval for the first candidate is $I_1 = [m_1 - \\delta m, m_1 + \\delta m]$.\nThe confidence interval for the second candidate is $I_2 = [m_2 - \\delta m, m_2 + \\delta m]$.\n\nThe condition for non-overlap is that the upper bound of the lower-mass interval ($I_1$) must be less than or equal to the lower bound of the higher-mass interval ($I_2$). This establishes the boundary condition for discrimination.\n$$m_1 + \\delta m \\le m_2 - \\delta m$$\nRearranging this inequality to solve for the mass separation gives:\n$$2\\delta m \\le m_2 - m_1$$\nSubstituting the given mass difference, $\\Delta m = m_2 - m_1$:\n$$2\\delta m \\le \\Delta m$$\nThis inequality defines the relationship between the instrument's absolute mass error and the mass difference required for discrimination. To guarantee discrimination, the instrument's maximum absolute error $\\delta m$ must be no more than half the mass difference between the two species. The maximum allowable error, which we denote $\\delta m_{max}$, corresponds to the equality, where the intervals just touch:\n$$2\\delta m_{max} = \\Delta m$$\n$$\\delta m_{max} = \\frac{\\Delta m}{2}$$\nSubstituting the given value of $\\Delta m = 0.0008$ Da:\n$$\\delta m_{max} = \\frac{0.0008 \\text{ Da}}{2} = 0.0004 \\text{ Da}$$\nThis is the largest absolute mass error the instrument can have while still being able to distinguish the two candidates.\n\nNext, we convert this maximum absolute error into the corresponding mass accuracy in parts-per-million (ppm), using the provided definition:\n$$\\mathrm{ppm} = \\left( \\frac{\\delta m}{m} \\right) \\times 10^{6}$$\nThe \"maximum allowable mass accuracy\" corresponds to the ppm value calculated with the maximum allowable error, $\\delta m_{max}$. The mass $m$ here is the mass at which the measurement is made, given as $m/z = 300.0000$. We assume $z=1$, thus $m = 300.0000$ Da.\n$$\\mathrm{ppm}_{max} = \\left( \\frac{\\delta m_{max}}{m} \\right) \\times 10^{6}$$\nSubstituting the values for $\\delta m_{max}$ and $m$:\n$$\\mathrm{ppm}_{max} = \\left( \\frac{0.0004}{300.0000} \\right) \\times 10^{6}$$\nPerforming the calculation:\n$$\\mathrm{ppm}_{max} = \\left( \\frac{4 \\times 10^{-4}}{3 \\times 10^{2}} \\right) \\times 10^{6} = \\left( \\frac{4}{3} \\times 10^{-6} \\right) \\times 10^{6} = \\frac{4}{3}$$\nThe exact value is $\\frac{4}{3}$, which is approximately $1.333...$ ppm. An instrument must have a mass accuracy equal to or better than this value (i.e., a smaller ppm number) to resolve the two candidates. The question asks for this maximum allowable value.\n\nFinally, rounding the result to three significant figures as required:\n$$\\mathrm{ppm}_{max} \\approx 1.33$$", "answer": "$$\\boxed{1.33}$$", "id": "3706955"}, {"introduction": "Beyond precise mass measurement, HRMS provides rich isotopic patterns that encode critical information about the analyte. One of the most fundamental parameters we can extract is the charge state ($z$) of the ion, which is essential for calculating the correct neutral mass. This practice [@problem_id:3706913] demonstrates how to determine the charge state by simply measuring the $m/z$ spacing between adjacent isotopic peaks, a cornerstone technique in analyzing data from methods like electrospray ionization (ESI).", "problem": "A singly observed isotopic pair in High Resolution Mass Spectrometry (HRMS) for an organic analyte shows two adjacent peaks in mass-to-charge ratio $m/z$ separated by $0.3345\\ \\mathrm{Th}$, where the Thomson unit ($\\mathrm{Th}$) is defined such that $1\\ \\mathrm{Th} = 1\\ \\mathrm{u}$ per elementary charge. Assume the isotopic pair differs by the substitution of one $^{13}\\mathrm{C}$ for one $^{12}\\mathrm{C}$ and that the charge state is the same for both peaks. The exact atomic masses are $m(^{12}\\mathrm{C}) = 12.000000000\\ \\mathrm{u}$ (by definition) and $m(^{13}\\mathrm{C}) = 13.003354835\\ \\mathrm{u}$. Neglect electron binding energies and any isotopic fine structure beyond the single carbon substitution.\n\nStarting from the definition of $m/z$ and the fact that isotopologues differing by one $^{13}\\mathrm{C}$ substitution differ in neutral mass by $m(^{13}\\mathrm{C}) - m(^{12}\\mathrm{C})$, determine the integer charge state $z$ implied by the observed $m/z$ spacing. Then, evaluate whether $z=3$ is consistent within a $1\\%$ tolerance by comparing the observed spacing to the spacing predicted if $z=3$.\n\nExpress the final answer as the inferred integer charge state $z$ (dimensionless). No rounding instructions apply to the final answer.", "solution": "The problem requires the determination of the integer charge state $z$ of an analyte, given the mass-to-charge ratio ($m/z$) spacing of an isotopic doublet observed in a high-resolution mass spectrum.\n\nThe mass-to-charge ratio, denoted as $m/z$, is the ratio of the mass $m$ of an ion to its charge number $z$. For two isotopologues with neutral masses $m_1$ and $m_2$ that form ions with the same charge state $z$, the corresponding mass-to-charge ratios are $(m/z)_1 = m_1/z$ and $(m/z)_2 = m_2/z$. The problem directs to neglect electron binding energies, and it is a standard approximation in mass spectrometry to equate the ion mass with the neutral molecular mass, as the mass of electrons is negligible in comparison.\n\nThe spacing between the two peaks in the mass spectrum, $\\Delta(m/z)$, is the difference in their $m/z$ values:\n$$ \\Delta(m/z) = (m/z)_2 - (m/z)_1 = \\frac{m_2}{z} - \\frac{m_1}{z} = \\frac{m_2 - m_1}{z} $$\nLet $\\Delta m = m_2 - m_1$ represent the difference in the neutral masses of the two isotopologues. The equation can be rearranged as:\n$$ \\Delta(m/z) = \\frac{\\Delta m}{z} $$\nThis fundamental relationship allows for the determination of the charge state $z$ if the mass difference $\\Delta m$ and the $m/z$ spacing are known.\n\nAccording to the problem statement, the isotopic pair differs by the substitution of a single carbon-13 atom ($^{13}\\mathrm{C}$) for a carbon-12 atom ($^{12}\\mathrm{C}$). The mass difference $\\Delta m$ is therefore the difference between the exact atomic masses of these two nuclides.\nThe given values are:\n- Mass of $^{13}\\mathrm{C}$: $m(^{13}\\mathrm{C}) = 13.003354835\\ \\mathrm{u}$\n- Mass of $^{12}\\mathrm{C}$: $m(^{12}\\mathrm{C}) = 12.000000000\\ \\mathrm{u}$\n\nThe mass difference $\\Delta m$ is calculated as:\n$$ \\Delta m = m(^{13}\\mathrm{C}) - m(^{12}\\mathrm{C}) = 13.003354835\\ \\mathrm{u} - 12.000000000\\ \\mathrm{u} = 1.003354835\\ \\mathrm{u} $$\nThe observed spacing between the peaks is given as $\\Delta(m/z)_{obs} = 0.3345\\ \\mathrm{Th}$. The Thomson unit ($\\mathrm{Th}$) is defined as $1\\ \\mathrm{Th} = 1\\ \\mathrm{u}$ per elementary charge, which means the numerical value of the $m/z$ spacing in Th is directly applicable in our equation where mass is in $\\mathrm{u}$ and $z$ is a dimensionless integer.\n\nWe can now solve the equation for the charge state $z$:\n$$ z = \\frac{\\Delta m}{\\Delta(m/z)_{obs}} $$\nSubstituting the numerical values:\n$$ z = \\frac{1.003354835}{0.3345} \\approx 2.99956602 $$\nSince the charge state $z$ must be an integer, we round this calculated value to the nearest integer to find the inferred charge state.\n$$ z_{inferred} = 3 $$\n\nThe second part of the problem asks to evaluate whether $z=3$ is consistent with the observed spacing within a $1\\%$ tolerance. To verify this, we calculate the theoretical $m/z$ spacing that would be predicted for a charge state of $z=3$, denoted as $\\Delta(m/z)_{pred, z=3}$.\n$$ \\Delta(m/z)_{pred, z=3} = \\frac{\\Delta m}{3} = \\frac{1.003354835\\ \\mathrm{u}}{3} \\approx 0.3344516117\\ \\mathrm{Th} $$\nWe then compare this predicted value to the observed value, $\\Delta(m/z)_{obs} = 0.3345\\ \\mathrm{Th}$, by calculating the relative percent difference. It is conventional to use the theoretical (predicted) value as the reference for this comparison.\n$$ \\text{Relative Difference} (\\%) = \\left| \\frac{\\Delta(m/z)_{obs} - \\Delta(m/z)_{pred, z=3}}{\\Delta(m/z)_{pred, z=3}} \\right| \\times 100\\% $$\n$$ \\text{Relative Difference} (\\%) = \\left| \\frac{0.3345 - 0.3344516117}{0.3344516117} \\right| \\times 100\\% $$\n$$ \\text{Relative Difference} (\\%) = \\left| \\frac{0.0000483883}{0.3344516117} \\right| \\times 100\\% \\approx 0.014468\\% $$\nThis relative difference of approximately $0.014\\%$ is substantially less than the specified tolerance of $1\\%$. Thus, the observed data are highly consistent with an integer charge state of $z=3$.\n\nThe problem primarily asks for the inferred integer charge state $z$. Based on our calculation, this is $z=3$.", "answer": "$$\\boxed{3}$$", "id": "3706913"}, {"introduction": "Identifying a single correct molecular formula from HRMS data is rarely achieved through one single filter. Modern analysis relies on integrating multiple, orthogonal pieces of information into a cohesive scoring model to rank candidate formulas with high confidence. This final capstone exercise [@problem_id:3706905] challenges you to build such a model, synthesizing concepts like mass accuracy, Double Bond Equivalents (DBE), and isotopic pattern fitting into a single, powerful workflow that mimics real-world bioinformatics software.", "problem": "A high-resolution mass spectrometry scenario is provided where the task is to score candidate molecular formulas using a composite metric derived from first principles and select the top-ranked formula for each test case. The problem focuses on combining measurement error in parts-per-million (ppm), Double Bond Equivalent (DBE) plausibility, isotopic pattern fit using chi-square, and adduct consistency. The final output must be a single line with the selected indices for each test case. All calculations must be based on fundamental definitions and well-tested facts relevant to spectrometric identification of organic compounds and high-resolution mass spectrometry for molecular formula determination.\n\nGiven definitions and facts:\n- High Resolution Mass Spectrometry (HRMS) reports the mass-to-charge ratio $m/z$ and isotopic peak intensities as relative abundances.\n- Monoisotopic masses (in daltons, $\\mathrm{Da}$) used:\n  - $m_{\\mathrm{^{12}C}} = 12.00000000000$\n  - $m_{\\mathrm{^{1}H}} = 1.00782503223$\n  - $m_{\\mathrm{^{14}N}} = 14.00307400443$\n  - $m_{\\mathrm{^{16}O}} = 15.99491461957$\n  - $m_{\\mathrm{^{32}S}} = 31.97207117440$\n  - $m_{\\mathrm{^{35}Cl}} = 34.96885268200$\n- Common adduct masses and charge states:\n  - Proton: $m_{\\mathrm{H^+}} = 1.007276466812$, adduct $[\\mathrm{M}+\\mathrm{H}]^+$.\n  - Sodium: $m_{\\mathrm{Na^+}} = 22.989218$, adduct $[\\mathrm{M}+\\mathrm{Na}]^+$.\n  - Double protonation: $2\\,m_{\\mathrm{H^+}}$, adduct $[\\mathrm{M}+2\\mathrm{H}]^{2+}$.\n- Parts-per-million (ppm) mass error is defined for observed $m/z$ as $\\mathrm{ppm} = 10^6 \\cdot \\dfrac{m_{\\mathrm{obs}} - m_{\\mathrm{theo}}}{m_{\\mathrm{theo}}}$.\n- Double Bond Equivalent (DBE) for composition $\\mathrm{C}_c\\mathrm{H}_h\\mathrm{N}_n\\mathrm{O}_o\\mathrm{S}_s\\mathrm{Cl}_x$ is defined (for typical organic compositions treating oxygen and sulfur as valence $2$ elements, halogens as monovalent) by $\\mathrm{DBE} = c - \\dfrac{h}{2} + \\dfrac{n}{2} + 1 - \\dfrac{x}{2}$.\n- Isotopic abundances used to approximate the first three isotope peaks:\n  - $p_{\\mathrm{^{13}C}} = 0.0107$, $p_{\\mathrm{^{2}H}} = 0.000115$, $p_{\\mathrm{^{15}N}} = 0.00364$, $p_{\\mathrm{^{17}O}} = 0.00038$, $p_{\\mathrm{^{18}O}} = 0.00205$, $p_{\\mathrm{^{33}S}} = 0.0075$, $p_{\\mathrm{^{34}S}} = 0.0429$, $p_{\\mathrm{^{37}Cl}} = 0.2422$.\n- Approximate predicted isotopic intensities for the monoisotopic peak $M$, the $M+1$ peak, and the $M+2$ peak are computed from binomial and pairwise contributions:\n  - $f_{1} \\approx c\\,p_{\\mathrm{^{13}C}} + h\\,p_{\\mathrm{^{2}H}} + n\\,p_{\\mathrm{^{15}N}} + o\\,p_{\\mathrm{^{17}O}} + s\\,p_{\\mathrm{^{33}S}}$.\n  - $f_{2} \\approx \\dfrac{c(c-1)}{2} p_{\\mathrm{^{13}C}}^2 + o\\,p_{\\mathrm{^{18}O}} + s\\,p_{\\mathrm{^{34}S}} + x\\,p_{\\mathrm{^{37}Cl}} + \\dfrac{n(n-1)}{2} p_{\\mathrm{^{15}N}}^2 + c n\\, p_{\\mathrm{^{13}C}} p_{\\mathrm{^{15}N}} + c h\\, p_{\\mathrm{^{13}C}} p_{\\mathrm{^{2}H}} + c o\\, p_{\\mathrm{^{13}C}} p_{\\mathrm{^{17}O}}$.\n  - $f_{0} = \\max\\!\\big(0,\\,1 - (f_{1} + f_{2})\\big)$, followed by normalization so that $f_{0} + f_{1} + f_{2} = 1$.\n- The isotopic fit chi-square is defined as $\\chi^2 = \\sum_{k \\in \\{0,1,2\\}} \\dfrac{(I^{\\mathrm{obs}}_k - I^{\\mathrm{exp}}_k)^2}{\\max(I^{\\mathrm{exp}}_k, \\epsilon)}$ with $I^{\\mathrm{obs}}_k$ and $I^{\\mathrm{exp}}_k$ normalized to sum to $1$ and $\\epsilon = 10^{-12}$.\n- Adduct consistency assigns zero penalty when $|\\mathrm{ppm}| \\le \\mathrm{ppm}_{\\mathrm{tol}}$ and a unit penalty otherwise.\n\nComposite metric:\n- For each candidate formula, compute the composite score $S$ as $S = w_1 \\cdot E_{\\mathrm{ppm}} + w_2 \\cdot P_{\\mathrm{DBE}} + w_3 \\cdot \\chi^2 + w_4 \\cdot P_{\\mathrm{adduct}}$, where $E_{\\mathrm{ppm}} = \\dfrac{|\\mathrm{ppm}|}{\\mathrm{ppm}_{\\mathrm{tol}}}$, $P_{\\mathrm{adduct}} \\in \\{0,1\\}$ is the adduct consistency penalty as defined, and $P_{\\mathrm{DBE}}$ is the DBE plausibility penalty given by\n  - $P_{\\mathrm{DBE}} = (-\\mathrm{DBE})^2 + 1$ if $\\mathrm{DBE} < 0$,\n  - $P_{\\mathrm{DBE}} = 0.25$ if $\\mathrm{DBE}$ is not an integer within tolerance $10^{-6}$,\n  - $P_{\\mathrm{DBE}} = 0$ otherwise.\n\nYour program must, for each test case, compute $S$ for all candidates and select the index (zero-based) of the formula with the smallest $S$ (ties broken by the smallest index). The final output must be a single line containing a comma-separated list of these indices enclosed in square brackets, such as $[\\mathrm{result}_1,\\mathrm{result}_2,\\mathrm{result}_3]$.\n\nTest suite:\n- Test Case $1$ (general case):\n  - Observed $m/z$: $263.08910\\,\\mathrm{Th}$.\n  - Adduct: $[\\mathrm{M}+\\mathrm{Na}]^+$, charge $z = 1$.\n  - $\\mathrm{ppm}_{\\mathrm{tol}} = 5.0$.\n  - Weights $(w_1,w_2,w_3,w_4) = (1.0, 2.0, 5.0, 10.0)$.\n  - Observed isotopic intensities $(I^{\\mathrm{obs}}_0, I^{\\mathrm{obs}}_1, I^{\\mathrm{obs}}_2) = (0.85, 0.13, 0.02)$.\n  - Candidates (in order, zero-based indexing) as $(c,h,n,o,s,x)$:\n    - $0$: $(12,16,0,5,0,0)$\n    - $1$: $(13,16,0,4,0,0)$\n    - $2$: $(10,14,0,6,0,0)$\n    - $3$: $(12,18,0,4,0,0)$\n- Test Case $2$ (boundary condition at tolerance):\n  - Observed $m/z$: $175.016523311373\\,\\mathrm{Th}$.\n  - Adduct: $[\\mathrm{M}+\\mathrm{H}]^+$, charge $z = 1$.\n  - $\\mathrm{ppm}_{\\mathrm{tol}} = 5.0$.\n  - Weights $(w_1,w_2,w_3,w_4) = (1.0, 2.0, 5.0, 10.0)$.\n  - Observed isotopic intensities $(I^{\\mathrm{obs}}_0, I^{\\mathrm{obs}}_1, I^{\\mathrm{obs}}_2) = (0.72, 0.06, 0.22)$.\n  - Candidates $(c,h,n,o,s,x)$:\n    - $0$: $(7,7,0,3,0,1)$\n    - $1$: $(8,11,0,4,0,0)$\n    - $2$: $(9,9,1,3,0,0)$\n- Test Case $3$ (edge case with doubly charged adduct):\n  - Observed $m/z$: $162.091345\\,\\mathrm{Th}$.\n  - Adduct: $[\\mathrm{M}+2\\mathrm{H}]^{2+}$, charge $z = 2$.\n  - $\\mathrm{ppm}_{\\mathrm{tol}} = 5.0$.\n  - Weights $(w_1,w_2,w_3,w_4) = (1.0, 2.0, 5.0, 10.0)$.\n  - Observed isotopic intensities $(I^{\\mathrm{obs}}_0, I^{\\mathrm{obs}}_1, I^{\\mathrm{obs}}_2) = (0.75, 0.22, 0.03)$.\n  - Candidates $(c,h,n,o,s,x)$:\n    - $0$: $(20,22,2,2,0,0)$\n    - $1$: $(10,20,2,5,0,0)$\n    - $2$: $(21,18,0,2,0,0)$\n\nProgram requirements:\n- Implement the composite scoring described above directly from the provided definitions.\n- Compute monoisotopic masses, theoretical $m/z$ according to adduct and charge, ppm error, DBE, isotopic predictions, chi-square, adduct penalty, and composite score for each candidate.\n- Select the index of the candidate with the minimum composite score for each test case.\n- Your program should produce a single line of output containing the indices for the three test cases in the format $[\\mathrm{index}_1,\\mathrm{index}_2,\\mathrm{index}_3]$.", "solution": "The problem requires the implementation of a composite scoring model to rank candidate molecular formulas based on high-resolution mass spectrometry (HRMS) data. The solution involves a systematic, step-by-step calculation of a score, $S$, for each candidate. The candidate with the minimum score is selected. The process is deterministic and grounded in the fundamental principles of mass spectrometry.\n\nThe composite score $S$ is defined as a weighted sum of four metrics:\n$$S = w_1 \\cdot E_{\\mathrm{ppm}} + w_2 \\cdot P_{\\mathrm{DBE}} + w_3 \\cdot \\chi^2 + w_4 \\cdot P_{\\mathrm{adduct}}$$\nEach component of the score is calculated as follows.\n\nFirst, we define the necessary physical constants and elemental compositions.\nThe monoisotopic masses are: $m_{\\mathrm{^{12}C}} = 12.00000000000\\,\\mathrm{Da}$, $m_{\\mathrm{^{1}H}} = 1.00782503223\\,\\mathrm{Da}$, $m_{\\mathrm{^{14}N}} = 14.00307400443\\,\\mathrm{Da}$, $m_{\\mathrm{^{16}O}} = 15.99491461957\\,\\mathrm{Da}$, $m_{\\mathrm{^{32}S}} = 31.97207117440\\,\\mathrm{Da}$, and $m_{\\mathrm{^{35}Cl}} = 34.96885268200\\,\\mathrm{Da}$.\nThe adduct masses are: $m_{\\mathrm{H^+}} = 1.007276466812\\,\\mathrm{Da}$ and $m_{\\mathrm{Na^+}} = 22.989218\\,\\mathrm{Da}$.\nA candidate formula is represented by the counts of each element: $(c, h, n, o, s, x)$ for $\\mathrm{C}_c\\mathrm{H}_h\\mathrm{N}_n\\mathrm{O}_o\\mathrm{S}_s\\mathrm{Cl}_x$.\n\n**Step 1: Theoretical Mass and Mass-to-Charge Ratio ($m/z$) Calculation**\nThe theoretical monoisotopic mass, $M_{\\mathrm{theo}}$, of a neutral molecule is the sum of the masses of its constituent atoms:\n$$M_{\\mathrm{theo}} = c \\cdot m_{\\mathrm{^{12}C}} + h \\cdot m_{\\mathrm{^{1}H}} + n \\cdot m_{\\mathrm{^{14}N}} + o \\cdot m_{\\mathrm{^{16}O}} + s \\cdot m_{\\mathrm{^{32}S}} + x \\cdot m_{\\mathrm{^{35}Cl}}$$\nThe theoretical mass-to-charge ratio, $m_{\\mathrm{theo}}$, is calculated based on the molecular mass, the adduct type, and the charge state $z$:\n$$m_{\\mathrm{theo}} = \\frac{M_{\\mathrm{theo}} + M_{\\mathrm{adduct}}}{z}$$\nWhere $M_{\\mathrm{adduct}}$ is the total mass of the adduct species (e.g., $m_{\\mathrm{Na^+}}$ for $[\\mathrm{M}+\\mathrm{Na}]^+$ or $2 \\cdot m_{\\mathrm{H^+}}$ for $[\\mathrm{M}+2\\mathrm{H}]^{2+}$) and $z$ is the absolute value of the charge number (e.g., $z=1$ for $[\\mathrm{M}+\\mathrm{Na}]^+$ and $z=2$ for $[\\mathrm{M}+2\\mathrm{H}]^{2+}$).\n\n**Step 2: Mass Error ($E_{\\mathrm{ppm}}$) and Adduct Penalty ($P_{\\mathrm{adduct}}$)**\nThe mass measurement error in parts-per-million (ppm) is calculated by comparing the observed $m/z$, $m_{\\mathrm{obs}}$, with the theoretical $m/z$, $m_{\\mathrm{theo}}$:\n$$\\mathrm{ppm} = 10^6 \\cdot \\frac{m_{\\mathrm{obs}} - m_{\\mathrm{theo}}}{m_{\\mathrm{theo}}}$$\nThe mass error score component, $E_{\\mathrm{ppm}}$, is the absolute ppm error normalized by the tolerance, $\\mathrm{ppm}_{\\mathrm{tol}}$:\n$$E_{\\mathrm{ppm}} = \\frac{|\\mathrm{ppm}|}{\\mathrm{ppm}_{\\mathrm{tol}}}$$\nThe adduct consistency penalty, $P_{\\mathrm{adduct}}$, is a binary penalty. It is $0$ if the absolute ppm error is within the tolerance and $1$ otherwise:\n$$P_{\\mathrm{adduct}} = \\begin{cases} 0 & \\text{if } |\\mathrm{ppm}| \\le \\mathrm{ppm}_{\\mathrm{tol}} \\\\ 1 & \\text{if } |\\mathrm{ppm}| > \\mathrm{ppm}_{\\mathrm{tol}} \\end{cases}$$\n\n**Step 3: Double Bond Equivalent (DBE) Penalty ($P_{\\mathrm{DBE}}$)**\nThe Double Bond Equivalent (DBE), which represents the number of rings and double bonds in a molecule, is calculated using the valencies of the elements:\n$$\\mathrm{DBE} = c - \\frac{h}{2} + \\frac{n}{2} + 1 - \\frac{x}{2}$$\nThe DBE plausibility penalty, $P_{\\mathrm{DBE}}$, penalizes formulas that are chemically unlikely. For neutral, closed-shell organic molecules, the DBE must be a non-negative integer.\n$$P_{\\mathrm{DBE}} = \\begin{cases} (-\\mathrm{DBE})^2 + 1 & \\text{if } \\mathrm{DBE} < 0 \\\\ 0.25 & \\text{if } |\\mathrm{DBE} - \\mathrm{round}(\\mathrm{DBE})| > 10^{-6} \\\\ 0 & \\text{otherwise} \\end{cases}$$\nThe tolerance of $10^{-6}$ is used to account for floating-point arithmetic inaccuracies when checking for non-integer values.\n\n**Step 4: Isotopic Pattern Fit ($\\chi^2$)**\nThe fit between the observed and theoretical isotopic patterns is quantified using a chi-square ($\\chi^2$) statistic.\nFirst, the relative intensities of the M+1 ($f_1$) and M+2 ($f_2$) isotopic peaks are approximated based on natural isotopic abundances ($p$):\n$$f_{1} \\approx c\\,p_{\\mathrm{^{13}C}} + h\\,p_{\\mathrm{^{2}H}} + n\\,p_{\\mathrm{^{15}N}} + o\\,p_{\\mathrm{^{17}O}} + s\\,p_{\\mathrm{^{33}S}}$$\n$$f_{2} \\approx \\frac{c(c-1)}{2} p_{\\mathrm{^{13}C}}^2 + o\\,p_{\\mathrm{^{18}O}} + s\\,p_{\\mathrm{^{34}S}} + x\\,p_{\\mathrm{^{37}Cl}} + \\frac{n(n-1)}{2} p_{\\mathrm{^{15}N}}^2 + c n p_{\\mathrm{^{13}C}} p_{\\mathrm{^{15}N}} + c h p_{\\mathrm{^{13}C}} p_{\\mathrm{^{2}H}} + c o p_{\\mathrm{^{13}C}} p_{\\mathrm{^{17}O}}$$\nThe isotopic abundances used are: $p_{\\mathrm{^{13}C}} = 0.0107$, $p_{\\mathrm{^{2}H}} = 0.000115$, $p_{\\mathrm{^{15}N}} = 0.00364$, $p_{\\mathrm{^{17}O}} = 0.00038$, $p_{\\mathrm{^{18}O}} = 0.00205$, $p_{\\mathrm{^{33}S}} = 0.0075$, $p_{\\mathrm{^{34}S}} = 0.0429$, $p_{\\mathrm{^{37}Cl}} = 0.2422$.\nThese raw relative abundances are then used to generate a normalized probability distribution for the first three isotopic peaks ($M$, $M+1$, $M+2$). Let $f_0^{raw} = \\max(0, 1 - (f_1+f_2))$. The total unnormalized sum is $F_{total} = f_0^{raw} + f_1 + f_2$. The expected normalized intensities $I^{\\mathrm{exp}}_k$ are:\n$$I^{\\mathrm{exp}}_0 = f_0^{raw} / F_{total}, \\quad I^{\\mathrm{exp}}_1 = f_1 / F_{total}, \\quad I^{\\mathrm{exp}}_2 = f_2 / F_{total}$$\nThe observed intensities $I^{\\mathrm{obs}}_k$ are also normalized to sum to $1$. The chi-square statistic is then:\n$$\\chi^2 = \\sum_{k \\in \\{0,1,2\\}} \\frac{(I^{\\mathrm{obs}}_k - I^{\\mathrm{exp}}_k)^2}{\\max(I^{\\mathrm{exp}}_k, \\epsilon)}$$\nwhere $\\epsilon = 10^{-12}$ is a small constant to prevent division by zero.\n\n**Algorithmic Procedure**\nFor each test case provided:\n1.  Initialize a list to store the composite scores $S$ for all candidate formulas.\n2.  For each candidate formula $(c, h, n, o, s, x)$:\n    a. Calculate the theoretical molecular mass $M_{\\mathrm{theo}}$ and the theoretical $m/z$ ratio $m_{\\mathrm{theo}}$ based on the specified adduct.\n    b. Compute the ppm error, the error score $E_{\\mathrm{ppm}}$, and the adduct penalty $P_{\\mathrm{adduct}}$.\n    c. Compute the DBE and its associated penalty $P_{\\mathrm{DBE}}$.\n    d. Compute the theoretical isotopic intensities $I^{\\mathrm{exp}}_k$ and the $\\chi^2$ value against the observed intensities $I^{\\mathrm{obs}}_k$.\n    e. Combine these values using the given weights $(w_1, w_2, w_3, w_4)$ to calculate the final composite score $S$.\n3.  After calculating $S$ for all candidates in a test case, identify the index of the candidate with the minimum score. Ties are broken by choosing the smaller index.\n4.  The selected indices for all test cases are collected and formatted into the final output string.\n\nThis comprehensive, step-by-step process ensures that each candidate formula is rigorously evaluated against the experimental data according to the specified model, leading to a unique and verifiable selection. This entire procedure will be implemented in the provided Python program.", "answer": "[1,0,0]", "id": "3706905"}]}