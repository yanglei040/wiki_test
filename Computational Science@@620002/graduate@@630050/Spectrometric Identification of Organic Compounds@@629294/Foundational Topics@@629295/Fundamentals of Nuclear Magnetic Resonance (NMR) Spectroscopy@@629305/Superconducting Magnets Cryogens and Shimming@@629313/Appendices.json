{"hands_on_practices": [{"introduction": "A key characteristic of a superconducting magnet operating in persistent mode is its long-term field stability. However, the field is not perfectly constant; it undergoes a slow, predictable decay due to a quantum mechanical phenomenon known as \"flux creep.\" This practice explores the physical origins of this drift, guiding you to derive the characteristic logarithmic time dependence from fundamental principles of superconductivity and then use this model to analyze and forecast a magnet's performance based on experimental data [@problem_id:3726334].", "problem": "A superconducting magnet used for Nuclear Magnetic Resonance (NMR) spectrometric identification of organic compounds operates in persistent mode and is cooled by Liquid Helium (LHe), with Liquid Nitrogen (LN2) as a radiation shield. In persistent mode, the field in the magnet bore changes slowly due to thermally activated motion of quantized vortices (flux creep) across pinning sites. The field drift affects the spectrometer’s frequency lock and the long-term stability of the proton resonance used for chemical shift referencing and shimming.\n\nStarting from the following well-tested physical bases and core definitions:\n- Magnetic induction is proportional to the transport current in the magnet winding, $B \\propto I$. In a long, uniform solenoid, $B = \\mu_0 n I$, where $\\mu_0$ is the permeability of free space and $n$ is the turn density, but the proportionality is sufficient for the derivation.\n- Flux creep is thermally activated vortex motion. In a pinned vortex lattice with an Anderson–Kim barrier, the activation energy depends on the current density as $U(J) = U_0 \\left(1 - \\frac{J}{J_c}\\right)$, where $U_0$ is a characteristic pinning energy and $J_c$ the critical current density.\n- The creep rate follows an Arrhenius law: $v \\propto \\exp\\!\\left[-\\frac{U(J)}{k_{\\mathrm{B}} T}\\right]$, where $k_{\\mathrm{B}}$ is the Boltzmann constant and $T$ is the temperature.\n- The electric field due to vortex motion is $E \\sim B v$; the macroscopic decay of the transport current is governed by $dJ/dt$ that inherits the Arrhenius factor through $U(J)$.\n- The resonance frequency $f$ of a nucleus in a static field $B$ is given by $f = \\left(\\frac{\\gamma}{2\\pi}\\right) B$, where $\\gamma$ is the gyromagnetic ratio. For the proton, $\\left(\\frac{\\gamma_H}{2\\pi}\\right) = 42.57747892 \\times 10^6 \\ \\mathrm{Hz/T}$; for deuterium, $\\left(\\frac{\\gamma_D}{2\\pi}\\right) = 6.535902 \\times 10^6 \\ \\mathrm{Hz/T}$.\n\nTasks:\n1. Derive, from the bases above, the expected functional dependence of $B(t)$ on elapsed time $t$ under thermally activated flux creep with an Anderson–Kim barrier $U(J)$, explicitly identifying the role of a reference time $t_0$ at which the initial condition is defined. Show that the dependence is logarithmic in $t/t_0$ and identify the free parameters to be estimated from data without writing down the final target formula in the problem statement.\n2. Given measured deuterium lock frequencies $f_D(t_i)$ at times $t_i$ (seconds), convert these to bore field values $B(t_i)$ in $\\mathrm{T}$ using $B = \\frac{f_D}{\\gamma_D/2\\pi}$, and fit the logarithmic-time drift model using least squares with the choice $t_0 = t_{\\min}$ (the first measurement time). From the fit, extract an amplitude parameter that quantifies the drift and the field at the reference time. Use these to forecast the proton resonance frequency $f_H$ in $\\mathrm{Hz}$ at a future time $t_{\\mathrm{future}} = t_{\\mathrm{last}} + 43200$ (i.e., add $12$ hours to the last measurement).\n3. Using the forecast, classify the magnet’s frequency stability over the next $12$ hours as stable or unstable according to the criterion $\\left| \\Delta f_H \\right| < 10.0 \\ \\mathrm{Hz}$, where $\\Delta f_H$ is the predicted change in proton frequency between $t_{\\mathrm{last}}$ and $t_{\\mathrm{future}}$.\n4. Implement a program that executes the conversion, fitting, and forecasting for each test case, and produces a single line of output containing the results as a comma-separated list enclosed in square brackets. Each result must be a list of three elements: the fitted drift amplitude in $\\mathrm{T}$, the forecasted proton frequency at $t_{\\mathrm{future}}$ in $\\mathrm{Hz}$, and a boolean for stability. The output must thus have the form $[ [\\text{amp}_1,\\text{fH}_1,\\text{stable}_1], [\\text{amp}_2,\\text{fH}_2,\\text{stable}_2], \\dots ]$.\n\nUse the following test suite of measured deuterium lock data (frequencies in $\\mathrm{Hz}$, times in $\\mathrm{s}$). Each case represents a different magnet and operating condition:\n- Case A (nominal $14.1 \\ \\mathrm{T}$ class magnet, typical drift): times $[300, 900, 3600, 14400, 21600]$ with $f_D$ values $[92156218.2, 92156216.2, 92156213.7, 92156211.2, 92156210.5]$.\n- Case B (nominal $9.4 \\ \\mathrm{T}$ class magnet, near-flat drift): times $[60, 120, 300, 1800, 10800]$ with $f_D$ values $[61437478.8, 61437478.7, 61437478.5, 61437478.1, 61437477.8]$.\n- Case C (nominal $18.8 \\ \\mathrm{T}$ class magnet, larger drift): times $[600, 1800, 7200, 43200]$ with $f_D$ values $[122874957.6, 122874954.0, 122874949.5, 122874943.6]$.\n\nAngle units are not applicable. All outputs must be provided in the specified physical units. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $[ [0.000001,600000000.0,True], [\\dots], [\\dots] ]$).", "solution": "The user has provided a problem that requires a quantitative analysis of magnetic field drift in a superconducting NMR magnet. The problem is to be solved by first deriving the theoretical model for the drift, then applying this model to fit experimental data, and finally using the fitted model to make a prediction and a stability classification.\n\n### Problem Validation\nThe problem was validated against the established criteria.\n\n1.  **Givens Extraction**: All physical principles, constants ($\\gamma_H/2\\pi$, $\\gamma_D/2\\pi$), task definitions, stability criteria ($|\\Delta f_H| < 10.0 \\ \\mathrm{Hz}$), and test data sets were extracted verbatim.\n2.  **Validation Check**: The problem is **scientifically grounded** in the physics of superconductivity (Anderson-Kim flux creep) and Nuclear Magnetic Resonance. The provided relationships and constants are standard and correct. It is **well-posed**, with clear objectives, sufficient data, and a defined mathematical procedure (least squares fitting). It is **objective**, using precise, quantitative language and avoiding ambiguity. The problem is self-contained and free of contradictions. The data provided is realistic, as confirmed by checking the correspondence between the nominal field strengths and the deuterium lock frequencies ($B = f_D / (\\gamma_D/2\\pi)$). For instance, for Case A, $f_D \\approx 92.156 \\times 10^6 \\ \\mathrm{Hz}$ which gives $B \\approx (92.156 \\times 10^6) / (6.535902 \\times 10^6) \\approx 14.1 \\ \\mathrm{T}$, matching the description. The problem is neither trivial nor unverifiable.\n3.  **Verdict**: The problem is deemed **valid**.\n\n### Step-by-Step Solution\n\n#### Part 1: Derivation of the Logarithmic Drift Model\n\nThe time dependence of the magnetic field, $B(t)$, is derived from the principles of thermally activated flux creep.\n\n1.  The magnetic field $B$ is proportional to the persistent current density $J$ in the superconducting windings. Thus, the temporal behavior of $B$ follows that of $J$.\n2.  The decay of the current is caused by a small voltage induced by the motion of magnetic flux vortices. From Faraday's law, this voltage leads to a rate of change of current, $\\frac{dJ}{dt} \\propto -E$, where $E$ is the electric field generated by vortex motion.\n3.  The electric field is proportional to the vortex velocity $v$, $E \\sim B v$. The velocity is thermally activated and follows an Arrhenius-type law, $v \\propto \\exp\\left[-\\frac{U(J)}{k_{\\mathrm{B}} T}\\right]$.\n4.  The activation energy $U(J)$ is given by the Anderson-Kim model, $U(J) = U_0 \\left(1 - \\frac{J}{J_c}\\right)$, where $J$ is close to the critical current density $J_c$.\n5.  Combining these, we get the differential equation for the current density decay:\n    $$ \\frac{dJ}{dt} \\propto - J \\exp\\left[-\\frac{U_0}{k_{\\mathrm{B}} T} \\left(1 - \\frac{J}{J_c}\\right)\\right] $$\n    For slow creep, $J$ is nearly constant and can be absorbed into the proportionality constant. Let $\\alpha = \\frac{U_0}{k_{\\mathrm{B}}T J_c}$. The equation simplifies to:\n    $$ \\frac{dJ}{dt} \\approx -C \\exp(\\alpha J) $$\n    where $C$ is a constant.\n6.  This differential equation can be solved by separation of variables: $e^{-\\alpha J} dJ = -C dt$. A more direct path, common in the literature and demonstrating consistency, is to test a logarithmic solution. let's assume a solution of the form $J(t) = K_1 - K_2 \\ln(t)$. Then $\\frac{dJ}{dt} = -\\frac{K_2}{t}$. Substituting this into the differential equation gives:\n    $$ -\\frac{K_2}{t} = -C \\exp[\\alpha(K_1 - K_2 \\ln t)] = -C e^{\\alpha K_1} t^{-\\alpha K_2} $$\n    For this equality to hold for all $t$, the powers of $t$ must be equal: $t^{-1} = t^{-\\alpha K_2}$, which implies $\\alpha K_2 = 1$, or $K_2 = 1/\\alpha$. The coefficients must also match. This confirms that a logarithmic dependence on time is a valid solution.\n7.  Since $B(t) \\propto J(t)$, the magnetic field must also exhibit a logarithmic decay. We can express this relative to a reference measurement time $t_0$:\n    $$ B(t) = B(t_0) - A_m \\ln\\left(\\frac{t}{t_0}\\right) $$\n    Here, $t_0$ is the time at which the initial condition $B(t_0)$ is defined. The model has two free parameters to be estimated from experimental data:\n    -   $B(t_0)$: The magnetic field at the reference time $t_0$.\n    -   $A_m$: The drift amplitude, a positive constant related to the physical parameters by $A_m \\propto 1/\\alpha \\propto \\frac{k_{\\mathrm{B}} T J_c}{U_0}$.\n\n#### Part 2: Data Fitting and Forecasting\n\nThe model derived, $B(t) = B(t_0) - A_m \\ln\\left(\\frac{t}{t_0}\\right)$, is linear in $\\ln(t/t_0)$. We can rewrite it for linear least-squares fitting as $y = p_0 + p_1 x$, where:\n-   $y = B(t)$\n-   $x = \\ln(t/t_0)$\n-   $p_0 = B(t_0)$ is the intercept, representing the field at the reference time.\n-   $p_1 = -A_m$ is the slope.\n\nThe procedure for each test case is as follows:\n1.  **Data Conversion**: Convert the measured deuterium frequencies $f_{D,i}$ at times $t_i$ to magnetic field values $B_i$ using the relation $B_i = f_{D,i} / (\\gamma_D/2\\pi)$.\n2.  **Variable Transformation**: Choose the reference time as the first measurement time, $t_0 = t_{\\min}$. Compute the independent variable for the fit, $x_i = \\ln(t_i/t_0)$.\n3.  **Least-Squares Fit**: Perform a linear least-squares regression of $B_i$ versus $x_i$ to find the optimal parameters $p_0$ and $p_1$. This will be done using `numpy.linalg.lstsq`.\n4.  **Parameter Extraction**: The drift amplitude is $A_m = -p_1$. The fitted field at the reference time is $p_0$.\n5.  **Forecasting**:\n    -   Calculate the future time $t_{\\mathrm{future}} = t_{\\mathrm{last}} + 43200 \\ \\mathrm{s}$.\n    -   Predict the magnetic field at this time using the fitted model: $B_{\\mathrm{future}} = p_0 + p_1 \\ln(t_{\\mathrm{future}}/t_0)$.\n    -   Convert this field to the corresponding proton resonance frequency: $f_{H, \\mathrm{future}} = (\\gamma_H/2\\pi) \\times B_{\\mathrm{future}}$.\n\n#### Part 3: Stability Classification\n\nThe magnet's stability is assessed over the 12-hour period from $t_{\\mathrm{last}}$ to $t_{\\mathrm{future}}$.\n1.  Calculate the predicted change in the proton resonance frequency, $\\Delta f_H = f_H(t_{\\mathrm{future}}) - f_H(t_{\\mathrm{last}})$.\n2.  Using the fitted model, $f_H(t) = (\\gamma_H/2\\pi) \\times (p_0 + p_1 \\ln(t/t_0))$.\n3.  The change is then:\n    $$ \\Delta f_H = \\frac{\\gamma_H}{2\\pi} \\times p_1 \\left( \\ln\\left(\\frac{t_{\\mathrm{future}}}{t_0}\\right) - \\ln\\left(\\frac{t_{\\mathrm{last}}}{t_0}\\right) \\right) = \\frac{\\gamma_H}{2\\pi} p_1 \\ln\\left(\\frac{t_{\\mathrm{future}}}{t_{\\mathrm{last}}}\\right) $$\n4.  The stability is classified as `True` (stable) if $|\\Delta f_H| < 10.0 \\ \\mathrm{Hz}$, and `False` (unstable) otherwise.\n\nThe following Python code implements this entire procedure.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem of analyzing superconducting magnet field drift for NMR.\n\n    This function processes several test cases of magnet drift data. For each case, it:\n    1. Converts measured deuterium lock frequencies to magnetic field values.\n    2. Fits a logarithmic-in-time drift model (B(t) = p0 + p1*ln(t/t0)) using linear least squares.\n    3. Extracts the drift amplitude from the fit.\n    4. Forecasts the proton resonance frequency 12 hours after the last measurement.\n    5. Classifies the magnet's stability based on the forecasted frequency change over that 12-hour period.\n    The results are then printed in the specified format.\n    \"\"\"\n\n    # Define physical constants\n    # Gyromagnetic ratio / 2*pi for Proton in Hz/T\n    GAMMA_H_OVER_2PI = 42.57747892e6\n    # Gyromagnetic ratio / 2*pi for Deuterium in Hz/T\n    GAMMA_D_OVER_2PI = 6.535902e6\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case A (nominal 14.1 T class magnet, typical drift)\n        {\n            \"times\": np.array([300, 900, 3600, 14400, 21600], dtype=np.float64),\n            \"f_D\": np.array([92156218.2, 92156216.2, 92156213.7, 92156211.2, 92156210.5], dtype=np.float64),\n        },\n        # Case B (nominal 9.4 T class magnet, near-flat drift)\n        {\n            \"times\": np.array([60, 120, 300, 1800, 10800], dtype=np.float64),\n            \"f_D\": np.array([61437478.8, 61437478.7, 61437478.5, 61437478.1, 61437477.8], dtype=np.float64),\n        },\n        # Case C (nominal 18.8 T class magnet, larger drift)\n        {\n            \"times\": np.array([600, 1800, 7200, 43200], dtype=np.float64),\n            \"f_D\": np.array([122874957.6, 122874954.0, 122874949.5, 122874943.6], dtype=np.float64),\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        times = case[\"times\"]\n        freq_d = case[\"f_D\"]\n\n        # Task 2: Convert frequency to field and fit the model\n        # B(t) = f_D(t) / (gamma_D/2pi)\n        B_measured = freq_d / GAMMA_D_OVER_2PI\n\n        # The model to fit is B(t) = B(t0) - A_m * ln(t/t0), which is a linear model\n        # y = p0 + p1*x where y=B, x=ln(t/t0), p0=B(t0), p1=-A_m\n        t0 = times[0]\n        x_fit = np.log(times / t0)\n\n        # Set up the design matrix for linear least squares\n        A_matrix = np.vstack([np.ones(len(x_fit)), x_fit]).T\n        \n        # Perform the least-squares fit\n        p, _, _, _ = np.linalg.lstsq(A_matrix, B_measured, rcond=None)\n        p0, p1 = p[0], p[1]\n\n        # Extract the drift amplitude\n        drift_amplitude = -p1\n\n        # Forecast proton frequency at t_future\n        t_last = times[-1]\n        t_future = t_last + 43200.0  # Add 12 hours in seconds\n        \n        # Use the fitted model to predict B at t_future\n        B_future = p0 + p1 * np.log(t_future / t0)\n        \n        # Convert B_future to proton frequency\n        f_H_future = GAMMA_H_OVER_2PI * B_future\n\n        # Task 3: Classify stability\n        # Calculate the change in proton frequency from t_last to t_future\n        # Delta_f_H = f_H(t_future) - f_H(t_last)\n        # Using the model: f_H(t) = GAMMA_H_OVER_2PI * (p0 + p1*ln(t/t0))\n        delta_f_H = GAMMA_H_OVER_2PI * p1 * (np.log(t_future / t0) - np.log(t_last / t0))\n        delta_f_H = GAMMA_H_OVER_2PI * p1 * np.log(t_future / t_last)\n\n        # Stability criterion: |Delta f_H| < 10.0 Hz\n        is_stable = abs(delta_f_H)  10.0\n\n        results.append([drift_amplitude, f_H_future, is_stable])\n\n    # Task 4: Final print statement in the exact required format\n    # Build the string representation for the final list of lists\n    result_strings = []\n    for res in results:\n        # Each res is [amplitude, frequency, stability_boolean]\n        # str(value) is used for default representation of floats and booleans.\n        # Python's str(True) is 'True', which matches the example's capitalization.\n        result_strings.append(f\"[{str(res[0])},{str(res[1])},{str(res[2])}]\")\n    \n    print(f\"[{','.join(result_strings)}]\")\n\nsolve()\n```", "id": "3726334"}, {"introduction": "To counteract the inherent field drift from effects like flux creep, high-resolution NMR spectrometers employ an active stabilization system called a field-frequency lock. This system continuously monitors the resonance frequency of a reference nucleus (typically deuterium) and applies minute corrections to the main magnetic field, $B_0$. This exercise delves into the heart of this feedback mechanism, challenging you to derive the precise relationship between a measured frequency drift and the corrective current required from a shim coil to maintain field stability [@problem_id:3726292].", "problem": "A high-field Nuclear Magnetic Resonance (NMR) spectrometer used for spectrometric identification of organic compounds employs a deuterium (${}^{2}\\mathrm{H}$) lock at $92\\ \\mathrm{MHz}$ to stabilize the static magnetic field. In a superconducting magnet, slow magnetic field drift arises from cryogen-related thermal changes and flux creep. The deuterium Larmor frequency obeys the relation $f = (\\gamma_{D}/2\\pi)\\,B_{0}$, where $\\gamma_{D}$ is the deuterium gyromagnetic ratio and $B_{0}$ is the static field. The lock controller uses the central uniform shim channel $Z_{0}$ to correct $B_{0}$; the $Z_{0}$ coil is characterized by a calibration constant $\\beta_{Z0}$ defined by $dB_{0} = \\beta_{Z0}\\,dI$, where $I$ is the applied $Z_{0}$ current.\n\nSuppose the lock channel reports a measured deuterium frequency drift rate $\\frac{df}{dt}$ (with the sign convention that a positive $\\frac{df}{dt}$ indicates increasing frequency). Over each minute, the controller applies a single $Z_{0}$ current correction to compensate the accumulated drift. Under the assumptions of linear drift within each minute and that the $Z_{0}$ field contribution is uniform over the sample volume, derive from first principles an analytic expression for the $Z_{0}$ current correction per minute, $\\Delta I$, that must be applied to keep the lock frequency within $\\pm 1\\ \\mathrm{Hz}$ of $92\\ \\mathrm{MHz}$. Express your final answer as a closed-form expression in terms of $\\frac{df}{dt}$, $\\gamma_{D}$, and $\\beta_{Z0}$. Indicate the sign of the correction relative to the sign of $\\frac{df}{dt}$. Use amperes per minute for the current correction. No numerical substitution is permitted; do not round. Your final answer must be a single analytical expression.", "solution": "The problem will first be validated for scientific soundness, consistency, and completeness before a solution is attempted.\n\n### Problem Validation\n\n**Step 1: Extract Givens**\n-   Deuterium (${}^{2}\\mathrm{H}$) lock target frequency: $f_{target} = 92\\ \\mathrm{MHz}$.\n-   Larmor frequency relation: $f = (\\gamma_{D}/2\\pi)\\,B_{0}$.\n-   Deuterium gyromagnetic ratio: $\\gamma_{D}$.\n-   Static magnetic field: $B_{0}$.\n-   $Z_{0}$ shim coil calibration constant: $\\beta_{Z0}$, defined by $dB_{0} = \\beta_{Z0}\\,dI$.\n-   $Z_{0}$ current: $I$.\n-   Measured frequency drift rate: $\\frac{df}{dt}$.\n-   Sign convention: A positive $\\frac{df}{dt}$ corresponds to an increasing frequency.\n-   Correction timing: A single correction is applied each minute.\n-   Assumption: Linear drift within each minute.\n-   Objective: Derive an expression for the \"current correction per minute, $\\Delta I$\".\n-   Constraint: The expression for $\\Delta I$ must be in terms of $\\frac{df}{dt}$, $\\gamma_{D}$, and $\\beta_{Z0}$.\n-   Operational Tolerance: The frequency must be kept within $\\pm 1\\ \\mathrm{Hz}$ of the target.\n-   Units: The result should represent \"amperes per minute\".\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is scientifically grounded, describing a standard field-frequency lock mechanism in an NMR spectrometer. The physical principles (Larmor equation) and components (shim coils, deuterium lock) are accurately represented.\n\nHowever, there is an ambiguity in the problem statement that must be resolved. The problem asks for a quantity designated as $\\Delta I$, which typically represents a finite change in current (units of Amperes). It also describes the correction process as a discrete step applied once per minute. A derivation for a discrete current step, $\\Delta I_{step}$, would necessarily depend on the time interval, $\\Delta t = 1\\ \\text{minute}$. This contradicts the explicit constraint that the final expression must only be in terms of $\\frac{df}{dt}$, $\\gamma_{D}$, and $\\beta_{Z0}$.\n\nSimultaneously, the problem requests the answer in \"amperes per minute,\" which is a unit of rate (current per time), not a change in current. This strongly suggests that the intended quantity is the *rate of change of current*, $\\frac{dI}{dt}$, required to continuously compensate for the drift. This interpretation resolves the contradictions:\n1.  Deriving a rate, $\\frac{dI}{dt}$, results in an expression that depends only on the specified variables.\n2.  A rate $\\frac{dI}{dt}$ has units of current per time, consistent with \"amperes per minute,\" provided the time variable in all derivatives is taken to be in minutes.\n\nThe description of a \"single current correction\" per minute is interpreted as a practical implementation of a fundamentally continuous correction model. The quantity to be derived is the ideal rate of current change. The notation \"$\\Delta I$\" is thus considered an imprecise symbol for the rate $\\frac{dI}{dt}$. The tolerance of $\\pm 1\\ \\mathrm{Hz}$ is contextual and does not enter the derivation for the ideal compensation, which aims for zero error.\n\n**Step 3: Verdict and Action**\nThe problem is deemed **valid**, contingent on the resolution of the ambiguity as described above. The solution will proceed by deriving the required rate of change of the shim current, $\\frac{dI}{dt}$, under the assumption that the time basis for all rates is minutes.\n\n### Derivation of the Current Correction Rate\n\nThe fundamental principle of a field-frequency lock is to maintain a constant Larmor frequency, which requires maintaining a constant static magnetic field, $B_{0}$. Any drift in the magnetic field must be actively canceled by a correcting field.\n\nLet the total magnetic field $B_{0}$ be the sum of a constant component, a time-dependent drift component $B_{drift}(t)$, and a time-dependent correction component $B_{corr}(t)$ generated by the $Z_{0}$ shim coil. For the lock to be stable, the total field must not change with time, so its time derivative must be zero:\n$$\n\\frac{dB_0}{dt} = \\frac{d}{dt} [B_{main} + B_{drift}(t) + B_{corr}(t)] = 0\n$$\nAs $B_{main}$ is constant, this simplifies to:\n$$\n\\frac{dB_{drift}}{dt} + \\frac{dB_{corr}}{dt} = 0 \\quad \\implies \\quad \\frac{dB_{corr}}{dt} = - \\frac{dB_{drift}}{dt}\n$$\nThis equation states that the rate of change of the correction field must be equal and opposite to the rate of change of the drift field.\n\nWe can relate these field drift rates to the given frequency drift rate, $\\frac{df}{dt}$. The Larmor equation is given as:\n$$\nf = \\frac{\\gamma_{D}}{2\\pi} B_{0}\n$$\nThe observed frequency drift rate, in the absence of correction, is due to the drift field. Differentiating the Larmor equation with respect to time $t$ gives the relationship between the frequency drift and the magnetic field drift:\n$$\n\\frac{df}{dt} = \\frac{\\gamma_{D}}{2\\pi} \\frac{dB_{drift}}{dt}\n$$\nWe can rearrange this to express the field drift rate in terms of the measurable frequency drift rate:\n$$\n\\frac{dB_{drift}}{dt} = \\frac{2\\pi}{\\gamma_{D}} \\frac{df}{dt}\n$$\nNext, we relate the correction field rate, $\\frac{dB_{corr}}{dt}$, to the rate of change of the shim current, $\\frac{dI}{dt}$. The problem provides the calibration constant $\\beta_{Z0}$ through the differential relation $dB_{0} = \\beta_{Z0}\\,dI$. For the correction field component generated by the shim, this implies a relationship between the rates of change:\n$$\n\\frac{dB_{corr}}{dt} = \\beta_{Z0} \\frac{dI}{dt}\n$$\nNow, we substitute the expressions for the field rates back into the stability condition $\\frac{dB_{corr}}{dt} = - \\frac{dB_{drift}}{dt}$:\n$$\n\\beta_{Z0} \\frac{dI}{dt} = - \\frac{2\\pi}{\\gamma_{D}} \\frac{df}{dt}\n$$\nSolving for the required rate of current correction, $\\frac{dI}{dt}$, we obtain:\n$$\n\\frac{dI}{dt} = - \\frac{2\\pi}{\\gamma_{D} \\beta_{Z0}} \\frac{df}{dt}\n$$\nThis expression represents the required continuous rate of change of the $Z_{0}$ current. Per the validation analysis, we interpret the prompt's request for the \"current correction per minute, $\\Delta I$\" to be this quantity, where the time derivatives are implicitly taken with respect to time measured in minutes. This ensures the units are \"amperes per minute\" and the expression depends only on the specified variables.\n\nThe sign of the correction is negative. If the frequency drift rate $\\frac{df}{dt}$ is positive (field is increasing), the rate of current change $\\frac{dI}{dt}$ must be negative to generate a decreasing counter-field (assuming $\\gamma_D$ and $\\beta_{Z0}$ are positive constants, which they are by convention). This is physically correct.", "answer": "$$\n\\boxed{-\\frac{2\\pi}{\\gamma_{D}\\beta_{Z0}}\\frac{df}{dt}}\n$$", "id": "3726292"}, {"introduction": "Beyond temporal stability, achieving high spectral resolution demands exceptional spatial homogeneity of the magnetic field across the entire sample volume. The process of correcting spatial imperfections is called \"shimming,\" which involves adjusting currents in a set of specialized coils. This hands-on problem simulates the modern computational approach to shimming, where you will use a measured map of field deviations to calculate the optimal shim currents that minimize inhomogeneity, providing a practical application of linear algebra and least-squares optimization [@problem_id:3726346].", "problem": "A superconducting magnet used for Nuclear Magnetic Resonance (NMR) in spectrometric identification of organic compounds must have a highly homogeneous static magnetic field. Sample susceptibility and small installation imperfections introduce spatial variation in the static field that can be corrected by applying currents to shim coils. First-order shim coils generate fields proportional to Cartesian coordinates, commonly named $Z_1$ (proportional to $z$) and $X$ (proportional to $x$). Consider a measured static-field deviation map $\\Delta B(\\mathbf{r}_i)$ at discrete locations $\\mathbf{r}_i=(x_i,y_i,z_i)$, where the dominant components are $Z_1$ and $X$. The objective is to compute shim currents that minimize the residual inhomogeneity and then quantify the residual homogeneity after applying the computed shims, expressed as frequency offsets for the hydrogen nucleus.\n\nFundamental base and definitions:\n- The magnetic field superposition principle states that the total field is the sum of contributions from independent sources. If the shim coils produce fields proportional to $z$ and $x$ with calibration constants $k_{Z_1}$ and $k_X$ defined as field per ampere per meter, then the shim correction field at point $(x_i,y_i,z_i)$ is $\\Delta B_{\\text{shim}}(x_i,y_i,z_i) = k_{Z_1} I_{Z_1} z_i + k_X I_X x_i$, where $I_{Z_1}$ and $I_X$ are the applied currents in amperes.\n- The hydrogen nuclear Larmor frequency offset is related to the magnetic field by $f = \\left(\\gamma/2\\pi\\right) \\Delta B$, where $\\gamma/2\\pi = 42.577\\times 10^6$ Hz/T is the gyromagnetic ratio of the proton.\n- The residual field after shimming at each sample location is $\\Delta B_{\\text{res},i} = \\Delta B(\\mathbf{r}_i) + \\Delta B_{\\text{shim}}(\\mathbf{r}_i)$, and the squared-error objective to minimize is $\\sum_i \\left(\\Delta B_{\\text{res},i}\\right)^2 = \\sum_i \\left(\\Delta B(\\mathbf{r}_i) + k_{Z_1} I_{Z_1} z_i + k_X I_X x_i\\right)^2$.\n- The least-squares solution seeks currents $I_{Z_1}$ and $I_X$ that minimize the above sum. Because first-order shim fields are linear in $I_{Z_1}$ and $I_X$, the problem can be cast as a linear least-squares problem.\n\nYour task:\n- For each test case below, compute the two shim currents $I_{Z_1}$ and $I_X$ (in amperes) that minimize $\\sum_i \\left(\\Delta B(\\mathbf{r}_i) + k_{Z_1} I_{Z_1} z_i + k_X I_X x_i\\right)^2$ using a numerically stable method. If the system is rank-deficient, return the minimum-norm solution.\n- Using the computed currents, form the residual field list $\\{\\Delta B_{\\text{res},i}\\}$, convert it to frequency offsets in hertz using $f_i = \\left(\\gamma/2\\pi\\right) \\Delta B_{\\text{res},i}$ with $\\gamma/2\\pi = 42.577\\times 10^6$ Hz/T, and then compute:\n    - The root-mean-square of the residual frequency offsets, $\\text{RMS} = \\sqrt{\\frac{1}{N}\\sum_i f_i^2}$, expressed in hertz.\n    - The peak-to-peak residual frequency spread, $\\text{P2P} = \\max_i f_i - \\min_i f_i$, expressed in hertz.\n- Express all currents in amperes and all frequency quantities in hertz. Angles are not involved. Numerical answers must be floats.\n\nTest suite:\nCase A (happy path, two-dimensional grid, both $Z_1$ and $X$ observable):\n- Coordinates $(x_i,z_i)$ in meters with $y_i=0$:\n    - $(-0.02,-0.015),(0,-0.015),(0.02,-0.015),(-0.02,0),(0,0),(0.02,0),(-0.02,0.015),(0,0.015),(0.02,0.015)$, that is $x$ values $[-0.02,0,0.02]$ crossed with $z$ values $[-0.015,0,0.015]$.\n- Calibration constants (field per ampere per meter):\n    - $k_{Z_1} = 5.0\\times 10^{-3}$ T/(A·m), $k_X = 5.0\\times 10^{-3}$ T/(A·m).\n- Measured field map $\\Delta B$ in tesla at the above points (ordered as listed):\n    - $[-1.0 \\times 10^{-7}, -1.85 \\times 10^{-6}, -3.32 \\times 10^{-6}, 1.53 \\times 10^{-6}, 0, -1.54 \\times 10^{-6}, 3.36 \\times 10^{-6}, 1.82 \\times 10^{-6}, 1.1 \\times 10^{-7}]$.\n\nCase B (boundary, all $z_i=0$, only $X$ observable):\n- Coordinates $(x_i,z_i)$ in meters with $y_i=0$:\n    - $(-0.02,0),(-0.01,0),(0,0),(0.01,0),(0.02,0)$.\n- Calibration constants:\n    - $k_{Z_1} = 5.0\\times 10^{-3}$ T/(A·m), $k_X = 4.0\\times 10^{-3}$ T/(A·m).\n- Measured field map $\\Delta B$ in tesla at the above points (ordered as listed):\n    - $[-1.95 \\times 10^{-6}, -1.02 \\times 10^{-6}, 0, 1.03 \\times 10^{-6}, 1.96 \\times 10^{-6}]$.\n\nCase C (edge case with an outlier, irregular sampling):\n- Coordinates $(x_i,z_i)$ in meters with $y_i=0$:\n    - $(-0.02,-0.02),(-0.015,-0.01),(-0.005,0),(0,0.01),(0.01,0.02),(0.015,-0.015),(0.02,0),(-0.01,0.02),(0,-0.02),(0.015,0.015)$.\n- Calibration constants:\n    - $k_{Z_1} = 6.0\\times 10^{-3}$ T/(A·m), $k_X = 4.0\\times 10^{-3}$ T/(A·m).\n- Measured field map $\\Delta B$ in tesla at the above points (ordered as listed):\n    - $[0.85 \\times 10^{-6}, 0.12 \\times 10^{-6}, -0.24 \\times 10^{-6}, -0.88 \\times 10^{-6}, -1.32 \\times 10^{-6}, 2.90 \\times 10^{-6}, 0.95 \\times 10^{-6}, -2.26 \\times 10^{-6}, 1.74 \\times 10^{-6}, -0.60 \\times 10^{-6}]$.\n\nAlgorithmic specification:\n- For each case, construct the design matrix $\\mathbf{A}\\in\\mathbb{R}^{N\\times 2}$ with columns $\\left[k_{Z_1} z_i\\right]$ and $\\left[k_X x_i\\right]$. Let $\\mathbf{b}=-\\Delta \\mathbf{B}$.\n- Compute the minimum-norm least-squares solution $\\mathbf{I}=\\left[I_{Z_1},I_X\\right]^T$ that minimizes $\\|\\mathbf{A}\\mathbf{I}-\\mathbf{b}\\|_2$.\n- Compute the residual field $\\Delta \\mathbf{B}_{\\text{res}}=\\Delta \\mathbf{B}+\\mathbf{A}\\mathbf{I}$.\n- Convert residual field to frequency offsets using $f_i=\\left(\\gamma/2\\pi\\right)\\Delta B_{\\text{res},i}$ with $\\gamma/2\\pi=42.577\\times 10^6$ Hz/T, then compute $\\text{RMS}=\\sqrt{\\frac{1}{N}\\sum_i f_i^2}$ and $\\text{P2P}=\\max_i f_i-\\min_i f_i$.\n\nFinal output format:\n- Your program should produce a single line of output containing the results for all three cases as a comma-separated list enclosed in square brackets. Each case’s result must itself be a list of four floats in the order $[I_{Z_1}, I_X, \\text{RMS}, \\text{P2P}]$, where currents are in amperes and frequency metrics are in hertz. For example, the output must look like $[[i_{A,Z_1},i_{A,X},\\text{rms}_A,\\text{p2p}_A],[i_{B,Z_1},i_{B,X},\\text{rms}_B,\\text{p2p}_B],[i_{C,Z_1},i_{C,X},\\text{rms}_C,\\text{p2p}_C]]$ with actual numeric values replacing the symbols.", "solution": "The superconducting magnet’s static field nonuniformity is well described locally by a linear combination of spherical harmonics. The first-order harmonics $Z_1$ and $X$ correspond to fields proportional to $z$ and $x$, respectively. Because magnetic fields superpose linearly, the net residual field after applying shim currents is the sum of the measured deviation and the shim-generated correction. The fundamental basis for this problem is linear superposition and linear least-squares minimization.\n\nWe start with the measured offsets $\\Delta B(\\mathbf{r}_i)$ at positions $\\mathbf{r}_i=(x_i,y_i,z_i)$. First-order shim coils produce correction fields given by $\\Delta B_{\\text{shim}}(x_i,y_i,z_i)=k_{Z_1} I_{Z_1} z_i + k_X I_X x_i$, where $k_{Z_1}$ and $k_X$ are calibration constants converting current and spatial coordinate into magnetic field, and $I_{Z_1}$, $I_X$ are the currents to determine. The residual field at sample $i$ is then\n$$\n\\Delta B_{\\text{res},i}=\\Delta B(\\mathbf{r}_i)+k_{Z_1} I_{Z_1} z_i + k_X I_X x_i.\n$$\nTo find $I_{Z_1}$ and $I_X$, we minimize the sum of squared residuals\n$$\nS(I_{Z_1},I_X)=\\sum_{i=1}^N\\left(\\Delta B(\\mathbf{r}_i)+k_{Z_1} I_{Z_1} z_i + k_X I_X x_i\\right)^2.\n$$\nThis is a linear least-squares problem. Let the design matrix be\n$$\n\\mathbf{A}=\\begin{bmatrix}\nk_{Z_1} z_1  k_X x_1 \\\\\nk_{Z_1} z_2  k_X x_2 \\\\\n\\vdots  \\vdots \\\\\nk_{Z_1} z_N  k_X x_N\n\\end{bmatrix},\\quad\n\\mathbf{b}=-\\begin{bmatrix}\n\\Delta B(\\mathbf{r}_1) \\\\ \\Delta B(\\mathbf{r}_2) \\\\ \\vdots \\\\ \\Delta B(\\mathbf{r}_N)\n\\end{bmatrix}.\n$$\nWe seek $\\mathbf{I}=\\begin{bmatrix}I_{Z_1}\\\\I_X\\end{bmatrix}$ minimizing $\\left\\|\\mathbf{A}\\mathbf{I}-\\mathbf{b}\\right\\|_2$. When $\\mathbf{A}$ has full column rank, the solution satisfies the normal equations\n$$\n(\\mathbf{A}^\\top \\mathbf{A})\\mathbf{I}=\\mathbf{A}^\\top \\mathbf{b},\n$$\nleading to\n$$\n\\mathbf{I}=(\\mathbf{A}^\\top \\mathbf{A})^{-1}\\mathbf{A}^\\top \\mathbf{b}.\n$$\nIf $\\mathbf{A}$ is rank-deficient (e.g., all $z_i=0$ so the $Z_1$ column is zero), then the minimum-norm solution is given by the Moore–Penrose pseudo-inverse,\n$$\n\\mathbf{I}=\\mathbf{A}^+\\mathbf{b},\n$$\nwhich can be computed stably using methods such as Singular Value Decomposition or dedicated least-squares solvers that return the minimum-norm solution.\n\nOnce $\\mathbf{I}$ is obtained, the residual magnetic field vector is\n$$\n\\Delta \\mathbf{B}_{\\text{res}}=\\Delta \\mathbf{B}+\\mathbf{A}\\mathbf{I}.\n$$\nTo assess homogeneity in the spectroscopic domain, convert each residual field into a frequency offset for the hydrogen nucleus via\n$$\nf_i=\\left(\\frac{\\gamma}{2\\pi}\\right)\\Delta B_{\\text{res},i},\\quad\\frac{\\gamma}{2\\pi}=42.577\\times 10^6\\ \\text{Hz/T}.\n$$\nThe root-mean-square residual frequency is\n$$\n\\text{RMS}=\\sqrt{\\frac{1}{N}\\sum_{i=1}^N f_i^2},\n$$\nand the peak-to-peak spread is\n$$\n\\text{P2P}=\\max_i f_i - \\min_i f_i.\n$$\n\nAlgorithmically, for each test case we:\n- Construct $\\mathbf{A}$ using the provided $k_{Z_1}$, $k_X$, and coordinates.\n- Compute $\\mathbf{I}$ using a numerically stable least-squares solver that handles rank-deficiency gracefully, yielding minimum-norm solutions.\n- Form $\\Delta \\mathbf{B}_{\\text{res}}$ and convert to frequency offsets using the provided proton gyromagnetic ratio.\n- Compute $\\text{RMS}$ and $\\text{P2P}$ in hertz.\n\nScientific realism is ensured by using calibration constants that yield physically plausible currents (on the order of tens of milliamperes to a few hundred milliamperes for first-order shims), spatial coordinates in centimeters converted to meters, and measured field deviations in microtesla. The test suite probes distinct facets: a well-conditioned grid with both $z$ and $x$ variation, a boundary case with only $x$ variation (rank-deficient for $Z_1$), and an irregular set with an outlier to observe the sensitivity of least-squares residuals. The output format aggregates each case’s currents and residual homogeneity metrics into a single list of lists printed on one line, directly verifiable against the program’s computations.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    # Proton gyromagnetic ratio in Hz/T\n    gamma_hz_per_t = 42.577e6\n\n    # Define the test cases from the problem statement.\n    # Each case: dict with keys: 'x', 'z', 'kz1', 'kx', 'dB'\n    test_cases = [\n        {\n            # Case A\n            \"x\": np.array([-0.02, 0.0, 0.02, -0.02, 0.0, 0.02, -0.02, 0.0, 0.02], dtype=float),\n            \"z\": np.array([-0.015, -0.015, -0.015, 0.0, 0.0, 0.0, 0.015, 0.015, 0.015], dtype=float),\n            \"kz1\": 5.0e-3,\n            \"kx\": 5.0e-3,\n            \"dB\": np.array([-1.0e-7, -1.85e-6, -3.32e-6, 1.53e-6, 0.0, -1.54e-6, 3.36e-6, 1.82e-6, 1.1e-7], dtype=float),\n        },\n        {\n            # Case B\n            \"x\": np.array([-0.02, -0.01, 0.0, 0.01, 0.02], dtype=float),\n            \"z\": np.array([0.0, 0.0, 0.0, 0.0, 0.0], dtype=float),\n            \"kz1\": 5.0e-3,\n            \"kx\": 4.0e-3,\n            \"dB\": np.array([-1.95e-6, -1.02e-6, 0.0, 1.03e-6, 1.96e-6], dtype=float),\n        },\n        {\n            # Case C\n            \"x\": np.array([-0.02, -0.015, -0.005, 0.0, 0.01, 0.015, 0.02, -0.01, 0.0, 0.015], dtype=float),\n            \"z\": np.array([-0.02, -0.01, 0.0, 0.01, 0.02, -0.015, 0.0, 0.02, -0.02, 0.015], dtype=float),\n            \"kz1\": 6.0e-3,\n            \"kx\": 4.0e-3,\n            \"dB\": np.array([0.85e-6, 0.12e-6, -0.24e-6, -0.88e-6, -1.32e-6, 2.90e-6, 0.95e-6, -2.26e-6, 1.74e-6, -0.60e-6], dtype=float),\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        x = case[\"x\"]\n        z = case[\"z\"]\n        kz1 = case[\"kz1\"]\n        kx = case[\"kx\"]\n        dB = case[\"dB\"]\n\n        # Construct design matrix A with columns [kz1 * z, kx * x]\n        A = np.column_stack((kz1 * z, kx * x))\n\n        # Target vector b = -dB\n        b = -dB\n\n        # Compute minimum-norm least-squares solution for currents [I_Z1, I_X]\n        # Using lstsq which handles rank-deficiency and returns the minimum-norm solution.\n        I, residuals, rank, s = np.linalg.lstsq(A, b, rcond=None)\n        I_z1, I_x = float(I[0]), float(I[1])\n\n        # Compute residual magnetic field after applying shim currents\n        dB_res = dB + A @ I  # vector of residuals in Tesla\n\n        # Convert residuals to frequency offsets (Hz)\n        f_res = gamma_hz_per_t * dB_res\n\n        # Compute RMS and Peak-to-Peak in Hz\n        rms_hz = float(np.sqrt(np.mean(f_res**2)))\n        p2p_hz = float(np.max(f_res) - np.min(f_res))\n\n        results.append([I_z1, I_x, rms_hz, p2p_hz])\n\n    # Final print statement in the exact required format.\n    # Print a single line: list of lists, each inner list has four floats.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3726346"}]}