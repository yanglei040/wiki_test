{"hands_on_practices": [{"introduction": "The primary motivation for staggered grid arrangements is to prevent the numerical pressure-velocity decoupling that can plague simple colocated schemes. This exercise provides a direct and illuminating demonstration of this core principle by tasking you to excite a \"checkerboard\" pressure mode and observe how different grid arrangements respond [@problem_id:3365597]. By comparing the behavior of a naive colocated gradient with the standard Marker-and-Cell (MAC) gradient, you will gain a concrete understanding of how staggering ensures a robust coupling between pressure and velocity fields.", "problem": "Consider the steady, incompressible Stokes equations on a two-dimensional periodic domain of length $L=1$ in each direction, with spatial coordinates $(x,y)$ and velocity field $\\mathbf{u}(x,y) = (u(x,y), v(x,y))$:\n$$\n-\\nabla p + \\nu \\nabla^2 \\mathbf{u} = \\mathbf{f}, \\quad \\nabla \\cdot \\mathbf{u} = 0,\n$$\nwhere $p(x,y)$ is the pressure, $\\nu$ is the kinematic viscosity, and $\\mathbf{f}(x,y)$ is a given body force. In a fractional-step projection approach, the pressure field $p$ is recovered from the following Poisson equation for pressure associated with enforcing discrete incompressibility:\n$$\n\\nabla^2 p = s,\n$$\nwhere $s$ is a discrete source constructed from the divergence of an intermediate velocity field. On a uniform Cartesian grid with spacing $\\Delta x = \\Delta y$, different grid arrangements lead to different discrete gradient and divergence operators. In particular:\n- The colocated (cell-centered) arrangement places $u$, $v$, and $p$ all at cell centers. A common naive central-difference implementation computes the discrete pressure gradient at centers using nearest neighbors in each coordinate direction:\n$$\n\\left(\\frac{\\partial p}{\\partial x}\\right)_{i,j}^{\\text{col}} = \\frac{p_{i+1,j} - p_{i-1,j}}{2 \\Delta x}, \\quad\n\\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j}^{\\text{col}} = \\frac{p_{i,j+1} - p_{i,j-1}}{2 \\Delta x}.\n$$\n- The Marker-and-Cell (MAC) staggered arrangement places $u$ on vertical faces at $(i+\\tfrac{1}{2}, j)$, $v$ on horizontal faces at $(i, j+\\tfrac{1}{2})$, and $p$ at cell centers $(i,j)$. The discrete pressure gradient naturally appears at faces:\n$$\n\\left(\\frac{\\partial p}{\\partial x}\\right)_{i+\\frac{1}{2},j}^{\\text{MAC}} = \\frac{p_{i+1,j} - p_{i,j}}{\\Delta x}, \\quad\n\\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j+\\frac{1}{2}}^{\\text{MAC}} = \\frac{p_{i,j+1} - p_{i,j}}{\\Delta x}.\n$$\n\nIt is known that colocated central differences admit a spurious pressure mode, often called a checkerboard mode, which is defined on an $N_x \\times N_y$ uniform periodic grid by\n$$\np_{i,j}^{\\text{chk}} = (-1)^{i+j}, \\quad i = 0,1,\\dots,N_x-1, \\quad j = 0,1,\\dots,N_y-1,\n$$\nand corresponds to the highest resolvable spatial frequency (the Nyquist mode). This mode can be excited by certain discrete forcings and, on colocated grids, can decouple from the momentum equations under naive interpolation from centers to faces, leading to nonphysical oscillations in $p$ that do not drive momentum. In contrast, the MAC staggering suppresses this decoupling because the face-centered discrete gradient directly samples adjacent cell-center pressures, and the checkerboard difference does not vanish at faces.\n\nYour task is to:\n1. Use a manufactured source $s_{i,j} = (-1)^{i+j}$ to excite the checkerboard mode in the discrete pressure Poisson equation with periodic boundary conditions, discretized by the standard five-point Laplacian. The discrete Fourier symbol of the five-point Laplacian on a uniform grid of spacing $\\Delta x$ is\n$$\n\\lambda(k_x,k_y) = \\frac{2}{\\Delta x^2}\\left(\\cos(k_x \\Delta x)-1\\right) + \\frac{2}{\\Delta x^2}\\left(\\cos(k_y \\Delta x)-1\\right),\n$$\nfor discrete wavenumbers $k_x = \\frac{2\\pi m}{L}$, $k_y = \\frac{2\\pi n}{L}$, where $m = 0,1,\\dots,N_x-1$ and $n = 0,1,\\dots,N_y-1$. The checkerboard mode corresponds to $(m,n) = (N_x/2, N_y/2)$ when $N_x$ and $N_y$ are even, giving $\\cos(\\pi) = -1$ and thus\n$$\n\\lambda_{\\text{chk}} = -\\frac{4}{\\Delta x^2} - \\frac{4}{\\Delta x^2} = -\\frac{8}{\\Delta x^2}.\n$$\nFrom this, the pressure amplitude associated with the checkerboard forcing scales as\n$$\nA_p(\\Delta x) = \\frac{1}{|\\lambda_{\\text{chk}}|} = \\frac{\\Delta x^2}{8}.\n$$\n2. Numerically solve the discrete periodic Poisson equation $\\nabla^2 p = s$ using the discrete Laplacian symbol above in the Fourier domain for a sequence of uniform grids, and extract the numerical amplitude $A_p(\\Delta x)$ of the checkerboard component by projecting the computed $p$ onto $p^{\\text{chk}}$.\n3. Compute and compare the root-mean-square (RMS) magnitude of the face-centered pressure gradient that would enter the momentum equations under:\n   - A colocated naive face-gradient obtained by averaging cell-centered gradients at adjacent cells to faces:\n   $$\n   \\left(\\frac{\\partial p}{\\partial x}\\right)_{i+\\frac{1}{2},j}^{\\text{col-face}} = \\frac{1}{2}\\left[\\left(\\frac{\\partial p}{\\partial x}\\right)_{i,j}^{\\text{col}} + \\left(\\frac{\\partial p}{\\partial x}\\right)_{i+1,j}^{\\text{col}}\\right], \\quad\n   \\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j+\\frac{1}{2}}^{\\text{col-face}} = \\frac{1}{2}\\left[\\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j}^{\\text{col}} + \\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j+1}^{\\text{col}}\\right].\n   $$\n   - The MAC face-gradient, as defined above. The RMS magnitude is defined as\n   $$\n   G_{\\text{RMS}} = \\sqrt{\\frac{1}{N_f}\\sum_{f} g_f^2},\n   $$\n   where $g_f$ ranges over all face gradient components in both directions and $N_f$ is the number of faces.\n4. Demonstrate numerically that:\n   - The colocated naive face-gradient is blind to the checkerboard component so that its RMS magnitude is numerically zero for the manufactured forcing, explaining the decoupling.\n   - The MAC face-gradient couples to the checkerboard mode, and its RMS magnitude scales like $\\mathcal{O}(\\Delta x)$ for the manufactured forcing because $A_p(\\Delta x) \\sim \\Delta x^2$ and the face gradient scales like $A_p(\\Delta x)/\\Delta x$.\n\nImplement a program that:\n- Builds the manufactured source $s_{i,j} = (-1)^{i+j}$ on a periodic domain of length $L=1$.\n- Solves the discrete Poisson equation in Fourier space using the discrete Laplacian symbol to obtain $p_{i,j}$.\n- Computes the numerical checkerboard amplitude $A_p(\\Delta x)$ via projection onto $(-1)^{i+j}$.\n- Computes $G_{\\text{RMS}}^{\\text{col-face}}$ and $G_{\\text{RMS}}^{\\text{MAC}}$ for the resulting $p_{i,j}$.\n- Reports the tuple $(A_p(\\Delta x), G_{\\text{RMS}}^{\\text{col-face}}, G_{\\text{RMS}}^{\\text{MAC}})$ for each grid.\n\nTest Suite:\n- Use square grids with $N_x=N_y$ and $L=1$ for the following cases:\n  1. $N_x=N_y=8$ (coarse grid, $\\Delta x = 1/8$).\n  2. $N_x=N_y=16$ (moderate grid, $\\Delta x = 1/16$).\n  3. $N_x=N_y=32$ (fine grid, $\\Delta x = 1/32$).\n  4. $N_x=N_y=64$ (very fine grid, $\\Delta x = 1/64$).\nAll reported quantities are dimensionless. Your program should produce a single line of output containing the results as a comma-separated list of four bracketed tuples, each tuple ordered as $(A_p(\\Delta x), G_{\\text{RMS}}^{\\text{col-face}}, G_{\\text{RMS}}^{\\text{MAC}})$ in the same order as the test cases, for example:\n\"[(a1,b1,c1),(a2,b2,c2),(a3,b3,c3),(a4,b4,c4)]\".", "solution": "We begin from the steady incompressible Stokes equations\n$$\n-\\nabla p + \\nu \\nabla^2 \\mathbf{u} = \\mathbf{f}, \\quad \\nabla \\cdot \\mathbf{u} = 0,\n$$\nwhich, under a fractional-step approach, leads to enforcing discrete incompressibility via a pressure Poisson equation\n$$\n\\nabla^2 p = s,\n$$\nwhere the source $s$ is obtained from the divergence of an intermediate velocity. On a uniform periodic grid, solving this Poisson equation in the discrete Fourier space is natural and reveals how certain spatial modes propagate into pressure. We focus on the checkerboard (Nyquist) mode,\n$$\np_{i,j}^{\\text{chk}} = (-1)^{i+j},\n$$\nwhich alternates in sign between neighboring cell centers.\n\nFor a uniform grid with spacing $\\Delta x$ and periodic boundary conditions, the standard five-point discrete Laplacian has Fourier symbol\n$$\n\\lambda(k_x,k_y) = \\frac{2}{\\Delta x^2}\\left(\\cos(k_x \\Delta x)-1\\right) + \\frac{2}{\\Delta x^2}\\left(\\cos(k_y \\Delta x)-1\\right),\n$$\nwith discrete wavenumbers $k_x = \\frac{2\\pi m}{L}$ and $k_y = \\frac{2\\pi n}{L}$, $m=0,\\dots,N_x-1$, $n=0,\\dots,N_y-1$, and $L=1$. For the checkerboard mode, $(m,n)=(N_x/2, N_y/2)$ and $k_x \\Delta x = \\pi$, $k_y \\Delta x = \\pi$, giving\n$$\n\\lambda_{\\text{chk}} = \\frac{2}{\\Delta x^2}\\left(\\cos \\pi - 1\\right) + \\frac{2}{\\Delta x^2}\\left(\\cos \\pi - 1\\right) = \\frac{2}{\\Delta x^2}\\left(-1 - 1\\right) + \\frac{2}{\\Delta x^2}\\left(-1 - 1\\right) = -\\frac{8}{\\Delta x^2}.\n$$\nForcing the Poisson equation with $s_{i,j}=(-1)^{i+j}$ means the right-hand side has only this mode. Therefore the solution is proportional to the same mode:\n$$\np_{i,j} = A_p(\\Delta x)\\, (-1)^{i+j}.\n$$\nPlugging into the discrete Poisson equation in Fourier space yields\n$$\n\\lambda_{\\text{chk}} A_p(\\Delta x) = 1 \\quad \\Rightarrow \\quad A_p(\\Delta x) = -\\frac{1}{\\lambda_{\\text{chk}}} = \\frac{\\Delta x^2}{8}.\n$$\nThus the amplitude of the checkerboard component in the computed pressure scales as $\\Delta x^2$.\n\nThe distinction between colocated and Marker-And-Cell (MAC) staggering enters through how the pressure gradient is represented in the momentum equations:\n- In a colocated (cell-centered) scheme, a common naive implementation uses central differences to estimate $\\left(\\frac{\\partial p}{\\partial x}\\right)_{i,j}^{\\text{col}}$ and $\\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j}^{\\text{col}}$ at cell centers. For the checkerboard pressure $p_{i,j} = A_p(\\Delta x)\\,(-1)^{i+j}$,\n$$\n\\left(\\frac{\\partial p}{\\partial x}\\right)_{i,j}^{\\text{col}} = \\frac{p_{i+1,j} - p_{i-1,j}}{2 \\Delta x}\n= \\frac{A_p(\\Delta x)\\left[(-1)^{i+1+j} - (-1)^{i-1+j}\\right]}{2\\Delta x}\n= \\frac{A_p(\\Delta x)\\,(-1)^{i+j}\\left[-1 - (-1)\\right]}{2\\Delta x} = 0,\n$$\nand a similar calculation shows $\\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j}^{\\text{col}}=0$. If one then naively forms face gradients by averaging adjacent center gradients, the resulting face pressure gradient that would drive the momentum equations is still zero. This demonstrates the decoupling: the checkerboard pressure produces no face-centered pressure force in the colocated naive scheme.\n- In the MAC staggered arrangement, the face-centered discrete gradient directly takes differences of adjacent center pressures:\n$$\n\\left(\\frac{\\partial p}{\\partial x}\\right)_{i+\\frac{1}{2},j}^{\\text{MAC}} = \\frac{p_{i+1,j} - p_{i,j}}{\\Delta x}\n= \\frac{A_p(\\Delta x)\\left[(-1)^{i+1+j} - (-1)^{i+j}\\right]}{\\Delta x}\n= \\frac{A_p(\\Delta x)\\,(-1)^{i+j}(-1 - 1)}{\\Delta x}\n= -\\frac{2\\,A_p(\\Delta x)}{\\Delta x}\\,(-1)^{i+j}.\n$$\nAn analogous expression holds for $\\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j+\\frac{1}{2}}^{\\text{MAC}}$. Consequently, the MAC face-gradient couples strongly to the checkerboard and drives momentum corrections that suppress such oscillations. The magnitude of the MAC face-gradient scales like $\\frac{A_p(\\Delta x)}{\\Delta x} \\sim \\frac{\\Delta x^2}{\\Delta x} = \\mathcal{O}(\\Delta x)$ for the manufactured forcing.\n\nAlgorithmic design for the program:\n1. For each test grid with $N_x=N_y$ and $\\Delta x = 1/N_x$, construct the manufactured source $s_{i,j} = (-1)^{i+j}$.\n2. Compute the two-dimensional discrete Fourier transform of $s$ to obtain $\\hat{s}(m,n)$.\n3. For each Fourier mode $(m,n)$, compute the discrete Laplacian symbol $\\lambda(m,n)$ using\n$$\n\\lambda(m,n) = \\frac{2}{\\Delta x^2}\\left(\\cos\\left(\\frac{2\\pi m}{N_x}\\right)-1\\right) + \\frac{2}{\\Delta x^2}\\left(\\cos\\left(\\frac{2\\pi n}{N_y}\\right)-1\\right).\n$$\n4. Compute $\\hat{p}(m,n) = \\hat{s}(m,n) / \\lambda(m,n)$ for all $(m,n)$ such that $\\lambda(m,n) \\neq 0$. The zero mode $(m,n)=(0,0)$ is absent in $\\hat{s}$ due to the alternating pattern, so division by zero does not occur.\n5. Inverse transform to obtain $p_{i,j}$ in physical space.\n6. Project $p$ onto the checkerboard pattern to extract the amplitude,\n$$\nA_p(\\Delta x) = \\frac{1}{N_x N_y} \\sum_{i=0}^{N_x-1}\\sum_{j=0}^{N_y-1} p_{i,j}(-1)^{i+j}.\n$$\n7. Compute colocated center gradients using central differences and then obtain colocated face-gradients by averaging adjacent center gradients to faces. Compute the root-mean-square magnitude over all faces:\n$$\nG_{\\text{RMS}}^{\\text{col-face}} = \\sqrt{\\frac{1}{N_f}\\sum_{f}\\left(g_{f}^{\\text{col-face}}\\right)^2}.\n$$\n8. Compute MAC face-gradients from adjacent center pressures and the corresponding root-mean-square magnitude:\n$$\nG_{\\text{RMS}}^{\\text{MAC}} = \\sqrt{\\frac{1}{N_f}\\sum_{f}\\left(g_{f}^{\\text{MAC}}\\right)^2}.\n$$\n9. Output $(A_p(\\Delta x), G_{\\text{RMS}}^{\\text{col-face}}, G_{\\text{RMS}}^{\\text{MAC}})$ for each grid in the test suite, aggregated into a single line as specified.\n\nExpected behavior:\n- The numerical $A_p(\\Delta x)$ should scale closely with $\\Delta x^2/8$ (up to floating-point and discrete transform normalization).\n- $G_{\\text{RMS}}^{\\text{col-face}}$ should be numerically zero (to machine precision), demonstrating that the colocated naive gradient is blind to checkerboard pressure.\n- $G_{\\text{RMS}}^{\\text{MAC}}$ should scale linearly with $\\Delta x$ for this manufactured forcing because the face gradient magnitude behaves like $2 A_p(\\Delta x)/\\Delta x$.\n\nThis directly exhibits the mechanism by which the Marker-and-Cell (MAC) staggered grid suppresses checkerboard pressure modes: by placing velocities at faces, the discrete pressure gradient is evaluated as a difference of neighboring pressures, which does not vanish for alternating patterns, and thereby couples the spurious mode into momentum where it is damped. In contrast, a colocated naive central difference for the pressure gradient at centers annihilates the alternating component, allowing the spurious pressure mode to persist without influencing the velocity field.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef discrete_laplacian_symbol(nx, ny, dx):\n    \"\"\"\n    Build the discrete Laplacian symbol lambda(m,n) for a periodic grid\n    using the five-point stencil central differences on a uniform grid.\n    \"\"\"\n    # Wavenumber indices m, n\n    m = np.arange(nx)\n    n = np.arange(ny)\n    # Cosine terms for each axis\n    cos_m = np.cos(2.0 * np.pi * m / nx)\n    cos_n = np.cos(2.0 * np.pi * n / ny)\n    # Broadcast to 2D grid of (m,n)\n    lam = (2.0 / dx**2) * (cos_m[:, None] - 1.0) + (2.0 / dx**2) * (cos_n[None, :] - 1.0)\n    return lam\n\ndef solve_poisson_checkerboard(nx, ny, L=1.0):\n    \"\"\"\n    Solve the discrete periodic Poisson equation for s_{i,j} = (-1)^{i+j}\n    using the discrete Laplacian symbol in Fourier space.\n\n    Returns:\n        p: computed pressure field (nx x ny)\n        Ap: numerical checkerboard amplitude via projection onto (-1)^{i+j}\n    \"\"\"\n    dx = L / nx\n    # Manufactured source s = (-1)^{i+j}\n    i = np.arange(nx)[:, None]\n    j = np.arange(ny)[None, :]\n    s = ((-1.0) ** (i + j)).astype(np.float64)\n\n    # FFT of source\n    s_hat = np.fft.fft2(s)\n\n    # Discrete Laplacian symbol\n    lam = discrete_laplacian_symbol(nx, ny, dx)\n\n    # Avoid division by zero: source has zero mean, so lam[0,0] won't be used\n    # Construct p_hat = s_hat / lam\n    # Use where to handle potential zeros robustly (though s_hat[0,0]==0)\n    p_hat = np.zeros_like(s_hat, dtype=np.complex128)\n    mask = lam != 0.0\n    p_hat[mask] = s_hat[mask] / lam[mask]\n\n    # Inverse FFT to get p\n    p = np.real(np.fft.ifft2(p_hat))\n\n    # Compute checkerboard amplitude Ap = mean(p * (-1)^{i+j})\n    pattern = ((-1.0) ** (i + j)).astype(np.float64)\n    Ap = np.sum(p * pattern) / (nx * ny)\n\n    return p, Ap, dx\n\ndef colocated_face_gradient_rms(p, dx):\n    \"\"\"\n    Compute colocated center gradients via central differences and then\n    naive face gradients by averaging adjacent center gradients.\n    Return RMS magnitude over all faces.\n    \"\"\"\n    nx, ny = p.shape\n\n    # Periodic shifts\n    p_ip = np.roll(p, -1, axis=0)\n    p_im = np.roll(p,  1, axis=0)\n    p_jp = np.roll(p, -1, axis=1)\n    p_jm = np.roll(p,  1, axis=1)\n\n    # Center gradients (central difference)\n    gx_c = (p_ip - p_im) / (2.0 * dx)\n    gy_c = (p_jp - p_jm) / (2.0 * dx)  # dx == dy\n\n    # Face gradients: average adjacent center gradients to faces\n    # x-faces at (i+1/2, j): average gx_c[i,j] and gx_c[i+1,j]\n    gx_face = 0.5 * (gx_c + np.roll(gx_c, -1, axis=0))\n    # y-faces at (i, j+1/2): average gy_c[i,j] and gy_c[i,j+1]\n    gy_face = 0.5 * (gy_c + np.roll(gy_c, -1, axis=1))\n\n    # RMS over all faces (both directions)\n    # Number of faces: 2 * nx * ny\n    rms = np.sqrt((np.sum(gx_face**2) + np.sum(gy_face**2)) / (2.0 * nx * ny))\n    return rms\n\ndef mac_face_gradient_rms(p, dx):\n    \"\"\"\n    Compute MAC face gradients directly from adjacent center pressures.\n    Return RMS magnitude over all faces.\n    \"\"\"\n    nx, ny = p.shape\n\n    # x-face gradient: (p_{i+1,j} - p_{i,j}) / dx\n    p_ip = np.roll(p, -1, axis=0)\n    gx_face = (p_ip - p) / dx\n\n    # y-face gradient: (p_{i,j+1} - p_{i,j}) / dx\n    p_jp = np.roll(p, -1, axis=1)\n    gy_face = (p_jp - p) / dx\n\n    rms = np.sqrt((np.sum(gx_face**2) + np.sum(gy_face**2)) / (2.0 * nx * ny))\n    return rms\n\ndef run_test_case(nx):\n    ny = nx\n    p, Ap, dx = solve_poisson_checkerboard(nx, ny, L=1.0)\n    rms_col = colocated_face_gradient_rms(p, dx)\n    rms_mac = mac_face_gradient_rms(p, dx)\n    return (Ap, rms_col, rms_mac)\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [8, 16, 32, 64]\n\n    results = []\n    for nx in test_cases:\n        Ap, rms_col, rms_mac = run_test_case(nx)\n        # Format each tuple with reasonable precision\n        results.append(f\"({Ap:.10f},{rms_col:.10e},{rms_mac:.10e})\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```", "id": "3365597"}, {"introduction": "A well-designed numerical scheme should not introduce spurious forces in simple, fundamental physical situations. This hands-on practice guides you to verify a crucial property of the MAC staggered grid: its ability to exactly balance the pressure gradient and a body force when the underlying analytical solution is polynomial [@problem_id:3365551]. By implementing a test case for a fluid in rigid-body rotation, you will demonstrate that the discrete MAC gradient operator perfectly represents the quadratic pressure field required for hydrostatic equilibrium, resulting in zero residual error to machine precision.", "problem": "Construct a program that verifies, on a Marker-and-Cell (MAC) staggered grid arrangement, that the discrete pressure gradient exactly cancels the centrifugal force for a rigid-body rotation velocity field. The physical setting is a steady, inviscid flow of a constant-density fluid undergoing rigid-body rotation with angular velocity vector $\\boldsymbol{\\Omega}$, where the velocity is given by $\\mathbf{u} = \\boldsymbol{\\Omega} \\times \\mathbf{r}$, with $\\mathbf{r}$ the position vector. The verification must be performed in the rotating frame where the centrifugal acceleration is modeled as a body force, and the hydrostatic balance is $-\\nabla p + \\rho \\mathbf{a}_{\\mathrm{cf}} = \\mathbf{0}$, for constant density $\\rho$, where $\\mathbf{a}_{\\mathrm{cf}}$ is the centrifugal acceleration. Use the well-tested formula $\\mathbf{a}_{\\mathrm{cf}} = -\\boldsymbol{\\Omega}\\times(\\boldsymbol{\\Omega}\\times \\mathbf{r})$. All quantities must be treated in the International System of Units (SI): positions in meters, time in seconds, mass in kilograms, and angular velocity in radians per second. The final residual must be expressed in $\\mathrm{N/m^3}$.\n\nUse the following MAC grid definitions on a uniform, orthogonal, two-dimensional grid embedded in the plane $z = z_0$:\n- Pressure $p$ is stored at cell centers at coordinates $(x_{i+\\frac{1}{2}}, y_{j+\\frac{1}{2}})$ with $x_{i+\\frac{1}{2}} = x_{\\min} + (i+\\frac{1}{2})\\Delta x$ and $y_{j+\\frac{1}{2}} = y_{\\min} + (j+\\frac{1}{2})\\Delta y$, for integers $i \\in \\{0,\\dots,N_x-1\\}$ and $j \\in \\{0,\\dots,N_y-1\\}$.\n- The $x$-momentum (the $u$-velocity location) is located at the centers of $x$-faces at $(x_{i+1}, y_{j+\\frac{1}{2}})$ where $x_{i+1} = x_{\\min} + (i+1)\\Delta x$, with $i \\in \\{0,\\dots,N_x-2\\}$ and $j \\in \\{0,\\dots,N_y-1\\}$. The MAC discrete pressure gradient in the $x$-momentum equation at $(i+\\frac{1}{2},j+\\frac{1}{2})$ is defined by $-\\partial p/\\partial x \\approx -\\left(p_{i+1,j} - p_{i,j}\\right)/\\Delta x$.\n- The $y$-momentum (the $v$-velocity location) is located at the centers of $y$-faces at $(x_{i+\\frac{1}{2}}, y_{j+1})$ where $y_{j+1} = y_{\\min} + (j+1)\\Delta y$, with $i \\in \\{0,\\dots,N_x-1\\}$ and $j \\in \\{0,\\dots,N_y-2\\}$. The MAC discrete pressure gradient in the $y$-momentum equation at $(i+\\frac{1}{2},j+\\frac{1}{2})$ is defined by $-\\partial p/\\partial y \\approx -\\left(p_{i,j+1} - p_{i,j}\\right)/\\Delta y$.\n\nYou must:\n- Derive from first principles a fluid pressure field $p(\\mathbf{r})$ for constant density $\\rho$ under rigid-body rotation such that the continuous hydrostatic balance $-\\nabla p + \\rho \\mathbf{a}_{\\mathrm{cf}} = \\mathbf{0}$ is satisfied.\n- Using that $p(\\mathbf{r})$, evaluate $p$ at all cell centers, compute the MAC discrete pressure gradients at the face centers, evaluate $\\rho \\mathbf{a}_{\\mathrm{cf}}$ at the same face centers, and then compute the pointwise residuals in the $x$- and $y$-momentum equations: $R_x = -\\left(p_{i+1,j}-p_{i,j}\\right)/\\Delta x + \\rho \\, a_{\\mathrm{cf},x}$ at $x$-faces, and $R_y = -\\left(p_{i,j+1}-p_{i,j}\\right)/\\Delta y + \\rho \\, a_{\\mathrm{cf},y}$ at $y$-faces.\n- Aggregate the result by reporting the maximum absolute residual over all interior faces and both components, i.e., $\\max\\left(\\max_{i,j} |R_x|, \\max_{i,j} |R_y|\\right)$, in $\\mathrm{N/m^3}$.\n\nAngle units: the angular velocity vector components in $\\boldsymbol{\\Omega} = (\\Omega_x,\\Omega_y,\\Omega_z)$ are in radians per second. Distances are in meters. Density is in $\\mathrm{kg/m^3}$. The residuals must be reported in $\\mathrm{N/m^3}$.\n\nTest Suite:\nFor each of the following parameter sets, compute the single scalar output described above.\n\n- Test $1$ (happy path, square cells, axis-aligned angular velocity):\n  - $\\rho = 1000$,\n  - $\\boldsymbol{\\Omega} = (0,0,10)$,\n  - domain: $x \\in [0,1]$, $y \\in [0,1]$, $z_0 = 0$,\n  - grid: $N_x = 64$, $N_y = 64$.\n- Test $2$ (rectangular cells, axis-aligned angular velocity, off-centered domain):\n  - $\\rho = 1$,\n  - $\\boldsymbol{\\Omega} = (0,0,2.5)$,\n  - domain: $x \\in [-2,3]$, $y \\in [-1,1]$, $z_0 = 0$,\n  - grid: $N_x = 50$, $N_y = 20$.\n- Test $3$ (non-axis-aligned angular velocity, nonzero plane offset):\n  - $\\rho = 1.2$,\n  - $\\boldsymbol{\\Omega} = (3,4,5)$,\n  - domain: $x \\in [1,2]$, $y \\in [-0.3,0.7]$, $z_0 = 0.2$,\n  - grid: $N_x = 37$, $N_y = 29$.\n- Test $4$ (minimal interior faces):\n  - $\\rho = 850$,\n  - $\\boldsymbol{\\Omega} = (0,0,0.1)$,\n  - domain: $x \\in [-1,1]$, $y \\in [-1,1]$, $z_0 = 0$,\n  - grid: $N_x = 2$, $N_y = 2$.\n- Test $5$ (larger angular speed, small domain):\n  - $\\rho = 997$,\n  - $\\boldsymbol{\\Omega} = (0,0,1000)$,\n  - domain: $x \\in [0.1,0.2]$, $y \\in [-0.05,0.05]$, $z_0 = 0$,\n  - grid: $N_x = 16$, $N_y = 16$.\n\nYour program must compute, for each test, the single scalar $\\max\\left(\\max_{i,j} |R_x|, \\max_{i,j} |R_y|\\right)$, and finally print a single line containing the results for the tests as a comma-separated list enclosed in square brackets, for example, $[r_1,r_2,r_3,r_4,r_5]$, where each $r_k$ is a floating-point value in $\\mathrm{N/m^3}$.", "solution": "The user-provided problem is a well-posed verification exercise in computational fluid dynamics. It is scientifically sound and all required information is provided.\n\nThe problem asks to verify, for a specific case, the property of a Marker-and-Cell (MAC) staggered grid discretization. The physical scenario is a fluid in steady, inviscid rigid-body rotation. In a reference frame rotating with the fluid, the governing equation for a static fluid is the hydrostatic balance between the pressure gradient and the body forces. The only body force considered, besides a uniform gravitational field which can be absorbed into a modified pressure, is the centrifugal force. The balance equation is given as:\n$$-\\nabla p + \\rho \\mathbf{a}_{\\mathrm{cf}} = \\mathbf{0}$$\nwhere $p$ is the pressure, $\\rho$ is the constant fluid density, and $\\mathbf{a}_{\\mathrm{cf}}$ is the centrifugal acceleration. The problem is to demonstrate that the standard MAC grid discretization of this equation results in a zero residual, up to machine precision, when the exact analytical pressure field is used. This is a verification of the discretization's ability to exactly represent a certain class of analytical solutions.\n\n## Principle-Based Design and Derivations\n\n### 1. Analytical Pressure Field Derivation\nFirst, we derive the analytical pressure field $p(\\mathbf{r})$ that satisfies the continuous hydrostatic balance equation. The equation can be written as:\n$$\\nabla p = \\rho \\mathbf{a}_{\\mathrm{cf}}$$\nThe centrifugal acceleration is given by the formula $\\mathbf{a}_{\\mathrm{cf}} = -\\boldsymbol{\\Omega} \\times (\\boldsymbol{\\Omega} \\times \\mathbf{r})$, where $\\boldsymbol{\\Omega}$ is the constant angular velocity vector and $\\mathbf{r}$ is the position vector.\n\nUsing the vector triple product identity $\\mathbf{A} \\times (\\mathbf{B} \\times \\mathbf{C}) = \\mathbf{B}(\\mathbf{A} \\cdot \\mathbf{C}) - \\mathbf{C}(\\mathbf{A} \\cdot \\mathbf{B})$, we expand the expression for $\\mathbf{a}_{\\mathrm{cf}}$:\n$$\\mathbf{a}_{\\mathrm{cf}} = -[\\boldsymbol{\\Omega}(\\boldsymbol{\\Omega} \\cdot \\mathbf{r}) - \\mathbf{r}(\\boldsymbol{\\Omega} \\cdot \\boldsymbol{\\Omega})]$$\n$$\\mathbf{a}_{\\mathrm{cf}} = (\\boldsymbol{\\Omega} \\cdot \\boldsymbol{\\Omega})\\mathbf{r} - (\\boldsymbol{\\Omega} \\cdot \\mathbf{r})\\boldsymbol{\\Omega}$$\nLet $\\Omega^2 = |\\boldsymbol{\\Omega}|^2 = \\boldsymbol{\\Omega} \\cdot \\boldsymbol{\\Omega}$. The pressure gradient is therefore:\n$$\\nabla p = \\rho [ \\Omega^2 \\mathbf{r} - (\\boldsymbol{\\Omega} \\cdot \\mathbf{r})\\boldsymbol{\\Omega} ]$$\nThis vector field is the gradient of a scalar potential. We can find $p(\\mathbf{r})$ by integrating. We recognize parts of the expression as gradients of scalar fields:\n$$\\nabla(\\frac{1}{2} r^2) = \\nabla(\\frac{1}{2} \\mathbf{r} \\cdot \\mathbf{r}) = \\mathbf{r}$$\n$$\\nabla(\\frac{1}{2}(\\boldsymbol{\\Omega} \\cdot \\mathbf{r})^2) = (\\boldsymbol{\\Omega} \\cdot \\mathbf{r}) \\nabla(\\boldsymbol{\\Omega} \\cdot \\mathbf{r}) = (\\boldsymbol{\\Omega} \\cdot \\mathbf{r})\\boldsymbol{\\Omega}$$\nSubstituting these into the expression for $\\nabla p$:\n$$\\nabla p = \\rho [ \\Omega^2 \\nabla(\\frac{1}{2} r^2) - \\nabla(\\frac{1}{2}(\\boldsymbol{\\Omega} \\cdot \\mathbf{r})^2) ] = \\nabla \\left[ \\frac{1}{2}\\rho ( \\Omega^2 r^2 - (\\boldsymbol{\\Omega} \\cdot \\mathbf{r})^2 ) \\right]$$\nIntegrating with respect to $\\mathbf{r}$ yields the pressure field, up to an arbitrary constant $p_0$:\n$$p(\\mathbf{r}) = \\frac{1}{2}\\rho (\\Omega^2 r^2 - (\\boldsymbol{\\Omega} \\cdot \\mathbf{r})^2) + p_0$$\nThis can be expressed more compactly using the identity $|\\mathbf{A} \\times \\mathbf{B}|^2 = |\\mathbf{A}|^2 |\\mathbf{B}|^2 - (\\mathbf{A} \\cdot \\mathbf{B})^2$:\n$$p(\\mathbf{r}) = \\frac{1}{2}\\rho |\\boldsymbol{\\Omega} \\times \\mathbf{r}|^2 + p_0$$\nSince only pressure differences matter, we can set the reference pressure $p_0$ to $0$.\n\n### 2. Discretization and Residual Analysis\nThe problem specifies a 2D MAC grid in the plane $z=z_0$. Pressure $p$ is located at cell centers $(x_{i+1/2}, y_{j+1/2})$, while the velocity components (and thus momentum equation residuals) are at face centers.\nThe residual for the $x$-momentum equation, $R_x$, is evaluated at the centers of the vertical faces, at locations $(x_{i+1}, y_{j+1/2})$. The residual is defined as:\n$$R_x = -\\frac{p_{i+1,j} - p_{i,j}}{\\Delta x} + \\rho \\, a_{\\mathrm{cf},x}|_{(x_{i+1}, y_{j+1/2})}$$\nwhere $p_{i,j}$ denotes the pressure at the center of cell $(i,j)$, i.e., $p(x_{i+1/2}, y_{j+1/2}, z_0)$.\n\nA critical observation is that the analytical pressure field $p(x,y,z_0)$ is a quadratic polynomial of the spatial coordinates $x$ and $y$. Let us expand the expression for $p$ with $\\mathbf{r}=(x,y,z_0)$ and $\\boldsymbol{\\Omega}=(\\Omega_x, \\Omega_y, \\Omega_z)$:\n$$p(x,y) = \\frac{1}{2}\\rho [(\\Omega_x^2+\\Omega_y^2+\\Omega_z^2)(x^2+y^2+z_0^2) - (\\Omega_x x + \\Omega_y y + \\Omega_z z_0)^2]$$\n$$p(x,y) = A x^2 + B y^2 + C xy + D x + E y + F$$\nwhere $A, B, C, D, E, F$ are constants that depend on $\\rho, \\boldsymbol{\\Omega},$ and $z_0$.\n\nThe discrete pressure gradient term $-\\frac{p_{i+1,j} - p_{i,j}}{\\Delta x}$ is a centered finite difference approximation of $-\\frac{\\partial p}{\\partial x}$. The pressure values are taken at cell centers $(x_{i+1/2}, y_{j+1/2})$ and $(x_{i+3/2}, y_{j+1/2})$. The midpoint between these two locations is $(x_{i+1}, y_{j+1/2})$, which is precisely the location where the residual $R_x$ is evaluated.\n\nFor any quadratic polynomial $f(x) = ax^2 + bx + c$, the centered finite difference is exact, meaning it equals the analytical derivative at the midpoint:\n$$\\frac{f(x_0 + h/2) - f(x_0 - h/2)}{h} = \\frac{[a(x_0+h/2)^2 + b(x_0+h/2)+c] - [a(x_0-h/2)^2 + b(x_0-h/2)+c]}{h} = 2ax_0 + b = f'(x_0)$$\nSince our pressure field $p(x,y)$ is quadratic in $x$ (for a fixed $y$), the discrete gradient is exactly equal to the continuous gradient at the face center:\n$$\\frac{p_{i+1,j} - p_{i,j}}{\\Delta x} = \\left. \\frac{\\partial p}{\\partial x} \\right|_{(x_{i+1}, y_{j+1/2})}$$\nFrom our initial derivation, we know that the continuous pressure field exactly balances the centrifugal force, i.e., $\\nabla p = \\rho \\mathbf{a}_{\\mathrm{cf}}$. This implies $\\frac{\\partial p}{\\partial x} = \\rho a_{\\mathrm{cf},x}$ at every point in space.\nTherefore, at the face center $(x_{i+1}, y_{j+1/2})$:\n$$\\frac{p_{i+1,j} - p_{i,j}}{\\Delta x} = \\left. \\rho a_{\\mathrm{cf},x} \\right|_{(x_{i+1}, y_{j+1/2})}$$\nSubstituting this into the definition of the residual $R_x$:\n$$R_x = -\\left(\\rho a_{\\mathrm{cf},x}\\right) + \\rho a_{\\mathrm{cf},x} = 0$$\nThe same logic applies to the $y$-component residual, $R_y$. Thus, the discrete residuals are analytically zero. The numerical implementation should yield results that are zero to within the limits of floating-point precision.\n\n### 3. Algorithmic Implementation\nThe program will implement the verification for each test case by following these steps:\n1.  Parse the test case parameters: $\\rho$, $\\boldsymbol{\\Omega}$, domain boundaries, $z_0$, and grid resolution $N_x, N_y$.\n2.  Calculate grid spacings $\\Delta x$ and $\\Delta y$.\n3.  Generate coordinate arrays for pressure cell centers using NumPy broadcasting for efficiency.\n4.  Evaluate the analytical pressure field $p(\\mathbf{r})$ at all cell centers to populate a 2D pressure array `p_grid`.\n5.  For the $x$-momentum residuals:\n    a. Generate coordinate arrays for the centers of the interior vertical faces.\n    b. Compute the discrete pressure gradient $-\\left(p_{i+1,j}-p_{i,j}\\right)/\\Delta x$ for all relevant faces.\n    c. Evaluate the centrifugal force term $\\rho a_{\\mathrm{cf},x}$ at the same face centers.\n    d. Calculate the residual $R_x$ as the sum of the two terms.\n6.  Repeat the process for the $y$-momentum residuals, $R_y$, on interior horizontal faces.\n7.  Determine the maximum absolute value over all computed $R_x$ and $R_y$ values. This is the final result for the test case.\n8.  Collect the results from all test cases and format them as specified.\n\nThis algorithm directly implements the formulas and definitions from the problem statement and leverages the analytical solution derived above to test the property of the numerical scheme.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the verification for all test cases and print the results.\n    \"\"\"\n\n    def calculate_max_residual(params):\n        \"\"\"\n        Calculates the maximum absolute residual for a single test case.\n\n        Args:\n            params (tuple): A tuple containing all parameters for the test case:\n                (rho, Omega_vec, domain_x, domain_y, z0, Nx, Ny).\n\n        Returns:\n            float: The maximum absolute residual found on the grid.\n        \"\"\"\n        rho, Omega_vec, domain_x, domain_y, z0, Nx, Ny = params\n        Omega_vec = np.array(Omega_vec, dtype=float)\n        x_min, x_max = domain_x\n        y_min, y_max = domain_y\n\n        dx = (x_max - x_min) / Nx\n        dy = (y_max - y_min) / Ny\n\n        # --- 1. Calculate pressure at cell centers ---\n        # Use broadcasting to create coordinate grids implicitly\n        i_p = np.arange(Nx, dtype=float).reshape(-1, 1)\n        j_p = np.arange(Ny, dtype=float).reshape(1, -1)\n        x_p = x_min + (i_p + 0.5) * dx\n        y_p = y_min + (j_p + 0.5) * dy\n\n        # Evaluate analytical pressure field p(r) = 0.5 * rho * |Omega x r|^2\n        omega_sq = np.dot(Omega_vec, Omega_vec)\n        r_sq = x_p**2 + y_p**2 + z0**2\n        omega_dot_r = Omega_vec[0] * x_p + Omega_vec[1] * y_p + Omega_vec[2] * z0\n        p_grid = 0.5 * rho * (omega_sq * r_sq - omega_dot_r**2)\n\n        max_res = 0.0\n\n        # --- 2. Calculate x-momentum residual Rx ---\n        if Nx > 1:\n            # Coordinates of x-face centers (where Rx is evaluated)\n            i_rx = np.arange(Nx - 1, dtype=float).reshape(-1, 1)\n            j_rx = np.arange(Ny, dtype=float).reshape(1, -1)\n            x_fx = x_min + (i_rx + 1.0) * dx\n            y_fx = y_min + (j_rx + 0.5) * dy\n\n            # Discrete pressure gradient component in x\n            grad_p_x = (p_grid[1:, :] - p_grid[:-1, :]) / dx\n\n            # Centrifugal force component at x-faces: rho * a_cf,x\n            # a_cf = Omega^2 * r - (Omega . r) * Omega\n            omega_dot_r_fx = Omega_vec[0] * x_fx + Omega_vec[1] * y_fx + Omega_vec[2] * z0\n            a_cf_x = omega_sq * x_fx - omega_dot_r_fx * Omega_vec[0]\n            force_x = rho * a_cf_x\n\n            # Calculate residual\n            Rx = -grad_p_x + force_x\n            max_res = max(max_res, np.max(np.abs(Rx)))\n\n        # --- 3. Calculate y-momentum residual Ry ---\n        if Ny > 1:\n            # Coordinates of y-face centers (where Ry is evaluated)\n            i_ry = np.arange(Nx, dtype=float).reshape(-1, 1)\n            j_ry = np.arange(Ny - 1, dtype=float).reshape(1, -1)\n            x_fy = x_min + (i_ry + 0.5) * dx\n            y_fy = y_min + (j_ry + 1.0) * dy\n\n            # Discrete pressure gradient component in y\n            grad_p_y = (p_grid[:, 1:] - p_grid[:, :-1]) / dy\n\n            # Centrifugal force component at y-faces: rho * a_cf,y\n            omega_dot_r_fy = Omega_vec[0] * x_fy + Omega_vec[1] * y_fy + Omega_vec[2] * z0\n            a_cf_y = omega_sq * y_fy - omega_dot_r_fy * Omega_vec[1]\n            force_y = rho * a_cf_y\n\n            # Calculate residual\n            Ry = -grad_p_y + force_y\n            max_res = max(max_res, np.max(np.abs(Ry)))\n\n        return max_res\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Test 1: rho, Omega, domain_x, domain_y, z0, Nx, Ny\n        (1000.0, (0.0, 0.0, 10.0), (0.0, 1.0), (0.0, 1.0), 0.0, 64, 64),\n        # Test 2\n        (1.0, (0.0, 0.0, 2.5), (-2.0, 3.0), (-1.0, 1.0), 0.0, 50, 20),\n        # Test 3\n        (1.2, (3.0, 4.0, 5.0), (1.0, 2.0), (-0.3, 0.7), 0.2, 37, 29),\n        # Test 4\n        (850.0, (0.0, 0.0, 0.1), (-1.0, 1.0), (-1.0, 1.0), 0.0, 2, 2),\n        # Test 5\n        (997.0, (0.0, 0.0, 1000.0), (0.1, 0.2), (-0.05, 0.05), 0.0, 16, 16),\n    ]\n\n    results = []\n    for case in test_cases:\n        result = calculate_max_residual(case)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3365551"}, {"introduction": "While staggered grids provide a robust theoretical framework, their correct implementation requires careful attention to detail, especially at boundaries. This diagnostic exercise confronts a common and subtle implementation bug: the off-by-half-cell placement of pressure boundary conditions in a simple hydrostatic test case [@problem_id:3365549]. By analyzing the resulting spurious velocities, you will learn to appreciate the importance of geometric consistency between discrete variables and physical boundaries, and develop skills in using hydrostatic balance checks to debug and verify your code.", "problem": "Consider a vertical $1\\mathrm{D}$ column of an incompressible fluid of density $\\rho$ under gravitational acceleration $g$ acting in the negative $y$-direction. The domain spans $y \\in [0,L]$ and is discretized on a Marker-and-Cell (MAC) staggered grid: pressure unknowns $p_j$ are stored at cell centers $y_j = (j - \\tfrac{1}{2}) \\Delta y$, $j = 1,\\dots,N$, and the vertical velocity unknowns $u_i$ are stored at the cell faces $y_{i} = i \\Delta y$, $i = 0,\\dots,N$, where $\\Delta y = L/N$. Assume no-penetration at the boundaries so that $u_0 = u_N = 0$.\n\nIn hydrostatic equilibrium, the continuous pressure is $p(y) = p_{\\mathrm{ref}} - \\rho g\\, y$, so that $\\partial p/\\partial y = -\\rho g$ and the true fluid velocity is $u(y) \\equiv 0$. On the discrete MAC grid, the pressure gradient at an interior face $y_i$ is approximated by a centered difference\n$$\n\\left.\\frac{\\partial p}{\\partial y}\\right|_{y_i} \\approx \\frac{p_{i+1} - p_i}{\\Delta y}, \\quad i = 1,\\dots,N-1.\n$$\nA common implementation error is to impose Dirichlet pressure boundary conditions using the physical boundary values at the wrong index, namely placing $p_1 \\leftarrow p(0)$ and $p_N \\leftarrow p(L)$, instead of values appropriate to the cell centers at $y = \\tfrac{1}{2}\\Delta y$ and $y = L - \\tfrac{1}{2}\\Delta y$. Suppose this off-by-half-cell error is made at both ends. At all interior centers $j = 2,\\dots,N-1$, assume the pressure is exactly hydrostatic, i.e., $p_j = p\\big((j - \\tfrac{1}{2})\\Delta y\\big)$.\n\nTo diagnose the resulting hydrostatic imbalance, consider a single explicit predictor update of the vertical velocity that includes only the body force and the discrete pressure gradient (ignore viscosity and the projection step for this diagnostic), starting from rest $u_i^n = 0$:\n$$\nu_i^{n+1} = u_i^n - \\frac{\\Delta t}{\\rho} \\frac{p_{i+1} - p_i}{\\Delta y} - g \\,\\Delta t, \\quad i = 1,\\dots,N-1.\n$$\nHere $\\Delta t$ is an arbitrary time step used only to non-dimensionalize the imbalance. You may take $p_{\\mathrm{ref}}$ to be arbitrary.\n\nWhich statement best characterizes the spurious velocity pattern $u_i^{n+1}$ produced by the off-by-half-cell pressure boundary conditions, and prescribes a correct remedy for the boundary condition placement on a MAC grid?\n\nA. The discrete pressure gradient at the first interior faces $i=1$ and $i=N-1$ becomes too negative, specifically $(p_{i+1} - p_i)/\\Delta y = -\\tfrac{3}{2}\\rho g$, producing upward spurious velocities $u_1^{n+1} = u_{N-1}^{n+1} = +\\tfrac{1}{2} g \\Delta t$, with $u_i^{n+1} = 0$ for $i=2,\\dots,N-2$. The correct fix is to impose the Dirichlet pressure at the proper indices by assigning the cell-center values to the hydrostatic values at $y = \\tfrac{1}{2}\\Delta y$ and $y = L - \\tfrac{1}{2}\\Delta y$, or equivalently to set ghost-cell pressures so that linear interpolation yields the physical boundary pressure.\n\nB. The imbalance generates a uniform shear so that all interior face velocities satisfy $u_i^{n+1} = +\\tfrac{1}{2} g \\Delta t$ for $i=1,\\dots,N-1$. The correct fix is to co-locate pressure and velocity unknowns on the same grid.\n\nC. The error excites a pressure–velocity decoupling mode, producing an alternating-sign checkerboard in $u_i^{n+1}$ across all interior faces with amplitude $\\tfrac{1}{2} g \\Delta t$. The correct fix is to switch to a collocated grid and use Rhie–Chow interpolation.\n\nD. The pressure boundary error cancels at the two ends, so $u_i^{n+1} = 0$ for all $i$ in this hydrostatic test. The only practical remedy is to reduce $\\Delta t$ to suppress transients.", "solution": "This problem tests the understanding of how boundary conditions must be applied on a staggered grid to maintain hydrostatic balance. Let's analyze the pressure gradient at different faces.\n\n### Givens\n- Hydrostatic pressure: $p(y) = p_{\\mathrm{ref}} - \\rho g y$.\n- MAC grid: Pressure $p_j$ at cell centers $y_j = (j - \\tfrac{1}{2})\\Delta y$; velocity $u_i$ at faces $y_i = i\\Delta y$.\n- Boundary condition error: $p_1$ is set to $p(0)$ and $p_N$ is set to $p(L)$.\n- Interior pressure: $p_j = p(y_j)$ for $j=2, \\dots, N-1$.\n- Velocity update: $u_i^{n+1} = - \\frac{\\Delta t}{\\rho} \\frac{p_{i+1} - p_i}{\\Delta y} - g \\Delta t$, starting from $u_i^n=0$.\n\n### Analysis of the Discrete Pressure Gradient\n\n1.  **Face $i=1$ (between cell 1 and 2):**\n    The gradient is $(p_2 - p_1) / \\Delta y$.\n    -   $p_1$ is incorrectly set to $p(0) = p_{\\mathrm{ref}}$.\n    -   $p_2$ is correctly set at its cell center $y_2 = (2 - \\tfrac{1}{2})\\Delta y = \\tfrac{3}{2}\\Delta y$. So, $p_2 = p(\\tfrac{3}{2}\\Delta y) = p_{\\mathrm{ref}} - \\rho g (\\tfrac{3}{2}\\Delta y)$.\n    -   The discrete gradient is:\n        $$ \\frac{p_2 - p_1}{\\Delta y} = \\frac{(p_{\\mathrm{ref}} - \\tfrac{3}{2}\\rho g \\Delta y) - p_{\\mathrm{ref}}}{\\Delta y} = -\\frac{3}{2}\\rho g $$\n    This is incorrect; the hydrostatic gradient should be $-\\rho g$. The error is $-\\frac{1}{2}\\rho g$.\n\n2.  **Face $i=N-1$ (between cell $N-1$ and $N$):**\n    The gradient is $(p_N - p_{N-1}) / \\Delta y$.\n    -   $p_N$ is incorrectly set to $p(L) = p(N\\Delta y) = p_{\\mathrm{ref}} - \\rho g N \\Delta y$.\n    -   $p_{N-1}$ is correctly set at its cell center $y_{N-1} = (N-1 - \\tfrac{1}{2})\\Delta y = (N - \\tfrac{3}{2})\\Delta y$. So, $p_{N-1} = p_{\\mathrm{ref}} - \\rho g (N - \\tfrac{3}{2})\\Delta y$.\n    -   The discrete gradient is:\n        $$ \\frac{p_N - p_{N-1}}{\\Delta y} = \\frac{(p_{\\mathrm{ref}} - \\rho g N \\Delta y) - (p_{\\mathrm{ref}} - \\rho g (N - \\tfrac{3}{2})\\Delta y)}{\\Delta y} = \\frac{-\\rho g N \\Delta y + \\rho g (N - \\tfrac{3}{2})\\Delta y}{\\Delta y} = -\\frac{3}{2}\\rho g $$\n    Again, the gradient is incorrect by the same amount.\n\n3.  **An interior face $i \\in [2, N-2]$:**\n    The gradient is $(p_{i+1} - p_i) / \\Delta y$.\n    -   $p_{i+1}$ is at center $y_{i+1} = (i+1 - \\tfrac{1}{2})\\Delta y = (i + \\tfrac{1}{2})\\Delta y$. So, $p_{i+1} = p_{\\mathrm{ref}} - \\rho g (i + \\tfrac{1}{2})\\Delta y$.\n    -   $p_i$ is at center $y_i = (i - \\tfrac{1}{2})\\Delta y$. So, $p_i = p_{\\mathrm{ref}} - \\rho g (i - \\tfrac{1}{2})\\Delta y$.\n    -   The discrete gradient is:\n        $$ \\frac{p_{i+1} - p_i}{\\Delta y} = \\frac{(p_{\\mathrm{ref}} - \\rho g (i + \\tfrac{1}{2})\\Delta y) - (p_{\\mathrm{ref}} - \\rho g (i - \\tfrac{1}{2})\\Delta y)}{\\Delta y} = \\frac{-\\rho g \\Delta y}{\\Delta y} = -\\rho g $$\n    This is the correct hydrostatic gradient.\n\n### Analysis of Spurious Velocity\n\nNow we compute $u_i^{n+1}$ using the update formula $u_i^{n+1} = - \\frac{\\Delta t}{\\rho}(\\text{gradient}) - g \\Delta t$.\n\n-   **For $i=1$ and $i=N-1$**: The gradient is $-\\tfrac{3}{2}\\rho g$.\n    $$ u_{1, N-1}^{n+1} = - \\frac{\\Delta t}{\\rho} \\left(-\\frac{3}{2}\\rho g\\right) - g \\Delta t = +\\frac{3}{2}g\\Delta t - g\\Delta t = +\\frac{1}{2}g\\Delta t $$\n    A spurious upward velocity is generated at the faces adjacent to the boundaries.\n\n-   **For $i \\in [2, N-2]$**: The gradient is $-\\rho g$.\n    $$ u_i^{n+1} = - \\frac{\\Delta t}{\\rho} (-\\rho g) - g \\Delta t = +g\\Delta t - g \\Delta t = 0 $$\n    No spurious velocity is generated in the interior of the domain.\n\n### Evaluating the Options\n\n*   **A:** This option states the gradient at $i=1, N-1$ is $-\\tfrac{3}{2}\\rho g$, the spurious velocity is $+\\tfrac{1}{2} g \\Delta t$ at these locations and zero elsewhere. This exactly matches our derivation. It also correctly identifies the fix: setting pressure values at cell centers, or using ghost cells to interpolate to the boundary. **This is the correct answer.**\n\n*   **B:** This option claims a uniform shear where all interior velocities are non-zero. Our analysis shows the spurious velocity is localized to the boundaries. The proposed fix, co-locating variables, would introduce the checkerboard decoupling problem that the staggered grid is designed to solve. This is incorrect.\n\n*   **C:** This option incorrectly claims a checkerboard velocity pattern. The error is localized, not oscillatory. The proposed fix, Rhie–Chow interpolation, is a technique for collocated grids to prevent checkerboard pressure modes, and is irrelevant to this staggered grid boundary condition problem. This is incorrect.\n\n*   **D:** This option incorrectly claims the errors cancel and the velocity is zero everywhere. Our calculation clearly shows a non-zero velocity. Reducing the time step $\\Delta t$ would reduce the magnitude of the spurious velocity *per step*, but it does not fix the underlying spatial discretization error that creates the imbalance. The imbalance force is constant, so velocity would continue to grow over time. This is incorrect.", "answer": "$$\\boxed{A}$$", "id": "3365549"}]}