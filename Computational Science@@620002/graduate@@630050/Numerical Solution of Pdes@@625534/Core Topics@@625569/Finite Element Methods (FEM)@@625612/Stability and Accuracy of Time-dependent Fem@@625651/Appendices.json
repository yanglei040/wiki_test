{"hands_on_practices": [{"introduction": "Understanding the stability of time-dependent finite element schemes is paramount for obtaining reliable numerical solutions. This first exercise provides a foundational walkthrough of stability analysis for an explicit time-stepping method. By applying the Forward Euler scheme to the semi-discretized heat equation, you will directly confront the core principle that stability is governed by the discrete spectrum of the spatial operator, leading to a constraint on the time step size [@problem_id:3447081]. This practice will solidify your skills in assembling FEM matrices and performing a spectral analysis to derive a concrete stability bound from first principles.", "problem": "Consider the one-dimensional heat equation $u_{t} = \\nu u_{xx}$ on the spatial interval $[0,L]$ with homogeneous Dirichlet boundary conditions $u(0,t) = 0$ and $u(L,t) = 0$, where $\\nu > 0$ is the thermal diffusivity. Discretize the spatial domain into three uniform subintervals of length $h = L/3$ and approximate $u(x,t)$ by continuous, piecewise-linear basis functions associated with the four mesh nodes. Enforce the boundary conditions strongly at $x=0$ and $x=L$, so that the semidiscrete system is written in terms of the two interior nodal degrees of freedom. Use the standard Galerkin Finite Element Method (FEM) with the consistent mass matrix. Denote the resulting semidiscrete system by $M \\dot{\\mathbf{u}}(t) + \\nu K \\mathbf{u}(t) = \\mathbf{0}$, where $M$ is the $2 \\times 2$ mass matrix and $K$ is the $2 \\times 2$ stiffness matrix.\n\nTime-discretize this semidiscrete system using the forward Euler method with uniform time step $\\Delta t$, so that the fully discrete update is $\\mathbf{u}^{n+1} = \\mathbf{u}^{n} - \\Delta t \\,\\nu\\, M^{-1} K \\,\\mathbf{u}^{n}$. Starting from the variational formulation and the element-wise definitions of $M$ and $K$, assemble the global interior matrices and perform a spectral analysis via the generalized eigenvalue problem $K \\mathbf{v} = \\mu M \\mathbf{v}$ to determine the largest admissible time step $\\Delta t_{\\max}$ for which the method is non-amplifying in the $\\ell^{2}$-norm for all modes.\n\nProvide the exact, closed-form symbolic expression for $\\Delta t_{\\max}$ in terms of $L$ and $\\nu$. Express your answer in seconds. Your final answer must be a single closed-form expression and must not contain inequalities or additional conditions.", "solution": "The problem requires finding the maximum stable time step for the forward Euler time discretization of a semidiscrete finite element approximation of the one-dimensional heat equation.\n\nThe governing partial differential equation is the heat equation:\n$$\nu_{t} = \\nu u_{xx}, \\quad x \\in [0,L], t>0\n$$\nwith homogeneous Dirichlet boundary conditions $u(0,t) = 0$ and $u(L,t) = 0$. The parameter $\\nu > 0$ is the thermal diffusivity.\n\nThe standard Galerkin finite element method begins with the variational (or weak) formulation. We seek a solution $u(\\cdot, t)$ in the function space $H^1_0([0,L])$ such that for any test function $v \\in H^1_0([0,L])$:\n$$\n\\int_{0}^{L} u_t v \\,dx = \\int_{0}^{L} (\\nu u_{xx}) v \\,dx\n$$\nIntegrating the right-hand side by parts and applying the homogeneous boundary conditions gives:\n$$\n\\int_{0}^{L} u_t v \\,dx = -\\nu \\int_{0}^{L} u_x v_x \\,dx\n$$\nThe spatial domain $[0,L]$ is discretized into three uniform subintervals, so the mesh size is $h = L/3$. The nodes are located at $x_0=0$, $x_1=L/3$, $x_2=2L/3$, and $x_3=L$. We use continuous, piecewise-linear basis functions $\\phi_i(x)$. The approximate solution is written as a linear combination of these basis functions:\n$$\nu_h(x,t) = \\sum_{j=0}^{3} u_j(t) \\phi_j(x)\n$$\nThe boundary conditions $u(0,t)=0$ and $u(L,t)=0$ are enforced strongly, which means $u_0(t)=0$ and $u_3(t)=0$. The approximation is therefore defined by the two interior nodal values:\n$$\nu_h(x,t) = u_1(t)\\phi_1(x) + u_2(t)\\phi_2(x)\n$$\nWe choose our test functions from the same finite-dimensional space, i.e., $v_h(x) = \\phi_i(x)$ for $i=1,2$. Substituting $u_h$ and $v_h$ into the weak form yields a system of ordinary differential equations for the interior nodal values $\\mathbf{u}(t) = [u_1(t), u_2(t)]^T$:\n$$\nM \\dot{\\mathbf{u}}(t) + \\nu K \\mathbf{u}(t) = \\mathbf{0}\n$$\nwhere $M$ is the consistent mass matrix and $K$ is the stiffness matrix, with entries:\n$$\nM_{ij} = \\int_0^L \\phi_j(x) \\phi_i(x) \\,dx \\quad \\text{and} \\quad K_{ij} = \\int_0^L \\phi'_j(x) \\phi'_i(x) \\,dx\n$$\nTo compute these matrices, we first determine the element mass matrix $M^e$ and element stiffness matrix $K^e$ for a generic element of length $h$. Using linear shape functions $N_1(\\xi) = 1-\\xi/h$ and $N_2(\\xi) = \\xi/h$ on a local domain $[0,h]$, we find:\n$$\nM^e = \\int_0^h \\begin{pmatrix} N_1^2 & N_1 N_2 \\\\ N_2 N_1 & N_2^2 \\end{pmatrix} d\\xi = \\frac{h}{6} \\begin{pmatrix} 2 & 1 \\\\ 1 & 2 \\end{pmatrix}\n$$\n$$\nK^e = \\int_0^h \\begin{pmatrix} (N'_1)^2 & N'_1 N'_2 \\\\ N'_2 N'_1 & (N'_2)^2 \\end{pmatrix} d\\xi = \\frac{1}{h} \\begin{pmatrix} 1 & -1 \\\\ -1 & 1 \\end{pmatrix}\n$$\nThe global matrices for the two interior degrees of freedom are assembled from the contributions of the three elements: $[x_0, x_1]$, $[x_1, x_2]$, and $[x_2, x_3]$.\nFor the mass matrix $M$:\n$M_{11}$ receives contributions from element $1$ (node $2$) and element $2$ (node $1$): $M_{11} = M^e_{22} + M^e_{11} = h/3 + h/3 = 2h/3$.\n$M_{22}$ receives contributions from element $2$ (node $2$) and element $3$ (node $1$): $M_{22} = M^e_{22} + M^e_{11} = h/3 + h/3 = 2h/3$.\n$M_{12} = M_{21}$ receives a contribution from element $2$: $M_{12} = M^e_{12} = h/6$.\n$$\nM = \\begin{pmatrix} 2h/3 & h/6 \\\\ h/6 & 2h/3 \\end{pmatrix} = \\frac{h}{6} \\begin{pmatrix} 4 & 1 \\\\ 1 & 4 \\end{pmatrix}\n$$\nFor the stiffness matrix $K$:\n$K_{11}$ receives contributions from element $1$ (node $2$) and element $2$ (node $1$): $K_{11} = K^e_{22} + K^e_{11} = 1/h + 1/h = 2/h$.\n$K_{22}$ receives contributions from element $2$ (node $2$) and element $3$ (node $1$): $K_{22} = K^e_{22} + K^e_{11} = 1/h + 1/h = 2/h$.\n$K_{12} = K_{21}$ receives a contribution from element $2$: $K_{12} = K^e_{12} = -1/h$.\n$$\nK = \\begin{pmatrix} 2/h & -1/h \\\\ -1/h & 2/h \\end{pmatrix} = \\frac{1}{h} \\begin{pmatrix} 2 & -1 \\\\ -1 & 2 \\end{pmatrix}\n$$\nThe semidiscrete system is discretized in time using the forward Euler method with time step $\\Delta t$:\n$$\n\\frac{\\mathbf{u}^{n+1} - \\mathbf{u}^{n}}{\\Delta t} = - \\nu M^{-1} K \\mathbf{u}^{n}\n$$\nThis gives the fully discrete update rule:\n$$\n\\mathbf{u}^{n+1} = (I - \\Delta t \\, \\nu M^{-1} K) \\mathbf{u}^{n}\n$$\nThe matrix $G = I - \\Delta t \\, \\nu M^{-1} K$ is the amplification matrix. For the method to be non-amplifying (stable), the spectral radius of $G$ must satisfy $\\rho(G) \\le 1$.\nThe eigenvalues of $G$, denoted $\\lambda_G$, are related to the eigenvalues of $M^{-1}K$, denoted $\\mu$, by $\\lambda_G = 1 - \\Delta t \\, \\nu \\mu$. The eigenvalues $\\mu$ are the solutions to the generalized eigenvalue problem $K \\mathbf{v} = \\mu M \\mathbf{v}$.\nSince $M$ and $K$ are symmetric positive definite, the eigenvalues $\\mu$ are real and positive. The stability condition $|\\lambda_G| \\le 1$ becomes:\n$$\n|1 - \\Delta t \\, \\nu \\mu| \\le 1 \\implies -1 \\le 1 - \\Delta t \\, \\nu \\mu \\le 1\n$$\nThe right inequality is always satisfied for $\\Delta t, \\nu, \\mu > 0$. The left inequality gives:\n$$\n-2 \\le - \\Delta t \\, \\nu \\mu \\implies \\Delta t \\le \\frac{2}{\\nu \\mu}\n$$\nTo ensure stability for all modes, this condition must hold for the largest eigenvalue, $\\mu_{\\max}$. Thus, the maximum stable time step is:\n$$\n\\Delta t_{\\max} = \\frac{2}{\\nu \\mu_{\\max}}\n$$\nWe now solve the generalized eigenvalue problem $\\det(K - \\mu M) = 0$:\n$$\n\\det\\left( \\frac{1}{h} \\begin{pmatrix} 2 & -1 \\\\ -1 & 2 \\end{pmatrix} - \\mu \\frac{h}{6} \\begin{pmatrix} 4 & 1 \\\\ 1 & 4 \\end{pmatrix} \\right) = 0\n$$\n$$\n\\det\\begin{pmatrix} \\frac{2}{h} - \\frac{4\\mu h}{6} & -\\frac{1}{h} - \\frac{\\mu h}{6} \\\\ -\\frac{1}{h} - \\frac{\\mu h}{6} & \\frac{2}{h} - \\frac{4\\mu h}{6} \\end{pmatrix} = 0\n$$\nThis yields the characteristic equation:\n$$\n\\left(\\frac{2}{h} - \\frac{2\\mu h}{3}\\right)^2 - \\left(-\\frac{1}{h} - \\frac{\\mu h}{6}\\right)^2 = 0\n$$\nThis is of the form $A^2 - B^2 = 0$, which factors into $(A-B)(A+B) = 0$.\n\nCase 1: $A-B = 0$\n$$\n\\left(\\frac{2}{h} - \\frac{2\\mu h}{3}\\right) - \\left(-\\frac{1}{h} - \\frac{\\mu h}{6}\\right) = 0 \\implies \\frac{3}{h} - \\frac{3\\mu h}{6} = 0 \\implies \\frac{3}{h} = \\frac{\\mu h}{2} \\implies \\mu_1 = \\frac{6}{h^2}\n$$\nCase 2: $A+B = 0$\n$$\n\\left(\\frac{2}{h} - \\frac{2\\mu h}{3}\\right) + \\left(-\\frac{1}{h} - \\frac{\\mu h}{6}\\right) = 0 \\implies \\frac{1}{h} - \\frac{5\\mu h}{6} = 0 \\implies \\frac{1}{h} = \\frac{5\\mu h}{6} \\implies \\mu_2 = \\frac{6}{5h^2}\n$$\nThe eigenvalues are $\\mu_1 = 6/h^2$ and $\\mu_2 = 6/(5h^2)$. The maximum eigenvalue is:\n$$\n\\mu_{\\max} = \\frac{6}{h^2}\n$$\nNow we can compute the maximum stable time step:\n$$\n\\Delta t_{\\max} = \\frac{2}{\\nu \\mu_{\\max}} = \\frac{2}{\\nu (6/h^2)} = \\frac{2h^2}{6\\nu} = \\frac{h^2}{3\\nu}\n$$\nThe problem specifies that the domain $[0,L]$ is divided into three subintervals, so the mesh size is $h = L/3$. Substituting this into the expression for $\\Delta t_{\\max}$:\n$$\n\\Delta t_{\\max} = \\frac{(L/3)^2}{3\\nu} = \\frac{L^2/9}{3\\nu} = \\frac{L^2}{27\\nu}\n$$\nThis is the final expression for the maximum admissible time step.", "answer": "$$\\boxed{\\frac{L^2}{27\\nu}}$$", "id": "3447081"}, {"introduction": "While theoretical analysis often assumes exact operators, practical implementations of FEM rely on numerical quadrature, which can introduce subtle errors. This practice explores the consequences of such approximations, specifically how under-integration of the mass matrix can compromise the stability of an otherwise robust implicit method like BDF2. You will write code to assemble matrices with varying quadrature accuracy and numerically investigate the impact on stability by analyzing the spectral radius of the time-stepping operator [@problem_id:3447128]. This exercise bridges the gap between theory and computational practice, highlighting the importance of coercivity and careful implementation for ensuring numerical stability.", "problem": "Consider the linear, time-dependent Finite Element Method (FEM) semidiscretization of a one-dimensional diffusion operator on the unit interval with homogeneous Dirichlet boundary conditions. The semidiscrete model reads $M \\dot{u} + K u = f$, where $M$ is the mass matrix and $K$ is the stiffness matrix assembled from continuous, piecewise-linear shape functions on a uniform mesh. Assume $f \\equiv 0$ so that the continuous evolution is contractive relative to the energy induced by the exact $M$. The Backward Differentiation Formula of order two (BDF2) is known to be absolutely stable (A-stable) for the scalar test equation with nonpositive real spectrum.\n\nYour task is to quantify how quadrature errors during the assembly of $M$ impact the observed step-wise absolute stability of BDF2 when applied to $M \\dot{u} + K u = 0$, and to provide a quantitative degradation metric as a function of the quadrature order used for $M$. Work strictly from the following fundamental bases: the Galerkin definition of $M$ and $K$, the definition of BDF2 as a two-step implicit formula for $\\dot{u}$, and the spectral characterization of stability in terms of the spectral radius of the one-step amplification operator.\n\nImplement the following, adhering to all the specifications:\n\n1) Geometry and discretization:\n- Use a uniform partition of the unit interval $[0,1]$ with $N$ elements and continuous, piecewise-linear basis with homogeneous Dirichlet boundary conditions at both endpoints. Use $N = 32$.\n- Assemble the exact stiffness matrix $K$ using exact integration on each element.\n- Assemble two mass matrices: the exact mass matrix $M_{\\text{ex}}$ using exact integration, and an approximate mass matrix $M_q$ assembled by Gauss–Legendre quadrature with $q$ points per element, where $q \\in \\{1,2,3\\}$.\n\n2) Time discretization:\n- Apply the Backward Differentiation Formula of order two (BDF2) to the semidiscrete system $M_q \\dot{u} + K u = 0$ on a uniform timestep $\\Delta t$. Start from the definition of BDF2 as a two-step, linear multistep formula that approximates $\\dot{u}$ at the new time using a linear combination of $u$ at the new and two previous timesteps, without assuming any shortcut formulas.\n\n3) Stability characterization:\n- Derive the linear, time-invariant, one-step amplification operator that maps the block state $[u^n; u^{n-1}]$ to $[u^{n+1}; u^n]$ for the homogeneous problem with $M_q$ in place of $M$. Define the spectral radius of this amplification operator and use it to measure absolute stability at a given $\\Delta t$.\n- Quantify the coercivity degradation of the approximate mass with respect to the exact mass by the smallest generalized eigenvalue $c(q)$ of the pair $(M_q, M_{\\text{ex}})$, that is, the minimum of the Rayleigh quotient $v^\\top M_q v / v^\\top M_{\\text{ex}} v$ over nonzero $v$. This number satisfies $c(q) \\in [0,\\infty)$ and measures the worst-case relative underestimation of mass; values near $0$ indicate loss of coercivity.\n\n4) Test suite and metrics to output:\n- Use $N = 32$ elements.\n- Use quadrature orders $q \\in \\{1,2,3\\}$ for assembling $M_q$.\n- Use the timestep set $\\Delta t \\in \\{10^{-3}, 10^{-1}, 1, 10\\}$.\n- For each $q$, compute two quantities:\n  a) The coercivity ratio $c(q)$ as defined above.\n  b) The maximum spectral radius $\\rho_{\\max}(q)$ of the BDF2 amplification operator over the given $\\Delta t$ values.\n\n5) Output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, ordered as $[c(1), \\rho_{\\max}(1), c(2), \\rho_{\\max}(2), c(3), \\rho_{\\max}(3)]$.\n- All outputs must be real numbers in floating-point format.\n\nThere are no physical units involved; all quantities are dimensionless. Angles are not used. Percentages are not used; ratios must be expressed as decimal numbers. The numerical results must be computed directly by your program for the specified test suite; no external input is allowed.", "solution": "We begin from the standard Galerkin Finite Element Method (FEM) semidiscretization for a one-dimensional diffusion operator on $[0,1]$ with homogeneous Dirichlet boundary conditions. Let $N$ be the number of elements, nodes are $x_i = i h$ for $i=0,\\dots,N$ with uniform spacing $h = 1/N$. The piecewise-linear, continuous basis with nodal values at interior nodes defines the mass and stiffness matrices by\n$$\n(M_{\\text{ex}})_{ij} = \\int_0^1 \\varphi_i(x) \\varphi_j(x)\\,dx,\\qquad\nK_{ij} = \\int_0^1 \\varphi_i'(x) \\varphi_j'(x)\\,dx.\n$$\nOn each element of length $h$, the exact local contributions for piecewise-linear basis functions are\n$$\nM_{\\text{loc,ex}} = \\frac{h}{6} \\begin{bmatrix}2 & 1 \\\\ 1 & 2 \\end{bmatrix}, \\qquad\nK_{\\text{loc}} = \\frac{1}{h} \\begin{bmatrix} 1 & -1 \\\\ -1 & 1 \\end{bmatrix}.\n$$\nThe approximate mass matrix $M_q$ is obtained by evaluating the element integrals for the mass using Gauss–Legendre quadrature with $q$ points per element. On a single element with local coordinate $\\xi \\in [0,1]$, the basis functions are $\\varphi_1(\\xi)=1-\\xi$ and $\\varphi_2(\\xi)=\\xi$, the Jacobian is $h$, and the approximate local mass entries are\n$$\n(M_{\\text{loc},q})_{ab} \\approx h \\sum_{\\ell=1}^{q} w_\\ell\\, \\varphi_a(\\xi_\\ell)\\,\\varphi_b(\\xi_\\ell),\n$$\nwhere $(\\xi_\\ell,w_\\ell)$ are the Gauss–Legendre points and weights mapped to $[0,1]$ from $[-1,1]$. The stiffness matrix is assembled exactly using $K_{\\text{loc}}$ above. Dirichlet boundary conditions are enforced by restricting to the interior degrees of freedom.\n\nFor time discretization, consider the semidiscrete system with approximate mass,\n$$\nM_q \\dot{u}(t) + K u(t) = 0.\n$$\nThe Backward Differentiation Formula of order two (BDF2) is a two-step implicit linear multistep method. Starting from the definition for a scalar function $y(t)$ on a uniform grid with timestep $\\Delta t$, the BDF2 approximation to the derivative at time $t_{n+1}$ is\n$$\n\\dot{y}(t_{n+1}) \\approx \\frac{1}{\\Delta t}\\left( \\frac{3}{2} y^{n+1} - 2 y^{n} + \\frac{1}{2} y^{n-1} \\right).\n$$\nApplying this definition to the vector system with $M_q$ and $K$ gives\n$$\nM_q \\frac{1}{\\Delta t}\\left( \\frac{3}{2} u^{n+1} - 2 u^{n} + \\frac{1}{2} u^{n-1} \\right) + K u^{n+1} = 0.\n$$\nRearranging terms, we obtain the linear system determining the new value $u^{n+1}$ from the two previous values:\n$$\n\\left(\\frac{3}{2} M_q + \\Delta t\\, K\\right) u^{n+1} = 2 M_q u^{n} - \\frac{1}{2} M_q u^{n-1}.\n$$\nDefine the matrices\n$$\nA := \\frac{3}{2} M_q + \\Delta t\\, K,\\qquad B := 2 M_q,\\qquad C := -\\frac{1}{2} M_q.\n$$\nThen\n$$\nu^{n+1} = A^{-1} B\\, u^{n} + A^{-1} C\\, u^{n-1}.\n$$\nIntroducing the block state vector $w^n = \\begin{bmatrix} u^n \\\\ u^{n-1} \\end{bmatrix}$, the one-step amplification operator $T(\\Delta t)$ that maps $w^n$ to $w^{n+1}$ is\n$$\nw^{n+1} =\n\\begin{bmatrix}\nA^{-1} B & A^{-1} C \\\\\nI & 0\n\\end{bmatrix}\n\\begin{bmatrix}\nu^n \\\\ u^{n-1}\n\\end{bmatrix}\n=: T(\\Delta t)\\, w^n.\n$$\nThe absolute stability at a given $\\Delta t$ is characterized by the spectral radius $\\rho(T(\\Delta t))$, which is the maximum magnitude of the eigenvalues of $T(\\Delta t)$. For the homogeneous problem, non-increasing amplitude under iteration corresponds to $\\rho(T(\\Delta t)) \\le 1$.\n\nTo quantify the effect of quadrature error in $M_q$, we define the coercivity ratio with respect to the exact mass as the minimum generalized eigenvalue of the pair $(M_q, M_{\\text{ex}})$:\n$$\nc(q) := \\min_{v \\ne 0} \\frac{v^\\top M_q v}{v^\\top M_{\\text{ex}} v}.\n$$\nThis is the smallest value in the generalized spectrum of $M_q v = \\lambda M_{\\text{ex}} v$. It measures the worst-case underestimation of the $M_{\\text{ex}}$-norm by the inexact quadrature mass. For exact quadrature on piecewise-linear elements, $M_q = M_{\\text{ex}}$, so $c(q) = 1$. Under-integration can lead to $c(q)$ significantly below $1$, and even $c(q)=0$ if $M_q$ loses coercivity along some directions.\n\nAlgorithmic steps:\n- Assemble $K$ exactly and $M_{\\text{ex}}$ exactly on the interior degrees of freedom for the uniform mesh.\n- For each quadrature order $q \\in \\{1,2,3\\}$, assemble $M_q$ by Gauss–Legendre quadrature with $q$ points per element.\n- Compute the coercivity ratio $c(q)$ as the minimal generalized eigenvalue of $(M_q, M_{\\text{ex}})$.\n- For each $\\Delta t \\in \\{10^{-3}, 10^{-1}, 1, 10\\}$, form $T(\\Delta t)$ and compute its spectral radius $\\rho(T(\\Delta t))$. Let $\\rho_{\\max}(q)$ be the maximum of $\\rho(T(\\Delta t))$ over the given $\\Delta t$ values.\n- Output the list $[c(1), \\rho_{\\max}(1), c(2), \\rho_{\\max}(2), c(3), \\rho_{\\max}(3)]$ as a single line.\n\nRationale:\n- The derivation uses the Galerkin definition of $M$ and $K$ and the fundamental definition of BDF2 to construct the time-stepping operator.\n- The spectral radius of $T(\\Delta t)$ quantifies absolute stability for the linear, autonomous homogeneous system.\n- The generalized eigenvalue problem defining $c(q)$ is a direct mathematical measure of the quadrature-induced loss of coercivity relative to the exact inner product, which is essential in energy-based stability analyses. For example, with $q=1$ (one Gauss point per element), the quadrature is not exact for the quadratic integrand $\\varphi_i \\varphi_j$, which can lead to a semidefinite $M_q$ and $c(1)=0$, while for $q \\ge 2$ it is exact for piecewise-linear bases and yields $c(q)=1$.\n\nThe program implements these steps with $N=32$, $q \\in \\{1,2,3\\}$, and $\\Delta t \\in \\{10^{-3}, 10^{-1}, 1, 10\\}$, and reports the requested aggregated results.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import linalg\n\ndef assemble_matrices(n_elements: int, q_points: int):\n    \"\"\"\n    Assemble stiffness K (exact), exact mass M_ex, and quadrature-based mass M_q\n    for 1D P1 FEM on [0,1] with homogeneous Dirichlet BCs.\n\n    Parameters:\n        n_elements: number of uniform elements (N)\n        q_points: number of Gauss-Legendre points per element for mass quadrature\n\n    Returns:\n        M_q: (n_dof x n_dof) mass matrix with q-point quadrature\n        K:   (n_dof x n_dof) exact stiffness matrix\n        M_ex:(n_dof x n_dof) exact mass matrix\n    \"\"\"\n    N = n_elements\n    h = 1.0 / N\n    n_dof = N - 1  # interior nodes\n\n    # Initialize matrices\n    M_q = np.zeros((n_dof, n_dof), dtype=float)\n    M_ex = np.zeros((n_dof, n_dof), dtype=float)\n    K = np.zeros((n_dof, n_dof), dtype=float)\n\n    # Exact local matrices (P1)\n    Mloc_ex = (h / 6.0) * np.array([[2.0, 1.0],\n                                    [1.0, 2.0]], dtype=float)\n    Kloc = (1.0 / h) * np.array([[1.0, -1.0],\n                                 [-1.0, 1.0]], dtype=float)\n\n    # Gauss-Legendre quadrature nodes/weights on [0,1]\n    # Map from [-1,1] nodes/weights\n    if q_points >= 1:\n        xi_gl, w_gl = np.polynomial.legendre.leggauss(q_points)\n        xi = 0.5 * (xi_gl + 1.0)  # to [0,1]\n        w = 0.5 * w_gl\n    else:\n        raise ValueError(\"q_points must be >= 1\")\n\n    # Shape functions on reference [0,1]\n    def phi1(xi_ref):\n        return 1.0 - xi_ref\n\n    def phi2(xi_ref):\n        return xi_ref\n\n    # Assemble over elements\n    for e in range(N):\n        # Global node indices\n        left = e\n        right = e + 1\n\n        # Local mass with quadrature\n        Mloc_q = np.zeros((2, 2), dtype=float)\n        for (xip, wp) in zip(xi, w):\n            vals = np.array([phi1(xip), phi2(xip)], dtype=float)\n            Mloc_q += h * wp * np.outer(vals, vals)\n\n        # Add to global matrices with Dirichlet BC handling (interior indices)\n        # Interior indices: i-1 for global node i in 1..N-1\n        li = left - 1\n        ri = right - 1\n\n        # Mass exact\n        if 0 <= li < n_dof:\n            M_ex[li, li] += Mloc_ex[0, 0]\n        if 0 <= ri < n_dof:\n            M_ex[ri, ri] += Mloc_ex[1, 1]\n        if 0 <= li < n_dof and 0 <= ri < n_dof:\n            M_ex[li, ri] += Mloc_ex[0, 1]\n            M_ex[ri, li] += Mloc_ex[1, 0]\n\n        # Mass quadrature\n        if 0 <= li < n_dof:\n            M_q[li, li] += Mloc_q[0, 0]\n        if 0 <= ri < n_dof:\n            M_q[ri, ri] += Mloc_q[1, 1]\n        if 0 <= li < n_dof and 0 <= ri < n_dof:\n            M_q[li, ri] += Mloc_q[0, 1]\n            M_q[ri, li] += Mloc_q[1, 0]\n\n        # Stiffness exact\n        if 0 <= li < n_dof:\n            K[li, li] += Kloc[0, 0]\n        if 0 <= ri < n_dof:\n            K[ri, ri] += Kloc[1, 1]\n        if 0 <= li < n_dof and 0 <= ri < n_dof:\n            K[li, ri] += Kloc[0, 1]\n            K[ri, li] += Kloc[1, 0]\n\n    return M_q, K, M_ex\n\ndef bdf2_step_matrix(M: np.ndarray, K: np.ndarray, dt: float):\n    \"\"\"\n    Construct the BDF2 amplification matrix T(dt) for the homogeneous system\n    M u_dot + K u = 0, using mass matrix M and stiffness K.\n\n    T maps [u^n; u^{n-1}] to [u^{n+1}; u^n].\n\n    Returns:\n        T: (2n x 2n) amplification matrix\n    \"\"\"\n    n = M.shape[0]\n    A = 1.5 * M + dt * K\n    B = 2.0 * M\n    C = -0.5 * M\n\n    # Solve A X = B and A Y = C\n    X = linalg.solve(A, B, assume_a='sym')\n    Y = linalg.solve(A, C, assume_a='sym')\n\n    # Build block matrix\n    T = np.zeros((2 * n, 2 * n), dtype=float)\n    T[:n, :n] = X\n    T[:n, n:] = Y\n    T[n:, :n] = np.eye(n)\n    # T[n:, n:] already zeros\n    return T\n\ndef spectral_radius(mat: np.ndarray) -> float:\n    vals = linalg.eig(mat, left=False, right=False)\n    return float(np.max(np.abs(vals)))\n\ndef coercivity_ratio(M_q: np.ndarray, M_ex: np.ndarray) -> float:\n    \"\"\"\n    Compute the smallest generalized eigenvalue of (M_q, M_ex).\n    Since M_ex is SPD and M_q is symmetric (possibly semidefinite),\n    use symmetric generalized eigenvalue solver.\n    \"\"\"\n    # Ensure symmetry\n    Mq_sym = 0.5 * (M_q + M_q.T)\n    Mex_sym = 0.5 * (M_ex + M_ex.T)\n    # Generalized symmetric eigenproblem\n    # eigh returns real eigenvalues; handle potential tiny negative due to rounding.\n    vals = linalg.eigh(Mq_sym, Mex_sym, lower=True, eigvals_only=True)\n    # Clean up numerical noise\n    vals_real = np.real(vals)\n    # Minimal eigenvalue\n    lam_min = float(np.min(vals_real))\n    # Clamp tiny negatives to zero\n    if lam_min < 0 and abs(lam_min) < 1e-12:\n        lam_min = 0.0\n    return lam_min\n\ndef solve():\n    # Define the test cases from the problem statement.\n    N = 32\n    q_list = [1, 2, 3]\n    dt_list = [1e-3, 1e-1, 1.0, 10.0]\n\n    results = []\n    for q in q_list:\n        Mq, K, Mex = assemble_matrices(N, q_points=q)\n        # Coercivity degradation metric\n        c_q = coercivity_ratio(Mq, Mex)\n\n        # Stability metric: maximum spectral radius over dt_list\n        rho_max = 0.0\n        for dt in dt_list:\n            T = bdf2_step_matrix(Mq, K, dt)\n            rho = spectral_radius(T)\n            if rho > rho_max:\n                rho_max = rho\n\n        # Append results in order [c(q), rho_max(q)]\n        # Format to a reasonable number of decimals for stable output\n        results.append(f\"{c_q:.6f}\")\n        results.append(f\"{rho_max:.6f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```", "id": "3447128"}, {"introduction": "Achieving higher-order accuracy in FEM sometimes involves spatial post-processing to extract more precise information from the computed solution. However, the effectiveness of such techniques depends on their interaction with the time-evolution operator. This problem demonstrates a crucial mechanism for accuracy degradation: the failure of the time-stepping and post-processing operators to commute [@problem_id:3447131]. Through a combination of analytical expansion and direct matrix computation, you will quantify this non-commutativity and understand how it can spoil superconvergence, providing a valuable lesson on the careful composition of numerical operators.", "problem": "Consider the one-dimensional heat equation with heterogeneous diffusion,\n$$\nu_{t} - \\partial_{x}\\!\\left(a(x)\\,\\partial_{x} u\\right) = 0 \\quad \\text{in } (0,1), \\qquad u(0,t)=0,\\; u(1,t)=0,\n$$\nand initial data $u(x,0)=u_{0}(x)$ sufficiently smooth. Discretize in space by the Finite Element Method (FEM) (continuous, piecewise linear basis) on the uniform mesh with $N=3$ elements and mesh size $h=1/3$. Use the consistent mass matrix. Let the diffusion coefficient be piecewise constant with values\n$$\na(x) = \\begin{cases}\n1, & x \\in [0,1/3],\\\\\n2, & x \\in [1/3,2/3],\\\\\n3, & x \\in [2/3,1].\n\\end{cases}\n$$\nLet $M \\in \\mathbb{R}^{2\\times 2}$ and $K \\in \\mathbb{R}^{2\\times 2}$ denote the interior-degree-of-freedom consistent mass and stiffness matrices under homogeneous Dirichlet boundary conditions. Advance in time by one backward Euler step of size $\\tau>0$, whose discrete one-step solution operator is\n$$\nE_{\\tau} := (M + \\tau K)^{-1} M.\n$$\nConsider the following spatial postprocessing operator $S:\\mathbb{R}^{2}\\to\\mathbb{R}^{2}$ defined by the nodal three-point smoothing that uses the homogeneous boundary values $u_{0}=u_{3}=0$:\n$$\n(Su)_{1} := \\frac{u_{0} + 2u_{1} + u_{2}}{4} = \\frac{1}{2}u_{1} + \\frac{1}{4}u_{2}, \\qquad (Su)_{2} := \\frac{u_{1} + 2u_{2} + u_{3}}{4} = \\frac{1}{4}u_{1} + \\frac{1}{2}u_{2}.\n$$\nDefine the discrete spatial operator $B := M^{-1}K$ and the commutator\n$$\nC := SB - BS.\n$$\nYou are to construct and analyze this example to demonstrate a mechanism by which refining the time step $\\tau$ on the fixed mesh destroys superconvergence of the postprocessed solution. In particular, use the first-order Neumann series expansion of the resolvent to argue that for small $\\tau$,\n$$\nSE_{\\tau} - E_{\\tau}S = -\\tau\\,C + \\mathcal{O}(\\tau^{2}),\n$$\nso noncommutation, $C\\neq 0$, injects an unavoidable leading-order $\\mathcal{O}(\\tau)$ term that spoils any superconvergent cancellation. Then, explicitly assemble $M$, $K$, $B$, $S$, and $C$ for the data above, and compute the largest singular value of $C$ (i.e., the operator $2$-norm of $C$). This number quantifies the magnitude of the leading-order commutator defect and is the requested output. No rounding is required, and you should report an exact value with no units.", "solution": "The problem asks for two main tasks: first, to demonstrate analytically how a non-zero commutator between a post-processing operator and the discrete spatial operator can degrade the accuracy of a numerical scheme, and second, to compute the magnitude of this effect for a specific example.\n\nFirst, let us analyze the expression for the commutation error between the spatial postprocessing operator $S$ and the one-step backward Euler time-stepping operator $E_{\\tau}$.\nThe one-step operator is given by $E_{\\tau} = (M + \\tau K)^{-1} M$. Let $B = M^{-1}K$ be the discrete spatial operator. We can rewrite $E_{\\tau}$ as:\n$$\nE_{\\tau} = (M(I + \\tau M^{-1}K))^{-1} M = (I + \\tau B)^{-1} M^{-1} M = (I + \\tau B)^{-1}\n$$\nHere, $I$ is the $2 \\times 2$ identity matrix. For a sufficiently small time step $\\tau$, we can use the Neumann series expansion for the matrix inverse (the resolvent):\n$$\n(I + \\tau B)^{-1} = I - \\tau B + (\\tau B)^{2} - (\\tau B)^{3} + \\dots = I - \\tau B + \\mathcal{O}(\\tau^{2})\n$$\nThe commutation error between $S$ and $E_{\\tau}$ is $SE_{\\tau} - E_{\\tau}S$. Substituting the expansion gives:\n$$\nSE_{\\tau} - E_{\\tau}S = S(I - \\tau B + \\mathcal{O}(\\tau^{2})) - (I - \\tau B + \\mathcal{O}(\\tau^{2}))S\n$$\nExpanding the products, we have:\n$$\nSE_{\\tau} - E_{\\tau}S = (S - \\tau SB + \\mathcal{O}(\\tau^{2})) - (S - \\tau BS + \\mathcal{O}(\\tau^{2}))\n$$\nThe terms of order zero, $S - S$, cancel out. The leading-order term in $\\tau$ is:\n$$\nSE_{\\tau} - E_{\\tau}S = -\\tau SB + \\tau BS + \\mathcal{O}(\\tau^{2}) = -\\tau(SB - BS) + \\mathcal{O}(\\tau^{2})\n$$\nDefining the commutator $C := SB - BS$, we arrive at the desired expression:\n$$\nSE_{\\tau} - E_{\\tau}S = -\\tau C + \\mathcal{O}(\\tau^{2})\n$$\nThis result demonstrates that if the operators $S$ and $B$ do not commute (i.e., $C \\neq 0$), an error term of order $\\mathcal{O}(\\tau)$ is introduced when interchanging the order of time-stepping and post-processing. This term can spoil any higher-order accuracy (superconvergence) that might otherwise be present.\n\nNext, we explicitly construct the matrices for the given problem. The domain is $(0,1)$ with a uniform mesh of $N=3$ elements, making the mesh size $h=1/3$. The nodes are at $x_{0}=0$, $x_{1}=1/3$, $x_{2}=2/3$, and $x_{3}=1$. The interior degrees of freedom correspond to nodes $x_{1}$ and $x_{2}$. The basis functions for the interior are the standard piecewise linear \"hat\" functions $\\phi_{1}(x)$ and $\\phi_{2}(x)$.\n\nThe consistent mass matrix $M$ for interior nodes on a uniform mesh with linear elements is given by $M_{ij} = \\int_{0}^{1} \\phi_{i}(x) \\phi_{j}(x) dx$. The general form is $\\frac{h}{6}$ times a tridiagonal matrix with entries $(1, 4, 1)$. For our $2 \\times 2$ case:\n$$\nM = \\frac{h}{6} \\begin{pmatrix} 4 & 1 \\\\ 1 & 4 \\end{pmatrix} = \\frac{1/3}{6} \\begin{pmatrix} 4 & 1 \\\\ 1 & 4 \\end{pmatrix} = \\frac{1}{18} \\begin{pmatrix} 4 & 1 \\\\ 1 & 4 \\end{pmatrix}\n$$\nThe stiffness matrix $K$ is given by $K_{ij} = \\int_{0}^{1} a(x) \\phi'_{i}(x) \\phi'_{j}(x) dx$. The derivatives of the basis functions are piecewise constant: $\\phi'_{1}(x)$ is $3$ on $(0, 1/3)$ and $-3$ on $(1/3, 2/3)$; $\\phi'_{2}(x)$ is $3$ on $(1/3, 2/3)$ and $-3$ on $(2/3, 1)$. The diffusion coefficient $a(x)$ is $1$ on the first element, $2$ on the second, and $3$ on the third.\n$$\nK_{11} = \\int_{0}^{1/3} (1) (3)^{2} dx + \\int_{1/3}^{2/3} (2) (-3)^{2} dx = 9 \\cdot \\frac{1}{3} + 18 \\cdot \\frac{1}{3} = 3 + 6 = 9\n$$\n$$\nK_{22} = \\int_{1/3}^{2/3} (2) (3)^{2} dx + \\int_{2/3}^{1} (3) (-3)^{2} dx = 18 \\cdot \\frac{1}{3} + 27 \\cdot \\frac{1}{3} = 6 + 9 = 15\n$$\n$$\nK_{12} = K_{21} = \\int_{1/3}^{2/3} (2) (-3)(3) dx = -18 \\cdot \\frac{1}{3} = -6\n$$\nThus, the stiffness matrix is:\n$$\nK = \\begin{pmatrix} 9 & -6 \\\\ -6 & 15 \\end{pmatrix}\n$$\nThe post-processing operator $S$ is given by its matrix form:\n$$\nS = \\begin{pmatrix} 1/2 & 1/4 \\\\ 1/4 & 1/2 \\end{pmatrix} = \\frac{1}{4} \\begin{pmatrix} 2 & 1 \\\\ 1 & 2 \\end{pmatrix}\n$$\nNow we compute the discrete spatial operator $B=M^{-1}K$. First, we find the inverse of $M$:\n$$\n\\det(M) = \\left(\\frac{1}{18}\\right)^{2} (4 \\cdot 4 - 1 \\cdot 1) = \\frac{15}{324} = \\frac{5}{108}\n$$\n$$\nM^{-1} = \\frac{1}{\\det(M)} \\frac{1}{18} \\begin{pmatrix} 4 & -1 \\\\ -1 & 4 \\end{pmatrix} = \\frac{108}{5} \\cdot \\frac{1}{18} \\begin{pmatrix} 4 & -1 \\\\ -1 & 4 \\end{pmatrix} = \\frac{6}{5} \\begin{pmatrix} 4 & -1 \\\\ -1 & 4 \\end{pmatrix}\n$$\nNext, we compute $B$:\n$$\nB = M^{-1}K = \\frac{6}{5} \\begin{pmatrix} 4 & -1 \\\\ -1 & 4 \\end{pmatrix} \\begin{pmatrix} 9 & -6 \\\\ -6 & 15 \\end{pmatrix} = \\frac{6}{5} \\begin{pmatrix} 42 & -39 \\\\ -33 & 66 \\end{pmatrix}\n$$\nNow we can compute the commutator $C = SB - BS$.\n$$\nSB = \\left( \\frac{1}{4} \\begin{pmatrix} 2 & 1 \\\\ 1 & 2 \\end{pmatrix} \\right) \\left( \\frac{6}{5} \\begin{pmatrix} 42 & -39 \\\\ -33 & 66 \\end{pmatrix} \\right) = \\frac{3}{10} \\begin{pmatrix} 2 \\cdot 42 + 1 \\cdot (-33) & 2 \\cdot (-39) + 1 \\cdot 66 \\\\ 1 \\cdot 42 + 2 \\cdot (-33) & 1 \\cdot (-39) + 2 \\cdot 66 \\end{pmatrix} = \\frac{3}{10} \\begin{pmatrix} 51 & -12 \\\\ -24 & 93 \\end{pmatrix}\n$$\n$$\nBS = \\left( \\frac{6}{5} \\begin{pmatrix} 42 & -39 \\\\ -33 & 66 \\end{pmatrix} \\right) \\left( \\frac{1}{4} \\begin{pmatrix} 2 & 1 \\\\ 1 & 2 \\end{pmatrix} \\right) = \\frac{3}{10} \\begin{pmatrix} 42 \\cdot 2 + (-39) \\cdot 1 & 42 \\cdot 1 + (-39) \\cdot 2 \\\\ -33 \\cdot 2 + 66 \\cdot 1 & -33 \\cdot 1 + 66 \\cdot 2 \\end{pmatrix} = \\frac{3}{10} \\begin{pmatrix} 45 & -36 \\\\ 0 & 99 \\end{pmatrix}\n$$\nSubtracting these gives the commutator $C$:\n$$\nC = SB - BS = \\frac{3}{10} \\left( \\begin{pmatrix} 51 & -12 \\\\ -24 & 93 \\end{pmatrix} - \\begin{pmatrix} 45 & -36 \\\\ 0 & 99 \\end{pmatrix} \\right) = \\frac{3}{10} \\begin{pmatrix} 6 & 24 \\\\ -24 & -6 \\end{pmatrix} = \\frac{18}{10} \\begin{pmatrix} 1 & 4 \\\\ -4 & -1 \\end{pmatrix} = \\frac{9}{5} \\begin{pmatrix} 1 & 4 \\\\ -4 & -1 \\end{pmatrix}\n$$\nThe final step is to compute the largest singular value of $C$, which is its operator $2$-norm, $\\|C\\|_{2}$. The singular values $\\sigma$ of $C$ are the square roots of the eigenvalues of $C^{T}C$.\n$$\nC^{T}C = \\left( \\frac{9}{5} \\begin{pmatrix} 1 & -4 \\\\ 4 & -1 \\end{pmatrix} \\right) \\left( \\frac{9}{5} \\begin{pmatrix} 1 & 4 \\\\ -4 & -1 \\end{pmatrix} \\right) = \\frac{81}{25} \\begin{pmatrix} 1+16 & 4+4 \\\\ 4+4 & 16+1 \\end{pmatrix} = \\frac{81}{25} \\begin{pmatrix} 17 & 8 \\\\ 8 & 17 \\end{pmatrix}\n$$\nLet the eigenvalues of $C^{T}C$ be denoted by $\\lambda$. They are obtained from the characteristic equation $\\det(C^{T}C - \\lambda I) = 0$. This is equivalent to finding the eigenvalues $\\lambda'$ of the matrix $\\begin{pmatrix} 17 & 8 \\\\ 8 & 17 \\end{pmatrix}$ and then multiplying by $\\frac{81}{25}$.\n$$\n\\det\\begin{pmatrix} 17-\\lambda' & 8 \\\\ 8 & 17-\\lambda' \\end{pmatrix} = (17-\\lambda')^{2} - 64 = 0\n$$\n$$\n(17-\\lambda')^{2} = 64 \\quad \\implies \\quad 17-\\lambda' = \\pm 8 \\quad \\implies \\quad \\lambda' = 17 \\mp 8\n$$\nThe eigenvalues are $\\lambda'_{1} = 17+8=25$ and $\\lambda'_{2} = 17-8=9$.\nThe eigenvalues of $C^{T}C$ are therefore $\\lambda_{1} = \\frac{81}{25} \\cdot 25 = 81$ and $\\lambda_{2} = \\frac{81}{25} \\cdot 9 = \\frac{729}{25}$.\nThe singular values of $C$ are the square roots of these eigenvalues: $\\sigma_{1} = \\sqrt{81} = 9$ and $\\sigma_{2} = \\sqrt{729/25} = 27/5 = 5.4$.\nThe largest singular value is $\\sigma_{\\max} = 9$. This value, $\\|C\\|_{2}$, quantifies the magnitude of the leading-order commutator defect.", "answer": "$$\n\\boxed{9}\n$$", "id": "3447131"}]}