{"hands_on_practices": [{"introduction": "A fundamental requirement for any physically sound electrostatic method is that a particle does not exert a net force on itself. In the context of PME, this means the reciprocal-space calculation, which involves a sum over all periodic images, must not produce a spurious \"self-force.\" This theoretical exercise will guide you through a proof using symmetry arguments to show that the reciprocal-space force on an isolated charge is indeed zero, a cornerstone of the PME method's self-consistency. [@problem_id:3433341]", "problem": "Consider a single point charge of magnitude $q$ located at position $\\mathbf{r}_0$ inside a cubic, triply periodic simulation box of side length $L$ and volume $V = L^3$. A uniform neutralizing background of charge density $\\rho_{\\mathrm{b}} = -q/V$ is present so that the total charge in the box is zero. Work in Gaussian electrostatic units where $4\\pi \\epsilon_0 = 1$.\n\nIn the Particle-Mesh Ewald (PME) method (Particle-Mesh Ewald (PME)), the electrostatic potential is obtained by splitting the Coulomb kernel into real-space and reciprocal-space contributions using a Gaussian screening of width parameter $\\alpha > 0$, and the reciprocal-space contribution is evaluated on a mesh using a charge-assignment window of finite support. Let the reciprocal lattice vectors be $\\mathbf{k} = \\frac{2\\pi}{L}\\mathbf{n}$ with $\\mathbf{n} \\in \\mathbb{Z}^3$, and let the zero mode $\\mathbf{k}=\\mathbf{0}$ be excluded by construction due to charge neutrality. Assume that the PME influence function used to solve the Poisson equation in reciprocal space is a real, even function of $\\mathbf{k}$ and that the Fourier transform of the charge-assignment window is also real and even in $\\mathbf{k}$.\n\nStarting from the Poisson equation and the Fourier representation for periodic boundary conditions with a neutralizing background, and using only the properties stated above (periodicity, neutrality, Gaussian screening of width parameter $\\alpha$, and real-even influence and assignment functions in reciprocal space), derive the reciprocal-space electric field at the position of the charge $\\mathbf{r}_0$ and hence the reciprocal-space force on the particle. Use symmetry arguments of the reciprocal lattice to simplify the expression.\n\nWhat is the exact magnitude of the reciprocal-space force on the particle, $|\\mathbf{F}^{\\mathrm{rec}}|$, in reduced electrostatic units? State your final answer as a single exact number (no rounding).", "solution": "The problem asks for the reciprocal-space electrostatic force on a single point charge in a periodic system with a neutralizing background, as calculated by the Particle-Mesh Ewald (PME) method. We are given several key properties of the functions used in the PME algorithm, which are crucial for the derivation.\n\nFirst, let's establish the mathematical framework. The system consists of a single charge $q$ at position $\\mathbf{r}_0$ in a cubic box of volume $V=L^3$ with periodic boundary conditions. The charge density is $\\rho(\\mathbf{r}) = q \\delta(\\mathbf{r} - \\mathbf{r}_0) - q/V$, where the second term is the uniform neutralizing background. We work in Gaussian units where the permittivity of free space factor $4\\pi \\epsilon_0$ is set to $1$.\n\nThe electrostatic potential $\\phi(\\mathbf{r})$ and charge density $\\rho(\\mathbf{r})$ can be represented by Fourier series over the reciprocal lattice vectors $\\mathbf{k} = \\frac{2\\pi}{L}\\mathbf{n}$ for $\\mathbf{n} \\in \\mathbb{Z}^3$:\n$$ \\phi(\\mathbf{r}) = \\frac{1}{V} \\sum_{\\mathbf{k}} \\hat{\\phi}(\\mathbf{k}) e^{i\\mathbf{k}\\cdot\\mathbf{r}}, \\quad \\rho(\\mathbf{r}) = \\frac{1}{V} \\sum_{\\mathbf{k}} \\hat{\\rho}(\\mathbf{k}) e^{i\\mathbf{k}\\cdot\\mathbf{r}} $$\nwhere the Fourier coefficients are given by volume integrals:\n$$ \\hat{\\phi}(\\mathbf{k}) = \\int_V \\phi(\\mathbf{r}) e^{-i\\mathbf{k}\\cdot\\mathbf{r}} d^3r, \\quad \\hat{\\rho}(\\mathbf{k}) = \\int_V \\rho(\\mathbf{r}) e^{-i\\mathbf{k}\\cdot\\mathbf{r}} d^3r $$\nThe Fourier coefficient of the charge density is:\n$$ \\hat{\\rho}(\\mathbf{k}) = \\int_V \\left(q \\delta(\\mathbf{r} - \\mathbf{r}_0) - \\frac{q}{V}\\right) e^{-i\\mathbf{k}\\cdot\\mathbf{r}} d^3r = q e^{-i\\mathbf{k}\\cdot\\mathbf{r}_0} - \\frac{q}{V} \\int_V e^{-i\\mathbf{k}\\cdot\\mathbf{r}} d^3r $$\nThe integral evaluates to $V\\delta_{\\mathbf{k},\\mathbf{0}}$. For $\\mathbf{k}=\\mathbf{0}$, $\\hat{\\rho}(\\mathbf{0}) = q - q = 0$, reflecting the overall charge neutrality. For $\\mathbf{k}\\neq\\mathbf{0}$, we have $\\hat{\\rho}(\\mathbf{k}) = q e^{-i\\mathbf{k}\\cdot\\mathbf{r}_0}$. The PME method excludes the $\\mathbf{k}=\\mathbf{0}$ term from the reciprocal-space calculation based on this neutrality.\n\nIn the PME method, the force on a particle is calculated from a potential that is constructed in stages. First, the point charge is assigned to a grid, which corresponds to a convolution with a window function $W(\\mathbf{r})$. In Fourier space, this means the Fourier coefficients of the gridded charge density $\\hat{\\rho}_g(\\mathbf{k})$ are $\\hat{\\rho}_g(\\mathbf{k}) = \\hat{W}(\\mathbf{k}) \\hat{\\rho}(\\mathbf{k})$, where $\\hat{W}(\\mathbf{k})$ is the Fourier transform of the window function.\n\nThe Poisson equation in Gaussian units, $\\nabla^2\\phi = -4\\pi\\rho$, becomes $k^2\\hat{\\phi}(\\mathbf{k}) = 4\\pi\\hat{\\rho}(\\mathbf{k})$ in reciprocal space. The PME method solves this for the long-range (reciprocal-space) part of the potential using an influence function $\\tilde{G}(\\mathbf{k})$, which includes effects of Gaussian screening. The Fourier coefficients of the potential on the grid are given by:\n$$ \\hat{\\phi}_g(\\mathbf{k}) = \\tilde{G}(\\mathbf{k}) \\hat{\\rho}_g(\\mathbf{k}) = \\tilde{G}(\\mathbf{k}) \\hat{W}(\\mathbf{k}) \\hat{\\rho}(\\mathbf{k}) $$\nTo find the force on the point charge at $\\mathbf{r}_0$, the grid potential must be interpolated back to the particle's position. This interpolation step is equivalent to a convolution with the window function, which in Fourier space corresponds to multiplying by the complex conjugate of its transform, $\\hat{W}^*(\\mathbf{k})$. The potential felt by the particle, $\\phi_{\\text{felt}}(\\mathbf{r})$, is thus constructed as:\n$$ \\phi_{\\text{felt}}(\\mathbf{r}) = \\frac{1}{V} \\sum_{\\mathbf{k}\\neq\\mathbf{0}} \\hat{W}^*(\\mathbf{k}) \\hat{\\phi}_g(\\mathbf{k}) e^{i\\mathbf{k}\\cdot\\mathbf{r}} = \\frac{1}{V} \\sum_{\\mathbf{k}\\neq\\mathbf{0}} \\hat{W}^*(\\mathbf{k})\\tilde{G}(\\mathbf{k})\\hat{W}(\\mathbf{k}) \\hat{\\rho}(\\mathbf{k}) e^{i\\mathbf{k}\\cdot\\mathbf{r}} $$\nLet us define an effective influence function $I(\\mathbf{k}) = |\\hat{W}(\\mathbf{k})|^2 \\tilde{G}(\\mathbf{k})$. The problem statement specifies that the PME influence function $\\tilde{G}(\\mathbf{k})$ is a real, even function of $\\mathbf{k}$, and that the Fourier transform of the charge-assignment window $\\hat{W}(\\mathbf{k})$ is also real and even in $\\mathbf{k}$.\nSince $\\hat{W}(\\mathbf{k})$ is real, $|\\hat{W}(\\mathbf{k})|^2 = (\\hat{W}(\\mathbf{k}))^2$. Since $\\hat{W}(\\mathbf{k})$ and $\\tilde{G}(\\mathbf{k})$ are both even functions of $\\mathbf{k}$ (i.e., $f(-\\mathbf{k}) = f(\\mathbf{k})$), their product $I(\\mathbf{k}) = (\\hat{W}(\\mathbf{k}))^2 \\tilde{G}(\\mathbf{k})$ must also be a real, even function of $\\mathbf{k}$.\n\nSubstituting for $\\hat{\\rho}(\\mathbf{k})$ and using $I(\\mathbf{k})$, the potential felt at a general position $\\mathbf{r}$ is:\n$$ \\phi_{\\text{felt}}(\\mathbf{r}) = \\frac{1}{V} \\sum_{\\mathbf{k}\\neq\\mathbf{0}} I(\\mathbf{k}) \\left(q e^{-i\\mathbf{k}\\cdot\\mathbf{r}_0}\\right) e^{i\\mathbf{k}\\cdot\\mathbf{r}} = \\frac{q}{V} \\sum_{\\mathbf{k}\\neq\\mathbf{0}} I(\\mathbf{k}) e^{i\\mathbf{k}\\cdot(\\mathbf{r}-\\mathbf{r}_0)} $$\nThe reciprocal-space electric field is $\\mathbf{E}^{\\mathrm{rec}}(\\mathbf{r}) = -\\nabla \\phi_{\\text{felt}}(\\mathbf{r})$. Differentiating the series term-by-term with respect to $\\mathbf{r}$:\n$$ \\mathbf{E}^{\\mathrm{rec}}(\\mathbf{r}) = -\\frac{q}{V} \\sum_{\\mathbf{k}\\neq\\mathbf{0}} I(\\mathbf{k}) (i\\mathbf{k}) e^{i\\mathbf{k}\\cdot(\\mathbf{r}-\\mathbf{r}_0)} $$\nWe need to evaluate this field at the position of the charge itself, $\\mathbf{r}=\\mathbf{r}_0$:\n$$ \\mathbf{E}^{\\mathrm{rec}}(\\mathbf{r}_0) = -\\frac{iq}{V} \\sum_{\\mathbf{k}\\neq\\mathbf{0}} I(\\mathbf{k}) \\mathbf{k} e^{i\\mathbf{k}\\cdot(\\mathbf{r}_0-\\mathbf{r}_0)} = -\\frac{iq}{V} \\sum_{\\mathbf{k}\\neq\\mathbf{0}} I(\\mathbf{k}) \\mathbf{k} $$\nThe reciprocal-space force on the particle is $\\mathbf{F}^{\\mathrm{rec}} = q \\mathbf{E}^{\\mathrm{rec}}(\\mathbf{r}_0)$:\n$$ \\mathbf{F}^{\\mathrm{rec}} = - \\frac{iq^2}{V} \\sum_{\\mathbf{k}\\neq\\mathbf{0}} I(\\mathbf{k}) \\mathbf{k} $$\nThe final step is to evaluate the sum $\\mathcal{S} = \\sum_{\\mathbf{k}\\neq\\mathbf{0}} I(\\mathbf{k}) \\mathbf{k}$ using symmetry. The summation spans all non-zero reciprocal lattice vectors. The set of these vectors is symmetric with respect to inversion; for every vector $\\mathbf{k}$ in the sum, its negative $-\\mathbf{k}$ is also present.\n\nLet the summand be the vector function $\\mathbf{f}(\\mathbf{k}) = I(\\mathbf{k})\\mathbf{k}$. We analyze its parity. We established that $I(\\mathbf{k})$ is an even function, $I(-\\mathbf{k}) = I(\\mathbf{k})$. The vector $\\mathbf{k}$ itself is an odd function, $(-\\mathbf{k}) = -\\mathbf{k}$. Therefore, the summand is an odd function:\n$$ \\mathbf{f}(-\\mathbf{k}) = I(-\\mathbf{k})(-\\mathbf{k}) = I(\\mathbf{k})(-\\mathbf{k}) = -I(\\mathbf{k})\\mathbf{k} = -\\mathbf{f}(\\mathbf{k}) $$\nWhen summing an odd function over a symmetric domain, the contributions from each pair of points $(\\mathbf{k}, -\\mathbf{k})$ cancel out:\n$$ \\mathbf{f}(\\mathbf{k}) + \\mathbf{f}(-\\mathbf{k}) = \\mathbf{f}(\\mathbf{k}) - \\mathbf{f}(\\mathbf{k}) = \\mathbf{0} $$\nSince the entire sum can be arranged into such cancelling pairs, the total sum is the zero vector:\n$$ \\mathcal{S} = \\sum_{\\mathbf{k}\\neq\\mathbf{0}} I(\\mathbf{k}) \\mathbf{k} = \\mathbf{0} $$\nConsequently, the reciprocal-space force on the particle is zero:\n$$ \\mathbf{F}^{\\mathrm{rec}} = - \\frac{iq^2}{V} \\cdot \\mathbf{0} = \\mathbf{0} $$\nThe magnitude of this force is $|\\mathbf{F}^{\\mathrm{rec}}| = 0$. This is a fundamental result ensuring that, within the PME formalism, a particle does not experience an unphysical \"self-force\" from its own periodic images and the screening charge in the reciprocal-space calculation.\nThe specific unit system, whether \"reduced electrostatic units\" or otherwise, is irrelevant for a value of zero.", "answer": "$$\\boxed{0}$$", "id": "3433341"}, {"introduction": "While the reciprocal-space sum in PME elegantly handles long-range interactions, it treats all particle pairs identically. However, molecular force fields require specific intramolecular interactions, such as those between atoms separated by one, two, or three bonds, to be excluded or scaled. This practice problem bridges theory and application by demonstrating how to properly adjust real-space and reciprocal-space forces for these exceptions, and verifies that the process correctly conserves the total momentum of the system. [@problem_id:3433395]", "problem": "Consider a three-dimensional cubic simulation cell of side length $L$ with periodic boundary conditions and tin-foil electrostatic boundary conditions. A single four-atom linear topology occupies the cell, with covalent connectivity $1$–$2$–$3$–$4$. The atomic positions are fixed at $\\mathbf{r}_{1} = (0,0,0)$, $\\mathbf{r}_{2} = (a,0,0)$, $\\mathbf{r}_{3} = (2a,0,0)$, and $\\mathbf{r}_{4} = (3a,0,0)$, where $0  3a  r_{c}  L/2$. The partial charges are $q_{1} = +q$, $q_{2} = 0$, $q_{3} = 0$, and $q_{4} = -q$ with $q > 0$. A standard Ewald splitting with parameter $\\alpha > 0$ is used, with a real-space cutoff $r_{c}$ and a reciprocal-space summation computed by Particle Mesh Ewald (PME). In this force field, the intramolecular $1$–$2$ and $2$–$3$ electrostatic interactions are fully excluded, the $1$–$3$ electrostatic interaction is fully excluded, and the $1$–$4$ electrostatic interaction is scaled by a factor $s \\in (0,1]$ (the $1$–$4$ scaling factor). Assume the PME implementation is mathematically equivalent to the standard Ewald reciprocal-space sum in the infinite mesh limit, and that the self-term contributes no force.\n\nStarting from Coulomb’s law and the standard Ewald decomposition under three-dimensional periodic boundary conditions:\n\n1. Derive the real-space pair force between two charges separated by a distance $r$ and write the adjusted real-space forces on atoms $1$ and $4$, explicitly incorporating the $1$–$4$ scaling factor $s$ and the given exclusions.\n\n2. Express the reciprocal-space (PME) force on atom $i$ in terms of the structure factor $S(\\mathbf{k}) = \\sum_{j} q_{j} \\exp(-\\mathrm{i}\\,\\mathbf{k}\\cdot\\mathbf{r}_{j})$ and the usual Ewald $k$-space weight. Then, using $q_{2} = q_{3} = 0$, derive the adjusted reciprocal-space forces on atoms $1$ and $4$ in terms of $s$, $q$, $\\alpha$, $L$, and the reciprocal lattice vectors $\\mathbf{k} = \\frac{2\\pi}{L}\\mathbf{n}$ with $\\mathbf{n}\\in\\mathbb{Z}^{3}\\setminus\\{\\mathbf{0}\\}$.\n\n3. Using Newton’s third law and the properties of the structure factor, verify momentum conservation by showing that the total adjusted force on the four-atom system vanishes exactly.\n\nReport as your final answer the scalar magnitude of the total adjusted force on the entire four-atom system. Express the final answer as an exact real number without units. No rounding is required.", "solution": "The solution proceeds in three parts as requested. We are working in a system with periodic boundary conditions, using the Ewald summation method. The Coulomb interaction is split into a short-range (real-space) and a long-range (reciprocal-space) component. For a pair of charges $q_i$ and $q_j$ separated by a distance $r$, the Coulomb potential energy $U(r) = \\frac{1}{4\\pi\\epsilon_0} \\frac{q_i q_j}{r}$ is split as:\n$$ U(r) = \\frac{1}{4\\pi\\epsilon_0} \\frac{q_i q_j \\text{erfc}(\\alpha r)}{r} + \\frac{1}{4\\pi\\epsilon_0} \\frac{q_i q_j \\text{erf}(\\alpha r)}{r} $$\nwhere the first term is the real-space potential and the second is the real-space representation of the reciprocal-space potential. The self-energy term contributes no force and is ignored. The system is charge-neutral $(\\sum q_i = q+0+0-q=0)$, so the surface dipole correction term is zero.\n\nThe force is the negative gradient of the potential energy, $\\mathbf{F} = -\\nabla U$.\n\n### Part 1: Real-space Forces\n\nThe real-space pair force on particle $i$ due to particle $j$ at a separation vector $\\mathbf{r}_{ij} = \\mathbf{r}_i - \\mathbf{r}_j$ (with magnitude $r_{ij} = |\\mathbf{r}_{ij}|$) is derived from the real-space potential $U^{\\text{real}}(r_{ij}) = \\frac{1}{4\\pi\\epsilon_0} \\frac{q_i q_j \\text{erfc}(\\alpha r_{ij})}{r_{ij}}$.\n$$ \\mathbf{F}_{ij}^{\\text{real}} = -\\nabla_{\\mathbf{r}_i} U^{\\text{real}}(r_{ij}) = - \\frac{dU^{\\text{real}}}{dr_{ij}} \\frac{\\mathbf{r}_{ij}}{r_{ij}} $$\nThe derivative is:\n$$ \\frac{d}{dr} \\left(\\frac{\\text{erfc}(\\alpha r)}{r}\\right) = \\frac{1}{r} \\left(-\\frac{2\\alpha}{\\sqrt{\\pi}} \\exp(-\\alpha^2 r^2)\\right) - \\frac{\\text{erfc}(\\alpha r)}{r^2} $$\nThus, the real-space pair force is:\n$$ \\mathbf{F}_{ij}^{\\text{real}} = \\frac{q_i q_j}{4\\pi\\epsilon_0} \\left[ \\frac{\\text{erfc}(\\alpha r_{ij})}{r_{ij}^2} + \\frac{2\\alpha}{\\sqrt{\\pi}} \\frac{\\exp(-\\alpha^2 r_{ij}^2)}{r_{ij}} \\right] \\frac{\\mathbf{r}_{ij}}{r_{ij}} $$\nThis force is calculated for all pairs $(i, j)$ separated by a distance less than the cutoff $r_c$, including periodic images.\n\nIn this problem, we have a single molecule, so all interactions are intramolecular. The atoms $q_2$ and $q_3$ have zero charge, so they do not participate in any electrostatic interactions. The only interacting pair is $(1, 4)$.\nThe problem specifies the following rules for intramolecular interactions:\n- $1-2, 2-3, 1-3$ pairs are fully excluded.\n- The $1-4$ pair interaction is scaled by a factor $s$.\n\nThe separation between atoms $1$ and $4$ is $r_{14}=3a$. The condition $3a  r_c$ ensures this interaction is computed within the real-space sum.\nThe \"adjusted\" real-space force on atom $1$ is the sum of its real-space interactions, modified by the exclusion/scaling rules. Since $q_2=q_3=0$, the only contribution is from atom $4$.\n$$ \\mathbf{F}_{1}^{\\text{real, adj}} = s \\cdot \\mathbf{F}_{14}^{\\text{real}} $$\nUsing the particle data: $q_1=+q$, $q_4=-q$, $\\mathbf{r}_1=(0,0,0)$, $\\mathbf{r}_4=(3a,0,0)$.\nSo, $\\mathbf{r}_{14} = \\mathbf{r}_1 - \\mathbf{r}_4 = (-3a, 0, 0)$, and $r_{14}=3a$.\n$$ \\mathbf{F}_{1}^{\\text{real, adj}} = s \\frac{(q)(-q)}{4\\pi\\epsilon_0} \\left[ \\frac{\\text{erfc}(3\\alpha a)}{(3a)^2} + \\frac{2\\alpha}{\\sqrt{\\pi}} \\frac{\\exp(-\\alpha^2 (3a)^2)}{3a} \\right] \\frac{(-3a,0,0)}{3a} $$\n$$ \\mathbf{F}_{1}^{\\text{real, adj}} = \\frac{sq^2}{4\\pi\\epsilon_0} \\left[ \\frac{\\text{erfc}(3\\alpha a)}{9a^2} + \\frac{2\\alpha}{3a\\sqrt{\\pi}} \\exp(-9\\alpha^2 a^2) \\right] (1,0,0) $$\nBy Newton's third law, the adjusted real-space force on atom $4$ is:\n$$ \\mathbf{F}_{4}^{\\text{real, adj}} = s \\cdot \\mathbf{F}_{41}^{\\text{real}} = -s \\cdot \\mathbf{F}_{14}^{\\text{real}} = -\\mathbf{F}_{1}^{\\text{real, adj}} $$\n$$ \\mathbf{F}_{4}^{\\text{real, adj}} = -\\frac{sq^2}{4\\pi\\epsilon_0} \\left[ \\frac{\\text{erfc}(3\\alpha a)}{9a^2} + \\frac{2\\alpha}{3a\\sqrt{\\pi}} \\exp(-9\\alpha^2 a^2) \\right] (1,0,0) $$\n\n### Part 2: Reciprocal-space Forces\n\nThe reciprocal-space force on atom $i$ is given by the formula:\n$$ \\mathbf{F}_{i}^{\\text{recip}} = \\frac{q_i}{L^3 \\epsilon_0} \\sum_{\\mathbf{k}\\neq\\mathbf{0}} \\frac{\\exp(-k^2/4\\alpha^2)}{k^2} \\mathbf{k} \\, \\text{Im}\\left[S(\\mathbf{k}) \\exp(\\mathrm{i}\\mathbf{k}\\cdot\\mathbf{r}_i)\\right] $$\nwhere $\\mathbf{k} = \\frac{2\\pi}{L}\\mathbf{n}$ are the reciprocal lattice vectors for $\\mathbf{n}\\in\\mathbb{Z}^3\\setminus\\{0\\}$, $L^3$ is the cell volume, and $S(\\mathbf{k})$ is the structure factor $S(\\mathbf{k}) = \\sum_j q_j \\exp(-\\mathrm{i}\\mathbf{k}\\cdot\\mathbf{r}_j)$.\n\nThe \"adjusted reciprocal-space force\" accounts for the intramolecular scaling and exclusions. In a standard Ewald implementation, the reciprocal-space sum is computed assuming all pairs interact fully (scaling factor of $1$). A correction is then applied to account for the actual intramolecular scaling. The total force on a pair $(i,j)$ should be $s_{ij} \\mathbf{F}_{ij}^{\\text{Coulomb}}$. The computed force is $\\mathbf{F}_{i}^{\\text{comp}} = \\mathbf{F}_{i}^{\\text{real,adj}} + \\mathbf{F}_{i}^{\\text{recip}}$. For the $1-4$ pair, this becomes $\\mathbf{F}_{1}^{\\text{comp}} = s\\mathbf{F}_{14}^{\\text{real}} + \\mathbf{F}_{1}^{\\text{recip}}$. The target force is $s\\mathbf{F}_{14}^{\\text{Coulomb}} = s(\\mathbf{F}_{14}^{\\text{real}} + \\mathbf{F}_{14}^{\\text{recip,complement}})$. Using the Ewald identity $\\mathbf{F}_{14}^{\\text{recip,complement}}=\\mathbf{F}_1^{\\text{recip}}$ (the k-space sum for a pair equals its real-space complement force), the target force is $s\\mathbf{F}_{14}^{\\text{real}} + s\\mathbf{F}_{1}^{\\text{recip}}$. The correction required is the target minus the computed, which is $(s\\mathbf{F}_{14}^{\\text{real}} + s\\mathbf{F}_{1}^{\\text{recip}}) - (s\\mathbf{F}_{14}^{\\text{real}} + \\mathbf{F}_{1}^{\\text{recip}}) = (s-1)\\mathbf{F}_{1}^{\\text{recip}}$. The adjusted reciprocal force is the unadjusted force plus the correction:\n$$ \\mathbf{F}_{1}^{\\text{recip, adj}} = \\mathbf{F}_{1}^{\\text{recip}} + (s-1)\\mathbf{F}_{1}^{\\text{recip}} = s\\mathbf{F}_{1}^{\\text{recip}} $$\nSo, the scaling factor $s$ applies directly to the standard reciprocal-space force.\n\nNow we derive the explicit expression. The structure factor for this system is:\n$$ S(\\mathbf{k}) = q_1 e^{-\\mathrm{i}\\mathbf{k}\\cdot\\mathbf{r}_1} + q_4 e^{-\\mathrm{i}\\mathbf{k}\\cdot\\mathbf{r}_4} = q e^0 - q e^{-\\mathrm{i}k_x(3a)} = q(1 - \\exp(-3\\mathrm{i}k_x a)) $$\nFor atom $1$, $\\mathbf{r}_1 = \\mathbf{0}$, so $\\exp(\\mathrm{i}\\mathbf{k}\\cdot\\mathbf{r}_1)=1$. The force calculation requires $\\text{Im}[S(\\mathbf{k})]$.\n$$ S(\\mathbf{k}) = q(1 - \\cos(3k_x a) + \\mathrm{i}\\sin(3k_x a)) \\implies \\text{Im}[S(\\mathbf{k})] = q\\sin(3k_x a) $$\nThe standard reciprocal force on atom $1$ is:\n$$ \\mathbf{F}_{1}^{\\text{recip}} = \\frac{q}{L^3 \\epsilon_0} \\sum_{\\mathbf{k}\\neq\\mathbf{0}} \\frac{\\exp(-k^2/4\\alpha^2)}{k^2} \\mathbf{k} \\, (q\\sin(3k_x a)) = \\frac{q^2}{L^3 \\epsilon_0} \\sum_{\\mathbf{k}\\neq\\mathbf{0}} \\mathbf{k} \\frac{\\exp(-k^2/4\\alpha^2)}{k^2} \\sin(3k_x a) $$\nThe adjusted reciprocal force on atom $1$ is therefore:\n$$ \\mathbf{F}_{1}^{\\text{recip, adj}} = \\frac{s q^2}{L^3 \\epsilon_0} \\sum_{\\mathbf{k}\\neq\\mathbf{0}} \\mathbf{k} \\frac{\\exp(-k^2/4\\alpha^2)}{k^2} \\sin(3k_x a) $$\nFor atom $4$, we need $\\text{Im}[S(\\mathbf{k}) \\exp(\\mathrm{i}\\mathbf{k}\\cdot\\mathbf{r}_4)]$.\n$$ S(\\mathbf{k}) \\exp(\\mathrm{i}\\mathbf{k}\\cdot\\mathbf{r}_4) = q(1 - e^{-3\\mathrm{i}k_x a})e^{3\\mathrm{i}k_x a} = q(e^{3\\mathrm{i}k_x a} - 1) = q(\\cos(3k_x a) - 1 + \\mathrm{i}\\sin(3k_x a)) $$\nThe imaginary part is $q\\sin(3k_x a)$. The force on atom $4$ (charge $q_4=-q$) is:\n$$ \\mathbf{F}_{4}^{\\text{recip}} = \\frac{-q}{L^3 \\epsilon_0} \\sum_{\\mathbf{k}\\neq\\mathbf{0}} \\frac{\\exp(-k^2/4\\alpha^2)}{k^2} \\mathbf{k} \\, (q\\sin(3k_x a)) = -\\mathbf{F}_{1}^{\\text{recip}} $$\nThe adjusted reciprocal force on atom $4$ is:\n$$ \\mathbf{F}_{4}^{\\text{recip, adj}} = s\\mathbf{F}_{4}^{\\text{recip}} = -s\\mathbf{F}_{1}^{\\text{recip}} = -\\mathbf{F}_{1}^{\\text{recip, adj}} $$\n\n### Part 3: Momentum Conservation\n\nWe must verify that the total adjusted force on the four-atom system, $\\mathbf{F}_{\\text{total}} = \\sum_{i=1}^4 \\mathbf{F}_i$, is zero.\nThe total force on atom $i$ is the sum of its adjusted real-space and reciprocal-space components: $\\mathbf{F}_i = \\mathbf{F}_i^{\\text{real, adj}} + \\mathbf{F}_i^{\\text{recip, adj}}$.\nThe forces on atoms $2$ and $3$ are zero because their charges are zero: $\\mathbf{F}_2 = \\mathbf{F}_3 = \\mathbf{0}$.\nThe total force is therefore $\\mathbf{F}_{\\text{total}} = \\mathbf{F}_1 + \\mathbf{F}_4$.\n$$ \\mathbf{F}_{\\text{total}} = (\\mathbf{F}_1^{\\text{real, adj}} + \\mathbf{F}_1^{\\text{recip, adj}}) + (\\mathbf{F}_4^{\\text{real, adj}} + \\mathbf{F}_4^{\\text{recip, adj}}) $$\nFrom Part 1, we established that $\\mathbf{F}_{4}^{\\text{real, adj}} = -\\mathbf{F}_{1}^{\\text{real, adj}}$, which is a direct consequence of Newton's third law applied to pairwise real-space forces.\nFrom Part 2, we established that $\\mathbf{F}_{4}^{\\text{recip, adj}} = -\\mathbf{F}_{1}^{\\text{recip, adj}}$.\nSubstituting these into the expression for the total force:\n$$ \\mathbf{F}_{\\text{total}} = (\\mathbf{F}_1^{\\text{real, adj}} + \\mathbf{F}_1^{\\text{recip, adj}}) + (-\\mathbf{F}_1^{\\text{real, adj}} - \\mathbf{F}_1^{\\text{recip, adj}}) = \\mathbf{0} $$\nThis confirms that the total force on the system is the zero vector, and thus momentum is conserved.\n\nThe prompt also mentions using properties of the structure factor. The total unadjusted reciprocal force on the system is:\n$$ \\sum_i \\mathbf{F}_i^{\\text{recip}} = \\sum_i \\frac{q_i}{L^3\\epsilon_0} \\sum_{\\mathbf{k}\\ne\\mathbf{0}} \\mathbf{k} \\frac{\\exp(-k^2/4\\alpha^2)}{k^2} \\text{Im}[S(\\mathbf{k}) e^{\\mathrm{i}\\mathbf{k}\\cdot\\mathbf{r}_i}] $$\n$$ = \\frac{1}{L^3\\epsilon_0} \\sum_{\\mathbf{k}\\ne\\mathbf{0}} \\mathbf{k} \\frac{\\exp(-k^2/4\\alpha^2)}{k^2} \\text{Im}[S(\\mathbf{k}) \\sum_i q_i e^{\\mathrm{i}\\mathbf{k}\\cdot\\mathbf{r}_i}] $$\nThe inner sum is $\\sum_i q_i e^{\\mathrm{i}\\mathbf{k}\\cdot\\mathbf{r}_i} = \\sum_i q_i e^{-\\mathrm{i}(-\\mathbf{k})\\cdot\\mathbf{r}_i} = S(-\\mathbf{k})$.\nThe term becomes $\\text{Im}[S(\\mathbf{k})S(-\\mathbf{k})]$. Since $S(-\\mathbf{k}) = S(\\mathbf{k})^*$, this is $\\text{Im}[|S(\\mathbf{k})|^2]$. As $|S(\\mathbf{k})|^2$ is purely real, its imaginary part is zero. Thus, the sum of the unadjusted reciprocal forces is zero. Since the adjusted forces are just scaled versions ($s\\mathbf{F}^{\\text{recip}}$), and this holds true for all pairs, their sum is also zero.\n\nThe total adjusted force on the entire four-atom system is the zero vector. The scalar magnitude of this force is therefore $0$.", "answer": "$$\n\\boxed{0}\n$$", "id": "3433395"}, {"introduction": "The accuracy and stability of a PME simulation depend critically on the choice of numerical parameters, particularly the charge assignment order, which determines the smoothness of the force. This computational exercise puts theory into practice, allowing you to implement a particle-mesh algorithm and directly observe the consequences of using different B-spline assignment orders. By tracking force discontinuities and energy drift, you will gain a tangible understanding of why higher-order, smoother assignment functions are essential for stable and accurate molecular dynamics. [@problem_id:3433420]", "problem": "Consider a three-dimensional periodic cubic domain of side length $L$ containing a single point particle of charge $q$ and mass $M$. The electrostatic potential $\\phi(\\mathbf{r})$ is defined by the Poisson equation in the domain with periodic boundary conditions, and the electric field is $\\mathbf{E}(\\mathbf{r}) = -\\nabla \\phi(\\mathbf{r})$. A Particle-Mesh algorithm assigns the particle charge to a uniform mesh of sizes $N_x \\times N_y \\times N_z$ using a cardinal $m$-order B-spline assignment function, solves the Poisson equation spectrally, and interpolates the field back to the particle position using the same assignment function. The zero spatial frequency mode of the potential is set to zero to avoid singularity for net charge. The particle is advanced using the microcanonical dynamics with the velocity Verlet scheme, and periodic boundary conditions are applied to the position.\n\nStarting only from the following base principles: Gauss's law in differential form, the Poisson equation with periodic boundary conditions, the definition of the electric field as the negative gradient of the potential, the conservation of charge under assignment, and Newton's second law for microcanonical time evolution, derive an algorithm to:\n\n1. Assign the particle charge to the mesh using an $m$-order cardinal B-spline so that the discretized charge density $\\rho(\\mathbf{r})$ is conservative and localized to $m$ cells per spatial dimension.\n2. Solve the discretized Poisson equation spectrally to obtain $\\phi(\\mathbf{r})$ and $\\mathbf{E}(\\mathbf{r})$ on the mesh, with the zero-mode removed.\n3. Interpolate $\\phi(\\mathbf{r})$ and $\\mathbf{E}(\\mathbf{r})$ to the particle position using the same $m$-order B-spline as in assignment.\n4. Integrate the particle's position and velocity using velocity Verlet in dimensionless units, with total energy defined as $E(t) = \\frac{1}{2} M \\|\\mathbf{v}(t)\\|^2 + q \\, \\phi(\\mathbf{r}(t))$.\n\nDefine the force discontinuity observed at mesh cell boundaries as follows: if $i_x(t) = \\lfloor N_x x(t)/L \\rfloor$, $i_y(t) = \\lfloor N_y y(t)/L \\rfloor$, and $i_z(t) = \\lfloor N_z z(t)/L \\rfloor$ denote the mesh cell indices containing the particle at time $t$, then whenever $\\left(i_x(t+\\Delta t), i_y(t+\\Delta t), i_z(t+\\Delta t)\\right) \\neq \\left(i_x(t), i_y(t), i_z(t)\\right)$, record the force jump magnitude $J_t = \\|\\mathbf{F}(t+\\Delta t) - \\mathbf{F}(t)\\|$. Over the entire microcanonical trajectory of $T$ steps, define the maximum jump as $J = \\max_t J_t$. Define the energy drift as $\\Delta E = E(T) - E(0)$.\n\nWork in dimensionless units where $L=1$, $M=1$, and $q=1$. Use radians implicitly for any trigonometric computations. The program must implement the algorithm described above and compute, for each test case in the suite below, two quantities: the maximum force jump $J$ and the energy drift $\\Delta E$, both expressed as floats in dimensionless units.\n\nTest Suite:\n- Case 1 (happy path, coarse grid, low assignment order): $m=1$, $N_x=N_y=N_z=16$, $\\Delta t = 0.005$, $T=250$, initial position $\\mathbf{r}_0 = (0.25, 0.37, 0.41)$, initial velocity $\\mathbf{v}_0 = (0.2, 0, 0)$.\n- Case 2 (increased smoothness): $m=2$, $N_x=N_y=N_z=16$, $\\Delta t = 0.005$, $T=250$, initial position $\\mathbf{r}_0 = (0.25, 0.37, 0.41)$, initial velocity $\\mathbf{v}_0 = (0.2, 0, 0)$.\n- Case 3 (higher smoothness): $m=3$, $N_x=N_y=N_z=16$, $\\Delta t = 0.005$, $T=250$, initial position $\\mathbf{r}_0 = (0.25, 0.37, 0.41)$, initial velocity $\\mathbf{v}_0 = (0.2, 0, 0)$.\n- Case 4 (highest smoothness in the set): $m=4$, $N_x=N_y=N_z=16$, $\\Delta t = 0.005$, $T=250$, initial position $\\mathbf{r}_0 = (0.25, 0.37, 0.41)$, initial velocity $\\mathbf{v}_0 = (0.2, 0, 0)$.\n- Case 5 (edge case, wrap-around boundary crossing and coarse grid): $m=1$, $N_x=N_y=N_z=8$, $\\Delta t = 0.02$, $T=80$, initial position $\\mathbf{r}_0 = (0.98, 0.20, 0.20)$, initial velocity $\\mathbf{v}_0 = (0.05, 0, 0)$.\n\nRequired final output format: Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each entry is a two-element list $[J,\\Delta E]$ corresponding to a test case, with both values rounded to six decimal places. For example, the output must look like $[[J_1,\\Delta E_1],[J_2,\\Delta E_2],\\dots]$.", "solution": "We begin with the fundamental relations of electrostatics and molecular dynamics relevant to Particle-Mesh methods. Gauss's law in differential form states that $\\nabla \\cdot \\mathbf{E}(\\mathbf{r}) = \\rho(\\mathbf{r})/\\varepsilon_0$, where $\\rho(\\mathbf{r})$ is the charge density and $\\varepsilon_0$ is the permittivity of free space. Combining this with $\\mathbf{E}(\\mathbf{r}) = -\\nabla \\phi(\\mathbf{r})$, we obtain the Poisson equation $\\nabla^2 \\phi(\\mathbf{r}) = -\\rho(\\mathbf{r})/\\varepsilon_0$. In a three-dimensional periodic domain, the solution is efficiently computed via Fourier transformation. Let the Fourier transform be defined as $\\hat{f}(\\mathbf{k}) = \\int_{\\text{box}} f(\\mathbf{r}) e^{-i \\mathbf{k}\\cdot \\mathbf{r}} \\, d^3 r$, with inverse $f(\\mathbf{r}) = (1/V)\\sum_{\\mathbf{k}} \\hat{f}(\\mathbf{k}) e^{i \\mathbf{k}\\cdot \\mathbf{r}}$ for volume $V=L^3$.\n\nFor nonzero wave vectors $\\mathbf{k}$, the spectral solution to the Poisson equation is $\\hat{\\phi}(\\mathbf{k}) = \\hat{\\rho}(\\mathbf{k}) / (\\varepsilon_0 \\|\\mathbf{k}\\|^2)$ and $\\widehat{\\nabla \\phi}(\\mathbf{k}) = i \\mathbf{k} \\hat{\\phi}(\\mathbf{k})$. The zero mode $\\mathbf{k}=\\mathbf{0}$ is set to zero to avoid divergence when there is net charge, which is a standard and physically consistent modification under periodic boundary conditions that corresponds to removing the undefined mean potential.\n\nThe Particle-Mesh approach replaces the continuous $\\rho(\\mathbf{r})$ with a conservative discrete distribution on a mesh by assigning the particle charge to a set of neighboring grid points with weights summing to unity. For a cardinal $m$-order B-spline assignment in one dimension, the weights $w_j(s)$ for $j=0,1,\\dots,m-1$ depend only on the fractional coordinate $s$ of the particle within its grid cell and have compact support of size $m$ cells while satisfying $\\sum_{j=0}^{m-1} w_j(s)=1$ and non-negativity. In three dimensions, the assignment weights are separable and given by products of one-dimensional weights. The B-spline assignment ensures that the charge is conserved and distributed smoothly over $m$ neighboring cells in each direction, with higher $m$ giving increased continuity.\n\nOnce the mesh charge density is known, we compute the Fourier transform $\\hat{\\rho}(\\mathbf{k})$ over the discrete grid. For a uniform grid of sizes $N_x \\times N_y \\times N_z$ and side length $L$, the discrete wave number components are $k_x = 2\\pi n_x / L$, $k_y = 2\\pi n_y / L$, and $k_z = 2\\pi n_z / L$, where $n_x \\in \\{0,1,\\dots,N_x-1\\}$ and similarly for $n_y$ and $n_z$, with the negative frequencies represented implicitly by the ordering of the Fast Fourier Transform. The Green's function in Fourier space is $G(\\mathbf{k}) = 1/(\\varepsilon_0 \\|\\mathbf{k}\\|^2)$ for $\\mathbf{k}\\neq \\mathbf{0}$ and $G(\\mathbf{0})=0$. The potential and electric field in Fourier space are then $\\hat{\\phi}(\\mathbf{k}) = \\hat{\\rho}(\\mathbf{k}) G(\\mathbf{k})$ and $\\hat{\\mathbf{E}}(\\mathbf{k}) = -i \\mathbf{k} \\hat{\\phi}(\\mathbf{k})$. Transforming back to real space via inverse Fast Fourier Transform yields $\\phi(\\mathbf{r})$ and $\\mathbf{E}(\\mathbf{r})$ on the mesh grid points. Interpolating these fields to the particle position uses the same B-spline weights, maintaining consistency between assignment and gather operations.\n\nThe particle's motion under microcanonical conditions is governed by Newton's second law $M \\, d\\mathbf{v}/dt = \\mathbf{F}(\\mathbf{r})$, where $\\mathbf{F}(\\mathbf{r}) = q \\mathbf{E}(\\mathbf{r})$. We use the velocity Verlet algorithm for time integration in dimensionless units. The update from time $t$ to $t+\\Delta t$ is\n$$\n\\mathbf{r}(t+\\Delta t) = \\mathbf{r}(t) + \\mathbf{v}(t) \\Delta t + \\frac{\\mathbf{F}(t)}{2M} \\Delta t^2,\n$$\nwith periodic wrapping of $\\mathbf{r}(t+\\Delta t)$ to the domain $[0,L)^3$, followed by computation of the new force $\\mathbf{F}(t+\\Delta t)$, and then\n$$\n\\mathbf{v}(t+\\Delta t) = \\mathbf{v}(t) + \\frac{\\mathbf{F}(t) + \\mathbf{F}(t+\\Delta t)}{2M} \\Delta t.\n$$\nThe total energy is taken as $E(t) = \\frac{1}{2} M \\|\\mathbf{v}(t)\\|^2 + q \\phi(\\mathbf{r}(t))$. Using the same potential for energy and the same field for force ensures consistency of work-energy in the discretized model. The energy drift is finally defined by $\\Delta E = E(T) - E(0)$ for a trajectory of $T$ steps.\n\nThe force discontinuity as the particle traverses mesh cell boundaries arises from the finite support and continuity class of the $m$-order B-spline assignment. For low $m$ (e.g., $m=1$, nearest-grid-point), the assigned density changes discontinuously when crossing cell boundaries, producing discontinuities in the mesh-solved field and hence jumps in the interpolated force. For higher $m$ (e.g., $m=3$ and $m=4$), the assignment yields continuous derivatives up to a certain order, which reduces or removes force discontinuities. We quantify this by monitoring when the integer mesh indices change: define $i_x(t) = \\lfloor N_x x(t)/L \\rfloor$ and similarly for $i_y$ and $i_z$; whenever any of these indices changes between successive time steps, we record the jump magnitude $J_t = \\|\\mathbf{F}(t+\\Delta t) - \\mathbf{F}(t)\\|$. The maximum value over the run is $J$, which is a measure of the force discontinuity severity for the chosen $m$ and mesh.\n\nAlgorithmic construction:\n- Represent the domain and grid. Compute wave numbers $k_x$, $k_y$, and $k_z$ arrays using the discrete Fourier frequency scaled to $2\\pi/L$.\n- Implement the cardinal B-spline weights for arbitrary integer order $m \\geq 1$. A stable recursion (Cox–de Boor style adapted for cardinal knots) builds the $m$ non-negative weights $w_j(s)$ from $s \\in [0,1)$, ensuring partition of unity $\\sum_j w_j(s) = 1$.\n- For assignment, compute one-dimensional weights and corresponding index offsets for each dimension. Use separability to compute three-dimensional weights as products $w^{(x)}_a(s_x) w^{(y)}_b(s_y) w^{(z)}_c(s_z)$ and deposit the charge $q$ to the mesh at indices $(i_x + \\delta_a, i_y + \\delta_b, i_z + \\delta_c)$ with periodic wrapping. For the support centered on the local cell, indices are chosen as $i_d - \\lfloor (m-1)/2 \\rfloor + j$ for $j=0,\\dots,m-1$ in dimension $d$.\n- After assignment, compute $\\hat{\\rho}(\\mathbf{k})$ by a three-dimensional Fast Fourier Transform, construct $G(\\mathbf{k})$ with the zero mode set to zero, and compute $\\hat{\\phi}(\\mathbf{k})$ and $\\hat{\\mathbf{E}}(\\mathbf{k}) = -i \\mathbf{k} \\hat{\\phi}(\\mathbf{k})$. Inverse transform to obtain $\\phi(\\mathbf{r})$ and $\\mathbf{E}(\\mathbf{r})$ on the grid.\n- For interpolation, use the same $m$-order B-spline weights to compute $\\phi(\\mathbf{r}(t))$ and $\\mathbf{E}(\\mathbf{r}(t))$ by weighted sums over the mesh values at the supporting grid points, yielding consistent field and potential at the particle position.\n- Perform velocity Verlet integration, wrapping positions periodically. At each step, track the mesh cell indices and record the jump magnitude when indices change. Accumulate the maximum jump $J$ and compute the final energy drift $\\Delta E$.\n\nBecause we are using a single particle, the mesh-based potential and field embody the grid-induced self-interaction, which is absent in the continuum. This self-interaction is position dependent relative to the mesh and leads to grid-induced forces whose smoothness is governed by $m$. The algorithm above isolates the role of the assignment order $m$ on force continuity and the corresponding numerical energy drift under microcanonical integration.\n\nThe final program evaluates the five test cases described, computes the maximum force jump $J$ and energy drift $\\Delta E$ for each, and outputs a single line containing a comma-separated list of $[J,\\Delta E]$ pairs enclosed in square brackets, with both values rounded to six decimal places, in dimensionless units.", "answer": "```python\nimport numpy as np\n\n# Particle-Mesh Electrostatics: Force discontinuities and energy drift for different assignment orders.\n\ndef b_spline_weights(s: float, m: int) - np.ndarray:\n    \"\"\"\n    Compute cardinal B-spline weights of order m for fractional coordinate s in [0,1).\n    Uses a stable recursion ensuring partition of unity and non-negativity.\n    Returns an array of length m with weights w[0..m-1].\n    \"\"\"\n    w = np.zeros(m, dtype=float)\n    w[0] = 1.0\n    for k in range(1, m):\n        saved = 0.0\n        for j in range(0, k):\n            tmp = w[j]\n            w[j] = ((k - s) * tmp + saved) / k\n            saved = (s * tmp) / k\n        w[k] = saved\n    return w\n\n\ndef compute_k_grids(Nx, Ny, Nz, L):\n    \"\"\"\n    Compute wave-number grids kx, ky, kz for a 3D periodic box of side L\n    with Nx, Ny, Nz points per dimension.\n    \"\"\"\n    kx = 2.0 * np.pi * np.fft.fftfreq(Nx, d=L / Nx)\n    ky = 2.0 * np.pi * np.fft.fftfreq(Ny, d=L / Ny)\n    kz = 2.0 * np.pi * np.fft.fftfreq(Nz, d=L / Nz)\n    kxg, kyg, kzg = np.meshgrid(kx, ky, kz, indexing='ij')\n    return kxg, kyg, kzg\n\n\ndef deposit_charge(q, pos, grid_shape, L, m):\n    \"\"\"\n    Deposit a single particle charge q at position pos (3-vector) onto a grid of shape grid_shape\n    using m-order cardinal B-spline weights. Returns rho grid.\n    \"\"\"\n    Nx, Ny, Nz = grid_shape\n    rho = np.zeros(grid_shape, dtype=float)\n    # Compute indices and weights in each dimension\n    indices_list = []\n    weights_list = []\n    for d, N in enumerate([Nx, Ny, Nz]):\n        u = pos[d] / L * N\n        i = int(np.floor(u)) % N\n        s = u - np.floor(u)\n        w = b_spline_weights(s, m)\n        base = i - ((m - 1) // 2)\n        idx = (base + np.arange(m)) % N\n        indices_list.append(idx)\n        weights_list.append(w)\n    ix = indices_list[0]\n    iy = indices_list[1]\n    iz = indices_list[2]\n    wx = weights_list[0]\n    wy = weights_list[1]\n    wz = weights_list[2]\n    # Separable deposition\n    for a in range(m):\n        for b in range(m):\n            for c in range(m):\n                rho[ix[a], iy[b], iz[c]] += q * wx[a] * wy[b] * wz[c]\n    return rho\n\n\ndef spectral_field_and_potential(rho, L):\n    \"\"\"\n    Compute potential phi and electric field E = -grad(phi) on the grid via spectral Poisson solver.\n    Zero mode handled by setting Green's function to zero at k=0.\n    \"\"\"\n    Nx, Ny, Nz = rho.shape\n    rho_hat = np.fft.fftn(rho)\n    kxg, kyg, kzg = compute_k_grids(Nx, Ny, Nz, L)\n    k2 = kxg * kxg + kyg * kyg + kzg * kzg\n    G = np.zeros_like(k2, dtype=float)\n    nonzero = k2 > 0.0\n    G[nonzero] = 1.0 / k2[nonzero]\n    phi_hat = rho_hat * G\n    # Electric field in Fourier space: E_hat = -i k phi_hat\n    Ex_hat = -1j * kxg * phi_hat\n    Ey_hat = -1j * kyg * phi_hat\n    Ez_hat = -1j * kzg * phi_hat\n    # Back to real space\n    phi = np.fft.ifftn(phi_hat).real\n    Ex = np.fft.ifftn(Ex_hat).real\n    Ey = np.fft.ifftn(Ey_hat).real\n    Ez = np.fft.ifftn(Ez_hat).real\n    return phi, Ex, Ey, Ez\n\n\ndef gather_at_position(pos, field_grid, L, m):\n    \"\"\"\n    Interpolate a grid field (scalar or vector components) to the particle position pos\n    using m-order cardinal B-spline weights. field_grid may be scalar grid (phi) or component grid (Ex).\n    \"\"\"\n    Nx, Ny, Nz = field_grid.shape\n    # Compute indices and weights in each dimension\n    indices_list = []\n    weights_list = []\n    for d, N in enumerate([Nx, Ny, Nz]):\n        u = pos[d] / L * N\n        i = int(np.floor(u)) % N\n        s = u - np.floor(u)\n        w = b_spline_weights(s, m)\n        base = i - ((m - 1) // 2)\n        idx = (base + np.arange(m)) % N\n        indices_list.append(idx)\n        weights_list.append(w)\n    ix = indices_list[0]\n    iy = indices_list[1]\n    iz = indices_list[2]\n    wx = weights_list[0]\n    wy = weights_list[1]\n    wz = weights_list[2]\n    # Weighted sum\n    val = 0.0\n    for a in range(m):\n        for b in range(m):\n            for c in range(m):\n                val += wx[a] * wy[b] * wz[c] * field_grid[ix[a], iy[b], iz[c]]\n    return val\n\n\ndef compute_force_and_energy(q, pos, L, m, grid_shape):\n    \"\"\"\n    Given particle position, compute mesh-based force F and potential energy U = q * phi(pos),\n    using spectral solution of Poisson equation.\n    \"\"\"\n    rho = deposit_charge(q, pos, grid_shape, L, m)\n    phi, Ex, Ey, Ez = spectral_field_and_potential(rho, L)\n    # Interpolate field components and potential at particle pos\n    Ex_p = gather_at_position(pos, Ex, L, m)\n    Ey_p = gather_at_position(pos, Ey, L, m)\n    Ez_p = gather_at_position(pos, Ez, L, m)\n    phi_p = gather_at_position(pos, phi, L, m)\n    F = q * np.array([Ex_p, Ey_p, Ez_p], dtype=float)\n    U = q * phi_p\n    return F, U\n\n\ndef velocity_verlet_microcanonical(case):\n    \"\"\"\n    Perform microcanonical integration for a single particle under mesh-based electrostatics,\n    tracking max force jump J and energy drift DeltaE over the trajectory.\n    \"\"\"\n    # Unpack parameters\n    m = case['m']\n    Nx, Ny, Nz = case['N']\n    L = case['L']\n    dt = case['dt']\n    nsteps = case['nsteps']\n    pos = np.array(case['pos'], dtype=float)\n    vel = np.array(case['vel'], dtype=float)\n    q = case['q']\n    M = case['M']\n    grid_shape = (Nx, Ny, Nz)\n\n    # Initial force and energy\n    F, U = compute_force_and_energy(q, pos, L, m, grid_shape)\n    E_total = 0.5 * M * np.dot(vel, vel) + U\n    E_initial = E_total\n\n    # Initialize max force jump tracking\n    def cell_indices(p):\n        return (int(np.floor(p[0] / L * Nx)) % Nx,\n                int(np.floor(p[1] / L * Ny)) % Ny,\n                int(np.floor(p[2] / L * Nz)) % Nz)\n\n    idx_old = cell_indices(pos)\n    J_max = 0.0\n\n    # Time stepping\n    for _ in range(nsteps):\n        # Position update\n        pos = pos + vel * dt + (F / (2.0 * M)) * (dt ** 2)\n        # Periodic wrapping\n        pos = np.mod(pos, L)\n        # New force and potential energy\n        F_new, U_new = compute_force_and_energy(q, pos, L, m, grid_shape)\n        # Velocity update\n        vel = vel + (F + F_new) / (2.0 * M) * dt\n        # Track force jump on crossing cell boundaries\n        idx_new = cell_indices(pos)\n        if idx_new != idx_old:\n            jump = np.linalg.norm(F_new - F)\n            if jump > J_max:\n                J_max = jump\n        idx_old = idx_new\n        # Update for next iteration\n        F = F_new\n        U = U_new\n\n    # Final energy\n    E_final = 0.5 * M * np.dot(vel, vel) + U\n    DeltaE = E_final - E_initial\n    return J_max, DeltaE\n\n\ndef solve():\n    # Define test cases\n    test_cases = [\n        # Case 1\n        {'m': 1, 'N': (16, 16, 16), 'L': 1.0, 'dt': 0.005, 'nsteps': 250,\n         'pos': (0.25, 0.37, 0.41), 'vel': (0.2, 0.0, 0.0), 'q': 1.0, 'M': 1.0},\n        # Case 2\n        {'m': 2, 'N': (16, 16, 16), 'L': 1.0, 'dt': 0.005, 'nsteps': 250,\n         'pos': (0.25, 0.37, 0.41), 'vel': (0.2, 0.0, 0.0), 'q': 1.0, 'M': 1.0},\n        # Case 3\n        {'m': 3, 'N': (16, 16, 16), 'L': 1.0, 'dt': 0.005, 'nsteps': 250,\n         'pos': (0.25, 0.37, 0.41), 'vel': (0.2, 0.0, 0.0), 'q': 1.0, 'M': 1.0},\n        # Case 4\n        {'m': 4, 'N': (16, 16, 16), 'L': 1.0, 'dt': 0.005, 'nsteps': 250,\n         'pos': (0.25, 0.37, 0.41), 'vel': (0.2, 0.0, 0.0), 'q': 1.0, 'M': 1.0},\n        # Case 5 (wrap-around crossing, coarse grid)\n        {'m': 1, 'N': (8, 8, 8), 'L': 1.0, 'dt': 0.02, 'nsteps': 80,\n         'pos': (0.98, 0.20, 0.20), 'vel': (0.05, 0.0, 0.0), 'q': 1.0, 'M': 1.0},\n    ]\n\n    results = []\n    for case in test_cases:\n        J, dE = velocity_verlet_microcanonical(case)\n        # Round to six decimals\n        results.append([round(J, 6), round(float(dE), 6)])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(str(r) for r in results)}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```", "id": "3433420"}]}