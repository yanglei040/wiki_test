{"hands_on_practices": [{"introduction": "A central challenge in multiscale simulation is the systematic derivation of a coarse-grained (CG) model that faithfully represents the underlying atomistic physics. Force matching provides a robust framework for this task by optimizing a parametric CG force field to reproduce the mapped forces from a high-fidelity atomistic simulation. This exercise [@problem_id:3427931] delves into the statistical mechanics foundation of this technique, asking you to demonstrate that the optimal CG force is precisely the conditional expectation of the atomistic force, thereby connecting a practical algorithm to a cornerstone of probability theory.", "problem": "Consider an atomistic system of $N$ particles with positions $\\mathbf{x} \\in \\mathbb{R}^{3N}$ and potential energy $U(\\mathbf{x})$. The atomistic force is defined by $\\mathbf{F}_{\\mathrm{AA}}(\\mathbf{x}) = -\\nabla_{\\mathbf{x}} U(\\mathbf{x})$. Let $\\boldsymbol{\\xi}: \\mathbb{R}^{3N} \\to \\mathbb{R}^{3n_b}$ be a measurable coarse-graining map that assigns to each atomistic configuration a coarse-grained configuration $\\mathbf{R} = \\boldsymbol{\\xi}(\\mathbf{x})$, where $n_b$ is the number of coarse-grained beads. Define a linear projection $\\mathbf{P}: \\mathbb{R}^{3N} \\to \\mathbb{R}^{3n_b}$ that maps atomistic forces to bead-resolved forces $\\mathbf{F}_{\\mathrm{map}}(\\mathbf{x}) = \\mathbf{P}\\mathbf{F}_{\\mathrm{AA}}(\\mathbf{x})$. A parametric coarse-grained force model $\\mathbf{F}_{\\mathrm{CG}}(\\mathbf{R};\\theta)$ is to be fitted by minimizing a force-matching objective over a set of atomistic samples $\\{\\mathbf{X}_k\\}_{k=1}^{K}$ drawn from the canonical equilibrium ensemble at temperature $T$ with density $\\mu(\\mathrm{d}\\mathbf{x}) \\propto \\exp(-\\beta U(\\mathbf{x}))\\,\\mathrm{d}\\mathbf{x}$, where $\\beta = (k_{\\mathrm{B}}T)^{-1}$ and $k_{\\mathrm{B}}$ is the Boltzmann constant. The discrete force-matching functional is\n$$\nJ(\\theta) = \\sum_{k=1}^{K} \\left\\| \\mathbf{F}_{\\mathrm{map}}(\\mathbf{X}_k) - \\mathbf{F}_{\\mathrm{CG}}(\\mathbf{R}_k;\\theta) \\right\\|^2,\n$$\nwhere $\\mathbf{R}_k = \\boldsymbol{\\xi}(\\mathbf{X}_k)$. Assume the parametric class is sufficiently rich to approximate any square-integrable function of $\\mathbf{R}$ and consider the continuum limit in which the sum approximates an ensemble average. Using only fundamental definitions from statistical mechanics and probability theory (canonical ensemble, expectation, conditional expectation, and $L^2$ projection), which of the following statements best characterizes the continuum-limit minimizer of the force-matching functional and its connection to conditional expectations over mapped atomistic configurations?\n\nA. In the limit $K \\to \\infty$ with $\\mathbf{X}_k \\sim \\mu$, minimizing $J(\\theta)$ over all square-integrable functions of $\\mathbf{R} = \\boldsymbol{\\xi}(\\mathbf{X})$ yields the unique minimizer $\\mathbf{F}_{\\mathrm{CG}}^{\\star}(\\mathbf{R}) = \\mathbb{E}\\!\\left[\\mathbf{P}\\mathbf{F}_{\\mathrm{AA}}(\\mathbf{X}) \\mid \\boldsymbol{\\xi}(\\mathbf{X}) = \\mathbf{R}\\right]$ for almost every $\\mathbf{R}$ with respect to the coarse marginal density $p_{\\mathbf{R}}(\\mathbf{R})$, i.e., it is the $L^2$ projection onto the $\\sigma$-algebra generated by $\\boldsymbol{\\xi}(\\mathbf{X})$.\n\nB. The functional $J(\\theta)$ is minimized by the constant vector $\\mathbf{F}_{\\mathrm{CG}}^{\\star}(\\mathbf{R}) = \\mathbb{E}\\!\\left[\\mathbf{P}\\mathbf{F}_{\\mathrm{AA}}(\\mathbf{X})\\right]$, independent of $\\mathbf{R}$, because the least-squares fit averages out the dependence on $\\mathbf{R}$.\n\nC. The minimizer satisfies $\\mathbf{F}_{\\mathrm{CG}}^{\\star}(\\mathbf{R}) = \\mathbb{E}\\!\\left[\\mathbf{P}\\mathbf{F}_{\\mathrm{AA}}(\\mathbf{X}) \\mid \\boldsymbol{\\xi}(\\mathbf{X}) = \\mathbf{R}\\right]$ computed with respect to a uniform measure on $\\mathbf{R}$, so the coarse marginal density $p_{\\mathbf{R}}(\\mathbf{R})$ does not enter the characterization of the optimum.\n\nD. Regardless of the mapping $\\boldsymbol{\\xi}$ and projection $\\mathbf{P}$, the minimizer is always $\\mathbf{F}_{\\mathrm{CG}}^{\\star}(\\mathbf{R}) = -\\nabla_{\\mathbf{R}} W(\\mathbf{R})$, where $W(\\mathbf{R}) = -k_{\\mathrm{B}}T \\ln p_{\\mathbf{R}}(\\mathbf{R})$ is the potential of mean force; no additional corrections are needed to reconcile the conditional expectation with $-\\nabla_{\\mathbf{R}} W(\\mathbf{R})$.\n\nE. In Adaptive Resolution Simulation (AdResS), where atomistic and coarse-grained regions are coupled by a position-dependent interpolation $w(\\mathbf{x})$, consistency requires preweighting the samples in $J(\\theta)$ by $w(\\mathbf{x})$; otherwise, force-matching cannot be interpreted as a conditional expectation in any ensemble.", "solution": "The problem statement is scientifically sound and well-posed, establishing a standard scenario in the statistical mechanics of coarse-graining models. There is, however, a significant notational ambiguity in the definition of the force-matching functional:\n$$\nJ(\\theta) = \\sum_{k=1}^{K} \\left\\| \\mathbf{F}_{\\mathrm{AA}}(\\mathbf{R}_k) - \\mathbf{F}_{\\mathrm{CG}}(\\mathbf{R}_k;\\theta) \\right\\|^2\n$$\nThe term $\\mathbf{F}_{\\mathrm{AA}}(\\mathbf{R}_k)$ is problematic, as the atomistic force $\\mathbf{F}_{\\mathrm{AA}}$ is a function of the full microscopic state $\\mathbf{x} \\in \\mathbb{R}^{3N}$, not the coarse-grained state $\\mathbf{R}_k \\in \\mathbb{R}^{3n_b}$. The problem text attempts to clarify this by stating that \"$\\mathbf{F}_{\\mathrm{AA}}(\\mathbf{R}_k)$ denotes the mapped atomistic force evaluated at $\\mathbf{R}_k$\". The only logical and standard interpretation in the context of force-matching is that for each microscopic sample $\\mathbf{X}_k$, the target force is the atomistic force calculated from that sample and then mapped to the coarse-grained level using the projection $\\mathbf{P}$. The mapped force is defined as $\\mathbf{F}_{\\mathrm{map}}(\\mathbf{x}) = \\mathbf{P}\\mathbf{F}_{\\mathrm{AA}}(\\mathbf{x})$. Therefore, the functional must be interpreted as:\n$$\nJ(\\theta) = \\sum_{k=1}^{K} \\left\\| \\mathbf{P}\\mathbf{F}_{\\mathrm{AA}}(\\mathbf{X}_k) - \\mathbf{F}_{\\mathrm{CG}}(\\boldsymbol{\\xi}(\\mathbf{X}_k);\\theta) \\right\\|^2\n$$\nUnder this necessary clarification, the problem is valid and can be solved.\n\nThe question asks for the characterization of the minimizer of the functional $J(\\theta)$ in the continuum limit, where the sum over a large number of samples $K \\to \\infty$ becomes an expectation value over the canonical ensemble. The atomic positions $\\mathbf{X}$ are treated as a random variable distributed according to the probability density $\\mu(\\mathbf{x}) \\propto \\exp(-\\beta U(\\mathbf{x}))$.\n\nLet us define the mapped atomistic force as the random variable $\\mathbf{Y} = \\mathbf{P}\\mathbf{F}_{\\mathrm{AA}}(\\mathbf{X})$ and the coarse-grained coordinates as $\\mathbf{Z} = \\boldsymbol{\\xi}(\\mathbf{X})$. The coarse-grained force model $\\mathbf{F}_{\\mathrm{CG}}(\\mathbf{R};\\theta)$ is a function of the realization of $\\mathbf{Z}$, which we can write as $f(\\mathbf{Z})$. The problem then is to find the function $f$ that minimizes the mean squared error. In the continuum limit, the objective functional becomes:\n$$\nJ[f] = \\mathbb{E}_{\\mathbf{X} \\sim \\mu} \\left[ \\left\\| \\mathbf{Y} - f(\\mathbf{Z}) \\right\\|^2 \\right] = \\int \\left\\| \\mathbf{P}\\mathbf{F}_{\\mathrm{AA}}(\\mathbf{x}) - f(\\boldsymbol{\\xi}(\\mathbf{x})) \\right\\|^2 \\mu(\\mathbf{x}) \\, \\mathrm{d}\\mathbf{x}\n$$\nWe assume the parametric family for $\\mathbf{F}_{\\mathrm{CG}}$ is sufficiently rich to represent the optimal function $f$, so we minimize over all square-integrable functions of $\\mathbf{R}$.\n\nWe can use the law of total expectation (or tower property), which states $\\mathbb{E}[\\cdot] = \\mathbb{E}[\\mathbb{E}[\\cdot|\\mathbf{Z}]]$.\n$$\nJ[f] = \\mathbb{E}_{\\mathbf{Z}} \\left[ \\mathbb{E}_{\\mathbf{X}|\\mathbf{Z}} \\left[ \\left\\| \\mathbf{Y} - f(\\mathbf{Z}) \\right\\|^2 \\mid \\mathbf{Z}=\\mathbf{R} \\right] \\right]\n$$\nLet's analyze the inner expectation. Given a fixed coarse-grained configuration $\\mathbf{Z}=\\mathbf{R}$, the function value $f(\\mathbf{R})$ is a constant vector.\n$$\n\\mathbb{E}_{\\mathbf{X}|\\mathbf{Z}=\\mathbf{R}} \\left[ \\left\\| \\mathbf{Y} - f(\\mathbf{R}) \\right\\|^2 \\right] = \\mathbb{E}_{\\mathbf{X}|\\mathbf{Z}=\\mathbf{R}} \\left[ (\\mathbf{Y} - f(\\mathbf{R})) \\cdot (\\mathbf{Y} - f(\\mathbf{R})) \\right]\n$$\n$$\n= \\mathbb{E}_{\\mathbf{X}|\\mathbf{Z}=\\mathbf{R}} \\left[ \\|\\mathbf{Y}\\|^2 - 2\\mathbf{Y} \\cdot f(\\mathbf{R}) + \\|f(\\mathbf{R})\\|^2 \\right]\n$$\n$$\n= \\mathbb{E}_{\\mathbf{X}|\\mathbf{Z}=\\mathbf{R}} \\left[ \\|\\mathbf{Y}\\|^2 \\right] - 2 \\mathbb{E}_{\\mathbf{X}|\\mathbf{Z}=\\mathbf{R}}[\\mathbf{Y}] \\cdot f(\\mathbf{R}) + \\|f(\\mathbf{R})\\|^2\n$$\nLet $\\mathbf{F}^\\star(\\mathbf{R}) = \\mathbb{E}_{\\mathbf{X}|\\mathbf{Z}=\\mathbf{R}}[\\mathbf{Y}] = \\mathbb{E}[\\mathbf{P}\\mathbf{F}_{\\mathrm{AA}}(\\mathbf{X}) \\mid \\boldsymbol{\\xi}(\\mathbf{X})=\\mathbf{R}]$. This is the conditional expectation of the mapped atomistic force, given the coarse-grained configuration. The expression becomes:\n$$\n\\mathbb{E}_{\\mathbf{X}|\\mathbf{Z}=\\mathbf{R}} \\left[ \\|\\mathbf{Y}\\|^2 \\right] - 2 \\mathbf{F}^\\star(\\mathbf{R}) \\cdot f(\\mathbf{R}) + \\|f(\\mathbf{R})\\|^2\n$$\nWe can complete the square with respect to $f(\\mathbf{R})$:\n$$\n= \\left( \\|f(\\mathbf{R})\\|^2 - 2 \\mathbf{F}^\\star(\\mathbf{R}) \\cdot f(\\mathbf{R}) + \\|\\mathbf{F}^\\star(\\mathbf{R})\\|^2 \\right) + \\mathbb{E}_{\\mathbf{X}|\\mathbf{Z}=\\mathbf{R}} \\left[ \\|\\mathbf{Y}\\|^2 \\right] - \\|\\mathbf{F}^\\star(\\mathbf{R})\\|^2\n$$\n$$\n= \\|f(\\mathbf{R}) - \\mathbf{F}^\\star(\\mathbf{R})\\|^2 + \\left( \\mathbb{E}_{\\mathbf{X}|\\mathbf{Z}=\\mathbf{R}} \\left[ \\|\\mathbf{Y}\\|^2 \\right] - \\|\\mathbb{E}_{\\mathbf{X}|\\mathbf{Z}=\\mathbf{R}}[\\mathbf{Y}]\\|^2 \\right)\n$$\nThe second term is the trace of the conditional covariance matrix of $\\mathbf{Y}$ given $\\mathbf{Z}=\\mathbf{R}$. It is non-negative and, crucially, independent of our choice of function $f$.\n\nThe total functional is therefore:\n$$\nJ[f] = \\mathbb{E}_{\\mathbf{Z}} \\left[ \\|f(\\mathbf{Z}) - \\mathbf{F}^\\star(\\mathbf{Z})\\|^2 \\right] + \\mathbb{E}_{\\mathbf{Z}} \\left[ \\text{Tr}(\\text{Cov}(\\mathbf{Y}|\\mathbf{Z})) \\right]\n$$\nTo minimize $J[f]$ with respect to $f$, we only need to minimize the first term, as the second term is a constant with respect to $f$. The first term can be written as an integral:\n$$\n\\int \\|f(\\mathbf{R}) - \\mathbf{F}^\\star(\\mathbf{R})\\|^2 p_{\\mathbf{R}}(\\mathbf{R}) \\, \\mathrm{d}\\mathbf{R}\n$$\nwhere $p_{\\mathbf{R}}(\\mathbf{R})$ is the marginal probability density of the coarse-grained variable $\\mathbf{R}$. Since the integrand is non-negative, the integral is minimized when the integrand is zero. This occurs if and only if $f(\\mathbf{R}) = \\mathbf{F}^\\star(\\mathbf{R})$ for almost every $\\mathbf{R}$ with respect to the measure $p_{\\mathbf{R}}(\\mathbf{R})\\mathrm{d}\\mathbf{R}$.\n\nThus, the optimal coarse-grained force function, denoted $\\mathbf{F}_{\\mathrm{CG}}^{\\star}(\\mathbf{R})$, is the conditional expectation of the mapped atomistic force:\n$$\n\\mathbf{F}_{\\mathrm{CG}}^{\\star}(\\mathbf{R}) = \\mathbb{E}\\!\\left[\\mathbf{P}\\mathbf{F}_{\\mathrm{AA}}(\\mathbf{X}) \\mid \\boldsymbol{\\xi}(\\mathbf{X}) = \\mathbf{R}\\right]\n$$\nThis is a fundamental result in probability theory: the best $L^2$ approximation of a random variable $Y$ by a function of another random variable $Z$ is the conditional expectation $\\mathbb{E}[Y|Z]$. In the language of functional analysis, the conditional expectation is the orthogonal projection of the random variable $\\mathbf{P}\\mathbf{F}_{\\mathrm{AA}}(\\mathbf{X})$ onto the subspace of functions that are measurable with respect to the $\\sigma$-algebra generated by $\\boldsymbol{\\xi}(\\mathbf{X})$.\n\nNow we evaluate the options.\n\nA. **In the limit $K \\to \\infty$ with $\\mathbf{X}_k \\sim \\mu$, minimizing $J(\\theta)$ over all square-integrable functions of $\\mathbf{R} = \\boldsymbol{\\xi}(\\mathbf{X})$ yields the unique minimizer $\\mathbf{F}_{\\mathrm{CG}}^{\\star}(\\mathbf{R}) = \\mathbb{E}\\!\\left[\\mathbf{P}\\mathbf{F}_{\\mathrm{AA}}(\\mathbf{X}) \\mid \\boldsymbol{\\xi}(\\mathbf{X}) = \\mathbf{R}\\right]$ for almost every $\\mathbf{R}$ with respect to the coarse marginal density $p_{\\mathbf{R}}(\\mathbf{R})$, i.e., it is the $L^2$ projection onto the $\\sigma$-algebra generated by $\\boldsymbol{\\xi}(\\mathbf{X})$.**\nThis statement is a precise and complete summary of the derivation above. It correctly identifies the minimizer as the conditional expectation, specifies the condition of holding \"almost everywhere\" with respect to the correct marginal measure, and correctly identifies the operation as an $L^2$ projection.\n**Verdict: Correct.**\n\nB. **The functional $J(\\theta)$ is minimized by the constant vector $\\mathbf{F}_{\\mathrm{CG}}^{\\star}(\\mathbf{R}) = \\mathbb{E}\\!\\left[\\mathbf{P}\\mathbf{F}_{\\mathrm{AA}}(\\mathbf{X})\\right]$, independent of $\\mathbf{R}$, because the least-squares fit averages out the dependence on $\\mathbf{R}$.**\nThis is incorrect. Minimizing the mean squared error for a function of $\\mathbf{R}$ yields the conditional mean, which is a function of $\\mathbf{R}$. The unconditional mean $\\mathbb{E}[\\mathbf{Y}]$ is only the optimal solution if the model is restricted to a constant function, i.e., $\\mathbf{F}_{\\mathrm{CG}}(\\mathbf{R}) = \\mathbf{c}$. The problem statement allows for a general function of $\\mathbf{R}$.\n**Verdict: Incorrect.**\n\nC. **The minimizer satisfies $\\mathbf{F}_{\\mathrm{CG}}^{\\star}(\\mathbf{R}) = \\mathbb{E}\\!\\left[\\mathbf{P}\\mathbf{F}_{\\mathrm{AA}}(\\mathbf{X}) \\mid \\boldsymbol{\\xi}(\\mathbf{X}) = \\mathbf{R}\\right]$ computed with respect to a uniform measure on $\\mathbf{R}$, so the coarse marginal density $p_{\\mathbf{R}}(\\mathbf{R})$ does not enter the characterization of the optimum.**\nThis is incorrect. The expectation is taken with respect to the canonical ensemble measure $\\mu(\\mathrm{d}\\mathbf{x}) \\propto e^{-\\beta U(\\mathbf{x})} \\mathrm{d}\\mathbf{x}$. The resulting marginal density $p_{\\mathbf{R}}(\\mathbf{R})$ is generally not uniform. While the form of the optimal solution $\\mathbf{F}_{\\mathrm{CG}}^\\star(\\mathbf{R})$ is the conditional expectation, this solution is the minimizer of an integral weighted by $p_{\\mathbf{R}}(\\mathbf{R})$. The characterization of the optimum as holding \"almost everywhere\" is fundamentally tied to this density.\n**Verdict: Incorrect.**\n\nD. **Regardless of the mapping $\\boldsymbol{\\xi}$ and projection $\\mathbf{P}$, the minimizer is always $\\mathbf{F}_{\\mathrm{CG}}^{\\star}(\\mathbf{R}) = -\\nabla_{\\mathbf{R}} W(\\mathbf{R})$, where $W(\\mathbf{R}) = -k_{\\mathrm{B}}T \\ln p_{\\mathbf{R}}(\\mathbf{R})$ is the potential of mean force; no additional corrections are needed to reconcile the conditional expectation with $-\\nabla_{\\mathbf{R}} W(\\mathbf{R})$.**\nThis is a strong claim that is known to be false in general. The identity relating the conditional expectation of forces to the gradient of the potential of mean force, $\\mathbb{E}[-\\nabla_{\\mathbf{x}} U(\\mathbf{x}) | ... ] = -\\nabla_{\\mathbf{R}} W(\\mathbf{R})$, holds only for specific choices of the coarse-graining map $\\boldsymbol{\\xi}$ and an associated \"force projection\". For a general linear projection $\\mathbf{P}$ and map $\\boldsymbol{\\xi}$, the force-matching solution $\\mathbb{E}[\\mathbf{P}\\mathbf{F}_{\\mathrm{AA}}(\\mathbf{X})|\\boldsymbol{\\xi}(\\mathbf{X})=\\mathbf{R}]$ is not equal to $-\\nabla_{\\mathbf{R}} W(\\mathbf{R})$. The discrepancy between these two quantities is a central topic in multiscale modeling, and reconciling them often requires correction terms. The phrase \"Regardless of the mapping... and projection...\" makes the statement definitively false.\n**Verdict: Incorrect.**\n\nE. **In Adaptive Resolution Simulation (AdResS), where atomistic and coarse-grained regions are coupled by a position-dependent interpolation $w(\\mathbf{x})$, consistency requires preweighting the samples in $J(\\theta)$ by $w(\\mathbf{x})$; otherwise, force-matching cannot be interpreted as a conditional expectation in any ensemble.**\nThis statement introduces concepts specific to the AdResS method, which are not part of the problem's general setup. The problem is formulated in the context of the canonical ensemble, where samples are drawn from $\\mu(\\mathrm{d}\\mathbf{x})$. The conclusion derived from this setup, as shown in A, is that force-matching does yield a conditional expectation. This option incorrectly suggests that the interpretation as a conditional expectation is invalid without modifications related to AdResS. The question is about the interpretation of the functional *as given*, not how it should be modified for a different simulation methodology.\n**Verdict: Incorrect.**", "answer": "$$\\boxed{A}$$", "id": "3427931"}, {"introduction": "Once a coarse-grained model is coupled to an atomistic region in an adaptive simulation, ensuring physical consistency across the hybrid interface becomes paramount. A critical test of this consistency is the conservation of local momentum flux, which manifests as a constant and isotropic pressure tensor throughout the system. This hands-on exercise [@problem_id:3427894] guides you through the process of implementing the Irving-Kirkwood stress tensor calculation to numerically quantify pressure anisotropy, a key artifact that can arise at the interface, and to explore how tuning the hybrid region width can mitigate this issue.", "problem": "Consider a three-dimensional, periodic, planar multiscale setup conceived for Adaptive Resolution Simulation (AdResS), in which a Lennard–Jones fluid is divided along the $z$ direction into a coarse-grained region, a hybrid region of width $\\Delta$, and a fully atomistic region. The goal is to quantify how the choice of $\\Delta$ affects the pressure anisotropy in the hybrid region by computing the Irving–Kirkwood (IK) stress tensor $\\sigma_{\\alpha\\beta}(z)$ and then to determine, for a given tolerance $\\epsilon$, the minimal $\\Delta$ among a prescribed candidate set such that the hybrid-region stress agrees with a fully atomistic baseline within $\\epsilon$. All computations must be performed in reduced Lennard–Jones units, where the Lennard–Jones diameter $\\sigma_{\\mathrm{LJ}}$ equals $1$, the Lennard–Jones energy $\\varepsilon_{\\mathrm{LJ}}$ equals $1$, the mass $m$ equals $1$, and the Boltzmann constant $k_{\\mathrm{B}}$ equals $1$. In these reduced units, the stress has units of energy per volume, i.e., $\\varepsilon_{\\mathrm{LJ}}/\\sigma_{\\mathrm{LJ}}^3$.\n\nFundamental base and definitions:\n- The equations of motion follow Newton’s Second Law: $m \\,\\mathrm{d}^2 \\mathbf{r}_i/\\mathrm{d}t^2 = \\sum_{j \\neq i} \\mathbf{F}_{ij}$, where $\\mathbf{F}_{ij}$ is the pairwise force exerted by particle $j$ on particle $i$.\n- The pairwise atomistic Lennard–Jones potential is $U_{\\mathrm{AT}}(r) = 4 \\varepsilon \\left[ \\left(\\dfrac{\\sigma}{r}\\right)^{12} - \\left(\\dfrac{\\sigma}{r}\\right)^6 \\right]$ for $r < r_c$ and $U_{\\mathrm{AT}}(r) = 0$ for $r \\ge r_c$, with $\\sigma = 1$, $\\varepsilon = 1$, and a cutoff $r_c$ explicitly specified for each test case. The corresponding force is $\\mathbf{F}_{ij}^{\\mathrm{AT}} = -\\nabla U_{\\mathrm{AT}}(r)$ applied along the minimum image displacement vector.\n- The coarse-grained potential is of the same Lennard–Jones form but with energy parameter $\\varepsilon_{\\mathrm{CG}} = f_{\\mathrm{CG}} \\varepsilon$, where $f_{\\mathrm{CG}}$ is a given factor in each test case. The corresponding force is $\\mathbf{F}_{ij}^{\\mathrm{CG}}$.\n- The hybrid force mixing in AdResS employs a smooth position-dependent weight $w(z)$, defined by a cubic polynomial in the hybrid region to ensure continuous first derivatives across region boundaries. Let the box length in $z$ be $L_z$ and the central coordinate be $z_c = L_z/2$. Then\n  $$\n  w(z) =\n  \\begin{cases}\n  0,  z  z_c - \\frac{\\Delta}{2}, \\\\\n  3 t^2 - 2 t^3,  z_c - \\frac{\\Delta}{2} \\le z \\le z_c + \\frac{\\Delta}{2}, \\\\\n  1,  z > z_c + \\frac{\\Delta}{2},\n  \\end{cases}\n  $$\n  where $t = \\dfrac{z - (z_c - \\Delta/2)}{\\Delta}$ in the hybrid interval. The hybrid pair force is\n  $$\\mathbf{F}_{ij}^{\\mathrm{hyb}} = w(z_i)\\,w(z_j)\\,\\mathbf{F}_{ij}^{\\mathrm{AT}} + \\left[1 - w(z_i)\\,w(z_j)\\right] \\mathbf{F}_{ij}^{\\mathrm{CG}}.$$\n- The Irving–Kirkwood stress tensor for planar geometry is defined by\n  $$\\sigma_{\\alpha\\beta}(z) = - \\frac{1}{V_s} \\left[ \\sum_{i \\in s} m v_{i\\alpha} v_{i\\beta} + \\frac{1}{2} \\sum_{i \\neq j} r_{ij,\\alpha} F_{ij,\\beta} \\int_0^1 \\delta\\!\\left( z - z_i - \\lambda (z_j - z_i) \\right) \\,\\mathrm{d}\\lambda \\right],$$\n  where $\\alpha,\\beta \\in \\{x,y,z\\}$, $V_s$ is the slab volume, $r_{ij,\\alpha}$ is the $\\alpha$ component of the minimum image displacement, and $F_{ij,\\beta}$ is the $\\beta$ component of the pair force.\n\nNumerical implementation requirements:\n- The domain is a periodic box of size $L_x \\times L_y \\times L_z$. Divide the box into $M$ slabs of equal thickness $h = L_z/M$. The slab volumes equal $V_s = L_x L_y h$.\n- Approximate the IK line integral by a discrete sum over $K$ equally spaced points $\\lambda_k = \\dfrac{k + 1/2}{K}$ for $k \\in \\{0,\\dots,K-1\\}$ along the minimum image segment connecting $i$ and $j$. The contribution $-\\dfrac{1}{2V_s}\\,r_{ij,\\alpha} F_{ij,\\beta}$ is distributed uniformly across those slabs that contain the sample points via the discrete sum, i.e., each sample contributes $-\\dfrac{1}{2V_s K}\\,r_{ij,\\alpha} F_{ij,\\beta}$ to the slab containing $\\mathbf{r}_i + \\lambda_k \\mathbf{r}_{ij}$ (modulo periodic boundaries).\n- The kinetic contribution is $-\\dfrac{1}{V_s}\\sum_{i \\in s} m v_{i\\alpha} v_{i\\beta}$, with particle assignment by the particle’s $z$ coordinate to slab index $s$.\n- Generate initial positions on a simple cubic lattice within the box and add a small random displacement to each particle to avoid pathological overlaps. Use the minimum image convention for all pair displacements. Generate velocities from a Maxwell–Boltzmann distribution at temperature $T$ with variance $\\sigma_v^2 = k_{\\mathrm{B}} T/m = T$ in each component. Use a fixed pseudorandom seed to make the results reproducible.\n- Compute the baseline atomistic stress $\\sigma_{\\alpha\\beta}^{\\mathrm{AT}}(z)$ using $\\mathbf{F}_{ij}^{\\mathrm{AT}}$, and the hybrid stress $\\sigma_{\\alpha\\beta}^{\\mathrm{hyb}}(z)$ using $\\mathbf{F}_{ij}^{\\mathrm{hyb}}$ for a given $\\Delta$. In both cases, include the kinetic contribution. Define the anisotropy deviation for a given $\\Delta$ by\n  $$A(\\Delta) = \\max_{s \\in \\mathcal{H}(\\Delta)} \\max_{\\alpha,\\beta \\in \\{x,y,z\\}} \\left| \\sigma_{\\alpha\\beta}^{\\mathrm{hyb}}(z_s) - \\sigma_{\\alpha\\beta}^{\\mathrm{AT}}(z_s) \\right|,$$\n  where $\\mathcal{H}(\\Delta)$ denotes the set of slab indices whose centers lie inside the hybrid interval $[z_c - \\Delta/2, z_c + \\Delta/2]$.\n- For each test case, search a prescribed ascending list of candidate widths $\\{\\Delta_{\\mathrm{cand}}\\}$ to find the minimal $\\Delta_{\\mathrm{cand}}$ such that $A(\\Delta_{\\mathrm{cand}})  \\epsilon$. If no candidate satisfies the inequality, return $-1$.\n\nPhysical units and output requirement:\n- All lengths must be handled in units of $\\sigma_{\\mathrm{LJ}}$, all energies in units of $\\varepsilon_{\\mathrm{LJ}}$, all masses in units of $m$, and all stresses returned and compared in units of $\\varepsilon_{\\mathrm{LJ}}/\\sigma_{\\mathrm{LJ}}^3$.\n- Your program should produce a single line of output containing the minimal accepted hybrid widths for each test case, as a comma-separated Python list, e.g., $[\\Delta_1,\\Delta_2,\\Delta_3,\\Delta_4]$.\n\nTest suite:\nUse the following four test cases. Each case provides $(N, L_x, L_y, L_z, T, r_c, f_{\\mathrm{CG}}, M, K, \\epsilon, \\{\\Delta_{\\mathrm{cand}}\\})$.\n\n1. Case $1$: $N=150$, $L_x = 10$, $L_y = 10$, $L_z = 10$, $T = 1$, $r_c = 2.5$, $f_{\\mathrm{CG}} = 0.5$, $M = 20$, $K = 8$, $\\epsilon = 0.5$, $\\{\\Delta_{\\mathrm{cand}}\\} = \\{0.5, 1.0, 2.0, 3.0, 4.0\\}$.\n2. Case $2$: $N=80$, $L_x = 10$, $L_y = 10$, $L_z = 10$, $T = 1$, $r_c = 2.5$, $f_{\\mathrm{CG}} = 0.5$, $M = 20$, $K = 8$, $\\epsilon = 0.2$, $\\{\\Delta_{\\mathrm{cand}}\\} = \\{0.5, 1.0, 1.5, 2.0\\}$.\n3. Case $3$: $N=150$, $L_x = 10$, $L_y = 10$, $L_z = 10$, $T = 1$, $r_c = 2.5$, $f_{\\mathrm{CG}} = 0.5$, $M = 20$, $K = 8$, $\\epsilon = 0.01$, $\\{\\Delta_{\\mathrm{cand}}\\} = \\{0.5, 1.0, 2.0, 3.0, 4.0, 5.0\\}$.\n4. Case $4$: $N=150$, $L_x = 12$, $L_y = 12$, $L_z = 12$, $T = 1$, $r_c = 2.5$, $f_{\\mathrm{CG}} = 0.5$, $M = 24$, $K = 8$, $\\epsilon = 0.3$, $\\{\\Delta_{\\mathrm{cand}}\\} = \\{0.5, 1.0, 2.0, 3.0, 4.0, 6.0\\}$.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, for example, $[\\Delta_1,\\Delta_2,\\Delta_3,\\Delta_4]$, where each $\\Delta_i$ is either a float (if a candidate satisfies the tolerance) or the integer $-1$ (if no candidate satisfies the tolerance).", "solution": "The problem statement has been analyzed and is deemed valid. It is scientifically sound, well-posed, and provides a complete and consistent set of definitions and parameters. The problem is a well-defined computational task in the field of multiscale molecular dynamics, specifically concerning the calculation of the Irving-Kirkwood stress tensor in an Adaptive Resolution Simulation (AdResS) setup. We may therefore proceed with a full solution.\n\nThe solution is implemented by following the sequence of steps outlined in the problem statement. This involves generating a single static particle configuration, calculating stress tensors for a baseline all-atom system and for several hybrid systems with varying hybrid region widths, and then identifying the minimal width that satisfies a given tolerance criterion.\n\nFirst, we establish the initial state of the system for each test case. This consists of particle positions and velocities.\nParticle positions are generated on a simple cubic lattice structure that spans the simulation box of size $L_x \\times L_y \\times L_z$. For $N$ particles, we determine the number of grid points along each dimension as $n = \\lceil N^{1/3} \\rceil$. The lattice spacings are then $a_x = L_x/n$, $a_y = L_y/n$, and $a_z = L_z/n$. The $N$ particles are placed at the first $N$ grid points. A small random displacement, drawn from a uniform distribution, is added to each particle's coordinates to break the perfect lattice symmetry. All positions are then wrapped into the primary simulation box using periodic boundary conditions.\nParticle velocities are drawn from a\nMaxwell–Boltzmann distribution for a given temperature $T$. In the specified reduced units ($m=1, k_{\\mathrm{B}}=1$), the velocity component for each degree of freedom follows a normal distribution with mean $0$ and variance $T$. To ensure the system has no net drift, the center-of-mass velocity is calculated and subtracted from each particle's velocity vector. A fixed pseudorandom seed is used for all random number generation to ensure reproducibility.\n\nThe core of the problem is the calculation of the slab-resolved Irving–Kirkwood (IK) stress tensor, $\\sigma_{\\alpha\\beta}(z_s)$. The expression provided is:\n$$\n\\sigma_{\\alpha\\beta}(z_s) = - \\frac{1}{V_s} \\left[ \\mathcal{K}_{\\alpha\\beta}(s) + \\mathcal{V}_{\\alpha\\beta}(s) \\right]\n$$\nwhere $V_s=L_x L_y (L_z/M)$ is the volume of a slab $s$. The calculation is divided into a kinetic contribution, $\\mathcal{K}_{\\alpha\\beta}(s)$, and a virial (or configurational) contribution, $\\mathcal{V}_{\\alpha\\beta}(s)$.\n\nThe kinetic term for a slab $s$ is the sum of contributions from all particles $i$ whose $z$-coordinate, $z_i$, falls within that slab:\n$$\n\\mathcal{K}_{\\alpha\\beta}(s) = \\sum_{i \\text{ in slab } s} m v_{i\\alpha} v_{i\\beta}\n$$\nThe slab index for a particle $i$ at $z_i$ is determined by $s = \\lfloor z_i / h \\rfloor$, where $h = L_z/M$ is the slab thickness.\n\nThe virial term involves pairwise interactions and is given by:\n$$\n\\mathcal{V}_{\\alpha\\beta}(z) = \\frac{1}{2} \\sum_{i \\neq j} r_{ij,\\alpha} F_{ij,\\beta} \\int_0^1 \\delta\\!\\left( z - z_i - \\lambda (z_j - z_i) \\right) \\,\\mathrm{d}\\lambda\n$$\nwhere $\\mathbf{r}_{ij}$ is the minimum image displacement vector $\\mathbf{r}_j - \\mathbf{r}_i$ and $\\mathbf{F}_{ij}$ is the force exerted by particle $j$ on particle $i$. The sum over $i \\neq j$ can be simplified to $2 \\sum_{ij}$, which cancels the factor of $1/2$. The Dirac delta function and the integral over $\\lambda$ signify that the contribution from the pair interaction is distributed along the line segment connecting the two particles. As per the problem's numerical requirements, this line integral is approximated by a discrete sum over $K$ points. The contribution of a single pair $(i,j)$ is distributed uniformly over the $K$ sample points along the connecting line segment. The contribution to slab $s$ is thus:\n$$\n\\mathcal{V}_{\\alpha\\beta}(s) = \\sum_{ij} \\frac{1}{K} \\sum_{k=0}^{K-1} \\mathbb{I}[s_k(\\lambda_k) = s] \\, r_{ij,\\alpha} F_{ij,\\beta}\n$$\nwhere $\\lambda_k = (k+0.5)/K$, and $s_k(\\lambda_k)$ is the slab index corresponding to the $z$-coordinate of the point $\\mathbf{r}_i + \\lambda_k \\mathbf{r}_{ij}$.\n\nTwo types of forces are computed. The atomistic (AT) force, $\\mathbf{F}_{ij}^{\\mathrm{AT}}$, is derived from the truncated Lennard–Jones potential $U_{\\mathrm{AT}}(r) = 4\\varepsilon [(\\sigma/r)^{12} - (\\sigma/r)^6]$ with $\\varepsilon=1, \\sigma=1$. The coarse-grained (CG) force, $\\mathbf{F}_{ij}^{\\mathrm{CG}}$, has the same form but with a scaled energy parameter $\\varepsilon_{\\mathrm{CG}} = f_{\\mathrm{CG}}\\varepsilon$. The hybrid force, $\\mathbf{F}_{ij}^{\\mathrm{hyb}}$, is a position-dependent mixture of these two:\n$$\n\\mathbf{F}_{ij}^{\\mathrm{hyb}} = w(z_i)w(z_j)\\mathbf{F}_{ij}^{\\mathrm{AT}} + \\left[1 - w(z_i)w(z_j)\\right] \\mathbf{F}_{ij}^{\\mathrm{CG}}\n$$\nThe weighting function $w(z)$ smoothly transitions from $0$ in the coarse-grained region to $1$ in the atomistic region over the hybrid domain $[z_c - \\Delta/2, z_c + \\Delta/2]$, where $z_c = L_z/2$.\n\nFor each test case, we first compute the baseline atomistic stress tensor profile $\\sigma_{\\alpha\\beta}^{\\mathrm{AT}}(z_s)$ by using $\\mathbf{F}_{ij}^{\\mathrm{AT}}$ for all pairs. Then, we iterate through the prescribed candidate set of hybrid widths $\\{\\Delta_{\\mathrm{cand}}\\}$. For each $\\Delta_{\\mathrm{cand}}$, we compute the hybrid stress profile $\\sigma_{\\alpha\\beta}^{\\mathrm{hyb}}(z_s)$ using $\\mathbf{F}_{ij}^{\\mathrm{hyb}}$.\n\nThe anisotropy deviation $A(\\Delta)$ is then calculated as the maximum absolute difference between the hybrid and atomistic stress tensors over all components and all slabs whose centers lie within the hybrid region:\n$$\nA(\\Delta) = \\max_{s \\in \\mathcal{H}(\\Delta)} \\max_{\\alpha,\\beta} \\left| \\sigma_{\\alpha\\beta}^{\\mathrm{hyb}}(z_s) - \\sigma_{\\alpha\\beta}^{\\mathrm{AT}}(z_s) \\right|\n$$\nwhere $\\mathcal{H}(\\Delta) = \\{ s \\mid z_c - \\Delta/2 \\le (s+0.5)h \\le z_c+\\Delta/2 \\}$.\n\nThe first value of $\\Delta_{\\mathrm{cand}}$ from the sorted list for which $A(\\Delta_{\\mathrm{cand}})  \\epsilon$ is selected as the result for the test case. If no candidate width satisfies the condition, the result is $-1$. This procedure is repeated for all test cases.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main solver function that orchestrates the entire calculation for all test cases.\n    It defines helper functions and then executes the simulation logic.\n    \"\"\"\n    \n    # Use a fixed seed for reproducibility as requested.\n    GLOBAL_SEED = 42\n\n    def get_mic_displacement(dr, L):\n        \"\"\"\n        Applies minimum image convention to a displacement vector.\n        The displacement dr is for r_j - r_i.\n        \"\"\"\n        return dr - L * np.round(dr / L)\n\n    def w_func(z, z_c, delta, Lz):\n        \"\"\"\n        AdResS weighting function.\n        z is the z-coordinate of a particle.\n        \"\"\"\n        z_wrapped = z % Lz\n        \n        hybrid_min = z_c - delta / 2.0\n        hybrid_max = z_c + delta / 2.0\n\n        if z_wrapped  hybrid_min:\n            return 0.0\n        elif z_wrapped  hybrid_max:\n            return 1.0\n        else:\n            t = (z_wrapped - hybrid_min) / delta\n            return 3.0 * t**2 - 2.0 * t**3\n\n    def generate_initial_conditions(N, L, T, seed):\n        \"\"\"\n        Generates initial positions on a lattice and velocities from Maxwell-Boltzmann.\n        \"\"\"\n        rng = np.random.default_rng(seed)\n        \n        # Positions on a simple cubic grid that spans the box\n        n_per_dim = int(np.ceil(N**(1.0/3.0)))\n        spacings = L / n_per_dim\n        \n        pos = np.zeros((N, 3))\n        count = 0\n        for i in range(n_per_dim):\n            for j in range(n_per_dim):\n                for k in range(n_per_dim):\n                    if count  N:\n                        pos[count, :] = [i * spacings[0], j * spacings[1], k * spacings[2]]\n                        count += 1\n        \n        # Add small random displacement\n        disp_scale = np.min(spacings) * 0.1\n        pos += rng.uniform(-disp_scale/2.0, disp_scale/2.0, size=(N, 3))\n        \n        pos %= L\n        \n        # Velocities: variance is T since k_B=1, m=1.\n        vel = rng.normal(0.0, np.sqrt(T), size=(N, 3))\n        \n        # Remove center-of-mass velocity to prevent drift\n        vel -= np.mean(vel, axis=0)\n        \n        return pos, vel\n\n    def calculate_stress(pos, vel, L, M, K, rc, f_CG, delta):\n        \"\"\"\n        Computes the Irving-Kirkwood stress tensor profile.\n        delta=0.0 implies fully atomistic calculation.\n        delta0.0 implies hybrid calculation.\n        \"\"\"\n        N = pos.shape[0]\n        Lx, Ly, Lz = L[0], L[1], L[2]\n        h = Lz / M\n        V_s = Lx * Ly * h\n        rc_sq = rc**2\n        z_c = Lz / 2.0\n\n        m = 1.0\n        kinetic_contrib = np.zeros((M, 3, 3))\n        virial_contrib = np.zeros((M, 3, 3))\n        \n        # Kinetic part\n        for i in range(N):\n            slab_idx = int(pos[i, 2] / h)\n            if 0 = slab_idx  M:\n                kinetic_contrib[slab_idx] += m * np.outer(vel[i], vel[i])\n\n        # Virial part\n        lambda_k_vals = (np.arange(K) + 0.5) / K\n        \n        weights = np.ones(N)\n        is_hybrid = delta  0.0\n        if is_hybrid:\n            for i in range(N):\n                weights[i] = w_func(pos[i, 2], z_c, delta, Lz)\n\n        for i in range(N):\n            for j in range(i + 1, N):\n                r_ij = get_mic_displacement(pos[j] - pos[i], L)\n                r_sq = np.dot(r_ij, r_ij)\n                \n                if r_sq  rc_sq:\n                    r_inv2 = 1.0 / r_sq\n                    r_inv6 = r_inv2**3\n                    \n                    # Force magnitude / r: F(r)/r\n                    force_mag_over_r_at = 24.0 * (2.0 * r_inv6**2 - r_inv6) * r_inv2\n                    F_ij_at_vec = force_mag_over_r_at * r_ij\n                    \n                    if not is_hybrid:\n                        F_ij = F_ij_at_vec\n                    else:\n                        weight_prod = weights[i] * weights[j]\n                        force_scale = weight_prod + (1.0 - weight_prod) * f_CG\n                        F_ij = force_scale * F_ij_at_vec\n                    \n                    r_ij_outer_F_ij = np.outer(r_ij, F_ij)\n\n                    for lambda_k in lambda_k_vals:\n                        p_k_z = (pos[i, 2] + lambda_k * r_ij[2]) % Lz\n                        slab_idx_k = int(p_k_z / h)\n                        if 0 = slab_idx_k  M:\n                            virial_contrib[slab_idx_k] += r_ij_outer_F_ij\n        \n        virial_contrib /= K\n        stress_tensor = - (kinetic_contrib + virial_contrib) / V_s\n        return stress_tensor\n\n    def find_minimal_delta(N, Lx, Ly, Lz, T, rc, f_CG, M, K, epsilon, deltas_cand):\n        \"\"\"\n        Solves a single test case to find the minimal delta.\n        \"\"\"\n        L = np.array([Lx, Ly, Lz])\n        pos, vel = generate_initial_conditions(N, L, T, GLOBAL_SEED)\n        \n        sigma_at = calculate_stress(pos, vel, L, M, K, rc, f_CG, delta=0.0)\n\n        for delta_cand in deltas_cand:\n            sigma_hyb = calculate_stress(pos, vel, L, M, K, rc, f_CG, delta=delta_cand)\n            \n            h = Lz / M\n            z_c = Lz / 2.0\n            hybrid_region_min_z = z_c - delta_cand / 2.0\n            hybrid_region_max_z = z_c + delta_cand / 2.0\n            \n            max_deviation = 0.0\n            found_slab = False\n            for s in range(M):\n                slab_center_z = (s + 0.5) * h\n                if hybrid_region_min_z = slab_center_z = hybrid_region_max_z:\n                    found_slab = True\n                    deviation = np.max(np.abs(sigma_hyb[s] - sigma_at[s]))\n                    if deviation  max_deviation:\n                        max_deviation = deviation\n            \n            if found_slab and max_deviation  epsilon:\n                return delta_cand\n                \n        return -1\n\n    # Test cases from the problem statement.\n    test_cases = [\n        # (N, Lx, Ly, Lz, T, rc, f_CG, M, K, epsilon, Deltas_cand)\n        (150, 10.0, 10.0, 10.0, 1.0, 2.5, 0.5, 20, 8, 0.5, [0.5, 1.0, 2.0, 3.0, 4.0]),\n        (80, 10.0, 10.0, 10.0, 1.0, 2.5, 0.5, 20, 8, 0.2, [0.5, 1.0, 1.5, 2.0]),\n        (150, 10.0, 10.0, 10.0, 1.0, 2.5, 0.5, 20, 8, 0.01, [0.5, 1.0, 2.0, 3.0, 4.0, 5.0]),\n        (150, 12.0, 12.0, 12.0, 1.0, 2.5, 0.5, 24, 8, 0.3, [0.5, 1.0, 2.0, 3.0, 4.0, 6.0]),\n    ]\n    \n    results = []\n    for params in test_cases:\n        result = find_minimal_delta(*params)\n        results.append(result)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3427894"}, {"introduction": "While ensuring mechanical balance is crucial, maintaining thermodynamic consistency, particularly the conservation of total energy, is another fundamental challenge in adaptive resolution simulations. When a molecule crosses the boundary between regions, the abrupt change in its interaction potential can lead to a spurious energy drift, violating a key principle of Hamiltonian dynamics. In this practice problem [@problem_id:3427961], you will analyze this artifact in a simplified one-dimensional system to quantify the energy jump and then explore two distinct mitigation strategies: an instantaneous energy correction and a continuous dissipation via a Langevin thermostat.", "problem": "You are asked to formalize, quantify, and mitigate the energy drift that arises when a molecular pair undergoes an abrupt resolution change at an interface in an adaptive resolution simulation. Work in one spatial dimension and in reduced Lennard-Jones units (dimensionless), so no physical unit conversion is required.\n\nConsider a diatomic pair with positions $x_{1}$ and $x_{2}$ and center-of-mass coordinate $x_{\\mathrm{cm}} = (x_{1}+x_{2})/2$. An abrupt interface is placed at $x=0$. The region $x_{\\mathrm{cm}}  0$ is an atomistic domain and the region $x_{\\mathrm{cm}} \\ge 0$ is a coarse-grained domain. The pairwise interaction in the atomistic domain is the Lennard-Jones potential, and the coarse-grained domain uses a harmonic potential with an energy offset:\n$$\nV_{\\mathrm{AT}}(r) = 4 \\varepsilon \\left[\\left(\\frac{\\sigma}{r}\\right)^{12} - \\left(\\frac{\\sigma}{r}\\right)^{6}\\right], \\quad\nW_{\\mathrm{CG}}(r) = \\frac{1}{2} k \\left(r - r_{0}\\right)^{2} + u_{0},\n$$\nwhere $r = |x_{2} - x_{1}|$, and $\\varepsilon$, $\\sigma$, $k$, $r_{0}$, and $u_{0}$ are given parameters.\n\nAt a discrete time step, you are given the pair’s positions just before and just after the step, $(x_{1}^{\\mathrm{before}}, x_{2}^{\\mathrm{before}})$ and $(x_{1}^{\\mathrm{after}}, x_{2}^{\\mathrm{after}})$. An abrupt resolution switch is deemed to occur if $\\mathrm{sign}(x_{\\mathrm{cm}}^{\\mathrm{before}}) \\ne \\mathrm{sign}(x_{\\mathrm{cm}}^{\\mathrm{after}})$, where $x_{\\mathrm{cm}}^{\\mathrm{before}} = (x_{1}^{\\mathrm{before}}+x_{2}^{\\mathrm{before}})/2$ and $x_{\\mathrm{cm}}^{\\mathrm{after}} = (x_{1}^{\\mathrm{after}}+x_{2}^{\\mathrm{after}})/2$. In that case, define the spurious energy drift as the jump in the Hamiltonian due solely to the change in resolution, evaluated at the post-step separation $r^{\\mathrm{after}} = |x_{2}^{\\mathrm{after}} - x_{1}^{\\mathrm{after}}|$:\n- If the switch is from atomistic to coarse-grained, the old potential is $V_{\\mathrm{old}} = V_{\\mathrm{AT}}(r^{\\mathrm{after}})$ and the new potential is $V_{\\mathrm{new}} = W_{\\mathrm{CG}}(r^{\\mathrm{after}})$.\n- If the switch is from coarse-grained to atomistic, the old potential is $V_{\\mathrm{old}} = W_{\\mathrm{CG}}(r^{\\mathrm{after}})$ and the new potential is $V_{\\mathrm{new}} = V_{\\mathrm{AT}}(r^{\\mathrm{after}})$.\n- If no switch occurs, the spurious drift is zero.\n\nThe energy drift is $\\Delta E = V_{\\mathrm{new}} - V_{\\mathrm{old}}$. A minimal energy-conserving correction is a scalar compensation $c$ applied upon switching such that the corrected energy change vanishes, $c = -\\Delta E$.\n\nAdditionally, propose a thermostat-based mitigation using a Langevin thermostat. Let a desired relaxation time $\\tau$ and a target removal fraction $f \\in (0,1)$ be given. Choose a friction coefficient $\\gamma$ such that an initial energy deviation of magnitude $|\\Delta E|$ would relax in expectation to a remaining fraction $(1-f)$ of its initial value after time $\\tau$. You must compute $\\gamma$ that satisfies this property in reduced units.\n\nTask:\n- For each test case below, compute the triple $[\\Delta E, c, \\gamma]$ where $\\Delta E$ is the energy drift defined above, $c$ is the instantaneous compensation as above, and $\\gamma$ is the Langevin friction coefficient consistent with the specified relaxation behavior. All potentials, positions, and parameters are given in reduced dimensionless units.\n- Angle units are not applicable.\n- Output format: Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each element is itself a triple in square brackets, i.e., a list of triples $[\\Delta E, c, \\gamma]$ for each test case. Each floating-point number must be rounded to $8$ decimal places. For example: $[[a_{1},b_{1},c_{1}],[a_{2},b_{2},c_{2}],\\dots]$, with no spaces.\n- Important: Use $r^{\\mathrm{after}}$ in the potential evaluations for $\\Delta E$. Determine the switching direction using $x_{\\mathrm{cm}}^{\\mathrm{before}}$ and $x_{\\mathrm{cm}}^{\\mathrm{after}}$ as specified.\n\nTest suite (each case lists $(\\varepsilon,\\sigma,k,r_{0},u_{0},x_{1}^{\\mathrm{before}},x_{2}^{\\mathrm{before}},x_{1}^{\\mathrm{after}},x_{2}^{\\mathrm{after}},\\tau,f)$):\n- Case $1$ (happy path, switch from atomistic to coarse-grained near matched minima): $(1.0, 1.0, 100.0, 1.122462048, -1.0, -0.6, -0.3, 0.0, 1.122462048, 5.0, 0.9)$.\n- Case $2$ (no switch, energy drift zero by construction): $(1.0, 1.0, 100.0, 1.122462048, -1.0, -0.8, -0.2, -0.7, -0.1, 1.0, 0.5)$.\n- Case $3$ (switch from atomistic to coarse-grained at compressed separation): $(1.0, 1.0, 100.0, 1.122462048, -1.0, -0.6, -0.4, 0.1, 1.0, 2.0, 0.95)$.\n- Case $4$ (switch from coarse-grained to atomistic at stretched separation): $(1.0, 1.0, 100.0, 1.122462048, -1.0, 0.2, 1.8, -1.0, 0.5, 1.0, 0.99)$.\n\nYour program must implement the above logic exactly and print a single line of the form $[[\\Delta E_{1},c_{1},\\gamma_{1}],[\\Delta E_{2},c_{2},\\gamma_{2}],[\\Delta E_{3},c_{3},\\gamma_{3}],[\\Delta E_{4},c_{4},\\gamma_{4}]]$ with all entries rounded to $8$ decimal places, no additional text, and no spaces.", "solution": "The problem requires the calculation of three quantities related to an abrupt resolution change in an adaptive resolution molecular dynamics simulation: the spurious energy drift $\\Delta E$, the corresponding instantaneous energy compensation $c$, and a friction coefficient $\\gamma$ for a Langevin thermostat designed to mitigate such energy deviations over time. The analysis is performed for a diatomic pair in one dimension.\n\nFirst, we formalize the simulation setup. The system consists of two particles at positions $x_1$ and $x_2$. The resolution region is determined by their center-of-mass coordinate, $x_{\\mathrm{cm}} = (x_1 + x_2)/2$. The region $x_{\\mathrm{cm}}  0$ is atomistic (AT), and the region $x_{\\mathrm{cm}} \\ge 0$ is coarse-grained (CG). The inter-particle distance is $r = |x_2 - x_1|$.\n\nThe potential energy functions are given for each region. In the AT region, the interaction is the Lennard-Jones (LJ) potential:\n$$\nV_{\\mathrm{AT}}(r) = 4 \\varepsilon \\left[\\left(\\frac{\\sigma}{r}\\right)^{12} - \\left(\\frac{\\sigma}{r}\\right)^{6}\\right]\n$$\nIn the CG region, the interaction is a harmonic potential with an energy offset:\n$$\nW_{\\mathrm{CG}}(r) = \\frac{1}{2} k \\left(r - r_0\\right)^2 + u_0\n$$\nwhere $\\varepsilon$, $\\sigma$, $k$, $r_0$, and $u_0$ are given parameters.\n\nThe core of the problem is to identify when a resolution switch occurs and to quantify the resulting energy artifact. A switch is defined to have occurred between two time steps if the center of mass crosses the interface at $x=0$. Given the positions before the step, $(x_1^{\\mathrm{before}}, x_2^{\\mathrm{before}})$, and after, $(x_1^{\\mathrm{after}}, x_2^{\\mathrm{after}})$, we first compute the corresponding centers of mass, $x_{\\mathrm{cm}}^{\\mathrm{before}}$ and $x_{\\mathrm{cm}}^{\\mathrm{after}}$. A switch occurs if the particle pair is in a different resolution region before and after the step. Specifically, if one of $x_{\\mathrm{cm}}^{\\mathrm{before}}$ and $x_{\\mathrm{cm}}^{\\mathrm{after}}$ is less than $0$ and the other is greater than or equal to $0$.\n\nIf no switch occurs, the energy drift $\\Delta E$ is defined to be $0$. If a switch occurs, the drift is the difference between the potential energy of the new resolution level and the potential energy of the old resolution level, both evaluated at the final inter-particle separation, $r^{\\mathrm{after}} = |x_2^{\\mathrm{after}} - x_1^{\\mathrm{after}}|$.\nLet $V_{\\mathrm{old}}$ be the potential in the \"before\" region and $V_{\\mathrm{new}}$ be the potential in the \"after\" region. The energy drift is $\\Delta E = V_{\\mathrm{new}}(r^{\\mathrm{after}}) - V_{\\mathrm{old}}(r^{\\mathrm{after}})$.\n explicitly:\n- For a switch from AT to CG ($x_{\\mathrm{cm}}^{\\mathrm{before}}  0$ and $x_{\\mathrm{cm}}^{\\mathrm{after}} \\ge 0$): $\\Delta E = W_{\\mathrm{CG}}(r^{\\mathrm{after}}) - V_{\\mathrm{AT}}(r^{\\mathrm{after}})$.\n- For a switch from CG to AT ($x_{\\mathrm{cm}}^{\\mathrm{before}} \\ge 0$ and $x_{\\mathrm{cm}}^{\\mathrm{after}}  0$): $\\Delta E = V_{\\mathrm{AT}}(r^{\\mathrm{after}}) - W_{\\mathrm{CG}}(r^{\\mathrm{after}})$.\n\nThe second quantity to compute is the instantaneous compensation, $c$. This is a simple correction designed to nullify the energy drift at the moment it occurs. It is defined as:\n$$\nc = - \\Delta E\n$$\nApplying this correction would restore energy conservation for the potential energy part of the Hamiltonian at the switching instant.\n\nThe third quantity is the friction coefficient, $\\gamma$, for a Langevin thermostat. This represents a continuous, rather than instantaneous, method of mitigating energy drift. The thermostat is characterized by a desired relaxation time $\\tau$ and a target removal fraction $f$ for any energy deviation. We are asked to find $\\gamma$ such that an initial energy deviation, $\\Delta E_0$, relaxes in expectation to a remaining fraction $(1-f)$ of its value after a time $\\tau$. The expected decay of an energy perturbation in a system coupled to a Langevin thermostat is commonly modeled by an exponential decay. The rate of this decay is related to the friction coefficient. For many systems, the energy relaxation rate is $2\\gamma$. Thus, the expected energy deviation $\\langle \\delta E(t) \\rangle$ at time $t$ is:\n$$\n\\langle \\delta E(t) \\rangle = \\delta E_0 e^{-2\\gamma t}\n$$\nAccording to the problem statement, after a time $\\tau$, the remaining energy is $(1-f)$ of the initial amount:\n$$\n\\langle \\delta E(\\tau) \\rangle = (1-f) \\delta E_0\n$$\nEquating the two expressions gives:\n$$\n\\delta E_0 e^{-2\\gamma \\tau} = (1-f) \\delta E_0\n$$\n$$\ne^{-2\\gamma \\tau} = 1-f\n$$\nTo solve for $\\gamma$, we take the natural logarithm of both sides:\n$$\n-2\\gamma \\tau = \\ln(1-f)\n$$\nFinally, we isolate $\\gamma$:\n$$\n\\gamma = -\\frac{\\ln(1-f)}{2\\tau}\n$$\nSince $f \\in (0,1)$, $1-f$ is also in $(0,1)$, making $\\ln(1-f)$ negative. Thus, $\\gamma$ is guaranteed to be positive, as physically required for a friction coefficient. This formula is used to calculate $\\gamma$ for each test case, using the provided $\\tau$ and $f$ values. Note that $\\gamma$ depends only on the desired thermostatting properties, not on the magnitude of the energy drift itself.\n\nThe overall algorithm for each test case is as follows:\n1.  Read the input parameters $(\\varepsilon, \\sigma, k, r_0, u_0, x_1^{\\mathrm{before}}, x_2^{\\mathrm{before}}, x_1^{\\mathrm{after}}, x_2^{\\mathrm{after}}, \\tau, f)$.\n2.  Compute $x_{\\mathrm{cm}}^{\\mathrm{before}} = (x_1^{\\mathrm{before}} + x_2^{\\mathrm{before}})/2$ and $x_{\\mathrm{cm}}^{\\mathrm{after}} = (x_1^{\\mathrm{after}} + x_2^{\\mathrm{after}})/2$.\n3.  Determine if a switch occurred by checking if the pair crossed the $x=0$ boundary.\n4.  If a switch occurred:\n    a. Calculate $r^{\\mathrm{after}} = |x_2^{\\mathrm{after}} - x_1^{\\mathrm{after}}|$.\n    b. Evaluate $V_{\\mathrm{AT}}(r^{\\mathrm{after}})$ and $W_{\\mathrm{CG}}(r^{\\mathrm{after}})$.\n    c. Calculate $\\Delta E$ based on the switching direction.\n5.  If no switch occurred, set $\\Delta E = 0$.\n6.  Calculate $c = -\\Delta E$.\n7.  Calculate $\\gamma = -\\ln(1-f) / (2\\tau)$.\n8.  Store the resulting triple $[\\Delta E, c, \\gamma]$.\nThis procedure is applied to all provided test cases.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes energy drift, compensation, and thermostat friction for adaptive resolution simulations.\n    \"\"\"\n\n    test_cases = [\n        # (eps, sigma, k, r0, u0, x1_before, x2_before, x1_after, x2_after, tau, f)\n        (1.0, 1.0, 100.0, 1.122462048, -1.0, -0.6, -0.3, 0.0, 1.122462048, 5.0, 0.9),\n        (1.0, 1.0, 100.0, 1.122462048, -1.0, -0.8, -0.2, -0.7, -0.1, 1.0, 0.5),\n        (1.0, 1.0, 100.0, 1.122462048, -1.0, -0.6, -0.4, 0.1, 1.0, 2.0, 0.95),\n        (1.0, 1.0, 100.0, 1.122462048, -1.0, 0.2, 1.8, -1.0, 0.5, 1.0, 0.99),\n    ]\n\n    def V_AT(r, eps, sigma):\n        \"\"\"Lennard-Jones potential.\"\"\"\n        s_over_r_6 = (sigma / r)**6\n        s_over_r_12 = s_over_r_6**2\n        return 4.0 * eps * (s_over_r_12 - s_over_r_6)\n\n    def W_CG(r, k, r0, u0):\n        \"\"\"Coarse-grained harmonic potential.\"\"\"\n        return 0.5 * k * (r - r0)**2 + u0\n\n    results = []\n    for case in test_cases:\n        eps, sigma, k, r0, u0, x1_before, x2_before, x1_after, x2_after, tau, f = case\n\n        # Step 1: Calculate centers of mass and check for a switch\n        x_cm_before = (x1_before + x2_before) / 2.0\n        x_cm_after = (x1_after + x2_after) / 2.0\n\n        is_before_at = x_cm_before  0\n        is_after_at = x_cm_after  0\n        \n        switch_occurred = is_before_at != is_after_at\n\n        delta_E = 0.0\n        if switch_occurred:\n            # Step 2: Calculate energy drift if a switch occurred\n            r_after = abs(x2_after - x1_after)\n            \n            pot_AT = V_AT(r_after, eps, sigma)\n            pot_CG = W_CG(r_after, k, r0, u0)\n            \n            if is_before_at and not is_after_at:  # AT - CG switch\n                V_old = pot_AT\n                V_new = pot_CG\n            else:  # CG - AT switch\n                V_old = pot_CG\n                V_new = pot_AT\n            \n            delta_E = V_new - V_old\n\n        # Step 3: Calculate instantaneous compensation\n        c = -delta_E\n\n        # Step 4: Calculate Langevin friction coefficient\n        # gamma = -ln(1-f) / (2*tau)\n        gamma = -np.log(1.0 - f) / (2.0 * tau)\n\n        results.append([delta_E, c, gamma])\n\n    # Final formatting and printing\n    formatted_strings = []\n    for res in results:\n        s = f\"[{res[0]:.8f},{res[1]:.8f},{res[2]:.8f}]\"\n        formatted_strings.append(s)\n    \n    final_output = f\"[{','.join(formatted_strings)}]\"\n    print(final_output)\n\nsolve()\n```", "id": "3427961"}]}