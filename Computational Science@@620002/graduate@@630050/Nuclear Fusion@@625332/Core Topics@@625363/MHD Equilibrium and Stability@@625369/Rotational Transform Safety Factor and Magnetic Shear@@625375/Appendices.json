{"hands_on_practices": [{"introduction": "The first step in mastering magnetic shear is to develop proficiency in calculating it from a given safety factor profile, $q(r)$. This exercise provides practice in applying the mathematical definition of magnetic shear, $\\hat{s}(r)$, to a common parametric model for the $q$-profile [@problem_id:3717265]. By working through this derivation, you will gain a concrete understanding of how the shape of the safety factor profile dictates the shear and under what conditions a \"reversed shear\" configuration, which is beneficial for plasma stability, can arise.", "problem": "In an axisymmetric toroidal confinement device of minor radius $a$, the safety factor $q(r)$ is defined as the ratio of the number of toroidal transits to the number of poloidal transits of a magnetic field line, and the rotational transform $\\iota(r)$ is defined by $\\iota(r)=1/q(r)$. The normalized magnetic shear $\\hat{s}(r)$ quantifies the radial variation of the field-line pitch and is defined in terms of how $q(r)$ varies with the minor radius $r$. Consider a parametric safety-factor profile\n$$\nq(r)=q_0+\\bigl(q_a-q_0\\bigr)\\left(\\frac{r}{a}\\right)^{\\beta},\n$$\nwith constants $q_00$, $q_a0$, and $\\beta0$, and with $0\\le r\\le a$.\n\nStarting from the definitions above and without invoking any pre-memorized shear formulas, derive an explicit closed-form expression for the normalized magnetic shear $\\hat{s}(r)$ in terms of $q_0$, $q_a$, $a$, $\\beta$, and $r$. Then, using your derived expression, determine the conditions on $q_0$, $q_a$, and $\\beta$ under which the plasma core ($r\\to 0^{+}$) exhibits reversed shear, understood here as $\\hat{s}(r)0$ in the neighborhood of the magnetic axis.\n\nExpress your final answer as the closed-form analytic expression for $\\hat{s}(r)$. No numerical evaluation is required. No units are to be included in the final answer because $\\hat{s}(r)$ is dimensionless.", "solution": "The problem statement is examined and found to be valid. It is scientifically grounded in the principles of plasma physics and magnetohydrodynamics for toroidal confinement devices. The problem is well-posed, objective, and contains sufficient information to derive the requested expression and analyze the specified physical condition. The given parametric profile for the safety factor is a standard model used in the field. The provided conceptual definition of magnetic shear can be formalized using a standard mathematical expression, which is a necessary and reasonable step for a problem at this level.\n\nThe primary task is to derive an expression for the normalized magnetic shear, $\\hat{s}(r)$, for a given safety factor profile, $q(r)$. The safety factor is given as\n$$\nq(r) = q_0 + (q_a - q_0)\\left(\\frac{r}{a}\\right)^{\\beta}\n$$\nwhere $q_0$, $q_a$, $a$, and $\\beta$ are positive constants, and $r$ is the minor radius, with $0 \\le r \\le a$.\n\nThe normalized magnetic shear, $\\hat{s}(r)$, quantifies the radial variation of the magnetic field line pitch. It is a dimensionless measure of how the safety factor $q$ changes with radius. The standard and most widely accepted definition of the normalized magnetic shear, which formalizes the conceptual description provided in the problem, is\n$$\n\\hat{s}(r) = \\frac{r}{q(r)} \\frac{dq(r)}{dr}\n$$\nThe problem's injunction against using \"pre-memorized shear formulas\" is interpreted as requiring a derivation starting from this fundamental definition applied to the specific $q(r)$ profile, rather than quoting a result for a general class of profiles.\n\nFirst, we must calculate the derivative of the given $q(r)$ with respect to $r$:\n$$\n\\frac{dq(r)}{dr} = \\frac{d}{dr} \\left[ q_0 + (q_a - q_0)\\left(\\frac{r}{a}\\right)^{\\beta} \\right]\n$$\nSince $q_0$, $q_a$, $a$, and $\\beta$ are constants, we can write the expression as $q(r) = q_0 + \\frac{q_a - q_0}{a^{\\beta}} r^{\\beta}$. The derivative is then:\n$$\n\\frac{dq(r)}{dr} = 0 + \\frac{q_a - q_0}{a^{\\beta}} \\cdot \\frac{d}{dr}(r^{\\beta}) = \\frac{q_a - q_0}{a^{\\beta}} (\\beta r^{\\beta-1})\n$$\nThis can be rewritten as:\n$$\n\\frac{dq(r)}{dr} = \\beta (q_a - q_0) \\frac{r^{\\beta-1}}{a^{\\beta}}\n$$\nNow, we substitute both $q(r)$ and its derivative $\\frac{dq(r)}{dr}$ into the definition of $\\hat{s}(r)$:\n$$\n\\hat{s}(r) = \\frac{r}{q_0 + (q_a - q_0)\\left(\\frac{r}{a}\\right)^{\\beta}} \\left[ \\beta (q_a - q_0) \\frac{r^{\\beta-1}}{a^{\\beta}} \\right]\n$$\nTo simplify this expression, we combine the terms involving $r$:\n$$\n\\hat{s}(r) = \\frac{\\beta (q_a - q_0) \\frac{r \\cdot r^{\\beta-1}}{a^{\\beta}}}{q_0 + (q_a - q_0)\\left(\\frac{r}{a}\\right)^{\\beta}} = \\frac{\\beta (q_a - q_0) \\frac{r^{\\beta}}{a^{\\beta}}}{q_0 + (q_a - q_0)\\left(\\frac{r}{a}\\right)^{\\beta}}\n$$\nThis yields the final closed-form expression for the normalized magnetic shear:\n$$\n\\hat{s}(r) = \\frac{\\beta (q_a - q_0) (r/a)^{\\beta}}{q_0 + (q_a - q_0) (r/a)^{\\beta}}\n$$\nThe second part of the problem asks for the conditions on the constants under which the plasma core ($r \\to 0^{+}$) exhibits reversed shear. Reversed shear is defined in the problem as $\\hat{s}(r)  0$ in the neighborhood of the magnetic axis. We must therefore analyze the sign of $\\hat{s}(r)$ for small, positive values of $r$.\n\nLet's examine the derived expression for $\\hat{s}(r)$ as $r \\to 0^{+}$.\nThe denominator is $D(r) = q_0 + (q_a - q_0) (r/a)^{\\beta}$.\nThe numerator is $N(r) = \\beta (q_a - q_0) (r/a)^{\\beta}$.\n\nAs $r \\to 0^{+}$, since $\\beta  0$, the term $(r/a)^{\\beta} \\to 0$.\nThe denominator tends to $D(r) \\to q_0$. Since we are given $q_0  0$, the denominator is positive for $r$ sufficiently close to $0$.\nThe sign of $\\hat{s}(r)$ for small $r  0$ is therefore determined by the sign of the numerator, $N(r)$.\nThe numerator is $N(r) = \\beta (q_a - q_0) (r/a)^{\\beta}$. We are given that $\\beta  0$. For any $r \\in (0, a]$, the term $(r/a)^{\\beta}$ is also positive.\nThus, the sign of $N(r)$ is determined solely by the sign of the factor $(q_a - q_0)$.\n\nFor reversed shear, we require $\\hat{s}(r)  0$. This implies that the numerator must be negative:\n$$\n\\beta (q_a - q_0) (r/a)^{\\beta}  0\n$$\nSince $\\beta  0$ and $(r/a)^{\\beta}  0$ for $r \\in (0, a]$, this inequality is satisfied if and only if\n$$\nq_a - q_0  0 \\quad \\implies \\quad q_a  q_0\n$$\nThis condition is independent of the parameter $\\beta$, as long as it is positive. The physical interpretation is that the safety factor on the magnetic axis, $q(0) = q_0$, must be greater than the safety factor at the plasma edge, $q(a) = q_a$. This creates a $q$-profile that is monotonically decreasing with radius (for this specific functional form), corresponding to a negative value of $dq/dr$ and hence a negative shear $\\hat{s}(r)$ for all $r \\in (0, a]$. This fulfills the condition of reversed shear in the core region.\n\nThe problem asks for the final answer to be the closed-form expression for $\\hat{s}(r)$.", "answer": "$$\n\\boxed{\\frac{\\beta(q_a - q_0)\\left(\\frac{r}{a}\\right)^{\\beta}}{q_0 + (q_a - q_0)\\left(\\frac{r}{a}\\right)^{\\beta}}}\n$$", "id": "3717265"}, {"introduction": "Magnetic shear is not merely a mathematical descriptor of a magnetic field; it is a critical physical property that can be actively controlled to optimize plasma confinement. This advanced practice bridges the gap between the abstract $q$-profile and its physical cause: the toroidal current density, $j(r)$ [@problem_id:3717219]. By deriving the necessary auxiliary current drive profile to achieve a target reversed-shear equilibrium, you will explore the powerful technique of profile control, a cornerstone of modern advanced tokamak operating scenarios.", "problem": "Consider a large–aspect–ratio, circular–flux–surface tokamak with major radius $R_{0}$ and minor radius $a$. Assume axisymmetry, negligible Shafranov shift, and that the toroidal magnetic field $B_{\\phi}$ is radially uniform and equal to a constant $B_{0}$. The total toroidal plasma current density is the sum of an Ohmic component and an auxiliary driven component, $j_{\\mathrm{tot}}(r) = j_{\\mathrm{ohm}}(r) + j_{\\mathrm{cd}}(r)$, with a baseline Ohmic profile $j_{\\mathrm{ohm}}(r) = j_{0}\\left(1 - \\left(\\frac{r}{a}\\right)^{2}\\right)$ for $0 \\le r \\le a$.\n\nThe safety factor $q(r)$ is defined as the field–line pitch (ratio of toroidal to poloidal transits) on a flux surface. Starting from Maxwell–Ampère’s law and this core definition of $q(r)$, derive how the auxiliary driven toroidal current density $j_{\\mathrm{cd}}(r)$ modifies the magnetic shear $dq/dr$ and under what condition a region of reversed shear ($dq/dr  0$ over a finite interval of $r$) can be created.\n\nYou are tasked with achieving the following target safety–factor profile:\n$$\nq_{\\mathrm{tgt}}(r) \\equiv q_{0} + A_{2}\\left(\\frac{r}{a}\\right)^{2} - A_{4}\\left(\\frac{r}{a}\\right)^{4} + A_{6}\\left(\\frac{r}{a}\\right)^{6},\n$$\nwhere $q_{0}  0$ and $A_{2}  0$, $A_{4}  0$, $A_{6}  0$ are constants chosen such that the magnetic shear reverses sign in an intermediate radial region. Compute the explicit auxiliary current–drive profile $j_{\\mathrm{cd}}(r)$ that, when added to $j_{\\mathrm{ohm}}(r)$, produces $q(r) = q_{\\mathrm{tgt}}(r)$ throughout $0 \\le r \\le a$.\n\nExpress your final expression for $j_{\\mathrm{cd}}(r)$ in base International System of Units (SI), taking $r$ in meters and current density in $\\mathrm{A\\,m^{-2}}$. Your final answer must be a single closed–form analytic expression.", "solution": "We begin from Maxwell–Ampère’s law, $\\nabla \\times \\mathbf{B} = \\mu_{0}\\mathbf{j}$, and exploit axisymmetry and large aspect ratio to relate the poloidal magnetic field $B_{\\theta}(r)$ to the toroidal plasma current enclosed within radius $r$. In cylindrical approximation,\n$$\nB_{\\theta}(r) = \\frac{\\mu_{0} I(r)}{2\\pi r},\n$$\nwhere $I(r) = \\int_{0}^{r} 2\\pi r' j_{\\mathrm{tot}}(r')\\,dr'$ is the total toroidal current enclosed by the flux surface of minor radius $r$.\n\nThe safety factor $q(r)$ is defined as the field–line pitch. In the large–aspect–ratio circular approximation,\n$$\nq(r) = \\frac{r B_{\\phi}}{R_{0} B_{\\theta}(r)}.\n$$\nWith $B_{\\phi}(r) \\approx B_{0}$, we obtain\n$$\nq(r) = \\frac{r B_{0}}{R_{0}}\\cdot \\frac{2\\pi r}{\\mu_{0} I(r)} = \\frac{2\\pi B_{0}}{\\mu_{0}R_{0}} \\cdot \\frac{r^{2}}{I(r)}.\n$$\nIt is convenient to introduce the constant\n$$\nK \\equiv \\frac{2\\pi B_{0}}{\\mu_{0}R_{0}},\n$$\nso that $q(r) = K \\frac{r^{2}}{I(r)}$. This relation captures how the enclosed current $I(r)$ sets the poloidal field and hence the field–line pitch.\n\nTo see how the current density modifies the magnetic shear $dq/dr$, differentiate $q(r)$ with respect to $r$:\n$$\n\\frac{dq}{dr} = K\\left(\\frac{2r}{I(r)} - \\frac{r^{2} I'(r)}{I(r)^{2}}\\right).\n$$\nUsing $I'(r) = \\frac{dI}{dr} = 2\\pi r\\, j_{\\mathrm{tot}}(r)$, we find\n$$\n\\frac{dq}{dr} = K\\left(\\frac{2r}{I} - \\frac{r^{2}\\,2\\pi r\\, j_{\\mathrm{tot}}}{I^{2}}\\right).\n$$\nWe can express $I$ in terms of $q$ using $I = K r^{2}/q$, which gives $I^{2} = K^{2} r^{4}/q^{2}$, and also note that $K/I = q/r^{2}$. Substituting,\n$$\n\\frac{dq}{dr} = 2\\,\\frac{q}{r} - \\frac{2\\pi K r^{3} j_{\\mathrm{tot}}}{I^{2}} = 2\\,\\frac{q}{r} - \\frac{2\\pi j_{\\mathrm{tot}} q^{2}}{K r}.\n$$\nRecalling $K = \\frac{2\\pi B_{0}}{\\mu_{0}R_{0}}$, we obtain\n$$\n\\frac{dq}{dr} = \\frac{2q}{r} - \\frac{\\mu_{0}R_{0}}{B_{0}}\\,\\frac{j_{\\mathrm{tot}} q^{2}}{r}.\n$$\nThis expression shows that, for given $q(r)$, the sign and magnitude of $dq/dr$ are directly controlled by $j_{\\mathrm{tot}}(r)$. The shear is zero when\n$$\n\\frac{dq}{dr} = 0 \\quad \\Longleftrightarrow \\quad j_{\\mathrm{tot}}(r) = \\frac{2 B_{0}}{\\mu_{0} R_{0}\\, q(r)}.\n$$\nHence, a region of reversed shear ($dq/dr  0$) can be created by making $j_{\\mathrm{tot}}(r)$ exceed the threshold\n$j_{\\mathrm{rs}}(r) \\equiv \\frac{2 B_{0}}{\\mu_{0} R_{0}\\, q(r)}$,\nover an interval of $r$, i.e., by appropriately tailoring the auxiliary current drive $j_{\\mathrm{cd}}(r)$ such that $j_{\\mathrm{ohm}}(r) + j_{\\mathrm{cd}}(r)  j_{\\mathrm{rs}}(r)$ in that interval while maintaining desirable shear elsewhere.\n\nNext, we compute the auxiliary current density required to realize a specified target profile $q_{\\mathrm{tgt}}(r)$. Starting from $q(r) = K r^{2}/I(r)$, we can solve for the enclosed current as\n$$\nI(r) = \\frac{K r^{2}}{q(r)} = \\frac{2\\pi B_{0}}{\\mu_{0} R_{0}}\\,\\frac{r^{2}}{q(r)}.\n$$\nDifferentiating this $I(r)$ and using $I'(r) = 2\\pi r\\, j_{\\mathrm{tot}}(r)$ yields\n$$\nj_{\\mathrm{tot}}(r) = \\frac{1}{2\\pi r}\\,\\frac{dI}{dr} = \\frac{B_{0}}{\\mu_{0} R_{0}\\, r}\\,\\frac{d}{dr}\\!\\left(\\frac{r^{2}}{q(r)}\\right).\n$$\nTherefore, for the target $q_{\\mathrm{tgt}}(r)$, the required total current density is\n$$\nj_{\\mathrm{tot}}(r) = \\frac{B_{0}}{\\mu_{0} R_{0}\\, r}\\,\\frac{d}{dr}\\!\\left(\\frac{r^{2}}{q_{\\mathrm{tgt}}(r)}\\right).\n$$\nThe auxiliary current–drive profile is then\n$$\nj_{\\mathrm{cd}}(r) = j_{\\mathrm{tot}}(r) - j_{\\mathrm{ohm}}(r) = \\frac{B_{0}}{\\mu_{0} R_{0}\\, r}\\,\\frac{d}{dr}\\!\\left(\\frac{r^{2}}{q_{\\mathrm{tgt}}(r)}\\right) - j_{0}\\left(1 - \\left(\\frac{r}{a}\\right)^{2}\\right).\n$$\n\nTo render this in a closed form, define the dimensionless radius $\\rho \\equiv \\frac{r}{a}$ and write\n$$\nq_{\\mathrm{tgt}}(r) = q_{0} + A_{2}\\rho^{2} - A_{4}\\rho^{4} + A_{6}\\rho^{6}.\n$$\nUsing $\\frac{d}{dr} = \\frac{1}{a}\\frac{d}{d\\rho}$ and $r = a\\rho$, we have\n$$\nj_{\\mathrm{tot}}(r) = \\frac{B_{0}}{\\mu_{0} R_{0}\\, a\\rho}\\cdot a\\,\\frac{d}{d\\rho}\\!\\left(\\frac{\\rho^{2}}{q_{\\mathrm{tgt}}(\\rho)}\\right) = \\frac{B_{0}}{\\mu_{0} R_{0}}\\,\\frac{2 q_{\\mathrm{tgt}}(\\rho) - \\rho\\,\\frac{dq_{\\mathrm{tgt}}}{d\\rho}}{q_{\\mathrm{tgt}}(\\rho)^{2}},\n$$\nwhere\n$$\n\\frac{dq_{\\mathrm{tgt}}}{d\\rho} = 2A_{2}\\rho - 4A_{4}\\rho^{3} + 6A_{6}\\rho^{5}.\n$$\nA notable simplification occurs:\n$$\n2 q_{\\mathrm{tgt}}(\\rho) - \\rho\\,\\frac{dq_{\\mathrm{tgt}}}{d\\rho} = 2q_{0} + 2A_{4}\\rho^{4} - 4A_{6}\\rho^{6}.\n$$\nThus,\n$$\nj_{\\mathrm{tot}}(r) = \\frac{B_{0}}{\\mu_{0} R_{0}}\\,\\frac{2q_{0} + 2A_{4}\\rho^{4} - 4A_{6}\\rho^{6}}{\\left(q_{0} + A_{2}\\rho^{2} - A_{4}\\rho^{4} + A_{6}\\rho^{6}\\right)^{2}},\n$$\nand the auxiliary profile is\n$$\nj_{\\mathrm{cd}}(r) = \\frac{B_{0}}{\\mu_{0} R_{0}}\\,\\frac{2q_{0} + 2A_{4}\\left(\\frac{r}{a}\\right)^{4} - 4A_{6}\\left(\\frac{r}{a}\\right)^{6}}{\\left(q_{0} + A_{2}\\left(\\frac{r}{a}\\right)^{2} - A_{4}\\left(\\frac{r}{a}\\right)^{4} + A_{6}\\left(\\frac{r}{a}\\right)^{6}\\right)^{2}} - j_{0}\\left(1 - \\left(\\frac{r}{a}\\right)^{2}\\right).\n$$\n\nThis expression is in base International System of Units (SI) provided $B_{0}$ is in $\\mathrm{T}$, $R_{0}$ and $a$ in $\\mathrm{m}$, $\\mu_{0}$ in $\\mathrm{N\\,A^{-2}}$, and $j_{0}$ and $j_{\\mathrm{cd}}$ in $\\mathrm{A\\,m^{-2}}$. It explicitly shows how auxiliary current drive modifies $dq/dr$ via $j_{\\mathrm{tot}}$ and provides the closed–form driven current density needed to realize the prescribed reversed–shear $q$–profile.", "answer": "$$\\boxed{\\frac{B_{0}}{\\mu_{0} R_{0}}\\,\\frac{2q_{0} + 2A_{4}\\left(\\frac{r}{a}\\right)^{4} - 4A_{6}\\left(\\frac{r}{a}\\right)^{6}}{\\left(q_{0} + A_{2}\\left(\\frac{r}{a}\\right)^{2} - A_{4}\\left(\\frac{r}{a}\\right)^{4} + A_{6}\\left(\\frac{r}{a}\\right)^{6}\\right)^{2}} - j_{0}\\left(1 - \\left(\\frac{r}{a}\\right)^{2}\\right)}$$", "id": "3717219"}, {"introduction": "While analytical derivations provide invaluable insight, analyzing complex or experimentally-reconstructed magnetic equilibria often necessitates numerical methods. This final practice moves from analytical theory to computational application, tasking you with building a numerical scheme to calculate the rotational transform by directly tracing magnetic field lines [@problem_id:3717228]. This exercise reinforces the fundamental geometric meaning of the safety factor and introduces practical aspects of computational plasma physics, such as estimating discretization and integration errors.", "problem": "You are given an axisymmetric toroidal equilibrium with circular, concentric flux surfaces in cylindrical coordinates $(R,\\phi,Z)$. The major radius is $R_0$, and a flux surface is parameterized by the minor radius $r$ and the poloidal angle $\\theta$ through $R(\\theta) = R_0 + r \\cos\\theta$ and $Z(\\theta) = r \\sin\\theta$. The magnetic field $\\mathbf{B}$ has toroidal and poloidal components that depend on $R$ according to $B_\\phi(R) = B_0 \\, R_0/R$ and $B_\\theta(R) = B_{p0} \\, R_0/R$, where $B_0$ and $B_{p0}$ are positive constants. Throughout, angles must be treated in radians.\n\nThe rotational transform $\\iota(\\psi)$ and the safety factor $q(\\psi)$ are related by $q(\\psi) = 1/\\iota(\\psi)$. The safety factor on a flux surface can be defined via field-line following as the average toroidal angle advance per poloidal transit,\n$$\nq(\\psi) = \\frac{1}{2\\pi} \\int_0^{2\\pi} \\frac{d\\phi}{d\\theta} \\, d\\theta,\n$$\nwhere the field line obeys $d\\phi/d\\theta = (\\mathbf{B}\\cdot\\nabla\\phi)/(\\mathbf{B}\\cdot\\nabla\\theta)$ on the flux surface. Assume the following instantaneous mapping with a small, periodic ripple included to mimic metric nonuniformity or weak non-axisymmetric effects:\n$$\n\\frac{d\\phi}{d\\theta} = \\left(\\frac{\\mathbf{B}\\cdot\\nabla\\phi}{\\mathbf{B}\\cdot\\nabla\\theta}\\right) + \\varepsilon \\sin(n \\theta),\n$$\nwhere $\\varepsilon$ is a small dimensionless amplitude and $n$ is a positive integer. The magnetic shear is defined as\n$$\ns(r) = \\frac{r}{q(r)} \\frac{dq}{dr}.\n$$\n\nStarting from the fundamental definitions of a field line ($d\\mathbf{x}/ds \\parallel \\mathbf{B}$) and coordinate gradients in cylindrical coordinates, construct a numerical scheme that:\n- Computes a numerical estimate of $q(r)$ on a given flux surface by integrating $d\\phi/d\\theta$ over a finite poloidal angle length using a uniform discretization in $\\theta$,\n- Computes the rotational transform $\\iota(r) = 1/q(r)$,\n- Estimates the error introduced by finite integration length (using a non-integer multiple of $2\\pi$ in the integration extent) and by discretization (comparing two step sizes),\n- Computes the magnetic shear $s(r)$ via a central finite difference in $r$, and compares it to the analytic shear for this equilibrium (which you should derive in your solution),\n- Aggregates the numerical outputs for a set of test cases.\n\nYour numerical integration must use a uniform partition of the poloidal angle $\\theta$ over the chosen length $L_\\theta = 2\\pi N_{\\mathrm{turns}}$ with $N_{\\mathrm{steps}}$ subintervals. Use the midpoint rule to approximate the integral,\n$$\n\\int_0^{L_\\theta} f(\\theta)\\,d\\theta \\approx \\sum_{k=0}^{N_{\\mathrm{steps}}-1} f\\!\\left(\\theta_k + \\frac{\\Delta\\theta}{2}\\right)\\Delta\\theta,\\quad \\Delta\\theta = \\frac{L_\\theta}{N_{\\mathrm{steps}}},\n$$\nwhere $f(\\theta) = d\\phi/d\\theta$. The instantaneous ratio must be computed from the given $\\mathbf{B}$ and the coordinate gradients on the specified flux surface. The ripple term $\\varepsilon \\sin(n \\theta)$ is to be added directly to $d\\phi/d\\theta$.\n\nDefine the following error estimates:\n- Discretization error at integer $N_{\\mathrm{turns}}$: $e_{\\mathrm{disc}} = \\left| q_{\\mathrm{fine}} - q_{\\mathrm{coarse}} \\right|$, where $q_{\\mathrm{fine}}$ and $q_{\\mathrm{coarse}}$ are computed with the same $N_{\\mathrm{turns}}$ but different $N_{\\mathrm{steps}}$.\n- Finite-length error at fine resolution: $e_{\\mathrm{len}} = \\left| q_{\\mathrm{int}} - q_{\\mathrm{nonint}} \\right|$, where $q_{\\mathrm{int}}$ uses an integer $N_{\\mathrm{turns}}$ and $q_{\\mathrm{nonint}}$ uses a non-integer $N_{\\mathrm{turns}}$.\n\nCompute the magnetic shear numerically via a central difference using a small perturbation $\\delta r$:\n$$\ns_{\\mathrm{num}}(r) = \\frac{r}{q(r)} \\cdot \\frac{q(r+\\delta r) - q(r-\\delta r)}{2\\delta r}.\n$$\nAlso compute the analytic shear $s_{\\mathrm{an}}(r)$ for the specified equilibrium and report the absolute shear error $|s_{\\mathrm{num}}(r) - s_{\\mathrm{an}}(r)|$.\n\nDesign your program to evaluate the following three test cases. For all cases, use $B_0 = 5.0$, $B_{p0} = 1.0$, $R_0 = 3.0$. Use radians for all angles. Use $\\delta r = 0.01$.\n\n- Case A (happy path): $r = 0.5$, $\\varepsilon = 0.02$, $n = 3$, $N_{\\mathrm{steps,coarse}} = 256$, $N_{\\mathrm{steps,fine}} = 4096$, $N_{\\mathrm{turns,int}} = 1.0$, $N_{\\mathrm{turns,nonint}} = 1.5$.\n- Case B (near-axis boundary): $r = 0.05$, $\\varepsilon = 0.02$, $n = 3$, $N_{\\mathrm{steps,coarse}} = 256$, $N_{\\mathrm{steps,fine}} = 4096$, $N_{\\mathrm{turns,int}} = 1.0$, $N_{\\mathrm{turns,nonint}} = 1.5$.\n- Case C (strong poloidal variation edge case): $r = 2.5$, $\\varepsilon = 0.05$, $n = 5$, $N_{\\mathrm{steps,coarse}} = 256$, $N_{\\mathrm{steps,fine}} = 8192$, $N_{\\mathrm{turns,int}} = 1.0$, $N_{\\mathrm{turns,nonint}} = 1.5$.\n\nYour program must produce, for each case, a list of six floats:\n1. $q_{\\mathrm{int,fine}}$,\n2. $\\iota_{\\mathrm{int,fine}}$,\n3. $e_{\\mathrm{len}}$,\n4. $e_{\\mathrm{disc}}$,\n5. $s_{\\mathrm{num}}$,\n6. $\\left| s_{\\mathrm{num}} - s_{\\mathrm{an}} \\right|$.\n\nFinal Output Format: Your program should produce a single line of output containing the results as a comma-separated list of the three case results, each case result itself being a comma-separated list enclosed in square brackets. For example, a valid output format is\n$$\n[\\,[q_1,\\iota_1,e_{\\mathrm{len},1},e_{\\mathrm{disc},1},s_{\\mathrm{num},1},e_{s,1}],[q_2,\\iota_2,e_{\\mathrm{len},2},e_{\\mathrm{disc},2},s_{\\mathrm{num},2},e_{s,2}],[q_3,\\iota_3,e_{\\mathrm{len},3},e_{\\mathrm{disc},3},s_{\\mathrm{num},3},e_{s,3}]\\,].\n$$\nNo additional text should be printed. All quantities are dimensionless numbers, and angles must be in radians.", "solution": "The problem is assessed to be valid as it is scientifically grounded in a standard simplified model of tokamak physics, is well-posed with all necessary information provided, and is formulated objectively. The problem is free from the specified invalidity criteria. We may therefore proceed with a solution.\n\nThe solution requires a combination of analytical derivations and numerical implementation. First, we derive the necessary analytical expressions for the safety factor $q(r)$ and magnetic shear $s(r)$ for the idealized equilibrium. Second, we detail the numerical scheme to compute $q(r)$, $\\iota(r)$, $s(r)$, and associated error metrics based on the provided problem statement.\n\n### 1. Derivation of the Field Line Equation\n\nThe safety factor $q$ is defined in terms of an integral over the quantity $d\\phi/d\\theta$, which describes the rate of change of the toroidal angle $\\phi$ with respect to the poloidal angle $\\theta$ as one follows a magnetic field line. The problem provides the relation:\n$$\n\\frac{d\\phi}{d\\theta} = \\frac{\\mathbf{B}\\cdot\\nabla\\phi}{\\mathbf{B}\\cdot\\nabla\\theta}\n$$\nWe must evaluate the terms in this expression using the provided cylindrical coordinates $(R, \\phi, Z)$ and the toroidal coordinate system $(r, \\theta, \\phi)$ defined by $R = R_0 + r \\cos\\theta$ and $Z = r \\sin\\theta$.\n\nThe magnetic field $\\mathbf{B}$ is given by its toroidal and poloidal components. The toroidal component is $B_\\phi \\hat{\\phi}$. The poloidal component $\\mathbf{B}_p$ lies in the $(R,Z)$ plane and is tangent to the circular flux surfaces (constant $r$). The unit vector in the poloidal direction $\\hat{\\mathbf{e}}_\\theta$ is obtained by normalizing the tangent vector $\\partial\\mathbf{x}/\\partial\\theta = (-r\\sin\\theta)\\hat{\\mathbf{R}} + (r\\cos\\theta)\\hat{\\mathbf{Z}}$, which gives $\\hat{\\mathbf{e}}_\\theta = -\\sin\\theta \\hat{\\mathbf{R}} + \\cos\\theta \\hat{\\mathbf{Z}}$. The magnitude of the poloidal field is given as $B_\\theta(R) = B_{p0} R_0/R$. Thus, the magnetic field vector is:\n$$\n\\mathbf{B} = B_\\theta(R) \\hat{\\mathbf{e}}_\\theta + B_\\phi(R) \\hat{\\phi} = B_\\theta(R)(-\\sin\\theta \\hat{\\mathbf{R}} + \\cos\\theta \\hat{\\mathbf{Z}}) + B_\\phi(R) \\hat{\\phi}\n$$\n\nThe gradients of the angular coordinates $\\phi$ and $\\theta$ in cylindrical coordinates are:\n$$\n\\nabla\\phi = \\frac{1}{R}\\hat{\\phi}\n$$\nTo find $\\nabla\\theta$, we use the relation $\\theta = \\arctan(Z / (R-R_0))$:\n$$\n\\nabla\\theta = \\frac{\\partial\\theta}{\\partial R}\\hat{\\mathbf{R}} + \\frac{1}{R}\\frac{\\partial\\theta}{\\partial\\phi}\\hat{\\phi} + \\frac{\\partial\\theta}{\\partial Z}\\hat{\\mathbf{Z}} = -\\frac{Z}{(R-R_0)^2+Z^2}\\hat{\\mathbf{R}} + 0 \\cdot \\hat{\\phi} + \\frac{R-R_0}{(R-R_0)^2+Z^2}\\hat{\\mathbf{Z}}\n$$\nRecognizing that $r^2 = (R-R_0)^2+Z^2$, $Z=r\\sin\\theta$, and $R-R_0=r\\cos\\theta$:\n$$\n\\nabla\\theta = -\\frac{r\\sin\\theta}{r^2}\\hat{\\mathbf{R}} + \\frac{r\\cos\\theta}{r^2}\\hat{\\mathbf{Z}} = \\frac{1}{r}(-\\sin\\theta \\hat{\\mathbf{R}} + \\cos\\theta \\hat{\\mathbf{Z}}) = \\frac{1}{r}\\hat{\\mathbf{e}}_\\theta\n$$\n\nNow we compute the dot products:\n$$\n\\mathbf{B}\\cdot\\nabla\\phi = (B_\\phi(R)\\hat{\\phi}) \\cdot (\\frac{1}{R}\\hat{\\phi}) = \\frac{B_\\phi(R)}{R}\n$$\n$$\n\\mathbf{B}\\cdot\\nabla\\theta = (B_\\theta(R)\\hat{\\mathbf{e}}_\\theta + B_\\phi(R)\\hat{\\phi}) \\cdot (\\frac{1}{r}\\hat{\\mathbf{e}}_\\theta) = \\frac{B_\\theta(R)}{r}\n$$\nThe ratio becomes:\n$$\n\\frac{\\mathbf{B}\\cdot\\nabla\\phi}{\\mathbf{B}\\cdot\\nabla\\theta} = \\frac{B_\\phi(R)/R}{B_\\theta(R)/r} = \\frac{r B_\\phi(R)}{R B_\\theta(R)}\n$$\nSubstituting the given field dependencies, $B_\\phi(R) = B_0 R_0/R$ and $B_\\theta(R) = B_{p0} R_0/R$:\n$$\n\\frac{\\mathbf{B}\\cdot\\nabla\\phi}{\\mathbf{B}\\cdot\\nabla\\theta} = \\frac{r (B_0 R_0/R)}{R (B_{p0} R_0/R)} = \\frac{r B_0}{R B_{p0}}\n$$\nWith $R = R_0 + r \\cos\\theta$, the final expression for the full field-line mapping, including the ripple term, is:\n$$\n\\frac{d\\phi}{d\\theta} = \\frac{r B_0}{B_{p0}(R_0 + r \\cos\\theta)} + \\varepsilon \\sin(n \\theta)\n$$\nThis function of $\\theta$ is the integrand for the safety factor calculation.\n\n### 2. Analytic Safety Factor and Magnetic Shear (Ideal Case)\n\nFor comparison, we derive the analytic safety factor $q_{\\mathrm{an}}(r)$ and magnetic shear $s_{\\mathrm{an}}(r)$ for the ideal equilibrium (i.e., with $\\varepsilon=0$).\nThe safety factor is defined as:\n$$\nq(r) = \\frac{1}{2\\pi} \\int_0^{2\\pi} \\left(\\frac{d\\phi}{d\\theta}\\right)_{\\mathrm{ideal}} d\\theta = \\frac{1}{2\\pi} \\int_0^{2\\pi} \\frac{r B_0}{B_{p0}(R_0 + r \\cos\\theta)} d\\theta\n$$\n$$\nq_{\\mathrm{an}}(r) = \\frac{r B_0}{2\\pi B_{p0}} \\int_0^{2\\pi} \\frac{d\\theta}{R_0 + r \\cos\\theta}\n$$\nThis is a standard definite integral, which evaluates to $\\frac{2\\pi}{\\sqrt{R_0^2 - r^2}}$ for $R_0 > r$.\n$$\nq_{\\mathrm{an}}(r) = \\frac{r B_0}{2\\pi B_{p0}} \\cdot \\frac{2\\pi}{\\sqrt{R_0^2 - r^2}} = \\frac{r B_0}{B_{p0}\\sqrt{R_0^2 - r^2}}\n$$\nThe magnetic shear is defined as $s(r) = \\frac{r}{q(r)} \\frac{dq}{dr}$. We first compute $\\frac{dq}{dr}$:\n$$\n\\frac{dq_{\\mathrm{an}}}{dr} = \\frac{B_0}{B_{p0}} \\frac{d}{dr} \\left( \\frac{r}{\\sqrt{R_0^2 - r^2}} \\right) = \\frac{B_0}{B_{p0}} \\left[ \\frac{1}{\\sqrt{R_0^2 - r^2}} - \\frac{r(-\\frac{1}{2})(R_0^2-r^2)^{-3/2}(-2r)}{R_0^2-r^2} \\right]\n$$\n$$\n\\frac{dq_{\\mathrm{an}}}{dr} = \\frac{B_0}{B_{p0}} \\left[ \\frac{R_0^2 - r^2 + r^2}{(R_0^2 - r^2)^{3/2}} \\right] = \\frac{B_0}{B_{p0}} \\frac{R_0^2}{(R_0^2 - r^2)^{3/2}}\n$$\nNow, constructing the shear $s_{\\mathrm{an}}(r)$:\n$$\ns_{\\mathrm{an}}(r) = \\frac{r}{q_{\\mathrm{an}}(r)} \\frac{dq_{\\mathrm{an}}}{dr} = \\frac{r}{\\frac{r B_0}{B_{p0}\\sqrt{R_0^2 - r^2}}} \\left( \\frac{B_0}{B_{p0}} \\frac{R_0^2}{(R_0^2 - r^2)^{3/2}} \\right)\n$$\n$$\ns_{\\mathrm{an}}(r) = \\frac{B_{p0}\\sqrt{R_0^2 - r^2}}{B_0} \\cdot \\frac{B_0 R_0^2}{B_{p0}(R_0^2 - r^2)^{3/2}} = \\frac{R_0^2}{R_0^2 - r^2}\n$$\nThis simple expression for $s_{\\mathrm{an}}(r)$ provides the benchmark for our numerical calculation.\n\n### 3. Numerical Scheme\n\nThe problem specifies the use of the midpoint rule for numerical integration. The safety factor $q$ is the average toroidal advance per poloidal transit. For an integration over a total poloidal angle of $L_\\theta = 2\\pi N_{\\mathrm{turns}}$, the average value of $d\\phi/d\\theta$ gives $q$.\n$$\nq \\approx \\frac{1}{L_\\theta} \\int_0^{L_\\theta} \\frac{d\\phi}{d\\theta} d\\theta \\approx \\frac{1}{L_\\theta} \\sum_{k=0}^{N_{\\mathrm{steps}}-1} f(\\theta_k^{\\mathrm{mid}}) \\Delta\\theta\n$$\nwhere $f(\\theta) = d\\phi/d\\theta$, $\\Delta\\theta = L_\\theta / N_{\\mathrm{steps}}$, and $\\theta_k^{\\mathrm{mid}} = (k+0.5)\\Delta\\theta$. This simplifies to the mean of the function values at the midpoints:\n$$\nq \\approx \\frac{1}{N_{\\mathrm{steps}}} \\sum_{k=0}^{N_{\\mathrm{steps}}-1} f(\\theta_k^{\\mathrm{mid}})\n$$\nA function `compute_q(r, params)` will implement this calculation.\n\nThe required outputs are computed as follows for each test case:\n1.  $q_{\\mathrm{int,fine}}$: Calculated using `compute_q` with the fine step count $N_{\\mathrm{steps,fine}}$ and integer number of turns $N_{\\mathrm{turns,int}}$.\n2.  $\\iota_{\\mathrm{int,fine}}$: The rotational transform, simply $1/q_{\\mathrm{int,fine}}$.\n3.  $e_{\\mathrm{len}}$: The finite-length error is $|q_{\\mathrm{int,fine}} - q_{\\mathrm{nonint,fine}}|$. $q_{\\mathrm{nonint,fine}}$ is computed using the non-integer turns $N_{\\mathrm{turns,nonint}}$ at the fine resolution. This error arises primarily from the non-zero average of the ripple term $\\varepsilon\\sin(n\\theta)$ over a non-integer number of $2\\pi$ intervals.\n4.  $e_{\\mathrm{disc}}$: The discretization error is $|q_{\\mathrm{int,fine}} - q_{\\mathrm{int,coarse}}|$. $q_{\\mathrm{int,coarse}}$ is computed using the coarse step count $N_{\\mathrm{steps,coarse}}$ and integer turns. This error reflects the accuracy of the midpoint rule integrator.\n5.  $s_{\\mathrm{num}}$: The numerical shear is computed using a central finite difference. This requires computing $q$ at $r+\\delta r$ and $r-\\delta r$. To maximize accuracy, these $q$ values are computed using the high-fidelity parameters ($N_{\\mathrm{steps,fine}}$, $N_{\\mathrm{turns,int}}$). The ripple term $\\varepsilon \\sin(n\\theta)$ averages to nearly zero over an integer number of turns, so the computed $q$ values are predominantly determined by the ideal equilibrium structure.\n    $$\n    s_{\\mathrm{num}}(r) = \\frac{r}{q_{\\mathrm{int,fine}}(r)} \\frac{q_{\\mathrm{int,fine}}(r+\\delta r) - q_{\\mathrm{int,fine}}(r-\\delta r)}{2\\delta r}\n    $$\n6.  $|s_{\\mathrm{num}} - s_{\\mathrm{an}}|$: The absolute difference between the numerically computed shear and the analytically derived shear $s_{\\mathrm{an}}(r) = R_0^2 / (R_0^2 - r^2)$. This gauges the accuracy of the numerical differentiation and the underlying $q$ computation. Note that while $s_{\\mathrm{an}}$ is derived for $\\varepsilon=0$, $s_{\\mathrm{num}}$ is computed with the ripple term present. However, since the $q$ values for the finite difference use integer turns, the ripple's effect is minimal, making the comparison meaningful.\n\nThe implementation will consist of a main function that iterates through the test cases, calling a helper function for the $q$ calculation with appropriate parameters, and then computes and stores the six required quantities for each case. The final output will be formatted as a list of lists.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for all test cases.\n    \"\"\"\n    \n    # Global constants for all test cases\n    B0 = 5.0\n    Bp0 = 1.0\n    R0 = 3.0\n    delta_r = 0.01\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case A: happy path\n        {'r': 0.5, 'eps': 0.02, 'n': 3, 'N_steps_coarse': 256, 'N_steps_fine': 4096, 'N_turns_int': 1.0, 'N_turns_nonint': 1.5},\n        # Case B: near-axis boundary\n        {'r': 0.05, 'eps': 0.02, 'n': 3, 'N_steps_coarse': 256, 'N_steps_fine': 4096, 'N_turns_int': 1.0, 'N_turns_nonint': 1.5},\n        # Case C: strong poloidal variation edge case\n        {'r': 2.5, 'eps': 0.05, 'n': 5, 'N_steps_coarse': 256, 'N_steps_fine': 8192, 'N_turns_int': 1.0, 'N_turns_nonint': 1.5},\n    ]\n\n    all_results = []\n    \n    for case in test_cases:\n        r = case['r']\n        eps = case['eps']\n        n = case['n']\n        N_steps_coarse = case['N_steps_coarse']\n        N_steps_fine = case['N_steps_fine']\n        N_turns_int = case['N_turns_int']\n        N_turns_nonint = case['N_turns_nonint']\n\n        # 1. Compute q_int_fine and iota_int_fine\n        q_int_fine = compute_q(r, B0, Bp0, R0, eps, n, N_turns_int, N_steps_fine)\n        iota_int_fine = 1.0 / q_int_fine\n\n        # 2. Compute finite-length error e_len\n        q_nonint_fine = compute_q(r, B0, Bp0, R0, eps, n, N_turns_nonint, N_steps_fine)\n        e_len = abs(q_int_fine - q_nonint_fine)\n\n        # 3. Compute discretization error e_disc\n        q_int_coarse = compute_q(r, B0, Bp0, R0, eps, n, N_turns_int, N_steps_coarse)\n        e_disc = abs(q_int_fine - q_int_coarse)\n\n        # 4. Compute numerical shear s_num\n        q_plus = compute_q(r + delta_r, B0, Bp0, R0, eps, n, N_turns_int, N_steps_fine)\n        q_minus = compute_q(r - delta_r, B0, Bp0, R0, eps, n, N_turns_int, N_steps_fine)\n        dq_dr_num = (q_plus - q_minus) / (2.0 * delta_r)\n        s_num = (r / q_int_fine) * dq_dr_num\n        \n        # 5. Compute analytic shear s_an and shear error\n        s_an = R0**2 / (R0**2 - r**2)\n        shear_error = abs(s_num - s_an)\n        \n        # 6. Aggregate results for the current case\n        case_results = [\n            q_int_fine,\n            iota_int_fine,\n            e_len,\n            e_disc,\n            s_num,\n            shear_error,\n        ]\n        all_results.append(case_results)\n\n    # Format the final output as a string.\n    # e.g. [[1.0,2.0],[3.0,4.0]]\n    result_str = \",\".join([f\"[{','.join(map(str, res))}]\" for res in all_results])\n    print(f\"[{result_str}]\")\n\ndef compute_q(r, B0, Bp0, R0, eps, n, N_turns, N_steps):\n    \"\"\"\n    Computes the safety factor q using the midpoint rule for integration.\n\n    Args:\n        r (float): Minor radius of the flux surface.\n        B0 (float): Magnetic field constant (toroidal).\n        Bp0 (float): Magnetic field constant (poloidal).\n        R0 (float): Major radius.\n        eps (float): Ripple amplitude.\n        n (int): Ripple mode number.\n        N_turns (float): Number of poloidal turns for integration.\n        N_steps (int): Number of steps for numerical integration.\n\n    Returns:\n        float: The numerically calculated safety factor q.\n    \"\"\"\n    if r = 0 or r >= R0:\n        # Handle cases outside the valid domain to prevent division by zero or other errors\n        # Note: r=0 is a singularity for some definitions, and r>=R0 is unphysical\n        # This problem's cases are well-behaved.\n        return float('nan')\n        \n    L_theta = 2.0 * np.pi * N_turns\n    delta_theta = L_theta / N_steps\n\n    # Midpoint theta values for integration\n    theta_midpoints = (np.arange(N_steps) + 0.5) * delta_theta\n\n    # Calculate the integrand d(phi)/d(theta) at each midpoint\n    R_vals = R0 + r * np.cos(theta_midpoints)\n    \n    # Ideal part of d(phi)/d(theta)\n    dphi_dtheta_ideal = (r * B0) / (Bp0 * R_vals)\n    \n    # Ripple part\n    dphi_dtheta_ripple = eps * np.sin(n * theta_midpoints)\n    \n    # Total integrand\n    integrand_values = dphi_dtheta_ideal + dphi_dtheta_ripple\n\n    # q is the average value of the integrand over the integration interval\n    q_val = np.mean(integrand_values)\n    \n    return q_val\n\n# Execute the main function\nsolve()\n```", "id": "3717228"}]}