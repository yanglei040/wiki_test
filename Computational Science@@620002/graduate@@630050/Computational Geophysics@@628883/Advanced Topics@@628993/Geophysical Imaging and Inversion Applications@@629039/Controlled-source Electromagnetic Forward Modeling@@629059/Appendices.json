{"hands_on_practices": [{"introduction": "This first practice exercise grounds our study in the fundamental physics of electromagnetic wave propagation in conductive media. By starting from Maxwell's equations, you will derive the characteristic length scale of attenuation, known as the skin depth, and see how this single parameter governs the behavior of diffusive EM fields. This exercise builds a crucial intuition for survey design by connecting theoretical principles directly to a practical calculation of source frequency based on a target exploration depth.", "problem": "Consider a controlled-source electromagnetic (CSEM) forward-modeling setting in a homogeneous, isotropic, electrically conducting medium characterized by magnetic permeability $\\mu$ and electrical conductivity $\\sigma$. Assume time-harmonic sources with angular frequency $\\omega$, negligible displacement current, and no free charges in the region of interest away from the source. Starting from Maxwell’s equations and standard constitutive relations, formulate the governing equation for the electric field $\\mathbf{E}$ in this conduction-dominated regime. From this base, restrict attention to a one-dimensional vertical variation and deduce the form of the depth-dependent solution. Introduce a rescaled depth variable $\\zeta = z / \\ell$ and choose the length scale $\\ell$ so that the canonical plane-wave solution in the rescaled coordinate has the normalized form $E(\\zeta) = E_{0} \\exp\\!\\big(-(1+i)\\,\\zeta\\big)$, where $E_{0}$ is a constant amplitude and $i$ is the imaginary unit. Derive $\\ell$ explicitly as a function of $\\omega$, $\\mu$, and $\\sigma$.\n\nFinally, use this diffusive scaling length to design a survey: for seawater with conductivity $\\sigma = 0.5\\,\\mathrm{S/m}$ and permeability $\\mu = \\mu_{0} = 4\\pi \\times 10^{-7}\\,\\mathrm{H/m}$, choose the source frequency such that the non-dimensional horizontal source–receiver offset $L/\\ell$ equals $10$ for a physical offset $L = 7.5\\,\\mathrm{km}$. Compute the corresponding frequency $f$ in Hertz. Round your answer to three significant figures.", "solution": "First, we derive the governing equation for the electric field $\\mathbf{E}$. We start with the time-harmonic forms of Faraday's Law and Ampère's Law in a source-free region under the quasi-static (conduction-dominated) approximation:\n$$ \\nabla \\times \\mathbf{E} = -i\\omega\\mu\\mathbf{H} $$\n$$ \\nabla \\times \\mathbf{H} = \\sigma\\mathbf{E} $$\nTaking the curl of the first equation and substituting the second gives:\n$$ \\nabla \\times (\\nabla \\times \\mathbf{E}) = -i\\omega\\mu(\\nabla \\times \\mathbf{H}) = -i\\omega\\mu(\\sigma\\mathbf{E}) $$\nUsing the vector identity $\\nabla \\times (\\nabla \\times \\mathbf{E}) = \\nabla(\\nabla \\cdot \\mathbf{E}) - \\nabla^2\\mathbf{E}$ and the fact that $\\nabla \\cdot \\mathbf{E} = 0$ in a homogeneous source-free region, we arrive at the vector diffusion equation:\n$$ \\nabla^2\\mathbf{E} = i\\omega\\mu\\sigma\\mathbf{E} $$\n\nNext, we consider a one-dimensional plane wave propagating in the $z$-direction. The equation reduces to a scalar ODE for a field component, say $E_x(z)$:\n$$ \\frac{d^2E_x}{dz^2} - (i\\omega\\mu\\sigma)E_x = 0 $$\nThe general solution is $E_x(z) = A \\exp(kz) + B \\exp(-kz)$, where $k^2 = i\\omega\\mu\\sigma$. We choose the physically attenuating solution, so $A=0$. We evaluate $k$:\n$$ k = \\sqrt{i\\omega\\mu\\sigma} = \\sqrt{i}\\sqrt{\\omega\\mu\\sigma} = \\frac{1+i}{\\sqrt{2}}\\sqrt{\\omega\\mu\\sigma} = (1+i)\\sqrt{\\frac{\\omega\\mu\\sigma}{2}} $$\nThe solution is thus $E_x(z) = E_0 \\exp\\left(-(1+i)\\sqrt{\\frac{\\omega\\mu\\sigma}{2}}z\\right)$.\n\nWe are asked to find the length scale $\\ell$ such that this solution matches the form $E(\\zeta) = E_0 \\exp(-(1+i)\\zeta)$ with $\\zeta = z/\\ell$. Substituting $\\zeta$ into this form gives $E(z) = E_0 \\exp(-(1+i)z/\\ell)$. Comparing the exponents of the two solution forms, we can equate the coefficients of $z$:\n$$ \\frac{1}{\\ell} = \\sqrt{\\frac{\\omega\\mu\\sigma}{2}} $$\nSolving for $\\ell$ gives the skin depth:\n$$ \\ell = \\sqrt{\\frac{2}{\\omega\\mu\\sigma}} $$\n\nFinally, we use this relationship for the survey design. We are given the target non-dimensional offset $L/\\ell=10$ for a physical offset $L=7.5\\,\\text{km} = 7500\\,\\text{m}$. This allows us to determine the required skin depth $\\ell$:\n$$ \\ell = \\frac{L}{10} = \\frac{7500\\,\\text{m}}{10} = 750\\,\\text{m} $$\nNow we solve for the frequency $f$. Rearranging the formula for $\\ell$ to solve for the angular frequency $\\omega$:\n$$ \\ell^2 = \\frac{2}{\\omega\\mu\\sigma} \\implies \\omega = \\frac{2}{\\ell^2\\mu\\sigma} $$\nSince $\\omega = 2\\pi f$, the frequency $f$ is:\n$$ f = \\frac{\\omega}{2\\pi} = \\frac{1}{2\\pi} \\left( \\frac{2}{\\ell^2\\mu\\sigma} \\right) = \\frac{1}{\\pi\\ell^2\\mu\\sigma} $$\nSubstituting the numerical values $\\ell=750\\,\\text{m}$, $\\sigma = 0.5\\,\\mathrm{S/m}$, and $\\mu = \\mu_0 = 4\\pi \\times 10^{-7}\\,\\mathrm{H/m}$:\n$$ f = \\frac{1}{\\pi(750)^2(4\\pi \\times 10^{-7})(0.5)} = \\frac{1}{\\pi(562500)(2\\pi \\times 10^{-7})} = \\frac{1}{1.11033\\dots} \\approx 0.90063\\,\\text{Hz} $$\nRounding to three significant figures, the required frequency is $0.901\\,\\text{Hz}$.", "answer": "$$ \\boxed{0.901} $$", "id": "3582341"}, {"introduction": "Having established the concept of diffusive scaling, we now move from a uniform medium to a more realistic one-dimensional layered Earth model, a cornerstone of geophysical inversion. This coding exercise will guide you through the implementation of a 1D forward solver using the powerful Transverse Electric (TE) and Transverse Magnetic (TM) mode decomposition. You will develop a recursive algorithm based on modal admittances, providing a hands-on understanding of how the subsurface layering is encoded in the surface-measured reflection response.", "problem": "You are to implement a computational geophysics routine for controlled-source electromagnetic forward modeling in a one-dimensional layered Earth using Transverse Electric (TE) and Transverse Magnetic (TM) mode decomposition. The derivation must begin with Maxwell’s equations in the frequency domain under the phasor convention $e^{i \\omega t}$, the constitutive relations, and boundary conditions at planar interfaces. A one-dimensional layered Earth is invariant in the horizontal directions, so the fields induced by a controlled source can be decomposed into plane waves characterized by horizontal wavenumber $k_r$ and separated into TE and TM polarizations. Each polarization admits a layer-recursive representation through modal admittances that encodes the boundary conditions.\n\nYour task is to write a program that, for each specified test case, computes the TE and TM reflection coefficients at the air-Earth interface in the wavenumber domain for a set of horizontal wavenumbers $k_r$. The reflection coefficient is defined as the ratio of the reflected to incident wave amplitudes for each mode and should be computed through a physically consistent recursion of input admittances from the basement half-space upward through the finite layers to the surface. Your implementation must respect complex-valued propagation in conductive and dielectric media and handle evanescent and propagating regimes via the vertical propagation constant.\n\nUse the following physical constants: $ \\mu_0 = 4 \\pi \\times 10^{-7} \\text{ H/m}$, $ \\epsilon_0 = 8.854187817 \\times 10^{-12} \\text{ F/m}$, and angular frequency $ \\omega = 2 \\pi f$ for frequency $ f$ in $\\text{Hz}$. For each layer $n$, with thickness $d_n$ (in $\\text{m}$), conductivity $\\sigma_n$ (in $\\text{S/m}$), relative permittivity $\\epsilon_{r,n}$ (dimensionless), and relative permeability $\\mu_{r,n}$ (dimensionless, here take $\\mu_{r,n} = 1$ for all layers), define $ \\mu_n = \\mu_0 \\mu_{r,n}$ and $ \\epsilon_n = \\epsilon_0 \\epsilon_{r,n}$. The basement half-space has properties $ \\sigma_b$, $ \\epsilon_{r,b}$, and $ \\mu_{r,b} = 1$. Air is the top half-space with $ \\sigma_{\\text{air}} = 0$, $ \\epsilon_{\\text{air}} = \\epsilon_0$, and $ \\mu_{\\text{air}} = \\mu_0$.\n\nStarting from the fundamental relations, derive the vertical propagation constant $ \\gamma_n$ in each layer as a function of $k_r$, $ \\omega$, $ \\mu_n$, $ \\epsilon_n$, and $ \\sigma_n$, and then establish the TE and TM characteristic admittances $ Y_n^{\\mathrm{TE}}$ and $ Y_n^{\\mathrm{TM}}$. Use these to recursively compute the input admittances $ Y_{\\text{in}}^{\\mathrm{TE}}$ and $ Y_{\\text{in}}^{\\mathrm{TM}}$ seen at the top of the layered stack from the basement up. Finally, compute the reflection coefficients $ R^{\\mathrm{TE}}(k_r)$ and $ R^{\\mathrm{TM}}(k_r)$ at the air-Earth interface. You must output the magnitudes $ |R^{\\mathrm{TE}}(k_r)|$ and $ |R^{\\mathrm{TM}}(k_r)|$ (dimensionless) for each $k_r$ in each test case. No other physical quantity is to be output.\n\nImplement the program in $ \\text{Python}$, version $ 3.12$. This numerical task requires libraries for complex-number arithmetic and array manipulation, such as `numpy`. Your program must run without user input. The final output must be a single line containing a comma-separated list enclosed in square brackets of all requested magnitudes across all test cases, in the exact order defined below.\n\nTest Suite:\n- Test Case $1$ (happy path):\n  - Frequency $ f = 1000$ $\\text{Hz}$.\n  - Finite layers: one layer with thickness $ d_1 = 100$ $\\text{m}$, conductivity $ \\sigma_1 = 0.01$ $\\text{S/m}$, relative permittivity $ \\epsilon_{r,1} = 10$.\n  - Basement: conductivity $ \\sigma_b = 1.0$ $\\text{S/m}$, relative permittivity $ \\epsilon_{r,b} = 10$.\n  - Horizontal wavenumbers: $ k_r \\in \\{0.0, 10.0, 100.0\\}$ $\\text{m}^{-1}$.\n- Test Case $2$ (low-frequency and resistive basement edge case):\n  - Frequency $ f = 1$ $\\text{Hz}$.\n  - Finite layers: two layers: layer $1$ with $ d_1 = 50$ $\\text{m}$, $ \\sigma_1 = 0.1$ $\\text{S/m}$, $ \\epsilon_{r,1} = 4$; layer $2$ with $ d_2 = 200$ $\\text{m}$, $ \\sigma_2 = 0.01$ $\\text{S/m}$, $ \\epsilon_{r,2} = 6$.\n  - Basement: conductivity $ \\sigma_b = 0.001$ $\\text{S/m}$, relative permittivity $ \\epsilon_{r,b} = 10$.\n  - Horizontal wavenumbers: $ k_r \\in \\{0.0, 1.0, 5.0\\}$ $\\text{m}^{-1}$.\n- Test Case $3$ (high-frequency thin-layer edge case):\n  - Frequency $ f = 100000$ $\\text{Hz}$.\n  - Finite layers: one layer with thickness $ d_1 = 1$ $\\text{m}$, conductivity $ \\sigma_1 = 0.5$ $\\text{S/m}$, relative permittivity $ \\epsilon_{r,1} = 20$.\n  - Basement: conductivity $ \\sigma_b = 0.1$ $\\text{S/m}$, relative permittivity $ \\epsilon_{r,b} = 15$.\n  - Horizontal wavenumbers: $ k_r \\in \\{0.0, 100.0, 1000.0\\}$ $\\text{m}^{-1}$.\n\nFinal Output Specification:\n- For each test case, and for each $k_r$ listed in that test case in the order provided, compute the pair $ \\left(|R^{\\mathrm{TE}}(k_r)|, |R^{\\mathrm{TM}}(k_r)|\\right)$.\n- Aggregate all results in order by concatenating the pairs across all $k_r$ and all test cases into a single list.\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. For example, the format must be exactly as follows: $ [r_1, r_2, r_3, \\dots]$, where each $ r_j$ is a floating-point number corresponding to a magnitude $ |R^{\\mathrm{TE}}|$ or $ |R^{\\mathrm{TM}}|$ in the specified order.", "solution": "The theoretical foundation for controlled-source electromagnetic forward modeling is Maxwell's equations. Assuming a time-harmonic dependency of the form $e^{i \\omega t}$, where $\\omega$ is the angular frequency, Maxwell's equations in the frequency domain for a source-free region are:\n$$ \\nabla \\times \\mathbf{E} = -i \\omega \\mathbf{B} $$\n$$ \\nabla \\times \\mathbf{H} = \\mathbf{J} + i \\omega \\mathbf{D} $$\nFor a linear, isotropic, and homogeneous medium, the constitutive relations are $\\mathbf{D} = \\epsilon \\mathbf{E}$, $\\mathbf{B} = \\mu \\mathbf{H}$, and $\\mathbf{J} = \\sigma \\mathbf{E}$, where $\\epsilon$ is the electric permittivity, $\\mu$ is the magnetic permeability, and $\\sigma$ is the electrical conductivity. Substituting these into Maxwell's equations yields:\n$$ \\nabla \\times \\mathbf{E} = -i \\omega \\mu \\mathbf{H} $$\n$$ \\nabla \\times \\mathbf{H} = (\\sigma + i \\omega \\epsilon) \\mathbf{E} $$\nTaking the curl of the first equation and substituting the second gives the vector Helmholtz equation for the electric field $\\mathbf{E}$:\n$$ \\nabla^2 \\mathbf{E} + k^2 \\mathbf{E} = 0 $$\nwhere we have assumed a source-free region such that $\\nabla \\cdot \\mathbf{E} = 0$. The squared wavenumber for the medium, $k^2$, is a complex quantity defined as:\n$$ k^2 = \\omega^2 \\mu \\epsilon - i \\omega \\mu \\sigma $$\n\nThe problem considers a $1$-dimensional ($1\\text{D}$) Earth model, where the physical properties $(\\sigma, \\epsilon, \\mu)$ are piecewise constant and vary only with depth, $z$. This horizontal invariance allows for a decomposition of the fields into a spectrum of plane waves using a Fourier-Hankel transform over the horizontal coordinates $(x, y)$. This transforms the partial differential equations into ordinary differential equations in the spectral domain, characterized by the horizontal wavenumber $k_r$. In this domain, the Laplacian operator's horizontal part, $\\frac{\\partial^2}{\\partial x^2} + \\frac{\\partial^2}{\\partial y^2}$, becomes a multiplication by $-k_r^2$. Thus, for each layer $n$, the Helmholtz equation becomes:\n$$ \\left( \\frac{d^2}{dz^2} - k_r^2 + k_n^2 \\right) \\tilde{\\mathbf{F}}(k_r, z) = 0 $$\nwhere $\\tilde{\\mathbf{F}}$ represents a transformed field component. This is rewritten as:\n$$ \\frac{d^2}{dz^2} \\tilde{\\mathbf{F}}(k_r, z) - \\gamma_n^2 \\tilde{\\mathbf{F}}(k_r, z) = 0 $$\nHere, $\\gamma_n$ is the vertical propagation constant in layer $n$, defined by:\n$$ \\gamma_n = \\sqrt{k_r^2 - k_n^2} = \\sqrt{k_r^2 - (\\omega^2 \\mu_n \\epsilon_n - i \\omega \\mu_n \\sigma_n)} $$\nThe sign of the square root is chosen such that the real part of $\\gamma_n$ is non-negative, $\\text{Re}(\\gamma_n) \\ge 0$, to ensure that the wave amplitudes decay in the direction of propagation away from any sources.\n\nThe electromagnetic fields in this $1\\text{D}$ geometry can be decoupled into two independent modes: Transverse Electric (TE) and Transverse Magnetic (TM).\nFor the TE mode, the electric field is purely horizontal ($E_z=0$). The tangential fields are related by a characteristic wave admittance, $Y_n^{\\mathrm{TE}}$. From the transformed Maxwell's equations, this is found to be:\n$$ Y_n^{\\mathrm{TE}} = \\frac{\\gamma_n}{i \\omega \\mu_n} $$\nFor the TM mode, the magnetic field is purely horizontal ($H_z=0$). The tangential fields are related by the characteristic admittance $Y_n^{\\mathrm{TM}}$, given by:\n$$ Y_n^{\\mathrm{TM}} = \\frac{\\sigma_n + i \\omega \\epsilon_n}{\\gamma_n} $$\n\nThe reflection coefficient at the surface depends on the input admittance of the entire layered Earth structure. This input admittance is computed using a recursive algorithm that propagates the admittance from the bottom of the model upwards to the surface. This is analogous to transmission line theory. We start at the bottom-most interface, which is the top of the basement half-space (layer $N+1$). Since there are only downward-propagating waves in the basement, the input admittance seen at the top of the basement is simply its characteristic admittance, $Y_{\\text{load}} = Y_{N+1}$.\n\nFor a layer $n$ of thickness $d_n$ overlying a medium with input admittance $Y_{\\text{load}}$, the input admittance $Y_{\\text{in}}$ at the top of layer $n$ is given by the transmission line equation:\n$$ Y_{\\text{in}} = Y_n \\frac{Y_{\\text{load}} + Y_n \\tanh(\\gamma_n d_n)}{Y_n + Y_{\\text{load}} \\tanh(\\gamma_n d_n)} $$\nThis formula is applied recursively for each mode (TE and TM) separately. The algorithm proceeds as follows:\n$1$. The initial \"load\" admittance is that of the basement half-space: $Y_{\\text{load}} = Y_{\\text{basement}}$.\n$2$. For each layer $n$ from the deepest finite layer ($N$) up to the surface layer ($1$), update the load admittance:\n$Y_{\\text{in}, n} = Y_n \\frac{Y_{\\text{load}} + Y_n \\tanh(\\gamma_n d_n)}{Y_n + Y_{\\text{load}} \\tanh(\\gamma_n d_n)}$\n$Y_{\\text{load}} = Y_{\\text{in}, n}$\n$3$. After iterating through all layers, the final $Y_{\\text{load}}$ is the input admittance of the layered Earth as seen at the surface ($z=0$), which we denote $Y_{\\text{Earth}}$.\n\nFinally, the reflection coefficient $R$ at the air-Earth interface (interface between layer $0$ and layer $1$) is calculated. This coefficient is the ratio of the up-going to down-going wave amplitudes in the air half-space. It is determined by the mismatch between the characteristic admittance of the air, $Y_0$, and the input admittance of the Earth, $Y_{\\text{Earth}}$:\n$$ R = \\frac{Y_0 - Y_{\\text{Earth}}}{Y_0 + Y_{\\text{Earth}}} $$\nThis calculation is performed for both TE and TM modes to find $R^{\\mathrm{TE}}$ and $R^{\\mathrm{TM}}$. The desired output is the magnitude of these complex reflection coefficients, $|R^{\\mathrm{TE}}|$ and $|R^{\\mathrm{TM}}|$.\n\nThe full procedure for each test case is:\na. For a given frequency $f$ and a set of horizontal wavenumbers $k_r$, define the physical properties for all layers, including the air half-space (layer $0$), the finite Earth layers ($1, \\dots, N$), and the basement half-space (layer $N+1$). These properties are $\\sigma_n$, $\\epsilon_n = \\epsilon_0 \\epsilon_{r,n}$, and $\\mu_n = \\mu_0 \\mu_{r,n}$ (with $\\mu_{r,n} = 1$).\nb. For each $k_r$, calculate the vertical propagation constant $\\gamma_n$ and the characteristic admittances $Y_n^{\\mathrm{TE}}$ and $Y_n^{\\mathrm{TM}}$ for every layer.\nc. Initialize the load admittances for TE and TM modes with the characteristic admittances of the basement, $Y_{\\text{basement}}^{\\mathrm{TE}}$ and $Y_{\\text{basement}}^{\\mathrm{TM}}$.\nd. Recursively apply the admittance transformation formula upwards from the bottom-most finite layer to the top layer, separately for TE and TM modes. The result is the total input admittance of the Earth, $Y_{\\text{Earth}}^{\\mathrm{TE}}$ and $Y_{\\text{Earth}}^{\\mathrm{TM}}$.\ne. Calculate the reflection coefficients $R^{\\mathrm{TE}}$ and $R^{\\mathrm{TM}}$ using the characteristic admittances of air ($Y_{0}^{\\mathrm{TE}}, Y_{0}^{\\mathrm{TM}}$) and the computed Earth admittances.\nf. Compute and record the magnitudes $|R^{\\mathrm{TE}}|$ and $|R^{\\mathrm{TM}}|$.\nThis process is repeated for each $k_r$ and for each test case provided.", "answer": "```python\nimport numpy as np\nfrom scipy.constants import mu_0, epsilon_0\n\ndef compute_reflection_coefficients(freq, finite_layers, basement_props, kr_values):\n    \"\"\"\n    Computes TE and TM reflection coefficients for a 1D layered Earth model.\n\n    Args:\n        freq (float): Frequency in Hz.\n        finite_layers (list): A list of tuples, where each tuple represents a finite layer\n                              and contains (thickness_m, sigma_S_per_m, rel_permittivity).\n        basement_props (tuple): A tuple for the basement half-space containing\n                                (sigma_S_per_m, rel_permittivity).\n        kr_values (list): A list of horizontal wavenumbers (k_r) in m^-1.\n\n    Returns:\n        list: A list of computed magnitudes [|R_te|, |R_tm|, ...].\n    \"\"\"\n    omega = 2 * np.pi * freq\n    \n    # Layer properties: [air, finite_layers..., basement]\n    # Air is layer 0\n    air_props = (np.inf, 0.0, 1.0) # (thickness, sigma, eps_r)\n    \n    # Combine all layers into one list for easier processing\n    # Structure: (d, sigma, eps_r, mu_r=1)\n    all_layer_props = [air_props] + finite_layers + [basement_props]\n    layer_thicknesses = [p[0] for p in all_layer_props]\n    \n    results = []\n    \n    for kr in kr_values:\n        gammas = []\n        Y_te = []\n        Y_tm = []\n        \n        # Calculate properties for all layers (air, finite, basement)\n        for _, sigma, eps_r in all_layer_props:\n            mu = mu_0  # mu_r is 1 for all layers\n            eps = epsilon_0 * eps_r\n            \n            # Complex wavenumber squared: k^2 = omega^2*mu*eps - i*omega*mu*sigma\n            k_sq = omega**2 * mu * eps - 1j * omega * mu * sigma\n            \n            # Vertical propagation constant: gamma = sqrt(kr^2 - k^2)\n            # numpy.sqrt of complex number correctly returns value with non-negative real part.\n            gamma = np.sqrt(kr**2 - k_sq)\n            gammas.append(gamma)\n            \n            # Characteristic admittances\n            # TE mode: Y_te = gamma / (i*omega*mu)\n            Y_n_te = gamma / (1j * omega * mu)\n            Y_te.append(Y_n_te)\n            \n            # TM mode: Y_tm = (sigma + i*omega*eps) / gamma\n            # Handle potential division by zero if gamma is zero\n            if gamma == 0:\n                Y_n_tm = np.inf \n            else:\n                Y_n_tm = (sigma + 1j * omega * eps) / gamma\n            Y_tm.append(Y_n_tm)\n\n        # Upward recursion from basement to surface\n        num_finite_layers = len(finite_layers)\n\n        # Start with basement's characteristic admittance as the load\n        Y_load_te = Y_te[-1]\n        Y_load_tm = Y_tm[-1]\n        \n        # Loop from the deepest finite layer (index num_finite_layers) up to the top one (index 1)\n        for n in range(num_finite_layers, 0, -1):\n            gamma_n = gammas[n]\n            d_n = layer_thicknesses[n]\n            \n            # tanh(z) -> 1 for large positive real(z)\n            # Since Re(gamma) >= 0 and d > 0, we only need to check for large positive real part.\n            if np.isinf(d_n):\n                 tanh_val = 1.0\n            else:\n                 tanh_val = np.tanh(gamma_n * d_n)\n\n            # TE mode recursion\n            Y_n_te = Y_te[n]\n            numerator_te = Y_load_te + Y_n_te * tanh_val\n            denominator_te = Y_n_te + Y_load_te * tanh_val\n            Y_in_te = Y_n_te * (numerator_te / denominator_te)\n            Y_load_te = Y_in_te\n\n            # TM mode recursion\n            Y_n_tm = Y_tm[n]\n            numerator_tm = Y_load_tm + Y_n_tm * tanh_val\n            denominator_tm = Y_n_tm + Y_load_tm * tanh_val\n            Y_in_tm = Y_n_tm * (numerator_tm / denominator_tm)\n            Y_load_tm = Y_in_tm\n\n        # Final input admittances for the entire Earth stack\n        Y_earth_te = Y_load_te\n        Y_earth_tm = Y_load_tm\n        \n        # Reflection coefficients at air-earth interface (z=0)\n        # R = (Y0 - Y_earth) / (Y0 + Y_earth)\n        Y0_te = Y_te[0]\n        Y0_tm = Y_tm[0]\n\n        R_te = (Y0_te - Y_earth_te) / (Y0_te + Y_earth_te)\n        R_tm = (Y0_tm - Y_earth_tm) / (Y0_tm + Y_earth_tm)\n        \n        results.append(np.abs(R_te))\n        results.append(np.abs(R_tm))\n        \n    return results\n\ndef solve():\n    \"\"\"\n    Defines and runs the test suite for the CSEM forward modeling problem.\n    \"\"\"\n    test_cases = [\n        # Test Case 1\n        {\n            \"freq\": 1000.0,\n            \"layers\": [ (100.0, 0.01, 10.0) ], # (d, sigma, eps_r)\n            \"basement\": (1.0, 10.0), # (sigma, eps_r)\n            \"kr_values\": [0.0, 10.0, 100.0]\n        },\n        # Test Case 2\n        {\n            \"freq\": 1.0,\n            \"layers\": [\n                (50.0, 0.1, 4.0),\n                (200.0, 0.01, 6.0)\n            ],\n            \"basement\": (0.001, 10.0),\n            \"kr_values\": [0.0, 1.0, 5.0]\n        },\n        # Test Case 3\n        {\n            \"freq\": 100000.0,\n            \"layers\": [ (1.0, 0.5, 20.0) ],\n            \"basement\": (0.1, 15.0),\n            \"kr_values\": [0.0, 100.0, 1000.0]\n        }\n    ]\n\n    all_results = []\n    for case in test_cases:\n        # Basement properties are extended with infinite thickness for consistency\n        basement_full_props = (np.inf,) + case[\"basement\"]\n        results = compute_reflection_coefficients(case[\"freq\"], case[\"layers\"], basement_full_props, case[\"kr_values\"])\n        all_results.extend(results)\n\n    # Format the final output as a single comma-separated list in brackets\n    # Use a high precision format for floating point numbers\n    print(f\"[{','.join(f'{r:.12f}' for r in all_results)}]\")\n\nsolve()\n```", "id": "3582348"}, {"introduction": "Our final practice elevates the challenge to a two-dimensional, generally inhomogeneous medium, requiring a more sophisticated numerical solver based on the finite-difference method. Beyond just building the solver, this exercise introduces a critical concept in computational science: numerical verification through physical principles. You will implement a reciprocity test, leveraging the symmetry of the underlying physics to validate the correctness of your numerical operator, a technique essential for developing robust and reliable modeling codes.", "problem": "Consider a two-dimensional controlled-source electromagnetic problem with spatially varying electrical conductivity $\\sigma(\\mathbf{x})$ on a rectangular domain $\\Omega = [0,L_x] \\times [0,L_y]$. Assume invariance along the $z$-axis and time-harmonic fields with $e^{i\\omega t}$ convention. Begin from Maxwell's equations in the frequency domain ($\\nabla \\times \\mathbf{E} = -i\\omega\\mu\\mathbf{H}$ and $\\nabla \\times \\mathbf{H} = \\sigma \\mathbf{E} + i\\omega \\epsilon \\mathbf{E} + \\mathbf{J}_s$), and invoke the quasi-static conduction regime where displacement currents are negligible compared to conduction currents (i.e., $|\\omega \\epsilon| \\ll \\sigma$ everywhere in $\\Omega$). Under a Transverse Electric (TE) and Transverse Magnetic (TM) reduction with fields polarized such that either $E_z$ or $H_z$ is the nonzero component, derive scalar partial differential equations governing $E_z(\\mathbf{x})$ and $H_z(\\mathbf{x})$ in the presence of an impressed source $\\mathbf{J}_s(\\mathbf{x})$.\n\nYour derivation should start from these fundamental laws and definitions:\n- Maxwell's equations in the frequency domain under the $e^{i\\omega t}$ convention.\n- The constitutive relations for a linear, isotropic medium: $\\mathbf{B} = \\mu \\mathbf{H}$ and $\\mathbf{D} = \\epsilon \\mathbf{E}$.\n- The quasi-static conduction assumption $|\\omega \\epsilon| \\ll \\sigma$, with $\\mu(\\mathbf{x}) = \\mu_0$ constant and $\\epsilon(\\mathbf{x})$ neglected.\n\nFrom these, show that both TE ($E_z$) and TM ($H_z$) scalar formulations lead to second-order linear differential operators of the generic form $\\nabla \\cdot (a(\\mathbf{x}) \\nabla u(\\mathbf{x})) + c(\\mathbf{x}) u(\\mathbf{x}) = s(\\mathbf{x})$, and identify the coefficient functions $a(\\mathbf{x})$ and $c(\\mathbf{x})$ for each formulation in terms of $\\sigma(\\mathbf{x})$, $\\mu_0$, and $\\omega$.\n\nDiscretize both scalar equations on a uniform Cartesian grid using the Finite Difference Method (FDM) with homogeneous Dirichlet boundary conditions ($u=0$ on $\\partial \\Omega$). Use a five-point stencil for the operator $\\nabla \\cdot (a(\\mathbf{x}) \\nabla u(\\mathbf{x}))$, and apply harmonic averaging for face-centered values of $a(\\mathbf{x})$ between neighboring cells to ensure a symmetric discrete operator. Model the impressed source $s(\\mathbf{x})$ as a grid-based point source localized to one interior node, represented as a discrete delta.\n\nDefine the Green's function $G(\\mathbf{x}_r,\\mathbf{x}_s)$ for each formulation (electric and magnetic) as the field at the receiver location $\\mathbf{x}_r$ due to a unit point source at $\\mathbf{x}_s$. Construct a numerical reciprocity test by swapping source and receiver positions and verifying the symmetry $G(\\mathbf{x}_r,\\mathbf{x}_s) = G(\\mathbf{x}_s,\\mathbf{x}_r)$ for both the electric and magnetic formulations. Implement a complex-valued linear solver to compute the discrete fields.\n\nUse the following physical constants and units and adhere to them in your derivation and discretization:\n- Magnetic permeability $\\mu_0 = 4\\pi \\times 10^{-7}$ in henry per meter (H/m).\n- Lengths in meters (m).\n- Frequency in hertz (Hz).\n- Conductivity in siemens per meter (S/m).\nThe final program output consists of boolean values and therefore does not require physical units.\n\nTest Suite:\nFor each case below, build the conductivity model $\\sigma(\\mathbf{x})$ and evaluate reciprocity for both formulations. The domain is $L_x = 1.0$ m, $L_y = 1.0$ m, discretized on a $(N_x,N_y)$ grid with $N_x = N_y = 41$ nodes. The grid spacing is uniform and equal along $x$ and $y$. Receiver and source positions are specified in meters and must be mapped to the nearest interior grid node. For each case, test reciprocity by computing $G(\\mathbf{x}_r,\\mathbf{x}_s)$ and $G(\\mathbf{x}_s,\\mathbf{x}_r)$ and returning a boolean indicating whether their absolute difference, normalized by the maximum magnitude of the two, is less than a tolerance of $10^{-7}$.\n\n- Case 1 (general inhomogeneous): Frequency $f = 10$ Hz. Background conductivity $\\sigma = 1.0$ S/m. A circular low-conductivity inclusion with $\\sigma = 0.1$ S/m centered at $(0.6,0.4)$ of radius $0.15$ m, and a vertical high-conductivity strip with $\\sigma = 10.0$ S/m for $x \\in [0.2,0.25]$ for all $y$. Source at $\\mathbf{x}_s = (0.10,0.10)$ m. Receiver at $\\mathbf{x}_r = (0.80,0.90)$ m.\n- Case 2 (adjacent nodes near contrast): Frequency $f = 1$ Hz. Background conductivity $\\sigma = 0.5$ S/m. A circular high-conductivity inclusion with $\\sigma = 5.0$ S/m centered at $(0.5,0.5)$ of radius $0.20$ m. Source at $\\mathbf{x}_s = (0.50,0.70)$ m. Receiver at $\\mathbf{x}_r = (0.525,0.70)$ m.\n- Case 3 (strong checkerboard contrast, near-boundary points): Frequency $f = 100$ Hz. Checkerboard conductivity with base $\\sigma = 0.1$ S/m, and cells where $\\lfloor i/5 \\rfloor + \\lfloor j/5 \\rfloor$ is even have $\\sigma = 50.0$ S/m, where $(i,j)$ are the grid indices. Source at $\\mathbf{x}_s = (0.02,0.95)$ m. Receiver at $\\mathbf{x}_r = (0.98,0.05)$ m.\n\nAlgorithmic Requirements:\n- Assemble the discrete operator for the electric formulation using $a_E(\\mathbf{x})$ and $c_E(\\mathbf{x})$ derived from first principles, and similarly for the magnetic formulation with $a_H(\\mathbf{x})$ and $c_H(\\mathbf{x})$.\n- Use harmonic averaging at cell faces to compute face-centered $a(\\mathbf{x})$ values.\n- Impose homogeneous Dirichlet boundary conditions by excluding boundary nodes from the system of equations.\n- Represent the source as a unit discrete delta at the source node.\n- Solve the resulting complex-valued linear systems to obtain the field at the receiver.\n\nFinal Output Format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, ordered as $[\\text{E1},\\text{H1},\\text{E2},\\text{H2},\\text{E3},\\text{H3}]$, where each entry is a boolean indicating whether reciprocity holds in the specified case for the electric (E) or magnetic (H) formulation. For example, \"[True,False,True,True,False,True]\". The output must be the only text printed by the program.", "solution": "We begin by deriving the governing equations from Maxwell's equations in the frequency domain, assuming a time-harmonic dependency of $e^{i\\omega t}$. Under the quasi-static approximation, where conduction currents dominate displacement currents ($\\sigma \\gg |\\omega\\epsilon|$), Maxwell's equations simplify to:\n$$\n\\nabla \\times \\mathbf{E} = -i\\omega\\mu_0\\mathbf{H} \\quad (1)\n$$\n$$\n\\nabla \\times \\mathbf{H} = \\sigma(\\mathbf{x}) \\mathbf{E} + \\mathbf{J}_s \\quad (2)\n$$\nHere, $\\mathbf{E}$ is the electric field, $\\mathbf{H}$ is the magnetic field, $\\omega$ is the angular frequency, $\\mu_0$ is the magnetic permeability of free space, $\\sigma(\\mathbf{x})$ is the spatially varying electrical conductivity, and $\\mathbf{J}_s$ is the impressed electric current source density. The problem is $2$D, implying all fields and properties are constant along the $z$-axis ($\\partial/\\partial z = 0$).\n\n**Transverse Electric (TE) Mode**\nIn the TE mode, the electric field is polarized purely in the $z$-direction: $\\mathbf{E} = E_z(\\mathbf{x}) \\hat{\\mathbf{z}}$. Consequently, the magnetic field lies in the $xy$-plane: $\\mathbf{H} = H_x(\\mathbf{x}) \\hat{\\mathbf{x}} + H_y(\\mathbf{x}) \\hat{\\mathbf{y}}$. For this mode to be sustained, the source must also be $z$-directed, $\\mathbf{J}_s = J_{sz}(\\mathbf{x}) \\hat{\\mathbf{z}}$.\n\nFrom Equation ($1$), we express the magnetic field components in terms of $E_z$:\n$$\nH_x = \\frac{i}{\\omega\\mu_0}\\frac{\\partial E_z}{\\partial y}, \\qquad H_y = -\\frac{i}{\\omega\\mu_0}\\frac{\\partial E_z}{\\partial x}\n$$\nNext, we take the curl of $\\mathbf{H}$ and consider its $z$-component, using Equation ($2$):\n$$\n(\\nabla \\times \\mathbf{H})_z = \\frac{\\partial H_y}{\\partial x} - \\frac{\\partial H_x}{\\partial y} = \\sigma E_z + J_{sz}\n$$\nSubstituting the expressions for $H_x$ and $H_y$ and rearranging gives the final scalar PDE for $E_z$:\n$$\n\\nabla^2 E_z - i\\omega\\mu_0\\sigma(\\mathbf{x}) E_z = i\\omega\\mu_0 J_{sz}(\\mathbf{x})\n$$\nThis equation is of the generic form $\\nabla \\cdot (a(\\mathbf{x}) \\nabla u(\\mathbf{x})) + c(\\mathbf{x}) u(\\mathbf{x}) = s(\\mathbf{x})$ with $u=E_z$, and the coefficients are identified as:\n- $a_E(\\mathbf{x}) = 1$\n- $c_E(\\mathbf{x}) = -i\\omega\\mu_0\\sigma(\\mathbf{x})$\n- The scalar source $s_E(\\mathbf{x})$ is related to the physical current source by $s_E = i\\omega\\mu_0 J_{sz}$.\n\n**Transverse Magnetic (TM) Mode**\nIn the TM mode, the magnetic field is polarized purely in the $z$-direction: $\\mathbf{H} = H_z(\\mathbf{x}) \\hat{\\mathbf{z}}$. The electric field is in the $xy$-plane: $\\mathbf{E} = E_x(\\mathbf{x}) \\hat{\\mathbf{x}} + E_y(\\mathbf{x}) \\hat{\\mathbf{y}}$. From Equation ($2$), we express the electric field:\n$$\n\\mathbf{E} = \\frac{1}{\\sigma}(\\nabla \\times \\mathbf{H} - \\mathbf{J}_s)\n$$\nNext, we take the curl of $\\mathbf{E}$ and consider its $z$-component, using Equation ($1$):\n$$\n(\\nabla \\times \\mathbf{E})_z = -i\\omega\\mu_0 H_z\n$$\nSubstituting the expression for $\\mathbf{E}$ and rearranging gives the final scalar PDE for $H_z$:\n$$\n\\nabla \\cdot \\left(\\frac{1}{\\sigma(\\mathbf{x})} \\nabla H_z\\right) - i\\omega\\mu_0 H_z = -\\left(\\nabla \\times \\frac{\\mathbf{J}_s}{\\sigma}\\right)_z\n$$\nThis equation is of the generic form with $u=H_z$, and the coefficients are identified as:\n- $a_H(\\mathbf{x}) = 1/\\sigma(\\mathbf{x})$\n- $c_H(\\mathbf{x}) = -i\\omega\\mu_0$\n- The scalar source $s_H(\\mathbf{x})$ is related to the curl of the physical source current. For a point source, this term becomes complex. The problem permits us to model the entire right-hand side as a simple scalar point source $s(\\mathbf{x})$.\n\n### Discretization and Reciprocity\n\nWe discretize the generic equation $\\nabla \\cdot (a \\nabla u) + c u = s$ on a uniform Cartesian grid with spacing $h$. Using a five-point finite-difference stencil at an interior node $(i,j)$, the equation becomes:\n$$\n\\frac{1}{h^2} \\left( a_{i+\\frac{1}{2},j}(u_{i+1,j}-u_{i,j}) - a_{i-\\frac{1}{2},j}(u_{i,j}-u_{i-1,j}) \\right) + \\frac{1}{h^2} \\left( a_{i,j+\\frac{1}{2}}(u_{i,j+1}-u_{i,j}) - a_{i,j-\\frac{1}{2}}(u_{i,j}-u_{i,j-1}) \\right) + c_{i,j}u_{i,j} = s_{i,j}\n$$\nTo ensure the discrete operator is symmetric, which is a prerequisite for numerical reciprocity, we use harmonic averaging for the face-centered coefficients:\n$$\na_{i+\\frac{1}{2},j} = \\frac{2 a_{i,j} a_{i+1,j}}{a_{i,j} + a_{i+1,j}} \\quad \\text{and} \\quad a_{i,j+\\frac{1}{2}} = \\frac{2 a_{i,j} a_{i,j+1}}{a_{i,j} + a_{i,j+1}}\n$$\nThis discretization, along with homogeneous Dirichlet boundary conditions ($u=0$ on $\\partial\\Omega$), leads to a complex-valued linear system of equations $\\mathbf{A}\\mathbf{u} = \\mathbf{b}$. The matrix $\\mathbf{A}$ assembled with harmonic averaging is symmetric ($\\mathbf{A} = \\mathbf{A}^T$).\n\nThe discrete Green's function, $G_{rk} = (\\mathbf{A}^{-1})_{rk}$, represents the field at node $r$ due to a unit source at node $k$. The symmetry of $\\mathbf{A}$ implies the symmetry of its inverse, $\\mathbf{A}^{-1} = (\\mathbf{A}^{-1})^T$, so $(\\mathbf{A}^{-1})_{rk} = (\\mathbf{A}^{-1})_{kr}$. This means the field at receiver $\\mathbf{x}_r$ due to a source at $\\mathbf{x}_s$ is identical to the field at $\\mathbf{x}_s$ due to a source at $\\mathbf{x}_r$. This is the principle of reciprocity, which we will test numerically. The source $\\mathbf{b}$ is modeled as a vector with a single non-zero entry (a value of $1$) at the source node, corresponding to a discrete delta function.", "answer": "```python\nimport numpy as np\nfrom scipy.sparse import lil_matrix, csc_matrix\nfrom scipy.sparse.linalg import spsolve\n\ndef solve():\n    \"\"\"\n    Main function to run the CSEM reciprocity tests.\n    \"\"\"\n    \n    # --- Physical and Numerical Parameters ---\n    MU_0 = 4 * np.pi * 1e-7  # H/m\n    TOLERANCE = 1e-7\n    \n    # Grid parameters\n    LX, LY = 1.0, 1.0  # m\n    NX, NY = 41, 41\n\n    # --- Test Cases ---\n    test_cases = [\n        {\n            # Case 1: General inhomogeneous model\n            \"f\": 10.0,\n            \"sigma_params\": {\n                \"background\": 1.0,\n                \"inclusion1\": {\"type\": \"circle\", \"center\": (0.6, 0.4), \"radius\": 0.15, \"sigma\": 0.1},\n                \"inclusion2\": {\"type\": \"strip\", \"x_range\": [0.2, 0.25], \"sigma\": 10.0}\n            },\n            \"xs\": (0.10, 0.10),\n            \"xr\": (0.80, 0.90)\n        },\n        {\n            # Case 2: Adjacent nodes near contrast\n            \"f\": 1.0,\n            \"sigma_params\": {\n                \"background\": 0.5,\n                \"inclusion1\": {\"type\": \"circle\", \"center\": (0.5, 0.5), \"radius\": 0.20, \"sigma\": 5.0}\n            },\n            \"xs\": (0.50, 0.70),\n            \"xr\": (0.525, 0.70)\n        },\n        {\n            # Case 3: Strong checkerboard contrast, near-boundary points\n            \"f\": 100.0,\n            \"sigma_params\": {\n                \"background\": 0.1,\n                \"inclusion1\": {\"type\": \"checkerboard\", \"block_size\": 5, \"sigma\": 50.0}\n            },\n            \"xs\": (0.02, 0.95),\n            \"xr\": (0.98, 0.05)\n        }\n    ]\n\n    def build_conductivity_model(params, x_coords, y_coords):\n        \"\"\"Builds the conductivity grid based on model parameters.\"\"\"\n        sigma = np.full((NX, NY), params[\"background\"], dtype=np.float64)\n        for key in sorted(params.keys()):\n            if \"inclusion\" in key:\n                inc = params[key]\n                if inc[\"type\"] == \"circle\":\n                    cx, cy = inc[\"center\"]\n                    r2 = inc[\"radius\"]**2\n                    for i in range(NX):\n                        for j in range(NY):\n                            if (x_coords[i] - cx)**2 + (y_coords[j] - cy)**2  r2:\n                                sigma[i, j] = inc[\"sigma\"]\n                elif inc[\"type\"] == \"strip\":\n                    x_min, x_max = inc[\"x_range\"]\n                    for i in range(NX):\n                        if x_min = x_coords[i] = x_max:\n                            sigma[i, :] = inc[\"sigma\"]\n                elif inc[\"type\"] == \"checkerboard\":\n                    block_size = inc[\"block_size\"]\n                    for i in range(NX):\n                        for j in range(NY):\n                            if (i // block_size + j // block_size) % 2 == 0:\n                                sigma[i, j] = inc[\"sigma\"]\n        return sigma\n\n    def check_reciprocity(mode, f, sigma, xs_pos, xr_pos):\n        \"\"\"Assembles and solves the system for a given mode and checks reciprocity.\"\"\"\n        \n        # Grid setup\n        hx = LX / (NX - 1)\n        hy = LY / (NY - 1)\n        \n        # Angular frequency\n        omega = 2 * np.pi * f\n        \n        # Map physical coordinates to nearest interior grid indices\n        def map_to_interior_idx(pos):\n            i = np.clip(np.rint(pos[0] / hx).astype(int), 1, NX - 2)\n            j = np.clip(np.rint(pos[1] / hy).astype(int), 1, NY - 2)\n            return i, j\n\n        is_s, js_s = map_to_interior_idx(xs_pos)\n        is_r, js_r = map_to_interior_idx(xr_pos)\n\n        # Number of interior nodes\n        num_unknowns = (NX - 2) * (NY - 2)\n        \n        # PDE coefficients based on the mode\n        if mode == 'TE':\n            a_grid = np.ones((NX, NY), dtype=np.float64)\n            c_grid = -1j * omega * MU_0 * sigma\n        elif mode == 'TM':\n            a_grid = 1.0 / sigma\n            c_grid = np.full((NX, NY), -1j * omega * MU_0, dtype=np.complex128)\n        else:\n            raise ValueError(\"Mode must be 'TE' or 'TM'\")\n\n        # Assembly of the sparse system matrix A\n        A = lil_matrix((num_unknowns, num_unknowns), dtype=np.complex128)\n        \n        for i in range(1, NX - 1):\n            for j in range(1, NY - 1):\n                k = (j - 1) * (NX - 2) + (i - 1)  # 1D index\n                \n                # Diagonal contribution from c * u term\n                A[k, k] = c_grid[i, j]\n                \n                # West neighbor (i-1, j)\n                a_w = 2 * a_grid[i, j] * a_grid[i - 1, j] / (a_grid[i, j] + a_grid[i - 1, j])\n                A[k, k] -= a_w / hx**2\n                if i > 1:\n                    A[k, k - 1] += a_w / hx**2\n\n                # East neighbor (i+1, j)\n                a_e = 2 * a_grid[i, j] * a_grid[i + 1, j] / (a_grid[i, j] + a_grid[i + 1, j])\n                A[k, k] -= a_e / hx**2\n                if i  NX - 2:\n                    A[k, k + 1] += a_e / hx**2\n\n                # South neighbor (i, j-1)\n                a_s = 2 * a_grid[i, j] * a_grid[i, j - 1] / (a_grid[i, j] + a_grid[i, j - 1])\n                A[k, k] -= a_s / hy**2\n                if j > 1:\n                    A[k, k - (NX - 2)] += a_s / hy**2\n                    \n                # North neighbor (i, j+1)\n                a_n = 2 * a_grid[i, j] * a_grid[i, j + 1] / (a_grid[i, j] + a_grid[i, j + 1])\n                A[k, k] -= a_n / hy**2\n                if j  NY - 2:\n                    A[k, k + (NX - 2)] += a_n / hy**2\n        \n        A_csc = A.tocsc()\n        \n        ks = (js_s - 1) * (NX - 2) + (is_s - 1)\n        kr = (js_r - 1) * (NX - 2) + (is_r - 1)\n\n        # --- First solve: source at xs, receiver at xr ---\n        b_s = np.zeros(num_unknowns, dtype=np.complex128)\n        b_s[ks] = 1.0\n        u_s = spsolve(A_csc, b_s)\n        G1 = u_s[kr]\n\n        # --- Second solve: source at xr, receiver at xs ---\n        b_r = np.zeros(num_unknowns, dtype=np.complex128)\n        b_r[kr] = 1.0\n        u_r = spsolve(A_csc, b_r)\n        G2 = u_r[ks]\n        \n        # --- Reciprocity check ---\n        abs_G1 = np.abs(G1)\n        abs_G2 = np.abs(G2)\n        max_val = max(abs_G1, abs_G2)\n        \n        if max_val == 0:\n            # If both are zero, difference is zero, reciprocity holds.\n            return True\n        \n        norm_diff = np.abs(G1 - G2) / max_val\n        return norm_diff  TOLERANCE\n\n    # --- Main loop to run all tests ---\n    results = []\n    x_coords = np.linspace(0, LX, NX)\n    y_coords = np.linspace(0, LY, NY)\n    \n    for case in test_cases:\n        sigma_model = build_conductivity_model(case[\"sigma_params\"], x_coords, y_coords)\n        \n        # TE mode test\n        reciprocity_E = check_reciprocity('TE', case[\"f\"], sigma_model, case[\"xs\"], case[\"xr\"])\n        results.append(reciprocity_E)\n        \n        # TM mode test\n        reciprocity_H = check_reciprocity('TM', case[\"f\"], sigma_model, case[\"xs\"], case[\"xr\"])\n        results.append(reciprocity_H)\n\n    # Print results in the specified format\n    print(f\"[{','.join(str(r).capitalize() for r in results)}]\")\n\nsolve()\n\n```", "id": "3582367"}]}