{"hands_on_practices": [{"introduction": "The heart of any hybrid Finite Element–Boundary Integral (FE-BI) method lies at the interface where the interior and exterior models are coupled. This first practice focuses on the essential mechanics of this coupling, translating the physical requirement of tangential field continuity into a concrete, computable matrix. By deriving and implementing the coupling terms between volume-based Nédélec elements and surface-based Rao–Wilton–Glisson (RWG) functions, you will gain a fundamental understanding of how information is passed between the FEM and BEM domains. [@problem_id:3315828]", "problem": "You are asked to derive and implement the discrete coupling between interior vector Finite Element Method (FEM) degrees of freedom and exterior surface basis functions used in the Boundary Element Method (BEM) for electromagnetic scattering. Specifically, consider the lowest-order Nédélec edge elements in tetrahedra for the interior field and the Rao–Wilton–Glisson (RWG) basis functions on a triangulated surface. Your task is to construct the coupling matrix entry that maps each interior edge-element degree of freedom to a single RWG coefficient by integrating the tangential trace of the interior basis functions against the RWG basis on the surface interface $\\Gamma$.\n\nStart from the following fundamental base:\n\n- Maxwell’s equations enforce the continuity of the tangential electric field across an interface, which leads to the weak enforcement involving surface integrals over the interface $\\Gamma$ of interior-trace fields against surface test functions.\n- The lowest-order Nédélec (first kind) edge basis function on a tetrahedron with vertices $\\boldsymbol{p}_0, \\boldsymbol{p}_1, \\boldsymbol{p}_2, \\boldsymbol{p}_3$ associated with edge $(i,j)$ is defined via barycentric coordinates as $\\boldsymbol{N}_{ij}(\\boldsymbol{r}) = \\lambda_i(\\boldsymbol{r}) \\nabla \\lambda_j - \\lambda_j(\\boldsymbol{r}) \\nabla \\lambda_i$, where $\\lambda_k$ are the barycentric coordinates and $\\nabla \\lambda_k$ are constant vectors on the tetrahedron.\n- The Rao–Wilton–Glisson (RWG) basis function is supported on two adjacent surface triangles $T^+$ and $T^-$ that share one common edge. It is defined piecewise as $\\boldsymbol{f}(\\boldsymbol{r}) = \\dfrac{l_e}{2 A^+}\\left(\\boldsymbol{r} - \\boldsymbol{r}^+_{\\text{op}}\\right)$ on $T^+$ and $\\boldsymbol{f}(\\boldsymbol{r}) = -\\dfrac{l_e}{2 A^-}\\left(\\boldsymbol{r} - \\boldsymbol{r}^-_{\\text{op}}\\right)$ on $T^-$, where $l_e$ is the length of the common edge, $A^\\pm$ are the areas of $T^\\pm$, and $\\boldsymbol{r}^\\pm_{\\text{op}}$ are the vertices opposite the common edge on $T^\\pm$. This vector field is tangential to the surface by construction.\n- On a triangular face, the barycentric coordinates satisfy standard integral identities. For a triangle $T$ with area $A$ and vertices indexed by $\\{a,b,c\\}$, the integrals of barycentric monomials are $\\int_T \\lambda_i \\, \\mathrm{d}S = \\dfrac{A}{3}$ for $i \\in \\{a,b,c\\}$ and $0$ otherwise; and $\\int_T \\lambda_i \\lambda_j \\, \\mathrm{d}S = \\dfrac{A}{6}$ if $i=j \\in \\{a,b,c\\}$, $\\dfrac{A}{12}$ if $i \\neq j$ with $i,j \\in \\{a,b,c\\}$, and $0$ otherwise. Also, for any point $\\boldsymbol{r} \\in T$, $\\boldsymbol{r} = \\lambda_a \\boldsymbol{p}_a + \\lambda_b \\boldsymbol{p}_b + \\lambda_c \\boldsymbol{p}_c$, so $\\int_T \\lambda_i \\boldsymbol{r} \\, \\mathrm{d}S = \\sum_{m \\in \\{a,b,c\\}} \\boldsymbol{p}_m \\int_T \\lambda_i \\lambda_m \\, \\mathrm{d}S$.\n\nThe coupling entry to be computed for a given interior edge $(i,j)$ with Nédélec basis $\\boldsymbol{N}_{ij}$ and a single RWG basis $\\boldsymbol{f}$ supported on $T^+$ and $T^-$ is the surface inner product over $\\Gamma$ restricted to the support of the RWG, namely the scalar\n$$\nC_{ij} = \\int_{T^+} \\boldsymbol{N}_{ij}(\\boldsymbol{r}) \\cdot \\boldsymbol{f}(\\boldsymbol{r}) \\, \\mathrm{d}S + \\int_{T^-} \\boldsymbol{N}_{ij}(\\boldsymbol{r}) \\cdot \\boldsymbol{f}(\\boldsymbol{r}) \\, \\mathrm{d}S.\n$$\nBecause $\\boldsymbol{f}$ is tangential to $\\Gamma$, and the Nédélec trace’s tangential projection is $\\boldsymbol{N}_{ij} - (\\boldsymbol{N}_{ij} \\cdot \\boldsymbol{n}) \\boldsymbol{n}$, the dot product $\\boldsymbol{N}_{ij} \\cdot \\boldsymbol{f}$ equals its tangential projection dotted with $\\boldsymbol{f}$, ensuring that the normal component of $\\boldsymbol{N}_{ij}$ does not contribute.\n\nGeometry and meshing for this problem are specified as follows:\n\n- The surface interface $\\Gamma$ is the union of two triangles $T^+$ and $T^-$ forming a square in the plane $z=0$:\n  - $\\boldsymbol{v}_0 = (0,0,0)$,\n  - $\\boldsymbol{v}_1 = (1,0,0)$,\n  - $\\boldsymbol{v}_2 = (0,1,0)$,\n  - $\\boldsymbol{v}_3 = (1,1,0)$.\n  - $T^+$ has vertices $(\\boldsymbol{v}_0,\\boldsymbol{v}_1,\\boldsymbol{v}_2)$.\n  - $T^-$ has vertices $(\\boldsymbol{v}_3,\\boldsymbol{v}_2,\\boldsymbol{v}_1)$.\n  - The common edge is between $\\boldsymbol{v}_1$ and $\\boldsymbol{v}_2$. The opposite vertices are $\\boldsymbol{v}_0$ for $T^+$ and $\\boldsymbol{v}_3$ for $T^-$.\n- The interior domain is meshed by two tetrahedra, one attached to each triangle:\n  - Tetrahedron $A$ has vertices $(\\boldsymbol{v}_0,\\boldsymbol{v}_1,\\boldsymbol{v}_2,\\boldsymbol{v}_4)$.\n  - Tetrahedron $B$ has vertices $(\\boldsymbol{v}_3,\\boldsymbol{v}_2,\\boldsymbol{v}_1,\\boldsymbol{v}_5)$.\n- For each tetrahedron, consider all $6$ lowest-order Nédélec basis functions associated with edges $(0,1)$, $(0,2)$, $(0,3)$, $(1,2)$, $(1,3)$, $(2,3)$ in local vertex indexing. This yields a total of $12$ interior edge-element degrees of freedom.\n- The coupling matrix thus maps these $12$ interior degrees of freedom to the single RWG coefficient supported on $(T^+,T^-)$; it will be represented as a single row vector of length $12$.\n\nYour tasks:\n\n1. Derive from the base definitions an exact expression for each integral $\\int_{T^\\pm} \\boldsymbol{N}_{ij}(\\boldsymbol{r}) \\cdot \\boldsymbol{f}(\\boldsymbol{r}) \\, \\mathrm{d}S$ using only barycentric identities on the triangle $T^\\pm$ and the constant gradients $\\nabla \\lambda_k$ from the adjacent tetrahedron. Express all intermediate steps clearly in your solution and justify the elimination of the normal component of $\\boldsymbol{N}_{ij}$ from the integral due to the tangentiality of $\\boldsymbol{f}$.\n2. Implement a program that constructs the coupling row for three different test cases (varying the interior apex positions $\\boldsymbol{v}_4$ and $\\boldsymbol{v}_5$):\n   - Test case $1$: $\\boldsymbol{v}_4 = (0,0,1)$, $\\boldsymbol{v}_5 = (1,1,1)$.\n   - Test case $2$: $\\boldsymbol{v}_4 = (0.2,0.1,0.9)$, $\\boldsymbol{v}_5 = (0.8,1.3,1.1)$.\n   - Test case $3$: $\\boldsymbol{v}_4 = (-0.1,0.2,0.7)$, $\\boldsymbol{v}_5 = (1.1,0.9,1.4)$.\n3. Use exact barycentric integral identities on triangles and exact analytic gradients of barycentric coordinates on tetrahedra. Do not use numerical quadrature.\n4. Your program should produce a single line of output containing the three coupling rows as a comma-separated list of lists, each inner list being the $12$-entry row of real numbers for the corresponding test case, formatted like $[[r_{1,1},\\dots,r_{1,12}],[r_{2,1},\\dots,r_{2,12}],[r_{3,1},\\dots,r_{3,12}]]$.\n\nNo user input is permitted. The output contains pure numbers without units, since the integral is dimensionally consistent within the discretization. Angles are not involved in this computation.\n\nMake sure your derivation and implementation demonstrate the chain from electromagnetic interface conditions to the discretized coupling, and that the final computation uses only the definitions and identities provided. The test suite covers a typical configuration, a mildly skewed interior mesh, and a more pronounced skew, to probe stability of the construction. The final answer must be a complete, runnable program.", "solution": "The problem requires the derivation and implementation of the coupling matrix entries between interior Nédélec finite element basis functions and exterior RWG boundary element basis functions. The coupling is established through a surface integral on the interface between the FEM and BEM domains.\n\n### Problem Validation\n\nThe given problem is first subjected to a rigorous validation procedure.\n\n**Step 1: Extract Givens**\n- **Coupling Integral**: $C_{ij} = \\int_{T^+} \\boldsymbol{N}_{ij}(\\boldsymbol{r}) \\cdot \\boldsymbol{f}(\\boldsymbol{r}) \\, \\mathrm{d}S + \\int_{T^-} \\boldsymbol{N}_{ij}(\\boldsymbol{r}) \\cdot \\boldsymbol{f}(\\boldsymbol{r}) \\, \\mathrm{d}S$.\n- **Nédélec Basis (lowest-order, first kind)**: $\\boldsymbol{N}_{ij}(\\boldsymbol{r}) = \\lambda_i(\\boldsymbol{r}) \\nabla \\lambda_j - \\lambda_j(\\boldsymbol{r}) \\nabla \\lambda_i$.\n- **RWG Basis**: $\\boldsymbol{f}(\\boldsymbol{r}) = \\frac{l_e}{2 A^+}(\\boldsymbol{r} - \\boldsymbol{r}^+_{\\text{op}})$ on $T^+$ and $\\boldsymbol{f}(\\boldsymbol{r}) = -\\frac{l_e}{2 A^-}(\\boldsymbol{r} - \\boldsymbol{r}^-_{\\text{op}})$ on $T^-$.\n- **Barycentric Integral Identities (on a triangle $T$ of area $A$ with vertices $\\{a,b,c\\}$)**:\n  - $\\int_T \\lambda_i \\, \\mathrm{d}S = A/3$ for $i \\in \\{a,b,c\\}$.\n  - $\\int_T \\lambda_i \\lambda_j \\, \\mathrm{d}S = A/6$ for $i=j \\in \\{a,b,c\\}$; $A/12$ for $i \\neq j \\in \\{a,b,c\\}$.\n  - $\\int_T \\lambda_i \\boldsymbol{r} \\, \\mathrm{d}S = \\sum_{m \\in \\{a,b,c\\}} \\boldsymbol{p}_m \\int_T \\lambda_i \\lambda_m \\, \\mathrm{d}S$.\n- **Geometry**:\n  - Surface vertices: $\\boldsymbol{v}_0 = (0,0,0)$, $\\boldsymbol{v}_1 = (1,0,0)$, $\\boldsymbol{v}_2 = (0,1,0)$, $\\boldsymbol{v}_3 = (1,1,0)$.\n  - $T^+$ vertices: $(\\boldsymbol{v}_0,\\boldsymbol{v}_1,\\boldsymbol{v}_2)$. $T^-$ vertices: $(\\boldsymbol{v}_3,\\boldsymbol{v}_2,\\boldsymbol{v}_1)$.\n  - Common edge for RWG: $(\\boldsymbol{v}_1, \\boldsymbol{v}_2)$, with opposite vertices $\\boldsymbol{r}^+_{\\text{op}} = \\boldsymbol{v}_0$ and $\\boldsymbol{r}^-_{\\text{op}} = \\boldsymbol{v}_3$.\n  - Tetrahedron $A$: $(\\boldsymbol{v}_0,\\boldsymbol{v}_1,\\boldsymbol{v_2},\\boldsymbol{v}_4)$. Tetrahedron $B$: $(\\boldsymbol{v}_3,\\boldsymbol{v}_2,\\boldsymbol{v}_1,\\boldsymbol{v}_5)$.\n- **Degrees of Freedom**: $6$ Nédélec edges for each tetrahedron, for a total of $12$. The order is specified as local edges $(0,1), (0,2), (0,3), (1,2), (1,3), (2,3)$ for Tet $A$, then for Tet $B$.\n- **Test Cases**: Three pairs of coordinates for $(\\boldsymbol{v}_4, \\boldsymbol{v}_5)$.\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is scientifically grounded in the principles of computational electromagnetics, specifically hybrid FEM-BEM formulations. The basis function definitions and mathematical identities are standard and correct. The problem is well-posed, providing all necessary geometric and mathematical information to arrive at a unique, computable solution. The language is objective and precise. The problem is non-trivial and tests core concepts of the discretization method. There are no contradictions, ambiguities, or unrealistic assumptions.\n\n**Step 3: Verdict and Action**\nThe problem is deemed **valid**. A full derivation and solution will be provided.\n\n### Derivation of the Coupling Integral\n\nThe goal is to derive an analytical expression for the coupling entry $C_{ij}$. This entry represents the weak-form coupling between an interior Nédélec basis function $\\boldsymbol{N}_{ij}$ and a surface RWG basis function $\\boldsymbol{f}$.\n\nThe total coupling is the sum of integrals over the two triangles $T^+$ and $T^-$ that constitute the support of $\\boldsymbol{f}$:\n$$C_{ij} = \\int_{T^+} \\boldsymbol{N}_{ij}(\\boldsymbol{r}) \\cdot \\boldsymbol{f}(\\boldsymbol{r}) \\, \\mathrm{d}S + \\int_{T^-} \\boldsymbol{N}_{ij}(\\boldsymbol{r}) \\cdot \\boldsymbol{f}(\\boldsymbol{r}) \\, \\mathrm{d}S$$\nThe Nédélec basis function $\\boldsymbol{N}_{ij}$ is associated with a specific tetrahedron. For a basis function on tetrahedron $A$, its support is limited to tetrahedron $A$. Since $T^-$ is not a face of tetrahedron $A$, the restriction of any basis function from $A$ to $T^-$ is zero. Consequently, for a basis function $\\boldsymbol{N}_{A,ij}$ from tetrahedron $A$, the coupling integral simplifies to:\n$$C_{A,ij} = \\int_{T^+} \\boldsymbol{N}_{A,ij}(\\boldsymbol{r}) \\cdot \\boldsymbol{f}(\\boldsymbol{r}) \\, \\mathrm{d}S$$\nSimilarly, for a basis function $\\boldsymbol{N}_{B,kl}$ from tetrahedron $B$, which has $T^-$ as a face, the coupling is:\n$$C_{B,kl} = \\int_{T^-} \\boldsymbol{N}_{B,kl}(\\boldsymbol{r}) \\cdot \\boldsymbol{f}(\\boldsymbol{r}) \\, \\mathrm{d}S$$\n\nLet us derive a general formula for the integral $I_T = \\int_T \\boldsymbol{N}_{ij}(\\boldsymbol{r}) \\cdot \\boldsymbol{f}(\\boldsymbol{r}) \\, \\mathrm{d}S$, where $T$ is a face of the tetrahedron supporting $\\boldsymbol{N}_{ij}$. We substitute the definitions:\n$$I_T = \\int_T \\left(\\lambda_i \\nabla \\lambda_j - \\lambda_j \\nabla \\lambda_i\\right) \\cdot \\alpha_T (\\boldsymbol{r} - \\boldsymbol{r}_{\\text{op}}) \\, \\mathrm{d}S$$\nwhere $\\alpha_T$ is the scalar coefficient of the RWG function on triangle $T$ and $\\boldsymbol{r}_{\\text{op}}$ is the opposite vertex. As the gradients $\\nabla\\lambda_k$ are constant vectors within the tetrahedron, we can take them and $\\alpha_T$ out of the integral:\n$$I_T = \\alpha_T \\left[ \\nabla \\lambda_j \\cdot \\int_T \\lambda_i (\\boldsymbol{r} - \\boldsymbol{r}_{\\text{op}}) \\, \\mathrm{d}S - \\nabla \\lambda_i \\cdot \\int_T \\lambda_j (\\boldsymbol{r} - \\boldsymbol{r}_{\\text{op}}) \\, \\mathrm{d}S \\right]$$\nLet's define the vector integral $\\boldsymbol{K}_k = \\int_T \\lambda_k (\\boldsymbol{r} - \\boldsymbol{r}_{\\text{op}}) \\, \\mathrm{d}S$. Then $I_T = \\alpha_T (\\nabla \\lambda_j \\cdot \\boldsymbol{K}_i - \\nabla \\lambda_i \\cdot \\boldsymbol{K}_j)$. The integral $\\boldsymbol{K}_k$ can be evaluated using the provided barycentric identities.\nThe functions $\\lambda_k$ are the barycentric coordinates of the tetrahedron. Let the tetrahedron have vertices $\\{\\boldsymbol{p}_0, \\boldsymbol{p}_1, \\boldsymbol{p}_2, \\boldsymbol{p}_3\\}$, and let triangle $T$ be the face with vertices $\\{\\boldsymbol{p}_a, \\boldsymbol{p}_b, \\boldsymbol{p}_c\\}$. On this face, the barycentric coordinate corresponding to the fourth vertex (not on the face) is zero. The other three tetrahedral barycentric coordinates, when restricted to $T$, behave exactly as the triangular barycentric coordinates of $T$.\nIf the index $k$ of a Nédélec basis vertex is not among the vertices of the face $T$ (i.e., $k \\notin \\{a,b,c\\}$), then $\\lambda_k(\\boldsymbol{r}) = 0$ for all $\\boldsymbol{r} \\in T$, which implies $\\boldsymbol{K}_k = \\boldsymbol{0}$. This correctly captures that an edge element not touching a face has no tangential trace on it.\nIf $k \\in \\{a,b,c\\}$, we expand $\\boldsymbol{K}_k$:\n$$\\boldsymbol{K}_k = \\int_T \\lambda_k \\boldsymbol{r} \\, \\mathrm{d}S - \\boldsymbol{r}_{\\text{op}} \\int_T \\lambda_k \\, \\mathrm{d}S$$\nUsing the identities, with $A_T$ being the area of triangle $T$:\n$\\int_T \\lambda_k \\, \\mathrm{d}S = A_T/3$.\n$\\int_T \\lambda_k \\boldsymbol{r} \\, \\mathrm{d}S = \\sum_{m \\in \\{a,b,c\\}} \\boldsymbol{p}_m \\int_T \\lambda_k \\lambda_m \\, \\mathrm{d}S = \\boldsymbol{p}_k (A_T/6) + \\sum_{m \\in \\{a,b,c\\}, m\\neq k} \\boldsymbol{p}_m (A_T/12) = \\frac{A_T}{12} (2\\boldsymbol{p}_k + \\sum_{m \\in \\{a,b,c\\}, m\\neq k} \\boldsymbol{p}_m) = \\frac{A_T}{12} (\\boldsymbol{p}_k + \\sum_{m \\in \\{a,b,c\\}} \\boldsymbol{p}_m)$.\nSubstituting these into the expression for $\\boldsymbol{K}_k$:\n$$\\boldsymbol{K}_k = \\frac{A_T}{12} \\left(\\boldsymbol{p}_k + \\sum_{m \\in \\{a,b,c\\}} \\boldsymbol{p}_m \\right) - \\boldsymbol{r}_{\\text{op}} \\frac{A_T}{3} = \\frac{A_T}{12} \\left(\\boldsymbol{p}_k + \\sum_{m \\in \\{a,b,c\\}} \\boldsymbol{p}_m - 4\\boldsymbol{r}_{\\text{op}}\\right)$$\nThe term $\\boldsymbol{N}_{ij} \\cdot \\boldsymbol{f}$ correctly handles the tangential coupling. The RWG function $\\boldsymbol{f}$ is tangential to the surface $\\Gamma$ by its definition. $\\boldsymbol{N}_{ij}$ can be decomposed into tangential and normal components, $\\boldsymbol{N}_{ij} = \\boldsymbol{N}_{ij,t} + \\boldsymbol{N}_{ij,n}$. The dot product is $\\boldsymbol{N}_{ij} \\cdot \\boldsymbol{f} = \\boldsymbol{N}_{ij,t} \\cdot \\boldsymbol{f} + \\boldsymbol{N}_{ij,n} \\cdot \\boldsymbol{f}$. Since $\\boldsymbol{f}$ is tangential, its dot product with the normal component $\\boldsymbol{N}_{ij,n}$ is zero, so $\\boldsymbol{N}_{ij,n} \\cdot \\boldsymbol{f} = 0$. Thus, the integral correctly captures the interaction between the tangential components of the fields, as required by electromagnetic boundary conditions.\n\n### Implementation Specifics\n\nThe implementation calculates this integral for each of the $12$ interior Nédélec basis functions.\n\n**1. Geometric Constants:**\n- $T^+$ has vertices $\\boldsymbol{v}_0, \\boldsymbol{v}_1, \\boldsymbol{v}_2$. Area $A^+ = 1/2$. $\\boldsymbol{r}^+_{\\text{op}} = \\boldsymbol{v}_0$.\n- $T^-$ has vertices $\\boldsymbol{v}_3, \\boldsymbol{v}_2, \\boldsymbol{v}_1$. Area $A^- = 1/2$. $\\boldsymbol{r}^-_{\\text{op}} = \\boldsymbol{v}_3$.\n- Common edge length $l_e = ||\\boldsymbol{v}_2 - \\boldsymbol{v}_1|| = \\sqrt{2}$.\n- RWG coefficient for $T^+$: $\\alpha_{T^+} = l_e / (2A^+) = \\sqrt{2}$.\n- RWG coefficient for $T^-$: $\\alpha_{T^-} = -l_e / (2A^-) = -\\sqrt{2}$.\n\n**2. Gradient Calculation:** For a tetrahedron with vertices $\\boldsymbol{p}_0, \\boldsymbol{p}_1, \\boldsymbol{p}_2, \\boldsymbol{p}_3$, we define the matrix $S = [\\boldsymbol{p}_1-\\boldsymbol{p}_0, \\boldsymbol{p}_2-\\boldsymbol{p}_0, \\boldsymbol{p}_3-\\boldsymbol{p}_0]$. The gradients of the barycentric coordinates $\\lambda_1, \\lambda_2, \\lambda_3$ are the rows of $S^{-1}$. The gradient $\\nabla\\lambda_0$ is computed from the sum property $\\sum_{k=0}^3 \\lambda_k = 1$, which implies $\\sum_{k=0}^3 \\nabla\\lambda_k = \\boldsymbol{0}$.\n\n**3. Coupling for Tetrahedron A:**\n- Local vertices: $(\\boldsymbol{p}_0, \\boldsymbol{p}_1, \\boldsymbol{p}_2, \\boldsymbol{p}_3)_{\\text{A}} = (\\boldsymbol{v}_0, \\boldsymbol{v}_1, \\boldsymbol{v}_2, \\boldsymbol{v}_4)$.\n- Interface face: $T^+$ with local vertices $\\{0,1,2\\}$.\n- The vector integrals $\\boldsymbol{K}_{A,k}$ are non-zero only for $k \\in \\{0,1,2\\}$.\n- The coupling for edge $(i,j)$ is $C_{A,ij} = \\alpha_{T^+} (\\nabla \\lambda_{Aj} \\cdot \\boldsymbol{K}_{A,i} - \\nabla \\lambda_{Ai} \\cdot \\boldsymbol{K}_{A,j})$.\n\n**4. Coupling for Tetrahedron B:**\n- Local vertices: $(\\boldsymbol{p}_0, \\boldsymbol{p}_1, \\boldsymbol{p}_2, \\boldsymbol{p}_3)_{\\text{B}} = (\\boldsymbol{v}_3, \\boldsymbol{v}_2, \\boldsymbol{v}_1, \\boldsymbol{v}_5)$.\n- Interface face: $T^-$ with local vertices $\\{0,1,2\\}$.\n- The vector integrals $\\boldsymbol{K}_{B,k}$ are non-zero only for $k \\in \\{0,1,2\\}$.\n- The coupling for edge $(k,l)$ is $C_{B,kl} = \\alpha_{T^-} (\\nabla \\lambda_{Bl} \\cdot \\boldsymbol{K}_{B,k} - \\nabla \\lambda_{Bk} \\cdot \\boldsymbol{K}_{B,l})$.\n\nThe program below implements this logic for the three test cases.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Derives and implements the FEM-BEM coupling matrix for the specified problem.\n    \"\"\"\n    # Define the surface vertices\n    v0 = np.array([0.0, 0.0, 0.0])\n    v1 = np.array([1.0, 0.0, 0.0])\n    v2 = np.array([0.0, 1.0, 0.0])\n    v3 = np.array([1.0, 1.0, 0.0])\n\n    # Test cases for the apex vertices v4 and v5\n    test_cases = [\n        (np.array([0.0, 0.0, 1.0]), np.array([1.0, 1.0, 1.0])),\n        (np.array([0.2, 0.1, 0.9]), np.array([0.8, 1.3, 1.1])),\n        (np.array([-0.1, 0.2, 0.7]), np.array([1.1, 0.9, 1.4])),\n    ]\n\n    all_results = []\n\n    # Geometric properties of the RWG basis support\n    # Triangle T+\n    T_plus_verts = [v0, v1, v2]\n    A_plus = 0.5 * np.linalg.norm(np.cross(v1 - v0, v2 - v0))\n    r_op_plus = v0\n\n    # Triangle T-\n    T_minus_verts = [v3, v2, v1]\n    A_minus = 0.5 * np.linalg.norm(np.cross(v2 - v3, v1 - v3))\n    r_op_minus = v3\n\n    # Common edge length for RWG\n    l_e = np.linalg.norm(v2 - v1)\n\n    # RWG coefficients\n    alpha_plus = l_e / (2 * A_plus)\n    alpha_minus = -l_e / (2 * A_minus)\n\n    # Local edge indexing for a tetrahedron\n    edges = [(0, 1), (0, 2), (0, 3), (1, 2), (1, 3), (2, 3)]\n\n    def compute_grads(p0, p1, p2, p3):\n        \"\"\"Computes the gradients of barycentric coordinates for a tetrahedron.\"\"\"\n        S = np.array([p1 - p0, p2 - p0, p3 - p0]).T\n        inv_S = np.linalg.inv(S)\n        grad1 = inv_S[0, :]\n        grad2 = inv_S[1, :]\n        grad3 = inv_S[2, :]\n        grad0 = -(grad1 + grad2 + grad3)\n        return [grad0, grad1, grad2, grad3]\n\n    def compute_K_vectors(face_verts, r_op, area):\n        \"\"\"Computes the vector integrals K_k for a triangular face.\"\"\"\n        p_a, p_b, p_c = face_verts\n        sum_p = p_a + p_b + p_c\n        K_vecs = {}\n        # k=a (local index 0 on face)\n        K_vecs[0] = (area / 12.0) * (p_a + sum_p - 4 * r_op)\n        # k=b (local index 1 on face)\n        K_vecs[1] = (area / 12.0) * (p_b + sum_p - 4 * r_op)\n        # k=c (local index 2 on face)\n        K_vecs[2] = (area / 12.0) * (p_c + sum_p - 4 * r_op)\n        return K_vecs\n\n    for v4, v5 in test_cases:\n        coupling_row = []\n\n        # === Tetrahedron A ===\n        tet_A_verts = [v0, v1, v2, v4]\n        grads_A = compute_grads(*tet_A_verts)\n        # Face T+ corresponds to local vertices 0, 1, 2 of Tet A\n        # The K vectors need to be indexed by local tet indices (0, 1, 2)\n        K_vecs_A_face = compute_K_vectors(T_plus_verts, r_op_plus, A_plus)\n        K_A = {0: K_vecs_A_face[0], 1: K_vecs_A_face[1], 2: K_vecs_A_face[2], 3: np.zeros(3)}\n        \n        for i, j in edges:\n            K_i = K_A[i]\n            K_j = K_A[j]\n            grad_i = grads_A[i]\n            grad_j = grads_A[j]\n            \n            C_ij = alpha_plus * (np.dot(grad_j, K_i) - np.dot(grad_i, K_j))\n            coupling_row.append(C_ij)\n\n        # === Tetrahedron B ===\n        tet_B_verts = [v3, v2, v1, v5]\n        grads_B = compute_grads(*tet_B_verts)\n        # Face T- corresponds to local vertices 0, 1, 2 of Tet B\n        K_vecs_B_face = compute_K_vectors(T_minus_verts, r_op_minus, A_minus)\n        K_B = {0: K_vecs_B_face[0], 1: K_vecs_B_face[1], 2: K_vecs_B_face[2], 3: np.zeros(3)}\n\n        for i, j in edges:\n            K_i = K_B[i]\n            K_j = K_B[j]\n            grad_i = grads_B[i]\n            grad_j = grads_B[j]\n            \n            C_ij = alpha_minus * (np.dot(grad_j, K_i) - np.dot(grad_i, K_j))\n            coupling_row.append(C_ij)\n            \n        all_results.append(coupling_row)\n\n    # Format the final output string exactly as required\n    output_str = f\"[{','.join([f'[{\",\".join(map(str, row))}]' for row in all_results])}]\"\n    print(output_str)\n\nsolve()\n```", "id": "3315828"}, {"introduction": "A robust numerical simulation must not only be mathematically consistent but also physically correct. This practice demonstrates how to use a fundamental physical principle, the conservation of energy, as a powerful tool for code verification and model validation. Starting from Maxwell's equations and the complex Poynting theorem, you will derive a power balance identity for the hybrid FE-BI system and use it to construct a quantitative diagnostic to detect modeling errors in material properties or interface coupling. [@problem_id:3315798]", "problem": "Consider a time-harmonic electromagnetic field with the $\\exp(+j \\omega t)$ convention in a bounded interior region $V \\subset \\mathbb{R}^{3}$ with boundary $S = \\partial V$ and unit outward normal $\\mathbf{n}$. The interior has permeability $\\mu_{0}$ and complex permittivity $\\epsilon(\\omega) = \\epsilon'(\\omega) - j \\epsilon''(\\omega)$ with $\\epsilon''(\\omega) \\ge 0$. The exterior domain is free space. A hybrid finite element–boundary integral (FE–BI) formulation truncates the computation to $V$ and represents the exterior via a boundary integral radiation operator. Let $\\mathbf{E}$ and $\\mathbf{H}$ denote the total macroscopic fields in $V$ produced by an impressed current density $\\mathbf{J}_{\\text{imp}}$ supported in $V$. On $S$, let $\\mathbf{e}_{t} = \\mathbf{n} \\times \\mathbf{E}|_{S}$ be the tangential electric trace. The exterior is represented by a passive linear radiation operator $\\mathcal{T}$ mapping $\\mathbf{e}_{t}$ to the exterior magnetic trace, $\\mathbf{n} \\times \\mathbf{H}^{\\text{ext}} = \\mathcal{T}\\,\\mathbf{e}_{t}$. Assume $\\mathcal{T}$ is passive in the sense that $\\Re \\langle \\mathbf{e}_{t}, \\mathcal{T}\\,\\mathbf{e}_{t} \\rangle_{S} \\ge 0$ for all square-integrable tangential traces, with the surface inner product $\\langle \\mathbf{u}, \\mathbf{v} \\rangle_{S} = \\int_{S} \\mathbf{u} \\cdot \\mathbf{v}^{*}\\, \\mathrm{d}S$.\n\n1) Starting only from Maxwell’s curl equations and the complex Poynting theorem, derive the time-average energy conservation identity that relates the real input power from the impressed sources in $V$ to the sum of interior dissipated power in $V$ and exterior radiated power represented by $\\mathcal{T}$, expressed as\n$$\n\\Re \\int_{V} \\mathbf{J}_{\\text{imp}} \\cdot \\mathbf{E}^{*}\\, \\mathrm{d}V \\;=\\; \\frac{\\omega}{2} \\int_{V} \\epsilon''(\\omega)\\, |\\mathbf{E}|^{2}\\, \\mathrm{d}V \\;+\\; \\frac{1}{2}\\, \\Re \\langle \\mathbf{e}_{t}, \\mathcal{T}\\,\\mathbf{e}_{t} \\rangle_{S}.\n$$\nClearly state the sign conventions adopted and justify the boundary-integral representation of the outward radiated power.\n\n2) To obtain a one-degree-of-freedom calibration model, suppose the FE trace space on $S$ is one-dimensional: $\\mathbf{e}_{t} = x\\, \\boldsymbol{\\phi}_{t}$ with $\\langle \\boldsymbol{\\phi}_{t}, \\boldsymbol{\\phi}_{t} \\rangle_{S} = 1$, and suppose the FE interior dissipation quadratic form reduces to\n$$\nP_{\\text{diss}} = \\frac{\\omega}{2}\\, \\epsilon''(\\omega)\\, C\\, |x|^{2},\n$$\nfor some known positive constant $C$ determined by the interior basis functions and material distribution. Further assume the radiation operator reduces to a scalar impedance $Z_{\\text{rad}}(\\omega) \\in \\mathbb{C}$ on this subspace, so that\n$$\nP_{\\text{rad}} = \\frac{1}{2}\\, \\Re\\{ Z_{\\text{rad}}(\\omega) \\}\\, |x|^{2}.\n$$\nConsider a practical calibration in which the drive amplitude and frequency are chosen so that, for the correct model, the interior dissipation equals the exterior radiated power, i.e., $P_{\\text{diss}} = P_{\\text{rad}}$. Using the result of part 1), show that this implies the scalar equality\n$$\n\\Re\\{ Z_{\\text{rad}}(\\omega) \\} \\;=\\; \\omega\\, \\epsilon''(\\omega)\\, C.\n$$\n\n3) Now, suppose a modeling error is present: the implemented permittivity loss uses $\\epsilon''_{\\text{FE}}(\\omega) = \\epsilon''(\\omega)\\, \\big(1 + \\Delta_{\\epsilon}\\big)$ with real $\\Delta_{\\epsilon}$, and the FE–BI trace coupling has a multiplicative mismatch so that the BI receives a scaled trace $\\tilde{\\mathbf{e}}_{t} = s\\, \\mathbf{e}_{t}$ with $s = 1 + \\Delta_{t}$, where $\\Delta_{t}$ is real. Treat these as post-processing errors on a fixed interior amplitude $x$ obtained from the correct model. Define the power-balance diagnostic residual\n$$\nR \\;\\equiv\\; \\frac{P_{\\text{rad}}^{\\text{err}} - P_{\\text{diss}}^{\\text{err}}}{P_{\\text{rad}}^{\\text{err}} + P_{\\text{diss}}^{\\text{err}}},\n$$\nwhere $P_{\\text{rad}}^{\\text{err}}$ is computed by the BI from $\\tilde{\\mathbf{e}}_{t}$ and $P_{\\text{diss}}^{\\text{err}}$ is the FE dissipation computed with $\\epsilon''_{\\text{FE}}(\\omega)$. Using the calibration equality you derived in part 2) to eliminate $C$ and $\\Re\\{ Z_{\\text{rad}}(\\omega) \\}$, derive a closed-form analytic expression for $R$ as a function of $\\Delta_{\\epsilon}$ and $\\Delta_{t}$ only. Provide your final expression for $R$ in simplest form. The final answer must be a single analytic expression with no units.", "solution": "The problem is assessed to be valid as it is scientifically grounded in Maxwell's theory and computational electromagnetics, is well-posed with a clear and logical structure, and uses precise, objective language. All necessary information is provided for a unique solution.\n\n**Part 1: Derivation of the Energy Conservation Identity**\n\nWe begin with the time-harmonic form of Maxwell's curl equations, assuming a time dependence of $\\exp(+j \\omega t)$. The permeability is $\\mu_0$ and the complex permittivity is $\\epsilon(\\omega) = \\epsilon'(\\omega) - j \\epsilon''(\\omega)$.\n\nFaraday's Law of Induction:\n$$ \\nabla \\times \\mathbf{E} = -j \\omega \\mathbf{B} = -j \\omega \\mu_{0} \\mathbf{H} $$\n\nAmpere-Maxwell Law:\nThe total current density is $\\mathbf{J}_{\\text{tot}} = \\mathbf{J}_{\\text{imp}} + j \\omega \\mathbf{D}$, where $\\mathbf{J}_{\\text{imp}}$ is the impressed source current and $j \\omega \\mathbf{D}$ is the displacement current. With $\\mathbf{D} = \\epsilon \\mathbf{E} = (\\epsilon' - j \\epsilon'')\\mathbf{E}$, the law becomes:\n$$ \\nabla \\times \\mathbf{H} = \\mathbf{J}_{\\text{imp}} + j \\omega (\\epsilon' - j \\epsilon'') \\mathbf{E} = \\mathbf{J}_{\\text{imp}} + \\omega \\epsilon'' \\mathbf{E} + j \\omega \\epsilon' \\mathbf{E} $$\nThe term $\\omega \\epsilon'' \\mathbf{E}$ represents the ohmic loss current density, consistent with a conductivity $\\sigma = \\omega \\epsilon''$.\n\nWe use the vector identity $\\nabla \\cdot (\\mathbf{A} \\times \\mathbf{B}) = \\mathbf{B} \\cdot (\\nabla \\times \\mathbf{A}) - \\mathbf{A} \\cdot (\\nabla \\times \\mathbf{B})$. Let $\\mathbf{A} = \\mathbf{E}$ and $\\mathbf{B} = \\mathbf{H}^{*}$.\n$$ \\nabla \\cdot (\\mathbf{E} \\times \\mathbf{H}^{*}) = \\mathbf{H}^{*} \\cdot (\\nabla \\times \\mathbf{E}) - \\mathbf{E} \\cdot (\\nabla \\times \\mathbf{H}^{*}) $$\nSubstitute the curl of $\\mathbf{E}$ from Faraday's law:\n$$ \\mathbf{H}^{*} \\cdot (\\nabla \\times \\mathbf{E}) = \\mathbf{H}^{*} \\cdot (-j \\omega \\mu_0 \\mathbf{H}) = -j \\omega \\mu_0 |\\mathbf{H}|^2 $$\nTake the complex conjugate of the Ampere-Maxwell law (noting $\\omega, \\epsilon', \\epsilon''$ are real):\n$$ \\nabla \\times \\mathbf{H}^{*} = \\mathbf{J}_{\\text{imp}}^{*} + \\omega \\epsilon'' \\mathbf{E}^{*} - j \\omega \\epsilon' \\mathbf{E}^{*} $$\nSubstitute this into the identity:\n$$ \\mathbf{E} \\cdot (\\nabla \\times \\mathbf{H}^{*}) = \\mathbf{E} \\cdot \\mathbf{J}_{\\text{imp}}^{*} + \\omega \\epsilon'' |\\mathbf{E}|^2 - j \\omega \\epsilon' |\\mathbf{E}|^2 $$\nCombining these results gives the differential form of the complex Poynting theorem:\n$$ \\nabla \\cdot (\\mathbf{E} \\times \\mathbf{H}^{*}) = -j \\omega \\mu_0 |\\mathbf{H}|^2 - (\\mathbf{E} \\cdot \\mathbf{J}_{\\text{imp}}^{*} + \\omega \\epsilon'' |\\mathbf{E}|^2 - j \\omega \\epsilon' |\\mathbf{E}|^2) $$\n$$ - \\mathbf{E} \\cdot \\mathbf{J}_{\\text{imp}}^{*} = \\nabla \\cdot (\\mathbf{E} \\times \\mathbf{H}^{*}) + \\omega \\epsilon'' |\\mathbf{E}|^2 + j \\omega (\\mu_0 |\\mathbf{H}|^2 - \\epsilon' |\\mathbf{E}|^2) $$\nIntegrating over the volume $V$:\n$$ -\\int_{V} \\mathbf{E} \\cdot \\mathbf{J}_{\\text{imp}}^{*} \\, \\mathrm{d}V = \\int_{V} \\nabla \\cdot (\\mathbf{E} \\times \\mathbf{H}^{*}) \\, \\mathrm{d}V + \\int_{V} \\omega \\epsilon'' |\\mathbf{E}|^2 \\, \\mathrm{d}V + j \\omega \\int_{V} (\\mu_0 |\\mathbf{H}|^2 - \\epsilon' |\\mathbf{E}|^2) \\, \\mathrm{d}V $$\nApplying the divergence theorem to the first term on the right-hand side:\n$$ \\int_{V} \\nabla \\cdot (\\mathbf{E} \\times \\mathbf{H}^{*}) \\, \\mathrm{d}V = \\oint_{S} (\\mathbf{E} \\times \\mathbf{H}^{*}) \\cdot \\mathbf{n} \\, \\mathrm{d}S $$\nTaking the real part of the entire equation:\n$$ \\Re \\left\\{ -\\int_{V} \\mathbf{E} \\cdot \\mathbf{J}_{\\text{imp}}^{*} \\, \\mathrm{d}V \\right\\} = \\Re \\left\\{ \\oint_{S} (\\mathbf{E} \\times \\mathbf{H}^{*}) \\cdot \\mathbf{n} \\, \\mathrm{d}S \\right\\} + \\int_{V} \\omega \\epsilon'' |\\mathbf{E}|^2 \\, \\mathrm{d}V $$\nThe time-average power supplied by the impressed sources is $P_{\\text{in}} = \\frac{1}{2}\\Re \\int_V \\mathbf{J}_{\\text{imp}} \\cdot \\mathbf{E}^* \\, \\mathrm{d}V$. Note that $\\Re\\{z\\} = \\Re\\{z^*\\}$, so $\\Re\\{\\mathbf{J}_{\\text{imp}} \\cdot \\mathbf{E}^*\\} = \\Re\\{(\\mathbf{J}_{\\text{imp}} \\cdot \\mathbf{E}^*)^*\\} = \\Re\\{\\mathbf{J}_{\\text{imp}}^* \\cdot \\mathbf{E}\\}$. Also $\\Re\\{-z\\} = -\\Re\\{z\\}$. Thus, the left-hand side is $-2 P_{\\text{in}}$. Let me re-evaluate the source power definition. Common convention defines power *delivered by* the source as $\\frac{1}{2}\\Re \\int_V \\mathbf{J}_{\\text{imp}} \\cdot \\mathbf{E}^* dV$. This implies a sign change needed in my development. Let's work from the other side.\n The time-average power delivered by the sources is $P_{\\text{in}} = -\\frac{1}{2} \\Re \\int_V \\mathbf{E} \\cdot \\mathbf{J}_{\\text{imp}}^* \\, \\mathrm{d}V = \\frac{1}{2} \\Re \\int_V \\mathbf{J}_{\\text{imp}} \\cdot \\mathbf{E}^* \\, \\mathrm{d}V$.\n The time-average power dissipated as heat in $V$ is $P_{\\text{diss}} = \\frac{1}{2} \\int_V \\omega \\epsilon'' |\\mathbf{E}|^2 \\, \\mathrm{d}V$.\n The time-average power radiated out of $V$ is $P_{\\text{rad}} = \\frac{1}{2} \\Re \\oint_S (\\mathbf{E} \\times \\mathbf{H}^*) \\cdot \\mathbf{n} \\, \\mathrm{d}S$.\nMultiplying our integrated Poynting relation by $\\frac{1}{2}$:\n$$ \\frac{1}{2} \\Re \\left\\{ -\\int_{V} \\mathbf{E} \\cdot \\mathbf{J}_{\\text{imp}}^{*} \\, \\mathrm{d}V \\right\\} = \\frac{1}{2} \\Re \\left\\{ \\oint_{S} (\\mathbf{E} \\times \\mathbf{H}^{*}) \\cdot \\mathbf{n} \\, \\mathrm{d}S \\right\\} + \\frac{1}{2} \\int_{V} \\omega \\epsilon'' |\\mathbf{E}|^2 \\, \\mathrm{d}V $$\n$$ P_{\\text{in}} = P_{\\text{rad}} + P_{\\text{diss}} $$\n$$ \\frac{1}{2} \\Re \\int_{V} \\mathbf{J}_{\\text{imp}} \\cdot \\mathbf{E}^{*}\\, \\mathrm{d}V = \\frac{\\omega}{2} \\int_{V} \\epsilon''(\\omega)\\, |\\mathbf{E}|^{2}\\, \\mathrm{d}V + \\frac{1}{2} \\Re \\oint_{S} (\\mathbf{E} \\times \\mathbf{H}^{*}) \\cdot \\mathbf{n}\\, \\mathrm{d}S $$\nThe final step is to justify the boundary-integral representation of the outward radiated power. The fields in the exterior region are uniquely determined by the tangential electric field trace $\\mathbf{e}_t = \\mathbf{n} \\times \\mathbf{E}|_S$ on the boundary $S$ (subject to the Silver-Müller radiation condition). This implies that the tangential magnetic field on the boundary is also determined by $\\mathbf{e}_t$. For a linear medium like free space, this relationship is linear and can be written as $\\mathbf{n} \\times \\mathbf{H}^{\\text{ext}} = \\mathcal{T}\\,\\mathbf{e}_{t}$, where $\\mathcal{T}$ is the linear radiation operator. The total radiated power $P_{\\text{rad}}$ must therefore be expressible as a quadratic function of $\\mathbf{e}_t$. The problem provides this expression as $\\frac{1}{2}\\, \\Re \\langle \\mathbf{e}_{t}, \\mathcal{T}\\,\\mathbf{e}_{t} \\rangle_{S}$. By replacing the Poynting flux integral with this equivalent representation, we obtain the final identity:\n$$ \\Re \\int_{V} \\mathbf{J}_{\\text{imp}} \\cdot \\mathbf{E}^{*}\\, \\mathrm{d}V \\;=\\; \\frac{\\omega}{2} \\int_{V} \\epsilon''(\\omega)\\, |\\mathbf{E}|^{2}\\, \\mathrm{d}V \\;+\\; \\frac{1}{2}\\, \\Re \\langle \\mathbf{e}_{t}, \\mathcal{T}\\,\\mathbf{e}_{t} \\rangle_{S} $$\nNote that the factor of $1/2$ has been absorbed into the definition of the terms in the target equation, so my derivation is consistent with it.\n\n**Part 2: Calibration Model Equality**\n\nThe energy conservation identity from Part 1 equates the total input power to the sum of interior dissipated power and exterior radiated power: $P_{\\text{in}} = P_{\\text{diss}} + P_{\\text{rad}}$. The terms are given by:\n$$ P_{\\text{diss}} = \\frac{\\omega}{2} \\int_{V} \\epsilon''(\\omega)\\, |\\mathbf{E}|^{2}\\, \\mathrm{d}V $$\n$$ P_{\\text{rad}} = \\frac{1}{2}\\, \\Re \\langle \\mathbf{e}_{t}, \\mathcal{T}\\,\\mathbf{e}_{t} \\rangle_{S} $$\nIn the one-degree-of-freedom model, these quantities are simplified. The interior dissipated power is given as:\n$$ P_{\\text{diss}} = \\frac{\\omega}{2}\\, \\epsilon''(\\omega)\\, C\\, |x|^{2} $$\nThe radiated power is given as:\n$$ P_{\\text{rad}} = \\frac{1}{2}\\, \\Re\\{ Z_{\\text{rad}}(\\omega) \\}\\, |x|^{2} $$\nThis expression for $P_{\\text{rad}}$ arises from substituting $\\mathbf{e}_t = x\\,\\boldsymbol{\\phi}_t$ into the general form, where $Z_{\\text{rad}}(\\omega) = \\langle \\boldsymbol{\\phi}_t, \\mathcal{T} \\boldsymbol{\\phi}_t \\rangle_S$.\nThe calibration condition is that the interior dissipation equals the exterior radiated power: $P_{\\text{diss}} = P_{\\text{rad}}$.\nSubstituting the model expressions into this condition:\n$$ \\frac{\\omega}{2}\\, \\epsilon''(\\omega)\\, C\\, |x|^{2} = \\frac{1}{2}\\, \\Re\\{ Z_{\\text{rad}}(\\omega) \\}\\, |x|^{2} $$\nAssuming a non-trivial solution ($x \\neq 0$), we can divide both sides by $\\frac{1}{2}|x|^2$ to obtain the desired scalar equality:\n$$ \\omega\\, \\epsilon''(\\omega)\\, C = \\Re\\{ Z_{\\text{rad}}(\\omega) \\} $$\n\n**Part 3: Power-Balance Diagnostic Residual**\n\nWe are given a diagnostic residual $R$ defined in terms of erroneous power calculations:\n$$ R = \\frac{P_{\\text{rad}}^{\\text{err}} - P_{\\text{diss}}^{\\text{err}}}{P_{\\text{rad}}^{\\text{err}} + P_{\\text{diss}}^{\\text{err}}} $$\nThe erroneous dissipated power, $P_{\\text{diss}}^{\\text{err}}$, is calculated using the incorrect permittivity loss $\\epsilon''_{\\text{FE}}(\\omega) = \\epsilon''(\\omega)\\,(1 + \\Delta_{\\epsilon})$. The calculation is based on the correct field amplitude $x$.\n$$ P_{\\text{diss}}^{\\text{err}} = \\frac{\\omega}{2}\\, \\epsilon''_{\\text{FE}}(\\omega)\\, C\\, |x|^{2} = \\frac{\\omega}{2}\\, \\epsilon''(\\omega)\\,(1 + \\Delta_{\\epsilon})\\, C\\, |x|^{2} $$\nThe erroneous radiated power, $P_{\\text{rad}}^{\\text{err}}$, is calculated from a scaled tangential trace $\\tilde{\\mathbf{e}}_{t} = s\\,\\mathbf{e}_{t}$, where $s = 1 + \\Delta_{t}$ is a real scaling factor.\n$$ P_{\\text{rad}}^{\\text{err}} = \\frac{1}{2}\\, \\Re \\langle \\tilde{\\mathbf{e}}_{t}, \\mathcal{T}\\,\\tilde{\\mathbf{e}}_{t} \\rangle_{S} = \\frac{1}{2}\\, \\Re \\langle s\\,\\mathbf{e}_{t}, \\mathcal{T}\\,(s\\,\\mathbf{e}_{t}) \\rangle_{S} $$\nUsing the linearity of $\\mathcal{T}$ and properties of the inner product:\n$$ P_{\\text{rad}}^{\\text{err}} = \\frac{1}{2}\\, \\Re \\{ s s^* \\langle \\mathbf{e}_{t}, \\mathcal{T}\\,\\mathbf{e}_{t} \\rangle_{S} \\} = \\frac{1}{2}\\, |s|^2 \\Re \\langle \\mathbf{e}_{t}, \\mathcal{T}\\,\\mathbf{e}_{t} \\rangle_{S} $$\nSince $s$ is real, $|s|^2 = s^2 = (1+\\Delta_t)^2$. The term $\\frac{1}{2}\\, \\Re \\langle \\mathbf{e}_{t}, \\mathcal{T}\\,\\mathbf{e}_{t} \\rangle_{S}$ is the correct radiated power $P_{\\text{rad}} = \\frac{1}{2} \\Re\\{Z_{\\text{rad}}\\} |x|^2$.\n$$ P_{\\text{rad}}^{\\text{err}} = (1+\\Delta_t)^2 \\left( \\frac{1}{2}\\, \\Re\\{ Z_{\\text{rad}}(\\omega) \\}\\, |x|^{2} \\right) $$\nNow, we substitute these expressions for $P_{\\text{diss}}^{\\text{err}}$ and $P_{\\text{rad}}^{\\text{err}}$ into the formula for $R$:\n$$ R = \\frac{(1+\\Delta_t)^2 \\left( \\frac{1}{2}\\, \\Re\\{Z_{\\text{rad}}\\} |x|^2 \\right) - \\frac{\\omega}{2}\\, \\epsilon''(1+\\Delta_\\epsilon) C |x|^2}{(1+\\Delta_t)^2 \\left( \\frac{1}{2}\\, \\Re\\{Z_{\\text{rad}}\\} |x|^2 \\right) + \\frac{\\omega}{2}\\, \\epsilon''(1+\\Delta_\\epsilon) C |x|^2} $$\nThe common factor $\\frac{1}{2}|x|^2$ cancels from the numerator and denominator:\n$$ R = \\frac{(1+\\Delta_t)^2 \\Re\\{Z_{\\text{rad}}\\} - \\omega \\epsilon''(1+\\Delta_\\epsilon) C}{(1+\\Delta_t)^2 \\Re\\{Z_{\\text{rad}}\\} + \\omega \\epsilon''(1+\\Delta_\\epsilon) C} $$\nWe now use the calibration equality derived in Part 2: $\\Re\\{ Z_{\\text{rad}}(\\omega) \\} = \\omega\\, \\epsilon''(\\omega)\\, C$. Let's denote this common value by $K_0$. Substituting $K_0$ for both $\\Re\\{Z_{\\text{rad}}\\}$ and $\\omega \\epsilon'' C$:\n$$ R = \\frac{(1+\\Delta_t)^2 K_0 - (1+\\Delta_\\epsilon) K_0}{(1+\\Delta_t)^2 K_0 + (1+\\Delta_\\epsilon) K_0} $$\nSince $K_0 = \\omega \\epsilon'' C > 0$, we can cancel $K_0$ from the numerator and denominator:\n$$ R = \\frac{(1+\\Delta_t)^2 - (1+\\Delta_\\epsilon)}{(1+\\Delta_t)^2 + (1+\\Delta_\\epsilon)} $$\nFinally, we expand the terms to obtain the simplest form:\n$$ (1+\\Delta_t)^2 = 1 + 2\\Delta_t + \\Delta_t^2 $$\n$$ R = \\frac{(1 + 2\\Delta_t + \\Delta_t^2) - (1 + \\Delta_\\epsilon)}{(1 + 2\\Delta_t + \\Delta_t^2) + (1 + \\Delta_\\epsilon)} = \\frac{2\\Delta_t + \\Delta_t^2 - \\Delta_\\epsilon}{2 + 2\\Delta_t + \\Delta_t^2 + \\Delta_\\epsilon} $$\nThis expression for $R$ depends only on the modeling error parameters $\\Delta_t$ and $\\Delta_\\epsilon$, as required.\nRe-ordering the terms to group by powers of $\\Delta_t$:\n$$ R = \\frac{\\Delta_t^2 + 2\\Delta_t - \\Delta_\\epsilon}{\\Delta_t^2 + 2\\Delta_t + \\Delta_\\epsilon + 2} $$", "answer": "$$\\boxed{\\frac{\\Delta_t^2 + 2\\Delta_t - \\Delta_\\epsilon}{\\Delta_t^2 + 2\\Delta_t + \\Delta_\\epsilon + 2}}$$", "id": "3315798"}, {"introduction": "Achieving high accuracy in large-scale electromagnetic simulations requires an efficient allocation of computational resources. This final practice introduces goal-oriented adaptive mesh refinement (AMR), an advanced strategy for automatically optimizing the computational mesh to meet a desired accuracy target. You will implement an algorithm that uses a posteriori error estimators to intelligently decide whether to refine the interior volume mesh or the exterior boundary mesh, maximizing the error reduction per unit of computational cost. [@problem_id:3315744]", "problem": "Consider time-harmonic electromagnetic scattering in free space where the electric field $\\mathbf{E}$ with angular frequency $\\omega$ satisfies Maxwell’s equations. In a hybrid discretization that couples the Finite Element Method (FEM) in a bounded volume domain $\\Omega$ with a Boundary Integral (BI) equation on the enclosing surface $\\Gamma$, the FEM approximates the interior field while the BI enforces the radiation condition and represents the exterior field. The hybrid finite element–boundary integral method seeks $\\mathbf{E}_h$ such that the volume weak form and the boundary integral coupling conditions are both satisfied. The far-field amplitude in a given observation direction is a linear functional $J(\\mathbf{E})$ of the electromagnetic field (for example, via the Stratton–Chu representation), and the quantity of interest is the far-field error $|J(\\mathbf{E}) - J(\\mathbf{E}_h)|$.\n\nStarting from the time-harmonic Maxwell curl–curl equation in the interior,\n$$\n\\nabla \\times \\left( \\mu^{-1} \\nabla \\times \\mathbf{E} \\right) - \\omega^2 \\varepsilon \\mathbf{E} = \\mathbf{0} \\quad \\text{in } \\Omega,\n$$\nwith $\\mu$ the magnetic permeability and $\\varepsilon$ the electric permittivity, and from a boundary integral formulation on $\\Gamma$ that enforces the outgoing radiation condition in the exterior, goal-oriented a posteriori error analysis yields an error representation that decomposes the far-field error into contributions from volume residuals and boundary residuals weighted by the adjoint (dual) solution. Denote by the set of tetrahedral volume elements $\\{K_i\\}_{i=1}^{N_{\\mathrm{vol}}}$ with characteristic sizes $\\{h_i^{\\mathrm{vol}}\\}$ and by the set of triangular surface elements $\\{T_j\\}_{j=1}^{N_{\\mathrm{surf}}}$ with characteristic sizes $\\{h_j^{\\mathrm{surf}}\\}$. Let the free-space speed of light be $c = 2.99792458 \\times 10^8\\,\\mathrm{m/s}$ and the wavenumber be $k = 2\\pi f/c$, where $f$ is the frequency in $\\mathrm{Hz}$.\n\nDefine computable local indicators for the volume and surface contributions that scale with mesh size and wavenumber,\n$$\n\\eta_i^{\\mathrm{vol}} = A_{\\mathrm{vol}} \\left(k\\, h_i^{\\mathrm{vol}}\\right)^{p_{\\mathrm{vol}}} \\rho_i, \\quad\n\\eta_j^{\\mathrm{surf}} = A_{\\mathrm{surf}} \\left(k\\, h_j^{\\mathrm{surf}}\\right)^{p_{\\mathrm{surf}}} \\sigma_j,\n$$\nwhere $A_{\\mathrm{vol}}$ and $A_{\\mathrm{surf}}$ are positive scaling constants reflecting material contrast and discretization order, $p_{\\mathrm{vol}}>0$ and $p_{\\mathrm{surf}}>0$ are convergence exponents, and $\\rho_i>0$, $\\sigma_j>0$ are computable residual amplitudes. Let $w_i^{\\mathrm{vol}}$ and $w_j^{\\mathrm{surf}}$ be positive adjoint-based influence weights that reflect the sensitivity of the far-field functional $J(\\mathbf{E})$ to perturbations in the corresponding elements. In this problem, assume the weights are modeled by\n$$\nw_i^{\\mathrm{vol}} = \\frac{1}{1 + \\left(k\\, h_i^{\\mathrm{vol}}\\right)^2}, \\qquad\nw_j^{\\mathrm{surf}} = \\frac{1}{1 + \\left(k\\, h_j^{\\mathrm{surf}}\\right)}.\n$$\nDefine the far-field error estimator as\n$$\n\\mathcal{E}_{\\mathrm{ff}} = \\left( \\sum_{i=1}^{N_{\\mathrm{vol}}} w_i^{\\mathrm{vol}} \\left(\\eta_i^{\\mathrm{vol}}\\right)^2 + \\sum_{j=1}^{N_{\\mathrm{surf}}} w_j^{\\mathrm{surf}} \\left(\\eta_j^{\\mathrm{surf}}\\right)^2 \\right)^{1/2},\n$$\nand suppose that refining a volume element $K_i$ halves its size $h_i^{\\mathrm{vol}} \\mapsto h_i^{\\mathrm{vol}}/2$, and similarly for a surface element $T_j$ where $h_j^{\\mathrm{surf}} \\mapsto h_j^{\\mathrm{surf}}/2$. Under this refinement, the indicators contract according to the scaling exponents:\n$$\n\\eta_i^{\\mathrm{vol}} \\mapsto 2^{-p_{\\mathrm{vol}}}\\, \\eta_i^{\\mathrm{vol}}, \\qquad\n\\eta_j^{\\mathrm{surf}} \\mapsto 2^{-p_{\\mathrm{surf}}}\\, \\eta_j^{\\mathrm{surf}},\n$$\nand the weights update with the new sizes. Let the computational cost of one refinement of a volume element be $c_{\\mathrm{vol}}>0$ and for a surface element be $c_{\\mathrm{surf}}>0$.\n\nTask. Propose and implement an adaptive refinement algorithm that, at each iteration, selects either one volume tetrahedron or one surface triangle to refine in order to minimize the far-field error estimator $\\mathcal{E}_{\\mathrm{ff}}$ subject to a target tolerance $\\varepsilon_{\\mathrm{ff}}$. The selection must balance volume and surface refinements by maximizing the predicted error reduction per unit cost. That is, for each candidate element, predict the decrease in $\\mathcal{E}_{\\mathrm{ff}}^2$ due to halving its size using the given indicator and weight models, and select the element that maximizes the ratio of predicted decrease to refinement cost. Repeat until $\\mathcal{E}_{\\mathrm{ff}} \\le \\varepsilon_{\\mathrm{ff}}$ or a maximum number of iterations is reached. The program must output, for each test case, a list containing the boolean indicating whether the tolerance was achieved, the total number of iterations, the total number of volume refinements, the total number of surface refinements, and the final estimated far-field error $\\mathcal{E}_{\\mathrm{ff}}$.\n\nUse the following deterministic residual amplitudes:\n$$\n\\rho_i = \\frac{1}{1+i}, \\qquad \\sigma_j = \\frac{1}{1+j}.\n$$\nUse the following deterministic initial element sizes:\n$$\nh_i^{\\mathrm{vol}} = \\bar{h}_{\\mathrm{vol}} \\left(1 + 0.3\\sin(i)\\right), \\qquad\nh_j^{\\mathrm{surf}} = \\bar{h}_{\\mathrm{surf}} \\left(1 + 0.3\\cos(j)\\right),\n$$\nwith $\\bar{h}_{\\mathrm{vol}}>0$ and $\\bar{h}_{\\mathrm{surf}}>0$.\n\nImplement the algorithm in a single program that runs without any external input and produces the results for the following test suite. All physical quantities must use International System of Units (SI). Frequencies must be in $\\mathrm{Hz}$, lengths in $\\mathrm{m}$, and the far-field error tolerance and estimator must be dimensionless. The final far-field error must be reported as a decimal number.\n\nTest suite:\n- Case $1$ (happy path): $f = 3.0\\times 10^9\\,\\mathrm{Hz}$, $L = 0.1\\,\\mathrm{m}$, $N_{\\mathrm{vol}} = 32$, $N_{\\mathrm{surf}} = 64$, $\\bar{h}_{\\mathrm{vol}} = L/20$, $\\bar{h}_{\\mathrm{surf}} = L/30$, $A_{\\mathrm{vol}} = 1.0$, $A_{\\mathrm{surf}} = 1.0$, $p_{\\mathrm{vol}} = 1.0$, $p_{\\mathrm{surf}} = 1.0$, $c_{\\mathrm{vol}} = 2.0$, $c_{\\mathrm{surf}} = 1.0$, $\\varepsilon_{\\mathrm{ff}} = 1.0\\times 10^{-3}$, maximum iterations $= 1000$.\n- Case $2$ (tight tolerance boundary): $f = 1.0\\times 10^{10}\\,\\mathrm{Hz}$, $L = 0.2\\,\\mathrm{m}$, $N_{\\mathrm{vol}} = 40$, $N_{\\mathrm{surf}} = 80$, $\\bar{h}_{\\mathrm{vol}} = 0.01\\,\\mathrm{m}$, $\\bar{h}_{\\mathrm{surf}} = 0.007\\,\\mathrm{m}$, $A_{\\mathrm{vol}} = 1.0$, $A_{\\mathrm{surf}} = 1.5$, $p_{\\mathrm{vol}} = 1.0$, $p_{\\mathrm{surf}} = 1.0$, $c_{\\mathrm{vol}} = 2.0$, $c_{\\mathrm{surf}} = 1.0$, $\\varepsilon_{\\mathrm{ff}} = 1.0\\times 10^{-6}$, maximum iterations $= 600$.\n- Case $3$ (low frequency and cost imbalance): $f = 1.0\\times 10^8\\,\\mathrm{Hz}$, $L = 0.5\\,\\mathrm{m}$, $N_{\\mathrm{vol}} = 20$, $N_{\\mathrm{surf}} = 40$, $\\bar{h}_{\\mathrm{vol}} = 0.02\\,\\mathrm{m}$, $\\bar{h}_{\\mathrm{surf}} = 0.015\\,\\mathrm{m}$, $A_{\\mathrm{vol}} = 0.8$, $A_{\\mathrm{surf}} = 1.2$, $p_{\\mathrm{vol}} = 1.0$, $p_{\\mathrm{surf}} = 1.0$, $c_{\\mathrm{vol}} = 1.5$, $c_{\\mathrm{surf}} = 1.0$, $\\varepsilon_{\\mathrm{ff}} = 1.0\\times 10^{-4}$, maximum iterations $= 600$.\n\nFinal output format. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each test case result is itself a list in the order $\\left[\\text{success}, \\text{iterations}, \\text{volume\\_refinements}, \\text{surface\\_refinements}, \\mathcal{E}_{\\mathrm{ff}}\\right]$. For example, the output should look like $\\left[[\\text{True},10,5,7,9.1e-4],[\\text{False},600,320,280,2.3e-6],[\\text{True},\\dots]\\right]$ with actual numbers computed by your program.", "solution": "The problem asks for the design and implementation of a goal-oriented adaptive mesh refinement (AMR) algorithm for a hybrid finite element–boundary integral (FEM-BI) method in computational electromagnetics. The objective is to efficiently reduce the estimated error in a specific quantity of interest, the far-field amplitude, below a given tolerance $\\varepsilon_{\\mathrm{ff}}$. The algorithm must iteratively refine either a volume (tetrahedral) element or a surface (triangular) element, making the selection based on which refinement offers the maximum predicted error reduction per unit of computational cost.\n\nThe proposed algorithm is a greedy, iterative procedure. At each step, it identifies the single most \"profitable\" element to refine and updates the mesh state accordingly. This process repeats until the estimated error $\\mathcal{E}_{\\mathrm{ff}}$ falls below the target tolerance $\\varepsilon_{\\mathrm{ff}}$ or a maximum number of iterations is reached.\n\nThe core components of the algorithm are as follows:\n\n1.  **State Representation**: The state of the discretized domain at any iteration is defined by the set of characteristic sizes of all volume and surface elements, $\\{h_i^{\\mathrm{vol}}\\}_{i=1}^{N_{\\mathrm{vol}}}$ and $\\{h_j^{\\mathrm{surf}}\\}_{j=1}^{N_{\\mathrm{surf}}}$. All other parameters, such as residual amplitudes $\\rho_i$ and $\\sigma_j$, are assumed to be fixed for each element throughout the simulation as per the problem definition.\n\n2.  **Error Estimator Calculation**: In each iteration, the total far-field error estimator $\\mathcal{E}_{\\mathrm{ff}}$ is computed. This estimator is the square root of the sum of squared, weighted local error indicators over all elements:\n    $$\n    \\mathcal{E}_{\\mathrm{ff}} = \\left( \\sum_{i=1}^{N_{\\mathrm{vol}}} w_i^{\\mathrm{vol}} \\left(\\eta_i^{\\mathrm{vol}}\\right)^2 + \\sum_{j=1}^{N_{\\mathrm{surf}}} w_j^{\\mathrm{surf}} \\left(\\eta_j^{\\mathrm{surf}}\\right)^2 \\right)^{1/2}\n    $$\n    The individual components are calculated based on the current element sizes:\n    -   The wavenumber is $k = 2\\pi f/c$.\n    -   Local indicators: $\\eta_i^{\\mathrm{vol}} = A_{\\mathrm{vol}} \\left(k\\, h_i^{\\mathrm{vol}}\\right)^{p_{\\mathrm{vol}}} \\rho_i$ and $\\eta_j^{\\mathrm{surf}} = A_{\\mathrm{surf}} \\left(k\\, h_j^{\\mathrm{surf}}\\right)^{p_{\\mathrm{surf}}} \\sigma_j$.\n    -   Adjoint weights: $w_i^{\\mathrm{vol}} = \\frac{1}{1 + \\left(k\\, h_i^{\\mathrm{vol}}\\right)^2}$ and $w_j^{\\mathrm{surf}} = \\frac{1}{1 + \\left(k\\, h_j^{\\mathrm{surf}}\\right)}$.\n\n3.  **Refinement Selection Criterion**: The algorithm employs a cost-aware greedy strategy. To select which element to refine, we predict the reduction in the squared error, $\\mathcal{E}_{\\mathrm{ff}}^2$, that would result from refining each candidate element. This balances the potential error reduction against the computational cost of the refinement.\n\n    For a given volume element $K_i$, its current contribution to the squared error is $C_i^{\\mathrm{vol}} = w_i^{\\mathrm{vol}} \\left(\\eta_i^{\\mathrm{vol}}\\right)^2$. If we refine this element, its size becomes $h_i^{\\mathrm{vol, new}} = h_i^{\\mathrm{vol}}/2$. According to the problem's scaling rules, the indicator contracts to $\\eta_i^{\\mathrm{vol, new}} = 2^{-p_{\\mathrm{vol}}} \\eta_i^{\\mathrm{vol}}$. The weight updates to $w_i^{\\mathrm{vol, new}} = \\frac{1}{1 + \\left(k h_i^{\\mathrm{vol, new}}\\right)^2}$. The new contribution to the squared error would be $C_i^{\\mathrm{vol, new}} = w_i^{\\mathrm{vol, new}} (\\eta_i^{\\mathrm{vol, new}})^2$.\n\n    The predicted reduction in $\\mathcal{E}_{\\mathrm{ff}}^2$ from refining element $K_i$ is therefore $\\Delta_i^{\\mathrm{vol}} = C_i^{\\mathrm{vol}} - C_i^{\\mathrm{vol, new}}$. The selection metric, which represents the error reduction per unit cost, is:\n    $$\n    M_i^{\\mathrm{vol}} = \\frac{\\Delta_i^{\\mathrm{vol}}}{c_{\\mathrm{vol}}}\n    $$\n    An analogous metric, $M_j^{\\mathrm{surf}}$, is computed for each surface element $T_j$:\n    $$\n    M_j^{\\mathrm{surf}} = \\frac{\\Delta_j^{\\mathrm{surf}}}{c_{\\mathrm{surf}}} = \\frac{w_j^{\\mathrm{surf}} (\\eta_j^{\\mathrm{surf}})^2 - w_j^{\\mathrm{surf, new}} (\\eta_j^{\\mathrm{surf, new}})^2}{c_{\\mathrm{surf}}}\n    $$\n    At each iteration, the algorithm computes $M_i^{\\mathrm{vol}}$ for all $i \\in \\{1, \\dots, N_{\\mathrm{vol}}\\}$ and $M_j^{\\mathrm{surf}}$ for all $j \\in \\{1, \\dots, N_{\\mathrm{surf}}\\}$. The element corresponding to the maximum value among all these metrics is chosen for refinement.\n\n4.  **Adaptive Loop and Termination**: The overall algorithm proceeds as follows:\n    a. Initialize element sizes $\\{h_i^{\\mathrm{vol}}\\}$ and $\\{h_j^{\\mathrm{surf}}\\}$ and residual amplitudes $\\{\\rho_i\\}$ and $\\{\\sigma_j\\}$ based on the provided formulas. Initialize iteration and refinement counters to $0$.\n    b. Start the main loop, which runs for a maximum number of iterations.\n    c. In each iteration, calculate the current total error estimator $\\mathcal{E}_{\\mathrm{ff}}$.\n    d. Check for termination: If $\\mathcal{E}_{\\mathrm{ff}} \\le \\varepsilon_{\\mathrm{ff}}$, the tolerance is met. The loop terminates, and success is recorded.\n    e. If not terminated, compute the selection metrics $M_i^{\\mathrm{vol}}$ and $M_j^{\\mathrm{surf}}$ for all elements.\n    f. Identify the element (either volume or surface) with the globally maximum metric value.\n    g. Refine the selected element: update its size by halving it ($h \\mapsto h/2$).\n    h. Increment the appropriate refinement counter (volume or surface) and the total iteration counter.\n    i. If the loop completes by reaching the maximum iteration limit without satisfying the tolerance, the process terminates and reports failure to converge.\n    j. Upon termination, report the success status, total iterations, total volume and surface refinements, and the final value of $\\mathcal{E}_{\\mathrm{ff}}$.\n\nThis algorithm is implemented using NumPy for efficient vectorized computation of indicators, weights, and metrics across all elements simultaneously, avoiding slow, explicit loops in Python.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the adaptive refinement simulation for all test cases.\n    \"\"\"\n    \n    # Speed of light in m/s\n    c = 2.99792458e8\n\n    # Test suite from the problem statement\n    test_cases = [\n        # Case 1 (happy path)\n        {'f': 3.0e9, 'L': 0.1, 'N_vol': 32, 'N_surf': 64, 'h_bar_vol_factor': 1/20.0, 'h_bar_surf_factor': 1/30.0,\n         'A_vol': 1.0, 'A_surf': 1.0, 'p_vol': 1.0, 'p_surf': 1.0, 'c_vol': 2.0, 'c_surf': 1.0,\n         'tol': 1.0e-3, 'max_iter': 1000},\n        # Case 2 (tight tolerance boundary)\n        {'f': 1.0e10, 'L': 0.2, 'N_vol': 40, 'N_surf': 80, 'h_bar_vol': 0.01, 'h_bar_surf': 0.007,\n         'A_vol': 1.0, 'A_surf': 1.5, 'p_vol': 1.0, 'p_surf': 1.0, 'c_vol': 2.0, 'c_surf': 1.0,\n         'tol': 1.0e-6, 'max_iter': 600},\n        # Case 3 (low frequency and cost imbalance)\n        {'f': 1.0e8, 'L': 0.5, 'N_vol': 20, 'N_surf': 40, 'h_bar_vol': 0.02, 'h_bar_surf': 0.015,\n         'A_vol': 0.8, 'A_surf': 1.2, 'p_vol': 1.0, 'p_surf': 1.0, 'c_vol': 1.5, 'c_surf': 1.0,\n         'tol': 1.0e-4, 'max_iter': 600}\n    ]\n\n    all_results = []\n    for params in test_cases:\n        result = run_simulation(params, c)\n        all_results.append(result)\n    \n    # Format the output string to match the required format exactly\n    output_parts = []\n    for r in all_results:\n        # Format: [success, iterations, volume_refinements, surface_refinements, E_ff]\n        # str(bool) gives 'True'/'False'\n        part = f\"[{str(r[0])},{r[1]},{r[2]},{r[3]},{r[4]}]\"\n        output_parts.append(part)\n    \n    print(f\"[{','.join(output_parts)}]\")\n\n\ndef run_simulation(params, c):\n    \"\"\"\n    Runs the adaptive refinement algorithm for a single test case.\n    \"\"\"\n    # Unpack parameters\n    f = params['f']\n    N_vol, N_surf = params['N_vol'], params['N_surf']\n    A_vol, A_surf = params['A_vol'], params['A_surf']\n    p_vol, p_surf = params['p_vol'], params['p_surf']\n    c_vol, c_surf = params['c_vol'], params['c_surf']\n    tol, max_iter = params['tol'], params['max_iter']\n\n    if 'h_bar_vol_factor' in params:\n        L = params['L']\n        h_bar_vol = L * params['h_bar_vol_factor']\n        h_bar_surf = L * params['h_bar_surf_factor']\n    else:\n        h_bar_vol = params['h_bar_vol']\n        h_bar_surf = params['h_bar_surf']\n        \n    k = 2 * np.pi * f / c\n\n    # Initialization\n    # Indices for deterministic formulas (1-based)\n    vol_indices = np.arange(1, N_vol + 1)\n    surf_indices = np.arange(1, N_surf + 1)\n\n    # Residual amplitudes (fixed)\n    rho_vol = 1.0 / (1.0 + vol_indices)\n    sigma_surf = 1.0 / (1.0 + surf_indices)\n\n    # Initial element sizes\n    h_vol = h_bar_vol * (1.0 + 0.3 * np.sin(vol_indices))\n    h_surf = h_bar_surf * (1.0 + 0.3 * np.cos(surf_indices))\n\n    iterations = 0\n    vol_refinements = 0\n    surf_refinements = 0\n    success = False\n    E_ff = float('inf')\n\n    for i in range(max_iter):\n        iterations = i\n\n        # Calculate current error estimator\n        kh_vol = k * h_vol\n        kh_surf = k * h_surf\n\n        eta_vol = A_vol * (kh_vol ** p_vol) * rho_vol\n        eta_surf = A_surf * (kh_surf ** p_surf) * sigma_surf\n        \n        w_vol = 1.0 / (1.0 + kh_vol**2)\n        w_surf = 1.0 / (1.0 + kh_surf)\n        \n        contrib_sq_vol = w_vol * eta_vol**2\n        contrib_sq_surf = w_surf * eta_surf**2\n        \n        E_ff_sq = np.sum(contrib_sq_vol) + np.sum(contrib_sq_surf)\n        E_ff = np.sqrt(E_ff_sq)\n\n        if E_ff <= tol:\n            success = True\n            break\n        \n        # Predict error reduction for all elements\n        \n        # Volume elements\n        kh_vol_new = kh_vol / 2.0\n        eta_vol_new = eta_vol * (2.0**(-p_vol))\n        w_vol_new = 1.0 / (1.0 + kh_vol_new**2)\n        contrib_sq_vol_new = w_vol_new * eta_vol_new**2\n        reductions_vol = contrib_sq_vol - contrib_sq_vol_new\n        metrics_vol = reductions_vol / c_vol\n\n        # Surface elements\n        kh_surf_new = kh_surf / 2.0\n        eta_surf_new = eta_surf * (2.0**(-p_surf))\n        w_surf_new = 1.0 / (1.0 + kh_surf_new)\n        contrib_sq_surf_new = w_surf_new * eta_surf_new**2\n        reductions_surf = contrib_sq_surf - contrib_sq_surf_new\n        metrics_surf = reductions_surf / c_surf\n\n        # Select element with max metric and refine\n        best_vol_idx = np.argmax(metrics_vol)\n        best_surf_idx = np.argmax(metrics_surf)\n        \n        if metrics_vol[best_vol_idx] >= metrics_surf[best_surf_idx]:\n            h_vol[best_vol_idx] /= 2.0\n            vol_refinements += 1\n        else:\n            h_surf[best_surf_idx] /= 2.0\n            surf_refinements += 1\n    \n    # If loop finished due to max_iter, one final calculation of E_ff is needed\n    if not success:\n      iterations += 1\n      # Recalculate final error after the last refinement\n      kh_vol = k * h_vol\n      kh_surf = k * h_surf\n      eta_vol = A_vol * (kh_vol ** p_vol) * rho_vol\n      eta_surf = A_surf * (kh_surf ** p_surf) * sigma_surf\n      w_vol = 1.0 / (1.0 + kh_vol**2)\n      w_surf = 1.0 / (1.0 + kh_surf)\n      contrib_sq_vol = w_vol * eta_vol**2\n      contrib_sq_surf = w_surf * eta_surf**2\n      E_ff_sq = np.sum(contrib_sq_vol) + np.sum(contrib_sq_surf)\n      E_ff = np.sqrt(E_ff_sq)\n\n    return [success, iterations, vol_refinements, surf_refinements, E_ff]\n\nsolve()\n```", "id": "3315744"}]}