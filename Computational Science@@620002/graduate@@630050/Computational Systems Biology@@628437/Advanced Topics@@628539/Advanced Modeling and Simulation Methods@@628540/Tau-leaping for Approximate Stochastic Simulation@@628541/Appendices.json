{"hands_on_practices": [{"introduction": "The elegance of tau-leaping lies in its simple statistical foundation: approximating complex reaction dynamics with Poisson processes. This first exercise [@problem_id:3354348] tasks you with deriving the conditional mean and variance for a basic birth-death system. This foundational calculation reveals how the algorithm's statistical \"signature\" directly reflects the underlying propensities and provides a bridge to understanding its connection with stochastic differential equations.", "problem": "Consider a single-species birth–death reaction system in computational systems biology with $2$ reactions. The state $X(t)$ denotes the discrete molecular count at time $t$. Reaction $1$ increases the count by $1$ with propensity function $a_{1}(x)=\\alpha$, where $\\alpha>0$ is a constant production rate. Reaction $2$ decreases the count by $1$ with propensity function $a_{2}(x)=\\beta x$, where $\\beta>0$ is a first-order degradation rate constant and $x \\in \\mathbb{Z}_{\\ge 0}$ is the current molecular count.\n\nAssume a fixed leap interval of length $\\tau>0$ and that the leap condition holds over $[t,t+\\tau]$, so that propensity functions remain effectively constant at the value $X(t)=x$ during the leap. Using the tau-leaping approximation grounded in the Chemical Master Equation (CME), where reaction firings over a short interval with constant propensities are approximated by independent Poisson random variables with parameters equal to the propensity times the interval length, perform the following:\n\n- Derive the explicit tau-leap update for $X(t+\\tau)$ in terms of $X(t)$ and the random reaction counts over $[t,t+\\tau]$, and identify the distributions and parameters of these random counts.\n- Compute the conditional expectation $\\mathbb{E}[X(t+\\tau)\\mid X(t)=x]$ and the conditional variance $\\mathrm{Var}[X(t+\\tau)\\mid X(t)=x]$.\n\nExpress your final answer as closed-form analytic expressions. No rounding is required, and no units are needed.", "solution": "The problem asks for the derivation of the tau-leap update equation, conditional expectation, and conditional variance for a single-species birth–death process. We shall proceed by first establishing the update rule based on the tenets of the tau-leaping approximation and then computing the required statistical moments.\n\nThe system involves a single chemical species whose population is denoted by the state variable $X(t)$. There are $M=2$ reactions.\nReaction $1$: Birth, with stoichiometric change $\\nu_1 = +1$ and propensity function $a_1(x) = \\alpha$, where $\\alpha  0$ is a constant.\nReaction $2$: Death, with stoichiometric change $\\nu_2 = -1$ and propensity function $a_2(x) = \\beta x$, where $\\beta  0$ is a rate constant and $x$ is the current molecular count.\n\nThe general tau-leap update rule approximates the change in the state vector over a small time interval $\\tau$ as:\n$$X(t+\\tau) = X(t) + \\sum_{j=1}^{M} \\nu_j K_j$$\nwhere $K_j$ is the number of times reaction $j$ fires in the interval $[t, t+\\tau]$, and $\\nu_j$ is the stoichiometric change associated with reaction $j$. The core assumption of tau-leaping, as stated in the problem, is that for a sufficiently small $\\tau$ (the leap condition), the number of firings for each reaction $j$, $K_j$, can be approximated as an independent Poisson random variable:\n$$K_j \\sim \\text{Poisson}(\\lambda_j = a_j(X(t)) \\cdot \\tau)$$\n\nFirst, we will establish the explicit tau-leap update for the given system.\nLet $X(t)=x$. The state is a scalar count. The stoichiometric changes are $\\nu_1=1$ and $\\nu_2=-1$. The state update equation is:\n$$X(t+\\tau) = x + \\nu_1 K_1 + \\nu_2 K_2 = x + (1)K_1 + (-1)K_2 = x + K_1 - K_2$$\nHere, $K_1$ and $K_2$ are independent random variables representing the number of birth and death events, respectively, during the interval $[t, t+\\tau]$.\n\nAccording to the tau-leaping approximation, the distributions of these random counts are Poisson. The parameters (rates) of these Poisson distributions are determined by the propensity functions evaluated at the start of the interval, $X(t)=x$, multiplied by the leap duration $\\tau$.\n\nFor reaction $1$ (birth), the propensity is $a_1(x) = \\alpha$. The parameter for the corresponding Poisson distribution is $\\lambda_1 = a_1(x)\\tau = \\alpha\\tau$. Thus, the number of birth events is a random variable $K_1 \\sim \\text{Poisson}(\\alpha\\tau)$.\n\nFor reaction $2$ (death), the propensity is $a_2(x) = \\beta x$. The parameter for its Poisson distribution is $\\lambda_2 = a_2(x)\\tau = \\beta x \\tau$. Thus, the number of death events is a random variable $K_2 \\sim \\text{Poisson}(\\beta x \\tau)$.\n\nTherefore, the explicit tau-leap update for $X(t+\\tau)$ is given by the expression $X(t+\\tau) = x + K_1 - K_2$, where $K_1$ and $K_2$ are independent random variables with distributions $K_1 \\sim \\text{Poisson}(\\alpha\\tau)$ and $K_2 \\sim \\text{Poisson}(\\beta x \\tau)$.\n\nNext, we compute the conditional expectation of the state at time $t+\\tau$, given the state at time $t$.\n$$\\mathbb{E}[X(t+\\tau) \\mid X(t)=x]$$\nUsing the update equation we derived:\n$$\\mathbb{E}[X(t+\\tau) \\mid X(t)=x] = \\mathbb{E}[x + K_1 - K_2]$$\nBy the linearity of the expectation operator, this becomes:\n$$\\mathbb{E}[x + K_1 - K_2] = \\mathbb{E}[x] + \\mathbb{E}[K_1] - \\mathbb{E}[K_2]$$\nSince $x$ is a given value (the condition), it is a constant with respect to the expectation, so $\\mathbb{E}[x]=x$.\nThe expectation of a Poisson random variable with parameter $\\lambda$ is equal to $\\lambda$. Therefore:\n$$\\mathbb{E}[K_1] = \\alpha\\tau$$\n$$\\mathbb{E}[K_2] = \\beta x \\tau$$\nSubstituting these into the expression for the conditional expectation gives:\n$$\\mathbb{E}[X(t+\\tau) \\mid X(t)=x] = x + \\alpha\\tau - \\beta x \\tau = x(1 - \\beta\\tau) + \\alpha\\tau$$\n\nFinally, we compute the conditional variance of the state at time $t+\\tau$, given the state at time $t$.\n$$\\mathrm{Var}[X(t+\\tau) \\mid X(t)=x]$$\nUsing the same update equation:\n$$\\mathrm{Var}[X(t+\\tau) \\mid X(t)=x] = \\mathrm{Var}[x + K_1 - K_2]$$\nThe variance is invariant to constant shifts, so adding $x$ does not change the variance:\n$$\\mathrm{Var}[x + K_1 - K_2] = \\mathrm{Var}[K_1 - K_2]$$\nA key property of variance is that for any two independent random variables $Y_1$ and $Y_2$, $\\mathrm{Var}[Y_1 - Y_2] = \\mathrm{Var}[Y_1] + \\mathrm{Var}[Y_2]$. Since $K_1$ and $K_2$ are stipulated to be independent in the tau-leaping framework:\n$$\\mathrm{Var}[K_1 - K_2] = \\mathrm{Var}[K_1] + \\mathrm{Var}[K_2]$$\nThe variance of a Poisson random variable with parameter $\\lambda$ is also equal to $\\lambda$. Therefore:\n$$\\mathrm{Var}[K_1] = \\alpha\\tau$$\n$$\\mathrm{Var}[K_2] = \\beta x \\tau$$\nSubstituting these into the expression for the conditional variance gives:\n$$\\mathrm{Var}[X(t+\\tau) \\mid X(t)=x] = \\alpha\\tau + \\beta x \\tau = (\\alpha + \\beta x)\\tau$$\n\nThe derived expressions for the conditional expectation and conditional variance provide the mean and variance of the change in the species population over the leap interval $\\tau$, under the tau-leaping approximation. These moments are fundamental for analyzing the behavior of the stochastic simulation algorithm.", "answer": "$$\\boxed{\\begin{pmatrix} x(1 - \\beta\\tau) + \\alpha\\tau  (\\alpha + \\beta x)\\tau \\end{pmatrix}}$$", "id": "3354348"}, {"introduction": "A key weakness of the basic tau-leaping method is its potential to generate non-physical negative species counts, especially when populations are small. This practice [@problem_id:3354376] introduces a powerful adaptive strategy—a hybrid algorithm that partitions reactions into \"critical\" and \"noncritical\" sets—to navigate this challenge. By working through a step rejection and recalculation, you will gain insight into making tau-leaping both robust and accurate in realistic scenarios.", "problem": "Consider a well-mixed biochemical reaction system governed by the Chemical Master Equation (CME). The state is a vector of molecular counts $\\mathbf{x} = (x_{1}, x_{2})$ for two species $X_{1}$ and $X_{2}$. The system has four elementary reactions with stoichiometric changes $\\nu_{ij}$ and propensity functions $a_{j}(\\mathbf{x}) = c_{j} h_{j}(\\mathbf{x})$, where $c_{j}$ are stochastic rate constants and $h_{j}(\\mathbf{x})$ is the number of distinct reactant combinations:\n- Reaction $\\mathrm{R}_{1}$: $X_{1} \\to \\varnothing$, with $c_{1} = 0.9$ s$^{-1}$ and $h_{1}(\\mathbf{x}) = x_{1}$.\n- Reaction $\\mathrm{R}_{2}$: $\\varnothing \\to X_{1}$, with $c_{2} = 1.0$ s$^{-1}$ and $h_{2}(\\mathbf{x}) = 1$.\n- Reaction $\\mathrm{R}_{3}$: $X_{1} + X_{2} \\to X_{2}$, with $c_{3} = 0.001$ s$^{-1}$ and $h_{3}(\\mathbf{x}) = x_{1} x_{2}$.\n- Reaction $\\mathrm{R}_{4}$: $X_{2} \\to \\varnothing$, with $c_{4} = 0.05$ s$^{-1}$ and $h_{4}(\\mathbf{x}) = x_{2}$.\n\nThe stoichiometric coefficients are:\n- For species $X_{1}$: $\\nu_{1,1} = -1$, $\\nu_{1,2} = +1$, $\\nu_{1,3} = -1$, $\\nu_{1,4} = 0$.\n- For species $X_{2}$: $\\nu_{2,1} = 0$, $\\nu_{2,2} = 0$, $\\nu_{2,3} = 0$, $\\nu_{2,4} = -1$.\n\nLet the current state be $\\mathbf{x} = (x_{1}, x_{2}) = (3, 80)$. In the explicit tau-leaping approximation, one chooses a leap time $\\tau$ so that the reaction propensities remain approximately constant over $[t, t + \\tau)$, and the net change in each species is well-controlled in both mean and variance.\n\nStarting from the CME and the definition of propensities, derive the expressions for the drift $\\mu_{i}(\\mathbf{x})$ and diffusion $\\sigma_{i}^{2}(\\mathbf{x})$ of each species in terms of the stoichiometry and propensities. Impose the standard tau-leaping bounded-change conditions that ensure the expected relative change and the standard deviation-scaled relative change of each species during the leap do not exceed a given threshold $\\epsilon$. Use these conditions to compute a candidate $\\tau$ for the full reaction set with threshold parameter $\\epsilon = 1.0$ and safety factor $\\eta = 0.8$.\n\nFor this demonstration, suppose the realized counts are $K_{1} = 4$, $K_{2} = 1$, $K_{3} = 1$, and $K_{4} = 3$. Determine whether the leap would produce a negative species count and hence must be rejected.\n\nUpon rejection, reclassify reactions into a critical subset and a noncritical subset as follows: any reaction that decreases a species $X_{i}$ with current count $x_{i} \\leq n_{c}$ is deemed critical, with the critical threshold set to $n_{c} = 10$. Recompute the drift and diffusion using only the noncritical reactions, and use the same bounded-change conditions with the same $\\epsilon$ and safety factor $\\eta$ to obtain a new noncritical $\\tau_{\\mathrm{nc}}$. In addition, compute the time to the next critical event by sampling an exponential clock with rate equal to the total critical propensity $a^{c}(\\mathbf{x}) = \\sum_{j \\in \\mathcal{C}} a_{j}(\\mathbf{x})$. For this instance, suppose the uniform variate drawn is $r = 0.2$, so that $\\tau_{c} = \\frac{1}{a^{c}(\\mathbf{x})} \\ln\\!\\left(\\frac{1}{r}\\right)$. The final accepted leap time is $\\tau_{\\mathrm{final}} = \\min\\{\\tau_{\\mathrm{nc}}, \\tau_{c}\\}$.\n\nCompute $\\tau_{\\mathrm{final}}$ for the given state and realizations. Express the final result in seconds and round your answer to four significant figures. The final answer must be a single real number.", "solution": "The problem requires a multi-step analysis within the framework of approximate stochastic simulation, specifically using the explicit tau-leaping method and its hybrid extension involving critical reactions. The solution proceeds by first deriving the general expressions for drift and diffusion, then validating the leap rejection, and finally computing the revised leap time using the hybrid method.\n\n### Derivation of Drift and Diffusion\nThe evolution of the state vector $\\mathbf{x}$ is described by the Chemical Master Equation (CME). In the tau-leaping approximation, for a time step $\\tau$ small enough that the propensity functions $a_j(\\mathbf{x})$ are nearly constant, the number of times each reaction $\\mathrm{R}_j$ occurs, $K_j$, can be approximated by a Poisson random variable, $K_j \\sim \\mathrm{Poisson}(a_j(\\mathbf{x})\\tau)$.\n\nThe change in the number of molecules of species $X_i$ over the interval $\\tau$ is given by $\\Delta x_i = \\sum_{j=1}^{M} \\nu_{ij} K_j$, where $M$ is the total number of reactions.\n\nThe drift, $\\mu_i(\\mathbf{x})$, is defined as the expected rate of change of species $X_i$. Using the property that the expectation of a Poisson variable $\\mathrm{Poisson}(\\lambda)$ is $\\lambda$, we have $\\mathbb{E}[K_j] = a_j(\\mathbf{x})\\tau$.\nThe expected change is:\n$$ \\mathbb{E}[\\Delta x_i] = \\mathbb{E}\\left[\\sum_{j=1}^{M} \\nu_{ij} K_j\\right] = \\sum_{j=1}^{M} \\nu_{ij} \\mathbb{E}[K_j] = \\sum_{j=1}^{M} \\nu_{ij} a_j(\\mathbf{x})\\tau $$\nThe drift is the expected change per unit time:\n$$ \\mu_i(\\mathbf{x}) = \\frac{\\mathbb{E}[\\Delta x_i]}{\\tau} = \\sum_{j=1}^{M} \\nu_{ij} a_j(\\mathbf{x}) $$\n\nThe diffusion, $\\sigma_i^2(\\mathbf{x})$, is the variance of the rate of change. Using the property that the variance of a Poisson variable $\\mathrm{Poisson}(\\lambda)$ is also $\\lambda$, we have $\\mathrm{Var}(K_j) = a_j(\\mathbf{x})\\tau$. Assuming the reaction firings are independent, the variance of the change is:\n$$ \\mathrm{Var}(\\Delta x_i) = \\mathrm{Var}\\left[\\sum_{j=1}^{M} \\nu_{ij} K_j\\right] = \\sum_{j=1}^{M} \\nu_{ij}^2 \\mathrm{Var}(K_j) = \\sum_{j=1}^{M} \\nu_{ij}^2 a_j(\\mathbf{x})\\tau $$\nThe diffusion is the variance of the change per unit time:\n$$ \\sigma_i^2(\\mathbf{x}) = \\frac{\\mathrm{Var}(\\Delta x_i)}{\\tau} = \\sum_{j=1}^{M} \\nu_{ij}^2 a_j(\\mathbf{x}) $$\n\n### Leap Rejection Analysis\nFirst, we calculate the propensity functions for the current state $\\mathbf{x} = (x_1, x_2) = (3, 80)$:\n$a_1(\\mathbf{x}) = c_1 x_1 = 0.9 \\times 3 = 2.7$ s$^{-1}$\n$a_2(\\mathbf{x}) = c_2 \\times 1 = 1.0 \\times 1 = 1.0$ s$^{-1}$\n$a_3(\\mathbf{x}) = c_3 x_1 x_2 = 0.001 \\times 3 \\times 80 = 0.24$ s$^{-1}$\n$a_4(\\mathbf{x}) = c_4 x_2 = 0.05 \\times 80 = 4.0$ s$^{-1}$\n\nThe problem provides a hypothetical set of realized Poisson counts for a leap: $K_1 = 4$, $K_2 = 1$, $K_3 = 1$, and $K_4 = 3$. We calculate the change in species counts, $\\Delta x_i = \\sum_j \\nu_{ij} K_j$.\n\nFor species $X_1$:\n$$ \\Delta x_1 = \\nu_{1,1} K_1 + \\nu_{1,2} K_2 + \\nu_{1,3} K_3 + \\nu_{1,4} K_4 = (-1)(4) + (+1)(1) + (-1)(1) + (0)(3) = -4 + 1 - 1 = -4 $$\nFor species $X_2$:\n$$ \\Delta x_2 = \\nu_{2,1} K_1 + \\nu_{2,2} K_2 + \\nu_{2,3} K_3 + \\nu_{2,4} K_4 = (0)(4) + (0)(1) + (0)(1) + (-1)(3) = -3 $$\n\nThe new state would be $\\mathbf{x}' = \\mathbf{x} + \\Delta\\mathbf{x} = (3 - 4, 80 - 3) = (-1, 77)$.\nSince the count for species $X_1$ becomes negative ($x'_1 = -1$), which is physically impossible, this leap must be rejected.\n\n### Hybrid Method: Reaction Partitioning and $\\tau$ Calculation\nUpon rejection, the algorithm switches to a hybrid method. Reactions are partitioned into critical and noncritical sets. A reaction is critical if it decreases a species $X_i$ whose current count $x_i$ is less than or equal to the threshold $n_c = 10$.\n\nAt state $\\mathbf{x} = (3, 80)$:\n- $x_1 = 3 \\le n_c$, so reactions decreasing $X_1$ are critical.\n- $x_2 = 80  n_c$.\n\nAnalyzing the reactions:\n- $\\mathrm{R}_{1}$: $\\nu_{1,1} = -1$. Decreases $X_1$. Thus, $\\mathrm{R}_{1}$ is critical.\n- $\\mathrm{R}_{2}$: $\\nu_{1,2} = +1$. Does not decrease $X_1$. Noncritical.\n- $\\mathrm{R}_{3}$: $\\nu_{1,3} = -1$. Decreases $X_1$. Thus, $\\mathrm{R}_{3}$ is critical.\n- $\\mathrm{R}_{4}$: $\\nu_{2,4} = -1$. Decreases $X_2$, but $x_2  n_c$. Noncritical.\n\nThe sets are: Critical $\\mathcal{C} = \\{\\mathrm{R}_{1}, \\mathrm{R}_{3}\\}$ and Noncritical $\\mathcal{NC} = \\{\\mathrm{R}_{2}, \\mathrm{R}_{4}\\}$.\n\nThe total propensity of critical reactions is:\n$$ a^c(\\mathbf{x}) = a_1(\\mathbf{x}) + a_3(\\mathbf{x}) = 2.7 + 0.24 = 2.94 \\, \\mathrm{s}^{-1} $$\nThe time to the next critical reaction, $\\tau_c$, is sampled from an exponential distribution with rate $a^c(\\mathbf{x})$. Using the given uniform random variate $r = 0.2$:\n$$ \\tau_c = \\frac{1}{a^c(\\mathbf{x})} \\ln\\left(\\frac{1}{r}\\right) = \\frac{1}{2.94} \\ln\\left(\\frac{1}{0.2}\\right) = \\frac{\\ln(5)}{2.94} \\approx 0.547428 \\, \\mathrm{s} $$\n\nNext, we compute a leap time $\\tau_{\\mathrm{nc}}$ for the noncritical reactions using the bounded-change conditions. We first need the drift and diffusion from only the noncritical reactions $\\mathrm{R}_{2}$ and $\\mathrm{R}_{4}$.\nFor $X_1$:\n$$ \\mu_1^{\\mathrm{nc}}(\\mathbf{x}) = \\nu_{1,2}a_2(\\mathbf{x}) + \\nu_{1,4}a_4(\\mathbf{x}) = (+1)(1.0) + (0)(4.0) = 1.0 $$\n$$ (\\sigma_1^{\\mathrm{nc}})^2(\\mathbf{x}) = \\nu_{1,2}^2 a_2(\\mathbf{x}) + \\nu_{1,4}^2 a_4(\\mathbf{x}) = (+1)^2(1.0) + (0)^2(4.0) = 1.0 $$\nFor $X_2$:\n$$ \\mu_2^{\\mathrm{nc}}(\\mathbf{x}) = \\nu_{2,2}a_2(\\mathbf{x}) + \\nu_{2,4}a_4(\\mathbf{x}) = (0)(1.0) + (-1)(4.0) = -4.0 $$\n$$ (\\sigma_2^{\\mathrm{nc}})^2(\\mathbf{x}) = \\nu_{2,2}^2 a_2(\\mathbf{x}) + \\nu_{2,4}^2 a_4(\\mathbf{x}) = (0)^2(1.0) + (-1)^2(4.0) = 4.0 $$\n\nThe candidate $\\tau$ for each species is determined by:\n$$ \\tau_i^{\\mathrm{raw}} = \\min\\left(\\frac{\\epsilon x_i}{|\\mu_i^{\\mathrm{nc}}(\\mathbf{x})|}, \\frac{(\\epsilon x_i)^2}{(\\sigma_i^{\\mathrm{nc}})^2(\\mathbf{x})}\\right) $$\nGiven $\\epsilon = 1.0$.\nFor $X_1$ ($x_1=3$):\n$$ \\tau_1^{\\mathrm{raw}} = \\min\\left(\\frac{1.0 \\times 3}{|1.0|}, \\frac{(1.0 \\times 3)^2}{1.0}\\right) = \\min(3, 9) = 3 \\, \\mathrm{s} $$\nFor $X_2$ ($x_2=80$):\n$$ \\tau_2^{\\mathrm{raw}} = \\min\\left(\\frac{1.0 \\times 80}{|-4.0|}, \\frac{(1.0 \\times 80)^2}{4.0}\\right) = \\min\\left(\\frac{80}{4}, \\frac{6400}{4}\\right) = \\min(20, 1600) = 20 \\, \\mathrm{s} $$\nThe overall noncritical time step is the minimum of these, with the safety factor $\\eta = 0.8$ applied:\n$$ \\tau_{\\mathrm{nc}} = \\eta \\times \\min(\\tau_1^{\\mathrm{raw}}, \\tau_2^{\\mathrm{raw}}) = 0.8 \\times \\min(3, 20) = 0.8 \\times 3 = 2.4 \\, \\mathrm{s} $$\n\nFinally, the accepted leap time for the hybrid step is the minimum of the time to the next critical event and the leap time for the noncritical system:\n$$ \\tau_{\\mathrm{final}} = \\min\\{\\tau_{\\mathrm{nc}}, \\tau_c\\} = \\min\\{2.4, 0.547428\\} = 0.547428 \\, \\mathrm{s} $$\nRounding to four significant figures, we get $0.5474$.", "answer": "$$\\boxed{0.5474}$$", "id": "3354376"}, {"introduction": "The ultimate test of understanding an algorithm is to build it. This final practice [@problem_id:3354334] challenges you to implement a complete tau-leaping simulator from the ground up, incorporating efficient sampling via Poisson thinning and a crucial non-negativity constraint. This exercise bridges the gap between the mathematical framework of the Chemical Master Equation and a functional computational tool for systems biology.", "problem": "You are to implement a one-step, fixed-step approximate stochastic simulation algorithm for well-mixed biochemical reaction networks based on tau-leaping with Poisson thinning and capacity capping to avoid negative populations. The mathematical foundation is the Chemical Master Equation (CME) for continuous-time Markov jump processes in a well-mixed volume, and mass-action kinetics. From first principles, for a state vector $\\mathbf{x} \\in \\mathbb{N}_0^d$ with $d$ chemical species and $m$ reactions, each reaction $i \\in \\{1,\\dots,m\\}$ has a rate constant $c_i \\in \\mathbb{R}_+$, a reactant stoichiometry vector $r_i \\in \\mathbb{N}_0^d$, and a net stoichiometric change vector $\\nu_i \\in \\mathbb{Z}^d$. Under mass-action kinetics, the propensity (hazard) function is $a_i(\\mathbf{x}) = c_i \\prod_{s=1}^d \\binom{x_s}{r_{i,s}}$, where the binomial factor is defined as $\\binom{n}{0} = 1$ and $\\binom{n}{k} = 0$ if $n  k$. The exact Stochastic Simulation Algorithm (SSA) is not to be implemented; instead implement an approximate tau-leaping step that uses a single aggregate Poisson draw and Poisson thinning to allocate firings across reactions, followed by a capacity capping to guarantee nonnegativity of all species.\n\nYour program must implement, for one tau-leap step of size $\\tau \\in \\mathbb{R}_+$, starting from state $\\mathbf{x}$, the following procedure:\n- Compute $a_i(\\mathbf{x})$ for all $i$ and the sum $a_0(\\mathbf{x}) = \\sum_{i=1}^m a_i(\\mathbf{x})$.\n- If $a_0(\\mathbf{x}) = 0$, return the unchanged state. Otherwise, draw a total event count $K \\sim \\mathrm{Poisson}(a_0(\\mathbf{x})\\,\\tau)$.\n- If $K = 0$, return the unchanged state. Otherwise, allocate these $K$ events to the $m$ reactions by drawing $(K_1,\\dots,K_m) \\sim \\mathrm{Multinomial}\\left(K; p_1,\\dots,p_m\\right)$ where $p_i = a_i(\\mathbf{x})/a_0(\\mathbf{x})$.\n- To avoid negative populations, impose caps on the drawn counts $(K_1,\\dots,K_m)$ by requiring that, for each species $s \\in \\{1,\\dots,d\\}$ with net consumption, the total decrements do not exceed the available molecules. Define the per-reaction net consumption entries as $d_{i,s} = \\max\\{0,-\\nu_{i,s}\\}$. Compute total demand $D_s = \\sum_{i=1}^m K_i\\, d_{i,s}$. If $D_s \\le x_s$ for all $s$, accept $(K_1,\\dots,K_m)$ as is. Otherwise, compute a global contraction factor $\\alpha = \\min_{s: D_s0} \\min\\{1, x_s / D_s\\}$ and set $K_i' = \\lfloor \\alpha K_i \\rfloor$ for all $i$, which guarantees that $\\sum_i K_i' d_{i,s} \\le x_s$ for all $s$. Update the state by $\\mathbf{x} \\leftarrow \\mathbf{x} + \\sum_{i=1}^m K_i' \\nu_i$.\n\nYou must support multiple sequential tau-leap steps by iterating the single-step procedure a specified number of times, with a fixed $\\tau$ and fixed propensities at the beginning of each step as defined above (that is, no adaptive step selection and no within-step state updates except at the end of each step). Use a pseudorandom number generator with a specified seed for reproducibility per test case.\n\nYour implementation must be general for any small $d$ and $m$ and must:\n- Compute $a_i(\\mathbf{x})$ from first principles using mass-action combinatorial factors.\n- Use a single aggregated Poisson draw and Poisson thinning via a multinomial allocation.\n- Enforce the nonnegativity constraint using the capacity capping described above based on net consumption $d_{i,s}$.\n\nTest suite and parameterization. Implement your solver to run the following four test cases. In each case, initialize the pseudorandom number generator with the given seed and run the specified number of fixed steps of size $\\tau$.\n\nTest case $1$ (single-species, two competing degradations with a birth):\n- Species: $d=1$ with state $\\mathbf{x} = [X]$.\n- Reactions ($m=3$):\n  - $R_b$: $\\varnothing \\rightarrow X$ with rate $c_b = 20.0$, reactant $r=[0]$, net change $\\nu=[+1]$.\n  - $R_1$: $X \\rightarrow \\varnothing$ with rate $c_1 = 0.3$, reactant $r=[1]$, net change $\\nu=[-1]$.\n  - $R_2$: $X \\rightarrow \\varnothing$ with rate $c_2 = 0.2$, reactant $r=[1]$, net change $\\nu=[-1]$.\n- Initial state $\\mathbf{x}_0 = [50]$.\n- Step size $\\tau = 0.1$, number of steps $120$.\n- Seed $42$.\n\nTest case $2$ (single-species, competition between monomer decay and dimerization plus birth):\n- Species: $d=1$ with state $\\mathbf{x} = [X]$.\n- Reactions ($m=3$):\n  - $R_b$: $\\varnothing \\rightarrow X$ with rate $c_b = 40.0$, reactant $r=[0]$, net change $\\nu=[+1]$.\n  - $R_d$: $2X \\rightarrow \\varnothing$ with rate $c_d = 0.002$, reactant $r=[2]$, net change $\\nu=[-2]$.\n  - $R_m$: $X \\rightarrow \\varnothing$ with rate $c_m = 0.05$, reactant $r=[1]$, net change $\\nu=[-1]$.\n- Initial state $\\mathbf{x}_0 = [80]$.\n- Step size $\\tau = 0.05$, number of steps $200$.\n- Seed $7$.\n\nTest case $3$ (two-species, catalytic removal of one species competing with spontaneous decay, plus births and monomer decay of the catalyst):\n- Species: $d=2$ with state $\\mathbf{x} = [X,Y]$.\n- Reactions ($m=5$):\n  - $R_1$: $X + Y \\rightarrow X$ with rate $c_1 = 0.005$, reactant $r=[1,1]$, net change $\\nu=[0,-1]$.\n  - $R_2$: $Y \\rightarrow \\varnothing$ with rate $c_2 = 0.1$, reactant $r=[0,1]$, net change $\\nu=[0,-1]$.\n  - $R_3$: $\\varnothing \\rightarrow Y$ with rate $b_Y = 5.0$, reactant $r=[0,0]$, net change $\\nu=[0,+1]$.\n  - $R_4$: $\\varnothing \\rightarrow X$ with rate $b_X = 2.0$, reactant $r=[0,0]$, net change $\\nu=[+1,0]$.\n  - $R_5$: $X \\rightarrow \\varnothing$ with rate $c_X = 0.05$, reactant $r=[1,0]$, net change $\\nu=[-1,0]$.\n- Initial state $\\mathbf{x}_0 = [10,60]$.\n- Step size $\\tau = 0.1$, number of steps $150$.\n- Seed $2021$.\n\nTest case $4$ (boundary case with zero propensity):\n- Species: $d=1$ with state $\\mathbf{x} = [Z]$.\n- Reactions ($m=1$):\n  - $R$: $Z \\rightarrow \\varnothing$ with rate $c = 1.0$, reactant $r=[1]$, net change $\\nu=[-1]$.\n- Initial state $\\mathbf{x}_0 = [0]$.\n- Step size $\\tau = 0.2$, number of steps $50$.\n- Seed $123$.\n\nYour program must run these test cases in order and return the final state vector for each test case as a list of integers in species order. The final output must be a single line containing a list of these per-test-case lists, with no whitespace, enclosed in square brackets. For example, if there were two test cases, the output format would be $[[x_{1,1},\\dots,x_{1,d_1}],[x_{2,1},\\dots,x_{2,d_2}]]$. The data types of all entries must be integers. No physical units are required for this problem. Angles are not involved. Percentages are not involved.", "solution": "We begin from the Chemical Master Equation (CME) formulation for a well-mixed reaction network modeled as a continuous-time Markov jump process on $\\mathbb{N}_0^d$. For each reaction $i \\in \\{1,\\dots,m\\}$ with rate constant $c_i$, reactant stoichiometry vector $r_i \\in \\mathbb{N}_0^d$, and net change vector $\\nu_i \\in \\mathbb{Z}^d$, the propensity $a_i(\\mathbf{x})$ under mass-action kinetics is $a_i(\\mathbf{x}) = c_i \\prod_{s=1}^d \\binom{x_s}{r_{i,s}}$. This combinatorial factor counts the number of distinct unordered reactant combinations available in state $\\mathbf{x}$. For example, for a unimolecular reaction in species $s$ with $r_{i,s} = 1$, the contribution is $x_s$, and for a dimerization with $r_{i,s} = 2$, it is $x_s(x_s-1)/2$.\n\nIn exact Stochastic Simulation Algorithm (SSA), one samples the next reaction time and type exactly from the current propensities. In tau-leaping, over a small time interval of length $\\tau$ during which the propensities are assumed approximately constant, the number of firings $N_i$ of each reaction $i$ is approximated as a Poisson random variable with mean $a_i(\\mathbf{x})\\,\\tau$, and different reactions are approximated as independent. There is a foundational identity for Poisson processes: if $N_i \\sim \\mathrm{Poisson}(\\lambda_i)$ are independent, then their sum $K = \\sum_i N_i$ is $\\mathrm{Poisson}(\\sum_i \\lambda_i)$, and conditioned on $K$, the vector $(N_1,\\dots,N_m)$ is distributed as $\\mathrm{Multinomial}(K; p_1,\\dots,p_m)$ with $p_i = \\lambda_i / \\sum_j \\lambda_j$. Applying this with $\\lambda_i = a_i(\\mathbf{x})\\,\\tau$ yields an equivalent two-stage sampling procedure for tau-leaping: first draw a single $K \\sim \\mathrm{Poisson}(a_0(\\mathbf{x})\\,\\tau)$ where $a_0(\\mathbf{x}) = \\sum_i a_i(\\mathbf{x})$, and then allocate the $K$ events to reactions by $(K_1,\\dots,K_m) \\sim \\mathrm{Multinomial}(K; p)$ with $p_i = a_i(\\mathbf{x})/a_0(\\mathbf{x})$. This is the Poisson thinning interpretation of superposed Poisson processes.\n\nA practical difficulty of tau-leaping is that the naive sampled counts may lead to negative species counts after applying the state update $\\mathbf{x} \\leftarrow \\mathbf{x} + \\sum_i K_i \\nu_i$. To guarantee nonnegativity while minimally perturbing the statistical structure, we impose a capacity constraint per species. Define the per-reaction net consumption of species $s$ as $d_{i,s} = \\max\\{0, -\\nu_{i,s}\\}$, which counts the units of species $s$ removed by one firing of reaction $i$ in net. For a catalytic reaction such as $X + Y \\rightarrow X$, we have $\\nu_X = 0$ and thus $d_{i,X} = 0$, so no capacity constraint is required for $X$ even though $X$ appears in $r_i$. The total net demand for species $s$ implied by the sampled counts is $D_s = \\sum_i K_i d_{i,s}$. A necessary and sufficient condition for nonnegativity after the update is that $D_s \\le x_s$ for all $s$ (since $x_s$ loses at most $D_s$ units from all reactions combined). If this condition fails, we reduce the vector $K$ uniformly by a scalar factor $\\alpha \\in [0,1]$ chosen to satisfy all constraints. A simple choice is $\\alpha = \\min_{s: D_s  0} x_s / D_s$, which ensures $\\alpha D_s \\le x_s$ for all $s$ with demand. We then define integer counts $K_i' = \\lfloor \\alpha K_i \\rfloor$. For any species $s$, we have $\\sum_i K_i' d_{i,s} \\le \\sum_i \\alpha K_i d_{i,s} = \\alpha D_s \\le x_s$, since $\\lfloor z \\rfloor \\le z$ for any $z \\in \\mathbb{R}$. Therefore, the adjusted counts $K'$ satisfy the capacity constraints. The updated state $\\mathbf{x}' = \\mathbf{x} + \\sum_i K_i' \\nu_i$ is guaranteed to have nonnegative components. This capping preserves the structure of Poisson thinning while ensuring feasibility.\n\nAlgorithmic design:\n- Represent a reaction network by $(c_i, r_i, \\nu_i)$ for $i \\in \\{1,\\dots,m\\}$. The state $\\mathbf{x} \\in \\mathbb{N}_0^d$ is an integer vector. The mass-action propensity is computed from the combinatorial product $a_i(\\mathbf{x}) = c_i \\prod_s \\binom{x_s}{r_{i,s}}$. The binomial coefficient is computed as $\\binom{n}{k} = \\prod_{j=0}^{k-1} \\frac{n-j}{j+1}$ for $k \\ge 1$ with the convention $\\binom{n}{k} = 0$ if $n  k$.\n- For each tau-leap step:\n  - Compute $a_i(\\mathbf{x})$ and $a_0(\\mathbf{x})$.\n  - If $a_0(\\mathbf{x}) = 0$, return $\\mathbf{x}$ unchanged (no reactions can fire).\n  - Draw $K \\sim \\mathrm{Poisson}(a_0(\\mathbf{x})\\,\\tau)$. If $K = 0$, return $\\mathbf{x}$ unchanged.\n  - Compute probabilities $p_i = a_i(\\mathbf{x})/a_0(\\mathbf{x})$ and sample $(K_1,\\dots,K_m) \\sim \\mathrm{Multinomial}(K; p)$.\n  - Compute demands $D_s = \\sum_i K_i d_{i,s}$ with $d_{i,s} = \\max\\{0,-\\nu_{i,s}\\}$.\n  - If any $D_s > x_s$, compute $\\alpha = \\min_{s: D_s0} \\min\\{1, x_s / D_s\\}$, set $K_i' = \\lfloor \\alpha K_i \\rfloor$, else $K' = K$.\n  - Update the state by $\\mathbf{x} \\leftarrow \\mathbf{x} + \\sum_i K_i' \\nu_i$.\n- Repeat the above for the specified number of steps with fixed $\\tau$. Use a seeded pseudorandom number generator to ensure reproducibility.\n\nCorrectness and rationale:\n- The use of Poisson thinning is justified by the superposition and thinning properties of independent Poisson processes, applied to the independent Poisson approximations for reaction firing counts over intervals of length $\\tau$ with approximately constant propensities.\n- The capacity capping is derived from the invariant that species counts must remain in $\\mathbb{N}_0^d$. The scaling by $\\alpha$ guarantees that for each species $s$, the total net consumption does not exceed the current availability $x_s$, since $\\sum_i K_i' d_{i,s} \\le \\alpha D_s \\le x_s$ by construction. This is a conservative adjustment that guarantees feasibility and avoids negative populations without attempting to reassign events across reactions, which would be more complex and potentially inconsistent with the multinomial allocation.\n- The catalytic reaction case illustrates the importance of using net consumption $d_{i,s}$ for capping rather than reactant stoichiometry $r_{i,s}$. For $X + Y \\rightarrow X$, we have $r_{i,X} = 1$ but $\\nu_X = 0$, hence $d_{i,X} = 0$, reflecting that while $X$ is required for the reaction to occur, its count does not decrease as a net effect; only $Y$ is limiting for nonnegativity.\n\nTest suite coverage:\n- Test case $1$ exercises thinning across two parallel first-order decay channels sharing the same limiting species $X$, alongside a zeroth-order birth to replenish $X$.\n- Test case $2$ exercises competition between first-order decay and second-order dimerization, testing combinatorial propensities and the capping for a reaction with net consumption of $2$ units per firing.\n- Test case $3$ exercises multispecies coupling including a catalytic reaction where net consumption excludes the catalyst species, plus births and a decay channel for the catalyst.\n- Test case $4$ exercises the boundary condition with zero total propensity $a_0(\\mathbf{x}) = 0$, ensuring that the algorithm properly leaves the state unchanged.\n\nOutput specification:\n- For each test case, after the specified number of steps, output the final state vector as a list of integers in species order.\n- Aggregate the per-test-case lists into a single top-level list and print it as a single line with no whitespace, for example $[[x_{1,1},\\dots,x_{1,d_1}],\\dots,[x_{4,1},\\dots,x_{4,d_4}]]$ for the four cases.\n\nThis design adheres to fundamental CME principles, uses the well-tested Poisson superposition and thinning facts, and enforces feasibility via a mathematically justified capping that preserves nonnegativity.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef comb_nk(n: int, k: int) - float:\n    \"\"\"\n    Compute binomial coefficient C(n, k) as float with the convention that\n    C(n, k) = 0 if n  k, and C(n, 0) = 1.\n    \"\"\"\n    if k  0:\n        return 0.0\n    if k == 0:\n        return 1.0\n    if n  k:\n        return 0.0\n    # Compute product form to avoid large factorials.\n    res = 1.0\n    for j in range(1, k + 1):\n        res *= (n - (j - 1)) / j\n    return res\n\ndef mass_action_propensity(x: np.ndarray, reactant: np.ndarray, rate: float) - float:\n    \"\"\"\n    Compute mass-action propensity a_i(x) = c * prod_s C(x_s, r_s)\n    \"\"\"\n    prod = 1.0\n    for xs, rs in zip(x, reactant):\n        # If any required molecules are not available, propensity contribution is zero.\n        prod *= comb_nk(int(xs), int(rs))\n        if prod == 0.0:\n            return 0.0\n    return rate * prod\n\ndef tau_leap_step(x: np.ndarray,\n                  reactions: list,\n                  tau: float,\n                  rng: np.random.Generator) - np.ndarray:\n    \"\"\"\n    Perform one tau-leap step with Poisson thinning and capacity capping.\n    reactions: list of dicts with keys:\n        'rate': float,\n        'reactant': np.ndarray of nonnegative ints,\n        'nu': np.ndarray of ints\n    \"\"\"\n    m = len(reactions)\n    d = x.shape[0]\n    # Compute propensities\n    a = np.empty(m, dtype=float)\n    for i, rxn in enumerate(reactions):\n        a[i] = mass_action_propensity(x, rxn['reactant'], rxn['rate'])\n    a0 = float(np.sum(a))\n    if a0 = 0.0:\n        # No reactions can fire\n        return x.copy()\n    # Draw total number of events by Poisson with mean a0 * tau\n    mean_events = a0 * tau\n    K_total = rng.poisson(mean_events)\n    if K_total = 0:\n        return x.copy()\n    # Multinomial allocation (Poisson thinning)\n    p = a / a0\n    # Ensure sum(p) is 1.0 within floating error; multinomial expects that.\n    K_alloc = rng.multinomial(K_total, p)\n    # Capacity capping based on net consumption d_{i,s} = max(0, -nu_{i,s})\n    # Compute demands D_s\n    demands = np.zeros(d, dtype=float)\n    neg_consumption = np.zeros((m, d), dtype=int)\n    for i, rxn in enumerate(reactions):\n        # net consumption per firing for species s\n        neg_consumption[i, :] = np.maximum(0, -rxn['nu'])\n    # total demand per species\n    demands = (K_alloc[:, None] * neg_consumption).sum(axis=0).astype(float)\n    # Compute alpha\n    alpha = 1.0\n    for s in range(d):\n        Ds = demands[s]\n        if Ds  0.0:\n            cap = x[s] / Ds\n            if cap  alpha:\n                alpha = cap\n    if alpha  1.0:\n        # Scale down counts\n        K_scaled = np.floor(alpha * K_alloc).astype(int)\n    else:\n        K_scaled = K_alloc\n    # State update\n    delta = np.zeros(d, dtype=int)\n    for i, rxn in enumerate(reactions):\n        if K_scaled[i] != 0:\n            delta += K_scaled[i] * rxn['nu']\n    x_new = x + delta\n    # Safety: enforce nonnegativity by clipping (should not be needed due to capping)\n    x_new = np.maximum(x_new, 0)\n    return x_new\n\ndef simulate(initial_state, reactions, tau, steps, seed):\n    rng = np.random.default_rng(seed)\n    x = np.array(initial_state, dtype=int)\n    for _ in range(steps):\n        x = tau_leap_step(x, reactions, tau, rng)\n    return x.tolist()\n\ndef format_results_no_spaces(list_of_lists):\n    # Format a list of lists of ints as a single string with no whitespace\n    inner = []\n    for lst in list_of_lists:\n        inner.append(\"[\" + \",\".join(str(int(v)) for v in lst) + \"]\")\n    return \"[\" + \",\".join(inner) + \"]\"\n\ndef solve():\n    # Define the test cases from the problem statement.\n\n    # Test case 1\n    reactions1 = [\n        {'rate': 20.0, 'reactant': np.array([0], dtype=int), 'nu': np.array([+1], dtype=int)},\n        {'rate': 0.3,  'reactant': np.array([1], dtype=int), 'nu': np.array([-1], dtype=int)},\n        {'rate': 0.2,  'reactant': np.array([1], dtype=int), 'nu': np.array([-1], dtype=int)},\n    ]\n    case1 = {\n        'initial': [50],\n        'reactions': reactions1,\n        'tau': 0.1,\n        'steps': 120,\n        'seed': 42,\n    }\n\n    # Test case 2\n    reactions2 = [\n        {'rate': 40.0,  'reactant': np.array([0], dtype=int), 'nu': np.array([+1], dtype=int)},\n        {'rate': 0.002, 'reactant': np.array([2], dtype=int), 'nu': np.array([-2], dtype=int)},\n        {'rate': 0.05,  'reactant': np.array([1], dtype=int), 'nu': np.array([-1], dtype=int)},\n    ]\n    case2 = {\n        'initial': [80],\n        'reactions': reactions2,\n        'tau': 0.05,\n        'steps': 200,\n        'seed': 7,\n    }\n\n    # Test case 3\n    reactions3 = [\n        {'rate': 0.005, 'reactant': np.array([1, 1], dtype=int), 'nu': np.array([0, -1], dtype=int)},   # X + Y - X\n        {'rate': 0.1,   'reactant': np.array([0, 1], dtype=int), 'nu': np.array([0, -1], dtype=int)},   # Y - ∅\n        {'rate': 5.0,   'reactant': np.array([0, 0], dtype=int), 'nu': np.array([0, +1], dtype=int)},   # ∅ - Y\n        {'rate': 2.0,   'reactant': np.array([0, 0], dtype=int), 'nu': np.array([+1, 0], dtype=int)},   # ∅ - X\n        {'rate': 0.05,  'reactant': np.array([1, 0], dtype=int), 'nu': np.array([-1, 0], dtype=int)},   # X - ∅\n    ]\n    case3 = {\n        'initial': [10, 60],\n        'reactions': reactions3,\n        'tau': 0.1,\n        'steps': 150,\n        'seed': 2021,\n    }\n\n    # Test case 4\n    reactions4 = [\n        {'rate': 1.0, 'reactant': np.array([1], dtype=int), 'nu': np.array([-1], dtype=int)}\n    ]\n    case4 = {\n        'initial': [0],\n        'reactions': reactions4,\n        'tau': 0.2,\n        'steps': 50,\n        'seed': 123,\n    }\n\n    test_cases = [case1, case2, case3, case4]\n\n    results = []\n    for case in test_cases:\n        final_state = simulate(case['initial'], case['reactions'], case['tau'], case['steps'], case['seed'])\n        results.append(final_state)\n\n    # Final print statement in the exact required format (no whitespace).\n    print(format_results_no_spaces(results))\n\nsolve()\n```", "id": "3354334"}]}