{"hands_on_practices": [{"introduction": "A key role of a numerical flux is to manage the flow of information between elements, and this choice has profound consequences for both the accuracy (dispersion) and stability (dissipation) of the simulation. This practice challenges you to reason about the distinct behaviors of central and Lax-Friedrichs fluxes. By doing so, you will uncover the fundamental trade-off between accurately propagating well-resolved waves and damping spurious, under-resolved oscillations. [@problem_id:3405177]", "problem": "Consider the $1$-dimensional linear advection equation $u_t + a\\,u_x = 0$ with constant speed $a \\in \\mathbb{R}$ on a periodic domain partitioned into a uniform mesh of elements of size $h$. A nodal Discontinuous Galerkin (DG) method (Discontinuous Galerkin (DG)) with polynomial degree $p$ and Legendre–Gauss–Lobatto nodes is used to construct a semi-discrete spatial operator. At inter-element interfaces, two numerical fluxes are considered: the central flux and the Lax–Friedrichs flux (Lax–Friedrichs (LF)). The central flux is defined as $f^* = \\tfrac{1}{2}\\big(a\\,u^- + a\\,u^+\\big)$, while the Lax–Friedrichs flux is $f^* = \\tfrac{1}{2}\\big(a\\,u^- + a\\,u^+\\big) - \\tfrac{\\alpha}{2}\\big(u^+ - u^-\\big)$ with a penalty parameter $\\alpha \\ge |a|$. Assume an exact-in-time analysis of the semi-discrete operator (i.e., time integration errors are excluded), and define the nondimensional wavenumber $\\theta = k h$ and the order-scaled wavenumber $\\kappa = \\theta/(p+1)$ for a Fourier mode $u(x,t) = \\hat{u}(t)e^{\\mathrm{i}k x}$.\n\nUsing only fundamental properties of the DG spatial discretization, including interface fluxes, periodicity, and Fourier-mode analysis, reason about the dispersion and dissipation characteristics of the two fluxes across wavenumbers. In particular:\n\n- For the central flux, determine whether the semi-discrete operator is dissipative or energy-conserving and explain how this affects the dispersion-dissipation curves as a function of $\\kappa$.\n- For the Lax–Friedrichs flux with $\\alpha = |a|$, determine how the interface penalty alters the energy balance and argue how the dissipation depends on $\\kappa$, especially as $\\kappa$ increases toward the element-scale resolution limit.\n- Based on these properties, identify the ranges of $\\kappa$ for which each flux is preferable for wave propagation when the goal is to preserve amplitude and phase of well-resolved waves while suppressing spurious under-resolved content.\n\nWhich statement best captures the correct comparison and preference across wavenumber ranges?\n\nA. For well-resolved modes with $\\kappa \\ll 1$, the central flux is preferable due to vanishing semi-discrete dissipation and smaller phase error; for under-resolved modes with $\\kappa = \\mathcal{O}(1)$ approaching the element Nyquist (i.e., $\\kappa \\to \\pi$), the Lax–Friedrichs flux is preferable because its dissipation increases with wavenumber and suppresses spurious high-frequency content.\n\nB. The Lax–Friedrichs flux is preferable uniformly across all wavenumbers because its added dissipation both reduces dispersion error and preserves amplitudes better than the central flux for any $\\kappa$.\n\nC. The central flux is preferable for high wavenumbers $\\kappa \\approx \\pi$ because its non-dissipative character preserves oscillations near the Nyquist, while the Lax–Friedrichs flux excessively damps resolved content in that range.\n\nD. The central and Lax–Friedrichs fluxes are equivalent for all wavenumbers whenever $\\alpha = |a|$, so there is no wavenumber-dependent preference in a nodal DG scheme.\n\nProvide the single best choice and justify it from first principles using the semi-discrete DG framework, the interface flux definitions, and Fourier-mode analysis of dispersion and dissipation. State any additional assumptions you need, and keep them scientifically realistic and consistent with the scenario. Clearly explain the reasoning, and do not rely on shortcut formulas or pre-stated target results.", "solution": "The problem statement is evaluated as valid. It presents a standard, well-posed problem in the numerical analysis of partial differential equations, using clearly defined terms and concepts from the field of Discontinuous Galerkin methods. All parameters and methods are standard and the question asks for a conceptual comparison based on fundamental principles.\n\nThe solution proceeds by analyzing the energy conservation properties of the semi-discrete DG operator for the two specified numerical fluxes. Let $u_h$ be the approximate solution, which is a polynomial of degree $p$ within each element $K_j = [x_{j-1/2}, x_{j+1/2}]$. The semi-discrete weak form of the advection equation $u_t + a u_x = 0$ is found by multiplying by a test function $v_h$ and integrating over an element $K_j$:\n$$ \\int_{K_j} \\frac{\\partial u_h}{\\partial t} v_h \\,dx - \\int_{K_j} a u_h \\frac{\\partial v_h}{\\partial x} \\,dx + \\left[ a u_h v_h \\right]_{x_{j-1/2}}^{x_{j+1/2}} = 0 $$\nThe boundary evaluation $[ \\cdot ]$ is replaced by a numerical flux term based on values from the left ($^-$) and right ($^+$) of each interface.\n$$ \\int_{K_j} \\frac{\\partial u_h}{\\partial t} v_h \\,dx - \\int_{K_j} a u_h \\frac{\\partial v_h}{\\partial x} \\,dx + f^*(u_h(x_{j+1/2}^-), u_h(x_{j+1/2}^+)) v_h(x_{j+1/2}^-) - f^*(u_h(x_{j-1/2}^-), u_h(x_{j-1/2}^+)) v_h(x_{j-1/2}^-) = 0 $$\nTo analyze the dissipation of the scheme, we set the test function $v_h = u_h$ and sum over all elements $j$. This leads to an equation for the time-evolution of the total semi-discrete energy, which is the $L^2$-norm squared, $\\|u_h\\|^2 = \\sum_j \\int_{K_j} u_h^2 \\,dx$. The rate of change of energy is given by the sum of contributions from each interface. For a generic interface with left state $u_L$ and right state $u_R$, the contribution to $\\frac{1}{2} \\frac{d}{dt} \\|u_h\\|^2$ is:\n$$ \\mathcal{J} = \\frac{a}{2}(u_L^2 - u_R^2) - (u_L - u_R)f^*(u_L, u_R) $$\nA non-positive value of $\\mathcal{J}$ for all $u_L, u_R$ indicates a dissipative (energy-stable) scheme, while $\\mathcal{J}=0$ indicates an energy-conserving scheme.\n\n**1. Analysis of the Central Flux**\n\nThe central flux is defined as $f^*_{\\text{central}} = \\frac{1}{2}(a u^- + a u^+)$. Substituting this into the energy contribution expression, with $u_L=u^-$ and $u_R=u^+$:\n$$ \\mathcal{J}_{\\text{central}} = \\frac{a}{2}(u_L^2 - u_R^2) - (u_L - u_R) \\left( \\frac{1}{2}(a u_L + a u_R) \\right) $$\n$$ \\mathcal{J}_{\\text{central}} = \\frac{a}{2}(u_L^2 - u_R^2) - \\frac{a}{2}(u_L - u_R)(u_L + u_R) $$\n$$ \\mathcal{J}_{\\text{central}} = \\frac{a}{2}(u_L^2 - u_R^2) - \\frac{a}{2}(u_L^2 - u_R^2) = 0 $$\nThus, the contribution from every interface is exactly zero, regardless of the values of $u_L$ and $u_R$. This proves that the DG semi-discretization with a central flux is **energy-conserving**. In the context of Fourier analysis, this means the eigenvalues of the semi-discrete operator are purely imaginary. The scheme has zero numerical dissipation for all wavenumbers $\\kappa$. While this perfectly preserves wave amplitudes, any dispersion error will cause waves of different frequencies to travel at incorrect speeds, leading to phase errors that accumulate over time. For high wavenumbers, these dispersion errors become large, causing unphysical oscillations (spurious modes) to persist and propagate through the domain.\n\n**2. Analysis of the Lax–Friedrichs (LF) Flux**\n\nThe Lax–Friedrichs flux is defined as $f^*_{\\text{LF}} = \\frac{1}{2}(a u^- + a u^+) - \\frac{\\alpha}{2}(u^+ - u^-)$, with $\\alpha = |a|$.\n$$ \\mathcal{J}_{\\text{LF}} = \\frac{a}{2}(u_L^2 - u_R^2) - (u_L - u_R) \\left( \\frac{1}{2}(a u_L + a u_R) - \\frac{\\alpha}{2}(u_R - u_L) \\right) $$\n$$ \\mathcal{J}_{\\text{LF}} = \\left( \\frac{a}{2}(u_L^2 - u_R^2) - \\frac{a}{2}(u_L^2 - u_R^2) \\right) - (u_L - u_R)\\left(-\\frac{\\alpha}{2}(u_R-u_L)\\right) $$\n$$ \\mathcal{J}_{\\text{LF}} = - (u_L - u_R)\\left(\\frac{\\alpha}{2}(u_L-u_R)\\right) = -\\frac{\\alpha}{2}(u_L - u_R)^2 $$\nSince we are given $\\alpha = |a| \\ge 0$, the energy contribution is $\\mathcal{J}_{\\text{LF}} = -\\frac{|a|}{2}(u_L - u_R)^2 \\le 0$. The scheme dissipates energy whenever there is a jump at an interface ($u_L \\neq u_R$). The amount of dissipation is proportional to the square of the jump.\n- For a **well-resolved** wave mode (low wavenumber, $\\kappa \\ll 1$), the polynomial representation $u_h$ is very accurate. The value of the polynomial at the element boundary is very close to the value from the neighboring element, so the jump $(u_L - u_R)$ is very small. Consequently, the dissipation is minimal.\n- For an **under-resolved** wave mode (high wavenumber, $\\kappa = \\mathcal{O}(1)$), the polynomial of degree $p$ cannot accurately capture the rapid oscillations. This leads to significant jumps at element interfaces as the polynomial from one element does not smoothly connect to the next. The term $(u_L - u_R)^2$ becomes large, causing substantial dissipation. This is a desirable property, as it damps spurious, high-frequency numerical noise that the grid and polynomial order cannot resolve accurately.\n\n**3. Comparison and Conclusion**\n\n- **For well-resolved waves ($\\kappa \\ll 1$):** The primary goal is accuracy in both amplitude and phase. The central flux is superior because it is non-dissipative (perfect amplitude preservation) and known to have very low phase (dispersion) error for high-order DG methods in this regime. The LF flux, while only weakly dissipative here, still introduces some unwanted damping and can have slightly larger phase error.\n- **For under-resolved waves ($\\kappa = \\mathcal{O}(1)$):** The primary goal shifts from accuracy (which is unattainable) to stability and suppression of non-physical artifacts. The central flux's lack of dissipation is a major drawback here, as it allows spurious modes with large phase errors to persist and pollute the solution. The Lax–Friedrichs flux is highly preferable in this regime because its dissipation scales with the jump, a proxy for unresolved content, effectively damping these spurious modes and stabilizing the scheme.\n\n**Evaluation of Options:**\n\n- **A:** This option correctly states that for well-resolved modes ($\\kappa \\ll 1$), the central flux is preferred for its lack of dissipation and low phase error. It also correctly states that for under-resolved modes ($\\kappa = \\mathcal{O}(1)$), the Lax-Friedrichs flux is preferred because its dissipation increases with wavenumber, suppressing spurious content. This aligns perfectly with the analysis. **Correct**.\n\n- **B:** This option claims the LF flux is uniformly preferable, which is false. For well-resolved waves, its dissipation is an undesirable artifact compared to the central flux. It also incorrectly claims LF preserves amplitudes better; the central flux preserves the $L^2$ norm perfectly, while LF dissipates it. **Incorrect**.\n\n- **C:** This option incorrectly claims the central flux is preferable for high wavenumbers. Preserving these highly dispersive, spurious oscillations is detrimental to the quality of the numerical solution. The damping provided by the LF flux in this range is beneficial, not excessive. **Incorrect**.\n\n- **D:** This option claims the fluxes are equivalent. The definitions and the energy analysis clearly show they are not. One is energy-conserving, the other is dissipative. They are only equivalent in the trivial case of a continuous solution ($u^-=u^+$ at all interfaces), which negates the \"Discontinuous\" in DG. **Incorrect**.", "answer": "$$\\boxed{A}$$", "id": "3405177"}, {"introduction": "The theoretical properties of a numerical scheme are encoded in the eigenvalue spectrum of its semi-discrete operator. In this hands-on coding exercise, you will build a Discontinuous Galerkin Spectral Element Method (DGSEM) operator and compute its eigenvalues to visualize how different flux choices physically alter the operator. This numerical experiment serves as a microscope, allowing you to directly observe how dissipation pushes eigenvalues into the stable left half-plane and how this effect changes with polynomial order. [@problem_id:3405180]", "problem": "Consider the one-dimensional linear advection equation $u_t + a u_x = 0$ on a periodic domain of length $L = 1$ with constant advection speed $a = 1$. Use a nodal Discontinuous Galerkin Spectral Element Method (DGSEM) with Legendre–Gauss–Lobatto (LGL) points per element, enforcing the Summation-By-Parts (SBP) property. The semi-discrete DGSEM operator is constructed on a uniform mesh of $K$ elements, each of size $h = L/K$, using a reference element mapping and strong-form collocation differentiation. Numerical fluxes at interfaces are taken as a one-parameter family:\n$$\n\\widehat{f}(u^-, u^+) = a \\left( \\tfrac{1}{2} (u^- + u^+) - \\tfrac{\\alpha}{2} (u^+ - u^-) \\right),\n$$\nwhere $u^-$ and $u^+$ are the left and right interface traces, and $\\alpha \\in [0,1]$ is the interface jump penalization strength. Special cases are $\\alpha = 0$ (central), $\\alpha = 1$ (upwind), and intermediate $\\alpha$ corresponding to skew-symmetric split-form fluxes with local Lax–Friedrichs penalization.\n\nYour task is to:\n1. Derive from the DG weak form and the SBP property a semi-discrete matrix operator $\\mathbf{L}(\\alpha, p, K)$ such that the global degrees of freedom vector $\\mathbf{u}$ satisfies $\\frac{d\\mathbf{u}}{dt} = \\mathbf{L}(\\alpha, p, K) \\mathbf{u}$. Here $p$ is the per-element polynomial degree, and the nodal basis consists of $p+1$ LGL nodes on each element.\n2. For each $\\alpha$, compute the eigenvalues of $\\mathbf{L}(\\alpha, p, K)$ and analyze how the real and imaginary parts of the spectrum depend on $p$ and $\\alpha$. In particular, identify “outlier” eigenmodes whose real parts lie significantly below the bulk of the spectrum, and quantify how their magnitude scales with the interface penalization strength $\\alpha$.\n\nUse the following foundational base for your derivation and construction:\n- The DG weak form on each element with interface numerical fluxes replacing physical fluxes at element boundaries.\n- The mapping from the physical coordinate $x$ to the reference coordinate $\\xi \\in [-1,1]$ with $x = x_e + \\frac{h}{2}\\xi$ and $u_x = \\frac{2}{h} u_\\xi$.\n- Nodal collocation at the LGL points, with a diagonal mass matrix based on LGL quadrature weights and a differentiation matrix obtained from the Lagrange basis derivatives at LGL nodes.\n- The Summation-By-Parts (SBP) property for the LGL differentiation and quadrature pair, which ensures energy stability for central fluxes and controls dissipation for penalized fluxes.\n\nNumerical and algorithmic requirements:\n- Use $K = 8$ elements with periodic boundary conditions.\n- For each $p \\in \\{1,2,4\\}$ and each $\\alpha \\in \\{0.0, 0.5, 1.0\\}$, assemble $\\mathbf{L}(\\alpha, p, K)$ and compute all eigenvalues.\n- Define outliers using a threshold\n$$\n\\theta = \\min\\left( \\mu_{\\Re} - 2 \\sigma_{\\Re}, -10^{-8} \\right),\n$$\nwhere $\\mu_{\\Re}$ and $\\sigma_{\\Re}$ are the mean and the standard deviation of the real parts of the eigenvalues. Count outliers as those eigenvalues whose real parts are strictly less than $\\theta$.\n- For each $p$, compute the Pearson correlation coefficient between the list of $\\alpha$ values $[0.0, 0.5, 1.0]$ and the corresponding list of minimum real parts of the eigenvalues $\\left[\\min \\Re(\\lambda(\\alpha))\\right]$. This coefficient quantifies how strengthening interface penalization pushes the most dissipative modes further left in the complex plane.\n- For each $p$, also compute $\\Delta_{\\min} = \\min \\Re(\\lambda(\\alpha{=}1.0)) - \\min \\Re(\\lambda(\\alpha{=}0.0))$, and the outlier count at $\\alpha = 1.0$.\n\nTest suite:\n- Element count $K = 8$, domain length $L = 1$, advection speed $a = 1$.\n- Polynomial degrees $p \\in \\{1, 2, 4\\}$.\n- Penalization strengths $\\alpha \\in \\{0.0, 0.5, 1.0\\}$.\n\nRequired final output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. For each $p$ in ascending order, append the triplet\n  - the correlation coefficient (float) between $\\alpha$ and $\\min \\Re(\\lambda)$,\n  - the value $\\Delta_{\\min}$ (float),\n  - the outlier count at $\\alpha = 1.0$ (integer).\n- Therefore, the final output must contain $3$ triplets in order $p = 1$, $p = 2$, $p = 4$, resulting in a list of $9$ entries overall, for example: \n\"[corr_p1,delta_p1,count_p1,corr_p2,delta_p2,count_p2,corr_p4,delta_p4,count_p4]\".", "solution": "The problem posed is a well-defined and standard task in the numerical analysis of partial differential equations, specifically concerning the spectral properties of a Discontinuous Galerkin Spectral Element Method (DGSEM) for the linear advection equation. All parameters and methodologies, such as the equation, domain, DGSEM formulation, Legendre-Gauss-Lobatto (LGL) nodes, Summation-By-Parts (SBP) property, and the definition of the numerical flux, are standard and correctly specified. The problem is scientifically grounded, self-contained, and algorithmically tractable. We may therefore proceed with the derivation and solution.\n\nOur objective is to construct the semi-discrete matrix operator $\\mathbf{L}(\\alpha, p, K)$ for the one-dimensional linear advection equation $u_t + a u_x = 0$ and analyze its eigenvalues. The domain is periodic of length $L=1$, discretized into $K$ uniform elements of size $h=L/K$. The advection speed is $a=1$. The solution within each element is approximated by a polynomial of degree $p$ in a nodal basis defined by the $p+1$ LGL points.\n\nWe begin with the strong-form DGSEM formulation. On each element $k$, we collocate the PDE at the $p+1$ LGL nodes. Let $\\mathbf{u}_k$ be the vector of solution values at the LGL nodes within element $k$. The time derivative of the solution at these nodes is given by the spatial operator applied to the solution, plus correction terms for the interface fluxes. The spatial derivative $u_x$ is mapped to the reference element $\\xi \\in [-1, 1]$ via $u_x = \\frac{2}{h} u_\\xi$. The derivative $u_\\xi$ at the nodes is approximated by matrix-vector multiplication with the LGL differentiation matrix, $\\mathbf{D}$.\n\nThe semi-discrete equation for the degrees of freedom in element $k$, $\\mathbf{u}_k$, is\n$$\n\\frac{d\\mathbf{u}_k}{dt} = -a \\frac{2}{h} \\mathbf{D} \\mathbf{u}_k + \\mathbf{C}_k\n$$\nwhere $\\mathbf{C}_k$ is a correction vector that enforces the user-defined numerical flux at the element interfaces. This correction only affects the boundary nodes of the element, which for LGL points are the first node ($\\xi_0 = -1$) and the last node ($\\xi_p = 1$). The correction term for a node $i$ is derived from the difference between the numerical flux and the physical flux, scaled by the inverse of the corresponding mass matrix entry. For a diagonal mass matrix $\\mathbf{M} = \\text{diag}(w_0, \\dots, w_p)$ (scaled by the Jacobian $h/2$), the update for node $i$ is:\n$$\n\\frac{du_{i,k}}{dt} = -a \\frac{2}{h} (\\mathbf{D} \\mathbf{u}_k)_i - \\frac{2}{h} \\frac{1}{w_i} \\left[ \\delta_{ip} (\\widehat{f}(u_p^k, u_0^{k+1}) - f(u_p^k)) - \\delta_{i0} (\\widehat{f}(u_p^{k-1}, u_0^k) - f(u_0^k)) \\right]\n$$\nwhere $f(u) = au$ is the physical flux, and $u_j^k$ denotes the solution at node $j$ of element $k$. The Kronecker deltas $\\delta_{ip}$ and $\\delta_{i0}$ ensure the corrections are applied only at nodes $p$ (right boundary, $\\xi=1$) and $0$ (left boundary, $\\xi=-1$), respectively. The indices on neighboring elements, $k-1$ and $k+1$, are handled periodically.\n\nThe numerical flux is given by $\\widehat{f}(u^-, u^+) = a \\left( \\frac{1}{2} (u^- + u^+) - \\frac{\\alpha}{2} (u^+ - u^-) \\right)$, which can be rewritten as $\\widehat{f}(u^-, u^+) = a \\left( \\frac{1+\\alpha}{2} u^- + \\frac{1-\\alpha}{2} u^+ \\right)$.\n\nAt the left boundary of element $k$ (node $0$), we have $u^- = u_p^{k-1}$ and $u^+ = u_0^k$. The flux mismatch is:\n$$\n\\widehat{f}(u_p^{k-1}, u_0^k) - f(u_0^k) = a \\left( \\frac{1+\\alpha}{2} u_p^{k-1} + \\frac{1-\\alpha}{2} u_0^k \\right) - a u_0^k = a \\frac{1+\\alpha}{2} u_p^{k-1} - a \\frac{1+\\alpha}{2} u_0^k = -a \\frac{1+\\alpha}{2} (u_0^k - u_p^{k-1})\n$$\nAt the right boundary of element $k$ (node $p$), we have $u^- = u_p^k$ and $u^+ = u_0^{k+1}$. The flux mismatch is:\n$$\n\\widehat{f}(u_p^k, u_0^{k+1}) - f(u_p^k) = a \\left( \\frac{1+\\alpha}{2} u_p^k + \\frac{1-\\alpha}{2} u_0^{k+1} \\right) - a u_p^k = a \\frac{1-\\alpha}{2} u_0^{k+1} - a \\frac{1-\\alpha}{2} u_p^k = a \\frac{1-\\alpha}{2} (u_0^{k+1} - u_p^k)\n$$\nSubstituting these into the nodal update equation:\nFor node $i=0$:\n$$\n\\frac{du_{0,k}}{dt} = -a \\frac{2}{h} (\\mathbf{D} \\mathbf{u}_k)_0 - \\frac{2}{h} \\frac{1}{w_0} \\left[ - \\left( -a \\frac{1+\\alpha}{2} (u_0^k - u_p^{k-1}) \\right) \\right] = -a \\frac{2}{h} (\\mathbf{D} \\mathbf{u}_k)_0 - \\frac{a(1+\\alpha)}{h w_0} (u_0^k - u_p^{k-1})\n$$\nFor node $i=p$:\n$$\n\\frac{du_{p,k}}{dt} = -a \\frac{2}{h} (\\mathbf{D} \\mathbf{u}_k)_p - \\frac{2}{h} \\frac{1}{w_p} \\left[ a \\frac{1-\\alpha}{2} (u_0^{k+1} - u_p^k) \\right] = -a \\frac{2}{h} (\\mathbf{D} \\mathbf{u}_k)_p - \\frac{a(1-\\alpha)}{h w_p} (u_0^{k+1} - u_p^k)\n$$\nWe can now assemble the global matrix operator $\\mathbf{L}$ of size $N \\times N$, where $N=K(p+1)$. The vector of global degrees of freedom is $\\mathbf{U} = [\\mathbf{u}_0^T, \\dots, \\mathbf{u}_{K-1}^T]^T$. The system is $\\frac{d\\mathbf{U}}{dt} = \\mathbf{L} \\mathbf{U}$. The matrix $\\mathbf{L}$ has a block-circulant structure. The diagonal blocks $\\mathbf{L}_{k,k}$ represent intra-element contributions, while off-diagonal blocks $\\mathbf{L}_{k,k-1}$ and $\\mathbf{L}_{k,k+1}$ represent inter-element coupling.\n\n1.  **Volume term**: The differentiation term $-a \\frac{2}{h} \\mathbf{D}$ contributes to the diagonal blocks $\\mathbf{L}_{k,k}$.\n2.  **Surface terms (diagonal blocks)**:\n    - The term $-\\frac{a(1+\\alpha)}{h w_0} u_0^k$ adds to the $(0,0)$ entry of $\\mathbf{L}_{k,k}$.\n    - The term $+\\frac{a(1-\\alpha)}{h w_p} u_p^k$ adds to the $(p,p)$ entry of $\\mathbf{L}_{k,k}$.\n3.  **Surface terms (off-diagonal blocks)**:\n    - The term $+\\frac{a(1+\\alpha)}{h w_0} u_p^{k-1}$ contributes to the $(0,p)$ entry of the block $\\mathbf{L}_{k,k-1}$.\n    - The term $-\\frac{a(1-\\alpha)}{h w_p} u_0^{k+1}$ contributes to the $(p,0)$ entry of the block $\\mathbf{L}_{k,k+1}$.\n\nThe SBP property of the LGL-point-based differentiation operator $\\mathbf{D}$ and mass matrix $\\mathbf{M}$ is $\\mathbf{M}\\mathbf{D} + (\\mathbf{M}\\mathbf{D})^T = \\text{diag}(-1, 0, \\dots, 0, 1)$. This property guarantees that for a central flux ($\\alpha=0$), the semi-discrete operator is energy-stable, meaning the eigenvalues have zero or non-positive real parts (ideally zero for the advection equation). For $\\alpha > 0$, dissipation is introduced, pushing the real parts of eigenvalues to be strictly negative.\n\nThe numerical implementation will construct this matrix for each given set of parameters $(p, \\alpha)$, compute its eigenvalues, and perform the specified analysis: calculating the Pearson correlation between $\\alpha$ and the minimum real part of the eigenvalues, the difference in $\\min \\Re(\\lambda)$ between upwind and central fluxes, and counting the number of outlier modes for the upwind case.", "answer": "```python\nimport numpy as np\nfrom scipy.special import roots_jacobi, legendre\n\ndef get_lgl_basis(p):\n    \"\"\"\n    Computes LGL nodes, weights, and the differentiation matrix for a given\n    polynomial degree p.\n    \"\"\"\n    if p == 0:\n      return np.array([-1.0]), np.array([2.0]), np.array([[0.0]])\n      \n    if p == 1:\n        xi = np.array([-1.0, 1.0])\n        w = np.array([1.0, 1.0])\n        D = np.array([[-0.5, 0.5], [-0.5, 0.5]])\n        return xi, w, D\n\n    # Interior nodes are roots of the derivative of the p-th Legendre polynomial,\n    # which are roots of the Jacobi polynomial P_{p-1}^{(1,1)}.\n    xi_interior, _ = roots_jacobi(p - 1, 1, 1)\n    xi = np.concatenate(([-1.0], np.sort(xi_interior), [1.0]))\n\n    # Legendre polynomial object\n    P_p_poly = legendre(p)\n    P_p_vals = P_p_poly(xi)\n\n    # Weights\n    w = 2.0 / (p * (p + 1) * P_p_vals**2)\n\n    # Differentiation matrix\n    D = np.zeros((p + 1, p + 1))\n    for i in range(p + 1):\n        for j in range(p + 1):\n            if i != j:\n                D[i, j] = P_p_vals[i] / (P_p_vals[j] * (xi[i] - xi[j]))\n            else:\n                if i == 0:\n                    D[i, i] = -p * (p + 1) / 4.0\n                elif i == p:\n                    D[i, i] = p * (p + 1) / 4.0\n                else:\n                    D[i, i] = 0.0\n    return xi, w, D\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem.\n    \"\"\"\n    L_domain = 1.0\n    a = 1.0\n    K = 8\n    h = L_domain / K\n\n    p_list = [1, 2, 4]\n    alpha_list = [0.0, 0.5, 1.0]\n\n    all_results = []\n\n    for p in p_list:\n        xi, w, D = get_lgl_basis(p)\n        N_p = p + 1\n        N_global = K * N_p\n\n        min_real_parts = []\n        outlier_count_alpha1 = 0\n\n        for alpha in alpha_list:\n            L_matrix = np.zeros((N_global, N_global), dtype=np.complex128)\n\n            # Volume contribution (same for all elements)\n            D_block = -a * 2.0 / h * D\n\n            # Surface contributions\n            # Self-coupling terms\n            C_self_00 = -a * (1.0 + alpha) / (h * w[0])\n            C_self_pp = a * (1.0 - alpha) / (h * w[p])\n            \n            # Neighbor-coupling terms\n            C_left_0p = a * (1.0 + alpha) / (h * w[0])\n            C_right_p0 = -a * (1.0 - alpha) / (h * w[p])\n\n            for k in range(K):\n                offset = k * N_p\n\n                # Diagonal block (volume + self-coupling surface terms)\n                L_matrix[offset : offset + N_p, offset : offset + N_p] = D_block\n                L_matrix[offset, offset] += C_self_00\n                L_matrix[offset + p, offset + p] += C_self_pp\n\n                # Off-diagonal blocks (neighbor-coupling surface terms)\n                # Periodic boundary conditions\n                km1 = (k - 1 + K) % K\n                kp1 = (k + 1) % K\n                \n                L_matrix[offset, km1 * N_p + p] += C_left_0p\n                L_matrix[offset + p, kp1 * N_p] += C_right_p0\n\n            # Compute eigenvalues\n            eigenvalues = np.linalg.eigvals(L_matrix)\n            real_parts = eigenvalues.real\n            min_real_parts.append(np.min(real_parts))\n\n            # Outlier analysis for alpha = 1.0\n            if alpha == 1.0:\n                mu_re = np.mean(real_parts)\n                sigma_re = np.std(real_parts)\n                threshold = min(mu_re - 2 * sigma_re, -1e-8)\n                outlier_count_alpha1 = int(np.sum(real_parts  threshold))\n\n        # Compute Pearson correlation\n        corr_matrix = np.corrcoef(alpha_list, min_real_parts)\n        # Handle case of zero variance if min_real_parts are constant\n        if np.isnan(corr_matrix[0, 1]):\n            correlation = 0.0\n        else:\n            correlation = corr_matrix[0, 1]\n\n        # Compute Delta_min\n        delta_min = min_real_parts[2] - min_real_parts[0]\n\n        all_results.extend([correlation, delta_min, outlier_count_alpha1])\n\n    # Format and print the final output\n    print(f\"[{','.join(f'{x:.6f}' if isinstance(x, float) else str(x) for x in all_results)}]\")\n\nsolve()\n```", "id": "3405180"}, {"introduction": "Moving beyond the simple scalar advection equation, many real-world systems, like atmospheric or oceanic models, involve a delicate balance between flux gradients and source terms. A robust numerical scheme must preserve these balances at the discrete level, a property known as well-balancing. This advanced practice guides you through implementing a well-balanced scheme for the shallow water equations, demonstrating how a careful \"flux-source pairing\" is essential for preventing spurious numerical artifacts in complex simulations. [@problem_id:3405150]", "problem": "Consider the two-dimensional shallow water equations with Coriolis acceleration on a flat bottom, written for the fluid depth $h(x,y,t)$ and depth-averaged velocity $(u(x,y,t),v(x,y,t))$:\n$$\n\\partial_t h + \\partial_x (h u) + \\partial_y (h v) = 0,\n$$\n$$\n\\partial_t (h u) + \\partial_x\\left(h u^2 + \\tfrac{1}{2} g h^2\\right) + \\partial_y (h u v) = f_c h v,\n$$\n$$\n\\partial_t (h v) + \\partial_x (h u v) + \\partial_y\\left(h v^2 + \\tfrac{1}{2} g h^2\\right) = - f_c h u,\n$$\nwhere $g$ is gravitational acceleration and $f_c$ is the Coriolis parameter. Assume fields depend only on the coordinate $y$ and time $t$ (no $x$-variation), and consider the geostrophically balanced steady state in which $(\\partial_t h,\\partial_t u,\\partial_t v)=(0,0,0)$, $v(y)=0$, and $u(y)$ is such that the $y$-momentum equation balances the hydrostatic pressure gradient against the Coriolis force.\n\nYou will construct and analyze a Discontinuous Galerkin (DG) discretization for the $y$-momentum equation on a one-dimensional domain in $y$:\n$$\n\\partial_t (h v) + \\partial_y\\left(\\tfrac{1}{2} g h^2\\right) = - f_c h u,\n$$\nunder the geostrophic assumption $v(y)=0$. The computational domain is the interval $[0,1]$ partitioned into two equal elements $[0,\\tfrac{1}{2}]$ and $[\\tfrac{1}{2},1]$. On each element, use a polynomial approximation of degree $p$ with Legendre–Gauss–Lobatto nodes, and let $\\{\\ell_j(y)\\}_{j=0}^{p}$ denote the local Lagrange basis functions. Denote by $F(y) := \\tfrac{1}{2} g h(y)^2$ and by $S(y) := - f_c h(y) u(y)$ the hydrostatic pressure flux and Coriolis source, respectively. The DG weak form for the $y$-momentum equation in steady geostrophic balance reduces to testing against each basis function $\\ell_j$ and enforcing the discrete residual\n$$\n\\mathcal{R}_j = - \\int_{K} \\partial_y \\ell_j(y)\\, F(y)\\, dy + \\left.\\ell_j(y)\\,F^*(y)\\,n(y)\\right|_{\\partial K} - \\int_K \\ell_j(y)\\, S(y)\\, dy,\n$$\nto vanish on each element $K$, where $n(y)$ is the outward unit normal at the element boundary (in one dimension $n=-1$ on the left face and $n=+1$ on the right face), and $F^*(y)$ is a numerical flux function at the element boundary. The task is to:\n1. Starting from the continuous geostrophic balance relation (hydrostatic pressure gradient equals Coriolis force), justify a flux–source pairing in which the interface flux function $F^*$ and a discrete source term are chosen so that the discrete residual $\\mathcal{R}_j$ vanishes exactly for geostrophically balanced states represented at the Legendre–Gauss–Lobatto nodes, provided the element boundary values of $h$ are evaluated consistently at the shared interface.\n2. Quantify how replacing the volume source integral by an alternative quadrature rule that does not match the flux pairing affects the discrete residual, and explain the mechanism of the imbalance.\n\nYou must implement a program that, for given $p$, gravitational acceleration $g$, Coriolis parameter $f_c$, and a choice of depth profile $h(y)$ with the corresponding geostrophic velocity $u(y)$, evaluates the discrete residual vector over all degrees of freedom on both elements and returns the Euclidean norm of the residual. In all computations use dimensionless units with $g=1$ and $f_c=1$ (no physical unit conversion required; report dimensionless residual magnitudes as floating-point numbers).\n\nFor the flux–source pairing, enforce the following design choices:\n- Use interface numerical flux $F^*$ equal to the hydrostatic pressure potential evaluated at the shared boundary value of $h$ (the boundary coordinate is common to both adjacent elements so the boundary value is single-valued under pointwise evaluation of $h$).\n- For exact geostrophic preservation, discretize the Coriolis source by the discrete derivative of the hydrostatic pressure potential computed with the same Legendre–Gauss–Lobatto derivative operator used for the flux volume term.\n- For quadrature mismatch analysis, approximate the Coriolis source volume integral by Legendre–Gauss quadrature with $q$ points on each element, evaluating the continuous expression $S(y)=g h(y)\\,\\partial_y h(y)$ at those quadrature points and the basis functions at the same points. Keep the flux volume term and interface flux as in the exact pairing.\n\nYour program must implement the following test suite and output the four residual norms on a single line in the exact format specified at the end of this problem:\n\n- Test Case 1 (matched pairing, polynomial depth): $p=4$, $h(y)=1+0.2\\,y+0.1\\,y^2$, $g=1$, $f_c=1$. Use the exact pairing (discrete source as the discrete derivative of the hydrostatic pressure potential with the same Legendre–Gauss–Lobatto operators). Return the Euclidean norm of the assembled residual vector.\n\n- Test Case 2 (quadrature mismatch, same polynomial depth): $p=4$, $h(y)=1+0.2\\,y+0.1\\,y^2$, $g=1$, $f_c=1$, but compute the source volume integral using Legendre–Gauss quadrature with $q=5$ points per element and the continuous formula $S(y)=g h(y)\\,\\partial_y h(y)$ evaluated at those points. Return the Euclidean norm of the assembled residual vector.\n\n- Test Case 3 (boundary-degree edge case, linear depth with mismatch): $p=1$, $h(y)=1+0.3\\,y$, $g=1$, $f_c=1$, source integral by Legendre–Gauss quadrature with $q=2$ points per element. Return the Euclidean norm of the assembled residual vector.\n\n- Test Case 4 (non-polynomial depth with mismatch): $p=6$, $h(y)=1+0.1\\sin(2\\pi y)$, $g=1$, $f_c=1$, source integral by Legendre–Gauss quadrature with $q=6$ points per element. Return the Euclidean norm of the assembled residual vector.\n\nFinal Output Format:\nYour program should produce a single line of output containing the four residual norms as a comma-separated list enclosed in square brackets. For example, it should print a line of the form\n$$\n[\\text{result1},\\text{result2},\\text{result3},\\text{result4}]\n$$\nwhere each entry is a floating-point number.", "solution": "The problem requires the construction and analysis of a Discontinuous Galerkin (DG) discretization for the one-dimensional $y$-momentum equation of the shallow water equations, specialized to a steady geostrophic balance. The analysis focuses on the concept of well-balancing, where the numerical scheme is designed to exactly preserve this balanced state.\n\nFirst, we establish the continuous geostrophic balance relation. The shallow water equations are given, and under the assumptions of steady state ($\\partial_t = 0$), no variation in the $x$-direction ($\\partial_x = 0$), and zero velocity in the $y$-direction ($v=0$), the $y$-momentum equation simplifies significantly.\nThe full equation is:\n$$\n\\partial_t (h v) + \\partial_x (h u v) + \\partial_y\\left(h v^2 + \\tfrac{1}{2} g h^2\\right) = - f_c h u\n$$\nApplying the assumptions, all terms containing $v$ or $\\partial_t$ vanish, and the $\\partial_x$ term is zero by assumption, leaving:\n$$\n\\partial_y\\left(\\tfrac{1}{2} g h^2\\right) = - f_c h u\n$$\nThis equation represents the geostrophic balance, where the hydrostatic pressure gradient force in the $y$-direction is balanced by the Coriolis force. We define the hydrostatic pressure flux as $F(y) = \\tfrac{1}{2} g h(y)^2$ and the Coriolis source term as $S(y) = -f_c h(y) u(y)$. The continuous balance is thus compactly written as $\\partial_y F(y) = S(y)$. For the specified dimensionless units $g=1$ and $f_c=1$, the geostrophic velocity is $u(y) = -(g/f_c) \\partial_y h(y) = - \\partial_y h(y)$. The source term becomes $S(y) = - (1) h(y) (-\\partial_y h(y)) = h(y) \\partial_y h(y)$. This is consistent with the flux derivative, since $\\partial_y F(y) = \\partial_y(\\frac{1}{2}h(y)^2) = h(y) \\partial_y h(y)$.\n\nNext, we establish the DG weak formulation. Multiplying the equation $\\partial_y F = S$ by a test function $\\ell_j(y)$ (a Lagrange basis polynomial of degree $p$) and integrating over a computational element $K$ gives:\n$$\n\\int_K \\ell_j(y) (\\partial_y F(y)) dy = \\int_K \\ell_j(y) S(y) dy\n$$\nIntegrating the flux term by parts yields:\n$$\n\\left[ \\ell_j(y) F(y) \\right]_{\\partial K} - \\int_K (\\partial_y \\ell_j(y)) F(y) dy = \\int_K \\ell_j(y) S(y) dy\n$$\nIn a DG context, the single-valued flux $F$ at element boundaries is replaced by a numerical flux $F^*$. The boundary term is written as $\\left. \\ell_j(y) F^*(y) n(y) \\right|_{\\partial K}$, where $n(y)$ is the outward unit normal. The discrete residual for the $i$-th degree of freedom on element $K$ is then defined as:\n$$\n\\mathcal{R}_j = - \\int_{K} \\partial_y \\ell_j(y)\\, F(y)\\, dy + \\left.\\ell_j(y)\\,F^*(y)\\,n(y)\\right|_{\\partial K} - \\int_K \\ell_j(y)\\, S(y)\\, dy\n$$\nThe problem requires this residual to be evaluated for a discrete approximation where the solution is represented by its values at the $p+1$ Legendre-Gauss-Lobatto (LGL) nodes within each element. Let $F_p(y)$ be the polynomial interpolant of the flux function $F(y)$ through these nodes.\n\n**Part 1: Justification of the Flux-Source Pairing**\n\nA well-balanced scheme is one where the discrete residual $\\mathcal{R}_j$ is identically zero when the exact continuous balanced solution is used as input. This is achieved by defining the discrete source term in a way that it exactly cancels the discrete flux derivative.\n\nThe DG discretization is performed on LGL nodes. A key property of these nodal sets is that the associated differentiation matrix $\\mathbf{D}$ and diagonal mass matrix (quadrature weights) $\\mathbf{W}$ satisfy the summation-by-parts (SBP) property: $\\mathbf{D}^T\\mathbf{W} + \\mathbf{W}\\mathbf{D} = \\mathbf{B}$, where $\\mathbf{B}=\\text{diag}([-1, 0, \\dots, 0, 1])$.\n\nThe volume integrals in the residual are approximated using LGL quadrature, which is based on the nodal values.\nThe flux integral term (vector form) is $\\mathbf{I}_1 = -(\\mathbf{D}^T \\mathbf{W}) \\mathbf{F}$, where $\\mathbf{F}$ is the vector of flux values at the nodes.\nThe well-balanced source term, as specified, uses the same LGL derivative operator. In the nodal framework, this means the discrete source vector $\\mathbf{S}_{\\text{node}}$ is defined as the discrete derivative of the flux vector: $\\mathbf{S}_{\\text{node}} = \\mathbf{D} \\mathbf{F}$. The corresponding source integral term is $\\mathbf{I}_3 = -\\mathbf{W} \\mathbf{S}_{\\text{node}} = -\\mathbf{W}\\mathbf{D}\\mathbf{F}$.\n\nThe sum of the volume terms in the residual is thus:\n$$\n\\mathbf{I}_1 + \\mathbf{I}_3 = -(\\mathbf{D}^T\\mathbf{W})\\mathbf{F} - (\\mathbf{W}\\mathbf{D})\\mathbf{F} = -(\\mathbf{D}^T\\mathbf{W} + \\mathbf{W}\\mathbf{D})\\mathbf{F} = -\\mathbf{B}\\mathbf{F}\n$$\nThis results in a vector where the only non-zero entries correspond to the element boundaries: $-(-1)F_0$ for the first node ($j=0$) and $-(+1)F_p$ for the last node ($j=p$). So, the combined volume-term residual is $(F_0, 0, \\dots, 0, -F_p)^T$, where $F_0$ and $F_p$ are flux values at the left and right boundaries of the element.\n\nThe boundary flux term in the residual is $\\mathbf{I}_2$. For basis function $\\ell_j$, it is non-zero only at the endpoints. For $j=0$, the contribution is $\\ell_0(y_{\\text{left}}) F^*(y_{\\text{left}}) n_{\\text{left}} = (1) F^*(y_{\\text{left}}) (-1) = -F^*(y_{\\text{left}})$. For $j=p$, the contribution is $\\ell_p(y_{\\text{right}}) F^*(y_{\\text{right}}) n_{\\text{right}} = (1) F^*(y_{\\text{right}}) (+1) = F^*(y_{\\text{right}})$. The vector $\\mathbf{I}_2$ is $(-F^*(y_{\\text{left}}), 0, \\dots, 0, F^*(y_{\\text{right}}))^T$.\n\nThe total residual vector is $\\mathcal{R} = (\\mathbf{I}_1 + \\mathbf{I}_3) + \\mathbf{I}_2$.\n$$\n\\mathcal{R} = \\begin{pmatrix} F_0 \\\\ 0 \\\\ \\vdots \\\\ 0 \\\\ -F_p \\end{pmatrix} + \\begin{pmatrix} -F^*(y_{\\text{left}}) \\\\ 0 \\\\ \\vdots \\\\ 0 \\\\ F^*(y_{\\text{right}}) \\end{pmatrix} = \\begin{pmatrix} F_0 - F^*(y_{\\text{left}}) \\\\ 0 \\\\ \\vdots \\\\ 0 \\\\ -F_p + F^*(y_{\\text{right}}) \\end{pmatrix}\n$$\nThe problem states that the numerical flux $F^*$ is evaluated at the shared boundary value of $h$. This is a central flux, meaning $F^* = F$ at the boundaries. Consequently, $F_0 - F^*(y_{\\text{left}}) = 0$ and $-F_p + F^*(y_{\\text{right}}) = 0$. The entire discrete residual vector $\\mathcal{R}$ vanishes. This justifies the proposed flux-source pairing: it ensures that the discrete geostrophic balance is maintained to machine precision.\n\n**Part 2: Quadrature Mismatch and Imbalance**\n\nWhen the source volume integral is computed using an alternative method, the exact cancellation demonstrated above is broken. The problem specifies using a $q$-point Legendre-Gauss (LG) quadrature rule to approximate $\\int_K \\ell_j(y) S(y) dy$, where $S(y)$ is the *continuous* source function $S(y) = g h(y) \\partial_y h(y)$.\n\nThe residual is now calculated as $\\mathcal{R} = \\mathbf{I}_1 + \\mathbf{I}_2 + \\mathbf{I}_{3, \\text{mismatch}}$. The flux terms $\\mathbf{I}_1$ and $\\mathbf{I}_2$ are unchanged. The new source term $\\mathbf{I}_{3, \\text{mismatch}}$ no longer satisfies the algebraic identity required for cancellation with the flux gradient term $\\mathbf{I}_1$.\n\nThe mechanism of the imbalance is the loss of consistency between the discrete operators for the flux gradient and the source term. While the continuous geostrophic state satisfies $S = \\partial_y F$, the well-balanced numerical scheme requires that the discrete representations also satisfy this, i.e., $\\text{Discrete}(S) = \\text{Discrete}(\\partial_y F)$. By using a different numerical procedure (LG quadrature on the analytic source function) for the source term than for the flux gradient (which is implicitly defined by the LGL-based weak form), this consistency is violated. The resulting residual $\\mathcal{R}$ will be non-zero, representing a spurious force that would accelerate the fluid away from the steady state in a time-dependent simulation. The magnitude of this residual quantifies the degree of the imbalance.\n\nThe program below implements the calculation of the Euclidean norm of the assembled residual vector for both the well-balanced (matched) and non-well-balanced (mismatched) schemes across four test cases.", "answer": "```python\nimport numpy as np\nfrom scipy.special import legendre, roots_jacobi\nfrom scipy.interpolate import BarycentricInterpolator\n\ndef solve():\n    \"\"\"\n    Solves the Discontinuous Galerkin residual problem for the shallow water equations.\n    \"\"\"\n\n    # Helper functions for spectral/DG methods, nested to be self-contained.\n    def get_lgl_nodes_weights(p):\n        \"\"\"Computes Legendre-Gauss-Lobatto nodes and weights for degree p on [-1, 1].\"\"\"\n        if p == 0:\n            return np.array([0.0]), np.array([2.0])\n        if p == 1:\n            return np.array([-1.0, 1.0]), np.array([1.0, 1.0])\n        \n        # Interior nodes are roots of P_p'(x) == roots of Jacobi polynomial P_{p-1}^{(1,1)}(x)\n        interior_nodes = roots_jacobi(p - 1, 1, 1)[0]\n        nodes = np.concatenate([[-1.0], interior_nodes, [1.0]])\n        \n        # Weights\n        leg_p_at_nodes = legendre(p)(nodes)\n        weights = 2.0 / (p * (p + 1) * leg_p_at_nodes**2)\n        \n        return nodes, weights\n\n    def get_lgl_diff_matrix(p, nodes):\n        \"\"\"Computes the LGL differentiation matrix for degree p on [-1, 1].\"\"\"\n        if p == 0:\n            return np.array([[0.0]])\n        \n        N = p + 1\n        D = np.zeros((N, N))\n        leg_p_at_nodes = legendre(p)(nodes)\n        \n        for i in range(N):\n            for j in range(N):\n                if i != j:\n                    D[i, j] = (leg_p_at_nodes[i] / leg_p_at_nodes[j]) / (nodes[i] - nodes[j])\n                else:\n                    if i == 0:\n                        D[i, j] = -p * (p + 1) / 4.0\n                    elif i == p:\n                        D[i, j] = p * (p + 1) / 4.0\n                    else:\n                        D[i, j] = 0.0\n        return D\n\n    def get_lagrange_basis_eval_matrix(eval_pts, nodes):\n        \"\"\"Computes matrix L where L_ij = l_j(eval_pts_i).\"\"\"\n        n_nodes = len(nodes)\n        n_eval = len(eval_pts)\n        L = np.zeros((n_eval, n_nodes))\n        \n        ident = np.eye(n_nodes)\n        for j in range(n_nodes):\n            # The j-th basis function has value 1 at node j and 0 at others.\n            interp = BarycentricInterpolator(nodes, ident[j, :])\n            if n_eval > 0:\n                L[:, j] = interp(eval_pts)\n        return L\n\n\n    def calculate_residual_norm(p, h_func, h_prime_func, g, f_c, mode, q=None):\n        \"\"\"\n        Calculates the Euclidean norm of the DG residual vector.\n        \"\"\"\n        domain = [0.0, 1.0]\n        elements = [[0.0, 0.5], [0.5, 1.0]]\n        total_dofs = 2 * (p + 1)\n        global_residual = np.zeros(total_dofs)\n\n        lgl_nodes_ref, lgl_weights_ref = get_lgl_nodes_weights(p)\n        diff_matrix_ref = get_lgl_diff_matrix(p, lgl_nodes_ref)\n\n        for e_idx, elem_bounds in enumerate(elements):\n            y_a, y_b = elem_bounds\n            jacobian = (y_b - y_a) / 2.0\n            \n            # Map reference nodes to physical element\n            y_nodes = y_a + jacobian * (lgl_nodes_ref + 1.0)\n            \n            # Evaluate functions at nodes\n            h_vals = h_func(y_nodes)\n            F_vals = 0.5 * g * h_vals**2\n\n            # 1. Flux volume term: I1 = - (D_ref^T @ W_ref) @ F_vals\n            # (D_ref.T @ diag(W_ref)) is the weak derivative matrix\n            I1_vec = - (diff_matrix_ref.T @ np.diag(lgl_weights_ref)) @ F_vals\n\n            # 2. Boundary flux term: I2\n            F_left = 0.5 * g * h_func(y_a)**2\n            F_right = 0.5 * g * h_func(y_b)**2\n            I2_vec = np.zeros(p + 1)\n            I2_vec[0] = -F_left  # n=-1 at left boundary\n            I2_vec[-1] = F_right # n=+1 at right boundary\n\n            # 3. Source term: I3\n            if mode == 'matched':\n                # S_node = D_phys @ F_vals = (1/J) * D_ref @ F_vals\n                S_node_vals = (1.0 / jacobian) * (diff_matrix_ref @ F_vals)\n                # I3 = - M @ S_node = - J * W_ref * S_node\n                I3_vec = - (jacobian * lgl_weights_ref) * S_node_vals\n            \n            elif mode == 'mismatched':\n                lg_nodes_ref, lg_weights_ref = np.polynomial.legendre.leggauss(q)\n                y_lg = y_a + jacobian * (lg_nodes_ref + 1.0)\n                \n                # Evaluate analytical source S(y) = g*h(y)*h'(y) at LG quadrature points\n                S_vals_at_lg = g * h_func(y_lg) * h_prime_func(y_lg)\n                \n                # Evaluate Lagrange basis functions at LG points\n                lagrange_eval_matrix = get_lagrange_basis_eval_matrix(lg_nodes_ref, lgl_nodes_ref)\n                \n                # I3_i = - integral(l_i * S)_K = - J * sum(w_k * l_i(y_k) * S(y_k))\n                I3_vec = -jacobian * (lagrange_eval_matrix.T @ (lg_weights_ref * S_vals_at_lg))\n            \n            else:\n                raise ValueError(\"Invalid mode specified.\")\n\n            elem_residual = I1_vec + I2_vec + I3_vec\n            start_idx = e_idx * (p + 1)\n            end_idx = start_idx + (p + 1)\n            global_residual[start_idx:end_idx] = elem_residual\n\n        return np.linalg.norm(global_residual)\n\n    # Test Case Definitions\n    g_val, fc_val = 1.0, 1.0\n    \n    # Case 1\n    p1 = 4\n    h1 = lambda y: 1.0 + 0.2*y + 0.1*y**2\n    h1_p = lambda y: 0.2 + 0.2*y\n    res1 = calculate_residual_norm(p1, h1, h1_p, g_val, fc_val, 'matched')\n    \n    # Case 2\n    p2, q2 = 4, 5\n    h2 = h1\n    h2_p = h1_p\n    res2 = calculate_residual_norm(p2, h2, h2_p, g_val, fc_val, 'mismatched', q=q2)\n\n    # Case 3\n    p3, q3 = 1, 2\n    h3 = lambda y: 1.0 + 0.3*y\n    h3_p = lambda y: 0.3\n    res3 = calculate_residual_norm(p3, h3, h3_p, g_val, fc_val, 'mismatched', q=q3)\n\n    # Case 4\n    p4, q4 = 6, 6\n    h4 = lambda y: 1.0 + 0.1 * np.sin(2 * np.pi * y)\n    h4_p = lambda y: 0.1 * 2 * np.pi * np.cos(2 * np.pi * y)\n    res4 = calculate_residual_norm(p4, h4, h4_p, g_val, fc_val, 'mismatched', q=q4)\n\n    results = [res1, res2, res3, res4]\n    \n    # Format output as specified\n    print(f\"[{','.join(f'{r:.15e}' for r in results)}]\")\n\nsolve()\n```", "id": "3405150"}]}