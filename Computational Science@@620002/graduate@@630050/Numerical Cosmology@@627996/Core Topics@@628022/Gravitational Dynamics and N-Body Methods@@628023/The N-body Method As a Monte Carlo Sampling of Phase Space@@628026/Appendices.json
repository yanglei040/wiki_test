{"hands_on_practices": [{"introduction": "The power spectrum is a cornerstone of modern cosmology, summarizing the statistical properties of large-scale structure. When we estimate it from an N-body simulation, we don't measure the power spectrum of the true, continuous density field, but rather that of a discrete particle distribution assigned to a grid. This practice ([@problem_id:3497535]) guides you through a foundational derivation, showing how the mass assignment procedure acts as a filter and how the discreteness of particles introduces an irreducible Poisson shot noise. Understanding these effects is the first critical step toward recovering an unbiased estimate of the underlying cosmological power spectrum from raw simulation data.", "problem": "Consider a statistically homogeneous and isotropic matter density contrast field $\\delta(\\boldsymbol{x})$ in a periodic cubic domain of volume $V$, with the power spectrum $P(\\boldsymbol{k})$ defined by the ensemble average $\\langle \\tilde{\\delta}(\\boldsymbol{k}) \\tilde{\\delta}^{*}(\\boldsymbol{k}') \\rangle = (2\\pi)^{3} \\delta_{\\mathrm{D}}(\\boldsymbol{k} - \\boldsymbol{k}') P(\\boldsymbol{k})$, where $\\tilde{\\delta}(\\boldsymbol{k})$ denotes the Fourier transform of $\\delta(\\boldsymbol{x})$ and $\\delta_{\\mathrm{D}}$ is the Dirac delta distribution. Model the $N$-body particle realization as a Monte Carlo sampling of the phase space that produces a point process with mean number density $\\bar{n}$ and intensity $\\bar{n} [1 + \\delta(\\boldsymbol{x})]$. The gridded number density field $n_{\\mathrm{g}}(\\boldsymbol{x})$ is constructed by mass assignment using a separable compact kernel $w(\\boldsymbol{x})$ that integrates to unity, so that $n_{\\mathrm{g}}(\\boldsymbol{x}) = \\sum_{i=1}^{N} w(\\boldsymbol{x} - \\boldsymbol{x}_{i})$. Define the gridded density contrast as $\\delta_{\\mathrm{g}}(\\boldsymbol{x}) = n_{\\mathrm{g}}(\\boldsymbol{x})/\\bar{n} - 1$, and let its Fourier transform be $\\tilde{\\delta}_{\\mathrm{g}}(\\boldsymbol{k})$. You measure the power spectrum on a regular mesh of spacing $\\Delta$ using the Fast Fourier Transform (FFT), obtaining an estimator $P_{\\mathrm{meas}}(\\boldsymbol{k})$ from $|\\tilde{\\delta}_{\\mathrm{g}}(\\boldsymbol{k})|^{2}$.\n\nAssume that the underlying $P(\\boldsymbol{k})$ is negligible for $|\\boldsymbol{k}|$ at or above the Nyquist frequency $k_{\\mathrm{Ny}} = \\pi/\\Delta$ (so that aliasing due to sampling on the mesh can be neglected), and that the mass-assignment kernel is a three-dimensional B-spline of order $p \\in \\{1,2,3\\}$, corresponding respectively to Nearest Grid Point (NGP), Cloud-In-Cell (CIC), and Triangular Shaped Cloud (TSC). Under these assumptions:\n\n- Starting from the definitions above and treating the particle realization as an inhomogeneous Poisson process with intensity $\\bar{n} [1 + \\delta(\\boldsymbol{x})]$, derive the ensemble expectation of the measured spectrum $P_{\\mathrm{meas}}(\\boldsymbol{k})$ in terms of the underlying $P(\\boldsymbol{k})$, the Fourier transform $\\tilde{W}(\\boldsymbol{k})$ of the assignment kernel $w(\\boldsymbol{x})$, and the mean number density $\\bar{n}$. Clearly identify the term arising from the Poisson shot noise.\n\n- For the three-dimensional B-spline assignment of order $p$, write $\\tilde{W}(\\boldsymbol{k})$ explicitly in terms of $\\boldsymbol{k} = (k_{1}, k_{2}, k_{3})$ and the mesh spacing $\\Delta$.\n\n- By deconvolving the mass-assignment window and accounting for shot noise, provide a closed-form expression for the deconvolved estimator $\\widehat{P}(\\boldsymbol{k})$ that recovers the underlying $P(\\boldsymbol{k})$ from $P_{\\mathrm{meas}}(\\boldsymbol{k})$ under the stated assumptions.\n\nYour final answer must be a single analytic expression for $\\widehat{P}(\\boldsymbol{k})$ expressed in terms of $P_{\\mathrm{meas}}(\\boldsymbol{k})$, $\\bar{n}$, $p$, $\\Delta$, and $\\boldsymbol{k}$. No numerical evaluation is required.", "solution": "The problem is subjected to validation before a solution is attempted.\n\n### Step 1: Extract Givens\n-   **Density contrast field:** A statistically homogeneous and isotropic matter density contrast field $\\delta(\\boldsymbol{x})$ in a periodic cubic domain of volume $V$.\n-   **Power spectrum definition:** The ensemble average $\\langle \\tilde{\\delta}(\\boldsymbol{k}) \\tilde{\\delta}^{*}(\\boldsymbol{k}') \\rangle = (2\\pi)^{3} \\delta_{\\mathrm{D}}(\\boldsymbol{k} - \\boldsymbol{k}') P(\\boldsymbol{k})$, where $\\tilde{\\delta}(\\boldsymbol{k})$ is the Fourier transform of $\\delta(\\boldsymbol{x})$ and $\\delta_{\\mathrm{D}}$ is the Dirac delta distribution.\n-   **Particle realization model:** An $N$-body point process sampling the phase space, with mean number density $\\bar{n}$ and intensity $\\lambda(\\boldsymbol{x}) = \\bar{n} [1 + \\delta(\\boldsymbol{x})]$. This is specified to be treated as an inhomogeneous Poisson process.\n-   **Gridded number density:** $n_{\\mathrm{g}}(\\boldsymbol{x}) = \\sum_{i=1}^{N} w(\\boldsymbol{x} - \\boldsymbol{x}_{i})$, using a separable, compact mass assignment kernel $w(\\boldsymbol{x})$ that integrates to unity.\n-   **Gridded density contrast:** $\\delta_{\\mathrm{g}}(\\boldsymbol{x}) = n_{\\mathrm{g}}(\\boldsymbol{x})/\\bar{n} - 1$. Its Fourier transform is $\\tilde{\\delta}_{\\mathrm{g}}(\\boldsymbol{k})$.\n-   **Measured power spectrum:** An estimator $P_{\\mathrm{meas}}(\\boldsymbol{k})$ obtained from $|\\tilde{\\delta}_{\\mathrm{g}}(\\boldsymbol{k})|^{2}$.\n-   **Mesh properties:** Regular mesh with spacing $\\Delta$.\n-   **Assumptions:**\n    1.  The underlying power spectrum $P(\\boldsymbol{k})$ is negligible for $|\\boldsymbol{k}| \\ge k_{\\mathrm{Ny}} = \\pi/\\Delta$.\n    2.  The mass-assignment kernel $w(\\boldsymbol{x})$ is a three-dimensional B-spline of order $p \\in \\{1,2,3\\}$, corresponding to NGP, CIC, and TSC schemes.\n-   **Tasks:**\n    1.  Derive the ensemble expectation of the measured spectrum, $\\langle P_{\\mathrm{meas}}(\\boldsymbol{k}) \\rangle$, in terms of $P(\\boldsymbol{k})$, $\\tilde{W}(\\boldsymbol{k})$, and $\\bar{n}$. Identify the shot noise term.\n    2.  Provide an explicit expression for $\\tilde{W}(\\boldsymbol{k})$ for the specified B-spline kernel.\n    3.  Provide a closed-form expression for the deconvolved estimator $\\widehat{P}(\\boldsymbol{k})$ in terms of $P_{\\mathrm{meas}}(\\boldsymbol{k})$, $\\bar{n}$, $p$, $\\Delta$, and $\\boldsymbol{k}$.\n\n### Step 2: Validate Using Extracted Givens\n-   **Scientific Grounding:** The problem is firmly grounded in the standard theoretical framework of numerical cosmology and the analysis of large-scale structure. All concepts—power spectrum, density contrast, Poisson sampling, shot noise, and mass assignment schemes (NGP, CIC, TSC)—are fundamental to the field. The model of particles as an inhomogeneous Poisson process is a standard and well-justified approximation.\n-   **Well-Posedness:** The problem is well-posed. It provides clear definitions, explicit assumptions, and a sequence of tasks that lead to a unique mathematical result. The assumptions, such as neglecting aliasing, are common simplifying conditions in such derivations.\n-   **Objectivity:** The language is technical, precise, and free of any subjective or ambiguous terminology.\n-   **Completeness and Consistency:** The problem is self-contained. The provided information is sufficient and internally consistent for the derivation. The relationship between the measured power spectrum $P_{\\mathrm{meas}}(\\boldsymbol{k})$ and $|\\tilde{\\delta}_{\\mathrm{g}}(\\boldsymbol{k})|^{2}$ is standard in this context, where $P_{\\mathrm{meas}}(\\boldsymbol{k})$ is taken to be an estimator of the power spectrum of the $\\delta_{\\mathrm{g}}$ field.\n\n### Step 3: Verdict and Action\nThe problem is valid. A full, reasoned solution will be provided.\n\n### Solution Derivation\n\nThe solution is developed in three parts as requested by the problem statement.\n\n**Part 1: Derivation of the Expected Measured Power Spectrum**\n\nWe begin with the gridded density contrast, $\\delta_{\\mathrm{g}}(\\boldsymbol{x}) = n_{\\mathrm{g}}(\\boldsymbol{x})/\\bar{n} - 1$. Substituting the definition of $n_{\\mathrm{g}}(\\boldsymbol{x})$:\n$$\n\\delta_{\\mathrm{g}}(\\boldsymbol{x}) = \\frac{1}{\\bar{n}} \\sum_{i=1}^{N} w(\\boldsymbol{x} - \\boldsymbol{x}_{i}) - 1\n$$\nWe compute its Fourier transform, $\\tilde{\\delta}_{\\mathrm{g}}(\\boldsymbol{k}) = \\int \\delta_{\\mathrm{g}}(\\boldsymbol{x}) e^{-i \\boldsymbol{k} \\cdot \\boldsymbol{x}} d^3x$. For modes with $\\boldsymbol{k} \\neq \\boldsymbol{0}$, the Fourier transform of the constant term $-1$ vanishes.\n$$\n\\tilde{\\delta}_{\\mathrm{g}}(\\boldsymbol{k}) = \\frac{1}{\\bar{n}} \\int \\left( \\sum_{i=1}^{N} w(\\boldsymbol{x} - \\boldsymbol{x}_{i}) \\right) e^{-i \\boldsymbol{k} \\cdot \\boldsymbol{x}} d^3x\n$$\nUsing the convolution theorem, the Fourier transform of a sum of shifted kernels is the product of the kernel's Fourier transform, $\\tilde{W}(\\boldsymbol{k})$, and the structure factor of the particle positions:\n$$\n\\tilde{\\delta}_{\\mathrm{g}}(\\boldsymbol{k}) = \\frac{\\tilde{W}(\\boldsymbol{k})}{\\bar{n}} \\sum_{i=1}^{N} e^{-i \\boldsymbol{k} \\cdot \\boldsymbol{x}_{i}}\n$$\nThe power in this mode is $|\\tilde{\\delta}_{\\mathrm{g}}(\\boldsymbol{k})|^2$:\n$$\n|\\tilde{\\delta}_{\\mathrm{g}}(\\boldsymbol{k})|^2 = \\frac{|\\tilde{W}(\\boldsymbol{k})|^2}{\\bar{n}^2} \\left( \\sum_{i=1}^{N} e^{-i \\boldsymbol{k} \\cdot \\boldsymbol{x}_{i}} \\right) \\left( \\sum_{j=1}^{N} e^{i \\boldsymbol{k} \\cdot \\boldsymbol{x}_{j}} \\right) = \\frac{|\\tilde{W}(\\boldsymbol{k})|^2}{\\bar{n}^2} \\sum_{i,j=1}^{N} e^{-i \\boldsymbol{k} \\cdot (\\boldsymbol{x}_{i} - \\boldsymbol{x}_{j})}\n$$\nWe separate this sum into diagonal ($i=j$) and off-diagonal ($i \\neq j$) terms:\n$$\n|\\tilde{\\delta}_{\\mathrm{g}}(\\boldsymbol{k})|^2 = \\frac{|\\tilde{W}(\\boldsymbol{k})|^2}{\\bar{n}^2} \\left( N + \\sum_{i \\neq j} e^{-i \\boldsymbol{k} \\cdot (\\boldsymbol{x}_{i} - \\boldsymbol{x}_{j})} \\right)\n$$\nNext, we take the ensemble average. This is a two-step process: first, an average over the Poisson process for a fixed underlying field $\\delta(\\boldsymbol{x})$, denoted $\\langle \\cdot \\rangle_P$, followed by an average over the ensemble of fields $\\delta(\\boldsymbol{x})$. The particle positions are drawn from an inhomogeneous Poisson process with intensity $\\lambda(\\boldsymbol{x}) = \\bar{n}[1 + \\delta(\\boldsymbol{x})]$. For such a process, we have the following properties (from extensions of Campbell's theorem):\n$\\langle N \\rangle_P = \\int \\lambda(\\boldsymbol{x}) d^3x = \\int \\bar{n}[1+\\delta(\\boldsymbol{x})]d^3x = \\bar{n}V$.\n$\\langle \\sum_{i \\neq j} f(\\boldsymbol{x}_i, \\boldsymbol{x}_j) \\rangle_P = \\iint \\lambda(\\boldsymbol{x}_i) \\lambda(\\boldsymbol{x}_j) f(\\boldsymbol{x}_i, \\boldsymbol{x}_j) d^3x_i d^3x_j$.\n\nApplying this to our expression:\n$$\n\\langle \\sum_{i \\neq j} e^{-i \\boldsymbol{k} \\cdot (\\boldsymbol{x}_{i} - \\boldsymbol{x}_{j})} \\rangle_P = \\iint \\bar{n}^2 [1+\\delta(\\boldsymbol{x}_i)][1+\\delta(\\boldsymbol{x}_j)] e^{-i \\boldsymbol{k} \\cdot (\\boldsymbol{x}_i - \\boldsymbol{x}_j)} d^3x_i d^3x_j\n$$\n$$\n= \\bar{n}^2 \\left( \\int [1+\\delta(\\boldsymbol{x})] e^{-i \\boldsymbol{k} \\cdot \\boldsymbol{x}} d^3x \\right) \\left( \\int [1+\\delta(\\boldsymbol{x}')] e^{i \\boldsymbol{k} \\cdot \\boldsymbol{x}'} d^3x' \\right)\n$$\nFor $\\boldsymbol{k} \\neq \\boldsymbol{0}$, $\\int e^{-i \\boldsymbol{k} \\cdot \\boldsymbol{x}} d^3x = 0$. Thus, we are left with:\n$$\n= \\bar{n}^2 \\left( \\int \\delta(\\boldsymbol{x}) e^{-i \\boldsymbol{k} \\cdot \\boldsymbol{x}} d^3x \\right) \\left( \\int \\delta(\\boldsymbol{x}') e^{i \\boldsymbol{k} \\cdot \\boldsymbol{x}'} d^3x' \\right) = \\bar{n}^2 |\\tilde{\\delta}(\\boldsymbol{k})|^2\n$$\nThe Poisson-averaged power is:\n$$\n\\langle |\\tilde{\\delta}_{\\mathrm{g}}(\\boldsymbol{k})|^2 \\rangle_P = \\frac{|\\tilde{W}(\\boldsymbol{k})|^2}{\\bar{n}^2} \\left[ \\bar{n}V + \\bar{n}^2 |\\tilde{\\delta}(\\boldsymbol{k})|^2 \\right] = |\\tilde{W}(\\boldsymbol{k})|^2 \\left( \\frac{V}{\\bar{n}} + |\\tilde{\\delta}(\\boldsymbol{k})|^2 \\right)\n$$\nNow, we average over the ensemble of fields $\\delta(\\boldsymbol{x})$. The measured power spectrum estimator $P_{\\mathrm{meas}}(\\boldsymbol{k})$ for the gridded field in a finite volume $V$ is defined via its expectation as $\\langle P_{\\mathrm{meas}}(\\boldsymbol{k}) \\rangle = \\frac{1}{V} \\langle |\\tilde{\\delta}_{\\mathrm{g}}(\\boldsymbol{k})|^2 \\rangle$, where $\\langle \\cdot \\rangle$ is the full ensemble average.\n$$\n\\langle P_{\\mathrm{meas}}(\\boldsymbol{k}) \\rangle = \\frac{1}{V} \\langle |\\tilde{W}(\\boldsymbol{k})|^2 \\left(\\frac{V}{\\bar{n}} + |\\tilde{\\delta}(\\boldsymbol{k})|^2\\right) \\rangle = \\frac{|\\tilde{W}(\\boldsymbol{k})|^2}{V} \\left( \\frac{V}{\\bar{n}} + \\langle |\\tilde{\\delta}(\\boldsymbol{k})|^2 \\rangle \\right)\n$$\nThe power spectrum $P(\\boldsymbol{k})$ of the underlying field is defined by $\\langle |\\tilde{\\delta}(\\boldsymbol{k})|^2 \\rangle = V P(\\boldsymbol{k})$. Substituting this gives:\n$$\n\\langle P_{\\mathrm{meas}}(\\boldsymbol{k}) \\rangle = \\frac{|\\tilde{W}(\\boldsymbol{k})|^2}{V} \\left(\\frac{V}{\\bar{n}} + V P(\\boldsymbol{k})\\right) = |\\tilde{W}(\\boldsymbol{k})|^2 P(\\boldsymbol{k}) + \\frac{|\\tilde{W}(\\boldsymbol{k})|^2}{\\bar{n}}\n$$\nThe first term represents the true cosmological power spectrum, suppressed by the window function. The second term, $\\frac{|\\tilde{W}(\\boldsymbol{k})|^2}{\\bar{n}}$, is the contribution from **Poisson shot noise**. It corresponds to a white noise spectrum of amplitude $1/\\bar{n}$ that has been filtered by the mass assignment kernel.\n\n**Part 2: Fourier Transform of the B-Spline Kernel**\n\nThe assignment kernel $w(\\boldsymbol{x})$ is a separable, 3D B-spline of order $p$. This means $w(\\boldsymbol{x}) = w_p(x_1) w_p(x_2) w_p(x_3)$, where $w_p(x)$ is the 1D B-spline of order $p$. A B-spline of order $p$ is constructed by convolving the top-hat function (B-spline of order $1$) with itself $p$ times. The order $p=1$ kernel (NGP) is a normalized top-hat function:\n$$\nw_1(x) = \\frac{1}{\\Delta} \\quad \\text{for } |x| \\le \\frac{\\Delta}{2}, \\text{ and } 0 \\text{ otherwise.}\n$$\nIts 1D Fourier transform is:\n$$\n\\tilde{W}_1(k) = \\int_{-\\infty}^{\\infty} w_1(x) e^{-ikx} dx = \\frac{1}{\\Delta} \\int_{-\\Delta/2}^{\\Delta/2} e^{-ikx} dx = \\frac{\\sin(k\\Delta/2)}{k\\Delta/2}\n$$\nThe Fourier transform of a B-spline of order $p$ is the $p$-th power of the order-1 transform:\n$$\n\\tilde{W}_p(k) = [\\tilde{W}_1(k)]^p = \\left[ \\frac{\\sin(k\\Delta/2)}{k\\Delta/2} \\right]^p\n$$\nSince the 3D kernel is separable, its Fourier transform is the product of the 1D transforms:\n$$\n\\tilde{W}(\\boldsymbol{k}) = \\tilde{W}(\\boldsymbol{k}=(k_1,k_2,k_3)) = \\tilde{W}_p(k_1) \\tilde{W}_p(k_2) \\tilde{W}_p(k_3) = \\prod_{j=1}^{3} \\left[ \\frac{\\sin(k_j\\Delta/2)}{k_j\\Delta/2} \\right]^p\n$$\n\n**Part 3: The Deconvolved Estimator**\n\nWe seek an estimator $\\widehat{P}(\\boldsymbol{k})$ for the true power spectrum $P(\\boldsymbol{k})$ that is constructed from a single measurement $P_{\\text{meas}}(\\boldsymbol{k})$ and is unbiased, meaning $\\langle \\widehat{P}(\\boldsymbol{k}) \\rangle = P(\\boldsymbol{k})$. From Part 1, we have the relation for the expectation:\n$$\n\\langle P_{\\mathrm{meas}}(\\boldsymbol{k}) \\rangle = |\\tilde{W}(\\boldsymbol{k})|^2 P(\\boldsymbol{k}) + \\frac{|\\tilde{W}(\\boldsymbol{k})|^2}{\\bar{n}}\n$$\nWe can solve this equation for $P(\\boldsymbol{k})$:\n$$\nP(\\boldsymbol{k}) = \\frac{\\langle P_{\\mathrm{meas}}(\\boldsymbol{k}) \\rangle}{|\\tilde{W}(\\boldsymbol{k})|^2} - \\frac{1}{\\bar{n}}\n$$\nThis suggests an estimator for $P(\\boldsymbol{k})$ where we replace the expected quantity $\\langle P_{\\mathrm{meas}}(\\boldsymbol{k}) \\rangle$ with the actual measurement $P_{\\mathrm{meas}}(\\boldsymbol{k})$ from a single realization:\n$$\n\\widehat{P}(\\boldsymbol{k}) = \\frac{P_{\\mathrm{meas}}(\\boldsymbol{k})}{|\\tilde{W}(\\boldsymbol{k})|^2} - \\frac{1}{\\bar{n}}\n$$\nThis estimator is unbiased, as $\\langle \\widehat{P}(\\boldsymbol{k}) \\rangle = \\frac{\\langle P_{\\mathrm{meas}}(\\boldsymbol{k}) \\rangle}{|\\tilde{W}(\\boldsymbol{k})|^2} - \\frac{1}{\\bar{n}} = P(\\boldsymbol{k})$. This procedure consists of deconvolving the window function from the measured power and subtracting the (un-convolved) shot noise power.\n\nWe now substitute the expression for $|\\tilde{W}(\\boldsymbol{k})|^2$ from Part 2. Since $\\frac{\\sin(x)}{x}$ is a real-valued function for real arguments, $|\\tilde{W}(\\boldsymbol{k})|^2 = (\\tilde{W}(\\boldsymbol{k}))^2$.\n$$\n|\\tilde{W}(\\boldsymbol{k})|^2 = \\left( \\prod_{j=1}^{3} \\left[ \\frac{\\sin(k_j\\Delta/2)}{k_j\\Delta/2} \\right]^p \\right)^2 = \\prod_{j=1}^{3} \\left[ \\frac{\\sin(k_j\\Delta/2)}{k_j\\Delta/2} \\right]^{2p}\n$$\nThe final closed-form expression for the deconvolved estimator is:\n$$\n\\widehat{P}(\\boldsymbol{k}) = \\frac{P_{\\mathrm{meas}}(\\boldsymbol{k})}{\\prod_{j=1}^{3} \\left[ \\frac{\\sin(k_j\\Delta/2)}{k_j\\Delta/2} \\right]^{2p}} - \\frac{1}{\\bar{n}}\n$$\nThis is the final expression, which recovers the underlying power spectrum $P(\\boldsymbol{k})$ from the measured, gridded power spectrum $P_{\\mathrm{meas}}(\\boldsymbol{k})$ by correcting for both the mass assignment window and the Poisson shot noise, under the specified assumptions.", "answer": "$$\n\\boxed{\\widehat{P}(\\boldsymbol{k}) = P_{\\mathrm{meas}}(\\boldsymbol{k}) \\left( \\prod_{j=1}^{3} \\left[ \\frac{\\sin(k_j\\Delta/2)}{k_j\\Delta/2} \\right]^{2p} \\right)^{-1} - \\frac{1}{\\bar{n}}}\n$$", "id": "3497535"}, {"introduction": "Even with a perfect measurement technique, the statistical power of a cosmological simulation is fundamentally limited by its finite volume. A finite box can only contain a discrete set of Fourier modes, meaning our estimate of the power spectrum is an average over a finite sample. This exercise ([@problem_id:3497525]) explores this irreducible uncertainty, known as cosmic variance, by tasking you to calculate the number of independent modes available in a given Fourier-space shell and to derive the resulting fractional error on the power spectrum. This demonstrates the ultimate precision limit inherent to observing a single realization of our Universe (or a simulation thereof).", "problem": "You run a cosmological $N$-body simulation in a cubic, periodic comoving volume of side length $L = 1000\\,h^{-1}\\,\\mathrm{Mpc}$. Consider the linear density contrast field $\\delta(\\mathbf{x})$ as a statistically homogeneous, isotropic Gaussian random field and interpret the simulation measurement of the power spectrum $P(k)$ as a Monte Carlo estimate obtained by averaging over discrete Fourier modes in shells of wavenumber $k$. You focus on the shell centered at $k = 0.2\\,h\\,\\mathrm{Mpc}^{-1}$, and you bin modes into a spherical shell of width equal to $10$ times the fundamental Fourier wavenumber spacing implied by the periodic boundary.\n\nAssume the following:\n- The estimator of $P(k)$ is formed by averaging $|\\delta_{\\mathbf{k}}|^{2}$ over all modes with magnitudes in the chosen shell.\n- The finite simulation volume and periodic boundary conditions determine the discretization of Fourier modes.\n- Ignore particle shot noise and any window-function effects; treat modes within the shell as statistically independent to leading order for a Gaussian field.\n\nTasks:\n1. Determine the fundamental Fourier wavenumber spacing set by the finite periodic box.\n2. From first principles, derive the expression for the number of independent Fourier modes in a spherical shell of width equal to $10$ fundamental spacings at the target $k$, and evaluate it for the given numerical values.\n3. Using Gaussian statistics for the Fourier amplitudes, derive the fractional one-sigma uncertainty on the power spectrum estimate due to cosmic variance for this shell.\n\nReport as your final answer the numerical value of the one-sigma fractional uncertainty $\\sigma_{P}/P$ at $k = 0.2\\,h\\,\\mathrm{Mpc}^{-1}$ under the stated assumptions. Express your final answer as a unitless decimal rounded to four significant figures.", "solution": "The problem asks for the one-sigma fractional uncertainty on a power spectrum measurement, $\\sigma_{P}/P$, which is a measure of cosmic variance for a given setup. We will solve this by following the tasks outlined.\n\nFirst, we validate the problem statement. The givens are:\n-   Simulation volume: periodic cube of side length $L = 1000\\,h^{-1}\\,\\mathrm{Mpc}$.\n-   Field: $\\delta(\\mathbf{x})$, a statistically homogeneous, isotropic Gaussian random field.\n-   Target wavenumber: $k = 0.2\\,h\\,\\mathrm{Mpc}^{-1}$.\n-   Binning shell: spherical shell of width $\\Delta k = 10 \\times k_f$, where $k_f$ is the fundamental Fourier wavenumber spacing.\n-   Assumptions: The estimator of $P(k)$ is the average of $|\\delta_{\\mathbf{k}}|^{2}$ over modes in the shell; Fourier modes are discretized by the box; shot noise and window effects are ignored; modes are statistically independent.\n\nThe problem is scientifically grounded in standard cosmological large-scale structure analysis, is well-posed with sufficient information, and uses objective, precise language. All provided values are physically realistic for modern cosmological simulations. Therefore, the problem is valid.\n\nWe proceed with the solution, which is divided into three main parts as guided by the problem statement.\n\n**1. Fundamental Fourier Wavenumber Spacing**\n\nFor a field defined within a cubic, periodic box of side length $L$, the allowed wavevectors $\\mathbf{k}$ are determined by the condition that the basis functions $\\exp(i\\mathbf{k}\\cdot\\mathbf{x})$ must have the same period as the box. This leads to the quantization of a wavevector's components:\n$$\n\\mathbf{k} = (k_x, k_y, k_z) = \\frac{2\\pi}{L}(n_x, n_y, n_z)\n$$\nwhere $n_x$, $n_y$, and $n_z$ are integers. The fundamental Fourier wavenumber spacing, $k_f$, is the step size between adjacent discrete modes along any Cartesian axis in Fourier space. It is given by:\n$$\nk_f = \\frac{2\\pi}{L}\n$$\nSubstituting the given value $L = 1000\\,h^{-1}\\,\\mathrm{Mpc}$, we find:\n$$\nk_f = \\frac{2\\pi}{1000\\,h^{-1}\\,\\mathrm{Mpc}} = 0.002\\pi\\,h\\,\\mathrm{Mpc}^{-1}\n$$\n\n**2. Number of Independent Fourier Modes**\n\nWe need to find the number of independent modes in a spherical shell centered at wavenumber $k$ with a width $\\Delta k$. The problem specifies $\\Delta k = 10 k_f$.\nThe volume of this shell in $k$-space, assuming the width is small compared to the radius ($\\Delta k \\ll k$), is approximately:\n$$\nV_{\\text{shell}} = 4\\pi k^2 \\Delta k\n$$\nThe discrete Fourier modes form a grid in $k$-space, with each grid point occupying a volume of:\n$$\nV_{\\text{mode}} = (k_f)^3 = \\left(\\frac{2\\pi}{L}\\right)^3\n$$\nThe total number of $k$-space grid points (modes) in the shell is the ratio of the shell's volume to the volume per mode:\n$$\nN_{\\text{total}} = \\frac{V_{\\text{shell}}}{V_{\\text{mode}}} = \\frac{4\\pi k^2 \\Delta k}{(2\\pi/L)^3}\n$$\nSubstituting $\\Delta k = 10 k_f = 10(2\\pi/L)$:\n$$\nN_{\\text{total}} = \\frac{4\\pi k^2 \\left(10 \\frac{2\\pi}{L}\\right)}{\\left(\\frac{2\\pi}{L}\\right)^3} = \\frac{40\\pi k^2}{\\left(\\frac{2\\pi}{L}\\right)^2} = \\frac{40\\pi k^2 L^2}{4\\pi^2} = \\frac{10 k^2 L^2}{\\pi}\n$$\nThis expression, $N_{\\text{total}}$, counts every discrete wavevector $\\mathbf{k}$ in the shell. However, the density field $\\delta(\\mathbf{x})$ is real, which imposes the reality condition on its Fourier transform: $\\delta_{\\mathbf{k}} = \\delta_{-\\mathbf{k}}^*$. This means the Fourier coefficient at $\\mathbf{k}$ is not independent of the one at $-\\mathbf{k}$; they are complex conjugates. The power, $|\\delta_{\\mathbf{k}}|^{2} = |\\delta_{-\\mathbf{k}}|^2$, is identical for both. Therefore, the pair of modes $(\\mathbf{k}, -\\mathbf{k})$ constitutes a single independent measurement of power. The number of independent modes, $N_k$, is half the total number of modes (ignoring the negligible contribution of modes for which $\\mathbf{k} = -\\mathbf{k}$, which occurs only at $\\mathbf{k=0}$, a point not in our shell).\n$$\nN_k = \\frac{1}{2} N_{\\text{total}} = \\frac{5 k^2 L^2}{\\pi}\n$$\nNow we evaluate this expression using the given numerical values: $k = 0.2\\,h\\,\\mathrm{Mpc}^{-1}$ and $L = 1000\\,h^{-1}\\,\\mathrm{Mpc}$.\n$$\nN_k = \\frac{5 \\left(0.2\\,h\\,\\mathrm{Mpc}^{-1}\\right)^2 \\left(1000\\,h^{-1}\\,\\mathrm{Mpc}\\right)^2}{\\pi} = \\frac{5 \\cdot (0.04) \\cdot (10^6)}{\\pi} \\frac{(h\\,\\mathrm{Mpc}^{-1})^2 (h^{-1}\\,\\mathrm{Mpc})^2}{1} = \\frac{2 \\times 10^5}{\\pi}\n$$\n\n**3. Fractional Uncertainty on the Power Spectrum**\n\nThe power spectrum estimator, $\\hat{P}(k)$, is the average of $|\\delta_{\\mathbf{k}_i}|^2$ over the $N_k$ independent modes in the shell:\n$$\n\\hat{P}(k) = \\frac{1}{N_k} \\sum_{i=1}^{N_k} |\\delta_{\\mathbf{k}_i}|^2\n$$\nThe true power spectrum is the expectation value $P(k) = \\langle \\hat{P}(k) \\rangle$. For a statistically homogeneous and isotropic field, $\\langle |\\delta_{\\mathbf{k}_i}|^2 \\rangle = P(k)$ is constant for all modes in the narrow shell, so the estimator is unbiased.\n\nThe variance of the estimator is $\\sigma_{\\hat{P}}^2 = \\text{Var}(\\hat{P}(k))$. Since the modes are assumed to be statistically independent, the variance of the sum is the sum of the variances:\n$$\n\\sigma_{\\hat{P}}^2 = \\text{Var}\\left(\\frac{1}{N_k} \\sum_{i=1}^{N_k} |\\delta_{\\mathbf{k}_i}|^2\\right) = \\frac{1}{N_k^2} \\sum_{i=1}^{N_k} \\text{Var}\\left(|\\delta_{\\mathbf{k}_i}|^2\\right) = \\frac{1}{N_k^2} \\cdot N_k \\cdot \\text{Var}\\left(|\\delta_{\\mathbf{k}}|^2\\right) = \\frac{\\text{Var}\\left(|\\delta_{\\mathbf{k}}|^2\\right)}{N_k}\n$$\nTo find $\\text{Var}(|\\delta_{\\mathbf{k}}|^2)$, we use the property that $\\delta(\\mathbf{x})$ is a Gaussian random field. This implies that the real and imaginary parts of $\\delta_{\\mathbf{k}}$, let's call them $a = \\operatorname{Re}(\\delta_{\\mathbf{k}})$ and $b = \\operatorname{Im}(\\delta_{\\mathbf{k}})$, are independent Gaussian random variables with zero mean. Their variances must sum to the total power: $\\langle a^2 \\rangle + \\langle b^2 \\rangle = \\langle |\\delta_{\\mathbf{k}}|^2 \\rangle = P(k)$. Due to isotropy, $\\langle a^2 \\rangle = \\langle b^2 \\rangle = P(k)/2$.\nThe variance of a single power measurement is $\\text{Var}\\left(|\\delta_{\\mathbf{k}}|^2\\right) = \\langle \\left(|\\delta_{\\mathbf{k}}|^2\\right)^2 \\rangle - \\left(\\langle |\\delta_{\\mathbf{k}}|^2 \\rangle\\right)^2$.\nWe have $\\langle |\\delta_{\\mathbf{k}}|^2 \\rangle = P(k)$. We need to calculate $\\langle (|\\delta_{\\mathbf{k}}|^2)^2 \\rangle = \\langle (a^2+b^2)^2 \\rangle = \\langle a^4 + 2a^2b^2 + b^4 \\rangle$.\nUsing the independence of $a$ and $b$, and the property of a zero-mean Gaussian variable $X$ with variance $\\sigma^2$ that $\\langle X^4 \\rangle = 3\\sigma^4 = 3(\\langle X^2 \\rangle)^2$:\n$$\n\\langle a^4 \\rangle = 3(\\langle a^2 \\rangle)^2 = 3\\left(\\frac{P(k)}{2}\\right)^2 = \\frac{3}{4}P(k)^2\n$$\n$$\n\\langle b^4 \\rangle = 3(\\langle b^2 \\rangle)^2 = 3\\left(\\frac{P(k)}{2}\\right)^2 = \\frac{3}{4}P(k)^2\n$$\n$$\n\\langle 2a^2b^2 \\rangle = 2\\langle a^2 \\rangle \\langle b^2 \\rangle = 2\\left(\\frac{P(k)}{2}\\right)\\left(\\frac{P(k)}{2}\\right) = \\frac{1}{2}P(k)^2\n$$\nSumming these up:\n$$\n\\langle \\left(|\\delta_{\\mathbf{k}}|^2\\right)^2 \\rangle = \\frac{3}{4}P(k)^2 + \\frac{1}{2}P(k)^2 + \\frac{3}{4}P(k)^2 = \\frac{3+2+3}{4}P(k)^2 = 2P(k)^2\n$$\nThus, the variance of a single power measurement is:\n$$\n\\text{Var}\\left(|\\delta_{\\mathbf{k}}|^2\\right) = 2P(k)^2 - (P(k))^2 = P(k)^2\n$$\nThe variance of the estimator $\\hat{P}(k)$ is then:\n$$\n\\sigma_{\\hat{P}}^2 = \\frac{P(k)^2}{N_k}\n$$\nThe one-sigma fractional uncertainty is the standard deviation of the estimator, $\\sigma_{\\hat{P}}$, divided by the true value, $P(k)$:\n$$\n\\frac{\\sigma_P}{P} \\equiv \\frac{\\sigma_{\\hat{P}}}{P(k)} = \\frac{\\sqrt{P(k)^2 / N_k}}{P(k)} = \\frac{P(k) / \\sqrt{N_k}}{P(k)} = \\frac{1}{\\sqrt{N_k}}\n$$\nThis fundamental result is known as the cosmic variance limit. Substituting our expression for $N_k$:\n$$\n\\frac{\\sigma_P}{P} = \\frac{1}{\\sqrt{\\frac{2 \\times 10^5}{\\pi}}} = \\sqrt{\\frac{\\pi}{2 \\times 10^5}}\n$$\nNumerically evaluating this expression:\n$$\n\\frac{\\sigma_P}{P} \\approx \\sqrt{\\frac{3.14159265}{200000}} \\approx \\sqrt{1.570796 \\times 10^{-5}} \\approx 0.003963325\n$$\nRounding to four significant figures, the fractional uncertainty is $0.003963$.", "answer": "$$\\boxed{0.003963}$$", "id": "3497525"}, {"introduction": "While the statistical framework for the power spectrum is well-suited to the large, quasi-linear scales, it faces challenges in the deeply non-linear regime of gravitational collapse. Here, the initially smooth phase-space sheet folds to create caustics—regions of formally infinite density—where simple estimators diverge. This advanced practice ([@problem_id:3497486]) uses a one-dimensional toy model to analytically and computationally explore this phenomenon, deriving how density estimators must be carefully constructed and how their resolution must scale with particle number to faithfully probe the structure of caustics. This exercise provides a crucial link between idealized Monte Carlo theory and the practical art of analyzing highly clustered N-body data.", "problem": "A one-dimensional phase-space sheet code is specified by a single Lagrangian parameter $q \\in [-Q,Q]$ whose mapping into Eulerian phase space $(x,v)$ is given by $x(q) = q^{2}$ and $v(q) = q$. The sheet represents a cold collisionless distribution with constant mass per unit Lagrangian coordinate $m_{0}$, so the phase-space Distribution Function (DF) $f(x,v)$ is supported on the parametric curve $(x(q),v(q))$. Consider the resulting fold caustic at $x=0$, where the spatial density diverges.\n\nYour tasks are:\n- Derive, from first principles, the exact expressions for the phase-space DF $f(x,v)$ and the Eulerian spatial density $\\rho(x)$ generated by the mapping $x(q) = q^{2}$, $v(q) = q$. Use only the definitions of the DF for collisionless flow, the properties of the Dirac delta distribution, and change-of-variable rules.\n- Derive the expected value and variance of a Kernel Density Estimation (KDE) of $\\rho(x)$ at the caustic location $x_{0}=0$ when the sheet is Monte Carlo (MC) sampled by $N$ particles uniformly in $q \\in [-Q,Q]$. Use a top-hat kernel $K_{h}$ of width $h$ defined by $K_{h}(x-x_{0}) = \\frac{1}{h}$ for $|x-x_{0}| \\le h/2$ and $K_{h}(x-x_{0})=0$ otherwise, and assume the estimator is $\\hat{\\rho}_{h}(x_{0}) = \\frac{1}{h} \\sum_{i=1}^{N} w \\, \\mathbb{I}(|x_{i}-x_{0}| \\le h/2)$ with particle mass $w = \\frac{M}{N}$ and total mass $M = \\int_{-Q}^{Q} m_{0} \\, dq = 2 Q m_{0}$. Quantify the coefficient of variation $\\mathrm{CV} = \\sqrt{\\mathrm{Var}[\\hat{\\rho}_{h}(x_{0})]}/\\mathbb{E}[\\hat{\\rho}_{h}(x_{0})]$ and deduce how the bandwidth $h$ must scale with $N$ to keep $\\mathrm{CV}$ bounded as $N \\to \\infty$ in the presence of the caustic.\n- Implement a deterministic MC experiment to test the scaling law at $x_{0}=0$. In each test case, generate $N$ particles by sampling $q$ uniformly in $[-Q,Q]$, map to $x=q^{2}$, and evaluate the top-hat KDE at $x_{0}=0$. Repeat this experiment over a fixed number of replicates with different fixed seeds, compute the empirical coefficient of variation $\\mathrm{CV}_{\\mathrm{emp}}$, and compare against the threshold $\\tau=0.25$. Report whether the scaling choice satisfies $\\mathrm{CV}_{\\mathrm{emp}} \\le \\tau$.\n\nAssume dimensionless units with $m_{0}=1$ and $Q=1$. Use angle-independent quantities. The program must be self-contained and produce deterministic results by seeding the random number generator in a reproducible way.\n\nTest suite:\n- Case 1 (happy path): $N=4000$, bandwidth $h=c N^{-\\alpha}$ with $\\alpha=2$ and $c=512$, replicates $R=200$, threshold $\\tau=0.25$. This case tests the borderline scaling expected to keep $\\mathrm{CV}$ approximately constant with $N$.\n- Case 2 (well-resolved): $N=4000$, bandwidth $h=c N^{-\\alpha}$ with $\\alpha=0.5$ and $c=8$, replicates $R=200$, threshold $\\tau=0.25$. This case tests slower shrinkage of bandwidth, expected to reduce $\\mathrm{CV}$.\n- Case 3 (edge-case failure): $N=4000$, bandwidth $h=c N^{-\\alpha}$ with $\\alpha=2.5$ and $c=512$, replicates $R=200$, threshold $\\tau=0.25$. This case tests overly aggressive bandwidth shrinkage, expected to increase $\\mathrm{CV}$.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each entry is a boolean indicating whether $\\mathrm{CV}_{\\mathrm{emp}} \\le \\tau$ for the corresponding test case, in the order of the three cases. For example, the expected format is $[b_{1},b_{2},b_{3}]$ where each $b_{i}$ is either $True$ or $False$.", "solution": "The problem is approached in three stages. First, the exact analytical forms of the phase-space Distribution Function ($DF$) and the corresponding spatial density are derived from first principles. Second, a statistical analysis of the proposed Kernel Density Estimation (KDE) method is performed to understand its behavior, particularly at the caustic. This analysis yields a theoretical scaling law for the kernel bandwidth $h$ as a function of particle number $N$. Finally, a numerical algorithm is designed to implement a Monte Carlo experiment that tests this derived scaling law against the provided test cases.\n\n**Part 1: Analytical Derivations**\n\nThe system describes a one-dimensional, cold, collisionless sheet. The state of any point on the sheet is parameterized by a single Lagrangian coordinate $q \\in [-Q, Q]$. The mapping from this Lagrangian coordinate to the Eulerian phase space $(x, v)$ is given by $x(q) = q^2$ and $v(q) = q$. The mass per unit Lagrangian coordinate is a constant, $m_0$.\n\nThe phase-space Distribution Function, $f(x,v)$, for such a continuous sheet can be expressed as an integral over the Lagrangian parameter $q$. It is non-zero only on the curve $(x(q), v(q))$ specified by the mapping:\n$$f(x,v) = \\int_{-Q}^{Q} m_0 \\, \\delta(x - x(q)) \\, \\delta(v - v(q)) \\, dq$$\nwhere $\\delta(\\cdot)$ is the Dirac delta distribution. Substituting the given mappings $x(q) = q^2$ and $v(q) = q$:\n$$f(x,v) = \\int_{-Q}^{Q} m_0 \\, \\delta(x - q^2) \\, \\delta(v - q) \\, dq$$\nThe integration over $q$ is simplified by the term $\\delta(v-q)$, which forces $q=v$. Using the sifting property of the delta distribution, we get:\n$$f(x,v) = m_0 \\, \\delta(x - v^2)$$\nThis expression is valid only if the value $q=v$ is within the integration limits, i.e., $v \\in [-Q, Q]$. Outside this velocity range, the $DF$ is zero. So, the full expression is:\n$$f(x,v) = m_0 \\, \\delta(x - v^2) \\, \\mathbb{I}(v \\in [-Q, Q])$$\nwhere $\\mathbb{I}(\\cdot)$ is the indicator function. The problem states $m_0=1$ and $Q=1$, simplifying this to $f(x,v) = \\delta(x - v^2) \\, \\mathbb{I}(v \\in [-1, 1])$. The support of this $DF$ is the parabola $x=v^2$ for $v \\in [-1, 1]$.\n\nThe Eulerian spatial density $\\rho(x)$ is the integral of the $DF$ over all velocities:\n$$\\rho(x) = \\int_{-\\infty}^{\\infty} f(x,v) \\, dv = \\int_{-1}^{1} m_0 \\, \\delta(x - v^2) \\, dv$$\nTo evaluate this integral, we use the property of the Dirac delta distribution involving a function as its argument: $\\delta(g(v)) = \\sum_i \\frac{\\delta(v - v_i)}{|g'(v_i)|}$, where $v_i$ are the simple roots of $g(v)=0$. Here, $g(v) = x - v^2$. The roots are $v = \\pm\\sqrt{x}$, which are real and distinct for $x > 0$. The derivative is $g'(v) = -2v$, so $|g'(v)| = 2|v|$. At the roots, $|g'(\\pm\\sqrt{x})| = 2\\sqrt{x}$.\nTherefore, for $x > 0$:\n$$\\delta(x - v^2) = \\frac{\\delta(v - \\sqrt{x})}{2\\sqrt{x}} + \\frac{\\delta(v + \\sqrt{x})}{2\\sqrt{x}}$$\nSubstituting this into the expression for $\\rho(x)$:\n$$\\rho(x) = \\int_{-1}^{1} m_0 \\left( \\frac{\\delta(v - \\sqrt{x})}{2\\sqrt{x}} + \\frac{\\delta(v + \\sqrt{x})}{2\\sqrt{x}} \\right) dv$$\nThe integral is non-zero only if the roots $v = \\pm\\sqrt{x}$ lie within the integration domain $[-1, 1]$. This condition is satisfied if $\\sqrt{x} \\le 1$, which means $0 < x \\le 1$. For this range of $x$, both delta functions contribute to the integral:\n$$\\rho(x) = \\frac{m_0}{2\\sqrt{x}} \\left( \\int_{-1}^{1} \\delta(v - \\sqrt{x}) \\, dv + \\int_{-1}^{1} \\delta(v + \\sqrt{x}) \\, dv \\right) = \\frac{m_0}{2\\sqrt{x}} (1 + 1) = \\frac{m_0}{\\sqrt{x}}$$\nFor $x \\le 0$ or $x > 1$, $\\rho(x)=0$. With $m_0=1$, the final expression for the density is $\\rho(x) = 1/\\sqrt{x}$ for $x \\in (0, 1]$. The density diverges as $x \\to 0^+$, which is the location of the fold caustic.\n\n**Part 2: Statistical Analysis of the KDE**\n\nThe problem defines a KDE estimator for the density at $x_0=0$:\n$$\\hat{\\rho}_{h}(0) = \\frac{1}{h} \\sum_{i=1}^{N} w \\, \\mathbb{I}(|x_{i}| \\le h/2)$$\nwhere $w = M/N = 2Qm_0/N$ is the particle mass, and $x_i = q_i^2$ with $q_i$ sampled uniformly from $[-Q, Q]$. Since $x_i \\ge 0$, the condition $|x_i| \\le h/2$ simplifies to $0 \\le x_i \\le h/2$, which is equivalent to $q_i^2 \\le h/2$, or $|q_i| \\le \\sqrt{h/2}$.\n\nLet $Y_i = \\mathbb{I}(|q_i| \\le \\sqrt{h/2})$ be a Bernoulli random variable. The probability of success, $p$, is the ratio of the length of the interval $[-\\sqrt{h/2}, \\sqrt{h/2}]$ to the length of the sampling domain $[-Q, Q]$, assuming $\\sqrt{h/2} \\le Q$:\n$$p = P(|q_i| \\le \\sqrt{h/2}) = \\frac{2\\sqrt{h/2}}{2Q} = \\frac{\\sqrt{h}}{\\sqrt{2}Q}$$\nThe number of particles in the bin, $K = \\sum_{i=1}^{N} Y_i$, follows a binomial distribution $B(N, p)$. The estimator is $\\hat{\\rho}_h(0) = \\frac{w}{h} K = \\frac{M}{Nh} K$.\n\nThe expected value of the estimator is:\n$$\\mathbb{E}[\\hat{\\rho}_{h}(0)] = \\frac{M}{Nh} \\mathbb{E}[K] = \\frac{M}{Nh} (Np) = \\frac{M}{h} p = \\frac{2Qm_0}{h} \\frac{\\sqrt{h}}{\\sqrt{2}Q} = \\frac{\\sqrt{2}m_0}{\\sqrt{h}}$$\nThe variance of the estimator is:\n$$\\mathrm{Var}[\\hat{\\rho}_{h}(0)] = \\left(\\frac{M}{Nh}\\right)^2 \\mathrm{Var}[K] = \\frac{M^2}{N^2 h^2} (Np(1-p)) = \\frac{M^2 p(1-p)}{N h^2}$$\nThe squared coefficient of variation, $\\mathrm{CV}^2$, is the ratio of the variance to the squared expectation:\n$$\\mathrm{CV}^2 = \\frac{\\mathrm{Var}[\\hat{\\rho}_{h}(0)]}{(\\mathbb{E}[\\hat{\\rho}_{h}(0)])^2} = \\frac{M^2 p(1-p) / (N h^2)}{(Mp/h)^2} = \\frac{1-p}{Np}$$\nAs $N \\to \\infty$, the bandwidth $h \\to 0$ to resolve the structure, so $p \\to 0$ and $1-p \\approx 1$. The expression simplifies to:\n$$\\mathrm{CV}^2 \\approx \\frac{1}{Np} = \\frac{1}{N \\frac{\\sqrt{h}}{\\sqrt{2}Q}} = \\frac{\\sqrt{2}Q}{N\\sqrt{h}}$$\nTo keep the $\\mathrm{CV}$ bounded (i.e., constant) as $N \\to \\infty$, the term $N\\sqrt{h}$ must be constant. Let $N\\sqrt{h} = \\text{const}$. Squaring both sides gives $N^2 h = \\text{const}$, which implies the bandwidth must scale as $h \\propto N^{-2}$.\nThis scaling, $h \\propto N^{-2}$, is much more aggressive than the standard optimal scaling for non-singular densities (which is $h \\propto N^{-1/5}$ in 1D for Mean Integrated Squared Error minimization), and is a direct consequence of the $x^{-1/2}$ density profile at the caustic.\n\nFor the proposed scaling $h = c N^{-\\alpha}$, the coefficient of variation behaves as:\n$$\\mathrm{CV} \\approx \\sqrt{\\frac{\\sqrt{2}Q}{N\\sqrt{c N^{-\\alpha}}}} = \\sqrt{\\frac{\\sqrt{2}Q}{N \\cdot c^{1/2} N^{-\\alpha/2}}} = \\sqrt{\\frac{\\sqrt{2}Q}{c^{1/2}} N^{\\frac{\\alpha}{2}-1}}$$\n- If $\\alpha = 2$, $\\mathrm{CV} \\propto N^{1-1} = N^0$, which is constant.\n- If $\\alpha < 2$ (e.g., $\\alpha=0.5$), $\\mathrm{CV} \\propto N^{0.25-1} = N^{-0.75}$, which decreases as $N \\to \\infty$.\n- If $\\alpha > 2$ (e.g., $\\alpha=2.5$), $\\mathrm{CV} \\propto N^{1.25-1} = N^{0.25}$, which diverges as $N \\to \\infty$.\nThese theoretical predictions match the expectations for the three test cases.\n\n**Part 3: Algorithmic Design for Numerical Experiment**\n\nThe numerical experiment validates the derived scaling law. The algorithm proceeds as follows for each test case:\n1.  Initialize parameters: particle number $N$, scaling parameters $c$ and $\\alpha$, number of replicates $R$, and threshold $\\tau$. Set physical constants $m_0=1$ and $Q=1$.\n2.  Calculate dependent quantities: total mass $M=2Qm_0=2$, particle mass $w=M/N$, and bandwidth $h=c N^{-\\alpha}$.\n3.  Execute a loop for $r$ from $1$ to $R$ to perform the replicates:\n    a. Seed a random number generator with a unique but deterministic seed for each replicate (e.g., `master_seed + r`) to ensure reproducibility.\n    b. Generate $N$ Lagrangian coordinates $q_i$ by drawing from a uniform distribution over $[-Q, Q]$.\n    c. Transform these to Eulerian positions: $x_i = q_i^2$.\n    d. Count the number of particles $K_r$ that fall within the KDE bin at $x_0=0$, i.e., satisfy $0 \\le x_i \\le h/2$.\n    e. Calculate the density estimate for the replicate: $\\hat{\\rho}_{h,r}(0) = \\frac{w}{h} K_r$.\n    f. Store this estimate $\\hat{\\rho}_{h,r}(0)$.\n4.  After all replicates are complete, compute the empirical statistics from the $R$ stored estimates:\n    a. Empirical mean: $\\bar{\\rho} = \\frac{1}{R} \\sum_{r=1}^{R} \\hat{\\rho}_{h,r}(0)$.\n    b. Empirical sample variance: $s^2 = \\frac{1}{R-1} \\sum_{r=1}^{R} (\\hat{\\rho}_{h,r}(0) - \\bar{\\rho})^2$.\n    c. Empirical coefficient of variation: $\\mathrm{CV}_{\\mathrm{emp}} = s / \\bar{\\rho}$.\n5.  Compare the result with the threshold: determine if $\\mathrm{CV}_{\\mathrm{emp}} \\le \\tau$.\n6.  The boolean outcomes for the three test cases are collected and printed in the required format. This procedure systematically tests the theoretical scaling predictions.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem by running a deterministic Monte Carlo experiment\n    for three specified test cases to validate the scaling law of KDE at a caustic.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1 (happy path): N=4000, alpha=2.0, c=512, R=200, tau=0.25\n        {'N': 4000, 'alpha': 2.0, 'c': 512.0, 'R': 200, 'tau': 0.25},\n        # Case 2 (well-resolved): N=4000, alpha=0.5, c=8, R=200, tau=0.25\n        {'N': 4000, 'alpha': 0.5, 'c': 8.0, 'R': 200, 'tau': 0.25},\n        # Case 3 (edge-case failure): N=4000, alpha=2.5, c=512, R=200, tau=0.25\n        {'N': 4000, 'alpha': 2.5, 'c': 512.0, 'R': 200, 'tau': 0.25},\n    ]\n\n    results = []\n\n    # A master seed for overall reproducibility of the experiment\n    master_seed = 0\n\n    for case in test_cases:\n        N = case['N']\n        alpha = case['alpha']\n        c = case['c']\n        R = case['R']\n        tau = case['tau']\n        \n        # Physical constants from the problem description\n        m0 = 1.0\n        Q = 1.0\n        \n        # Total mass of the system\n        M = 2.0 * Q * m0\n        # Mass per Monte Carlo particle\n        w = M / N\n        \n        # KDE bandwidth, calculated from the scaling law h = c * N^(-alpha)\n        h = c * (N ** (-alpha))\n        \n        # The location of the caustic where density is estimated\n        x0 = 0.0\n        \n        # Array to store the density estimates from each replicate\n        rho_estimates = np.zeros(R)\n        \n        for r in range(R):\n            # Create a new Random Number Generator for each replicate with a deterministic seed.\n            # This ensures each replicate is statistically independent but the entire experiment\n            # is reproducible.\n            rng = np.random.default_rng(master_seed + r)\n            \n            # Step 1: Generate N particles by sampling the Lagrangian parameter q uniformly in [-Q, Q]\n            q_particles = rng.uniform(-Q, Q, size=N)\n            \n            # Step 2: Map to Eulerian position x using x(q) = q^2\n            x_particles = q_particles**2\n            \n            # Step 3: Evaluate the top-hat Kernel Density Estimator at x0 = 0.\n            # The kernel support is |x_i - x_0| <= h/2.\n            # Since x0=0 and x_i are non-negative, this simplifies to 0 <= x_i <= h/2.\n            \n            # Count the number of particles falling within the kernel's support region\n            count_in_bin = np.sum(x_particles <= h / 2.0)\n            \n            # Calculate the density estimate for this replicate using the formula:\n            # rho_hat = (1/h) * sum(w * I(...)) = (w/h) * count_in_bin\n            if h > 0:\n                rho_hat_r = (w / h) * count_in_bin\n                rho_estimates[r] = rho_hat_r\n            else: # If bandwidth is zero, estimate is ill-defined, treat as zero\n                rho_estimates[r] = 0.0\n\n        # Step 4: After all replicates, compute empirical statistics\n        if R > 1:\n            # Empirical mean of the density estimates\n            mean_rho = np.mean(rho_estimates)\n            \n            # Empirical sample variance (using ddof=1 for an unbiased estimator)\n            var_rho = np.var(rho_estimates, ddof=1)\n            \n            # Empirical Coefficient of Variation (CV)\n            # Avoid division by zero if the mean estimate is close to zero\n            if mean_rho > 1e-12:\n                cv_emp = np.sqrt(var_rho) / mean_rho\n            else:\n                # If mean is zero, variance is zero, CV is ill-defined or 0.\n                # In a noisy context, could be considered infinite. Let's use 0.\n                cv_emp = 0.0\n        else: # Handle the case of a single replicate (no variation)\n            cv_emp = 0.0\n\n        # Step 5: Compare the empirical CV against the threshold and store the boolean result\n        results.append(cv_emp <= tau)\n        \n    # Print the final results in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3497486"}]}