{"hands_on_practices": [{"introduction": "The effectiveness of a hybrid Tree-PM method hinges on the precise mathematical form of the force splitting. This practice delves into this core concept by having you derive the real-space short-range potential and force from their definitions in Fourier space [@problem_id:3475892]. By working through this fundamental calculation, you will gain a concrete understanding of the force kernel that is handled by the computationally expensive tree algorithm, clarifying why it is \"short-range.\"", "problem": "Consider a hybrid Tree-Particle Mesh (Tree-PM) method in numerical cosmology, where the Newtonian potential of a point mass is split into a short-range (Tree) part and a long-range (Particle Mesh) part using a Gaussian filter of comoving smoothing scale $r_{s}$. The Newtonian potential of a point mass $m$ at the origin is given by $\\phi_{\\mathrm{N}}(r)=-G m/r$, where $G$ is the gravitational constant and $r$ is the comoving separation. In Fourier space, using the convention $\\phi(\\boldsymbol{k})=\\int \\mathrm{d}^{3}\\boldsymbol{r}\\,\\phi(\\boldsymbol{r})\\exp(-\\mathrm{i}\\,\\boldsymbol{k}\\cdot\\boldsymbol{r})$ and $\\phi(\\boldsymbol{r})=\\int \\mathrm{d}^{3}\\boldsymbol{k}\\,\\phi(\\boldsymbol{k})\\exp(\\mathrm{i}\\,\\boldsymbol{k}\\cdot\\boldsymbol{r})/(2\\pi)^{3}$, the Green’s function for the Newtonian potential of a point mass is $\\Phi(\\boldsymbol{k})=-4\\pi G m/k^2$. A Gaussian split is effected by multiplying $\\Phi(\\boldsymbol{k})$ by a Gaussian $W(k)=\\exp(-k^2 r_s^2)$, thereby defining the long-range part as $\\Phi_{\\mathrm{LR}}(\\boldsymbol{k})=\\Phi(\\boldsymbol{k})W(k)$ and the short-range part as $\\Phi_{\\mathrm{SR}}(\\boldsymbol{k})=\\Phi(\\boldsymbol{k})\\left[1-W(k)\\right]$. The complementary error function is defined by $\\mathrm{erfc}(x)=1-\\mathrm{erf}(x)$, where $\\mathrm{erf}(x)=\\frac{2}{\\sqrt{\\pi}}\\int_{0}^{x}\\exp(-t^2)\\,\\mathrm{d}t$.\n\nStarting from these definitions and conventions, and without introducing any shortcut formulas beyond the stated fundamental base, derive the real-space short-range potential $\\phi_{\\mathrm{SR}}(r)$ of the point mass by inverse Fourier transformation, and then compute the spherically symmetric radial short-range force magnitude $F_{\\mathrm{SR}}(r)$ from $F_{\\mathrm{SR}}(r)=\\mathrm{d}\\phi_{\\mathrm{SR}}/\\mathrm{d}r$. Express the final $F_{\\mathrm{SR}}(r)$ as a single closed-form analytic expression in terms of $G$, $m$, $r$, $r_{s}$, $\\mathrm{erfc}$, and $\\exp$. Use International System of Units (SI) for any physical quantities; if you were to evaluate numerically, the force would be in Newtons. No numerical evaluation is required; provide an exact expression. Do not round. The final answer must be the explicit analytic expression for $F_{\\mathrm{SR}}(r)$ only.", "solution": "The problem is validated as scientifically grounded, well-posed, and objective. It represents a standard calculation in the context of numerical cosmology simulations. All definitions, conventions, and physical premises are consistent with established principles. The problem is therefore deemed valid and a full solution will be derived.\n\nThe objective is to compute the short-range force magnitude $F_{\\mathrm{SR}}(r)$, which is defined by the problem as the radial derivative of the short-range potential, $F_{\\mathrm{SR}}(r) = \\mathrm{d}\\phi_{\\mathrm{SR}}/\\mathrm{d}r$. To accomplish this, we must first derive the expression for the real-space short-range potential, $\\phi_{\\mathrm{SR}}(r)$.\n\nThe problem states that the short-range potential in Fourier space, $\\Phi_{\\mathrm{SR}}(\\boldsymbol{k})$, is given by the difference between the full Newtonian potential and the long-range potential:\n$$\n\\Phi_{\\mathrm{SR}}(\\boldsymbol{k}) = \\Phi(\\boldsymbol{k}) \\left[1-W(k)\\right] = \\Phi(\\boldsymbol{k}) - \\Phi_{\\mathrm{LR}}(\\boldsymbol{k})\n$$\nwhere $\\Phi(\\boldsymbol{k})$ is the Fourier transform of the full Newtonian potential $\\phi_{\\mathrm{N}}(r)$, and $\\Phi_{\\mathrm{LR}}(\\boldsymbol{k})$ is the Fourier transform of the long-range potential $\\phi_{\\mathrm{LR}}(r)$.\n\nThe inverse Fourier transform is a linear operation. Applying it to the equation above yields the relationship in real space:\n$$\n\\phi_{\\mathrm{SR}}(\\boldsymbol{r}) = \\mathcal{F}^{-1}[\\Phi_{\\mathrm{SR}}(\\boldsymbol{k})] = \\mathcal{F}^{-1}[\\Phi(\\boldsymbol{k})] - \\mathcal{F}^{-1}[\\Phi_{\\mathrm{LR}}(\\boldsymbol{k})]\n$$\nGiven that $\\phi_{\\mathrm{N}}(r)=-G m/r$ is the inverse Fourier transform of $\\Phi(\\boldsymbol{k})$, and since the potential is spherically symmetric, we can write $\\phi_{\\mathrm{SR}}(r)$ as:\n$$\n\\phi_{\\mathrm{SR}}(r) = \\phi_{\\mathrm{N}}(r) - \\phi_{\\mathrm{LR}}(r) = -\\frac{G m}{r} - \\phi_{\\mathrm{LR}}(r)\n$$\nOur first task is to calculate $\\phi_{\\mathrm{LR}}(r)$ by taking the inverse Fourier transform of $\\Phi_{\\mathrm{LR}}(\\boldsymbol{k})$. The problem provides the Fourier convention:\n$$\n\\phi_{\\mathrm{LR}}(\\boldsymbol{r}) = \\int \\frac{\\mathrm{d}^3\\boldsymbol{k}}{(2\\pi)^3} \\Phi_{\\mathrm{LR}}(\\boldsymbol{k}) \\exp(\\mathrm{i}\\,\\boldsymbol{k}\\cdot\\boldsymbol{r})\n$$\nWe are given $\\Phi_{\\mathrm{LR}}(\\boldsymbol{k}) = \\Phi(\\boldsymbol{k})W(k) = \\left(-\\frac{4\\pi G m}{k^2}\\right) \\exp(-k^2 r_s^2)$. Substituting this into the integral:\n$$\n\\phi_{\\mathrm{LR}}(r) = \\int \\frac{\\mathrm{d}^3\\boldsymbol{k}}{(2\\pi)^3} \\left(-\\frac{4\\pi G m}{k^2}\\right) \\exp(-k^2 r_s^2) \\exp(\\mathrm{i}\\,\\boldsymbol{k}\\cdot\\boldsymbol{r})\n$$\nTo evaluate this $3$-dimensional integral, we switch to spherical coordinates in $\\boldsymbol{k}$-space. Let the z-axis be aligned with the vector $\\boldsymbol{r}$, so that $\\boldsymbol{r}$ has magnitude $r=|\\boldsymbol{r}|$ and $\\boldsymbol{k}\\cdot\\boldsymbol{r} = kr\\cos\\theta_k$, where $\\theta_k$ is the polar angle of $\\boldsymbol{k}$. The volume element is $\\mathrm{d}^3\\boldsymbol{k} = k^2 \\sin\\theta_k \\, \\mathrm{d}k \\, \\mathrm{d}\\theta_k \\, \\mathrm{d}\\phi_k$.\n$$\n\\phi_{\\mathrm{LR}}(r) = -\\frac{4\\pi G m}{(2\\pi)^3} \\int_0^\\infty \\mathrm{d}k \\int_0^\\pi \\mathrm{d}\\theta_k \\int_0^{2\\pi} \\mathrm{d}\\phi_k \\, k^2 \\sin\\theta_k \\left(\\frac{1}{k^2}\\right) \\exp(-k^2 r_s^2) \\exp(\\mathrm{i}kr\\cos\\theta_k)\n$$\nThe integral over the azimuthal angle $\\phi_k$ yields $2\\pi$. The $k^2$ terms cancel out.\n$$\n\\phi_{\\mathrm{LR}}(r) = -\\frac{8\\pi^2 G m}{8\\pi^3} \\int_0^\\infty \\mathrm{d}k \\, \\exp(-k^2 r_s^2) \\int_0^\\pi \\mathrm{d}\\theta_k \\, \\sin\\theta_k \\exp(\\mathrm{i}kr\\cos\\theta_k)\n$$\n$$\n\\phi_{\\mathrm{LR}}(r) = -\\frac{G m}{\\pi} \\int_0^\\infty \\mathrm{d}k \\, \\exp(-k^2 r_s^2) \\left[ \\int_0^\\pi \\sin\\theta_k \\exp(\\mathrm{i}kr\\cos\\theta_k) \\, \\mathrm{d}\\theta_k \\right]\n$$\nThe integral in the square brackets can be solved by substituting $u=\\cos\\theta_k$, $\\mathrm{d}u=-\\sin\\theta_k \\mathrm{d}\\theta_k$:\n$$\n\\int_1^{-1} e^{\\mathrm{i}kru} (-\\mathrm{d}u) = \\int_{-1}^1 e^{\\mathrm{i}kru} \\mathrm{d}u = \\left[\\frac{e^{\\mathrm{i}kru}}{\\mathrm{i}kr}\\right]_{-1}^1 = \\frac{e^{\\mathrm{i}kr} - e^{-\\mathrm{i}kr}}{\\mathrm{i}kr} = \\frac{2\\sin(kr)}{kr}\n$$\nSubstituting this result back into the expression for $\\phi_{\\mathrm{LR}}(r)$:\n$$\n\\phi_{\\mathrm{LR}}(r) = -\\frac{G m}{\\pi} \\int_0^\\infty \\exp(-k^2 r_s^2) \\frac{2\\sin(kr)}{kr} \\, \\mathrm{d}k = -\\frac{2 G m}{\\pi r} \\int_0^\\infty \\frac{\\sin(kr)}{k} \\exp(-k^2 r_s^2) \\, \\mathrm{d}k\n$$\nThis integral is a standard form related to the error function, $\\mathrm{erf}(x)$. The identity is $\\int_0^\\infty \\frac{\\sin(ax)}{x} \\exp(-b^2 x^2) \\mathrm{d}x = \\frac{\\pi}{2} \\mathrm{erf}\\left(\\frac{a}{2b}\\right)$. Here, we have $x=k$, $a=r$, and $b=r_s$.\n$$\n\\int_0^\\infty \\frac{\\sin(kr)}{k} \\exp(-k^2 r_s^2) \\, \\mathrm{d}k = \\frac{\\pi}{2} \\mathrm{erf}\\left(\\frac{r}{2r_s}\\right)\n$$\nPlugging this into the expression for $\\phi_{\\mathrm{LR}}(r)$:\n$$\n\\phi_{\\mathrm{LR}}(r) = -\\frac{2 G m}{\\pi r} \\left(\\frac{\\pi}{2} \\mathrm{erf}\\left(\\frac{r}{2r_s}\\right)\\right) = -\\frac{G m}{r} \\mathrm{erf}\\left(\\frac{r}{2r_s}\\right)\n$$\nNow we can write the short-range potential $\\phi_{\\mathrm{SR}}(r)$:\n$$\n\\phi_{\\mathrm{SR}}(r) = -\\frac{G m}{r} - \\left(-\\frac{G m}{r} \\mathrm{erf}\\left(\\frac{r}{2r_s}\\right)\\right) = -\\frac{G m}{r} \\left(1 - \\mathrm{erf}\\left(\\frac{r}{2r_s}\\right)\\right)\n$$\nUsing the given definition of the complementary error function, $\\mathrm{erfc}(x) = 1 - \\mathrm{erf}(x)$, we obtain the final expression for the short-range potential:\n$$\n\\phi_{\\mathrm{SR}}(r) = -\\frac{G m}{r} \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right)\n$$\nThe final step is to compute the force magnitude $F_{\\mathrm{SR}}(r)$ by differentiating $\\phi_{\\mathrm{SR}}(r)$ with respect to $r$.\n$$\nF_{\\mathrm{SR}}(r) = \\frac{\\mathrm{d}}{\\mathrm{d}r}\\phi_{\\mathrm{SR}}(r) = \\frac{\\mathrm{d}}{\\mathrm{d}r}\\left[ -\\frac{G m}{r} \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) \\right]\n$$\nUsing the product rule for differentiation, $(uv)' = u'v + uv'$:\n$$\nF_{\\mathrm{SR}}(r) = -G m \\left[ \\left(\\frac{\\mathrm{d}}{\\mathrm{d}r}\\frac{1}{r}\\right) \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) + \\frac{1}{r} \\left(\\frac{\\mathrm{d}}{\\mathrm{d}r}\\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right)\\right) \\right]\n$$\n$$\nF_{\\mathrm{SR}}(r) = -G m \\left[ -\\frac{1}{r^2} \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) + \\frac{1}{r} \\left(\\frac{\\mathrm{d}}{\\mathrm{d}r}\\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right)\\right) \\right]\n$$\nTo find the derivative of $\\mathrm{erfc}$, we use its definition in terms of the error function integral: $\\frac{\\mathrm{d}}{\\mathrm{d}x}\\mathrm{erf}(x) = \\frac{2}{\\sqrt{\\pi}}\\exp(-x^2)$. Thus, $\\frac{\\mathrm{d}}{\\mathrm{d}x}\\mathrm{erfc}(x) = -\\frac{2}{\\sqrt{\\pi}}\\exp(-x^2)$. Using the chain rule with argument $u = r/(2r_s)$, for which $\\mathrm{d}u/\\mathrm{d}r = 1/(2r_s)$:\n$$\n\\frac{\\mathrm{d}}{\\mathrm{d}r}\\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) = \\left( -\\frac{2}{\\sqrt{\\pi}}\\exp\\left(-\\left(\\frac{r}{2r_s}\\right)^2\\right) \\right) \\cdot \\frac{1}{2r_s} = -\\frac{1}{r_s\\sqrt{\\pi}}\\exp\\left(-\\frac{r^2}{4r_s^2}\\right)\n$$\nSubstituting this derivative back into the expression for $F_{\\mathrm{SR}}(r)$:\n$$\nF_{\\mathrm{SR}}(r) = -G m \\left[ -\\frac{1}{r^2} \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) + \\frac{1}{r} \\left(-\\frac{1}{r_s\\sqrt{\\pi}}\\exp\\left(-\\frac{r^2}{4r_s^2}\\right)\\right) \\right]\n$$\n$$\nF_{\\mathrm{SR}}(r) = -G m \\left[ -\\frac{1}{r^2} \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) - \\frac{1}{r r_s\\sqrt{\\pi}}\\exp\\left(-\\frac{r^2}{4r_s^2}\\right) \\right]\n$$\nDistributing the leading factor $-G m$ gives the final expression for the short-range force magnitude as defined in the problem:\n$$\nF_{\\mathrm{SR}}(r) = \\frac{G m}{r^2} \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) + \\frac{G m}{r r_s\\sqrt{\\pi}} \\exp\\left(-\\frac{r^2}{4r_s^2}\\right)\n$$\nThis is a single closed-form analytic expression in terms of the specified quantities.", "answer": "$$\\boxed{\\frac{G m}{r^2} \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) + \\frac{G m}{r r_s\\sqrt{\\pi}} \\exp\\left(-\\frac{r^2}{4r_s^2}\\right)}$$", "id": "3475892"}, {"introduction": "While the Particle-Mesh (PM) component efficiently computes long-range forces, its reliance on a discrete grid introduces systematic errors from mass assignment and the finite-difference approximation of the Laplacian. This exercise guides you through the process of quantifying and correcting these errors, a critical step in building a high-precision code [@problem_id:3475913]. You will derive the deconvolution factor needed to counteract the smoothing effects of the popular Cloud-in-Cell (CIC) scheme and analyze the residual force bias, highlighting the inherent limitations of grid-based calculations.", "problem": "Consider a hybrid Tree-PM method for cosmological $N$-body simulations, where long-range gravitational forces are computed on a uniform Cartesian mesh of spacing $\\Delta x$ using a Fourier-space Poisson solver, and short-range forces are computed with a tree algorithm. In the PM component, particles are assigned to the mesh using the Cloud-in-Cell (CIC) scheme and forces are interpolated back to particles using the same CIC kernel. Let the Nyquist wavenumber be $k_{\\mathrm{Ny}} = \\pi / \\Delta x$, and denote a Fourier mode by $\\boldsymbol{k} = (k_x, k_y, k_z)$. The discrete lattice Green’s function for the second-order finite-difference Laplacian is defined by\n$$\n\\hat{\\Delta}(\\boldsymbol{k}) = \\frac{2}{\\Delta x^2} \\sum_{i \\in \\{x,y,z\\}} \\left(1 - \\cos(k_i \\Delta x)\\right),\n$$\nso that the mesh-based potential satisfies $-\\hat{\\Delta}(\\boldsymbol{k}) \\,\\phi(\\boldsymbol{k}) = 4 \\pi G \\bar{\\rho} \\,\\delta(\\boldsymbol{k})$, where $G$ is the gravitational constant, $\\bar{\\rho}$ is the mean matter density, and $\\delta(\\boldsymbol{k})$ is the Fourier transform of the density contrast.\n\nStarting only from the following fundamental bases:\n- The Poisson equation in Fourier space for Newtonian gravity in comoving coordinates, $-k^2 \\phi(\\boldsymbol{k}) = 4 \\pi G \\bar{\\rho} \\,\\delta(\\boldsymbol{k})$ for the continuum, and its discrete counterpart given above for the mesh.\n- The definition of the one-dimensional CIC assignment kernel in real space as the triangular (tent) function $w_{\\mathrm{CIC}}(x) = 1 - |x|/\\Delta x$ for $|x| \\le \\Delta x$ and $w_{\\mathrm{CIC}}(x) = 0$ otherwise, and that three-dimensional assignment is separable as the product of one-dimensional kernels in each Cartesian direction.\n- The fact that convolution in real space corresponds to multiplication in Fourier space, and that the same kernel used for assignment is used for interpolation back to particle positions in the PM scheme.\n\nDerive:\n1. The Fourier-space deconvolution factor $D(\\boldsymbol{k})$ that must multiply the mesh-computed force in Fourier space to remove the bias introduced by CIC assignment and CIC interpolation, thereby recovering unbiased PM forces relative to the continuum in the absence of discretization effects.\n2. Under spectral differentiation (i.e., forces computed by multiplying by $i \\boldsymbol{k}$ in Fourier space) and using the discrete lattice Green’s function $\\hat{\\Delta}(\\boldsymbol{k})$ defined above, quantify the residual fractional amplitude bias $b(\\epsilon)$ of the PM force relative to the exact continuum force for a mode $\\boldsymbol{k} = (k_{\\mathrm{Ny}}(1 - \\epsilon), 0, 0)$ with $0 < \\epsilon \\ll 1$.\n\nExpress your final answer as a row matrix with two entries: the deconvolution factor $D(\\boldsymbol{k})$ as a closed-form analytical expression, and the residual fractional amplitude bias $b(\\epsilon)$ as a closed-form analytical expression. No numerical evaluation is required, and no rounding is needed. Do not include any physical units in your final answer.", "solution": "The user has requested the derivation of two quantities related to the Particle-Mesh (PM) method in cosmological simulations: a deconvolution factor and a residual force bias. The problem is well-defined, scientifically grounded in the field of numerical cosmology, and contains sufficient information for a unique solution.\n\n### Part 1: Derivation of the Deconvolution Factor $D(\\boldsymbol{k})$\n\nThe goal is to find the deconvolution factor $D(\\boldsymbol{k})$ that removes the bias introduced by the Cloud-in-Cell (CIC) assignment and interpolation steps. This bias arises from the smoothing effect of the CIC kernel. Let the CIC kernel be $W(\\boldsymbol{x})$. The problem states that the 3D kernel is separable, $W(\\boldsymbol{x}) = w_{\\mathrm{CIC}}(x_1)w_{\\mathrm{CIC}}(x_2)w_{\\mathrm{CIC}}(x_3)$, where the 1D kernel is the triangular function $w_{\\mathrm{CIC}}(x) = 1 - |x|/\\Delta x$ for $|x| \\le \\Delta x$ and zero otherwise.\n\nThe overall PM force calculation involves three main steps in Fourier space: mass assignment, solving the Poisson equation, and force interpolation.\n1.  **Mass Assignment**: The process of assigning particle masses to the grid effectively convolves the true density field with the assignment kernel $W(\\boldsymbol{x})$. In Fourier space, this corresponds to multiplying the Fourier transform of the density contrast, $\\delta(\\boldsymbol{k})$, by the Fourier transform of the assignment kernel, $\\hat{W}(\\boldsymbol{k})$. The density on the grid is thus $\\delta_{\\text{grid}}(\\boldsymbol{k}) = \\hat{W}(\\boldsymbol{k}) \\delta(\\boldsymbol{k})$.\n\n2.  **Poisson Solver**: The gravitational potential $\\phi_{\\text{mesh}}(\\boldsymbol{k})$ is computed from the gridded density using the discrete Poisson equation provided.\n\n3.  **Force Interpolation**: The force is interpolated from the grid back to the particle positions using the same kernel $W(\\boldsymbol{x})$. This is equivalent to convolving the grid force field with $W(\\boldsymbol{x})$. In Fourier space, the interpolated force experienced by the particles, $\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k})$, is related to the grid-based force, $\\boldsymbol{F}_{\\text{mesh}}(\\boldsymbol{k})$, by $\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}) = \\hat{W}(\\boldsymbol{k})\\boldsymbol{F}_{\\text{mesh}}(\\boldsymbol{k})$. (For a real and symmetric kernel $W(\\boldsymbol{x})$, its Fourier transform $\\hat{W}(\\boldsymbol{k})$ is real, and $\\hat{W}(-\\boldsymbol{k}) = \\hat{W}(\\boldsymbol{k})$).\n\nCombining these steps, the PM-computed force is related to the true density contrast $\\delta(\\boldsymbol{k})$ by:\n$$\n\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}) = \\hat{W}(\\boldsymbol{k}) \\boldsymbol{F}_{\\text{mesh}}(\\boldsymbol{k}) = \\hat{W}(\\boldsymbol{k}) \\left( \\boldsymbol{D}_{\\text{mesh}} \\phi_{\\text{mesh}}(\\boldsymbol{k}) \\right)\n$$\nwhere $\\boldsymbol{D}_{\\text{mesh}}$ is the operator for differentiating the potential to get the force. The potential is\n$$\n\\phi_{\\text{mesh}}(\\boldsymbol{k}) = G_{\\text{mesh}}(\\boldsymbol{k}) \\delta_{\\text{grid}}(\\boldsymbol{k}) = G_{\\text{mesh}}(\\boldsymbol{k}) \\hat{W}(\\boldsymbol{k}) \\delta(\\boldsymbol{k})\n$$\nwhere $G_{\\text{mesh}}(\\boldsymbol{k})$ is the Green's function for the discrete Poisson solver. Therefore,\n$$\n\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}) = \\hat{W}(\\boldsymbol{k}) \\boldsymbol{D}_{\\text{mesh}} G_{\\text{mesh}}(\\boldsymbol{k}) \\hat{W}(\\boldsymbol{k}) \\delta(\\boldsymbol{k}) = [\\hat{W}(\\boldsymbol{k})]^2 (\\boldsymbol{D}_{\\text{mesh}} G_{\\text{mesh}}(\\boldsymbol{k})) \\delta(\\boldsymbol{k})\n$$\nThe corresponding continuum force is $\\boldsymbol{F}_{\\text{cont}}(\\boldsymbol{k}) = (\\boldsymbol{D}_{\\text{cont}} G_{\\text{cont}}(\\boldsymbol{k})) \\delta(\\boldsymbol{k})$. The bias introduced specifically by the CIC assignment and interpolation is the factor $[\\hat{W}(\\boldsymbol{k})]^2$. To remove this bias, we must multiply the computed force by a deconvolution factor $D(\\boldsymbol{k}) = [\\hat{W}(\\boldsymbol{k})]^{-2}$.\n\nNext, we must find the Fourier transform of the CIC kernel. The 1D kernel is $w_{\\mathrm{CIC}}(x) = 1 - |x|/\\Delta x$ for $x \\in [-\\Delta x, \\Delta x]$. This is a triangular or \"tent\" function. The shape of the kernel is independent of its normalization. Let's use the dimensionless form of the Fourier transformed kernel, which is standard practice. The Fourier transform of the triangular function shape $\\Lambda(u) = 1-|u|$ for $|u| \\le 1$ is $\\operatorname{sinc}^2(k/2)$, where $\\operatorname{sinc}(z) = \\sin(z)/z$. Our kernel is $w_{\\mathrm{CIC}}(x) = \\Lambda(x/\\Delta x)$. The Fourier transform is:\n$$\n\\hat{w}_{\\text{shape}}(k_x) = \\mathcal{F}[\\Lambda(x/\\Delta x)] \\propto \\operatorname{sinc}^2\\left(\\frac{k_x \\Delta x}{2}\\right)\n$$\nThe 3D kernel is separable, so its Fourier transform is the product of the 1D transforms:\n$$\n\\hat{W}(\\boldsymbol{k}) \\propto \\prod_{i \\in \\{x,y,z\\}} \\operatorname{sinc}^2\\left(\\frac{k_i \\Delta x}{2}\\right)\n$$\nThe deconvolution factor is the inverse of the square of this shape factor:\n$$\nD(\\boldsymbol{k}) = \\left[ \\prod_{i \\in \\{x,y,z\\}} \\operatorname{sinc}^2\\left(\\frac{k_i \\Delta x}{2}\\right) \\right]^{-2} = \\prod_{i \\in \\{x,y,z\\}} \\operatorname{sinc}^{-4}\\left(\\frac{k_i \\Delta x}{2}\\right)\n$$\nThis can be written as:\n$$\nD(\\boldsymbol{k}) = \\prod_{i \\in \\{x,y,z\\}} \\left(\\frac{k_i\\Delta x / 2}{\\sin(k_i\\Delta x / 2)}\\right)^4\n$$\n\n### Part 2: Derivation of the Residual Fractional Amplitude Bias $b(\\epsilon)$\n\nThe fractional amplitude bias $b(\\boldsymbol{k})$ is defined as the ratio of the PM force amplitude to the exact continuum force amplitude, minus one:\n$$\nb(\\boldsymbol{k}) = \\frac{|\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k})|}{|\\boldsymbol{F}_{\\text{cont}}(\\boldsymbol{k})|} - 1\n$$\nFrom the problem statement, the continuum force is derived from $-k^2\\phi = 4\\pi G \\bar{\\rho} \\delta$, and using spectral differentiation ($\\boldsymbol{F} = -i\\boldsymbol{k}\\phi$), we get:\n$$\n\\boldsymbol{F}_{\\text{cont}}(\\boldsymbol{k}) = -i\\boldsymbol{k} \\left(\\frac{4\\pi G \\bar{\\rho}}{k^2}\\delta(\\boldsymbol{k})\\right) \\implies |\\boldsymbol{F}_{\\text{cont}}(\\boldsymbol{k})| \\propto \\frac{k}{k^2} = \\frac{1}{k}\n$$\nThe PM force (uncorrected) is derived from $-\\hat{\\Delta}\\phi=4\\pi G\\bar{\\rho}\\delta_{\\text{grid}}$ with the steps outlined in Part 1. With spectral differentiation, the PM force is:\n$$\n\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}) = -i\\boldsymbol{k} \\left( [\\hat{W}(\\boldsymbol{k})]^2 \\frac{4\\pi G \\bar{\\rho}}{\\hat{\\Delta}(\\boldsymbol{k})}\\delta(\\boldsymbol{k}) \\right) \\implies |\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k})| \\propto k \\frac{[\\hat{W}(\\boldsymbol{k})]^2}{\\hat{\\Delta}(\\boldsymbol{k})}\n$$\nThe ratio of magnitudes is:\n$$\n\\frac{|\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k})|}{|\\boldsymbol{F}_{\\text{cont}}(\\boldsymbol{k})|} = \\frac{k [\\hat{W}(\\boldsymbol{k})]^2 / \\hat{\\Delta}(\\boldsymbol{k})}{1/k} = \\frac{k^2 [\\hat{W}(\\boldsymbol{k})]^2}{\\hat{\\Delta}(\\boldsymbol{k})}\n$$\nWe evaluate this for the mode $\\boldsymbol{k} = (k_x, 0, 0)$ with $k_x = k_{\\mathrm{Ny}}(1-\\epsilon) = \\frac{\\pi}{\\Delta x}(1-\\epsilon)$, for $0 < \\epsilon \\ll 1$.\nFor this mode, $k_y=k_z=0$ and $k=|\\boldsymbol{k}|=k_x$.\nThe terms in the ratio are:\n1.  $k^2 = k_x^2 = \\left(\\frac{\\pi}{\\Delta x}(1-\\epsilon)\\right)^2 = \\frac{\\pi^2}{\\Delta x^2}(1-\\epsilon)^2$.\n2.  $\\hat{W}(\\boldsymbol{k})$: Since $k_y=k_z=0$, $\\operatorname{sinc}(0)=1$. So $\\hat{W}(\\boldsymbol{k}) = \\operatorname{sinc}^2\\left(\\frac{k_x \\Delta x}{2}\\right)$.\n    The argument is $\\frac{k_x \\Delta x}{2} = \\frac{\\pi}{2}(1-\\epsilon)$.\n    $\\hat{W}(\\boldsymbol{k}) = \\left(\\frac{\\sin(\\frac{\\pi}{2}(1-\\epsilon))}{\\frac{\\pi}{2}(1-\\epsilon)}\\right)^2 = \\left(\\frac{\\cos(\\pi\\epsilon/2)}{\\pi(1-\\epsilon)/2}\\right)^2$.\n3.  $\\hat{\\Delta}(\\boldsymbol{k})$: With $k_y=k_z=0$, the sum reduces to the $x$-component.\n    $\\hat{\\Delta}(\\boldsymbol{k}) = \\frac{2}{\\Delta x^2}(1-\\cos(k_x \\Delta x))$.\n    The argument is $k_x \\Delta x = \\pi(1-\\epsilon)$. So $\\cos(\\pi(1-\\epsilon)) = -\\cos(\\pi\\epsilon)$.\n    $\\hat{\\Delta}(\\boldsymbol{k}) = \\frac{2}{\\Delta x^2}(1+\\cos(\\pi\\epsilon))$.\n\nSubstituting these into the bias expression $b(\\epsilon) = \\frac{k^2 [\\hat{W}(\\boldsymbol{k})]^2}{\\hat{\\Delta}(\\boldsymbol{k})} - 1$:\n$$\nb(\\epsilon)+1 = \\frac{\\frac{\\pi^2}{\\Delta x^2}(1-\\epsilon)^2 \\left[\\left(\\frac{\\cos(\\pi\\epsilon/2)}{\\pi(1-\\epsilon)/2}\\right)^2\\right]^2}{\\frac{2}{\\Delta x^2}(1+\\cos(\\pi\\epsilon))} = \\frac{\\pi^2(1-\\epsilon)^2}{\\frac{2}{\\Delta x^2}(1+\\cos(\\pi\\epsilon))} \\frac{\\cos^4(\\pi\\epsilon/2)}{(\\pi/2)^4(1-\\epsilon)^4} \\Delta x^2\n$$\n$$\nb(\\epsilon)+1 = \\frac{\\pi^2 \\cos^4(\\pi\\epsilon/2)}{2(1+\\cos(\\pi\\epsilon))} \\frac{16}{\\pi^4(1-\\epsilon)^2} = \\frac{8}{\\pi^2} \\frac{\\cos^4(\\pi\\epsilon/2)}{(1-\\epsilon)^2(1+\\cos(\\pi\\epsilon))}\n$$\nThis is the exact expression. The problem asks to quantify the bias for $\\epsilon \\ll 1$, which suggests a Taylor expansion. Let $F(\\epsilon) = b(\\epsilon)+1$.\n$F(\\epsilon) \\approx F(0) + F'(0)\\epsilon$.\nAt $\\epsilon=0$:\n$F(0) = \\frac{8}{\\pi^2} \\frac{\\cos^4(0)}{(1-0)^2(1+\\cos(0))} = \\frac{8}{\\pi^2} \\frac{1}{1 \\cdot (1+1)} = \\frac{4}{\\pi^2}$.\nTo find the derivative $F'(0)$, we use the quotient rule $F' = (N'D-ND')/D^2$, with $N(\\epsilon)=\\frac{8}{\\pi^2}\\cos^4(\\pi\\epsilon/2)$ and $D(\\epsilon) = (1-\\epsilon)^2(1+\\cos(\\pi\\epsilon))$.\n$N'( \\epsilon) = \\frac{8}{\\pi^2} \\cdot 4\\cos^3(\\frac{\\pi\\epsilon}{2}) \\cdot (-\\sin(\\frac{\\pi\\epsilon}{2})) \\cdot \\frac{\\pi}{2}$. At $\\epsilon=0$, $N'(0)=0$.\n$D'(\\epsilon) = -2(1-\\epsilon)(1+\\cos(\\pi\\epsilon)) + (1-\\epsilon)^2(-\\pi\\sin(\\pi\\epsilon))$. At $\\epsilon=0$, $D'(0) = -2(1)(1+1)+0 = -4$.\n$F'(0) = \\frac{N'(0)D(0) - N(0)D'(0)}{[D(0)]^2} = \\frac{0 \\cdot 2 - (4/\\pi^2 \\cdot 2)(-4)}{2^2} = \\frac{(8/\\pi^2)(4)}{4} = \\frac{8}{\\pi^2}$.\nThus, the first-order Taylor expansion of $F(\\epsilon)$ is:\n$$\nb(\\epsilon)+1 \\approx \\frac{4}{\\pi^2} + \\frac{8}{\\pi^2}\\epsilon\n$$\nSo the residual fractional amplitude bias is:\n$$\nb(\\epsilon) \\approx \\left(\\frac{4}{\\pi^2} - 1\\right) + \\frac{8}{\\pi^2}\\epsilon\n$$", "answer": "$$\n\\boxed{\\begin{pmatrix} \\prod_{i \\in \\{x,y,z\\}} \\left(\\frac{k_i \\Delta x}{2 \\sin(k_i \\Delta x / 2)}\\right)^{4} & \\left(\\frac{4}{\\pi^2} - 1\\right) + \\frac{8}{\\pi^2}\\epsilon \\end{pmatrix}}\n$$", "id": "3475913"}, {"introduction": "A key to the efficiency of any hybrid algorithm is balancing the workload and accuracy between its different components. In this exercise, you will explore how to optimally tune a Tree-PM code by linking the accuracy of the tree calculation to the force splitting scale, $r_s$ [@problem_id:3475856]. By deriving an optimal tree opening angle $\\theta$ that matches the tree's truncation error with the residual error from the PM part, you will practice the crucial concept of error-balancing that underpins modern high-performance simulation codes.", "problem": "Consider a hybrid Tree-PM method in numerical cosmology that splits the Newtonian gravitational potential into a long-range component solved on a Particle-Mesh (PM) grid and a short-range component computed by a tree algorithm. The long-range/short-range split is implemented via a Gaussian filter in Fourier space with characteristic splitting scale $r_{s}$, such that the short-range real-space potential for a point mass $m$ is the Newtonian potential weighted by the complementary error function $\\operatorname{erfc}$, i.e., the short-range potential fraction at separation $r$ is $\\operatorname{erfc}\\!\\left(r/(2 r_{s})\\right)$. The tree employs the standard opening criterion $s/d \\le \\theta$, where $s$ is the size of a source cell, $d$ is the distance from the target point to the cell’s center of mass, and $\\theta$ is a dimensionless opening parameter.\n\nAssume the tree potential is constructed by truncating the multipole expansion at the monopole, so the leading neglected term is the quadrupole. Let the quadrupole contribution to the potential error scale as $E_{M_{2}}(d) \\sim G |M_{2}|/d^3$, where $G$ is the gravitational constant and $M_{2}$ is a scalar measure of the quadrupole moment amplitude of the cell (for example, a spectral norm applied to the traceless quadrupole tensor). For a conservative, geometry-independent bound, adopt $|M_{2}| \\le M s^2$, where $M$ is the total mass of the cell. Use the Newtonian monopole potential magnitude $|\\Phi_{M}(d)| \\sim G M/d$ as the normalization for a fractional potential error.\n\nDefine the target fractional error $\\epsilon_{\\rm target}$ by matching the tree’s quadrupole truncation error at the splitting scale to the PM residual amplitude at $r=r_{s}$ in the potential, i.e., set $\\epsilon_{\\rm target} = \\operatorname{erfc}\\!\\left(\\frac{1}{2}\\right)$. Impose the requirement that the fractional tree truncation error at the opening threshold be no larger than $\\epsilon_{\\rm target}$.\n\nUnder these assumptions and definitions, derive an analytic expression for the optimal opening parameter $\\theta_{\\rm opt}$ in terms of $\\epsilon_{\\rm target}$ and evaluate it numerically using the above Gaussian split. Express your final answer for $\\theta_{\\rm opt}$ as a dimensionless number. Round your answer to $4$ significant figures.", "solution": "The problem is first validated to ensure it is scientifically sound, well-posed, and objective.\n\n**Step 1: Extract Givens**\n- **Method**: Hybrid Tree-PM.\n- **Potential Split**: Long-range (PM) and short-range (Tree).\n- **Splitting Scale**: $r_{s}$.\n- **Short-Range Potential Fraction**: $\\operatorname{erfc}(r/(2 r_{s}))$ at separation $r$.\n- **Tree Opening Criterion**: $s/d \\le \\theta$, where $s$ is cell size, $d$ is distance to cell, and $\\theta$ is the opening parameter.\n- **Tree Approximation**: Monopole only, leading error is from the quadrupole.\n- **Quadrupole Error Scaling**: $E_{M_{2}}(d) \\sim G |M_{2}|/d^{3}$, with $M_2$ a measure of the quadrupole moment.\n- **Quadrupole Moment Bound**: $|M_{2}| \\le M s^{2}$, with $M$ being the cell mass.\n- **Error Normalization**: $|\\Phi_{M}(d)| \\sim G M/d$.\n- **Target Fractional Error**: $\\epsilon_{\\rm target} = \\operatorname{erfc}(\\frac{1}{2})$.\n- **Constraint**: The fractional tree truncation error at the opening threshold must be no larger than $\\epsilon_{\\rm target}$.\n- **Objective**: Derive an expression for the optimal opening parameter $\\theta_{\\rm opt}$ and evaluate it numerically, rounded to $4$ significant figures.\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is scientifically grounded. The hybrid Tree-PM method, the use of a Gaussian split characterized by the complementary error function $\\operatorname{erfc}$, the Barnes-Hut opening criterion ($s/d \\le \\theta$), and the multipole expansion for gravitational potentials are all standard, well-established concepts in computational cosmology and astrophysics. The error scalings and bounds provided ($E_{M_2} \\propto d^{-3}$, $|M_2| \\le Ms^2$) are standard approximations used for performance and error analysis of such algorithms.\n\nThe problem is well-posed. It provides all necessary definitions, scalings, and constraints to derive a unique expression for the opening parameter $\\theta_{\\rm opt}$. The language is objective and precise, with no ambiguities.\n\n**Step 3: Verdict and Action**\nThe problem is deemed **valid**. A solution will be derived.\n\nThe derivation proceeds as follows. First, we formulate the fractional tree truncation error. The error is dominated by the leading neglected term in the multipole expansion, which is the quadrupole term. The magnitude of this potential error is given to scale as:\n$$E_{M_{2}}(d) \\sim \\frac{G |M_{2}|}{d^{3}}$$\nwhere $G$ is the gravitational constant, $|M_{2}|$ is the magnitude of the quadrupole moment of the source cell, and $d$ is the distance to the target point.\n\nThis error is to be normalized by the magnitude of the monopole potential, which is given as:\n$$|\\Phi_{M}(d)| \\sim \\frac{G M}{d}$$\nwhere $M$ is the total mass of the cell.\n\nThe fractional tree truncation error, $\\epsilon_{\\rm tree}$, is the ratio of these two quantities:\n$$\\epsilon_{\\rm tree}(d) = \\frac{E_{M_{2}}(d)}{|\\Phi_{M}(d)|} \\sim \\frac{G |M_{2}|/d^{3}}{G M/d} = \\frac{|M_{2}|}{M d^{2}}$$\n\nTo obtain a conservative bound, we use the provided geometry-independent upper limit for the quadrupole moment: $|M_{2}| \\le M s^{2}$, where $s$ is the size of the source cell. Substituting this into the expression for the fractional error gives:\n$$\\epsilon_{\\rm tree}(d) \\le \\frac{M s^{2}}{M d^{2}} = \\left(\\frac{s}{d}\\right)^{2}$$\nThis expression bounds the fractional error in terms of the ratio $s/d$.\n\nThe tree algorithm employs the opening criterion $s/d \\le \\theta$. The algorithm treats a cell as a point mass (monopole) as long as this condition is met. The most permissive case, which represents the condition at the threshold of opening the cell, is when the ratio reaches its maximum allowed value, $s/d = \\theta$. At this opening threshold, the upper bound on the fractional truncation error is:\n$$\\epsilon_{\\rm tree, threshold} \\le \\theta^{2}$$\n\nThe problem requires that this a priori estimate of the truncation error be matched to the scale-dependent error introduced by the long-range/short-range force split. The target fractional error, $\\epsilon_{\\rm target}$, is defined by evaluating the PM residual (i.e., the short-range potential fraction) at the characteristic splitting scale $r=r_s$. The short-range potential fraction is given as $\\operatorname{erfc}(r/(2r_s))$. Thus,\n$$\\epsilon_{\\rm target} = \\operatorname{erfc}\\left(\\frac{r_s}{2 r_s}\\right) = \\operatorname{erfc}\\left(\\frac{1}{2}\\right)$$\n\nThe final constraint is that the fractional tree truncation error at the opening threshold should be no larger than this target error: $\\epsilon_{\\rm tree, threshold} \\le \\epsilon_{\\rm target}$. To find the optimal opening parameter, $\\theta_{\\rm opt}$, we balance the errors by setting the maximum possible tree error at the opening threshold equal to the target error. A smaller $\\theta$ would be computationally more expensive (more nodes opened) but more accurate than needed, while a larger $\\theta$ would violate the error-balancing principle. Therefore, the optimal choice is to set:\n$$\\theta_{\\rm opt}^2 = \\epsilon_{\\rm target}$$\n\nSolving for $\\theta_{\\rm opt}$, we get:\n$$\\theta_{\\rm opt} = \\sqrt{\\epsilon_{\\rm target}}$$\n\nSubstituting the expression for $\\epsilon_{\\rm target}$:\n$$\\theta_{\\rm opt} = \\sqrt{\\operatorname{erfc}\\left(\\frac{1}{2}\\right)}$$\n\nNow, we evaluate this expression numerically. The complementary error function is defined as $\\operatorname{erfc}(x) = 1 - \\operatorname{erf}(x)$, where $\\operatorname{erf}(x)$ is the error function.\nThe value of $\\operatorname{erfc}(1/2)$ is required.\n$$\\operatorname{erfc}(0.5) \\approx 0.479500122187$$\nTaking the square root gives the value for the optimal opening parameter:\n$$\\theta_{\\rm opt} = \\sqrt{0.479500122187} \\approx 0.69245947203$$\n\nThe problem asks for the answer to be rounded to $4$ significant figures.\nThe first four significant figures are $6$, $9$, $2$, $4$. The fifth digit is $5$, so we round up the fourth digit.\n$$\\theta_{\\rm opt} \\approx 0.6925$$\nThis is the final numerical value for the optimal opening parameter under the given assumptions.", "answer": "$$\\boxed{0.6925}$$", "id": "3475856"}]}