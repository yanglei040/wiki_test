{"hands_on_practices": [{"introduction": "The cornerstone of weak lensing mass mapping is the ability to reconstruct the projected mass density, or convergence $\\kappa$, from the observable shear field $\\gamma$. This practice guides you through the classic Kaiser-Squires inversion technique in an idealized but foundational scenario: the gravitational field of a Singular Isothermal Sphere. By performing this analytical derivation in Fourier space, you will gain a deep, first-principles understanding of the mathematical relationship between mass and the distortion it induces on light paths [@problem_id:3468573].", "problem": "Consider a statistically isotropic weak-lensing field generated by a Singular Isothermal Sphere (SIS), where the lens is centered at the origin of the angular coordinate plane with angular position vector $\\boldsymbol{\\theta} = (\\theta_{x}, \\theta_{y})$ and radial coordinate $\\theta = |\\boldsymbol{\\theta}| = \\sqrt{\\theta_{x}^{2} + \\theta_{y}^{2}}$. The observed complex shear is specified by its Cartesian components,\n$$\n\\gamma_{1}(\\theta_{x}, \\theta_{y}) = -\\frac{\\theta_{E}}{2}\\,\\frac{\\theta_{x}^{2} - \\theta_{y}^{2}}{\\left(\\theta_{x}^{2} + \\theta_{y}^{2}\\right)^{3/2}}, \n\\qquad\n\\gamma_{2}(\\theta_{x}, \\theta_{y}) = -\\frac{\\theta_{E}}{2}\\,\\frac{2\\,\\theta_{x}\\,\\theta_{y}}{\\left(\\theta_{x}^{2} + \\theta_{y}^{2}\\right)^{3/2}},\n$$\nwhere $\\theta_{E}  0$ is a constant angle parameter (the Einstein radius), and the shear is purely tangential around the origin. Assume the field is defined over the full plane and is free of curl-type (B-mode) systematics. Using the Fourier-space relation between shear and convergence derived from the lensing potential, invert the given shear to reconstruct the convergence $\\kappa(\\boldsymbol{\\theta})$ as a closed-form function of $\\theta$. Then compare the recovered $\\kappa(\\boldsymbol{\\theta})$ to the SIS expectation that it scales as $\\theta^{-1}$, and state the final expression for $\\kappa(\\theta)$ in simplest form. Express your final answer as a single analytical expression depending only on $\\theta$ and $\\theta_{E}$. Do not include any integrals in your final expression. No rounding is required, and no units should be included in the final expression.", "solution": "The problem requires the reconstruction of the convergence field $\\kappa(\\boldsymbol{\\theta})$ from the given shear components $\\gamma_1(\\boldsymbol{\\theta})$ and $\\gamma_2(\\boldsymbol{\\theta})$ for a Singular Isothermal Sphere (SIS) lens, using Fourier-space methods.\n\nFirst, we perform a validation of the problem statement.\n\n**Step 1: Extract Givens**\n- Lens model: Singular Isothermal Sphere (SIS) centered at the origin.\n- Angular position vector: $\\boldsymbol{\\theta} = (\\theta_{x}, \\theta_{y})$.\n- Radial coordinate: $\\theta = |\\boldsymbol{\\theta}| = \\sqrt{\\theta_{x}^{2} + \\theta_{y}^{2}}$.\n- Shear components:\n$$\n\\gamma_{1}(\\theta_{x}, \\theta_{y}) = -\\frac{\\theta_{E}}{2}\\,\\frac{\\theta_{x}^{2} - \\theta_{y}^{2}}{\\left(\\theta_{x}^{2} + \\theta_{y}^{2}\\right)^{3/2}}\n$$\n$$\n\\gamma_{2}(\\theta_{x}, \\theta_{y}) = -\\frac{\\theta_{E}}{2}\\,\\frac{2\\,\\theta_{x}\\,\\theta_{y}}{\\left(\\theta_{x}^{2} + \\theta_{y}^{2}\\right)^{3/2}}\n$$\n- Constant parameter: $\\theta_{E}  0$ (Einstein radius).\n- Condition: The shear is purely tangential.\n- Condition: The field is free of curl-type (B-mode) systematics.\n- Task: Invert the shear to find the convergence $\\kappa(\\boldsymbol{\\theta})$ as a closed-form function of $\\theta$ using Fourier-space relations. Compare the result with the expected $\\theta^{-1}$ scaling.\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is well-posed and scientifically grounded. The given shear components are the correct expressions for a weak lensing field generated by an SIS potential, $\\psi(\\boldsymbol{\\theta}) = \\theta_E |\\boldsymbol{\\theta}|$. The relations $\\gamma_1 = \\frac{1}{2}(\\psi_{xx} - \\psi_{yy})$ and $\\gamma_2 = \\psi_{xy}$ (where subscripts on $\\psi$ denote partial derivatives with respect to $\\theta_x$ and $\\theta_y$) correctly yield the provided expressions. The condition of no B-modes is necessary for a unique inversion from shear to convergence and is consistent with the shear being derived from a scalar potential. The problem is a standard exercise in weak lensing theory. Therefore, the problem is valid.\n\n**Step 3: Verdict and Action**\nThe problem is valid. We proceed to the solution.\n\nThe fundamental quantities of weak lensing, the convergence $\\kappa$ and the complex shear $\\gamma = \\gamma_1 + i\\gamma_2$, are related to the second derivatives of the lensing potential $\\psi(\\boldsymbol{\\theta})$. These relationships are most conveniently expressed in Fourier space. Let $\\hat{f}(\\boldsymbol{\\ell})$ denote the two-dimensional Fourier transform of a function $f(\\boldsymbol{\\theta})$, where $\\boldsymbol{\\ell}$ is the Fourier conjugate variable to $\\boldsymbol{\\theta}$. The relations are:\n$$\n\\hat{\\kappa}(\\boldsymbol{\\ell}) = \\frac{1}{2}(\\ell_x^2 + \\ell_y^2) \\hat{\\psi}(\\boldsymbol{\\ell}) = \\frac{1}{2}\\ell^2 \\hat{\\psi}(\\boldsymbol{\\ell})\n$$\n$$\n\\hat{\\gamma}_1(\\boldsymbol{\\ell}) = \\frac{1}{2}(\\ell_x^2 - \\ell_y^2) \\hat{\\psi}(\\boldsymbol{\\ell})\n$$\n$$\n\\hat{\\gamma}_2(\\boldsymbol{\\ell}) = \\ell_x \\ell_y \\hat{\\psi}(\\boldsymbol{\\ell})\n$$\nwhere $\\ell = |\\boldsymbol{\\ell}|$. The Fourier transform of the complex shear is $\\hat{\\gamma}(\\boldsymbol{\\ell}) = \\hat{\\gamma}_1(\\boldsymbol{\\ell}) + i\\hat{\\gamma}_2(\\boldsymbol{\\ell})$. Combining the expressions for $\\hat{\\gamma}_1$ and $\\hat{\\gamma}_2$:\n$$\n\\hat{\\gamma}(\\boldsymbol{\\ell}) = \\frac{1}{2}(\\ell_x^2 - \\ell_y^2 + 2i\\ell_x\\ell_y) \\hat{\\psi}(\\boldsymbol{\\ell}) = \\frac{1}{2}(\\ell_x + i\\ell_y)^2 \\hat{\\psi}(\\boldsymbol{\\ell})\n$$\nExpressing the Fourier-space vector $\\boldsymbol{\\ell}$ in polar coordinates, $\\ell_x+i\\ell_y = \\ell e^{i\\phi_\\ell}$, where $\\phi_\\ell$ is the polar angle of $\\boldsymbol{\\ell}$, we have:\n$$\n\\hat{\\gamma}(\\boldsymbol{\\ell}) = \\frac{1}{2}\\ell^2 e^{i2\\phi_\\ell} \\hat{\\psi}(\\boldsymbol{\\ell})\n$$\nBy comparing this with the expression for $\\hat{\\kappa}(\\boldsymbol{\\ell})$, we arrive at the pivotal Kaiser-Squires relation:\n$$\n\\hat{\\gamma}(\\boldsymbol{\\ell}) = \\hat{\\kappa}(\\boldsymbol{\\ell}) e^{i2\\phi_\\ell}\n$$\nThis relation allows for the reconstruction of the convergence from the shear. Inverting for $\\hat{\\kappa}(\\boldsymbol{\\ell})$ gives:\n$$\n\\hat{\\kappa}(\\boldsymbol{\\ell}) = \\hat{\\gamma}(\\boldsymbol{\\ell}) e^{-i2\\phi_\\ell}\n$$\nThe problem now reduces to computing the Fourier transform of the given shear field and then applying this inversion formula.\n\nFirst, let's express the given shear field in complex form.\n$$\n\\gamma(\\boldsymbol{\\theta}) = \\gamma_1 + i\\gamma_2 = -\\frac{\\theta_E}{2} \\frac{(\\theta_x^2 - \\theta_y^2) + i(2\\theta_x\\theta_y)}{(\\theta_x^2+\\theta_y^2)^{3/2}}\n$$\nThe numerator is $(\\theta_x + i\\theta_y)^2$. In polar coordinates for $\\boldsymbol{\\theta}$, we have $\\theta_x+i\\theta_y = \\theta e^{i\\phi}$. The denominator is simply $\\theta^3$.\n$$\n\\gamma(\\boldsymbol{\\theta}) = -\\frac{\\theta_E}{2} \\frac{(\\theta e^{i\\phi})^2}{\\theta^3} = -\\frac{\\theta_E}{2\\theta} e^{i2\\phi}\n$$\nThis form shows the characteristic quadrupolar ($e^{i2\\phi}$) nature of a shear field and its $\\theta^{-1}$ dependence for an SIS.\n\nNext, we calculate the 2D Fourier transform of $\\gamma(\\boldsymbol{\\theta})$:\n$$\n\\hat{\\gamma}(\\boldsymbol{\\ell}) = \\int d^2\\theta \\, \\gamma(\\boldsymbol{\\theta}) e^{-i\\boldsymbol{\\ell} \\cdot \\boldsymbol{\\theta}} = \\int d^2\\theta \\, \\left( -\\frac{\\theta_E}{2\\theta} e^{i2\\phi} \\right) e^{-i\\boldsymbol{\\ell} \\cdot \\boldsymbol{\\theta}}\n$$\nThe Fourier transform of a function of the form $f(\\theta, \\phi) = f_R(\\theta) e^{im\\phi}$ is given by:\n$$\n\\hat{f}(\\ell, \\phi_\\ell) = 2\\pi (-i)^m e^{im\\phi_\\ell} \\int_0^\\infty \\theta \\, f_R(\\theta) J_m(\\ell \\theta) d\\theta\n$$\nwhere $J_m$ is the Bessel function of the first kind of order $m$. For our shear field, we have $m=2$ and $f_R(\\theta) = - \\frac{\\theta_E}{2\\theta}$.\n$$\n\\hat{\\gamma}(\\boldsymbol{\\ell}) = 2\\pi (-i)^2 e^{i2\\phi_\\ell} \\int_0^\\infty \\theta \\left( -\\frac{\\theta_E}{2\\theta} \\right) J_2(\\ell \\theta) d\\theta\n$$\n$$\n\\hat{\\gamma}(\\boldsymbol{\\ell}) = -2\\pi e^{i2\\phi_\\ell} \\left( -\\frac{\\theta_E}{2} \\right) \\int_0^\\infty J_2(\\ell \\theta) d\\theta = \\pi \\theta_E e^{i2\\phi_\\ell} \\int_0^\\infty J_2(\\ell \\theta) d\\theta\n$$\nWe use the standard integral identity $\\int_0^\\infty J_\\nu(ax) dx = \\frac{1}{a}$, which is valid for $\\Re(\\nu)  -1$. For our case, $\\nu=2$ and $a=\\ell$, so the condition is satisfied.\n$$\n\\int_0^\\infty J_2(\\ell \\theta) d\\theta = \\frac{1}{\\ell}\n$$\nSubstituting this result into the expression for $\\hat{\\gamma}(\\boldsymbol{\\ell})$:\n$$\n\\hat{\\gamma}(\\boldsymbol{\\ell}) = \\frac{\\pi \\theta_E}{\\ell} e^{i2\\phi_\\ell}\n$$\nNow we apply the inversion formula $\\hat{\\kappa}(\\boldsymbol{\\ell}) = \\hat{\\gamma}(\\boldsymbol{\\ell}) e^{-i2\\phi_\\ell}$:\n$$\n\\hat{\\kappa}(\\boldsymbol{\\ell}) = \\left(\\frac{\\pi \\theta_E}{\\ell} e^{i2\\phi_\\ell}\\right) e^{-i2\\phi_\\ell} = \\frac{\\pi \\theta_E}{\\ell}\n$$\nThis is the Fourier transform of the convergence field. It is radially symmetric, depending only on $\\ell = |\\boldsymbol{\\ell}|$, as expected for a circularly symmetric lens.\n\nTo find $\\kappa(\\boldsymbol{\\theta})$, we take the inverse Fourier transform of $\\hat{\\kappa}(\\boldsymbol{\\ell})$:\n$$\n\\kappa(\\boldsymbol{\\theta}) = \\int \\frac{d^2\\ell}{(2\\pi)^2} \\hat{\\kappa}(\\ell) e^{i\\boldsymbol{\\ell} \\cdot \\boldsymbol{\\theta}}\n$$\nSince $\\hat{\\kappa}(\\ell)$ is radially symmetric, the resulting $\\kappa(\\boldsymbol{\\theta})$ will also be radially symmetric, i.e., $\\kappa(\\boldsymbol{\\theta})=\\kappa(\\theta)$. The integral is a 0-th order Hankel transform.\n$$\n\\kappa(\\theta) = \\frac{1}{(2\\pi)^2} \\int_0^\\infty \\ell d\\ell \\int_0^{2\\pi} d\\phi_\\ell \\left(\\frac{\\pi\\theta_E}{\\ell}\\right) e^{i\\ell\\theta \\cos(\\phi_\\ell)}\n$$\nWe have aligned $\\boldsymbol{\\theta}$ with the $x$-axis without loss of generality.\n$$\n\\kappa(\\theta) = \\frac{\\pi\\theta_E}{4\\pi^2} \\int_0^\\infty d\\ell \\int_0^{2\\pi} d\\phi_\\ell e^{i\\ell\\theta \\cos(\\phi_\\ell)}\n$$\nThe integral over $\\phi_\\ell$ is an integral representation of the Bessel function $J_0$: $\\int_0^{2\\pi}e^{ix \\cos\\phi} d\\phi = 2\\pi J_0(x)$.\n$$\n\\kappa(\\theta) = \\frac{\\theta_E}{4\\pi} \\int_0^\\infty 2\\pi J_0(\\ell\\theta) d\\ell = \\frac{\\theta_E}{2} \\int_0^\\infty J_0(\\ell\\theta) d\\ell\n$$\nUsing the same integral identity as before, $\\int_0^\\infty J_0(ax) dx = \\frac{1}{a}$, with $a=\\theta$.\n$$\n\\int_0^\\infty J_0(\\ell\\theta) d\\ell = \\frac{1}{\\theta}\n$$\nTherefore, the reconstructed convergence is:\n$$\n\\kappa(\\theta) = \\frac{\\theta_E}{2} \\cdot \\frac{1}{\\theta} = \\frac{\\theta_E}{2\\theta}\n$$\nThis recovered convergence profile, $\\kappa(\\theta) = \\frac{\\theta_E}{2\\theta}$, scales as $\\theta^{-1}$, which is precisely the expected result for a Singular Isothermal Sphere. The entire derivation is self-consistent and confirms the well-known properties of the SIS model.\n\nThe final expression for the convergence $\\kappa(\\theta)$ is given in its simplest form.", "answer": "$$ \\boxed{ \\frac{\\theta_{E}}{2\\theta} } $$", "id": "3468573"}, {"introduction": "While the fundamental theory provides a direct path from shear to convergence, real-world observations are inevitably affected by noise. This exercise explores the practical challenge of constructing a map for a higher-order lensing effect, the first flexion $\\mathbf{F}$, which is particularly sensitive to noise from both intrinsic galaxy shapes and pixel-level detector effects. You will derive the expected noise level in a smoothed flexion map and compute the signal-to-noise ratio, providing a crucial lesson in survey design and the feasibility of measuring subtle cosmological signals [@problem_id:3468635].", "problem": "A weak gravitational lensing mass-mapping pipeline constructs fields of convergence, shear, and flexion from galaxy images. Let the first flexion field be defined as $ \\mathbf{F}(\\boldsymbol{\\theta}) = \\boldsymbol{\\nabla}\\kappa(\\boldsymbol{\\theta}) $, where $ \\kappa $ is the convergence and $ \\boldsymbol{\\theta} $ is the sky angle. Consider the following simplified, yet scientifically realistic, setup for constructing a smoothed map of the first flexion amplitude $ F(\\boldsymbol{\\theta}) $ from a catalog of galaxies with measured per-galaxy first flexion estimates.\n\nAssume:\n1. The per-galaxy flexion estimator is linear and unbiased. For galaxy $ j $ it satisfies $ \\hat{F}_{j} = F_{\\mathrm{true},j} + \\eta_{j} + \\epsilon_{j} $, where $ \\eta_{j} $ is an intrinsic morphology term with zero mean and variance $ \\sigma_{F,\\mathrm{int}}^{2} $, and $ \\epsilon_{j} $ is a measurement contribution induced by pixel noise with zero mean and variance $ \\sigma_{F,\\mathrm{pix}}^{2} $. The two contributions are independent across galaxies and mutually independent for each galaxy.\n2. The galaxies are distributed as a spatially uniform Poisson process with number density $ n_{g} $ and independent noise realizations. The map is constructed by kernel-weighted averaging with a Gaussian kernel of width $ R $,\n$$\nW_{R}(\\boldsymbol{\\theta}) = \\frac{1}{2\\pi R^{2}}\\exp\\!\\left(-\\frac{|\\boldsymbol{\\theta}|^{2}}{2R^{2}}\\right),\n$$\nnormalized so that $ \\int \\mathrm{d}^{2}\\boldsymbol{\\theta}\\, W_{R}(\\boldsymbol{\\theta}) = 1 $. The estimator of the smoothed flexion field at location $ \\boldsymbol{\\theta} $ is\n$$\n\\hat{F}_{R}(\\boldsymbol{\\theta}) = \\frac{\\sum_{j} W_{R}(\\boldsymbol{\\theta}-\\boldsymbol{\\theta}_{j})\\,\\hat{F}_{j}}{\\sum_{j} W_{R}(\\boldsymbol{\\theta}-\\boldsymbol{\\theta}_{j})}.\n$$\n3. Angles are expressed in arcseconds, and the Gaussian width is $ R = 30\\,\\mathrm{arcsec} $ (i.e., $ R = 0.5\\,\\mathrm{arcmin} $). The number density is $ n_{g} = 20\\,\\mathrm{arcmin}^{-2} $. The per-galaxy intrinsic morphology dispersion and pixel-noise-induced measurement dispersion are $ \\sigma_{F,\\mathrm{int}} = 0.05\\,\\mathrm{arcsec}^{-1} $ and $ \\sigma_{F,\\mathrm{pix}} = 0.03\\,\\mathrm{arcsec}^{-1} $, respectively.\n4. At this smoothing scale, the root-mean-square (RMS) of the cosmological first flexion signal is $ \\sigma_{F,\\mathrm{cos}} = 6.7\\times 10^{-4}\\,\\mathrm{arcsec}^{-1} $. Here RMS denotes root-mean-square. The sought signal-to-noise ratio (SNR) is defined as $ \\mathrm{SNR} = \\sigma_{F,\\mathrm{cos}} / \\sigma_{F,\\mathrm{map}} $, where $ \\sigma_{F,\\mathrm{map}} $ is the RMS noise of the smoothed map estimator arising from $ \\eta_{j} $ and $ \\epsilon_{j} $ only.\n\nStarting from first principles of linear error propagation for unbiased estimators, properties of Poisson sampling, and kernel smoothing of independent noisy samples, derive an analytic expression for the variance of the smoothed flexion map $ \\mathrm{Var}[\\hat{F}_{R}(\\boldsymbol{\\theta})] $ in terms of $ \\sigma_{F,\\mathrm{int}}^{2} $, $ \\sigma_{F,\\mathrm{pix}}^{2} $, $ n_{g} $, and $ W_{R} $. Evaluate this expression for the Gaussian kernel and the numerical values above, and compute the resulting SNR. Round your final SNR to two significant figures. Express the SNR as a dimensionless number.", "solution": "We begin by recalling the definitions of the relevant lensing fields in terms of the lensing potential $ \\psi(\\boldsymbol{\\theta}) $: the convergence is $ \\kappa = \\tfrac{1}{2}\\nabla^{2}\\psi $, the shear is a spin-$2$ combination of second derivatives of $ \\psi $, and the first flexion is $ \\mathbf{F} = \\boldsymbol{\\nabla}\\kappa $. The task is to quantify the noise in a smoothed map of the first flexion amplitude built from per-galaxy estimators with intrinsic and pixel-noise contributions, and then to compare that noise to a given cosmological RMS signal.\n\nFundamental base: linear error propagation and properties of averages of independent random variables. For an unbiased linear estimator that averages independent samples with weights, the variance of the weighted average equals the weighted sum of per-sample variances, normalized by the square of the sum of weights. For a galaxy at $ \\boldsymbol{\\theta}_{j} $, its estimator decomposes as $ \\hat{F}_{j} = F_{\\mathrm{true},j} + \\nu_{j} $, where $ \\nu_{j} = \\eta_{j} + \\epsilon_{j} $ has zero mean and variance\n$$\n\\mathrm{Var}[\\nu_{j}] = \\sigma_{F,\\mathrm{int}}^{2} + \\sigma_{F,\\mathrm{pix}}^{2} \\equiv \\sigma_{F,\\mathrm{gal}}^{2}.\n$$\nHere $ \\sigma_{F,\\mathrm{gal}}^{2} $ is the total per-galaxy variance due to intrinsic morphology and pixel noise, with the two sources assumed independent and uncorrelated across galaxies.\n\nThe smoothed map estimator with a normalized kernel is\n$$\n\\hat{F}_{R}(\\boldsymbol{\\theta}) = \\frac{\\sum_{j} W_{R}(\\boldsymbol{\\theta}-\\boldsymbol{\\theta}_{j})\\,\\hat{F}_{j}}{\\sum_{j} W_{R}(\\boldsymbol{\\theta}-\\boldsymbol{\\theta}_{j})}.\n$$\nUnder the assumptions of spatially uniform Poisson sampling with density $ n_{g} $ and negligible fluctuations in the denominator compared to its mean, we approximate the denominator in the large-sample limit by its expectation $ \\mathbb{E}\\!\\left[\\sum_{j} W_{R}(\\boldsymbol{\\theta}-\\boldsymbol{\\theta}_{j})\\right] = n_{g}\\int \\mathrm{d}^{2}\\boldsymbol{\\theta}'\\,W_{R}(\\boldsymbol{\\theta}') = n_{g} $, because the kernel is normalized to unit integral. This is the standard continuous approximation in weak lensing mass-mapping.\n\nWith this approximation and focusing on the noise of the map (i.e., treating the true flexion field as fixed and noise-free for the purpose of evaluating the noise variance), the map noise is a weighted average of independent zero-mean $ \\nu_{j} $ with effective weights $ W_{R}(\\boldsymbol{\\theta}-\\boldsymbol{\\theta}_{j})/n_{g} $. Therefore, by the variance of a weighted sum of independent, identically distributed variables,\n$$\n\\mathrm{Var}[\\hat{F}_{R}(\\boldsymbol{\\theta})] \\approx \\frac{1}{n_{g}^{2}}\\,\\mathbb{E}\\!\\left[\\sum_{j} W_{R}(\\boldsymbol{\\theta}-\\boldsymbol{\\theta}_{j})^{2}\\,\\mathrm{Var}[\\nu_{j}]\\right] = \\frac{\\sigma_{F,\\mathrm{gal}}^{2}}{n_{g}^{2}}\\,\\mathbb{E}\\!\\left[\\sum_{j} W_{R}(\\boldsymbol{\\theta}-\\boldsymbol{\\theta}_{j})^{2}\\right].\n$$\nFor a spatial Poisson process with density $ n_{g} $, the expectation of the sum over galaxies of any function $ f(\\boldsymbol{\\theta}-\\boldsymbol{\\theta}_{j}) $ equals $ n_{g}\\int \\mathrm{d}^{2}\\boldsymbol{\\theta}'\\, f(\\boldsymbol{\\theta}') $. Thus,\n$$\n\\mathbb{E}\\!\\left[\\sum_{j} W_{R}(\\boldsymbol{\\theta}-\\boldsymbol{\\theta}_{j})^{2}\\right] = n_{g} \\int \\mathrm{d}^{2}\\boldsymbol{\\theta}'\\, W_{R}(\\boldsymbol{\\theta}')^{2}.\n$$\nCombining the factors,\n$$\n\\mathrm{Var}[\\hat{F}_{R}(\\boldsymbol{\\theta})] \\approx \\frac{\\sigma_{F,\\mathrm{gal}}^{2}}{n_{g}} \\int \\mathrm{d}^{2}\\boldsymbol{\\theta}'\\, W_{R}(\\boldsymbol{\\theta}')^{2}.\n$$\nThis is the desired general expression in terms of the per-galaxy variance, number density, and the kernel. It embodies the basic fact that the variance of a smoothed map from independent samples decreases inversely with the effective number of sources under the smoothing kernel, quantified by $ n_{g} $ and the kernelâ€™s self-convolution area $ \\int W_{R}^{2} $.\n\nFor a Gaussian kernel\n$$\nW_{R}(\\boldsymbol{\\theta}) = \\frac{1}{2\\pi R^{2}}\\exp\\!\\left(-\\frac{|\\boldsymbol{\\theta}|^{2}}{2R^{2}}\\right),\n$$\nwe compute the self-overlap integral,\n$$\n\\int \\mathrm{d}^{2}\\boldsymbol{\\theta}\\, W_{R}(\\boldsymbol{\\theta})^{2} = \\int \\mathrm{d}^{2}\\boldsymbol{\\theta}\\, \\frac{1}{(2\\pi R^{2})^{2}}\\exp\\!\\left(-\\frac{|\\boldsymbol{\\theta}|^{2}}{R^{2}}\\right) = \\frac{1}{4\\pi R^{2}},\n$$\nwhere the last equality follows from standard Gaussian integrals in two dimensions. Therefore,\n$$\n\\mathrm{Var}[\\hat{F}_{R}(\\boldsymbol{\\theta})] = \\frac{\\sigma_{F,\\mathrm{gal}}^{2}}{4\\pi R^{2} n_{g}}, \\quad \\text{and} \\quad \\sigma_{F,\\mathrm{map}} \\equiv \\sqrt{\\mathrm{Var}[\\hat{F}_{R}]} = \\sqrt{\\frac{\\sigma_{F,\\mathrm{gal}}^{2}}{4\\pi R^{2} n_{g}}}.\n$$\n\nWe now evaluate numerically with the provided values, expressing all angles in arcseconds. First, the total per-galaxy variance is\n$$\n\\sigma_{F,\\mathrm{gal}}^{2} = \\sigma_{F,\\mathrm{int}}^{2} + \\sigma_{F,\\mathrm{pix}}^{2} = (0.05)^{2} + (0.03)^{2} = 0.0025 + 0.0009 = 0.0034 \\quad \\text{(in } \\mathrm{arcsec}^{-2}\\text{)}.\n$$\nThe Gaussian width is $ R = 30\\,\\mathrm{arcsec} $, and the number density $ n_{g} = 20\\,\\mathrm{arcmin}^{-2} $ must be converted to $ \\mathrm{arcsec}^{-2} $:\n$$\n1\\,\\mathrm{arcmin}^{2} = (60\\,\\mathrm{arcsec})^{2} = 3600\\,\\mathrm{arcsec}^{2}, \\quad n_{g} = \\frac{20}{3600}\\,\\mathrm{arcsec}^{-2} = \\frac{1}{180}\\,\\mathrm{arcsec}^{-2}.\n$$\nHence,\n$$\n\\mathrm{Var}[\\hat{F}_{R}] = \\frac{0.0034}{4\\pi (30)^{2} \\cdot \\frac{1}{180}} = \\frac{0.0034}{4\\pi \\cdot 900} \\cdot 180 = \\frac{0.0034}{20\\pi}.\n$$\nTherefore,\n$$\n\\sigma_{F,\\mathrm{map}} = \\sqrt{\\frac{0.0034}{20\\pi}}.\n$$\nThe signal-to-noise ratio is defined as\n$$\n\\mathrm{SNR} = \\frac{\\sigma_{F,\\mathrm{cos}}}{\\sigma_{F,\\mathrm{map}}} = \\frac{6.7\\times 10^{-4}}{\\sqrt{\\frac{0.0034}{20\\pi}}}.\n$$\nEvaluating numerically,\n$$\n\\frac{0.0034}{20\\pi} \\approx \\frac{0.0034}{62.831853\\ldots} \\approx 5.4110\\times 10^{-5}, \\quad \\sigma_{F,\\mathrm{map}} \\approx \\sqrt{5.4110\\times 10^{-5}} \\approx 7.3569\\times 10^{-3},\n$$\nso\n$$\n\\mathrm{SNR} \\approx \\frac{6.7\\times 10^{-4}}{7.3569\\times 10^{-3}} \\approx 9.1048\\times 10^{-2}.\n$$\n\nRounded to two significant figures, the signal-to-noise ratio is $ 9.1\\times 10^{-2} $. This quantitative result encapsulates the demonstration: even with optimistic number density and smoothing, the noise in the flexion map arising from intrinsic morphology dispersion and pixel noise greatly exceeds the cosmological flexion RMS at current survey depths, yielding a signal-to-noise ratio well below unity and thus a noise-dominated map.", "answer": "$$\\boxed{9.1\\times 10^{-2}}$$", "id": "3468635"}, {"introduction": "Beyond random noise, systematic errors originating from the survey strategy itself pose a major hurdle to accurate mass mapping. This capstone practice tackles one of the most significant systematics: the leakage of E-mode power into B-modes due to incomplete sky coverage and sharp mask edges. You will implement a full numerical pipeline to first derive the E/B reconstruction formulae, then demonstrate how a mask induces spurious B-modes, and finally implement and test an apodization technique to mitigate this effect, gaining essential hands-on experience in robust data analysis [@problem_id:3468591].", "problem": "Consider weak gravitational lensing on a flat sky domain, modeled on a two-dimensional periodic square grid. Start from the gravitational lensing potential $\\,\\psi(\\boldsymbol{\\theta})\\,$, the convergence $\\,\\kappa(\\boldsymbol{\\theta})\\,$, and the shear components $\\,\\gamma_1(\\boldsymbol{\\theta}),\\gamma_2(\\boldsymbol{\\theta})\\,$ defined by linear differential operators of $\\,\\psi\\,$. Assume a controlled mock mass distribution that yields a purely scalar potential $\\,\\psi\\,$ and hence a purely gradient-like (\"electric\") shear field with no curl-like (\"magnetic\") component. An observation is made through an arbitrary binary mask $\\,W_0(\\boldsymbol{\\theta})\\in\\{0,1\\}\\,$ that removes data in selected regions; the observed shear is then $\\,\\gamma^{\\mathrm{obs}}(\\boldsymbol{\\theta})=W(\\boldsymbol{\\theta})\\,\\gamma(\\boldsymbol{\\theta})\\,$ where $\\,W(\\boldsymbol{\\theta})\\,$ may include a smooth apodization that transitions from $\\,0\\,$ to $\\,1\\,$ near mask boundaries.\n\nYour tasks are:\n- Derive the linear inversion in Fourier space that maps the observed shear field to the \"electric-mode\" convergence $\\,\\kappa_E(\\boldsymbol{\\theta})\\,$ and the \"magnetic-mode\" convergence $\\,\\kappa_B(\\boldsymbol{\\theta})\\,$ on the flat sky. The derivation should start only from the fundamental relations between $\\,\\psi\\,$, $\\,\\kappa\\,$, and $\\,\\gamma\\,$, without assuming any pre-known inversion formula.\n- Propose an apodization function $\\,A(d)\\,$ that depends only on the distance $\\,d\\,$ to the nearest mask boundary and yields a smooth transition of $\\,W(\\boldsymbol{\\theta})\\,$ inside the masked region to reduce $\\,E/B\\,$ mixing. Justify the choice of $\\,A(d)\\,$ based on minimizing sharp-edge effects.\n- Implement a numerical experiment on a square grid to evaluate leakage, defined as the dimensionless ratio\n$$L \\equiv \\sqrt{\\frac{\\sum_{i} W_i \\,\\kappa_B(\\boldsymbol{\\theta}_i)^2}{\\sum_{i} W_i \\,\\kappa_E(\\boldsymbol{\\theta}_i)^2}},$$\nwhere the sum runs over pixels with $\\,W_i0\\,$, and demonstrate how apodization reduces $\\,L\\,$ compared to a hard (non-apodized) mask.\n\nUse the following controlled mock and grid configuration:\n- Square grid of linear size $\\,N=128\\,$ pixels with unit pixel spacing. Treat the domain as periodic for Fourier transforms. All fields are dimensionless; no physical units are required.\n- Convergence $\\,\\kappa(\\boldsymbol{\\theta})\\,$ is a superposition of two isotropic Gaussian clumps centered at positions $\\,\\boldsymbol{\\theta}_1=(N/4,N/4)\\,$ and $\\,\\boldsymbol{\\theta}_2=(3N/4,3N/4)\\,$ with amplitudes $\\,A_1=1.0\\,$ and $\\,A_2=0.8\\,$, and standard deviations $\\,\\sigma_1=5\\,$ pixels and $\\,\\sigma_2=8\\,$ pixels, respectively. Subtract the mean of $\\,\\kappa\\,$ so that the zero-mode is zero.\n- Compute $\\,\\psi(\\boldsymbol{\\theta})\\,$, $\\,\\gamma_1(\\boldsymbol{\\theta})\\,$, and $\\,\\gamma_2(\\boldsymbol{\\theta})\\,$ from $\\,\\kappa(\\boldsymbol{\\theta})\\,$ using Fourier derivatives on the periodic grid.\n\nDefine masks and apodization widths for the test suite as follows:\n1. Case 1 (baseline): No mask, i.e., $\\,W_0(\\boldsymbol{\\theta})=1\\,$ everywhere; apodization width $\\,w=0\\,$ pixels.\n2. Case 2 (hard circular hole): $\\,W_0(\\boldsymbol{\\theta})=0\\,$ inside a circle of radius $\\,r=12\\,$ pixels centered at $\\,\\boldsymbol{\\theta}=(N/2,N/2)\\,$, and $\\,W_0(\\boldsymbol{\\theta})=1\\,$ elsewhere; apodization width $\\,w=0\\,$ pixels.\n3. Case 3 (apodized circular hole): Same $\\,W_0\\,$ as Case 2 but with apodization width $\\,w=6\\,$ pixels.\n4. Case 4 (apodized vertical stripe hole): $\\,W_0(\\boldsymbol{\\theta})=0\\,$ for the central vertical stripe where $\\,|x-N/2|\\leq s\\,$ with $\\,s=6\\,$ pixels, and $\\,W_0(\\boldsymbol{\\theta})=1\\,$ elsewhere; apodization width $\\,w=6\\,$ pixels.\n\nFor apodization, construct $\\,W(\\boldsymbol{\\theta})\\,$ from $\\,W_0(\\boldsymbol{\\theta})\\,$ by smoothly tapering from $\\,0\\,$ to $\\,1\\,$ inside the unmasked region across a boundary layer of width $\\,w\\,$ pixels using the same $\\,A(d)\\,$ for all mask geometries. If $\\,w=0\\,$, set $\\,W(\\boldsymbol{\\theta})=W_0(\\boldsymbol{\\theta})\\,$.\n\nYour program must:\n- Implement the derivation-based inversion from observed shear to $\\,\\kappa_E\\,$ and $\\,\\kappa_B\\,$ on the flat sky.\n- Implement the proposed apodization $\\,A(d)\\,$ and apply it to each mask $\\,W_0\\,$ to produce $\\,W\\,$.\n- Compute the leakage metric $\\,L\\,$ for each case on the specified mock, and round each result to six decimal places.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,result3,result4]\"). Each entry must be the float $\\,L\\,$ for the corresponding case in the order given above, rounded to six decimal places.\n\nThe test suite is thus the ordered list of parameter triplets $\\,(\\text{mask type},\\,\\text{mask parameter},\\,w)\\,$:\n- Case 1: $\\,(\\text{none},\\,0,\\,0)\\,$\n- Case 2: $\\,(\\text{circular},\\,r=12,\\,0)\\,$\n- Case 3: $\\,(\\text{circular},\\,r=12,\\,6)\\,$\n- Case 4: $\\,(\\text{stripe},\\,s=6,\\,6)\\,$", "solution": "The problem requires the derivation of the weak lensing E/B mode inversion for masked data, the proposal of an apodization scheme, and a numerical implementation to quantify E-B mode leakage. The problem is well-defined, scientifically grounded in the principles of cosmology and data analysis, and all necessary parameters for a numerical solution are provided.\n\n### 1. Derivation of the E/B Mode Inversion\n\nThe analysis begins from the fundamental relations connecting the gravitational lensing potential $\\psi(\\boldsymbol{\\theta})$, the convergence $\\kappa(\\boldsymbol{\\theta})$, and the two components of the shear field, $\\gamma_1(\\boldsymbol{\\theta})$ and $\\gamma_2(\\boldsymbol{\\theta})$, on a flat sky. These are given by second derivatives of the potential:\n$$ \\kappa = \\frac{1}{2}(\\partial_1^2 + \\partial_2^2)\\psi = \\frac{1}{2}\\nabla^2\\psi $$\n$$ \\gamma_1 = \\frac{1}{2}(\\partial_1^2 - \\partial_2^2)\\psi $$\n$$ \\gamma_2 = \\partial_1 \\partial_2 \\psi $$\nwhere $\\partial_i$ denotes the partial derivative with respect to the angular coordinate $\\theta_i$.\n\nThese relations simplify in Fourier space. Let $\\hat{f}(\\boldsymbol{k})$ denote the Fourier transform of a field $f(\\boldsymbol{\\theta})$. The derivative operator $\\partial_i$ transforms to multiplication by $i k_i$, where $k_i$ is the wavevector component. Thus, the relations become:\n$$ \\hat{\\kappa}(\\boldsymbol{k}) = -\\frac{1}{2}(k_1^2 + k_2^2)\\hat{\\psi}(\\boldsymbol{k}) = -\\frac{1}{2}k^2\\hat{\\psi}(\\boldsymbol{k}) $$\n$$ \\hat{\\gamma}_1(\\boldsymbol{k}) = -\\frac{1}{2}(k_1^2 - k_2^2)\\hat{\\psi}(\\boldsymbol{k}) $$\n$$ \\hat{\\gamma}_2(\\boldsymbol{k}) = -(k_1 k_2)\\hat{\\psi}(\\boldsymbol{k}) $$\nHere, $k^2 = k_1^2 + k_2^2$. For this problem, the underlying mass distribution is assumed to produce a pure E-mode (gradient-only) field, so $\\kappa$ is the true E-mode convergence. We can express the shear components in terms of the convergence by substituting $\\hat{\\psi}(\\boldsymbol{k}) = -2\\hat{\\kappa}(\\boldsymbol{k})/k^2$ (for $\\boldsymbol{k} \\neq \\boldsymbol{0}$):\n$$ \\hat{\\gamma}_1(\\boldsymbol{k}) = \\frac{k_1^2 - k_2^2}{k^2}\\hat{\\kappa}(\\boldsymbol{k}) $$\n$$ \\hat{\\gamma}_2(\\boldsymbol{k}) = \\frac{2k_1 k_2}{k^2}\\hat{\\kappa}(\\boldsymbol{k}) $$\n\nA general shear field can be decomposed into a curl-free E-mode part, sourced by a potential $\\kappa_E$, and a divergence-free B-mode part, sourced by a pseudo-potential $\\kappa_B$. The Fourier-space relations for a general shear field are:\n$$ \\hat{\\gamma}_1(\\boldsymbol{k}) = \\frac{k_1^2 - k_2^2}{k^2}\\hat{\\kappa}_E(\\boldsymbol{k}) + \\frac{2k_1 k_2}{k^2}\\hat{\\kappa}_B(\\boldsymbol{k}) $$\n$$ \\hat{\\gamma}_2(\\boldsymbol{k}) = \\frac{2k_1 k_2}{k^2}\\hat{\\kappa}_E(\\boldsymbol{k}) - \\frac{k_1^2 - k_2^2}{k^2}\\hat{\\kappa}_B(\\boldsymbol{k}) $$\nThis represents a system of two linear equations for $\\hat{\\kappa}_E(\\boldsymbol{k})$ and $\\hat{\\kappa}_B(\\boldsymbol{k})$ at each wavevector $\\boldsymbol{k}$. Solving this system yields the inversion formulae. Multiplying the first equation by $(k_1^2 - k_2^2)/k^2$ and the second by $(2k_1 k_2)/k^2$ and adding them isolates $\\hat{\\kappa}_E$. Similarly, multiplying the first by $(2k_1 k_2)/k^2$ and the second by $-(k_1^2 - k_2^2)/k^2$ and adding isolates $\\hat{\\kappa}_B$. The inversion is:\n$$ \\hat{\\kappa}_E(\\boldsymbol{k}) = \\frac{k_1^2 - k_2^2}{k^2}\\hat{\\gamma}_1(\\boldsymbol{k}) + \\frac{2k_1 k_2}{k^2}\\hat{\\gamma}_2(\\boldsymbol{k}) $$\n$$ \\hat{\\kappa}_B(\\boldsymbol{k}) = \\frac{2k_1 k_2}{k^2}\\hat{\\gamma}_1(\\boldsymbol{k}) - \\frac{k_1^2 - k_2^2}{k^2}\\hat{\\gamma}_2(\\boldsymbol{k}) $$\nThese expressions are defined for $\\boldsymbol{k} \\neq \\boldsymbol{0}$. The mean convergence, $\\hat{\\kappa}(\\boldsymbol{0})$, is unobservable from shear (the mass-sheet degeneracy), and we set $\\hat{\\kappa}_E(\\boldsymbol{0}) = \\hat{\\kappa}_B(\\boldsymbol{0}) = 0$.\n\nIn an observational setting, the true shear field $\\gamma(\\boldsymbol{\\theta})$ is multiplied by a window function (mask) $W(\\boldsymbol{\\theta})$, such that the observed shear is $\\gamma^{\\mathrm{obs}}(\\boldsymbol{\\theta}) = W(\\boldsymbol{\\theta})\\gamma(\\boldsymbol{\\theta})$. Multiplication in real space corresponds to convolution in Fourier space: $\\hat{\\gamma}^{\\mathrm{obs}}(\\boldsymbol{k}) = (\\hat{W} * \\hat{\\gamma})(\\boldsymbol{k})$. If $W(\\boldsymbol{\\theta})$ has sharp edges, its Fourier transform $\\hat{W}(\\boldsymbol{k})$ has broad, slowly decaying wings. This convolution mixes power between different Fourier modes. Since the E/B filters depend on the direction of $\\boldsymbol{k}$, this mode-mixing corrupts the separation, causing power from the pure E-mode signal to \"leak\" into the reconstructed B-mode map. The inversion procedure is thus applied to the Fourier transform of the *observed* fields, $\\hat{\\gamma}^{\\mathrm{obs}}_1$ and $\\hat{\\gamma}^{\\mathrm{obs}}_2$, which leads to a non-zero $\\kappa_B$ even if the original field was pure E-mode.\n\n### 2. Apodization Strategy\n\nTo mitigate the E/B leakage caused by sharp mask boundaries, the window function $W(\\boldsymbol{\\theta})$ must be smoothed. This process is known as apodization. A good apodization function smoothly transitions from $0$ to $1$ over a finite width $w$ at the mask edges. The problem asks for a function $A(d)$ that depends on the distance $d$ to the nearest masked region.\n\nWe propose a sine-squared (or cosine-bell) tapering function. Let $W_0(\\boldsymbol{\\theta})$ be the binary mask ($0$ in excluded regions, $1$ elsewhere). For any point $\\boldsymbol{\\theta}$ in the unmasked region ($W_0(\\boldsymbol{\\theta})=1$), let $d(\\boldsymbol{\\theta})$ be its Euclidean distance to the nearest point in the masked region. The apodized window $W(\\boldsymbol{\\theta})$ is defined as:\n$$\nW(\\boldsymbol{\\theta}) =\n\\begin{cases}\n    0  \\text{if } W_0(\\boldsymbol{\\theta}) = 0 \\\\\n    \\sin^2\\left(\\frac{\\pi d(\\boldsymbol{\\theta})}{2w}\\right)  \\text{if } W_0(\\boldsymbol{\\theta}) = 1 \\text{ and } d(\\boldsymbol{\\theta})  w \\\\\n    1  \\text{if } W_0(\\boldsymbol{\\theta}) = 1 \\text{ and } d(\\boldsymbol{\\theta}) \\ge w\n\\end{cases}\n$$\nThe justification for this choice is its smoothness. This function is continuous and has a continuous first derivative at the transition points $d=0$ (boundary of the original mask) and $d=w$ (inner edge of the apodization region). A function $f(x)$ with continuous derivatives has a Fourier transform $\\hat{f}(k)$ that decays faster at large $k$. By ensuring $W(\\boldsymbol{\\theta})$ and its first derivative are continuous, we suppress the high-frequency power in $\\hat{W}(\\boldsymbol{k})$, narrowing its core and reducing the extent of mode-mixing, thereby minimizing E/B leakage.\n\n### 3. Numerical Experiment Design\n\nThe numerical experiment is designed to demonstrate the effectiveness of apodization. The procedure is as follows:\n1.  **Grid and Mock Field:** A $128 \\times 128$ pixel grid is defined. The true convergence field $\\kappa(\\boldsymbol{\\theta})$ is constructed as a superposition of two Gaussian clumps with specified parameters. Its mean is subtracted to ensure $\\hat{\\kappa}(\\boldsymbol{0}) = 0$.\n2.  **True Shear Generation:** The true shear fields $\\gamma_1(\\boldsymbol{\\theta})$ and $\\gamma_2(\\boldsymbol{\\theta})$ are generated from $\\kappa(\\boldsymbol{\\theta})$ using the Fourier space relations derived above. This involves FFT'ing $\\kappa$, applying the appropriate filters in $k$-space, and IFFT'ing back.\n3.  **Mask Application:** For each of the four test cases, the corresponding binary mask $W_0$ is created. The apodized mask $W$ is then constructed using the sine-squared tapering function with the specified width $w$. The observed shear fields $\\gamma_1^{\\mathrm{obs}}$ and $\\gamma_2^{\\mathrm{obs}}$ are obtained by multiplying the true shear fields by $W$.\n4.  **E/B Reconstruction:** The observed shear fields are Fourier transformed. The E/B inversion formulae are applied in Fourier space to obtain $\\hat{\\kappa}_E(\\boldsymbol{k})$ and $\\hat{\\kappa}_B(\\boldsymbol{k})$. These are then inverse Fourier transformed to yield the real-space maps $\\kappa_E(\\boldsymbol{\\theta})$ and $\\kappa_B(\\boldsymbol{\\theta})$.\n5.  **Leakage Calculation:** The leakage metric $L$ is calculated for each case using the formula:\n    $$ L = \\sqrt{\\frac{\\sum_{i} W_i \\,\\kappa_B(\\boldsymbol{\\theta}_i)^2}{\\sum_{i} W_i \\,\\kappa_E(\\boldsymbol{\\theta}_i)^2}} $$\n    This metric quantifies the ratio of power in the reconstructed B-mode to the E-mode, weighted by the mask itself to focus on the observed region. The results for the four cases will demonstrate that $L$ is negligible for the unmasked case, significant for a hard-edged mask, and substantially reduced by apodization.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.ndimage import distance_transform_edt\n\ndef create_mock_kappa(N, clumps):\n    \"\"\"Generates the mock convergence map.\"\"\"\n    y, x = np.meshgrid(np.arange(N), np.arange(N), indexing='ij')\n    kappa = np.zeros((N, N))\n    for clump in clumps:\n        A, (x0, y0), sigma = clump\n        dist_sq = (x - x0)**2 + (y - y0)**2\n        kappa += A * np.exp(-dist_sq / (2 * sigma**2))\n    \n    # Subtract the mean to ensure the DC mode is zero.\n    kappa -= np.mean(kappa)\n    return kappa\n\ndef kappa_to_shear(kappa, N):\n    \"\"\"Computes shear fields from a convergence map in Fourier space.\"\"\"\n    kappa_k = np.fft.fft2(kappa)\n    \n    ky = np.fft.fftfreq(N)[:, None]\n    kx = np.fft.fftfreq(N)[None, :]\n    \n    # Square of the wavenumber. Avoid division by zero at k=0.\n    k_sq = kx**2 + ky**2\n    k_sq[0, 0] = 1.0  # Avoid division by zero\n    \n    # Shear-to-convergence filters\n    # gamma1_k = kappa_k * (kx^2 - ky^2) / k^2\n    # gamma2_k = kappa_k * (2*kx*ky) / k^2\n    g1_k_filter = (kx**2 - ky**2) / k_sq\n    g2_k_filter = (2 * kx * ky) / k_sq\n    \n    # The k=0 mode has no shear, set filter to 0\n    g1_k_filter[0, 0] = 0.0\n    g2_k_filter[0, 0] = 0.0\n    \n    gamma1_k = kappa_k * g1_k_filter\n    gamma2_k = kappa_k * g2_k_filter\n        \n    gamma1 = np.fft.ifft2(gamma1_k).real\n    gamma2 = np.fft.ifft2(gamma2_k).real\n    \n    return gamma1, gamma2\n\ndef reconstruct_kEB(gamma1_obs, gamma2_obs, N):\n    \"\"\"Reconstructs E-mode and B-mode convergence from observed shear.\"\"\"\n    gamma1_obs_k = np.fft.fft2(gamma1_obs)\n    gamma2_obs_k = np.fft.fft2(gamma2_obs)\n\n    ky = np.fft.fftfreq(N)[:, None]\n    kx = np.fft.fftfreq(N)[None, :]\n    \n    k_sq = kx**2 + ky**2\n    k_sq[0, 0] = 1.0  # Avoid division by zero\n    \n    # E-mode filter: kE_k = ((kx^2-ky^2)*g1_k + (2*kx*ky)*g2_k)/k^2\n    kE_k = ((kx**2 - ky**2) * gamma1_obs_k + 2 * kx * ky * gamma2_obs_k) / k_sq\n    \n    # B-mode filter: kB_k = ((2*kx*ky)*g1_k - (kx^2-ky^2)*g2_k)/k^2\n    kB_k = (2 * kx * ky * gamma1_obs_k - (kx**2 - ky**2) * gamma2_obs_k) / k_sq\n\n    # Set DC modes to zero (mass sheet degeneracy)\n    kE_k[0, 0] = 0.0\n    kB_k[0, 0] = 0.0\n    \n    kappa_E = np.fft.ifft2(kE_k).real\n    kappa_B = np.fft.ifft2(kB_k).real\n    \n    return kappa_E, kappa_B\n\ndef generate_mask(mask_type, param, N):\n    \"\"\"Generates the binary mask W0.\"\"\"\n    W0 = np.ones((N, N))\n    y, x = np.meshgrid(np.arange(N), np.arange(N), indexing='ij')\n    center = N / 2\n\n    if mask_type == \"none\":\n        pass\n    elif mask_type == \"circular\":\n        radius = param\n        dist_sq = (x - center)**2 + (y - center)**2\n        W0[dist_sq = radius**2] = 0\n    elif mask_type == \"stripe\":\n        half_width = param\n        W0[:, np.abs(np.arange(N) - center) = half_width] = 0\n        \n    return W0\n\ndef apply_apodization(W0, w, N):\n    \"\"\"Applies sine-squared apodization to a binary mask.\"\"\"\n    if w == 0:\n        return W0.astype(float)\n\n    # distance_transform_edt computes the distance from each non-zero pixel \n    # to the nearest zero pixel. This is exactly d(theta).\n    dist_map = distance_transform_edt(W0)\n    \n    W = W0.copy().astype(float)\n    \n    # Identify the region to apply tapering\n    taper_zone = (W0 == 1)  (dist_map  w)\n    \n    # Apply the sine-squared apodization function\n    W[taper_zone] = np.sin(np.pi * dist_map[taper_zone] / (2 * w))**2\n    \n    return W\n\ndef calculate_leakage(kappa_E, kappa_B, W):\n    \"\"\"Calculates the E-to-B leakage metric L.\"\"\"\n    \n    # The sum is over all pixels, weighted by W_i.\n    # Pixels where W_i=0 contribute nothing.\n    power_B = np.sum(W * kappa_B**2)\n    power_E = np.sum(W * kappa_E**2)\n    \n    if power_E == 0:\n        return np.inf\n        \n    return np.sqrt(power_B / power_E)\n\ndef solve():\n    N = 128\n    \n    # Define the mock kappa field\n    clumps = [\n        (1.0, (N/4, N/4), 5.0),\n        (0.8, (3*N/4, 3*N/4), 8.0)\n    ]\n    kappa_true = create_mock_kappa(N, clumps)\n    \n    # Generate the true, unmasked shear fields\n    gamma1_true, gamma2_true = kappa_to_shear(kappa_true, N)\n    \n    # Define the test cases\n    test_cases = [\n        {\"mask_type\": \"none\", \"param\": 0, \"w\": 0},\n        {\"mask_type\": \"circular\", \"param\": 12, \"w\": 0},\n        {\"mask_type\": \"circular\", \"param\": 12, \"w\": 6},\n        {\"mask_type\": \"stripe\", \"param\": 6, \"w\": 6},\n    ]\n    \n    results = []\n    \n    for case in test_cases:\n        # 1. Generate binary mask\n        W0 = generate_mask(case[\"mask_type\"], case[\"param\"], N)\n        \n        # 2. Apply apodization to get final window function W\n        W = apply_apodization(W0, case[\"w\"], N)\n        \n        # 3. Create observed (masked) shear fields\n        gamma1_obs = gamma1_true * W\n        gamma2_obs = gamma2_true * W\n        \n        # 4. Reconstruct E and B modes from observed shear\n        kappa_E, kappa_B = reconstruct_kEB(gamma1_obs, gamma2_obs, N)\n        \n        # 5. Calculate leakage\n        leakage = calculate_leakage(kappa_E, kappa_B, W)\n        results.append(leakage)\n\n    # Format the final output\n    formatted_results = [f\"{r:.6f}\" for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "3468591"}]}