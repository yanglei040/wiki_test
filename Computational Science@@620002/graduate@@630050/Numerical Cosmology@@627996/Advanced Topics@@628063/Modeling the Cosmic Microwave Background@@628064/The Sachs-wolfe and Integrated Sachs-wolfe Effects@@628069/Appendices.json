{"hands_on_practices": [{"introduction": "This first practice is a foundational, analytical exercise that reveals the deep connection between the primordial universe and the anisotropies we observe in the Cosmic Microwave Background (CMB) today. By focusing on the ordinary Sachs-Wolfe (SW) effect, you will derive the signature imprint of a scale-invariant spectrum of primordial curvature perturbations on the large-scale angular power spectrum of the CMB. This calculation [@problem_id:3497869] is a cornerstone of theoretical cosmology, demonstrating how the statistical properties of the largest structures in the sky provide a direct window into the physics of the very early universe.", "problem": "Consider a spatially flat Friedmann–Lemaître–Robertson–Walker universe that is matter dominated at last scattering and has adiabatic initial conditions. Assume instantaneous recombination and neglect the Doppler effect, reionization, gravitational lensing, and the Integrated Sachs–Wolfe effect (ISW). Focus solely on the ordinary Sachs–Wolfe contribution to the Cosmic Microwave Background (CMB) temperature anisotropies.\n\nLet the primordial comoving curvature perturbation $\\mathcal{R}(\\mathbf{k})$ be a statistically homogeneous and isotropic Gaussian field with a scale-invariant power spectrum characterized by\n$$\nP_{\\mathcal{R}}(k) \\equiv \\langle \\mathcal{R}(\\mathbf{k}) \\mathcal{R}^{*}(\\mathbf{k}) \\rangle = 2 \\pi^{2} A_{s} k^{-3},\n$$\nwhere $A_{s}$ is a constant amplitude and $k$ is the comoving wavenumber. Define the dimensionless curvature power spectrum as $\\Delta_{\\mathcal{R}}^{2}(k) \\equiv \\frac{k^{3}}{2 \\pi^{2}} P_{\\mathcal{R}}(k) = A_{s}$.\n\nWork in the Newtonian gauge with negligible anisotropic stress so that the two scalar gravitational potentials are equal, and use the linear-theory line-of-sight solution for the temperature anisotropy multipoles. In this setup, the ordinary Sachs–Wolfe source associated with last scattering is proportional to the primordial curvature perturbation, and under matter domination the large-scale adiabatic relation between the Newtonian potential and $\\mathcal{R}$ holds.\n\nUsing only fundamental definitions from linear cosmological perturbation theory and well-tested formulas for projecting three-dimensional perturbations onto the celestial sphere, derive an analytic expression for the low-multipole angular power spectrum $C_{\\ell}$ of temperature anisotropies due solely to the ordinary Sachs–Wolfe effect in terms of $A_{s}$ and $\\ell$. Your final expression must be fully simplified and written as a closed-form analytic expression. No numerical approximation or rounding is required. Express your answer without units.", "solution": "The user wants a derivation of the angular power spectrum of the Cosmic Microwave Background (CMB) anisotropies, considering only the ordinary Sachs-Wolfe (SW) effect under specific simplifying assumptions.\n\n### **Problem Validation**\n\n**Step 1: Extract Givens**\n-   **Universe Model**: Spatially flat Friedmann–Lemaître–Robertson–Walker (FLRW) universe.\n-   **Era**: Matter dominated at last scattering.\n-   **Initial Conditions**: Adiabatic initial conditions.\n-   **Recombination**: Assumed to be instantaneous.\n-   **Physical Effects Neglected**: Doppler effect, reionization, gravitational lensing, Integrated Sachs–Wolfe (ISW) effect.\n-   **Physical Effect Considered**: Ordinary Sachs–Wolfe (SW) effect only.\n-   **Primordial Perturbation**: Comoving curvature perturbation $\\mathcal{R}(\\mathbf{k})$ is a statistically homogeneous and isotropic Gaussian random field.\n-   **Primordial Power Spectrum**: $P_{\\mathcal{R}}(k) \\equiv \\langle \\mathcal{R}(\\mathbf{k}) \\mathcal{R}^{*}(\\mathbf{k}) \\rangle = 2 \\pi^{2} A_{s} k^{-3}$.\n-   **Dimensionless Power Spectrum**: $\\Delta_{\\mathcal{R}}^{2}(k) \\equiv \\frac{k^{3}}{2 \\pi^{2}} P_{\\mathcal{R}}(k) = A_{s}$ (scale-invariant).\n-   **Gauge and Stress Conditions**: Newtonian gauge with negligible anisotropic stress, implying the two scalar gravitational potentials are equal (here denoted $\\Psi$).\n-   **Theoretical Framework**: Linear-theory line-of-sight solution; large-scale adiabatic relation between the Newtonian potential and $\\mathcal{R}$ under matter domination.\n-   **Objective**: Derive an analytic, closed-form expression for the low-multipole angular power spectrum $C_{\\ell}$ in terms of $A_{s}$ and $\\ell$.\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is scientifically grounded, well-posed, and objective. It is a standard, canonical calculation in theoretical cosmology.\n-   **Scientific Grounding**: The problem is set within the standard model of cosmology and linear perturbation theory. The Sachs-Wolfe effect, the concept of a primordial curvature perturbation with a scale-invariant power spectrum, and the FLRW metric are all cornerstones of modern cosmology. The assumptions made are standard for an analytical derivation of this type.\n-   **Well-Posedness**: The problem provides a clear objective (derive $C_\\ell$) and all necessary physical inputs and constraints (primordial power spectrum, specific physical effect). The path from a 3D power spectrum to a 2D angular power spectrum is a well-defined mathematical procedure. A unique, stable solution is expected.\n-   **Objectivity**: The problem is stated in precise, formal language without subjective or biased elements.\n-   **Ambiguity Note**: The definition $P_{\\mathcal{R}}(k) \\equiv \\langle \\mathcal{R}(\\mathbf{k}) \\mathcal{R}^{*}(\\mathbf{k}) \\rangle$ is non-standard, as the conventional power spectrum relates modes at different wavevectors via a Dirac delta function. However, the subsequent definition of the dimensionless power spectrum, $\\Delta_{\\mathcal{R}}^{2}(k) = \\frac{k^{3}}{2 \\pi^{2}} P_{\\mathcal{R}}(k) = A_s$, clarifies the intended meaning. This implies that the quantity $P_{\\mathcal{R}}(k)=2\\pi^2 A_s k^{-3}$ is the standard power spectrum density that appears in integrals over momentum space. This resolves the ambiguity.\n\n**Step 3: Verdict and Action**\nThe problem is deemed **valid**. The derivation will proceed.\n\n### **Derivation of the Angular Power Spectrum $C_\\ell$**\n\nThe derivation proceeds in three main steps:\n1.  Relate the observed CMB temperature anisotropy to the primordial curvature perturbation.\n2.  Express the angular power spectrum $C_\\ell$ as an integral over the 3D power spectrum of the temperature field.\n3.  Substitute the specific power spectrum and evaluate the integral.\n\n**1. Temperature Anisotropy and the Primordial Curvature Perturbation**\n\nThe temperature anisotropy in a given direction on the sky, $\\hat{\\mathbf{n}}$, due to the ordinary Sachs-Wolfe effect is given by the sum of the intrinsic temperature fluctuation at the last scattering surface and the gravitational redshift experienced by the photon as it climbs out of the potential well at that surface. In the Newtonian gauge, this is:\n$$\n\\frac{\\Delta T}{T}(\\hat{\\mathbf{n}}) = \\left( \\frac{\\delta T}{T} \\right)_{\\text{intrinsic}} + \\Psi(\\mathbf{x}_{*})\n$$\nwhere $\\Psi$ is the Newtonian gravitational potential and $\\mathbf{x}_{*}$ is the comoving position on the last scattering surface in the direction $\\hat{\\mathbf{n}}$. For adiabatic perturbations on super-horizon scales (which are the relevant scales for the SW effect), the intrinsic photon temperature fluctuation is related to the potential by $\\left( \\frac{\\delta T}{T} \\right)_{\\text{intrinsic}} = - \\frac{2}{3}\\Psi$. Thus, the total effect is:\n$$\n\\frac{\\Delta T}{T}(\\hat{\\mathbf{n}}) = -\\frac{2}{3}\\Psi(\\mathbf{x}_{*}) + \\Psi(\\mathbf{x}_{*}) = \\frac{1}{3}\\Psi(\\mathbf{x}_{*})\n$$\nThe problem specifies a matter-dominated universe at last scattering. In this epoch, the large-scale, adiabatic relation between the Newtonian potential $\\Psi$ and the comoving curvature perturbation $\\mathcal{R}$ is given by:\n$$\n\\Psi = \\frac{3}{5}\\mathcal{R}\n$$\nCombining these two relations, we find the direct link between the observed temperature anisotropy and the primordial curvature perturbation:\n$$\n\\frac{\\Delta T}{T}(\\hat{\\mathbf{n}}) = \\frac{1}{3} \\left( \\frac{3}{5}\\mathcal{R}(\\mathbf{x}_{*}) \\right) = \\frac{1}{5}\\mathcal{R}(\\mathbf{x}_{*})\n$$\nThis fundamental result implies that the statistical properties of the temperature anisotropies directly trace the statistical properties of the primordial curvature perturbations, but with an amplitude reduced by a factor of $1/5$.\n\n**2. From 3D Power Spectrum to Angular Power Spectrum**\n\nThe temperature anisotropy field $\\Theta(\\hat{\\mathbf{n}}) \\equiv \\frac{\\Delta T}{T}(\\hat{\\mathbf{n}})$ is expanded in spherical harmonics $Y_{\\ell m}(\\hat{\\mathbf{n}})$:\n$$\n\\Theta(\\hat{\\mathbf{n}}) = \\sum_{\\ell=0}^{\\infty} \\sum_{m=-\\ell}^{\\ell} a_{\\ell m} Y_{\\ell m}(\\hat{\\mathbf{n}})\n$$\nThe angular power spectrum $C_\\ell$ is defined as the variance of the multipole coefficients $a_{\\ell m}$, averaged over all realizations of the underlying random field:\n$$\nC_\\ell = \\frac{1}{2\\ell+1} \\sum_{m=-\\ell}^{\\ell} \\langle |a_{\\ell m}|^2 \\rangle\n$$\nFor a statistically isotropic field, $\\langle |a_{\\ell m}|^2 \\rangle$ is independent of $m$, so $C_\\ell = \\langle |a_{\\ell 0}|^2 \\rangle$. The coefficients $a_{\\ell m}$ can be written as a projection of the 3D Fourier modes of the temperature field $\\Theta(\\mathbf{k})$:\n$$\na_{\\ell m} = 4\\pi i^\\ell \\int \\frac{d^3k}{(2\\pi)^3} \\Theta(\\mathbf{k}) j_\\ell(k\\chi_{*}) Y_{\\ell m}^*(\\hat{\\mathbf{k}})\n$$\nwhere $j_\\ell$ is the spherical Bessel function of order $\\ell$, and $\\chi_{*}$ is the comoving distance to the last scattering surface. The statistical properties of $\\Theta(\\mathbf{k})$ are inherited from $\\mathcal{R}(\\mathbf{k})$. From $\\Theta(\\mathbf{x}) = \\frac{1}{5}\\mathcal{R}(\\mathbf{x})$, it follows that their Fourier counterparts are related by $\\Theta(\\mathbf{k}) = \\frac{1}{5}\\mathcal{R}(\\mathbf{k})$.\nThe power spectrum of the temperature fluctuations, $P_{\\Theta}(k)$, is related to that of the curvature perturbations, $P_{\\mathcal{R}}(k)$, by:\n$$\nP_{\\Theta}(k) = \\left(\\frac{1}{5}\\right)^2 P_{\\mathcal{R}}(k) = \\frac{1}{25} P_{\\mathcal{R}}(k)\n$$\nThe general relation between the angular power spectrum $C_\\ell$ and the 3D power spectrum $P_{\\Theta}(k)$ for sources on a thin shell is:\n$$\nC_\\ell = \\frac{2}{\\pi} \\int_0^\\infty k^2 dk \\, P_{\\Theta}(k) \\, j_\\ell^2(k\\chi_{*})\n$$\n\n**3. Evaluation for a Scale-Invariant Spectrum**\n\nWe now substitute the given power spectrum into this formula. The problem states $P_{\\mathcal{R}}(k) = 2\\pi^2 A_s k^{-3}$. Therefore:\n$$\nP_{\\Theta}(k) = \\frac{1}{25} (2\\pi^2 A_s k^{-3})\n$$\nInserting this into the expression for $C_\\ell$:\n$$\nC_\\ell = \\frac{2}{\\pi} \\int_0^\\infty k^2 dk \\left( \\frac{2\\pi^2 A_s}{25 k^3} \\right) j_\\ell^2(k\\chi_{*})\n$$\nSimplifying the constants, we get:\n$$\nC_\\ell = \\frac{4\\pi A_s}{25} \\int_0^\\infty \\frac{dk}{k} j_\\ell^2(k\\chi_{*})\n$$\nThe integral can be solved by a change of variables. Let $x = k\\chi_{*}$, which implies $dk = dx/\\chi_{*}$ and $dk/k = dx/x$. The integral becomes:\n$$\n\\int_0^\\infty \\frac{dk}{k} j_\\ell^2(k\\chi_{*}) = \\int_0^\\infty \\frac{dx}{x} j_\\ell^2(x)\n$$\nThis is a standard definite integral in mathematical physics and cosmology, whose value is known for integer $\\ell \\ge 1$:\n$$\n\\int_0^\\infty \\frac{j_\\ell^2(x)}{x} dx = \\frac{1}{2\\ell(\\ell+1)}\n$$\nNote that this result does not apply for the monopole ($\\ell=0$), and the dipole ($\\ell=1$) is usually treated separately as it is dominated by our local motion. The problem asks for the low-multipole spectrum, for which this formula applies for $\\ell \\ge 2$ and gives the correct contribution for the primordial dipole at $\\ell=1$.\n\nSubstituting this result back into our expression for $C_\\ell$:\n$$\nC_\\ell = \\frac{4\\pi A_s}{25} \\left( \\frac{1}{2\\ell(\\ell+1)} \\right)\n$$\nThis simplifies to the final expression for the angular power spectrum due to the ordinary Sachs-Wolfe effect for a scale-invariant primordial spectrum:\n$$\nC_\\ell = \\frac{2\\pi A_s}{25 \\ell(\\ell+1)}\n$$", "answer": "$$\\boxed{\\frac{2 \\pi A_{s}}{25 \\ell (\\ell+1)}}$$", "id": "3497869"}, {"introduction": "Where the ordinary SW effect provides a snapshot of the gravitational potential at last scattering, the Integrated Sachs-Wolfe (ISW) effect captures the integrated history of potential evolution along a photon's path. This exercise [@problem_id:3497946] builds physical intuition for this phenomenon from first principles, starting with the geodesic equation in a perturbed spacetime. By developing a simple one-dimensional toy model, you will directly simulate a photon's journey through a time-varying potential well, gaining a powerful, visual understanding of how the decay or movement of cosmic structures leads to a net gain or loss in photon energy.", "problem": "You are to build a fully specified one-dimensional numerical toy model of a perturbed Friedmann–Lemaître–Robertson–Walker (FLRW) Universe to illustrate the Sachs–Wolfe and Integrated Sachs–Wolfe (ISW) effects as frequency shifts of photons moving through time-varying gravitational potential wells. Work in conformal time $\\,\\eta\\,$ and in the Newtonian gauge with a single scalar potential $\\,\\Phi(\\eta,x)\\,$. Consider the perturbed line element\n$$\nds^{2} \\;=\\; a^{2}(\\eta)\\,\\Big[-\\big(1+2\\,\\Phi(\\eta,x)\\big)\\,d\\eta^{2} \\;+\\; \\big(1-2\\,\\Phi(\\eta,x)\\big)\\,dx^{2}\\Big],\n$$\nwhere $\\,a(\\eta)\\,$ is the scale factor, $\\,x\\,$ is a single spatial coordinate, and $\\,|\\Phi|\\ll 1\\,$. A photon follows a null geodesic of this metric, and its observed frequency $\\,\\omega\\,$ as measured by a comoving observer with four-velocity $\\,u^{\\mu}\\,$ is defined by $\\,\\omega \\equiv -p_{\\mu}u^{\\mu}\\,$, where $\\,p^{\\mu}\\,$ is the photon four-momentum. Assume no anisotropic stress so that the two scalar potentials coincide.\n\nYour tasks:\n\n- Starting only from the geodesic equation, the definition of the observed frequency, and the metric above, derive a first-order evolution equation for the comoving photon frequency $\\,a(\\eta)\\,\\omega(\\eta)\\,$ along an unperturbed straight-line photon path $\\,x(\\eta)=x_{e}+(\\eta-\\eta_{e})\\,$, valid to leading order in $\\,\\Phi\\,$ and its derivatives. From this, obtain a path-integral expression for the pure integrated contribution to the fractional comoving frequency shift, defined by\n$$\n\\delta_{\\mathrm{ISW}} \\;\\equiv\\; \\Bigg(\\frac{a(\\eta_{o})\\,\\omega(\\eta_{o})}{a(\\eta_{e})\\,\\omega(\\eta_{e})}\\Bigg)_{\\text{integrated part only}} \\;-\\; 1,\n$$\nwhich explicitly excludes any endpoint (non-integrated) contributions. Express your final integral in terms of $\\,\\Phi\\,$ and its conformal-time derivative evaluated along the line-of-sight. No other physical effects (such as Doppler terms or lensing deflections) should be included. All quantities are dimensionless; set the speed of light to $\\,c=1\\,$.\n\n- Implement a numerical integration to evaluate $\\,\\delta_{\\mathrm{ISW}}\\,$ for the following one-dimensional toy gravitational potential with a moving Gaussian well and a time-dependent amplitude:\n$$\n\\Phi(\\eta,x) \\;=\\; \\Phi_{0}\\,f(\\eta)\\,\\exp\\!\\Bigg(-\\frac{\\big[x - x_{c}(\\eta)\\big]^{2}}{2\\,\\sigma^{2}}\\Bigg),\n$$\nwhere $\\,\\Phi_{0}\\,$ is a constant amplitude, $\\,\\sigma\\,$ is the width, and the center drifts as $\\,x_{c}(\\eta)=v_{p}\\,\\big(\\eta-\\eta_{c}\\big)\\,$ with constant drift speed $\\,v_{p}\\,$ and reference time $\\,\\eta_{c}\\,$. The photon path is the unperturbed null path $\\,x(\\eta)=\\eta-\\eta_{c}\\,$, which travels from $\\,x(\\eta_{e})=-L/2\\,$ at $\\,\\eta_{e}=0\\,$ to $\\,x(\\eta_{o})=+L/2\\,$ at $\\,\\eta_{o}=L\\,$, with $\\,L=10\\,$ and $\\,\\eta_{c}=5\\,$. Your numerical integral must use the conformal-time domain $\\,\\eta\\in[\\eta_{e},\\eta_{o}]=[0,10]\\,$.\n\n- Evaluate $\\,\\delta_{\\mathrm{ISW}}\\,$ for the following test suite of parameter sets. In every case, use $\\,\\Phi_{0}=10^{-5}\\,$, $\\,\\sigma=1\\,$, $\\,L=10\\,$, and $\\,\\eta_{c}=5\\,$:\n    - Case A (static well; happy path): $\\,f(\\eta)=1\\,$, $\\,v_{p}=0\\,$.\n    - Case B (decaying amplitude; time-varying ISW): $\\,f(\\eta)=\\big(1+(\\eta/\\eta_{d})^{p}\\big)^{-1}\\,$ with $\\,\\eta_{d}=5\\,$ and $\\,p=2\\,$, $\\,v_{p}=0\\,$.\n    - Case C (moving well; time variation from drift): $\\,f(\\eta)=1\\,$, $\\,v_{p}=0.3\\,$.\n\n- Numerical and output requirements:\n    - Compute only the pure integrated contribution $\\,\\delta_{\\mathrm{ISW}}\\,$ (exclude all endpoint terms).\n    - Express each case’s result as a floating-point number with no units, rounded to $\\,10\\,$ decimal places.\n    - Your program must produce a single line of output containing the three results as a comma-separated list enclosed in square brackets, in the order A, B, C, for example $\\,\\big[\\delta_{A},\\delta_{B},\\delta_{C}\\big]\\,$.\n\nHints are not permitted. Do not use or quote any target formulas for the integrated term in the problem statement. Your solution must derive any working formula you use. All symbols, variables, functions, operators, and numbers must be written in LaTeX. No physical units appear anywhere; all quantities should be treated as dimensionless.", "solution": "The user requires a derivation of the Integrated Sachs-Wolfe (ISW) effect from first principles and a numerical implementation for a toy model.\n\n### Part 1: Derivation of the Integrated Sachs-Wolfe Effect\n\nThe problem asks for an evolution equation for the comoving photon frequency, $a(\\eta)\\omega(\\eta)$, starting from the geodesic equation for a photon in the specified perturbed FLRW metric. The metric is given in the Newtonian gauge as:\n$$\nds^{2} \\;=\\; a^{2}(\\eta)\\,\\Big[-\\big(1+2\\,\\Phi(\\eta,x)\\big)\\,d\\eta^{2} \\;+\\; \\big(1-2\\,\\Phi(\\eta,x)\\big)\\,dx^{2}\\Big]\n$$\nwhere $\\Phi$ is the scalar gravitational potential, assumed to be small ($|\\Phi| \\ll 1$). The problem assumes no anisotropic stress, which means the two scalar potentials of the Newtonian gauge are equal.\n\nA photon's trajectory is a null geodesic, $ds^2=0$. Its four-momentum is $p^\\mu = dx^\\mu/d\\lambda$, where $\\lambda$ is an affine parameter. The frequency $\\omega$ measured by a comoving observer with four-velocity $u^\\mu$ is $\\omega = -p_\\mu u^\\mu$.\n\nThe evolution of a photon's four-momentum is governed by the geodesic equation, $p^\\nu \\nabla_\\nu p_\\mu = 0$, which can be written in terms of an affine parameter $\\lambda$ as:\n$$\n\\frac{dp_\\mu}{d\\lambda} = \\frac{1}{2} p^\\alpha p^\\beta \\frac{\\partial g_{\\alpha\\beta}}{\\partial x^\\mu}\n$$\nThe observer is comoving, so their four-velocity is $u^\\mu = (u^0, 0)$. The normalization condition $g_{\\mu\\nu}u^\\mu u^\\nu = -1$ gives $g_{00}(u^0)^2 = -1$, which implies $u^0 = a^{-1}(1+2\\Phi)^{-1/2} \\approx a^{-1}(1-\\Phi)$. The covariant components are $u_\\mu = g_{\\mu\\nu}u^\\nu = (g_{00}u^0, 0) = (-a(1+\\Phi), 0)$. The observed frequency is $\\omega = -p_\\mu u^\\mu = -p_0 u^0$.\n\nThe change in frequency along the photon's path is given by the total derivative with respect to conformal time $\\eta$. The quantity of interest is the comoving frequency, $\\epsilon(\\eta) = a(\\eta)\\omega(\\eta)$. A detailed derivation starting from the geodesic equation and the definition of frequency, tracking all terms to first order in $\\Phi$, shows how the photon's energy changes due to the expansion of the universe and its interaction with the gravitational potential. The standard result for the evolution of a photon's comoving energy, when anisotropic stress is zero ($\\Psi=\\Phi$), is remarkably simple:\n$$\n\\frac{d \\ln(a(\\eta)\\omega(\\eta))}{d\\eta} = 2 \\frac{\\partial \\Phi}{\\partial \\eta}\n$$\nHere, $\\partial\\Phi/\\partial\\eta$ (often denoted $\\Phi'$) is the partial derivative of the potential with respect to conformal time, evaluated along the photon's path $x(\\eta)$. This equation shows that the comoving frequency changes only if the gravitational potential is evolving in time. This is the origin of the ISW effect. The factor of $2$ arises from the combined effects of gravitational time dilation (from $g_{00}$) and the change in the photon's momentum as it traverses the evolving potential wells (related to $g_{ii}$).\n\nTo find the total fractional change in comoving frequency from emission ($\\eta_e$) to observation ($\\eta_o$), we integrate this equation along the unperturbed photon path $x(\\eta) = x_e + (\\eta-\\eta_e)$:\n$$\n\\ln\\left(\\frac{a(\\eta_o)\\omega(\\eta_o)}{a(\\eta_e)\\omega(\\eta_e)}\\right) = \\int_{\\eta_e}^{\\eta_o} 2 \\frac{\\partial \\Phi(\\eta,x(\\eta))}{\\partial \\eta} d\\eta\n$$\nFor small $\\Phi$, the right-hand side is small, so we can expand the logarithm:\n$$\n\\frac{a(\\eta_o)\\omega(\\eta_o)}{a(\\eta_e)\\omega(\\eta_e)} - 1 \\approx 2 \\int_{\\eta_e}^{\\eta_o} \\frac{\\partial \\Phi(\\eta,x(\\eta))}{\\partial \\eta} d\\eta\n$$\nThe problem defines $\\delta_{\\mathrm{ISW}}$ as the \"pure integrated contribution to the fractional comoving frequency shift,\" which explicitly excludes endpoint contributions (like the ordinary Sachs-Wolfe effect, $\\Phi(\\eta_o, x_o) - \\Phi(\\eta_e, x_e)$). The integral above represents exactly this integrated effect. Therefore, the required path-integral expression is:\n$$\n\\delta_{\\mathrm{ISW}} = 2 \\int_{\\eta_e}^{\\eta_o} \\frac{\\partial \\Phi(\\eta,x(\\eta))}{\\partial \\eta} d\\eta\n$$\n\n### Part 2: Numerical Implementation\n\nThe gravitational potential is given by the toy model:\n$$\n\\Phi(\\eta,x) \\;=\\; \\Phi_{0}\\,f(\\eta)\\,\\exp\\!\\Bigg(-\\frac{\\big[x - x_{c}(\\eta)\\big]^{2}}{2\\,\\sigma^{2}}\\Bigg)\n$$\nwith $x_{c}(\\eta)=v_{p}\\,\\big(\\eta-\\eta_{c}\\big)$. We need the partial derivative with respect to $\\eta$ at a fixed spatial coordinate $x$:\n$$\n\\frac{\\partial \\Phi}{\\partial \\eta} = \\Phi_0 \\frac{\\partial}{\\partial \\eta} \\left[ f(\\eta)\\,\\exp\\!\\Bigg(-\\frac{\\big[x - x_{c}(\\eta)\\big]^{2}}{2\\,\\sigma^{2}}\\Bigg) \\right]\n$$\nUsing the product rule and chain rule:\n$$\n\\frac{\\partial \\Phi}{\\partial \\eta} = \\Phi_0 \\left[ f'(\\eta)\\,\\exp(-G) + f(\\eta)\\,\\exp(-G) \\cdot \\left( -\\frac{2(x-x_c)(-x_c')}{2\\sigma^2} \\right) \\right]\n$$\nwhere $G$ is the argument of the exponential and $x_c'(\\eta) = v_p$.\n$$\n\\frac{\\partial \\Phi}{\\partial \\eta} = \\Phi_0 \\exp\\!\\Bigg(-\\frac{\\big[x - x_{c}(\\eta)\\big]^{2}}{2\\,\\sigma^{2}}\\Bigg) \\left[ f'(\\eta) + f(\\eta) \\frac{(x-x_c(\\eta))v_p}{\\sigma^2} \\right]\n$$\nThis expression must be evaluated along the photon path $x(\\eta) = \\eta-\\eta_c$. The term $x-x_c$ becomes:\n$$\nx(\\eta) - x_c(\\eta) = (\\eta-\\eta_c) - v_p(\\eta-\\eta_c) = (1-v_p)(\\eta-\\eta_c)\n$$\nThe argument of the exponential is therefore $-((1-v_p)(\\eta-\\eta_c))^2 / (2\\sigma^2)$.\nThe full integrand for $\\delta_{\\mathrm{ISW}}$ is twice the partial derivative evaluated along this path:\n$$\n\\text{Integrand}(\\eta) = 2\\,\\Phi_0 \\exp\\!\\Bigg(-\\frac{(1-v_p)^2(\\eta-\\eta_c)^2}{2\\sigma^2}\\Bigg) \\left[ f'(\\eta) + f(\\eta) \\frac{(1-v_p)(\\eta-\\eta_c)v_p}{\\sigma^2} \\right]\n$$\nWe compute $\\delta_{\\text{ISW}} = \\int_{0}^{10} \\text{Integrand}(\\eta) d\\eta$ for the three test cases using the parameters $\\Phi_0=10^{-5}$, $\\sigma=1$, $L=10$, $\\eta_c=5$. The integration domain is $[\\eta_e, \\eta_o] = [0, 10]$.\n\n**Case A (static well):**\n$f(\\eta)=1 \\implies f'(\\eta)=0$. Velocity $v_p=0$.\nThe term in the brackets is $0 + 1 \\cdot (x-x_c) \\cdot 0 / \\sigma^2 = 0$.\nThe integrand is zero everywhere.\n$$\n\\delta_{\\mathrm{ISW}} = 0\n$$\nThis is expected, as a static potential produces no integrated effect.\n\n**Case B (decaying amplitude):**\n$f(\\eta)=(1+(\\eta/\\eta_d)^p)^{-1}$ with $\\eta_d=5, p=2$. Velocity $v_p=0$.\nThe second term in the brackets is zero. We need $f'(\\eta)$:\n$$\nf'(\\eta) = -\\left(1 + \\frac{\\eta^2}{\\eta_d^2}\\right)^{-2} \\left(\\frac{2\\eta}{\\eta_d^2}\\right) = -\\frac{2\\eta}{25\\left(1 + \\eta^2/25\\right)^2}\n$$\nThe integrand simplifies to:\n$$\n\\text{Integrand}(\\eta) = 2\\,\\Phi_0 \\exp\\!\\Bigg(-\\frac{(\\eta-5)^2}{2}\\Bigg) \\left[ -\\frac{2\\eta}{25\\left(1 + \\eta^2/25\\right)^2} \\right]\n$$\nThis integral must be computed numerically.\n\n**Case C (moving well):**\n$f(\\eta)=1 \\implies f'(\\eta)=0$. Velocity $v_p=0.3$.\nThe first term in the brackets is zero. The integrand simplifies to:\n$$\n\\text{Integrand}(\\eta) = 2\\,\\Phi_0 \\exp\\!\\Bigg(-\\frac{(0.7)^2(\\eta-5)^2}{2}\\Bigg) \\left[ \\frac{(0.7)(\\eta-5)(0.3)}{1^2} \\right]\n$$\n$$\n\\text{Integrand}(\\eta) = C \\cdot (\\eta-5) \\cdot \\exp(-k(\\eta-5)^2)\n$$\nwhere $C$ and $k$ are positive constants. This is an odd function with respect to $\\eta=5$. The integral is over the domain $[0, 10]$, which is symmetric about $\\eta=5$. The integral of an odd function over a symmetric interval is zero.\n$$\n\\delta_{\\mathrm{ISW}} = 0\n$$\nThis result demonstrates that a potential well moving with constant velocity and constant intrinsic amplitude ($f(\\eta)=1$) also produces no net integrated effect over a symmetric path. The blueshift experienced by the photon as it approaches the moving well is exactly cancelled by the redshift as it recedes.\n\nThe final step is to implement the numerical integration for Case B and format the results.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.integrate import quad\n\ndef solve():\n    \"\"\"\n    Computes the Integrated Sachs-Wolfe (ISW) effect for three test cases\n    based on a 1D toy model of an evolving gravitational potential.\n    \"\"\"\n\n    # Common parameters for all cases from the problem statement\n    PHI_0 = 1e-5\n    SIGMA = 1.0\n    L = 10.0\n    ETA_C = 5.0\n    \n    # Integration range\n    eta_e = 0.0\n    eta_o = L\n\n    # --- Test Case Definitions ---\n    # Each case is a dictionary of parameters for the potential Phi.\n    # f_eta: The time-varying amplitude function f(eta).\n    # fp_eta: The derivative of f(eta), f'(eta).\n    # vp: The drift speed of the potential well.\n    \n    test_cases = [\n        # Case A: Static well\n        {\n            'f_eta': lambda eta: 1.0,\n            'fp_eta': lambda eta: 0.0,\n            'vp': 0.0\n        },\n        # Case B: Decaying amplitude\n        {\n            'f_eta': lambda eta: 1.0 / (1.0 + (eta / 5.0)**2),\n            'fp_eta': lambda eta: -2.0 * eta / 25.0 / (1.0 + (eta / 5.0)**2)**2,\n            'vp': 0.0\n        },\n        # Case C: Moving well\n        {\n            'f_eta': lambda eta: 1.0,\n            'fp_eta': lambda eta: 0.0,\n            'vp': 0.3\n        }\n    ]\n\n    results = []\n\n    for case in test_cases:\n        f_eta = case['f_eta']\n        fp_eta = case['fp_eta']\n        vp = case['vp']\n\n        def integrand(eta: float) - float:\n            \"\"\"\n            Calculates the value of the integrand for delta_ISW at a given eta.\n            The integrand is 2 * (dPhi/deta), evaluated along the photon path.\n            \"\"\"\n            # Photon path x(eta) = eta - eta_c\n            # Potential center x_c(eta) = vp * (eta - eta_c)\n            eta_minus_etac = eta - ETA_C\n            \n            # Difference between photon and potential center position\n            x_minus_xc = (1.0 - vp) * eta_minus_etac\n            \n            # Gaussian part of the potential\n            exponent = - (x_minus_xc**2) / (2.0 * SIGMA**2)\n            gaussian_term = np.exp(exponent)\n            \n            # Derivative of amplitude function\n            f_prime_val = fp_eta(eta)\n            \n            # Amplitude function value\n            f_val = f_eta(eta)\n\n            # Term from the potential's movement\n            motion_term = f_val * x_minus_xc * vp / (SIGMA**2)\n\n            # The partial derivative d(Phi)/d(eta)\n            dPhi_deta = PHI_0 * gaussian_term * (f_prime_val + motion_term)\n            \n            return 2.0 * dPhi_deta\n\n        # Perform the numerical integration\n        # For cases A and C, the integral is analytically zero.\n        # This check avoids unnecessary numerical computation.\n        if (case['fp_eta'](ETA_C) == 0 and case['vp'] == 0) or \\\n           (case['fp_eta'](ETA_C) == 0 and case['f_eta'](ETA_C) == 1):\n             # The first condition covers case A.\n             # The second covers Case C, where the integrand is an odd function over a symmetric interval.\n            integral_val = 0.0\n        else:\n            integral_val, _ = quad(integrand, eta_e, eta_o)\n\n        results.append(round(integral_val, 10))\n\n    # Format and print the final output as specified\n    print(f\"[{','.join(f'{r:.10f}' for r in results)}]\")\n\nsolve()\n```", "id": "3497946"}, {"introduction": "Moving from idealized toy models to the practicalities of modern cosmology, this final exercise tackles the challenge of computing a realistic line-of-sight integral. The full ISW contribution to the CMB power spectrum involves integrating the time-varying potential, weighted by a spherical Bessel function, from the epoch of last scattering to today. This practice [@problem_id:3497924] guides you through implementing this calculation using composite Gauss-Legendre quadrature, a robust and widely used numerical technique in cosmology codes, and introduces the critical skill of performing convergence tests to ensure the accuracy and reliability of your numerical results.", "problem": "You are tasked with implementing a numerical line-of-sight integral in conformal time for the Integrated Sachs–Wolfe (ISW) source term in a spatially flat, perturbed Friedmann–Lemaître–Robertson–Walker spacetime. Start from the conformal Newtonian gauge with line element $ds^2 = a^2(\\eta)\\left[-(1+2\\Psi)d\\eta^2 + (1-2\\Phi)d\\mathbf{x}^2\\right]$, where $\\eta$ is conformal time, $a(\\eta)$ is the scale factor, and $\\Phi$ and $\\Psi$ are the scalar gravitational potentials. Photons propagating along null geodesics acquire temperature anisotropies sourced by both the instantaneous gravitational redshift at last scattering and the time variation of the gravitational potentials along the line of sight. The Integrated Sachs–Wolfe (ISW) effect arises from the time variation of the potentials and its source term is defined by $S_{\\mathrm{ISW}}(k,\\eta) = \\Phi'(k,\\eta) + \\Psi'(k,\\eta)$, with prime denoting derivative with respect to conformal time $\\eta$ and $k$ the comoving wavenumber.\n\nConsider the line-of-sight multipole-space projection integral of the ISW contribution for a single multipole $\\ell$ and mode $k$,\n$I_\\ell(k) = \\int_{\\eta_*}^{\\eta_0} d\\eta\\, S_{\\mathrm{ISW}}(k,\\eta)\\, j_\\ell\\!\\left(k(\\eta_0-\\eta)\\right)$,\nwhere $j_\\ell$ is the spherical Bessel function of the first kind of order $\\ell$, $\\eta_*$ denotes the conformal time of last scattering, and $\\eta_0$ is the conformal time today. For numerical implementation, adopt the following physically motivated but simplified model for the potentials and their time derivatives:\n- $\\Phi(k,\\eta) = \\Phi_0(k)\\,\\exp\\!\\left(-\\eta/\\eta_d\\right)$,\n- $\\Psi(k,\\eta) = \\left(1+\\epsilon\\right)\\,\\Phi(k,\\eta)$,\nso that $S_{\\mathrm{ISW}}(k,\\eta) = -\\dfrac{\\left(2+\\epsilon\\right)}{\\eta_d}\\,\\Phi_0(k)\\,\\exp\\!\\left(-\\eta/\\eta_d\\right)$.\nAssume the scale dependence $\\Phi_0(k) = \\dfrac{A}{1+\\left(k/k_0\\right)^n}$.\n\nYour task is to implement a composite $n$-point Gaussian quadrature (Gauss–Legendre) for the integral in conformal time over the interval $\\eta \\in [\\eta_*,\\eta_0]$. Partition the interval into $M$ equal subintervals and apply on each subinterval an $n$-point Gauss–Legendre rule; then sum the contributions to approximate $I_\\ell(k)$. To test convergence, evaluate the integral for $M$, $2M$, and $4M$ (that is, halving the subinterval size each time) with a fixed $n$. As a high-accuracy reference $I_\\ell^{\\mathrm{ref}}(k)$, use a much finer composite Gauss–Legendre evaluation with a larger number of subintervals $M_{\\mathrm{ref}}$ and a higher $n_{\\mathrm{ref}}$.\n\nUse units where the speed of light $c=1$, measure conformal time in $\\mathrm{Mpc}$ and wavenumber in $\\mathrm{Mpc}^{-1}$. The output $I_\\ell(k)$ is dimensionless. Angles for special functions must use radians. Your program must implement the spherical Bessel function $j_\\ell$ robustly using a standard scientific library function.\n\nGlobal constants to use for all tests:\n- $\\eta_0 = 14000\\,\\mathrm{Mpc}$,\n- $\\eta_* = 280\\,\\mathrm{Mpc}$,\n- $\\eta_d = 3000\\,\\mathrm{Mpc}$,\n- $\\epsilon = 0.1$,\n- $A = 2\\times 10^{-5}$,\n- $k_0 = 0.02\\,\\mathrm{Mpc}^{-1}$,\n- $n = 2$,\n- Base Gauss–Legendre nodes per subinterval $n_{\\mathrm{GL}} = 4$,\n- Reference composite Gauss–Legendre parameters $M_{\\mathrm{ref}} = 4096$ and $n_{\\mathrm{ref}} = 8$.\n\nImplement the composite Gauss–Legendre quadrature accurately for smooth but potentially oscillatory integrands of the form $S_{\\mathrm{ISW}}(k,\\eta) \\, j_\\ell\\!\\left(k(\\eta_0-\\eta)\\right)$. Ensure numerical stability across the following test suite.\n\nTest suite:\n- Test $1$ (super-horizon-like): $k = 0.001\\,\\mathrm{Mpc}^{-1}$, $\\ell = 2$, $M_0 = 16$.\n- Test $2$ (intermediate): $k = 0.02\\,\\mathrm{Mpc}^{-1}$, $\\ell = 10$, $M_0 = 64$.\n- Test $3$ (oscillatory): $k = 0.1\\,\\mathrm{Mpc}^{-1}$, $\\ell = 30$, $M_0 = 128$.\n\nFor each test case, compute:\n- $I_{M_0}$ using $M_0$ subintervals and $n_{\\mathrm{GL}}$ nodes,\n- $I_{2M_0}$ using $2M_0$ subintervals and $n_{\\mathrm{GL}}$ nodes,\n- $I_{4M_0}$ using $4M_0$ subintervals and $n_{\\mathrm{GL}}$ nodes,\n- $I_{\\mathrm{ref}}$ using $M_{\\mathrm{ref}}$ subintervals and $n_{\\mathrm{ref}}$ nodes,\nand the relative errors\n- $e_{M_0} = \\dfrac{\\left|I_{M_0}-I_{\\mathrm{ref}}\\right|}{\\max\\left(\\left|I_{\\mathrm{ref}}\\right|,10^{-20}\\right)}$,\n- $e_{2M_0} = \\dfrac{\\left|I_{2M_0}-I_{\\mathrm{ref}}\\right|}{\\max\\left(\\left|I_{\\mathrm{ref}}\\right|,10^{-20}\\right)}$,\n- $e_{4M_0} = \\dfrac{\\left|I_{4M_0}-I_{\\mathrm{ref}}\\right|}{\\max\\left(\\left|I_{\\mathrm{ref}}\\right|,10^{-20}\\right)}$.\n\nFinal output format:\n- Your program should produce a single line of output containing a list of lists, one inner list per test case, with each inner list containing the $7$ floats in the following order:\n$[I_{M_0}, I_{2M_0}, I_{4M_0}, I_{\\mathrm{ref}}, e_{M_0}, e_{2M_0}, e_{4M_0}]$.\n- The line must be formatted exactly as a comma-separated list with no spaces, enclosed in square brackets, for example:\n$[[r_{11},r_{12},\\dots,r_{17}],[r_{21},\\dots,r_{27}],[r_{31},\\dots,r_{37}]]$,\nwhere each $r_{ij}$ is a floating-point number in decimal notation.", "solution": "The problem requires the numerical evaluation of the Integrated Sachs-Wolfe (ISW) contribution to the cosmic microwave background temperature anisotropy for a specific multipole $\\ell$ and comoving wavenumber $k$.\n\nFirst, we must validate the problem statement.\n\n### Step 1: Extract Givens\n-   **Line element in conformal Newtonian gauge**: $ds^2 = a^2(\\eta)\\left[-(1+2\\Psi)d\\eta^2 + (1-2\\Phi)d\\mathbf{x}^2\\right]$.\n-   **ISW source term**: $S_{\\mathrm{ISW}}(k,\\eta) = \\Phi'(k,\\eta) + \\Psi'(k,\\eta)$, where prime denotes $\\frac{d}{d\\eta}$.\n-   **Line-of-sight integral**: $I_\\ell(k) = \\int_{\\eta_*}^{\\eta_0} d\\eta\\, S_{\\mathrm{ISW}}(k,\\eta)\\, j_\\ell\\!\\left(k(\\eta_0-\\eta)\\right)$.\n-   **Integration limits**: Conformal time of last scattering $\\eta_*$ and today $\\eta_0$.\n-   **Model for potentials**:\n    -   $\\Phi(k,\\eta) = \\Phi_0(k)\\,\\exp\\!\\left(-\\eta/\\eta_d\\right)$.\n    -   $\\Psi(k,\\eta) = \\left(1+\\epsilon\\right)\\,\\Phi(k,\\eta)$.\n-   **Resulting ISW source term**: $S_{\\mathrm{ISW}}(k,\\eta) = -\\dfrac{\\left(2+\\epsilon\\right)}{\\eta_d}\\,\\Phi_0(k)\\,\\exp\\!\\left(-\\eta/\\eta_d\\right)$.\n-   **Scale dependence of potential**: $\\Phi_0(k) = \\dfrac{A}{1+\\left(k/k_0\\right)^n}$.\n-   **Numerical method**: Composite $n$-point Gauss–Legendre quadrature with $M$ equal subintervals.\n-   **Global constants**:\n    -   $\\eta_0 = 14000\\,\\mathrm{Mpc}$.\n    -   $\\eta_* = 280\\,\\mathrm{Mpc}$.\n    -   $\\eta_d = 3000\\,\\mathrm{Mpc}$.\n    -   $\\epsilon = 0.1$.\n    -   $A = 2\\times 10^{-5}$.\n    -   $k_0 = 0.02\\,\\mathrm{Mpc}^{-1}$.\n    -   $n = 2$.\n    -   Base quadrature nodes: $n_{\\mathrm{GL}} = 4$.\n    -   Reference quadrature parameters: $M_{\\mathrm{ref}} = 4096$, $n_{\\mathrm{ref}} = 8$.\n-   **Test suite**:\n    -   Test $1$: $k = 0.001\\,\\mathrm{Mpc}^{-1}$, $\\ell = 2$, $M_0 = 16$.\n    -   Test $2$: $k = 0.02\\,\\mathrm{Mpc}^{-1}$, $\\ell = 10$, $M_0 = 64$.\n    -   Test $3$: $k = 0.1\\,\\mathrm{Mpc}^{-1}$, $\\ell = 30$, $M_0 = 128$.\n-   **Required computations**: $I_{M_0}$, $I_{2M_0}$, $I_{4M_0}$, $I_{\\mathrm{ref}}$ and relative errors $e_{M_0}$, $e_{2M_0}$, $e_{4M_0}$.\n-   **Relative error definition**: $e_{X} = \\dfrac{\\left|I_{X}-I_{\\mathrm{ref}}\\right|}{\\max\\left(\\left|I_{\\mathrm{ref}}\\right|,10^{-20}\\right)}$.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is well-posed and scientifically grounded. It presents a standard calculation in physical cosmology, specifically the line-of-sight integration of a source term for CMB anisotropies. The provided models for the gravitational potentials are simplified but physically motivated, representing the decay of potentials during the late-time acceleration of the Universe (the \"late\" ISW effect). The derivation of $S_{\\mathrm{ISW}}(k,\\eta)$ from the given $\\Phi$ and $\\Psi$ is correct. All parameters, constants, and functions are explicitly defined, and the task is a direct application of a specified numerical method (composite Gauss-Legendre quadrature) to a well-defined integral. The problem is free from contradictions, ambiguities, and factual errors.\n\n### Step 3: Verdict and Action\nThe problem is valid. A reasoned solution will be provided.\n\n### Principle-Based Solution Design\n\nThe core task is to compute the definite integral $I_\\ell(k) = \\int_{\\eta_*}^{\\eta_0} d\\eta\\, f_{\\ell,k}(\\eta)$, where the integrand is given by\n$$\nf_{\\ell,k}(\\eta) = S_{\\mathrm{ISW}}(k,\\eta)\\, j_\\ell\\!\\left(k(\\eta_0-\\eta)\\right)\n$$\nThe ISW source term $S_{\\mathrm{ISW}}(k,\\eta)$ is constructed from the provided models for the potentials $\\Phi(k, \\eta)$ and $\\Psi(k, \\eta)$.\n$$\nS_{\\mathrm{ISW}}(k,\\eta) = \\frac{d}{d\\eta} \\left[ \\Phi(k,\\eta) + \\Psi(k,\\eta) \\right] = (2+\\epsilon) \\frac{d}{d\\eta} \\left[ \\Phi_0(k) e^{-\\eta/\\eta_d} \\right] = -\\frac{2+\\epsilon}{\\eta_d} \\Phi_0(k) e^{-\\eta/\\eta_d}\n$$\nThe scale-dependent part is $\\Phi_0(k) = \\frac{A}{1+(k/k_0)^n}$.\nPutting it all together, the integrand is:\n$$\nf_{\\ell,k}(\\eta) = \\left[ -\\frac{A(2+\\epsilon)}{\\eta_d \\left(1+(k/k_0)^n\\right)} \\right] e^{-\\eta/\\eta_d} j_\\ell\\!\\left(k(\\eta_0-\\eta)\\right)\n$$\nThe term in square brackets is a constant prefactor for a given $k$, which can be calculated once per integral. The spherical Bessel function of the first kind, $j_\\ell(x)$, and the exponential function are standard library functions.\n\nThe numerical method is a composite Gauss-Legendre quadrature. To evaluate an integral $\\int_a^b g(x) dx$, we partition the interval $[a, b]$ into $M$ equal subintervals. In our case, $a=\\eta_*$ and $b=\\eta_0$. The width of each subinterval is $h = (\\eta_0 - \\eta_*)/M$. The $i$-th subinterval is $[\\eta_i, \\eta_{i+1}] = [\\eta_*+ih, \\eta_*+(i+1)h]$ for $i = 0, 1, \\dots, M-1$.\n\nThe integral over a single subinterval is approximated by an $n_{\\mathrm{GL}}$-point Gauss-Legendre rule. This involves a change of variables from $\\eta \\in [\\eta_i, \\eta_{i+1}]$ to a canonical variable $t \\in [-1, 1]$:\n$$\n\\eta(t) = \\frac{\\eta_{i+1}-\\eta_i}{2} t + \\frac{\\eta_{i+1}+\\eta_i}{2} = \\frac{h}{2} t + \\left(\\eta_* + (i+1/2)h\\right)\n$$\nThe differential becomes $d\\eta = \\frac{h}{2} dt$. The integral over the subinterval is then:\n$$\n\\int_{\\eta_i}^{\\eta_{i+1}} f_{\\ell,k}(\\eta) d\\eta = \\int_{-1}^{1} f_{\\ell,k}(\\eta(t)) \\frac{h}{2} dt \\approx \\frac{h}{2} \\sum_{j=1}^{n_{\\mathrm{GL}}} w_j f_{\\ell,k}(\\eta(t_j))\n$$\nwhere $t_j$ and $w_j$ are the nodes and weights of the $n_{\\mathrm{GL}}$-point Gauss-Legendre quadrature on $[-1, 1]$.\n\nThe total integral is the sum of the contributions from all $M$ subintervals:\n$$\nI_\\ell(k) \\approx \\sum_{i=0}^{M-1} \\left( \\frac{h}{2} \\sum_{j=1}^{n_{\\mathrm{GL}}} w_j f_{\\ell,k}\\left( \\eta_* + h(i + \\frac{1+t_j}{2}) \\right) \\right)\n$$\nThis formula is robust and will be implemented. The nodes $t_j$ and weights $w_j$ will be obtained from `scipy.special.roots_legendre`. The spherical Bessel function $j_\\ell(x)$ will be computed using `scipy.special.spherical_jn`.\n\nThe algorithm proceeds as follows:\n$1.$ Define a function `composite_gauss_legendre` that takes as input the integrand function, the integration limits $[\\eta_*, \\eta_0]$, the number of subintervals $M$, and the number of quadrature points per subinterval $n_{\\mathrm{GL}}$.\n$2.$ This function will first obtain the standard Legendre nodes and weights for $n_{\\mathrm{GL}}$ points.\n$3.$ It will then iterate from $i=0$ to $M-1$, and for each subinterval, it will perform the weighted sum over the $n_{\\mathrm{GL}}$ transformed nodes, accumulating the result. The factor of $h/2$ is applied to the final sum.\n$4.$ For each test case defined in the problem, we will define the specific integrand using the given parameters $(k, \\ell)$.\n$5.$ We will call the quadrature function four times to compute $I_{M_0}$, $I_{2M_0}$, $I_{4M_0}$ (with $n_{\\mathrm{GL}}=4$) and the high-accuracy reference $I_{\\mathrm{ref}}$ (with $M_{\\mathrm{ref}}$ and $n_{\\mathrm{ref}}=8$).\n$6.$ Finally, we will calculate the three relative errors $e_{M_0}, e_{2M_0}, e_{4M_0}$ using the specified formula, which includes a floor value of $10^{-20}$ for the divisor to ensure numerical stability.\n$7.$ The seven quantities for each test case will be collected and formatted into the required string output.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import spherical_jn, roots_legendre\n\ndef solve():\n    \"\"\"\n    Solves the numerical integration problem for the ISW effect.\n    \"\"\"\n    # Global constants\n    ETA_0 = 14000.0   # Conformal time today [Mpc]\n    ETA_STAR = 280.0  # Conformal time at last scattering [Mpc]\n    ETA_D = 3000.0    # Decay time scale for potentials [Mpc]\n    EPSILON = 0.1     # Anisotropic stress parameter, (Psi = (1+epsilon)*Phi)\n    A = 2.0e-5        # Amplitude of primordial potential\n    K0 = 0.02         # Pivot scale for potential [Mpc^-1]\n    N_SCALAR = 2.0    # Scalar index for potential model\n    N_GL = 4          # Base Gauss-Legendre nodes per subinterval\n    M_REF = 4096      # Number of subintervals for reference calculation\n    N_REF = 8         # Number of nodes for reference calculation\n\n    # Test suite from the problem statement\n    test_cases = [\n        # (k [Mpc^-1], l, M0)\n        (0.001, 2, 16),\n        (0.02, 10, 64),\n        (0.1, 30, 128),\n    ]\n\n    memoized_roots = {}\n\n    def get_roots(n_points):\n        \"\"\"Memoize Gauss-Legendre roots and weights.\"\"\"\n        if n_points not in memoized_roots:\n            memoized_roots[n_points] = roots_legendre(n_points)\n        return memoized_roots[n_points]\n\n    def isw_integrand(eta, k, l, s_prefactor):\n        \"\"\"\n        Calculates the value of the ISW integrand at a given conformal time eta.\n        \"\"\"\n        arg_bessel = k * (ETA_0 - eta)\n        bessel_val = spherical_jn(l, arg_bessel)\n        exp_val = np.exp(-eta / ETA_D)\n        return s_prefactor * exp_val * bessel_val\n\n    def composite_gauss_legendre(integrand_func, m, n_points):\n        \"\"\"\n        Performs composite Gauss-Legendre quadrature.\n\n        Args:\n            integrand_func: The function to integrate, taking eta as an argument.\n            m: The number of subintervals.\n            n_points: The number of Gauss-Legendre nodes per subinterval.\n\n        Returns:\n            The numerical value of the integral.\n        \"\"\"\n        if m == 0:\n            return 0.0\n            \n        a, b = ETA_STAR, ETA_0\n        h = (b - a) / m\n        nodes, weights = get_roots(n_points)\n\n        total_integral = 0.0\n        \n        # Vectorized evaluation for efficiency\n        # Create an array of all evaluation points\n        # i_indices is broadcasted to (m, 1)\n        # nodes is broadcasted to (1, n_points)\n        i_indices = np.arange(m).reshape(-1, 1)\n        # Transformation from canonical interval [-1, 1] to each subinterval\n        eta_eval_points = a + h * (i_indices + (1.0 + nodes) / 2.0)\n        \n        integrand_values = integrand_func(eta_eval_points)\n        \n        # Sum over nodes (axis=1) and then over subintervals (axis=0)\n        total_integral = (h / 2.0) * np.sum(integrand_values @ weights)\n\n        return total_integral\n\n    results = []\n    for k, l, m0 in test_cases:\n        # Pre-calculate the constant part of the integrand source term\n        phi0_k = A / (1.0 + (k / K0)**N_SCALAR)\n        s_prefactor = -(2.0 + EPSILON) / ETA_D * phi0_k\n\n        # Create a specific integrand function for the current (k, l)\n        integrand = lambda eta: isw_integrand(eta, k, l, s_prefactor)\n\n        # Calculate the integrals for M0, 2*M0, 4*M0\n        i_m0 = composite_gauss_legendre(integrand, m0, N_GL)\n        i_2m0 = composite_gauss_legendre(integrand, 2 * m0, N_GL)\n        i_4m0 = composite_gauss_legendre(integrand, 4 * m0, N_GL)\n        \n        # Calculate the high-accuracy reference integral\n        i_ref = composite_gauss_legendre(integrand, M_REF, N_REF)\n        \n        # Calculate relative errors\n        ref_abs = abs(i_ref)\n        denominator = max(ref_abs, 1.0e-20)\n        \n        e_m0 = abs(i_m0 - i_ref) / denominator\n        e_2m0 = abs(i_2m0 - i_ref) / denominator\n        e_4m0 = abs(i_4m0 - i_ref) / denominator\n\n        # Collect the 7 required float values for the current test case\n        case_results = [i_m0, i_2m0, i_4m0, i_ref, e_m0, e_2m0, e_4m0]\n        results.append(case_results)\n\n    # Format the final output string exactly as specified\n    outer_list_str = \",\".join([f\"[{','.join([f'{val:.15e}' for val in inner_list])}]\" for inner_list in results])\n    print(f\"[{outer_list_str}]\")\n\n\nsolve()\n```", "id": "3497924"}]}