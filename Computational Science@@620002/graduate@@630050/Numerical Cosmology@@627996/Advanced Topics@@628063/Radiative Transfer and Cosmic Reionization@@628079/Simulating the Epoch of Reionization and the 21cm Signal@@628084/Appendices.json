{"hands_on_practices": [{"introduction": "At the core of simulating the Epoch of Reionization lies the challenge of accurately tracking the movement of countless ionizing photons through the cosmos. This exercise [@problem_id:3488852] takes you to the foundational level of this task: building a numerical radiative transfer solver. By deriving and implementing a photon-conserving, finite-volume scheme, you will gain first-hand experience with the methods that ensure physical fidelity in large-scale simulations, including the crucial role of implicit time-stepping in handling optically thick regions.", "problem": "Consider the numerical transport of hydrogen-ionizing photons during the Epoch of Reionization (EoR). A photon-conserving finite-volume discretization should advance the photon count in each control volume such that the global photon budget exactly balances source emission, boundary fluxes, and absorptions. Start from the photon number conservation law in integral form over a Cartesian control volume, which follows from the radiative transfer equation in the grey (single-frequency-bin) approximation: the time rate of change of photons inside a cell equals the net photon inflow through the faces plus in-cell emission minus absorptions. Let the speed of light be $c$ in $\\mathrm{m\\,s^{-1}}$, let the absorption coefficient be $\\kappa$ in $\\mathrm{m^{-1}}$, let the photon source rate density be $S$ in $\\mathrm{photons\\,m^{-3}\\,s^{-1}}$, and let the photon number density be $n_{\\gamma}$ in $\\mathrm{photons\\,m^{-3}}$. The sink rate density is $c\\,\\kappa\\,n_{\\gamma}$ in $\\mathrm{photons\\,m^{-3}\\,s^{-1}}$. For a uniform Cartesian mesh with cell volume $V$ and faces of area $A$, define the per-cell photon count $N_i = \\int_{V_i} n_{\\gamma}\\,\\mathrm{d}V$ in $\\mathrm{photons}$ and the face photon rate $\\Phi_{i\\pm\\frac{1}{2}} = \\int_{A_{i\\pm\\frac{1}{2}}} \\boldsymbol{F}\\cdot\\mathrm{d}\\boldsymbol{A}$ in $\\mathrm{photons\\,s^{-1}}$, where $\\boldsymbol{F}$ is the photon number flux density in $\\mathrm{photons\\,m^{-2}\\,s^{-1}}$. Assume a one-dimensional mesh along $x$ with uniform cells indexed by $i \\in \\{0,\\dots,N_x-1\\}$ and faces at $i\\pm\\frac{1}{2}$; the outward normal at the right face is in the $+\\hat{x}$ direction, so a positive $\\Phi$ transports photons to increasing $x$. Let the volume-integrated source in cell $i$ be $S_i V$ in $\\mathrm{photons\\,s^{-1}}$, denoted by $Q_i$.\n\nYour task:\n\n1) Derive a discrete, photon-conserving, finite-volume update rule for the per-cell photon counts over a time step $\\Delta t$ in $\\mathrm{s}$ that is fully implicit in the absorption sink term to ensure positivity and robustness for stiff absorption. The update must be expressed in terms of cell-wise quantities $N_i^n$ and $N_i^{n+1}$ in $\\mathrm{photons}$, face photon rates $\\Phi_{i\\pm\\frac{1}{2}}$ in $\\mathrm{photons\\,s^{-1}}$, cell-integrated source rates $Q_i$ in $\\mathrm{photons\\,s^{-1}}$, the speed of light $c$ in $\\mathrm{m\\,s^{-1}}$, and the absorption coefficient $\\kappa_i$ in $\\mathrm{m^{-1}}$.\n\n2) Implement the derived update rule for a one-dimensional mesh where the geometry is absorbed into the definitions of $N_i$ and $\\Phi_{i\\pm\\frac{1}{2}}$ as above, so that the flux contribution to $N_i$ over $\\Delta t$ is $-\\Delta t\\,(\\Phi_{i+\\frac{1}{2}}-\\Phi_{i-\\frac{1}{2}})$ in $\\mathrm{photons}$.\n\n3) For each test case below, perform one time step and compute the absolute global conservation residual $R$ in $\\mathrm{photons}$ defined by\n$$\nR \\equiv \\left|\\left(\\sum_{i=0}^{N_x-1} N_i^{n+1}-\\sum_{i=0}^{N_x-1} N_i^{n}\\right) - \\left(-\\Delta t\\,\\big(\\Phi_{N_x-\\frac{1}{2}}-\\Phi_{-\\frac{1}{2}}\\big) + \\Delta t\\,\\sum_{i=0}^{N_x-1} Q_i - \\Delta t\\,\\sum_{i=0}^{N_x-1} c\\,\\kappa_i\\,N_i^{n+1}\\right)\\right| ,\n$$\nwhere $\\Phi_{-\\frac{1}{2}}$ and $\\Phi_{N_x-\\frac{1}{2}}$ are the left and right boundary face photon rates, respectively. A photon-conserving scheme should yield $R$ that is compatible with roundoff.\n\nExpress the final answers for the residuals $R$ in $\\mathrm{photons}$ using scientific notation with six significant figures.\n\nTest suite (all quantities are to be interpreted in the units specified above):\n\n- Case A (happy path): $N_x = 4$, initial per-cell photon counts $[N_0^n,N_1^n,N_2^n,N_3^n] = [10^6, 2\\times 10^6, 5\\times 10^5, 1.5\\times 10^6]$, face photon rates $[\\Phi_{-\\frac{1}{2}},\\Phi_{\\frac{1}{2}},\\Phi_{\\frac{3}{2}},\\Phi_{\\frac{5}{2}},\\Phi_{\\frac{7}{2}}] = [10^5, 5\\times 10^4, -2\\times 10^4, 0, -5\\times 10^4]$, cell-integrated source rates $[Q_0,Q_1,Q_2,Q_3] = [10^4, 0, 2\\times 10^4, 0]$, uniform absorption coefficient $\\kappa_i = 10^{-10}$ for all $i$, $\\Delta t = 10^{-1}$, $c = 2.99792458\\times 10^8$.\n\n- Case B (zero-flux boundaries, sources and absorption only): $N_x = 3$, initial $[N_0^n,N_1^n,N_2^n] = [0,0,0]$, faces $[\\Phi_{-\\frac{1}{2}},\\Phi_{\\frac{1}{2}},\\Phi_{\\frac{3}{2}},\\Phi_{\\frac{5}{2}}] = [0,0,0,0]$, sources $[Q_0,Q_1,Q_2] = [10^5,10^5,10^5]$, $\\kappa_i = 10^{-9}$ for all $i$, $\\Delta t = 1$, $c = 2.99792458\\times 10^8$.\n\n- Case C (vacuum, check strict conservation with sources and balanced boundary fluxes): $N_x = 2$, initial $[N_0^n,N_1^n] = [10^3, 2\\times 10^3]$, faces $[\\Phi_{-\\frac{1}{2}},\\Phi_{\\frac{1}{2}},\\Phi_{\\frac{3}{2}}] = [10^2,10^2,10^2]$, sources $[Q_0,Q_1] = [0,10^2]$, $\\kappa_i = 0$ for all $i$, $\\Delta t = 10$, $c = 2.99792458\\times 10^8$.\n\n- Case D (stiff absorption, positivity under implicit sink): $N_x = 1$, initial $[N_0^n] = [10^9]$, faces $[\\Phi_{-\\frac{1}{2}},\\Phi_{\\frac{1}{2}}] = [0,0]$, sources $[Q_0] = [10^8]$, $\\kappa_0 = 1$, $\\Delta t = 10^{-9}$, $c = 2.99792458\\times 10^8$.\n\n- Case E (net inflow from boundaries, no sources, no absorption): $N_x = 3$, initial $[N_0^n,N_1^n,N_2^n] = [10^4,2\\times 10^4,3\\times 10^4]$, faces $[\\Phi_{-\\frac{1}{2}},\\Phi_{\\frac{1}{2}},\\Phi_{\\frac{3}{2}},\\Phi_{\\frac{5}{2}}] = [5\\times 10^3,0,0,-5\\times 10^3]$, sources $[Q_0,Q_1,Q_2] = [0,0,0]$, $\\kappa_i = 0$ for all $i$, $\\Delta t = 1$, $c = 2.99792458\\times 10^8$.\n\nYour program should produce a single line of output containing the residuals as a comma-separated list enclosed in square brackets (e.g., $[r_A,r_B,r_C,r_D,r_E]$), where each $r$ is the absolute residual $R$ for the corresponding case formatted in scientific notation with six significant figures. All residuals must be reported in $\\mathrm{photons}$.", "solution": "The user's request is to derive a photon-conserving finite-volume update rule for radiative transfer and apply it to a series of test cases, reporting the global conservation residual for each.\n\nThe problem is valid as it is scientifically grounded in the principles of radiative transfer, mathematically well-posed, objective, and provides a complete and consistent set of data and definitions. The task is a standard exercise in numerical methods for conservation laws. I will now proceed with the derivation and implementation.\n\n**1. Derivation of the Finite-Volume Update Rule**\n\nThe fundamental principle is the conservation of photon number within a control volume $V_i$. The time rate of change of the number of photons in $V_i$ equals the net rate of photons entering the volume plus the rate of internal emission, minus the rate of internal absorption. This is expressed by the integral form of the transport equation:\n$$\n\\frac{\\mathrm{d}}{\\mathrm{d}t} \\int_{V_i} n_{\\gamma}\\,\\mathrm{d}V = -\\oint_{\\partial V_i} \\boldsymbol{F}\\cdot\\mathrm{d}\\boldsymbol{A} + \\int_{V_i} S\\,\\mathrm{d}V - \\int_{V_i} c\\,\\kappa\\,n_{\\gamma}\\,\\mathrm{d}V\n$$\nHere, $n_{\\gamma}$ is the photon number density, $\\boldsymbol{F}$ is the photon number flux density, $S$ is the source rate density, $c$ is the speed of light, and $\\kappa$ is the absorption coefficient.\n\nWe translate this into the problem's discrete quantities:\n- The per-cell photon count in cell $i$ is $N_i(t) = \\int_{V_i} n_{\\gamma}\\,\\mathrm{d}V$.\n- The cell-integrated source rate is $Q_i = \\int_{V_i} S\\,\\mathrm{d}V$.\n- Assuming the absorption coefficient $\\kappa_i$ is constant within a cell, the volume-integrated absorption rate is $\\int_{V_i} c\\,\\kappa\\,n_{\\gamma}\\,\\mathrm{d}V = c\\,\\kappa_i \\int_{V_i} n_{\\gamma}\\,\\mathrm{d}V = c\\,\\kappa_i N_i(t)$.\n- In one dimension, the surface integral $\\oint_{\\partial V_i} \\boldsymbol{F}\\cdot\\mathrm{d}\\boldsymbol{A}$ represents the net flux out of the cell. The problem defines the face photon rate $\\Phi_{i \\pm \\frac{1}{2}}$ as the rate of photons crossing the face in the $+\\hat{x}$ direction. The net flux out of cell $i$ is the outflow rate at the right face ($i+\\frac{1}{2}$) minus the inflow rate at the left face ($i-\\frac{1}{2}$). This corresponds to $\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}$.\n\nSubstituting these discrete quantities into the conservation law gives the semi-discrete ordinary differential equation for $N_i$:\n$$\n\\frac{\\mathrm{d}N_i}{\\mathrm{d}t} = -(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}) + Q_i - c\\,\\kappa_i N_i\n$$\nTo discretize in time over a step $\\Delta t$ from $t^n$ to $t^{n+1}$, we approximate the derivative as $\\frac{N_i^{n+1} - N_i^n}{\\Delta t}$. The problem requires the absorption sink term to be treated implicitly, meaning it is evaluated at the new time level $t^{n+1}$. The source and flux terms are treated as constant over the time step. This mixed explicit-implicit (IMEX) scheme is written as:\n$$\n\\frac{N_i^{n+1} - N_i^n}{\\Delta t} = -(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}) + Q_i - c\\,\\kappa_i N_i^{n+1}\n$$\nTo find the update rule, we solve for $N_i^{n+1}$. First, multiply by $\\Delta t$:\n$$\nN_i^{n+1} - N_i^n = \\Delta t \\left[ -(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}) + Q_i \\right] - \\Delta t\\,c\\,\\kappa_i N_i^{n+1}\n$$\nNext, group all terms involving $N_i^{n+1}$ on the left-hand side:\n$$\nN_i^{n+1} + \\Delta t\\,c\\,\\kappa_i N_i^{n+1} = N_i^n - \\Delta t(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}) + \\Delta t\\,Q_i\n$$\nFactor out $N_i^{n+1}$:\n$$\nN_i^{n+1}(1 + c\\,\\kappa_i\\,\\Delta t) = N_i^n + \\Delta t\\,Q_i - \\Delta t(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}})\n$$\nFinally, dividing by the term in parentheses yields the explicit update rule for $N_i^{n+1}$:\n$$\nN_i^{n+1} = \\frac{N_i^n + \\Delta t\\,Q_i - \\Delta t\\,(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}})}{1 + c\\,\\kappa_i\\,\\Delta t}\n$$\nThis equation is implemented for each cell $i=0, \\dots, N_x-1$ to compute the state at time $t^{n+1}$. This implicit treatment of the sink term guarantees positivity of $N_i^{n+1}$ for non-negative inputs.\n\n**2. Global Conservation and the Residual R**\n\nThe problem defines the absolute global conservation residual $R$ to verify the scheme. By summing our update rule over all cells, we can show that the scheme is perfectly conserving by construction. Rearranging our time-discrete equation before solving for $N_i^{n+1}$:\n$$\n(N_i^{n+1} - N_i^n) - \\left[ -\\Delta t(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}) + \\Delta t\\,Q_i - \\Delta t\\,c\\,\\kappa_i N_i^{n+1} \\right] = 0\n$$\nSumming over all cells $i=0, \\dots, N_x-1$:\n$$\n\\sum_{i=0}^{N_x-1}(N_i^{n+1} - N_i^n) - \\left[ -\\Delta t \\sum_{i=0}^{N_x-1}(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}) + \\Delta t \\sum_{i=0}^{N_x-1} Q_i - \\Delta t \\sum_{i=0}^{N_x-1} c\\,\\kappa_i N_i^{n+1} \\right] = 0\n$$\nThe sum over fluxes forms a telescoping series:\n$$\n\\sum_{i=0}^{N_x-1}(\\Phi_{i+\\frac{1}{2}} - \\Phi_{i-\\frac{1}{2}}) = (\\Phi_{\\frac{1}{2}} - \\Phi_{-\\frac{1}{2}}) + (\\Phi_{\\frac{3}{2}} - \\Phi_{\\frac{1}{2}}) + \\dots + (\\Phi_{N_x-\\frac{1}{2}} - \\Phi_{N_x-\\frac{3}{2}}) = \\Phi_{N_x-\\frac{1}{2}} - \\Phi_{-\\frac{1}{2}}\n$$\nSubstituting this back gives the global conservation equation:\n$$\n\\left(\\sum_{i=0}^{N_x-1}N_i^{n+1} - \\sum_{i=0}^{N_x-1}N_i^{n}\\right) - \\left[ -\\Delta t (\\Phi_{N_x-\\frac{1}{2}} - \\Phi_{-\\frac{1}{2}}) + \\Delta t \\sum_{i=0}^{N_x-1} Q_i - \\Delta t \\sum_{i=0}^{N_x-1} c\\,\\kappa_i N_i^{n+1} \\right] = 0\n$$\nThe expression inside the absolute value for the residual $R$ is precisely this equation. Therefore, if the update rule is implemented correctly, $R$ will be zero up to floating-point roundoff error. The implementation below calculates $N_i^{n+1}$ for all cells according to the derived formula and then evaluates $R$ to confirm this property.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Derives and implements a photon-conserving finite-volume update rule for \n    radiative transfer, calculates the global conservation residual for a suite \n    of test cases, and prints the results in the specified format.\n    \"\"\"\n    \n    # Define the speed of light, c, in m/s\n    c = 2.99792458e8\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case A: Happy path\n        {'Nx': 4, 'Nn': np.array([1e6, 2e6, 5e5, 1.5e6], dtype=np.float64),\n         'Phi': np.array([1e5, 5e4, -2e4, 0, -5e4], dtype=np.float64),\n         'Q': np.array([1e4, 0, 2e4, 0], dtype=np.float64),\n         'kappa': np.full(4, 1e-10, dtype=np.float64), 'dt': 1e-1},\n        \n        # Case B: Zero-flux boundaries, sources and absorption only\n        {'Nx': 3, 'Nn': np.array([0., 0., 0.], dtype=np.float64),\n         'Phi': np.array([0., 0., 0., 0.], dtype=np.float64),\n         'Q': np.array([1e5, 1e5, 1e5], dtype=np.float64),\n         'kappa': np.full(3, 1e-9, dtype=np.float64), 'dt': 1.0},\n        \n        # Case C: Vacuum, check strict conservation with sources and balanced boundary fluxes\n        {'Nx': 2, 'Nn': np.array([1e3, 2e3], dtype=np.float64),\n         'Phi': np.array([100., 100., 100.], dtype=np.float64),\n         'Q': np.array([0., 100.], dtype=np.float64),\n         'kappa': np.full(2, 0.0, dtype=np.float64), 'dt': 10.0},\n        \n        # Case D: Stiff absorption, positivity under implicit sink\n        {'Nx': 1, 'Nn': np.array([1e9], dtype=np.float64),\n         'Phi': np.array([0., 0.], dtype=np.float64),\n         'Q': np.array([1e8], dtype=np.float64),\n         'kappa': np.array([1.0], dtype=np.float64), 'dt': 1e-9},\n        \n        # Case E: Net inflow from boundaries, no sources, no absorption\n        {'Nx': 3, 'Nn': np.array([1e4, 2e4, 3e4], dtype=np.float64),\n         'Phi': np.array([5e3, 0., 0., -5e3], dtype=np.float64),\n         'Q': np.array([0., 0., 0.], dtype=np.float64),\n         'kappa': np.full(3, 0.0, dtype=np.float64), 'dt': 1.0}\n    ]\n\n    residuals = []\n    for case in test_cases:\n        # Unpack parameters for the current test case\n        Nx = case['Nx']\n        Nn = case['Nn']\n        Phi = case['Phi']\n        Q = case['Q']\n        kappa = case['kappa']\n        dt = case['dt']\n\n        # Array to store the new photon counts\n        Nn_plus_1 = np.zeros(Nx, dtype=np.float64)\n\n        # Apply the update rule for each cell\n        for i in range(Nx):\n            # Flux divergence for cell i\n            flux_diff = Phi[i+1] - Phi[i]\n            \n            # Numerator of the update rule\n            numerator = Nn[i] + dt * Q[i] - dt * flux_diff\n            \n            # Denominator of the update rule (implicit sink term)\n            denominator = 1.0 + c * kappa[i] * dt\n            \n            Nn_plus_1[i] = numerator / denominator\n\n        # Calculate the absolute global conservation residual R\n        \n        # Total change in photon number in the domain\n        total_change_N = np.sum(Nn_plus_1) - np.sum(Nn)\n        \n        # Total contribution from boundary fluxes\n        # The term phi_Nx-1/2 corresponds to Phi[Nx] and phi_-1/2 to Phi[0]\n        boundary_flux_term = -dt * (Phi[Nx] - Phi[0])\n        \n        # Total contribution from internal sources\n        source_term = dt * np.sum(Q)\n        \n        # Total contribution from absorption sinks (using new state Nn+1)\n        sink_term = -dt * c * np.sum(kappa * Nn_plus_1)\n        \n        # Sum of all photon changes due to fluxes, sources, and sinks\n        total_contributions = boundary_flux_term + source_term + sink_term\n        \n        # The residual is the absolute difference, which should be near zero\n        residual = abs(total_change_N - total_contributions)\n        residuals.append(residual)\n\n    # Format the final results as specified: scientific notation with six significant figures\n    # The format specifier '.5e' gives one digit before the decimal and five after.\n    formatted_results = [f\"{r:.5e}\" for r in residuals]\n    \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "3488852"}, {"introduction": "While full radiative transfer simulations are highly accurate, their computational cost has spurred the development of faster, \"semi-numerical\" models. This practice [@problem_id:3488937] delves into the mechanics and potential pitfalls of these approximate methods. You will first implement a simple \"union-of-spheres\" model to generate an ionization map and discover how such naive approaches can violate the fundamental principle of photon conservation, then engineer a more sophisticated correction that enforces this conservation by construction, offering a clear lesson on the trade-offs between computational efficiency and physical accuracy.", "problem": "You are given a simplified, self-consistent numerical experiment to diagnose and correct photon non-conservation in naive ionization bubble painting during the cosmic Epoch of Reionization. Work in a cubic, comoving domain of side length $L_{\\mathrm{box}}$ (in comoving megaparsecs, cMpc), discretized into a uniform Cartesian grid with $N^3$ voxels of side length $\\Delta x = L_{\\mathrm{box}}/N$ (in cMpc) and cell comoving volume $V_{\\mathrm{cell}} = \\Delta x^3$ (in $\\mathrm{cMpc}^3$). Assume a uniform baryon density, ignore recombinations and helium, and take the hydrogen mass fraction to be $X_{\\mathrm{p}}$. The present-day critical density is $\\rho_{\\mathrm{crit},0} = 3 H_0^2/(8\\pi G)$, so the present-day comoving hydrogen number density (in $\\mathrm{cMpc}^{-3}$) is $n_{\\mathrm{H},0} = X_{\\mathrm{p}} \\, \\Omega_{\\mathrm{b}} \\, \\rho_{\\mathrm{crit},0} / m_{\\mathrm{p}}$, converted from $\\mathrm{m}^{-3}$ to $\\mathrm{cMpc}^{-3}$ using the exact metric conversion, where $H_0$ is the Hubble constant today, $G$ is Newton’s constant, $\\Omega_{\\mathrm{b}}$ is the present-day baryon density parameter, and $m_{\\mathrm{p}}$ is the proton mass. You are provided a set of discrete ionizing sources at positions $\\{\\mathbf{x}_i\\}$ (in cMpc) with effective collapsed fractions $\\{f_{{\\mathrm{coll}},i}\\}$ and a global ionizing efficiency $\\zeta$. Under the simplifications adopted, source $i$ produces a total number of ionizing photons\n$$\nN_{\\gamma,i} = \\zeta \\, f_{{\\mathrm{coll}},i} \\, n_{\\mathrm{H},0} \\, V_{\\mathrm{cell}},\n$$\nand the total photon budget is $N_{\\gamma,\\mathrm{tot}}=\\sum_i N_{\\gamma,i}$. The total number of hydrogen atoms in the box is $N_{\\mathrm{H,tot}}=n_{\\mathrm{H},0} \\, L_{\\mathrm{box}}^3$. Throughout, treat all number counts as comoving and dimensionless tallies; if a quantity requires units, use the specified units in cgs or SI as appropriate when computing $n_{\\mathrm{H},0}$, but all final photon and atom tallies and errors are dimensionless.\n\nDefine a naive, non-conserving ionization map by painting non-overlapping spherical bubbles centered at each source with radius $R_i$ chosen so that the number of atoms in each isolated bubble equals the source’s photons:\n$$\nN_{\\gamma,i} = n_{\\mathrm{H},0} \\, \\frac{4\\pi}{3} R_i^3 \\quad \\Rightarrow \\quad R_i = \\left(\\frac{3 \\, N_{\\gamma,i}}{4\\pi \\, n_{\\mathrm{H},0}}\\right)^{1/3} = \\left(\\frac{3 \\, \\zeta \\, f_{{\\mathrm{coll}},i} \\, V_{\\mathrm{cell}}}{4\\pi}\\right)^{1/3}.\n$$\nOn a discrete grid, approximate the naive ionization field by marking a voxel as ionized if its center lies within at least one bubble, and neutral otherwise. This “union-of-spheres” discretization produces a total number of ionized atoms $N_{\\mathrm{ion,naive}} = n_{\\mathrm{H},0} \\, V_{\\mathrm{cell}} \\, N_{\\mathrm{vox,ion}}$, where $N_{\\mathrm{vox,ion}}$ is the number of ionized voxels. In general, overlaps and discretization lead to a photon accounting mismatch. Define the global photon accounting target as\n$$\nN_{\\mathrm{use}} = \\min\\!\\left(N_{\\gamma,\\mathrm{tot}}, N_{\\mathrm{H,tot}}\\right),\n$$\nand quantify the naive photon non-conservation error as the dimensionless fractional discrepancy\n$$\n\\varepsilon_{\\mathrm{naive}} = \\frac{N_{\\mathrm{ion,naive}} - N_{\\mathrm{use}}}{N_{\\mathrm{use}}}.\n$$\nDesign and implement a deterministic, global photon-accounting correction that enforces conservation by constructing a ranked “photon deposition” field $D(\\mathbf{x})$ and then selecting voxels in descending $D(\\mathbf{x})$ until the cumulative atoms equal $N_{\\mathrm{use}}$ to within one voxel, with the final voxel allowed to be partially ionized to match $N_{\\mathrm{use}}$ exactly. Specifically, define for each source a distance-based weight\n$$\nw_i(\\mathbf{x}) = \\frac{1}{\\left(\\lVert \\mathbf{x}-\\mathbf{x}_i \\rVert + \\epsilon\\right)^p},\n$$\nwith $\\epsilon0$ a small softening in cMpc and $p0$ a fixed exponent. Normalize per source so that $\\sum_{\\mathbf{x}} \\tilde{w}_i(\\mathbf{x}) = 1$ over all voxels, where $\\tilde{w}_i(\\mathbf{x}) = w_i(\\mathbf{x})/\\sum_{\\mathbf{x}} w_i(\\mathbf{x})$, and define\n$$\nD(\\mathbf{x}) = \\sum_i N_{\\gamma,i} \\, \\tilde{w}_i(\\mathbf{x}).\n$$\nSort voxels by $D(\\mathbf{x})$ in descending order and mark them ionized until the cumulative assigned atoms equals $N_{\\mathrm{use}}$. This produces a corrected global tally $N_{\\mathrm{ion,corr}} = N_{\\mathrm{use}}$ by construction and a corrected fractional error\n$$\n\\varepsilon_{\\mathrm{corr}} = \\frac{N_{\\mathrm{ion,corr}} - N_{\\mathrm{use}}}{N_{\\mathrm{use}}}.\n$$\nAlso report the corrected global ionized fraction\n$$\n\\bar{x}_{\\mathrm{HII,corr}} = \\frac{N_{\\mathrm{ion,corr}}}{N_{\\mathrm{H,tot}}} = \\frac{N_{\\mathrm{use}}}{N_{\\mathrm{H,tot}}}.\n$$\n\nImplement the above in a single program. Use the following cosmological constants in SI for the density calculation: $G = 6.67430\\times 10^{-11}\\,\\mathrm{m}^3\\,\\mathrm{kg}^{-1}\\,\\mathrm{s}^{-2}$, $m_{\\mathrm{p}} = 1.67262192369\\times 10^{-27}\\,\\mathrm{kg}$, $H_0 = 100\\,h\\,\\mathrm{km}\\,\\mathrm{s}^{-1}\\,\\mathrm{Mpc}^{-1}$ with $h=0.68$, $\\Omega_{\\mathrm{b}}=0.0486$, $X_{\\mathrm{p}}=0.76$, and $1\\,\\mathrm{Mpc} = 3.085677581\\times 10^{22}\\,\\mathrm{m}$. Convert $n_{\\mathrm{H},0}$ to $\\mathrm{cMpc}^{-3}$ exactly using these constants. Assume angles are not used; distances are in cMpc; photon and atom counts are dimensionless tallies. Take the deposition parameters to be fixed at $p=2$ and $\\epsilon=\\Delta x/2$.\n\nYour task is to write a program that, for each test case, computes $\\varepsilon_{\\mathrm{naive}}$, $\\varepsilon_{\\mathrm{corr}}$, and $\\bar{x}_{\\mathrm{HII,corr}}$ as floats.\n\nTest suite (units as specified; all positions are in cMpc, all distances use cMpc, all results are dimensionless):\n\n- Case $1$ (well-separated bubbles, minimal overlap):\n  - $N=32$, $L_{\\mathrm{box}}=32$, $\\zeta=30$,\n  - Sources: $\\big([\\;8,16,16\\;],\\, f_{{\\mathrm{coll}},1}=0.4\\big)$ and $\\big([\\;24,16,16\\;],\\, f_{{\\mathrm{coll}},2}=0.4\\big)$.\n\n- Case $2$ (significant overlap):\n  - $N=32$, $L_{\\mathrm{box}}=32$, $\\zeta=40$,\n  - Sources: $\\big([\\;14,16,16\\;],\\, f_{{\\mathrm{coll}},1}=0.5\\big)$, $\\big([\\;18,16,16\\;],\\, f_{{\\mathrm{coll}},2}=0.5\\big)$, $\\big([\\;16,18,16\\;],\\, f_{{\\mathrm{coll}},3}=0.3\\big)$.\n\n- Case $3$ (photon-saturated box):\n  - $N=24$, $L_{\\mathrm{box}}=24$, $\\zeta=3000$,\n  - Sources at the eight sub-box centers:\n    - $\\big([\\;6,6,6\\;],\\, 0.6\\big)$, $\\big([\\;6,6,18\\;],\\, 0.6\\big)$, $\\big([\\;6,18,6\\;],\\, 0.6\\big)$, $\\big([\\;6,18,18\\;],\\, 0.6\\big)$,\n    - $\\big([\\;18,6,6\\;],\\, 0.6\\big)$, $\\big([\\;18,6,18\\;],\\, 0.6\\big)$, $\\big([\\;18,18,6\\;],\\, 0.6\\big)$, $\\big([\\;18,18,18\\;],\\, 0.6\\big)$.\n\nYour program should produce a single line of output containing the results as a comma-separated Python-style list of lists with no spaces, where each inner list has the three floats $[\\varepsilon_{\\mathrm{naive}}, \\varepsilon_{\\mathrm{corr}}, \\bar{x}_{\\mathrm{HII,corr}}]$ in that order for the corresponding test case. For example, print exactly a string of the form\n“[[a1,b1,c1],[a2,b2,c2],[a3,b3,c3]]”,\nwith each $a_i$, $b_i$, $c_i$ printed as decimal floats. All reported quantities are dimensionless; do not include any units in the printed output.", "solution": "We begin with conservation of ionizing photons: during the Epoch of Reionization, neglecting recombinations and helium, each ionizing photon ultimately ionizes one hydrogen atom. The global photon budget produced by discrete sources must equal the total number of ionized hydrogen atoms in the domain, but naive bubble painting or excursion-set-inspired algorithms may double-count when smoothing or may under- or over-ionize due to discretization and overlap.\n\nLet $N_{\\mathrm{H,tot}} = n_{\\mathrm{H},0} \\, L_{\\mathrm{box}}^3$ be the total hydrogen atom count in the domain. We compute $n_{\\mathrm{H},0}$ from the present-day baryon density:\n$$\n\\rho_{\\mathrm{crit},0} = \\frac{3 H_0^2}{8\\pi G}, \\quad \\rho_{\\mathrm{b},0} = \\Omega_{\\mathrm{b}} \\rho_{\\mathrm{crit},0}, \\quad n_{\\mathrm{H},0}^{\\mathrm{(SI)}} = \\frac{X_{\\mathrm{p}} \\rho_{\\mathrm{b},0}}{m_{\\mathrm{p}}} \\; \\; [\\mathrm{m}^{-3}],\n$$\nand convert to per $\\mathrm{cMpc}^{-3}$ using $1\\,\\mathrm{Mpc} = 3.085677581\\times 10^{22}\\,\\mathrm{m}$:\n$$\nn_{\\mathrm{H},0} = n_{\\mathrm{H},0}^{\\mathrm{(SI)}} \\times (1\\,\\mathrm{Mpc})^3.\n$$\nSince we work comovingly, this number density is spatially uniform and redshift-independent in our toy model.\n\nEach source $i$ has a collapsed fraction $f_{{\\mathrm{coll}},i}$ and an ionizing efficiency $\\zeta$. Under the assumption of uniform density and neglecting spatial modulation of $f_{\\mathrm{coll}}$ beyond the discrete sources, we define the photon yield per source as\n$$\nN_{\\gamma,i} = \\zeta \\, f_{{\\mathrm{coll}},i} \\, n_{\\mathrm{H},0} \\, V_{\\mathrm{cell}},\n$$\nso the total photons are $N_{\\gamma,\\mathrm{tot}} = \\sum_i N_{\\gamma,i}$. The naive bubble painting radius equates the photon count of source $i$ to the number of atoms in a sphere of radius $R_i$ at the mean density:\n$$\nN_{\\gamma,i} = n_{\\mathrm{H},0}\\,\\frac{4\\pi}{3} R_i^3 \\;\\Rightarrow\\; R_i = \\left(\\frac{3 N_{\\gamma,i}}{4\\pi n_{\\mathrm{H},0}}\\right)^{1/3} = \\left(\\frac{3 \\zeta f_{{\\mathrm{coll}},i} V_{\\mathrm{cell}}}{4\\pi}\\right)^{1/3}.\n$$\nNotably, $R_i$ is independent of $n_{\\mathrm{H},0}$ because $N_{\\gamma,i}\\propto n_{\\mathrm{H},0}$; thus, the bubble volume in cMpc$^3$ equals $N_{\\gamma,i}/n_{\\mathrm{H},0}$ by construction in the continuum.\n\nOn a discretized grid, we define the naive ionization map by marking each voxel whose center lies within at least one sphere of radius $R_i$ centered at $\\mathbf{x}_i$. This yields a union-of-spheres set of voxels with count $N_{\\mathrm{vox,ion}}$, corresponding to a naive ionized atom count\n$$\nN_{\\mathrm{ion,naive}} = n_{\\mathrm{H},0} \\, V_{\\mathrm{cell}} \\, N_{\\mathrm{vox,ion}}.\n$$\nBecause of overlaps between spheres and discrete voxelization, $N_{\\mathrm{ion,naive}}$ may be smaller than $N_{\\gamma,\\mathrm{tot}}$ (unassigned photons) or, in some excursion-set algorithms, larger (double-counting); in our union-of-spheres construction, overlaps generally lead to $N_{\\mathrm{ion,naive}} \\le \\sum_i n_{\\mathrm{H},0}\\,\\frac{4\\pi}{3} R_i^3 = N_{\\gamma,\\mathrm{tot}}$, so the mismatch is typically negative. Physical limits impose that the maximally used photons cannot exceed $N_{\\mathrm{H,tot}}$, so we define the global target\n$$\nN_{\\mathrm{use}} = \\min\\!\\left(N_{\\gamma,\\mathrm{tot}},\\, N_{\\mathrm{H,tot}}\\right).\n$$\nThe naive photon non-conservation fractional error is then\n$$\n\\varepsilon_{\\mathrm{naive}} = \\frac{N_{\\mathrm{ion,naive}} - N_{\\mathrm{use}}}{N_{\\mathrm{use}}},\n$$\nwhich is dimensionless and can take negative values if the naive method underuses photons.\n\nTo enforce global photon accounting, we design a deterministic assignment that allocates exactly $N_{\\mathrm{use}}$ atoms to be ionized by ranking voxels according to a photon deposition field $D(\\mathbf{x})$. We choose a physically motivated kernel that decays with distance from each source, modeling a redistribution of photons outward from the naive bubble boundaries in proportion to proximity to sources. For source $i$, define\n$$\nw_i(\\mathbf{x}) = \\frac{1}{\\left(\\lVert \\mathbf{x}-\\mathbf{x}_i \\rVert + \\epsilon\\right)^p}, \\quad \\epsilon = \\frac{\\Delta x}{2}, \\quad p=2,\n$$\nand normalize per source:\n$$\n\\tilde{w}_i(\\mathbf{x}) = \\frac{w_i(\\mathbf{x})}{\\sum_{\\mathbf{y}} w_i(\\mathbf{y})}.\n$$\nThe photon deposition field is then\n$$\nD(\\mathbf{x}) = \\sum_i N_{\\gamma,i} \\, \\tilde{w}_i(\\mathbf{x}),\n$$\nwhich satisfies $\\sum_{\\mathbf{x}} D(\\mathbf{x}) = \\sum_i N_{\\gamma,i} = N_{\\gamma,\\mathrm{tot}}$ by construction. Sorting all voxels $\\mathbf{x}$ by decreasing $D(\\mathbf{x})$ yields an ordering that prioritizes cells most strongly coupled to the sources. We then ionize voxels in that order until the cumulative ionized atoms reach $N_{\\mathrm{use}}$. Because $N_{\\mathrm{use}}$ may not be an integer multiple of the atoms per cell $n_{\\mathrm{H},0}V_{\\mathrm{cell}}$, we allow the last selected cell to be partially ionized with a fractional occupancy so that the assigned ionized atom count is exactly $N_{\\mathrm{ion,corr}} = N_{\\mathrm{use}}$. This guarantees a corrected fractional error\n$$\n\\varepsilon_{\\mathrm{corr}} = \\frac{N_{\\mathrm{ion,corr}} - N_{\\mathrm{use}}}{N_{\\mathrm{use}}} = 0,\n$$\nup to floating-point rounding. The corrected mean ionized fraction is\n$$\n\\bar{x}_{\\mathrm{HII,corr}} = \\frac{N_{\\mathrm{ion,corr}}}{N_{\\mathrm{H,tot}}} = \\frac{N_{\\mathrm{use}}}{N_{\\mathrm{H,tot}}}.\n$$\n\nAlgorithmic steps for each test case:\n- Compute $\\Delta x = L_{\\mathrm{box}}/N$ and $V_{\\mathrm{cell}}=\\Delta x^3$.\n- Compute $n_{\\mathrm{H},0}$ in $\\mathrm{cMpc}^{-3}$ from the given constants.\n- Build the grid of voxel centers $\\{\\mathbf{x}\\}$ in cMpc as $(j+1/2)\\Delta x$ per axis for $j\\in\\{0,\\dots,N-1\\}$.\n- For each source $i$, compute $N_{\\gamma,i} = \\zeta f_{{\\mathrm{coll}},i} n_{\\mathrm{H},0} V_{\\mathrm{cell}}$ and $R_i = \\left(3\\zeta f_{{\\mathrm{coll}},i}V_{\\mathrm{cell}}/(4\\pi)\\right)^{1/3}$.\n- Naive map: build a boolean mask that marks a voxel ionized if its center is within $R_i$ of any source center. Compute $N_{\\mathrm{ion,naive}} = n_{\\mathrm{H},0}V_{\\mathrm{cell}} N_{\\mathrm{vox,ion}}$ and $N_{\\mathrm{use}}=\\min(N_{\\gamma,\\mathrm{tot}}, n_{\\mathrm{H},0}L_{\\mathrm{box}}^3)$, then $\\varepsilon_{\\mathrm{naive}}$.\n- Correction: compute $w_i(\\mathbf{x})$ for all sources and voxels, normalize to $\\tilde{w}_i(\\mathbf{x})$, compute $D(\\mathbf{x})$, sort descending, and select the smallest prefix and a final fractional voxel such that assigned atoms equal $N_{\\mathrm{use}}$. Report $\\varepsilon_{\\mathrm{corr}}$ and $\\bar{x}_{\\mathrm{HII,corr}}$.\n\nNumerical considerations:\n- All distances in cMpc and all volumes in $\\mathrm{cMpc}^3$.\n- The softening $\\epsilon=\\Delta x/2$ avoids divergences for voxels containing sources.\n- Sorting produces a deterministic selection due to a fixed tie-breaker ordering in the sort implementation; we do not use randomness.\n\nEdge cases covered by the test suite:\n- Case $1$ has well-separated bubbles, so $\\varepsilon_{\\mathrm{naive}}$ should be close to zero in magnitude, with residual discretization.\n- Case $2$ has significant overlaps, yielding a more negative $\\varepsilon_{\\mathrm{naive}}$ because the union volume is less than the sum of individual sphere volumes.\n- Case $3$ is photon-saturated with $N_{\\gamma,\\mathrm{tot}} \\gtrsim N_{\\mathrm{H,tot}}$, so $N_{\\mathrm{use}} = N_{\\mathrm{H,tot}}$ and the correction saturates at full ionization with $\\bar{x}_{\\mathrm{HII,corr}} \\approx 1$; the naive map underuses photons due to boundary clipping and overlap.\n\nOutput specification:\n- For each case, output the triple $[\\varepsilon_{\\mathrm{naive}}, \\varepsilon_{\\mathrm{corr}}, \\bar{x}_{\\mathrm{HII,corr}}]$ as decimal floats.\n- Aggregate the three triples into a single list with no spaces, printed on one line as a Python-style list of lists:\n“[[a1,b1,c1],[a2,b2,c2],[a3,b3,c3]]”.\nAll three reported quantities are dimensionless; no units are to be printed.", "answer": "```python\nimport numpy as np\n\n# Numerical cosmology constants and conversions\nG = 6.67430e-11  # m^3 kg^-1 s^-2\nm_p = 1.67262192369e-27  # kg\nh = 0.68\nH0 = 100.0 * h * 1000.0 / 3.085677581e22  # s^-1 (100 h km/s/Mpc converted)\nOmega_b = 0.0486\nX_p = 0.76\nMPC_IN_M = 3.085677581e22  # m\n\ndef hydrogen_number_density_cMpc3():\n    \"\"\"Compute present-day comoving hydrogen number density n_H0 in 1/cMpc^3.\"\"\"\n    rho_crit0 = 3.0 * H0**2 / (8.0 * np.pi * G)  # kg/m^3\n    rho_b0 = Omega_b * rho_crit0  # kg/m^3\n    n_H_SI = X_p * rho_b0 / m_p  # 1/m^3\n    n_H_cMpc3 = n_H_SI * (MPC_IN_M**3)  # convert to 1/Mpc^3 (cMpc^3)\n    return n_H_cMpc3\n\ndef grid_voxel_centers(N, Lbox):\n    \"\"\"Return (N^3, 3) array of voxel center coordinates in cMpc.\"\"\"\n    dx = Lbox / N\n    coords_1d = (np.arange(N, dtype=np.float64) + 0.5) * dx\n    X, Y, Z = np.meshgrid(coords_1d, coords_1d, coords_1d, indexing='ij')\n    positions = np.stack([X.ravel(), Y.ravel(), Z.ravel()], axis=1)\n    return positions, dx\n\ndef naive_union_spheres_mask(positions, sources_pos, radii):\n    \"\"\"Compute union-of-spheres mask (boolean array of length Nvox).\"\"\"\n    Nvox = positions.shape[0]\n    mask = np.zeros(Nvox, dtype=bool)\n    for pos, R in zip(sources_pos, radii):\n        diff = positions - pos  # (Nvox, 3)\n        r2 = np.sum(diff * diff, axis=1)\n        mask |= (r2 = R * R)\n    return mask\n\ndef photon_deposition_field(positions, sources_pos, N_gamma_list, dx, p=2.0):\n    \"\"\"Compute global photon deposition field D(x) normalized to sum to sum(N_gamma).\"\"\"\n    Nvox = positions.shape[0]\n    D = np.zeros(Nvox, dtype=np.float64)\n    # Softening to avoid singularity at r=0\n    eps = dx * 0.5\n    for pos, Ng in zip(sources_pos, N_gamma_list):\n        diff = positions - pos\n        r = np.linalg.norm(diff, axis=1)\n        w = 1.0 / np.power(r + eps, p)\n        w_sum = w.sum()\n        if w_sum = 0.0:\n            continue\n        D += Ng * (w / w_sum)\n    return D\n\ndef enforce_global_photon_accounting(D, nH, Vcell, N_use):\n    \"\"\"Greedy selection by descending D to match N_use atoms. Allows fractional final voxel.\"\"\"\n    atoms_per_cell = nH * Vcell\n    if N_use = 0.0 or atoms_per_cell = 0.0:\n        return 0.0, 0, 0.0  # assigned atoms, number of full cells, fraction in last\n    idx = np.argsort(-D)  # descending\n    # Number of full cells we can take\n    K_full = int(np.floor(N_use / atoms_per_cell))\n    assigned_atoms = atoms_per_cell * K_full\n    frac_last = 0.0\n    last_index = None\n    if assigned_atoms  N_use and K_full  len(idx):\n        # Take one more voxel fractionally\n        last_index = idx[K_full]\n        remaining = N_use - assigned_atoms\n        frac_last = min(1.0, remaining / atoms_per_cell)\n        assigned_atoms += frac_last * atoms_per_cell\n    # If assigned_atoms still less due to reaching end, that's fine; but in practice won't happen.\n    return assigned_atoms, K_full, frac_last\n\ndef run_case(N, Lbox, zeta, sources):\n    \"\"\"\n    sources: list of tuples ([x,y,z], f_coll)\n    Returns epsilon_naive, epsilon_corr, xHII_corr\n    \"\"\"\n    # Grid and constants\n    positions, dx = grid_voxel_centers(N, Lbox)\n    Vcell = dx**3\n    nH = hydrogen_number_density_cMpc3()\n    NH_tot = nH * (Lbox**3)\n\n    # Source photons and bubble radii\n    src_pos = []\n    fcolls = []\n    for (pos, fcoll) in sources:\n        src_pos.append(np.array(pos, dtype=np.float64))\n        fcolls.append(float(fcoll))\n    src_pos = np.array(src_pos, dtype=np.float64)\n    fcolls = np.array(fcolls, dtype=np.float64)\n\n    N_gamma_list = zeta * fcolls * nH * Vcell  # photons per source (dimensionless tally)\n    N_gamma_tot = float(np.sum(N_gamma_list))\n    N_use = min(N_gamma_tot, NH_tot)\n\n    # Radii independent of nH\n    radii = np.power((3.0 * zeta * fcolls * Vcell) / (4.0 * np.pi), 1.0 / 3.0)\n\n    # Naive union-of-spheres mask\n    mask = naive_union_spheres_mask(positions, src_pos, radii)\n    N_vox_ion = int(np.count_nonzero(mask))\n    N_ion_naive = nH * Vcell * N_vox_ion\n    # Fractional error\n    # Guard against division by zero: in our test suite N_use  0\n    eps_naive = (N_ion_naive - N_use) / N_use if N_use  0 else 0.0\n\n    # Photon-conserving correction\n    D = photon_deposition_field(positions, src_pos, N_gamma_list, dx, p=2.0)\n    assigned_atoms, _, _ = enforce_global_photon_accounting(D, nH, Vcell, N_use)\n    eps_corr = (assigned_atoms - N_use) / N_use if N_use  0 else 0.0\n    xHII_corr = assigned_atoms / NH_tot if NH_tot  0 else 0.0\n\n    return float(eps_naive), float(eps_corr), float(xHII_corr)\n\ndef format_results(results):\n    # Format as [[a,b,c],[...],...] with fixed decimal formatting and no spaces\n    def fmt(x):\n        # Use a reasonable precision; ensure deterministic output\n        return f\"{x:.6f}\"\n    inner = []\n    for triple in results:\n        a, b, c = triple\n        inner.append(f\"[{fmt(a)},{fmt(b)},{fmt(c)}]\")\n    return \"[\" + \",\".join(inner) + \"]\"\n\ndef solve():\n    # Define test cases as specified\n    test_cases = [\n        # Case 1\n        {\n            \"N\": 32,\n            \"Lbox\": 32.0,\n            \"zeta\": 30.0,\n            \"sources\": [\n                ([8.0, 16.0, 16.0], 0.4),\n                ([24.0, 16.0, 16.0], 0.4),\n            ],\n        },\n        # Case 2\n        {\n            \"N\": 32,\n            \"Lbox\": 32.0,\n            \"zeta\": 40.0,\n            \"sources\": [\n                ([14.0, 16.0, 16.0], 0.5),\n                ([18.0, 16.0, 16.0], 0.5),\n                ([16.0, 18.0, 16.0], 0.3),\n            ],\n        },\n        # Case 3\n        {\n            \"N\": 24,\n            \"Lbox\": 24.0,\n            \"zeta\": 3000.0,\n            \"sources\": [\n                ([6.0, 6.0, 6.0], 0.6),\n                ([6.0, 6.0, 18.0], 0.6),\n                ([6.0, 18.0, 6.0], 0.6),\n                ([6.0, 18.0, 18.0], 0.6),\n                ([18.0, 6.0, 6.0], 0.6),\n                ([18.0, 6.0, 18.0], 0.6),\n                ([18.0, 18.0, 6.0], 0.6),\n                ([18.0, 18.0, 18.0], 0.6),\n            ],\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        eps_naive, eps_corr, xHII_corr = run_case(case[\"N\"], case[\"Lbox\"], case[\"zeta\"], case[\"sources\"])\n        results.append([eps_naive, eps_corr, xHII_corr])\n\n    print(format_results(results).replace(\" \",\"\"))\n\nif __name__ == \"__main__\":\n    solve()\n```", "id": "3488937"}, {"introduction": "The ultimate goal of reionization simulations is to connect theory with observation, and the 21cm signal from neutral hydrogen is our primary observational probe. The nature of this signal—whether it appears in absorption or emission against the cosmic microwave background—is dictated by the gas spin temperature, $T_S$. This hands-on practice [@problem_id:3488955] allows you to explore the underlying physics of the Wouthuysen-Field effect by toggling different coupling mechanisms and directly measuring the impact on the observable 21cm power spectrum, $P_{21}(k)$.", "problem": "You are asked to design and implement a minimal, self-consistent numerical experiment to assess the sensitivity of the three-dimensional 21 centimeter brightness temperature power spectrum to different spin temperature coupling prescriptions during the epoch of reionization. The study is limited to a toy model that is scientifically plausible, isolates the effect of spin temperature coupling, and is explicitly testable.\n\nFundamental base and definitions:\n- The 21 centimeter differential brightness temperature is modeled as $T_{\\mathrm{b}}(\\mathbf{x}) \\approx 27\\,\\mathrm{mK}\\,x_{\\mathrm{HI}}(\\mathbf{x})\\left[1+\\delta(\\mathbf{x})\\right]\\left(1 - \\frac{T_{\\gamma}}{T_{\\mathrm{S}}(\\mathbf{x})}\\right)\\sqrt{\\frac{1+z}{10}}$, where $x_{\\mathrm{HI}}(\\mathbf{x})$ is the neutral hydrogen fraction, $\\delta(\\mathbf{x})$ is the matter overdensity, $T_{\\gamma}$ is the Cosmic Microwave Background (CMB) temperature, $T_{\\mathrm{S}}(\\mathbf{x})$ is the spin temperature, and $z$ is redshift.\n- The spin temperature coupling is given by the Wouthuysen-Field relation, $T_{\\mathrm{S}}^{-1} = \\dfrac{T_{\\gamma}^{-1} + x_{c}\\,T_{\\mathrm{K}}^{-1} + x_{\\alpha}\\,T_{\\alpha}^{-1}}{1 + x_{c} + x_{\\alpha}}$, where $x_{c}$ is the collisional coupling coefficient, $x_{\\alpha}$ is the Lyman-Alpha (Ly$\\alpha$) coupling coefficient, $T_{\\mathrm{K}}$ is the kinetic temperature of the gas, and $T_{\\alpha}$ is the Ly$\\alpha$ color temperature. Assume $T_{\\alpha} = T_{\\mathrm{K}}$.\n- The three-dimensional power spectrum $P_{21}(k)$ of the brightness temperature fluctuations is defined by the Fourier transform convention of the Fast Fourier Transform (FFT) used in discrete periodic boxes, and operationally estimated by binning $\\left|\\tilde{\\Delta}_{21}(\\mathbf{k})\\right|^{2}$ into spherical $k$-shells and dividing by the box volume, where $\\Delta_{21}(\\mathbf{x}) \\equiv T_{\\mathrm{b}}(\\mathbf{x}) - \\langle T_{\\mathrm{b}}\\rangle$.\n\nPhysical and numerical setup:\n- Domain: a periodic cube of comoving side length $L = 200\\,\\mathrm{Mpc}\\,h^{-1}$ uniformly discretized into $N = 32$ cells along each dimension.\n- Redshift: $z = 10$, so $T_{\\gamma} = 2.725\\,(1+z)\\,\\mathrm{K}$.\n- Neutral fraction: choose a spatially uniform value $x_{\\mathrm{HI}}(\\mathbf{x}) = 1$ to isolate spin temperature effects.\n- Kinetic temperature: choose a spatially uniform value $T_{\\mathrm{K}} = 5\\,\\mathrm{K}$ and set $T_{\\alpha} = T_{\\mathrm{K}}$.\n- Coupling coefficients when “on”: $x_{c,\\mathrm{on}} = 0.1$ and $x_{\\alpha,\\mathrm{on}} = 2.0$. When a coupling is “off,” set it to zero.\n- Overdensity field: construct a statistically homogeneous and isotropic Gaussian random overdensity field $\\delta(\\mathbf{x})$ by:\n  1. Sampling a zero-mean, unit-variance Gaussian white noise field on the grid in real space.\n  2. Transforming to Fourier space and applying a spherically symmetric transfer function $T(k) = \\left(\\dfrac{k}{k_{0}}\\right)^{n/2}\\exp\\left[-\\dfrac{1}{2}\\left(\\dfrac{k}{k_{c}}\\right)^{2}\\right]$ to shape the field, with $n = -2.5$, $k_{0} = 0.1\\,h\\,\\mathrm{Mpc}^{-1}$, and $k_{c} = 0.8\\,h\\,\\mathrm{Mpc}^{-1}$, and setting the zero mode to zero. Then inverse transform to real space and subtract any residual mean to ensure $\\langle \\delta\\rangle = 0$.\n\nTarget quantity:\n- For each spin temperature coupling prescription, compute the binned $P_{21}(k)$ by:\n  1. Building $T_{\\mathrm{b}}(\\mathbf{x})$ in milliKelvin using the formula above with $x_{\\mathrm{HI}}=1$ and the chosen $T_{\\mathrm{S}}$ prescription.\n  2. Subtracting the spatial mean to obtain $\\Delta_{21}(\\mathbf{x})$.\n  3. Computing the Fourier transform and binning $|\\tilde{\\Delta}_{21}(\\mathbf{k})|^{2}$ into spherical shells in $k$-space of width $\\Delta k$, and dividing by the box volume $L^{3}$ to obtain an estimate of $P_{21}(k)$ in $\\mathrm{mK}^{2}\\,(\\mathrm{Mpc}\\,h^{-1})^{3}$.\n- Use three disjoint $k$-bins centered at $k \\in \\{0.1,\\,0.3,\\,0.5\\}\\,h\\,\\mathrm{Mpc}^{-1}$, each with half-width $\\Delta k/2 = 0.05\\,h\\,\\mathrm{Mpc}^{-1}$; that is, bins $[0.05,0.15)$, $[0.25,0.35)$, and $[0.45,0.55)$.\n\nSpin temperature test suite:\n- Evaluate four coupling prescriptions by “toggling” $x_{c}$ and $x_{\\alpha}$:\n  1. Case A (baseline): $x_{c} = x_{c,\\mathrm{on}}$, $x_{\\alpha} = x_{\\alpha,\\mathrm{on}}$.\n  2. Case B (collisions only): $x_{c} = x_{c,\\mathrm{on}}$, $x_{\\alpha} = 0$.\n  3. Case C (Ly$\\alpha$ only): $x_{c} = 0$, $x_{\\alpha} = x_{\\alpha,\\mathrm{on}}$.\n  4. Case D (neither): $x_{c} = 0$, $x_{\\alpha} = 0$.\n\nRequired outputs:\n- For each case, compute the fractional change in the binned power spectrum relative to the baseline, $\\Delta_{\\mathrm{frac}}(k) = \\dfrac{P_{21}^{\\mathrm{case}}(k) - P_{21}^{\\mathrm{A}}(k)}{P_{21}^{\\mathrm{A}}(k)}$, evaluated at the three $k$-bins defined above. Express these fractional changes as dimensionless decimals.\n- Your program must use the random seed $42$ to ensure reproducibility, implement all steps described above, and produce the results in a single line of output as a comma-separated list of lists in the following order of cases: A, B, C, D. For example, the output must have the form [[a1,a2,a3],[b1,b2,b3],[c1,c2,c3],[d1,d2,d3]] where each entry is a floating-point number corresponding to the fractional change at the three bins. The baseline case A should therefore yield approximately [0,0,0].\n\nAngle units are not used. All physical units appearing in the calculation must be consistent: temperatures in Kelvin, $T_{\\mathrm{b}}$ in milliKelvin, wave numbers in $h\\,\\mathrm{Mpc}^{-1}$, volume in $(\\mathrm{Mpc}\\,h^{-1})^{3}$, and $P_{21}$ in $\\mathrm{mK}^{2}\\,(\\mathrm{Mpc}\\,h^{-1})^{3}$. The final requested fractional changes are unitless. The program must be self-contained, require no input, and print exactly one line in the format specified above.", "solution": "The problem statement poses a well-defined and scientifically grounded numerical experiment in physical cosmology. It provides a clear, self-contained set of instructions and parameters to construct a toy model of the 21 centimeter brightness temperature field during the epoch of reionization. The objective is to quantify the sensitivity of the 21cm power spectrum to different physical coupling mechanisms governing the hydrogen spin temperature. All provided definitions, equations, and numerical values are consistent with standard literature and practices for simplified models in this field. The problem is free of scientific flaws, contradictions, or ambiguities that would prevent a unique and meaningful solution. The specified simplifications, such as a uniform neutral fraction and kinetic temperature, are appropriate for the stated goal of isolating the effects of spin temperature coupling. Therefore, a problem is deemed valid.\n\nThe solution proceeds by implementing the numerical simulation exactly as described. The core steps are: 1) setting up the computational domain and physical constants; 2) generating a Gaussian random overdensity field $\\delta(\\mathbf{x})$ with the specified statistical properties; 3) for each of the four spin temperature coupling cases, calculating the 21cm brightness temperature field $T_{\\mathrm{b}}(\\mathbf{x})$; 4) for each case, computing the binned power spectrum $P_{21}(k)$ of the brightness temperature fluctuations; and 5) calculating the fractional change of the power spectrum in each bin relative to the baseline case.\n\nFirst, we define the physical and numerical constants based on the problem statement.\nThe simulation domain is a periodic cube of side length $L=200\\,\\mathrm{Mpc}\\,h^{-1}$ on a grid of $N^3=32^3$ cells.\nThe redshift is $z=10$, yielding a Cosmic Microwave Background (CMB) temperature of $T_{\\gamma} = 2.725(1+z) = 29.975\\,\\mathrm{K}$.\nWe are given a uniform neutral hydrogen fraction $x_{\\mathrm{HI}}=1$ and a uniform gas kinetic temperature $T_{\\mathrm{K}}=5\\,\\mathrm{K}$. The Lyman-Alpha (Ly$\\alpha$) color temperature is set equal to the kinetic temperature, $T_{\\alpha}=T_{\\mathrm{K}}$.\n\nThe overdensity field $\\delta(\\mathbf{x})$ is generated in Fourier space. A grid of wavevectors $\\mathbf{k}$ is constructed, with components given by $k_i = 2\\pi m_i/L$ for integers $m_i \\in [-N/2, N/2-1]$. We generate a field of complex Gaussian white noise $\\tilde{w}(\\mathbf{k})$ in Fourier space. This is equivalent to generating real-space white noise and then transforming it. The field is then shaped by applying the specified transfer function $T(k)$:\n$$\n\\tilde{\\delta}(\\mathbf{k}) = \\tilde{w}(\\mathbf{k}) T(k)\n$$\nwhere $k=|\\mathbf{k}|$ and the transfer function is\n$$\nT(k) = \\left(\\frac{k}{k_{0}}\\right)^{n/2}\\exp\\left[-\\frac{1}{2}\\left(\\frac{k}{k_{c}}\\right)^{2}\\right]\n$$\nwith parameters $n=-2.5$, $k_0 = 0.1\\,h\\,\\mathrm{Mpc}^{-1}$, and $k_c = 0.8\\,h\\,\\mathrm{Mpc}^{-1}$. The DC mode $\\tilde{\\delta}(\\mathbf{k}=0)$ is set to zero. An inverse Fast Fourier Transform (FFT) yields the real-space field $\\delta(\\mathbf{x})$. Any residual numerical mean is subtracted to ensure $\\langle\\delta\\rangle=0$. This same density field is used for all four cases.\n\nFor each test case (A, B, C, D), we calculate the corresponding spatially uniform spin temperature, $T_{\\mathrm{S}}$. The Wouthuysen-Field relation is given as:\n$$\nT_{\\mathrm{S}}^{-1} = \\frac{T_{\\gamma}^{-1} + x_{c}\\,T_{\\mathrm{K}}^{-1} + x_{\\alpha}\\,T_{\\alpha}^{-1}}{1 + x_{c} + x_{\\alpha}}\n$$\nThe coupling coefficients $(x_c, x_\\alpha)$ are set according to the case: A $(x_{c,\\mathrm{on}}, x_{\\alpha,\\mathrm{on}})$, B $(x_{c,\\mathrm{on}}, 0)$, C $(0, x_{\\alpha,\\mathrm{on}})$, and D $(0,0)$, with $x_{c,\\mathrm{on}}=0.1$ and $x_{\\alpha,\\mathrm{on}}=2.0$.\n\nThe brightness temperature field $T_{\\mathrm{b}}(\\mathbf{x})$ for each case is then computed. Since $x_{\\mathrm{HI}}$, $z$, $T_{\\gamma}$, and $T_{\\mathrm{S}}$ (within a given case) are all spatially uniform, the expression simplifies to a linear function of the overdensity:\n$$\nT_{\\mathrm{b}}(\\mathbf{x}) = C \\cdot (1 + \\delta(\\mathbf{x}))\n$$\nwhere the constant $C$ is given by\n$$\nC = 27\\,\\mathrm{mK} \\cdot x_{\\mathrm{HI}} \\cdot \\left(1 - \\frac{T_{\\gamma}}{T_{\\mathrm{S}}}\\right) \\cdot \\sqrt{\\frac{1+z}{10}}\n$$\nThe fluctuation field is $\\Delta_{21}(\\mathbf{x}) = T_{\\mathrm{b}}(\\mathbf{x}) - \\langle T_{\\mathrm{b}} \\rangle$. Since $\\langle\\delta\\rangle=0$, we have $\\langle T_{\\mathrm{b}}\\rangle = C$, and thus $\\Delta_{21}(\\mathbf{x}) = C \\cdot \\delta(\\mathbf{x})$.\n\nThe power spectrum $P_{21}(k)$ is estimated numerically. We compute the discrete Fourier transform $\\tilde{\\Delta}_{21}(\\mathbf{k}) = \\mathrm{FFT}[\\Delta_{21}(\\mathbf{x})]$. The power in each mode is $|\\tilde{\\Delta}_{21}(\\mathbf{k})|^2$. These power values are then averaged in three spherical shells in $k$-space, defined by the intervals $[0.05, 0.15)$, $[0.25, 0.35)$, and $[0.45, 0.55)$, all in units of $h\\,\\mathrm{Mpc}^{-1}$. The problem asks for a fractional change, which is a ratio of power spectra. Any normalization constant (like the volume factors relating discrete and continuous Fourier transforms) will cancel out. Therefore, we may simply average the raw $|\\tilde{\\Delta}_{21}(\\mathbf{k})|^2$ values within each bin to obtain a quantity proportional to the binned power spectrum.\n\nFinally, for cases B, C, and D, the fractional change relative to the baseline Case A is computed for each of the three $k$-bins:\n$$\n\\Delta_{\\mathrm{frac}}(k) = \\frac{P_{21}^{\\mathrm{case}}(k) - P_{21}^{\\mathrm{A}}(k)}{P_{21}^{\\mathrm{A}}(k)}\n$$\nSince $\\Delta_{21}(\\mathbf{x}) \\propto \\delta(\\mathbf{x})$, the power spectrum $P_{21}(k) \\propto P_{\\delta}(k)$, where $P_{\\delta}(k)$ is the power spectrum of the overdensity field. Specifically, $P_{21}^{\\text{case}}(k) = C_{\\text{case}}^2 P_{\\delta}(k)$. The fractional change thus simplifies to $\\Delta_{\\mathrm{frac}} = (C_{\\text{case}}/C_{\\text{A}})^2 - 1$, which is independent of the wavenumber $k$. Our numerical simulation will explicitly demonstrate this consequence of the model's simplifications by yielding nearly identical values for the fractional change in all three $k$-bins for any given case.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the sensitivity of the 21cm power spectrum to spin temperature\n    coupling prescriptions in a toy model of the epoch of reionization.\n    \"\"\"\n    \n    # 1. Define constants and parameters\n    L = 200.0  # Box side length in Mpc/h\n    N = 32     # Grid size along each dimension\n    z = 10.0   # Redshift\n    x_HI = 1.0 # Uniform neutral hydrogen fraction\n    T_K = 5.0  # Uniform gas kinetic temperature in K\n    T_alpha = T_K # Ly-alpha color temperature in K\n    x_c_on = 0.1\n    x_alpha_on = 2.0\n    n = -2.5   # Power spectrum spectral index parameter\n    k0 = 0.1   # Power spectrum pivot scale in h/Mpc\n    kc = 0.8   # Power spectrum cutoff scale in h/Mpc\n    T_CMB_0 = 2.725 # CMB temperature at z=0 in K\n    seed = 42\n\n    T_gamma = T_CMB_0 * (1.0 + z)\n    \n    # Define the four test cases\n    cases = {\n        'A': (x_c_on, x_alpha_on),    # Baseline\n        'B': (x_c_on, 0.0),           # Collisions only\n        'C': (0.0, x_alpha_on),       # Ly-alpha only\n        'D': (0.0, 0.0)              # Neither\n    }\n    case_order = ['A', 'B', 'C', 'D']\n\n    # 2. Set up Fourier space grid\n    k_vec = 2 * np.pi * np.fft.fftfreq(N, d=L/N)\n    kx, ky, kz = np.meshgrid(k_vec, k_vec, k_vec, indexing='ij')\n    k_mag = np.sqrt(kx**2 + ky**2 + kz**2)\n\n    # 3. Generate the overdensity field delta(x)\n    np.random.seed(seed)\n    # Generate Gaussian white noise in real space and transform\n    white_noise = np.random.randn(N, N, N)\n    white_noise_k = np.fft.fftn(white_noise)\n    \n    # Define transfer function T(k)\n    T_k = np.zeros_like(k_mag, dtype=np.float64)\n    non_zero_k = k_mag  0\n    k_mag_safe = k_mag[non_zero_k]\n    T_k[non_zero_k] = np.power(k_mag_safe / k0, n / 2.0) * np.exp(-0.5 * np.power(k_mag_safe / kc, 2))\n    \n    # Apply transfer function to shape the field\n    delta_k = white_noise_k * T_k\n    delta_k[0, 0, 0] = 0.0  # Set mean to zero\n\n    # Transform back to real space and ensure mean is zero\n    delta_r = np.real(np.fft.ifftn(delta_k))\n    delta_r -= np.mean(delta_r)\n\n    # 4. Define binning scheme and a function to compute binned power spectrum\n    k_bins = [\n        (0.05, 0.15),\n        (0.25, 0.35),\n        (0.45, 0.55)\n    ]\n\n    def get_binned_power_spectrum(delta_21_field):\n        \"\"\"Computes the binned power spectrum of a given field.\"\"\"\n        delta_21_k = np.fft.fftn(delta_21_field)\n        power_modes = np.abs(delta_21_k)**2\n        \n        binned_P = []\n        for k_min, k_max in k_bins:\n            mask = (k_mag = k_min)  (k_mag  k_max)\n            modes_in_bin = np.sum(mask)\n            if modes_in_bin  0:\n                # Average power of modes in the k-shell\n                p_k = np.mean(power_modes[mask])\n                binned_P.append(p_k)\n            else:\n                binned_P.append(0.0) # No modes in this bin\n        return np.array(binned_P)\n\n    # 5. Calculate power spectrum for each case\n    all_power_spectra = {}\n    prefactor_Tb = 27.0 * x_HI * np.sqrt((1.0 + z) / 10.0)\n\n    for name, (xc, xa) in cases.items():\n        # Calculate spin temperature T_S\n        denominator = 1.0 + xc + xa\n        if np.isclose(denominator, 0): # Should not happen for problem cases\n            T_S = T_gamma\n        else:\n            T_S_inv = (T_gamma**-1 + xc * T_K**-1 + xa * T_alpha**-1) / denominator\n            T_S = 1.0 / T_S_inv if T_S_inv  0 else np.inf\n\n        # Calculate the scaling constant C for the brightness temperature\n        if np.isclose(T_S, T_gamma):\n            C = 0.0\n        else:\n            C = prefactor_Tb * (1.0 - T_gamma / T_S)\n        \n        # Fluctuation field is C * delta_r\n        delta_21 = C * delta_r\n\n        # Compute and store binned power spectrum\n        all_power_spectra[name] = get_binned_power_spectrum(delta_21)\n\n    # 6. Compute and format fractional changes\n    P_A_binned = all_power_spectra['A']\n    final_results = []\n\n    for name in case_order:\n        P_case_binned = all_power_spectra[name]\n        \n        # Calculate fractional change, handling potential division by zero\n        frac_change = np.zeros_like(P_A_binned)\n        valid_bins = P_A_binned  1e-12 # Use a small threshold for float comparison\n        \n        frac_change[valid_bins] = (P_case_binned[valid_bins] - P_A_binned[valid_bins]) / P_A_binned[valid_bins]\n        \n        # Handle case where P_A(k) is zero but P_case(k) is not (very unlikely)\n        # In this specific problem, it indicates P_case(k) must also be zero\n        \n        final_results.append(list(frac_change))\n\n    # Print in the required format\n    print(str(final_results).replace(\" \", \"\"))\n\nsolve()\n```", "id": "3488955"}]}