{"hands_on_practices": [{"introduction": "Any simulation using spectral methods on a grid must correctly translate between the array indices provided by a Fast Fourier Transform (FFT) library and the physical wavevectors ($\\mathbf{k}$) of the Fourier modes. This practice focuses on mastering this crucial mapping and enforcing the Hermitian symmetry condition required to ensure that a field is purely real in configuration space. Special attention must be paid to the zero-frequency and Nyquist modes, which are self-conjugate and demand specific handling for a physically correct representation [@problem_id:3512441].", "problem": "You are generating cosmological initial conditions for a Gaussian random field on a three-dimensional periodic cubic domain with side lengths $L_x$, $L_y$, and $L_z$, discretized on a regular grid of sizes $N_x$, $N_y$, and $N_z$ with spacings $\\Delta_x = L_x/N_x$, $\\Delta_y = L_y/N_y$, and $\\Delta_z = L_z/N_z$. You will compute the first- and second-order Lagrangian perturbation theory (2LPT) displacements by solving Poisson-type equations in Fourier space, so you must accurately map Fast Fourier Transform (FFT) array indices to physical wavevector components and enforce the reality of the real-space fields.\n\nStart from the definition of the discrete Fourier transform of a real scalar field $\\delta(\\mathbf{x})$ sampled on the grid, consistent with a three-dimensional periodic Fourier series representation on integers $m_a \\in \\mathbb{Z}$ for $a \\in \\{x,y,z\\}$:\n$$\n\\delta(\\mathbf{x}_{\\mathbf{n}}) = \\sum_{\\mathbf{m}} \\tilde{\\delta}(\\mathbf{k}_{\\mathbf{m}}) \\exp\\!\\left(i \\mathbf{k}_{\\mathbf{m}} \\cdot \\mathbf{x}_{\\mathbf{n}}\\right), \\quad \\mathbf{x}_{\\mathbf{n}} = \\left(n_x \\Delta_x, n_y \\Delta_y, n_z \\Delta_z\\right), \\quad \\mathbf{k}_{\\mathbf{m}} = \\left(\\tfrac{2\\pi m_x}{L_x}, \\tfrac{2\\pi m_y}{L_y}, \\tfrac{2\\pi m_z}{L_z}\\right),\n$$\nwith $n_a \\in \\{0,1,\\dots,N_a-1\\}$. For a real field $\\delta(\\mathbf{x})$, the Fourier coefficients obey the Hermitian symmetry $\\tilde{\\delta}(-\\mathbf{k}) = \\tilde{\\delta}(\\mathbf{k})^\\ast$.\n\nIn practice, FFT libraries present the discrete spectrum in different index orderings. Two common conventions are:\n- The raw, “unshifted” FFT output ordering per axis $a$ with indices $i_a \\in \\{0,1,\\dots,N_a-1\\}$.\n- The reindexed “shifted” ordering (for example, via a function that moves the zero-frequency to the center), with indices $s_a \\in \\{0,1,\\dots,N_a-1\\}$ corresponding to ascending signed frequencies from negative to positive.\n\nTo ensure the generated Gaussian random field and all derived first-order and second-order Lagrangian perturbation theory displacement fields are strictly real in real space, it is necessary to use the correct integer-frequency mapping from FFT array indices to physical $\\mathbf{k}$ values under each convention, and to apply the correct treatment of the zero and Nyquist modes that are self-conjugate.\n\nWhich option correctly specifies:\n(i) the mapping from FFT array indices to the integer triplet $(m_x, m_y, m_z)$ and hence to physical $\\mathbf{k}$ for both the unshifted and shifted conventions in three dimensions (covering even and odd $N_a$), and\n(ii) the correct handling of the zero and Nyquist modes needed to satisfy $\\tilde{\\delta}(-\\mathbf{k}) = \\tilde{\\delta}(\\mathbf{k})^\\ast$ so that $\\delta(\\mathbf{x})$ is real?\n\nChoose the best option.\n\nA. Unshifted mapping: for each axis $a$ with size $N_a$ and raw index $i_a \\in \\{0,\\dots,N_a-1\\}$, define the integer frequency\n$$\nm_a(i_a) = \\begin{cases}\ni_a, & \\text{if } 0 \\le i_a \\le \\tfrac{N_a}{2} \\quad \\text{(even } N_a) \\\\[4pt]\ni_a - N_a, & \\text{if } \\tfrac{N_a}{2} < i_a \\le N_a - 1 \\quad \\text{(even } N_a) \\\\[6pt]\ni_a, & \\text{if } 0 \\le i_a \\le \\tfrac{N_a - 1}{2} \\quad \\text{(odd } N_a) \\\\[4pt]\ni_a - N_a, & \\text{if } \\tfrac{N_a + 1}{2} \\le i_a \\le N_a - 1 \\quad \\text{(odd } N_a)\n\\end{cases}\n$$\nShifted mapping: for each axis $a$ with shifted index $s_a \\in \\{0,\\dots,N_a - 1\\}$, define\n$$\nm_a(s_a) = s_a - \\left\\lfloor \\tfrac{N_a}{2} \\right\\rfloor,\n$$\nso that the signed integers ascend from $- \\left\\lfloor \\tfrac{N_a}{2} \\right\\rfloor$ to $+\\left\\lceil \\tfrac{N_a}{2} \\right\\rceil - 1$. The physical wavevector is\n$$\nk_a = \\frac{2\\pi m_a}{L_a}, \\quad \\mathbf{k} = (k_x, k_y, k_z).\n$$\nZero and Nyquist handling: enforce $\\tilde{\\delta}(-\\mathbf{k}) = \\tilde{\\delta}(\\mathbf{k})^\\ast$ by pairing distinct modes; for any mode that is its own negative under the discrete symmetry $2 m_a \\equiv 0 \\pmod{N_a}$ for all $a$ (that is, each component $m_a \\in \\{0, N_a/2\\}$ when $N_a$ is even), set $\\tilde{\\delta}(\\mathbf{k})$ to be purely real. In particular, the zero mode $(m_x,m_y,m_z)=(0,0,0)$ and the full set of “corner” Nyquist combinations with $m_a \\in \\{0, N_a/2\\}$ (when applicable) are real. All other modes are handled by Hermitian pairing.\n\nB. Unshifted mapping: $k_a = \\dfrac{2\\pi i_a}{L_a}$ for $i_a \\in \\{0,\\dots,N_a-1\\}$ with no wrap-around; shifted mapping: $k_a = \\dfrac{2\\pi s_a}{L_a}$. Zero and Nyquist handling: only the zero mode must be real; Nyquist modes can be complex with independent real and imaginary parts because their negatives are represented elsewhere.\n\nC. Unshifted mapping: $m_a(i_a) = i_a$ for $i_a < \\tfrac{N_a}{2}$ and $m_a(i_a) = \\tfrac{N_a}{2} - i_a$ for $i_a \\ge \\tfrac{N_a}{2}$; shifted mapping: $m_a(s_a) = s_a$ for all $s_a$. Physical wavenumbers are $k_a = \\dfrac{m_a}{\\Delta_a}$ without the factor of $2\\pi$. Zero and Nyquist handling: set the imaginary part to zero only when exactly one axis is at the Nyquist value; the zero mode need not be constrained because Hermitian symmetry will enforce reality after the inverse FFT.\n\nD. Unshifted mapping: $m_a(i_a) = i_a - N_a$ for all $i_a$; shifted mapping: $m_a(s_a) = s_a - N_a$ so that negative indices occupy the first half but zero frequency is at index $s_a = N_a$. Physical wavenumbers are $k_a = \\dfrac{\\pi m_a}{L_a}$ limited to the range $\\lvert k_a \\rvert \\le \\dfrac{\\pi}{\\Delta_a}$. Zero and Nyquist handling: treat all modes, including zero and Nyquist, as independent complex degrees of freedom and rely on numerical roundoff to cancel imaginary parts in real space.", "solution": "We begin from the periodic Fourier series on a finite three-dimensional domain. For each axis $a \\in \\{x,y,z\\}$, the continuous representation of a field on a periodic domain of length $L_a$ admits discrete Fourier modes with physical wavenumbers\n$$\nk_a = \\frac{2\\pi m_a}{L_a}, \\quad m_a \\in \\mathbb{Z}.\n$$\nSampling on a uniform grid $\\{n_a \\in \\{0,\\dots,N_a-1\\}\\}$ selects a finite set of these integers $m_a$ with associated discrete Fourier transform coefficients $\\tilde{\\delta}(\\mathbf{k}_{\\mathbf{m}})$, and the inverse transform reconstructs the field via\n$$\n\\delta(\\mathbf{x}_{\\mathbf{n}}) = \\sum_{m_x} \\sum_{m_y} \\sum_{m_z} \\tilde{\\delta}(\\mathbf{k}_{\\mathbf{m}}) \\exp\\!\\left(i \\left(\\frac{2\\pi m_x}{L_x} n_x \\Delta_x + \\frac{2\\pi m_y}{L_y} n_y \\Delta_y + \\frac{2\\pi m_z}{L_z} n_z \\Delta_z\\right)\\right),\n$$\nwith $\\Delta_a = L_a/N_a$ and $\\mathbf{x}_{\\mathbf{n}} = (n_x \\Delta_x, n_y \\Delta_y, n_z \\Delta_z)$. The discrete Fourier transform implements these sums in a particular index ordering determined by the FFT convention.\n\nThe key is the mapping from FFT array indices to the integer frequencies $\\mathbf{m} = (m_x, m_y, m_z)$, which then map to the physical $\\mathbf{k}$ via $k_a = 2\\pi m_a / L_a$. Two common conventions are the raw “unshifted” ordering and the “fftshifted” ordering.\n\nUnshifted ordering. For each axis $a$, the FFT output array has indices $i_a \\in \\{0,1,\\dots,N_a-1\\}$. The frequencies are ordered so that nonnegative integers appear first, followed by negative integers. For even $N_a$, the standard unshifted sequence of integers is\n$$\n0,\\;1,\\;2,\\;\\dots,\\;\\frac{N_a}{2},\\;-\\frac{N_a}{2}+1,\\;-\\frac{N_a}{2}+2,\\;\\dots,\\;-1,\n$$\nwhich corresponds to the mapping\n$$\nm_a(i_a) = \\begin{cases}\ni_a, & 0 \\le i_a \\le \\frac{N_a}{2} \\\\[4pt]\ni_a - N_a, & \\frac{N_a}{2} < i_a \\le N_a - 1\n\\end{cases}\n$$\nFor odd $N_a$, there is no Nyquist integer; the sequence is\n$$\n0,\\;1,\\;2,\\;\\dots,\\;\\frac{N_a-1}{2},\\;-\\frac{N_a-1}{2},\\;-\\frac{N_a-1}{2}+1,\\;\\dots,\\;-1,\n$$\nand the mapping becomes\n$$\nm_a(i_a) = \\begin{cases}\ni_a, & 0 \\le i_a \\le \\frac{N_a - 1}{2} \\\\[4pt]\ni_a - N_a, & \\frac{N_a + 1}{2} \\le i_a \\le N_a - 1\n\\end{cases}\n$$\nThese expressions encode the wrap-around (modulo $N_a$) of negative frequencies into the upper half of the index range.\n\nShifted ordering. After reindexing by a “shift” that moves the zero frequency to the middle of the array (such as an “fftshift”), the sequence of integers per axis $a$ is ascending from negative to positive. For even $N_a$, it is\n$$\n-\\frac{N_a}{2},\\;-\\frac{N_a}{2}+1,\\;\\dots,\\;-1,\\;0,\\;1,\\;\\dots,\\;\\frac{N_a}{2}-1,\n$$\nand for odd $N_a$, it is\n$$\n-\\frac{N_a - 1}{2},\\;-\\frac{N_a - 1}{2}+1,\\;\\dots,\\;-1,\\;0,\\;1,\\;\\dots,\\;\\frac{N_a - 1}{2}.\n$$\nA compact mapping that covers both cases is\n$$\nm_a(s_a) = s_a - \\left\\lfloor \\frac{N_a}{2} \\right\\rfloor, \\quad s_a \\in \\{0,\\dots,N_a - 1\\},\n$$\nwhich yields the desired ordered integer sequence. In all cases, the physical wavevector components follow from $k_a = 2\\pi m_a/L_a$.\n\nReality and Hermitian symmetry. For a real field $\\delta(\\mathbf{x})$, the discrete Fourier coefficients must satisfy Hermitian symmetry,\n$$\n\\tilde{\\delta}(-\\mathbf{k}) = \\tilde{\\delta}(\\mathbf{k})^\\ast,\n$$\nso that the inverse transform is real. For modes where $-\\mathbf{k}$ is at a distinct array index from $\\mathbf{k}$, this is enforced by generating a complex coefficient at $\\mathbf{k}$ and setting the coefficient at $-\\mathbf{k}$ to its complex conjugate. However, whenever a mode is its own negative under the discrete symmetry, the Hermitian condition reduces to $\\tilde{\\delta}(\\mathbf{k}) = \\tilde{\\delta}(\\mathbf{k})^\\ast$, implying that the coefficient is purely real. In the discrete setting, a mode is self-conjugate if and only if, for each axis $a$, the integer $m_a$ satisfies\n$$\n2 m_a \\equiv 0 \\pmod{N_a},\n$$\nwhich means $m_a \\in \\{0, N_a/2\\}$ when $N_a$ is even, and $m_a = 0$ when $N_a$ is odd. Therefore:\n- The zero mode $(m_x,m_y,m_z) = (0,0,0)$ is always purely real.\n- For even $N_a$, any “corner” combination with each component $m_a \\in \\{0, N_a/2\\}$ is self-conjugate and must be purely real. There are up to $2^d$ such points in $d$ dimensions (for $d=3$, up to $8$ points), depending on which axes have even sizes.\n- All other modes occur in $\\pm \\mathbf{k}$ pairs and must be set as complex-conjugate pairs.\n\nThis is essential in cosmological initial condition generation: improper handling of zero and Nyquist modes violates $\\tilde{\\delta}(-\\mathbf{k}) = \\tilde{\\delta}(\\mathbf{k})^\\ast$ and yields complex contamination in real-space fields, corrupting both first-order displacements (Zel’dovich approximation) and second-order Lagrangian perturbation theory corrections.\n\nWe now assess the options.\n\nOption A. This option gives the correct unshifted mappings for even and odd $N_a$, properly capturing the wrap-around of negative integers into the upper half of the index range. It provides the compact shifted mapping $m_a = s_a - \\lfloor N_a/2 \\rfloor$. The physical $k_a$ are correctly given by $k_a = 2\\pi m_a/L_a$. For reality handling, it correctly states Hermitian pairing for distinct $\\pm \\mathbf{k}$ and that any mode that is its own negative (all components satisfying $2 m_a \\equiv 0 \\pmod{N_a}$) must be purely real, explicitly including the zero mode and all Nyquist corner combinations. This is the correct and complete specification.\n\nVerdict: Correct.\n\nOption B. This option maps $k_a$ linearly to the raw indices $i_a$ without wrap-around. It does not account for negative frequencies and thus cannot recover the signed integer spectrum; it also incorrectly maps shifted indices $s_a$ directly to positive $k_a$ values. In the handling of the zero and Nyquist modes, it erroneously claims the Nyquist modes can be complex with independent real and imaginary parts. That violates the self-conjugacy condition for modes with $m_a = N_a/2$ (when even), making the inverse transform non-real.\n\nVerdict: Incorrect.\n\nOption C. This option proposes $m_a(i_a) = i_a$ for $i_a < N_a/2$ and $m_a(i_a) = N_a/2 - i_a$ otherwise, which is not the standard unshifted mapping and produces incorrect negative-frequency indices (e.g., it flips sign and magnitude in a way that does not match modulo $N_a$ arithmetic). The shifted mapping $m_a(s_a) = s_a$ is also wrong because it fails to center zero and to include negative integers. The physical wavenumbers $k_a = m_a/\\Delta_a$ omit the necessary factor of $2\\pi$ and use the wrong scaling. The zero and Nyquist handling is incorrect: self-conjugacy depends on all axes, not just exactly one axis at Nyquist, and the zero mode must be constrained to be real explicitly.\n\nVerdict: Incorrect.\n\nOption D. This option sets $m_a(i_a) = i_a - N_a$ for all $i_a$, which incorrectly shifts the entire spectrum and places zero frequency at a negative integer, not matching any common FFT ordering. The shifted mapping $m_a(s_a) = s_a - N_a$ likewise misplaces zero at index $N_a$, which is outside the valid range. The physical wavenumbers $k_a = \\pi m_a/L_a$ are missing the factor of $2$, and the stated limit $\\lvert k_a \\rvert \\le \\pi/\\Delta_a$ is a sampling-theory statement, not a mapping rule; moreover, the mapping itself is wrong. The handling of zero and Nyquist modes as independent complex degrees of freedom is incorrect and will not ensure a real inverse field.\n\nVerdict: Incorrect.\n\nTherefore, the only option that correctly provides both the index-to-$\\mathbf{k}$ mappings for common FFT conventions and the necessary zero/Nyquist handling to preserve real-field consistency is Option A.", "answer": "$$\\boxed{A}$$", "id": "3512441"}, {"introduction": "A core operation in generating initial conditions is solving the Poisson equation to obtain the gravitational potential from the density field, which in Fourier space involves division by $-k^2$. This seemingly simple step, however, harbors numerical pitfalls that can corrupt the entire simulation. This exercise explores the stability issues at the zero-frequency mode ($k=0$) and inaccuracies near the grid's Nyquist frequency, guiding you to select regularization strategies for a physically meaningful and numerically stable solution [@problem_id:3512412].", "problem": "Consider a periodic cubic domain of comoving side length $L$ discretized on a uniform grid with $N^3$ points and spacing $\\Delta = L/N$. A real-valued Gaussian random field for the density contrast $\\delta(\\mathbf{x})$ is generated in Fourier space as $\\delta(\\mathbf{k})$ with isotropic power spectrum $P(k)$ and then transformed to real space via the Fast Fourier Transform (FFT). The first-order Lagrangian potential $\\phi^{(1)}(\\mathbf{x})$ is obtained by solving the Poisson equation in Fourier space, and the second-order Lagrangian potential $\\phi^{(2)}(\\mathbf{x})$ is subsequently obtained by solving a Poisson equation with a source term $S(\\mathbf{x})$ that is quadratic in spatial derivatives of $\\phi^{(1)}(\\mathbf{x})$, consistent with Second-Order Lagrangian Perturbation Theory (2LPT). Specifically, one uses that a real-valued field has Hermitian-symmetric Fourier coefficients and that the Fourier representation of the Laplacian on a continuous periodic domain is multiplication by $-k^2$ for wavevector $\\mathbf{k} = (k_x, k_y, k_z)$ with magnitude $k = \\|\\mathbf{k}\\|$.\n\nFor FFT-based Poisson solves, numerical instabilities and artifacts can arise at the zero mode $k=0$ and near the Nyquist frequencies $k_x = \\pm k_{\\mathrm{Ny}}$, $k_y = \\pm k_{\\mathrm{Ny}}$, $k_z = \\pm k_{\\mathrm{Ny}}$, where $k_{\\mathrm{Ny}} = \\pi/\\Delta$. The zero mode corresponds to the spatial mean, for which the Poisson operator is singular. The Nyquist modes are the highest resolvable frequencies per axis on the discrete grid and are sensitive to aliasing and anisotropy of the discrete operator.\n\nStarting from the following fundamental bases: (i) the definition of the Fourier transform on a periodic domain, (ii) the Laplacian acting as multiplication by $-k^2$ in the continuum, (iii) the requirement of Hermitian symmetry $\\delta(-\\mathbf{k}) = \\delta^{*}(\\mathbf{k})$ for real-valued fields, and (iv) the sampling theorem that defines the Nyquist frequency and aliasing constraints, analyze how division by $k^2$ in the Fourier-space Poisson solve affects numerical stability near $k=0$ and at Nyquist modes. Then, determine which of the following strategies are valid and necessary to regularize the zero and Nyquist modes to prevent spurious artifacts in $\\phi^{(1)}$ and $\\phi^{(2)}$:\n\nA. Explicitly set $\\phi^{(1)}(\\mathbf{k}=\\mathbf{0}) = 0$ and $\\phi^{(2)}(\\mathbf{k}=\\mathbf{0}) = 0$, thereby choosing the gauge in which the spatial mean of the potentials is zero and ensuring no uniform displacement or acceleration, consistent with periodic boundary conditions.\n\nB. Replace the continuum $k^2$ in the Fourier-space Poisson operator by the eigenvalue of the discrete Laplacian on the grid, for example $\\lambda(\\mathbf{k}) = \\frac{2}{\\Delta^2}\\left[3 - \\cos(k_x \\Delta) - \\cos(k_y \\Delta) - \\cos(k_z \\Delta)\\right]$, and solve $\\phi^{(1)}(\\mathbf{k}) = -\\delta(\\mathbf{k})/\\lambda(\\mathbf{k})$ for $\\mathbf{k} \\neq \\mathbf{0}$, with an analogous step for $\\phi^{(2)}(\\mathbf{k})$, to mitigate anisotropy and reduce amplification of numerical noise near the Nyquist frequencies.\n\nC. Preserve power at the Nyquist by retaining all Nyquist coefficients with their initially drawn amplitudes and random phases, since they are part of the spectrum; avoid any special treatment to prevent biasing the power spectrum.\n\nD. Introduce a small softening parameter $\\varepsilon > 0$ and replace $k^2$ by $k^2 + \\varepsilon$ in the denominator for all $\\mathbf{k}$, then renormalize the large-scale power spectrum $P(k)$ after the Poisson solve to match the input spectrum; this avoids division by very small $k^2$ and prevents overflow.\n\nE. Enforce Hermitian symmetry for all Fourier coefficients of $\\delta(\\mathbf{k})$, $\\phi^{(1)}(\\mathbf{k})$, the source $S(\\mathbf{k})$, and $\\phi^{(2)}(\\mathbf{k})$; in particular, constrain the Nyquist planes and axes so that coefficients at $k_i = \\pm k_{\\mathrm{Ny}}$ are purely real and consistent across conjugate pairs, and set ambiguous Nyquist modes to zero to avoid aliasing into real-space artifacts.\n\nChoose all options that are correct in the sense of ensuring numerical stability and physical fidelity of $\\phi^{(1)}$ and $\\phi^{(2)}$ in the FFT-based Poisson solve within a periodic cosmological initial-condition generator.", "solution": "The problem concerns the numerical generation of cosmological initial conditions, specifically the gravitational potentials $\\phi^{(1)}$ and $\\phi^{(2)}$ from the density contrast field $\\delta$ using Second-Order Lagrangian Perturbation Theory (2LPT). This requires solving a Poisson equation of the form $\\nabla^2 \\phi = \\psi$ on a discrete, periodic grid. The standard method involves using the Fast Fourier Transform (FFT), which transforms the differential equation into an algebraic one in Fourier space. In the continuum limit, the Laplacian operator $\\nabla^2$ corresponds to multiplication by $-k^2$, where $k = \\|\\mathbf{k}\\|$ is the magnitude of the wavevector $\\mathbf{k}$. The solution for the Fourier modes of the potential is then formally $\\phi(\\mathbf{k}) = -\\psi(\\mathbf{k}) / k^2$.\n\nThis procedure encounters numerical and physical issues at two specific locations in Fourier space: the zero mode ($\\mathbf{k}=\\mathbf{0}$) and the Nyquist modes (where one or more components of $\\mathbf{k}$ are at the grid's maximum frequency, $k_{\\mathrm{Ny}}$).\n\n1.  **The Zero Mode ($\\mathbf{k}=\\mathbf{0}$):** At this mode, $k^2 = 0$, leading to a division by zero. This singularity reflects a fundamental property of the Poisson equation on a periodic domain: the solution is only defined up to an additive constant. This corresponds to a gauge freedom in the potential, as the physical quantities of interest (velocity and particle displacement) are derived from the *gradient* of the potential, which is unaffected by a constant offset. For the first-order potential $\\phi^{(1)}$, the source is the density contrast $\\delta$. By definition, the mean density contrast over the entire cosmological volume is zero, so $\\delta(\\mathbf{k}=\\mathbf{0}) = \\int \\delta(\\mathbf{x}) d^3\\mathbf{x} = 0$. The equation becomes $0 \\cdot \\phi^{(1)}(\\mathbf{0}) = 0$, which is indeterminate. For the second-order potential $\\phi^{(2)}$, the source term $S(\\mathbf{x})$ is quadratic in derivatives of $\\phi^{(1)}$ and its spatial mean $S(\\mathbf{k}=\\mathbf{0})$ is not guaranteed to be zero. A non-zero mean source is incompatible with a periodic solution for the Poisson equation. A choice must be made to regularize the problem.\n\n2.  **The Nyquist Modes:** These modes correspond to the highest frequencies resolvable on the grid, $k_i = \\pm k_{\\mathrm{Ny}} = \\pm \\pi/\\Delta$ for each Cartesian direction $i \\in \\{x, y, z\\}$. At these scales, two primary issues arise. First, the continuum approximation $\\nabla^2 \\leftrightarrow -k^2$ becomes inaccurate. The properties of the discrete grid and the finite-difference nature of discrete derivatives become dominant, leading to anisotropy and incorrect amplification of high-frequency modes. Second, for the generated fields $\\delta(\\mathbf{x})$, $\\phi^{(1)}(\\mathbf{x})$, and $\\phi^{(2)}(\\mathbf{x})$ to be real-valued, their Fourier transforms must exhibit Hermitian symmetry: $\\mathcal{F}(-\\mathbf{k}) = \\mathcal{F}^*(\\mathbf{k})$ for any field $\\mathcal{F}$. This property imposes specific constraints on the Fourier coefficients at the Nyquist frequencies that must be explicitly enforced.\n\nBased on these principles, we evaluate each proposed strategy.\n\n**A. Explicitly set $\\phi^{(1)}(\\mathbf{k}=\\mathbf{0}) = 0$ and $\\phi^{(2)}(\\mathbf{k}=\\mathbf{0}) = 0$, thereby choosing the gauge in which the spatial mean of the potentials is zero and ensuring no uniform displacement or acceleration, consistent with periodic boundary conditions.**\nThis strategy directly addresses the singularity at $\\mathbf{k}=\\mathbf{0}$. Setting the mean of the potentials to zero is a valid gauge choice. This choice has a clear physical interpretation: it ensures that there is no net displacement ($\\propto \\nabla\\phi^{(1)}$) or net acceleration ($\\propto \\nabla\\phi^{(2)}$) of the entire simulation volume, which is a necessary condition for a system in comoving coordinates with periodic boundary conditions. For $\\phi^{(1)}$, since $\\delta(\\mathbf{0})=0$, this is a simple resolution of the $0/0$ indeterminacy. For $\\phi^{(2)}$, where $S(\\mathbf{0})$ may be non-zero, this procedure effectively solves for the potential corresponding to the source $S(\\mathbf{x}) - \\langle S \\rangle$, which is the standard and correct approach.\n**Verdict: Correct**\n\n**B. Replace the continuum $k^2$ in the Fourier-space Poisson operator by the eigenvalue of the discrete Laplacian on the grid, for example $\\lambda(\\mathbf{k}) = \\frac{2}{\\Delta^2}\\left[3 - \\cos(k_x \\Delta) - \\cos(k_y \\Delta) - \\cos(k_z \\Delta)\\right]$, and solve $\\phi^{(1)}(\\mathbf{k}) = -\\delta(\\mathbf{k})/\\lambda(\\mathbf{k})$ for $\\mathbf{k} \\neq \\mathbf{0}$, with an analogous step for $\\phi^{(2)}(\\mathbf{k})$, to mitigate anisotropy and reduce amplification of numerical noise near the Nyquist frequencies.**\nThis strategy addresses the inaccuracy of the continuum operator $-k^2$ at high frequencies. The provided expression $\\lambda(\\mathbf{k})$ is precisely the negative of the eigenvalue of the standard second-order centered finite-difference Laplacian on a 3D grid. Using this discrete operator ensures that the Poisson solve is mathematically consistent with a well-defined finite-difference scheme on the grid. While for small $k$ (large scales), $\\lambda(\\mathbf{k}) \\approx k^2$, its behavior near the Nyquist frequency is different and correctly captures the anisotropic nature of the discrete grid, thus improving the fidelity of the solution at small scales. This is a standard technique in high-precision numerical codes to ensure stability and accuracy.\n**Verdict: Correct**\n\n**C. Preserve power at the Nyquist by retaining all Nyquist coefficients with their initially drawn amplitudes and random phases, since they are part of the spectrum; avoid any special treatment to prevent biasing the power spectrum.**\nThis strategy is incorrect because it ignores a fundamental requirement for real-valued fields. The Hermitian symmetry condition, $\\mathcal{F}(-\\mathbf{k}) = \\mathcal{F}^*(\\mathbf{k})$, imposes that Fourier coefficients at wavevectors $\\mathbf{k}$ where $\\mathbf{k}$ is equivalent to $-\\mathbf{k}$ (up to a reciprocal lattice vector) must be purely real. This is the case for modes on the Nyquist axes and planes. Generating these coefficients with arbitrary random phases violates this condition and will result in a complex-valued field in real space after the inverse FFT, which is a non-physical artifact. Special treatment of Nyquist modes is not a bias but a necessary step to enforce physical reality.\n**Verdict: Incorrect**\n\n**D. Introduce a small softening parameter $\\varepsilon > 0$ and replace $k^2$ by $k^2 + \\varepsilon$ in the denominator for all $\\mathbf{k}$, then renormalize the large-scale power spectrum $P(k)$ after the Poisson solve to match the input spectrum; this avoids division by very small $k^2$ and prevents overflow.**\nThis is a brute-force regularization method that avoids the division-by-zero at $\\mathbf{k}=\\mathbf{0}$ but does so by fundamentally changing the governing equation from the Poisson equation to a Helmholtz-like equation, $(\\nabla^2 - \\varepsilon)\\phi = \\psi$. This introduces an artificial screening length scale $\\sim 1/\\sqrt{\\varepsilon}$ and systematically suppresses the potential on large scales. The suggestion to \"renormalize\" the result is ad hoc and cannot fully compensate for the scale-dependent error introduced. A much cleaner, more principled, and physically motivated solution exists via the gauge choice described in option A.\n**Verdict: Incorrect**\n\n**E. Enforce Hermitian symmetry for all Fourier coefficients of $\\delta(\\mathbf{k})$, $\\phi^{(1)}(\\mathbf{k})$, the source $S(\\mathbf{k})$, and $\\phi^{(2)}(\\mathbf{k})$; in particular, constrain the Nyquist planes and axes so that coefficients at $k_i = \\pm k_{\\mathrm{Ny}}$ are purely real and consistent across conjugate pairs, and set ambiguous Nyquist modes to zero to avoid aliasing into real-space artifacts.**\nThis statement correctly describes a set of fundamental constraints and best practices. For any real-valued field $\\mathcal{F}(\\mathbf{x})$, its Fourier transform $\\mathcal{F}(\\mathbf{k})$ must be Hermitian. Since $\\delta$, $\\phi^{(1)}$, and $\\phi^{(2)}$ are real fields, this property must hold for their Fourier representations. This is not an optional strategy but a mandatory condition. As explained in the analysis of option C, this has specific, non-trivial consequences for the Nyquist modes, requiring certain coefficients to be real. Setting ambiguous or problematic modes (like the highest-frequency corners of the Fourier box) to zero is a common and safe practice to prevent numerical artifacts and ensure the reality of the transformed field, as these modes contain negligible power and are poorly resolved.\n**Verdict: Correct**\n\nIn summary, a robust numerical implementation requires fixing the gauge at the zero mode (A), enforcing Hermitian symmetry for all fields (E), and ideally, using a discrete form of the Laplacian for better accuracy at high frequencies (B).", "answer": "$$\\boxed{ABE}$$", "id": "3512412"}, {"introduction": "The second-order Lagrangian Perturbation Theory (2LPT) source term involves a non-linear combination of second derivatives of the potential, making its implementation prone to subtle errors. A powerful technique for ensuring correctness is to validate the code against a known analytic solution, a cornerstone of rigorous code verification. This practice guides you through designing a \"test harness\" that injects a simple tidal field as the initial potential, allowing you to compare your numerically computed 2LPT displacement against the exact analytical result [@problem_id:3512423].", "problem": "Design and implement a self-contained program that constructs a periodic, three-dimensional Lagrangian perturbation theory test harness to validate second-order Lagrangian perturbation theory (2LPT) anisotropic displacements induced by a known tidal quadrupole in the initial potential. Work entirely with dimensionless quantities on a periodic cube of side length $L$, and use discrete Fourier transforms to solve Poisson-type equations. The program must produce a single line of output containing a list of floating-point values, each corresponding to the maximum relative error between numerical and analytic root-mean-square (RMS) components of the 2LPT displacement for a specified test case.\n\nBegin from the following bases:\n- The Lagrangian displacement is expanded as $\\boldsymbol{\\Psi} = \\sum_{n \\ge 1} \\boldsymbol{\\Psi}^{(n)}$ with $\\boldsymbol{\\Psi}^{(n)} = -\\boldsymbol{\\nabla} \\phi^{(n)}$, where $\\phi^{(n)}$ is the scalar potential at order $n$.\n- The governing second-order equation for the scalar potential in second-order Lagrangian perturbation theory (2LPT) is\n$$\n\\nabla^2 \\phi^{(2)}(\\boldsymbol{x}) \\;=\\; \\sum_{i>j} \\left( \\phi^{(1)}_{,ii}(\\boldsymbol{x}) \\, \\phi^{(1)}_{,jj}(\\boldsymbol{x}) \\;-\\; \\left[\\phi^{(1)}_{,ij}(\\boldsymbol{x})\\right]^2 \\right),\n$$\nwhere $\\phi^{(1)}_{,ij} \\equiv \\partial_i \\partial_j \\phi^{(1)}$.\n\nInject a known, spatially periodic tidal quadrupole into the initial (first-order) potential by prescribing\n$$\n\\phi^{(1)}(\\boldsymbol{x}) \\;=\\; A \\sum_{i \\in \\{x,y,z\\}} a_i \\cos\\!\\left( K \\, x_i \\right),\n$$\nwith $A$ a dimensionless amplitude, $\\boldsymbol{a} = (a_x,a_y,a_z)$ a dimensionless coefficient triplet that encodes the quadrupolar anisotropy, and $K = 2\\pi m / L$ the fundamental wavenumber with integer mode index $m$. Use $m = 1$. Work on a regular grid with $N^3$ points on the periodic cube $[0,L)^3$.\n\nTasks to implement:\n1. Construct the real-space source term for the 2LPT scalar potential using only first-order second derivatives,\n$$\nS(\\boldsymbol{x}) \\;\\equiv\\; \\sum_{i>j} \\left( \\phi^{(1)}_{,ii} \\phi^{(1)}_{,jj} - \\left[\\phi^{(1)}_{,ij}\\right]^2 \\right).\n$$\nFor the separable cosine ansatz above, $\\phi^{(1)}_{,ij} = 0$ for $i \\neq j$ and $\\phi^{(1)}_{,ii} = -A \\, a_i \\, K^2 \\cos(K x_i)$, so that\n$$\nS(\\boldsymbol{x}) \\;=\\; A^2 K^4 \\left( a_x a_y \\cos(K x) \\cos(K y) \\;+\\; a_x a_z \\cos(K x) \\cos(K z) \\;+\\; a_y a_z \\cos(K y) \\cos(K z) \\right).\n$$\n2. Solve the Poisson equation for the second-order potential on the periodic cube using spectral methods,\n$$\n\\nabla^2 \\phi^{(2)}(\\boldsymbol{x}) \\;=\\; S(\\boldsymbol{x}),\n$$\nwith periodic boundary conditions and vanishing mean for $\\phi^{(2)}$. In Fourier space, for each nonzero wavevector $\\boldsymbol{k} = (k_x,k_y,k_z)$ with $k^2 = k_x^2 + k_y^2 + k_z^2$, the solution satisfies\n$$\n\\tilde{\\phi}^{(2)}(\\boldsymbol{k}) \\;=\\; - \\frac{\\tilde{S}(\\boldsymbol{k})}{k^2}, \\quad \\text{and} \\quad \\tilde{\\phi}^{(2)}(\\boldsymbol{0}) \\;=\\; 0,\n$$\nwhere tildes denote discrete Fourier transforms.\n3. Compute the second-order displacement field by spectral differentiation,\n$$\n\\tilde{\\Psi}^{(2)}_i(\\boldsymbol{k}) \\;=\\; i k_i \\, \\tilde{\\phi}^{(2)}(\\boldsymbol{k}), \\quad \\text{and inverse transform to obtain } \\Psi^{(2)}_i(\\boldsymbol{x}).\n$$\n4. Compute the numerical RMS of each component over the full grid,\n$$\n\\mathrm{RMS}^{\\mathrm{num}}_i \\;=\\; \\sqrt{\\langle \\left(\\Psi^{(2)}_i(\\boldsymbol{x})\\right)^2 \\rangle_{\\boldsymbol{x}} }.\n$$\n5. Derive and evaluate the analytic RMS for the chosen separable cosine ansatz. Using independence of factors across coordinates on the uniform grid and $\\langle \\sin^2(K x_i) \\rangle = 1/2$, $\\langle \\cos^2(K x_i) \\rangle = 1/2$, the $i$-th component’s RMS is\n$$\n\\mathrm{RMS}^{\\mathrm{ana}}_i \\;=\\; \\frac{A^2 K^3}{4} \\, \\sqrt{ a_i^2 \\left( \\sum_{j \\neq i} a_j^2 \\right) }.\n$$\n6. For each specified test case, report the maximum relative error across components,\n$$\n\\epsilon_{\\max} \\;=\\; \\max_{i \\in \\{x,y,z\\}} \\begin{cases}\n\\left| \\dfrac{\\mathrm{RMS}^{\\mathrm{num}}_i - \\mathrm{RMS}^{\\mathrm{ana}}_i}{\\mathrm{RMS}^{\\mathrm{ana}}_i} \\right|, & \\text{if}\\ \\mathrm{RMS}^{\\mathrm{ana}}_i \\neq 0, \\\\\n\\left| \\mathrm{RMS}^{\\mathrm{num}}_i \\right|, & \\text{if}\\ \\mathrm{RMS}^{\\mathrm{ana}}_i = 0.\n\\end{cases}\n$$\n\nNumerical implementation requirements:\n- Use a periodic cube with side length $L = 1$ and grid size $N = 64$ for all tests.\n- Use $m = 1$, hence $K = 2\\pi$.\n- Use discrete Fourier transforms with wave numbers $k_i = 2\\pi \\, n_i / L$, where $n_i$ are the standard integer frequencies corresponding to the discrete Fourier transform on a grid of size $N$.\n- Use dimensionless units throughout.\n\nTest suite:\n- Case $1$: $(A, a_x, a_y, a_z) = (0.05, 1, -1, 0)$.\n- Case $2$: $(A, a_x, a_y, a_z) = (0.1, 1, 1, -2)$.\n- Case $3$: $(A, a_x, a_y, a_z) = (0.2, 0, 0, 0)$.\n\nRequired output:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of the test cases, for example, $[\\epsilon_1,\\epsilon_2,\\epsilon_3]$. Each $\\epsilon_i$ must be a floating-point number.\n\nNo physical units appear; all quantities are strictly dimensionless. Angles, when they appear inside trigonometric functions, are in radians by construction of the discrete Fourier representation.", "solution": "The user-provided problem is assessed as valid. It is scientifically sound, well-posed, objective, and contains all necessary information for a unique solution. The core task is to implement a numerical test of second-order Lagrangian Perturbation Theory (2LPT) against a prescribed analytic solution, a standard validation procedure in computational cosmology. The methodology relies on established principles of Fourier analysis for solving differential equations on periodic domains.\n\nThe following is a principled, step-by-step description of the implemented solution.\n\nThe program's objective is to compute the maximum relative error between a numerically calculated second-order Lagrangian displacement field, $\\boldsymbol{\\Psi}^{(2)}$, and its known analytical counterpart for a specific initial condition. The entire procedure is carried out on a three-dimensional periodic grid.\n\n**1. Grid and Constant Initialization**\nThe simulation domain is a periodic cube of side length $L=1$, discretized on a regular grid of $N^3$ points, with $N=64$. The fundamental wavenumber for the initial potential is $K = 2\\pi m / L$, where the mode index is $m=1$. Since $L=1$, this simplifies to $K=2\\pi$. We construct three-dimensional coordinate arrays $x, y, z$ representing the grid points $(x_i, y_j, z_k)$ for $i,j,k \\in \\{0, 1, \\dots, N-1\\}$.\n\n**2. Construction of the 2LPT Source Term**\nThe problem begins with a prescribed first-order potential, $\\phi^{(1)}$, which is a separable cosine ansatz:\n$$\n\\phi^{(1)}(\\boldsymbol{x}) \\;=\\; A \\sum_{i \\in \\{x,y,z\\}} a_i \\cos\\!\\left( K \\, x_i \\right)\n$$\nThe source term $S(\\boldsymbol{x})$ for the second-order potential, $\\phi^{(2)}$, is defined by the derivatives of $\\phi^{(1)}$:\n$$\nS(\\boldsymbol{x}) \\;\\equiv\\; \\sum_{i>j} \\left( \\phi^{(1)}_{,ii} \\phi^{(1)}_{,jj} - \\left[\\phi^{(1)}_{,ij}\\right]^2 \\right)\n$$\nFor the given separable form of $\\phi^{(1)}$, the cross-derivatives $\\phi^{(1)}_{,ij}$ for $i \\neq j$ are zero. The second derivatives are $\\phi^{(1)}_{,ii} = -A \\, a_i \\, K^2 \\cos(K x_i)$. Substituting these into the definition of $S(\\boldsymbol{x})$ yields the analytical expression used in the code:\n$$\nS(\\boldsymbol{x}) \\;=\\; A^2 K^4 \\left( a_x a_y \\cos(K x) \\cos(K y) \\;+\\; a_x a_z \\cos(K x) \\cos(K z) \\;+\\; a_y a_z \\cos(K y) \\cos(K z) \\right)\n$$\nThis source term is evaluated on the real-space grid for the given parameters $A$ and $\\boldsymbol{a}=(a_x, a_y, a_z)$ of each test case.\n\n**3. Spectral Solution for the Second-Order Potential**\nThe second-order potential $\\phi^{(2)}$ is governed by the Poisson equation $\\nabla^2 \\phi^{(2)}(\\boldsymbol{x}) = S(\\boldsymbol{x})$. On a periodic domain, this equation is most efficiently solved using spectral methods.\nFirst, the source term is transformed into Fourier space using the three-dimensional Fast Fourier Transform (FFT), $\\tilde{S}(\\boldsymbol{k}) = \\mathcal{F}[S(\\boldsymbol{x})]$, which is implemented with `scipy.fft.fftn`.\nIn Fourier space, the Laplacian operator $\\nabla^2$ becomes multiplication by $-k^2$, where $k^2 = k_x^2 + k_y^2 + k_z^2$ is the squared magnitude of the wavevector $\\boldsymbol{k}$. The discrete wavevectors $k_i$ corresponding to the grid are generated using `scipy.fft.fftfreq`.\nThe Poisson equation thus transforms into an algebraic equation for the Fourier modes of the potential:\n$$\n-k^2 \\tilde{\\phi}^{(2)}(\\boldsymbol{k}) = \\tilde{S}(\\boldsymbol{k}) \\quad \\implies \\quad \\tilde{\\phi}^{(2)}(\\boldsymbol{k}) = - \\frac{\\tilde{S}(\\boldsymbol{k})}{k^2}\n$$\nThis solution is valid for all $\\boldsymbol{k} \\neq \\boldsymbol{0}$. For the zero-frequency mode ($\\boldsymbol{k}=\\boldsymbol{0}$), division by $k^2=0$ is undefined. The physical constraint of zero mean for the potential, $\\langle \\phi^{(2)} \\rangle=0$, sets the Fourier-space DC component to zero, $\\tilde{\\phi}^{(2)}(\\boldsymbol{0})=0$. This is handled explicitly in the code.\n\n**4. Computation of the 2LPT Displacement Field**\nThe 2LPT displacement field is the negative gradient of the potential, $\\boldsymbol{\\Psi}^{(2)} = -\\boldsymbol{\\nabla}\\phi^{(2)}$. Similar to the Laplacian, the gradient operator has a simple representation in Fourier space: $\\mathcal{F}[\\boldsymbol{\\nabla} f(\\boldsymbol{x})] = i\\boldsymbol{k}\\tilde{f}(\\boldsymbol{k})$.\nTherefore, the Fourier modes of the displacement field components are computed by:\n$$\n\\tilde{\\Psi}^{(2)}_i(\\boldsymbol{k}) = -i k_i \\tilde{\\phi}^{(2)}(\\boldsymbol{k})\n$$\nOnce the Fourier-space displacement components $\\tilde{\\Psi}^{(2)}_i(\\boldsymbol{k})$ are calculated, they are transformed back to real space using the inverse FFT (`scipy.fft.ifftn`). Since the original field is real, the resulting displacement components $\\Psi^{(2)}_i(\\boldsymbol{x})$ must also be real. We explicitly take the real part of the inverse FFT output to discard any small, spurious imaginary components arising from floating-point inaccuracies.\n\n**5. Validation and Error Calculation**\nThe final part of the process is to validate the numerical result.\nThe numerical root-mean-square (RMS) of each displacement component is computed by taking the square root of the mean of the squared field values over the entire grid:\n$$\n\\mathrm{RMS}^{\\mathrm{num}}_i \\;=\\; \\sqrt{\\frac{1}{N^3} \\sum_{\\boldsymbol{x}} \\left(\\Psi^{(2)}_i(\\boldsymbol{x})\\right)^2 }\n$$\nThis is implemented using `numpy.sqrt` and `numpy.mean`.\nThese numerical results are compared against the analytically derived RMS values, provided in the problem statement:\n$$\n\\mathrm{RMS}^{\\mathrm{ana}}_i \\;=\\; \\frac{A^2 K^3}{4} \\, \\sqrt{ a_i^2 \\left( \\sum_{j \\neq i} a_j^2 \\right) }\n$$\nFor each component $i \\in \\{x,y,z\\}$, the relative error is computed. A conditional check is necessary to handle cases where the analytical RMS is zero. If $\\mathrm{RMS}^{\\mathrm{ana}}_i = 0$, the error is defined as the absolute value of the numerical RMS, $|\\mathrm{RMS}^{\\mathrm{num}}_i|$. Otherwise, it is the standard relative error, $|\\mathrm{RMS}^{\\mathrm{num}}_i - \\mathrm{RMS}^{\\mathrm{ana}}_i| / |\\mathrm{RMS}^{\\mathrm{ana}}_i|$.\nThe final output for each test case is the maximum of these three component-wise errors, $\\epsilon_{\\max}$. This entire procedure is repeated for all specified test cases.", "answer": "```python\nimport numpy as np\nfrom scipy import fft\n\ndef compute_2lpt_error(params):\n    \"\"\"\n    Computes the maximum relative error for 2LPT displacement for one test case.\n\n    This function implements the full chain:\n    1. Set up the grid and initial potential parameters.\n    2. Compute the real-space source term S(x).\n    3. Solve the Poisson equation for phi^(2) in Fourier space.\n    4. Compute the displacement field Psi^(2) via spectral differentiation.\n    5. Calculate numerical and analytical RMS values.\n    6. Return the maximum relative error across components.\n    \"\"\"\n    # Unpack test case parameters\n    A, ax, ay, az = params\n\n    # Numerical and physical constants\n    L = 1.0\n    N = 64\n    m = 1\n    K = 2.0 * np.pi * m / L\n\n    # 1. Construct the real-space grid\n    grid_1d = np.arange(N, dtype=float) * L / N\n    # Use 'ij' indexing for coordinate arrays to match the typical (x,y,z) loop order\n    x, y, z = np.meshgrid(grid_1d, grid_1d, grid_1d, indexing='ij')\n\n    # 2. Construct the real-space source term for the 2LPT scalar potential\n    S = A**2 * K**4 * (\n        ax * ay * np.cos(K * x) * np.cos(K * y) +\n        ax * az * np.cos(K * x) * np.cos(K * z) +\n        ay * az * np.cos(K * y) * np.cos(K * z)\n    )\n\n    # 3. Solve the Poisson equation using spectral methods\n    # Fourier transform the source term\n    S_k = fft.fftn(S)\n\n    # Create the k-space grid of wavevectors\n    k_freq = fft.fftfreq(N, d=L / N) * 2.0 * np.pi\n    kx, ky, kz = np.meshgrid(k_freq, k_freq, k_freq, indexing='ij')\n    \n    # Calculate k-squared, handling the k=0 mode to avoid division by zero\n    k_squared = kx**2 + ky**2 + kz**2\n    # The [0,0,0] element is the DC mode (k=0).\n    # Temporarily set k_squared[0,0,0] to a non-zero value to avoid a warning.\n    k_squared[0, 0, 0] = 1.0\n\n    # Solve for phi_2_k = -S_k / k^2\n    phi2_k = -S_k / k_squared\n    # Enforce zero mean for phi^(2) by setting the k=0 mode to zero.\n    phi2_k[0, 0, 0] = 0.0\n\n    # 4. Compute the second-order displacement field by spectral differentiation\n    # Psi_i = -grad_i phi  =>  Psi_i_k = -i * k_i * phi_k\n    Psi2x_k = -1j * kx * phi2_k\n    Psi2y_k = -1j * ky * phi2_k\n    Psi2z_k = -1j * kz * phi2_k\n\n    # Inverse transform to get real-space displacement fields\n    Psi2x = fft.ifftn(Psi2x_k).real\n    Psi2y = fft.ifftn(Psi2y_k).real\n    Psi2z = fft.ifftn(Psi2z_k).real\n\n    # 5. Compute the numerical RMS of each displacement component\n    rms_num_x = np.sqrt(np.mean(Psi2x**2))\n    rms_num_y = np.sqrt(np.mean(Psi2y**2))\n    rms_num_z = np.sqrt(np.mean(Psi2z**2))\n    rms_num = np.array([rms_num_x, rms_num_y, rms_num_z])\n\n    # 6. Derive and evaluate the analytic RMS\n    prefactor = (A**2 * K**3) / 4.0\n    a = np.array([ax, ay, az])\n    \n    rms_ana_x = prefactor * np.sqrt(a[0]**2 * (a[1]**2 + a[2]**2))\n    rms_ana_y = prefactor * np.sqrt(a[1]**2 * (a[0]**2 + a[2]**2))\n    rms_ana_z = prefactor * np.sqrt(a[2]**2 * (a[0]**2 + a[1]**2))\n    rms_ana = np.array([rms_ana_x, rms_ana_y, rms_ana_z])\n\n    # 7. Compute the maximum relative error across components\n    errors = np.zeros(3)\n    for i in range(3):\n        if rms_ana[i] != 0.0:\n            errors[i] = np.abs((rms_num[i] - rms_ana[i]) / rms_ana[i])\n        else:\n            errors[i] = np.abs(rms_num[i])\n            \n    return np.max(errors)\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (0.05, 1.0, -1.0, 0.0),   # Case 1\n        (0.1, 1.0, 1.0, -2.0),    # Case 2\n        (0.2, 0.0, 0.0, 0.0),     # Case 3\n    ]\n\n    results = []\n    for case in test_cases:\n        max_error = compute_2lpt_error(case)\n        results.append(max_error)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == '__main__':\n    solve()\n```", "id": "3512423"}]}