{"hands_on_practices": [{"introduction": "Before tackling complex numerical schemes, it is essential to master the fundamental algebraic relationship between conserved and primitive variables. This first exercise provides a direct, hands-on calculation for a simple fluid state governed by the Euler equations. By manually inverting a given conserved state $U = (\\rho, \\mathbf{m}, E)$ to find its corresponding pressure $p$ and sound speed $c_s$, you will solidify your understanding of the core definitions and practice the crucial step of verifying the physical admissibility of a numerical state [@problem_id:3530060].", "problem": "Consider a three-dimensional Newtonian compressible ideal gas governed by the Euler equations. The conserved variables are the mass density, the momentum density vector, and the total energy density, denoted by $U = (\\rho, \\mathbf{m}, E)$. The primitive variables are the mass density, the velocity vector, and the pressure, denoted by $(\\rho, \\mathbf{v}, p)$. For an ideal gas with adiabatic index $\\gamma$, the internal energy per unit mass, $e$, and the pressure, $p$, are related by the ideal gas closure. The adiabatic sound speed $c_{s}$ is determined by local thermodynamic state through linearization of the equations about a uniform state.\n\nYou are given the numerical state\n$$\n\\rho = 3.0 \\times 10^{-19}, \\quad \\mathbf{m} = \\left(6.0 \\times 10^{-15},\\,-4.0 \\times 10^{-15},\\,2.0 \\times 10^{-15}\\right), \\quad E = 6.0 \\times 10^{-10},\n$$\nand the adiabatic index\n$$\n\\gamma = \\frac{5}{3}.\n$$\nAll quantities are in the International System of Units (SI): $\\rho$ in $\\mathrm{kg\\,m^{-3}}$, $\\mathbf{m}$ in $\\mathrm{kg\\,m^{-2}\\,s^{-1}}$, and $E$ in $\\mathrm{J\\,m^{-3}}$. The ideal gas closure and the standard definitions of conserved and primitive variables apply.\n\nTask:\n- Starting from the conservation-law definitions of $U$ and the ideal gas closure between $e$ and $p$, invert to obtain the pressure $p$ and the adiabatic sound speed $c_{s}$ for the given state.\n- Explicitly compute $p$ and $c_{s}$ and verify the positivity and admissibility conditions, including $p > 0$, $\\rho > 0$, and $c_{s}^{2} \\ge 0$; comment on the necessary condition on the total energy density for admissibility in terms of the kinetic energy density.\n- Express $p$ in pascals and $c_{s}$ in $\\mathrm{km\\,s^{-1}}$, and round each to four significant figures.\n\nYour final reported answer must be the pair $(p, c_{s})$.", "solution": "The problem asks for the conversion from conserved variables to primitive variables for a state governed by the Euler equations for a compressible ideal gas. We are given the conserved state vector $U = (\\rho, \\mathbf{m}, E)$ and the adiabatic index $\\gamma$, and are tasked with finding the pressure $p$ and the adiabatic sound speed $c_s$.\n\nThe conserved variables are the mass density $\\rho$, the momentum density vector $\\mathbf{m}$, and the total energy density $E$. The primitive variables are the mass density $\\rho$, the fluid velocity vector $\\mathbf{v}$, and the pressure $p$. The relationship between these sets of variables is defined as follows:\n1.  Mass density $\\rho$ is common to both sets.\n2.  The momentum density is defined as $\\mathbf{m} = \\rho \\mathbf{v}$.\n3.  The total energy density $E$ is the sum of the kinetic energy density and the internal energy density: $E = E_{\\text{kin}} + E_{\\text{int}}$.\n    The kinetic energy density is given by $E_{\\text{kin}} = \\frac{1}{2}\\rho |\\mathbf{v}|^2$.\n    The internal energy density is given by $E_{\\text{int}} = \\rho e$, where $e$ is the specific internal energy (internal energy per unit mass).\n\nFor an ideal gas, the pressure $p$ is related to the internal energy density through the equation of state:\n$p = (\\gamma - 1) E_{\\text{int}} = (\\gamma - 1) \\rho e$.\n\nOur first step is to express the pressure $p$ in terms of the given conserved quantities. From the definition of momentum density, the velocity is $\\mathbf{v} = \\frac{\\mathbf{m}}{\\rho}$. Substituting this into the expression for kinetic energy density gives:\n$$\nE_{\\text{kin}} = \\frac{1}{2}\\rho \\left|\\frac{\\mathbf{m}}{\\rho}\\right|^2 = \\frac{1}{2}\\rho \\frac{|\\mathbf{m}|^2}{\\rho^2} = \\frac{|\\mathbf{m}|^2}{2\\rho}\n$$\nThe internal energy density can then be found by subtracting the kinetic energy density from the total energy density:\n$$\nE_{\\text{int}} = E - E_{\\text{kin}} = E - \\frac{|\\mathbf{m}|^2}{2\\rho}\n$$\nNow, we can use the ideal gas equation of state to find the pressure:\n$$\np = (\\gamma - 1) E_{\\text{int}} = (\\gamma - 1) \\left(E - \\frac{|\\mathbf{m}|^2}{2\\rho}\\right)\n$$\nThis equation allows us to compute the pressure $p$ from the given conserved variables.\n\nBefore performing the calculation, we address the issue of physical admissibility. A state is considered physically admissible if both the density and pressure are positive: $\\rho > 0$ and $p > 0$. The density is given as $\\rho = 3.0 \\times 10^{-19} \\, \\mathrm{kg\\,m^{-3}}$, which is positive. For the pressure to be positive, since $\\gamma = \\frac{5}{3} > 1$, the term $(\\gamma - 1)$ is positive. Therefore, the condition $p > 0$ requires that the internal energy density be positive, which means $E - \\frac{|\\mathbf{m}|^2}{2\\rho} > 0$. This implies a necessary condition on the total energy density: it must be strictly greater than the kinetic energy density, $E > E_{\\text{kin}}$.\n\nWe now proceed with the numerical calculation. The given values are:\n$\\rho = 3.0 \\times 10^{-19}$\n$\\mathbf{m} = \\left(6.0 \\times 10^{-15},\\,-4.0 \\times 10^{-15},\\,2.0 \\times 10^{-15}\\right)$\n$E = 6.0 \\times 10^{-10}$\n$\\gamma = \\frac{5}{3}$\n\nFirst, we calculate the squared magnitude of the momentum density vector:\n$$\n|\\mathbf{m}|^2 = (6.0 \\times 10^{-15})^2 + (-4.0 \\times 10^{-15})^2 + (2.0 \\times 10^{-15})^2\n$$\n$$\n|\\mathbf{m}|^2 = (36 \\times 10^{-30}) + (16 \\times 10^{-30}) + (4 \\times 10^{-30}) = (36 + 16 + 4) \\times 10^{-30} = 56 \\times 10^{-30} = 5.6 \\times 10^{-29}\n$$\nThe units are $(\\mathrm{kg\\,m^{-2}\\,s^{-1}})^2$.\n\nNext, we calculate the kinetic energy density:\n$$\nE_{\\text{kin}} = \\frac{|\\mathbf{m}|^2}{2\\rho} = \\frac{5.6 \\times 10^{-29}}{2 \\times (3.0 \\times 10^{-19})} = \\frac{5.6}{6.0} \\times 10^{-10} = \\frac{14}{15} \\times 10^{-10} \\approx 0.9333 \\times 10^{-10} \\, \\mathrm{J\\,m^{-3}}\n$$\nWe check the admissibility condition: $E = 6.0 \\times 10^{-10}$ and $E_{\\text{kin}} \\approx 0.9333 \\times 10^{-10}$. Since $E > E_{\\text{kin}}$, the pressure will be positive, and the state is physically admissible.\n\nNow we compute the pressure $p$:\n$$\np = \\left(\\frac{5}{3} - 1\\right) \\left(6.0 \\times 10^{-10} - \\frac{14}{15} \\times 10^{-10}\\right)\n$$\n$$\np = \\frac{2}{3} \\left(6.0 - \\frac{14}{15}\\right) \\times 10^{-10} = \\frac{2}{3} \\left(\\frac{90 - 14}{15}\\right) \\times 10^{-10} = \\frac{2}{3} \\left(\\frac{76}{15}\\right) \\times 10^{-10}\n$$\n$$\np = \\frac{152}{45} \\times 10^{-10} \\approx 3.3777... \\times 10^{-10} \\, \\mathrm{Pa}\n$$\nRounding to four significant figures, we get $p = 3.378 \\times 10^{-10} \\, \\mathrm{Pa}$.\n\nNext, we calculate the adiabatic sound speed $c_s$. For an ideal gas, the square of the sound speed is given by:\n$$\nc_s^2 = \\frac{\\gamma p}{\\rho}\n$$\nAdmissibility requires $c_s^2 \\ge 0$. Since $\\gamma > 0$, $\\rho > 0$, and we have found $p > 0$, this condition is satisfied.\nSubstituting the values for $\\gamma$, $p$, and $\\rho$:\n$$\nc_s^2 = \\frac{\\frac{5}{3} \\times \\left(\\frac{152}{45} \\times 10^{-10}\\right)}{3.0 \\times 10^{-19}} = \\frac{5 \\times 152}{3 \\times 45 \\times 3.0} \\times 10^9 = \\frac{760}{405} \\times 10^9 = \\frac{152}{81} \\times 10^9\n$$\n$c_s^2 \\approx 1.87654... \\times 10^9 \\, (\\mathrm{m/s})^2$.\n\nThe sound speed $c_s$ is the square root of this value:\n$$\nc_s = \\sqrt{\\frac{152}{81} \\times 10^9} \\approx \\sqrt{1.87654... \\times 10^9} \\approx 43319.086... \\, \\mathrm{m\\,s^{-1}}\n$$\nThe problem asks for $c_s$ in units of $\\mathrm{km\\,s^{-1}}$.\n$$\nc_s \\approx 43.319086... \\, \\mathrm{km\\,s^{-1}}\n$$\nRounding to four significant figures, we get $c_s = 43.32 \\, \\mathrm{km\\,s^{-1}}$.\n\nThe final answer is the pair $(p, c_s)$, with $p$ in pascals and $c_s$ in $\\mathrm{km\\,s^{-1}}$, rounded to four significant figures.\n$p \\approx 3.378 \\times 10^{-10} \\, \\mathrm{Pa}$\n$c_s \\approx 43.32 \\, \\mathrm{km\\,s^{-1}}$", "answer": "$$\n\\boxed{\\begin{pmatrix} 3.378 \\times 10^{-10} & 43.32 \\end{pmatrix}}\n$$", "id": "3530060"}, {"introduction": "The algebraic simplicity of the conversion from conserved to primitive variables can be deceptive, often hiding a significant numerical pitfall. In high-Mach-number flows, where kinetic energy vastly exceeds internal energy, a naive subtraction to find the thermal pressure can lead to catastrophic cancellation errors. This practice challenges you to implement a \"dual-energy\" safeguard, a standard technique in modern astrophysical codes, to ensure robust and accurate pressure recovery across all flow regimes [@problem_id:3530055].", "problem": "Consider an ideal, inviscid, non-relativistic hydrodynamic fluid modeled in one spatial dimension with the Euler equations. The standard computational practice in astrophysical simulations uses a set of conserved variables and converts them to primitive variables for reconstructions and flux computations. Let the mass density be denoted by $\\rho$, the velocity by $u$, and the pressure by $p$. The conserved variables are the mass density $D$, the momentum density $S$, and the total energy density $E$. The canonical conversion pathway from conserved to primitive variables for an ideal gas with adiabatic index $\\gamma$ recovers the pressure from total energy by first isolating the internal energy density. The fundamental base to use is the ideal-gas equation of state and the decomposition of the total energy density into internal and kinetic parts. Additionally, the entropy function is defined for adiabatic flows and serves as a potential auxiliary variable in numerical schemes.\n\nYour task is to write a complete and runnable program that, for a given test suite, evaluates the impact of floating-point roundoff on pressure recovery when the kinetic energy dominates the total energy and then implements a dual-energy safeguard that switches to an entropy-based pressure recovery when a certain dimensionless diagnostic indicates that the internal energy is a small fraction of the total. You must proceed from first principles of the decomposition of the total energy density and the ideal-gas law. Explicitly:\n\n- Work in dimensionless code units (that is, all quantities are to be treated as dimensionless).\n- Use double-precision floating-point numbers (IEEE 754 binary64).\n- Base your derivations only on the following fundamental laws and definitions:\n    1. The ideal-gas equation of state: the internal energy density $e$ satisfies $p = (\\gamma - 1) e$.\n    2. The decomposition of total energy density as the sum of internal and kinetic energies: $E = e + E_{\\text{kin}}$, where $E_{\\text{kin}}$ is the kinetic energy density.\n    3. The definitions of conserved variables: $D = \\rho$, $S = \\rho u$, and $E$ as stated above.\n    4. The entropy function $A$ defined for an ideal gas by $A = p \\, \\rho^{-\\gamma}$, which is advected in smooth, adiabatic regions.\n\nYou must not assume nor use any formulas beyond the above foundational definitions in your reasoning to construct your algorithm. The diagnostic to trigger the safeguard must be derived from these definitions to quantify the fraction of the total energy that is internal. Design the safeguard as follows: when the diagnostic falls below a chosen threshold, recover $p$ from the entropy function $A$; otherwise, recover $p$ by subtracting kinetic energy from total energy and applying the ideal-gas relation.\n\nTo assess floating-point roundoff, perturb the total energy $E$ by a multiplicative factor $(1 + \\delta)$ where $\\delta$ is a small prescribed number meant to mimic representation error, and then recover the pressure via both the naive subtraction pathway and the dual-energy safeguard. Quantify the error in the recovered pressure as the absolute relative error, defined as $|p_{\\text{approx}} - p_{\\text{true}}| / p_{\\text{true}}$, where $p_{\\text{true}}$ is the pressure used to construct the conserved state before perturbation.\n\nImplement the following test suite, each case expressed in dimensionless code units with adiabatic index $\\gamma = 5/3$:\n\n- Case $1$ (strong kinetic dominance, small internal fraction):\n    - $\\rho = 1.0$, $u = 1000.0$, $p = 1.0$, $\\gamma = 5/3$, threshold $= 10^{-3}$, perturbation $\\delta = +10^{-15}$.\n- Case $2$ (moderate kinetic energy):\n    - $\\rho = 1.0$, $u = 10.0$, $p = 10.0$, $\\gamma = 5/3$, threshold $= 10^{-3}$, perturbation $\\delta = +10^{-15}$.\n- Case $3$ (boundary triggering value; choose $p$ so that the diagnostic equals the threshold):\n    - $\\rho = 1.0$, $u = 100.0$, $\\gamma = 5/3$, threshold $= 10^{-3}$; choose $p$ such that the internal energy fraction equals $10^{-3}$ using the ideal-gas relation and energy decomposition.\n- Case $4$ (extreme cancellation leading to negative internal energy under perturbation in naive subtraction):\n    - $\\rho = 1.0$, $u = 10^{5}$, choose $p$ such that the internal energy density $e$ is $10^{-3}$, $\\gamma = 5/3$, threshold $= 10^{-3}$, perturbation $\\delta = -10^{-12}$.\n- Case $5$ (low Mach number, internal energy dominance):\n    - $\\rho = 1.0$, $u = 0.01$, $p = 1.0$, $\\gamma = 5/3$, threshold $= 10^{-3}$, perturbation $\\delta = +10^{-15}$.\n\nFor each case:\n- Construct the conserved variables $D$, $S$, and $E$ from the given $\\rho$, $u$, and $p$ using the foundational definitions.\n- Compute the entropy function $A$ from $p$ and $\\rho$.\n- Perturb the total energy to $E_{\\text{pert}} = E (1 + \\delta)$.\n- Recover $p$ naively from $E_{\\text{pert}}$ by subtracting kinetic energy and applying the ideal-gas relation.\n- Derive from first principles a dimensionless diagnostic that quantifies the fraction of the total energy that is internal, and compute it for the perturbed state.\n- Recover $p$ via the dual-energy safeguard: if the diagnostic is below the threshold, use the entropy pathway; otherwise use the naive pathway.\n- Compute the diagnostic value, the naive absolute relative error, the dual-energy absolute relative error, and a boolean indicating whether the entropy pathway was used.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each element corresponds to one case and is itself a list with four entries: the diagnostic value, the naive absolute relative error, the dual-energy absolute relative error, and a boolean indicating whether the entropy pathway was used for that case. The final output should therefore be of the form $[ [d_{1}, r^{\\text{naive}}_{1}, r^{\\text{dual}}_{1}, b_{1}], [d_{2}, r^{\\text{naive}}_{2}, r^{\\text{dual}}_{2}, b_{2}], \\ldots ]$.\n\nAll numerical answers should be floats or booleans. Angle units are not applicable. No physical units are used beyond the declared dimensionless code units. Ensure scientific realism by keeping all values finite and non-negative where physically required. The program must not read external input and must run as-is.", "solution": "**1. Fundamental Quantities and Relationships**\n\nThe state of the fluid is described by primitive variables: mass density $\\rho$, velocity $u$, and pressure $p$. For numerical evolution using finite-volume methods, it is advantageous to use conserved variables: mass density $D$, momentum density $S$, and total energy density $E$. The relationships between these sets of variables are derived from fundamental definitions.\n\n- Mass Density: The conserved mass density is identical to the primitive mass density.\n$$D = \\rho$$\n- Momentum Density: The momentum per unit volume is the product of mass density and velocity.\n$$S = \\rho u$$\n- Total Energy Density: The total energy density $E$ is the sum of the internal energy density $e$ and the kinetic energy density $E_{\\text{kin}}$.\n$$E = e + E_{\\text{kin}}$$\nThe ideal-gas equation of state provides the relationship between internal energy and pressure for an adiabatic index $\\gamma$:\n$$p = (\\gamma - 1)e \\implies e = \\frac{p}{\\gamma-1}$$\nThe kinetic energy density is the kinetic energy per unit volume:\n$$E_{\\text{kin}} = \\frac{1}{2}\\rho u^2$$\nUsing the definitions of $D$ and $S$, we can express $E_{\\text{kin}}$ in terms of conserved variables:\n$$u = \\frac{S}{D} \\implies E_{\\text{kin}} = \\frac{1}{2} D \\left(\\frac{S}{D}\\right)^2 = \\frac{S^2}{2D}$$\nTherefore, the total energy density can be written as:\n$$E = \\frac{p}{\\gamma-1} + \\frac{1}{2}\\rho u^2$$\n\n- Entropy Function: An auxiliary quantity, the entropy function $A$, is defined as:\n$$A = p \\rho^{-\\gamma}$$\nIn smooth, adiabatic flow, $A$ is constant along fluid particle paths and can be advected as if it were a conserved quantity.\n\n**2. Pressure Recovery Algorithms**\n\nThe core task is to recover the primitive variables $(\\rho, u, p)$ from the conserved state $(D, S, E)$. The recovery of $\\rho$ and $u$ is straightforward: $\\rho=D$ and $u=S/D$. The challenge lies in recovering $p$.\n\n**2.1. Naive Pressure Recovery from Total Energy**\n\nThis method directly inverts the definition of total energy.\nFirst, the internal energy density $e$ is computed by subtracting the kinetic energy density from the total energy density:\n$$e_{\\text{naive}} = E - E_{\\text{kin}} = E - \\frac{S^2}{2D}$$\nThen, the pressure is found using the ideal-gas relation:\n$$p_{\\text{naive}} = (\\gamma - 1) e_{\\text{naive}} = (\\gamma - 1) \\left(E - \\frac{S^2}{2D}\\right)$$\nThe weakness of this method emerges when the flow is kinetically dominated, i.e., $E_{\\text{kin}} \\gg e$. In this case, $E \\approx E_{\\text{kin}}$, and the subtraction $E - S^2/(2D)$ is subject to catastrophic cancellation due to floating-point representation errors. A small relative error in $E$ can become a large relative error in $e$, potentially yielding a non-physical negative pressure.\n\n**2.2. Pressure Recovery from Entropy**\n\nThis method utilizes the advected entropy function $A$. By rearranging its definition, pressure can be recovered directly:\n$$p_{\\text{entropy}} = A \\rho^{\\gamma} = A D^{\\gamma}$$\nThis calculation does not involve the subtraction of two large, nearly equal numbers and is therefore numerically robust even when internal energy is a minute fraction of the total energy.\n\n**3. Dual-Energy Safeguard Design**\n\nThe dual-energy safeguard combines the two methods, applying each in the regime where it is most accurate. A diagnostic trigger is required to select the appropriate method.\n\n**3.1. The Diagnostic Trigger**\n\nThe problem requires a dimensionless diagnostic that quantifies the fraction of total energy that is internal. Given a conserved state $(D, S, E)$, the \"recovered\" internal energy is $e_{\\text{rec}} = E - S^2/(2D)$. The ratio of this internal energy to the total energy provides a suitable diagnostic, which we denote by $\\eta$:\n$$\\eta = \\frac{e_{\\text{rec}}}{E} = \\frac{E - S^2/(2D)}{E}$$\nThis diagnostic can be computed directly from the conserved state at each point in the simulation. When $\\eta$ is small, it indicates that the flow is kinetically dominated and the naive subtraction is unreliable.\n\n**3.2. The Safeguard Algorithm**\n\nGiven a conserved state $(D, S, E)$, the advected entropy function $A$, and a pre-defined threshold $\\theta$:\n1. Compute the diagnostic: $\\eta = (E - S^2/(2D)) / E$.\n2. Compare $\\eta$ with the threshold $\\theta$.\n3. If $\\eta < \\theta$:\n   The flow is kinetically dominated. Use the entropy pathway: $p = A D^{\\gamma}$.\n4. Else:\n   The flow is not kinetically dominated. The naive pathway is safe: $p = (\\gamma - 1)(E - S^2/(2D))$.\n\n**4. Test Suite Analysis and Setup**\n\nThe analysis is performed by first constructing a \"true\" conserved state from given primitive variables $(\\rho_{\\text{true}}, u_{\\text{true}}, p_{\\text{true}})$, perturbing the total energy $E_{\\text{true}}$ to get $E_{\\text{pert}} = E_{\\text{true}}(1+\\delta)$, and then attempting to recover $p$ using both the naive and dual-energy methods. The error is quantified by the absolute relative error: $|p_{\\text{approx}} - p_{\\text{true}}| / p_{\\text{true}}$.\n\nFor each case, we first establish the true state $(\\rho_{\\text{true}}, u_{\\text{true}}, p_{\\text{true}})$ and the adiabatic index $\\gamma = 5/3$.\n\n- **Case 3 Setup**: We are given $\\rho_{\\text{true}}=1.0$, $u_{\\text{true}}=100.0$, and the condition that the true internal energy fraction $e_{\\text{true}}/E_{\\text{true}}$ equals the threshold $\\theta = 10^{-3}$.\nThe kinetic energy density is $E_{\\text{kin,true}} = \\frac{1}{2}\\rho_{\\text{true}} u_{\\text{true}}^2 = \\frac{1}{2}(1.0)(100.0)^2 = 5000.0$.\nThe condition is $e_{\\text{true}} / (e_{\\text{true}} + E_{\\text{kin,true}}) = \\theta$.\n$$ \\frac{e_{\\text{true}}}{e_{\\text{true}} + 5000.0} = 10^{-3} \\implies e_{\\text{true}} = 10^{-3}(e_{\\text{true}} + 5000.0) $$\n$$ e_{\\text{true}}(1 - 10^{-3}) = 5.0 \\implies e_{\\text{true}} = \\frac{5.0}{0.999} $$\nThe pressure is then $p_{\\text{true}} = (\\gamma - 1)e_{\\text{true}} = (5/3 - 1) \\frac{5.0}{0.999} = \\frac{2}{3} \\frac{5.0}{0.999} = \\frac{10.0}{2.997}$.\n\n- **Case 4 Setup**: We are given $\\rho_{\\text{true}}=1.0$, $u_{\\text{true}}=10^5$, and $e_{\\text{true}}=10^{-3}$.\nThe pressure is directly computed as $p_{\\text{true}} = (\\gamma - 1)e_{\\text{true}} = (5/3 - 1)(10^{-3}) = \\frac{2}{3} \\times 10^{-3}$.\n\nThe provided Python code will implement this logic for all five test cases, calculating the diagnostic value, the error from the naive method, the error from the dual-energy method, and whether the entropy-based safeguard was triggered for each case.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements and tests a dual-energy safeguard for pressure recovery in\n    computational hydrodynamics based on the Euler equations for an ideal gas.\n    \"\"\"\n    gamma = 5.0 / 3.0\n\n    # Define the test cases. Case 3 and 4 require pre-calculation of pressure.\n    \n    # Case 3: Calculate p_true such that e/E = threshold\n    rho3, u3, threshold3 = 1.0, 100.0, 1e-3\n    e_kin3 = 0.5 * rho3 * u3**2\n    # e / (e + e_kin) = threshold => e = threshold * e_kin / (1 - threshold)\n    e3_true = threshold3 * e_kin3 / (1 - threshold3)\n    p3_true = (gamma - 1) * e3_true\n    \n    # Case 4: Calculate p_true from given e_true\n    e4_true = 1e-3\n    p4_true = (gamma - 1) * e4_true\n\n    test_cases_data = [\n        # Case 1 (strong kinetic dominance)\n        {\"rho\": 1.0, \"u\": 1000.0, \"p\": 1.0, \"threshold\": 1e-3, \"delta\": 1e-15},\n        # Case 2 (moderate kinetic energy)\n        {\"rho\": 1.0, \"u\": 10.0, \"p\": 10.0, \"threshold\": 1e-3, \"delta\": 1e-15},\n        # Case 3 (boundary triggering value)\n        {\"rho\": rho3, \"u\": u3, \"p\": p3_true, \"threshold\": threshold3, \"delta\": 1e-15},\n        # Case 4 (extreme cancellation)\n        {\"rho\": 1.0, \"u\": 1e5, \"p\": p4_true, \"threshold\": 1e-3, \"delta\": -1e-12},\n        # Case 5 (low Mach number)\n        {\"rho\": 1.0, \"u\": 0.01, \"p\": 1.0, \"threshold\": 1e-3, \"delta\": 1e-15},\n    ]\n\n    results = []\n    for case in test_cases_data:\n        rho_true = case[\"rho\"]\n        u_true = case[\"u\"]\n        p_true = case[\"p\"]\n        threshold = case[\"threshold\"]\n        delta = case[\"delta\"]\n\n        # 1. Construct the true conserved state and entropy function\n        e_true = p_true / (gamma - 1.0)\n        e_kin_true = 0.5 * rho_true * u_true**2\n        \n        D = rho_true\n        S = rho_true * u_true\n        E_true = e_true + e_kin_true\n        \n        # The entropy function A = p * rho^(-gamma)\n        A = p_true * rho_true**(-gamma)\n\n        # 2. Perturb the total energy\n        E_pert = E_true * (1.0 + delta)\n\n        # Pre-compute kinetic energy term from conserved state (remains unchanged)\n        S_sq_over_2D = S**2 / (2.0 * D)\n\n        # 3. Naive pressure recovery\n        # e_naive = E_pert - S^2/(2D)\n        # p_naive = (gamma - 1) * e_naive\n        p_naive = (gamma - 1.0) * (E_pert - S_sq_over_2D)\n        \n        # Calculate naive absolute relative error\n        # Ensure p_true is not zero to avoid division by zero\n        r_naive = abs(p_naive - p_true) / p_true if p_true != 0.0 else (0.0 if p_naive == 0.0 else np.inf)\n\n        # 4. Dual-energy safeguard\n        # Calculate diagnostic: fraction of internal energy from the perturbed state\n        # diagnostic = (E_pert - S^2/(2D)) / E_pert\n        diagnostic = (E_pert - S_sq_over_2D) / E_pert\n        \n        entropy_path_used = False\n        p_dual = 0.0\n\n        if diagnostic < threshold:\n            # Use entropy pathway\n            # p_dual = A * D^gamma\n            p_dual = A * D**gamma\n            entropy_path_used = True\n        else:\n            # Use naive pathway (subtraction is safe)\n            p_dual = p_naive\n            entropy_path_used = False\n\n        # Calculate dual-energy absolute relative error\n        r_dual = abs(p_dual - p_true) / p_true if p_true != 0.0 else (0.0 if p_dual == 0.0 else np.inf)\n\n        # 5. Store results\n        results.append([diagnostic, r_naive, r_dual, entropy_path_used])\n\n    # Final print statement in the exact required format.\n    # The default str() for a list includes spaces, which matches the problem description's style.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3530055"}, {"introduction": "The principles of variable conversion extend to more complex physical systems, though the mathematical machinery becomes more sophisticated. This advanced practice guides you through the complete derivation and implementation of an inversion scheme for ideal Special Relativistic Magnetohydrodynamics (SRMHD). You will construct a single, non-linear scalar equation from first principles and use a numerical root-finder to recover the primitive state, a method that lies at the heart of many cutting-edge relativistic astrophysics codes [@problem_id:3530073].", "problem": "You are tasked with designing and implementing a complete algorithm, together with a runnable program, that inverts conserved variables to primitive variables in ideal relativistic magnetohydrodynamics within the field of computational astrophysics. The derivation and algorithm must begin only from foundational definitions and laws and must not rely on pre-given shortcut formulas. The goal is to obtain a scalar root equation for a reduced variable, for example $\\hat{W} = \\rho h W^2$, that can be solved to recover the fluid pressure $p$, the Lorentz factor $W$, and the three-velocity $v^i$, and to specify computational steps that compute the magnetic four-vector $b^\\mu$ consistently. Use geometrized units where the speed of light is set to $c = 1$.\n\nBegin from the following foundations:\n- The fluid four-velocity $u^\\mu$ satisfies $u^\\mu u_\\mu = -1$.\n- The electromagnetic field in the fluid frame is represented by the magnetic four-vector $b^\\mu$, with the ideal magnetohydrodynamics condition that the electric field in the fluid frame vanishes.\n- The stress-energy tensor of ideal relativistic magnetohydrodynamics (Special Relativistic Magnetohydrodynamics (SRMHD)) is\n$$\nT^{\\mu\\nu} = (\\rho h + b^2) u^\\mu u^\\nu + \\left(p + \\frac{b^2}{2}\\right) g^{\\mu\\nu} - b^\\mu b^\\nu,\n$$\nwhere $\\rho$ is the rest-mass density, $p$ is the fluid pressure, $h$ is the specific enthalpy, $b^2 \\equiv b^\\mu b_\\mu$, and $g^{\\mu\\nu}$ is the spacetime metric. For the program and test suite, use the Minkowski metric with signature $(-,+,+,+)$, lapse $\\alpha = 1$, shift $\\beta^i = 0$, and spatial metric $\\gamma_{ij} = \\delta_{ij}$. In this case, spatial indices can be raised and lowered by $\\delta_{ij}$, and spatial dot-products are Euclidean.\n- The Valencia-form conserved variables are constructed from $T^{\\mu\\nu}$ and $u^\\mu$ by projection onto the Eulerian observer. Define:\n    - The mass density $D \\equiv \\rho W$, where $W \\equiv u^0$ is the Lorentz factor and $v^i \\equiv u^i / W$ is the three-velocity.\n    - The momentum density $S_i \\equiv T^{0}{}_i$.\n    - The energy variable $\\tau \\equiv T^{00} - D$.\n    - The magnetic field three-vector $B^i$ measured in the Eulerian frame.\n- Use the ideal-gas equation of state with adiabatic index $\\Gamma$, namely $p = (\\Gamma - 1) \\rho \\epsilon$, where $\\epsilon$ is the specific internal energy, and $h = 1 + \\epsilon + p/\\rho$.\n\nYour tasks are:\n1. Derive, from the above foundations and definitions, a single scalar root equation for the reduced variable $\\hat{W} \\equiv \\rho h W^2$ in terms of the conserved variables $U \\equiv (D, S_i, \\tau, B^i)$ and the metric. The equation must be solvable for $\\hat{W}$ and must yield $p$, $W$, and $v^i$ when solved.\n2. Specify the computational steps to compute the magnetic four-vector $b^\\mu$ consistently from the recovered primitive variables, using the metric indicated.\n3. Implement a program that:\n    - For each provided test case of primitive variables $(\\rho, p, v^i, B^i, \\Gamma)$, computes the corresponding conserved variables $(D, S_i, \\tau, B^i)$ using the Minkowski metric described.\n    - Inverts $(D, S_i, \\tau, B^i)$ back to the primitive variables by solving your derived scalar root equation for $\\hat{W}$ and then computing $p$, $W$, and $v^i$. Compute $b^\\mu$ consistently from the recovered primitives.\n    - Compares the recovered $(p, W, v^i)$ and $b^\\mu$ to the original primitive inputs and returns a boolean indicating whether all recovered quantities match the originals within a strict tolerance of $10^{-9}$ in absolute difference for each scalar component and Euclidean norm difference for spatial vectors. No angles appear in the problem; all quantities are dimensionless under the unit choice $c = 1$.\n4. The final program output must be a single line containing a comma-separated list enclosed in square brackets of boolean values, one per test case, where each boolean indicates whether all checks passed for that test case, for example, `[True, False, ...]`.\n\nTest suite:\n- Test case $1$ (general, non-degenerate configuration):\n    - $\\rho = 1.0$, $p = 0.1$, $\\Gamma = \\frac{4}{3}$, $v^i = (0.2, -0.1, 0.05)$, $B^i = (0.3, 0.4, -0.2)$.\n- Test case $2$ (magnetic field aligned with velocity, moderate magnetization):\n    - $\\rho = 0.8$, $p = 0.05$, $\\Gamma = \\frac{5}{3}$, $v^i = (0.4, 0.0, 0.0)$, $B^i = (0.8, 0.0, 0.0)$.\n- Test case $3$ (near-relativistic speed, weak magnetization):\n    - $\\rho = 1.0$, $p = 0.01$, $\\Gamma = \\frac{5}{3}$, $v^i = (0.5, 0.7, 0.2)$ scaled to have $|v| = 0.95$ (Euclidean norm), $B^i = (0.001, -0.002, 0.001)$.\n- Test case $4$ (strong magnetization, small pressure, low speed):\n    - $\\rho = 2.0$, $p = 0.001$, $\\Gamma = \\frac{4}{3}$, $v^i = (0.05, -0.03, 0.02)$, $B^i = (5.0, -3.0, 2.0)$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (for example, `[True, True, True, True]`).", "solution": "### 1. Fundamental Quantities in the Eulerian Frame\n\nThe fluid four-velocity $u^\\mu$ is normalized such that $u^\\mu u_\\mu = -1$. In the Eulerian (lab) frame, it is expressed in terms of the three-velocity $v^i \\equiv u^i/u^0$ as $u^\\mu = (W, Wv^i)$, where $W \\equiv u^0$ is the Lorentz factor. The normalization condition gives $g_{\\mu\\nu}u^\\mu u^\\nu = -W^2 + W^2 v_i v^i = -1$, which implies $W = (1-v^2)^{-1/2}$, with $v^2 \\equiv v_i v^i$.\n\nThe magnetic field is described by the magnetic four-vector $b^\\mu$. In ideal MHD, the electric field in the fluid's rest frame vanishes. This leads to the following expressions for the components of $b^\\mu$ in the lab frame in terms of the lab-frame magnetic field $B^i$ and the fluid three-velocity $v^i$:\n$$\nb^0 = u_i B^i = W (v_k B^k)\n$$\n$$\nb^i = \\frac{B^i}{W} + u^i b^0 = \\frac{B^i}{W} + W v^i (v_k B^k)\n$$\nThe magnetic four-vector is orthogonal to the fluid four-velocity, $b^\\mu u_\\mu = 0$. The squared magnitude of the magnetic four-vector is a Lorentz invariant, given by:\n$$\nb^2 \\equiv b^\\mu b_\\mu = -(b^0)^2 + b_i b^i = \\frac{B_k B^k}{W^2} + (v_k B^k)^2\n$$\nLet's define the scalar products $B^2 \\equiv B_k B^k$ and $(\\mathbf{v} \\cdot \\mathbf{B}) \\equiv v_k B^k$. Then $b^2 = B^2/W^2 + (\\mathbf{v} \\cdot \\mathbf{B})^2$.\n\n### 2. Conserved Variables in Terms of Primitives\n\nThe conserved variables are defined from the stress-energy tensor $T^{\\mu\\nu}$.\n$$\nT^{\\mu\\nu} = (\\rho h + b^2) u^\\mu u^\\nu + \\left(p + \\frac{b^2}{2}\\right) g^{\\mu\\nu} - b^\\mu b^\\nu\n$$\nHere, $\\rho$ is the rest-mass density, $p$ is the gas pressure, and $h$ is the specific enthalpy related by the ideal gas equation of state $p=(\\Gamma-1)\\rho\\epsilon$ and $h = 1+\\epsilon+p/\\rho$. This implies $\\rho h = \\rho + \\frac{\\Gamma p}{\\Gamma-1}$.\n\nThe conserved variables are:\n- Mass density: $D \\equiv \\rho W$.\n- Momentum density: $S_i \\equiv T^{0}{}_i = T^{0i}$.\n- Energy density: $\\tau \\equiv T^{00} - D$.\n- Magnetic field: $B^i$, which is advected.\n\nLet us express $S_i$ and $\\tau$ in terms of primitive variables.\nFor the momentum density $S_i$:\n$$\nS_i = T^{0i} = (\\rho h + b^2) u^0 u^i + \\left(p + \\frac{b^2}{2}\\right) g^{0i} - b^0 b^i\n$$\nWith $u^0=W$, $u^i = Wv^i$, and $g^{0i}=0$:\n$$\nS_i = (\\rho h + b^2) W^2 v_i - b^0 b_i\n$$\nLet's define the auxiliary variable $\\hat{W} \\equiv \\rho h W^2$.\n$$\nS_i = (\\hat{W} + b^2 W^2) v_i - b^0 b_i\n$$\nSubstituting the expressions for $b^2$, $b^0$, and $b_i$:\n$$\n S_i = (\\hat{W} + B^2 + W^2(\\mathbf{v}\\cdot\\mathbf{B})^2)v_i - W(\\mathbf{v}\\cdot\\mathbf{B}) \\left(\\frac{B_i}{W} + Wv_i(\\mathbf{v}\\cdot\\mathbf{B}) \\right)\n$$\n$$\n S_i = (\\hat{W} + B^2)v_i + W^2(\\mathbf{v}\\cdot\\mathbf{B})^2 v_i - (\\mathbf{v}\\cdot\\mathbf{B})B_i - W^2(\\mathbf{v}\\cdot\\mathbf{B})^2 v_i\n$$\nThis simplifies to a key equation relating $S_i$ to the primitive variables:\n$$\nS_i = (\\hat{W} + B^2)v_i - (\\mathbf{v}\\cdot\\mathbf{B})B_i\n$$\n\nFor the energy density $\\tau$:\n$$\nT^{00} = (\\rho h + b^2)(u^0)^2 + \\left(p + \\frac{b^2}{2}\\right)g^{00} - (b^0)^2 = \\hat{W} + b^2 W^2 - p - \\frac{b^2}{2} - (b^0)^2\n$$\nUsing $b^2 W^2 - (b^0)^2 = B^2$ and $b^2 = B^2/W^2 + (\\mathbf{v}\\cdot\\mathbf{B})^2$:\n$$\nT^{00} = \\hat{W} - p + B^2 - \\frac{b^2}{2} = \\hat{W} - p + B^2 - \\frac{1}{2}\\left(\\frac{B^2}{W^2} + (\\mathbf{v}\\cdot\\mathbf{B})^2\\right)\n$$\nUsing $W^{-2} = 1-v^2$, this becomes:\n$$\nT^{00} = \\hat{W} - p + B^2 - \\frac{B^2(1-v^2)}{2} - \\frac{(\\mathbf{v}\\cdot\\mathbf{B})^2}{2} = \\hat{W} - p + \\frac{B^2(1+v^2)}{2} - \\frac{(\\mathbf{v}\\cdot\\mathbf{B})^2}{2}\n$$\nThe conserved energy variable is $\\tau = T^{00} - D$.\n\n### 3. Derivation of the Scalar Root Equation for $\\hat{W}$\n\nThe inversion process requires solving for the primitive variables $(\\rho, p, v^i)$ from the conserved variables $(D, S_i, \\tau, B^i)$. We will derive a single scalar equation for the auxiliary variable $\\hat{W} = \\rho h W^2$.\n\nFrom the momentum equation $\\mathbf{S} = (\\hat{W} + B^2)\\mathbf{v} - (\\mathbf{v}\\cdot\\mathbf{B})\\mathbf{B}$, we can express $\\mathbf{v}$ in terms of $\\hat{W}$ and known conserved quantities. Let $S^2 = S_k S^k$ and $S_B = S_k B^k$.\nTaking the dot product of the momentum equation with $\\mathbf{B}$:\n$$\nS_B = (\\hat{W} + B^2)(\\mathbf{v}\\cdot\\mathbf{B}) - (\\mathbf{v}\\cdot\\mathbf{B})B^2 = \\hat{W}(\\mathbf{v}\\cdot\\mathbf{B})\n$$\nThis yields a remarkably simple expression for the velocity-magnetic field projection:\n$$\n(\\mathbf{v}\\cdot\\mathbf{B}) = \\frac{S_B}{\\hat{W}}\n$$\nSubstituting this back into the momentum equation:\n$$\n\\mathbf{S} = (\\hat{W} + B^2)\\mathbf{v} - \\frac{S_B}{\\hat{W}}\\mathbf{B}\n$$\nSolving for $\\mathbf{v}$:\n$$\n\\mathbf{v} = \\frac{\\mathbf{S} + (S_B/\\hat{W})\\mathbf{B}}{\\hat{W}+B^2} = \\frac{\\hat{W}\\mathbf{S} + S_B\\mathbf{B}}{\\hat{W}(\\hat{W}+B^2)}\n$$\nNow we can express $v^2 = \\mathbf{v}\\cdot\\mathbf{v}$ in terms of $\\hat{W}$:\n$$\nv^2 = \\frac{(\\hat{W}\\mathbf{S} + S_B\\mathbf{B})\\cdot(\\hat{W}\\mathbf{S} + S_B\\mathbf{B})}{\\hat{W}^2(\\hat{W}+B^2)^2} = \\frac{\\hat{W}^2 S^2 + 2\\hat{W}S_B^2 + S_B^2 B^2}{\\hat{W}^2(\\hat{W}+B^2)^2}\n$$\nThis makes $v^2$, and consequently $W=(1-v^2)^{-1/2}$, functions of $\\hat{W}$ and known quantities.\n\nNext, we express the pressure $p$ in terms of $\\hat{W}$. From the definition of specific enthalpy for an ideal gas, $\\rho h = \\rho + \\Gamma p / (\\Gamma - 1)$.\nThen, $\\hat{W} = \\rho h W^2 = \\left(\\rho + \\frac{\\Gamma p}{\\Gamma-1}\\right)W^2$.\nUsing $D=\\rho W$, we have $\\rho = D/W$:\n$$\n\\hat{W} = \\left(\\frac{D}{W} + \\frac{\\Gamma p}{\\Gamma-1}\\right)W^2 = DW + \\frac{\\Gamma p W^2}{\\Gamma-1}\n$$\nSolving for $p$:\n$$\np = \\frac{\\Gamma-1}{\\Gamma W^2}(\\hat{W} - DW) = \\frac{\\Gamma-1}{\\Gamma}(1-v^2)(\\hat{W} - D(1-v^2)^{-1/2})\n$$\nNow we have all components to be substituted into the energy equation, $\\tau = T^{00} - D$:\n$$\n\\tau + D = \\hat{W} - p + \\frac{B^2(1+v^2)}{2} - \\frac{(S_B/\\hat{W})^2}{2}\n$$\nSubstituting the expression for $p$:\n$$\n\\tau + D = \\hat{W} - \\frac{\\Gamma-1}{\\Gamma}(1-v^2)\\left(\\hat{W} - \\frac{D}{\\sqrt{1-v^2}}\\right) + \\frac{B^2(1+v^2)}{2} - \\frac{S_B^2}{2\\hat{W}^2}\n$$\nThis equation, let's call it $f(\\hat{W}) = 0$, is the final scalar equation for $\\hat{W}$. All quantities in it are either known conserved variables or functions of $\\hat{W}$.\n$$\nf(\\hat{W}) = \\hat{W} - (\\tau+D) - \\frac{\\Gamma-1}{\\Gamma}(1-v^2(\\hat{W}))\\left(\\hat{W} - \\frac{D}{\\sqrt{1-v^2(\\hat{W})}}\\right) + \\frac{B^2(1+v^2(\\hat{W}))}{2} - \\frac{S_B^2}{2\\hat{W}^2} = 0\n$$\nwhere $v^2(\\hat{W})$ is the previously derived expression. This non-linear equation can be solved for $\\hat{W}$ using a numerical root-finding algorithm. Note that for a physically valid solution, we must have $\\hat{W} > D$, $p > 0$, and $v^2 < 1$.\n\n### 4. Recovery Algorithm\n\nOnce the root $\\hat{W}$ is found, the primitive variables are recovered as follows:\n1.  Calculate $v^2 = \\frac{\\hat{W}^2 S^2 + S_B^2(2\\hat{W}+B^2)}{\\hat{W}^2(\\hat{W}+B^2)^2}$.\n2.  Calculate the Lorentz factor $W = (1-v^2)^{-1/2}$.\n3.  Calculate the three-velocity vector $v^i = \\frac{\\hat{W}S^i + S_B B^i}{\\hat{W}(\\hat{W}+B^2)}$.\n4.  Calculate the rest-mass density $\\rho = D/W$.\n5.  Calculate the gas pressure $p = \\frac{\\Gamma-1}{\\Gamma W^2}(\\hat{W} - DW)$.\n\n### 5. Computation of the Magnetic Four-Vector $b^\\mu$\n\nThe magnetic four-vector $b^\\mu$ can be computed from the recovered primitive variables $(v^i, W)$ and the conserved magnetic field $B^i$. The computational steps are:\n1.  Compute the scalar product $\\mathbf{v}\\cdot\\mathbf{B} = v_k B^k$.\n2.  Compute the time component $b^0 = W(\\mathbf{v}\\cdot\\mathbf{B})$.\n3.  Compute the spatial components $b^i = \\frac{B^i}{W} + W v^i (\\mathbf{v}\\cdot\\mathbf{B})$.\nThe resulting four-vector is $b^\\mu = (b^0, b^i)$. It is consistent with the recovered primitives and satisfies $b^\\mu u_\\mu=0$.", "answer": "```python\nimport numpy as np\nfrom scipy.optimize import brentq\n\ndef solve():\n    \"\"\"\n    Solves the SRMHD inversion problem for a given set of test cases.\n    \"\"\"\n    # Test case 3 requires scaling the velocity vector\n    v3_raw = np.array([0.5, 0.7, 0.2])\n    v3_norm = np.linalg.norm(v3_raw)\n    v3_scaled = v3_raw * (0.95 / v3_norm)\n\n    test_cases = [\n        # (rho, p, v, B, Gamma)\n        (1.0, 0.1, np.array([0.2, -0.1, 0.05]), np.array([0.3, 0.4, -0.2]), 4.0/3.0),\n        (0.8, 0.05, np.array([0.4, 0.0, 0.0]), np.array([0.8, 0.0, 0.0]), 5.0/3.0),\n        (1.0, 0.01, v3_scaled, np.array([0.001, -0.002, 0.001]), 5.0/3.0),\n        (2.0, 0.001, np.array([0.05, -0.03, 0.02]), np.array([5.0, -3.0, 2.0]), 4.0/3.0),\n    ]\n\n    results = []\n    TOLERANCE = 1e-9\n\n    for case in test_cases:\n        rho, p, v, B, Gamma = case\n\n        # --- 1. Forward conversion (Primitives to Conserved) ---\n        v_sq = np.dot(v, v)\n        W = 1.0 / np.sqrt(1.0 - v_sq)\n        \n        # Calculate specific enthalpy h\n        epsilon = p / ((Gamma - 1.0) * rho)\n        h = 1.0 + epsilon + p / rho\n        \n        # Conserved variables\n        D = rho * W\n        \n        # Auxiliary variable W_hat\n        W_hat_orig = rho * h * W**2\n        \n        # Magnetic field related scalars\n        B_sq = np.dot(B, B)\n        v_dot_B = np.dot(v, B)\n        \n        # Momentum S_i\n        S = (W_hat_orig + B_sq) * v - v_dot_B * B\n        \n        # Energy tau\n        T00 = W_hat_orig - p + B_sq - (B_sq / (2.0 * W**2) + v_dot_B**2 / 2.0)\n        tau = T00 - D\n\n        # --- 2. Inversion (Conserved to Primitives) ---\n        \n        # Pre-compute scalars from conserved variables\n        S_sq = np.dot(S, S)\n        S_dot_B = np.dot(S, B)\n        # B_sq is the same as before, B is a conserved variable\n\n        def root_function(W_hat_guess):\n            # Equation for v^2 in terms of W_hat\n            numerator_v_sq = W_hat_guess**2 * S_sq + S_dot_B**2 * (2 * W_hat_guess + B_sq)\n            denominator_v_sq = (W_hat_guess * (W_hat_guess + B_sq))**2\n            \n            # Avoid division by zero, though W_hat > D > 0\n            if abs(denominator_v_sq) < 1e-40:\n                return np.inf\n\n            v_sq_rec = numerator_v_sq / denominator_v_sq\n            \n            # Physical constraints\n            if v_sq_rec >= 1.0 or W_hat_guess <= D:\n                return np.inf # Return a large value to repel the solver\n            \n            W_rec = 1.0 / np.sqrt(1.0 - v_sq_rec)\n            \n            # Pressure from W_hat\n            p_rec_term = (W_hat_guess / W_rec**2) - (D / W_rec)\n            p_rec = (Gamma - 1.0) / Gamma * p_rec_term\n            \n            # If p becomes negative, unphysical solution\n            if p_rec < 0:\n                return np.inf\n\n            # Reconstruct tau from the guess\n            tau_rec = W_hat_guess - p_rec - D + 0.5 * B_sq * (1.0 + v_sq_rec) - 0.5 * S_dot_B**2 / W_hat_guess**2\n            \n            return tau - tau_rec\n\n        # Find a bracketing interval for the root finder\n        # Lower bound: W_hat > D\n        # Upper bound: A generous estimate based on total energy\n        lower_bound = D * (1.0 + 1e-10)\n        upper_bound_factor = 10.0\n        upper_bound = max(tau + D, lower_bound) * upper_bound_factor + B_sq\n        \n        try:\n            W_hat_rec = brentq(root_function, lower_bound, upper_bound, xtol=1e-15, rtol=1e-15)\n        except ValueError:\n            # If brentq fails to find a root in the interval, the case fails\n            results.append(False)\n            continue\n\n        # --- Recovery of primitive variables from W_hat_rec ---\n        v_sq_rec_final = (W_hat_rec**2 * S_sq + S_dot_B**2 * (2 * W_hat_rec + B_sq)) / (W_hat_rec * (W_hat_rec + B_sq))**2\n        W_rec = 1.0 / np.sqrt(1.0 - v_sq_rec_final)\n        v_rec = (W_hat_rec * S + S_dot_B * B) / (W_hat_rec * (W_hat_rec + B_sq))\n        rho_rec = D / W_rec\n        \n        p_rec_term = W_hat_rec / W_rec**2 - D / W_rec\n        p_rec = (Gamma - 1.0) / Gamma * p_rec_term\n\n        # --- 3. Comparison ---\n        \n        # Original b^mu\n        b0_orig = W * v_dot_B\n        b_vec_orig = B / W + W * v * v_dot_B\n\n        # Recovered b^mu\n        v_dot_B_rec = np.dot(v_rec, B)\n        b0_rec = W_rec * v_dot_B_rec\n        b_vec_rec = B / W_rec + W_rec * v_rec * v_dot_B_rec\n\n        # Boolean checks with tolerance\n        check_rho = np.abs(rho - rho_rec) < TOLERANCE\n        check_p = np.abs(p - p_rec) < TOLERANCE\n        check_W = np.abs(W - W_rec) < TOLERANCE\n        check_v = np.linalg.norm(v - v_rec) < TOLERANCE\n        check_b0 = np.abs(b0_orig - b0_rec) < TOLERANCE\n        check_b_vec = np.linalg.norm(b_vec_orig - b_vec_rec) < TOLERANCE\n\n        all_checks_passed = all([check_rho, check_p, check_W, check_v, check_b0, check_b_vec])\n        results.append(all_checks_passed)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == '__main__':\n    solve()\n```", "id": "3530073"}]}