{"hands_on_practices": [{"introduction": "The behavior of any fluid system, including a magnetized plasma, is governed by how information propagates. This practice guides you through the linearization of the ideal MHD equations to uncover the system's fundamental wave modes. Understanding and calculating the speeds of these waves is a critical skill for computational astrophysics, as they determine the stability constraints of numerical simulations and form the foundation of modern Godunov-type schemes [@problem_id:3539067].", "problem": "Consider the equations of ideal Magnetohydrodynamics (MHD) in Heaviside–Lorentz units (magnetic permeability set to unity), consisting of the mass continuity equation, the momentum equation with magnetic (Lorentz) force, the induction equation with the ideal Ohm’s law, and the solenoidal constraint. A uniform, homogeneous equilibrium state is given by constant background fields $\\rho_{0}$, $p_{0}$, $\\mathbf{v}_{0}$, and $\\mathbf{B}_{0}$, and an adiabatic equation of state with ratio of specific heats $\\gamma$. The divergence-free constraint $\\nabla \\cdot \\mathbf{B} = 0$ is satisfied initially.\n\nLinearize the ideal MHD equations about this uniform equilibrium and assume plane-wave perturbations proportional to $\\exp\\left[i\\left(k\\,\\hat{\\mathbf{n}}\\cdot\\mathbf{x} - \\omega t\\right)\\right]$ propagating along a given unit direction $\\hat{\\mathbf{n}}$. Using only the fundamental equations and the solenoidal constraint, derive the dispersion relations for the linear waves and thereby obtain the characteristic phase speeds in the lab frame along $\\hat{\\mathbf{n}}$: the advected entropy mode speed $v_{n}$, the Alfvén speeds $v_{n} \\pm c_{A,n}$, and the fast and slow magnetosonic speeds $v_{n} \\pm c_{f}$ and $v_{n} \\pm c_{s}$ (with $c_{f} \\ge c_{s} \\ge 0$). Here $v_{n} \\equiv \\mathbf{v}_{0}\\cdot\\hat{\\mathbf{n}}$, $c_{A,n} \\equiv |\\mathbf{B}_{0}\\cdot\\hat{\\mathbf{n}}|/\\sqrt{\\rho_{0}}$, and $a \\equiv \\sqrt{\\gamma p_{0}/\\rho_{0}}$ is the adiabatic sound speed. You must explicitly demonstrate how the divergence-free constraint is preserved by the linearized evolution and how it constrains the perturbations.\n\nThen, for the specific uniform state\n- $\\rho_{0} = 1$,\n- $p_{0} = 1$,\n- $\\gamma = \\dfrac{5}{3}$,\n- $\\mathbf{v}_{0} = (0.3,\\,-0.2,\\,0.4)$,\n- $\\mathbf{B}_{0} = (1,\\,2,\\,2)$,\n- $\\hat{\\mathbf{n}} = (0,\\,0,\\,1)$,\n\ncompute the seven characteristic speeds in the canonical ordering\n$$v_{n} - c_{f},\\quad v_{n} - c_{A,n},\\quad v_{n} - c_{s},\\quad v_{n},\\quad v_{n} + c_{s},\\quad v_{n} + c_{A,n},\\quad v_{n} + c_{f}.$$\n\nExpress all speeds as pure numbers in nondimensional code units and round each entry to $6$ significant figures. Provide your final numerical results in the specified order as a single row vector. No units are to be included in the final boxed answer.", "solution": "The problem requires the derivation of the dispersion relations for linear waves in ideal Magnetohydrodynamics (MHD) and the subsequent calculation of the characteristic wave speeds for a specific physical state. The process begins with validating the problem statement, which is found to be scientifically sound, well-posed, and complete.\n\nThe equations of ideal MHD in Heaviside-Lorentz units are:\n1.  Mass continuity: $\\dfrac{\\partial \\rho}{\\partial t} + \\nabla \\cdot (\\rho \\mathbf{v}) = 0$\n2.  Momentum: $\\rho \\left( \\dfrac{\\partial \\mathbf{v}}{\\partial t} + (\\mathbf{v} \\cdot \\nabla) \\mathbf{v} \\right) = -\\nabla p + (\\nabla \\times \\mathbf{B}) \\times \\mathbf{B}$\n3.  Induction: $\\dfrac{\\partial \\mathbf{B}}{\\partial t} = \\nabla \\times (\\mathbf{v} \\times \\mathbf{B})$\n4.  Solenoidal constraint: $\\nabla \\cdot \\mathbf{B} = 0$\n5.  Adiabatic equation of state: $\\dfrac{d}{dt}\\left(\\dfrac{p}{\\rho^\\gamma}\\right) = 0$, where $\\dfrac{d}{dt} = \\dfrac{\\partial}{\\partial t} + \\mathbf{v} \\cdot \\nabla$\n\nWe linearize these equations around a uniform equilibrium state defined by constants $\\rho_0$, $p_0$, $\\mathbf{v}_0$, and $\\mathbf{B}_0$. We introduce small perturbations:\n$\\rho = \\rho_0 + \\delta\\rho$, $p = p_0 + \\delta p$, $\\mathbf{v} = \\mathbf{v}_0 + \\delta\\mathbf{v}$, $\\mathbf{B} = \\mathbf{B}_0 + \\delta\\mathbf{B}$.\nSubstituting these into the MHD equations and retaining only first-order terms in the perturbations, we obtain the linearized equations:\n1.  $\\dfrac{\\partial \\delta\\rho}{\\partial t} + \\mathbf{v}_0 \\cdot \\nabla \\delta\\rho + \\rho_0 \\nabla \\cdot \\delta\\mathbf{v} = 0$\n2.  $\\rho_0 \\left( \\dfrac{\\partial \\delta\\mathbf{v}}{\\partial t} + (\\mathbf{v}_0 \\cdot \\nabla) \\delta\\mathbf{v} \\right) = -\\nabla \\delta p + (\\nabla \\times \\delta\\mathbf{B}) \\times \\mathbf{B}_0$\n3.  $\\dfrac{\\partial \\delta\\mathbf{B}}{\\partial t} = \\nabla \\times (\\mathbf{v}_0 \\times \\delta\\mathbf{B} + \\delta\\mathbf{v} \\times \\mathbf{B}_0)$\n4.  $\\nabla \\cdot \\delta\\mathbf{B} = 0$ (since $\\nabla \\cdot \\mathbf{B}_0 = 0$)\n5.  $\\left(\\dfrac{\\partial}{\\partial t} + \\mathbf{v}_0 \\cdot \\nabla\\right) (\\delta p - a^2 \\delta\\rho) = 0$, where $a^2 = \\gamma p_0 / \\rho_0$ is the squared adiabatic sound speed.\n\nWe assume plane-wave solutions for the perturbations of the form $\\delta f \\propto \\exp[i(\\mathbf{k} \\cdot \\mathbf{x} - \\omega t)]$, where $\\mathbf{k} = k\\hat{\\mathbf{n}}$. This transforms the differential operators as $\\dfrac{\\partial}{\\partial t} \\to -i\\omega$ and $\\nabla \\to i\\mathbf{k}$.\nThe linearized equations become a system of algebraic equations:\n1.  $-i\\omega \\delta\\rho + i(\\mathbf{k} \\cdot \\mathbf{v}_0) \\delta\\rho + i\\rho_0 (\\mathbf{k} \\cdot \\delta\\mathbf{v}) = 0$\n2.  $-i\\omega\\rho_0\\delta\\mathbf{v} + i\\rho_0(\\mathbf{k} \\cdot \\mathbf{v}_0)\\delta\\mathbf{v} = -i\\mathbf{k}\\delta p + (i\\mathbf{k} \\times \\delta\\mathbf{B}) \\times \\mathbf{B}_0$\n3.  $-i\\omega\\delta\\mathbf{B} = i\\mathbf{k} \\times (\\mathbf{v}_0 \\times \\delta\\mathbf{B} + \\delta\\mathbf{v} \\times \\mathbf{B}_0)$\n4.  $i\\mathbf{k} \\cdot \\delta\\mathbf{B} = 0$\n5.  $(-i\\omega + i\\mathbf{k}\\cdot\\mathbf{v}_0)(\\delta p - a^2 \\delta\\rho) = 0$\n\nLet's define the Doppler-shifted frequency in the plasma frame, $\\omega' = \\omega - \\mathbf{k} \\cdot \\mathbf{v}_0$. The equations simplify to:\n1.  $-\\omega' \\delta\\rho + \\rho_0 (\\mathbf{k} \\cdot \\delta\\mathbf{v}) = 0$\n2.  $-\\omega'\\rho_0\\delta\\mathbf{v} = -\\mathbf{k}\\delta p + (\\mathbf{k} \\times \\delta\\mathbf{B}) \\times \\mathbf{B}_0$\n3.  $-\\omega'\\delta\\mathbf{B} = \\mathbf{k} \\times (\\delta\\mathbf{v} \\times \\mathbf{B}_0)$\n4.  $\\mathbf{k} \\cdot \\delta\\mathbf{B} = 0$\n5.  $\\omega'(\\delta p - a^2 \\delta\\rho) = 0$\n\nThe solenoidal constraint $\\nabla \\cdot \\mathbf{B} = 0$ is preserved by the dynamics. Taking the divergence of the induction equation gives $\\dfrac{\\partial (\\nabla \\cdot \\mathbf{B})}{\\partial t} = \\nabla \\cdot (\\nabla \\times \\mathbf{Q}) = 0$, where $\\mathbf{Q} = \\mathbf{v} \\times \\mathbf{B}$. Thus, if $\\nabla \\cdot \\mathbf{B} = 0$ at $t=0$, it remains so for all time. In Fourier space, this implies $\\mathbf{k} \\cdot \\delta\\mathbf{B} = 0$, meaning the magnetic field perturbation is purely transverse to the direction of wave propagation. This constraint is automatically satisfied by the linearized induction equation: dotting equation (3) with $\\mathbf{k}$ gives $-\\omega'(\\mathbf{k} \\cdot \\delta\\mathbf{B}) = \\mathbf{k} \\cdot (\\mathbf{k} \\times (\\delta\\mathbf{v} \\times \\mathbf{B}_0)) = 0$.\n\nFrom equation (5), we have two families of solutions:\n-   If $\\omega' \\neq 0$, then $\\delta p = a^2 \\delta\\rho$. These are the acoustic and magnetic wave modes.\n-   If $\\omega' = 0$, then $\\omega = \\mathbf{k} \\cdot \\mathbf{v}_0$. This gives the phase speed $\\omega/k = \\mathbf{v}_0 \\cdot \\hat{\\mathbf{n}} = v_n$. This is the entropy mode, which corresponds to a density perturbation advected with the fluid flow, with $\\delta\\mathbf{v}=0$, $\\delta\\mathbf{B}=0$, $\\delta p=0$.\n\nFor the $\\omega'\\neq 0$ modes, we solve the system. It is convenient to choose a coordinate system where $\\mathbf{k} = (0,0,k)$ and $\\mathbf{B}_0$ lies in the x-z plane, $\\mathbf{B}_0 = (B_{0x}, 0, B_{0z})$. The constraint $\\mathbf{k} \\cdot \\delta\\mathbf{B}=0$ implies $\\delta B_z = 0$. The equations for the components of $\\delta\\mathbf{v}$ and $\\delta\\mathbf{B}$ decouple.\n\nThe y-component equations yield an incompressible transverse wave, the Alfvén wave:\n$$(\\omega'^2 - k^2 c_{A,n}^2) \\delta v_y = 0$$\nwhere $c_{A,n} = |\\mathbf{B}_0 \\cdot \\hat{\\mathbf{n}}|/\\sqrt{\\rho_0}$ is the component of the Alfvén speed along the propagation direction. The dispersion relation is $\\omega' = \\pm k c_{A,n}$. The phase speeds in the lab frame are $v_{ph} = \\omega/k = v_n \\pm c_{A,n}$.\n\nThe x and z components are coupled and describe compressible magnetosonic waves. A $2 \\times 2$ system for $(\\delta v_x, \\delta v_z)$ leads to the dispersion relation for the fast and slow magnetosonic modes. Defining the phase speed in the fluid frame $V = \\omega'/k$, we obtain a quadratic equation for $V^2$:\n$$V^4 - (a^2 + c_A^2)V^2 + a^2 c_{A,n}^2 = 0$$\nwhere $c_A^2 = |\\mathbf{B}_0|^2/\\rho_0$ is the squared total Alfvén speed. The solutions for $V^2$ are the squared fast ($c_f^2$) and slow ($c_s^2$) magnetosonic speeds:\n$$c_{f,s}^2 = \\frac{1}{2} \\left[ (a^2 + c_A^2) \\pm \\sqrt{(a^2+c_A^2)^2 - 4 a^2 c_{A,n}^2} \\right]$$\nThe fast mode corresponds to the '+' sign and the slow mode to the '-' sign, ensuring $c_f \\ge c_s \\ge 0$. The lab-frame phase speeds are $v_{ph} = v_n \\pm c_f$ and $v_n \\pm c_s$.\n\nIn summary, the seven characteristic wave speeds along $\\hat{\\mathbf{n}}$ are:\n1.  Entropy mode: $v_n$\n2.  Alfvén modes: $v_n \\pm c_{A,n}$\n3.  Slow magnetosonic modes: $v_n \\pm c_s$\n4.  Fast magnetosonic modes: $v_n \\pm c_f$\n\nNow we compute these speeds for the given numerical values:\n-   $\\rho_{0} = 1$\n-   $p_{0} = 1$\n-   $\\gamma = \\dfrac{5}{3}$\n-   $\\mathbf{v}_{0} = (0.3, -0.2, 0.4)$\n-   $\\mathbf{B}_{0} = (1, 2, 2)$\n-   $\\hat{\\mathbf{n}} = (0, 0, 1)$\n\nFirst, we calculate the required physical parameters:\n-   The advection speed along $\\hat{\\mathbf{n}}$: $v_n = \\mathbf{v}_0 \\cdot \\hat{\\mathbf{n}} = (0.3)(0) + (-0.2)(0) + (0.4)(1) = 0.4$.\n-   The squared sound speed: $a^2 = \\dfrac{\\gamma p_0}{\\rho_0} = \\dfrac{(5/3)(1)}{1} = \\dfrac{5}{3}$.\n-   The squared total Alfvén speed: $|\\mathbf{B}_0|^2 = 1^2+2^2+2^2 = 9$. So, $c_A^2 = \\dfrac{|\\mathbf{B}_0|^2}{\\rho_0} = \\dfrac{9}{1} = 9$.\n-   The squared Alfvén speed projected along $\\hat{\\mathbf{n}}$: $\\mathbf{B}_0 \\cdot \\hat{\\mathbf{n}} = (1)(0) + (2)(0) + (2)(1) = 2$. So, $c_{A,n}^2 = \\dfrac{(\\mathbf{B}_0 \\cdot \\hat{\\mathbf{n}})^2}{\\rho_0} = \\dfrac{2^2}{1} = 4$.\n-   From this, the projected Alfvén speed is $c_{A,n} = \\sqrt{4} = 2$.\n\nNext, we calculate the fast and slow magnetosonic speeds, $c_f$ and $c_s$:\n$$c_{f,s}^2 = \\frac{1}{2} \\left[ \\left(\\frac{5}{3} + 9\\right) \\pm \\sqrt{\\left(\\frac{5}{3}+9\\right)^2 - 4\\left(\\frac{5}{3}\\right)(4)} \\right]$$\n$$c_{f,s}^2 = \\frac{1}{2} \\left[ \\frac{32}{3} \\pm \\sqrt{\\left(\\frac{32}{3}\\right)^2 - \\frac{80}{3}} \\right] = \\frac{1}{2} \\left[ \\frac{32}{3} \\pm \\sqrt{\\frac{1024}{9} - \\frac{240}{9}} \\right]$$\n$$c_{f,s}^2 = \\frac{1}{2} \\left[ \\frac{32}{3} \\pm \\sqrt{\\frac{784}{9}} \\right] = \\frac{1}{2} \\left[ \\frac{32}{3} \\pm \\frac{28}{3} \\right]$$\n-   Fast mode speed squared: $c_f^2 = \\dfrac{1}{2}\\left(\\dfrac{32+28}{3}\\right) = \\dfrac{1}{2}\\left(\\dfrac{60}{3}\\right) = 10$. So, $c_f = \\sqrt{10}$.\n-   Slow mode speed squared: $c_s^2 = \\dfrac{1}{2}\\left(\\dfrac{32-28}{3}\\right) = \\dfrac{1}{2}\\left(\\dfrac{4}{3}\\right) = \\dfrac{2}{3}$. So, $c_s = \\sqrt{\\dfrac{2}{3}}$.\n\nFinally, we compute the seven characteristic speeds in the lab frame and round to 6 significant figures:\n-   $v_{n} - c_{f} = 0.4 - \\sqrt{10} \\approx 0.4 - 3.16227766 = -2.76227766 \\approx -2.76228$\n-   $v_{n} - c_{A,n} = 0.4 - 2 = -1.60000$\n-   $v_{n} - c_{s} = 0.4 - \\sqrt{2/3} \\approx 0.4 - 0.81649658 = -0.41649658 \\approx -0.416497$\n-   $v_{n} = 0.400000$\n-   $v_{n} + c_{s} = 0.4 + \\sqrt{2/3} \\approx 0.4 + 0.81649658 = 1.21649658 \\approx 1.21650$\n-   $v_{n} + c_{A,n} = 0.4 + 2 = 2.40000$\n-   $v_{n} + c_{f} = 0.4 + \\sqrt{10} \\approx 0.4 + 3.16227766 = 3.56227766 \\approx 3.56228$\n\nThe calculated speeds in the specified canonical ordering are presented as a row vector.", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n-2.76228 & -1.60000 & -0.416497 & 0.400000 & 1.21650 & 2.40000 & 3.56228\n\\end{pmatrix}\n}\n$$", "id": "3539067"}, {"introduction": "While the ideal MHD equations guarantee that an initially divergence-free magnetic field remains so, this property is not automatically inherited by numerical discretizations. This exercise demonstrates the consequences of violating the $\\nabla \\cdot \\mathbf{B} = 0$ constraint by deliberately introducing a divergence error into a one-dimensional Riemann problem. By comparing how different Riemann solvers handle this non-physical situation, you will gain practical insight into the robustness of various numerical methods and the necessity of divergence-control techniques [@problem_id:3539086].", "problem": "A one-dimensional ideal magnetohydrodynamics (MHD) Riemann problem consists of two constant thermodynamic-magnetic states separated at an interface located at $x=0$, with left state $x<0$ and right state $x>0$. The ideal MHD equations along the $x$-direction, in units where the magnetic permeability is unity, for conserved variables $\\mathbf{U} = [\\rho, m_x, m_y, m_z, B_y, B_z, E]^\\top$ and interface normal magnetic field $B_x$ are\n$$\n\\frac{\\partial}{\\partial t}\n\\begin{bmatrix}\n\\rho\\\\\nm_x\\\\\nm_y\\\\\nm_z\\\\\nB_y\\\\\nB_z\\\\\nE\n\\end{bmatrix}\n+\n\\frac{\\partial}{\\partial x}\n\\begin{bmatrix}\n\\rho v_x\\\\\nm_x v_x + p + \\frac{1}{2}B^2 - B_x^2\\\\\nm_y v_x - B_x B_y\\\\\nm_z v_x - B_x B_z\\\\\nB_y v_x - B_x v_y\\\\\nB_z v_x - B_x v_z\\\\\n(E + p_t) v_x - B_x (\\mathbf{v}\\cdot\\mathbf{B})\n\\end{bmatrix}\n=\n\\mathbf{0}\n$$\nwhere $\\rho$ is mass density, $\\mathbf{v}=(v_x,v_y,v_z)$ is velocity, $\\mathbf{B}=(B_x,B_y,B_z)$ is magnetic field, $m_i = \\rho v_i$ are momentum components, $E$ is total energy density, $p$ is gas pressure, $B^2 = \\mathbf{B}\\cdot\\mathbf{B}$, and $p_t = p + \\frac{1}{2} B^2$ is total pressure. The equation of state for an ideal gas gives\n$$\nE = \\frac{p}{\\gamma - 1} + \\frac{1}{2}\\rho \\|\\mathbf{v}\\|^2 + \\frac{1}{2} \\|\\mathbf{B}\\|^2\n$$\nwith adiabatic index $\\gamma>1$. The divergence-free constraint for magnetic field is $\\nabla\\cdot\\mathbf{B} = 0$, which, in the strict one-dimensional setting, reduces to $\\frac{\\partial B_x}{\\partial x} = 0$; thus, $B_x$ must be continuous across the interface in an exact ideal MHD Riemann problem.\n\nThis problem requires you to construct an exact solution to a special one-dimensional ideal MHD Riemann problem in the transverse Alfvénic subsystem, and then study the impact of deliberately perturbing the divergence-free constraint by setting $B_{x,L} \\neq B_{x,R}$, which produces a localized non-zero $\\nabla\\cdot\\mathbf{B}$ at the interface. You must evaluate and compare the robustness of three Riemann solvers—Roe, Harten-Lax-van Leer Discontinuities (HLLD), and Harten-Lax-van Leer Einfeldt (HLLE)—against the emergence of non-physical intermediate states when the divergence-free constraint is violated.\n\nFundamental base and setup:\n- Consider an initial configuration with constant left and right states defined by $(\\rho, p, v_x, v_y, v_z, B_x, B_y, B_z)$ on each side. Use code units with magnetic permeability equal to unity. Let $\\gamma = \\frac{5}{3}$.\n- Focus on the transverse Alfvénic subsystem of ideal MHD in one dimension with $v_x=0$, $B_z=0$, and $v_z=0$, where only $v_y$ and $B_y$ may differ between the left and right states while $\\rho$ and $p$ are equal on both sides in the exact baseline configuration.\n- For the exact Alfvénic subsystem solution at $x/t=0$ with continuous $B_x$ and equal density on both sides, the transverse Riemann invariants $w^\\pm = v_y \\pm B_y / \\sqrt{\\rho}$ propagate with speeds $S^\\pm = v_x \\pm c_{A,x}$ where $c_{A,x} = |B_x|/\\sqrt{\\rho}$. At $x/t=0$ and $v_x=0$ with $B_x>0$, the interfacial exact star state is given by\n$$\nv_y^\\star = \\frac{w_L^+ + w_R^-}{2},\\quad B_y^\\star = \\frac{\\sqrt{\\rho}\\,(w_L^+ - w_R^-)}{2}.\n$$\n- To study violations of the divergence-free constraint, introduce a mismatch $B_{x,L} \\neq B_{x,R}$ across the interface. Approximate the localized divergence at the interface as\n$$\n(\\nabla\\cdot\\mathbf{B})_\\mathrm{int} \\approx \\frac{B_{x,R} - B_{x,L}}{\\Delta x}\n$$\nfor a chosen spatial normalization $\\Delta x$. Under the eight-wave formulation of ideal MHD (Powell’s source terms), a non-zero $\\nabla\\cdot\\mathbf{B}$ couples to the energy equation through an additional source term\n$$\n\\frac{\\partial E}{\\partial t}\\Big|_{\\mathrm{div}B} = -(\\mathbf{v}\\cdot\\mathbf{B})\\,(\\nabla\\cdot\\mathbf{B}).\n$$\nFor a single interface update over a time step $\\Delta t$, the energy perturbation is\n$$\n\\Delta E = -(\\mathbf{v}^\\star\\cdot\\mathbf{B}^\\star)\\,(\\nabla\\cdot\\mathbf{B})_\\mathrm{int}\\,\\Delta t,\n$$\nwhere $\\mathbf{v}^\\star$ and $\\mathbf{B}^\\star$ are the interfacial star states produced by a given solver. Use the interfacial $B_x^\\star$ as the arithmetic average $B_x^\\star = \\frac{1}{2}(B_{x,L}+B_{x,R})$.\n\nSolver-specific interfacial star states for the transverse subsystem:\n- Roe solver: For the linear transverse Alfvénic subsystem under $v_x=0$ and equal $\\rho$ on both sides, Roe’s linearization resolves Alfvén waves exactly. Use the exact interfacial star state $(v_y^\\star, B_y^\\star)$ given above.\n- HLLD solver: In the same specialized subsystem and conditions, HLLD resolves Alfvénic intermediate states sharply. Use the exact interfacial star state $(v_y^\\star, B_y^\\star)$ given above.\n- HLLE solver: Use the two-wave HLL average specialized to the transverse subsystem. Define $S_L = v_{x,L} - c_{A,L}$ and $S_R = v_{x,R} + c_{A,R}$ where $c_{A,L} = |B_{x,L}|/\\sqrt{\\rho}$ and $c_{A,R} = |B_{x,R}|/\\sqrt{\\rho}$; with $v_x=0$, these are $S_L = -c_{A,L}$ and $S_R = +c_{A,R}$. Let $\\mathbf{U}_t = [m_y, B_y]^\\top$ and $\\mathbf{F}_t = [m_y v_x - B_x B_y,\\, B_y v_x - B_x v_y]^\\top$. With $v_x=0$, these fluxes reduce to $\\mathbf{F}_t = [-B_x B_y,\\,-B_x v_y]^\\top$. The HLLE interfacial transverse star state is\n$$\n\\mathbf{U}_t^\\star = \\frac{S_R \\mathbf{U}_{t,R} - S_L \\mathbf{U}_{t,L} + \\mathbf{F}_{t,L} - \\mathbf{F}_{t,R}}{S_R - S_L},\\quad v_y^\\star = \\frac{m_y^\\star}{\\rho},\\quad B_y^\\star = (\\mathbf{U}_t^\\star)_2.\n$$\n\nEnergy and gas pressure update:\n- For a given solver’s $(v_y^\\star, B_y^\\star)$ and $B_x^\\star$, define the interfacial star total energy before divergence perturbation as\n$$\nE^\\star = \\frac{p}{\\gamma - 1} + \\frac{1}{2}\\rho\\left[(v_x)^2 + (v_y^\\star)^2 + (v_z)^2\\right] + \\frac{1}{2}\\left[(B_x^\\star)^2 + (B_y^\\star)^2 + (B_z)^2\\right].\n$$\n- Apply the divergence-induced energy update using the source term to obtain\n$$\nE^{\\star\\star} = E^\\star + \\Delta E.\n$$\n- Recover the interfacial gas pressure from $E^{\\star\\star}$,\n$$\np^{\\star\\star} = (\\gamma - 1)\\left( E^{\\star\\star} - \\frac{1}{2}\\rho\\left[(v_x)^2 + (v_y^\\star)^2 + (v_z)^2\\right] - \\frac{1}{2}\\left[(B_x^\\star)^2 + (B_y^\\star)^2 + (B_z)^2\\right] \\right).\n$$\nA non-physical intermediate state is defined here as one with $p^{\\star\\star} < 0$.\n\nTime step and normalization:\n- Choose $\\Delta x = 1$ and a Courant number $\\mathrm{CFL} = \\frac{1}{2}$. Define the time step by the maximum Alfvén speed on either side,\n$$\n\\Delta t = \\mathrm{CFL}\\frac{\\Delta x}{\\max(c_{A,L}, c_{A,R})},\\quad c_{A,\\{\\cdot\\}} = \\frac{|B_{x,\\{\\cdot\\}}|}{\\sqrt{\\rho}}.\n$$\n\nYour program must, for each test case, compute the interfacial star states for Roe, HLLD, and HLLE as described above, apply the divergence-induced energy update, determine whether the resulting interfacial gas pressure $p^{\\star\\star}$ is non-negative, and return a boolean for each solver indicating physical admissibility. If a computation encounters a division by zero (e.g., $S_R - S_L = 0$), treat the star state as undefined and return a boolean value of `False` for that solver.\n\nTest suite:\nUse $\\gamma = \\frac{5}{3}$, $\\Delta x = 1$, and $\\mathrm{CFL} = \\frac{1}{2}$ for all cases, with $v_x=0$ and $B_z=v_z=0$. Each test case specifies $(\\rho, p, v_{y,L}, B_{y,L}, v_{y,R}, B_{y,R}, B_{x,L}, B_{x,R})$:\n\n1. Baseline near divergence-free, moderate transverse Alfvénic jump:\n   - $(\\rho, p, v_{y,L}, B_{y,L}, v_{y,R}, B_{y,R}, B_{x,L}, B_{x,R}) = (1.0, 1.0, 0.1, 0.1, -0.1, -0.1, 1.0, 1.0 + 10^{-8})$.\n2. Moderate divergence violation with opposing transverse fields designed to maximize negative $(\\mathbf{v}\\cdot\\mathbf{B})$:\n   - $(\\rho, p, v_{y,L}, B_{y,L}, v_{y,R}, B_{y,R}, B_{x,L}, B_{x,R}) = (1.0, 0.02, 0.5, -0.5, -0.5, 0.5, 1.0, 0.5)$.\n3. Boundary case with zero transverse components:\n   - $(\\rho, p, v_{y,L}, B_{y,L}, v_{y,R}, B_{y,R}, B_{x,L}, B_{x,R}) = (1.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.2, 0.05)$.\n4. Strong divergence error with the same opposing transverse configuration:\n   - $(\\rho, p, v_{y,L}, B_{y,L}, v_{y,R}, B_{y,R}, B_{x,L}, B_{x,R}) = (1.0, 0.10, 0.5, -0.5, -0.5, 0.5, 1.0, 0.0)$.\n\nFinal output format:\nYour program should produce a single line of output containing the results for all test cases as a comma-separated list enclosed in square brackets. Each test case’s result must be a list of three booleans in the order [`Roe`, `HLLD`, `HLLE`], indicating whether $p^{\\star\\star} \\ge 0$ for that solver. For example, an output line could look like:\n`[ [True,True,False], [True,True,True], ... ]`.", "solution": "The ideal magnetohydrodynamics (MHD) equations couple fluid dynamics with electromagnetic fields under the assumptions of infinite conductivity and negligible displacement current. The one-dimensional system along the $x$-direction admits a flux-form conservation law for $\\rho$, $\\mathbf{m}=\\rho\\mathbf{v}$, $(B_y,B_z)$, and $E$, with $B_x$ appearing as a parameter in the flux; the divergence-free constraint reduces to $\\frac{\\partial B_x}{\\partial x}=0$, implying that a physically exact one-dimensional Riemann problem must have continuous $B_x$ across the interface.\n\nTo build a tractable exact solution and simultaneously isolate the impact of $\\nabla\\cdot\\mathbf{B}$ violations, we consider the transverse Alfvénic subsystem with $v_x=0$, $v_z=0$, $B_z=0$, equal density $\\rho$ on each side, and equal gas pressure $p$ in the baseline configuration. In this reduced subsystem, the relevant variables are $v_y$ and $B_y$, and the propagating characteristics are Alfvén waves along $x$ with speeds $S^\\pm = v_x \\pm c_{A,x} = \\pm c_{A,x}$ for $v_x=0$, where $c_{A,x} = |B_x|/\\sqrt{\\rho}$ is the Alfvén speed associated with $B_x$. The transverse Alfvénic Riemann invariants are $w^\\pm = v_y \\pm B_y/\\sqrt{\\rho}$. For continuous $B_x$ and equal $\\rho$, the exact interfacial state at $x/t=0$ is obtained by upwinding these invariants: at $x/t=0$ and $B_x>0$, the right-propagating invariant $w^+$ samples from the left state and the left-propagating invariant $w^-$ samples from the right state, yielding\n$$\nv_y^\\star = \\frac{w_L^+ + w_R^-}{2},\\qquad B_y^\\star = \\frac{\\sqrt{\\rho}\\,(w_L^+ - w_R^-)}{2}.\n$$\nThis result follows from linear characteristic theory and is exact for the specified subsystem.\n\nTo study violations of the divergence-free constraint, we introduce a mismatch $B_{x,L} \\neq B_{x,R}$. In a finite-volume discretization, a localized divergence at the interface can be modeled as $(\\nabla\\cdot\\mathbf{B})_\\mathrm{int} \\approx (B_{x,R}-B_{x,L})/\\Delta x$, which produces extra source terms in non-conservative formulations such as Powell’s eight-wave method. In particular, the energy equation acquires a source term\n$$\n\\frac{\\partial E}{\\partial t}\\Big|_{\\mathrm{div}B} = -(\\mathbf{v}\\cdot\\mathbf{B})\\,(\\nabla\\cdot\\mathbf{B}).\n$$\nOver a single interface update of duration $\\Delta t$, the resulting energy change is\n$$\n\\Delta E = -(\\mathbf{v}^\\star\\cdot\\mathbf{B}^\\star)\\,(\\nabla\\cdot\\mathbf{B})_\\mathrm{int}\\,\\Delta t,\n$$\nwhere the interfacial star state $(\\mathbf{v}^\\star,\\mathbf{B}^\\star)$ depends on the Riemann solver used. Because our subsystem has $v_x=0$, $v_z=0$, $B_z=0$, the dot product reduces to $(\\mathbf{v}^\\star\\cdot\\mathbf{B}^\\star) = v_y^\\star B_y^\\star$. The interfacial $B_x^\\star$ is taken as the arithmetic average $B_x^\\star = \\frac{1}{2}(B_{x,L}+B_{x,R})$ to represent a consistent interface value.\n\nWe now specify the interfacial star states for the three solvers:\n\n1. Roe solver. Roe linearization diagonalizes the system at a suitable averaged state and produces the same result as the exact solution for the linear transverse Alfvénic subsystem. Therefore, we take\n$$\n(v_y^\\star, B_y^\\star)_\\mathrm{Roe} = (v_y^\\star, B_y^\\star)_\\mathrm{exact} = \\left( \\frac{w_L^+ + w_R^-}{2},\\, \\frac{\\sqrt{\\rho}\\,(w_L^+ - w_R^-)}{2} \\right).\n$$\n\n2. Harten-Lax-van Leer Discontinuities (HLLD). HLLD is a multi-wave approximate MHD Riemann solver that resolves the contact and Alfvén waves. In the present transverse subsystem with $v_x=0$, equal $\\rho$, and $B_x>0$, HLLD also reproduces the exact Alfvénic star state, so we set\n$$\n(v_y^\\star, B_y^\\star)_\\mathrm{HLLD} = (v_y^\\star, B_y^\\star)_\\mathrm{exact}.\n$$\n\n3. Harten-Lax-van Leer Einfeldt (HLLE). HLLE collapses the wave fan into two bounding signal speeds $S_L$ and $S_R$, yielding a single average intermediate state. Applied to the transverse subsystem with $v_x=0$, define\n$$\nS_L = -c_{A,L} = -\\frac{|B_{x,L}|}{\\sqrt{\\rho}},\\qquad S_R = +c_{A,R} = +\\frac{|B_{x,R}|}{\\sqrt{\\rho}}.\n$$\nLet the transverse conserved variables and fluxes be\n$$\n\\mathbf{U}_t = \\begin{bmatrix}m_y\\\\B_y\\end{bmatrix} = \\begin{bmatrix}\\rho v_y\\\\B_y\\end{bmatrix},\\qquad\n\\mathbf{F}_t = \\begin{bmatrix}m_y v_x - B_x B_y\\\\ B_y v_x - B_x v_y\\end{bmatrix} = \\begin{bmatrix}-B_x B_y\\\\ -B_x v_y\\end{bmatrix}.\n$$\nThen the HLLE transverse star state is\n$$\n\\mathbf{U}_t^\\star = \\frac{S_R \\mathbf{U}_{t,R} - S_L \\mathbf{U}_{t,L} + \\mathbf{F}_{t,L} - \\mathbf{F}_{t,R}}{S_R - S_L},\\qquad v_y^\\star = \\frac{m_y^\\star}{\\rho},\\qquad B_y^\\star = (\\mathbf{U}_t^\\star)_2.\n$$\nThis construction captures the effect of unequal $B_{x,L}$ and $B_{x,R}$ on the star state through the signal speeds and fluxes.\n\nWith $(v_y^\\star, B_y^\\star)$ and $B_x^\\star$ in hand for each solver, we compute the pre-perturbation interfacial energy\n$$\nE^\\star = \\frac{p}{\\gamma - 1} + \\frac{1}{2}\\rho (v_y^\\star)^2 + \\frac{1}{2}\\left[(B_x^\\star)^2 + (B_y^\\star)^2\\right],\n$$\nand apply the divergence-induced energy change\n$$\n\\Delta E = - v_y^\\star B_y^\\star \\left(\\frac{B_{x,R} - B_{x,L}}{\\Delta x}\\right)\\Delta t\n$$\nwith $\\Delta x = 1$ and $\\Delta t = \\mathrm{CFL}\\,\\Delta x/\\max(c_{A,L}, c_{A,R})$ using $\\mathrm{CFL}=\\frac{1}{2}$. The updated energy is $E^{\\star\\star} = E^\\star + \\Delta E$. The updated gas pressure is recovered as\n$$\np^{\\star\\star} = (\\gamma - 1)\\left( E^{\\star\\star} - \\frac{1}{2}\\rho (v_y^\\star)^2 - \\frac{1}{2}\\left[(B_x^\\star)^2 + (B_y^\\star)^2\\right] \\right).\n$$\nA state is deemed non-physical if $p^{\\star\\star} < 0$.\n\nAlgorithmic steps for each test case:\n- Input $(\\rho, p, v_{y,L}, B_{y,L}, v_{y,R}, B_{y,R}, B_{x,L}, B_{x,R})$ with $v_x=0$ and $B_z=v_z=0$.\n- Compute $B_x^\\star = \\frac{1}{2}(B_{x,L}+B_{x,R})$, $c_{A,L} = |B_{x,L}|/\\sqrt{\\rho}$, $c_{A,R} = |B_{x,R}|/\\sqrt{\\rho}$, $\\Delta t = \\frac{1}{2}/\\max(c_{A,L}, c_{A,R})$.\n- Exact/Roe/HLLD star:\n  - Compute $w_L^+ = v_{y,L} + B_{y,L}/\\sqrt{\\rho}$ and $w_R^- = v_{y,R} - B_{y,R}/\\sqrt{\\rho}$.\n  - Set $(v_y^\\star, B_y^\\star) = \\left(\\frac{w_L^+ + w_R^-}{2},\\, \\frac{\\sqrt{\\rho}\\,(w_L^+ - w_R^-)}{2}\\right)$.\n- HLLE star:\n  - Compute $S_L = -c_{A,L}$, $S_R = +c_{A,R}$, $\\mathbf{U}_{t,L}=[\\rho v_{y,L}, B_{y,L}]^\\top$, $\\mathbf{U}_{t,R}=[\\rho v_{y,R}, B_{y,R}]^\\top$, $\\mathbf{F}_{t,L}=[-B_{x,L} B_{y,L}, -B_{x,L} v_{y,L}]^\\top$, $\\mathbf{F}_{t,R}=[-B_{x,R} B_{y,R}, -B_{x,R} v_{y,R}]^\\top$.\n  - If $S_R - S_L \\neq 0$, set $\\mathbf{U}_t^\\star = \\frac{S_R \\mathbf{U}_{t,R}-S_L \\mathbf{U}_{t,L}+\\mathbf{F}_{t,L}-\\mathbf{F}_{t,R}}{S_R - S_L}$ and $(v_y^\\star, B_y^\\star) = ((\\mathbf{U}_t^\\star)_1/\\rho, (\\mathbf{U}_t^\\star)_2)$; otherwise, declare failure for HLLE.\n- For each solver’s $(v_y^\\star, B_y^\\star)$, compute $E^\\star$, $\\Delta E$, $E^{\\star\\star}$, and $p^{\\star\\star}$; return a boolean indicating $p^{\\star\\star}\\ge 0$. If a division by zero or undefined step occurs, return `False`.\n\nTest suite coverage rationale:\n- Case 1 is a near-divergence-free configuration with modest transverse Alfvénic jump; it tests the “happy path” where all solvers should remain physical.\n- Case 2 introduces a moderate divergence violation and opposing transverse fields to maximize negative $(\\mathbf{v}\\cdot\\mathbf{B})$, stressing the energy source term; it tests susceptibility to non-physical states.\n- Case 3 is a boundary case with zero transverse components, rendering $(\\mathbf{v}\\cdot\\mathbf{B})=0$ and neutralizing divergence-induced energy change; all solvers should be robust.\n- Case 4 imposes a strong divergence error with the same transverse configuration, probing severe conditions.\n\nThe program aggregates results per test case as [`Roe`, `HLLD`, `HLLE`] booleans and prints a single list-of-lists line, enabling automated verification of solver robustness under prescribed divergence violations.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\nGAMMA = 5.0 / 3.0\nCFL = 0.5\nDX = 1.0\n\ndef exact_alfven_star(rho, vyL, ByL, vyR, ByR):\n    \"\"\"\n    Exact transverse Alfvénic star state for v_x=0, equal rho, using Riemann invariants.\n    Returns (v_y_star, B_y_star).\n    \"\"\"\n    sqrt_rho = np.sqrt(rho)\n    wLp = vyL + ByL / sqrt_rho\n    wRm = vyR - ByR / sqrt_rho\n    vy_star = 0.5 * (wLp + wRm)\n    By_star = 0.5 * sqrt_rho * (wLp - wRm)\n    return vy_star, By_star\n\ndef hlle_transverse_star(rho, vxL, vyL, ByL, BxL, vxR, vyR, ByR, BxR):\n    \"\"\"\n    HLLE transverse star state for the subsystem with v_x possibly zero.\n    Uses U_t = [m_y, B_y], F_t = [m_y v_x - B_x B_y, B_y v_x - B_x v_y].\n    Returns (v_y_star, B_y_star) or (None, None) if denominator is zero.\n    \"\"\"\n    cAL = abs(BxL) / np.sqrt(rho)\n    cAR = abs(BxR) / np.sqrt(rho)\n    SL = vxL - cAL\n    SR = vxR + cAR\n    denom = SR - SL\n    if denom == 0.0:\n        return None, None\n    UyL = rho * vyL\n    UyR = rho * vyR\n    FtL = np.array([UyL * vxL - BxL * ByL, ByL * vxL - BxL * vyL], dtype=float)\n    FtR = np.array([UyR * vxR - BxR * ByR, ByR * vxR - BxR * vyR], dtype=float)\n    UtL = np.array([UyL, ByL], dtype=float)\n    UtR = np.array([UyR, ByR], dtype=float)\n    Ut_star = (SR * UtR - SL * UtL + FtL - FtR) / denom\n    vy_star = Ut_star[0] / rho\n    By_star = Ut_star[1]\n    return vy_star, By_star\n\ndef energy_pressure_update(rho, p, vx, vy_star, vz, Bx_star, By_star, Bz,\n                           BxL, BxR):\n    \"\"\"\n    Compute E*, apply divergence-induced energy change, recover p**.\n    Returns p_new (float).\n    \"\"\"\n    # Pre-perturbation energy E*\n    kinetic = 0.5 * rho * (vx*vx + vy_star*vy_star + vz*vz)\n    magnetic = 0.5 * (Bx_star*Bx_star + By_star*By_star + Bz*Bz)\n    E_star = p / (GAMMA - 1.0) + kinetic + magnetic\n\n    # Divergence and timestep\n    divB = (BxR - BxL) / DX\n    cAL = abs(BxL) / np.sqrt(rho)\n    cAR = abs(BxR) / np.sqrt(rho)\n    cAmax = max(cAL, cAR)\n    if cAmax == 0.0:\n        dt = 0.0\n    else:\n        dt = CFL * DX / cAmax\n\n    # Energy change from Powell source term\n    vdotB = vx * Bx_star + vy_star * By_star + vz * Bz\n    dE = - vdotB * divB * dt\n    E_new = E_star + dE\n\n    # Recover gas pressure\n    internal = E_new - kinetic - magnetic\n    p_new = (GAMMA - 1.0) * internal\n    return p_new\n\ndef evaluate_case(case):\n    \"\"\"\n    Evaluate one test case across Roe, HLLD, HLLE.\n    case: (rho, p, vyL, ByL, vyR, ByR, BxL, BxR)\n    Returns [bool_Roe, bool_HLLD, bool_HLLE]\n    \"\"\"\n    rho, p, vyL, ByL, vyR, ByR, BxL, BxR = case\n    vxL = 0.0\n    vxR = 0.0\n    vx = 0.0\n    vz = 0.0\n    Bz = 0.0\n    Bx_star = 0.5 * (BxL + BxR)\n\n    # Roe / Exact star\n    vy_star_exact, By_star_exact = exact_alfven_star(rho, vyL, ByL, vyR, ByR)\n    p_new_roe = energy_pressure_update(rho, p, vx, vy_star_exact, vz, Bx_star, By_star_exact, Bz, BxL, BxR)\n    ok_roe = (np.isfinite(p_new_roe) and (p_new_roe >= 0.0))\n\n    # HLLD (same as exact in this subsystem)\n    vy_star_hlld, By_star_hlld = vy_star_exact, By_star_exact\n    p_new_hlld = energy_pressure_update(rho, p, vx, vy_star_hlld, vz, Bx_star, By_star_hlld, Bz, BxL, BxR)\n    ok_hlld = (np.isfinite(p_new_hlld) and (p_new_hlld >= 0.0))\n\n    # HLLE\n    vy_star_hlle, By_star_hlle = hlle_transverse_star(rho, vxL, vyL, ByL, BxL, vxR, vyR, ByR, BxR)\n    if vy_star_hlle is None or By_star_hlle is None or not (np.isfinite(vy_star_hlle) and np.isfinite(By_star_hlle)):\n        ok_hlle = False\n    else:\n        p_new_hlle = energy_pressure_update(rho, p, vx, vy_star_hlle, vz, Bx_star, By_star_hlle, Bz, BxL, BxR)\n        ok_hlle = (np.isfinite(p_new_hlle) and (p_new_hlle >= 0.0))\n\n    return [ok_roe, ok_hlld, ok_hlle]\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (rho, p, vyL, ByL, vyR, ByR, BxL, BxR)\n        (1.0, 1.0, 0.1, 0.1, -0.1, -0.1, 1.0, 1.0 + 1e-8),\n        (1.0, 0.02, 0.5, -0.5, -0.5, 0.5, 1.0, 0.5),\n        (1.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.2, 0.05),\n        (1.0, 0.10, 0.5, -0.5, -0.5, 0.5, 1.0, 0.0),\n    ]\n\n    results = []\n    for case in test_cases:\n        result = evaluate_case(case)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    # Produce a single line of output as a list-of-lists of booleans.\n    def format_list(lst):\n        return \"[\" + \",\".join(str(x) for x in lst) + \"]\"\n    print(\"[\" + \",\".join(format_list(r).replace(\"True\", \"True\").replace(\"False\", \"False\")) + \"]\")\n\nsolve()\n```", "id": "3539086"}, {"introduction": "Having witnessed the numerical pathologies that arise from unconstrained $\\nabla \\cdot \\mathbf{B}$ errors, we now turn to a robust solution: the Constrained Transport (CT) method. The CT method uses a staggered grid to mathematically preserve the divergence-free condition to machine precision. This hands-on practice challenges you to derive and implement a metric-aware CT scheme in cylindrical coordinates, a crucial step toward building reliable MHD codes for astrophysical phenomena with axial symmetry, such as accretion disks and jets [@problem_id:3539071].", "problem": "You are to derive and implement the metric-aware constrained transport (CT) update for the magnetic induction subsystem of ideal magnetohydrodynamics (MHD), in axisymmetric cylindrical coordinates. Your implementation must be conservative in the sense that it exactly preserves a discrete representation of the divergence-free constraint for the magnetic field, up to machine precision, even near the cylindrical axis. The physics is ideal magnetohydrodynamics (MHD), with the induction equation obtained from the Maxwell–Faraday law and the ideal Ohm’s law. Your derivation must begin strictly from the fundamental laws: the Maxwell–Faraday law and the ideal Ohm’s law for a perfectly conducting fluid.\n\nStarting point and modeling assumptions:\n- The fundamental Maxwell–Faraday law is $\\partial \\mathbf{B}/\\partial t = - \\nabla \\times \\mathbf{E}$, and the ideal Ohm’s law is $\\mathbf{E} = - \\mathbf{v} \\times \\mathbf{B}$, where $\\mathbf{B}$ is the magnetic field, $\\mathbf{E}$ is the electric field, and $\\mathbf{v}$ is the fluid velocity.\n- Use cylindrical coordinates $(r,\\phi,z)$ with axisymmetry, meaning $\\partial/\\partial \\phi = 0$.\n- Restrict to the poloidal induction subsystem that updates $B_r$ and $B_z$ via $E_\\phi$; you may hold the toroidal component $B_\\phi$ fixed and do not need to update mass, momentum, or energy.\n- The discrete divergence operator to be preserved is the cylindrical, axisymmetric divergence of $\\mathbf{B}$: $\\nabla\\cdot\\mathbf{B} = \\frac{1}{r}\\frac{\\partial}{\\partial r}(r B_r) + \\frac{\\partial B_z}{\\partial z}$.\n\nYour tasks:\n- Derive, from the Maxwell–Faraday law and the ideal Ohm’s law, semi-discrete, metric-aware CT updates for the face-centered magnetic components $B_r$ and $B_z$ on a uniform $(r,z)$ grid under axisymmetry. You must express the updates in terms of edge-centered $E_\\phi$ and show how the cylindrical metric factors enter the update.\n- Derive a consistent, face-centered discrete divergence operator that uses $r B_r$ on radial faces and $B_z$ on axial faces, and prove that the CT updates preserve this discrete divergence exactly (to round-off), assuming periodic boundary conditions in $z$ and regularity at $r=0$.\n- Implement a program that:\n  - Builds a uniform grid with $N_r$ cells in $r \\in [0,R]$ and $N_z$ cells in $z \\in [0,Z]$.\n  - Stores $B_r$ on radial faces at locations $(r_{i+1/2}, z_j)$ and $B_z$ on axial faces at locations $(r_i, z_{j+1/2})$, with $i \\in \\{0,\\dots,N_r-1\\}$ and $j \\in \\{0,\\dots,N_z-1\\}$ for centers and the obvious face-index ranges. Here $r_i = (i+1/2)\\Delta r$ and $z_j = (j+1/2)\\Delta z$ with $\\Delta r = R/N_r$ and $\\Delta z = Z/N_z$. Radial faces are at $r_{i+1/2} = i \\Delta r$ with $i \\in \\{0,\\dots,N_r\\}$, and axial faces are at $z_{j+1/2} = j \\Delta z$ with $j \\in \\{0,\\dots,N_z\\}$.\n  - Initializes $B_r=0$ and $B_z=B_0$ constant.\n  - Prescribes a time-independent velocity field with a solid-body rotation and a smooth, axis-regular radial inflow/outflow:\n    - $v_\\phi(r,z) = \\Omega\\, r$,\n    - $v_r(r,z) = a\\, r \\cos\\!\\big(2\\pi z/Z\\big)$,\n    - $v_z(r,z) = 0$.\n  - Computes the edge-centered $E_\\phi$ at cell corners $(r_{i+1/2}, z_{j+1/2})$ from the ideal Ohm’s law using the current $B$ and the prescribed $\\mathbf{v}$ under axisymmetry. You must use $E_\\phi = -(\\mathbf{v} \\times \\mathbf{B})_\\phi = - (v_r B_z - v_z B_r)$, which reduces to $E_\\phi = - v_r B_z$ since $v_z=0$.\n  - Advances $B_r$ and $B_z$ by one or more CT time steps with your metric-aware updates. Use periodic boundary conditions in $z$. At the cylindrical axis $r=0$ enforce regularity by $B_r(r=0,\\cdot)=0$. The outer radial boundary at $r=R$ can be updated by the same CT formula (no inflow/outflow handling is required beyond that).\n  - Uses a time step computed from a Courant–Friedrichs–Lewy (CFL) condition based on the poloidal flow: $\\Delta t = C_{\\mathrm{cfl}} \\min(\\Delta r,\\Delta z)/\\max(|v_r|+|v_z|)$, evaluated on the grid. If the maximum denominator is zero, set $\\Delta t = C_{\\mathrm{cfl}} \\min(\\Delta r,\\Delta z)$.\n  - After a prescribed number of steps, computes the maximum absolute value of the discrete divergence over all cell centers using the metric-consistent operator:\n    $$D_{i,j} = \\frac{1}{r_i}\\,\\frac{r_{i+1/2} B_{r\\,i+1/2,j} - r_{i-1/2} B_{r\\,i-1/2,j}}{\\Delta r} \\;+\\; \\frac{B_{z\\,i,j+1/2} - B_{z\\,i,j-1/2}}{\\Delta z}.$$\n  - Reports this maximum absolute discrete divergence as a floating-point number.\n\nNumerical units:\n- Use dimensionless units throughout. All reported quantities must be dimensionless.\n\nAngle units:\n- Any trigonometric functions of $z$ must use radians.\n\nTest suite:\nImplement your program to execute the following test cases and output the results aggregated into a single line as specified below. For each case, run the scheme for $N_{\\mathrm{steps}}$ steps and report the final maximum absolute discrete divergence.\n\n- Case $1$ (happy path):\n  - $N_r = 32$, $N_z = 32$, $R = 1$, $Z = 1$, $B_0 = 1$, $a = 0.5$, $\\Omega = 3$, $C_{\\mathrm{cfl}} = 0.4$, $N_{\\mathrm{steps}} = 10$.\n- Case $2$ (axis proximity and strong shear):\n  - $N_r = 8$, $N_z = 16$, $R = 0.25$, $Z = 1$, $B_0 = 0.7$, $a = 4.0$, $\\Omega = 10$, $C_{\\mathrm{cfl}} = 0.2$, $N_{\\mathrm{steps}} = 20$.\n- Case $3$ (pure rotation, no poloidal flow):\n  - $N_r = 16$, $N_z = 16$, $R = 1$, $Z = 1$, $B_0 = 2.0$, $a = 0.0$, $\\Omega = 5.0$, $C_{\\mathrm{cfl}} = 0.4$, $N_{\\mathrm{steps}} = 5$.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, with the three floating-point results in the order of the cases above (e.g., $[r_1,r_2,r_3]$). Each entry must be a floating-point number. The output must be a single line with no additional text.\n\nScientific realism and constraints:\n- Ensure that your derivation uses only the Maxwell–Faraday law and the ideal Ohm’s law as its starting point. Do not assume any specialized MHD formulas not derived from these principles.\n- Ensure that your implementation respects the cylindrical metric factors and the axis regularity, and uses periodic boundary conditions in $z$.", "solution": "The user has requested a derivation and implementation of a metric-aware constrained transport (CT) update for the poloidal magnetic field components in axisymmetric cylindrical coordinates. The derivation must start from fundamental principles, and the implementation must numerically preserve the divergence-free condition of the magnetic field.\n\n### Part 1: Derivation of the Semi-Discrete Induction Equations\n\nThe problem begins with two fundamental laws of electromagnetism: the Maxwell-Faraday law and the ideal Ohm's law for a perfectly conducting fluid.\n\n1.  **Maxwell-Faraday Law**:\n    $$ \\frac{\\partial \\mathbf{B}}{\\partial t} = - \\nabla \\times \\mathbf{E} $$\n    where $\\mathbf{B}$ is the magnetic field vector and $\\mathbf{E}$ is the electric field vector.\n\n2.  **Ideal Ohm's Law**:\n    $$ \\mathbf{E} = - \\mathbf{v} \\times \\mathbf{B} $$\n    where $\\mathbf{v}$ is the fluid velocity.\n\nSubstituting the ideal Ohm's law into the Maxwell-Faraday law yields the ideal induction equation:\n$$ \\frac{\\partial \\mathbf{B}}{\\partial t} = \\nabla \\times (\\mathbf{v} \\times \\mathbf{B}) $$\nThe problem is set in cylindrical coordinates $(r, \\phi, z)$ with the assumption of axisymmetry, which implies that all partial derivatives with respect to the azimuthal angle $\\phi$ are zero, i.e., $\\frac{\\partial}{\\partial \\phi} = 0$.\n\nThe curl operator in cylindrical coordinates is given by:\n$$ \\nabla \\times \\mathbf{A} = \\left( \\frac{1}{r}\\frac{\\partial A_z}{\\partial \\phi} - \\frac{\\partial A_\\phi}{\\partial z} \\right) \\hat{\\mathbf{r}} + \\left( \\frac{\\partial A_r}{\\partial z} - \\frac{\\partial A_z}{\\partial r} \\right) \\hat{\\mathbf{\\phi}} + \\frac{1}{r} \\left( \\frac{\\partial (r A_\\phi)}{\\partial r} - \\frac{\\partial A_r}{\\partial \\phi} \\right) \\hat{\\mathbf{z}} $$\nApplying axisymmetry ($\\frac{\\partial}{\\partial \\phi} = 0$), the curl simplifies to:\n$$ \\nabla \\times \\mathbf{A} = - \\frac{\\partial A_\\phi}{\\partial z} \\hat{\\mathbf{r}} + \\left( \\frac{\\partial A_r}{\\partial z} - \\frac{\\partial A_z}{\\partial r} \\right) \\hat{\\mathbf{\\phi}} + \\frac{1}{r} \\frac{\\partial (r A_\\phi)}{\\partial r} \\hat{\\mathbf{z}} $$\nThe problem restricts the analysis to the poloidal induction subsystem, which governs the evolution of the poloidal magnetic field components, $B_r$ and $B_z$. This evolution is driven by the toroidal component of the electric field, $E_\\phi$. From the Faraday's law under axisymmetry, the time derivatives of the poloidal magnetic field components are:\n$$ \\frac{\\partial B_r}{\\partial t} = (-\\nabla \\times \\mathbf{E})_r = - \\left( -\\frac{\\partial E_\\phi}{\\partial z} \\right) = \\frac{\\partial E_\\phi}{\\partial z} $$\n$$ \\frac{\\partial B_z}{\\partial t} = (-\\nabla \\times \\mathbf{E})_z = - \\left( \\frac{1}{r} \\frac{\\partial (r E_\\phi)}{\\partial r} \\right) = -\\frac{1}{r} \\frac{\\partial (r E_\\phi)}{\\partial r} $$\nThe toroidal electric field $E_\\phi$ is given by the $\\hat{\\mathbf{\\phi}}$ component of the ideal Ohm's law:\n$$ E_\\phi = (-\\mathbf{v} \\times \\mathbf{B})_\\phi = -(v_r B_z - v_z B_r) = v_z B_r - v_r B_z $$\nThese two partial differential equations form the semi-discrete system to be solved numerically.\n\n### Part 2: Discretization and the Constrained Transport Update\n\nWe discretize the domain on a uniform grid with cell widths $\\Delta r$ and $\\Delta z$. Following the Constrained Transport (CT) method, the magnetic field components are staggered:\n-   $B_r$ is located on radial faces at positions $(r_{i+1/2}, z_j)$.\n-   $B_z$ is located on axial faces at positions $(r_i, z_{j+1/2})$.\n-   $E_\\phi$ is located at cell corners, or \"edges\" in the $r-z$ plane, at positions $(r_{i+1/2}, z_{j+1/2})$.\n\nHere, $r_i$ and $z_j$ denote cell-center locations, while $r_{i+1/2}$ and $z_{j+1/2}$ denote face/edge locations. The grid is defined as:\n-   Radial cell centers: $r_i = (i+1/2)\\Delta r$ for $i=0, \\dots, N_r-1$.\n-   Radial faces: $r_{i+1/2} = (i+1)\\Delta r$ for $i=-1, \\dots, N_r-1$. The problem statement uses a slightly different indexing convention; we map it to standard finite-volume indices. We define radial faces $r_f[i] = i \\Delta r$ for $i=0, \\dots, N_r$. Cell $i$ is between $r_f[i]$ and $r_f[i+1]$.\n-   Axial faces and centers are defined analogously.\n\nWe now write the finite-difference approximation for the semi-discrete equations using a simple forward Euler time-integration step.\n\nThe update for $B_r$, discretized at $(r_{i+1/2}, z_j)$:\n$$ \\frac{B_{r, i+1/2, j}^{n+1} - B_{r, i+1/2, j}^{n}}{\\Delta t} = \\frac{E_{\\phi, i+1/2, j+1/2}^{n} - E_{\\phi, i+1/2, j-1/2}^{n}}{\\Delta z} $$\n$$ \\implies B_{r, i+1/2, j}^{n+1} = B_{r, i+1/2, j}^{n} + \\frac{\\Delta t}{\\Delta z} (E_{\\phi, i+1/2, j+1/2}^{n} - E_{\\phi, i+1/2, j-1/2}^{n}) $$\n\nThe update for $B_z$, discretized at $(r_i, z_{j+1/2})$:\n$$ \\frac{B_{z, i, j+1/2}^{n+1} - B_{z, i, j+1/2}^{n}}{\\Delta t} = - \\frac{1}{r_i} \\left( \\frac{r_{i+1/2} E_{\\phi, i+1/2, j+1/2}^{n} - r_{i-1/2} E_{\\phi, i-1/2, j+1/2}^{n}}{\\Delta r} \\right) $$\n$$ \\implies B_{z, i, j+1/2}^{n+1} = B_{z, i, j+1/2}^{n} - \\frac{\\Delta t}{r_i \\Delta r} (r_{i+1/2} E_{\\phi, i+1/2, j+1/2}^{n} - r_{i-1/2} E_{\\phi, i-1/2, j+1/2}^{n}) $$\nThese are the metric-aware CT update equations. The geometric metric factors ($r$) are explicitly included.\n\n### Part 3: Conservation of the Discrete Divergence\n\nThe distinguishing feature of the CT method is its ability to preserve the divergence-free condition, $\\nabla \\cdot \\mathbf{B} = 0$, to machine precision. The axisymmetric divergence of $\\mathbf{B}$ is:\n$$ \\nabla \\cdot \\mathbf{B} = \\frac{1}{r} \\frac{\\partial (r B_r)}{\\partial r} + \\frac{\\partial B_z}{\\partial z} $$\nA consistent, face-centered discrete divergence operator at cell center $(i, j)$ is given in the problem statement:\n$$ D_{i,j} = \\frac{1}{r_i \\Delta r} (r_{i+1/2} B_{r, i+1/2, j} - r_{i-1/2} B_{r, i-1/2, j}) + \\frac{1}{\\Delta z} (B_{z, i, j+1/2} - B_{z, i, j-1/2}) $$\nTo prove that the CT updates preserve this discrete divergence, we examine the change in $D_{i,j}$ over one time step, $D_{i,j}^{n+1} - D_{i,j}^{n}$. Let's denote $\\delta B = B^{n+1} - B^n$.\n$$ D_{i,j}^{n+1} - D_{i,j}^{n} = \\frac{1}{r_i \\Delta r} (r_{i+1/2} \\delta B_{r, i+1/2, j} - r_{i-1/2} \\delta B_{r, i-1/2, j}) + \\frac{1}{\\Delta z} (\\delta B_{z, i, j+1/2} - \\delta B_{z, i, j-1/2}) $$\nSubstitute the expressions for $\\delta B$ from the update equations:\n$$ \\delta B_{r, i+1/2, j} = \\frac{\\Delta t}{\\Delta z} (E_{\\phi, i+1/2, j+1/2} - E_{\\phi, i+1/2, j-1/2}) $$\n$$ \\delta B_{z, i, j+1/2} = - \\frac{\\Delta t}{r_i \\Delta r} (r_{i+1/2} E_{\\phi, i+1/2, j+1/2} - r_{i-1/2} E_{\\phi, i-1/2, j+1/2}) $$\nSubstituting these into the change in divergence equation and dividing by $\\Delta t$:\n\\begin{align*}\n\\frac{D_{i,j}^{n+1} - D_{i,j}^{n}}{\\Delta t} = & \\frac{1}{r_i \\Delta r} \\left[ r_{i+1/2} \\frac{E_{\\phi, i+1/2, j+1/2} - E_{\\phi, i+1/2, j-1/2}}{\\Delta z} - r_{i-1/2} \\frac{E_{\\phi, i-1/2, j+1/2} - E_{\\phi, i-1/2, j-1/2}}{\\Delta z} \\right] \\\\\n& + \\frac{1}{\\Delta z} \\left[ - \\frac{1}{r_i \\Delta r} (r_{i+1/2} E_{\\phi, i+1/2, j+1/2} - r_{i-1/2} E_{\\phi, i-1/2, j+1/2}) \\right. \\\\\n& \\left. - \\left( - \\frac{1}{r_i \\Delta r} (r_{i+1/2} E_{\\phi, i+1/2, j-1/2} - r_{i-1/2} E_{\\phi, i-1/2, j-1/2}) \\right) \\right]\n\\end{align*}\nMultiplying the entire equation by $r_i \\Delta r \\Delta z$ simplifies the expression:\n\\begin{align*}\n\\text{Term 1 (from } B_r\\text{): } & (r_{i+1/2} E_{\\phi, i+1/2, j+1/2} - r_{i+1/2} E_{\\phi, i+1/2, j-1/2}) - (r_{i-1/2} E_{\\phi, i-1/2, j+1/2} - r_{i-1/2} E_{\\phi, i-1/2, j-1/2}) \\\\\n\\text{Term 2 (from } B_z\\text{): } & -(r_{i+1/2} E_{\\phi, i+1/2, j+1/2} - r_{i-1/2} E_{\\phi, i-1/2, j+1/2}) + (r_{i+1/2} E_{\\phi, i+1/2, j-1/2} - r_{i-1/2} E_{\\phi, i-1/2, j-1/2})\n\\end{align*}\nAdding these two terms together, we observe that every term cancels out exactly:\n$$ (+r_{i+1/2}E_{\\dots,j+1/2}) + (-r_{i+1/2}E_{\\dots,j+1/2}) = 0 $$\n$$ (-r_{i+1/2}E_{\\dots,j-1/2}) + (+r_{i+1/2}E_{\\dots,j-1/2}) = 0 $$\n$$ (-r_{i-1/2}E_{\\dots,j+1/2}) + (+r_{i-1/2}E_{\\dots,j+1/2}) = 0 $$\n$$ (+r_{i-1/2}E_{\\dots,j-1/2}) + (-r_{i-1/2}E_{\\dots,j-1/2}) = 0 $$\nThe sum is identically zero. This proves that $D_{i,j}^{n+1} - D_{i,j}^{n} = 0$, meaning the discrete divergence is conserved to machine precision at every cell and for every time step. This property holds true even at the axis ($i=0$) provided the update formulas and divergence operator are formulated correctly to handle the coordinate singularity, which they are. The term $r_{i-1/2}$ becomes zero for the cell at the axis, and the $1/r_i$ factor is correctly handled. Specifically, at $r \\to 0$, we have $\\frac{1}{r}\\frac{\\partial(rA)}{\\partial r} \\to 2\\frac{\\partial A}{\\partial r}$ if $A(0)=0$. Our finite difference stencil for the $B_z$ update at $i=0$ correctly approximates this limit.\n\n### Part 4: Implementation Strategy\n\nThe program will implement the derived CT scheme.\n1.  **Grid and Fields**: Set up staggered grid arrays for $B_r$, $B_z$, and $E_\\phi$, paying careful attention to array dimensions corresponding to faces and cell centers.\n2.  **Initial and Boundary Conditions**: Initialize $B_r=0$ and $B_z=B_0$. The axis condition $B_r(r=0)=0$ is enforced. Periodicity in $z$ is handled by ensuring that quantities on the $z=Z$ boundary match those at $z=0$.\n3.  **Time Loop**: For each time step:\n    a.  Calculate the time step $\\Delta t$ from the CFL condition based on the maximum poloidal velocity on the grid.\n    b.  Compute the electric field $E_\\phi = v_z B_r - v_r B_z$ at cell corners. Since $v_z=0$, this simplifies to $E_\\phi = -v_r B_z$. This requires interpolating $B_z$ (defined at $r$-cell centers) to the $r$-faces where $E_\\phi$ is needed. A simple linear average is sufficient. At the axis $r=0$, $v_r=0$, so $E_\\phi(0,z)=0$.\n    c.  Use the derived CT update formulas to advance $B_r$ and $B_z$ in time. Special care is taken for the update on the axis.\n4.  **Divergence Calculation**: After the specified number of steps, compute the discrete divergence $D_{i,j}$ at all cell centers using the metric-aware formula. The formula must be carefully implemented for both the general case ($i>0$) and the special case at the axis ($i=0$).\n5.  **Output**: Report the maximum absolute value of the computed divergence across the grid. For the case of pure rotation ($a=0$), where $E_\\phi=0$, the fields should not evolve, and the initial zero divergence should be preserved to machine precision.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite for the metric-aware constrained transport problem.\n    \"\"\"\n\n    test_cases = [\n        # Case 1 (happy path)\n        {'Nr': 32, 'Nz': 32, 'R': 1.0, 'Z': 1.0, 'B0': 1.0, 'a': 0.5, 'Omega': 3.0, 'C_cfl': 0.4, 'N_steps': 10},\n        # Case 2 (axis proximity and strong shear)\n        {'Nr': 8, 'Nz': 16, 'R': 0.25, 'Z': 1.0, 'B0': 0.7, 'a': 4.0, 'Omega': 10.0, 'C_cfl': 0.2, 'N_steps': 20},\n        # Case 3 (pure rotation, no poloidal flow)\n        {'Nr': 16, 'Nz': 16, 'R': 1.0, 'Z': 1.0, 'B0': 2.0, 'a': 0.0, 'Omega': 5.0, 'C_cfl': 0.4, 'N_steps': 5},\n    ]\n\n    results = []\n    for params in test_cases:\n        result = _solve_case(**params)\n        results.append(result)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef _solve_case(Nr, Nz, R, Z, B0, a, Omega, C_cfl, N_steps):\n    \"\"\"\n    Solves a single instance of the axisymmetric ideal MHD induction problem.\n    \"\"\"\n    # Grid setup\n    dr = R / Nr\n    dz = Z / Nz\n    \n    # r_f: radial face locations. Size Nr+1. r_f[i] is at i*dr.\n    r_f = np.linspace(0.0, R, Nr + 1)\n    # z_f: axial face locations. Size Nz+1. z_f[j] is at j*dz.\n    z_f = np.linspace(0.0, Z, Nz + 1)\n    \n    # r_c: radial cell-center locations. Size Nr. r_c[i] is at (i+0.5)*dr.\n    r_c = (r_f[:-1] + r_f[1:]) / 2.0\n    # z_c: axial cell-center locations. Size Nz. z_c[j] is at (j+0.5)*dz.\n    z_c = (z_f[:-1] + z_f[1:]) / 2.0\n\n    # Field initialization\n    # Br is on radial faces (r_f) and z-cell-centers (z_c)\n    Br = np.zeros((Nr + 1, Nz))\n    # Bz is on r-cell-centers (r_c) and axial faces (z_f)\n    Bz = np.full((Nr, Nz + 1), B0)\n\n    # Main time loop\n    for _ in range(N_steps):\n        # CFL condition\n        # Evaluate vr at cell centers to find max velocity for a stable timestep\n        if a != 0:\n            vr_on_cells = a * r_c[:, None] * np.cos(2.0 * np.pi * z_c[None, :] / Z)\n            v_max = np.max(np.abs(vr_on_cells))\n        else:\n            v_max = 0.0\n        \n        min_dx = min(dr, dz)\n        if v_max > 1e-12: # Avoid division by zero\n            dt = C_cfl * min_dx / v_max\n        else:\n            dt = C_cfl * min_dx\n        \n        # --- Calculate E_phi at corners (r_f, z_f) ---\n        Ephi = np.zeros((Nr + 1, Nz + 1))\n        \n        # E_phi = v_z * B_r - v_r * B_z. With v_z=0, E_phi = -v_r * B_z\n        # E_phi is zero on the axis (r=0) because v_r(r=0)=0. Ephi[0, :] is already 0.\n        \n        # To compute Ephi at (r_f, z_f), we need B_z there.\n        # Bz is at (r_c, z_f). We interpolate Bz from r_c to r_f.\n        # This requires periodic boundaries in z.\n        Bz_padded = np.pad(Bz, ((0,0),(1,1)), 'wrap')\n\n        Bz_on_rf = np.zeros((Nr, Nz + 1))\n        # Linear interpolation for interior r-faces\n        if Nr > 1:\n            Bz_on_rf[:-1, :] = 0.5 * (Bz[:-1, :] + Bz[1:, :])\n        # Extrapolation for outer boundary r-face (r=R)\n        Bz_on_rf[-1, :] = Bz[-1, :]\n\n        # Calculate v_r at corners r_f[1:], z_f\n        vr_corners = a * r_f[1:, None] * np.cos(2.0 * np.pi * z_f[None, :] / Z)\n        \n        # Calculate Ephi for r > 0 from Ohm's Law\n        Ephi[1:, :] = -vr_corners * Bz_on_rf\n\n        # --- Update B fields (Constrained Transport method) ---\n        Br_new = Br.copy()\n        Bz_new = Bz.copy()\n        \n        # Update Br (at r_f[i], z_c[j])\n        # Br[0, :] remains 0 due to axis regularity and Ephi[0,:]=0. We update Br[1:,:].\n        E_z_diff = Ephi[1:, 1:] - Ephi[1:, :-1]\n        # Periodic BC in z for Br update\n        Br_padded = np.pad(Br, ((0,0),(1,1)), 'wrap')\n        Br_new[1:, :] += (dt / dz) * (Ephi[1:, 1:] - Ephi[1:, :-1])\n        \n        # Update Bz (at r_c[i], z_f[j])\n        # For i=0 (axis): a special form derived from limit r->0\n        Bz_new[0, :] -= (2.0 * dt / dr) * Ephi[1, :]\n        \n        # For i > 0 (off-axis)\n        if Nr > 1:\n            rE_r_diff = r_f[2:, None] * Ephi[2:, :] - r_f[1:-1, None] * Ephi[1:-1, :]\n            Bz_new[1:, :] -= (dt / dr) * (1.0 / r_c[1:, None]) * rE_r_diff\n        \n        Br, Bz = Br_new, Bz_new\n    \n    # After loop, compute divergence at cell centers (r_c, z_c)\n    divB = np.zeros((Nr, Nz))\n\n    # r-component of divergence: (1/r) * d/dr (r * Br)\n    # Off-axis part (i > 0)\n    if Nr > 1:\n        rBr_diff = r_f[2:, None] * Br[2:, :] - r_f[1:-1, None] * Br[1:-1, :]\n        divB[1:, :] = (1.0 / (r_c[1:, None] * dr)) * rBr_diff\n    \n    # Axis part (i = 0)\n    # divB_r = 2 * dBr/dr = 2 * (Br_1/2 - Br_-1/2)/dr. At r=0, we only have the Br_1/2 contribution at r=dr/2\n    # A better centered approx is using faces: 2*(Br(dr)-Br(0))/dr. Here we use the face-centered Br field.\n    # divB_r = (1/r_c) * (r_f[1]Br[1] - r_f[0]Br[0])/dr = (1/(dr/2)) * (dr*Br[1] - 0)/dr = 2*Br[1]/(dr/2) is wrong.\n    # It should be 2 * Br[1,:] / r_f[1] but let's stick to the formula in the problem.\n    # D_{0,j} = 1/r_0 * (r_{1/2} Br_{1/2,j} - r_{-1/2} Br_{-1/2,j}) / dr\n    # r_{1/2} -> r_f[1], r_{-1/2} -> r_f[0]=0, Br_{-1/2,j} -> Br[0,j]=0. r_0 -> r_c[0]=dr/2\n    divB[0, :] = (1.0 / (r_c[0] * dr)) * (r_f[1] * Br[1, :])\n\n    # z-component of divergence: d/dz (Bz)\n    divB += (1.0 / dz) * (Bz[:, 1:] - Bz[:, :-1])\n    \n    max_abs_divB = np.max(np.abs(divB))\n    \n    return max_abs_divB\n\nif __name__ == '__main__':\n    solve()\n```", "id": "3539071"}]}