{"hands_on_practices": [{"introduction": "The most direct and efficient way to sample from a probability distribution is the inverse transform method, provided its cumulative distribution function (CDF) can be analytically inverted. The Henyey-Greenstein phase function is a cornerstone of astrophysical radiative transfer, and mastering its sampling is a crucial first step. This exercise [@problem_id:3522939] guides you through the fundamental derivation of its inverse CDF, a result you will use constantly in practical MCRT codes.", "problem": "Consider photon scattering by interstellar dust modeled in radiative transfer using the Henyey–Greenstein phase function, widely employed in computational astrophysics to describe anisotropic scattering. Let $\\mu=\\cos\\theta\\in[-1,1]$ denote the cosine of the scattering angle. The unnormalized probability density function is given by $p(\\mu)\\propto \\dfrac{1-g^{2}}{\\left(1+g^{2}-2g\\mu\\right)^{3/2}}$ for anisotropy parameter $g\\in(-1,1)$. In Monte Carlo (MC) radiative transfer, efficient sampling of $\\mu$ is achieved via inverse transform sampling: draw a uniform deviate $\\xi\\in(0,1)$ and set $\\mu$ equal to the inverse cumulative distribution function (CDF) evaluated at $\\xi$. Starting from the fundamental definitions of a probability density function (PDF), its normalization on the support $[-1,1]$, and the cumulative distribution function $F(\\mu)=\\int_{-1}^{\\mu}p(\\mu')\\,d\\mu'$, derive a closed-form analytic expression for the inverse CDF mapping $\\xi\\mapsto\\mu(\\xi;g)$ that produces samples distributed according to the normalized Henyey–Greenstein law on $\\mu\\in[-1,1]$. Express the final result as a single symbolic expression in terms of $g$ and $\\xi$. No numerical approximation or rounding is required. Do not return an angle $\\theta$; return $\\mu=\\cos\\theta$ as the quantity to be sampled.", "solution": "The user wants to derive the inverse cumulative distribution function (CDF) for the Henyey–Greenstein phase function, which is a standard procedure for Monte Carlo sampling.\n\n### Step 1: Problem Validation\n\n**1.1. Extraction of Givens:**\n-   **Unnormalized PDF:** The probability density function $p(\\mu)$ is proportional to the expression $\\frac{1-g^2}{(1+g^2-2g\\mu)^{3/2}}$.\n-   **Variable and Domain:** The variable is $\\mu = \\cos\\theta$, which lies on the closed interval $[-1, 1]$.\n-   **Parameter and Domain:** The anisotropy parameter $g$ is on the open interval $(-1, 1)$.\n-   **Methodology:** The sampling is to be performed using inverse transform sampling. A uniform deviate $\\xi$ is drawn from the open interval $(0, 1)$.\n-   **Objective:** Derive a closed-form expression for $\\mu(\\xi; g)$ by inverting the CDF, where $F(\\mu) = \\int_{-1}^{\\mu} p(\\mu') \\, d\\mu'$.\n\n**1.2. Validation:**\n-   **Scientific Grounding:** The problem is firmly grounded in computational astrophysics and statistical mechanics. The Henyey–Greenstein phase function is a canonical model for anisotropic scattering in radiative transfer simulations. Inverse transform sampling is a fundamental Monte Carlo technique. All aspects of the problem are scientifically sound.\n-   **Well-Posedness:** The problem is well-posed. It requests the derivation of an analytical formula from first principles. The functions involved are well-behaved over their specified domains. The denominator term $(1+g^2-2g\\mu)$ is strictly positive for $g \\in (-1, 1)$ and $\\mu \\in [-1, 1]$, as it equals $(1-g)^2 > 0$ at $\\mu=1$ and $(1+g)^2 > 0$ at $\\mu=-1$, and is linear in $\\mu$. Thus, the PDF is non-singular and non-negative, ensuring its integral (the CDF) is monotonically increasing, which guarantees the existence of a unique inverse.\n-   **Objectivity:** The problem is stated in precise, objective mathematical language, free from any subjectivity or ambiguity.\n\n**1.3. Verdict:**\nThe problem is valid. It is a standard and non-trivial derivation in computational physics.\n\n### Step 2: Derivation of the Solution\n\nThe derivation proceeds in three main steps: normalization of the probability density function (PDF), calculation of the cumulative distribution function (CDF), and inversion of the CDF.\n\n**2.1. Normalization of the PDF**\n\nLet the unnormalized PDF be $p_{un}(\\mu) = \\frac{1-g^2}{(1+g^2-2g\\mu)^{3/2}}$. The normalized PDF, $p(\\mu)$, must satisfy the condition $\\int_{-1}^{1} p(\\mu) \\, d\\mu = 1$. Let $p(\\mu) = C \\cdot p_{un}(\\mu)$, where $C$ is the normalization constant. We must first compute the integral of $p_{un}(\\mu)$ over its support $[-1, 1]$.\n\n$$\n\\int_{-1}^{1} p_{un}(\\mu) \\, d\\mu = \\int_{-1}^{1} \\frac{1-g^2}{(1+g^2-2g\\mu)^{3/2}} \\, d\\mu\n$$\n\nWe use the substitution $u = 1+g^2-2g\\mu$, which implies $d\\mu = -\\frac{du}{2g}$. The limits of integration change from $\\mu=-1$ to $u=(1+g)^2$ and from $\\mu=1$ to $u=(1-g)^2$.\n\n$$\n\\begin{aligned}\n\\int_{-1}^{1} p_{un}(\\mu) \\, d\\mu &= (1-g^2) \\int_{(1+g)^2}^{(1-g)^2} u^{-3/2} \\left(-\\frac{du}{2g}\\right) \\\\\n&= \\frac{1-g^2}{-2g} \\left[ \\frac{u^{-1/2}}{-1/2} \\right]_{(1+g)^2}^{(1-g)^2} \\\\\n&= \\frac{1-g^2}{g} \\left[ u^{-1/2} \\right]_{(1+g)^2}^{(1-g)^2} \\\\\n&= \\frac{1-g^2}{g} \\left( ((1-g)^2)^{-1/2} - ((1+g)^2)^{-1/2} \\right)\n\\end{aligned}\n$$\n\nSince $g \\in (-1, 1)$, both $1-g$ and $1+g$ are positive. Therefore, $\\sqrt{(1-g)^2} = 1-g$ and $\\sqrt{(1+g)^2} = 1+g$.\n\n$$\n\\begin{aligned}\n\\int_{-1}^{1} p_{un}(\\mu) \\, d\\mu &= \\frac{1-g^2}{g} \\left( \\frac{1}{1-g} - \\frac{1}{1+g} \\right) \\\\\n&= \\frac{(1-g)(1+g)}{g} \\left( \\frac{(1+g) - (1-g)}{(1-g)(1+g)} \\right) \\\\\n&= \\frac{1}{g} (1+g-1+g) = \\frac{2g}{g} = 2\n\\end{aligned}\n$$\n\nThe integral of the given expression is $2$. Therefore, the normalization constant is $C = 1/2$. The correctly normalized PDF is:\n\n$$\np(\\mu) = \\frac{1}{2} \\frac{1-g^2}{(1+g^2-2g\\mu)^{3/2}}\n$$\n\n**2.2. Calculation of the CDF**\n\nThe CDF, $F(\\mu)$, is defined as the integral of the PDF from the lower bound of the support to $\\mu$.\n\n$$\nF(\\mu) = \\int_{-1}^{\\mu} p(\\mu') \\, d\\mu' = \\int_{-1}^{\\mu} \\frac{1}{2} \\frac{1-g^2}{(1+g^2-2g\\mu')^{3/2}} \\, d\\mu'\n$$\n\nWe use the same antiderivative as in the normalization step. For $g \\neq 0$:\n\n$$\n\\begin{aligned}\nF(\\mu) &= \\frac{1-g^2}{2} \\left[ \\frac{1}{g} (1+g^2-2g\\mu')^{-1/2} \\right]_{-1}^{\\mu} \\\\\n&= \\frac{1-g^2}{2g} \\left[ (1+g^2-2g\\mu)^{-1/2} - (1+g^2-2g(-1))^{-1/2} \\right] \\\\\n&= \\frac{1-g^2}{2g} \\left( \\frac{1}{\\sqrt{1+g^2-2g\\mu}} - \\frac{1}{\\sqrt{(1+g)^2}} \\right) \\\\\n&= \\frac{1-g^2}{2g} \\left( \\frac{1}{\\sqrt{1+g^2-2g\\mu}} - \\frac{1}{1+g} \\right)\n\\end{aligned}\n$$\n\nWe can verify that $F(-1)=0$ and $F(1)=1$, confirming the correctness of the CDF.\n\n**2.3. Inversion of the CDF**\n\nTo find the inverse function $\\mu(\\xi) = F^{-1}(\\xi)$, we set $F(\\mu) = \\xi$ and solve for $\\mu$. This is valid for $g \\neq 0$.\n\n$$\n\\xi = \\frac{1-g^2}{2g} \\left( \\frac{1}{\\sqrt{1+g^2-2g\\mu}} - \\frac{1}{1+g} \\right)\n$$\n\nWe rearrange the equation to isolate $\\mu$:\n\n$$\n\\frac{2g\\xi}{1-g^2} = \\frac{1}{\\sqrt{1+g^2-2g\\mu}} - \\frac{1}{1+g}\n$$\n\n$$\n\\frac{1}{\\sqrt{1+g^2-2g\\mu}} = \\frac{2g\\xi}{1-g^2} + \\frac{1}{1+g} = \\frac{2g\\xi + (1-g)}{(1-g)(1+g)} = \\frac{1-g+2g\\xi}{1-g^2}\n$$\n\nInverting both sides gives:\n\n$$\n\\sqrt{1+g^2-2g\\mu} = \\frac{1-g^2}{1-g+2g\\xi}\n$$\n\nSquaring both sides:\n\n$$\n1+g^2-2g\\mu = \\left( \\frac{1-g^2}{1-g+2g\\xi} \\right)^2\n$$\n\nFinally, solving for $\\mu$:\n\n$$\n2g\\mu = 1+g^2 - \\left( \\frac{1-g^2}{1-g+2g\\xi} \\right)^2\n$$\n\n$$\n\\mu(\\xi; g) = \\frac{1}{2g} \\left[ 1+g^2 - \\left( \\frac{1-g^2}{1-g+2g\\xi} \\right)^2 \\right]\n$$\n\nThis expression is the required inverse CDF for $g \\neq 0$. For the special case of $g=0$ (isotropic scattering), the PDF becomes uniform, $p(\\mu)=1/2$, and the CDF is $F(\\mu) = (\\mu+1)/2$. Inverting this gives $\\mu = 2\\xi-1$. The derived general expression for $\\mu(\\xi; g)$ correctly yields this result in the limit $g \\to 0$, as can be verified using L'Hôpital's rule or Taylor expansion. The expression is therefore continuous over the entire domain $g \\in (-1, 1)$. This is the single symbolic expression for the inverse CDF.", "answer": "$$\n\\boxed{\\frac{1}{2g} \\left[ 1+g^{2} - \\left( \\frac{1-g^{2}}{1-g+2g\\xi} \\right)^{2} \\right]}\n$$", "id": "3522939"}, {"introduction": "While powerful, the inverse transform method is not always feasible, as many probability density functions (PDFs) have intractable CDFs. The acceptance-rejection method provides a robust and universally applicable alternative for generating samples from any target distribution. This practice [@problem_id:3523288] challenges you to design and analyze a sampler for a custom anisotropic scattering function, developing skills essential for exploring new physical scattering models.", "problem": "Consider the task in Monte Carlo radiative transfer (MCRT) of sampling a scattering deflection angle with a probability density function (PDF) proportional to $1+\\alpha \\cos^{2}\\theta$ for $\\theta \\in [0,\\pi]$, where $\\alpha \\in [0,1]$ controls the anisotropy. Define $\\mu \\equiv \\cos \\theta$, so that $\\mu \\in [-1,1]$, and interpret the target density over $\\mu$ as proportional to $1+\\alpha \\mu^{2}$. The goal is to use acceptance-rejection sampling with an envelope that is uniform in $\\mu$ to construct a sampler for $\\theta$ in radians and to characterize the acceptance rate as a function of $\\alpha$.\n\nStarting from fundamental definitions of probability density functions and the acceptance-rejection method, do the following:\n\n1. Derive the normalization constant $Z(\\alpha)$ of the target density $f(\\mu) \\propto 1+\\alpha \\mu^{2}$ on $\\mu \\in [-1,1]$ with respect to the Lebesgue measure $d\\mu$. Express the normalized target $f(\\mu)$ in closed form.\n\n2. Using an envelope density $g(\\mu)$ that is uniform on $\\mu \\in [-1,1]$, i.e., $g(\\mu)=\\frac{1}{2}$, find the minimal envelope scale $M(\\alpha)$ such that $f(\\mu) \\le M(\\alpha)\\,g(\\mu)$ for all $\\mu \\in [-1,1]$. From first principles of acceptance-rejection, derive a closed-form expression for the acceptance rate $R(\\alpha)$ as a function of $\\alpha$.\n\n3. Design an acceptance-rejection sampler that:\n   - Proposes $\\mu$ from $g(\\mu)$,\n   - Accepts with probability $a(\\mu,\\alpha)$ derived from your $M(\\alpha)$,\n   - Returns the angle $\\theta = \\arccos(\\mu)$ in radians.\n   Your implementation must be valid for all $\\alpha \\in [0,1]$.\n\n4. Test suite and output specification:\n   - For the parameter values $\\alpha \\in \\{0, 0.25, 0.5, 1\\}$, compute the analytic acceptance rate $R(\\alpha)$ you derived.\n   - Your program must output a single line containing these four results as a comma-separated list enclosed in square brackets, in the order of the given $\\alpha$ values. Each value must be rounded to $6$ decimal places.\n   - The final output format must be exactly: \"[r0,r1,r2,r3]\" where each $r_k$ is a float with $6$ decimal places. Angles used internally in the sampler must be in radians, but the program’s required output is the list of acceptance rates, which are dimensionless.\n\nScientific and numerical requirements:\n- All angles are in radians.\n- The acceptance-rejection framework must be formulated in terms of properly normalized PDFs.\n- Ensure that your derivation is consistent with the definitions of PDFs under change of variables from $\\theta$ to $\\mu = \\cos \\theta$.\n- The final program must be self-contained and must not read input.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, for example \"[r0,r1,r2,r3]\".", "solution": "The problem statement has been critically validated and is deemed sound. It is scientifically grounded in the principles of radiative transfer and Monte Carlo methods, is well-posed, and all terms are objectively and precisely defined. The interpretation of the target density for $\\mu \\equiv \\cos\\theta$ as being proportional to $1+\\alpha\\mu^2$ is consistent with sampling from a physical scattering phase function proportional to $1+\\alpha\\cos^2\\theta$ in three dimensions, where the solid angle element $d\\Omega = \\sin\\theta d\\theta d\\phi$ leads to a probability distribution over $\\theta$ proportional to $(1+\\alpha\\cos^2\\theta)\\sin\\theta$. A change of variables to $\\mu$ correctly yields a density for $\\mu$ proportional to $1+\\alpha\\mu^2$. The problem is therefore valid, and we proceed to a full solution.\n\nThe solution is structured into three parts: derivation of the normalized probability density function (PDF), derivation of the acceptance-rejection parameters, and finally, the formulation of the algorithm and computation of the required values.\n\n### 1. Derivation of the Normalized Target PDF\nThe problem specifies a target probability density for the variable $\\mu = \\cos\\theta$ on the interval $\\mu \\in [-1, 1]$ that is proportional to $1+\\alpha\\mu^2$. Let us denote this unnormalized density as $\\tilde{f}(\\mu)$.\n$$\n\\tilde{f}(\\mu) = 1 + \\alpha\\mu^2\n$$\nTo transform this into a true PDF, $f(\\mu)$, we must normalize it by dividing by its integral over the domain. This integral is the normalization constant, $Z(\\alpha)$.\n$$\nZ(\\alpha) = \\int_{-1}^{1} \\tilde{f}(\\mu) \\, d\\mu = \\int_{-1}^{1} (1 + \\alpha\\mu^2) \\, d\\mu\n$$\nThe integration is straightforward:\n$$\nZ(\\alpha) = \\left[ \\mu + \\frac{\\alpha\\mu^3}{3} \\right]_{-1}^{1} = \\left(1 + \\frac{\\alpha(1)^3}{3}\\right) - \\left(-1 + \\frac{\\alpha(-1)^3}{3}\\right) = \\left(1 + \\frac{\\alpha}{3}\\right) - \\left(-1 - \\frac{\\alpha}{3}\\right)\n$$\n$$\nZ(\\alpha) = 1 + \\frac{\\alpha}{3} + 1 + \\frac{\\alpha}{3} = 2 + \\frac{2\\alpha}{3}\n$$\nThe normalized PDF, $f(\\mu)$, is therefore given by:\n$$\nf(\\mu) = \\frac{\\tilde{f}(\\mu)}{Z(\\alpha)} = \\frac{1 + \\alpha\\mu^2}{2 + \\frac{2\\alpha}{3}}\n$$\n\n### 2. Envelope Scale and Acceptance Rate\nThe acceptance-rejection method requires a proposal PDF, $g(\\mu)$, and an envelope scale constant, $M(\\alpha)$, such that $f(\\mu) \\le M(\\alpha)g(\\mu)$ for all $\\mu$ in the domain. The problem specifies a uniform proposal PDF on $\\mu \\in [-1, 1]$.\n$$\ng(\\mu) = \\frac{1}{1 - (-1)} = \\frac{1}{2}\n$$\nThe minimal envelope scale $M(\\alpha)$ is the maximum value of the ratio of the target PDF to the proposal PDF over the domain.\n$$\nM(\\alpha) = \\max_{\\mu \\in [-1, 1]} \\frac{f(\\mu)}{g(\\mu)}\n$$\nSubstituting the expressions for $f(\\mu)$ and $g(\\mu)$:\n$$\n\\frac{f(\\mu)}{g(\\mu)} = \\frac{\\frac{1 + \\alpha\\mu^2}{2 + 2\\alpha/3}}{\\frac{1}{2}} = \\frac{2(1 + \\alpha\\mu^2)}{2(1 + \\alpha/3)} = \\frac{1 + \\alpha\\mu^2}{1 + \\alpha/3} = \\frac{3(1 + \\alpha\\mu^2)}{3 + \\alpha}\n$$\nTo find the maximum of this ratio, we examine its dependence on $\\mu$. Let $h(\\mu) = \\frac{3(1 + \\alpha\\mu^2)}{3 + \\alpha}$. The derivative with respect to $\\mu$ is $h'(\\mu) = \\frac{6\\alpha\\mu}{3 + \\alpha}$. Since $\\alpha \\in [0, 1]$, the term $6\\alpha/(3+\\alpha)$ is non-negative.\n- If $\\alpha=0$, $h(\\mu)$ is constant.\n- If $\\alpha > 0$, $h(\\mu)$ is a parabola in $\\mu$ opening upwards, with its minimum at $\\mu=0$. Therefore, its maximum on the interval $[-1, 1]$ must occur at the boundaries, $\\mu=-1$ or $\\mu=1$.\nBy symmetry ($\\mu^2$), the value is the same at both endpoints. Let's evaluate at $\\mu=1$:\n$$\nM(\\alpha) = \\left. \\frac{3(1 + \\alpha\\mu^2)}{3 + \\alpha} \\right|_{\\mu=1} = \\frac{3(1 + \\alpha)}{3 + \\alpha}\n$$\nIn the acceptance-rejection method, the overall probability of accepting a proposed sample is the inverse of the envelope scale $M(\\alpha)$, provided both $f$ and $g$ are normalized PDFs. This is the acceptance rate, $R(\\alpha)$.\n$$\nR(\\alpha) = \\frac{1}{M(\\alpha)} = \\frac{3 + \\alpha}{3(1 + \\alpha)}\n$$\nThis is the closed-form expression for the acceptance rate as a function of $\\alpha$.\n\n### 3. Sampler Design and Calculation\nThe acceptance-rejection sampler operates as follows:\n1.  Draw a candidate value $\\mu_c$ from the proposal distribution $g(\\mu)$, i.e., sample $\\mu_c$ from a uniform distribution on $[-1, 1]$.\n2.  Draw a random number $u$ from a uniform distribution on $[0, 1]$.\n3.  Accept $\\mu_c$ if the condition $u \\le \\frac{f(\\mu_c)}{M(\\alpha)g(\\mu_c)}$ is met. The acceptance probability for a given $\\mu_c$, $a(\\mu_c, \\alpha)$, simplifies nicely:\n    $$\n    a(\\mu_c, \\alpha) = \\frac{f(\\mu_c)}{M(\\alpha)g(\\mu_c)} = \\frac{1}{M(\\alpha)} \\frac{f(\\mu_c)}{g(\\mu_c)} = \\frac{3 + \\alpha}{3(1 + \\alpha)} \\cdot \\frac{3(1 + \\alpha\\mu_c^2)}{3 + \\alpha} = \\frac{1 + \\alpha\\mu_c^2}{1 + \\alpha}\n    $$\n    So, the condition is $u \\le \\frac{1 + \\alpha\\mu_c^2}{1 + \\alpha}$.\n4.  If the sample is accepted, the final output is the scattering angle $\\theta = \\arccos(\\mu_c)$, in radians. If rejected, the process repeats from step $1$.\n\nThe problem requires calculating the analytical acceptance rate $R(\\alpha)$ for $\\alpha \\in \\{0, 0.25, 0.5, 1\\}$, which will be implemented in the final program.\n$$\nR(\\alpha) = \\frac{3 + \\alpha}{3(1 + \\alpha)}\n$$\n- For $\\alpha=0$: $R(0) = \\frac{3}{3(1)} = 1$.\n- For $\\alpha=0.25$: $R(0.25) = \\frac{3.25}{3(1.25)} = \\frac{3.25}{3.75} = \\frac{13}{15} \\approx 0.866667$.\n- For $\\alpha=0.5$: $R(0.5) = \\frac{3.5}{3(1.5)} = \\frac{3.5}{4.5} = \\frac{7}{9} \\approx 0.777778$.\n- For $\\alpha=1$: $R(1) = \\frac{4}{3(2)} = \\frac{4}{6} = \\frac{2}{3} \\approx 0.666667$.\nThe program will compute these values and format them as requested.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Calculates the analytic acceptance rate for a Monte Carlo sampler\n    based on the problem specification.\n    \"\"\"\n    # Define the test cases for the anisotropy parameter alpha.\n    test_cases = [0.0, 0.25, 0.5, 1.0]\n\n    results = []\n    for alpha in test_cases:\n        # The acceptance rate R(alpha) is derived from first principles as:\n        # R(alpha) = (3 + alpha) / (3 * (1 + alpha))\n        # This formula is valid for all alpha >= 0.\n        acceptance_rate = (3.0 + alpha) / (3.0 * (1.0 + alpha))\n        results.append(acceptance_rate)\n\n    # Format the results into a string with each value rounded to 6 decimal places,\n    # as required by the problem statement.\n    formatted_results = [f\"{r:.6f}\" for r in results]\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "3523288"}, {"introduction": "Generating random numbers according to a physical process is only half the battle; using them to compute accurate physical quantities requires constructing unbiased estimators. This is the domain of importance sampling, where weights must correctly account for any mismatch between the target and proposal distributions. This exercise [@problem_id:3523304] addresses a common but subtle error in handling multi-dimensional phase functions and demonstrates how to derive the corrective weights needed to ensure your simulation yields physically meaningful results.", "problem": "A single-scattering step in a Monte Carlo (MC) radiative transfer simulation is governed by a normalized scattering phase function $p(\\mu,\\phi)$ over the sphere, where $\\mu \\equiv \\cos\\theta \\in [-1,1]$ is the cosine of the polar angle $\\theta$ and $\\phi \\in [0,2\\pi)$ is the azimuth. Normalization means $\\int_{-1}^{1}\\int_{0}^{2\\pi} p(\\mu,\\phi)\\, \\mathrm{d}\\phi\\, \\mathrm{d}\\mu = 1$. Consider estimating the expectation of an arbitrary bounded test function $h(\\mu,\\phi)$ under $p(\\mu,\\phi)$ by importance sampling: sample from a proposal probability density function (PDF) $q(\\mu,\\phi)$ and weight samples by $w(\\mu,\\phi) = p(\\mu,\\phi)/q(\\mu,\\phi)$.\n\nA practitioner uses the following scheme:\n- They factorize the proposal as $q(\\mu,\\phi) = q_{\\mu}(\\mu)\\,q_{\\phi}(\\phi)$ with $q_{\\phi}(\\phi) = \\frac{1}{2\\pi}$ (uniform azimuth).\n- They choose $q_{\\mu}(\\mu)$ equal to the polar marginal of the true phase function, $p_{\\mu}(\\mu) \\equiv \\int_{0}^{2\\pi} p(\\mu,\\phi)\\,\\mathrm{d}\\phi$.\n- They erroneously weight samples only by the polar dependence, effectively taking $w_{\\mathrm{bad}}(\\mu) = \\frac{p_{\\mu}(\\mu)}{q_{\\mu}(\\mu)} = 1$, thereby ignoring any azimuthal anisotropy in $p(\\mu,\\phi)$.\n\nStarting from the definition of an unbiased importance sampling estimator and the normalization of the phase function on the sphere, derive the multiplicative corrective weight factor $w_{\\mathrm{corr}}(\\mu,\\phi)$ that, when applied to the practitioner’s existing weights $w_{\\mathrm{bad}}(\\mu)$, restores unbiasedness for arbitrary $h(\\mu,\\phi)$. Then, for the explicit anisotropic phase function\n$$\np(\\mu,\\phi) = \\frac{1}{4\\pi}\\Big[1 + a\\,\\mu + b\\,\\big(1-\\mu^{2}\\big)\\cos\\big(2\\phi\\big)\\Big],\n$$\nwith constants $a$ and $b$ chosen such that $p(\\mu,\\phi)\\ge 0$ for all $(\\mu,\\phi)$ and $\\int p\\,\\mathrm{d}\\Omega = 1$, compute $w_{\\mathrm{corr}}(\\mu,\\phi)$ in closed form.\n\nProvide your final answer as a single analytical expression for $w_{\\mathrm{corr}}(\\mu,\\phi)$. No numerical rounding is required, and no units are involved.", "solution": "The problem statement is evaluated as scientifically grounded, well-posed, and objective. It is a valid problem in computational astrophysics, specifically concerning Monte Carlo radiative transfer methods.\n\nWe begin by formalizing the concepts of an unbiased estimator and importance sampling in this context. The expectation of an arbitrary bounded test function $h(\\mu,\\phi)$ with respect to the probability density function (PDF) $p(\\mu,\\phi)$ is defined as:\n$$\nE_{p}[h] = \\int_{-1}^{1}\\int_{0}^{2\\pi} h(\\mu,\\phi) p(\\mu,\\phi)\\, \\mathrm{d}\\phi\\, \\mathrm{d}\\mu\n$$\nIn importance sampling, we draw $N$ samples $(\\mu_i, \\phi_i)$ from a proposal PDF $q(\\mu,\\phi)$ instead of $p(\\mu,\\phi)$. The Monte Carlo estimator for $E_{p}[h]$ is then given by:\n$$\n\\hat{E}_{N}[h] = \\frac{1}{N} \\sum_{i=1}^{N} w(\\mu_i, \\phi_i) h(\\mu_i, \\phi_i)\n$$\nwhere $w(\\mu, \\phi)$ are the importance weights. For the estimator to be unbiased, meaning $E_{q}[\\hat{E}_{N}[h]] = E_{p}[h]$, the weights must be defined as the ratio of the target PDF to the proposal PDF:\n$$\nw(\\mu,\\phi) = \\frac{p(\\mu,\\phi)}{q(\\mu,\\phi)}\n$$\nThe practitioner uses a factorized proposal PDF $q(\\mu,\\phi) = q_{\\mu}(\\mu)q_{\\phi}(\\phi)$, with specific choices for the polar and azimuthal components:\n- $q_{\\phi}(\\phi) = \\frac{1}{2\\pi}$ (uniform sampling in azimuth)\n- $q_{\\mu}(\\mu) = p_{\\mu}(\\mu) \\equiv \\int_{0}^{2\\pi} p(\\mu,\\phi)\\,\\mathrm{d}\\phi$ (sampling the polar angle from the true marginal PDF)\n\nThe full proposal PDF is therefore:\n$$\nq(\\mu,\\phi) = p_{\\mu}(\\mu) \\frac{1}{2\\pi} = \\frac{p_{\\mu}(\\mu)}{2\\pi}\n$$\nThe correct importance weight $w(\\mu,\\phi)$ should thus be:\n$$\nw(\\mu,\\phi) = \\frac{p(\\mu,\\phi)}{q(\\mu,\\phi)} = \\frac{p(\\mu,\\phi)}{p_{\\mu}(\\mu)/(2\\pi)} = \\frac{2\\pi p(\\mu,\\phi)}{p_{\\mu}(\\mu)}\n$$\nThe practitioner erroneously uses a weight $w_{\\mathrm{bad}}(\\mu) = 1$. The problem asks for a corrective weight factor $w_{\\mathrm{corr}}(\\mu,\\phi)$ that, when multiplied by the practitioner's weight, yields the correct weight.\n$$\nw_{\\mathrm{bad}}(\\mu) \\cdot w_{\\mathrm{corr}}(\\mu,\\phi) = w(\\mu,\\phi)\n$$\nSubstituting $w_{\\mathrm{bad}}(\\mu) = 1$, we find that the corrective weight is simply the correct weight:\n$$\nw_{\\mathrm{corr}}(\\mu,\\phi) = w(\\mu,\\phi) = \\frac{2\\pi p(\\mu,\\phi)}{p_{\\mu}(\\mu)}\n$$\nThis is the general expression for the corrective weight. It corrects for the erroneous assumption that the azimuthal angle $\\phi$ can be sampled uniformly without a corresponding weight adjustment. The correction factor is the ratio of the true conditional PDF of $\\phi$ given $\\mu$, which is $p(\\phi|\\mu) = p(\\mu,\\phi)/p_{\\mu}(\\mu)$, to the assumed uniform PDF, $q_{\\phi}(\\phi) = 1/(2\\pi)$.\n\nNext, we compute this corrective weight for the specific anisotropic phase function provided:\n$$\np(\\mu,\\phi) = \\frac{1}{4\\pi}\\Big[1 + a\\,\\mu + b\\,\\big(1-\\mu^{2}\\big)\\cos\\big(2\\phi\\big)\\Big]\n$$\nFirst, we must calculate the marginal PDF $p_{\\mu}(\\mu)$ by integrating $p(\\mu,\\phi)$ over the azimuthal angle $\\phi$ from $0$ to $2\\pi$.\n$$\np_{\\mu}(\\mu) = \\int_{0}^{2\\pi} p(\\mu,\\phi)\\,\\mathrm{d}\\phi = \\int_{0}^{2\\pi} \\frac{1}{4\\pi}\\Big[1 + a\\,\\mu + b\\,\\big(1-\\mu^{2}\\big)\\cos\\big(2\\phi\\big)\\Big] \\,\\mathrm{d}\\phi\n$$\nWe can separate the integral into two parts:\n$$\np_{\\mu}(\\mu) = \\frac{1}{4\\pi} \\left( \\int_{0}^{2\\pi} (1 + a\\,\\mu)\\,\\mathrm{d}\\phi + \\int_{0}^{2\\pi} b\\,\\big(1-\\mu^{2}\\big)\\cos\\big(2\\phi\\big)\\,\\mathrm{d}\\phi \\right)\n$$\nThe first integral is:\n$$\n\\int_{0}^{2\\pi} (1 + a\\,\\mu)\\,\\mathrm{d}\\phi = (1 + a\\,\\mu) \\int_{0}^{2\\pi} \\mathrm{d}\\phi = 2\\pi(1 + a\\,\\mu)\n$$\nThe second integral is:\n$$\n\\int_{0}^{2\\pi} b\\,\\big(1-\\mu^{2}\\big)\\cos\\big(2\\phi\\big)\\,\\mathrm{d}\\phi = b\\,\\big(1-\\mu^{2}\\big) \\int_{0}^{2\\pi} \\cos(2\\phi)\\,\\mathrm{d}\\phi = b\\,\\big(1-\\mu^{2}\\big) \\left[\\frac{\\sin(2\\phi)}{2}\\right]_{0}^{2\\pi} = 0\n$$\nSubstituting these results back into the expression for $p_{\\mu}(\\mu)$:\n$$\np_{\\mu}(\\mu) = \\frac{1}{4\\pi} \\left( 2\\pi(1 + a\\,\\mu) + 0 \\right) = \\frac{1}{2}(1 + a\\,\\mu)\n$$\nNow we can compute the final corrective weight $w_{\\mathrm{corr}}(\\mu,\\phi)$ using the formula derived earlier:\n$$\nw_{\\mathrm{corr}}(\\mu,\\phi) = \\frac{2\\pi p(\\mu,\\phi)}{p_{\\mu}(\\mu)} = \\frac{2\\pi \\cdot \\frac{1}{4\\pi}\\Big[1 + a\\,\\mu + b\\,\\big(1-\\mu^{2}\\big)\\cos\\big(2\\phi\\big)\\Big]}{\\frac{1}{2}(1 + a\\,\\mu)}\n$$\nSimplifying the expression:\n$$\nw_{\\mathrm{corr}}(\\mu,\\phi) = \\frac{\\frac{1}{2}\\Big[1 + a\\,\\mu + b\\,\\big(1-\\mu^{2}\\big)\\cos\\big(2\\phi\\big)\\Big]}{\\frac{1}{2}(1 + a\\,\\mu)} = \\frac{1 + a\\,\\mu + b\\,\\big(1-\\mu^{2}\\big)\\cos\\big(2\\phi\\big)}{1 + a\\,\\mu}\n$$\nThis can be written as:\n$$\nw_{\\mathrm{corr}}(\\mu,\\phi) = \\frac{1 + a\\,\\mu}{1 + a\\,\\mu} + \\frac{b\\,\\big(1-\\mu^{2}\\big)\\cos\\big(2\\phi\\big)}{1 + a\\,\\mu} = 1 + \\frac{b\\left(1-\\mu^{2}\\right)\\cos(2\\phi)}{1 + a\\mu}\n$$\nThis is the final closed-form expression for the multiplicative corrective weight factor.", "answer": "$$\n\\boxed{1 + \\frac{b\\left(1 - \\mu^{2}\\right)\\cos(2\\phi)}{1 + a\\mu}}\n$$", "id": "3523304"}]}