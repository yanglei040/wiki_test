{"hands_on_practices": [{"introduction": "In many fluid dynamics applications, such as atmospheric or oceanic modeling, flows are often small perturbations of a background hydrostatic equilibrium. This practice demonstrates the critical importance of a \"well-balanced\" numerical scheme, which is designed to exactly preserve this equilibrium state at the discrete level [@problem_id:3335974]. You will explore how an inconsistent treatment of pressure and gravitational forces in the integral momentum balance can introduce spurious, non-physical momentum, and then implement a fix to ensure the numerical scheme correctly honors the underlying physics.", "problem": "Consider a one-dimensional vertical column of fluid of height $H$ and cross-sectional area $A$, aligned with the vertical coordinate $z$ that increases upward. Let gravity be represented by the body force density $\\rho \\mathbf{g}$ with $\\mathbf{g} = -g(z)\\,\\hat{\\mathbf{z}}$, where $g(z) \\ge 0$ is the gravitational acceleration magnitude, potentially dependent on $z$. Assume no motion ($\\mathbf{u} = \\mathbf{0}$) and consider hydrostatic conditions. The integral form of momentum conservation for a stationary control volume states that the sum of the surface forces and body forces is zero. In this setting, the only surface force is pressure, and the only body force is gravity.\n\nStarting from Newton's second law and the integral form of momentum conservation, derive the discrete residual of the vertical momentum balance for the entire column in terms of pressures at the top and bottom faces and the column-wise integral of the gravitational body force. Then design and implement a finite-volume benchmark that demonstrates how an inconsistent discrete treatment of gravity $\\rho \\mathbf{g}$ in hydrostatic balance causes a nonzero net residual (spurious momentum) in the integral sense, and propose a pressure-based fix that restores exact discrete hydrostatic balance.\n\nYour benchmark must adhere to the following specifications:\n\n- Fundamental base:\n  - Use Newton's second law and the integral form of momentum conservation to reason about the stationary hydrostatic column.\n  - Define $z$-component outward unit normals on the top and bottom faces, and use these to write the $z$-component of the pressure contribution.\n  - Use physically consistent definitions for $\\rho(z)$, $p(z)$, and $g(z)$ in hydrostatic equilibrium.\n- Geometry and discretization:\n  - Use a uniform grid with $N$ control volumes of equal thickness $\\Delta z = H/N$, with cell centers at $z_i = \\left(i + \\tfrac{1}{2}\\right)\\Delta z$ for $i = 0,1,\\dots,N-1$.\n  - Use cross-sectional area $A = 1$ to report forces in Newtons ($\\mathrm{N}$) without additional scaling.\n- Two discrete treatments to be compared:\n  1. A \"naive\" discrete treatment in which the net surface pressure force uses continuous hydrostatic boundary pressures $p_{\\mathrm{top}}$ and $p_{\\mathrm{bot}}$ evaluated from the continuous hydrostatic solution at $z=H$ and $z=0$, while the body force is approximated by the midpoint rule $\\sum_{i=0}^{N-1} \\rho_i\\,g_i\\,\\Delta z$ with $\\rho_i$ and $g_i$ evaluated at cell centers. This produces a discrete residual because the two sides of the hydrostatic balance are evaluated with different quadrature.\n  2. A \"pressure-based fix\" that constructs a discrete hydrostatic face pressure field $\\{p_{i+\\tfrac{1}{2}}\\}$ such that the discrete pressure difference across each cell exactly balances the discrete gravitational body force in that cell, thereby ensuring that the net integral momentum residual across the entire column is identically zero in the discrete sense for hydrostatic data. Use the given top boundary pressure $p_{\\mathrm{top}}$ and a discrete recursion consistent with the gravitational source to compute $p_{\\mathrm{bot}}$; then evaluate the net residual for the whole column using these discrete hydrostatic face pressures.\n- Physics specifications for test cases:\n  - Isothermal ideal gas: For constant temperature $T$, ideal gas constant $R$, and constant $g$, use $\\rho(z) = \\rho_0 \\exp\\!\\left(-\\frac{z}{H_s}\\right)$ and $p(z) = p_0 \\exp\\!\\left(-\\frac{z}{H_s}\\right)$, where $H_s = \\frac{R T}{g}$, $p_0$ is the bottom pressure at $z=0$, and $\\rho_0 = \\frac{p_0}{R T}$.\n  - Isothermal ideal gas with vertically varying gravity $g(z) = g_0\\left(1 - \\alpha z\\right)$ for small $\\alpha$; then $\\ln\\!\\left(\\frac{p(H)}{p(0)}\\right) = -\\frac{1}{R T}\\int_0^H g(z)\\,\\mathrm{d}z$ must be used to provide a physically consistent top boundary pressure $p_{\\mathrm{top}}$ from $p_0$.\n- Units:\n  - All input physical quantities must be in SI units: $H$ in meters ($\\mathrm{m}$), $g$ in meters per second squared ($\\mathrm{m/s^2}$), $R$ in joules per kilogram per kelvin ($\\mathrm{J/(kg\\,K)}$), $T$ in kelvin ($\\mathrm{K}$), $p$ in pascals ($\\mathrm{Pa}$), $\\rho$ in kilograms per cubic meter ($\\mathrm{kg/m^3}$), and forces in Newtons ($\\mathrm{N}$).\n- Numerical tasks to implement:\n  - For each test case, construct the hydrostatic $\\rho_i$ and $p_{\\mathrm{top}}$ appropriate to that case.\n  - Compute the net integral momentum residual $R_{\\mathrm{naive}}$ for the \"naive\" treatment as the difference of the net surface pressure force and the discrete gravitational body force.\n  - Construct the discrete hydrostatic face pressures consistent with the body force quadrature and compute the net residual $R_{\\mathrm{fix}}$.\n  - Report both residuals in Newtons ($\\mathrm{N}$).\n- Test suite:\n  - Case $1$ (happy path): Isothermal ideal gas with constant gravity and moderate resolution.\n    - Parameters: $H = 1000\\,\\mathrm{m}$, $N = 10$, $g = 9.81\\,\\mathrm{m/s^2}$, $T = 300\\,\\mathrm{K}$, $R = 287\\,\\mathrm{J/(kg\\,K)}$, $p_0 = 101325\\,\\mathrm{Pa}$.\n  - Case $2$ (coarse resolution): Same physics as Case $1$ but very coarse grid.\n    - Parameters: $H = 1000\\,\\mathrm{m}$, $N = 2$, $g = 9.81\\,\\mathrm{m/s^2}$, $T = 300\\,\\mathrm{K}$, $R = 287\\,\\mathrm{J/(kg\\,K)}$, $p_0 = 101325\\,\\mathrm{Pa}$.\n  - Case $3$ (extreme coarse edge case): Same physics as Case $1$ but with $N = 1$ cell.\n    - Parameters: $H = 1000\\,\\mathrm{m}$, $N = 1$, $g = 9.81\\,\\mathrm{m/s^2}$, $T = 300\\,\\mathrm{K}$, $R = 287\\,\\mathrm{J/(kg\\,K)}$, $p_0 = 101325\\,\\mathrm{Pa}$.\n  - Case $4$ (variable gravity): Isothermal ideal gas with gravity decreasing linearly with altitude.\n    - Parameters: $H = 2000\\,\\mathrm{m}$, $N = 20$, $g_0 = 9.81\\,\\mathrm{m/s^2}$, $\\alpha = 10^{-5}\\,\\mathrm{m^{-1}}$, $T = 300\\,\\mathrm{K}$, $R = 287\\,\\mathrm{J/(kg\\,K)}$, $p_0 = 101325\\,\\mathrm{Pa}$.\n- Final output format:\n  - Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. For each test case, output a two-element list $[R_{\\mathrm{naive}}, R_{\\mathrm{fix}}]$ in Newtons ($\\mathrm{N}$). Aggregate these per-case lists into a single list. For example, the output should look like $[[r_1^{\\mathrm{naive}}, r_1^{\\mathrm{fix}}],[r_2^{\\mathrm{naive}}, r_2^{\\mathrm{fix}}],\\dots]$ where each $r$ is a floating-point number representing Newtons ($\\mathrm{N}$).", "solution": "The problem requires the derivation and implementation of a numerical benchmark to demonstrate the importance of a \"well-balanced\" discretization for hydrostatic problems in computational fluid dynamics. We must compare a \"naive\" finite-volume discretization, which produces a spurious net force due to inconsistent numerical approximations, against a \"pressure-based fix\" that guarantees discrete hydrostatic balance.\n\n### 1. Continuous Integral Momentum Balance\n\nWe begin with the integral form of the momentum conservation law for a control volume $V$ with surface $S$. For a fluid with density $\\rho$, velocity $\\mathbf{u}$, and pressure $p$, under a body force density $\\mathbf{f}_b$, Newton's second law is:\n$$\n\\frac{d}{dt}\\int_V \\rho \\mathbf{u} \\, dV = \\oint_S (-p \\mathbf{n}) \\, dS + \\int_V \\mathbf{f}_b \\, dV\n$$\nwhere $\\mathbf{n}$ is the outward-pointing unit normal on the surface $S$.\n\nFor the specified one-dimensional vertical column of fluid at rest ($\\mathbf{u} = \\mathbf{0}$) under gravity, the problem is one of hydrostatic equilibrium. The time derivative vanishes. The body force is $\\mathbf{f}_b = \\rho \\mathbf{g}$, where $\\mathbf{g} = -g(z) \\hat{\\mathbf{z}}$. We consider the vertical ($\\hat{\\mathbf{z}}$) component of the momentum equation. The control volume is the entire column, from $z=0$ to $z=H$, with a constant cross-sectional area $A$.\n\nThe surface integral has contributions only from the top face ($S_{\\text{top}}$ at $z=H$) and the bottom face ($S_{\\text{bot}}$ at $z=0$), as contributions from the side walls cancel due to symmetry or have normals orthogonal to $\\hat{\\mathbf{z}}$.\n- On $S_{\\text{top}}$: $\\mathbf{n} = \\hat{\\mathbf{z}}$, so the pressure force component is $\\int_{S_{\\text{top}}} (-p \\hat{\\mathbf{z}}) \\cdot \\hat{\\mathbf{z}} \\, dS = -p(H) A$.\n- On $S_{\\text{bot}}$: $\\mathbf{n} = -\\hat{\\mathbf{z}}$, so the pressure force component is $\\int_{S_{\\text{bot}}} (-p (-\\hat{\\mathbf{z}})) \\cdot \\hat{\\mathbf{z}} \\, dS = p(0) A$.\n\nThe net surface force in the $z$-direction is $F_{S,z} = A(p(0) - p(H))$.\n\nThe total body force in the $z$-direction is the volume integral of the $z$-component of $\\rho \\mathbf{g}$:\n$$\nF_{B,z} = \\int_V (\\rho \\mathbf{g}) \\cdot \\hat{\\mathbf{z}} \\, dV = \\int_0^H \\int_A \\rho(z)(-g(z)) \\, dA \\, dz = -A \\int_0^H \\rho(z) g(z) \\, dz\n$$\nThe integral momentum balance equation is the sum of forces, which must be zero for equilibrium:\n$$\nF_{S,z} + F_{B,z} = 0 \\implies A(p(0) - p(H)) - A \\int_0^H \\rho(z) g(z) \\, dz = 0\n$$\nDividing by $A$ and rearranging gives the familiar hydrostatic relation: $p(0) - p(H) = \\int_0^H \\rho(z) g(z) \\, dz$. The net force, or residual, on the continuous system is identically zero.\n\n### 2. Finite-Volume Discretization\n\nThe column of height $H$ is discretized into $N$ uniform control volumes (cells), indexed $i = 0, 1, \\dots, N-1$. Each cell has thickness $\\Delta z = H/N$. The $i$-th cell occupies the spatial domain $[i\\Delta z, (i+1)\\Delta z]$ and has its center at $z_i = (i + \\frac{1}{2})\\Delta z$. The problem sets the cross-sectional area to $A=1$ for simplicity, so forces are numerically equal to pressure differences or integrated source terms.\n\nThe discrete form of the momentum balance for the entire column is an approximation of the continuous integral form. The net residual, $R_{\\text{discrete}}$, is the sum of the discretized surface and body forces.\n$$\nR_{\\text{discrete}} = F_{S,z}^{\\text{discrete}} + F_{B,z}^{\\text{discrete}}\n$$\n\n### 3. The \"Naive\" Discrete Treatment\n\nThe \"naive\" approach inconsistently mixes continuous and discrete representations.\n- **Surface Force:** The net surface force is evaluated using the exact, continuous hydrostatic pressures at the domain boundaries: $p_{\\text{bot}} = p(0)$ and $p_{\\text{top}} = p(H)$.\n  $$\n  F_{S,z}^{\\text{naive}} = p(0) - p(H) = \\int_0^H \\rho(z) g(z) \\, dz\n  $$\n- **Body Force:** The total body force is approximated by summing the contributions from each cell. The integral over each cell is approximated using the midpoint rule, with density and gravity evaluated at the cell center $z_i$.\n  $$\n  F_{B,z}^{\\text{naive}} = \\sum_{i=0}^{N-1} \\left( -\\int_{i\\Delta z}^{(i+1)\\Delta z} \\rho(z) g(z) \\, dz \\right) \\approx \\sum_{i=0}^{N-1} \\left( - \\rho(z_i)g(z_i) \\Delta z \\right) = - \\sum_{i=0}^{N-1} \\rho_i g_i \\Delta z\n  $$\nThe naive residual, $R_{\\text{naive}}$, is the sum of these two terms:\n$$\nR_{\\text{naive}} = \\left( p(0) - p(H) \\right) - \\sum_{i=0}^{N-1} \\rho_i g_i \\Delta z = \\int_0^H \\rho(z) g(z) \\, dz - \\sum_{i=0}^{N-1} \\rho_i g_i \\Delta z\n$$\nThis residual is precisely the global quadrature error of the midpoint rule for the integral $\\int_0^H \\rho(z) g(z) \\, dz$. Unless $\\rho(z)g(z)$ is a linear function of $z$ (which is not the case for an ideal gas in a gravitational field), this error is non-zero. This non-zero net force is a numerical artifact, or \"spurious momentum,\" that can corrupt a dynamic simulation.\n\n### 4. The \"Pressure-Based Fix\" (Well-Balanced Approach)\n\nThis approach enforces discrete hydrostatic balance at the level of a single control volume. For cell $i$, the pressure force on its faces must exactly balance the discrete body force within it. Let $p_{f,i}$ be the pressure at the face at $z = i\\Delta z$. The balance for cell $i$ is:\n$$\n(p_{f,i} - p_{f,i+1}) - \\rho_i g_i \\Delta z = 0\n$$\nThis establishes a relationship between the discrete pressure gradient and the discrete source term, ensuring they are modeled consistently. This equation can be written as a recursion for the face pressures:\n$$\np_{f,i} = p_{f,i+1} + \\rho_i g_i \\Delta z\n$$\nTo construct the full field of face pressures $\\{p_{f,j}\\}_{j=0}^N$, we start with a boundary condition. Following the problem, we set the pressure at the top face, $p_{f,N}$, to the continuous value $p(H)$. We then recurse downward from $i=N-1$ to $i=0$ to find all face pressures, culminating in the discrete bottom pressure, $p_{f,0}$.\n\nThe net residual for this \"fixed\" scheme, $R_{\\text{fix}}$, is calculated using the boundary pressures derived from this method, $p_{f,0}$ and $p_{f,N}$.\n$$\nR_{\\text{fix}} = (p_{f,0} - p_{f,N}) - \\sum_{i=0}^{N-1} \\rho_i g_i \\Delta z\n$$\nBy summing the per-cell balance equation from $i=0$ to $N-1$, we get a telescoping sum for the pressure term:\n$$\n\\sum_{i=0}^{N-1} (p_{f,i} - p_{f,i+1}) = p_{f,0} - p_{f,N}\n$$\nFrom the per-cell balance, we also have $\\sum_{i=0}^{N-1} (p_{f,i} - p_{f,i+1}) = \\sum_{i=0}^{N-1} \\rho_i g_i \\Delta z$.\nSubstituting this into the expression for $R_{\\text{fix}}$:\n$$\nR_{\\text{fix}} = \\left( \\sum_{i=0}^{N-1} \\rho_i g_i \\Delta z \\right) - \\sum_{i=0}^{N-1} \\rho_i g_i \\Delta z = 0\n$$\nThus, the residual for the pressure-based fix is identically zero (to machine precision) by construction, demonstrating a well-balanced scheme free of spurious momentum in the hydrostatic state.\n\n### 5. Implementation for Test Cases\n\nThe solution is implemented by defining the continuous physics for each case, from which the discrete quantities are derived.\n\n- **Constant Gravity:** For constant $g$, temperature $T$, and gas constant $R$, the scale height is $H_s = RT/g$. The hydrostatic solution for an isothermal ideal gas is $p(z) = p_0 e^{-z/H_s}$ and $\\rho(z) = p(z)/(RT)$.\n- **Variable Gravity:** For $g(z) = g_0(1 - \\alpha z)$, the hydrostatic relation $dp/p = -g(z)/(RT) \\, dz$ integrates to give $p(z) = p_0 \\exp\\left(-\\frac{g_0}{RT}(z - \\frac{\\alpha z^2}{2})\\right)$.\n\nFor each test case, we compute $R_{\\text{naive}}$ and $R_{\\text{fix}}$ following the methodologies described above. The results, particularly for coarse grids ($N=1, 2$), will starkly illustrate the failure of the naive method and the robustness of the well-balanced approach.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef calculate_residuals(params):\n    \"\"\"\n    Calculates the naive and fixed momentum residuals for a given test case.\n    \"\"\"\n    # Extract parameters\n    H = params['H']\n    N = params['N']\n    T = params['T']\n    R = params['R']\n    p0 = params['p0']\n    \n    A = 1.0  # Cross-sectional area is 1 m^2\n    dz = H / N\n\n    # Define cell centers\n    # z_i corresponds to the center of cell i, for i in 0..N-1\n    z_i = (np.arange(N) + 0.5) * dz\n    \n    # Define continuous physics functions based on the case type\n    if params['type'] == 'const_g':\n        g_const = params['g']\n        g_func = lambda z: np.full_like(np.atleast_1d(z), g_const)\n        \n        # Scale height for isothermal atmosphere with constant g\n        Hs = R * T / g_const\n        \n        # Continuous pressure and density profiles\n        p_func = lambda z: p0 * np.exp(-z / Hs)\n        rho_func = lambda z: p_func(z) / (R * T)\n    \n    elif params['type'] == 'var_g':\n        g0 = params['g0']\n        alpha = params['alpha']\n        g_func = lambda z: g0 * (1.0 - alpha * z)\n        \n        # Continuous pressure and density for variable g\n        # Derived from integrating dp/p = -g(z)/(RT) dz\n        exponent_func = lambda z: -(g0 / (R * T)) * (z - 0.5 * alpha * z**2)\n        p_func = lambda z: p0 * np.exp(exponent_func(z))\n        rho_func = lambda z: p_func(z) / (R * T)\n\n    # Evaluate density and gravity at cell centers\n    rho_i = rho_func(z_i)\n    g_i = g_func(z_i)\n\n    # --- 1. Naive Residual Calculation ---\n    \n    # Net surface force from continuous pressure profile at domain boundaries\n    p_top_cont = p_func(H)\n    p_bot_cont = p_func(0.0) # This is p0\n    net_surface_force_naive = A * (p_bot_cont - p_top_cont)\n\n    # Total body force from midpoint rule sum over cells\n    total_body_force_discrete = A * np.sum(rho_i * g_i) * dz\n    \n    # Residual is the sum of forces (surface + body). Body force is negative.\n    # In the problem's terms: difference of surface force and magnitude of body force.\n    R_naive = net_surface_force_naive - total_body_force_discrete\n\n    # --- 2. Pressure-Based Fix Residual Calculation ---\n    \n    # Create an array for face pressures. N+1 faces for N cells.\n    # Face j is at z = j * dz.\n    p_face = np.zeros(N + 1)\n    \n    # Set the top boundary face pressure as the starting point for recursion\n    p_face[N] = p_top_cont\n\n    # Recurse downwards from top to bottom to find all face pressures\n    # p_face[i] = p_face[i+1] + rho_i[i] * g_i[i] * dz\n    for i in range(N - 1, -1, -1):\n        p_face[i] = p_face[i+1] + rho_i[i] * g_i[i] * dz\n        \n    p_bot_fix = p_face[0]\n    p_top_fix = p_face[N]\n\n    # Net surface force using the newly computed consistent boundary pressures\n    net_surface_force_fix = A * (p_bot_fix - p_top_fix)\n    \n    # The discrete body force sum is the same as before\n    # The residual for the fix should be zero by construction\n    R_fix = net_surface_force_fix - total_body_force_discrete\n    \n    return [R_naive, R_fix]\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test suite.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1 (happy path): Isothermal ideal gas with constant gravity\n        {'H': 1000.0, 'N': 10, 'g': 9.81, 'T': 300.0, 'R': 287.0, 'p0': 101325.0, \n         'g0': None, 'alpha': None, 'type': 'const_g'},\n        # Case 2 (coarse resolution): Same as Case 1, coarser grid\n        {'H': 1000.0, 'N': 2, 'g': 9.81, 'T': 300.0, 'R': 287.0, 'p0': 101325.0, \n         'g0': None, 'alpha': None, 'type': 'const_g'},\n        # Case 3 (extreme coarse edge case): N=1 cell\n        {'H': 1000.0, 'N': 1, 'g': 9.81, 'T': 300.0, 'R': 287.0, 'p0': 101325.0, \n         'g0': None, 'alpha': None, 'type': 'const_g'},\n        # Case 4 (variable gravity): Isothermal ideal gas with linearly varying g\n        {'H': 2000.0, 'N': 20, 'g': None, 'T': 300.0, 'R': 287.0, 'p0': 101325.0, \n         'g0': 9.81, 'alpha': 1e-5, 'type': 'var_g'}\n    ]\n\n    results = []\n    for case in test_cases:\n        result = calculate_residuals(case)\n        results.append(result)\n\n    # Format the output string exactly as specified\n    formatted_results = [f\"[{res[0]},{res[1]}]\" for res in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "3335974"}, {"introduction": "Moving from static equilibria to dynamic flows, the challenge becomes discretizing the nonlinear convective terms while rigorously enforcing conservation. This exercise connects the theoretical weak form of the momentum equations to a practical implementation using a Discontinuous Galerkin (DG) method [@problem_id:3336007]. By implementing a conservative numerical flux, you will verify that global momentum is conserved exactly in a periodic domain, a cornerstone property of robust shock-capturing schemes.", "problem": "Consider a compressible, Newtonian fluid with mass density $\\rho$, velocity $\\mathbf{u}$, pressure $p$, Cauchy stress deviator $\\boldsymbol{\\tau}$, and identity tensor $\\mathbf{I}$. The integral momentum balance on a fixed control volume $\\Omega$ with boundary $\\partial \\Omega$ and outward unit normal $\\mathbf{n}$, neglecting body forces, follows from Newton's second law as a conservation law: the time rate of change of total momentum equals the net traction flux through the boundary. Starting from this fundamental base, derive the differential (strong) form by invoking the divergence theorem and appropriate smoothness assumptions, and then the weak Galerkin form by multiplying the strong form by a sufficiently smooth test function $\\boldsymbol{\\phi}$ with compact support and integrating over $\\Omega$, performing integration by parts to move spatial derivatives onto $\\boldsymbol{\\phi}$. Explicitly discuss which boundary terms appear and under what boundary conditions the weak and strong forms are equivalent.\n\nNext, specialize to a one-dimensional inviscid case (set $\\boldsymbol{\\tau}=\\mathbf{0}$ and let $\\mathbf{u}=u\\mathbf{e}_x$) so that the momentum equation for the conserved variable $m=\\rho u$ can be written as a conservation law with a physical flux $f(m,\\rho,p)=\\rho u^2+p$. For numerical discretization, consider the Discontinuous Galerkin (DG) method with piecewise-constant basis functions (polynomial degree $0$, also known as $P0$) on a uniform mesh of $N$ cells covering a one-dimensional domain of length $L$ with constant cell size $\\Delta x=L/N$. Denote by $m_i$ the cell-average of momentum in cell $i$ and by $(\\rho_i,p_i)$ the cell-averaged density and pressure, which you may treat as independent inputs for the purpose of designing and testing conservation.\n\nDesign a single-valued numerical interface flux $F^\\star$ for the inviscid momentum equation that satisfies the two essential properties required for global conservation in DG:\n- Consistency: $F^\\star(U,U)=f(U)$ when the left and right states coincide, where $U$ denotes the set of state variables needed to evaluate the physical flux.\n- Conservation symmetry: the contribution of an interior interface to adjacent cells must be equal and opposite so that, when summing over all cells, interior contributions telescope and only boundary fluxes remain.\n\nA concrete choice that satisfies these properties is the local Lax–Friedrichs (also called Rusanov) flux tailored to the momentum equation. In one space dimension, let $U_L=(\\rho_L,m_L,p_L)$ and $U_R=(\\rho_R,m_R,p_R)$ be the left and right states at an interface, with $u_L=m_L/\\rho_L$, $u_R=m_R/\\rho_R$, and sound speeds $c_L=\\sqrt{\\gamma p_L/\\rho_L}$, $c_R=\\sqrt{\\gamma p_R/\\rho_R}$ for a calorically perfect gas with ratio of specific heats $\\gamma$. Define the maximum characteristic speed $a=\\max\\left(\\lvert u_L\\rvert+c_L,\\lvert u_R\\rvert+c_R\\right)$. The numerical momentum flux is a consistent central average of the physical flux minus a stabilizing term proportional to the jump in momentum:\n$$\nF^\\star(U_L,U_R)=\\tfrac{1}{2}\\left(\\rho_L u_L^2+p_L+\\rho_R u_R^2+p_R\\right)-\\tfrac{1}{2}a\\left(m_R-m_L\\right).\n$$\nImplement a semi-discrete $P0$ DG update with forward Euler time integration,\n$$\nm_i^{n+1}=m_i^n-\\frac{\\Delta t}{\\Delta x}\\left(F^\\star_{i+\\tfrac{1}{2}}-F^\\star_{i-\\tfrac{1}{2}}\\right),\n$$\nwhere $F^\\star_{i+\\tfrac{1}{2}}$ is the numerical momentum flux at the interface between cells $i$ and $i+1$, computed from the left and right states. For periodic boundary conditions, identify cell $0$’s left neighbor with cell $N-1$.\n\nUse dimensionless units throughout. Angles do not appear. Your implementation should verify discrete global momentum conservation properties implied by the strong and weak forms, namely that the sum of cell-averaged momenta only changes due to boundary fluxes:\n$$\n\\sum_{i=0}^{N-1} m_i^{n+1}-\\sum_{i=0}^{N-1} m_i^n=-\\frac{\\Delta t}{\\Delta x}\\left(F^\\star_{\\text{right boundary}}-F^\\star_{\\text{left boundary}}\\right).\n$$\nOn a periodic domain, the right and left boundary are the same interface so the net change is zero.\n\nImplement the program to run the following test suite, each specified by $(N,L,\\Delta t,\\text{steps},\\gamma,\\text{boundary type},\\text{initial fields},\\text{boundary states})$:\n\n- Test $1$ (general periodic, nonuniform “happy path”): $N=50$, $L=1$, $\\Delta t=10^{-3}$, $\\text{steps}=100$, $\\gamma=1.4$, periodic boundaries; initial fields defined by $\\rho(x)=1+0.2\\sin(2\\pi x)$, $u(x)=0.5+0.3\\cos(2\\pi x)$, and $p(x)=1+0.1\\sin(4\\pi x)$. Report a boolean indicating whether the total momentum is preserved to within a tolerance of $10^{-12}$, i.e., whether $\\left\\lvert\\sum_i m_i^{\\text{final}}-\\sum_i m_i^{\\text{initial}}\\right\\rvert\\le 10^{-12}$.\n\n- Test $2$ (uniform periodic state): $N=20$, $L=1$, $\\Delta t=10^{-3}$, $\\text{steps}=50$, $\\gamma=1.4$, periodic boundaries; initial fields $\\rho(x)=1$, $u(x)=1$, $p(x)=1$. Report a boolean with the same $10^{-12}$ tolerance.\n\n- Test $3$ (non-periodic with prescribed open boundary states; single-step discrete balance): $N=40$, $L=1$, $\\Delta t=10^{-3}$, $\\text{steps}=1$, $\\gamma=1.4$, non-periodic boundaries; interior initial fields $\\rho(x)=1+0.1\\cos(2\\pi x)$, $u(x)=0.2+0.1\\sin(2\\pi x)$, $p(x)=1+0.05\\cos(2\\pi x)$; left boundary ghost state $U_L=(\\rho,p,u)=(1.1,1.05,0.3)$ and right boundary ghost state $U_R=(\\rho,p,u)=(0.9,0.95,0.1)$, each converted to $(\\rho,m=\\rho u,p)$ when computing $F^\\star$. Report the absolute float difference between the numerically observed change in total momentum and the theoretically predicted $-\\frac{\\Delta t}{\\Delta x}\\left(F^\\star_{\\text{right boundary}}-F^\\star_{\\text{left boundary}}\\right)$ for that single step.\n\n- Test $4$ (edge case with very few cells, random periodic state): $N=2$, $L=1$, $\\Delta t=10^{-3}$, $\\text{steps}=10$, $\\gamma=1.4$, periodic boundaries; initial fields generated deterministically by $\\rho(x)=1+0.3\\sin(6\\pi x)$, $u(x)=0.4+0.2\\cos(6\\pi x)$, $p(x)=1+0.2\\sin(8\\pi x)$. Report a boolean with the same $10^{-12}$ tolerance.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of Tests $1$ through $4$, for example, $[result_1,result_2,result_3,result_4]$, where $result_1$, $result_2$, and $result_4$ are booleans and $result_3$ is a float in dimensionless units.", "solution": "The problem requires a two-part response: firstly, a theoretical derivation and discussion of various forms of the momentum conservation law in fluid dynamics, and secondly, a numerical implementation to verify discrete conservation for a specific scheme.\n\n### Part 1: Theoretical Derivation and Discussion\n\nWe begin with the fundamental integral form of the momentum conservation law for a compressible, Newtonian fluid in a fixed control volume $\\Omega$ with boundary $\\partial \\Omega$.\n\n**From Integral to Strong Form**\n\nThe momentum balance is a statement of Newton's second law for a continuous medium. For a fixed control volume $\\Omega$, the time rate of change of momentum within the volume plus the net rate at which momentum is convected out through the boundary $\\partial \\Omega$ is equal to the sum of all forces acting on the fluid within the volume. Neglecting body forces, the only forces are surface forces (pressure and viscous stresses). The integral form is:\n$$\n\\frac{d}{dt}\\int_{\\Omega} \\rho \\mathbf{u} \\,d V + \\oint_{\\partial\\Omega} (\\rho \\mathbf{u}) (\\mathbf{u}\\cdot\\mathbf{n}) \\,dA = \\oint_{\\partial\\Omega} \\boldsymbol{\\sigma} \\cdot \\mathbf{n} \\,dA\n$$\nwhere $\\rho$ is the mass density, $\\mathbf{u}$ is the velocity vector, $\\mathbf{n}$ is the outward unit normal to the boundary, and $\\boldsymbol{\\sigma}$ is the Cauchy stress tensor, given by $\\boldsymbol{\\sigma} = -p\\mathbf{I} + \\boldsymbol{\\tau}$, with $p$ being the pressure, $\\mathbf{I}$ the identity tensor, and $\\boldsymbol{\\tau}$ the deviatoric stress tensor.\n\nThe convective flux term can be rewritten using the tensor product $\\otimes$ as $\\rho \\mathbf{u} (\\mathbf{u}\\cdot\\mathbf{n}) = (\\rho \\mathbf{u} \\otimes \\mathbf{u}) \\cdot \\mathbf{n}$. For a fixed control volume, the time derivative can be moved inside the integral. The equation becomes:\n$$\n\\int_{\\Omega} \\frac{\\partial (\\rho \\mathbf{u})}{\\partial t} \\,d V + \\oint_{\\partial\\Omega} (\\rho \\mathbf{u} \\otimes \\mathbf{u}) \\cdot \\mathbf{n} \\,dA = \\oint_{\\partial\\Omega} \\boldsymbol{\\sigma} \\cdot \\mathbf{n} \\,dA\n$$\nBy invoking the divergence theorem, which states that $\\oint_{\\partial \\Omega} \\mathbf{F} \\cdot \\mathbf{n} \\, dA = \\int_{\\Omega} \\nabla \\cdot \\mathbf{F} \\, dV$ for a sufficiently smooth tensor field $\\mathbf{F}$, we can convert the surface integrals to volume integrals:\n$$\n\\int_{\\Omega} \\frac{\\partial (\\rho \\mathbf{u})}{\\partial t} \\,d V + \\int_{\\Omega} \\nabla \\cdot (\\rho \\mathbf{u} \\otimes \\mathbf{u}) \\,d V = \\int_{\\Omega} \\nabla \\cdot \\boldsymbol{\\sigma} \\,d V\n$$\nCombining the terms under a single integral:\n$$\n\\int_{\\Omega} \\left[ \\frac{\\partial (\\rho \\mathbf{u})}{\\partial t} + \\nabla \\cdot (\\rho \\mathbf{u} \\otimes \\mathbf{u} - \\boldsymbol{\\sigma}) \\right] d V = \\mathbf{0}\n$$\nUnder the assumption of sufficient smoothness of the integrand (e.g., continuity), for this integral to be zero for any arbitrary control volume $\\Omega$, the integrand itself must be zero everywhere. This yields the differential (strong) form of the momentum conservation law:\n$$\n\\frac{\\partial (\\rho \\mathbf{u})}{\\partial t} + \\nabla \\cdot (\\rho \\mathbf{u} \\otimes \\mathbf{u} - \\boldsymbol{\\sigma}) = \\mathbf{0}\n$$\nSubstituting $\\boldsymbol{\\sigma} = -p\\mathbf{I} + \\boldsymbol{\\tau}$, we arrive at the final form:\n$$\n\\frac{\\partial (\\rho \\mathbf{u})}{\\partial t} + \\nabla \\cdot (\\rho \\mathbf{u} \\otimes \\mathbf{u} + p\\mathbf{I} - \\boldsymbol{\\tau}) = \\mathbf{0}\n$$\nThis is a system of conservation laws of the form $\\frac{\\partial \\mathbf{q}}{\\partial t} + \\nabla \\cdot \\mathbf{F} = \\mathbf{0}$, where $\\mathbf{q} = \\rho\\mathbf{u}$ is the vector of conserved momentum components and $\\mathbf{F} = \\rho \\mathbf{u} \\otimes \\mathbf{u} + p\\mathbf{I} - \\boldsymbol{\\tau}$ is the momentum flux tensor.\n\n**Derivation of the Weak Galerkin Form**\n\nThe weak form is derived by multiplying the strong form by a sufficiently smooth vector test function $\\boldsymbol{\\phi}$ (from a suitable function space, e.g., $H^1(\\Omega)$) and integrating over the domain $\\Omega$:\n$$\n\\int_{\\Omega} \\boldsymbol{\\phi} \\cdot \\left[ \\frac{\\partial (\\rho \\mathbf{u})}{\\partial t} + \\nabla \\cdot (\\rho \\mathbf{u} \\otimes \\mathbf{u} + p\\mathbf{I} - \\boldsymbol{\\tau}) \\right] d V = 0\n$$\nWe analyze the terms separately. The time-derivative term, assuming $\\boldsymbol{\\phi}$ is not a function of time, is $\\int_{\\Omega} \\boldsymbol{\\phi} \\cdot \\frac{\\partial(\\rho\\mathbf{u})}{\\partial t} dV = \\frac{d}{dt} \\int_{\\Omega} \\boldsymbol{\\phi} \\cdot (\\rho\\mathbf{u}) dV$. For the flux term, we use integration by parts (a multidimensional version which is a consequence of the divergence theorem). For a vector $\\mathbf{v}$ and a tensor $\\mathbf{F}$, a relevant identity is $\\nabla\\cdot(\\mathbf{F}^T\\mathbf{v}) = (\\nabla\\cdot\\mathbf{F})\\cdot\\mathbf{v} + \\mathbf{F}:\\nabla\\mathbf{v}$. Since the flux tensor $\\mathbf{F} = \\rho \\mathbf{u} \\otimes \\mathbf{u} + p\\mathbf{I} - \\boldsymbol{\\tau}$ is symmetric, $\\mathbf{F}^T=\\mathbf{F}$. Thus:\n$$\n\\int_\\Omega \\boldsymbol{\\phi} \\cdot (\\nabla \\cdot \\mathbf{F}) dV = \\int_\\Omega (\\nabla \\cdot (\\mathbf{F}\\boldsymbol{\\phi})) dV - \\int_\\Omega \\mathbf{F} : \\nabla\\boldsymbol{\\phi} \\, dV\n$$\nApplying the divergence theorem to the first term on the right-hand side gives:\n$$\n\\int_\\Omega \\boldsymbol{\\phi} \\cdot (\\nabla \\cdot \\mathbf{F}) dV = \\oint_{\\partial\\Omega} (\\mathbf{F}\\boldsymbol{\\phi}) \\cdot \\mathbf{n} \\, dA - \\int_\\Omega \\mathbf{F} : \\nabla\\boldsymbol{\\phi} \\, dV = \\oint_{\\partial\\Omega} \\boldsymbol{\\phi} \\cdot (\\mathbf{F} \\cdot \\mathbf{n}) \\, dA - \\int_\\Omega \\mathbf{F} : \\nabla\\boldsymbol{\\phi} \\, dV\n$$\nSubstituting this back into the integrated equation, we obtain the weak Galerkin form:\n$$\n\\frac{d}{dt} \\int_{\\Omega} \\boldsymbol{\\phi} \\cdot (\\rho\\mathbf{u}) \\, dV - \\int_{\\Omega} (\\rho \\mathbf{u} \\otimes \\mathbf{u} + p\\mathbf{I} - \\boldsymbol{\\tau}) : \\nabla\\boldsymbol{\\phi} \\, dV + \\oint_{\\partial\\Omega} \\boldsymbol{\\phi} \\cdot ((\\rho \\mathbf{u} \\otimes \\mathbf{u} + p\\mathbf{I} - \\boldsymbol{\\tau}) \\cdot \\mathbf{n}) \\, dA = 0\n$$\nThis form is \"weak\" because it has transferred the spatial derivatives from the state variables $(\\rho, \\mathbf{u}, p, \\boldsymbol{\\tau})$ to the smooth test function $\\boldsymbol{\\phi}$, thereby lowering the smoothness requirement on the solution itself. This is crucial for handling solutions with discontinuities, such as shock waves.\n\n**Equivalence and Boundary Conditions**\n\nThe boundary integral term, $\\oint_{\\partial\\Omega} \\boldsymbol{\\phi} \\cdot (\\mathbf{F} \\cdot \\mathbf{n}) \\, dA$, is where boundary conditions are naturally applied.\nA solution satisfying the strong form (a \"strong solution\") is by definition smooth enough for all derivatives to exist, and by reversing the integration by parts, it is straightforward to show it also satisfies the weak form.\nEquivalence in the other direction (from weak to strong) is more subtle. If a solution satisfies the weak form for all possible test functions $\\boldsymbol{\\phi}$ in a sufficiently large space, one can argue for a pointwise satisfaction of the strong form. If we specifically choose test functions $\\boldsymbol{\\phi}$ that have compact support within $\\Omega$ (i.e., $\\boldsymbol{\\phi} = \\mathbf{0}$ on $\\partial\\Omega$), the boundary integral vanishes. The weak form becomes:\n$$\n\\frac{d}{dt} \\int_{\\Omega} \\boldsymbol{\\phi} \\cdot (\\rho\\mathbf{u}) \\, dV - \\int_{\\Omega} (\\rho \\mathbf{u} \\otimes \\mathbf{u} + p\\mathbf{I} - \\boldsymbol{\\tau}) : \\nabla\\boldsymbol{\\phi} \\, dV = 0\n$$\nIf the solution is assumed to be smooth, we can integrate by parts in reverse to recover the integral of the strong form's differential operator multiplied by $\\boldsymbol{\\phi}$. By the fundamental lemma of calculus of variations, this implies the operator itself is zero, thus recovering the strong form. Therefore, for smooth solutions and test functions with compact support, the weak and strong forms are equivalent. The weak form, however, is more general as it admits non-smooth solutions.\n\n### Part 2: Numerical Implementation\n\nThe problem specializes to a 1D, inviscid ($\\boldsymbol{\\tau}=\\mathbf{0}$) case. The state vector is $\\mathbf{u} = u\\mathbf{e}_x$. The momentum equation becomes:\n$$\n\\frac{\\partial (\\rho u)}{\\partial t} + \\frac{\\partial (\\rho u^2 + p)}{\\partial x} = 0\n$$\nThis is a conservation law $\\frac{\\partial m}{\\partial t} + \\frac{\\partial f}{\\partial x} = 0$ for the conserved variable $m = \\rho u$ and the physical flux $f = \\rho u^2 + p$.\n\nWe use a Discontinuous Galerkin method with piecewise-constant basis functions ($P0$), which on a uniform grid is equivalent to a finite volume method. We integrate the PDE over a cell $i$, $[x_{i-1/2}, x_{i+1/2}]$ of size $\\Delta x$:\n$$\n\\int_{x_{i-1/2}}^{x_{i+1/2}} \\frac{\\partial m}{\\partial t} dx + \\int_{x_{i-1/2}}^{x_{i+1/2}} \\frac{\\partial f}{\\partial x} dx = 0 \\quad \\implies \\quad \\frac{d}{dt} \\int_{x_{i-1/2}}^{x_{i+1/2}} m \\, dx + \\left[f(x_{i+1/2}) - f(x_{i-1/2})\\right] = 0\n$$\nDefining the cell-average $m_i(t) = \\frac{1}{\\Delta x} \\int_{x_{i-1/2}}^{x_{i+1/2}} m(x,t) dx$, we get $\\Delta x \\frac{dm_i}{dt} + [f(x_{i+1/2}) - f(x_{i-1/2})] = 0$. Since the solution is discontinuous at cell interfaces, we replace the physical flux $f$ with a single-valued numerical flux $F^\\star$ that depends on the states to the left ($U_L$) and right ($U_R$) of the interface. This gives the semi-discrete scheme:\n$$\n\\frac{dm_i}{dt} = -\\frac{1}{\\Delta x} \\left[ F^\\star(U_i, U_{i+1}) - F^\\star(U_{i-1}, U_i) \\right]\n$$\nwhere $F^\\star_{i+1/2} = F^\\star(U_i, U_{i+1})$. Applying a forward Euler time-integration step $\\frac{m_i^{n+1}-m_i^n}{\\Delta t} = \\frac{dm_i}{dt}$ yields the fully-discrete update rule provided.\n\nThe chosen numerical flux is the local Lax-Friedrichs (Rusanov) flux:\n$$\nF^\\star(U_L,U_R)=\\tfrac{1}{2}\\left(f(U_L)+f(U_R)\\right)-\\tfrac{1}{2}a\\left(m_R-m_L\\right)\n$$\nwhere $a=\\max\\left(\\lvert u_L\\rvert+c_L,\\lvert u_R\\rvert+c_R\\right)$ is an estimate of the maximum signal speed. This flux is consistent ($F^\\star(U,U) = f(U)$) and conservative.\n\nFor a periodic domain, the sum of all updates is $\\sum_{i=0}^{N-1} (m_i^{n+1}-m_i^n) = -\\frac{\\Delta t}{\\Delta x} \\sum_{i=0}^{N-1} (F^\\star_{i+1/2}-F^\\star_{i-1/2})$. This is a telescoping sum which, due to periodicity ($F^\\star_{-1/2} = F^\\star_{N-1/2}$), evaluates to zero. Thus, total momentum $\\sum m_i$ is conserved. For non-periodic domains, the sum telescopes to the boundary fluxes: $\\sum_{i=0}^{N-1} (m_i^{n+1}-m_i^n) = -\\frac{\\Delta t}{\\Delta x} (F^\\star_{\\text{right bdy}} - F^\\star_{\\text{left bdy}})$. The implementation will verify these properties. For cell-average initialization, we approximate the integral by the function value at the cell center, a standard second-order-accurate choice for smooth functions.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef rusanov_flux(rho_L, m_L, p_L, rho_R, m_R, p_R, gamma):\n    \"\"\"\n    Computes the Rusanov (local Lax-Friedrichs) numerical flux for the\n    1D inviscid momentum equation.\n    \"\"\"\n    # Left state velocity and flux\n    u_L = m_L / rho_L\n    f_L = rho_L * u_L**2 + p_L\n    \n    # Right state velocity and flux\n    u_R = m_R / rho_R\n    f_R = rho_R * u_R**2 + p_R\n    \n    # Sound speeds\n    c_L = np.sqrt(gamma * p_L / rho_L)\n    c_R = np.sqrt(gamma * p_R / rho_R)\n    \n    # Maximum characteristic speed at the interface\n    a = max(abs(u_L) + c_L, abs(u_R) + c_R)\n    \n    # Rusanov flux\n    flux = 0.5 * (f_L + f_R) - 0.5 * a * (m_R - m_L)\n    \n    return flux\n\ndef run_simulation(N, L, dt, steps, gamma, boundary_type, rho0, m0, p0, ghost_L_state=None, ghost_R_state=None):\n    \"\"\"\n    Runs the DG-P0 simulation and returns the result for the specified test.\n    \"\"\"\n    dx = L / N\n    rho, m, p = rho0.copy(), m0.copy(), p0.copy()\n    \n    initial_total_momentum = np.sum(m)\n\n    for _ in range(steps):\n        m_old = m.copy()\n        \n        # Calculate fluxes at all N interfaces (periodic) or N+1 interfaces (non-periodic)\n        if boundary_type == 'periodic':\n            fluxes = np.zeros(N)\n            for i in range(N):\n                i_L = i\n                i_R = (i + 1) % N\n                fluxes[i] = rusanov_flux(rho[i_L], m[i_L], p[i_L], rho[i_R], m[i_R], p[i_R], gamma)\n            \n            # Update momentum in each cell\n            for i in range(N):\n                flux_L = fluxes[(i - 1 + N) % N]\n                flux_R = fluxes[i]\n                m[i] = m_old[i] - (dt / dx) * (flux_R - flux_L)\n        \n        else: # non-periodic\n            fluxes = np.zeros(N + 1)\n            # Left boundary flux\n            fluxes[0] = rusanov_flux(ghost_L_state[0], ghost_L_state[1], ghost_L_state[2], rho[0], m[0], p[0], gamma)\n            \n            # Interior fluxes\n            for i in range(N - 1):\n                fluxes[i+1] = rusanov_flux(rho[i], m[i], p[i], rho[i+1], m[i+1], p[i+1], gamma)\n            \n            # Right boundary flux\n            fluxes[N] = rusanov_flux(rho[N-1], m[N-1], p[N-1], ghost_R_state[0], ghost_R_state[1], ghost_R_state[2], gamma)\n\n            # Update momentum in each cell\n            for i in range(N):\n                flux_L = fluxes[i]\n                flux_R = fluxes[i+1]\n                m[i] = m_old[i] - (dt / dx) * (flux_R - flux_L)\n\n    # Calculate and return the required metric for the test case\n    if boundary_type == 'periodic':\n        final_total_momentum = np.sum(m)\n        conservation_error = abs(final_total_momentum - initial_total_momentum)\n        return conservation_error <= 1e-12\n    else: # non-periodic for Test 3\n        final_total_momentum = np.sum(m)\n        observed_change = final_total_momentum - initial_total_momentum\n        \n        F_left_bdy = fluxes[0]\n        F_right_bdy = fluxes[N]\n        predicted_change = -(dt / dx) * (F_right_bdy - F_left_bdy)\n        \n        return abs(observed_change - predicted_change)\n\ndef solve():\n    results = []\n\n    # Test 1\n    N, L, dt, steps, gamma = 50, 1.0, 1e-3, 100, 1.4\n    x = (np.arange(N) + 0.5) * (L / N)\n    rho0_1 = 1.0 + 0.2 * np.sin(2 * np.pi * x)\n    u0_1 = 0.5 + 0.3 * np.cos(2 * np.pi * x)\n    p0_1 = 1.0 + 0.1 * np.sin(4 * np.pi * x)\n    m0_1 = rho0_1 * u0_1\n    results.append(run_simulation(N, L, dt, steps, gamma, 'periodic', rho0_1, m0_1, p0_1))\n    \n    # Test 2\n    N, L, dt, steps, gamma = 20, 1.0, 1e-3, 50, 1.4\n    rho0_2 = np.full(N, 1.0)\n    u0_2 = np.full(N, 1.0)\n    p0_2 = np.full(N, 1.0)\n    m0_2 = rho0_2 * u0_2\n    results.append(run_simulation(N, L, dt, steps, gamma, 'periodic', rho0_2, m0_2, p0_2))\n\n    # Test 3\n    N, L, dt, steps, gamma = 40, 1.0, 1e-3, 1, 1.4\n    x = (np.arange(N) + 0.5) * (L / N)\n    rho0_3 = 1.0 + 0.1 * np.cos(2 * np.pi * x)\n    u0_3 = 0.2 + 0.1 * np.sin(2 * np.pi * x)\n    p0_3 = 1.0 + 0.05 * np.cos(2 * np.pi * x)\n    m0_3 = rho0_3 * u0_3\n    \n    ghost_L_pu, ghost_R_pu = (1.1, 1.05, 0.3), (0.9, 0.95, 0.1)\n    ghost_L_state = (ghost_L_pu[0], ghost_L_pu[0] * ghost_L_pu[2], ghost_L_pu[1]) # (rho, m, p)\n    ghost_R_state = (ghost_R_pu[0], ghost_R_pu[0] * ghost_R_pu[2], ghost_R_pu[1]) # (rho, m, p)\n    results.append(run_simulation(N, L, dt, steps, gamma, 'non-periodic', rho0_3, m0_3, p0_3, ghost_L_state, ghost_R_state))\n\n    # Test 4\n    N, L, dt, steps, gamma = 2, 1.0, 1e-3, 10, 1.4\n    x = (np.arange(N) + 0.5) * (L / N)\n    rho0_4 = 1.0 + 0.3 * np.sin(6 * np.pi * x)\n    u0_4 = 0.4 + 0.2 * np.cos(6 * np.pi * x)\n    p0_4 = 1.0 + 0.2 * np.sin(8 * np.pi * x)\n    m0_4 = rho0_4 * u0_4\n    results.append(run_simulation(N, L, dt, steps, gamma, 'periodic', rho0_4, m0_4, p0_4))\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```", "id": "3336007"}, {"introduction": "To efficiently simulate flows with a vast range of scales, from turbulent eddies to large-scale structures, computational fluid dynamics relies on Adaptive Mesh Refinement (AMR). A fundamental requirement for AMR is that the integral conservation laws are strictly enforced across the interfaces between different grid levels [@problem_id:3335976]. This practice challenges you to numerically verify this flux conservation property, demonstrating how the momentum transferred across a coarse face must be perfectly balanced by the sum of fluxes across its refined children.", "problem": "Consider the integral form of momentum conservation in a Newtonian fluid without body forces and with negligible viscous stresses across a smooth interface. The integral momentum balance over a control volume with boundary surface is that the net surface flux of the momentum flux tensor equals the time rate of change of momentum inside the control volume. In steady state with no body forces and no viscous stresses at the interface, the surface integral of the inviscid momentum flux tensor equals zero over a closed surface. The inviscid momentum flux tensor is defined by the second-order tensor $T = \\rho \\mathbf{u} \\otimes \\mathbf{u} + p \\mathbf{I}$, where $\\rho$ is the mass density, $\\mathbf{u}$ is the velocity vector, $p$ is the pressure, $\\otimes$ denotes the outer product, and $\\mathbf{I}$ is the identity tensor. For a given oriented surface element with unit normal $\\mathbf{n}$, the flux vector of momentum is $T \\cdot \\mathbf{n}$, and its integral over an open face is the force transmitted across the face, in Newtons (N). In the context of Adaptive Mesh Refinement (AMR), one demands conservative prolongation and restriction so that the face-integrated flux on a coarse face equals the sum of face-integrated fluxes on its refined children across a coarse–fine interface. Formally, if a coarse face of length $H$ is subdivided into $r$ equal fine faces, conservation requires\n$$\n\\int_{0}^{H} \\left(T \\cdot \\mathbf{n}\\right)\\, \\mathrm{d}A \\;=\\; \\sum_{i=1}^{r} \\int_{A_i} \\left(T \\cdot \\mathbf{n}\\right)\\, \\mathrm{d}A,\n$$\nwhere $A_i$ are the non-overlapping fine subfaces that tile the coarse face.\n\nYour task is to write a complete, runnable program that verifies this conservation property numerically for specified analytic fields under two prolongation/restriction strategies: a conservative strategy that computes fine subface fluxes by accurate quadrature and a non-conservative strategy that approximates fine subface fluxes by midpoint sampling. The interface is vertical, located at $x = x_0$, with unit depth in the out-of-plane direction so that the face area equals the face length. The face spans $y \\in [0, H]$, and its unit normal is $\\mathbf{n} = (1, 0)$. The inviscid flux vector through this face is\n$$\n\\left(T \\cdot \\mathbf{n}\\right)(x_0,y) \\;=\\; \\begin{bmatrix} \\rho(x_0,y)\\, u_x(x_0,y)^2 + p(x_0,y) \\\\ \\rho(x_0,y)\\, u_x(x_0,y)\\, u_y(x_0,y) \\end{bmatrix},\n$$\nwith units of Newtons per square meter (Pascal) times area to give Newtons for the face-integrated flux. You must compute the face-integrated flux vector on the coarse face and compare it with the sum of the fine face-integrated flux vectors obtained by either conservative or non-conservative strategy. The conservative strategy must use sufficiently accurate Gaussian quadrature so that the integral of any polynomial integrand up to total degree $5$ in $y$ is computed exactly on each subface. The non-conservative strategy must approximate each fine subface flux by the midpoint rule (one sample at the subface center times the subface length). All fields must use International System of Units (SI): $\\rho$ in kilograms per cubic meter (kg/m$^3$), velocity in meters per second (m/s), pressure in Pascals (Pa), face lengths in meters (m), and the integrated flux in Newtons (N). The program should not output flux values; it should output booleans indicating whether the conservative balance criterion is met to within a specified absolute tolerance.\n\nImplement the following analytic fields, which are polynomials in $x$ and $y$:\n- Density: $\\rho(x,y) = \\rho_0 + a_x x + a_y y$.\n- Velocity components: $u_x(x,y) = \\alpha_0 + \\alpha_1 y + \\alpha_2 y^2$ and $u_y(x,y) = \\beta_0 + \\beta_x x + \\beta_y y$.\n- Pressure: $p(x,y) = p_0 + p_x x + p_y y$.\n\nDefine the coarse face as the vertical line $x = x_0$ over $y \\in [0,H]$, and its subdivision into $r$ equal fine faces with subface intervals $[y_{i-1}, y_i]$ where $y_i = i H / r$ for $i \\in \\{0,1,\\ldots,r\\}$. For the coarse face, compute the integrated flux vector by Gaussian quadrature with at least $n_q = 5$ points over the full interval $[0,H]$. For the conservative strategy on the fine faces, compute each fine subface integral with the same $n_q = 5$ Gaussian quadrature points and sum the resulting vectors. For the non-conservative strategy, approximate each fine subface integral by the midpoint rule on the subinterval (one evaluation multiplied by subinterval length). Define the absolute tolerance $\\varepsilon = 10^{-10}$ Newtons. For each test case, return a boolean that is true if and only if both components (the $x$-momentum and $y$-momentum flux components) of the difference between the coarse integral and the sum of fine integrals have absolute value less than or equal to $\\varepsilon$.\n\nTest Suite. Your program must run the following test cases and aggregate the boolean results:\n- Test $1$ (happy path, conservative, cubic integrand present): parameters $H = 1$, $x_0 = 0.5$, $r = 2$, $\\rho_0 = 1$, $a_x = 0.2$, $a_y = 0.1$, $\\alpha_0 = 2$, $\\alpha_1 = 0.5$, $\\alpha_2 = 0$, $\\beta_0 = -1$, $\\beta_x = 0.3$, $\\beta_y = 0$, $p_0 = 100000$, $p_x = 1000$, $p_y = -500$, with conservative fine-face integration. This test should return true.\n- Test $2$ (edge case, non-conservative midpoint, refinement ratio not a power of two): same parameters as Test $1$ except $r = 3$ and using midpoint fine-face integration. This test should return false because the composite midpoint rule will not exactly integrate the cubic integrand, leading to a detectable imbalance above $\\varepsilon$.\n- Test $3$ (coverage with higher-order variation, conservative): parameters $H = 1$, $x_0 = 0.25$, $r = 4$, $\\rho_0 = 1$, $a_x = 0.1$, $a_y = -0.2$, $\\alpha_0 = 1.5$, $\\alpha_1 = 0.4$, $\\alpha_2 = 0.2$, $\\beta_0 = 0.2$, $\\beta_x = -0.1$, $\\beta_y = 0.05$, $p_0 = 101325$, $p_x = 800$, $p_y = 400$, with conservative fine-face integration. This test should return true.\n\nYour program should compute, for each test, whether the coarse face-integrated momentum flux equals the sum of fine face-integrated momentum fluxes within the tolerance $\\varepsilon$ using the specified strategy. The final output format must be a single line containing the list of boolean results in order for Tests $1$, $2$, and $3$, formatted as a comma-separated list enclosed in square brackets (for example, \"[True,False,True]\"). No other output is permitted.", "solution": "The problem requires the numerical verification of a conservation property for the inviscid momentum flux, a principle central to finite volume methods in computational fluid dynamics, particularly in the context of Adaptive Mesh Refinement (AMR). The core task is to compare the integrated momentum flux over a coarse face with the sum of integrated fluxes over its child fine faces.\n\nThe inviscid momentum flux tensor is given by $T = \\rho \\mathbf{u} \\otimes \\mathbf{u} + p \\mathbf{I}$. For a vertical face at $x=x_0$ with unit normal vector $\\mathbf{n} = [1, 0]^T$, the momentum flux vector is $F(y) = T \\cdot \\mathbf{n}$. Its components are:\n$$\nF(y) = \\begin{bmatrix} F_x(y) \\\\ F_y(y) \\end{bmatrix} = \\begin{bmatrix} \\rho(x_0,y)\\, u_x(x_0,y)^2 + p(x_0,y) \\\\ \\rho(x_0,y)\\, u_x(x_0,y)\\, u_y(x_0,y) \\end{bmatrix}\n$$\nThe problem specifies the fluid properties as polynomial functions of the spatial coordinates $x$ and $y$. At the fixed face location $x=x_0$, these become\n- Density: $\\rho(x_0,y) = (\\rho_0 + a_x x_0) + a_y y$, a polynomial of degree $1$ in $y$.\n- x-velocity: $u_x(x_0,y) = \\alpha_0 + \\alpha_1 y + \\alpha_2 y^2$, a polynomial of degree $2$ in $y$.\n- y-velocity: $u_y(x_0,y) = (\\beta_0 + \\beta_x x_0) + \\beta_y y$, a polynomial of degree $1$ in $y$.\n- Pressure: $p(x_0,y) = (p_0 + p_x x_0) + p_y y$, a polynomial of degree $1$ in $y$.\n\nThe total integrated flux over the coarse face, spanning $y \\in [0, H]$, is a vector quantity $\\Phi_{\\text{coarse}} = \\int_0^H F(y) dy$. The sum of fluxes over the $r$ sub-faces is $\\Phi_{\\text{fine}} = \\sum_{i=1}^{r} \\int_{(i-1)H/r}^{iH/r} F(y) dy$. The conservation property states $\\Phi_{\\text{coarse}} = \\Phi_{\\text{fine}}$. We must verify if $|\\Phi_{\\text{coarse}} - \\Phi_{\\text{fine}}| \\le \\varepsilon$ for each component, where $\\varepsilon = 10^{-10}$.\n\nThe degree of the polynomial integrands determines the accuracy of numerical quadrature.\n- The x-momentum flux, $F_x(y) = \\rho(y) u_x(y)^2 + p(y)$, is a polynomial of degree up to $\\text{deg}(\\rho) + 2 \\times \\text{deg}(u_x) = 1 + 2 \\times 2 = 5$.\n- The y-momentum flux, $F_y(y) = \\rho(y) u_x(y) u_y(y)$, is a polynomial of degree up to $\\text{deg}(\\rho) + \\text{deg}(u_x) + \\text{deg}(u_y) = 1 + 2 + 1 = 4$.\n\nTwo numerical strategies are tested.\n\n1.  **Conservative Strategy:** This strategy employs Gaussian-Legendre quadrature. A Gaussian quadrature rule with $n_q$ points integrates any polynomial of degree up to $2n_q - 1$ exactly. The problem specifies using at least $n_q=5$ points. For $n_q=5$, the rule is exact for polynomials of degree up to $2 \\times 5 - 1 = 9$. Since the highest degree of our integrands is $5$, the $5$-point Gaussian quadrature will compute the integrals exactly (to within machine precision). Due to the linearity of integration, $\\int_0^H F(y) dy = \\sum_{i=1}^{r} \\int_{y_{i-1}}^{y_i} F(y) dy$. As the numerical method is exact for all integrals involved, the computed coarse flux will equal the sum of computed fine fluxes. This is why Tests $1$ and $3$, which use this strategy, are expected to pass.\n\n2.  **Non-Conservative Strategy:** This strategy uses the midpoint rule, which approximates an integral by the value of the integrand at the midpoint of the interval multiplied by the interval's length: $\\int_a^b f(y) dy \\approx f((a+b)/2) \\times (b-a)$. The midpoint rule is a $1$-point Newton-Cotes formula and is exact only for polynomials of degree up to $1$. In Test $2$, the integrand for the x-momentum flux, $F_x(y)$, is a polynomial of degree $3$ (since $\\alpha_2=0$, $\\text{deg}(u_x)=1$, so $\\text{deg}(F_x) = 1 + 2\\times 1 = 3$), and for the y-momentum flux, $F_y(y)$, it is a polynomial of degree $2$. The midpoint rule will incur a significant error when integrating these higher-degree polynomials. Therefore, the sum of the approximate fluxes on the fine faces will not equal the \"exact\" flux on the coarse face (computed with high-order quadrature), and the difference will exceed the tolerance $\\varepsilon$. Test $2$ is thus expected to fail.\n\nThe implementation follows these principles. A Python program is constructed to:\n- Define the field and flux functions based on the provided polynomial forms.\n- Implement a Gaussian quadrature routine using points and weights from `numpy.polynomial.legendre.leggauss` for a given number of points, $n_q=5$. This routine correctly maps the standard $[-1, 1]$ interval to the arbitrary integration domain $[a,b]$.\n- Iterate through each test case, setting up the specific parameters.\n- For each test case, compute the coarse-face flux using the Gaussian quadrature routine.\n- Compute the sum of fine-face fluxes using either the conservative (Gaussian quadrature on each sub-face) or non-conservative (midpoint rule on each sub-face) strategy, as specified.\n- Calculate the absolute difference between the coarse and summed-fine flux vectors and check if both components are within the tolerance $\\varepsilon$.\n- Store the resulting boolean and format the final output as requested.\nThis approach systematically verifies the problem's assertions about numerical conservation.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Verifies the AMR momentum flux conservation property for given analytic fields.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"id\": 1, \"strategy\": \"conservative\", \"H\": 1.0, \"x0\": 0.5, \"r\": 2,\n            \"rho0\": 1.0, \"ax\": 0.2, \"ay\": 0.1,\n            \"alpha0\": 2.0, \"alpha1\": 0.5, \"alpha2\": 0.0,\n            \"beta0\": -1.0, \"beta_x\": 0.3, \"beta_y\": 0.0,\n            \"p0\": 100000.0, \"px\": 1000.0, \"py\": -500.0\n        },\n        {\n            \"id\": 2, \"strategy\": \"midpoint\", \"H\": 1.0, \"x0\": 0.5, \"r\": 3,\n            \"rho0\": 1.0, \"ax\": 0.2, \"ay\": 0.1,\n            \"alpha0\": 2.0, \"alpha1\": 0.5, \"alpha2\": 0.0,\n            \"beta0\": -1.0, \"beta_x\": 0.3, \"beta_y\": 0.0,\n            \"p0\": 100000.0, \"px\": 1000.0, \"py\": -500.0\n        },\n        {\n            \"id\": 3, \"strategy\": \"conservative\", \"H\": 1.0, \"x0\": 0.25, \"r\": 4,\n            \"rho0\": 1.0, \"ax\": 0.1, \"ay\": -0.2,\n            \"alpha0\": 1.5, \"alpha1\": 0.4, \"alpha2\": 0.2,\n            \"beta0\": 0.2, \"beta_x\": -0.1, \"beta_y\": 0.05,\n            \"p0\": 101325.0, \"px\": 800.0, \"py\": 400.0\n        }\n    ]\n\n    epsilon = 1.0e-10\n    n_q = 5\n\n    def flux_vector(y, params, x0):\n        \"\"\"\n        Calculates the inviscid momentum flux vector at a given y-coordinate (or array of y-coords).\n        \"\"\"\n        # Evaluate primitive variables at (x0, y)\n        rho_val = params['rho0'] + params['ax'] * x0 + params['ay'] * y\n        ux_val = params['alpha0'] + params['alpha1'] * y + params['alpha2'] * y**2\n        uy_val = params['beta0'] + params['beta_x'] * x0 + params['beta_y'] * y\n        p_val = params['p0'] + params['px'] * x0 + params['py'] * y\n\n        # Calculate flux components\n        flux_x = rho_val * ux_val**2 + p_val\n        flux_y = rho_val * ux_val * uy_val\n\n        return np.array([flux_x, flux_y])\n\n    # Pre-compute\n    xi_gauss, w_gauss = np.polynomial.legendre.leggauss(n_q)\n\n    def integrate_gauss(func, a, b):\n        \"\"\"\n        Performs Gaussian quadrature of a vector-valued function over the interval [a, b].\n        \"\"\"\n        # Transform quadrature points from [-1, 1] to [a, b]\n        y_points = 0.5 * (b - a) * xi_gauss + 0.5 * (a + b)\n        \n        # Evaluate the function at the quadrature points\n        f_values = func(y_points)  # Expected shape (2, n_q)\n        \n        # Compute the integral using matrix-vector product\n        integral = 0.5 * (b - a) * (f_values @ w_gauss)\n        return integral\n\n    results = []\n    for case in test_cases:\n        H = case['H']\n        x0 = case['x0']\n        r = case['r']\n        strategy = case['strategy']\n\n        # Create a closure for the flux function with the current case's parameters\n        def F_y(y):\n            return flux_vector(y, case, x0)\n\n        # 1. Compute coarse face integral\n        coarse_flux = integrate_gauss(F_y, 0.0, H)\n\n        # 2. Compute sum of fine face integrals\n        sum_fine_fluxes = np.zeros(2)\n        dy = H / r\n        if strategy == 'conservative':\n            for i in range(r):\n                y_start = i * dy\n                y_end = (i + 1) * dy\n                sum_fine_fluxes += integrate_gauss(F_y, y_start, y_end)\n        elif strategy == 'midpoint':\n            for i in range(r):\n                y_mid = (i + 0.5) * dy\n                sum_fine_fluxes += F_y(y_mid) * dy\n        \n        # 3. Compare results and check against tolerance\n        diff = coarse_flux - sum_fine_fluxes\n        is_conserved = np.all(np.abs(diff) <= epsilon)\n        results.append(is_conserved)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3335976"}]}