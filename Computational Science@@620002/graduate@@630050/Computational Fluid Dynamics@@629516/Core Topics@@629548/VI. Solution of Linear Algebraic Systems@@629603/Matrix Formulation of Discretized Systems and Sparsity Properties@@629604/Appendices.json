{"hands_on_practices": [{"introduction": "To master the art of computational fluid dynamics, we must first understand how continuous physical laws are translated into discrete algebraic systems. This first practice serves as our foundational exercise, taking the simplest relevant model—the one-dimensional diffusion equation—and guiding you through its discretization. By applying a central difference scheme, you will see firsthand how a local stencil operation gives rise to a globally sparse, tridiagonal matrix, a structure ubiquitous in numerical simulations [@problem_id:3344037]. This exercise is essential for building intuition about the direct link between the physics of a local neighborhood and the resulting matrix properties like bandwidth and sparsity.", "problem": "Consider the one-dimensional steady diffusion model governed by the second-order ordinary differential equation $-u''(x)=f(x)$ on the closed interval $[0,L]$, subject to Dirichlet boundary conditions $u(0)=g_{0}$ and $u(L)=g_{L}$, where $L>0$ is fixed. Let the interval be partitioned into a uniform grid of $N+2$ points with spacing $h=\\frac{L}{N+1}$, and let the $N$ interior grid points be denoted $x_{i}=ih$ for $i=1,2,\\dots,N$. Define the vector of unknowns $\\boldsymbol{u}=\\left(u(x_{1}),u(x_{2}),\\dots,u(x_{N})\\right)^{\\mathsf{T}}$ and the forcing vector $\\boldsymbol{f}=\\left(f(x_{1}),f(x_{2}),\\dots,f(x_{N})\\right)^{\\mathsf{T}}$. Using a second-order central difference approximation for the second derivative $u''(x)$ at each interior point, construct the linear system $A\\boldsymbol{u}=\\boldsymbol{b}$ that discretizes $-u''(x)=f(x)$, making explicit the entries of the matrix $A \\in \\mathbb{R}^{N\\times N}$ in terms of $N$ and $h$ (the right-hand side $\\boldsymbol{b}$ may include boundary contributions but is not the focus of this question). \n\nDefine the lower bandwidth $\\ell$ of an $N\\times N$ matrix $A=\\left(a_{ij}\\right)$ as the smallest nonnegative integer such that $a_{ij}=0$ whenever $j<i-\\ell$, and define the upper bandwidth $u$ as the smallest nonnegative integer such that $a_{ij}=0$ whenever $j>i+u$. The full bandwidth is then $b=\\ell+u+1$. For the matrix $A$ you constructed, compute the full bandwidth $b$ and the exact total number of nonzero entries in $A$ as functions of $N$. Express your final answer as a row matrix using the LaTeX \\texttt{pmatrix} environment with the first entry equal to $b$ and the second entry equal to the total number of nonzeros. No rounding is required and no units should be included in the final answer.", "solution": "The governing ordinary differential equation is $-u''(x) = f(x)$ on the domain $x \\in [0, L]$, with $L>0$. The problem is subject to Dirichlet boundary conditions $u(0) = g_0$ and $u(L) = g_L$. The domain is discretized using a uniform grid with $N+2$ points, defined as $x_i = ih$ for $i = 0, 1, \\dots, N+1$, where the grid spacing is $h = \\frac{L}{N+1}$. The values $u(x_0)=u(0)=g_0$ and $u(x_{N+1})=u(L)=g_L$ are known. The unknowns are the values of the function $u(x)$ at the $N$ interior grid points, $u_i = u(x_i)$ for $i=1, 2, \\dots, N$.\n\nThe second derivative $u''(x)$ is approximated at each interior grid point $x_i$ using a second-order accurate central difference formula:\n$$\nu''(x_i) \\approx \\frac{u(x_i - h) - 2u(x_i) + u(x_i + h)}{h^2} = \\frac{u(x_{i-1}) - 2u(x_i) + u(x_{i+1})}{h^2}\n$$\nSubstituting this approximation into the differential equation $-u''(x_i) = f(x_i)$, we obtain a system of algebraic equations:\n$$\n-\\frac{u_{i+1} - 2u_i + u_{i-1}}{h^2} = f_i\n$$\nwhere $u_i = u(x_i)$ and $f_i = f(x_i)$. This equation is valid for each interior node $i = 1, 2, \\dots, N$. We can rearrange it to group terms involving the unknown values of $u$:\n$$\n\\frac{1}{h^2}(-u_{i-1} + 2u_i - u_{i+1}) = f_i\n$$\nThis set of $N$ equations forms the linear system $A\\boldsymbol{u} = \\boldsymbol{b}$, where $\\boldsymbol{u} = (u_1, u_2, \\dots, u_N)^{\\mathsf{T}}$ is the vector of unknowns. The matrix $A \\in \\mathbb{R}^{N \\times N}$ and the right-hand side vector $\\boldsymbol{b} \\in \\mathbb{R}^N$ are constructed by considering the equations for each index $i$.\n\nFor the first interior point, $i=1$:\n$$\n\\frac{1}{h^2}(-u_0 + 2u_1 - u_2) = f_1\n$$\nSince $u_0 = g_0$ is a known boundary value, this term is moved to the right-hand side:\n$$\n\\frac{1}{h^2}(2u_1 - u_2) = f_1 + \\frac{g_0}{h^2}\n$$\nThis equation defines the first row of the matrix $A$. The coefficients of the unknowns $u_1$ and $u_2$ are $a_{11} = \\frac{2}{h^2}$ and $a_{12} = -\\frac{1}{h^2}$. All other entries in the first row, $a_{1j}$ for $j>2$, are zero.\n\nFor a general interior point, $1 < i < N$:\n$$\n\\frac{1}{h^2}(-u_{i-1} + 2u_i - u_{i+1}) = f_i\n$$\nThis equation defines the $i$-th row of $A$. The non-zero coefficients are $a_{i,i-1} = -\\frac{1}{h^2}$, $a_{ii} = \\frac{2}{h^2}$, and $a_{i,i+1} = -\\frac{1}{h^2}$. All other entries $a_{ij}$ for $|i-j| > 1$ are zero.\n\nFor the last interior point, $i=N$:\n$$\n\\frac{1}{h^2}(-u_{N-1} + 2u_N - u_{N+1}) = f_N\n$$\nSince $u_{N+1} = g_L$ is a known boundary value, this term is moved to the right-hand side:\n$$\n\\frac{1}{h^2}(-u_{N-1} + 2u_N) = f_N + \\frac{g_L}{h^2}\n$$\nThis equation defines the last row of $A$. The coefficients are $a_{N,N-1} = -\\frac{1}{h^2}$ and $a_{NN} = \\frac{2}{h^2}$. All other entries $a_{Nj}$ for $j < N-1$ are zero.\n\nCombining these results, the matrix $A$ is an $N \\times N$ matrix with the following structure:\n$$\nA = \\frac{1}{h^2}\n\\begin{pmatrix}\n2 & -1 & 0 & \\cdots & 0 \\\\\n-1 & 2 & -1 & \\ddots & \\vdots \\\\\n0 & -1 & 2 & \\ddots & 0 \\\\\n\\vdots & \\ddots & \\ddots & \\ddots & -1 \\\\\n0 & \\cdots & 0 & -1 & 2\n\\end{pmatrix}\n$$\nThis is a symmetric tridiagonal matrix. The non-zero entries are located on the main diagonal ($a_{ii}$), the first sub-diagonal ($a_{i,i-1}$), and the first super-diagonal ($a_{i,i+1}$).\n\nNext, we compute the bandwidth.\nThe lower bandwidth $\\ell$ is the smallest non-negative integer such that $a_{ij}=0$ for all $j < i - \\ell$. The non-zero entries below the main diagonal occur only for $j = i-1$. Thus, for any $j < i-1$, we have $a_{ij}=0$. This implies that the condition is satisfied for $\\ell=1$. Since this is the smallest such non-negative integer, we have $\\ell=1$.\n\nThe upper bandwidth $u$ is the smallest non-negative integer such that $a_{ij}=0$ for all $j > i + u$. The non-zero entries above the main diagonal occur only for $j = i+1$. Thus, for any $j > i+1$, we have $a_{ij}=0$. This implies that the condition is satisfied for $u=1$. Since this is the smallest such non-negative integer, we have $u=1$.\n\nThe full bandwidth $b$ is defined as $b = \\ell + u + 1$. Substituting the values we found:\n$$\nb = 1 + 1 + 1 = 3\n$$\n\nFinally, we compute the total number of non-zero entries in $A$.\nThe matrix $A$ has non-zero entries exclusively on three diagonals:\n1. The main diagonal ($a_{ii}$ for $i=1, \\dots, N$) has $N$ non-zero entries.\n2. The first super-diagonal ($a_{i,i+1}$ for $i=1, \\dots, N-1$) has $N-1$ non-zero entries.\n3. The first sub-diagonal ($a_{i,i-1}$ for $i=2, \\dots, N$) has $N-1$ non-zero entries.\n\nThe total number of non-zero entries is the sum of the counts from these three diagonals:\n$$\n\\text{Total non-zeros} = N + (N-1) + (N-1) = 3N - 2\n$$\n\nThe required answer is a row matrix containing the full bandwidth $b$ and the total number of non-zeros.\nThe first entry is $b=3$.\nThe second entry is $3N-2$.", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n3 & 3N-2\n\\end{pmatrix}\n}\n$$", "id": "3344037"}, {"introduction": "Building on the one-dimensional case, we now advance to a more realistic two-dimensional domain. This practice explores the discretization of the Poisson equation using the classic five-point Laplacian stencil, a cornerstone of many CFD simulations [@problem_id:3344091]. The critical challenge introduced here is the mapping of a two-dimensional grid of unknowns into a one-dimensional vector, for which we use lexicographic ordering. You will discover how this choice, combined with the 2D stencil, generates a larger but still highly structured block-tridiagonal matrix, and how the presence of boundaries affects the sparsity pattern on a row-by-row basis.", "problem": "Consider the discrete pressure Poisson equation arising in incompressible Computational Fluid Dynamics (CFD) as a model of elliptic operators: the continuous Partial Differential Equation (PDE) is $-\\nabla^{2} u = f$ on a rectangular domain with Dirichlet boundary conditions. Using a uniform Cartesian mesh and the standard second-order five-point finite difference approximation of the Laplacian, assemble the linear system $A \\mathbf{u} = \\mathbf{b}$ over the interior nodes only. Let the unknowns be indexed as $\\{u_{i,j}\\}$ with $i = 1, 2, \\dots, N_{x}$ and $j = 1, 2, \\dots, N_{y}$, where $N_{x} \\geq 2$ and $N_{y} \\geq 2$ denote the number of interior points in the $x$- and $y$-directions, respectively. Use lexicographic (row-major) ordering that maps $(i,j)$ to a single index $k = i + (j-1) N_{x}$. Assume Dirichlet boundary values are known and have been incorporated into the right-hand side $\\mathbf{b}$, so only interior nodes are in the unknown vector.\n\nStarting from the finite difference stencil connectivity implied by the five-point Laplacian and the interior-only assembly with Dirichlet conditions, derive:\n- a formula for the number of nonzero entries in each matrix row as a function of the node location $(i,j)$ within the interior grid, and classify the possible row nonzero counts by location type (corner, edge-but-not-corner, interior),\n- a closed-form expression for the total number of nonzero entries $\\mathrm{nnz}(A)$ in the matrix $A$.\n\nReport your final answer as a single row matrix containing four entries in the following order: $(\\text{corner row nonzeros}, \\text{edge row nonzeros}, \\text{interior row nonzeros}, \\mathrm{nnz}(A))$. No rounding is required.", "solution": "The five-point finite difference approximation for the negative Laplacian $-\\nabla^2 u$ at an interior grid point $(i,j)$ is given by:\n$$ -\\left( \\frac{u_{i-1,j} - 2u_{i,j} + u_{i+1,j}}{(\\Delta x)^2} + \\frac{u_{i,j-1} - 2u_{i,j} + u_{i,j+1}}{(\\Delta y)^2} \\right) = f_{i,j} $$\nFor simplicity, let's assume a uniform mesh with $\\Delta x = \\Delta y = h$. The equation becomes:\n$$ 4u_{i,j} - u_{i-1,j} - u_{i+1,j} - u_{i,j-1} - u_{i,j+1} = h^2f_{i,j} $$\nThis equation defines the $k$-th row of the linear system $A \\mathbf{u} = \\mathbf{b}$, where $k$ is the single index corresponding to the node $(i,j)$. The non-zero entries in this row of $A$ correspond to the variables that appear on the left-hand side of the equation.\n\nA variable $u_{m,n}$ appears on the LHS if and only if the node $(m,n)$ is an interior node. If a neighbor, e.g., $(i-1,j)$, falls on the boundary, its value $u_{i-1,j}$ is known due to the Dirichlet condition. This known value is moved to the right-hand side, and thus it does not contribute to a non-zero entry in the matrix $A$ (which only multiplies the vector of unknowns $\\mathbf{u}$).\n\nThe number of non-zero entries in the row of $A$ corresponding to node $(i,j)$ is therefore $1$ (for the diagonal term $u_{i,j}$ itself) plus the number of its four neighbors—$(i-1,j)$, $(i+1,j)$, $(i,j-1)$, $(i,j+1)$—that are also interior nodes.\n\nLet's classify the interior nodes $\\{ (i,j) : 1 \\leq i \\leq N_x, 1 \\leq j \\leq N_y \\}$ based on their location.\n\n**1. Number of Non-Zero Entries per Row by Node Location**\n\n*   **Interior-Interior Nodes:** These are nodes $(i,j)$ such that $1 < i < N_x$ and $1 < j < N_y$.\n    For such a node, all four of its neighbors—$(i-1,j)$, $(i+1,j)$, $(i,j-1)$, and $(i,j+1)$—are within the interior grid. The finite difference equation involves $u_{i,j}$ and these four neighboring unknowns.\n    Therefore, the corresponding row in matrix $A$ has $1 + 4 = 5$ non-zero entries.\n\n*   **Edge-but-not-Corner Nodes:** These nodes lie on one of the four edges of the interior grid but are not at a corner.\n    -   $i=1$, $1 < j < N_y$ (left edge): Neighbors are $(0,j)$, $(2,j)$, $(1,j-1)$, $(1,j+1)$. Node $(0,j)$ is on the boundary. The other three neighbors are interior. The equation involves $u_{1,j}$ and three neighboring unknowns. Total non-zeros: $1 + 3 = 4$.\n    -   $i=N_x$, $1 < j < N_y$ (right edge): Similar to the left edge, one neighbor is on the boundary. Total non-zeros: $4$.\n    -   $j=1$, $1 < i < N_x$ (bottom edge): One neighbor is on the boundary. Total non-zeros: $4$.\n    -   $j=N_y$, $1 < i < N_x$ (top edge): One neighbor is on the boundary. Total non-zeros: $4$.\n    In all these cases, a row corresponding to an edge node (not a corner) has **$4$** non-zero entries.\n\n*   **Corner Nodes:** These are the four corners of the interior grid: $(1,1)$, $(N_x,1)$, $(1,N_y)$, and $(N_x,N_y)$. Let's consider $(1,1)$.\n    -   Neighbors of $(1,1)$ are $(0,1)$, $(2,1)$, $(1,0)$, $(1,2)$.\n    -   Nodes $(0,1)$ and $(1,0)$ are on the boundary.\n    -   Nodes $(2,1)$ and $(1,2)$ are interior.\n    -   The equation involves $u_{1,1}$ and two neighboring unknowns. Total non-zeros: $1 + 2 = 3$.\n    By symmetry, all four corner nodes result in rows with **$3$** non-zero entries.\n\n**Summary of non-zeros per row:**\n- Corner row nonzeros: $3$\n- Edge row nonzeros: $4$\n- Interior row nonzeros: $5$\n\n**2. Total Number of Non-Zero Entries, nnz($A$)**\n\nTo find the total number of non-zero entries, we sum the non-zeros from all rows. We do this by counting the number of nodes of each type. The interior grid has dimensions $N_x \\times N_y$. The conditions $N_x \\geq 2$ and $N_y \\geq 2$ are essential.\n\n*   **Number of corner nodes:** There are always $4$ corners: $(1,1)$, $(N_x,1)$, $(1,N_y)$, $(N_x,N_y)$.\n*   **Number of edge-but-not-corner nodes:**\n    -   There are $N_x-2$ such nodes on the bottom edge and $N_x-2$ on the top edge.\n    -   There are $N_y-2$ such nodes on the left edge and $N_y-2$ on the right edge.\n    -   Total: $2(N_x-2) + 2(N_y-2) = 2N_x + 2N_y - 8$.\n*   **Number of interior-interior nodes:** These form a sub-grid of size $(N_x-2) \\times (N_y-2)$.\n    -   Total: $(N_x-2)(N_y-2) = N_xN_y - 2N_x - 2N_y + 4$.\n\nTotal non-zero entries $\\mathrm{nnz}(A)$ is the sum of contributions from each node type:\n$$ \\mathrm{nnz}(A) = (\\text{num corners} \\times 3) + (\\text{num edges} \\times 4) + (\\text{num interiors} \\times 5) $$\n$$ \\mathrm{nnz}(A) = 4 \\times 3 + (2N_x + 2N_y - 8) \\times 4 + (N_xN_y - 2N_x - 2N_y + 4) \\times 5 $$\n$$ \\mathrm{nnz}(A) = 12 + (8N_x + 8N_y - 32) + (5N_xN_y - 10N_x - 10N_y + 20) $$\nNow, collect terms:\n- For $N_xN_y$: $5N_xN_y$\n- For $N_x$: $8N_x - 10N_x = -2N_x$\n- For $N_y$: $8N_y - 10N_y = -2N_y$\n- For the constant term: $12 - 32 + 20 = 0$\nCombining these terms yields the closed-form expression:\n$$ \\mathrm{nnz}(A) = 5N_xN_y - 2N_x - 2N_y $$\n\nAn alternative method is to count the diagonal and off-diagonal entries. The matrix A is of size $(N_xN_y) \\times (N_xN_y)$.\n- **Diagonal entries:** Every row has a non-zero diagonal entry, $A_{k,k}$, corresponding to the term with $u_{i,j}$ itself. There are $N_xN_y$ such entries.\n- **Off-diagonal entries:** An off-diagonal entry $A_{k,l}$ is non-zero if nodes $k$ and $l$ are adjacent interior nodes. Each such adjacency (or \"link\") creates two non-zero entries, $A_{k,l}$ and $A_{l,k}$.\n    - Number of horizontal links: $(N_x-1)$ links in each of the $N_y$ rows. Total: $(N_x-1)N_y$.\n    - Number of vertical links: $(N_y-1)$ links in each of the $N_x$ columns. Total: $N_x(N_y-1)$.\n    - Total links = $(N_x-1)N_y + N_x(N_y-1) = N_xN_y - N_y + N_xN_y - N_x = 2N_xN_y - N_x - N_y$.\n    - Total off-diagonal non-zeros = $2 \\times (\\text{Total links}) = 2(2N_xN_y - N_x - N_y) = 4N_xN_y - 2N_x - 2N_y$.\n- **Total nnz($A$):**\n$$ \\mathrm{nnz}(A) = (\\text{diagonal entries}) + (\\text{off-diagonal entries}) $$\n$$ \\mathrm{nnz}(A) = (N_xN_y) + (4N_xN_y - 2N_x - 2N_y) = 5N_xN_y - 2N_x - 2N_y $$\nBoth methods yield the same result, confirming the expression.\n\nThe final answer is composed of the four required quantities in a row matrix: (corner row nonzeros, edge row nonzeros, interior row nonzeros, $\\mathrm{nnz}(A)$).\nThe values are ($3$, $4$, $5$, $5N_xN_y - 2N_x - 2N_y$).", "answer": "$$ \\boxed{ \\begin{pmatrix} 3 & 4 & 5 & 5 N_x N_y - 2 N_x - 2 N_y \\end{pmatrix} } $$", "id": "3344091"}, {"introduction": "Having analyzed linear elliptic problems, we now tackle the core challenge of fluid dynamics: nonlinearity. This advanced practice focuses on the convective term of the incompressible Navier–Stokes equations, which is responsible for much of the complexity in fluid flow simulations [@problem_id:3344038]. Your task is to perform a Newton linearization of this term, deriving the structure of the resulting Jacobian matrix. This exercise demonstrates how the product rule, applied to the discrete flux and advected quantities, reveals the intricate coupling between different velocity components, leading to a Jacobian with a specific, predictable sparsity pattern that is fundamental to the stability and efficiency of modern implicit CFD solvers.", "problem": "Consider the incompressible Navier–Stokes equations discretized by the finite-volume method on a uniform Cartesian mesh in spatial dimension $d \\in \\mathbb{N}$ with $d \\ge 2$, using collocated storage of all velocity components. Assume constant density $\\rho$ and neglect the pressure and viscous terms; focus exclusively on the convective contribution to the momentum residual. For a control volume centered at cell $P$, let $\\mathcal{F}(P)$ denote the set of its $2d$ faces. For each face $f \\in \\mathcal{F}(P)$ with outward unit normal $\\boldsymbol{n}_f$ and area $A_f$, define the mass flux\n$$\nF_f \\equiv \\rho\\,(\\boldsymbol{u}_f \\cdot \\boldsymbol{n}_f)\\,A_f,\n$$\nwhere the face-centered velocity $\\boldsymbol{u}_f$ is obtained by arithmetic averaging of the two adjacent cell-centered velocities. Discretize the conservative convective term for the $i$-th momentum component by\n$$\nR_i(P) \\equiv \\sum_{f \\in \\mathcal{F}(P)} F_f\\,U_{i,f},\n$$\nwhere $U_{i,f}$ is the arithmetic average of the $i$-th velocity component from the two cells adjacent to face $f$. Consider a Newton linearization of the convective residual $R_i(P)$ with respect to the velocity degrees of freedom, i.e., form the Jacobian entries\n$$\nJ_{(P,i),(Q,j)} \\equiv \\frac{\\partial R_i(P)}{\\partial U_j(Q)},\n$$\nfor any velocity component index $j \\in \\{1,\\dots,d\\}$ and any cell $Q$.\n\nStarting from conservation and the stated finite-volume discretization, derive the structure of $J_{(P,i),(Q,j)}$ by explicitly identifying which neighboring cells $Q$ and components $j$ contribute nonzero entries via the product rule decomposition of variations of $F_f$ and $U_{i,f}$ under a perturbation of $\\boldsymbol{u}$. Restrict attention to an interior cell $P$ (no boundaries) and the stated arithmetic averaging on faces.\n\nYour final task is a calculation: determine a closed-form expression $N_{\\mathrm{nz}}(d)$ for the exact number of nonzero scalar Jacobian entries in the row corresponding to $R_i(P)$ (fixed $i$ and interior $P$), due solely to the convective term described above, as a function of the spatial dimension $d$. Present your answer as a single analytic expression in $d$. No rounding is needed, and no units should be included in the final answer.", "solution": "The problem requires the derivation of the number of nonzero scalar Jacobian entries, $N_{\\mathrm{nz}}(d)$, in a single row of the Jacobian matrix corresponding to the convective term of the incompressible Navier-Stokes equations. The row is associated with the $i$-th momentum component, $R_i(P)$, at an interior cell $P$. The discretization is based on the finite-volume method on a $d$-dimensional uniform Cartesian mesh with collocated variables.\n\nThe Jacobian entries are defined as\n$$\nJ_{(P,i),(Q,j)} \\equiv \\frac{\\partial R_i(P)}{\\partial U_j(Q)}\n$$\nwhere $R_i(P)$ is the convective residual for the $i$-th momentum component in cell $P$, and $U_j(Q)$ is the $j$-th component of the velocity vector at the center of cell $Q$. The indices are $i, j \\in \\{1, \\dots, d\\}$.\n\nThe residual $R_i(P)$ is given by the sum over the $2d$ faces of the control volume $P$:\n$$\nR_i(P) = \\sum_{f \\in \\mathcal{F}(P)} F_f\\,U_{i,f}\n$$\nHere, $F_f$ is the mass flux through face $f$, and $U_{i,f}$ is the value of the $i$-th velocity component at the face center.\n\nApplying the product rule for differentiation with respect to a velocity component $U_j(Q)$:\n$$\nJ_{(P,i),(Q,j)} = \\frac{\\partial R_i(P)}{\\partial U_j(Q)} = \\sum_{f \\in \\mathcal{F}(P)} \\left( \\frac{\\partial F_f}{\\partial U_j(Q)} U_{i,f} + F_f \\frac{\\partial U_{i,f}}{\\partial U_j(Q)} \\right)\n$$\nTo determine which entries are nonzero, we must analyze the dependencies of $F_f$ and $U_{i,f}$ on the cell-centered velocities $U_j(Q)$.\n\nLet a face $f$ be the interface between cell $P$ and a neighboring cell, denoted as $Q_f$. The problem states that face-centered quantities are obtained by arithmetic averaging of the values from the two adjacent cells.\nThe face-centered velocity vector $\\boldsymbol{u}_f$ is:\n$$\n\\boldsymbol{u}_f = \\frac{1}{2}(\\boldsymbol{u}(P) + \\boldsymbol{u}(Q_f))\n$$\nThe mass flux $F_f$ is defined as $F_f = \\rho A_f (\\boldsymbol{u}_f \\cdot \\boldsymbol{n}_f)$, where $A_f$ is the face area and $\\boldsymbol{n}_f$ is the outward unit normal. For a Cartesian mesh, the normal vector $\\boldsymbol{n}_f$ is aligned with one of the coordinate axes. Let this be the $m$-th axis, so $\\boldsymbol{n}_f = \\sigma_f \\boldsymbol{e}_m$, where $\\boldsymbol{e}_m$ is the unit vector in the $m$-th direction and $\\sigma_f = \\pm 1$. The dot product becomes $\\boldsymbol{u}_f \\cdot \\boldsymbol{n}_f = \\sigma_f u_{m,f}$. The mass flux is therefore:\n$$\nF_f = \\rho A_f \\sigma_f u_{m,f} = \\rho A_f \\sigma_f \\frac{1}{2}(U_m(P) + U_m(Q_f))\n$$\nThis shows that $F_f$ depends only on the $m$-th velocity components in cells $P$ and $Q_f$, where $m$ is the direction normal to the face $f$.\n\nThe advected velocity component $U_{i,f}$ is also an arithmetic average:\n$$\nU_{i,f} = \\frac{1}{2}(U_i(P) + U_i(Q_f))\n$$\nThis shows that $U_{i,f}$ depends only on the $i$-th velocity components in cells $P$ and $Q_f$.\n\nA Jacobian entry $J_{(P,i),(Q,j)}$ can be nonzero only if the velocity $U_j(Q)$ influences $R_i(P)$. Based on the averaging formulas, $R_i(P)$ depends on the velocities in cell $P$ and its $2d$ direct face neighbors. Thus, $Q$ must be either $P$ itself or one of its $2d$ face neighbors. We analyze these cases separately.\n\n**Case 1: Diagonal block contribution ($Q=P$)**\nWe evaluate $J_{(P,i),(P,j)} = \\frac{\\partial R_i(P)}{\\partial U_j(P)}$. The sum over the faces of $P$ means that for any velocity component $j \\in \\{1, \\dots, d\\}$, there will be a contribution to the Jacobian entry $J_{(P,i),(P,j)}$. Specifically, the term $\\frac{\\partial F_f}{\\partial U_j(P)}$ is nonzero for faces normal to direction $j$, and the term $\\frac{\\partial U_{i,f}}{\\partial U_j(P)}$ is nonzero for $j=i$. In general, all $d$ entries in this diagonal block are nonzero. This contributes $d$ nonzero entries.\n\n**Case 2: Off-diagonal block contribution ($Q$ is a neighbor of $P$)**\nLet $Q$ be a neighbor of $P$, sharing a single face $f_Q$. For any other face $f \\in \\mathcal{F}(P)$ with $f \\neq f_Q$, the quantities $F_f$ and $U_{i,f}$ do not depend on velocities in $Q$. Therefore, the sum collapses to a single term corresponding to the face $f_Q$:\n$$\nJ_{(P,i),(Q,j)} = \\frac{\\partial F_{f_Q}}{\\partial U_j(Q)} U_{i,f_Q} + F_{f_Q} \\frac{\\partial U_{i,f_Q}}{\\partial U_j(Q)}\n$$\nLet the shared face $f_Q$ be normal to the direction $m$. The derivatives are:\n- $\\frac{\\partial F_{f_Q}}{\\partial U_j(Q)} = \\frac{1}{2}\\rho A_{f_Q} \\sigma_{f_Q} \\delta_{jm}$. This is nonzero only if $j=m$.\n- $\\frac{\\partial U_{i,f_Q}}{\\partial U_j(Q)} = \\frac{1}{2}\\delta_{ij}$. This is nonzero only if $j=i$.\n\nThe entry $J_{(P,i),(Q,j)}$ is nonzero if and only if $j=m$ (the direction normal to the shared face) or $j=i$ (the component of the momentum equation being considered). The number of nonzero entries for a given neighbor $Q$ is the size of the set of indices $\\{i, m\\}$, which is $|\\{i,m\\}|$.\n\n**Counting the total number of nonzero entries, $N_{\\mathrm{nz}}(d)$**\nWe sum the contributions from all cells in the stencil: cell $P$ and its $2d$ neighbors.\n1.  **Contribution from $Q=P$**: As determined, this is $d$ nonzero entries.\n\n2.  **Contribution from neighbors**: We have $2d$ neighbors, which we categorize:\n    - **Neighbors across faces normal to direction $i$**: There are two such neighbors. For these, the face-normal direction is $m=i$. The set of influencing components is $\\{i, m\\} = \\{i, i\\} = \\{i\\}$. The size is $1$. Each of these two neighbors contributes $1$ nonzero entry. Total from these two neighbors: $2 \\times 1 = 2$.\n    - **Neighbors across faces normal to a direction $m \\neq i$**: There are $2d-2$ such neighbors (two for each of the $d-1$ directions not equal to $i$). For each of these neighbors, the face-normal direction is $m \\neq i$. The set of influencing velocity components from cell $Q$ is $\\{i, m\\}$, which has size 2. Thus, each of these $2d-2$ neighbors contributes 2 nonzero entries. Total from these neighbors: $(2d-2) \\times 2 = 4d-4$.\n\nTotal contribution from all neighbors is the sum of these two cases: $2 + (4d-4) = 4d-2$.\n\n**Final Calculation:**\nThe total number of nonzero entries $N_{\\mathrm{nz}}(d)$ is the sum of contributions from the central cell $P$ and all its neighbors:\n$$\nN_{\\mathrm{nz}}(d) = (\\text{contribution from } P) + (\\text{contribution from neighbors})\n$$\n$$\nN_{\\mathrm{nz}}(d) = d + (4d-2)\n$$\n$$\nN_{\\mathrm{nz}}(d) = 5d - 2\n$$\nThis expression gives the exact number of nonzero scalar Jacobian entries in the row corresponding to $R_i(P)$ for an interior cell $P$.", "answer": "$$\\boxed{5d-2}$$", "id": "3344038"}]}