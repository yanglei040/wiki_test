{"hands_on_practices": [{"introduction": "The high-order accuracy of the Spectral Element Method (SEM) is intricately linked to the properties of its underlying numerical quadrature. When nonlinear terms are present, as is common in fluid dynamics, the degree of the resulting polynomial integrand can exceed the exactness limit of the quadrature rule. This practice provides a rigorous analytical derivation of the resulting quadrature error, connecting it directly to the critical phenomenon of aliasing, where unresolved high-frequency information contaminates the resolved modes of the solution [@problem_id:3617162].", "problem": "Consider a one-dimensional reference element $[-1,1]$ as used in the Spectral Element Method (SEM). Let $N \\in \\mathbb{N}$ be the polynomial approximation degree, and let the Gauss-Lobatto-Legendre (GLL) quadrature with $N+1$ nodes $\\{x_i\\}_{i=0}^{N}$ and weights $\\{w_i\\}_{i=0}^{N}$ be employed. The GLL quadrature is exact for all polynomials up to degree $2N-1$. In SEM, nonlinear terms constructed from degree-$N$ polynomial fields can produce integrands of degree $2N$, for which the GLL rule is not exact. Define the quadrature error for a function $p(x)$ as\n$$\nE[p] \\equiv \\int_{-1}^{1} p(x)\\,dx \\;-\\; \\sum_{i=0}^{N} w_i\\, p(x_i).\n$$\nStarting from the orthogonality of Legendre polynomials $\\{L_m(x)\\}_{m\\ge 0}$ on $[-1,1]$ and the interpolatory character of the GLL quadrature, derive the exact form of the quadrature error when $p(x)$ is a polynomial of degree $2N$. In particular:\n\n- Write a general polynomial $p(x)$ of degree $2N$ in the Legendre basis $p(x)=\\sum_{m=0}^{2N} \\hat{p}_m\\, L_m(x)$ and show that $E[p]$ depends only on the coefficient $\\hat{p}_{2N}$ of $L_{2N}$.\n- By exploiting the orthogonality of Legendre polynomials and properties of GLL quadrature weights, compute the closed-form constant $C_N$ such that $E[p]= - C_N\\, \\hat{p}_{2N}$ for all polynomials $p$ of degree $2N$.\n- Specialize your result to the nonlinear prototype $p(x)=x^{2N}$ and provide the final closed-form expression for $E[x^{2N}]$ as a function of $N$ only.\n\nFinally, explain the aliasing mechanism in SEM: show how, when integrating nonlinear terms of degree $2N$ using a $(2N-1)$-exact GLL quadrature, the highest-degree Legendre mode $L_{2N}(x)$ produces a nonzero discrete inner product with the constant mode $L_0(x)$, and quantify this aliasing amplitude in terms of $N$. Express your final numerical or analytical answer for $E[x^{2N}]$ as a single closed-form expression. No rounding is required. If you use any acronym, define it upon first use; for example, Spectral Element Method (SEM) and Gauss-Lobatto-Legendre (GLL).", "solution": "We begin with core properties of Legendre polynomials and interpolatory quadrature. The Legendre polynomials $\\{L_m(x)\\}_{m\\ge 0}$ form an orthogonal basis on $[-1,1]$ with\n$$\n\\int_{-1}^{1} L_m(x)\\,L_n(x)\\,dx \\;=\\; \\frac{2}{2n+1}\\,\\delta_{mn},\n$$\nso any polynomial $p(x)$ of degree at most $2N$ admits the expansion\n$$\np(x) \\;=\\; \\sum_{m=0}^{2N} \\hat{p}_m\\, L_m(x),\n\\quad\n\\hat{p}_m \\;=\\; \\frac{2m+1}{2}\\,\\int_{-1}^{1} p(x)\\,L_m(x)\\,dx.\n$$\nThe $N+1$-point Gauss-Lobatto-Legendre (GLL) quadrature is exact for polynomials of degree up to $2N-1$. Therefore, for any polynomial $p(x)$ of degree $2N$, we have\n$$\nE[p] \\;=\\; \\int_{-1}^{1} p(x)\\,dx \\;-\\; \\sum_{i=0}^{N} w_i\\, p(x_i),\n$$\nand since all components of $p$ of degree $\\le 2N-1$ are integrated exactly, the error arises solely from the $L_{2N}(x)$ component. To show this, note that\n$$\n\\int_{-1}^{1} L_m(x)\\,dx \\;=\\; \\begin{cases}\n2, & m=0,\\\\\n0, & m\\ge 1,\n\\end{cases}\n$$\nand by exactness, for $m\\le 2N-1$,\n$$\n\\sum_{i=0}^{N} w_i\\, L_m(x_i) \\;=\\; \\int_{-1}^{1} L_m(x)\\,dx.\n$$\nHence the difference for such $m$ vanishes. For $m=2N$, exactness fails, so the error reduces to\n$$\nE[p] \\;=\\; \\hat{p}_{2N}\\left(\\int_{-1}^{1} L_{2N}(x)\\,dx \\;-\\; \\sum_{i=0}^{N} w_i\\, L_{2N}(x_i)\\right)\n\\;=\\; -\\,\\hat{p}_{2N}\\,\\sum_{i=0}^{N} w_i\\, L_{2N}(x_i),\n$$\nbecause $\\int_{-1}^{1} L_{2N}(x)\\,dx = 0$ for $2N\\ge 1$. Therefore, there exists a constant $C_N$ such that\n$$\nE[p] \\;=\\; -\\,C_N\\, \\hat{p}_{2N},\n\\quad\nC_N \\;=\\; \\sum_{i=0}^{N} w_i\\, L_{2N}(x_i).\n$$\nWe now compute $C_N$ in closed form using standard GLL weight identities. The GLL nodes $\\{x_i\\}$ are the endpoints and the roots of $(1-x^2)\\,L'_N(x)=0$, and the corresponding weights satisfy\n$$\nw_i \\;=\\; \\frac{2}{N(N+1)}\\,\\frac{1}{L_N(x_i)^2},\n\\quad i=0,1,\\dots,N,\n$$\nincluding endpoints since $L_N(\\pm 1)^2=1$. Thus,\n$$\nC_N \\;=\\; \\sum_{i=0}^{N} w_i\\, L_{2N}(x_i)\n\\;=\\; \\frac{2}{N(N+1)} \\sum_{i=0}^{N} \\frac{L_{2N}(x_i)}{L_N(x_i)^2}.\n$$\nDirect evaluation of this sum is nontrivial, but we can determine $C_N$ by a consistency argument using the error functional acting on the polynomial $L_N(x)^2$. Consider $f(x)=L_N(x)^2$, which is of degree $2N$. The exact integral is\n$$\n\\int_{-1}^{1} L_N(x)^2\\,dx \\;=\\; \\frac{2}{2N+1}.\n$$\nThe GLL quadrature sum is\n$$\n\\sum_{i=0}^{N} w_i\\, L_N(x_i)^2\n\\;=\\; \\sum_{i=0}^{N} \\frac{2}{N(N+1)}\\,\\frac{L_N(x_i)^2}{L_N(x_i)^2}\n\\;=\\; \\frac{2}{N(N+1)}\\,(N+1) \\;=\\; \\frac{2}{N}.\n$$\nHence the quadrature error for $f=L_N^2$ is\n$$\nE[L_N^2] \\;=\\; \\frac{2}{2N+1} - \\frac{2}{N} \\;=\\; -\\,\\frac{2(N+1)}{N(2N+1)}.\n$$\nOn the other hand, since $E[f] = - C_N\\, \\hat{f}_{2N}$ and $f=L_N^2$ has a Legendre expansion whose highest mode $L_{2N}$ coefficient equals the ratio of leading coefficients,\n$$\n\\hat{f}_{2N} \\;=\\; \\frac{\\text{leading coefficient of }L_N^2}{\\text{leading coefficient of }L_{2N}}\n\\;=\\; \\frac{\\left(2^{-N}\\binom{2N}{N}\\right)^2}{2^{-2N}\\binom{4N}{2N}}\n\\;=\\; \\frac{\\binom{2N}{N}^2}{\\binom{4N}{2N}}.\n$$\nEquating the two expressions for $E[L_N^2]$ gives\n$$\n-\\,\\frac{2(N+1)}{N(2N+1)} \\;=\\; -\\,C_N\\, \\frac{\\binom{2N}{N}^2}{\\binom{4N}{2N}},\n$$\nso\n$$\nC_N \\;=\\; \\frac{2(N+1)}{N(2N+1)}\\,\\frac{\\binom{4N}{2N}}{\\binom{2N}{N}^2}.\n$$\nThis closes the derivation of $C_N$.\n\nWe now specialize to the prototype nonlinear integrand $p(x)=x^{2N}$. Its Legendre coefficient $\\hat{p}_{2N}$ can be found by matching leading coefficients: the leading coefficient of $L_{2N}(x)$ is $2^{-2N}\\binom{4N}{2N}$, so to produce a leading term $x^{2N}$, the required coefficient is\n$$\n\\hat{p}_{2N} \\;=\\; \\frac{1}{2^{-2N}\\binom{4N}{2N}}\n\\;=\\; \\frac{2^{2N}}{\\binom{4N}{2N}}.\n$$\nTherefore, the quadrature error is\n$$\nE[x^{2N}] \\;=\\; -\\,C_N\\,\\hat{p}_{2N}\n\\;=\\; -\\,\\left(\\frac{2(N+1)}{N(2N+1)}\\,\\frac{\\binom{4N}{2N}}{\\binom{2N}{N}^2}\\right)\\left(\\frac{2^{2N}}{\\binom{4N}{2N}}\\right)\n\\;=\\; -\\,\\frac{2^{2N+1}(N+1)}{N(2N+1)\\,\\binom{2N}{N}^2}.\n$$\nThis is a closed-form expression in terms of $N$ only.\n\nWe next explain the aliasing mechanism. In SEM, inner products and integrals are approximated by GLL quadrature. For polynomials of degree at most $2N-1$, the discrete inner product coincides with the exact one, preserving the orthogonality of Legendre modes. However, for the degree-$2N$ mode $L_{2N}(x)$, discrete orthogonality fails:\n$$\n\\sum_{i=0}^{N} w_i\\, L_{2N}(x_i)\\, L_0(x_i) \\;=\\; \\sum_{i=0}^{N} w_i\\, L_{2N}(x_i)\n\\;=\\; C_N \\;\\neq\\; 0,\n$$\nwhere $L_0(x)=1$. Thus, the highest-degree content in nonlinear terms (for example, $u(x)^2$ when $u$ is degree $N$) produces a spurious nonzero discrete projection onto the constant mode under $(2N-1)$-exact quadrature. This folding of unresolved high-frequency content into lower-frequency modes is the classical aliasing mechanism. Quantitatively, if $u^2$ has Legendre coefficient $\\widehat{(u^2)}_{2N}$ in front of $L_{2N}$, then its discrete mean computed by GLL is increased by the aliasing amplitude\n$$\nA_N \\;=\\; \\sum_{i=0}^{N} w_i\\, L_{2N}(x_i) \\;=\\; C_N \\;=\\; \\frac{2(N+1)}{N(2N+1)}\\,\\frac{\\binom{4N}{2N}}{\\binom{2N}{N}^2}.\n$$\nThis underintegration-induced bias is responsible for spurious energy transfers in SEM when evaluating nonlinearities without adequate quadrature exactness.\n\nIn summary, the quadrature error for $p(x)=x^{2N}$ with an $N+1$-point GLL rule on $[-1,1]$ is given by\n$$\nE[x^{2N}] \\;=\\; -\\,\\frac{2^{2N+1}(N+1)}{N(2N+1)\\,\\binom{2N}{N}^2}.\n$$\nThis single closed-form expression completes the requested calculation, and the aliasing mechanism follows from the nonzero discrete projection of $L_{2N}$ onto $L_0$ with amplitude $C_N$.", "answer": "$$\\boxed{-\\,\\frac{2^{2N+1}(N+1)}{N(2N+1)\\,\\binom{2N}{N}^{2}}}$$", "id": "3617162"}, {"introduction": "Applying SEM to systems of partial differential equations, such as the incompressible Stokes equations, introduces new challenges related to numerical stability. The choice of polynomial approximation spaces for different physical fields—like velocity and pressure—must satisfy a compatibility condition, known as the Ladyzhenskaya–Babuška–Brezzi (LBB) or inf-sup condition, to avoid non-physical artifacts. This exercise guides you through the construction of the discrete operators for an equal-order velocity-pressure formulation, allowing you to discover and analyze the classic \"checkerboard\" spurious pressure mode that arises from violating this crucial stability condition [@problem_id:3381222].", "problem": "Consider the incompressible Stokes equations on the unit square domain $\\Omega = [0,1]^2$ with periodic boundary conditions, where the velocity field is denoted by $\\mathbf{u}$ and the pressure field by $p$. The continuous weak formulation seeks $\\mathbf{u} \\in \\mathbf{V}$ and $p \\in Q$ such that\n$$\n\\int_{\\Omega} \\nabla \\mathbf{u} : \\nabla \\mathbf{v} \\, d\\Omega - \\int_{\\Omega} p \\, \\nabla \\cdot \\mathbf{v} \\, d\\Omega = \\int_{\\Omega} \\mathbf{f} \\cdot \\mathbf{v} \\, d\\Omega \\quad \\text{for all } \\mathbf{v} \\in \\mathbf{V},\n$$\nand\n$$\n\\int_{\\Omega} q \\, \\nabla \\cdot \\mathbf{u} \\, d\\Omega = 0 \\quad \\text{for all } q \\in Q,\n$$\nwhere $\\mathbf{V}$ is the appropriate Sobolev space for velocity and $Q$ is the appropriate space for pressure. Stability of mixed formulations is governed by the Ladyzhenskaya–Babuška–Brezzi (LBB) condition, also known as the inf–sup condition, which requires a positive lower bound on the discrete inf–sup constant for the chosen discretization of $\\mathbf{V}$ and $Q$.\n\nIn the Spectral Element Method (SEM), with Gauss–Lobatto–Legendre (GLL) quadrature and nodal basis functions, an equal-order choice $Q_p/Q_p$ (velocity and pressure spaces of the same polynomial degree $p$) on a structured mesh is known to admit spurious pressure modes that violate the inf–sup condition. In particular, for $p = 1$ (bilinear nodal basis on element corners) with diagonal (mass-lumped) quadrature using $2 \\times 2$ GLL points, a classic “checkerboard” pressure mode persists under mesh refinement on structured grids.\n\nYour task is to construct, purely in algebraic terms, the discrete divergence coupling operator for the equal-order SEM on a structured, periodic mesh of the unit square using $p = 1$, and to demonstrate the existence and persistence of a spurious pressure mode under mesh refinement. Proceed as follows.\n\n1. Discretize $\\Omega$ into $M \\times M$ identical square spectral elements, with $M$ even, so that the element size is $h_x = h_y = h = 1/M$. Use GLL nodes at the element corners, which, under periodic identification, induce a global structured grid of $M \\times M$ unique nodal points indexed by $(i,j)$ with $i \\in \\{0,1,\\dots,M-1\\}$ and $j \\in \\{0,1,\\dots,M-1\\}$. Use equal-order, continuous nodal basis functions for velocity and pressure defined at these global nodes.\n\n2. Let the global velocity vector be ordered as two components per node, so the number of velocity degrees of freedom is $n_u = 2 M^2$, and the number of pressure degrees of freedom is $n_p = M^2$. Define the discrete divergence coupling matrix $\\mathbf{B} \\in \\mathbb{R}^{n_p \\times n_u}$ purely algebraically by SEM collocation with GLL quadrature:\n   - On the reference element $[-1,1]^2$, the $2$-point one-dimensional GLL nodes are at $\\xi = -1$ and $\\xi = +1$ with weights $w = 1$ and the differentiation matrix\n     $$\n     \\mathbf{D}^{(1\\text{D})} = \\begin{bmatrix} -\\tfrac{1}{2} & \\tfrac{1}{2} \\\\ -\\tfrac{1}{2} & \\tfrac{1}{2} \\end{bmatrix}.\n     $$\n   - The physical derivatives scale as $\\partial/\\partial x = \\tfrac{2}{h} \\, \\partial/\\partial \\xi$ and $\\partial/\\partial y = \\tfrac{2}{h} \\, \\partial/\\partial \\eta$.\n   - For each element with lower-left corner at $(i,j)$ in the global index space, and for each of its four local nodes $(s,t) \\in \\{0,1\\} \\times \\{0,1\\}$ corresponding to reference coordinates $(\\xi_s, \\eta_t) \\in \\{-1,+1\\} \\times \\{-1,+1\\}$, the discrete divergence at that local node induced by global velocity nodal values is defined by\n     $$\n     \\big(\\nabla \\cdot \\mathbf{u}\\big)_{(s,t)} = \\frac{2}{h} \\sum_{k=0}^{1} \\mathbf{D}^{(1\\text{D})}_{s,k} \\, u_x\\big(k,t\\big) \\;+\\; \\frac{2}{h} \\sum_{k=0}^{1} \\mathbf{D}^{(1\\text{D})}_{t,k} \\, u_y\\big(s,k\\big),\n     $$\n     where $u_x(k,t)$ and $u_y(s,k)$ are the velocity nodal values at the appropriate global nodes on that element. Assemble these contributions to a global collocated divergence operator by summing element-wise contributions at shared global nodes under periodic identification. Then, define $\\mathbf{B}$ by mass-lumped GLL quadrature as\n     $$\n     \\mathbf{B} = h^2 \\, \\mathbf{D}_{\\text{glob}},\n     $$\n     where $\\mathbf{D}_{\\text{glob}}$ maps global velocity degrees of freedom to the divergence evaluated at global pressure nodes, and $h^2$ is the quadrature weight accumulated per global node (each node is shared by four elements and each element contributes $(h^2)/4$ per corner with $2 \\times 2$ GLL).\n\n3. Define the checkerboard pressure vector $\\mathbf{p}_{\\text{alt}} \\in \\mathbb{R}^{n_p}$ at global node $(i,j)$ by\n   $$\n   \\big(\\mathbf{p}_{\\text{alt}}\\big)_{i,j} = (-1)^{i+j}.\n   $$\n   This vector is well-defined on the periodic grid only for even $M$.\n\n4. Demonstrate spurious pressure mode persistence under mesh refinement by computing, for $M \\in \\{2,4,8\\}$:\n   - The Euclidean norm $\\left\\| \\mathbf{B}^\\top \\mathbf{p}_{\\text{alt}} \\right\\|_2$ and reporting whether it is below a threshold $\\varepsilon = 10^{-12}$ (a boolean result).\n   - The number of singular values of $\\mathbf{B}$ less than or equal to $\\varepsilon$, minus $1$ to remove the trivial nullspace associated with constant pressure. This yields a nonnegative integer that counts spurious pressure modes beyond the constant-pressure mode.\n\n5. Your program must implement the above assembly exactly as specified and produce a single line of output containing the results as a comma-separated list enclosed in square brackets. The list must be ordered as\n   $$\n   \\big[ b_{2}, b_{4}, b_{8}, c_{2}, c_{4}, c_{8} \\big],\n   $$\n   where $b_M$ is the boolean indicating whether $\\left\\| \\mathbf{B}^\\top \\mathbf{p}_{\\text{alt}} \\right\\|_2 \\le \\varepsilon$ for the given $M$, and $c_M$ is the integer count of spurious pressure modes as described above for that $M$. No physical units are involved in this computation. Angles are not present. Percentages are not present. The program must print exactly one line with the specified format.\n\nThe test suite is given by the parameter values $M \\in \\{2,4,8\\}$ and threshold $\\varepsilon = 10^{-12}$. Ensure numerical robustness and exact assembly so that the discrete algebra reflects the specified SEM collocation and quadrature model.", "solution": "The user has provided a problem concerning the numerical stability of an equal-order spectral element method for the incompressible Stokes equations. The task is to construct the discrete divergence operator and use it to demonstrate the existence of a spurious pressure mode. This requires validating the problem statement, and if valid, proceeding with a detailed, reasoned solution and a corresponding Python implementation.\n\n### Step 1: Problem Validation: Extraction of Givens\n\n- **Governing Equations**: Incompressible Stokes equations on $\\Omega = [0,1]^2$ with periodic boundary conditions.\n- **Discretization Method**: Spectral Element Method (SEM) with Gauss–Lobatto–Legendre (GLL) quadrature.\n- **Polynomial Order**: $p=1$ (bilinear basis functions) for both velocity and pressure (equal-order $Q_1/Q_1$ formulation).\n- **Mesh**: Structured $M \\times M$ grid of identical square elements, with $M$ being an even integer. Element size is $h = 1/M$.\n- **Global Nodal Grid**: $M \\times M$ unique nodes after periodic identification, indexed by $(i,j)$ for $i, j \\in \\{0, \\dots, M-1\\}$.\n- **Degrees of Freedom**: $n_p = M^2$ for pressure, $n_u = 2M^2$ for velocity ($u_x, u_y$ components at each node).\n- **1D Reference Element Discretization**: On $[-1,1]$, $2$-point GLL nodes are at $\\xi \\in \\{-1, +1\\}$ with weights $w=1$. The $p=1$ differentiation matrix is $\\mathbf{D}^{(1\\text{D})} = \\begin{bmatrix} -1/2 & 1/2 \\\\ -1/2 & 1/2 \\end{bmatrix}$.\n- **Local Divergence Definition**: For an element, the divergence at a local corner node $(s, t)$ is given by collocation: $\\big(\\nabla \\cdot \\mathbf{u}\\big)_{(s,t)} = \\frac{2}{h} \\sum_{k=0}^{1} \\mathbf{D}^{(1\\text{D})}_{s,k} \\, u_x\\big(k,t\\big) \\;+\\; \\frac{2}{h} \\sum_{k=0}^{1} \\mathbf{D}^{(1\\text{D})}_{t,k} \\, u_y\\big(s,k\\big)$.\n- **Global Operator Assembly**: The global collocated divergence operator, $\\mathbf{D}_{\\text{glob}}$, is formed by summing the element-wise contributions at shared global nodes.\n- **Discrete Divergence Matrix $\\mathbf{B}$**: Defined as $\\mathbf{B} = h^2 \\, \\mathbf{D}_{\\text{glob}}$, where the $h^2$ factor arises from mass-lumped GLL quadrature.\n- **Spurious Mode**: The checkerboard pressure vector $\\mathbf{p}_{\\text{alt}}$ is defined at global node $(i, j)$ as $(\\mathbf{p}_{\\text{alt}})_{i,j} = (-1)^{i+j}$.\n- **Computational Tasks**: For $M \\in \\{2, 4, 8\\}$ and tolerance $\\varepsilon = 10^{-12}$:\n    1. Determine if $\\left\\| \\mathbf{B}^\\top \\mathbf{p}_{\\text{alt}} \\right\\|_2 \\le \\varepsilon$ (a boolean result $b_M$).\n    2. Count the number of singular values of $\\mathbf{B}$ less than or equal to $\\varepsilon$, and subtract $1$ (an integer result $c_M$).\n- **Output Format**: A single line `[b_2,b_4,b_8,c_2,c_4,c_8]`.\n\n### Step 2: Problem Validation: Analysis\n\n1.  **Scientific Groundedness**: The problem is rooted in the established theory of mixed finite/spectral element methods for CFD. The LBB (inf-sup) condition, spurious pressure modes in equal-order elements, GLL quadrature, and the checkerboard mode are all standard, well-documented concepts in numerical analysis. The setup is scientifically and mathematically sound.\n2.  **Well-Posedness**: The instructions provide a complete and unambiguous algebraic procedure for constructing the matrix $\\mathbf{B}$. The subsequent numerical linear algebra tasks (norm and SVD computation) are well-defined and lead to a unique, computable result.\n3.  **Objectivity**: The problem is stated in precise, quantitative, and unbiased technical language.\n4.  **Completeness and Consistency**: The problem provides all necessary information. The use of periodic boundary conditions is consistent with the definition of the checkerboard mode for even $M$. The definition of $\\mathbf{B}$ via $\\mathbf{D}_{\\text{glob}}$ and a quadrature-based scaling factor is clear. For the specified test cases ($M \\in \\{2, 4, 8\\}$), the matrices are small enough for standard SVD algorithms.\n5.  **No other flaws detected**: The problem is not ill-posed, trivial, or unverifiable. It is a substantive exercise in implementing a specific numerical discretization and analyzing its properties.\n\n### Step 3: Verdict and Action\n\nThe problem statement is **valid**. A solution will be provided.\n\n### Solution Derivation\n\nThe solution requires constructing the matrix $\\mathbf{B} \\in \\mathbb{R}^{n_p \\times n_u}$ and then analyzing its properties. The core of this task is to find the explicit stencil for the global divergence operator $\\mathbf{D}_{\\text{glob}}$.\n\n**1. Global Nodal Indexing**\nWe adopt a lexicographical ordering for the global degrees of freedom. For a node at grid position $(i,j)$ where $i,j \\in \\{0, \\dots, M-1\\}$:\n- The pressure DOF index is $p_{idx}(i,j) = iM + j$.\n- The velocity DOFs are interleaved: the $u_x$ index is $u_{x,idx}(i,j) = 2(iM+j)$ and the $u_y$ index is $u_{y,idx}(i,j) = 2(iM+j) + 1$.\n\n**2. Assembling the Global Divergence Operator $\\mathbf{D}_{\\text{glob}}$**\nThe problem states that the global operator is formed by \"summing element-wise contributions\". A global node $(i,j)$ is shared by four elements, which have their lower-left corners at global indices $(i,j)$, $((i-1)\\%M, j)$, $(i, (j-1)\\%M)$, and $((i-1)\\%M, (j-1)\\%M)$. We sum the contributions to the divergence at node $(i,j)$ from each of these four elements.\n\nLet's focus on the $u_x$ contribution to the divergence at node $(i,j)$, which we denote $(\\partial_x u_x)_{i,j}$.\n- **Element 1 (LL corner at $(i,j)$)**: Node $(i,j)$ is its local node $(0,0)$. The contribution is $\\frac{2}{h}\\sum_{k=0}^1 (\\mathbf{D}^{(1\\text{D})}_{0,k}) u_x(k,0) = \\frac{2}{h} (\\frac{-1}{2}u_x(0,0) + \\frac{1}{2}u_x(1,0)) = \\frac{1}{h}(u_x(i+1, j) - u_x(i, j))$.\n- **Element 2 (LL corner at $(i-1,j)$)**: Node $(i,j)$ is its local node $(1,0)$. The contribution is $\\frac{2}{h}\\sum_{k=0}^1 (\\mathbf{D}^{(1\\text{D})}_{1,k}) u_x(k,0) = \\frac{2}{h} (\\frac{-1}{2}u_x(0,0) + \\frac{1}{2}u_x(1,0)) = \\frac{1}{h}(u_x(i, j) - u_x(i-1, j))$.\n- **Element 3 (LL corner at $(i,j-1)$)**: Node $(i,j)$ is its local $(0,1)$. The contribution is $\\frac{1}{h}(u_x(i+1, j) - u_x(i, j))$.\n- **Element 4 (LL corner at $(i-1,j-1)$)**: Node $(i,j)$ is its local $(1,1)$. The contribution is $\\frac{1}{h}(u_x(i, j) - u_x(i-1, j))$.\n\nSumming these four contributions:\n$(\\partial_x u_x)_{i,j} = \\frac{1}{h} \\left[ (u_{x,i+1,j} - u_{x,i,j}) + (u_{x,i,j} - u_{x,i-1,j}) + (u_{x,i+1,j} - u_{x,i,j}) + (u_{x,i,j} - u_{x,i-1,j}) \\right]$\n$(\\partial_x u_x)_{i,j} = \\frac{2}{h} (u_{x,i+1,j} - u_{x,i-1,j})$\nwhere all indices are taken modulo $M$. By symmetry, the $u_y$ contribution is:\n$(\\partial_y u_y)_{i,j} = \\frac{2}{h} (u_{y,i,j+1} - u_{y,i,j-1})$\n\nThe full divergence at node $(i,j)$ is the sum of these two parts. This defines the action of $\\mathbf{D}_{\\text{glob}}$.\n\n**3. Constructing the Matrix $\\mathbf{B}$**\nThe matrix $\\mathbf{B}$ is defined as $\\mathbf{B} = h^2 \\, \\mathbf{D}_{\\text{glob}}$. Therefore, the row of $\\mathbf{B}$ corresponding to pressure at node $(i,j)$ is determined by:\n$h^2 \\left[ \\frac{2}{h}(u_{x,i+1,j} - u_{x,i-1,j}) + \\frac{2}{h}(u_{y,i,j+1} - u_{y,i,j-1}) \\right] = 2h(u_{x,i+1,j} - u_{x,i-1,j}) + 2h(u_{y,i,j+1} - u_{y,i,j-1})$.\nThis row will have four non-zero entries:\n- At column $u_{x,idx}((i+1)\\%M, j)$: value is $+2h$.\n- At column $u_{x,idx}((i-1)\\%M, j)$: value is $-2h$.\n- At column $u_{y,idx}(i, (j+1)\\%M)$: value is $+2h$.\n- At column $u_{y,idx}(i, (j-1)\\%M)$: value is $-2h$.\n\n**4. Analysis of Spurious Modes**\nWe must compute $\\mathbf{v} = \\mathbf{B}^\\top \\mathbf{p}_{\\text{alt}}$. Let's find the component of $\\mathbf{v}$ for the $u_x$ DOF at node $(k,l)$. This component is the dot product of the column of $\\mathbf{B}$ for $u_{x,idx}(k,l)$ with $\\mathbf{p}_{\\text{alt}}$.\nThe column for $u_{x,idx}(k,l)$ has a non-zero entry $+2h$ in the row for pressure node $((k-1)\\%M, l)$ and $-2h$ in the row for pressure node $((k+1)\\%M, l)$.\nThus, the component is:\n$v_{u_{x,idx}(k,l)} = (+2h) \\cdot (\\mathbf{p}_{\\text{alt}})_{k-1,l} + (-2h) \\cdot (\\mathbf{p}_{\\text{alt}})_{k+1,l}$\n$v_{u_{x,idx}(k,l)} = 2h \\left( (-1)^{(k-1)+l} - (-1)^{(k+1)+l} \\right) = 2h(-1)^{k+l} \\left( (-1)^{-1} - (-1)^{1} \\right) = 2h(-1)^{k+l} (-1 - (-1)) = 0$.\nA similar calculation shows the $u_y$ components are also zero. Therefore, $\\mathbf{B}^\\top \\mathbf{p}_{\\text{alt}} = \\mathbf{0}$ analytically. This implies $\\left\\| \\mathbf{B}^\\top \\mathbf{p}_{\\text{alt}} \\right\\|_2$ should be zero (or numerically close), so $b_M$ will be `True` for all $M$.\n\nThe vector $\\mathbf{p}_{\\text{alt}}$ is in the null space of $\\mathbf{B}^\\top$. This corresponds to a zero singular value of $\\mathbf{B}$. It is known that for this discretization, there are four such modes for any even $M$: constant $(p=1)$, $x$-checkerboard $(p=(-1)^i)$, $y$-checkerboard $(p=(-1)^j)$, and $xy$-checkerboard $(p=(-1)^{i+j})$. These four modes are mutually orthogonal. Therefore, we expect to find exactly four singular values of $\\mathbf{B}$ that are numerically zero.\nThe number of spurious modes is this count minus one (for the constant mode), which is $c_M=3$. This result should persist for all even $M$.\n\nA special case arises for $M=2$. The stencil for the divergence at node $(i,j)$ involves nodes $(i\\pm 1, j)$ and $(i, j\\pm 1)$. When $M=2$, $(i+1)\\%2 = (i-1)\\%2$ for any $i \\in \\{0, 1\\}$. The positive and negative contributions to the stencil cancel exactly, resulting in $\\mathbf{D}_{\\text{glob}} = \\mathbf{0}$ and consequently $\\mathbf{B} = \\mathbf{0}$. For a zero matrix, any vector is in its null space, so $\\|\\mathbf{B}^\\top\\mathbf{p}_\\text{alt}\\|_2=0$ trivially. The singular values are all zero. The number of singular values is $n_p = M^2=4$. The count of spurious modes is thus $4-1=3$.\n\nThe expected numerical result is therefore $[True, True, True, 3, 3, 3]$. The implementation will follow the derived algebraic construction.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Constructs the discrete divergence operator for an equal-order SEM discretization\n    of the Stokes equations and identifies spurious pressure modes.\n    \"\"\"\n    test_cases = [2, 4, 8]\n    epsilon = 1e-12\n\n    b_results = []\n    c_results = []\n\n    for M in test_cases:\n        # Define grid and problem size parameters\n        h = 1.0 / M\n        n_p = M * M\n        n_u = 2 * n_p\n        \n        # 1. Assemble the discrete divergence coupling matrix B.\n        # B has dimensions n_p x n_u (M^2 x 2M^2).\n        B = np.zeros((n_p, n_u))\n\n        # Loop over each pressure degree of freedom (row of B), which corresponds \n        # to a global node (i, j).\n        for i in range(M):\n            for j in range(M):\n                # The row index corresponds to the pressure DOF at node (i, j).\n                p_idx = i * M + j\n                \n                # Determine neighbor indices with periodic boundary conditions.\n                i_p1 = (i + 1) % M\n                i_m1 = (i - 1 + M) % M\n                j_p1 = (j + 1) % M\n                j_m1 = (j - 1 + M) % M\n\n                # The problem statement defines D_glob by summing local contributions. This results\n                # in a global stencil for the divergence at node (i,j):\n                # (div u)_ij = 2/h * (u_x(i+1,j) - u_x(i-1,j)) + 2/h * (u_y(i,j+1) - u_y(i,j-1)).\n                # The matrix B is defined as B = h^2 * D_glob.\n                # The coefficients in B are thus h^2 * (±2/h) = ±2h.\n                \n                # For M=2, i_p1 becomes equal to i_m1, causing terms to cancel exactly.\n                # The code handles this case correctly, resulting in B being the zero matrix.\n\n                # u_x contributions to the divergence at (i,j)\n                # Global column index for u_x at node (i+1, j)\n                col_ux_ip1 = 2 * (i_p1 * M + j)\n                # Global column index for u_x at node (i-1, j)\n                col_ux_im1 = 2 * (i_m1 * M + j)\n                \n                B[p_idx, col_ux_ip1] += 2 * h\n                B[p_idx, col_ux_im1] -= 2 * h\n\n                # u_y contributions to the divergence at (i,j)\n                # Global column index for u_y at node (i, j+1)\n                col_uy_jp1 = 2 * (i * M + j_p1) + 1\n                # Global column index for u_y at node (i, j-1)\n                col_uy_jm1 = 2 * (i * M + j_m1) + 1\n                \n                B[p_idx, col_uy_jp1] += 2 * h\n                B[p_idx, col_uy_jm1] -= 2 * h\n        \n        # 2. Define the checkerboard pressure vector p_alt.\n        p_alt = np.zeros(n_p)\n        for idx in range(n_p):\n            i = idx // M\n            j = idx % M\n            p_alt[idx] = (-1)**(i + j)\n\n        # 3. Compute ||B^T * p_alt||_2 and check against the threshold.\n        # This vector is the discrete gradient of the checkerboard pressure.\n        Bt_p_alt = B.T @ p_alt\n        norm_Bt_p_alt = np.linalg.norm(Bt_p_alt)\n        b_M = norm_Bt_p_alt <= epsilon\n\n        # 4. Compute the singular values of B to find the dimension of the null space of B^T.\n        # Spurious pressure modes correspond to vectors in the null space of B^T.\n        singular_values = np.linalg.svd(B, compute_uv=False)\n        \n        # Count singular values that are numerically zero.\n        num_zero_sv = np.sum(singular_values <= epsilon)\n        \n        # The number of spurious modes is the dimension of the null space minus 1\n        # (to remove the trivial constant pressure mode).\n        c_M = num_zero_sv - 1\n        \n        b_results.append(b_M)\n        c_results.append(c_M)\n\n    # Combine results into the specified order: [b2, b4, b8, c2, c4, c8]\n    final_results = [str(r) for r in b_results] + [str(r) for r in c_results]\n    print(f\"[{','.join(final_results)}]\")\n\nsolve()\n```", "id": "3381222"}, {"introduction": "A primary motivation for using high-order methods is their potential for superior computational efficiency, achieving a desired accuracy with fewer degrees of freedom than low-order methods. This advantage, however, is contingent on the use of highly efficient algorithms for applying discrete operators. This practice explores the computational heart of SEM by comparing a naive, dense matrix-vector multiplication with the elegant and powerful sum-factorization technique, which leverages the tensor-product structure of the basis functions to dramatically reduce computational cost [@problem_id:3381216].", "problem": "Consider a single hexahedral element in the Spectral Element Method (SEM) for the Poisson operator in three spatial dimensions, with Gauss–Lobatto–Legendre nodal basis of polynomial degree $N$ and $n_{q} = N+1$ points per coordinate direction, so the number of nodal unknowns per element is $n_{p} = n_{q}^{3}$. Assume an affine element mapping with constant contravariant metric tensor and Jacobian determinant over the element, and use a matrix-free application of the elemental stiffness operator in the weak form. Adopt a flop model in which each scalar floating-point multiplication or addition counts as $1$ floating-point operation (flop), and a fused multiply-add counts as $2$ flops.\n\nYou will analyze two operator-application strategies per element:\n\n- A non-factorized, assembled approach that forms and stores the full elemental stiffness matrix of size $n_{p} \\times n_{p}$ and applies it to a vector by a dense matrix-vector multiply.\n- A sum-factorized, matrix-free approach that exploits the tensor-product structure and uses one-dimensional derivative operators of size $n_{q} \\times n_{q}$ applied along coordinate lines, followed by metric contractions and back-projections.\n\nTasks:\n\n1. Starting from the weak form definition of the stiffness operator for the Poisson equation and the tensor-product structure of the SEM basis, derive the leading-order floating-point operation counts per element, as functions of $N$, for both the non-factorized and the sum-factorized operator application. Your derivation must explicitly count the dominant tensor contractions and account for forward derivative transforms, metric contractions, and backward projections in the sum-factorized case. You may assume that quadrature weights and the Jacobian determinant can be folded into constant scalings without changing the leading-order count.\n\n2. Derive the corresponding leading-order memory access patterns per element, in terms of the number of scalar words read and written, for both strategies. Clearly identify the dominant terms as functions of $N$ and indicate which data structures contribute to them (for example, the stored elemental stiffness matrix versus one-dimensional operators and field arrays). You may assume unit-stride access along coordinate lines and ignore cache effects, focusing only on asymptotic counts.\n\nReport the final result as the asymptotic ratio of floating-point operations per element between the non-factorized and sum-factorized applications, defined as $R(N) = \\dfrac{F_{\\mathrm{NF}}(N)}{F_{\\mathrm{SF}}(N)}$, where $F_{\\mathrm{NF}}(N)$ and $F_{\\mathrm{SF}}(N)$ are the flop counts you derive for the non-factorized and sum-factorized strategies, respectively. Ignore lower-order terms in $N$ but retain the leading constant that follows from the flop model specified above. Provide $R(N)$ as a closed-form analytic expression in $N$. No units are required for the final reported answer.", "solution": "The problem is evaluated to be scientifically grounded, well-posed, objective, and self-contained. It represents a standard and valid analysis in the field of high-order numerical methods for partial differential equations. We may therefore proceed with a full solution.\n\nThe analysis hinges on determining the computational cost, in terms of floating-point operations (flops) and memory accesses, for applying the elemental stiffness operator for the $3$D Poisson equation using two different strategies. Let $N$ be the polynomial degree of the basis functions. The number of Gauss-Lobatto-Legendre nodes in each coordinate direction is $n_q = N+1$. For a hexahedral element, the total number of nodal points is $n_p = n_q^3 = (N+1)^3$.\n\n### Task 1: Floating-Point Operation Counts\n\n#### Non-Factorized (NF) Strategy\n\nIn the non-factorized, assembled approach, the elemental stiffness matrix $K$ is pre-computed and stored. The matrix $K$ has dimensions $n_p \\times n_p$. The application of the operator to a vector of nodal values $u$ is performed as a dense matrix-vector product, $y = Ku$.\n\nA dense matrix-vector product of a matrix of size $M \\times M$ with a vector of size $M$ requires $M^2$ multiplications and $M(M-1)$ additions. According to the specified flop model, where each multiplication and each addition counts as $1$ flop, the total number of floating-point operations is $M^2 + M(M-1) = 2M^2 - M$.\n\nIn our case, $M = n_p = (N+1)^3$. Therefore, the flop count for the non-factorized strategy is:\n$$\nF_{\\mathrm{NF}}(N) = 2n_p^2 - n_p = 2\\left((N+1)^3\\right)^2 - (N+1)^3 = 2(N+1)^6 - (N+1)^3\n$$\nThe leading-order term for large $N$ is determined by the highest power of $N$. Thus, the leading-order flop count is:\n$$\nF_{\\mathrm{NF}}(N) \\sim 2(N+1)^6\n$$\n\n#### Sum-Factorized (SF) Strategy\n\nThe sum-factorized strategy avoids forming the $n_p \\times n_p$ matrix by exploiting the tensor-product structure of the basis functions. The action of the operator, which discretizes $-\\nabla^T G \\nabla$ (where $G$ is the metric tensor term), is performed in a sequence of steps. Let $u_{ijk}$ be the grid of nodal values.\n\n1.  **Forward Transform (Gradient calculation)**: We compute the partial derivatives of the field $u$ with respect to the reference coordinates $(\\xi, \\eta, \\zeta)$ at all $n_p$ quadrature points. Let these derivative fields be $d_{\\xi}$, $d_{\\eta}$, and $d_{\\zeta}$.\n    -   Computing $d_{\\xi}$ involves applying a $1$D derivative operator $D$ of size $n_q \\times n_q$ along each of the $n_q^2$ lines parallel to the $\\xi$-axis. The cost of one such $n_q \\times n_q$ matrix-vector product is $2n_q^2 - n_q$ flops. The total cost for $d_{\\xi}$ is $n_q^2(2n_q^2 - n_q) = 2n_q^4 - n_q^3$.\n    -   The same cost applies to computing $d_{\\eta}$ and $d_{\\zeta}$.\n    -   The total flop count for this step is $3 \\times (2n_q^4 - n_q^3) = 6n_q^4 - 3n_q^3$.\n\n2.  **Metric Contractions**: At each of the $n_p=n_q^3$ quadrature points, the reference-space gradient vector $(d_{\\xi}, d_{\\eta}, d_{\\zeta})^T$ is multiplied by the $3 \\times 3$ symmetric metric tensor $G$. Let the resulting weighted gradient vector be $(w_{\\xi}, w_{\\eta}, w_{\\zeta})^T$.\n    -   The operation is $w = G d$. Since $G$ is a $3 \\times 3$ symmetric matrix, this matrix-vector product requires $6$ unique matrix entries, $9$ multiplications, and $6$ additions per point.\n    -   Total flop count per point is $9+6=15$ flops.\n    -   The total flop count for this step over all $n_p$ points is $15n_p = 15n_q^3$.\n\n3.  **Backward Projection (Divergence calculation)**: This step computes the action of the transpose of the gradient operator. It involves applying the transpose of the $1$D derivative operator, $D^T$, to the weighted derivative fields $w_{\\xi}$, $w_{\\eta}$, and $w_{\\zeta}$.\n    -   The structure is identical to the forward transform. The flop count for applying the divergence operator to the three fields is $3 \\times (2n_q^4 - n_q^3) = 6n_q^4 - 3n_q^3$.\n\n4.  **Final Summation**: The results from the three backward projections (one for each coordinate direction) must be summed to obtain the final output vector $y$.\n    -   This requires summing three values at each of the $n_p$ nodal points. For each point, this is $y_{ijk} = (\\text{div } w)_{\\xi, ijk} + (\\text{div } w)_{\\eta, ijk} + (\\text{div } w)_{\\zeta, ijk}$. This costs $2$ additions per point.\n    -   The total flop count for this summation is $2n_p = 2n_q^3$.\n\nThe total flop count for the sum-factorized strategy is the sum of the flops from these four steps:\n$$\nF_{\\mathrm{SF}}(N) = (6n_q^4 - 3n_q^3) + 15n_q^3 + (6n_q^4 - 3n_q^3) + 2n_q^3\n$$\n$$\nF_{\\mathrm{SF}}(N) = 12n_q^4 + 11n_q^3 = 12(N+1)^4 + 11(N+1)^3\n$$\nThe leading-order flop count for the sum-factorized strategy is:\n$$\nF_{\\mathrm{SF}}(N) \\sim 12(N+1)^4\n$$\n\n### Task 2: Memory Access Patterns\n\n#### Non-Factorized (NF) Strategy\n\n-   **Data Structures**: The dominant data structure is the stored elemental stiffness matrix $K$, of size $n_p \\times n_p = (N+1)^6$ words. The input and output vectors, $u$ and $y$, are of size $n_p = (N+1)^3$ words each.\n-   **Memory Accesses**: To perform the matrix-vector multiplication, the entire matrix $K$ and the input vector $u$ must be read from memory, and the output vector $y$ must be written.\n    -   Reads: $n_p^2$ words for $K$ and $n_p$ words for $u$.\n    -   Writes: $n_p$ words for $y$.\n-   **Leading-Order Term**: The total memory traffic is $n_p^2 + 2n_p = (N+1)^6 + 2(N+1)^3$ words. The dominant term is $(N+1)^6$, which arises from reading the stiffness matrix $K$.\n\n#### Sum-Factorized (SF) Strategy\n\n-   **Data Structures**: This strategy does not store the full stiffness matrix. The required data structures are: the $1$D operator matrices (e.g., $D$ of size $n_q^2 = (N+1)^2$), the input vector $u$ (size $n_p$), the output vector $y$ (size $n_p$), and temporary arrays for intermediate fields (e.g., gradients $d_{\\xi}, d_{\\eta}, d_{\\zeta}$). A minimum of $3$ temporary fields of size $n_p$ are typically required.\n-   **Memory Accesses**: The algorithm consists of several passes over fields of size $n_p$.\n    -   Reads: The input vector $u$ is read. The temporary gradient fields are written and then read. The weighted gradient fields are written and then read. The final result is accumulated (read-modify-write).\n    -   Writes: The temporary fields and the final output vector are written.\n-   **Leading-Order Term**: The total number of words read and written is proportional to the size of the fields, $n_p$. For example, a non-optimized implementation might read the input field $3$ times, write/read $3$ temporary fields twice, and write the output field. This would lead to a memory traffic of roughly $3n_p (\\text{read } u) + 6n_p (\\text{write grads}) + 6n_p (\\text{read grads}) + 3n_p (\\text{read w-grads}) + n_p (\\text{write } y) \\approx O(n_p)$.\nThe total memory access volume scales as $O(n_p) = O((N+1)^3)$. The memory accesses for the small $1$D operators are of a lower order, $O(n_q^2) = O((N+1)^2)$. The dominant contribution comes from streaming the large $3$D field arrays ($u$, $y$, and temporaries) multiple times.\n\n### Asymptotic Ratio of Flop Counts\n\nThe final task is to compute the asymptotic ratio $R(N) = \\frac{F_{\\mathrm{NF}}(N)}{F_{\\mathrm{SF}}(N)}$. Using the derived leading-order flop counts:\n$$\nF_{\\mathrm{NF,leading}}(N) = 2(N+1)^6\n$$\n$$\nF_{\\mathrm{SF,leading}}(N) = 12(N+1)^4\n$$\nThe ratio $R(N)$ is:\n$$\nR(N) = \\frac{2(N+1)^6}{12(N+1)^4} = \\frac{1}{6}(N+1)^2\n$$\nThis demonstrates the substantial computational advantage of the sum-factorized approach, with the ratio of work growing quadratically with the polynomial degree $N$.", "answer": "$$\\boxed{\\frac{1}{6}(N+1)^2}$$", "id": "3381216"}]}