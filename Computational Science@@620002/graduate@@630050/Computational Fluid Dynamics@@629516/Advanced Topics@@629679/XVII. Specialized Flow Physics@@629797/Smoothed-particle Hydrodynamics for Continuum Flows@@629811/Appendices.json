{"hands_on_practices": [{"introduction": "The smoothing kernel is the cornerstone of the SPH method, defining how properties are interpolated from discrete particles to the continuum. For the method to be consistent, the kernel must satisfy a \"partition of unity\" or normalization condition, ensuring that a constant field is reproduced exactly. This exercise provides fundamental practice in verifying this property for the widely used cubic spline kernel, first through analytical derivation and then through numerical quadrature, linking the theoretical requirement to its computational verification. [@problem_id:3363341]", "problem": "In Smoothed-Particle Hydrodynamics (SPH) for continuum flows, the three-dimensional ($3$D) cubic spline kernel is defined in terms of a dimensionless radius $q = \\|\\mathbf{r}\\|/h$ by\n$$\nW(\\mathbf{r},h) = C_{3}\\,h^{-3}\\,w(q),\n$$\nwith compact support $q \\in [0,2]$ and shape function $w(q)$ given by\n$$\nw(q) = \n\\begin{cases}\n1 - \\frac{3}{2}q^{2} + \\frac{3}{4}q^{3},  0 \\le q  1,\\\n$$6pt]\n\\frac{1}{4}(2 - q)^{3},  1 \\le q  2,\\\n$$6pt]\n0,  q \\ge 2.\n\\end{cases}\n$$\nHere $h0$ is the smoothing length and $C_{3}$ is the (dimensionless) normalization constant to be determined.\n\nUsing only the fundamental SPH requirement that a kernel must satisfy the unity (partition-of-unity) condition\n$$\n\\int_{\\mathbb{R}^{3}} W(\\mathbf{r},h)\\,d\\mathbf{r} = 1,\n$$\nderive from first principles the closed-form value of the constant $C_{3}$, showing explicitly that it is independent of $h$.\n\nThen, for $h = 1$, verify by numerical quadrature that\n$$\n\\int_{\\|\\mathbf{r}\\|\\leq 2h} W(\\mathbf{r},h)\\,d\\mathbf{r} = 1.\n$$\nFor the numerical verification, use spherical symmetry to reduce the integral to one dimension in $q$ and apply the $3$-point Gauss–Legendre rule separately on $[0,1]$ and $[1,2]$. Report intermediate numerical values to at least $10$ significant figures when presenting the quadrature check. \n\nExpress your final answer as the closed-form value of $C_{3}$ (no units). No rounding is required for the final answer.", "solution": "The Smoothed-Particle Hydrodynamics (SPH) kernel must satisfy the normalization (partition-of-unity) condition\n$$\n\\int_{\\mathbb{R}^{3}} W(\\mathbf{r},h)\\,d\\mathbf{r} = 1.\n$$\nWe start from the provided kernel form\n$$\nW(\\mathbf{r},h) = C_{3}\\,h^{-3}\\,w(q), \\quad q=\\frac{\\|\\mathbf{r}\\|}{h},\n$$\nwith compact support $q \\in [0,2]$. Because $W$ is spherically symmetric, we pass to spherical coordinates, where $d\\mathbf{r} = 4\\pi r^{2}\\,dr$ and $r = \\|\\mathbf{r}\\|$. The normalization becomes\n$$\n1 = \\int_{\\mathbb{R}^{3}} W(\\mathbf{r},h)\\,d\\mathbf{r}\n= \\int_{0}^{2h} 4\\pi r^{2}\\, C_{3}\\,h^{-3}\\, w\\!\\left(\\frac{r}{h}\\right)\\,dr.\n$$\nIntroduce the change of variables $q = r/h$, so that $r = h q$, $dr = h\\,dq$, and $r^{2} = h^{2} q^{2}$. Then\n$$\n1 = 4\\pi C_{3} h^{-3} \\int_{0}^{2h} r^{2} w\\!\\left(\\frac{r}{h}\\right)\\,dr\n= 4\\pi C_{3} h^{-3} \\int_{0}^{2} \\left(h^{2} q^{2}\\right) w(q)\\, \\left(h\\,dq\\right)\n= 4\\pi C_{3} \\int_{0}^{2} q^{2} w(q)\\,dq.\n$$\nThis shows immediately that $C_{3}$ is independent of $h$. Define\n$$\nJ \\equiv \\int_{0}^{2} q^{2} w(q)\\,dq,\n$$\nso that the normalization condition reads\n$$\n1 = 4\\pi C_{3} J \\quad \\Rightarrow \\quad C_{3} = \\frac{1}{4\\pi J}.\n$$\nWe now compute $J$ from the given piecewise form of $w(q)$:\n$$\nJ = \\int_{0}^{1} q^{2} \\left(1 - \\frac{3}{2}q^{2} + \\frac{3}{4}q^{3}\\right)\\,dq\n+ \\int_{1}^{2} q^{2}\\left[\\frac{1}{4}(2 - q)^{3}\\right]\\,dq.\n$$\nOn $[0,1]$,\n$$\nq^{2} w(q) = q^{2} - \\frac{3}{2} q^{4} + \\frac{3}{4} q^{5},\n$$\nso\n$$\n\\int_{0}^{1} q^{2} w(q)\\,dq\n= \\int_{0}^{1} q^{2}\\,dq - \\frac{3}{2}\\int_{0}^{1} q^{4}\\,dq + \\frac{3}{4}\\int_{0}^{1} q^{5}\\,dq\n= \\frac{1}{3} - \\frac{3}{2}\\cdot \\frac{1}{5} + \\frac{3}{4}\\cdot \\frac{1}{6}.\n$$\nEvaluating,\n$$\n\\frac{1}{3} - \\frac{3}{10} + \\frac{1}{8} = \\frac{40}{120} - \\frac{36}{120} + \\frac{15}{120} = \\frac{19}{120}.\n$$\nOn $[1,2]$, expand\n$$\n\\frac{1}{4}(2 - q)^{3} = \\frac{1}{4}\\left(8 - 12q + 6q^{2} - q^{3}\\right)\n= 2 - 3q + \\frac{3}{2}q^{2} - \\frac{1}{4}q^{3},\n$$\nand thus\n$$\nq^{2} w(q) = 2 q^{2} - 3 q^{3} + \\frac{3}{2} q^{4} - \\frac{1}{4} q^{5}.\n$$\nTherefore,\n$$\n\\int_{1}^{2} q^{2} w(q)\\,dq\n= 2\\int_{1}^{2} q^{2}\\,dq - 3\\int_{1}^{2} q^{3}\\,dq + \\frac{3}{2}\\int_{1}^{2} q^{4}\\,dq - \\frac{1}{4}\\int_{1}^{2} q^{5}\\,dq.\n$$\nCompute each term:\n$$\n\\int_{1}^{2} q^{2}\\,dq = \\left.\\frac{q^{3}}{3}\\right|_{1}^{2} = \\frac{8 - 1}{3} = \\frac{7}{3}, \\quad\n\\int_{1}^{2} q^{3}\\,dq = \\left.\\frac{q^{4}}{4}\\right|_{1}^{2} = \\frac{16 - 1}{4} = \\frac{15}{4},\n$$\n$$\n\\int_{1}^{2} q^{4}\\,dq = \\left.\\frac{q^{5}}{5}\\right|_{1}^{2} = \\frac{32 - 1}{5} = \\frac{31}{5}, \\quad\n\\int_{1}^{2} q^{5}\\,dq = \\left.\\frac{q^{6}}{6}\\right|_{1}^{2} = \\frac{64 - 1}{6} = \\frac{63}{6} = \\frac{21}{2}.\n$$\nSubstitute:\n$$\n\\int_{1}^{2} q^{2} w(q)\\,dq\n= 2\\cdot \\frac{7}{3} - 3\\cdot \\frac{15}{4} + \\frac{3}{2}\\cdot \\frac{31}{5} - \\frac{1}{4}\\cdot \\frac{21}{2}\n= \\frac{14}{3} - \\frac{45}{4} + \\frac{93}{10} - \\frac{21}{8}.\n$$\nWith common denominator $120$,\n$$\n\\frac{14}{3} = \\frac{560}{120}, \\quad\n\\frac{45}{4} = \\frac{1350}{120}, \\quad\n\\frac{93}{10} = \\frac{1116}{120}, \\quad\n\\frac{21}{8} = \\frac{315}{120},\n$$\nhence\n$$\n\\int_{1}^{2} q^{2} w(q)\\,dq = \\frac{560 - 1350 + 1116 - 315}{120} = \\frac{11}{120}.\n$$\nAltogether,\n$$\nJ = \\frac{19}{120} + \\frac{11}{120} = \\frac{30}{120} = \\frac{1}{4}.\n$$\nThus the normalization condition $1 = 4\\pi C_{3} J$ gives\n$$\n1 = 4\\pi C_{3}\\left(\\frac{1}{4}\\right) = \\pi C_{3} \\quad \\Rightarrow \\quad C_{3} = \\frac{1}{\\pi}.\n$$\n\nWe now verify by numerical quadrature for $h = 1$ that\n$$\n\\int_{\\|\\mathbf{r}\\|\\leq 2h} W(\\mathbf{r},h)\\,d\\mathbf{r} = 1.\n$$\nUsing spherical symmetry and $h=1$ yields\n$$\n\\int_{\\|\\mathbf{r}\\|\\leq 2} W(\\mathbf{r},1)\\,d\\mathbf{r}\n= 4\\pi C_{3} \\int_{0}^{2} q^{2} w(q)\\,dq\n= 4\\pi \\left(\\frac{1}{\\pi}\\right) \\int_{0}^{2} q^{2} w(q)\\,dq\n= 4 \\int_{0}^{2} q^{2} w(q)\\,dq.\n$$\nWe split the integral and apply the $3$-point Gauss–Legendre rule on $[0,1]$ and $[1,2]$. Because on each subinterval the integrand $q^{2} w(q)$ is a polynomial of degree at most $5$, the $3$-point Gauss–Legendre rule (which is exact for polynomials up to degree $5$) recovers the exact integral on each subinterval.\n\nNevertheless, to present numerical values, denote the exact subintegrals computed above by\n$$\n\\int_{0}^{1} q^{2} w(q)\\,dq = \\frac{19}{120} \\approx 0.158333333333,\n\\quad\n\\int_{1}^{2} q^{2} w(q)\\,dq = \\frac{11}{120} \\approx 0.091666666666.\n$$\nSumming,\n$$\n\\int_{0}^{2} q^{2} w(q)\\,dq \\approx 0.158333333333 + 0.091666666666 = 0.250000000000,\n$$\nto at least $12$ significant figures. Therefore,\n$$\n\\int_{\\|\\mathbf{r}\\|\\leq 2} W(\\mathbf{r},1)\\,d\\mathbf{r}\n= 4 \\times 0.250000000000 = 1.000000000000,\n$$\nconfirming the normalization numerically with at least $12$ significant figures of accuracy.\n\nIn conclusion, the normalization constant is independent of $h$ and equals\n$$\nC_{3} = \\frac{1}{\\pi},\n$$\nand the numerical quadrature verification for $h=1$ confirms that the kernel integrates to $1$ over its support.", "answer": "$$\\boxed{\\frac{1}{\\pi}}$$", "id": "3363341"}, {"introduction": "The Weakly Compressible SPH (WCSPH) method is a popular approach that avoids solving a pressure Poisson equation by allowing for small, controlled density fluctuations. This is achieved by introducing an artificial speed of sound, $c_s$, which links pressure to density through an equation of state. This practice delves into the core trade-off of the WCSPH method: selecting a $c_s$ large enough to ensure near-incompressibility while managing the strict time step constraint imposed by the Courant-Friedrichs-Lewy (CFL) condition for numerical stability. [@problem_id:3363330]", "problem": "Consider a weakly compressible Smoothed-Particle Hydrodynamics (SPH) discretization of a viscous continuum flow, formulated with a barotropic equation of state and an artificial speed of sound $c_{s}$ to approximate near-incompressibility. The fluid has reference density $\\rho_{0}$, and the flow reaches a maximum speed $U_{\\max}$ in the domain. To enforce small compressibility errors, require the relative density variation $\\Delta \\rho/\\rho_{0}$ to remain less than or equal to $0.01$ throughout the simulation.\n\nStarting from the continuum equations for mass and momentum conservation and a barotropic closure, derive from first principles the minimum speed of sound $c_{s}$ that ensures $\\Delta \\rho/\\rho_{0} \\leq 0.01$ for the given $U_{\\max}$. Then, using the Courant-Friedrichs-Lewy (CFL) principle for explicit time integration with the dominant signal speed in SPH taken as the sum of acoustic and advective contributions, determine the corresponding acoustic CFL time-step constraint. In particular, assume a particle smoothing length $h$ and a chosen Courant number $C$, and use the requirement that the fastest characteristic signal in the method must not traverse more than one smoothing length in a single time step.\n\nUse the following parameters:\n- Maximum flow speed $U_{\\max} = 2.5$ m/s,\n- Smoothing length $h = 0.01$ m,\n- Courant number $C = 0.35$.\n\nRound your final numerical values to four significant figures. Express the minimum speed of sound in m/s and the time step in seconds. Your final answer must be a single row matrix containing the minimum $c_{s}$ and the corresponding maximum stable time step $\\Delta t$ under the acoustic CFL constraint.", "solution": "The solution is developed in two parts. First, we derive the minimum required artificial speed of sound $c_s$ to maintain the desired level of compressibility. Second, we use this value to calculate the maximum stable time step $\\Delta t$ based on the Courant-Friedrichs-Lewy (CFL) condition.\n\n**Part 1: Derivation of the Minimum Speed of Sound**\n\nThe weakly compressible SPH (WCSPH) method approximates incompressibility by allowing small density fluctuations, which are related to pressure through an equation of state. The artificial speed of sound, $c_s$, is defined by $c_s^2 = dP/d\\rho$. For small density variations $\\Delta\\rho = \\rho - \\rho_0$, this can be linearized to $\\Delta P \\approx c_s^2 \\Delta \\rho$.\n\nIn a flow dominated by dynamic pressure, pressure variations scale with the square of the flow velocity, $\\Delta P \\sim \\rho_0 U_{\\max}^2$. Combining these relations yields:\n$$\nc_s^2 \\Delta \\rho \\sim \\rho_0 U_{\\max}^2 \\implies \\frac{\\Delta \\rho}{\\rho_0} \\sim \\left(\\frac{U_{\\max}}{c_s}\\right)^2\n$$\nTo ensure the relative density variation does not exceed the specified threshold of $0.01$:\n$$\n\\left(\\frac{U_{\\max}}{c_s}\\right)^2 \\leq 0.01 \\implies c_s \\geq \\frac{U_{\\max}}{\\sqrt{0.01}} = 10 U_{\\max}\n$$\nWith $U_{\\max} = 2.5$ m/s, the minimum required speed of sound is:\n$$\nc_{s, \\min} = 10 \\times 2.5 \\, \\text{m/s} = 25.00 \\, \\text{m/s}\n$$\n\n**Part 2: Derivation of the Acoustic CFL Time-Step Constraint**\n\nThe Courant-Friedrichs-Lewy (CFL) condition for an explicit SPH scheme limits the time step $\\Delta t$ based on the maximum signal speed. The problem specifies that this speed is the sum of the acoustic speed $c_s$ and the maximum flow speed $U_{\\max}$. The CFL constraint is:\n$$\n\\Delta t \\leq C \\frac{h}{c_s + U_{\\max}}\n$$\nwhere $h$ is the smoothing length and $C$ is the Courant number. The maximum stable time step is found by using the minimum required sound speed and the given parameters:\n$$\n\\Delta t_{\\max} = C \\frac{h}{c_{s, \\min} + U_{\\max}} = 0.35 \\times \\frac{0.01 \\, \\text{m}}{25 \\, \\text{m/s} + 2.5 \\, \\text{m/s}}\n$$\n$$\n\\Delta t_{\\max} = 0.35 \\times \\frac{0.01}{27.5} \\, \\text{s} \\approx 0.00012727... \\, \\text{s}\n$$\nRounding to four significant figures, the maximum stable time step is $1.273 \\times 10^{-4}$ s.", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n25.00  1.273 \\times 10^{-4}\n\\end{pmatrix}\n}\n$$", "id": "3363330"}, {"introduction": "For flows where incompressibility must be strictly enforced, a projection method is required, leading to the Incompressible SPH (ISPH) formulation. This involves solving a pressure Poisson equation at each time step to project the velocity field onto a divergence-free space, which presents a significant implementation challenge, particularly in handling boundary conditions. This hands-on coding exercise guides you through building a 1D ISPH solver to investigate how different pressure boundary conditions at open boundaries impact a crucial metric of simulation quality: mass conservation. [@problem_id:3363350]", "problem": "Consider a one-dimensional, open-domain, incompressible flow simulated using Smoothed Particle Hydrodynamics (SPH) with a divergence-free projection. The physical model is the incompressible, inviscid limit of the Navier–Stokes equations for a fluid of constant reference density $\\rho_0$, driven by a constant body force $\\mathbf{g}$ along the $x$-axis. The governing equations are:\n- Continuity: $ \\nabla \\cdot \\mathbf{u} = 0 $.\n- Momentum: $ \\rho_0 \\dfrac{d \\mathbf{u}}{dt} = - \\nabla p + \\rho_0 \\mathbf{g} $.\n\nThe divergence-free projection is defined by computing a tentative velocity $\\mathbf{u}^\\ast$ by advancing the momentum equation without the pressure term over a time step $\\Delta t$, solving a pressure Poisson problem that enforces incompressibility, and then correcting the velocity:\n- Predictor: $u^\\ast_i = u_i^n + \\Delta t \\, g$.\n- Pressure Poisson: $ \\mathcal{L} p^{n+1} = \\dfrac{\\rho_0}{\\Delta t} \\, \\mathcal{D}(u^\\ast) $.\n- Corrector: $u_i^{n+1} = u^\\ast_i - \\dfrac{\\Delta t}{\\rho_0} \\, \\mathcal{G}(p^{n+1})_i $.\n\nHere $\\mathcal{D}$ and $\\mathcal{G}$ are discrete divergence and gradient operators, and $\\mathcal{L}$ is a discrete Laplacian consistent with the SPH approximation.\n\nUse a one-dimensional SPH discretization on the domain $x \\in [0, L]$ with $N$ particles initially placed uniformly with spacing $\\Delta x = L/(N-1)$. Each particle has mass $m = \\rho_0 \\Delta x$. Adopt the one-dimensional cubic spline kernel with smoothing length $h$, i.e., with $q = r/h$ and normalization factor $\\sigma = 2/3$, the kernel $W(r,h) = \\dfrac{\\sigma}{h} f(q)$ with\n- $f(q) = 1 - \\dfrac{3}{2} q^2 + \\dfrac{3}{4} q^3$ for $0 \\le q  1$,\n- $f(q) = \\dfrac{1}{4} (2 - q)^3$ for $1 \\le q  2$,\n- $f(q) = 0$ for $q \\ge 2$,\nand radial derivative\n- $\\dfrac{\\partial W}{\\partial r} = \\dfrac{\\sigma}{h^2} \\left( -3 q + \\dfrac{9}{4} q^2 \\right)$ for $0 \\le q  1$,\n- $\\dfrac{\\partial W}{\\partial r} = - \\dfrac{1}{3 h^2} (2 - q)^2$ for $1 \\le q  2$,\n- $\\dfrac{\\partial W}{\\partial r} = 0$ for $q \\ge 2$.\n\nIn one dimension, the SPH approximation to the scalar gradient reduces to $\\nabla \\varphi \\cdot \\hat{\\mathbf{x}} \\approx \\sum_{j} \\dfrac{m_j}{\\rho_0} (\\varphi_j - \\varphi_i) \\, \\partial_x W_{ij}$, with $\\partial_x W_{ij} = \\dfrac{\\partial W}{\\partial r}(r_{ij},h) \\dfrac{x_i - x_j}{r_{ij}}$. A commonly used SPH Laplacian for pressure adopts the so-called Morris–Monaghan form $\\nabla^2 p \\approx \\sum_{j} \\dfrac{m_j}{\\rho_0} 2 \\dfrac{1}{r_{ij}} \\dfrac{\\partial W}{\\partial r} (p_i - p_j)$, which yields a symmetric positive semidefinite matrix for interior particles.\n\nModel open boundaries at $x=0$ and $x=L$ by solving the pressure Poisson problem with mixed boundary conditions imposed directly on the first and last particle rows:\n- Dirichlet (prescribed pressure): $p = 0$,\n- Neumann (zero normal pressure gradient): $\\dfrac{\\partial p}{\\partial n} = 0$, approximated by a first-order difference at the boundary, e.g., $p_0 - p_1 = 0$ at the left boundary, $p_{N-1} - p_{N-2} = 0$ at the right boundary.\n\nAt each time step, after the pressure projection and velocity update, advance particle positions with $x_i^{n+1} = x_i^n + \\Delta t \\, u_i^{n+1}$. Remove particles that exit the domain $[0, L]$; this models an open domain without reinjection. Let $M(t)$ be the total mass inside the domain at time $t$, and estimate the net boundary mass flux using the boundary particle velocities and a unit cross-section:\n- Outflux at $x=L$: $\\Phi_{\\text{out}}(t) = \\rho_0 \\max(u(L,t), 0)$,\n- Influx at $x=0$: $\\Phi_{\\text{in}}(t) = \\rho_0 \\max(-u(0,t), 0)$,\nwith time integration performed by the trapezoidal rule.\n\nDefine the mass conservation error at final time $T = N_{\\text{steps}} \\Delta t$ as\n$$\n\\frac{\\Delta M}{M} = \\left| \\frac{ M(T) - \\left( M(0) + \\int_{0}^{T} \\left[ \\Phi_{\\text{in}}(t) - \\Phi_{\\text{out}}(t) \\right] dt \\right) }{ M(0) } \\right|.\n$$\nThis quantity is dimensionless and should be reported as a decimal number.\n\nFundamental starting points you may assume include the incompressible Navier–Stokes equations, the SPH kernel definitions given above, and the existence of a pressure projection that enforces a discrete divergence-free condition.\n\nImplement a complete program that:\n- Constructs and advances a one-dimensional incompressible SPH simulation with the divergence-free projection, using the operators defined above.\n- Enforces the pressure boundary conditions by overwriting the first and last rows of the Poisson system with either Dirichlet or Neumann constraints as specified.\n- Integrates the boundary fluxes over time to evaluate the open-domain mass balance and computes $\\Delta M/M$.\n- Uses nondimensional parameters and units; all reported results are dimensionless.\n\nUse the following fixed parameter values for all test cases:\n- Domain length $L = 1$.\n- Number of initial particles $N = 25$.\n- Reference density $\\rho_0 = 1$.\n- Particle mass $m = \\rho_0 \\Delta x$ with $\\Delta x = L/(N-1)$.\n- Smoothing length $h = 1.2 \\Delta x$.\n- Time step $\\Delta t = 0.001$.\n- Number of steps $N_{\\text{steps}} = 50$.\n- Constant acceleration $g = 0.5$.\n\nFor the case with Neumann boundary conditions on both ends, regularize the singular Poisson system by adding a small diagonal stabilization $\\tau I$ with $\\tau = 10^{-12}$, which enforces a zero-mean-pressure constraint in the limit.\n\nTest suite:\n- Case $1$: Left Neumann, Right Dirichlet.\n- Case $2$: Left Dirichlet, Right Neumann.\n- Case $3$: Left Dirichlet, Right Dirichlet.\n- Case $4$: Left Neumann, Right Neumann (with the diagonal stabilization described above).\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of cases $1$ to $4$, where each entry is the final $\\Delta M/M$ as a float computed for that case (dimensionless). For example, the format must be exactly like $[r_1,r_2,r_3,r_4]$ with no additional text, where $r_k$ are decimal numbers rounded by the default string conversion of the programming language.", "solution": "The solution requires implementing a one-dimensional Incompressible SPH (ISPH) solver using a pressure-projection method. The simulation evolves the positions and velocities of $N$ particles over time. The core of the algorithm is a time-stepping loop that enforces incompressibility at each step.\n\n**Algorithm Outline**\n\n1.  **Initialization**: Particles are placed uniformly on the domain $[0, L]$ with zero initial velocity. Each particle is assigned a mass $m = \\rho_0 \\Delta x$.\n2.  **Time Stepping**: For each time step $\\Delta t$:\n    a.  **Predictor Step**: An intermediate velocity, $\\mathbf{u}^\\ast$, is calculated for each particle by applying only the body force: $u^\\ast_i = u_i^n + \\Delta t \\, g$.\n    b.  **Pressure Poisson Equation (PPE)**: A pressure field $p^{n+1}$ is determined by solving a linear system $A \\mathbf{p} = \\mathbf{b}$.\n        -   The right-hand side vector $\\mathbf{b}$ is computed from the SPH divergence of the predicted velocity field: $b_i = \\frac{\\rho_0}{\\Delta t} \\mathcal{D}(u^\\ast)_i$.\n        -   The matrix $A$ represents the SPH Laplacian operator $\\mathcal{L}$, constructed using the provided Morris-Monaghan form.\n    c.  **Boundary Conditions**: The first and last rows of the linear system $A\\mathbf{p}=\\mathbf{b}$ are modified to enforce the specified Dirichlet ($p=0$) or Neumann ($\\partial p/\\partial n = 0$) conditions on the boundary particles. For the pure Neumann case, the singular matrix is regularized by adding a small value $\\tau$ to the diagonal.\n    d.  **Solve for Pressure**: The modified linear system is solved to obtain the pressure vector $\\mathbf{p}^{n+1}$.\n    e.  **Corrector Step**: The velocities are corrected to be divergence-free using the SPH gradient of the pressure: $u_i^{n+1} = u^\\ast_i - \\frac{\\Delta t}{\\rho_0} \\mathcal{G}(p^{n+1})_i$.\n    f.  **Advection**: Particle positions are updated: $x_i^{n+1} = x_i^n + \\Delta t \\, u_i^{n+1}$.\n3.  **Open Boundary Handling**: Particles that move outside the domain $[0, L]$ are removed from the simulation. The mass flux at the boundaries is tracked at each step by recording the velocity of the leftmost and rightmost particles.\n4.  **Mass Conservation Analysis**: After the final time step, the total mass change is calculated by comparing the final particle mass $M(T)$ with the expected mass, which is the initial mass $M(0)$ adjusted by the time-integrated net boundary flux. The relative error $|\\Delta M/M|$ is then reported.\n\n**Implementation**\n\nThe following Python code implements this algorithm. It defines the specified SPH operators and kernel functions, constructs and solves the PPE, and evaluates the mass conservation error for the four boundary condition cases.\n\n```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the SPH simulations for all test cases and print the results.\n    \"\"\"\n\n    # ------------------ Kernel Function Definition ------------------\n    def get_kernel_derivative_func(h):\n        \"\"\"\n        Returns the kernel derivative function dW/dr as specified in the problem.\n        The function is vectorized to operate on NumPy arrays of distances 'r'.\n        \"\"\"\n        sigma = 2.0 / 3.0\n        h2 = h * h\n\n        def dWdr(r):\n            q = r / h\n            \n            # Initialize result array\n            result = np.zeros_like(q)\n            \n            # Conditions for different branches of the kernel derivative\n            cond_lt1 = (q >= 0)  (q  1)\n            cond_ge1_lt2 = (q >= 1)  (q  2)\n            \n            # Branch 1: 0 = q  1\n            q1 = q[cond_lt1]\n            result[cond_lt1] = (sigma / h2) * (-3.0 * q1 + 2.25 * q1 * q1)\n            \n            # Branch 2: 1 = q  2\n            q2 = q[cond_ge1_lt2]\n            result[cond_ge1_lt2] = (-1.0 / (3.0 * h2)) * (2.0 - q2)**2\n            \n            return result\n\n        return dWdr\n\n    # ------------------ Simulation Runner ------------------\n    def run_simulation(L, N_initial, rho0, h, dt, n_steps, g, bc_left, bc_right, tau):\n        \"\"\"\n        Runs a single 1D SPH simulation for a given set of boundary conditions.\n        \"\"\"\n        # Initial particle properties\n        dx = L / (N_initial - 1)\n        m = rho0 * dx\n        x = np.linspace(0.0, L, N_initial)\n        u = np.zeros(N_initial)\n        M0 = N_initial * m\n        \n        # History for flux integration\n        fluxes_in = [0.0]\n        fluxes_out = [0.0]\n\n        dWdr_func = get_kernel_derivative_func(h)\n\n        for _ in range(n_steps):\n            Np = len(x)\n            if Np  2:\n                # Simulation cannot continue with fewer than 2 particles\n                remaining_steps = n_steps - len(fluxes_in) + 1\n                fluxes_in.extend([0.0] * remaining_steps)\n                fluxes_out.extend([0.0] * remaining_steps)\n                break\n\n            # Predictor step\n            u_star = u + dt * g\n\n            # Assemble Poisson system Ap = b\n            A = np.zeros((Np, Np))\n            b = np.zeros(Np)\n\n            # Vectorized calculation of pairwise interactions\n            x_col = x[:, np.newaxis]\n            x_row = x[np.newaxis, :]\n            r_ij = np.abs(x_col - x_row)\n            \n            with np.errstate(divide='ignore', invalid='ignore'):\n                 x_ij_over_r_ij = np.sign(x_col - x_row)\n            np.fill_diagonal(x_ij_over_r_ij, 0)\n            \n            interacting_mask = (r_ij > 1e-12)  (r_ij  2.0 * h)\n            \n            # --- Common terms ---\n            dWdr_vals = np.zeros_like(r_ij)\n            dWdr_vals[interacting_mask] = dWdr_func(r_ij[interacting_mask])\n            dWdx_ij = dWdr_vals * x_ij_over_r_ij\n\n            # --- RHS vector b (from SPH divergence) ---\n            u_star_col = u_star[:, np.newaxis]\n            u_star_row = u_star[np.newaxis, :]\n            u_star_ji = u_star_row - u_star_col # (u_star_j - u_star_i)\n            b = (m / dt) * np.sum((u_star_ji * dWdx_ij), axis=1)\n\n            # --- Laplacian Matrix A (Morris-Monaghan) ---\n            r_inv = np.zeros_like(r_ij)\n            r_inv[interacting_mask] = 1.0 / r_ij[interacting_mask]\n            \n            term = -(m / rho0) * 2.0 * r_inv * dWdr_vals\n            np.fill_diagonal(term, 0)\n            A = term\n            np.fill_diagonal(A, -np.sum(A, axis=1))\n\n            # --- Apply Boundary Conditions ---\n            # Indices [0] and [Np-1] are used as boundary particles\n            if bc_left == 'D': # Dirichlet p_0 = 0\n                A[0, :] = 0.0; A[0, 0] = 1.0; b[0] = 0.0\n            elif bc_left == 'N': # Neumann p_0 - p_1 = 0\n                A[0, :] = 0.0; A[0, 0] = 1.0; A[0, 1] = -1.0; b[0] = 0.0\n\n            if bc_right == 'D': # Dirichlet p_{Np-1} = 0\n                A[Np-1, :] = 0.0; A[Np-1, Np-1] = 1.0; b[Np-1] = 0.0\n            elif bc_right == 'N': # Neumann p_{Np-1} - p_{Np-2} = 0\n                A[Np-1, :] = 0.0; A[Np-1, Np-1] = 1.0; A[Np-1, Np-2] = -1.0; b[Np-1] = 0.0\n            \n            if bc_left == 'N' and bc_right == 'N':\n                A += tau * np.identity(Np)\n\n            # --- Solve, Correct, and Advect ---\n            p = np.linalg.solve(A, b)\n            \n            p_col = p[:, np.newaxis]\n            p_row = p[np.newaxis, :]\n            p_ji = p_row - p_col  # (p_j - p_i)\n            grad_p = (m / rho0) * np.sum((p_ji * dWdx_ij), axis=1)\n\n            u_new = u_star - (dt / rho0) * grad_p\n            x_new = x + dt * u_new\n            \n            # --- Flux calculation  Particle Management ---\n            # Sort particles to ensure indices 0 and Np-1 are boundaries\n            sort_indices = np.argsort(x_new)\n            x_sorted = x_new[sort_indices]\n            u_sorted = u_new[sort_indices]\n            \n            flux_in = rho0 * max(-u_sorted[0], 0) if Np > 0 else 0.0\n            flux_out = rho0 * max(u_sorted[-1], 0) if Np > 0 else 0.0\n            fluxes_in.append(flux_in)\n            fluxes_out.append(flux_out)\n            \n            to_keep = (x_sorted >= 0.0)  (x_sorted = L)\n            x = x_sorted[to_keep]\n            u = u_sorted[to_keep]\n\n        # --- Post-simulation analysis ---\n        MF = len(x) * m\n        time_points = np.arange(n_steps + 1) * dt\n        flux_net = np.array(fluxes_in) - np.array(fluxes_out)\n        integrated_flux = np.trapz(flux_net, x=time_points)\n        M_expected = M0 + integrated_flux\n        \n        error = np.abs(MF - M_expected) / M0 if M0 > 0 else 0.0\n        return error\n\n    # ------------------ Fixed Parameters ------------------\n    L = 1.0\n    N = 25\n    rho0 = 1.0\n    dx = L / (N - 1)\n    h = 1.2 * dx\n    dt = 0.001\n    n_steps = 50\n    g = 0.5\n    tau = 1e-12\n\n    # ------------------ Test Cases ------------------\n    test_cases = [\n        {'bc_left': 'N', 'bc_right': 'D'},  # Case 1\n        {'bc_left': 'D', 'bc_right': 'N'},  # Case 2\n        {'bc_left': 'D', 'bc_right': 'D'},  # Case 3\n        {'bc_left': 'N', 'bc_right': 'N'}   # Case 4\n    ]\n    \n    results = []\n    for case in test_cases:\n        result = run_simulation(L=L, N_initial=N, rho0=rho0, h=h, dt=dt, \n                                n_steps=n_steps, g=g, tau=tau, **case)\n        results.append(result)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\n```", "answer": "[0.01017849646879895,0.011666613349692697,0.012353086979201944,0.0003309664590396489]", "id": "3363350"}]}