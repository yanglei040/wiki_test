{"hands_on_practices": [{"introduction": "The most effective way to understand the Matrix Element Method is to build a likelihood from the ground up. This first practice [@problem_id:3522061] guides you through every step, starting with a fundamental process in Quantum Electrodynamics (QED), $e^+e^- \\to \\mu^+\\mu^-$. You will see how a theoretical prediction, the squared matrix element $|\\mathcal{M}|^2$, is convolved with a detector resolution model to compute the probability of observing a specific event, providing a complete, first-principles implementation of the MEM framework.", "problem": "You will design and implement a numerical Matrix Element Method (MEM) likelihood evaluator for the scattering process $e^+ e^- \\to \\mu^+ \\mu^-$ in Quantum Electrodynamics (QED). The objective is to start from first principles of scattering theory, derive the unpolarized, spin-averaged squared matrix element $|\\mathcal{M}|^2$ for the process at tree level under the high-energy approximation where the muon mass is negligible, and then insert it into a MEM event likelihood of the form\n$$\nL(x \\mid \\theta) \\;=\\; \\frac{1}{\\sigma(\\theta)} \\int d\\Phi_2 \\;\\frac{d\\sigma}{d\\Phi_2}(\\theta)\\; W(x \\mid \\phi;\\theta),\n$$\nwhere $x$ denotes the measured event observables, $\\theta$ denotes the model parameter(s), $d\\Phi_2$ denotes the two-body final-state phase space, $d\\sigma/d\\Phi_2$ is the differential cross-section, and $W(x \\mid \\phi;\\theta)$ is a transfer function modeling the detector response.\n\nYou must implement this expression numerically for the following specific setup:\n\n- Fundamental base and assumptions:\n  - Use tree-level Quantum Electrodynamics (QED) for $e^+ e^- \\to \\mu^+ \\mu^-$ with only photon exchange.\n  - Assume the high-energy limit where the muon mass is negligible compared to the center-of-mass energy $\\sqrt{s}$ of the $e^+ e^-$ beams. Electrons are treated as massless.\n  - Use the fine-structure constant $\\alpha$ as a fixed numerical constant $\\alpha = 1/137.035999084$.\n  - The center-of-mass frame coincides with the laboratory frame, and there is no initial-state radiation.\n  - The parameter $\\theta$ is the center-of-mass energy $\\sqrt{s}$ in $\\mathrm{GeV}$, so that $s = (\\sqrt{s})^2$.\n\n- Scattering theory and phase space:\n  - Start from the $S$-matrix and Fermi’s Golden Rule for relativistic scattering, with the standard flux and phase-space factors for $2\\to 2$ scattering.\n  - For massless final-state muons, in the center-of-mass frame, let $\\theta$ (polar) and $\\varphi$ (azimuth) parametrize the direction of the $\\mu^+$ momentum. Then $d\\Phi_2$ can be written as $d\\Omega = d\\varphi\\, d(\\cos\\theta)$ times known constants, and the differential cross-section can be expressed as a function of $s$ and $\\cos\\theta$.\n  - The unpolarized, spin-averaged squared matrix element $|\\mathcal{M}|^2$ must be derived from QED trace technology, and the resulting differential cross section $d\\sigma/d\\Omega$ must be expressed in terms of $|\\mathcal{M}|^2$, $s$, and constants.\n\n- Transfer function:\n  - The detector transfer function $W(x \\mid \\phi;\\theta)$ is a product of independent Gaussian resolutions on the three Cartesian momentum components of each muon. Let the measured three-momenta be $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^+}$ and $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^-}$, and the true three-momenta (which are functions of $\\phi \\equiv (\\theta,\\varphi)$ and $\\sqrt{s}$) be $\\mathbf{p}^{\\,\\mathrm{true}}_{\\mu^+}(\\phi;\\sqrt{s})$ and $\\mathbf{p}^{\\,\\mathrm{true}}_{\\mu^-}(\\phi;\\sqrt{s}) = -\\mathbf{p}^{\\,\\mathrm{true}}_{\\mu^+}(\\phi;\\sqrt{s})$. The Gaussian transfer function is:\n    $$\n    W(x \\mid \\phi;\\sqrt{s}) \\;=\\; \\prod_{i=1}^{3} \\frac{1}{\\sqrt{2\\pi}\\,\\sigma}\\exp\\!\\left(-\\frac{\\left(p^{\\,\\mathrm{meas}}_{\\mu^+,i}-p^{\\,\\mathrm{true}}_{\\mu^+,i}(\\phi;\\sqrt{s})\\right)^2}{2\\sigma^2}\\right)\\;\n    \\prod_{i=1}^{3} \\frac{1}{\\sqrt{2\\pi}\\,\\sigma}\\exp\\!\\left(-\\frac{\\left(p^{\\,\\mathrm{meas}}_{\\mu^-,i}-p^{\\,\\mathrm{true}}_{\\mu^-,i}(\\phi;\\sqrt{s})\\right)^2}{2\\sigma^2}\\right),\n    $$\n    where $\\sigma$ is the momentum resolution (the same for each Cartesian component).\n  - The true three-momentum magnitude for each muon is $|\\mathbf{p}^{\\,\\mathrm{true}}_{\\mu^\\pm}| = \\sqrt{s}/2$ and the direction of $\\mu^+$ is given by $(\\theta,\\varphi)$, with $\\mu^-$ back-to-back.\n\n- Likelihood and normalization:\n  - Use\n    $$\n    L(x \\mid \\sqrt{s}) \\;=\\; \\frac{1}{\\sigma(s)} \\int d\\Omega \\;\\frac{d\\sigma}{d\\Omega}(s,\\cos\\theta)\\; W(x\\mid \\theta,\\varphi;\\sqrt{s}),\n    $$\n    where $s = (\\sqrt{s})^2$, $d\\Omega = d\\varphi\\, d(\\cos\\theta)$, and $\\sigma(s)$ is the total tree-level cross-section.\n  - All integrations must be performed numerically with deterministic quadrature. Angles must be in radians. The integration domain is $\\cos\\theta \\in [-1,1]$ and $\\varphi \\in [0,2\\pi)$.\n  - You must explicitly compute $\\sigma(s)$ from the same theory as $d\\sigma/d\\Omega$ to ensure a properly normalized likelihood in the sense of the MEM definition above.\n\n- Units:\n  - All momenta must be in $\\mathrm{GeV}$, all energies in $\\mathrm{GeV}$, and all angles in radians.\n  - The final likelihood has units of $\\mathrm{GeV}^{-6}$ due to the Gaussian transfer function being a density in three-momentum space for two particles. Your program must output floating-point values in these units.\n\n- Numerical implementation guidance:\n  - Use Gauss-Legendre quadrature in $u \\equiv \\cos\\theta$ and a uniform trapezoidal rule in $\\varphi$ for $d\\Omega = d\\varphi \\, du$, with sufficiently many points to achieve stable values.\n  - Your code must be self-contained and must not read external input.\n\n- Test suite:\n  - Use the fine-structure constant $\\alpha = 1/137.035999084$.\n  - For each test case below, evaluate $L(x \\mid \\sqrt{s})$ with the specified $\\sqrt{s}$, Gaussian width $\\sigma$ (in $\\mathrm{GeV}$), and measured momenta (in $\\mathrm{GeV}$):\n    1. Happy path:\n       - $\\sqrt{s} = 10.0$\n       - $\\sigma = 0.5$\n       - $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^+} = (4.10,\\,1.10,\\,2.60)$\n       - $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^-} = (-4.00,\\,-1.30,\\,-2.80)$\n    2. Different energy scale:\n       - $\\sqrt{s} = 5.0$\n       - $\\sigma = 0.3$\n       - $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^+} = (-0.70,\\,1.70,\\,-1.60)$\n       - $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^-} = (0.90,\\,-1.80,\\,1.40)$\n    3. Edge case with inconsistent back-to-back topology:\n       - $\\sqrt{s} = 10.0$\n       - $\\sigma = 0.5$\n       - $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^+} = (3.00,\\,0.00,\\,3.00)$\n       - $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^-} = (-2.00,\\,0.50,\\,-3.40)$\n\n- Final output format:\n  - Your program must produce a single line of output containing the three likelihood values, in a Python-style list with commas and no spaces, for example: $\\texttt{[v1,v2,v3]}$. Each $v_i$ must be a floating-point number.\n\nExpress all final answers in units of $\\mathrm{GeV}^{-6}$, and angles in radians. Your program must be fully deterministic and self-contained.", "solution": "The problem is valid as it constitutes a well-defined and self-contained task in computational high-energy physics. It is grounded in the established principles of Quantum Electrodynamics (QED) and scattering theory, and provides all necessary information to derive and implement a numerical solution.\n\nThe objective is to compute the Matrix Element Method (MEM) likelihood $L(x \\mid \\sqrt{s})$ for the process $e^+ e^- \\to \\mu^+ \\mu^-$. The likelihood is given by:\n$$\nL(x \\mid \\sqrt{s}) = \\frac{1}{\\sigma(s)} \\int d\\Omega \\;\\frac{d\\sigma}{d\\Omega}(s,\\cos\\theta)\\; W(x\\mid \\theta,\\varphi;\\sqrt{s})\n$$\nwhere $s = (\\sqrt{s})^2$ is the square of the center-of-mass energy, $d\\Omega = d\\varphi\\, d(\\cos\\theta)$ is the solid angle element, $d\\sigma/d\\Omega$ is the differential cross section, $\\sigma(s)$ is the total cross section, and $W$ is the detector transfer function. The solution requires deriving these components from first principles.\n\n**1. Derivation of the Differential Cross Section $d\\sigma/d\\Omega$**\n\nThe differential cross section for a $2 \\to 2$ scattering process in the center-of-mass (CM) frame, for massless final state particles, is given by Fermi's Golden Rule:\n$$\n\\frac{d\\sigma}{d\\Omega} = \\frac{1}{64\\pi^2 s} \\overline{|\\mathcal{M}|^2}\n$$\nwhere $\\overline{|\\mathcal{M}|^2}$ is the spin-averaged squared matrix element.\n\nThe process is $e^-(p_1) + e^+(p_2) \\to \\mu^-(p_3) + \\mu^+(p_4)$. At tree level in QED, this proceeds via a single virtual photon in the $s$-channel. The matrix element $\\mathcal{M}$ is:\n$$\n\\mathcal{M} = \\frac{e^2}{s} \\left[ \\bar{v}(p_2)\\gamma^\\mu u(p_1) \\right] \\left[ \\bar{u}(p_3)\\gamma_\\mu v(p_4) \\right]\n$$\nwhere $e$ is the elementary charge, $\\gamma^\\mu$ are the Dirac matrices, and $u, v, \\bar{u}, \\bar{v}$ are the particle and anti-particle spinors.\n\nTo compute the unpolarized cross section, we average over initial state spins (a factor of $1/2 \\times 1/2 = 1/4$) and sum over final state spins:\n$$\n\\overline{|\\mathcal{M}|^2} = \\frac{1}{4} \\sum_{\\text{spins}} |\\mathcal{M}|^2 = \\frac{1}{4} \\frac{e^4}{s^2} L_e^{\\mu\\nu} L_{\\mu\\nu}^{\\mu}\n$$\nThe leptonic tensors $L_e^{\\mu\\nu}$ and $L_{\\mu\\nu}^{\\mu}$ result from the spin sums. Using trace technology in the high-energy limit (massless fermions), where $\\sum_s u_s(p)\\bar{u}_s(p) = \\not p$ and $\\sum_s v_s(p)\\bar{v}_s(p) = \\not p$:\n$$\nL_e^{\\mu\\nu} = \\mathrm{Tr}[\\not p_2 \\gamma^\\mu \\not p_1 \\gamma^\\nu] = 4 \\left( p_1^\\mu p_2^\\nu + p_1^\\nu p_2^\\mu - g^{\\mu\\nu}(p_1 \\cdot p_2) \\right)\n$$\n$$\nL_{\\mu\\nu}^{\\mu} = \\mathrm{Tr}[\\not p_3 \\gamma_\\mu \\not p_4 \\gamma_\\nu] = 4 \\left( p_{3\\mu} p_{4\\nu} + p_{3\\nu} p_{4\\mu} - g_{\\mu\\nu}(p_3 \\cdot p_4) \\right)\n$$\nThe contraction of these tensors is most easily expressed using Mandelstam variables. For a massless process, $s=(p_1+p_2)^2$, $t=(p_1-p_3)^2$, $u=(p_1-p_4)^2$, with $s+t+u=0$.\n$p_1 \\cdot p_2 = s/2$, $p_3 \\cdot p_4 = s/2$.\n$p_1 \\cdot p_3 = p_2 \\cdot p_4 = -t/2$.\n$p_1 \\cdot p_4 = p_2 \\cdot p_3 = -u/2$.\nThe tensor contraction yields:\n$$\nL_e^{\\mu\\nu} L_{\\mu\\nu}^{\\mu} = 32 \\left( (p_1 \\cdot p_3)(p_2 \\cdot p_4) + (p_1 \\cdot p_4)(p_2 \\cdot p_3) \\right) = 32 \\left( \\frac{t^2}{4} + \\frac{u^2}{4} \\right) = 8(t^2+u^2)\n$$\nThus, the squared matrix element is:\n$$\n\\overline{|\\mathcal{M}|^2} = \\frac{1}{4} \\frac{e^4}{s^2} \\left[ 8(t^2+u^2) \\right] = \\frac{2e^4}{s^2}(t^2+u^2)\n$$\nIn the CM frame, let $\\theta$ be the angle between the incoming electron and the outgoing $\\mu^-$. The Mandelstam variables are:\n$t = (p_1-p_3)^2 = -2 p_1 \\cdot p_3 = -2 \\frac{\\sqrt{s}}{2} \\frac{\\sqrt{s}}{2} (1 - \\cos\\theta) = -\\frac{s}{2}(1-\\cos\\theta)$\n$u = (p_1-p_4)^2 = -2 p_1 \\cdot p_4 = -2 \\frac{\\sqrt{s}}{2} \\frac{\\sqrt{s}}{2} (1 + \\cos\\theta) = -\\frac{s}{2}(1+\\cos\\theta)$\nSubstituting these into the expression for $\\overline{|\\mathcal{M}|^2}$:\n$$\n\\overline{|\\mathcal{M}|^2} = \\frac{2e^4}{s^2} \\left[ \\frac{s^2}{4}(1-\\cos\\theta)^2 + \\frac{s^2}{4}(1+\\cos\\theta)^2 \\right] = \\frac{e^4}{2} \\left[ (1-2\\cos\\theta+\\cos^2\\theta) + (1+2\\cos\\theta+\\cos^2\\theta) \\right] = e^4(1+\\cos^2\\theta)\n$$\nUsing the fine-structure constant $\\alpha = e^2/(4\\pi)$ in natural units, we have $e^4 = 16\\pi^2\\alpha^2$.\n$$\n\\overline{|\\mathcal{M}|^2} = 16\\pi^2\\alpha^2(1+\\cos^2\\theta)\n$$\nFinally, the differential cross section is:\n$$\n\\frac{d\\sigma}{d\\Omega} = \\frac{1}{64\\pi^2 s} \\left[ 16\\pi^2\\alpha^2(1+\\cos^2\\theta) \\right] = \\frac{\\alpha^2}{4s}(1+\\cos^2\\theta)\n$$\n\n**2. Calculation of the Total Cross Section $\\sigma(s)$**\n\nThe total cross section $\\sigma(s)$ is the normalization factor for the likelihood. It is obtained by integrating the differential cross section over the full solid angle:\n$$\n\\sigma(s) = \\int \\frac{d\\sigma}{d\\Omega} d\\Omega = \\int_0^{2\\pi} d\\varphi \\int_{-1}^{1} d(\\cos\\theta) \\frac{\\alpha^2}{4s}(1+\\cos^2\\theta)\n$$\nThe integral over $\\varphi$ gives $2\\pi$. Let $u = \\cos\\theta$:\n$$\n\\sigma(s) = 2\\pi \\frac{\\alpha^2}{4s} \\int_{-1}^{1} (1+u^2) du = \\frac{\\pi\\alpha^2}{2s} \\left[ u + \\frac{u^3}{3} \\right]_{-1}^{1} = \\frac{\\pi\\alpha^2}{2s} \\left[ \\left(1+\\frac{1}{3}\\right) - \\left(-1-\\frac{1}{3}\\right) \\right] = \\frac{\\pi\\alpha^2}{2s} \\left(\\frac{8}{3}\\right)\n$$\n$$\n\\sigma(s) = \\frac{4\\pi\\alpha^2}{3s}\n$$\n\n**3. Assembling the Likelihood Integrand**\n\nThe likelihood expression involves the ratio $\\frac{1}{\\sigma(s)}\\frac{d\\sigma}{d\\Omega}$, which defines a normalized probability distribution over the solid angle:\n$$\n\\frac{1}{\\sigma(s)}\\frac{d\\sigma}{d\\Omega} = \\frac{3s}{4\\pi\\alpha^2} \\cdot \\frac{\\alpha^2}{4s}(1+\\cos^2\\theta) = \\frac{3}{16\\pi}(1+\\cos^2\\theta)\n$$\nThe full likelihood expression is therefore:\n$$\nL(x \\mid \\sqrt{s}) = \\int_0^{2\\pi} d\\varphi \\int_{-1}^{1} d(\\cos\\theta) \\left( \\frac{3}{16\\pi}(1+\\cos^2\\theta) \\right) W(x \\mid \\theta,\\varphi;\\sqrt{s})\n$$\n\n**4. Transfer Function**\n\nThe transfer function $W(x \\mid \\phi;\\sqrt{s})$ connects the true partonic momenta $\\mathbf{p}^{\\text{true}}_{\\mu^\\pm}$ to the measured momenta $\\mathbf{p}^{\\text{meas}}_{\\mu^\\pm}$. It is a product of six Gaussians:\n$$\nW(x \\mid \\phi;\\sqrt{s}) = \\left(\\frac{1}{\\sqrt{2\\pi}\\,\\sigma}\\right)^6 \\exp\\left(-\\frac{\\left|\\mathbf{p}^{\\text{meas}}_{\\mu^+} - \\mathbf{p}^{\\text{true}}_{\\mu^+}\\right|^2 + \\left|\\mathbf{p}^{\\text{meas}}_{\\mu^-} - \\mathbf{p}^{\\text{true}}_{\\mu^-}\\right|^2}{2\\sigma^2}\\right)\n$$\nIn the CM frame, $\\mathbf{p}^{\\text{true}}_{\\mu^-} = -\\mathbf{p}^{\\text{true}}_{\\mu^+}$. The magnitude is $|\\mathbf{p}^{\\text{true}}_{\\mu^+}| = \\sqrt{s}/2$. The direction of $\\mathbf{p}^{\\text{true}}_{\\mu^+}$ is parametrized by the integration variables $(\\theta, \\varphi)$:\n$$\n\\mathbf{p}^{\\text{true}}_{\\mu^+}(\\theta, \\varphi) = \\frac{\\sqrt{s}}{2} \\begin{pmatrix} \\sin\\theta\\cos\\varphi \\\\ \\sin\\theta\\sin\\varphi \\\\ \\cos\\theta \\end{pmatrix}\n$$\nThe exponent's argument can be expanded for efficient computation:\n$$ \\mathcal{E} = -\\frac{1}{2\\sigma^2} \\left[ |\\mathbf{p}^{\\text{meas}}_{\\mu^+}|^2 + |\\mathbf{p}^{\\text{meas}}_{\\mu^-}|^2 + 2|\\mathbf{p}^{\\text{true}}_{\\mu^+}|^2 - 2(\\mathbf{p}^{\\text{meas}}_{\\mu^+} - \\mathbf{p}^{\\text{meas}}_{\\mu^-}) \\cdot \\mathbf{p}^{\\text{true}}_{\\mu^+} \\right] $$\n$$ \\mathcal{E} = -\\frac{1}{2\\sigma^2} \\left[ |\\mathbf{p}^{\\text{meas}}_{\\mu^+}|^2 + |\\mathbf{p}^{\\text{meas}}_{\\mu^-}|^2 + \\frac{s}{2} - 2(\\mathbf{p}^{\\text{meas}}_{\\mu^+} - \\mathbf{p}^{\\text{meas}}_{\\mu^-}) \\cdot \\mathbf{p}^{\\text{true}}_{\\mu^+}(\\theta, \\varphi) \\right] $$\nThe terms in brackets that do not depend on $(\\theta, \\varphi)$ can be pre-calculated.\n\n**5. Numerical Integration**\n\nThe final integral is computed numerically. We use Gauss-Legendre quadrature for the integration over $u = \\cos\\theta \\in [-1, 1]$ and the trapezoidal rule for the integration over $\\varphi \\in [0, 2\\pi)$.\nLet $u_i, w_i$ be the $N_u$ Gauss-Legendre points and weights. Let $\\varphi_j = j \\frac{2\\pi}{N_\\varphi}$ for $j=0, \\dots, N_\\varphi-1$ be the uniform points for the trapezoidal rule. The discretized integral is:\n$$\nL \\approx \\sum_{i=1}^{N_u} w_i \\left( \\frac{2\\pi}{N_\\varphi} \\sum_{j=0}^{N_\\varphi-1} \\left[ \\frac{3}{16\\pi}(1+u_i^2) \\right] W(x \\mid \\theta_i, \\varphi_j; \\sqrt{s}) \\right)\n$$\nwhere $\\cos\\theta_i = u_i$. This provides a deterministic and accurate evaluation of the likelihood.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import roots_legendre\n\ndef solve():\n    \"\"\"\n    Main function to calculate MEM likelihood for specified test cases.\n    \"\"\"\n    # Define constants\n    N_U = 64  # Number of points for cos(theta) integration (Gauss-Legendre)\n    N_PHI = 64  # Number of points for phi integration (Trapezoidal)\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (sqrt_s, sigma, p_mu_plus_meas, p_mu_minus_meas) in GeV\n        (10.0, 0.5, (4.10, 1.10, 2.60), (-4.00, -1.30, -2.80)),\n        (5.0, 0.3, (-0.70, 1.70, -1.60), (0.90, -1.80, 1.40)),\n        (10.0, 0.5, (3.00, 0.00, 3.00), (-2.00, 0.50, -3.40)),\n    ]\n\n    results = []\n    for case in test_cases:\n        sqrt_s, sigma, p_plus_meas, p_minus_meas = case\n        likelihood = calculate_likelihood(sqrt_s, sigma, p_plus_meas, p_minus_meas, N_U, N_PHI)\n        results.append(f\"{likelihood:.6e}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef calculate_likelihood(sqrt_s, sigma, p_mu_plus_meas, p_mu_minus_meas, n_u, n_phi):\n    \"\"\"\n    Calculates the MEM likelihood for a single event.\n\n    Args:\n        sqrt_s (float): Center-of-mass energy in GeV.\n        sigma (float): Momentum resolution (Gaussian width) in GeV.\n        p_mu_plus_meas (tuple): 3-momentum of the measured mu+.\n        p_mu_minus_meas (tuple): 3-momentum of the measured mu-.\n        n_u (int): Number of integration points for cos(theta).\n        n_phi (int): Number of integration points for phi.\n\n    Returns:\n        float: The calculated likelihood value in GeV^-6.\n    \"\"\"\n    s = sqrt_s**2\n\n    # Convert measured momenta to numpy arrays\n    p_plus = np.array(p_mu_plus_meas)\n    p_minus = np.array(p_mu_minus_meas)\n\n    # --- Pre-calculate terms for the transfer function exponent ---\n    # The exponent is -(constant_part + vector_part . p_true) / (2*sigma^2)\n    \n    # Constant part of the numerator: |p_meas+|^2 + |p_meas-|^2 + 2*|p_true|^2\n    # where |p_true|^2 = (sqrt_s/2)^2 = s/4\n    exp_const_part = np.dot(p_plus, p_plus) + np.dot(p_minus, p_minus) + s / 2.0\n\n    # Coefficient for the vector part of the numerator: -2 * (p_meas+ - p_meas-)\n    exp_vec_coeff = -2.0 * (p_plus - p_minus)\n    \n    # Overall prefactor for the transfer function W\n    w_prefactor = (1.0 / (np.sqrt(2 * np.pi) * sigma))**6\n    \n    # --- Numerical Integration Setup ---\n    # Gauss-Legendre quadrature for u = cos(theta) in [-1, 1]\n    u_points, u_weights = roots_legendre(n_u)\n    # Trapezoidal rule for phi in [0, 2*pi)\n    phi_points = np.linspace(0, 2 * np.pi, n_phi, endpoint=False)\n    d_phi = 2 * np.pi / n_phi\n    \n    integral_sum = 0.0\n    true_p_mag = sqrt_s / 2.0\n    \n    # Outer loop: integration over u = cos(theta)\n    for i in range(n_u):\n        u = u_points[i]\n        w_u = u_weights[i]\n        \n        # sin(theta) can be derived from u = cos(theta)\n        sin_theta = np.sqrt(1.0 - u**2)\n        \n        # The normalized QED matrix element part of the integrand\n        # P(Omega) = (3 / (16*pi)) * (1 + cos_theta^2)\n        matrix_element_part = (3.0 / (16.0 * np.pi)) * (1.0 + u**2)\n        \n        phi_integral_sum = 0.0\n        # Inner loop: integration over phi\n        for j in range(n_phi):\n            phi = phi_points[j]\n            \n            # Construct the true mu+ momentum vector for this integration point\n            p_true = np.array([\n                true_p_mag * sin_theta * np.cos(phi),\n                true_p_mag * sin_theta * np.sin(phi),\n                true_p_mag * u\n            ])\n            \n            # --- Calculate the Transfer Function W ---\n            dot_product = np.dot(exp_vec_coeff, p_true)\n            exponent_numerator = exp_const_part + dot_product\n            exponent = -exponent_numerator / (2.0 * sigma**2)\n            \n            w_val = w_prefactor * np.exp(exponent)\n            \n            # Full integrand for this (u_i, phi_j) point\n            integrand = matrix_element_part * w_val\n            phi_integral_sum += integrand\n\n        # Accumulate the phi-integrated result (trapezoidal sum)\n        # weighted by the Gauss-Legendre weight for this u_i\n        integral_sum += w_u * (phi_integral_sum * d_phi)\n        \n    return integral_sum\n\nif __name__ == \"__main__\":\n    solve()\n```", "id": "3522061"}, {"introduction": "While the principles of MEM are universal, real-world applications at hadron colliders introduce a significant challenge: combinatorial ambiguity. When an event has multiple jets, we don't know *a priori* which jet corresponds to which final-state parton. This practice [@problem_id:3522033] demonstrates how to handle this by constructing the event likelihood as a sum over all possible jet-parton permutations for a realistic $t\\bar{t}$ decay, and shows how to incorporate crucial external information like $b$-tagging to help resolve the ambiguity.", "problem": "Consider a single event consistent with top–antitop production and decay in the Standard Model (SM) channel $t\\bar{t}\\to W^{+}b\\, W^{-}\\bar{b}\\to \\ell \\nu + 4$ jets, where exactly $4$ reconstructed jets are present and all come from the partons $\\{b_{\\text{lep}}, b_{\\text{had}}, q, q^{\\prime}\\}$, with $\\ell$ denoting an electron or muon and $\\nu$ the corresponding neutrino. You will use the Matrix Element Method (MEM) to write down the event probability density, including a sum over jet–parton assignments and per-jet $b$-tag information. Assume the following idealizations, which are standard and scientifically consistent for this purpose:\n\n- The two light quarks $\\{q, q^{\\prime}\\}$ from hadronic $W$ decay are indistinguishable in the squared matrix element.\n- The observed event record $x$ consists of the measured lepton four-momentum, missing transverse momentum, the four jet four-momenta $\\{p_{1},p_{2},p_{3},p_{4}\\}$, and binary $b$-tag bits $\\{t_{1},t_{2},t_{3},t_{4}\\}$ with $t_{j}\\in\\{0,1\\}$.\n- The $b$-tag response model is independent across jets and depends only on the true parton flavor assigned to that jet: for a jet originating from a $b$ quark, $P(t_{j}=1|b)=\\varepsilon_{b}$ and $P(t_{j}=0|b)=1-\\varepsilon_{b}$; for a jet originating from a light quark ($u$, $d$, $s$) or a gluon, $P(t_{j}=1|\\text{light})=\\varepsilon_{q}$ and $P(t_{j}=0|\\text{light})=1-\\varepsilon_{q}$, with $0<\\varepsilon_{q}<\\varepsilon_{b}<1$.\n- The event probability density in MEM is constructed by convolving the fully differential partonic cross section with detector transfer functions and normalizing by the inclusive cross section. Use a factorized transfer function $W(x|y;\\alpha)$ that encodes the mapping, under a given jet–parton assignment $\\alpha$, from the parton-level kinematics $y$ to the measured $x$; you may keep $W(x|y;\\alpha)$ symbolic.\n- The initial-state hadrons are unpolarized protons, and the initial parton momentum fractions are integrated over with Parton Distribution Functions (PDFs). Denote the hadronic center-of-mass energy by $\\sqrt{s}$, the partonic center-of-mass energy by $\\hat{s}=x_{1}x_{2}s$, and include the usual flux factor.\n\nTasks:\n\n(a) Using only the particle content of the final state and the indistinguishability of the hadronic $W\\to q q^{\\prime}$ decay products in the squared matrix element, compute the number of inequivalent jet–parton permutations that must be summed in MEM for this topology when there are exactly $4$ reconstructed jets.\n\n(b) Starting from the definition that the MEM event probability density is proportional to the partonic differential cross section convolved with detector transfer functions and normalized by the total cross section, construct the permutation-summed event likelihood $L(x|\\theta)$ for model parameters $\\theta$. Your expression must:\n- Sum over all inequivalent jet–parton assignments obtained in part (a).\n- Sum over initial-state parton flavors.\n- Integrate over the parton momentum fractions and the full final-state phase space for $t\\bar{t}\\to \\ell \\nu b \\bar{b} q q^{\\prime}$.\n- Include the flux factor and the squared matrix element.\n- Multiply each assignment’s kinematic integral by the product of per-jet $b$-tag probabilities implied by that assignment and the observed tag bits $\\{t_{j}\\}$.\n\n(c) Provide your final result as a single, closed-form analytic expression for $L(x|\\theta)$ in which the upper limit of the permutation sum is the explicit number obtained in part (a), and where the per-jet $b$-tag factor is written using indicator functions that identify whether, under a given assignment, a jet is mapped to a $b$ or a light quark. The expression must be a single line mathematical formula. No numerical evaluation is required and no units should be included in the final expression.", "solution": "The user has provided a problem in computational high-energy physics concerning the Matrix Element Method (MEM). I will first validate the problem statement.\n\n### Problem Validation\n\n**Step 1: Extract Givens**\n- **Process**: Top-antitop production and decay $t\\bar{t}\\to W^{+}b\\, W^{-}\\bar{b}\\to \\ell \\nu + 4$ jets.\n- **Partons giving rise to jets**: $\\{b_{\\text{lep}}, b_{\\text{had}}, q, q^{\\prime}\\}$.\n- **Indistinguishability**: The light quarks $\\{q, q^{\\prime}\\}$ from the hadronic $W$ boson decay are indistinguishable in the squared matrix element.\n- **Observed Event Data ($x$)**: Measured lepton four-momentum, missing transverse momentum, four jet four-momenta $\\{p_{1},p_{2},p_{3},p_{4}\\}$, and four binary $b$-tagging bits $\\{t_{1},t_{2},t_{3},t_{4}\\}$ where $t_{j}\\in\\{0,1\\}$.\n- **B-tagging Model**:\n    - Per-jet independence.\n    - $P(t_{j}=1|b)=\\varepsilon_{b}$ and $P(t_{j}=0|b)=1-\\varepsilon_{b}$.\n    - $P(t_{j}=1|\\text{light})=\\varepsilon_{q}$ and $P(t_{j}=0|\\text{light})=1-\\varepsilon_{q}$.\n    - Efficiency and mistag rate constraint: $0<\\varepsilon_{q}<\\varepsilon_{b}<1$.\n- **MEM Formulation**:\n    - The event probability density is proportional to the convolution of the fully differential partonic cross section with detector transfer functions, normalized by the inclusive cross section.\n    - Transfer function is a factorized function $W(x|y;\\alpha)$ kept in symbolic form.\n- **Initial State**: Unpolarized protons, integration over parton momentum fractions $x_1, x_2$ with Parton Distribution Functions (PDFs), hadronic center-of-mass energy $\\sqrt{s}$, partonic center-of-mass energy $\\hat{s}=x_{1}x_{2}s$, and inclusion of the flux factor.\n\n**Step 2: Validate Using Extracted Givens**\n- **Scientifically Grounded**: The problem is firmly rooted in the Standard Model of particle physics and employs the Matrix Element Method, a standard, well-established technique in experimental high-energy physics data analysis. All concepts, including $t\\bar{t}$ production, PDFs, matrix elements, transfer functions, and $b$-tagging, are standard and scientifically sound.\n- **Well-Posed**: The problem is structured into three clear, sequential tasks. Part (a) is a well-defined combinatorial problem. Part (b) and (c) request the construction of a mathematical object (the likelihood function) based on explicitly stated physical principles and components. The level of abstraction (e.g., symbolic matrix element and transfer function) is appropriate for a theoretical problem and does not render it unsolvable.\n- **Objective**: The language is technical, precise, and free of any subjectivity or ambiguity.\n\nThe problem statement does not violate any of the invalidity criteria. It is scientifically sound, well-posed, objective, complete, and non-trivial.\n\n**Verdict**: The problem is **valid**.\n\n### Solution\n\nThe solution proceeds by addressing each of the three tasks in order.\n\n**(a) Number of Inequivalent Jet–Parton Permutations**\n\nThe task is to determine the number of distinct ways to assign the four final-state partons $\\{b_{\\text{lep}}, b_{\\text{had}}, q, q^{\\prime}\\}$ to the four reconstructed jets $\\{p_1, p_2, p_3, p_4\\}$. A specific assignment is a permutation that maps each jet to a unique parton.\n\n- The four jets are distinguishable by their measured properties (e.g., four-momenta).\n- The four partons must be carefully considered. The labels $b_{\\text{lep}}$ and $b_{\\text{had}}$ denote the $b$-quarks originating from the top quarks that decay leptonically and hadronically, respectively. These are distinct physical hypotheses in the context of event reconstruction, as associating a jet with $b_{\\text{lep}}$ versus $b_{\\text{had}}$ leads to different kinematic configurations for the parent top quarks. Therefore, $b_{\\text{lep}}$ and $b_{\\text{had}}$ are treated as distinguishable.\n- The problem states that the light quarks from the hadronic $W$ decay, $\\{q, q^{\\prime}\\}$, are \"indistinguishable in the squared matrix element\". This is a standard simplification in MEM that implies that any two permutations that differ only by swapping the assignments of $q$ and $q^{\\prime}$ between two jets will yield the same value for the kinematic part of the likelihood integrand. Consequently, they do not represent distinct hypotheses and should be counted as a single \"inequivalent\" permutation.\n\nWe are therefore counting the number of permutations of a multiset of parton roles to be assigned to the four distinct jets. The set of roles is $\\{b_{\\text{lep}}, b_{\\text{had}}, \\text{light}, \\text{light}\\}$. We have $N=4$ items (the jet slots) and want to arrange $k_1=1$ object of type $b_{\\text{lep}}$, $k_2=1$ object of type $b_{\\text{had}}$, and $k_3=2$ objects of type 'light quark'. The number of such distinct permutations is given by the multinomial coefficient:\n$$ \\frac{N!}{k_1! k_2! k_3!} = \\frac{4!}{1! \\, 1! \\, 2!} = \\frac{24}{2} = 12 $$\nThus, there are $12$ inequivalent jet-parton permutations that must be summed over.\n\n**(b) Construction of the Event Likelihood**\n\nThe event probability density, which we take as the likelihood $L(x|\\theta)$, is defined as the normalized differential cross section for producing the observed event $x$, given model parameters $\\theta$. The general formula is:\n$$ L(x|\\theta) = \\frac{1}{\\sigma_{\\text{tot}}(\\theta)} \\frac{d\\sigma(x|\\theta)}{dx} $$\nThe term $\\frac{d\\sigma(x|\\theta)}{dx}$ is obtained by summing over all possible intermediate steps that could lead to the observation $x$. This involves:\n1.  A sum over all possible initial-state parton pairings, denoted by indices $i, j$.\n2.  An integral over the momentum fractions $x_1, x_2$ of these partons, weighted by their respective PDFs, $f_{i,j}(x,Q^2)$.\n3.  The partonic interaction itself, described by the squared matrix element $|\\mathcal{M}_{ij \\to f}(y;\\theta)|^2$, where $y$ represents the final-state parton momenta. This is weighted by the relativistic flux factor, $1/(2\\hat{s}) = 1/(2x_1x_2s)$.\n4.  An integral over the full Lorentz-invariant phase space $d\\Phi(y)$ of the final-state partons.\n5.  Convolution with a detector transfer function $W(x|y;\\alpha)$, which gives the probability of observing the state $x$ given the partonic state $y$ and a specific jet-parton assignment $\\alpha$.\n6.  A sum over all inequivalent jet-parton assignments, $\\alpha_k$, as determined in part (a).\n7.  A multiplicative factor for the probability of observing the $b$-tag configuration $\\{t_j\\}$ given an assignment $\\alpha_k$.\n\nCombining these elements, the unnormalized probability is constructed as a sum over permutations, where each term involves an integral over the latent variables (parton kinematics). The b-tagging probability for a given assignment $\\alpha_k$, $P_b(\\{t_j\\}|\\alpha_k)$, is constant with respect to the kinematic integrals and can be factored out. This probability is the product of individual jet tagging probabilities, which depend on the true flavor of the parton assigned to the jet.\n$$ P_b(\\{t_j\\}|\\alpha_k) = \\prod_{j=1}^4 P(t_j|\\text{flavor}(\\alpha_k(p_j))) $$\nThe full expression is then constructed by assembling these components, following the structure prescribed by the MEM framework.\n\n**(c) Final Analytic Expression for the Likelihood**\n\nHere we write the complete expression for $L(x|\\theta)$, incorporating the results from (a) and (b). Let $\\mathcal{A} = \\{\\alpha_k\\}_{k=1}^{12}$ be the set of the $12$ inequivalent jet-parton assignments. Let $I_b(\\alpha_k, j)$ be an indicator function that is $1$ if jet $j$ is assigned to a $b$-quark ($b_{\\text{lep}}$ or $b_{\\text{had}}$) under assignment $\\alpha_k$, and $0$ otherwise. Similarly, let $I_q(\\alpha_k, j) = 1 - I_b(\\alpha_k, j)$ be the indicator for assignment to a light quark ($q$ or $q^{\\prime}$). The final state is $f = \\{\\ell, \\nu, b, \\bar{b}, q, q^{\\prime}\\}$, with parton momenta collectively denoted by $y$. The normalization factor $\\sigma(\\theta)$ is the total theoretical cross section for the signal process, given by integrating the differential partonic cross section over the full phase space and PDFs, without the transfer function or b-tagging probabilities. The likelihood is:\n$$ L(x|\\theta) = \\frac{1}{\\sigma(\\theta)} \\sum_{i,j} \\sum_{k=1}^{12} \\left( \\prod_{j=1}^4 \\left[\\varepsilon_b^{t_j}(1-\\varepsilon_b)^{1-t_j}\\right]^{I_b(\\alpha_k,j)} \\left[\\varepsilon_q^{t_j}(1-\\varepsilon_q)^{1-t_j}\\right]^{I_q(\\alpha_k,j)} \\right) \\int_0^1 \\!\\! dx_1 \\int_0^1 \\!\\! dx_2 \\frac{f_i(x_1,Q^2)f_j(x_2,Q^2)}{2x_1x_2s} \\int \\! d\\Phi(y) |\\mathcal{M}_{ij \\to f}(y;\\theta)|^2 W(x|y;\\alpha_k) $$\n\nThis expression represents the complete probability density for observing the event $x$ under the specified model and assumptions. It sums over all contributing initial states ($i,j$) and all distinguishable final-state configurations (the $12$ permutations), weighting each by its corresponding $b$-tagging probability and convolving the theoretical prediction with the detector response.", "answer": "$$\\boxed{\\frac{1}{\\sigma(\\theta)} \\sum_{i,j} \\sum_{k=1}^{12} \\left( \\prod_{j=1}^4 \\left[\\varepsilon_b^{t_j}(1-\\varepsilon_b)^{1-t_j}\\right]^{I_b(\\alpha_k,j)} \\left[\\varepsilon_q^{t_j}(1-\\varepsilon_q)^{1-t_j}\\right]^{I_q(\\alpha_k,j)} \\right) \\int_0^1 \\! dx_1 \\int_0^1 \\! dx_2 \\frac{f_i(x_1,Q^2)f_j(x_2,Q^2)}{2x_1x_2s} \\int \\! d\\Phi(y) |\\mathcal{M}_{ij \\to f}(y;\\theta)|^2 W(x|y;\\alpha_k)}$$", "id": "3522033"}, {"introduction": "After setting up the formal structure for handling combinatorial ambiguity, it is crucial to understand what the sum over permutations accomplishes from a statistical standpoint. This hands-on exercise [@problem_id:3522084] provides a focused, numerical implementation of this sum for a simplified three-jet system. By marginalizing over all possible assignments, you will not only calculate the total event likelihood but also use Bayes' rule to determine the posterior probability of each assignment, offering a quantitative measure of which physical interpretation is most favored by the data.", "problem": "You are tasked with constructing and implementing, from first principles, a simplified but faithful computation that captures the core of the matrix element method for high-energy physics event likelihoods with indistinguishable final-state partons. Your program must perform a full marginalization over jet–parton permutations with appropriate symmetry factors, and then study the posterior distribution over jet–parton assignments, including aggregation over equivalence classes induced by indistinguishability.\n\nStart from the following foundational bases only: (i) Bayes’ rule, (ii) the sum rule of probability, and (iii) indistinguishability of identical final-state quanta as a symmetry that induces quotienting by label permutations and thus introduces a symmetry factor equal to the factorial of each multiplicity of identical particles. You must derive the expressions needed to compute an event’s marginalized likelihood over all jet–parton assignments and the posterior over assignments. No other starting formulas are permitted in your derivation.\n\nIn this problem, there are $3$ final-state partons and $3$ reconstructed jets. The parton flavor content is one bottom quark and two indistinguishable light quarks, i.e., the multiset $\\{b, q, q\\}$. The indistinguishability of the two light quarks implies that exchanging their labels does not produce a distinct physical final state; therefore the corresponding symmetry factor is the product over multiplicities of identical particles, here $2!$ for the two light quarks and $1!$ for the bottom quark, so the overall factor is $2$. Assume a uniform prior over all jet–parton permutations consistent with this indistinguishability.\n\nFor computation, you are provided, for each test case, a $3 \\times 3$ nonnegative matrix $K$ of transfer weights, where $K_{i k}$ is proportional to the probability density for parton index $i$ to be reconstructed as jet index $k$. The parton indices are ordered as $i = 0$ for $b$, $i = 1$ for $q_{1}$, and $i = 2$ for $q_{2}$. The jet indices are $k \\in \\{0,1,2\\}$. Your derivation must use only the provided foundational bases to obtain how to: (a) marginalize over all bijective assignments $\\pi$ from partons to jets to obtain a scalar marginalized event likelihood for each test case, and (b) compute the posterior over assignments given the event, both for individual permutations and for equivalence classes under exchanging the two light-quark labels. You must explicitly account for the indistinguishability symmetry in the marginalization.\n\nYou must use the following test suite of three cases, each specified by the transfer weight matrix $K$:\n\n- Case $1$ (discriminating): \n$$\nK^{(1)} \\;=\\; \n\\begin{pmatrix}\n0.90 & 0.05 & 0.05 \\\\\n0.10 & 0.45 & 0.45 \\\\\n0.10 & 0.50 & 0.40\n\\end{pmatrix}.\n$$\n\n- Case $2$ (ambiguous jets with identical columns $1$ and $2$): \n$$\nK^{(2)} \\;=\\; \n\\begin{pmatrix}\n0.40 & 0.30 & 0.30 \\\\\n0.20 & 0.40 & 0.40 \\\\\n0.20 & 0.40 & 0.40\n\\end{pmatrix}.\n$$\n\n- Case $3$ (nearly symmetric): \n$$\nK^{(3)} \\;=\\; \n\\begin{pmatrix}\n0.34 & 0.33 & 0.33 \\\\\n0.33 & 0.34 & 0.33 \\\\\n0.33 & 0.33 & 0.34\n\\end{pmatrix}.\n$$\n\nYour program must, for each case, do all of the following:\n\n- Enumerate all permutations $\\pi$ of the jets assigned to the ordered parton list $(b,q_{1},q_{2})$, in the fixed lexicographic order of tuples $(\\pi(0),\\pi(1),\\pi(2))$: \n$\\left(0,1,2\\right)$, $\\left(0,2,1\\right)$, $\\left(1,0,2\\right)$, $\\left(1,2,0\\right)$, $\\left(2,0,1\\right)$, $\\left(2,1,0\\right)$.\n- Using only the fundamental bases above, derive and implement the event’s marginalized likelihood over all $\\pi$ with the correct symmetry factor for the two identical light quarks.\n- Compute, for each individual permutation in the fixed order above, the posterior probability of that permutation given the event.\n- Define the three equivalence classes by the jet chosen for the bottom quark, i.e., class $0$ is $\\{\\pi:\\pi(0)=0\\}$, class $1$ is $\\{\\pi:\\pi(0)=1\\}$, and class $2$ is $\\{\\pi:\\pi(0)=2\\}$. Compute the posterior probability for each class by aggregating the posterior over permutations in that class.\n\nNumerical requirements:\n\n- All quantities are dimensionless; do not attach physical units.\n- Your program must output, for each of the three cases in order, a sequence of $10$ floating-point numbers: first the marginalized likelihood, then the $6$ posterior probabilities for the individual permutations in the fixed order above, then the $3$ class-posteriors in the order bottom-jet $0$, bottom-jet $1$, bottom-jet $2$.\n- Each floating-point number must be rounded to exactly $6$ decimal places.\n\nFinal output format:\n\n- Your program should produce a single line of output containing the concatenation of all three cases’ results as a comma-separated list enclosed in square brackets. The list therefore contains $30$ numbers. For example, the structure must be \n$[\\text{L}^{(1)},p^{(1)}_{\\pi_{1}},\\dots,p^{(1)}_{\\pi_{6}},P^{(1)}_{b\\to 0},P^{(1)}_{b\\to 1},P^{(1)}_{b\\to 2},\\text{L}^{(2)},\\dots,\\text{L}^{(3)},\\dots]$ \nwith all values rounded to $6$ decimals.", "solution": "The problem requires the derivation and implementation of a calculation for event likelihoods and posteriors in a simplified high-energy physics scenario, based on first principles. The system consists of three final-state partons—one bottom quark ($b$, index $0$) and two indistinguishable light quarks ($q_1$, index $1$; $q_2$, index $2$)—and three reconstructed jets (indices $0, 1, 2$). The provided data is a $3 \\times 3$ matrix $K$, where $K_{ik}$ is a weight proportional to the probability density of parton $i$ being observed as jet $k$.\n\nThe derivation will proceed from the foundational bases of (i) Bayes’ rule, (ii) the sum rule of probability, and (iii) the principle of quantum indistinguishability.\n\nLet $\\vec{y}$ denote the observed event data, which in this problem is encapsulated by the matrix $K$. A specific parton-to-jet assignment is a bijection $\\pi: \\{0,1,2\\} \\to \\{0,1,2\\}$, where $\\pi(i)$ is the jet index assigned to parton $i$. The set of all such bijections is the symmetric group $S_3$, which has $3! = 6$ elements.\n\n**1. Likelihood of a Single Labeled Assignment**\n\nFor a given assignment $\\pi$, the partons are mapped to distinct jets. Assuming the processes of parton-to-jet reconstruction are independent for each parton in the assignment, the total likelihood for the assignment is the product of the individual weights. We define the likelihood of the event data $\\vec{y}$ given a specific labeled assignment $\\pi$, denoted $L(\\pi)$, as:\n$$L(\\pi) \\equiv p(\\vec{y}|\\pi) = K_{0,\\pi(0)} \\cdot K_{1,\\pi(1)} \\cdot K_{2,\\pi(2)}$$\nThis quantity represents the likelihood for one specific permutation of the labeled partons $(b, q_1, q_2)$. Any overall proportionality constant is omitted, as it does not affect the calculation of the posteriors and represents a global normalization of the problem that is not specified.\n\n**2. Marginalized Event Likelihood**\n\nThe total, or marginalized, event likelihood $L_{\\text{event}}$ is proportional to the total probability of observing the event $\\vec{y}$, summed over all possible intermediate configurations that can produce it. Here, the intermediate configurations are the parton-jet assignments.\n\nThe **sum rule of probability** dictates that we must sum over a set of mutually exclusive, exhaustive possibilities. The core physical possibilities are the assignments of partons to jets. However, the **principle of indistinguishability** for the two identical light quarks ($q_1, q_2$) implies that swapping their assigned jets does not result in a new, physically distinct final state. For example, the assignment $(b \\to j_0, q_1 \\to j_1, q_2 \\to j_2)$ is physically indistinguishable from $(b \\to j_0, q_1 \\to j_2, q_2 \\to j_1)$.\n\nTo correctly calculate the total likelihood, we must sum over distinguishable physical states. A standard technique derived from quantum mechanics is to sum over all permutations of the *labeled* particles and then divide by a symmetry factor $S$ to correct for the overcounting of identical states. The symmetry factor $S$ is the product of the factorials of the multiplicities of each type of identical particle. In this case, with one $b$ quark and two $q$ quarks, the symmetry factor is $S = 1! \\cdot 2! = 2$.\n\nApplying the sum rule over the space of labeled permutations and correcting for indistinguishability, the marginalized event likelihood is:\n$$L_{\\text{event}} = \\frac{1}{S} \\sum_{\\pi \\in S_3} L(\\pi) = \\frac{1}{2} \\sum_{\\pi \\in S_3} K_{0,\\pi(0)} \\cdot K_{1,\\pi(1)} \\cdot K_{2,\\pi(2)}$$\n\n**3. Posterior Probability of Individual Permutations**\n\nWe wish to find the posterior probability of a specific *labeled* permutation $\\pi$, given the observation $\\vec{y}$, which is denoted $p(\\pi|\\vec{y})$. This is a direct application of **Bayes' rule**:\n$$p(\\pi|\\vec{y}) = \\frac{p(\\vec{y}|\\pi)p(\\pi)}{p(\\vec{y})}$$\nHere, $p(\\vec{y}|\\pi)$ is the likelihood $L(\\pi)$ defined previously. The term $p(\\pi)$ is the prior probability of the assignment $\\pi$. The problem specifies a uniform prior over permutations. In the context of determining the posterior for the labeled permutations, this means the prior is the same for all $6$ elements of $S_3$, i.e., $p(\\pi) = C$, a constant. The denominator $p(\\vec{y})$ is the evidence, which serves as a normalization factor. It is calculated by marginalizing over all hypotheses (the $6$ permutations) using the **sum rule**:\n$$p(\\vec{y}) = \\sum_{\\pi' \\in S_3} p(\\vec{y}|\\pi')p(\\pi')$$\nSubstituting these into Bayes' rule, the constant prior $C$ cancels:\n$$p(\\pi|\\vec{y}) = \\frac{L(\\pi) \\cdot C}{\\sum_{\\pi' \\in S_3} L(\\pi') \\cdot C} = \\frac{L(\\pi)}{\\sum_{\\pi' \\in S_3} L(\\pi')}$$\nThe denominator is the sum of likelihoods over all $6$ labeled permutations, and ensures that $\\sum_{\\pi \\in S_3} p(\\pi|\\vec{y}) = 1$. It is crucial to note that this normalization factor, $\\sum L(\\pi')$, is different from the marginalized physical likelihood, $L_{\\text{event}}$, by the factor of $S$.\n\n**4. Posterior Probability of Equivalence Classes**\n\nThe problem defines equivalence classes $C_j$ based on the jet index $j$ assigned to the bottom quark (parton $0$). Thus, $C_j = \\{\\pi \\in S_3 | \\pi(0) = j\\}$. We want to find the posterior probability of each class, $P(C_j|\\vec{y})$.\n\nSince the individual permutations $\\pi$ within a class are mutually exclusive events, we can use the **sum rule of probability** to find the total probability of the class by summing the probabilities of its members:\n$$P(C_j|\\vec{y}) = \\sum_{\\pi \\in C_j} p(\\pi|\\vec{y})$$\nThe three classes are:\n-   Class $0$ ($b \\to \\text{jet } 0$): $C_0 = \\{\\pi_1=(0,1,2), \\pi_2=(0,2,1)\\}$.\n-   Class $1$ ($b \\to \\text{jet } 1$): $C_1 = \\{\\pi_3=(1,0,2), \\pi_4=(1,2,0)\\}$.\n-   Class $2$ ($b \\to \\text{jet } 2$): $C_2 = \\{\\pi_5=(2,0,1), \\pi_6=(2,1,0)\\}$.\nThe sum of these three class posteriors will be $1$.\n\nThese derived formulae are implemented for each test case to produce the required numerical results.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Constructs and implements a simplified matrix element method computation\n    for event likelihoods with indistinguishable final-state partons.\n    \"\"\"\n    # Define test cases as specified in the problem statement.\n    test_cases = [\n        # Case 1 (discriminating)\n        np.array([\n            [0.90, 0.05, 0.05],\n            [0.10, 0.45, 0.45],\n            [0.10, 0.50, 0.40]\n        ]),\n        # Case 2 (ambiguous jets)\n        np.array([\n            [0.40, 0.30, 0.30],\n            [0.20, 0.40, 0.40],\n            [0.20, 0.40, 0.40]\n        ]),\n        # Case 3 (nearly symmetric)\n        np.array([\n            [0.34, 0.33, 0.33],\n            [0.33, 0.34, 0.33],\n            [0.33, 0.33, 0.34]\n        ])\n    ]\n\n    # Partons are indexed i=0 (b), i=1 (q1), i=2 (q2).\n    # Jets are indexed k=0, 1, 2.\n    # Permutations pi are ordered as (pi(0), pi(1), pi(2)) where pi(i) is the jet for parton i.\n    # The fixed lexicographic order of permutations is:\n    perms = [\n        (0, 1, 2), (0, 2, 1), (1, 0, 2),\n        (1, 2, 0), (2, 0, 1), (2, 1, 0)\n    ]\n    \n    # The symmetry factor S for one b-quark and two indistinguishable q-quarks is 1! * 2! = 2.\n    symmetry_factor = 2.0\n\n    all_results = []\n    \n    for K in test_cases:\n        # Calculate the likelihood L(pi) for each of the 6 labeled permutations.\n        # L(pi) = K(0, pi(0)) * K(1, pi(1)) * K(2, pi(2))\n        likelihoods_pi = []\n        for pi in perms:\n            l = K[0, pi[0]] * K[1, pi[1]] * K[2, pi[2]]\n            likelihoods_pi.append(l)\n\n        # Calculate the sum of likelihoods over all permutations.\n        # This sum is the normalization factor for the posterior probabilities.\n        likelihood_sum = sum(likelihoods_pi)\n\n        # 1. Calculate the marginalized event likelihood, L_event.\n        # This is the sum over permutations divided by the symmetry factor.\n        marginalized_likelihood = likelihood_sum / symmetry_factor\n\n        # 2. Calculate the posterior probability for each individual permutation.\n        # p(pi | y) = L(pi) / sum(L(pi'))\n        if likelihood_sum == 0:\n            posteriors_pi = [0.0] * len(perms)\n        else:\n            posteriors_pi = [l / likelihood_sum for l in likelihoods_pi]\n\n        # 3. Calculate the posterior probability for each equivalence class.\n        # The classes are defined by the jet assigned to the bottom quark (parton 0).\n        # Class 0: pi(0)=0. Corresponds to perms[0] and perms[1].\n        # Class 1: pi(0)=1. Corresponds to perms[2] and perms[3].\n        # Class 2: pi(0)=2. Corresponds to perms[4] and perms[5].\n        class_posteriors = [\n            posteriors_pi[0] + posteriors_pi[1],\n            posteriors_pi[2] + posteriors_pi[3],\n            posteriors_pi[4] + posteriors_pi[5]\n        ]\n\n        # Collect the 10 results for the current case.\n        case_results = [marginalized_likelihood] + posteriors_pi + class_posteriors\n        \n        # Format results to 6 decimal places and add to the final list.\n        all_results.extend([f\"{val:.6f}\" for val in case_results])\n\n    # Print the final output in the required format.\n    print(f\"[{','.join(all_results)}]\")\n\nsolve()\n```", "id": "3522084"}]}