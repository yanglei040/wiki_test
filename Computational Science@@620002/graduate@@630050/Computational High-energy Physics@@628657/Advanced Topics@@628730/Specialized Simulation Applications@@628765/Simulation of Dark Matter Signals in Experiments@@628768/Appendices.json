{"hands_on_practices": [{"introduction": "The expected flux of particles from dark matter annihilation is proportional to the line-of-sight integral of the dark matter density squared, a quantity known as the astrophysical $J$-factor. This factor encapsulates the spatial distribution of dark matter and is a critical, albeit uncertain, input for any indirect detection search. This first practice will guide you through the analytical derivation of the $J$-factor for the benchmark Navarro-Frenk-White (NFW) halo profile, providing a foundational understanding of how signal strengths are predicted. [@problem_id:3534035]", "problem": "A spherically symmetric dark matter halo is modeled with the Navarro-Frenk-White (NFW) density profile, defined by the characteristic density $\\rho_{s}$ and scale radius $r_{s}$ as $\\rho(r) = \\rho_{s} \\left[ \\left( \\frac{r}{r_{s}} \\right) \\left( 1 + \\frac{r}{r_{s}} \\right)^{2} \\right]^{-1}$. For indirect detection through particle annihilation, the astrophysical line-of-sight (l.o.s.) $J$-factor is defined by the path integral $J = \\int_{\\text{l.o.s.}} \\rho^{2}(s) \\, ds$, where $s$ is the coordinate along the line of sight.\n\nAssume an observer located at distance $D \\gg r_{s}$ from the halo center and consider the central line of sight corresponding to angular separation $\\psi = 0$ so that the impact parameter is zero. For physical realism, assume the density profile is truncated to a constant core inside a small radius $r_{\\min}$ (for instance due to annihilation saturation or baryonic feedback), so that the integral effectively begins at $r = r_{\\min} > 0$. Take the l.o.s. to extend to infinity.\n\nStarting only from the above definitions and geometric relations between the l.o.s. coordinate and the radial coordinate in a spherically symmetric system, derive a closed-form analytical expression for the central $J$-factor $J_{\\text{NFW}}(\\psi=0; r_{\\min})$ in terms of $\\rho_{s}$, $r_{s}$, and the dimensionless inner cutoff $y_{\\min} \\equiv r_{\\min}/r_{s}$. Express your final answer as a single analytic expression and do not include any numerical values or physical units.\n\nThen, using the generalized NFW profile $\\rho(r) = \\rho_{s} \\left[ \\left( \\frac{r}{r_{s}} \\right)^{\\gamma} \\left( 1 + \\frac{r}{r_{s}} \\right)^{3-\\gamma} \\right]^{-1}$ with inner slope parameter $\\gamma$, explain qualitatively how varying $\\gamma$ changes the scaling of $J_{\\text{NFW}}(\\psi=0; r_{\\min})$ with $r_{\\min}$. Finally, explain how unresolved substructure modifies signal predictions through the relationship between $\\langle \\rho^{2} \\rangle$ and $\\langle \\rho \\rangle^{2}$, and define a boost factor that quantifies this effect.\n\nYour final answer must be a single closed-form analytic expression for $J_{\\text{NFW}}(\\psi=0; r_{\\min})$ written in terms of $\\rho_{s}$, $r_{s}$, and $y_{\\min}$, without any units. No rounding is required.", "solution": "The astrophysical $J$-factor for annihilation is defined by the line-of-sight integral $J = \\int_{\\text{l.o.s.}} \\rho^{2}(s)\\, ds$, where the line-of-sight coordinate $s$ traverses the density field along a given direction. For a spherically symmetric halo, the radial coordinate $r$ is related to the impact parameter $b$ and line-of-sight coordinate $s$ by $r = \\sqrt{b^{2} + s^{2}}$. For the central line of sight, $\\psi = 0$ implies $b = D \\sin \\psi = 0$, so $r = |s|$. Introducing a physically motivated inner cutoff radius $r_{\\min} > 0$, the integral begins at $r_{\\min}$ to avoid the divergence associated with the NFW cusp.\n\nWith the Navarro-Frenk-White (NFW) profile $\\rho(r) = \\rho_{s}\\left[ \\left( \\frac{r}{r_{s}} \\right) \\left( 1 + \\frac{r}{r_{s}} \\right)^{2} \\right]^{-1}$, the squared density is\n$$\n\\rho^{2}(r) = \\rho_{s}^{2} \\left[ \\left( \\frac{r}{r_{s}} \\right)^{2} \\left( 1 + \\frac{r}{r_{s}} \\right)^{4} \\right]^{-1}.\n$$\nOn the central line of sight, the integral becomes\n$$\nJ_{\\text{NFW}}(\\psi=0; r_{\\min}) = \\int_{-\\infty}^{\\infty} \\rho^{2}(|s|)\\, ds = 2 \\int_{r_{\\min}}^{\\infty} \\rho^{2}(r)\\, dr,\n$$\nwhere the factor of $2$ accounts for the two symmetric halves of the line of sight ($s>0$ and $s<0$). Changing variables to a dimensionless radial coordinate $y \\equiv r/r_{s}$, so $r = r_{s} y$ and $dr = r_{s}\\, dy$, and defining $y_{\\min} \\equiv r_{\\min}/r_{s}$, we obtain\n$$\nJ_{\\text{NFW}}(\\psi=0; r_{\\min}) = 2 \\rho_{s}^{2} r_{s} \\int_{y_{\\min}}^{\\infty} \\frac{1}{y^{2} (1+y)^{4}}\\, dy.\n$$\n\nWe now compute the integral $I(y) \\equiv \\int \\frac{dy}{y^{2} (1+y)^{4}}$. A convenient substitution is $t \\equiv \\frac{1}{1+y}$, which implies $y = \\frac{1-t}{t}$ and $dy = -\\frac{dt}{t^{2}}$. The integrand simplifies as\n$$\n\\frac{1}{y^{2} (1+y)^{4}} = \\frac{t^{6}}{(1-t)^{2}},\n$$\nand the measure transforms to\n$$\n\\frac{t^{6}}{(1-t)^{2}} \\left(-\\frac{dt}{t^{2}}\\right) = - \\frac{t^{4}}{(1-t)^{2}}\\, dt.\n$$\nLetting $w \\equiv 1 - t$, we have $dt = -dw$ and $- \\frac{t^{4}}{(1-t)^{2}}\\, dt = \\frac{(1-w)^{4}}{w^{2}}\\, dw$. Expanding the numerator yields\n$$\n\\frac{(1-w)^{4}}{w^{2}} = w^{-2} - 4 w^{-1} + 6 - 4 w + w^{2}.\n$$\nIntegrating term by term,\n$$\nI(y) = \\int \\frac{dy}{y^{2} (1+y)^{4}} = - \\frac{1}{w} - 4 \\ln w + 6 w - 2 w^{2} + \\frac{1}{3} w^{3} + C,\n$$\nwhere $w \\equiv \\frac{y}{1+y}$ and $C$ is a constant of integration. Thus,\n$$\nI(y) = - \\frac{1+y}{y} - 4 \\ln\\!\\left( \\frac{y}{1+y} \\right) + \\frac{6y}{1+y} - \\frac{2 y^{2}}{(1+y)^{2}} + \\frac{1}{3} \\frac{y^{3}}{(1+y)^{3}} + C.\n$$\n\nWe need the definite integral from $y_{\\min}$ to $\\infty$. First evaluate the limit at infinity. As $y \\to \\infty$, $w \\to 1$, and we find\n$$\nI(\\infty) = -1 - 4 \\ln(1) + 6 \\cdot 1 - 2 \\cdot 1 + \\frac{1}{3} \\cdot 1 = \\frac{10}{3}.\n$$\nTherefore,\n$$\n\\int_{y_{\\min}}^{\\infty} \\frac{dy}{y^{2} (1+y)^{4}} = I(\\infty) - I(y_{\\min}) = \\frac{10}{3} + \\frac{1+y_{\\min}}{y_{\\min}} + 4 \\ln\\!\\left( \\frac{y_{\\min}}{1+y_{\\min}} \\right) - \\frac{6 y_{\\min}}{1+y_{\\min}} + \\frac{2 y_{\\min}^{2}}{(1+y_{\\min})^{2}} - \\frac{1}{3} \\frac{y_{\\min}^{3}}{(1+y_{\\min})^{3}}.\n$$\nMultiplying by $2 \\rho_{s}^{2} r_{s}$ gives the desired central $J$-factor:\n$$\nJ_{\\text{NFW}}(\\psi=0; r_{\\min}) = 2 \\rho_{s}^{2} r_{s} \\left[ \\frac{10}{3} + \\frac{1+y_{\\min}}{y_{\\min}} + 4 \\ln\\!\\left( \\frac{y_{\\min}}{1+y_{\\min}} \\right) - \\frac{6 y_{\\min}}{1+y_{\\min}} + \\frac{2 y_{\\min}^{2}}{(1+y_{\\min})^{2}} - \\frac{1}{3} \\frac{y_{\\min}^{3}}{(1+y_{\\min})^{3}} \\right].\n$$\n\nWe now discuss the impact of the inner slope and substructure. Consider the generalized NFW profile with inner slope parameter $\\gamma$,\n$$\n\\rho(r) = \\rho_{s} \\left[ \\left( \\frac{r}{r_{s}} \\right)^{\\gamma} \\left( 1 + \\frac{r}{r_{s}} \\right)^{3-\\gamma} \\right]^{-1}.\n$$\nNear the center ($r \\ll r_{s}$), this behaves as $\\rho(r) \\propto r^{-\\gamma}$, so $\\rho^{2}(r) \\propto r^{-2\\gamma}$. On the central line of sight with a cutoff at $r_{\\min}$, the leading scaling is\n$$\nJ(\\psi=0; r_{\\min}) \\sim \\int_{r_{\\min}}^{\\infty} r^{-2\\gamma} \\, dr \\propto\n\\begin{cases}\nr_{\\min}^{1 - 2\\gamma} & \\text{if } \\gamma \\neq \\frac{1}{2}, \\\\\n\\ln\\!\\left( \\frac{r_{\\text{max}}}{r_{\\min}} \\right) & \\text{if } \\gamma = \\frac{1}{2},\n\\end{cases}\n$$\nwhere $r_{\\text{max}}$ is an outer scale entering the logarithm for the marginal case $\\gamma = \\frac{1}{2}$. Thus, steeper inner slopes ($\\gamma$ larger) enhance the sensitivity of $J$ to the inner cutoff, increasing the central $J$ as $r_{\\min}$ decreases. For the classic NFW case $\\gamma = 1$, $J(\\psi=0; r_{\\min}) \\propto r_{\\min}^{-1}$ in the central limit, consistent with the explicit expression derived above.\n\nUnresolved substructure modifies signal predictions because annihilation depends on $\\langle \\rho^{2} \\rangle$, not $\\langle \\rho \\rangle^{2}$. For a volume element with density fluctuations, define the boost factor\n$$\nB \\equiv \\frac{\\langle \\rho^{2} \\rangle}{\\langle \\rho \\rangle^{2}} - 1,\n$$\nso that the total $J$-factor including substructure can be written schematically as\n$$\nJ_{\\text{tot}} \\simeq J_{\\text{smooth}} \\left( 1 + B \\right).\n$$\nHere $B$ depends on the subhalo mass function (for example $dN/dM \\propto M^{-\\alpha}$), the concentration-mass relation $c(M)$, the minimal clump mass and spatial distribution, and tidal evolution. In general, $B$ enhances the annihilation signal, often more strongly at large radii where subhalos are less tidally disrupted, thereby altering both the normalization and morphology of the predicted signal compared to a smooth-halo model.\n\nThe requested final answer is the closed-form expression for $J_{\\text{NFW}}(\\psi=0; r_{\\min})$ in terms of $\\rho_{s}$, $r_{s}$, and $y_{\\min}$ as derived above.", "answer": "$$\\boxed{2 \\rho_{s}^{2} r_{s} \\left[ \\frac{10}{3} + \\frac{1+y_{\\min}}{y_{\\min}} + 4 \\ln\\!\\left( \\frac{y_{\\min}}{1+y_{\\min}} \\right) - \\frac{6 y_{\\min}}{1+y_{\\min}} + \\frac{2 y_{\\min}^{2}}{(1+y_{\\min})^{2}} - \\frac{1}{3} \\frac{y_{\\min}^{3}}{(1+y_{\\min})^{3}} \\right]}$$", "id": "3534035"}, {"introduction": "Building on the concept of the $J$-factor, a full-scale simulation of a dark matter signal requires incorporating instrumental effects, astrophysical backgrounds, and potential cosmological factors. This exercise challenges you to construct a complete simulation and analysis pipeline for a gamma-ray line search, a classic \"smoking-gun\" signature for dark matter annihilation. You will generate synthetic data that includes these complexities and then perform a Maximum A Posteriori (MAP) fit to recover the signal, learning how to robustly handle uncertainties in the $J$-factor itself. [@problem_id:3534024]", "problem": "You are tasked with building a self-contained program to simulate and fit indirect detection gamma-ray line signals from dark matter annihilation into two photons for the process $\\chi \\chi \\to \\gamma \\gamma$, incorporating subhalo boost distributions, extragalactic attenuation, and template-fitting robustness to astrophysical $J$-factor uncertainties modeled with lognormal priors. The derivation and implementation must start from fundamental definitions and well-tested formulas.\n\nBegin with the following base principles for annihilation fluxes and likelihoods:\n\n1. Dark matter annihilation differential photon flux from a single line-of-sight region of interest (ROI) with astrophysical $J$-factor $J$ is given by\n$$\n\\frac{d\\Phi_{\\mathrm{gal}}}{dE} = \\frac{\\langle \\sigma v \\rangle}{8 \\pi \\, m_\\chi^2} \\, 2 \\, \\delta(E - m_\\chi) \\, J,\n$$\nwhere $m_\\chi$ is the dark matter particle mass, $\\langle \\sigma v \\rangle$ is the velocity-averaged annihilation cross section, and the factor $2$ accounts for two photons per annihilation.\n\n2. The extragalactic annihilation intensity per unit observed energy $E$ for a monochromatic line at emission energy $E_{\\mathrm{em}} = m_\\chi$ under a flat $\\Lambda$ Cold Dark Matter cosmology can be expressed as an integral over redshift $z$,\n$$\n\\frac{d\\Phi_{\\mathrm{ex}}}{dE}(E) = \\frac{c}{8 \\pi} \\frac{\\langle \\sigma v \\rangle}{m_\\chi^2} \\rho_c^2 \\, \\Omega_{\\mathrm{DM}}^2 \\int_0^{z_{\\max}} \\frac{(1+z)^3}{H(z)} e^{-\\tau(E,z)} \\, \\delta\\!\\big(E(1+z) - m_\\chi\\big) \\, dz,\n$$\nwhere $c$ is the speed of light, $\\rho_c$ is the critical density, $\\Omega_{\\mathrm{DM}}$ is the dark matter density parameter, $H(z)$ is the Hubble expansion rate, $\\tau(E,z)$ is the extragalactic background light optical depth, and $\\delta$ is the Dirac delta. Use $H(z) = H_0 \\sqrt{\\Omega_m (1+z)^3 + \\Omega_\\Lambda}$ with $\\Omega_m + \\Omega_\\Lambda = 1$.\n\n3. Model the instrument energy response for the Galactic line by a Gaussian energy dispersion with fractional resolution $r$, such that the line at $E = m_\\chi$ is reconstructed with a Gaussian kernel $G(E; m_\\chi, \\sigma_E)$ of width $\\sigma_E = r \\, m_\\chi$ and unit area. Thus the observed Galactic line intensity is\n$$\n\\frac{d\\Phi_{\\mathrm{gal,obs}}}{dE}(E) = \\left(\\frac{\\langle \\sigma v \\rangle}{4 \\pi \\, m_\\chi^2} J\\right) G\\!\\left(E; m_\\chi, \\sigma_E\\right).\n$$\n\n4. For the optical depth, use the simple parametric form\n$$\n\\tau(E,z) = \\tau_0 \\left(\\frac{E}{E_{\\ast}}\\right)^{\\alpha} z,\n$$\nwith $E_{\\ast} = 100 \\, \\mathrm{GeV}$ and $\\alpha = 1.2$.\n\n5. For each ROI $i$, the expected observed counts in energy bin $j$ with bin center $E_j$ and bin width $\\Delta E$ are given by\n$$\n\\mu_{ij} = \\mathcal{E}_i \\, \\Delta E \\left[ \\frac{d\\Phi_{\\mathrm{gal,obs}}}{dE}(E_j; J_i, \\langle \\sigma v \\rangle) + \\Omega_i \\, \\frac{d\\Phi_{\\mathrm{ex}}}{dE}(E_j; \\langle \\sigma v \\rangle) + \\frac{d\\Phi_{\\mathrm{bkg},i}}{dE}(E_j; k_i) \\right],\n$$\nwhere $\\mathcal{E}_i$ is the exposure (effective area times live time), $\\Omega_i$ is the solid angle of the ROI, and the background spectrum per ROI is modeled as a power law with fixed slope,\n$$\n\\frac{d\\Phi_{\\mathrm{bkg},i}}{dE}(E) = k_i \\left( \\frac{E}{E_0} \\right)^{-\\gamma}.\n$$\n\n6. Observed counts $n_{ij}$ are modeled as independent Poisson random variables with means $\\mu_{ij}$. The joint likelihood is\n$$\n\\mathcal{L} = \\prod_{i,j} \\mathrm{Poisson}(n_{ij} \\mid \\mu_{ij}).\n$$\n\n7. The astrophysical $J$-factors are uncertain. Assume independent lognormal priors per ROI,\n$$\n\\ln J_i \\sim \\mathcal{N}(\\ln \\bar{J}_i, \\sigma_{J,\\mathrm{prior}}^2),\n$$\nwhere $\\bar{J}_i$ is the nominal estimate and $\\sigma_{J,\\mathrm{prior}}$ is the prior width on $\\ln J$. The prior density is\n$$\np(J_i) = \\frac{1}{J_i \\, \\sigma_{J,\\mathrm{prior}} \\sqrt{2\\pi}} \\exp\\!\\left[-\\frac{(\\ln J_i - \\ln \\bar{J}_i)^2}{2 \\sigma_{J,\\mathrm{prior}}^2}\\right].\n$$\n\n8. For robustness testing, generate the true $J$-factors by applying a subhalo boost factor $B_i$ as $J^{\\mathrm{true}}_i = \\bar{J}_i \\, B_i$, where $B_i$ are independent draws from a lognormal distribution with median $1$, that is, $\\ln B_i \\sim \\mathcal{N}(0, \\sigma_{B}^2)$.\n\n9. Adopt flat (improper) priors on the nonnegative parameters $\\langle \\sigma v \\rangle \\ge 0$ and $k_i \\ge 0$.\n\n10. Fit by maximum a posteriori (MAP) estimation, maximizing the posterior\n$$\n\\mathcal{P}(\\langle \\sigma v \\rangle, \\{k_i\\}, \\{J_i\\} \\mid \\{n_{ij}\\}) \\propto \\mathcal{L} \\times \\prod_i p(J_i).\n$$\n\nYour program must:\n\n- Implement the physics exactly as stated above, with all constants and units carefully handled.\n\n- Use the following fixed instrument, cosmology, and analysis settings:\n  - Dark matter mass $m_\\chi = 100 \\, \\mathrm{GeV}$.\n  - Energy range $E \\in [50 \\, \\mathrm{GeV}, 150 \\, \\mathrm{GeV}]$ with $N_{\\mathrm{bins}} = 30$ equal-width bins of width $\\Delta E = (150 - 50)/30 \\, \\mathrm{GeV}$ and centers at bin midpoints.\n  - Fractional energy resolution $r = 0.10$ (that is, $\\sigma_E = 0.10 \\, m_\\chi$).\n  - Fixed background spectral index $\\gamma = 2.3$, pivot $E_0 = 100 \\, \\mathrm{GeV}$.\n  - Exposures $\\mathcal{E}_i = 10^{11} \\, \\mathrm{cm}^2 \\, \\mathrm{s}$ for every ROI $i$.\n  - Solid angles $\\Omega_i = 10^{-4} \\, \\mathrm{sr}$ for every ROI $i$.\n  - Nominal $J$-factors per ROI: $\\bar{J} = [10^{19}, 3 \\times 10^{19}, 10^{20}, 3 \\times 10^{20}, 10^{21}] \\, \\mathrm{GeV}^2 \\, \\mathrm{cm}^{-5}$.\n  - True background normalizations $k^{\\mathrm{true}} = [10^{-12}, 1.5 \\times 10^{-12}, 2 \\times 10^{-12}, 10^{-12}, 3 \\times 10^{-12}] \\, \\mathrm{cm}^{-2} \\, \\mathrm{s}^{-1} \\, \\mathrm{GeV}^{-1}$ for ROIs $i = 1,\\dots,5$.\n  - Cosmology: $H_0 = 70 \\, \\mathrm{km} \\, \\mathrm{s}^{-1} \\, \\mathrm{Mpc}^{-1}$, $\\Omega_m = 0.3$, $\\Omega_\\Lambda = 0.7$, $\\Omega_{\\mathrm{DM}} = 0.26$, speed of light $c = 2.99792458 \\times 10^{10} \\, \\mathrm{cm} \\, \\mathrm{s}^{-1}$, and critical density $\\rho_c = 1.05375 \\times 10^{-5} h^2 \\, \\mathrm{GeV} \\, \\mathrm{cm}^{-3}$ with $h = 0.7$.\n  - Extragalactic attenuation parametrization with $E_\\ast = 100 \\, \\mathrm{GeV}$ and $\\alpha = 1.2$.\n\n- Generate synthetic data by:\n  - Drawing $B_i \\sim \\mathrm{LogNormal}(\\mu=0, \\sigma=\\sigma_B)$ independently and setting $J_i^{\\mathrm{true}} = \\bar{J}_i \\, B_i$.\n  - Computing the expected counts $\\mu_{ij}$ using $\\langle \\sigma v \\rangle_{\\mathrm{true}}$, $J_i^{\\mathrm{true}}$, and $k_i^{\\mathrm{true}}$, then drawing $n_{ij} \\sim \\mathrm{Poisson}(\\mu_{ij})$.\n  - Use a pseudorandom generator with the fixed seed $12345$ to ensure reproducibility.\n\n- Perform a MAP fit over $\\langle \\sigma v \\rangle \\ge 0$, $k_i \\ge 0$, and $J_i > 0$, given the lognormal priors for $J_i$ with width $\\sigma_{J,\\mathrm{prior}}$ and the Poisson likelihood, holding the background spectral index and all other constants fixed. Treat the extragalactic component as an isotropic template whose normalization is tied to $\\langle \\sigma v \\rangle$ via the cosmological formula above. Use $z_{\\max} = 5$ but note that the delta-function support enforces $z^\\star = m_\\chi/E - 1$.\n\n- Compute the extragalactic line intensity by analytically evaluating the redshift integral using the delta function:\n  - For each observed energy $E$, define $z^\\star = m_\\chi/E - 1$; if $z^\\star < 0$ or $z^\\star > z_{\\max}$, set the extragalactic contribution to zero.\n  - Otherwise,\n  $$\n  \\frac{d\\Phi_{\\mathrm{ex}}}{dE}(E) = \\frac{c}{8 \\pi} \\frac{\\langle \\sigma v \\rangle}{m_\\chi^2} \\rho_c^2 \\, \\Omega_{\\mathrm{DM}}^2 \\, \\frac{(1+z^\\star)^3}{H(z^\\star)} \\frac{e^{-\\tau(E, z^\\star)}}{E}.\n  $$\n\n- Fit objective: maximize the logarithm of the posterior (equivalently, minimize the negative log-posterior). Impose positivity bounds and use a suitable numerical optimizer.\n\nTest suite and outputs:\n\nRun the above end-to-end simulation-and-fit for the following three cases, which probe different robustness regimes:\n\n- Case A (happy path): $\\langle \\sigma v \\rangle_{\\mathrm{true}} = 3 \\times 10^{-26} \\, \\mathrm{cm}^3 \\, \\mathrm{s}^{-1}$, $\\tau_0 = 0.5$, $\\sigma_{J,\\mathrm{prior}} = 0.5$, and $\\sigma_B = 0.5$.\n\n- Case B (boundary low-signal, underestimated $J$ prior width): $\\langle \\sigma v \\rangle_{\\mathrm{true}} = 1 \\times 10^{-27} \\, \\mathrm{cm}^3 \\, \\mathrm{s}^{-1}$, $\\tau_0 = 0.0$, $\\sigma_{J,\\mathrm{prior}} = 0.2$, and $\\sigma_B = 0.5$.\n\n- Case C (edge high attenuation, overestimated $J$ prior width): $\\langle \\sigma v \\rangle_{\\mathrm{true}} = 3 \\times 10^{-26} \\, \\mathrm{cm}^3 \\, \\mathrm{s}^{-1}$, $\\tau_0 = 2.0$, $\\sigma_{J,\\mathrm{prior}} = 0.8$, and $\\sigma_B = 0.5$.\n\nFor each case, compute the ratio\n$$\nR = \\frac{\\langle \\sigma v \\rangle_{\\mathrm{MAP}}}{\\langle \\sigma v \\rangle_{\\mathrm{true}}}.\n$$\n\nFinal output format:\n\nYour program should produce a single line of output containing the results for the three cases as a comma-separated list of three floating-point numbers enclosed in square brackets, specifically $[R_A, R_B, R_C]$, with no additional text.\n\nAll physical units in inputs are as specified above. Report only the dimensionless ratios $R$ as floats.", "solution": "The solution will be implemented by following these steps:\n1.  **Setup and Constants**: All physical constants and analysis parameters are defined in a consistent system of units (GeV, cm, s).\n2.  **Physical Modeling**: Implement functions for the a) Galactic signal component, b) extragalactic signal component, and c) astrophysical background component, according to the provided formulas.\n3.  **Data Simulation**: A routine is developed to generate synthetic count data. This involves setting the true physical parameters, calculating expected counts in each energy bin for each Region of Interest (ROI), and drawing pseudo-random numbers from a Poisson distribution. True $J$-factors are generated by applying a lognormally distributed boost factor to the nominal values.\n4.  **Statistical Fitting**: A Maximum A Posteriori (MAP) fit is performed to recover the model parameters from the synthetic data. The objective function to be minimized is the negative log-posterior, defined as:\n    $$\n    f(\\vec{\\theta}) = -\\ln\\mathcal{P}(\\vec{\\theta} \\mid \\{n_{ij}\\}) = -\\ln\\mathcal{L}(\\{n_{ij}\\} \\mid \\vec{\\theta}) - \\ln p(\\vec{\\theta})\n    $$\n    where the parameter vector is $\\vec{\\theta} = (\\langle \\sigma v \\rangle, \\{k_i\\}, \\{J_i\\})$.\n\nThe log-likelihood, derived from the product of Poisson probabilities, and neglecting constant terms, is:\n$$\n-\\ln\\mathcal{L} = \\sum_{i,j} \\left( \\mu_{ij}(\\vec{\\theta}) - n_{ij} \\ln(\\mu_{ij}(\\vec{\\theta})) \\right)\n$$\nThe log-prior, combining flat priors for $\\langle \\sigma v \\rangle$ and $\\{k_i\\}$ with lognormal priors for $\\{J_i\\}$, contributes:\n$$\n-\\ln p(\\vec{\\theta}) = \\sum_i \\left( \\frac{(\\ln J_i - \\ln \\bar{J}_i)^2}{2\\sigma_{J,\\mathrm{prior}}^2} + \\ln J_i \\right) + \\text{const.}\n$$\nThe sum of these two terms forms the objective function for minimization. The fit is performed over $11$ parameters: the global annihilation cross-section $\\langle \\sigma v \\rangle$ and the per-ROI background normalizations $\\{k_i\\}_{i=1..5}$ and $J$-factors $\\{J_i\\}_{i=1..5}$.\n\nThe key components of the physical model are implemented as follows:\n\n-   **Energy Bins**: The energy range from $E_{\\min} = 50 \\, \\mathrm{GeV}$ to $E_{\\max} = 150 \\, \\mathrm{GeV}$ is divided into $N_{\\mathrm{bins}} = 30$ bins. The bin width is $\\Delta E = (E_{\\max} - E_{\\min})/N_{\\mathrm{bins}}$, and bin centers $E_j$ are at the midpoints.\n\n-   **Galactic Signal**: The observed Galactic signal flux, after accounting for energy dispersion, is:\n    $$\n    \\frac{d\\Phi_{\\mathrm{gal,obs}}}{dE}(E; J_i, \\langle \\sigma v \\rangle) = \\frac{\\langle \\sigma v \\rangle}{4 \\pi m_\\chi^2} J_i \\cdot G(E; m_\\chi, \\sigma_E)\n    $$\n    where $G(E; m_\\chi, \\sigma_E)$ is the probability density function of a Normal distribution with mean $m_\\chi = 100 \\, \\mathrm{GeV}$ and standard deviation $\\sigma_E = r \\cdot m_\\chi = 0.1 \\cdot 100 \\, \\mathrm{GeV} = 10 \\, \\mathrm{GeV}$.\n\n-   **Extragalactic Signal**: The extragalactic signal intensity is calculated by analytically solving the redshift integral using the Dirac delta property:\n    $$\n    \\frac{d\\Phi_{\\mathrm{ex}}}{dE}(E) = \\frac{c}{8 \\pi} \\frac{\\langle \\sigma v \\rangle}{m_\\chi^2} (\\rho_c \\Omega_{\\mathrm{DM}})^2 \\frac{(1+z^\\star)^3}{H(z^\\star)} \\frac{e^{-\\tau(E, z^\\star)}}{E}\n    $$\n    This is valid for $z^\\star = m_\\chi/E - 1$ in the range $[0, z_{\\max}]$, and zero otherwise. The Hubble rate is $H(z) = H_0 \\sqrt{\\Omega_m(1+z)^3 + \\Omega_\\Lambda}$, and the optical depth is $\\tau(E, z) = \\tau_0 (E/E_\\ast)^\\alpha z$.\n\n-   **Background**: The astrophysical background is a simple power law:\n    $$\n    \\frac{d\\Phi_{\\mathrm{bkg},i}}{dE}(E) = k_i \\left( \\frac{E}{E_0} \\right)^{-\\gamma}\n    $$\n    with $\\gamma = 2.3$ and $E_0 = 100 \\, \\mathrm{GeV}$.\n\n-   **Expected Counts**: The expected number of counts $\\mu_{ij}$ for ROI $i$ in energy bin $j$ is the sum of these flux components multiplied by the exposure $\\mathcal{E}_i$ and the bin width $\\Delta E$. The extragalactic intensity is also multiplied by the ROI solid angle $\\Omega_i$.\n\nA numerical optimization algorithm, specifically L-BFGS-B as implemented in `scipy.optimize.minimize`, is used to find the parameter values that minimize the negative log-posterior, subject to the positivity constraints $\\langle \\sigma v \\rangle \\ge 0$, $k_i \\ge 0$, and $J_i > 0$.\n\nThe entire process is executed for three test cases, each with different true parameters and prior assumptions, to test the robustness of the fitting procedure. The final output is the ratio of the MAP-fitted cross-section to its true value, $R = \\langle \\sigma v \\rangle_{\\mathrm{MAP}} / \\langle \\sigma v \\rangle_{\\mathrm{true}}$, for each case.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import minimize\nfrom scipy.stats import norm\n\n#\n# Execution Environment:\n# language: Python\n# version: 3.12\n# libraries:\n#   - name: numpy, version: 1.23.5\n#   - name: scipy, version: 1.11.4\n#\n\ndef solve():\n    \"\"\"\n    Main function to run the simulation and fitting for all test cases.\n    \"\"\"\n\n    # --- Physical Constants ---\n    C_LIGHT = 2.99792458e10  # cm/s\n    H0_KM_S_MPC = 70.0  # km/s/Mpc\n    KM_PER_MPC = 3.08567758e19\n    H0_S_INV = H0_KM_S_MPC / KM_PER_MPC  # s^-1\n    H_val = 0.7  # H0 / 100\n    RHO_C_PREFACTOR = 1.05375e-5  # h^2 GeV/cm^3\n    RHO_C = RHO_C_PREFACTOR * H_val**2  # GeV/cm^3\n\n    # --- Cosmological Parameters ---\n    OMEGA_M = 0.3\n    OMEGA_L = 0.7\n    OMEGA_DM = 0.26\n    \n    # --- Analysis Settings ---\n    M_CHI = 100.0  # GeV\n    E_MIN, E_MAX, N_BINS = 50.0, 150.0, 30\n    E_BINS = np.linspace(E_MIN, E_MAX, N_BINS + 1)\n    E_CENTERS = (E_BINS[:-1] + E_BINS[1:]) / 2.0\n    DELTA_E = (E_MAX - E_MIN) / N_BINS\n    E_RES = 0.10\n    SIGMA_E = E_RES * M_CHI\n    BKG_GAMMA = 2.3\n    BKG_E0 = 100.0  # GeV\n    Z_MAX = 5.0\n\n    # --- Attenuation Parameters ---\n    ALPHA_TAU = 1.2\n    E_STAR_TAU = 100.0  # GeV\n\n    # --- ROI-specific Settings ---\n    N_ROIS = 5\n    EXPOSURE = 1.0e11  # cm^2 s, same for all ROIs\n    SOLID_ANGLE = 1.0e-4  # sr, same for all ROIs\n    J_BAR = np.array([1e19, 3e19, 1e20, 3e20, 1e21])  # GeV^2 cm^-5\n    K_TRUE = np.array([1e-12, 1.5e-12, 2e-12, 1e-12, 3e-12])  # cm^-2 s^-1 GeV^-1\n\n    # --- Pre-calculate templates ---\n    GAL_TEMPLATE = norm.pdf(E_CENTERS, loc=M_CHI, scale=SIGMA_E)\n    BKG_TEMPLATE = (E_CENTERS / BKG_E0)**(-BKG_GAMMA)\n\n    def hubble_rate(z):\n        return H0_S_INV * np.sqrt(OMEGA_M * (1 + z)**3 + OMEGA_L)\n\n    def optical_depth(E, z, tau_0):\n        return tau_0 * (E / E_STAR_TAU)**ALPHA_TAU * z\n\n    def extragalactic_flux_template(e_array, tau_0):\n        z_star = M_CHI / e_array - 1\n        flux = np.zeros_like(e_array)\n        \n        valid_mask = (z_star >= 0) & (z_star <= Z_MAX)\n        if np.any(valid_mask):\n            z_s_valid = z_star[valid_mask]\n            e_valid = e_array[valid_mask]\n            \n            prefactor = (C_LIGHT / (8 * np.pi * M_CHI**2)) * (RHO_C * OMEGA_DM)**2\n            \n            integrand = ((1 + z_s_valid)**3 / hubble_rate(z_s_valid)) \\\n                        * np.exp(-optical_depth(e_valid, z_s_valid, tau_0)) / e_valid\n            \n            flux[valid_mask] = prefactor * integrand\n        return flux\n\n    # --- Main Calculation Functions ---\n    def get_expected_counts(params, tau_0):\n        sv, k_vals, j_vals = params[0], params[1:1+N_ROIS], params[1+N_ROIS:]\n        \n        # Extragalactic flux is common for all ROIs (up to solid angle)\n        exgal_flux_template = extragalactic_flux_template(E_CENTERS, tau_0)\n        exgal_flux_total = sv * exgal_flux_template\n        \n        mu = np.zeros((N_ROIS, N_BINS))\n        for i in range(N_ROIS):\n            gal_flux = (sv / (4 * np.pi * M_CHI**2)) * j_vals[i] * GAL_TEMPLATE\n            bkg_flux = k_vals[i] * BKG_TEMPLATE\n            \n            total_flux = gal_flux + SOLID_ANGLE * exgal_flux_total + bkg_flux\n            mu[i, :] = total_flux * EXPOSURE * DELTA_E\n        \n        return mu\n\n    def neg_log_posterior(params, n_obs, tau_0, sigma_j_prior):\n        # Unpack parameters: sv, k_i, J_i\n        sv, k_vals, j_vals = params[0], params[1:1+N_ROIS], params[1+N_ROIS:]\n        \n        # Ensure parameters are positive\n        if sv < 0 or np.any(k_vals < 0) or np.any(j_vals <= 0):\n            return np.inf\n\n        mu = get_expected_counts(params, tau_0)\n        \n        # Add a small epsilon to avoid log(0)\n        mu[mu <= 0] = 1e-30\n        \n        # Poisson log-likelihood part\n        log_likelihood = np.sum(mu - n_obs * np.log(mu))\n        \n        # Lognormal prior on J-factors part\n        log_prior_j = np.sum(\n            (np.log(j_vals) - np.log(J_BAR))**2 / (2 * sigma_j_prior**2) + np.log(j_vals)\n        )\n        \n        return log_likelihood + log_prior_j\n\n    def run_case(sv_true, tau_0, sigma_j_prior, sigma_b):\n        # --- 1. Generate Data ---\n        rng = np.random.default_rng(12345)\n        \n        # Generate true J-factors with boost\n        ln_b_vals = rng.normal(loc=0.0, scale=sigma_b, size=N_ROIS)\n        b_vals = np.exp(ln_b_vals)\n        j_true = J_BAR * b_vals\n        \n        # Calculate true expected counts\n        true_params = np.concatenate(([sv_true], K_TRUE, j_true))\n        mu_true = get_expected_counts(true_params, tau_0)\n        \n        # Generate observed counts\n        n_obs = rng.poisson(lam=mu_true)\n\n        # --- 2. Perform MAP Fit ---\n        # Initial guess for optimization\n        x0 = np.concatenate(([1e-27], K_TRUE, J_BAR))\n        \n        # Parameter bounds\n        bounds = [(1e-30, None)]  # sv >= 0 (small positive num to avoid issues)\n        bounds += [(1e-20, None)] * N_ROIS  # k_i >= 0\n        bounds += [(1e-20, None)] * N_ROIS  # J_i > 0\n\n        # Run optimizer\n        result = minimize(\n            neg_log_posterior,\n            x0,\n            args=(n_obs, tau_0, sigma_j_prior),\n            method='L-BFGS-B',\n            options={'ftol': 1e-12, 'gtol': 1e-8}\n        )\n        \n        sv_map = result.x[0]\n        \n        return sv_map / sv_true\n\n    # --- Test Cases Definition ---\n    test_cases = [\n        # Case A: happy path\n        {'sv_true': 3e-26, 'tau_0': 0.5, 'sigma_j_prior': 0.5, 'sigma_b': 0.5},\n        # Case B: low-signal, underestimated J prior\n        {'sv_true': 1e-27, 'tau_0': 0.0, 'sigma_j_prior': 0.2, 'sigma_b': 0.5},\n        # Case C: high attenuation, overestimated J prior\n        {'sv_true': 3e-26, 'tau_0': 2.0, 'sigma_j_prior': 0.8, 'sigma_b': 0.5},\n    ]\n\n    results = []\n    for case in test_cases:\n        ratio = run_case(\n            sv_true=case['sv_true'],\n            tau_0=case['tau_0'],\n            sigma_j_prior=case['sigma_j_prior'],\n            sigma_b=case['sigma_b']\n        )\n        results.append(ratio)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == '__main__':\n    solve()\n```", "id": "3534024"}, {"introduction": "Shifting our focus from indirect to direct detection, this practice explores the rich phenomenology of directional signals, where the 3D direction of nuclear recoils can be measured. The angular distribution of these recoils depends on the underlying dark matter-nucleon interaction, offering a powerful way to probe the fundamental nature of dark matter. This simulation will task you with modeling signals from two different interaction operators, including realistic detector effects, and using a likelihood-ratio test to quantify our ability to distinguish them. [@problem_id:3534014]", "problem": "A low-pressure carbon tetrafluoride Time Projection Chamber (CF$_{4}$ TPC) measures nuclear recoil directions induced by elastic scattering of Dark Matter (DM) with target nuclei. In the nonrelativistic effective field theory basis, consider two benchmark DM-nucleon interaction operators: $\\mathcal{O}_1$ (spin-independent leading operator) and $\\mathcal{O}_8$ (velocity-perpendicular coupling). In directional detection, elastic scattering from a Maxwellian Galactic halo leads to anisotropic recoil directions that can be approximated, to leading order, by an axisymmetric distribution about the DM wind direction for $\\mathcal{O}_1$, and by a ring-like distribution for $\\mathcal{O}_8$. Realistic reconstruction in a CF$_{4}$ TPC introduces two major degradations: finite track diffusion (angular smearing) and head-tail sense uncertainty (track direction inversion), which degrade operator discrimination.\n\nStarting from fundamental probabilistic definitions and normalization on the unit sphere, derive and implement the following simulation and likelihood ratio test, adhering to the axioms of probability and the requirement that every probability density integrates to unity over the sphere:\n\n1. Model assumptions:\n   - Let the laboratory DM wind direction be the $+\\hat{z}$ axis. The true recoil direction is a unit vector $\\mathbf{x} \\in S^2$ represented in spherical coordinates by a polar angle $\\theta \\in [0,\\pi]$ and an azimuthal angle $\\phi \\in [0,2\\pi)$, with the surface area element on the sphere given by $\\mathrm{d}\\Omega = \\sin\\theta\\,\\mathrm{d}\\theta\\,\\mathrm{d}\\phi$.\n   - For $\\mathcal{O}_1$, approximate the true directional distribution by an axisymmetric von Mises–Fisher distribution on $S^2$ with concentration parameter $\\kappa_1 > 0$ and mean direction $+\\hat{z}$. You must derive the properly normalized three-dimensional density $f_1(\\mathbf{x}\\,;\\kappa_1)$ on $S^2$.\n   - For $\\mathcal{O}_8$, approximate the true directional distribution by an axisymmetric ring centered at polar angle $\\theta_0 \\in (0,\\pi)$ with width $\\sigma_{\\mathrm{ring}} > 0$ such that the three-dimensional density is independent of $\\phi$ and depends on $\\theta$ via a Gaussian in $\\theta$. You must derive the properly normalized three-dimensional density $f_8(\\theta\\,;\\theta_0,\\sigma_{\\mathrm{ring}})$ on $S^2$ that integrates to unity with respect to $\\mathrm{d}\\Omega$.\n   - Finite diffusion is modeled as an angular perturbation of the true unit vector $\\mathbf{x}$ by a random infinitesimal rotation of angle $\\alpha \\sim \\mathcal{N}(0,\\sigma_{\\mathrm{diff}}^2)$ about a random axis orthogonal to $\\mathbf{x}$, yielding a measured unit vector $\\tilde{\\mathbf{x}}$. Head-tail sense uncertainty is modeled by flipping the measured direction, $\\tilde{\\mathbf{x}} \\mapsto -\\tilde{\\mathbf{x}}$, independently for each event with probability $p_{\\mathrm{flip}} \\in [0,1]$.\n   - Angles must be treated and reported in radians.\n\n2. Likelihood ratio test:\n   - Given a set of measured unit vectors $\\{\\tilde{\\mathbf{x}}_i\\}_{i=1}^N$, define the log-likelihood ratio statistic\n     $$S = \\sum_{i=1}^{N} \\ln \\frac{f_1(\\tilde{\\mathbf{x}}_i\\,;\\kappa_1)}{f_8(\\tilde{\\theta}_i\\,;\\theta_0,\\sigma_{\\mathrm{ring}})},$$\n     where $\\tilde{\\theta}_i$ is the polar angle of $\\tilde{\\mathbf{x}}_i$ relative to $+\\hat{z}$. Use the classification rule that favors $\\mathcal{O}_1$ if $S > 0$ and favors $\\mathcal{O}_8$ if $S \\le 0$.\n\n3. Simulation task:\n   - For each test case, simulate $M$ independent pseudo-experiments. In each pseudo-experiment:\n     - Sample $N$ true recoil directions $\\{\\mathbf{x}_i\\}$ from the true operator’s directional distribution ($\\mathcal{O}_1$ or $\\mathcal{O}_8$).\n     - Apply diffusion to each $\\mathbf{x}_i$ via an infinitesimal random rotation of angle $\\alpha \\sim \\mathcal{N}(0,\\sigma_{\\mathrm{diff}}^2)$ about a random axis orthogonal to $\\mathbf{x}_i$, producing $\\tilde{\\mathbf{x}}_i$.\n     - Independently flip $\\tilde{\\mathbf{x}}_i \\mapsto -\\tilde{\\mathbf{x}}_i$ with probability $p_{\\mathrm{flip}}$.\n     - Compute the log-likelihood ratio $S$ and record whether the classification is correct under the true operator.\n   - For each test case, report the classification accuracy as a single float equal to the fraction of pseudo-experiments classified correctly.\n\n4. Units and numerical requirements:\n   - All angles ($\\theta$, $\\phi$, $\\theta_0$, $\\sigma_{\\mathrm{ring}}$, $\\sigma_{\\mathrm{diff}}$) must be in radians.\n   - The output values must be floats in $[0,1]$.\n   - Your program must produce results rounded to $6$ decimal places.\n\n5. Test suite:\n   - Use the following test cases, each specified by $(N, M, \\kappa_1, \\theta_0, \\sigma_{\\mathrm{ring}}, \\sigma_{\\mathrm{diff}}, p_{\\mathrm{flip}}, \\text{true\\_operator})$, where $\\text{true\\_operator} \\in \\{1,8\\}$ specifies the operator generating the data:\n     - Case $1$: $(N,M,\\kappa_1,\\theta_0,\\sigma_{\\mathrm{ring}},\\sigma_{\\mathrm{diff}},p_{\\mathrm{flip}},\\text{true\\_operator}) = (200,200,6.0,1.20,0.30,0.20,0.10,1)$.\n     - Case $2$ (boundary, no diffusion and perfect head-tail): $(200,200,6.0,1.20,0.30,0.00,0.00,1)$.\n     - Case $3$ (high diffusion, moderate head-tail): $(200,200,6.0,1.20,0.30,0.70,0.30,1)$.\n     - Case $4$ (extreme head-tail uncertainty): $(200,200,6.0,1.20,0.30,0.20,0.50,1)$.\n     - Case $5$ (true $\\mathcal{O}_8$): $(200,200,6.0,1.20,0.30,0.20,0.10,8)$.\n\n6. Final output format:\n   - Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, ordered by cases $1$ through $5$. For example, the format must be $[\\text{result}_1,\\text{result}_2,\\text{result}_3,\\text{result}_4,\\text{result}_5]$, with each $\\text{result}_i$ rounded to $6$ decimal places.\n\nYou must ensure scientific realism by deriving and using properly normalized densities on $S^2$, sampling from these densities to produce $\\mathbf{x}_i$, applying diffusion and head-tail uncertainty as specified, and computing the log-likelihood ratio based on your derived $f_1$ and $f_8$. Angles must be in radians. No external data may be used. The final output must adhere to the single-line format specified above.", "solution": "The solution involves three main stages:\n1.  Derivation of the normalized probability density functions (PDFs) for the two dark matter signal hypotheses, $\\mathcal{O}_1$ and $\\mathcal{O}_8$.\n2.  Implementation of a Monte Carlo simulation to generate event samples, including the modeling of experimental effects.\n3.  Execution of a log-likelihood ratio test on the simulated data to determine classification accuracy.\n\n**1. Probability Density Functions**\n\nThe surface area element on the unit sphere $S^2$ is $\\mathrm{d}\\Omega = \\sin\\theta\\,\\mathrm{d}\\theta\\,\\mathrm{d}\\phi$, where $\\theta \\in [0,\\pi]$ is the polar angle and $\\phi \\in [0,2\\pi)$ is the azimuthal angle. Any PDF $f(\\mathbf{x})$ on the sphere must satisfy the normalization condition $\\int_{S^2} f(\\mathbf{x})\\,\\mathrm{d}\\Omega = 1$. The dark matter wind direction is aligned with the $+\\hat{z}$ axis.\n\n**1.1. $\\mathcal{O}_1$ Signal Model: von Mises-Fisher Distribution**\nThe directional distribution for the $\\mathcal{O}_1$ operator is modeled by a von Mises-Fisher (vMF) distribution. The general PDF for a vMF distribution on $S^2$ is given by $f(\\mathbf{x} | \\boldsymbol{\\mu}, \\kappa) = C(\\kappa) e^{\\kappa \\boldsymbol{\\mu} \\cdot \\mathbf{x}}$, where $\\boldsymbol{\\mu}$ is the mean direction and $\\kappa$ is the concentration parameter.\n\nIn this problem, the mean direction is $\\boldsymbol{\\mu} = \\hat{z} = (0,0,1)$. For a recoil direction vector $\\mathbf{x}$ with polar angle $\\theta$, the dot product is $\\boldsymbol{\\mu} \\cdot \\mathbf{x} = \\hat{z} \\cdot \\mathbf{x} = \\cos\\theta$. The PDF is thus independent of the azimuthal angle $\\phi$ and can be written as $f_1(\\theta; \\kappa_1) = C_1 e^{\\kappa_1 \\cos\\theta}$.\n\nTo find the normalization constant $C_1$, we integrate over the sphere:\n$$ \\int_{S^2} C_1 e^{\\kappa_1 \\cos\\theta} \\mathrm{d}\\Omega = \\int_0^{2\\pi} \\mathrm{d}\\phi \\int_0^{\\pi} C_1 e^{\\kappa_1 \\cos\\theta} \\sin\\theta\\,\\mathrm{d}\\theta = 1 $$\nThe integral over $\\phi$ yields $2\\pi$. The integral over $\\theta$ can be solved with the substitution $u = \\cos\\theta$, $\\mathrm{d}u = -\\sin\\theta\\,\\mathrm{d}\\theta$:\n$$ 2\\pi C_1 \\int_{-1}^{1} e^{\\kappa_1 u} \\mathrm{d}u = 2\\pi C_1 \\left[ \\frac{e^{\\kappa_1 u}}{\\kappa_1} \\right]_{-1}^{1} = 2\\pi C_1 \\frac{e^{\\kappa_1} - e^{-\\kappa_1}}{\\kappa_1} = 2\\pi C_1 \\frac{2\\sinh(\\kappa_1)}{\\kappa_1} $$\nSetting this equal to $1$ gives the normalization constant:\n$$ C_1 = \\frac{\\kappa_1}{4\\pi\\sinh(\\kappa_1)} $$\nTherefore, the normalized PDF for the $\\mathcal{O}_1$ hypothesis is:\n$$ f_1(\\mathbf{x}; \\kappa_1) = \\frac{\\kappa_1}{4\\pi\\sinh(\\kappa_1)} e^{\\kappa_1 (\\mathbf{x} \\cdot \\hat{z})} = \\frac{\\kappa_1}{4\\pi\\sinh(\\kappa_1)} e^{\\kappa_1 \\cos\\theta} $$\n\n**1.2. $\\mathcal{O}_8$ Signal Model: Ring Distribution**\nThe directional distribution for the $\\mathcal{O}_8$ operator is modeled as a ring-like structure, independent of $\\phi$ and with a Gaussian profile in the polar angle $\\theta$ centered at $\\theta_0$ with width $\\sigma_{\\mathrm{ring}}$. The unnormalized density is proportional to $e^{-(\\theta - \\theta_0)^2 / (2\\sigma_{\\mathrm{ring}}^2)}$. Let the normalized PDF be $f_8(\\theta; \\theta_0, \\sigma_{\\mathrm{ring}}) = C_8 e^{-(\\theta - \\theta_0)^2 / (2\\sigma_{\\mathrm{ring}}^2)}$.\n\nWe find the normalization constant $C_8$ by integrating over the sphere:\n$$ \\int_{S^2} C_8 e^{-(\\theta - \\theta_0)^2 / (2\\sigma_{\\mathrm{ring}}^2)} \\mathrm{d}\\Omega = \\int_0^{2\\pi} \\mathrm{d}\\phi \\int_0^{\\pi} C_8 e^{-(\\theta - \\theta_0)^2 / (2\\sigma_{\\mathrm{ring}}^2)} \\sin\\theta\\,\\mathrm{d}\\theta = 1 $$\nThe integral over $\\phi$ yields $2\\pi$. The remaining integral over $\\theta$ does not have a simple analytical closed form and must be computed numerically. Let this integral be $I_8^{int}$:\n$$ I_8^{int}(\\theta_0, \\sigma_{\\mathrm{ring}}) = \\int_0^{\\pi} e^{-(\\theta' - \\theta_0)^2 / (2\\sigma_{\\mathrm{ring}}^2)} \\sin\\theta' \\,\\mathrm{d}\\theta' $$\nThe normalization constant is then $C_8 = (2\\pi I_8^{int})^{-1}$. The final PDF for the $\\mathcal{O}_8$ hypothesis is:\n$$ f_8(\\theta; \\theta_0, \\sigma_{\\mathrm{ring}}) = \\frac{e^{-(\\theta - \\theta_0)^2 / (2\\sigma_{\\mathrm{ring}}^2)}}{2\\pi \\int_0^{\\pi} e^{-(\\theta' - \\theta_0)^2 / (2\\sigma_{\\mathrm{ring}}^2)} \\sin\\theta' \\,\\mathrm{d}\\theta'} $$\n\n**2. Monte Carlo Simulation**\n\nThe simulation proceeds by generating $M$ pseudo-experiments, each containing $N$ events.\n\n**2.1. Event Sampling**\n- **Sampling from $f_1$**: We use inverse transform sampling for the polar angle. The PDF for $u = \\cos\\theta$ is $p(u) \\propto e^{\\kappa_1 u}$ for $u \\in [-1, 1]$. The cumulative distribution function (CDF) is $F(u) = (e^{\\kappa_1 u} - e^{-\\kappa_1}) / (e^{\\kappa_1} - e^{-\\kappa_1})$. Setting $F(u)$ to a uniform random variate $y \\in [0,1]$ and solving for $u$ gives $u = \\frac{1}{\\kappa_1} \\ln(e^{-\\kappa_1} + y(e^{\\kappa_1} - e^{-\\kappa_1}))$. The polar angle is $\\theta = \\arccos(u)$. The azimuthal angle $\\phi$ is sampled uniformly from $[0, 2\\pi)$.\n\n- **Sampling from $f_8$**: We use rejection sampling for the polar angle $\\theta$. The target PDF for $\\theta$ is $p(\\theta) \\propto h(\\theta) = e^{-(\\theta - \\theta_0)^2 / (2\\sigma_{\\mathrm{ring}}^2)} \\sin\\theta$ on $[0, \\pi]$. We use a uniform proposal distribution $g(\\theta) = 1/\\pi$ on $[0, \\pi]$. The algorithm is as follows:\n    1.  Find the maximum value $h_{max}$ of $h(\\theta)$ on $[0, \\pi]$ numerically.\n    2.  Sample a candidate $\\theta_{cand}$ from $U(0, \\pi)$.\n    3.  Sample a random variate $v$ from $U(0, 1)$.\n    4.  Accept $\\theta_{cand}$ if $v \\cdot h_{max} \\le h(\\theta_{cand})$. Otherwise, repeat from step 2.\nThe azimuthal angle $\\phi$ is sampled uniformly from $[0, 2\\pi)$.\n\nFrom the sampled $(\\theta, \\phi)$, the true recoil vector is constructed: $\\mathbf{x} = (\\sin\\theta\\cos\\phi, \\sin\\theta\\sin\\phi, \\cos\\theta)$.\n\n**2.2. Instrumental Effects**\n1.  **Diffusion**: The true vector $\\mathbf{x}$ is rotated to the measured vector $\\tilde{\\mathbf{x}}$. The rotation is by an angle $\\alpha$, sampled from a normal distribution $\\mathcal{N}(0, \\sigma_{\\mathrm{diff}}^2)$, around a random axis $\\mathbf{k}$ orthogonal to $\\mathbf{x}$. The axis $\\mathbf{k}$ is generated by taking the cross product of $\\mathbf{x}$ with a random isotropic vector and normalizing the result. The rotation is applied using Rodrigues' rotation formula:\n    $$ \\tilde{\\mathbf{x}} = \\mathbf{x} \\cos\\alpha + (\\mathbf{k} \\times \\mathbf{x}) \\sin\\alpha $$\n    since $\\mathbf{k} \\cdot \\mathbf{x} = 0$.\n\n2.  **Head-Tail Flip**: For each measured vector $\\tilde{\\mathbf{x}}_i$, a random number $u_i \\in [0,1]$ is drawn. If $u_i < p_{\\mathrm{flip}}$, the vector is inverted: $\\tilde{\\mathbf{x}}_i \\mapsto -\\tilde{\\mathbf{x}}_i$.\n\n**3. Likelihood Ratio Test and Classification**\n\nFor each pseudo-experiment, a set of $N$ measured vectors $\\{\\tilde{\\mathbf{x}}_i\\}_{i=1}^N$ is generated. The log-likelihood ratio statistic $S$ is calculated:\n$$ S = \\sum_{i=1}^{N} \\ln \\frac{f_1(\\tilde{\\mathbf{x}}_i\\,;\\kappa_1)}{f_8(\\tilde{\\theta}_i\\,;\\theta_0,\\sigma_{\\mathrm{ring}})} $$\nwhere $\\tilde{\\theta}_i = \\arccos(\\tilde{\\mathbf{x}}_i \\cdot \\hat{z})$ is the polar angle of the measured vector $\\tilde{\\mathbf{x}}_i$. By substituting the derived PDFs, the statistic can be computed as:\n$$ S = \\sum_{i=1}^{N} \\left( \\ln\\left(\\frac{\\kappa_1}{4\\pi\\sinh(\\kappa_1)}\\right) - \\ln\\left(\\frac{1}{2\\pi I_8^{int}}\\right) + \\kappa_1 \\cos\\tilde{\\theta}_i + \\frac{(\\tilde{\\theta}_i - \\theta_0)^2}{2\\sigma_{\\mathrm{ring}}^2} \\right) $$\n\nThe classification rule is:\n-   If $S > 0$, the pseudo-experiment is classified as $\\mathcal{O}_1$.\n-   If $S \\le 0$, the pseudo-experiment is classified as $\\mathcal{O}_8$.\n\nThe classification accuracy for a given test case is the fraction of $M$ pseudo-experiments for which this classification matches the true data-generating operator.", "answer": "```python\nimport numpy as np\nfrom scipy import integrate, optimize\n\ndef solve():\n    \"\"\"\n    Solves the dark matter directional detection simulation problem.\n    \"\"\"\n    # Fix the random seed for reproducibility\n    np.random.seed(42)\n\n    test_cases = [\n        # (N, M, kappa1, theta0, sigma_ring, sigma_diff, p_flip, true_operator)\n        (200, 200, 6.0, 1.20, 0.30, 0.20, 0.10, 1),\n        (200, 200, 6.0, 1.20, 0.30, 0.00, 0.00, 1),\n        (200, 200, 6.0, 1.20, 0.30, 0.70, 0.30, 1),\n        (200, 200, 6.0, 1.20, 0.30, 0.20, 0.50, 1),\n        (200, 200, 6.0, 1.20, 0.30, 0.20, 0.10, 8),\n    ]\n\n    results = []\n\n    for case in test_cases:\n        N, M, kappa1, theta0, sigma_ring, sigma_diff, p_flip, true_operator = case\n\n        # Pre-compute normalization constants and sampling parameters\n        \n        # O1 (von Mises-Fisher)\n        log_norm_f1 = np.log(kappa1 / (4 * np.pi * np.sinh(kappa1)))\n\n        # O8 (Ring distribution)\n        integrand_f8 = lambda theta: np.exp(-(theta - theta0)**2 / (2 * sigma_ring**2)) * np.sin(theta)\n        integral_f8, _ = integrate.quad(integrand_f8, 0, np.pi)\n        log_norm_f8 = -np.log(2 * np.pi * integral_f8)\n        \n        # For rejection sampling from f8\n        # Find max of the unnormalized PDF of theta\n        res = optimize.minimize_scalar(lambda t: -integrand_f8(t), bounds=(0, np.pi), method='bounded')\n        h_max_f8 = -res.fun\n\n        correct_classifications = 0\n        for _ in range(M):\n            # --- Generate N events for one pseudo-experiment ---\n            \n            # 1. Sample N true recoil directions\n            if true_operator == 1:\n                # Sample from von Mises-Fisher\n                y = np.random.rand(N)\n                # handle kappa1 -> 0 case for robustness, though not in test cases\n                if kappa1 > 1e-6:\n                     # Use stable formula for log to avoid large number overflow in exp\n                    term1 = np.exp(-kappa1)\n                    term2 = y * (np.exp(kappa1) - term1)\n                    u = (1/kappa1) * np.log(term1 + term2)\n                else: # isotropic limit\n                    u = 2 * y - 1\n                \n                theta = np.arccos(u)\n                phi = np.random.uniform(0, 2 * np.pi, N)\n            \n            elif true_operator == 8:\n                # Sample from ring distribution using rejection sampling\n                theta_samples = []\n                while len(theta_samples) < N:\n                    theta_cand = np.random.uniform(0, np.pi)\n                    u_rej = np.random.uniform(0, 1)\n                    if u_rej * h_max_f8 <= integrand_f8(theta_cand):\n                        theta_samples.append(theta_cand)\n                theta = np.array(theta_samples)\n                phi = np.random.uniform(0, 2 * np.pi, N)\n\n            # Construct true 3D vectors\n            x_true = np.zeros((N, 3))\n            x_true[:, 0] = np.sin(theta) * np.cos(phi)\n            x_true[:, 1] = np.sin(theta) * np.sin(phi)\n            x_true[:, 2] = np.cos(theta)\n            \n            x_measured = x_true.copy()\n\n            # 2. Apply diffusion (angular smearing)\n            if sigma_diff > 0:\n                alpha = np.random.normal(0, sigma_diff, N)\n                \n                # Generate random axes orthogonal to each true vector\n                v = np.random.randn(N, 3)\n                k_prime = np.cross(x_true, v)\n                k_norm = np.linalg.norm(k_prime, axis=1, keepdims=True)\n                # Handle case where v is parallel to x_true (rare)\n                k_norm[k_norm == 0] = 1.0 \n                k = k_prime / k_norm\n\n                # Rodrigues' rotation formula\n                cos_alpha = np.cos(alpha)[:, np.newaxis]\n                sin_alpha = np.sin(alpha)[:, np.newaxis]\n                k_cross_x = np.cross(k, x_true)\n                \n                x_measured = x_true * cos_alpha + k_cross_x * sin_alpha\n\n            # 3. Apply head-tail sense uncertainty\n            if p_flip > 0:\n                flip_indices = np.random.rand(N) < p_flip\n                x_measured[flip_indices] *= -1\n\n            # --- Compute log-likelihood ratio S ---\n            cos_theta_tilde = np.clip(x_measured[:, 2], -1.0, 1.0)\n            theta_tilde = np.arccos(cos_theta_tilde)\n\n            log_f1_vals = log_norm_f1 + kappa1 * cos_theta_tilde\n            log_f8_vals = log_norm_f8 - (theta_tilde - theta0)**2 / (2 * sigma_ring**2)\n            \n            s_statistic = np.sum(log_f1_vals - log_f8_vals)\n\n            # --- Classify and check correctness ---\n            classified_as_1 = s_statistic > 0\n            is_truly_1 = (true_operator == 1)\n            \n            if classified_as_1 == is_truly_1:\n                correct_classifications += 1\n\n        accuracy = correct_classifications / M\n        results.append(round(accuracy, 6))\n        \n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == '__main__':\n    solve()\n```", "id": "3534014"}]}