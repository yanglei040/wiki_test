{"hands_on_practices": [{"introduction": "要真正掌握一个度量标准，最好的方法莫过于从其最基本的定义出发，亲手推导一遍。本练习将引导你从零开始构建交并比（$IoU$）的表达式，首先处理简化的同中心情况，然后扩展到更普遍的偏心情况。通过这个过程，你将深刻理解$IoU$是如何将中心位置、宽度和高度这几个看似独立的变量耦合在一起，共同决定预测框的好坏 [@problem_id:3160509]。", "problem": "考虑在物体检测中使用的两个轴对齐的矩形边界框，每个边界框由其中心坐标、宽度和高度表示。设真实边界框的中心为 $(x, y)$，宽度为 $w$，高度为 $h$；预测边界框的中心为 $(\\hat{x}, \\hat{y})$，宽度为 $\\hat{w}$，高度为 $\\hat{h}$。交并比（Intersection over Union, IoU）定义为两个边界框交集面积与并集面积之比。你将仅从轴对齐矩形面积重叠的核心定义和集合并集的定义出发，推导和分析IoU。\n\n(a) 仅使用以下定义：两个区间在某一轴上的重叠是这两个区间交集的长度，且轴对齐矩形的交集面积等于它们在两个轴上重叠范围的乘积。请在此基础上，推导当两个边界框共享同一中心，即 $(\\hat{x}, \\hat{y}) = (x, y)$ 时的特殊情况下 $\\mathrm{IoU}$ 的表达式。然后，从第一性原理出发，论证为什么在这种特殊情况下，最大化 $\\mathrm{IoU}$ 等价于最小化绝对差 $|w - \\hat{w}|$ 和 $|h - \\hat{h}|$。\n\n(b) 将你的推导扩展到中心不重合的情况 $(\\hat{x}, \\hat{y}) \\neq (x, y)$，其中水平和垂直偏移分别为 $\\Delta x = \\hat{x} - x$ 和 $\\Delta y = \\hat{y} - y$。请用 $w$, $\\hat{w}$, $h$, $\\hat{h}$, $|\\Delta x|$ 和 $|\\Delta y|$ 表示水平轴和垂直轴上的重叠范围，并给出相应的 $\\mathrm{IoU}$ 表达式。基于此表达式，讨论为了最大化 $\\mathrm{IoU}$，中心位置误差和尺寸误差是否可以解耦。\n\n(c) 考虑一个具体配置，设真实边界框的中心为 $(0, 0)$，宽度 $w = 6$，高度 $h = 4$；预测边界框的中心为 $(1, -0.5)$，宽度 $\\hat{w} = 5$，高度 $\\hat{h} = 3$。计算最终的 $\\mathrm{IoU}$。将你的最终答案四舍五入到四位有效数字。最终答案必须是一个无单位的实数。", "solution": "该问题要求推导和分析两个轴对齐矩形边界框的交并比（IoU）指标。我们将系统地解决每个部分。真实边界框由其中心 $(x, y)$、宽度 $w$ 和高度 $h$ 定义。预测边界框由其中心 $(\\hat{x}, \\hat{y})$、宽度 $\\hat{w}$ 和高度 $\\hat{h}$ 定义。\n\n(a) 特殊情况：中心重合的边界框\n\n首先，我们考虑边界框共享同一中心的特殊情况，即 $(\\hat{x}, \\hat{y}) = (x, y)$。\n\n一个轴对齐的矩形可以描述为水平轴和垂直轴上两个闭区间的笛卡尔积。\n真实边界框对应于水平区间 $[x - w/2, x + w/2]$ 和垂直区间 $[y - h/2, y + h/2]$。\n预测边界框共享同一中心，对应于水平区间 $[x - \\hat{w}/2, x + \\hat{w}/2]$ 和垂直区间 $[y - \\hat{h}/2, y + \\hat{h}/2]$。\n\n两个轴对齐矩形的交集面积是它们对应一维区间交集长度的乘积。\n两个水平区间 $[x - w/2, x + w/2]$ 和 $[x - \\hat{w}/2, x + \\hat{w}/2]$ 的交集是另一个以 $x$ 为中心的区间。其半宽是两个半宽中的较小者，即 $\\min(w/2, \\hat{w}/2)$。这个交集的长度是 $2 \\cdot \\min(w/2, \\hat{w}/2) = \\min(w, \\hat{w})$。\n类似地，两个垂直区间交集的长度是 $\\min(h, \\hat{h})$。\n\n因此，交集面积 $A_I$ 为：\n$$A_I = \\min(w, \\hat{w}) \\cdot \\min(h, \\hat{h})$$\n\n两个集合的并集面积由容斥原理给出：$A_U = A_{GT} + A_P - A_I$，其中 $A_{GT} = wh$ 是真实边界框的面积，$A_P = \\hat{w}\\hat{h}$ 是预测边界框的面积。\n$$A_U = wh + \\hat{w}\\hat{h} - \\min(w, \\hat{w}) \\min(h, \\hat{h})$$\n\n交并比 $\\mathrm{IoU}$ 是这两个面积的比值：\n$$\\mathrm{IoU} = \\frac{A_I}{A_U} = \\frac{\\min(w, \\hat{w}) \\min(h, \\hat{h})}{wh + \\hat{w}\\hat{h} - \\min(w, \\hat{w}) \\min(h, \\hat{h})}$$\n\n为了论证为什么最大化 $\\mathrm{IoU}$ 等价于最小化绝对差 $|w - \\hat{w}|$ 和 $|h - \\hat{h}|$，我们分析 $\\mathrm{IoU}$ 的表达式。最大化该分式等价于最小化其倒数：\n$$\\frac{1}{\\mathrm{IoU}} = \\frac{wh + \\hat{w}\\hat{h}}{\\min(w, \\hat{w}) \\min(h, \\hat{h})} - 1 = \\frac{w}{\\min(w, \\hat{w})} \\frac{h}{\\min(h, \\hat{h})} + \\frac{\\hat{w}}{\\min(w, \\hat{w})} \\frac{\\hat{h}}{\\min(h, \\hat{h})} - 1$$\n我们来分析这些比率。$\\frac{w}{\\min(w, \\hat{w})}$ 这一项，如果 $w \\le \\hat{w}$ 则等于 $1$，如果 $w > \\hat{w}$ 则等于 $w/\\hat{w}$。这可以紧凑地写为 $\\max(1, w/\\hat{w})$。类似地，$\\frac{\\hat{w}}{\\min(w, \\hat{w})} = \\max(1, \\hat{w}/w)$。将这些代入表达式中，得到：\n$$\\frac{1}{\\mathrm{IoU}} = \\max\\left(1, \\frac{w}{\\hat{w}}\\right) \\max\\left(1, \\frac{h}{\\hat{h}}\\right) + \\max\\left(1, \\frac{\\hat{w}}{w}\\right) \\max\\left(1, \\frac{\\hat{h}}{h}\\right) - 1$$\n每个比率项，如 $\\max(1, w/\\hat{w})$，总是大于或等于 $1$。当所有比率都恰好为 $1$ 时，该表达式达到最小值。这当且仅当 $w = \\hat{w}$ 和 $h = \\hat{h}$ 时发生。在这种情况下，$1/\\mathrm{IoU} = 1 \\cdot 1 + 1 \\cdot 1 - 1 = 1$，这意味着 $\\mathrm{IoU}=1$，即可能的最大值。\n$\\hat{w}$ 相对于 $w$ 的任何偏差（即 $|w - \\hat{w}| > 0$）或 $\\hat{h}$ 相对于 $h$ 的任何偏差（即 $|h - \\hat{h}| > 0$）都会使至少一个比率严格大于 $1$。例如，如果 $\\hat{w}  w$，则 $w/\\hat{w} > 1$，使得 $\\max(1, w/\\hat{w}) > 1$。这会增加 $1/\\mathrm{IoU}$ 的值，从而减小 $\\mathrm{IoU}$。因此，在中心重合的情况下最大化 $\\mathrm{IoU}$ 等价于使 $\\hat{w} \\to w$ 和 $\\hat{h} \\to h$，这与最小化 $|w - \\hat{w}|$ 和 $|h - \\hat{h}|$ 是相同的。\n\n(b) 一般情况：中心不重合的边界框\n\n现在我们将推导扩展到具有中心偏移 $\\Delta x = \\hat{x} - x$ 和 $\\Delta y = \\hat{y} - y$ 的一般情况。真实边界框的水平区间为 $[x_1, x_2] = [x - w/2, x + w/2]$，垂直区间为 $[y_1, y_2] = [y - h/2, y + h/2]$。预测边界框的水平区间为 $[\\hat{x}_1, \\hat{x}_2] = [\\hat{x} - \\hat{w}/2, \\hat{x} + \\hat{w}/2]$，垂直区间为 $[\\hat{y}_1, \\hat{y}_2] = [\\hat{y} - \\hat{h}/2, \\hat{y} + \\hat{h}/2]$。\n\n两个区间 $[a,b]$ 和 $[c,d]$ 的交集长度由 $\\max(0, \\min(b, d) - \\max(a, c))$ 给出。\n水平重叠范围 $W_{int}$ 为：\n$$W_{int} = \\max(0, \\min(x_2, \\hat{x}_2) - \\max(x_1, \\hat{x}_1)) = \\max\\left(0, \\min\\left(x + \\frac{w}{2}, \\hat{x} + \\frac{\\hat{w}}{2}\\right) - \\max\\left(x - \\frac{w}{2}, \\hat{x} - \\frac{\\hat{w}}{2}\\right)\\right)$$\n类似地，垂直重叠范围 $H_{int}$ 为：\n$$H_{int} = \\max(0, \\min(y_2, \\hat{y}_2) - \\max(y_1, \\hat{y}_1)) = \\max\\left(0, \\min\\left(y + \\frac{h}{2}, \\hat{y} + \\frac{\\hat{h}}{2}\\right) - \\max\\left(y - \\frac{h}{2}, \\hat{y} - \\frac{\\hat{h}}{2}\\right)\\right)$$\n这些表达式是通用的，并且是两个边界框中心和尺寸的函数。尽管交集长度对于偏移的符号是对称的（例如，取决于 $|\\Delta x|$），但由于相对尺寸和位置之间复杂的相互作用，如果不使用min/max函数或进行情况分析，仅用 $w$, $\\hat{w}$ 和 $|\\Delta x|$ 来表示 $W_{int}$ 是不可能的。\n\n交集面积为 $A_I = W_{int} \\cdot H_{int}$。\n并集面积为 $A_U = wh + \\hat{w}\\hat{h} - A_I$。\n一般的 $\\mathrm{IoU}$ 表达式为：\n$$\\mathrm{IoU} = \\frac{W_{int} \\cdot H_{int}}{wh + \\hat{w}\\hat{h} - W_{int} \\cdot H_{int}}$$\n\n现在，我们讨论为了最大化 $\\mathrm{IoU}$，中心位置误差 $(\\Delta x, \\Delta y)$ 和尺寸误差 $(\\hat{w}, \\hat{h})$ 是否可以解耦。这些参数是耦合的。$W_{int}$ 的表达式同时取决于中心坐标 $(x, \\hat{x})$ 和宽度 $(w, \\hat{w})$。同样，$H_{int}$ 取决于 $(y, \\hat{y})$ 和 $(h, \\hat{h})$。$\\mathrm{IoU}$ 是这些交集范围的非线性函数。\n$$\\mathrm{IoU}(\\Delta x, \\Delta y, \\hat{w}, \\hat{h}) = \\frac{W_{int}(\\Delta x, \\hat{w}) \\cdot H_{int}(\\Delta y, \\hat{h})}{wh + \\hat{w}\\hat{h} - W_{int}(\\Delta x, \\hat{w}) \\cdot H_{int}(\\Delta y, \\hat{h})}$$\n在这个函数中，变量是不可分离的。例如，$\\mathrm{IoU}$ 关于 $\\hat{w}$ 的梯度取决于 $\\Delta x, \\Delta y,$ 和 $\\hat{h}$。宽度变化 $\\Delta \\hat{w}$ 对 $\\mathrm{IoU}$ 的影响受到当前偏移量 $\\Delta x$ 的调节。如果 $|\\Delta x|$ 很大，以至于两个边界框在水平方向上相距很远（$W_{int}=0$），那么 $\\hat{w}$ 的微小变化对 $A_I$ 没有影响，因此对 $\\mathrm{IoU}$ 几乎没有影响。然而，如果边界框在水平方向上完全居中（$\\Delta x = 0$），那么同样的 $\\hat{w}$ 变化可能对 $W_{int}$ 产生显著影响，从而对 $\\mathrm{IoU}$ 产生显著影响，如(a)部分所示。因为 $\\mathrm{IoU}$ 对一个参数（例如 $\\hat{w}$）误差的敏感性取决于另一个参数（例如 $\\Delta x$）的值，所以这些误差不能被认为是解耦的。因此，要最大化 $\\mathrm{IoU}$，必须同时优化所有四个预测参数：$\\hat{x}, \\hat{y}, \\hat{w}, \\hat{h}$。\n\n(c) 数值计算\n\n我们得到以下配置：\n真实边界框：中心 $(x, y)=(0, 0)$，宽度 $w=6$，高度 $h=4$。\n预测边界框：中心 $(\\hat{x}, \\hat{y})=(1, -0.5)$，宽度 $\\hat{w}=5$，高度 $\\hat{h}=3$。\n\n首先，我们确定边界框的边界坐标。\n对于真实边界框：\n$x_1 = x - w/2 = 0 - 6/2 = -3$\n$x_2 = x + w/2 = 0 + 6/2 = 3$\n$y_1 = y - h/2 = 0 - 4/2 = -2$\n$y_2 = y + h/2 = 0 + 4/2 = 2$\n\n对于预测边界框：\n$\\hat{x}_1 = \\hat{x} - \\hat{w}/2 = 1 - 5/2 = -1.5$\n$\\hat{x}_2 = \\hat{x} + \\hat{w}/2 = 1 + 5/2 = 3.5$\n$\\hat{y}_1 = \\hat{y} - \\hat{h}/2 = -0.5 - 3/2 = -2$\n$\\hat{y}_2 = \\hat{y} + \\hat{h}/2 = -0.5 + 3/2 = 1$\n\n接下来，我们使用(b)部分的公式计算重叠范围。\n$W_{int} = \\max(0, \\min(x_2, \\hat{x}_2) - \\max(x_1, \\hat{x}_1)) = \\max(0, \\min(3, 3.5) - \\max(-3, -1.5)) = \\min(3, 3.5) - \\max(-3, -1.5) = 3 - (-1.5) = 4.5$。\n$H_{int} = \\max(0, \\min(y_2, \\hat{y}_2) - \\max(y_1, \\hat{y}_1)) = \\max(0, \\min(2, 1) - \\max(-2, -2)) = \\min(2, 1) - \\max(-2, -2) = 1 - (-2) = 3$。\n\n交集面积为：\n$A_I = W_{int} \\cdot H_{int} = 4.5 \\times 3 = 13.5$。\n\n单个边界框的面积为：\n$A_{GT} = w \\cdot h = 6 \\times 4 = 24$。\n$A_P = \\hat{w} \\cdot \\hat{h} = 5 \\times 3 = 15$。\n\n并集面积为：\n$A_U = A_{GT} + A_P - A_I = 24 + 15 - 13.5 = 39 - 13.5 = 25.5$。\n\n最后，我们计算 $\\mathrm{IoU}$：\n$$\\mathrm{IoU} = \\frac{A_I}{A_U} = \\frac{13.5}{25.5} = \\frac{135}{255} = \\frac{27}{51} = \\frac{9}{17}$$\n换算成小数，即为 $9/17 \\approx 0.52941176...$。\n四舍五入到四位有效数字得到 $0.5294$。", "answer": "$$\\boxed{0.5294}$$", "id": "3160509"}, {"introduction": "在评估目标检测的定位精度时，为什么我们通常选择交并比（$IoU$）而不是更直观的中心点距离呢？这个练习通过两个精心设计的对比场景，揭示了这两种度量标准的根本差异。你会发现，仅靠中心点距离可能会得出误导性的结论，而$IoU$能够更全面地评估预测框与真实框在尺寸、形状和位置上的综合匹配度 [@problem_id:3160438]。", "problem": "考虑二维图像平面中的轴对齐矩形边界框。一个边界框由其中心坐标 $(x,y)$、宽度 $w$ 和高度 $h$ 参数化。对于两个框，定义交并比（IoU）为它们的交集面积与并集面积之比，并定义中心距离度量为它们中心之间的欧氏距离（以像素为单位）。交并比（IoU）和欧氏中心距离被广泛用于评估目标检测的定位。在本问题中，你将比较这两种度量在给出相反判断的两种场景下的表现。\n\n场景对 $1$：真实框 $G_1$ 的中心为 $(50,50)$，宽度为 $40$，高度为 $20$。预测框 $P_1$ 的中心为 $(51,49)$，宽度为 $6$，高度为 $6$。\n\n场景对 $2$：真实框 $G_2$ 的中心为 $(200,200)$，宽度为 $300$，高度为 $300$。预测框 $P_2$ 的中心为 $(280,200)$，宽度为 $300$，高度为 $300$。\n\n选择所有正确的陈述：\n\nA. 在场景对 $1$ 中，中心距离小于 $2$ 像素，但由于纵横比和尺寸不匹配，交并比低于 $0.05$。\n\nB. 在场景对 $2$ 中，中心距离超过 $75$ 像素，但由于框很大且重叠度高，交并比至少为 $0.55$。\n\nC. 中心距离和交并比是等效的度量，它们对所有轴对齐矩形的预测排序相同。\n\nD. 这两对场景突显的不匹配表明，仅最小化中心距离可能导致较差的 IoU，反之亦然，因此需要一个包含重叠度（例如，广义交并比（GIoU））的损失函数来实现鲁棒的定位。", "solution": "评估问题陈述的有效性。\n\n**步骤 1：提取已知条件**\n- 一个边界框由其中心坐标 $(x,y)$、宽度 $w$ 和高度 $h$ 参数化。\n- 交并比（IoU）定义为两个框的交集面积与并集面积之比。\n- 中心距离定义为两个框中心之间的欧氏距离。\n- 场景对 $1$：\n  - 真实框 $G_1$：中心 $(50,50)$，宽度 $w_1=40$，高度 $h_1=20$。\n  - 预测框 $P_1$：中心 $(51,49)$，宽度 $w'_1=6$，高度 $h'_1=6$。\n- 场景对 $2$：\n  - 真实框 $G_2$：中心 $(200,200)$，宽度 $w_2=300$，高度 $h_2=300$。\n  - 预测框 $P_2$：中心 $(280,200)$，宽度 $w'_2=300$，高度 $h'_2=300$。\n\n**步骤 2：使用提取的已知条件进行验证**\n- **科学依据：** 边界框、交并比和欧氏距离的概念是计算机视觉领域，特别是目标检测领域的基础和标准度量。该问题牢固地基于已建立的定义。\n- **适定性：** 边界框的所有参数都给出了精确的数值。度量的定义是清晰的。这使得可以对两种场景唯一地计算 IoU 和中心距离。\n- **客观性：** 问题使用精确的、定量的语言描述。没有主观或模糊的术语。\n\n**步骤 3：结论和行动**\n该问题具有科学合理性、适定性和客观性。这是一个有效的问题。我们继续进行解答。\n\n解答需要计算每个场景对的中心距离和 IoU。\n\n一个中心为 $(c_x, c_y)$、宽度为 $w$、高度为 $h$ 的边界框，其角点坐标由以下公式给出：\n$x_{min} = c_x - w/2$\n$y_{min} = c_y - h/2$\n$x_{max} = c_x + w/2$\n$y_{max} = c_y + h/2$\n这样一个框的面积是 $A = w \\times h$。\n\n两个框 $B_a$ 和 $B_b$ 的交集是一个矩形，其角点坐标为：\n$x_{int,min} = \\max(x_{a,min}, x_{b,min})$\n$y_{int,min} = \\max(y_{a,min}, y_{b,min})$\n$x_{int,max} = \\min(x_{a,max}, x_{b,max})$\n$y_{int,max} = \\min(y_{a,max}, y_{b,max})$\n交集面积为 $A_{int} = \\max(0, x_{int,max} - x_{int,min}) \\times \\max(0, y_{int,max} - y_{int,min})$。\n\n并集面积由 $A_{union} = A_a + A_b - A_{int}$ 给出。\n交并比为 $IoU = A_{int} / A_{union}$。\n\n**场景对 1 的分析**\n- 真实框 $G_1$：中心 $(50,50)$，$w_1=40$，$h_1=20$。\n  - $A_1 = 40 \\times 20 = 800$。\n  - $x_{1,min}=50-20=30$，$y_{1,min}=50-10=40$。\n  - $x_{1,max}=50+20=70$，$y_{1,max}=50+10=60$。\n- 预测框 $P_1$：中心 $(51,49)$，$w'_1=6$，$h'_1=6$。\n  - $A'_1 = 6 \\times 6 = 36$。\n  - $x'_{1,min}=51-3=48$，$y'_{1,min}=49-3=46$。\n  - $x'_{1,max}=51+3=54$，$y'_{1,max}=49+3=52$。\n\n- **场景对 1 的中心距离**：\n中心 $(50,50)$ 和 $(51,49)$ 之间的距离 $d_1$ 是：\n$$d_1 = \\sqrt{(51-50)^2 + (49-50)^2} = \\sqrt{1^2 + (-1)^2} = \\sqrt{2} \\approx 1.414 \\text{ 像素}$$\n\n- **场景对 1 的 IoU**：\n  - 交集坐标：\n    - $x_{int,min} = \\max(30, 48) = 48$\n    - $y_{int,min} = \\max(40, 46) = 46$\n    - $x_{int,max} = \\min(70, 54) = 54$\n    - $y_{int,max} = \\min(60, 52) = 52$\n  - 交集面积：\n    - $A_{int,1} = (54-48) \\times (52-46) = 6 \\times 6 = 36$。\n  - 并集面积：\n    - $A_{union,1} = A_1 + A'_1 - A_{int,1} = 800 + 36 - 36 = 800$。\n  - IoU：\n    - $IoU_1 = \\frac{A_{int,1}}{A_{union,1}} = \\frac{36}{800} = \\frac{9}{200} = 0.045$。\n\n**场景对 2 的分析**\n- 真实框 $G_2$：中心 $(200,200)$，$w_2=300$，$h_2=300$。\n  - $A_2 = 300 \\times 300 = 90000$。\n  - $x_{2,min}=200-150=50$，$y_{2,min}=200-150=50$。\n  - $x_{2,max}=200+150=350$，$y_{2,max}=200+150=350$。\n- 预测框 $P_2$：中心 $(280,200)$，$w'_2=300$，$h'_2=300$。\n  - $A'_2 = 300 \\times 300 = 90000$。\n  - $x'_{2,min}=280-150=130$，$y'_{2,min}=200-150=50$。\n  - $x'_{2,max}=280+150=430$，$y'_{2,max}=200+150=350$。\n\n- **场景对 2 的中心距离**：\n中心 $(200,200)$ 和 $(280,200)$ 之间的距离 $d_2$ 是：\n$$d_2 = \\sqrt{(280-200)^2 + (200-200)^2} = \\sqrt{80^2 + 0^2} = 80 \\text{ 像素}$$\n\n- **场景对 2 的 IoU**：\n  - 交集坐标：\n    - $x_{int,min} = \\max(50, 130) = 130$\n    - $y_{int,min} = \\max(50, 50) = 50$\n    - $x_{int,max} = \\min(350, 430) = 350$\n    - $y_{int,max} = \\min(350, 350) = 350$\n  - 交集面积：\n    - $A_{int,2} = (350-130) \\times (350-50) = 220 \\times 300 = 66000$。\n  - 并集面积：\n    - $A_{union,2} = A_2 + A'_2 - A_{int,2} = 90000 + 90000 - 66000 = 114000$。\n  - IoU：\n    - $IoU_2 = \\frac{A_{int,2}}{A_{union,2}} = \\frac{66000}{114000} = \\frac{66}{114} = \\frac{11}{19} \\approx 0.5789$。\n\n**评估选项**\n\nA. 在场景对 $1$ 中，中心距离小于 $2$ 像素，但由于纵横比和尺寸不匹配，交并比低于 $0.05$。\n- 我们的计算显示中心距离为 $d_1 = \\sqrt{2} \\approx 1.414$，小于 $2$。\n- 我们的计算显示 IoU 为 $IoU_1 = 0.045$，低于 $0.05$。\n- 给出的理由“纵横比和尺寸不匹配”是准确的。真实框 $G_1$ 的面积为 $800$，纵横比为 $40/20=2$，而预测框 $P_1$ 的面积为 $36$，纵横比为 $6/6=1$。尽管中心很近，但这种在尺度和形状上的严重不匹配导致了很差的重叠。\n- **结论：正确**\n\nB. 在场景对 $2$ 中，中心距离超过 $75$ 像素，但由于框很大且重叠度高，交并比至少为 $0.55$。\n- 我们的计算显示中心距离为 $d_2 = 80$，超过了 $75$。\n- 我们的计算显示 IoU 为 $IoU_2 = 11/19 \\approx 0.579$，至少为 $0.55$。\n- 给出的理由也是准确的。$80$ 像素的中心距离相对于 $300$ 像素的框宽来说是比较小的。这导致了大的重叠区域，从而产生了高的 IoU。\n- **结论：正确**\n\nC. 中心距离和交并比是等效的度量，它们对所有轴对齐矩形的预测排序相同。\n- 这个陈述声称，如果一个预测在一个度量上优于另一个，那么它在另一个度量上也必须更优。这两个场景就是一个直接的反例。\n- 比较两种场景中预测的质量：\n  - 按中心距离：预测 $P_1$ 优于 $P_2$，因为 $d_1 \\approx 1.414 \\ll d_2 = 80$。\n  - 按 IoU：预测 $P_2$ 优于 $P_1$，因为 $IoU_2 \\approx 0.579 \\gg IoU_1 = 0.045$。\n- 这两种度量对这两对场景中的定位质量产生了相反的排名。因此，它们不是等效的度量。\n- **结论：不正确**\n\nD. 这两对场景突显的不匹配表明，仅最小化中心距离可能导致较差的 IoU，反之亦然，因此需要一个包含重叠度（例如，广义交并比（GIoU））的损失函数来实现鲁棒的定位。\n- 陈述的第一部分是我们分析的直接结论。场景对 $1$ 表明，非常小的中心距离并不能保证好的 IoU。场景对 $2$ 表明，即使中心距离很大，如果框很大，也可以实现高 IoU。这表明优化一个度量不一定能优化另一个。\n- 陈述的第二部分是现代目标检测中一个公认的原则。简单的 L_n 范数损失作用于边界框坐标（这与中心距离和尺寸有关）的局限性，以及 IoU 损失的局限性（例如，对于不重叠的框梯度为零），促使了改进的损失函数的开发，如广义 IoU (GIoU)、距离 IoU (DIoU) 和完整 IoU (CIoU)。这些损失结合了重叠度、中心距离和纵横比的概念，为边界框回归提供了更稳定和鲁棒的训练。该陈述正确地将 GIoU 识别为此类函数的一个例子，并正确地阐述了其目的。\n- **结论：正确**", "answer": "$$\\boxed{ABD}$$", "id": "3160438"}, {"introduction": "理论理解之后，我们需要通过编程实践来具体感受$IoU$的特性。本练习要求你编写一个程序，系统地研究当预测框发生平移时，$IoU$值是如何变化的，特别是在不同宽高比的情况下。这项实践不仅能加深你对$IoU$非线性行为的理解，也为后续学习更复杂的损失函数（如$GIoU$、$DIoU$）为何被提出打下坚实基础 [@problem_id:3160435]。", "problem": "考虑二维图像平面中的轴对齐边界框。一个边界框由其中心坐标 $(x,y)$ 及其宽度和高度 $(w,h)$ 表示。假设预测框相对于真实框（ground-truth box）在水平和垂直方向上存在恒定的系统性偏移 $(\\Delta x,\\Delta y)$，而其宽度和高度与真实框相同。请仅使用面积、重叠度和交并比（Intersection over Union, IoU）的核心定义，研究 IoU 如何响应不同宽高比下 $(\\Delta x,\\Delta y)$ 的偏移。其中，IoU 定义为两个集合的交集面积与并集面积之比。\n\n您的任务是编写一个程序，针对指定的测试套件，计算真实框与系统性偏移后的预测框之间的 IoU，并汇总数值结果。真实框的中心固定在 $(0,0)$，所有框均为轴对齐的矩形。该测试套件旨在探究在保持面积恒为 $A=16$ 的情况下，$(\\Delta x,\\Delta y)$ 偏差在不同宽高比下产生的线性和非线性影响。\n\n请使用以下测试套件，其中每个案例指定了 $(w,h)$ 和一组偏移量 $(\\Delta x,\\Delta y)$：\n\n- 案例 $\\mathrm{C1}$（正方形，水平偏移）：$(w,h)=(4,4)$，偏移量 $\\{(0,0),(1,0),(2,0),(4,0)\\}$。\n- 案例 $\\mathrm{C2}$（宽形，水平偏移）：$(w,h)=(8,2)$，偏移量 $\\{(0,0),(1,0),(2,0),(4,0),(8,0)\\}$。\n- 案例 $\\mathrm{C3}$（高形，垂直偏移）：$(w,h)=(2,8)$，偏移量 $\\{(0,0),(0,1),(0,2),(0,4),(0,8)\\}$。\n- 案例 $\\mathrm{C4}$（正方形，对角线偏移）：$(w,h)=(4,4)$，偏移量 $\\{(0,0),(1,1),(2,2),(3,3),(4,4)\\}$。\n\n对于每个案例，计算每个指定偏移量对应的 IoU。所有量均为无量纲量。最终输出必须将所有案例的结果汇总到一行中。您的程序应生成一行输出，其中包含一个用方括号括起来的逗号分隔列表（例如 $[r_1,r_2,r_3]$）作为结果。在此问题中，每个 $r_i$ 本身是一个浮点数 IoU 值列表，对应于给定案例中的偏移量，其顺序与上文所列顺序相同。因此，输出必须是打印在一行上的浮点数列表的列表。", "solution": "该问题要求为一组预定义的测试案例计算交并比（IoU）。每个案例都涉及一个真实边界框和一个预测边界框，后者是前者的平移版本。我们首先推导一个通用公式，用于计算两个尺寸相同、其中一个相对于另一个发生偏移的轴对齐边界框之间的 IoU。\n\n设真实边界框 $B_g$ 是一个中心位于原点 $(0, 0)$、宽度为 $w$、高度为 $h$ 的轴对齐矩形。在笛卡尔坐标系中，该框在 x 轴上占据区间 $[-\\frac{w}{2}, \\frac{w}{2}]$，在 y 轴上占据区间 $[-\\frac{h}{2}, \\frac{h}{2}]$。其面积为 $A_g = w \\times h$。\n\n预测边界框 $B_p$ 具有相同的尺寸 $(w, h)$，但其中心被平移到 $(\\Delta x, \\Delta y)$。因此，它占据的区间为 $[\\Delta x - \\frac{w}{2}, \\Delta x + \\frac{w}{2}]$ 和 $[\\Delta y - \\frac{h}{2}, \\Delta y + \\frac{h}{2}]$。其面积 $A_p$ 也是 $w \\times h$。\n\n交并比的定义为：\n$$ \\text{IoU} = \\frac{\\text{Area}(B_g \\cap B_p)}{\\text{Area}(B_g \\cup B_p)} $$\n\n为了计算 IoU，我们必须首先求出交集面积 $A_{\\text{intersection}} = \\text{Area}(B_g \\cap B_p)$。两个轴对齐矩形的交集是另一个轴对齐矩形。这个交集矩形的宽度 $w_i$ 是 x 轴上重叠区间的长度。该重叠是区间 $[-\\frac{w}{2}, \\frac{w}{2}]$ 和 $[\\Delta x - \\frac{w}{2}, \\Delta x + \\frac{w}{2}]$ 的交集长度。这个交集的长度由 $w_i = \\max(0, w - |\\Delta x|)$ 给出。如果 $|\\Delta x| \\ge w$，则两个框在 x 维度上不重叠，交集宽度为 $0$。\n\n同样，交集矩形的高度 $h_i$ 是 y 轴上重叠区间的长度，由 $h_i = \\max(0, h - |\\Delta y|)$ 给出。\n\n交集的面积是其宽度和高度的乘积：\n$$ A_{\\text{intersection}} = w_i \\times h_i = \\max(0, w - |\\Delta x|) \\times \\max(0, h - |\\Delta y|) $$\n\n接下来，我们计算并集的面积 $A_{\\text{union}} = \\text{Area}(B_g \\cup B_p)$。根据面积的容斥原理，我们有：\n$$ A_{\\text{union}} = \\text{Area}(B_g) + \\text{Area}(B_p) - A_{\\text{intersection}} $$\n由于两个框的面积均为 $wh$，上式可简化为：\n$$ A_{\\text{union}} = 2wh - A_{\\text{intersection}} $$\n\n将 $A_{\\text{intersection}}$ 和 $A_{\\text{union}}$ 的表达式代入 IoU 定义，我们得到通用公式：\n$$ \\text{IoU} = \\frac{A_{\\text{intersection}}}{2wh - A_{\\text{intersection}}} = \\frac{\\max(0, w - |\\Delta x|) \\times \\max(0, h - |\\Delta y|)}{2wh - \\left( \\max(0, w - |\\Delta x|) \\times \\max(0, h - |\\Delta y|) \\right)} $$\n如果交集面积为 $0$，则分子为 $0$，因此 IoU 为 $0$。如果完全重叠 $(\\Delta x = 0, \\Delta y = 0)$，则 $A_{\\text{intersection}} = wh$，IoU 为 $\\frac{wh}{2wh - wh} = \\frac{wh}{wh} = 1$。\n\n此公式被用于计算测试套件中提供的每个维度 $(w, h)$ 和偏移量 $(\\Delta x, \\Delta y)$ 组合的 IoU。在所有案例中，真实框的面积均为 $A = wh = 16$。实现过程将遍历每个案例，对每个指定的偏移量应用推导出的公式，并汇总结果。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the Intersection over Union (IoU) for a series of test cases\n    involving shifted bounding boxes and prints the results in the specified format.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    # Each list element is a tuple containing: ((w, h), list_of_offsets).\n    test_cases = [\n        # Case C1: square box, horizontal shifts\n        ((4, 4), [(0, 0), (1, 0), (2, 0), (4, 0)]),\n        # Case C2: wide box, horizontal shifts\n        ((8, 2), [(0, 0), (1, 0), (2, 0), (4, 0), (8, 0)]),\n        # Case C3: tall box, vertical shifts\n        ((2, 8), [(0, 0), (0, 1), (0, 2), (0, 4), (0, 8)]),\n        # Case C4: square box, diagonal shifts\n        ((4, 4), [(0, 0), (1, 1), (2, 2), (3, 3), (4, 4)])\n    ]\n\n    all_results = []\n    for case in test_cases:\n        (w, h), offsets = case\n        case_results = []\n        \n        box_area = float(w * h)\n\n        for dx, dy in offsets:\n            # Calculate the width and height of the intersection rectangle.\n            # The overlap in a dimension is the original dimension size minus the\n            # absolute shift in that dimension, floored at zero.\n            inter_w = np.maximum(0.0, float(w) - np.abs(float(dx)))\n            inter_h = np.maximum(0.0, float(h) - np.abs(float(dy)))\n            \n            # The area of intersection is the product of its dimensions.\n            intersection_area = inter_w * inter_h\n            \n            # The area of the union is the sum of the areas of the two boxes\n            # minus the area of their intersection.\n            union_area = 2 * box_area - intersection_area\n            \n            # IoU is the ratio of intersection area to union area.\n            # This handles the case where intersection_area is 0.\n            # Division by zero is not a risk as union_area >= box_area > 0.\n            if union_area > 0:\n                iou = intersection_area / union_area\n            else:\n                # This case would only occur if box_area is 0, which is not true here.\n                # If intersection_area is 0, iou is 0 by the formula above.\n                # If intersection_area is > 0, union_area is guaranteed to be > 0.\n                iou = 0.0\n\n            case_results.append(iou)\n        \n        all_results.append(case_results)\n\n    # The required output is a single line representing a list of lists.\n    # The `str` function converts each inner list to its string representation (e.g., '[1.0, 0.5]').\n    # The `join` method combines these strings, separated by commas.\n    # The outer brackets are added by the f-string to complete the list-of-lists format.\n    print(f\"[{','.join(map(str, all_results))}]\")\n\nsolve()\n```", "id": "3160435"}]}