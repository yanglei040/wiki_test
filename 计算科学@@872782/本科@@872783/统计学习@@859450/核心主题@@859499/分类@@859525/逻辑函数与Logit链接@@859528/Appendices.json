{"hands_on_practices": [{"introduction": "要建立有效的模型，我们必须能够衡量模型与数据的拟合程度。在逻辑斯蒂回归中，“偏差”(deviance) 是一个关键的拟合优度度量，其作用类似于线性回归中的残差平方和。第一个练习 [@problem_id:1930939] 将提供一个动手实践的机会，让你为一个给定的逻辑斯蒂模型计算总偏差，从而巩固从 logit 链接计算预测概率并将其应用于偏差公式的基本步骤。", "problem": "在一项关于一种新型杀虫剂有效性的研究中，昆虫的结局是二元的：存活（用 $y=0$ 表示）或未存活（用 $y=1$ 表示）。未存活的概率 $p$ 使用带有逻辑斯谛链接函数的广义线性模型 (GLM) 进行建模，这种方法通常称为逻辑斯谛回归。该模型通过对数优势比（log-odds）方程将概率 $p$ 与杀虫剂浓度 $x$（单位：百万分之几，ppm）联系起来：\n$$ \\ln\\left(\\frac{p}{1-p}\\right) = \\beta_0 + \\beta_1 x $$\n基于大量的初步实验，拟合的模型参数确定为 $\\beta_0 = -1.50$ 和 $\\beta_1 = 0.80$。\n\n对一小组四只昆虫进行了一项新实验，得出以下数据：\n- 昆虫1：浓度 $x_1 = 1.0$ ppm，结局 $y_1 = 0$ (存活)\n- 昆虫2：浓度 $x_2 = 2.0$ ppm，结局 $y_2 = 1$ (未存活)\n- 昆虫3：浓度 $x_3 = 3.0$ ppm，结局 $y_3 = 1$ (未存活)\n- 昆虫4：浓度 $x_4 = 4.0$ ppm，结局 $y_4 = 0$ (存活)\n\n模型的总偏差是衡量模型拟合数据优良程度的指标。对于一组二元结局 $y_i$（$i=1, \\dots, n$）及其对应的模型拟合概率 $\\hat{p}_i$，总偏差由以下公式给出：\n$$ D = -2 \\sum_{i=1}^{n} \\left[ y_i \\ln(\\hat{p}_i) + (1-y_i)\\ln(1-\\hat{p}_i) \\right] $$\n\n计算此逻辑斯谛回归模型对这组四只昆虫的总偏差 $D$。将最终答案四舍五入到四位有效数字。", "solution": "该模型使用逻辑斯谛链接，因此对于每只浓度为 $x_i$ 的昆虫，线性预测量为 $\\eta_{i}=\\beta_{0}+\\beta_{1}x_{i}$，拟合概率为 $\\hat{p}_{i}=\\frac{1}{1+\\exp(-\\eta_{i})}$。\n\n给定 $\\beta_{0}=-1.50$ 和 $\\beta_{1}=0.80$，计算 $\\eta_{i}$ 和 $\\hat{p}_{i}$：\n- 昆虫1: $x_{1}=1.0$, $\\eta_{1}=-1.5+0.8(1)=-0.7$, 所以 $\\hat{p}_{1}=\\frac{1}{1+\\exp(0.7)}\\approx 0.331812227$。\n- 昆虫2: $x_{2}=2.0$, $\\eta_{2}=-1.5+0.8(2)=0.1$, 所以 $\\hat{p}_{2}=\\frac{1}{1+\\exp(-0.1)}\\approx 0.524979188$。\n- 昆虫3: $x_{3}=3.0$, $\\eta_{3}=-1.5+0.8(3)=0.9$, 所以 $\\hat{p}_{3}=\\frac{1}{1+\\exp(-0.9)}\\approx 0.710949501$。\n- 昆虫4: $x_{4}=4.0$, $\\eta_{4}=-1.5+0.8(4)=1.7$, 所以 $\\hat{p}_{4}=\\frac{1}{1+\\exp(-1.7)}\\approx 0.845534734$。\n\n总偏差为\n$$\nD=-2\\sum_{i=1}^{4}\\left[y_{i}\\ln(\\hat{p}_{i})+(1-y_{i})\\ln(1-\\hat{p}_{i})\\right].\n$$\n使用观测到的 $y_{i}$ 计算每一项的贡献：\n- 昆虫1: $y_{1}=0$, 贡献为 $-2\\ln(1-\\hat{p}_{1})=-2\\ln(0.668187773)\\approx 0.80637182$。\n- 昆虫2: $y_{2}=1$, 贡献为 $-2\\ln(\\hat{p}_{2})=-2\\ln(0.524979188)\\approx 1.28879255$。\n- 昆虫3: $y_{3}=1$, 贡献为 $-2\\ln(\\hat{p}_{3})=-2\\ln(0.710949501)\\approx 0.68230800$。\n- 昆虫4: $y_{4}=0$, 贡献为 $-2\\ln(1-\\hat{p}_{4})=-2\\ln(0.154465266)\\approx 3.73557206$。\n\n将这些贡献相加：\n$$\nD \\approx 0.80637182+1.28879255+0.68230800+3.73557206=6.51304443.\n$$\n四舍五入到四位有效数字，总偏差为 $6.513$。", "answer": "$$\\boxed{6.513}$$", "id": "1930939"}, {"introduction": "特征缩放是机器学习中常见的数据预处理步骤，但它如何影响模型的系数呢？这个练习 [@problem_id:3185465] 深入探讨了这个问题，揭示了像逻辑斯蒂回归这样包含线性组合的模型的关键特性。通过推导系数如何适应特征的线性变换，你将更深刻地理解模型的预测不变性以及截距和斜率系数之间的相互作用，从而确保你对模型系数的解释是稳健的。", "problem": "考虑一个使用逻辑斯谛函数和 logit 链接的二元分类模型：对于一个特征向量 $x = (x_{1}, \\dots, x_{d})$，类别 $1$ 的条件概率为 $p(x) = \\frac{1}{1 + \\exp(-\\eta(x))}$，其中线性预测器为 $\\eta(x) = \\beta_{0} + \\sum_{k=1}^{d} \\beta_{k} x_{k}$。您决定通过定义一个重新缩放的特征 $x_{j}^{\\text{new}} = \\frac{x_{j} - u}{v}$ 来改变单个特征 $x_{j}$ 的度量单位，其中 $u$ 是一个固定的实数常量，$v$ 是一个固定的正实数常量。所有其他特征 $x_{k}$（对于 $k \\neq j$）保持不变。\n\n您希望在这次重新缩放后，对于每个输入，预测概率 $p(x)$ 保持完全相同，同时模型要用转换后的特征 $x_{j}^{\\text{new}}$ 来表示。也就是说，您需要寻找新的系数 $\\tilde{\\beta}_{0}$、$\\tilde{\\beta}_{j}$ 和 $\\tilde{\\beta}_{k}$（对于 $k \\neq j$），使得转换后的线性预测器 $\\tilde{\\eta}(x) = \\tilde{\\beta}_{0} + \\tilde{\\beta}_{j} x_{j}^{\\text{new}} + \\sum_{k \\neq j} \\tilde{\\beta}_{k} x_{k}$ 对所有 $x$ 都满足 $p(x) = \\frac{1}{1 + \\exp(-\\tilde{\\eta}(x))}$。请用 $\\beta_{0}$、$\\beta_{j}$、$u$ 和 $v$ 的封闭形式表达式来表示数对 $(\\tilde{\\beta}_{0}, \\tilde{\\beta}_{j})$。请使用 LaTeX 的 pmatrix 环境将您的最终答案表示为一个行矩阵，其中的元素顺序为 $(\\tilde{\\beta}_{0}, \\tilde{\\beta}_{j})$。", "solution": "该问题要求在一个逻辑斯谛回归模型中，对单个特征 $x_{j}$ 进行线性变换后，找到新的系数 $(\\tilde{\\beta}_{0}, \\tilde{\\beta}_{j})$，以使得对于所有输入向量 $x$，预测概率保持不变。\n\n类别 $1$ 的条件概率由逻辑斯谛函数给出，$p(x) = \\sigma(\\eta(x))$，其中 $\\sigma(z) = \\frac{1}{1 + \\exp(-z)}$，而 $\\eta(x)$ 是线性预测器。逻辑斯谛函数 $\\sigma(z)$ 是其参数 $z$ 的一个严格单调递增函数。因此，要在变换特征 $x_{j}$ 后，对于任何给定的输入向量 $x$，预测概率保持相同，线性预测器的值也必须保持不变。这意味着对于所有的 $x$，原始的线性预测器 $\\eta(x)$ 必须等于新的线性预测器 $\\tilde{\\eta}(x)$。\n\n原始的线性预测器由下式给出：\n$$ \\eta(x) = \\beta_{0} + \\sum_{k=1}^{d} \\beta_{k} x_{k} = \\beta_{0} + \\beta_{j} x_{j} + \\sum_{k \\neq j, k=1}^{d} \\beta_{k} x_{k} $$\n\n新的特征 $x_{j}^{\\text{new}}$ 由以下变换定义：\n$$ x_{j}^{\\text{new}} = \\frac{x_{j} - u}{v} $$\n其中 $u$ 是一个实数常量，$v$ 是一个正实数常量。为了用新特征来表示原始预测器，我们必须首先将 $x_j$ 表示为 $x_{j}^{\\text{new}}$ 的函数。重新整理变换方程可得：\n$$ v x_{j}^{\\text{new}} = x_{j} - u $$\n$$ x_{j} = v x_{j}^{\\text{new}} + u $$\n\n现在，我们将这个关于 $x_{j}$ 的表达式代回到原始线性预测器 $\\eta(x)$ 的方程中：\n$$ \\eta(x) = \\beta_{0} + \\beta_{j} (v x_{j}^{\\text{new}} + u) + \\sum_{k \\neq j} \\beta_{k} x_{k} $$\n\n将 $\\beta_{j}$ 项展开，并重新组合各项以匹配新线性预测器的结构，可得：\n$$ \\eta(x) = \\beta_{0} + \\beta_{j} v x_{j}^{\\text{new}} + \\beta_{j} u + \\sum_{k \\neq j} \\beta_{k} x_{k} $$\n$$ \\eta(x) = (\\beta_{0} + \\beta_{j} u) + (\\beta_{j} v) x_{j}^{\\text{new}} + \\sum_{k \\neq j} \\beta_{k} x_{k} $$\n\n新的线性预测器用新系数 $\\tilde{\\beta}_{0}$、$\\tilde{\\beta}_{j}$ 和 $\\tilde{\\beta}_{k}$（对于 $k \\neq j$）定义如下：\n$$ \\tilde{\\eta}(x) = \\tilde{\\beta}_{0} + \\tilde{\\beta}_{j} x_{j}^{\\text{new}} + \\sum_{k \\neq j} \\tilde{\\beta}_{k} x_{k} $$\n\n为了使条件 $\\eta(x) = \\tilde{\\eta}(x)$ 对特征向量 $x$ 的所有可能值（因此也对 $x_{j}^{\\text{new}}$ 和 $x_k$（$k \\neq j$）的所有值）成立，两个线性预测器的多项式表达式中对应项的系数必须相等。我们可以逐项对比系数：\n\n将以 $x_{j}^{\\text{new}}$ 表示的 $\\eta(x)$ 表达式与 $\\tilde{\\eta}(x)$ 的表达式进行比较：\n$$ (\\beta_{0} + \\beta_{j} u) + (\\beta_{j} v) x_{j}^{\\text{new}} + \\sum_{k \\neq j} \\beta_{k} x_{k} = \\tilde{\\beta}_{0} + \\tilde{\\beta}_{j} x_{j}^{\\text{new}} + \\sum_{k \\neq j} \\tilde{\\beta}_{k} x_{k} $$\n\n1.  令常数项（截距）相等：\n    $$ \\tilde{\\beta}_{0} = \\beta_{0} + \\beta_{j} u $$\n\n2.  令变换后特征 $x_{j}^{\\text{new}}$ 的系数相等：\n    $$ \\tilde{\\beta}_{j} = \\beta_{j} v $$\n\n3.  令其他特征 $x_{k}$（对于 $k \\neq j$）的系数相等：\n    $$ \\tilde{\\beta}_{k} = \\beta_{k} $$\n\n问题要求的是数对 $(\\tilde{\\beta}_{0}, \\tilde{\\beta}_{j})$ 的表达式。根据以上推导，它们是：\n$$ \\tilde{\\beta}_{0} = \\beta_{0} + \\beta_{j} u $$\n$$ \\tilde{\\beta}_{j} = \\beta_{j} v $$\n\n这些表达式给出了重新缩放后的特征的新截距和新系数，确保了模型的预测在特征 $x_j$ 的指定线性变换下保持不变。最终答案将按要求以行矩阵的形式呈现。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\beta_{0} + \\beta_{j} u  \\beta_{j} v\n\\end{pmatrix}\n}\n$$", "id": "3185465"}, {"introduction": "逻辑斯蒂回归模型为我们提供了概率，但最终目标通常是做出决策。在现实世界中，不同错误的代价可能相差悬殊，因此简单地使用 $0.5$ 作为阈值很少是最佳选择。最后一个练习 [@problem_id:3185480] 将挑战你扮演决策者的角色，运用贝叶斯决策理论的原理，推导出考虑了非对称成本和总体流行率的最优分类阈值。", "problem": "一个二元分类器被训练用于预测个体是否患有某种状况（$Y=1$）或没有（$Y=0$）。在目标人群中，该状况的患病率为 $\\pi = \\mathbb{P}(Y=1)$，其中 $0  \\pi  1$。该分类器是一个逻辑回归模型，其线性预测器为 $\\eta(x)$，输出分数为 $q(x)$，由逻辑函数 $\\sigma$ 和 logit 链接函数给出，即 $q(x) = \\sigma(\\eta(x))$，其中 $\\sigma(z) = \\left(1 + \\exp(-z)\\right)^{-1}$ 且 $\\operatorname{logit}(q) = \\ln\\!\\left(\\frac{q}{1-q}\\right) = \\eta(x)$。该模型是在一个平衡数据集上训练的，因此其分数 $q(x)$ 被校准为等同的类别先验，即 $q(x) = \\frac{f_{1}(x)}{f_{0}(x) + f_{1}(x)}$，其中 $f_{y}(x)$ 表示在给定 $Y=y$ 条件下特征 $x$ 的类条件密度。\n\n您必须选择一个单一的概率阈值 $t$ 应用于 $q(x)$：当 $q(x) \\ge t$ 时预测 $Y=1$，否则预测 $Y=0$。错误分类会产生不对称的成本：假阴性（FN）产生的成本为 $C_{FN}  0$，假阳性（FP）产生的成本为 $C_{FP}  0$。从条件风险最小化和贝叶斯决策理论的核心定义出发，并将 $\\pi$、$C_{FN}$ 和 $C_{FP}$ 视为固定的已知常数，推导成本最优阈值 $t^{*}$ 作为 $\\pi$、$C_{FN}$ 和 $C_{FP}$ 的函数，该阈值可直接应用于 $q(x)$。\n\n您的最终答案必须是 $t^{*}$ 的一个单一解析表达式。", "solution": "最优阈值 $t^*$ 的推导是通过最小化决策的期望成本来进行的，这是贝叶斯决策理论中称为条件风险最小化的一个原则。\n\n首先，对于给定的特征向量 $x$，我们定义与每个可能决策相关的条件风险。有两种行动：预测 $Y=1$（记为 $\\alpha_1$）或预测 $Y=0$（记为 $\\alpha_0$）。风险是在 $x$ 条件下的期望成本。\n\n预测 $Y=1$ 的风险是该行动出错（假阳性）的成本乘以其出错的概率。\n$$R(\\alpha_1|x) = C_{FP} \\cdot \\mathbb{P}(Y=0|x)$$\n\n预测 $Y=0$ 的风险是该行动出错（假阴性）的成本乘以其出错的概率。\n$$R(\\alpha_0|x) = C_{FN} \\cdot \\mathbb{P}(Y=1|x)$$\n\n贝叶斯最优决策规则是选择条件风险较低的行动。如果 $R(\\alpha_1|x) \\le R(\\alpha_0|x)$，我们应该预测 $Y=1$。包含边界情况的等式是为了与问题的决策规则 $q(x) \\ge t$ 保持一致。\n$$C_{FP} \\cdot \\mathbb{P}(Y=0|x) \\le C_{FN} \\cdot \\mathbb{P}(Y=1|x)$$\n\n令 $p(x) = \\mathbb{P}(Y=1|x)$ 为目标人群中正类的真实后验概率。那么 $\\mathbb{P}(Y=0|x) = 1 - p(x)$。将这些代入不等式得到：\n$$C_{FP} (1 - p(x)) \\le C_{FN} p(x)$$\n为了找到关于 $p(x)$ 的阈值，我们重新整理这个不等式。\n$$C_{FP} \\le p(x) (C_{FN} + C_{FP})$$\n然而，使用几率来处理更为优雅。决策规则也可以写成：\n$$\\frac{p(x)}{1-p(x)} \\ge \\frac{C_{FP}}{C_{FN}}$$\n这是以真实后验几率表示的最优决策规则。\n\n接下来，我们必须将真实后验概率 $p(x)$ 与模型的分数 $q(x)$ 联系起来。分数 $q(x)$ 是在假设平衡先验（即 $\\mathbb{P}(Y=1)=\\mathbb{P}(Y=0)=0.5$）的情况下计算的后验概率。问题陈述给出 $q(x) = \\frac{f_1(x)}{f_0(x) + f_1(x)}$。根据这个定义，我们可以用 $q(x)$ 来推导似然比 $\\frac{f_1(x)}{f_0(x)}$：\n$$q(x) (f_0(x) + f_1(x)) = f_1(x)$$\n$$q(x) f_0(x) = f_1(x) (1 - q(x))$$\n$$\\frac{f_1(x)}{f_0(x)} = \\frac{q(x)}{1-q(x)}$$\n右侧是对应于分数 $q(x)$ 的几率。\n\n真实后验概率 $p(x)$ 由贝叶斯定理使用真实患病率 $\\pi$ 给出：\n$$p(x) = \\mathbb{P}(Y=1|x) = \\frac{p(x|Y=1)\\mathbb{P}(Y=1)}{p(x|Y=1)\\mathbb{P}(Y=1) + p(x|Y=0)\\mathbb{P}(Y=0)} = \\frac{f_1(x)\\pi}{f_1(x)\\pi + f_0(x)(1-\\pi)}$$\n相应的真实后验几率是：\n$$\\frac{p(x)}{1-p(x)} = \\frac{f_1(x)\\pi}{f_0(x)(1-\\pi)} = \\frac{f_1(x)}{f_0(x)} \\cdot \\frac{\\pi}{1-\\pi}$$\n代入似然比的表达式，我们建立了真实后验几率与分数几率之间的关键关系：\n$$\\frac{p(x)}{1-p(x)} = \\frac{q(x)}{1-q(x)} \\cdot \\frac{\\pi}{1-\\pi}$$\n\n现在，我们将这个关系代入我们的最优决策规则：\n$$\\frac{q(x)}{1-q(x)} \\cdot \\frac{\\pi}{1-\\pi} \\ge \\frac{C_{FP}}{C_{FN}}$$\n我们需要对这个不等式求解 $q(x)$。这将得出阈值 $t^*$。\n$$\\frac{q(x)}{1-q(x)} \\ge \\frac{C_{FP}}{C_{FN}} \\cdot \\frac{1-\\pi}{\\pi}$$\n令右侧为一个常数 $K$：$K = \\frac{C_{FP}(1-\\pi)}{C_{FN}\\pi}$。不等式为 $\\frac{q(x)}{1-q(x)} \\ge K$。由于 $q(x) \\in [0, 1)$，所以 $1-q(x) > 0$，我们可以在两边同乘以 $(1-q(x))$：\n$$q(x) \\ge K(1-q(x))$$\n$$q(x) \\ge K - Kq(x)$$\n$$q(x)(1+K) \\ge K$$\n$$q(x) \\ge \\frac{K}{1+K}$$\n阈值 $t^*$ 是右侧的值。我们将 $K$ 的表达式代回：\n$$t^* = \\frac{\\frac{C_{FP}(1-\\pi)}{C_{FN}\\pi}}{1 + \\frac{C_{FP}(1-\\pi)}{C_{FN}\\pi}}$$\n为了简化这个繁分数，我们将分子和分母同乘以 $C_{FN}\\pi$：\n$$t^* = \\frac{C_{FP}(1-\\pi)}{C_{FN}\\pi + C_{FP}(1-\\pi)}$$\n这就是可直接应用于模型分数 $q(x)$ 的成本最优阈值 $t^*$ 的闭式表达式。", "answer": "$$\\boxed{\\frac{C_{FP}(1-\\pi)}{C_{FN}\\pi + C_{FP}(1-\\pi)}}$$", "id": "3185480"}]}