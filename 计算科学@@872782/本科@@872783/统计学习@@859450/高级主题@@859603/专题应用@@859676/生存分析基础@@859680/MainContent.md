## 引言
在医学、工程学到经济学等众多领域，我们常常关心一个关键问题：“一个事件需要多长时间才会发生？”无论是患者的生存时间、机器零件的故障时间，还是客户的流失时间，这类“时间至事件”（time-to-event）数据都蕴含着重要信息。[生存分析](@entry_id:163785)正是一套为此[类数](@entry_id:156164)据量身打造的强大统计工具集。传统统计方法在处理这[类数](@entry_id:156164)据时往往会遇到一个核心障碍——数据删失（censoring），即由于研究结束或个体失访等原因，我们无法观测到所有研究对象的完整事件时间。

本文旨在系统地介绍[生存分析](@entry_id:163785)的基础知识，解决因数据不完整性带来的分析挑战。我们将带领读者穿越理论的殿堂，直面真实世界的应用，最终通过动手实践巩固所学。在第一章“原理与机制”中，我们将奠定理论基石，深入探讨[生存分析](@entry_id:163785)的核心概念，如生存函数与[风险函数](@entry_id:166593)，并详细讲解两种最重要的方法：用于非参数估计的[Kaplan-Meier](@entry_id:169317)方法和用于[回归分析](@entry_id:165476)的[Cox比例风险模型](@entry_id:174252)。接着，在第二章“应用与跨学科联系”中，我们将打破学科壁垒，展示[生存分析](@entry_id:163785)如何灵活应用于工程可靠性、神经科学、市场营销乃至机器学习等不同领域，解决各种实际问题。最后，在“动手实践”部分，您将有机会通过解决具体问题，将理论知识转化为可操作的技能。学完本文，您将掌握分析和解读时间至事件数据的基本能力。

## 原理与机制

[生存分析](@entry_id:163785)是一套用于分析从起点事件到终点事件发生所需时间的统计方法。与传统回归方法不同，[生存分析](@entry_id:163785)的核心特征在于其能够妥善处理“删失”（censoring）数据，即由于各种原因，我们只知道事件发生在某个时间点之后，但不知道确切的发生时间。本章将深入探讨[生存分析](@entry_id:163785)的基本原理和核心机制，涵盖其基本概念、非参数估计方法，以及强大的[半参数模型](@entry_id:200031)。

### [生存分析](@entry_id:163785)的基本量

理解[生存分析](@entry_id:163785)需要掌握三个核心的数学概念：生存函数、[风险函数](@entry_id:166593)和[累积风险函数](@entry_id:169734)。这三者从不同角度描述了事件发生时间的[概率分布](@entry_id:146404)。

#### 生存函数 $S(t)$

最直观的量是**生存函数 (Survival Function)**，记作 $S(t)$。它定义为[随机变量](@entry_id:195330) $T$（表示事件发生时间）超过特定时间点 $t$ 的概率：

$$
S(t) = \Pr(T > t)
$$

换言之，$S(t)$ 代表了研究对象存活超过时间 $t$ 的概率。生存函数是一个非增函数，其起始值为 $S(0) = 1$（在时间起点，存活概率为100%），并随着时间推移趋近于 $0$。

#### [风险函数](@entry_id:166593) $\lambda(t)$

与生存函数关注“存活”不同，**[风险函数](@entry_id:166593) (Hazard Function)**，记作 $\lambda(t)$ 或 $h(t)$，关注的是“瞬时风险”。它定义为在时间点 $t$ 存活下来的前提下，在下一个极小时间间隔 $[t, t+\Delta t)$ 内发生事件的[瞬时速率](@entry_id:182981)。其数学定义为：

$$
\lambda(t) = \lim_{\Delta t \to 0^+} \frac{\Pr(t \le T  t + \Delta t \mid T \ge t)}{\Delta t}
$$

[风险函数](@entry_id:166593)不是一个概率（它的值可以大于1），而是一个速率，单位是“事件数/单位时间”。例如，如果时间单位是年，$\lambda(5) = 0.1$ 意味着在第5年仍然存活的个体，其在该时刻的死亡风险速率为每年 $0.1$ 次事件。

#### [累积风险函数](@entry_id:169734) $\Lambda(t)$

**[累积风险函数](@entry_id:169734) (Cumulative Hazard Function)**，记作 $\Lambda(t)$，是[风险函数](@entry_id:166593)从时间起点 $0$ 到时间点 $t$ 的积分：

$$
\Lambda(t) = \int_0^t \lambda(u) du
$$

它代表了到时间 $t$ 为止个体所累积的总风险。如果说[风险函数](@entry_id:166593)是速度，那么[累积风险函数](@entry_id:169734)就是走过的路程。

这三个量通过一个基本关系紧密相连：

$$
S(t) = \exp(-\Lambda(t)) = \exp\left(-\int_0^t \lambda(u) du\right)
$$

这个关系表明，知道其中任意一个函数，原则上就可以推导出另外两个。

### 删失与截断：不完整数据的挑战

在实际研究中，我们很少能观察到所有研究对象的完整事件时间。这种数据的不完整性是[生存分析](@entry_id:163785)需要解决的核心问题，主要表现为删失和截断。

#### [右删失](@entry_id:164686)

最常见的数据不完整形式是**[右删失](@entry_id:164686) (Right-Censoring)**。当一个研究对象的随访在事件发生前终止时，我们只知道其事件时间大于某个观测到的时间。例如，在临床试验中，[右删失](@entry_id:164686)可能由以下原因导致 [@problem_id:3179117]：
1.  **管理性删失 (Administrative Censoring)**：研究在预定的日期结束，此时仍未发生事件的个体被删失。如果研究结束日期是预先固定的，与正在发生的事件无关，那么这种删失通常被认为是**非信息性**的。
2.  **失访 (Loss to Follow-up)**：研究对象因搬家、失联等原因退出研究。
3.  **[竞争风险](@entry_id:173277)事件发生**：研究对象因其他不相关的事件死亡。

[生存分析](@entry_id:163785)方法的一个关键前提是**非信息性删失 (Non-informative Censoring)**。该假设意味着，在给定[协变](@entry_id:634097)量的情况下，一个人的删失时间与其真实的事件时间是相互独立的。换句话说，删失机制本身不能提供关于个体事件风险的额外信息。

例如，一个预先设定结束日期的研究，其管理性删失是典型的非信息性删失 [@problem_id:3179117]。然而，如果研究的结束日期会因为观察到过多事件而被提前，那么删失就变成了信息性的，因为它与群体的整体风险相关。同样，如果病情更严重的患者因为症状频繁而更少被删失，而病情较轻的患者因为就诊稀疏而更容易被删失，这种删失机制也明显是信息性的，使用标准方法会导致偏倚 [@problem_id:3179117]。

#### 左截断

另一种不完整数据是**左截断 (Left Truncation)**，也称为延迟进入。这种情况发生在个体只有在存活到某个时间点 $L_i$ 后才可能被纳入研究。例如，一项关于老年人疾病的研究，只招募了年龄大于65岁的个体，那么所有在65岁前死亡的个体都被系统性地排除了。在分析中，一个左截断的个体 $i$ 只有在其观察期内，即时间 $t$ 满足 $L_i \le t \le T_i$（$T_i$ 为其事件或删失时间）时，才对风险集合有贡献 [@problem_id:3179091]。

### 非[参数估计](@entry_id:139349)

当没有关于事件时间[分布](@entry_id:182848)的先验假设时，我们可以使用[非参数方法](@entry_id:138925)直接从数据中估计生存函数和[累积风险函数](@entry_id:169734)。

#### [Kaplan-Meier](@entry_id:169317) (KM) 估计器

**[Kaplan-Meier](@entry_id:169317) (KM) 估计器**是估计生存函数 $S(t)$ 的标准[非参数方法](@entry_id:138925)。其核心思想是，总体的生存概率是跨越一系列连续时间区间的条件生存概率的乘积。

在每个事件发生的时间点 $t_i$，我们计算在该时刻存活的[条件概率](@entry_id:151013)。设 $n_i$ 是在时间点 $t_i$ 之前（即处于风险中）的个体数量，$d_i$ 是在时间点 $t_i$ 发生事件的个体数量。那么，在给定存活到 $t_i$ 的条件下，继续存活过 $t_i$ 的[条件概率](@entry_id:151013)可以估计为：

$$
\frac{n_i - d_i}{n_i} = 1 - \frac{d_i}{n_i}
$$

KM生存函数 $\hat{S}(t)$ 就是将所有截至时间 $t$ 的事件点上的这些条件生存概率相乘：

$$
\hat{S}(t) = \prod_{i: t_i \le t} \left(1 - \frac{d_i}{n_i}\right)
$$

这个公式也被称为**乘积极限估计 (Product-Limit Estimator)**。删失的个体在计算中扮演了关键角色：他们在删失前对风险集 $n_i$ 做出贡献，但在删失后便从风险集中移除 [@problem_id:2745909]。例如，在一个[神经元存活](@entry_id:162973)的研究中，一些新生的神经元可能会迁移出成像视野。这些神经元并没有被观察到死亡（事件），但也不再被追踪。正确的处理方式是在它们最后一次被观察到存活时将其作为右[删失数据](@entry_id:173222)处理，而不是错误地计为死亡事件 [@problem_id:2745909]。

让我们通过一个简单的例子来构建KM估计器 [@problem_id:3179090]。假设有7个研究对象，观测数据（时间，事件指示符 $\delta=1$ 表示事件，$\delta=0$ 表示删失）为：$(1, 1), (3, 1), (4, 0), (5, 1), (7, 0), (8, 1), (10, 1)$。
我们可以构建一个[生命表](@entry_id:154706)：

| 事件时间 $t_i$ | 风险集大小 $n_i$ | 事件数 $d_i$ | 条件生存概率 $(n_i-d_i)/n_i$ | 生存函数 $\hat{S}(t_i)$ |
| :---: | :---: | :---: | :---: | :---: |
| 1 | 7 | 1 | $6/7$ | $6/7$ |
| 3 | 6 | 1 | $5/6$ | $(6/7) \times (5/6) = 5/7$ |
| 5 | 4 | 1 | $3/4$ | $(5/7) \times (3/4) = 15/28$ |
| 8 | 2 | 1 | $1/2$ | $(15/28) \times (1/2) = 15/56$ |
| 10 | 1 | 1 | $0/1$ | $(15/56) \times (0/1) = 0$ |

在时间点4和7发生的删失，减少了后续风险集的大小（例如，从 $n_2=6$ 减少到 $n_3=4$ 是因为在时间3有1个事件，在时间4有1个删失）。因此，在时间7的生存概率 $\hat{S}(7)$ 与 $\hat{S}(5)$ 相同，为 $15/28$。

#### Nelson-Aalen (NA) 估计器

与KM估计器对应，**Nelson-Aalen (NA) 估计器**用于非参数地估计[累积风险函数](@entry_id:169734) $\Lambda(t)$。其思想是，总累积风险是每个事件点上瞬时风险的累加。在每个事件时间点 $t_i$，瞬时风险（风险增量）可以被估计为事件数与风险集大小的比值 $d_i/n_i$。NA估计器就是将所有截至时间 $t$ 的风险增量相加：

$$
\hat{\Lambda}(t) = \sum_{i: t_i \le t} \frac{d_i}{n_i}
$$

KM和NA估计器之间存在着与理论公式 $S(t) = \exp(-\Lambda(t))$ 相对应的近似关系。具体来说，$\log \hat{S}(t) = \sum \log(1 - d_i/n_i)$。当每个风险增量 $d_i/n_i$ 都很小时，根据[泰勒展开](@entry_id:145057) $\log(1-x) \approx -x$，我们有：

$$
\log \hat{S}(t) \approx \sum \left( -\frac{d_i}{n_i} \right) = - \hat{\Lambda}(t)
$$

因此，$\hat{S}(t) \approx \exp(-\hat{\Lambda}(t))$。这个近似在风险集很大且事件稀疏时非常精确 [@problem_id:3179138]。

### [半参数模型](@entry_id:200031)：[Cox比例风险模型](@entry_id:174252)

虽然[非参数方法](@entry_id:138925)很灵活，但它们无法直接评估协变量（如年龄、性别、治疗方案）对生存时间的影响。**[Cox比例风险模型](@entry_id:174252) (Cox Proportional Hazards, CPH) **是一种[半参数模型](@entry_id:200031)，它完美地解决了这个问题。

#### 模型定义与假设

CPH模型假设一个体的[风险函数](@entry_id:166593)可以分解为一个与时间相关但不依赖于协变量的**基准[风险函数](@entry_id:166593) $\lambda_0(t)$**，和一个依赖于协变量但不依赖于时间的因子。对于具有协变量向量 $X$ 的个体，其[风险函数](@entry_id:166593)为：

$$
\lambda(t \mid X) = \lambda_0(t) \exp(X^T \beta)
$$

其中 $\beta$ 是需要估计的[回归系数](@entry_id:634860)向量。这个模型的核心是**[比例风险假设](@entry_id:163597) (Proportional Hazards Assumption)**：对于任意两个[协变](@entry_id:634097)量不同的个体（例如 $X_1$ 和 $X_2$），他们的[风险函数](@entry_id:166593)之比是恒定的：

$$
\frac{\lambda(t \mid X_1)}{\lambda(t \mid X_2)} = \frac{\lambda_0(t) \exp(X_1^T \beta)}{\lambda_0(t) \exp(X_2^T \beta)} = \exp((X_1 - X_2)^T \beta)
$$

这个比值不随时间 $t$ 变化。$\exp(\beta_j)$ 被解释为[协变](@entry_id:634097)量 $x_j$ 每增加一个单位，[风险比](@entry_id:173429) (Hazard Ratio) 的变化倍数。

#### 部分似然估计

[Cox模型](@entry_id:164053)的巨大成功在于其巧妙的估计方法——**部分似然 (Partial Likelihood)**。这种方法允许我们估计参数 $\beta$ 而无需对未知的基准[风险函数](@entry_id:166593) $\lambda_0(t)$ 做任何假设。

其思想是，在每个事件发生的时间点 $t_j$，我们考虑一个[条件概率](@entry_id:151013)：给定风险集 $R(t_j)$ 中恰好有一个事件发生，这个事件恰好发生在实际观测到的个体 $i_j$ 身上的概率。这个概率为：

$$
L_j(\beta) = \frac{\text{个体 } i_j \text{ 的风险}}{\text{风险集中所有个体风险之和}} = \frac{\lambda(t_j \mid X_{i_j})}{\sum_{k \in R(t_j)} \lambda(t_j \mid X_k)} = \frac{\lambda_0(t_j) \exp(X_{i_j}^T \beta)}{\sum_{k \in R(t_j)} \lambda_0(t_j) \exp(X_k^T \beta)} = \frac{\exp(X_{i_j}^T \beta)}{\sum_{k \in R(t_j)} \exp(X_k^T \beta)}
$$

神奇的是，基准风险 $\lambda_0(t_j)$ 在分子和分母中被约掉了。部分[似然函数](@entry_id:141927)就是将所有事件点的这些条件概率相乘：

$$
L_p(\beta) = \prod_{j: \text{事件发生}} L_j(\beta) = \prod_{j: \text{事件发生}} \frac{\exp(X_{i_j}^T \beta)}{\sum_{k \in R(t_j)} \exp(X_k^T \beta)}
$$

这个函数只依赖于数据和参数 $\beta$，因此可以通过最大化它来得到 $\hat{\beta}$ 的估计值 [@problem_id:3179095]。这个估计过程对时间的任何单调递增变换都是不变的，但基准[风险函数](@entry_id:166593)本身会随时间尺度的变换而改变 [@problem_id:3179145]。

#### 从估计到预测

得到 $\hat{\beta}$ 后，我们可以进一步估计整个模型以进行预测 [@problem_id:3179096]。
1.  **估计基准累积风险**：使用 **Breslow估计器**来估计基准[累积风险函数](@entry_id:169734) $\Lambda_0(t)$：
    $$
    \hat{\Lambda}_0(t) = \sum_{j: t_j \le t} \frac{d_j}{\sum_{k \in R(t_j)} \exp(X_k^T \hat{\beta})}
    $$
    这与Nelson-Aalen估计器类似，但分母用协变量调整后的风险总和代替了简单的风险集大小。
2.  **估计基准生存函数**：通过基本关系得到基准生存函数 $\hat{S}_0(t) = \exp(-\hat{\Lambda}_0(t))$。
3.  **预测个体生存曲线**：对于一个具有新协变量 $X^\star$ 的个体，其生存函数可以预测为：
    $$
    \hat{S}(t \mid X^\star) = \hat{S}_0(t)^{\exp(X^{\star T} \hat{\beta})}
    $$
    这清晰地展示了协变量如何通过[风险比](@entry_id:173429)来调[整基](@entry_id:190217)准生存曲线。

#### 模型扩展与注意事项

[Cox模型](@entry_id:164053)非常灵活，可以处理更复杂的情况。
- **时变协变量 (Time-Dependent Covariates)**：当协变量的值随时间变化时（如用药状态），可以在模型中指定 $X(t)$。这是处理许多偏倚（如**不[死时间](@entry_id:273487)偏倚 (Immortal Time Bias)**）的正确方法。不[死时间](@entry_id:273487)偏倚发生于错误地将一个在随访期间才开始接受治疗的个体从基线就划分为“治疗组”。这段治疗前的“不[死时间](@entry_id:273487)”（因为他必须存活才能开始治疗）被人为地算入治疗组，从而虚假地拉低了治疗组的[风险率](@entry_id:266388)。正确的做法是将该个体的随访时间分割为治疗前和治疗后两部分，并相应地更新其在风险集中的协变量状态 [@problem_id:3179064]。

- **时间轴的定义**：分析者必须谨慎选择时间的度量尺度。时间可以是年龄、日历时间或自诊断以来的时间。改变时间轴（例如，从年龄 $a$ 变为自诊断时间 $s = a - a_0$）是一个变量代换，它会改变基准[风险函数](@entry_id:166593) $\lambda_0(t)$ 的形状。具体来说，对于一个严格递增的[时间变换](@entry_id:634205) $s=g(t)$，[风险函数](@entry_id:166593)的变换规律为 $\lambda^{(s)}(s) = \lambda^{(t)}(g^{-1}(s)) \cdot (g^{-1})'(s)$。这说明风险作为一种“速率”，其数值会随着时间单位的改变而缩放 [@problem_id:3179145]。

### 高级主题：[竞争风险](@entry_id:173277)

在许多研究中，个体可能面临多种类型的终点事件，这些事件相互排斥，一个事件的发生会阻止其他事件的发生。这被称为**[竞争风险](@entry_id:173277) (Competing Risks)**。例如，在心脏病研究中，患者可能死于心脏病（主要事件），也可能死于癌症（竞争事件）。

在[竞争风险](@entry_id:173277)框架下，仅使用[Kaplan-Meier](@entry_id:169317)方法估计特定原因的事件概率是有误导性的，因为它会高估事件发生率。我们需要引入两个新的概念：
1.  **原因别定[风险函数](@entry_id:166593) (Cause-Specific Hazard Function)** $\lambda_k(t)$：这是在时间 $t$ 发生原因 $k$ 事件的瞬时[风险率](@entry_id:266388)，其定义与总[风险函数](@entry_id:166593)类似，但分子只考虑原因 $k$ 的事件 [@problem_id:3179114]：
    $$
    \lambda_k(t) = \lim_{\Delta t \to 0^+} \frac{\Pr(t \le T  t + \Delta t, J=k \mid T \ge t)}{\Delta t}
    $$
    其中 $J$ 是事件类型指示符。总风险是所有原因别定风险之和：$\lambda(t) = \sum_k \lambda_k(t)$。

2.  **累积发生函数 (Cumulative Incidence Function, CIF)** $F_k(t)$：这表示到时间 $t$ 为止，因原因 $k$ 而发生事件的累积概率。它正确地考虑了其他[竞争风险](@entry_id:173277)的存在。其定义为 $F_k(t) = \Pr(T \le t, J=k)$。

CIF与原因别定风险和总生存函数之间的关系至关重要。$F_k(t)$ 的瞬时变化率（即原因 $k$ 的事件发生密度）是原因别定风险 $\lambda_k(u)$ 乘以在时间 $u$ 之前存活（未发生任何事件）的概率 $S(u-)$。因此，CIF可以通过以下积分得到 [@problem_id:3179114]：

$$
F_k(t) = \int_0^t \lambda_k(u) S(u-) du
$$

这里的 $S(u-)$ 是总生存函数在 $u$ 点的[左极限](@entry_id:139055)，代表在时间 $u$ 恰好开始时处于风险中的概率。这个公式强调了，某个特定原因的事件发生概率，不仅取决于该原因自身的风险，还取决于个体能存活足够长的时间以“有机会”经历该事件。这就是[竞争风险分析](@entry_id:634319)的核心洞见。