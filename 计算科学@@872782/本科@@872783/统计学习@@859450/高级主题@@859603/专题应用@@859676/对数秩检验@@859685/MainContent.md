## 引言
在分析“事件发生时间”数据时，例如患者的生存期、机械零件的故障时间或用户的流失时间，我们面临一个独特的挑战：数据删失。由于研究时间有限或受试者失访，我们往往无法观察到所有个体的确切事件时间，这使得传统的统计方法难以适用。[对数秩检验](@entry_id:168043)（Log-rank Test）正是在这种背景下应运而生，成为[生存分析](@entry_id:163785)领域中比较两组或多组生存[分布](@entry_id:182848)的基石方法。

本文旨在全面而深入地剖析[对数秩检验](@entry_id:168043)。我们首先将探讨其为何是处理[删失数据](@entry_id:173222)的理想工具，以及它如何解决直接比较生存时间所带来的问题。通过学习本文，读者将能够掌握[对数秩检验](@entry_id:168043)的完整知识体系，从基本原理到高级应用。

文章结构如下：第一章“原理与机制”将深入其核心逻辑，详细拆解检验统计量的构建过程，并讨论如何处理事件时间平局、混杂因素以及非[比例风险](@entry_id:166780)等复杂情况。第二章“应用与跨学科联系”将展示[对数秩检验](@entry_id:168043)如何超越其[生物统计学](@entry_id:266136)的起源，在工程、商业、计算机科学等多个领域解决实际问题。最后，第三章“动手实践”提供了一系列精心设计的练习，帮助读者将理论知识转化为实践技能。

让我们从[对数秩检验](@entry_id:168043)的基石开始，探究其如何通过巧妙地比较“观测”与“期望”来揭示不同群体间生存体验的差异。

## 原理与机制

在[生存分析](@entry_id:163785)领域，[对数秩检验](@entry_id:168043)（Log-rank Test）是一种基础且功能强大的[非参数方法](@entry_id:138925)，用于比较两组或多组受试者在某一事件发生时间上的[分布](@entry_id:182848)。与依赖于对数据[分布](@entry_id:182848)作出特定假设的参数方法不同，[对数秩检验](@entry_id:168043)不作此类假设，因此具有广泛的适用性。本章将深入探讨[对数秩检验](@entry_id:168043)的核心原理、计算机制及其在各种复杂情境下的应用与扩展。

### 核心问题：比较事件时间[分布](@entry_id:182848)

[生存分析](@entry_id:163785)的核心任务是分析从某个起始点到某个“事件”发生所经过的时间。这些事件可以是多样化的，例如在医学研究中患者的康复或死亡，在工程学中机械部件的失效，或者在社会学中某项社会状态的改变。分析这[类数](@entry_id:156164)据时，我们通常会遇到一个独特的挑战：**删失（censoring）**。[删失数据](@entry_id:173222)是指我们在研究结束时，仍未观察到某些受试者发生事件。例如，一个患者在研究结束时仍然存活，或者一个机械部件在测试结束时仍未损坏。这些删失观测提供了有价值的信息——我们知道它们的生存时间至少是某个值——但我们不知道确切的事件发生时间。这种数据的存在使得直接比较两组的平均或[中位生存时间](@entry_id:634182)变得困难或产生误导。

为了克服这一挑战，[生存分析](@entry_id:163785)引入了两个核心概念：**生存函数（Survival Function）**和**[风险函数](@entry_id:166593)（Hazard Function）**。

**生存函数** $S(t)$ 定义为一个个体生存时间超过时间点 $t$ 的概率，即 $S(t) = P(T > t)$。它是一条从 $S(0)=1$ 开始单调递减至 $S(\infty)=0$ 的曲线，直观地描绘了随着时间推移，群体中“存活”个体的比例。

**[风险函数](@entry_id:166593)** $h(t)$（或称[瞬时失效率](@entry_id:171877)）则描述了在时间点 $t$ 仍然存活的个体，在下一个极小时间间隔内发生事件的[瞬时速率](@entry_id:182981)。它捕捉了在任何给定时刻事件发生的“风险”。生存函数与[风险函数](@entry_id:166593)密切相关，关系式为 $h(t) = -\frac{d}{dt} \ln S(t)$。

[对数秩检验](@entry_id:168043)的根本目的，就是比较两组独立的生存函数是否相同。在一个典型的[假设检验框架](@entry_id:165093)中，其[零假设](@entry_id:265441)（$H_0$）和备择假设（$H_1$）可以正式表述为：

$H_0$: 两组的生存函数在所有时间点上都相同。
$H_1$: 至少在某个时间点上，两组的生存函数不同。

例如，在一个比较两种涡轮叶片合金（X 和 Y）耐久性的工程测试中，研究人员希望确定两种材料的断裂时间[分布](@entry_id:182848)是否存在显著差异 [@problem_id:1962139]。[对数秩检验](@entry_id:168043)的假设将表述为：

$H_0: S_X(t) = S_Y(t)$ 对于所有时间 $t \geq 0$
$H_1: S_X(t) \neq S_Y(t)$ 对于某个时间 $t \geq 0$

此处的 $S_X(t)$ 和 $S_Y(t)$ 分别是合金 X 和合金 Y 的生存函数。由于生存函数与[风险函数](@entry_id:166593)等价，零假设也可以表述为两组的[风险函数](@entry_id:166593)在所有时间点上都相同，即 $H_0: h_X(t) = h_Y(t)$。

### [对数秩检验](@entry_id:168043)的逻辑：比较观测事件数与期望事件数

[对数秩检验](@entry_id:168043)的巧妙之处在于其直观的逻辑。它并不直接比较生存曲线本身，而是逐个检查每个**事件发生的时间点**，并在这个时间点上比较“观测到”的事件数和在[零假设](@entry_id:265441)成立条件下“期望”的事件数。

其核心思想可以概括为以下步骤：
1.  找出数据集中所有**不同的事件发生时间点** $t_1, t_2, \dots, t_k$。检验只在这些时间点上进行计算。
2.  在每个事件时间点 $t_i$ 之前，确定当时仍在被观察且尚未经历事件或删失的个体集合，这个集合被称为**风险集（Risk Set）**。
3.  在[零假设](@entry_id:265441)（即两组风险相同）的前提下，计算在每个事件时间点 $t_i$ 时，我们**期望**在某个特定组（例如，处理组）中看到的事件数量。
4.  将每个事件时间点上，该组的**观测**事件数与**期望**事件数进行比较。
5.  最后，将所有事件时间点的这些差异汇总起来，形成一个总的[检验统计量](@entry_id:167372)。如果这个总差异显著偏离零，我们就有理由拒绝零假设。

**风险集的构建**是此过程的关键。在时刻 $t_i$ 的风险集包含了所有在该时刻“有资格”发生事件的个体。一个受试者在研究开始后，直到其经历事件或被删失之前，都处于风险集中。例如，在一个测试新型生物可降解支架的临床试验中，一名患者在 $t_c$ 时刻因移居国外而退出研究，其数据在 $t_c$ 被[右删失](@entry_id:164686)。对于在 $t_c$ 之前发生的事件（例如在 $t_{before}  t_c$），该患者仍处于观察中，因此他会被包含在 $t_{before}$ 时刻的风险集内。然而，对于在 $t_c$ 之后发生的事件（例如在 $t_{after}  t_c$），该患者已退出研究，因此不会被包含在 $t_{after}$ 时刻的风险集内 [@problem_id:1962149]。

更复杂的情况是存在**延迟进入（delayed entry）**或称**左截断（left truncation）**。当受试者不是从研究的零时刻开始被观察，而是在某个稍后的时间点 $L_i$ 才进入研究时，就会发生这种情况。在这种情况下，一个受试者只有在其进入研究后且在事件或[右删失](@entry_id:164686)发生前，才对风险集有贡献。因此，在时刻 $t_j$，正确的风险集应只包含满足 $L_i \le t_j \le Y_i$ 的个体，其中 $Y_i$ 是观测到的事件或删失时间。忽略延迟进入时间 $L_i$ 会错误地将个体计入他们尚未进入研究时的风险集，从而人为地夸大风险集的大小，可能导致严重的偏倚和错误的结论 [@problem_id:3185170]。

在确定了风险集后，我们可以计算**期望事件数（Expected Events）**。假设在事件时间 $t_i$，总风险集大小为 $n_i$，其中处理组有 $n_{1i}$ 人，[对照组](@entry_id:747837)有 $n_{2i}$ 人（$n_i = n_{1i} + n_{2i}$）。如果在该时刻总共观测到 $d_i$ 个事件，那么在[零假设](@entry_id:265441)（两组风险相同）下，这些事件应该按风险集中的人数比例随机分配到两组中。因此，我们期望在处理组中看到的事件数为：

$E_{1i} = d_i \times \frac{n_{1i}}{n_i}$

相应的，处理组在该时刻的**观测事件数（Observed Events）**就是实际记录到的事件数，记为 $O_{1i}$。[对数秩检验](@entry_id:168043)的核心就是汇总每个事件时间点的差值 $(O_{1i} - E_{1i})$。

### 构建[检验统计量](@entry_id:167372)：一步步计算

[对数秩检验](@entry_id:168043)统计量将所有事件时间点的“观测减期望”之差进行标准化汇总。其标准形式通常表示为卡方统计量 $X^2$：

$X^2 = \frac{\left( \sum_{i=1}^{k} (O_{1i} - E_{1i}) \right)^2}{\sum_{i=1}^{k} V_i}$

其中，求和遍历所有 $k$ 个不同的事件时间点。分子是总的观测事件数与总的期望事件数之差的平方。分母 $\sum V_i$ 是总[方差](@entry_id:200758)，用于[标准化](@entry_id:637219)这个差异。$V_i$ 是在第 $i$ 个事件时间点上，差值 $(O_{1i} - E_{1i})$ 的[方差](@entry_id:200758)。

在[零假设](@entry_id:265441)下，$d_{1i}$（即 $O_{1i}$）的[分布](@entry_id:182848)可以被建模。具体来说，给定风险集大小 $n_{1i}$, $n_{2i}$ 和总事件数 $d_i$，观测到的处理组事件数 $d_{1i}$ 服从[超几何分布](@entry_id:193745)。[超几何分布](@entry_id:193745)的[方差](@entry_id:200758)给出了 $V_i$ 的精确表达式：

$V_i = \text{Var}(O_{1i}) = d_i \frac{n_{1i}}{n_i} \left( 1 - \frac{n_{1i}}{n_i} \right) \frac{n_i - d_i}{n_i - 1} = d_i \frac{n_{1i} n_{2i}}{n_i^2} \frac{n_i - d_i}{n_i - 1}$

这个公式自然地处理了**事件时间平局（ties）**，即当 $d_i  1$ 时的情况。

让我们通过一个实例来演示完整的计算过程。假设一项研究比较一种新型添加剂（处理组）与无添加剂（[对照组](@entry_id:747837)）对[塑料降解](@entry_id:178134)时间的影响 [@problem_id:1962148]。数据如下：
*   **处理组 (Group 1):** 8, 11, 15, 15, 20, 22, 25+, 25+, 25+, 25+
*   **对照组 (Group 2):** 12, 17, 19, 21, 24, 25+, 25+, 25+, 25+, 25+

我们为每个事件时间点构建一个计算表格：

| 事件时间 $t_i$ | 风险数 $n_{1i}, n_{2i}$ | 事件数 $d_{1i}, d_{2i}$ | 总事件数 $d_i$ | $O_{1i}$ | $E_{1i} = d_i \frac{n_{1i}}{n_{1i}+n_{2i}}$ | $O_{1i} - E_{1i}$ | $V_i$ |
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
| 8 | 10, 10 | 1, 0 | 1 | 1 | $1 \cdot \frac{10}{20} = 0.500$ | 0.500 | 0.250 |
| 11 | 9, 10 | 1, 0 | 1 | 1 | $1 \cdot \frac{9}{19} = 0.474$ | 0.526 | 0.249 |
| 12 | 8, 10 | 0, 1 | 1 | 0 | $1 \cdot \frac{8}{18} = 0.444$ | -0.444 | 0.247 |
| 15 | 8, 9 | 2, 0 | 2 | 2 | $2 \cdot \frac{8}{17} = 0.941$ | 1.059 | 0.467 |
| 17 | 6, 9 | 0, 1 | 1 | 0 | $1 \cdot \frac{6}{15} = 0.400$ | -0.400 | 0.240 |
| 19 | 6, 8 | 0, 1 | 1 | 0 | $1 \cdot \frac{6}{14} = 0.429$ | -0.429 | 0.245 |
| 20 | 6, 7 | 1, 0 | 1 | 1 | $1 \cdot \frac{6}{13} = 0.462$ | 0.538 | 0.249 |
| 21 | 5, 7 | 0, 1 | 1 | 0 | $1 \cdot \frac{5}{12} = 0.417$ | -0.417 | 0.243 |
| 22 | 5, 6 | 1, 0 | 1 | 1 | $1 \cdot \frac{5}{11} = 0.455$ | 0.545 | 0.248 |
| 24 | 4, 6 | 0, 1 | 1 | 0 | $1 \cdot \frac{4}{10} = 0.400$ | -0.400 | 0.240 |
| **总计** | | | | | | **1.079** | **2.678** |

根据表格的汇总结果：
$\sum (O_{1i} - E_{1i}) = 1.079$
$\sum V_i = 2.678$

[检验统计量](@entry_id:167372)为：
$X^2 = \frac{(1.079)^2}{2.678} \approx 0.4351$

在零假设下，$X^2$ 近似服从自由度为1的卡方分布。我们可以将计算出的值与[卡方分布](@entry_id:165213)的临界值进行比较，以获得 p 值并作出统计推断。

### 高级主题与实践考量

#### 事件时间平局的处理

在上面的例子中，我们在 $t=15$ 时刻处理了一个平局事件（$d=2$）。我们使用的[方差](@entry_id:200758)公式是“精确”方法，因为它源于[超几何分布](@entry_id:193745)，该[分布](@entry_id:182848)是[无放回抽样](@entry_id:276879)的正确模型。然而，在作为[对数秩检验](@entry_id:168043)理论基础的 Cox [比例风险模型](@entry_id:171806)中，精确似然的计算可能非常耗时。因此，发展出了几种近似方法 [@problem_id:3185176]：

*   **Breslow 近似**：将抽样过程近似为“有放回”抽样，对应于[二项分布](@entry_id:141181)。其[方差](@entry_id:200758)公式忽略了超几何[方差](@entry_id:200758)中的修正因子 $\frac{n_i - d_i}{n_i - 1}$，因此 $V_i^{\text{Breslow}} = d_i \frac{n_{1i} n_{2i}}{n_i^2}$。这个[方差](@entry_id:200758)总是比精确[方差](@entry_id:200758)大，因此是一种保守的近似。
*   **Efron 近似**：这是对 Breslow 近似的一种改进，它在精确方法和 Breslow 方法之间取得了平衡。其[方差](@entry_id:200758)值介于两者之间：$\operatorname{Var}_{\text{Breslow}}  \operatorname{Var}_{\text{Efron}}  \operatorname{Var}_{\text{exact}}$。

由于[检验统计量](@entry_id:167372) $Z = \frac{\sum(O-E)}{\sqrt{\sum V}}$ 的大小与[方差](@entry_id:200758)的平方根成反比，使用 Breslow 近似将得到最保守的（即最小的[绝对值](@entry_id:147688)）检验统计量。在现代软件中，通常可以选择使用这些不同的方法。

#### 分层[对数秩检验](@entry_id:168043)

在多中心临床试验或存在已知重要混杂因素（如年龄组、疾病严重程度）的研究中，直接汇总所有数据可能会产生误导，类似于[辛普森悖论](@entry_id:136589)。**分层[对数秩检验](@entry_id:168043)（Stratified Log-rank Test）** 提供了一个解决方案。其思想是在每个“层”（stratum）内部分别进行“观测减期望”和[方差](@entry_id:200758)的计算，然后将结果汇总 [@problem_id:1962152]。

具体来说，假设有 $K$ 个分层。分层[检验统计量](@entry_id:167372) $U_{\text{strat}}$ 和其[方差](@entry_id:200758) $V_{\text{strat}}$ 的计算方式如下：

$U_{\text{strat}} = \sum_{k=1}^{K} U_k = \sum_{k=1}^{K} \left( \sum_{i} (O_{ki} - E_{ki}) \right)$

$V_{\text{strat}} = \sum_{k=1}^{K} V_k = \sum_{k=1}^{K} \left( \sum_{i} V_{ki} \right)$

最终的[检验统计量](@entry_id:167372)为 $X^2_{\text{strat}} = \frac{U_{\text{strat}}^2}{V_{\text{strat}}}$。这种方法假设[处理效应](@entry_id:636010)在各层之间是同向的，并通过在层内进行比较来有效地控制混杂因素。

#### 加权[对数秩检验](@entry_id:168043)与检验效能

标准[对数秩检验](@entry_id:168043)对所有事件时间点的 $(O_i - E_i)$ 差异给予相同的权重（即权重为1）。这种做法在一个关键假设下是最优（即最“有效力”的）：**[比例风险](@entry_id:166780)（Proportional Hazards）**假设。该假设意味着两组的[风险函数](@entry_id:166593)在所有时间点上成恒定比例，即 $h_1(t) = \theta h_2(t)$，其中 $\theta$ 是一个不随时间改变的常数。

然而，在许多实际情况中，[比例风险假设](@entry_id:163597)可能不成立。例如，一种新疗法可能在早期效果显著，但长期效果减弱，导致[风险比](@entry_id:173429)随时间变化。另一种情况是生存[曲线交叉](@entry_id:189391)，意味着一组在早期风险更高，但在[后期](@entry_id:165003)风险变得更低。在这些非[比例风险](@entry_id:166780)的情况下，标准[对数秩检验](@entry_id:168043)的效能可能会大幅下降，因为它可能会将早期和晚期的相反效应相互抵消。

为了应对这种情况，**加权[对数秩检验](@entry_id:168043)（Weighted Log-rank Tests）**被提出。这类检验在汇总 $(O_i - E_i)$ 时引入了一个权重函数 $W(t_i)$：

$U_W = \sum_{i=1}^{k} W(t_i) (O_{1i} - E_{1i})$

一个著名的加权检验族是 $G^{\rho}$ 族 [@problem_id:1962137]，其权重为 $W(t) = [\hat{S}(t-)]^{\rho}$，其中 $\hat{S}(t-)$ 是合并样本的 [Kaplan-Meier](@entry_id:169317) 生存估计。
*   当 $\rho=0$ 时，权重 $W(t)=1$，这就是标准的[对数秩检验](@entry_id:168043)，对[比例风险](@entry_id:166780)备择假设最有效。
*   当 $\rho0$ 时（例如，Peto-Peto 检验），会给早期事件更大的权重。这适用于生存曲线早期分离，后期趋同的情况。
*   当 $\rho0$ 时，会给晚期事件更大的权重。

对于生存[曲线交叉](@entry_id:189391)的复杂情况，一个精心设计的权重函数可以显著提高检验效能。例如，如果已知曲线在 $t^*$ 时刻交叉，且处理组在 $t^*$ 前风险较低，在 $t^*$ 后风险较高，那么一个理想的权重函数将是 $w(t) = +1$ 当 $t \le t^*$ 且 $w(t) = -1$ 当 $t  t^*$。这样的权重函数可以确保早期和晚期的效应在统计量中同向累积，而不是相互抵消，从而最大化检验的效能 [@problem_id:3185127]。

#### 理论基础与更广泛的背景

从更深的理论层面看，[对数秩检验](@entry_id:168043)统计量可以基于**[计数过程](@entry_id:260664)（counting process）**和**[鞅](@entry_id:267779)论（martingale theory）**来构建。在这个框架下，每个组的事件[计数过程](@entry_id:260664) $N_i(t)$ 可以分解为一个可预测的累积风险部分（补偿器）和一个均值为零的鞅部分。对数秩统计量的核心 $Z = \int (dN_1(t) - \frac{Y_1(t)}{Y(t)}dN(t))$ 可以被证明在[零假设](@entry_id:265441)下是一个鞅 [@problem_id:1962135]。这意味着它的[期望值](@entry_id:153208)为零，即 $E[Z]=0$。[鞅中心极限定理](@entry_id:198119)进一步保证了在样本量足够大时，标准化后的统计量会收敛到正态分布，这为我们使用[卡方分布](@entry_id:165213)或[正态分布](@entry_id:154414)进行[假设检验](@entry_id:142556)提供了理论依据。

这个理论框架也帮助我们理解在**[竞争风险](@entry_id:173277)（competing risks）**设置中[对数秩检验](@entry_id:168043)的正确解释。当存在多种类型的事件时，分析其中一种特定事件（如“疾病进展”）时，通常将其他类型的事件（如“因其他原因死亡”）视为删失。一个重要的问题是，如果两组在竞争事件的风险上存在差异，这是否会使我们对目标事件的检验产生偏倚？答案是不会。即使竞争事件的风险不同，只要我们感兴趣的特定原因的风险（即**特定原因[风险函数](@entry_id:166593), cause-specific hazard function**）在两组间是相同的（即零假设成立），那么[对数秩检验](@entry_id:168043)统计量的[期望值](@entry_id:153208)仍然为零 [@problem_id:1962154]。因此，[对数秩检验](@entry_id:168043)在这种情况下仍然是有效的，但它的结论必须被严谨地解释为关于“特定原因风险”的比较，而不是关于事件发生累积概率的比较。