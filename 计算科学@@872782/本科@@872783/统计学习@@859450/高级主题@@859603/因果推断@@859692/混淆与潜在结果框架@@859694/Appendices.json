{"hands_on_practices": [{"introduction": "理论是抽象的，但混淆的效应是具体而强大的。这项练习将通过一个精心设计的数值示例，带你亲手构建并分析辛普森悖论。通过计算分层和边际期望，你将清晰地看到一个混淆变量如何能够完全逆转我们观察到的关联性，从而深刻理解为什么不能轻易地从简单的边际关联中得出因果结论。[@problem_id:3110506]", "problem": "考虑一个二元处理 $A \\in \\{0,1\\}$，一个二元结果 $Y \\in \\{0,1\\}$，以及一个二元预处理协变量（混杂因素）$X \\in \\{0,1\\}$。令 $Y(1)$ 和 $Y(0)$ 分别表示在处理和控制下的潜在结果。假设以下数据生成过程成立：\n\n1. 协变量分布：$\\mathbb{P}(X=1)=\\frac{9}{10}$ 且 $\\mathbb{P}(X=0)=\\frac{1}{10}$。\n\n2. 处理分配依赖于 $X$，但在给定 $X$ 的条件下不依赖于潜在结果（条件可交换性）。具体来说，$\\mathbb{P}(A=1 \\mid X=1)=\\frac{19}{20}$ 且 $\\mathbb{P}(A=1 \\mid X=0)=\\frac{1}{20}$。同时假设正定性和一致性成立，即观测结果满足 $Y=Y(A)$。\n\n3. 潜在结果分布（在 $X$ 的每个分层内，处理都是有益的）：\n   - 对于 $X=1$：$Y(1)\\mid X=1 \\sim \\mathrm{Bernoulli}\\!\\left(\\frac{13}{20}\\right)$ 且 $Y(0)\\mid X=1 \\sim \\mathrm{Bernoulli}\\!\\left(\\frac{3}{5}\\right)$。\n   - 对于 $X=0$：$Y(1)\\mid X=0 \\sim \\mathrm{Bernoulli}\\!\\left(\\frac{19}{20}\\right)$ 且 $Y(0)\\mid X=0 \\sim \\mathrm{Bernoulli}\\!\\left(\\frac{9}{10}\\right)$。\n\n你的任务：\n\na) 仅使用概率法则和潜在结果框架（一致性、给定 $X$ 的条件可交换性以及正定性），计算以下期望：\n- 边缘期望 $\\mathbb{E}[Y \\mid A=1]$ 和 $\\mathbb{E}[Y \\mid A=0]$。\n- 对于 $x \\in \\{0,1\\}$ 的条件期望 $\\mathbb{E}[Y \\mid A=1, X=x]$ 和 $\\mathbb{E}[Y \\mid A=0, X=x]$。\n\nb) 定义边缘关联对比 $\\Delta_{\\mathrm{marg}} \\equiv \\mathbb{E}[Y \\mid A=1]-\\mathbb{E}[Y \\mid A=0]$ 和对于 $x \\in \\{0,1\\}$ 的层内关联对比 $\\Delta_{x} \\equiv \\mathbb{E}[Y \\mid A=1, X=x]-\\mathbb{E}[Y \\mid A=0, X=x]$。精确计算 $\\Delta_{\\mathrm{marg}}$、$\\Delta_{0}$ 和 $\\Delta_{1}$。\n\nc) 使用潜在结果术语和全期望定律，简要解释在此设置中，为什么 $\\Delta_{\\mathrm{marg}}$ 的符号会相对于 $\\Delta_{0}$ 和 $\\Delta_{1}$ 的符号发生反转（即，证明由 $X$ 的混杂效应引起的辛普森悖论）。\n\n答案规格：\n- 以单行矩阵的形式，按顺序提供 $(\\Delta_{\\mathrm{marg}}, \\Delta_{0}, \\Delta_{1})$ 的最终数值结果，结果为精确的最简分数。\n- 无需四舍五入。不包含任何单位。", "solution": "我们从基本原则出发：潜在结果框架，包括一致性 ($Y=Y(A)$)、给定 $X$ 的条件可交换性 ($A \\perp (Y(0),Y(1)) \\mid X$)、正定性，以及全概率定律和全期望定律。\n\n步骤 1：使用贝叶斯法则计算 $\\mathbb{P}(A=1)$、$\\mathbb{P}(A=0)$ 以及各处理组内的协变量分布。\n\n已知 $\\mathbb{P}(X=1)=\\frac{9}{10}$ 且 $\\mathbb{P}(X=0)=\\frac{1}{10}$，以及 $\\mathbb{P}(A=1 \\mid X=1)=\\frac{19}{20}$、$\\mathbb{P}(A=1 \\mid X=0)=\\frac{1}{20}$，我们有\n$$\n\\mathbb{P}(A=1)=\\mathbb{P}(A=1 \\mid X=1)\\mathbb{P}(X=1)+\\mathbb{P}(A=1 \\mid X=0)\\mathbb{P}(X=0)\n=\\frac{19}{20}\\cdot \\frac{9}{10}+\\frac{1}{20}\\cdot \\frac{1}{10}\n=\\frac{171}{200}+\\frac{1}{200}\n=\\frac{172}{200}\n=\\frac{43}{50}.\n$$\n因此 $\\mathbb{P}(A=0)=1-\\frac{43}{50}=\\frac{7}{50}$。\n\n现在，\n$$\n\\mathbb{P}(X=1 \\mid A=1)=\\frac{\\mathbb{P}(A=1 \\mid X=1)\\mathbb{P}(X=1)}{\\mathbb{P}(A=1)}\n=\\frac{\\frac{19}{20}\\cdot \\frac{9}{10}}{\\frac{43}{50}}\n=\\frac{\\frac{171}{200}}{\\frac{43}{50}}\n=\\frac{171}{200}\\cdot \\frac{50}{43}\n=\\frac{171}{172},\n$$\n且\n$$\n\\mathbb{P}(X=0 \\mid A=1)=1-\\frac{171}{172}=\\frac{1}{172}.\n$$\n对于 $A=0$ 同理，\n$$\n\\mathbb{P}(X=1 \\mid A=0)=\\frac{\\mathbb{P}(A=0 \\mid X=1)\\mathbb{P}(X=1)}{\\mathbb{P}(A=0)}\n=\\frac{\\frac{1}{20}\\cdot \\frac{9}{10}}{\\frac{7}{50}}\n=\\frac{\\frac{9}{200}}{\\frac{7}{50}}\n=\\frac{9}{200}\\cdot \\frac{50}{7}\n=\\frac{9}{28},\n$$\n且\n$$\n\\mathbb{P}(X=0 \\mid A=0)=1-\\frac{9}{28}=\\frac{19}{28}.\n$$\n\n步骤 2：计算条件期望 $\\mathbb{E}[Y \\mid A=a, X=x]$。\n\n根据一致性和给定 $X$ 的条件可交换性，我们有 $\\mathbb{E}[Y \\mid A=a, X=x]=\\mathbb{E}[Y(a)\\mid X=x]$。使用给定的潜在结果分布：\n- 对于 $X=1$：$\\mathbb{E}[Y \\mid A=1, X=1]=\\mathbb{E}[Y(1)\\mid X=1]=\\frac{13}{20}$ 且 $\\mathbb{E}[Y \\mid A=0, X=1]=\\mathbb{E}[Y(0)\\mid X=1]=\\frac{3}{5}=\\frac{12}{20}$。\n- 对于 $X=0$：$\\mathbb{E}[Y \\mid A=1, X=0]=\\mathbb{E}[Y(1)\\mid X=0]=\\frac{19}{20}$ 且 $\\mathbb{E}[Y \\mid A=0, X=0]=\\mathbb{E}[Y(0)\\mid X=0]=\\frac{9}{10}=\\frac{18}{20}$。\n\n因此，层内关联对比为\n$$\n\\Delta_{1}=\\mathbb{E}[Y \\mid A=1, X=1]-\\mathbb{E}[Y \\mid A=0, X=1]=\\frac{13}{20}-\\frac{12}{20}=\\frac{1}{20},\n$$\n$$\n\\Delta_{0}=\\mathbb{E}[Y \\mid A=1, X=0]-\\mathbb{E}[Y \\mid A=0, X=0]=\\frac{19}{20}-\\frac{18}{20}=\\frac{1}{20}.\n$$\n\n步骤 3：通过全期望定律计算边缘期望 $\\mathbb{E}[Y \\mid A=1]$ 和 $\\mathbb{E}[Y \\mid A=0]$：\n$$\n\\mathbb{E}[Y \\mid A=1]=\\sum_{x \\in \\{0,1\\}} \\mathbb{E}[Y \\mid A=1, X=x]\\;\\mathbb{P}(X=x \\mid A=1)\n=\\frac{13}{20}\\cdot \\frac{171}{172}+\\frac{19}{20}\\cdot \\frac{1}{172}.\n$$\n精确计算：\n$$\n\\frac{13}{20}\\cdot \\frac{171}{172}=\\frac{2223}{3440},\\qquad \\frac{19}{20}\\cdot \\frac{1}{172}=\\frac{19}{3440},\n$$\n所以\n$$\n\\mathbb{E}[Y \\mid A=1]=\\frac{2223+19}{3440}=\\frac{2242}{3440}=\\frac{1121}{1720}.\n$$\n类似地，\n$$\n\\mathbb{E}[Y \\mid A=0]=\\sum_{x \\in \\{0,1\\}} \\mathbb{E}[Y \\mid A=0, X=x]\\;\\mathbb{P}(X=x \\mid A=0)\n=\\frac{3}{5}\\cdot \\frac{9}{28}+\\frac{9}{10}\\cdot \\frac{19}{28}.\n$$\n精确计算：\n$$\n\\frac{3}{5}\\cdot \\frac{9}{28}=\\frac{27}{140},\\qquad \\frac{9}{10}\\cdot \\frac{19}{28}=\\frac{171}{280},\n$$\n所以\n$$\n\\mathbb{E}[Y \\mid A=0]=\\frac{27}{140}+\\frac{171}{280}=\\frac{54}{280}+\\frac{171}{280}=\\frac{225}{280}=\\frac{45}{56}.\n$$\n\n步骤 4：计算边缘关联对比 $\\Delta_{\\mathrm{marg}}$ 并确认符号反转。\n$$\n\\Delta_{\\mathrm{marg}}=\\mathbb{E}[Y \\mid A=1]-\\mathbb{E}[Y \\mid A=0]=\\frac{1121}{1720}-\\frac{45}{56}.\n$$\n进行通分。$1720$ 和 $56$ 的最小公倍数是 $12040$，所以\n$$\n\\frac{1121}{1720}=\\frac{7847}{12040},\\qquad \\frac{45}{56}=\\frac{9675}{12040},\n$$\n因此\n$$\n\\Delta_{\\mathrm{marg}}=\\frac{7847-9675}{12040}=-\\frac{1828}{12040}=-\\frac{457}{3010}.\n$$\n所以，\n$$\n\\Delta_{\\mathrm{marg}}=-\\frac{457}{3010},\\qquad \\Delta_{0}=\\frac{1}{20},\\qquad \\Delta_{1}=\\frac{1}{20}.\n$$\n我们观察到了辛普森悖论：在 $X$ 的每个分层内，关联对比是正的（处理看起来是有益的），但在边缘上，关联对比是负的（处理看起来是有害的）。\n\n步骤 5：使用潜在结果解释符号反转。\n根据给定 $X$ 的条件可交换性，$\\mathbb{E}[Y \\mid A=a, X=x]=\\mathbb{E}[Y(a)\\mid X=x]$，所以层内对比 $\\Delta_{x}$ 反映了层内的因果对比，并且在这里是正的。然而，边缘关联对比通过 $\\mathbb{E}[Y \\mid A=a]=\\sum_{x}\\mathbb{E}[Y(a)\\mid X=x]\\mathbb{P}(X=x \\mid A=a)$ 混合了具有不同基线风险的分层。由于处理分配相对于 $X$ 是高度不平衡的（大多数被处理者具有 $X=1$，那里的结果较低；大多数控制组具有 $X=0$，那里的结果较高），权重 $\\mathbb{P}(X=x \\mid A=a)$ 在 $A=1$ 和 $A=0$ 之间有显著不同。这种差异化的加权压倒了层内的益处，并反转了边缘关联的符号。用潜在结果的术语来说，存在由 $X$ 引起的混杂，因此在边缘上 $A \\not\\perp (Y(0),Y(1))$，并且边缘关联不等于因果效应，即使特定分层的因果效应是有益的。这正是辛普森悖论，它产生于具有不同基线风险的分层混合以及跨分层的不均匀处理分配。", "answer": "$$\\boxed{\\begin{pmatrix}-\\frac{457}{3010}  \\frac{1}{20}  \\frac{1}{20}\\end{pmatrix}}$$", "id": "3110506"}, {"introduction": "在因果推断中，一个常见的误区是混淆了“预测”与“平衡”。这个思想实验旨在打破这一误解。你将看到，即使一个倾向性得分模型能够几乎完美地预测处理分配，严重的混淆偏倚依然可能存在，这揭示了获得良好协变量平衡对于因果估计的至关重要性，而这并非预测准确性所能保证的。[@problem_id:3110561]", "problem": "考虑一个二元处理 $A \\in \\{0,1\\}$，一个二元协变量 $X \\in \\{0,1\\}$，以及在稳定单位处理价值假设（SUTVA）下定义的结果。SUTVA 假设每个单位都有明确定义的潜在结果 $Y(0)$ 和 $Y(1)$，并且观测结果为 $Y = A Y(1) + (1-A) Y(0)$，单位之间不存在干扰。设协变量的总体分布为 $P(X=1) = 0.5$ 和 $P(X=0) = 0.5$。潜在结果是 $X$ 的确定性函数，由以下公式给出：\n$$\nY(0) = 2 + X, \\qquad Y(1) = 5 + 3X.\n$$\n处理分配强依赖于 $X$，由以下公式给出：\n$$\nP(A=1 \\mid X=1) = 0.99, \\qquad P(A=1 \\mid X=0) = 0.01.\n$$\n一位研究者拟合了一个倾向性模型，该模型输出的 $\\hat{p}(X) = P(A=1 \\mid X)$ 与上述完全一致，从而得到了一个从 $X$ 预测 $A$ 的近乎完美的预测因子。使用潜在结果框架，从第一性原理出发：\n- 识别在目标总体中定义为 $\\mathbb{E}[Y(1) - Y(0)]$ 的真实平均处理效应 (ATE)。\n- 在给定的分配机制下，推导观测均值中朴素差异的期望值 $\\mathbb{E}[Y \\mid A=1] - \\mathbb{E}[Y \\mid A=0]$。\n- 计算偏差，其定义为朴素均值差异减去真实 ATE，并报告该值。\n\n你的最终答案必须是偏差，表示为单个实数。请提供精确值，无需四舍五入。最终答案不带单位。", "solution": "该问题要求计算三个量：真实平均处理效应 (ATE)、观测均值的朴素差异以及由此产生的偏差。\n\n#### 1. 真实平均处理效应 (ATE)\nATE 是处理组和对照组潜在结果之差在整个总体上的期望值。\n$$\n\\text{ATE} = \\mathbb{E}[Y(1) - Y(0)]\n$$\n由于潜在结果依赖于协变量 $X$，我们可以通过以 $X$ 为条件来计算此期望值：\n$$\n\\text{ATE} = \\sum_{x \\in \\{0,1\\}} (\\mathbb{E}[Y(1) \\mid X=x] - \\mathbb{E}[Y(0) \\mid X=x]) P(X=x)\n$$\n鉴于 $Y(0)$ 和 $Y(1)$ 是 $X$ 的确定性函数，条件期望就是函数在给定 $x$ 处的值。\n对于 $X=0$：$Y(1) - Y(0) = (5 + 3(0)) - (2 + 0) = 3$。\n对于 $X=1$：$Y(1) - Y(0) = (5 + 3(1)) - (2 + 1) = 5$。\n\nATE 是这些分层特定效应的加权平均，权重由每个分层的概率给出：\n$$\n\\text{ATE} = (3) \\cdot P(X=0) + (5) \\cdot P(X=1)\n$$\n使用给定的分布 $P(X=0) = 0.5$ 和 $P(X=1) = 0.5$：\n$$\n\\text{ATE} = (3)(0.5) + (5)(0.5) = 1.5 + 2.5 = 4\n$$\n\n#### 2. 观测均值的朴素差异\n处理效应的朴素估计量是处理组和对照组之间观测结果均值的差异。\n$$\n\\text{Naive Difference} = \\mathbb{E}[Y \\mid A=1] - \\mathbb{E}[Y \\mid A=0]\n$$\n在 SUTVA 假设下，这等于 $\\mathbb{E}[Y(1) \\mid A=1] - \\mathbb{E}[Y(0) \\mid A=0]$。为了计算这些条件期望，我们需要每个处理组内协变量 $X$ 的分布 $P(X=x \\mid A=a)$。我们使用贝叶斯定理。首先，处理的边际概率 $P(A=1)$ 为：\n$$\nP(A=1) = P(A=1 \\mid X=1)P(X=1) + P(A=1 \\mid X=0)P(X=0)\n$$\n$$\nP(A=1) = (0.99)(0.5) + (0.01)(0.5) = 0.495 + 0.005 = 0.5\n$$\n因此 $P(A=0) = 1 - 0.5 = 0.5$。\n\n现在我们求在 $A=1$ 的条件下 $X$ 的条件分布：\n$$\nP(X=1 \\mid A=1) = \\frac{P(A=1 \\mid X=1)P(X=1)}{P(A=1)} = \\frac{(0.99)(0.5)}{0.5} = 0.99\n$$\n$$\nP(X=0 \\mid A=1) = 1 - 0.99 = 0.01\n$$\n处理组的期望结果是：\n$$\n\\mathbb{E}[Y(1) \\mid A=1] = \\mathbb{E}[5+3X \\mid A=1] = 5 + 3\\mathbb{E}[X \\mid A=1] = 5 + 3(1 \\cdot 0.99 + 0 \\cdot 0.01) = 5 + 2.97 = 7.97\n$$\n接下来，我们求在 $A=0$ 的条件下 $X$ 的条件分布：\n$$\nP(X=1 \\mid A=0) = \\frac{P(A=0 \\mid X=1)P(X=1)}{P(A=0)} = \\frac{(1 - 0.99)(0.5)}{0.5} = 0.01\n$$\n$$\nP(X=0 \\mid A=0) = 1 - 0.01 = 0.99\n$$\n对照组的期望结果是：\n$$\n\\mathbb{E}[Y(0) \\mid A=0] = \\mathbb{E}[2+X \\mid A=0] = 2 + \\mathbb{E}[X \\mid A=0] = 2 + (1 \\cdot 0.01 + 0 \\cdot 0.99) = 2 + 0.01 = 2.01\n$$\n朴素均值差异为：\n$$\n\\text{Naive Difference} = 7.97 - 2.01 = 5.96\n$$\n\n#### 3. 偏差计算\n偏差定义为朴素估计量与真实 ATE 之间的差异。\n$$\n\\text{Bias} = (\\mathbb{E}[Y \\mid A=1] - \\mathbb{E}[Y \\mid A=0]) - \\text{ATE}\n$$\n代入计算出的值：\n$$\n\\text{Bias} = 5.96 - 4 = 1.96\n$$\n这个正偏差的产生是因为处理分配与协变量 $X$ 强相关，而 $X$ 本身是潜在结果的一个决定因素。这种现象被称为混杂。具体来说，具有 $X=1$ 的个体（他们在处理和对照条件下都有更高的潜在结果）更有可能接受处理。这夸大了处理组的观测均值，并压低了对照组的观测均值，从而导致对处理效应的高估。", "answer": "$$\n\\boxed{1.96}\n$$", "id": "3110561"}, {"introduction": "在任何现实世界的观察性研究中，我们都必须面对“未观测到的混淆”这一幽灵。我们如何量化它对我们结论的潜在威胁？这项练习将向你介绍 E-值，一个强大的敏感性分析工具。通过推导并计算 E-值，你将学会如何评估一个未测量的混淆因素需要多强才能完全“解释掉”我们观察到的效应，从而使我们的因果推断更加严谨和稳健。[@problem_id:3110463]", "problem": "考虑一项关于二元处理 $A \\in \\{0,1\\}$ 和二元结果 $Y \\in \\{0,1\\}$ 的观察性研究。设潜在结果为 $Y(1)$ 和 $Y(0)$，并将因果风险比定义为 $RR^{\\text{causal}} = \\frac{\\mathbb{E}[Y(1)]}{\\mathbb{E}[Y(0)]}$。观察到的关联由风险比 (RR) $\\widehat{RR} = \\frac{P(Y=1 \\mid A=1)}{P(Y=1 \\mid A=0)}$ 来概括。假设可能存在一个单一的未测量二元混杂因素 $U$，在对已测量协变量进行条件化后，它与 $A$ 和 $Y$ 都有关联。\n\n从潜在结果的定义和那些为风险比尺度上未测量混杂所致的乘性偏倚设定界限的成熟结果出发，推导E值作为 $\\widehat{RR}$ 函数的闭式表达式。其中，E值定义为最小的等强度风险比 $E$，使得 $U$ 与 $Y$ 之间的关联（在 $A$ 的各水平内）和 $U$ 与 $A$ 之间的关联能够共同作用，将 $RR^{\\text{causal}}$ 降至 $1$，同时再现观察到的 $\\widehat{RR}$。然后，使用你推导出的表达式，计算当 $\\widehat{RR} = 1.8$ 时的E值。将你的数值答案四舍五入到 $4$ 位有效数字。不需要单位。最后，简要解释此E值对于“解释掉”观察到的效应所需的最小混杂强度意味着什么。", "solution": "E值的推导始于观察风险比（$\\widehat{RR}$）、真实因果风险比（$RR^{\\text{causal}}$）以及由未测量混杂因素 $U$ 引入的偏倚因子 $B$ 之间的关系。对于一个观察风险比 $\\widehat{RR} > 1$，该关系可以表示为 $\\widehat{RR} = RR^{\\text{causal}} \\times B$。要“解释掉”观察到的关联，意味着找到一个与真实因果风险比为 $1$（即 $RR^{\\text{causal}} = 1$）相容的混杂结构，此时 $\\widehat{RR} = B$。这意味着要让混杂完全解释观察到的风险比，偏倚因子必须等于 $\\widehat{RR}$。\n\nE值被定义为能产生所需偏倚的最小等强度关联 $E$。设 $RR_{AU}$ 为混杂因素与处理之间的风险比关联，设 $RR_{UY}$ 为混杂因素与结果之间的风险比关联。偏倚因子的一个著名上界由这两个参数给出。E值对应于设置 $RR_{AU} = RR_{UY} = E$ 且该组合恰好能产生大小为 $\\widehat{RR}$ 的偏倚的情况。\n\n最广为接受的推导最终得出的闭式表达式为：\n$$ E\\text{-值} = \\widehat{RR} + \\sqrt{\\widehat{RR}(\\widehat{RR}-1)} $$\n此公式适用于 $\\widehat{RR} \\ge 1$。如果 $\\widehat{RR} < 1$，则在计算前先取其倒数。\n\n现在，我们计算 $\\widehat{RR} = 1.8$ 时的E值。\n$$ E = 1.8 + \\sqrt{1.8(1.8 - 1)} $$\n$$ E = 1.8 + \\sqrt{1.8 \\times 0.8} $$\n$$ E = 1.8 + \\sqrt{1.44} $$\n$$ E = 1.8 + 1.2 $$\n$$ E = 3.0 $$\n四舍五入到4位有效数字，E值为 $3.000$。\n\n最后，我们解释这个结果。对于一个观察风险比为 $1.8$，其E值为 $3.000$ 意味着，一个未测量的混杂因素要完全解释掉这个观察到的关联（即将真实的因果风险比降至 $1.0$），它需要与处理和结果的关联强度（以风险比衡量）均至少为 $3.0$（在调整了已测量协变量之后）。例如，该混杂因素必须使结果的风险增加三倍，并且在处理组中的普遍性是未处理组中的三倍。可以通过将这种所需的关联强度（$E=3.0$）与已知风险因素的强度进行比较，来评估这种混杂解释的合理性。如果认为如此强的混杂是不太可能的，那么关于因果效应的推断就更为稳健。", "answer": "$$\n\\boxed{3.000}\n$$", "id": "3110463"}]}