{"hands_on_practices": [{"introduction": "大M法的核心在于使用一个足够大的常数$M$来“开关”约束。然而，$M$值的选择并非随心所欲；它必须足够大以确保约束在非激活状态下是冗余的，但过大的$M$值会削弱模型的线性规划松弛，导致求解效率低下。这个练习将引导你为一个典型的析取约束（$x \\le 30$ 或 $x \\ge 70$）推导出最小的有效$M$值，从而让你对“紧凑”公式的含义及其重要性有一个扎实的理解 ([@problem_id:3102348])。", "problem": "一个实值决策变量 $x$ 的界限为 $x \\in [0,100]$。您希望在混合整数线性规划 (MILP) 的框架内，使用一个二元决策变量 $y \\in \\{0,1\\}$ 来强制执行逻辑析取 $x \\leq 30$ 或 $x \\geq 70$。从大M法（big-$M$ method）使用上下界常数根据二元变量的值来使线性约束失效的基本定义出发，推导一个通过大M法对此析取进行建模的线性不等式系统。仅使用给定的 $x$ 的界限以及阈值 $30$ 和 $70$，确定能使该公式对所有可行的 $x$ 和 $y$ 值都成立的最小有效常数 $M$。然后，分析其中 $y \\in [0,1]$ 的连续松弛，并证明使用这个最小的 $M$ 时，在扩展空间 $(x,y)$ 中的松弛可行域恰好是原始析取区域的凸包。请以 $M$ 的最小值作为您的最终答案。无需四舍五入。", "solution": "该问题要求使用大M法推导逻辑析取的混合整数线性规划 (MILP) 模型，确定最小的有效常数 $M$，并对连续松弛进行分析。\n\n### 步骤1：使用大M法对析取进行建模\n\n需要建模的逻辑析取是 $x \\leq 30$ 或 $x \\geq 70$。决策变量 $x$ 是一个实数，其界限为 $x \\in [0, 100]$。引入一个二元变量 $y \\in \\{0,1\\}$ 来控制该析取。\n\n让我们定义二元变量 $y$ 与两个条件之间的关系：\n- 如果 $y=1$，则约束 $x \\leq 30$ 必须激活。\n- 如果 $y=0$，则约束 $x \\geq 70$ 必须激活。\n\n为了使用大M法，我们首先将不等式重写为标准形式 $f(x) \\leq 0$：\n1. $x - 30 \\leq 0$\n2. $70 - x \\leq 0$\n\n对于两个不等式 $f_1(x) \\leq 0$ 或 $f_2(x) \\leq 0$ 的析取，使用二元变量 $y$ 的通用大M公式为：\n$$f_1(x) \\leq M(1-y)$$\n$$f_2(x) \\leq M y$$\n在这里，我们将 $y=1$ 与第一个不等式激活 ($f_1(x) \\leq 0$) 相关联，将 $y=0$ 与第二个不等式激活 ($f_2(x) \\leq 0$) 相关联。\n\n将此应用于我们的具体问题，我们有 $f_1(x) = x-30$ 和 $f_2(x) = 70-x$。不等式系统变为：\n$$x - 30 \\leq M(1-y) \\quad (1)$$\n$$70 - x \\leq M y \\quad (2)$$\n\n我们来验证这个公式：\n- 如果 $y=1$：不等式(1)变为 $x - 30 \\leq M(0) \\implies x \\leq 30$。不等式(2)变为 $70 - x \\leq M(1) \\implies 70 - x \\leq M$。对于 $x \\leq 30$ 条件下的任何可行 $x$，第二个不等式必须是冗余的。\n- 如果 $y=0$：不等式(1)变为 $x - 30 \\leq M(1) \\implies x-30 \\leq M$。对于 $x \\geq 70$ 条件下的任何可行 $x$，这个不等式必须是冗余的。不等式(2)变为 $70 - x \\leq M(0) \\implies 70 - x \\leq 0 \\implies x \\geq 70$。\n\n只要常数 $M$ 选择得足够大，该公式就能正确地对析取进行建模。\n\n### 步骤2：确定最小有效常数 $M$\n\n常数 $M$ 必须足够大，以使“非激活”的约束在 $x$ 的可行域上不具限制性。$x$ 的总域为 $[0, 100]$。\n\n1.  考虑 $y=0$ 的情况，此时强制 $x \\geq 70$。另一个约束是 $x - 30 \\leq M$。这必须对在这种情况下所有可能的 $x$ 值都成立。因此，$x$ 的可能范围是 $[70, 100]$。为确保 $x-30 \\leq M$ 始终满足，$M$ 必须大于或等于左侧表达式 $x-30$ 在此范围内的最大可能值。\n    $$M \\geq \\max_{x \\in [70, 100]} (x-30)$$\n    表达式 $x-30$ 在 $x$ 取最大值时（即 $x=100$）达到最大。\n    $$M \\geq 100 - 30 = 70$$\n\n2.  考虑 $y=1$ 的情况，此时强制 $x \\leq 30$。另一个约束是 $70 - x \\leq M$。这必须对在这种情况下所有可能的 $x$ 值都成立。因此，$x$ 的可能范围是 $[0, 30]$。为确保 $70-x \\leq M$ 始终满足，$M$ 必须大于或等于左侧表达式 $70-x$ 在此范围内的最大可能值。\n    $$M \\geq \\max_{x \\in [0, 30]} (70-x)$$\n    表达式 $70-x$ 在 $x$ 取最小值时（即 $x=0$）达到最大。\n    $$M \\geq 70 - 0 = 70$$\n\n两个条件都要求 $M \\geq 70$。因此，常数 $M$ 的最小有效值为 $70$。\n\n使用最小 $M$ 的最终不等式系统是：\n$$x - 30 \\leq 70(1-y)$$\n$$70 - x \\leq 70y$$\n$$x \\in [0, 100], \\quad y \\in \\{0, 1\\}$$\n\n### 步骤3：连续松弛分析\n\n问题要求证明，使用最小 $M=70$ 时，此公式的连续松弛得到的是析取可行域的凸包。\n\n$(x,y)$ 空间中 MILP 的可行集是两个不相交集合（线段）的并集：\n- 对于 $y=0$：$x \\in [70, 100]$。这给出了集合 $S_0 = \\{(x,0) \\mid x \\in [70, 100]\\}$。\n- 对于 $y=1$：$x \\in [0, 30]$。这给出了集合 $S_1 = \\{(x,1) \\mid x \\in [0, 30]\\}$。\n总可行集为 $S_{MILP} = S_0 \\cup S_1$。该集合由平面上的两条线段组成，其端点为 $(70,0)$、$(100,0)$、$(0,1)$ 和 $(30,1)$。\n\n$S_{MILP}$ 的凸包，记作 $\\text{conv}(S_{MILP})$，是包含 $S_{MILP}$ 的最小凸集。由于 $S_{MILP}$ 由两条线段组成，其凸包是由它们的四个端点 $(70,0)$、$(100,0)$、$(30,1)$ 和 $(0,1)$ 形成的多边形。\n\n通过允许 $y$ 在 $[0,1]$ 中取任何实数值，可以得到 MILP 公式化的连续松弛。连续松弛的区域（我们称之为 $P$）由以下不等式定义：\n1. $x \\in [0, 100]$\n2. $y \\in [0, 1]$\n3. $x - 30 \\leq 70(1-y) \\implies x + 70y \\leq 100$\n4. $70 - x \\leq 70y \\implies x + 70y \\geq 70$\n\n集合 $P$ 是一个多面体。为了证明 $P = \\text{conv}(S_{MILP})$，我们可以证明多面体 $P$ 的顶点恰好是 $S_{MILP}$ 中线段的端点。让我们通过求解其边界不等式的交点来找到 $P$ 的顶点。\n\n- $y=0$ 和 $x+70y=70$ 的交点：$x=70$。点：$(70,0)$。\n- $y=0$ 和 $x=100$ 的交点：点：$(100,0)$。（这也满足 $x+70y = 100 \\leq 100$ 和 $100 \\geq 70$）。\n- $y=1$ 和 $x+70y=100$ 的交点：$x+70=100 \\implies x=30$。点：$(30,1)$。\n- $y=1$ 和 $x=0$ 的交点：点：$(0,1)$。（这也满足 $x+70y = 70 \\geq 70$ 和 $70 \\leq 100$）。\n- $x=0$ 和 $x+70y=70$ 的交点：$70y=70 \\implies y=1$。点：$(0,1)$。\n\n连续松弛的可行域 $P$ 的顶点是 $(70,0)$、$(100,0)$、$(30,1)$ 和 $(0,1)$。这些恰好是定义 $\\text{conv}(S_{MILP})$ 的四个极点。由于 $P$ 是一个凸多边形，其顶点是 $\\text{conv}(S_{MILP})$ 的极点，因此这两个集合是相同的。因此，$P = \\text{conv}(S_{MILP})$。\n\n这证明了使用最小值 $M=70$ 会得到一个“紧”的公式，其中线性规划松弛定义了整数解的凸包。\n\n问题要求的是 $M$ 的最小值。根据推导，该值为 $70$。", "answer": "$$\n\\boxed{70}\n$$", "id": "3102348"}, {"introduction": "掌握了如何构建大M约束之后，下一步自然是将其应用于解决一个完整的问题。本练习将带你走过使用大M单纯形法求解一个线性规划问题的全过程，从构建初始单纯形表到通过迭代找到最优解。通过将大M法与两阶段法进行对比，你将更深刻地理解这两种处理人工变量的标准算法是如何运作的 ([@problem_id:3102417])。", "problem": "考虑以下线性规划（LP）问题，这是一个具有线性目标和线性约束的模型，其中决策变量必须满足非负性，并且所有线性等式和不等式都按常规方式解释：\n最大化\n$$z \\;=\\; 5 x_{1} \\;+\\; 3 x_{2}$$\n约束条件为\n$$2 x_{1} \\;+\\; x_{2} \\;=\\; 4,$$\n$$-\\,x_{1} \\;+\\; 2 x_{2} \\;\\ge\\; 3,$$\n$$x_{1} \\;+\\; x_{2} \\;\\le\\; 5,$$\n$$x_{1} \\;\\ge\\; 0,\\quad x_{2} \\;\\ge\\; 0.$$\n由于第一个约束是等式，第二个约束是大于等于约束，因此需要引入人工变量来获得单纯形法的初始基本可行解（BFS）。\n\n从基本可行解（BFS）、松弛变量、剩余变量和人工变量的基本定义出发，并使用标准单纯形旋转逻辑，完成以下任务：\n- 通过引入适当的松弛、剩余和人工变量，构建一个有效的初始单纯形表。\n- 使用大M法（BM）求解该线性规划问题，其中惩罚参数 $M$ 是一个被视为足够大的正数，目标函数通过减去 $M$ 乘以每个人工变量来进行惩罚。当需要时，使用 Dantzig 规则（对于最大化问题，选择最大的检验数）并按变量名的字典序进行决断。\n- 使用两阶段单纯形法（TPS）求解同一个线性规划问题：第一阶段最小化人工变量之和以找到原问题的基本可行解，第二阶段最大化原目标函数。在两个阶段都使用相同的旋转规则。\n- 比较大M法和两阶段法所用的总旋转迭代次数，并确定在任一方法中是否出现退化旋转（即由于离基变量的右端项为零，导致进基步骤没有增加目标函数值的旋转）。\n\n你最终报告的量必须是总旋转迭代次数的差值，计算公式为\n$$\\text{(大M法总旋转次数)} \\;-\\; \\text{(两阶段法总旋转次数)}.$$\n将最终答案表示为单个实数。无需四舍五入。在你的推导过程中，也请报告你所获得的最优目标值 $z$，但最终的数值答案只应给出旋转次数的差值。", "solution": "首先根据指定标准对问题进行验证。\n\n**步骤1：提取已知条件**\n- **目标函数：** 最大化 $z = 5 x_{1} + 3 x_{2}$。\n- **约束条件：**\n  1. $2 x_{1} + x_{2} = 4$。\n  2. $-\\,x_{1} + 2 x_{2} \\ge 3$。\n  3. $x_{1} + x_{2} \\le 5$。\n  4. $x_{1} \\ge 0, x_{2} \\ge 0$。\n- **方法：** 使用大M法（BM）和两阶段单纯形法（TPS）求解。\n- **旋转规则：** Dantzig 规则（最大检验数，对于使用 $z$ 行系数为 $c_j' = z_j - c_j$ 的单纯形表的最大化问题，对应于最负的系数）。按变量名的字典序进行决断。\n- **要求比较：** 比较大M法和两阶段法的总旋转迭代次数。识别任何退化旋转。\n- **最终答案：** $(\\text{大M法总旋转次数}) - (\\text{两阶段法总旋转次数})$ 的值。\n\n**步骤2：使用提取的已知条件进行验证**\n- **科学依据：** 该问题是一个标准的线性规划（LP）问题，是数学和运筹学中一个成熟的课题。所涉及的所有原则都是合理的。\n- **适定性：** 问题给出了明确的目标和一组线性约束。其结构确保了有唯一且有意义的解。\n- **客观性：** 问题使用精确的数学语言陈述，没有歧义或主观论断。\n\n**步骤3：结论与行动**\n问题有效。将提供完整解答。\n\n首先，我们通过引入一个剩余变量 $s_2$、一个松弛变量 $s_3$ 和两个人工变量 $a_1$ 和 $a_2$，将线性规划问题转换为标准形式。\n最大化 $z = 5x_1 + 3x_2$\n约束条件为：\n$2x_1 + x_2 + a_1 = 4$\n$-x_1 + 2x_2 - s_2 + a_2 = 3$\n$x_1 + x_2 + s_3 = 5$\n$x_1, x_2, s_2, s_3, a_1, a_2 \\ge 0$\n\n初始基变量是 $a_1, a_2, s_3$。初始基本可行解（对于辅助问题）是 $(x_1, x_2, s_2, s_3, a_1, a_2) = (0, 0, 0, 5, 4, 3)$。\n\n**大M法（BM）**\n修改目标函数以惩罚人工变量：最大化 $Z = 5x_1 + 3x_2 - M a_1 - M a_2$。单纯形表的初始 $z$ 行为 $Z - 5x_1 - 3x_2 + M a_1 + M a_2 = 0$。为了使单纯形表规范化，我们使用约束条件将 $a_1$ 和 $a_2$ 从 $z$ 行中替换出去：\n$a_1 = 4 - 2x_1 - x_2$\n$a_2 = 3 + x_1 - 2x_2 + s_2$\n这得到初始 $z$ 行：$Z - (5+M)x_1 - (3+3M)x_2 + Ms_2 = -7M$。\n初始单纯形表的基变量为 $\\{a_1, a_2, s_3\\}$，右端项（RHS）值为 $\\{4, 3, 5\\}$。$z$ 行中非基变量的系数对于 $x_1$ 是 $-(5+M)$，对于 $x_2$ 是 $-(3+3M)$，对于 $s_2$ 是 $-M$。\n\n**大M法旋转 1：**\n- $z$ 行中最负的系数是 $-(3M+3)$（因为 $M$ 是大的正数）。因此，$x_2$ 是进基变量。\n- 执行最小比率测试：$\\min\\{4/1, 3/2, 5/1\\} = 1.5$。最小比率对应于基变量为 $a_2$ 的行。\n- $x_2$ 进基，$a_2$ 离基。这是第一次旋转。目标函数值从 $Z=-7M$ 变为 $Z = -5M/2 + 9/2$。由于最小比率为正，没有发生退化。\n\n**大M法旋转 2：**\n- 第一次旋转后，新的基为 $\\{a_1, x_2, s_3\\}$。基本可行解为 $(x_1, x_2) = (0, 1.5)$，由于 $a_1=2.5 \\neq 0$，这对原问题不是可行解。\n- 非基变量 $x_1$ 和 $s_2$ 的新 $z$ 行系数分别为 $-(5M/2 + 13/2)$ 和 $-(M/2 + 3/2)$。最负的是 $x_1$ 的系数。\n- $x_1$ 是进基变量。\n- 执行最小比率测试：$\\min\\{(5/2)/(5/2), (7/2)/(3/2)\\} = \\min\\{1, 7/3\\} = 1$。最小比率对应于基变量为 $a_1$ 的行。\n- $x_1$ 进基，$a_1$ 离基。这是第二次旋转。目标函数值变为 $Z = 11$。没有发生退化。\n\n**大M法旋转 3：**\n- 第二次旋转后，基为 $\\{x_1, x_2, s_3\\}$。基本可行解为 $(x_1, x_2) = (1, 2)$。所有人工变量都是非基变量，因此该解对于原问题是可行的，目标函数值为 $z = 5(1)+3(2) = 11$。\n- 非基变量 $s_2$ 的新 $z$ 行系数为 $-1/5$。由于它是负数，当前解不是最优解。\n- $s_2$ 是进基变量。\n- 执行最小比率测试：$x_1$ 所在行的比率为 $1/(1/5) = 5$，$s_3$ 所在行的比率为 $2/(1/5) = 10$。$x_2$ 所在行的 $s_2$ 系数为负，不参与比率测试。最小比率为 $5$，对应于基变量为 $x_1$ 的行。\n- $s_2$ 进基，$x_1$ 离基。这是第三次旋转。目标函数值变为 $Z=12$。没有发生退化。\n\n第三次旋转后，基为 $\\{s_2, x_2, s_3\\}$。所有非基变量（$x_1$ 和人工变量 $a_1, a_2$）的 $z$ 行系数均为非负。算法终止。\n最优解为 $x_1=0, x_2=4$，最优目标函数值为 $z=12$。\n大M法总旋转次数为 $3$ 次。没有发生退化旋转。\n\n**两阶段单纯形法（TPS）**\n\n**第一阶段：**\n目标是最小化 $w = a_1 + a_2$，这等同于最大化 $-w = -a_1 - a_2$。\n第一阶段的初始 $z$ 行为 $-w + a_1 + a_2 = 0$。规范化后，$z$ 行为 $-w - x_1 - 3x_2 + s_2 = -7$。\n这与大M法的初始 $z$ 行（检验数部分）形式相同，如果将 $M$ 设为1，常数项设为0。\n\n**两阶段法第一阶段，旋转 1：**\n- $-w$ 行中最负的系数是 $x_2$ 对应的 $-3$。$x_2$ 进基。\n- 最小比率测试为 $\\min\\{4/1, 3/2, 5/1\\} = 1.5$。$a_2$ 离基。\n- 这次旋转与大M法的第一次旋转相同。目标 $-w$ 从 $-7$ 变为 $-5/2$。没有发生退化。\n\n**两阶段法第一阶段，旋转 2：**\n- 新的基为 $\\{a_1, x_2, s_3\\}$。$x_1$ 的 $-w$ 行系数为 $-5/2$，$s_2$ 的为 $-1/2$。最负的是 $x_1$ 的系数。\n- $x_1$ 进基。最小比率测试为 $\\min\\{(5/2)/(5/2), (7/2)/(3/2)\\} = 1$。$a_1$ 离基。\n- 这次旋转与大M法的第二次旋转相同。目标 $-w$ 变为 $0$。\n\n第一阶段在 $2$ 次旋转后终止。最优值为 $w=0$，表明已找到原问题的可行解。基为 $\\{x_1, x_2, s_3\\}$。第一阶段没有发生退化旋转。\n\n**第二阶段：**\n我们移除人工变量列和第一阶段的目标行。第二阶段的初始单纯形表是第一阶段的最终单纯形表。目标函数是原目标函数：$z = 5x_1 + 3x_2$。$z$ 行为 $z - 5x_1 - 3x_2 = 0$。\n基为 $\\{x_1, x_2, s_3\\}$。我们通过替换掉 $x_1$ 和 $x_2$ 来使 $z$ 行规范化。这得到 $z$ 行 $z - (1/5)s_2 = 11$。这与大M法第二次旋转后的状态相同（忽略大的 $M$ 项）。\n\n**两阶段法第二阶段，旋转 1：**\n- $z$ 行中 $s_2$ 的系数为负数 $-1/5$。该解不是最优解。\n- $s_2$ 进基。最小比率测试为 $1/(1/5) = 5$（$x_1$ 离基）和 $2/(1/5) = 10$（$s_3$ 离基）。最小比率为 $5$。$x_1$ 离基。\n- 这次旋转与大M法的第三次旋转相同。目标函数值变为 $z=12$。没有发生退化。\n\n这次旋转后，$z$ 行中的所有系数都为非负。算法终止。\n两阶段法的总旋转次数为 $2$（第一阶段） + $1$（第二阶段） = $3$ 次。没有发生退化旋转。\n\n**比较与最终答案**\n- 大M法总旋转次数：$3$ 次。\n- 两阶段单纯形法总旋转次数：$3$ 次。\n- 两种方法均未观察到退化旋转。\n- 获得的最优目标值为 $z=12$。\n\n总旋转迭代次数的差值为：\n$(\\text{大M法总旋转次数}) - (\\text{两阶段法总旋转次数}) = 3 - 3 = 0$。", "answer": "$$\n\\boxed{0}\n$$", "id": "3102417"}, {"introduction": "对于简单的教学案例，手动计算$M$值是可行的，但在现实世界的大规模复杂模型中，这种方法既耗时又容易出错。因此，我们需要更通用、更强大的方法。本练习将理论与实践相结合，介绍了一种现代优化求解器中常用的高级预处理技术：通过求解一系列辅助线性规划问题来自动收紧每个约束的$M$值 ([@problem_id:3102341])。", "problem": "考虑一个混合整数线性规划 (MILP) 模型族，其中包含二元决策变量和连续决策变量。一种常见的建模技巧是“大M”方法，其中一个线性不等式约束由一个二元变量条件性地强制执行。使用以下数学设定。设连续变量集合于一个向量 $x \\in \\mathbb{R}^n$ 中，并假设 $x$ 有简单边界约束 $l \\le x \\le u$，其中 $l \\in \\mathbb{R}^n$ 和 $u \\in \\mathbb{R}^n$ 是给定的下界和上界。此外，可能存在独立于二元变量的共享线性约束，集合为 $A_{\\text{shared}} x \\le d$，其中 $A_{\\text{shared}} \\in \\mathbb{R}^{m \\times n}$ 且 $d \\in \\mathbb{R}^m$。每个大M约束由一个行向量 $a_i \\in \\mathbb{R}^n$ 和一个标量 $b_i \\in \\mathbb{R}$ 指定，并写为 $a_i^\\top x \\le b_i + M_i (1 - y_i)$，其中 $y_i \\in \\{0,1\\}$ 是一个二元变量。当 $y_i=1$ 时，必须满足原始线性不等式 $a_i^\\top x \\le b_i$；当 $y_i=0$ 时，通过加上一个足够大的常数 $M_i$ 来松弛该不等式。\n\n您的任务是设计并实现一个预处理流程，通过为每个大M约束求解一个线性规划 (LP) 问题来收紧常数 $M_i$。线性规划 (LP) 是在线性等式和不等式约束定义的可行域上优化一个线性目标函数。此推导的基本依据是线性系统的可行性定义、箱式约束下多面体的有界性，以及线性函数在非空紧多面体上必能达到其最大值这一事实。对于每个索引为 $i$ 的大M约束，考虑这样一个 LP 问题：在由共享约束和边界指定的可行域上，寻求对原始不等式的最大可能违背量。该 LP 使用等于约束的左侧减去右侧常数的目标函数，并受限于 $A_{\\text{shared}} x \\le d$ 和 $l \\le x \\le u$。然后，收紧后的 $M_i$ 被选为非负的最大违背量，以确保当相应的二元变量为0时，松弛不会无意中收紧约束。\n\n请实现该流程，并将其应用于以下玩具模型的测试集。所有常数都是无量纲的；不涉及物理单位。对于每个测试用例，计算一个列表，其条目是该用例中每个大M约束的收紧后的 $M_i$ 值，按给定顺序排列。\n\n测试用例 1：\n- 连续变量：$x_1, x_2$。\n- 边界：$0 \\le x_1 \\le 5$, $0 \\le x_2 \\le 3$。\n- 共享约束：$x_1 + x_2 \\le 5$。\n- 大M约束：\n  - 约束 1：$2 x_1 + 1 x_2 \\le 4 + M_1 (1 - y_1)$。\n  - 约束 2：$-1 x_1 + 3 x_2 \\le 7 + M_2 (1 - y_2)$。\n\n测试用例 2：\n- 连续变量：$x_1, x_2$。\n- 边界：$0 \\le x_1 \\le 5$, $0 \\le x_2 \\le 5$。\n- 共享约束：$x_1 + x_2 \\le 10$。\n- 大M约束：\n  - 约束 1：$0.5 x_1 + 0.5 x_2 \\le 10 + M_1 (1 - y_1)$。\n\n测试用例 3：\n- 连续变量：$x_1, x_2, x_3$。\n- 边界：$0 \\le x_1 \\le 4$, $0 \\le x_2 \\le 4$, $0 \\le x_3 \\le 4$。\n- 共享约束：无。\n- 大M约束：\n  - 约束 1：$0 x_1 + 0 x_2 + 0 x_3 \\le 1 + M_1 (1 - y_1)$。\n\n测试用例 4：\n- 连续变量：$x_1, x_2, x_3$。\n- 边界：$0 \\le x_1 \\le 10$, $0 \\le x_2 \\le 10$, $0 \\le x_3 \\le 10$。\n- 共享约束：$2 x_1 + x_2 \\le 12$, $x_2 + x_3 \\le 9$。\n- 大M约束：\n  - 约束 1：$3 x_1 - 1 x_2 + 0.5 x_3 \\le 8 + M_1 (1 - y_1)$。\n  - 约束 2：$1 x_1 + 2 x_2 + 3 x_3 \\le 7 + M_2 (1 - y_2)$。\n\n您的程序必须为每个测试用例中的每个大M约束求解该 LP 问题以最大化违背表达式，然后将 $M_i$ 设置为非负的最大化值。最终输出格式必须是单行文本，包含一个逗号分隔的列表的列表，每个内部列表对应一个测试用例，其中包含按顺序排列的收紧后的 $M_i$ 值。例如，输出应类似于 $[[m_{1,1}, m_{1,2}], [m_{2,1}], [m_{3,1}], [m_{4,1}, m_{4,2}]]$, 其中 $m_{t,i}$ 是测试用例 $t$ 中约束 $i$ 的收紧值。", "solution": "所述问题是有效的。它在科学上基于线性和混合整数规划理论，问题陈述清晰、客观，并为每个测试用例提供了完整且一致的设定。因此，我们可以着手求解。\n\n核心任务是收紧一系列混合整数线性規劃 (MILP) 公式中的“大M”常数。一个通用的大M约束形式为 $a_i^\\top x \\le b_i + M_i (1 - y_i)$，其中 $y_i \\in \\{0,1\\}$ 是一个二元决策变量，而 $x \\in \\mathbb{R}^n$ 是一个连续决策变量向量。\n\n此公式的目的是使用二元变量 $y_i$ 来“开启”或“关闭”约束 $a_i^\\top x \\le b_i$。\n- 如果 $y_i = 1$，则 $M_i (1 - y_i)$ 项变为 $0$，约束强制执行 $a_i^\\top x \\le b_i$。\n- 如果 $y_i = 0$，则 $M_i (1 - y_i)$ 项变为 $M_i$，约束变为 $a_i^\\top x \\le b_i + M_i$。\n\n为使公式正确，$M_i$ 的值必须选择得足够大，以使松弛后的约束 $a_i^\\top x \\le b_i + M_i$ 不会排除任何在 $y_i=0$ 时本应允许的 $x$ 的可行解。也就是说，对于任何满足其他问题约束的 $x$，该不等式必须是冗余的。在优化中，不必要地过大的 $M_i$ 值可能导致数值性能不佳和弱的线性规划松弛，从而显著减慢求解过程。因此，选择尽可能小的有效 $M_i$ 值是有利的。\n\n$M_i$ 的最紧（最小）有效值，是恰好足以容纳表达式 $a_i^\\top x - b_i$ 在 $x$ 的可行域上的最大可能值。这个我们表示为 $\\mathcal{F}$ 的可行域，是由独立于二元变量的共享约束和变量边界定义的：\n$$\n\\mathcal{F} = \\{ x \\in \\mathbb{R}^n \\mid A_{\\text{shared}} x \\le d, \\text{ and } l \\le x \\le u \\}\n$$\n松弛项 $M_i$ 的最紧可能值是违背量 $a_i^\\top x - b_i$ 在该区域上的上确界：\n$$\nM_i^{\\text{ideal}} = \\sup_{x \\in \\mathcal{F}} \\{ a_i^\\top x - b_i \\}\n$$\n问题指明 $x$ 的可行域由线性不等式 $A_{\\text{shared}} x \\le d$ 和简单边界 $l \\le x \\le u$ 定义。这个区域 $\\mathcal{F}$ 是一个多面体。因为它受到有限的上下界约束，只要非空，这个多面体就是紧的（闭合且有界）。根据线性规划基本定理（魏尔斯特拉斯极值定理的一个应用），线性函数在一个非空紧集上必能达到其最大值和最小值。因此，这个上确界是一个最大值，可以通过求解一个线性规划 (LP) 问题找到。\n\n对于每个大M约束 $i$，我们构建以下 LP：\n$$\n\\begin{align*}\nz_i^* = \\max_{x} \\quad  a_i^\\top x - b_i \\\\\n\\text{s.t.} \\quad  A_{\\text{shared}} x \\le d \\\\\n l \\le x \\le u\n\\end{align*}\n$$\n由于目标函数中的常数项 $-b_i$ 不影响最优解 $x^*$，我们可以等价地求解 $\\max_{x} (a_i^\\top x)$ 然后再减去 $b_i$。标准的 LP 求解器通常设计用于最小化。为了最大化 $a_i^\\top x$，我们可以最小化 $-a_i^\\top x$。设 $v_i^* = \\min_{x \\in \\mathcal{F}} (-a_i^\\top x)$。那么 $\\max_{x \\in \\mathcal{F}} (a_i^\\top x) = -v_i^*$，最大违背量为 $z_i^* = -v_i^* - b_i$。\n\n问题规定，收紧后的 $M_i$ 必须是非负的。因此，$M_i$ 的最终值由下式给出：\n$$\nM_i^{\\text{tight}} = \\max \\{ 0, z_i^* \\} = \\max \\{ 0, -v_i^* - b_i \\}\n$$\n我们将此程序应用于每个测试用例中的每个约束。\n\n**计算示例：测试用例 1**\n- 变量：$x = [x_1, x_2]^\\top$。\n- 可行域 $\\mathcal{F}$：\n  - $0 \\le x_1 \\le 5$\n  - $0 \\le x_2 \\le 3$\n  - $x_1 + x_2 \\le 5$\n该区域是一个凸多边形，其顶点为 $(0,0)$, $(5,0)$, $(2,3)$, 和 $(0,3)$。任何线性函数在该区域上的最大值将出现在这些顶点之一。\n\n**约束 1:** $2 x_1 + 1 x_2 \\le 4 + M_1 (1 - y_1)$。\n此处，$a_1 = [2, 1]^\\top$ 且 $b_1 = 4$。我们需要找到 $\\max_{x \\in \\mathcal{F}} (2x_1 + x_2)$。我们在每个顶点处评估目标函数：\n- 于 $(0,0)$: $2(0) + 1(0) = 0$。\n- 于 $(5,0)$: $2(5) + 1(0) = 10$。\n- 于 $(2,3)$: $2(2) + 1(3) = 7$。\n- 于 $(0,3)$: $2(0) + 1(3) = 3$。\n$a_1^\\top x$ 的最大值为 $10$。\n最大违背量为 $z_1^* = 10 - b_1 = 10 - 4 = 6$。\n收紧后的值为 $M_1 = \\max\\{0, 6\\} = 6$。\n\n**约束 2:** $-1 x_1 + 3 x_2 \\le 7 + M_2 (1 - y_2)$。\n此处，$a_2 = [-1, 3]^\\top$ 且 $b_2 = 7$。我们需要找到 $\\max_{x \\in \\mathcal{F}} (-x_1 + 3x_2)$。我们在各顶点处评估此目标：\n- 于 $(0,0)$: $-1(0) + 3(0) = 0$。\n- 于 $(5,0)$: $-1(5) + 3(0) = -5$。\n- 于 $(2,3)$: $-1(2) + 3(3) = 7$。\n- 于 $(0,3)$: $-1(0) + 3(3) = 9$。\n$a_2^\\top x$ 的最大值为 $9$。\n最大违背量为 $z_2^* = 9 - b_2 = 9 - 7 = 2$。\n收紧后的值为 $M_2 = \\max\\{0, 2\\} = 2$。\n\n测试用例 1 的结果是 $[6, 2]$。使用数值 LP 求解器，对剩余的测试用例应用相同的方法，正如所提供代码中实现的那样。", "answer": "```python\nimport numpy as np\nfrom scipy.optimize import linprog\n\ndef solve():\n    \"\"\"\n    Solves for tightened big-M values for a suite of MILP test cases.\n    \"\"\"\n    \n    test_cases = [\n        # Test Case 1\n        {\n            \"l\": np.array([0, 0]),\n            \"u\": np.array([5, 3]),\n            \"A_shared\": np.array([[1, 1]]),\n            \"d_shared\": np.array([5]),\n            \"big_M_constraints\": [\n                {\"a\": np.array([2, 1]), \"b\": 4},\n                {\"a\": np.array([-1, 3]), \"b\": 7},\n            ]\n        },\n        # Test Case 2\n        {\n            \"l\": np.array([0, 0]),\n            \"u\": np.array([5, 5]),\n            \"A_shared\": np.array([[1, 1]]),\n            \"d_shared\": np.array([10]),\n            \"big_M_constraints\": [\n                {\"a\": np.array([0.5, 0.5]), \"b\": 10},\n            ]\n        },\n        # Test Case 3\n        {\n            \"l\": np.array([0, 0, 0]),\n            \"u\": np.array([4, 4, 4]),\n            \"A_shared\": None,\n            \"d_shared\": None,\n            \"big_M_constraints\": [\n                {\"a\": np.array([0, 0, 0]), \"b\": 1},\n            ]\n        },\n        # Test Case 4\n        {\n            \"l\": np.array([0, 0, 0]),\n            \"u\": np.array([10, 10, 10]),\n            \"A_shared\": np.array([[2, 1, 0], [0, 1, 1]]),\n            \"d_shared\": np.array([12, 9]),\n            \"big_M_constraints\": [\n                {\"a\": np.array([3, -1, 0.5]), \"b\": 8},\n                {\"a\": np.array([1, 2, 3]), \"b\": 7},\n            ]\n        }\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        case_results = []\n        bounds = list(zip(case[\"l\"], case[\"u\"]))\n        A_ub = case[\"A_shared\"]\n        b_ub = case[\"d_shared\"]\n\n        for constr in case[\"big_M_constraints\"]:\n            a = constr[\"a\"]\n            b = constr[\"b\"]\n            \n            c = -a\n            \n            res = linprog(c, A_ub=A_ub, b_ub=b_ub, bounds=bounds, method='highs')\n\n            if not res.success:\n                raise RuntimeError(f\"LP solver failed for case with objective a={a}, b={b}.\")\n\n            max_ax = -res.fun\n            \n            max_violation = max_ax - b\n            \n            tightened_M = max(0, max_violation)\n            case_results.append(tightened_M)\n            \n        all_results.append(case_results)\n\n    def format_list(lst):\n        # Format numbers to be clean, e.g., 6.0 instead of 6.000...\n        # Use a general approach that handles integers and floats cleanly.\n        formatted_nums = []\n        for num in lst:\n            if num == int(num):\n                formatted_nums.append(f\"{int(num)}.0\")\n            else:\n                formatted_nums.append(str(num))\n        return f\"[{','.join(formatted_nums)}]\"\n    \n    final_output_str = f\"[{','.join(map(format_list, all_results))}]\"\n\n    print(final_output_str)\n\nsolve()\n```", "id": "3102341"}]}