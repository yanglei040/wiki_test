{"hands_on_practices": [{"introduction": "在分子模拟中，最基本的操作之一是从给定的势能函数推导出作用在粒子上的力。这个过程不仅是理论理解的基础，也是编写或修改模拟代码的核心技能。这个练习 [@problem_id:2404403] 提供了一个基于非标准“类 Lennard-Jones”势的推导任务，旨在确保您能从第一性原理出发，熟练掌握势能、力和维里之间的关系。", "problem": "考虑一个单原子体系，其对心、两两相互作用由以下类 Lennard-Jones 势描述：\n$$\nU(r) = 4\\,\\varepsilon\\left[\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right],\n$$\n其中 $r = |\\mathbf{r}_{ij}|$ 是两个粒子间的标量距离，$\\mathbf{r}_{ij}$ 是粒子间分离矢量，$\\sigma$ 是一个特征长度标度，$\\varepsilon$ 是一个能量标度。假设该相互作用是球对称且两两可加的。仅使用以下基本定义：(i) 力是势的负梯度，以及 (ii) 标量对维里贡献定义为 $w(r) = \\mathbf{r}_{ij} \\cdot \\mathbf{F}_{ij}(r)$，推导出力矢量 $\\mathbf{F}_{ij}(r)$ 和标量对维里 $w(r)$ 作为 $r$、$\\sigma$ 和 $\\varepsilon$ 的函数的解析表达式。将力沿径向单位矢量 $\\hat{\\mathbf{r}}_{ij} = \\mathbf{r}_{ij}/r$ 表示。\n\n仅用 $r$、$\\sigma$ 和 $\\varepsilon$ 表示您的最终结果，形式为闭式表达式。将力表示为矢量，维里表示为标量。不要代入数值。在最终的方框答案中不要包含单位。将两个结果一起以单行矩阵 $\\begin{pmatrix}\\mathbf{F}_{ij}(r)  w(r)\\end{pmatrix}$ 的形式报告。", "solution": "该问题要求从给定的对心势 $U(r)$ 推导粒子间力矢量 $\\mathbf{F}_{ij}(r)$ 和标量对维里 $w(r)$。这是一个适定且科学上合理的问题，是经典力学和统计物理学中的一个标准练习。我们将根据所提供的基本定义进行推导。\n\n原子间势由下式给出：\n$$\nU(r) = 4\\,\\varepsilon\\left[\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right]\n$$\n其中 $r = |\\mathbf{r}_{ij}|$ 是粒子 $i$ 和 $j$ 之间的标量距离。\n\n首先，我们推导力矢量 $\\mathbf{F}_{ij}$。力定义为势能关于粒子间分离矢量 $\\mathbf{r}_{ij}$ 的负梯度：\n$$\n\\mathbf{F}_{ij} = -\\nabla_{\\mathbf{r}_{ij}} U(r)\n$$\n由于势 $U$ 仅是标量距离 $r$ 的函数，我们可以对梯度应用链式法则：\n$$\n\\nabla_{\\mathbf{r}_{ij}} U(r) = \\frac{dU}{dr} \\nabla_{\\mathbf{r}_{ij}} r\n$$\n标量距离 $r = |\\mathbf{r}_{ij}| = \\sqrt{x_{ij}^2 + y_{ij}^2 + z_{ij}^2}$ 的梯度是径向单位矢量 $\\hat{\\mathbf{r}}_{ij}$：\n$$\n\\nabla_{\\mathbf{r}_{ij}} r = \\frac{\\mathbf{r}_{ij}}{r} = \\hat{\\mathbf{r}}_{ij}\n$$\n因此，力矢量可以表示为：\n$$\n\\mathbf{F}_{ij}(r) = -\\frac{dU}{dr} \\hat{\\mathbf{r}}_{ij}\n$$\n现在我们计算势 $U(r)$ 关于 $r$ 的导数。为清晰起见，我们将 $U(r)$ 重写为：\n$$\nU(r) = 4\\,\\varepsilon\\left(\\sigma^{10}r^{-10} - \\sigma^{5}r^{-5}\\right)\n$$\n导数是：\n$$\n\\frac{dU}{dr} = 4\\,\\varepsilon \\frac{d}{dr}\\left(\\sigma^{10}r^{-10} - \\sigma^{5}r^{-5}\\right) = 4\\,\\varepsilon\\left(\\sigma^{10}(-10)r^{-11} - \\sigma^{5}(-5)r^{-6}\\right)\n$$\n$$\n\\frac{dU}{dr} = 4\\,\\varepsilon\\left(-10 \\frac{\\sigma^{10}}{r^{11}} + 5 \\frac{\\sigma^{5}}{r^{6}}\\right)\n$$\n提出公因式，我们可以写成：\n$$\n\\frac{dU}{dr} = \\frac{20\\,\\varepsilon}{r} \\left(-2 \\frac{\\sigma^{10}}{r^{10}} + \\frac{\\sigma^{5}}{r^{5}}\\right) = -\\frac{20\\,\\varepsilon}{r} \\left[2\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right]\n$$\n将此导数代回力的表达式中，我们得到：\n$$\n\\mathbf{F}_{ij}(r) = - \\left(-\\frac{20\\,\\varepsilon}{r} \\left[2\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right]\\right) \\hat{\\mathbf{r}}_{ij}\n$$\n$$\n\\mathbf{F}_{ij}(r) = \\frac{20\\,\\varepsilon}{r} \\left[2\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right] \\hat{\\mathbf{r}}_{ij}\n$$\n这就是力矢量的解析表达式。\n\n接下来，我们推导标量对维里 $w(r)$。其定义如下：\n$$\nw(r) = \\mathbf{r}_{ij} \\cdot \\mathbf{F}_{ij}(r)\n$$\n我们代入推导出的 $\\mathbf{F}_{ij}(r)$ 表达式：\n$$\nw(r) = \\mathbf{r}_{ij} \\cdot \\left(\\frac{20\\,\\varepsilon}{r} \\left[2\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right] \\hat{\\mathbf{r}}_{ij}\\right)\n$$\n使用关系式 $\\mathbf{r}_{ij} = r \\hat{\\mathbf{r}}_{ij}$ 并注意到单位矢量与自身的点积为 1，即 $\\hat{\\mathbf{r}}_{ij} \\cdot \\hat{\\mathbf{r}}_{ij} = 1$，我们得到：\n$$\nw(r) = (r \\hat{\\mathbf{r}}_{ij}) \\cdot \\left(\\frac{20\\,\\varepsilon}{r} \\left[2\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right] \\hat{\\mathbf{r}}_{ij}\\right)\n$$\n$$\nw(r) = r \\left(\\frac{20\\,\\varepsilon}{r} \\left[2\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right]\\right) (\\hat{\\mathbf{r}}_{ij} \\cdot \\hat{\\mathbf{r}}_{ij})\n$$\n$r$ 的因子相互消去，剩下：\n$$\nw(r) = 20\\,\\varepsilon \\left[2\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right]\n$$\n这就是标量对维里的解析表达式。另一种求维里的等价方法是使用表达式 $w(r) = -r \\frac{dU}{dr}$，这会得到相同的结果：\n$$\nw(r) = -r \\left(-\\frac{20\\,\\varepsilon}{r} \\left[2\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right]\\right) = 20\\,\\varepsilon \\left[2\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right]\n$$\n推导完成。我们已经得到了力矢量和标量对维里的闭式表达式。", "answer": "$$\n\\boxed{\\begin{pmatrix} \\frac{20\\,\\varepsilon}{r}\\left[2\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right]\\hat{\\mathbf{r}}_{ij}  & 20\\,\\varepsilon\\left[2\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right] \\end{pmatrix}}\n$$", "id": "2404403"}, {"introduction": "选择一个合适的势能函数形式，对于确保模拟的物理真实性和数值稳定性至关重要。一个过于简化的模型可能会在特定条件下导致非物理行为甚至模拟崩溃。本练习 [@problem_id:2407785] 深入探讨了两种常见的键合势——简谐势和莫尔斯势——之间的差异，突出了键解离这一关键物理现象及其对分子动力学模拟的重要影响。", "problem": "在计算生物学和生物信息学中使用的分子力学力场中，共价键有时用谐振子势 $U_h(r) = \\tfrac{1}{2} k (r - r_0)^2$ 来建模，其中 $k$ 是键力常数，$r_0$ 是平衡键长。另一种选择是莫尔斯势 $U_M(r) = D_e \\left(1 - e^{-a (r - r_0)}\\right)^2$，其中 $D_e$ 是解离能，$a$ 控制势的范围。考虑一个代表单个共价键的孤立双原子片段。在时间 $t = 0$ 时，原子间距离为 $r = r_0$，一个冲量沿键伸缩方向赋予了相对动能 $E_0$。忽略所有其他自由度、环境耦合和非键相互作用。在一个时间步长为 $\\Delta t$ 的典型显式分子动力学 (MD) 积分器中，非常大的瞬时力可能导致数值不稳定性。\n\n下列哪个陈述正确描述了此设置的物理和数值后果，并证明了在分子力学力场中用莫尔斯势替代谐振子键是合理的？\n\nA. 在 $U_h(r)$ 下，对于任何有限的 $E_0$，原子都保持键合状态。外转折点满足 $U_h(r_{\\max}) = E_0$，给出 $r_{\\max} = r_0 + \\sqrt{2 E_0 / k}$，在转折点处的最大恢复力大小为 $\\sqrt{2 k E_0}$，随着 $E_0$ 的增加，这个力可以变得任意大，对于固定的 $\\Delta t$ 存在积分器灾难性失效的风险。在 $U_M(r)$ 下，如果 $E_0 > D_e$，键会解离，并且当 $r \\to \\infty$ 时，力的大小衰减到 $0$，因此能量和力保持在具有物理意义的值的界限内，避免了力的失控。\n\nB. 在 $U_h(r)$ 下，当 $r \\to \\infty$ 时，势能的上限是 $D_e$，因此没有无界力或数值不稳定性的风险；所以用 $U_M(r)$ 替换 $U_h(r)$ 是不必要的。\n\nC. 对于小位移 $|r - r_0| \\ll a^{-1}$，$U_M(r)$ 近似为谐振子势，其曲率 $k_{\\mathrm{eff}} = 2 D_e a^2$，因此，可以将 $k_{\\mathrm{eff}}$ 与选定的 $k$ 相匹配，以再现近平衡振动，同时在大 $r$ 处增加真实的键解离行为。\n\nD. 用 $U_M(r)$ 替换 $U_h(r)$ 必然会增加 $r_0$ 附近的最高振动频率，这迫使在显式MD中需要更小的稳定时间步长 $\\Delta t$，使得莫尔斯势在平衡点附近的数值表现更差。\n\nE. 在 $U_h(r)$ 下出现灾难性失效是因为其恢复力随着 $r$ 的增加而衰减到 $0$，导致失控的分离；$U_M(r)$ 通过在大的 $r$ 处提供一个线性增加的力来解决这个问题。", "solution": "该问题要求对用于在分子力学中模拟共价键的两种势能函数进行批判性比较：谐振子势 $U_h(r)$ 和莫尔斯势 $U_M(r)$。我们必须分析它们的物理真实性以及它们对分子动力学 (MD) 模拟数值稳定性的影响。\n\n谐振子势由以下公式给出：\n$$ U_h(r) = \\frac{1}{2} k (r - r_0)^2 $$\n其中 $k$ 是力常数，$r_0$ 是平衡键长。与此势相关的力由其负梯度导出：\n$$ F_h(r) = -\\frac{dU_h(r)}{dr} = -k (r - r_0) $$\n这是一个简单的胡克定律恢复力。谐振子势的一个关键特征是，当原子间距离 $r$ 偏离 $r_0$ 时，$U_h(r) \\to \\infty$。因此，恢复力的大小 $|F_h(r)| = k|r-r_0|$ 线性地无界增加。这在物理上是不真实的，因为一个真正的共价键如果被充分拉伸就会断裂（解离），此时势能应趋于一个恒定值（解离能），原子间的力应趋于零。\n\n在所描述的情景中，系统以动能 $E_0$ 从 $r=r_0$ 开始。根据能量守恒，总能量为 $E_{total} = E_0$。原子将会振荡。当所有动能都转换成势能时，达到外转折点 $r_{max}$，即 $U_h(r_{max}) = E_0$。\n$$ \\frac{1}{2} k (r_{max} - r_0)^2 = E_0 \\implies r_{max} = r_0 + \\sqrt{\\frac{2 E_0}{k}} $$\n对于任何有限的正能量 $E_0$，都存在一个有限的转折点，意味着键永远不会断裂。在此转折点处，会感受到最大的力：\n$$ |F_{h, max}| = |F_h(r_{max})| = k(r_{max} - r_0) = k \\sqrt{\\frac{2 E_0}{k}} = \\sqrt{2 k E_0} $$\n这个最大力随 $\\sqrt{E_0}$ 增长，如果 $E_0$ 很大，它可以变得任意大。在一个固定时间步长为 $\\Delta t$ 的显式MD积分器中，非常大的力可能导致粒子在单个步骤中发生不符合物理规律的大位移，从而导致数值不稳定和模拟的灾难性失败。\n\n莫尔斯势是一个更真实的替代方案：\n$$ U_M(r) = D_e \\left(1 - e^{-a (r - r_0)}\\right)^2 $$\n在这里，$D_e$ 是键解离能，$a$ 是一个控制势阱“宽度”的参数。\n莫尔斯势的关键特性是：\n1.  当 $r \\to \\infty$ 时，$e^{-a(r-r_0)} \\to 0$，所以 $U_M(r) \\to D_e$。这正确地模拟了键解离。\n2.  该势在 $r = r_0$ 处有最小值 $0$。\n\n从莫尔斯势导出的力是：\n$$ F_M(r) = -\\frac{dU_M(r)}{dr} = -2 a D_e \\left(1 - e^{-a (r - r_0)}\\right) e^{-a (r - r_0)} = -2 a D_e \\left(e^{-a(r-r_0)} - e^{-2a(r-r_0)}\\right) $$\n当 $r \\to \\infty$ 时，两个指数项都趋于 $0$，所以力 $F_M(r) \\to 0$。这在物理上是正确的；分离的原子之间不应该相互施加力。来自莫尔斯势的力是有界的。其最大值出现在 $r = r_0 + \\frac{\\ln(2)}{a}$ 处，大小等于 $\\frac{a D_e}{2}$。无论系统能量如何，这个力的有限上限可以防止谐振子势中出现的力失控问题。如果初始动能 $E_0$ 超过解离能 $D_e$，键将直接断裂，原子将分离，它们之间的力衰减为零，这是一个在物理上和数值上都稳定的结果。\n\n现在，我们评估每个选项。\n\nA. 在 $U_h(r)$ 下，对于任何有限的 $E_0$，原子都保持键合状态。外转折点满足 $U_h(r_{\\max}) = E_0$，给出 $r_{\\max} = r_0 + \\sqrt{2 E_0 / k}$，在转折点处的最大恢复力大小为 $\\sqrt{2 k E_0}$，随着 $E_0$ 的增加，这个力可以变得任意大，对于固定的 $\\Delta t$ 存在积分器灾难性失效的风险。在 $U_M(r)$ 下，如果 $E_0 > D_e$，键会解离，并且当 $r \\to \\infty$ 时，力的大小衰减到 $0$，因此能量和力保持在具有物理意义的值的界限内，避免了力的失控。\n**Verdict: 正确。** 该陈述准确地总结了上述分析。它正确地指出了谐振子力的无界性质及其数值后果，并将其与莫尔斯势提供的物理上真实的解离和数值上良性的有界力进行了对比。\n\nB. 在 $U_h(r)$ 下，当 $r \\to \\infty$ 时，势能的上限是 $D_e$，因此没有无界力或数值不稳定性的风险；所以用 $U_M(r)$ 替换 $U_h(r)$ 是不必要的。\n**Verdict: 不正确。** 前提是错误的。谐振子势 $U_h(r) = \\frac{1}{2} k (r - r_0)^2$ 是无界的；当 $r$ 远离 $r_0$ 时，它呈二次方增长。因此，力也是无界的，这带来了显著的数值不稳定性风险。\n\nC. 对于小位移 $|r - r_0| \\ll a^{-1}$，$U_M(r)$ 近似为谐振子势，其曲率 $k_{\\mathrm{eff}} = 2 D_e a^2$，因此，可以将 $k_{\\mathrm{eff}}$ 与选定的 $k$ 相匹配，以再现近平衡振动，同时在大 $r$ 处增加真实的键解离行为。\n**Verdict: 正确。** 为了验证这一点，我们对 $U_M(r)$ 在 $r=r_0$ 附近进行泰勒展开。令 $x = r - r_0$。对于小的 $x$，我们有 $e^{-ax} \\approx 1 - ax + \\frac{1}{2}(-ax)^2 = 1-ax+\\frac{a^2x^2}{2}$。\n将此代入莫尔斯势表达式：\n$$ U_M(x) = D_e \\left(1 - \\left(1 - ax + \\frac{a^2x^2}{2} + \\dots \\right)\\right)^2 = D_e \\left(ax - \\frac{a^2x^2}{2} + \\dots \\right)^2 $$\n展开并保留 $x$ 的最低阶项：\n$$ U_M(x) \\approx D_e(ax)^2 = D_e a^2 x^2 = D_e a^2 (r - r_0)^2 $$\n将其与谐振子形式 $U_h(r) = \\frac{1}{2} k (r - r_0)^2$ 进行比较，我们可以定义一个有效的力常数 $k_{eff}$，使得 $\\frac{1}{2} k_{eff} (r - r_0)^2 = D_e a^2 (r-r_0)^2$。这得出 $k_{eff} = 2 D_e a^2$。因此，可以对莫尔斯势进行参数化，以匹配谐振子势在小振荡时的行为，确保其准确地模拟近平衡振动，同时还提供正确的解离行为。这是使用它的一个主要理由。\n\nD. 用 $U_M(r)$ 替换 $U_h(r)$ 必然会增加 $r_0$ 附近的最高振动频率，这迫使在显式MD中需要更小的稳定时间步长 $\\Delta t$，使得莫尔斯势在平衡点附近的数值表现更差。\n**Verdict: 不正确。** 如选项 C 的分析所示，可以选择莫尔斯势的参数（$a$ 和 $D_e$）来匹配任何期望的近平衡有效力常数 $k_{eff}$，包括设置 $k_{eff} = k$（给定谐振子势的力常数）。因此，振动频率 $\\omega = \\sqrt{k_{eff}/\\mu}$（其中 $\\mu$ 是约化质量）不一定增加。该陈述是错误的。\n\nE. 在 $U_h(r)$ 下出现灾难性失效是因为其恢复力随着 $r$ 的增加而衰减到 $0$，导致失控的分离；$U_M(r)$ 通过在大的 $r$ 处提供一个线性增加的力来解决这个问题。\n**Verdict: 不正确。** 这个陈述把物理原理搞反了。$U_h(r)$ 下的失效是由于其线性*增加*的力，这个力会变得无界。而莫尔斯势 $U_M(r)$ 的力在大的 $r$ 处衰减到 $0$。\n\n根据分析，陈述 A 和 C 是对物理和数值属性的正确描述，证明了在分子力学模拟中使用莫尔斯势替代谐振子势的合理性。", "answer": "$$\\boxed{AC}$$", "id": "2407785"}, {"introduction": "力场不仅仅是抽象的数学模型，其参数必须经过仔细校准，以准确再现真实分子的物理化学性质。这个高级练习 [@problem_id:2404445] 让您亲身体验一个复杂的力场参数化过程：静电势（ESP）拟合。通过将经典点电荷模型产生的静电势与高精度的量子力学计算结果进行匹配，您可以为分子确定一套最佳的原子部分电荷。", "problem": "编写一个完整的程序，在原子单位制下，通过最小化力场静电势与一组代表量子力学计算的参考静电势值之间的差异，来拟合甲醛分子的部分原子电荷。该分子包含四个原子：一个碳原子、一个氧原子和两个等效的氢原子。由位于位置 $\\mathbf{R}_i$ 的 $N$ 个点电荷 $q_i$ 在场点位置 $\\mathbf{r}$ 产生的静电势，在原子单位制中（其中 $1/(4\\pi\\varepsilon_0)=1$），由下式给出：\n$$\nV(\\mathbf{r})=\\sum_{i=1}^{N}\\frac{q_i}{\\lVert \\mathbf{r}-\\mathbf{R}_i\\rVert}.\n$$\n对甲醛使用以下固定的原子位置（单位为玻尔）：\n- 碳 (C): $(0.00000,\\,0.00000,\\,0.00000)$\n- 氧 (O): $(2.28660,\\,0.00000,\\,0.00000)$\n- 氢 1 (H1): $(-1.03935,\\,1.80099,\\,0.00000)$\n- 氢 2 (H2): $(-1.03935,\\,-1.80099,\\,0.00000)$\n\n使用以下八个场点（单位为玻尔），在这些点上给出了参考静电势值：\n- $\\mathbf{g}_1=(4.00000,\\,0.00000,\\,0.00000)$\n- $\\mathbf{g}_2=(-4.00000,\\,0.00000,\\,0.00000)$\n- $\\mathbf{g}_3=(0.00000,\\,4.00000,\\,0.00000)$\n- $\\mathbf{g}_4=(0.00000,\\,-4.00000,\\,0.00000)$\n- $\\mathbf{g}_5=(0.00000,\\,0.00000,\\,4.00000)$\n- $\\mathbf{g}_6=(0.00000,\\,0.00000,\\,-4.00000)$\n- $\\mathbf{g}_7=(3.00000,\\,3.00000,\\,0.00000)$\n- $\\mathbf{g}_8=(-3.00000,\\,-3.00000,\\,0.00000)$\n\n在这些场点上相应的参考静电势值 $V_{\\mathrm{ref}}(\\mathbf{g}_k)$（以原子单位制的势能为单位）如下：\n- $V_{\\mathrm{ref}}(\\mathbf{g}_1)=-0.17942$\n- $V_{\\mathrm{ref}}(\\mathbf{g}_2)=0.05318$\n- $V_{\\mathrm{ref}}(\\mathbf{g}_3)=0.02462$\n- $V_{\\mathrm{ref}}(\\mathbf{g}_4)=0.02462$\n- $V_{\\mathrm{ref}}(\\mathbf{g}_5)=0.01088$\n- $V_{\\mathrm{ref}}(\\mathbf{g}_6)=0.01088$\n- $V_{\\mathrm{ref}}(\\mathbf{g}_7)=-0.05177$\n- $V_{\\mathrm{ref}}(\\mathbf{g}_8)=0.05125$\n\n令未知的部分电荷为 $\\mathbf{q}=[q_{\\mathrm{C}},\\,q_{\\mathrm{O}},\\,q_{\\mathrm{H1}},\\,q_{\\mathrm{H2}}]^{\\top}$，单位为基本电荷。通过最小化模型势与参考值之间的加权残差平方和，并附加一个各向同性的 Tikhonov 正则化项来确定 $\\mathbf{q}$：\n$$\n\\min_{\\mathbf{q}} \\; \\sum_{k=1}^{8} w_k \\left( \\sum_{i=1}^{4} \\frac{q_i}{\\lVert \\mathbf{g}_k-\\mathbf{R}_i\\rVert} - V_{\\mathrm{ref}}(\\mathbf{g}_k) \\right)^2 \\;+\\; \\lambda \\sum_{i=1}^{4} q_i^2\n$$\n服从以下精确的线性等式约束：\n1. 分子电中性：$q_{\\mathrm{C}}+q_{\\mathrm{O}}+q_{\\mathrm{H1}}+q_{\\mathrm{H2}}=0$。\n2. 氢原子等效性：$q_{\\mathrm{H1}}-q_{\\mathrm{H2}}=0$。\n\n所有距离必须以玻尔为单位处理，所有电势以原子单位制处理，所有电荷以基本电荷为单位处理。最终拟合的电荷必须按下文规定以基本电荷为单位报告。\n\n测试套件。您的程序必须针对以下三个测试用例求解问题，这些用例在非负权重 $\\{w_k\\}_{k=1}^8$ 和正则化参数 $\\lambda$ 上有所不同：\n- 用例 A (基准): $\\mathbf{w}=[1,\\,1,\\,1,\\,1,\\,1,\\,1,\\,1,\\,1]$, $\\lambda=0$。\n- 用例 B (重加权，轻度正则化): $\\mathbf{w}=[2,\\,1,\\,1,\\,1,\\,1,\\,1,\\,2,\\,1]$, $\\lambda=0.001$。\n- 用例 C (稀疏强调，强度正则化): $\\mathbf{w}=[0,\\,5,\\,0,\\,0,\\,0,\\,0,\\,0,\\,5]$, $\\lambda=1.000$。\n\n答案规格与最终输出格式。对于每个测试用例，计算完全满足约束条件的拟合电荷向量 $\\mathbf{q}$。将 $\\mathbf{q}$ 的每个分量以基本电荷为单位表示，并将每个分量四舍五入到六位小数。您的程序应生成单行输出，其中包含结果，形式为由三个列表组成的逗号分隔列表，每个测试用例一个列表，顺序为 $[q_{\\mathrm{C}},q_{\\mathrm{O}},q_{\\mathrm{H1}},q_{\\mathrm{H2}}]$。例如，要求的格式是\n$[[q_{\\mathrm{C}}^{(A)},q_{\\mathrm{O}}^{(A)},q_{\\mathrm{H1}}^{(A)},q_{\\mathrm{H2}}^{(A)}],[q_{\\mathrm{C}}^{(B)},q_{\\mathrm{O}}^{(B)},q_{\\mathrm{H1}}^{(B)},q_{\\mathrm{H2}}^{(B)}],[q_{\\mathrm{C}}^{(C)},q_{\\mathrm{O}}^{(C)},q_{\\mathrm{H1}}^{(C)},q_{\\mathrm{H2}}^{(C)}]]$，其中每个标量都四舍五入到六位小数，且无额外字符。此问题中没有角度量。所有答案必须以指定单位和格式表示，并汇集到所需的单行输出中。", "solution": "所提出的问题是一个约束二次优化任务，这是计算化学中一个常见的程序，称为静电势（ESP）拟合。我们需要确定甲醛分子的四个部分原子电荷集合 $\\mathbf{q} = [q_{\\mathrm{C}},\\,q_{\\mathrm{O}},\\,q_{\\mathrm{H1}},\\,q_{\\mathrm{H2}}]^{\\top}$，以最佳地重现一组给定的量子力学参考势。这是一个可以解析求解的适定问题。\n\n目标是最小化成本函数 $J(\\mathbf{q})$，该函数由加权残差平方和与 Tikhonov 正则化项组成：\n$$\nJ(\\mathbf{q}) = \\sum_{k=1}^{M} w_k \\left( V_{\\mathrm{model}}(\\mathbf{g}_k) - V_{\\mathrm{ref}}(\\mathbf{g}_k) \\right)^2 \\;+\\; \\lambda \\sum_{i=1}^{N} q_i^2\n$$\n此处，$M=8$ 是场点数，$N=4$ 是原子数。由位于原子位置 $\\mathbf{R}_i$ 的点电荷 $q_i$ 产生的模型势 $V_{\\mathrm{model}}(\\mathbf{g}_k)$ 与电荷成线性关系：\n$$\nV_{\\mathrm{model}}(\\mathbf{g}_k) = \\sum_{i=1}^{N} \\frac{q_i}{\\lVert \\mathbf{g}_k-\\mathbf{R}_i\\rVert}\n$$\n我们可以用矩阵形式表示这种关系。令 $\\mathbf{V}_{\\mathrm{ref}} \\in \\mathbb{R}^{M}$ 为参考势值向量，$\\mathbf{V}_{\\mathrm{model}} \\in \\mathbb{R}^{M}$ 为场点处的模型势向量。则 $\\mathbf{V}_{\\mathrm{model}} = \\mathbf{A}\\mathbf{q}$，其中 $\\mathbf{A}$ 是一个 $M \\times N$ 矩阵，其元素是场点与原子中心之间距离的倒数：\n$$\nA_{ki} = \\frac{1}{\\lVert \\mathbf{g}_k-\\mathbf{R}_i\\rVert}\n$$\n目标函数可以用矩阵代数写成：\n$$\nJ(\\mathbf{q}) = (\\mathbf{A}\\mathbf{q} - \\mathbf{V}_{\\mathrm{ref}})^{\\top} \\mathbf{W} (\\mathbf{A}\\mathbf{q} - \\mathbf{V}_{\\mathrm{ref}}) + \\lambda \\mathbf{q}^{\\top}\\mathbf{I}\\mathbf{q}\n$$\n其中 $\\mathbf{W}$ 是一个由权重 $w_k$ 构成的 $M \\times M$ 对角矩阵，$\\mathbf{I}$ 是 $N \\times N$ 单位矩阵。\n\n最小化过程受两个线性等式约束：\n1.  电中性：$q_{\\mathrm{C}}+q_{\\mathrm{O}}+q_{\\mathrm{H1}}+q_{\\mathrm{H2}}=0$\n2.  等效性：$q_{\\mathrm{H1}}-q_{\\mathrm{H2}}=0$\n\n这些约束减少了系统中独立自由度的数量。我们可以求解这些约束，用一个较小的独立变量集来表示这 4 个电荷。根据第二个约束，我们有 $q_{\\mathrm{H1}} = q_{\\mathrm{H2}}$。我们将这个共同的电荷表示为 $q_{\\mathrm{H}}$。将其代入第一个约束得到 $q_{\\mathrm{C}} + q_{\\mathrm{O}} + 2q_{\\mathrm{H}} = 0$，可以重新整理以将 $q_{\\mathrm{O}}$ 表示为 $q_{\\mathrm{O}} = -q_{\\mathrm{C}} - 2q_{\\mathrm{H}}$。\n\n因此，整个电荷向量 $\\mathbf{q} \\in \\mathbb{R}^4$ 可以由一个包含两个独立变量的向量 $\\mathbf{q}' = [q_{\\mathrm{C}}, q_{\\mathrm{H}}]^{\\top} \\in \\mathbb{R}^2$ 来参数化。该关系是一个线性变换 $\\mathbf{q} = \\mathbf{S}\\mathbf{q}'$，其中 $\\mathbf{S}$ 是一个 $4 \\times 2$ 的代换矩阵：\n$$\n\\mathbf{q} = \\begin{pmatrix} q_{\\mathrm{C}} \\\\ q_{\\mathrm{O}} \\\\ q_{\\mathrm{H1}} \\\\ q_{\\mathrm{H2}} \\end{pmatrix} = \\begin{pmatrix} 1 q_{\\mathrm{C}} + 0 q_{\\mathrm{H}} \\\\ -1 q_{\\mathrm{C}} - 2 q_{\\mathrm{H}} \\\\ 0 q_{\\mathrm{C}} + 1 q_{\\mathrm{H}} \\\\ 0 q_{\\mathrm{C}} + 1 q_{\\mathrm{H}} \\end{pmatrix} = \\begin{pmatrix} 1  0 \\\\ -1  -2 \\\\ 0  1 \\\\ 0  1 \\end{pmatrix} \\begin{pmatrix} q_{\\mathrm{C}} \\\\ q_{\\mathrm{H}} \\end{pmatrix} = \\mathbf{S}\\mathbf{q}'\n$$\n将 $\\mathbf{q} = \\mathbf{S}\\mathbf{q}'$ 代入目标函数，将 $\\mathbb{R}^4$ 中的约束问题转化为 $\\mathbb{R}^2$ 中的无约束问题：\n$$\nJ(\\mathbf{q}') = (\\mathbf{A}\\mathbf{S}\\mathbf{q}' - \\mathbf{V}_{\\mathrm{ref}})^{\\top} \\mathbf{W} (\\mathbf{A}\\mathbf{S}\\mathbf{q}' - \\mathbf{V}_{\\mathrm{ref}}) + \\lambda (\\mathbf{S}\\mathbf{q}')^{\\top}(\\mathbf{S}\\mathbf{q}')\n$$\n我们定义一个简化的 $M \\times 2$ 几何矩阵 $\\mathbf{A}' = \\mathbf{A}\\mathbf{S}$。目标函数变为：\n$$\nJ(\\mathbf{q}') = (\\mathbf{A}'\\mathbf{q}' - \\mathbf{V}_{\\mathrm{ref}})^{\\top} \\mathbf{W} (\\mathbf{A}'\\mathbf{q}' - \\mathbf{V}_{\\mathrm{ref}}) + \\lambda \\mathbf{q}'^{\\top}\\mathbf{S}^{\\top}\\mathbf{S}\\mathbf{q}'\n$$\n这是一个标准的二次型。为了找到最小值，我们计算关于 $\\mathbf{q}'$ 的梯度并将其设为零：\n$$\n\\nabla_{\\mathbf{q}'} J(\\mathbf{q}') = 2\\mathbf{A}'^{\\top}\\mathbf{W}(\\mathbf{A}'\\mathbf{q}' - \\mathbf{V}_{\\mathrm{ref}}) + 2\\lambda\\mathbf{S}^{\\top}\\mathbf{S}\\mathbf{q}' = \\mathbf{0}\n$$\n重新整理各项，得到一个关于 $\\mathbf{q}'$ 的 $2 \\times 2$ 线性方程组，称为正规方程：\n$$\n(\\mathbf{A}'^{\\top}\\mathbf{W}\\mathbf{A}' + \\lambda\\mathbf{S}^{\\top}\\mathbf{S})\\mathbf{q}' = \\mathbf{A}'^{\\top}\\mathbf{W}\\mathbf{V}_{\\mathrm{ref}}\n$$\n这个形式为 $\\mathbf{M}\\mathbf{x} = \\mathbf{b}$ 的系统可以可靠地求解出 $\\mathbf{q}'$。矩阵 $\\mathbf{A}'^{\\top}\\mathbf{W}\\mathbf{A}'$ 是半正定的，而 $\\mathbf{S}^{\\top}\\mathbf{S}$ 是正定的。对于任何 $\\lambda \\ge 0$，只要 $\\mathbf{A}'$ 是满列秩的（对于给定的几何结构这是成立的），矩阵 $\\mathbf{M} = \\mathbf{A}'^{\\top}\\mathbf{W}\\mathbf{A}' + \\lambda\\mathbf{S}^{\\top}\\mathbf{S}$ 就是正定的，因此是可逆的，从而保证了唯一解。\n\n计算步骤如下：\n1.  根据给定的原子坐标和场点构造矩阵 $\\mathbf{A}$。\n2.  定义代换矩阵 $\\mathbf{S}$。\n3.  对于三个测试用例中的每一个，定义权重矩阵 $\\mathbf{W}$ 和正则化参数 $\\lambda$。\n4.  建立并求解关于独立电荷向量 $\\mathbf{q}' = [q_{\\mathrm{C}}, q_{\\mathrm{H}}]^{\\top}$ 的 $2 \\times 2$ 线性系统。\n5.  使用变换 $\\mathbf{q} = \\mathbf{S}\\mathbf{q}'$ 重构完整的电荷向量 $\\mathbf{q}$。\n6.  按照规定格式化所得电荷 $[q_{\\mathrm{C}}, q_{\\mathrm{O}}, q_{\\mathrm{H1}}, q_{\\mathrm{H2}}]^{\\top}$。\n\n该过程将在提供的 Python 代码中实现，以计算三个测试用例的解。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves for partial atomic charges by minimizing a regularized,\n    weighted sum of squared residuals between a force field electrostatic\n    potential and reference values, subject to linear constraints.\n    \"\"\"\n\n    # --- Step 1: Define Givens (in atomic units) ---\n\n    # Atomic positions (bohr), N=4 atoms\n    # Order: C, O, H1, H2\n    R_atoms = np.array([\n        [0.00000, 0.00000, 0.00000],   # C\n        [2.28660, 0.00000, 0.00000],   # O\n        [-1.03935, 1.80099, 0.00000],  # H1\n        [-1.03935, -1.80099, 0.00000]   # H2\n    ])\n\n    # Field points (bohr), M=8 points\n    g_points = np.array([\n        [4.00000, 0.00000, 0.00000],\n        [-4.00000, 0.00000, 0.00000],\n        [0.00000, 4.00000, 0.00000],\n        [0.00000, -4.00000, 0.00000],\n        [0.00000, 0.00000, 4.00000],\n        [0.00000, 0.00000, -4.00000],\n        [3.00000, 3.00000, 0.00000],\n        [-3.00000, -3.00000, 0.00000]\n    ])\n\n    # Reference electrostatic potential (atomic units)\n    V_ref = np.array([\n        -0.17942, 0.05318, 0.02462, 0.02462,\n        0.01088, 0.01088, -0.05177, 0.05125\n    ])\n\n    # Test cases: weights w and regularization parameter lambda\n    test_cases = [\n        # Case A\n        {'w': np.ones(8), 'lambda': 0.0},\n        # Case B\n        {'w': np.array([2., 1., 1., 1., 1., 1., 2., 1.]), 'lambda': 0.001},\n        # Case C\n        {'w': np.array([0., 5., 0., 0., 0., 0., 0., 5.]), 'lambda': 1.000}\n    ]\n\n    # --- Step 2: Formulate the Linear System ---\n\n    # The 4 charges q = [q_C, q_O, q_H1, q_H2] are dependent.\n    # Constraints:\n    # 1. q_H1 - q_H2 = 0  => q_H1 = q_H2 = q_H\n    # 2. q_C + q_O + q_H1 + q_H2 = 0 => q_O = -q_C - 2*q_H\n    # Independent variables are q' = [q_C, q_H].\n    # The transformation is q = S @ q'.\n    S = np.array([\n        [1., 0.],    # q_C = 1*q_C + 0*q_H\n        [-1., -2.],  # q_O = -1*q_C - 2*q_H\n        [0., 1.],    # q_H1 = 0*q_C + 1*q_H\n        [0., 1.]     # q_H2 = 0*q_C + 1*q_H\n    ])\n\n    # Compute the M x N matrix A of inverse distances 1/||g_k - R_i||\n    # Using broadcasting to calculate all distances at once\n    # g_points shape (M, 1, 3), R_atoms shape (1, N, 3)\n    # dists shape (M, N)\n    dists = np.linalg.norm(g_points[:, np.newaxis, :] - R_atoms[np.newaxis, :, :], axis=2)\n    A = 1.0 / dists\n\n    # Compute the reduced M x 2 geometry matrix A' = A @ S\n    A_prime = A @ S\n\n    # Compute the 2 x 2 matrix T = S^T @ S for the regularization term\n    T = S.T @ S\n\n    results = []\n    # --- Step 3: Solve for each test case ---\n    for case in test_cases:\n        w_k = case['w']\n        lambda_reg = case['lambda']\n\n        # Weight matrix W is diagonal\n        W = np.diag(w_k)\n\n        # Form the 2x2 linear system M @ q' = v\n        # M = A'^T @ W @ A' + lambda * S^T @ S\n        M = A_prime.T @ W @ A_prime + lambda_reg * T\n        # v = A'^T @ W @ V_ref\n        v = A_prime.T @ W @ V_ref\n\n        # Solve for the independent variables q' = [q_C, q_H]\n        q_prime = np.linalg.solve(M, v)\n\n        # Reconstruct the full 4-element charge vector q = S @ q'\n        q = S @ q_prime\n        \n        # Round to 6 decimal places for final output\n        rounded_q = [f\"{charge:.6f}\" for charge in q]\n        results.append(rounded_q)\n\n    # --- Step 4: Format and Print Final Output ---\n    # The format is a list of lists: [[...],[...],[...]]\n    case_strings = [f\"[{','.join(res)}]\" for res in results]\n    final_output = f\"[{','.join(case_strings)}]\"\n    print(final_output)\n\nsolve()\n```", "id": "2404445"}]}