{"hands_on_practices": [{"introduction": "理解系统性能始于对其进行量化。本练习将引导您推导平均内存访问时间（AMAT），这是内存层次结构分析的基石指标。通过计算 AMAT 对各级缓存未命中率的敏感性，您将学会识别对整体性能影响最大的层次结构部分，这对于性能调优和体系结构设计至关重要 [@problem_id:3660682]。", "problem": "一个三级缓存层次结构由一级（$L1$）、二级（$L2$）和三级（$L3$）缓存以及主内存组成。平均内存访问时间（AMAT）定义为每次内存引用的期望延迟。设 $m_1$、$m_2$ 和 $m_3$ 分别表示 $L1$、$L2$ 和 $L3$ 的未命中率，其中每个 $m_i$ 是在访问已到达第 $i$ 级缓存时的条件未命中概率。设 $t_1$、$t_2$ 和 $t_3$ 分别表示访问 $L1$、$L2$ 和 $L3$ 的服务时间（延迟），并设 $t_M$ 表示主内存访问延迟。假设一次内存引用探测 $L1$ 耗时 $t_1$；如果 $L1$ 未命中，则探测 $L2$ 耗时 $t_2$；如果 $L2$ 未命中，则探测 $L3$ 耗时 $t_3$；如果 $L3$ 未命中，则访问主内存耗时 $t_M$。假设没有重叠，并且延迟沿未命中路径累加。\n\n仅从全期望定律、条件概率的定义以及每个事件的期望成本出发，完成以下任务：\n\n1. 根据在每一级命中或未命中的互斥事件，使用 $t_1$、$t_2$、$t_3$、$t_M$ 和条件未命中率 $m_1$、$m_2$、$m_3$ 将 AMAT 表示为一个期望值。然后，通过计算偏导数 $\\frac{\\partial\\, AMAT}{\\partial m_1}$、$\\frac{\\partial\\, AMAT}{\\partial m_2}$ 和 $\\frac{\\partial\\, AMAT}{\\partial m_3}$，符号化地推导出 AMAT 对每个 $m_i$ 的敏感度。\n\n2. 假设您有硬件性能计数器 (HPC)，可以报告总周期数 $C$、总内存引用数 $N$ 以及每级的未命中数 $M_1$、$M_2$、$M_3$。请描述一个基于实证的流程，通过设计受控扰动实验来调整某个 $m_i$ 同时保持其他 $m_j$ 近似恒定，从而估计在一个操作点附近的每个偏导数 $\\frac{\\partial\\, AMAT}{\\partial m_i}$。您的设计必须解释如何利用相对于 $L1$、$L2$ 和 $L3$ 容量的工作负载工作集来隔离 $m_1$、$m_2$ 和 $m_3$ 的变化，以及如何使用从计数器得到的估计值 $\\hat{AMAT} = \\frac{C}{N}$ 和 $\\hat{m}_i$ 通过小有限差分来近似每个导数。\n\n3. 对于一个系统，其参数为 $t_1 = 1$ 周期，$t_2 = 12$ 周期，$t_3 = 35$ 周期，$t_M = 220$ 周期，$m_1 = 0.07$，$m_2 = 0.22$ 和 $m_3 = 0.40$，计算在此操作点上 $\\frac{\\partial\\, AMAT}{\\partial m_2}$ 的数值。以周期为单位表示最终答案，并将答案四舍五入到4位有效数字。", "solution": "该问题陈述具有科学依据、提法恰当，并提供了所有必要的参数和定义。它与计算机体系结构和性能分析的既定原则相符。因此，该问题被认为是有效的，下面将给出完整解答。\n\n解答按要求分为三个部分呈现。\n\n### 第1部分：AMAT 推导与敏感度分析\n\n平均内存访问时间（AMAT）是服务一次内存引用所需的总时间 $T$ 的期望值。我们可以利用全期望定律，考虑内存层次结构中每一级产生的成本，来推导 AMAT 的表达式。该模型指定了一种顺序、非重叠的访问模式。\n\n每次内存引用都必须首先访问一级（$L1$）缓存，这需要时间 $t_1$。\n这些引用中的一部分（由条件 $L1$ 未命中率 $m_1$ 给出）将在 $L1$ 中未命中，然后必须继续访问二级（$L2$）缓存。访问 $L2$ 产生的额外时间为 $t_2$。\n到达 $L2$ 的引用中，一部分（由条件 $L2$ 未命中率 $m_2$ 给出）也将在 $L2$ 中未命中。在 $L1$ 和 $L2$ 中都未命中的引用占总引用数的绝对比例是概率的乘积 $m_1 m_2$。这些引用将继续访问三级（$L3$）缓存，产生额外的时间 $t_3$。\n最后，到达 $L3$ 的引用中，一部分（由条件 $L3$ 未命中率 $m_3$ 给出）将会未命中。在所有三级缓存中都未命中的引用占总引用数的绝对比例是 $m_1 m_2 m_3$。这些引用必须访问主内存，产生最终的额外惩罚 $t_M$。\n\n将这些成本按其发生的概率加权求和，得到 AMAT 方程：\n$$AMAT = t_1 + m_1 t_2 + (m_1 m_2) t_3 + (m_1 m_2 m_3) t_M$$\n\n这个表达式代表了期望成本，从访问 $L1$ 的基本成本开始，并加上在每个后续级别未命中的期望惩罚。\n\n为了求出 AMAT 对每个条件未命中率 $m_i$ 的敏感度，我们计算 AMAT 表达式关于 $m_1$、$m_2$ 和 $m_3$ 的偏导数。\n\n**对 $m_1$ 的敏感度：**\n我们将 $m_2$ 和 $m_3$ 视为常数，并对 $m_1$ 求导：\n$$ \\frac{\\partial\\, AMAT}{\\partial m_1} = \\frac{\\partial}{\\partial m_1} (t_1 + m_1 t_2 + m_1 m_2 t_3 + m_1 m_2 m_3 t_M) $$\n$$ \\frac{\\partial\\, AMAT}{\\partial m_1} = 0 + t_2 + m_2 t_3 + m_2 m_3 t_M $$\n$$ \\frac{\\partial\\, AMAT}{\\partial m_1} = t_2 + m_2(t_3 + m_3 t_M) $$\n这个导数表示 $L1$ 未命中率发生微小变化时 AMAT 的变化量。它是 $L1$ 未命中的完全未命中惩罚，包括访问 $L2$ 的时间（$t_2$）加上层次结构中更低级别的期望未命中惩罚。\n\n**对 $m_2$ 的敏感度：**\n我们将 $m_1$ 和 $m_3$ 视为常数，并对 $m_2$ 求导：\n$$ \\frac{\\partial\\, AMAT}{\\partial m_2} = \\frac{\\partial}{\\partial m_2} (t_1 + m_1 t_2 + m_1 m_2 t_3 + m_1 m_2 m_3 t_M) $$\n$$ \\frac{\\partial\\, AMAT}{\\partial m_2} = 0 + 0 + m_1 t_3 + m_1 m_3 t_M $$\n$$ \\frac{\\partial\\, AMAT}{\\partial m_2} = m_1 (t_3 + m_3 t_M) $$\n这个导数按 $m_1$ 进行了缩放，因为 $m_2$ 的任何变化只影响那些已经在 $L1$ 中未命中的访问比例。项 $(t_3 + m_3 t_M)$ 是 $L2$ 未命中的未命中惩罚。\n\n**对 $m_3$ 的敏感度：**\n我们将 $m_1$ 和 $m_2$ 视为常数，并对 $m_3$ 求导：\n$$ \\frac{\\partial\\, AMAT}{\\partial m_3} = \\frac{\\partial}{\\partial m_3} (t_1 + m_1 t_2 + m_1 m_2 t_3 + m_1 m_2 m_3 t_M) $$\n$$ \\frac{\\partial\\, AMAT}{\\partial m_3} = 0 + 0 + 0 + m_1 m_2 t_M $$\n$$ \\frac{\\partial\\, AMAT}{\\partial m_3} = m_1 m_2 t_M $$\n这个导数按因子 $m_1 m_2$ 进行了缩放，因为 $m_3$ 的变化仅与那些已经在 $L1$ 和 $L2$ 中都未命中的访问相关。项 $t_M$ 是 $L3$ 未命中的未命中惩罚。\n\n### 第2部分：经验估计流程\n\n为了经验地估计偏导数 $\\frac{\\partial\\, AMAT}{\\partial m_i}$，我们可以设计受控实验，单独扰动每个 $m_i$ 并测量 AMAT 的相应变化。此流程使用硬件性能计数器 (HPC) 和有限差分法。\n\n首先，我们建立模型参数与 HPC 可观察量之间的关系：\n-   总内存引用数：$N$\n-   这些引用的总执行周期数：$C$\n-   $L1$ 未命中数：$M_1$\n-   $L2$ 未命中数：$M_2$\n-   $L3$ 未命中数：$M_3$\n\n根据这些计数器，我们可以估计模型在一个操作点附近的参数：\n-   估计的 AMAT：$\\hat{AMAT} = \\frac{C}{N}$\n-   估计的条件 $L1$ 未命中率：$\\hat{m}_1 = \\frac{M_1}{N}$\n-   估计的条件 $L2$ 未命中率：$\\hat{m}_2 = \\frac{M_2}{M_1}$（当 $M_1 > 0$ 时）\n-   估计的条件 $L3$ 未命中率：$\\hat{m}_3 = \\frac{M_3}{M_2}$（当 $M_2 > 0$ 时）\n\n估计 $\\frac{\\partial\\, AMAT}{\\partial m_i}$ 的实验流程如下：\n\n**通用流程：**\n1.  **隔离目标变量：** 为了估计对特定未命中率 $m_i$ 的敏感度，我们必须设计一种方法来改变 $m_i$，同时尽可能保持其他未命中率 $m_j$（其中 $j \\neq i$）不变。这可以通过仔细控制测试工作负载的工作集大小（WSS）相对于缓存容量 $S_1, S_2, S_3$ 来实现。\n\n2.  **设计扰动工作负载：** 针对每个目标 $m_i$，创建两个工作负载：一个基准工作负载（$W_a$）和一个扰动工作负载（$W_b$）。\n    -   要扰动 $m_1$：设计 $W_a$ 的 WSS $\\le S_1$，设计 $W_b$ 的 WSS $> S_1$ 但 WSS $\\ll S_2$。\n    -   要扰动 $m_2$：设计 $W_a$ 的 WSS $> S_1$ 但 WSS $\\le S_2$，设计 $W_b$ 的 WSS $> S_2$ 但 WSS $\\ll S_3$。\n    -   要扰动 $m_3$：设计 $W_a$ 的 WSS $> S_2$ 但 WSS $\\le S_3$，设计 $W_b$ 的 WSS $> S_3$。\n\n3.  **数据收集：** 在目标系统上执行两个工作负载（$W_a$ 和 $W_b$），并为每次运行收集 HPC 数据（$C, N, M_1, M_2, M_3$）。设基准运行收集的数据为 ($C_a, N_a, M_{1a}, M_{2a}, M_{3a}$)，扰动运行收集的数据为 ($C_b, N_b, M_{1b}, M_{2b}, M_{3b}$)。\n\n4.  **计算经验参数：** 对于每次运行 $k \\in \\{a, b\\}$，使用上面定义的公式计算估计参数 $\\hat{AMAT}_k$、$\\hat{m}_{1,k}$、$\\hat{m}_{2,k}$ 和 $\\hat{m}_{3,k}$。\n\n5.  **近似导数：** 使用有限差分近似法来计算偏导数。例如，要估计对 $m_2$ 的敏感度：\n$$ \\frac{\\partial\\, AMAT}{\\partial m_2} \\approx \\frac{\\Delta \\hat{AMAT}}{\\Delta \\hat{m}_2} = \\frac{\\hat{AMAT}_b - \\hat{AMAT}_a}{\\hat{m}_{2,b} - \\hat{m}_{2,a}} $$\n\n6.  **验证：** 一个关键步骤是验证实验的质量。非目标未命中率的变化量 $|\\hat{m}_{j,b} - \\hat{m}_{j,a}|$（对于 $j \\neq i$）应显著小于目标未命中率的变化量 $|\\hat{m}_{i,b} - \\hat{m}_{i,a}|$。如果不满足此条件，则必须优化实验设置（例如，工作负载的 WSS），以更好地隔离感兴趣的变量。\n\n这个系统化的流程允许我们基于实证来估计系统性能（AMAT）对各级缓存效率的敏感度。\n\n### 第3部分：数值计算\n\n我们被要求计算在特定操作点上 $\\frac{\\partial\\, AMAT}{\\partial m_2}$ 的数值。第1部分推导出的公式是：\n$$ \\frac{\\partial\\, AMAT}{\\partial m_2} = m_1 (t_3 + m_3 t_M) $$\n\n给定的值为：\n-   $t_1 = 1$ 周期\n-   $t_2 = 12$ 周期\n-   $t_3 = 35$ 周期\n-   $t_M = 220$ 周期\n-   $m_1 = 0.07$\n-   $m_2 = 0.22$\n-   $m_3 = 0.40$\n\n将相关值代入偏导数表达式中：\n$$ \\frac{\\partial\\, AMAT}{\\partial m_2} = 0.07 \\times (35 + 0.40 \\times 220) $$\n首先，我们计算括号内的项，它代表 $L2$ 的未命中惩罚：\n$$ 35 + 0.40 \\times 220 = 35 + 88 = 123 $$\n现在，我们乘以 $L1$ 的未命中率：\n$$ \\frac{\\partial\\, AMAT}{\\partial m_2} = 0.07 \\times 123 = 8.61 $$\n结果是 $8.61$ 周期。题目要求将答案四舍五入到4位有效数字。因此，该值为 $8.610$。这个值意味着，如果 $L2$ 的条件未命中率有小幅增加，例如增加 $0.01$（即 $1\\%$），AMAT 将大约增加 $0.01 \\times 8.610 = 0.0861$ 周期。", "answer": "$$\n\\boxed{8.610}\n$$", "id": "3660682"}, {"introduction": "在这个实践场景中，理论模型与现实相遇，您将诊断一个常见的性能瓶颈：缓存争用。您将分析当指令流和数据流的工作集大于统一 L1 缓存容量时，它们如何竞争有限的缓存空间，从而导致高未命中率。本练习让您亲身体验如何计算缓存组织结构和替换策略对流水线停顿的实际影响 [@problem_id:3660665]。", "problem": "一个单线程微基准测试在一个具有统一 L1 缓存（一级缓存）和多级存储层次结构的处理器上执行。该统一 L1 缓存的容量为 $64 \\,\\text{KiB}$，相联度为 $4$（四路组相联），缓存行大小为 $64 \\,\\text{B}$。L2 缓存（二级缓存）是统一的，容量为 $512 \\,\\text{KiB}$，相联度为 $8$，缓存行大小为 $64 \\,\\text{B}$。L3 缓存（三级缓存）是统一的，容量为 $8 \\,\\text{MiB}$，相联度为 $16$，缓存行大小为 $64 \\,\\text{B}$。该统一 L1 缓存采用物理索引和物理标记，其组索引由地址位 $b_{6..13}$ 形成。\n\n该微基准测试将一个大的代码段及其只读数据数组在内存中连续存放，并按 $64 \\,\\text{B}$ 对齐。代码段大小为 $96 \\,\\text{KiB}$，数据数组大小为 $48 \\,\\text{KiB}$。在微基准测试的每次迭代中：\n- 指令流顺序执行整个 $96 \\,\\text{KiB}$ 的代码段一次，以恒定速率获取指令，并具有空间局部性，每个 $64 \\,\\text{B}$ 的缓存行恰好被访问一次。\n- 数据访问模式顺序地从整个 $48 \\,\\text{KiB}$ 数据数组的每个 $64 \\,\\text{B}$ 缓存行中加载一个 $8 \\,\\text{B}$ 的元素一次，每个数据行产生一次请求加载。\n\n假设如下：\n- 代码和数据的放置方式使其地址均匀地跨越统一 L1 缓存中相同的组索引，即，由于它们是连续且对齐的，并且索引位 $b_{6..13}$ 为 L1 缓存选择了 256 个组，两个流都均匀分布在所有 L1 组上，并竞争相同的组。\n- 替换策略为真正的最近最少使用（LRU）。\n- L2 缓存可以容纳来自两个流的整个工作集，在一次迭代中不会发生替换，并且 L2 命中以重新填充 L1 缓存行的延迟为 $12$ 个周期。在此场景中忽略 L3 和主存。\n- 来自统一 L1 缓存的未命中不发生重叠；即，每次 L1 未命中都会累加到流水线停顿周期中，且处理器无法隐藏这些惩罚。\n\n从未命中率和相联度约束的定义出发，确定指令获取和数据加载的稳态 L1 未命中率，分别表示为 $m_{I1}$ 和 $m_{D1}$。然后，假设每次 L1 未命中都由 L2 命中的 $12$ 个周期延迟来服务，计算每次迭代中由两个流的 L1 未命中引起的总流水线停顿周期。将最终的停顿计数以每次迭代的周期数表示，并将此停顿计数四舍五入到四位有效数字。最终答案必须是一个单行矩阵，按顺序包含 $m_{I1}$、$m_{D1}$ 和四舍五入后的每次迭代的停顿周期。", "solution": "该解决方案旨在解决一个关于缓存性能的问题。\n\n### 步骤 1：问题分析\n\n首先，我们验证问题陈述的合理性与完整性。\n\n#### 已知参数：\n- **处理器：** 单线程。\n- **L1 缓存（统一）：**\n  - 容量: $C_1 = 64 \\,\\text{KiB}$\n  - 相联度: $A_1 = 4$ (四路组相联)\n  - 行大小: $L = 64 \\,\\text{B}$\n  - 索引/标记: 物理索引，物理标记。\n  - 组索引: 地址位 $b_{6..13}$，对应 256 个组 ($2^{13-6+1} = 2^8 = 256$)。\n  - L1 缓存结构验证: $S_1 \\times A_1 \\times L = 256 \\times 4 \\times 64 \\,\\text{B} = 65536 \\,\\text{B} = 64 \\,\\text{KiB}$。结构一致。\n- **L2 缓存（统一）：** 容量 $C_2 = 512 \\,\\text{KiB}$。\n- **工作负载：**\n  - 代码段大小: $W_I = 96 \\,\\text{KiB}$\n  - 数据数组大小: $W_D = 48 \\,\\text{KiB}$\n  - 总工作集大小： $W_{total} = W_I + W_D = 96 + 48 = 144 \\,\\text{KiB}$。\n- **访问模式（每次迭代）：**\n  - **指令：** 顺序扫描 $96 \\,\\text{KiB}$ 代码段，每个 $64 \\,\\text{B}$ 行访问一次。\n  - **数据：** 顺序扫描 $48 \\,\\text{KiB}$ 数据数组，每个 $64 \\,\\text{B}$ 行访问一次。\n- **假设：**\n  1.  工作负载均匀分布在所有 256 个 L1 组上。\n  2.  替换策略：真 LRU。\n  3.  L2 缓存足够大，可以容纳整个工作集（$144 \\,\\text{KiB}  512 \\,\\text{KiB}$），因此所有 L1 未命中都将在 L2 命中。\n  4.  L1 未命中惩罚（L2 命中延迟）：$T_{penalty} = 12$ 周期。\n  5.  L1 未命中惩罚不重叠，直接累加为停顿。\n- **要求：**\n  1.  稳态 L1 指令未命中率, $m_{I1}$。\n  2.  稳态 L1 数据未命中率, $m_{D1}$。\n  3.  每次迭代的总流水线停顿周期（四舍五入到四位有效数字）。\n\n#### 问题分析：\n问题设置是科学合理的，所有参数都已明确给出。核心在于分析在 L1 统一缓存中，总工作集大小（144 KiB）远大于缓存容量（64 KiB）时，指令流和数据流之间的冲突。\n\n### 步骤 2：求解过程\n\n我们分析一个具有代表性的 L1 缓存组的行为。\n\n首先，计算两个流产生的缓存行数量：\n- 指令流的行数： $N_I = \\frac{W_I}{L} = \\frac{96 \\times 1024 \\,\\text{B}}{64 \\,\\text{B}} = 1536$ 行。\n- 数据流的行数： $N_D = \\frac{W_D}{L} = \\frac{48 \\times 1024 \\,\\text{B}}{64 \\,\\text{B}} = 768$ 行。\n\n由于工作负载均匀分布在 256 个组中，映射到每个组的行数为：\n- 每个组的指令行数： $N_{I,set} = \\frac{N_I}{S_1} = \\frac{1536}{256} = 6$。\n- 每个组的数据行数： $N_{D,set} = \\frac{N_D}{S_1} = \\frac{768}{256} = 3$。\n\n因此，在每次迭代中，每个缓存组都会被来自指令流和数据流的总共 $N_{total,set} = 6 + 3 = 9$ 个不同的缓存行所访问。\n\nL1 缓存是 $A_1=4$ 路组相联的，这意味着每个组只能同时容纳 4 个缓存行。由于映射到每个组的唯一行数（9）大于该组的相联度（4），必然会发生冲突未命中。\n\n考虑到访问模式是单次顺序扫描，在一次迭代中没有行被重用。让我们分析一个组的稳态行为：\n1.  对一个组的前 4 个唯一行的访问将是强制性未命中，并填满该组。\n2.  对该组的第 5 个唯一行的访问将是一次冲突未命中。根据 LRU 策略，它将驱逐最早被加载的行。\n3.  对该组的第 6、7、8、9 个唯一行的访问也都是冲突未命中，每次都会驱逐当前组中最旧的行。\n由于在一次迭代中，每个行只被访问一次，所以当一个行被驱逐后，在本次迭代中它再也不会被访问到，因此也不会有命中的机会。当下一次迭代开始时，程序又从头开始访问，但所需的行早已被后续的访问所驱逐。\n\n因此，在稳态下，对 1536 个指令行和 768 个数据行的每一次访问都将导致一次 L1 未命中。\n\n**计算未命中率：**\n未命中率定义为未命中次数与访问次数的比率。\n- 指令流访问 1536 个不同的行，每次访问都是未命中。\n  $$m_{I1} = \\frac{\\text{指令未命中数}}{\\text{指令访问数}} = \\frac{1536}{1536} = 1$$\n- 数据流访问 768 个不同的行，每次访问都是未命中。\n  $$m_{D1} = \\frac{\\text{数据未命中数}}{\\text{数据访问数}} = \\frac{768}{768} = 1$$\n\n**计算总流水线停顿周期：**\n每次迭代的总 L1 未命中数是指令和数据未命中数之和：\n$$\\text{总未命中数} = N_I + N_D = 1536 + 768 = 2304$$\n每次 L1 未命中都会导致 $T_{penalty} = 12$ 个周期的流水线停顿。\n$$\\text{总停顿周期} = \\text{总未命中数} \\times T_{penalty} = 2304 \\times 12 = 27648$$\n问题要求将结果四舍五入到四位有效数字。数字 27648 有五位有效数字。我们将第五位数字（8）向上舍入，得到：\n$$\\text{四舍五入后的停顿周期} = 27650$$\n\n最终答案包含三个值：$m_{I1}$、$m_{D1}$ 和四舍五入后的停顿周期。\n$m_{I1} = 1$\n$m_{D1} = 1$\n停顿周期 = $27650$", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n1  1  27650\n\\end{pmatrix}\n}\n$$", "id": "3660665"}, {"introduction": "缓存设计是一场权衡的艺术，其中最基本的一项就是选择缓存行大小。这个问题挑战您从分析转向设计，推导出一个精确的数学条件，用以判断在何种情况下增大缓存行对性能有利或有弊。通过对空间局部性与内存带宽消耗之间的相互作用进行建模，您将对指导现代处理器体系结构设计的原则有更深刻的理解 [@problem_id:3660631]。", "problem": "考虑一个包含L1、L2和L3三个级别的包容性三级缓存层次结构，其中L1为1级缓存 ($\\text{L1}$)，L2为2级缓存 ($\\text{L2}$)，L3为3级缓存 ($\\text{L3}$)。每个级别使用固定的相联度和一个共同的缓存行大小 $B$ (字节)。单次引用的平均内存访问时间(AMAT)由各级命中延迟和未命中代价的递归组合定义，其中L1、L2和L3的命中率分别为 $h_1$、$h_2$ 和 $h_3$，未命中率为 $m_i = 1 - h_i$。设L1、L2和L3的命中延迟分别为 $t_1$、$t_2$ 和 $t_3$。对于从主内存填充缓存行，未命中代价建模为 $P_{\\text{mem}}(B) = \\alpha + \\beta B$，其中 $\\alpha$ 是固定的访问延迟，$\\beta$ 是内存子系统的每字节传输时间。该层次结构是包容性的，并且L3的缓存行填充成本主要由主内存的未命中代价决定。\n\n定义浪费加载分数 $w$ 为每个缓存行中在被驱逐之前未被工作负载引用的字节的期望分数。当缓存行大小加倍到 $2B$ 时，级别 $i \\in \\{1,2,3\\}$ 的命中率从 $h_i$ 变为 $h_i' = h_i + \\Delta h_i$，其中增量命中率收益建模为 $\\Delta h_i = c_i (1 - w)$，系数 $c_i$ 为非负数，取决于重用行为和微架构，但不依赖于 $w$。假设 $0 \\leq \\Delta h_i \\leq 1 - h_i$。\n\n从平均内存访问时间在各级别上的核心定义和线性传输时间模型 $P_{\\text{mem}}(B) = \\alpha + \\beta B$ 出发，推导一个解析条件，该条件关联了 $h_1$、$h_2$、$h_3$、$t_2$、$t_3$、$\\alpha$、$\\beta$、$B$、$c_1$、$c_2$、$c_3$ 和 $w$。在此条件下，将缓存行大小从 $B$ 加倍到 $2B$ 会对顺序工作负载（低 $w$）严格降低AMAT，但对随机工作负载（高 $w$）严格增加AMAT。然后，将此条件表示为单个阈值 $w^{\\*}$，使得当 $B$ 加倍时，$w  w^{\\*}$ 意味着AMAT降低，而 $w  w^{\\*}$ 意味着AMAT增加。你的最终答案必须是关于指定参数的 $w^{\\*}$ 的封闭形式表达式。不要提供任何数值近似。", "solution": "起点是三级包容性层次结构的平均内存访问时间(AMAT)的定义。令 $m_i = 1 - h_i$ 表示未命中率。当缓存行大小为 $B$ 时，我们有\n$$\n\\text{AMAT}(B) = t_1 + m_1 \\left[ t_2 + m_2 \\left( t_3 + m_3 P_{\\text{mem}}(B) \\right) \\right],\n$$\n其中 $P_{\\text{mem}}(B) = \\alpha + \\beta B$ 表示主内存的未命中代价。当缓存行大小加倍到 $2B$ 时，主内存的未命中代价变为\n$$\nP_{\\text{mem}}(2B) = \\alpha + \\beta (2B) = P_{\\text{mem}}(B) + \\Delta P,\n$$\n其中\n$$\n\\Delta P = \\beta B.\n$$\n将 $B$ 加倍会使命中率变为 $h_i' = h_i + \\Delta h_i$，其中 $\\Delta h_i = c_i (1 - w)$ 且 $c_i \\geq 0$。因此，新的未命中率为 $m_i' = 1 - h_i' = m_i - \\Delta h_i$。新的AMAT为\n$$\n\\text{AMAT}(2B) = t_1 + m_1' \\left[ t_2 + m_2' \\left( t_3 + m_3' P_{\\text{mem}}(2B) \\right) \\right].\n$$\n\n为了推导出一个易于处理的符号条件，我们分析AMAT相对于微小增量 $\\Delta h_i$ 和由行大小引起的代价增量 $\\Delta P$ 的一阶变化。定义\n$$\nA \\equiv t_2 + m_2 \\left( t_3 + m_3 P_{\\text{mem}}(B) \\right),\n$$\n这是在基线 $B$ 下L1未命中的期望代价。在L2级别，括号内受扰动的量可以一阶线性化为\n$$\nA' \\approx A + m_2 m_3 \\Delta P - \\Delta h_2 \\left( t_3 + m_3 P_{\\text{mem}}(B) \\right) - m_2 \\Delta h_3 P_{\\text{mem}}(B),\n$$\n其中我们忽略了增量的乘积项，如 $\\Delta h_2 \\Delta h_3$、$\\Delta h_i \\Delta P$ 以及更高阶的项。AMAT的变化量则近似为\n\\begin{align*}\n\\Delta \\text{AMAT} \\equiv \\text{AMAT}(2B) - \\text{AMAT}(B) \\\\\n\\approx (m_1 - \\Delta h_1) A' - m_1 A \\\\\n\\approx m_1 m_2 m_3 \\Delta P - m_1 \\Delta h_2 \\left( t_3 + m_3 P_{\\text{mem}}(B) \\right) - m_1 m_2 \\Delta h_3 P_{\\text{mem}}(B) - \\Delta h_1 A.\n\\end{align*}\n解释各项符号的意义：项 $m_1 m_2 m_3 \\Delta P$ 是在完整未命中路径上传输更长缓存行所增加的成本，而三个负项则分别量化了L1、L2和L3命中率增加所带来的收益。\n\n当且仅当 $\\Delta \\text{AMAT}  0$ 时，加倍缓存行大小会降低AMAT，这产生不等式\n$$\n\\Delta h_1 A + m_1 \\Delta h_2 \\left( t_3 + m_3 P_{\\text{mem}}(B) \\right) + m_1 m_2 \\Delta h_3 P_{\\text{mem}}(B) > m_1 m_2 m_3 \\Delta P.\n$$\n代入 $\\Delta h_i = c_i (1 - w)$ 和 $\\Delta P = \\beta B$，以及 $P_{\\text{mem}}(B) = \\alpha + \\beta B$，我们得到\n\\begin{align*}\n(1 - w)\\Big[ c_1 A + m_1 c_2 \\left( t_3 + m_3 P_{\\text{mem}}(B) \\right) + m_1 m_2 c_3 P_{\\text{mem}}(B) \\Big]  m_1 m_2 m_3 \\beta B.\n\\end{align*}\n解出 $w$ 得到阈值\n$$\nw^{\\*} = 1 - \\frac{ m_1 m_2 m_3 \\beta B }{ c_1 A + m_1 c_2 \\left( t_3 + m_3 P_{\\text{mem}}(B) \\right) + m_1 m_2 c_3 P_{\\text{mem}}(B) }.\n$$\n这个阈值有如下解释：对于任何浪费加载分数 $w  w^{\\*}$ 的工作负载，更大缓存行带来的命中率收益超过了增加的传输时间，从而使得 $\\text{AMAT}(2B)  \\text{AMAT}(B)$。反之，对于 $w  w^{\\*}$ 的工作负载，额外的传输时间占主导地位，使得 $\\text{AMAT}(2B)  \\text{AMAT}(B)$。顺序工作负载通常具有较小的 $w$，因此低于 $w^{\\*}$；而随机工作负载倾向于具有较大的 $w$，并超过 $w^{\\*}$。\n\n最后，显式展开 $A$ 和 $P_{\\text{mem}}(B)$，并写出 $m_i = 1 - h_i$，得到封闭形式的表达式\n\\begin{align*}\nw^{\\*} = 1 - \\frac{ (1 - h_1)(1 - h_2)(1 - h_3)\\,\\beta B }{ c_1 \\Big[ t_2 + (1 - h_2)\\big( t_3 + (1 - h_3)(\\alpha + \\beta B) \\big) \\Big] + (1 - h_1) c_2 \\Big( t_3 + (1 - h_3)(\\alpha + \\beta B) \\Big) + (1 - h_1)(1 - h_2) c_3 (\\alpha + \\beta B) }.\n\\end{align*}\n这个关于 $w^{\\*}$ 的单一解析表达式满足了所要求的条件，并通过系数 $c_i$ 和未命中率 $m_i = 1 - h_i$ 编码了对命中率和浪费加载的依赖关系。", "answer": "$$\\boxed{1 - \\frac{(1 - h_1)(1 - h_2)(1 - h_3)\\,\\beta B}{ c_1 \\left[ t_2 + (1 - h_2)\\left( t_3 + (1 - h_3)(\\alpha + \\beta B) \\right) \\right] + (1 - h_1) c_2 \\left( t_3 + (1 - h_3)(\\alpha + \\beta B) \\right) + (1 - h_1)(1 - h_2) c_3 (\\alpha + \\beta B) }}$$", "id": "3660631"}]}