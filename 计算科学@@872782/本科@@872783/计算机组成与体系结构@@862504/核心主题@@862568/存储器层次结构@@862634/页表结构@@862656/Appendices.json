{"hands_on_practices": [{"introduction": "理解多级页表的第一步是掌握硬件如何解析虚拟地址。这个练习提供了将一个给定的虚拟地址分解为其组成部分（即各级页表索引和页内偏移量）的实践机会。这是一项基础技能，对于理解地址翻译的全过程至关重要[@problem_id:3663703]。", "problem": "一个计算机系统实现了 $W=48$ 位的虚拟地址 (VA) 和一个 $L$ 级分层页表。每个页表页包含 $E$ 个固定大小的条目，且页的大小为 $S$ 字节。虚拟地址被划分为一个元组 $(i_1,i_2,\\dots,i_L,o)$，其中 $i_1$ 是顶层索引，$i_L$ 是底层索引，$o$ 是页内偏移量。该划分由以下基本事实定义：偏移量宽度为 $s=\\log_2(S)$，每个索引宽度为 $b=\\log_2(E)$；并遵循以下约定：最低有效 $s$ 位是 $o$，其后是 $i_L$、然后是 $i_{L-1}$，依此类推，直至 $i_1$。\n\n在该系统中：\n- 对于标准页，$S=4$ KiB (即 $S=2^{12}$)，有 $L=4$ 个级别，每个页表页包含 $E=512$ 个条目 (即 $E=2^9$) 。\n- 对于巨页，$S=2$ MiB (即 $S=2^{21}$)。巨页映射是一种在第 3 级终止的块映射（也就是说，巨页偏移量占据了原本应是第 4 级索引和偏移量的位置，且地址转换不会下探到第 4 级页表）。巨页映射必须从与 $S$ 对齐的虚拟地址基址开始。\n\n给定一个 $48$ 位的虚拟地址 $\\text{VA}=\\text{0xABCDEF123456}$。请仅使用上述核心定义及其所蕴含的标准掩码和移位操作，在标准页配置（$S=4$ KiB, $L=4$, $E=512$）下，提取第 2 级索引 $i_2$，并以十进制整数形式报告其值。\n\n为了检验你对未对齐巨页的理解，请考虑一个映射单个 $2^{21}$ 字节连续区域的请求，该区域的基虚拟地址 $\\text{VA}$ 未与 $2^{21}$ 字节边界对齐。这样的请求无法由单个巨页条目满足，因为所需的偏移位 $o$ 不会全为零；相反，它将跨越多个较低级别的区域，需要多个条目或回退到标准页。你无需为巨页的情况进行任何计算；提供此信息是为了让你理解掩码和移位方法，以及在不同的 $S$ 和 $L$ 值下 $(i_1,\\dots,i_L,o)$ 的位划分。\n\n请提供 $i_2$ 的十进制数值。无需四舍五入，不涉及单位。请将最终答案表示为单个数字。", "solution": "题目要求从一个给定的 $48$ 位虚拟地址中提取第 2 级索引 $i_2$。虚拟地址的结构由标准页配置下的内存管理系统参数决定。\n\n首先，我们根据题目陈述确定标准页配置的参数：\n-   虚拟地址宽度：$W = 48$ 位。\n-   页表级别数：$L = 4$。\n-   页大小：$S = 4$ KiB。因为 $1$ KiB 是 $2^{10}$ 字节，所以 $S = 4 \\times 2^{10} = 2^2 \\times 2^{10} = 2^{12}$ 字节。\n-   每个页表页的条目数：$E = 512$。可以表示为 2 的幂：$E = 2^9$。\n\n接下来，我们确定虚拟地址中不同字段的宽度。题目定义：\n-   页内偏移量字段 $o$ 的宽度为 $s = \\log_2(S)$。\n-   每个页表索引字段 $i_k$ 的宽度为 $b = \\log_2(E)$。\n\n使用给定的值：\n-   偏移量宽度：$s = \\log_2(2^{12}) = 12$ 位。\n-   索引宽度：$b = \\log_2(2^9) = 9$ 位。\n\n由于 $L=4$，虚拟地址 $\\text{VA}$ 被划分为一个元组 $(i_1, i_2, i_3, i_4, o)$。题目规定，位字段的排列方式是，偏移量 $o$ 位于最低有效位，其后是索引 $i_L, i_{L-1}, \\dots, i_1$。在 $L=4$ 的情况下，从最高有效位 (MSB) 到最低有效位 (LSB) 的结构是 $(i_1, i_2, i_3, i_4, o)$。\n\n我们来验证总宽度。有 $L=4$ 个索引字段，每个宽度为 $b=9$ 位，还有一个宽度为 $s=12$ 位的偏移量字段。\n总宽度 $= L \\times b + s = 4 \\times 9 + 12 = 36 + 12 = 48$ 位。\n这与给定的虚拟地址宽度 $W=48$ 相匹配，因此整个 $48$ 位地址空间都被此划分方案所利用。\n\n现在我们可以确定每个字段的精确位范围，将位从 $0$ (LSB) 编号到 $47$ (MSB)：\n-   偏移量 $o$：占据位 $0$ 到 $11$。范围：$[11:0]$。宽度：$12$ 位。\n-   索引 $i_4$：占据位 $12$ 到 $20$。范围：$[20:12]$。宽度：$9$ 位。\n-   索引 $i_3$：占据位 $21$ 到 $29$。范围：$[29:21]$。宽度：$9$ 位。\n-   索引 $i_2$：占据位 $30$ 到 $38$。范围：$[38:30]$。宽度：$9$ 位。\n-   索引 $i_1$：占据位 $39$ 到 $47$。范围：$[47:39]$。宽度：$9$ 位。\n\n题目要求的是第 2 级索引 $i_2$ 的值，它对应虚拟地址的第 $38$ 位到第 $30$ 位。\n\n给定的虚拟地址是 $\\text{VA} = \\text{0xABCDEF123456}$。为了提取所需的位，我们首先将此十六进制值转换为其 $48$ 位二进制表示。每个十六进制数字对应 $4$ 位：\n-   $\\text{A} = 1010_2$\n-   $\\text{B} = 1011_2$\n-   $\\text{C} = 1100_2$\n-   $\\text{D} = 1101_2$\n-   $\\text{E} = 1110_2$\n-   $\\text{F} = 1111_2$\n-   $\\text{1} = 0001_2$\n-   $\\text{2} = 0010_2$\n-   $\\text{3} = 0011_2$\n-   $\\text{4} = 0100_2$\n-   $\\text{5} = 0101_2$\n-   $\\text{6} = 0110_2$\n\n完整的二进制地址是：\n$\\text{VA} = \\underbrace{1010}_{\\text{A}} \\underbrace{1011}_{\\text{B}} \\underbrace{1100}_{\\text{C}} \\underbrace{1101}_{\\text{D}} \\underbrace{1110}_{\\text{E}} \\underbrace{1111}_{\\text{F}} \\underbrace{0001}_{1} \\underbrace{0010}_{2} \\underbrace{0011}_{3} \\underbrace{0100}_{4} \\underbrace{0101}_{5} \\underbrace{0110}_{6}$\n位位置（从左到右）：$47, 46, \\dots, 1, 0$。\n\n$i_2$ 字段由位 $[38:30]$ 组成。我们在 $\\text{VA}$ 的二进制表示中定位这些位：\n-   十六进制数字 'C' 对应于位 $[39:36]$：$1100_2$。因此，位 $39=1$，位 $38=1$，位 $37=0$，位 $36=0$。\n-   十六进制数字 'D' 对应于位 $[35:32]$：$1101_2$。因此，位 $35=1$，位 $34=1$，位 $33=0$，位 $32=1$。\n-   十六进制数字 'E' 对应于位 $[31:28]$：$1110_2$。因此，位 $31=1$，位 $30=1$，位 $29=1$，位 $28=0$。\n\n我们从第 $38$ 位到第 $30$ 位收集 $i_2$ 的位：\n-   第 $38$ 位：来自 'C'，第二位是 $1$。\n-   第 $37$ 位：来自 'C'，第三位是 $0$。\n-   第 $36$ 位：来自 'C'，第四位是 $0$。\n-   位 $[35:32]$：这些是 'D' 的位，即 $1101_2$。\n-   第 $31$ 位：来自 'E'，第一位是 $1$。\n-   第 $30$ 位：来自 'E'，第二位是 $1$。\n\n从 MSB 到 LSB（$b_{38}$ 到 $b_{30}$）组合成 $i_2$ 的 $9$ 位二进制值：\n$i_2 = b_{38}b_{37}b_{36}b_{35}b_{34}b_{33}b_{32}b_{31}b_{30} = 100110111_2$。\n\n最后，我们将这个二进制数转换为其十进制整数值：\n$i_2 = 1 \\cdot 2^8 + 0 \\cdot 2^7 + 0 \\cdot 2^6 + 1 \\cdot 2^5 + 1 \\cdot 2^4 + 0 \\cdot 2^3 + 1 \\cdot 2^2 + 1 \\cdot 2^1 + 1 \\cdot 2^0$\n$i_2 = 1 \\cdot 256 + 0 + 0 + 1 \\cdot 32 + 1 \\cdot 16 + 0 + 1 \\cdot 4 + 1 \\cdot 2 + 1 \\cdot 1$\n$i_2 = 256 + 32 + 16 + 4 + 2 + 1$\n$i_2 = 256 + 48 + 7$\n$i_2 = 311$\n\n第 2 级索引 $i_2$ 的值为 $311$。\n这也可以通过应用掩码和移位操作来找到。$i_2$ 的值可以通过 $(\\text{VA} \\gg 30) \\ \\text{AND} \\ (2^9 - 1)$ 获得。\n$\\text{VA} \\gg 30 = \\text{0xABCDEF123456} \\gg 30 = \\text{0x2AF37}$。\n$2^9 - 1 = 511 = \\text{0x1FF}$。\n$i_2 = \\text{0x2AF37} \\ \\text{AND} \\ \\text{0x1FF} = \\text{0x137}$。\n将 $\\text{0x137}$ 转换为十进制：$1 \\cdot 16^2 + 3 \\cdot 16^1 + 7 \\cdot 16^0 = 256 + 48 + 7 = 311$。", "answer": "$$\\boxed{311}$$", "id": "3663703"}, {"introduction": "页表是实现虚拟内存的关键，但它们本身也需要占用物理内存，这种开销是系统设计中必须考虑的因素。这个练习将重点从单次地址翻译转移到页表结构整体的内存占用上。你需要为一个实际的内存分配场景计算页表所带来的额外开销，从而更深入地理解虚拟地址空间使用与物理内存成本之间的权衡[@problem_id:3667089]。", "problem": "考虑一个由操作系统（OS）管理的进程，该进程使用一个$L$级分层页表。每个页表节点在物理内存中存储为大小为$p$字节的一整页，并包含大小为$e$字节的固定大小的表项。因此，每个节点有$m = \\frac{p}{e}$个表项。一个$L$级层次结构将虚拟地址划分为$L$个索引字段（每级一个）和一个偏移量。当且仅当一个$\\ell$级节点的至少一个表项被用来引用$\\ell+1$级的子节点（或者在叶子级别，用于映射一个页帧）时，该节点才会被分配。假设此地址空间中没有预先存在的分配。\n\n给定一个具体且现实的配置：\n- 一个3级页表（$L = 3$），具有39位的虚拟地址空间，划分为每级9位的索引和一个12位的页偏移。\n- 页面大小$p = 4\\ \\mathrm{KiB} = 4096$字节，表项大小$e = 8$字节，因此每级每个节点有$m = \\frac{p}{e} = 512$个表项。\n- 该进程分配了$K = 1200$个大小为$p$的连续虚拟页面，起始虚拟地址与$m \\cdot p$字节（即$2\\ \\mathrm{MiB}$边界）对齐，并且整个分配位于单个$m^{2} \\cdot p$字节的区域（即$1\\ \\mathrm{GiB}$区域）内。这保证了分配不会跨越2级页表的覆盖范围边界。\n\n仅根据上述定义和关于分层页表的公认事实，首先推断出此次分配中页表结构的总内存开销$S$（以字节为单位）如何取决于每级分配的节点数以及常量$p$和$e$。然后，针对所描述的配置和分配计算$S$的值。\n\n最终答案以字节为单位，表示为一个精确整数（无需四舍五入）。", "solution": "总内存开销$S$是所有已分配的页表节点所消耗的内存总和。每个节点，无论其级别如何，都恰好占用一页物理内存，大小为$p$。\n\n设$N_{\\ell}$为$\\ell$级已分配的页表节点数。对于给定的$L=3$级层次结构，已分配节点的总数为$N_{total} = N_1 + N_2 + N_3$。\n总开销为：\n$$S = N_{total} \\times p = (N_1 + N_2 + N_3) \\times p$$\n我们的任务是确定针对指定内存分配的$N_1$、$N_2$和$N_3$的值。\n\n**1. 3级节点数（$N_3$）**\n3级节点是层次结构中的最终页表，其表项直接指向物理页帧。\n- 每个3级节点是一个大小为$p = 4096$字节的页面，包含$m = \\frac{p}{e} = \\frac{4096}{8} = 512$个表项。\n- 每个表项映射一个虚拟页面，因此一个3级节点可以映射一个包含512个虚拟页面的连续块。\n- 该进程分配$K = 1200$个连续的虚拟页面。\n- 分配从一个$m \\cdot p = 512 \\times 4096 = 2 \\text{ MiB}$的边界开始。一个2级页表条目覆盖的范围是$m \\cdot p = 2\\text{ MiB}$。一个3级页表条目覆盖$p=4\\text{ KiB}$。分配起始地址与一个2 MiB边界对齐，而一个3级页表本身就覆盖2 MiB。因此，分配起始地址是与3级页表覆盖范围的边界对齐的。\n- 我们可以通过将待映射的页面总数除以每个3级节点可映射的页面数，然后对结果取上整，来计算所需的3级节点数。\n$$N_3 = \\left\\lceil \\frac{K}{m} \\right\\rceil = \\left\\lceil \\frac{1200}{512} \\right\\rceil = \\lceil 2.34375 \\rceil = 3$$\n所以，需要3个3级页表节点。前两个将被完全利用，第三个将被部分利用（映射$1200 - 2 \\times 512 = 1200 - 1024 = 176$个页面）。\n\n**2. 2级节点数（$N_2$）**\n2级节点包含指向3级节点的表项。\n- 我们需要3个3级节点。由于这1200个页面是连续分配的，这3个3级节点也将对应虚拟地址空间中的连续块。\n- 指向这3个3级节点的表项将是单个2级节点内的连续表项。\n- 单个2级节点包含$m=512$个表项。由于我们只需要指向3个3级节点（$3  512$），所有需要的表项都可以容纳在单个2级节点内。\n- 问题约束保证了整个分配位于单个$m^2 \\cdot p$区域内。一个1级表项指向一个2级节点，而这个2级节点覆盖的虚拟地址范围大小为$m \\times (\\text{一个3级节点的覆盖范围}) = m \\times (m \\cdot p) = m^2 \\cdot p$。该约束保证了所有分配的页面都落在由单个2级节点管理的地址范围内。因此，只需要分配一个2级节点。\n$$N_2 = 1$$\n\n**3. 1级节点数（$N_1$）**\n1级节点是进程地址空间的页表层次结构的根。\n- 对于任何要映射的内存，层次结构的根都必须存在。\n- 我们需要一个2级节点，它必须由1级节点中的一个表项指向。\n- 根据分配规则，由于1级节点中的一个表项被使用，1级节点本身必须被分配。每个具有非空地址空间的进程都至少需要根页表节点。\n$$N_1 = 1$$\n\n**4. 总开销计算（$S$）**\n已分配节点的总数是各级节点数之和：\n$$N_{total} = N_1 + N_2 + N_3 = 1 + 1 + 3 = 5$$\n总内存开销是节点总数乘以单个节点的大小（即一页的大小）：\n$$S = N_{total} \\times p = 5 \\times 4096$$\n$$S = 20480 \\text{ 字节}$$\n此次特定分配中页表结构的总内存开销为$20480$字节。", "answer": "$$\n\\boxed{20480}\n$$", "id": "3667089"}, {"introduction": "现代处理器广泛使用大页面（huge pages）作为一项关键优化，以减少翻译后备缓冲器（TLB）的压力和页表自身的内存开销。这个练习探讨了内存管理的动态特性，特别是在操作系统需要将一个大页面拆分成多个小页面以实现更精细权限控制的场景。通过分析这种“拆分”操作对页表结构产生的“级联分配”效应，你将能更深刻地理解现代内存管理系统中的复杂性和优化策略[@problem_id:3663768]。", "problem": "一个系统使用四级分层页表，各级从顶层到底层分别命名为 Page Map Level 4 (PML4)、Page Directory Pointer Table (PDPT)、Page Directory (PD) 和 Page Table (PT)。每个页表存储在一个大小为 $P$ 的物理页中，每个页表包含 $N$ 个条目，每个非叶节点条目指向下一级的一个页表。基本页面大小为 $P$，且该体系结构支持大页（huge page），大页通过在中间级别（自底向上第3级的 PDPT 和自底向上第2级的 PD）的页表条目（PTE）实现。一个大页 PTE 在某个级别上映射一个与该级别覆盖范围相对应的连续区域，而不是指向一个更低级别的页表。操作系统使用紧凑策略：除非在更高级别条目覆盖的区域内需要更细粒度的映射，否则不会分配更低级别的页表。\n\n假设有 $L=4$ 个级别，$N=512$，且 $P=4\\,\\mathrm{KiB}$。初始状态下，两个相邻的 $1\\,\\mathrm{GiB}$ 虚拟区域分别由一个位于 PDPT 级别（自底向上第3级）的大页 PTE 进行映射，占用了两个 PDPT 条目，且在这些条目下没有分配 PD 或 PT 页。\n\n一次软件更新需要在子范围上更改保护权限，同时在其他地方保持尽可能紧凑的映射：\n- 在第一个 $1\\,\\mathrm{GiB}$ 区域（称为区域 A）中，前 $x_A=5\\,\\mathrm{MiB}+8\\,\\mathrm{KiB}$ 的部分必须被拆分到基本页面级别（PT 级别），以应用不同的权限。\n- 在第二个 $1\\,\\mathrm{GiB}$ 区域（区域 B）中，必须拆分一组基本页面，使它们恰好位于该 $1\\,\\mathrm{GiB}$ 区域内的 $u_B=9$ 个不同的 $2\\,\\mathrm{MiB}$ 子范围中；只有这些子范围需要基本页面粒度，该区域的所有其他部分应保持在体系结构和紧凑策略所允许的最大粒度上进行映射。\n\n任务：\n1) 仅使用上述给出的分层页表的基本定义，推导在何种明确条件下，拆分某个级别 $\\ell$ 的大页映射会触发更低级别页表的级联分配。你的条件应根据转换路径上是否存在一个祖先级别的大页 PTE 以及需要更细粒度的不同子子范围的数量来表述。\n2) 在紧凑策略和给定参数下，计算为在区域 A 和 B 中实施这两项更改而必须分配的额外页表内存页的总数。只计算新分配的页表页；不计算数据页。将最终答案表示为一个不带单位的整数。", "solution": "首先，我们确定各级页表条目的地址空间覆盖范围：\n- PT 条目（级别 1）：映射一个基本页面，大小为 $P = 4\\,\\mathrm{KiB}$。\n- PD 条目（级别 2）：指向一个 PT，或作为一个 $2\\,\\mathrm{MiB}$ 的大页。一个完整的 PD 覆盖 $N \\times (\\text{PT 覆盖范围}) = 512 \\times (512 \\times 4\\,\\mathrm{KiB})$，但一个 PD 条目覆盖的范围是 $512 \\times 4\\,\\mathrm{KiB} = 2\\,\\mathrm{MiB}$。\n- PDPT 条目（级别 3）：指向一个 PD，或作为一个 $1\\,\\mathrm{GiB}$ 的大页。一个完整的 PDPT 覆盖 $512 \\times 2\\,\\mathrm{MiB} = 1\\,\\mathrm{GiB}$。\n\n**1) 级联分配的条件**\n\n当一个级别 $\\ell$ 的大页映射被拆分时，意味着原来由单个大页PTE覆盖的区域现在需要更细粒度的映射。这必然要求分配一个级别 $\\ell-1$ 的页表，并将原大页PTE替换为指向这个新页表的指针。\n“级联分配”发生在需要为新创建的级别 $\\ell-1$ 页表中的某些条目进一步分配级别 $\\ell-2$ 页表时。\n条件：拆分一个级别 $\\ell$ 的大页后，如果需要细粒度映射的地址范围与级别 $\\ell-1$ 页表中某个条目所对应的子区域相交，并且该子区域自身无法被一个级别 $\\ell-1$ 的大页PTE完整覆盖（因为该子区域内仍有部分需要更细的粒度），那么该级别 $\\ell-1$ 的条目就必须指向一个级别 $\\ell-2$ 的页表。这种情况的发生，就构成了级联分配。需要分配的级别 $\\ell-2$ 页表的数量，取决于有多少个不同的级别 $\\ell-1$ 子区域受到了这种影响。\n\n**2) 额外分配页面的计算**\n\n我们计算为区域 A 和 B 的修改所需的新页表页总数。\n\n**区域 A：**\n需要将一个 $1\\,\\mathrm{GiB}$ 区域的前 $x_A = 5\\,\\mathrm{MiB} + 8\\,\\mathrm{KiB}$ 拆分到基本页面级别。\n1.  **拆分 1 GiB 大页**：初始的 $1\\,\\mathrm{GiB}$ 大页PTE（在PDPT中）必须被拆分。它被替换为一个指向新页表（一个PD）的指针。这需要分配 **1 个 PD 页**。\n2.  **分析 PD**：这个新的 PD 有 512 个条目，每个条目覆盖一个 $2\\,\\mathrm{MiB}$ 的区域。我们需要确定哪些 $2\\,\\mathrm{MiB}$ 区域受到 $5\\,\\mathrm{MiB} + 8\\,\\mathrm{KiB}$ 范围的影响。\n    -   第 1 个 PD 条目覆盖 `[0, 2 MiB)`。受影响，需要拆分。\n    -   第 2 个 PD 条目覆盖 `[2 MiB, 4 MiB)`。受影响，需要拆分。\n    -   第 3 个 PD 条目覆盖 `[4 MiB, 6 MiB)`。受影响，需要拆分。\n    这 3 个 PD 条目不能再是大页，必须指向各自的页表（PT）。因此需要分配 **3 个 PT 页**。\n3.  **其他条目**：剩下的 $512 - 3 = 509$ 个 PD 条目覆盖的区域未受影响。根据紧凑策略，它们将成为 $2\\,\\mathrm{MiB}$ 的大页PTE，无需分配更多页表。\n4.  **区域 A 总计**：$1 \\text{ (PD)} + 3 \\text{ (PTs)} = 4$ 个额外页面。\n\n**区域 B：**\n在一个 $1\\,\\mathrm{GiB}$ 区域内，位于 $u_B=9$ 个不同的 $2\\,\\mathrm{MiB}$ 子区域中的页面需要基本页面粒度。\n1.  **拆分 1 GiB 大页**：与区域 A 类似，必须拆分 $1\\,\\mathrm{GiB}$ 大页。这需要分配 **1 个 PD 页**。\n2.  **分析 PD**：问题明确指出，恰好有 9 个不同的 $2\\,\\mathrm{MiB}$ 子区域需要细粒度映射。每个这样的子区域对应新 PD 中的一个条目。\n    -   这 9 个 PD 条目中的每一个都必须指向一个 PT，以提供基本页面粒度。这需要分配 **9 个 PT 页**。\n3.  **其他条目**：剩下的 $512 - 9 = 503$ 个 PD 条目将保持为 $2\\,\\mathrm{MiB}$ 的大页PTE。\n4.  **区域 B 总计**：$1 \\text{ (PD)} + 9 \\text{ (PTs)} = 10$ 个额外页面。\n\n**额外页面总数：**\n总数 = (区域 A 的页数) + (区域 B 的页数) = $4 + 10 = 14$。", "answer": "$$\n\\boxed{14}\n$$", "id": "3663768"}]}