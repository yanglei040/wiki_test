{"hands_on_practices": [{"introduction": "结构性冒险通常源于指令需求与可用硬件资源之间的根本性不匹配。第一个练习 [@problem_id:3682639] 提供了一个经典的例子，其中寄存器文件读取端口数量不足，从而形成了一个决定整个流水线性能的瓶颈。通过分析这个简单的案例，你将学会如何精确定位限制指令吞吐率的“最薄弱环节”。", "problem": "考虑一个中央处理器 (CPU) 中的标量五级流水线，其阶段如下：取指令 (IF)、指令译码与寄存器读取 (ID)、执行 (EX)、访存 (MEM) 和写回 (WB)。在没有冒险的情况下，每个阶段每条指令恰好占用 $1$ 个时钟周期，并且流水线每个周期最多发射一条指令。寄存器文件每个周期最多可支持 $R$ 个读端口和 $W$ 个写端口。一条三地址指令需要读取 $3$ 个源寄存器并写入 $1$ 个目标寄存器。读取操作仅在ID阶段执行，写入操作仅在WB阶段执行。寄存器文件不能在同一个周期内执行超过 $R$ 次读取或超过 $W$ 次写入，并且在指令所需的所有寄存器读取完成之前，ID阶段不能前进到EX阶段。冒险的解决完全通过停顿来执行：一个无法在当前周期完成其所需工作的阶段会保持其指令，并阻止上游阶段前进。\n\n考虑一个由这类三地址指令组成的长的稳态序列，其中没有数据相关、没有控制冒险，且MEM阶段没有内存操作，因此唯一潜在的冒险是由寄存器文件端口引起的结构冒险。设 $R=2$ 且 $W=1$。在符合给定约束的最优调度下，该流水线的稳态平均每指令周期数 (CPI) 是多少？\n\n将您的最终答案表示为单个实数。无需四舍五入。", "solution": "基本定义如下。当一个给定周期内所需的硬件资源超过其可用容量时，就会发生结构冒险。在流水线CPU中，如果一个阶段由于资源不足而无法完成其所需的操作，该阶段就必须停顿，这会阻止上游阶段前进并可能降低吞吐率。对于一个各级平衡且无冒险的标量流水线，其稳态下的平均每指令周期数 (CPI) 为 $1$。如果某个阶段由于资源限制而每条指令需要超过 $1$ 个周期，那么该阶段就成为吞吐率瓶颈：流水线发射新指令的速度不能快于该阶段接收指令的速度，且稳态CPI等于瓶颈阶段每条指令所需的周期数。\n\n将这些原则应用于给定场景。每条三地址指令在指令译码与寄存器读取 (ID) 阶段需要 $3$ 次寄存器读取，在写回 (WB) 阶段需要 $1$ 次寄存器写入。寄存器文件有 $R=2$ 个读端口和 $W=1$ 个写端口。对于一个单发射流水线，当 $W=1$ 时，WB阶段每个周期最多可以处理 $1$ 次写入，但由于在任何时候WB阶段只有一条指令（单发射），所以对于这种指令组合，WB阶段不是瓶颈。关键资源是ID阶段的读端口。\n\n在ID阶段，每个周期最多可以读取 $R=2$ 个寄存器。一条三地址指令需要 $3$ 次读取，这无法在单个周期内完成，因为 $3 > R=2$。因此，ID阶段必须将该指令保留多个周期。具体来说，在第一个ID周期，指令可以读取 $2$ 个操作数，在第二个ID周期，它可以读取剩下的 $1$ 个操作数。因此，每条指令的ID阶段占用时间为\n$$\n\\left\\lceil \\frac{3}{R} \\right\\rceil = \\left\\lceil \\frac{3}{2} \\right\\rceil = 2 \\text{ cycles}.\n$$\n由于冒险的解决完全通过停顿来执行，并且流水线是单发射的，ID阶段将一条指令保持 $2$ 个周期会阻止下一条指令进入ID阶段，直到这些读取操作完成。相对于ID阶段本可以在 $1$ 个周期内完成的无冒险情况，这给每条指令带来了 $1$ 个周期的停顿。\n\n我们可以通过列出一条指令（记为 $I_1$）的调度来明确说明这一点：\n- 周期 $1$：$I_1$ 在 IF 阶段。\n- 周期 $2$：$I_1$ 在 ID 阶段 (读取 $2$ 个寄存器)。\n- 周期 $3$：$I_1$ 在 ID 阶段 (读取 $1$ 个寄存器，完成读取)。\n- 周期 $4$：$I_1$ 在 EX 阶段。\n- 周期 $5$：$I_1$ 在 MEM 阶段。\n- 周期 $6$：$I_1$ 在 WB 阶段 (执行 $1$ 次写入，这在 $W=1$ 的限制内)。\n\n对于下一条指令 $I_2$，它最早可以在周期 $3$ 之后进入ID阶段，因为ID阶段在周期 $2$ 和 $3$ 被 $I_1$ 占用。因此，即使在由这类指令组成的长序列的稳态下，且没有其他冒险，ID阶段处理指令的速率也是每 $2$ 个周期 $1$ 条指令。由于所有其他阶段都是 $1$ 个周期，ID阶段是限制吞吐率的瓶颈。\n\n因此，稳态吞吐率为每周期 $0.5$ 条指令，稳态平均每指令周期数是\n$$\n\\mathrm{CPI} = 2.\n$$\n无需四舍五入，因为这是一个从整数资源约束和阶段占用时间推导出的精确值。", "answer": "$$\\boxed{2}$$", "id": "3682639"}, {"introduction": "在现代复杂处理器中，流水线停顿的根本原因并不总是显而易见的。这个练习 [@problem_id:3682664] 旨在挑战你超越表面现象（例如两条指令使用同一个寄存器），去正确地区分资源冲突（即结构性冒险）与真正的数据依赖。这项技能对于准确诊断和解决实际系统中的性能问题至关重要。", "problem": "考虑一个执行整数和访存指令的顺序双发射流水线。该机器具有以下特性：\n\n- 前端每个周期最多可以取指和译码 $2$ 条指令，并尝试按程序顺序将它们作为一对进行发射。\n- 有一个地址生成单元 (AGU) 资源。任何加载或存储指令在执行有效地址计算时都需要 AGU 整整 $1$ 个周期。AGU 在同一周期内不能共享，因此每个周期最多只能有一条访存指令使用 AGU。\n- 算术逻辑单元 (ALU) 执行整数算术/逻辑指令，每个周期最多执行 $1$ 条 ALU 指令。ALU 指令不使用 AGU。\n- 加载和存储没有缓存未命中；忽略内存延迟，只需考虑加载和存储各需要一个 AGU 使用周期来计算其有效地址。当检测到结构冲突时，发射逻辑会停顿一对指令中的第二条指令，让第一条指令继续执行。\n- 冒险检测是标准的：仅当存在对一个值的真相关（写后读）时，才存在数据冒险。在没有中间写入的情况下，连续两条指令读取同一个寄存器不构成数据冒险。\n\n通过对两个连续的访存操作使用相同的基址寄存器，构造一个看起来是数据冒险但实际上由于共享 AGU 而成为结构冒险的指令序列。然后，针对下面的特定循环体，解释这种区别，并量化纯粹由 AGU 争用引起的停顿。\n\n循环体（一次迭代），以寄存器传输风格编写：\n\n- 指令 $1$：load $R4 \\leftarrow \\mathrm{Mem}[R1 + 0]$.\n- 指令 $2$：store $\\mathrm{Mem}[R1 + 8] \\leftarrow R5$.\n- 指令 $3$：integer add $R6 \\leftarrow R6 + R9$.\n- 指令 $4$：integer subtract $R10 \\leftarrow R11 - R12$.\n\n假设前端在迭代的第一个周期尝试同时发射指令 $1$ 和 $2$，然后按程序顺序继续，在每个周期尝试填满两个发射槽，但受限于上述资源约束。\n\n任务：\n\n1. 使用结构冒险和数据冒险的基本定义，论证为何指令 $1$ 和 $2$ 之间的交互是结构冒险而不是数据冒险。\n2. 确定每次循环迭代中，仅由共享 AGU 引起的停顿周期数。\n3. 对于该循环体的 $N = 100$ 次迭代，计算由 AGU 争用引起的总停顿周期数。将最终结果表示为停顿周期数。无需四舍五入。", "solution": "### 任务1：冒险类型的论证\n**数据冒险**（具体为写后读，RAW）发生于一条指令需要读取另一条先前指令写入结果的情况。\n- 指令1 (`load R4 - Mem[R1 + 0]`) 写入寄存器 `R4`。\n- 指令2 (`store Mem[R1 + 8] - R5`) 读取寄存器 `R1` 和 `R5`，但它不读取 `R4`。\n因此，指令2不依赖于指令1的结果，它们之间不存在数据冒险。两条指令都读取 `R1` 只是输入复用，不构成冒险。\n\n**结构冒险**发生于两条指令在同一周期内竞争同一个硬件资源。\n- 指令1（`load`）和指令2（`store`）都是访存指令，它们都需要地址生成单元（AGU）来计算有效地址。\n- 处理器尝试在同一周期发射这两条指令，但只有一个AGU。\n由于两条指令对单一AGU资源的竞争，这构成了结构冒险的经典定义。\n\n### 任务2：每次迭代中由AGU争用引起的停顿周期\n流水线按顺序处理指令对 `(I1, I2)` 和 `(I3, I4)`。\n\n- **周期 1**: 尝试发射 `(I1, I2)`。\n  - `I1` (load) 需要 AGU。\n  - `I2` (store) 也需要 AGU。\n  - 发生结构冲突。根据策略，`I1` 发射，`I2` 停顿。该周期只发射了1条指令。\n- **周期 2**: 发射被停顿的 `I2`。\n  - `I2` 发射并使用 AGU。该周期只发射了1条指令。\n理想情况下，指令对 `(I1, I2)` 可以在1个周期内发射。由于AGU冲突，现在需要2个周期。因此，由AGU争用引起的停顿为 $2 - 1 = 1$ 个周期。\n\n（作为补充分析，指令对 `(I3, I4)` 也会因为竞争唯一的ALU而产生1个周期的停顿，但问题只关注AGU争用。）\n\n### 任务3：100次迭代的总停顿周期\n每次迭代的执行模式和资源冲突是相同的。\n- 每次迭代由AGU争用引起的停顿 = 1 周期。\n- 总迭代次数 N = 100。\n\n因此，由AGU争用引起的总停顿周期为：\n$1 \\text{ 周期/迭代} \\times 100 \\text{ 迭代} = 100 \\text{ 周期}$。", "answer": "$$\n\\boxed{100}\n$$", "id": "3682664"}, {"introduction": "单个流水线阶段会遇到资源限制，但当多个处理单元争用总线等共享系统资源时，结构性冒险也会在更大范围内发生。这个练习 [@problem_id:3682652] 引入了一个更高级的场景，它应用排队论的原理来建模和量化共享写回总线上的竞争效应。这展示了一种强大的分析方法，用于预测系统级的性能指标，例如停顿概率和平均等待时间。", "problem": "$M$ 个相同的流水线使用一个共享的 $64$ 位写回数据总线。每个流水线在完成一次存储或脏驱逐时都可能生成一个写回请求。在每个周期中，每个流水线以概率 $\\alpha$ 独立地产生一个写回请求，这些请求被送入一个单一的总线仲裁器队列，仲裁器以先到先服务 (FCFS) 的顺序处理这些请求。该总线每个周期可以传输 $B$ 个对齐的 $64$ 位字，每次写回平均传输 $s$ 个对齐的 $64$ 位字。如果一个写回请求到达时总线正忙，发起该请求的流水线的写回阶段将暂停，直到服务开始。\n\n假设以下参数：$M = 16$，$\\alpha = 0.01$，$B = 2$（字/周期），以及 $s = 8$（字/写回）。将跨流水线的聚合到达过程视为足够稀疏，可用每个周期的泊松过程来近似，并将每次写回的服务时间视为在其均值处是确定性的。从结构性冒险作为共享资源冲突的基本定义出发，并使用适用于计算机系统中内存和互连仲裁的、经过充分检验的排队论结果，推导出一个新到达的写回请求发现总线繁忙的竞争概率，以及一个写回请求在开始服务前所经历的期望暂停时间（以周期为单位）。\n\n请以无量纲小数的形式提供竞争概率的最终数值答案，并以周期为单位提供暂停时间。将两个量都四舍五入到四位有效数字。暂停时间以周期表示。", "solution": "该问题中的结构性冒险——多个流水线对共享写回总线的竞争——可以使用排队论进行建模和量化。我们将此系统建模为一个M/D/1排队（马尔可夫到达，确定性服务时间，单个服务台），并按以下步骤进行分析。\n\n**1. 计算到达率 ($\\lambda$)**\n有 $M = 16$ 个独立的流水线，每个流水线在每个周期以概率 $\\alpha = 0.01$ 生成一个请求。问题陈述要求将聚合到达过程近似为泊松过程。平均到达率 $\\lambda$ 是每个周期的期望总请求数。\n$$ \\lambda = M \\times \\alpha $$\n代入给定值：\n$$ \\lambda = 16 \\times 0.01 = 0.16 \\text{ 请求/周期} $$\n\n**2. 计算服务时间 ($T_s$)**\n每次写回请求涉及传输 $s = 8$ 个字。总线每个周期可以传输 $B = 2$ 个字。问题指明服务时间在其均值处是确定性的。服务时间 $T_s$ 是传输单个请求的所有字所需的时间。\n$$ T_s = \\frac{s}{B} $$\n代入给定值：\n$$ T_s = \\frac{8 \\text{ 字}}{2 \\text{ 字/周期}} = 4 \\text{ 周期/请求} $$\n此服务时间对所有请求都是恒定的。\n\n**3. 计算服务台利用率 ($\\rho$)**\n服务台利用率 $\\rho$ 是总线繁忙的时间比例。它是到达率和平均服务时间的乘积。\n$$ \\rho = \\lambda \\times T_s $$\n代入计算出的值：\n$$ \\rho = 0.16 \\text{ 请求/周期} \\times 4 \\text{ 周期/请求} = 0.64 $$\n由于 $\\rho  1$，队列是稳定的，并将达到稳态。\n\n**4. 计算竞争概率 ($P_{\\text{busy}}$)**\n竞争概率是一个新到达的写回请求发现总线繁忙的概率。对于泊松到达的系统，PASTA（泊松到达看到时间平均）属性适用。该属性指出，到达时发现系统处于某一给定状态的到达比例，等于系统处于该状态的长期时间比例。因此，一个到达的请求发现总线繁忙的概率，等于总线繁忙的稳态概率，即服务台利用率 $\\rho$。\n$$ P_{\\text{busy}} = \\rho = 0.64 $$\n\n**5. 计算期望暂停时间 ($E[T_q]$)**\n暂停时间是一个请求在服务开始前在队列中等待的时间。我们需要求出在队列中的期望等待时间 $E[T_q]$。对于一个通用的 M/G/1 排队（马尔可夫到达、一般服务分布、1个服务台），平均等待时间的 Pollaczek-Khinchine 公式为：\n$$ E[T_q] = \\frac{\\lambda E[T_s^2]}{2(1-\\rho)} $$\n其中 $E[T_s^2]$ 是服务时间分布的二阶矩。对于我们的 M/D/1 情况，服务时间是确定性的，即 $T_s = 4$ 个周期。一个确定性值的方差为 $0$。因此，二阶矩为：\n$$ E[T_s^2] = \\text{Var}(T_s) + (E[T_s])^2 = 0 + T_s^2 = T_s^2 $$\n将此代入 $E[T_q]$ 的公式，得到 M/D/1 排队的特定结果：\n$$ E[T_q] = \\frac{\\lambda T_s^2}{2(1-\\rho)} $$\n现在，我们代入数值：$\\lambda = 0.16$，$T_s = 4$，以及 $\\rho = 0.64$。\n$$ E[T_q] = \\frac{0.16 \\times 4^2}{2(1 - 0.64)} = \\frac{0.16 \\times 16}{2 \\times 0.36} = \\frac{2.56}{0.72} $$\n精确值为：\n$$ E[T_q] = \\frac{256}{72} = \\frac{32}{9} \\approx 3.555... \\text{ 周期} $$\n\n**6. 最终数值答案**\n问题要求答案四舍五入到四位有效数字。\n- 竞争概率：$P_{\\text{busy}} = 0.64$。保留四位有效数字，即 $0.6400$。\n- 期望暂停时间：$E[T_q] = \\frac{32}{9} \\approx 3.5555...$ 周期。四舍五入到四位有效数字，即 $3.556$ 周期。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n0.6400  3.556\n\\end{pmatrix}\n}\n$$", "id": "3682652"}]}