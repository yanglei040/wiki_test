{"hands_on_practices": [{"introduction": "哈佛架构的主要优势在于其能够同时进行指令提取和数据访问。这个练习提供了一个量化框架来评估这种并行性。通过推导和计算“重叠效率”，你将探索指令和数据总线的相对带宽如何直接影响处理器最大化并发内存操作的能力。[@problem_id:3646906]", "problem": "处理器采用哈佛架构，这意味着指令路径和数据路径在物理上是分离的。具体来说，它有一条指令（I）总线和一条数据（D）总线，它们可以在一个共同的时钟下同时运行。考虑执行一条内存相关指令，该指令需要通过指令（I）总线获取大小为 $s_{i}$ 字节的指令，并在其执行期间，通过数据（D）总线执行一次大小为 $s_{d}$ 字节的数据内存传输。假设如下：\n\n- 指令（I）总线的总线宽度为 $B_{i}$ 位，数据（D）总线的总线宽度为 $B_{d}$ 位。\n- 每个总线每个时钟周期最多能传输其全部宽度的数据，即对于宽度为 $B$ 的总线，每个周期最多传输 $B$ 位。\n- 两次传输在各自的总线上于同一时钟周期开始，并以每周期允许的最大速率进行，直到各自的大小被完全传输。\n- 忽略固定的建立延迟、对齐约束以及任何额外的流水线或缓存效应；仅考虑以时钟周期为单位测量的每个总线的原始传输时间。\n\n将重叠效率定义为 $\\eta = \\dfrac{\\text{并行周期}}{\\text{总周期}}$，其中“并行周期”是指令（I）总线和数据（D）总线同时活跃的时钟周期数，“总周期”是为此指令的内存活动期间，两个总线中至少有一个处于活跃状态的总时钟周期数。\n\n从上述关于哈佛架构并发性和每周期总线传输容量的基本定义出发，推导出一个关于 $B_{i}$、$B_{d}$、$s_{i}$ 和 $s_{d}$ 的 $\\eta$ 的解析表达式。然后，对于指令大小 $s_{i}=16$ 字节和数据传输大小 $s_{d}=32$ 字节的场景，计算以下三种总线宽度配置下的 $\\eta$（所有宽度均以位为单位）：\n\n- 情况 A：$B_{i}=64$，$B_{d}=64$。\n- 情况 B：$B_{i}=32$，$B_{d}=64$。\n- 情况 C：$B_{i}=128$，$B_{d}=32$。\n\n将最终的重叠效率表示为精确值。效率 $\\eta$ 是无量纲的；最终数值结果中不包含单位。不需要四舍五入。", "solution": "该问题的核心是确定哈佛架构中两次并发总线传输的重叠效率 $\\eta$。该效率定义为并行活跃周期数与总活跃周期数之比。\n\n首先，我们必须确定每次传输所需的时钟周期数。内存大小以字节为单位，而总线宽度以位为单位，其中 $1$ 字节 $= 8$ 位。\n\n设 $N_i$ 为通过宽度为 $B_i$ 位的指令（I）总线获取大小为 $s_i$ 字节的指令所需的时钟周期数。指令的总大小（以位为单位）是 $8s_i$。所需的周期数是总位数除以每周期传输的位数，并向上取整。\n$$\nN_i = \\left\\lceil \\frac{8s_i}{B_i} \\right\\rceil\n$$\n\n类似地，设 $N_d$ 为通过宽度为 $B_d$ 位的数据（D）总线进行大小为 $s_d$ 字节的数据传输所需的时钟周期数。\n$$\nN_d = \\left\\lceil \\frac{8s_d}{B_d} \\right\\rceil\n$$\n\n根据定义，“并行周期”是两个总线同时活跃的周期数，即两次传输中较短一次的持续时间。\n$$\nN_{\\text{parallel}} = \\min(N_i, N_d)\n$$\n\n“总周期”是至少有一个总线处于活跃状态的总周期数，即两次传输中较长一次的持续时间。\n$$\nN_{\\text{total}} = \\max(N_i, N_d)\n$$\n\n重叠效率 $\\eta$ 是并行周期与总周期的比率。\n$$\n\\eta = \\frac{N_{\\text{parallel}}}{N_{\\text{total}}} = \\frac{\\min(N_i, N_d)}{\\max(N_i, N_d)}\n$$\n\n代入 $N_i$ 和 $N_d$ 的表达式，我们得到 $\\eta$ 的通用解析表达式：\n$$\n\\eta = \\frac{\\min\\left(\\left\\lceil \\frac{8s_i}{B_i} \\right\\rceil, \\left\\lceil \\frac{8s_d}{B_d} \\right\\rceil\\right)}{\\max\\left(\\left\\lceil \\frac{8s_i}{B_i} \\right\\rceil, \\left\\lceil \\frac{8s_d}{B_d} \\right\\rceil\\right)}\n$$\n这就是所要求的解析表达式。\n\n接下来，我们计算给定场景下的 $\\eta$：$s_i = 16$ 字节（128位），$s_d = 32$ 字节（256位）。\n\n**情况 A：** $B_i = 64$ 位，$B_d = 64$ 位。\n指令获取周期：$N_i = \\lceil 128/64 \\rceil = 2$ 个周期。\n数据传输周期：$N_d = \\lceil 256/64 \\rceil = 4$ 个周期。\n效率 $\\eta_A$ 为：$\\eta_A = \\frac{\\min(2, 4)}{\\max(2, 4)} = \\frac{2}{4} = \\frac{1}{2}$。\n\n**情况 B：** $B_i = 32$ 位，$B_d = 64$ 位。\n指令获取周期：$N_i = \\lceil 128/32 \\rceil = 4$ 个周期。\n数据传输周期：$N_d = \\lceil 256/64 \\rceil = 4$ 个周期。\n效率 $\\eta_B$ 为：$\\eta_B = \\frac{\\min(4, 4)}{\\max(4, 4)} = \\frac{4}{4} = 1$。\n\n**情况 C：** $B_i = 128$ 位，$B_d = 32$ 位。\n指令获取周期：$N_i = \\lceil 128/128 \\rceil = 1$ 个周期。\n数据传输周期：$N_d = \\lceil 256/32 \\rceil = 8$ 个周期。\n效率 $\\eta_C$ 为：$\\eta_C = \\frac{\\min(1, 8)}{\\max(1, 8)} = \\frac{1}{8}$。\n\n三种情况的最终结果分别为 $\\frac{1}{2}$，$1$ 和 $\\frac{1}{8}$。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{1}{2} & 1 & \\frac{1}{8}\n\\end{pmatrix}\n}\n$$", "id": "3646906"}, {"introduction": "将视角从单核扩展到多核系统，哈佛架构的原理会影响系统级的性能和资源管理。这个调度问题挑战你将具有不同指令和数据带宽需求的人物分配到多个核心上。你的目标是优化共享L2缓存的使用，这展示了架构特性如何决定高层次的软件和系统设计决策。[@problem_id:3646991]", "problem": "一个多核处理器采用哈佛架构，每个核心都有独立的指令和数据通路。每个核心拥有一个私有的一级指令缓存和一个私有的一级数据缓存，并且所有核心共享一个统一的二级（L2）缓存。在此工作负载模型中，每个任务由一个以千兆字节/秒 (GB/s) 为单位的恒定速率对 $\\left(I_{bw}, D_{bw}\\right)$ 来表征：$I_{bw}$ 是进入核心指令通路的持续指令提取带宽需求，而 $D_{bw}$ 是由于在一级数据缓存中未命中的流式数据所产生的、由共享二级（L2）缓存服务的持续数据带宽需求。假设指令提取完全由一级指令缓存层次结构服务，不会到达二级（L2）缓存，而所有计入 $D_{bw}$ 的数据请求都会到达二级（L2）缓存。\n\n有 $C=3$ 个相同的核心。时间被划分为正好 $2$ 个不重叠的时间槽。每个任务必须被非抢占式地调度到恰好一个时间槽中，并在该时间槽内于一个核心上运行。在一个时间槽内，一个核心上最多只能运行一个任务。每个核心的指令通路有 $I_{\\max}=5$ GB/s 的限制，数据通路有 $D_{\\max}=8$ GB/s 的限制。芯片每个时间槽有 $I_{\\text{chip}}=9$ GB/s 的共享指令结构限制，即在一个时间槽内调度的所有任务的 $I_{bw}$ 总和不能超过 $I_{\\text{chip}}$。共享二级（L2）缓存为一个时间槽内调度的所有任务提供聚合的 $D_{bw}$ 数据流量服务，并且该时间槽的二级（L2）带宽消耗是该槽内任务的 $D_{bw}$ 之和。\n\n给定 $5$ 个任务及其需求 $(I_{bw}, D_{bw})$（单位：GB/s）：\n- $T_{1}: \\left(4, 6\\right)$\n- $T_{2}: \\left(3, 4\\right)$\n- $T_{3}: \\left(2, 5\\right)$\n- $T_{4}: \\left(4, 3\\right)$\n- $T_{5}: \\left(1, 7\\right)$\n\n所有任务都单独满足 $I_{bw} \\leq I_{\\max}$ 和 $D_{bw} \\leq D_{\\max}$，因此任何单个任务都可以在任何核心上运行。\n\n仅使用以下基本事实：(i) 在哈佛架构中，每个核心的指令和数据通路是独立的，(ii) 芯片级指令结构容量限制了每个时间槽的指令提取需求总和，以及 (iii) 每个时间槽的共享二级（L2）带宽等于该槽内调度任务的 $D_{bw}$ 之和，请在满足上述约束条件下，确定两个时间槽中可实现的最小峰值二级（L2）带宽。\n\n以 GB/s 为单位，将最终答案表示为精确整数。不要提供不等式或方程式；提供单个最小可实现峰值。无需四舍五入；给出精确值。", "solution": "该问题要求在满足一系列调度约束的条件下，求出两个时间槽中可实现的最小峰值二级（L2）带宽。这是一个组合优化问题，旨在将5个任务划分为两组（$S_1$, $S_2$），以最小化 $\\max(\\sum_{i \\in S_1} D_{bw,i}, \\sum_{j \\in S_2} D_{bw,j})$。\n\n约束条件如下：\n1. 核心约束：$|S_1| \\le 3$ 且 $|S_2| \\le 3$。由于共有5个任务，这意味着划分的大小必须是 (2, 3) 或 (3, 2)。\n2. 指令带宽约束：每个时间槽的总指令带宽不得超过 $I_{\\text{chip}}=9$ GB/s。所有任务的总指令带宽为 $4+3+2+4+1=14$ GB/s。因此，对于任意划分 $(S_1, S_2)$，必须满足 $\\sum_{i \\in S_1} I_{bw,i} \\le 9$ 且 $\\sum_{j \\in S_2} I_{bw,j} = 14 - \\sum_{i \\in S_1} I_{bw,i} \\le 9$。这共同要求任一分组的总指令带宽必须在 $[5, 9]$ GB/s 的区间内。\n\n总数据带宽为 $6+4+5+3+7=25$ GB/s。我们的目标是找到一个有效的划分，使两组的数据带宽总和尽可能接近 $25/2 = 12.5$ GB/s。\n\n我们通过枚举所有 $\\binom{5}{2} = 10$ 种可能的 (2, 3) 划分来寻找最优解。我们对每个由2个任务构成的分组 $S_1$ 进行检查（任务表示为 $(I_{bw}, D_{bw})$）：\n- $S_1 = \\{T_1(4,6), T_2(3,4)\\}$: $\\sum I=7$ (有效)。$\\sum D_1=10, \\sum D_2=15$。峰值=15。\n- $S_1 = \\{T_1(4,6), T_3(2,5)\\}$: $\\sum I=6$ (有效)。$\\sum D_1=11, \\sum D_2=14$。峰值=14。\n- $S_1 = \\{T_1(4,6), T_4(4,3)\\}$: $\\sum I=8$ (有效)。$\\sum D_1=9, \\sum D_2=16$。峰值=16。\n- $S_1 = \\{T_1(4,6), T_5(1,7)\\}$: $\\sum I=5$ (有效)。$\\sum D_1=13, \\sum D_2=12$。峰值=13。\n- $S_1 = \\{T_2(3,4), T_3(2,5)\\}$: $\\sum I=5$ (有效)。$\\sum D_1=9, \\sum D_2=16$。峰值=16。\n- $S_1 = \\{T_2(3,4), T_4(4,3)\\}$: $\\sum I=7$ (有效)。$\\sum D_1=7, \\sum D_2=18$。峰值=18。\n- $S_1 = \\{T_2(3,4), T_5(1,7)\\}$: $\\sum I=4$ (无效，小于5)。\n- $S_1 = \\{T_3(2,5), T_4(4,3)\\}$: $\\sum I=6$ (有效)。$\\sum D_1=8, \\sum D_2=17$。峰值=17。\n- $S_1 = \\{T_3(2,5), T_5(1,7)\\}$: $\\sum I=3$ (无效，小于5)。\n- $S_1 = \\{T_4(4,3), T_5(1,7)\\}$: $\\sum I=5$ (有效)。$\\sum D_1=10, \\sum D_2=15$。峰值=15。\n\n在所有有效的划分中，计算出的峰值带宽分别为 $\\{15, 14, 16, 13, 16, 18, 17, 15\\}$。这些值中的最小值为 $13$。该最优值由划分 $S_1=\\{T_1, T_5\\}$ 和 $S_2=\\{T_2, T_3, T_4\\}$ 实现，其数据带宽分别为 $13$ GB/s 和 $12$ GB/s。", "answer": "$$\n\\boxed{13}\n$$", "id": "3646991"}, {"introduction": "尽管代码和数据的分离是哈佛模型的基础，但实际的工程约束可能会催生出模糊这一界限的创新解决方案。这个问题探讨了这样一种技术：将数据直接嵌入指令流中。你将通过计算由此产生的“指令空间拥塞”来分析这种“代码即数据”方法的效率，从而深入了解架构纯粹性与工程实用性之间的权衡。[@problem_id:3646951]", "problem": "一个处理器实现了哈佛架构，具有独立的指令存储器和数据存储器。指令集架构（ISA）提供固定宽度为 $s$ 位的指令。指令存储器（指令空间，简称 $I$-space）由指令提取单元（IFU）读取，不能被数据加载/存储单元直接寻址。为了实现一种将代码作为数据（code-as-data）的范式，用于小型查找表且不访问数据存储器，您决定将表值直接编码到 $I$-space 中，并通过控制流来访问它们。\n\n假设以下基本事实和定义：\n- 在哈佛架构中，$I$-space 和数据空间是物理上分离的。IFU 提取指令，但不能从 $I$-space 发出任意的数据加载指令。\n- 一个值为 $v$ 位的编码表条目，可以通过执行一系列携带立即数的指令来重构，这些指令将常量累积地具体化到一个寄存器中。ISA提供了一种携带立即数的指令，该指令可以将一个有效载荷宽度为 $p$ 位的立即数字段写入或合并到目标寄存器，而无需额外的算术或逻辑指令。每条这样的指令在 $I$-space 中仍然占用一个完整的 $s$ 位的指令字。\n- 为了访问索引为 $j$ 的条目，代码计算一个目标地址并执行一次间接跳转（一条跳转指令）。在目标地址处，它精确地执行 $n$ 条携带立即数的指令（其中 $n$ 是从 $p$ 位有效载荷中具体化 $v$ 位值所需的最小指令数），然后执行一条返回指令以在调用者处恢复执行。\n- 忽略分支预测效应、流水线气泡、指令缓存未命中和对齐惩罚；仅计算由于跳转指令、 $n$ 条携带立即数的指令和返回指令而由IFU提取的总位数。将每条指令视为在 $I$-space 中占用 $s$ 位。\n\n将一次查找的 $I$-space 拥塞因子 $\\kappa$ 定义为：在这样一次表访问期间，IFU提取的指令总位数与表所提供的有用数据位数（即表值的 $v$ 位）之比。因此，$\\kappa$ 是无量纲的，它量化了每传递一个数据位所消耗的指令位数。\n\n给定一个具体系统，其参数如下：\n- 固定指令宽度 $s = 32$ 位。\n- 每条指令的立即数有效载荷宽度 $p = 16$ 位。\n- 每个表条目的值宽度 $v = 24$ 位。\n- 每次查找需要一条间接跳转指令和一条返回指令，且它们都是 $s$ 位的指令。\n\n仅使用上述基本事实，从第一性原理推导 $n$，然后推导用 $s$、$p$、$v$ 和 $n$ 表示的 $\\kappa$ 表达式，最后计算给定系统下 $\\kappa$ 的数值。将最终数值结果四舍五入到四位有效数字。最终答案以无单位的纯数表示。", "solution": "该问题的目标是推导并计算一个量化“代码即数据”方法开销的“I-space拥塞因子” $\\kappa$。\n\n1.  **推导所需指令数 $n$**：\n    一个值为 $v$ 位的表条目需要通过一系列携带 $p$ 位立即数的指令来构造。要具体化这个 $v$ 位的值，所需的最小指令数 $n$ 是能使得 $n \\times p \\geq v$ 的最小整数。这等价于比值 $v/p$ 的向上取整：\n    $$n = \\left\\lceil \\frac{v}{p} \\right\\rceil$$\n    对于给定的系统参数 $v = 24$ 位和 $p = 16$ 位，我们计算 $n$：\n    $$n = \\left\\lceil \\frac{24}{16} \\right\\rceil = \\lceil 1.5 \\rceil = 2$$\n    因此，需要2条指令来构造一个24位的值。\n\n2.  **推导拥塞因子 $\\kappa$ 的表达式**：\n    拥塞因子 $\\kappa$ 定义为提取的指令总位数与提供的有用数据位数之比：\n    $$\\kappa = \\frac{\\text{提取的指令总位数}}{\\text{提供的有用数据位数}}$$\n    一次查找操作包括1条间接跳转指令、 $n$ 条携带立即数的指令和1条返回指令，总共是 $(n+2)$ 条指令。由于每条指令的宽度为 $s$ 位，提取的指令总位数为 $(n+2)s$。\n    提供的有用数据位数就是表条目的宽度 $v$。\n    因此，$\\kappa$ 的表达式为：\n    $$\\kappa = \\frac{(n+2)s}{v}$$\n    将 $n$ 的表达式代入，得到完全由基本参数表示的 $\\kappa$：\n    $$\\kappa = \\frac{\\left( \\left\\lceil \\frac{v}{p} \\right\\rceil + 2 \\right)s}{v}$$\n\n3.  **计算 $\\kappa$ 的数值**：\n    使用系统参数 $s=32$，$p=16$，$v=24$，以及我们计算出的 $n=2$：\n    $$\\kappa = \\frac{(2 + 2) \\times 32}{24} = \\frac{4 \\times 32}{24} = \\frac{128}{24}$$\n    将分数化简：\n    $$\\kappa = \\frac{16}{3} = 5.3333...$$\n    根据要求四舍五入到四位有效数字，得到：\n    $$\\kappa \\approx 5.333$$\n    这意味着，通过此方法每传递一位有用数据，就需要从指令存储器中提取约 5.333 位。", "answer": "$$\n\\boxed{5.333}\n$$", "id": "3646951"}]}