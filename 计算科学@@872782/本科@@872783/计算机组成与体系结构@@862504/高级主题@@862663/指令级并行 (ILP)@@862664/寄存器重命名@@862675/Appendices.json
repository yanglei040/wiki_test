{"hands_on_practices": [{"introduction": "在理解了寄存器重命名是如何工作的之后，下一个合理的问题是，为什么它在现代处理器中如此关键。这个练习 [@problem_id:3672407] 通过分析一个循环在有和没有重命名两种情况下的性能来探讨这个问题。您将计算两种场景下的循环启动间隔，从而量化通过打破伪依赖、解锁更高指令级并行度所带来的性能提升。", "problem": "一个乱序超标量处理器使用寄存器别名表（RAT）实现寄存器重命名，该表将体系结构寄存器映射到大型物理寄存器堆中的物理寄存器。数据相关类型定义如下：写后读（RAW）是真相关，读后写（WAR）和写后写（WAW）是名相关。在没有寄存器重命名的情况下，名相关会限制指令的发射，但当不同的物理寄存器被分配给同一体系结构寄存器的不同动态实例时，这种相关性会被消除。\n\n考虑以下循环，它以理想化的类汇编伪代码编写，其中$R1$是一个累加器（携带循环真相关的体系结构寄存器），$R2$是每次迭代中重复使用的临时体系结构寄存器，$R3$是加载目标寄存器，$R5$是一个常数乘数：\n1. $R3 \\leftarrow \\text{load}(A[i])$\n2. $R1 \\leftarrow R1 + R3$\n3. $R2 \\leftarrow R3 \\times R5$\n4. $R8 \\leftarrow R2 + R9$\n\n假设：\n- 处理器每个周期最多可发射 $w = 4$ 条指令，每个周期最多进行 $1$ 次内存操作、最多 $1$ 次乘法操作以及最多 $2$ 次整数算术逻辑单元（ALU）操作。\n- 产生结果的延迟为：加载到使用 $= 3$ 个周期，整数加法 $= 1$ 个周期，乘法 $= 3$ 个周期。乘法器是完全流水线化的（每个周期可接受 $1$ 个新的乘法操作，并在 $3$ 个周期后产生结果）。整数ALU操作是单周期的并且完全旁路。\n- 完美的分支预测和完美的高速缓存；除了上述单元限制外，没有结构冒险或内存别名冒险。\n- 物理寄存器堆至少有 $32$ 个整数物理寄存器，足以容纳多个执行中迭代的 $R2$ 的独立物理版本。\n- 体系结构寄存器 $R1$ 携带一个循环真RAW相关：一次迭代中产生的 $R1$ 会被下一次迭代的指令 $2$ 消耗。体系结构寄存器 $R2$ 仅是每次迭代内的临时寄存器，除了在没有重命名时受到名相关的约束外，不会被后续迭代读取。\n\n考虑两种执行模式：\n- 模式N（不对$R2$进行重命名）：机器对体系结构寄存器$R2$强制执行WAR和WAW约束，因此一次迭代对$R2$的写操作不能在先前迭代中已调度的任何对$R2$的读操作之前发射，并且对$R2$的多次写操作必须按程序顺序完成。\n- 模式R（寄存器重命名）：每次迭代的体系结构寄存器$R2$被映射到一个独立的物理寄存器$P2_i$，从而消除了跨迭代的对$R2$的WAR和WAW相关。对$R1$的真相关仍然存在。\n\n在稳态条件下，确定模式N和模式R的启动间隔（II），定义为稳态下每个完成的循环迭代所需的平均周期数，并计算相应的加速比（模式R相对于模式N）。选择正确的陈述。\n\nA. 使用寄存器重命名时，稳态启动间隔为每个迭代 $1$ 个周期；不使用重命名时为每个迭代 $4$ 个周期；加速比为 $4\\times$。\n\nB. 使用寄存器重命名时，稳态启动间隔为每个迭代 $2$ 个周期；不使用重命名时为每个迭代 $4$ 个周期；加速比为 $2\\times$。\n\nC. 寄存器重命名没有带来吞吐量上的好处：由于$R1$上的真相关，两种模式的稳态启动间隔均为每个迭代 $1$ 个周期。\n\nD. 使用寄存器重命名时，稳态启动间隔为每个迭代 $3$ 个周期；不使用重命名时也是每个迭代 $3$ 个周期；加速比为 $1\\times$。", "solution": "用户提供了一个计算机体系结构的问题，要求计算一个循环在两种不同执行模式（一种有寄存器重命名，一种没有）下的稳态性能。性能指标是启动间隔（II），即每次迭代的平均周期数。\n\n### 第1步：问题验证\n\n我将首先验证问题陈述，以确保其科学上合理、定义明确且完整。\n\n**1.1. 提取的已知条件：**\n- **处理器：** 使用寄存器别名表（RAT）进行寄存器重命名的乱序超标量处理器。\n- **相关类型：**\n  - 写后读（RAW）：真相关。\n  - 读后写（WAR）、写后写（WAW）：名相关，可通过重命名消除。\n- **循环代码：**\n  1. $I1: R3 \\leftarrow \\text{load}(A[i])$\n  2. $I2: R1 \\leftarrow R1 + R3$\n  3. $I3: R2 \\leftarrow R3 \\times R5$\n  4. $I4: R8 \\leftarrow R2 + R9$\n- **寄存器角色：**\n  - $R1$: 循环携带真相关（累加器）。\n  - $R2$: 临时寄存器，每次迭代重用。\n  - $R3, R5, R8, R9$: 体系结构寄存器。\n- **资源约束：**\n  - 发射宽度 $w = 4$ 指令/周期。\n  - 内存单元：$1$/周期。\n  - 乘法单元：$1$/周期（完全流水线化）。\n  - 整数ALU单元：$2$/周期（完全旁路）。\n- **指令延迟：**\n  - 加载到使用：$3$ 个周期。\n  - 整数加法：$1$ 个周期。\n  - 乘法：$3$ 个周期。\n- **假设：**\n  - 完美的分支预测和高速缓存。\n  - 无其他结构/内存冒险。\n  - 有足够的物理寄存器用于重命名。\n- **执行模式：**\n  - **模式N（不对R2进行重命名）：** 机器对体系结构寄存器$R2$强制执行WAR和WAW约束。\n  - **模式R（寄存器重命名）：** $R2$的每个动态实例（即每次迭代）被映射到一个唯一的物理寄存器，从而消除了跨迭代对$R2$的WAR和WAW相关。\n\n**1.2. 根据标准进行验证：**\n- **科学依据：** 该问题是高级计算机体系结构中的一个标准练习。所有概念——超标量执行、乱序、寄存器重命名、数据冒险（RAW, WAR, WAW）、启动间隔和性能分析——都是该领域的基础。\n- **定义明确：** 问题提供了所有必要的参数：指令序列、延迟、资源约束以及对两种执行模式的清晰定义。目标是确定启动间隔，这是一个定义明确的任务，并基于所给模型有唯一解。\n- **客观性：** 问题以精确的技术语言陈述，没有主观或模棱两可的术语。\n- **一致性和完整性：** 数据内部一致。每次迭代的指令数和可用的功能单元都已明确指定，从而可以进行完整的分析。模式N和模式R之间的区别通过对寄存器$R2$名相关的处理方式明确定义。\n\n**1.3. 结论：**\n问题陈述有效。这是一个计算机体系结构性能分析中定义明确的问题。我现在将进行解答。\n\n### 第2步：求解推导\n\n循环的稳态启动间隔（$II$）由最严格的约束决定，即以下两个下界中的最大值：\n1.  **资源约束的II ($ResII$):** 由可用功能单元数量决定的最小间隔。\n2.  **递归约束的II ($RecII$):** 由循环携带相关环（递归）决定的最小间隔。\n\n$II = \\max(ResII, RecII)$\n\n**2.1. 计算资源约束的II ($ResII$)**\n$ResII$对于模式R和模式N都是相同的，因为它仅取决于循环体中的指令和机器的资源。循环体有：\n- $1$ 个内存操作（$load$）\n- $1$ 个乘法操作\n- $2$ 个整数ALU操作（$add$）\n- 总共 $4$ 条指令。\n\n约束条件如下：\n- 内存：$ResII_{mem} = \\lceil \\frac{\\text{内存操作数}}{\\text{内存单元数}} \\rceil = \\lceil \\frac{1}{1} \\rceil = 1$ 周期。\n- 乘法：$ResII_{mul} = \\lceil \\frac{\\text{乘法操作数}}{\\text{乘法单元数}} \\rceil = \\lceil \\frac{1}{1} \\rceil = 1$ 周期。\n- ALU：$ResII_{alu} = \\lceil \\frac{\\text{ALU操作数}}{\\text{ALU单元数}} \\rceil = \\lceil \\frac{2}{2} \\rceil = 1$ 周期。\n- 发射宽度：$ResII_{issue} = \\lceil \\frac{\\text{总指令数}}{\\text{发射宽度}} \\rceil = \\lceil \\frac{4}{4} \\rceil = 1$ 周期。\n\n总的$ResII$是这些单个下界的最大值：\n$ResII = \\max(1, 1, 1, 1) = 1$ 周期。\n这意味着仅基于资源，每个周期启动一次新的迭代是可能的。\n\n**2.2. 模式R（有寄存器重命名）的分析**\n在此模式下，所有名相关（WAR, WAW）都被消除。我们只需要考虑真相关（RAW）。\n\n- **迭代内RAW相关：**\n  - $I1 \\rightarrow I2$ (on $R3$)\n  - $I1 \\rightarrow I3$ (on $R3$)\n  - $I3 \\rightarrow I4$ (on $R2$)\n- **循环携带RAW相关：**\n  - 问题陈述指出$R1$上存在一个循环携带真相关。第$i$次迭代的指令$I2$, $I2_i: R1_i \\leftarrow R1_{i-1} + R3_i$，依赖于第$i-1$次迭代$I2_{i-1}$的结果。\n  - 这创建了一个递归：$I2_{i-1} \\rightarrow I2_i$。\n  - 这个递归环的延迟是环内指令的延迟，即$add$指令（$I2$）的延迟。\n  - $add$的延迟 = $1$ 个周期。\n  - 因此，递归约束的II是$RecII_R = 1$周期。\n\n模式R的启动间隔为：\n$II_R = \\max(ResII, RecII_R) = \\max(1, 1) = 1$ 周期/迭代。\n\n详细的调度可以证实这是可行的。在稳态下的任何周期$t$，处理器可以发射$I1_t$、$I2_{t-3}$、$I3_{t-3}$和$I4_{t-6}$，这符合$1$个内存、$2$个ALU和$1$个乘法器的资源限制。\n\n**2.3. 模式N（不对$R2$进行重命名）的分析**\n在此模式下，机器必须强制执行涉及体系结构寄存器$R2$的WAR和WAW相关。这些相关引入了新的循环携带相关。\n\n- **循环携带RAW相关：** 对$R1$的递归仍然存在，给出一个$RecII \\ge 1$的下界。\n- **$R2$上的循环携带名相关：**\n  1.  **WAW (写后写):** 第$i$次迭代中指令$I3$（$I3_i$）对$R2$的写操作必须在第$i-1$次迭代中指令$I3$（$I3_{i-1}$）对$R2$的写操作之后发生。一个保守的乱序机器会通过推迟$I3_i$的发射直到$I3_{i-1}$完成来强制执行此约束。\n      - 令$T_{issue}(I, k)$为第$k$次迭代中指令$I$的发射时间。\n      - $T_{issue}(I3_i) \\ge T_{complete}(I3_{i-1}) = T_{issue}(I3_{i-1}) + \\text{latency}(mul)$。\n      - $T_{issue}(I3_i) \\ge T_{issue}(I3_{i-1}) + 3$。\n      - 这意味着连续发射$I3$之间的最小间隔为$3$个周期。这创建了一个递归，给出$RecII_{WAW} = 3$。\n  2.  **WAR (读后写):** 第$i$次迭代中指令$I3$（$I3_i$）对$R2$的写操作必须在第$i-1$次迭代中指令$I4$（$I4_{i-1}$）对$R2$的读操作完成之后才能发生。问题陈述中说“$I3_i$不能在 ... $I4_{i-1}$之前发射”。在一个乱序处理器中，读取操作数发生在指令发射时或之后。因此，约束在于发射时间：\n      - $T_{issue}(I3_i) > T_{issue}(I4_{i-1})$，这意味着$T_{issue}(I3_i) \\ge T_{issue}(I4_{i-1}) + 1$。\n      - 此外，$I4_{i-1}$通过$R2$对$I3_{i-1}$有RAW相关。因此，$I4_{i-1}$只能在$I3_{i-1}$的结果就绪后发射。\n      - $T_{issue}(I4_{i-1}) \\ge T_{complete}(I3_{i-1}) = T_{issue}(I3_{i-1}) + \\text{latency}(mul)$。\n      - $T_{issue}(I4_{i-1}) \\ge T_{issue}(I3_{i-1}) + 3$。\n      - 结合这些不等式：\n      - $T_{issue}(I3_i) \\ge T_{issue}(I4_{i-1}) + 1 \\ge (T_{issue}(I3_{i-1}) + 3) + 1$。\n      - $T_{issue}(I3_i) \\ge T_{issue}(I3_{i-1}) + 4$。\n      - 这意味着连续发射$I3$之间的最小间隔为$4$个周期。这条循环携带相关链（$I3_{i-1} \\xrightarrow{RAW} I4_{i-1} \\xrightarrow{WAR} I3_i$）建立了一个递归，其$RecII_{WAR} = 4$。\n\n总的$RecII_N$是所有递归约束中的最大值：\n$RecII_N = \\max(RecII_{R1-RAW}, RecII_{R2-WAW}, RecII_{R2-WAR}) = \\max(1, 3, 4) = 4$ 周期。\n\n模式N的启动间隔为：\n$II_N = \\max(ResII, RecII_N) = \\max(1, 4) = 4$ 周期/迭代。\n\n**2.4. 加速比计算**\n加速比是执行时间的比率。对于固定次数的迭代，这等同于启动间隔的比率。\n加速比 = $\\frac{\\text{无优化的执行时间}}{\\text{有优化的执行时间}} = \\frac{II_N}{II_R} = \\frac{4}{1} = 4$。\n\n### 第3步：逐项分析选项\n\n**A. 使用寄存器重命名时，稳态启动间隔为每个迭代 $1$ 个周期；不使用重命名时为每个迭代 $4$ 个周期；加速比为 $4\\times$。**\n- $II_R = 1$: 与我们的推导相符。\n- $II_N = 4$: 与我们的推导相符。\n- 加速比 = $4\\times$: 与我们的计算相符 ($4/1 = 4$)。\n- **结论: 正确。**\n\n**B. 使用寄存器重命名时，稳态启动间隔为每个迭代 $2$ 个周期；不使用重命名时为每个迭代 $4$ 个周期；加速比为 $2\\times$。**\n- $II_R = 2$: 不正确。我们的分析表明$II_R = 1$。没有任何资源或递归约束会导致$II$为$2$。\n- $II_N = 4$: 正确。\n- 加速比 = $2\\times$: 不正确。应为$4/1=4$。\n- **结论: 错误。**\n\n**C. 寄存器重命名没有带来吞吐量上的好处：由于$R1$上的真相关，两种模式的稳态启动间隔均为每个迭代 $1$ 个周期。**\n- $II_R = 1$: 正确。\n- $II_N = 1$: 不正确。这一说法忽略了$R2$上的名相关，而模式N的说明明确指出硬件会强制执行这些相关并限制性能。如上推导，$II_N=4$。\n- **结论: 错误。**\n\n**D. 使用寄存器重命名时，稳态启动间隔为每个迭代 $3$ 个周期；不使用重命名时也是每个迭代 $3$ 个周期；加速比为 $1\\times$。**\n- $II_R = 3$: 不正确。这个值可能是由于将单个指令延迟（如加载或乘法）误解为启动间隔而得出的，这对于流水线化的乱序机器是不正确的。\n- $II_N = 3$: 不正确。这个值很可能来自于只考虑$R2$上的WAW冒险（$RecII_{WAW}=3$）而忽略了更严格的WAR冒险（$RecII_{WAR}=4$）。\n- **结论: 错误。**", "answer": "$$\\boxed{A}$$", "id": "3672407"}, {"introduction": "设计一款高性能处理器就是进行一系列复杂的工程权衡。虽然更大的物理寄存器堆（PRF）可以减少影响性能的停顿，但它也会增加芯片的面积和能耗。最后一个练习 [@problem_id:3672398] 挑战您像计算机架构师一样思考，通过建立并优化一个成本函数来模拟这种权衡。通过运用微积分来平衡停顿惩罚与访问能耗，您将推导出最优的PRF大小，从而深入理解驱动处理器设计的量化推理过程。", "problem": "考虑一个乱序（OoO）超标量核心，该核心实现了寄存器重命名，并配备了一个大小为 $P$ 个条目的物理寄存器堆（PRF）。当物理寄存器的空闲列表为空时，会发生重命名停顿，这迫使前端停止派发新指令，直到一次提交释放了条目。在指令级并行性假定为稳态的稳定状态下，设指令窗口和已提交但尚未释放状态所持有的活跃物理寄存器的平均数量为 $L$，其中 $L$ 相对于 $P$ 被视为一个常数。\n\n假设以下基于科学依据的一阶模型：\n- 由于字线/位线长度和译码器复杂性，每次 PRF 读取的动态能耗与 PRF 大小近似成线性比例。将读取能耗建模为 $E_{r}(P) = \\epsilon_{r} P$，写入能耗建模为 $E_{w}(P) = \\epsilon_{w} P$，其中 $\\epsilon_{r} > 0$ 且 $\\epsilon_{w} > 0$。\n- 平均而言，每条指令执行 $r$ 次 PRF 读取和 $w$ 次 PRF 写入，其中 $r \\ge 0$ 和 $w \\ge 0$ 被视为常数。\n- 每条指令的预期重命名停顿惩罚被建模为与空闲列表余量 $P - L$ 成反比。具体来说，预期的惩罚贡献一个成本项 $\\frac{C_{s}}{P - L}$，其中 $C_{s} > 0$ 汇集了因停顿导致的性能损失的等效能量成本。\n\n在这些假设下，定义结合了 PRF 访问能耗和重命名停顿惩罚的每指令目标函数 $J(P)$。从第一性原理和微积分出发，推导出在 $P > L$ 的约束下最小化 $J(P)$ 的 PRF 大小 $P^{*}$。将 $P^{*}$ 表示为关于 $L$、$C_{s}$、$\\epsilon_{r}$、$\\epsilon_{w}$、$r$ 和 $w$ 的单个闭式解析表达式。无需取整；提供精确的符号表达式。最终答案必须仅为 $P^{*}$ 的表达式。", "solution": "物理寄存器堆（PRF）是一个池，寄存器重命名过程从中为已解码的指令分配目标寄存器，从而将体系结构寄存器与物理存储解耦。当物理寄存器的空闲列表耗尽时，会发生重命名停顿，当余量 $P - L$（平均空闲条目数）较小时，这种情况更有可能发生。\n\n我们首先根据核心定义和经过充分检验的缩放定律构建一个基于科学依据的目标函数：\n1. 在类存储器结构中，每次访问的动态能耗随线路长度和译码器开销而变化。主要的动态能耗项是 $E = \\frac{1}{2} C V^{2}$，其中电容 $C$ 随导线长度和扇出而增长。对于一个 PRF，其字线和位线会随着行数或列数的增加而变长，因此其每次访问能耗的一阶模型与 $P$ 呈线性关系。因此，我们将每次读取的能耗建模为 $E_{r}(P) = \\epsilon_{r} P$，每次写入的能耗建模为 $E_{w}(P) = \\epsilon_{w} P$，其中 $\\epsilon_{r} > 0$ 且 $\\epsilon_{w} > 0$。如果平均每条指令执行 $r$ 次读取和 $w$ 次写入，那么每条指令的预期 PRF 访问能耗为\n$$\nE_{\\text{PRF}}(P) = r E_{r}(P) + w E_{w}(P) = r \\epsilon_{r} P + w \\epsilon_{w} P = (\\epsilon_{r} r + \\epsilon_{w} w) P.\n$$\n\n2. 当空闲列表包含零个条目时，就会出现重命名停顿。设 $L$ 表示由在途指令持有且尚未返回到空闲列表的活跃物理寄存器的平均数量，这是一个由指令窗口、退役延迟和生存期统计数据决定的属性。对于 $P > L$，空闲列表的余量为 $P - L$。在一个一阶占用率近似（大余量区域）中，每条指令遇到空闲列表耗尽事件的概率与余量近似成反比，这捕捉了每个额外的空闲条目都会降低瞬时饱和风险的直观效果。因此，我们将每条指令的预期重命名停顿惩罚建模为\n$$\nE_{\\text{stall}}(P) = \\frac{C_{s}}{P - L},\n$$\n其中 $C_{s} > 0$ 汇集了因停顿导致的性能损失的等效能量影响。\n\n结合这些项，每指令的目标函数为\n$$\nJ(P) = E_{\\text{PRF}}(P) + E_{\\text{stall}}(P) = (\\epsilon_{r} r + \\epsilon_{w} w) P + \\frac{C_{s}}{P - L},\n$$\n定义域为 $P > L$。\n\n我们寻求最小化 $J(P)$ 的 $P^{*}$。我们使用微积分通过对 $J(P)$ 关于 $P$ 求导来找到驻点：\n$$\n\\frac{d J}{d P} = (\\epsilon_{r} r + \\epsilon_{w} w) + \\frac{d}{dP}\\left(C_{s}(P - L)^{-1}\\right) = (\\epsilon_{r} r + \\epsilon_{w} w) + C_{s} \\left(-1\\right) (P - L)^{-2}.\n$$\n因此，\n$$\n\\frac{d J}{d P} = (\\epsilon_{r} r + \\epsilon_{w} w) - \\frac{C_{s}}{(P - L)^{2}}.\n$$\n为求极值，令导数为零：\n$$\n(\\epsilon_{r} r + \\epsilon_{w} w) - \\frac{C_{s}}{(P - L)^{2}} = 0\n\\quad \\Longrightarrow \\quad\n(\\epsilon_{r} r + \\epsilon_{w} w) = \\frac{C_{s}}{(P - L)^{2}}.\n$$\n求解 $P - L$：\n$$\n(P - L)^{2} = \\frac{C_{s}}{\\epsilon_{r} r + \\epsilon_{w} w}\n\\quad \\Longrightarrow \\quad\nP - L = \\sqrt{\\frac{C_{s}}{\\epsilon_{r} r + \\epsilon_{w} w}},\n$$\n根据定义域约束 $P - L > 0$，我们取正根。因此，\n$$\nP^{*} = L + \\sqrt{\\frac{C_{s}}{\\epsilon_{r} r + \\epsilon_{w} w}}.\n$$\n\n为确认此驻点是最小值点，我们计算二阶导数：\n$$\n\\frac{d^{2} J}{d P^{2}} = - C_{s} \\frac{d}{dP}\\left((P - L)^{-2}\\right) = - C_{s} \\left(-2\\right) (P - L)^{-3} = \\frac{2 C_{s}}{(P - L)^{3}}.\n$$\n对于 $P > L$ 和 $C_{s} > 0$，我们有 $\\frac{d^{2} J}{d P^{2}} > 0$，这验证了函数的凸性，并证明该驻点是可行域内唯一的全局最小值点。\n\n因此，在 PRF 访问能耗的线性增长与和空闲列表余量成反比的重命名停顿惩罚之间取得平衡的 PRF 大小为\n$$\nP^{*} = L + \\sqrt{\\frac{C_{s}}{\\epsilon_{r} r + \\epsilon_{w} w}}.\n$$", "answer": "$$\\boxed{L + \\sqrt{\\frac{C_{s}}{\\epsilon_{r} r + \\epsilon_{w} w}}}$$", "id": "3672398"}]}