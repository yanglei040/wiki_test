{"hands_on_practices": [{"introduction": "任何推测执行所能带来的性能收益，其基础都取决于处理器能沿着正确路径推测多远。这个练习将指导你使用基本的概率论来构建一个模型，用以计算在遇到第一个分支预测错误之前，成功预测的分支链的期望长度。通过这个练习，你将深入理解推测执行的根本限制，并掌握一个关键的性能分析工具。[@problem_id:3679051]", "problem": "一个带有现代分支预测器的中央处理器（CPU）在推测执行期间执行一系列紧密相连的条件分支。假设每次分支预测都相互独立，并且在推测路径上遇到的每个分支都有一个恒定的错误预测概率 $p$。推测会连续经过多个分支，直到遇到第一次错误预测时停止，此时流水线会清除所有不正确的推测性工作。\n\n将推测链长度 $L$ 定义为在遇到第一次错误预测之前，连续正确预测的分支数量。在所述的独立性和平稳性假设下，$L$ 的分布是在支撑集 $\\{0,1,2,\\dots\\}$上参数为 $p$ 的几何分布。\n\n从独立伯努利试验的概率公理出发，并且不使用任何预先推导出的期望公式，推导 $L$ 的概率质量函数，然后计算其期望值 $\\mathbb{E}[L]$，并以 $p$ 的闭式表达式表示。最后，通过推导 $\\Pr(L \\ge \\ell)$ 并描述其在 $\\ell \\to \\infty$ 时的渐近衰减特性来讨论其尾部行为。\n\n请将 $\\mathbb{E}[L]$ 的最终答案表示为关于 $p$ 的单个闭式解析表达式。无需四舍五入。", "solution": "首先对问题陈述进行验证。\n\n**步骤1：提取已知条件**\n-   执行一系列紧密相连的条件分支。\n-   每次分支预测都是一个独立事件。\n-   任何给定分支的错误预测概率是一个常数，记为 $p$。\n-   推测执行在第一次错误预测时停止。\n-   $L$ 是推测链长度，定义为第一次错误预测前连续正确预测的分支数量。\n-   随机变量 $L$ 的支撑集是非负整数集合 $\\{0, 1, 2, \\dots\\}$。\n-   问题陈述指出 $L$ 的分布是参数为 $p$ 的几何分布。\n-   任务是推导 $L$ 的概率质量函数（PMF），计算其期望值 $\\mathbb{E}[L]$，并分析其尾部概率 $\\Pr(L \\ge \\ell)$。\n\n**步骤2：使用提取的已知条件进行验证**\n-   **科学依据：** 该问题在计算机体系结构和概率论方面有充分的依据。将分支预测结果建模为一系列独立的伯努利试验，是一阶性能分析的标准和基本方法。推测执行、错误预测和流水线清除等概念是现代处理器设计的核心。从此模型中得出几何分布是这些假设的直接且正确的结果。\n-   **适定性：** 这是一个适定的问题。它清晰地定义了随机变量 $L$ 及其底层的概率过程。其目标（推导PMF、期望和尾部概率）是标准的，并且在数学上是可解的，从而可以得到唯一且有意义的解。\n-   **客观性：** 该问题是客观陈述的，使用了概率论和计算机科学中精确和标准的术语。没有主观或模棱两可的陈述。\n-   **完整性和一致性：** 该问题是自洽的。正确预测的概率隐含为 $1-p$。将 $L$ 定义为第一次错误预测*之前*的正确预测次数，这与其支撑集为 $\\{0, 1, 2, \\dots\\}$ 是一致的，其中 $L=0$ 对应于第一个分支就被错误预测的情况。不存在任何矛盾。\n\n**步骤3：结论与行动**\n问题是有效的。这是一个应用概率论中与计算机体系结构相关的标准、适定的问题。现在开始求解过程。\n\n**概率质量函数（PMF）的推导**\n\n设一次正确的分支预测为“成功”，一次错误预测为“失败”。成功概率为 $\\Pr(\\text{成功}) = 1-p$，失败概率为 $\\Pr(\\text{失败}) = p$。随机变量 $L$ 统计第一次失败前连续成功的次数。各次试验是独立的。\n\n对于 $k \\in \\{0, 1, 2, \\dots\\}$，事件 $\\{L=k\\}$ 表示前 $k$ 次分支预测是正确的，而第 $(k+1)$ 次分支预测是错误的。其结果序列为 $k$ 次成功后跟一次失败。\n\n由于分支预测的独立性，这个特定序列的概率是各次独立试验概率的乘积：\n$$\n\\Pr(L=k) = \\underbrace{\\Pr(\\text{成功}) \\times \\cdots \\times \\Pr(\\text{成功})}_{k \\text{ 次}} \\times \\Pr(\\text{失败})\n$$\n代入给定的概率，我们得到 $L$ 的概率质量函数（PMF）：\n$$\n\\Pr(L=k) = (1-p)^k p\n$$\n此 PMF 定义在 $k \\in \\{0, 1, 2, \\dots\\}$ 上。我们可以通过对其支撑集求和来验证它是一个有效的 PMF。该和是一个几何级数：\n$$\n\\sum_{k=0}^{\\infty} \\Pr(L=k) = \\sum_{k=0}^{\\infty} p(1-p)^k = p \\sum_{k=0}^{\\infty} (1-p)^k\n$$\n对于 $p \\in (0,1)$，我们有 $0  1-p  1$。几何级数的和为 $\\frac{1}{1-(1-p)} = \\frac{1}{p}$。因此，\n$$\n\\sum_{k=0}^{\\infty} \\Pr(L=k) = p \\left(\\frac{1}{p}\\right) = 1\n$$\n这证实了所推导的 PMF 的有效性。\n\n**期望值 $\\mathbb{E}[L]$ 的推导**\n\n问题要求从基本定义出发推导期望值。对于一个取值为非负整数的离散随机变量 $L$，其期望值的一个基本性质是可以通过对其尾部概率求和来计算：\n$$\n\\mathbb{E}[L] = \\sum_{k=0}^{\\infty} \\Pr(L  k)\n$$\n首先，我们必须推导 $\\Pr(Lk)$ 的表达式。事件 $\\{L  k\\}$ 意味着正确预测的分支数量大于 $k$。这等价于至少前 $k+1$ 个分支被正确预测的事件。\n$$\n\\Pr(Lk) = \\Pr(\\text{前 } k+1 \\text{ 次预测都正确})\n$$\n根据独立性，可得：\n$$\n\\Pr(Lk) = \\underbrace{\\Pr(\\text{成功}) \\times \\cdots \\times \\Pr(\\text{成功})}_{k+1 \\text{ 次}} = (1-p)^{k+1}\n$$\n现在，我们将其代回期望值的求和公式中：\n$$\n\\mathbb{E}[L] = \\sum_{k=0}^{\\infty} (1-p)^{k+1}\n$$\n让我们写出这个级数的各项：\n$$\n\\mathbb{E}[L] = (1-p)^1 + (1-p)^2 + (1-p)^3 + \\dots\n$$\n这是一个首项为 $a = 1-p$、公比为 $r = 1-p$ 的几何级数。该级数的和由公式 $\\frac{a}{1-r}$ 给出。\n$$\n\\mathbb{E}[L] = \\frac{1-p}{1 - (1-p)} = \\frac{1-p}{p}\n$$\n因此，推测链的期望长度为 $\\frac{1-p}{p}$。\n\n**尾部行为分析**\n\n问题要求我们分析尾部概率 $\\Pr(L \\ge \\ell)$ 及其渐近衰减。事件 $\\{L \\ge \\ell\\}$ 意味着推测链的长度至少为 $\\ell$。这等价于前 $\\ell$ 次分支预测全部正确的事件。第 $(\\ell+1)$ 次或任何后续预测的结果不受此事件的约束。\n$$\n\\Pr(L \\ge \\ell) = \\Pr(\\text{前 } \\ell \\text{ 次预测都正确})\n$$\n根据独立性，我们有：\n$$\n\\Pr(L \\ge \\ell) = (\\Pr(\\text{成功}))^\\ell = (1-p)^\\ell\n$$\n这就是几何分布的生存函数（或互补累积分布函数）。\n\n为了描述其在 $\\ell \\to \\infty$ 时的渐近衰减特性，我们考察表达式 $(1-p)^\\ell$。由于 $p$ 是一个概率，因此 $0  p  1$（如果 $p=0$ 或 $p=1$，问题则变得平凡）。因此，幂的底数 $1-p$ 是一个在区间 $(0,1)$ 内的值。对于任何这样的底数，当指数 $\\ell$ 趋于无穷大时，该函数会指数级衰减至零。\n$$\n\\lim_{\\ell \\to \\infty} \\Pr(L \\ge \\ell) = \\lim_{\\ell \\to \\infty} (1-p)^\\ell = 0\n$$\n衰减是关于 $\\ell$ 的指数形式。我们可以将其写为 $\\exp(\\ell \\ln(1-p))$。由于 $\\ln(1-p)$ 是一个负常数，这明确地显示了指数衰减。这意味着观察到一个非常长的、不间断的正确推测预测链的概率，会随着所需链长度的增加而指数级下降。衰减率由 $p$ 决定；较小的错误预测概率 $p$ 会导致底数 $1-p$ 更接近1，从而指数衰减更慢，使得更长的推测链更为可行。\n\n所要求的最终答案是 $\\mathbb{E}[L]$ 的闭式表达式。", "answer": "$$\\boxed{\\frac{1-p}{p}}$$", "id": "3679051"}, {"introduction": "性能提升往往伴随着能量消耗的代价，推测执行也不例外。每一次分支预测失误不仅会浪费计算周期，还会产生显著的能量开销。本练习将让你扮演一名处理器设计师，构建一个能量消耗模型，并计算出为了满足特定的能耗预算，分支预测器必须达到的最低准确率。[@problem_id:3679097]", "problem": "一个超标量处理器采用推测执行来维持前端吞吐率。其分支预测器的准确率为 $p$，意味着分支预测正确的概率为 $p$，不正确的概率为 $1-p$。前端使用一种影子取指译码机制，在每次遇到动态条件分支时，都会准备备用路径上的一个小窗口，以减少重定向延迟。无论预测是否正确，该机制都会为每个动态分支带来能量开销。当发生预测错误时，处理器会回滚流水线，清除错误路径上的工作并重新填充，这会为每次预测错误带来额外的能量成本。\n\n假设在某一次程序运行中：\n- 程序执行了 $N = 5.0 \\times 10^{9}$ 条动态指令。\n- 程序执行了 $B = 6.0 \\times 10^{8}$ 次动态条件分支。\n- 每条指令的基准动态能量（不包括与推测相关的成本）为 $e_{\\text{base}} = 1.5 \\times 10^{-9}$ 焦耳/指令。\n- 影子前端为错误路径做准备的开销为 $e_{\\text{wp}} = 2.0 \\times 10^{-10}$ 焦耳/动态分支，每次分支都会产生此开销，与预测正确与否无关。\n- 每次预测错误的回滚能量为 $e_{\\text{rb}} = 4.0 \\times 10^{-9}$ 焦耳/次预测错误。\n- 整个运行过程的能量预算为 $E_{\\text{budget}} = 8.05$ 焦耳。\n\n仅从期望值的定义和 $p$作为正确预测概率的解释出发，推导出总期望能量 $E_{\\text{total}}(p)$ 作为 $p$ 的函数，并确定满足 $E_{\\text{total}}(p) \\leq E_{\\text{budget}}$ 的最小 $p$ 值。将 $p$ 表示为一个无单位的小数。将您的最终数值答案四舍五入到四位有效数字。", "solution": "该问题具有科学依据，提法明确，并包含足够的信息以获得唯一解。我们首先推导总期望能耗 $E_{\\text{total}}(p)$ 作为分支预测准确率 $p$ 的函数表达式。\n\n总期望能量是三个不同部分的总和：\n1.  执行所有已退役指令的基准能量，$E_{\\text{base\\_total}}$。\n2.  影子前端为错误路径做准备的能量开销，$E_{\\text{wp\\_total}}$。\n3.  因分支预测错误而回滚的期望能量成本，$E_{\\text{rb\\_total}}(p)$。\n\n我们分别分析每个部分。\n\n基准能量 $E_{\\text{base\\_total}}$ 是 $N$ 条属于正确程序执行路径的动态指令所消耗的能量，不包括任何与推测相关的成本。这是一项固定成本。\n$$E_{\\text{base\\_total}} = N \\times e_{\\text{base}}$$\n给定 $N = 5.0 \\times 10^{9}$ 条指令和 $e_{\\text{base}} = 1.5 \\times 10^{-9}$ 焦耳/指令：\n$$E_{\\text{base\\_total}} = (5.0 \\times 10^{9}) \\times (1.5 \\times 10^{-9}) = 7.5 \\text{ 焦耳}$$\n\n影子前端开销 $E_{\\text{wp\\_total}}$ 是为 $B$ 次动态条件分支中的每一次产生的，无论预测正确与否。这也是一项固定成本。\n$$E_{\\text{wp\\_total}} = B \\times e_{\\text{wp}}$$\n给定 $B = 6.0 \\times 10^{8}$ 次分支和 $e_{\\text{wp}} = 2.0 \\times 10^{-10}$ 焦耳/分支：\n$$E_{\\text{wp\\_total}} = (6.0 \\times 10^{8}) \\times (2.0 \\times 10^{-10}) = 12.0 \\times 10^{-2} = 0.12 \\text{ 焦耳}$$\n\n回滚能量 $E_{\\text{rb\\_total}}(p)$ 仅在分支预测错误时产生。预测错误的次数是一个随机变量。为了求出期望能量成本，我们必须首先求出预测错误的期望次数。\n让我们考虑单个条件分支。预测正确的概率为 $p$，不正确的概率为 $1-p$。设 $X_i$ 为第 $i$ 个动态分支的指示随机变量，其中 $i = 1, 2, \\dots, B$。我们定义如果第 $i$ 个分支预测错误，则 $X_i = 1$，如果预测正确，则 $X_i = 0$。\n一次预测错误的概率是 $P(X_i = 1) = 1-p$。\n预测错误的总次数 $M$ 是这些指示变量的和：$M = \\sum_{i=1}^{B} X_i$。\n根据期望的线性性质，预测错误的期望次数 $E[M]$ 为：\n$$E[M] = E\\left[\\sum_{i=1}^{B} X_i\\right] = \\sum_{i=1}^{B} E[X_i]$$\n一个指示随机变量的期望值是它所指示事件的概率：$E[X_i] = P(X_i = 1) = 1-p$。\n因此，预测错误的期望次数是：\n$$E[M] = \\sum_{i=1}^{B} (1-p) = B(1-p)$$\n回滚的总期望能量成本是这个期望的预测错误次数乘以每次回滚的能量成本 $e_{\\text{rb}}$。\n$$E_{\\text{rb\\_total}}(p) = E[M] \\times e_{\\text{rb}} = B(1-p)e_{\\text{rb}}$$\n这个部分是 $p$ 的函数。对于给定值，项 $B \\times e_{\\text{rb}}$ 为：\n$$B \\times e_{\\text{rb}} = (6.0 \\times 10^{8}) \\times (4.0 \\times 10^{-9}) = 24.0 \\times 10^{-1} = 2.4 \\text{ 焦耳}$$\n所以，$E_{\\text{rb\\_total}}(p) = 2.4(1-p)$ 焦耳。\n\n总期望能量 $E_{\\text{total}}(p)$ 是这三个部分的总和：\n$$E_{\\text{total}}(p) = E_{\\text{base\\_total}} + E_{\\text{wp\\_total}} + E_{\\text{rb\\_total}}(p)$$\n$$E_{\\text{total}}(p) = N e_{\\text{base}} + B e_{\\text{wp}} + B(1-p)e_{\\text{rb}}$$\n\n问题要求这个总能量不超过预算 $E_{\\text{budget}} = 8.05$ 焦耳。我们建立不等式：\n$$N e_{\\text{base}} + B e_{\\text{wp}} + B(1-p)e_{\\text{rb}} \\leq E_{\\text{budget}}$$\n我们需要求解满足此条件的最小 $p$ 值。由于 $E_{\\text{total}}(p)$ 是 $p$ 的递减函数（因为 $p$ 的系数 $-B e_{\\text{rb}}$ 是负数），所以当等式成立时，将找到 $p$ 的最小值。\n让我们重新整理不等式来求解 $p$：\n$$B(1-p)e_{\\text{rb}} \\leq E_{\\text{budget}} - N e_{\\text{base}} - B e_{\\text{wp}}$$\n$$1-p \\leq \\frac{E_{\\text{budget}} - N e_{\\text{base}} - B e_{\\text{wp}}}{B e_{\\text{rb}}}$$\n$$-p \\leq \\frac{E_{\\text{budget}} - N e_{\\text{base}} - B e_{\\text{wp}}}{B e_{\\text{rb}}} - 1$$\n两边乘以 $-1$ 会使不等号反向：\n$$p \\geq 1 - \\frac{E_{\\text{budget}} - N e_{\\text{base}} - B e_{\\text{wp}}}{B e_{\\text{rb}}}$$\n$$p \\geq \\frac{B e_{\\text{rb}} - (E_{\\text{budget}} - N e_{\\text{base}} - B e_{\\text{wp}})}{B e_{\\text{rb}}}$$\n$$p \\geq \\frac{N e_{\\text{base}} + B e_{\\text{wp}} + B e_{\\text{rb}} - E_{\\text{budget}}}{B e_{\\text{rb}}}$$\n因此，所需的最低准确率 $p_{\\text{min}}$ 为：\n$$p_{\\text{min}} = \\frac{N e_{\\text{base}} + B e_{\\text{wp}} + B e_{\\text{rb}} - E_{\\text{budget}}}{B e_{\\text{rb}}}$$\n现在，我们代入之前计算出的数值：\n$$p_{\\text{min}} = \\frac{7.5 + 0.12 + 2.4 - 8.05}{2.4}$$\n$$p_{\\text{min}} = \\frac{10.02 - 8.05}{2.4}$$\n$$p_{\\text{min}} = \\frac{1.97}{2.4}$$\n$$p_{\\text{min}} \\approx 0.8208333\\dots$$\n四舍五入到四位有效数字，我们得到 $p_{\\text{min}} = 0.8208$。这是为了保持在能量预算之内所需的最低分支预测器准确率。", "answer": "$$\\boxed{0.8208}$$", "id": "3679097"}, {"introduction": "推测执行不仅限于控制流（分支预测），现代处理器还会对数据流进行推测，尤其是在内存系统中。通过允许加载操作在先前的存储地址确定之前执行（称为推测性存储绕行），处理器可以获得更高的性能，但也面临着内存顺序冲突的风险。这个高级练习将引导你分析这种复杂场景，并计算由于错误的内存依赖性推测而导致的流水线回滚率。[@problem_id:3679086]", "problem": "在采用推测性存储旁路（Speculative Store Bypass, SSB）的乱序（Out-of-Order, OoO）处理器中，如果内存依赖性预测器（Memory Dependency Predictor, MDP）认为加载-存储关系是独立的，那么一条加载指令可能会在地址未解析的旧有存储指令之前发射并执行。如果该加载指令实际上依赖于这些旧有存储指令中的任何一个（即，存在一个存储-到-加载的真依赖），那么推测性旁路会导致内存顺序冲突并强制回滚。\n\n假设在单个加载指令的发射点，存在以下有科学依据的模型：\n- 该加载指令可见的、地址未解析的旧有存储指令的数量是一个随机变量 $N$，它遵循均值为 $\\lambda = 4$ 的泊松分布。\n- 对于这 $N$ 个存储指令中的每一个，其目标地址与加载指令相同的概率独立地为 $d = 0.05$，这模拟了一个存储-到-加载的真依赖。\n- 在这 $N$ 个存储指令中至少存在一个真依赖的事件条件下，MDP 错误地允许推测性旁路的概率为 $\\alpha = 0.10$；否则，任何被允许的旁路都不会导致回滚。\n\n在这些假设下，并从独立 Bernoulli 试验和泊松分布的基本概率原理出发，推导单个加载指令回滚率的解析表达式，然后计算其数值。将您的数值答案四舍五入到四位有效数字。将最终比率表示为无量纲的小数。", "solution": "我们的目标是计算单个加载指令的回滚率，即回滚事件 $R$ 发生的概率 $\\Pr(R)$。\n\n根据问题描述，回滚事件 $R$ 发生的条件是：\n1.  至少存在一个存储-到-加载的真依赖（事件 $D$）。\n2.  并且，内存依赖性预测器（MDP）错误地允许了推测性旁路（事件 $A$）。\n\n因此，回滚事件是这两个事件的交集：$R = D \\cap A$。我们想要求解 $\\Pr(R) = \\Pr(D \\cap A)$。\n利用条件概率的定义，我们可以将其写为：\n$\\Pr(R) = \\Pr(A|D) \\Pr(D)$。\n\n问题中给出了条件概率 $\\Pr(A|D) = \\alpha = 0.10$。现在我们的任务是计算事件 $D$ 的概率，即至少存在一个真依赖的概率。\n\n直接计算 $\\Pr(D)$ 比较困难，因为它涉及到对所有可能存在依赖的场景进行求和。一个更简单的方法是计算其补集事件 $D^c$ 的概率，即“不存在任何真依赖”，然后使用 $\\Pr(D) = 1 - \\Pr(D^c)$。\n\n我们可以使用全概率公式，通过对地址未解析的存储指令数量 $N$ 的所有可能值进行条件化来计算 $\\Pr(D^c)$。\n$$ \\Pr(D^c) = \\sum_{n=0}^{\\infty} \\Pr(D^c | N=n) \\Pr(N=n) $$\n\n-   $\\Pr(N=n)$ 是泊松分布的概率质量函数（PMF），其均值为 $\\lambda$：\n    $$ \\Pr(N=n) = \\frac{e^{-\\lambda} \\lambda^n}{n!} $$\n-   $\\Pr(D^c | N=n)$ 是在给定有 $n$ 个旧有存储指令的条件下，它们都不与加载指令存在依赖的概率。对于单个存储指令，它与加载指令存在依赖的概率为 $d$，因此不存在依赖的概率为 $1-d$。由于每个存储指令的依赖性是独立的，因此 $n$ 个存储指令全都不存在依赖的概率是：\n    $$ \\Pr(D^c | N=n) = (1-d)^n $$\n\n将这两个表达式代入全概率公式中：\n$$ \\Pr(D^c) = \\sum_{n=0}^{\\infty} (1-d)^n \\frac{e^{-\\lambda} \\lambda^n}{n!} $$\n我们可以将与 $n$ 无关的项 $e^{-\\lambda}$ 提到求和符号外面：\n$$ \\Pr(D^c) = e^{-\\lambda} \\sum_{n=0}^{\\infty} \\frac{(\\lambda(1-d))^n}{n!} $$\n我们识别出求和部分是指数函数 $e^x$ 的泰勒级数展开式，其中 $x = \\lambda(1-d)$。\n$$ \\sum_{n=0}^{\\infty} \\frac{(\\lambda(1-d))^n}{n!} = e^{\\lambda(1-d)} $$\n因此，$\\Pr(D^c)$ 可以被简化为：\n$$ \\Pr(D^c) = e^{-\\lambda} e^{\\lambda(1-d)} = e^{-\\lambda + \\lambda - \\lambda d} = e^{-\\lambda d} $$\n这是一个关于泊松过程稀释（thinning）的标准结果。\n\n现在我们可以计算存在至少一个依赖的概率 $\\Pr(D)$：\n$$ \\Pr(D) = 1 - \\Pr(D^c) = 1 - e^{-\\lambda d} $$\n\n最后，我们可以计算回滚率 $\\Pr(R)$：\n$$ \\Pr(R) = \\Pr(A|D) \\Pr(D) = \\alpha (1 - e^{-\\lambda d}) $$\n\n现在代入给定的数值：\n- $\\lambda = 4$\n- $d = 0.05$\n- $\\alpha = 0.10$\n\n首先计算指数项中的乘积：\n$$ \\lambda d = 4 \\times 0.05 = 0.2 $$\n然后计算回滚率：\n$$ \\Pr(R) = 0.10 \\times (1 - e^{-0.2}) $$\n使用计算器得到 $e^{-0.2} \\approx 0.81873075...$\n$$ \\Pr(R) \\approx 0.10 \\times (1 - 0.81873075) $$\n$$ \\Pr(R) \\approx 0.10 \\times 0.18126925 $$\n$$ \\Pr(R) \\approx 0.018126925 $$\n根据问题要求，我们将结果四舍五入到四位有效数字，得到 $0.01813$。\n\n因此，单个加载指令的回滚率约为 $0.01813$。", "answer": "$$\\boxed{0.01813}$$", "id": "3679086"}]}