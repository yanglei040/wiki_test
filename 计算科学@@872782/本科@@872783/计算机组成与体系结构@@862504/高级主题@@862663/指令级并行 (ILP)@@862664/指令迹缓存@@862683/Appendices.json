{"hands_on_practices": [{"introduction": "在处理器前端增加一个指令踪迹缓存，相当于在存储层次结构中引入了新的一级。虽然其目标是提升性能，但它自身也会消耗能量。本练习将引导你对这一权衡进行基础分析，你需要为每次取指的平均能耗建模，并确定指令踪迹缓存变得比传统指令缓存更节能的盈亏平衡点 [@problem_id:3650604]。掌握这种计算是基于功耗和性能指标做出明智架构决策的关键。", "problem": "一个超标量处理器通过在传统的指令缓存 (IC) 之上增加一个踪迹缓存 (Trace Cache, TC) 来增强其前端。每个指令获取周期首先探测 TC；如果 TC 未命中，则探测 IC；如果 IC 未命中，则访问较低级别的未命中路径（例如，二级缓存和主内存）。设每次访问的动态能耗分别为：TC 的 $E_{tc}$，IC 的 $E_{ic}$，以及在 IC 未命中时除了 IC 访问之外产生的较低级别未命中路径的能耗 $E_{m}$。设 TC 的命中率为 $h_{tc}$，IC 的命中率（以访问 IC 为条件）为 $h_{ic}$。假设一次尝试性访问无论命中与否都会消耗其能量，并且 TC 的存在不会改变那些确实到达 IC 的指令获取的条件 IC 命中率。\n\n仅使用命中率和期望值的定义，完成以下任务：\n\n1. 推导存在 TC 时每次获取的平均能耗的解析表达式，用 $E_{tc}$、$E_{ic}$、$E_{m}$、$h_{tc}$ 和 $h_{ic}$ 表示。\n\n2. 推导没有 TC（仅 IC 系统）时每次获取的平均能耗的解析表达式，用 $E_{ic}$、$E_{m}$ 和 $h_{ic}$ 表示。\n\n3. 使用参数值 $E_{tc} = 0.18$ nJ, $E_{ic} = 0.25$ nJ, $E_{m} = 1.20$ nJ, $h_{ic} = 0.95$ 和 $h_{tc} = 0.65$，计算两种系统每次获取的平均能耗数值，单位为纳焦耳 (nJ)。\n\n4. 确定使带有 TC 的系统每次获取的平均能耗与仅有 IC 的系统相等的临界 TC 命中率 $h_{tc}^{\\star}$。提供一个用 $E_{tc}$、$E_{ic}$、$E_{m}$ 和 $h_{ic}$ 表示的 $h_{tc}^{\\star}$ 的闭式表达式，然后用给定的参数值进行数值计算。\n\n仅报告 $h_{tc}^{\\star}$ 作为最终答案，表示为无单位的小数，并四舍五入到四位有效数字。", "solution": "经评估，问题陈述有效。它在科学上基于计算机体系结构的原理，特别是处理器前端设计和能耗模型。问题定义明确，所有必要的变量、常数和假设都已明确定义。它客观且无歧义，允许通过逻辑和数学推导得出唯一、可验证的解。因此，我们可以进行正式求解。\n\n每次获取的平均能耗是所消耗能量的期望值，通过将每种可能结果的能耗与该结果发生的概率相乘，然后求和计算得出。\n\n首先，我们推导存在踪迹缓存（TC）时每次获取的平均能耗的解析表达式，记为 $E_{\\text{avg, TC}}$。获取过程有三种互斥的结果：\n1.  **TC 命中**：指令获取在 TC 中命中。这种情况发生的概率为 $h_{\\text{tc}}$。消耗的能量是 TC 访问的能量 $E_{\\text{tc}}$。\n2.  **TC 未命中，指令缓存 (IC) 命中**：获取在 TC 中未命中，但在 IC 中命中。只有当 TC 未命中时才会走这条路径，其概率为 $(1 - h_{\\text{tc}})$。在 TC 未命中的情况下，会发起一次 IC 访问。这次 IC 访问命中的概率是 $h_{\\text{ic}}$。这一序列的总概率是 $(1 - h_{\\text{tc}})h_{\\text{ic}}$。消耗的能量是 TC 访问能量和 IC 访问能量之和，$E_{\\text{tc}} + E_{\\text{ic}}$。\n3.  **TC 未命中，IC 未命中**：获取在 TC 和 IC 中都未命中。TC 未命中的概率是 $(1 - h_{\\text{tc}})$。随后的 IC 未命中的概率是 $(1 - h_{\\text{ic}})$。这一序列的总概率是 $(1 - h_{\\text{tc}})(1 - h_{\\text{ic}})$。消耗的能量是 TC 访问能量、IC 访问能量以及访问较低级别存储器的额外能量之和，$E_{\\text{tc}} + E_{\\text{ic}} + E_{\\text{m}}$。\n\n每次获取的总平均能耗 $E_{\\text{avg, TC}}$ 是每种情况的能耗贡献之和：\n$$E_{\\text{avg, TC}} = (h_{\\text{tc}})(E_{\\text{tc}}) + (1 - h_{\\text{tc}})h_{\\text{ic}}(E_{\\text{tc}} + E_{\\text{ic}}) + (1 - h_{\\text{tc}})(1 - h_{\\text{ic}})(E_{\\text{tc}} + E_{\\text{ic}} + E_{\\text{m}})$$\n这个表达式可以简化。考虑到在该系统中，每次获取访问总是先探测 TC，因此总是消耗 $E_{\\text{tc}}$。如果 TC 未命中（概率为 $1 - h_{\\text{tc}}$），则进行一次 IC 访问，消耗 $E_{\\text{ic}}$。如果该 IC 访问也未命中（概率为 $1 - h_{\\text{ic}}$），则会消耗额外的能量 $E_{\\text{m}}$。这导出一个更直接的公式：\n$$E_{\\text{avg, TC}} = E_{\\text{tc}} + (1 - h_{\\text{tc}})E_{\\text{ic}} + (1 - h_{\\text{tc}})(1 - h_{\\text{ic}})E_{\\text{m}}$$\n这是问题第一部分所要求的表达式。\n\n第二，我们推导仅有 IC 的系统（IC-only system）的平均能耗 $E_{\\text{avg, IC-only}}$。在这个系统中，每次获取都访问 IC。\n1.  **IC 命中**：获取在 IC 中命中。这种情况发生的概率为 $h_{\\text{ic}}$。消耗的能量是 $E_{\\text{ic}}$。\n2.  **IC 未命中**：获取在 IC 中未命中。这种情况发生的概率为 $(1 - h_{\\text{ic}})$。消耗的能量是 IC 访问的能量加上未命中路径的额外能量，$E_{\\text{ic}} + E_{\\text{m}}$。\n\n平均能耗 $E_{\\text{avg, IC-only}}$ 为：\n$$E_{\\text{avg, IC-only}} = h_{\\text{ic}}(E_{\\text{ic}}) + (1 - h_{\\text{ic}})(E_{\\text{ic}} + E_{\\text{m}})$$\n简化这个表达式：\n$$E_{\\text{avg, IC-only}} = h_{\\text{ic}}E_{\\text{ic}} + E_{\\text{ic}} - h_{\\text{ic}}E_{\\text{ic}} + (1 - h_{\\text{ic}})E_{\\text{m}}$$\n$$E_{\\text{avg, IC-only}} = E_{\\text{ic}} + (1 - h_{\\text{ic}})E_{\\text{m}}$$\n这是问题第二部分所要求的表达式。\n\n第三，我们使用给定的参数计算两种系统的平均能耗数值：$E_{\\text{tc}} = 0.18$ nJ, $E_{\\text{ic}} = 0.25$ nJ, $E_{\\text{m}} = 1.20$ nJ, $h_{\\text{ic}} = 0.95$ 和 $h_{\\text{tc}} = 0.65$。\n对于带有 TC 的系统：\n$$E_{\\text{avg, TC}} = 0.18 + (1 - 0.65) \\times 0.25 + (1 - 0.65)(1 - 0.95) \\times 1.20$$\n$$E_{\\text{avg, TC}} = 0.18 + (0.35 \\times 0.25) + (0.35 \\times 0.05 \\times 1.20)$$\n$$E_{\\text{avg, TC}} = 0.18 + 0.0875 + 0.021 = 0.2885 \\text{ nJ}$$\n对于仅有 IC 的系统：\n$$E_{\\text{avg, IC-only}} = 0.25 + (1 - 0.95) \\times 1.20$$\n$$E_{\\text{avg, IC-only}} = 0.25 + (0.05 \\times 1.20)$$\n$$E_{\\text{avg, IC-only}} = 0.25 + 0.06 = 0.31 \\text{ nJ}$$\n\n第四，我们确定临界 TC 命中率 $h_{\\text{tc}}^{\\star}$，此时两个系统的平均能耗相等：\n$$E_{\\text{avg, TC}}|_{h_{\\text{tc}} = h_{\\text{tc}}^{\\star}} = E_{\\text{avg, IC-only}}$$\n代入推导出的解析表达式：\n$$E_{\\text{tc}} + (1 - h_{\\text{tc}}^{\\star})E_{\\text{ic}} + (1 - h_{\\text{tc}}^{\\star})(1 - h_{\\text{ic}})E_{\\text{m}} = E_{\\text{ic}} + (1 - h_{\\text{ic}})E_{\\text{m}}$$\n我们可以将左侧的项 $(1 - h_{\\text{tc}}^{\\star})$ 提取出来：\n$$E_{\\text{tc}} + (1 - h_{\\text{tc}}^{\\star}) [E_{\\text{ic}} + (1 - h_{\\text{ic}})E_{\\text{m}}] = E_{\\text{ic}} + (1 - h_{\\text{ic}})E_{\\text{m}}$$\n注意到左边方括号中的项等于右边的整个表达式，也就是 $E_{\\text{avg, IC-only}}$。为了清晰起见，我们进行代换：\n$$E_{\\text{tc}} + (1 - h_{\\text{tc}}^{\\star}) E_{\\text{avg, IC-only}} = E_{\\text{avg, IC-only}}$$\n现在，我们求解 $h_{\\text{tc}}^{\\star}$：\n$$E_{\\text{tc}} = E_{\\text{avg, IC-only}} - (1 - h_{\\text{tc}}^{\\star}) E_{\\text{avg, IC-only}}$$\n$$E_{\\text{tc}} = E_{\\text{avg, IC-only}} (1 - (1 - h_{\\text{tc}}^{\\star}))$$\n$$E_{\\text{tc}} = E_{\\text{avg, IC-only}} (1 - 1 + h_{\\text{tc}}^{\\star})$$\n$$E_{\\text{tc}} = h_{\\text{tc}}^{\\star} E_{\\text{avg, IC-only}}$$\n$$h_{\\text{tc}}^{\\star} = \\frac{E_{\\text{tc}}}{E_{\\text{avg, IC-only}}}$$\n代入 $E_{\\text{avg, IC-only}}$ 的表达式，得到临界命中率的最终闭式表达式：\n$$h_{\\text{tc}}^{\\star} = \\frac{E_{\\text{tc}}}{E_{\\text{ic}} + (1 - h_{\\text{ic}})E_{\\text{m}}}$$\n最后，我们使用提供的参数值对该表达式进行数值计算：\n$$h_{\\text{tc}}^{\\star} = \\frac{0.18}{0.25 + (1 - 0.95) \\times 1.20}$$\n$$h_{\\text{tc}}^{\\star} = \\frac{0.18}{0.25 + 0.05 \\times 1.20} = \\frac{0.18}{0.25 + 0.06} = \\frac{0.18}{0.31}$$\n$$h_{\\text{tc}}^{\\star} \\approx 0.58064516...$$\n四舍五入到四位有效数字，我们得到 $h_{\\text{tc}}^{\\star} \\approx 0.5806$。", "answer": "$$\\boxed{0.5806}$$", "id": "3650604"}, {"introduction": "缓存在物理层面的实现涉及芯片面积和访问速度之间的关键权衡。在这个实践问题中，你将扮演微架构设计者的角色，评估指令踪迹缓存的两种不同布局：一个单一的大型存储器阵列，或两个较小的独立阵列 [@problem_id:3650627]。通过基于合理的模型分析面积成本和时序延迟，你将学习到物理设计约束如何决定架构选择，以满足处理器的周期时间目标。", "problem": "一个微架构团队正在设计一个指令踪迹缓存（Instruction Trace Cache），该缓存可存储长度最多为固定数量指令槽的追踪。每个追踪条目存储一个指令束和每个追踪的元数据。该团队正在考虑两种存储元数据的方案：(i) 单片式，元数据与指令束存储在同一个静态随机存取存储器（SRAM）宏单元中；(ii) 分离式，元数据存储在一个并行访问的独立SRAM宏单元中。您必须计算分离式方案的面积开销，并根据以下基于标准面积核算和关键路径时序建模的假设和定义，确定是否需要分离元数据以满足周期时间目标。\n\n假设：\n- 追踪条目数（深度）：$N = 4096$。\n- 每个追踪的指令束宽度：$B_{\\mathrm{inst}} = 512$ 位。\n- 每个追踪的元数据由一个 $flags$ 字段和一个 $branch\\_mask$ 组成，总共 $B_{\\mathrm{meta}} = 32$ 位。\n- SRAM位单元面积为每位 $a_{\\mathrm{cell}} = 0.07\\,\\mu\\mathrm{m}^{2}$。\n- 每个SRAM宏单元具有固定的外围电路面积 $A_{\\mathrm{peri}} = 0.015\\,\\mathrm{mm}^{2}$，与位数无关。每个宏单元实例都会产生一次外围电路面积。\n- 任何SRAM宏单元的阵列访问时间为 $t_{\\mathrm{arr}} = 0.45\\,\\mathrm{ns}$。\n- 读后对齐和导向网络的延迟被建模为输出宽度 $W$（以位为单位）的仿射函数。对于单片式方案（指令加元数据的组合宽度 $W_{\\mathrm{mono}} = B_{\\mathrm{inst}} + B_{\\mathrm{meta}}$），延迟为\n$$\nt_{\\mathrm{align,mono}} = t_{0,\\mathrm{mono}} + s_{\\mathrm{mono}} \\cdot W_{\\mathrm{mono}}, \\quad t_{0,\\mathrm{mono}} = 0.12\\,\\mathrm{ns}, \\quad s_{\\mathrm{mono}} = 1.2 \\times 10^{-3}\\,\\mathrm{ns/bit}.\n$$\n- 对于分离式方案，指令和元数据路径各有其自己的对齐和导向网络，宽度分别为 $W_{\\mathrm{inst}} = B_{\\mathrm{inst}}$ 和 $W_{\\mathrm{meta}} = B_{\\mathrm{meta}}$，延迟为\n$$\nt_{\\mathrm{align,inst}} = t_{0,\\mathrm{inst}} + s_{\\mathrm{inst}} \\cdot W_{\\mathrm{inst}}, \\quad t_{0,\\mathrm{inst}} = 0.06\\,\\mathrm{ns}, \\quad s_{\\mathrm{inst}} = 1.0 \\times 10^{-3}\\,\\mathrm{ns/bit},\n$$\n$$\nt_{\\mathrm{align,meta}} = t_{0,\\mathrm{meta}} + s_{\\mathrm{meta}} \\cdot W_{\\mathrm{meta}}, \\quad t_{0,\\mathrm{meta}} = 0.03\\,\\mathrm{ns}, \\quad s_{\\mathrm{meta}} = 0.5 \\times 10^{-3}\\,\\mathrm{ns/bit}.\n$$\n- 在分离式方案中，两个SRAM在同一个流水线阶段并行访问；阶段时间是两条路径延迟的最大值加上一个小的合并开销 $t_{\\mathrm{merge}} = 0.03\\,\\mathrm{ns}$。因此，阶段时间为\n$$\nt_{\\mathrm{split}} = t_{\\mathrm{arr}} + \\max\\!\\big(t_{\\mathrm{align,inst}},\\, t_{\\mathrm{align,meta}}\\big) + t_{\\mathrm{merge}}.\n$$\n- 在单片式方案中，阶段时间为\n$$\nt_{\\mathrm{mono}} = t_{\\mathrm{arr}} + t_{\\mathrm{align,mono}}.\n$$\n- 目标周期时间为 $T_{\\mathrm{target}} = 1.10\\,\\mathrm{ns}$。\n\n将SRAM宏单元的面积定义为位单元面积和外围电路面积之和。在单片式方案中，有一个宽度为 $W_{\\mathrm{mono}}$、深度为 $N$ 的宏单元。在分离式方案中，有两个宏单元（一个用于指令，一个用于元数据），每个宏单元都有自己的外围电路面积。\n\n任务：\n1. 计算分离式方案相对于单片式方案的分数面积开销，定义为\n$$\n\\Delta A_{\\mathrm{frac}} = \\frac{A_{\\mathrm{split}} - A_{\\mathrm{mono}}}{A_{\\mathrm{mono}}},\n$$\n其中 $A_{\\mathrm{mono}}$ 和 $A_{\\mathrm{split}}$ 分别是单片式和分离式方案的总面积。面积以 $\\mathrm{mm}^{2}$ 表示，注意 $1\\,\\mathrm{mm}^{2} = 10^{6}\\,\\mu\\mathrm{m}^{2}$。\n2. 通过将 $t_{\\mathrm{mono}}$ 和 $t_{\\mathrm{split}}$ 与 $T_{\\mathrm{target}}$ 进行比较，决定是否应将元数据放置在独立的SRAM中以缓解时序压力。如果单片式方案不满足 $T_{\\mathrm{target}}$ 而分离式方案满足，则需要进行分离。\n\n如果需要分离，则报告一个等于 $\\Delta A_{\\mathrm{frac}}$ 值的最终数值答案；否则报告 $0$。将最终值表示为不带百分号的小数，并四舍五入到四位有效数字。", "solution": "问题陈述经核实具有科学依据、定义明确、客观且完整。它使用简化但合理的SRAM面积和时序模型，展示了计算机微架构中的一个标准权衡分析。所有必要的参数和定义都已提供，没有矛盾或含糊不清之处。该问题是可解的。\n\n任务是确定在踪迹缓存中将元数据存储与指令存储分离是否为满足时序目标所必需，如果是，则计算相关的分数面积开销。这需要进行两部分分析：首先，计算两种配置的面积以找出开销；其次，计算它们各自的访问时间以与目标进行比较。\n\n首先，我们计算面积开销。一个SRAM宏单元的总面积是所有位单元的面积和一个固定的外围电路面积之和。\n设 $N$ 为追踪条目数，$B_{\\mathrm{inst}}$ 为指令束宽度，$B_{\\mathrm{meta}}$ 为元数据宽度，$a_{\\mathrm{cell}}$ 为单位位单元的面积，$A_{\\mathrm{peri}}$ 为每个宏单元的外围电路面积。\n\n对于单片式方案，有一个SRAM宏单元。其总宽度为 $W_{\\mathrm{mono}} = B_{\\mathrm{inst}} + B_{\\mathrm{meta}}$。\n位单元的总面积为 $A_{\\mathrm{bits,mono}} = N \\cdot (B_{\\mathrm{inst}} + B_{\\mathrm{meta}}) \\cdot a_{\\mathrm{cell}}$。\n单片式方案的总面积为 $A_{\\mathrm{mono}} = A_{\\mathrm{bits,mono}} + A_{\\mathrm{peri}}$。\n\n对于分离式方案，有两个SRAM宏单元，一个用于指令，一个用于元数据。每个宏单元都有自己的外围电路面积。\n指令位单元的面积是 $A_{\\mathrm{bits,inst}} = N \\cdot B_{\\mathrm{inst}} \\cdot a_{\\mathrm{cell}}$。\n元数据位单元的面积是 $A_{\\mathrm{bits,meta}} = N \\cdot B_{\\mathrm{meta}} \\cdot a_{\\mathrm{cell}}$。\n分离式方案的总面积是 $A_{\\mathrm{split}} = (A_{\\mathrm{bits,inst}} + A_{\\mathrm{peri}}) + (A_{\\mathrm{bits,meta}} + A_{\\mathrm{peri}}) = (A_{\\mathrm{bits,inst}} + A_{\\mathrm{bits,meta}}) + 2 \\cdot A_{\\mathrm{peri}}$。\n总位单元面积与单片式情况相同：$A_{\\mathrm{bits,inst}} + A_{\\mathrm{bits,meta}} = N \\cdot (B_{\\mathrm{inst}} + B_{\\mathrm{meta}}) \\cdot a_{\\mathrm{cell}} = A_{\\mathrm{bits,mono}}$。\n因此，$A_{\\mathrm{split}} = A_{\\mathrm{bits,mono}} + 2 \\cdot A_{\\mathrm{peri}}$。\n\n分数面积开销 $\\Delta A_{\\mathrm{frac}}$ 由下式给出：\n$$\n\\Delta A_{\\mathrm{frac}} = \\frac{A_{\\mathrm{split}} - A_{\\mathrm{mono}}}{A_{\\mathrm{mono}}} = \\frac{(A_{\\mathrm{bits,mono}} + 2 \\cdot A_{\\mathrm{peri}}) - (A_{\\mathrm{bits,mono}} + A_{\\mathrm{peri}})}{A_{\\mathrm{bits,mono}} + A_{\\mathrm{peri}}} = \\frac{A_{\\mathrm{peri}}}{A_{\\mathrm{bits,mono}} + A_{\\mathrm{peri}}}\n$$\n我们现在代入给定的数值。首先，我们将所有面积单位转换为 $\\mathrm{mm}^2$。\n$a_{\\mathrm{cell}} = 0.07\\,\\mu\\mathrm{m}^{2} = 0.07 \\times 10^{-6}\\,\\mathrm{mm}^{2} = 7 \\times 10^{-8}\\,\\mathrm{mm}^{2}$。\n已知条件是：$N = 4096$，$B_{\\mathrm{inst}} = 512\\,\\text{位}$，$B_{\\mathrm{meta}} = 32\\,\\text{位}$，$A_{\\mathrm{peri}} = 0.015\\,\\mathrm{mm}^{2}$。\n总位单元面积是：\n$$\nA_{\\mathrm{bits,mono}} = 4096 \\cdot (512 + 32) \\cdot (7 \\times 10^{-8}\\,\\mathrm{mm}^{2}) = 4096 \\cdot 544 \\cdot 7 \\times 10^{-8}\\,\\mathrm{mm}^{2} = 2228224 \\cdot 7 \\times 10^{-8}\\,\\mathrm{mm}^{2} = 0.15597568\\,\\mathrm{mm}^{2}\n$$\n单片式方案的总面积是：\n$$\nA_{\\mathrm{mono}} = 0.15597568\\,\\mathrm{mm}^{2} + 0.015\\,\\mathrm{mm}^{2} = 0.17097568\\,\\mathrm{mm}^{2}\n$$\n分数面积开销是：\n$$\n\\Delta A_{\\mathrm{frac}} = \\frac{0.015\\,\\mathrm{mm}^{2}}{0.17097568\\,\\mathrm{mm}^{2}} \\approx 0.0877317\n$$\n\n接下来，我们进行时序分析。目标周期时间为 $T_{\\mathrm{target}} = 1.10\\,\\mathrm{ns}$。\n单片式阶段时间为 $t_{\\mathrm{mono}} = t_{\\mathrm{arr}} + t_{\\mathrm{align,mono}}$。\n对齐和导向延迟为 $t_{\\mathrm{align,mono}} = t_{0,\\mathrm{mono}} + s_{\\mathrm{mono}} \\cdot W_{\\mathrm{mono}}$。\n给定 $t_{\\mathrm{arr}} = 0.45\\,\\mathrm{ns}$，$t_{0,\\mathrm{mono}} = 0.12\\,\\mathrm{ns}$，$s_{\\mathrm{mono}} = 1.2 \\times 10^{-3}\\,\\mathrm{ns/bit}$，以及 $W_{\\mathrm{mono}} = B_{\\mathrm{inst}} + B_{\\mathrm{meta}} = 512 + 32 = 544\\,\\text{位}$。\n$$\nt_{\\mathrm{align,mono}} = 0.12\\,\\mathrm{ns} + (1.2 \\times 10^{-3}\\,\\mathrm{ns/bit}) \\cdot (544\\,\\text{bits}) = 0.12\\,\\mathrm{ns} + 0.6528\\,\\mathrm{ns} = 0.7728\\,\\mathrm{ns}\n$$\n$$\nt_{\\mathrm{mono}} = 0.45\\,\\mathrm{ns} + 0.7728\\,\\mathrm{ns} = 1.2228\\,\\mathrm{ns}\n$$\n与目标相比，$t_{\\mathrm{mono}} = 1.2228\\,\\mathrm{ns}  T_{\\mathrm{target}} = 1.10\\,\\mathrm{ns}$。单片式方案未能满足时序要求。\n\n分离式阶段时间为 $t_{\\mathrm{split}} = t_{\\mathrm{arr}} + \\max\\!\\big(t_{\\mathrm{align,inst}},\\, t_{\\mathrm{align,meta}}\\big) + t_{\\mathrm{merge}}$。\n我们计算两条并行路径的延迟。\n对于指令路径：$W_{\\mathrm{inst}} = 512\\,\\text{位}$，$t_{0,\\mathrm{inst}} = 0.06\\,\\mathrm{ns}$，$s_{\\mathrm{inst}} = 1.0 \\times 10^{-3}\\,\\mathrm{ns/bit}$。\n$$\nt_{\\mathrm{align,inst}} = 0.06\\,\\mathrm{ns} + (1.0 \\times 10^{-3}\\,\\mathrm{ns/bit}) \\cdot (512\\,\\text{bits}) = 0.06\\,\\mathrm{ns} + 0.512\\,\\mathrm{ns} = 0.572\\,\\mathrm{ns}\n$$\n对于元数据路径：$W_{\\mathrm{meta}} = 32\\,\\text{位}$，$t_{0,\\mathrm{meta}} = 0.03\\,\\mathrm{ns}$，$s_{\\mathrm{meta}} = 0.5 \\times 10^{-3}\\,\\mathrm{ns/bit}$。\n$$\nt_{\\mathrm{align,meta}} = 0.03\\,\\mathrm{ns} + (0.5 \\times 10^{-3}\\,\\mathrm{ns/bit}) \\cdot (32\\,\\text{bits}) = 0.03\\,\\mathrm{ns} + 0.016\\,\\mathrm{ns} = 0.046\\,\\mathrm{ns}\n$$\n关键路径是两者中较长的一个：$\\max(t_{\\mathrm{align,inst}}, t_{\\mathrm{align,meta}}) = \\max(0.572\\,\\mathrm{ns}, 0.046\\,\\mathrm{ns}) = 0.572\\,\\mathrm{ns}$。\n考虑到 $t_{\\mathrm{merge}} = 0.03\\,\\mathrm{ns}$，分离式方案的总时间为：\n$$\nt_{\\mathrm{split}} = 0.45\\,\\mathrm{ns} + 0.572\\,\\mathrm{ns} + 0.03\\,\\mathrm{ns} = 1.052\\,\\mathrm{ns}\n$$\n与目标相比，$t_{\\mathrm{split}} = 1.052\\,\\mathrm{ns} \\le T_{\\mathrm{target}} = 1.10\\,\\mathrm{ns}$。分离式方案满足时序要求。\n\n由于单片式方案不满足目标周期时间（$1.2228\\,\\mathrm{ns}  1.10\\,\\mathrm{ns}$），而分离式方案满足（$1.052\\,\\mathrm{ns} \\le 1.10\\,\\mathrm{ns}$），因此需要将元数据分离到独立的SRAM中。\n\n问题要求在这种情况下给出 $\\Delta A_{\\mathrm{frac}}$ 的数值。我们计算出该值约为 $0.0877317$。四舍五入到四位有效数字得到 $0.08773$。\n如果不需要分离，答案将是 $0$。因为需要分离，所以答案是计算出的分数面积开销。", "answer": "$$\n\\boxed{0.08773}\n$$", "id": "3650627"}, {"introduction": "指令踪迹缓存的实际效益在很大程度上取决于它如何与处理器流水线交互，尤其是在发生分支预测错误等事件时。这个问题挑战你量化一种更智能的流水线恢复机制所带来的性能提升 [@problem_id:3650574]。通过比较一种在预测错误时丢弃整个踪迹的朴素策略，和一种能够挽救正确部分的更聪明的策略，你将更深入地理解流水线优化对于最大化前端组件效率的重要性。", "problem": "一个现代超标量处理器前端采用一种指令踪迹缓存 (ITC)，该缓存存储沿着预测的控制流跨越已采用分支的已解码指令（微操作）序列。考虑一个长度为 $L = 32$ 条指令的 ITC 踪迹行，其中恰好包含 $b = 4$ 个条件分支，分别出现在指令索引 $8$、$16$、$24$ 和 $32$ 处。前端取指带宽为 $R = 4$ 条指令/周期。追踪中的每个条件分支都被独立预测，误预测概率为 $p = 0.2$。流水线通过清空比第一个误预测分支更晚的指令，并将取指程序计数器重定向到正确的目标来处理误预测。\n\n在一个朴素的踪迹失效策略中，无论何时在取出的踪迹行内任何位置检测到误预测，整个踪迹行都会被判为无效并视为错误路径工作，因此即使是直到（并包括）第一个误预测分支的架构上正确的前缀，也需要在稍后走正确路径时被重新取指。相比之下，请提出一种选择性清空前缀保留策略：当在取出的踪迹行内检测到第一个误预测分支时，该策略在指令队列中保留该行直到（并包括）该分支的正确前缀，而只清空其后的更晚指令。这种补救措施避免了在正确路径上重新取指被保留的前缀。\n\n利用分支结果的独立性，对行内第一个误预测分支的位置进行建模。从第一性原理和明确的概率推理出发，推导相对于朴素策略，在一个 $L = 32$ 指令的踪迹行内，选择性清空前缀保留策略在每次误预测事件中节省的取指周期的期望值。将你的最终数值答案四舍五入至四位有效数字，并以周期为单位表示。", "solution": "问题陈述经过严格验证，确认有效。它在科学上基于计算机组成与体系结构的原理，是自包含、适定且客观的。唯一解所需的所有参数均已提供：踪迹长度 $L=32$ 条指令，分支数量 $b=4$，分支的具体指令索引 ($k_1=8, k_2=16, k_3=24, k_4=32$)，取指带宽 $R=4$ 条指令/周期，以及独立的分支误预测概率 $p=0.2$。两种策略（朴素失效策略 vs. 选择性清空前缀保留策略）定义清晰。目标是推导选择性清空策略在每次误预测事件中节省的取指周期的期望值，这是一个定义明确的数学问题。\n\n问题的核心是计算在踪迹行内发生误预测事件的条件下，节省的取指周期的期望值。\n\n首先，让我们量化特定结果下的节省量。节省是通过选择性清空策略无需重新取指直到（并包括）第一个误预测分支的正确指令前缀而实现的。朴素策略会使整行失效，从而强制后续重新取指这个正确的前缀。\n\n设四个条件分支表示为 $B_1, B_2, B_3, B_4$，分别位于指令索引 $k_1=8, k_2=16, k_3=24$ 和 $k_4=32$ 处。前端取指带宽为 $R=4$ 条指令/周期。\n\n如果第一个误预测发生在分支 $B_i$（位于索引 $k_i$ 处），则正确的前缀包含 $k_i$ 条指令。取指这 $k_i$ 条指令所需的取指周期数为 $\\lceil \\frac{k_i}{R} \\rceil$。该值代表了在此特定结果下，选择性清空策略节省的取指周期数 $S_i$。\n\n我们来计算每种可能的首次误预测情况下的节省量：\n- 如果首次误预测发生在 $B_1$（索引 $k_1=8$）：$S_1 = \\lceil \\frac{k_1}{R} \\rceil = \\lceil \\frac{8}{4} \\rceil = 2$ 周期。\n- 如果首次误预测发生在 $B_2$（索引 $k_2=16$）：$S_2 = \\lceil \\frac{k_2}{R} \\rceil = \\lceil \\frac{16}{4} \\rceil = 4$ 周期。\n- 如果首次误预测发生在 $B_3$（索引 $k_3=24$）：$S_3 = \\lceil \\frac{k_3}{R} \\rceil = \\lceil \\frac{24}{4} \\rceil = 6$ 周期。\n- 如果首次误预测发生在 $B_4$（索引 $k_4=32$）：$S_4 = \\lceil \\frac{k_4}{R} \\rceil = \\lceil \\frac{32}{4} \\rceil = 8$ 周期。\n\n接下来，我们对这些结果中每一种的概率进行建模。各个分支是独立的，每个分支的误预测概率为 $p=0.2$。正确预测的概率是 $1-p = 0.8$。\n\n设 $E_i$ 为首次误预测发生在分支 $B_i$ 的事件。\n- 要使 $E_1$ 发生，$B_1$ 必须被误预测。其概率为 $P(E_1) = p$。\n- 要使 $E_2$ 发生，$B_1$ 必须预测正确而 $B_2$ 必须被误预测。其概率为 $P(E_2) = (1-p)p$。\n- 要使 $E_3$ 发生，$B_1$ 和 $B_2$ 必须预测正确而 $B_3$ 必须被误预测。其概率为 $P(E_3) = (1-p)^2 p$。\n- 要使 $E_4$ 发生，$B_1, B_2, B_3$ 必须预测正确而 $B_4$ 必须被误预测。其概率为 $P(E_4) = (1-p)^3 p$。\n\n问题要求的是*每次误预测事件*节省的周期数的期望值。这是一个条件期望。设 $S$ 为代表节省周期数的随机变量，设 $M$ 为踪迹行内至少发生一次误预测的事件。我们需要计算 $E[S|M]$。\n\n事件 $M$ 是事件 $E_1, E_2, E_3, E_4$ 的不交并。因此，其概率为：\n$$P(M) = P(E_1) + P(E_2) + P(E_3) + P(E_4)$$\n或者，$M$ 是所有分支都预测正确这一事件的补集。对于 $b=4$ 个分支，没有误预测的概率是 $(1-p)^b$。\n$$P(M) = 1 - (1-p)^b = 1 - (1-p)^4$$\n\n在发生误预测事件的条件下，节省的期望值由下式给出：\n$$E[S|M] = \\sum_{i=1}^{4} S_i P(\\text{first miss is at } B_i | M)$$\n使用条件概率的定义，$P(E_i|M) = \\frac{P(E_i \\cap M)}{P(M)}$。由于事件 $E_i$ 蕴含了事件 $M$，它们的交集就是 $E_i$。因此，$P(E_i|M) = \\frac{P(E_i)}{P(M)}$。\n\n条件期望变为：\n$$E[S|M] = \\sum_{i=1}^{4} S_i \\frac{P(E_i)}{P(M)} = \\frac{1}{P(M)} \\sum_{i=1}^{4} S_i P(E_i)$$\n这可以理解为每次踪迹取指节省的周期总期望值，除以一次踪迹取指导致误预测的概率。\n\n我们来计算分子，也就是每次踪迹的总期望节省量 $E[S]$：\n$$E[S] = \\sum_{i=1}^{4} S_i P(E_i) = S_1 p + S_2 (1-p)p + S_3 (1-p)^2 p + S_4 (1-p)^3 p$$\n$$E[S] = p \\sum_{i=1}^{4} S_i (1-p)^{i-1}$$\n代入给定值 $p=0.2$ 和 $1-p=0.8$：\n$$E[S] = 0.2 \\left( S_1 (0.8)^0 + S_2 (0.8)^1 + S_3 (0.8)^2 + S_4 (0.8)^3 \\right)$$\n$$E[S] = 0.2 \\left( 2 \\cdot 1 + 4 \\cdot 0.8 + 6 \\cdot 0.64 + 8 \\cdot 0.512 \\right)$$\n$$E[S] = 0.2 \\left( 2 + 3.2 + 3.84 + 4.096 \\right)$$\n$$E[S] = 0.2 (13.136) = 2.6272 \\text{ cycles}$$\n\n现在，我们来计算分母 $P(M)$：\n$$P(M) = 1 - (0.8)^4 = 1 - 0.4096 = 0.5904$$\n最后，我们计算条件期望：\n$$E[S|M] = \\frac{E[S]}{P(M)} = \\frac{2.6272}{0.5904}$$\n$$E[S|M] \\approx 4.4498644986... \\text{ cycles}$$\n\n问题要求答案四舍五入到四位有效数字。前四位有效数字是 $4, 4, 4, 9$。第五位数字是 $8$，所以我们将第四位数字向上取整。\n$$E[S|M] \\approx 4.450 \\text{ cycles}$$", "answer": "$$\\boxed{4.450}$$", "id": "3650574"}]}