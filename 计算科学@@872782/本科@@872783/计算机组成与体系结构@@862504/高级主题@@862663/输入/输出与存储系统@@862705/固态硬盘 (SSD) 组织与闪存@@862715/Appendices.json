{"hands_on_practices": [{"introduction": "计算机中的每一个操作都会消耗能量。在固态硬盘（SSD）中，读取、编程（写入）和擦除这些基本操作的能量特性差异巨大。本练习将帮助您量化这些差异，并理解典型工作负载的能耗是如何由这些操作的组合决定的。这是领会闪存物理限制的至关重要的第一步。[@problem_id:3678859]", "problem": "固态硬盘 (SSD) 使用与非 (NAND) 闪存单元，执行三种基本闪存操作：读取、编程（写入）和块擦除。考虑一个由稳压电源供电的独立 NAND 芯片。对于每种操作，在其活动期间，电源电压和平均电流消耗近似恒定，而在活动期之外则可忽略不计。将瞬时电功率视为电压和电流的乘积，并将操作的能量视为功率在其持续时间上的时间积分。\n\n给定一个特定 NAND 芯片在标称条件下的各操作参数如下：\n- 读取：电源电压 $V_{r} = 3.3$ V，平均电流 $I_{r} = 18$ mA，操作时间 $t_{r} = 80$ 微秒。\n- 编程（写入）：电源电压 $V_{w} = 3.3$ V，平均电流 $I_{w} = 28$ mA，操作时间 $t_{w} = 900$ 微秒。\n- 擦除：电源电压 $V_{e} = 3.3$ V，平均电流 $I_{e} = 45$ mA，操作时间 $t_{e} = 2.5$ 毫秒。\n\n假设存在一个大量的闪存操作流，其中任一操作为读取的概率为 $p_{r} = 0.70$，为编程的概率为 $p_{w} = 0.28$，为擦除的概率为 $p_{e} = 0.02$，且 $p_{r} + p_{w} + p_{e} = 1$。这些操作根据这些概率独立同分布。将每次输入/输出 (I/O) 的能量 $E_{io}$ 定义为从该分布中随机抽取一个闪存操作所消耗的期望能量。\n\n仅使用电功率和能量的基本定义以及离散随机变量的期望定义，推导出 $E_{io}$ 关于给定量的表达式，并计算其数值。将最终数值答案四舍五入至三位有效数字。用微焦耳 (µJ) 表示最终能量。", "solution": "该问题陈述已经过严格验证，被认为是有效的。它以电学和概率论原理为科学基础，问题设定明确，给出的条件完整且一致，并以客观、无歧义的语言表达。\n\n该问题要求推导和计算 NAND 闪存芯片每次 I/O 操作消耗的期望能量 $E_{io}$。推导将从基本定义开始。\n\n首先，我们定义电能。瞬时电功率 $P$ 是电压 $V$ 和电流 $I$ 的乘积，即 $P = V \\cdot I$。在某个时间间隔内消耗的能量 $E$ 是功率的时间积分。问题陈述指出，对于每种操作，在其活动期间，电源电压和平均电流消耗近似恒定。因此，对于一个持续时间为 $t_k$、电压为 $V_k$、平均电流为 $I_k$ 的 $k$ 型单次操作，其消耗的能量 $E_k$ 为：\n$$E_k = \\int_{0}^{t_k} P(t) dt = \\int_{0}^{t_k} (V_k \\cdot I_k) dt = V_k \\cdot I_k \\cdot t_k$$\n\n使用这个基本关系，我们可以表示三种基本闪存操作各自的能量：\n1.  读取操作能量 $E_r$：\n    $$E_r = V_r I_r t_r$$\n2.  编程（写入）操作能量 $E_w$：\n    $$E_w = V_w I_w t_w$$\n3.  擦除操作能量 $E_e$：\n    $$E_e = V_e I_e t_e$$\n\n问题将每次 I/O 的能量 $E_{io}$ 定义为一次随机选择的闪存操作所消耗的期望能量。操作类型是一个离散随机变量，其能量从集合 $\\{E_r, E_w, E_e\\}$ 中抽取，对应的概率为 $\\{p_r, p_w, p_e\\}$。根据离散随机变量期望值的定义，$E_{io}$ 是各项操作能量的加权平均值，权重为各自的概率：\n$$E_{io} = \\mathbb{E}[\\text{Energy}] = p_r E_r + p_w E_w + p_e E_e$$\n\n将 $E_r$、$E_w$ 和 $E_e$ 的表达式代入期望公式，我们得到 $E_{io}$ 的通用符号表达式：\n$$E_{io} = p_r(V_r I_r t_r) + p_w(V_w I_w t_w) + p_e(V_e I_e t_e)$$\n问题陈述所有操作均由单一稳压电源供电，因此我们可以假设 $V_r = V_w = V_e = V_{sup} = 3.3 \\text{ V}$。表达式简化为：\n$$E_{io} = V_{sup} (p_r I_r t_r + p_w I_w t_w + p_e I_e t_e)$$\n\n我们现在进行数值计算。给定的参数是：\n- 电源电压: $V_{sup} = 3.3 \\text{ V}$\n- 读取参数: $p_r = 0.70$, $I_r = 18 \\text{ mA} = 1.8 \\times 10^{-2} \\text{ A}$, $t_r = 80 \\text{ µs} = 8.0 \\times 10^{-5} \\text{ s}$\n- 编程参数: $p_w = 0.28$, $I_w = 28 \\text{ mA} = 2.8 \\times 10^{-2} \\text{ A}$, $t_w = 900 \\text{ µs} = 9.0 \\times 10^{-4} \\text{ s}$\n- 擦除参数: $p_e = 0.02$, $I_e = 45 \\text{ mA} = 4.5 \\times 10^{-2} \\text{ A}$, $t_e = 2.5 \\text{ ms} = 2.5 \\times 10^{-3} \\text{ s}$\n\n首先，我们计算每次独立操作的能量，单位为焦耳 (J)：\n$$E_r = (3.3 \\text{ V}) \\cdot (1.8 \\times 10^{-2} \\text{ A}) \\cdot (8.0 \\times 10^{-5} \\text{ s}) = 4.752 \\times 10^{-6} \\text{ J}$$\n$$E_w = (3.3 \\text{ V}) \\cdot (2.8 \\times 10^{-2} \\text{ A}) \\cdot (9.0 \\times 10^{-4} \\text{ s}) = 8.316 \\times 10^{-5} \\text{ J}$$\n$$E_e = (3.3 \\text{ V}) \\cdot (4.5 \\times 10^{-2} \\text{ A}) \\cdot (2.5 \\times 10^{-3} \\text{ s}) = 3.7125 \\times 10^{-4} \\text{ J}$$\n\n接下来，我们计算 $E_{io}$ 的加权和，单位为焦耳：\n$$E_{io} = p_r E_r + p_w E_w + p_e E_e$$\n$$E_{io} = (0.70)(4.752 \\times 10^{-6} \\text{ J}) + (0.28)(8.316 \\times 10^{-5} \\text{ J}) + (0.02)(3.7125 \\times 10^{-4} \\text{ J})$$\n$$E_{io} = (3.3264 \\times 10^{-6} \\text{ J}) + (2.32848 \\times 10^{-5} \\text{ J}) + (7.425 \\times 10^{-6} \\text{ J})$$\n为了对这些值求和，我们将它们归一化到共同的 10 的幂次，例如 $10^{-6}$：\n$$E_{io} = (3.3264 \\times 10^{-6} \\text{ J}) + (23.2848 \\times 10^{-6} \\text{ J}) + (7.425 \\times 10^{-6} \\text{ J})$$\n$$E_{io} = (3.3264 + 23.2848 + 7.425) \\times 10^{-6} \\text{ J}$$\n$$E_{io} = 34.0362 \\times 10^{-6} \\text{ J}$$\n\n问题要求最终答案以微焦耳 (µJ) 表示。因为 $1 \\text{ µJ} = 10^{-6} \\text{ J}$，所以可以直接转换：\n$$E_{io} = 34.0362 \\text{ µJ}$$\n\n最后，我们根据要求将结果四舍五入到三位有效数字：\n$$E_{io} \\approx 34.0 \\text{ µJ}$$", "answer": "$$\\boxed{34.0}$$", "id": "3678859"}, {"introduction": "NAND闪存的一个关键限制是数据无法原地覆盖，且必须以页（page）为单位进行写入。在处理小尺寸更新时（这在许多工作负载中很常见），这一限制带来了巨大挑战。本练习将探讨由小尺寸写入导致的“读取-修改-写入”周期，并让您推导出其所带来的基本开销，从而揭示SSD控制器为何要竭力避免这种惩罚。[@problem_id:3678863]", "problem": "固态硬盘 (SSD) 使用浮栅与非 (NAND) 闪存，其存储单元被组织成大小为 $P$ 字节的页，并由闪存转换层 (FTL) 管理异地更新。在 NAND 闪存中，页无法被原地覆写；任何小于整页的修改都需要读取现有页面，在控制器内存中构建更新后的页面镜像，然后编程（写入）一个新的物理页。考虑一个由大小为 $s$ 字节的小型主机写入组成的工作负载，其中 $s \\ll P$。为了缓解由 $s \\ll P$ 引起的写入偏斜，控制器采用子页仿真技术：它将每个页划分为 $m$ 个大小相等的子页，每个子页大小为 $P/m$，并配置 $m$ 使得 $m = P/s$（假设 $s$ 能整除 $P$），在控制器内存中为一个逻辑页累积 $m$ 次子页更新，然后通过编程一个新页来提交结果。假设对于每个逻辑页，在这 $m$ 次小写入共同更新了完整的 $P$ 字节之后，控制器才会刷写该页。\n\n将控制器和闪存的操作时间建模如下：\n- 整页读取延迟为 $t_r$ 秒。\n- 整页编程延迟为 $t_p$ 秒。\n- 控制器内每字节内存复制时间为 $t_b$ 秒/字节，用于在 RAM 中组装页面镜像。\n- 每字节纠错码 (ECC) 计算时间为 $t_e$ 秒/字节，在编程前应用于页面镜像。\n\n假设理想的、整页对齐的写入（$s = P$）的基准如下：控制器仅使用主机提供的数据来构建和编程一个新页，无需读取页面；此基准下每页的总控制器时间是单次编程时间与对 $P$ 字节执行的每字节操作时间之和。在所述的针对 $s \\ll P$ 的子页仿真下，控制器在对页面的第一次小写入时执行一次整页读取，在 RAM 中累积 $m$ 次写入，并在刷写页面时执行一次整页编程。仅使用这些假设和 NAND 闪存无法原地覆写页面的基本约束，推导 $O_c$ 的封闭形式表达式。$O_c$ 定义为在子页仿真下由于写入偏斜导致的每主机字节的额外控制器开销，即子页仿真情景与理想整页对齐写入情景下每主机字节控制器时间的差值。请用符号形式（无数值近似）表示你的最终答案，单位为秒/字节。", "solution": "此题要求我们推导在特定子页仿真方案下，相较于理想的整页写入情景，每主机字节的额外控制器开销 $O_c$ 的封闭形式表达式。推导过程将首先为每种情景建立每主机字节的控制器时间，然后计算它们的差值。\n\n我们首先定义理想的、整页对齐写入情景下的每主机字节控制器时间。我们将其表示为 $C_{ideal}$。题目指出，对于一次理想写入，主机提供一整页大小为 $P$ 字节的数据。控制器操作包括：\n1.  从主机提供的数据构建新页。这涉及对 $P$ 字节进行内存复制操作。所用时间为 $P \\cdot t_b$。\n2.  为 $P$ 字节的页面镜像计算纠错码 (ECC)。所用时间为 $P \\cdot t_e$。\n3.  将新页编程到闪存中。所用时间为 $t_p$。\n题目说明在这种理想情况下不需要读取页面。\n\n处理一次大小为 $P$ 字节的理想写入的总控制器时间 $T_{ideal}$ 是这些操作时间的总和：\n$$T_{ideal} = t_p + P \\cdot t_b + P \\cdot t_e$$\n此操作中处理的主机数据量为 $P$ 字节。因此，每主机字节的控制器时间 $C_{ideal}$ 为：\n$$C_{ideal} = \\frac{T_{ideal}}{P} = \\frac{t_p + P \\cdot t_b + P \\cdot t_e}{P} = \\frac{t_p}{P} + t_b + t_e$$\n\n接下来，我们分析针对大小为 $s$ 字节（其中 $s \\ll P$）的小型写入的子页仿真情景。题目描述了一个逻辑页的完整操作周期，该周期涉及累积 $m$ 次小写入，其中 $m = P/s$。这样一个周期内处理的主机数据总量为 $m \\cdot s = (P/s) \\cdot s = P$ 字节。题目规定了这整个周期的操作序列：\n1.  在对该逻辑页的第一次小写入时，控制器执行一次整页读取以获取页面的当前版本。此操作的时间为 $t_r$。\n2.  控制器随后在其内部内存中累积 $m$ 次子页更新。在整个周期中，总共有 $P$ 字节来自主机的新数据被复制到页缓冲区中。这项内存构建工作的总时间为 $P \\cdot t_b$。\n3.  第 $m$ 次写入后，页面镜像完成。控制器对此最终的 $P$ 字节镜像计算 ECC。所用时间为 $P \\cdot t_e$。\n4.  最后，控制器执行一次整页编程，将更新后的页面提交到闪存中的一个新物理位置。此操作的时间为 $t_p$。\n\n处理一个完整周期（对应 $P$ 字节的主机数据）的总控制器时间 $T_{subpage}$ 是此系列操作时间的总和：\n$$T_{subpage} = t_r + t_p + P \\cdot t_b + P \\cdot t_e$$\n此周期内处理的主机数据总量为 $P$ 字节。因此，子页仿真情景下的每主机字节控制器时间 $C_{subpage}$ 为：\n$$C_{subpage} = \\frac{T_{subpage}}{P} = \\frac{t_r + t_p + P \\cdot t_b + P \\cdot t_e}{P} = \\frac{t_r}{P} + \\frac{t_p}{P} + t_b + t_e$$\n\n题目要求计算 $O_c$，即因写入偏斜导致的每主机字节的额外控制器开销。它被定义为子页仿真情景与理想情景下每主机字节控制器时间的差值。\n$$O_c = C_{subpage} - C_{ideal}$$\n代入上面推导出的表达式：\n$$O_c = \\left( \\frac{t_r}{P} + \\frac{t_p}{P} + t_b + t_e \\right) - \\left( \\frac{t_p}{P} + t_b + t_e \\right)$$\n$\\frac{t_p}{P}$、$t_b$ 和 $t_e$ 项相互抵消，得到开销的最终表达式：\n$$O_c = \\frac{t_r}{P}$$\n这个结果表明，每字节的额外开销是单次必需的页面读取延迟 ($t_r$) 分摊到页内所有字节（$P$）上。参数 $s$ 和 $m$ 定义了需要读-改-写周期的条件，但在所述的特定聚合方案下，每字节的开销与小写入的确切大小无关。单位为秒/字节，符合要求。", "answer": "$$\\boxed{\\frac{t_r}{P}}$$", "id": "3678863"}, {"introduction": "“异地更新”（out-of-place update）机制虽然解决了无法原地覆写的问题，但会导致无效（陈旧）数据页的累积。清理这些页面的过程称为垃圾回收（garbage collection），它会引入额外的写入，这种现象被称为写放大（Write Amplification, WA）。本练习提供了一个概率模型来计算写放大，将文件系统的更新模式与SSD的效率和耐久度直接联系起来。[@problem_id:3678850]", "problem": "考虑一个固态硬盘 (SSD)，其闪存转换层 (FTL) 执行异地更新：页面重写会将新数据写入一个空闲页面，并将旧页面标记为无效，而擦除操作则作用于整个块。一个擦除块包含 $B$ 个页面。假设一个元数据密集的文件系统块最后一次被完全写入，因此所有 $B$ 个页面最初都是有效的，并存储其逻辑页面的最新版本。系统经历了 $R$ 个连续的文件系统更新周期。在每个周期中，该块中比例为 $p_s$（其中 $0  p_s \\leq 1$）的页面被均匀随机且独立于先前周期地选择出来，这些被选中的页面会使用异地更新进行重写。这些重写操作会在别处分配新的物理页面，并将原始块中的旧副本标记为无效。\n\n在 $R$ 个周期之后，垃圾回收会擦除原始块，以便其空间可以被重用。在擦除之前，原始块中任何仍然持有最新版本（即，保持有效）的页面都必须被迁移（复制）到新的空闲页面以保存数据。假设没有其他导致该块失效或重写的来源，并忽略所描述更新之外的磨损均衡副作用。\n\n从逻辑写入次数是用户发起的页面重写次数，以及写入放大 (WA) 是设备执行的总物理页面写入次数与总逻辑页面写入次数的比率这两个基本定义出发，推导一个解析表达式，用于表示由这 $R$ 个更新周期及随后对该块的垃圾回收所引起的 WA，该表达式应为 $p_s$、$R$ 和 $B$ 的函数。将您的最终答案表示为一个封闭形式的符号表达式。无需四舍五入，也不涉及物理单位。", "solution": "该问题要求针对固态硬盘 (SSD) 中单个擦除块的特定场景，推导写入放大 (WA) 的解析表达式。验证过程确认该问题定义明确、有科学依据，并包含进行形式化推导所需的所有必要信息。\n\n写入放大 (WA) 定义为 SSD 执行的总物理页面写入次数与主机系统请求的总逻辑页面写入次数的比率。\n$$WA = \\frac{W_{physical}}{W_{logical}}$$\n其中，$W_{physical}$ 是物理页面写入的总次数，$W_{logical}$ 是逻辑页面写入的总次数。\n\n为了求出 WA，我们必须计算所述过程中 $W_{logical}$ 和 $W_{physical}$ 的值。该过程涉及 $R$ 个更新周期，随后是对原始块的垃圾回收。\n\n首先，我们确定逻辑写入的总次数 $W_{logical}$。\n问题陈述一个擦除块包含 $B$ 个页面。在 $R$ 个更新周期中的每一个周期，块中比例为 $p_s$ 的页面被重写。这些用户发起的重写构成了逻辑写入。单个周期中重写的页面数量是 $p_s \\times B$。由于有 $R$ 个独立的周期，逻辑写入的总次数为：\n$$W_{logical} = R \\times (p_s B) = R p_s B$$\n\n接下来，我们确定物理写入的总次数 $W_{physical}$。这些写入发生在两个不同的阶段：\n1.  应用写入 ($W_{app}$)：在 $R$ 个更新周期中，将新数据写入空闲页面的操作。\n2.  垃圾回收写入 ($W_{gc}$)：在原始块被擦除之前，迁移有效（活动）数据时发生的写入操作。\n\n物理写入的总次数是这两个部分的总和：\n$$W_{physical} = W_{app} + W_{gc}$$\n\n我们来计算每个组成部分。\n\n应用写入的次数 $W_{app}$ 直接对应于异地更新。每当一个逻辑页面被重写时，就会发生一次物理写入，以将新数据存储到一个新的空闲页面上。因此，应用写入的次数等于逻辑写入的次数。\n$$W_{app} = W_{logical} = R p_s B$$\n\n垃圾回收写入的次数 $W_{gc}$ 等于在 $R$ 个更新周期完成后，原始块中仍然有效的页面数量。在块被擦除之前，这些有效页面必须被复制（迁移）到一个新的位置。为了求出这个数量，我们分析单个页面在 $R$ 个周期中的状态。\n\n最初，块中所有 $B$ 个页面都是有效的。在每个周期中，如果一个页面被选中进行重写，它就会被置为无效。问题陈述页面是均匀随机选择的。这可以解释为，在任何给定的周期中，每个页面都有一个独立的概率 $p_s$ 被选中进行重写。\n\n一个特定页面在一个周期内被选中重写的概率是 $p_s$。\n因此，一个特定页面在单个周期内*不*被选中重写的概率是 $1 - p_s$。\n\n一个页面在 $R$ 个周期后在原始块中保持有效，当且仅当它在所有 $R$ 个周期中从未被选中进行重写。由于各个周期是独立的，我们可以通过将它在每个周期中不被选中的概率相乘，来求得一个页面保持有效的概率。\n$$P(\\text{page remains valid after } R \\text{ cycles}) = (1 - p_s)^R$$\n\n垃圾回收写入的次数 $W_{gc}$ 是块中有效页面的期望数量。根据期望的线性性质，这个数量等于总页面数 $B$ 乘以单个页面保持有效的概率。\n$$W_{gc} = B \\times P(\\text{page remains valid after } R \\text{ cycles}) = B (1 - p_s)^R$$\n\n现在我们可以计算物理写入的总次数 $W_{physical}$：\n$$W_{physical} = W_{app} + W_{gc} = R p_s B + B (1 - p_s)^R$$\n\n最后，我们通过计算总物理写入与总逻辑写入的比率来计算写入放大：\n$$WA = \\frac{W_{physical}}{W_{logical}} = \\frac{R p_s B + B (1 - p_s)^R}{R p_s B}$$\n\n我们可以通过将分子中的每一项除以分母来简化此表达式：\n$$WA = \\frac{R p_s B}{R p_s B} + \\frac{B (1 - p_s)^R}{R p_s B}$$\n$$WA = 1 + \\frac{(1 - p_s)^R}{R p_s}$$\n\n这就是写入放大的最终封闭形式符号表达式。虽然问题要求将表达式表示为 $p_s$、$R$ 和 $B$ 的函数，但块大小 $B$ 在最终的比率中被消掉了。这表明，在此模型的假设下，与清理此块相关的 WA 与块内的页面数量无关。结果仍然是所有三个变量的函数，尽管它对 $B$ 的依赖是平凡的。", "answer": "$$\\boxed{1 + \\frac{(1 - p_s)^R}{R p_s}}$$", "id": "3678850"}]}