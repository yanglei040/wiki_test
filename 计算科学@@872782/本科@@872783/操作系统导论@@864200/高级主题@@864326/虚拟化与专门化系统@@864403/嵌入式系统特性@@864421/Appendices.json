{"hands_on_practices": [{"introduction": "嵌入式系统的核心是实时操作系统（RTOS），而其多任务处理能力并非没有代价。上下文切换作为任务调度的基本操作，会消耗宝贵的CPU周期。本练习将指导你如何量化这种开销，并计算其在系统总负载中的占比，这是进行任何性能分析和优化的关键第一步。[@problem_id:3638732]", "problem": "一个嵌入式控制器，在一颗中央处理器（CPU）上运行一个抢占式固定优先级实时操作系统（RTOS）。该控制器提供一个周期计数器，每个核心时钟周期递增一次。可以在软件中紧邻上下文切换前后读取该周期计数器，以经验性地确定在切换运行线程时操作系统所花费的周期数。在该平台上的测量揭示了每次切换周期计数的两种可重复模式：$c_{h} = 420$ 周期的缓存命中路径和 $c_{c} = 900$ 周期的缓存未命中路径。在稳态操作中，缓存命中路径出现的概率为 $p_{h} = 0.75$，缓存未命中路径出现的概率为 $p_{c} = 0.25$。CPU 时钟频率为 $f_{\\mathrm{clk}} = 168 \\times 10^{6}\\ \\mathrm{Hz}$。假设每次运行任务的身份变化，包括与空闲任务之间的转换，都会产生恰好一次上下文切换，其成本分布如上所述。忽略所有其他来源的开销。\n\n一组由三个独立的周期性任务组成，采用速率单调优先级分配（周期越短，优先级越高）进行调度。它们的周期和最坏情况执行时间（不包括操作系统开销）如下：\n- 任务 $\\tau_{1}$：周期 $T_{1} = 2\\,\\mathrm{ms}$，执行时间 $C_{1} = 0.2\\,\\mathrm{ms}$，\n- 任务 $\\tau_{2}$：周期 $T_{2} = 5\\,\\mathrm{ms}$，执行时间 $C_{2} = 0.7\\,\\mathrm{ms}$，\n- 任务 $\\tau_{3}$：周期 $T_{3} = 10\\,\\mathrm{ms}$，执行时间 $C_{3} = 1.6\\,\\mathrm{ms}$。\n\n假设完全抢占式调度、无滴答操作（调度仅在抢占当前任务的作业释放时或作业完成时发生），以及所有任务在时间 $t = 0$ 时最坏情况同步释放。空闲任务始终以最低优先级就绪。\n\n仅使用以下基本关系：(i) 时间等于周期数除以频率，以及 (ii) 在一个区间内的处理器利用率等于该区间内用于执行的时间分数，确定在上述调度下，一个超周期内用于执行上下文切换的处理器时间的期望分数。将最终答案表示为不带百分号的小数，并四舍五入到四位有效数字。", "solution": "为了确定用于上下文切换的处理器时间的期望分数，我们将其表示为 $U_{sw}$。该值定义为在一个超周期 $H$ 内，用于上下文切换的总期望时间除以超周期的持续时间。\n$$U_{sw} = \\frac{N_{sw} \\times E[T_{sw}]}{H}$$\n其中 $N_{sw}$ 是超周期内的总上下文切换次数，$E[T_{sw}]$ 是单次上下文切换的期望时间。\n\n解题步骤如下：\n\n**1. 计算单次上下文切换的期望时间 $E[T_{sw}]$**\n单次切换的期望周期数 $E[C_{sw}]$ 是缓存命中和未命中两种情况的加权平均值：\n$$E[C_{sw}] = c_{h} p_{h} + c_{c} p_{c} = (420 \\times 0.75) + (900 \\times 0.25) = 315 + 225 = 540 \\text{ 周期}$$\n单次上下文切换的期望时间 $E[T_{sw}]$ 是期望周期数除以时钟频率 $f_{\\mathrm{clk}}$：\n$$E[T_{sw}] = \\frac{E[C_{sw}]}{f_{\\mathrm{clk}}} = \\frac{540}{168 \\times 10^{6}} \\text{ s}$$\n\n**2. 确定超周期 $H$**\n超周期是所有任务周期的最小公倍数 (LCM)：\n$$H = \\mathrm{lcm}(T_{1}, T_{2}, T_{3}) = \\mathrm{lcm}(2, 5, 10) = 10\\,\\mathrm{ms}$$\n\n**3. 计算超周期内的上下文切换次数 $N_{sw}$**\n我们通过模拟速率单调抢占式调度来追踪一个超周期（从 $t=0$ 到 $t=10\\,\\mathrm{ms}$）内的执行过程。每当运行中的任务发生改变时，就计为一次上下文切换。\n- $t=0$: 所有任务释放。空闲任务被 $\\tau_{1}$（最高优先级）抢占。**切换 1**: 空闲 $\\rightarrow \\tau_{1}$。\n- $t=0.2\\,\\mathrm{ms}$: $\\tau_{1}$ 完成。$\\tau_{2}$ 成为最高优先级的就绪任务。**切换 2**: $\\tau_{1} \\rightarrow \\tau_{2}$。\n- $t=0.9\\,\\mathrm{ms}$: $\\tau_{2}$ 完成。$\\tau_{3}$ 成为最高优先级的就绪任务。**切换 3**: $\\tau_{2} \\rightarrow \\tau_{3}$。\n- $t=2.0\\,\\mathrm{ms}$: $\\tau_{1}$ 新作业释放，抢占 $\\tau_{3}$。**切换 4**: $\\tau_{3} \\rightarrow \\tau_{1}$。\n- $t=2.2\\,\\mathrm{ms}$: $\\tau_{1}$ 完成。被抢占的 $\\tau_{3}$ 恢复执行。**切换 5**: $\\tau_{1} \\rightarrow \\tau_{3}$。\n- $t=2.7\\,\\mathrm{ms}$: $\\tau_{3}$ 完成（总执行时间 $1.6\\,\\mathrm{ms}$）。无其他就绪任务，空闲任务运行。**切换 6**: $\\tau_{3} \\rightarrow$ 空闲。\n- $t=4.0\\,\\mathrm{ms}$: $\\tau_{1}$ 新作业释放，抢占空闲任务。**切换 7**: 空闲 $\\rightarrow \\tau_{1}$。\n- $t=4.2\\,\\mathrm{ms}$: $\\tau_{1}$ 完成。空闲任务运行。**切换 8**: $\\tau_{1} \\rightarrow$ 空闲。\n- $t=5.0\\,\\mathrm{ms}$: $\\tau_{2}$ 新作业释放，抢占空闲任务。**切换 9**: 空闲 $\\rightarrow \\tau_{2}$。\n- $t=5.7\\,\\mathrm{ms}$: $\\tau_{2}$ 完成。空闲任务运行。**切换 10**: $\\tau_{2} \\rightarrow$ 空闲。\n- $t=6.0\\,\\mathrm{ms}$: $\\tau_{1}$ 新作业释放，抢占空闲任务。**切换 11**: 空闲 $\\rightarrow \\tau_{1}$。\n- $t=6.2\\,\\mathrm{ms}$: $\\tau_{1}$ 完成。空闲任务运行。**切换 12**: $\\tau_{1} \\rightarrow$ 空闲。\n- $t=8.0\\,\\mathrm{ms}$: $\\tau_{1}$ 新作业释放，抢占空闲任务。**切换 13**: 空闲 $\\rightarrow \\tau_{1}$。\n- $t=8.2\\,\\mathrm{ms}$: $\\tau_{1}$ 完成。空闲任务运行。**切换 14**: $\\tau_{1} \\rightarrow$ 空闲。\n- $t=10.0\\,\\mathrm{ms}$: 超周期结束。\n\n一个超周期内的总上下文切换次数为 $N_{sw} = 14$。\n\n**4. 最终计算**\n将以上数值代入公式：\n$$U_{sw} = \\frac{N_{sw} \\times E[T_{sw}]}{H} = \\frac{14 \\times \\left(\\frac{540}{168 \\times 10^{6}}\\right)}{10 \\times 10^{-3}}$$\n$$U_{sw} = \\frac{14 \\times 540}{(168 \\times 10^{6}) \\times (10 \\times 10^{-3})} = \\frac{7560}{168 \\times 10^{4}} = \\frac{7560}{1,680,000}$$\n$$U_{sw} = 0.0045$$\n问题要求答案是一个四舍五入到四位有效数字的小数。\n$$0.004500$$", "answer": "$$\\boxed{0.004500}$$", "id": "3638732"}, {"introduction": "在资源受限的嵌入式系统中，内存管理，尤其是堆栈空间的管理，至关重要。堆栈溢出是导致系统崩溃的常见原因，因此必须在设计阶段就确保有足够的堆栈空间。本练习将演示一种关键的安全分析技术：通过考虑最坏情况下的中断嵌套，精确计算所需的最大堆栈深度，从而防止灾难性故障。[@problem_id:3638740]", "problem": "一个单核微控制器运行一个抢占式实时操作系统，该系统具有固定优先级的中断处理和一个统一堆栈：当前运行的任务和任何抢占它的中断服务程序（ISR）的帧都放置在同一个后进先出的堆栈上。在任何时刻，实时堆栈内容都是（从基底到顶部）被中断任务的实时帧，后面依次跟着任何嵌套ISR的帧，按它们到达的顺序排列，最近到达的ISR在最顶端。假设任何地方都没有递归，每个ISR都是不可重入的，并且ISR内部的临界区仅在相对于抢占而言可忽略不计的时间内屏蔽同等或更低优先级的中断。没有单独的中断专用堆栈，也没有内存保护单元。\n\n给定以下系统特性和测量值：\n- 当前运行的任务在第一个中断可能到达前的瞬间，测得的最坏情况实时堆栈使用量为 $S_{\\text{task}} = 1408$ 字节。\n- 共有 $4$ 个具有固定且不同优先级的ISR。将它们表示为 $\\text{ISR}_{1}$（最高优先级）、$\\text{ISR}_{2}$、$\\text{ISR}_{3}$ 和 $\\text{ISR}_{4}$（最低优先级）。工具链的堆栈分析器报告了每个ISR在活动时（包括其进入/退出代码、寄存器保存、局部变量及其任何内部调用帧）相对于其调用者帧已在堆栈上的额外堆栈使用量：\n  - $\\text{ISR}_{1}$ 为 $\\Delta S_{1} = 224$ 字节，\n  - $\\text{ISR}_{2}$ 为 $\\Delta S_{2} = 176$ 字节，\n  - $\\text{ISR}_{3}$ 为 $\\Delta S_{3} = 144$ 字节，\n  - $\\text{ISR}_{4}$ 为 $\\Delta S_{4} = 128$ 字节。\n- 中断控制器允许与这些优先级一致的完全抢占。在最坏情况下，一个较低优先级的ISR在运行时，可能会被任何在其运行期间到达的、优先级严格更高的ISR相继抢占。假设中断到达可以以对抗性的方式排列，以在满足这些优先级的前提下最大化嵌套深度。\n- 为检测罕见的溢出并允许使用调试器金丝雀（canaries），工程策略规定，在最大实时使用量之上必须有一个固定的 $128$ 字节的未触及保护带。\n\n仅使用以下通用原则：（i）堆栈是后进先出的，（ii）抢占式固定优先级中断可以嵌套，使得瞬时实时堆栈等于被中断的任务帧加上所有当前活动的ISR帧，以及（iii）所需的分配必须超过最大可能的瞬时实时使用量加上固定的保護帶，确定在最坏情况下保证不发生溢出的最小堆栈分配 $S_{\\text{alloc}}$（以字节为单位）。\n\n请将您的最终答案表示为单个整数字节数。不要四舍五入；请报告确切值。", "solution": "为了计算保证不发生溢出的最小堆栈分配，我们必须首先确定最坏情况下的峰值实时堆栈使用量，记为 $S_{\\text{max\\_live}}$。然后，将此值与指定的保护带相加即可得到最终结果。\n\n在具有固定优先级和抢占式中断的统一堆栈模型中，最坏的堆栈使用情况发生在系统经历最大程度的中断嵌套时。这个场景的展开如下：\n1.  首先，一个任务正在运行，并达到了其自身的最坏情况堆栈使用量，即 $S_{\\text{task}} = 1408$ 字节。\n2.  在这一时刻，为了达到最大嵌套深度，我们假设中断以最坏的方式到达：最低优先级的 $\\text{ISR}_{4}$ 中断到达并抢占了该任务。\n3.  接着，在 $\\text{ISR}_{4}$ 执行期间，更高优先级的 $\\text{ISR}_{3}$ 到达并抢占了 $\\text{ISR}_{4}$。\n4.  此过程沿着优先级链继续，$\\text{ISR}_{3}$ 被 $\\text{ISR}_{2}$ 抢占，最后 $\\text{ISR}_{2}$ 被最高优先级的 $\\text{ISR}_{1}$ 抢占。\n\n在此刻，当 $\\text{ISR}_{1}$ 开始执行时，堆栈上同时包含了原始任务的帧以及所有四个 ISR 的帧。因为 $\\text{ISR}_{1}$ 的优先级最高，不会再有其他中断能抢占它，所以这代表了系统可能达到的最大实时堆栈深度。\n\n最大实时堆栈使用量 $S_{\\text{max\\_live}}$ 是所有这些组件的堆栈使用量之和：\n$$S_{\\text{max\\_live}} = S_{\\text{task}} + \\Delta S_{1} + \\Delta S_{2} + \\Delta S_{3} + \\Delta S_{4}$$\n代入给定值：\n$$S_{\\text{max\\_live}} = 1408 + 224 + 176 + 144 + 128$$\n所有ISR的堆栈贡献总和为：\n$$\\sum_{i=1}^{4} \\Delta S_{i} = 224 + 176 + 144 + 128 = 672 \\text{ 字节}$$\n因此，最大实时堆栈使用量为：\n$$S_{\\text{max\\_live}} = 1408 + 672 = 2080 \\text{ 字节}$$\n\n最后，根据工程策略，需要在最大实时堆栈使用量之上增加一个 $S_{\\text{guard}} = 128$ 字节的保护带。\n所以，最小总堆栈分配量 $S_{\\text{alloc}}$ 为：\n$$S_{\\text{alloc}} = S_{\\text{max\\_live}} + S_{\\text{guard}} = 2080 + 128 = 2208 \\text{ 字节}$$\n这是保证即使在最坏情况下的嵌套中断抢占中也不会发生堆栈溢出，同时满足所需安全保护带的最小堆栈大小。", "answer": "$$\\boxed{2208}$$", "id": "3638740"}, {"introduction": "在理解了系统开销和资源限制之后，实时系统的最终目标是确保所有任务都能在截止日期前完成。本练习将引导你应用响应时间分析（RTA）这一强大工具来验证系统的可调度性。我们还将探讨如何使用优先级天花板协议（PCP）来管理共享资源，在防止死锁的同时，有效控制优先级反转带来的阻塞时间。[@problem_id:3638756]", "problem": "考虑一个单核嵌入式控制器，采用固定优先级的速率单调调度（RMS）进行调度。对共享资源的访问由优先级天花板协议（PCP）控制。有四个独立的周期性任务 $\\tau_1$、$\\tau_2$、$\\tau_3$ 和 $\\tau_4$。每个任务 $\\tau_i$ 都有一个周期 $T_i$、一个最坏情况执行时间 $C_i$ 和一个相对截止时间 $D_i$；假设对所有 $i$ 都有 $D_i = T_i$。所有任务在时间 $t=0$ 同步释放，没有释放抖动、上下文切换开销或与缓存相关的抢占延迟。允许抢占。优先级越高，周期越短。\n\n任务参数（周期单位为毫秒）：\n- $\\tau_1$：$T_1 = 10$，$C_1 = 1.5$。在其执行过程中，$\\tau_1$ 在资源 $R_C$ 上执行一个长度为 $1$ 的临界区。\n- $\\tau_2$：$T_2 = 15$，$C_2 = 2$。$\\tau_2$ 不访问共享资源。\n- $\\tau_3$：$T_3 = 25$，$C_3 = 4$。在其执行过程中，$\\tau_3$ 在资源 $R_B$ 上执行一个长度为 $2$ 的临界区。\n- $\\tau_4$：$T_4 = 50$，$C_4 = 15$。在其执行过程中，$\\tau_4$ 执行三个不相交的临界区：在资源 $R_A$ 上的长度为 $5$，在资源 $R_B$ 上的长度为 $1$，在资源 $R_C$ 上的长度为 $2$。\n\n在 RMS 下，优先级顺序为 $\\tau_1 \\succ \\tau_2 \\succ \\tau_3 \\succ \\tau_4$。在 PCP 下，每个资源的天花板是使用该资源的所有任务中的最高任务优先级。\n\n仅使用 RMS 干扰的基本定义和优先级天花板协议的阻塞属性，确定 $\\tau_3$ 可能遇到的最大阻塞 $B_{\\max}$，并计算最坏情况响应时间 $R_3$。然后验证 $R_3 \\le D_3$ 是否成立。以毫秒表示最终响应时间，并将最终答案四舍五入到四位有效数字。", "solution": "求解过程首先确定共享资源的优先级天花板，然后计算任务 $\\tau_3$ 的最大阻塞时间，最后使用响应时间分析（RTA）求出 $R_3$。\n\n**优先级分配和资源天花板**\n根据速率单调调度（RMS），任务优先级与其周期成反比。由于 $T_1  T_2  T_3  T_4$，优先级排序为 $P(\\tau_1) > P(\\tau_2) > P(\\tau_3) > P(\\tau_4)$。\n\n优先级天花板协议（PCP）为每个共享资源分配一个优先级天花板，该值等于可以锁定该资源的任何任务的最高优先级。\n-   资源 $R_A$ 被 $\\tau_4$ 使用。天花板 $C(R_A) = P(\\tau_4)$。\n-   资源 $R_B$ 被 $\\tau_3$ 和 $\\tau_4$ 使用。天花板 $C(R_B) = \\max\\{P(\\tau_3), P(\\tau_4)\\} = P(\\tau_3)$。\n-   资源 $R_C$ 被 $\\tau_1$ 和 $\\tau_4$ 使用。天花板 $C(R_C) = \\max\\{P(\\tau_1), P(\\tau_4)\\} = P(\\tau_1)$。\n\n**$\\tau_3$ 的最大阻塞时间 ($B_3$)**\n根据PCP规则，任务 $\\tau_i$ 仅可能被一个优先级低于它的任务 $\\tau_j$ 阻塞一次。这种情况发生于 $\\tau_j$ 持有一个资源，该资源的优先级天花板高于或等于 $\\tau_i$ 的优先级。对于任务 $\\tau_3$，唯一可能阻塞它的低优先级任务是 $\\tau_4$。我们检查 $\\tau_4$ 持有的临界区：\n-   $\\tau_4$ 使用 $R_A$：天花板 $C(R_A) = P(\\tau_4)$。由于 $P(\\tau_4)  P(\\tau_3)$，该临界区不能阻塞 $\\tau_3$。\n-   $\\tau_4$ 使用 $R_B$：天花板 $C(R_B) = P(\\tau_3)$。由于 $P(\\tau_3) \\ge P(\\tau_3)$，该临界区可以阻塞 $\\tau_3$。此临界区长度为 1 ms。\n-   $\\tau_4$ 使用 $R_C$：天花板 $C(R_C) = P(\\tau_1)$。由于 $P(\\tau_1) > P(\\tau_3)$，该临界区可以阻塞 $\\tau_3$。此临界区长度为 2 ms。\n\n$\\tau_3$ 的最大阻塞时间 $B_3$ 是所有可能阻塞它的临界区中的最大长度。\n$$ B_3 = \\max\\{1, 2\\} = 2 \\text{ ms} $$\n这是 $\\tau_3$ 所承受的 $B_{\\max}$。\n\n**$\\tau_3$ 的最坏情况响应时间 ($R_3$)**\n任务 $\\tau_i$ 的最坏情况响应时间由以下递归方程给出：\n$$ R_i^{(k+1)} = C_i + B_i + \\sum_{j \\in hp(i)} \\left\\lceil \\frac{R_i^{(k)}}{T_j} \\right\\rceil C_j $$\n其中 $hp(i)$ 是比 $\\tau_i$ 优先级更高的任务集合。对于 $\\tau_3$，$hp(3) = \\{\\tau_1, \\tau_2\\}$。方程为：\n$$ R_3 = C_3 + B_3 + \\left\\lceil \\frac{R_3}{T_1} \\right\\rceil C_1 + \\left\\lceil \\frac{R_3}{T_2} \\right\\rceil C_2 $$\n代入数值：\n$$ R_3 = 4 + 2 + \\left\\lceil \\frac{R_3}{10} \\right\\rceil (1.5) + \\left\\lceil \\frac{R_3}{15} \\right\\rceil (2) $$\n$$ R_3 = 6 + 1.5 \\left\\lceil \\frac{R_3}{10} \\right\\rceil + 2 \\left\\lceil \\frac{R_3}{15} \\right\\rceil $$\n我们迭代求解，初始猜测 $R_3^{(0)} = C_3 + B_3 = 6$。\n-   迭代 1：\n    $$ R_3^{(1)} = 6 + 1.5 \\left\\lceil \\frac{6}{10} \\right\\rceil + 2 \\left\\lceil \\frac{6}{15} \\right\\rceil = 6 + 1.5(1) + 2(1) = 6 + 1.5 + 2 = 9.5 $$\n-   迭代 2：\n    $$ R_3^{(2)} = 6 + 1.5 \\left\\lceil \\frac{9.5}{10} \\right\\rceil + 2 \\left\\lceil \\frac{9.5}{15} \\right\\rceil = 6 + 1.5(1) + 2(1) = 6 + 1.5 + 2 = 9.5 $$\n由于 $R_3^{(2)} = R_3^{(1)}$，迭代收敛。$\\tau_3$ 的最坏情况响应时间是 $R_3 = 9.5$ 毫秒。\n\n**可调度性验证**\n任务可调度的条件是 $R_3 \\le D_3$。\n-   $R_3 = 9.5$ ms\n-   $D_3 = T_3 = 25$ ms\n因为 $9.5 \\le 25$，条件满足，任务 $\\tau_3$ 是可调度的。\n\n问题要求最终响应时间四舍五入到四位有效数字。\n$$ R_3 = 9.500 \\text{ ms} $$", "answer": "$$\n\\boxed{9.500}\n$$", "id": "3638756"}]}