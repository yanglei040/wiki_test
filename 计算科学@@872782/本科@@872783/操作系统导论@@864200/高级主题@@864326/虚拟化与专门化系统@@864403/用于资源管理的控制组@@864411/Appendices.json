{"hands_on_practices": [{"introduction": "要真正掌握资源管理，理论联系实际至关重要。控制组（cgroups）的核心机制之一是按比例分配CPU资源。这个练习旨在帮助您将抽象的 `cpu.weight` 参数与实际的CPU时间分配联系起来。通过计算理论上的预期CPU时间，并将其与一个假设的观测结果进行比较，您将学会如何量化和诊断调度器的公平性表现，这是系统性能分析的一项基本技能。[@problem_id:3628647]", "problem": "一个 Linux 系统使用控制组 (cgroups) 版本 2，通过参数 $cpu.weight$ 来限制和按比例共享各组间的中央处理器 (CPU) 资源。考虑两个控制组 A 和 B，其权重配置为 $w_{A}=100$ 和 $w_{B}=400$。有一个被完全利用的 CPU 核心，并且在整个测量区间内，每个 cgroup 恰好有一个持续可运行的任务固定到这个核心上。假设在此区间内没有其他可运行的实体竞争 CPU。调度器是 Linux 完全公平调度器 (Completely Fair Scheduler, CFS)，在稳态竞争条件下，它会尝试均衡按权重缩放后各实体的虚拟运行时间。\n\n在一个长度为 $T=12 \\text{ s}$ 的固定区间内进行测量，得到控制组 A 和 B 的观测 CPU 运行时间分别为 $T_{A}^{\\text{obs}}=2.6 \\text{ s}$ 和 $T_{B}^{\\text{obs}}=9.4 \\text{ s}$。\n\n从 CFS 试图均衡各可运行实体的加权虚拟运行时间这一核心公平性原则出发，推导在该区间内预期的按比例分配的 CPU 时间 $T_{A}^{\\text{exp}}$ 和 $T_{B}^{\\text{exp}}$，然后使用均方根相对误差公式量化观测分配与预期分配之间的差异：\n$$\nE \\;=\\; \\sqrt{\\frac{1}{2}\\left(\\frac{\\left(T_{A}^{\\text{obs}}-T_{A}^{\\text{exp}}\\right)^{2}}{\\left(T_{A}^{\\text{exp}}\\right)^{2}} \\;+\\; \\frac{\\left(T_{B}^{\\text{obs}}-T_{B}^{\\text{exp}}\\right)^{2}}{\\left(T_{B}^{\\text{exp}}\\right)^{2}}\\right)}.\n$$\n仅报告 $E$ 的值，以无单位的小数形式表示。将您的答案四舍五入到四位有效数字。", "solution": "本题要求计算由 Linux 完全公平调度器 (CFS) 管理的两个控制组 A 和 B 的观测与预期 CPU 时间分配之间的差异。\n\n首先，我们必须确定预期的 CPU 时间分配 $T_{A}^{\\text{exp}}$ 和 $T_{B}^{\\text{exp}}$。题目指出，CFS 调度器在竞争条件下，会根据实体的 `cpu.weight` 值在实体间按比例共享 CPU。给定的控制组 A 和控制组 B 的权重分别为 $w_{A}=100$ 和 $w_{B}=400$。\n\n竞争实体的总权重是各独立权重的总和：\n$$\nW = w_{A} + w_{B} = 100 + 400 = 500\n$$\n每个 cgroup 的预期 CPU 时间比例是其权重与总权重的比值。\n对于 cgroup A，预期比例 $p_{A}$ 为：\n$$\np_{A} = \\frac{w_{A}}{W} = \\frac{100}{500} = \\frac{1}{5} = 0.2\n$$\n对于 cgroup B，预期比例 $p_{B}$ 为：\n$$\np_{B} = \\frac{w_{B}}{W} = \\frac{400}{500} = \\frac{4}{5} = 0.8\n$$\n给定的总测量区间为 $T=12 \\text{ s}$。预期的 CPU 运行时间是通过将总区间乘以各自的比例来计算的。\ncgroup A 的预期运行时间为：\n$$\nT_{A}^{\\text{exp}} = p_{A} \\times T = 0.2 \\times 12 \\text{ s} = 2.4 \\text{ s}\n$$\ncgroup B 的预期运行时间为：\n$$\nT_{B}^{\\text{exp}} = p_{B} \\times T = 0.8 \\times 12 \\text{ s} = 9.6 \\text{ s}\n$$\n作为验证，预期的运行时间总和必须等于总区间：$T_{A}^{\\text{exp}} + T_{B}^{\\text{exp}} = 2.4 \\text{ s} + 9.6 \\text{ s} = 12 \\text{ s}$，这与题设一致。\n\n接下来，我们使用给定的均方根相对误差公式 $E$ 来量化观测分配与预期分配之间的差异：\n$$\nE = \\sqrt{\\frac{1}{2}\\left(\\frac{\\left(T_{A}^{\\text{obs}}-T_{A}^{\\text{exp}}\\right)^{2}}{\\left(T_{A}^{\\text{exp}}\\right)^{2}} + \\frac{\\left(T_{B}^{\\text{obs}}-T_{B}^{\\text{exp}}\\right)^{2}}{\\left(T_{B}^{\\text{exp}}\\right)^{2}}\\right)}\n$$\n题目给出的观测运行时间为：$T_{A}^{\\text{obs}}=2.6 \\text{ s}$ 和 $T_{B}^{\\text{obs}}=9.4 \\text{ s}$。我们现在可以将观测值和预期值代入 $E$ 的公式中。\n\n首先，我们计算各自的相对误差项。对于 cgroup A：\n$$\n\\frac{T_{A}^{\\text{obs}}-T_{A}^{\\text{exp}}}{T_{A}^{\\text{exp}}} = \\frac{2.6 - 2.4}{2.4} = \\frac{0.2}{2.4} = \\frac{1}{12}\n$$\n对于 cgroup B：\n$$\n\\frac{T_{B}^{\\text{obs}}-T_{B}^{\\text{exp}}}{T_{B}^{\\text{exp}}} = \\frac{9.4 - 9.6}{9.6} = \\frac{-0.2}{9.6} = -\\frac{1}{48}\n$$\n现在我们将这些值代入 $E$ 的公式中：\n$$\nE = \\sqrt{\\frac{1}{2}\\left(\\left(\\frac{1}{12}\\right)^{2} + \\left(-\\frac{1}{48}\\right)^{2}\\right)}\n$$\n$$\nE = \\sqrt{\\frac{1}{2}\\left(\\frac{1}{144} + \\frac{1}{2304}\\right)}\n$$\n为了将分数相加，我们找到一个公分母，即 $2304$。注意 $144 \\times 16 = 2304$。\n$$\nE = \\sqrt{\\frac{1}{2}\\left(\\frac{16}{2304} + \\frac{1}{2304}\\right)}\n$$\n$$\nE = \\sqrt{\\frac{1}{2}\\left(\\frac{17}{2304}\\right)}\n$$\n$$\nE = \\sqrt{\\frac{17}{4608}}\n$$\n最后，我们计算数值，并按要求四舍五入到四位有效数字。\n$$\nE \\approx \\sqrt{0.003689236...} \\approx 0.06073908...\n$$\n四舍五入到四位有效数字，我们得到：\n$$\nE \\approx 0.06074\n$$", "answer": "$$\n\\boxed{0.06074}\n$$", "id": "3628647"}, {"introduction": "在真实的系统中，资源分配策略通常不是扁平的，而是通过嵌套的控制组形成复杂的层次结构。此练习将您的理解从单一层级的资源划分推进到多层级的场景，特别是针对I/O带宽。通过分析父组如何将其获得的带宽分配给其子组，您将学会计算在嵌套结构中，任意一个子组最终获得的资源份额。这对于管理容器化环境（如Docker或Kubernetes）中的资源至关重要，因为这些环境广泛使用层次化控制组。[@problem_id:3628646]", "problem": "一个系统使用控制组 (cgroups) 来管理单个块设备的输入/输出 (I/O) 带宽，该设备的可持续吞吐量为 $B$ 兆字节/秒 (MiB/s)。块 I/O 控制器采用线性比例共享策略：在任何调度器层级，可用带宽都根据其配置的权重在同级 cgroup 之间进行分配。\n\n考虑以下以设备控制器为根的层次结构。在根级别，正好有两个同级 cgroup：\n- 父组 $\\mathcal{P}$，其配置权重为 $blkio.weight = 500$。\n- 同级组 $\\mathcal{S}$，其配置权重为 $blkio.weight = 500$。\n\n在 $\\mathcal{P}$ 内部，正好有两个叶 cgroup，它们都持续发出大块 I/O 请求，从而完全利用任何分配到的带宽：\n- 子组 $\\mathcal{C}_1$，其配置权重为 $100$。\n- 子组 $\\mathcal{C}_2$，其配置权重为 $400$。\n\n同级组 $\\mathcal{S}$ 包含一个叶节点，该叶节点也持续发出 I/O 请求，因此设备被三个活动的叶节点（$\\mathcal{C}_1$、$\\mathcal{C}_2$ 和 $\\mathcal{S}$ 内的叶节点）完全饱和。\n\n假设层次结构中的每个级别都实现了理想的线性比例共享，并且所有三个叶节点具有相同的 I/O 请求特性，请计算 $\\mathcal{C}_1$ 和 $\\mathcal{C}_2$ 的归一化吞吐量份额，表示为总设备吞吐量 $B$ 的精确分数。将您的答案以一个二元行矩阵 $(\\mathcal{C}_1, \\mathcal{C}_2)$ 的形式报告。无需四舍五入；将最终值表示为不带单位的精确分数。", "solution": "基本原理是线性比例共享原则：在任何调度器层级，共享同一资源的一组同级实体按其配置的权重比例接收资源分配。在控制组 (cgroups) 和块 I/O 控制器的背景下，这意味着在层次结构的每个级别，分配给子组的带宽份额与其权重相对于其所有同级组权重之和的比例成正比，而一个叶节点的长期份额等于其从根节点到该叶节点的路径上所有比例份额的乘积。\n\n设总设备吞吐量为 $B$ MiB/s。在根级别，两个同级 cgroup $\\mathcal{P}$ 和 $\\mathcal{S}$ 的权重分别为 $500$ 和 $500$。在比例共享下，分配给 $\\mathcal{P}$ 的 $B$ 的份额为\n$$\n\\frac{500}{500 + 500} = \\frac{500}{1000} = \\frac{1}{2},\n$$\n因此 $\\mathcal{P}$ 获得 $\\frac{1}{2} B$。同样，$\\mathcal{S}$ 获得 $\\frac{1}{2} B$。\n\n在 $\\mathcal{P}$ 内部，两个叶节点 $\\mathcal{C}_1$ 和 $\\mathcal{C}_2$ 的权重分别为 $100$ 和 $400$。它们在 $\\mathcal{P}$ 的分配中所占的份额由该级别的同级实体间的比例共享决定。分配给 $\\mathcal{C}_1$ 的 $\\mathcal{P}$ 的带宽份额为\n$$\n\\frac{100}{100 + 400} = \\frac{100}{500} = \\frac{1}{5},\n$$\n分配给 $\\mathcal{C}_2$ 的份额为\n$$\n\\frac{400}{100 + 400} = \\frac{400}{500} = \\frac{4}{5}.\n$$\n\n将其乘以 $\\mathcal{P}$ 从根级别获得的分配，相对于总设备吞吐量 $B$ 的绝对份额为：\n- 对于 $\\mathcal{C}_1$：\n$$\n\\left(\\frac{1}{2}\\right) \\times \\left(\\frac{1}{5}\\right) \\times B = \\frac{1}{10} B,\n$$\n这对应于 $B$ 的归一化分数 $\\frac{1}{10}$。\n- 对于 $\\mathcal{C}_2$：\n$$\n\\left(\\frac{1}{2}\\right) \\times \\left(\\frac{4}{5}\\right) \\times B = \\frac{4}{10} B = \\frac{2}{5} B,\n$$\n这对应于 $B$ 的归一化分数 $\\frac{2}{5}$。\n\n因此，$\\mathcal{C}_1$ 和 $\\mathcal{C}_2$ 的归一化吞吐量份额（作为总设备吞吐量的分数）分别为 $\\frac{1}{10}$ 和 $\\frac{2}{5}$。以二元行矩阵 $(\\mathcal{C}_1, \\mathcal{C}_2)$ 的形式报告，得到\n$$\n\\begin{pmatrix}\n\\frac{1}{10}  \\frac{2}{5}\n\\end{pmatrix}.\n$$", "answer": "$$\\boxed{\\begin{pmatrix}\\frac{1}{10}  \\frac{2}{5}\\end{pmatrix}}$$", "id": "3628646"}, {"introduction": "资源管理的挑战不仅在于公平分配，更在于保证系统的稳定性和服务的可用性，避免任何工作负载被“饿死”。本练习模拟了一个经典场景：一个执行大量读操作的高优先级任务与一个执行少量写操作的低优先级任务竞争I/O资源。您将运用基本的排队论原理，推导出为保证低优先级任务队列稳定所需的最小资源预留量 $r_{\\min}$。解决这个问题将使您深入理解如何通过设置资源下限来防止服务质量下降和任务饥饿，这是设计健壮高可用系统的关键一步。[@problem_id:3628649]", "problem": "一位系统管理员使用 Linux 控制组 (cgroups) 来管理共享单个存储设备的 $2$ 个工作负载的输入/输出 (I/O)。一个 cgroup（表示为 $W$）执行小数据量的随机写入；另一个 cgroup（表示为 $R$）执行大数据量的顺序读取。当设备专门服务于单个 cgroup 时，其行为如下：对于 $W$，设备维持 $\\Theta_{w}$ 字节/秒的吞吐量；对于 $R$，设备维持 $\\Theta_{r}$ 字节/秒的吞吐量。写入的平均请求大小为 $B_{w}$ 字节，读取的平均请求大小为 $B_{r}$ 字节。请求以独立的更新过程到达，$W$ 的平均速率为 $\\lambda_{w}$ 请求/秒，$R$ 的平均速率为 $\\lambda_{r}$ 请求/秒。\n\nI/O 控制器是工作保持的。在没有任何预留或份额配置的情况下，每当两个队列都非空时，控制器会给予 $R$ 严格的优先级，这反映了常见的对延迟敏感的读取偏好。当配置了时间片预留时，设备服务时间的 $r$ 部分被保证分配给 $W$，而 $1-r$ 部分可用于 $R$，其中 $0  r  1$。交错的工作负载（即 $r$ 和 $1-r$ 时间片）引入了显著的低效率；$W$ 的有效写入服务速率变为其独占使用请求服务速率的 $\\alpha$ 倍，其中 $\\alpha \\in (0,1]$。\n\n1.  在无预留、读取优先机制下，工作负载 $W$ 将被饿死的条件是什么？用 $\\lambda_{r}$、$\\Theta_{r}$ 和 $B_{r}$ 表示。\n2.  推导出保证工作负载 $W$ 队列稳定的最小预留比例 $r_{\\min}$。用 $\\lambda_{w}$、$\\Theta_{w}$、$B_{w}$ 和 $\\alpha$ 表示。", "solution": "这个问题包含两个部分，都可以使用排队论的第一性原理来解决。单服务器队列保持稳定的核心原理是：其平均到达速率（表示为 $\\lambda$）必须严格小于其平均服务速率（表示为 $\\mu$）。如果 $\\lambda \\geq \\mu$，队列长度平均而言将无限增长，这种情况被称为不稳定性或非平稳性。服务器的利用率定义为 $\\rho = \\lambda / \\mu$。稳定性要求 $\\rho  1$。\n\n$1.$ 在无预留、读取优先机制下工作负载 $W$ 被饿死的条件。\n\n在此机制下，I/O 控制器实现了一个严格的、非抢占式的优先级排队规则，其中工作负载 $R$ 具有高优先级，而工作负载 $W$ 具有低优先级。这意味着服务器（存储设备）只有在 $R$ 队列为空时，才会服务来自 $W$ 队列的请求。\n\n工作负载 $R$ 的到达速率为 $\\lambda_r$ 请求/秒。$R$ 的独占使用服务速率由 $\\mu_r = \\Theta_r / B_r$ 请求/秒给出。服务器忙于服务高优先级工作负载 $R$ 的时间比例是其利用率 $\\rho_r$。\n$$ \\rho_r = \\frac{\\lambda_r}{\\mu_r} = \\frac{\\lambda_r}{\\Theta_r / B_r} = \\frac{\\lambda_r B_r}{\\Theta_r} $$\n$\\lambda_r B_r$ 项表示读取数据的平均到达速率（单位为字节/秒），而 $\\Theta_r$ 是读取数据的最大服务速率（单位为字节/秒）。因此，$\\rho_r$ 是读取工作负载所需求的设备 I/O 容量的比例。\n\n低优先级的工作负载 $W$ 只有在服务器相对于工作负载 $R$ 而言是空闲时才能获得服务。假设 $\\rho_r  1$，这种情况发生的时间比例为 $1 - \\rho_r$。如果来自高优先级工作负载的需求达到或超过服务器的容量，即如果 $\\rho_r \\geq 1$，服务器将有 $100\\%$ 的时间（在稳态或极限情况下）忙于服务 $R$ 的请求。因此，$W$ 队列将永远不会得到服务，从而导致其饿死。\n\n因此，$W$ 被饿死的条件是：\n$$ \\rho_r \\geq 1 $$\n代入 $\\rho_r$ 的表达式，该条件变为：\n$$ \\frac{\\lambda_r B_r}{\\Theta_r} \\geq 1 $$\n这等同于说，读取数据的到达速率 $\\lambda_r B_r$ 大于或等于设备对该数据的服务能力 $\\Theta_r$。\n\n$2.$ 推导使 $W$ 队列保持稳定的最小预留比例 $r_{\\min}$。\n\n在时间分片预留策略下，工作负载 $W$ 队列的稳定性取决于其自身的到达速率和有效服务速率。稳定性条件是 $\\lambda_w  \\mu_{w,eff}$，其中 $\\lambda_w$ 是 $W$ 的到达速率，而 $\\mu_{w,eff}$ 是其在预留方案下的有效服务速率。\n\n我们需要推导 $\\mu_{w,eff}$ 的表达式。\n工作负载 $W$ 的独占使用服务速率为 $\\mu_w = \\Theta_w / B_w$ 请求/秒。\n通过时间片预留，设备服务时间的 $r$ 部分被保证分配给 $W$。这将服务速率按比例缩放了因子 $r$。\n此外，交错的工作负载会引入低效率，由因子 $\\alpha \\in (0,1]$ 建模。这个因子降低了写入请求可以被处理的速率。\n\n问题陈述中提到“$W$ 的有效写入服务速率变为其独占使用请求服务速率的 $\\alpha$ 倍”。这意味着在 $W$ 的时间片内，瞬时服务速率是 $\\alpha \\mu_w$。由于 $W$ 被保证了总时间的 $r$ 部分，其长期平均有效服务速率是预留时间比例、效率因子和独占使用服务速率的乘积。\n$$ \\mu_{w,eff} = r \\cdot \\alpha \\cdot \\mu_w $$\n因此，工作负载 $W$ 的稳定性条件是：\n$$ \\lambda_w  r \\cdot \\alpha \\cdot \\mu_w $$\n为了找到保证稳定性的最小预留比例 $r_{\\min}$，我们考虑边界情况，即到达速率等于有效服务速率。任何大于此边界值的 $r$ 值都将确保稳定性。\n$$ \\lambda_w = r_{\\min} \\cdot \\alpha \\cdot \\mu_w $$\n解出 $r_{\\min}$：\n$$ r_{\\min} = \\frac{\\lambda_w}{\\alpha \\cdot \\mu_w} $$\n问题要求最终表达式用 $\\lambda_{w}$、$\\Theta_{w}$、$B_{w}$ 和 $\\alpha$ 表示。我们代入 $\\mu_w$ 的表达式：\n$$ r_{\\min} = \\frac{\\lambda_w}{\\alpha \\left( \\frac{\\Theta_w}{B_w} \\right)} $$\n化简此表达式得到最终结果：\n$$ r_{\\min} = \\frac{\\lambda_w B_w}{\\alpha \\Theta_w} $$\n这个结果是直观的：所需的最小资源比例是写入所需的吞吐量（$\\lambda_w B_w$）与在交错情况下设备对写入的有效吞吐能力（$\\alpha \\Theta_w$）之比。这个比例 $r_{\\min}$ 必须小于或等于 $1$，才能使一个稳定的解决方案可行。", "answer": "$$ \\boxed{\\frac{\\lambda_w B_w}{\\alpha \\Theta_w}} $$", "id": "3628649"}]}