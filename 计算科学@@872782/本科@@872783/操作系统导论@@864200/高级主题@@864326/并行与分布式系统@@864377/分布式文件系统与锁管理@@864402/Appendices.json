{"hands_on_practices": [{"introduction": "在确保我们的锁机制正确之后，我们必须考虑其对性能的影响。在服务器上实施强制锁检查以防止行为不当的客户端忽略锁，会给每个操作增加开销。这个实践问题 [@problem_id:3636621] 将指导你完成一个实际的性能分析，通过对网络延迟、缓存和处理成本等现实世界因素进行建模，来计算此类检查引入的预期延迟。", "problem": "一个分布式文件系统通过远程过程调用（RPC）向客户端提供读写操作。该系统目前使用劝告锁，行为不当的客户端可能会忽略这种锁。您的任务是在服务器端设计强制锁执行机制，并量化在每次读写操作时执行锁检查所带来的预期附加延迟。强制锁执行意味着服务器在处理一个操作前，必须查询权威的锁状态，并拒绝与现有锁冲突的请求。\n\n基本定义和假设：\n- 劝告锁是无需强制执行的提示；强制锁由服务器强制执行，它会阻塞或拒绝冲突的访问。\n- 锁检查按顺序分阶段进行；当各阶段按顺序发生时，延迟会累加。\n- 服务器使用租约缓存锁状态；如果租约仍然有效，则可以使用缓存的锁状态。\n- 离散随机变量的期望值是其所有可能值的概率加权和。\n- 设锁管理器为分布式锁管理器（DLM）。\n\n设计场景和参数：\n- 在每次读或写操作时，服务器都会执行一次锁检查。有 $p_h$ 的概率，服务器拥有一个有效的缓存锁状态（缓存命中），产生本地处理成本 $t_{\\text{hit}}$。有 $1 - p_h$ 的概率，缓存无效或不存在（缓存未命中），此时服务器必须通过 RPC 查询 DLM 以获取当前锁状态；这条未命中路径的成本为 $t_{\\text{miss}}$。\n- 缓存命中成本为 $t_{\\text{hit}} = 0.05$ 毫秒。\n- 对于缓存未命中，其顺序阶段及其延迟如下：\n  - 服务器和 DLM 之间的网络往返时间：$t_{\\text{rtt}} = 0.70$ 毫秒。\n  - 每个数据包的网络栈开销：$t_{\\text{stack}} = 0.04$ 毫秒，每次 RPC 有 $2$ 个数据包（总共 $2 \\cdot t_{\\text{stack}}$）。\n  - 序列化和反序列化成本：$t_{\\text{ser}} = 0.03$ 毫秒。\n  - 文件服务器准备和解析请求与响应的 CPU 时间：$t_{\\text{fs}} = 0.07$ 毫秒。\n  - DLM 基本锁检查时间（不包括范围扫描）：$t_{\\text{lm}} = 0.11$ 毫秒。\n  - 范围锁扫描：锁管理器平均检查 $k$ 个不相交的范围，每个范围的成本为 $t_{\\text{range}} = 0.028$ 毫秒，预期 $k = 2.5$。\n  - 检查的审计日志记录：$t_{\\text{log}} = 0.05$ 毫秒。\n  - 客户端身份验证：$t_{\\text{id}} = 0.015$ 毫秒。\n  - 服务器在接收到新状态后更新缓存：$t_{\\text{cacheupd}} = 0.02$ 毫秒。\n- 缓存命中概率为 $p_h = 0.91$。\n- 假设缓存命中事件与操作类型之间相互独立，并且上述延迟是稳定且可累加的。忽略因操作冲突而被拒绝所产生的任何额外时间；仅测量强制检查的开销。\n\n任务：\n- 基于以上场景，推导由每次请求都检查的强制锁执行所引入的每次操作的预期附加延迟 $E[t]$。\n- 以毫秒为单位表示您的最终答案。将您的答案四舍五入到四位有效数字。", "solution": "目标是计算因引入强制锁执行而导致的每次操作的预期附加延迟，记为 $E[t]$。问题描述了一个系统，其中锁检查可能产生两种结果之一：缓存命中或缓存未命中。\n\n设 $t$ 为表示附加延迟的随机变量。考虑到缓存命中和缓存未命中这两个不相交事件，根据全期望定律，$t$ 的期望值 $E[t]$ 可由以下公式得出：\n$$\nE[t] = t_{\\text{hit}} \\cdot P(\\text{hit}) + t_{\\text{miss}} \\cdot P(\\text{miss})\n$$\n其中 $t_{\\text{hit}}$ 是缓存命中时的延迟，$t_{\\text{miss}}$ 是缓存未命中时的延迟，$P(\\text{hit})$ 是缓存命中的概率，而 $P(\\text{miss})$ 是缓存未命中的概率。\n\n问题提供了以下参数：\n- 缓存命中的概率，$p_h = P(\\text{hit}) = 0.91$。\n- 缓存未命中的概率是其补集，$1 - p_h = P(\\text{miss}) = 1 - 0.91 = 0.09$。\n- 缓存命中的延迟为 $t_{\\text{hit}} = 0.05$ 毫秒。\n\n缓存未命中的延迟 $t_{\\text{miss}}$ 是其顺序阶段延迟的总和。我们必须计算这个总成本。其组成部分如下：\n1.  网络往返时间：$t_{\\text{rtt}} = 0.70$ 毫秒。\n2.  网络栈开销：此成本是每个数据包都会产生的。一次 RPC 包括一个请求和一个响应，共计 $2$ 个数据包。因此总的网络栈开销为 $2 \\cdot t_{\\text{stack}} = 2 \\cdot 0.04 = 0.08$ 毫秒。\n3.  序列化和反序列化成本：$t_{\\text{ser}} = 0.03$ 毫秒。\n4.  文件服务器处理请求/响应的 CPU 时间：$t_{\\text{fs}} = 0.07$ 毫秒。\n5.  分布式锁管理器 (DLM) 基本检查时间：$t_{\\text{lm}} = 0.11$ 毫秒。\n6.  范围锁扫描成本：这取决于预期的范围数 $k$ 和每个范围的成本 $t_{\\text{range}}$。预期成本为 $k \\cdot t_{\\text{range}} = 2.5 \\cdot 0.028 = 0.07$ 毫秒。\n7.  审计日志记录成本：$t_{\\text{log}} = 0.05$ 毫秒。\n8.  客户端身份验证成本：$t_{\\text{id}} = 0.015$ 毫秒。\n9.  服务器端的缓存更新成本：$t_{\\text{cacheupd}} = 0.02$ 毫秒。\n\n缓存未命中的总延迟 $t_{\\text{miss}}$ 是这些组成部分的总和：\n$$\nt_{\\text{miss}} = t_{\\text{rtt}} + 2 \\cdot t_{\\text{stack}} + t_{\\text{ser}} + t_{\\text{fs}} + t_{\\text{lm}} + k \\cdot t_{\\text{range}} + t_{\\text{log}} + t_{\\text{id}} + t_{\\text{cacheupd}}\n$$\n以毫秒为单位代入给定值：\n$$\nt_{\\text{miss}} = 0.70 + 2 \\cdot (0.04) + 0.03 + 0.07 + 0.11 + (2.5 \\cdot 0.028) + 0.05 + 0.015 + 0.02\n$$\n$$\nt_{\\text{miss}} = 0.70 + 0.08 + 0.03 + 0.07 + 0.11 + 0.07 + 0.05 + 0.015 + 0.02\n$$\n$$\nt_{\\text{miss}} = 1.145 \\text{ ms}\n$$\n现在，我们可以将 $p_h$、$t_{\\text{hit}}$ 和 $t_{\\text{miss}}$ 的值代入期望公式，来计算预期的总延迟 $E[t]$：\n$$\nE[t] = p_h \\cdot t_{\\text{hit}} + (1 - p_h) \\cdot t_{\\text{miss}}\n$$\n$$\nE[t] = (0.91) \\cdot (0.05) + (0.09) \\cdot (1.145)\n$$\n$$\nE[t] = 0.0455 + 0.10305\n$$\n$$\nE[t] = 0.14855 \\text{ ms}\n$$\n问题要求最终答案四舍五入到四位有效数字。计算结果为 $0.14855$。四位有效数字是 $1$、$4$、$8$ 和 $5$。下一位数字是 $5$，因此我们将最后一位有效数字向上舍入。\n$$\nE[t] \\approx 0.1486 \\text{ ms}\n$$\n这个值表示由于强制锁执行检查，每次读或写操作所产生的平均开销。", "answer": "$$\n\\boxed{0.1486}\n$$", "id": "3636621"}, {"introduction": "锁是确保一致性的强大工具，但它不是唯一的工具，而且有时效率不高。这个问题 [@problem_id:3636588] 探讨了悲观并发（访问前加锁）和乐观并发（提交前验证）之间的基本权衡。你将推导出一个数学模型来找到“盈亏平衡点”，帮助你理解在何种数据冲突可能性下，一种策略会比另一种更有效。", "problem": "考虑一个带有中心化锁管理器（LM）和元数据服务的分布式文件系统（DFS）。对于单个文件对象的操作，有两种并发控制策略可用：使用锁的悲观并发和使用版本检查的乐观并发。您将推导出一个冲突概率阈值，在该阈值下，对于混合读写工作负载，这两种策略的预期并发控制开销相等。\n\n假设以下基本事实和定义：\n- 在悲观并发下，读操作获取一个共享锁然后释放它，由于锁获取、释放以及由争用引起的任何预期等待时间，会产生 $L_{r}$ 的平均总开销时间。\n- 在悲观并发下，写操作获取一个排他锁然后释放它，由于锁获取、释放以及由争用引起的任何预期等待时间，会产生 $L_{w}$ 的平均总开销时间。\n- 在乐观并发下，读操作在读取后对元数据服务执行版本验证，产生 $V_{r}$ 的开销时间；假设在此模型中没有读操作中止。\n- 在乐观并发下，写操作在提交时执行版本验证，每次尝试产生 $V_{w}$ 的开销时间。每次尝试以概率 $q$ 独立地发生冲突，因此中止并且必须重试；尝试将继续直到有一次成功。假设冲突是独立的，并且对于对象上的所有写尝试，冲突概率 $q$ 是相同的。\n- 设工作负载的写操作比例为 $\\alpha$，读操作比例为 $1-\\alpha$，其中 $0  \\alpha  1$。\n- 忽略两种策略共有的任何基本数据路径成本；只计算并发控制开销。\n\n从上述定义和独立试验期望的标准属性出发，推导出一个冲突概率的闭式表达式 $q^{\\star}$，在该概率下，悲观和乐观策略下每次操作的预期并发控制开销相等。用 $\\alpha$、$L_{r}$、$L_{w}$、$V_{r}$ 和 $V_{w}$ 的符号形式表示 $q^{\\star}$。您的最终答案必须是单个解析表达式。不要四舍五入。", "solution": "目标是找到冲突概率 $q^{\\star}$，在该概率下，悲观和乐观策略下每次操作的预期并发控制开销相等。设 $E[C_{\\text{pessimistic}}]$ 为悲观策略的预期开销，设 $E[C_{\\text{optimistic}}]$ 为乐观策略的预期开销。我们需要在方程 $E[C_{\\text{pessimistic}}] = E[C_{\\text{optimistic}}]$ 中求解 $q^{\\star}$。\n\n首先，我们确定悲观策略下每次操作的预期开销。这是基于工作负载构成的读写开销的加权平均值。\n$$E[C_{\\text{pessimistic}}] = \\alpha \\cdot L_{w} + (1-\\alpha) \\cdot L_{r}$$\n\n接下来，我们确定乐观策略下每次操作的预期开销。这也是预期的读写开销的加权平均值。\n$$E[C_{\\text{optimistic}}] = \\alpha \\cdot E[C_{\\text{write, opt}}] + (1-\\alpha) \\cdot E[C_{\\text{read, opt}}]$$\n\n乐观读的开销是一个给定的常数 $V_{r}$。由于假设读操作从不中止，所以预期开销就是这个值。\n$$E[C_{\\text{read, opt}}] = V_{r}$$\n\n乐观写的开销更复杂，因为它涉及可变次数的尝试。设 $K$ 为表示写操作成功前尝试次数的随机变量。每次尝试都是一个独立的伯努利试验，成功概率为 $1-q$，失败概率为 $q$。尝试次数 $K$ 服从几何分布，其概率质量函数为 $P(K=k) = q^{k-1}(1-q)$，其中 $k \\in \\{1, 2, 3, \\dots\\}$。\n\n预期尝试次数 $E[K]$ 是几何分布的一个标准结果：\n$$E[K] = \\sum_{k=1}^{\\infty} k \\cdot P(K=k) = \\sum_{k=1}^{\\infty} k \\cdot q^{k-1}(1-q) = \\frac{1}{1-q}$$\n每次尝试的开销为 $V_{w}$。因此，需要 $K$ 次尝试的写操作的总开销为 $K \\cdot V_{w}$。乐观写的预期开销是通过对这个总开销取期望值来找到的：\n$$E[C_{\\text{write, opt}}] = E[K \\cdot V_{w}] = V_{w} \\cdot E[K] = \\frac{V_{w}}{1-q}$$\n\n将预期的读写开销代回到总预期乐观开销的表达式中，我们得到：\n$$E[C_{\\text{optimistic}}] = \\alpha \\left( \\frac{V_{w}}{1-q} \\right) + (1-\\alpha)V_{r}$$\n\n现在，我们通过令两种策略的预期开销相等来找到阈值概率 $q^{\\star}$：\n$$E[C_{\\text{pessimistic}}] = E[C_{\\text{optimistic}}]$$\n$$\\alpha L_{w} + (1-\\alpha)L_{r} = \\alpha \\left( \\frac{V_{w}}{1-q^{\\star}} \\right) + (1-\\alpha)V_{r}$$\n\n我们继续解这个方程以求出 $q^{\\star}$。首先，分离出包含 $q^{\\star}$ 的项：\n$$\\alpha \\left( \\frac{V_{w}}{1-q^{\\star}} \\right) = \\alpha L_{w} + (1-\\alpha)L_{r} - (1-\\alpha)V_{r}$$\n$$\\alpha \\left( \\frac{V_{w}}{1-q^{\\star}} \\right) = \\alpha L_{w} + (1-\\alpha)(L_{r} - V_{r})$$\n\n因为问题陈述中 $0  \\alpha  1$，我们可以安全地除以 $\\alpha$：\n$$\\frac{V_{w}}{1-q^{\\star}} = L_{w} + \\frac{1-\\alpha}{\\alpha}(L_{r} - V_{r})$$\n\n现在，我们可以求解 $1-q^{\\star}$：\n$$1-q^{\\star} = \\frac{V_{w}}{L_{w} + \\frac{1-\\alpha}{\\alpha}(L_{r} - V_{r})}$$\n为了简化分母中的复合分数，我们找到一个公分母：\n$$L_{w} + \\frac{1-\\alpha}{\\alpha}(L_{r} - V_{r}) = \\frac{\\alpha L_{w}}{\\alpha} + \\frac{(1-\\alpha)(L_{r} - V_{r})}{\\alpha} = \\frac{\\alpha L_{w} + (1-\\alpha)(L_{r} - V_{r})}{\\alpha}$$\n将此代回到 $1-q^{\\star}$ 的表达式中：\n$$1-q^{\\star} = \\frac{V_{w}}{\\frac{\\alpha L_{w} + (1-\\alpha)(L_{r} - V_{r})}{\\alpha}} = \\frac{\\alpha V_{w}}{\\alpha L_{w} + (1-\\alpha)(L_{r} - V_{r})}$$\n\n最后，我们求解 $q^{\\star}$：\n$$q^{\\star} = 1 - \\frac{\\alpha V_{w}}{\\alpha L_{w} + (1-\\alpha)(L_{r} - V_{r})}$$\n这就是两种策略的预期开销相等时的冲突概率阈值的闭式表达式。", "answer": "$$\\boxed{1 - \\frac{\\alpha V_{w}}{\\alpha L_{w} + (1-\\alpha)(L_{r} - V_{r})}}$$", "id": "3636588"}]}