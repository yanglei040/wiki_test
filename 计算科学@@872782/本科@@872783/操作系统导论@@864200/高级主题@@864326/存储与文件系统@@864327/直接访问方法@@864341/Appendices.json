{"hands_on_practices": [{"introduction": "任何直接访问系统的基础都是其映射结构，它负责将逻辑地址转换为物理位置。这个练习 [@problem_id:3634057] 将让你扮演系统设计师的角色，任务是计算这样一个映射表的内存占用。你将需要在存储容量、分配粒度和有限的RAM预算之间进行权衡，这是操作系统设计中一个经典的挑战。", "problem": "一个操作系统通过使用存储在随机存取存储器（RAM）中的映射表来索引固定大小的分配单元，从而为一个大型块设备实现直接（随机）访问方法。根据直接访问的定义，每个分配单元都恰好有一个映射表条目，该条目将分配单元的逻辑索引映射到其物理位置。该设备的总大小为 $S$ 字节，分配粒度为 $g$ 字节，每个映射表条目在对齐后的大小固定为 $e$ 字节。除了用于实际分配单元的条目外，系统还维护了一部分额外的备用条目，其数量为实际条目数的分数 $r$，以及一个大小为 $H$ 字节的固定头部。整个内存中的映射结构（头部加上所有条目，包括备用条目）必须能容纳在给定的 RAM 预算 $R_{\\max}$ 之内。\n\n考虑以下遵循直接访问方法约束的设计实例：\n- 设备容量为 $S = 18$ 太字节 (TiB)，其中 $1$ TiB $= 2^{40}$ 字节。\n- 每个分配单元由一个条目索引，其原始字段为：一个 $48$ 位的物理地址，一个 $12$ 位的长度（以 $g$ 为单位），一个 $4$ 位的标志字段，以及一个 $32$ 位的校验和。该条目在 RAM 中被填充到下一个 8 字节的倍数。\n- 备用分数为 $r = 0.08$（一个小数）。\n- 固定的映射表头部大小为 $H = 1$ 兆字节 (MiB)，其中 $1$ MiB $= 2^{20}$ 字节。\n- RAM 预算为 $R_{\\max} = 24$ 吉字节 (GiB)，其中 $1$ GiB $= 2^{30}$ 字节。\n- 分配粒度 $g$ 必须是 $4$ 千字节 (KiB) 的整数倍，其中 $1$ KiB $= 2^{10}$ 字节。\n\n仅使用上述基本定义（即，直接访问要求每个分配单元有一个条目，且总条目数等于分配单元数乘以备用因子），确定最小的可行 $g$ 值，以确保整个内存中的映射结构能容纳在 RAM 预算之内。请以字节为单位表示您选择的 $g$ 作为最终答案。不要提供中间值。无需按有效数字进行四舍五入；您必须严格遵守“$4$ KiB 的倍数”这一约束。", "solution": "题目陈述经评估有效。其内容自洽，科学上基于操作系统设计的原理，并且在数学上是适定的。我们可以开始求解。\n\n问题要求我们确定以字节为单位的最小可行分配粒度 $g$，该粒度受限于几个约束条件。主要约束是内存中映射结构的总大小不得超过给定的 RAM 预算 $R_{\\max}$。\n\n首先，我们将给定参数之间的关系形式化。块设备的总大小为 $S$。设备被划分为大小为 $g$ 的分配单元。因此，分配单元的数量 $N_a$ 是设备总大小除以分配粒度：\n$$N_a = \\frac{S}{g}$$\n\n问题陈述，映射表为每个分配单元包含一个条目，此外还有一部分备用条目，其数量为实际条目数的分数 $r$。总条目数 $N_e$ 为：\n$$N_e = N_a + r \\cdot N_a = N_a(1+r)$$\n代入 $N_a$ 的表达式，我们得到：\n$$N_e = \\frac{S(1+r)}{g}$$\n\n接下来，我们必须计算单个映射表条目的大小 $e$。该条目由几个字段组成。这些字段的原始比特大小之和为：\n$$e_{\\text{raw\\_bits}} = 48 \\,(\\text{address}) + 12 \\,(\\text{length}) + 4 \\,(\\text{flags}) + 32 \\,(\\text{checksum}) = 96 \\text{ bits}$$\n因为 1 字节有 8 比特，所以以字节为单位的原始大小为：\n$$e_{\\text{raw\\_bytes}} = \\frac{96}{8} = 12 \\text{ bytes}$$\n问题指定该条目被填充到下一个 8 字节的倍数。大于或等于 12 的第一个 8 的倍数是 16。因此，内存中一个条目的对齐后大小为：\n$$e = 16 \\text{ bytes}$$\n\n内存中映射结构的总大小，我们将其表示为 $R_{\\text{total}}$，是固定头部大小 $H$ 与所有映射表条目总大小之和。\n$$R_{\\text{total}} = H + N_e \\cdot e$$\n代入我们关于 $N_e$ 的表达式：\n$$R_{\\text{total}} = H + \\frac{S(1+r)e}{g}$$\n\n这个总内存使用量必须小于或等于允许的最大 RAM 预算 $R_{\\max}$：\n$$H + \\frac{S(1+r)e}{g} \\le R_{\\max}$$\n\n我们的目标是找到 $g$ 的最小可能值。为此，我们重排不等式以求解 $g$。\n$$\\frac{S(1+r)e}{g} \\le R_{\\max} - H$$\n由于 $g$ 必须为正，我们可以将不等式两边同乘以 $g$ 并除以 $(R_{\\max} - H)$（其值为正），而不会改变不等号的方向：\n$$g \\ge \\frac{S(1+r)e}{R_{\\max} - H}$$\n这个不等式确立了 $g$ 的最小可能值。\n\n现在，我们将指定的数值代入此表达式。我们必须注意使用一致的单位，即字节，以及正确的二进制前缀（$1$ KiB = $2^{10}$ 字节, $1$ MiB = $2^{20}$ 字节, $1$ GiB = $2^{30}$ 字节, $1$ TiB = $2^{40}$ 字节）。\n- $S = 18 \\text{ TiB} = 18 \\times 2^{40}$ 字节\n- $r = 0.08$，这意味着 $1+r = 1.08$\n- $e = 16 \\text{ bytes} = 2^4$ 字节\n- $H = 1 \\text{ MiB} = 2^{20}$ 字节\n- $R_{\\max} = 24 \\text{ GiB} = 24 \\times 2^{30}$ 字节\n\n我们先计算分母：\n$$R_{\\max} - H = (24 \\times 2^{30}) - 2^{20} = (24 \\times 2^{10} \\times 2^{20}) - (1 \\times 2^{20}) = (24 \\times 1024 - 1) \\times 2^{20} = (24576 - 1) \\times 2^{20} = 24575 \\times 2^{20} \\text{ bytes}$$\n现在，计算分子：\n$$S(1+r)e = (18 \\times 2^{40}) \\cdot (1.08) \\cdot (16) = (18 \\times 1.08 \\times 16) \\times 2^{40} = 311.04 \\times 2^{40} \\text{ bytes}^2$$\n将这些值代入求 $g$ 最小值的不等式中：\n$$g \\ge \\frac{311.04 \\times 2^{40}}{24575 \\times 2^{20}} = \\frac{311.04}{24575} \\times 2^{20} \\text{ bytes}$$\n我们来计算这个表达式的值：\n$$g \\ge \\frac{311.04}{24575} \\times 1048576 \\approx 13271.04 \\text{ bytes}$$\n\n最后的约束是 $g$ 必须是 $4$ KiB 的整数倍。这个量的大小是：\n$$g_{\\text{quantum}} = 4 \\text{ KiB} = 4 \\times 2^{10} \\text{ bytes} = 4096 \\text{ bytes}$$\n所以，$g$ 的形式必须为 $k \\cdot 4096$，其中 $k$ 为某个正整数。我们必须找到最小的整数 $k$，使得这个条件和内存约束都得到满足：\n$$k \\cdot 4096 \\ge 13271.04$$\n$$k \\ge \\frac{13271.04}{4096} \\approx 3.23999$$\n由于 $k$ 必须是整数，因此 $k$ 的最小可能值为 $4$。\n\n因此，分配粒度 $g$ 的最小可行值为：\n$$g = 4 \\times 4096 = 16384 \\text{ bytes}$$", "answer": "$$\\boxed{16384}$$", "id": "3634057"}, {"introduction": "虽然直接访问允许我们跳转到任何数据块，但这个操作并非瞬时完成，尤其是在传统的机械硬盘（HDD）上。本实践 [@problem_id:3634116] 将引导你为HDD上的随机访问建立一个经典的性能模型。通过将总访问时间分解为其核心组成部分——寻道时间、旋转延迟和传输时间——你将对机械存储的物理限制有一个定量的理解。", "problem": "一个存储系统使用具有直接（随机）存取方式的硬盘驱动器 (HDD)。在直接存取方法中，任何块地址在任何时候被请求的概率均等，且磁头位置和盘片的角位置与下一个被请求的块在统计上是独立的。对于单次随机块读取，假设如下：\n\n1. HDD 的转速为 $7200$ 转每分钟 (RPM)。\n2. 磁盘有 $C=20000$ 个柱面，连续随机请求的初始柱面和目标柱面在 $\\{1,2,\\dots,C\\}$ 上独立且均匀分布。\n3. 寻道时间模型与当前柱面和目标柱面之间的绝对柱面距离 $d$ 呈线性关系：$T_{\\text{seek}}(d)=t_{0}+s\\,d$，其中 $t_{0}=2.0$ 毫秒 (ms)，$s=1.05\\times 10^{-3}$ 毫秒/柱面。\n4. 请求的块大小为 $4$ kibibyte ($4$ KiB)，持续传输速率为 $160$ mebibyte每秒 ($160$ MiB/s)，在传输过程中可视为常数。\n5. 忽略所有其他开销（例如，指令处理、排队、磁道偏斜）。\n\n任务：\na) 仅从磁头与所需扇区之间的角偏移在整个一圈旋转上均匀分布的假设出发，推导期望旋转延迟作为旋转周期 $T_{\\text{rot}}$ 的函数。\n\nb) 使用以上假设和您在 (a) 部分得到的结果，推导随机块读取的期望总存取时间 $E[T_{\\text{total}}]$ 的表达式（用 $C$、$t_{0}$、$s$ 和 $T_{\\text{rot}}$ 表示），然后根据给定的参数计算其数值。将最终时间以毫秒表示，并将您的答案四舍五入到四位有效数字。", "solution": "用户希望我解决一个关于计算硬盘驱动器 (HDD) 期望存取时间的问题。\n\n### 问题验证\n\n**第 1 步：提取已知条件**\n\n*   存取方法：直接（随机）存取。\n*   块地址请求的概率均等。\n*   磁头位置和盘片角位置与下一个请求在统计上独立。\n*   转速：$7200$ 转每分钟 (RPM)。\n*   柱面数：$C = 20000$。\n*   初始柱面 $c_1$ 在 $\\{1, 2, \\dots, C\\}$ 上均匀分布。\n*   目标柱面 $c_2$ 在 $\\{1, 2, \\dots, C\\}$ 上均匀分布。\n*   $c_1$ 和 $c_2$ 独立。\n*   寻道时间模型：$T_{\\text{seek}}(d) = t_0 + s \\cdot d$，其中 $d = |c_1 - c_2|$。\n*   寻道时间常数：$t_0 = 2.0$ 毫秒 (ms)。\n*   寻道时间因子：$s = 1.05 \\times 10^{-3}$ 毫秒/柱面。\n*   块大小：$4$ kibibyte ($4$ KiB)。\n*   持续传输速率：$160$ mebibyte每秒 ($160$ MiB/s)。\n*   开销被忽略。\n*   任务 (a)：假设角偏移均匀分布，推导期望旋转延迟 $E[T_{\\text{rotational}}]$ 作为旋转周期 $T_{\\text{rot}}$ 的函数。\n*   任务 (b)：推导期望总存取时间 $E[T_{\\text{total}}]$ 的表达式并进行数值计算。\n\n**第 2 步：使用提取的已知条件进行验证**\n\n根据验证标准对问题进行分析：\n\n1.  **科学性**：该问题使用了标准但简化的 HDD 性能模型。寻道时间、旋转延迟和传输时间是存储系统的基本概念。线性寻道时间模型是教科书中常见的近似方法。所有提供的参数对于 HDD 来说都是物理上现实的。该问题是合理的。\n2.  **适定性**：问题定义清晰。统计假设（均匀分布、独立性）已明确说明。任务要求基于这些假设推导期望值，这会得出一个唯一、稳定且有意义的解。该问题是适定的。\n3.  **客观性**：问题以精确、定量和无偏见的语言陈述。它不含任何主观或基于观点的内容。\n4.  **完整性**：所有必要的数据、模型和统计属性都已提供。问题是自包含的。\n5.  **其他缺陷**：该问题没有表现出任何其他缺陷，如无关紧要、矛盾或无法形式化。这是操作系统和计算机体系结构领域一个标准的、实质性的问题。\n\n**第 3 步：结论与行动**\n该问题是**有效的**。将提供解答。\n\n### 解答\n\n在 HDD 上存取一个随机块的总时间 $T_{\\text{total}}$ 是三个不同组成部分之和：寻道时间 $T_{\\text{seek}}$、旋转延迟 $T_{\\text{rotational}}$ 和传输时间 $T_{\\text{transfer}}$。\n$$T_{\\text{total}} = T_{\\text{seek}} + T_{\\text{rotational}} + T_{\\text{transfer}}$$\n根据期望的线性性质，期望总存取时间是这些组成部分期望值的总和：\n$$E[T_{\\text{total}}] = E[T_{\\text{seek}}] + E[T_{\\text{rotational}}] + E[T_{\\text{transfer}}]$$\n\n我们将按顺序完成每个任务。\n\n**a) 期望旋转延迟**\n\n此任务要求从第一性原理推导期望旋转延迟 $E[T_{\\text{rotational}}]$。设 $T_{\\text{rot}}$ 为磁盘盘片旋转一整圈所需的时间。问题陈述，读/写磁头与目标扇区起始位置之间的角偏移在整整一圈的范围内是均匀分布的。这意味着，等待扇区到达磁头下方的时间，即旋转延迟 $T_{\\text{rotational}}$，是一个在区间 $[0, T_{\\text{rot}}]$ 上均匀分布的连续随机变量。\n\n一个在 $[a, b]$ 上均匀分布的随机变量 $X$ 的概率密度函数 (PDF) 是 $f(x) = \\frac{1}{b-a}$，对于 $x \\in [a, b]$。对于 $T_{\\text{rotational}}$，我们有 $a=0$ 和 $b=T_{\\text{rot}}$，所以其 PDF 是：\n$$f(t) = \\frac{1}{T_{\\text{rot}}}, \\quad \\text{for } t \\in [0, T_{\\text{rot}}]$$\n期望值通过在其支撑集上对 $t \\cdot f(t)$ 进行积分来计算：\n$$E[T_{\\text{rotational}}] = \\int_{0}^{T_{\\text{rot}}} t \\cdot f(t) \\, dt = \\int_{0}^{T_{\\text{rot}}} t \\cdot \\frac{1}{T_{\\text{rot}}} \\, dt$$\n$$E[T_{\\text{rotational}}] = \\frac{1}{T_{\\text{rot}}} \\left[ \\frac{t^2}{2} \\right]_{0}^{T_{\\text{rot}}} = \\frac{1}{T_{\\text{rot}}} \\left( \\frac{T_{\\text{rot}}^2}{2} - 0 \\right) = \\frac{T_{\\text{rot}}}{2}$$\n期望旋转延迟是完整旋转一周时间的一半。任务 (a) 完成。\n\n**b) 期望总存取时间**\n\n为了求得 $E[T_{\\text{total}}]$，我们必须使用给定的参数求出每个分量的期望值。\n\n**1. 期望旋转延迟, $E[T_{\\text{rotational}}]$**\n首先，我们根据给定的转速 $7200$ RPM 计算 $T_{\\text{rot}}$。\n$$T_{\\text{rot}} = \\frac{1}{7200 \\text{ rotations/minute}} = \\frac{1 \\text{ minute}}{7200 \\text{ rotations}} = \\frac{60 \\text{ seconds}}{7200} = \\frac{1}{120} \\text{ s}$$\n转换为毫秒 (ms)：\n$$T_{\\text{rot}} = \\frac{1}{120} \\text{ s} \\times \\frac{1000 \\text{ ms}}{1 \\text{ s}} = \\frac{1000}{120} \\text{ ms} = \\frac{100}{12} \\text{ ms} = \\frac{25}{3} \\text{ ms}$$\n使用 (a) 部分的结果：\n$$E[T_{\\text{rotational}}] = \\frac{T_{\\text{rot}}}{2} = \\frac{1}{2} \\left(\\frac{25}{3}\\right) \\text{ms} = \\frac{25}{6} \\text{ ms}$$\n数值上，$E[T_{\\text{rotational}}] \\approx 4.167$ ms。\n\n**2. 传输时间, $T_{\\text{transfer}}$**\n对于固定的块大小和持续的传输速率，传输时间是确定性的。因此，$E[T_{\\text{transfer}}] = T_{\\text transfer}$。\n我们有一个 $4$ KiB ($4 \\times 2^{10}$ 字节) 的块大小和一个 $160$ MiB/s ($160 \\times 2^{20}$ 字节/秒) 的传输速率。\n$$T_{\\text{transfer}} = \\frac{\\text{Block Size}}{\\text{Transfer Rate}} = \\frac{4 \\times 2^{10} \\text{ bytes}}{160 \\times 2^{20} \\text{ bytes/s}} = \\frac{4}{160} \\times \\frac{2^{10}}{2^{20}} \\text{ s} = \\frac{1}{40} \\times 2^{-10} \\text{ s}$$\n$$T_{\\text{transfer}} = \\frac{1}{40 \\times 1024} \\text{ s} = \\frac{1}{40960} \\text{ s}$$\n转换为毫秒：\n$$T_{\\text{transfer}} = \\frac{1000}{40960} \\text{ ms} = \\frac{100}{4096} \\text{ ms} = \\frac{25}{1024} \\text{ ms}$$\n数值上，$T_{\\text{transfer}} \\approx 0.0244$ ms。\n\n**3. 期望寻道时间, $E[T_{\\text{seek}}]$**\n寻道时间由线性模型 $T_{\\text{seek}}(d) = t_{0} + s \\cdot d$ 给出，其中 $d = |c_1 - c_2|$ 是柱面距离。\n期望寻道时间是：\n$$E[T_{\\text{seek}}] = E[t_{0} + s \\cdot |c_1 - c_2|] = t_{0} + s \\cdot E[|c_1 - c_2|]$$\n我们必须求出两个独立随机变量 $c_1$ 和 $c_2$ 之间的期望距离 $E[d]$，这两个变量都在整数集合 $\\{1, 2, \\dots, C\\}$ 上均匀分布。\n$$E[d] = \\sum_{i=1}^{C} \\sum_{j=1}^{C} |i-j| P(c_1=i, c_2=j)$$\n由于独立性和均匀分布，$P(c_1=i, c_2=j) = P(c_1=i)P(c_2=j) = \\frac{1}{C} \\cdot \\frac{1}{C} = \\frac{1}{C^2}$。\n$$E[d] = \\frac{1}{C^2} \\sum_{i=1}^{C} \\sum_{j=1}^{C} |i-j|$$\n这个双重求和可以计算为：\n$$\\sum_{i=1}^{C} \\sum_{j=1}^{C} |i-j| = 2 \\sum_{i=1}^{C} \\sum_{j=1}^{i-1} (i-j) = 2 \\sum_{i=1}^{C} \\frac{(i-1)i}{2} = \\sum_{i=1}^{C} (i^2 - i) = \\sum_{i=1}^{C} i^2 - \\sum_{i=1}^{C} i$$\n使用幂和公式 $\\sum_{k=1}^{n} k = \\frac{n(n+1)}{2}$ 和 $\\sum_{k=1}^{n} k^2 = \\frac{n(n+1)(2n+1)}{6}$：\n$$\\sum_{i=1}^{C} \\sum_{j=1}^{C} |i-j| = \\frac{C(C+1)(2C+1)}{6} - \\frac{C(C+1)}{2} = \\frac{C(C+1)}{6} ((2C+1) - 3) = \\frac{C(C+1)(2C-2)}{6} = \\frac{C(C+1)2(C-1)}{6} = \\frac{C(C^2-1)}{3}$$\n因此，期望距离是：\n$$E[d] = \\frac{1}{C^2} \\frac{C(C^2-1)}{3} = \\frac{C^2-1}{3C}$$\n对于大的 $C$，这大约是 $\\frac{C}{3}$。\n现在，我们可以写出 $E[T_{\\text{seek}}]$ 的表达式：\n$$E[T_{\\text{seek}}] = t_0 + s \\left(\\frac{C^2-1}{3C}\\right)$$\n我们有 $C=20000$，$t_0=2.0$ ms，以及 $s=1.05 \\times 10^{-3}$ 毫秒/柱面。\n$$E[d] = \\frac{20000^2 - 1}{3 \\times 20000} = \\frac{4 \\times 10^8 - 1}{6 \\times 10^4} \\approx 6666.66665 \\text{ cylinders}$$\n$$E[T_{\\text{seek}}] = 2.0 + (1.05 \\times 10^{-3}) \\left(\\frac{20000^2 - 1}{60000}\\right) \\text{ ms}$$\n$$E[T_{\\text{seek}}] = 2.0 + (1.05 \\times 10^{-3}) \\left(\\frac{C}{3} - \\frac{1}{3C}\\right) = 2.0 + \\frac{1.05 \\times 10^{-3} \\times 20000}{3} - \\frac{1.05 \\times 10^{-3}}{3 \\times 20000}$$\n乘积的第一项是 $\\frac{1.05 \\times 20}{3} = \\frac{21}{3} = 7.0$。第二项小到可以忽略不计。\n$$E[T_{\\text{seek}}] \\approx 2.0 + 7.0 - \\frac{1.05 \\times 10^{-3}}{6 \\times 10^4} \\approx 9.0 - 1.75 \\times 10^{-8} \\text{ ms}$$\n所以，$E[T_{\\text{seek}}] \\approx 9.0$ ms。\n\n**$E[T_{\\text{total}}]$ 的推导和数值计算**\n期望总存取时间的符号表达式是：\n$$E[T_{\\text{total}}] = \\left(t_0 + s \\frac{C^2-1}{3C}\\right) + \\frac{T_{\\text{rot}}}{2} + T_{\\text{transfer}}$$\n现在，我们代入每个分量的数值：\n$$E[T_{\\text{seek}}] \\approx 9.00000 \\text{ ms}$$\n$$E[T_{\\text{rotational}}] = \\frac{25}{6} \\text{ ms} \\approx 4.16667 \\text{ ms}$$\n$$T_{\\text{transfer}} = \\frac{25}{1024} \\text{ ms} \\approx 0.02441 \\text{ ms}$$\n将这些值相加：\n$$E[T_{\\text{total}}] \\approx 9.00000 + 4.16667 + 0.02441 = 13.19108 \\text{ ms}$$\n问题要求将最终答案四舍五入到四位有效数字。将数值 $13.19108$ 四舍五入到四位有效数字是 $13.19$。\n\n最终表达式：\n$$E[T_{\\text{total}}] = t_{0} + s\\left(\\frac{C^2-1}{3C}\\right) + \\frac{T_{\\text{rot}}}{2} + \\frac{\\text{Block Size}}{\\text{Transfer Rate}}$$\n\n最终计算：\n$$E[T_{\\text{total}}] \\approx (9.0 - 1.75 \\times 10^{-8}) + \\frac{25}{6} + \\frac{25}{1024} \\text{ ms}$$\n$$E[T_{\\text{total}}] \\approx 8.9999999825 + 4.1666666667 + 0.0244140625 = 13.1910807117 \\text{ ms}$$\n四舍五入到四位有效数字得到 $13.19$ ms。", "answer": "$$\n\\boxed{13.19}\n$$", "id": "3634116"}, {"introduction": "像固态硬盘（SSD）这样的现代存储设备，提供了比HDD低得多的延迟和高得多的并行度。为了利用这种能力，我们必须将重点从最小化单个请求的延迟转向最大化系统吞吐量。本练习 [@problem_id:3634045] 介绍了一个来自排队论的基本概念——利特尔法则（Little's Law），用以确定饱和一个高性能设备所需的最优队列深度，展示了现代存储性能工程中的一项关键技术。", "problem": "一位操作系统存储工程师正在为一个异步输入/输出（I/O）子系统进行调优，该子系统处理的是直接（随机）访问工作负载，包括从固态硬盘中均匀随机读取大小为 $4$ KiB 的固定数据块。目标是选择一个主机端异步I/O队列深度，记为 $q$，使其在稳态操作下恰好足以保持设备饱和而不会利用不足。该工程师采用以下测量协议来区分两种测量角色：一种是低负载特性分析，用于估计设备的单次请求服务时间；另一种是高负载特性分析，用于估计可持续的吞吐量平台期。\n\n低负载特性分析：在队列深度为 $1$ 且请求之间有足够的思考时间以避免排队的情况下，测得的平均单次请求延迟为 $0.096$ ms。\n\n高负载特性分析：在预热后使用非常大的队列深度，测得的可持续吞吐量平台期接近 $3.49 \\times 10^{5}$ 每秒I/O操作数（IOPS）。\n\n为了提供用于验证的实验背景，我们进行了一次后续扫描，报告了实现的吞吐量 $X$（以IOPS为单位）作为队列深度 $q$ 的函数：\n- $q = 1 \\rightarrow X \\approx 1.02 \\times 10^{4}$\n- $q = 8 \\rightarrow X \\approx 8.2 \\times 10^{4}$\n- $q = 16 \\rightarrow X \\approx 1.60 \\times 10^{5}$\n- $q = 24 \\rightarrow X \\approx 2.30 \\times 10^{5}$\n- $q = 32 \\rightarrow X \\approx 3.10 \\times 10^{5}$\n- $q = 36 \\rightarrow X \\approx 3.33 \\times 10^{5}$\n- $q = 40 \\rightarrow X \\approx 3.44 \\times 10^{5}$\n- $q = 48 \\rightarrow X \\approx 3.49 \\times 10^{5}$\n- $q = 64 \\rightarrow X \\approx 3.49 \\times 10^{5}$\n- $q = 128 \\rightarrow X \\approx 3.49 \\times 10^{5}$\n\n任务：仅从操作系统的稳态流守恒和基本排队论出发（不使用其他现成公式），推导一个连接平均未完成请求数 $q$、实现的吞吐量 $X$（以请求/秒为单位）和平均单次请求延迟 $L$（以秒为单位）的关系式。使用该关系式获得一个实值表达式，用于计算达到等于测得平台期吞吐量的目标吞吐量所需的最小队列深度。然后，使用低负载平均延迟 $L = 0.096$ ms 和平台期吞吐量 $X = 3.49 \\times 10^{5}$ IOPS 对该表达式进行数值计算，并应用数学上的向上取整操作，得出应能使设备饱和的最小整数队列深度，记为 $q_{\\text{pred}}$。报告 $q_{\\text{pred}}$ 的整数值，不带单位。你可以定性地使用上述扫描数据来验证你预测的深度接近饱和点，但你提交的答案必须仅为整数 $q_{\\text{pred}}$。", "solution": "首先对问题陈述进行验证。\n\n**步骤1：提取已知条件**\n- 工作负载：直接（随机）访问，均匀随机读取。\n- 块大小：$4$ KiB。\n- 目标：找到能使设备饱和的最小整数主机端异步I/O队列深度 $q$。\n- 低负载特性分析（$q=1$，无排队）：平均单次请求延迟为 $0.096$ ms。\n- 高负载特性分析（大 $q$）：可持续吞吐量平台期接近 $X_{\\text{max}} = 3.49 \\times 10^{5}$ 每秒I/O操作数（IOPS）。\n- 用于计算的任务特定输入：\n    - 目标吞吐量 $X = 3.49 \\times 10^{5}$ IOPS。\n    - 模型中使用的延迟：$L = 0.096$ ms。\n- 任务要求：\n    1. 从稳态流守恒推导一个连接平均未完成请求数 $q$、实现的吞吐量 $X$ 和平均单次请求延迟 $L$ 的关系式。\n    2. 使用此关系式获得一个实值表达式，用于计算达到目标吞吐量所需的最小队列深度。\n    3. 对表达式进行数值计算。\n    4. 应用向上取整函数找到最小整数队列深度 $q_{\\text{pred}}$。\n- 用于定性验证的扫描数据：一组10个数据点，显示了队列深度 $q$ 从 $1$ 到 $128$ 时的吞吐量 $X$。\n\n**步骤2：使用提取的已知条件进行验证**\n该问题具有科学依据，定义明确且客观。\n- **科学依据：** 该问题是排队论在计算机系统性能分析中的一个经典应用，具体针对I/O子系统。队列深度、延迟、吞吐量和设备饱和度等概念是基础性的，并且应用正确。给出的延迟（$0.096$ ms）和吞吐量（$3.49 \\times 10^5$ IOPS）的数值对于现代固态硬盘（SSD）是符合实际的。\n- **定义明确性：** 该问题提供了一个明确的目标和所有必需的数据来实现它。它要求推导Little定律，这是排队论中的一个基本定理，并将其应用于特定场景。所要求的计算是明确定义的。\n- **客观性：** 语言是技术性的、精确的，并且没有偏见或主观论断。\n\n该问题不包含科学矛盾，不缺少完成所需任务的信息，也没有歧义。它要求推导的关系是该领域的核心。提供的实验扫描数据为验证提供了背景，快速检查表明其内部一致。例如，在 $q=1$ 时，数据显示 $X \\approx 1.02 \\times 10^4$ IOPS，问题陈述的延迟为 $0.096$ ms。使用Little定律，$q = X \\times L = (1.02 \\times 10^4 \\text{ s}^{-1}) \\times (0.096 \\times 10^{-3} \\text{ s}) \\approx 0.979$，这与给定的队列深度 $q=1$ 一致。问题有效。\n\n**步骤3：结论与行动**\n问题有效。将提供一个完整的解决方案。\n\n**推导与求解**\n问题要求从流守恒的第一性原理推导未完成请求数、吞吐量和延迟之间的关系。该关系通常被称为Little定律。\n\n考虑一个处于稳态的稳定系统。设 $q$ 表示系统中存在的平均请求数（即，正在队列中等待或正在被主动服务的请求）。设 $X$ 为请求到达系统的平均速率，在稳态下，该速率必须等于它们离开系统的平均速率。这个速率 $X$ 就是吞吐量，以单位时间内的请求数来衡量。设 $L$ 为一个请求在系统中花费的平均时间，从其到达至其离开。这个时间就是延迟。\n\n我们可以在一个很长的时间间隔 $T$ 内分析该系统。在此期间到达（并离开）的请求总数为：\n$$N = X \\cdot T$$\n这 $N$ 个请求中的每一个，在系统中平均花费时间 $L$。因此，在时间间隔 $T$ 内，所有通过系统的请求累积的总时间可以近似为请求数与每个请求平均时间的乘积：\n$$\\text{总请求时间} = N \\cdot L = (X \\cdot T) \\cdot L$$\n另外，我们也可以通过考虑任何时刻驻留在系统中的平均请求数 $q$ 来表示累积的总请求时间。在时间间隔 $T$ 内，这个平均占用量贡献的总时间为：\n$$\\text{总请求时间} = q \\cdot T$$\n通过将这两个表示总累积请求时间的表达式相等，我们得到守恒定律：\n$$q \\cdot T = X \\cdot L \\cdot T$$\n假设观察间隔 $T$ 大于零（$T > 0$），我们可以在两边同时除以 $T$，得到基本关系式：\n$$q = X \\cdot L$$\n这就是Little定律。它指出，在一个稳定的排队系统中，平均请求数是平均吞吐量和平均延迟的乘积。\n\n问题要求计算完全饱和I/O设备所需的最小队列深度 $q$。饱和是设备达到其最大可能吞吐量的工作点，该吞吐量作为平台期吞吐量给出，即 $X_{\\text{max}} = 3.49 \\times 10^{5}$ IOPS。为了达到这个吞吐量，我们必须维持一定数量的“在途”请求，以确保设备的内部处理单元永远不会空闲。这个在途请求的数量就是队列深度 $q$。\n\n乘积 $X \\cdot L$ 可以被解释为一种形式的带宽延迟积。在这里，$X$ 是系统的“带宽”（吞吐量），而 $L$ 是“延迟”。该乘积给出了为保持流水线满载所必须的请求总数。为了找到使设备饱和的最小队列深度，我们必须使用最大吞吐量 $X_{\\text{max}}$ 和相应的单次请求延迟。问题指示我们使用低负载延迟 $L_{\\text{low-load}} = 0.096$ ms 进行此计算。这是一个标准的工程近似，因为低负载延迟代表了在没有排队延迟时，请求的最佳情况下的固有服务时间。为了使设备的并行架构以其峰值速率 $X_{\\text{max}}$ 充分利用，我们必须有足够的未完成请求来覆盖每个工作流的延迟 $L_{\\text{low-load}}$。\n\n因此，所需的实值队列深度，我们记为 $q_{\\text{real}}$，为：\n$$q_{\\text{real}} = X_{\\text{max}} \\cdot L_{\\text{low-load}}$$\n给定条件：\n- $X_{\\text{max}} = 3.49 \\times 10^{5}$ 请求/秒\n- $L_{\\text{low-load}} = 0.096$ ms $= 0.096 \\times 10^{-3}$ 秒\n\n将这些值代入表达式中：\n$$q_{\\text{real}} = (3.49 \\times 10^{5} \\text{ s}^{-1}) \\cdot (0.096 \\times 10^{-3} \\text{ s})$$\n$$q_{\\text{real}} = 3.49 \\times 0.096 \\times 10^{5-3}$$\n$$q_{\\text{real}} = 0.33504 \\times 10^{2}$$\n$$q_{\\text{real}} = 33.504$$\n这个值代表了达到吞吐量平台期所需的平均并发请求数。由于I/O队列深度 $q$ 必须是整数，我们必须选择大于或等于此理论最小值的最小整数。这需要应用向上取整函数。\n预测的最小整数队列深度 $q_{\\text{pred}}$ 为：\n$$q_{\\text{pred}} = \\lceil q_{\\text{real}} \\rceil = \\lceil 33.504 \\rceil = 34$$\n与提供的扫描数据进行定性检查，证实此结果是合理的。在 $q=32$ 时，吞吐量为 $3.10 \\times 10^{5}$ IOPS，仍低于饱和状态。在 $q=36$ 时，吞吐量为 $3.33 \\times 10^{5}$ IOPS，非常接近平台期。我们计算出的值 $q_{\\text{pred}} = 34$ 正好落在这个区域，代表了饱和的大致起点。", "answer": "$$\\boxed{34}$$", "id": "3634045"}]}