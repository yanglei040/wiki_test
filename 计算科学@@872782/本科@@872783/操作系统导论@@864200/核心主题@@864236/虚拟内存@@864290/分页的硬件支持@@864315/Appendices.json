{"hands_on_practices": [{"introduction": "这项练习是理解为何TLB（快表）至关重要的基础。通过从第一性原理出发推导有效访问时间（EAT），你将量化TLB命中带来的性能增益和未命中造成的性能损失，为这一硬件缓存的重要性提供坚实的数学依据 [@problem_id:3623054]。本次实践将巩固你对内存地址转换关键路径的理解。", "problem": "一台计算机采用单级分页机制，并配备了硬件实现的快表（Translation Lookaside Buffer, TLB）。页表完全驻留在主存中。设主存访问时间为 $t_{m}$，TLB查找时间为 $t_{tlb}$，TLB命中率为 $h$（$0 \\leq h \\leq 1$）。假设TLB查找是串行执行的，不与任何主存访问重叠；一次TLB未命中需要在访问主存中的引用数据之前，从主存中获取一个页表项；并且没有缺页或其他延迟。\n\n仅从分页地址转换的核心定义和全期望定律出发，推导命中路径和未命中路径的访问时间，然后推导有效访问时间（EAT），即这两条路径的期望值。使用第一性原理比较命中路径成本和未命中路径成本的大小。最后，给出一个以 $t_{tlb}$、$t_{m}$ 和 $h$ 表示的、简化的EAT解析表达式。最终的时间应与 $t_{m}$ 和 $t_{tlb}$ 使用相同的时间单位，并以封闭形式表达式给出最终结果。", "solution": "首先将对问题的科学合理性、自洽性和客观性进行验证。\n\n### 步骤1：提取已知条件\n- 系统类型：带硬件快表（TLB）的单级分页系统。\n- 页表位置：完全在主存中。\n- 主存访问时间：$t_{m}$。\n- TLB查找时间：$t_{tlb}$。\n- TLB命中率：$h$，其中 $0 \\leq h \\leq 1$。\n- 时间假设1：TLB查找是串行执行的，不与任何主存访问重叠。\n- 时间假设2：一次TLB未命中需要在访问引用数据之前，从主存中获取一个页表项。\n- 系统状态：无缺页或其他延迟。\n\n### 步骤2：使用提取的已知条件进行验证\n对问题进行严格评估。\n- **科学依据：** 问题描述了一个简化但标准且典型的带TLB的内存管理单元（MMU）模型。分页、页表、TLB命中、TLB未命中以及相关的时间成本等概念是计算机体系结构和操作系统中的基本原理。该模型在科学上是合理的。\n- **适定性：** 问题提供了所有必要的变量（$t_{m}$、$t_{tlb}$、$h$），并清晰、明确地描述了TLB命中和TLB未命中两种情况下的操作序列。它要求一个具体的、可推导的量——有效访问时间（EAT），根据所提供的信息，存在唯一解。\n- **客观性：** 问题以精确、正式的语言陈述，没有主观论断或含糊之处。\n- **结论：** 问题有效。这是一个适定的、有科学依据的问题，并遵循其领域的基本原理。\n\n### 步骤3：裁定与行动\n问题被判定为**有效**。将提供一个完整的、有理有据的解答。\n\n### 解答推导\n目标是推导有效访问时间（EAT）的表达式。EAT是执行一次内存访问所需时间的期望值。推导从全期望定律开始，该定律指出，一个随机变量的期望值可以通过对一组互斥且穷尽的事件的条件期望进行加权求和得到，权重为它们各自的概率。\n\n在此情境下，对于任何给定的内存访问，两个可能的事件是TLB命中或TLB未命中。设 $T$ 为表示总访问时间的随机变量。设 $H$ 为TLB命中事件，$M$ 为TLB未命中事件。\nTLB命中的概率为 $P(H) = h$。\n由于命中或未命中是仅有的两种结果，未命中的概率为 $P(M) = 1 - h$。\n\nEAT是 $T$ 的期望值，记为 $E[T]$，可以表示为：\n$$EAT = E[T|H]P(H) + E[T|M]P(M)$$\n其中 $E[T|H]$ 是命中路径上的访问时间，$E[T|M]$ 是未命中路径上的访问时间。\n\n**1. 命中路径上的访问时间 ($T_{hit}$)**\n根据问题陈述，命中路径包括两个串行操作：\n- 首先，检查TLB以获取页到帧的映射。这需要时间 $t_{tlb}$。\n- 发生命中，直接从TLB获得物理帧号。\n- 有了完整的物理地址，访问主存以检索数据。这需要时间 $t_{m}$。\n一次命中的总时间是这些串行的、非重叠操作的时间之和：\n$$T_{hit} = E[T|H] = t_{tlb} + t_{m}$$\n\n**2. 未命中路径上的访问时间 ($T_{miss}$)**\n未命中路径涉及一个额外的步骤：\n- 首先，检查TLB。这需要时间 $t_{tlb}$。\n- 发生未命中。\n- 系统现在必须查询位于主存中的页表。从主存访问所需的页表项（PTE）需要一次主存访问时间，即 $t_{m}$。\n- PTE提供了物理帧号。\n- 有了完整的物理地址，访问主存以检索数据。这是第二次独立的主存访问，需要时间 $t_{m}$。\n一次未命中的总时间是这三个串行操作的时间之和：\n$$T_{miss} = E[T|M] = t_{tlb} + t_{m} + t_{m} = t_{tlb} + 2t_{m}$$\n\n**3. 命中路径与未命中路径成本的比较**\n根据第一性原理，主存访问时间 $t_{m}$ 必须是一个正数，即 $t_{m} > 0$。比较推导出的两种成本：\n$$T_{miss} = t_{tlb} + 2t_{m} = (t_{tlb} + t_{m}) + t_{m} = T_{hit} + t_{m}$$\n这表明未命中路径的成本比命中路径多出一个主存访问时间 $t_{m}$。这个额外成本代表了TLB未命中的惩罚，即从主存中的页表获取地址转换所需的时间。\n\n**4. 有效访问时间（EAT）的推导**\n将路径成本和概率代入EAT公式：\n$$EAT = T_{hit} \\cdot h + T_{miss} \\cdot (1 - h)$$\n$$EAT = (t_{tlb} + t_{m})h + (t_{tlb} + 2t_{m})(1 - h)$$\n为了得到一个简化的封闭形式表达式，我们可以重新排列这些项。一个概念上清晰的方法是围绕基础成本和惩罚成本对表达式进行因式分解。\n任何访问的成本都至少包括一次TLB查找和一次内存访问，即命中路径的时间。未命中会产生一次内存访问的额外惩罚，即 $t_{m}$。\n$$EAT = (t_{tlb} + t_{m})h + (t_{tlb} + t_{m} + t_{m})(1 - h)$$\n$$EAT = (t_{tlb} + t_{m})h + (t_{tlb} + t_{m})(1-h) + t_{m}(1-h)$$\n提取公因式 $(t_{tlb} + t_{m})$：\n$$EAT = (t_{tlb} + t_{m})(h + 1 - h) + t_{m}(1-h)$$\n$$EAT = (t_{tlb} + t_{m})(1) + t_{m}(1-h)$$\n$$EAT = t_{tlb} + t_{m} + t_{m} - h \\cdot t_{m}$$\n$$EAT = t_{tlb} + 2t_{m} - h \\cdot t_{m}$$\n最后，从后两项中提取 $t_{m}$，得到简化的解析表达式：\n$$EAT = t_{tlb} + (2 - h)t_{m}$$\n这个表达式表示有效访问时间，其时间单位与 $t_{tlb}$ 和 $t_{m}$ 相同。", "answer": "$$\\boxed{t_{tlb} + (2 - h)t_{m}}$$", "id": "3623054"}, {"introduction": "现实世界中的系统在从32位架构迁移到64位架构时，面临着内存开销与性能之间的权衡。这个问题要求你比较一个简单的线性页表和一个现代的多级页表，分析它们的内存占用和TLB未命中惩罚 [@problem_id:3646691]。这种量化的比较将揭示几乎所有现代处理器中采用的分层页表结构背后的设计原则。", "problem": "一门计算机体系结构课程研究了分页的硬件支持如何影响内存开销和旁路转换缓冲（TLB）的行为。考虑两个系统，它们都使用 $4$ KiB 的页面大小。\n\n系统 A 使用 $32$ 位虚拟地址（VA）和单级线性页表。该页表为整个地址空间中的每个虚拟页面包含一个页表条目（PTE），无论实际映射了多少页面。在系统 A 中，每个 PTE 为 $4$ 字节。\n\n系统 B 使用 $64$ 位虚拟地址（VA）和一个 $4$ 级基数为 $512$ 的页表树（例如，在典型的 $x86$-$64$ 设计中，其级别类似于 PML4、PDPT、PD 和 PT）。每一级的每个页表都恰好占用一个 $4$ KiB 的页面，并包含 $512$ 个条目；每个条目为 $8$ 字节。只有当某个级别的页表页中至少有一个条目需要用于映射某个更低级别的对象时，该页表页才会被分配。树的根页面总是被分配。\n\n假设一个进程从虚拟地址 $0$ 开始，连续映射其虚拟地址空间中恰好 $M = 2^{30}$ 字节的区域，并按页面边界对齐。映射的粒度为页面大小。对于系统 B，假设由连续映射引起的树的完美平衡使用，并且分配不受页表缓存效应的影响。\n\n对于 TLB 未命中时的行为，假设硬件页面遍历器（page walker）执行每种方案所需的最小页表条目内存读取次数。设数据缓存命中延迟为 $c = 4$ 个周期，主存延迟为 $m = 200$ 个周期。在系统 A 中，一次 TLB 未命中会触发恰好一次 PTE 读取，该读取以 $q_A = 0.9$ 的概率在数据缓存中命中，否则访问主存。在系统 B 中，一次 TLB 未命中会触发每个级别一次读取，总共 $4$ 次读取，并且每个级别的读取以 $q_B = 0.95$ 的概率独立地在数据缓存中命中，否则访问主存。\n\n定义以下两个量：\n\n- 内存开销比 $R_{\\text{mem}}$，定义为对于给定的 $M$ 字节映射，系统 A 分配的页表内存总字节数除以系统 B 分配的总字节数。\n- TLB 未命中惩罚比 $R_{\\text{tlb}}$，定义为在给定的缓存命中概率和延迟下，系统 B 中每次 TLB 未命中的预期周期数除以系统 A 中每次 TLB 未命中的预期周期数。\n\n计算复合无量纲度量\n$$\nJ \\;=\\; R_{\\text{mem}} \\times R_{\\text{tlb}} \\, .\n$$\n将你的答案四舍五入到四位有效数字。将最终结果表示为一个纯数字（无单位）。", "solution": "该问题经检验具有科学依据、问题明确、客观且自洽。所提供的数据在给定的计算机体系结构背景下是一致且现实的。我们开始解题。\n\n目标是计算复合度量 $J = R_{\\text{mem}} \\times R_{\\text{tlb}}$。这需要计算内存开销比 $R_{\\text{mem}}$ 和 TLB 未命中惩罚比 $R_{\\text{tlb}}$。\n\n首先，我们定义页面大小 $P_S$（以字节为单位）：\n$P_S = 4 \\text{ KiB} = 4 \\times 2^{10} \\text{ bytes} = 2^2 \\times 2^{10} \\text{ bytes} = 2^{12} \\text{ bytes}$。\n\n**1. 内存开销比（$R_{\\text{mem}}$）的计算**\n\n我们需要计算系统 A（$\\text{Mem}_A$）和系统 B（$\\text{Mem}_B$）中为页表分配的总内存。\n\n对于系统 A：\n该系统使用 $32$ 位虚拟地址空间和单级线性页表。虚拟地址空间的总大小为 $2^{32}$ 字节。整个地址空间中的虚拟页面数由总地址空间大小除以页面大小得出：\n$$\nN_{\\text{pages, A}} = \\frac{2^{32} \\text{ bytes}}{2^{12} \\text{ bytes/page}} = 2^{20} \\text{ pages}\n$$\n系统 A 为每个虚拟页面分配一个页表条目（PTE），无论其是否被映射。每个 PTE 的大小给定为 $4$ 字节。\n系统 A 的总内存开销为：\n$$\n\\text{Mem}_A = N_{\\text{pages, A}} \\times (\\text{PTE size}) = 2^{20} \\times 4 \\text{ bytes} = 2^{20} \\times 2^2 \\text{ bytes} = 2^{22} \\text{ bytes}\n$$\n\n对于系统 B：\n该系统映射一个大小为 $M = 2^{30}$ 字节的连续内存区域。该进程映射的页面数为：\n$$\nN_{\\text{mapped}} = \\frac{M}{P_S} = \\frac{2^{30} \\text{ bytes}}{2^{12} \\text{ bytes/page}} = 2^{18} \\text{ pages}\n$$\n系统 B 使用一个 $4$ 级基数为 $512$ 的页表。任何级别的每个页表都包含 $512 = 2^9$ 个条目，并占用一个 $4$ KiB（$2^{12}$ 字节）的页面。由于映射是从虚拟地址 $0$ 开始的连续映射，我们可以确定所需的页表页数。\n\n虚拟地址被拆分为用于页表 $4$ 个级别的索引和一个页面偏移量。偏移量为 $\\log_2(2^{12}) = 12$ 位。每个级别由 $\\log_2(512) = 9$ 位索引。因此，一个 $4$ 级页表的虚拟地址结构为 [索引 (4x9=36 位)][偏移量 (12 位)]。一个 L3 表条目覆盖的地址范围为 $512 \\times 512 \\times P_S = 2^9 \\times 2^9 \\times 2^{12} = 2^{30}$ 字节。所映射的内存量 $M=2^{30}$ 字节，恰好对应于一个 L3 页表条目（在 x86-64 中，是一个 PDPT 条目）所跨越的地址空间。\n\n我们来计算已分配的页表页数：\n- **第 1 级（L1，页表）：** 每个 L1 表映射 $512$ 个页面。要映射 $2^{18}$ 个页面，我们需要 $N_{L1} = \\frac{2^{18}}{512} = \\frac{2^{18}}{2^9} = 2^9 = 512$ 个 L1 表。\n- **第 2 级（L2，页目录）：** 每个 L2 表可以指向 $512$ 个 L1 表。由于我们需要 $512$ 个 L1 表，这些都可以由单个 L2 表引用。所以，$N_{L2} = 1$。\n- **第 3 级（L3，页目录指针表）：** 我们需要分配 $1$ 个 L2 表。这需要在 L3 表中占用一个条目。因此，必须分配一个 L3 表页。所以，$N_{L3} = 1$。\n- **第 4 级（L4，例如 PML4）：** 根页面总是被分配。它必须指向我们需要的那个 L3 表。所以，$N_{L4} = 1$。\n\n系统 B 的页表页总数是所有级别页数的总和：\n$$\nN_{\\text{tables, B}} = N_{L4} + N_{L3} + N_{L2} + N_{L1} = 1 + 1 + 1 + 512 = 515 \\text{ pages}\n$$\n这些页面中每一个的大小都是 $4$ KiB（$2^{12}$ 字节）。系统 B 的总内存开销为：\n$$\n\\text{Mem}_B = N_{\\text{tables, B}} \\times P_S = 515 \\times 2^{12} \\text{ bytes}\n$$\n内存开销比 $R_{\\text{mem}}$ 为：\n$$\nR_{\\text{mem}} = \\frac{\\text{Mem}_A}{\\text{Mem}_B} = \\frac{2^{22}}{515 \\times 2^{12}} = \\frac{2^{10}}{515} = \\frac{1024}{515}\n$$\n\n**2. TLB 未命中惩罚比（$R_{\\text{tlb}}$）的计算**\n\n我们需要计算为两个系统服务一次 TLB 未命中所需的预期周期数。\n设缓存命中延迟为 $c = 4$ 个周期，主存延迟为 $m = 200$ 个周期。\n\n对于系统 A ($T_A$)：\n一次 TLB 未命中触发一次 PTE 读取。此读取在数据缓存中命中的概率是 $q_A = 0.9$。预期惩罚是：\n$$\nT_A = q_A \\times c + (1 - q_A) \\times m = (0.9 \\times 4) + (0.1 \\times 200) = 3.6 + 20 = 23.6 \\text{ cycles}\n$$\n\n对于系统 B ($T_B$)：\n一次 TLB 未命中会触发一次页面遍历，涉及 $4$ 次内存读取，页表树的每个级别一次。每次读取都是一个独立事件，缓存命中率为 $q_B = 0.95$。\n其中单次读取的预期时间是：\n$$\nT_{\\text{read, B}} = q_B \\times c + (1 - q_B) \\times m = (0.95 \\times 4) + (0.05 \\times 200) = 3.8 + 10 = 13.8 \\text{ cycles}\n$$\n由于总惩罚是 $4$ 次顺序读取的延迟之和，系统 B 的总预期惩罚为：\n$$\nT_B = 4 \\times T_{\\text{read, B}} = 4 \\times 13.8 = 55.2 \\text{ cycles}\n$$\nTLB 未命中惩罚比 $R_{\\text{tlb}}$ 为：\n$$\nR_{\\text{tlb}} = \\frac{T_B}{T_A} = \\frac{55.2}{23.6}\n$$\n\n**3. 复合度量（$J$）的计算**\n\n最后，我们计算复合度量 $J$：\n$$\nJ = R_{\\text{mem}} \\times R_{\\text{tlb}} = \\frac{1024}{515} \\times \\frac{55.2}{23.6}\n$$\n为精确执行此计算，我们可以使用分数以避免浮点表示错误。\n$$\nR_{\\text{tlb}} = \\frac{55.2}{23.6} = \\frac{552}{236} = \\frac{4 \\times 138}{4 \\times 59} = \\frac{138}{59}\n$$\n现在，将此代入 $J$ 的表达式中：\n$$\nJ = \\frac{1024}{515} \\times \\frac{138}{59} = \\frac{1024 \\times 138}{515 \\times 59} = \\frac{141312}{30385}\n$$\n现在我们计算数值：\n$$\nJ \\approx 4.65070923...\n$$\n题目要求将答案四舍五入到四位有效数字。前四位有效数字是 $4$、$6$、$5$ 和 $0$。第五位有效数字是 $7$，所以我们将第四位数字向上取整。\n$$\nJ \\approx 4.651\n$$", "answer": "$$\n\\boxed{4.651}\n$$", "id": "3646691"}, {"introduction": "选择合适的页面大小是一项关键的系统设计决策，不存在一刀切的答案。本次实践将让你扮演系统设计者的角色，通过平衡TLB性能和内部碎片化这对相互竞争的压力来最小化总系统成本 [@problem_id:3646748]。通过对给定工作负载的这种权衡进行建模和优化，你将深入了解硬件参数和工作负载特性如何相互作用，共同决定最优的系统配置。", "problem": "考虑一个处理器，它实现了带有硬件支持（包括一个翻译后备缓冲器，TLB）的分页机制。该翻译后备缓冲器 (TLB) 是全相联的，采用最近最少使用 (LRU) 替换策略，并存储 $E$ 个页表条目。TLB未命中会产生 $T_m$ 周期的固定开销。系统分配了 $M$ 个独立的内存段，其大小与页面大小无关，并且由于内碎片导致的每字节浪费成本为 $c$ 周期/字节。\n\n工作负载以以下访问模式发出内存引用：\n- 以概率 $q$，该引用是对大小为 $S_A$ 字节的连续区域进行单次顺序遍历的一部分，其中每个字节按顺序被精确读取一次，并且该遍历足够长，以至于冷启动效应可以忽略不计。\n- 以概率 $1-q$，该引用是针对大小为 $S_B$ 字节的不同区域中均匀分布的一个随机字节，并且所访问的页面在各次引用之间是独立的（均匀独立引用 (UIR) 模型）。\n\n假设在顺序遍历下，每个页面在首次接触时恰好导致一次TLB未命中；在随机区域的UIR模型下，稳态TLB命中概率等于可以驻留在TLB中的工作集页面所占的比例；也就是说，如果随机区域跨越了 $R_B = S_B/P$ 个不同的页面（页面大小为 $P$），那么命中概率为 $\\min\\!\\left(1, E/R_B\\right)$，未命中概率为 $1 - \\min\\!\\left(1, E/R_B\\right)$。\n\n对于内碎片，将 $M$ 个段中每个段最后一个页面浪费的预期字节数建模为除以 $P$ 时的预期余数，在连续均匀余数假设下，该值等于 $P/2$。因此，预期的内碎片成本与 $P$ 成正比。\n\n给定参数\n- $E = 512$，\n- $T_m = 300$ 周期，\n- $q = 0.6$，\n- $S_A = 256 \\,\\mathrm{MiB}$ (此值足够大以验证顺序遍历的假设，且不会进入最终表达式)，\n- $S_B = 64 \\,\\mathrm{MiB} = 64 \\times 2^{20} = 67{,}108{,}864$ 字节，\n- $M = 6{,}144$ 段，\n- $c = 3 \\times 10^{-7}$ 周期/字节，\n\n以及允许的页面大小\n$$P \\in \\{4096,\\;8192,\\;16384,\\;65536,\\;131072\\}\\ \\text{字节},$$\n在指定的访问模式和模型下，确定能使每次引用的总成本最小化的页面大小 $P$。每次引用的总成本定义为预期的TLB未命中开销与预期的内碎片成本之和。明确计算每个允许的 $P$ 值的总成本，并选择使成本最小的值。最终答案以字节表示。无需四舍五入。", "solution": "### 步骤1：提取已知条件\n问题提供了以下参数、定义和模型：\n- TLB大小：$E = 512$ 条目\n- TLB未命中开销：$T_m = 300$ 周期\n- 工作负载混合概率（顺序）：$q = 0.6$\n- 工作负载混合概率（随机）：$1-q = 0.4$\n- 顺序访问区域大小：$S_A = 256 \\,\\mathrm{MiB}$\n- 随机访问区域大小：$S_B = 64 \\,\\mathrm{MiB} = 64 \\times 2^{20} = 67{,}108{,}864$ 字节\n- 独立内存段的数量：$M = 6{,}144$\n- 内碎片成本因子：$c = 3 \\times 10^{-7}$ 周期/字节\n- 允许的页面大小集合：$P \\in \\{4096, 8192, 16384, 65536, 131072\\}$ 字节\n- 顺序访问模型：每个页面恰好导致一次TLB未命中。冷启动效应可以忽略不计。\n- 随机访问模型：均匀独立引用 (UIR) 模型。随机区域中的页面数量为 $R_B = S_B/P$。TLB命中概率为 $\\min(1, E/R_B)$。\n- 内碎片模型：每个段的预期浪费字节数为 $P/2$。\n\n### 步骤2：使用提取的已知条件进行验证\n根据指定标准对问题进行验证。\n- **科学性：** 该问题使用了计算机体系结构和操作系统性能分析中的标准（尽管简化了）模型。TLB未命中开销、内碎片和工作负载建模（顺序与随机访问）等概念是该领域的基础。所提供的模型（例如，UIR命中概率、碎片期望值）在入门教材中很常见。\n- **适定性：** 提供了构建成本函数所需的所有参数。目标明确：最小化每次引用的总成本。优化变量页面大小 $P$ 被限制在一个有限集合内，这保证了在该集合中存在最小值。\n- **客观性：** 问题以精确、定量的术语陈述，没有主观语言或观点。\n- **不完整性/矛盾：** 碎片成本的单位存在潜在的模糊性。成本因子 $c$ 以“周期/字节”为单位，乘以总浪费字节数（$M \\cdot P/2$）后意味着总周期成本。然而，该成本必须与TLB未命中成本相加，而TLB未命中成本自然以“周期/引用”为单位表示。为了使问题可解，碎片成本也必须以每次引用的基础来表示。在这种学术问题中，最合理的解释是参数 $c$ 隐含了这种归一化。也就是说，$c$ 实际上是一个每次引用的成本因子，单位为（周期/引用）/字节。根据这一标准解释，该问题是自洽且一致的。\n- **不切实际/不可行性：** 所提供的TLB大小、未命中开销、内存大小和页面大小的数值都在真实世界或模拟计算机系统的典型范围内。在上述解释下，不存在物理或量纲上的不一致。\n- **未检测到其他缺陷。** 该问题既不普通也非同义反复，其结构合理，可得出唯一解。\n\n### 步骤3：结论与行动\n在此背景下，根据成本建模的标准解释，该问题被视为 **有效**。现在开始求解过程。\n\n### 求解推导\n目标是从给定集合中找到页面大小 $P$，以最小化每次引用的总成本 $C_{total}(P)$。该成本是每次引用的预期TLB未命中开销 $C_{tlb}(P)$ 和每次引用的预期内碎片成本 $C_{frag}(P)$ 之和。\n$$C_{total}(P) = C_{tlb}(P) + C_{frag}(P)$$\n\n**1. 每次引用的预期TLB未命中开销, $C_{tlb}(P)$**\n预期的TLB成本是两种访问模式成本的加权平均值。\n$$C_{tlb}(P) = q \\cdot C_{tlb, seq}(P) + (1-q) \\cdot C_{tlb, rand}(P)$$\n- 对于顺序遍历，成本为 $T_m$ 的TLB未命中每 $P$ 字节发生一次。每字节的成本是 $T_m/P$。由于一次引用是针对一个字节，因此每次引用的成本是：\n$$C_{tlb, seq}(P) = \\frac{T_m}{P}$$\n- 对于随机UIR模式，成本是未命中概率乘以未命中开销。随机区域中不同页面的数量是 $R_B = S_B/P$。未命中概率给定为 $m_B = 1 - \\min(1, E/R_B)$。\n$$C_{tlb, rand}(P) = T_m \\cdot \\left(1 - \\min\\left(1, \\frac{E}{R_B}\\right)\\right) = T_m \\cdot \\left(1 - \\min\\left(1, \\frac{E \\cdot P}{S_B}\\right)\\right)$$\n组合这些项：\n$$C_{tlb}(P) = q \\frac{T_m}{P} + (1-q) T_m \\left(1 - \\min\\left(1, \\frac{E \\cdot P}{S_B}\\right)\\right)$$\n\n**2. 每次引用的预期内碎片成本, $C_{frag}(P)$**\n每个段预期浪费的字节数是 $P/2$。对于 $M$ 个段，总浪费字节数是 $M \\cdot P/2$。这种浪费的成本由因子 $c$ 给出。如验证阶段所述，为了单位一致，这必须是每次引用的成本。\n$$C_{frag}(P) = \\left(M \\frac{P}{2}\\right) c = \\frac{M c}{2} P$$\n\n**3. 总成本函数**\n每次引用的总成本是：\n$$C_{total}(P) = q \\frac{T_m}{P} + (1-q) T_m \\left(1 - \\min\\left(1, \\frac{E \\cdot P}{S_B}\\right)\\right) + \\frac{M c}{2} P$$\n\n**数值计算**\n我们代入给定值：\n- $E = 512$\n- $T_m = 300$\n- $q = 0.6 \\implies 1-q = 0.4$\n- $S_B = 67{,}108{,}864$\n- $M = 6144$\n- $c = 3 \\times 10^{-7}$\n\n$C_{total}(P)$ 的表达式变为：\n$$C_{total}(P) = 0.6 \\frac{300}{P} + 0.4 \\cdot 300 \\left(1 - \\min\\left(1, \\frac{512 \\cdot P}{67{,}108{,}864}\\right)\\right) + \\frac{6144 \\cdot 3 \\times 10^{-7}}{2} P$$\n$$C_{total}(P) = \\frac{180}{P} + 120 \\left(1 - \\min\\left(1, \\frac{P}{131072}\\right)\\right) + (9216 \\times 10^{-7}) P$$\n$$C_{total}(P) = \\frac{180}{P} + 120 \\left(1 - \\min\\left(1, \\frac{P}{131072}\\right)\\right) + 0.0009216 \\cdot P$$\n\n函数的行为在 $P = 131072$ 处发生变化，此时 $E \\cdot P / S_B = 1$。\n- 当 $P  131072$ 时：\n$$C_{total}(P) = \\frac{180}{P} + 120 \\left(1 - \\frac{P}{131072}\\right) + 0.0009216 \\cdot P$$\n$$C_{total}(P) = \\frac{180}{P} + 120 - \\frac{120}{131072} P + 0.0009216 \\cdot P$$\n$$C_{total}(P) \\approx \\frac{180}{P} + 120 - 0.000915527 \\cdot P + 0.0009216 \\cdot P$$\n$$C_{total}(P) \\approx \\frac{180}{P} + 120 + 0.000006073 \\cdot P$$\n\n- 当 $P \\ge 131072$ 时：\n$$C_{total}(P) = \\frac{180}{P} + 120(1 - 1) + 0.0009216 \\cdot P$$\n$$C_{total}(P) = \\frac{180}{P} + 0.0009216 \\cdot P$$\n\n我们现在为每个允许的页面大小 $P$ 计算成本：\n\n- 对于 $P = 4096$（使用 $P  131072$ 的公式）：\n$$C_{total}(4096) = \\frac{180}{4096} + 120 \\left(1 - \\frac{4096}{131072}\\right) + 0.0009216 \\cdot 4096$$\n$$C_{total}(4096) = 0.0439453125 + 120(1 - 1/32) + 3.7744896$$\n$$C_{total}(4096) = 0.0439453125 + 120 - 3.75 + 3.7744896 = 120.0684349125$$\n\n- 对于 $P = 8192$（使用 $P  131072$ 的公式）：\n$$C_{total}(8192) = \\frac{180}{8192} + 120 \\left(1 - \\frac{8192}{131072}\\right) + 0.0009216 \\cdot 8192$$\n$$C_{total}(8192) = 0.02197265625 + 120(1 - 1/16) + 7.5489792$$\n$$C_{total}(8192) = 0.02197265625 + 120 - 7.5 + 7.5489792 = 120.07095185625$$\n\n- 对于 $P = 16384$（使用 $P  131072$ 的公式）：\n$$C_{total}(16384) = \\frac{180}{16384} + 120 \\left(1 - \\frac{16384}{131072}\\right) + 0.0009216 \\cdot 16384$$\n$$C_{total}(16384) = 0.010986328125 + 120(1 - 1/8) + 15.0979584$$\n$$C_{total}(16384) = 0.010986328125 + 120 - 15 + 15.0979584 = 120.108944728125$$\n\n- 对于 $P = 65536$（使用 $P  131072$ 的公式）：\n$$C_{total}(65536) = \\frac{180}{65536} + 120 \\left(1 - \\frac{65536}{131072}\\right) + 0.0009216 \\cdot 65536$$\n$$C_{total}(65536) = 0.00274658203125 + 120(1 - 1/2) + 60.3918336$$\n$$C_{total}(65536) = 0.00274658203125 + 120 - 60 + 60.3918336 = 120.394580182_...$$\n\n- 对于 $P = 131072$（使用 $P \\ge 131072$ 的公式）：\n$$C_{total}(131072) = \\frac{180}{131072} + 0.0009216 \\cdot 131072$$\n$$C_{total}(131072) = 0.001373291015625 + 120.7836672 = 120.78504049...$$\n\n比较总成本：\n- $C_{total}(4096) \\approx 120.068$\n- $C_{total}(8192) \\approx 120.071$\n- $C_{total}(16384) \\approx 120.109$\n- $C_{total}(65536) \\approx 120.395$\n- $C_{total}(131072) \\approx 120.785$\n\n最小成本出现在集合中最小的页面大小处。最小化每次引用总成本的页面大小 $P$ 是 $4096$ 字节。", "answer": "$$\\boxed{4096}$$", "id": "3646748"}]}