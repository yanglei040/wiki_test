{"hands_on_practices": [{"introduction": "在掌握了基础知识之后，这个练习将深入探讨TLB性能中一个更微妙的方面：冲突未命中。我们将研究一个特定的内存访问模式——固定步幅访问，如何与TLB的映射机制相互作用，从而导致病态的性能表现，即便TLB仍有可用条目。这个思想实验揭示了数据布局和访问模式对于性能是多么关键，尤其是在较为简单的直接映射硬件结构中 [@problem_id:3689175]。", "problem": "一个程序在虚拟内存中扫描一个非常大的数组，其访问模式如下：第 $n$ 次内存访问的虚拟地址为 $A_{n} = A_{0} + n s$，其中 $A_{0}$ 是页面对齐的，$s$ 是以字节为单位的正步长，且 $n \\in \\{0, 1, 2, \\dots\\}$。虚拟页面大小为 $P$ 字节。系统使用一个转译后备缓冲器 (TLB)，具体来说是一个有 $E$ 个条目的直接映射 TLB。虚拟页号的 TLB 索引由 $i(v) = v \\bmod E$ 给出，其中虚拟页号 $v$ 定义为 $v = \\left\\lfloor \\frac{A}{P} \\right\\rfloor$。TLB 初始为空，当发生缺失时，被引用虚拟页面的转译被插入到直接映射条目 $i(v)$ 中，驱逐该条目中任何已有的转译。假设数组和访问次数足够大，以至于该序列会访问许多不同的虚拟页面（你可以假设至少触及 $E+1$ 个不同的虚拟页面），并且除了该访问模式所隐含的重用之外，没有其他转译的重用。\n\n仅从这些定义和事实出发，推导在这种访问模式下，直接映射 TLB 中冲突缺失最大化的步长 $s$ 的充分必要条件，即每次对新虚拟页面的访问都映射到相同的 TLB 索引并驱逐之前的转译。然后，使用该条件，确定实现这种最坏情况冲突行为的最小正步长 $s$（以字节为单位），用 $P$ 和 $E$ 的闭式表达式表示。请以 $P$ 和 $E$ 的单个闭式表达式的形式提供您的最终答案。无需四舍五入，最终的方框答案中不要包含单位。[@problem_id:458]", "solution": "问题要求我们找到使直接映射转译后备缓冲器 (TLB) 中冲突缺失最大化的步长 $s$ 的充分必要条件，然后找出满足此条件的最小正步长 $s$。\n\n让我们从形式化给定的信息开始。\n第 $n$ 次内存访问的虚拟地址 $A_n$ 由以下等差数列给出：\n$$A_n = A_0 + n s, \\quad n \\in \\{0, 1, 2, \\dots\\}$$\n其中 $A_0$ 是起始地址，$s$ 是以字节为单位的正步长。\n虚拟页面大小为 $P$ 字节。起始地址 $A_0$ 是页面对齐的，这意味着 $A_0$ 是 $P$ 的整数倍。我们可以将其写为 $A_0 = v_0 P$，其中 $v_0$ 是某个整数，代表起始地址的虚拟页号。\n\n对于一个通用虚拟地址 $A$，其虚拟页号 $v$ 由下式给出：\n$$v(A) = \\left\\lfloor \\frac{A}{P} \\right\\rfloor$$\n因此，第 $n$ 次访问的虚拟页号是：\n$$v_n = v(A_n) = \\left\\lfloor \\frac{A_0 + ns}{P} \\right\\rfloor = \\left\\lfloor \\frac{v_0 P + ns}{P} \\right\\rfloor = v_0 + \\left\\lfloor \\frac{ns}{P} \\right\\rfloor$$\n\n系统有一个具有 $E$ 个条目的直接映射 TLB。虚拟页号 $v$ 的 TLB 索引为：\n$$i(v) = v \\bmod E$$\n\n问题将最大化冲突缺失的条件定义为“每次对新虚拟页面的访问都映射到相同的 TLB 索引并驱逐之前的转译”。\n设程序按升序访问的不同虚拟页面的序列为 $V_0, V_1, V_2, \\dots$。\n该条件意味着，对于每一个不同的页面，其 TLB 索引必须是相同的常数值。\n$$i(V_k) = \\text{对于所有 } k \\ge 0 \\text{ 均为常数}$$\n这等价于：\n$$V_k \\pmod E = I$$\n其中 $I$ 是某个恒定的整数索引。\n这也意味着，对于任何两个被访问的不同页面 $V_j$ 和 $V_k$，我们必须有 $V_j \\equiv V_k \\pmod E$。\n\n第一次访问的虚拟页面是当 $n=0$ 时：\n$$v_0 = v_0 + \\left\\lfloor \\frac{0 \\cdot s}{P} \\right\\rfloor = v_0$$\n所以，访问的第一个不同页面是 $V_0 = v_0$。任何后续的不同页面 $V_k$ 都必须满足 $V_k \\equiv V_0 \\pmod E$。\n$$V_k - V_0 \\equiv 0 \\pmod E$$\n所有被访问的不同虚拟页面的集合由 $\\{v_0 + U_k\\}$ 给出，其中 $\\{U_k\\}$ 是由 $\\lfloor ns/P \\rfloor$ 对 $n=0, 1, 2, \\dots$ 生成的唯一值的有序集合。\n因此，条件简化为要求 $\\lfloor ns/P \\rfloor$ 的每个唯一的非零值都是 $E$ 的倍数。更正式地，对于所有 $n \\ge 0$：\n$$\\left\\lfloor \\frac{ns}{P} \\right\\rfloor \\equiv 0 \\pmod E$$\n\n令 $\\alpha = s/P$。条件是对于所有 $n \\ge 0$，$\\lfloor n\\alpha \\rfloor \\equiv 0 \\pmod E$。\n我们可以将 $\\alpha$ 表示为其整数部分和小数部分之和：$\\alpha = \\lfloor \\alpha \\rfloor + \\{\\alpha\\}$，其中 $\\lfloor \\alpha \\rfloor$ 是一个整数，且 $0 \\le \\{\\alpha\\}  1$。\n页号偏移量的表达式变为：\n$$\\lfloor n\\alpha \\rfloor = \\lfloor n(\\lfloor \\alpha \\rfloor + \\{\\alpha\\}) \\rfloor = \\lfloor n\\lfloor \\alpha \\rfloor + n\\{\\alpha\\} \\rfloor = n\\lfloor \\alpha \\rfloor + \\lfloor n\\{\\alpha\\} \\rfloor$$\n所以条件是：\n$$n\\lfloor \\alpha \\rfloor + \\lfloor n\\{\\alpha\\} \\rfloor \\equiv 0 \\pmod E \\quad \\text{对于所有 } n \\ge 0$$\n\n让我们分析这个条件。\n首先，考虑 $n=1$：\n$$\\lfloor \\alpha \\rfloor + \\lfloor \\{\\alpha\\} \\rfloor \\equiv 0 \\pmod E$$\n因为 $0 \\le \\{\\alpha\\}  1$，我们有 $\\lfloor \\{\\alpha\\} \\rfloor = 0$。条件变为：\n$$\\lfloor \\alpha \\rfloor \\equiv 0 \\pmod E$$\n这意味着 $\\lfloor s/P \\rfloor$ 必须是 $E$ 的整数倍。设 $\\lfloor s/P \\rfloor = mE$，其中 $m$ 为某个非负整数。\n\n将此代回一般条件中，我们得到：\n$$n(mE) + \\lfloor n\\{\\alpha\\} \\rfloor \\equiv 0 \\pmod E$$\n由于 $n(mE)$ 总是 $E$ 的倍数，条件简化为：\n$$\\lfloor n\\{\\alpha\\} \\rfloor \\equiv 0 \\pmod E \\quad \\text{对于所有 } n \\ge 0$$\n其中 $\\{\\alpha\\} = \\{s/P\\}$ 是 $s/P$ 的小数部分。\n\n让我们分析这个剩余的条件。令 $f = \\{\\alpha\\} = \\{s/P\\}$。我们有 $0 \\le f  1$。我们需要对于所有 $n \\ge 0$，$\\lfloor nf \\rfloor$ 都是 $E$ 的倍数。\n如果 $f > 0$，我们总能找到一个整数 $n$ 使得 $1 \\le nf  E$（假设 $E>1$）。例如，我们可以选择 $n = \\lceil 1/f \\rceil$。对于这个 $n$，$nf \\ge 1$。并且，$n  1/f + 1$，所以 $nf  1+f$。因为 $f1$，所以 $nf  2$。因此，$\\lfloor nf \\rfloor$ 将是 $1$。\n所以，如果 $f > 0$，我们会找到一个 $n$ 值，使得 $\\lfloor nf \\rfloor = 1$。条件则要求 $1 \\equiv 0 \\pmod E$，这意味着 $E=1$。\n对于 $E$ 可以是任何正整数的一般情况，除非 $E=1$，否则我们不能有 $f > 0$。因此，为了满足 $E > 1$ 的条件，我们必须有 $f=0$。\n\n条件 $f=0$ 意味着 $\\{\\alpha\\} = \\{s/P\\} = 0$。这意味着 $s/P$ 必须是一个整数。设 $s/P = c$，其中 $c$ 为某个正整数（因为 $s>0, P>0$）。这意味着步长 $s$ 必须是页面大小 $P$ 的整数倍。\n\n所以，我们推导出了两个必要条件：\n1. $s$ 是 $P$ 的倍数。设 $s = cP$，其中 $c \\ge 1$ 为整数。\n2. $\\lfloor s/P \\rfloor$ 是 $E$ 的倍数。代入 $s=cP$，我们得到 $\\lfloor cP/P \\rfloor = c$ 必须是 $E$ 的倍数。\n\n结合这两点，$c$ 必须是 $E$ 的正整数倍。我们可以写成 $c=mE$，其中 $m \\in \\{1, 2, 3, \\dots\\}$ 是一个正整数。\n因此，步长 $s$ 必须具有以下形式：\n$$s = cP = (mE)P = mEP$$\n这是引起所述最坏情况冲突行为的 $s$ 的充分必要条件。\n\n最后，问题要求满足此条件的最小正步长 $s$。这对应于 $m$ 的最小正整数值，即 $m=1$。\n设 $m=1$，我们找到最小正步长：\n$$s_{min} = 1 \\cdot EP = EP$$\n\n最终答案是 $EP$。这正是所要求的用 $P$ 和 $E$ 表示的闭式表达式。", "answer": "$$\\boxed{EP}$$", "id": "3689175"}, {"introduction": "我们最后的练习将探讨替换策略这一复杂主题。并非所有的TLB未命中都是等同的，本练习将挑战一个普遍的假设，即最近最少使用（LRU）策略总是最优的。通过分析一个特定的循环访问模式，我们将揭示一个场景，其中简单的随机替换策略的性能显著优于LRU，这阐明了一个重要原则：最佳策略是依赖于具体工作负载的 [@problem_id:3689229]。", "problem": "转换旁路缓冲（TLB）是内存管理单元使用的一种小型、快速的相联结构，用于缓存最近的虚拟到物理页的转换。考虑一个组相联 TLB，它有 $S$ 个组，每组有 $W$ 路（相联度），总容量为 $S \\cdot W$ 个条目。每个虚拟页通过一个固定的索引函数确定性地映射到 $S$ 个组中的一个；在一个组内，任何一路都可以保存该转换。当发生未命中时，替换策略在每个组内独立应用。我们比较两种策略：最近最少使用（LRU），它会替换掉组中未使用时间最长的条目；以及随机替换，它在每次未命中时从组中均匀随机选择一个已驻留条目进行替换。将颠簸定义为因重复访问超出每组容量的工作集而导致的持续性未命中。\n\n假设一个循环访问模式，它以固定的循环顺序无限次地接触 $S \\cdot W + 1$ 个不同的虚拟页。页到组的映射关系是这样的：$S-1$ 个组恰好访问 $W$ 个不同的页（可以容纳），而一个组（称之为过载组）访问 $W+1$ 个不同的页（超出该组容量 1）。在每个组内，对其页的访问顺序是针对该组页面的简单循环顺序。假设 $W \\ge 2$。\n\n哪种说法能最好地从基本原理出发，预测在此场景下哪种策略能减少颠簸，并量化整个循环产生的稳态未命中率？\n\nA. 随机替换相对于最近最少使用（LRU）策略减少了颠簸。在过载组中，LRU 对其 $W+1$ 个页的每次访问都会产生一次未命中，而随机替换对这些访问产生的预期未命中率约为 $2/(W+1)$。因此，在整个循环中，随机替换下的总未命中率约为 $2/(S \\cdot W + 1)$，而 LRU 下的总未命中率约为 $(W+1)/(S \\cdot W + 1)$。\n\nB. 最近最少使用（LRU）相对于随机替换减少了颠簸，因为即使工作集大小超出容量 1，其栈属性也能确保保留最近的 $W$ 个页，从而使得 LRU 下的总未命中率低于随机替换。\n\nC. 对于此访问模式，在稳态下，两种策略表现出相同的颠簸行为；两种策略的总未命中率均为 $(W+1)/(S \\cdot W + 1)$。\n\nD. 随机替换在过载组中相对于 LRU 增加了颠簸，因为它有时会替换掉下一个即将被使用的页，使其总未命中率大于 LRU。", "solution": "为了确定哪种策略能更好地处理这种特定的访问模式，我们需要分别分析两种替换策略（LRU 和随机）在稳态下的行为，并计算它们的总未命中率。\n\n首先，分析问题中的两种类型的TLB组：\n1.  **行为良好的组**：有 $S-1$ 个这样的组。每个组的容量为 $W$ 路，并且恰好被 $W$ 个不同的页面访问。由于工作集大小等于组容量，在初始填充阶段后，这 $W$ 个页面的翻译将稳定地驻留在组中。因为对这些页面的访问是循环的，且没有新的页面映射到这些组，所以无论是LRU还是随机替换策略，在稳态下对这些组的访问都将是100%命中。因此，这 $(S-1)W$ 个页面的稳态未命中率为 0。\n\n2.  **过载组**：有 1 个这样的组。其容量为 $W$ 路，但被 $W+1$ 个不同的页面访问（我们称之为 $P_0, P_1, \\dots, P_W$）。访问模式是严格的循环序列：$P_0, P_1, \\dots, P_W, P_0, \\dots$。\n\n现在，我们分析两种策略在过载组中的性能：\n\n**最近最少使用（LRU）策略：**\nLRU策略在这种“循环加一”的访问模式下会表现出最差的性能，即颠簸。\n- 让我们追踪访问序列。假设组中最初缓存了 $\\{P_0, \\dots, P_{W-1}\\}$。\n- 当访问 $P_W$ 时，发生未命中。根据LRU规则，$P_0$ 是最近最少使用的页面，因此被替换出去。组中现在包含 $\\{P_1, \\dots, P_W\\}$。\n- 序列中的下一次访问是 $P_0$。这又是一次未命中，因为 $P_0$ 刚刚被替换掉。此时，$P_1$ 是LRU页面，它将被替换。\n- 这个模式会持续下去：对于循环中的每一次访问，被访问的页面恰好是 $W$ 次访问之前为了给新页面腾出空间而被替换出去的那个。\n- 因此，在过载组中，LRU策略下的每一次访问都会导致一次未命中。该组的未命中率为 100% 或 1。\n\n**随机替换策略：**\n当发生未命中时，随机策略会从组中的 $W$ 个现有条目中随机选择一个进行替换。\n- 假设对页面 $P_i$ 的访问发生了未命中。这意味着组中缓存了除 $P_i$ 之外的所有其他 $W$ 个页面。\n- 当 $P_i$ 被调入时，一个随机选择的页面 $P_k$ (其中 $k \\neq i$) 被替换出去。\n- 接下来的访问序列将是 $P_{i+1}, P_{i+2}, \\dots$ （索引模 $W+1$）。这些访问都将是命中，直到访问到刚刚被替换出去的页面 $P_k$ 为止。\n- 一次未命中后，下一次未命中前的预期命中次数是多少？被替换的页面 $P_k$ 是从当前组中的 $W$ 个页面中以 $1/W$ 的概率均匀选择的。在循环访问模式下，从当前访问 $P_i$ 到下一个访问 $P_k$ 之间有一定数量的页面。这个数量就是命中次数。\n- 平均而言，一次未命中后的预期命中次数为：\n$$E[\\text{hits}] = \\sum_{j=0}^{W-1} j \\cdot \\frac{1}{W} = \\frac{1}{W} \\frac{(W-1)W}{2} = \\frac{W-1}{2}$$\n- 一个典型的事件周期包含 1 次未命中和预期的 $\\frac{W-1}{2}$ 次命中，总访问次数为 $1 + \\frac{W-1}{2} = \\frac{W+1}{2}$。\n- 因此，过载组在随机策略下的预期未命中率为：\n$$\\text{未命中率}_{\\text{随机}} = \\frac{\\text{未命中次数}}{\\text{总访问次数}} = \\frac{1}{(W+1)/2} = \\frac{2}{W+1}$$\n\n**计算总未命中率：**\n一个完整的访问循环包含 $N_{\\text{total}} = S \\cdot W + 1$ 次对不同页面的访问。\n- **LRU 总未命中率**：\n  总未命中次数 = (良好组的未命中) + (过载组的未命中) = $0 + (W+1) \\times 1 = W+1$。\n  总未命中率 = $\\frac{\\text{总未命中次数}}{N_{\\text{total}}} = \\frac{W+1}{S \\cdot W + 1}$。\n- **随机替换总未命中率**：\n  总预期未命中次数 = $0 + (W+1) \\times \\frac{2}{W+1} = 2$。\n  总未命中率 = $\\frac{\\text{总预期未命中次数}}{N_{\\text{total}}} = \\frac{2}{S \\cdot W + 1}$。\n\n**结论与选项评估：**\n由于假设 $W \\ge 2$，则 $W+1 > 2$。因此，LRU的总未命中率 $\\frac{W+1}{S \\cdot W + 1}$ 明显高于随机替换的总未命中率 $\\frac{2}{S \\cdot W + 1}$。随机策略在这种特定的病态工作负载下性能要好得多，因为它避免了LRU的确定性颠簸行为。\n\n- **选项 A** 正确地指出随机替换减少了颠簸，并准确地量化了过载组和整个循环中两种策略的未命中率。\n- **选项 B** 错误地声称LRU更好。\n- **选项 C** 错误地声称两种策略性能相同。\n- **选项 D** 错误地声称随机替换增加了颠簸。\n\n因此，选项A是唯一正确的描述。", "answer": "$$\\boxed{A}$$", "id": "3689229"}]}