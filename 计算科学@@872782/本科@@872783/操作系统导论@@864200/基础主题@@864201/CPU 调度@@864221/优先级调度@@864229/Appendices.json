{"hands_on_practices": [{"introduction": "要真正掌握优先级调度，我们首先要从其最基本的形式之一——比例份额调度开始。这个练习将帮助你通过一个清晰的数学模型，理解如何将抽象的“优先级权重”转化为具体的 CPU 时间分配。通过推导这个核心关系 [@problem_id:3671520]，你将为理解更复杂的调度策略打下坚实的基础。", "problem": "一个操作系统使用比例份额调度器在 $n$ 个持续可运行的CPU密集型类别（索引为 $i \\in \\{1,\\dots,n\\}$）之间分配中央处理器（CPU）时间。每个类别 $i$ 被分配一个正的优先级权重 $w_i \\in \\mathbb{R}_{>0}$。该调度器根据以下核心定义进行设计：(i) 它是工作保持的，意味着只要有任何类别可运行，CPU就不会空闲，以及 (ii) 它强制执行比例性，意味着在稳态下，一个类别的长期服务率与其权重成正比。CPU容量被归一化为每单位时间1个服务单位。考虑一个长度为 $T > 0$ 的观察窗口，在此期间所有 $n$ 个类别都保持可运行状态，且系统保持在稳态。\n\n仅使用这些定义和容量守恒，推导在持续时间 $T$ 内分配给类别 $i$ 的期望CPU时间的闭式表达式，该表达式应使用 $w_i$、$\\sum_{j=1}^{n} w_j$ 和 $T$ 来表示。将你的最终答案表示为单个解析表达式。最终答案中不要包含单位。", "solution": "该问题要求推导在一个给定时间间隔内分配给特定类别 $i$ 的期望中央处理器（CPU）时间的闭式表达式。我们将把所给的定义和约束形式化为一个数学模型，以得出解答。\n\n首先，我们定义主要变量。有 $n$ 个可运行类别，索引为 $i \\in \\{1, \\dots, n\\}$。每个类别 $i$ 被分配一个正的优先级权重，记为 $w_i$，其中 $w_i \\in \\mathbb{R}_{>0}$。观察窗口的总持续时间为 $T > 0$。总CPU容量被归一化为每单位时间1个服务单位。\n\n设 $S_i$ 为分配给类别 $i$ 的长期服务率。这代表类别 $i$ 接收到的总CPU容量的份额。问题指出，该服务率与类别权重 $w_i$ 成正比。我们可以通过引入一个比例常数 $k$ 来数学地表示这种比例关系：\n$$S_i = k \\cdot w_i$$\n这个常数 $k$ 对所有类别 $i=1, \\dots, n$ 都是相同的，因为它建立了全系统范围内权重和服务率之间的比例关系。\n\n下一个信息是调度器是工作保持的。一个工作保持的调度器确保只要至少有一个可运行的进程，CPU就不会空闲。问题陈述指明，在长度为 $T$ 的观察窗口内，所有 $n$ 个类别都是持续可运行的。因此，在此期间CPU被完全利用。所有类别分配到的服务率之和因此必须等于总CPU容量。鉴于容量被归一化为1，我们可以写出一个守恒定律：\n$$\\sum_{i=1}^{n} S_i = 1$$\n现在我们可以通过将 $S_i$ 的表达式代入守恒方程来确定比例常数 $k$ 的值：\n$$\\sum_{i=1}^{n} (k \\cdot w_i) = 1$$\n由于 $k$ 是相对于求和索引 $i$ 的常数，我们可以将其从求和中提取出来：\n$$k \\left( \\sum_{i=1}^{n} w_i \\right) = 1$$\n问题指出每个权重 $w_i$ 都是一个正实数。因此，和 $\\sum_{j=1}^{n} w_j$ 是严格为正的，我们可以安全地用它来除。解出 $k$，我们得到：\n$$k = \\frac{1}{\\sum_{j=1}^{n} w_j}$$\n这里，我们根据题目的建议在分母中使用 $j$ 作为求和索引，尽管它是一个哑变量。\n\n在确定了常数 $k$ 之后，我们现在可以用给定的权重来表示任何类别 $i$ 的服务率 $S_i$：\n$$S_i = k \\cdot w_i = \\frac{w_i}{\\sum_{j=1}^{n} w_j}$$\n这个方程给出了类别 $i$ 每单位时间接收到的CPU时间的份额。\n\n最后，我们需要求出在持续时间 $T$ 内分配给类别 $i$ 的总期望CPU时间。设这个量为 $C_i(T)$。由于系统被指定处于稳态，服务率 $S_i$ 在时间间隔 $T$ 内是恒定的。总分配时间是分配率乘以时间间隔的持续时间：\n$$C_i(T) = S_i \\times T$$\n代入我们推导出的 $S_i$ 表达式，得到最终的闭式表达式：\n$$C_i(T) = \\left( \\frac{w_i}{\\sum_{j=1}^{n} w_j} \\right) T$$\n这可以更紧凑地写成：\n$$C_i(T) = \\frac{w_i T}{\\sum_{j=1}^{n} w_j}$$\n该表达式根据类别 $i$ 的权重 $w_i$、所有权重的总和 $\\sum_{j=1}^{n} w_j$ 以及观察时间 $T$ 给出了类别 $i$ 的期望CPU时间，符合题目要求。", "answer": "$$\\boxed{\\frac{w_i T}{\\sum_{j=1}^{n} w_j}}$$", "id": "3671520"}, {"introduction": "简单的优先级模型在现实世界中会遇到一些棘手的问题，其中最著名的就是“优先级反转”。这个实践练习模拟了一个经典场景，让你亲手量化优先级反转造成的延迟，并与应用“优先级继承”策略后的性能进行对比 [@problem_id:3623596]。通过这个练习，你将深刻体会到在并发系统中设计健壮调度机制的重要性。", "problem": "考虑一个多道程序操作系统中的可抢占固定优先级分时调度器。存在三个任务：高优先级任务 $H$、中优先级任务 $M$ 和低优先级任务 $L$。任务 $L$ 当前持有一个保护短临界区的互斥锁 (mutex) $X$。在时间 $t=0$ 时，任务 $L$ 正在 $X$ 内部执行，其临界区剩余执行时间为 $c_{L}=2.4\\,\\mathrm{ms}$。在 $t=0^{+}$ 时，任务 $H$ 到达并立即尝试获取 $X$，因此阻塞直到 $X$ 被释放。同样在 $t=0^{+}$ 时，任务 $M$ 变为就绪状态，其单次计算突发时间为 $c_{M}=7.6\\,\\mathrm{ms}$，并且不需要任何锁或输入/输出。假设只有一个中央处理器 (CPU)，采用可抢占的固定优先级调度，$H \\succ M \\succ L$（$\\succ$ 表示更高优先级），并且没有其他任务或到达事件。假设调度、上下文切换和锁/解锁的开销为 $0$。\n\n将 $H$ 经历的优先级反转延迟定义为从 $H$ 在 $t=0^{+}$ 时请求 $X$ 到 $H$ 获取 $X$ 的时间。在没有优先级继承 (PI) 的标准调度下，当高优先级任务 $H$ 因低优先级任务 $L$ 持有的锁而阻塞时，任何就绪的中优先级任务 $M$ 都会抢占 $L$，从而延长 $H$ 的等待时间。在优先级继承 (PI) 下，当 $H$ 因 $X$ 而阻塞时，锁持有者 $L$ 会临时继承 $H$ 的优先级，直到 $X$ 被释放，从而防止被 $M$ 抢占。\n\n从可抢占固定优先级调度以及阻塞和优先级继承语义的基本原理出发，推导在没有 PI 和有 PI 的情况下 $H$ 的锁等待时间的表达式。然后，计算比率\n$$R=\\frac{\\text{无 PI 时的锁等待时间}}{\\text{有 PI 时的锁等待时间}}。$$\n以纯数（无量纲）形式提供 $R$。将您的答案四舍五入到四位有效数字。", "solution": "此问题要求分析在可抢占的固定优先级调度策略下，单个中央处理器 (CPU) 上的任务执行情况。问题的核心是确定高优先级任务 $H$ 在两种不同场景下所经历的锁等待时间：一种是没有优先级继承 (PI) 协议，另一种是有该协议。任务 $H$ 的锁等待时间定义为从它请求互斥锁 $X$ 到成功获取该锁的持续时间。\n\n让我们将任务的优先级表示为 $P_H$、$P_M$ 和 $P_L$。问题陈述 $H \\succ M \\succ L$，这等同于 $P_H > P_M > P_L$。调度器是可抢占的，这意味着如果一个优先级为 $P_{\\text{new}}$ 的任务在优先级为 $P_{\\text{current}}$ 的任务运行时变为就绪状态，那么如果 $P_{\\text{new}} > P_{\\text{current}}$，正在运行的任务将被抢占。\n\n时间 $t=0$ 时的初始条件是：\n- 任务 $L$（低优先级）正在执行受互斥锁 $X$ 保护的临界区。\n- $L$ 完成其临界区所需的剩余执行时间为 $c_L = 2.4\\,\\mathrm{ms}$。\n\n在时间 $t=0^{+}$（$t=0$ 后的一个无穷小时间）：\n- 任务 $H$（高优先级）到达并请求锁 $X$。由于 $X$ 被 $L$ 持有，任务 $H$ 进入“阻塞”状态。\n- 任务 $M$（中优先级）变为“就绪”状态，准备执行，其 CPU 突发时间为 $c_M = 7.6\\,\\mathrm{ms}$。\n\n我们在两种不同情况下分析系统的演变。\n\n### 情况 1：无优先级继承 (PI) 的调度\n\n在这种情况下，任务优先级是静态的，不会改变。\n\n1.  在 $t=0^{+}$ 时，调度器必须决定运行哪个任务。各任务的状态如下：\n    -   任务 $H$：阻塞（等待锁 $X$）。没有资格运行。\n    -   任务 $M$：就绪。\n    -   任务 $L$：正在运行，但由于就绪任务 $M$ 的到达，必须做出调度决策。为了调度的目的，$L$ 被视为就绪状态。\n\n2.  调度器比较所有*就绪*任务的优先级：$P_M$ 和 $P_L$。由于 $P_M > P_L$，调度器抢占任务 $L$ 并分派任务 $M$。\n\n3.  从 $t=0^{+}$ 开始，直到任务 $M$ 完成其 CPU 突发，任务 $M$ 将占用 CPU。此持续时间为 $c_M = 7.6\\,\\mathrm{ms}$。在此期间，任务 $L$ 保持在就绪状态，无法在其临界区上取得进展。这是经典的高优先级任务被中优先级任务延迟的优先级反转场景。\n\n4.  在 $t=c_M = 7.6\\,\\mathrm{ms}$ 时，任务 $M$ 完成执行，不再处于就绪状态。调度器现在重新评估。唯一的就绪任务是 $L$（任务 $H$ 仍处于阻塞状态）。因此，调度器分派任务 $L$。\n\n5.  任务 $L$ 现在运行其剩余的临界区时间 $c_L = 2.4\\,\\mathrm{ms}$。它在时间 $t = c_M + c_L = 7.6\\,\\mathrm{ms} + 2.4\\,\\mathrm{ms} = 10.0\\,\\mathrm{ms}$ 完成其临界区。\n\n6.  在 $t=10.0\\,\\mathrm{ms}$ 时，任务 $L$ 释放互斥锁 $X$。$X$ 的释放解除了任务 $H$ 的阻塞，使其状态从阻塞变为就绪。\n\n7.  调度器必须再次做出决策。现在的就绪任务是 $H$ 和 $L$。由于 $P_H > P_L$，调度器立即抢占 $L$ 并分派 $H$。任务 $H$ 在此时获取锁 $X$。\n\n在没有 PI 的情况下，$H$ 的锁等待时间，记为 $W_{\\text{noPI}}$，是从它在 $t=0^{+}$ 请求到在 $t=10.0\\,\\mathrm{ms}$ 获取锁所经过的总时间。\n$$W_{\\text{noPI}} = c_M + c_L = 7.6\\,\\mathrm{ms} + 2.4\\,\\mathrm{ms} = 10.0\\,\\mathrm{ms}$$\n\n### 情况 2：有优先级继承 (PI) 的调度\n\n在这种情况下，持有锁的任务的优先级可以被临时提升。\n\n1.  在 $t=0^{+}$ 时，任务 $H$ 尝试获取锁 $X$ 并因 $L$ 持有该锁而阻塞。\n2.  优先级继承协议被触发。任务 $L$，即锁持有者，临时继承了它所阻塞的最高优先级任务的优先级。在这种情况下，$L$ 继承了 $H$ 的优先级。设 $L$ 的有效优先级为 $P'_L$。那么 $P'_L = P_H$。\n3.  同时，任务 $M$ 变为就绪状态。\n4.  调度器必须决定运行哪个任务。各任务的状态如下：\n    -   任务 $H$：阻塞。\n    -   任务 $M$：就绪。\n    -   任务 $L$：就绪，有效优先级为 $P'_L = P_H$。\n\n5.  调度器比较就绪任务 $M$ 和 $L$ 的优先级。由于 $P'_L = P_H$ 且 $P_H > P_M$，所以 $L$ 的有效优先级高于 $M$ 的优先级。因此，任务 $M$ 不能抢占任务 $L$。任务 $L$ 继续运行。\n\n6.  任务 $L$ 执行其剩余的临界区时间 $c_L = 2.4\\,\\mathrm{ms}$。它从 $t=0$ 开始，在 $t=c_L = 2.4\\,\\mathrm{ms}$ 完成。\n\n7.  在 $t=2.4\\,\\mathrm{ms}$ 时，任务 $L$ 释放锁 $X$。在这一刻：\n    -   $L$ 的优先级恢复到其原始的低值 $P_L$。\n    -   任务 $H$ 被解除阻塞并变为就绪状态。\n\n8.  调度器做出决策。就绪任务是 $H$、$M$ 和 $L$。它们的优先级是 $P_H > P_M > P_L$。调度器分派最高优先级的任务 $H$。因此，任务 $H$ 在 $t=2.4\\,\\mathrm{ms}$ 获取锁 $X$。\n\n在有 PI 的情况下，$H$ 的锁等待时间，记为 $W_{\\text{PI}}$，是从它在 $t=0^{+}$ 请求到在 $t=2.4\\,\\mathrm{ms}$ 获取锁所经过的总时间。\n$$W_{\\text{PI}} = c_L = 2.4\\,\\mathrm{ms}$$\n\n### 比率 R 的计算\n\n问题要求计算比率 $R = \\frac{\\text{无 PI 时的锁等待时间}}{\\text{有 PI 时的锁等待时间}}$。\n$$R = \\frac{W_{\\text{noPI}}}{W_{\\text{PI}}} = \\frac{c_M + c_L}{c_L}$$\n代入给定的数值：\n$$R = \\frac{7.6 + 2.4}{2.4} = \\frac{10.0}{2.4}$$\n计算该值：\n$$R = \\frac{10}{2.4} = \\frac{100}{24} = \\frac{25}{6} = 4.1666...$$\n问题要求答案四舍五入到四位有效数字。\n$$R \\approx 4.167$$\n该比率量化了在此特定场景中，通过使用优先级继承来减轻优先级反转影响所获得的性能提升。", "answer": "$$\\boxed{4.167}$$", "id": "3623596"}, {"introduction": "在实时系统中，仅仅拥有静态的高优先级是不够的，我们还需要确保任务能在其截止日期 $D$ 前完成。这个练习探讨了一种称为“老化”的动态优先级调整技术，通过一个精巧的数学函数，任务的优先级会随着其截止日期的临近而动态提升 [@problem_id:3671612]。你的任务是求解该函数的关键参数 $\\alpha$，以保证任务的按时完成，这让你能一窥高级实时调度算法的设计精髓。", "problem": "考虑一个单处理器中央处理单元（CPU）系统，其上运行一个完全抢占式的最高优先级优先调度器。根据定义，在任何时刻，调度器都会选择就绪队列中动态优先级最高的作业；当优先级相同时，通过一个固定的确定性规则来打破平局，该规则仅当有截止时间约束的作业的动态优先级以一个正的裕量严格超过竞争值时才偏向该作业。系统采用老化策略，根据作业的等待时间来增加其动态优先级，其中等待时间定义为作业进入就绪队列后，在完成所需服务之前所经过的时间。\n\n一个作业 $J$ 在时间 $0$ 到达，其严格相对截止时间为 $D$，所需服务时间为 $S$。系统的优先级范围是有界的，其最大允许值为 $P_{\\max}$。作业 $J$ 的初始动态优先级为 $p_{0}$。系统中所有其他作业都具有静态（非老化）优先级，其中最高的竞争优先级值记为 $P^{\\star}$。在抢占式最高优先级优先调度下，为保证作业 $J$ 在其截止时间前完成，一个充分条件是作业 $J$ 最晚在等待时间 $w^{\\star} = D - S$ 时开始连续执行，然后不间断地运行直至完成。这要求其在 $w^{\\star}$ 时的动态优先级以一个正的裕量 $\\delta$ 严格超过最大竞争者，即：\n\n$$\np(w^{\\star}) \\geq P^{\\star} + \\delta.\n$$\n\n为避免优先级区分度崩溃（即，在作业生命周期的早期保持作业间的可分离性），老化函数必须在 $w$ 较小时增长缓慢，但随着截止时间的临近而加速，同时保持在 $P_{\\max}$ 的界限内。考虑以下满足这些约束的、截止时间感知的老化函数族：\n\n$$\np(w) = p_{0} + \\left(P_{\\max} - p_{0}\\right)\\left(1 - \\exp\\!\\left(-\\alpha \\cdot \\frac{w}{D - w}\\right)\\right), \\quad \\text{for } 0 \\leq w < D,\n$$\n\n其中参数 $\\alpha > 0$。假设 CPU 在被调度时以单位速率执行。\n\n给定数值参数 $D = 100\\,\\text{ms}$，$S = 30\\,\\text{ms}$，$p_{0} = 10$，$P_{\\max} = 100$，$P^{\\star} = 65$ 和 $\\delta = 1$，确定 $\\alpha$ 的最小值，该值需保证作业 $J$ 根据调度器规则，在等待时间 $w^{\\star} = D - S$ 之前开始连续执行，从而在其截止时间前完成。将 $\\alpha$ 的最终答案四舍五入到四位有效数字。最终答案以无量纲量的形式表示。", "solution": "该问题要求确定老化参数 $\\alpha$ 的最小值，以确保特定作业 $J$ 在其截止时间前完成执行。这个问题被构建为一个基于作业动态优先级的可调度性条件。\n\n如问题所述，控制条件是作业 $J$ 的动态优先级 $p(w)$ 必须在关键等待时间 $w^{\\star}$ 满足以下不等式：\n$$p(w^{\\star}) \\geq P^{\\star} + \\delta$$\n这里，$P^{\\star}$ 是任何竞争作业的最高优先级，$\\delta$ 是一个指定的正裕量。\n\n关键等待时间 $w^{\\star}$ 是作业在需要服务时间为 $S$ 的情况下，能够开始连续执行并恰好满足其截止时间 $D$ 的最晚时刻。其计算方式如下：\n$$w^{\\star} = D - S$$\n根据给定的值 $D = 100\\,\\text{ms}$ 和 $S = 30\\,\\text{ms}$，我们得到：\n$$w^{\\star} = 100 - 30 = 70\\,\\text{ms}$$\n\n动态优先级 $p(w)$ 由给定的老化函数定义：\n$$p(w) = p_{0} + \\left(P_{\\max} - p_{0}\\right)\\left(1 - \\exp\\!\\left(-\\alpha \\cdot \\frac{w}{D - w}\\right)\\right)$$\n其中 $p_0$ 是初始优先级，$P_{\\max}$ 是最大可能优先级，$\\alpha$ 是老化参数。\n\n为了找到满足可调度性条件的 $\\alpha$ 的最小值，我们首先研究 $p(w^{\\star})$ 对 $\\alpha$ 的依赖关系。指数内的项是 $-\\alpha \\cdot \\frac{w^{\\star}}{D - w^{\\star}}$。由于 $\\alpha > 0$ 且比率 $\\frac{w^{\\star}}{D-w^{\\star}}$ 为正（因为 $0 \\le w^{\\star} < D$），指数的参数为负。随着 $\\alpha$ 的增加，这个负参数减小（变得更负）。因此，指数项 $\\exp(-\\dots)$ 的值减小并趋近于 $0$。这导致 $(1 - \\exp(-\\dots))$ 项增加，进而导致 $p(w^{\\star})$ 增加。因此，$p(w^{\\star})$ 是 $\\alpha$ 的单调递增函数。\n\n鉴于这种单调关系，满足不等式 $p(w^{\\star}) \\geq P^{\\star} + \\delta$ 的 $\\alpha$ 的最小值就是使等式成立的值：\n$$p(w^{\\star}) = P^{\\star} + \\delta$$\n\n我们可以将老化函数在 $w^{\\star}$ 处的值代入，来表示这个等式：\n$$p_{0} + \\left(P_{\\max} - p_{0}\\right)\\left(1 - \\exp\\!\\left(-\\alpha \\cdot \\frac{w^{\\star}}{D - w^{\\star}}\\right)\\right) = P^{\\star} + \\delta$$\n\n现在，我们将给定的数值代入此方程：$p_{0} = 10$，$P_{\\max} = 100$，$P^{\\star} = 65$，$\\delta = 1$，$D = 100$，以及 $w^{\\star} = 70$。指数中的比率为：\n$$\\frac{w^{\\star}}{D - w^{\\star}} = \\frac{70}{100 - 70} = \\frac{70}{30} = \\frac{7}{3}$$\n\n将所有值代入方程中：\n$$10 + (100 - 10)\\left(1 - \\exp\\!\\left(-\\alpha \\cdot \\frac{7}{3}\\right)\\right) = 65 + 1$$\n$$10 + 90\\left(1 - \\exp\\!\\left(-\\frac{7\\alpha}{3}\\right)\\right) = 66$$\n\n我们现在求解这个方程以得到 $\\alpha$。\n$$90\\left(1 - \\exp\\!\\left(-\\frac{7\\alpha}{3}\\right)\\right) = 66 - 10$$\n$$90\\left(1 - \\exp\\!\\left(-\\frac{7\\alpha}{3}\\right)\\right) = 56$$\n$$1 - \\exp\\!\\left(-\\frac{7\\alpha}{3}\\right) = \\frac{56}{90}$$\n化简分数得到 $\\frac{56}{90} = \\frac{28}{45}$。\n$$1 - \\exp\\!\\left(-\\frac{7\\alpha}{3}\\right) = \\frac{28}{45}$$\n\n分离指数项：\n$$\\exp\\!\\left(-\\frac{7\\alpha}{3}\\right) = 1 - \\frac{28}{45}$$\n$$\\exp\\!\\left(-\\frac{7\\alpha}{3}\\right) = \\frac{45}{45} - \\frac{28}{45} = \\frac{17}{45}$$\n\n为了求出 $\\alpha$，我们对等式两边取自然对数：\n$$\\ln\\left(\\exp\\!\\left(-\\frac{7\\alpha}{3}\\right)\\right) = \\ln\\left(\\frac{17}{45}\\right)$$\n$$-\\frac{7\\alpha}{3} = \\ln\\left(\\frac{17}{45}\\right)$$\n\n最后，我们求解 $\\alpha$：\n$$\\alpha = -\\frac{3}{7} \\ln\\left(\\frac{17}{45}\\right)$$\n使用对数恒等式 $\\ln(a/b) = -\\ln(b/a)$，我们可以将 $\\alpha$ 表示为：\n$$\\alpha = \\frac{3}{7} \\ln\\left(\\frac{45}{17}\\right)$$\n\n这就得到了 $\\alpha$ 的精确解析解。题目要求一个四舍五入到四位有效数字的数值答案。我们计算其值：\n$$\\alpha = \\frac{3}{7} \\ln\\left(\\frac{45}{17}\\right) \\approx \\frac{3}{7} \\ln(2.6470588...)$$\n$$\\alpha \\approx 0.4285714 \\times 0.9734901...$$\n$$\\alpha \\approx 0.41721005...$$\n\n四舍五入到四位有效数字，我们得到：\n$$\\alpha \\approx 0.4172$$\n这个结果是一个无量纲量，这与指数函数的参数必须是无量纲的要求相符。", "answer": "$$\\boxed{0.4172}$$", "id": "3671612"}]}