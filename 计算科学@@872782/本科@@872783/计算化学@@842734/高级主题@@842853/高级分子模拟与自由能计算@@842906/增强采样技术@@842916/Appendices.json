{"hands_on_practices": [{"introduction": "增强采样模拟的成功在很大程度上取决于能否选择正确的集合变量（Collective Variables, CVs）。本练习将要求你为一个实际问题——蛋白质同型二聚体的解离——设计合适的CV，这会促使你思考变量的一些关键属性，例如对旋转和平移的不变性，以及数学上的可微性。掌握这项技能是建立有意义的模拟研究的第一步，也是最关键的一步[@problem_id:2455461]。", "problem": "您正在为一个在显式溶剂中的同源二聚体蛋白的解离过程设置增强采样模拟。设单体 $A$ 包含索引为 $i \\in A$ 的原子，其位置为 $\\{\\mathbf{r}_i^A\\}$；单体 $B$ 包含索引为 $j \\in B$ 的原子，其位置为 $\\{\\mathbf{r}_j^B\\}$。将质心（COM）记为 $\\mathbf{R}_{\\mathrm{COM}}^A$ 和 $\\mathbf{R}_{\\mathrm{COM}}^B$。令 $r_{ij} \\equiv \\lVert \\mathbf{r}_i^A - \\mathbf{r}_j^B \\rVert$。集体变量（CV）是原子坐标 $\\mathbf{x}$ 的一个标量函数 $s(\\mathbf{x})$，用于偏置采样。为了在常用的增强采样方法中获得稳定的偏置力，假定 $s(\\mathbf{x})$ 必须对所有坐标连续可微。该二聚体可以在溶液中自由平移和翻滚；也就是说，在模拟过程中，可以有任意的整体刚性平移，并且每个单体可以围绕其瞬时质心进行刚体旋转。您的目标是以一种对这种翻滚具有鲁棒性、且对实验室参考系中的绝对取向不敏感的方式来监测和偏置解离过程，同时在物理上仍能指示亚基间的分离或接触的丢失。\n\n在这些条件下，下列哪个定义是合适的CV选择？请选择所有适用项。\n\nA. $s_A(\\mathbf{x}) = \\lVert \\mathbf{R}_{\\mathrm{COM}}^A - \\mathbf{R}_{\\mathrm{COM}}^B \\rVert$。\n\nB. $s_B(\\mathbf{x}) = \\sqrt{\\frac{1}{N_A}\\sum_{i \\in A} \\lVert \\mathbf{r}_i^A - \\mathbf{r}_{i,\\mathrm{ref}}^A \\rVert^2}$，单体 $A$ 相对于在实验室参考系中定义的固定参考构象的均方根偏差（RMSD），计算时未进行最佳叠合。\n\nC. $s_C(\\mathbf{x}) = \\displaystyle\\sum_{i \\in I_A}\\sum_{j \\in I_B} \\frac{1}{1 + \\left(\\frac{r_{ij}}{r_0}\\right)^n}$，在选定的界面重原子集 $I_A \\subset A$ 和 $I_B \\subset B$ 上的平滑配位数，其中参数 $r_0  0$ 和 $n  0$ 为固定值。\n\nD. $s_D(\\mathbf{x}) = \\arccos\\!\\big(\\hat{\\mathbf{u}}_A \\cdot \\hat{\\mathbf{u}}_B\\big)$，单体 $A$ 和 $B$ 的主惯性轴（PAI）单位向量 $\\hat{\\mathbf{u}}_A$ 和 $\\hat{\\mathbf{u}}_B$ 之间的夹角。\n\nE. $s_E(\\mathbf{x}) = \\min_{i \\in A,\\, j \\in B} r_{ij}$，任意时刻亚基间的最小原子-原子距离。\n\n假设所有集合和参数都是良好定义且事先固定的。通过选择所有满足所述鲁棒解离CV要求的选项来回答。", "solution": "该问题要求为同源二聚体解离的增强采样模拟识别合适的集体变量（CV）。一个合适的CV，记为 $s(\\mathbf{x})$，必须满足从问题陈述中得出的三个主要条件：\n$1$. CV必须对所有原子坐标 $\\mathbf{x}$ 连续可微。这对于计算稳定的偏置力至关重要，因为偏置力与CV的梯度 $\\nabla_{\\mathbf{x}} s(\\mathbf{x})$ 成正比。\n$2$. CV必须在整个系统的整体刚体平移和旋转下保持不变。解离过程必须由内坐标描述，与该同源二聚体在模拟盒子中的绝对位置和取向无关。\n$3$. CV必须是解离过程的一个物理上有意义的报告量，该过程的特征是亚基间分离或亚基间接触的丢失。\n\n我们现在将根据这三个标准来评估每个提出的定义。\n\nA. $s_A(\\mathbf{x}) = \\lVert \\mathbf{R}_{\\mathrm{COM}}^A - \\mathbf{R}_{\\mathrm{COM}}^B \\rVert$。\n该CV是两个单体质心（COM）之间的距离。\n- **物理意义**：单体质心之间的距离是其宏观分离的一个直接且直观的度量。随着单体解离，该距离单调增加。这是一个极好的解离报告量。此条件满足。\n- **不变性**：设系统经历一个由向量 $\\mathbf{c}$ 描述的刚性平移。新的原子位置为 $\\mathbf{r}'_k = \\mathbf{r}_k + \\mathbf{c}$。一个单体（例如 $A$）的新质心变为 $\\mathbf{R'}_{\\mathrm{COM}}^A = (\\sum_{i \\in A} m_i (\\mathbf{r}_i^A + \\mathbf{c})) / \\sum_{i \\in A} m_i = \\mathbf{R}_{\\mathrm{COM}}^A + \\mathbf{c}$。类似地，$\\mathbf{R'}_{\\mathrm{COM}}^B = \\mathbf{R}_{\\mathrm{COM}}^B + \\mathbf{c}$。差分向量为 $\\mathbf{R'}_{\\mathrm{COM}}^A - \\mathbf{R'}_{\\mathrm{COM}}^B = (\\mathbf{R}_{\\mathrm{COM}}^A + \\mathbf{c}) - (\\mathbf{R}_{\\mathrm{COM}}^B + \\mathbf{c}) = \\mathbf{R}_{\\mathrm{COM}}^A - \\mathbf{R}_{\\mathrm{COM}}^B$。因此，该向量的范数对平移不变。\n现在，设系统经历一个由正交矩阵 $\\mathbf{O}$ 描述的刚性旋转。新的质心为 $\\mathbf{R'}_{\\mathrm{COM}}^A = \\mathbf{O}\\mathbf{R}_{\\mathrm{COM}}^A$。新的差分向量为 $\\mathbf{O}\\mathbf{R}_{\\mathrm{COM}}^A - \\mathbf{O}\\mathbf{R}_{\\mathrm{COM}}^B = \\mathbf{O}(\\mathbf{R}_{\\mathrm{COM}}^A - \\mathbf{R}_{\\mathrm{COM}}^B)$。由于旋转保持范数不变，$\\lVert \\mathbf{O}(\\mathbf{R}_{\\mathrm{COM}}^A - \\mathbf{R}_{\\mathrm{COM}}^B) \\rVert = \\lVert \\mathbf{R}_{\\mathrm{COM}}^A - \\mathbf{R}_{\\mathrm{COM}}^B \\rVert$。该CV对整体平移和旋转都不变。此条件满足。\n- **可微性**：每个单体的质心是原子坐标的线性函数，因此是无限可微的。该CV是差分向量 $\\mathbf{v} = \\mathbf{R}_{\\mathrm{COM}}^A - \\mathbf{R}_{\\mathrm{COM}}^B$ 的欧几里得范数。范数函数 $f(\\mathbf{v}) = \\lVert \\mathbf{v} \\rVert$ 在除了 $\\mathbf{v} = \\mathbf{0}$ 之外的所有点都是连续可微的。对于两个具有排除体积的独立物理对象，其质心重合的概率实际上为零。即使出现这种理论上的奇异点，它也只发生在一个点上，并且可以被标准模拟软件稳健地处理。因此，该CV被认为适合用于施加偏置。此条件满足。\n结论：**正确**。\n\nB. $s_B(\\mathbf{x}) = \\sqrt{\\frac{1}{N_A}\\sum_{i \\in A} \\lVert \\mathbf{r}_i^A - \\mathbf{r}_{i,\\mathrm{ref}}^A \\rVert^2}$。\n这是相对于实验室参考系中固定参考结构的均方根偏差（RMSD）。\n- **物理意义**：该CV测量的是单体 $A$ 相对于空间中特定位置和取向的偏差。它不测量单体 $A$ 和单体 $B$ 之间的分离。相反，它会惩罚复合物的自然翻滚和扩散，而这并非我们的目标。它不是一个有意义的解离报告量。此条件不满足。\n- **不变性**：问题陈述指出，参考结构 $\\{\\mathbf{r}_{i,\\mathrm{ref}}^A\\}$ 在实验室参考系中是固定的。如果整个系统平移 $\\mathbf{c}$，CV变为 $\\sqrt{\\frac{1}{N_A}\\sum_{i \\in A} \\lVert (\\mathbf{r}_i^A + \\mathbf{c}) - \\mathbf{r}_{i,\\mathrm{ref}}^A \\rVert^2}$，这显然依赖于 $\\mathbf{c}$。该CV对平移和旋转都不是不变的。问题明确要求对翻滚具有鲁棒性，而这个CV定义直接与此矛盾。此条件不满足。\n由于两个关键条件不满足，无需进一步分析。\n结论：**不正确**。\n\nC. $s_C(\\mathbf{x}) = \\displaystyle\\sum_{i \\in I_A}\\sum_{j \\in I_B} \\frac{1}{1 + \\left(\\frac{r_{ij}}{r_0}\\right)^n}$。\n这是一个平滑配位数CV。\n- **物理意义**：函数 $f(r_{ij}) = [1 + (r_{ij}/r_0)^n]^{-1}$ 起到一个平滑开关的作用。当原子对距离 $r_{ij} \\ll r_0$ 时，它约等于 $1$，当 $r_{ij} \\gg r_0$ 时，它平滑地衰减到 $0$。通过对选定的界面原子对求和，该CV有效地计算了两个单体之间的“接触”数量。随着二聚体解离，距离 $r_{ij}$ 增加，$s_C$ 减小并趋向于 $0$。这是接触丢失的直接度量，是解离的一个关键特征。此条件满足。\n- **不变性**：该CV是仅依赖于原子间距离 $r_{ij} = \\lVert \\mathbf{r}_i^A - \\mathbf{r}_j^B \\rVert$ 的项的总和。如选项A的分析所确立的，粒子对之间的距离在整体平移和旋转下是不变的。一个仅由这些不变量构成的函数，其本身也是不变的。此条件满足。\n- **可微性**：对于 $r_{ij}  0$，距离 $r_{ij}$ 对坐标是连续可微的，由于排除体积效应，这对于不同的原子总是成立的。对于 $u \\geq 0$ 和 $n  0$，函数 $[1 + u^n]^{-1}$ 是连续可微的。由于 $s_C$ 是连续可微函数的复合和求和，它本身也是连续可微的。此条件满足。\n结论：**正确**。\n\nD. $s_D(\\mathbf{x}) = \\arccos\\!\\big(\\hat{\\mathbf{u}}_A \\cdot \\hat{\\mathbf{u}}_B\\big)$。\n该CV测量两个单体主惯性轴（PAI）之间的夹角。\n- **物理意义**：该CV量化了两个单体的相对取向。虽然在解离过程中相对取向会发生变化，但该CV不直接报告分离距离。单体可能相距很远（$s_A \\to \\infty$）但其PAI平行（$s_D \\approx 0$），或者它们可能直接接触但PAI正交（$s_D \\approx \\pi/2$）。因此，它不适合作为驱动解离的主要CV，因为解离本质上是一个增加分离的过程。此条件不满足。\n- **不变性**：PAI是相对于单体自身质心计算的惯性张量的特征向量。得到的向量 $\\hat{\\mathbf{u}}_A$ 和 $\\hat{\\mathbf{u}}_B$ 是在体坐标系（body-fixed frame）中定义的。在由矩阵 $\\mathbf{O}$ 描述的整体旋转下，向量变换为 $\\hat{\\mathbf{u}}'_A = \\mathbf{O}\\hat{\\mathbf{u}}_A$ 和 $\\hat{\\mathbf{u}}'_B = \\mathbf{O}\\hat{\\mathbf{u}}_B$。点积是不变的：$\\hat{\\mathbf{u}}'_A \\cdot \\hat{\\mathbf{u}}'_B = (\\mathbf{O}\\hat{\\mathbf{u}}_A)\\cdot(\\mathbf{O}\\hat{\\mathbf{u}}_B) = \\hat{\\mathbf{u}}_A \\cdot \\hat{\\mathbf{u}}_B$。该CV在整体平移下也是不变的。此条件满足。\n- **可微性**：PAI向量是惯性张量的特征向量。根据矩阵微扰理论，对称矩阵的特征向量仅当其所有特征值都不同时，才是其矩阵元素的连续可微函数。对于具有足够对称性的分子（例如，圆柱形），惯性张量可能具有简并的特征值。在这种简并点，特征向量不是唯一定义的，它们对原子坐标的导数可能是不连续的。这会导致不稳定的偏置力。一个CV必须对任何分子构象都具有鲁棒的可微性。对于一般的蛋白质，该CV未能通过此测试。此条件不满足。\n结论：**不正确**。\n\nE. $s_E(\\mathbf{x}) = \\min_{i \\in A,\\, j \\in B} r_{ij}$。\n这是单体A中任意原子与单体B中任意原子之间的最小距离。\n- **物理意义**：该CV是两个亚基之间最近接触点的一个非常直接和灵敏的度量。当它们分离时，这个最小距离必须增加。因此，它是一个有效的解离报告量。此条件满足。\n- **不变性**：该CV是一组原子间距离 $r_{ij}$ 的最小值。每个距离 $r_{ij}$ 对整体平移和旋转都是不变的。一组不变量的最小值也是不变的。此条件满足。\n- **可微性**：$\\min$ 函数不是连续可微的。考虑 $s_E(\\mathbf{x}) = \\min\\{f_1(\\mathbf{x}), f_2(\\mathbf{x}), \\dots\\}$。$s_E$ 的梯度是当前提供最小值的那个函数 $f_k$ 的梯度。在提供最小值的函数身份发生变化的点（即，在 $k \\ne l$ 的交叉点 $f_k(\\mathbf{x}) = f_l(\\mathbf{x})$），$s_E$ 的梯度是不连续的。在模拟中，定义最小距离的原子对 $(i, j)$ 可能突然改变，导致CV梯度的突变。这会在偏置力中产生脉冲，可能导致模拟中的数值不稳定性。因此，连续可微性的要求被严重违反。\n结论：**不正确**。\n\n根据以上分析，只有选项A和C满足此问题中合适集体变量的所有要求标准。", "answer": "$$\\boxed{AC}$$", "id": "2455461"}, {"introduction": "在从诸如伞形采样等偏置模拟中收集数据后，下一步是重建真实的自由能形貌。本练习将指导你实现加权直方图分析方法（Weighted Histogram Analysis Method, WHAM），这是完成此任务的一个基础算法。通过完成这个编程练习[@problem_id:2455424]，你将获得处理偏置数据、揭示系统内在热力学性质的实践经验。", "problem": "配体的内旋转围绕一个二面角坐标被建模为一个一维周期性坐标 $\\theta \\in [-\\pi,\\pi)$，单位为弧度。该配体位于一个埋藏的、近乎对称的结合口袋中，这会产生一个未知的约化平均力势 $u_0(\\theta)$，以热能 $k_\\mathrm{B}T$ 为单位（无量纲）。在没有外部偏置的平衡状态下，概率密度为 $p_0(\\theta) \\propto \\exp\\!\\left(-u_0(\\theta)\\right)$，自由能分布图为 $F(\\theta) = -\\ln p_0(\\theta) + \\text{常数}$，以 $k_\\mathrm{B}T$ 为单位。进行了一组共 $M$ 个谐波偏置实验，每个实验施加一个偏置 $u_i(\\theta)$，并从相应的偏置分布 $p_i(\\theta) \\propto \\exp\\!\\left(-[u_0(\\theta)+u_i(\\theta)]\\right)$ 中收集 $N_i$ 个独立的 $\\theta$ 平衡样本。谐波偏置为 $u_i(\\theta) = \\tfrac{k}{2}\\,d(\\theta,\\theta_i)^2$，其刚度 $k$ 的单位为 $k_\\mathrm{B}T/\\mathrm{rad}^2$，其中 $d(\\theta,\\theta_i)$ 是最小镜像角距离，单位为弧度，定义为 $d(\\theta,\\theta_i) = \\mathrm{wrap}(\\theta-\\theta_i)$，其中 $\\mathrm{wrap}(x)$ 通过加或减 $2\\pi$ 的倍数将 $x$ 映射到 $(-\\pi,\\pi]$ 区间内。对于每个实验 $i \\in \\{1,\\ldots,M\\}$，在一个均匀划分 $[-\\pi,\\pi)$ 的 $B$ 个分箱上，形成采样角度的直方图 $h_{i,j}$。分箱由 $j \\in \\{0,1,\\ldots,B-1\\}$ 索引，箱宽为 $\\Delta\\theta = 2\\pi/B$，箱中心为 $\\theta_j = -\\pi + (j+\\tfrac{1}{2})\\Delta\\theta$。计数 $h_{i,j}$ 是窗口 $i$ 中第 $j$ 个分箱的样本数。\n\n你的任务是根据这些偏置直方图估计无偏置的自由能分布图 $F(\\theta_j)$（最多相差一个加性常数），然后为每个测试案例计算两个标量值：\n- 能垒高度 $\\Delta F_\\mathrm{bar}$，定义为在 $\\theta=0$ 到 $\\theta=\\pi$ 的直接路径上（即 $\\theta \\in [0,\\pi]$），$F(\\theta)$ 的最大值减去在 $\\theta \\in [-\\pi/3,\\pi/3]$（$\\theta \\approx 0$ 附近）和满足 $|d(\\theta,\\pi)| \\le \\pi/3$ 的 $\\theta$（$\\theta \\approx \\pi$ 附近）的邻域内找到的两个最低极小值中的较小者。\n- 不对称性 $\\Delta F_\\mathrm{asym} = F_\\mathrm{min}(\\text{在 } \\pi \\text{ 附近}) - F_\\mathrm{min}(\\text{在 } 0 \\text{ 附近})$，其中 $F_\\mathrm{min}(\\text{在 } 0 \\text{ 附近})$ 是 $F(\\theta)$ 在 $\\theta \\in [-\\pi/3,\\pi/3]$ 上的最小值，而 $F_\\mathrm{min}(\\text{在 } \\pi \\text{ 附近})$ 是 $F(\\theta)$ 在满足 $|d(\\theta,\\pi)| \\le \\pi/3$ 的角度上的最小值。\n\n角度必须以弧度处理。能量和自由能必须以 $k_\\mathrm{B}T$ 为单位（无量纲）处理。最终报告的标量结果是无量纲的浮点数。\n\n为了使问题完全指定且可测试，你将根据一个已知的约化势 $u_0(\\theta)$，使用以下构造方法为每个测试案例确定性地生成直方图：\n- 底层约化势为 $u_0(\\theta) = -\\alpha \\cos(2\\theta) - \\beta \\cos(\\theta)$，其中参数 $(\\alpha,\\beta)$ 已给定。\n- 窗口数为 $M = 8$，偏置中心为 $\\theta_i = -\\pi + i \\cdot \\frac{\\pi}{4}$，其中 $i \\in \\{0,1,2,3,4,5,6,7\\}$。\n- 分箱数为每个测试案例指定的 $B$，在 $[-\\pi,\\pi)$ 上均匀分箱。\n- 对于每个窗口 $i$，偏置为 $u_i(\\theta) = \\tfrac{k}{2}\\,d(\\theta,\\theta_i)^2$，其刚度 $k$ 已指定。\n- 对于每个窗口 $i$，分箱 $j$ 的精确期望离散概率为\n$$\np_{i,j} = \\frac{\\exp\\!\\left(-[u_0(\\theta_j) + u_i(\\theta_j)]\\right)}{\\sum_{m=0}^{B-1} \\exp\\!\\left(-[u_0(\\theta_m) + u_i(\\theta_m)]\\right)}.\n$$\n- 直方图计数通过将期望计数 $N_i p_{i,j}$ 四舍五入为整数来确定性地设置，以使窗口 $i$ 的总数恰好为 $N_i$。具体来说，对于每个窗口 $i$，首先计算实数向量 $\\mathbf{e}_i$，其分量为 $e_{i,j} = N_i p_{i,j}$，然后对每个分量取底以获得整数，最后通过将剩余的 $N_i - \\sum_j \\lfloor e_{i,j}\\rfloor$ 个计数加到小数部分 $e_{i,j} - \\lfloor e_{i,j}\\rfloor$ 最大的分箱上（若出现小数部分完全相等的情况，则优先选择 $j$ 较小的分箱）。\n\n你必须实现一个程序，该程序：\n- 使用上述确定性程序构建直方图。\n- 仅使用直方图 $h_{i,j}$、已知的偏置 $u_i(\\theta_j)$、计数 $N_i$ 和分箱中心 $\\theta_j$ 来估计无偏置的自由能 $F(\\theta_j)$（最多相差一个加性常数）。\n- 按定义计算 $\\Delta F_\\mathrm{bar}$ 和 $\\Delta F_\\mathrm{asym}$。\n\n测试套件。实现你的程序以运行以下三个案例并汇总它们的结果：\n- 案例 1（理想情况，强双峰且近乎对称）：\n  - $\\alpha = 1.5$, $\\beta = 0.1$。\n  - $k = 20$。\n  - $B = 60$。\n  - $(N_0,\\ldots,N_7) = (2000,1500,2500,1800,2200,1600,2400,1700)$。\n- 案例 2（边界情况，近乎平坦的口袋）：\n  - $\\alpha = 0.15$, $\\beta = 0.0$。\n  - $k = 8$。\n  - $B = 60$。\n  - $(N_0,\\ldots,N_7) = (1200,1200,1200,1200,1200,1200,1200,1200)$。\n- 案例 3（不对称情况，极小值顺序颠倒）：\n  - $\\alpha = 1.6$, $\\beta = -0.3$。\n  - $k = 25$。\n  - $B = 60$。\n  - $(N_0,\\ldots,N_7) = (3000,1800,2200,2000,2600,1800,2400,1600)$。\n\n最终输出格式。你的程序应生成单行输出，其中包含三个结果对，格式为列表的列表：\n- 输出必须是一个单行字符串，表示 $[\\,[\\Delta F_\\mathrm{bar}^{(1)},\\Delta F_\\mathrm{asym}^{(1)}],\\,[\\Delta F_\\mathrm{bar}^{(2)},\\Delta F_\\mathrm{asym}^{(2)}],\\,[\\Delta F_\\mathrm{bar}^{(3)},\\Delta F_\\mathrm{asym}^{(3)}]\\,]$，其中上标表示案例编号。\n- 所有角度内部必须以弧度为单位，报告的值是单位为 $k_\\mathrm{B}T$ 的浮点数（无量纲）。不应打印任何单位。", "solution": "所提出的问题是计算统计力学中一个明确定义的练习，具体来说是从一组偏置模拟中重构平均力势（PMF）或自由能分布图。这是分子动力学中的一项标准任务，通常使用加权直方图分析方法（WHAM）或多态贝内特接受率（MBAR）方法来解决。该问题提供了所有必要的数据和确定性程序来生成类似模拟的直方图，从而使其成为一个完整且可解的数值问题。\n该问题是有效的，因为它具有科学依据、适定且客观。它不违反任何物理学或数学的基本原理。所有参数和过程都以足够的精度进行了描述，以确保唯一解的存在。\n\n我的方法将按以下步骤实施：\n1.  对于每个测试案例，首先生成所需的输入数据。这包括将坐标 $\\theta$ 离散化，计算该网格上真实的底层势 $u_0(\\theta)$ 和偏置势 $u_i(\\theta)$，然后根据精确的偏置概率，使用指定的确定性舍入程序构建直方图 $h_{i,j}$。\n2.  有了直方图 $h_{i,j}$、样本数 $N_i$ 和偏置势 $u_i(\\theta_j)$，下一步是计算无偏置的自由能分布图 $F(\\theta_j)$。我将使用 WHAM 方程，它提供了一套自洽关系式来找到自由能分布图的最优估计。这些方程是：\n    $$\n    e^{-F_j} = C \\cdot \\frac{\\sum_{i=1}^M h_{i,j}}{\\sum_{i=1}^M N_i e^{f_i - u_{i,j}}}\n    $$\n    $$\n    e^{-f_i} = \\sum_{j=0}^{B-1} e^{-F_j - u_{i,j}}\n    $$\n    在这里，$F_j$ 是分箱 $j$ 的自由能，$u_{i,j} = u_i(\\theta_j)$ 是窗口 $i$ 在分箱 $j$ 中的偏置势，$f_i$ 是各个模拟的自由能。$C$ 是一个归一化常数。这些方程通过迭代求解，直到 $F_j$ 和 $f_i$ 的值收敛。为确保数值稳定性，涉及指数和的计算将使用 log-sum-exp 技巧在对数空间中进行。\n\n3.  在获得收敛的自由能分布图 $F(\\theta_j)$ 之后，最后一步是提取所要求的两个标量：能垒高度 $\\Delta F_\\mathrm{bar}$ 和不对称性 $\\Delta F_\\mathrm{asym}$。这需要确定与问题中指定的角度区域相对应的正确索引范围：$\\theta \\in [0,\\pi]$ 用于能垒顶部，$\\theta \\in [-\\pi/3, \\pi/3]$ 用于零附近的最小值，以及 $|d(\\theta,\\pi)| \\le \\pi/3$ 用于 $\\pi$ 附近的最小值。在这些特定的索引范围内找到分布图 $F(\\theta_j)$ 的最小值和最大值，并根据其定义计算最终的标量。\n\n一个关键部分是正确处理角度 $\\theta$ 的周期性边界条件。最小镜像角距离 $d(\\theta, \\phi)$ 必须使用一个函数来计算，该函数能正确地将差值 $\\theta-\\phi$ 包装到区间 $(-\\pi, \\pi]$ 中，如问题所述。然后将其平方以计算谐波偏置能。\n\n整个过程封装在一个 Python 脚本中，该脚本处理三个测试案例中的每一个，并按照指定的输出格式将最终结果格式化为单个字符串。", "answer": "```python\nimport numpy as np\nfrom scipy.special import logsumexp\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test cases.\n    It orchestrates the data generation, analysis, and final output formatting.\n    \"\"\"\n\n    def wrap_to_pi(x):\n        \"\"\"\n        Wraps angle(s) x to the interval (-pi, pi].\n\n        Parameters:\n        x (float or np.ndarray): The angle(s) in radians.\n\n        Returns:\n        float or np.ndarray: The wrapped angle(s).\n        \"\"\"\n        y = np.mod(x, 2 * np.pi)\n        # For an array y, np.where is used for conditional assignment.\n        # if y > pi, it is mapped to y - 2*pi, resulting in the range (-pi, 0).\n        # if y = pi, it is unchanged, giving the range [0, pi].\n        # The combination of these two is (-pi, pi].\n        y = np.where(y > np.pi, y - 2 * np.pi, y)\n        return y\n\n    def process_case(alpha, beta, k, B, N_i):\n        \"\"\"\n        Processes a single test case: generates histograms, runs WHAM, and computes results.\n        \"\"\"\n        # 1. Setup grid and parameters\n        M = 8  # Number of windows\n        delta_theta = 2 * np.pi / B\n        theta_j = -np.pi + (np.arange(B) + 0.5) * delta_theta\n        theta_i_centers = -np.pi + np.arange(M) * np.pi / 4\n\n        # 2. Generate histograms deterministically\n        histograms = np.zeros((M, B), dtype=np.int64)\n        bias_potentials = np.zeros((M, B))\n        \n        # Calculate unbiased potential on the grid\n        u0_j = -alpha * np.cos(2 * theta_j) - beta * np.cos(theta_j)\n\n        for i in range(M):\n            # Calculate bias potential for window i\n            d_theta = wrap_to_pi(theta_j - theta_i_centers[i])\n            ui_j = 0.5 * k * d_theta**2\n            bias_potentials[i, :] = ui_j\n\n            # Calculate total potential and exact probabilities for bin j in window i\n            total_potential = u0_j + ui_j\n            log_probs = -total_potential\n            log_probs -= logsumexp(log_probs)  # Normalize using logsumexp\n            probs = np.exp(log_probs)\n            \n            # Calculate expected counts\n            expected_counts = N_i[i] * probs\n            \n            # Deterministic rounding procedure\n            floored_counts = np.floor(expected_counts)\n            h_ij = floored_counts.astype(np.int64)\n            # Use round() to handle potential float precision issues\n            remainder = int(round(N_i[i] - np.sum(floored_counts)))\n            \n            if remainder > 0:\n                fractional_parts = expected_counts - floored_counts\n                j_indices = np.arange(B)\n                # Sort indices by fractional part (descending) and then index (ascending) to break ties\n                sorted_indices = np.lexsort((j_indices, -fractional_parts))\n                indices_to_increment = sorted_indices[:remainder]\n                h_ij[indices_to_increment] += 1\n            \n            histograms[i, :] = h_ij\n\n        # 3. Reconstruct free energy profile using WHAM\n        F = np.zeros(B)  # Initial guess for free energies\n        N_i_arr = np.array(N_i)\n        total_counts_j = np.sum(histograms, axis=0)\n        \n        # Bins with zero counts will have infinite free energy\n        non_zero_counts = total_counts_j > 0\n        log_total_counts_j = np.full(B, -np.inf)\n        if np.any(non_zero_counts):\n            log_total_counts_j[non_zero_counts] = np.log(total_counts_j[non_zero_counts])\n\n        # WHAM iterative solution\n        max_iter = 10000\n        tolerance = 1e-9\n        for _ in range(max_iter):\n            F_old = F.copy()\n            \n            # Update f_i (dimensionless free energies of each simulation)\n            f = -logsumexp(-F[np.newaxis, :] - bias_potentials, axis=1)\n\n            # Update F_j (unbiased free energy profile)\n            log_sum_exp_term = logsumexp(np.log(N_i_arr)[:, np.newaxis] + f[:, np.newaxis] - bias_potentials, axis=0)\n            F = -log_total_counts_j + log_sum_exp_term\n\n            # Normalize F to prevent drift and handle any infinities\n            finite_F = F[np.isfinite(F)]\n            if finite_F.size > 0:\n                F -= np.min(finite_F)\n            \n            # Check for convergence\n            if np.all(np.isclose(F, F_old, atol=tolerance, rtol=0)):\n                break\n\n        # 4. Analyze the free energy profile F\n        # Define index ranges for analysis using boolean masks\n        range_0_pi_mask = theta_j >= 0\n        range_near_0_mask = (theta_j >= -np.pi/3)  (theta_j = np.pi/3)\n        range_near_pi_mask = (theta_j = -2*np.pi/3) | (theta_j >= 2*np.pi/3)\n\n        # Ensure ranges are not empty before taking min/max\n        if not np.any(range_near_0_mask) or not np.any(range_near_pi_mask) or not np.any(range_0_pi_mask):\n             return [np.nan, np.nan] # Should not happen with B=60\n\n        # Find minima and maxima in the specified ranges\n        F_min_near_0 = np.min(F[range_near_0_mask])\n        F_min_near_pi = np.min(F[range_near_pi_mask])\n        F_barrier_top = np.max(F[range_0_pi_mask])\n\n        # Calculate final scalar quantities\n        delta_F_bar = F_barrier_top - min(F_min_near_0, F_min_near_pi)\n        delta_F_asym = F_min_near_pi - F_min_near_0\n        \n        return [delta_F_bar, delta_F_asym]\n\n    # Define the test cases from the problem statement\n    test_cases = [\n        # Case 1: happy path, strongly bimodal and nearly symmetric\n        {\n            \"alpha\": 1.5, \"beta\": 0.1, \"k\": 20, \"B\": 60,\n            \"N_i\": [2000, 1500, 2500, 1800, 2200, 1600, 2400, 1700]\n        },\n        # Case 2: boundary case, nearly flat pocket\n        {\n            \"alpha\": 0.15, \"beta\": 0.0, \"k\": 8, \"B\": 60,\n            \"N_i\": [1200, 1200, 1200, 1200, 1200, 1200, 1200, 1200]\n        },\n        # Case 3: asymmetric case with reversed minimum ordering\n        {\n            \"alpha\": 1.6, \"beta\": -0.3, \"k\": 25, \"B\": 60,\n            \"N_i\": [3000, 1800, 2200, 2000, 2600, 1800, 2400, 1600]\n        }\n    ]\n    \n    results = []\n    for case_params in test_cases:\n        result = process_case(**case_params)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "2455424"}, {"introduction": "获得自由能曲线并不是故事的结局，验证结果的正确性同等重要。本问题[@problem_id:2455465]提出了一个常见但具有欺骗性的场景：元动力学模拟似乎找到了一个稳定状态，但无偏的模拟却揭示了事实并非如此。通过分析这种差异，你将认识到验证模拟结果的极端重要性，并理解你所选择的CV可能遗漏的“隐藏”慢自由度所带来的深远影响。", "problem": "一名学生使用元动力学 (metadynamics) 来探索一个分子系统的自由能面 (FES)。他们选择了一个单一的集合变量 (CV) $s(\\mathbf{x})$，在元动力学模拟过程中加入了一个依赖于历史的偏置势 $V_{\\mathrm{bias}}(s,t)$，并在足够长的时间后从该偏置势重构出自由能曲线 $F(s)$。在重构的 $F(s)$ 中，该学生在 $s=s^{\\ast}$ 处发现了一个看起来很深的极小值。随后，他们从元动力学轨迹中提取了一个构象 $\\mathbf{x}^{\\ast}$，其满足 $s(\\mathbf{x}^{\\ast}) \\approx s^{\\ast}$，并在相同的温度 $T$ 和使用相同的哈密顿量（无偏置势，恒温器和积分器设置完全相同）的情况下，进行了一次无偏置的分子动力学 (MD) 模拟。在这次无偏置MD模拟中，系统迅速离开了 $s^{\\ast}$ 的邻近区域，跃迁到另一个状态，并且在模拟的时间尺度内没有返回。\n\n假设热力学定义为 $F(s)=-k_{\\mathrm{B}}T\\ln P(s)+C$，其中 $k_{\\mathrm{B}}$ 是玻尔兹曼常数，$P(s)$ 是CV的平衡概率密度，$C$ 是一个无关常数。同时回想一下，沿着一个真正相关的反应坐标 $q$，跃迁速率 $k$ 通常遵循 $k\\propto \\exp(-\\beta \\Delta F^{\\ddagger})$ 的标度关系，其中 $\\beta=1/(k_{\\mathrm{B}}T)$，$\\Delta F^{\\ddagger}$ 是沿着 $q$ 的自由能垒。\n\n基于该学生对元动力学模拟的观察，以下哪个推论最为合理？\n\nA. $F(s)$ 中的深极小值必然意味着一个大的逃逸势垒，因此在无偏置MD中的快速逃逸必定是由于数值积分误差；除此之外，元动力学计算的自由能是正确的。\n\nB. 所选的CV $s(\\mathbf{x})$ 不足以参数化慢动力学过程；$F(s)$ 中表观的深极小值是投影到 $s$ 上产生的假象，并且 $s^{\\ast}$ 处的构象在未被 $s$ 捕捉到的正交自由度上是不稳定的。\n\nC. 这种差异的产生是因为无偏置MD的温度 $T$ 与元动力学中使用的温度不同；因此无法对元动力学模拟的质量做出任何推断。\n\nD. 元动力学中的高斯山太小，因此 $s^{\\ast}$ 处的极小值在现实中甚至更深；无偏置MD中的快速逃逸是一次罕见的涨落，并支持了元动力学模拟的收敛。", "solution": "必须首先验证问题陈述的科学性和逻辑完整性。\n\n### 步骤1：提取已知条件\n- 在一个分子系统上使用单一集合变量 (CV) $s(\\mathbf{x})$ 进行了一次元动力学模拟。\n- 在模拟过程中加入了一个依赖于历史的偏置势 $V_{\\mathrm{bias}}(s,t)$。\n- 从该偏置势重构出了自由能曲线 $F(s)$。\n- 这个重构的 $F(s)$ 在 $s=s^{\\ast}$ 处有一个深的极小值。\n- 从元动力学轨迹中提取了一个构象 $\\mathbf{x}^{\\ast}$，其满足 $s(\\mathbf{x}^{\\ast}) \\approx s^{\\ast}$。\n- 从 $\\mathbf{x}^{\\ast}$ 开始，在相同条件下（温度 $T$，哈密顿量，控温器，积分器）进行了一次无偏置的分子动力学 (MD) 模拟。\n- 在无偏置MD中，系统迅速离开了 $s^{\\ast}$ 附近的区域并且没有返回。\n- 自由能曲线的热力学定义是 $F(s)=-k_{\\mathrm{B}}T\\ln P(s)+C$。\n- 沿相关反应坐标的跃迁速率 $k$ 的标度关系为 $k\\propto \\exp(-\\beta \\Delta F^{\\ddagger})$，其中 $\\beta=1/(k_{\\mathrm{B}}T)$。\n\n### 步骤2：使用已知条件进行验证\n该问题描述了在使用像元动力学这样的增强采样技术的计算研究中一个常见且真实的场景。\n\n- **科学上成立：** 所呈现的概念——元动力学、集合变量、自由能面、无偏置MD和跃迁速率——在计算化学和统计力学中是标准和基础的。所描述的场景不仅是合理的，而且是应用此类方法时的一个主要陷阱的教科书式例子。其原理陈述正确。\n- **提问清晰：** 该问题被构造为一个思想实验或对计算结果的解释。它要求在一组选项中找出最合理的推论，这需要基于所提供的信息进行推理。可以得出一个逻辑结论。\n- **客观性：** 语言是技术性的和客观的。对模拟结果的描述（“深的极小值”、“迅速离开”）在分子模拟的背景下其预期的物理意义是清晰的。\n\n### 步骤3：结论与行动\n问题陈述是有效的。它在科学上可靠、提问清晰且客观。它提出了一个关于解释元动力学结果的标准问题。我将继续进行全面的分析和解答。\n\n***\n\n问题的核心在于两次模拟结果之间的明显矛盾：\n1.  **元动力学：** 重构的自由能面 $F(s)$ 在 $s = s^{\\ast}$ 处显示出一个深的极小值。根据关系式 $F(s) = -k_{\\mathrm{B}}T\\ln P(s) + C$，自由能的深极小值对应于高的平衡概率密度 $P(s^{\\ast})$。这表明对应于 $s=s^{\\ast}$ 的状态是热力学稳定的。此外，如果 $s$ 是真实的反应坐标，一个深阱将意味着有高势垒将其与其他状态分开，从而导致 $s^{\\ast}$ 处状态的寿命很长。\n2.  **无偏置MD：** 从构象 $\\mathbf{x}^{\\ast}$ （其中 $s(\\mathbf{x}^{\\ast}) \\approx s^{\\ast}$）开始的模拟显示系统是动力学不稳定的。它“迅速离开” $s^{\\ast}$ 的邻近区域，表明该状态的寿命很短。这与从 $F(s)$ 推断出的稳定性结论相矛盾。\n\n任务是找出造成这种差异的最合理的理由。\n\n### 逐项分析选项\n\n**A. $F(s)$ 中的深极小值必然意味着一个大的逃逸势垒，因此在无偏置MD中的快速逃逸必定是由于数值积分误差；除此之外，元动力学计算的自由能是正确的。**\n\n这个陈述是有缺陷的。自由能曲线 $F(s)$ 是全维势能面在一维坐标 $s$ 上的投影。$F(s)$ 中的深极小值仅意味着*沿着坐标 $s$* 有一个大的逃逸势垒。它没有提供关于系统相对于与 $s$ 正交的自由度上的运动的稳定性的信息。构象 $\\mathbf{x}^{\\ast}$ 可以位于相对于 $s$ 的深阱中，同时又位于相对于其他未被 $s$ 捕捉到的“隐藏”坐标的最大值或陡峭的下坡上。在无偏置模拟中观察到的快速逃逸（该模拟在全维空间中传播系统）是动力学不稳定性的强有力的物理证据。在没有任何依据的情况下将其归因于“数值积分误差”是不严谨的科学推理。无偏置MD的结果是使对 $F(s)$ 的简单解释失效的关键数据，它本身不是一个错误。\n\n结论：**不正确**。\n\n**B. 所选的CV $s(\\mathbf{x})$ 不足以参数化慢动力学过程；$F(s)$ 中表观的深极小值是投影到 $s$ 上产生的假象，并且 $s^{\\ast}$ 处的构象在未被 $s$ 捕捉到的正交自由度上是不稳定的。**\n\n这是最准确和最根本的解释。自由能 $F(s)$ 是通过对所有与给定 $s$ 值兼容的自由度 $\\mathbf{x}$ 进行积分得到的：\n$$ P(s) = \\int d\\mathbf{x} \\, \\delta(s(\\mathbf{x}) - s) P(\\mathbf{x}) \\propto \\int d\\mathbf{x} \\, \\delta(s(\\mathbf{x}) - s) e^{-\\beta U(\\mathbf{x})} $$\n低的 $F(s)$ 值意味着具有 $s(\\mathbf{x})=s$ 的构象系综具有高的总统计权重。然而，这个系综可能包含高能（不稳定构象）和低能（稳定构象）的子区域。如果元动力学模拟将系统推入一个高能区域，而该区域恰好投影到 $s=s^{\\ast}$ 上，那么由于熵效应或对同样在 $s=s^{\\ast}$ 处采样的其他更稳定区域的平均，重构的 $F(s)$ 可能仍然在那里显示出极小值。当从这个高能区域提取一个特定的构象 $\\mathbf{x}^{\\ast}$ 并用于开始无偏置MD时，系统会自然地、迅速地沿着与 $s$ 正交的不稳定自由度“下山”演化。这是一个典型症状，表明所选的集合变量不佳，未能捕捉到系统的所有相关慢运动。在一维投影中表观的稳定性是一种假象。\n\n结论：**正确**。\n\n**C. 这种差异的产生是因为无偏置MD的温度 $T$ 与元动力学中使用的温度不同；因此无法对元动力学模拟的质量做出任何推断。**\n\n问题陈述明确指出，无偏置MD是在“**相同的温度 T** 和使用 **相同的哈密顿量**”下运行的。这个选项引入了一个与给定信息直接矛盾的前提。因此，它不可能是正确的解释。\n\n结论：**不正确**。\n\n**D. 元动力学中的高斯山太小，因此 $s^{\\ast}$ 处的极小值在现实中甚至更深；无偏置MD中的快速逃逸是一次罕见的涨落，并支持了元动力学模拟的收敛。**\n\n这个陈述包含多个逻辑错误。首先，高斯山的大小影响收敛速度并可能引入误差，但它并没有一个简单的直接关系，即小的高斯山能保证真实的极小值更深。未完全填充的势阱可能看起来被人为地加深了。其次，更关键的是，根据定义，“快速”逃逸不是“罕见的涨落”。一个罕见事件，比如跨越一个高能垒，只会在很长的模拟时间后才会被观察到。一个快速事件意味着势垒很低或不存在，表明动力学不稳定。因此，快速逃逸直接与系统处于一个稳定的深极小值的观点相矛盾，从而从根本上挑战了使用该CV的元动力学模拟的收敛性和有效性。\n\n结论：**不正确**。", "answer": "$$\\boxed{B}$$", "id": "2455465"}]}