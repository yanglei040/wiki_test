{"hands_on_practices": [{"introduction": "理论上的计算标度律如何转化为实际的硬件限制？这个实践练习将引导你完成一个基础但至关重要的计算，将一个算法的内存需求与其可行性直接联系起来。通过计算在给定的内存容量下，可以存储的最大哈特里-福克（Hartree-Fock）积分张量的大小，你将亲身体会到理论成本分析在规划计算实验时的实用价值 ([@problem_id:2452800])。", "problem": "在一个基于一组空间基函数的 Hartree-Fock 计算中，四指标电子排斥积分张量可以表示为一个稠密的四阶数组，其条目由 $(\\mu,\\nu,\\lambda,\\sigma)$ 索引，每个索引的取值范围为从 $1$ 到 $N$。假设没有利用对称性约化或稀疏性，因此存储的实数总数为 $N^{4}$。假设你有一个计算节点，其上分配了恰好 $128$ 吉比字节（gibibytes）的内存，专门用于在内存中存储此张量，并且每个张量元素都存储为 $64$ 位浮点数。使用以下单位转换定义：$1\\ \\mathrm{byte} = 8\\ \\mathrm{bits}$ 和 $1\\ \\mathrm{GiB} = 2^{30}\\ \\mathrm{bytes}$。忽略任何额外的内存开销。为使完整的 $N \\times N \\times N \\times N$ 张量能完全载入内存（in-core），最大的整数 $N$ 是多少？请提供 $N$ 的精确整数值。", "solution": "对所述问题进行有效性验证。\n\n第一步：提取已知条件。\n- 研究对象是四指标电子排斥积分张量。\n- 该张量表示为一个稠密的四阶数组，索引为 $(\\mu, \\nu, \\lambda, \\sigma)$。\n- 每个索引的取值范围为从 $1$ 到 $N$，其中 $N$ 是空间基函数的数量。\n- 未利用对称性或稀疏性。\n- 张量中的元素总数为 $N^4$。\n- 每个元素存储为 $64$ 位浮点数。\n- 计算节点上的可用内存恰好为 $128$ 吉比字节 (GiB)。\n- 单位转换已指定: $1\\ \\mathrm{byte} = 8\\ \\mathrm{bits}$ 和 $1\\ \\mathrm{GiB} = 2^{30}\\ \\mathrm{bytes}$。\n- 操作系统或其他来源的内存开销将被忽略。\n- 目标是找到能使张量完全存储在指定内存中的最大整数 $N$。\n\n第二步：使用提取的已知条件进行验证。\n- **科学依据**：该问题是计算化学中关于硬件限制的一个完全标准和基础的练习。在基组表示中，双电子排斥积分张量的 $N^4$ 标度是理解 Hartree-Fock 理论计算成本的基石。数据类型和内存大小是现实的。该问题有效。\n- **适定性**：该问题提供了所有必要的数值和定义，以得出 $N$ 的唯一整数解。它是明确且自洽的。该问题有效。\n- **客观性**：该问题以精确、定量的术语陈述。没有主观或基于意见的成分。该问题有效。\n\n第三步：结论与行动。\n该问题有效。将构建解答。\n\n基本原则是，存储张量所需的总内存必须小于或等于可用内存。我们将把这个条件形式化，并求解 $N$ 的最大整数值。\n\n首先，我们确定存储张量单个元素所需的内存。问题指出，每个元素是一个 $64$ 位浮点数。使用提供的转换，我们计算出以字节为单位的大小：\n$$\n\\text{每个元素的大小} = 64\\ \\mathrm{bits} \\times \\frac{1\\ \\mathrm{byte}}{8\\ \\mathrm{bits}} = 8\\ \\mathrm{bytes}\n$$\n\n接下来，我们表示存储整个稠密张量所需的总内存。该张量是 $4$ 阶的，每个维度的大小为 $N$。因此，元素总数为 $N^4$。我们记总内存需求为 $M_{\\text{req}}$，它是元素数量与每个元素大小的乘积：\n$$\nM_{\\text{req}} = N^4 \\times (8\\ \\mathrm{bytes})\n$$\n\n现在，我们计算以字节为单位的总可用内存 $M_{\\text{avail}}$。可用内存为 $128$ GiB。使用指定的转换 $1\\ \\mathrm{GiB} = 2^{30}\\ \\mathrm{bytes}$，我们有：\n$$\nM_{\\text{avail}} = 128\\ \\mathrm{GiB} \\times \\frac{2^{30}\\ \\mathrm{bytes}}{1\\ \\mathrm{GiB}} = 128 \\times 2^{30}\\ \\mathrm{bytes}\n$$\n将系数 $128$ 表示为 $2$ 的幂会很有利：$128 = 2^7$。因此，\n$$\nM_{\\text{avail}} = 2^7 \\times 2^{30}\\ \\mathrm{bytes} = 2^{37}\\ \\mathrm{bytes}\n$$\n\n张量能够载入内存的条件是 $M_{\\text{req}} \\le M_{\\text{avail}}$。我们代入这些量的表达式：\n$$\n8 \\times N^4 \\le 2^{37}\n$$\n我们将系数 $8$ 表示为 $2$ 的幂：$8 = 2^3$。\n$$\n2^3 \\times N^4 \\le 2^{37}\n$$\n为了求解 $N$，我们首先通过两边同除以 $2^3$ 来分离 $N^4$ 项：\n$$\nN^4 \\le \\frac{2^{37}}{2^3} = 2^{37-3} = 2^{34}\n$$\n现在，我们对不等式两边取四次方根。由于 $N$ 必须是正整数，这个操作很简单：\n$$\nN \\le (2^{34})^{\\frac{1}{4}} = 2^{\\frac{34}{4}} = 2^{8.5}\n$$\n为了求出数值，我们可以将 $2^{8.5}$ 写成 $2^8 \\times 2^{0.5}$：\n$$\nN \\le 2^8 \\times \\sqrt{2}\n$$\n我们知道 $2^8 = 256$。$\\sqrt{2}$ 的值约为 $1.41421356...$。\n$$\nN \\le 256 \\times 1.41421356... \\approx 362.03867...\n$$\n问题要求满足此条件的最大整数 $N$。满足 $N \\le 362.03867...$ 的整数集合是 $\\{..., 360, 361, 362\\}$。此集合中的最大整数是 $362$。\n\n因此，能使完整的 ERI 张量存储在给定内存中的最大基函数数量 $N$ 是 $362$。", "answer": "$$\n\\boxed{362}\n$$", "id": "2452800"}, {"introduction": "计算标度律中的指数不仅仅是一个抽象的数字，它直接决定了计算时间如何随系统规模的增长而飙升。本练习通过一个假设性的场景——一个存在缺陷的密度泛函理论（DFT）代码——来量化比较不同标度指数带来的性能差异。通过这个练习，你将更深刻地理解为什么在算法开发和选择中，追求更低的标度指数（例如，从 $O(N^{3.5})$ 降至 $O(N^3)$）是至关重要的 ([@problem_id:2452785])。", "problem": "在固定的硬件平台上，对于一个大小为 $N$（例如，基函数数量）的体系，一个密度泛函理论（DFT）代码的墙钟运行时间 $T(N)$ 被观察到在 $N$ 足够大时与 $N$ 的某个幂成正比。假设正确的实现具有 $T_{\\text{corr}}(N) \\propto N^{3}$ 的标度行为，但一个错误（bug）导致代码的标度行为变为 $T_{\\text{bug}}(N) \\propto N^{3.5}$。假定两个版本共享相同的比例前因子（即，它们仅在 $N$ 的指数上有所不同），在相同的硬件上运行，并且任何低阶项都可以忽略不计。\n\n当对于同一体系，该错误导致的运行时间相对于正确实现增加了 $100\\%$，即 $T_{\\text{bug}}(N)$ 恰好是 $T_{\\text{corr}}(N)$ 的两倍时，$N$ 的值是多少？请以纯数字形式提供 $N$，不带单位。无需四舍五入。", "solution": "在尝试求解之前，必须首先对问题陈述进行严格的验证。\n\n步骤1：提取已知条件。\n提供的信息如下：\n- 密度泛函理论（DFT）代码的正确实现的墙钟运行时间为 $T_{\\text{corr}}(N)$。\n- 正确实现的标度行为为 $T_{\\text{corr}}(N) \\propto N^{3}$。\n- 同一代码的错误实现的墙钟运行时间为 $T_{\\text{bug}}(N)$。\n- 错误实现的标度行为为 $T_{\\text{bug}}(N) \\propto N^{3.5}$。\n- 两种实现的比例前因子（我们用 $c$ 表示）是相同的。\n- 标度表达式中的低阶项被认为是可忽略的。\n- 需要求解的条件是，当错误实现的运行时间相对于正确实现的运行时间增加了 $100\\%$ 时的体系大小 $N$。这等同于条件 $T_{\\text{bug}}(N) = 2 T_{\\text{corr}}(N)$。\n\n步骤2：使用提取的已知条件进行验证。\n根据所需标准对问题进行评估：\n- **科学依据：** 前提是合理的。标准的DFT计算通常表现出计算成本随体系大小的三次方 $O(N^{3})$ 变化的标度行为，通常由矩阵对角化或交换相关势的构建所主导。算法效率低下或错误可能会合理地增加有效标度指数。在此背景下，给出的指数 $3$ 和 $3.5$ 是现实的。\n- **适定性：** 问题是适定的。它提供了清晰的数学关系和需要满足的特定条件，由此可以唯一确定单个未知变量 $N$。\n- **客观性：** 语言是定量的和精确的，没有任何主观或模棱两可的术语。\n\n该问题没有违反任何指定的无效标准。它具有科学合理性、可形式化、完整且结构良好。\n\n步骤3：结论与行动。\n问题被判定为有效。现在将推导解答。\n\n标度关系明确定义为：\n$$T_{\\text{corr}}(N) = c N^{3}$$\n$$T_{\\text{bug}}(N) = c N^{3.5}$$\n其中 $c$ 是一个正常数，代表共享的比例前因子。忽略低阶项的假设允许我们在本次分析中将这些简单的幂律用作精确的等式。\n\n给定的条件是，错误实现的运行时间相对于正确实现显示出 $100\\%$ 的增加。$100\\%$ 的增加对应于原始值的翻倍。因此，数学条件是：\n$$T_{\\text{bug}}(N) = T_{\\text{corr}}(N) + (1.00) \\times T_{\\text{corr}}(N) = 2 T_{\\text{corr}}(N)$$\n\n将标度表达式代入此方程：\n$$c N^{3.5} = 2 (c N^{3})$$\n\n我们正在寻求 $N$ 的非平凡解，这意味着 $N > 0$。比例前因子 $c$ 必须非零才能进行任何计算，所以 $c > 0$。因此，我们可以将方程两边同时除以 $c$：\n$$N^{3.5} = 2 N^{3}$$\n\n假设 $N > 0$，我们可以将两边同时除以 $N^{3}$：\n$$\\frac{N^{3.5}}{N^{3}} = 2$$\n\n使用指数性质 $x^{a}/x^{b} = x^{a-b}$：\n$$N^{3.5 - 3} = 2$$\n$$N^{0.5} = 2$$\n\n指数 $0.5$ 等价于平方根：\n$$N^{1/2} = \\sqrt{N} = 2$$\n\n为了解出 $N$，我们将方程两边平方：\n$$\\left(\\sqrt{N}\\right)^{2} = 2^{2}$$\n$$N = 4$$\n\n因此，对于体系大小为 $N=4$ 的情况，错误实现的运行时间将恰好是正确实现的两倍。这个结果与比例前因子 $c$ 无关，这对于基于标度律的相对比较是符合预期的。", "answer": "$$\\boxed{4}$$", "id": "2452785"}, {"introduction": "在理想世界中，将处理器数量加倍会使计算时间减半。然而，在真实的计算中，我们常常会遇到性能“负增长”的现象。这个练习探讨了这种反直觉结果背后的硬件层面的原因，从共享的内存带宽到处理器核心的频率调整 ([@problem_id:2452799])。理解这些并行计算中的瓶颈，对于在高性能计算环境中有效利用资源和调试性能问题至关重要。", "problem": "一名学生在同一台工作站上运行了两次完全相同的密度泛函理论 (DFT) 几何优化：一次使用 $8$ 个线程，一次使用 $16$ 个线程。使用 $16$ 个线程的运行比使用 $8$ 个线程的运行完成得更慢。除了线程数之外，没有更改任何输入文件或算法设置。以下哪种硬件层面的效应可以合理解释这个结果？请选择所有适用项。\n\nA. 内存带宽是共享资源；在 $16$ 个线程下，内存子系统饱和，导致与 $8$ 个线程相比，每线程带宽下降，总时间增加。\n\nB. 由于功率和散热限制（全核睿频），当有更多活动核心时，中央处理器 (CPU) 会降低每核心的频率，使得 $16$ 个线程比 $8$ 个线程慢。\n\nC. 非一致性内存访问 (NUMA) 效应：在 $16$ 个线程下，操作系统跨插槽调度工作，导致远程内存访问，与 $8$ 个线程相比，其延迟更高、带宽更低。\n\nD. 使用 $16$ 个线程的运行比使用 $8$ 个线程的运行使用了更大的分子几何构型，所以自然需要更长时间。\n\nE. 在 $16$ 个线程下，共享的末级缓存 (LLC) 中的争用增加，导致更高的缓存未命中率和更多的主内存流量，从而相对于 $8$ 个线程减慢了执行速度。\n\nF. DFT 使用的数学算法在更多线程上运行时具有更差的渐近复杂性类别，因此其大O成本在 $16$ 个线程时会增加。\n\nG. 同步多线程 (SMT) 已启用；$16$ 个线程分时共享 $8$ 个物理核心，对于此工作负载，额外的硬件线程几乎不提供好处，甚至由于资源争用而产生负面影响。", "solution": "问题描述了并行计算中一个典型的负强扩展性案例。目标是解决一个固定大小的问题，即一个密度泛函理论 (DFT) 几何优化问题，而将处理线程数从 $8$ 个增加到 $16$ 个导致了更长的执行时间。这表明增加更多线程所引入的开销超过了计算加速带来的好处。我们必须验证所提出的硬件层面原因对这一现象的解释是否合理。\n\n该问题陈述是有效的。它描述了在高性能计算中遇到的一个现实场景，其科学依据植根于计算机体系结构和计算化学的原理，并且问题提得很好，要求从给定列表中找出合理解释。\n\n我们现在来逐一评估每个选项。\n\n**A. 内存带宽是共享资源；在 $16$ 个线程下，内存子系统饱和，导致与 $8$ 个线程相比，每线程带宽下降，总时间增加。**\nDFT 计算的许多阶段，例如构建 Fock 或 Kohn-Sham 矩阵以及用于对角化的数值线性代数例程，都受内存带宽限制。从 DRAM 到 CPU 的总可用内存带宽对于所有核心来说是一种有限的共享资源。如果 $8$ 线程的执行已经占用了该带宽的很大一部分，那么将活动线程数加倍到 $16$ 个就可能使内存控制器过饱和。饱和时，线程必须等待更长时间才能从主内存中获取数据，导致处理器停顿周期增加。每线程的有效内存带宽会下降，如果算法的进展受到此数据访问速率的限制，那么总的墙上时钟时间将会增加。这是多核系统中一个非常常见的性能瓶颈。\n结论：**正确**。\n\n**B. 由于功率和散热限制（全核睿频），当有更多活动核心时，中央处理器 (CPU) 会降低每核心的频率，使得 $16$ 个线程比 $8$ 个线程慢。**\n现代 CPU 会根据工作负载、核心利用率、功耗和散热余量动态调整其时钟频率。这通常以“Turbo Boost”或“Precision Boost”等名义进行营销。一个核心可达到的最大频率与并发活动核心的数量成反比。运行 $16$ 个线程会加载 $16$ 个核心（或逻辑处理器），这比在 $8$ 个核心上运行产生更多的热量和消耗更多的功率。为了保持在指定的热设计功耗 (TDP) 和温度限制内，CPU 的电源管理单元将降低“全核”睿频频率。对于 $16$ 个活动核心的频率显著低于 $8$ 个活动核心的频率是完全可能的。如果这种频率降低导致的性能损失大于将工作并行化到额外 $8$ 个线程上所获得的性能增益，那么净结果就是执行时间变慢。\n结论：**正确**。\n\n**C. 非一致性内存访问 (NUMA) 效应：在 $16$ 个线程下，操作系统跨插槽调度工作，导致远程内存访问，与 $8$ 个线程相比，其延迟更高、带宽更低。**\n拥有 $16$ 个或更多核心的工作站通常采用多插槽或多芯粒设计，这会导致非一致性内存访问 (NUMA) 架构。在此类系统中，一个 CPU 由多个 NUMA 节点组成（例如，2 个节点，每个节点有 8 个核心）。每个节点都有自己的本地内存控制器和连接的 DRAM。访问本地内存速度很快，而访问连接到不同节点上的内存（远程内存）则因为需要穿越插槽间互连而产生更高的延迟和更低的带宽。一个 $8$ 线程的作业可能被操作系统调度器限制在单个 NUMA 节点内，从而完全受益于快速的本地内存访问。然而，一个 $16$ 线程的作业必然会跨越两个 NUMA 节点。这将为一个节点上的线程在尝试访问由另一节点上的线程分配的数据时引入远程内存访问。对于像 DFT 这样内存密集型的应用，内存访问延迟的增加和互连上的争用很容易导致显著的性能下降，从而造成净减速。\n结论：**正确**。\n\n**D. 使用 $16$ 个线程的运行比使用 $8$ 个线程的运行使用了更大的分子几何构型，所以自然需要更长时间。**\n该陈述直接与问题的前提相矛盾。问题明确指出，学生运行的是“**完全相同的**密度泛函理论 (DFT) 几何优化”，并且“**没有更改任何输入文件或算法设置**”。分子几何构型是输入文件的主要组成部分。因此，该选项被问题的条件所排除。\n结论：**错误**。\n\n**E. 在 $16$ 个线程下，共享的末级缓存 (LLC) 中的争用增加，导致更高的缓存未命中率和更多的主内存流量，从而相对于 $8$ 个线程减慢了执行速度。**\n末级缓存 (LLC)，通常是 $L3$ 缓存，是多个核心共享的关键性能组件。每个线程的性能取决于能否将其工作集数据保留在缓存中，以避免缓慢的主内存访问。当线程数从 $8$ 个增加到 $16$ 个时，每个线程可用的 LLC 容量减半。这可能导致一种称为“缓存抖动”的情况，即线程之间相互竞争地将对方的数据从缓存中驱逐出去。由此导致的缓存未命中率增加，迫使 CPU 更频繁地从主内存中获取数据，而主内存访问速度要慢上几个数量级。这种称为缓存争用的效应会增加内存流量和处理器停顿，从而导致性能下降。\n结论：**正确**。\n\n**F. DFT 使用的数学算法在更多线程上运行时具有更差的渐近复杂性类别，因此其大O成本在 $16$ 个线程时会增加。**\n这种说法反映了对计算复杂性的根本误解。渐近复杂性，用大O表示法（如 $O(N^3)$）表示，描述了算法的资源需求（如时间或内存）如何随输入规模 $N$（衡量系统大小的指标，如基函数数量）而变化。它不依赖于执行所使用的处理器数量。无论是否并行化，底层的数学算法都保持不变。并行化影响的是执行时间中的常数因子，$T(N, P) = c(P) \\cdot f(N)$，其中 $P$ 是处理器数量，$f(N)$ 代表渐近增长。函数 $f(N)$ 不随 $P$ 的变化而改变。\n结论：**错误**。\n\n**G. 同步多线程 (SMT) 已启用；$16$ 个线程分时共享 $8$ 个物理核心，对于此工作负载，额外的硬件线程几乎不提供好处，甚至由于资源争用而产生负面影响。**\n同步多线程 (SMT)，在英特尔 CPU 上称为超线程技术，允许单个物理核心向操作系统呈现为两个（或更多）逻辑处理器。如果工作站有一个启用了 SMT 的 $8$ 核 CPU，它将显示为拥有 $16$ 个逻辑核心。一个 $8$ 线程的运行将利用 $8$ 个物理核心，每个核心一个线程。一个 $16$ 线程的运行将在每个物理核心上调度两个线程。这两个线程必须共享核心的执行资源（例如，浮点单元、加载/存储单元、L1/L2 缓存）。对于许多已经高度优化以使用核心资源的科学计算工作负载而言，这种共享会导致资源争用，而不是有效利用空闲周期。这种争用可能使得一个核心上的两个线程的运行速度远低于单个线程速度的两倍，在某些情况下，甚至可能比单线程每核心的情况还要慢，导致从 $8$ 个线程增加到 $16$ 个线程时出现净性能损失。\n结论：**正确**。", "answer": "$$\\boxed{ABCEG}$$", "id": "2452799"}]}