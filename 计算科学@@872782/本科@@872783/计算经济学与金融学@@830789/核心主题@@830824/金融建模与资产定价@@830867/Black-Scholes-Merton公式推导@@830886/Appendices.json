{"hands_on_practices": [{"introduction": "Black-Scholes-Merton模型的推导核心在于理解期权价格如何随标的股票的随机运动而变化。本练习将运用BSM推导的基石——伊藤引理（Itô's Lemma）——来计算期权的“贝塔系数”，从而将其风险与股票风险联系起来。通过这个过程，你将更清晰地理解期权的Delta（$\\Delta$）与其风险特征之间的深刻联系。[@problem_id:2390329]", "problem": "考虑一个无摩擦市场，其中一只标的股票被连续交易，其价格过程被建模为几何布朗运动 (GBM)，即 $dS_t = \\mu S_t \\, dt + \\sigma S_t \\, dW_t$，其中 $\\,\\mu \\in \\mathbb{R}\\,$ 和 $\\,\\sigma > 0\\,$ 为常数，$W_t$ 是一个标准布朗运动。令 $C(S,t)$ 表示一份欧式看涨期权在时间 $t$ 的价格，该期权以该股票为标的，执行价为 $K$，到期日为 $T$，股票的连续股息率为 $q$，无风险利率为 $r$ 且连续复利。该期权价格是 Black–Scholes–Merton 框架下唯一的无套利价格。\n\n将无穷小时间间隔内股票的算术回报率定义为 $r_S = dS_t / S_t$，期权的算术回报率定义为 $r_C = dC_t / C_t$。将期权回报率相对于股票回报率的瞬时贝塔定义为\n$$\\beta = \\lim_{\\Delta t \\to 0^+} \\frac{\\operatorname{Cov}\\!\\left(r_C, r_S\\right)}{\\operatorname{Var}\\!\\left(r_S\\right)}.$$\n你的任务是，对下方测试套件中的每组参数，使用与模型假设一致的期权价格及其敏感度的精确解析值，计算模型所隐含的瞬时贝塔 $\\beta$。所有输出必须是实数，不带任何单位换算或百分比符号。\n\n测试套件（每个案例是一个元组 $(S, K, r, q, \\sigma, T)$）：\n- 案例1（一般情况，平价）：$(100.0, 100.0, 0.01, 0.02, 0.2, 1.0)$。\n- 案例2（深度实值）：$(150.0, 100.0, 0.03, 0.0, 0.25, 2.0)$。\n- 案例3（深度虚值）：$(50.0, 100.0, 0.01, 0.0, 0.2, 1.0)$。\n- 案例4（短到期时间，平价）：$(100.0, 100.0, 0.0, 0.0, 0.2, 1.0/365.0)$。\n- 案例5（带股息的虚值，长到期时间）：$(100.0, 110.0, 0.05, 0.02, 0.3, 3.0)$。\n\n要求：\n- 对每个案例，在给定的模型和参数下，使用上述算术回报率的定义计算瞬时贝塔 $\\beta$。\n- 将每个结果表示为浮点数，并四舍五入到六位小数。\n- 你的程序应生成单行输出，其中包含用方括号括起来的、以逗号分隔的结果列表，顺序与测试套件相同（例如 $[x_1,x_2,x_3,x_4,x_5]$）。不要包含任何额外的文本或空格。\n\n注意：不涉及角度；没有需要报告的物理单位。所有数值答案必须以实数形式提供（例如，使用 $0.123456$ 而不是 $12.3456\\%$）。", "solution": "该问题要求计算欧式看涨期权回报率相对于其标的股票回报率的瞬时贝塔。我们首先在 Black-Scholes-Merton 框架内严格推导该贝塔的解析表达式。\n\n问题将瞬时贝塔定义为：\n$$ \\beta = \\lim_{\\Delta t \\to 0^+} \\frac{\\operatorname{Cov}\\!\\left(r_C, r_S\\right)}{\\operatorname{Var}\\!\\left(r_S\\right)} $$\n其中 $r_S = dS_t / S_t$ 和 $r_C = dC_t / C_t$ 分别是股票和期权的算术回报率。此公式等价于瞬时协方差率与瞬时方差率之比。\n\n首先，我们分析分母，它涉及股票的回报动态。股票价格 $S_t$ 服从几何布朗运动 (GBM)：\n$$ dS_t = \\mu S_t \\, dt + \\sigma S_t \\, dW_t $$\n因此，算术回报率为：\n$$ r_S = \\frac{dS_t}{S_t} = \\mu \\, dt + \\sigma \\, dW_t $$\n在无穷小时间间隔 $dt$ 上，该过程的方差完全由随机项驱动。标准布朗运动的增量 $dW_t$ 服从均值为 $0$、方差为 $dt$ 的正态分布。\n$$ \\operatorname{Var}(r_S) = \\operatorname{Var}(\\mu \\, dt + \\sigma \\, dW_t) = \\sigma^2 \\operatorname{Var}(dW_t) = \\sigma^2 dt $$\n瞬时方差率是 $dt$ 的系数，即 $\\sigma^2$。这是 $\\beta$ 表达式中的分母。\n\n接下来，我们分析分子，它涉及期权的回报动态。期权价格 $C(S,t)$ 是股票价格 $S$ 和时间 $t$ 的函数。我们应用 Itô's Lemma 来找出 $C(S,t)$ 的动态过程：\n$$ dC_t = \\frac{\\partial C}{\\partial t} dt + \\frac{\\partial C}{\\partial S} dS_t + \\frac{1}{2} \\frac{\\partial^2 C}{\\partial S^2} (dS_t)^2 $$\n二次变分项 $(dS_t)^2$ 计算如下：\n$$ (dS_t)^2 = (\\mu S_t \\, dt + \\sigma S_t \\, dW_t)^2 = \\sigma^2 S_t^2 (dW_t)^2 = \\sigma^2 S_t^2 dt $$\n此处，我们忽略 $dt^{3/2}$ 和 $dt^2$ 阶的项。将 $dS_t$ 和 $(dS_t)^2$ 的表达式代入 $dC_t$ 的伊藤展开式中：\n$$ dC_t = \\frac{\\partial C}{\\partial t} dt + \\frac{\\partial C}{\\partial S} (\\mu S_t \\, dt + \\sigma S_t \\, dW_t) + \\frac{1}{2} \\frac{\\partial^2 C}{\\partial S^2} \\sigma^2 S_t^2 dt $$\n对 $dt$ 和 $dW_t$ 项进行分组得到：\n$$ dC_t = \\left( \\frac{\\partial C}{\\partial t} + \\mu S_t \\frac{\\partial C}{\\partial S} + \\frac{1}{2} \\sigma^2 S_t^2 \\frac{\\partial^2 C}{\\partial S^2} \\right) dt + \\left( \\sigma S_t \\frac{\\partial C}{\\partial S} \\right) dW_t $$\n期权的算术回报率为 $r_C = dC_t / C_t$：\n$$ r_C = \\frac{1}{C_t} \\left( \\frac{\\partial C}{\\partial t} + \\mu S_t \\frac{\\partial C}{\\partial S} + \\frac{1}{2} \\sigma^2 S_t^2 \\frac{\\partial^2 C}{\\partial S^2} \\right) dt + \\frac{1}{C_t} \\left( \\sigma S_t \\frac{\\partial C}{\\partial S} \\right) dW_t $$\n现在，我们计算在区间 $dt$ 上 $r_C$ 和 $r_S$ 之间的协方差：\n$$ \\operatorname{Cov}(r_C, r_S) = \\operatorname{Cov}\\left( \\frac{1}{C_t} \\sigma S_t \\frac{\\partial C}{\\partial S} dW_t, \\sigma dW_t \\right) $$\n只有随机部分对协方差有贡献。\n$$ \\operatorname{Cov}(r_C, r_S) = \\left( \\frac{1}{C_t} \\sigma S_t \\frac{\\partial C}{\\partial S} \\right) \\cdot \\sigma \\cdot \\operatorname{Var}(dW_t) = \\frac{\\sigma^2 S_t}{C_t} \\frac{\\partial C}{\\partial S} dt $$\n瞬时协方差率是 $dt$ 的系数：$\\frac{\\sigma^2 S_t}{C_t} \\frac{\\partial C}{\\partial S}$。\n\n现在我们可以组合出贝塔的表达式：\n$$ \\beta = \\frac{\\text{Instantaneous Covariance Rate}}{\\text{Instantaneous Variance Rate}} = \\frac{\\frac{\\sigma^2 S_t}{C_t} \\frac{\\partial C}{\\partial S}}{\\sigma^2} $$\n$\\sigma^2$ 项相互抵消，得出一个非常简洁优美的结果：\n$$ \\beta = \\frac{S_t}{C_t} \\frac{\\partial C}{\\partial S} $$\n这个量也被称为期权价格相对于股票价格的弹性，通常用 $\\Omega$ 表示。它是期权的 delta ($\\Delta_C = \\frac{\\partial C}{\\partial S}$) 与股票价格和期权价格之比的乘积。\n\n为了数值计算 $\\beta$，我们必须按规定使用 Black-Scholes-Merton 模型的解析公式。令 $\\tau = T-t$ 为到期时间。在时间 $t=0$ 时，$\\tau=T$。带连续股息率 $q$ 的欧式看涨期权价格为：\n$$ C(S, t) = S e^{-q \\tau} N(d_1) - K e^{-r \\tau} N(d_2) $$\n期权的 delta 为：\n$$ \\Delta_C = \\frac{\\partial C}{\\partial S} = e^{-q \\tau} N(d_1) $$\n其中 $N(\\cdot)$ 是标准正态分布的累积分布函数 (CDF)，而 $d_1, d_2$ 由以下公式给出：\n$$ d_1 = \\frac{\\ln(S/K) + (r - q + \\frac{1}{2}\\sigma^2)\\tau}{\\sigma \\sqrt{\\tau}} $$\n$$ d_2 = d_1 - \\sigma \\sqrt{\\tau} $$\n将 $C$ 和 $\\Delta_C$ 的表达式代入我们的 $\\beta$ 公式中：\n$$ \\beta = \\frac{S \\cdot \\left( e^{-q \\tau} N(d_1) \\right)}{S e^{-q \\tau} N(d_1) - K e^{-r \\tau} N(d_2)} $$\n这就是需要实现的最终解析公式。对于每个测试案例，我们将给定的参数 $(S, K, r, q, \\sigma, T)$（其中 $\\tau=T$）代入此方程，并使用标准的数值库来评估正态累积分布函数 $N(\\cdot)$。步骤如下：\n$1$. 对每组参数，计算 $\\tau=T$。\n$2$. 计算 $d_1$ 和 $d_2$。\n$3$. 评估 $N(d_1)$ 和 $N(d_2)$。\n$4$. 计算分子项 $S e^{-q \\tau} N(d_1)$。\n$5$. 计算分母项（即看涨期权价格 $C$），其值为 $S e^{-q \\tau} N(d_1) - K e^{-r \\tau} N(d_2)$。\n$6$. $\\beta$ 的值是第4步结果与第5步结果之比。\n此过程将应用于所有提供的测试案例。", "answer": "```python\nimport numpy as np\nfrom scipy.stats import norm\n\ndef solve():\n    \"\"\"\n    Computes the instantaneous beta of a European call option for a set of test cases.\n    \"\"\"\n    # Test suite: (S, K, r, q, sigma, T)\n    test_cases = [\n        (100.0, 100.0, 0.01, 0.02, 0.2, 1.0),\n        (150.0, 100.0, 0.03, 0.0, 0.25, 2.0),\n        (50.0, 100.0, 0.01, 0.0, 0.2, 1.0),\n        (100.0, 100.0, 0.0, 0.0, 0.2, 1.0 / 365.0),\n        (100.0, 110.0, 0.05, 0.02, 0.3, 3.0),\n    ]\n\n    def calculate_beta(S, K, r, q, sigma, T):\n        \"\"\"\n        Calculates the instantaneous beta of a European call option.\n        Beta = (S * Delta) / C\n        \"\"\"\n        # Ensure time to maturity is not zero to avoid division by zero in d1/d2.\n        # If maturity is extremely small, the result will be large but finite.\n        if T  1e-12:\n            return float('inf')\n\n        # Time to maturity\n        tau = T\n\n        # Calculate d1 and d2\n        sigma_sqrt_tau = sigma * np.sqrt(tau)\n        d1 = (np.log(S / K) + (r - q + 0.5 * sigma**2) * tau) / sigma_sqrt_tau\n        d2 = d1 - sigma_sqrt_tau\n\n        # Evaluate the standard normal CDF\n        N_d1 = norm.cdf(d1)\n        N_d2 = norm.cdf(d2)\n        \n        # We compute beta using the derived analytical formula:\n        # beta = (S * exp(-q*tau) * N(d1)) / (S * exp(-q*tau) * N(d1) - K * exp(-r*tau) * N(d2))\n        \n        numerator = S * np.exp(-q * tau) * N_d1\n        \n        # Denominator is the Black-Scholes call price C\n        denominator = numerator - K * np.exp(-r * tau) * N_d2\n\n        # To avoid division by zero for deep out-of-the-money options where C might be numerically zero\n        if np.abs(denominator)  1e-12:\n            # If the call price is effectively zero, the beta is theoretically infinite.\n            # In practice, we return a very large number or inf.\n            return float('inf')\n\n        beta = numerator / denominator\n        \n        return beta\n\n    results = []\n    for case in test_cases:\n        beta_value = calculate_beta(*case)\n        # Round the result to six decimal places as required.\n        results.append(f\"{beta_value:.6f}\")\n\n    # Format the final output string\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```", "id": "2390329"}, {"introduction": "著名的Black-Scholes-Merton公式是一个特定偏微分方程（PDE）的解析解。本练习让你通过数值方法直接求解该PDE，从期末的回报函数出发，一步步地反向推导出期权在初始时刻的价格，从而获得对该方程的直观感受。这种方法不仅揭示了PDE的内在运作机制，也为你展示了在缺乏解析解时，金融工程师所依赖的强大计算技术。[@problem_id:2387926]", "problem": "考虑一个无摩擦市场，其中一种风险资产的价格过程表示为 $S_t$，还有一个货币市场账户，其收益为连续复利的无风险利率 $r$。假设在风险中性概率测度下，该风险资产遵循几何布朗运动 $dS_t = r S_t \\, dt + \\sigma S_t \\, dW_t$，其中 $\\sigma  0$ 是恒定的波动率，$W_t$ 是一个标准布朗运动。设 $V(S,t)$ 表示一个行权价为 $K$、到期日为 $T$ 的欧式看涨期权在时间 $t$ 的价值。根据无套利和复制原理，$V(S,t)$ 满足 Black-Scholes-Merton 偏微分方程 $V_t + \\tfrac{1}{2} \\sigma^2 S^2 V_{SS} + r S V_S - r V = 0$，其中 $S \\in (0,\\infty)$ 且 $t \\in [0,T)$。终端条件为 $V(S,T) = \\max(S-K,0)$。在一个截断的空间域 $S \\in [0,S_{\\max}]$（其中 $S_{\\max} \\gg K$）上，施加边界条件 $V(0,t) = 0$ 和 $V(S_{\\max},t) \\approx S_{\\max} - K e^{-r (T-t)}$，其中 $t \\in [0,T]$。\n\n您的任务是编写一个完整且可运行的程序，该程序从基本无套利原理和 Black-Scholes-Merton 偏微分方程出发，在均匀时空网格上计算数值解，并通过使用非常大的时间步长来凭经验证明其无条件稳定性。该程序必须：\n\n- 在域 $S \\in [0,S_{\\max}]$ 和 $\\tau \\in [0,T]$ 上，构建一个在时间和空间上均为二阶精度的、相容的有限差分近似，其中 $\\tau = T - t$ 是距到期日时间变量。在 $\\tau = 0$ 时的初始条件是 $V(S,0) = \\max(S-K,0)$。边界条件为 $V(0,\\tau) = 0$ 和 $V(S_{\\max},\\tau) = S_{\\max} - K e^{-r \\tau}$，其中 $\\tau \\in [0,T]$。\n- 通过对网格解 $V(S,\\tau)$ 在 $\\tau = T$ 处进行线性插值，在给定的初始标的资产价值 $S_0$ 下为欧式看涨期权定价。所有利率必须以小数表示，而非百分号。所有价格必须以与 S 和 K 相同的任意货币单位报告。\n- 通过将数值价格与 Black-Scholes-Merton 解析值 $C_{\\text{BSM}}(S_0,K,r,\\sigma,T)$ 进行比较，定量评估数值误差，并以浮点数形式报告绝对误差。\n- 凭经验证明无条件稳定性，方法是固定空间网格，使用非常大的时间步长（非常少的时间层级）运行该格式，并验证在所有时间层级和节点上，数值解都保持在 $0$ 和 $S_{\\max}$ 之间。\n\n使用以下通用参数值：$S_0 = 100$，$K = 100$，$r = 0.05$，$\\sigma = 0.2$，$T = 1$，$S_{\\max} = 500$。使用一个具有 $M$ 个子区间（即 $M+1$ 个空间节点）的均匀空间网格，以及一个在 $\\tau$ 上具有 $N$ 个子区间（即包括 $\\tau=0$ 和 $\\tau=T$ 在内的 $N+1$ 个时间层级）的均匀时间网格。\n\n测试套件。您的程序必须运行以下四个测试用例，并按规定汇总结果：\n- 测试用例 1（理想路径准确性）：$(M,N) = (400,400)$。以浮点数形式输出绝对误差 $|C_{\\text{num}} - C_{\\text{BSM}}|$。\n- 测试用例 2（极大时间步长）：$(M,N) = (400,4)$。以浮点数形式输出绝对误差 $|C_{\\text{num}} - C_{\\text{BSM}}|$。\n- 测试用例 3（更粗糙的时空网格）：$(M,N) = (100,100)$。以浮点数形式输出绝对误差 $|C_{\\text{num}} - C_{\\text{BSM}}|$。\n- 测试用例 4（经验性无条件稳定性检查）：固定 $M = 400$，并使用 $N \\in \\{1,2,4,8,16,32,64\\}$ 运行。设稳定性指标为一个布尔值，当且仅当对于该集合中的每一个 $N$，在每个时间层级和每个空间节点，所有计算值都是有限的，并且在 $[0,S_{\\max}]$ 范围内（容差为 $10^{-8}$）时，该布尔值为真，否则为假。输出此布尔值。\n\n最终输出格式。您的程序应生成一行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，顺序完全如下：测试用例 1 的绝对误差，测试用例 2 的绝对误差，测试用例 3 的绝对误差，以及测试用例 4 的稳定性布尔值。例如，一个语法正确的输出行格式为 $[0.001234,0.056789,0.012345,True]$。", "solution": "问题陈述构成了一个计算金融学中适定的初边值问题。它在科学上以 Black-Scholes-Merton 无套利框架为基础，并为数值求解提供了一套完整且一致的参数、初始条件和边界条件。因此，该问题是有效的，我们着手构建所需的数值方法和程序。\n\n基本方程是欧式期权价值 $V(S,t)$ 的 Black-Scholes-Merton 偏微分方程（PDE）：\n$$\n\\frac{\\partial V}{\\partial t} + \\frac{1}{2}\\sigma^2 S^2 \\frac{\\partial^2 V}{\\partial S^2} + r S \\frac{\\partial V}{\\partial S} - r V = 0\n$$\n这是一个终值问题，其在时间 $t=T$ 的终端条件由期权的收益函数给出，$V(S,T) = \\max(S-K, 0)$。为了将其转换为一个标准的初值问题，我们引入距到期日时间变量 $\\tau = T - t$。导数转换为 $\\frac{\\partial}{\\partial t} = \\frac{\\partial \\tau}{\\partial t} \\frac{\\partial}{\\partial \\tau} = - \\frac{\\partial}{\\partial \\tau}$。将其代入 PDE 可得：\n$$\n\\frac{\\partial V}{\\partial \\tau} = \\frac{1}{2}\\sigma^2 S^2 \\frac{\\partial^2 V}{\\partial S^2} + r S \\frac{\\partial V}{\\partial S} - r V\n$$\n这是一个关于 $\\tau$ 的前向扩散-对流-反应方程，我们必须求解从 $\\tau=0$ 到 $\\tau=T$。在 $\\tau=0$ 时的初始条件是 $V(S,0) = \\max(S-K,0)$。\n\n该问题要求一种在时间和空间上均为二阶精度且无条件稳定的数值格式。Crank-Nicolson 有限差分法具备这些性质。我们在均匀网格上离散化域 $(S, \\tau) \\in [0, S_{\\max}] \\times [0, T]$。设 $S_j = j \\Delta S$，$j=0, 1, \\dots, M$，其中 $\\Delta S = S_{\\max}/M$。设 $\\tau_i = i \\Delta \\tau$，$i=0, 1, \\dots, N$，其中 $\\Delta \\tau = T/N$。设 $V_j^i$ 是 $V(S_j, \\tau_i)$ 的数值近似。\n\n我们使用二阶中心差分来近似空间导数：\n$$\n\\frac{\\partial V}{\\partial S} \\bigg|_{S_j,\\tau_i} \\approx \\frac{V_{j+1}^i - V_{j-1}^i}{2 \\Delta S}\n$$\n$$\n\\frac{\\partial^2 V}{\\partial S^2} \\bigg|_{S_j,\\tau_i} \\approx \\frac{V_{j+1}^i - 2V_j^i + V_{j-1}^i}{(\\Delta S)^2}\n$$\n设 $\\mathcal{L}$ 是变换后 PDE 右侧的空间微分算子。Crank-Nicolson 格式将 PDE 近似为：\n$$\n\\frac{V_j^{i+1} - V_j^i}{\\Delta \\tau} = \\frac{1}{2} \\left[ (\\mathcal{L} V^i)_j + (\\mathcal{L} V^{i+1})_j \\right]\n$$\n整理各项，将时间层级 $i+1$ 的未知数与层级 $i$ 的已知数分开：\n$$\n\\left(I - \\frac{\\Delta \\tau}{2} \\mathcal{L}_d\\right) V^{i+1} = \\left(I + \\frac{\\Delta \\tau}{2} \\mathcal{L}_d\\right) V^i\n$$\n其中 $\\mathcal{L}_d$ 是离散化的空间算子。这个方程代表了在内部空间节点 $j=1, \\dots, M-1$ 处关于期权价值向量 $V^{i+1}$ 的一个线性方程组。该系统是三对角的。对于内部节点 $j$ 的一般方程是：\n$$\nl_j V_{j-1}^{i+1} + d_j V_j^{i+1} + u_j V_{j+1}^{i+1} = l'_j V_{j-1}^i + d'_j V_j^i + u'_j V_{j+1}^i\n$$\n其中的系数是通过将有限差分近似代入算子 $\\mathcal{L}$ 得出的。对于 $S_j=j\\Delta S$，它们简化为：\n$$\nl_j = -\\frac{\\Delta \\tau}{4}(\\sigma^2 j^2 - rj)\n$$\n$$\nd_j = 1 + \\frac{\\Delta \\tau}{2}(\\sigma^2 j^2 + r)\n$$\n$$\nu_j = -\\frac{\\Delta \\tau}{4}(\\sigma^2 j^2 + rj)\n$$\n右侧的系数为 $l'_j = -l_j$，$d'_j = 2 - d_j$ 和 $u'_j = -u_j$。\n\n在每个时间步 $i \\to i+1$，我们求解三对角系统 $A V^{i+1} = \\mathbf{b}$，其中 $A$ 是对角线为 $(l_j, d_j, u_j)$ 的矩阵，而 $\\mathbf{b}$ 是由右侧计算出的向量。\n必须并入边界条件。\n条件 $V(0, \\tau) = 0$ 意味着对于所有 $i$，$V_0^i = 0$。这意味着系统中的第一个方程（对于 $j=1$）不涉及未知的边界项。\n条件 $V(S_{\\max}, \\tau) = S_{\\max} - Ke^{-r\\tau}$ 在每个时间步为 $V_M^i$ 提供了已知值。来自系统最后一个方程（对于 $j=M-1$）的项 $u_{M-1} V_M^{i+1}$ 是已知的，并被移到右侧。因此，在求解系统之前，右侧向量 $\\mathbf{b}$ 会相应地被修改。\n\n步骤如下：\n1. 用 $V_j^0 = \\max(j\\Delta S - K, 0)$ 初始化在 $\\tau=0$ 的网格解。\n2. 对于从 $0$ 到 $N-1$ 的每个时间步 $i$：\n    a. 使用来自 $V^i$ 的值构造右侧向量 $\\mathbf{b}$。\n    b. 调整 $\\mathbf{b}$ 的最后一个元素以考虑在 $S_{\\max}$ 处的边界条件。\n    c. 求解三对角系统 $A V_{\\text{interior}}^{i+1} = \\mathbf{b}$ 以得到内部节点值 $V_1^{i+1}, \\dots, V_{M-1}^{i+1}$。使用带状矩阵求解器对此很有效。\n    d. 用计算出的内部值和 $\\tau_{i+1}$ 的边界值更新完整解向量 $V^{i+1}$。\n3. 完成所有时间步后，向量 $V^N$ 包含在 $\\tau=T$（即时间 $t=0$）的期权价格。\n4. 在指定的初始股票价格 $S_0$ 处对 $V^N$ 中的值进行线性插值，以获得最终的数值价格 $C_{\\text{num}}$。\n5. 计算绝对误差 $|C_{\\text{num}} - C_{\\text{BSM}}|$，其中 $C_{\\text{BSM}}$ 是来自 Black-Scholes-Merton 公式的解析价格：\n$$C(S, K, r, \\sigma, T) = S_0 N(d_1) - K e^{-rT} N(d_2)$$\n$$d_1 = \\frac{\\ln(S_0/K) + (r + \\frac{1}{2}\\sigma^2)T}{\\sigma\\sqrt{T}}, \\quad d_2 = d_1 - \\sigma\\sqrt{T}$$\n其中 $N(\\cdot)$ 是标准正态分布的累积分布函数。\n6. 对于稳定性测试，检查所有节点和时间步的 $V_j^i$ 值，以确保它们保持有限并且在无套利边界 $[0, S_{\\max}]$ 内。Crank-Nicolson 格式的无条件稳定性确保了即使对于大的 $\\Delta \\tau$（小的 $N$），这一点也成立。\n\n这个系统性步骤在提供的程序中实现，以解决给定的测试用例。", "answer": "```python\nimport numpy as np\nfrom scipy.stats import norm\nfrom scipy.linalg import solve_banded\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the final result.\n    \"\"\"\n    # Common parameters as specified in the problem\n    S0 = 100.0\n    K = 100.0\n    r = 0.05\n    SIGMA = 0.2\n    T = 1.0\n    S_MAX = 500.0\n\n    def bsm_analytical_price(s, k, rate, sigma, time):\n        \"\"\"Calculates the analytical Black-Scholes-Merton price for a European call.\"\"\"\n        if time == 0:\n            return np.maximum(s - k, 0)\n        d1 = (np.log(s / k) + (rate + 0.5 * sigma**2) * time) / (sigma * np.sqrt(time))\n        d2 = d1 - sigma * np.sqrt(time)\n        price = s * norm.cdf(d1) - k * np.exp(-rate * time) * norm.cdf(d2)\n        return price\n\n    def solve_crank_nicolson(s0, k, rate, sigma, time, s_max, M, N, stability_check=False, tol=1e-8):\n        \"\"\"\n        Solves the Black-Scholes PDE using the Crank-Nicolson finite difference method.\n\n        If stability_check is True, it returns a boolean indicating if the solution\n        remained within bounds [0, s_max] throughout the simulation. Otherwise, it\n        returns the interpolated option price at s0.\n        \"\"\"\n        # Grid setup\n        dS = s_max / M\n        dTau = time / N\n        S_grid = np.linspace(0, s_max, M + 1)\n\n        # Initial condition at tau=0 (which is maturity t=T)\n        V = np.maximum(S_grid - k, 0)\n        \n        if stability_check:\n            if not (np.all(np.isfinite(V)) and np.all((V >= -tol)  (V = s_max + tol))):\n                return False\n\n        # Coefficients for the tridiagonal system. These are time-independent.\n        j = np.arange(1, M, dtype=np.float64)  # Interior nodes j = 1, ..., M-1\n        \n        # Coefficients for LHS matrix A in A * V_new = b\n        l_j = -0.25 * dTau * (sigma**2 * j**2 - rate * j)\n        d_j = 1.0 + 0.5 * dTau * (sigma**2 * j**2 + rate)\n        u_j = -0.25 * dTau * (sigma**2 * j**2 + rate * j)\n        \n        # LHS matrix A, in banded form for scipy.linalg.solve_banded\n        A = np.zeros((3, M - 1))\n        A[0, 1:] = u_j[:-1]   # Upper diagonal\n        A[1, :] = d_j         # Main diagonal\n        A[2, :-1] = l_j[1:]   # Lower diagonal\n        \n        # Coefficients for RHS matrix B where b = B * V_old\n        l_prime_j = -l_j\n        d_prime_j = 2.0 - d_j\n        u_prime_j = -u_j\n        \n        # Time-stepping loop from tau=0 to tau=T\n        for i in range(N):\n            tau_i_plus_1 = (i + 1) * dTau\n            \n            # Construct RHS vector b = B * V_old\n            rhs_vector = (l_prime_j * V[:-2] + \n                          d_prime_j * V[1:-1] +\n                          u_prime_j * V[2:])\n\n            # Boundary condition adjustments for the RHS vector b\n            bc_upper_i_plus_1 = s_max - k * np.exp(-rate * tau_i_plus_1)\n            rhs_vector[-1] -= u_j[-1] * bc_upper_i_plus_1\n            \n            # Solve the linear system A * V_new = b for interior nodes\n            V_interior_new = solve_banded((1, 1), A, rhs_vector)\n            \n            # Update full solution vector V for the next time step\n            V[1:-1] = V_interior_new\n            V[0] = 0.0  # Lower boundary V(0, t)=0\n            V[-1] = bc_upper_i_plus_1\n            \n            if stability_check:\n                if not (np.all(np.isfinite(V)) and np.all((V >= -tol)  (V = s_max + tol))):\n                    return False\n                    \n        if stability_check:\n            return True\n\n        # Interpolate to find price at S0 after all time steps\n        numerical_price = np.interp(s0, S_grid, V)\n        return numerical_price\n\n    results = []\n    \n    # Calculate the analytical price once for all comparisons\n    analytical_price = bsm_analytical_price(S0, K, r, SIGMA, T)\n\n    # Test Case 1: (M,N) = (400,400)\n    M1, N1 = 400, 400\n    num_price1 = solve_crank_nicolson(S0, K, r, SIGMA, T, S_MAX, M1, N1)\n    results.append(abs(num_price1 - analytical_price))\n\n    # Test Case 2: (M,N) = (400,4)\n    M2, N2 = 400, 4\n    num_price2 = solve_crank_nicolson(S0, K, r, SIGMA, T, S_MAX, M2, N2)\n    results.append(abs(num_price2 - analytical_price))\n\n    # Test Case 3: (M,N) = (100,100)\n    M3, N3 = 100, 100\n    num_price3 = solve_crank_nicolson(S0, K, r, SIGMA, T, S_MAX, M3, N3)\n    results.append(abs(num_price3 - analytical_price))\n\n    # Test Case 4: Stability Check\n    M4 = 400\n    N_values = [1, 2, 4, 8, 16, 32, 64]\n    overall_stability = True\n    for N_val in N_values:\n        is_stable = solve_crank_nicolson(S0, K, r, SIGMA, T, S_MAX, M4, N_val, stability_check=True)\n        if not is_stable:\n            overall_stability = False\n            break\n    results.append(overall_stability)\n\n    # Print results in the required format\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "2387926"}, {"introduction": "我们不应将Black-Scholes-Merton公式视为一个僵化的整体，而应看作一个由多个有价值的模块构成的工具箱。本练习要求你通过重新组合BSM公式的部件——特别是标准看涨期权价格和风险中性世界中到期时处于价内的概率$N(d_2)$——来为一种新颖的“或有保费”期权定价。这项实践将加深你对风险中性定价这一强大理念以及公式中各项金融含义的理解。[@problem_id:2420974]", "problem": "考虑在 Black–Scholes–Merton (BSM) 框架下，一份针对支付股息股票的欧式看涨期权。在风险中性测度下，股价过程遵循具有恒定参数的几何布朗运动：现货价格为 $S_0$，波动率为 $\\sigma$，连续复利无风险利率为 $r$，连续股息率为 $q$。该看涨期权的执行价格为 $K$，到期日为 $T$。要求您为一份“或有保费期权”（Contingent Premium Option）定价，其定义如下：买方在期初不支付任何期权费；而是在到期日 $T$，仅当期权为价内时，买方才支付一笔金额为 $p$ 的期权费。如果期权到期时为价外，则买方无需支付任何费用。因此，在到期日 $T$，买方的期权收益为 $(S_T - K)^{+} - p \\,\\mathbf{1}_{\\{S_T  K\\}}$，其中 $\\mathbf{1}_{\\{\\cdot\\}}$ 是指示函数。\n\n使用无套利和风险中性定价原理，推导出使得买方现金流在0时刻的价值为零的公平期权费 $p$。然后，根据以下参数数值计算 $p$：\n- $S_0 = 100$，\n- $K = 105$，\n- $r = 0.05$ (连续复利，年化)，\n- $q = 0.02$ (年化)，\n- $\\sigma = 0.20$ (年化)，\n- $T = 1$ (年)。\n\n假设标准正态分布的累积分布函数用 $N(\\cdot)$ 表示。以美元为单位表示您对 $p$ 的最终数值答案，并四舍五入到四位有效数字。", "solution": "所述问题具有科学依据、提法明确、客观，并包含得出唯一解所需的所有信息。这是计算金融领域的一个标准问题，具体涉及奇异期权的定价。因此，我将进行推导和计算。\n\n该问题要求解“或有保费期权”的公平期权费 $p$。该合约的定义特征是其在初始时刻（$t=0$ 时）的净值为零。买方的总现金流发生在到期日 $T$，由收益函数 $V_T = (S_T - K)^{+} - p \\cdot \\mathbf{1}_{\\{S_T  K\\}}$ 给出，其中 $S_T$ 是在时刻 $T$ 的股票价格，$K$ 是执行价格，$\\mathbf{1}_{\\{\\cdot\\}}$ 是指示函数。$(S_T - K)^{+}$ 项代表标准欧式看涨期权的收益，而 $p \\cdot \\mathbf{1}_{\\{S_T  K\\}}$ 是当且仅当期权到期为价内（$S_T  K$）时，买方支付给卖方的或有保费。\n\n根据无套利原理，该合约在时刻 $t=0$ 的价值（记为 $V_0$）必须是其未来现金流以无风险利率 $r$ 贴现后的风险中性期望值。问题规定该初始价值为零。\n$$V_0 = \\mathbb{E}^{\\mathbb{Q}}\\left[\\exp(-rT) V_T\\right] = 0$$\n其中 $\\mathbb{E}^{\\mathbb{Q}}[\\cdot]$ 是在风险中性测度下所取的期望。\n\n代入收益 $V_T$：\n$$\\mathbb{E}^{\\mathbb{Q}}\\left[\\exp(-rT) \\left( (S_T - K)^{+} - p \\cdot \\mathbf{1}_{\\{S_T  K\\}} \\right) \\right] = 0$$\n根据期望的线性性质，我们可以将各项分开：\n$$\\mathbb{E}^{\\mathbb{Q}}\\left[\\exp(-rT) (S_T - K)^{+}\\right] - \\mathbb{E}^{\\mathbb{Q}}\\left[\\exp(-rT) p \\cdot \\mathbf{1}_{\\{S_T  K\\}}\\right] = 0$$\n根据定义，第一项是在 Black-Scholes-Merton (BSM) 框架下针对支付股息股票的标准欧式看涨期权的价格，我们将其记为 $C(S_0, K, T, r, q, \\sigma)$。常数期权费 $p$ 可以从第二项的期望中提取出来。\n$$C(S_0, K, T, r, q, \\sigma) - p \\cdot \\mathbb{E}^{\\mathbb{Q}}\\left[\\exp(-rT) \\mathbf{1}_{\\{S_T  K\\}}\\right] = 0$$\n期望 $\\mathbb{E}^{\\mathbb{Q}}\\left[\\exp(-rT) \\mathbf{1}_{\\{S_T  K\\}}\\right]$ 是一种现金或无式看涨期权的价格，该期权在到期日 $T$ 当 $S_T  K$ 时支付1美元。其价值为 $\\exp(-rT) \\mathbb{Q}(S_T  K)$，其中 $\\mathbb{Q}(S_T  K)$ 是期权到期为价内的风险中性概率。\n\n在 BSM 模型中，此概率由 $N(d_2)$ 给出，其中 $N(\\cdot)$ 是标准正态分布的累积分布函数，$d_2$ 定义为：\n$$d_2 = \\frac{\\ln(S_0/K) + (r - q - \\sigma^2/2)T}{\\sigma\\sqrt{T}}$$\n因此，关于 $p$ 的方程变为：\n$$C(S_0, K, T, r, q, \\sigma) = p \\cdot \\exp(-rT) N(d_2)$$\n解出 $p$：\n$$p = \\frac{C(S_0, K, T, r, q, \\sigma)}{\\exp(-rT) N(d_2)}$$\n对于具有连续股息率 $q$ 的股票，欧式看涨期权价格的 BSM 公式为：\n$$C(S_0, K, T, r, q, \\sigma) = S_0 \\exp(-qT) N(d_1) - K \\exp(-rT) N(d_2)$$\n其中\n$$d_1 = \\frac{\\ln(S_0/K) + (r - q + \\sigma^2/2)T}{\\sigma\\sqrt{T}} = d_2 + \\sigma\\sqrt{T}$$\n将 $C$ 的表达式代入 $p$ 的方程中：\n$$p = \\frac{S_0 \\exp(-qT) N(d_1) - K \\exp(-rT) N(d_2)}{\\exp(-rT) N(d_2)}$$\n$$p = \\frac{S_0 \\exp(-qT) N(d_1)}{\\exp(-rT) N(d_2)} - K$$\n$$p = S_0 \\exp((r-q)T) \\frac{N(d_1)}{N(d_2)} - K$$\n该表达式给出了或有保费 $p$ 的公允价值。另一种解释是 $p = \\mathbb{E}^{\\mathbb{Q}}[S_T - K | S_T  K]$，这是看涨期权在价内到期条件下的收益期望值。\n\n现在我们根据给定的数值参数计算 $p$：\n$S_0 = 100$, $K = 105$, $r = 0.05$, $q = 0.02$, $\\sigma = 0.20$, $T = 1$。\n\n首先，我们计算 $d_1$ 和 $d_2$：\n$$d_1 = \\frac{\\ln(100/105) + (0.05 - 0.02 + 0.20^2/2) \\cdot 1}{0.20 \\cdot \\sqrt{1}}$$\n$$d_1 = \\frac{\\ln(100/105) + (0.03 + 0.04/2)}{0.20} = \\frac{\\ln(100/105) + 0.05}{0.20}$$\n$$d_1 \\approx \\frac{-0.04879016 + 0.05}{0.20} = \\frac{0.00120984}{0.20} \\approx 0.0060492$$\n$$d_2 = d_1 - \\sigma\\sqrt{T} \\approx 0.0060492 - 0.20 \\cdot 1 = -0.1939508$$\n接下来，我们计算标准正态累积分布函数的值：\n$$N(d_1) \\approx N(0.0060492) \\approx 0.5024128$$\n$$N(d_2) \\approx N(-0.1939508) \\approx 0.4231365$$\n现在，我们可以计算 $p$：\n$$p = S_0 \\exp((r-q)T) \\frac{N(d_1)}{N(d_2)} - K$$\n$$p = 100 \\cdot \\exp((0.05-0.02) \\cdot 1) \\cdot \\frac{0.5024128}{0.4231365} - 105$$\n$$p = 100 \\cdot \\exp(0.03) \\cdot (1.187342) - 105$$\n$$p \\approx 100 \\cdot (1.0304545) \\cdot (1.187342) - 105$$\n$$p \\approx 103.04545 \\cdot 1.187342 - 105$$\n$$p \\approx 122.3483 - 105 = 17.3483$$\n四舍五入到四位有效数字，我们得到 $p = 17.35$。", "answer": "$$\\boxed{17.35}$$", "id": "2420974"}]}