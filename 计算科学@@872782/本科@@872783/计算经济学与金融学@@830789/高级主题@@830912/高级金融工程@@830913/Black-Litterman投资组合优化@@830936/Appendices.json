{"hands_on_practices": [{"introduction": "理解一个模型的最好方法就是亲手构建它。第一个练习将指导您实现Black-Litterman模型的核心部分。您将把市场均衡回报（先验信念）与投资者的观点（新信息）相结合，计算出一套全新的、融合的预期回报，并据此得出最优的投资组合权重。这个练习可以巩固您对模型机制和数学结构的理解，您将处理不同的场景，包括一个关键的“无观点”情况，这是对您实现方案的一个重要健全性检查。[@problem_id:2376247]", "problem": "您的任务是实现 Black–Litterman 投资组合模型，作为一个完全指定的计算程序。该模型将先验的市场隐含多元正态收益分布与线性的高斯投资者观点相结合，生成后验收益分布，然后使用相同的协方差矩阵和给定的风险厌恶参数计算无约束的均值-方差最优权重。\n\n假设有 $n$ 种风险资产，其超额收益由随机向量 $\\mathbf{r} \\in \\mathbb{R}^n$ 表示。假设使用以下建模框架：\n\n1. 先验（市场隐含）信念：$\\mathbf{r}$ 被建模为均值为 $\\boldsymbol{\\mu}_0 \\in \\mathbb{R}^n$ 且协方差为 $\\tau \\boldsymbol{\\Sigma} \\in \\mathbb{R}^{n \\times n}$ 的多元正态分布，其中 $\\tau \\in \\mathbb{R}_{>0}$ 是一个表示先验不确定性缩放的标量，$\\boldsymbol{\\Sigma} \\in \\mathbb{R}^{n \\times n}$ 是一个资产收益的正定协方差矩阵。先验均值由市值权重 $\\mathbf{w}_m \\in \\mathbb{R}^n$ 和风险厌恶参数 $\\lambda \\in \\mathbb{R}_{>0}$ 通过 $\\boldsymbol{\\mu}_0 = \\lambda \\boldsymbol{\\Sigma} \\mathbf{w}_m$ 隐含得出。\n\n2. 线性高斯观点：存在 $k$ 个线性观点，由 $\\mathbf{P} \\in \\mathbb{R}^{k \\times n}$ 和 $\\mathbf{Q} \\in \\mathbb{R}^k$ 表示，观点噪声协方差为 $\\boldsymbol{\\Omega} \\in \\mathbb{R}^{k \\times k}$（正定）。观察到的观点被建模为 $\\mathbf{P} \\mathbf{r}$ 是对 $\\mathbf{Q}$ 的一个带噪观测，其高斯噪声的协方差为 $\\boldsymbol{\\Omega}$。\n\n3. 后验信念：基于这些假设，计算观察到观点后 $\\mathbf{r}$ 的后验均值，记为 $\\boldsymbol{\\mu}_{\\text{BL}} \\in \\mathbb{R}^n$。\n\n4. 无约束最优权重：使用相同的协方差矩阵 $\\boldsymbol{\\Sigma}$ 和风险厌恶参数 $\\lambda$，基于 $\\boldsymbol{\\mu}_{\\text{BL}}$ 计算无约束的均值-方差最优权重 $\\mathbf{w}_{\\text{BL}} \\in \\mathbb{R}^n$。权重必须以小数表示（而非百分比）。\n\n您必须编写一个程序，为下面的每个测试案例计算并输出向量 $\\mathbf{w}_{\\text{BL}}$。\n\n需使用的定义和假设如下：\n- 先验均值为 $\\boldsymbol{\\mu}_0 = \\lambda \\boldsymbol{\\Sigma} \\mathbf{w}_m$。\n- $\\mathbf{r}$ 的先验协方差为 $\\tau \\boldsymbol{\\Sigma}$。\n- 投资者观点是如上所述带有高斯噪声的线性观点。\n- 无约束的均值-方差最优权重是根据后验均值和在给定风险厌恶参数下的协方差矩阵获得的。\n- 所有计算均在一致的无量纲单位中进行；所有输出必须是小数。\n\n测试套件（三个案例）：\n\n案例A（一般信息性观点）：\n- 资产数量：$n = 3$。\n- 协方差矩阵：\n$$\n\\boldsymbol{\\Sigma}_A =\n\\begin{bmatrix}\n0.04  0.006  0.004 \\\\\n0.006  0.09  0.002 \\\\\n0.004  0.002  0.0225\n\\end{bmatrix}.\n$$\n- 市值权重：\n$$\n\\mathbf{w}_{m,A} = \\begin{bmatrix} 0.6 \\\\ 0.3 \\\\ 0.1 \\end{bmatrix}.\n$$\n- 风险厌恶：$\\lambda_A = 2.5$。\n- 先验不确定性缩放：$\\tau_A = 0.05$。\n- 观点：\n$$\n\\mathbf{P}_A =\n\\begin{bmatrix}\n1  -1  0 \\\\\n0  1  -1\n\\end{bmatrix}, \\quad\n\\mathbf{Q}_A = \\begin{bmatrix} 0.02 \\\\ 0.01 \\end{bmatrix}, \\quad\n\\boldsymbol{\\Omega}_A = \\begin{bmatrix} 0.0004  0 \\\\ 0  0.0009 \\end{bmatrix}.\n$$\n\n案例B（无观点边缘案例）：\n- 资产数量：$n = 3$。\n- 协方差矩阵：\n$$\n\\boldsymbol{\\Sigma}_B =\n\\begin{bmatrix}\n0.04  0.006  0.004 \\\\\n0.006  0.09  0.002 \\\\\n0.004  0.002  0.0225\n\\end{bmatrix}.\n$$\n- 市值权重：\n$$\n\\mathbf{w}_{m,B} = \\begin{bmatrix} 0.6 \\\\ 0.3 \\\\ 0.1 \\end{bmatrix}.\n$$\n- 风险厌恶：$\\lambda_B = 2.5$。\n- 先验不确定性缩放：$\\tau_B = 0.05$。\n- 观点：$k = 0$（无观点），由空矩阵 $\\mathbf{P}_B \\in \\mathbb{R}^{0 \\times 3}$、空向量 $\\mathbf{Q}_B \\in \\mathbb{R}^{0}$ 和空的 $\\boldsymbol{\\Omega}_B \\in \\mathbb{R}^{0 \\times 0}$ 表示。\n\n案例C（高置信度单一相对观点）：\n- 资产数量：$n = 3$。\n- 协方差矩阵：\n$$\n\\boldsymbol{\\Sigma}_C =\n\\begin{bmatrix}\n0.05  0.01  0.0 \\\\\n0.01  0.07  0.005 \\\\\n0.0  0.005  0.03\n\\end{bmatrix}.\n$$\n- 市值权重：\n$$\n\\mathbf{w}_{m,C} = \\begin{bmatrix} 0.4 \\\\ 0.4 \\\\ 0.2 \\end{bmatrix}.\n$$\n- 风险厌恶：$\\lambda_C = 3.0$。\n- 先验不确定性缩放：$\\tau_C = 0.1$。\n- 观点：\n$$\n\\mathbf{P}_C = \\begin{bmatrix} 1  0  -1 \\end{bmatrix}, \\quad\n\\mathbf{Q}_C = \\begin{bmatrix} 0.05 \\end{bmatrix}, \\quad\n\\boldsymbol{\\Omega}_C = \\begin{bmatrix} 10^{-6} \\end{bmatrix}.\n$$\n\n要求的最终输出格式：\n- 您的程序必须按 A、B、C 的顺序处理这三个案例，并输出一行，其中包含一个由三个列表组成的列表，每个内部列表包含该案例的 $\\mathbf{w}_{\\text{BL}}$ 的三个分量，四舍五入到六位小数。确切格式为：\"[ [wA1,wA2,wA3], [wB1,wB2,wB3], [wC1,wC2,wC3] ]\"，除所示空格外无其他空格，也无附加文本。\n- 每个权重必须表示为小数，四舍五入到小数点后六位。\n\n您的程序应生成单行输出，其中包含一个以方括号括起来的、逗号分隔的列表的列表形式的结果，与上述描述完全一致。", "solution": "Black–Litterman 模型将预期的资产收益的先验分布与投资者指定的观点相结合，以产生收益的后验分布。任务是基于这个后验均值计算无约束的均值-方差最优投资组合权重。\n\n该模型由两个高斯信息源定义：\n1. 先验信念，源自市场均衡，指出收益向量 $\\mathbf{r}$ 服从分布 $\\mathbf{r} \\sim \\mathcal{N}(\\boldsymbol{\\mu}_0, \\tau \\boldsymbol{\\Sigma})$，其中先验均值为 $\\boldsymbol{\\mu}_0 = \\lambda \\boldsymbol{\\Sigma} \\mathbf{w}_m$。\n2. 投资者观点提供额外信息。问题陈述 $\\mathbf{P}\\mathbf{r}$ 是对 $\\mathbf{Q}$ 的带噪观测。这被建模为一个线性高斯约束：$\\mathbf{P}\\mathbf{r} \\sim \\mathcal{N}(\\mathbf{Q}, \\boldsymbol{\\Omega})$。\n\n结合这两个高斯信息源是一个标准的贝叶斯推断问题。$\\mathbf{r}$ 的后验分布也是高斯分布。我们关心的是其均值 $\\boldsymbol{\\mu}_{\\text{BL}}$。一个数值稳定且简洁的求后验分布的方法是将先验的精度矩阵（协方差矩阵的逆）与来自观点的似然项结合起来。\n\n先验的精度矩阵为 $(\\tau\\boldsymbol{\\Sigma})^{-1} = \\frac{1}{\\tau}\\boldsymbol{\\Sigma}^{-1}$。\n观点方程 $\\mathbf{P}\\mathbf{r} \\sim \\mathcal{N}(\\mathbf{Q}, \\boldsymbol{\\Omega})$可以重写为 $\\mathbf{Q} = \\mathbf{P}\\mathbf{r} + \\boldsymbol{\\epsilon}$，其中 $\\boldsymbol{\\epsilon} \\sim \\mathcal{N}(\\mathbf{0}, \\boldsymbol{\\Omega})$。给定观点下 $\\mathbf{r}$ 的对数似然与 $-(\\mathbf{P}\\mathbf{r} - \\mathbf{Q})^T \\boldsymbol{\\Omega}^{-1} (\\mathbf{P}\\mathbf{r} - \\mathbf{Q})$ 成正比。这对应于将一个精度项 $\\mathbf{P}^T \\boldsymbol{\\Omega}^{-1} \\mathbf{P}$ 加到先验精度上。\n\n后验精度矩阵是先验精度矩阵和观点隐含精度矩阵之和：\n$$\n\\mathbf{\\Sigma}_{\\text{BL}}^{-1} = (\\tau\\boldsymbol{\\Sigma})^{-1} + \\mathbf{P}^T\\boldsymbol{\\Omega}^{-1}\\mathbf{P}\n$$\n后验均值 $\\boldsymbol{\\mu}_{\\text{BL}}$ 则是先验均值和观点隐含均值的精度加权平均：\n$$\n\\boldsymbol{\\mu}_{\\text{BL}} = \\mathbf{\\Sigma}_{\\text{BL}} \\left( (\\tau\\boldsymbol{\\Sigma})^{-1}\\boldsymbol{\\mu}_0 + \\mathbf{P}^T\\boldsymbol{\\Omega}^{-1}\\mathbf{Q} \\right)\n$$\n代入后验精度矩阵，得到后验均值的完整表达式：\n$$\n\\boldsymbol{\\mu}_{\\text{BL}} = \\left( (\\tau\\boldsymbol{\\Sigma})^{-1} + \\mathbf{P}^T\\boldsymbol{\\Omega}^{-1}\\mathbf{P} \\right)^{-1} \\left( (\\tau\\boldsymbol{\\Sigma})^{-1}\\boldsymbol{\\mu}_0 + \\mathbf{P}^T\\boldsymbol{\\Omega}^{-1}\\mathbf{Q} \\right)\n$$\n\n计算步骤如下：\n\n1. 计算先验均值向量 $\\boldsymbol{\\mu}_0$：\n    $$\n    \\boldsymbol{\\mu}_0 = \\lambda \\boldsymbol{\\Sigma} \\mathbf{w}_m\n    $$\n\n2. 处理无观点（$k=0$）的边缘情况。在这种情况下，$\\mathbf{P}$、$\\mathbf{Q}$ 和 $\\boldsymbol{\\Omega}$ 为空。涉及这些矩阵的项为零，因此后验精度等于先验精度，后验均值等于先验均值：\n    $$\n    \\boldsymbol{\\mu}_{\\text{BL}} = \\boldsymbol{\\mu}_0 \\quad (\\text{if } k=0)\n    $$\n\n3. 对于一般情况（$k > 0$），计算后验均值 $\\boldsymbol{\\mu}_{\\text{BL}}$：\n    a. 计算矩阵的逆：$\\boldsymbol{\\Sigma}^{-1}$ 和 $\\boldsymbol{\\Omega}^{-1}$。这是可行的，因为两个矩阵都给定为正定矩阵。\n    b. 计算后验精度矩阵：$\\mathbf{M}_{\\text{post}} = \\frac{1}{\\tau}\\boldsymbol{\\Sigma}^{-1} + \\mathbf{P}^T\\boldsymbol{\\Omega}^{-1}\\mathbf{P}$。\n    c. 计算加权均值项：$\\mathbf{v}_{\\text{post}} = \\frac{1}{\\tau}\\boldsymbol{\\Sigma}^{-1}\\boldsymbol{\\mu}_0 + \\mathbf{P}^T\\boldsymbol{\\Omega}^{-1}\\mathbf{Q}$。\n    d. 计算后验均值：$\\boldsymbol{\\mu}_{\\text{BL}} = \\mathbf{M}_{\\text{post}}^{-1} \\mathbf{v}_{\\text{post}}$。\n\n4. 计算无约束的均值-方差最优权重 $\\mathbf{w}_{\\text{BL}}$。问题明确指出要使用原始协方差矩阵 $\\boldsymbol{\\Sigma}$ 和风险厌恶参数 $\\lambda$。无约束优化的标准公式是：\n    $$\n    \\mathbf{w}_{\\text{BL}} = \\frac{1}{\\lambda} \\boldsymbol{\\Sigma}^{-1} \\boldsymbol{\\mu}_{\\text{BL}}\n    $$\n    对于无观点的情况（$k=0$），这简化为 $\\mathbf{w}_{\\text{BL}} = \\frac{1}{\\lambda}\\boldsymbol{\\Sigma}^{-1}\\boldsymbol{\\mu}_0 = \\frac{1}{\\lambda}\\boldsymbol{\\Sigma}^{-1}(\\lambda\\boldsymbol{\\Sigma}\\mathbf{w}_m) = \\mathbf{w}_m$。得到的投资组合就是市场投资组合，这是正确且预期的结果。", "answer": "```python\nimport numpy as np\n\ndef calculate_bl_weights(Sigma, w_m, lam, tau, P, Q, Omega):\n    \"\"\"\n    Computes the Black-Litterman optimal portfolio weights.\n\n    Args:\n        Sigma (np.ndarray): n x n covariance matrix of asset returns.\n        w_m (np.ndarray): n x 1 vector of market capitalization weights.\n        lam (float): Risk aversion parameter.\n        tau (float): Uncertainty scaling of the prior.\n        P (np.ndarray): k x n matrix for linear views.\n        Q (np.ndarray): k x 1 vector for view outcomes.\n        Omega (np.ndarray): k x k covariance matrix of view noise.\n\n    Returns:\n        np.ndarray: n x 1 vector of unconstrained optimal weights.\n    \"\"\"\n    n, k = Sigma.shape[0], P.shape[0]\n\n    # Step 1: Calculate the prior mean (market-implied returns)\n    mu_0 = lam * Sigma @ w_m\n\n    # Pre-calculate inverse of Sigma as it's used multiple times\n    Sigma_inv = np.linalg.inv(Sigma)\n\n    # Step 2  3: Compute the posterior mean\n    if k == 0:\n        # If there are no views, posterior mean equals prior mean\n        mu_bl = mu_0\n    else:\n        # Invert the view noise covariance matrix\n        Omega_inv = np.linalg.inv(Omega)\n\n        # Posterior precision matrix\n        # M_post = (1/tau) * Sigma_inv + P.T @ Omega_inv @ P\n        # Using np.linalg.multi_dot for potential efficiency and clarity\n        posterior_precision = (1 / tau) * Sigma_inv + np.linalg.multi_dot([P.T, Omega_inv, P])\n\n        # Weighted mean term\n        # v_post = (1/tau) * Sigma_inv @ mu_0 + P.T @ Omega_inv @ Q\n        # Using np.linalg.multi_dot here as well\n        weighted_mean_term = (1 / tau) * (Sigma_inv @ mu_0) + np.linalg.multi_dot([P.T, Omega_inv, Q])\n\n        # Posterior mean\n        mu_bl = np.linalg.inv(posterior_precision) @ weighted_mean_term\n\n    # Step 4: Calculate unconstrained mean-variance optimal weights\n    w_bl = (1 / lam) * (Sigma_inv @ mu_bl)\n\n    return w_bl\n\ndef solve():\n    \"\"\"\n    Defines test cases, computes results, and formats the output.\n    \"\"\"\n    # Case A: General informative views\n    Sigma_A = np.array([\n        [0.04, 0.006, 0.004],\n        [0.006, 0.09, 0.002],\n        [0.004, 0.002, 0.0225]\n    ])\n    w_m_A = np.array([0.6, 0.3, 0.1])\n    lambda_A = 2.5\n    tau_A = 0.05\n    P_A = np.array([\n        [1, -1, 0],\n        [0, 1, -1]\n    ])\n    Q_A = np.array([0.02, 0.01])\n    Omega_A = np.array([\n        [0.0004, 0],\n        [0, 0.0009]\n    ])\n\n    # Case B: No views edge case\n    Sigma_B = np.array([\n        [0.04, 0.006, 0.004],\n        [0.006, 0.09, 0.002],\n        [0.004, 0.002, 0.0225]\n    ])\n    w_m_B = np.array([0.6, 0.3, 0.1])\n    lambda_B = 2.5\n    tau_B = 0.05\n    # k=0 means P has 0 rows, Q and Omega are empty\n    P_B = np.empty((0, 3))\n    Q_B = np.empty((0,))\n    Omega_B = np.empty((0, 0))\n\n    # Case C: High-confidence single relative view\n    Sigma_C = np.array([\n        [0.05, 0.01, 0.0],\n        [0.01, 0.07, 0.005],\n        [0.0, 0.005, 0.03]\n    ])\n    w_m_C = np.array([0.4, 0.4, 0.2])\n    lambda_C = 3.0\n    tau_C = 0.1\n    P_C = np.array([[1, 0, -1]])\n    Q_C = np.array([0.05])\n    Omega_C = np.array([[1e-6]])\n\n    test_cases = [\n        (Sigma_A, w_m_A, lambda_A, tau_A, P_A, Q_A, Omega_A),\n        (Sigma_B, w_m_B, lambda_B, tau_B, P_B, Q_B, Omega_B),\n        (Sigma_C, w_m_C, lambda_C, tau_C, P_C, Q_C, Omega_C)\n    ]\n\n    results = []\n    for case in test_cases:\n        w_bl = calculate_bl_weights(*case)\n        # Round the numerical values to 6 decimal places\n        w_bl_rounded_list = np.round(w_bl, 6).tolist()\n        results.append(w_bl_rounded_list)\n\n    # Format the final output string exactly as required\n    # str() on a list of lists of floats and removing spaces is robust\n    output_string = str(results).replace(\" \", \"\")\n    print(output_string)\n\nsolve()\n```", "id": "2376247"}, {"introduction": "除了构建投资组合，Black-Litterman模型还是一个强大的分析工具。这个练习将问题反转过来：您不是用观点来寻找投资组合，而是用一个已知的投资组合来反推其背后隐含的观点。通过假定一个给定的投资组合是最优的，您可以反向工程出支持该组合的预期回报，然后利用Black-Litterman框架推断出能够弥合市场均衡与这些组合隐含回报之间差距的具体投资者观点。这种“逆向工程”方法在实践中被广泛用于分析主动型基金经理的隐含预测，对于任何量化分析师来说都是一项宝贵的技能。[@problem_id:2376249]", "problem": "给定一个 Black-Litterman (BL) 投资组合优化的程式化情景，在该情景中，假设基金经理报告的投资组合权重是在某个后验预期超额收益下的精确均值-方差最优解，而该后验预期超额收益是通过将基于市场的先验与线性观点相结合得出的。您的任务是推导出在该 Black-Litterman 模型下能够合理解释所观察到权重的基金经理“隐含观点”向量，并将该推导过程实现为一个完整的、可运行的程序，用以计算一个小测试集中的这些隐含观点。\n\n从以下基础出发：\n- 带无风险资产的均值-方差优化：最优风险投资组合权重 $w$ 最大化 $U(w) = w^{\\top} \\mu - \\frac{\\lambda}{2} w^{\\top} \\Sigma w$，其中 $w$ 是 $n$ 种风险资产的投资组合权重，$\\mu$ 是预期超额收益向量，$\\Sigma$ 是超额收益的对称正定协方差矩阵，$\\lambda > 0$ 是风险规避系数。使用一阶最优性条件来关联 $w$、$\\mu$、$\\Sigma$ 和 $\\lambda$。\n- 市场均衡先验：假设市值加权投资组合 $w^{\\text{mkt}}$ 是在给定相同的 $\\Sigma$ 和 $\\lambda$ 的情况下，对于先验预期超额收益 $\\pi$ 的均值-方差最优风险投资组合。\n- Black-Litterman (BL) 线性高斯观点结构：先验 $r \\sim \\mathcal{N}(\\pi, \\tau \\Sigma)$，其中 $\\tau > 0$ 是一个标量；观点 $P r \\sim \\mathcal{N}(Q, \\Omega)$，其中 $P$ 是 $k \\times n$ 的观点矩阵， $Q$ 是待确定的 $k \\times 1$ 观点向量，$\\Omega$ 是对称正定的 $k \\times k$ 观点误差协方差。\n\n假设基金经理报告的权重 $w^{\\text{mgr}}$ 相对于 BL 后验超额收益均值是精确的均值-方差最优解。请推导与观察到的 $w^{\\text{mgr}}$ 和指定的模型输入相一致的隐含观点向量 $Q$ 的显式表达式。您的推导必须从上述基本原则出发，不得使用任何假设已知 Black-Litterman 后验封闭式解的快捷公式。\n\n然后，实现一个程序，为下面指定的每个测试用例计算隐含观点 $Q$。所有收益率必须视为超额收益，并以小数（而非百分比）表示。不出现角度，因此不需要角度单位。不出现物理单位。\n\n对于所有测试用例，使用 $n = 3$ 种资产和 $k = 3$ 个绝对观点，其中 $P = I_3$，即 $3 \\times 3$ 的单位矩阵。协方差矩阵 $\\Sigma$ 在所有用例中均相同：\n- $\\Sigma = \\begin{bmatrix}\n0.040  0.018  0.012 \\\\\n0.018  0.035  0.015 \\\\\n0.012  0.015  0.030\n\\end{bmatrix}$\n\n市值权重在所有用例中均相同：\n- $w^{\\text{mkt}} = \\begin{bmatrix} 0.5 \\\\ 0.3 \\\\ 0.2 \\end{bmatrix}$\n\n对于每个用例，给定基金经理观察到的权重 $w^{\\text{mgr}}$、风险规避系数 $\\lambda$、标量 $\\tau$ 以及 $\\Omega$ 的对角线元素。\n\n测试集（三个用例）：\n- 用例 1（一般正常路径）：\n  - $w^{\\text{mgr}} = \\begin{bmatrix} 0.3 \\\\ 0.4 \\\\ 0.3 \\end{bmatrix}$，$\\lambda = 2.5$，$\\tau = 0.05$，$\\Omega = \\operatorname{diag}(0.01, 0.02, 0.03)$。\n- 用例 2（$\\tau$ 值较小的边界情况）：\n  - $w^{\\text{mgr}} = \\begin{bmatrix} 0.6 \\\\ 0.2 \\\\ 0.2 \\end{bmatrix}$，$\\lambda = 2.5$，$\\tau = 0.001$，$\\Omega = \\operatorname{diag}(0.02, 0.02, 0.02)$。\n- 用例 3（$\\Omega$ 值较大的边界情况）：\n  - $w^{\\text{mgr}} = \\begin{bmatrix} 0.2 \\\\ 0.5 \\\\ 0.3 \\end{bmatrix}$，$\\lambda = 2.5$，$\\tau = 0.05$，$\\Omega = \\operatorname{diag}(0.2, 0.15, 0.25)$。\n\n每个用例需要计算的内容：\n1. 使用均值-方差一阶条件，根据 $w^{\\text{mkt}}$、$\\Sigma$ 和 $\\lambda$ 计算均衡先验预期超额收益 $\\pi$。\n2. 使用相同的一阶条件，计算由 $w^{\\text{mgr}}$、$\\Sigma$ 和 $\\lambda$ 隐含的后验最优预期超额收益 $\\mu^{\\star}$。\n3. 使用 $P = I_3$、$\\tau$ 和 $\\Omega$ 的 Black-Litterman 线性高斯框架，推导并计算能够产生后验均值 $\\mu^{\\star}$ 的隐含绝对观点向量 $Q$。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果。\n- 对于每个用例，按顺序输出对应的隐含观点向量 $Q$ 的三个条目；按用例 1、用例 2、用例 3 的顺序连接这三个用例的结果。\n- 在打印前，将每个浮点结果四舍五入到恰好六位小数。\n- 结构示例（非实际值）：[$q_{1,1}$,$q_{1,2}$,$q_{1,3}$,$q_{2,1}$,$q_{2,2}$,$q_{2,3}$,$q_{3,1}$,$q_{3,2}$,$q_{3,3}$]。\n\n您提交的内容必须是一个完整的、可运行的程序，该程序能计算这九个数字，并按照指定的单行格式进行精确舍入和打印。", "solution": "任务是推导能够合理解释观察到的投资组合 $w^{\\text{mgr}}$ 的基金经理隐含观点向量 $Q$。推导将从指定的基础原则出发。\n\n**步骤 1：均值-方差一阶条件的推导**\n\n投资者的优化问题是选择投资组合权重 $w$ 以最大化效用函数 $U(w)$：\n$$ \\max_{w} U(w) = w^{\\top} \\mu - \\frac{\\lambda}{2} w^{\\top} \\Sigma w $$\n在这里，$w$ 是风险资产投资组合权重的 $n \\times 1$ 向量，$\\mu$ 是预期超额收益的 $n \\times 1$ 向量，$\\Sigma$ 是超额收益的 $n \\times n$ 协方差矩阵（对称正定），$\\lambda > 0$ 是风险规避的标量系数。\n\n为了找到最优权重，我们计算 $U(w)$ 关于 $w$ 的梯度并将其设为零。使用标准矩阵微积分，一阶条件（FOC）为：\n$$ \\frac{\\partial U(w)}{\\partial w} = \\mu - \\lambda \\Sigma w = 0 $$\n这就得出了预期超额收益与最优投资组合权重之间的基本关系：\n$$ \\mu = \\lambda \\Sigma w $$\n这个方程允许人们确定使给定投资组合 $w$ 成为最优的预期收益。这通常被称为“逆向优化”。\n\n**步骤 2：隐含先验和后验收益的计算**\n\n该问题假定了此逆向优化原则的两种应用。\n\n首先，市场均衡先验收益（表示为 $\\pi$）是那些使市值投资组合 $w^{\\text{mkt}}$ 成为最优的收益。应用一阶条件：\n$$ \\pi = \\lambda \\Sigma w^{\\text{mkt}} $$\n\n其次，假设基金经理观察到的投资组合 $w^{\\text{mgr}}$ 相对于我们表示为 $\\mu^{\\star}$ 的 Black-Litterman 后验预期收益是最优的。因此：\n$$ \\mu^{\\star} = \\lambda \\Sigma w^{\\text{mgr}} $$\n\n**步骤 3：隐含观点向量 $Q$ 的推导**\n\nBlack-Litterman 模型通过结合收益的先验分布 $r \\sim \\mathcal{N}(\\pi, \\tau \\Sigma)$ 和一组线性观点 $P r \\sim \\mathcal{N}(Q, \\Omega)$，提供了后验平均预期收益 $\\mu^{\\text{BL}}$ 的公式。后验均值的公式是贝叶斯推断的结果：\n$$ \\mu^{\\text{BL}} = \\left[ (\\tau \\Sigma)^{-1} + P^{\\top} \\Omega^{-1} P \\right]^{-1} \\left[ (\\tau \\Sigma)^{-1} \\pi + P^{\\top} \\Omega^{-1} Q \\right] $$\n我们已知基金经理的隐含收益 $\\mu^{\\star}$ 等于 BL 后验均值，因此 $\\mu^{\\star} = \\mu^{\\text{BL}}$。我们的目标是求解观点向量 $Q$。\n\n让我们重新整理该方程：\n$$ \\left[ (\\tau \\Sigma)^{-1} + P^{\\top} \\Omega^{-1} P \\right] \\mu^{\\star} = (\\tau \\Sigma)^{-1} \\pi + P^{\\top} \\Omega^{-1} Q $$\n分离包含 $Q$ 的项：\n$$ P^{\\top} \\Omega^{-1} Q = \\left[ (\\tau \\Sigma)^{-1} + P^{\\top} \\Omega^{-1} P \\right] \\mu^{\\star} - (\\tau \\Sigma)^{-1} \\pi $$\n在右侧分配 $\\mu^{\\star}$：\n$$ P^{\\top} \\Omega^{-1} Q = (\\tau \\Sigma)^{-1} \\mu^{\\star} + P^{\\top} \\Omega^{-1} P \\mu^{\\star} - (\\tau \\Sigma)^{-1} \\pi $$\n合并项：\n$$ P^{\\top} \\Omega^{-1} Q = (\\tau \\Sigma)^{-1} (\\mu^{\\star} - \\pi) + P^{\\top} \\Omega^{-1} P \\mu^{\\star} $$\n问题指明有 $k=n=3$ 个绝对观点，因此观点矩阵 $P$ 是 $3 \\times 3$ 的单位矩阵，$P = I_3$。由于 $P$ 是单位矩阵，它等于其自身的逆和自身的转置，即 $P = P^{\\top} = P^{-1} = I_n$。代入 $P = I_n$ 和 $P^{\\top} = I_n$ 会显著简化方程：\n$$ I_n^{\\top} \\Omega^{-1} Q = (\\tau \\Sigma)^{-1} (\\mu^{\\star} - \\pi) + I_n^{\\top} \\Omega^{-1} I_n \\mu^{\\star} $$\n$$ \\Omega^{-1} Q = (\\tau \\Sigma)^{-1} (\\mu^{\\star} - \\pi) + \\Omega^{-1} \\mu^{\\star} $$\n为了求解 $Q$，我们用 $\\Omega$ 左乘两边。由于 $\\Omega$ 被指定为对称正定，其逆 $\\Omega^{-1}$ 存在。\n$$ Q = \\Omega \\left[ (\\tau \\Sigma)^{-1} (\\mu^{\\star} - \\pi) + \\Omega^{-1} \\mu^{\\star} \\right] $$\n$$ Q = \\Omega (\\tau \\Sigma)^{-1} (\\mu^{\\star} - \\pi) + \\Omega \\Omega^{-1} \\mu^{\\star} $$\n简化后，我们得到隐含观点向量 $Q$ 的最终表达式：\n$$ Q = \\mu^{\\star} + \\frac{1}{\\tau} \\Omega \\Sigma^{-1} (\\mu^{\\star} - \\pi) $$\n\n**计算步骤总结**\n\n对于每个测试用例，给定参数 $\\{\\Sigma, w^{\\text{mkt}}, w^{\\text{mgr}}, \\lambda, \\tau, \\Omega\\}$，执行以下步骤：\n1.  计算市场隐含的先验收益：$\\pi = \\lambda \\Sigma w^{\\text{mkt}}$。\n2.  计算基金经理隐含的后验收益：$\\mu^{\\star} = \\lambda \\Sigma w^{\\text{mgr}}$。\n3.  计算协方差矩阵的逆 $\\Sigma^{-1}$。\n4.  使用推导出的公式计算隐含观点向量 $Q$：$Q = \\mu^{\\star} + \\frac{1}{\\tau} \\Omega \\Sigma^{-1} (\\mu^{\\star} - \\pi)$。\n\n此过程将被实现，用以为指定的测试用例求解 $Q$。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the implied view vector Q in the Black-Litterman model for three test cases.\n    \"\"\"\n    \n    # Common parameters for all test cases\n    Sigma = np.array([\n        [0.040, 0.018, 0.012],\n        [0.018, 0.035, 0.015],\n        [0.012, 0.015, 0.030]\n    ])\n    \n    w_mkt = np.array([0.5, 0.3, 0.2])\n    \n    # Test suite: (w_mgr, lambda, tau, Omega_diag)\n    test_cases = [\n        (np.array([0.3, 0.4, 0.3]), 2.5, 0.05, np.array([0.01, 0.02, 0.03])),\n        (np.array([0.6, 0.2, 0.2]), 2.5, 0.001, np.array([0.02, 0.02, 0.02])),\n        (np.array([0.2, 0.5, 0.3]), 2.5, 0.05, np.array([0.2, 0.15, 0.25]))\n    ]\n\n    all_q_values = []\n\n    # Pre-compute inverse of Sigma as it is constant\n    Sigma_inv = np.linalg.inv(Sigma)\n\n    for case in test_cases:\n        w_mgr, lambda_val, tau, Omega_diag = case\n        \n        # Build the diagonal Omega matrix\n        Omega = np.diag(Omega_diag)\n        \n        # Step 1: Compute equilibrium prior expected excess returns (pi)\n        # pi = lambda * Sigma * w_mkt\n        pi = lambda_val * (Sigma @ w_mkt)\n        \n        # Step 2: Compute posterior-optimizing expected excess returns (mu_star)\n        # mu_star = lambda * Sigma * w_mgr\n        mu_star = lambda_val * (Sigma @ w_mgr)\n        \n        # Step 3: Compute the implied absolute-view vector (Q)\n        # Q = mu_star + (1/tau) * Omega * Sigma_inv * (mu_star - pi)\n        mu_diff = mu_star - pi\n        adjustment_term = (1 / tau) * (Omega @ Sigma_inv @ mu_diff)\n        Q = mu_star + adjustment_term\n        \n        all_q_values.extend(Q)\n\n    # Format the final output string with 6 decimal places for each value\n    results_str = [f\"{val:.6f}\" for val in all_q_values]\n    \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results_str)}]\")\n\nsolve()\n```", "id": "2376249"}, {"introduction": "细节决定成败。最后一个练习将探讨应用Black-Litterman模型时一个微妙但至关重要的方面：观点的表述方式。您将研究将同一个经济信念——例如，“资产A将跑赢资产B”——用不同的数学形式（比如，作为对资产 $A$ 的绝对观点或资产 $A$ 与 $B$ 之间的相对观点）表达时，是否会得到相同的投资组合。这个练习揭示了观点的数学结构至关重要，它会影响观点的置信度以及最终的资产配置，从而教会我们在构建模型输入时必须小心谨慎。[@problem_id:2376222]", "problem": "您将实施并分析一种 Black-Litterman 投资组合优化方法，该方法在不同的观点编码结构下进行，以测试将相同的经济信念表达为绝对观点与相对观点是否会改变最终的最优投资组合，以及改变的程度。\n\n从以下基本原理开始：\n- Markowitz 均值-方差最优性：对于给定的预期超额收益向量 $ \\mu \\in \\mathbb{R}^{n} $、协方差矩阵 $ \\Sigma \\in \\mathbb{R}^{n \\times n} $ 和风险规避参数 $ \\lambda \\in \\mathbb{R}_{+} $，均值-方差最优权重为 $ w^{\\star}(\\mu) = \\frac{1}{\\lambda} \\Sigma^{-1} \\mu $。\n- 用于均衡隐含收益率的逆向优化：如果市场市值权重为 $ w^{mkt} \\in \\mathbb{R}^{n} $，则隐含的均衡预期超额收益率为 $ \\pi = \\lambda \\Sigma w^{mkt} $。\n- 在多元正态先验和线性含噪声观测下的贝叶斯更新：假设未知的预期超额收益向量 $ \\mu $ 具有先验分布 $ \\mu \\sim \\mathcal{N}(\\pi, \\tau \\Sigma) $，其中 $ \\tau \\in \\mathbb{R}_{+} $，并且线性观点被建模为 $ P \\mu + \\varepsilon = q $，其中 $ P \\in \\mathbb{R}^{k \\times n} $，$ q \\in \\mathbb{R}^{k} $，以及 $ \\varepsilon \\sim \\mathcal{N}(0, \\Omega) $，其中 $ \\Omega \\in \\mathbb{R}^{k \\times k} $ 是对称正定矩阵。您必须推导出 $ \\mu $ 的后验均值，并使用它来计算均值-方差最优性下的后验最优投资组合权重。\n\n数值设定（所有数字都是无量纲的，没有物理单位）：\n- 资产数量 $ n = 3 $。\n- 协方差矩阵\n$$\n\\Sigma =\n\\begin{bmatrix}\n0.04  0.006  0.012 \\\\\n0.006  0.09  0.018 \\\\\n0.012  0.018  0.16\n\\end{bmatrix}.\n$$\n- 市场市值权重 $ w^{mkt} = [0.5, 0.3, 0.2]^{\\top} $。\n- 风险规避 $ \\lambda = 2.5 $。\n- 先验缩放因子 $ \\tau = 0.05 $。\n- 单一经济信念：“资产 $ 1 $ 的预期超额收益应比其均衡隐含值高出 $ \\Delta = 0.01 $”，即资产 $ 1 $ 的预期超额收益发生 $ 0.01 $ 的偏移。\n\n观点与测试套件：\n对于所有观点，将观点协方差 $ \\Omega $ 构建为一个对角矩阵，其对角线上的元素等于每个观点在模型下的隐含方差，即第 $ i $ 个对角元素是第 $ i $ 个线性观点在先验分布 $ \\mathcal{N}(\\pi, \\tau \\Sigma) $ 下的方差，计算方式为 $ P (\\tau \\Sigma) P^{\\top} $ 矩阵的第 $ i $ 个对角元素。这确保了在不同观点参数化设置下的置信度具有可比性。\n\n定义以下三个测试用例，每个用例都会产生一个最优的 Black-Litterman 投资组合。您必须计算 $ \\pi $，然后根据每个观点结构计算 $ \\mu $ 的后验均值，接着计算相应的最优权重 $ w^{\\star} $。\n\n- 测试用例 A（绝对观点 vs. “相对于现金”的观点）：\n  - 绝对观点：$ P_{A,abs} = [1, 0, 0] $，$ q_{A,abs} = \\pi_{1} + \\Delta $。\n  - 相对于现金的观点：在超额收益的设定中，现金对应于 $ 0 $，因此 $ P_{A,rel} = [1, 0, 0] $，$ q_{A,rel} = \\pi_{1} + \\Delta $。\n  - 计算两个最终最优权重向量之间的欧几里得距离：\n    $$ d_{A} = \\lVert w^{\\star}_{A,abs} - w^{\\star}_{A,rel} \\rVert_{2}. $$\n\n- 测试用例 B（绝对观点 vs. 相对于资产 $ 2 $ 的观点）：\n  - 绝对观点：$ P_{B,abs} = [1, 0, 0] $，$ q_{B,abs} = \\pi_{1} + \\Delta $。\n  - 相对于资产 $ 2 $ 的相对观点：$ P_{B,rel} = [1, -1, 0] $，并选择 $ q_{B,rel} = (\\pi_{1} + \\Delta) - \\pi_{2} $，以使资产 $ 1 $ 和 $ 2 $ 之间的目标差异，与当资产 $ 2 $ 保持在其先验均值时，资产 $ 1 $ 的绝对目标所隐含的差异相匹配。\n  - 计算欧几里得距离：\n    $$ d_{B} = \\lVert w^{\\star}_{B,abs} - w^{\\star}_{B,rel} \\rVert_{2}. $$\n\n- 测试用例 C（观点重复的敏感性）：\n  - 单一的相对于资产 $ 2 $ 的相对观点：$ P_{C,1} = [1, -1, 0] $，$ q_{C,1} = (\\pi_{1} + \\Delta) - \\pi_{2} $。\n  - 重复的观点（两个相同的行）：\n    $$\n    P_{C,2} =\n    \\begin{bmatrix}\n    1  -1  0 \\\\\n    1  -1  0\n    \\end{bmatrix}, \\quad\n    q_{C,2} =\n    \\begin{bmatrix}\n    (\\pi_{1} + \\Delta) - \\pi_{2} \\\\\n    (\\pi_{1} + \\Delta) - \\pi_{2}\n    \\end{bmatrix}.\n    $$\n    对每一行使用相同的对角线构造方法来构建 $ \\Omega $。这种重复增加了同一线性信念的有效精度。\n  - 计算最终最优权重之间的欧几里得距离：\n    $$ d_{C} = \\lVert w^{\\star}_{C,1} - w^{\\star}_{C,2} \\rVert_{2}. $$\n\n您的程序必须：\n1. 根据给定的 $ \\Sigma $、$ \\lambda $ 和 $ w^{mkt} $ 计算 $ \\pi $。\n2. 对于每个观点设定，按照从 $ P (\\tau \\Sigma) P^{\\top} $ 描述的方式构建 $ \\Omega $。\n3. 在正态-线性贝叶斯更新下计算 $ \\mu $ 的后验均值。\n4. 对每种情况计算 $ w^{\\star} = \\frac{1}{\\lambda} \\Sigma^{-1} \\mu_{post} $。\n5. 输出一行，包含列表 $ [d_{A}, d_{B}, d_{C}] $，其中每个 $ d $ 是一个四舍五入到八位小数的浮点数。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，“[0.00000000,0.01234567,0.00123456]”）。", "solution": "该问题要求分析 Black-Litterman 投资组合优化模型，特别是研究最终的最优投资组合权重对投资者观点表述方式的敏感性。此分析将通过比较由相同经济信念但以不同数学形式（绝对观点和相对观点）表达而得出的投资组合来执行。\n\n该问题的理论基础建立在两大支柱之上：Markowitz 均值-方差优化模型和用于推导预期收益的 Black-Litterman 模型。\n\n首先，Markowitz 模型假定，对于给定的预期超额收益向量 $ \\mu \\in \\mathbb{R}^{n} $、资产协方差矩阵 $ \\Sigma \\in \\mathbb{R}^{n \\times n} $ 和标量风险规避参数 $ \\lambda > 0 $，能够最大化效用函数 $ U(w) = w^{\\top}\\mu - \\frac{\\lambda}{2}w^{\\top}\\Sigma w $ 的最优投资组合权重 $ w^{\\star} $ 由下式给出：\n$$\nw^{\\star}(\\mu) = \\frac{1}{\\lambda} \\Sigma^{-1} \\mu\n$$\n\n其次，Black-Litterman 模型提供了一个贝叶斯框架来确定预期收益向量 $ \\mu $。它首先从可观察到的市场市值权重 $ w^{mkt} $ 中逆向推导出市场的共识预期。这些被称为隐含均衡收益，用 $ \\pi $ 表示，计算如下：\n$$\n\\pi = \\lambda \\Sigma w^{mkt}\n$$\n这些均衡收益作为未知真实预期收益 $ \\mu $ 的先验分布的中心。先验分布假设为多元正态分布：\n$$\n\\mu \\sim \\mathcal{N}(\\pi, \\tau\\Sigma)\n$$\n其中 $ \\tau \\in \\mathbb{R}_{+} $ 是一个缩放因子，用于控制对先验均值 $ \\pi $ 的置信度。较小的 $ \\tau $ 表示较高的置信度。\n\n投资者的个人观点被表达为一组包含不确定性的 $ k $ 个线性方程：\n$$\nP \\mu + \\varepsilon = q\n$$\n这里，$ P \\in \\mathbb{R}^{k \\times n} $ 是“选择”或“观点”矩阵，用于识别每个观点中涉及的资产。向量 $ q \\in \\mathbb{R}^{k} $ 包含这些线性组合的预期结果。项 $ \\varepsilon \\sim \\mathcal{N}(0, \\Omega) $ 代表观点中的不确定性，其中 $ \\Omega \\in \\mathbb{R}^{k \\times k} $ 是观点误差的协方差矩阵。\n\n为了获得 $ \\mu $ 的后验分布，我们使用贝叶斯定理将先验分布与从观点中导出的似然函数相结合。对于多元正态分布，后验分布也是正态的。后验均值 $ \\mu_{post} $ 是通过最小化与先验模型和观点模型的负对数似然相对应的马氏距离（Mahalanobis distances）平方和来导出的：\n$$\nL(\\mu) = (\\mu - \\pi)^{\\top}(\\tau\\Sigma)^{-1}(\\mu - \\pi) + (q - P\\mu)^{\\top}\\Omega^{-1}(q - P\\mu)\n$$\n对 $ \\mu $ 求导并令其为零可得：\n$$\n\\frac{\\partial L}{\\partial \\mu} = 2(\\tau\\Sigma)^{-1}(\\mu - \\pi) - 2P^{\\top}\\Omega^{-1}(q - P\\mu) = 0\n$$\n$$\n\\left( (\\tau\\Sigma)^{-1} + P^{\\top}\\Omega^{-1}P \\right) \\mu = (\\tau\\Sigma)^{-1}\\pi + P^{\\top}\\Omega^{-1}q\n$$\n解出 $ \\mu $ 即可得到预期收益的后验均值：\n$$\n\\mu_{post} = \\left( (\\tau\\Sigma)^{-1} + P^{\\top}\\Omega^{-1}P \\right)^{-1} \\left( (\\tau\\Sigma)^{-1}\\pi + P^{\\top}\\Omega^{-1}q \\right)\n$$\n这个后验均值 $ \\mu_{post} $ 代表了市场均衡和投资者特定观点的一种精妙融合。然后，它被用于 Markowitz 公式中，以计算最终的 Black-Litterman 最优投资组合权重：\n$$\nw^{\\star}_{BL} = \\frac{1}{\\lambda} \\Sigma^{-1} \\mu_{post}\n$$\n该问题指定了一种构建观点不确定性矩阵 $ \\Omega $ 的特定方法：它是一个对角矩阵，其中第 $ i $ 个对角元素是先验分布所隐含的第 $ i $ 个观点的方差。该方差计算为矩阵 $ P(\\tau\\Sigma)P^{\\top} $ 的第 $ i $ 个对角元素。\n\n计算流程如下：\n1.  使用给定的 $ \\lambda $、$ \\Sigma $ 和 $ w^{mkt} $ 的数值，我们首先计算隐含均衡收益向量 $ \\pi $。\n2.  对于每个测试用例，我们构建用于编码观点的特定 $ P $ 和 $ q $ 矩阵/向量。\n3.  然后，我们按照规定为每个观点结构构建观点协方差矩阵 $ \\Omega $。\n4.  使用推导出的公式，我们为每种情景计算后验预期收益 $ \\mu_{post} $。\n5.  接着，我们计算每种情景对应的最优投资组合权重 $ w^{\\star} $。\n6.  最后，我们计算相关权重向量对之间的欧几里得距离 $ d_A, d_B, d_C $。\n\n**测试用例 A**：此用例比较了对资产 $ 1 $ 的绝对观点与“相对于现金”的观点。在超额收益框架中，现金的收益为零。因此，关于某项资产超额收益的观点本质上是相对于现金的。两种情景的数学表述是相同的：$ P = [1, 0, 0] $ 和 $ q = \\pi_1 + \\Delta $。因此，最终的后验收益和投资组合权重必须相同，从而预期距离 $ d_A = 0 $。这可以作为一个一致性检验。\n\n**测试用例 B**：此用例对比了对资产 $ 1 $ 的绝对观点（$ P_{abs} = [1, 0, 0] $）与涉及资产 $ 1 $ 和资产 $ 2 $ 的相对观点（$ P_{rel} = [1, -1, 0] $）。相对观点的目标 $ q_{rel} $ 被设定为与绝对观点在资产 $ 2 $ 的预期收益保持在其先验均值的假设下相一致。尽管在经济理念上保持一致，但数学结构是不同的（$ P_{abs} \\neq P_{rel} $）。这将导致不同的 $ \\Omega $ 矩阵和不同的后验更新，从而产生不同的最优投资组合。距离 $ d_B $ 将量化这种差异。\n\n**测试用例 C**：此用例考察了观点重复的影响。我们将来自单个相对观点（与用例 B 中的相对观点相同）的投资组合与一个将相同观点陈述两次的投资组合进行比较。通过用两个相同的行构建 $ P $ 和用两个相同的条目构建 $ q $，并对 $ \\Omega $ 使用指定的对角线构建方法，我们实际上是在增加对该单一经济信念的置信度。后验均值公式中的 $ P^{\\top}\\Omega^{-1}P $ 项在重复观点的情况下会更大，从而将后验均值更强地拉向该观点。距离 $ d_C $ 将衡量由于这种置信度增加而导致的投资组合变化。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements the Black-Litterman model to analyze portfolio sensitivity\n    to different view formulations.\n    \"\"\"\n    # Numerical setup from the problem statement\n    n = 3\n    Sigma = np.array([\n        [0.04, 0.006, 0.012],\n        [0.006, 0.09, 0.018],\n        [0.012, 0.018, 0.16]\n    ])\n    w_mkt = np.array([0.5, 0.3, 0.2])\n    lam = 2.5\n    tau = 0.05\n    Delta = 0.01\n\n    # Pre-compute matrices that are used repeatedly\n    Sigma_inv = np.linalg.inv(Sigma)\n    tau_Sigma = tau * Sigma\n    tau_Sigma_inv = np.linalg.inv(tau_Sigma)\n\n    # Step 1: Compute implied equilibrium returns (pi)\n    pi = lam * Sigma @ w_mkt\n\n    def compute_bl_weights(P, q, pi_vec, tau_Sigma_mat, tau_Sigma_inv_mat, Sigma_inv_mat, lam_val):\n        \"\"\"\n        Computes the Black-Litterman optimal portfolio weights for a given set of views.\n        Args:\n            P (np.ndarray): The view matrix (k x n).\n            q (np.ndarray): The view outcomes vector (k,).\n            pi_vec (np.ndarray): The equilibrium returns vector (n,).\n            tau_Sigma_mat (np.ndarray): The scaled prior covariance matrix (n x n).\n            tau_Sigma_inv_mat (np.ndarray): The inverse of tau_Sigma_mat (n x n).\n            Sigma_inv_mat (np.ndarray): The inverse asset covariance matrix (n x n).\n            lam_val (float): The risk aversion parameter.\n        Returns:\n            np.ndarray: The optimal portfolio weights vector (n,).\n        \"\"\"\n        # Ensure P is 2D\n        if P.ndim == 1:\n            P = P.reshape(1, -1)\n        \n        # Ensure q is 1D\n        if q.ndim > 1:\n            q = q.flatten()\n\n        # Step 2: Construct the view covariance Omega\n        # Omega is a diagonal matrix with diagonal elements from P * (tau*Sigma) * P.T\n        view_var_cov = P @ tau_Sigma_mat @ P.T\n        Omega_diag = np.diag(view_var_cov)\n        Omega = np.diag(Omega_diag)\n        Omega_inv = np.linalg.inv(Omega)\n\n        # Step 3: Compute the posterior mean of mu\n        # Formula: mu_post = inv(inv(tau*Sigma) + P.T*inv(Omega)*P) * (inv(tau*Sigma)*pi + P.T*inv(Omega)*q)\n        posterior_precision = tau_Sigma_inv_mat + P.T @ Omega_inv @ P\n        posterior_covariance = np.linalg.inv(posterior_precision)\n        \n        rhs_vector = tau_Sigma_inv_mat @ pi_vec + P.T @ Omega_inv @ q\n        \n        mu_post = posterior_covariance @ rhs_vector\n\n        # Step 4: Compute the optimal portfolio weights\n        w_star = (1 / lam_val) * Sigma_inv_mat @ mu_post\n        \n        return w_star\n\n    # ----- Test Case A -----\n    # Absolute view\n    P_A_abs = np.array([1, 0, 0])\n    q_A_abs = np.array([pi[0] + Delta])\n    w_A_abs = compute_bl_weights(P_A_abs, q_A_abs, pi, tau_Sigma, tau_Sigma_inv, Sigma_inv, lam)\n    \n    # Relative-to-cash view (mathematically identical to absolute view in this context)\n    P_A_rel = np.array([1, 0, 0])\n    q_A_rel = np.array([pi[0] + Delta])\n    w_A_rel = compute_bl_weights(P_A_rel, q_A_rel, pi, tau_Sigma, tau_Sigma_inv, Sigma_inv, lam)\n\n    d_A = np.linalg.norm(w_A_abs - w_A_rel)\n\n    # ----- Test Case B -----\n    # Absolute view (same as w_A_abs)\n    w_B_abs = w_A_abs\n    \n    # Relative view to asset 2\n    P_B_rel = np.array([1, -1, 0])\n    q_B_rel_val = (pi[0] + Delta) - pi[1]\n    q_B_rel = np.array([q_B_rel_val])\n    w_B_rel = compute_bl_weights(P_B_rel, q_B_rel, pi, tau_Sigma, tau_Sigma_inv, Sigma_inv, lam)\n\n    d_B = np.linalg.norm(w_B_abs - w_B_rel)\n    \n    # ----- Test Case C -----\n    # Single relative view (same as w_B_rel)\n    w_C_1 = w_B_rel\n\n    # Duplicated relative view\n    P_C_2 = np.array([[1, -1, 0], [1, -1, 0]])\n    q_C_2 = np.array([q_B_rel_val, q_B_rel_val])\n    w_C_2 = compute_bl_weights(P_C_2, q_C_2, pi, tau_Sigma, tau_Sigma_inv, Sigma_inv, lam)\n    \n    d_C = np.linalg.norm(w_C_1 - w_C_2)\n\n    # Final output formatting\n    results = [round(d, 8) for d in [d_A, d_B, d_C]]\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "2376222"}]}