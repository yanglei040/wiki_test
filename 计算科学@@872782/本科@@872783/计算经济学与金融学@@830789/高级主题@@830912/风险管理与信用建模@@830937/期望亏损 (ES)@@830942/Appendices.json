{"hands_on_practices": [{"introduction": "要真正掌握预期短缺（ES），最好的方法就是亲手计算它。这个练习将从一个基础但至关重要的场景开始：一个由两种风险资产和现金组成的投资组合。通过计算不同资产权重下的投资组合 ES [@problem_id:2390659]，你将直观地理解资产配置如何直接影响投资组合的尾部风险，并将抽象的风险概念转化为具体的数值。", "problem": "给定一个由两种相关风险资产和一种现金资产组成的投资组合。设风险资产收益的随机向量为 $R = (R_1, R_2)^\\top$，其中 $R$ 服从联合正态分布，其均值向量为 $\\mu = (\\mu_1, \\mu_2)^\\top$，协方差矩阵为\n$$\n\\Sigma = \\begin{pmatrix}\n\\sigma_1^2  \\rho\\,\\sigma_1 \\sigma_2 \\\\\n\\rho\\,\\sigma_1 \\sigma_2  \\sigma_2^2\n\\end{pmatrix}.\n$$\n设 $w_1$ 和 $w_2$ 表示两种风险资产的投资组合权重，剩余权重为 $w_0 = 1 - w_1 - w_2$，投资于零收益和零方差的现金资产。假设 $w_1 \\ge 0$，$w_2 \\ge 0$ 且 $w_1 + w_2 \\le 1$。定义投资组合收益为 $R_p = w_1 R_1 + w_2 R_2 + w_0 \\cdot 0 = w_1 R_1 + w_2 R_2$，投资组合损失为 $L = -R_p$。设尾部概率水平为 $\\alpha \\in (0,1)$ 时的预期短缺（Conditional Value-at-Risk）为\n$$\n\\mathrm{ES}_\\alpha(L) = \\mathbb{E}\\!\\left[\\,L \\,\\middle|\\, L \\ge \\mathrm{VaR}_\\alpha(L)\\,\\right],\n$$\n其中 $\\mathrm{VaR}_\\alpha(L)$ 是水平为 $\\alpha$ 时的风险价值（Value-at-Risk）。\n\n使用的参数：\n- 风险资产均值：$\\mu_1 = 0.001$，$\\mu_2 = 0.0005$。\n- 风险资产波动率：$\\sigma_1 = 0.02$，$\\sigma_2 = 0.015$。\n- 相关性：$\\rho = 0.4$。\n- 尾部概率水平：$\\alpha = 0.975$。\n\n任务：\n- 对于方形区域 $[0,1]\\times[0,1]$ 上步长为 $0.01$ 的均匀网格上的权重 $(w_1,w_2)$，计算所有满足 $w_1 \\ge 0$，$w_2 \\ge 0$ 且 $w_1 + w_2 \\le 1$ 的可行点的 $\\mathrm{ES}_\\alpha(L)$。这将生成一个数值曲面，其等值线构成了在可行权重三角形上投资组合预期短缺的二维等高线表示。\n- 不要输出网格。而是计算以下特定权重对测试集的 $\\mathrm{ES}_\\alpha(L)$，并按给定顺序表示：\n  $$\n  (w_1,w_2) \\in \\{(0,0),\\ (1,0),\\ (0,1),\\ (0.3,0.2)\\}.\n  $$\n- 所有答案必须表示为实数（浮点数）。不适用任何物理单位。尾部概率水平是 $(0,1)$ 内的小数，而不是百分比。\n- 您的程序应生成单行输出，其中包含按测试集顺序排列的结果，形式为方括号内的逗号分隔列表，每个值四舍五入到 $6$ 位小数（例如，$[x_1,x_2,x_3,x_4]$）。\n\n输入数据已在上面完全指定；您的程序不得读取任何输入，也不得访问外部资源。", "solution": "在尝试求解之前，对问题陈述进行验证。\n\n逐字提取给定条件：\n- 一个投资组合由两种相关风险资产和一种现金资产组成。\n- 风险资产收益的随机向量为 $R = (R_1, R_2)^\\top$。\n- $R$ 服从联合正态分布，其均值向量为 $\\mu = (\\mu_1, \\mu_2)^\\top$，协方差矩阵为 $\\Sigma = \\begin{pmatrix} \\sigma_1^2  \\rho\\,\\sigma_1 \\sigma_2 \\\\ \\rho\\,\\sigma_1 \\sigma_2  \\sigma_2^2 \\end{pmatrix}$。\n- 风险资产的投资组合权重为 $w_1$ 和 $w_2$。\n- 现金资产的权重为 $w_0 = 1 - w_1 - w_2$，其收益和方差均为零。\n- 约束条件为 $w_1 \\ge 0$，$w_2 \\ge 0$ 且 $w_1 + w_2 \\le 1$。\n- 投资组合收益为 $R_p = w_1 R_1 + w_2 R_2$。\n- 投资组合损失为 $L = -R_p$。\n- 尾部概率水平为 $\\alpha \\in (0,1)$ 时的预期短缺为 $\\mathrm{ES}_\\alpha(L) = \\mathbb{E}\\!\\left[\\,L \\,\\middle|\\, L \\ge \\mathrm{VaR}_\\alpha(L)\\,\\right]$。\n- 风险价值为 $\\mathrm{VaR}_\\alpha(L)$。\n- 参数：$\\mu_1 = 0.001$，$\\mu_2 = 0.0005$，$\\sigma_1 = 0.02$，$\\sigma_2 = 0.015$，$\\rho = 0.4$，$\\alpha = 0.975$。\n- $(w_1,w_2)$ 的测试用例为 $\\{(0,0),\\ (1,0),\\ (0,1),\\ (0.3,0.2)\\}$。\n\n验证评估：\n该问题具有科学依据、提法明确且客观。这是一个计算金融学中的标准问题，基于投资组合理论和风险管理的既定原则。其数学设定涉及正态分布随机变量的线性组合，是一致的，并能导出一个唯一的、明确定义的解。所提供的参数在数值上是现实的。术语“尾部概率水平 $\\alpha$”略有歧义。金融学的标准惯例将 $\\mathrm{ES}_\\alpha$ 和 $\\mathrm{VaR}_\\alpha$ 中的 $\\alpha$ 定义为置信水平（例如 $0.95$，$0.99$），相应的尾部概率为 $1-\\alpha$。鉴于 $\\alpha=0.975$ 这个值，我们将其解释为置信水平，这是一种标准的解释，使得问题不再有歧义。因此，该问题被认为是**有效的**。\n\n求解过程如下。\n\n首先，我们确定投资组合损失 $L$ 的概率分布。投资组合收益 $R_p$ 是两个联合正态分布随机变量 $R_1$ 和 $R_2$ 的线性组合。设权重向量为 $w = (w_1, w_2)^\\top$。投资组合收益可以写成 $R_p = w^\\top R$。\n因为 $R \\sim \\mathcal{N}(\\mu, \\Sigma)$，投资组合收益 $R_p$ 也服从正态分布。\n投资组合收益的均值 $\\mu_p$ 是：\n$$ \\mu_p = \\mathbb{E}[R_p] = \\mathbb{E}[w^\\top R] = w^\\top \\mu = w_1 \\mu_1 + w_2 \\mu_2 $$\n投资组合收益的方差 $\\sigma_p^2$ 是：\n$$ \\sigma_p^2 = \\mathrm{Var}(R_p) = \\mathrm{Var}(w^\\top R) = w^\\top \\Sigma w = w_1^2 \\sigma_1^2 + w_2^2 \\sigma_2^2 + 2 w_1 w_2 \\rho \\sigma_1 \\sigma_2 $$\n因此，$R_p \\sim \\mathcal{N}(\\mu_p, \\sigma_p^2)$。\n\n投资组合损失定义为 $L = -R_p$。作为正态随机变量的仿射变换，$L$ 也服从正态分布。\n投资组合损失的均值 $\\mu_L$ 是：\n$$ \\mu_L = \\mathbb{E}[L] = \\mathbb{E}[-R_p] = -\\mu_p = -(w_1 \\mu_1 + w_2 \\mu_2) $$\n投资组合损失的方差 $\\sigma_L^2$ 是：\n$$ \\sigma_L^2 = \\mathrm{Var}(L) = \\mathrm{Var}(-R_p) = (-1)^2 \\mathrm{Var}(R_p) = \\sigma_p^2 $$\n损失的标准差是 $\\sigma_L = \\sigma_p$。\n所以，损失分布为 $L \\sim \\mathcal{N}(\\mu_L, \\sigma_L^2)$。\n\n其次，我们为这个正态分布构建预期短缺 $\\mathrm{ES}_\\alpha(L)$ 的公式。提供的定义是 $\\mathrm{ES}_\\alpha(L) = \\mathbb{E}[L \\mid L \\ge \\mathrm{VaR}_\\alpha(L)]$。\n风险价值 $\\mathrm{VaR}_\\alpha(L)$ 是损失分布 $L$ 的 $\\alpha$-分位数。设 $z_\\alpha = \\Phi^{-1}(\\alpha)$ 是标准正态分布 $\\mathcal{N}(0,1)$ 的 $\\alpha$-分位数，其中 $\\Phi(\\cdot)$ 是标准正态累积分布函数（CDF）。\n然后，通过对 $L$ 进行标准化来找到 $\\mathrm{VaR}_\\alpha(L)$：\n$$ P(L \\le \\mathrm{VaR}_\\alpha(L)) = P\\left(\\frac{L - \\mu_L}{\\sigma_L} \\le \\frac{\\mathrm{VaR}_\\alpha(L) - \\mu_L}{\\sigma_L}\\right) = \\Phi\\left(\\frac{\\mathrm{VaR}_\\alpha(L) - \\mu_L}{\\sigma_L}\\right) = \\alpha $$\n这意味着 $\\frac{\\mathrm{VaR}_\\alpha(L) - \\mu_L}{\\sigma_L} = z_\\alpha$，从而得出：\n$$ \\mathrm{VaR}_\\alpha(L) = \\mu_L + \\sigma_L z_\\alpha $$\n现在，$\\mathrm{ES}_\\alpha(L)$ 是 $L$ 在 $c = \\mathrm{VaR}_\\alpha(L)$ 处进行下方截断后的期望值。对于一个一般正态变量 $X \\sim \\mathcal{N}(\\mu, \\sigma^2)$，其条件期望由以下公式给出：\n$$ \\mathbb{E}[X \\mid X \\ge c] = \\mu + \\sigma \\frac{\\phi((c-\\mu)/\\sigma)}{1 - \\Phi((c-\\mu)/\\sigma)} $$\n其中 $\\phi(\\cdot)$ 是标准正态概率密度函数（PDF）。\n在我们的例子中，$X=L$，$\\mu=\\mu_L$，$\\sigma=\\sigma_L$，且 $c = \\mathrm{VaR}_\\alpha(L)$。标准化的截断点是：\n$$ \\frac{c - \\mu_L}{\\sigma_L} = \\frac{(\\mu_L + \\sigma_L z_\\alpha) - \\mu_L}{\\sigma_L} = z_\\alpha $$\n将此代入条件期望公式，得到预期短缺的公式：\n$$ \\mathrm{ES}_\\alpha(L) = \\mu_L + \\sigma_L \\frac{\\phi(z_\\alpha)}{1 - \\Phi(z_\\alpha)} $$\n根据定义，由于 $\\Phi(z_\\alpha) = \\alpha$，我们得到最终的解析表达式：\n$$ \\mathrm{ES}_\\alpha(L) = \\mu_L + \\sigma_L \\frac{\\phi(z_\\alpha)}{1 - \\alpha} $$\n\n第三，我们使用指定参数将此公式应用于给定的测试用例：$\\mu_1 = 0.001$，$\\mu_2 = 0.0005$，$\\sigma_1 = 0.02$，$\\sigma_2 = 0.015$，$\\rho = 0.4$ 和 $\\alpha = 0.975$。\n分位数 $z_{0.975} = \\Phi^{-1}(0.975) \\approx 1.959964$。分母是 $1 - \\alpha = 0.025$。\n\n情况1：$(w_1, w_2) = (0, 0)$。\n投资组合仅持有现金资产。\n$\\mu_L = -(0 \\cdot \\mu_1 + 0 \\cdot \\mu_2) = 0$。\n$\\sigma_L^2 = 0$，所以 $\\sigma_L = 0$。\n$\\mathrm{ES}_{0.975}(L) = 0 + 0 \\cdot \\frac{\\phi(z_{0.975})}{0.025} = 0$。\n\n情况2：$(w_1, w_2) = (1, 0)$。\n投资组合完全投资于资产1。\n$\\mu_L = -(1 \\cdot 0.001 + 0 \\cdot 0.0005) = -0.001$。\n$\\sigma_L = \\sigma_1 = 0.02$。\n$\\mathrm{ES}_{0.975}(L) = -0.001 + 0.02 \\cdot \\frac{\\phi(z_{0.975})}{0.025} \\approx 0.045753$。\n\n情况3：$(w_1, w_2) = (0, 1)$。\n投资组合完全投资于资产2。\n$\\mu_L = -(0 \\cdot 0.001 + 1 \\cdot 0.0005) = -0.0005$。\n$\\sigma_L = \\sigma_2 = 0.015$。\n$\\mathrm{ES}_{0.975}(L) = -0.0005 + 0.015 \\cdot \\frac{\\phi(z_{0.975})}{0.025} \\approx 0.034565$。\n\n情况4：$(w_1, w_2) = (0.3, 0.2)$。\n$\\mu_L = -(0.3 \\cdot 0.001 + 0.2 \\cdot 0.0005) = -(0.0003 + 0.0001) = -0.0004$。\n$\\sigma_L^2 = (0.3)^2(0.02)^2 + (0.2)^2(0.015)^2 + 2(0.3)(0.2)(0.4)(0.02)(0.015) = 0.0000594$。\n$\\sigma_L = \\sqrt{0.0000594} \\approx 0.00770714$。\n$\\mathrm{ES}_{0.975}(L) = -0.0004 + 0.00770714 \\cdot \\frac{\\phi(z_{0.975})}{0.025} \\approx 0.017597$。\n\n这些计算在提供的程序中实现，以生成最终的数值答案。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import norm\n\ndef solve():\n    \"\"\"\n    Calculates the Expected Shortfall (ES) for a two-asset portfolio for specific weight combinations.\n    \"\"\"\n    # Define the parameters given in the problem statement.\n    mu1 = 0.001\n    mu2 = 0.0005\n    sigma1 = 0.02\n    sigma2 = 0.015\n    rho = 0.4\n    alpha = 0.975\n\n    # Define the test suite of specific weight pairs.\n    test_cases = [\n        (0.0, 0.0),\n        (1.0, 0.0),\n        (0.0, 1.0),\n        (0.3, 0.2),\n    ]\n\n    # Pre-compute constants related to the standard normal distribution.\n    # z_alpha is the alpha-quantile of the standard normal distribution.\n    z_alpha = norm.ppf(alpha)\n    \n    # This is the term phi(z_alpha) / (1 - alpha) from the ES formula for a normal distribution.\n    pdf_over_tail = norm.pdf(z_alpha) / (1.0 - alpha)\n\n    results = []\n    for w1, w2 in test_cases:\n        # Calculate the mean of the portfolio loss (L = -R_p).\n        # mu_L = -E[R_p] = -(w1*mu1 + w2*mu2)\n        mu_L = -(w1 * mu1 + w2 * mu2)\n\n        # Calculate the variance of the portfolio return, which is equal to the variance of the loss.\n        # var_p = w1^2*sigma1^2 + w2^2*sigma2^2 + 2*w1*w2*rho*sigma1*sigma2\n        var_p = (w1 * sigma1)**2 + (w2 * sigma2)**2 + 2 * w1 * w2 * rho * sigma1 * sigma2\n        \n        # The standard deviation of the loss.\n        sigma_L = np.sqrt(var_p)\n\n        # Calculate Expected Shortfall (ES_alpha) using the derived formula for normal distributions:\n        # ES_alpha(L) = mu_L + sigma_L * (phi(z_alpha) / (1 - alpha))\n        es = mu_L + sigma_L * pdf_over_tail\n        results.append(es)\n\n    # Format the results to 6 decimal places as required.\n    formatted_results = [f\"{r:.6f}\" for r in results]\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "2390659"}, {"introduction": "金融市场的波动性并非一成不变，而是在高、低两种状态间切换。这个练习引入了更符合现实的马尔可夫转换模型来捕捉这种动态性。在这个练习 [@problem_id:2390701] 中，你将面临的挑战是计算不同市场状态下的预期短缺，并将其与整个投资周期的无条件预期短缺进行比较，从而深化对动态风险度量的理解。", "problem": "考虑一个用于单期投资组合回报的双区域马尔可夫转换模型。设时间 $t$ 的潜在区域为 $S_t \\in \\{1,2\\}$。在给定 $S_t = s$ 的条件下，投资组合回报 $R_t$ 服从均值为 $\\mu_s$、方差为 $\\sigma_s^2$ 的正态分布，即对于 $s \\in \\{1,2\\}$，$R_t \\mid (S_t = s) \\sim \\mathcal{N}(\\mu_s, \\sigma_s^2)$。区域过程 $\\{S_t\\}$ 服从一个双状态时齐马尔可夫链，其转移矩阵为\n$$\nP \\;=\\; \\begin{bmatrix}\np_{11}  p_{12} \\\\\np_{21}  p_{22}\n\\end{bmatrix},\n$$\n其中 $p_{ij} = \\mathbb{P}(S_{t+1} = j \\mid S_t = i)$ 且 $p_{11} + p_{12} = 1$，$p_{21} + p_{22} = 1$。将损失定义为 $L_t = -R_t$，并固定一个尾部概率水平 $q \\in (0,1)$，该水平解释为损失分布右尾的概率质量。在险价值阈值 $c_q$ 由 $\\mathbb{P}(L_t \\ge c_q) = q$ 隐式定义。尾部概率为 $q$ 时的预期损失（条件在险价值）定义为\n$$\n\\mathrm{ES}(q) \\;=\\; \\mathbb{E}\\!\\left[\\,L_t \\,\\middle|\\, L_t \\ge c_q \\,\\right].\n$$\n\n对于每个区域 $s \\in \\{1,2\\}$，使用条件损失分布 $L_t \\mid (S_t = s) \\sim \\mathcal{N}(-\\mu_s, \\sigma_s^2)$ 定义区域条件预期损失 $\\mathrm{ES}_s(q)$。使用通过将两个高斯分量与马尔可夫链的平稳概率混合得到的无条件损失分布，来定义无条件混合预期损失 $\\mathrm{ES}_{\\mathrm{mix}}(q)$。设平稳分布为向量 $\\pi = (\\pi_1, \\pi_2)$，满足 $\\pi = \\pi P$ 和 $\\pi_1 + \\pi_2 = 1$，且 $\\pi_1  0$ 及 $\\pi_2  0$。\n\n将具有较大标准差 $\\sigma_s$ 的区域确定为高波动性区域，将具有较小标准差的区域确定为低波动性区域。对于下方的每个测试用例，您必须按此顺序计算三个量：高波动性区域的预期损失 $\\mathrm{ES}_{\\text{high}}(q)$，低波动性区域的预期损失 $\\mathrm{ES}_{\\text{low}}(q)$，以及无条件混合预期损失 $\\mathrm{ES}_{\\mathrm{mix}}(q)$。所有输出必须以小数回报单位（而非百分比）表示，每个数值都必须四舍五入到恰好八位小数。\n\n测试套件。对于每个用例，元组列出 $(\\mu_1, \\sigma_1, \\mu_2, \\sigma_2, P, q)$，其中\n$$\nP \\,=\\, \\begin{bmatrix} p_{11}  p_{12} \\\\ p_{21}  p_{22} \\end{bmatrix}.\n$$\n- 用例 $1$：$(\\mu_1, \\sigma_1, \\mu_2, \\sigma_2) = (\\,0.0005,\\, 0.01,\\, -0.0005,\\, 0.03\\,)$，$P = \\begin{bmatrix} 0.95  0.05 \\\\ 0.10  0.90 \\end{bmatrix}$，$q = 0.01$。\n- 用例 $2$：$(\\mu_1, \\sigma_1, \\mu_2, \\sigma_2) = (\\,0.0,\\, 0.01,\\, 0.0,\\, 0.02\\,)$，$P = \\begin{bmatrix} 0.90  0.10 \\\\ 0.10  0.90 \\end{bmatrix}$，$q = 0.05$。\n- 用例 $3$：$(\\mu_1, \\sigma_1, \\mu_2, \\sigma_2) = (\\,0.0002,\\, 0.005,\\, -0.0002,\\, 0.05\\,)$，$P = \\begin{bmatrix} 0.995  0.005 \\\\ 0.005  0.995 \\end{bmatrix}$，$q = 0.02$。\n- 用例 $4$：$(\\mu_1, \\sigma_1, \\mu_2, \\sigma_2) = (\\,0.0001,\\, 0.001,\\, -0.0001,\\, 0.04\\,)$，$P = \\begin{bmatrix} 0.50  0.50 \\\\ 0.50  0.50 \\end{bmatrix}$，$q = 0.001$。\n\n您的程序必须：\n- 对于每个用例，通过比较 $\\sigma_1$ 和 $\\sigma_2$ 来确定哪个是高波动性区域，哪个是低波动性区域。\n- 使用区域条件的正常损失分布，从基本原理计算 $\\mathrm{ES}_{\\text{high}}(q)$ 和 $\\mathrm{ES}_{\\text{low}}(q)$。\n- 使用 $P$ 的平稳分布 $\\pi$ 和两个正态损失分量的无条件混合，从基本原理计算 $\\mathrm{ES}_{\\mathrm{mix}}(q)$。\n\n最终输出格式。您的程序应生成单行输出，其中包含一个浮点数的扁平列表，顺序如下\n$$\n\\big[\\, \\mathrm{ES}_{\\text{high}}^{(1)},\\, \\mathrm{ES}_{\\text{low}}^{(1)},\\, \\mathrm{ES}_{\\mathrm{mix}}^{(1)},\\, \\mathrm{ES}_{\\text{high}}^{(2)},\\, \\mathrm{ES}_{\\text{low}}^{(2)},\\, \\mathrm{ES}_{\\mathrm{mix}}^{(2)},\\, \\mathrm{ES}_{\\text{high}}^{(3)},\\, \\mathrm{ES}_{\\text{low}}^{(3)},\\, \\mathrm{ES}_{\\mathrm{mix}}^{(3)},\\, \\mathrm{ES}_{\\text{high}}^{(4)},\\, \\mathrm{ES}_{\\text{low}}^{(4)},\\, \\mathrm{ES}_{\\mathrm{mix}}^{(4)} \\,\\big],\n$$\n不含空格，其中上标 $(i)$ 指的是测试用例 $i$。每个数字必须四舍五入到恰好八位小数。该行必须打印为用方括号括起来的逗号分隔列表，例如 $[x_1,x_2,\\dots,x_{12}]$。", "solution": "该问题经过严格验证。\n\n### 步骤 1：提取给定条件\n- **模型**：一个用于单期投资组合回报 $R_t$ 的双区域马尔可夫转换模型。\n- **潜在区域**：$S_t \\in \\{1,2\\}$，服从时齐马尔可夫链。\n- **转移矩阵**：$P = \\begin{bmatrix} p_{11}  p_{12} \\\\ p_{21}  p_{22} \\end{bmatrix}$，其中 $p_{ij} = \\mathbb{P}(S_{t+1} = j \\mid S_t = i)$。\n- **条件回报分布**：$R_t \\mid (S_t = s) \\sim \\mathcal{N}(\\mu_s, \\sigma_s^2)$。\n- **损失定义**：$L_t = -R_t$。因此，条件损失分布为 $L_t \\mid (S_t = s) \\sim \\mathcal{N}(-\\mu_s, \\sigma_s^2)$。\n- **尾部概率**：一个固定的水平 $q \\in (0,1)$。\n- **在险价值 (VaR)**：$c_q$ 由 $\\mathbb{P}(L_t \\ge c_q) = q$ 定义。\n- **预期损失 (ES)**：$\\mathrm{ES}(q) = \\mathbb{E}[L_t \\mid L_t \\ge c_q]$。\n- **区域条件ES**：$\\mathrm{ES}_s(q)$ 是损失分布 $L_t \\mid (S_t = s)$ 的ES。\n- **无条件混合ES**：$\\mathrm{ES}_{\\mathrm{mix}}(q)$ 是无条件损失分布的ES，该分布是两个条件分布的混合，由马尔可夫链的平稳概率 $\\pi = (\\pi_1, \\pi_2)$ 加权。\n- **平稳分布**：$\\pi$ 是满足 $\\pi = \\pi P$ 和 $\\pi_1 + \\pi_2 = 1$ 的向量。\n- **区域识别**：高波动性区域具有较大的 $\\sigma_s$，低波动性区域具有较小的 $\\sigma_s$。\n- **任务**：对于四个测试用例，计算 $\\mathrm{ES}_{\\text{high}}(q)$、$\\mathrm{ES}_{\\text{low}}(q)$ 和 $\\mathrm{ES}_{\\mathrm{mix}}(q)$。\n- **测试用例**：\n    1. $(\\mu_1, \\sigma_1, \\mu_2, \\sigma_2) = (0.0005, 0.01, -0.0005, 0.03)$，$P = \\begin{bmatrix} 0.95  0.05 \\\\ 0.10  0.90 \\end{bmatrix}$，$q = 0.01$。\n    2. $(\\mu_1, \\sigma_1, \\mu_2, \\sigma_2) = (0.0, 0.01, 0.0, 0.02)$，$P = \\begin{bmatrix} 0.90  0.10 \\\\ 0.10  0.90 \\end{bmatrix}$，$q = 0.05$。\n    3. $(\\mu_1, \\sigma_1, \\mu_2, \\sigma_2) = (0.0002, 0.005, -0.0002, 0.05)$，$P = \\begin{bmatrix} 0.995  0.005 \\\\ 0.005  0.995 \\end{bmatrix}$，$q = 0.02$。\n    4. $(\\mu_1, \\sigma_1, \\mu_2, \\sigma_2) = (0.0001, 0.001, -0.0001, 0.04)$，$P = \\begin{bmatrix} 0.50  0.50 \\\\ 0.50  0.50 \\end{bmatrix}$，$q = 0.001$。\n\n### 步骤 2：使用提取的给定条件进行验证\n该问题**具有科学依据**，基于金融计量经济学和风险管理的标准原则。马尔可夫转换模型、在险价值和预期损失都是经典概念。该问题是**适定的**，为待计算的量提供了所有必要的参数和无歧义的定义。其数学结构保证了**唯一且有意义的解**。问题陈述是**客观的**，不含任何主观或推测性内容。未发现检查清单中的任何缺陷。\n\n### 步骤 3：结论与行动\n此问题**有效**。下面是合理的解决方案。\n\n---\n\n### 解题方法论\n\n该问题要求为一个源自双区域马尔可夫转换模型的损失过程计算三种类型的预期损失 (ES)。核心原则阐述如下。\n\n**1. 区域条件预期损失**\n\n对于一个代表损失的随机变量 $L$，若其服从正态分布 $L \\sim \\mathcal{N}(\\mu_L, \\sigma_L^2)$，则尾部概率为 $q$ 时的预期损失由以下公式给出：\n$$\n\\mathrm{ES}(q) = \\mu_L + \\sigma_L \\frac{\\phi(\\Phi^{-1}(1-q))}{q}\n$$\n其中 $\\phi(\\cdot)$ 是标准正态概率密度函数 (PDF)，$\\Phi(\\cdot)$ 是标准正态累积分布函数 (CDF)。\n\n在本问题中，区域 $s$ 的回报为 $R_s \\sim \\mathcal{N}(\\mu_s, \\sigma_s^2)$。损失为 $L_s = -R_s$，因此其分布为 $L_s \\sim \\mathcal{N}(-\\mu_s, \\sigma_s^2)$。损失的均值为 $\\mu_{L,s} = -\\mu_s$，其标准差为 $\\sigma_{L,s} = \\sigma_s$。将这些代入通用公式，得到区域条件ES：\n$$\n\\mathrm{ES}_s(q) = -\\mu_s + \\sigma_s \\frac{\\phi(z_q)}{q}\n$$\n其中 $z_q = \\Phi^{-1}(1-q)$ 是标准正态分布的 $(1-q)$-分位数。我们为高波动性 ($\\mathrm{ES}_{\\text{high}}(q)$) 和低波动性 ($\\mathrm{ES}_{\\text{low}}(q)$) 区域计算这个量，这两个区域通过比较 $\\sigma_1$ 和 $\\sigma_2$ 的值来确定。\n\n**2. 无条件混合预期损失**\n\n$\\mathrm{ES}_{\\mathrm{mix}}(q)$ 的计算是一个多步骤的过程。\n\n**步骤 2a：平稳分布**\n损失的无条件分布是两个区域条件分布的混合，由马尔可夫链的平稳概率加权。对于一个 $2 \\times 2$ 的转移矩阵 $P = \\begin{bmatrix} p_{11}  p_{12} \\\\ p_{21}  p_{22} \\end{bmatrix}$，平稳概率 $\\pi = (\\pi_1, \\pi_2)$ 通过求解线性系统 $\\pi P = \\pi$（满足 $\\pi_1 + \\pi_2 = 1$）得到。解为：\n$$\n\\pi_1 = \\frac{p_{21}}{p_{12} + p_{21}}, \\quad \\pi_2 = \\frac{p_{12}}{p_{12} + p_{21}}\n$$\n这假设了链是不可约的，即 $p_{12} + p_{21}  0$，这对所有测试用例都成立。\n\n**步骤 2b：混合分布的在险价值**\n无条件损失 $L$ 的混合CDF由 $F_L(c) = \\pi_1 F_1(c) + \\pi_2 F_2(c)$ 给出，其中 $F_s(c)$ 是区域 $s$ 中损失的CDF，$L_s \\sim \\mathcal{N}(-\\mu_s, \\sigma_s^2)$。具体而言，$F_s(c) = \\Phi\\left(\\frac{c - (-\\mu_s)}{\\sigma_s}\\right) = \\Phi\\left(\\frac{c+\\mu_s}{\\sigma_s}\\right)$。\n在险价值 $c_q$ 由条件 $\\mathbb{P}(L \\ge c_q) = q$ 定义，这等价于 $F_L(c_q) = 1-q$。这给出了关于 $c_q$ 的非线性方程：\n$$\n\\pi_1 \\Phi\\left(\\frac{c_q+\\mu_1}{\\sigma_1}\\right) + \\pi_2 \\Phi\\left(\\frac{c_q+\\mu_2}{\\sigma_2}\\right) = 1-q\n$$\n这个方程必须数值求解，例如，使用 Brent 方法。\n\n**步骤 2c：混合分布的预期损失**\n混合ES是条件期望 $\\mathrm{ES}_{\\mathrm{mix}}(q) = \\mathbb{E}[L \\mid L \\ge c_q]$。其计算方式如下：\n$$\n\\mathrm{ES}_{\\mathrm{mix}}(q) = \\frac{1}{q} \\int_{c_q}^{\\infty} c \\cdot f_L(c) \\, dc = \\frac{1}{q} \\left( \\pi_1 \\int_{c_q}^{\\infty} c \\cdot f_1(c) \\, dc + \\pi_2 \\int_{c_q}^{\\infty} c \\cdot f_2(c) \\, dc \\right)\n$$\n其中 $f_s(c)$ 是损失分布 $L_s$ 的PDF。积分 $\\int_{c_q}^{\\infty} c \\cdot f_s(c) \\, dc$ 是正态分布 $L_s$ 的一阶偏矩。对于一个正态变量 $X \\sim \\mathcal{N}(\\mu, \\sigma^2)$，该偏矩由 $\\mu \\cdot \\mathbb{P}(X  c_q) + \\sigma^2 \\cdot \\phi(c_q; \\mu, \\sigma)$ 给出。对于我们的损失 $L_s \\sim \\mathcal{N}(-\\mu_s, \\sigma_s^2)$，这变为：\n$$\n\\int_{c_q}^{\\infty} c \\cdot f_s(c) \\, dc = (-\\mu_s)\\left(1 - \\Phi\\left(\\frac{c_q+\\mu_s}{\\sigma_s}\\right)\\right) + \\sigma_s \\phi\\left(\\frac{c_q+\\mu_s}{\\sigma_s}\\right)\n$$\n通过将每个区域的这个表达式代入 $\\mathrm{ES}_{\\mathrm{mix}}(q)$ 的公式，我们得到最终值。\n\n通过为每个提供的测试用例遵循这些精确的数学步骤来实现该算法。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import norm\nfrom scipy.optimize import root_scalar\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: (mu1, sigma1, mu2, sigma2), [[p11, p12], [p21, p22]], q\n        ((0.0005, 0.01, -0.0005, 0.03), np.array([[0.95, 0.05], [0.10, 0.90]]), 0.01),\n        # Case 2\n        ((0.0, 0.01, 0.0, 0.02), np.array([[0.90, 0.10], [0.10, 0.90]]), 0.05),\n        # Case 3\n        ((0.0002, 0.005, -0.0002, 0.05), np.array([[0.995, 0.005], [0.005, 0.995]]), 0.02),\n        # Case 4\n        ((0.0001, 0.001, -0.0001, 0.04), np.array([[0.50, 0.50], [0.50, 0.50]]), 0.001),\n    ]\n\n    all_results = []\n    for params, P, q in test_cases:\n        mu1, sigma1, mu2, sigma2 = params\n        \n        # 1. Identify high/low volatility regimes.\n        if sigma1  sigma2:\n            mu_high, sigma_high = mu1, sigma1\n            mu_low, sigma_low = mu2, sigma2\n            # Regime 1 is high vol, Regime 2 is low vol\n            p11, p12, p21, p22 = P[0,0], P[0,1], P[1,0], P[1,1]\n            mu_h_orig, sigma_h_orig = mu1, sigma1\n            mu_l_orig, sigma_l_orig = mu2, sigma2\n        else:\n            mu_high, sigma_high = mu2, sigma2\n            mu_low, sigma_low = mu1, sigma1\n            # Regime 2 is high vol, Regime 1 is low vol, so we need to map stationary probabilities correctly\n            p11, p12, p21, p22 = P[0,0], P[0,1], P[1,0], P[1,1]\n            mu_h_orig, sigma_h_orig = mu2, sigma2\n            mu_l_orig, sigma_l_orig = mu1, sigma1\n\n            \n        # 2. Calculate regime-conditional Expected Shortfall.\n        def es_normal(mu, sigma, q_level):\n            \"\"\"Calculates ES for a normal loss L ~ N(-mu, sigma^2).\"\"\"\n            z_q = norm.ppf(1 - q_level)\n            es = -mu + sigma * norm.pdf(z_q) / q_level\n            return es\n\n        es_high = es_normal(mu_high, sigma_high, q)\n        es_low = es_normal(mu_low, sigma_low, q)\n        \n        # 3. Calculate unconditional mixture Expected Shortfall.\n        \n        # 3a. Stationary probabilities\n        # pi_1 = p21 / (p12 + p21), pi_2 = p12 / (p12 + p21)\n        if p12 + p21 > 0:\n            pi1 = p21 / (p12 + p21)\n            pi2 = 1.0 - pi1\n        else: # Reducible chain\n            pi1 = 1.0 if p11 == 1.0 else 0.0\n            pi2 = 1.0 - pi1\n        \n        # 3b. Find VaR of the mixture (c_q) by finding the root.\n        # Loss L_s ~ N(-mu_s, sigma_s^2)\n        # CDF of L_s is F_s(c) = norm.cdf((c - (-mu_s)) / sigma_s) = norm.cdf((c + mu_s) / sigma_s)\n        # We need to solve F_L(c) = pi1*F1(c) + pi2*F2(c) = 1 - q\n        def mixture_cdf_minus_target(c, mu1, sigma1, mu2, sigma2, pi1, pi2, q_level):\n            cdf1 = norm.cdf((c + mu1) / sigma1)\n            cdf2 = norm.cdf((c + mu2) / sigma2)\n            return pi1 * cdf1 + pi2 * cdf2 - (1.0 - q_level)\n\n        # Bracket for root finding. A wide but safe range.\n        bracket_min = min(-mu1, -mu2) - 10 * max(sigma1, sigma2)\n        bracket_max = max(-mu1, -mu2) + 10 * max(sigma1, sigma2)\n        \n        sol = root_scalar(\n            mixture_cdf_minus_target, \n            args=(mu1, sigma1, mu2, sigma2, pi1, pi2, q),\n            bracket=[bracket_min, bracket_max],\n            method='brentq'\n        )\n        c_q = sol.root\n\n        # 3c. Calculate partial expectations and the mixture ES.\n        # Partial expectation for L_s: E[L_s | L_s > c_q] * P(L_s > c_q)\n        # This is integral from c_q to infinity of x * f_s(x) dx\n        def partial_expectation(c_threshold, mu, sigma):\n            mu_loss = -mu\n            z = (c_threshold - mu_loss) / sigma\n            # Formula: mu_L * (1 - CDF(z)) + sigma * PDF(z)\n            return mu_loss * (1 - norm.cdf(z)) + sigma * norm.pdf(z)\n\n        pe1 = partial_expectation(c_q, mu1, sigma1)\n        pe2 = partial_expectation(c_q, mu2, sigma2)\n        \n        es_mix = (pi1 * pe1 + pi2 * pe2) / q\n        \n        all_results.extend([es_high, es_low, es_mix])\n\n    # Final print statement in the exact required format.\n    formatted_results = [f\"{r:.8f}\" for r in all_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "2390701"}, {"introduction": "为何监管机构和业界越来越青睐预期短缺（ES）而非更简单的风险价值（VaR）？答案在于它们在实践中的表现。本练习 [@problem_id:2374170] 通过一个精心设计的模拟，揭示了一个有趣的悖论：一个 VaR 模型可能无法通过标准的回测检验，而其关联的 ES 预测却可能非常准确。通过亲手构建这个场景，你将深刻体会到 ES 在捕捉尾部损失量级方面的优越性。", "problem": "要求您构建一个完整的确定性模拟，以证明一个具有极高质量预期短缺 (ES) 预测的模型，仍可能无法通过标准的在险价值 (VaR) 无条件覆盖回测。您的程序必须从第一性原理出发实现相关定义和逻辑，并且不得依赖任何外部数据或用户输入。\n\n定义和要求：\n- 将在险价值 (VaR) 在置信水平 $c$ 下定义为损失分布在水平 $c$ 上的上分位数，因此如果 $L$ 表示损失，则 $\\mathrm{VaR}_c$ 是满足 $\\mathbb{P}(L \\le v) = c$ 的唯一值 $v$。等价地，对于尾部概率 $\\alpha := 1 - c$，$\\mathrm{VaR}_c$ 是使得 $\\mathbb{P}(L  v) = \\alpha$ 的阈值 $v$。\n- 将预期短缺 (ES) 在置信水平 $c$ 下定义为损失超过 $\\mathrm{VaR}_c$ 时的条件期望，即 $\\mathrm{ES}_c := \\mathbb{E}[L \\mid L  \\mathrm{VaR}_c]$。\n- “VaR 无条件覆盖回测”是基于超出指标序列 $I_t := \\mathbf{1}\\{L_t  v\\}$ 的评估，其原假设为 $\\mathbb{P}(I_t = 1) = \\alpha$ 在时间上独立。标准的无条件覆盖检验评估在固定的显著性水平下，观测到的超出次数 $x := \\sum_{t=1}^T I_t$ 是否与原假设一致。您的任务是实现无条件覆盖似然比检验，并在显著性水平为 $0.05$ 时，如果原假设被拒绝，则声明“失败”(fail)，否则声明“通过”(pass)。\n- 为量化 ES 预测质量，当 $x \\ge 1$ 时，计算已实现的尾部均值 $\\widehat{\\mathrm{ES}} := \\frac{1}{x} \\sum_{t: L_t  v} L_t$，并将其与模型的 ES 预测值 $e$进行比较。定义相对误差 $\\varepsilon := \\lvert \\widehat{\\mathrm{ES}} - e \\rvert / e$。对于给定的容忍度 $\\tau$，如果 $\\varepsilon \\le \\tau$，则声明 ES 为“极高质量”。\n\n用于演示该悖论的模拟设计：\n- “模型”将产生恒定的预测值 $(v, e)$，如同损失服从标准正态分布一样。具体来说，取损失 $Z$ 从标准正态分布中抽取，定义 $v$ 为 $Z$ 的 $c$-分位数，定义 $e$ 为条件均值 $e := \\mathbb{E}[Z \\mid Z  v]$。这些 $(v, e)$ 是模型在整个回测期间的恒定预测值。\n- 真实的数据生成过程 (DGP) 有意地违反了 VaR 的无条件覆盖，同时保持 ES 预测近似正确：\n  1. 固定尾部概率 $\\alpha$ 和置信水平 $c := 1 - \\alpha$。固定尾部膨胀因子 $r \\ge 1$ 和样本量 $T$。将超出次数确定性地设置为 $x := \\mathrm{round}(r \\cdot \\alpha \\cdot T)$，非超出次数为 $T - x$。这使得超出频率在四舍五入后等于 $r \\cdot \\alpha$。\n  2. 对于 $x$ 次超出损失，从广义帕累托分布 (GPD) 中抽样，该分布用于描述超过阈值 $v$ 的部分，其形状参数为 $\\xi \\in (0, 1)$，尺度参数 $\\beta$ 的选择使得条件均值等于模型的预测值 $e$。如果 $W \\sim \\mathrm{GPD}(\\xi, \\beta)$ 表示超额部分且 $L := v + W$，则 $\\mathbb{E}[L \\mid L  v] = v + \\beta/(1 - \\xi)$。通过设置 $\\beta := (e - v)\\,(1 - \\xi)$ 来强制 $v + \\beta/(1 - \\xi) = e$。\n  3. 对于 $T - x$ 次非超出损失，从区间 $[0, v]$ 上的均匀分布中独立抽样，这保证了它们不会超过 $v$。\n- 这种构造确保了已实现的超出概率近似为 $r \\cdot \\alpha$，当 $r$ 足够大于 $1$ 时，这将引发无条件覆盖检验的失败，然而根据构造，超出损失的条件均值与模型的 ES 相匹配，使得 ES 非常准确。\n\n测试与报告：\n- 使用固定的随机种子以确保模拟是确定性和可复现的。您必须在显著性水平 $0.05$ 下实现无条件覆盖似然比检验，使用原假设下和经验超出率下的精确伯努利似然，并与自由度为1的卡方临界值进行比较。\n- 对于 ES 质量，使用下面每个测试案例中指定的相对误差阈值 $\\tau$。如果没有超出（$x = 0$），则任意定义 $\\widehat{\\mathrm{ES}}$ 并将 ES 质量设置为“非高质量”；然而，所提供的测试套件确保 $x \\ge 1$。\n\n测试套件：\n- 所有案例的通用参数：尾部概率 $\\alpha = 0.01$，VaR 测试的显著性水平 $0.05$，GPD 形状参数 $\\xi = 0.10$，以及 ES 容忍度 $\\tau = 0.05$。模型置信水平为 $c = 1 - \\alpha = 0.99$。\n- 案例 1 (理想情况)：$T = 5000, r = 1.0$。\n- 案例 2 (悖论)：$T = 5000, r = 2.0$。\n- 案例 3 (低功效边界情况)：$T = 5000, r = 1.2$。\n\n要求输出：\n- 对每个案例，计算两个布尔值：\n  1. VaR 回测失败（如果在显著性水平 $0.05$ 下拒绝无条件覆盖的原假设，则为 True，否则为 False）。\n  2. ES 高质量指标（如果 $\\varepsilon \\le \\tau$，则为 True，否则为 False）。\n- 您的程序应生成一行输出，其中包含按案例和指标顺序排列的六个布尔值，格式为用方括号括起来的逗号分隔列表，顺序如下：$[\\text{VaRFail}_1,\\text{ESGood}_1,\\text{VaRFail}_2,\\text{ESGood}_2,\\text{VaRFail}_3,\\text{ESGood}_3]$。仅为示例格式：$[\\text{True},\\text{False},\\dots]$。\n\n约束条件：\n- 程序必须是完全自包含和确定性的。\n- 所有随机抽样必须使用您选择的固定种子执行，并且超出计数必须按规定确定性地设置为 $x := \\mathrm{round}(r \\cdot \\alpha \\cdot T)$。", "solution": "问题陈述是有效的。它在科学上基于金融风险管理的原则，特别是关于在险价值（VaR）和预期短缺（ES）模型的回测。所提供的 VaR、ES、无条件覆盖检验和广义帕累托分布（GPD）的定义都是标准且数学上正确的。该模拟设计是一个精心设定的计算实验，旨在演示一个已知的、不平凡的现象，即一个模型可以在产出高质量 ES 预测的同时，未通过 VaR 回测。该问题是自包含的，所有必要的参数和程序都已指定，且没有矛盾或含糊之处。\n\n以下是推理过程的解决方案。\n\n核心任务是构建一个确定性模拟，以证明一个模型的在险价值（$\\mathrm{VaR}$）和预期短缺（$\\mathrm{ES}$）预测在回测中可能收到相互矛盾的评估。具体来说，模拟必须展示一个场景，其中 $\\mathrm{VaR}$ 预测被拒绝，但 $\\mathrm{ES}$ 预测被认为是高度准确的。\n\n首先，我们为模型预测、数据生成过程（DGP）和统计检验建立理论基础。\n\n**1. 模型预测**\n\n“模型”被定义为为 $\\mathrm{VaR}$ 和 $\\mathrm{ES}$ 分别生成恒定的预测值 $(v, e)$。这些预测是基于金融损失 $L$ 服从标准正态分布 $Z \\sim N(0, 1)$ 的假设得出的。\n\n置信水平为 $c = 1 - \\alpha$，其中 $\\alpha = 0.01$。因此，$c = 0.99$。\n$\\mathrm{VaR}$ 预测值 $v$ 是标准正态分布的 $c$-分位数：\n$$v = \\Phi^{-1}(c) = \\Phi^{-1}(0.99)$$\n其中 $\\Phi^{-1}$ 是标准正态分布的分位数函数（逆累积分布函数）。\n\n$\\mathrm{ES}$ 预测值 $e$ 是在损失超过 $\\mathrm{VaR}$ 阈值 $v$ 的条件下的损失期望值：\n$$e = \\mathbb{E}[Z \\mid Z  v]$$\n对于标准正态分布，这有一个著名的闭式解：\n$$e = \\frac{\\phi(v)}{1 - c} = \\frac{\\phi(v)}{\\alpha}$$\n其中 $\\phi$ 是标准正态分布的概率密度函数（PDF）。这些值 $v$ 和 $e$ 在整个模拟中都是常数。\n\n**2. 数据生成过程 (DGP)**\n\n模拟的 DGP 被设计为以一种受控的方式偏离模型的假设。它生成一个包含 $T$ 次损失的时间序列。\n\n$\\mathrm{VaR}$ 的超出次数 $x$ 是基于尾部膨胀因子 $r$ 确定性地设置的：\n$$x = \\mathrm{round}(r \\cdot \\alpha \\cdot T)$$\n相应的非超出次数为 $T-x$。这种构造直接操纵了经验超出频率，使其近似为 $r \\cdot \\alpha$。\n\n损失本身由两种不同的分布生成：\n- **超出损失（$x$ 个样本）：**超过模型 $\\mathrm{VaR}$ 预测值 $v$ 的损失形式为 $L_t = v + W_t$，其中 $W_t$ 是超过阈值的超额损失。$W_t$ 从广义帕累托分布中抽样，$W_t \\sim \\mathrm{GPD}(\\xi, \\beta)$。问题指定了形状参数 $\\xi = 0.10$。选择尺度参数 $\\beta$ 是为了强制使超出损失的条件均值与模型的 $\\mathrm{ES}$ 预测值 $e$ 相匹配。一个 $\\mathrm{GPD}(\\xi, \\beta)$ 的均值为 $\\mathbb{E}[W_t] = \\beta / (1 - \\xi)$，对于 $\\xi  1$。因此，我们强制：\n$$\\mathbb{E}[L_t \\mid L_t  v] = v + \\mathbb{E}[W_t] = v + \\frac{\\beta}{1 - \\xi} = e$$\n求解尺度参数 $\\beta$ 可得：\n$$\\beta = (e - v)(1 - \\xi)$$\n$\\beta$ 的这一选择是此悖论的核心：尾部损失的分布被构造成其均值精确匹配模型的（错误推导的）$\\mathrm{ES}$ 预测值。为了从这个 GPD 生成随机变量 $W$，我们使用逆变换采样法。对于一个均匀随机变量 $u \\sim U(0,1)$，GPD 的逆累积分布函数（分位数函数）是 $F^{-1}(u) = \\frac{\\beta}{\\xi}((1-u)^{-\\xi} - 1)$。\n\n- **非超出损失（$T-x$ 个样本）：**这些损失从区间 $[0, v]$ 上的均匀分布中抽样。这个简单的选择保证了这些损失总是小于或等于 $v$，因此永远不会构成 $\\mathrm{VaR}$ 超出。\n\n**3. 回测程序**\n\n对生成的 $T$ 次损失序列执行两个独立的测试。\n\n- **VaR 回测（无条件覆盖）：**由 Kupiec 提出的无条件覆盖检验，评估原假设 $H_0$：即在任何给定日期发生 $\\mathrm{VaR}$ 超出的概率为 $\\alpha$，即 $p = \\alpha$。该检验基于似然比（LR）统计量。观测到 $T$ 个样本中有 $x$ 次超出的似然函数由二项概率质量函数 $L(p; x, T) = p^x (1-p)^{T-x}$ 给出。LR 统计量将原假设（$p=\\alpha$）下的似然与备择假设下的似然进行比较，其中 $p$ 由其最大似然估计 $\\hat{p} = x/T$ 估算。该统计量为：\n$$LR_{uc} = 2 \\ln\\left(\\frac{L(\\hat{p})}{L(\\alpha)}\\right) = 2 \\left[ \\ln(L(\\hat{p})) - \\ln(L(\\alpha)) \\right]$$\n$$LR_{uc} = 2 \\left[ x \\ln\\left(\\frac{x}{T}\\right) + (T-x) \\ln\\left(1 - \\frac{x}{T}\\right) - x \\ln(\\alpha) - (T-x) \\ln(1 - \\alpha) \\right]$$\n在 $H_0$ 下，该统计量渐近服从自由度为 1 的卡方分布 $\\chi^2_1$。如果 $LR_{uc}$ 超过临界值 $\\chi^2_{1, 0.95} \\approx 3.841$，则在显著性水平 $0.05$ 下拒绝原假设。拒绝意味着 VaR 模型未能通过回测。\n\n- **ES 质量评估：**ES 预测值 $e$ 的质量通过将其与已实现的超出损失均值 $\\widehat{\\mathrm{ES}}$ 进行比较来评估。\n$$\\widehat{\\mathrm{ES}} = \\frac{1}{x} \\sum_{t: L_t  v} L_t$$\n相对误差 $\\varepsilon$ 计算如下：\n$$\\varepsilon = \\frac{\\lvert \\widehat{\\mathrm{ES}} - e \\rvert}{e}$$\n如果该误差在给定的容忍度 $\\tau = 0.05$ 内，即 $\\varepsilon \\le 0.05$，则认为 ES 预测是“高质量”的。\n\n**4. 模拟执行**\n\n模拟通过对三个测试案例中的每一个执行上述步骤来进行。使用固定的随机种子以确保结果是确定性和可复现的。\n\n- **案例 1 ($r=1.0$)：** $x = \\mathrm{round}(1.0 \\cdot 0.01 \\cdot 5000) = 50$。经验超出率 $\\hat{p} = 50/5000 = 0.01$，这恰好是 $\\alpha$。$LR_{uc}$ 统计量为 $0$，低于临界值。$\\mathrm{VaR}$ 检验会通过。由于大数定律，已实现的 ES，即 $\\widehat{\\mathrm{ES}}$，将接近真实均值 $e$，可能导致误差 $\\varepsilon$ 很小，从而获得高质量的评估。\n- **案例 2 ($r=2.0$)：** $x = \\mathrm{round}(2.0 \\cdot 0.01 \\cdot 5000) = 100$。经验比率 $\\hat{p} = 100/5000 = 0.02$，是假设的 $\\alpha$ 的两倍。这种巨大的差异将导致一个很大的 $LR_{uc}$ 统计量，从而使 $\\mathrm{VaR}$ 检验失败。然而，DGP 的构造仍然使得超出损失的条件均值为 $e$。因此，$\\widehat{\\mathrm{ES}}$ 预计将接近 $e$，并且 $\\mathrm{ES}$ 预测将被认为是高质量的。这是核心的悖论结果。\n- **案例 3 ($r=1.2$)：** $x = \\mathrm{round}(1.2 \\cdot 0.01 \\cdot 5000) = 60$。经验比率 $\\hat{p} = 60/5000 = 0.012$。与 $\\alpha$ 的偏差很小。由此产生的 $LR_{uc}$ 统计量可能不够大，不足以超过临界值，这展示了一个低功效的情景，其中 $\\mathrm{VaR}$ 检验未能检测到偏差。ES 质量预计将保持很高。\n\n实现将计算这些结果并报告指定的布尔值。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import norm, chi2\n\ndef solve():\n    \"\"\"\n    Runs a deterministic simulation to demonstrate that a model with high-quality\n    Expected Shortfall (ES) forecasts can fail a standard Value-at-Risk (VaR)\n    backtest for unconditional coverage.\n    \"\"\"\n    # Use a fixed random seed for deterministic and reproducible results.\n    SEED = 42\n    rng = np.random.default_rng(SEED)\n\n    # --- Common parameters from the problem statement ---\n    alpha = 0.01            # Tail probability\n    var_test_sig_level = 0.05 # Significance level for the VaR LR test\n    xi = 0.10               # GPD shape parameter\n    tau = 0.05              # Relative error tolerance for ES quality\n    \n    # Confidence level for VaR and ES\n    c = 1 - alpha\n    \n    # --- Step 1: Calculate the model's constant forecasts (v, e) ---\n    # The model assumes losses are standard normal Z ~ N(0, 1).\n    # v is the c-quantile of the standard normal distribution.\n    v = norm.ppf(c)\n    # e is the expected value of Z given Z  v.\n    e = norm.pdf(v) / alpha\n    \n    # --- Pre-calculate the critical value for the LR test ---\n    # The LR statistic is asymptotically chi-square distributed with 1 df.\n    chi2_critical_value = chi2.ppf(1 - var_test_sig_level, df=1)\n\n    # --- Define the test cases ---\n    test_cases = [\n        # (T, r)\n        (5000, 1.0),  # Case 1: Ideal case\n        (5000, 2.0),  # Case 2: Paradox\n        (5000, 1.2),  # Case 3: Low-power boundary case\n    ]\n\n    results = []\n    \n    # --- Step 2: Run simulation for each test case ---\n    for T, r in test_cases:\n        # --- a. Determine exceedance count deterministically ---\n        x = int(np.round(r * alpha * T))\n        T_minus_x = T - x\n\n        # The test cases provided guarantee that 0  x  T.\n\n        # --- b. Generate simulated losses based on the true DGP ---\n        \n        # Exceedance losses: drawn from a GPD to match the model's ES 'e'\n        # The GPD scale parameter beta is chosen to match the conditional mean.\n        # E[L | L > v] = v + beta / (1 - xi) = e\n        beta = (e - v) * (1 - xi)\n        \n        # Generate GPD variates using inverse transform sampling (first principles)\n        # W = (beta / xi) * ((1 - U)^(-xi) - 1) for U ~ U(0,1)\n        u_samples_gpd = rng.uniform(size=x)\n        excess_losses = (beta / xi) * (np.power(1 - u_samples_gpd, -xi) - 1)\n        exceedance_losses = v + excess_losses\n        \n        # Non-exceedance losses are not needed for the tests but complete the DGP.\n        # non_exceedance_losses = rng.uniform(low=0.0, high=v, size=T_minus_x)\n\n        # --- c. Perform VaR unconditional coverage backtest ---\n        p_hat = x / T\n        \n        # Log-likelihood under the alternative hypothesis (p = p_hat)\n        log_L1 = x * np.log(p_hat) + T_minus_x * np.log(1 - p_hat)\n        # Log-likelihood under the null hypothesis (p = alpha)\n        log_L0 = x * np.log(alpha) + T_minus_x * np.log(1 - alpha)\n        \n        # Likelihood-ratio statistic\n        lr_uc_statistic = 2 * (log_L1 - log_L0)\n        \n        # VaR backtest fails if the statistic exceeds the critical value\n        var_fail = lr_uc_statistic  chi2_critical_value\n        results.append(var_fail)\n\n        # --- d. Evaluate ES forecast quality ---\n        # Realized tail average (sample mean of exceedance losses)\n        es_hat = np.mean(exceedance_losses)\n        \n        # Relative error of the ES forecast\n        epsilon = np.abs(es_hat - e) / e\n        \n        # ES forecast is high-quality if the relative error is within tolerance\n        es_good = epsilon = tau\n        results.append(es_good)\n        \n    # --- Final print statement in the exact required format ---\n    # Convert Python boolean True/False to lowercase string \"true\"/\"false\" as per similar problems\n    # Upon review, the example format [True,False,...] uses standard Python bool __str__ representation.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "2374170"}]}