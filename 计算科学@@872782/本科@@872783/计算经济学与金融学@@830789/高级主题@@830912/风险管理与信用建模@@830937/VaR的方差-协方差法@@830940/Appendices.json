{"hands_on_practices": [{"introduction": "第一个练习是基础实践，旨在将理论上的VaR公式转化为可执行的计算机程序。通过为几种假设的投资组合计算风险价值，你将具体地理解投资组合权重 $w$、预期收益 $\\mu$ 和协方差矩阵 $\\Sigma$ 是如何共同决定整体风险的。这个练习将帮助你巩固方差-协方差方法的核心计算机制。", "problem": "给定一个包含 $N$ 种资产的投资组合，其线性敞口向量为 $w \\in \\mathbb{R}^{N}$，日资产收益率向量为 $r \\in \\mathbb{R}^{N}$，日均收益率向量为 $\\mu \\in \\mathbb{R}^{N}$，日方差-协方差矩阵为 $\\Sigma \\in \\mathbb{R}^{N \\times N}$。假设 $r$ 服从均值为 $\\mu$、协方差为 $\\Sigma$ 的多元正态分布。单日投资组合收益率为 $R_{p} = w^{\\top} r$，单日投资组合损失（与投资组合价值的货币单位相同）为 $L = -V \\, R_{p}$，其中 $V \\in \\mathbb{R}_{+}$ 是当前投资组合价值。将在险价值 (VaR) 定义为在尾部概率 $\\alpha \\in (0,1)$ 下的数值 $v$，使得 $\\mathbb{P}(L > v) = \\alpha$。所有概率都是无单位的。所有收益率均以小数表示，不带百分号。\n\n编写一个完整的程序，使用方差-协方差法，在正态性假设下，为以下每个测试用例计算单日在险价值。每个结果必须以与 $V$ 相同的货币单位表示，并四舍五入到两位小数。您的程序必须生成单行输出，其中包含用方括号括起来的逗号分隔的结果列表（例如，$[x_{1},x_{2},x_{3}]$），且不含空格。\n\n测试套件：\n- 用例 $1$（一般多资产情况）：\n  - $N = 3$\n  - $w = [\\,0.5,\\,0.3,\\,0.2\\,]$\n  - $\\mu = [\\,0.0005,\\,0.0002,\\,-0.0001\\,]$\n  - $\\Sigma = \\begin{bmatrix}\n  0.000225  0.00003  0.00015 \\\\\n  0.00003  0.0001  0.00006 \\\\\n  0.00015  0.00006  0.0004\n  \\end{bmatrix}$\n  - $V = 1000000$\n  - $\\alpha = 0.01$\n- 用例 $2$（完全对冲，零方差）：\n  - $N = 2$\n  - $w = [\\,0.5,\\,-0.5\\,]$\n  - $\\mu = [\\,0.0002,\\,0.0002\\,]$\n  - $\\Sigma = \\begin{bmatrix}\n  0.0001  0.0001 \\\\\n  0.0001  0.0001\n  \\end{bmatrix}$\n  - $V = 2000000$\n  - $\\alpha = 0.01$\n- 用例 $3$（单资产情况）：\n  - $N = 1$\n  - $w = [\\,1.0\\,]$\n  - $\\mu = [\\,-0.0003\\,]$\n  - $\\Sigma = \\begin{bmatrix} 0.0009 \\end{bmatrix}$\n  - $V = 500000$\n  - $\\alpha = 0.05$\n\n您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔的结果列表（例如，$[result1,result2,result3]$）。每个 $resulti$ 必须是四舍五入到两位小数的浮点数。不应打印其他文本。", "solution": "该问题要求使用方差-协方差法计算一个包含 $N$ 种资产的投资组合的单日在险价值 ($VaR$)。该问题定义明确，科学上合理，并为获得唯一解提供了所有必要数据。核心假设是日资产收益率向量 $r$ 服从多元正态分布，$r \\sim \\mathcal{N}(\\mu, \\Sigma)$。\n\n首先，我们必须确定单日投资组合收益率 $R_{p}$ 的统计分布。投资组合收益率是单个资产收益率的线性组合，由方程 $R_{p} = w^{\\top} r$ 指定，其中 $w$ 是投资组合权重向量。多元正态分布的一个基本性质是其分量的任何线性组合也服从正态分布。因此，$R_{p}$ 服从单变量正态分布。\n\n投资组合收益率的均值 $\\mu_{p}$ 是 $R_{p}$ 的期望值：\n$$ \\mu_{p} = \\mathbb{E}[R_{p}] = \\mathbb{E}[w^{\\top} r] = w^{\\top} \\mathbb{E}[r] = w^{\\top} \\mu $$\n投资组合收益率的方差 $\\sigma_{p}^2$ 由下式给出：\n$$ \\sigma_{p}^2 = \\text{Var}(R_{p}) = \\text{Var}(w^{\\top} r) = w^{\\top} \\text{Var}(r) w = w^{\\top} \\Sigma w $$\n因此，投资组合收益率的分布为 $R_{p} \\sim \\mathcal{N}(\\mu_{p}, \\sigma_{p}^2)$。\n\n接下来，我们考虑投资组合损失 $L$，其定义为 $L = -V R_{p}$，其中 $V$ 是当前投资组合价值。由于 $L$ 是正态分布变量 $R_{p}$ 的线性变换，因此 $L$ 也服从正态分布。\n损失的均值 $\\mu_{L}$ 为：\n$$ \\mu_{L} = \\mathbb{E}[L] = \\mathbb{E}[-V R_{p}] = -V \\mathbb{E}[R_{p}] = -V \\mu_{p} = -V w^{\\top} \\mu $$\n损失的方差 $\\sigma_{L}^2$ 为：\n$$ \\sigma_{L}^2 = \\text{Var}(L) = \\text{Var}(-V R_{p}) = (-V)^2 \\text{Var}(R_{p}) = V^2 \\sigma_{p}^2 = V^2 (w^{\\top} \\Sigma w) $$\n损失的标准差为 $\\sigma_{L} = V \\sigma_{p} = V \\sqrt{w^{\\top} \\Sigma w}$。\n所以，投资组合损失的分布为 $L \\sim \\mathcal{N}(\\mu_{L}, \\sigma_{L}^2)$。\n\n在尾部概率为 $\\alpha$ 时的在险价值，记为 $v$，由条件 $\\mathbb{P}(L > v) = \\alpha$ 定义。为了求解 $v$，我们对正态随机变量 $L$ 进行标准化。令 $Z$ 为标准正态变量，$Z \\sim \\mathcal{N}(0, 1)$。我们可以将 $L$ 表示为 $L = \\mu_{L} + \\sigma_{L} Z$。概率陈述变为：\n$$ \\mathbb{P}(\\mu_{L} + \\sigma_{L} Z > v) = \\alpha $$\n假设 $\\sigma_{L} > 0$，我们整理不等式：\n$$ \\mathbb{P}\\left(Z > \\frac{v - \\mu_{L}}{\\sigma_{L}}\\right) = \\alpha $$\n令 $z_{\\alpha}$ 为标准正态分布的上$\\alpha$-分位数，即满足 $\\mathbb{P}(Z > z_{\\alpha}) = \\alpha$ 的值。该值等价于在 $1 - \\alpha$ 处求值的累积分布函数 (CDF) $\\Phi$ 的反函数，即 $z_{\\alpha} = \\Phi^{-1}(1 - \\alpha)$。\n通过令概率函数的参数相等，我们得到：\n$$ \\frac{v - \\mu_{L}}{\\sigma_{L}} = z_{\\alpha} $$\n求解 $v$ 即可得到 $VaR_{\\alpha}$ 的公式：\n$$ v = \\text{VaR}_{\\alpha} = \\mu_{L} + z_{\\alpha} \\sigma_{L} $$\n代入 $\\mu_{L}$ 和 $\\sigma_{L}$ 的表达式，我们得到最终的计算公式：\n$$ \\text{VaR}_{\\alpha} = -V (w^{\\top} \\mu) + z_{\\alpha} V \\sqrt{w^{\\top} \\Sigma w} $$\n这可以重写为：\n$$ \\text{VaR}_{\\alpha} = V (z_{\\alpha} \\sigma_{p} - \\mu_{p}) $$\n在投资组合方差 $\\sigma_{p}^2 = 0$ 的特殊情况下，投资组合收益率是确定性的：$R_{p} = \\mu_{p}$。损失也是确定性的，$L = -V\\mu_{p}$。分位数的广义定义得出，对于任何 $\\alpha \\in (0,1)$，$\\text{VaR}_{\\alpha} = -V\\mu_{p}$，这与通用公式在含 $\\sigma_{p}$ 的项变为零时的情况是一致的。\n\n解决每个测试用例的算法如下：\n$1$. 对于给定的参数集 $\\{w, \\mu, \\Sigma, V, \\alpha\\}$，首先计算投资组合的平均收益率 $\\mu_{p} = w^{\\top} \\mu$。\n$2$. 计算投资组合收益率的方差 $\\sigma_{p}^2 = w^{\\top} \\Sigma w$。\n$3$. 计算投资组合收益率的标准差 $\\sigma_{p} = \\sqrt{\\sigma_{p}^2}$。\n$4$. 使用数值函数计算 $\\Phi^{-1}(1 - \\alpha)$，确定与尾部概率 $\\alpha$ 对应的标准正态分位数 $z_{\\alpha}$。\n$5$. 使用公式 $\\text{VaR}_{\\alpha} = V(z_{\\alpha} \\sigma_{p} - \\mu_{p})$ 计算 $VaR$。\n$6$. 将最终结果四舍五入到两位小数。\n此过程将应用于所提供的三个测试用例中的每一个。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import norm\n\ndef solve():\n    \"\"\"\n    Computes the one-day Value-at-Risk for a portfolio using the\n    variance-covariance method under the normality assumption.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1 (general multi-asset case)\n        {\n            \"w\": np.array([0.5, 0.3, 0.2]),\n            \"mu\": np.array([0.0005, 0.0002, -0.0001]),\n            \"Sigma\": np.array([\n                [0.000225, 0.00003, 0.00015],\n                [0.00003, 0.0001, 0.00006],\n                [0.00015, 0.00006, 0.0004]\n            ]),\n            \"V\": 1000000.0,\n            \"alpha\": 0.01\n        },\n        # Case 2 (perfect hedge, zero variance)\n        {\n            \"w\": np.array([0.5, -0.5]),\n            \"mu\": np.array([0.0002, 0.0002]),\n            \"Sigma\": np.array([\n                [0.0001, 0.0001],\n                [0.0001, 0.0001]\n            ]),\n            \"V\": 2000000.0,\n            \"alpha\": 0.01\n        },\n        # Case 3 (single-asset case)\n        {\n            \"w\": np.array([1.0]),\n            \"mu\": np.array([-0.0003]),\n            \"Sigma\": np.array([[0.0009]]),\n            \"V\": 500000.0,\n            \"alpha\": 0.05\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        w = case[\"w\"]\n        mu = case[\"mu\"]\n        Sigma = case[\"Sigma\"]\n        V = case[\"V\"]\n        alpha = case[\"alpha\"]\n\n        # 1. Calculate portfolio mean return (mu_p)\n        # mu_p = w^T * mu\n        mu_p = w.T @ mu\n\n        # 2. Calculate portfolio variance of return (sigma_p^2)\n        # sigma_p_sq = w^T * Sigma * w\n        sigma_p_sq = w.T @ Sigma @ w\n\n        # 3. Calculate portfolio standard deviation of return (sigma_p)\n        sigma_p = np.sqrt(sigma_p_sq)\n\n        # 4. Find the standard normal quantile for the given confidence level\n        # z_alpha = Phi^-1(1 - alpha)\n        z_alpha = norm.ppf(1 - alpha)\n\n        # 5. Compute the Value-at-Risk (VaR)\n        # VaR = V * (z_alpha * sigma_p - mu_p)\n        var_value = V * (z_alpha * sigma_p - mu_p)\n\n        # Format the result to two decimal places.\n        results.append(f\"{var_value:.2f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```", "id": "2447014"}, {"introduction": "在掌握了基础计算之后，这个练习将引导你更进一步，将风险度量与投资组合构建相结合。在现实世界的金融实践中，投资组合的权重并非随意给定，而通常是优化过程的结果，例如经典的马科维茨均值-方差优化。这个问题要求你首先通过求解一个优化问题来确定最优的投资组合权重，然后在该*有效*投资组合的基础上计算其风险价值（VaR）。", "problem": "给定一个投资组合选择问题，其中投资组合权重 $w$ 必须通过求解 Markowitz 均值-方差优化来选择。假设资产收益率服从联合高斯分布，且投资组合与权重呈线性关系。目标是使用方差-协方差法为几个测试用例计算风险价值 (VaR)。适用以下定义和假设。\n\n- 令 $n$ 表示资产数量。令期望收益向量为 $\\mu \\in \\mathbb{R}^n$，协方差矩阵为 $\\Sigma \\in \\mathbb{R}^{n \\times n}$，其中 $\\Sigma$ 是对称正定矩阵。令目标投资组合期望收益为 $r_{\\text{target}} \\in \\mathbb{R}$。令投资组合价值为 $V \\in \\mathbb{R}_{+}$。令期限（单位与 $\\mu$ 和 $\\Sigma$ 的单位匹配）为 $h \\in \\mathbb{N}$。令置信水平为 $c \\in (0,1)$。所有收益均表示为每期的十进制小数。\n\n- 确定 $w \\in \\mathbb{R}^n$ 的 Markowitz 均值-方差问题如下：\n  最小化投资组合方差，约束条件为达到目标期望收益和全额投资：\n  $$\\min_{w \\in \\mathbb{R}^n} \\; w^{\\top} \\Sigma \\, w \\quad \\text{subject to} \\quad \\mu^{\\top} w = r_{\\text{target}}, \\quad \\mathbf{1}^{\\top} w = 1.$$\n  其中 $\\mathbf{1} \\in \\mathbb{R}^n$ 是全为 1 的向量。\n\n- 在多元正态收益假设下，使用方差-协方差法，投资组合收益 $R_p$ 服从高斯分布，其均值为 $\\mu_p = \\mu^{\\top} w$，方差为 $\\sigma_p^2 = w^{\\top} \\Sigma \\, w$。在期限 $h$ 内，假设增量是独立同分布 (i.i.d.) 的，因此 $h$ 期的均值和标准差分别为 $\\mu_h = h \\, \\mu_p$ 和 $\\sigma_h = \\sqrt{h} \\, \\sigma_p$。对于置信水平 $c$，令 $z_c$ 表示标准正态分布的 $c$-分位数。将投资组合损失定义为 $L = - V \\, R_p$。您的任务是使用方差-协方差法计算置信水平为 $c$ 的参数风险价值 (VaR)，以货币单位表示。\n\n您的程序必须为每个测试用例精确求解上述指定的 Markowitz 优化问题，然后相应地计算 VaR，并输出结果。\n\n测试套件。对于以下每种情况，计算一个 VaR 值。\n\n- 情况 1（正常路径，4 种资产）：\n  - $\\mu = [\\, 0.01, \\, 0.015, \\, 0.02, \\, 0.012 \\,]$\n  - $\\Sigma = \\begin{bmatrix}\n    0.0030  0.0012  0.0011  0.0009 \\\\\n    0.0012  0.0040  0.0013  0.0010 \\\\\n    0.0011  0.0013  0.0050  0.0012 \\\\\n    0.0009  0.0010  0.0012  0.0035\n  \\end{bmatrix}$\n  - $r_{\\text{target}} = 0.015$\n  - $V = 1000000$\n  - $h = 1$\n  - $c = 0.99$\n\n- 情况 2（有效前沿上的边界点，4 种资产）：使用与情况 1 相同的 $\\mu$ 和 $\\Sigma$，但将目标期望收益设置为由 $\\mu$ 和 $\\Sigma$ 所蕴含的全局最小方差投资组合的期望收益。即，计算\n  $$r_{\\text{target}} = \\frac{B}{A}, \\quad \\text{where} \\quad A = \\mathbf{1}^{\\top} \\Sigma^{-1} \\mathbf{1}, \\quad B = \\mathbf{1}^{\\top} \\Sigma^{-1} \\mu.$$\n  使用\n  - $V = 1000000$\n  - $h = 1$\n  - $c = 0.95$\n\n- 情况 3（期限缩放和不同维度，3 种资产）：\n  - $\\mu = [\\, 0.008, \\, 0.011, \\, 0.0095 \\,]$\n  - $\\Sigma = \\begin{bmatrix}\n    0.0025  -0.0003  0.0004 \\\\\n    -0.0003  0.0030  -0.0002 \\\\\n    0.0004  -0.0002  0.0020\n  \\end{bmatrix}$\n  - $r_{\\text{target}} = 0.0105$\n  - $V = 2000000$\n  - $h = 3$\n  - $c = 0.975$\n\n要求。\n\n- 仅使用上述明确说明的数学假设和约束条件。不要引入额外的约束，如卖空限制；允许 $w$ 取满足线性约束的任何实数值。\n\n- 您的程序必须：\n  1. 对于每个测试用例，从第一性原理出发，使用线性代数推导求解所述的均值-方差优化问题以得到 $w$。\n  2. 计算期限为 $h$、置信水平为 $c$ 的 VaR，以货币单位表示（与 $V$ 的单位相同）。将最终数值表示为浮点值（小数）。\n  3. 将三个 VaR 结果汇总到单行输出中，形式为用方括号括起来的逗号分隔列表，顺序为情况 1、2、3，例如 $[x_1,x_2,x_3]$。", "solution": "问题陈述已分析并被认为是有效的。它在科学上基于金融数学的既定原理，特别是 Markowitz 投资组合理论和参数风险价值 (VaR) 计算。该问题是适定的、客观的，并为获得唯一解提供了所有必要的数据。所提供的协方差矩阵是对称正定的，确保了优化问题有合规的解。\n\n解决方案分两部分展开：首先，求解 Markowitz 均值-方差优化问题；其次，使用方差-协方差法计算投资组合的 VaR。\n\nMarkowitz 优化问题表述如下：\n$$\n\\min_{w \\in \\mathbb{R}^n} \\; \\sigma_p^2 = w^{\\top} \\Sigma w\n$$\n受两个线性约束：\n$$\n\\mu^{\\top} w = r_{\\text{target}} \\quad (\\text{目标收益})\n$$\n$$\n\\mathbf{1}^{\\top} w = 1 \\quad (\\text{全额投资})\n$$\n其中 $w$ 是投资组合权重向量，$\\mu$ 是期望资产收益向量，$\\Sigma$ 是资产收益的协方差矩阵，$r_{\\text{target}}$ 是期望的投资组合期望收益，$\\mathbf{1}$ 是全为 1 的向量。\n\n这是一个有约束的二次优化问题。我们使用拉格朗日乘数法来求解。拉格朗日函数 $\\mathcal{L}$ 为：\n$$\n\\mathcal{L}(w, \\lambda_1, \\lambda_2) = w^{\\top} \\Sigma w - 2\\lambda_1 (\\mu^{\\top} w - r_{\\text{target}}) - 2\\lambda_2 (\\mathbf{1}^{\\top} w - 1)\n$$\n引入因子 $2$ 是为了代数计算上的方便。关于权重向量 $w$ 的一阶条件是：\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial w} = 2 \\Sigma w - 2\\lambda_1 \\mu - 2\\lambda_2 \\mathbf{1} = \\mathbf{0}\n$$\n由于 $\\Sigma$ 是正定的，其逆矩阵 $\\Sigma^{-1}$ 存在。我们可以解出 $w$：\n$$\n\\Sigma w = \\lambda_1 \\mu + \\lambda_2 \\mathbf{1}\n$$\n$$\nw = \\lambda_1 \\Sigma^{-1} \\mu + \\lambda_2 \\Sigma^{-1} \\mathbf{1}\n$$\n为了求出拉格朗日乘数 $\\lambda_1$ 和 $\\lambda_2$，我们将 $w$ 的这个表达式代回到两个约束条件中：\n$1$. $\\mu^{\\top} w = \\mu^{\\top} (\\lambda_1 \\Sigma^{-1} \\mu + \\lambda_2 \\Sigma^{-1} \\mathbf{1}) = \\lambda_1 (\\mu^{\\top} \\Sigma^{-1} \\mu) + \\lambda_2 (\\mu^{\\top} \\Sigma^{-1} \\mathbf{1}) = r_{\\text{target}}$\n$2$. $\\mathbf{1}^{\\top} w = \\mathbf{1}^{\\top} (\\lambda_1 \\Sigma^{-1} \\mu + \\lambda_2 \\Sigma^{-1} \\mathbf{1}) = \\lambda_1 (\\mathbf{1}^{\\top} \\Sigma^{-1} \\mu) + \\lambda_2 (\\mathbf{1}^{\\top} \\Sigma^{-1} \\mathbf{1}) = 1$\n\n我们定义三个标量来简化该系统：\n$A = \\mathbf{1}^{\\top} \\Sigma^{-1} \\mathbf{1}$\n$B = \\mathbf{1}^{\\top} \\Sigma^{-1} \\mu$\n$C = \\mu^{\\top} \\Sigma^{-1} \\mu$\n关于 $(\\lambda_1, \\lambda_2)$ 的线性方程组变为：\n$$\n\\begin{pmatrix} C  B \\\\ B  A \\end{pmatrix} \\begin{pmatrix} \\lambda_1 \\\\ \\lambda_2 \\end{pmatrix} = \\begin{pmatrix} r_{\\text{target}} \\\\ 1 \\end{pmatrix}\n$$\n该方程组的解通过矩阵求逆得到：\n$$\n\\begin{pmatrix} \\lambda_1 \\\\ \\lambda_2 \\end{pmatrix} = \\frac{1}{AC - B^2} \\begin{pmatrix} A  -B \\\\ -B  C \\end{pmatrix} \\begin{pmatrix} r_{\\text{target}} \\\\ 1 \\end{pmatrix}\n$$\n这得出：\n$$\n\\lambda_1 = \\frac{A r_{\\text{target}} - B}{AC - B^2}\n$$\n$$\n\\lambda_2 = \\frac{C - B r_{\\text{target}}}{AC - B^2}\n$$\n确定了 $\\lambda_1$ 和 $\\lambda_2$ 之后，最优权重向量 $w$ 就完全确定了。投资组合方差 $\\sigma_p^2 = w^{\\top} \\Sigma w$ 即可计算。一个更直接的方差计算源于一阶条件：\n$$\n\\sigma_p^2 = w^{\\top} \\Sigma w = w^{\\top}(\\lambda_1 \\mu + \\lambda_2 \\mathbf{1}) = \\lambda_1 (w^{\\top} \\mu) + \\lambda_2 (w^{\\top} \\mathbf{1})\n$$\n使用约束条件 $w^{\\top} \\mu = r_{\\text{target}}$ 和 $w^{\\top} \\mathbf{1} = 1$，我们得到一个简洁的结果：\n$$\n\\sigma_p^2 = \\lambda_1 r_{\\text{target}} + \\lambda_2\n$$\n代入 $\\lambda_1$ 和 $\\lambda_2$ 的表达式：\n$$\n\\sigma_p^2 = \\frac{(A r_{\\text{target}} - B)r_{\\text{target}} + (C - B r_{\\text{target}})}{AC - B^2} = \\frac{A r_{\\text{target}}^2 - 2B r_{\\text{target}} + C}{AC - B^2}\n$$\n这个方程描述了有效前沿，它在 $(\\sigma_p^2, r_{\\text{target}})$ 平面上是一条抛物线。\n对于情况 2，目标收益是全局最小方差投资组合 (GMVP) 的收益。GMVP 对应于这条抛物线的顶点，该顶点出现在 $r_{\\text{target}} = B/A$ 处。GMVP 的方差是 $\\sigma_{\\text{GMV}}^2 = 1/A$。\n\n接下来，我们计算风险价值。问题陈述指出投资组合收益服从高斯分布。单期投资组合收益 $R_p$ 服从 $R_p \\sim \\mathcal{N}(\\mu_p, \\sigma_p^2)$，其中 $\\mu_p = r_{\\text{target}}$，$\\sigma_p^2$ 是上面计算出的方差。假设在 $h$ 期的期限内收益是独立同分布的，那么 $h$ 期收益 $R_h$ 也服从正态分布：\n$$\nR_h \\sim \\mathcal{N}(\\mu_h, \\sigma_h^2)\n$$\n其中 $\\mu_h = h \\mu_p$ 且 $\\sigma_h^2 = h \\sigma_p^2$。\n期限 $h$ 内的投资组合损失为 $L_h = -V R_h$，其中 $V$ 是初始投资组合价值。置信水平为 $c$ 时的 VaR 是值 $\\text{VaR}_c$，使得损失超过此值的概率为 $1-c$：\n$$\nP(L_h > \\text{VaR}_c) = 1-c\n$$\n代入损失的定义：\n$$\nP(-V R_h > \\text{VaR}_c) = P(R_h  -\\text{VaR}_c / V) = 1-c\n$$\n令 $Z = (R_h - \\mu_h) / \\sigma_h$ 为一个标准正态变量。那么 $R_h = \\mu_h + \\sigma_h Z$。概率变为：\n$$\nP(\\mu_h + \\sigma_h Z  -\\text{VaR}_c / V) = P(Z  \\frac{-\\text{VaR}_c / V - \\mu_h}{\\sigma_h}) = 1-c\n$$\n令 $z_{1-c}$ 为标准正态分布的 $(1-c)$-分位数。那么：\n$$\n\\frac{-\\text{VaR}_c / V - \\mu_h}{\\sigma_h} = z_{1-c}\n$$\n根据正态分布的对称性，$z_{1-c} = -z_c$，其中 $z_c$ 是 $c$-分位数。\n$$\n-\\text{VaR}_c / V - \\mu_h = -\\sigma_h z_c\n$$\n求解 $\\text{VaR}_c$：\n$$\n\\text{VaR}_c = V(z_c \\sigma_h - \\mu_h)\n$$\n每个测试用例的计算过程如下：\n$1$. 给定 $\\mu$、$\\Sigma$、$r_{\\text{target}}$、$V$、$h$ 和 $c$。\n$2$. 对于情况 2，首先计算 $A=\\mathbf{1}^\\top \\Sigma^{-1} \\mathbf{1}$ 和 $B=\\mathbf{1}^\\top \\Sigma^{-1} \\mu$，然后设置 $r_{\\text{target}} = B/A$。\n$3$. 对于所有情况，从 $\\mu$ 和 $\\Sigma$ 计算标量 $A$、$B$ 和 $C=\\mu^\\top\\Sigma^{-1}\\mu$。\n$4$. 计算单期投资组合方差 $\\sigma_p^2 = (A r_{\\text{target}}^2 - 2B r_{\\text{target}} + C) / (AC - B^2)$。\n$5$. 确定 $h$ 期的均值 $\\mu_h = h r_{\\text{target}}$ 和标准差 $\\sigma_h = \\sqrt{h \\sigma_p^2}$。\n$6$. 求出标准正态分布的 $c$-分位数 $z_c$。\n$7$. 使用推导出的公式计算 VaR：$\\text{VaR}_c = V(z_c \\sigma_h - \\mu_h)$。\n将实施此过程以得出最终的数值结果。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import norm\n\ndef solve():\n    \"\"\"\n    Solves for the Value at Risk (VaR) for a portfolio optimized\n    using Markowitz mean-variance principles.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: Happy path, 4 assets\n        {\n            \"mu\": np.array([0.01, 0.015, 0.02, 0.012]),\n            \"Sigma\": np.array([\n                [0.0030, 0.0012, 0.0011, 0.0009],\n                [0.0012, 0.0040, 0.0013, 0.0010],\n                [0.0011, 0.0013, 0.0050, 0.0012],\n                [0.0009, 0.0010, 0.0012, 0.0035]\n            ]),\n            \"r_target\": 0.015,\n            \"V\": 1000000.0,\n            \"h\": 1,\n            \"c\": 0.99,\n            \"type\": \"standard\"\n        },\n        # Case 2: Boundary on the efficient frontier (GMVP)\n        {\n            \"mu\": np.array([0.01, 0.015, 0.02, 0.012]),\n            \"Sigma\": np.array([\n                [0.0030, 0.0012, 0.0011, 0.0009],\n                [0.0012, 0.0040, 0.0013, 0.0010],\n                [0.0011, 0.0013, 0.0050, 0.0012],\n                [0.0009, 0.0010, 0.0012, 0.0035]\n            ]),\n            \"r_target\": None,  # To be calculated\n            \"V\": 1000000.0,\n            \"h\": 1,\n            \"c\": 0.95,\n            \"type\": \"gmv\"\n        },\n        # Case 3: Horizon scaling and different dimension\n        {\n            \"mu\": np.array([0.008, 0.011, 0.0095]),\n            \"Sigma\": np.array([\n                [0.0025, -0.0003, 0.0004],\n                [-0.0003, 0.0030, -0.0002],\n                [0.0004, -0.0002, 0.0020]\n            ]),\n            \"r_target\": 0.0105,\n            \"V\": 2000000.0,\n            \"h\": 3,\n            \"c\": 0.975,\n            \"type\": \"standard\"\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        mu = case[\"mu\"]\n        Sigma = case[\"Sigma\"]\n        r_target_initial = case[\"r_target\"]\n        V = case[\"V\"]\n        h = case[\"h\"]\n        c = case[\"c\"]\n        case_type = case[\"type\"]\n        \n        n = mu.shape[0]\n        ones = np.ones(n)\n        \n        # Calculate the inverse of the covariance matrix\n        Sigma_inv = np.linalg.inv(Sigma)\n        \n        # Calculate the scalar constants A, B, C\n        A = ones.T @ Sigma_inv @ ones\n        B = ones.T @ Sigma_inv @ mu\n        C = mu.T @ Sigma_inv @ mu\n        \n        # Determine the target return\n        if case_type == \"gmv\":\n            # For the Global Minimum-Variance Portfolio, r_target = B/A\n            r_target = B / A\n        else:\n            r_target = r_target_initial\n\n        # Calculate the portfolio variance using the efficient frontier formula\n        # This formula is derived from the Lagrangian solution.\n        # sigma_p^2 = (A*r_target^2 - 2*B*r_target + C) / (A*C - B^2)\n        # For the GMV case, this simplifies to 1/A. We use the general formula for all cases.\n        denominator = A * C - B**2\n        portfolio_variance_p = (A * r_target**2 - 2 * B * r_target + C) / denominator\n\n        # Scale mean and standard deviation for the horizon h\n        mu_p = r_target\n        sigma_p = np.sqrt(portfolio_variance_p)\n        \n        mu_h = h * mu_p\n        sigma_h = np.sqrt(h) * sigma_p\n        \n        # Find the c-quantile of the standard normal distribution\n        z_c = norm.ppf(c)\n        \n        # Calculate Value at Risk\n        # VaR = V * (z_c * sigma_h - mu_h)\n        var_result = V * (z_c * sigma_h - mu_h)\n        results.append(var_result)\n\n    # Format the results into the required output string\n    formatted_results = f\"[{','.join(f'{r:.10f}' for r in results)}]\"\n\n    # Final print statement in the exact required format.\n    print(formatted_results)\n\nsolve()\n```", "id": "2446949"}, {"introduction": "一位出色的风险管理者不仅需要知道如何使用一个模型，更要洞悉其失效的边界。最后一个练习是一个思想实验，旨在培养对方差-协方差VaR模型局限性的批判性思维。你将分析几种特殊情境：在这些情境中，模型由于其线性和正态分布的假设，计算出的VaR为零，但实际上却潜藏着巨大的经济风险，从而暴露了模型在非线性风险（如gamma风险）和未建模风险因子方面的盲点。", "problem": "一位风险经理采用方差-协方差法来计算为期一天的风险价值（VaR）。该方法将一日投资组合的损益建模为联合正态分布的风险因子变化的线性函数。具体来说：(i) 对于线性工具投资组合，一日损益被建模为风险因子变化向量的仿射线性形式；(ii) 对于包含单一股票欧式期权的投资组合，该银行使用股票价格的一阶（delta）线性化，并忽略了诸如 gamma 和 vega 等高阶项。股票的一日连续复利回报率被建模为均值为零、方差为 $\\sigma^{2}$ 的正态分布。当前股价为 $S_{0}$。在这种建模选择下，一个对所有建模的风险因子净一阶敏感度恰好为零的投资组合，其计算出的一日 VaR 为零。\n\n在上述方差-协方差程序下，以下哪个投资组合计算出的一日 VaR 为零，但在经济现实中仍然具有极高风险？选择所有适用项。\n\nA. 卖出1份欧式看涨期权和卖出1份欧式看跌期权，两者均以该股票为标的，具有相同的到期日和行权价 $K=S_{0}$；无该股票或现金头寸。\n\nB. 仅持有一张1天后到期的无风险国库券；无其他头寸，并忽略1天内的利率风险。\n\nC. 做多1股该股票，并做空市场指数期货，名义本金的选择使得投资组合相对于市场指数的 beta 恰好为零。VaR 系统仅将市场指数作为股票风险因子进行建模，并忽略了股票的异质性波动。\n\nD. 买入1份欧式看涨期权并卖出1份欧式看跌期权，两者均以该股票为标的，具有相同的到期日和行权价 $K=S_{0}$；无该股票或现金头寸。", "solution": "我们从陈述的建模基础开始。方差-协方差 VaR 假设一日损益 $P$ 被建模为联合正态分布的风险因子变化的线性函数。对于只有一个风险因子（其价格）的单一标的股票，一个包含期权和股票的投资组合的价值 $V$ 在一天内的 delta 线性化变化为\n$$\n\\Delta V \\approx \\delta \\,\\Delta S,\n$$\n其中 $\\delta$ 是对股票价格 $S$ 的净一阶敏感度（美元 delta），$\\Delta S$ 是 $S$ 的一日变化量。如果股票的一日回报率被建模为均值为零、方差为 $\\sigma^{2}$ 的正态分布，则 $\\Delta S$ 近似服从均值为零、标准差为 $S_{0}\\sigma$ 的正态分布。在方差-协方差法下，置信度为 $\\alpha$ 的一日 VaR（忽略微小的均值效应）为\n$$\n\\mathrm{VaR}_{\\alpha} \\propto |\\delta|\\,S_{0}\\sigma,\n$$\n因此，如果对所有建模的风险因子的净一阶敏感度 $\\delta$ 恰好为零，则计算出的 VaR 为零。然而，如果线性化忽略了重要的高阶风险（如 gamma、vega）或遗漏了相关的风险因子（如异质性成分），那么经济风险可能仍然很大。\n\n现在评估每个选项。\n\n选项 A：卖出1份欧式看涨期权和卖出1份欧式看跌期权，均为平价期权，行权价 $K=S_{0}$，到期日相同；无股票或现金头寸。\n\n根据无套利原理，在 Black–Scholes 框架下，对于无股息支付股票的欧式期权，看涨期权的 delta 为 $\\Delta_{c}=N(d_{1})$，看跌期权的 delta 为 $\\Delta_{p}=N(d_{1})-1$，其中 $N(\\cdot)$ 是标准正态累积分布函数，$d_{1}$ 是常规的 Black–Scholes 项。对于平价远期期权，有 $d_{1}=0$，因此 $N(0)=\\tfrac{1}{2}$。因此，在初始时，\n$$\n\\Delta_{c}=\\tfrac{1}{2},\\qquad \\Delta_{p}=-\\tfrac{1}{2}.\n$$\n一个卖出跨式组合（卖出1份看涨期权和1份看跌期权）的净 delta 为\n$$\n\\delta_{\\text{net}} = -\\Delta_{c} - \\Delta_{p} = -\\tfrac{1}{2} - (-\\tfrac{1}{2}) = 0.\n$$\n在忽略了 gamma 和 vega 的方差-协方差（delta-正态）法下，由于对唯一建模的因子的一阶风险暴露为零，因此计算出的一日 VaR 为零。从经济角度看，该头寸风险极高：一个卖出的平价跨式组合是空头凸性（负的 gamma）。对于足够大的价格变动 $|\\Delta S|$，二阶项 $\\tfrac{1}{2}\\Gamma (\\Delta S)^{2}$（对于卖出跨式组合，$\\Gamma0$）将占主导地位，可能产生巨大的损失。结论：正确。\n\n选项 B：仅持有一张1天后到期的无风险国库券；忽略1天内的利率风险。\n\n在所述假设下，一日内的回报在实际上是确定的，并且没有建模的随机风险因子暴露。计算出的一日 VaR 为零，但该头寸并非“极高风险”；事实上，它被建模（并意图）为在该时间范围内无风险。这不满足“仍然具有极高风险”的要求。结论：错误。\n\n选项 C：做多1股该股票，并做空市场指数期货，使投资组合的 beta 恰好为零；VaR 系统仅将市场指数作为股票风险因子进行建模，并忽略了异质性风险。\n\n设股票的回报率可分解为 $R_{i}=\\beta_{i} R_{m}+\\varepsilon_{i}$，其中 $R_{m}$ 是市场指数回报率，$\\varepsilon_{i}$ 是异质性部分，其方差为 $\\sigma_{\\varepsilon}^{2}$，且与 $R_{m}$ 无关。根据假设，方差-协方差系统仅对 $R_{m}$ 进行建模，并将投资组合的风险暴露映射到单一因子 $R_{m}$ 上。选择合适的期货名义本金将净 beta 设置为零，使得对 $R_{m}$ 的建模一阶风险暴露恰好为零。因此，在该银行的因子集下，计算出的一日 VaR 为零。从经济角度看，该头寸仍然带有该单一股票的异质性成分 $\\varepsilon_{i}$，这可能很大（例如，公司特定新闻、盈利意外）。由于该风险因子被模型忽略，它不进入计算的 VaR 中，但在现实中可能导致巨大损失。因此，该投资组合计算出的 VaR 为零，但潜在风险仍然极高。结论：正确。\n\n选项 D：买入1份欧式看涨期权并卖出1份欧式看跌期权，均为平价期权，行权价 $K=S_{0}$；无股票或现金头寸。\n\n根据看跌-看涨期权平价关系和 delta，该头寸是一个合成远期：净 delta 等于\n$$\n\\delta_{\\text{net}} = \\Delta_{c} - \\Delta_{p} = \\tfrac{1}{2} - (-\\tfrac{1}{2}) = 1,\n$$\n因此它对股票价格具有非零的一阶风险暴露。在方差-协方差法下，计算出的一日 VaR 与 $S_{0}\\sigma$ 成正比，并且严格为正，不为零。尽管该头寸可能有风险，但它不满足“通过方差-协方差法计算的 VaR 为零”的条件。结论：错误。\n\n总结：选项 A 和 C 满足在方差-协方差法下计算的 VaR 为零的条件，同时在经济上由于分别被忽略的高阶（gamma）风险和被遗漏的异质性风险而具有非常高的风险。", "answer": "$$\\boxed{AC}$$", "id": "2447005"}]}