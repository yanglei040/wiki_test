{"hands_on_practices": [{"introduction": "本次练习将我们的理解建立在一个 `while` 循环的基本机制上。我们将剖析一个简单的循环，根据其参数确定精确的迭代次数，并计算累加和的最终结果。这个实践旨在巩固循环的核心操作语义，以及如何将其转化为可预测的数学结果 [@problem_id:3653514]。", "problem": "考虑一个在命令式中间表示中针对数学整数的结构化循环，其变量初始化如下：$i \\leftarrow a$，$s \\leftarrow 0$，其中 $a$、$n$ 和 $d$ 是满足 $0 \\le a \\le n$、$d \\ge 1$ 且 $d$ 整除 $(n-a)$ 的整数。该循环的高级形式为：当谓词 $i \\le n$ 成立时，执行一个循环体，该循环体执行更新操作 $s \\leftarrow s + (2i + 1)$，然后通过 $i \\leftarrow i + d$ 来推进循环变量。你必须将此循环降级（lower）为规范的单入口单出口循环形式，该形式在控制流图（CFG）中包含一个前置头部（preheader）、一个测试谓词 $i \\le n$ 的头部（header）、一个计算循环有效载荷的主体（body），以及一个更新 $i$ 并分支返回到头部的闭锁（latch）。此降级过程必须保留语义，使得当且仅当在所述的可除性条件下 $i$ 达到 $n$ 时，最后一次迭代才在 $i=n$ 时执行。\n\n仅从循环的基本操作语义（即：while 循环在头部评估其谓词；若为真，则执行循环体并继续循环；若为假，则退出）和控制流图中的标准规范循环结构（头部测试、主体和带有回边的闭锁）出发，推导 $i$ 所取的精确动态值序列、作为 $a$、$n$ 和 $d$ 的函数的结果循环体执行次数，然后计算循环退出时 $s$ 的最终值的封闭形式表达式。假设使用无限精度算术且无整数溢出。\n\n请以关于 $a$、$n$ 和 $d$ 的单一封闭形式解析表达式提供你的最终答案。最终答案中不应包含推导过程。无需四舍五入。", "solution": "用户希望我分析一个特定的循环，并推导出一个变量最终值的封闭形式表达式。\n\n### 问题验证\n\n**步骤 1：提取已知条件**\n-   **变量初始值**：$i \\leftarrow a$, $s \\leftarrow 0$。\n-   **循环谓词**：$i \\le n$。\n-   **循环体更新**：$s \\leftarrow s + (2i + 1)$。\n-   **循环变量更新（闭锁）**：$i \\leftarrow i + d$。\n-   **参数约束**：$a$、$n$ 和 $d$ 是整数。$0 \\le a \\le n$。$d \\ge 1$。$d$ 整除 $(n - a)$，可写作 $(n-a) \\equiv 0 \\pmod{d}$。\n-   **终止条件**：最后一次迭代在 $i = n$ 时执行。\n-   **算术模型**：无限精度算术。\n\n**步骤 2：使用提取的已知条件进行验证**\n-   **科学依据**：该问题基于编译器设计（循环分析、中间表示、控制流图）和离散数学（等差数列、求和）的原理。所有概念都是完善且形式化的。\n-   **适定性**：该问题是适定的。给出的条件是充分且一致的。约束条件，特别是 $d$ 整除 $(n-a)$，确保了循环计数器 $i$ 将精确达到值 $n$，从而得到明确定义的迭代次数。存在一个唯一、稳定且有意义的解。\n-   **客观性**：问题以精确、客观的数学和计算语言陈述。没有主观或模糊的术语。\n\n**步骤 3：结论与行动**\n问题是有效的。这是一个在计算机科学背景下定义明确的数学问题。我将继续推导解答。\n\n### 解答推导\n\n问题描述了一个`while`循环。在规范的控制流图（CFG）表示中，此结构包括用于初始化的前置头部、用于条件测试的头部、用于主计算的主体，以及用于更新循环计数器并分支返回到头部的闭锁。\n\n1.  **分析循环计数器 `i` 的序列**：\n    循环计数器 $i$ 初始化为 $a$。在每次迭代中，它增加 $d$。因此，在每次迭代开始时（在头部测试处）$i$ 所取的值序列构成一个等差数列：\n    $$ a, a+d, a+2d, a+3d, \\dots $$\n\n2.  **确定循环迭代次数**：\n    只要谓词 $i \\le n$ 为真，循环就会执行。问题陈述 $d$ 整除 $(n-a)$。这意味着存在一个整数 $m$ 使得 $n - a = m d$。由于 $n \\ge a$ 和 $d \\ge 1$，我们有 $m \\ge 0$。\n    $i$ 的值序列为 $a+0d, a+1d, a+2d, \\dots, a+md$。此序列中的最后一个值为 $a+md = a+(n-a) = n$。\n    循环体将对这些值中的每一个执行，因为对于 $k \\in \\{0, 1, \\dots, m\\}$，每个值 $a+kd$ 都满足 $a+kd \\le a+md = n$。\n    执行循环体的 $i$ 的值序列为 $a, a+d, \\ldots, n$。\n    为求迭代次数，我们计算此序列中的项数。这些项可以通过 $k \\in \\{0, 1, \\dots, m\\}$ 进行索引。总项数为 $(m - 0) + 1 = m+1$。\n    设 $N_{iter}$ 为迭代次数。\n    $$ N_{iter} = m+1 $$\n    代入 $m = \\frac{n-a}{d}$：\n    $$ N_{iter} = \\frac{n-a}{d} + 1 = \\frac{n-a+d}{d} $$\n\n3.  **计算 `s` 的最终值**：\n    变量 $s$ 初始化为 $0$。在每次迭代中，值 $(2i+1)$ 被加到 $s$ 上。$s$ 的最终值是循环体执行时所有 $i$ 值对应的 $(2i+1)$ 的总和。\n    $$ s_{final} = \\sum_{k=0}^{m} \\left( 2(a+kd) + 1 \\right) $$\n    加到 $s$ 上的各项构成一个等差级数。我们来确定首项、末项和项数。\n    -   **项数**：$N = N_{iter} = m+1 = \\frac{n-a+d}{d}$。\n    -   **首项（当 $k=0$ 时）**：$T_1 = 2(a+0 \\cdot d) + 1 = 2a+1$。\n    -   **末项（当 $k=m$ 时）**：$T_N = 2(a+m \\cdot d) + 1$。由于 $a+md = n$，因此 $T_N = 2n+1$。\n\n    等差级数的和由公式 $S_N = \\frac{N}{2}(\\text{首项} + \\text{末项})$ 给出。\n    应用此公式求 $s_{final}$：\n    $$ s_{final} = \\frac{N_{iter}}{2} (T_1 + T_N) $$\n    代入 $N_{iter}$、$T_1$ 和 $T_N$ 的表达式：\n    $$ s_{final} = \\frac{1}{2} \\left( \\frac{n-a+d}{d} \\right) \\left( (2a+1) + (2n+1) \\right) $$\n    现在，我们简化表达式：\n    $$ s_{final} = \\frac{1}{2} \\left( \\frac{n-a+d}{d} \\right) (2a + 2n + 2) $$\n    $$ s_{final} = \\frac{1}{2} \\left( \\frac{n-a+d}{d} \\right) \\cdot 2(a+n+1) $$\n    $$ s_{final} = \\left( \\frac{n-a+d}{d} \\right) (n+a+1) $$\n    这就是循环终止时 $s$ 值的最终封闭形式表达式。", "answer": "$$\\boxed{\\left(\\frac{n-a+d}{d}\\right)(n+a+1)}$$", "id": "3653514"}, {"introduction": "现实世界中的循环常常包含像 `break` 和 `continue` 这样的复杂控制流。本练习要求你将一个带有这些语句的嵌套循环转化为一个正式的控制流图（CFG）。通过将程序建模为基本块和跳转的图，你将更深入地理解编译器如何表示非线性控制流，并学会使用圈复杂度来量化其复杂性 [@problem_id:3653528]。", "problem": "考虑以下高级程序片段，该片段嵌套了两个循环，并在外层循环中使用了条件 continue，在内层循环中使用了条件 break。设 $I$、$J$ 和 $k$ 是固定的整数，满足 $I \\ge 1$、$J \\ge 1$ 和 $0 \\le k  J$。该片段如下：\n\n对于 $i$ 从 $0$ 到 $I-1$：\n- 如果 $i \\bmod 2 = 1$，则 continue 到外层循环的下一次迭代。\n- 对于 $j$ 从 $0$ 到 $J-1$：\n  - 如果 $j = k$，则 break 跳出内层循环（即，如同内层循环已对当前 $i$ 完成一样继续执行）。\n  - 执行一个基本语句 $S(i,j)$，该语句没有内部控制流（既不分支也不调用任何过程）。\n\n假设使用传统编译器将其转换为三地址码（TAC），其中：\n- 每个循环都使用一个循环初始化块、一个循环条件测试块、一个循环体块和一个循环增量块来实现，这些块通过显式的条件和无条件跳转连接。\n- 每个条件测试（包括循环条件以及对 $i \\bmod 2 = 1$ 和 $j = k$ 的测试）都放在其自己的基本块中。\n- 以下各项都放在其自己的基本块中：循环初始化（$i := 0$, $j := 0$）、循环增量（$i := i + 1$, $j := j + 1$）、语句 $S(i,j)$ 以及一个唯一的函数出口块。\n- 函数只有一个入口和一个出口，因此控制流图（CFG）有 $1$ 个连通分量。\n\n从上述片段和假设出发，通过识别基本块及其由传统 TAC 转换所隐含的控制流边（包括 $continue$ 和 $break$ 语句的影响）来构建控制流图（CFG）。然后，使用编译器理论和图论的基本原理计算所得 CFG 的圈复杂度。\n\n请提供您的最终答案，为一个表示圈复杂度的整数。不需要四舍五入，也没有单位。", "solution": "该问题要求确定一个控制流图（CFG）的圈复杂度，该控制流图是根据一组特定的编译器转换规则从给定的高级程序片段构建的。分析将首先验证问题，然后系统地识别 CFG 的组成部分（其节点和边），最后应用圈复杂度的形式化定义。\n\n问题陈述的验证如下：\n1.  **已知条件提取**：问题提供了一个带有条件 `continue` 和 `break` 语句的嵌套循环结构。变量 $I$、$J$ 和 $k$ 被定义为固定整数，约束条件为 $I \\geq 1$、$J \\geq 1$ 和 $0 \\leq k  J$。关键是，它指定了一套精确的规则，用于将此代码转换为 CFG，包括如何为初始化、条件测试、增量和其他语句形成基本块。它还指出该 CFG 只有一个连通分量。\n2.  **有效性检查**：该问题在编译器理论和图论方面有科学依据，使用了基本块、CFG 和圈复杂度等标准概念。为构建 CFG 给出的规则是明确且无歧义的，这使得问题是适定 (well-posed) 的。语言客观且正式。问题是自包含的，没有违反任何科学原理。\n3.  **结论**：问题被认为是有效的。可以推导出严谨的解。\n\n解决方案分三个阶段推导：识别基本块、通过定义控制流边来构建 CFG，以及计算圈复杂度。\n\n首先，我们识别基本块的集合，这些基本块将作为我们的 CFG $G=(V,E)$ 的顶点 $V$。根据指定的规则，每个条件测试、初始化、增量和语句 $S(i,j)$ 都构成其自己的基本块。我们还包括一个唯一的出口块。\n由此产生的基本块是：\n- $B_1$：外层循环初始化：`$i := 0$`\n- $B_2$：外层循环条件测试：`$i  I$`\n- $B_3$：`continue` 语句条件测试：`$i \\bmod 2 = 1$`\n- $B_4$：内层循环初始化：`$j := 0$`\n- $B_5$：内层循环条件测试：`$j  J$`\n- $B_6$：`break` 语句条件测试：`$j = k$`\n- $B_7$：基本语句：`$S(i,j)$`\n- $B_8$：内层循环增量：`$j := j + 1$`\n- $B_9$：外层循环增量：`$i := i + 1$`\n- $B_{10}$：唯一的函数出口块。\n\n此枚举给出了 CFG 中总共 $N = |V| = 10$ 个节点。\n\n其次，我们确定表示这些块之间控制流的有向边 $E$。\n- $B_1 \\to B_2$：初始化 `$i$` 后，检查外层循环条件。\n- $B_2 \\to B_3$：如果 `$i  I$` 为真，控制流进入外层循环体，从 `$i \\bmod 2$` 测试开始。\n- $B_2 \\to B_{10}$：如果 `$i  I$` 为假，外层循环终止，控制流转向出口块。\n- $B_3 \\to B_9$：如果 `$i \\bmod 2 = 1$` 为真，`continue` 语句执行，将控制权转移到外层循环的增量块 $B_9$。\n- $B_3 \\to B_4$：如果 `$i \\bmod 2 = 1$` 为假，执行顺序进行到内层循环的初始化。\n- $B_4 \\to B_5$：初始化 `$j$` 后，检查内层循环条件。\n- $B_5 \\to B_6$：如果 `$j  J$` 为真，控制流进入内层循环体，从 `$j=k$` 测试开始。\n- $B_5 \\to B_9$：如果 `$j  J$` 为假，内层循环终止。然后控制流继续到下一个有效语句，即外层循环的增量块 $B_9$。\n- $B_6 \\to B_9$：如果 `$j = k$` 为真，`break` 语句执行，终止内层循环并将控制权转移到其后的语句，即外层循环的增量块 $B_9$。\n- $B_6 \\to B_7$：如果 `$j = k$` 为假，执行顺序进行到语句 `$S(i,j)$`。\n- $B_7 \\to B_8$：执行 `$S(i,j)$` 后，控制流转向内层循环的增量。\n- $B_8 \\to B_5$：增加 `$j$` 后，控制流返回到内层循环的条件测试。\n- $B_9 \\to B_2$：增加 `$i$` 后，控制流返回到外层循环的条件测试。\n\n计算这些转移，我们发现边的总数为 $E = |E| = 13$。\n\n第三，我们计算圈复杂度 $V(G)$。对于一个有 $N$ 个节点、$E$ 条边和 $P$ 个连通分量的图，复杂度由以下公式给出：\n$$V(G) = E - N + 2P$$\n问题指定 CFG 有 $1$ 个连通分量，所以 $P=1$。代入上面推导出的 $N$ 和 $E$ 的值：\n$$V(G) = 13 - 10 + 2(1) = 3 + 2 = 5$$\n\n这个结果可以用结构化程序的替代公式 $V(G) = D + 1$ 来验证，其中 $D$ 是谓词节点（出度大于 $1$ 的节点）的数量。在我们的 CFG 中，谓词节点是：\n- $B_2$ (测试 `$i  I$`)\n- $B_3$ (测试 `$i \\bmod 2 = 1$`)\n- $B_5$ (测试 `$j  J$`)\n- $B_6$ (测试 `$j = k$`)\n这样的节点有 $D=4$ 个。因此，圈复杂度为：\n$$V(G) = 4 + 1 = 5$$\n两种方法得出了相同的结果，证实了分析的正确性。指定 CFG 的圈复杂度为 $5$。", "answer": "$$\\boxed{5}$$", "id": "3653528"}, {"introduction": "现代编译器依赖静态单赋值（SSA）形式来进行强大的优化。最后一个练习通过分析嵌套循环索引变量的 $\\phi$ 函数的行为，探讨了循环结构与SSA之间的联系。你将计算退出SSA形式时生成的操作总数，从而在高级循环语义和低级代码生成成本之间建立起具体的联系 [@problem_id:3653540]。", "problem": "一个编译器将结构化循环转换为一种低级的控制流形式，并将变量置于静态单赋值（SSA）形式。考虑将以下高级语言中的嵌套循环，在下列假设下，规范化降级为一个带有显式循环头和循环闩的控制流图：\n\n- 外层循环迭代 $N$ 次，索引 $i$ 的取值范围为 $0, 1, \\dots, N-1$（即，守卫条件为 $i  N$）。\n- 对于每个固定的外层索引 $i$，内层循环以索引 $j$ 进行迭代，受限于边界 $j  i$。也就是说，在每次外层循环的迭代中，$j$ 依次取值为 $0, 1, \\dots, i-1$。\n- 编译器执行规范化循环降级，使得每个循环都有一个唯一的循环前置头、循环头、循环体和循环闩。循环头支配循环体和循环闩，并且恰好有两条入边：一条来自循环前置头，另一条来自循环闩（即回边）。内层循环索引 $j$ 在每次内层循环执行开始时（即从循环前置头进入内层循环头时）被重新初始化为 $0$，并在内层循环闩中沿回边递增 $1$。循环中没有异常退出（没有 break 或 continue），并且循环体是顺序代码。\n- 编译器构建 SSA 形式，并在内层循环头处为内层索引 $j$放置一个单一的 $\\phi$ 函数，以合并其两个到达定值：来自循环前置头的初始值 $0$ 和来自循环闩的递增值 $j+1$。\n- 在解构 SSA 时，编译器将每个 $\\phi$ 函数降级为一个并行拷贝，实现为在通往循环头的每条入边上的一次寄存器到寄存器的移动指令，每当运行时采用该边时执行。假设没有发生拷贝合并或消除。\n\n仅使用 SSA 形式的基本定义、支配汇合点处的 $\\phi$ 函数以及上述的规范化循环降级语义，推导出一个关于 $N$ 的闭式表达式，该表达式表示在整个嵌套循环执行期间，仅由内层循环头处用于 $j$ 的 $\\phi$ 函数所导致的运行时寄存器到寄存器移动指令的总数。\n\n请将您的最终答案表述为关于 $N$ 的单个闭式解析表达式。无需四舍五入；不要包含单位。假设 $N$ 是一个非负整数。", "solution": "所述问题具有科学依据、提法明确、客观，并包含足够信息以得到唯一解。它基于编译器设计的标准原则，包括控制流图、循环降级和静态单赋值（SSA）形式。因此，该问题是有效的。\n\n目标是找到因内层循环索引 $j$ 的 $\\phi$ 函数进行 de-SSA 降级而执行的寄存器到寄存器移动指令总数的闭式表达式。\n\n根据问题描述，SSA 解构将内层循环头处的 $\\phi$ 函数降级为沿该循环头的每条入边上的一次寄存器到寄存器的移动指令。每当在运行时遍历这些边中的一条时，就会执行一次移动。\n\n根据所述的规范化循环结构，内层循环头恰好有两条入边：\n1.  一条来自内层循环前置头的边，每次进入内层循环时遍历一次。\n2.  一条来自内层循环闩的边，即循环的回边，在内层循环体每次迭代后遍历，以测试下一次迭代的条件。\n\n设 $M$ 为执行的移动指令总数。该总数是整个嵌套循环执行期间这两条边各自被遍历次数的总和。设 $M_{pre}$ 是从循环前置头到循环头的边的总遍历次数，设 $M_{latch}$ 是从循环闩到循环头（回边）的边的总遍历次数。\n$$\nM = M_{pre} + M_{latch}\n$$\n外层循环以索引 $i$ 对值 $0, 1, \\dots, N-1$ 进行迭代。对于这 $N$ 次迭代中的每一次，控制流都进入外层循环体，其中包含内层循环结构。因此，对于 $i$ 的每个值，内层循环的前置头都会被进入一次。所以，内层循环的前置头到头的边总共被遍历 $N$ 次。\n$$\nM_{pre} = N\n$$\n接下来，我们分析内层循环回边的遍历次数。对于一个固定的外层循环索引 $i$，内层循环以索引 $j$ 进行迭代，其条件为 $j  i$。索引 $j$ 初始化为 $0$，并在循环闩中递增 $1$。内层循环体对 $j = 0, 1, \\dots, i-1$ 执行。\n\n对于一个固定的 $i$，我们来计算内层回边被采用的次数。回边在给定 $j$ 的循环体执行完毕后被采用，以返回到循环头。对于每个执行循环体的 $j$ 值，这都会发生一次。执行循环体的 $j$ 值为 $0, 1, \\dots, i-1$。共有 $i$ 个这样的值。当 $j=i-1$ 的循环体执行完毕后，循环闩将 $j$ 递增为 $i$，并最后一次采用回边回到循环头，此时条件 $i  i$ 被评估为假，导致循环终止。因此，对于一个给定的外层循环索引 $i$，内层循环的回边恰好被遍历 $i$ 次。\n\n为了求出回边遍历的总次数 $M_{latch}$，我们必须将外层循环每次迭代（从 $i=0$ 到 $i=N-1$）的回边遍历次数相加。\n$$\nM_{latch} = \\sum_{i=0}^{N-1} i\n$$\n这是前 $N-1$ 个非负整数的和。一个等差级数 $0 + 1 + 2 + \\dots + (k-1)$ 的和由公式 $\\frac{k(k-1)}{2}$ 给出。在我们的例子中，级数是 $0 + 1 + \\dots + (N-1)$，这是一个等差数列的前 $N$ 项之和。其和由 $\\frac{n(a_1+a_n)}{2}$ 给出，其中 $n$ 是项数。这里 $n=N$, $a_1=0$, $a_N=N-1$。所以和为 $\\frac{N(0 + N-1)}{2} = \\frac{N(N-1)}{2}$。\n$$\nM_{latch} = \\sum_{i=0}^{N-1} i = 0 + 1 + 2 + \\dots + (N-1) = \\frac{(N-1)N}{2}\n$$\n现在，我们可以通过将来自两条边的贡献相加来计算移动指令的总数 $M$。\n$$\nM = M_{pre} + M_{latch} = N + \\frac{N(N-1)}{2}\n$$\n为了得到一个单一的闭式表达式，我们对其进行代数化简。\n$$\nM = \\frac{2N}{2} + \\frac{N^2 - N}{2} = \\frac{2N + N^2 - N}{2} = \\frac{N^2 + N}{2}\n$$\n这可以被因式分解为：\n$$\nM = \\frac{N(N+1)}{2}\n$$\n这个表达式代表前 $N$ 个正整数的和，也称为第 $N$ 个三角数。\n\n或者，我们可以这样推理：移动指令的总数等于内层循环头被进入的总次数。对于一个给定的外层索引 $i$，内层循环头从前置头进入一次（为 $j=0$ 启动循环），并从循环闩进入 $i$ 次（对应于 $j=0, \\dots, i-1$ 的迭代）。因此，对于一个给定的 $i$，循环头被进入 $1+i$ 次。对所有可能的 $i$ 值求和：\n$$\nM = \\sum_{i=0}^{N-1} (1+i) = (1+0) + (1+1) + \\dots + (1 + (N-1)) = \\sum_{k=1}^{N} k\n$$\n这是前 $N$ 个正整数的和，这也证实了我们的结果。\n$$\n\\sum_{k=1}^{N} k = \\frac{N(N+1)}{2}\n$$\n运行时寄存器到寄存器移动指令的总数是 $\\frac{N(N+1)}{2}$。", "answer": "$$\n\\boxed{\\frac{N(N+1)}{2}}\n$$", "id": "3653540"}]}