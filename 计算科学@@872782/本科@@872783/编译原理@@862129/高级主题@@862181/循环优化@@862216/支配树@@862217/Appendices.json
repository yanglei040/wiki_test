{"hands_on_practices": [{"introduction": "理论必须与实践相结合。第一个练习将带领你从头开始，为一个包含循环的简单控制流图计算其支配集、立即支配节点树和支配边界。这个练习旨在阐明这些数据结构在编译器最重要的优化之一——静态单赋值（SSA）中，是如何指导$\\phi$函数放置的 (problem_id:3638820)。通过这个练习，你将把支配树的抽象概念与其核心应用场景直接联系起来。", "problem": "考虑以下控制流图 (CFG)，其基本块标记为 $S$、$H$、$B$、$B_1$、$B_2$、$B_3$、$J$ 和 $T$。有向边为：$S \\to H$、$H \\to B$、$H \\to T$、$B \\to B_1$、$B \\to B_2$、$B_1 \\to J$、$B_2 \\to B_3$、$B_3 \\to J$ 和 $J \\to H$。块 $H$ 是循环头，回边是 $J \\to H$。假设一个标量变量 $x$ 最初在 $S$ 中定义，在两个不同的循环体块 $B_1$ 和 $B_3$ 中被更新，并在 $J$ 处（在走回边之前）、在 $H$ 处的循环继续测试中以及循环退出后在 $T$ 处被使用。需要使用迭代支配边界方法构建静态单赋值 (SSA) 形式，并假设根据上述使用情况指定的活跃性进行剪枝 SSA 放置。\n\n任务：\n- 计算给定 CFG 以 $S$ 为根的支配集和直接支配节点树。\n- 从第一性原理出发，计算循环头 $H$ 的支配边界，并证明该集合中每个元素的合理性。\n- 仅使用支配、直接支配节点和支配边界的定义，通过其定义位置的迭代支配边界来确定变量 $x$ 的最小 SSA $\\phi$-函数放置。特别解释循环头 $H$ 的支配边界如何指导循环携带值的 $\\phi$-函数放置。\n- 最后，报告在给定的活跃性假设下，使用迭代支配边界进行最小 SSA 放置后，必须包含变量 $x$ 的 $\\phi$-函数的不同基本块的总数。\n\n你的最终答案必须是一个等于包含变量 $x$ 的 $\\phi$-函数的不同基本块数量的整数。不要包含任何单位。无需四舍五入。", "solution": "问题陈述是有效的。这是一个编译原理中定义明确的问题，基于控制流图 (CFG)、支配节点分析和静态单赋值 (SSA) 形式构建的既定原则。给定条件是自洽且一致的，可以得出一个唯一的解。\n\n该问题描述了一个 CFG，其基本块集合为 $V = \\{S, H, B, B_1, B_2, B_3, J, T\\}$。入口块是 $S$。有向边集合为 $E = \\{(S, H), (H, B), (H, T), (B, B_1), (B, B_2), (B_1, J), (B_2, B_3), (B_3, J), (J, H)\\}$。变量 $x$ 在块 $\\{S, B_1, B_3\\}$ 中定义，在块 $\\{H, J, T\\}$ 中使用。\n\n**1. 支配集和直接支配节点树**\n\n如果从入口节点 $S$ 到节点 $M$ 的每条路径都包含节点 $N$，则称节点 $N$ 支配节点 $M$。如果 $N$ 支配 $M$ 且 $N \\neq M$，则称节点 $N$ 严格支配 $M$。$M$ 的直接支配节点，记为 $idom(M)$，是在任何从入口到 $M$ 的路径上最接近 $M$ 的严格支配节点。\n\n通过分析从入口节点 $S$ 到每个其他节点的所有路径，我们计算出每个节点 $N \\in V$ 的支配集 $Dom(N)$：\n- $Dom(S) = \\{S\\}$\n- $Dom(H) = \\{S, H\\}$。任何到 $H$ 的路径要么是 $S \\to H$，要么通过循环本身再次经过 $H$。\n- $Dom(B) = \\{S, H, B\\}$。任何到 $B$ 的路径都形如 $S \\to \\dots \\to H \\to B$。\n- $Dom(T) = \\{S, H, T\\}$。任何到 $T$ 的路径都形如 $S \\to \\dots \\to H \\to T$。\n- $Dom(B_1) = \\{S, H, B, B_1\\}$。任何到 $B_1$ 的路径都形如 $S \\to \\dots \\to H \\to B \\to B_1$。\n- $Dom(B_2) = \\{S, H, B, B_2\\}$。任何到 $B_2$ 的路径都形如 $S \\to \\dots \\to H \\to B \\to B_2$。\n- $Dom(B_3) = \\{S, H, B, B_2, B_3\\}$。任何到 $B_3$ 的路径都形如 $S \\to \\dots \\to H \\to B \\to B_2 \\to B_3$。\n- $Dom(J) = \\{S, H, B, J\\}$。到 $J$ 的路径有 $S \\to \\dots \\to B_1 \\to J$ 和 $S \\to \\dots \\to B_3 \\to J$。$B_1$ 和 $B_3$ 的共同支配节点是 $\\{S, H, B\\}$，因此它们必须在任何到 $J$ 的路径上。\n\n根据支配集，我们确定每个节点 $N \\neq S$ 的直接支配节点 $idom(N)$：\n- $idom(H) = S$\n- $idom(B) = H$\n- $idom(T) = H$\n- $idom(B_1) = B$\n- $idom(B_2) = B$\n- $idom(B_3) = B_2$\n- $idom(J) = B$。$J$ 的前驱节点是 $B_1$ 和 $B_3$。在支配节点树中，$B_1$ 和 $B_3$ 的最低公共祖先是 $B$。\n\n得到的以 $S$ 为根的直接支配节点树是：\n$S$ 是 $H$ 的父节点。\n$H$ 是 $B$ 和 $T$ 的父节点。\n$B$ 是 $B_1$、$B_2$ 和 $J$ 的父节点。\n$B_2$ 是 $B_3$ 的父节点。\n\n**2. 循环头 $H$ 的支配边界**\n\n一个节点 $N$ 的支配边界，记为 $DF(N)$，是所有节点 $Y$ 的集合，其中 $N$ 支配 $Y$ 在 CFG 中的一个直接前驱，但 $N$ 并不严格支配 $Y$。形式化地：\n$$DF(N) = \\{ Y \\in V \\mid (\\exists P \\in pred_{CFG}(Y) \\text{ s.t. } N \\in Dom(P)) \\land (N \\notin Dom(Y) \\setminus \\{Y\\}) \\}$$\n我们从这个第一性原理计算 $DF(H)$。我们必须找到节点 $Y$，使得 $H$ 支配 $Y$ 的一个前驱 $P$，但 $H$ 不严格支配 $Y$。不被 $H$ 严格支配的节点集合是 $\\{S, H\\}$。我们只需要检查这两个节点作为 $Y$ 的潜在候选者。\n- **候选者 $Y=S$**：在给定的 CFG 中，节点 $S$ 没有前驱。条件 $(\\exists P \\in pred_{CFG}(S))$ 为假。因此，$S \\notin DF(H)$。\n- **候选者 $Y=H$**：$H$ 的前驱是 $S$ 和 $J$。\n    - 考虑前驱 $P=S$：$H$ 不支配 $S$（实际上，$S$ 支配 $H$），所以这个前驱不满足条件。\n    - 考虑前驱 $P=J$：$H$ 支配 $J$，因为 $Dom(J) = \\{S, H, B, J\\}$。条件的第一个部分满足了。现在我们检查第二部分：$H$ 是否不严格支配 $H$？是的，$H$ 支配它自身，但不是严格支配。条件的第二部分也满足了。\n因此，$H \\in DF(H)$。\n\n因为没有其他节点可以在 $H$ 的支配边界中，我们得出结论 $DF(H) = \\{H\\}$。这个结果是循环头的典型特征；它们是来自循环外部和来自循环回边的控制流的合并点。\n\n**3. 最小化 SSA $\\phi$-函数放置**\n\n变量 $x$ 的最小 $\\phi$-函数集合被放置在包含 $x$ 定义的块集合的迭代支配边界 $IDF(Defs(x))$ 处。初始定义位置是 $Defs(x) = \\{S, B_1, B_3\\}$。$IDF$ 使用工作列表算法计算。\n\n首先，我们需要定义位置以及我们后续放置 $\\phi$-函数的所有位置的支配边界。\n- $DF(S) = \\emptyset$，因为 $S$ 没有前驱，且其唯一的后继 $H$ 被 $S$ 严格支配。\n- $DF(B_1) = \\{J\\}$。$B_1$ 有一个后继 $J$。$J$ 的一个前驱是 $B_1$，它被 $B_1$ 支配。然而，$B_1$ 并不严格支配 $J$（实际上是 $B$ 支配）。因此，$J \\in DF(B_1)$。\n- $DF(B_3) = \\{J\\}$。$J$ 的一个前驱是 $B_3$，它被 $B_3$ 支配。然而，$B_3$ 并不严格支配 $J$。因此，$J \\in DF(B_3)$。\n- $DF(J) = \\{H\\}$。$H$ 的一个前驱是 $J$，它被 $J$ 支配。然而，$J$ 并不严格支配 $H$。因此，$H \\in DF(J)$。\n- $DF(H) = \\{H\\}$，如前所述。\n\n工作列表算法过程如下：\n- 初始化工作列表 $W = \\{S, B_1, B_3\\}$。初始化带有 $\\phi$-函数的节点集合 $\\Phi = \\emptyset$。\n- **步骤 1**：从 $W$ 中弹出 $S$。计算 $DF(S) = \\emptyset$。没有新的 $\\phi$-函数被添加。$W = \\{B_1, B_3\\}$。\n- **步骤 2**：从 $W$ 中弹出 $B_1$。计算 $DF(B_1) = \\{J\\}$。由于 $J \\notin \\Phi$，在 $J$ 处添加一个 $\\phi$-函数。更新 $\\Phi = \\{J\\}$ 并将 $J$ 添加到工作列表：$W = \\{B_3, J\\}$。\n- **步骤 3**：从 $W$ 中弹出 $B_3$。计算 $DF(B_3) = \\{J\\}$。由于 $J \\in \\Phi$，不执行任何操作。$W = \\{J\\}$。\n- **步骤 4**：从 $W$ 中弹出 $J$。计算 $DF(J) = \\{H\\}$。由于 $H \\notin \\Phi$，在 $H$ 处添加一个 $\\phi$-函数。更新 $\\Phi = \\{J, H\\}$ 并将 $H$ 添加到工作列表：$W = \\{H\\}$。\n- **步骤 5**：从 $W$ 中弹出 $H$。计算 $DF(H) = \\{H\\}$。由于 $H \\in \\Phi$，不执行任何操作。$W = \\emptyset$。\n\n工作列表现在为空。算法终止。需要 $\\phi$-函数的块集合是 $\\Phi = \\{J, H\\}$。\n\n问题指定了*剪枝* SSA 放置，这意味着只有当变量 $x$ 在节点 $Y$ 的入口处是活跃的，才会在 $Y$ 处放置 $\\phi$-函数。\n- 在 $J$ 处放置一个 $\\phi$-函数。问题陈述 $x$ 在 $J$ 处被使用。因此，$x$ 在进入 $J$ 时是活跃的，这个 $\\phi$-函数是必需的。\n- 在 $H$ 处放置一个 $\\phi$-函数。问题陈述 $x$ 在 $H$ 处用于循环测试。因此，$x$ 在进入 $H$ 时是活跃的，这个 $\\phi$-函数是必需的。\n活跃性分析证实了这两个 $\\phi$-函数都是必需的。\n\n在循环头 $H$ 处放置 $\\phi$-函数对于处理循环携带值至关重要。如果一个 $x$ 的值在一个迭代中定义并在后续迭代中使用，则它被认为是循环携带的。在本例中，$x$ 的定义发生在循环体中（$B_1$、$B_3$）。这些定义在块 $J$ 处到达迭代的末尾。回边 $J \\to H$ 将此值带到下一次迭代的开始。循环头 $H$ 是 $x$ 的两组不同到达定义的合并点：来自 $S$ 的初始值（首次进入时）和来自 $J$ 的前一次迭代的值。支配边界的形式化方法正确地将 $H$ 识别为这个合并点。迭代算法首先找到循环体内部两条路径的汇合点 $J$（$DF(B_1) \\cup DF(B_3) = \\{J\\}$）。然后，将 $J$ 视为一个新的定义位置，算法找到循环本身的汇合点（$DF(J)=\\{H\\}$）。因此，$H$ 处的 $\\phi$-函数正确地合并了 $x$ 的初始值和 $x$ 的循环携带值。\n\n**4. 最终计数**\n\n必须为变量 $x$ 包含 $\\phi$-函数的不同基本块的集合是 $\\{J, H\\}$。这些块的总数是 $2$。", "answer": "$$\n\\boxed{2}\n$$", "id": "3638820"}, {"introduction": "真实的编译器常常需要修改控制流图以方便后续的优化。本练习将探讨一种常见的图变换——关键边拆分（critical edge splitting）(problem_id:3638838)。你将分析这一修改如何影响支配树和支配边界，从而深入理解支配关系分析的稳定性，以及为何这类变换在实践中如此重要。", "problem": "考虑以下有向控制流图（CFG），其中 CFG 是 Control Flow Graph 的缩写。入口块用 $R$ 表示，唯一的出口块用 $X$ 表示。基本块的集合是 $\\{R, A, B, C, D, E, F, X\\}$，有向边如下：\n- $R \\to A$\n- $A \\to B$, $A \\to C$, $A \\to F$\n- $B \\to D$\n- $C \\to E$\n- $D \\to F$\n- $E \\to F$\n- $F \\to X$\n\n假设使用标准定义：如果从 $R$ 到节点 $n$ 的每条路径都包含节点 $d$，则称节点 $d$ 支配 (dominates) 节点 $n$；立即支配节点 (immediate dominator) $\\mathrm{idom}(n)$ 是 $n$ 的唯一严格支配节点，它不支配 $n$ 的任何其他严格支配节点；支配树 (dominator tree)是由父指针 $\\mathrm{idom}(\\cdot)$ 形成的树；支配边界 (dominance frontier) $\\mathrm{DF}(X)$ 是所有节点 $Y$ 的集合，其中 $X$ 支配 $Y$ 的一个前驱节点，但 $X$ 并不严格支配 $Y$。如果 $u$ 的出度 $> 1$ 且 $v$ 的入度 $> 1$，则边 $u \\to v$ 称为关键边 (critical edge)。\n\n1) 在上述 CFG 中识别一条关键边，并通过在该边上插入一个新块 $S$ 来分割它，将 $u \\to v$ 替换为 $u \\to S$ 和 $S \\to v$。\n\n2) 仅使用上述核心定义（支配、立即支配、支配树和支配边界），推断此边分割对支配关系和支配边界的影响。\n\n选择在执行所述分割后所有为真的陈述：\n\nA. 在通过插入一个新块 $S$ 分割关键边 $A \\to F$ 后（边变为 $A \\to S$ 和 $S \\to F$），原始节点 $\\{R, A, B, C, D, E, F, X\\}$ 中的立即支配节点保持不变；限制在这些原始节点上的支配树与分割前相同。\n\nB. 分割后，关于原始节点，$B$ 的支配边界不再包含 $F$，因为 $B$ 不再支配 $F$ 的任何前驱节点。\n\nC. 分割后，由于新节点 $S$ 的存在，在增广图上计算的支配边界可能会有所不同（例如，$\\mathrm{DF}(S)$ 包含 $F$），尽管对于每个原始节点 $Y$，集合 $\\mathrm{DF}(Y)$ 与原始节点的交集保持不变。\n\nD. 分割关键边 $A \\to F$ 可能会改变支配 $F$ 的原始节点，从而可能改变原始节点中 $F$ 的立即支配节点 $\\mathrm{idom}(F)$。\n\nE. 分割关键边为该边提供了一个唯一的程序点，这在后续的转换（如静态单赋值（SSA）形式构建，SSA 是 Static Single Assignment 的缩写）中可能很有用，但它本身并不需要从汇合节点移动任何 $\\phi$-函数；原始节点间的支配关系不受影响。", "solution": "用户要求对一个关于控制流图（CFG）、支配节点和支配边界的问题进行详细分析。第一步是验证问题陈述。\n\n### 步骤 1：提取已知条件\n\n-   **图结构：** 一个有向控制流图（CFG）。\n-   **入口块：** $R$。\n-   **出口块：** $X$。\n-   **基本块集合：** $\\{R, A, B, C, D, E, F, X\\}$。\n-   **有向边：**\n    -   $R \\to A$\n    -   $A \\to B$, $A \\to C$, $A \\to F$\n    -   $B \\to D$\n    -   $C \\to E$\n    -   $D \\to F$\n    -   $E \\to F$\n    -   $F \\to X$\n-   **定义：**\n    -   **支配（Dominance）：** 如果从 $R$ 到节点 $n$ 的每条路径都包含节点 $d$，则称节点 $d$ 支配节点 $n$。\n    -   **立即支配节点（Immediate Dominator）：** $\\mathrm{idom}(n)$ 是 $n$ 的唯一严格支配节点，它不支配 $n$ 的任何其他严格支配节点。如果节点 $d$ 支配节点 $n$ 且 $d \\neq n$，则称 $d$ 严格支配 $n$。\n    -   **支配树（Dominator Tree）：** 由父指针 $\\mathrm{idom}(\\cdot)$ 形成的树。\n    -   **支配边界（Dominance Frontier）：** $\\mathrm{DF}(X)$ 是所有节点 $Y$ 的集合，其中 $X$ 支配 $Y$ 的一个前驱节点，但 $X$ 并不严格支配 $Y$。\n    -   **关键边（Critical Edge）：** 如果 $u$ 的出度 $> 1$ 且 $v$ 的入度 $> 1$，则边 $u \\to v$ 称为关键边。\n-   **任务：**\n    1.  识别一条关键边，并通过在该边上插入一个新块 $S$ 来分割它，将 $u \\to v$ 替换为 $u \\to S$ 和 $S \\to v$。\n    2.  推断此边分割对支配关系和支配边界的影响。\n\n### 步骤 2：使用提取的已知条件进行验证\n\n-   **科学基础（关键）：** 该问题基于编译器理论中标准的、完善的概念，特别是静态程序分析。CFG、支配、立即支配节点、支配树、支配边界和关键边的定义都是规范的。该问题在科学上和数学上是合理的。**通过。**\n-   **良构性（Well-Posed）：** 图被完全指定，所有术语都有定义，任务明确。基于所提供的定义，图转换的分析具有确定的结果。**通过。**\n-   **客观性（关键）：** 问题使用计算机科学中常见的精确、形式化的语言陈述。它没有主观或模糊的术语。**通过。**\n-   **完整性：** 问题提供了进行所需分析的所有必要信息（图结构和所有相关定义）。它是自洽的。**通过。**\n-   **一致性：** 提供的图结构或定义中没有矛盾。**通过。**\n\n### 步骤 3：结论和行动\n\n问题陈述是**有效的**。可以进行分析。\n\n### 解题推导\n\n分析将分三个阶段进行：\n1.  分析原始 CFG，为支配关系和支配边界建立基线。\n2.  执行指定的边分割转换。\n3.  分析修改后的 CFG，并将其属性与原始 CFG 进行比较。\n4.  基于此比较分析评估每个选项。\n\n**1. 原始 CFG 分析**\n\n首先，我们确定节点的入度和出度，以识别关键边。\n-   $\\mathrm{out}(R)=1, \\mathrm{in}(R)=0$\n-   $\\mathrm{out}(A)=3, \\mathrm{in}(A)=1$\n-   $\\mathrm{out}(B)=1, \\mathrm{in}(B)=1$\n-   $\\mathrm{out}(C)=1, \\mathrm{in}(C)=1$\n-   $\\mathrm{out}(D)=1, \\mathrm{in}(D)=1$\n-   $\\mathrm{out}(E)=1, \\mathrm{in}(E)=1$\n-   $\\mathrm{out}(F)=1, \\mathrm{in}(F)=3$\n-   $\\mathrm{out}(X)=0, \\mathrm{in}(X)=1$\n\n一条关键边 $u \\to v$ 要求 $\\mathrm{out}(u) > 1$ 且 $\\mathrm{in}(v) > 1$。唯一满足此条件的边是 $A \\to F$，因为 $\\mathrm{out}(A)=3$ 且 $\\mathrm{in}(F)=3$。问题要求分析对此边的分割。\n\n**支配节点（原始 CFG）：**\n-   $\\mathrm{dom}(R) = \\{R\\}$\n-   到任何其他节点的每条路径都必须经过 $A$。因此，$A$ 支配除 $R$ 之外的所有节点。\n-   $\\mathrm{dom}(A) = \\{R, A\\}$\n-   $\\mathrm{dom}(B) = \\{R, A, B\\}$\n-   $\\mathrm{dom}(C) = \\{R, A, C\\}$\n-   $\\mathrm{dom}(D) = \\{R, A, B, D\\}$\n-   $\\mathrm{dom}(E) = \\{R, A, C, E\\}$\n-   到 $F$ 的路径有 $R \\to A \\to F$，$R \\to A \\to B \\to D \\to F$ 和 $R \\to A \\to C \\to E \\to F$。公共节点是 $R$ 和 $A$。所以，$\\mathrm{dom}(F) = \\{R, A, F\\}$。\n-   所有到 $X$ 的路径都必须经过 $F$。所以，$\\mathrm{dom}(X) = \\mathrm{dom}(F) \\cup \\{X\\} = \\{R, A, F, X\\}$。\n\n**立即支配节点（原始 CFG）：**\n-   $\\mathrm{idom}(A) = R$\n-   $\\mathrm{idom}(B) = A$\n-   $\\mathrm{idom}(C) = A$\n-   $\\mathrm{idom}(F) = A$\n-   $\\mathrm{idom}(D) = B$\n-   $\\mathrm{idom}(E) = C$\n-   $\\mathrm{idom}(X) = F$\n\n**支配边界（原始 CFG）：**\n我们应用定义：如果 $Z$ 支配 $Y$ 的一个前驱节点，但 $Z$ 不严格支配 $Y$，则 $Y \\in \\mathrm{DF}(Z)$。\n-   $\\mathrm{DF}(B)$：$B$ 支配 $F$ 的一个前驱节点 $D$。$B$ 不支配 $F$，所以它不严格支配 $F$。因此，$F \\in \\mathrm{DF}(B)$。\n-   $\\mathrm{DF}(C)$：$C$ 支配 $F$ 的一个前驱节点 $E$。$C$ 不严格支配 $F$。因此，$F \\in \\mathrm{DF}(C)$。\n-   $\\mathrm{DF}(D)$：$D$ 支配其自身，即 $F$ 的一个前驱节点。$D$ 不严格支配 $F$。因此，$F \\in \\mathrm{DF}(D)$。\n-   $\\mathrm{DF}(E)$：$E$ 支配其自身，即 $F$ 的一个前驱节点。$E$ 不严格支配 $F$。因此，$F \\in \\mathrm{DF}(E)$。\n-   $\\mathrm{DF}(A)$：从 $A$ 出发的路径唯一可能的汇合点是 $F$。然而，$A$ 严格支配 $F$（因为 $\\mathrm{idom}(F)=A$）。条件“$A$ 不严格支配 $Y$”对于 $Y=F$ 是假的。对于任何其他节点 $Y$，如果 $A$ 支配其一个前驱，那么 $A$ 也严格支配 $Y$。因此，$\\mathrm{DF}(A) = \\emptyset$。\n-   因此，$\\mathrm{DF}(B) = \\{F\\}$，$\\mathrm{DF}(C) = \\{F\\}$，$\\mathrm{DF}(D) = \\{F\\}$，$\\mathrm{DF}(E) = \\{F\\}$。\n\n**2. 边分割转换**\n\n通过插入一个新块 $S$ 来分割关键边 $A \\to F$。\n-   边 $A \\to F$ 被移除。\n-   添加新边 $A \\to S$ 和 $S \\to F$。\n-   块的集合变为 $\\{R, A, B, C, D, E, S, F, X\\}$。\n-   $S$ 的前驱是 $\\{A\\}$。\n-   $F$ 的前驱现在是 $\\{D, E, S\\}$。\n\n**3. 修改后 CFG 的分析**\n\n**对支配关系的影响：**\n我们考虑两个原始节点 $U$ 和 $V$。如果从 $R$ 到 $N$ 的每条路径都包含 $D$，则节点 $D$ 支配节点 $N$。\n原始图中不使用边 $A \\to F$ 的任何路径在新图中仍然是一条路径。\n原始图中形如 $\\dots \\to A \\to F \\to \\dots$ 的任何路径在新图中变为路径 $\\dots \\to A \\to S \\to F \\to \\dots$。此路径上的原始节点集合保持不变。\n因此，如果在分割前，原始节点 $D$ 位于从 $R$ 到原始节点 $N$ 的每条路径上，那么分割后它仍然位于每条这样的路径上。如果在分割前存在一条从 $R$ 到 $N$ 且避开 $D$ 的路径，那么该路径（或其插入了 S 的版本）仍然存在并避开 $D$。\n因此，对于任意两个原始节点 $U, V$，$U$ 在新图中支配 $V$ 当且仅当 $U$ 在旧图中支配 $V$。这意味着原始节点间的支配关系、严格支配关系和立即支配关系都保持不变。\n\n-   对于任何原始节点 $N$，$\\mathrm{dom}_{\\text{new}}(N) = \\mathrm{dom}_{\\text{old}}(N)$。\n-   对于任何原始节点 $N$，$\\mathrm{idom}_{\\text{new}}(N) = \\mathrm{idom}_{\\text{old}}(N)$。\n-   $\\mathrm{dom}(S) = \\mathrm{dom}(A) \\cup \\{S\\} = \\{R, A, S\\}$，所以 $\\mathrm{idom}(S) = A$。\n\n**对支配边界的影响：**\n让我们重新评估 DF。\n-   对于任何原始节点 $Y$，当限制在原始节点范围内时，$\\mathrm{DF}_{\\text{new}}(Y)$ 是否与 $\\mathrm{DF}_{\\text{old}}(Y)$ 不同？\n-   原始节点中，只有 $F$ 的前驱节点集合发生了变化：$\\mathrm{preds}_{\\text{new}}(F) = \\{D, E, S\\}$。\n-   我们来检查 $\\mathrm{DF}_{\\text{new}}(B)$。我们检查 $F$ 是否在 $\\mathrm{DF}_{\\text{new}}(B)$ 中。$B$ 必须支配 $F$ 的一个前驱节点，并且不严格支配 $F$。\n    -   $\\mathrm{preds}_{\\text{new}}(F) = \\{D, E, S\\}$。$B$ 不支配 $S$ 或 $E$。然而，$B$ 仍然支配 $D$。\n    -   $B$ 不严格支配 $F$。\n    -   两个条件都成立。因此，$F \\in \\mathrm{DF}_{\\text{new}}(B)$。\n-   同样的逻辑适用于 $C, D, E$。它们的支配边界仍然包含 $F$。\n-   原始节点的其他前驱节点集合没有改变。原始节点之间的支配关系没有改变。因此，对于任何原始节点 $Y$，限制在原始节点范围内的 $\\mathrm{DF}_{\\text{new}}(Y)$ 与 $\\mathrm{DF}_{\\text{old}}(Y)$ 相同。\n-   那么新的 DF 呢？我们来计算 $\\mathrm{DF}(S)$。\n    -   我们检查节点 $F$。$F$ 来自 $S$ 的前驱是 $S$ 本身。$S$ 支配其前驱 $S$。\n    -   $S$ 是否严格支配 $F$？$\\mathrm{dom}(F)=\\{R, A, F\\}$。$S$ 不在该集合中，所以 $S$ 不支配 $F$。\n    -   条件满足。因此，$F \\in \\mathrm{DF}(S)$。\n\n**4. 逐项评估**\n\n**A. 在通过插入一个新块 $S$ 分割关键边 $A \\to F$ 后（边变为 $A \\to S$ 和 $S \\to F$），原始节点 $\\{R, A, B, C, D, E, F, X\\}$ 中的立即支配节点保持不变；限制在这些原始节点上的支配树与分割前相同。**\n我们的分析表明，任意两个原始节点之间的支配关系在此转换下是不变的。其直接结果是，任何原始节点的立即支配节点保持不变。因此，连接原始节点的支配树结构是相同的。\n**结论：正确。**\n\n**B. 分割后，关于原始节点，$B$ 的支配边界不再包含 $F$，因为 $B$ 不再支配 $F$ 的任何前驱节点。**\n该陈述的前提是错误的。$F$ 的新前驱是 $\\{D, E, S\\}$。正如我们的分析所确定，节点 $B$ 仍然支配节点 $D$。由于 $B$ 支配 $F$ 的一个前驱（即 $D$）并且 $B$ 不严格支配 $F$，所以 $F$ 仍然在 $B$ 的支配边界中。\n**结论：错误。**\n\n**C. 分割后，由于新节点 $S$ 的存在，在增广图上计算的支配边界可能会有所不同（例如，$\\mathrm{DF}(S)$ 包含 $F$），尽管对于每个原始节点 $Y$，集合 $\\mathrm{DF}(Y)$ 与原始节点的交集保持不变。**\n该陈述有两个部分。\n1.  “由于新节点 $S$ 的存在，在增广图上计算的支配边界可能会有所不同（例如，$\\mathrm{DF}(S)$ 包含 $F$）”——我们的分析表明 $F \\in \\mathrm{DF}(S)$。这是一个以前不存在的新的支配边界关系。这部分是正确的。\n2.  “对于每个原始节点 $Y$，集合 $\\mathrm{DF}(Y)$ 与原始节点的交集保持不变。”——我们的分析表明，对于任何原始节点 $Y$，其包含原始节点的支配边界集合保持不变。只有 $F$ 的前驱集合发生了变化，但是对于先前在其 DF 中包含 $F$ 的每个节点 $Z$，仍然存在一个 $Z$ 所支配的 $F$ 的前驱。所以对于所有原始节点 $Y$，$\\mathrm{DF}_{\\text{new}}(Y) = \\mathrm{DF}_{\\text{old}}(Y)$。因此，交集子句得到满足。这部分是正确的。\n由于陈述的两个部分都为真，整个陈述为真。\n**结论：正确。**\n\n**D. 分割关键边 $A \\to F$ 可能会改变支配 $F$ 的原始节点，从而可能改变原始节点中 $F$ 的立即支配节点 $\\mathrm{idom}(F)$。**\n这与我们对选项 A 的分析结果相矛盾。$F$ 的支配节点集合 $\\mathrm{dom}(F)$ 是通过取从 $R$ 到 $F$ 的所有路径上的节点的交集来确定的。该转换在某些路径上增加了 $S$，但任何路径上的*原始*节点集合是不变的。因此，这些原始节点集合的交集也是不变的。原始节点中 `dom(F)` 没有改变，因此 $\\mathrm{idom}(F)$ 也没有改变。\n**结论：错误。**\n\n**E. 分割关键边为该边提供了一个唯一的程序点，这在后续的转换（如静态单赋值（SSA）形式构建，SSA 是 Static Single Assignment 的缩写）中可能很有用，但它本身并不需要从汇合节点移动任何 $\\phi$-函数；原始节点间的支配关系不受影响。**\n这是一个概念性的陈述。让我们验证其各个部分。\n1.  “分割关键边为该边提供了一个唯一的程序点”：这是边分割的主要目的。新块 $S$ 作为放置逻辑上属于边 $A \\to F$ 的代码的唯一位置。这是正确的。\n2.  “在后续的转换（如...SSA）中可能很有用”：正确。在关键边上进行代码移动和插入补偿代码（例如，为 $\\phi$-函数进行寄存器移动）是有问题的。分割它们可以解决这个问题。\n3.  “它本身并不需要从汇合节点移动任何 $\\phi$-函数”：在 SSA 构建中，$\\phi$-函数被放置在包含变量定义的节点的迭代支配边界中的节点上。如对 C 的分析所示，原始节点的支配边界保持不变。因此，在原始节点上放置 $\\phi$-函数的标准保持不变。不需要将任何 $\\phi$-函数从一个原始节点移动到另一个原始节点。这是正确的。\n4.  “原始节点间的支配关系不受影响”：如对 A 的分析所确定，这是正确的。\n所有组成部分的论断都是编译器理论中的正确陈述，并且与我们对此图的具体分析相一致。\n**结论：正确。**", "answer": "$$\\boxed{ACE}$$", "id": "3638838"}, {"introduction": "并非所有的控制流图都是“结构良好”的。最后一个练习将向你抛出一个挑战：一个不可约流图（irreducible graph）(problem_id:3638857)，其中循环的头部不支配循环体内的所有节点。通过运用支配关系的基本定义来诊断问题，并应用节点拆分技术来修复它，你将学习到编译器如何处理这些复杂情况，并将其转化为可分析的形式。", "problem": "考虑以下控制流图 (CFG)，它有一个唯一的入口节点 $S$ 和一个唯一的出口节点 $T$。节点为 $S, A, B, C, D, E, F, T$。有向边如下：\n- $S \\to A$，\n- $A \\to B$，$A \\to C$，$A \\to F$，\n- $F \\to D$，\n- $B \\to D$，\n- $D \\to C$，\n- $C \\to E$，\n- $E \\to B$，$E \\to T$。\n\n该 CFG 在节点集 $\\{B, C, D, E\\}$ 上包含一个强连通分量 (SCC)，其循环为 $B \\to D \\to C \\to E \\to B$。我们将视此 SCC 为一个循环候选。\n\n你将使用以下基本定义：\n- 支配 (Dominance): 在一个入口为 $S$ 的 CFG 中，如果从 $S$ 到 $Y$ 的每一条路径都包含节点 $X$，则称节点 $X$ 支配节点 $Y$。\n- 循环头 (Loop header): 循环头是支配其循环体中所有节点的节点。\n- 可约流图 (Reducible flow graph): 如果每个循环都是单入口的，则该 CFG 是可约的；等价地，每个循环都有一个单一的、支配循环体中所有节点的循环头。\n- 不可约流图 (Irreducible flow graph): 如果存在某个循环，它有多个从 SCC 外部进入 SCC 中不同节点的独立入口边，导致没有任何单个节点能支配整个 SCC，则该 CFG 是不可约的。\n\n任务：\n1) 仅使用上述定义，通过检查 $B$ 是否支配 $C$ 和 $D$ 来论证节点 $B$ 是否能作为 SCC $\\{B, C, D, E\\}$ 的循环头。根据你的推理，判断该 SCC 相对于 $B$ 是否是不可约的。\n\n2) 为了修复不可约性，应用以下确定性的节点分裂过程，并将 $B$ 指定为循环头 $H$：\n   - 通过边 $B \\mapsto D$, $D \\mapsto C$, $C \\mapsto E$, $E \\mapsto B$ 在 SCC 上定义唯一的朝向循环头的后继映射。对于任何 $v \\in \\{B,C,D,E\\}$，此选择通过重复遵循此映射直至到达 $B$，导出了到 $H = B$ 的唯一朝向循环头的路径。\n   - 对于每一条边 $(u \\to v)$，其中 $u \\notin \\{B,C,D,E\\}$ 且 $v \\in \\{B,C,D,E\\}$ 并且 $v \\neq B$，沿着从 $v$ 到 $B$ 的朝向循环头的路径执行节点分裂：\n     • 创建从 $v$ 开始到 $B$ 之前结束的朝向循环头的路径上每个节点的新副本。如果路径是 $v = w_{0} \\to w_{1} \\to \\dots \\to w_{k-1} \\to w_{k} = B$，则创建新节点 $w_{0}', w_{1}', \\dots, w_{k-1}'$。\n     • 将 $(u \\to v)$ 重定向到 $(u \\to w_{0}')$，并添加边 $w_{i}' \\to w_{i+1}'$（对于 $i = 0, \\dots, k-2$）和 $w_{k-1}' \\to B$。\n     • 对于从任何 $w_{i}$ 到 SCC 外部节点的任何原始出口边，从 $w_{i}'$ 添加相同的出口边到该外部目标。\n     • 不要在不同的外部入口边之间共享副本；每个外部入口沿其到 $B$ 的路径生成自己的一组新副本。\n   - 如果 $v = B$（循环头），则对 $(u \\to v)$ 不执行任何操作。\n\n3) 设 $N$ 为此修复过程在给定 CFG 上创建的新节点副本的总数。计算 $N$。你的最终答案必须是一个实数。无需四舍五入。", "solution": "我们从支配、循环头以及可约与不可约流图的定义开始。\n\n步骤 1：检测不可约性和非支配关系。\n- SCC $\\{B, C, D, E\\}$ 通过 $B \\to D \\to C \\to E \\to B$ 形成一个循环，因此这四个节点是相互可达的。这是一个循环候选。\n- 进入此 SCC 的外部入口边是指从 SCC 外部节点指向 SCC 内部节点的边。根据边列表：\n  • $A \\to B$ 在 $B$ 进入 SCC。\n  • $A \\to C$ 在 $C$ 进入 SCC。\n  • $F \\to D$ 在 $D$ 进入 SCC。\n  因此，有三条不同的入口边进入 SCC，目标分别是 $B$、$C$ 和 $D$。\n- 要测试 $B$ 是否能成为循环头，我们必须验证 $B$ 是否支配 SCC 中的每一个节点。使用支配的定义，检查 $C$ 和 $D$：\n  • 对于 $C$：存在一条路径 $S \\to A \\to C$，它到达 $C$ 而不经过 $B$。因此，并非每一条从 $S$ 到 $C$ 的路径都包含 $B$，所以 $B$ 不支配 $C$。\n  • 对于 $D$：存在一条路径 $S \\to A \\to F \\to D$，它到达 $D$ 而不经过 $B$。因此， $B$ 不支配 $D$。\n  由于 $B$ 未能支配至少 $C$ 和 $D$，所以 $B$ 不能作为该 SCC 的循环头。根据单入口准则，多个外部入口（$(A \\to C)$ 和 $(F \\to D)$）进入 SCC 的不同节点，意味着该 SCC 相对于 $B$ 是不可约的。\n\n步骤 2：应用带有朝向循环头的后继映射的确定性节点分裂修复。\n- 朝向循环头的后继映射被指定为 $B \\mapsto D$, $D \\mapsto C$, $C \\mapsto E$, $E \\mapsto B$。这为 SCC 中的任何节点产生了到 $B$ 的唯一朝向循环头的路径：\n  • 从 $C$ 出发：$C \\to E \\to B$。\n  • 从 $D$ 出发：$D \\to C \\to E \\to B$。\n  • 从 $E$ 出发：$E \\to B$。\n  • 从 $B$ 出发：已在 $B$。\n- 我们必须处理每一个外部入口 $(u \\to v)$，其中 $u \\notin \\{B,C,D,E\\}$ 且 $v \\in \\{B,C,D,E\\}$，$v \\neq B$。\n\n存在两条这样的边：\n- 边 $(A \\to C)$，其中 $v = C \\neq B$。\n  • 从 $C$ 到 $B$ 的朝向循环头的路径是 $C \\to E \\to B$。此路径上严格在 $B$ 之前的节点是 $C$ 和 $E$。\n  • 创建新副本 $C_{1}$ 和 $E_{1}$。\n  • 将 $A \\to C$ 重定向到 $A \\to C_{1}$。\n  • 添加边 $C_{1} \\to E_{1}$ 和 $E_{1} \\to B$。\n  • 复制从原始节点到 SCC 外部的出口边：$E$ 有一个出口边 $E \\to T$，所以添加 $E_{1} \\to T$。在原始图中，节点 $C$ 没有到 SCC 外部的出口，因此不需要为 $C_{1}$ 复制出口。\n  • 此外部入口贡献的新节点数量为 $2$（节点 $C_{1}$ 和 $E_{1}$）。\n\n- 边 $(F \\to D)$，其中 $v = D \\neq B$。\n  • 从 $D$ 到 $B$ 的朝向循环头的路径是 $D \\to C \\to E \\to B$。此路径上严格在 $B$ 之前的节点是 $D$、$C$ 和 $E$。\n  • 创建新副本 $D_{2}$、$C_{2}$ 和 $E_{2}$。\n  • 将 $F \\to D$ 重定向到 $F \\to D_{2}$。\n  • 添加边 $D_{2} \\to C_{2}$、$C_{2} \\to E_{2}$ 和 $E_{2} \\to B$。\n  • 复制从原始节点到 SCC 外部的出口边：$E$ 有出口 $E \\to T$，所以添加 $E_{2} \\to T$。在原始图中，节点 $D$ 和 $C$ 没有到 SCC 外部的出口，因此不需要为 $D_{2}$ 或 $C_{2}$ 复制出口。\n  • 此外部入口贡献的新节点数量为 $3$（节点 $D_{2}$、$C_{2}$ 和 $E_{2}$）。\n\n根据过程规定，副本在不同的外部入口之间不共享。因此，创建的新节点总数是这两个入口贡献数量的总和。\n\n步骤 3：计算 $N$。\n- 来自 $(A \\to C)$：$2$ 个新节点。\n- 来自 $(F \\to D)$：$3$ 个新节点。\n因此，\n$$\nN = 2 + 3 = 5.\n$$\n\n步骤 4：后置条件检查（此修复在概念上为何有效）。\n- 经过这些转换后，从 SCC $\\{B, C, D, E\\}$ 外部进入原始 SCC 节点的唯一剩余边是 $A \\to B$（循环头）。重定向的边现在进入新副本，然后到达 $B$ 或在 $T$ 退出，而不会进入除 $B$ 之外的任何原始 SCC 节点。\n- 因此，从 $S$ 到原始 SCC 中任何节点的每条路径都必须经过 $B$，所以 $B$ 现在支配了 SCC 中的所有节点，使得该循环成为单入口，并且 CFG 相对于该循环是可约的。\n- 计算出的 $N$ 量化了在指定的确定性过程下通过节点分裂进行的修复的规模。\n\n因此，创建的新节点副本总数为 $5$。", "answer": "$$\\boxed{5}$$", "id": "3638857"}]}