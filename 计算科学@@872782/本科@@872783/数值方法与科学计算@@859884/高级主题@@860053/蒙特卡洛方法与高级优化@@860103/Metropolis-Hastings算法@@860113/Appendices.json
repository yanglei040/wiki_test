{"hands_on_practices": [{"introduction": "要掌握 Metropolis-Hastings 算法，第一步是理解其核心机制——接受概率的计算。这个练习 [@problem_id:1401721] 将引导你完成这一基本计算。通过一个在简单网格上移动的机器人的直观场景，你将学会如何运用目标分布的比率和提议分布的比率来确定是否接受一个新状态，从而将抽象的公式转化为具体的实践。", "problem": "一个清洁机器人在一个小的2x2网格上工作。机器人的状态由其坐标 $(i, j)$ 给出，其中行索引 $i$ 和列索引 $j$ 都可以是1或2。该机器人被编程来从一个目标平稳分布 $P(i, j)$ 中采样，已知该分布与坐标之和成正比，即 $P(i, j) \\propto i+j$。\n\n机器人的移动由一个简单的提议机制决定。从当前状态出发，机器人识别所有相邻（非对角线）的网格单元。然后它提议移动到这些相邻单元中的一个，每个相邻单元被选择的概率相等。\n\n使用Metropolis-Hastings算法，计算从初始状态 $(1,2)$ 到新状态 $(1,1)$ 的提议移动的接受概率。\n\n最终答案必须是单一的封闭形式解析表达式。", "solution": "我们要求解当目标分布为 $\\pi(i,j)\\propto i+j$ 且提议在相邻的非对角线邻居中均匀选择时，从当前状态 $x=(1,2)$ 移动到提议状态 $y=(1,1)$ 的Metropolis-Hastings接受概率。\n\n根据Metropolis-Hastings法则，接受概率为\n$$\n\\alpha(x\\to y)=\\min\\left(1,\\frac{\\pi(y)\\,q(y\\to x)}{\\pi(x)\\,q(x\\to y)}\\right).\n$$\n因为 $\\pi(i,j)\\propto i+j$，目标概率的比值为\n$$\n\\frac{\\pi(1,1)}{\\pi(1,2)}=\\frac{1+1}{1+2}=\\frac{2}{3}.\n$$\n提议 $q(\\cdot\\to\\cdot)$ 在有效的相邻邻居中均匀选择。\n\n从 $x=(1,2)$ 出发，相邻的非对角线邻居是 $(1,1)$ 和 $(2,2)$，所以有 $2$ 个邻居，因此\n$$\nq\\big((1,2)\\to(1,1)\\big)=\\frac{1}{2}.\n$$\n从 $y=(1,1)$ 出发，相邻的非对角线邻居是 $(1,2)$ 和 $(2,1)$，所以有 $2$ 个邻居，因此\n$$\nq\\big((1,1)\\to(1,2)\\big)=\\frac{1}{2}.\n$$\n因此，提议比率为\n$$\n\\frac{q\\big((1,1)\\to(1,2)\\big)}{q\\big((1,2)\\to(1,1)\\big)}=\\frac{\\frac{1}{2}}{\\frac{1}{2}}=1.\n$$\n将这些放在一起，\n$$\n\\alpha\\big((1,2)\\to(1,1)\\big)=\\min\\left(1,\\frac{2}{3}\\cdot 1\\right)=\\frac{2}{3}.\n$$", "answer": "$$\\boxed{\\frac{2}{3}}$$", "id": "1401721"}, {"introduction": "在掌握了基本计算之后，我们将转向一个在实际应用中至关重要的问题：数值稳定性。当处理的概率值极小时，直接计算它们的比率可能会导致计算机出现下溢错误。这个问题 [@problem_id:1401715] 介绍了一种标准的解决方案：在对数域（log-domain）中进行计算，将概率比率的计算转化为对数概率的差值，这大大增强了算法的鲁棒性。", "problem": "一位计算生物学家正在开发一个统计模型，用于分析一个柔性生物分子的构象状态。该分子的状态由一个广义坐标 $\\theta$ 描述。状态的未归一化后验概率密度 $\\pi(\\theta)$ 由于其值极小，直接进行计算具有挑战性。因此，该模型由其未归一化的对数后验密度 $\\mathcal{L}(\\theta) = \\ln(\\pi(\\theta))$ 定义，其表达式为：\n$$\n\\mathcal{L}(\\theta) = -A (\\theta - \\theta_0)^4 - B \\sin^2(k \\theta)\n$$\n为了探索可能状态的分布情况，使用了 Metropolis-Hastings 马尔可夫链蒙特卡洛 (MCMC) 算法。该算法使用对称的提议分布，从当前状态 $\\theta$ 生成一个提议的新状态 $\\theta'$，这意味着从 $\\theta$ 提议 $\\theta'$ 的概率与从 $\\theta'$ 提议 $\\theta$ 的概率相同。\n\n为了保持数值稳定性并避免下溢错误，算法的接受准则在对数域中进行评估。算法不计算接受概率 $A$，而是直接计算一个称为对数接受率的量 $\\alpha_{\\log}$。如果从 $[0, 1]$ 上的均匀分布中抽取的随机数 $u$ 满足 $\\ln(u)  \\alpha_{\\log}$（对于 $\\alpha_{\\log}$ 为负的情况），则接受提议的移动。\n\n考虑模拟中的一个步骤，其中当前状态为 $\\theta = 0.25$，提议的新状态为 $\\theta' = 0.35$。模型参数设置如下：\n- $A = 120.0$\n- $\\theta_0 = 0.10$\n- $B = 20.0$\n- $k = 2\\pi$\n\n计算此特定提议移动的对数接受率 $\\alpha_{\\log}$ 的数值。三角函数的所有参数均以弧度为单位。将您的最终答案四舍五入到四位有效数字。", "solution": "Metropolis-Hastings 算法的核心是从状态 $\\theta$ 到提议状态 $\\theta'$ 的转移的接受概率 $A$。它由下式给出：\n$$\nA(\\theta'|\\theta) = \\min \\left( 1, \\frac{\\pi(\\theta') Q(\\theta|\\theta')}{\\pi(\\theta) Q(\\theta'|\\theta)} \\right)\n$$\n其中 $\\pi(\\theta)$ 是目标概率密度，而 $Q(x'|x)$ 是提议分布。\n\n题目说明提议分布是对称的，这意味着 $Q(\\theta'|\\theta) = Q(\\theta|\\theta')$。这将接受概率简化为：\n$$\nA(\\theta'|\\theta) = \\min \\left( 1, \\frac{\\pi(\\theta')}{\\pi(\\theta)} \\right)\n$$\n题目规定，为避免数值下溢，算法计算对数接受率 $\\alpha_{\\log}$。这是 $\\min$ 函数内部比率项的自然对数：\n$$\n\\alpha_{\\log} = \\ln \\left( \\frac{\\pi(\\theta')}{\\pi(\\theta)} \\right)\n$$\n使用对数的性质，这可以表示为对数概率的差：\n$$\n\\alpha_{\\log} = \\ln(\\pi(\\theta')) - \\ln(\\pi(\\theta))\n$$\n题目将未归一化的对数后验密度定义为 $\\mathcal{L}(\\theta) = \\ln(\\pi(\\theta))$。因此，我们可以用 $\\mathcal{L}(\\theta)$ 来表示对数接受率：\n$$\n\\alpha_{\\log} = \\mathcal{L}(\\theta') - \\mathcal{L}(\\theta)\n$$\n这种形式在数值上是稳定的，因为它涉及中等大小的数（$\\mathcal{L}(\\theta)$ 值）的差，而不是极小的数（$\\pi(\\theta)$ 值）的比率。\n\n现在，我们代入给定的 $\\mathcal{L}(\\theta)$ 表达式：\n$$\n\\mathcal{L}(\\theta) = -A (\\theta - \\theta_0)^4 - B \\sin^2(k \\theta)\n$$\n所以，$\\alpha_{\\log}$ 的表达式变为：\n$$\n\\alpha_{\\log} = \\left[ -A (\\theta' - \\theta_0)^4 - B \\sin^2(k \\theta') \\right] - \\left[ -A (\\theta - \\theta_0)^4 - B \\sin^2(k \\theta) \\right]\n$$\n重新整理各项，我们得到：\n$$\n\\alpha_{\\log} = -A \\left[ (\\theta' - \\theta_0)^4 - (\\theta - \\theta_0)^4 \\right] - B \\left[ \\sin^2(k \\theta') - \\sin^2(k \\theta) \\right]\n$$\n现在，我们代入指定的数值：\n- $A = 120.0$\n- $\\theta_0 = 0.10$\n- $B = 20.0$\n- $k = 2\\pi$\n- $\\theta = 0.25$\n- $\\theta' = 0.35$\n\n首先，我们计算第一项的各个部分：\n- $\\theta - \\theta_0 = 0.25 - 0.10 = 0.15$\n- $\\theta' - \\theta_0 = 0.35 - 0.10 = 0.25$\n- $(\\theta' - \\theta_0)^4 - (\\theta - \\theta_0)^4 = (0.25)^4 - (0.15)^4 = 0.00390625 - 0.00050625 = 0.0034$\n\n接下来，我们计算第二项的各个部分。正弦函数的参数以弧度为单位。\n- $k \\theta = 2\\pi \\times 0.25 = \\frac{\\pi}{2}$\n- $k \\theta' = 2\\pi \\times 0.35 = 0.7\\pi$\n- $\\sin(k \\theta) = \\sin(\\frac{\\pi}{2}) = 1$\n- $\\sin(k \\theta') = \\sin(0.7\\pi)$\n- $\\sin^2(k \\theta') - \\sin^2(k \\theta) = \\sin^2(0.7\\pi) - 1^2$\n我们可以使用恒等式 $\\sin(\\pi - x) = \\sin(x)$ 来计算 $\\sin(0.7\\pi) = \\sin(\\pi - 0.3\\pi) = \\sin(0.3\\pi)$。\n- $\\sin^2(0.7\\pi) - 1 = (\\sin(0.7\\pi))^2 - 1 \\approx (0.809017)^2 - 1 \\approx 0.654508 - 1 = -0.345492$\n\n现在，我们可以组合出 $\\alpha_{\\log}$ 的最终值：\n$$\n\\alpha_{\\log} = -120.0 \\times (0.0034) - 20.0 \\times (\\sin^2(0.7\\pi) - 1)\n$$\n$$\n\\alpha_{\\log} \\approx -120.0 \\times 0.0034 - 20.0 \\times (-0.345492)\n$$\n$$\n\\alpha_{\\log} \\approx -0.408 + 6.90984\n$$\n$$\n\\alpha_{\\log} \\approx 6.50184\n$$\n将结果四舍五入到四位有效数字，我们得到：\n$$\n\\alpha_{\\log} = 6.502\n$$", "answer": "$$\\boxed{6.502}$$", "id": "1401715"}, {"introduction": "一个成功的 MCMC 模拟不仅需要正确的计算，还需要满足一个关键的理论前提：遍历性（ergodicity），即采样器必须能够探索到目标分布的所有可能区域。这个问题 [@problem_id:1401742] 构建了一个巧妙的场景，其中采样器由于提议分布的步长太小而“困在”了分布的某个局部区域，无法访问整个状态空间。这个练习揭示了选择合适提议分布的深层重要性，确保了你的马尔可夫链能够忠实地反映整个目标分布。", "problem": "一位统计学家正在使用马尔可夫链蒙特卡洛（MCMC）算法从一维目标概率密度 $p(x)$ 中抽样。随机变量 $x$ 的状态空间 $\\mathcal{X}$ 定义为两个不相交区间的并集：$\\mathcal{X} = [-2, -1] \\cup [1, 2]$。\n\n未归一化的目标密度 $f(x)$ 分段定义如下：\n$$\nf(x) = \\begin{cases}\n1  \\text{if } x \\in [-2, -1] \\\\\n3  \\text{if } x \\in [1, 2] \\\\\n0  \\text{otherwise}\n\\end{cases}\n$$\n归一化目标密度为 $p(x) = f(x) / Z$，其中 $Z = \\int_{\\mathcal{X}} f(x) dx$。\n\n该采样器使用Metropolis-Hastings算法。在每一步，给定当前状态 $x_t$，从一个对称的提议分布 $q(x'|x_t)$ 中提议一个候选状态 $x'$，该分布是区间 $[x_t - 0.5, x_t + 0.5]$ 上的均匀分布。如果提议的状态 $x'$ 落在状态空间 $\\mathcal{X}$ 之外，它将被自动拒绝。\n\n采样器在状态 $x_0 = 1.5$ 处初始化。然后运行非常多次迭代。根据MCMC的理论，样本的长期平均值 $\\frac{1}{N}\\sum_{i=1}^N x_i$ 应收敛到链的平稳分布下 $x$ 的期望值。\n\n确定 $x$ 的样本均值将收敛到的数值。请用精确分数表示你的答案。", "solution": "未归一化的目标密度是分段常数：在 $[-2,-1]$ 上 $f(x)=1$，在 $[1,2]$ 上 $f(x)=3$，在其他地方为 $0$。归一化常数为\n$$\nZ=\\int_{\\mathcal{X}} f(x)\\,dx=\\int_{-2}^{-1} 1\\,dx+\\int_{1}^{2} 3\\,dx=x\\big|_{-2}^{-1}+3x\\big|_{1}^{2}=1+3=4.\n$$\n因此，全空间上的归一化目标密度为 $p(x)=f(x)/Z$，它在 $[-2,-1]$ 上分配的总质量为 $\\int_{-2}^{-1} p(x)\\,dx=\\frac{1}{4}$，在 $[1,2]$ 上分配的总质量为 $\\int_{1}^{2} p(x)\\,dx=\\frac{3}{4}$。\n\nMetropolis-Hastings提议是对称的：$q(x'|x)$ 在 $[x-0.5,x+0.5]$ 上是均匀分布。落在 $\\mathcal{X}$ 之外的提议被拒绝，这等价于在 $\\mathcal{X}$ 之外目标密度为零的标准MH规则。关键的是，因为最大提议步长为 $0.5$，而两个区间之间的间隔为 $2$，所以在任意数量的接受步骤中，从一个区间移动到另一个区间的概率为零：对于任何 $x\\in[1,2]$，提议的支撑集 $[x-0.5,x+0.5]\\subset[0.5,2.5]$，所以任何提议的 $x'1$ 或 $x'>2$ 都落在 $\\mathcal{X}$ 之外并被拒绝。因此，该马尔可夫链有两个封闭的互通类，从 $x_{0}=1.5\\in[1,2]$ 开始，它将永远停留在 $[1,2]$ 中。\n\n在 $[1,2]$ 内，$f(x)\\equiv 3$ 是常数，因此对于任何提议的 $x'\\in[1,2]$，Metropolis-Hastings的接受概率为 $\\min\\{1,f(x')/f(x)\\}=1$。限制在该类上的马尔可夫链的不变分布与 $[1,2]$ 上的 $f$ 成正比，因此是在 $[1,2]$ 上的均匀分布：\n$$\ng(x)=\\frac{f(x)}{\\int_{1}^{2} f(u)\\,du}=\\frac{3}{\\int_{1}^{2}3\\,du}=\\frac{3}{3}=1\\quad\\text{for }x\\in[1,2],\n$$\n在其他情况下 $g(x)=0$。因此，长期样本均值收敛到 $g$ 分布下 $X$ 的期望，即\n$$\n\\mathbb{E}_{g}[X]=\\int_{1}^{2} x\\,g(x)\\,dx=\\int_{1}^{2} x\\,dx=\\frac{1}{2}x^{2}\\bigg|_{1}^{2}=\\frac{1}{2}\\left(4-1\\right)=\\frac{3}{2}.\n$$\n根据封闭互通类内马尔可夫链的遍历定理，经验均值 $\\frac{1}{N}\\sum_{i=1}^{N} x_{i}$ 几乎必然收敛到 $\\mathbb{E}_{g}[X]=\\frac{3}{2}$。", "answer": "$$\\boxed{\\frac{3}{2}}$$", "id": "1401742"}]}