{"hands_on_practices": [{"introduction": "精确控制近似误差是树形码算法的核心。这个练习 [@problem_id:3480580] 将让你实践一个基本但至关重要的任务：将一个给定的误差容忍度 $ \\varepsilon $ 与一个常用的开放判据参数 $ \\alpha $ 联系起来。通过推导被忽略的主导项（即四极矩项）在最坏情况下的贡献，你将建立一个不依赖于方向的、稳健的性能保证。", "problem": "在牛顿 $N$ 体宇宙学模拟中，一个巴恩斯-赫特 (BH) 树代码通过将多极展开截断至单极项来近似计算一个遥远单元的引力影响，即将该单元的总质量置于其质心处。考虑这样一个单元，其总质量为 $M$，质心位于原点，且其所有组成质量均位于半径为 $s/2$ 的球体内（因此该单元的特征尺寸为 $s$）。一个目标粒子位于距原点 $r$ 处，其单位方向矢量为 $\\mathbf{n} = \\mathbf{r}/r$。假设由于展开是围绕质心进行的，偶极项为零。\n\n首个被忽略的项是四极项。质量四极张量定义为\n$$\nQ_{ij} \\equiv \\sum_{a} m_{a} \\left( 3 x_{a,i} x_{a,j} - |\\mathbf{x}_{a}|^{2} \\delta_{ij} \\right),\n$$\n其中 $\\mathbf{x}_{a}$ 是单元内粒子相对于质心的位置， $m_{a}$ 是它们的质量，而 $\\delta_{ij}$ 是克罗内克 δ 符号。目标粒子从已接受的相互作用中获得了一个当前的总加速度大小估计值 $|\\mathbf{a}_{\\text{ref}}|$。\n\n该树代码使用以下接受检验，其参数为一个无量纲阈值 $\\alpha$：如果满足\n$$\n\\frac{G M s^{2}}{r^{4}} \\leq \\alpha \\, |\\mathbf{a}_{\\text{ref}}|,\n$$\n则对于该目标粒子，该单元在单极阶被接受。其中 $G$ 是引力常数。在单元内部质量分布相对于 $\\mathbf{n}$ 的最坏朝向情况下，要求接受单个单元所导致的目标粒子加速度的总相对误差（即，该单元的首个被忽略项贡献的大小与 $|\\mathbf{a}_{\\text{ref}}|$ 的比值）严格小于一个指定的容差 $\\varepsilon$。\n\n仅从牛顿引力定律和上述四极矩的定义出发，推导该单元的四极加速度贡献的最紧的、与朝向无关的界，并确定 $\\alpha$，使得任何被接受的单个单元所产生的最坏情况下的相对误差界 $\\leq \\varepsilon$。将 $\\alpha$ 的最终答案表示为仅含 $\\varepsilon$ 的闭式解析表达式。不需要四舍五入，$\\alpha$ 是无量纲的。", "solution": "质心位于原点的局域质量分布在场点 $\\mathbf{r}$ 处产生的牛顿引力势可以进行多极展开。当偶极项为零时（以质心为中心），直到四极阶的势可以写为\n$$\n\\Phi(\\mathbf{r}) = - \\frac{G M}{r} - \\frac{G}{2 r^{3}} \\, T(\\mathbf{n}) + \\mathcal{O}\\!\\left(\\frac{1}{r^{4}}\\right),\n$$\n其中 $r = |\\mathbf{r}|$, $\\mathbf{n} = \\mathbf{r}/r$，以及\n$$\nT(\\mathbf{n}) \\equiv n_{i} n_{j} Q_{ij} = \\mathbf{n}^{\\mathsf{T}} Q \\, \\mathbf{n}.\n$$\n相应的加速度为 $\\mathbf{a}(\\mathbf{r}) = - \\nabla \\Phi(\\mathbf{r})$，因此对加速度的四极贡献为\n$$\n\\mathbf{a}^{(2)}(\\mathbf{r}) = - \\nabla \\left( - \\frac{G}{2 r^{3}} \\, T(\\mathbf{n}) \\right) = \\nabla \\left( \\frac{G}{2 r^{3}} \\, T(\\mathbf{n}) \\right).\n$$\n为了界定 $|\\mathbf{a}^{(2)}|$，将梯度分为径向和角向部分：\n$$\n\\nabla \\left( r^{-3} T(\\mathbf{n}) \\right) = \\left( \\frac{\\partial}{\\partial r} r^{-3} \\right) T(\\mathbf{n}) \\, \\hat{\\mathbf{r}} + r^{-3} \\, \\nabla_{\\Omega} T(\\mathbf{n}),\n$$\n其中 $\\nabla_{\\Omega}$ 表示单位球面上的角向梯度，$\\hat{\\mathbf{r}} = \\mathbf{n}$ 是径向单位矢量。径向导数因子为 $\\partial (r^{-3})/\\partial r = -3 r^{-4}$，所以径向分量为\n$$\n\\mathbf{a}^{(2)}_{\\mathrm{rad}}(\\mathbf{r}) = \\frac{G}{2} \\left( -3 r^{-4} \\right) T(\\mathbf{n}) \\, \\hat{\\mathbf{r}} = - \\frac{3 G}{2 r^{4}} \\, T(\\mathbf{n}) \\, \\hat{\\mathbf{r}}.\n$$\n角向分量为\n$$\n\\mathbf{a}^{(2)}_{\\mathrm{tan}}(\\mathbf{r}) = \\frac{G}{2} \\, r^{-3} \\, \\nabla_{\\Omega} T(\\mathbf{n}).\n$$\n我们现在寻找使 $|\\mathbf{a}^{(2)}|$ 最大化的最坏朝向。注意到 $T(\\mathbf{n}) = \\mathbf{n}^{\\mathsf{T}} Q \\, \\mathbf{n}$ 是单位球面上的一个二次型。在 $|\\mathbf{n}| = 1$ 的约束下，其极值出现在当 $\\mathbf{n}$ 是对称张量 $Q$ 的一个特征向量时，极值等于相应的特征值。在这些极值点，角向梯度 $\\nabla_{\\Omega} T$ 为零，因此四极加速度是纯径向的，其大小为\n$$\n\\left| \\mathbf{a}^{(2)}(\\mathbf{r}) \\right| = \\frac{3 G}{2 r^{4}} \\, \\lambda_{\\max},\n$$\n其中 $\\lambda_{\\max}$ 是 $Q$ 的最大特征值。\n\n接下来需要根据单元的几何约束来界定 $\\lambda_{\\max}$。对于位于位置 $\\mathbf{x}$、满足 $|\\mathbf{x}| = r_{x}$ 的单个点质量 $m$，其对 $Q$ 的贡献是 $m \\left( 3 \\mathbf{x} \\mathbf{x}^{\\mathsf{T}} - r_{x}^{2} I \\right)$。这个秩一更新的最大特征值出现在沿 $\\mathbf{x}$ 的方向上，等于 $2 m r_{x}^{2}$（垂直方向上的特征值为 $- m r_{x}^{2}$）。因此，对于整个单元，\n$$\n\\lambda_{\\max} \\leq \\sum_{a} 2 m_{a} r_{a}^{2} = 2 \\sum_{a} m_{a} r_{a}^{2}.\n$$\n鉴于所有质量都包含在半径为 $s/2$ 的球体内，我们对每个 $a$ 都有 $r_{a} \\leq s/2$，因此\n$$\n\\sum_{a} m_{a} r_{a}^{2} \\leq \\sum_{a} m_{a} \\left( \\frac{s}{2} \\right)^{2} = M \\left( \\frac{s}{2} \\right)^{2} = \\frac{M s^{2}}{4}.\n$$\n于是，\n$$\n\\lambda_{\\max} \\leq 2 \\cdot \\frac{M s^{2}}{4} = \\frac{M s^{2}}{2}.\n$$\n这个上界是紧的：例如，将等量质量放置在穿过中心的同一轴上的 $\\pm \\frac{s}{2}$ 处即可达到此界，这样做会使所有特征向量对齐，并使最大特征值的总和达到饱和。\n\n将此界代入四极加速度大小，得到最坏情况下的、与朝向无关的界\n$$\n\\left| \\mathbf{a}^{(2)}(\\mathbf{r}) \\right| \\leq \\frac{3 G}{2 r^{4}} \\cdot \\frac{M s^{2}}{2} = \\frac{3}{4} \\, \\frac{G M s^{2}}{r^{4}}.\n$$\n于是，在单极阶接受该单元所引起的、相对于当前总加速度估计值大小 $|\\mathbf{a}_{\\text{ref}}|$ 的相对误差，其上界为\n$$\n\\frac{\\left| \\mathbf{a}^{(2)}(\\mathbf{r}) \\right|}{|\\mathbf{a}_{\\text{ref}}|} \\leq \\frac{3}{4} \\, \\frac{G M s^{2}}{r^{4} \\, |\\mathbf{a}_{\\text{ref}}|}.\n$$\n根据接受检验，\n$$\n\\frac{G M s^{2}}{r^{4}} \\leq \\alpha \\, |\\mathbf{a}_{\\text{ref}}|,\n$$\n因此任何被接受的单元都满足\n$$\n\\frac{\\left| \\mathbf{a}^{(2)}(\\mathbf{r}) \\right|}{|\\mathbf{a}_{\\text{ref}}|} \\leq \\frac{3}{4} \\, \\alpha.\n$$\n为保证这个最坏情况下的相对误差不大于指定的容差 $\\varepsilon$，选择 $\\alpha$ 使得\n$$\n\\frac{3}{4} \\, \\alpha \\leq \\varepsilon \\quad \\Rightarrow \\quad \\alpha = \\frac{4}{3} \\, \\varepsilon,\n$$\n这使得界饱和，因此是与要求相符的、允许的最大选择。这个 $\\alpha$ 是无量纲的，并且只依赖于 $\\varepsilon$。", "answer": "$$\\boxed{\\frac{4}{3}\\,\\varepsilon}$$", "id": "3480580"}, {"introduction": "虽然不依赖于方向的判据是安全的，但它们可能过于保守，导致不必要的计算开销。这个练习 [@problem_id:3480592] 使用一个简单的、高度各向异性的质量分布——一根细长的线状体——来生动地展示近似误差如何依赖于观测方向。这项实践突显了像 $s/r \\lt \\theta$ 这样简单的几何判据的内在局限性。", "problem": "考虑一根均匀、细长的质量丝，沿$z$轴排列，总长度为$L$，线密度为$\\lambda$，以原点为中心，其端点位于$z=-L/2$和$z=+L/2$。设总质量为$M=\\lambda L$。引力相互作用是牛顿引力，引力常数为$G$。对于远大于$L$的距离$r$，扩展质量分布的引力势可以表示为围绕质心的多极展开。无迹质量四极矩张量的定义为\n$$\nQ_{ij}=\\int \\rho(\\mathbf{r}')\\left(3 x'_i x'_j - r'^2 \\delta_{ij}\\right)\\,\\mathrm{d}^3\\mathbf{r}' \\, ,\n$$\n其中$\\delta_{ij}$是克罗内克δ函数，远场势包含一个与$n_i n_j Q_{ij}$成正比的四极矩贡献，其中$\\mathbf{n}=\\mathbf{r}/r$是视线单位矢量。\n\nBarnes–Hut (BH) 树代码使用几何张角判据$s/r\\theta$，其中$\\theta$是预设的容差，$s$是单元的特征尺寸。在本问题中，对于该质量丝，取$s=L$。在$r\\gg L$的极限下进行计算，并将原点置于质心，以使偶极矩贡献为零。\n\n任务：\n- 使用上述四极矩定义，推导该质量丝的主要非零分量$Q_{xx}$、$Q_{yy}$和$Q_{zz}$。\n- 基于牛顿引力的多极展开逻辑，将仅使用单极矩近似引力势的前导分数误差（定义为被忽略的四极矩项的量值除以单极矩项）用$\\mathbf{n}$、$Q_{ij}$、$M$和$r$表示。\n- 评估该分数误差在两个观测方向上的值：$\\mathbf{n}$平行于质量丝轴线（$z$轴）和$\\mathbf{n}$垂直于质量丝轴线（$x$轴）。展示当$s=L$时，误差如何依赖于$\\theta$，并解释为什么几何接受判据$s/r\\theta$会在某些观测角度下低估误差。\n\n答案要求：以$\\theta$的函数形式给出最坏情况下的分数误差的解析表达式。无需数值取整。最终答案必须是无单位的单一闭式表达式。", "solution": "该问题要求分析在Barnes-Hut树代码的张角判据背景下，对细长质量丝引力势进行单极矩近似所产生的前导阶误差。\n\n首先，我们计算指定质量丝的无迹质量四极矩张量$Q_{ij}$的分量。该质量丝具有恒定的线密度$\\lambda$，总长度为$L$，沿$z$轴排列，以原点为中心。其总质量为$M = \\lambda L$。三维质量密度$\\rho(\\mathbf{r}')$可以使用狄拉克δ函数表示为：\n$$\n\\rho(\\mathbf{r}') = \\lambda \\, \\delta(x') \\, \\delta(y') \\, \\Pi(z'/L)\n$$\n其中$\\Pi(u)$是矩形函数，当$|u| \\le 1/2$时等于$1$，否则为$0$。此处，质量分布内的位置矢量是$\\mathbf{r}' = (x', y', z')$。对于该质量丝，$x'=0$且$y'=0$，而$z'$的范围是$-L/2$到$L/2$。因此，$|\\mathbf{r}'|^2 = r'^2 = z'^2$。\n\n四极矩张量的定义是：\n$$\nQ_{ij} = \\int \\rho(\\mathbf{r}') \\left(3 x'_i x'_j - r'^2 \\delta_{ij}\\right) \\, \\mathrm{d}^3\\mathbf{r}'\n$$\n代入质量丝的密度，体积积分简化为沿$z'$轴的一维积分：\n$$\nQ_{ij} = \\lambda \\int_{-L/2}^{L/2} \\left(3 x'_i x'_j - z'^2 \\delta_{ij}\\right) \\, \\mathrm{d}z'\n$$\n其中$x'_1=x'=0$，$x'_2=y'=0$，$x'_3=z'$。\n\n由于轴对称性以及沿质量丝$x'=y'=0$的事实，任何非对角分量$Q_{ij}$（其中$i \\neq j$）必定包含一个为零的因子$x_i'$或$x_j'$（或两者都有）。例如，$Q_{12} = \\lambda \\int (3x'y' - ...) = 0$。因此，所有非对角分量都为零。\n\n现在我们计算对角分量：\n对于$Q_{zz}$（$i=j=3$）：\n$$\nQ_{zz} = \\lambda \\int_{-L/2}^{L/2} (3(z')^2 - (z')^2 \\delta_{33}) \\, \\mathrm{d}z' = 2\\lambda \\int_{-L/2}^{L/2} (z')^2 \\, \\mathrm{d}z'\n$$\n该积分的计算结果为$\\int_{-L/2}^{L/2} (z')^2 \\, \\mathrm{d}z' = \\left[\\frac{(z')^3}{3}\\right]_{-L/2}^{L/2} = \\frac{(L/2)^3}{3} - \\frac{(-L/2)^3}{3} = 2 \\frac{L^3/8}{3} = \\frac{L^3}{12}$。\n所以，$Q_{zz} = 2\\lambda \\left(\\frac{L^3}{12}\\right) = \\frac{\\lambda L^3}{6}$。代入$M = \\lambda L$，我们得到：\n$$\nQ_{zz} = \\frac{ML^2}{6}\n$$\n对于$Q_{xx}$（$i=j=1$）：\n$$\nQ_{xx} = \\lambda \\int_{-L/2}^{L/2} (3(x')^2 - (z')^2 \\delta_{11}) \\, \\mathrm{d}z' = \\lambda \\int_{-L/2}^{L/2} (0 - (z')^2) \\, \\mathrm{d}z' = -\\lambda \\left(\\frac{L^3}{12}\\right)\n$$\n代入$M = \\lambda L$，我们发现：\n$$\nQ_{xx} = -\\frac{ML^2}{12}\n$$\n根据对称性，$Q_{yy} = Q_{xx}$：\n$$\nQ_{yy} = -\\frac{ML^2}{12}\n$$\n作为检验，该张量必须是无迹的：$\\sum_i Q_{ii} = Q_{xx} + Q_{yy} + Q_{zz} = -\\frac{ML^2}{12} - \\frac{ML^2}{12} + \\frac{ML^2}{6} = 0$，这是正确的。\n\n接下来，我们构建分数误差的表达式。对于质心在原点的质量分布（因此偶极矩为零），引力势$\\Phi(\\mathbf{r})$的多极展开为：\n$$\n\\Phi(\\mathbf{r}) = -\\frac{GM}{r} - \\frac{G}{2r^3} \\sum_{i,j} Q_{ij} n_i n_j + \\mathcal{O}(r^{-4})\n$$\n其中$\\mathbf{n} = \\mathbf{r}/r$是指向观测点的单位矢量。单极矩项是$\\Phi_0 = -GM/r$，前导阶修正是四极矩项$\\Phi_2 = -\\frac{G}{2r^3} \\sum_{i,j} Q_{ij} n_i n_j$。仅使用单极矩近似的分数误差$\\epsilon$是四极矩项与单极矩项之比的量值：\n$$\n\\epsilon = \\left| \\frac{\\Phi_2}{\\Phi_0} \\right| = \\left| \\frac{-\\frac{G}{2r^3} \\sum_{i,j} Q_{ij} n_i n_j}{-\\frac{GM}{r}} \\right| = \\frac{1}{2Mr^2} \\left| \\sum_{i,j} Q_{ij} n_i n_j \\right|\n$$\n对于我们的质量丝，求和$\\sum Q_{ij} n_i n_j$为：\n$$\n\\sum_{i,j} Q_{ij} n_i n_j = Q_{xx}n_x^2 + Q_{yy}n_y^2 + Q_{zz}n_z^2 = -\\frac{ML^2}{12}n_x^2 - \\frac{ML^2}{12}n_y^2 + \\frac{ML^2}{6}n_z^2\n$$\n$$\n= \\frac{ML^2}{12} (-n_x^2 - n_y^2 + 2n_z^2)\n$$\n使用恒等式$n_x^2+n_y^2+n_z^2 = 1$，我们有$n_x^2+n_y^2 = 1-n_z^2$。代入此式可得：\n$$\n\\sum_{i,j} Q_{ij} n_i n_j = \\frac{ML^2}{12} \\left(-(1-n_z^2) + 2n_z^2\\right) = \\frac{ML^2}{12}(3n_z^2 - 1)\n$$\n将此结果代回$\\epsilon$的表达式中：\n$$\n\\epsilon = \\frac{1}{2Mr^2} \\left| \\frac{ML^2}{12}(3n_z^2 - 1) \\right| = \\frac{L^2}{24 r^2} |3n_z^2 - 1|\n$$\n现在，我们评估该误差在两个特定观测方向上的值。\n1.  平行于质量丝轴线（$\\mathbf{n}$沿$z$轴）：此时$n_z^2 = 1$。\n    $$\n    \\epsilon_{\\parallel} = \\frac{L^2}{24 r^2} |3(1) - 1| = \\frac{2L^2}{24r^2} = \\frac{L^2}{12r^2}\n    $$\n2.  垂直于质量丝轴线（$\\mathbf{n}$在$xy$平面内）：此时$n_z^2 = 0$。\n    $$\n    \\epsilon_{\\perp} = \\frac{L^2}{24 r^2} |3(0) - 1| = \\frac{L^2}{24r^2}\n    $$\nBarnes-Hut张角判据是$s/r  \\theta$，其中$s$是单元尺寸。本问题设定$s=L$。当$L/r  \\theta$时，来自该单元的力可用单极矩近似。对于给定的容差$\\theta$，最大误差出现在该条件的边界上，即$L/r = \\theta$。由此，我们得到$(L/r)^2 = \\theta^2$。我们可以用$\\theta$来表示误差：\n$$\n\\epsilon_{\\parallel} = \\frac{1}{12} \\left(\\frac{L}{r}\\right)^2 = \\frac{\\theta^2}{12}\n$$\n$$\n\\epsilon_{\\perp} = \\frac{1}{24} \\left(\\frac{L}{r}\\right)^2 = \\frac{\\theta^2}{24}\n$$\n误差取决于观测角度。几何判据$L/r  \\theta$是各向同性的；它只依赖于尺寸与距离的比值，而不依赖于质量分布相对于观测者的方向。对于固定的比值$L/r$（因而也是固定的$\\theta$），真实的分数误差$\\epsilon = \\frac{1}{24}(L/r)^2 |3n_z^2 - 1|$是可变的。当侧向观测质量丝时（$n_z=0$），误差最小，为$\\epsilon_{\\perp}$；当沿轴向观测时（$n_z=1$），误差最大，为$\\epsilon_{\\parallel} = 2 \\epsilon_{\\perp}$。因此，一个简单的几何张角判据无法提供统一的误差界限。如果选择的$\\theta$是为了满足某个“平均”方向上的误差容差，那么它将严重低估最坏情况方向（对于质量丝而言，即沿其轴线方向）的误差。\n\n最后，为了找到最坏情况下的分数误差，我们必须对表达式$\\epsilon = \\frac{\\theta^2}{24} |3n_z^2 - 1|$关于观测方向（由$n_z$参数化）求最大值。由于$0 \\le n_z^2 \\le 1$，当$n_z^2=1$时，项$|3n_z^2 - 1|$达到最大值。在这种情况下，因子为$|3(1)-1|=2$。\n在接受边界$L/r = \\theta$处，最坏情况下的分数误差$\\epsilon_{\\text{max}}$是：\n$$\n\\epsilon_{\\text{max}} = \\frac{\\theta^2}{24} \\times 2 = \\frac{\\theta^2}{12}\n$$", "answer": "$$\n\\boxed{\\frac{\\theta^2}{12}}\n$$", "id": "3480592"}, {"introduction": "本练习综合了前两个实践的经验，让你通过设计“最坏情况”的粒子排列来对各种开放判据进行压力测试 [@problem_id:3480537]。它超越了简单的几何测试，要求你实现并比较更先进的、考虑形状的判据，例如利用四极矩或惯性张量信息的判据。这为你提供了一个了解现代树形码如何实现更高准确性和效率的实用视角。", "problem": "给定一个引力树代码中的节点，该节点聚合了一个有限的点质量集合。该节点的特征是其总质量 $M$ 和包围半径 $s$，使得所有点质量都位于以该节点中心为球心、半径为 $s$ 的球体内。引力相互作用由牛顿引力支配，单极近似仅使用位于节点中心处的总质量 $M$ 来近似计算作用在远处目标上的力。在实践中，多极接受准则 (Multipole Acceptance Criteria, MACs) 用于确定一个节点是否离目标足够远，从而可以用近似方法处理，而无需打开该节点。\n\n从牛顿引力势及其多极展开出发，构建能够抵消偶极矩但最大化四极矩振幅的对抗性质点排列，并利用这些排列对 MACs 进行压力测试。然后，推导并实现基于惯性张量信息的形状感知 MACs。请遵循以下指令进行操作。\n\n1. 基本基础：\n   - 使用牛顿引力和紧凑源的引力势多极展开。只考虑点质量，并假设有 $N$ 个点质量 $\\{m_a\\}_{a=1}^N$ 位于节点内的位置 $\\{\\boldsymbol{x}_a\\}_{a=1}^N$，对于所有 $a$ 都有 $\\lVert \\boldsymbol{x}_a \\rVert \\le s$，总质量为 $M = \\sum_a m_a$。\n   - 定义质量二阶矩（在天体物理N体实践中有时称为惯性矩）$S_{ij} = \\sum_a m_a x_{a,i} x_{a,j}$，其迹 $t = \\mathrm{tr}(S) = \\sum_a m_a \\lVert \\boldsymbol{x}_a \\rVert^2$，以及无迹四极张量 $Q_{ij} = 3 S_{ij} - t \\,\\delta_{ij}$。\n   - 确保质心位于原点，即偶极矩为零：$\\sum_a m_a \\boldsymbol{x}_a = \\boldsymbol{0}$。\n\n2. 对抗性排列设计：\n   - 在固定 $M$ 和 $s$ 的约束下，构建满足偶极矩抵消条件并能最大化标量四极矩振幅 $Q_2$ 的明确点质量构型。使用无迹四极张量的 Frobenius 范数作为标量振幅，即 $Q_2 = \\lVert Q \\rVert_F = \\sqrt{\\mathrm{tr}(Q^T Q)}$。\n   - 提供至少一种实现最大 $Q_2$ 的排列，以及至少两种具有不同形状（例如，共线、平面和近似各向同性）的非最大但无偶极矩的排列，所有排列都具有相同的 $M$ 和 $s$。\n\n3. MAC 压力测试：\n   - 考虑一个距离节点中心为 $r$ 的目标，从节点到目标的视线单位向量为 $\\hat{\\boldsymbol{n}}$。实现以下 MACs：\n     - Barnes–Hut 多极接受准则 (BH MAC)：如果 $s/r \\le \\theta$ 则接受该节点，其中 $\\theta$ 是用户指定的张角参数。\n     - 形状感知四极矩范数 MAC：如果由四极项引起的分数加速度误差的保守界满足 $\\alpha \\, Q_2 / (M r^2) \\le \\varepsilon$，则接受该节点，其中 $\\varepsilon$ 是用户指定的容差，$\\alpha$ 是通过对四极矩的加速度贡献进行定界而获得的常数。\n     - 使用惯性张量的方向性形状感知 MAC：计算 $q_{\\mathrm{dir}} = \\lvert \\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}} \\rvert$，如果分数加速度误差的方向性界满足 $\\beta \\, q_{\\mathrm{dir}} / (M r^2) \\le \\varepsilon$，则接受该节点。此外，计算沿视线的质量加权方差 $\\sigma_n^2 = \\hat{\\boldsymbol{n}}^T (S/M) \\hat{\\boldsymbol{n}}$，如果 $\\sqrt{\\sigma_n^2}/r \\le \\theta$，则接受。\n   - 您的推导必须是严谨的，并从引力势及其梯度开始。从第一性原理出发，明确证明这些界中使用的常数 $\\alpha$ 和 $\\beta$ 的合理性。\n\n4. 要求的单位和输出：\n   - 在无量纲单位下工作，将 $M$ 和 $s$ 视为纯数，距离的单位与 $s$ 相同，因此不需要物理单位转换。角度不是必需的。\n   - 实现一个程序，为下面指定的每个测试用例构建对抗性排列，计算 $S_{ij}$、$Q_{ij}$、$Q_2$、$q_{\\mathrm{dir}}$ 以及 MAC 决策。\n   - 最终输出必须是单行，包含所有测试用例的结果列表。每个测试用例的结果必须是按顺序排列的四个布尔值的列表：$[$BH\\_accept, Qnorm\\_accept, Qdir\\_accept, Sigma\\_accept$]$。整个输出必须是这些列表的逗号分隔列表，并用方括号括起来，例如：$[[\\text{true},\\text{false},\\text{true},\\text{true}],[...],...]$。布尔值请使用小写。\n\n5. 测试套件：\n   - 所有情况均使用 $M = 1$ 和 $s = 1$。使用 $\\theta = 0.5$ 和 $\\varepsilon = 0.3$。\n   - 提供至少六个测试用例以涵盖不同方面：\n     1. 一个最大四极矩的杆状排列，两个等质量点位于 $x$ 轴上的 $\\pm s$ 位置，目标方向 $\\hat{\\boldsymbol{n}}$ 平行于杆，且 $r = 3$。\n     2. 相同的杆状排列，但 $\\hat{\\boldsymbol{n}}$ 垂直于杆（例如，沿 $y$ 轴），且 $r = 3$。\n     3. 一个平面的盘状排列，四个等质量点位于 $(\\pm s, 0, 0)$ 和 $(0, \\pm s, 0)$ 位置，$\\hat{\\boldsymbol{n}}$ 沿 $z$ 轴方向，且 $r = 3$。\n     4. 一个近似各向同性的排列，六个等质量点位于 $(\\pm s, 0, 0)$、$(0, \\pm s, 0)$ 和 $(0, 0, \\pm s)$ 位置，$\\hat{\\boldsymbol{n}}$ 沿任意轴（例如，$x$ 轴），且 $r = 3$。\n     5. 杆状排列的一个边界情况，$\\hat{\\boldsymbol{n}}$ 平行于杆，且 $r = 2$。\n     6. 杆状排列的一个远场情况，$\\hat{\\boldsymbol{n}}$ 平行于杆，且 $r = 10$。\n\n你的程序应生成单行输出，其中包含用方括号括起来的逗号分隔的结果列表（例如：\"[[true,false,true,true],[...],...]\"）。", "solution": "### 1. 引力势和多极展开\n\n由位于位置 $\\{\\boldsymbol{x}_a\\}$ 的源质量集合 $\\{m_a\\}$ 在目标位置 $\\boldsymbol{r}$ 产生的牛顿引力势为：\n$$\n\\Phi(\\boldsymbol{r}) = -G \\sum_a \\frac{m_a}{\\lVert \\boldsymbol{r} - \\boldsymbol{x}_a \\rVert}\n$$\n对于远处的目标，其中 $\\lVert \\boldsymbol{x}_a \\rVert \\ll \\lVert \\boldsymbol{r} \\rVert$，我们可以展开分母。设 $r = \\lVert \\boldsymbol{r} \\rVert$ 和 $\\hat{\\boldsymbol{n}} = \\boldsymbol{r}/r$。展开到四极阶的结果是：\n$$\n\\frac{1}{\\lVert \\boldsymbol{r} - \\boldsymbol{x}_a \\rVert} \\approx \\frac{1}{r} + \\frac{\\boldsymbol{r} \\cdot \\boldsymbol{x}_a}{r^3} + \\frac{3(\\boldsymbol{r} \\cdot \\boldsymbol{x}_a)^2 - r^2 \\lVert \\boldsymbol{x}_a \\rVert^2}{2r^5}\n$$\n将此代入势能求和中可得：\n$$\n\\Phi(\\boldsymbol{r}) \\approx - \\frac{G}{r}\\sum_a m_a - \\frac{G}{r^3}\\sum_a m_a (\\boldsymbol{r} \\cdot \\boldsymbol{x}_a) - \\frac{G}{2r^5}\\sum_a m_a (3(\\boldsymbol{r} \\cdot \\boldsymbol{x}_a)^2 - r^2 \\lVert \\boldsymbol{x}_a \\rVert^2)\n$$\n这些是单极、偶极和四极项。\n- **单极势：** $\\Phi_M(\\boldsymbol{r}) = -\\frac{GM}{r}$，其中 $M = \\sum_a m_a$ 是总质量。\n- **偶极势：** 问题陈述质心位于原点，因此偶极矩 $\\boldsymbol{d} = \\sum_a m_a \\boldsymbol{x}_a = \\boldsymbol{0}$。因此，偶极项为零。\n- **四极势：** 让我们使用定义的张量重写此项。设 $x_{a,i}$ 为 $\\boldsymbol{x}_a$ 的分量。四极项是：\n$$\n\\Phi_Q(\\boldsymbol{r}) = -\\frac{G}{2r^3} \\sum_a m_a \\left(3(\\hat{\\boldsymbol{n}} \\cdot \\boldsymbol{x}_a)^2 - \\lVert \\boldsymbol{x}_a \\rVert^2\\right) = -\\frac{G}{2r^3} \\hat{n}_i \\hat{n}_j \\sum_a m_a (3 x_{a,i} x_{a,j} - \\lVert \\boldsymbol{x}_a \\rVert^2 \\delta_{ij})\n$$\n求和中的量是无迹四极张量，$Q_{ij} = 3 S_{ij} - t \\delta_{ij}$，其中 $S_{ij} = \\sum_a m_a x_{a,i} x_{a,j}$ 是质量二阶矩张量，$t = \\mathrm{tr}(S) = \\sum_a m_a \\lVert \\boldsymbol{x}_a \\rVert^2$。\n因此，到四极阶的势为：\n$$\n\\Phi(\\boldsymbol{r}) \\approx \\Phi_M(\\boldsymbol{r}) + \\Phi_Q(\\boldsymbol{r}) = -\\frac{GM}{r} - \\frac{G}{2r^3} (\\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}})\n$$\n\n### 2. 引力加速度和误差界\n\n引力加速度为 $\\boldsymbol{a} = -\\nabla\\Phi$。\n- **单极加速度：** $\\boldsymbol{a}_M = -\\nabla\\Phi_M = -\\nabla(-\\frac{GM}{r}) = GM\\nabla(\\frac{1}{r}) = -\\frac{GM}{r^2}\\hat{\\boldsymbol{n}}$。其大小为 $\\lVert\\boldsymbol{a}_M\\rVert = \\frac{GM}{r^2}$。\n- **四极加速度：** $\\boldsymbol{a}_Q = -\\nabla\\Phi_Q = \\frac{G}{2}\\nabla\\left(\\frac{1}{r^3} \\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}}\\right) = \\frac{G}{2}\\nabla\\left(\\frac{\\boldsymbol{r}^T Q \\boldsymbol{r}}{r^5}\\right)$。\n该梯度的计算得出标准结果：\n$$\n\\boldsymbol{a}_Q = \\frac{G}{r^4} Q\\hat{\\boldsymbol{n}} - \\frac{5G}{2r^4}(\\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}})\\hat{\\boldsymbol{n}}\n$$\n接受准则是基于对分数误差 $\\lVert \\boldsymbol{a}_Q \\rVert / \\lVert \\boldsymbol{a}_M \\rVert$ 的定界。\n\n#### 用于四极矩范数 MAC 的常数 $\\alpha$ 的推导\n该准则为 $\\alpha \\, Q_2 / (M r^2) \\le \\varepsilon$，其中 $\\varepsilon$ 界定了分数误差。我们需要通过对 $\\lVert\\boldsymbol{a}_Q\\rVert$ 进行定界来找到 $\\alpha$ 的一个保守值。\n使用三角不等式对 $\\boldsymbol{a}_Q$ 的表达式进行处理：\n$$\n\\lVert\\boldsymbol{a}_Q\\rVert \\le \\frac{G}{r^4} \\left( \\lVert Q\\hat{\\boldsymbol{n}} \\rVert + \\frac{5}{2} \\lvert \\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}} \\rvert \\right)\n$$\n对于任何范数为 $\\lVert\\hat{\\boldsymbol{n}}\\rVert=1$ 的向量 $\\hat{\\boldsymbol{n}}$，我们有 $\\lVert Q\\hat{\\boldsymbol{n}} \\rVert \\le \\lVert Q \\rVert_2$ 和 $\\lvert \\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}} \\rvert \\le \\lVert Q \\rVert_2$，其中 $\\lVert Q \\rVert_2$ 是 $Q$ 的谱范数（最大绝对特征值）。\n$$\n\\lVert\\boldsymbol{a}_Q\\rVert \\le \\frac{G}{r^4} \\left( \\lVert Q \\rVert_2 + \\frac{5}{2} \\lVert Q \\rVert_2 \\right) = \\frac{7G}{2r^4} \\lVert Q \\rVert_2\n$$\n谱范数与 Frobenius 范数 $Q_2 = \\lVert Q \\rVert_F$ 的关系为 $\\lVert Q \\rVert_2 \\le \\lVert Q \\rVert_F$。因此，一个更宽松但更方便的界是：\n$$\n\\lVert\\boldsymbol{a}_Q\\rVert \\le \\frac{7G}{2r^4} Q_2\n$$\n分数误差则被界定为：\n$$\n\\frac{\\lVert\\boldsymbol{a}_Q\\rVert}{\\lVert\\boldsymbol{a}_M\\rVert} \\le \\frac{7 G Q_2 / (2r^4)}{GM/r^2} = \\frac{7}{2} \\frac{Q_2}{Mr^2}\n$$\nMAC准则要求误差估计值小于$\\varepsilon$。如果我们定义误差估计值为 $\\alpha \\frac{Q_2}{Mr^2}$，并使用上述保守界，则合适的$\\alpha$为$\\frac{7}{2}=3.5$。\n\n#### 用于方向性 MAC 的常数 $\\beta$ 的推导\n该准则为 $\\beta \\, q_{\\mathrm{dir}} / (M r^2) \\le \\varepsilon$，其中 $q_{\\mathrm{dir}} = \\lvert \\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}} \\rvert$。此准则通常关注沿视线方向的误差分量 $\\Delta a_n = \\boldsymbol{a}_Q \\cdot \\hat{\\boldsymbol{n}}$。\n$$\n\\Delta a_n = \\left(\\frac{G}{r^4} Q\\hat{\\boldsymbol{n}} - \\frac{5G}{2r^4}(\\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}})\\hat{\\boldsymbol{n}}\\right) \\cdot \\hat{\\boldsymbol{n}} = \\frac{G}{r^4} (\\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}}) - \\frac{5G}{2r^4} (\\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}}) (\\hat{\\boldsymbol{n}} \\cdot \\hat{\\boldsymbol{n}})\n$$\n由于 $\\hat{\\boldsymbol{n}} \\cdot \\hat{\\boldsymbol{n}} = 1$:\n$$\n\\Delta a_n = -\\frac{3G}{2r^4} (\\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}})\n$$\n径向加速度分量的分数误差为：\n$$\n\\frac{\\lvert\\Delta a_n\\rvert}{\\lVert\\boldsymbol{a}_M\\rVert} = \\frac{\\frac{3G}{2r^4} \\lvert\\hat{\\boldsymbol{n}}^T Q \\hat{\\boldsymbol{n}}\\rvert}{GM/r^2} = \\frac{3}{2} \\frac{q_{\\mathrm{dir}}}{Mr^2}\n$$\n与上述类似，如果我们定义方向性误差估计为 $\\beta \\frac{q_{\\mathrm{dir}}}{Mr^2}$，则合适的$\\beta$为$\\frac{3}{2}=1.5$。\n\n### 3. 其他 MACs\n\n- **Barnes-Hut (BH) MAC：** $s/r \\le \\theta$。这是一个简单的、与形状无关的准则，比较节点的包围半径 $s$ 和其距离 $r$。\n- **Sigma MAC：** $\\sqrt{\\sigma_n^2}/r \\le \\theta$。这里 $\\sigma_n^2 = \\hat{\\boldsymbol{n}}^T (S/M) \\hat{\\boldsymbol{n}} = \\frac{1}{M}\\sum_a m_a (\\boldsymbol{x}_a \\cdot \\hat{\\boldsymbol{n}})^2$ 是沿视线方向 $\\hat{\\boldsymbol{n}}$ 的粒子位置的质量加权方差。该准则通过使用方向性尺寸度量 $\\sqrt{\\sigma_n^2}$ 代替整体各向同性尺寸 $s$ 来改进 BH MAC。它能正确识别出从“正面”观察时，一个扁平系统看起来更小。\n\n### 4. 对抗性质点构型\n\n为了在固定质量 $M$ 和包围半径 $s$ 的情况下最大化四极矩振幅 $Q_2 = \\sqrt{\\mathrm{tr}(Q^T Q)}$，同时保持偶极矩为零，我们必须将质量排列得尽可能非球形。\n$Q_2^2 = \\mathrm{tr}((3S-tI)^T(3S-tI)) = \\mathrm{tr}(9S^2 - 6tS + t^2 I) = 9\\,\\mathrm{tr}(S^2) - 6t^2 + 3t^2 = 9\\,\\mathrm{tr}(S^2) - 3t^2$。对于所有放置在边界球面上的质量，$t = \\sum m_a \\lVert \\boldsymbol{x}_a \\rVert^2 = \\sum m_a s^2 = Ms^2$，这是一个常数且是最大值。任务简化为最大化 $\\mathrm{tr}(S^2) = \\sum_{ij} S_{ij}^2$。这可以通过将质量集中在单根轴上实现。\n具有两个质量 $m=M/2$ 位于 $\\boldsymbol{x} = \\pm s\\hat{\\boldsymbol{e}}_1$ 的**杆状排列**可以实现这一点。此时，$S_{11} = M s^2$ 且所有其他 $S_{ij}=0$。这使得 $S$ 成为对角矩阵，特征值为 $(Ms^2, 0, 0)$，并给出 $Q_2 = \\sqrt{6}Ms^2$。任何其他分布，如平面或准各向同性分布，都会将二阶矩更均匀地分布在 $S$ 的对角元素中，从而减少 $\\sum S_{ij}^2$ 并因此减少 $Q_2$。例如，指定的“各向同性”排列导致 $S_{ij} = (Ms^2/3)\\delta_{ij}$，结果是 $Q=\\boldsymbol{0}$ 和 $Q_2 = 0$。", "answer": "[[true,false,false,true],[true,true,true,true],[true,false,false,true],[true,true,true,true],[false,false,false,false],[true,true,true,true]]", "id": "3480537"}]}