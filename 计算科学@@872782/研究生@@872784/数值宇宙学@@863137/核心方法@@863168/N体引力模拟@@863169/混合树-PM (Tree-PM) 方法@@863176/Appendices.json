{"hands_on_practices": [{"introduction": "混合树-PM（Tree-PM）方法的核心在于将引力分解为短程和长程两个部分，分别由树形算法和粒子-网格（PM）方法处理。这个练习将带你完成一个基础但至关重要的推导：从傅里叶空间中的高斯分裂出发，推导出真实空间中短程力的解析形式。通过这个实践[@problem_id:3475892]，你将深刻理解树形算法在混合方法中需要精确计算的力的具体形态，为构建模拟代码打下坚实的数学基础。", "problem": "考虑数值宇宙学中的一种混合树-粒子网格（Tree-PM）方法，其中点质量的牛顿势通过一个共动平滑尺度为 $r_{s}$ 的高斯滤波器被分解为一个短程（树）部分和一个长程（粒子网格）部分。位于原点的点质量 $m$ 的牛顿势由 $\\phi_{\\mathrm{N}}(r)=-G m/r$ 给出，其中 $G$ 是引力常数，$r$ 是共动距离。在傅里叶空间中，使用约定 $\\phi(\\boldsymbol{k})=\\int \\mathrm{d}^{3}\\boldsymbol{r}\\,\\phi(\\boldsymbol{r})\\exp(-\\mathrm{i}\\,\\boldsymbol{k}\\cdot\\boldsymbol{r})$ 和 $\\phi(\\boldsymbol{r})=\\int \\mathrm{d}^{3}\\boldsymbol{k}\\,\\phi(\\boldsymbol{k})\\exp(\\mathrm{i}\\,\\boldsymbol{k}\\cdot\\boldsymbol{r})/(2\\pi)^{3}$，点质量的牛顿势的格林函数为 $\\Phi(\\boldsymbol{k})=-4\\pi G m/k^{2}$。通过将 $\\Phi(\\boldsymbol{k})$ 乘以一个高斯函数 $W(k)=\\exp(-k^{2} r_{s}^{2}/2)$ 来实现高斯分解，从而将长程部分定义为 $\\Phi_{\\mathrm{LR}}(\\boldsymbol{k})=\\Phi(\\boldsymbol{k})W(k)$，短程部分定义为 $\\Phi_{\\mathrm{SR}}(\\boldsymbol{k})=\\Phi(\\boldsymbol{k})\\left[1-W(k)\\right]$。互补误差函数定义为 $\\mathrm{erfc}(x)=1-\\mathrm{erf}(x)$，其中 $\\mathrm{erf}(x)=\\frac{2}{\\sqrt{\\pi}}\\int_{0}^{x}\\exp(-t^{2})\\,\\mathrm{d}t$。\n\n从这些定义和约定出发，在不引入所述基本基础之外的任何快捷公式的情况下，通过傅里叶逆变换推导点质量的实空间短程势 $\\phi_{\\mathrm{SR}}(r)$，然后根据 $F_{\\mathrm{SR}}(r)=\\mathrm{d}\\phi_{\\mathrm{SR}}/\\mathrm{d}r$ 计算球对称的径向短程力的大小 $F_{\\mathrm{SR}}(r)$。将最终的 $F_{\\mathrm{SR}}(r)$ 表示为包含 $G$, $m$, $r$, $r_{s}$, $\\mathrm{erfc}$ 和 $\\exp$ 的单一闭式解析表达式。对任何物理量使用国际单位制（SI）；如果进行数值计算，力的单位将是牛顿。不需要进行数值计算；请提供一个精确表达式。不要四舍五入。最终答案必须仅为 $F_{\\mathrm{SR}}(r)$ 的显式解析表达式。", "solution": "该问题被验证为具有科学依据、良定且客观。它代表了数值宇宙学模拟背景下的一个标准计算。所有定义、约定和物理前提都与既定原则一致。因此，该问题被认为是有效的，并将推导出完整的解。\n\n目标是计算短程力的大小 $F_{\\mathrm{SR}}(r)$，问题将其定义为短程势的径向导数，$F_{\\mathrm{SR}}(r) = \\mathrm{d}\\phi_{\\mathrm{SR}}/\\mathrm{d}r$。为此，我们必须首先推导出实空间短程势 $\\phi_{\\mathrm{SR}}(r)$ 的表达式。\n\n问题陈述，傅里叶空间中的短程势 $\\Phi_{\\mathrm{SR}}(\\boldsymbol{k})$ 由全牛顿势与长程势之差给出：\n$$\n\\Phi_{\\mathrm{SR}}(\\boldsymbol{k}) = \\Phi(\\boldsymbol{k}) \\left[1-W(k)\\right] = \\Phi(\\boldsymbol{k}) - \\Phi_{\\mathrm{LR}}(\\boldsymbol{k})\n$$\n其中 $\\Phi(\\boldsymbol{k})$ 是全牛顿势 $\\phi_{\\mathrm{N}}(r)$ 的傅里叶变换，$\\Phi_{\\mathrm{LR}}(\\boldsymbol{k})$ 是长程势 $\\phi_{\\mathrm{LR}}(r)$ 的傅里叶变换。\n\n傅里叶逆变换是线性操作。将其应用于上述方程，得到实空间中的关系：\n$$\n\\phi_{\\mathrm{SR}}(\\boldsymbol{r}) = \\mathcal{F}^{-1}[\\Phi_{\\mathrm{SR}}(\\boldsymbol{k})] = \\mathcal{F}^{-1}[\\Phi(\\boldsymbol{k})] - \\mathcal{F}^{-1}[\\Phi_{\\mathrm{LR}}(\\boldsymbol{k})]\n$$\n鉴于 $\\phi_{\\mathrm{N}}(r)=-G m/r$ 是 $\\Phi(\\boldsymbol{k})$ 的傅里叶逆变换，并且由于势是球对称的，我们可以将 $\\phi_{\\mathrm{SR}}(r)$ 写为：\n$$\n\\phi_{\\mathrm{SR}}(r) = \\phi_{\\mathrm{N}}(r) - \\phi_{\\mathrm{LR}}(r) = -\\frac{G m}{r} - \\phi_{\\mathrm{LR}}(r)\n$$\n我们的首要任务是通过对 $\\Phi_{\\mathrm{LR}}(\\boldsymbol{k})$ 进行傅里叶逆变换来计算 $\\phi_{\\mathrm{LR}}(r)$。问题提供了傅里叶约定：\n$$\n\\phi_{\\mathrm{LR}}(\\boldsymbol{r}) = \\int \\frac{\\mathrm{d}^3\\boldsymbol{k}}{(2\\pi)^3} \\Phi_{\\mathrm{LR}}(\\boldsymbol{k}) \\exp(\\mathrm{i}\\,\\boldsymbol{k}\\cdot\\boldsymbol{r})\n$$\n给定 $\\Phi_{\\mathrm{LR}}(\\boldsymbol{k}) = \\Phi(\\boldsymbol{k})W(k) = \\left(-\\frac{4\\pi G m}{k^2}\\right) \\exp(-k^2 r_s^2 / 2)$。将此代入积分：\n$$\n\\phi_{\\mathrm{LR}}(r) = \\int \\frac{\\mathrm{d}^3\\boldsymbol{k}}{(2\\pi)^3} \\left(-\\frac{4\\pi G m}{k^2}\\right) \\exp(-k^2 r_s^2/2) \\exp(\\mathrm{i}\\,\\boldsymbol{k}\\cdot\\boldsymbol{r})\n$$\n为计算此三维积分，我们转换到 $\\boldsymbol{k}$ 空间中的球坐标。设 z 轴与向量 $\\boldsymbol{r}$ 对齐，使得 $\\boldsymbol{r}$ 的大小为 $r=|\\boldsymbol{r}|$ 且 $\\boldsymbol{k}\\cdot\\boldsymbol{r} = kr\\cos\\theta_k$，其中 $\\theta_k$ 是 $\\boldsymbol{k}$ 的极角。体积元为 $\\mathrm{d}^3\\boldsymbol{k} = k^2 \\sin\\theta_k \\, \\mathrm{d}k \\, \\mathrm{d}\\theta_k \\, \\mathrm{d}\\phi_k$。\n$$\n\\phi_{\\mathrm{LR}}(r) = -\\frac{4\\pi G m}{(2\\pi)^3} \\int_0^\\infty \\mathrm{d}k \\int_0^\\pi \\mathrm{d}\\theta_k \\int_0^{2\\pi} \\mathrm{d}\\phi_k \\, k^2 \\sin\\theta_k \\left(\\frac{1}{k^2}\\right) \\exp(-k^2 r_s^2 / 2) \\exp(\\mathrm{i}kr\\cos\\theta_k)\n$$\n关于方位角 $\\phi_k$ 的积分得出 $2\\pi$。$k^2$ 项相互消去。\n$$\n\\phi_{\\mathrm{LR}}(r) = -\\frac{8\\pi^2 G m}{8\\pi^3} \\int_0^\\infty \\mathrm{d}k \\, \\exp(-k^2 r_s^2/2) \\int_0^\\pi \\mathrm{d}\\theta_k \\, \\sin\\theta_k \\exp(\\mathrm{i}kr\\cos\\theta_k)\n$$\n$$\n\\phi_{\\mathrm{LR}}(r) = -\\frac{G m}{\\pi} \\int_0^\\infty \\mathrm{d}k \\, \\exp(-k^2 r_s^2/2) \\left[ \\int_0^\\pi \\sin\\theta_k \\exp(\\mathrm{i}kr\\cos\\theta_k) \\, \\mathrm{d}\\theta_k \\right]\n$$\n方括号中的积分可以通过代换 $u=\\cos\\theta_k$，$\\mathrm{d}u=-\\sin\\theta_k \\mathrm{d}\\theta_k$ 来求解：\n$$\n\\int_1^{-1} e^{\\mathrm{i}kru} (-\\mathrm{d}u) = \\int_{-1}^1 e^{\\mathrm{i}kru} \\mathrm{d}u = \\left[\\frac{e^{\\mathrm{i}kru}}{\\mathrm{i}kr}\\right]_{-1}^1 = \\frac{e^{\\mathrm{i}kr} - e^{-\\mathrm{i}kr}}{\\mathrm{i}kr} = \\frac{2\\sin(kr)}{kr}\n$$\n将此结果代回 $\\phi_{\\mathrm{LR}}(r)$ 的表达式中：\n$$\n\\phi_{\\mathrm{LR}}(r) = -\\frac{G m}{\\pi} \\int_0^\\infty \\exp(-k^2 r_s^2/2) \\frac{2\\sin(kr)}{kr} \\, \\mathrm{d}k = -\\frac{2 G m}{\\pi r} \\int_0^\\infty \\frac{\\sin(kr)}{k} \\exp(-k^2 r_s^2/2) \\, \\mathrm{d}k\n$$\n这个积分是与误差函数 $\\mathrm{erf}(x)$ 相关的一个标准形式。其恒等式为 $\\int_0^\\infty \\frac{\\sin(ax)}{x} \\exp(-b^2 x^2) \\mathrm{d}x = \\frac{\\pi}{2} \\mathrm{erf}\\left(\\frac{a}{2b}\\right)$。此处，我们有 $x=k$，$a=r$，$b=r_s/\\sqrt{2}$。\n$$\n\\int_0^\\infty \\frac{\\sin(kr)}{k} \\exp(-k^2 r_s^2/2) \\, \\mathrm{d}k = \\frac{\\pi}{2} \\mathrm{erf}\\left(\\frac{r}{2(r_s/\\sqrt{2})}\\right) = \\frac{\\pi}{2} \\mathrm{erf}\\left(\\frac{r}{\\sqrt{2}r_s}\\right)\n$$\n将此代入 $\\phi_{\\mathrm{LR}}(r)$ 的表达式中：\n$$\n\\phi_{\\mathrm{LR}}(r) = -\\frac{2 G m}{\\pi r} \\left(\\frac{\\pi}{2} \\mathrm{erf}\\left(\\frac{r}{\\sqrt{2}r_s}\\right)\\right) = -\\frac{G m}{r} \\mathrm{erf}\\left(\\frac{r}{\\sqrt{2}r_s}\\right)\n$$\n现在我们可以写出短程势 $\\phi_{\\mathrm{SR}}(r)$：\n$$\n\\phi_{\\mathrm{SR}}(r) = -\\frac{G m}{r} - \\left(-\\frac{G m}{r} \\mathrm{erf}\\left(\\frac{r}{\\sqrt{2}r_s}\\right)\\right) = -\\frac{G m}{r} \\left(1 - \\mathrm{erf}\\left(\\frac{r}{\\sqrt{2}r_s}\\right)\\right)\n$$\n使用给定的互补误差函数定义 $\\mathrm{erfc}(x) = 1 - \\mathrm{erf}(x)$，我们得到短程势的最终表达式：\n$$\n\\phi_{\\mathrm{SR}}(r) = -\\frac{G m}{r} \\mathrm{erfc}\\left(\\frac{r}{\\sqrt{2}r_s}\\right)\n$$\n最后一步是通过对 $\\phi_{\\mathrm{SR}}(r)$ 关于 $r$ 求导来计算力的大小 $F_{\\mathrm{SR}}(r)$。\n$$\nF_{\\mathrm{SR}}(r) = \\frac{\\mathrm{d}}{\\mathrm{d}r}\\phi_{\\mathrm{SR}}(r) = \\frac{\\mathrm{d}}{\\mathrm{d}r}\\left[ -\\frac{G m}{r} \\mathrm{erfc}\\left(\\frac{r}{\\sqrt{2}r_s}\\right) \\right]\n$$\n使用乘法求导法则 $(uv)' = u'v + uv'$：\n$$\nF_{\\mathrm{SR}}(r) = -G m \\left[ \\left(\\frac{\\mathrm{d}}{\\mathrm{d}r}\\frac{1}{r}\\right) \\mathrm{erfc}\\left(\\frac{r}{\\sqrt{2}r_s}\\right) + \\frac{1}{r} \\left(\\frac{\\mathrm{d}}{\\mathrm{d}r}\\mathrm{erfc}\\left(\\frac{r}{\\sqrt{2}r_s}\\right)\\right) \\right]\n$$\n$$\nF_{\\mathrm{SR}}(r) = -G m \\left[ -\\frac{1}{r^2} \\mathrm{erfc}\\left(\\frac{r}{\\sqrt{2}r_s}\\right) + \\frac{1}{r} \\left(\\frac{\\mathrm{d}}{\\mathrm{d}r}\\mathrm{erfc}\\left(\\frac{r}{\\sqrt{2}r_s}\\right)\\right) \\right]\n$$\n为求 $\\mathrm{erfc}$ 的导数，我们使用其以误差函数积分表示的定义：$\\frac{\\mathrm{d}}{\\mathrm{d}x}\\mathrm{erf}(x) = \\frac{2}{\\sqrt{\\pi}}\\exp(-x^2)$。因此，$\\frac{\\mathrm{d}}{\\mathrm{d}x}\\mathrm{erfc}(x) = -\\frac{2}{\\sqrt{\\pi}}\\exp(-x^2)$。使用链式法则，设参数 $u = r/(\\sqrt{2}r_s)$，则有 $\\mathrm{d}u/\\mathrm{d}r = 1/(\\sqrt{2}r_s)$：\n$$\n\\frac{\\mathrm{d}}{\\mathrm{d}r}\\mathrm{erfc}\\left(\\frac{r}{\\sqrt{2}r_s}\\right) = \\left( -\\frac{2}{\\sqrt{\\pi}}\\exp\\left(-\\left(\\frac{r}{\\sqrt{2}r_s}\\right)^2\\right) \\right) \\cdot \\frac{1}{\\sqrt{2}r_s} = -\\frac{\\sqrt{2}}{r_s\\sqrt{\\pi}}\\exp\\left(-\\frac{r^2}{2r_s^2}\\right)\n$$\n将此导数代回 $F_{\\mathrm{SR}}(r)$ 的表达式中：\n$$\nF_{\\mathrm{SR}}(r) = -G m \\left[ -\\frac{1}{r^2} \\mathrm{erfc}\\left(\\frac{r}{\\sqrt{2}r_s}\\right) + \\frac{1}{r} \\left(-\\frac{\\sqrt{2}}{r_s\\sqrt{\\pi}}\\exp\\left(-\\frac{r^2}{2r_s^2}\\right)\\right) \\right]\n$$\n$$\nF_{\\mathrm{SR}}(r) = -G m \\left[ -\\frac{1}{r^2} \\mathrm{erfc}\\left(\\frac{r}{\\sqrt{2}r_s}\\right) - \\frac{\\sqrt{2}}{r r_s\\sqrt{\\pi}}\\exp\\left(-\\frac{r^2}{2r_s^2}\\right) \\right]\n$$\n将前导因子 $-G m$ 分配进去，得到问题所定义的短程力大小的最终表达式：\n$$\nF_{\\mathrm{SR}}(r) = \\frac{G m}{r^2} \\mathrm{erfc}\\left(\\frac{r}{\\sqrt{2}r_s}\\right) + \\frac{G m\\sqrt{2}}{r r_s\\sqrt{\\pi}} \\exp\\left(-\\frac{r^2}{2r_s^2}\\right)\n$$\n这是一个用指定量表示的单一闭式解析表达式。", "answer": "$$\\boxed{\\frac{G m}{r^2} \\mathrm{erfc}\\left(\\frac{r}{\\sqrt{2}r_s}\\right) + \\frac{G m}{r r_s} \\sqrt{\\frac{2}{\\pi}} \\exp\\left(-\\frac{r^2}{2r_s^2}\\right)}$$", "id": "3475892"}, {"introduction": "在精确计算了短程力之后，我们必须确保长程力在网格上的计算同样准确。然而，将粒子质量分配到网格（离散化）以及使用有限差分求解泊松方程会引入系统偏差。这个练习[@problem_id:3475913]旨在揭示这些偏差的来源，并指导你推导出校正这些效应所需的“反卷积”因子，这是实现高精度PM计算的关键步骤。理解这些修正是从一个朴素的PM实现走向一个研究级代码的必经之路。", "problem": "考虑一种用于宇宙学 $N$ 体模拟的混合树-粒子网格（PM）方法，其中长程引力使用傅里叶空间泊松求解器在间距为 $\\Delta x$ 的均匀笛卡尔网格上计算，而短程力则用树形算法计算。在 PM 部分，粒子使用云中网格（CIC）方案分配到网格上，力也使用相同的 CIC 核函数插值回粒子。令奈奎斯特波数为 $k_{\\mathrm{Ny}} = \\pi / \\Delta x$，并用 $\\boldsymbol{k} = (k_{x}, k_{y}, k_{z})$ 表示一个傅里叶模式。二阶有限差分拉普拉斯算子的离散格点格林函数定义为\n$$\n\\hat{\\Delta}(\\boldsymbol{k}) = \\frac{2}{\\Delta x^{2}} \\sum_{i \\in \\{x,y,z\\}} \\left(1 - \\cos(k_{i} \\Delta x)\\right),\n$$\n因此基于网格的势满足 $-\\hat{\\Delta}(\\boldsymbol{k}) \\,\\phi(\\boldsymbol{k}) = 4 \\pi G \\bar{\\rho} \\,\\delta(\\boldsymbol{k})$，其中 $G$ 是引力常数，$\\bar{\\rho}$ 是平均物质密度，$\\delta(\\boldsymbol{k})$ 是密度衬度的傅里叶变换。\n\n仅从以下基本依据出发：\n- 共动坐标系中牛顿引力的傅里叶空间泊松方程，对于连续介质为 $-k^{2} \\phi(\\boldsymbol{k}) = 4 \\pi G \\bar{\\rho} \\,\\delta(\\boldsymbol{k})$，及其针对网格的上文给出的离散对应形式。\n- 一维 CIC 分配核函数在实空间中的定义为三角（帐篷）函数 $w_{\\mathrm{CIC}}(x) = 1 - |x|/\\Delta x$（当 $|x| \\le \\Delta x$ 时）且在其他情况下 $w_{\\mathrm{CIC}}(x) = 0$，并且三维分配是可分的，可表示为每个笛卡尔方向上一维核函数的乘积。\n- 实空间中的卷积对应于傅里叶空间中的乘法，以及在 PM 方案中用于分配的核函数同样也用于插值回粒子位置。\n\n推导：\n1. 傅里叶空间的反卷积因子 $D(\\boldsymbol{k})$。该因子必须与傅里叶空间中网格上计算出的力相乘，以消除由 CIC 分配和 CIC 插值引入的偏差，从而在没有离散化效应的情况下恢复相对于连续介质的无偏 PM 力。\n2. 在谱微分（即，力通过在傅里叶空间中乘以 $i \\boldsymbol{k}$ 来计算）和使用上文定义的离散格点格林函数 $\\hat{\\Delta}(\\boldsymbol{k})$ 的情况下，量化对于模式 $\\boldsymbol{k} = (k_{\\mathrm{Ny}}(1 - \\epsilon), 0, 0)$（其中 $0   \\epsilon \\ll 1$），PM 力相对于精确连续介质力的残余分数振幅偏差 $b(\\epsilon)$。\n\n将最终答案表示为一个包含两个条目的行矩阵：反卷积因子 $D(\\boldsymbol{k})$ 的闭式解析表达式，以及残余分数振幅偏差 $b(\\epsilon)$ 的闭式解析表达式。无需进行数值计算，也无需进行四舍五入。最终答案中不要包含任何物理单位。", "solution": "用户要求推导与宇宙学模拟中的粒子网格（PM）方法相关的两个量：一个反卷积因子和一个残余力偏差。该问题定义明确，在数值宇宙学领域有坚实的科学基础，并包含足够的信息以得到唯一解。\n\n### 第 1 部分：反卷积因子 $D(\\boldsymbol{k})$ 的推导\n\n目标是找到反卷积因子 $D(\\boldsymbol{k})$，以消除由云中网格（CIC）分配和插值步骤引入的偏差。这种偏差源于 CIC 核函数的平滑效应。设 CIC 核函数为 $W(\\boldsymbol{x})$。问题陈述该三维核函数是可分的，$W(\\boldsymbol{x}) = w_{\\mathrm{CIC}}(x_1)w_{\\mathrm{CIC}}(x_2)w_{\\mathrm{CIC}}(x_3)$，其中一维核函数是三角函数 $w_{\\mathrm{CIC}}(x) = 1 - |x|/\\Delta x$（当 $|x| \\le \\Delta x$ 时），其他情况为零。\n\n整体 PM 力计算在傅里叶空间中涉及三个主要步骤：质量分配、求解泊松方程和力插值。\n1.  **质量分配**：将粒子质量分配到网格的过程，实际上是将真实密度场与分配核函数 $W(\\boldsymbol{x})$进行卷积。在傅里叶空间中，这对应于将密度衬度的傅里叶变换 $\\delta(\\boldsymbol{k})$ 乘以分配核函数的傅里叶变换 $\\hat{W}(\\boldsymbol{k})$。因此，网格上的密度为 $\\delta_{\\text{grid}}(\\boldsymbol{k}) = \\hat{W}(\\boldsymbol{k}) \\delta(\\boldsymbol{k})$。\n\n2.  **泊松求解器**：引力势 $\\phi_{\\text{mesh}}(\\boldsymbol{k})$ 是使用所提供的离散泊松方程从网格化密度计算得出的。\n\n3.  **力插值**：使用相同的核函数 $W(\\boldsymbol{x})$ 将力从网格插值回粒子位置。这等效于将网格力场与 $W(\\boldsymbol{x})$ 进行卷积。在傅里叶空间中，粒子所感受到的插值力 $\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k})$ 与基于网格的力 $\\boldsymbol{F}_{\\text{mesh}}(\\boldsymbol{k})$ 的关系为 $\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}) = \\hat{W}(\\boldsymbol{k})\\boldsymbol{F}_{\\text{mesh}}(\\boldsymbol{k})$。（对于一个实对称核函数 $W(\\boldsymbol{x})$，其傅里叶变换 $\\hat{W}(\\boldsymbol{k})$ 是实的，且 $\\hat{W}(-\\boldsymbol{k}) = \\hat{W}(\\boldsymbol{k})$）。\n\n结合这些步骤，PM 计算出的力与真实密度衬度 $\\delta(\\boldsymbol{k})$ 的关系如下：\n$$\n\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}) = \\hat{W}(\\boldsymbol{k}) \\boldsymbol{F}_{\\text{mesh}}(\\boldsymbol{k}) = \\hat{W}(\\boldsymbol{k}) \\left( \\boldsymbol{D}_{\\text{mesh}} \\phi_{\\text{mesh}}(\\boldsymbol{k}) \\right)\n$$\n其中 $\\boldsymbol{D}_{\\text{mesh}}$ 是对势进行微分以获得力的算子。势为\n$$\n\\phi_{\\text{mesh}}(\\boldsymbol{k}) = G_{\\text{mesh}}(\\boldsymbol{k}) \\delta_{\\text{grid}}(\\boldsymbol{k}) = G_{\\text{mesh}}(\\boldsymbol{k}) \\hat{W}(\\boldsymbol{k}) \\delta(\\boldsymbol{k})\n$$\n其中 $G_{\\text{mesh}}(\\boldsymbol{k})$ 是离散泊松求解器的格林函数。因此，\n$$\n\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}) = \\hat{W}(\\boldsymbol{k}) \\boldsymbol{D}_{\\text{mesh}} G_{\\text{mesh}}(\\boldsymbol{k}) \\hat{W}(\\boldsymbol{k}) \\delta(\\boldsymbol{k}) = [\\hat{W}(\\boldsymbol{k})]^2 (\\boldsymbol{D}_{\\text{mesh}} G_{\\text{mesh}}(\\boldsymbol{k})) \\delta(\\boldsymbol{k})\n$$\n对应的连续介质力为 $\\boldsymbol{F}_{\\text{cont}}(\\boldsymbol{k}) = (\\boldsymbol{D}_{\\text{cont}} G_{\\text{cont}}(\\boldsymbol{k})) \\delta(\\boldsymbol{k})$。由 CIC 分配和插值专门引入的偏差是因子 $[\\hat{W}(\\boldsymbol{k})]^2$。要消除此偏差，我们必须将计算出的力乘以一个反卷积因子 $D(\\boldsymbol{k}) = [\\hat{W}(\\boldsymbol{k})]^{-2}$。\n\n接下来，我们必须找到 CIC 核函数的傅里叶变换。一维核函数为 $w_{\\mathrm{CIC}}(x) = 1 - |x|/\\Delta x$，适用于 $x \\in [-\\Delta x, \\Delta x]$。这是一个三角或“帐篷”函数。核函数的形状与其归一化无关。我们使用傅里叶变换核函数的无量纲形式，这是标准做法。三角函数形状 $\\Lambda(u) = 1-|u|$（当 $|u| \\le 1$ 时）的傅里叶变换为 $\\operatorname{sinc}^2(k/2)$，其中 $\\operatorname{sinc}(z) = \\sin(z)/z$。我们的核函数是 $w_{\\mathrm{CIC}}(x) = \\Lambda(x/\\Delta x)$。其傅里叶变换为：\n$$\n\\hat{w}_{\\text{shape}}(k_x) = \\mathcal{F}[\\Lambda(x/\\Delta x)] \\propto \\operatorname{sinc}^2\\left(\\frac{k_x \\Delta x}{2}\\right)\n$$\n三维核函数是可分的，所以其傅里叶变换是一维变换的乘积：\n$$\n\\hat{W}(\\boldsymbol{k}) \\propto \\prod_{i \\in \\{x,y,z\\}} \\operatorname{sinc}^2\\left(\\frac{k_i \\Delta x}{2}\\right)\n$$\n反卷积因子是该形状因子平方的倒数：\n$$\nD(\\boldsymbol{k}) = \\left[ \\prod_{i \\in \\{x,y,z\\}} \\operatorname{sinc}^2\\left(\\frac{k_i \\Delta x}{2}\\right) \\right]^{-2} = \\prod_{i \\in \\{x,y,z\\}} \\operatorname{sinc}^{-4}\\left(\\frac{k_i \\Delta x}{2}\\right)\n$$\n这可以写成：\n$$\nD(\\boldsymbol{k}) = \\prod_{i \\in \\{x,y,z\\}} \\left(\\frac{k_i\\Delta x / 2}{\\sin(k_i\\Delta x / 2)}\\right)^4\n$$\n\n### 第 2 部分：残余分数振幅偏差 $b(\\epsilon)$ 的推导\n\n分数振幅偏差 $b(\\boldsymbol{k})$ 定义为 PM 力振幅与精确连续介质力振幅的比值减一：\n$$\nb(\\boldsymbol{k}) = \\frac{|\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k})|}{|\\boldsymbol{F}_{\\text{cont}}(\\boldsymbol{k})|} - 1\n$$\n根据问题陈述，连续介质力由 $-k^2\\phi = 4\\pi G \\bar{\\rho} \\delta$ 推导，并使用谱微分（$\\boldsymbol{F} = -i\\boldsymbol{k}\\phi$），我们得到：\n$$\n\\boldsymbol{F}_{\\text{cont}}(\\boldsymbol{k}) = -i\\boldsymbol{k} \\left(\\frac{4\\pi G \\bar{\\rho}}{k^2}\\delta(\\boldsymbol{k})\\right) \\implies |\\boldsymbol{F}_{\\text{cont}}(\\boldsymbol{k})| \\propto \\frac{k}{k^2} = \\frac{1}{k}\n$$\nPM 力（未校正的）是根据第 1 部分中概述的步骤，由 $-\\hat{\\Delta}\\phi=4\\pi G\\bar{\\rho}\\delta_{\\text{grid}}$ 推导得出。使用谱微分，PM 力为：\n$$\n\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}) = -i\\boldsymbol{k} \\left( [\\hat{W}(\\boldsymbol{k})]^2 \\frac{4\\pi G \\bar{\\rho}}{\\hat{\\Delta}(\\boldsymbol{k})}\\delta(\\boldsymbol{k}) \\right) \\implies |\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k})| \\propto k \\frac{[\\hat{W}(\\boldsymbol{k})]^2}{\\hat{\\Delta}(\\boldsymbol{k})}\n$$\n大小的比值为：\n$$\n\\frac{|\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k})|}{|\\boldsymbol{F}_{\\text{cont}}(\\boldsymbol{k})|} = \\frac{k [\\hat{W}(\\boldsymbol{k})]^2 / \\hat{\\Delta}(\\boldsymbol{k})}{1/k} = \\frac{k^2 [\\hat{W}(\\boldsymbol{k})]^2}{\\hat{\\Delta}(\\boldsymbol{k})}\n$$\n我们对模式 $\\boldsymbol{k} = (k_x, 0, 0)$（其中 $k_x = k_{\\mathrm{Ny}}(1-\\epsilon) = \\frac{\\pi}{\\Delta x}(1-\\epsilon)$，对于 $0   \\epsilon \\ll 1$）计算此值。\n对于此模式，$k_y=k_z=0$ 且 $k=|\\boldsymbol{k}|=k_x$。\n比值中的各项为：\n1.  $k^2 = k_x^2 = \\left(\\frac{\\pi}{\\Delta x}(1-\\epsilon)\\right)^2 = \\frac{\\pi^2}{\\Delta x^2}(1-\\epsilon)^2$。\n2.  $\\hat{W}(\\boldsymbol{k})$：由于 $k_y=k_z=0$，$\\operatorname{sinc}(0)=1$。所以 $\\hat{W}(\\boldsymbol{k}) = \\operatorname{sinc}^2\\left(\\frac{k_x \\Delta x}{2}\\right)$。\n    其自变量为 $\\frac{k_x \\Delta x}{2} = \\frac{\\pi}{2}(1-\\epsilon)$。\n    $\\hat{W}(\\boldsymbol{k}) = \\left(\\frac{\\sin(\\frac{\\pi}{2}(1-\\epsilon))}{\\frac{\\pi}{2}(1-\\epsilon)}\\right)^2 = \\left(\\frac{\\cos(\\pi\\epsilon/2)}{\\pi(1-\\epsilon)/2}\\right)^2$。\n3.  $\\hat{\\Delta}(\\boldsymbol{k})$：当 $k_y=k_z=0$ 时，和式简化为 x 分量。\n    $\\hat{\\Delta}(\\boldsymbol{k}) = \\frac{2}{\\Delta x^2}(1-\\cos(k_x \\Delta x))$。\n    其自变量为 $k_x \\Delta x = \\pi(1-\\epsilon)$。所以 $\\cos(\\pi(1-\\epsilon)) = -\\cos(\\pi\\epsilon)$。\n    $\\hat{\\Delta}(\\boldsymbol{k}) = \\frac{2}{\\Delta x^2}(1+\\cos(\\pi\\epsilon))$。\n\n将这些代入偏差表达式 $b(\\epsilon) = \\frac{k^2 [\\hat{W}(\\boldsymbol{k})]^2}{\\hat{\\Delta}(\\boldsymbol{k})} - 1$：\n$$\nb(\\epsilon)+1 = \\frac{\\frac{\\pi^2}{\\Delta x^2}(1-\\epsilon)^2 \\left[\\left(\\frac{\\cos(\\pi\\epsilon/2)}{\\pi(1-\\epsilon)/2}\\right)^2\\right]^2}{\\frac{2}{\\Delta x^2}(1+\\cos(\\pi\\epsilon))} = \\frac{\\pi^2(1-\\epsilon)^2}{\\frac{2}{\\Delta x^2}(1+\\cos(\\pi\\epsilon))} \\frac{\\cos^4(\\pi\\epsilon/2)}{(\\pi/2)^4(1-\\epsilon)^4} \\Delta x^2\n$$\n$$\nb(\\epsilon)+1 = \\frac{\\pi^2 \\cos^4(\\pi\\epsilon/2)}{2(1+\\cos(\\pi\\epsilon))} \\frac{16}{\\pi^4(1-\\epsilon)^2} = \\frac{8}{\\pi^2} \\frac{\\cos^4(\\pi\\epsilon/2)}{(1-\\epsilon)^2(1+\\cos(\\pi\\epsilon))}\n$$\n这是精确表达式。问题要求量化 $\\epsilon \\ll 1$ 时的偏差，这表明需要进行泰勒展开。令 $F(\\epsilon) = b(\\epsilon)+1$。\n$F(\\epsilon) \\approx F(0) + F'(0)\\epsilon$。\n在 $\\epsilon=0$ 处：\n$F(0) = \\frac{8}{\\pi^2} \\frac{\\cos^4(0)}{(1-0)^2(1+\\cos(0))} = \\frac{8}{\\pi^2} \\frac{1}{1 \\cdot (1+1)} = \\frac{4}{\\pi^2}$。\n为求导数 $F'(0)$，我们使用商法则 $F' = (N'D-ND')/D^2$，其中 $N(\\epsilon)=\\frac{8}{\\pi^2}\\cos^4(\\pi\\epsilon/2)$ 且 $D(\\epsilon) = (1-\\epsilon)^2(1+\\cos(\\pi\\epsilon))$。\n$N'( \\epsilon) = \\frac{8}{\\pi^2} \\cdot 4\\cos^3(\\frac{\\pi\\epsilon}{2}) \\cdot (-\\sin(\\frac{\\pi\\epsilon}{2})) \\cdot \\frac{\\pi}{2}$。在 $\\epsilon=0$ 处，$N'(0)=0$。\n$D'(\\epsilon) = -2(1-\\epsilon)(1+\\cos(\\pi\\epsilon)) + (1-\\epsilon)^2(-\\pi\\sin(\\pi\\epsilon))$。在 $\\epsilon=0$ 处，$D'(0) = -2(1)(1+1)+0 = -4$。\n$F'(0) = \\frac{N'(0)D(0) - N(0)D'(0)}{[D(0)]^2} = \\frac{0 \\cdot 2 - (4/\\pi^2)(-4)}{2^2} = \\frac{16/\\pi^2}{4} = \\frac{4}{\\pi^2}$。\n等一下，在原始草稿中我计算出 $F'(0) = 8/\\pi^2$。让我们再检查一下。\n$F'(0) = \\frac{0 - N(0)D'(0)}{[D(0)]^2} = \\frac{ - (4/\\pi^2) (-4) }{2^2} = \\frac{16/\\pi^2}{4} = \\frac{4}{\\pi^2}$.\n啊，之前的计算有误。让我们重新检查原始推导。\n`$F'(0) = \\frac{N'(0)D(0) - N(0)D'(0)}{[D(0)]^2} = \\frac{0 \\cdot 2 - (4/\\pi^2 \\cdot 2)(-4)}{2^2} = \\frac{(8/\\pi^2)(4)}{4} = \\frac{8}{\\pi^2}$`\n哪里出错了？`N(0)` 是 `8/\\pi^2`，不是 `4/\\pi^2`。\n$N(0) = \\frac{8}{\\pi^2}\\cos^4(0) = \\frac{8}{\\pi^2}$。\n$F(0) = N(0)/D(0) = (8/\\pi^2)/2 = 4/\\pi^2$. 这是对的。\n那么 $F'(0) = \\frac{0 - (N(0)) D'(0)}{D(0)^2} = \\frac{ - (8/\\pi^2)(-4)}{2^2} = \\frac{32/\\pi^2}{4} = \\frac{8}{\\pi^2}$.\n是的，原始推导是正确的。\n因此，$F(\\epsilon)$ 的一阶泰勒展开为：\n$$\nb(\\epsilon)+1 \\approx \\frac{4}{\\pi^2} + \\frac{8}{\\pi^2}\\epsilon\n$$\n所以，残余分数振幅偏差为：\n$$\nb(\\epsilon) \\approx \\left(\\frac{4}{\\pi^2} - 1\\right) + \\frac{8}{\\pi^2}\\epsilon\n$$", "answer": "$$\n\\boxed{\\begin{pmatrix} \\prod_{i \\in \\{x,y,z\\}} \\left(\\frac{k_i \\Delta x}{2 \\sin(k_i \\Delta x / 2)}\\right)^{4},  \\left(\\frac{4}{\\pi^2} - 1\\right) + \\frac{8}{\\pi^2}\\epsilon \\end{pmatrix}}\n$$", "id": "3475913"}, {"introduction": "一个高效的混合算法不仅要求每个组件都准确，还要求它们之间的“切换”是无缝且一致的。这个练习将引导你优化树算法和PM计算之间的平衡，通过将树算法的截断误差与PM部分的残余误差在分裂尺度上相匹配，来确定最优的树张开角 $\\theta$。这个实践[@problem_id:3475856]完美地诠释了混合方法的精髓——确保整个模拟在所有空间尺度上都具有统一且可控的精度。", "problem": "在数值宇宙学中，考虑一种混合的树-粒子网格（Tree-PM）方法，该方法将牛顿引力势分解为一个在粒子网格（PM）上求解的长程分量和一个通过树算法计算的短程分量。长程/短程分解是通过傅里叶空间中的高斯滤波器实现的，其特征分裂尺度为 $r_{s}$。因此，对于一个点质量 $m$，其短程实空间势是牛顿势乘以互补误差函数 $\\operatorname{erfc}$，即在距离 $r$ 处的短程势分数为 $\\operatorname{erfc}\\!\\left(r/(\\sqrt{2} r_{s})\\right)$。树算法采用标准的打开判据 $s/d \\le \\theta$，其中 $s$ 是源单元的大小，$d$ 是从目标点到单元质心的距离，$\\theta$ 是一个无量纲的打开参数。\n\n假设树势是通过将多极展开截断到单极来构建的，因此首个被忽略的项是四极项。设四极项对势误差的贡献尺度为 $E_{M_{2}}(d) \\sim G |M_{2}|/d^{3}$，其中 $G$ 是引力常数，$M_{2}$ 是单元四极矩振幅的标量度量（例如，应用于无迹四极张量的谱范数）。为了得到一个保守的、与几何形状无关的界，采用 $|M_{2}| \\le M s^{2}$，其中 $M$ 是单元的总质量。使用牛顿单极势的大小 $|\\Phi_{M}(d)| \\sim G M/d$ 作为相对势误差的归一化因子。\n\n通过将树在分裂尺度上的四极截断误差与势在 $r=r_{s}$ 处的PM残差振幅相匹配来定义目标相对误差 $\\epsilon_{\\rm target}$，即设 $\\epsilon_{\\rm target} = \\operatorname{erfc}\\!\\left(1/\\sqrt{2}\\right)$。施加要求：在打开阈值处的相对树截断误差不大于 $\\epsilon_{\\rm target}$。\n\n在这些假设和定义下，推导最优打开参数 $\\theta_{\\rm opt}$ 关于 $\\epsilon_{\\rm target}$ 的解析表达式，并使用上述高斯分裂对其进行数值计算。将你的最终答案 $\\theta_{\\rm opt}$ 表示为一个无量纲数。将你的答案四舍五入到 $4$ 位有效数字。", "solution": "首先验证问题，以确保其科学上合理、良定且客观。\n\n**步骤1：提取已知条件**\n- **方法**：混合树-粒子网格（Tree-PM）。\n- **势分解**：长程（PM）和短程（树）。\n- **分裂尺度**：$r_{s}$。\n- **短程势分数**：在距离 $r$ 处为 $\\operatorname{erfc}(r/(\\sqrt{2} r_{s}))$。\n- **树打开判据**：$s/d \\le \\theta$，其中 $s$ 是单元大小，$d$ 是到单元的距离，$\\theta$ 是打开参数。\n- **树近似**：仅单极，主要误差来自四极。\n- **四极误差尺度**：$E_{M_{2}}(d) \\sim G |M_{2}|/d^{3}$，其中 $M_2$ 是四极矩的度量。\n- **四极矩界**：$|M_{2}| \\le M s^{2}$，其中 $M$ 是单元质量。\n- **误差归一化**：$|\\Phi_{M}(d)| \\sim G M/d$。\n- **目标相对误差**：$\\epsilon_{\\rm target} = \\operatorname{erfc}(1/\\sqrt{2})$。\n- **约束条件**：在打开阈值处的相对树截断误差必须不大于 $\\epsilon_{\\rm target}$。\n- **目标**：推导最优打开参数 $\\theta_{\\rm opt}$ 的表达式并进行数值计算，结果四舍五入到4位有效数字。\n\n**步骤2：使用提取的已知条件进行验证**\n该问题具有科学依据。混合树-PM方法、使用互补误差函数 $\\operatorname{erfc}$ 表征的高斯分裂、Barnes-Hut打开判据（$s/d \\le \\theta$）以及引力势的多极展开，都是计算宇宙学和天体物理学中标准且成熟的概念。所提供的误差尺度和界（$E_{M_2} \\propto d^{-3}$，$|M_2| \\le Ms^2$）是对此类算法进行性能和误差分析时使用的标准近似。\n\n该问题是良定的。它提供了推导打开参数 $\\theta_{\\rm opt}$ 的唯一表达式所需的所有必要定义、尺度关系和约束条件。语言客观、精确，没有歧义。\n\n**步骤3：结论与行动**\n该问题被判定为**有效**。将推导解答。\n\n推导过程如下。首先，我们构建相对树截断误差的公式。该误差主要由多极展开中首个被忽略的项（即四极项）决定。该势误差的大小尺度由下式给出：\n$$E_{M_{2}}(d) \\sim \\frac{G |M_{2}|}{d^{3}}$$\n其中 G 是引力常数，|M₂| 是源单元的四极矩大小，d 是到目标点的距离。\n\n该误差需要用单极势的大小进行归一化，单极势的大小由下式给出：\n$$|\\Phi_{M}(d)| \\sim \\frac{G M}{d}$$\n其中 M 是单元的总质量。\n\n相对树截断误差 $\\epsilon_{\\rm tree}$ 是这两个量的比值：\n$$\\epsilon_{\\rm tree}(d) = \\frac{E_{M_{2}}(d)}{|\\Phi_{M}(d)|} \\sim \\frac{G |M_{2}|/d^{3}}{G M/d} = \\frac{|M_{2}|}{M d^{2}}$$\n\n为了获得一个保守的界，我们使用所提供的与几何形状无关的四极矩上限：$|M_{2}| \\le M s^{2}$，其中 $s$ 是源单元的大小。将此代入相对误差的表达式，得到：\n$$\\epsilon_{\\rm tree}(d) \\le \\frac{M s^{2}}{M d^{2}} = \\left(\\frac{s}{d}\\right)^{2}$$\n该表达式以比值 $s/d$ 的形式给出了相对误差的界。\n\n树算法采用打开判据 $s/d \\le \\theta$。只要满足此条件，算法就将一个单元视为点质量（单极）。最宽松的情况，即代表打开单元的阈值条件，是当该比值达到其允许的最大值 $s/d = \\theta$ 时。在此打开阈值处，相对截断误差的上限为：\n$$\\epsilon_{\\rm tree, threshold} \\le \\theta^{2}$$\n\n问题要求将这个截断误差的先验估计与由长程/短程力分解引入的、依赖于尺度的误差相匹配。目标相对误差 $\\epsilon_{\\rm target}$ 是通过在特征分裂尺度 $r=r_s$ 处计算 PM 残差（即短程势分数）来定义的。短程势分数由 $\\operatorname{erfc}(r/(\\sqrt{2}r_s))$ 给出。因此，\n$$\\epsilon_{\\rm target} = \\operatorname{erfc}\\left(\\frac{r_s}{\\sqrt{2} r_s}\\right) = \\operatorname{erfc}\\left(\\frac{1}{\\sqrt{2}}\\right)$$\n\n最后的约束条件是，在打开阈值处的相对树截断误差不应大于此目标误差：$\\epsilon_{\\rm tree, threshold} \\le \\epsilon_{\\rm target}$。为了找到最优打开参数 $\\theta_{\\rm opt}$，我们通过将打开阈值处可能的最大树误差设定为等于目标误差来平衡误差。一个较小的 $\\theta$ 会导致计算成本更高（打开更多节点），但精度会超出需要；而一个较大的 $\\theta$ 则会违反误差平衡原则。因此，最优选择是设定：\n$$\\theta_{\\rm opt}^2 = \\epsilon_{\\rm target}$$\n\n求解 $\\theta_{\\rm opt}$，我们得到：\n$$\\theta_{\\rm opt} = \\sqrt{\\epsilon_{\\rm target}}$$\n\n代入 $\\epsilon_{\\rm target}$ 的表达式：\n$$\\theta_{\\rm opt} = \\sqrt{\\operatorname{erfc}\\left(\\frac{1}{\\sqrt{2}}\\right)}$$\n\n现在，我们对该表达式进行数值计算。互补误差函数定义为 $\\operatorname{erfc}(x) = 1 - \\operatorname{erf}(x)$，其中 $\\operatorname{erf}(x)$ 是误差函数。我们需要计算 $\\operatorname{erfc}(1/\\sqrt{2})$ 的值。\n$$1/\\sqrt{2} \\approx 0.70710678$$\n$$\\operatorname{erfc}(0.70710678) \\approx 0.31731050$$\n取平方根即可得到最优打开参数的值：\n$$\\theta_{\\rm opt} = \\sqrt{0.31731050} \\approx 0.5633032$$\n\n问题要求将答案四舍五入到 $4$ 位有效数字。\n前四位有效数字是 $5$, $6$, $3$, $3$。第五位数字是 $0$，所以我们无需取整。\n$$\\theta_{\\rm opt} \\approx 0.5633$$\n这就是在给定假设下的最优打开参数的最终数值。", "answer": "$$\\boxed{0.5633}$$", "id": "3475856"}]}