{"hands_on_practices": [{"introduction": "本练习旨在为自适应步长奠定坚实的理论基础。通过对一个简化的宇宙学模型进行解析推导，您将深入理解为何根据问题特性量身定制的自适应步长策略，其性能会优于固定步长。这项分析性实践将揭示误差的标度行为，这是评估和设计数值方法的关键一环，从而让您对自适应时间步长控制的“幕后”原理有更深刻的认识。[@problem_id:3464466]", "problem": "考虑一个空间平坦、物质主导的 Friedmann–Lemaître–Robertson–Walker 宇宙学模型，其标度因子 $a(t)$ 遵循 $a(t) \\propto t^{2/3}$，因此其演化满足非自治线性常微分方程 $a'(t) = \\frac{2}{3 t} a(t)$，其中 $t0$。给定 $a(t_0) = a_0$，并考虑区间 $[t_0, T]$，其中 $0  t_0  T$。您将使用二阶显式中点法对此方程进行积分，这是一种两步 Runge–Kutta 格式，定义为 $y_{n+1} = y_n + h f\\!\\left(t_n + \\frac{h}{2}, y_n + \\frac{h}{2} f(t_n, y_n)\\right)$，其中 $f(t,y) = \\frac{2}{3 t} y$，$h$ 表示步长。\n\n仅使用精确解在一个步长上的 Taylor 展开和线性化误差演化的基本解，推导在两种时间步进策略下 $t=T$ 时的主阶全局误差：\n- 一种自适应策略，其时间步长随时间变化，为 $\\Delta t(t) = \\varepsilon t$，其中 $\\varepsilon0$ 是一个小的无量纲参数。\n- 一种均匀策略，其时间步长为常数 $\\Delta t = h$，其中 $h$ 的选择使得对于某个整数 $N$，有 $N h \\approx T - t_0$。\n\n执行以下步骤：\n1. 计算将显式中点法应用于 $a'(t) = \\frac{2}{3 t} a(t)$ 时，在一般时间 $t$ 处的局部截断误差，精确到 $\\Delta t(t)$ 的主导非零阶。\n2. 使用从 $a'(t) = \\frac{2}{3 t} a(t)$ 推导出的齐次误差方程的基本解，确定在时间 $s$ 注入的局部误差如何传播到最终时间 $T$。\n3. 对于自适应和均匀两种策略，累积所有步长的贡献，以构建在 $t=T$ 时的主阶全局误差。将每种误差表示为在 $[t_0, T]$ 上的时间积分。\n4. 最后，提供比率\n$$R \\equiv \\frac{E_{\\mathrm{global}}^{\\mathrm{adaptive}}(T)}{E_{\\mathrm{global}}^{\\mathrm{uniform}}(T)}$$\n的闭合形式解析表达式，用 $t_0$、$T$、$\\varepsilon$ 和 $h$ 表示。\n\n您的最终答案必须是一个单一的闭合形式解析表达式。无需四舍五入。比率 $R$ 是无量纲的；不要附加单位。", "solution": "问题要求在使用显式中点法积分常微分方程 (ODE) $a'(t) = \\frac{2}{3t} a(t)$ 时，对于两种不同的时间步进策略（自适应和均匀），在最终时间 $T$ 的主阶全局误差的比率。解题过程将遵循指定的四个步骤进行。\n\n该常微分方程为 $a'(t) = f(t, a(t))$，其中 $f(t, a) = \\frac{2a}{3t}$。精确解的形式为 $a(t) = C t^{2/3}$，其中 $C$ 为某个常数。根据初始条件 $a(t_0)=a_0$，常数为 $C = a_0 t_0^{-2/3}$，因此精确解为 $a(t) = a_0 (t/t_0)^{2/3}$。\n\n### 步骤 1：局部截断误差 (LTE)\n\n对于一个 $p$ 阶方法，其局部截断误差 $\\tau(t)$ 是在大小为 $\\Delta t$ 的单步中产生的误差，其主导项的形式为 $\\tau(t) \\approx C(t) (\\Delta t)^{p+1}$。对于二阶（$p=2$）显式中点法，我们期望主导误差项为 $(\\Delta t)^3$ 阶。\n\n对于初值问题 $y' = f(t,y)$，显式中点法为：\n$$y_{n+1} = y_n + h f\\left(t_n + \\frac{h}{2}, y_n + \\frac{h}{2} f(t_n, y_n)\\right)$$\n为求得 LTE，我们从精确解 $a(t)$ 出发，将一步之后的数值解与精确解 $a(t+\\Delta t)$ 的 Taylor 展开进行比较。\n设从时间 $t$ 开始走一个大小为 $\\Delta t$ 的步长。数值解 $a_1$ 为：\n$$a_1 = a(t) + \\Delta t \\, f\\left( t + \\frac{\\Delta t}{2}, a(t) + \\frac{\\Delta t}{2} f(t, a(t)) \\right)$$\n代入 $f(t, a) = \\frac{2a}{3t}$：\n$$a_1 = a(t) + \\Delta t \\, \\frac{2}{3(t+\\frac{\\Delta t}{2})} \\left( a(t) + \\frac{\\Delta t}{2} \\frac{2a(t)}{3t} \\right)$$\n$$a_1 = a(t) + \\frac{2\\Delta t}{3t(1+\\frac{\\Delta t}{2t})} a(t) \\left( 1 + \\frac{\\Delta t}{3t} \\right)$$\n我们将各项按 $\\Delta t$ 的幂次展开：\n$$\\frac{1}{1+\\frac{\\Delta t}{2t}} = 1 - \\frac{\\Delta t}{2t} + \\frac{(\\Delta t)^2}{4t^2} - O((\\Delta t)^3)$$\n$$a_1 = a(t) + \\frac{2\\Delta t a(t)}{3t} \\left(1 - \\frac{\\Delta t}{2t} + \\frac{(\\Delta t)^2}{4t^2} - \\dots \\right) \\left( 1 + \\frac{\\Delta t}{3t} \\right)$$\n$$a_1 = a(t) + a'(t) \\Delta t \\left(1 - \\frac{\\Delta t}{2t} + \\frac{\\Delta t}{3t} - \\frac{(\\Delta t)^2}{6t^2} + \\frac{(\\Delta t)^2}{4t^2} + \\dots \\right)$$\n$$a_1 = a(t) + a'(t) \\Delta t \\left(1 - \\frac{\\Delta t}{6t} + \\frac{(\\Delta t)^2}{12t^2} + \\dots \\right)$$\n$$a_1 = a(t) + \\Delta t a'(t) - \\frac{(\\Delta t)^2}{6t} a'(t) + \\frac{(\\Delta t)^3}{12t^2} a'(t) + \\dots$$\n精确解 $a(t+\\Delta t)$ 的 Taylor 级数为：\n$$a(t+\\Delta t) = a(t) + \\Delta t a'(t) + \\frac{(\\Delta t)^2}{2} a''(t) + \\frac{(\\Delta t)^3}{6} a'''(t) + \\dots$$\nLTE 为 $\\tau(t) = a(t+\\Delta t) - a_1$。$\\Delta t^0$ 和 $\\Delta t^1$ 阶的项相互抵消。$(\\Delta t)^2$ 的系数是 $\\frac{1}{2}a''(t) - (-\\frac{1}{6t}a'(t))$。\n精确解的导数为：$a'(t)=\\frac{2}{3t}a(t)$，$a''(t) = -\\frac{2}{9t^2}a(t) = -\\frac{1}{3t}a'(t)$，以及 $a'''(t) = \\frac{8}{27t^3}a(t)$。\n代入 $a''(t) = -\\frac{1}{3t}a'(t)$，$(\\Delta t)^2$ 项为 $\\frac{(\\Delta t)^2}{2}(-\\frac{1}{3t}a'(t)) + \\frac{(\\Delta t)^2}{6t}a'(t) = 0$，这证实了该方法是二阶的。\n\n主导非零项是 $(\\Delta t)^3$ 阶的：\n$$\\tau(t) = \\left( \\frac{1}{6}a'''(t) - \\frac{1}{12t^2}a'(t) \\right) (\\Delta t)^3 + O((\\Delta t)^4)$$\n将导数的表达式用 $a(t)$ 表示并代入：\n$$\\tau(t) = \\left( \\frac{1}{6}\\frac{8a(t)}{27t^3} - \\frac{1}{12t^2}\\frac{2a(t)}{3t} \\right) (\\Delta t)^3 + \\dots = \\left( \\frac{4a(t)}{81t^3} - \\frac{a(t)}{18t^3} \\right) (\\Delta t)^3 + \\dots$$\n$$\\tau(t) = a(t) \\left( \\frac{8-9}{162t^3} \\right) (\\Delta t)^3 + \\dots = -\\frac{a(t)}{162t^3} (\\Delta t)^3 + O((\\Delta t)^4)$$\n因此，在时间 $t$ 处，对于步长 $\\Delta t(t)$，主阶局部截断误差为：\n$$\\tau(t) = -\\frac{a(t)}{162 t^3} (\\Delta t(t))^3$$\n\n### 步骤 2：误差传播\n\n全局误差 $e(t) = a_{\\mathrm{num}}(t) - a(t)$ 根据一个线性化方程演化。全局误差的变化率是现有误差的传播与新局部误差注入的总和。此演化的齐次部分是 $e'(t) \\approx \\frac{\\partial f}{\\partial a} e(t)$。\n对于 $f(t,a) = \\frac{2a}{3t}$，其偏导数为 $\\frac{\\partial f}{\\partial a} = \\frac{2}{3t}$。齐次误差方程为：\n$$e'(t) = \\frac{2}{3t} e(t)$$\n这与 $a(t)$ 的方程相同，因此其解为 $e(t) \\propto t^{2/3}$。基本解 $\\Phi(t,s)$ 描述了在时间 $s$ 注入的单位误差到稍后时间 $ts$ 的演化。它是 $e'(t) = \\frac{2}{3t}e(t)$ 在初始条件 $e(s)=1$ 下的解。解是 $e(t) = (t/s)^{2/3}$。\n因此，从时间 $s$ 到时间 $T$ 的误差传播的基本解是：\n$$\\Phi(T,s) = \\left(\\frac{T}{s}\\right)^{2/3}$$\n\n### 步骤 3：全局误差累积\n\n在时间 $T$ 的主阶全局误差 $E_{\\mathrm{global}}(T)$ 是所有局部误差的积分，每个局部误差都传播到最终时间 $T$。局部误差以每单位时间 $\\frac{\\tau(t)}{\\Delta t(t)}$ 的速率注入。全局误差是非齐次常微分方程 $e'(t) = \\frac{2}{3t}e(t) + \\frac{\\tau(t)}{\\Delta t(t)}$ 在初始条件 $e(t_0)=0$ 下的解。\n使用常数变易法公式，解为：\n$$E_{\\mathrm{global}}(T) = \\int_{t_0}^T \\Phi(T, s) \\frac{\\tau(s)}{\\Delta t(s)} ds$$\n源项（误差注入率）为：\n$$S(s) = \\frac{\\tau(s)}{\\Delta t(s)} = \\frac{-a(s)/(162s^3) \\cdot (\\Delta t(s))^3}{\\Delta t(s)} = -\\frac{a(s)}{162s^3} (\\Delta t(s))^2$$\n代入 $a(s) = a_0(s/t_0)^{2/3}$ 和 $\\Phi(T,s)=(T/s)^{2/3}$：\n$$E_{\\mathrm{global}}(T) = \\int_{t_0}^T \\left(\\frac{T}{s}\\right)^{2/3} \\left(-\\frac{a_0(s/t_0)^{2/3}}{162s^3} (\\Delta t(s))^2 \\right) ds$$\n$$E_{\\mathrm{global}}(T) = -\\frac{a_0 T^{2/3}}{162 t_0^{2/3}} \\int_{t_0}^T s^{-2/3} \\frac{s^{2/3}}{s^3} (\\Delta t(s))^2 ds$$\n$$E_{\\mathrm{global}}(T) = -\\frac{a_0 T^{2/3}}{162 t_0^{2/3}} \\int_{t_0}^T s^{-3} (\\Delta t(s))^2 ds$$\n\n现在我们对两种策略计算这个积分。\n\n**自适应策略**：$\\Delta t(s) = \\varepsilon s$。\n$$E_{\\mathrm{global}}^{\\mathrm{adaptive}}(T) = -\\frac{a_0 T^{2/3}}{162 t_0^{2/3}} \\int_{t_0}^T s^{-3} (\\varepsilon s)^2 ds = -\\frac{a_0 T^{2/3} \\varepsilon^2}{162 t_0^{2/3}} \\int_{t_0}^T s^{-1} ds$$\n$$E_{\\mathrm{global}}^{\\mathrm{adaptive}}(T) = -\\frac{a_0 T^{2/3} \\varepsilon^2}{162 t_0^{2/3}} [\\ln(s)]_{t_0}^T = -\\frac{a_0 T^{2/3} \\varepsilon^2}{162 t_0^{2/3}} \\ln\\left(\\frac{T}{t_0}\\right)$$\n\n**均匀策略**：$\\Delta t(s) = h$。\n$$E_{\\mathrm{global}}^{\\mathrm{uniform}}(T) = -\\frac{a_0 T^{2/3}}{162 t_0^{2/3}} \\int_{t_0}^T s^{-3} h^2 ds = -\\frac{a_0 T^{2/3} h^2}{162 t_0^{2/3}} \\int_{t_0}^T s^{-3} ds$$\n$$E_{\\mathrm{global}}^{\\mathrm{uniform}}(T) = -\\frac{a_0 T^{2/3} h^2}{162 t_0^{2/3}} \\left[-\\frac{1}{2}s^{-2}\\right]_{t_0}^T = -\\frac{a_0 T^{2/3} h^2}{162 t_0^{2/3}} \\left(-\\frac{1}{2T^2} + \\frac{1}{2t_0^2}\\right)$$\n$$E_{\\mathrm{global}}^{\\mathrm{uniform}}(T) = -\\frac{a_0 T^{2/3} h^2}{324 t_0^{2/3}} \\left(\\frac{1}{t_0^2} - \\frac{1}{T^2}\\right)$$\n\n### 步骤 4：全局误差之比\n\n比率 $R$ 定义为 $E_{\\mathrm{global}}^{\\mathrm{adaptive}}(T) / E_{\\mathrm{global}}^{\\mathrm{uniform}}(T)$。\n$$R = \\frac{-\\frac{a_0 T^{2/3} \\varepsilon^2}{162 t_0^{2/3}} \\ln\\left(\\frac{T}{t_0}\\right)}{-\\frac{a_0 T^{2/3} h^2}{324 t_0^{2/3}} \\left(\\frac{1}{t_0^2} - \\frac{1}{T^2}\\right)}$$\n公共的预因子相互抵消：\n$$R = \\frac{\\frac{\\varepsilon^2}{162} \\ln\\left(\\frac{T}{t_0}\\right)}{\\frac{h^2}{324} \\left(\\frac{1}{t_0^2} - \\frac{1}{T^2}\\right)} = \\frac{324}{162} \\frac{\\varepsilon^2}{h^2} \\frac{\\ln\\left(\\frac{T}{t_0}\\right)}{\\frac{1}{t_0^2} - \\frac{1}{T^2}}$$\n$$R = 2 \\frac{\\varepsilon^2}{h^2} \\frac{\\ln\\left(\\frac{T}{t_0}\\right)}{\\frac{T^2-t_0^2}{t_0^2 T^2}}$$\n化简表达式得到最终结果：\n$$R = \\frac{2 \\varepsilon^2 t_0^2 T^2 \\ln\\left(\\frac{T}{t_0}\\right)}{h^2 (T^2 - t_0^2)}$$", "answer": "$$\\boxed{\\frac{2 \\varepsilon^2 t_0^2 T^2 \\ln\\left(\\frac{T}{t_0}\\right)}{h^2 \\left(T^2 - t_0^2\\right)}}$$", "id": "3464466"}, {"introduction": "本节将理论付诸实践，通过一个编码练习来展示真实宇宙学代码中使用的强大技术。您将探索积分变量的选择（例如从宇宙时间 $t$ 切换到共形时间 $\\eta$）如何能够“平滑”问题的演化，从而让数值积分器以相同的计算成本达到更高的精度。这个实践将理论（时间坐标变换）与可量化的结果（误差大小）直接联系起来，突显了巧妙选择问题表述在计算物理中的重要性。[@problem_id:3464501]", "problem": "我们要求您针对一个简单的宇宙学检验方程，实现并比较两种时间变量下的自适应时间步长方法。考虑在一个空间平坦的 Friedmann–Robertson–Walker 宇宙中，共动奇速度的衰减。该过程由一个关于宇宙时 $t$ 的一阶常微分方程所描述：\n$$\n\\frac{dv}{dt} + H(t)\\,v = 0,\n$$\n其中 $H(t)$ 是哈勃参数，定义为 $H(t) = \\dot{a}(t)/a(t)$，$a(t)$ 是尺度因子。共形时间 $\\eta$ 由基本关系式定义：\n$$\nd\\eta = \\frac{dt}{a(t)},\n$$\n因此，对于任意可微函数 $f$，链式法则意味着：\n$$\n\\frac{df}{dt} = \\frac{1}{a(\\eta)} \\frac{df}{d\\eta}.\n$$\n在从 $t$ 到 $\\eta$ 的变换下，检验方程变为一个等效的关于共形时间的一阶常微分方程：\n$$\n\\frac{dv}{d\\eta} + \\frac{a'(\\eta)}{a(\\eta)}\\,v = 0,\n$$\n其中，撇号表示对 $\\eta$ 的导数。\n\n对于以下两种情况，使用从 Friedmann 方程得到的经过充分检验的背景演化模型：\n- 辐射主导 (RD): $a(t) \\propto t^{1/2}$。\n- 物质主导 (MD): $a(t) \\propto t^{2/3}$。\n\n通过固定比例常数，在归一化的无量纲单位下进行计算，使得：\n- RD: $a(t) = t^{1/2}$，因此 $H(t) = \\frac{1}{2t}$，$\\eta(t) = 2\\,t^{1/2}$，$a(\\eta) = \\eta/2$，以及 $a'(\\eta)/a(\\eta) = 1/\\eta$。\n- MD: $a(t) = t^{2/3}$，因此 $H(t) = \\frac{2}{3t}$，$\\eta(t) = 3\\,t^{1/3}$，$a(\\eta) = (\\eta/3)^2$，以及 $a'(\\eta)/a(\\eta) = 2/\\eta$。\n\n对于下方的每个测试用例，请执行以下操作：\n1. 使用带有自适应步长控制的显式嵌入式 Runge–Kutta 方法，以及绝对和相对容差 $(\\text{atol}, \\text{rtol})$，将关于 $t$ 的检验方程从初始时间 $t_i$ 积分到最终时间 $t_f$，初始条件为 $v(t_i) = v_i$。\n2. 使用相应背景下给定的 $\\eta(t)$ 将时间区间转换为共形时间，并使用相同的初始值 $v(\\eta_i) = v_i$ 和相同的容差设置 $(\\text{atol}, \\text{rtol})$，将变换后的关于 $\\eta$ 的方程从 $\\eta_i = \\eta(t_i)$ 积分到 $\\eta_f = \\eta(t_f)$。\n3. 对于两种积分，使用由方程和背景演化模型所蕴含的精确解 $v_\\text{exact}(t_f) = v_i\\,\\frac{a(t_i)}{a(t_f)}$，计算最终时刻的绝对误差。\n4. 对于每个测试用例，报告一个浮点数，该数等于在共形时间 $\\eta$ 中积分产生的绝对误差与在宇宙时 $t$ 中积分产生的绝对误差之比，即：\n$$\nR = \\frac{|v_\\eta(t_f) - v_\\text{exact}(t_f)|}{|v_t(t_f) - v_\\text{exact}(t_f)|},\n$$\n其中 $v_\\eta(t_f)$ 是在 $\\eta$ 中积分并映射到 $t_f$ 所得到的值，而 $v_t(t_f)$ 是在 $t$ 中积分所得到的值。\n\n所有量在归一化单位下都是无量纲的。不涉及角度。不涉及百分比。\n\n测试套件（每个项目是一个元组 $(\\text{background}, t_i, t_f, v_i, \\text{rtol}, \\text{atol})$）：\n- 用例 1 (理想路径): $(\\\"RD\\\", 10^{-6}, 1, 1, 10^{-6}, 10^{-12})$。\n- 用例 2 (短区间内接近初始奇异行为): $(\\\"MD\\\", 10^{-6}, 10^{-2}, 1, 10^{-6}, 10^{-12})$。\n- 用例 3 (紧容差、长区间、负初始值): $(\\\"RD\\\", 10^{-4}, 10, -0.3, 10^{-9}, 10^{-14})$。\n- 用例 4 (松容差、长区间、大振幅): $(\\\"MD\\\", 10^{-4}, 10, 2, 10^{-3}, 10^{-9})$。\n\n您的程序必须为每个用例的两种时间变量应用相同的容差设置。您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，`[r1,r2,r3,r4]`），其中每个 $r_k$是第 $k$ 个测试用例的误差比 $R$，表示为一个浮点数。", "solution": "我们从一个均匀膨胀背景下奇速度衰减的宇宙学检验方程开始，\n$$\n\\frac{dv}{dt} + H(t)\\,v = 0,\n$$\n其中 $H(t) = \\dot{a}(t)/a(t)$ 且 $a(t)$ 是尺度因子。该方程源于牛顿极限下膨胀宇宙中自由流奇速度的动量守恒，并且通常认为哈勃阻力项与 $H(t)$ 和速度的乘积成正比。\n\n共形时间 $\\eta$ 由基本关系式定义：\n$$\nd\\eta = \\frac{dt}{a(t)}.\n$$\n链式法则意味着对于任意可微标量函数 $f$：\n$$\n\\frac{df}{dt} = \\frac{df}{d\\eta} \\frac{d\\eta}{dt} = \\frac{1}{a(\\eta)} \\frac{df}{d\\eta},\n$$\n其中，在需要时，我们通过使用逆关系 $t(\\eta)$ 将 $a$ 与 $\\eta$ 复合。将此应用于 $v$ 并使用恒等式 $H(t) = \\dot{a}(t)/a(t)$，我们可以将方程变换到共形时间。具体来说，\n$$\n\\frac{dv}{dt} + H(t)\\,v = 0\n\\quad \\Longleftrightarrow \\quad\n\\frac{1}{a}\\frac{dv}{d\\eta} + \\frac{1}{a}\\frac{da}{dt}\\, \\frac{v}{1} = 0.\n$$\n注意到 $\\frac{da}{dt} = \\frac{da}{d\\eta} \\frac{d\\eta}{dt} = \\frac{1}{a} \\frac{da}{d\\eta}$，原方程变为：\n$$\n\\frac{1}{a}\\frac{dv}{d\\eta} + \\frac{1}{a^2}\\frac{da}{d\\eta}\\, v = 0.\n$$\n乘以 $a$ 得到\n$$\n\\frac{dv}{d\\eta} + \\frac{a'(\\eta)}{a(\\eta)}\\,v = 0,\n$$\n其中 $a'(\\eta) \\equiv \\frac{da}{d\\eta}$。\n\n为获得明确的尺度因子演化函数，我们使用空间平坦宇宙中 Friedmann 方程的经过充分检验的背景解：\n- 在辐射主导时期，尺度因子满足 $a(t) \\propto t^{1/2}$。选择归一化单位，我们设 $a(t) = t^{1/2}$，这意味着 $H(t) = \\frac{1}{2t}$。共形时间为：\n$$\n\\eta(t) = \\int^t \\frac{d\\tilde{t}}{a(\\tilde{t})} = \\int^t \\tilde{t}^{-1/2}\\, d\\tilde{t} = 2\\, t^{1/2},\n$$\n因此 $a(\\eta) = \\eta/2$ 且 $a'(\\eta)/a(\\eta) = 1/\\eta$。\n- 在物质主导时期，$a(t) \\propto t^{2/3}$。当 $a(t) = t^{2/3}$ 时，我们有 $H(t) = \\frac{2}{3t}$。共形时间为：\n$\n\\eta(t) = \\int^t \\tilde{t}^{-2/3}\\, d\\tilde{t} = 3\\, t^{1/3},\n$\n因此 $a(\\eta) = (\\eta/3)^2$ 且 $a'(\\eta)/a(\\eta) = 2/\\eta$。\n\n原方程的精确解可以直接推导。写作：\n$$\n\\frac{dv}{dt} = -H(t)\\,v = -\\frac{\\dot{a}}{a}\\, v,\n$$\n我们有\n$$\n\\frac{1}{v}\\frac{dv}{dt} = -\\frac{1}{a}\\frac{da}{dt} \\quad \\Longrightarrow \\quad \\frac{d\\ln v}{dt} = -\\frac{d\\ln a}{dt}.\n$$\n从 $t_i$ 积分到 $t_f$ 得到：\n$$\n\\ln \\frac{v(t_f)}{v(t_i)} = - \\ln \\frac{a(t_f)}{a(t_i)} \\quad \\Longrightarrow \\quad v(t_f) = v(t_i)\\, \\frac{a(t_i)}{a(t_f)}.\n$$\n因此，精确的最终值为：\n$$\nv_\\text{exact}(t_f) = v_i\\, \\frac{a(t_i)}{a(t_f)}.\n$$\n\n算法设计：\n- 对于每个测试用例 $(\\text{background}, t_i, t_f, v_i, \\text{rtol}, \\text{atol})$，我们根据所选的背景定义 $a(t)$, $H(t)$, $\\eta(t)$, $a(\\eta)$ 和 $a'(\\eta)/a(\\eta)$。\n- 我们使用带有自适应步长的显式嵌入式 Runge–Kutta 方法和指定的容差 $(\\text{rtol}, \\text{atol})$，在宇宙时 $t$ 中，将一阶常微分方程\n$$\n\\frac{dv}{dt} = -H(t)\\,v\n$$\n从 $t_i$ 积分到 $t_f$，初始条件为 $v(t_i) = v_i$。一个标准的选择是 Dormand–Prince 方法，它通过比较一对不同阶数的解来自适应地控制局部截断误差，从而调整步长以维持所要求的误差界限。\n- 我们通过计算 $\\eta_i = \\eta(t_i)$ 和 $\\eta_f = \\eta(t_f)$ 将时间区间转换为共形时间。然后，我们使用相同的初始条件 $v(\\eta_i) = v_i$ 和相同的容差，在共形时间中积分方程\n$$\n\\frac{dv}{d\\eta} = -\\frac{a'(\\eta)}{a(\\eta)}\\, v,\n$$\n从 $\\eta_i$ 到 $\\eta_f$。因为当 $t \\to 0^+$ 和 $\\eta \\to 0^+$ 时，$H(t)$ 和 $a'(\\eta)/a(\\eta)$ 都具有可积的奇异行为，我们通过选择严格为正的 $t_i$ 以及因此严格为正的 $\\eta_i$ 来避免奇点。\n- 我们使用所选背景已知的 $a(t)$ 计算精确的最终值 $v_\\text{exact}(t_f) = v_i \\, a(t_i)/a(t_f)$。然后我们计算 $t$-积分和 $\\eta$-积分的绝对误差：\n$$\n\\varepsilon_t = \\left| v_t(t_f) - v_\\text{exact}(t_f) \\right|, \\quad\n\\varepsilon_\\eta = \\left| v_\\eta(t_f) - v_\\text{exact}(t_f) \\right|.\n$$\n- 为在相同容差设置下比较误差行为，我们计算比率\n$$\nR = \\frac{\\varepsilon_\\eta}{\\varepsilon_t}.\n$$\n该比率量化了在共形时间中使用相同的自适应容差进行积分，相对于在宇宙时中积分，是产生更小的误差（$R  1$）、更大的误差（$R > 1$）还是相似的误差（$R \\approx 1$）。\n\n测试覆盖率说明：\n- 用例 1 是一个通用的“理想路径”，在辐射主导背景下具有适中的区间和容差。\n- 用例 2 从接近初始奇异行为处开始，在物质主导背景下对一个短区间进行积分，以探测自适应控制器如何处理初始时间附近的大系数。\n- 用例 3 在辐射主导情况下，于一个更长的区间上使用更紧的容差和一个负初始值，以检验控制器在跨越多个时间数量级时保持高精度的能力。\n- 用例 4 在物质主导情况下，于一个长区间上使用更松的容差和更大的振幅，以测试在放宽精度要求时的鲁棒性和误差缩放情况。\n\n实现细节：\n- 我们使用标准数值库提供的带有自适应控制的显式嵌入式 Runge–Kutta 方法来实现两个积分器。我们确保对于每个测试用例，$t$ 和 $\\eta$ 的积分都使用相同的一对容差。\n- 最终程序产生单行输出，其中包含一个列表，按测试套件的顺序排列着四个误差比 $R$，格式为 `[r1,r2,r3,r4]`。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.integrate import solve_ivp\n\ndef background_functions(bg):\n    \"\"\"\n    Return functions for a(t), H(t), eta(t), a(eta), and (a'/a)(eta) for a given background.\n    bg: 'RD' or 'MD'\n    \"\"\"\n    if bg == 'RD':\n        # Radiation-dominated: a(t) = t^{1/2}, H(t) = 1/(2t)\n        a_of_t = lambda t: np.sqrt(t)\n        H_of_t = lambda t: 0.5 / t\n        eta_of_t = lambda t: 2.0 * np.sqrt(t)\n        a_of_eta = lambda eta: 0.5 * eta\n        aprime_over_a = lambda eta: 1.0 / eta\n    elif bg == 'MD':\n        # Matter-dominated: a(t) = t^{2/3}, H(t) = 2/(3t)\n        a_of_t = lambda t: t ** (2.0 / 3.0)\n        H_of_t = lambda t: (2.0 / 3.0) / t\n        eta_of_t = lambda t: 3.0 * (t ** (1.0 / 3.0))\n        a_of_eta = lambda eta: (eta / 3.0) ** 2\n        aprime_over_a = lambda eta: 2.0 / eta\n    else:\n        raise ValueError(\"Unknown background\")\n    return a_of_t, H_of_t, eta_of_t, a_of_eta, aprime_over_a\n\ndef integrate_in_t(H_of_t, t_i, t_f, v_i, rtol, atol):\n    \"\"\"\n    Integrate dv/dt = -H(t) v from t_i to t_f with initial condition v(t_i) = v_i.\n    \"\"\"\n    def rhs(t, y):\n        return [-H_of_t(t) * y[0]]\n    sol = solve_ivp(rhs, (t_i, t_f), [v_i], method='RK45', rtol=rtol, atol=atol)\n    v_tf = sol.y[0, -1]\n    return v_tf\n\ndef integrate_in_eta(ap_over_a, eta_i, eta_f, v_i, rtol, atol):\n    \"\"\"\n    Integrate dv/deta = -(a'/a)(eta) v from eta_i to eta_f with initial condition v(eta_i) = v_i.\n    \"\"\"\n    def rhs(eta, y):\n        return [-ap_over_a(eta) * y[0]]\n    sol = solve_ivp(rhs, (eta_i, eta_f), [v_i], method='RK45', rtol=rtol, atol=atol)\n    v_eta_f = sol.y[0, -1]\n    return v_eta_f\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each case: (background, t_i, t_f, v_i, rtol, atol)\n    test_cases = [\n        (\"RD\", 1e-6, 1.0, 1.0, 1e-6, 1e-12),     # Case 1\n        (\"MD\", 1e-6, 1e-2, 1.0, 1e-6, 1e-12),    # Case 2\n        (\"RD\", 1e-4, 10.0, -0.3, 1e-9, 1e-14),   # Case 3\n        (\"MD\", 1e-4, 10.0, 2.0, 1e-3, 1e-9),     # Case 4\n    ]\n\n    results = []\n    for bg, t_i, t_f, v_i, rtol, atol in test_cases:\n        a_of_t, H_of_t, eta_of_t, a_of_eta, aprime_over_a = background_functions(bg)\n\n        # Integrate in cosmic time t\n        v_t_final = integrate_in_t(H_of_t, t_i, t_f, v_i, rtol, atol)\n\n        # Convert to conformal time interval\n        eta_i = eta_of_t(t_i)\n        eta_f = eta_of_t(t_f)\n\n        # Integrate in conformal time eta\n        v_eta_final = integrate_in_eta(aprime_over_a, eta_i, eta_f, v_i, rtol, atol)\n\n        # Exact final value\n        v_exact = v_i * (a_of_t(t_i) / a_of_t(t_f))\n\n        # Absolute errors\n        err_t = abs(v_t_final - v_exact)\n        err_eta = abs(v_eta_final - v_exact)\n\n        # Error ratio; safeguard against zero division\n        if err_t == 0.0:\n            ratio = np.inf if err_eta  0.0 else 1.0\n        else:\n            ratio = err_eta / err_t\n\n        results.append(ratio)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```", "id": "3464501"}, {"introduction": "这项练习是一个高级设计挑战，反映了开发前沿模拟代码时所面临的复杂性。当一个系统涉及多种物理过程时（如此处的流体力学和引力），我们如何将来自不同物理量（如密度 $\\rho$、速度 $\\mathbf{v}$ 和引力势 $\\Phi$）的误差组合成一个单一且有意义的度量标准？这项练习要求您运用物理直觉和量纲分析，来构建一个稳健且自适应的误差范数，这是任何多物理场自适应时间步长方案的核心组成部分。[@problem_id:3464499]", "problem": "一个自引力、可压缩的非相对论性流体，在一个使用共动坐标的牛顿宇宙学代码中进行演化，其标度因子为 $a(t)$，哈勃参数为 $H(t) = \\dot{a}(t)/a(t)$。状态变量为质量密度 $\\rho(\\mathbf{x},t)$、本动速度 $\\mathbf{v}(\\mathbf{x},t)$ 和引力势 $\\Phi(\\mathbf{x},t)$，它们由连续性方程、欧拉方程和泊松方程所支配。在一个线性尺度为 $L$ 的局部控制体积内，代码的内嵌误差估计器对单个试验时间步产生局部截断误差估计 $\\delta \\rho$、$\\delta \\mathbf{v}$ 和 $\\delta \\Phi$。一个自适应时间步长控制器必须将这些误差聚合成一个单一的、无量纲的混合变量误差范数 $E$，以便与用户容差 $\\varepsilon$ 进行比较，并决定接受或拒绝该时间步。\n\n从第一性原理出发，相关的控制定律和量纲如下：\n- 连续性方程：$\\partial_t \\rho + \\nabla \\cdot (\\rho \\mathbf{v}) + 3 H \\rho = 0$。\n- 欧拉方程：$\\partial_t \\mathbf{v} + (\\mathbf{v}\\cdot\\nabla)\\mathbf{v} = - \\nabla P / \\rho - \\nabla \\Phi - H \\mathbf{v}$，其状态方程给出声速 $c_s^2 = \\partial P / \\partial \\rho$。\n- 泊松方程：$\\nabla^2 \\Phi = 4 \\pi G (\\rho - \\bar{\\rho})$，其中 $G$ 是牛顿引力常数，$\\bar{\\rho}$ 是宇宙平均密度。\n- 量纲：$[\\rho] = M L^{-3}$，$[\\mathbf{v}] = L T^{-1}$，$[\\Phi] = L^2 T^{-2}$，$[H] = T^{-1}$，$[c_s] = L T^{-1}$。\n\n一个物理上相关的特征速度应该能捕捉到平流、声学和引力运动中最快的信号。一个提议的选择是\n$$\nv_* = \\max\\!\\left( \\lVert \\mathbf{v} \\rVert,\\, c_s,\\, \\sqrt{|\\Phi|} \\right),\n$$\n其动机是在束缚流中存在维里标度关系 $|\\Phi| \\sim \\lVert \\mathbf{v} \\rVert^2$，以及声速 $c_s$ 控制着压缩动力学这一事实。在构造 $E$ 时，其标度变换必须量纲一致，并能反映密度、速度和引力势误差在不同机制下（包括超音速流、维里化晕和膨胀主导区域）对欧拉和泊松动力学的相对影响。\n\n基于量纲分析和物理相关性，在当前宇宙学背景下，以下哪个候选混合变量范数 $E$ 最适合用于聚合误差 $\\delta \\rho$、$\\delta \\mathbf{v}$ 和 $\\delta \\Phi$？这里 $\\delta v = \\lVert \\delta \\mathbf{v} \\rVert$。\n\nA. \n$$\nE_A = \\left[ \\left( \\frac{\\delta \\rho}{\\rho} \\right)^2 \\left( \\frac{c_s^2}{v_*^2} \\right) + \\left( \\frac{\\delta v}{v_*} \\right)^2 + \\left( \\frac{\\delta \\Phi}{v_*^2} \\right)^2 \\right]^{1/2}\n$$\n\nB.\n$$\nE_B = \\left[ \\left( \\frac{\\delta \\rho}{\\bar{\\rho}} \\right)^2 + \\left( \\frac{\\delta v}{\\lVert \\mathbf{v} \\rVert} \\right)^2 + \\left( \\frac{\\delta \\Phi}{|\\Phi|} \\right)^2 \\right]^{1/2}\n$$\n\nC.\n$$\nE_C = \\left[ \\delta \\rho^2 + \\delta v^2 + \\delta \\Phi^2 \\right]^{1/2}\n$$\n\nD.\n$$\nE_D = \\left[ \\left( \\frac{\\delta \\rho}{\\rho} \\right)^2 + \\left( \\frac{\\delta v}{H L} \\right)^2 + \\left( \\frac{\\delta \\Phi}{H^2 L^2} \\right)^2 \\right]^{1/2}\n$$\n\n选择唯一最佳选项。你必须通过从控制方程和量纲出发，展示 $E$ 中每一项的标度变换如何与物理上相关的加速度和时间尺度相关联，并说明为何所选选项在 $c_s$、$\\lVert \\mathbf{v} \\rVert$ 或 $\\sqrt{|\\Phi|}$ 占主导地位的不同机制下仍然适用，来证明你的选择是正确的。解释为什么其他选项在量纲一致性或物理相关性方面不成立。假设没有相对论效应，并且空间变化在网格尺度 $L$ 上得到了充分解析。", "solution": "### 问题分析\n核心任务是构建一个无量纲的误差范数 $E$，以适当地组合误差 $\\delta \\rho$、$\\delta v$ 和 $\\delta \\Phi$。这需要对每个变量的误差进行归一化，并根据其在系统动力学中的物理重要性进行加权。系统的动力学由欧拉方程决定，该方程支配着流体的加速度。\n\n一个鲁棒的误差范数应被构造成这样：其每一项都是无量纲的，并且整个表达式在所有预期的机制下都是数值上稳定且物理上有意义的。特征速度 $v_* = \\max\\!\\left( \\lVert \\mathbf{v} \\rVert,\\, c_s,\\, \\sqrt{|\\Phi|} \\right)$ 被作为动力学的关键局部尺度。它代表了信息可以局部传播的最快速度，因此它设定了局部的动力学时间尺度，例如，通过 Courant-Friedrichs-Lewy (CFL) 条件，$\\Delta t \\lesssim L/v_*$。\n\n让我们从每个变量构造无量纲的误差贡献：\n\n1.  **速度误差：** 速度误差为 $\\delta v$，其量纲为速度，$[L T^{-1}]$。用于归一化的自然且物理上自适应的量是特征速度 $v_*$。因此，无量纲的速度误差贡献是 $\\left( \\frac{\\delta v}{v_*} \\right)^2$。\n\n2.  **引力势误差：** 引力势误差为 $\\delta \\Phi$，其量纲为速度的平方，$[L^2 T^{-2}]$。为了使其无量纲，我们必须用一个具有相同量纲的量来归一化。与速度归一化一致的逻辑选择是 $v_*^2$。因此，无量纲的引力势误差贡献是 $\\left( \\frac{\\delta \\Phi}{v_*^2} \\right)^2$。\n\n3.  **密度误差：** 密度误差为 $\\delta \\rho$。一个简单的无量纲量是相对误差 $\\frac{\\delta \\rho}{\\rho}$。然而，密度涨落的动力学重要性关键地取决于流体的可压缩性和温度，由声速 $c_s$ 代表。欧拉方程表明，密度通过压力梯度项 $-\\nabla P/\\rho$ 影响加速度，该项的大小与 $c_s^2$ 相关。该压力项相对于惯性项（例如，平流，$\\sim v_*^2$）的重要性，由比率 $c_s^2 / v_*^2$ 来表征。在高度超音速流（$v_* \\gg c_s$）中，压力很弱，密度误差对总误差范数的影响应该较小。相反，在亚音速流（$v_* \\approx c_s$）中，压力在动力学上是显著的，密度误差应被完全加权。\n\n因此，平方相对密度误差 $\\left(\\frac{\\delta \\rho}{\\rho}\\right)^2$ 应乘以一个能捕捉到这种物理效应的权重因子。最直接且具有物理动机的权重因子恰好是特征压力“能量”与特征动能“能量”的比值，即 $w_\\rho = \\frac{c_s^2}{v_*^2}$。\n\n**组合各项：**\n将这些贡献组合成一个单一的L2范数（平方和），我们得到误差范数的平方：\n$$\nE^2 = w_\\rho \\left(\\frac{\\delta \\rho}{\\rho}\\right)^2 + w_v \\left(\\frac{\\delta v}{v_*}\\right)^2 + w_\\Phi \\left(\\frac{\\delta \\Phi}{v_*^2}\\right)^2\n$$\n设定权重 $w_v = 1$ 和 $w_\\Phi = 1$（因为速度和引力势已经由主导尺度 $v_*$ 归一化），并使用我们推导出的密度权重 $w_\\rho = c_s^2/v_*^2$，我们得到：\n$$\nE^2 = \\left(\\frac{c_s^2}{v_*^2}\\right) \\left(\\frac{\\delta \\rho}{\\rho}\\right)^2 + \\left(\\frac{\\delta v}{v_*}\\right)^2 + \\left(\\frac{\\delta \\Phi}{v_*^2}\\right)^2\n$$\n这个表达式是量纲一致的，使用了物理上自适应的归一化尺度 ($v_*$)，并根据局部动力学机制正确地加权了密度误差的贡献。\n\n### 逐项分析\n\n**A. $E_A = \\left[ \\left( \\frac{\\delta \\rho}{\\rho} \\right)^2 \\left( \\frac{c_s^2}{v_*^2} \\right) + \\left( \\frac{\\delta v}{v_*} \\right)^2 + \\left( \\frac{\\delta \\Phi}{v_*^2} \\right)^2 \\right]^{1/2}$**\n这个表达式与我们的推导完全匹配。\n-   **量纲分析：** 平方根内的每一项都是无量纲的。该表达式有效。\n-   **物理相关性：** 它使用自适应速度尺度 $v_*$ 进行归一化，确保了在不同机制下的相关性。$\\delta v$ 用 $v_*$ 归一化以及 $\\delta \\Phi$ 用 $v_*^2$ 归一化是正确的。关键在于，密度误差项乘以 $c_s^2/v_*^2$ 进行加权，正确地反映了物理原理，即密度涨落的动力学重要性与压力（由 $c_s^2$ 代表）相对于主导动力学（由 $v_*^2$ 代表）的重要性成正比。这使得该范数对于亚音速流、超音速流和维里化流都是鲁棒的。\n-   **结论：** 正确。\n\n**B. $E_B = \\left[ \\left( \\frac{\\delta \\rho}{\\bar{\\rho}} \\right)^2 + \\left( \\frac{\\delta v}{\\lVert \\mathbf{v} \\rVert} \\right)^2 + \\left( \\frac{\\delta \\Phi}{|\\Phi|} \\right)^2 \\right]^{1/2}$**\n此选项使用各自的局部量进行归一化。\n-   **量纲分析：** 每一项都是具有相同单位的量之比，因此是无量纲的。\n-   **物理相关性：** 这个范数有几个致命的缺陷。\n    1.  **数值不稳定性：** 分母 $\\lVert \\mathbf{v} \\rVert$ 和 $|\\Phi|$ 在物理上常见的情况下可能为零或接近零（例如，本动速度为零或引力势涨落为零的区域）。这将导致范数发散，从而在时间步长控制器中引起病态行为（例如，迫使时间步长无限小）。\n    2.  **不合适的标度：** 项 $\\delta\\rho/\\bar{\\rho}$ 用*宇宙平均密度* $\\bar{\\rho}$ 来归一化局部密度误差。在一个 $\\rho \\gg \\bar{\\rho}$ 的致密晕中，一个小的、物理上不重要的*相对*误差 $\\delta\\rho/\\rho$ 会被极大地放大，导致效率低下的过小时间步。\n    3.  **缺乏物理加权：** 它将每个变量的1%误差（相对于其自身的大小）视为同等重要，忽略了它们的相对影响会随着物理机制急剧变化的事实，而欧拉方程正捕捉了这一点。\n-   **结论：** 不正确。\n\n**C. $E_C = \\left[ \\delta \\rho^2 + \\delta v^2 + \\delta \\Phi^2 \\right]^{1/2}$**\n此选项直接将误差的平方相加。\n-   **量纲分析：** 这在根本上是错误的。它试图将具有不同物理量纲的量相加：\n    -   $[\\delta \\rho^2] = M^2 L^{-6}$\n    -   $[\\delta v^2] = L^2 T^{-2}$\n    -   $[\\delta \\Phi^2] = L^4 T^{-4}$\n    将这些量相加在数学和物理上是无意义的。$E_C$ 的值会随着所使用的单位制（例如，SI vs. cgs）而改变。\n-   **物理相关性：** 由于它在量纲上不一致，因此不具有物理相关性。\n-   **结论：** 不正确。\n\n**D. $E_D = \\left[ \\left( \\frac{\\delta \\rho}{\\rho} \\right)^2 + \\left( \\frac{\\delta v}{H L} \\right)^2 + \\left( \\frac{\\delta \\Phi}{H^2 L^2} \\right)^2 \\right]^{1/2}$**\n此选项使用从哈勃参数 $H$ 和网格尺度 $L$ 导出的尺度。\n-   **量纲分析：** 速度尺度 $HL$ 的单位是 $[L T^{-1}]$，引力势尺度 $H^2 L^2$ 的单位是 $[L^2 T^{-2}]$。所有项都是无量纲的。该表达式有效。\n-   **物理相关性：** 尺度 $HL$ 和 $H^2 L^2$ 是哈勃流在尺度 $L$ 上的特征。虽然这可能适用于哈勃流占主导地位的大尺度线性区域空洞，但对于非线性的、引力坍缩的结构（如星系和星系团）来说完全不合适。在这些致密区域，本动速度和引力势由局部物理决定，并且通常远大于由哈勃参数导出的尺度（例如 $\\lVert \\mathbf{v} \\rVert \\gg HL$）。使用 $HL$ 作为归一化会严重低估真实的动力学速度，导致误差范数被人为地放大，并迫使模拟采用不必要的、效率低下的过小时间步。一个合适的范数必须适应*局部*的动力学状态，而这个选项没有做到这一点。\n-   **结论：** 不正确。\n\n基于这一全面分析，选项A是唯一在量纲上一致、数值上稳定，并且在宇宙学模拟中遇到的各种条件下物理上都合适的候选选项。", "answer": "$$\\boxed{A}$$", "id": "3464499"}]}