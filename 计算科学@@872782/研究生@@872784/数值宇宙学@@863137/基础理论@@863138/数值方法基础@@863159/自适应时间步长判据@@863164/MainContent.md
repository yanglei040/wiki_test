## 引言
在[数值宇宙学](@entry_id:752779)中，[模拟宇宙](@entry_id:754872)的演化依赖于求解一组复杂的[微分方程](@entry_id:264184)，这些方程描述了跨越多个[数量级](@entry_id:264888)时间尺度的物理过程。从宇宙的快速膨胀到星系内部的[恒星动力学](@entry_id:158068)，不同现象的特征时间尺度差异巨大。这种多尺度特性给[数值模拟](@entry_id:137087)带来了严峻挑战：使用一个固定的、小到足以解析最快过程的时间步长，会使计算成本高到无法承受，从而限制了我们探索宇宙奥秘的能力。

本文旨在解决这一关键的知识缺口，系统介绍**[自适应时间步长](@entry_id:261403)标准**——一种旨在动态调整时间步长，从而在保证精度和稳定性的前提下，实现计算效率最大化的强大数值方法。通过学习本文，读者将掌握设计和实现鲁棒的[自适应步长控制](@entry_id:142684)器的核心知识。

为构建全面的理解，本文将分三个部分展开：
-   **原理与机制**：我们将深入探讨构成自适应控制基础的两大支柱——稳定性和精度。您将学习如何为[流体动力学](@entry_id:136788)、[引力](@entry_id:175476)以及其他物理过程量化[时间步长约束](@entry_id:174412)，并了解如何将它们融合成一个统一的控制策略。
-   **应用与交叉学科联系**：我们将展示这些原理如何在天体物理、计算流体力学、化学反应网络等不同领域得到应用，揭示普适的自适应思想如何演化出针对特定问题的精妙解决方案。
-   **动手实践**：通过一系列精心设计的练习，您将有机会将理论付诸实践，从解析推导到编码挑战，从而巩固对[自适应步长](@entry_id:636271)选择背后复杂性的深刻理解。

让我们首先从驱动[自适应时间步长](@entry_id:261403)选择的根本原理和核心机制开始。

## 原理与机制

在[数值宇宙学](@entry_id:752779)中，对宇宙演化的模拟本质上是求解一组复杂的[常微分方程](@entry_id:147024) (ODEs) 和[偏微分方程](@entry_id:141332) (PDEs) 的初值问题。这些方程描述了从背景时空的膨胀到暗物质的[引力](@entry_id:175476)聚集，再到重子气体的复杂[流体动力学](@entry_id:136788)和[化学反应](@entry_id:146973)。由于这些过程的时间尺度跨越了许多[数量级](@entry_id:264888)，使用一个固定的、足够小以解析最快过程的时间步长，在计算上是极其昂贵甚至不可行的。因此，**[自适应时间步长](@entry_id:261403)**（adaptive time-stepping）成为现代宇宙学模拟中不可或缺的核心技术。它并非单一的算法，而是一套控制策略，旨在根据模拟在每个时刻的状态动态调整时间步长 $\Delta t$，从而在满足用户定义的精度和稳定性要求的同时，最大限度地提高[计算效率](@entry_id:270255)。

本章将深入探讨驱动[自适应时间步长](@entry_id:261403)选择的根本原理和核心机制。我们将从构成任何自适应控制器基础的两大支柱——**稳定性**和**精度**——出发，系统地阐述如何在[流体动力学](@entry_id:136788)、[引力](@entry_id:175476)动力学和[常微分方程](@entry_id:147024)积分等不同物理情境下量化这些约束。随后，我们将展示如何将这些来自多物理过程的独立判据融合成一个统一的、鲁棒的步长[选择算法](@entry_id:637237)。最后，我们将讨论一些更为深刻和微妙的主题，包括[数值刚性](@entry_id:752836)、积分变量的选择、[自适应网格](@entry_id:164379)中的[步长控制](@entry_id:755439)，以及自适应性对基本[守恒定律](@entry_id:269268)的深远影响。

### 时间[步长控制](@entry_id:755439)的基本策略

在实践中，时间步长的选择主要遵循三种不同的策略，其核心区别在于确定 $\Delta t$ 的控制逻辑 [@problem_id:3464470]。

1.  **固定步长（Fixed Stepping）**：在整个模拟过程中使用一个恒定不变的时间步长 $\Delta t$。为保证全程的稳定性和精度，这个 $\Delta t$ 必须小于或等于模拟中可能出现的所有[时间步长约束](@entry_id:174412)的最小值。这种策略虽然简单，但效率极低，因为它被迫始终适应最极端的情况，即使这种情况很少发生。

2.  **[自适应步长](@entry_id:636271)（Adaptive Stepping）**：将 $\Delta t$ 视为一个受控变量，在每一步都根据当前系统的状态（如[波速](@entry_id:186208)、误差估计）进行调整。其目标是选择一个尽可能大的 $\Delta t$，同时精确地满足所有预设的精度和[稳定性判据](@entry_id:755304)。这是本章的[焦点](@entry_id:174388)，它代表了一种旨在实现效率与可靠性最佳平衡的动态控制过程。

3.  **事件驱动步长（Event-Driven Stepping）**：选择 $\Delta t$ 的首要目标是使模拟恰好在某个预定的外部指定的时间点（或“事件”）结束。例如，精确地停在某个特定的输出红移 $z_k$、多物理耦合的同步时刻，或某个物理量的阈值检测点。尽管一个鲁棒的事件驱动实现仍然必须在内部遵守稳定性和精度约束（可能通过采取多个子步骤来安全地到达事件点），但其步长选择的*主要动机*是满足外部时间表，而非内部[误差控制](@entry_id:169753)。

### [自适应控制](@entry_id:262887)的两大支柱：稳定性与精度

任何显式数值积分方案的有效性都建立在两个基本属性之上：稳定性和精度。[自适应时间步长](@entry_id:261403)算法的核心任务就是量化这两个要求，并将它们转化为对 $\Delta t$ 的具体约束。

#### 稳定性约束

稳定性保证了数值解在演化过程中不会出现无界增长或非物理[振荡](@entry_id:267781)。在[宇宙学模拟](@entry_id:747928)中，最主要的稳定性约束来自[双曲型偏微分方程](@entry_id:144631)（如[流体动力学](@entry_id:136788)）和[引力](@entry_id:175476)多体系统的积分。

**宇宙学[Courant-Friedrichs-Lewy (CFL) 条件](@entry_id:747986)**

对于描述[流体动力学](@entry_id:136788)的欧拉方程这类[双曲守恒律](@entry_id:147752)，显式[有限体积法](@entry_id:749372)（explicit finite-volume method）的稳定性受到 **[Courant-Friedrichs-Lewy (CFL) 条件](@entry_id:747986)** 的制约。该条件源于一个基本物理直觉：在一个时间步 $\Delta t$ 内，任何信息（或特征波）的传播距离不应超过一个网格单元的宽度。

在[宇宙学模拟](@entry_id:747928)中，我们通常在随动坐标（comoving coordinates）下进行计算，其网格尺寸为 $\Delta x$。物理坐标 $\boldsymbol{r}$ 和随动坐标 $\boldsymbol{x}$ 通过宇宙[尺度因子](@entry_id:266678) $a(t)$ 联系：$\boldsymbol{r}(t) = a(t)\boldsymbol{x}$。流体的物理[本动速度](@entry_id:157964) $\boldsymbol{v}$ 和随动[本动速度](@entry_id:157964) $\boldsymbol{u}$ 的关系是 $\boldsymbol{u} = \boldsymbol{v}/a$。类似地，物理声速 $c_{s,\mathrm{phys}}$ 对应于随动声速 $c_s = c_{s,\mathrm{phys}}/a$。

在随动[坐标系](@entry_id:156346)中，特征信号的最大[传播速度](@entry_id:189384)是随动流体速度和随动声速之和，即 $s_{\max} = \max(|\boldsymbol{u}|) + \max(c_s)$。[CFL条件](@entry_id:178032)要求在一个时间步 $\Delta t$ 内，这个信号在随动网格上移动的距离不超过一个单元，即 $s_{\max} \Delta t \le \Delta x$。因此，CFL[时间步长约束](@entry_id:174412)为：

$$
\Delta t_{\mathrm{CFL}} \le C_{\mathrm{CFL}}\,\dfrac{\Delta x}{s_{\max}} = C_{\mathrm{CFL}}\,\dfrac{\Delta x}{\max(|\boldsymbol{u}|) + \max(c_s)}
$$

其中 $C_{\mathrm{CFL}}$ 是一个小于1的安全因子，称为[Courant数](@entry_id:143767)。将随动量用物理量表示，我们得到一个在实践中更有用的形式 [@problem_id:3464508]：

$$
\Delta t_{\mathrm{CFL}} \le C_{\mathrm{CFL}}\,\dfrac{a\,\Delta x}{\max(|\boldsymbol{v}|) + \max(c_{s,\mathrm{phys}})}
$$

这个表达式的物理解释非常清晰：时间步长必须小于信号以最大物理特征速度（$|\boldsymbol{v}| + c_{s,\mathrm{phys}}$）穿过一个物理尺寸为 $a\Delta x$ 的网格单元所需的时间。例如，在一个[红移](@entry_id:159945) $z=3$ ($a=0.25$) 的模拟中，如果随动网格尺寸为 $\Delta x = 50\,\mathrm{kpc}$，最大物理速度为 $600\,\mathrm{km\,s^{-1}}$，最大物理声速为 $30\,\mathrm{km\,s^{-1}}$，并取 $C_{\mathrm{CFL}}=0.5$，则 $\Delta t_{\mathrm{CFL}}$ 约为 $9.7$ 百万年，这对于该分辨率下的[宇宙学模拟](@entry_id:747928)是一个合理的量级 [@problem_id:3464508]。

**[引力](@entry_id:175476)稳定性与动力学时标**

对于受[自引力](@entry_id:271015)主导的系统，如暗物质和重子物质的[引力](@entry_id:175476)塌缩，还存在另一个关键的稳定性约束。这个约束与**动力学时标**（dynamical time） $\tau_{\mathrm{dyn}}$ 相关，它大致等于一个系统的自由落体时标。从[量纲分析](@entry_id:140259)可知，唯一能由[引力常数](@entry_id:262704) $G$ (单位 $L^3 M^{-1} T^{-2}$) 和局部[物质密度](@entry_id:263043) $\rho$ (单位 $M L^{-3}$) 构成的具有时间量纲的组合是 $(G\rho)^{-1/2}$。因此，我们有：

$$
\tau_{\mathrm{dyn}} \propto (G\rho)^{-1/2}
$$

为保证[数值积分器](@entry_id:752799)能精确地追踪[引力](@entry_id:175476)驱动的演化（如轨道运动和结构塌缩），时间步长必须是动力学时标的一个小部分。这引出了[引力](@entry_id:175476)[时间步长约束](@entry_id:174412) [@problem_id:3464520]：

$$
\Delta t_{\mathrm{grav}} \le \eta\,\tau_{\mathrm{dyn}}
$$

其中 $\eta$ 是一个小于1的无量纲安全因子。由于 $\tau_{\mathrm{dyn}}$ 反比于密度的平方根，这意味着在密度极高的区域（如星系中心），[引力](@entry_id:175476)演化非常迅速，需要极小的时间步长。

#### 精度约束

精度关注的是数值解在多大程度上偏离了真实的连续解。[自适应算法](@entry_id:142170)通过在每一步估计**[局部截断误差](@entry_id:147703)**（Local Truncation Error, LTE）并将其控制在用户设定的容差范围内来保证精度。

**[常微分方程](@entry_id:147024)的精度控制：[嵌入式龙格-库塔](@entry_id:142025)法**

宇宙背景演化、化学网络、[辐射冷却](@entry_id:754014)等许多过程都可以被建模为[常微分方程组](@entry_id:266774) $\boldsymbol{y}'(t) = \boldsymbol{f}(t, \boldsymbol{y})$。求解这[类方程](@entry_id:144428)的现代标准方法是**[嵌入式龙格-库塔](@entry_id:142025)（embedded [Runge-Kutta](@entry_id:140452)）**方法，例如经典的Dormand-Prince 5(4)对。

这类方法在一个时间步 $h$ 内同时计算出两个不同阶数的解：一个高阶解 $\boldsymbol{y}^{[p]}$（例如5阶）和一个低阶解 $\boldsymbol{y}^{[q]}$（例如4阶）。由于高阶解比低阶解更精确，它们的差值可以作为对低阶解的[局部截断误差](@entry_id:147703)的良好估计 [@problem_id:3464475]：

$$
\boldsymbol{e} \approx \boldsymbol{y}^{[p]} - \boldsymbol{y}^{[q]}
$$

接下来的关键是如何判断这个误差 $\boldsymbol{e}$ 是否“小”。在宇宙学中，[状态向量](@entry_id:154607) $\boldsymbol{y}$ 的不同分量（如[尺度因子](@entry_id:266678) $a$，密度 $\rho$，哈勃参数 $H$）的量级可能相差巨大，并且在演化过程中自身也会发生巨大变化。例如，在早期宇宙，$a$ 非常接近于零，而 $\rho$ 则极大。

一个鲁棒的[误差控制](@entry_id:169753)策略必须能够适应这种尺度差异，这通过一个混合的**[绝对和相对容差](@entry_id:163682)**判据来实现。对于向量的第 $i$ 个分量 $y_i$，我们要求其误差估计 $e_i$ 满足：

$$
|e_i| \le w_i
$$

其中 $w_i$ 是为该分量定义的容差权重。这个权重由绝对容差 $\mathrm{atol}_i$ 和相对容差 $\mathrm{rtol}_i$ 组合而成：

$$
w_i = \mathrm{atol}_i + \mathrm{rtol}_i \cdot \max\big(|y_{i, \text{old}}|, |y_{i, \text{new}}|\big)
$$

这里的 $y_{i, \text{old}}$ 和 $y_{i, \text{new}}$ 分别是步长开始和结束时该分量的值。这个公式的精妙之处在于：
-   当 $|y_i|$ 很大时（如早期的 $\rho$），$\mathrm{rtol}_i$ 项占主导，保证了误差是当前值的一个小分数（[相对误差](@entry_id:147538)控制）。
-   当 $|y_i|$ 接近于零时（如早期的 $a$），$\mathrm{atol}_i$ 项成为容差的下限，防止因分母过小而导致步长被无限压缩（[绝对误差](@entry_id:139354)控制）。

通过为每个分量设置合适的 $\mathrm{atol}_i$ 和 $\mathrm{rtol}_i$，这种方法可以对跨越多个[数量级](@entry_id:264888)的变量进行稳健和公平的精度控制 [@problem_id:3464475]。如果所有分量的缩放误差 $|e_i/w_i|$ 都不超过1，则该步长被接受；否则，将根据误差大小缩减步长并重试。

**[粒子模拟](@entry_id:144357)的精度控制**

在N-body和SPH（Smoothed Particle Hydrodynamics）等[粒子模拟](@entry_id:144357)方法中，精度控制通常基于运动学原理。一个常用的判据要求由加速度引起的位移必须小于粒子分辨率的一个小部分 [@problem_id:3464469]。

考虑一个粒子在时间步 $\Delta t$ 内的运动，其位置变化可以通过泰勒展开近似为 $\Delta x \approx v \Delta t + \frac{1}{2} a (\Delta t)^2$。其中二阶项 $\frac{1}{2} a (\Delta t)^2$ 代表了由加速度 $a$ 引起的轨迹弯曲。为精确解析此轨迹，我们要求这个弯曲位移远小于该粒子的有效分辨率尺度 $L_{\mathrm{res}}$。这可以表示为：

$$
|a| (\Delta t)^2 \le \eta^2 L_{\mathrm{res}}
$$

解出 $\Delta t$，我们得到基于加速度的精度约束：

$$
\Delta t \le \eta \sqrt{\dfrac{L_{\mathrm{res}}}{|a|}}
$$

这里的 $\eta$ 是一个小的无量纲安全因子。分辨率尺度 $L_{\mathrm{res}}$ 取决于粒子类型：
-   对于暗物质或恒[星等](@entry_id:161778)**无碰撞N-body粒子**，其[引力](@entry_id:175476)在**[引力软化](@entry_id:146273)长度**（gravitational softening length） $\epsilon$ 的尺度上被平滑，因此 $L_{\mathrm{res}} = \epsilon$。
-   对于**SPH气体粒子**，其[流体动力学相互作用](@entry_id:180292)由**SPH光滑长度**（SPH smoothing length） $h$ 决定，因此 $L_{\mathrm{res}} = h$。

### [多物理场模拟](@entry_id:145294)中的时间步长综合判据

真实的[宇宙学模拟](@entry_id:747928)是多物理、多尺度的。一个有效的时间[步长控制](@entry_id:755439)器必须能将来自不同物理过程、不同空间区域的所有约束融合成一个单一的、全局或局部的步长。

#### 综合多个物理过程

基本原则是：最终的时间步长必须满足**所有**适用的约束条件，即取所有独立时间步长上限中的**最小值**。

一个典型的例子是包含宇宙膨胀、[自引力](@entry_id:271015)、[辐射冷却](@entry_id:754014)和[化学反应](@entry_id:146973)的模拟。在这种情况下，每种过程都有其特征时标 [@problem_id:3464478]：
-   **哈勃时标** $t_H = H^{-1}$：[宇宙膨胀](@entry_id:161474)的时标。
-   **动力学时标** $\tau_{\mathrm{dyn}} \sim (G\rho)^{-1/2}$：[引力](@entry_id:175476)塌缩时标。
-   **冷却时标** $\tau_{\mathrm{cool}} \sim e/|\Lambda - \Gamma|$：气体热能 $e$ 因净冷却/加热率 $|\Lambda - \Gamma|$ 而显著变化的时标。
-   **复合时标** $\tau_{\mathrm{rec}} \sim 1/(\alpha_B n_e)$：在电子密度为 $n_e$、复合系数为 $\alpha_B$ 的情况下，自由电子数减少的特征时标。

为了保证对所有过程的稳定和精确积分，时间步长必须小于这些时标中最快的那一个：

$$
\Delta t \le C \min(t_H, \tau_{\mathrm{dyn}}, \tau_{\mathrm{cool}}, \tau_{\mathrm{rec}})
$$

其中 $C$ 是一个综合性的安全因子。这个“最短时标原则”是多物理[自适应时间步长](@entry_id:261403)控制的基石。

一个更具体的例子是自[引力流体动力学](@entry_id:750036)模拟 [@problem_id:3464520]。在这种情况下，每个网格单元或粒子都必须同时满足[流体动力学](@entry_id:136788)的CFL约束和[引力](@entry_id:175476)约束。因此，步长由下式决定：

$$
\Delta t \le \min(\Delta t_{\mathrm{CFL}}, \Delta t_{\mathrm{grav}}) = \min\left(C_{\mathrm{CFL}}\frac{a\Delta x}{|\boldsymbol{v}| + c_{s,\mathrm{phys}}}, \eta(G\rho)^{-1/2}\right)
$$

这个综合判据完美地揭示了自适应的本质。在密度极高的**过密区**（如星系和暗晕），$\rho$ 很大，导致 $\tau_{\mathrm{dyn}}$ 非常小，因此[引力](@entry_id:175476)约束通常占主导地位。而在密度很低的**宇宙空洞**中，$\rho$ 很小，$\tau_{\mathrm{dyn}}$ 极长，[引力](@entry_id:175476)演化缓慢；此时，即使流速和声速很低，有限的CFL时间步长通常也会成为更严格的限制。

对于SPH粒子，情况类似。它必须同时满足基于加速度的精度要求和基于[流体速度](@entry_id:267320)的CFL稳定性要求。因此，其时间步长由两者中的较小值决定 [@problem_id:3464469]：

$$
\Delta t_{\mathrm{SPH}} \le \eta \min\left(\sqrt{\frac{h}{|a|}}, \frac{h}{|\boldsymbol{v}|}\right)
$$

（一个完整的SPH CFL条件还应包含声速项，即 $\frac{h}{|\boldsymbol{v}|+c_s}$）。

### 高级主题与精细考量

#### [数值刚性](@entry_id:752836)问题

在分析多时标问题时，必须区分**刚性（stiffness）**和一般性的多尺度变异。一个系统被称为刚性的，当它包含至少一个快速衰减的模式，但我们感兴趣的解本身却在慢得多的时标上平滑演化时 [@problem_id:3464537]。

在这种情况下，显式积分格式的**稳定性**要求时间步长必须小到足以解析那个快速衰减的模式（其时标为 $\tau_{\text{fast}}$），即 $\Delta t \lesssim \tau_{\text{fast}}$。然而，由于该模式迅速衰减并且对慢变解的贡献可以忽略不计，从**精度**角度看，一个远大于 $\tau_{\text{fast}}$ 的时间步长本已足够。这种稳定性要求与精度要求的分离，就是[刚性问题](@entry_id:142143)的核心特征。它迫使显式方法为保证稳定性而付出不必要的计算代价。

宇宙学中的化学网络和冷却过程是典型的[刚性问题](@entry_id:142143)。例如，在[复合时期](@entry_id:159287)，$z \approx 1100$，氢的复合时标 $t_{\mathrm{rec}}$ 大约是 $9.4 \times 10^9$ 秒，而宇宙演化的哈勃时标 $t_H$ 约为 $3.3 \times 10^{12}$ 秒，两者相差超过300倍。同样，在 $z \approx 10$ 的早期星系中，金属线冷却时标 $t_{\mathrm{cool}}$ 可能比 $t_H$ 短数百万倍。在这些情况下，系统的化学或热状态会迅速弛豫到一个随[宇宙膨胀](@entry_id:161474)缓慢演化的准静态平衡。使用显式方法求解将受限于极短的微观时标，而使用**隐式积分格式**（implicit integrators）则可以摆脱这个稳定性限制，允许步长由精度要求决定，从而大大提高效率。

#### 积分变量的选择

对于宇宙学中的[常微分方程](@entry_id:147024)，我们不仅可以调整步长 $\Delta t$，还可以策略性地选择积分的**自变量**。常见的选择有宇宙时 $t$、共形时 $\eta$ (定义为 $d\eta = dt/a(t)$) 和[尺度因子](@entry_id:266678) $a$ 本身 [@problem_id:3464496]。

选择不同的自变量，会改变[微分方程](@entry_id:264184)的形式，从而影响其数值特性。
-   **宇宙时 $t$**：最自然的选择，但可能不是最优的。例如，对于在背景中[振荡](@entry_id:267781)的相对论性场，其物理频率 $\omega_{\mathrm{phys}} \approx k/a(t)$ 会随时间变化，给[步长控制](@entry_id:755439)带来困难。
-   **共形时 $\eta$**：对于无质量（或相对论性）粒子和场的演化，这是一个绝佳的选择。在[FRW度规](@entry_id:158831)下，光在随动坐标中的传播速度相对于 $\eta$ 是常数1。这导致一个关键的简化：一个[波数](@entry_id:172452)为 $k$ 的相对论性扰动模式，其[振荡](@entry_id:267781)方程在 $\eta$ 时间下的形式近似为 $\phi_k'' + k^2\phi_k \approx 0$。其振荡频率关于 $\eta$ 是一个常数 $k$！这使得基于相位的精度控制（如要求 $k\Delta\eta$ 为常数）变得极其简单和高效 [@problem_id:3464496] [@problem_id:3464496]。
-   **[尺度因子](@entry_id:266678) $a$**：当哈勃参数 $H(a)$ 作为 $a$ 的函数出现剧烈变化时（例如在[相变](@entry_id:147324)或暴胀结束时），选择 $a$ 作为[自变量](@entry_id:267118)可以有效缓解刚性。因为时间步长与 $a$ 的步长关系为 $dt = da/(aH)$，当 $H(a)$ 很大时，一个固定的 $\Delta a$ 会自动转化为一个更小的 $\Delta t$，从而自然地在 $H$ 变化剧烈的区域加密积分点 [@problem_id:3464496]。

#### 自适应网格细化中的[步长控制](@entry_id:755439)

**[自适应网格细化](@entry_id:143852)（Adaptive Mesh Refinement, [AMR](@entry_id:204220)）**技术通过在需要高分辨率的区域（如星系中心）动态地创建更精细的网格层级来提高效率。为了充分发挥AMR的优势，通常会采用**[子循环](@entry_id:755594)（subcycling）**的时间步进策略 [@problem_id:3464472]。

基本思想是，不同层级的网格可以使用不同的时间步长。由于CFL条件要求 $\Delta t \propto \Delta x$，一个细化了 $r$ 倍的层级（$\Delta x_{\ell} = \Delta x_{\ell-1}/r$）自然需要一个大约小 $r$ 倍的时间步长。在[子循环](@entry_id:755594)中，每个层级 $\ell$ 都以其自身满足局部CFL条件的步长 $\Delta t_\ell$ 演化，且满足 $\Delta t_{\ell-1} = r \cdot \Delta t_\ell$。这意味着，当粗层级 $\ell-1$ 走一步时，细层级 $\ell$ 必须精确地走 $r$ 步。

这种时间上的**同步（synchronization）**对于维持守恒至关重要。有限体积法的基础是通量守恒，即在一个时间区间内，离开一个单元的量必须等于进入相邻单元的量。在[AMR](@entry_id:204220)的粗细网格边界，粗网格一步内的总通量必须精确等于细网格 $r$ 个子步内的总通量之和。由于粗细网格在边界处计算的通量通常不一致，必须通过一个称为**通量修正（refluxing）**的过程来强制守恒。该过程累积粗细通量之间的差异，并在粗网格步长结束时将其“返还”给粗网格，从而保证在层级边界上没有物质、动量或能量被凭空创造或消灭。这个过程的正确性，完全依赖于粗网格的一大步和细网格的 $r$ 小步所覆盖的物理时间区间是完全相同的 [@problem_id:3464472] [@problem_id:3464519] [@problem_id:3464472]。

#### 自适应性与守恒律

[自适应时间步长](@entry_id:261403)虽然极大地提升了计算效率，但它也可能对系统的基本[守恒定律](@entry_id:269268)产生微妙而深刻的影响。在此，我们必须区分两种“守恒” [@problem_id:3464519]：
-   **强不变性（Strong Invariance）**：指离散算法的[代数结构](@entry_id:137052)保证某个量在任何满足稳定性的有限步长下都精确不变（达到机器精度）。这通常源于完美的对消，如[有限体积法](@entry_id:749372)中的通量求和。
-   **弱守恒（Weak Conservation）**：指一个量在离散更新中不被精确保持，但其不守恒的误差会随着步长 $\Delta t \to 0$ 而趋于零。也就是说，数值解收敛到一个真正守恒的连续解。

应用这些概念，我们可以审视[自适应步长](@entry_id:636271)对不同物理量的影响：
-   **质量和动量（[有限体积法](@entry_id:749372)）**：如前述，通过精心设计的[子循环](@entry_id:755594)和通量修正，[AMR](@entry_id:204220)中的[有限体积法](@entry_id:749372)可以维持总质量、动量和能量的**强[不变性](@entry_id:140168)**。自适应性本身不破坏其守恒结构 [@problem_id:3464519]。
-   **动量（N-body）**：在具有**个体化[自适应时间步长](@entry_id:261403)**的N-body模拟中，[动量守恒](@entry_id:149964)会从强不变性退化为**弱守恒**。动量守恒源于牛顿第三定律 $\boldsymbol{F}_{ij} = -\boldsymbol{F}_{ji}$ 的完美对称性。如果粒子 $i$ 和 $j$ 不在同一时刻更新它们的动量（因为它们处于不同的时间步长上），这种对称性就被打破，导致[总动量](@entry_id:173071)出现微小的净变化。
-   **能量（哈密顿系统）**：对于由时间无关的[哈密顿量](@entry_id:172864)描述的[引力](@entry_id:175476)系统，[蛙跳法](@entry_id:751210)（leapfrog）等**[辛积分](@entry_id:755737)格式（symplectic integrator）**具有卓越的长期能量保持特性，因为它们精确地保持一个“影子[哈密顿量](@entry_id:172864)”。然而，使用**[可变时间步长](@entry_id:756430)会破坏算法的辛性**，使其不再是[正则变换](@entry_id:178165)。结果是，影子[哈密顿量](@entry_id:172864)的强[不变性](@entry_id:140168)丢失，[能量守恒](@entry_id:140514)退化为**弱守恒**，通常表现为能量的[随机游走](@entry_id:142620)或缓慢漂移 [@problem_id:3464519]。值得注意的是，即使对于固定步长，在存在[宇宙膨胀](@entry_id:161474)这类显式含时项的系统中，物理能量本身就不是守恒量。
-   **熵（[熵不等式](@entry_id:184404)）**：在模拟包含激波的流体时，物理上要求熵在穿过激波时必须增加（[热力学第二定律](@entry_id:142732)）。[Godunov型格式](@entry_id:143309)通过其内在的[数值黏性](@entry_id:141318)，能够正确地产生熵并满足一个离散的**[熵不等式](@entry_id:184404)**。[自适应步长](@entry_id:636271)（只要满足CFL条件）会保持这种正确的物理行为，但它无法消除在光滑流动区域由[截断误差](@entry_id:140949)引起的微小[数值耗散](@entry_id:168584)。因此，在这些格式中，熵从来都不是一个强[不变量](@entry_id:148850)，而自适应性也并未改变这一本质 [@problem_id:3464519]。

总之，[自适应时间步长](@entry_id:261403)是[数值宇宙学](@entry_id:752779)中一把强大的双刃剑。它通过动态匹配物理过程的内在时标来实现惊人的计算加速，但设计和实现一个鲁棒、精确且尽可能保持物理守恒性的[自适应步长控制](@entry_id:142684)器，需要对数值分析和底层物理有深刻的理解。