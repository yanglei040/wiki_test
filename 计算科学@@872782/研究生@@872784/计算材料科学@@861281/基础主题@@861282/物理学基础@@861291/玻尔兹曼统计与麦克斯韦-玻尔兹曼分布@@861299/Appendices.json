{"hands_on_practices": [{"introduction": "在计算科学中，一个基本的要求是“信任但要验证”。本练习旨在培养这一关键技能，要求您设计一个计算测试，以验证分子动力学（MD）模拟是否正确地再现了处于热平衡状态的系统的统计特性。您将从第一性原理出发，推导速度分量和速率的理论分布[@problem_id:3435506]，并应用严格的拟合优度检验来评估模拟数据的有效性，这是确保模拟结果可靠性的核心步骤。", "problem": "您的任务是设计一个基于统计学原理的计算测试，用于验证一个在温度 $T$ 下的兰纳-琼斯流体的分子动力学 (MD) 模拟所产生的速度分量是否遵循玻尔兹曼统计预测的高斯分布，以及由此产生的速率分布是否与三维麦克斯韦-玻尔兹曼形式相匹配。您的程序必须完全自包含，并且无需任何用户输入或外部数据即可运行。它必须仅以经过充分检验的科学原理和定义为基础，实现以下要求。\n\n解决方案必须基于的基本原理：\n- 在固定温度 $T$ 下的正则系综意味着相空间概率密度与 $\\exp(-\\beta H)$ 成正比，其中 $\\beta = 1 / (k_B T)$，$H$ 是哈密顿量。\n- 质量为 $m$ 的非相对论性粒子的动能为 $E_{\\mathrm{kin}} = \\frac{1}{2} m (v_x^2 + v_y^2 + v_z^2)$。\n- 平衡态下空间各向同性意味着速度向量的分布仅依赖于其大小。\n- 玻尔兹曼常数为 $k_B$；使用 $k_B = 1.380649 \\times 10^{-23}$ $\\mathrm{J/K}$。\n- 预期的统计行为源于这些定义和各向同性，但您不能假设任何简化公式。\n\n需要实现的验证任务：\n- 根据正则系综和各向同性，推导在温度 $T$ 下，质量为 $m$ 的一个笛卡尔速度分量 $v_x$ 的理论累积分布函数（CDF），并用它来测试 $v_x$ 的样本是否与给定 $T$ 和 $m$ 下相应的高斯分布一致。\n- 推导在温度 $T$ 下，质量为 $m$ 的速率 $s = \\sqrt{v_x^2 + v_y^2 + v_z^2}$ 的理论CDF，并用它来测试速率样本是否与产生的三维速率分布一致。\n- 使用一个基于统计学原理的拟合优度程序，将样本与一个完全指定的理论CDF进行比较。使用单样本拟合优度检验，该检验基于您推导的精确CDF产生一个 $p$ 值，并为每个检验选择一个显著性水平 $\\alpha = 10^{-4}$。\n- 除了对一维分量的拟合优度检验外，还需包括一个检验，即每个笛卡尔速度分量的样本均值与零是否一致。此检验使用由理论方差推导出的标准误和一个双边 $z$ 分数阈值 $|z| \\le 4.0$。\n- 声明MD样本通过测试的条件是，当且仅当所有三个分量检验同时通过，并且速率检验也通过，且都在指定的 $\\alpha$ 和 $z$ 分数阈值内。\n\n为内部测试套件生成数据：\n- 因为程序必须是独立且可复现的，您必须通过在三个笛卡尔方向上进行独立抽样来生成合成的“假定MD”速度数据。对于给定的模拟质量 $m$、一个“模拟温度”$T_{\\mathrm{sim}}$、一个理论温度 $T_{\\mathrm{theory}}$（测试用于评估数据的数值），一个漂移向量 $(\\mu_x, \\mu_y, \\mu_z)$（单位为 $\\mathrm{m/s}$），以及各向异性尺度因子 $(a_x, a_y, a_z)$，按如下方式生成 $N$ 个样本：\n  - 对于每个分量 $i \\in \\{x,y,z\\}$，从一个均值为 $\\mu_i$、标准差为 $\\sigma_i = a_i \\sqrt{k_B T_{\\mathrm{sim}} / m}$ 的正态分布中独立抽取 $v_i$。\n  - 统计检验必须对照在 $T_{\\mathrm{theory}}$ 和 $m$ 下的理论模型进行评估。\n- 所有速度必须以 $\\mathrm{m/s}$ 表示，所有温度以 $\\mathrm{K}$ 表示，质量以 $\\mathrm{kg}$ 表示。\n\n您的程序必须实现以下参数集的测试套件，每个参数集生成一个独立的合成数据集。对于每种情况，程序必须输出一个布尔值，指示数据是否通过所有验证任务。参数是元组 $(N, m, T_{\\mathrm{theory}}, T_{\\mathrm{sim}}, \\mu_x, \\mu_y, \\mu_z, a_x, a_y, a_z, \\mathrm{seed})$，单位如下：\n- 案例1（正常路径，各向同性，正确温度）：$(N = 20000, m = 6.63 \\times 10^{-26}\\ \\mathrm{kg}, T_{\\mathrm{theory}} = 120\\ \\mathrm{K}, T_{\\mathrm{sim}} = 120\\ \\mathrm{K}, \\mu_x = 0\\ \\mathrm{m/s}, \\mu_y = 0\\ \\mathrm{m/s}, \\mu_z = 0\\ \\mathrm{m/s}, a_x = 1, a_y = 1, a_z = 1, \\mathrm{seed} = 12345)$。\n- 案例2（温度不匹配）：$(N = 15000, m = 6.63 \\times 10^{-26}\\ \\mathrm{kg}, T_{\\mathrm{theory}} = 120\\ \\mathrm{K}, T_{\\mathrm{sim}} = 150\\ \\mathrm{K}, \\mu_x = 0\\ \\mathrm{m/s}, \\mu_y = 0\\ \\mathrm{m/s}, \\mu_z = 0\\ \\mathrm{m/s}, a_x = 1, a_y = 1, a_z = 1, \\mathrm{seed} = 2024)$。\n- 案例3（单向非零漂移）：$(N = 15000, m = 6.63 \\times 10^{-26}\\ \\mathrm{kg}, T_{\\mathrm{theory}} = 120\\ \\mathrm{K}, T_{\\mathrm{sim}} = 120\\ \\mathrm{K}, \\mu_x = 40\\ \\mathrm{m/s}, \\mu_y = 0\\ \\mathrm{m/s}, \\mu_z = 0\\ \\mathrm{m/s}, a_x = 1, a_y = 1, a_z = 1, \\mathrm{seed} = 777)$。\n- 案例4（单向各向异性）：$(N = 15000, m = 6.63 \\times 10^{-26}\\ \\mathrm{kg}, T_{\\mathrm{theory}} = 120\\ \\mathrm{K}, T_{\\mathrm{sim}} = 120\\ \\mathrm{K}, \\mu_x = 0\\ \\mathrm{m/s}, \\mu_y = 0\\ \\mathrm{m/s}, \\mu_z = 0\\ \\mathrm{m/s}, a_x = 1, a_y = 1, a_z = 1.5, \\mathrm{seed} = 314159)$。\n- 案例5（高温，正确模型，中等样本量）：$(N = 5000, m = 6.63 \\times 10^{-26}\\ \\mathrm{kg}, T_{\\mathrm{theory}} = 3000\\ \\mathrm{K}, T_{\\mathrm{sim}} = 3000\\ \\mathrm{K}, \\mu_x = 0\\ \\mathrm{m/s}, \\mu_y = 0\\ \\mathrm{m/s}, \\mu_z = 0\\ \\mathrm{m/s}, a_x = 1, a_y = 1, a_z = 1, \\mathrm{seed} = 424242)$。\n\n每个案例的接受标准：\n- 对于三个分量中的每一个，计算样本均值相对于在 $T_{\\mathrm{theory}}$ 和 $m$ 下的理论标准差的双边 $z$ 分数，并要求 $|z| \\le 4.0$。\n- 对每个分量，以显著性水平 $\\alpha = 10^{-4}$，针对在给定 $T_{\\mathrm{theory}}$ 和 $m$ 下推导出的高斯CDF执行单样本拟合优度检验，并独立地对速率样本，以相同的 $\\alpha$ 值，针对在相同 $T_{\\mathrm{theory}}$ 和 $m$ 下推导出的三维速率CDF执行单样本拟合优度检验。所有四个检验都必须得出 $p \\ge \\alpha$。\n- 当且仅当所有这些条件同时满足时，该案例才算通过。\n\n最终输出格式：\n- 您的程序应生成一行输出，其中包含五个案例的通过/失败结果，格式为一个不含空格的Python风格布尔值列表，例如 $[True,False,True,True,False]$。\n\n角度单位不适用。所有物理单位如上所述，所有速度必须以 $\\mathrm{m/s}$ 处理。不要进行任何四舍五入；布尔值是精确的。", "solution": "目标是构建一个计算程序，用于验证在指定温度 $T$ 下模拟的流体分子动力学（MD）速度数据是否符合经典统计力学（特别是玻尔兹曼统计）的预测。验证过程通过从第一性原理推导速度分量和粒子速率的理论概率分布，然后将这些分布用于严格的统计检验。\n\n首先，我们建立理论基础。在正则系综中，对于一个处于固定温度 $T$ 的系统，观察到能量为 $E$ 的微观状态的概率与玻尔兹曼因子 $\\exp(-\\beta E)$ 成正比，其中 $\\beta = 1/(k_B T)$，$k_B$ 是玻尔兹曼常数。对于一个无相互作用粒子的系统，或者当只考虑哈密顿量的动能部分时，一个质量为 $m$、速度向量为 $\\mathbf{v} = (v_x, v_y, v_z)$ 的单个粒子的能量是其动能 $E_{\\mathrm{kin}} = \\frac{1}{2} m (v_x^2 + v_y^2 + v_z^2)$。\n\n因此，速度向量 $\\mathbf{v}$ 的概率密度函数（PDF）由下式给出：\n$$P(v_x, v_y, v_z) \\propto \\exp\\left(-\\beta E_{\\mathrm{kin}}\\right) = \\exp\\left(-\\frac{\\beta m}{2} (v_x^2 + v_y^2 + v_z^2)\\right)$$\n这个表达式可以分解为三个独立的项：\n$$P(v_x, v_y, v_z) \\propto \\exp\\left(-\\frac{\\beta m v_x^2}{2}\\right) \\exp\\left(-\\frac{\\beta m v_y^2}{2}\\right) \\exp\\left(-\\frac{\\beta m v_z^2}{2}\\right)$$\n这种因式分解意味着速度分量 $v_x$、$v_y$ 和 $v_z$ 是统计独立的随机变量。问题中各向同性的假设意味着每个分量的分布都是相同的。因此，我们可以分析单个分量，比如 $v_x$。其PDF为：\n$$P(v_x) = C \\exp\\left(-\\frac{\\beta m v_x^2}{2}\\right)$$\n其中 $C$ 是一个归一化常数。这是一个均值为0的高斯（正态）分布形式。为了找到方差 $\\sigma^2$，我们对PDF进行归一化：$\\int_{-\\infty}^{\\infty} P(v_x) dv_x = 1$。使用标准高斯积分 $\\int_{-\\infty}^{\\infty} e^{-ax^2} dx = \\sqrt{\\pi/a}$，其中 $a = \\beta m / 2$，我们求得 $C = \\sqrt{\\beta m / (2\\pi)}$。PDF为：\n$$P(v_x) = \\sqrt{\\frac{m}{2\\pi k_B T}} \\exp\\left(-\\frac{m v_x^2}{2 k_B T}\\right)$$\n通过将其与零均值高斯PDF的标准形式 $P(x) = (1/(\\sigma \\sqrt{2\\pi})) \\exp(-x^2/(2\\sigma^2))$ 进行比较，我们确定理论方差为 $\\sigma^2_{\\mathrm{theory}} = k_B T / m$。\n\n对于拟合优度检验，我们需要累积分布函数（CDF），$F(v_x) = \\int_{-\\infty}^{v_x} P(u) du$。这个积分与误差函数 $\\mathrm{erf}(z) = (2/\\sqrt{\\pi}) \\int_0^z e^{-t^2} dt$ 有关。由此得到的速度分量的CDF为：\n$$F(v_x) = \\frac{1}{2} \\left[1 + \\mathrm{erf}\\left(v_x \\sqrt{\\frac{m}{2 k_B T}}\\right)\\right]$$\n这完全指定了用于检验 $v_x$ 值样本的理论分布。\n\n接下来，我们推导粒子速率 $s = |\\mathbf{v}| = \\sqrt{v_x^2 + v_y^2 + v_z^2}$ 的分布。由于各向同性，在速度空间中切换到球坐标是方便的。体积元 $dv_x dv_y dv_z$ 变为 $4\\pi s^2 ds$。找到一个速率在 $s$ 和 $s+ds$ 之间的粒子的概率，是对联合PDF在相应球壳上积分得到的：\n$$P(s)ds = 4\\pi s^2 P(v_x, v_y, v_z)|_{|\\mathbf{v}|=s} ds = 4\\pi s^2 \\left(\\frac{m}{2\\pi k_B T}\\right)^{3/2} \\exp\\left(-\\frac{m s^2}{2 k_B T}\\right) ds$$\n这就是麦克斯韦-玻尔兹曼速率分布。对应的速率CDF，$F(s) = \\int_0^s P(u)du$ (对于 $s \\ge 0$)，是通过对该表达式进行积分得到的。结果是：\n$$F(s) = \\mathrm{erf}\\left(s\\sqrt{\\frac{m}{2 k_B T}}\\right) - \\sqrt{\\frac{2m}{\\pi k_B T}} s \\exp\\left(-\\frac{m s^2}{2 k_B T}\\right)$$\n这个CDF将用于检验速率样本。\n\n计算程序基于这些推导实现了两个统计检查。\n1.  **均值验证**：对于每个笛卡尔分量 $v_i$，我们检验其样本均值 $\\bar{v}_i$ 是否与理论均值0一致。计算一个 $z$ 分数 $z_i = \\bar{v}_i / SE_i$，其中 $SE_i$ 是均值的标准误。它由 $SE_i = \\sigma_{\\mathrm{theory}} / \\sqrt{N}$ 给出，其中 $\\sigma_{\\mathrm{theory}} = \\sqrt{k_B T_{\\mathrm{theory}} / m}$，$N$ 是样本大小。如果所有三个分量的 $|z_i| \\le 4.0$，则MD样本通过此检验，这对应一个非常严格的置信水平。\n\n2.  **分布验证**：我们使用单样本柯尔莫哥洛夫-斯米尔诺夫（K-S）检验来比较样本数据的经验分布与上面推导的理论CDF。该检验计算经验CDF和理论CDF之间的最大绝对差。这个差值用于计算一个 $p$ 值。如果 $p$ 值大于或等于指定的显著性水平 $\\alpha = 10^{-4}$，则样本通过此检验。此检验对三个速度分量和速率分别独立进行。\n\n一个给定的合成MD数据集被认为通过整体验证，当且仅当所有七个条件同时满足：三个均值的 $z$ 分数检验和四个K-S检验（三个用于分量，一个用于速率）都必须在其指定的阈值下通过。\n\n该实现根据问题规范生成合成速度数据，使用一个模拟温度 $T_{\\mathrm{sim}}$、漂移 $\\boldsymbol{\\mu}$ 和各向异性因子 $\\mathbf{a}$，而统计检验是针对温度为 $T_{\\mathrm{theory}}$ 的理论模型进行的。这种设置允许测试验证程序在面对偏离理想平衡的常见情况（例如温度不正确、系统整体运动或各向异性的动能分布）时的稳健性。", "answer": "```python\nimport numpy as np\nfrom scipy import special, stats\n\ndef solve():\n    \"\"\"\n    Performs a statistically principled validation of synthetic MD velocity data.\n    \"\"\"\n    k_B = 1.380649e-23  # Boltzmann constant in J/K\n\n    test_cases = [\n        # Case 1: Happy path, isotropic, correct temperature\n        (20000, 6.63e-26, 120.0, 120.0, 0.0, 0.0, 0.0, 1.0, 1.0, 1.0, 12345),\n        # Case 2: Mismatched temperature\n        (15000, 6.63e-26, 120.0, 150.0, 0.0, 0.0, 0.0, 1.0, 1.0, 1.0, 2024),\n        # Case 3: Nonzero drift in one direction\n        (15000, 6.63e-26, 120.0, 120.0, 40.0, 0.0, 0.0, 1.0, 1.0, 1.0, 777),\n        # Case 4: Anisotropy in one direction\n        (15000, 6.63e-26, 120.0, 120.0, 0.0, 0.0, 0.0, 1.0, 1.0, 1.5, 314159),\n        # Case 5: High temperature, correct model, moderate sample size\n        (5000, 6.63e-26, 3000.0, 3000.0, 0.0, 0.0, 0.0, 1.0, 1.0, 1.0, 424242),\n    ]\n\n    def cdf_vx(v, T, m):\n        \"\"\"\n        Theoretical CDF for a Cartesian velocity component.\n        \"\"\"\n        arg = v * np.sqrt(m / (2 * k_B * T))\n        return 0.5 * (1.0 + special.erf(arg))\n\n    def cdf_s(s, T, m):\n        \"\"\"\n        Theoretical CDF for the 3D speed (Maxwell-Boltzmann).\n        \"\"\"\n        # CDF is 0 for s  0\n        s_safe = np.maximum(s, 0)\n        \n        a = m / (2 * k_B * T)\n        sqrt_a = np.sqrt(a)\n        \n        term1 = special.erf(s_safe * sqrt_a)\n        term2 = np.sqrt(4 * a / np.pi) * s_safe * np.exp(-a * s_safe**2)\n        \n        return term1 - term2\n\n    results = []\n    alpha = 1e-4\n    z_threshold = 4.0\n\n    for case in test_cases:\n        N, m, T_theory, T_sim, mu_x, mu_y, mu_z, a_x, a_y, a_z, seed = case\n        \n        rng = np.random.default_rng(seed)\n\n        # Generate synthetic data\n        sigma_sim_base = np.sqrt(k_B * T_sim / m)\n        v_x = rng.normal(loc=mu_x, scale=a_x * sigma_sim_base, size=N)\n        v_y = rng.normal(loc=mu_y, scale=a_y * sigma_sim_base, size=N)\n        v_z = rng.normal(loc=mu_z, scale=a_z * sigma_sim_base, size=N)\n        speeds = np.sqrt(v_x**2 + v_y**2 + v_z**2)\n        \n        # --- Run Verification Tests ---\n        \n        all_checks_passed = True\n        \n        # 1. Mean verification (z-score tests)\n        sigma_theory = np.sqrt(k_B * T_theory / m)\n        std_err = sigma_theory / np.sqrt(N)\n        \n        if std_err == 0:  # Avoid division by zero\n            all_checks_passed = False\n        else:\n            for v_comp in [v_x, v_y, v_z]:\n                mean_v = np.mean(v_comp)\n                z_score = mean_v / std_err\n                if abs(z_score) > z_threshold:\n                    all_checks_passed = False\n                    break\n        \n        if not all_checks_passed:\n            results.append(False)\n            continue\n            \n        # 2. Distribution verification (K-S tests)\n        # Components\n        for v_comp in [v_x, v_y, v_z]:\n            ks_result = stats.kstest(v_comp, lambda v: cdf_vx(v, T_theory, m))\n            if ks_result.pvalue  alpha:\n                all_checks_passed = False\n                break\n        \n        if not all_checks_passed:\n            results.append(False)\n            continue\n        \n        # Speed\n        ks_result_speed = stats.kstest(speeds, lambda s: cdf_s(s, T_theory, m))\n        if ks_result_speed.pvalue  alpha:\n            all_checks_passed = False\n\n        results.append(all_checks_passed)\n        \n    # Format and print the final output\n    print(f\"[{','.join(map(str, results))}]\".replace(\" \", \"\"))\n\nsolve()\n```", "id": "3435506"}, {"introduction": "一旦我们能够验证模拟数据的统计正确性，下一步就是利用这些数据来提取宏观物理量。本练习将引导您使用最大似然估计（MLE）这一强大的统计工具，从粒子速率的分布中精确推断系统的温度。通过这个实践[@problem_id:3435467]，您不仅将把麦克斯韦-玻尔兹曼分布的理论形式应用于实际数据分析，还将学会如何使用费雪信息来量化估计的不确定性。", "problem": "给定一个从单原子、无相互作用气体的分子动力学（MD）轨迹中提取的粒子速率直方图。假设瞬时粒子速率在三维空间中是独立同分布的，遵循麦克斯韦-玻尔兹曼（MB）速率分布，在绝对温度 $T$ 下，速率 $v \\ge 0$ 的概率密度函数为\n$$\nf(v \\mid T) = 4\\pi \\left(\\frac{m}{2\\pi k_B T}\\right)^{3/2} v^2 \\exp\\!\\left(-\\frac{m v^2}{2 k_B T}\\right).\n$$\n其中，$m$ 是粒子质量，$k_B$ 是玻尔兹曼常数。\n\n使用的基本原理：\n- 单原子理想气体的三维麦克斯韦-玻尔兹曼速率分布的定义。\n- 独立样本的似然函数定义以及最大似然估计原理。\n- 参数族分布的费雪信息及其在通过克拉默-拉奥下界进行不确定度传播中的应用。\n\n你的任务是，从第一性原理出发，使用上述分布和分箱的速率直方图，推导出绝对温度 $T$ 的最大似然估计量（MLE）。对分箱数据使用中点近似法：如果一个直方图的箱体中点为 $\\{v_j\\}$（单位：m/s），整数计数为 $\\{c_j\\}$，则将其视为代表了 $c_j$ 个值等于 $v_j$ 的独立样本。利用此近似法，推导出 $T$ 的最大似然估计量，并为 $T$ 的估计量推导出基于费雪信息的近似标准不确定度的解析表达式。\n\n然后，实现一个程序来计算每个测试用例的最大似然估计值 $\\hat{T}$ 及其基于费雪信息的标准不确定度 $\\sigma_{\\hat{T}}$。数值输出必须以开尔文（K）为单位，并四舍五入到三位小数。\n\n重要细节和要求：\n- 使用提供的粒子质量 $m$（单位：千克）、玻尔兹曼常数 $k_B$（单位：焦耳/开尔文）、直方图箱体中点 $\\{v_j\\}$（单位：m/s）和计数 $\\{c_j\\}$（无量纲）。\n- 假设中点近似法有效，因为相对于分布的尺度，箱体足够窄。\n- 最终的温度和不确定度以开尔文（K）表示，并四舍五入到三位小数。\n- 角度单位不适用。\n- 不要使用百分号；任何小数部分必须以十进制形式表示。\n\n测试套件：\n为以下四个测试用例提供结果。对于每个用例，给定 $m$、$k_B$、箱体中点列表（m/s）和整数箱体计数列表：\n1) 正常路径，中等大小样本：\n- $m = 6.6335209\\times 10^{-26}$ kg\n- $k_B = 1.380649\\times 10^{-23}$ J/K\n- 中点 (m/s): $[100, 200, 300, 400, 500, 600, 700]$\n- 计数: $[20, 80, 200, 400, 220, 70, 10]$\n2) 单个非空箱体的低样本量边缘情况：\n- $m = 6.6335209\\times 10^{-26}$ kg\n- $k_B = 1.380649\\times 10^{-23}$ J/K\n- 中点 (m/s): $[790]$\n- 计数: $[5]$\n3) 包含零计数箱体的稀疏直方图：\n- $m = 6.6335209\\times 10^{-26}$ kg\n- $k_B = 1.380649\\times 10^{-23}$ J/K\n- 中点 (m/s): $[50, 150, 250, 350, 450, 550]$\n- 计数: $[0, 0, 10, 30, 10, 0]$\n4) 不同种类（不同质量）但直方图与用例1相同：\n- $m = 3.350917\\times 10^{-26}$ kg\n- $k_B = 1.380649\\times 10^{-23}$ J/K\n- 中点 (m/s): $[100, 200, 300, 400, 500, 600, 700]$\n- 计数: $[20, 80, 200, 400, 220, 70, 10]$\n\n输出规范：\n- 对每个测试用例，计算以开尔文为单位的配对 $[\\hat{T}, \\sigma_{\\hat{T}}]$。\n- 将 $\\hat{T}$ 和 $\\sigma_{\\hat{T}}$ 均四舍五入到三位小数。\n- 你的程序应生成单行输出，包含这些配对的逗号分隔列表，并用方括号括起来。例如，输出必须如下所示：\n\"[[T1,SE1],[T2,SE2],[T3,SE3],[T4,SE4]]\"\n其中每个 $T_i$ 和 $SE_i$ 都是以开尔文表示并四舍五入到三位小数的浮点数。", "solution": "首先对问题陈述进行严格的验证过程。\n\n**步骤 1：提取已知条件**\n- 在绝对温度 $T$ 下，粒子速率 $v \\ge 0$ 的概率密度函数（PDF）是麦克斯韦-玻尔兹曼（MB）速率分布：\n$$ f(v \\mid T) = 4\\pi \\left(\\frac{m}{2\\pi k_B T}\\right)^{3/2} v^2 \\exp\\!\\left(-\\frac{m v^2}{2 k_B T}\\right) $$\n- $m$ 是粒子质量，单位为千克（$kg$）。\n- $k_B$ 是玻尔兹曼常数，单位为焦耳/开尔文（$J/K$）。\n- 数据以直方图形式提供，包含箱体中点 $\\{v_j\\}$（单位：米/秒, $m/s$）和整数计数 $\\{c_j\\}$（无量纲）。\n- 需使用中点近似法：将数据视为对于每个箱体 $j$，有 $c_j$ 个速率为 $v_j$ 的独立样本。\n- 使用的基本原理：MB速率分布的定义、最大似然估计（MLE）原理，以及使用费雪信息通过克拉默-拉奥下界进行不确定度分析。\n- 任务是推导出 $T$ 的最大似然估计量（记为 $\\hat{T}$）及其基于费雪信息的近似标准不确定度 $\\sigma_{\\hat{T}}$ 的解析表达式。必须实现一个程序来为四个指定的测试用例计算 $[\\hat{T}, \\sigma_{\\hat{T}}]$。\n- 输出格式：单行输出，包含一个 $[\\hat{T}, \\sigma_{\\hat{T}}]$ 配对的列表，两个值都以开尔文（K）为单位并四舍五入到三位小数。\n\n**步骤 2：使用提取的已知条件进行验证**\n- **科学基础（关键）**：该问题构建于统计力学（麦克斯韦-玻尔兹曼分布）和数理统计（最大似然估计、费雪信息）的基本、既定原则之上。其应用背景——分析分子动力学数据——是计算材料科学中的一个标准且现实的任务。该问题在科学上是合理的。\n- **适定性**：该问题有明确的目标。它提供了计算唯一解所需的所有数据和常数（$m$、$k_B$、$\\{v_j\\}$、$\\{c_j\\}$）。使用中点近似法的明确指令消除了处理分箱数据时的模糊性。该问题是适定的。\n- **客观性（关键）**：该问题完全以精确、定量和无偏见的语言表述。没有主观或基于观点的陈述。\n- **完备性与一致性**：该问题是自洽的，没有矛盾的约束。所提供的信息足以进行所需的推导和计算。\n\n**步骤 3：结论与行动**\n该问题被判定为**有效**。它满足了一个可解科学问题的所有标准。我现在将进行推导和求解。\n\n**最大似然估计量（$\\hat{T}$）的推导**\n\n推导从给定的麦克斯韦-玻尔兹曼 PDF 开始：\n$$ f(v \\mid T) = 4\\pi \\left(\\frac{m}{2\\pi k_B T}\\right)^{3/2} v^2 \\exp\\!\\left(-\\frac{m v^2}{2 k_B T}\\right) $$\n根据问题陈述，由箱体中点 $\\{v_j\\}$ 和计数 $\\{c_j\\}$ 组成的直方图数据被视为一组独立观测值，其中每个速率 $v_j$ 被观测到 $c_j$ 次。\n\n似然函数 $L(T)$ 表示在给定温度 $T$ 下该数据集的联合概率。假设独立性，它是各个概率的乘积：\n$$ L(T) = \\prod_{j} \\left[ f(v_j \\mid T) \\right]^{c_j} $$\n为便于分析，我们使用对数似然函数 $\\mathcal{L}(T) = \\ln L(T)$。最大化 $\\mathcal{L}(T)$ 等价于最大化 $L(T)$。\n$$ \\mathcal{L}(T) = \\ln \\left( \\prod_{j} \\left[ f(v_j \\mid T) \\right]^{c_j} \\right) = \\sum_j c_j \\ln f(v_j \\mid T) $$\n我们首先求出 PDF 的对数 $\\ln f(v \\mid T)$：\n$$ \\ln f(v \\mid T) = \\ln\\left(4\\pi\\right) + \\frac{3}{2}\\ln\\left(\\frac{m}{2\\pi k_B}\\right) - \\frac{3}{2}\\ln T + 2\\ln v - \\frac{m v^2}{2 k_B T} $$\n对数似然函数通过对所有观测值求和此表达式得到：\n$$ \\mathcal{L}(T) = \\sum_j c_j \\left[ \\left( \\ln(4\\pi) + \\frac{3}{2}\\ln\\left(\\frac{m}{2\\pi k_B}\\right) + 2\\ln v_j \\right) - \\frac{3}{2}\\ln T - \\frac{m v_j^2}{2 k_B T} \\right] $$\n我们可以分离出相对于 $T$ 是常数的项。设 $N = \\sum_j c_j$ 为粒子总数，$S = \\sum_j c_j v_j^2$ 为速率平方的加权和。\n$$ \\mathcal{L}(T) = \\text{Constant} - \\left(\\sum_j c_j\\right) \\frac{3}{2}\\ln T - \\frac{m}{2 k_B T} \\left(\\sum_j c_j v_j^2\\right) $$\n$$ \\mathcal{L}(T) = \\text{Constant} - \\frac{3N}{2}\\ln T - \\frac{mS}{2 k_B T} $$\n为了找到最大似然估计量 $\\hat{T}$，我们将 $\\mathcal{L}(T)$ 对 $T$ 求导并令其为零：\n$$ \\frac{d\\mathcal{L}}{dT} = 0 \\implies -\\frac{3N}{2T} + \\frac{mS}{2 k_B T^2} = 0 $$\n假设 $T \\neq 0$，我们乘以 $2k_B T^2$ 并重新整理：\n$$ -3 N k_B T + m S = 0 $$\n解出 $T$ 得到最大似然估计量：\n$$ \\hat{T} = \\frac{mS}{3 N k_B} = \\frac{m \\sum_j c_j v_j^2}{3 k_B \\sum_j c_j} $$\n这个结果与能量均分定理一致，该定理指出三维空间中单原子粒子的平均动能为 $\\langle E_k \\rangle = \\frac{3}{2}k_B T$。样本平均动能为 $\\frac{1}{2N}\\sum_j c_j m v_j^2 = \\frac{mS}{2N}$。令二者相等，可以得到与 $\\hat{T}$ 相同的表达式。\n\n**标准不确定度（$\\sigma_{\\hat{T}}$）的推导**\n\nMLE 的标准不确定度 $\\sigma_{\\hat{T}}$ 使用克拉默-拉奥下界进行近似。对于大的 $N$，无偏估计量的方差可以通过费雪信息的倒数很好地近似。我们将使用观测费雪信息 $J(\\hat{T})$，其定义为在 MLE 处（即 $T = \\hat{T}$）求值的对数似然函数二阶导数的负数。\n$$ J(T) = -\\frac{d^2\\mathcal{L}}{dT^2} \\quad \\text{and} \\quad \\sigma_{\\hat{T}} \\approx \\sqrt{J(\\hat{T})^{-1}} $$\n我们首先从其一阶导数计算 $\\mathcal{L}(T)$ 的二阶导数：\n$$ \\frac{d\\mathcal{L}}{dT} = -\\frac{3N}{2}T^{-1} + \\frac{mS}{2 k_B}T^{-2} $$\n$$ \\frac{d^2\\mathcal{L}}{dT^2} = \\frac{d}{dT}\\left(-\\frac{3N}{2}T^{-1} + \\frac{mS}{2 k_B}T^{-2}\\right) = \\frac{3N}{2}T^{-2} - \\frac{2mS}{2 k_B}T^{-3} = \\frac{3N}{2T^2} - \\frac{mS}{k_B T^3} $$\n观测费雪信息为：\n$$ J(T) = -\\left(\\frac{3N}{2T^2} - \\frac{mS}{k_B T^3}\\right) = \\frac{mS}{k_B T^3} - \\frac{3N}{2T^2} $$\n我们在 $T = \\hat{T}$ 处对此进行求值。使用为 MLE 推导出的关系式 $mS = 3Nk_B\\hat{T}$ 可以简化表达式：\n$$ J(\\hat{T}) = \\frac{3Nk_B\\hat{T}}{k_B \\hat{T}^3} - \\frac{3N}{2\\hat{T}^2} = \\frac{3N}{\\hat{T}^2} - \\frac{3N}{2\\hat{T}^2} = \\frac{3N}{2\\hat{T}^2} $$\n因此，估计量的方差近似为：\n$$ \\text{Var}(\\hat{T}) \\approx J(\\hat{T})^{-1} = \\frac{2\\hat{T}^2}{3N} $$\n标准不确定度 $\\sigma_{\\hat{T}}$ 是方差的平方根：\n$$ \\sigma_{\\hat{T}} = \\sqrt{\\frac{2\\hat{T}^2}{3N}} = \\hat{T} \\sqrt{\\frac{2}{3N}} $$\n其中 $N = \\sum_j c_j$ 是观测到的粒子总数。\n\n**计算算法**\n程序将按如下方式为每个测试用例实现推导出的公式：\n1. 计算总计数 $N = \\sum_j c_j$。\n2. 计算速率平方的加权和 $S = \\sum_j c_j v_j^2$。\n3. 计算温度估计值 $\\hat{T} = \\frac{mS}{3Nk_B}$。\n4. 计算标准不确定度 $\\sigma_{\\hat{T}} = \\hat{T} \\sqrt{\\frac{2}{3N}}$。\n5. 将两个值都四舍五入到三位小数，并按规定格式化输出。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Derives and computes the Maximum Likelihood Estimator (MLE) for temperature\n    and its standard uncertainty from binned particle speed data.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: Happy-path, moderately large sample\n        {\n            \"m\": 6.6335209e-26, # kg\n            \"k_B\": 1.380649e-23, # J/K\n            \"midpoints\": np.array([100, 200, 300, 400, 500, 600, 700], dtype=float), # m/s\n            \"counts\": np.array([20, 80, 200, 400, 220, 70, 10], dtype=float), # dimensionless\n        },\n        # Case 2: Low-sample edge case with a single occupied bin\n        {\n            \"m\": 6.6335209e-26,\n            \"k_B\": 1.380649e-23,\n            \"midpoints\": np.array([790], dtype=float),\n            \"counts\": np.array([5], dtype=float),\n        },\n        # Case 3: Sparse histogram with zero-count bins\n        {\n            \"m\": 6.6335209e-26,\n            \"k_B\": 1.380649e-23,\n            \"midpoints\": np.array([50, 150, 250, 350, 450, 550], dtype=float),\n            \"counts\": np.array([0, 0, 10, 30, 10, 0], dtype=float),\n        },\n        # Case 4: Different species (different mass) with the same histogram as case 1\n        {\n            \"m\": 3.350917e-26,\n            \"k_B\": 1.380649e-23,\n            \"midpoints\": np.array([100, 200, 300, 400, 500, 600, 700], dtype=float),\n            \"counts\": np.array([20, 80, 200, 400, 220, 70, 10], dtype=float),\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        m = case[\"m\"]\n        k_B = case[\"k_B\"]\n        vj = case[\"midpoints\"]\n        cj = case[\"counts\"]\n\n        # Step 1: Compute the total number of particles, N.\n        # N = sum(c_j)\n        N = np.sum(cj)\n        \n        # Guard against division by zero if all counts are zero.\n        if N == 0:\n            T_hat = np.nan\n            sigma_T_hat = np.nan\n        else:\n            # Step 2: Compute the sum of squared speeds weighted by counts, S.\n            # S = sum(c_j * v_j^2)\n            S = np.sum(cj * vj**2)\n\n            # Step 3: Calculate the estimated temperature T_hat using the MLE formula.\n            # T_hat = (m * S) / (3 * N * k_B)\n            T_hat = (m * S) / (3.0 * N * k_B)\n\n            # Step 4: Calculate the standard uncertainty sigma_T_hat.\n            # sigma_T_hat = T_hat * sqrt(2 / (3 * N))\n            sigma_T_hat = T_hat * np.sqrt(2.0 / (3.0 * N))\n\n        # Format the results to three decimal places as required.\n        # The .3f format specifier handles rounding and ensures trailing zeros.\n        results.append(f\"[{T_hat:.3f},{sigma_T_hat:.3f}]\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```", "id": "3435467"}, {"introduction": "标准的麦克斯韦-玻尔兹曼分布是基于质量为标量的各向同性系统的理想模型。然而，在晶体材料中，电子或空穴等准粒子的行为通常由一个各向异性的有效质量张量描述。本高级练习[@problem_id:3435458]将挑战您将玻尔兹曼统计的基本原理推广到更复杂、更现实的场景中，推导出一个适用于各向异性能量-速度关系的广义速度分布。这个过程不仅展示了统计力学基本原理的普适性，还揭示了一个深刻的结论：即使在各向异性系统中，平均总动能依然保持为 $\\frac{3}{2} k_B T$。", "problem": "在晶体固体中，单个非相互作用的准粒子的动能由各向异性的有效质量张量决定。在计算材料科学中，有效质量近似将准粒子速度建模为连续变量，将动能建模为由对称正定有效质量张量决定的二次型。考虑一个速度矢量为 $\\mathbf{v}\\in\\mathbb{R}^3$、对称正定有效质量张量为 $\\mathbf{m}\\in\\mathbb{R}^{3\\times 3}$ 的准粒子。其动能为 $H_{\\mathrm{kin}}(\\mathbf{v})=\\tfrac{1}{2}\\,\\mathbf{v}^\\top \\mathbf{m}\\,\\mathbf{v}$。在绝对温度为 $T$ 的热平衡状态下，正则系综根据玻尔兹曼因子为微观状态分配概率密度。玻尔兹曼常数为 $k_B=1.380649\\times 10^{-23}\\,\\mathrm{J/K}$。\n\n您的任务是：\n\n- 以正则系综和玻尔兹曼因子为基本出发点，推导能量为 $H_{\\mathrm{kin}}(\\mathbf{v})=\\tfrac{1}{2}\\,\\mathbf{v}^\\top \\mathbf{m}\\,\\mathbf{v}$ 的准粒子的平衡速度空间概率密度 $p(\\mathbf{v}\\,|\\,T,\\mathbf{m})$。通过计算相应的高斯积分来显式计算归一化常数。不要假设各向同性。您必须从正则概率密度 $p(\\mathbf{v})\\propto\\exp(-\\beta H_{\\mathrm{kin}}(\\mathbf{v}))$（其中 $\\beta=1/(k_B T)$）出发，推导出获得 $p(\\mathbf{v}\\,|\\,T,\\mathbf{m})$ 和速度空间配分函数 $Z_{\\mathbf{v}}(T,\\mathbf{m})$ 所需的所有步骤。\n- 根据您推导出的 $p(\\mathbf{v}\\,|\\,T,\\mathbf{m})$，获得 $\\mathbf{v}$ 的协方差矩阵（即 $\\mathbb{E}[\\mathbf{v}\\,\\mathbf{v}^\\top]$）的闭式表达式，用 $k_B$、$T$ 和 $\\mathbf{m}$ 表示。\n- 将沿单位矢量 $\\mathbf{n}\\in\\mathbb{R}^3$ 的方向动能定义为 $E_{\\mathbf{n}}=\\tfrac{1}{2}\\,(\\mathbf{n}^\\top\\mathbf{m}\\,\\mathbf{n})\\,(\\mathbf{n}^\\top\\mathbf{v})^2$。在不假设 $\\mathbf{n}$ 是 $\\mathbf{m}$ 的特征向量的情况下，推导平均值 $\\mathbb{E}[E_{\\mathbf{n}}]$ 和方差 $\\mathrm{Var}(E_{\\mathbf{n}})$ 的闭式表达式，用 $k_B$、$T$、$\\mathbf{m}$ 和 $\\mathbf{n}$ 表示。\n- 在平衡分布 $p(\\mathbf{v}\\,|\\,T,\\mathbf{m})$ 下，推导总动能 $E=\\tfrac{1}{2}\\,\\mathbf{v}^\\top\\mathbf{m}\\,\\mathbf{v}$ 的分布，并求出 $\\mathbb{E}[E]$ 和 $\\mathrm{Var}(E)$。解释这些结果是否依赖于 $\\mathbf{m}$ 的各向异性。\n\n然后，设计并实现一个模拟程序，从推导出的平衡分布中对 $\\mathbf{v}$ 进行采样，并针对给定的 $\\mathbf{m}$、$T$ 和 $\\mathbf{n}$ 估计 $E_{\\mathbf{n}}$ 的样本均值。使用以下参数值测试套件。所有质量单位必须是千克（kilograms），所有温度单位必须是开尔文（kelvins），所有能量单位必须是焦耳（joules）。当提供角度时，单位为度（degrees）。\n\n常数：\n- $k_B=1.380649\\times 10^{-23}\\,\\mathrm{J/K}$。\n- 电子静止质量 $m_e=9.1093837015\\times 10^{-31}\\,\\mathrm{kg}$。\n\n对于下方的每个测试案例，从 $p(\\mathbf{v}\\,|\\,T,\\mathbf{m})$ 生成 $N$ 个独立样本，计算 $E_{\\mathbf{n}}$ 的样本均值，并报告样本均值与您推导出的 $E_{\\mathbf{n}}$ 理论均值之间的绝对相对误差，以小数形式（而非百分比）表示。\n\n测试套件：\n- 案例 1：$T=300\\,\\mathrm{K}$，$\\mathbf{m}=0.5\\,m_e\\,\\mathbf{I}_{3}$，$\\mathbf{n}=(1,0,0)$，$N=100000$。\n- 案例 2：$T=300\\,\\mathrm{K}$，$\\mathbf{m}=\\mathrm{diag}(0.2,1.0,0.5)\\,m_e$，$\\mathbf{n}=(0,0,1)$，$N=120000$。\n- 案例 3：$T=300\\,\\mathrm{K}$，$\\mathbf{m}=\\mathrm{diag}(0.2,1.0,0.5)\\,m_e$，$\\mathbf{n}=(1,1,0)/\\sqrt{2}$，$N=150000$。\n- 案例 4：$T=800\\,\\mathrm{K}$，$\\mathbf{m}=\\mathbf{R}(\\theta)\\,\\mathrm{diag}(0.1,1.5,0.3)\\,m_e\\,\\mathbf{R}(\\theta)^\\top$，其中 $\\mathbf{R}(\\theta)$ 是绕 $\\hat{\\mathbf{z}}$ 轴旋转 $\\theta=45$ 度的旋转矩阵，$\\mathbf{n}=(1,0,0)$，$N=180000$。旋转矩阵为\n$$\n\\mathbf{R}(\\theta)=\\begin{pmatrix}\n\\cos\\theta  -\\sin\\theta  0\\\\\n\\sin\\theta  \\cos\\theta  0\\\\\n0  0  1\n\\end{pmatrix}.\n$$\n- 案例 5：$T=100\\,\\mathrm{K}$，$\\mathbf{m}=\\mathrm{diag}(0.01,5.0,0.5)\\,m_e$，$\\mathbf{n}=(\\sqrt{3}/2,\\,1/2,\\,0)$，$N=150000$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如 $[r_1,r_2,r_3,r_4,r_5]$），其中每个 $r_i$ 是相应案例的绝对相对误差，格式化为浮点数。最终的数值输出是无单位的小数。", "solution": "该问题陈述清晰，具有科学依据，并为提供完整解决方案提供了所有必要信息。它由一个理论推导部分和一个计算部分组成，后者用于验证一部分推导出的结果。我们将首先执行所要求的推导，然后设计模拟。\n\n准粒子的动能由 $H_{\\mathrm{kin}}(\\mathbf{v})=\\tfrac{1}{2}\\,\\mathbf{v}^\\top \\mathbf{m}\\,\\mathbf{v}$ 给出，其中 $\\mathbf{v} \\in \\mathbb{R}^3$ 是速度，$\\mathbf{m} \\in \\mathbb{R}^{3\\times 3}$ 是对称正定有效质量张量。系统处于温度为 $T$ 的热平衡状态。玻尔兹曼常数为 $k_B$。我们定义 $\\beta = 1/(k_B T)$。\n\n### 1. 平衡速度空间概率密度 $p(\\mathbf{v}\\,|\\,T,\\mathbf{m})$ 的推导\n\n根据正则系综，速度为 $\\mathbf{v}$ 的微观状态的概率密度正比于玻尔兹曼因子：\n$$\np(\\mathbf{v}) \\propto \\exp(-\\beta H_{\\mathrm{kin}}(\\mathbf{v})) = \\exp\\left(-\\frac{\\beta}{2} \\mathbf{v}^\\top \\mathbf{m} \\mathbf{v}\\right)\n$$\n这是 $\\mathbf{v}$ 的多元正态分布的核。均值为 $\\boldsymbol{\\mu}$、协方差矩阵为 $\\mathbf{\\Sigma}$ 的 $d$ 维多元正态分布的一般形式为：\n$$\nf(\\mathbf{x}) = \\frac{1}{\\sqrt{(2\\pi)^d \\det(\\mathbf{\\Sigma})}} \\exp\\left(-\\frac{1}{2} (\\mathbf{x}-\\boldsymbol{\\mu})^\\top \\mathbf{\\Sigma}^{-1} (\\mathbf{x}-\\boldsymbol{\\mu})\\right)\n$$\n在我们的例子中，二次型 $\\mathbf{v}^\\top \\mathbf{m} \\mathbf{v}$ 表明分布以 $\\boldsymbol{\\mu}=\\mathbf{0}$ 为中心。通过比较指数部分，我们有：\n$$\n\\frac{1}{2} \\mathbf{v}^\\top \\mathbf{\\Sigma}^{-1} \\mathbf{v} = \\frac{\\beta}{2} \\mathbf{v}^\\top \\mathbf{m} \\mathbf{v}\n$$\n这意味着协方差矩阵的逆是 $\\mathbf{\\Sigma}^{-1} = \\beta \\mathbf{m}$。由于 $\\mathbf{m}$ 是正定的，它是可逆的。因此，协方差矩阵为：\n$$\n\\mathbf{\\Sigma} = (\\beta \\mathbf{m})^{-1} = \\frac{1}{\\beta} \\mathbf{m}^{-1} = k_B T \\mathbf{m}^{-1}\n$$\n归一化常数是速度空间中的配分函数 $Z_{\\mathbf{v}}(T,\\mathbf{m})$，通过对所有可能的速度积分未归一化的密度得到：\n$$\nZ_{\\mathbf{v}}(T,\\mathbf{m}) = \\int_{\\mathbb{R}^3} \\exp\\left(-\\frac{\\beta}{2} \\mathbf{v}^\\top \\mathbf{m} \\mathbf{v}\\right) d^3\\mathbf{v}\n$$\n这是一个标准的高斯积分。对于一般的二次型 $\\frac{1}{2}\\mathbf{x}^\\top\\mathbf{A}\\mathbf{x}$，积分为 $\\sqrt{(2\\pi)^d \\det(\\mathbf{A}^{-1})}$。此处，$d=3$，二次型中的矩阵是 $\\beta\\mathbf{m}$。\n$$\nZ_{\\mathbf{v}}(T,\\mathbf{m}) = \\sqrt{(2\\pi)^3 \\det((\\beta\\mathbf{m})^{-1})} = \\sqrt{(2\\pi)^3 \\det(\\beta^{-1}\\mathbf{m}^{-1})}\n$$\n使用行列式属性 $\\det(c\\mathbf{A}) = c^d_test \\det(\\mathbf{A})$：\n$$\nZ_{\\mathbf{v}}(T,\\mathbf{m}) = \\sqrt{(2\\pi)^3 (\\beta^{-1})^3 \\det(\\mathbf{m}^{-1})} = \\sqrt{(2\\pi)^3 (k_B T)^3 (\\det\\mathbf{m})^{-1}} = (2\\pi k_B T)^{3/2} (\\det\\mathbf{m})^{-1/2}\n$$\n归一化概率密度函数则为 $p(\\mathbf{v}\\,|\\,T,\\mathbf{m}) = \\frac{1}{Z_{\\mathbf{v}}} \\exp(-\\beta H_{\\mathrm{kin}}(\\mathbf{v}))$，即：\n$$\np(\\mathbf{v}\\,|\\,T,\\mathbf{m}) = \\frac{\\sqrt{\\det(\\mathbf{m})}}{(2\\pi k_B T)^{3/2}} \\exp\\left(-\\frac{1}{2k_B T} \\mathbf{v}^\\top \\mathbf{m} \\mathbf{v}\\right)\n$$\n这表明 $\\mathbf{v}$ 服从一个三维多元正态分布，$\\mathbf{v} \\sim \\mathcal{N}(\\mathbf{0}, k_B T \\mathbf{m}^{-1})$。\n\n### 2. 协方差矩阵 $\\mathbb{E}[\\mathbf{v}\\,\\mathbf{v}^\\top]$ 的推导\n\n随机矢量 $\\mathbf{v}$ 的均值为 $\\boldsymbol{\\mu} = \\mathbb{E}[\\mathbf{v}]$，其协方差矩阵定义为 $\\mathrm{Cov}(\\mathbf{v}) = \\mathbb{E}[(\\mathbf{v}-\\boldsymbol{\\mu})(\\mathbf{v}-\\boldsymbol{\\mu})^\\top]$。从推导出的分布 $p(\\mathbf{v}\\,|\\,T,\\mathbf{m})$，我们看到该分布是 $\\mathcal{N}(\\mathbf{0}, k_B T \\mathbf{m}^{-1})$。均值为 $\\mathbb{E}[\\mathbf{v}]=\\mathbf{0}$。因此，协方差矩阵就是：\n$$\n\\mathbb{E}[\\mathbf{v}\\,\\mathbf{v}^\\top] = \\mathrm{Cov}(\\mathbf{v}) = \\mathbf{\\Sigma} = k_B T \\mathbf{m}^{-1}\n$$\n\n### 3. 方向动能 $E_{\\mathbf{n}}$ 的均值和方差\n\n方向动能为 $E_{\\mathbf{n}}=\\tfrac{1}{2}\\,(\\mathbf{n}^\\top\\mathbf{m}\\,\\mathbf{n})\\,(\\mathbf{n}^\\top\\mathbf{v})^2$。项 $c_{\\mathbf{n}} = \\frac{1}{2}(\\mathbf{n}^\\top\\mathbf{m}\\,\\mathbf{n})$ 是一个标量常数，表示方向 $\\mathbf{n}$ 上有效质量的一半。\n$E_{\\mathbf{n}}$ 的均值为：\n$$\n\\mathbb{E}[E_{\\mathbf{n}}] = \\mathbb{E}\\left[\\frac{1}{2}(\\mathbf{n}^\\top\\mathbf{m}\\,\\mathbf{n})\\,(\\mathbf{n}^\\top\\mathbf{v})^2\\right] = \\frac{1}{2}(\\mathbf{n}^\\top\\mathbf{m}\\,\\mathbf{n}) \\mathbb{E}[(\\mathbf{n}^\\top\\mathbf{v})^2]\n$$\n期望项 $\\mathbb{E}[(\\mathbf{n}^\\top\\mathbf{v})^2]$ 可以展开为 $\\mathbb{E}[(\\mathbf{n}^\\top\\mathbf{v})(\\mathbf{v}^\\top\\mathbf{n})] = \\mathbb{E}[\\mathbf{n}^\\top(\\mathbf{v}\\mathbf{v}^\\top)\\mathbf{n}]$。利用期望的线性性质：\n$$\n\\mathbb{E}[(\\mathbf{n}^\\top\\mathbf{v})^2] = \\mathbf{n}^\\top \\mathbb{E}[\\mathbf{v}\\mathbf{v}^\\top] \\mathbf{n} = \\mathbf{n}^\\top (k_B T \\mathbf{m}^{-1}) \\mathbf{n} = k_B T (\\mathbf{n}^\\top \\mathbf{m}^{-1} \\mathbf{n})\n$$\n将此代回，我们得到平均方向能量：\n$$\n\\mathbb{E}[E_{\\mathbf{n}}] = \\frac{1}{2} k_B T (\\mathbf{n}^\\top\\mathbf{m}\\,\\mathbf{n})(\\mathbf{n}^\\top \\mathbf{m}^{-1} \\mathbf{n})\n$$\n对于方差，我们首先注意到随机变量 $X = \\mathbf{n}^\\top\\mathbf{v}$ 是多元正态矢量分量的线性组合，因此其本身也是一个正态随机变量。其均值为 $\\mathbb{E}[X] = \\mathbf{n}^\\top \\mathbb{E}[\\mathbf{v}] = 0$。其方差为 $\\sigma_X^2 = \\mathrm{Var}(X) = \\mathbb{E}[X^2] = k_B T (\\mathbf{n}^\\top \\mathbf{m}^{-1} \\mathbf{n})$。因此，$X \\sim \\mathcal{N}(0, \\sigma_X^2)$。\n我们需要求 $\\mathrm{Var}(E_{\\mathbf{n}}) = \\mathrm{Var}(c_{\\mathbf{n}} X^2) = c_{\\mathbf{n}}^2 \\mathrm{Var}(X^2)$。\n零均值正态变量平方的方差是 $\\mathrm{Var}(X^2) = \\mathbb{E}[X^4] - (\\mathbb{E}[X^2])^2$。对于 $X \\sim \\mathcal{N}(0, \\sigma_X^2)$，其矩为 $\\mathbb{E}[X^2] = \\sigma_X^2$ 和 $\\mathbb{E}[X^4] = 3(\\sigma_X^2)^2$。\n因此，$\\mathrm{Var}(X^2) = 3(\\sigma_X^2)^2 - (\\sigma_X^2)^2 = 2(\\sigma_X^2)^2$。\n方向能量的方差为：\n$$\n\\mathrm{Var}(E_{\\mathbf{n}}) = c_{\\mathbf{n}}^2 \\cdot 2(\\sigma_X^2)^2 = 2 \\left( \\frac{1}{2}(\\mathbf{n}^\\top\\mathbf{m}\\,\\mathbf{n}) \\right)^2 (k_B T (\\mathbf{n}^\\top \\mathbf{m}^{-1} \\mathbf n))^2 = \\frac{1}{2} (k_B T)^2 (\\mathbf{n}^\\top\\mathbf{m}\\,\\mathbf{n})^2 (\\mathbf{n}^\\top \\mathbf{m}^{-1} \\mathbf{n})^2\n$$\n\n### 4. 总动能 $E$ 的分布、均值和方差\n\n总动能为 $E = H_{\\mathrm{kin}}(\\mathbf{v})=\\tfrac{1}{2}\\,\\mathbf{v}^\\top \\mathbf{m}\\,\\mathbf{v}$。\n为了求其均值，我们使用迹属性 $\\mathbf{x}^\\top\\mathbf{A}\\mathbf{x} = \\mathrm{Tr}(\\mathbf{A}\\mathbf{x}\\mathbf{x}^\\top)$：\n$$\n\\mathbb{E}[E] = \\mathbb{E}\\left[\\frac{1}{2} \\mathbf{v}^\\top \\mathbf{m} \\mathbf{v}\\right] = \\frac{1}{2}\\mathbb{E}[\\mathrm{Tr}(\\mathbf{m}\\mathbf{v}\\mathbf{v}^\\top)] = \\frac{1}{2}\\mathrm{Tr}(\\mathbb{E}[\\mathbf{m}\\mathbf{v}\\mathbf{v}^\\top])\n$$\n$$\n\\mathbb{E}[E] = \\frac{1}{2}\\mathrm{Tr}(\\mathbf{m}\\mathbb{E}[\\mathbf{v}\\mathbf{v}^\\top]) = \\frac{1}{2}\\mathrm{Tr}(\\mathbf{m}(k_B T \\mathbf{m}^{-1})) = \\frac{1}{2} k_B T \\mathrm{Tr}(\\mathbf{m}\\mathbf{m}^{-1}) = \\frac{1}{2} k_B T \\mathrm{Tr}(\\mathbf{I}_3)\n$$\n由于 $\\mathrm{Tr}(\\mathbf{I}_3) = 3$，平均总动能为：\n$$\n\\mathbb{E}[E] = \\frac{3}{2} k_B T\n$$\n为了找到 $E$ 的分布，我们进行变量替换。令 $\\mathbf{m}^{1/2}$ 为 $\\mathbf{m}$ 唯一的对称正定平方根。令 $\\mathbf{u} = \\sqrt{\\beta} \\mathbf{m}^{1/2} \\mathbf{v}$。$p(\\mathbf{v})$ 中的指数变为：\n$$\n-\\frac{\\beta}{2} \\mathbf{v}^\\top \\mathbf{m} \\mathbf{v} = -\\frac{1}{2} (\\sqrt{\\beta}\\mathbf{m}^{1/2}\\mathbf{v})^\\top (\\sqrt{\\beta}\\mathbf{m}^{1/2}\\mathbf{v}) = -\\frac{1}{2} \\mathbf{u}^\\top\\mathbf{u} = -\\frac{1}{2} \\sum_{i=1}^3 u_i^2\n$$\n从 $\\mathbf{u}$ 到 $\\mathbf{v}$ 的变换的雅可比行列式为 $| \\det((\\sqrt{\\beta}\\mathbf{m}^{1/2})^{-1}) | = (\\beta)^{-3/2} (\\det \\mathbf{m})^{-1/2}$。$\\mathbf{u}$ 的概率密度为 $p(\\mathbf{u}) = p(\\mathbf{v}(\\mathbf{u})) |J|$，简化为 $p(\\mathbf{u}) = (2\\pi)^{-3/2} \\exp(-\\frac{1}{2}\\mathbf{u}^\\top\\mathbf{u})$。这表明分量 $u_1, u_2, u_3$ 是独立的标准正态随机变量，$u_i \\sim \\mathcal{N}(0, 1)$。\n总能量 $E$ 可以用 $\\mathbf{u}$ 表示：\n$$\nE = \\frac{1}{2\\beta} (\\mathbf{u}^\\top \\mathbf{u}) = \\frac{1}{2} k_B T (u_1^2 + u_2^2 + u_3^2)\n$$\n$d$ 个独立标准正态变量的平方和服从自由度为 $d$ 的卡方分布，即 $\\chi_d^2$。此处，$\\sum u_i^2 \\sim \\chi_3^2$。$E$ 的分布是一个常数 $\\frac{1}{2}k_B T$ 乘以一个 $\\chi_3^2$ 随机变量的分布。$E$ 的概率密度函数是一个伽马分布，具体为：\n$$\np(E) = \\frac{2\\sqrt{E}}{\\sqrt{\\pi}(k_B T)^{3/2}} \\exp\\left(-\\frac{E}{k_B T}\\right) \\quad \\text{for } E \\ge 0\n$$\n$E$ 的方差为：\n$$\n\\mathrm{Var}(E) = \\mathrm{Var}\\left(\\frac{1}{2} k_B T \\chi_3^2\\right) = \\left(\\frac{1}{2} k_B T\\right)^2 \\mathrm{Var}(\\chi_3^2)\n$$\n$\\chi_d^2$ 分布的方差是 $2d$。对于 $d=3$，$\\mathrm{Var}(\\chi_3^2) = 6$。\n$$\n\\mathrm{Var}(E) = \\frac{1}{4}(k_B T)^2 \\cdot 6 = \\frac{3}{2}(k_B T)^2\n$$\n均值 $\\mathbb{E}[E]$ 和方差 $\\mathrm{Var}(E)$，以及 $E$ 的整个分布，都仅依赖于温度 $T$ 和空间维度（$d=3$）。它们与有效质量张量 $\\mathbf{m}$ 的具体形式（各向异性）无关。\n\n### 模拟设计\n\n该模拟将通过对大量样本进行平均来估计 $\\mathbb{E}[E_{\\mathbf{n}}]$，并将其与理论值进行比较。\n1.  **生成样本**：从其分布 $\\mathcal{N}(\\mathbf{0}, \\mathbf{\\Sigma})$ 中对速度矢量 $\\mathbf{v}$ 进行采样，其中 $\\mathbf{\\Sigma} = k_B T \\mathbf{m}^{-1}$。\n    -   生成一个包含3个独立标准正态随机变量的矢量 $\\mathbf{z}$。\n    -   计算协方差矩阵的Cholesky分解：$\\mathbf{\\Sigma} = \\mathbf{L}\\mathbf{L}^\\top$。\n    -   通过线性变换 $\\mathbf{v} = \\mathbf{L}\\mathbf{z}$ 获得 $\\mathbf{v}$ 的一个样本。\n2.  **计算样本均值**：对于每个样本 $\\mathbf{v}_i$，计算 $E_{\\mathbf{n},i} = \\frac{1}{2}(\\mathbf{n}^\\top\\mathbf{m}\\,\\mathbf{n})\\,(\\mathbf{n}^\\top\\mathbf{v}_i)^2$。样本均值为 $\\bar{E}_{\\mathbf{n}} = \\frac{1}{N}\\sum_{i=1}^N E_{\\mathbf{n},i}$。\n3.  **计算误差**：计算绝对相对误差 $|\\bar{E}_{\\mathbf{n}} - \\mathbb{E}[E_{\\mathbf{n}}]| / |\\mathbb{E}[E_{\\mathbf{n}}]|$，其中 $\\mathbb{E}[E_{\\mathbf{n}}]$ 是上面推导出的闭式表达式。\n此过程将为每个测试案例实施。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the absolute relative error between the theoretical mean and\n    the sample mean of the directional kinetic energy for a quasiparticle.\n    \"\"\"\n    # Define constants\n    K_B = 1.380649e-23  # J/K\n    M_E = 9.1093837015e-31  # kg\n\n    # Define the rotation matrix function\n    def get_rotation_matrix(theta_deg):\n        theta_rad = np.deg2rad(theta_deg)\n        c, s = np.cos(theta_rad), np.sin(theta_rad)\n        return np.array([[c, -s, 0], [s, c, 0], [0, 0, 1]])\n\n    # Test suite of parameters\n    test_cases = [\n        {\n            \"T\": 300.0,\n            \"m\": 0.5 * M_E * np.identity(3),\n            \"n\": np.array([1.0, 0.0, 0.0]),\n            \"N\": 100000,\n        },\n        {\n            \"T\": 300.0,\n            \"m\": np.diag([0.2, 1.0, 0.5]) * M_E,\n            \"n\": np.array([0.0, 0.0, 1.0]),\n            \"N\": 120000,\n        },\n        {\n            \"T\": 300.0,\n            \"m\": np.diag([0.2, 1.0, 0.5]) * M_E,\n            \"n\": np.array([1.0, 1.0, 0.0]) / np.sqrt(2.0),\n            \"N\": 150000,\n        },\n        {\n            \"T\": 800.0,\n            \"m\": get_rotation_matrix(45) @ np.diag([0.1, 1.5, 0.3]) @ get_rotation_matrix(45).T * M_E,\n            \"n\": np.array([1.0, 0.0, 0.0]),\n            \"N\": 180000,\n        },\n        {\n            \"T\": 100.0,\n            \"m\": np.diag([0.01, 5.0, 0.5]) * M_E,\n            \"n\": np.array([np.sqrt(3.0) / 2.0, 1.0 / 2.0, 0.0]),\n            \"N\": 150000,\n        },\n    ]\n\n    results = []\n    # Use a fixed seed for reproducibility.\n    rng = np.random.default_rng(seed=42)\n\n    for case in test_cases:\n        T = case[\"T\"]\n        m = case[\"m\"]\n        n = case[\"n\"]\n        N = case[\"N\"]\n\n        # 1. Calculate theoretical mean of directional kinetic energy\n        m_inv = np.linalg.inv(m)\n        term_m = n.T @ m @ n\n        term_m_inv = n.T @ m_inv @ n\n        E_n_mean_theory = 0.5 * K_B * T * term_m * term_m_inv\n\n        # 2. Set up the sampling procedure\n        # Covariance matrix of velocity: Sigma = k_B * T * m^-1\n        Sigma = K_B * T * m_inv\n        \n        # Cholesky decomposition: Sigma = L * L.T\n        # We sample v = L @ z, where z ~ N(0, I)\n        # Using numpy, if Z is (N,3) with z_i in rows, then V = Z @ L.T\n        try:\n            L = np.linalg.cholesky(Sigma)\n        except np.linalg.LinAlgError:\n            # Fallback for matrices that might have precision issues\n            # For a symmetric matrix, eigendecomposition Sigma = Q*D*Q.T\n            # L can be Q*sqrt(D)\n            eigvals, eigvecs = np.linalg.eigh(Sigma)\n            if np.any(eigvals  0): # Should not happen for SPD matrices\n                raise ValueError(\"Covariance matrix is not positive semi-definite.\")\n            L = eigvecs @ np.diag(np.sqrt(eigvals))\n\n        # 3. Generate N samples of v\n        # Z contains N samples of 3D standard normal vectors (row-wise)\n        Z = rng.standard_normal(size=(N, 3))\n        # Transform to samples from N(0, Sigma)\n        # v_row^T = z_row^T @ L^T, so V = Z @ L.T\n        V = Z @ L.T\n\n        # 4. Calculate sample mean of directional kinetic energy\n        # Directional effective mass scalar\n        m_n_eff = term_m\n        \n        # Velocity component along n for all samples\n        v_n = V @ n  # (N, 3) @ (3,) -> (N,)\n        \n        # Directional kinetic energy for each sample\n        E_n_samples = 0.5 * m_n_eff * v_n**2\n        \n        # Sample mean\n        E_n_mean_sample = np.mean(E_n_samples)\n\n        # 5. Compute absolute relative error\n        # Avoid division by zero if theoretical mean is zero, although not expected here.\n        if E_n_mean_theory == 0:\n            error = np.abs(E_n_mean_sample)\n        else:\n            error = np.abs(E_n_mean_sample - E_n_mean_theory) / np.abs(E_n_mean_theory)\n        \n        results.append(error)\n\n    # Final print statement in the exact required format\n    print(f\"[{','.join(f'{r:.10f}' for r in results)}]\")\n\nsolve()\n```", "id": "3435458"}]}