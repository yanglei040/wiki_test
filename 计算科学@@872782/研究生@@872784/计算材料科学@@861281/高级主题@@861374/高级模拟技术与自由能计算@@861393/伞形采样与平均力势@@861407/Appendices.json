{"hands_on_practices": [{"introduction": "伞形采样计算的平均力势（PMF）的有效性，依赖于对所有相关慢变量的充分采样，而不仅仅是被偏置的反应坐标本身。如果存在一个与反应坐标正交的“隐藏”慢变量，而模拟时间又不足以使其越过能垒并达到平衡，系统就会陷入“动力学陷阱”。这个练习 [@problem_id:2391871] 将挑战你识别一个标准伞形采样会因此类陷阱而彻底失败的分子系统，从而强调了在模拟开始前进行审慎物理思考和实验设计的至关重要性。", "problem": "您的任务是选择一种分子系统设计，在该设计中，如果使用标准伞形采样而不进行任何增强采样，动力学陷阱将导致计算出完全错误的平均力势 (PMF)。沿一维反应坐标 $s$ 的 PMF 由平衡关系 $G(s) = -k_{\\mathrm{B}} T \\ln Z(s) + C$ 定义，其中 $Z(s) = \\int \\mathrm{d}\\mathbf{r}\\,\\delta(s(\\mathbf{r}) - s)\\,\\exp[-\\beta U(\\mathbf{r})]$，$\\beta = 1/(k_{\\mathrm{B}} T)$，$U(\\mathbf{r})$ 是势能，$C$ 是一个任意常数。伞形采样将只偏置 $s$，并采用根据模拟协议进行平衡的窗口，但不使用交换、退火或其他增强方法。窗口的模拟时长短于穿越任何正交坐标中高势垒的时间尺度。\n\n在这些条件下，下面的哪个系统最有可能因为伞形采样未能使正交的慢自由度达到平衡，而产生完全错误的 $G(s)$？\n\nA. 蛋白质-配体结合，反应坐标为 $s = r$，即蛋白质-配体距离。一个正交的门控变量 $q \\in \\{\\text{closed}, \\text{open}\\}$ 代表一个阻挡结合口袋的环区。$q$ 转变（环区打开/关闭）的自由能垒为 $\\Delta G^{\\ddagger}_q \\gg k_{\\mathrm{B}} T$。当 $r$ 较大时，两种 $q$ 状态在热力学上都是可及的；当 $r$ 较小时，只有 $q = \\text{open}$ 与空间位阻相容。每个伞形窗口都从 $q = \\text{closed}$ 状态开始初始化。\n\nB. 蛋白质-配体结合，反应坐标为 $s = r$，门控变量 $q$ 与选项A中相同，但环区打开的势垒满足 $\\Delta G^{\\ddagger}_q \\approx k_{\\mathrm{B}} T$，因此 $q$ 的转变在窗口的时间尺度上频繁发生。所有窗口都从在相应 $r$ 值下通过无偏预平衡采样的 $q$ 状态混合物开始初始化。\n\nC. 离子穿过一个宽阔的水合孔道，反应坐标为 $s = z$，即离子的轴向位置。正交坐标包括局部水分子和侧链的重新取向，其势垒可以忽略不计，且其特征弛豫时间远短于窗口的模拟时长。该孔道没有疏水去湿润转变。\n\nD. 水中的一个二肽，反应坐标为 $s = \\phi$，一个单一的扭转二面角。正交坐标是键长、键角和溶剂位置，它们能快速达到平衡。除了沿 $\\phi$ 本身的状态（已由伞形采样直接偏置）之外，没有其他与 $s$ 耦合的亚稳态旋转异构体状态。\n\n选择最佳选项。", "solution": "问题要求我们识别一个分子系统，在该系统中，标准伞形采样会因动力学陷阱而灾难性地失败，从而导致计算出完全错误的平均力势 (PMF)。失败机制被指定为无法使与所选一维反应坐标 $s$ 正交的慢自由度达到平衡。\n\n平均力势 $G(s)$ 是一个平衡热力学量。它由关系式 $G(s) = -k_{\\mathrm{B}} T \\ln Z(s) + C$ 定义，其中 $k_{\\mathrm{B}}$ 是玻尔兹曼常数，$T$ 是温度，$C$ 是一个常数，$Z(s)$ 是系统在反应坐标 $s$ 取特定值时受约束的正则配分函数。形式上，$Z(s) = \\int \\mathrm{d}\\mathbf{r}\\,\\delta(s(\\mathbf{r}) - s)\\,\\exp[-\\beta U(\\mathbf{r})]$，其中 $\\beta = 1/(k_{\\mathrm{B}} T)$，$U(\\mathbf{r})$ 是系统所有坐标 $\\mathbf{r}$ 的势能。\n\n为了使用像伞形采样这样的分子模拟方法精确计算 $G(s)$，对于每个伞形窗口（即对于每个受约束的 $s$ 值），模拟必须实现对所有与 $s$ 正交的相关自由度的遍历性采样。如果存在一个慢的正交自由度 $q$，其特征是具有一个高自由能垒 $\\Delta G^{\\ddagger}_q \\gg k_{\\mathrm{B}} T$，那么 $q$ 的亚稳态之间的转变就是稀有事件。问题指出，每个伞形窗口的模拟时间短于穿越这种高势垒的时间尺度。这意味着如果一个系统拥有这样一个慢坐标 $q$，模拟将被困在 $q$ 的初始吸引盆中。窗口内的采样相对于 $q$ 将是非遍历的。\n\n这种非遍历性导致计算出一个有偏的 PMF，$G_{\\text{obs}}(s)$，它只反映了构象空间一个子集的自由能。如果动力学上被捕获的区域在给定的 $s$ 值下不是热力学上最稳定的区域，那么误差 $G_{\\text{obs}}(s) - G_{\\text{true}}(s)$ 将会很大，并可能使结果“完全错误”。我们必须分析每个选项，看哪一个呈现了这样的情景。\n\n**A. 蛋白质-配体结合，伴随慢的环区门控。**\n该系统涉及反应坐标 $s = r$（蛋白质-配体距离）和一个正交的门控变量 $q \\in \\{\\text{closed}, \\text{open}\\}$。\n关键信息是 $q$ 转变的势垒很高（$\\Delta G^{\\ddagger}_q \\gg k_{\\mathrm{B}} T$），使其成为一个慢自由度。模拟窗口的时长短于此转变的时间尺度。此外，每个窗口都从 $q = \\text{closed}$ 状态初始化。\n当配体接近蛋白质时（$r$ 减小），它需要进入结合口袋。问题指出，对于小的 $r$ 值，只有 $q = \\text{open}$ 状态在空间上是相容的。然而，由于模拟从 $q = \\text{closed}$ 开始，并且因为高势垒和短模拟时间而无法转变为 $q = \\text{open}$，系统仍然被困住。\n对于配体靠近或进入口袋的 $r$ 值，模拟将会采样到非物理的、高能量的构象（对应于闭合的环区与配体发生碰撞），或者被困在一个并非全局最小值的亚稳态中。真正的结合自由能路径必然涉及环区的打开，而这是一个模拟无法采样的过程。因此，计算出的 PMF 将显示一个不正确的高（可能发散）结合势垒，完全歪曲了实际的结合过程。这是一个由于正交坐标中的采样问题导致标准伞形采样灾难性失败的经典例子。\n**结论：正确。** 这种情景被设计成完全符合问题描述中的失败方式。\n\n**B. 蛋白质-配体结合，伴随快的环区门控。**\n该系统与A相似，但环区打开的势垒较低，$\\Delta G^{\\ddagger}_q \\approx k_{\\mathrm{B}} T$。这意味着 $q = \\text{open}$ 和 $q = \\text{closed}$ 状态之间的转变是频繁的，并且其发生的时间尺度远短于每个伞形窗口中的模拟时长。因此，在每个反应坐标 $r$ 的值上，$q$ 状态的平衡布居将被正确采样。系统不会在 $q$ 坐标上遭受动力学陷阱。初始化方案也有所改进，但关键因素是低势垒。标准伞形采样有望为该系统得出准确的 PMF。\n**结论：不正确。**\n\n**C. 离子穿过一个宽阔的水合孔道。**\n反应坐标是离子的轴向位置，$s = z$。正交坐标被指定为局部水分子和侧链的重新取向。问题明确指出，这些重新取向的势垒可以忽略不计，且其弛豫时间与窗口模拟时长相比很短。它还指出没有其他慢过程，如疏水去湿润。这意味着所有相关的正交自由度将在每个伞形窗口内迅速达到平衡。失败的条件——存在一个未被采样的慢的正交坐标——没有被满足。\n**结论：不正确。**\n\n**D. 水中的一个二肽。**\n反应坐标是一个单一的二面角，$s = \\phi$。正交自由度（键长、键角、溶剂位置）已知能非常迅速地达到平衡。问题通过说明它们能快速平衡，并且关键地指出“除了沿 $\\phi$ 本身的状态之外，没有其他与 $s$ 耦合的亚稳态旋转异构体状态”来强调这一点。由于沿 $\\phi$ 的运动是伞形采样所偏置和增强的自由度，而所有其他自由度都是快的，所以该方法非常适合解决这个问题。没有可能导致动力学陷阱的“隐藏”慢坐标。\n**结论：不正确。**\n\n总而言之，只有选项A描述了这样一种情况：在与反应坐标正交的自由度中存在一个高自由能垒，再加上不充分的模拟时间和有偏的初始化，将导致 PMF 计算出现系统性的、灾难性的失败。", "answer": "$$\\boxed{A}$$", "id": "2391871"}, {"introduction": "在构思了模拟体系的物理特性后，下一个实际步骤是设置采样窗口。窗口的放置是在计算成本和统计精度（确保直方图有良好重叠）之间的一种权衡。这个编程练习 [@problem_id:3499551] 提供了一种自动优化此过程的动手实践，要求你创建一个自适应算法，该算法基于定量的重叠度量来高效地放置窗口，这是任何成功的伞形采样研究中的关键一步。", "problem": "您的任务是为计算材料科学中一维反应坐标的伞形采样设计并实现一个自适应窗口方案。目标是优化窗口中心，使得相邻的偏置采样窗口具有足够的统计重叠，该重叠通过库尔贝克-莱布勒散度（KLD）进行量化。物理设置假设采用谐波偏置势，通过简短的初步模拟得出每个窗口内反应坐标的样本方差，并在指定温度下处于热平衡状态。您的程序必须基于这些初步的重叠度量，实现窗口中心的自适应优化，并在所有相邻窗口都满足散度阈值时停止。最终程序必须生成一行输出，其中包含所提供测试套件的结果，格式为方括号内以逗号分隔的列表。\n\n基本和建模假设：\n- 反应坐标 $x$ 是一个连续变量，物理单位为纳米。\n- 在温度为 $T$、摩尔气体常数为 $R$ 的正则系综条件下，偏置窗口中沿 $x$ 的平衡密度与 $\\exp\\!\\left(-\\beta \\left(F(x) + U_{\\text{bias}}(x)\\right)\\right)$ 成正比，其中 $\\beta = 1/(RT)$，$F(x)$ 是平均力势，$U_{\\text{bias}}(x)$ 是谐波偏置 $U_{\\text{bias}}(x) = \\tfrac{1}{2} k (x - c)^2$，$k$ 是单位为 $\\text{kJ}\\,\\text{mol}^{-1}\\,\\text{nm}^{-2}$ 的偏置劲度系数，$c$ 是单位为 $\\text{nm}$ 的窗口中心。\n- 初步的简短模拟在每个窗口中心 $c_i$ 处产生样本方差，记为 $\\sigma_i^2$，单位为 $\\text{nm}^2$。这些方差用于将每个窗口的偏置反应坐标分布近似为正态分布。\n- 两个相邻窗口分布之间的库尔贝克-莱布勒散度（KLD）应用作重叠度量。为消除方向性，应使用对称KLD（也称为杰弗里斯散度），其定义为两个定向KLD之和，每个定向KLD都使用连续分布的KLD定义从第一性原理计算得出。\n\n自适应方案要求：\n- 基于每个窗口的中心 $c_i$ 和样本标准差 $\\sigma_i$，将其表示为正态分布 $\\mathcal{N}(c_i,\\sigma_i^2)$。\n- 对于每个相邻对 $(i,i+1)$，使用从第一性原理推导出的正态分布KLD定义来计算对称KLD。\n- 如果任何相邻对违反停止准则 $J_{i,i+1} \\le \\tau$（其中 $J_{i,i+1}$ 是对称KLD，$\\tau$ 是用户指定的正阈值），则通过在其中点 $c_{\\text{new}} = \\tfrac{c_i + c_{i+1}}{2}$ 处插入一个新窗口来进行优化，其初步标准差 $\\sigma_{\\text{new}}$ 由平均值 $\\sigma_{\\text{new}} = \\tfrac{\\sigma_i + \\sigma_{i+1}}{2}$ 给出。\n- 重复计算对称KLD并插入中点窗口，直到所有相邻对都满足 $J_{i,i+1} \\le \\tau$。\n- 所有长度 $c_i$ 和 $\\sigma_i$ 的单位必须是 $\\text{nm}$，温度 $T$ 的单位是 $\\text{K}$，劲度系数 $k$ 的单位是 $\\text{kJ}\\,\\text{mol}^{-1}\\,\\text{nm}^{-2}$，$R$ 的单位是 $\\text{kJ}\\,\\text{mol}^{-1}\\,\\text{K}^{-1}$。KLD是无量纲的。\n- 您的程序不能要求任何外部输入；它必须运行嵌入在代码中的指定测试用例，并为每个用例打印优化后窗口中心的最终数量（整数）。\n\n测试套件：\n- 情况 $1$ （理想情况，需要大量优化）：\n  - 域 $[0,1]$ $\\text{nm}$，偏置劲度系数 $k = 1000$ $\\text{kJ}\\,\\text{mol}^{-1}\\,\\text{nm}^{-2}$，温度 $T = 300$ $\\text{K}$。\n  - 初始中心 $\\{0.0, 0.5, 1.0\\}$ $\\text{nm}$。\n  - 初步样本标准差 $\\{\\sigma_0, \\sigma_1, \\sigma_2\\} = \\{0.05, 0.045, 0.05\\}$ $\\text{nm}$。\n  - 停止阈值 $\\tau = 2.0$（无量纲）。\n- 情况 $2$ （中等程度优化）：\n  - 域 $[0,1]$ $\\text{nm}$，偏置劲度系数 $k = 200$ $\\text{kJ}\\,\\text{mol}^{-1}\\,\\text{nm}^{-2}$，温度 $T = 300$ $\\text{K}$。\n  - 初始中心 $\\{0.0, 0.25, 0.5, 0.75, 1.0\\}$ $\\text{nm}$。\n  - 初步样本标准差 $\\{0.112, 0.112, 0.112, 0.112, 0.112\\}$ $\\text{nm}$。\n  - 停止阈值 $\\tau = 4.0$。\n- 情况 $3$ （已有足够重叠）：\n  - 域 $[0,0.4]$ $\\text{nm}$，偏置劲度系数 $k = 100$ $\\text{kJ}\\,\\text{mol}^{-1}\\,\\text{nm}^{-2}$，温度 $T = 300$ $\\text{K}$。\n  - 初始中心 $\\{0.0, 0.2, 0.4\\}$ $\\text{nm}$。\n  - 初步样本标准差 $\\{0.158, 0.158, 0.158\\}$ $\\text{nm}$。\n  - 停止阈值 $\\tau = 2.5$。\n- 情况 $4$ （边界情况，偏置非常刚性）：\n  - 域 $[0,1]$ $\\text{nm}$，偏置劲度系数 $k = 5000$ $\\text{kJ}\\,\\text{mol}^{-1}\\,\\text{nm}^{-2}$，温度 $T = 300$ $\\text{K}$。\n  - 初始中心 $\\{0.0, 1.0\\}$ $\\text{nm}$。\n  - 初步样本标准差 $\\{0.022, 0.022\\}$ $\\text{nm}$。\n  - 停止阈值 $\\tau = 1.5$。\n\n算法输出规范：\n- 对于每个测试用例，运行自适应优化，直到每个相邻对都满足停止准则，并以整数形式返回窗口中心的最终数量。\n- 您的程序应生成一行输出，其中包含四个测试用例的结果，格式为方括号内以逗号分隔的列表（例如，$[n_1,n_2,n_3,n_4]$）。", "solution": "该问题要求为伞形采样模拟设计并实现一个自适应窗口算法。任务的核心是沿一维反应坐标 $x$ 迭代优化采样窗口的布局，直到所有相邻窗口之间实现足够的统计重叠。在假设每个偏置窗口内的粒子分布是正态分布的前提下，重叠度使用对称库尔贝克-莱布勒散度（也称为杰弗里斯散度）进行量化。\n\n解决方案主要分为两部分：首先，推导重叠度量的数学公式；其次，描述使用该度量来优化窗口布局的迭代算法。\n\n**1. 重叠度量：对称库尔贝克-莱布勒散度**\n\n问题规定，每个采样窗口以 $c_i$ 为中心，由谐波偏置势表征，其产生的反应坐标 $x$ 的分布可以近似为正态分布 $P_i(x) = \\mathcal{N}(c_i, \\sigma_i^2)$。这种分布的概率密度函数是：\n$$\nP_i(x) = \\frac{1}{\\sqrt{2\\pi\\sigma_i^2}} \\exp\\left(-\\frac{(x - c_i)^2}{2\\sigma_i^2}\\right)\n$$\n其中 $c_i$ 是均值（窗口中心），$\\sigma_i^2$ 是方差，从初步模拟中获得。\n\n两个相邻分布 $P_1 = \\mathcal{N}(c_1, \\sigma_1^2)$ 和 $P_2 = \\mathcal{N}(c_2, \\sigma_2^2)$ 之间的重叠由对称库尔贝克-莱布勒（KL）散度 $J_{1,2}$ 衡量。它被定义为两个定向KL散度之和：\n$$\nJ_{1,2} = D_{\\text{KL}}(P_1 || P_2) + D_{\\text{KL}}(P_2 || P_1)\n$$\n从 $P_2$ 到 $P_1$ 的KL散度由以下积分给出：\n$$\nD_{\\text{KL}}(P_1 || P_2) = \\int_{-\\infty}^{\\infty} P_1(x) \\log\\left(\\frac{P_1(x)}{P_2(x)}\\right) dx\n$$\n对于两个一维正态分布，该积分有一个著名的闭式解。首先，我们展开对数项：\n$$\n\\log\\left(\\frac{P_1(x)}{P_2(x)}\\right) = \\log\\left(\\frac{1/\\sqrt{2\\pi\\sigma_1^2}}{1/\\sqrt{2\\pi\\sigma_2^2}} \\cdot \\frac{\\exp(-\\frac{(x - c_1)^2}{2\\sigma_1^2})}{\\exp(-\\frac{(x - c_2)^2}{2\\sigma_2^2})}\\right) = \\log\\left(\\frac{\\sigma_2}{\\sigma_1}\\right) - \\frac{(x - c_1)^2}{2\\sigma_1^2} + \\frac{(x - c_2)^2}{2\\sigma_2^2}\n$$\n将其代入积分，并利用 $\\int P_1(x) dx = 1$ 和 $\\mathbb{E}_1[(x-c_1)^2] = \\sigma_1^2$ 这两个事实：\n$$\nD_{\\text{KL}}(P_1 || P_2) = \\mathbb{E}_1\\left[\\log\\left(\\frac{\\sigma_2}{\\sigma_1}\\right) - \\frac{(x - c_1)^2}{2\\sigma_1^2} + \\frac{(x - c_2)^2}{2\\sigma_2^2}\\right]\n$$\n$$\nD_{\\text{KL}}(P_1 || P_2) = \\log\\left(\\frac{\\sigma_2}{\\sigma_1}\\right) - \\frac{\\mathbb{E}_1[(x - c_1)^2]}{2\\sigma_1^2} + \\frac{\\mathbb{E}_1[(x - c_2)^2]}{2\\sigma_2^2}\n$$\n我们需要计算 $\\mathbb{E}_1[(x - c_2)^2] = \\int P_1(x)(x-c_2)^2 dx$。通过加上和减去 $c_1$，我们得到：\n$$\n\\mathbb{E}_1[(x - c_1 + c_1 - c_2)^2] = \\mathbb{E}_1[(x - c_1)^2 + 2(x - c_1)(c_1 - c_2) + (c_1 - c_2)^2]\n$$\n$$\n= \\mathbb{E}_1[(x - c_1)^2] + 2(c_1 - c_2)\\mathbb{E}_1[x - c_1] + (c_1 - c_2)^2 = \\sigma_1^2 + 0 + (c_1 - c_2)^2\n$$\n代回后，我们得到定向KL散度的表达式：\n$$\nD_{\\text{KL}}(P_1 || P_2) = \\log\\left(\\frac{\\sigma_2}{\\sigma_1}\\right) + \\frac{\\sigma_1^2 + (c_1 - c_2)^2}{2\\sigma_2^2} - \\frac{1}{2}\n$$\n对称散度 $J_{1,2}$ 是此表达式与交换索引1和2后的表达式之和：\n$$\nJ_{1,2} = \\left[ \\log\\left(\\frac{\\sigma_2}{\\sigma_1}\\right) + \\frac{\\sigma_1^2 + (c_1 - c_2)^2}{2\\sigma_2^2} - \\frac{1}{2} \\right] + \\left[ \\log\\left(\\frac{\\sigma_1}{\\sigma_2}\\right) + \\frac{\\sigma_2^2 + (c_2 - c_1)^2}{2\\sigma_1^2} - \\frac{1}{2} \\right]\n$$\n由于 $\\log(a) + \\log(1/a) = 0$ 且 $(c_1 - c_2)^2 = (c_2 - c_1)^2$，对数项相互抵消。这简化为算法中使用的最终表达式：\n$$\nJ_{1,2} = \\frac{\\sigma_1^2 + (c_1 - c_2)^2}{2\\sigma_2^2} + \\frac{\\sigma_2^2 + (c_1 - c_2)^2}{2\\sigma_1^2} - 1\n$$\n这也可以写成：\n$$\nJ_{1,2} = \\frac{1}{2}\\left(\\frac{\\sigma_1^2}{\\sigma_2^2} + \\frac{\\sigma_2^2}{\\sigma_1^2}\\right) + \\frac{(c_1 - c_2)^2}{2}\\left(\\frac{1}{\\sigma_1^2} + \\frac{1}{\\sigma_2^2}\\right) - 1\n$$\n这个无量纲量提供了两种分布之间差异的度量。值越小表示重叠越大。\n\n**2. 自适应优化算法**\n\n自适应方案迭代地改进采样窗口集，直到所有相邻对都满足重叠准则 $J_{i,i+1} \\le \\tau$，其中 $\\tau$ 是一个指定的容差。\n\n算法流程如下：\n1.  **初始化**：从一个初始窗口列表开始，每个窗口由一对 $(c_i, \\sigma_i)$ 定义，并按中心坐标 $c_i$ 排序。\n2.  **迭代循环**：进入一个循环，直到在一次完整的遍历中没有进行任何优化。可以使用一个布尔标志 `refined_in_pass` 来跟踪此情况。\n3.  **重叠评估**：在每次遍历中，迭代所有相邻的窗口对 $(c_i, \\sigma_i)$ 和 $(c_{i+1}, \\sigma_{i+1})$。\n4.  **计算散度**：对于每一对，使用上面推导的公式计算对称KL散度 $J_{i,i+1}$。\n5.  **检查准则**：如果 $J_{i,i+1} > \\tau$，则重叠不足，必须对这两个窗口之间的区间进行优化。标记该区间以进行优化。\n6.  **优化**：在一次遍历中检查完所有对后，生成一个新的窗口列表。这个新列表包括所有原始窗口以及在每个被标记为需要优化的区间的中点处插入的新窗口。\n    -   对于需要优化的一对 $(c_i, \\sigma_i)$ 和 $(c_{i+1}, \\sigma_{i+1})$，创建一个新窗口 $(c_{\\text{new}}, \\sigma_{\\text{new}})$，其参数为：\n        $$\n        c_{\\text{new}} = \\frac{c_i + c_{i+1}}{2}\n        $$\n        $$\n        \\sigma_{\\text{new}} = \\frac{\\sigma_i + \\sigma_{i+1}}{2}\n        $$\n7.  **更新**：新的、扩展后的窗口列表将替换旧列表，用于下一次迭代。根据构造方法，该列表保持排序。\n8.  **终止**：如果完成一次完整的遍历后 `refined_in_pass` 仍然为假（即对于所有相邻对都有 $J_{i,i+1} \\le \\tau$），则算法已收敛。然后报告最终的窗口数量。\n\n这个迭代过程保证会终止，因为每个优化步骤都会将窗口中心之间的距离减半，这会使散度公式中的主导项 $(c_1-c_2)^2$ 平方级减小，从而确保 $J$ 最终会降到任何正阈值 $\\tau$ 以下。额外的物理参数（$k, T, R$）为在真实模拟中如何获得输入标准差 $\\sigma_i$ 提供了背景信息，但在本次特定的算法任务中并未直接使用。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef calculate_jeffreys_divergence(c1, s1, c2, s2):\n    \"\"\"\n    Calculates the Jeffreys divergence (symmetric Kullback-Leibler divergence)\n    between two normal distributions N(c1, s1^2) and N(c2, s2^2).\n\n    Args:\n        c1 (float): Mean of the first distribution.\n        s1 (float): Standard deviation of the first distribution.\n        c2 (float): Mean of the second distribution.\n        s2 (float): Standard deviation of the second distribution.\n\n    Returns:\n        float: The dimensionless Jeffreys divergence.\n    \"\"\"\n    s1_sq = s1**2\n    s2_sq = s2**2\n    c_diff_sq = (c1 - c2)**2\n\n    # The problem asks for derivation from first principles, which leads to:\n    # J = D_KL(P1 || P2) + D_KL(P2 || P1)\n    # D_KL(P1 || P2) = log(s2/s1) + (s1^2 + (c1-c2)^2) / (2*s2^2) - 0.5\n    # Summing D_KL(P1||P2) and D_KL(P2||P1), log terms cancel.\n    \n    term1 = (s1_sq + c_diff_sq) / (2 * s2_sq)\n    term2 = (s2_sq + c_diff_sq) / (2 * s1_sq)\n    \n    divergence = term1 + term2 - 1.0\n    return divergence\n\ndef run_adaptive_scheme(initial_centers, initial_stdevs, tau):\n    \"\"\"\n    Runs the adaptive windowing refinement scheme until convergence.\n\n    Args:\n        initial_centers (list): List of initial window center coordinates.\n        initial_stdevs (list): List of initial window sample standard deviations.\n        tau (float): The stopping threshold for the Jeffreys divergence.\n\n    Returns:\n        int: The final number of windows after refinement.\n    \"\"\"\n    # Windows are stored as a list of (center, stdev) tuples, sorted by center.\n    windows = sorted(zip(initial_centers, initial_stdevs))\n\n    while True:\n        refined_in_pass = False\n        new_windows = [windows[0]]\n        \n        for i in range(len(windows) - 1):\n            c1, s1 = windows[i]\n            c2, s2 = windows[i+1]\n\n            divergence = calculate_jeffreys_divergence(c1, s1, c2, s2)\n\n            if divergence > tau:\n                refined_in_pass = True\n                # Insert a new window at the midpoint\n                c_new = (c1 + c2) / 2.0\n                s_new = (s1 + s2) / 2.0\n                new_windows.append((c_new, s_new))\n            \n            new_windows.append(windows[i+1])\n        \n        # Sort the newly generated list of windows by center\n        windows = sorted(new_windows)\n\n        if not refined_in_pass:\n            break\n            \n    return len(windows)\n\ndef solve():\n    \"\"\"\n    Defines and runs the test suite for the adaptive windowing problem.\n    \"\"\"\n    # The physical parameters k, T, and R are context for the origin of the\n    # sigma values but are not directly used in the refinement algorithm,\n    # which operates on the provided centers and standard deviations.\n    test_cases = [\n        {\n            \"_k\": 1000, \"_T\": 300,\n            \"centers\": [0.0, 0.5, 1.0],\n            \"stdevs\": [0.05, 0.045, 0.05],\n            \"tau\": 2.0\n        },\n        {\n            \"_k\": 200, \"_T\": 300,\n            \"centers\": [0.0, 0.25, 0.5, 0.75, 1.0],\n            \"stdevs\": [0.112, 0.112, 0.112, 0.112, 0.112],\n            \"tau\": 4.0\n        },\n        {\n            \"_k\": 100, \"_T\": 300,\n            \"centers\": [0.0, 0.2, 0.4],\n            \"stdevs\": [0.158, 0.158, 0.158],\n            \"tau\": 2.5\n        },\n        {\n            \"_k\": 5000, \"_T\": 300,\n            \"centers\": [0.0, 1.0],\n            \"stdevs\": [0.022, 0.022],\n            \"tau\": 1.5\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        final_window_count = run_adaptive_scheme(\n            case[\"centers\"], case[\"stdevs\"], case[\"tau\"]\n        )\n        results.append(final_window_count)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3499551"}, {"introduction": "即使经过了仔细的设计和设置，模拟也可能产生不符合物理现实的结果。一项关键技能是能够诊断输出并追溯错误的根源。这个练习 [@problem_id:2466493] 提出了一个常见情景——计算出的能垒过高得不切实际——并要求你构建一个严谨的清单，以排查模拟和分析过程中可能出现的各种错误。", "problem": "您使用伞形采样来计算配体沿质心分离坐标 $r$ 从蛋白质中脱离的平均力势，其中使用了 $M$ 个谐振窗口，偏置势为 $w_i(r)=\\tfrac{1}{2}k_i\\left(r-r_i\\right)^2$。您使用加权直方图分析方法 (WHAM) 将这些数据结合起来。结果曲线在解离区域显示出大约 $80\\ \\mathrm{kcal\\ mol^{-1}}$ 的单个势垒，这对于在接近 $T\\approx 300\\ \\mathrm{K}$ 的典型分子动力学 (MD) 条件下的小分子配体来说，在物理上是不切实际的。为了诊断这个虚高的势垒，下列哪些项目构成了一个您应首先调查的模拟或分析问题的严格检查清单？请选择所有适用项。\n\nA. 每个窗口的采样不足，以及沿 $r$ 轴相邻偏置窗口之间的重叠不足，导致对无偏置概率密度的统计重建效果差。\n\nB. 忽略了三维径向坐标的度量 (雅可比) 因子，即在将偏置直方图转换为一维平均力势 $W(r)$ 时，忽略了 $r^2$ 的简并度。\n\nC. 周期性模拟盒子太小，导致在较大的 $r$ 值处，配体或蛋白质与其周期性映像发生相互作用，从而破坏了 $W(r)$ 的渐近区域和势垒区域。\n\nD. 选择 $2\\ \\mathrm{fs}$ 而非 $1\\ \\mathrm{fs}$ 的 MD 积分时间步长，而所有其他模拟参数都稳定且收敛良好。\n\nE. 模拟与分析之间的单位不匹配，例如，将以 $\\mathrm{kJ\\ mol^{-1}\\ nm^{-2}}$ 为单位的力常数当作以 $\\mathrm{kcal\\ mol^{-1}\\ nm^{-2}}$ 为单位处理，或在分析过程中将以 $\\mathrm{nm}$ 为单位的 $r$ 解释为其他长度单位。\n\nF. 在将 $W(r)$ 的渐近区域映射到绝对结合自由能时，忽略了标准态校正。\n\nG. 选择了不当的反应坐标，强制系统采用非物理路径（例如，原始的质心距离迫使配体穿过蛋白质的空间位阻），从而在偏置采样过程中产生大量的非平衡功和高势垒。\n\nH. 在 WHAM 或多态贝内特接受率 (MBAR) 分析中使用了不正确的温度，即使用了与模拟温度 $T$ 不一致的 $\\beta=1/\\left(k_{\\mathrm{B}}T\\right)$，或在不同窗口间混合使用了不同的 $\\beta$ 值。", "solution": "对问题陈述进行验证。\n\n**第 1 步：提取已知条件**\n- **方法**：使用伞形采样计算平均力势 (PMF)，即 $W(r)$。\n- **反应坐标**：质心分离距离，$r$。\n- **偏置**：$M$ 个谐振窗口，偏置势为 $w_i(r)=\\tfrac{1}{2}k_i\\left(r-r_i\\right)^2$。\n- **分析**：使用加权直方图分析方法 (WHAM) 结合数据。\n- **结果**：计算出的 PMF 在解离区域显示出约 $80\\ \\mathrm{kcal\\ mol^{-1}}$ 的单个势垒。\n- **背景**：小分子配体从蛋白质解离的模拟。\n- **模拟条件**：在 $T\\approx 300\\ \\mathrm{K}$ 附近的分子动力学 (MD)。\n- **前提**：$80\\ \\mathrm{kcal\\ mol^{-1}}$ 的势垒高度被认为是物理上不切实际的。\n- **目标**：确定一个严格的检查清单，列出诊断虚高势垒的潜在问题。\n\n**第 2 步：使用提取的已知条件进行验证**\n该问题描述了计算化学中的一个常见场景：增强采样模拟产生了物理上难以置信的结果。\n- **科学基础**：该问题牢固地植根于统计力学和计算生物物理学的原理。伞形采样、WHAM 和 PMF 计算都是标准技术。对于一个典型的非共价配体-蛋白质复合物，在 $300\\ \\mathrm{K}$ 下 $80\\ \\mathrm{kcal\\ mol^{-1}}$ 的解离势垒确实在物理上是不切实际的，因为它意味着解离时间尺度长达数十亿年，远远超过了此类系统的典型时间（微秒到小时）。因此，该前提在事实上是可靠的。\n- **适定性**：该问题是适定的。它提出了一个具体的观察结果（异常高的势垒），并要求从给定的列表中找出可能的根本原因。根据该领域已建立的最佳实践和常见陷阱，可以推导出一组确定的正确答案。\n- **客观性**：该问题使用计算化学领域常见的精确、客观和技术性的语言进行陈述。它没有歧义和主观论断。\n\n**第 3 步：结论与行动**\n问题陈述是有效的。它具有科学依据、适定且客观。它代表了一个计算科学中现实的诊断练习。下面将进行分析。\n\n伞形采样与 WHAM 结合的目标是计算沿反应坐标 $r$ 的平均力势或自由能曲线 $W(r)$。PMF 与无偏置概率分布函数 $P(r)$ 通过统计力学中的基本关系相关联：\n$$W(r) = -k_{\\mathrm{B}}T \\ln P(r) + C$$\n其中 $k_{\\mathrm{B}}$ 是玻尔兹曼常数，$T$ 是绝对温度，$C$ 是一个任意常数。$80\\ \\mathrm{kcal\\ mol^{-1}}$ 的误差异常巨大，因为在 $T=300\\ \\mathrm{K}$ 时，$k_{\\mathrm{B}}T \\approx 0.6\\ \\mathrm{kcal\\ mol^{-1}}$。如此大的误差表明问题不在于微小的不准确性，而在于模拟设置、执行或分析中存在根本性缺陷。必须评估每个选项作为此类灾难性失败的潜在来源。\n\n**A. 每个窗口的采样不足，以及沿 $r$ 轴相邻偏置窗口之间的重叠不足，导致对无偏置概率密度的统计重建效果差。**\nWHAM 算法依赖于来自相邻窗口 $i$ 和 $i+1$ 的采样分布 $P_i(r)$ 之间有足够的统计重叠。如果窗口相距太远，或者每个窗口内的采样时间太短，直方图就会有很大的噪声并且重叠不足。这会导致 WHAM 中的方程组呈病态，从而产生巨大的统计误差，并可能造成人为势垒或急剧抬高现有势垒。不收敛是 PMF 计算中最常见和最严重的问题之一。因此，验证采样收敛性和直方图重叠是一个首要且必要的诊断步骤。\n**结论：正确**\n\n**B. 忽略了三维径向坐标的度量 (雅可比) 因子，即在将偏置直方图转换为一维平均力势 $W(r)$ 时，忽略了 $r^2$ 的简并度。**\n反应坐标 $r$ 是从三维系统导出的一维距离。在 $r$ 和 $r+dr$ 之间的球壳体积为 $4\\pi r^2 dr$。因此，在该壳层中找到系统的概率与 $r^2$ 成正比。用于定义 PMF 的一维概率密度 $P(r)$ 必须考虑这个几何因子。PMF 的正确计算公式为 $W(r) = -k_{\\mathrm{B}}T \\ln(N(r)/r^2) + C'$，其中 $N(r)$ 是原始直方图计数。这等同于在“朴素”的 PMF 上添加一个校正项 $-k_{\\mathrm{B}}T \\ln(r^2)$。忽略这个雅可比校正是根本性的方法论错误。该项表示随着可用体积随 $r$ 增加而导致的构象熵变化。忽略它会使得大 $r$ 处的自由能相对于小 $r$ 处被人为地抬高，从而增加了表观势垒高度。在 $T=300\\ \\mathrm{K}$ 时，在一个典型的解离路径上（例如，从 $r=5\\ \\mathrm{\\AA}$到 $r=25\\ \\mathrm{\\AA}$），这个误差的量级为 $2k_{\\mathrm{B}}T \\ln(25/5) = 2(0.6\\ \\mathrm{kcal\\ mol^{-1}}) \\ln(5) \\approx 1.9\\ \\mathrm{kcal\\ mol^{-1}}$。虽然仅此一项不能解释 $80\\ \\mathrm{kcal\\ mol^{-1}}$ 的势垒，但它是一个系统误差，必须列在任何涉及径向坐标的 PMF 计算的严格检查清单上。\n**结论：正确**\n\n**C. 周期性模拟盒子太小，导致在较大的 $r$ 值处，配体或蛋白质与其周期性映像发生相互作用，从而破坏了 $W(r)$ 的渐近区域和势垒区域。**\n在使用周期性边界条件的模拟中，系统在所有方向上被复制。如果模拟盒子不够大，当配体从蛋白质解离时（$r$ 增加），它将开始与蛋白质的周期性映像相互作用。最小镜像约定将导致测量的距离被人为地减小，并且会发生虚假的静电和范德华相互作用。这些有限尺寸效应会阻止 PMF 在大 $r$ 处正确地达到平台期，通常会导致其曲线向上或向下弯曲，这严重破坏了未结合状态的定义，从而也破坏了总势垒高度。这是模拟设置中一个关键且常见的错误。\n**结论：正确**\n\n**D. 选择 $2\\ \\mathrm{fs}$ 而非 $1\\ \\mathrm{fs}$ 的 MD 积分时间步长，而所有其他模拟参数都稳定且收敛良好。**\n在使用如 SHAKE 或 LINCS 等算法来约束涉及氢原子的键的运动时，$2\\ \\mathrm{fs}$ 的时间步长是生物分子模拟的标准做法。问题陈述中提到模拟是稳定且收敛良好的，这意味着选择此时间步长并未导致灾难性的积分失败。虽然更小的时间步长可能提供稍好一些的能量守恒，但它极不可能是导致 $80\\ \\mathrm{kcal\\ mol^{-1}}$ 这样大的系统误差的原因。如此大的误差指向计算的物理、统计或逻辑上的缺陷，而非微小的积分不准确性。\n**结论：不正确**\n\n**E. 模拟与分析之间的单位不匹配，例如，将以 $\\mathrm{kJ\\ mol^{-1}\\ nm^{-2}}$ 为单位的力常数当作以 $\\mathrm{kcal\\ mol^{-1}\\ nm^{-2}}$ 为单位处理，或在分析过程中将以 $\\mathrm{nm}$ 为单位的 $r$ 解释为其他长度单位。**\n这代表了一类简单但具有毁灭性后果的人为错误。例如，$1\\ \\mathrm{kcal} \\approx 4.184\\ \\mathrm{kJ}$。如果将 MD 模拟的势能（例如，单位为 $\\mathrm{kcal\\ mol^{-1}}$）输入一个期望能量单位为 $\\mathrm{kJ\\ mol^{-1}}$ 的 WHAM 程序，得到的 PMF 势垒将被高估约 $4.184$ 倍。一个真实的 $\\approx 19\\ \\mathrm{kcal\\ mol^{-1}}$ 势垒将显示为 $80\\ \\mathrm{kcal\\ mol^{-1}}$。类似地，力常数 $k_i$ 或坐标 $r$ 的单位不匹配（例如，$\\mathrm{\\AA}$ vs. $\\mathrm{nm}$）将导致偏置势在数量级上出错，从而破坏采样和后续分析的有效性。这类与单位相关的错误是导致巨大系统误差的一个非常常见的来源，必须作为最先检查的事项之一。\n**结论：正确**\n\n**F. 在将 $W(r)$ 的渐近区域映射到绝对结合自由能时，忽略了标准态校正。**\n标准态校正 $\\Delta G_{\\mathrm{corr}} = -k_{\\mathrm{B}}T \\ln(C^\\circ V_{\\mathrm{site}})$ 是一个在 PMF 曲线计算*之后*添加的项。它用于将从 PMF 推导出的结合自由能（对应于特定的相互作用体积 $V_{\\mathrm{site}}$）转换为标准浓度 $C^\\circ$（通常为 $1\\ \\mathrm{M}$）。此校正影响的是标准结合自由能 $\\Delta G^\\circ_{bind}$ 的最终单一值，而不是 $W(r)$ 曲线本身的形状或势垒高度。问题出在曲线内部的势垒，而不是由它推导出的最终热力学数值。\n**结论：不正确**\n\n**G. 选择了不当的反应坐标，强制系统采用非物理路径（例如，原始的质心距离迫使配体穿过蛋白质的空间位阻），从而在偏置采样过程中产生大量的非平衡功和高势垒。**\nPMF 给出的是沿着所选路径的自由能，该路径被假定为真实反应途径的合理表示。如果所选的一维坐标（例如，质心距离）是对复杂的多维解离过程的不良描述符，它可能会迫使系统翻越一个非物理的、高能量的路径。例如，它可能直接将配体拉过一个蛋白质环，而配体本应自然地绕过该环。计算出的 PMF 将正确地报告这个空间受阻的非物理路径具有非常高的自由能。这不是伞形采样方法本身的失败，而是实验设计上的失败。其结果是一个反映显著非平衡功而非平衡自由能势垒的巨大势垒。这是一个基本的概念性错误，是虚高势垒的主要怀疑对象。\n**结论：正确**\n\n**H. 在 WHAM 或多态贝内特接受率 (MBAR) 分析中使用了不正确的温度，即使用了与模拟温度 $T$ 不一致的 $\\beta=1/\\left(k_{\\mathrm{B}}T\\right)$，或在不同窗口间混合使用了不同的 $\\beta$ 值。**\nWHAM 方程使用逆温度 $\\beta = 1/(k_{\\mathrm{B}}T)$ 来对数据进行去偏并重建自由能曲线。最终的 PMF，$W(r)$，是以能量单位表示的。如果模拟在温度 $T_{\\mathrm{sim}}$ 下运行，但分析时使用了不正确的温度 $T_{\\mathrm{analysis}}$，那么得到的自由能曲线将被错误地缩放。WHAM 方程本质上是求解 $W(r) / (k_{\\mathrm{B}}T_{\\mathrm{analysis}})$。如果指定了一个与 $T_{\\mathrm{sim}}$ 大不相同的温度 $T_{\\mathrm{analysis}}$，得到的能量曲线将被缩放因子 $T_{\\mathrm{analysis}}/T_{\\mathrm{sim}}$ 影响。例如，如果 $T_{\\mathrm{sim}} = 300\\ \\mathrm{K}$，但在 WHAM 分析中错误地使用了以 $\\mathrm{kcal\\ mol^{-1}}$ 为单位的能量，并使用了对应于 $T=30\\ \\mathrm{K}$ 的 $\\beta$ 值，最终的势垒将被高估十倍。一个 $8\\ \\mathrm{kcal\\ mol^{-1}}$ 的势垒将显示为 $80\\ \\mathrm{kcal\\ mol^{-1}}$。这是另一个直接导致 PMF 巨大、系统性缩放的简单人为错误。\n**结论：正确**", "answer": "$$\\boxed{ABCEGH}$$", "id": "2466493"}]}