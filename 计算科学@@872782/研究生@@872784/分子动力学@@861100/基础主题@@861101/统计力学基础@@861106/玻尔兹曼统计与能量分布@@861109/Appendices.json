{"hands_on_practices": [{"introduction": "在分子动力学模拟中，温度并非一个静态参数，而是一个随系统动能变化的动态观测量。本练习将通过要求您从正则系综的第一性原理出发，推导总动能 $K$ 的概率分布，从而对这一关系进行基础性探究。通过分析瞬时温度估计量 $T_{\\text{inst}} = \\frac{2K}{f k_\\mathrm{B}}$ 的性质，您将更深刻地理解宏观温度如何从微观涨落中涌现，以及自由度数目 $f$ 的重要性 [@problem_id:3398827]。", "problem": "考虑一个经典的分子动力学 (MD) 模拟，其中包含$N$个质量为$m$的全同点状粒子，它们在$d$维空间中运动，并与一个恒温器耦合，使得系统在绝对温度$T$下对正则系综进行抽样。假设只有动量自由度对动能有贡献，并且全局约束（如固定的质心动量）已被考虑在内，从而剩下$f$个独立的二次型动量自由度。瞬时动能定义为 $K = \\sum_{i=1}^{f} \\frac{p_{i}^{2}}{2m}$，其中$p_{i}$是独立的动量分量。玻尔兹曼常数记为$k_{\\mathrm{B}}$。\n\n从动量的正则系综出发，其中概率密度正比于$\\exp(-\\beta K)$（逆热能为$\\beta = 1/(k_{\\mathrm{B}} T)$），通过将动量矢量视为$f$维空间中的一个点并计算具有固定$K$的态的数量，来推导瞬时动能$K$的概率密度。然后使用此密度来构建和分析瞬时温度估计量\n$$\nT_{\\text{inst}} = \\frac{2K}{f\\,k_{\\mathrm{B}}}.\n$$\n判断对于有限的$f$，$T_{\\text{inst}}$是否有偏，并以闭合形式计算其在有限$f$下的方差。你的推导必须从适用于正则系综的第一性原理出发，并且不使用任何未经证明的快捷公式。以开尔文平方为单位表示最终的方差。以$f$和$T$的单个解析表达式形式给出你的最终答案。不需要四舍五入。", "solution": "问题要求推导正则系综中系统的动能$K$的概率分布，然后利用此分布来分析瞬时温度估计量$T_{\\text{inst}}$的性质。\n\n### 步骤 1：问题验证\n\n**1.1. 提取已知条件：**\n- 系统：在$d$维空间中的$N$个质量为$m$的全同点状粒子。\n- 系综：绝对温度为$T$的正则系综。\n- 自由度：$f$个独立的二次型动量自由度。\n- 动能定义：$K = \\sum_{i=1}^{f} \\frac{p_{i}^{2}}{2m}$。\n- 动量分量：$p_{i}$，其中$i=1, \\dots, f$。\n- 玻尔兹曼常数：$k_{\\mathrm{B}}$。\n- 逆热能：$\\beta = 1/(k_{\\mathrm{B}} T)$。\n- 动量概率密度：正比于$\\exp(-\\beta K)$。\n- 瞬时温度估计量：$T_{\\text{inst}} = \\frac{2K}{f\\,k_{\\mathrm{B}}}$。\n\n**1.2. 验证：**\n- **科学依据：** 该问题牢固地植根于经典统计力学和热力学，特别是正则系综。所有概念和定义都是标准的、科学上合理的。\n- **适定性：** 该问题提供了明确的目标和足够的信息来推导所需的量。预期会有一个唯一且有意义的解。\n- **客观性：** 问题的陈述语言精确、客观，没有歧义或主观论断。\n\n**1.3. 结论：**\n该问题是有效的。它是一个适定的、有科学依据的统计物理学问题。可以开始求解过程。\n\n### 步骤 2：动能概率密度 $P(K)$ 的推导\n\n系统处于动量矢量为 $\\mathbf{p} = (p_1, p_2, \\dots, p_f)$ 的微观态的概率密度由正则系综的玻尔兹曼分布给出：\n$$\nP(\\mathbf{p}) = \\frac{1}{Z_p} \\exp(-\\beta K) = \\frac{1}{Z_p} \\exp\\left(-\\frac{\\beta}{2m} \\sum_{i=1}^{f} p_i^2\\right)\n$$\n其中 $Z_p$ 是动量配分函数，它作为归一化常数。$Z_p$ 通过对所有可能的动量分量值进行积分来求得：\n$$\nZ_p = \\int_{-\\infty}^{\\infty} \\dots \\int_{-\\infty}^{\\infty} \\exp\\left(-\\frac{\\beta}{2m} \\sum_{i=1}^{f} p_i^2\\right) dp_1 \\dots dp_f\n$$\n由于和的指数是指数的乘积，这个$f$维积分可以分解为$f$个相同的一维高斯积分的乘积：\n$$\nZ_p = \\left[ \\int_{-\\infty}^{\\infty} \\exp\\left(-\\frac{\\beta}{2m} p^2\\right) dp \\right]^f\n$$\n使用标准积分公式 $\\int_{-\\infty}^{\\infty} \\exp(-ax^2) dx = \\sqrt{\\pi/a}$，并令 $a = \\beta/(2m)$，我们得到：\n$$\nZ_p = \\left( \\sqrt{\\frac{2m\\pi}{\\beta}} \\right)^f = (2m\\pi k_\\mathrm{B} T)^{f/2}\n$$\n接下来，我们求动能$K$的概率密度$P(K)$。找到能量在 $K$ 和 $K+dK$ 之间的概率，是通过在对应于此能量范围的动量空间区域上对 $P(\\mathbf{p})$ 进行积分得到的。由于 $P(\\mathbf{p})$ 仅依赖于 $K = \\sum p_i^2 / (2m)$，因此它在由固定$K$定义的表面上是常数。这个表面 $2mK = \\sum p_i^2$ 是$f$维动量空间中半径为 $R_p = \\sqrt{2mK}$ 的一个超球面。\n\n能量在 $K$ 和 $K+dK$ 之间的薄壳体积由 $\\Omega(K)dK$ 给出。我们可以通过计算半径为 $R_p$ 的超球面的表面积并乘以其厚度 $dR_p$ 来求得。半径为$R$的$f$维球体的表面积是 $S_f(R) = \\frac{2\\pi^{f/2}}{\\Gamma(f/2)}R^{f-1}$。\n当 $R_p = \\sqrt{2mK}$ 时，壳的厚度为 $dR_p = \\frac{d}{dK}(\\sqrt{2mK}) dK = \\frac{1}{2}\\sqrt{\\frac{2m}{K}} dK$。\n\n因此，壳的体积是：\n$$\n\\Omega(K)dK = S_f(R_p) dR_p = \\frac{2\\pi^{f/2}}{\\Gamma(f/2)} (\\sqrt{2mK})^{f-1} \\left( \\frac{1}{2}\\sqrt{\\frac{2m}{K}} \\right) dK\n$$\n$$\n\\Omega(K)dK = \\frac{\\pi^{f/2}}{\\Gamma(f/2)} (2m)^{(f-1)/2} K^{(f-1)/2} (2m)^{1/2} K^{-1/2} dK = \\frac{(2m\\pi)^{f/2}}{\\Gamma(f/2)} K^{f/2 - 1} dK\n$$\n概率 $P(K)dK$ 是壳上的概率密度 $\\frac{1}{Z_p}\\exp(-\\beta K)$ 与壳的体积 $\\Omega(K)dK$ 的乘积。\n$$\nP(K)dK = \\frac{1}{Z_p} \\exp(-\\beta K) \\Omega(K)dK = \\frac{1}{(2m\\pi/\\beta)^{f/2}} \\exp(-\\beta K) \\frac{(2m\\pi)^{f/2}}{\\Gamma(f/2)} K^{f/2 - 1} dK\n$$\n代入 $1/\\beta = k_\\mathrm{B} T$，我们看到 $(2m\\pi)^{f/2}$ 项相互抵消：\n$$\nP(K) = \\frac{\\beta^{f/2}}{\\Gamma(f/2)} K^{f/2 - 1} \\exp(-\\beta K)\n$$\n这是形状参数为 $\\alpha = f/2$、速率参数为 $\\beta$ 的伽马分布的概率密度函数。\n\n### 步骤 3：温度估计量 $T_{\\text{inst}}$ 的分析\n\n瞬时温度估计量由 $T_{\\text{inst}} = \\frac{2K}{f k_\\mathrm{B}}$ 给出。\n\n**3.1. 估计量的偏差**\n如果一个估计量的期望值等于真实参数值，则该估计量是无偏的。我们计算期望值 $\\langle T_{\\text{inst}} \\rangle$：\n$$\n\\langle T_{\\text{inst}} \\rangle = \\left\\langle \\frac{2K}{f k_\\mathrm{B}} \\right\\rangle = \\frac{2}{f k_\\mathrm{B}} \\langle K \\rangle\n$$\n我们必须使用推导出的概率密度$P(K)$来计算平均动能 $\\langle K \\rangle$：\n$$\n\\langle K \\rangle = \\int_0^\\infty K P(K) dK = \\frac{\\beta^{f/2}}{\\Gamma(f/2)} \\int_0^\\infty K \\cdot K^{f/2-1} \\exp(-\\beta K) dK = \\frac{\\beta^{f/2}}{\\Gamma(f/2)} \\int_0^\\infty K^{f/2} \\exp(-\\beta K) dK\n$$\n使用伽马函数的定义 $\\Gamma(z) = \\int_0^\\infty t^{z-1} e^{-t} dt$，我们进行变量替换 $u = \\beta K$，因此 $K = u/\\beta$ 且 $dK = du/\\beta$：\n$$\n\\int_0^\\infty K^{f/2} \\exp(-\\beta K) dK = \\int_0^\\infty \\left(\\frac{u}{\\beta}\\right)^{f/2} e^{-u} \\frac{du}{\\beta} = \\frac{1}{\\beta^{f/2+1}} \\int_0^\\infty u^{f/2} e^{-u} du = \\frac{\\Gamma(f/2 + 1)}{\\beta^{f/2+1}}\n$$\n将此结果代回 $\\langle K \\rangle$ 的表达式中：\n$$\n\\langle K \\rangle = \\frac{\\beta^{f/2}}{\\Gamma(f/2)} \\frac{\\Gamma(f/2 + 1)}{\\beta^{f/2+1}} = \\frac{1}{\\beta} \\frac{\\Gamma(f/2+1)}{\\Gamma(f/2)}\n$$\n使用性质 $\\Gamma(z+1)=z\\Gamma(z)$，我们有 $\\Gamma(f/2+1) = (f/2)\\Gamma(f/2)$。\n$$\n\\langle K \\rangle = \\frac{1}{\\beta} \\frac{(f/2)\\Gamma(f/2)}{\\Gamma(f/2)} = \\frac{f}{2\\beta} = \\frac{f}{2} k_\\mathrm{B} T\n$$\n这个结果就是能量均分定理，这里是从第一性原理推导出来的。现在我们求估计量的期望：\n$$\n\\langle T_{\\text{inst}} \\rangle = \\frac{2}{f k_\\mathrm{B}} \\langle K \\rangle = \\frac{2}{f k_\\mathrm{B}} \\left(\\frac{f}{2} k_\\mathrm{B} T\\right) = T\n$$\n由于 $\\langle T_{\\text{inst}} \\rangle = T$，对于任何有限的自由度数$f$，该估计量都是**无偏**的。\n\n**3.2. 估计量的方差**\n$T_{\\text{inst}}$ 的方差由 $\\text{Var}(T_{\\text{inst}}) = \\langle T_{\\text{inst}}^2 \\rangle - \\langle T_{\\text{inst}} \\rangle^2$ 给出。我们已经求得 $\\langle T_{\\text{inst}} \\rangle = T$。现在我们需要计算 $\\langle T_{\\text{inst}}^2 \\rangle$。\n$$\n\\langle T_{\\text{inst}}^2 \\rangle = \\left\\langle \\left( \\frac{2K}{f k_\\mathrm{B}} \\right)^2 \\right\\rangle = \\frac{4}{(f k_\\mathrm{B})^2} \\langle K^2 \\rangle\n$$\n我们计算二阶矩 $\\langle K^2 \\rangle$：\n$$\n\\langle K^2 \\rangle = \\int_0^\\infty K^2 P(K) dK = \\frac{\\beta^{f/2}}{\\Gamma(f/2)} \\int_0^\\infty K^{f/2+1} \\exp(-\\beta K) dK\n$$\n使用相同的替换 $u=\\beta K$，积分变为：\n$$\n\\int_0^\\infty K^{f/2+1} \\exp(-\\beta K) dK = \\frac{1}{\\beta^{f/2+2}} \\int_0^\\infty u^{f/2+1} e^{-u} du = \\frac{\\Gamma(f/2+2)}{\\beta^{f/2+2}}\n$$\n所以，$K$的二阶矩是：\n$$\n\\langle K^2 \\rangle = \\frac{\\beta^{f/2}}{\\Gamma(f/2)} \\frac{\\Gamma(f/2+2)}{\\beta^{f/2+2}} = \\frac{1}{\\beta^2} \\frac{\\Gamma(f/2+2)}{\\Gamma(f/2)}\n$$\n使用 $\\Gamma(z+2) = (z+1)z\\Gamma(z)$：\n$$\n\\langle K^2 \\rangle = \\frac{1}{\\beta^2} \\frac{(f/2+1)(f/2)\\Gamma(f/2)}{\\Gamma(f/2)} = \\frac{1}{\\beta^2} \\left(\\frac{f^2}{4} + \\frac{f}{2}\\right) = (k_\\mathrm{B} T)^2 \\left(\\frac{f^2}{4} + \\frac{f}{2}\\right)\n$$\n现在，将此结果代入 $\\langle T_{\\text{inst}}^2 \\rangle$ 的表达式中：\n$$\n\\langle T_{\\text{inst}}^2 \\rangle = \\frac{4}{(f k_\\mathrm{B})^2} \\langle K^2 \\rangle = \\frac{4}{f^2 k_\\mathrm{B}^2} (k_\\mathrm{B} T)^2 \\left(\\frac{f^2}{4} + \\frac{f}{2}\\right) = \\frac{4T^2}{f^2} \\left(\\frac{f^2}{4} + \\frac{f}{2}\\right) = T^2 \\left(1 + \\frac{2}{f}\\right)\n$$\n最后，我们计算 $T_{\\text{inst}}$ 的方差：\n$$\n\\text{Var}(T_{\\text{inst}}) = \\langle T_{\\text{inst}}^2 \\rangle - \\langle T_{\\text{inst}} \\rangle^2 = T^2 \\left(1 + \\frac{2}{f}\\right) - T^2 = T^2 + \\frac{2T^2}{f} - T^2 = \\frac{2T^2}{f}\n$$\n对于有限的$f$，方差不为零，这表明虽然估计量是无偏的，但它会围绕真实平均温度$T$波动。这些波动的幅度随着自由度数$f$的增加而以$1/f$的形式减小。单位是温度的平方（开尔文平方），符合要求。", "answer": "$$\\boxed{\\frac{2T^{2}}{f}}$$", "id": "3398827"}, {"introduction": "前一个练习表明，动能分布严格依赖于系统的自由度数目 $f$。本练习将处理一个实际挑战：在真实的模拟中，我们如何确定复杂分子系统的 $f$ 值，因为在这些模拟中，通常会施加各种约束来模拟分子或控制系统的整体运动。您将学习完整约束（holonomic constraints），例如刚性键和固定的质心动量，是如何减少独立二次运动模式的数量的，这是精确计算温度和验证模拟方案的关键一步 [@problem_id:3398868]。", "problem": "考虑一个在三维空间中对混合物进行的正则系综（粒子数、体积和温度恒定）下的分子动力学模拟。该系统包含 $n_A = 200$ 个单原子粒子和 $n_{B_2} = 50$ 个双原子分子，因此原子总数为 $N = n_A + 2 n_{B_2}$。双原子分子通过完整约束算法实现完全刚性的键长来建模，并且模拟通过始终将总质心线动量固定为零来消除整体漂移。假设所有约束都是独立的，并且恒温器产生限制在约束流形上的 Maxwell–Boltzmann 分布。\n\n从动量的正则 Boltzmann 分布出发，推导速度上的线性约束如何减少计入动能 $K$ 的有效独立二次自由度数 $f$。然后，对于这个特定系统，计算与标量变量 $X = 2K/(k_\\mathrm{B} T)$ 相关的卡方分布的参数，其中 $k_\\mathrm{B}$ 是 Boltzmann 常数，$T$ 是绝对温度。将最终结果表示为一个不进行四舍五入且不带单位的精确整数。清楚地论证由于质心动量固定和刚性键长约束导致的 $f$ 的每次减少。", "solution": "该问题要求我们确定与受约束分子系统的归一化总动能相关的卡方分布的参数。该参数等同于有效独立二次自由度数，记为 $f$。\n\n一个包含 $N$ 个粒子的三维系统的总动能 $K$ 由所有笛卡尔动量分量的和给出：\n$$\nK = \\sum_{i=1}^{N} \\frac{1}{2m_i} (p_{ix}^2 + p_{iy}^2 + p_{iz}^2)\n$$\n在温度为 $T$ 的正则系综中，每个动量分量 $p_{j}$ 是一个从均值为零、方差为 $m k_\\mathrm{B} T$ 的高斯分布中抽取的随机变量，其中 $m$ 是与该分量相关的质量。因此，变量 $\\frac{p_j}{\\sqrt{m k_\\mathrm{B} T}}$ 服从标准正态分布。量 $X = \\frac{2K}{k_\\mathrm{B} T}$ 可以表示为：\n$$\nX = \\frac{2}{k_\\mathrm{B} T} \\sum_{i=1}^{N} \\frac{1}{2m_i} (p_{ix}^2 + p_{iy}^2 + p_{iz}^2) = \\sum_{i=1}^{N} \\left[ \\left(\\frac{p_{ix}}{\\sqrt{m_i k_\\mathrm{B} T}}\\right)^2 + \\left(\\frac{p_{iy}}{\\sqrt{m_i k_\\mathrm{B} T}}\\right)^2 + \\left(\\frac{p_{iz}}{\\sqrt{m_i k_\\mathrm{B} T}}\\right)^2 \\right]\n$$\n如果所有 $3N$ 个动量分量都是独立的，那么 $X$ 将是 $3N$ 个标准正态变量的平方和，因此服从自由度为 $3N$ 的卡方分布，即 $\\chi^2(3N)$。\n\n然而，该系统受到速度（因此也包括动量）的约束，这减少了独立动量分量的数量。每个对速度的独立线性约束会从系统中移除一个自由度。有效自由度数 $f$ 是初始总自由度数减去独立约束的总数。\n\n首先，我们确定系统中的原子总数 $N$。该系统包含 $n_A = 200$ 个单原子粒子和 $n_{B_2} = 50$ 个双原子分子。\n$$\nN = n_A + 2 n_{B_2} = 200 + 2(50) = 200 + 100 = 300 \\text{ 个原子}\n$$\n系统处于三维空间中 ($d=3$)。初始平动自由度的总数是：\n$$\nf_{\\text{initial}} = d \\times N = 3 \\times 300 = 900\n$$\n\n接下来，我们列举施加在系统上的约束。\n\n1.  **刚性键长约束**：系统包含 $n_{B_2} = 50$ 个双原子分子，每个分子都有一个完全刚性的键。两个原子（例如原子 $i$ 和原子 $j$）之间的刚性键是对它们位置的一个完整约束：\n    $$\n    (\\mathbf{r}_i - \\mathbf{r}_j) \\cdot (\\mathbf{r}_i - \\mathbf{r}_j) - d_{ij}^2 = 0\n    $$\n    其中 $d_{ij}$ 是固定的键长。对该式关于时间求导，得到一个对速度的约束：\n    $$\n    2(\\mathbf{r}_i - \\mathbf{r}_j) \\cdot (\\mathbf{v}_i - \\mathbf{v}_j) = 0\n    $$\n    对于每个刚性键，这是一个关于速度分量的单一线性方程。因为有 $n_{B_2} = 50$ 个这样的分子，所以有 50 个此类独立约束。来自刚性键的约束数量为 $c_{\\text{bonds}} = 50$。\n\n2.  **质心动量约束**：系统的总线动量 $\\mathbf{P}$ 固定为零。总动量是各个粒子动量的和：\n    $$\n    \\mathbf{P} = \\sum_{i=1}^{N} m_i \\mathbf{v}_i = \\mathbf{0}\n    $$\n    这是一个三维空间中的矢量方程，等价于三个关于总动量笛卡尔分量的独立标量方程：\n    \\begin{align*}\n    P_x = \\sum_{i=1}^{N} m_i v_{ix} = 0 \\\\\n    P_y = \\sum_{i=1}^{N} m_i v_{iy} = 0 \\\\\n    P_z = \\sum_{i=1}^{N} m_i v_{iz} = 0\n    \\end{align*}\n    这三个方程代表了对粒子速度的三个线性约束。来自固定质心动量的约束数量为 $c_{\\text{COM}} = 3$。\n\n问题陈述所有约束都是独立的。因此，约束总数 $c_{\\text{total}}$ 是来自键的约束和来自质心动量的约束之和。\n$$\nc_{\\text{total}} = c_{\\text{bonds}} + c_{\\text{COM}} = 50 + 3 = 53\n$$\n\n有效独立二次自由度数 $f$ 是初始自由度数减去约束总数：\n$$\nf = f_{\\text{initial}} - c_{\\text{total}} = 900 - 53 = 847\n$$\n\n这个值 $f=847$，是构成量 $X = 2K/(k_\\mathrm{B} T)$ 的独立标准正态变量平方和的个数。根据定义，$X$ 服从自由度为 $f$ 的卡方分布，记为 $\\chi^2(f)$。该分布的参数就是其自由度数。\n\n因此，$X$ 的卡方分布的参数是 847。", "answer": "$$\\boxed{847}$$", "id": "3398868"}, {"introduction": "这最后一个练习将理论与计算分析相结合，挑战您进行逆向工作：给定来自模拟的动能数据流，您能否推断出系统的有效自由度 $f_{\\text{eff}}$？通过基于动能的伽马分布（Gamma distribution）实现一个最大似然估计器，您将开发出一个强大的诊断工具，用以验证模拟是否在正确地抽样正则系综，或者是否存在来自恒温器或约束的伪影。这项动手编程练习巩固了能量分布的统计力学理论与分子动力学模拟的实践验证之间的联系 [@problem_id:3398873]。", "problem": "您的任务是开发一个完整的程序，使用玻尔兹曼统计在高等研究生水平上分析来自自分子动力学 (MD) 模拟的动能分布。该分析的制定和执行方式必须能够通过估算有效二次自由度数，揭示由于约束、刚体和恒温器伪影导致的与正则系综的偏差。\n\n这项任务的基础是正则系综和麦克斯韦-玻尔兹曼速度分布。从具有二次动能的系统的正则系综开始，其中在温度$T$的平衡状态下，每个二次自由度对总动能的贡献是加性的。使用经过充分检验的事实，即相空间中的正则概率密度与$\\exp(-\\beta H)$成正比，其中$\\beta = 1/(k_\\mathrm{B} T)$，动能是速度的二次方，且哈密顿量中独立的二次模式会产生独立的高斯速度分量。基于这些基础，推导出总动能的分布，并设计一个估算有效二次自由度数（记作$f_{\\text{eff}}$）的估算器。\n\n然后实现一个程序，对于一组给定的合成MD情景，执行以下步骤：\n- 使用物理上一致的参数模拟总动能$E_{\\text{kin}}$的独立样本，能量单位为$\\mathrm{J}$（焦耳），温度单位为$\\mathrm{K}$（开尔文）。\n- 将模拟的$E_{\\text{kin}}$分布拟合到由正则系综和二次动能结构所蕴含的参数族，以估计形状参数$k$，同时将绝对热能标度固定在$k_\\mathrm{B} T$，然后计算$f_{\\text{eff}} = 2 k$。\n- 对每个测试案例，汇总并以确切要求的输出格式报告估算出的$f_{\\text{eff}}$。\n\n您的程序必须从第一性原理实现以下估算原则：\n- 设$E_{\\text{kin}}$是在温度为$T$的正则系综中，$f$个二次自由度的总动能，玻尔兹曼常数为$k_\\mathrm{B}$。从正则系综推导出的参数模型的对数似然，在温度标度由恒温器固定为$\\theta = k_\\mathrm{B} T$的假设下，会导出一个关于形状参数$k$的单一非线性方程：\n$$ \\psi(k) = \\frac{1}{N} \\sum_{i=1}^{N} \\ln E_i - \\ln \\theta, $$\n其中$\\psi(\\cdot)$是双伽玛函数，$\\{E_i\\}_{i=1}^{N}$是观测到的动能样本，$\\theta = k_\\mathrm{B} T$，$N$是样本数量。对该方程进行数值求解，并报告$f_{\\text{eff}} = 2k$。\n\n该估算必须对现实的样本量和参数范围具有鲁棒性，并且必须使用有原则的数值方法可靠地收敛。您可以使用双伽玛函数和三伽玛函数。\n\n物理和数值单位：\n- 所有能量$E_{\\text{kin}}$必须以$\\mathrm{J}$（焦耳）为单位构建和处理。\n- 所有温度$T$必须以$\\mathrm{K}$（开尔文）为单位指定。\n- 玻尔兹曼常数必须是$k_\\mathrm{B} = 1.380649 \\times 10^{-23}\\,\\mathrm{J}\\,\\mathrm{K}^{-1}$。\n- 最终报告的$f_{\\text{eff}}$是无量纲实数，必须以浮点值输出。\n\n此问题不涉及角度单位。\n\n测试套件和参数规范：\n使用以下五种情景生成合成MD动能数据集并估算$f_{\\text{eff}}$。为了可复现性，对所有随机数生成使用固定的伪随机种子，等于$123456$。\n\n- 案例$1$（正则系综，理想情况）：\n  - 真实二次自由度：$f_{\\text{true}} = 300$。\n  - 温度：$T = 300\\,\\mathrm{K}$。\n  - 模拟器使用的热能标度：$\\theta_{\\text{eff}} = k_\\mathrm{B} T$。\n  - 独立样本数：$N = 50000$。\n  - 预期行为：估算器应返回接近$f_{\\text{true}}$的$f_{\\text{eff}}$。\n\n- 案例$2$（质心线动量受约束）：\n  - 真实二次自由度：$f_{\\text{true}} = 297$（从名义上的$300$中减去$3$）。\n  - 温度：$T = 300\\,\\mathrm{K}$。\n  - 模拟器使用的热能标度：$\\theta_{\\text{eff}} = k_\\mathrm{B} T$。\n  - 独立样本数：$N = 50000$。\n  - 预期行为：估算器应检测到减少，并返回接近$297$的$f_{\\text{eff}}$。\n\n- 案例$3$（刚体：10个自由刚体）：\n  - 真实二次自由度：$f_{\\text{true}} = 60$（每个刚体贡献$6$）。\n  - 温度：$T = 300\\,\\mathrm{K}$。\n  - 模拟器使用的热能标度：$\\theta_{\\text{eff}} = k_\\mathrm{B} T$。\n  - 独立样本数：$N = 50000$。\n  - 预期行为：估算器应返回接近$60$的$f_{\\text{eff}}$。\n\n- 案例$4$（非正则恒温器，能量涨落更窄）：\n  - 真实二次自由度：$f_{\\text{true}} = 300$。\n  - 估算器中用于设置固定热能标度的温度：$T = 300\\,\\mathrm{K}$，因此估算器中$\\theta = k_\\mathrm{B} T$。\n  - 模拟器使用的热能标度：$\\theta_{\\text{eff}} = 0.85\\,k_\\mathrm{B} T$。\n  - 独立样本数：$N = 50000$。\n  - 预期行为：估算器将$\\theta$固定在$k_\\mathrm{B} T$，为适应减小的涨落，应返回低于$300$的$f_{\\text{eff}}$。\n\n- 案例$5$（小样本量，边界情况）：\n  - 真实二次自由度：$f_{\\text{true}} = 6$。\n  - 温度：$T = 300\\,\\mathrm{K}$。\n  - 模拟器使用的热能标度：$\\theta_{\\text{eff}} = k_\\mathrm{B} T$。\n  - 独立样本数：$N = 50$。\n  - 预期行为：估算器应保持一致，但会表现出更大的抽样误差。\n\n数据生成协议：\n- 对每个案例，使用与正则二次自由度假设一致的参数模型生成总动能的独立样本：\n  - 设$k_{\\text{true}} = f_{\\text{true}}/2$，模拟器标度$\\theta_{\\text{eff}}$按规定设置。抽取$N$个独立样本$E_i \\sim \\text{Gamma}(k_{\\text{true}}, \\theta_{\\text{eff}})$，这对于正则系综中二次模式的总和在物理上是一致的。\n\n估算器实现协议：\n- 对每个案例，使用观测到的能量$\\{E_i\\}$和估算器中固定的标度$\\theta = k_\\mathrm{B} T$（注意在案例4中，模拟器使用$\\theta_{\\text{eff}} \\neq \\theta$），求解\n$$ \\psi(k) = \\frac{1}{N}\\sum_{i=1}^{N} \\ln E_i - \\ln \\theta $$\n中的$k$。采用鲁棒的数值方法（例如，使用三伽玛函数$\\psi^{(1)}(k)$的牛顿法），并进行正值初始化（例如，矩估计法$k_0 = \\bar{E}/\\theta$）并采取保护措施以维持$k > 0$。\n\n要求的最终输出格式：\n- 您的程序应生成一行输出，其中包含五个估算出的$f_{\\text{eff}}$值，按案例1到案例5的顺序排列，形式为用方括号括起来的逗号分隔列表。例如，输出必须是这种形式\n$[f_1,f_2,f_3,f_4,f_5]$\n其中每个$f_j$是一个浮点数。\n\n不允许用户输入、外部文件或网络访问；所有参数都在程序内部。最终程序必须是完整且可运行的。", "solution": "该问题要求开发一个程序，从合成的分子动力学 (MD) 动能数据中估算有效二次自由度数$f_{\\text{eff}}$。此估算基于统计力学中的正则系综原理。\n\n### 理论基础与动能分布的推导\n\n在正则系综中，一个与恒定绝对温度$T$的热浴处于热平衡的系统，其处于能量为$H$的微观状态的概率由玻尔兹曼分布给出，$P \\propto e^{-H/(k_\\mathrm{B} T)}$，其中$k_\\mathrm{B}$是玻尔兹曼常数。\n\n经典粒子系统的总动能$E_{\\text{kin}}$是速度（或动量）分量的二次项之和。对于一个有$f$个独立二次自由度的系统，总动能可以表示为$f$个独立项的和：\n$$\nE_{\\text{kin}} = \\sum_{i=1}^{f} \\epsilon_i\n$$\n根据能量均分定理，每个此类自由度的平均能量为$\\langle \\epsilon_i \\rangle = \\frac{1}{2} k_\\mathrm{B} T$。更根本地，每个动量分量服从高斯分布。相应的动能项（例如$\\frac{1}{2} m v_x^2$）因此服从自由度为1的卡方分布，这是伽马分布的一个特例。具体来说，每个能量项$\\epsilon_i$都是一个独立同分布的随机变量，服从形状参数$k=1/2$和尺度参数$\\theta = k_\\mathrm{B} T$的伽马分布。\n$$\n\\epsilon_i \\sim \\text{Gamma}\\left(k = \\frac{1}{2}, \\theta = k_\\mathrm{B} T\\right)\n$$\n伽马分布的一个关键特性是其可加性：具有相同尺度参数的独立伽马分布变量之和也服从伽马分布。所得分布的形状参数是各个形状参数之和。因此，对于具有$f$个独立二次自由度的系统，总动能$E_{\\text{kin}}$服从一个伽马分布：\n$$\nE_{\\text{kin}} \\sim \\text{Gamma}\\left(k = \\frac{f}{2}, \\theta = k_\\mathrm{B} T\\right)\n$$\n这个关系式$f_{\\text{eff}} = 2k$构成了我们分析的基础。通过估算动能分布的形状参数$k$，我们可以确定有效自由度数$f_{\\text{eff}} = 2k$。由于模拟中的伪影（如约束或非正则恒温器），这个$f_{\\text{eff}}$可能偏离名义上的自由度数。\n\n### 形状参数的最大似然估计\n\n问题指定了一个基于固定温度$T$的估算程序，这意味着尺度参数$\\theta = k_\\mathrm{B} T$是固定的。给定一组$N$个独立的动能样本$\\{E_i\\}_{i=1}^{N}$，我们必须估算形状参数$k$。我们使用最大似然估计 (MLE) 方法。\n\n具有形状参数$k$和尺度参数$\\theta$的伽马分布变量$E$的概率密度函数 (PDF) 为：\n$$\np(E; k, \\theta) = \\frac{E^{k-1} e^{-E/\\theta}}{\\Gamma(k) \\theta^k}\n$$\n其中$\\Gamma(k)$是伽马函数。对于$N$个观测能量的集合，将$\\theta$视为已知常数，其对数似然$\\mathcal{L}(k)$为：\n$$\n\\mathcal{L}(k) = \\ln \\left( \\prod_{i=1}^{N} p(E_i; k, \\theta) \\right) = \\sum_{i=1}^{N} \\ln p(E_i; k, \\theta)\n$$\n$$\n\\mathcal{L}(k) = \\sum_{i=1}^{N} \\left[ (k-1)\\ln E_i - \\frac{E_i}{\\theta} - k\\ln\\theta - \\ln\\Gamma(k) \\right]\n$$\n为了找到使该对数似然最大化的$k$值，我们对其关于$k$求导并设为零：\n$$\n\\frac{\\partial\\mathcal{L}}{\\partial k} = \\sum_{i=1}^{N} \\left[ \\ln E_i - \\ln\\theta - \\frac{d}{dk}\\ln\\Gamma(k) \\right] = 0\n$$\n引入双伽玛函数$\\psi(k) = \\frac{d}{dk}\\ln\\Gamma(k)$，我们得到：\n$$\n\\sum_{i=1}^{N} (\\ln E_i - \\ln\\theta) - N\\psi(k) = 0\n$$\n整理此方程可得到问题陈述中提供的表达式，必须求解该表达式以获得$k$：\n$$\n\\psi(k) = \\frac{1}{N} \\sum_{i=1}^{N} \\ln E_i - \\ln\\theta\n$$\n\n### 通过牛顿法进行数值求解\n\n这是一个关于$k$的非线性方程，我们用数值方法求解。牛顿法是一种强大而高效的选择。为了找到函数$g(k)=0$的根，该方法根据以下更新规则进行迭代：\n$$\nk_{n+1} = k_n - \\frac{g(k_n)}{g'(k_n)}\n$$\n我们定义需要置零的函数为$g(k) = \\psi(k) - C$，其中常数$C$是估算方程的经验确定右侧：\n$$\nC = \\frac{1}{N} \\sum_{i=1}^{N} \\ln E_i - \\ln(k_\\mathrm{B} T)\n$$\n$g(k)$关于$k$的导数是$g'(k) = \\frac{d}{dk}\\psi(k) = \\psi^{(1)}(k)$，其中$\\psi^{(1)}(k)$是三伽玛函数。\n我们特定问题的牛顿法更新规则是：\n$$\nk_{n+1} = k_n - \\frac{\\psi(k_n) - C}{\\psi^{(1)}(k_n)}\n$$\n- **初始化**：一个稳健的初始猜测$k_0$可以通过矩估计法获得。伽马分布变量的期望值是$\\langle E \\rangle = k \\theta$。我们可以用样本均值$\\bar{E}$来近似它，得到$k_0 = \\bar{E} / \\theta$。\n- **收敛性与稳定性**：迭代进行直到连续估计值之差$|k_{n+1} - k_n|$低于指定的容差。对于$k > 0$，三伽玛函数$\\psi^{(1)}(k)$总是正的，这意味着我们的目标函数$g(k)$是凸的。这个理想的性质确保了牛顿法将稳健地收敛到唯一的解。我们实现了一个安全措施，通过减小步长来确保$k$的估计值在整个迭代过程中保持正值，以防某次更新会导致$k \\le 0$。\n\n### 算法实现\n\n为了清晰和正确，程序被构造成三个主要部分：\n1.  **数据生成**：函数`generate_energy_samples`接受真实自由度$f_{\\text{true}}$、温度$T$、一个用于缩放热能的因子以及样本数量$N$。它计算真实的形状参数$k_{\\text{true}} = f_{\\text{true}}/2$和尺度参数$\\theta_{\\text{eff}}$，并使用一个带种子的伪随机数生成器从相应的$\\text{Gamma}(k_{\\text{true}}, \\theta_{\\text{eff}})$分布中抽取$N$个样本，以保证可复现性。\n2.  **参数估计**：函数`estimate_k`实现了牛顿法求解器。它接受能量样本数组和固定的估算器温度$T$作为输入。它计算常数$C$，使用矩估计法初始化$k_0$，并迭代直到收敛以找到$k$的MLE。\n3.  **主程序**：主函数`solve`定义了五个测试案例的参数。它遍历这些案例，依次调用数据生成和估算函数。对于每个案例，它从估算出的形状参数$k$计算$f_{\\text{eff}} = 2k$并存储结果。最后，它将所有五个$f_{\\text{eff}}$值格式化并打印为单个逗号分隔的列表。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import digamma, polygamma\n\n# Physical constants and simulation setup\nK_B = 1.380649e-23  # Boltzmann constant in J/K\nSEED = 123456       # Fixed seed for reproducibility\n\ndef generate_energy_samples(f_true, T, theta_eff_factor, N, rng):\n    \"\"\"\n    Generates synthetic kinetic energy samples from a Gamma distribution.\n    \n    Args:\n        f_true (float): The true number of quadratic degrees of freedom.\n        T (float): The temperature in Kelvin.\n        theta_eff_factor (float): A factor to scale the thermal energy,\n                                  simulating thermostat artifacts.\n        N (int): The number of independent samples to generate.\n        rng (numpy.random.Generator): The random number generator instance.\n\n    Returns:\n        numpy.ndarray: An array of N kinetic energy samples.\n    \"\"\"\n    k_true = f_true / 2.0\n    theta_eff = theta_eff_factor * K_B * T\n    return rng.gamma(shape=k_true, scale=theta_eff, size=N)\n\ndef estimate_k(energies, T):\n    \"\"\"\n    Estimates the shape parameter k of a Gamma distribution using MLE\n    with a fixed scale parameter theta = k_B * T.\n\n    Args:\n        energies (numpy.ndarray): The array of observed kinetic energy samples.\n        T (float): The temperature in Kelvin used by the estimator.\n\n    Returns:\n        float: The estimated shape parameter k.\n    \"\"\"\n    theta_estimator = K_B * T\n    \n    # C is the target value for digamma(k)\n    C = np.mean(np.log(energies)) - np.log(theta_estimator)\n    \n    # Initial guess using method of moments\n    k = np.mean(energies) / theta_estimator\n    if k <= 0:\n        k = 1.0 # Failsafe initialization\n        \n    # Newton-Raphson iteration\n    for _ in range(20): # 20 iterations are more than enough\n        g_k = digamma(k) - C\n        g_prime_k = polygamma(1, k)\n        \n        # Update step\n        step = g_k / g_prime_k\n        \n        # Safeguard to prevent k from becoming non-positive\n        alpha = 1.0\n        while k - alpha * step <= 0:\n            alpha /= 2.0\n            if alpha < 1e-8: # Failsafe for extreme cases\n                return k\n\n        k = k - alpha * step\n        \n        if np.abs(step) < 1e-9:\n            break\n            \n    return k\n\ndef solve():\n    \"\"\"\n    Main function to run the five test cases, estimate f_eff, and print the results.\n    \"\"\"\n    rng = np.random.default_rng(SEED)\n    \n    test_cases = [\n        # Case 1: Ideal NVT\n        {\"f_true\": 300, \"T\": 300, \"theta_eff_factor\": 1.0, \"N\": 50000},\n        # Case 2: Constrained COM\n        {\"f_true\": 297, \"T\": 300, \"theta_eff_factor\": 1.0, \"N\": 50000},\n        # Case 3: Rigid bodies\n        {\"f_true\": 60, \"T\": 300, \"theta_eff_factor\": 1.0, \"N\": 50000},\n        # Case 4: Non-canonical thermostat\n        {\"f_true\": 300, \"T\": 300, \"theta_eff_factor\": 0.85, \"N\": 50000},\n        # Case 5: Small sample size\n        {\"f_true\": 6, \"T\": 300, \"theta_eff_factor\": 1.0, \"N\": 50},\n    ]\n\n    results_f_eff = []\n    \n    for case in test_cases:\n        energies = generate_energy_samples(\n            case[\"f_true\"], case[\"T\"], case[\"theta_eff_factor\"], case[\"N\"], rng\n        )\n        \n        # The estimator always uses the nominal temperature T\n        k_est = estimate_k(energies, case[\"T\"])\n        f_eff = 2 * k_est\n        results_f_eff.append(f_eff)\n        \n    # Print results in the required format\n    # The output is not part of the answer, but the code to generate it is.\n    # For self-consistency, let's run it mentally or actually run it to ensure correctness.\n    # The actual output string is what an execution of this would produce.\n    # The task is to provide the code.\n    print(f\"[{','.join(map(str, results_f_eff))}]\")\n\n# The problem requires the code to be runnable.\n# Although the output is not part of the final answer tag, \n# this ensures the code is complete and correct as requested.\n# The user of the XML can run this code.\n# The `solve()` call is intentionally left uncommented.\n# To conform to the XML format and avoid execution on parsing,\n# it is better practice to wrap the main execution logic.\nif __name__ == '__main__':\n    solve()\n```", "id": "3398873"}]}