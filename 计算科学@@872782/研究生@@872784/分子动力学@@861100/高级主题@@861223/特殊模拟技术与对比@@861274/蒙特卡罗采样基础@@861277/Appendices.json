{"hands_on_practices": [{"introduction": "Metropolis-Hastings 算法的核心在于其接受准则，该准则不仅依赖于能量变化，还依赖于提议概率的比率。本练习 [@problem_id:3427343] 揭示了一个至关重要但常被忽视的细节：当提议分布相对于系统的不变测度（例如，为刚体均匀地提议欧拉角）是非均匀时，必须引入一个与雅可比行列式相关的校正因子（即 Hastings 因子）来维持细致平衡。掌握这一原理对于开发自定义且高效的采样算法至关重要。", "problem": "在对一个浸没在外场中的刚性非对称分子的转动自由度进行蒙特卡洛采样时，其取向的构型空间为特殊正交群$\\mathrm{SO}(3)$，由ZYZ欧拉角$(\\phi,\\theta,\\psi)$参数化，其取值范围为$\\phi \\in [0,2\\pi)$、$\\theta \\in [0,\\pi]$和$\\psi \\in [0,2\\pi)$。$\\mathrm{SO}(3)$上的不变体积元，即哈尔测度，在这些坐标下的局部形式为$d\\mu(\\phi,\\theta,\\psi) = \\sin\\theta\\, d\\phi\\, d\\theta\\, d\\psi$。取向上的物理目标分布相对于哈尔测度的密度由$\\pi(R) \\propto \\exp(-\\beta U(R))$给出，其中$R \\in \\mathrm{SO}(3)$编码了取向，$U(R)$是势能；$\\beta$是逆温度，定义为$\\beta = 1/(k_{B}T)$，其中$k_{B}$是玻尔兹曼常数，$T$是绝对温度。\n\nMetropolis-Hastings (MH) 更新的构建方式是，通过一个独立提议在角坐标中提议一个新的取向，该提议从乘积测度中抽取$(\\phi',\\theta',\\psi')$，其中$\\phi'$和$\\psi'$在$[0,2\\pi)$上均匀分布，$\\theta'$在$[0,\\pi]$上均匀分布，且独立于当前的$(\\phi,\\theta,\\psi)$。该提议相对于$\\mathrm{SO}(3)$上的哈尔测度是非均匀的，因为它在欧拉角上是均匀的，而不是在不变测度上。\n\n从$\\mathrm{SO}(3)$上的细致平衡定义出发，利用变量替换以及在坐标映射$(\\phi,\\theta,\\psi) \\mapsto R(\\phi,\\theta,\\psi)$下密度的绝对连续性，推导出Hastings修正因子。当用角坐标将目标密度表示为相对于勒贝格测度的密度时，该因子完全来自于角测度的雅可比行列式$\\sin\\theta$。请以一个仅依赖于当前极角$\\theta$和提议极角$\\theta'$的闭式表达式给出最终的Hastings因子。不要包含能量、温度或提议密度项；仅分离出用于修正雅可bi行列式的那个因子。最终答案必须是单一的解析表达式。", "solution": "问题要求推导在刚性分子的取向空间$\\mathrm{SO}(3)$上进行Metropolis-Hastings (MH) 蒙特卡洛更新时的Hastings修正因子。该修正的出现是因为提议机制在ZYZ欧拉角坐标$(\\phi, \\theta, \\psi)$中是均匀的，而群$\\mathrm{SO}(3)$上的不变测度却不是。\n\nMetropolis-Hastings算法的核心是细致平衡条件，它确保了期望的目标概率分布$\\pi$是所生成的马尔可夫链的平稳分布。对于任意两个状态$x$和$x'$，细致平衡要求：\n$$\n\\pi(x) q(x'|x) A(x'|x) = \\pi(x') q(x|x') A(x|x')\n$$\n其中$q(x'|x)$是从状态$x$移动到$x'$的提议密度，而$A(x'|x)$是接受该移动的概率。接受概率的标准解为：\n$$\nA(x'|x) = \\min\\left(1, \\frac{\\pi(x') q(x|x')}{\\pi(x) q(x'|x)}\\right)\n$$\n项$\\frac{q(x|x')}{q(x'|x)}$被称为Hastings修正因子。此形式体系的一个关键要求是，所有概率密度$\\pi$和$q$都必须相对于相同的底层参考测度来表示。\n\n设系统的状态为一个取向$R \\in \\mathrm{SO}(3)$。该空间上最自然且最优雅的参考测度选择是不变哈尔测度$d\\mu(R)$。用ZYZ欧拉角$(\\phi, \\theta, \\psi)$表示，该测度的局部表达式为$d\\mu(R) = \\sin\\theta \\, d\\phi \\, d\\theta \\, d\\psi$。\n\n首先，我们定义相对于该哈尔测度的目标密度。问题陈述，物理目标分布相对于哈尔测度的密度$\\pi(R)$由$\\pi(R) \\propto \\exp(-\\beta U(R))$给出。我们可以将其写为$\\pi(R) = C_{\\pi} \\exp(-\\beta U(R))$，其中$C_{\\pi}$是归一化常数。\n\n接下来，我们必须确定相对于同一哈尔测度$d\\mu$的提议密度$q(R'|R)$。问题描述了一个独立提议，其中新的欧拉角$(\\phi', \\theta', \\psi')$的抽取独立于当前状态。角度$\\phi'$和$\\psi'$从$[0, 2\\pi)$中均匀抽取，$\\theta'$从$[0, \\pi]$中均匀抽取。此提议的概率密度，相对于坐标空间上的勒贝格测度$d\\lambda = d\\phi' d\\theta' d\\psi'$，为：\n$$\ng_{\\lambda}(\\phi', \\theta', \\psi') = \\frac{1}{2\\pi} \\cdot \\frac{1}{\\pi} \\cdot \\frac{1}{2\\pi} = \\frac{1}{4\\pi^2}\n$$\n这是坐标空间中的提议密度。为了找到相对于哈尔测度$d\\mu(R')$的提议密度$q_{\\mu}(R'|R)$，我们使用概率守恒原理。在一个无穷小体积内提议一个状态的概率必须与描述该体积所用的坐标系无关。\n$$\nq_{\\mu}(R'|R) \\, d\\mu(R') = g_{\\lambda}(\\phi', \\theta', \\psi') \\, d\\lambda\n$$\n我们知道两个体积元之间的关系是$d\\mu(R') = \\sin\\theta' \\, d\\lambda$。将$d\\lambda = d\\mu(R') / \\sin\\theta'$代入方程可得：\n$$\nq_{\\mu}(R'|R) \\, d\\mu(R') = g_{\\lambda}(\\phi', \\theta', \\psi') \\, \\frac{d\\mu(R')}{\\sin\\theta'}\n$$\n因此，相对于哈尔测度的提议密度为：\n$$\nq_{\\mu}(R'|R) = \\frac{g_{\\lambda}(\\phi', \\theta', \\psi')}{\\sin\\theta'} = \\frac{1}{4\\pi^2 \\sin\\theta'}\n$$\n这是一个独立采样器，所以提议密度只依赖于提议的状态$R'$（对应于角度$(\\phi', \\theta', \\psi')$），而不依赖于当前状态$R$。所以，$q_{\\mu}(R'|R) = q_{\\mu}(R')$。从$R'$到$R$的逆向提议的密度，可以通过将带撇的变量替换为不带撇的变量得到：\n$$\nq_{\\mu}(R|R') = \\frac{1}{4\\pi^2 \\sin\\theta}\n$$\n现在我们可以计算Hastings修正因子，它是逆向提议密度与正向提议密度的比值：\n$$\n\\frac{q_{\\mu}(R|R')}{q_{\\mu}(R'|R)} = \\frac{\\frac{1}{4\\pi^2 \\sin\\theta}}{\\frac{1}{4\\pi^2 \\sin\\theta'}} = \\frac{4\\pi^2 \\sin\\theta'}{4\\pi^2 \\sin\\theta} = \\frac{\\sin\\theta'}{\\sin\\theta}\n$$\n这个因子解释了这样一个事实：均匀地提议角度不等同于在与极角相关的方向球面上均匀地提议取向。具体来说，在$\\theta$上的均匀提议更有可能生成靠近极点（$\\theta=0$或$\\theta=\\pi$）的取向，而在这些地方不变体积元$\\sin\\theta \\, d\\theta$很小。Hastings因子正确地补偿了这种偏差。\n\n完整的接受率将是$\\frac{\\pi(R')}{\\pi(R)} \\frac{q_{\\mu}(R|R')}{q_{\\mu}(R'|R)} = \\exp(-\\beta(U(R')-U(R))) \\frac{\\sin\\theta'}{\\sin\\theta}$。问题要求只分离出Hastings修正因子本身，它仅依赖于当前和提议的极角$\\theta$和$\\theta'$。", "answer": "$$\\boxed{\\frac{\\sin\\theta'}{\\sin\\theta}}$$", "id": "3427343"}, {"introduction": "一个有效的马尔可夫链蒙特卡洛（MCMC）采样器必须具备遍历性，即能够从任意状态到达任何其他状态。本练习 [@problem_id:3427345] 通过一个清晰的假设场景，展示了简单、直观的移动方式为何可能无法采样整个构型空间，从而破坏遍历性。它将挑战你诊断问题，设计一种“集体移动”来修复它，并分析采样效率（混合时间）的提升，从而将抽象理论与实际编程实现联系起来。", "problem": "考虑一个用于凸显马尔可夫链蒙特卡洛（MCMC）采样在分子动力学中核心性质的双粒子一维系统。令构型空间为 $\\Omega \\subset \\mathbb{R}^2$，粒子位置为 $(x_1,x_2)$。定义两个势盆和一个硬壁势能函数 $U:\\Omega \\rightarrow \\{0,+\\infty\\}$ 如下。允许的势盆为\n$$\n\\mathcal{A} = \\{(x_1,x_2) \\in \\mathbb{R}^2 \\mid -1 \\le x_1 \\le 0,\\,-1 \\le x_2 \\le 0,\\, x_1 \\le x_2\\}\n$$\n和\n$$\n\\mathcal{B} = \\{(x_1,x_2) \\in \\mathbb{R}^2 \\mid 1 \\le x_1 \\le 2,\\,1 \\le x_2 \\le 2,\\, x_1 \\le x_2\\}.\n$$\n当 $(x_1,x_2) \\in \\mathcal{A} \\cup \\mathcal{B}$ 时，设势能为 $U(x_1,x_2) = 0$，否则 $U(x_1,x_2) = +\\infty$。在逆温 $\\beta$ 下，Metropolis 接受准则应用于提议 $(x_1,x_2) \\mapsto (x_1',x_2')$：以概率 $\\min\\{1, \\exp(-\\beta[U(x_1',x_2') - U(x_1,x_2)])\\}$ 接受。\n\n考虑两种提议移动集：\n\n- 单粒子位移移动：在每一步中，从 $\\{1,2\\}$ 中均匀选择一个 $i$，并提议 $x_i' = x_i + \\delta$，其中 $\\delta$ 从 $[-d,d]$ 中均匀抽取，另一个坐标保持不变。由于硬壁约束，如果 $(x_1',x_2') \\notin \\mathcal{A} \\cup \\mathcal{B}$，则该提议被拒绝。\n\n- 集体平移移动：在每一步中，以概率 $p_c$ 选择一个集体移动，提议 $(x_1',x_2') = (x_1 + s, x_2 + s)$，其中 $s$ 从 $\\{+2,-2\\}$ 中均匀选择；以概率 $1 - p_c$ 选择上述的单粒子位移移动。\n\n任务：\n\n1. 仅使用 MCMC 的第一性原理和上述定义，证明仅使用单粒子位移移动时，由 $U$ 约束的 $\\Omega$ 上的马尔可夫链是非各向遍历的。具体来说，证明任何仅由单粒子位移构成的允许路径都无法从势盆 $\\mathcal{A}$ 转换到势盆 $\\mathcal{B}$。\n\n2. 在存在硬壁势能的情况下，确定一种恢复各向遍历性所必需的集体移动形式，并论证其保持细致平衡。然后，在宏观态 $\\{\\mathcal{A}, \\mathcal{B}\\}$ 的层面上，对于由对称选择 $s \\in \\{+2,-2\\}$ 产生的两态马尔可夫链，根据 $p_c$ 和总变差阈值 $\\varepsilon$ 推导出混合时间 $t_{\\mathrm{mix}}(\\varepsilon)$。\n\n3. 实现一个执行两项计算的程序：\n   - 构建一个步长 $h = 0.5$ 的离散化状态图，方法是枚举 $\\mathcal{A}$ 和 $\\mathcal{B}$ 中的允许网格点，如果两个状态在一个坐标上相差一个大小为 $h$ 的单粒子位移并且保持在允许区域内，则用边连接它们。返回一个布尔值，指示非各向遍历性，这里定义为在此类单粒子移动下，该图具有多于一个的连通分量。该布尔值必须根据此离散化图的连通性计算得出，不得硬编码。\n   - 对于集体移动概率 $p_c$ 的四个指定值 $\\{1.0, 0.2, 0.02, 0.0\\}$ 和一个固定的总变差阈值 $\\varepsilon = 10^{-3}$，计算由集体移动引起的宏观两态链 $\\{\\mathcal{A},\\mathcal{B}\\}$ 的混合时间 $t_{\\mathrm{mix}}(\\varepsilon)$。将 $t_{\\mathrm{mix}}(\\varepsilon)$ 表示为步数的整数，使用解析表达式的向上取整结果，除非它是无穷大（对于 $p_c = 0.0$）。在宏观转移概率等于 $0.5$ 的特殊情况下，取 $t_{\\mathrm{mix}}(\\varepsilon)$ 为 $1$。\n\n您的程序应生成单行输出，其中包含一个逗号分隔的列表，用方括号括起来，并严格按照以下顺序排列：\n$$\n[\\text{非各向遍历布尔值},\\, t_{\\mathrm{mix}}(p_c=1.0),\\, t_{\\mathrm{mix}}(p_c=0.2),\\, t_{\\mathrm{mix}}(p_c=0.02),\\, t_{\\mathrm{mix}}(p_c=0.0)]。\n$$\n第一个条目是布尔值，其余条目是整数，但最后一个在适当时为浮点数 $+\\infty$。不涉及物理单位；所有时间都是无量纲的步数计数。不出现角度。不得使用百分比；概率应视为 $[0,1]$ 内的实数。\n\n覆盖测试套件：\n- 使用 $h=0.5$ 构建图，以检测单粒子移动下的非各向遍历性。\n- 在阈值 $\\varepsilon = 10^{-3}$ 下，使用集体移动概率 $p_c \\in \\{1.0, 0.2, 0.02, 0.0\\}$ 来探测快速混合、中等混合、慢速混合以及无跨盆混合的边界情况。", "solution": "该问题被评估为有效。这是一个适定、有科学依据的统计力学问题，测试了马尔可夫链蒙特卡洛（MCMC）采样的基本概念，特别是各向遍历性、细致平衡和混合时间。所有定义和参数都足以进行严格的求解。\n\n### 第 1 部分：单粒子位移移动的非各向遍历性\n\n如果一个 MCMC 采样器可以从构型空间中的任何状态在有限步数内转换到任何其他状态，则称其为各向遍历的。具有有限势能的构型空间是两个不相交的势盆 $\\mathcal{A}$ 和 $\\mathcal{B}$ 的并集。\n$$\n\\mathcal{A} = \\{(x_1,x_2) \\in \\mathbb{R}^2 \\mid -1 \\le x_1 \\le 0,\\,-1 \\le x_2 \\le 0,\\, x_1 \\le x_2\\}\n$$\n$$\n\\mathcal{B} = \\{(x_1,x_2) \\in \\mathbb{R}^2 \\mid 1 \\le x_1 \\le 2,\\,1 \\le x_2 \\le 2,\\, x_1 \\le x_2\\}\n$$\n对于 $(x_1,x_2) \\in \\mathcal{A} \\cup \\mathcal{B}$，势能 $U(x_1,x_2)$ 为 $0$，否则为 $+\\infty$。\n\n设系统的初始状态为 $(x_1, x_2) \\in \\mathcal{A}$。根据 $\\mathcal{A}$ 的定义，这意味着 $-1 \\le x_1 \\le 0$ 且 $-1 \\le x_2 \\le 0$。我们考虑一个单粒子位移移动，它提议一个新状态 $(x_1', x_2')$。从状态 $x$ 到 $x'$ 的 Metropolis 接受概率是 $\\min\\{1, \\exp(-\\beta[U(x') - U(x)])\\}$。由于在 $\\mathcal{A}$ 内 $U(x)=0$，任何被接受的到新状态 $x'$ 的移动都必须有 $U(x')=0$，这意味着 $x' \\in \\mathcal{A} \\cup \\mathcal{B}$。\n\n从 $(x_1, x_2) \\in \\mathcal{A}$ 进行单粒子移动有两种情况：\n\n1.  **移动粒子 1**：提议的新状态是 $(x_1', x_2') = (x_1 + \\delta, x_2)$，其中 $\\delta$ 是一个随机位移。坐标 $x_2$ 保持不变，所以 $x_2' = x_2 \\in [-1, 0]$。势盆 $\\mathcal{B}$ 中的状态 $(y_1, y_2)$ 必须满足 $1 \\le y_2 \\le 2$。由于 $x_2' \\notin [1, 2]$，提议的状态 $(x_1', x_2')$ 不可能在 $\\mathcal{B}$ 中。因此，要使移动被接受（即势能保持有限），新状态必须位于 $\\mathcal{A}$ 中。\n\n2.  **移动粒子 2**：提议的新状态是 $(x_1', x_2') = (x_1, x_2 + \\delta)$。坐标 $x_1$ 保持不变，所以 $x_1' = x_1 \\in [-1, 0]$。势盆 $\\mathcal{B}$ 中的状态 $(y_1, y_2)$ 必须满足 $1 \\le y_1 \\le 2$。由于 $x_1' \\notin [1, 2]$，提议的状态 $(x_1', x_2')$ 不可能在 $\\mathcal{B}$ 中。因此，要使移动被接受，新状态必须位于 $\\mathcal{A}$ 中。\n\n在这两种情况下，任何源自 $\\mathcal{A}$ 中状态的被接受的单粒子移动都会导致一个同样在 $\\mathcal{A}$ 中的状态。仅使用单粒子位移不可能从 $\\mathcal{A}$ 中的状态生成 $\\mathcal{B}$ 中的状态。类似的论证表明，无法从 $\\mathcal{B}$ 转换到 $\\mathcal{A}$。状态空间被分割成两个不连通的区域。因此，该马尔可夫链是非各向遍历的。\n\n### 第 2 部分：恢复各向遍历性与混合时间的推导\n\n问题提出了一种集体平移移动来恢复各向遍历性：$(x_1', x_2') = (x_1 + s, x_2 + s)$，其中 $s$ 从 $\\{+2, -2\\}$ 中均匀选择。\n\n**恢复各向遍历性**：\n- 如果 $(x_1, x_2) \\in \\mathcal{A}$，则 $-1 \\le x_1, x_2 \\le 0$ 且 $x_1 \\le x_2$。应用 $s = +2$ 的平移得到 $(x_1', x_2') = (x_1+2, x_2+2)$。新坐标满足 $1 \\le x_1', x_2' \\le 2$。顺序关系保持不变：$x_1 \\le x_2 \\implies x_1+2 \\le x_2+2 \\implies x_1' \\le x_2'$。因此，新状态 $(x_1', x_2')$ 保证在 $\\mathcal{B}$ 中。\n- 如果 $(x_1, x_2) \\in \\mathcal{B}$，则 $1 \\le x_1, x_2 \\le 2$ 且 $x_1 \\le x_2$。应用 $s = -2$ 的平移得到 $(x_1', x_2') = (x_1-2, x_2-2)$。新坐标满足 $-1 \\le x_1', x_2' \\le 0$ 且 $x_1' \\le x_2'$。因此，新状态 $(x_1', x_2')$ 保证在 $\\mathcal{A}$ 中。\n这种移动成功地连接了两个势盆。当与单粒子移动（确保每个势盆内的各向遍历性）结合时，整个马尔可夫链变得各向遍历。\n\n**细致平衡**：\n该系统的平稳分布 $\\pi(x)$ 在允许区域 $\\mathcal{A} \\cup \\mathcal{B}$ 上是均匀的，因为势能 $U(x)$ 在那里是常数（零）。细致平衡要求 $\\pi(x)P(x \\to x') = \\pi(x')P(x' \\to x)$，其中 $P(x \\to x') = T(x \\to x')A(x \\to x')$ 是转移概率，由提议概率 $T$ 和接受概率 $A$ 组成。\n对于 $x \\in \\mathcal{A}$ 和 $x' \\in \\mathcal{B}$ 之间的集体移动，我们有 $\\pi(x) = \\pi(x')$，因为分布是均匀的。势能为 $U(x) = U(x') = 0$，所以接受概率是 $A(x \\to x') = \\min\\{1, \\exp(-0)\\} = 1$。从 $x$ 到 $x' = x+(s,s)$ 和从 $x'$ 到 $x = x'-(s,s)$ 的提议是对称的，因为 $s$ 是从 $\\{+2, -2\\}$ 中均匀选择的。因此，$T(x \\to x') = T(x' \\to x)$。在 $\\pi(x)=\\pi(x')$， $T(x \\to x')=T(x' \\to x)$ 和 $A(x \\to x')=A(x' \\to x)=1$ 的条件下，细致平衡条件得到满足。\n\n**宏观态链的混合时间**：\n我们分析宏观态 $\\{\\mathcal{A}, \\mathcal{B}\\}$ 上的两态马尔可夫链。$\\mathcal{A}$ 的面积是 $\\frac{1}{2}(1 \\times 1) = 1/2$，$\\mathcal{B}$ 的面积是 $\\frac{1}{2}(1 \\times 1) = 1/2$。因此，平稳概率相等：$\\pi(\\mathcal{A}) = \\pi(\\mathcal{B}) = 1/2$。\n宏观态之间的转换仅通过集体移动发生。\n- 从 $\\mathcal{A}$ 到 $\\mathcal{B}$ 一步转换的概率是 $P(\\mathcal{A} \\to \\mathcal{B}) = P(\\text{选择集体移动}) \\times P(\\text{选择 } s=+2) = p_c \\times (1/2) = p_c/2$。\n- 从 $\\mathcal{B}$ 到 $\\mathcal{A}$ 的转换概率是 $P(\\mathcal{B} \\to \\mathcal{A}) = p_c \\times (1/2) = p_c/2$。\n设 $\\alpha = p_c/2$。宏观态 $(\\mathcal{A}, \\mathcal{B})$ 的转移矩阵是：\n$$\nM = \\begin{pmatrix} 1-\\alpha  \\alpha \\\\ \\alpha  1-\\alpha \\end{pmatrix}\n$$\n特征值是 $\\lambda_1 = 1$ 和 $\\lambda_2 = 1 - 2\\alpha = 1 - p_c$。收敛到平稳分布的速率由第二大特征值模 $|\\lambda_2| = |1 - p_c|$ 决定。对于 $p_c \\in [0, 1]$，这个值是 $1-p_c$。\n从平稳分布 $\\pi_{macro} = [1/2, 1/2]^T$ 开始，经过 $t$ 步后，从一个纯态（最坏情况）出发的总变差距离是 $d_{TV}(t) = \\frac{1}{2}|\\lambda_2|^t = \\frac{1}{2}(1-p_c)^t$。\n我们寻求混合时间 $t_{\\mathrm{mix}}(\\varepsilon)$，即满足 $d_{TV}(t) \\le \\varepsilon$ 的最小整数 $t$。\n$$\n\\frac{1}{2}(1-p_c)^t \\le \\varepsilon \\implies (1-p_c)^t \\le 2\\varepsilon\n$$\n取自然对数：\n$$\nt \\ln(1-p_c) \\le \\ln(2\\varepsilon)\n$$\n对于 $p_c \\in (0, 1)$，$\\ln(1-p_c)$ 是负数，所以我们反转不等号：\n$$\nt \\ge \\frac{\\ln(2\\varepsilon)}{\\ln(1-p_c)}\n$$\n混合时间是该值的向上取整：\n$$\nt_{\\mathrm{mix}}(\\varepsilon) = \\left\\lceil \\frac{\\ln(2\\varepsilon)}{\\ln(1-p_c)} \\right\\rceil\n$$\n特殊情况：\n- 如果 $p_c=0$，分母是 $\\ln(1)=0$，所以 $t_{\\mathrm{mix}} = \\infty$。\n- 如果 $p_c=1$，宏观转移概率 $\\alpha = 1/2$。根据问题描述，$t_{\\mathrm{mix}}=1$。这与 $\\lambda_2=0$ 的事实一致，表明立即收敛。\n\n### 第 3 部分：实现计划\n\n1.  **非各向遍历性测试**：\n    - 用步长 $h=0.5$ 离散化状态空间。势盆 $\\mathcal{A}$ 的有效坐标是 $\\{-1.0, -0.5, 0.0\\}$，势盆 $\\mathcal{B}$ 的有效坐标是 $\\{1.0, 1.5, 2.0\\}$。\n    - 枚举 $\\mathcal{A} \\cup \\mathcal{B}$ 中所有满足约束（例如 $x_1 \\le x_2$）的状态。这将在 $\\mathcal{A}$ 中产生 $6$ 个状态，在 $\\mathcal{B}$ 中产生 $6$ 个状态，总共 $12$ 个状态。\n    - 构建一个图，其中状态是节点。如果两个节点之间可以通过大小为 $h=0.5$ 的单粒子位移从一个到达另一个，则它们之间存在一条边。\n    - 执行图遍历（例如广度优先或深度优先搜索）来计算连通分量的数量。如果数量大于 $1$，则系统在此离散化下是非各向遍历的，布尔值为 `True`。\n\n2.  **混合时间计算**：\n    - 使用推导出的公式 $t_{\\mathrm{mix}}(\\varepsilon) = \\lceil \\frac{\\ln(2\\varepsilon)}{\\ln(1-p_c)} \\rceil$，其中 $\\varepsilon = 10^{-3}$。\n    - 对于 $p_c = 1.0$，使用特殊情况规则 $t_{\\mathrm{mix}}=1$。\n    - 对于 $p_c \\in \\{0.2, 0.02\\}$，计算该公式。当 $2\\varepsilon = 0.002$ 时：\n      - $p_c=0.2$：$t = \\ln(0.002)/\\ln(0.8) \\approx 27.85 \\implies \\lceil 27.85 \\rceil = 28$。\n      - $p_c=0.02$：$t = \\ln(0.002)/\\ln(0.98) \\approx 307.65 \\implies \\lceil 307.65 \\rceil = 308$。\n    - 对于 $p_c=0.0$，混合时间是无穷大。\n    - 结果将被收集并按指定格式化。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the two-part problem:\n    1. Determines ergodicity of a discretized system via graph connectivity.\n    2. Calculates MCMC mixing times for a macrostate model.\n    \"\"\"\n\n    # --- Task 1: Check for non-ergodicity on a discretized grid ---\n\n    # Define the step size and coordinate grids for the two basins.\n    h = 0.5\n    coords_A = [-1.0, -0.5, 0.0]\n    coords_B = [1.0, 1.5, 2.0]\n\n    # Enumerate all valid states in basin A satisfying x1 = x2.\n    states_A = []\n    for x1 in coords_A:\n        for x2 in coords_A:\n            if x1 = x2:\n                states_A.append((x1, x2))\n    \n    # Enumerate all valid states in basin B satisfying x1 = x2.\n    states_B = []\n    for x1 in coords_B:\n        for x2 in coords_B:\n            if x1 = x2:\n                states_B.append((x1, x2))\n                \n    # Combine states from both basins and create a mapping for efficient lookup.\n    all_states = states_A + states_B\n    num_states = len(all_states)\n    state_to_idx = {state: i for i, state in enumerate(all_states)}\n\n    # Build an adjacency list for the graph.\n    adj = [[] for _ in range(num_states)]\n    for i, state in enumerate(all_states):\n        x1, x2 = state\n        # Define the four possible single-particle moves of magnitude h.\n        potential_moves = [(h, 0), (-h, 0), (0, h), (0, -h)]\n        for dx, dy in potential_moves:\n            # Calculate the neighbor coordinate.\n            # a direct key lookup will work as coordinates are exact multiples of h=0.5\n            neighbor_coord = (x1 + dx, x2 + dy)\n            if neighbor_coord in state_to_idx:\n                neighbor_idx = state_to_idx[neighbor_coord]\n                adj[i].append(neighbor_idx)\n\n    # Count connected components using Breadth-First Search (BFS) to determine ergodicity.\n    # Non-ergodicity is defined as having more than one connected component.\n    visited = [False] * num_states\n    num_components = 0\n    for i in range(num_states):\n        if not visited[i]:\n            num_components += 1\n            q = [i]\n            visited[i] = True\n            head = 0\n            while head  len(q):\n                u = q[head]\n                head += 1\n                for v in adj[u]:\n                    if not visited[v]:\n                        visited[v] = True\n                        q.append(v)\n    \n    non_ergodic_boolean = (num_components > 1)\n\n    # --- Task 2: Calculate mixing times for the two-state macrochain ---\n\n    pc_values = [1.0, 0.2, 0.02, 0.0]\n    epsilon = 1e-3\n    mixing_times = []\n\n    for pc in pc_values:\n        # The macrostate transition probability p(A->B) is alpha = pc/2.\n        # The problem defines a special case when this probability is 0.5.\n        if pc == 1.0: # Corresponds to macro transition prob = 0.5\n            mixing_times.append(1)\n        elif pc == 0.0: # No collective moves, so basins are disconnected.\n            mixing_times.append(float('inf'))\n        else:\n            # For 0  pc  1, use the derived analytical formula:\n            # t_mix = ceil(ln(2*eps) / ln(1-pc))\n            t_mix_float = np.log(2 * epsilon) / np.log(1 - pc)\n            mixing_times.append(int(np.ceil(t_mix_float)))\n\n    # --- Assemble and print the final output in the required format ---\n    \n    # Combine the boolean result with the list of mixing times.\n    results = [str(non_ergodic_boolean).lower()] + mixing_times\n    \n    # The final print statement must produce a single line in the specified format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3427345"}, {"introduction": "来自高级模拟（如分子动力学或 MCMC）的数据几乎从不是一系列独立同分布（i.i.d.）的样本；连续的构型之间存在时间相关性。本练习 [@problem_id:3427318] 解决了从这类相关时间序列中估计统计不确定性的实际挑战。它引导你理解并验证区块自助法（block bootstrap），这是一种在标准 i.i.d. 假设失效时，用以构建可靠置信区间的强大非参数技术。", "problem": "考虑一个标量可观测量 $A$ 的时间序列 $\\{A_t\\}_{t=1}^N$，该序列由分子动力学 (MD) 或马尔可夫链蒙特卡洛 (MCMC) 生成的遍历马尔可夫链的单一长轨迹记录得到。目标是估计样本均值 $\\hat{A}_N = \\frac{1}{N}\\sum_{t=1}^N A_t$ 的置信区间 (CI)。该链是平稳的，其平衡均值为 $\\mathbb{E}[A] = \\mu$，自协方差函数为 $C(\\ell) = \\mathbb{E}\\big[(A_t-\\mu)(A_{t+\\ell}-\\mu)\\big]$，并具有归一化的自相关函数 $\\rho(\\ell) = C(\\ell)/C(0)$，该函数在一个特征相关尺度上衰减。对于单位时间步长，积分自相关时间 (IAT) 定义为 $\\tau_{\\mathrm{int}} = \\frac{1}{2} + \\sum_{\\ell=1}^{\\infty} \\rho(\\ell)$。几何遍历马尔可夫链的中心极限定理指出，在温和条件下，$\\sqrt{N}\\big(\\hat{A}_N - \\mu\\big)$ 依分布收敛于一个正态随机变量，其方差膨胀由时间相关性决定。\n\n您需要寻找一种尊重序列依赖性的非参数重采样方法，以近似 $\\hat{A}_N$ 的样本分布，并生成一个具有科学依据的置信区间。以下哪个选项最正确地概述了针对相关马尔可夫链数据的块自助法程序，并阐明了相对于 $\\tau_{\\mathrm{int}}$ 选择块长度的理由？\n\nA. 从时间序列中估计 $\\tau_{\\mathrm{int}}$，选择一个块长度 $L_b$，其数量级为 $\\tau_{\\mathrm{int}}$ 的一个较小倍数，例如，$L_b \\approx \\alpha\\,\\tau_{\\mathrm{int}}$，其中 $\\alpha$ 在 2 到 10 之间。从 $\\{A_t\\}_{t=1}^N$ 中构建长度为 $L_b$ 的重叠连续块（使用循环包裹以允许块从接近 $t=N$ 的位置开始），有放回地抽取 $K=\\lceil N/L_b \\rceil$ 个块并将它们拼接起来，形成一个长度至少为 $N$ 的自助法序列，然后截断至恰好 $N$。对 $B$ 个自助法复制样本中的每一个计算 $\\hat{A}_N^{\\ast}$，并使用 $\\{\\hat{A}_N^{\\ast}\\}_{b=1}^B$ 的经验分位数来构建置信区间。理由：选择与几个 $\\tau_{\\mathrm{int}}$ 相当的 $L_b$ 可以保留大部分块内依赖性，同时允许有足够多的块，从而在自助法分布中平衡方差和偏差。\n\nB. 由于马尔可夫链是遍历的，独立有放回地重采样单个数据点 $A_t$ ($L_b=1$) 以形成 $B$ 个长度为 $N$ 的自助法序列，为每个序列计算 $\\hat{A}_N^{\\ast}$，并使用它们的分位数来构建置信区间。理由：遍历性保证了长期来看的独立性，因此单点重采样是足够的。\n\nC. 为避免因破坏相关性而产生的偏差，将块长度设置为完整轨迹的长度，$L_b=N$，并为每个复制样本重采样一个整块。计算 $\\hat{A}_N^{\\ast}$ 并使用其经验分布来构建置信区间。理由：使用整个轨迹的块可以完美地保留依赖性，因此能产生最忠实的自助法分布。\n\nD. 将序列划分为长度为 $L_b \\ll \\tau_{\\mathrm{int}}$ 的不重叠连续块，以最大化可用块的数量，有放回地对这些块进行采样以形成自助法序列，并计算 $\\hat{A}_N^{\\ast}$。理由：较短的块通过增加块的数量来减少自助法估计量的方差，从而提高置信区间的紧密度。\n\nE. 使用平稳自助法，其块长度服从几何分布，平均值 $L_b$ 设定得远小于 $\\tau_{\\mathrm{int}}$ 以避免过度平滑。生成 $B$ 个自助法序列，计算 $\\hat{A}_N^{\\ast}$ 并从其经验分布中推导出置信区间。理由：随机的短块可以防止自助法序列中出现人为的远程相关性，从而产生可靠的置信区间。", "solution": "此问题旨在评估对相关时间序列数据进行统计不确定性估计的理解，特别是块自助法（block bootstrap）的应用。核心挑战在于，标准自助法假设样本是独立同分布（i.i.d.）的，而MCMC或MD模拟产生的时间序列数据由于其马尔可夫性质而存在时间相关性。直接应用i.i.d.自助法会破坏这种相关结构，导致对样本均值方差的严重低估。\n\n块自助法的思想是通过重采样数据块而非单个数据点来保留原始序列的依赖结构。我们来分析各个选项：\n\n*   **选项 B** 描述了标准的i.i.d.自助法。这是不正确的，因为它完全忽略了数据中的时间相关性。遍历性保证了时间平均收敛于系综平均，但它并不意味着样本是独立的。这种方法会错误地将相关样本视为独立样本，从而产生过于狭窄、无法反映真实不确定性的置信区间。\n\n*   **选项 C** 建议使用整个轨迹作为单一的块。每次重采样都会得到原始的完整序列。因此，每个自助法复制样本的均值 $\\hat{A}_N^{\\ast}$ 都将等于原始样本均值 $\\hat{A}_N$。这会产生一个没有方差的自助法分布，完全无法用于构建置信区间。\n\n*   **选项 D** 建议使用比积分自相关时间 $\\tau_{\\mathrm{int}}$ 小得多的块长（$L_b \\ll \\tau_{\\mathrm{int}}$）。虽然这会产生大量的块，但这些块太短，无法捕捉到数据中完整的相关性。块的边界人为地切断了相关性，导致块与块之间仍然存在虚假的相关性。这会导致对真实方差的系统性低估（尽管比i.i.d.情况要好一些）。理由中提到的“提高置信区间的紧密度”实际上是偏差的体现，而非精度的提高。\n\n*   **选项 E** 描述了平稳自助法，这本身是一种有效的方法，但给出的理由是错误的。它建议将平均块长 $L_b$ 设定得远小于 $\\tau_{\\mathrm{int}}$。与选项D一样，这个选择是错误的，因为它无法充分捕获数据的依赖结构。为了使平稳自助法有效，平均块长仍然需要足够大以反映相关时间尺度。\n\n*   **选项 A** 正确地描述了移动块自助法（Moving Block Bootstrap, MBB）的程序和原理。\n    1.  **块长选择**：核心在于选择一个足够大的块长 $L_b$，使其能够近似地包含原始数据中的主要相关性。一个常见的经验法则是，$L_b$ 应该与积分自相关时间 $\\tau_{\\mathrm{int}}$ 的几倍相当。这确保了每个块内部的依赖结构得以保留，并且不同块之间的相关性相对较弱。\n    2.  **块的构建与采样**：使用重叠块（overlapping blocks）可以最大化可用块的数量（从 $N$ 个数据点可以生成 $N-L_b+1$ 个块），从而改善自助法估计的性能。然后有放回地对这些块进行采样。\n    3.  **自助法序列构建**：将采样的块拼接起来，形成一个新的时间序列，其长度与原始序列相同。\n    4.  **置信区间构建**：重复此过程多次，得到一个样本均值的自助法分布 $\\{\\hat{A}_N^{\\ast}\\}$，并使用该分布的经验分位数（例如2.5%和97.5%分位数）来构建置信区间。\n    理由部分正确地指出了块长选择中的关键权衡：块长需要足够长以减小偏差（保留相关性），但又不能太长，否则块的数量会太少，导致自助法分布的方差过大。因此，选项A提供了最准确和理论上最合理的描述。\n\n综上所述，选项A是唯一正确且完整地描述了如何将块自助法应用于相关时间序列数据的选项。", "answer": "$$\\boxed{A}$$", "id": "3427318"}]}