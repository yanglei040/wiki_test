{"hands_on_practices": [{"introduction": "此练习旨在探讨使用集体变量 (Collective Variables, CVs) 的数学基础。我们将研究对集体变量进行非线性变换如何影响计算出的自由能以及元动力学偏置核的形状，这是有效选择和操作集体变量的一个关键概念。[@problem_id:3461459]", "problem": "在一个由良温元动力学 (Well-Tempered Metadynamics, WTMetaD) 增强的分子动力学 (Molecular Dynamics, MD) 模拟中，监测一个单一的集体变量 (Collective Variable, CV) $s(\\mathbf{q})$，其中 $\\mathbf{q}$ 表示一个 $N$ 粒子系统的 $3N$ 维笛卡尔坐标。沿 $s$ 的平均力势 (potential of mean force, PMF) 由边缘概率密度 $P_{s}(s)$ 定义，通过 $F(s) = -k_{B} T \\ln P_{s}(s) + C$ 给出，其中 $k_{B}$ 是玻尔兹曼常数，$T$ 是绝对温度，$C$ 是一个可加常数。考虑一个光滑、严格单调、可微的一对一变换 $\\tilde{s} = f(s)$，其逆变换为 $s = f^{-1}(\\tilde{s})$。WTMetaD 中的偏置是通过在 CV 空间中沉积高斯核来构建的。在原始的 $s$ 空间中，一个中心位于 $s_{0}$、高度为 $w$、宽度参数为 $\\sigma_{s}$ 的单一高斯核具有形式 $G_{s}(s; s_{0}) = w \\exp\\!\\left(-\\frac{(s - s_{0})^{2}}{2 \\sigma_{s}^{2}}\\right)$。在变换后的 $\\tilde{s}$ 空间中，一个类似的高斯核为 $G_{\\tilde{s}}(\\tilde{s}; \\tilde{s}_{0}) = w \\exp\\!\\left(-\\frac{(\\tilde{s} - \\tilde{s}_{0})^{2}}{2 \\tilde{\\sigma}^{2}}\\right)$，其宽度参数为 $\\tilde{\\sigma}$ 且 $\\tilde{s}_{0} = f(s_{0})$。假设良温调节因子仅通过一个与累积偏置相关的指数函数影响随时间变化的振幅，并且在沉积瞬间不改变单个核的空间形状。\n\n从边缘密度的定义和概率密度的变量变换定理出发，并仅对核形状使用关于 $s_{0}$ 的 $f$ 的一阶局域线性化，完成以下任务：\n\n- 推导在变量变换下 PMF 如何变换，得出 $F_{\\tilde{s}}(\\tilde{s})$ 关于 $F(s)$ 和 $f'(s)$ 的表达式，结果可相差一个可加常数。\n- 在窄核近似下，确定在 $s$ 空间中的高斯核形状必须如何选择，以在 $\\tilde{s}$ 空间中表示一个宽度为常数 $\\tilde{\\sigma}$ 的目标高斯。你可以假设 $f'(s_{0}) \\neq 0$ 并且 $f$ 在核的支持集上是严格递增或严格递减的。\n- 简要论证为何良温振幅前因子在瞬时沉积下不改变所需的宽度空间重缩放。\n\n必须使用的 $s$ 空间宽度 $\\sigma_{s}(s)$ 的显式位置依赖表达式是什么，以使该核在局部上对应于 $\\tilde{s}$ 空间中的一个常数宽度 $\\tilde{\\sigma}$？请仅用 $\\tilde{\\sigma}$ 和 $f'(s)$ 来提供你的最终答案，形式为单个解析表达式。如果你引入任何常数，请保持其符号形式。不要引入任何数值。最终答案必须是一个没有单位的单一封闭形式表达式。无需四舍五入；提供精确的符号关系。", "solution": "对问题陈述进行有效性分析。\n\n**步骤1：提取已知条件**\n- 系统：一个具有 $3N$ 维笛卡尔坐标 $\\mathbf{q}$ 的 $N$ 粒子系统。\n- 集体变量 (CV): $s(\\mathbf{q})$。\n- 平均力势 (PMF): $F(s) = -k_{B} T \\ln P_{s}(s) + C$，其中 $P_{s}(s)$ 是边缘概率密度，$k_{B}$ 是玻尔兹曼常数，$T$ 是绝对温度，$C$ 是一个常数。\n- CV 变换: $\\tilde{s} = f(s)$，它是一个光滑、严格单调、可微的一对一函数，其逆函数为 $s = f^{-1}(\\tilde{s})$。\n- $s$ 空间中的高斯核: $G_{s}(s; s_{0}) = w \\exp\\!\\left(-\\frac{(s - s_{0})^{2}}{2 \\sigma_{s}^{2}}\\right)$，中心在 $s_{0}$，高度为 $w$，宽度为 $\\sigma_{s}$。\n- $\\tilde{s}$ 空间中的高斯核: $G_{\\tilde{s}}(\\tilde{s}; \\tilde{s}_{0}) = w \\exp\\!\\left(-\\frac{(\\tilde{s} - \\tilde{s}_{0})^{2}}{2 \\tilde{\\sigma}^{2}}\\right)$，中心在 $\\tilde{s}_{0} = f(s_{0})$，宽度为 $\\tilde{\\sigma}$。\n- 良温元动力学 (WTMetaD) 假设：调节因子仅影响随时间变化的振幅 $w$，而不影响新沉积核的空间形状。\n- 近似：使用关于点 $s_{0}$ 的 $f$ 的一阶局域线性化。\n- 条件: $f'(s_{0}) \\neq 0$。\n\n**步骤2：使用提取的已知条件进行验证**\n- **科学依据**：该问题基于统计力学、概率论以及分子动力学中增强采样方法（特别是元动力学）的既定原理。所有概念（PMF、CV、变量变换、高斯核）都是标准的且陈述正确。\n- **适定性**：该问题定义明确。它提供了充分的信息和清晰的假设（例如 $f(s)$ 的性质、使用线性化）来为所求量推导出唯一的解。\n- **客观性**：该问题以精确、客观、形式化的科学语言陈述，没有歧义或主观论断。\n\n**步骤3：结论与行动**\n该问题有效。它是元动力学模拟研究中的一个标准理论练习。将提供完整解答。\n\n**推导**\n\n该问题要求完成三个主要任务：推导 PMF 的变换规则，确定高斯核宽度的所需缩放，以及论证良温前因子的作用。\n\n**1. 平均力势 (PMF) 的变换**\n\nPMF 与边缘概率密度相关。为了找出 PMF 如何变换，我们必须首先找出在变量变换 $\\tilde{s} = f(s)$ 下概率密度如何变换。概率守恒原理指出，系统处于无穷小区间内的概率在坐标变换下必须是不变的。\n$$\nP_{s}(s) |ds| = P_{\\tilde{s}}(\\tilde{s}) |d\\tilde{s}|\n$$\n由于 $f$ 是严格单调的，我们可以暂时去掉微分的绝对值，并通过雅可比行列式重新引入它们。这给出了概率密度之间的关系：\n$$\nP_{\\tilde{s}}(\\tilde{s}) = P_{s}(s) \\left|\\frac{ds}{d\\tilde{s}}\\right|\n$$\n导数 $\\frac{ds}{d\\tilde{s}}$ 是从 $\\tilde{s}$ 到 $s$ 变换的雅可比。使用反函数定理，并给定 $\\tilde{s} = f(s)$，我们有：\n$$\n\\frac{ds}{d\\tilde{s}} = \\frac{d}{d\\tilde{s}} f^{-1}(\\tilde{s}) = \\frac{1}{f'(s)}\n$$\n其中 $s$ 在 $f^{-1}(\\tilde{s})$ 处取值。将此代入密度变换规则：\n$$\nP_{\\tilde{s}}(\\tilde{s}) = P_{s}(f^{-1}(\\tilde{s})) \\left|\\frac{1}{f'(f^{-1}(\\tilde{s}))}\\right|\n$$\n现在，我们使用各自空间中 PMF 的定义：\n$$\nF(s) = -k_{B} T \\ln P_{s}(s) + C_{s} \\implies P_{s}(s) = \\exp\\left(-\\frac{F(s) - C_{s}}{k_{B} T}\\right)\n$$\n$$\nF_{\\tilde{s}}(\\tilde{s}) = -k_{B} T \\ln P_{\\tilde{s}}(\\tilde{s}) + C_{\\tilde{s}}\n$$\n将 $P_{\\tilde{s}}(\\tilde{s})$ 的表达式代入其 PMF 定义：\n$$\nF_{\\tilde{s}}(\\tilde{s}) = -k_{B} T \\ln \\left( P_{s}(f^{-1}(\\tilde{s})) \\left|\\frac{1}{f'(f^{-1}(\\tilde{s}))}\\right| \\right) + C_{\\tilde{s}}\n$$\n使用对数性质 $\\ln(ab) = \\ln(a) + \\ln(b)$：\n$$\nF_{\\tilde{s}}(\\tilde{s}) = -k_{B} T \\ln P_{s}(f^{-1}(\\tilde{s})) - k_{B} T \\ln \\left( \\left| \\frac{1}{f'(f^{-1}(\\tilde{s}))} \\right| \\right) + C_{\\tilde{s}}\n$$\n认识到 $-k_{B} T \\ln P_{s}(s) = F(s) - C_{s}$ 和 $\\ln(1/x) = -\\ln(x)$：\n$$\nF_{\\tilde{s}}(\\tilde{s}) = \\left( F(f^{-1}(\\tilde{s})) - C_{s} \\right) + k_{B} T \\ln \\left| f'(f^{-1}(\\tilde{s})) \\right| + C_{\\tilde{s}}\n$$\n将常数 $C_s$ 和 $C_{\\tilde{s}}$ 合并为一个新的常数 $C'$，我们得到 PMF 的变换规则（相差一个任意可加常数）：\n$$\nF_{\\tilde{s}}(\\tilde{s}) = F(s(\\tilde{s})) + k_{B} T \\ln |f'(s(\\tilde{s}))| + C'\n$$\n该项，有时被称为“雅可比势”或“熵贡献”，用于校正由于非线性变量变换引起的相空间体积变化而产生的自由能。\n\n**2. 高斯核形状的变换**\n\n我们希望选择在 $s$ 空间中沉积的高斯核的宽度 $\\sigma_s$，使其对应于在变换后的 $\\tilde{s}$ 空间中具有固定常数宽度 $\\tilde{\\sigma}$ 的高斯核。这需要在使用指定的局域线性化下，匹配核函数在变换下的函数形式。\n\n假设一个高斯核沉积在 $s_0$。在变换后的空间中，其中心为 $\\tilde{s}_0 = f(s_0)$。我们对变换 $f(s)$ 在 $s_0$ 附近进行一阶泰勒展开：\n$$\n\\tilde{s} = f(s) \\approx f(s_0) + f'(s_0)(s - s_0)\n$$\n这意味着对于偏离中心的偏差，存在一个局域线性关系：\n$$\n\\tilde{s} - \\tilde{s}_0 \\approx f'(s_0)(s - s_0)\n$$\n在 $\\tilde{s}$ 空间中的目标核形状是一个具有常数宽度 $\\tilde{\\sigma}$ 的高斯函数：\n$$\nG_{\\tilde{s}}(\\tilde{s}; \\tilde{s}_{0}) = w \\exp\\left(-\\frac{(\\tilde{s} - \\tilde{s}_{0})^{2}}{2 \\tilde{\\sigma}^{2}}\\right)\n$$\n将线性化关系代入指数部分：\n$$\n-\\frac{(\\tilde{s} - \\tilde{s}_{0})^{2}}{2 \\tilde{\\sigma}^{2}} \\approx -\\frac{\\left[f'(s_0)(s - s_0)\\right]^{2}}{2 \\tilde{\\sigma}^{2}} = -\\frac{(f'(s_0))^2 (s - s_0)^2}{2 \\tilde{\\sigma}^2}\n$$\n我们希望这个表达式等价于在 $s$ 空间中沉积的高斯核的指数部分：\n$$\nG_{s}(s; s_{0}) = w \\exp\\left(-\\frac{(s - s_{0})^{2}}{2 \\sigma_{s}^{2}}\\right)\n$$\n其指数部分为：\n$$\n-\\frac{(s - s_0)^2}{2 \\sigma_s^2}\n$$\n通过比较这两个指数的自变量，我们强制要求 $s$ 空间中的核在局域变换后与 $\\tilde{s}$ 空间中的目标形状相匹配。\n$$\n\\frac{(s - s_0)^2}{2 \\sigma_s^2} = \\frac{(f'(s_0))^2 (s - s_0)^2}{2 \\tilde{\\sigma}^2}\n$$\n该等式必须在 $s$ 靠近 $s_0$ 的区域内成立。消去公共项得到：\n$$\n\\frac{1}{\\sigma_s^2} = \\frac{(f'(s_0))^2}{\\tilde{\\sigma}^2}\n$$\n解出 $\\sigma_s$：\n$$\n\\sigma_s^2 = \\frac{\\tilde{\\sigma}^2}{(f'(s_0))^2} \\implies \\sigma_s = \\sqrt{\\frac{\\tilde{\\sigma}^2}{(f'(s_0))^2}} = \\frac{\\tilde{\\sigma}}{|f'(s_0)|}\n$$\n由于这个逻辑必须适用于任何可能沉积高斯核的位置 $s$，我们将 $s_0$ 推广到一个通用位置 $s$。这就得出了为在变换空间中保持恒定有效宽度 $\\tilde{\\sigma}$ 所需的位置依赖宽度 $\\sigma_s(s)$：\n$$\n\\sigma_s(s) = \\frac{\\tilde{\\sigma}}{|f'(s)|}\n$$\n这个结果表明，在变换 $f(s)$ 陡峭的区域（$|f'(s)|$ 较大），需要在原始空间中使用较窄的核 $\\sigma_s$ 才能在变换空间中产生期望的宽度。相反，在 $f(s)$ 平坦的区域（$|f'(s)|$ 较小），则需要较宽的核。\n\n**3. 关于良温前因子的论证**\n\n在良温元动力学中，在时间 $t_n$ 沉积的高斯核的高度 $w$ 不是一个常数 $w_0$，而是受到已经累积的偏置势 $V_G$ 的调制：\n$$\nw(t_n) = w_0 \\exp\\left(-\\frac{V_G(s(t_n), t_{n-1})}{k_B \\Delta T}\\right)\n$$\n其中 $\\Delta T$ 是一个具有温度单位的参数，用于控制调节程度。\n\n第2部分的推导关注核函数的空间形状，它由指数函数的自变量决定，即与 $(s-s_0)^2$ 成比例的项。高度 $w(t_n)$ 是一个指数前因子，或称为振幅。核形状的匹配是通过令指数部分相等来实现的：\n$$\n\\text{指数}_s \\leftrightarrow \\text{指数}_{\\tilde{s}}\n$$\n振幅 $w$ 只是对整个函数进行缩放，并被视为一个公共因子：\n$$\nw \\exp(\\text{指数}_s) \\leftrightarrow w \\exp(\\text{指数}_{\\tilde{s}})\n$$\n$\\sigma_s$ 和 $\\tilde{\\sigma}$ 之间的关系完全是从核函数的空间部分推导出来的，而这部分与振幅前因子 $w$ 无关。因此，WTMetaD 中 $w$ 随时间和位置变化的事实，并不改变沉积瞬间核宽度的几何缩放要求。良温协议影响的是添加*多少*偏置，而我们推导出的宽度缩放影响的是所添加偏置的*形状*。\n\n总之，所需的 $s$ 空间中位置依赖宽度的表达式是目标宽度 $\\tilde{\\sigma}$ 和变换函数 $f(s)$ 的局域导数的函数。", "answer": "$$\\boxed{\\frac{\\tilde{\\sigma}}{|f'(s)|}}$$", "id": "3461459"}, {"introduction": "良好调节元动力学 (Well-Tempered Metadynamics) 的有效性依赖于一个核心假设：所选的集体变量表现出近似扩散的行为。本练习将挑战您分析当这一核心假设因隐藏的慢变量或迟滞效应而被违反时会发生什么，并评估用于解决这类常见实际问题的先进策略。[@problem_id:3461537]", "problem": "考虑一个分子系统，其微观坐标为 $q \\in \\mathbb{R}^N$，在温度 $T$ 下遵循欠阻尼朗之万动力学演化，质量矩阵为 $\\mathbf{M}$，保守势为 $U(q)$，摩擦系数为 $\\gamma$。一个标量集体变量（CV）$s(q)$ 被用来通过一个随时间变化的偏置势 $V_{\\mathrm{bias}}(s,t)$ 来偏置采样。在没有偏置势的情况下，微观运动方程为\n$$\n\\mathbf{M} \\ddot{q}(t) = - \\nabla U(q(t)) - \\gamma \\mathbf{M} \\dot{q}(t) + \\xi(t),\n$$\n其中 $\\xi(t)$ 是一个高斯随机力，其均值为零，协方差与涨落-耗散关系一致。在适温元动力学（WTMetaD）中，假设偏置变量 $s(q(t))$ 的演化在投影后可以被建模为一个有效的、近似马尔可夫的扩散过程，因此概率密度 $\\rho(s,t)$ 遵循一个福克-普朗克方程，其概率流 $J_s(s,t)$ 由一个与有效自由能梯度成正比的漂移项和一个扩散系数决定。\n\n然而，假设由于隐藏的慢变量 $u(q)$ 或构型空间区域中的结构迟滞， $s(q(t))$ 的投影动力学表现出非扩散特征：条件平均速率 $\\langle \\dot{s} \\mid s \\rangle$ 具有一个持续的、依赖于构型的确定性分量，并且投影噪声表现出记忆效应。这可以通过为 $s(t)$ 写出一个广义朗之万方程（GLE）来描述，形式如下\n$$\nm_s \\ddot{s}(t) = - \\partial_s F(s) - \\partial_s V_{\\mathrm{bias}}(s,t) - \\int_0^t K(t-\\tau) \\dot{s}(\\tau) \\, \\mathrm{d}\\tau + \\eta_s(t) + \\delta f(s,u),\n$$\n其中 $F(s)$ 是作为 $s$ 的函数的自由能，$K(t)$ 是一个记忆核，$\\eta_s(t)$ 是一个与该GLE的涨落-耗散关系一致的有色高斯噪声，而 $\\delta f(s,u)$ 是由隐藏变量 $u$ 引起的额外确定性漂移，它不能表示为仅与 $s$ 有关的状态函数的 $- \\partial_s$。因此，边缘概率 $\\rho(s,t)$ 的概率流具有以下形式\n$$\nJ_s(s,t) = v(s) \\, \\rho(s,t) - D(s) \\, \\partial_s \\rho(s,t),\n$$\n其中，非零的系统漂移 $v(s)$ 源于 $\\delta f(s,u)$，而有效扩散 $D(s)$ 因记忆效应而修正。\n\nWTMetaD 根据对 $s$ 的访问情况沉积偏置势，并采用一个旨在实现 $s$ 的稳态目标边缘分布同时防止过度填充的调温方案。从随机投影和概率连续性的第一性原理出发，分析投影动力学中非零 $v(s)$ 和记忆的存在如何影响 WTMetaD 关于马尔可夫性和扩散行为的假设，以及在偏置势沉积下零流稳态的存在性。根据您的分析，选择所有正确的陈述。\n\nA. 非扩散的CV动力学不影响适温元动力学中渐近偏置势的推导；即使存在持续的确定性漂移 $v(s) \\neq 0$，WTMetaD偏置势也会收敛到仅依赖于 $s$ 的真实自由能的一个缩放版本。\n\nB. 非零的系统漂移 $v(s)$ 意味着非零的概率流 $J_s(s,t)$；除非偏置势通过一个关于 $s$ 的梯度精确地抵消 $v(s)$，否则 WTMetaD 所假设的零流稳态不存在，这会导致偏置势持续增长和重构的自由能失真。\n\nC. 一种补救方法是引入一个与 $s$ 耦合的辅助扩展变量 $\\zeta$，赋予其过阻尼朗之万动力学，并在 $\\zeta$ 上应用 WTMetaD；通过适当的时间尺度分离和摩擦，这可以为偏置变量恢复近似的马尔可夫扩散行为，并减轻迟滞效应。\n\nD. 在 WTMetaD 中增加高斯沉积的高度或速率足以消除迟滞和确定性漂移，从而确保尽管存在非扩散的CV动力学，偏置势仍能收敛到正确的自由能。\n\nE. 构建一个局部正交化的偏置坐标 $\\tilde{s}(q) = s(q) - \\lambda(q) \\, u(q)$，其中 $\\lambda(q)$ 的选择使得在每个构型下都有 $\\nabla \\tilde{s}(q) \\cdot \\mathbf{M}^{-1} \\nabla u(q) = 0$，这会抑制由 $u$ 引起的 $s$ 的确定性漂移，并为 $\\tilde{s}$ 恢复更具扩散性的行为，从而改进 WTMetaD 的偏置势优化。\n\nF. 对物理自由度应用速度重标度恒温器可以保证在CV层面上存在白噪声驱动力，从而即使在投影动力学中存在迟滞和记忆效应的情况下，也能验证 WTMetaD 的假设。\n\n选择所有正确的选项。", "solution": "问题陈述是适定的、有科学依据的、并且是客观的。它准确地描述了增强采样模拟中一个已知的挑战，其中所选的集体变量（CV）不表现出理想的、马尔可夫的扩散动力学。引入带有记忆核和非势漂移项的广义朗之万方程（GLE）是分析此类投影动力学的标准理论框架（可从 Mori-Zwanzig 形式推导）。该问题是有效的，并且可以从第一性原理解决。\n\n适温元动力学（WTMetaD）的收敛性基于这样一个假设：集体变量 $s$ 的偏置动力学可以描述为势能面上的一个简单扩散过程。总有效势是内禀自由能 $F(s)$ 和沉积的偏置势 $V_{\\mathrm{bias}}(s,t)$ 的和。在这个理想化的图像中，过阻尼极限下的概率流由下式给出：\n$$ J_s(s,t) = -\\frac{D(s)}{k_B T} \\rho(s,t) \\frac{\\partial}{\\partial s} \\left( F(s) + V_{\\mathrm{bias}}(s,t) \\right) $$\n其中 $D(s)$ 是扩散系数，$T$ 是温度，$k_B$ 是玻尔兹曼常数，$\\rho(s,t)$ 是CV的概率密度。WTMetaD 被设计用来达到一个概率流消失的准稳态，即 $J_s(s,t) \\to 0$。这个条件意味着总的金兹堡-朗道自由能是平坦的，即 $F(s) + V_{\\mathrm{bias}}(s,t) = \\text{常数}$。该算法的构造使得偏置势收敛到自由能的一个缩放版本，$V_{\\mathrm{bias}}(s,t \\to \\infty) = - \\frac{\\gamma_{WT}-1}{\\gamma_{WT}} F(s)$，其中 $\\gamma_{WT}$ 是偏置因子。\n\n问题引入了一个复杂情况：投影动力学是非扩散的。概率流被给出为：\n$$ J_s(s,t) = v(s) \\, \\rho(s,t) - D(s) \\, \\partial_s \\rho(s,t) $$\n在这里，$v(s)$ 是一个系统性的、确定性的漂移速度，它不是从 $s$ 的势函数的梯度推导出来的。它源于与隐藏的慢变量 $u(q)$ 的耦合，这在投影到 $s$ 的动力学中引入了一个非保守“力”。项 $- D(s) \\, \\partial_s \\rho(s,t)$ 是标准的菲克扩散流。偏置系统的总流应该包含来自 $F(s)+V_{\\mathrm{bias}}(s,t)$ 的保守力和非保守漂移 $v(s)$。福克-普朗克方程中总漂移速度（平流项）的一个更完整的形式将导致如下的流：\n$$ J_s(s,t) = \\left[ -\\mu(s) \\frac{\\partial}{\\partial s}(F(s)+V_{\\mathrm{bias}}(s,t)) + v(s) \\right] \\rho(s,t) - D(s) \\partial_s \\rho(s,t) $$\n其中 $\\mu(s)$ 是迁移率，通过爱因斯坦关系 $D(s) = \\mu(s) k_B T$ 与 $D(s)$ 相关联。\nWTMetaD 的基本假设是实现一个零流稳态，$J_s(s,t \\to \\infty) = 0$。让我们来检验这个条件。对于一个稳态分布 $\\rho_{final}(s)$，条件 $J_s = 0$ 意味着：\n$$ D(s) \\frac{\\partial \\rho_{final}(s)}{\\partial s} = \\left[ -\\frac{D(s)}{k_B T} \\frac{\\partial}{\\partial s}(F(s)+V_{\\mathrm{bias}}(s)) + v(s) \\right] \\rho_{final}(s) $$\n$$ \\frac{1}{\\rho_{final}(s)}\\frac{\\partial \\rho_{final}(s)}{\\partial s} = -\\frac{1}{k_B T} \\frac{\\partial}{\\partial s}(F(s)+V_{\\mathrm{bias}}(s)) + \\frac{v(s)}{D(s)} $$\n现在，WTMetaD 被设计用来产生一个特定的稳态分布，即 $\\rho_{final}(s) \\propto \\exp\\left(-\\frac{F(s)+V_{\\mathrm{bias}}(s)}{k_B(T+\\Delta T)}\\right)$。对其对数取空间导数得到：\n$$ \\frac{1}{\\rho_{final}(s)}\\frac{\\partial \\rho_{final}(s)}{\\partial s} = -\\frac{1}{k_B(T+\\Delta T)} \\frac{\\partial}{\\partial s}(F(s)+V_{\\mathrm{bias}}(s)) $$\n将两个关于 $\\partial_s \\ln \\rho_{final}(s)$ 的表达式相等，我们得到：\n$$ -\\frac{1}{k_B(T+\\Delta T)} \\frac{\\partial}{\\partial s}(F(s)+V_{\\mathrm{bias}}(s)) = -\\frac{1}{k_B T} \\frac{\\partial}{\\partial s}(F(s)+V_{\\mathrm{bias}}(s)) + \\frac{v(s)}{D(s)} $$\n整理各项：\n$$ \\left( \\frac{1}{k_B T} - \\frac{1}{k_B(T+\\Delta T)} \\right) \\frac{\\partial}{\\partial s}(F(s)+V_{\\mathrm{bias}}(s)) = \\frac{v(s)}{D(s)} $$\n$$ \\left( \\frac{\\Delta T}{k_B T (T+\\Delta T)} \\right) \\frac{\\partial}{\\partial s}(F(s)+V_{\\mathrm{bias}}(s)) = \\frac{v(s)}{D(s)} $$\n这个方程显示了一个根本性的矛盾。WTMetaD的收敛要求项 $\\frac{\\partial}{\\partial s}(F(s)+V_{\\mathrm{bias}}(s))$ 不为零（这是使非平坦景观变平坦的驱动力）。如果 $v(s) \\neq 0$，这个方程原则上可以被满足。然而，WTMetaD自身的机制导致了一个特定的 $V_{bias}$ 形式，即 $V_{bias} \\propto -F(s)$，这使得 $\\frac{\\partial}{\\partial s}(F(s)+V_{\\mathrm{bias}}(s)) \\propto \\frac{\\partial F(s)}{\\partial s}$。\n$v(s) \\neq 0$ 的存在意味着该稳态本质上是一个非平衡态。零流状态无法与 WTMetaD 的目标分布同时实现。这种不匹配阻止了偏置势的正确收敛。\n\n---\n\n**A. 非扩散的CV动力学不影响适温元动力学中渐近偏置势的推导；即使存在持续的确定性漂移 $v(s) \\neq 0$，WTMetaD偏置势也会收敛到仅依赖于 $s$ 的真实自由能的一个缩放版本。**\n该陈述不正确。如上所述，非零系统漂移 $v(s)$ 的存在与 WTMetaD 收敛到自由能 $F(s)$ 的缩放版本所需的条件根本不相容。WTMetaD收敛性证明所依据的零流稳态假设被违反了。\n\n**B. 非零的系统漂移 $v(s)$ 意味着非零的概率流 $J_s(s,t)$；除非偏置势通过一个关于 $s$ 的梯度精确地抵消 $v(s)$，否则 WTMetaD 所假设的零流稳态不存在，这会导致偏置势持续增长和重构的自由能失真。**\n该陈述是正确的。漂移 $v(s)$ 源于一个不能表示为仅与 $s$ 有关的函数梯度的项 $\\delta f(s,u)$，这意味着它代表了 $s$ 空间中的一个非保守力。一个作为 $s$ 的标量函数的偏置势 $V_{\\mathrm{bias}}(s)$ 只能产生一个保守力 $-\\partial_s V_{\\mathrm{bias}}(s)$。它通常不能抵消非保守漂移。因此，零概率流状态（$J_s=0$）是无法达到的。系统被永久驱动，导致一个持续的流。WTMetaD 将不断沉积偏置势以试图抵消这个流，从而阻止收敛并导致重构的自由能失真。\n\n**C. 一种补救方法是引入一个与 $s$ 耦合的辅助扩展变量 $\\zeta$，赋予其过阻尼朗之万动力学，并在 $\\zeta$ 上应用 WTMetaD；通过适当的时间尺度分离和摩擦，这可以为偏置变量恢复近似的马尔可夫扩散行为，并减轻迟滞效应。**\n该陈述是正确的。它描述了扩展拉格朗日方法背后的核心思想，例如一种形式的扩展拉格朗日元动力学或即时概率增强采样（on-the-fly probability enhanced sampling, OPES）。通过将物理CV $s(q)$ 与一个虚拟变量 $\\zeta$ 耦合（例如，通过谐波势 $V_{cpl} = \\frac{k}{2}(s(q)-\\zeta)^2$）并在 $\\zeta$ 上施加偏置势，可以减轻非马尔可夫动力学的问题。如果 $\\zeta$ 的动力学变得非常缓慢（高摩擦/大质量），$\\zeta$ 会响应 $s(q)$ 的时间平均性质，有效地滤除了复杂的记忆效应和迟滞。由于 $\\zeta$ 本身遵循一个简单的、预设的朗之万方程，其动力学是马尔可夫和扩散的，使其成为 WTMetaD 的合适目标。\n\n**D. 在 WTMetaD 中增加高斯沉积的高度或速率足以消除迟滞和确定性漂移，从而确保尽管存在非扩散的CV动力学，偏置势仍能收敛到正确的自由能。**\n该陈述不正确。增加偏置势沉积速率（通过增加高斯函数的高度或更频繁地沉积）并不能解决根本问题，即非保守漂移 $v(s)$。更快的沉积会更积极地推动系统，但它不会使底层动力学更具扩散性或消除漂移。事实上，对于远离平衡的系统，已知的更高沉积速率会加剧误差并导致更大的系统性失真。\n\n**E. 构建一个局部正交化的偏置坐标 $\\tilde{s}(q) = s(q) - \\lambda(q) \\, u(q)$，其中 $\\lambda(q)$ 的选择使得在每个构型下都有 $\\nabla \\tilde{s}(q) \\cdot \\mathbf{M}^{-1} \\nabla u(q) = 0$，这会抑制由 $u$ 引起的 $s$ 的确定性漂移，并为 $\\tilde{s}$ 恢复更具扩散性的行为，从而改进 WTMetaD 的偏置势优化。**\n该陈述是正确的。有问题的漂移 $v(s)$ 源于所选CV $s$ 与隐藏慢变量 $u$ 之间的动态耦合。条件 $\\nabla \\tilde{s}(q) \\cdot \\mathbf{M}^{-1} \\nabla u(q) = 0$ 强制了新CV $\\tilde{s}$ 与隐藏变量 $u$ 之间的动力学正交性。这种正交性条件旨在解耦它们的动力学。通过最小化 $u$ 的运动在 $\\tilde{s}$ 方向上的投影，可以抑制 $u$ 施加在CV动力学上的非势作用力。这会产生一个新的CV $\\tilde{s}$，其动力学更加“理想”——即更具扩散性，且具有小得多的系统漂移 $v_{\\tilde{s}}(\\tilde{s}) \\approx 0$。这是一种寻找更适合像 WTMetaD 这样的方法的最优反应坐标的复杂策略。\n\n**F. 对物理自由度应用速度重标度恒温器可以保证在CV层面上存在白噪声驱动力，从而即使在投影动力学中存在迟滞和记忆效应的情况下，也能验证 WTMetaD 的假设。**\n该陈述不正确。恒温器的选择（例如，朗之万、Nosé-Hoover、速度重标度）控制着整个 $N$ 维系统的温度。CV空间中的记忆效应和系统漂移是高维动力学到由 $s(q)$ 定义的低维流形上的*投影*的后果。这是投影算符理论（例如 Mori-Zwanzig 形式）的一个基本结果。即使完整系统动力学是完全正则的并由白噪声驱动，任意CV上的投影动力学通常也是非马尔可夫的（具有记忆核和有色噪声）。恒温器的选择不会改变这个数学现实。迟滞和记忆的问题是势能面和CV选择所固有的，而不是恒温器的问题。", "answer": "$$\\boxed{BCE}$$", "id": "3461537"}, {"introduction": "在任何增强抽样模拟中，一个关键问题是“模拟何时收敛？”。这个动手编程练习将指导您实现一个复杂的、统计上稳健的模拟停止准则，它将重要性采样与自举法 (bootstrap) 分析相结合，以量化结果的不确定性。[@problem_id:3461487]", "problem": "给定一个一维集体变量 $s \\in \\mathbb{R}$ 和一个潜在的无偏平均力势 $U(s)$，它通过玻尔兹曼定律在绝对温度 $T$ 下控制平衡分布。在一个偏置分子动力学协议（例如良温元动力学）中，一个随时间变化的偏置 $V(s,t)$ 被添加到势能中，这会改变采样分布。假设在两个连续的时间窗口 $[t-\\Delta t, t)$ 和 $[t, t+\\Delta t)$ 中，偏置是准静态的，可以分别近似为 $V_{\\text{old}}(s) = -b_{\\text{old}} U(s)$ 和 $V_{\\text{new}}(s) = -b_{\\text{new}} U(s)$，其中 $b_{\\text{old}}, b_{\\text{new}} \\in [0,1)$。这与良温元动力学一致，在良温元动力学中，偏置与自由能成正比，并按小于一的因子进行缩放。设无偏自由能曲线（在相差一个加性常数的情况下）定义为 $F(s) = -\\beta^{-1} \\ln P(s)$，其中 $\\beta = 1/(k_{\\mathrm{B}} T)$，$P(s)$ 是 $s$ 的平衡概率密度。通过选择一个参考值 $s_{\\mathrm{ref}}$ 使得 $F(s_{\\mathrm{ref}}) = 0$ 来固定该加性常数。\n\n您的任务是设计并实现一个概率性停止规则，当两个时间窗口之间的曲线收敛时，该规则将停止运行。请使用以下仅包含原理的基础：\n\n- 一个构象的玻尔兹曼权重与 $\\exp(-\\beta U)$ 成正比。\n- 在加性偏置 $V(s,t)$ 下，采样权重变为与 $\\exp(-\\beta(U+V))$ 成正比。\n- 重要性采样允许通过对来自另一个分布的样本进行重加权，来重构某个分布下的期望值。\n\n基于此基础，推导并实现：\n\n1. 通过在 $s$ 的观测支撑集上的 $M$ 个区间的均匀网格上进行重要性采样，从偏置样本 $(s_i, V_i)$ 中得到无偏自由能曲线 $F(s)$ 的一致估计量。您必须推导出如何使用作为 $V_i$ 函数的权重来构建 $P(s)$ 的归一化估计，然后得到相差一个加性常数的 $F(s)$。通过强制在 $s_{\\mathrm{ref}}=0$ 处 $F(s_{\\mathrm{ref}})=0$ 来对齐曲线。\n2. 用于两个连续曲线的收敛度量，由整个网格上的一致范数给出，$d_{\\infty} = \\max_k |F_{\\text{new}}(s_k) - F_{\\text{old}}(s_k)|$，其中 $\\{s_k\\}_{k=1}^M$ 是区间中心。\n3. 对事件 $d_{\\infty}  \\varepsilon$ 的基于自助法（bootstrap）的置信度估计量，其中 $\\varepsilon$ 是给定的容差，单位为千焦/摩尔（kJ/mol）。对每个窗口中观测到的 $s$ 值进行有放回重采样，其选择概率与您从基础上推导出的重要性权重成正比，以生成 $F_{\\text{old}}$ 和 $F_{\\text{new}}$ 的自助法复制样本。对于每个自助法复制样本，使用完全相同的网格和参考对齐方式重新计算 $d_{\\infty}$。估计的置信度是满足 $d_{\\infty}  \\varepsilon$ 的自助法复制样本所占的比例。当且仅当估计的置信度大于或等于指定的阈值 $c \\in (0,1)$ 时，停止决策为“停止”。\n\n实现细节和约束：\n\n- 潜在的无偏势是一个对称双阱 $U(s) = k (s^2 - a^2)^2$，其中 $k$ 和 $a$ 已给定。\n- 每个窗口内的采样应使用 Metropolis–Hastings 随机游走，从与 $\\exp(-\\beta[U(s)+V(s)])$ 成正比的偏置玻尔兹曼分布中进行。该随机游走使用具有固定标准差的高斯提议分布。使用“老化”（burn-in）和“稀疏化”（thinning）策略以获得近似独立的样本，然后分别为旧窗口和新窗口收集确切数量的 $N_{\\text{old}}$ 和 $N_{\\text{new}}$ 个样本。\n- 自由能网格应该为每个测试用例构建一次，方法是汇集两个窗口的 $s$ 样本以确定观测到的最小值和最大值，然后在此区间上创建 $M$ 个等宽的区间。参考值 $s_{\\mathrm{ref}}=0$ 必须对齐到最近的区间中心。\n- 为避免未定义的对数，请实现一个数值稳定的策略，以确保在计算对数之前所有区间中的估计概率都严格为正。由此产生的调整必须在原始估计和自助法估计中保持一致。\n\n物理单位和常数：\n\n- 温度 $T$ 以开尔文（K）为单位指定。使用摩尔形式的玻尔兹曼常数，即通用气体常数 $R$，单位为千焦/摩尔/开尔文：$R = 0.00831446261815324$ kJ/(mol·K)。因此，$\\beta = 1/(R T)$，单位为 mol/kJ。\n- 容差 $\\varepsilon$ 以千焦/摩尔（kJ/mol）为单位报告。自由能曲线 $F(s)$ 及其差异也以千焦/摩尔（kJ/mol）为单位。\n- 此问题中不使用角度。\n\n测试套件和要求的输出：\n\n实现您的程序，以评估以下四个测试用例的停止决策。对于每个测试用例，您必须使用独立的随机种子以使结果具有确定性。每个测试用例是一个元组：\n(seed, T_K, k_kJ_per_mol, a, b_old, b_new, N_old, N_new, M_bins, epsilon_kJ_per_mol, confidence_threshold, B_bootstrap)\n\n使用以下测试用例列表：\n1. (42, 300.0, 5.0, 1.0, 0.30, 0.50, 4000, 4000, 80, 0.50, 0.95, 200)\n2. (7, 300.0, 5.0, 1.0, 0.30, 0.50, 500, 500, 80, 0.05, 0.95, 200)\n3. (123, 300.0, 5.0, 1.0, 0.00, 0.80, 1200, 1200, 100, 0.12, 0.90, 200)\n4. (2021, 300.0, 5.0, 1.0, 0.40, 0.60, 2500, 2500, 90, 0.40, 0.90, 150)\n\n您的程序应生成单行输出，其中包含一个逗号分隔的 Python 风格的布尔值列表，按测试用例的顺序排列。例如，输出行必须如下所示：\n[True,False,True,False]\n\n不应打印任何其他文本。如果 $d_{\\infty}  \\varepsilon$ 的估计自助法置信度大于或等于指定的置信度阈值，则决策为停止，否则不停止。所有计算必须以双精度浮点算术进行。", "solution": "用户提供了一个在计算统计力学领域定义明确的问题。\n\n### 第一步：提取已知条件\n- **系统**：一个一维集体变量 $s \\in \\mathbb{R}$。\n- **无偏势**：$U(s) = k (s^2 - a^2)^2$。\n- **温度**：$T$，单位为开尔文（K）。\n- **玻尔兹曼常数（摩尔）**：通用气体常数 $R = 0.00831446261815324 \\text{ kJ/(mol·K)}$。\n- **逆温度**：$\\beta = 1/(R T)$。\n- **偏置势**：\n  - 在窗口 $[t-\\Delta t, t)$ 中，$V_{\\text{old}}(s) = -b_{\\text{old}} U(s)$，其中 $b_{\\text{old}} \\in [0,1)$。\n  - 在窗口 $[t, t+\\Delta t)$ 中，$V_{\\text{new}}(s) = -b_{\\text{new}} U(s)$，其中 $b_{\\text{new}} \\in [0,1)$。\n- **无偏自由能**：$F(s) = -\\beta^{-1} \\ln P(s)$，其中 $P(s)$ 是平衡概率密度。\n- **参考条件**：在 $s_{\\mathrm{ref}}=0$ 处，$F(s_{\\mathrm{ref}}) = 0$。\n- **任务**：实现一个基于两个窗口间自由能曲线收敛情况的概率性停止规则。\n- **方法论**：\n  1.  **自由能估计量**：使用对偏置样本 $(s_i, V_i)$ 的重要性采样，重加权至无偏分布 $P(s)$，然后在 $M$ 个区间的均匀网格上计算 $F(s)$。\n  2.  **收敛度量**：$d_{\\infty} = \\max_k |F_{\\text{new}}(s_k) - F_{\\text{old}}(s_k)|$。\n  3.  **自助法置信度**：使用有放回重采样估计 $d_{\\infty}  \\varepsilon$ 的置信度。重采样的选择概率必须与重要性权重成正比。如果置信度 $\\geq c$，则决策为停止。\n- **实现约束**：\n  - **采样**：使用高斯提议分布的 Metropolis-Hastings 随机游走，进行老化和稀疏化处理。收集 $N_{\\text{old}}$ 和 $N_{\\text{new}}$ 个样本。\n  - **网格**：在样本的汇集范围上划分 $M$ 个区间。将参考点 $s_{\\mathrm{ref}}=0$ 对齐到最近的区间中心。\n  - **数值稳定性**：在取对数前确保概率严格为正。\n- **测试用例**：提供了四个元组：`(seed, T_K, k, a, b_old, b_new, N_old, N_new, M_bins, epsilon_kJ_per_mol, confidence_threshold, B_bootstrap)`。\n- **输出**：单行 Python 风格的布尔值列表，例如 `[True,False,True,False]`。\n\n### 第二步：使用提取的已知条件进行验证\n- **科学基础**：该问题在统计力学和计算物理学的原理上有坚实的基础。它利用了标准技术，如玻尔兹曼分布、元动力学、Metropolis-Hastings 采样、重要性采样和自助法分析。近似 $V(s) = -b U(s)$ 对于良温元动力学中的准静态状态是一个合理的简化，在该状态下，偏置势预计会收敛到自由能的缩放版本，而对于一维系统，$F(s) \\approx U(s) + \\text{const}$。\n- **良构性**：该问题是良构的。它提供了所有必要的参数、清晰的算法步骤以及固定的随机种子，以确保结果是确定且唯一的。采样参数（提议宽度、老化步数、稀疏化间隔）未指定，这意味着应做出标准的、合理的选择，这是常见的做法。\n- **客观性**：该问题以精确、客观和数学化的语言陈述，没有任何主观元素。\n- **缺陷清单**：该问题不违反任何无效标准。它科学合理、可形式化、完整、可行、结构良好、不平凡且可验证。\n\n### 第三步：结论与行动\n问题是**有效的**。将逐步开发并实现一个解决方案。\n\n### 基于原理的设计\n该解决方案是问题陈述中概述的原理和程序的直接实现。\n\n**1. 基础：玻尔兹曼统计和偏置采样**\n无偏系统的平衡概率密度为 $P_{\\text{unbiased}}(s) \\propto \\exp(-\\beta U(s))$，其中 $\\beta = 1/(RT)$。模拟在偏置势 $E(s) = U(s) + V(s)$ 下进行，产生偏置采样分布 $P_{\\text{biased}}(s) \\propto \\exp(-\\beta(U(s) + V(s)))$。给定的偏置形式为 $V(s) = -b U(s)$，因此采样的有效势为 $E(s) = (1-b)U(s)$。使用 Metropolis-Hastings 算法从 $P_{\\text{biased}}(s)$ 生成样本。\n\n**2. 通过重要性采样重构自由能**\n为了从来自 $P_{\\text{biased}}(s)$ 的样本 $\\{s_i\\}$ 中恢复无偏分布 $P_{\\text{unbiased}}(s)$，我们采用重要性采样。每个样本 $s_i$ 被赋予一个权重 $w_i$ 来校正偏置：\n$$ w_i = \\frac{P_{\\text{unbiased}}(s_i)}{P_{\\text{biased}}(s_i)} = \\frac{\\exp(-\\beta U(s_i))}{\\exp(-\\beta(U(s_i) + V(s_i)))} = \\exp(\\beta V(s_i)) $$\n对于特定的偏置 $V(s_i) = -b U(s_i)$，权重变为 $w_i = \\exp(-\\beta b U(s_i))$。\n\n**3. 离散化和曲线估计**\n集体变量 $s$ 在其观测范围内被离散化为 $M$ 个区间。对于一组给定的偏置样本 $\\{s_i\\}$ 及其对应的权重 $\\{w_i\\}$，系统处于区间 $k$ 的概率 $P_k$ 通过落入该区间的样本权重的归一化总和来估计：\n$$ \\hat{P}_k = \\frac{\\sum_{i \\text{ where } s_i \\in \\text{bin } k} w_i}{\\sum_{j=1}^N w_j} $$\n然后，在每个区间中心 $s_k$ 处估计自由能曲线 $F(s)$。在参考区间 $k_{\\text{ref}}$ 处对齐后，表达式简化为：\n$$ F(s_k) = -\\beta^{-1} \\ln(\\hat{P}_k) - (-\\beta^{-1} \\ln(\\hat{P}_{k_{\\text{ref}}})) = -\\beta^{-1} \\ln\\left(\\frac{\\hat{P}_k}{\\hat{P}_{k_{\\text{ref}}}}\\right) $$\n区间宽度项在对齐过程中被抵消。为确保数值稳定性，在归一化之前向每个区间的计数中添加一个小的正常数（例如，机器精度），以防止对零取对数。\n\n**4. 用于收敛性的自助法置信度估计**\n自由能曲线的统计不确定性通过自助法程序进行评估。问题指定了采样-重要性-重采样（SIR）方法：\n1.  对于每个窗口（“旧”和“新”），在原始样本 $\\{s_i\\}$ 上创建一个新的概率分布，其中选择 $s_i$ 的概率与其重要性权重成正比，$p_i = w_i / \\sum_j w_j$。\n2.  通过根据这些概率 $\\{p_i\\}$ 从原始集合中有放回地抽取 $N$ 个样本来生成一个自助法复制样本。这个新集合 $\\{s'_{j}\\}$ 是目标无偏分布的一个近似无权重样本。\n3.  对于每个自助法复制样本，通过构建自助法样本 $\\{s'_{j}\\}_{\\text{old}}$ 和 $\\{s'_{j}\\}_{\\text{new}}$ 的标准（无权重）直方图，归一化以找到概率，取对数，并在参考区间处对齐，来计算自由能曲线 $F_{\\text{old}}^{\\text{boot}}(s_k)$ 和 $F_{\\text{new}}^{\\text{boot}}(s_k)$。\n4.  计算该自助法复制样本的收敛度量：$d_{\\infty}^{\\text{boot}} = \\max_k |F_{\\text{new}}^{\\text{boot}}(s_k) - F_{\\text{old}}^{\\text{boot}}(s_k)|$。\n5.  对 $B_{\\text{bootstrap}}$ 个复制样本重复此过程。置信度是满足 $d_{\\infty}^{\\text{boot}}  \\varepsilon$ 的复制样本所占的比例。\n\n**5. 停止规则**\n如果估计的置信度大于或等于指定的阈值 $c$，则认为模拟已收敛，过程停止（返回 `True`）。否则，继续进行（返回 `False`）。对每个指定的测试用例都实现了这一完整算法。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem, executing the probabilistic stopping rule\n    for each specified test case.\n    \"\"\"\n\n    # Universal gas constant in kJ/(mol·K)\n    R_KJ_MOL_K = 0.00831446261815324\n    \n    # Small constant for numerical stability to avoid log(0)\n    TINY = np.finfo(np.float64).tiny\n\n    # Test cases as defined in the problem statement.\n    test_cases = [\n        # (seed, T_K, k, a, b_old, b_new, N_old, N_new, M_bins, epsilon_kJ_per_mol, confidence_threshold, B_bootstrap)\n        (42, 300.0, 5.0, 1.0, 0.30, 0.50, 4000, 4000, 80, 0.50, 0.95, 200),\n        (7, 300.0, 5.0, 1.0, 0.30, 0.50, 500, 500, 80, 0.05, 0.95, 200),\n        (123, 300.0, 5.0, 1.0, 0.00, 0.80, 1200, 1200, 100, 0.12, 0.90, 200),\n        (2021, 300.0, 5.0, 1.0, 0.40, 0.60, 2500, 2500, 90, 0.40, 0.90, 150)\n    ]\n\n    def _process_case(seed, T_K, k, a, b_old, b_new, N_old, N_new, M_bins,\n                      epsilon_kJ_per_mol, confidence_threshold, B_bootstrap):\n        \"\"\"\n        Processes a single test case, from sampling to the final stopping decision.\n        \"\"\"\n        \n        np.random.seed(seed)\n        \n        # --- 1. Setup Potentials and Constants ---\n        beta = 1.0 / (R_KJ_MOL_K * T_K)\n\n        def U(s):\n            return k * (s**2 - a**2)**2\n\n        def E_old(s):\n            # Total potential for the 'old' window's biased sampling\n            return (1.0 - b_old) * U(s)\n\n        def E_new(s):\n            # Total potential for the 'new' window's biased sampling\n            return (1.0 - b_new) * U(s)\n        \n        def V_old(s):\n            # Bias potential for the 'old' window\n            return -b_old * U(s)\n\n        def V_new(s):\n            # Bias potential for the 'new' window\n            return -b_new * U(s)\n\n        # --- 2. MCMC Sampling ---\n        def run_mcmc(potential_func, n_samples):\n            # MCMC parameters are chosen to be reasonable for typical molecular simulations.\n            proposal_std = 0.2\n            burn_in_steps = 5000\n            thinning_interval = 20\n            total_steps = burn_in_steps + n_samples * thinning_interval\n            \n            samples = np.zeros(n_samples, dtype=np.float64)\n            current_s = 0.0  # Start walker at s=0.0\n            current_E = potential_func(current_s)\n            \n            sample_idx = 0\n            for step in range(total_steps):\n                proposed_s = current_s + np.random.normal(0.0, proposal_std)\n                proposed_E = potential_func(proposed_s)\n                \n                # Metropolis acceptance criterion\n                delta_E = proposed_E - current_E\n                if delta_E  0 or np.random.rand()  np.exp(-beta * delta_E):\n                    current_s = proposed_s\n                    current_E = proposed_E\n                \n                # Collect sample after burn-in and at thinning intervals\n                if step >= burn_in_steps:\n                    if (step - burn_in_steps) % thinning_interval == 0:\n                        if sample_idx  n_samples:\n                            samples[sample_idx] = current_s\n                            sample_idx += 1\n            return samples\n\n        samples_old = run_mcmc(E_old, N_old)\n        samples_new = run_mcmc(E_new, N_new)\n\n        # --- 3. Grid Construction ---\n        all_samples = np.concatenate((samples_old, samples_new))\n        s_min, s_max = np.min(all_samples), np.max(all_samples)\n        bins = np.linspace(s_min, s_max, M_bins + 1, dtype=np.float64)\n        bin_centers = (bins[:-1] + bins[1:]) / 2.0\n        ref_idx = np.argmin(np.abs(bin_centers - 0.0))\n\n        # --- 4. Free Energy Calculation Logic (for bootstrap samples) ---\n        def calculate_F_from_unweighted(samples, bins, beta, ref_idx):\n            counts, _ = np.histogram(samples, bins=bins)\n            # Add TINY for numerical stability, then normalize to get probability\n            prob = (counts + TINY) / np.sum(counts + TINY)\n            F_raw = - (1.0 / beta) * np.log(prob)\n            # Align profile to reference\n            F_aligned = F_raw - F_raw[ref_idx]\n            return F_aligned\n\n        # --- 5. Bootstrap Analysis ---\n        # Calculate importance weights and resampling probabilities for SIR\n        weights_old = np.exp(beta * V_old(samples_old))\n        p_old = weights_old / np.sum(weights_old)\n        \n        weights_new = np.exp(beta * V_new(samples_new))\n        p_new = weights_new / np.sum(weights_new)\n\n        converged_count = 0\n        for _ in range(B_bootstrap):\n            # Generate bootstrap samples via Sampling-Importance-Resampling (SIR)\n            s_boot_old = np.random.choice(samples_old, size=N_old, replace=True, p=p_old)\n            s_boot_new = np.random.choice(samples_new, size=N_new, replace=True, p=p_new)\n            \n            # These bootstrap samples are now unweighted draws from the target distribution.\n            # Calculate FE profiles directly from their unweighted histograms.\n            F_boot_old = calculate_F_from_unweighted(s_boot_old, bins, beta, ref_idx)\n            F_boot_new = calculate_F_from_unweighted(s_boot_new, bins, beta, ref_idx)\n            \n            # Calculate convergence metric for this bootstrap replicate\n            d_infty_boot = np.max(np.abs(F_boot_new - F_boot_old))\n            \n            if d_infty_boot  epsilon_kJ_per_mol:\n                converged_count += 1\n                \n        confidence = converged_count / B_bootstrap\n        \n        # --- 6. Final Decision ---\n        return confidence >= confidence_threshold\n\n    results = []\n    for case in test_cases:\n        decision = _process_case(*case)\n        results.append(decision)\n\n    # Final print statement must match the required format exactly.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3461487"}]}