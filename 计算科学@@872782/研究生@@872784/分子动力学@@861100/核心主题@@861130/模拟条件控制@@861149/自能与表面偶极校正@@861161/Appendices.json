{"hands_on_practices": [{"introduction": "为建立对静电校正的坚实理解，我们首先回归到基本原理。“自能”这一概念描述了电荷与其在周围环境中感应出的极化之间的相互作用。本练习 [@problem_id:3444065] 邀请您从零开始，使用强大的镜像电荷法，为一个经典模型系统——一个位于平面介电界面附近的点电荷——推导出这种能量。", "problem": "考虑一个分子动力学 (MD) 模拟，其中一个点电荷 $q$ 处于一个占据 $z>0$ 的线性、均匀、各向同性的电介质半空间中，其绝对介电常数为 $\\epsilon_1$。占据 $z0$ 的半空间是另一个线性、均匀、各向同性的电介质，其绝对介电常数为 $\\epsilon_2$。平面界面位于 $z=0$ 处，没有自由界面电荷，且系统是静态的。点电荷位于位置 $\\mathbf{r}_0=(0,0,d)$，其中 $d>0$。\n\n您的目标是从静电学的基本原理出发，并且不使用简化公式，推导由于界面极化而产生的点电荷的静电自能（即 $q$ 与其感应表面极化电荷相互作用相关的能量）。使用与静电学中麦克斯韦方程组所蕴含的边界条件相一致的镜像法。从定义 $\\nabla \\times \\mathbf{E}=\\mathbf{0}$、$\\nabla \\cdot \\mathbf{D}=\\rho_{\\mathrm{free}}$ 和 $\\mathbf{D}=\\epsilon \\mathbf{E}$，以及标量势 $\\phi$（满足 $\\mathbf{E}=-\\nabla \\phi$）开始。假设每种介质的介电常数恒定，且界面是无限大的平面。在 $z=0$ 处强制 $\\mathbf{E}$ 的切向分量和 $\\mathbf{D}$ 的法向分量连续（自由表面电荷密度为零）。\n\n将自能 $U_{\\mathrm{self}}$ 定义为电荷 $q$ 与其所在位置由界面极化响应单独产生的感应电势（即不包括直接的库仑自势）之乘积的一半。使用与边界条件一致的镜像电荷构造，推导出 $U_{\\mathrm{self}}$ 关于 $q$、$d$、$\\epsilon_1$ 和 $\\epsilon_2$ 的显式解析表达式。\n\n最后，讨论极限情况 $\\epsilon_2 \\to \\infty$ 和 $\\epsilon_2 \\to \\epsilon_1$，解释在每种极限下 $U_{\\mathrm{self}}$ 的物理符号和大小趋势。最终能量以焦耳（SI 单位）表示。最终答案必须是 $U_{\\mathrm{self}}$ 作为 $q$、$d$、$\\epsilon_1$ 和 $\\epsilon_2$ 的函数的单个闭合形式解析表达式。", "solution": "该问题要求推导位于两种电介质之间的平面界面附近的一个点电荷 $q$ 的静电自能。电荷位于 $\\mathbf{r}_0 = (0,0,d)$，处在占据 $z>0$ 半空间、介电常数为 $\\epsilon_1$ 的介质中。另一种介电常数为 $\\epsilon_2$ 的介质占据 $z0$ 的半空间。自能定义为克服来自界面上感应极化电荷的静电力所做的功。\n\n这是一个经典的静电学边值问题，可以使用镜像法求解。基本方程是静电学中的麦克斯韦方程组。由于电场 $\\mathbf{E}$ 是静态的，其旋度为零，即 $\\nabla \\times \\mathbf{E} = \\mathbf{0}$，这允许我们定义一个标量势 $\\phi$，使得 $\\mathbf{E} = -\\nabla \\phi$。$\\phi$ 的控制方程是高斯定律，$\\nabla \\cdot \\mathbf{D} = \\rho_{\\mathrm{free}}$，其中 $\\mathbf{D} = \\epsilon \\mathbf{E}$ 是电位移场，$\\rho_{\\mathrm{free}}$ 是自由电荷密度。结合这些，我们得到每个区域的泊松方程：\n对于 $z>0$：$\\nabla^2 \\phi_1 = -\\frac{\\rho_{\\mathrm{free}}}{\\epsilon_1}$\n对于 $z0$：$\\nabla^2 \\phi_2 = -\\frac{\\rho_{\\mathrm{free}}}{\\epsilon_2}$\n\n在我们的情况中，唯一的自由电荷是位于 $\\mathbf{r}_0 = (0,0,d)$ 的点电荷 $q$，所以 $\\rho_{\\mathrm{free}} = q\\delta(x)\\delta(y)\\delta(z-d)$。因此，对于 $z>0$，有 $\\nabla^2 \\phi_1 = -\\frac{q}{\\epsilon_1}\\delta(x)\\delta(y)\\delta(z-d)$；对于 $z0$，由于没有自由电荷，有 $\\nabla^2 \\phi_2 = 0$（拉普拉斯方程）。\n\n在界面 $z=0$ 处，没有自由表面电荷的边界条件是：\n1. $\\mathbf{E}$ 的切向分量连续：$\\mathbf{E}_{1,t} = \\mathbf{E}_{2,t}$。这意味着标量势的连续性：$\\phi_1(x,y,0) = \\phi_2(x,y,0)$。\n2. $\\mathbf{D}$ 的法向分量连续：$D_{1,n} = D_{2,n}$。由于 $\\mathbf{D} = \\epsilon \\mathbf{E} = -\\epsilon\\nabla\\phi$，且法向为 $\\hat{\\mathbf{z}}$，此条件为 $\\epsilon_1 \\frac{\\partial \\phi_1}{\\partial z} \\Big|_{z=0} = \\epsilon_2 \\frac{\\partial \\phi_2}{\\partial z} \\Big|_{z=0}$。\n\n镜像法通过将复杂的感应表面电荷分布替换为一组位于关心区域之外的虚拟点电荷（镜像电荷）来提出一个解。\n\n对于区域 1 ($z>0$)：势 $\\phi_1$ 被构造为位于 $(0,0,d)$ 的真实电荷 $q$ 和位于介质 2 中 $(0,0,-d)$ 的镜像电荷 $q'$ 所产生的电势之和。位于 $z=-d$ 的镜像电荷的存在并不违反 $z>0$ 区域的泊松方程，因为它在该区域之外。使用柱坐标 $(\\rho, \\varphi, z)$，其中 $\\rho = \\sqrt{x^2+y^2}$，电势为：\n$$ \\phi_1(\\rho,z) = \\frac{1}{4\\pi\\epsilon_1} \\left( \\frac{q}{\\sqrt{\\rho^2 + (z-d)^2}} + \\frac{q'}{\\sqrt{\\rho^2 + (z+d)^2}} \\right) $$\n\n对于区域 2 ($z0$)：势 $\\phi_2$ 被构造为如同它是由位于真实电荷位置 $(0,0,d)$ 的单个有效电荷 $q''$ 产生的一样。该源在区域 2 之外，因此对于 $z0$，拉普拉斯方程 $\\nabla^2 \\phi_2 = 0$ 得到满足。请注意，该介质中的电势按 $1/\\epsilon_2$ 进行了缩放。\n$$ \\phi_2(\\rho,z) = \\frac{1}{4\\pi\\epsilon_2} \\left( \\frac{q''}{\\sqrt{\\rho^2 + (z-d)^2}} \\right) $$\n\n现在，我们应用 $z=0$ 处的边界条件来确定未知的镜像电荷 $q'$ 和 $q''$。\n\n根据电势的连续性，$\\phi_1(\\rho,0) = \\phi_2(\\rho,0)$：\n$$ \\frac{1}{4\\pi\\epsilon_1} \\left( \\frac{q}{\\sqrt{\\rho^2 + d^2}} + \\frac{q'}{\\sqrt{\\rho^2 + d^2}} \\right) = \\frac{1}{4\\pi\\epsilon_2} \\frac{q''}{\\sqrt{\\rho^2 + d^2}} $$\n这简化为我们的第一个方程：\n$$ \\frac{1}{\\epsilon_1} (q + q') = \\frac{1}{\\epsilon_2} q'' \\quad (1) $$\n\n根据 $\\mathbf{D}$ 的法向分量的连续性，我们首先计算关于 $z$ 的偏导数：\n$$ \\frac{\\partial \\phi_1}{\\partial z} = \\frac{1}{4\\pi\\epsilon_1} \\left[ q \\frac{-(z-d)}{(\\rho^2 + (z-d)^2)^{3/2}} + q' \\frac{-(z+d)}{(\\rho^2 + (z+d)^2)^{3/2}} \\right] $$\n在 $z=0$ 处：\n$$ \\frac{\\partial \\phi_1}{\\partial z} \\Big|_{z=0} = \\frac{1}{4\\pi\\epsilon_1} \\frac{qd - q'd}{(\\rho^2 + d^2)^{3/2}} $$\n对于 $\\phi_2$：\n$$ \\frac{\\partial \\phi_2}{\\partial z} = \\frac{1}{4\\pi\\epsilon_2} \\left[ q'' \\frac{-(z-d)}{(\\rho^2 + (z-d)^2)^{3/2}} \\right] $$\n在 $z=0$ 处：\n$$ \\frac{\\partial \\phi_2}{\\partial z} \\Big|_{z=0} = \\frac{1}{4\\pi\\epsilon_2} \\frac{q''d}{(\\rho^2 + d^2)^{3/2}} $$\n应用边界条件 $\\epsilon_1 \\frac{\\partial \\phi_1}{\\partial z}|_{z=0} = \\epsilon_2 \\frac{\\partial \\phi_2}{\\partial z}|_{z=0}$：\n$$ \\epsilon_1 \\left( \\frac{d(q-q')}{4\\pi\\epsilon_1(\\rho^2+d^2)^{3/2}} \\right) = \\epsilon_2 \\left( \\frac{d q''}{4\\pi\\epsilon_2(\\rho^2+d^2)^{3/2}} \\right) $$\n这简化为我们的第二个方程：\n$$ q - q' = q'' \\quad (2) $$\n\n我们现在求解线性方程组 $(1)$ 和 $(2)$ 以得到 $q'$ 和 $q''$。将 $(2)$ 代入 $(1)$：\n$$ \\frac{1}{\\epsilon_1}(q + q') = \\frac{1}{\\epsilon_2}(q - q') $$\n$$ \\epsilon_2(q + q') = \\epsilon_1(q - q') $$\n$$ \\epsilon_2 q + \\epsilon_2 q' = \\epsilon_1 q - \\epsilon_1 q' $$\n$$ q'(\\epsilon_1 + \\epsilon_2) = q(\\epsilon_1 - \\epsilon_2) $$\n$$ q' = q \\left( \\frac{\\epsilon_1 - \\epsilon_2}{\\epsilon_1 + \\epsilon_2} \\right) $$\n\n问题要求的是自能 $U_{\\mathrm{self}}$，其定义为电荷 $q$ 与其所在位置由感应电荷产生的电势之乘积的 $\\frac{1}{2}$。由感应表面极化产生的电势 $\\phi_{\\mathrm{ind}}$ 等效于区域 1 中镜像电荷 $q'$ 产生的电势。我们需要在真实电荷的位置 $\\mathbf{r}_0 = (0,0,d)$ 处计算这个电势。\n位于位置 $\\mathbf{r}'=(0,0,-d)$ 的镜像电荷 $q'$ 产生的电势为：\n$$ \\phi_{\\mathrm{ind}}(\\mathbf{r}) = \\frac{1}{4\\pi\\epsilon_1} \\frac{q'}{|\\mathbf{r}-\\mathbf{r}'|} $$\n在 $\\mathbf{r}_0$ 处计算：\n$$ \\phi_{\\mathrm{ind}}(\\mathbf{r}_0) = \\frac{1}{4\\pi\\epsilon_1} \\frac{q'}{|(0,0,d)-(0,0,-d)|} = \\frac{1}{4\\pi\\epsilon_1} \\frac{q'}{2d} $$\n代入 $q'$ 的表达式：\n$$ \\phi_{\\mathrm{ind}}(\\mathbf{r}_0) = \\frac{1}{8\\pi\\epsilon_1 d} \\left( q \\frac{\\epsilon_1 - \\epsilon_2}{\\epsilon_1 + \\epsilon_2} \\right) = \\frac{q}{8\\pi\\epsilon_1 d} \\left( \\frac{\\epsilon_1 - \\epsilon_2}{\\epsilon_1 + \\epsilon_2} \\right) $$\n自能定义为 $U_{\\mathrm{self}} = \\frac{1}{2} q \\phi_{\\mathrm{ind}}(\\mathbf{r}_0)$：\n$$ U_{\\mathrm{self}} = \\frac{1}{2} q \\left[ \\frac{q}{8\\pi\\epsilon_1 d} \\left( \\frac{\\epsilon_1 - \\epsilon_2}{\\epsilon_1 + \\epsilon_2} \\right) \\right] $$\n$$ U_{\\mathrm{self}} = \\frac{q^2}{16\\pi\\epsilon_1 d} \\left( \\frac{\\epsilon_1 - \\epsilon_2}{\\epsilon_1 + \\epsilon_2} \\right) $$\n\n最后，我们分析极限情况。\n情况1：$\\epsilon_2 \\to \\infty$。这代表与理想导体的界面。\n项 $\\left(\\frac{\\epsilon_1 - \\epsilon_2}{\\epsilon_1 + \\epsilon_2}\\right) = \\left(\\frac{\\epsilon_1/\\epsilon_2 - 1}{\\epsilon_1/\\epsilon_2 + 1}\\right) \\to -1$。\n自能变为 $U_{\\mathrm{self}} = -\\frac{q^2}{16\\pi\\epsilon_1 d}$。负号表示电荷与导电平面之间存在吸引力。在这种情况下，镜像电荷为 $q' = -q$，正如所预期的。\n\n情况2：$\\epsilon_2 \\to \\epsilon_1$。这代表没有界面的均匀介质。\n项 $\\left(\\frac{\\epsilon_1 - \\epsilon_2}{\\epsilon_1 + \\epsilon_2}\\right) \\to \\left(\\frac{\\epsilon_1 - \\epsilon_1}{\\epsilon_1 + \\epsilon_1}\\right) = 0$。\n自能变为 $U_{\\mathrm{self}} = 0$。这在物理上是正确的，因为没有界面来感应极化，因此没有相关的相互作用能。镜像电荷 $q'$ 为零。\n\n$U_{\\mathrm{self}}$ 的符号取决于 $(\\epsilon_1 - \\epsilon_2)$ 的符号。如果 $\\epsilon_2 > \\epsilon_1$（电荷位于极化性较弱的介质中），$U_{\\mathrm{self}}$ 为负，表示对界面的吸引力。如果 $\\epsilon_2  \\epsilon_1$（电荷位于极化性较强的介质中），$U_{\\mathrm{self}}$ 为正，表示与界面的排斥力。能量的大小与介电常数的失配程度成正比。", "answer": "$$\n\\boxed{\\frac{q^2}{16\\pi\\epsilon_1 d} \\left( \\frac{\\epsilon_1 - \\epsilon_2}{\\epsilon_1 + \\epsilon_2} \\right)}\n$$", "id": "3444065"}, {"introduction": "在周期性模拟中，尤其是模拟带有界面（如液体薄板）的系统时，会产生与周期性镜像之间的人为相互作用。本练习 [@problem_id:3444105] 聚焦于一个关键的人为效应：由净表面偶极矩与其周期性镜像相互作用而产生的伪能贡献。通过从宏观电动力学的基本原理出发，您将推导出广泛使用的校正项，以恢复孤立薄板的正确物理行为。", "problem": "分子动力学模拟将一个平面液-汽界面建模为一个电中性平板，其厚度远小于其横向尺寸，放置在一个尺寸为 $L_x$、$L_y$ 和 $L_z$ 的矩形周期性晶胞中，其中 $L_z$ 选择得足够大以包含一个显式的真空区域。该系统使用三维周期性边界条件和标准的三维 Ewald 求和方法进行模拟，并在无穷远处使用导电（锡箔）边界条件。由于界面不对称性，模拟的晶胞在沿表面法线方向上具有非零的总电偶极矩分量 $M_z \\neq 0$，而由于对称性，横向分量可以忽略不计。模拟晶胞外部的电介质是真空，其真空介电常数为 $\\varepsilon_0$。\n\n仅从宏观麦克斯韦电动力学和核心定义出发，特别是电位移场和极化强度之间的关系 $ \\mathbf{D} = \\varepsilon_0 \\mathbf{E} + \\mathbf{P} $，以及真空中匀强电场的静电能量密度 $u = \\tfrac{1}{2}\\varepsilon_0 |\\mathbf{E}|^2$，假设具有导电外部边界的三维周期性边界条件使得晶胞内的平均电位移场为零，即 $\\langle \\mathbf{D} \\rangle = \\mathbf{0}$。取晶胞平均极化强度为 $\\mathbf{P} = \\mathbf{M}/V$，其中 $V = L_x L_y L_z$ 且 $\\mathbf{M} = (0,0,M_z)$，请从第一性原理推导能量校正 $U_{\\mathrm{corr}}(L_x,L_y,Lz;M_z,\\varepsilon_0)$ 的表达式。该校正必须加到三维 Ewald 静电能上，以通过消除平板与其沿表面法线方向的周期性镜像之间的虚假相互作用，来获得二维平板极限。\n\n然后，通过引入表面偶极子密度 $\\mu_s = M_z/(L_x L_y)$，表示出单位面积的校正，并说明在固定的 $L_x$ 和 $L_y$ 下，其与真空层厚度 $L_z$ 的主要标度关系。你的最终答案必须是 $U_{\\mathrm{corr}}(L_x,L_y,L_z;M_z,\\varepsilon_0)$ 在国际单位制 (SI) 下的单个闭式解析表达式。无需进行数值计算。[@problem_id:3444105]", "solution": "该问题要求推导一个能量校正项，该项用于分子动力学模拟中具有垂直于界面的净偶极矩的平面界面。推导必须从指定的宏观电动力学第一性原理开始。目标是推导校正项 $U_{\\mathrm{corr}}$，它必须加到用三维 Ewald 求和计算出的能量 $U_{\\mathrm{3D-Ewald}}$ 上，以获得真实的二维周期性平板的能量 $U_{\\mathrm{2D-slab}}$。三维周期性引入了平板与其沿 z 轴（垂直于平板的方向）的周期性镜像之间的虚假相互作用。这种相互作用是吸引性的，类似于电容器极板之间的吸引力，这意味着计算出的能量 $U_{\\mathrm{3D-Ewald}}$ 被人为地降低了。因此，校正项必须为正，以抵消这种效应。\n\n$U_{\\mathrm{2D-slab}} = U_{\\mathrm{3D-Ewald}} + U_{\\mathrm{corr}}$\n\n我们根据提供的宏观静电学原理来推导 $U_{\\mathrm{corr}}$。\n\n1.  我们从导电边界条件所施加的基本假设开始：模拟晶胞体积 $V$ 内的平均电位移场为零。\n    $$ \\langle \\mathbf{D} \\rangle = \\mathbf{0} $$\n\n2.  使用位移场的定义 $\\mathbf{D} = \\varepsilon_0 \\mathbf{E} + \\mathbf{P}$，我们可以将其在晶胞内的平均值写为：\n    $$ \\langle \\mathbf{D} \\rangle = \\langle \\varepsilon_0 \\mathbf{E} + \\mathbf{P} \\rangle = \\varepsilon_0 \\langle \\mathbf{E} \\rangle + \\langle \\mathbf{P} \\rangle $$\n\n3.  结合这两个方程，我们找到平均电场 $\\langle \\mathbf{E} \\rangle$ 和平均极化强度 $\\langle \\mathbf{P} \\rangle$ 之间的关系：\n    $$ \\varepsilon_0 \\langle \\mathbf{E} \\rangle + \\langle \\mathbf{P} \\rangle = \\mathbf{0} \\implies \\langle \\mathbf{E} \\rangle = -\\frac{\\langle \\mathbf{P} \\rangle}{\\varepsilon_0} $$\n\n4.  问题陈述平均极化强度与晶胞总偶极矩 $\\mathbf{M}$ 的关系为 $\\langle \\mathbf{P} \\rangle = \\mathbf{M}/V$。将其代入平均电场的表达式中：\n    $$ \\langle \\mathbf{E} \\rangle = -\\frac{\\mathbf{M}}{\\varepsilon_0 V} $$\n    这是一个存在于整个模拟晶胞（包括真空区域）中的人为的匀强电场，它是将三维周期性边界条件应用于具有净偶极矩的系统的结果。\n\n5.  与此人为电场相关的能量是虚假相互作用能的来源。我们已知真空中匀强电场的能量密度公式为 $u = \\frac{1}{2}\\varepsilon_0 |\\mathbf{E}|^2$。虚假能量的大小是该电场在整个模拟晶胞体积 $V$ 中储存的总能量。此能量对应于必须加到三维 Ewald 能量上的校正项 $U_{\\mathrm{corr}}$。\n    $$ U_{\\mathrm{corr}} = \\int_V u \\, dV = u \\cdot V = \\left( \\frac{1}{2}\\varepsilon_0 |\\langle \\mathbf{E} \\rangle|^2 \\right) V $$\n\n6.  代入为 $\\langle \\mathbf{E} \\rangle$ 推导出的表达式：\n    $$ U_{\\mathrm{corr}} = \\frac{1}{2}\\varepsilon_0 V \\left| -\\frac{\\mathbf{M}}{\\varepsilon_0 V} \\right|^2 = \\frac{1}{2}\\varepsilon_0 V \\frac{|\\mathbf{M}|^2}{(\\varepsilon_0 V)^2} $$\n\n7.  简化表达式，我们得到：\n    $$ U_{\\mathrm{corr}} = \\frac{|\\mathbf{M}|^2}{2 \\varepsilon_0 V} $$\n\n8.  问题指定总偶极矩为 $\\mathbf{M} = (0, 0, M_z)$，因此其大小的平方为 $|\\mathbf{M}|^2 = M_z^2$。晶胞的体积是 $V = L_x L_y L_z$。将这些代入我们的校正能表达式，得到以给定参数表示的最终答案：\n    $$ U_{\\mathrm{corr}}(L_x, L_y, L_z; M_z, \\varepsilon_0) = \\frac{M_z^2}{2 \\varepsilon_0 L_x L_y L_z} $$\n\n这就是所要求的能量校正的闭式表达式。\n\n问题还要求表示出单位面积的校正，并说明其随 $L_z$ 的标度关系。平板的表面积为 $A = L_x L_y$。表面偶极子密度为 $\\mu_s = M_z/A = M_z/(L_x L_y)$。\n\n单位面积的校正 $u_{\\mathrm{corr}}$ 为：\n$$ u_{\\mathrm{corr}} = \\frac{U_{\\mathrm{corr}}}{L_x L_y} = \\frac{M_z^2}{2 \\varepsilon_0 (L_x L_y)^2 L_z} = \\frac{\\mu_s^2}{2 \\varepsilon_0 L_z} $$\n\n从这些表达式中，我们可以看到与真空层厚度 $L_z$ 的标度关系。对于固定的横向尺寸 $L_x$、$L_y$ 和固定的总偶极矩 $M_z$，总校正 $U_{\\mathrm{corr}}$ 与 $L_z^{-1}$ 成正比。单位面积的校正 $u_{\\mathrm{corr}}$ 也与 $L_z^{-1}$ 成正比。这种反比关系是预期的：随着真空间隙 $L_z$ 增加，周期性平板之间的虚假相互作用减弱。", "answer": "$$\\boxed{\\frac{M_z^2}{2 \\varepsilon_0 L_x L_y L_z}}$$", "id": "3444105"}, {"introduction": "正确应用静电校正不仅仅是调整势能，它要求对力和压力张量进行一致的处理，这对于在恒压系综中进行的模拟尤为关键。这项综合性练习 [@problem_id:3444099] 将挑战您实现对自能项和表面偶极项的校正，确保能量、维里和压力都得到一致且连贯的修正。", "problem": "考虑一个在周期性边界条件下的三维点电荷分子动力学系统。长程静电作用通过 Ewald 分裂和粒子网格 Ewald (PME) 方法进行计算。Ewald 分裂引入了一个以 Ewald 参数 $\\alpha$（单位为长度的倒数）为特征的高斯屏蔽，并将库仑能量分为短程的实空间部分、倒易空间部分、自相互作用项以及与 $k=0$（零波矢）模式相关的表面项。自相互作用源于电荷与其自身屏蔽电荷的相互作用，必须减去以避免重复计算。表面项取决于宏观边界条件，通常用周围连续介质的有限相对介电常数 $\\varepsilon_r$ 来建模，其中导电边界（锡箔）极限对应于 $\\varepsilon_r \\to \\infty$，真空边界对应于 $\\varepsilon_r = 1$。\n\n您的任务是，从第一性原理出发，在 PME 中实现对自相互作用和表面偶极贡献的一致性减除和校正，以确保总能量和维里得到协调一致的校正。维里通过力学方式定义为 $W = -\\sum_i \\mathbf{r}_i \\cdot \\mathbf{f}_i$，三维热力学压力由 $P = \\frac{N k_{\\mathrm{B}} T + W}{3 V}$ 给出，其中 $N$ 是粒子数，$k_{\\mathrm{B}}$ 是玻尔兹曼常数，$T$ 是温度，$V$ 是体积。在此任务中，您将专注于对能量、维里和由此产生的压力的校正贡献，忽略 $N k_{\\mathrm{B}} T$ 以及非由自相互作用和表面项产生的力和维里的任何其他部分。\n\n您必须使用的基础是：\n- 库仑定律以及 Ewald 分裂为实空间、倒易空间、自相互作用和表面项。\n- 维里的定义 $W = -\\sum_i \\mathbf{r}_i \\cdot \\mathbf{f}_i$ 和三维压力的热力学关系 $P = \\frac{N k_{\\mathrm{B}} T + W}{3 V}$。\n- 总偶极矩的定义 $\\mathbf{M} = \\sum_i q_i \\mathbf{r}_i$，其中 $q_i$ 是粒子电荷，$\\mathbf{r}_i$ 是它们相对于盒子中心的位置。\n\n根据以下要求实现校正：\n1. 将自相互作用能校正推导为 Ewald 参数 $\\alpha$ 和电荷集 $\\{q_i\\}$ 的函数，并确定其在两种情况下的维里（以及由此产生的压力）贡献：\n   - $\\alpha$ 固定且与盒子体积 $V$ 无关。\n   - $\\alpha$ 随盒子边长 $L$ 缩放，即 $\\alpha = k / L$，其中 $k$ 是一个固定的无量纲常数，对于立方盒子 $L = V^{1/3}$。对于此情况，使用在固定缩放坐标下维里的热力学定义 $W = - \\frac{\\partial U}{\\partial \\ln V}$。\n2. 在具有相对介电常数 $\\varepsilon_r$ 的通用电介质边界下，从与 $k=0$ 模式相关的力的贡献中一致地推导表面偶极能量和维里校正，并将您的实现特化到锡箔极限 $\\varepsilon_r \\to \\infty$ 和真空边界 $\\varepsilon_r = 1$。\n\n假设一个立方模拟盒子，边长为 $L$，体积为 $V = L^3$。位置 $\\mathbf{r}_i$ 是相对于盒子中心给出的。为下面的每个测试用例计算能量的总校正 $U_{\\mathrm{corr}}$（自相互作用加表面）、维里的总校正 $W_{\\mathrm{corr}}$（自相互作用加表面）以及相应的压力校正 $P_{\\mathrm{corr}} = W_{\\mathrm{corr}} / (3 V)$。\n\n使用无量纲化的静电单位，其中库仑常数等于 $1$，基本电荷等于 $1$，长度单位为纳米。在这些单位中：\n- 能量必须以 $e^2/\\mathrm{nm}$ 表示。\n- 维里必须以 $e^2/\\mathrm{nm}$ 表示。\n- 压力必须以 $e^2/\\mathrm{nm}^4$ 表示。\n所有输出均以这些单位表示。\n\n测试套件：\n- 测试用例 A（正常路径）：电荷 $\\{q_i\\} = [1.0, -1.0, 0.5, -0.5]$，位置（单位 $\\mathrm{nm}$）$\\{\\mathbf{r}_i\\} = \\{[0.5, 0.0, 0.0], [-0.5, 0.0, 0.0], [0.0, 0.3, 0.0], [0.0, -0.3, 0.0]\\}$，盒子边长 $L = 3.0$，固定 $\\alpha = 3.5$（单位 $\\mathrm{nm}^{-1}$），锡箔边界 $\\varepsilon_r \\to \\infty$。\n- 测试用例 B（表面校正检查）：与测试用例 A 相同的 $\\{q_i\\}$ 和 $\\{\\mathbf{r}_i\\}$，$L = 3.0$，固定 $\\alpha = 3.5$（单位 $\\mathrm{nm}^{-1}$），真空边界 $\\varepsilon_r = 1$。\n- 测试用例 C（体积耦合的 $\\alpha$）：与测试用例 A 相同的 $\\{q_i\\}$ 和 $\\{\\mathbf{r}_i\\}$，$L = 3.0$，缩放的 $\\alpha = k / L$ 且 $k = 10.5$，锡箔边界 $\\varepsilon_r \\to \\infty$。\n- 测试用例 D（零偶极矩边界情况）：电荷 $\\{q_i\\} = [1.0, 1.0, -1.0, -1.0]$，位置（单位 $\\mathrm{nm}$）$\\{\\mathbf{r}_i\\} = \\{[0.25, 0.0, 0.0], [-0.25, 0.0, 0.0], [0.0, 0.25, 0.0], [0.0, -0.25, 0.0]\\}$，$L = 2.0$，固定 $\\alpha = 2.0$（单位 $\\mathrm{nm}^{-1}$），真空边界 $\\varepsilon_r = 1$。\n\n您的程序应生成单行输出，包含一个用方括号括起来的逗号分隔列表，其中每个元素本身是按测试用例顺序排列的方括号括起来的逗号分隔三元组 $[U_{\\mathrm{corr}},W_{\\mathrm{corr}},P_{\\mathrm{corr}}]$，例如 $[[u_1,w_1,p_1],[u_2,w_2,p_2],\\dots]$。", "solution": "该问题要求在使用粒子网格 Ewald (PME) 方法的周期性分子动力学系统中，推导并实现对能量、维里和压力的校正项。这些校正考虑了源于 Ewald 求和技术的自相互作用能和表面偶极能。我们将分别处理每个校正项，推导能量 $U$ 和相应维里 $W$ 的表达式。总校正量是各个贡献的总和。\n\n### 1. 自相互作用校正\n\nEwald 方法涉及为每个点电荷加上和减去一个屏蔽电荷分布（通常是高斯分布）。自相互作用能是点电荷与其自身屏蔽高斯电荷分布的相互作用。这个虚假的能量项必须从总能量中减去。在 Ewald 求和的标准公式中，此校正由下式给出：\n$$ U_{\\text{self, corr}} = -k_e \\frac{\\alpha}{\\sqrt{\\pi}} \\sum_{i=1}^N q_i^2 $$\n在指定的无量纲单位中，库仑常数 $k_e=1$。因此，自相互作用能校正为：\n$$ U_{\\text{self, corr}} = - \\frac{\\alpha}{\\sqrt{\\pi}} \\sum_{i=1}^N q_i^2 $$\n其中 $\\{q_i\\}$ 是粒子电荷集，$\\alpha$ 是 Ewald 参数。\n\n该项对维里以及压力的贡献取决于如何处理 $\\alpha$ 与系统体积 $V$ 的关系。\n\n**情况 1：固定的 Ewald 参数 $\\alpha$**\n当 $\\alpha$ 是一个与盒子体积 $V$ 无关的常数时，自相互作用能 $U_{\\text{self, corr}}$ 是一个关于粒子位置 $\\mathbf{r}_i$ 的常数。该项对任何粒子 $i$ 的力的贡献为零：\n$$ \\mathbf{f}_{i, \\text{self}} = -\\nabla_{\\mathbf{r}_i} U_{\\text{self, corr}} = \\mathbf{0} $$\n力学维里定义为 $W = -\\sum_i \\mathbf{r}_i \\cdot \\mathbf{f}_i$。由于力为零，维里贡献也为零。\n$$ W_{\\text{self, corr}} = 0 \\quad (\\text{对于固定的 } \\alpha) $$\n\n**情况 2：与体积相关的 Ewald 参数 $\\alpha$**\n当 $\\alpha$ 与盒子体积耦合时，如对于体积为 $V=L^3$ 的立方盒子和无量纲常数 $k$，有 $\\alpha = k / L = k V^{-1/3}$，则势能 $U_{\\text{self, corr}}$ 显式地依赖于 $V$。\n$$ U_{\\text{self, corr}}(V) = - \\frac{k V^{-1/3}}{\\sqrt{\\pi}} \\sum_{i=1}^N q_i^2 $$\n问题指导我们在这种特定情况下使用维里的热力学定义：$W = - \\frac{\\partial U}{\\partial \\ln V}$（在固定缩放坐标下）。将此定义应用于 $U_{\\text{self, corr}}$：\n$$ W_{\\text{self, corr}} = - \\frac{\\partial U_{\\text{self, corr}}}{\\partial \\ln V} = -V \\frac{\\partial U_{\\text{self, corr}}}{\\partial V} $$\n我们计算该导数：\n$$ \\frac{\\partial U_{\\text{self, corr}}}{\\partial V} = \\frac{\\partial}{\\partial V} \\left( - \\frac{k V^{-1/3}}{\\sqrt{\\pi}} \\sum_i q_i^2 \\right) = - \\frac{k}{\\sqrt{\\pi}} \\left( \\sum_i q_i^2 \\right) \\left( -\\frac{1}{3} V^{-4/3} \\right) $$\n$$ \\frac{\\partial U_{\\text{self, corr}}}{\\partial V} = \\frac{1}{3} \\frac{k V^{-1/3}}{\\sqrt{\\pi} V} \\sum_i q_i^2 = -\\frac{1}{3V} U_{\\text{self, corr}} $$\n将此代入给定的维里公式：\n$$ W_{\\text{self, corr}} = -V \\left( -\\frac{1}{3V} U_{\\text{self, corr}} \\right) = \\frac{1}{3} U_{\\text{self, corr}} \\quad (\\text{对于 } \\alpha \\propto V^{-1/3}) $$\n\n### 2. 表面偶极校正\n\n标准的 Ewald 求和（省略了倒易和中的 $\\mathbf{k}=\\mathbf{0}$ 项）隐含地假设周期性模拟单元被完美的导体（锡箔边界条件，$\\varepsilon_r \\to \\infty$）所包围。需要一个校正项来模拟其他宏观边界条件，例如真空（$\\varepsilon_r = 1$）或具有有限相对介电常数 $\\varepsilon_r$ 的连续介质。此校正与模拟单元的净偶极矩 $\\mathbf{M} = \\sum_i q_i \\mathbf{r}_i$ 有关。\n\n能量校正项代表总偶极矩与其周期性镜像以及周围介质的相互作用，由下式给出：\n$$ U_{\\text{surf, corr}} = \\frac{2\\pi}{(2\\varepsilon_r+1)V} |\\mathbf{M}|^2 $$\n其中 $V$ 是模拟单元的体积。\n\n我们分析所要求的两个特定边界条件：\n*   **锡箔边界 ($\\varepsilon_r \\to \\infty$)：** 在此极限下，校正项消失。\n    $$ U_{\\text{surf, corr}} = \\lim_{\\varepsilon_r \\to \\infty} \\frac{2\\pi}{(2\\varepsilon_r+1)V} |\\mathbf{M}|^2 = 0 $$\n*   **真空边界 ($\\varepsilon_r = 1$)：** 在此情况下，表达式变为：\n    $$ U_{\\text{surf, corr}} = \\frac{2\\pi}{(2(1)+1)V} |\\mathbf{M}|^2 = \\frac{2\\pi}{3V} |\\mathbf{M}|^2 $$\n\n问题要求从力的贡献中一致地推导维里校正。由该表面势产生的对粒子 $j$ 的力为：\n$$ \\mathbf{f}_{j, \\text{surf}} = -\\nabla_{\\mathbf{r}_j} U_{\\text{surf, corr}} = -\\nabla_{\\mathbf{r}_j} \\left( \\frac{2\\pi}{(2\\varepsilon_r+1)V} (\\sum_i q_i \\mathbf{r}_i) \\cdot (\\sum_k q_k \\mathbf{r}_k) \\right) $$\n使用 $\\nabla_{\\mathbf{r}_j} (\\mathbf{a} \\cdot \\mathbf{b}) = (\\mathbf{a} \\cdot \\nabla_{\\mathbf{r}_j})\\mathbf{b} + (\\mathbf{b} \\cdot \\nabla_{\\mathbf{r}_j})\\mathbf{a} + \\mathbf{a} \\times (\\nabla_{\\mathbf{r}_j} \\times \\mathbf{b}) + \\mathbf{b} \\times (\\nabla_{\\mathbf{r}_j} \\times \\mathbf{a})$ 并注意到 $\\mathbf{r}_i$ 是独立变量，这可以简化。\n$\\mathbf{M} = \\sum_i q_i \\mathbf{r}_i$ 相对于 $\\mathbf{r}_j$ 的梯度是一个张量 $q_j \\mathbf{I}$，其中 $\\mathbf{I}$ 是单位张量。\n$|\\mathbf{M}|^2 = \\mathbf{M} \\cdot \\mathbf{M}$ 的梯度是 $2(\\nabla_{\\mathbf{r}_j} \\mathbf{M}) \\cdot \\mathbf{M} = 2 q_j \\mathbf{M}$。\n$$ \\mathbf{f}_{j, \\text{surf}} = - \\frac{2\\pi}{(2\\varepsilon_r+1)V} (2 q_j \\mathbf{M}) = - \\frac{4\\pi q_j}{(2\\varepsilon_r+1)V} \\mathbf{M} $$\n力学维里贡献为 $W_{\\text{surf, corr}} = -\\sum_j \\mathbf{r}_j \\cdot \\mathbf{f}_{j, \\text{surf}}$：\n$$ W_{\\text{surf, corr}} = -\\sum_j \\mathbf{r}_j \\cdot \\left( - \\frac{4\\pi q_j}{(2\\varepsilon_r+1)V} \\mathbf{M} \\right) = \\frac{4\\pi}{(2\\varepsilon_r+1)V} \\left( \\sum_j q_j \\mathbf{r}_j \\right) \\cdot \\mathbf{M} $$\n认识到 $\\sum_j q_j \\mathbf{r}_j = \\mathbf{M}$：\n$$ W_{\\text{surf, corr}} = \\frac{4\\pi}{(2\\varepsilon_r+1)V} |\\mathbf{M}|^2 $$\n将此与能量表达式进行比较，我们发现一个简单的关系：\n$$ W_{\\text{surf, corr}} = 2 U_{\\text{surf, corr}} $$\n\n### 3. 总校正\n\n对能量、维里和压力的总校正是自相互作用和表面偶极贡献的总和。\n\n*   总能量校正：$U_{\\text{corr}} = U_{\\text{self, corr}} + U_{\\text{surf, corr}}$\n*   总维里校正：$W_{\\text{corr}} = W_{\\text{self, corr}} + W_{\\text{surf, corr}}$\n*   总压力校正：$P_{\\text{corr}} = \\frac{W_{\\text{corr}}}{3V}$\n\n这些公式将被用于评估测试用例。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Calculates self-interaction and surface-dipole corrections for energy,\n    virial, and pressure in PME simulations for a given set of test cases.\n    \"\"\"\n\n    test_cases = [\n        # Test Case A\n        {\n            \"charges\": np.array([1.0, -1.0, 0.5, -0.5]),\n            \"positions\": np.array([[0.5, 0.0, 0.0], [-0.5, 0.0, 0.0], [0.0, 0.3, 0.0], [0.0, -0.3, 0.0]]),\n            \"L\": 3.0,\n            \"alpha_spec\": {\"type\": \"fixed\", \"value\": 3.5},\n            \"epsilon_r\": np.inf\n        },\n        # Test Case B\n        {\n            \"charges\": np.array([1.0, -1.0, 0.5, -0.5]),\n            \"positions\": np.array([[0.5, 0.0, 0.0], [-0.5, 0.0, 0.0], [0.0, 0.3, 0.0], [0.0, -0.3, 0.0]]),\n            \"L\": 3.0,\n            \"alpha_spec\": {\"type\": \"fixed\", \"value\": 3.5},\n            \"epsilon_r\": 1.0\n        },\n        # Test Case C\n        {\n            \"charges\": np.array([1.0, -1.0, 0.5, -0.5]),\n            \"positions\": np.array([[0.5, 0.0, 0.0], [-0.5, 0.0, 0.0], [0.0, 0.3, 0.0], [0.0, -0.3, 0.0]]),\n            \"L\": 3.0,\n            \"alpha_spec\": {\"type\": \"scaled\", \"k\": 10.5},\n            \"epsilon_r\": np.inf\n        },\n        # Test Case D\n        {\n            \"charges\": np.array([1.0, 1.0, -1.0, -1.0]),\n            \"positions\": np.array([[0.25, 0.0, 0.0], [-0.25, 0.0, 0.0], [0.0, 0.25, 0.0], [0.0, -0.25, 0.0]]),\n            \"L\": 2.0,\n            \"alpha_spec\": {\"type\": \"fixed\", \"value\": 2.0},\n            \"epsilon_r\": 1.0\n        }\n    ]\n\n    results_str = []\n    for case in test_cases:\n        charges = case[\"charges\"]\n        positions = case[\"positions\"]\n        L = case[\"L\"]\n        V = L**3\n        alpha_spec = case[\"alpha_spec\"]\n        epsilon_r = case[\"epsilon_r\"]\n\n        # 1. Self-interaction correction\n        sum_q_squared = np.sum(charges**2)\n\n        if alpha_spec[\"type\"] == \"fixed\":\n            alpha = alpha_spec[\"value\"]\n            U_self_corr = -alpha / np.sqrt(np.pi) * sum_q_squared\n            W_self_corr = 0.0\n        elif alpha_spec[\"type\"] == \"scaled\":\n            k = alpha_spec[\"k\"]\n            alpha = k / L\n            U_self_corr = -alpha / np.sqrt(np.pi) * sum_q_squared\n            # Per problem statement: W = -dU/dlnV = U/3\n            W_self_corr = U_self_corr / 3.0\n        else:\n            raise ValueError(\"Unknown alpha specification.\")\n\n        # 2. Surface-dipole correction\n        if np.isinf(epsilon_r):\n            U_surf_corr = 0.0\n            W_surf_corr = 0.0\n        else:\n            # M = sum(q_i * r_i)\n            M = np.sum(charges[:, np.newaxis] * positions, axis=0)\n            M_squared = np.dot(M, M)\n\n            # U_surf = (2*pi / ((2*eps_r + 1)*V)) * |M|^2\n            U_surf_corr = (2.0 * np.pi / ((2.0 * epsilon_r + 1.0) * V)) * M_squared\n            # W_surf = 2 * U_surf\n            W_surf_corr = 2.0 * U_surf_corr\n            \n        # 3. Total corrections\n        U_total_corr = U_self_corr + U_surf_corr\n        W_total_corr = W_self_corr + W_surf_corr\n        P_total_corr = W_total_corr / (3.0 * V)\n\n        results_str.append(f\"[{U_total_corr},{W_total_corr},{P_total_corr}]\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results_str)}]\")\n\nsolve()\n```", "id": "3444099"}]}