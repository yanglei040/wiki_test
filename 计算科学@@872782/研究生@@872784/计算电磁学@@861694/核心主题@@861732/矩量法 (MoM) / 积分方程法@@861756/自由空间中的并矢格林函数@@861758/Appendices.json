{"hands_on_practices": [{"introduction": "本练习将并矢格林函数的抽象数学定义与一个可触摸的物理结果——简易天线的辐射——联系起来。通过计算振荡电偶极子的辐射方向图和总辐射功率，你将具体理解格林函数如何作为“传播算子”，将电流源与其在整个空间中产生的场联系起来。这个基本问题是连接理论形式与实际天线分析的关键桥梁。[@problem_id:3303047]", "problem": "一个振荡点电偶极子的复相量偶极矩振幅为 $\\mathbf{p}_{0} = p_{0}\\,\\hat{\\mathbf{z}}$，位于介电常数为 $\\varepsilon_{0}$、磁导率为 $\\mu_{0}$ 的均匀自由空间的原点。假设时间依赖关系为 $\\exp(-i \\omega t)$，定义自由空间波数 $k = \\omega \\sqrt{\\mu_{0}\\varepsilon_{0}}$，并用 $\\eta_{0} = \\sqrt{\\mu_{0}/\\varepsilon_{0}}$ 表示自由空间波阻抗，用 $c = 1/\\sqrt{\\mu_{0}\\varepsilon_{0}}$ 表示光速。设自由空间中的电并矢格林函数为张量 $\\mathbf{G}^{E}(\\mathbf{r},\\mathbf{r}')$，它在以下意义上求解矢量亥姆霍兹方程：对于任意感生电流密度 $\\mathbf{J}(\\mathbf{r}')$，辐射电场满足\n$$\n\\nabla \\times \\nabla \\times \\mathbf{E}(\\mathbf{r}) - k^{2}\\mathbf{E}(\\mathbf{r}) = i \\omega \\mu_{0} \\mathbf{J}(\\mathbf{r}), \\quad \\mathbf{E}(\\mathbf{r}) = i \\omega \\mu_{0} \\int \\mathbf{G}^{E}(\\mathbf{r},\\mathbf{r}') \\cdot \\mathbf{J}(\\mathbf{r}') \\, dV'.\n$$\n将振荡电偶极子视为一个点源，其等效电流密度为 $\\mathbf{J}(\\mathbf{r}) = -i \\omega \\mathbf{p}_{0}\\,\\delta(\\mathbf{r})$。仅使用频域麦克斯韦方程组、自由空间并矢格林函数的定义、其远场渐近形式以及时均形式的坡印亭定理，完成以下任务：\n\n1. 推导偶极子辐射的远场电场和磁场，作为观测方向 $\\hat{\\mathbf{r}}$ 和从 $+\\hat{\\mathbf{z}}$ 轴测量的极角 $\\theta$ 的函数。\n\n2. 根据这些场，推导单位立体角的时均辐射功率，并确定归一化角向辐射方向图 $F(\\theta)$。$F(\\theta)$ 定义为无量纲，并归一化使得 $\\max_{\\theta} F(\\theta) = 1$。\n\n3. 对所有立体角进行积分，得到总时均辐射功率 $P_{\\text{rad}}$。\n\n答案格式要求：\n- 提供最终答案，形式为一个数对，包含：\n  - 纯粹表示为 $\\theta$ 的函数的归一化角向辐射方向图 $F(\\theta)$。\n  - 用 $\\omega$、 $|p_{0}|$、 $\\varepsilon_{0}$ 和 $c$ 符号表示的总时均辐射功率 $P_{\\text{rad}}$。\n- 以国际单位制（SI）中的瓦特（watts）表示 $P_{\\text{rad}}$。\n- 将两个答案放在一个单行矩阵中，作为最终的方框答案。\n- 无需进行数值计算或四舍五入。", "solution": "该问题陈述在科学上是合理的、自洽的且提法得当。它描述了电磁理论中的一个典型问题——点电偶极子的辐射——使用了标准的定义和方程。因此，该问题被认为是有效的。\n\n由感生电流密度 $\\mathbf{J}(\\mathbf{r}')$ 辐射的电场 $\\mathbf{E}(\\mathbf{r})$ 由包含电并矢格林函数 $\\mathbf{G}^{E}(\\mathbf{r},\\mathbf{r}')$ 的积分关系给出：\n$$\n\\mathbf{E}(\\mathbf{r}) = i \\omega \\mu_{0} \\int \\mathbf{G}^{E}(\\mathbf{r},\\mathbf{r}') \\cdot \\mathbf{J}(\\mathbf{r}') \\, dV'\n$$\n位于原点的点电偶极子由等效电流密度 $\\mathbf{J}(\\mathbf{r}') = -i \\omega \\mathbf{p}_{0}\\,\\delta(\\mathbf{r}')$ 表示，其中 $\\mathbf{p}_{0} = p_{0}\\,\\hat{\\mathbf{z}}$，$\\delta(\\mathbf{r}')$ 是三维狄拉克δ函数。\n\n将电流密度代入 $\\mathbf{E}(\\mathbf{r})$ 的积分中，得到：\n$$\n\\mathbf{E}(\\mathbf{r}) = i \\omega \\mu_{0} \\int \\mathbf{G}^{E}(\\mathbf{r},\\mathbf{r}') \\cdot (-i \\omega \\mathbf{p}_{0}\\,\\delta(\\mathbf{r}')) \\, dV'\n$$\n利用狄拉克δ函数的筛选性质，即 $\\int f(\\mathbf{x}')\\delta(\\mathbf{x}')d\\mathbf{x}'=f(\\mathbf{0})$，我们可以在 $\\mathbf{r}'=\\mathbf{0}$ 处计算积分：\n$$\n\\mathbf{E}(\\mathbf{r}) = (i \\omega)(-i \\omega) \\mu_{0} \\mathbf{G}^{E}(\\mathbf{r},\\mathbf{0}) \\cdot \\mathbf{p}_{0} = \\omega^{2} \\mu_{0} \\mathbf{G}^{E}(\\mathbf{r},\\mathbf{0}) \\cdot \\mathbf{p}_{0}\n$$\n问题要求远场解。对于位于 $\\mathbf{r}'=\\mathbf{0}$ 的源，自由空间并矢格林函数 $\\mathbf{G}^{E}(\\mathbf{r},\\mathbf{r}')$ 的远场渐近形式为\n$$\n\\mathbf{G}^{E}(\\mathbf{r},\\mathbf{0}) \\approx (\\mathbf{I} - \\hat{\\mathbf{r}}\\hat{\\mathbf{r}}) \\frac{\\exp(ikr)}{4\\pi r} \\quad \\text{当 } |\\mathbf{r}| \\to \\infty\n$$\n其中 $\\mathbf{I}$ 是单位并矢，$\\hat{\\mathbf{r}}=\\mathbf{r}/|\\mathbf{r}|$ 是径向单位矢量，$r=|\\mathbf{r}|$。项 $\\hat{\\mathbf{r}}\\hat{\\mathbf{r}}$ 表示并矢积。\n\n将此渐近形式代入 $\\mathbf{E}(\\mathbf{r})$ 的表达式中，得到远场电场：\n$$\n\\mathbf{E}(\\mathbf{r}) \\approx \\omega^{2} \\mu_{0} \\left[ (\\mathbf{I} - \\hat{\\mathbf{r}}\\hat{\\mathbf{r}}) \\frac{\\exp(ikr)}{4\\pi r} \\right] \\cdot \\mathbf{p}_{0}\n$$\n项 $(\\mathbf{I} - \\hat{\\mathbf{r}}\\hat{\\mathbf{r}}) \\cdot \\mathbf{p}_{0}$ 将偶极矩矢量 $\\mathbf{p}_{0}$ 投影到垂直于观测方向 $\\hat{\\mathbf{r}}$ 的平面上。给定 $\\mathbf{p}_{0} = p_{0}\\hat{\\mathbf{z}}$。在球坐标系中，$\\hat{\\mathbf{z}} = \\cos\\theta\\,\\hat{\\mathbf{r}} - \\sin\\theta\\,\\hat{\\boldsymbol{\\theta}}$，与 $\\hat{\\mathbf{r}}$ 的点积为 $\\hat{\\mathbf{r}} \\cdot \\hat{\\mathbf{z}} = \\cos\\theta$。\n因此，投影为：\n$$\n(\\mathbf{I} - \\hat{\\mathbf{r}}\\hat{\\mathbf{r}}) \\cdot \\mathbf{p}_{0} = \\mathbf{p}_{0} - \\hat{\\mathbf{r}}(\\hat{\\mathbf{r}} \\cdot \\mathbf{p}_{0}) = p_{0}\\hat{\\mathbf{z}} - \\hat{\\mathbf{r}}(p_{0}\\cos\\theta) = p_{0}(\\hat{\\mathbf{z}} - \\hat{\\mathbf{r}}\\cos\\theta)\n$$\n代入 $\\hat{\\mathbf{z}}$ 的球坐标表示：\n$$\np_{0}((\\cos\\theta\\,\\hat{\\mathbf{r}} - \\sin\\theta\\,\\hat{\\boldsymbol{\\theta}}) - \\hat{\\mathbf{r}}\\cos\\theta) = -p_{0}\\sin\\theta\\,\\hat{\\boldsymbol{\\theta}}\n$$\n将此结果代回 $\\mathbf{E}(\\mathbf{r})$ 的表达式中：\n$$\n\\mathbf{E}(\\mathbf{r}) \\approx \\omega^{2} \\mu_{0} \\frac{\\exp(ikr)}{4\\pi r} (-p_{0}\\sin\\theta\\,\\hat{\\boldsymbol{\\theta}}) = -\\frac{\\omega^{2} \\mu_{0} p_{0} \\sin\\theta}{4\\pi r} \\exp(ikr) \\hat{\\boldsymbol{\\theta}}\n$$\n使用关系式 $k = \\omega\\sqrt{\\mu_0\\varepsilon_0}$ 和 $c=1/\\sqrt{\\mu_0\\varepsilon_0}$，我们可以写出 $\\omega^2\\mu_0 = k^2c^2\\mu_0 = k^2/ \\varepsilon_0$。电场于是为：\n$$\n\\mathbf{E}(\\mathbf{r}) \\approx -\\frac{k^{2} p_{0}}{4\\pi\\varepsilon_{0}} \\frac{\\exp(ikr)}{r} \\sin\\theta\\,\\hat{\\boldsymbol{\\theta}}\n$$\n这是远场电场，完成了任务1的第一部分。\n\n对于任务1的第二部分，我们求远场磁场 $\\mathbf{H}(\\mathbf{r})$。在远场中，辐射场局部类似于横电磁（TEM）平面波，其磁场与电场的关系为 $\\mathbf{H} = \\frac{1}{\\eta_{0}} \\hat{\\mathbf{r}} \\times \\mathbf{E}$，其中 $\\eta_{0} = \\sqrt{\\mu_{0}/\\varepsilon_{0}}$ 是自由空间阻抗。\n$$\n\\mathbf{H}(\\mathbf{r}) \\approx \\frac{1}{\\eta_{0}} \\hat{\\mathbf{r}} \\times \\left( -\\frac{k^{2} p_{0}}{4\\pi\\varepsilon_{0}} \\frac{\\exp(ikr)}{r} \\sin\\theta\\,\\hat{\\boldsymbol{\\theta}} \\right)\n$$\n使用叉积 $\\hat{\\mathbf{r}} \\times \\hat{\\boldsymbol{\\theta}} = \\hat{\\boldsymbol{\\phi}}$：\n$$\n\\mathbf{H}(\\mathbf{r}) \\approx -\\frac{k^{2} p_{0}}{4\\pi\\eta_{0}\\varepsilon_{0}} \\frac{\\exp(ikr)}{r} \\sin\\theta\\,\\hat{\\boldsymbol{\\phi}}\n$$\n常数组可以用 $\\eta_0\\varepsilon_0 = \\sqrt{\\mu_0/\\varepsilon_0}\\varepsilon_0 = \\sqrt{\\mu_0\\varepsilon_0} = 1/c$ 来简化。\n所以，$\\frac{k^2}{\\eta_0\\varepsilon_0} = k^2 c = k(\\omega)$。\n$$\n\\mathbf{H}(\\mathbf{r}) \\approx -\\frac{k\\omega p_{0}}{4\\pi} \\frac{\\exp(ikr)}{r} \\sin\\theta\\,\\hat{\\boldsymbol{\\phi}}\n$$\n$\\mathbf{E}(\\mathbf{r})$ 和 $\\mathbf{H}(\\mathbf{r})$ 的表达式完成了任务1。\n\n对于任务2，我们推导单位立体角的时均辐射功率。这可以从时均坡印亭矢量 $\\langle\\mathbf{S}\\rangle = \\frac{1}{2}\\text{Re}\\{\\mathbf{E} \\times \\mathbf{H}^*\\}$ 的径向分量得到。\n$$\n\\mathbf{H}^*(\\mathbf{r}) \\approx -\\frac{k\\omega p_{0}^*}{4\\pi} \\frac{\\exp(-ikr)}{r} \\sin\\theta\\,\\hat{\\boldsymbol{\\phi}}\n$$\n$$\n\\mathbf{E} \\times \\mathbf{H}^* \\approx \\left( -\\frac{k^{2} p_{0}}{4\\pi\\varepsilon_{0}} \\frac{\\exp(ikr)}{r} \\sin\\theta\\,\\hat{\\boldsymbol{\\theta}} \\right) \\times \\left( -\\frac{k\\omega p_{0}^*}{4\\pi} \\frac{\\exp(-ikr)}{r} \\sin\\theta\\,\\hat{\\boldsymbol{\\phi}} \\right)\n$$\n负号相消，且 $\\exp(ikr)\\exp(-ikr)=1$。矢量叉积为 $\\hat{\\boldsymbol{\\theta}} \\times \\hat{\\boldsymbol{\\phi}} = \\hat{\\mathbf{r}}$。\n$$\n\\mathbf{E} \\times \\mathbf{H}^* \\approx \\frac{k^3\\omega |p_0|^2 \\sin^2\\theta}{16\\pi^2\\varepsilon_0 r^2} \\hat{\\mathbf{r}}\n$$\n此表达式为纯实数，所以 $\\text{Re}\\{\\mathbf{E} \\times \\mathbf{H}^*\\} = \\mathbf{E} \\times \\mathbf{H}^*$。\n$$\n\\langle\\mathbf{S}\\rangle = \\frac{1}{2} \\frac{k^3\\omega |p_0|^2 \\sin^2\\theta}{16\\pi^2\\varepsilon_0 r^2} \\hat{\\mathbf{r}} = \\frac{k^3\\omega |p_0|^2 \\sin^2\\theta}{32\\pi^2\\varepsilon_0 r^2} \\hat{\\mathbf{r}}\n$$\n为了用所要求的变量表示，我们代入 $k=\\omega/c$：\n$$\nk^3\\omega = (\\omega/c)^3\\omega = \\omega^4/c^3\n$$\n$$\n\\langle\\mathbf{S}\\rangle = \\frac{\\omega^4 |p_0|^2}{32\\pi^2\\varepsilon_0 c^3 r^2} \\sin^2\\theta\\,\\hat{\\mathbf{r}}\n$$\n单位立体角的时均辐射功率，记为 $\\frac{dP_{\\text{rad}}}{d\\Omega}$，由 $r^2$ 乘以坡印亭矢量的大小给出：\n$$\n\\frac{dP_{\\text{rad}}}{d\\Omega} = r^2 |\\langle\\mathbf{S}\\rangle| = \\frac{\\omega^4 |p_0|^2}{32\\pi^2\\varepsilon_0 c^3} \\sin^2\\theta\n$$\n归一化角向辐射方向图 $F(\\theta)$ 定义为无量纲且最大值为1。功率的角向依赖性包含在 $\\sin^2\\theta$ 项中。$\\sin^2\\theta$ 的最大值为1，出现在 $\\theta=\\pi/2$。因此，归一化辐射方向图为：\n$$\nF(\\theta) = \\sin^2\\theta\n$$\n这完成了任务2。\n\n对于任务3，我们通过对所有立体角 $\\Omega$ 积分单位立体角的功率来求总时均辐射功率 $P_{\\text{rad}}$。立体角微元为 $d\\Omega = \\sin\\theta d\\theta d\\phi$。\n$$\nP_{\\text{rad}} = \\int_{\\Omega} \\frac{dP_{\\text{rad}}}{d\\Omega} d\\Omega = \\int_{0}^{2\\pi} \\int_{0}^{\\pi} \\left( \\frac{\\omega^4 |p_0|^2}{32\\pi^2\\varepsilon_0 c^3} \\sin^2\\theta \\right) \\sin\\theta d\\theta d\\phi\n$$\n被积函数与 $\\phi$ 无关，所以对 $\\phi$ 的积分得到 $2\\pi$：\n$$\nP_{\\text{rad}} = \\frac{\\omega^4 |p_0|^2}{32\\pi^2\\varepsilon_0 c^3} (2\\pi) \\int_{0}^{\\pi} \\sin^3\\theta d\\theta = \\frac{\\omega^4 |p_0|^2}{16\\pi\\varepsilon_0 c^3} \\int_{0}^{\\pi} \\sin^3\\theta d\\theta\n$$\n我们计算剩下的积分：\n$$\n\\int_{0}^{\\pi} \\sin^3\\theta d\\theta = \\int_{0}^{\\pi} \\sin\\theta(1-\\cos^2\\theta)d\\theta\n$$\n令 $u = \\cos\\theta$，则 $du = -\\sin\\theta d\\theta$。积分限从 $\\theta=0 \\to u=1$ 和 $\\theta=\\pi \\to u=-1$ 变化。\n$$\n\\int_{0}^{\\pi} \\sin^3\\theta d\\theta = \\int_{1}^{-1} (1-u^2)(-du) = \\int_{-1}^{1} (1-u^2)du = \\left[u - \\frac{u^3}{3}\\right]_{-1}^{1}\n$$\n$$\n= \\left(1 - \\frac{1}{3}\\right) - \\left(-1 - \\frac{(-1)^3}{3}\\right) = \\frac{2}{3} - \\left(-1 + \\frac{1}{3}\\right) = \\frac{2}{3} - \\left(-\\frac{2}{3}\\right) = \\frac{4}{3}\n$$\n将此结果代入 $P_{\\text{rad}}$ 的表达式中：\n$$\nP_{\\text{rad}} = \\frac{\\omega^4 |p_0|^2}{16\\pi\\varepsilon_0 c^3} \\left(\\frac{4}{3}\\right) = \\frac{\\omega^4 |p_0|^2}{12\\pi\\varepsilon_0 c^3}\n$$\n这是偶极子辐射的总时均功率，用所需的物理常量表示。该表达式的单位是国际单位制（瓦特）。这完成了任务3。\n\n最终答案由数对 $(F(\\theta), P_{\\text{rad}})$ 组成。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\sin^2\\theta & \\frac{\\omega^4 |p_0|^2}{12\\pi\\varepsilon_0 c^3}\n\\end{pmatrix}\n}\n$$", "id": "3303047"}, {"introduction": "在数值计算中使用并矢格林函数的一个主要挑战是当源点和观察点重合时出现的不可积奇异性。本练习将指导你实现一种标准而强大的技术——奇异性减法——来解决这个问题。通过编写代码计算体电流产生的电场，你将学习如何分离核的奇异部分，对其进行解析处理，并对其余的正则部分进行数值积分，这是计算电磁学中的一项核心技能。[@problem_id:3303052]", "problem": "您的任务是设计并实现一个数值方案，用于通过并矢格林函数计算自由空间中体电流分布产生的频域电场，该方案需通过加减一个准静态核来使用奇异性减去法。计算必须基于电磁学的第一性原理和格林函数的基本定义。\n\n您推导方法所必须依据的基础理论包括：\n- 频域中的麦克斯韦方程组（时间依赖性为 $e^{-i \\omega t}$）、自由空间中的本构关系，以及波数定义 $k = \\omega \\sqrt{\\mu_0 \\epsilon_0}$。\n- 标量自由空间亥姆霍兹格林函数 $G_0(\\mathbf{r},\\mathbf{r}') = \\dfrac{e^{i k |\\mathbf{r} - \\mathbf{r}'|}}{4 \\pi |\\mathbf{r} - \\mathbf{r}'|}$。\n- 由电流密度 $\\mathbf{J}(\\mathbf{r}')$ 产生的电场的并矢格林函数表示法，\n  $$ \\mathbf{E}(\\mathbf{r}) = i \\omega \\mu_0 \\int_{\\mathbb{R}^3} \\left[ \\mathbf{I} + \\frac{1}{k^2} \\nabla \\nabla \\right] G_0(\\mathbf{r},\\mathbf{r}') \\cdot \\mathbf{J}(\\mathbf{r}') \\, d\\mathbf{r}' , $$\n  其中 $\\mathbf{I}$ 是单位并矢，$\\nabla$ 作用于 $\\mathbf{r}$。\n- 对于径向函数 $f$，将 $\\nabla \\nabla f(|\\mathbf{r}-\\mathbf{r}'|)$ 分解为沿 $\\hat{\\mathbf{R}} \\hat{\\mathbf{R}}$ 和 $\\mathbf{I} - \\hat{\\mathbf{R}} \\hat{\\mathbf{R}}$ 的分量，其中 $\\mathbf{R} = \\mathbf{r} - \\mathbf{r}'$ 且 $\\hat{\\mathbf{R}} = \\mathbf{R}/|\\mathbf{R}|$。\n- 通过对奇异部分取 $k \\to 0$ 极限得到的准静态核，以及库仑势的黑塞矩阵的分布恒等式，\n  $$ \\nabla \\nabla \\left(\\frac{1}{R}\\right) = \\operatorname{PV}\\left[\\frac{3 \\hat{\\mathbf{R}} \\hat{\\mathbf{R}} - \\mathbf{I}}{R^3}\\right] - \\frac{4 \\pi}{3} \\mathbf{I} \\, \\delta(\\mathbf{R}), $$\n  其中 $\\operatorname{PV}$ 表示柯西主值。\n\n您的任务是：\n- 从上述基本理论出发，推导出一个作用于 $\\mathbf{J}$ 的并矢核的显式算法形式，该形式适用于在离散网格上进行数值计算，且推导过程中不得使用跳过推导的简化公式。\n- 在奇异点（$\\mathbf{r} = \\mathbf{r}'$）周围的一个小球形邻域内，通过加减准静态核来实现奇异性减去，并加回可解析积分的狄拉克δ函数自洽项。具体来说，由准静态核产生的解析修正应作为一个局域“自洽项”被包含在内，该项与 $-\\mathbf{J}(\\mathbf{r})/(3 k^2)$ 成正比，并乘以 $\\mathbf{E}(\\mathbf{r})$ 的相应物理前置因子。\n\n数值设置：\n- 考虑一个在以原点为中心的边长为 $a$ 的有限立方体域内的均匀电流密度 $\\mathbf{J}(\\mathbf{r}') = J_0 \\, \\hat{\\mathbf{x}}$，域外为零。该立方体被均匀离散化，每边有 $N$ 个点，间距为 $\\Delta = a/(N-1)$，数值积分通过对网格单元上的核进行求和来执行。\n- 观测点 $\\mathbf{r}$ 可以在立方体内或外。当 $\\mathbf{r}$ 在内部时，通过为准静态部分排除 $\\mathbf{r}$ 周围半径为 $R_0$ 的球（使用 $R_0 = 2 \\Delta$）、在该球内对正则化核进行数值积分，并加回由分布恒等式所蕴含的解析自洽项来进行奇异性减去。当 $\\mathbf{r}$ 在外部时，则不需要进行减去操作。\n- 使用真空常数 $\\mu_0 = 4 \\pi \\times 10^{-7} \\, \\mathrm{H/m}$ 和 $c = 299792458 \\, \\mathrm{m/s}$，其中 $\\epsilon_0 = 1/(\\mu_0 c^2)$。波数为 $k = \\omega/c$，其中 $\\omega = 2 \\pi f$。\n\n您的程序必须计算以下三个测试案例的电场大小 $|\\mathbf{E}(\\mathbf{r})|$（单位：伏特/米，V/m），每个案例由 $(a, N, f, J_0, \\mathbf{r})$ 指定：\n1. 案例 A（带减去法的一般内部点）：\n   - $a = 0.2 \\, \\mathrm{m}$, $N = 41$, $f = 1.0 \\times 10^8 \\, \\mathrm{Hz}$, $J_0 = 1.0 \\, \\mathrm{A/m^2}$, $\\mathbf{r} = (0,0,0) \\, \\mathrm{m}$。观测点在立方体内。应用奇异性减去法，其中 $R_0 = 2 \\Delta$。\n2. 案例 B（不带减去法的外部点）：\n   - $a = 0.2 \\, \\mathrm{m}$, $N = 41$, $f = 1.0 \\times 10^8 \\, \\mathrm{Hz}$, $J_0 = 1.0 \\, \\mathrm{A/m^2}$, $\\mathbf{r} = (0,0,1.0) \\, \\mathrm{m}$。观测点在立方体外。不应用减去法。\n3. 案例 C（带减去法的近准静态内部点）：\n   - $a = 0.2 \\, \\mathrm{m}$, $N = 41$, $f = 1.0 \\times 10^6 \\, \\mathrm{Hz}$, $J_0 = 1.0 \\, \\mathrm{A/m^2}$, $\\mathbf{r} = (0,0,0) \\, \\mathrm{m}$。观测点在立方体内。应用奇异性减去法，其中 $R_0 = 2 \\Delta$。\n\n不涉及角度单位。物理单位：以十进制浮点数报告大小，单位为伏特/米 (V/m)。\n\n您的程序应生成单行输出，其中包含三个结果，格式为方括号括起来的逗号分隔列表，顺序为 [案例 A, 案例 B, 案例 C]，例如 `[x_A,x_B,x_C]`。每个条目必须是表示 $|\\mathbf{E}(\\mathbf{r})|$（单位 V/m）的浮点数。\n\n您的实现必须是完全自包含的，不得要求用户输入或外部文件，并且必须能直接运行。所有数值步骤和使用的任何常数都必须在程序中明确定义。", "solution": "该问题要求设计并实现一个数值方案，用以计算由体电流密度 $\\mathbf{J}(\\mathbf{r}')$ 产生的电场 $\\mathbf{E}(\\mathbf{r})$。该方法基于并矢格林函数形式体系，并采用奇异性减去法来处理当观测点 $\\mathbf{r}$ 位于源区域内时核的奇异行为。\n\n### 1. 理论阐述\n\n在频域中（假设时间依赖性为 $e^{-i\\omega t}$），由电流密度 $\\mathbf{J}(\\mathbf{r}')$ 在自由空间中产生的电场 $\\mathbf{E}(\\mathbf{r})$ 由以下体积积分方程给出：\n$$\n\\mathbf{E}(\\mathbf{r}) = \\int_{V'} \\overline{\\overline{K}}(\\mathbf{r}, \\mathbf{r}') \\cdot \\mathbf{J}(\\mathbf{r}') \\, dV'\n$$\n其中 $V'$ 是源体积，$\\overline{\\overline{K}}(\\mathbf{r}, \\mathbf{r}')$ 是电场核。该核通过 $\\overline{\\overline{K}} = i \\omega \\mu_0 \\overline{\\overline{G}}_E$ 与并矢格林函数 $\\overline{\\overline{G}}_E$ 相关联。并矢格林函数由下式给出：\n$$\n\\overline{\\overline{G}}_E(\\mathbf{r}, \\mathbf{r}') = \\left[ \\mathbf{I} + \\frac{1}{k^2} \\nabla \\nabla \\right] G_0(\\mathbf{r},\\mathbf{r}')\n$$\n此处，$\\mathbf{I}$ 是单位并矢，$k = \\omega/c$ 是自由空间中的波数，$\\nabla$ 作用于观测坐标 $\\mathbf{r}$，而 $G_0(\\mathbf{r},\\mathbf{r}')$ 是标量自由空间亥姆霍兹格林函数：\n$$\nG_0(\\mathbf{r}, \\mathbf{r}') = \\frac{e^{ikR}}{4\\pi R}\n$$\n其中 $\\mathbf{R} = \\mathbf{r} - \\mathbf{r}'$ 且 $R = |\\mathbf{R}|$。\n\n计算该积分的主要挑战在于当 $R \\to 0$ 时核的奇异性。$\\nabla\\nabla G_0$ 项包含一个量级为 $O(1/R^3)$ 的不可积（强）奇异点。\n\n### 2. 并矢核的推导\n\n为推导核的显式形式，我们必须计算黑塞矩阵 $\\nabla \\nabla G_0(R)$。对于一个普通的径向函数 $f(R)$，其黑塞矩阵可以表示为：\n$$\n\\nabla \\nabla f(R) = \\left( \\frac{d^2f}{dR^2} - \\frac{1}{R}\\frac{df}{dR} \\right) \\hat{\\mathbf{R}}\\hat{\\mathbf{R}} + \\frac{1}{R}\\frac{df}{dR} \\mathbf{I}\n$$\n其中 $\\hat{\\mathbf{R}} = \\mathbf{R}/R$。对于 $f(R) = G_0(R) = \\frac{e^{ikR}}{4\\pi R}$，其导数为：\n$$\n\\frac{dG_0}{dR} = \\frac{e^{ikR}}{4\\pi} \\left( \\frac{ik}{R} - \\frac{1}{R^2} \\right)\n$$\n$$\n\\frac{d^2G_0}{dR^2} = \\frac{e^{ikR}}{4\\pi} \\left( \\frac{-k^2}{R} - \\frac{2ik}{R^2} + \\frac{2}{R^3} \\right)\n$$\n将这些导数代入黑塞矩阵公式，得到：\n$$\n\\nabla \\nabla G_0(R) = \\frac{e^{ikR}}{4\\pi R^3} \\left[ (-k^2R^2 - 3ikR + 3) \\hat{\\mathbf{R}}\\hat{\\mathbf{R}} + (ikR - 1) \\mathbf{I} \\right]\n$$\n完整的核 $\\overline{\\overline{K}} = i\\omega\\mu_0 (\\mathbf{I} G_0 + \\frac{1}{k^2}\\nabla\\nabla G_0)$ 可写作：\n$$\n\\overline{\\overline{K}}(\\mathbf{R}) = \\frac{i\\omega\\mu_0 e^{ikR}}{4\\pi k^2 R^3} \\left[ (k^2R^2+ikR-1)\\mathbf{I} + (-k^2R^2-3ikR+3)\\hat{\\mathbf{R}}\\hat{\\mathbf{R}} \\right]\n$$\n当 $R \\to 0$ 时，与 $3\\hat{\\mathbf{R}}\\hat{\\mathbf{R}}/R^3$ 和 $-\\mathbf{I}/R^3$ 成比例的项占主导地位，表现出强 $O(1/R^3)$ 奇异性。\n\n### 3. 奇异性减去\n\n为了处理这种奇异性，我们减去并加上一个准静态核。当 $R \\to 0$ 时，$\\nabla\\nabla G_0$ 的奇异行为与更简单的静电势 $1/R$ 的行为相似。问题给出了库仑势的黑塞矩阵的分布恒等式：\n$$\n\\nabla \\nabla \\left(\\frac{1}{R}\\right) = \\operatorname{PV}\\left[\\frac{3 \\hat{\\mathbf{R}} \\hat{\\mathbf{R}} - \\mathbf{I}}{R^3}\\right] - \\frac{4 \\pi}{3} \\mathbf{I} \\, \\delta(\\mathbf{R})\n$$\n其中 $\\operatorname{PV}$ 表示柯西主值。导致强奇异性的核的准静态部分定义为：\n$$\n\\overline{\\overline{K}}_{\\text{qs,PV}}(\\mathbf{R}) = \\frac{i\\omega\\mu_0}{k^2} \\operatorname{PV}\\left[\\nabla\\nabla\\left(\\frac{1}{4\\pi R}\\right)\\right] = \\frac{i\\omega\\mu_0}{4\\pi k^2} \\operatorname{PV}\\left[\\frac{3 \\hat{\\mathbf{R}} \\hat{\\mathbf{R}} - \\mathbf{I}}{R^3}\\right]\n$$\n通过加减此准静态核并分离出狄拉克δ函数贡献，$\\mathbf{E}(\\mathbf{r})$ 的积分可重写为：\n$$\n\\mathbf{E}(\\mathbf{r}) = \\int_{V'} \\left( \\overline{\\overline{K}}(\\mathbf{R}) - \\overline{\\overline{K}}_{\\text{qs,PV}}(\\mathbf{R}) \\right) \\cdot \\mathbf{J}(\\mathbf{r}') \\, dV' + \\operatorname{PV} \\int_{V'} \\overline{\\overline{K}}_{\\text{qs,PV}}(\\mathbf{R}) \\cdot \\mathbf{J}(\\mathbf{r}') \\, dV' + \\mathbf{E}_{\\text{self}}\n$$\n“自洽项” $\\mathbf{E}_{\\text{self}}$ 源于该恒等式中的狄拉克δ函数部分：\n$$\n\\mathbf{E}_{\\text{self}} = \\int_{V'} \\frac{i\\omega\\mu_0}{k^2} \\left(-\\frac{1}{3}\\mathbf{I}\\delta(\\mathbf{R})\\right) \\cdot \\mathbf{J}(\\mathbf{r}') \\, dV' = -\\frac{i\\omega\\mu_0}{3k^2} \\mathbf{J}(\\mathbf{r})\n$$\n剩余的核 $\\overline{\\overline{K}}_{\\text{reg}}(\\mathbf{R}) = \\overline{\\overline{K}}(\\mathbf{R}) - \\overline{\\overline{K}}_{\\text{qs,PV}}(\\mathbf{R})$ 是正则化的。虽然它仍然以 $O(1/R)$ 的形式弱发散，但这种奇异性是可积的，允许直接进行数值求和。\n\n### 4. 数值算法\n\n遵循问题的规定，对于源体积内的观测点 $\\mathbf{r}$，我们将数值积分域进行划分。\n1.  **减去球之外 ($R > R_0$)**：使用完整的核 $\\overline{\\overline{K}}(\\mathbf{R})$。被积函数是良态的。\n2.  **减去球之内 ($0  R \\le R_0$)**：使用正则化的核 $\\overline{\\overline{K}}_{\\text{reg}}(\\mathbf{R}) = \\overline{\\overline{K}}(\\mathbf{R}) - \\overline{\\overline{K}}_{\\text{qs,PV}}(\\mathbf{R})$ 进行数值积分。这避免了强奇异性。\n3.  **解析修正**：减去项的贡献 $\\int_{V' \\cap B_{R_0}} \\overline{\\overline{K}}_{\\text{qs,PV}} \\cdot \\mathbf{J}' dV'$（其中 $B_{R_0}$ 是半径为 $R_0$ 的球）被解析处理。对于球形区域和常数 $\\mathbf{J}$，由于对称性，主值积分为零。狄拉克δ函数的贡献作为自洽项 $\\mathbf{E}_{\\text{self}}$ 被加回。\n\n对于内部点 $\\mathbf{r}$ 的离散计算为：\n$$\n\\mathbf{E}(\\mathbf{r}) \\approx \\sum_{\\mathbf{r}'_i, |\\mathbf{R}_i| > R_0} \\overline{\\overline{K}}(\\mathbf{R}_i) \\cdot \\mathbf{J}(\\mathbf{r}'_i)\n\\Delta V + \\sum_{\\mathbf{r}'_i, 0  |\\mathbf{R}_i| \\le R_0} \\overline{\\overline{K}}_{\\text{reg}}(\\mathbf{R}_i) \\cdot \\mathbf{J}(\\mathbf{r}'_i) \\Delta V + \\mathbf{E}_{\\text{self}}\n$$\n其中 $\\Delta V = (a/(N-1))^3$ 是一个网格单元的体积。对于外部点，$R$ 永远不为零，因此不需要减去操作，所有源单元都只使用完整的核 $\\overline{\\overline{K}}$。\n\n核-矢量积可以表示为 $\\overline{\\overline{K}}\\cdot\\mathbf{J} = (\\alpha \\mathbf{I} + \\beta \\hat{\\mathbf{R}}\\hat{\\mathbf{R}}) \\cdot \\mathbf{J} = \\alpha \\mathbf{J} + \\beta(\\hat{\\mathbf{R}}\\cdot\\mathbf{J})\\hat{\\mathbf{R}}$。完整核的系数为：\n$$\n\\alpha_{\\text{full}} = \\frac{i\\omega\\mu_0 e^{ikR}}{4\\pi k^2 R^3} (k^2R^2+ikR-1)\n$$\n$$\n\\beta_{\\text{full}} = \\frac{i\\omega\\mu_0 e^{ikR}}{4\\pi k^2 R^3} (-k^2R^2-3ikR+3)\n$$\n准静态部分的系数为：\n$$\n\\alpha_{\\text{qs}} = \\frac{i\\omega\\mu_0}{4\\pi k^2 R^3} (-1)\n$$\n$$\n\\beta_{\\text{qs}} = \\frac{i\\omega\\mu_0}{4\\pi k^2 R^3} (3)\n$$\n数值实现将在减去半径 $R_0$ 内使用 $\\alpha_{\\text{reg}} = \\alpha_{\\text{full}} - \\alpha_{\\text{qs}}$ 和 $\\beta_{\\text{reg}} = \\beta_{\\text{full}} - \\beta_{\\text{qs}}$。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the electric field from a volume current source using a dyadic Green's function\n    with singularity subtraction.\n    \"\"\"\n    # Define physical constants\n    MU0 = 4 * np.pi * 1e-7  # Vacuum permeability (H/m)\n    C = 299792458.0         # Speed of light in vacuum (m/s)\n    EPS0 = 1 / (MU0 * C**2)  # Vacuum permittivity (F/m)\n\n    test_cases = [\n        # Case A: (a, N, f, J0, r_obs) - Internal point\n        (0.2, 41, 1.0e8, 1.0, np.array([0.0, 0.0, 0.0])),\n        # Case B: (a, N, f, J0, r_obs) - External point\n        (0.2, 41, 1.0e8, 1.0, np.array([0.0, 0.0, 1.0])),\n        # Case C: (a, N, f, J0, r_obs) - Near-quasistatic internal point\n        (0.2, 41, 1.0e6, 1.0, np.array([0.0, 0.0, 0.0])),\n    ]\n\n    results = []\n    for case in test_cases:\n        a, N, f, J0, r_obs = case\n\n        # Derived parameters\n        omega = 2 * np.pi * f\n        k = omega / C\n        delta = a / (N - 1)\n        dV = delta**3\n        R0 = 2 * delta\n        \n        # Current density vector\n        J_vec = np.array([J0, 0.0, 0.0], dtype=complex)\n        \n        # Grid setup for the source cube\n        half_width = a / 2.0\n        grid_coords = np.linspace(-half_width, half_width, N)\n        \n        E_total = np.array([0.0, 0.0, 0.0], dtype=complex)\n\n        # Check if observation point is inside the source volume\n        is_internal = np.all(np.abs(r_obs) = half_width + 1e-9)\n\n        # Numerical integration over the source volume\n        for x_p in grid_coords:\n            for y_p in grid_coords:\n                for z_p in grid_coords:\n                    r_prime = np.array([x_p, y_p, z_p])\n                    \n                    R_vec = r_obs - r_prime\n                    R = np.linalg.norm(R_vec)\n                    \n                    # Skip the singularity point r = r' itself. It is handled by the self-term.\n                    if R  1e-12:\n                        continue\n                    \n                    R_hat = R_vec / R\n                    \n                    # Select kernel based on position (internal/external point) and distance\n                    use_regularized_kernel = is_internal and R = R0\n                    \n                    if use_regularized_kernel:\n                        # Regularized kernel: K_full - K_qs\n                        # Numerically more stable to compute (K_full - K_qs) directly\n                        # Full kernel coeffients\n                        exp_ikR = np.exp(1j * k * R)\n                        \n                        common_factor_full = 1j * omega * MU0 * exp_ikR / (4 * np.pi * k**2 * R**3)\n                        alpha_full = common_factor_full * (k**2 * R**2 + 1j * k * R - 1)\n                        beta_full = common_factor_full * (-k**2 * R**2 - 3j * k * R + 3)\n                        \n                        # Quasistatic kernel coefficients\n                        common_factor_qs = 1j * omega * MU0 / (4 * np.pi * k**2 * R**3)\n                        alpha_qs = common_factor_qs * (-1)\n                        beta_qs = common_factor_qs * (3)\n                        \n                        alpha = alpha_full - alpha_qs\n                        beta = beta_full - beta_qs\n                    else:\n                        # Full kernel\n                        exp_ikR = np.exp(1j * k * R)\n                        \n                        common_factor = 1j * omega * MU0 * exp_ikR / (4 * np.pi * k**2 * R**3)\n                        alpha = common_factor * (k**2 * R**2 + 1j * k * R - 1)\n                        beta = common_factor * (-k**2 * R**2 - 3j * k * R + 3)\n                        \n                    # Calculate contribution from this source cell\n                    Rhat_dot_J = np.dot(R_hat, J_vec)\n                    dE = (alpha * J_vec + beta * Rhat_dot_J * R_hat) * dV\n                    E_total += dE\n                    \n        # Add the analytical self-term for internal points\n        if is_internal:\n            # E_self = - (1j * omega * MU0) / (3 * k**2) * J_vec\n            # This can also be written as -1j / (3 * omega * EPS0) * J_vec\n            J_at_r_obs = np.array([J0, 0.0, 0.0], dtype=complex)\n            E_self = -1j / (3 * omega * EPS0) * J_at_r_obs\n            E_total += E_self\n\n        # Calculate the magnitude of the total electric field\n        E_magnitude = np.linalg.norm(np.abs(E_total))\n        results.append(E_magnitude)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3303052"}, {"introduction": "除了分析已知源产生的场外，并矢格林函数也是一个强大的综合工具——用于设计源以产生所需的场分布。本实践挑战你应用表面等效原理，在惠更斯表面上设计一组等效电流，以主动抵消指定“阴影”区域内的入射平面波。通过建立并解决这个反问题，你将看到格林函数框架如何支持电磁隐形和天线综合等高级应用。[@problem_id:3303043]", "problem": "您需要设计并评估一个计算过程，该过程使用自由空间的并矢格林函数，在封闭的惠更斯面上合成等效面电流，使得总电场在预设的阴影区域内近似为零。此外，您还需要量化该设计对惠更斯面离散化的敏感程度。\n\n从计算电磁学的基本原理出发，不预设任何目标公式。使用以下内容作为基本依据：\n- 频域中，采用 $\\exp(-i \\omega t)$ 约定的时谐无源麦克斯韦方程组：\n$$\\nabla \\times \\mathbf{E} = i \\omega \\mu \\,\\mathbf{H}, \\quad \\nabla \\times \\mathbf{H} = -i \\omega \\varepsilon \\,\\mathbf{E}, \\quad \\nabla \\cdot \\mathbf{E} = 0, \\quad \\nabla \\cdot \\mathbf{H} = 0.$$\n- 亥姆霍兹方程的自由空间标量格林函数 $g(\\mathbf{r},\\mathbf{r}')$，\n$$g(\\mathbf{r},\\mathbf{r}') = \\frac{e^{i k \\lvert \\mathbf{r} - \\mathbf{r}' \\rvert}}{4 \\pi \\lvert \\mathbf{r} - \\mathbf{r}' \\rvert}, \\quad k = \\omega \\sqrt{\\mu \\varepsilon}.$$\n- 由下式定义的自由空间并矢格林函数 $\\overline{\\overline{G}}(\\mathbf{r},\\mathbf{r}')$\n$$(\\nabla \\times \\nabla \\times - k^2 \\overline{\\overline{I}})\\,\\overline{\\overline{G}}(\\mathbf{r},\\mathbf{r}') = \\overline{\\overline{I}} \\,\\delta(\\mathbf{r}-\\mathbf{r}'),$$\n其中 $\\overline{\\overline{I}}$ 是单位并矢，$\\delta(\\cdot)$ 是狄拉克δ函数。\n\n您的任务是完成以下工作。\n\n1) 从上述基本依据出发，利用 $\\overline{\\overline{G}}$ 和 $g$ 定义所蕴含的矢量微积分恒等式，推导由位于自由空间中封闭曲面 $S$ 上的纯等效磁面电流密度 $\\mathbf{M}_s(\\mathbf{r}')$ 产生的辐射电场的面积分表示。证明在 $S$ 外部的无源区域中，来自 $\\mathbf{M}_s$ 的电场贡献可以写成一个作用于 $\\mathbf{M}_s(\\mathbf{r}')$ 的算子形式，该算子用标量格林函数表示如下：\n$$\\mathbf{E}_M(\\mathbf{r}) = - \\nabla \\times \\int_S g(\\mathbf{r},\\mathbf{r}') \\,\\mathbf{M}_s(\\mathbf{r}') \\, \\mathrm{d}S' = - \\int_S \\nabla g(\\mathbf{r},\\mathbf{r}') \\times \\mathbf{M}_s(\\mathbf{r}') \\,\\mathrm{d}S',$$\n其中 $\\nabla$ 作用于 $\\mathbf{r}$，$\\nabla g(\\mathbf{r},\\mathbf{r}')$ 是标量格林函数相对于观测坐标的梯度。明确求出 $\\nabla g(\\mathbf{r},\\mathbf{r}')$ 作为 $k$、$\\mathbf{r}$ 和 $\\mathbf{r}'$ 的函数。\n\n2) 考虑一个以原点为中心、半径为 $a$ 的球形惠更斯面 $S$。通过对极角 $\\theta \\in (0,\\pi)$ 和方位角 $\\phi \\in (0,2\\pi)$ 进行宽度分别为 $\\Delta \\theta = \\pi/N_\\theta$ 和 $\\Delta \\phi = 2\\pi/N_\\phi$ 的均匀剖分，将 $S$ 离散化为 $N_\\theta \\times N_\\phi$ 个不重叠的矩形球面片。用每个面片位于 $(\\theta_c,\\phi_c)$ 的形心及其面积 $A = a^2 \\sin\\theta_c\\, \\Delta \\theta \\,\\Delta \\phi$ 来近似它，并在形心处计算局部球面单位矢量 $\\hat{\\mathbf{r}}$、$\\hat{\\boldsymbol{\\theta}}$、$\\hat{\\boldsymbol{\\phi}}$。对每个面片上的磁面电流使用分段常数切向基，\n$$\\mathbf{M}_s(\\mathbf{r}') \\approx \\sum_{p=1}^{P} \\left(m_{p,1}\\, \\hat{\\boldsymbol{\\theta}}_p + m_{p,2}\\, \\hat{\\boldsymbol{\\phi}}_p\\right)\\, \\chi_p(\\mathbf{r}'),$$\n其中 $P=N_\\theta N_\\phi$，$\\chi_p$ 是面片 $p$ 的指示函数，$m_{p,1}$、$m_{p,2}$ 是未知的复系数。利用“面片上的积分等于形心处的值乘以面积”这一近似，推导从未知系数矢量到任意观测点 $\\mathbf{r}$ 处电场的离散线性映射：\n$$\\mathbf{E}_M(\\mathbf{r}) \\approx - \\sum_{p=1}^{P} A_p \\Big( \\nabla g(\\mathbf{r},\\mathbf{r}_p) \\times \\hat{\\boldsymbol{\\theta}}_p \\Big)\\, m_{p,1} - \\sum_{p=1}^{P} A_p \\Big( \\nabla g(\\mathbf{r},\\mathbf{r}_p) \\times \\hat{\\boldsymbol{\\phi}}_p \\Big)\\, m_{p,2}.$$\n对于一组观测点，通过堆叠每个观测点上电场的三个笛卡尔分量，将其表示为典范线性代数形式 $\\mathbf{A}\\,\\mathbf{m} \\approx \\mathbf{b}$，其中 $\\mathbf{m} \\in \\mathbb{C}^{2P}$，$\\mathbf{b}$ 是这些点上入射场贡献的负值。\n\n3) 设入射场为单位振幅平面波\n$$\\mathbf{E}_{\\mathrm{inc}}(\\mathbf{r}) = \\hat{\\mathbf{x}}\\, e^{i k z},$$\n在归一化单位下，波数 $k = 2 \\pi$，因此自由空间波长为 $1$。取球形惠更斯面半径为 $a = 0.5$。将阴影区域定义为半径 $r_{\\mathrm{obs}} > a$、极角较小（具体为 $\\theta \\in [0,\\theta_{\\max}]$，其中 $\\theta_{\\max} = 0.35$ 弧度）的球冠上的观测点集。在此球冠中使用两个不相交的点集：\n- 一个半径为 $r_{\\mathrm{train}} = 0.70$ 的训练集，包含 $[0,\\theta_{\\max}]$ 内 $N_{\\theta,\\mathrm{train}} = 4$ 个等距极角和 $[0,2\\pi)$ 内 $N_{\\phi,\\mathrm{train}} = 6$ 个等距方位角，共计 $N_{\\mathrm{train}} = 24$ 个点。\n- 一个半径为 $r_{\\mathrm{test}}$ 的测试集，包含 $[0,\\theta_{\\max}]$ 内 $N_{\\theta,\\mathrm{test}} = 5$ 个等距极角和 $[0,2\\pi)$ 内 $N_{\\phi,\\mathrm{test}} = 8$ 个等距方位角，共计 $N_{\\mathrm{test}} = 40$ 个点。\n\n在训练点上，求解最小二乘问题以得到磁面电流系数，使得总场残差的欧几里得范数最小化，\n$$\\min_{\\mathbf{m}} \\left\\| \\mathbf{A}_{\\mathrm{train}} \\mathbf{m} - \\mathbf{b}_{\\mathrm{train}} \\right\\|_2,$$\n其中 $\\mathbf{b}_{\\mathrm{train}}$ 是在所有训练点上堆叠的负入射场，$\\mathbf{A}_{\\mathrm{train}}$ 是在第2项中构建的离散化算子。然后，在测试集上评估总场，\n$$\\mathbf{E}_{\\mathrm{tot}}(\\mathbf{r}) = \\mathbf{E}_{\\mathrm{inc}}(\\mathbf{r}) + \\mathbf{E}_M(\\mathbf{r}),$$\n并计算测试点上的以下标量性能指标：\n- 最大相对幅值\n$$\\eta_{\\max} = \\max_{q=1,\\dots,N_{\\mathrm{test}}} \\frac{ \\lVert \\mathbf{E}_{\\mathrm{tot}}(\\mathbf{r}_q)\\rVert_2 }{ \\lVert \\hat{\\mathbf{x}} \\rVert_2 },$$\n- 均方根相对幅值\n$$\\eta_{\\mathrm{rms}} = \\sqrt{ \\frac{1}{N_{\\mathrm{test}}} \\sum_{q=1}^{N_{\\mathrm{test}}} \\left( \\frac{ \\lVert \\mathbf{E}_{\\mathrm{tot}}(\\mathbf{r}_q)\\rVert_2 }{ \\lVert \\hat{\\mathbf{x}} \\rVert_2 } \\right)^2 }.$$\n注意 $\\lVert \\hat{\\mathbf{x}} \\rVert_2 = 1$，因此这些指标是无量纲的。本问题中所有角度都必须以弧度处理。\n\n4) 通过对以下参数元组 $(N_\\theta, N_\\phi, r_{\\mathrm{test}})$ 的测试套件重复上述设计-评估过程，来量化对离散化的鲁棒性：\n- 情况 A (粗糙，类边界): $(2, 4, 0.70)$，\n- 情况 B (粗糙): $(4, 8, 0.70)$，\n- 情况 C (理想情况): $(8, 16, 0.70)$，\n- 情况 D (边缘情况，近表面评估): $(8, 16, 0.55)$。\n\n对于每种情况，报告在其相应测试集上计算出的配对 $(\\eta_{\\max}, \\eta_{\\mathrm{rms}})$。\n\n5) 最终输出格式。您的程序必须生成单行输出，其中包含一个列表，每个案例对应一个条目。每个条目是一个双元素列表 $[\\eta_{\\max}, \\eta_{\\mathrm{rms}}]$，其中每个浮点数四舍五入到六位小数，并按A、B、C、D的顺序聚合。例如，一个可接受的输出格式是\n$$[\\,[0.123456,0.012345],[\\dots],[\\dots],[\\dots]\\,].$$\n\n程序不应读取任何外部输入。所有计算必须如所述使用归一化单位进行，并且所有角度必须是弧度。输出是无量纲的，因此最终答案中无需物理单位。", "solution": "该问题经过严格的验证过程。\n\n### 步骤 1：提取给定条件\n- **基本方程**:\n  - 时谐麦克斯韦方程组 (采用 $\\exp(-i \\omega t)$): $\\nabla \\times \\mathbf{E} = i \\omega \\mu \\,\\mathbf{H}$, $\\nabla \\times \\mathbf{H} = -i \\omega \\varepsilon \\,\\mathbf{E}$, $\\nabla \\cdot \\mathbf{E} = 0$, $\\nabla \\cdot \\mathbf{H} = 0$.\n  - 标量格林函数: $g(\\mathbf{r},\\mathbf{r}') = \\frac{e^{i k \\lvert \\mathbf{r} - \\mathbf{r}' \\rvert}}{4 \\pi \\lvert \\mathbf{r} - \\mathbf{r}' \\rvert}$，其中 $k = \\omega \\sqrt{\\mu \\varepsilon}$。\n  - 并矢格林函数定义: $(\\nabla \\times \\nabla \\times - k^2 \\overline{\\overline{I}})\\,\\overline{\\overline{G}}(\\mathbf{r},\\mathbf{r}') = \\overline{\\overline{I}} \\,\\delta(\\mathbf{r}-\\mathbf{r}')$。\n- **任务 1：推导**:\n  - 推导由封闭曲面 $S$ 上的磁面电流 $\\mathbf{M}_s(\\mathbf{r}')$ 产生的电场 $\\mathbf{E}_M(\\mathbf{r})$ 的面积分。\n  - 证明 $\\mathbf{E}_M(\\mathbf{r}) = - \\nabla \\times \\int_S g(\\mathbf{r},\\mathbf{r}') \\,\\mathbf{M}_s(\\mathbf{r}') \\, \\mathrm{d}S' = - \\int_S \\nabla g(\\mathbf{r},\\mathbf{r}') \\times \\mathbf{M}_s(\\mathbf{r}') \\,\\mathrm{d}S'$。\n  - 推导 $\\nabla g(\\mathbf{r},\\mathbf{r}')$ 的表达式。\n- **任务 2：离散化**:\n  - 几何形状：以原点为中心、半径为 $a$ 的球形惠更斯面。\n  - 离散化：通过对 $\\theta \\in (0,\\pi)$ 和 $\\phi \\in (0,2\\pi)$ 进行均匀剖分，得到 $N_\\theta \\times N_\\phi$ 个面片。\n  - 面片属性：形心 $(\\theta_c,\\phi_c)$，面积 $A = a^2 \\sin\\theta_c\\, (\\pi/N_\\theta) \\,(2\\pi/N_\\phi)$。\n  - 基函数：分段常数切向电流，$\\mathbf{M}_s(\\mathbf{r}') \\approx \\sum_{p=1}^{P} \\left(m_{p,1}\\, \\hat{\\boldsymbol{\\theta}}_p + m_{p,2}\\, \\hat{\\boldsymbol{\\phi}}_p\\right)\\, \\chi_p(\\mathbf{r}')$。\n  - 离散化场表达式：$\\mathbf{E}_M(\\mathbf{r}) \\approx - \\sum_{p=1}^{P} A_p \\Big( \\nabla g(\\mathbf{r},\\mathbf{r}_p) \\times \\hat{\\boldsymbol{\\theta}}_p \\Big)\\, m_{p,1} - \\sum_{p=1}^{P} A_p \\Big( \\nabla g(\\mathbf{r},\\mathbf{r}_p) \\times \\hat{\\boldsymbol{\\phi}}_p \\Big)\\, m_{p,2}$。\n  - 构建线性系统 $\\mathbf{A}\\,\\mathbf{m} \\approx \\mathbf{b}$。\n- **任务 3：数值设置**:\n  - 入射场: $\\mathbf{E}_{\\mathrm{inc}}(\\mathbf{r}) = \\hat{\\mathbf{x}}\\, e^{i k z}$。\n  - 参数: $k = 2 \\pi$, $a = 0.5$。\n  - 阴影区域：半径 $r_{\\mathrm{obs}} > a$，$\\theta \\in [0,0.35]$ 的球冠。\n  - 训练集：$r_{\\mathrm{train}}=0.70$, $N_{\\theta,\\mathrm{train}}=4$, $N_{\\phi,\\mathrm{train}}=6$ (共 $24$ 个点)。\n  - 测试集：$r_{\\mathrm{test}}$ (可变), $N_{\\theta,\\mathrm{test}}=5$, $N_{\\phi,\\mathrm{test}}=8$ (共 $40$ 个点)。\n  - 求解方法：求解 $\\min_{\\mathbf{m}} \\left\\| \\mathbf{A}_{\\mathrm{train}} \\mathbf{m} - \\mathbf{b}_{\\mathrm{train}} \\right\\|_2$。\n  - 性能指标：测试集上总场 $\\mathbf{E}_{\\mathrm{tot}} = \\mathbf{E}_{\\mathrm{inc}} + \\mathbf{E}_M$ 的 $\\eta_{\\max}$ (最大相对幅值) 和 $\\eta_{\\mathrm{rms}}$ (均方根相对幅值)。\n- **任务 4：测试套件**:\n  - 情况 A: $(N_\\theta, N_\\phi, r_{\\mathrm{test}}) = (2, 4, 0.70)$\n  - 情况 B: $(N_\\theta, N_\\phi, r_{\\mathrm{test}}) = (4, 8, 0.70)$\n  - 情况 C: $(N_\\theta, N_\\phi, r_{\\mathrm{test}}) = (8, 16, 0.70)$\n  - 情况 D: $(N_\\theta, N_\\phi, r_{\\mathrm{test}}) = (8, 16, 0.55)$\n- **任务 5：输出格式**: 一个包含 A-D 情况下 $[\\eta_{\\max}, \\eta_{\\mathrm{rms}}]$ 配对的列表，浮点数四舍五入到六位小数。\n\n### 步骤 2：使用提取的给定条件进行验证\n该问题基于电磁辐射与散射的标准理论，具体使用了表面等效原理（惠更斯原理）和矩量法进行数值求解。所有的物理量、方程和参数都定义明确、一致且科学合理。该问题是计算电磁学中一个有一定难度但标准的练习，旨在测试理论推导和数值实现两方面的技能。用于离散化和评估点的数值参数均已明确指定。问题是适定的；使用最小二乘求解器可以正确处理因不同离散化水平而产生的超定和欠定系统。\n\n### 步骤 3：结论与操作\n该问题被判定为 **有效**。将提供完整解答。\n\n### 解答\n\n#### 第 1 部分：面积分表示的推导\n\n我们从源产生的电场表示开始。在无源空间区域 $V$ 中，电场可以由其边界面 $S$ 上的场确定。Stratton-Chu 公式提供了这样一种表示。一个从表面等效原理推导出的简化版本指出，由封闭曲面 $S$ 上的等效电面电流 $\\mathbf{J}_s$ 和磁面电流 $\\mathbf{M}_s$ 辐射的场由下式给出：\n$$ \\mathbf{E}(\\mathbf{r}) = - \\int_S \\left[ i\\omega\\mu \\, \\overline{\\overline{G}}(\\mathbf{r}, \\mathbf{r}') \\cdot \\mathbf{J}_s(\\mathbf{r}') - \\nabla' \\times \\overline{\\overline{G}}(\\mathbf{r}, \\mathbf{r}') \\cdot \\mathbf{M}_s(\\mathbf{r}') \\right] \\mathrm{d}S' $$\n对于 $e^{-i\\omega t}$ 的时间约定，磁流贡献的旋度符号为正。更直接的方法是通过磁矢量位 $\\mathbf{F}$ 和电标量位 $\\Phi_m$。电场由 $\\mathbf{E} = -\\frac{1}{\\epsilon}\\nabla \\times \\mathbf{F}$ 给出，其中 $\\mathbf{F} = \\epsilon \\int_S g(\\mathbf{r}, \\mathbf{r}') \\mathbf{M}_s(\\mathbf{r}') dS'$。\n因此，$\\mathbf{E}_M(\\mathbf{r}) = - \\nabla \\times \\int_S g(\\mathbf{r},\\mathbf{r}') \\,\\mathbf{M}_s(\\mathbf{r}') \\, \\mathrm{d}S'$。这是第一个所需的恒等式。\n旋度算子 $\\nabla$ 作用于观测坐标 $\\mathbf{r}$，而积分是针对源坐标 $\\mathbf{r}'$ 进行的。由于两者相互独立，我们可以将算子移入积分内部：\n$$ \\mathbf{E}_M(\\mathbf{r}) = - \\int_S \\nabla \\times \\Big(g(\\mathbf{r},\\mathbf{r}') \\,\\mathbf{M}_s(\\mathbf{r}')\\Big) \\, \\mathrm{d}S' $$\n使用矢量微积分恒等式 $\\nabla \\times (f\\mathbf{V}) = f(\\nabla \\times \\mathbf{V}) + (\\nabla f) \\times \\mathbf{V}$，我们令 $f = g(\\mathbf{r},\\mathbf{r}')$ 和 $\\mathbf{V} = \\mathbf{M}_s(\\mathbf{r}')$。由于 $\\mathbf{M}_s(\\mathbf{r}')$ 仅是 $\\mathbf{r}'$ 的函数，其相对于 $\\mathbf{r}$ 的旋度为零，即 $\\nabla \\times \\mathbf{M}_s(\\mathbf{r}') = 0$。表达式简化为：\n$$ \\nabla \\times \\Big(g(\\mathbf{r},\\mathbf{r}') \\,\\mathbf{M}_s(\\mathbf{r}')\\Big) = \\nabla g(\\mathbf{r},\\mathbf{r}') \\times \\mathbf{M}_s(\\mathbf{r}') $$\n将其代回积分，得到第二个所需的恒等式：\n$$ \\mathbf{E}_M(\\mathbf{r}) = - \\int_S \\nabla g(\\mathbf{r},\\mathbf{r}') \\times \\mathbf{M}_s(\\mathbf{r}') \\,\\mathrm{d}S' $$\n接下来，我们求标量格林函数的梯度 $\\nabla g(\\mathbf{r},\\mathbf{r}')$。令 $R = \\lvert \\mathbf{r} - \\mathbf{r}' \\rvert$。标量格林函数为 $g(R) = \\frac{e^{i k R}}{4 \\pi R}$。使用链式法则，$\\nabla g = \\frac{\\mathrm{d}g}{\\mathrm{d}R} \\nabla R$。\n距离 $R$ 的梯度为 $\\nabla R = \\frac{\\mathbf{r} - \\mathbf{r}'}{\\lvert \\mathbf{r} - \\mathbf{r}' \\rvert}$。\n$g$ 相对于 $R$ 的导数为：\n$$ \\frac{\\mathrm{d}g}{\\mathrm{d}R} = \\frac{1}{4\\pi} \\frac{\\mathrm{d}}{\\mathrm{d}R} \\left( \\frac{e^{i k R}}{R} \\right) = \\frac{1}{4\\pi} \\left( \\frac{i k R e^{i k R} - e^{i k R}}{R^2} \\right) = \\frac{e^{i k R}}{4\\pi R^2} (i k R - 1) $$\n将这些组合起来，得到梯度的最终表达式：\n$$ \\nabla g(\\mathbf{r},\\mathbf{r}') = \\frac{e^{i k \\lvert \\mathbf{r} - \\mathbf{r}' \\rvert}}{4 \\pi \\lvert \\mathbf{r} - \\mathbf{r}' \\rvert^2} \\left(i k - \\frac{1}{\\lvert \\mathbf{r} - \\mathbf{r}' \\rvert}\\right) (\\mathbf{r} - \\mathbf{r}') $$\n\n#### 第 2 部分：离散化与线性系统构建\n\n我们对惠更斯面和积分方程进行离散化。磁面电流 $\\mathbf{M}_s(\\mathbf{r}')$ 由定义在 $P=N_\\theta N_\\phi$ 个面片上的一组分段常数基函数之和来近似：\n$$ \\mathbf{M}_s(\\mathbf{r}') \\approx \\sum_{p=1}^{P} \\mathbf{M}_p \\, \\chi_p(\\mathbf{r}') = \\sum_{p=1}^{P} \\left(m_{p,1}\\, \\hat{\\boldsymbol{\\theta}}_p + m_{p,2}\\, \\hat{\\boldsymbol{\\phi}}_p\\right)\\, \\chi_p(\\mathbf{r}') $$\n这里，$\\chi_p(\\mathbf{r}')$ 是面片 $p$ 的指示函数，$\\hat{\\boldsymbol{\\theta}}_p, \\hat{\\boldsymbol{\\phi}}_p$ 是面片形心 $\\mathbf{r}_p$ 处的局部切向单位矢量。\n将此代入推导出的 $\\mathbf{E}_M(\\mathbf{r})$ 积分式中：\n$$ \\mathbf{E}_M(\\mathbf{r}) = - \\sum_{p=1}^{P} \\int_{S_p} \\nabla g(\\mathbf{r},\\mathbf{r}') \\times \\left(m_{p,1}\\, \\hat{\\boldsymbol{\\theta}}_p + m_{p,2}\\, \\hat{\\boldsymbol{\\phi}}_p\\right) \\, \\mathrm{d}S' $$\n使用中点法则进行积分，$\\int_{S_p} F(\\mathbf{r}') \\mathrm{d}S' \\approx F(\\mathbf{r}_p) A_p$，其中 $A_p$ 是面片 $p$ 的面积：\n$$ \\mathbf{E}_M(\\mathbf{r}) \\approx - \\sum_{p=1}^{P} A_p \\, \\nabla g(\\mathbf{r},\\mathbf{r}_p) \\times \\left(m_{p,1}\\, \\hat{\\boldsymbol{\\theta}}_p + m_{p,2}\\, \\hat{\\boldsymbol{\\phi}}_p\\right) $$\n通过分配叉积并根据未知系数 $m_{p,1}$ 和 $m_{p,2}$ 分离求和，我们得到问题中给出的表达式：\n$$ \\mathbf{E}_M(\\mathbf{r}) \\approx - \\sum_{p=1}^{P} A_p \\Big( \\nabla g(\\mathbf{r},\\mathbf{r}_p) \\times \\hat{\\boldsymbol{\\theta}}_p \\Big)\\, m_{p,1} - \\sum_{p=1}^{P} A_p \\Big( \\nabla g(\\mathbf{r},\\mathbf{r}_p) \\times \\hat{\\boldsymbol{\\phi}}_p \\Big)\\, m_{p,2} $$\n这是未知系数与辐射场之间的线性关系。为了创建一个线性方程组，我们在 $N_{\\mathrm{train}}$ 个观测（训练）点 $\\mathbf{r}_q$ 上强制总场为零的条件：\n$$ \\mathbf{E}_{\\mathrm{tot}}(\\mathbf{r}_q) = \\mathbf{E}_{\\mathrm{inc}}(\\mathbf{r}_q) + \\mathbf{E}_M(\\mathbf{r}_q) \\approx 0 \\implies \\mathbf{E}_M(\\mathbf{r}_q) \\approx -\\mathbf{E}_{\\mathrm{inc}}(\\mathbf{r}_q) $$\n设 $\\mathbf{m} \\in \\mathbb{C}^{2P}$ 是所有未知系数组成的矢量，$\\mathbf{m} = [m_{1,1}, m_{1,2}, \\dots, m_{P,1}, m_{P,2}]^T$。设 $\\mathbf{b} \\in \\mathbb{C}^{3N_{\\mathrm{train}}}$ 是为所有训练点 $\\{ \\mathbf{r}_q \\}$ 堆叠的负入射电场分量组成的矢量。该关系可以写成矩阵方程 $\\mathbf{A}\\,\\mathbf{m} = \\mathbf{b}$。\n矩阵 $\\mathbf{A}$ 的维度是 $(3N_{\\mathrm{train}}) \\times (2P)$。每个训练点 $\\mathbf{r}_q$ 为 $\\mathbf{A}$ 贡献 $3$ 行（对应于 $x, y, z$ 场分量）。每个电流系数 $m_{p,j}$ 对应于 $\\mathbf{A}$ 的一列。\n对应于 $m_{p,1}$ 的列（列索引为 $2(p-1)$）包含了对 $q=1, \\dots, N_{\\mathrm{train}}$ 堆叠的矢量 $-A_p (\\nabla g(\\mathbf{r}_q, \\mathbf{r}_p) \\times \\hat{\\boldsymbol{\\theta}}_p)$。\n同样，对应于 $m_{p,2}$ 的列（列索引为 $2(p-1)+1$）包含了堆叠的矢量 $-A_p (\\nabla g(\\mathbf{r}_q, \\mathbf{r}_p) \\times \\hat{\\boldsymbol{\\phi}}_p)$。\n\n#### 第 3 和 4 部分：数值实现与评估\n\n该过程以 Python 脚本实现。\n1.  **常数与几何**：设置 $k=2\\pi$, $a=0.5$。\n2.  **遍历各种情况**：对每个元组 $(N_\\theta, N_\\phi, r_{\\mathrm{test}})$：\n    a. **生成表面网格**：在球面上创建 $P=N_\\theta N_\\phi$ 个面片。对每个面片，计算其形心 $\\mathbf{r}_p$、面积 $A_p$ 以及笛卡尔坐标系下的局部切向基矢量 $\\hat{\\boldsymbol{\\theta}}_p, \\hat{\\boldsymbol{\\phi}}_p$。\n    b. **生成训练点**：在指定的阴影球冠内，于半径 $r_{\\mathrm{train}}=0.70$ 处创建 $N_{\\mathrm{train}}=24$ 个点。\n    c. **构建系统**：\n       i. 构建大小为 $(3 \\times 24) \\times (2P)$ 的矩阵 $\\mathbf{A}_{\\mathrm{train}}$。每个元素都由离散化场的表达式计算得出。\n       ii. 使用在训练点上评估的入射场 $\\mathbf{E}_{\\mathrm{inc}}(\\mathbf{r}) = \\hat{\\mathbf{x}}\\, e^{i k z}$ 构建大小为 $(3 \\times 24)$ 的矢量 $\\mathbf{b}_{\\mathrm{train}}$。\n    d. **求解电流**：求解最小二乘问题 $\\min_{\\mathbf{m}} \\| \\mathbf{A}_{\\mathrm{train}} \\mathbf{m} - \\mathbf{b}_{\\mathrm{train}} \\|_2$ 以找到最优电流系数矢量 $\\mathbf{m}$。对于情况 C 和 D，此系统是欠定的；`numpy.linalg.lstsq` 将找到最小范数解。\n    e. **评估性能**：\n       i. 在指定半径 $r_{\\mathrm{test}}$ 处生成 $N_{\\mathrm{test}}=40$ 个测试点。\n       ii. 为这些测试点构建矩阵 $\\mathbf{A}_{\\mathrm{test}}$。\n       iii. 计算测试点上的散射场：$\\mathbf{E}_M^{\\mathrm{stacked}} = \\mathbf{A}_{\\mathrm{test}} \\mathbf{m}$。\n       iv. 计算测试点上的入射场 $\\mathbf{E}_{\\mathrm{inc}}$。\n       v. 计算总场：$\\mathbf{E}_{\\mathrm{tot}} = \\mathbf{E}_{\\mathrm{inc}} + \\mathbf{E}_M$。\n       vi. 计算所有测试点上的指标 $\\eta_{\\max}$ 和 $\\eta_{\\mathrm{rms}}$。参考幅值为 $\\|\\hat{\\mathbf{x}}\\|_2 = 1$。\n3.  **格式化输出**：收集所有情况下的 $(\\eta_{\\max}, \\eta_{\\mathrm{rms}})$ 配对，并以指定的列表格式打印，四舍五入到六位小数。\n\n这个结构化的过程确保了问题的所有要求都得到满足，它将理论推导与稳健的数值实现相结合。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the electromagnetics problem by synthesizing surface currents on a\n    Huygens surface to null an incident field in a shadow region.\n    \"\"\"\n\n    # --- Problem Parameters ---\n    k = 2.0 * np.pi  # Wavenumber (lambda = 1)\n    a = 0.5  # Radius of the spherical Huygens surface\n    theta_max = 0.35  # Max polar angle of shadow region in radians\n\n    # Training set parameters\n    r_train = 0.70\n    N_theta_train = 4\n    N_phi_train = 6\n    N_train = N_theta_train * N_phi_train\n\n    # Test set parameters\n    N_theta_test = 5\n    N_phi_test = 8\n    N_test = N_theta_test * N_phi_test\n\n    # Test suite of cases (N_theta, N_phi, r_test)\n    test_cases = [\n        (2, 4, 0.70),   # Case A\n        (4, 8, 0.70),   # Case B\n        (8, 16, 0.70),  # Case C\n        (8, 16, 0.55),  # Case D\n    ]\n\n    # --- Helper Functions ---\n\n    def generate_patches(N_theta, N_phi):\n        \"\"\"Generates patch centroids, areas, and basis vectors.\"\"\"\n        delta_theta = np.pi / N_theta\n        delta_phi = 2 * np.pi / N_phi\n        \n        patches = []\n        for i in range(N_theta):\n            theta_c = (i + 0.5) * delta_theta\n            for j in range(N_phi):\n                phi_c = (j + 0.5) * delta_phi\n                \n                area = a**2 * np.sin(theta_c) * delta_theta * delta_phi\n                \n                # Centroid in Cartesian coordinates\n                r_p = np.array([\n                    a * np.sin(theta_c) * np.cos(phi_c),\n                    a * np.sin(theta_c) * np.sin(phi_c),\n                    a * np.cos(theta_c)\n                ])\n                \n                # Tangential basis vectors in Cartesian coordinates\n                theta_hat = np.array([\n                    np.cos(theta_c) * np.cos(phi_c),\n                    np.cos(theta_c) * np.sin(phi_c),\n                    -np.sin(theta_c)\n                ])\n                phi_hat = np.array([\n                    -np.sin(phi_c),\n                    np.cos(phi_c),\n                    0.0\n                ])\n                \n                patches.append({'r_p': r_p, 'area': area, 'theta_hat': theta_hat, 'phi_hat': phi_hat})\n        return patches\n\n    def generate_observation_points(r_obs, N_theta_obs, N_phi_obs):\n        \"\"\"Generates observation points on a spherical cap.\"\"\"\n        thetas = np.linspace(0, theta_max, N_theta_obs)\n        phis = np.linspace(0, 2 * np.pi, N_phi_obs, endpoint=False)\n        \n        points = []\n        for theta in thetas:\n            for phi in phis:\n                point = np.array([\n                    r_obs * np.sin(theta) * np.cos(phi),\n                    r_obs * np.sin(theta) * np.sin(phi),\n                    r_obs * np.cos(theta)\n                ])\n                points.append(point)\n        return np.array(points)\n\n    def grad_g(r, r_prime):\n        \"\"\"Computes the gradient of the scalar Green's function.\"\"\"\n        R_vec = r - r_prime\n        R = np.linalg.norm(R_vec)\n        if R == 0:\n            return np.zeros(3, dtype=np.complex128)\n        \n        phase_term = np.exp(1j * k * R)\n        magnitude_term = (1j * k * R - 1) / (4 * np.pi * R**3)\n        \n        return phase_term * magnitude_term * R_vec\n\n    def incident_field(r_obs):\n        \"\"\"Computes the incident plane wave field.\"\"\"\n        z = r_obs[2]\n        return np.array([np.exp(1j * k * z), 0.0, 0.0], dtype=np.complex128)\n\n    # --- Main Loop ---\n    \n    results = []\n\n    # Generate training points once\n    training_points = generate_observation_points(r_train, N_theta_train, N_phi_train)\n\n    for case in test_cases:\n        N_theta, N_phi, r_test = case\n        \n        # 1. Generate surface discretization\n        patches = generate_patches(N_theta, N_phi)\n        P = len(patches) # Total number of patches\n        \n        # 2. Assemble training system\n        A_train = np.zeros((3 * N_train, 2 * P), dtype=np.complex128)\n        b_train = np.zeros(3 * N_train, dtype=np.complex128)\n        \n        for q, r_q in enumerate(training_points):\n            # Calculate incident field for b_train\n            b_train[3*q : 3*q+3] = -incident_field(r_q)\n            \n            # Fill A_train matrix\n            for p, patch in enumerate(patches):\n                grad_g_val = grad_g(r_q, patch['r_p'])\n                \n                # Contribution from m_p,1 (theta-directed current)\n                v1 = -patch['area'] * np.cross(grad_g_val, patch['theta_hat'])\n                A_train[3*q : 3*q+3, 2*p] = v1\n\n                # Contribution from m_p,2 (phi-directed current)\n                v2 = -patch['area'] * np.cross(grad_g_val, patch['phi_hat'])\n                A_train[3*q : 3*q+3, 2*p + 1] = v2\n\n        # 3. Solve for current coefficients using least squares\n        m, _, _, _ = np.linalg.lstsq(A_train, b_train, rcond=None)\n        \n        # 4. Evaluate on the test set\n        test_points = generate_observation_points(r_test, N_theta_test, N_phi_test)\n        \n        E_scattered = np.zeros((N_test, 3), dtype=np.complex128)\n        for q, r_q in enumerate(test_points):\n            e_scat_q = np.zeros(3, dtype=np.complex128)\n            for p, patch in enumerate(patches):\n                grad_g_val = grad_g(r_q, patch['r_p'])\n                m_p1 = m[2*p]\n                m_p2 = m[2*p+1]\n                \n                v1 = -patch['area'] * np.cross(grad_g_val, patch['theta_hat'])\n                v2 = -patch['area'] * np.cross(grad_g_val, patch['phi_hat'])\n                \n                e_scat_q += m_p1 * v1 + m_p2 * v2\n            E_scattered[q] = e_scat_q\n\n        E_incident = np.array([incident_field(r_q) for r_q in test_points])\n        E_total = E_incident + E_scattered\n        \n        # 5. Compute performance metrics\n        # The reference amplitude is ||x_hat|| = 1\n        magnitudes_sq = np.sum(np.abs(E_total)**2, axis=1)\n        \n        eta_max = np.sqrt(np.max(magnitudes_sq))\n        eta_rms = np.sqrt(np.mean(magnitudes_sq))\n        \n        results.append([round(eta_max, 6), round(eta_rms, 6)])\n\n    # Final print statement in the exact required format.\n    # Using a simple string replace to achieve the exact format without extra spaces.\n    final_output_str = str(results).replace(\"'\", \"\").replace(\" \", \"\")\n    print(final_output_str)\n\nsolve()\n```", "id": "3303043"}]}