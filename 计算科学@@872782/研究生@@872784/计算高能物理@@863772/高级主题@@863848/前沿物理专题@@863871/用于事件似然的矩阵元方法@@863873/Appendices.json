{"hands_on_practices": [{"introduction": "该练习是掌握矩阵元方法的基石。它将指导您从第一性原理出发，为一个纯净的 $e^+e^-$ 碰撞事件构建一个完整而简单的矩阵元方法似然。通过完成这个实践，您将巩固对核心组成部分的理解：理论矩阵元（$|\\mathcal{M}|^2$）、相空间积分，以及模拟实验效应的探测器传递函数卷积。[@problem_id:3522061]", "problem": "您将设计并实现一个数值矩阵元方法 (Matrix Element Method, MEM) 似然评估器，用于评估量子电动力学 (Quantum Electrodynamics, QED) 中的散射过程 $e^+ e^- \\to \\mu^+ \\mu^-$。目标是从散射理论的第一性原理出发，在μ子质量可忽略不计的高能近似下，推导出该过程在树级水平下的非极化、自旋平均的矩阵元平方 $|\\mathcal{M}|^2$，然后将其代入以下形式的 MEM 事件似然函数\n$$\nL(x \\mid \\theta) \\;=\\; \\frac{1}{\\sigma(\\theta)} \\int d\\Phi_2 \\;\\frac{d\\sigma}{d\\Phi_2}(\\theta)\\; W(x \\mid \\phi;\\theta),\n$$\n其中 $x$ 表示测量的事件可观测量，$\\theta$ 表示模型参数，$d\\Phi_2$ 表示二体末态相空间，$d\\sigma/d\\Phi_2$ 是微分截面，而 $W(x \\mid \\phi;\\theta)$ 是一个模拟探测器响应的转移函数。\n\n您必须针对以下特定设置对该表达式进行数值实现：\n\n- 基本依据与假设：\n  - 对 $e^+ e^- \\to \\mu^+ \\mu^-$ 使用仅包含光子交换的树级量子电动力学 (QED)。\n  - 假设在高能极限下，μ子质量相对于 $e^+ e^-$ 束的质心能量 $\\sqrt{s}$ 可忽略不计。电子被视为无质量。\n  - 使用精细结构常数 $\\alpha$ 作为一个固定的数值常量 $\\alpha = 1/137.035999084$。\n  - 质心系与实验室系重合，且没有初态辐射。\n  - 参数 $\\theta$ 是以 $\\mathrm{GeV}$ 为单位的质心能量 $\\sqrt{s}$，因此 $s = (\\sqrt{s})^2$。\n\n- 散射理论与相空间：\n  - 从相对论性散射的 $S$ 矩阵和费米黄金定则 (Fermi’s Golden Rule) 出发，使用 $2\\to 2$ 散射的标准通量和相空间因子。\n  - 对于无质量的末态μ子，在质心系中，令 $\\theta$ (极角) 和 $\\varphi$ (方位角) 参数化 $\\mu^+$ 动量的方向。那么 $d\\Phi_2$ 可以写成 $d\\Omega = d\\varphi\\, d(\\cos\\theta)$ 乘以已知常数，微分截面可以表示为 $s$ 和 $\\cos\\theta$ 的函数。\n  - 非极化、自旋平均的矩阵元平方 $|\\mathcal{M}|^2$ 必须通过 QED 的迹技术推导得出，并且得到的微分截面 $d\\sigma/d\\Omega$ 必须用 $|\\mathcal{M}|^2$、$s$ 和常数表示。\n\n- 转移函数：\n  - 探测器转移函数 $W(x \\mid \\phi;\\theta)$ 是每个μ子三个笛卡尔动量分量的独立高斯分辨率的乘积。设测量的三维动量为 $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^+}$ 和 $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^-}$，真实的三维动量（是 $\\phi \\equiv (\\theta,\\varphi)$ 和 $\\sqrt{s}$ 的函数）为 $\\mathbf{p}^{\\,\\mathrm{true}}_{\\mu^+}(\\phi;\\sqrt{s})$ 和 $\\mathbf{p}^{\\,\\mathrm{true}}_{\\mu^-}(\\phi;\\sqrt{s}) = -\\mathbf{p}^{\\,\\mathrm{true}}_{\\mu^+}(\\phi;\\sqrt{s})$。高斯转移函数为：\n    $$\n    W(x \\mid \\phi;\\sqrt{s}) \\;=\\; \\prod_{i=1}^{3} \\frac{1}{\\sqrt{2\\pi}\\,\\sigma}\\exp\\!\\left(-\\frac{\\left(p^{\\,\\mathrm{meas}}_{\\mu^+,i}-p^{\\,\\mathrm{true}}_{\\mu^+,i}(\\phi;\\sqrt{s})\\right)^2}{2\\sigma^2}\\right)\\;\n    \\prod_{i=1}^{3} \\frac{1}{\\sqrt{2\\pi}\\,\\sigma}\\exp\\!\\left(-\\frac{\\left(p^{\\,\\mathrm{meas}}_{\\mu^-,i}-p^{\\,\\mathrm{true}}_{\\mu^-,i}(\\phi;\\sqrt{s})\\right)^2}{2\\sigma^2}\\right),\n    $$\n    其中 $\\sigma$ 是动量分辨率（对每个笛卡尔分量都相同）。\n  - 每个μ子的真实三维动量大小为 $|\\mathbf{p}^{\\,\\mathrm{true}}_{\\mu^\\pm}| = \\sqrt{s}/2$，$\\mu^+$ 的方向由 $(\\theta,\\varphi)$ 给出，而 $\\mu^-$ 的方向与之相反（背对背）。\n\n- 似然函数与归一化：\n  - 使用\n    $$\n    L(x \\mid \\sqrt{s}) \\;=\\; \\frac{1}{\\sigma(s)} \\int d\\Omega \\;\\frac{d\\sigma}{d\\Omega}(s,\\cos\\theta)\\; W(x\\mid \\theta,\\varphi;\\sqrt{s}),\n    $$\n    其中 $s = (\\sqrt{s})^2$，$d\\Omega = d\\varphi\\, d(\\cos\\theta)$，$\\sigma(s)$ 是总的树级截面。\n  - 所有积分必须使用确定性求积法进行数值计算。角度必须以弧度为单位。积分域为 $\\cos\\theta \\in [-1,1]$ 和 $\\varphi \\in [0,2\\pi)$。\n  - 您必须根据与 $d\\sigma/d\\Omega$ 相同的理论显式计算 $\\sigma(s)$，以确保根据上述 MEM 定义获得一个正确归一化的似然函数。\n\n- 单位：\n  - 所有动量单位必须是 $\\mathrm{GeV}$，所有能量单位是 $\\mathrm{GeV}$，所有角度单位是弧度。\n  - 最终的似然函数单位是 $\\mathrm{GeV}^{-6}$，因为高斯转移函数是两个粒子在三维动量空间中的密度。您的程序必须以这些单位输出浮点数值。\n\n- 数值实现指南：\n  - 对 $u \\equiv \\cos\\theta$ 使用高斯-勒让德求积法 (Gauss-Legendre quadrature)，对 $\\varphi$ 使用均匀梯形法则，以计算 $d\\Omega = d\\varphi \\, du$，并使用足够多的点数以获得稳定值。\n  - 您的代码必须是自包含的，且不得读取外部输入。\n\n- 测试套件：\n  - 使用精细结构常数 $\\alpha = 1/137.035999084$。\n  - 对于下方的每个测试用例，使用指定的 $\\sqrt{s}$、高斯宽度 $\\sigma$ (单位 $\\mathrm{GeV}$) 和测量的动量 (单位 $\\mathrm{GeV}$) 来评估 $L(x \\mid \\sqrt{s})$：\n    1. 正常路径：\n       - $\\sqrt{s} = 10.0$\n       - $\\sigma = 0.5$\n       - $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^+} = (4.10,\\,1.10,\\,2.60)$\n       - $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^-} = (-4.00,\\,-1.30,\\,-2.80)$\n    2. 不同能量标度：\n       - $\\sqrt{s} = 5.0$\n       - $\\sigma = 0.3$\n       - $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^+} = (-0.70,\\,1.70,\\,-1.60)$\n       - $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^-} = (0.90,\\,-1.80,\\,1.40)$\n    3. 具有不一致背对背拓扑的边缘案例：\n       - $\\sqrt{s} = 10.0$\n       - $\\sigma = 0.5$\n       - $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^+} = (3.00,\\,0.00,\\,3.00)$\n       - $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^-} = (-2.00,\\,0.50,\\,-3.40)$\n\n- 最终输出格式：\n  - 您的程序必须生成一行输出，其中包含三个似然值，格式为 Python 风格的列表，用逗号分隔且无空格，例如：$\\texttt{[v1,v2,v3]}$。每个 $v_i$ 都必须是一个浮点数。\n\n所有最终答案都以 $\\mathrm{GeV}^{-6}$ 为单位表示，角度以弧度表示。您的程序必须是完全确定性的和自包含的。", "solution": "该问题是有效的，因为它构成了一个在计算高能物理领域中定义明确且自包含的任务。它基于量子电动力学 (QED) 和散射理论的既定原理，并提供了推导和实现数值解所需的所有必要信息。\n\n目标是计算过程 $e^+ e^- \\to \\mu^+ \\mu^-$ 的矩阵元方法 (MEM) 似然函数 $L(x \\mid \\sqrt{s})$。似然函数由以下公式给出：\n$$\nL(x \\mid \\sqrt{s}) = \\frac{1}{\\sigma(s)} \\int d\\Omega \\;\\frac{d\\sigma}{d\\Omega}(s,\\cos\\theta)\\; W(x\\mid \\theta,\\varphi;\\sqrt{s})\n$$\n其中 $s = (\\sqrt{s})^2$ 是质心能量的平方，$d\\Omega = d\\varphi\\, d(\\cos\\theta)$ 是立体角元，$d\\sigma/d\\Omega$ 是微分截面，$\\sigma(s)$ 是总截面，而 $W$ 是探测器转移函数。解答需要从第一性原理推导这些组成部分。\n\n**1. 微分截面 $d\\sigma/d\\Omega$ 的推导**\n\n对于末态粒子无质量的 $2 \\to 2$ 散射过程，在质心 (CM) 系中，其微分截面由费米黄金定则 (Fermi's Golden Rule) 给出：\n$$\n\\frac{d\\sigma}{d\\Omega} = \\frac{1}{64\\pi^2 s} \\overline{|\\mathcal{M}|^2}\n$$\n其中 $\\overline{|\\mathcal{M}|^2}$ 是自旋平均的矩阵元平方。\n\n该过程为 $e^-(p_1) + e^+(p_2) \\to \\mu^-(p_3) + \\mu^+(p_4)$。在 QED 的树级水平上，此过程通过 $s$ 道中的单个虚光子进行。矩阵元 $\\mathcal{M}$ 为：\n$$\n\\mathcal{M} = \\frac{e^2}{s} \\left[ \\bar{v}(p_2)\\gamma^\\mu u(p_1) \\right] \\left[ \\bar{u}(p_3)\\gamma_\\mu v(p_4) \\right]\n$$\n其中 $e$ 是元电荷，$\\gamma^\\mu$ 是狄拉克矩阵 (Dirac matrices)，$u, v, \\bar{u}, \\bar{v}$ 是粒子和反粒子的旋量。\n\n为计算非极化截面，我们对初态自旋进行平均（因子为 $1/2 \\times 1/2 = 1/4$）并对末态自旋求和：\n$$\n\\overline{|\\mathcal{M}|^2} = \\frac{1}{4} \\sum_{\\text{spins}} |\\mathcal{M}|^2 = \\frac{1}{4} \\frac{e^4}{s^2} L_e^{\\mu\\nu} L_{\\mu\\nu}^{\\mu}\n$$\n轻子张量 $L_e^{\\mu\\nu}$ 和 $L_{\\mu\\nu}^{\\mu}$ 来自于自旋求和。在高能极限（无质量费米子）下使用迹技术，其中 $\\sum_s u_s(p)\\bar{u}_s(p) = \\not p$ 且 $\\sum_s v_s(p)\\bar{v}_s(p) = \\not p$：\n$$\nL_e^{\\mu\\nu} = \\mathrm{Tr}[\\not p_2 \\gamma^\\mu \\not p_1 \\gamma^\\nu] = 4 \\left( p_1^\\mu p_2^\\nu + p_1^\\nu p_2^\\mu - g^{\\mu\\nu}(p_1 \\cdot p_2) \\right)\n$$\n$$\nL_{\\mu\\nu}^{\\mu} = \\mathrm{Tr}[\\not p_3 \\gamma_\\mu \\not p_4 \\gamma_\\nu] = 4 \\left( p_{3\\mu} p_{4\\nu} + p_{3\\nu} p_{4\\mu} - g_{\\mu\\nu}(p_3 \\cdot p_4) \\right)\n$$\n这些张量的缩并最容易用曼德尔施塔姆变量 (Mandelstam variables) 表示。对于一个无质量过程，$s=(p_1+p_2)^2$，$t=(p_1-p_3)^2$，$u=(p_1-p_4)^2$，且 $s+t+u=0$。\n$p_1 \\cdot p_2 = s/2$, $p_3 \\cdot p_4 = s/2$.\n$p_1 \\cdot p_3 = p_2 \\cdot p_4 = -t/2$.\n$p_1 \\cdot p_4 = p_2 \\cdot p_3 = -u/2$.\n张量缩并得到：\n$$\nL_e^{\\mu\\nu} L_{\\mu\\nu}^{\\mu} = 32 \\left( (p_1 \\cdot p_3)(p_2 \\cdot p_4) + (p_1 \\cdot p_4)(p_2 \\cdot p_3) \\right) = 32 \\left( \\frac{t^2}{4} + \\frac{u^2}{4} \\right) = 8(t^2+u^2)\n$$\n因此，矩阵元平方为：\n$$\n\\overline{|\\mathcal{M}|^2} = \\frac{1}{4} \\frac{e^4}{s^2} \\left[ 8(t^2+u^2) \\right] = \\frac{2e^4}{s^2}(t^2+u^2)\n$$\n在质心系中，令 $\\theta$ 为入射电子和出射 $\\mu^-$ 之间的夹角。曼德尔施塔姆变量为：\n$t = (p_1-p_3)^2 = -2 p_1 \\cdot p_3 = -2 \\frac{\\sqrt{s}}{2} \\frac{\\sqrt{s}}{2} (1 - \\cos\\theta) = -\\frac{s}{2}(1-\\cos\\theta)$\n$u = (p_1-p_4)^2 = -2 p_1 \\cdot p_4 = -2 \\frac{\\sqrt{s}}{2} \\frac{\\sqrt{s}}{2} (1 + \\cos\\theta) = -\\frac{s}{2}(1+\\cos\\theta)$\n将这些代入 $\\overline{|\\mathcal{M}|^2}$ 的表达式中：\n$$\n\\overline{|\\mathcal{M}|^2} = \\frac{2e^4}{s^2} \\left[ \\frac{s^2}{4}(1-\\cos\\theta)^2 + \\frac{s^2}{4}(1+\\cos\\theta)^2 \\right] = \\frac{e^4}{2} \\left[ (1-2\\cos\\theta+\\cos^2\\theta) + (1+2\\cos\\theta+\\cos^2\\theta) \\right] = e^4(1+\\cos^2\\theta)\n$$\n在自然单位制中，使用精细结构常数 $\\alpha = e^2/(4\\pi)$，我们有 $e^4 = 16\\pi^2\\alpha^2$。\n$$\n\\overline{|\\mathcal{M}|^2} = 16\\pi^2\\alpha^2(1+\\cos^2\\theta)\n$$\n最后，微分截面为：\n$$\n\\frac{d\\sigma}{d\\Omega} = \\frac{1}{64\\pi^2 s} \\left[ 16\\pi^2\\alpha^2(1+\\cos^2\\theta) \\right] = \\frac{\\alpha^2}{4s}(1+\\cos^2\\theta)\n$$\n\n**2. 总截面 $\\sigma(s)$ 的计算**\n\n总截面 $\\sigma(s)$ 是似然函数的归一化因子。它通过对微分截面在整个立体角上积分得到：\n$$\n\\sigma(s) = \\int \\frac{d\\sigma}{d\\Omega} d\\Omega = \\int_0^{2\\pi} d\\varphi \\int_{-1}^{1} d(\\cos\\theta) \\frac{\\alpha^2}{4s}(1+\\cos^2\\theta)\n$$\n对 $\\varphi$ 的积分得到 $2\\pi$。令 $u = \\cos\\theta$：\n$$\n\\sigma(s) = 2\\pi \\frac{\\alpha^2}{4s} \\int_{-1}^{1} (1+u^2) du = \\frac{\\pi\\alpha^2}{2s} \\left[ u + \\frac{u^3}{3} \\right]_{-1}^{1} = \\frac{\\pi\\alpha^2}{2s} \\left[ \\left(1+\\frac{1}{3}\\right) - \\left(-1-\\frac{1}{3}\\right) \\right] = \\frac{\\pi\\alpha^2}{2s} \\left(\\frac{8}{3}\\right)\n$$\n$$\n\\sigma(s) = \\frac{4\\pi\\alpha^2}{3s}\n$$\n\n**3. 组合似然被积函数**\n\n似然表达式包含比率 $\\frac{1}{\\sigma(s)}\\frac{d\\sigma}{d\\Omega}$，该比率定义了在立体角上的归一化概率分布：\n$$\n\\frac{1}{\\sigma(s)}\\frac{d\\sigma}{d\\Omega} = \\frac{3s}{4\\pi\\alpha^2} \\cdot \\frac{\\alpha^2}{4s}(1+\\cos^2\\theta) = \\frac{3}{16\\pi}(1+\\cos^2\\theta)\n$$\n因此，完整的似然表达式为：\n$$\nL(x \\mid \\sqrt{s}) = \\int_0^{2\\pi} d\\varphi \\int_{-1}^{1} d(\\cos\\theta) \\left( \\frac{3}{16\\pi}(1+\\cos^2\\theta) \\right) W(x \\mid \\theta,\\varphi;\\sqrt{s})\n$$\n\n**4. 转移函数**\n\n转移函数 $W(x \\mid \\phi;\\sqrt{s})$ 将真实的份子动量 $\\mathbf{p}^{\\text{true}}_{\\mu^\\pm}$ 与测量的动量 $\\mathbf{p}^{\\text{meas}}_{\\mu^\\pm}$ 联系起来。它是六个高斯函数的乘积：\n$$\nW(x \\mid \\phi;\\sqrt{s}) = \\left(\\frac{1}{\\sqrt{2\\pi}\\,\\sigma}\\right)^6 \\exp\\left(-\\frac{\\left|\\mathbf{p}^{\\text{meas}}_{\\mu^+} - \\mathbf{p}^{\\text{true}}_{\\mu^+}\\right|^2 + \\left|\\mathbf{p}^{\\text{meas}}_{\\mu^-} - \\mathbf{p}^{\\text{true}}_{\\mu^-}\\right|^2}{2\\sigma^2}\\right)\n$$\n在质心系中，$\\mathbf{p}^{\\text{true}}_{\\mu^-} = -\\mathbf{p}^{\\text{true}}_{\\mu^+}$。大小为 $|\\mathbf{p}^{\\text{true}}_{\\mu^+}| = \\sqrt{s}/2$。$\\mathbf{p}^{\\text{true}}_{\\mu^+}$ 的方向由积分变量 $(\\theta, \\varphi)$ 参数化：\n$$\n\\mathbf{p}^{\\text{true}}_{\\mu^+}(\\theta, \\varphi) = \\frac{\\sqrt{s}}{2} \\begin{pmatrix} \\sin\\theta\\cos\\varphi \\\\ \\sin\\theta\\sin\\varphi \\\\ \\cos\\theta \\end{pmatrix}\n$$\n指数的参数可以展开以便高效计算：\n$$ \\mathcal{E} = -\\frac{1}{2\\sigma^2} \\left[ |\\mathbf{p}^{\\text{meas}}_{\\mu^+}|^2 + |\\mathbf{p}^{\\text{meas}}_{\\mu^-}|^2 + 2|\\mathbf{p}^{\\text{true}}_{\\mu^+}|^2 - 2(\\mathbf{p}^{\\text{meas}}_{\\mu^+} - \\mathbf{p}^{\\text{meas}}_{\\mu^-}) \\cdot \\mathbf{p}^{\\text{true}}_{\\mu^+} \\right] $$\n$$ \\mathcal{E} = -\\frac{1}{2\\sigma^2} \\left[ |\\mathbf{p}^{\\text{meas}}_{\\mu^+}|^2 + |\\mathbf{p}^{\\text{meas}}_{\\mu^-}|^2 + \\frac{s}{2} - 2(\\mathbf{p}^{\\text{meas}}_{\\mu^+} - \\mathbf{p}^{\\text{meas}}_{\\mu^-}) \\cdot \\mathbf{p}^{\\text{true}}_{\\mu^+}(\\theta, \\varphi) \\right] $$\n方括号中不依赖于 $(\\theta, \\varphi)$ 的项可以预先计算。\n\n**5. 数值积分**\n\n最终的积分采用数值方法计算。我们对 $u = \\cos\\theta \\in [-1, 1]$ 的积分使用高斯-勒让德求积法，对 $\\varphi \\in [0, 2\\pi)$ 的积分使用梯形法则。\n设 $u_i, w_i$ 为 $N_u$ 个高斯-勒让德点和权重。设 $\\varphi_j = j \\frac{2\\pi}{N_\\varphi}$ (其中 $j=0, \\dots, N_\\varphi-1$) 为梯形法则的均匀点。离散化的积分为：\n$$\nL \\approx \\sum_{i=1}^{N_u} w_i \\left( \\frac{2\\pi}{N_\\varphi} \\sum_{j=0}^{N_\\varphi-1} \\left[ \\frac{3}{16\\pi}(1+u_i^2) \\right] W(x \\mid \\theta_i, \\varphi_j; \\sqrt{s}) \\right)\n$$\n其中 $\\cos\\theta_i = u_i$。这提供了一种对似然函数的确定性且精确的评估。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import roots_legendre\n\ndef solve():\n    \"\"\"\n    Main function to calculate MEM likelihood for specified test cases.\n    \"\"\"\n    # Define constants\n    N_U = 64  # Number of points for cos(theta) integration (Gauss-Legendre)\n    N_PHI = 64  # Number of points for phi integration (Trapezoidal)\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (sqrt_s, sigma, p_mu_plus_meas, p_mu_minus_meas) in GeV\n        (10.0, 0.5, (4.10, 1.10, 2.60), (-4.00, -1.30, -2.80)),\n        (5.0, 0.3, (-0.70, 1.70, -1.60), (0.90, -1.80, 1.40)),\n        (10.0, 0.5, (3.00, 0.00, 3.00), (-2.00, 0.50, -3.40)),\n    ]\n\n    results = []\n    for case in test_cases:\n        sqrt_s, sigma, p_plus_meas, p_minus_meas = case\n        likelihood = calculate_likelihood(sqrt_s, sigma, p_plus_meas, p_minus_meas, N_U, N_PHI)\n        results.append(f\"{likelihood:.6e}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef calculate_likelihood(sqrt_s, sigma, p_mu_plus_meas, p_mu_minus_meas, n_u, n_phi):\n    \"\"\"\n    Calculates the MEM likelihood for a single event.\n\n    Args:\n        sqrt_s (float): Center-of-mass energy in GeV.\n        sigma (float): Momentum resolution (Gaussian width) in GeV.\n        p_mu_plus_meas (tuple): 3-momentum of the measured mu+.\n        p_mu_minus_meas (tuple): 3-momentum of the measured mu-.\n        n_u (int): Number of integration points for cos(theta).\n        n_phi (int): Number of integration points for phi.\n\n    Returns:\n        float: The calculated likelihood value in GeV^-6.\n    \"\"\"\n    s = sqrt_s**2\n\n    # Convert measured momenta to numpy arrays\n    p_plus = np.array(p_mu_plus_meas)\n    p_minus = np.array(p_mu_minus_meas)\n\n    # --- Pre-calculate terms for the transfer function exponent ---\n    # The exponent is -(constant_part + vector_part . p_true) / (2*sigma^2)\n    \n    # Constant part of the numerator: |p_meas+|^2 + |p_meas-|^2 + 2*|p_true|^2\n    # where |p_true|^2 = (sqrt_s/2)^2 = s/4\n    exp_const_part = np.dot(p_plus, p_plus) + np.dot(p_minus, p_minus) + s / 2.0\n\n    # Coefficient for the vector part of the numerator: -2 * (p_meas+ - p_meas-)\n    exp_vec_coeff = -2.0 * (p_plus - p_minus)\n    \n    # Overall prefactor for the transfer function W\n    w_prefactor = (1.0 / (np.sqrt(2 * np.pi) * sigma))**6\n    \n    # --- Numerical Integration Setup ---\n    # Gauss-Legendre quadrature for u = cos(theta) in [-1, 1]\n    u_points, u_weights = roots_legendre(n_u)\n    # Trapezoidal rule for phi in [0, 2*pi)\n    phi_points = np.linspace(0, 2 * np.pi, n_phi, endpoint=False)\n    d_phi = 2 * np.pi / n_phi\n    \n    integral_sum = 0.0\n    true_p_mag = sqrt_s / 2.0\n    \n    # Outer loop: integration over u = cos(theta)\n    for i in range(n_u):\n        u = u_points[i]\n        w_u = u_weights[i]\n        \n        # sin(theta) can be derived from u = cos(theta)\n        sin_theta = np.sqrt(1.0 - u**2)\n        \n        # The normalized QED matrix element part of the integrand\n        # P(Omega) = (3 / (16*pi)) * (1 + cos_theta^2)\n        matrix_element_part = (3.0 / (16.0 * np.pi)) * (1.0 + u**2)\n        \n        phi_integral_sum = 0.0\n        # Inner loop: integration over phi\n        for j in range(n_phi):\n            phi = phi_points[j]\n            \n            # Construct the true mu+ momentum vector for this integration point\n            p_true = np.array([\n                true_p_mag * sin_theta * np.cos(phi),\n                true_p_mag * sin_theta * np.sin(phi),\n                true_p_mag * u\n            ])\n            \n            # --- Calculate the Transfer Function W ---\n            dot_product = np.dot(exp_vec_coeff, p_true)\n            exponent_numerator = exp_const_part + dot_product\n            exponent = -exponent_numerator / (2.0 * sigma**2)\n            \n            w_val = w_prefactor * np.exp(exponent)\n            \n            # Full integrand for this (u_i, phi_j) point\n            integrand = matrix_element_part * w_val\n            phi_integral_sum += integrand\n\n        # Accumulate the phi-integrated result (trapezoidal sum)\n        # weighted by the Gauss-Legendre weight for this u_i\n        integral_sum += w_u * (phi_integral_sum * d_phi)\n        \n    return integral_sum\n\nif __name__ == \"__main__\":\n    solve()\n```", "id": "3522061"}, {"introduction": "强子对撞机上的真实实验常常产生复杂的末态，其中包含多个源自可能无法区分的夸克的喷注。本练习直面这一组合挑战，这是在真实分析环境中应用矩阵元方法的关键环节。您将学习如何正确地对所有可能的喷注-部分子分配进行求和，并融入如b物理标签这样的离散实验信息，以构建一个强大而真实的事件似然。[@problem_id:3522033]", "problem": "考虑一个与标准模型（SM）中顶夸克-反顶夸克对产生和衰变通道 $t\\bar{t}\\to W^{+}b\\, W^{-}\\bar{b}\\to \\ell \\nu + 4$ jets 一致的单个事件。在此事件中，存在正好 $4$ 个重建的喷注，且它们全部来自部分子 $\\{b_{\\text{lep}}, b_{\\text{had}}, q, q^{\\prime}\\}$。其中 $\\ell$ 表示一个电子或缪子，$\\nu$ 表示相应的中微子。您将使用矩阵元方法（MEM）来写出事件概率密度，其中包括对喷注-部分子分配的求和以及每个喷注的 $b$-标签信息。为此目的，假设以下理想化条件，这些条件是标准的且科学上一致的：\n\n- 来自强子衰变的 $W$ 玻色子的两个轻夸克 $\\{q, q^{\\prime}\\}$ 在矩阵元的平方中是不可区分的。\n- 观测到的事件记录 $x$ 包括测量的轻子四动量、缺失横向动量、四个喷注的四动量 $\\{p_{1},p_{2},p_{3},p_{4}\\}$ 以及二进制的 $b$-标签比特 $\\{t_{1},t_{2},t_{3},t_{4}\\}$，其中 $t_{j}\\in\\{0,1\\}$。\n- $b$-标签响应模型在各个喷注之间是独立的，并且仅依赖于分配给该喷注的真实部分子味：对于源自 $b$ 夸克的喷注，$P(t_{j}=1|b)=\\varepsilon_{b}$ 且 $P(t_{j}=0|b)=1-\\varepsilon_{b}$；对于源自轻夸克（$u$，$d$，$s$）或胶子的喷注，$P(t_{j}=1|\\text{light})=\\varepsilon_{q}$ 且 $P(t_{j}=0|\\text{light})=1-\\varepsilon_{q}$，其中 $0  \\varepsilon_{q}  \\varepsilon_{b}  1$。\n- 在MEM中，事件概率密度是通过将完全微分的部分子截面与探测器传递函数进行卷积，并用总截面进行归一化来构建的。使用一个因子化的传递函数 $W(x|y;\\alpha)$，它编码了在给定的喷注-部分子分配 $\\alpha$ 下，从部分子级运动学 $y$ 到测量值 $x$ 的映射；您可以保持 $W(x|y;\\alpha)$ 为符号形式。\n- 初始态强子是未极化的质子，初始部分子的动量分数通过部分子分布函数（PDFs）进行积分。用 $\\sqrt{s}$ 表示强子质心系能量，用 $\\hat{s}=x_{1}x_{2}s$ 表示部分子质心系能量，并包含通常的流强因子。\n\n任务：\n\n(a) 仅使用末态的粒子成分和矩阵元平方中强子衰变 $W\\to q q^{\\prime}$ 产物的不可区分性，计算在这种拓扑结构下，当正好有 $4$ 个重建喷注时，在MEM中必须求和的非等价喷注-部分子置换的数量。\n\n(b) 从MEM事件概率密度与部分子微分截面卷积探测器传递函数并由总截面归一化成正比的定义出发，构建模型参数为 $\\theta$ 的置换求和事件似然函数 $L(x|\\theta)$。您的表达式必须：\n- 对(a)部分中获得的所有非等价喷注-部分子分配进行求和。\n- 对初态部分子味进行求和。\n- 对部分子动量分数和 $t\\bar{t}\\to \\ell \\nu b \\bar{b} q q^{\\prime}$ 的整个末态相空间进行积分。\n- 包含流强因子和矩阵元的平方。\n- 将每个分配的运动学积分乘以由该分配和观测到的标签比特 $\\{t_{j}\\}$ 所蕴含的每个喷注的 $b$-标签概率的乘积。\n\n(c) 以单个闭合形式的解析表达式给出 $L(x|\\theta)$ 的最终结果，其中置换求和的上限是(a)部分中得到的明确数字，并且每个喷注的 $b$-标签因子使用指示函数书写，该函数标识在给定分配下，一个喷注是被映射到一个 $b$ 夸克还是一个轻夸克。该表达式必须是一个单行的数学公式。不需要进行数值计算，最终表达式中也不应包含任何单位。", "solution": "用户提供了一个关于计算高能物理中矩阵元方法（MEM）的问题。我将首先验证问题陈述。\n\n### 问题验证\n\n**第一步：提取已知条件**\n- **过程**：顶夸克-反顶夸克对产生和衰变 $t\\bar{t}\\to W^{+}b\\, W^{-}\\bar{b}\\to \\ell \\nu + 4$ jets。\n- **产生喷注的部分子**：$\\{b_{\\text{lep}}, b_{\\text{had}}, q, q^{\\prime}\\}$。\n- **不可区分性**：来自强子衰变的 $W$ 玻色子的轻夸克 $\\{q, q^{\\prime}\\}$ 在矩阵元的平方中是不可区分的。\n- **观测事件数据 ($x$)**：测量的轻子四动量、缺失横向动量、四个喷注的四动量 $\\{p_{1},p_{2},p_{3},p_{4}\\}$，以及四个二进制 $b$-标签比特 $\\{t_{1},t_{2},t_{3},t_{4}\\}$，其中 $t_{j}\\in\\{0,1\\}$。\n- **$b$-标签模型**：\n    - 每个喷注之间独立。\n    - $P(t_{j}=1|b)=\\varepsilon_{b}$ 且 $P(t_{j}=0|b)=1-\\varepsilon_{b}$。\n    - $P(t_{j}=1|\\text{light})=\\varepsilon_{q}$ 且 $P(t_{j}=0|\\text{light})=1-\\varepsilon_{q}$。\n    - 效率和误标率约束：$0  \\varepsilon_{q}  \\varepsilon_{b}  1$。\n- **MEM 公式化**：\n    - 事件概率密度与完全微分的部分子截面和探测器传递函数的卷积成正比，并由总截面进行归一化。\n    - 传递函数是一个因子化的函数 $W(x|y;\\alpha)$，保持为符号形式。\n- **初始态**：未极化的质子，通过部分子分布函数（PDFs）对部分子动量分数 $x_1, x_2$ 进行积分，强子质心系能量为 $\\sqrt{s}$，部分子质心系能量为 $\\hat{s}=x_{1}x_{2}s$，并包含流强因子。\n\n**第二步：使用提取的已知条件进行验证**\n- **科学依据**：该问题牢固地植根于粒子物理学的标准模型，并采用了矩阵元方法，这是实验高能物理数据分析中一种标准的、成熟的技术。所有概念，包括 $t\\bar{t}$ 产生、PDFs、矩阵元、传递函数和 $b$-标签，都是标准的且科学上合理的。\n- **良态问题**：该问题被构造成三个清晰的、顺序性的任务。部分(a)是一个定义明确的组合问题。部分(b)和(c)要求基于明确陈述的物理原理和组件构建一个数学对象（似然函数）。抽象的层次（例如，符号化的矩阵元和传递函数）对于一个理论问题是合适的，并不会使其无法解决。\n- **客观性**：语言是技术性的、精确的，并且没有任何主观性或模糊性。\n\n问题陈述没有违反任何无效标准。它是科学合理的、良态的、客观的、完整的且非平凡的。\n\n**结论**：问题是**有效的**。\n\n### 解答\n\n解答过程按顺序处理三个任务中的每一个。\n\n**(a) 非等价喷注-部分子置换的数量**\n\n任务是确定将四个末态部分子 $\\{b_{\\text{lep}}, b_{\\text{had}}, q, q^{\\prime}\\}$ 分配给四个重建喷注 $\\{p_1, p_2, p_3, p_4\\}$ 的不同方式的数量。一个特定的分配是一个将每个喷注映射到一个唯一部分子的置换。\n\n- 这四个喷注可以通过其测量属性（例如，四动量）来区分。\n- 这四个部分子必须仔细考虑。标签 $b_{\\text{lep}}$ 和 $b_{\\text{had}}$ 分别表示源自轻子衰变和强子衰变的顶夸克的 $b$ 夸克。在事件重建的背景下，这些是不同的物理假设，因为将一个喷注与 $b_{\\text{lep}}$ 或 $b_{\\text{had}}$ 相关联会导致母顶夸克的不同运动学构型。因此，$b_{\\text{lep}}$ 和 $b_{\\text{had}}$ 被视为可区分的。\n- 问题陈述指出，来自强子 $W$ 衰变的轻夸克 $\\{q, q^{\\prime}\\}$ 在“矩阵元的平方中是不可区分的”。这是MEM中的一个标准简化，意味着任何两个仅因交换两个喷注之间的 $q$ 和 $q^{\\prime}$ 分配而不同的置换，将为似然函数被积函数的运动学部分产生相同的值。因此，它们不代表不同的假设，应被计为一个单一的“非等价”置换。\n\n因此，我们正在计算要分配给四个不同喷注的部分子角色的多重集的置换数。角色集合是 $\\{b_{\\text{lep}}, b_{\\text{had}}, \\text{light}, \\text{light}\\}$。我们有 $N=4$ 个项目（喷注位置），并希望排列 $k_1=1$ 个 $b_{\\text{lep}}$ 类型的对象，$k_2=1$ 个 $b_{\\text{had}}$ 类型的对象，以及 $k_3=2$ 个“轻夸克”类型的对象。这种不同置换的数量由多项式系数给出：\n$$ \\frac{N!}{k_1! k_2! k_3!} = \\frac{4!}{1! \\, 1! \\, 2!} = \\frac{24}{2} = 12 $$\n因此，必须求和的非等价喷注-部分子置换有 $12$ 种。\n\n**(b) 事件似然函数的构建**\n\n事件概率密度，我们将其作为似然函数 $L(x|\\theta)$，定义为在给定模型参数 $\\theta$ 的情况下，产生观测事件 $x$ 的归一化微分截面。通用公式为：\n$$ L(x|\\theta) = \\frac{1}{\\sigma_{\\text{tot}}(\\theta)} \\frac{d\\sigma(x|\\theta)}{dx} $$\n项 $\\frac{d\\sigma(x|\\theta)}{dx}$ 是通过对所有可能导致观测到 $x$ 的中间步骤求和得到的。这包括：\n1.  对所有可能的初态部分子配对求和，用索引 $i, j$ 表示。\n2.  对这些部分子的动量分数 $x_1, x_2$ 进行积分，并由它们各自的PDFs $f_{i,j}(x,Q^2)$ 加权。\n3.  部分子相互作用本身，由矩阵元的平方 $|\\mathcal{M}_{ij \\to f}(y;\\theta)|^2$ 描述，其中 $y$ 代表末态部分子的动量。这由相对论性流强因子 $1/(2\\hat{s}) = 1/(2x_1x_2s)$ 加权。\n4.  对末态部分子的完整洛伦兹不变相空间 $d\\Phi(y)$ 进行积分。\n5.  与探测器传递函数 $W(x|y;\\alpha)$ 进行卷积，该函数给出在给定部分子态 $y$ 和特定喷注-部分子分配 $\\alpha$ 的情况下，观测到状态 $x$ 的概率。\n6.  对(a)部分中确定的所有非等价喷注-部分子分配 $\\alpha_k$ 进行求和。\n7.  给定分配 $\\alpha_k$ 时，观测到 $b$-标签构型 $\\{t_j\\}$ 的概率的乘法因子。\n\n结合这些元素，未归一化的概率被构建为对置换的求和，其中每一项都涉及对潜变量（部分子运动学）的积分。对于给定的分配 $\\alpha_k$，$b$-标签概率 $P_b(\\{t_j\\}|\\alpha_k)$ 相对于运动学积分是常数，可以被因子化出来。这个概率是单个喷注标签概率的乘积，这些概率依赖于分配给该喷注的部分子的真实味。\n$$ P_b(\\{t_j\\}|\\alpha_k) = \\prod_{j=1}^4 P(t_j|\\text{flavor}(\\alpha_k(p_j))) $$\n然后，遵循MEM框架规定的结构，通过组合这些组件来构建完整的表达式。\n\n**(c) 似然函数的最终解析表达式**\n\n在这里，我们写出 $L(x|\\theta)$ 的完整表达式，结合(a)和(b)的结果。设 $\\mathcal{A} = \\{\\alpha_k\\}_{k=1}^{12}$ 是 $12$ 个非等价喷注-部分子分配的集合。设 $I_b(\\alpha_k, j)$ 是一个指示函数，如果喷注 $j$ 在分配 $\\alpha_k$ 下被分配给一个 $b$-夸克（$b_{\\text{lep}}$ 或 $b_{\\text{had}}$），则其值为 $1$，否则为 $0$。类似地，设 $I_q(\\alpha_k, j) = 1 - I_b(\\alpha_k, j)$ 是分配给轻夸克（$q$ 或 $q^{\\prime}$）的指示函数。末态为 $f = \\{\\ell, \\nu, b, \\bar{b}, q, q^{\\prime}\\}$，其部分子动量集体表示为 $y$。归一化因子 $\\sigma(\\theta)$ 是信号过程的总理论截面，通过对完全相空间和PDFs上的微分部分子截面进行积分得到，不包括传递函数或 $b$-标签概率。似然函数为：\n$$ L(x|\\theta) = \\frac{1}{\\sigma(\\theta)} \\sum_{i,j} \\sum_{k=1}^{12} \\left( \\prod_{j=1}^4 \\left[\\varepsilon_b^{t_j}(1-\\varepsilon_b)^{1-t_j}\\right]^{I_b(\\alpha_k,j)} \\left[\\varepsilon_q^{t_j}(1-\\varepsilon_q)^{1-t_j}\\right]^{I_q(\\alpha_k,j)} \\right) \\int_0^1 \\!\\! dx_1 \\int_0^1 \\!\\! dx_2 \\frac{f_i(x_1,Q^2)f_j(x_2,Q^2)}{2x_1x_2s} \\int \\! d\\Phi(y) |\\mathcal{M}_{ij \\to f}(y;\\theta)|^2 W(x|y;\\alpha_k) $$\n\n这个表达式表示在指定模型和假设下观测到事件 $x$ 的完整概率密度。它对所有贡献的初态（$i,j$）和所有可区分的末态构型（$12$ 种置换）进行求和，每一种都由其相应的 $b$-标签概率加权，并将理论预测与探测器响应进行卷积。", "answer": "$$\\boxed{L(x|\\theta) = \\frac{1}{\\sigma(\\theta)} \\sum_{i,j} \\sum_{k=1}^{12} \\left( \\prod_{j=1}^4 \\left[\\varepsilon_b^{t_j}(1-\\varepsilon_b)^{1-t_j}\\right]^{I_b(\\alpha_k,j)} \\left[\\varepsilon_q^{t_j}(1-\\varepsilon_q)^{1-t_j}\\right]^{I_q(\\alpha_k,j)} \\right) \\int_0^1 \\!\\! dx_1 \\int_0^1 \\!\\! dx_2 \\frac{f_i(x_1,Q^2)f_j(x_2,Q^2)}{2x_1x_2s} \\int \\! d\\Phi(y) |\\mathcal{M}_{ij \\to f}(y;\\theta)|^2 W(x|y;\\alpha_k)}$$", "id": "3522033"}, {"introduction": "矩阵元方法的威力超越了粒子发现，延伸到了精确测量的领域。这项高级实践展示了如何运用矩阵元方法探测微妙的量子力学特性，例如顶夸克与反顶夸克之间的自旋相关性。通过实现复杂的自旋密度矩阵形式，您将学会从末态粒子的角分布中提取这些信息，从而深入了解其内在的产生动力学。[@problem_id:3522028]", "problem": "您将使用自旋密度矩阵形式体系，实现一个最小但完全通用的、基于矩阵元的顶夸克-反顶夸克自旋关联的逐事件似然，然后使用轻子角度量化逐事件灵敏度。工作将完全在窄宽度近似下进行，在该近似中，矩阵元的平方可以分解为一个产生自旋密度矩阵和多个衰变自旋分析器。目标是仅使用顶夸克和反顶夸克各自静止参考系中的轻子方向，从第一性原理出发，为指定的关联假设构建一个归一化的逐事件似然比和一个逐事件得分。\n\n从以下基本基础开始：\n- 在窄宽度近似下，对于一个包含两个衰变的自旋为 $\\tfrac{1}{2}$ 的母粒子的过程，其全微分率可以分解为一个产生自旋密度矩阵和多个衰变密度矩阵。这可以不失一般性地通过对自旋指标求迹来表示。\n- 顶夸克-反顶夸克在领头阶的产生自旋密度矩阵可以在 Pauli 基上展开为\n$$\n\\rho = \\frac{1}{4}\\left(I \\otimes I + \\sum_{i} P_i \\, \\sigma_i \\otimes I + \\sum_{i} \\bar{P}_i \\, I \\otimes \\sigma_i + \\sum_{i,j} C_{ij} \\, \\sigma_i \\otimes \\sigma_j \\right),\n$$\n其中 $I$ 是自旋 $\\tfrac{1}{2}$ 空间上的单位矩阵，$\\sigma_i$ 是 Pauli 矩阵（$i \\in \\{x,y,z\\}$），$C_{ij}$ 是自旋关联张量。假设没有单自旋极化，即 $P_i = \\bar{P}_i = 0$，但保留对角元 $C_{xx}$、$C_{yy}$、$C_{zz}$ 中的完整关联结构。\n- 对于来自极化顶夸克（或反顶夸克）衰变的带电轻子，该轻子是一个分析能力为 $\\alpha_\\ell = 1$ 的最大自旋分析器。在母粒子静止参考系中，对于单个轻子方向单位向量 $\\hat{\\ell} = (\\ell_x,\\ell_y,\\ell_z)$ 的衰变密度矩阵为\n$$\nD(\\hat{\\ell}) = \\frac{1}{2}\\left(I + \\alpha_\\ell \\, \\hat{\\ell}\\cdot \\vec{\\sigma}\\right),\n$$\n其中 $\\vec{\\sigma} = (\\sigma_x,\\sigma_y,\\sigma_z)$。\n- 对于观测到的轻子单位向量 $\\hat{\\ell}_+$ 和 $\\hat{\\ell}_-$，其逐事件权重（与微分率成正比）由以下自旋迹给出\n$$\nw(C_{xx},C_{yy},C_{zz} \\mid \\hat{\\ell}_+,\\hat{\\ell}_-) \\propto \\mathrm{Tr}\\left[ \\rho(C_{xx},C_{yy},C_{zz}) \\, D(\\hat{\\ell}_+) \\otimes D(\\hat{\\ell}_-) \\right].\n$$\n在产生和衰变过程中，请使用一个共同的固定自旋量子化基。您可以假设，在任何似然比中，与关联参数无关的总体归一化因子会相互抵消。\n\n您的任务：\n1. 从迹表达式出发，仅使用 Pauli 矩阵的代数性质，推导逐事件权重 $w$ 的一个明确可计算的表达式。然后实现一个函数，通过直接的矩阵运算来计算 $w$，而不使用任何简化公式。\n2. 为具有不同关联张量的两个假设 $H_1$ 和 $H_0$ 定义逐事件对数似然比 $R$，如下所示\n$$\nR \\equiv \\ln \\frac{L(H_1 \\mid \\hat{\\ell}_+,\\hat{\\ell}_-)}{L(H_0 \\mid \\hat{\\ell}_+,\\hat{\\ell}_-)},\n$$\n其中 $L$ 与 $w$ 成正比。由于与 $(C_{xx},C_{yy},C_{zz})$ 无关的总体归一化会抵消，您可以通过相应权重的比值来计算 $R$。\n3. 为仅以 $C_{zz}=\\kappa$（其中 $C_{xx}=C_{yy}=0$）形式出现的标量参数 $\\kappa$ 定义逐事件得分，即逐事件对数似然对 $\\kappa$ 的导数，\n$$\nS_z(\\kappa) \\equiv \\frac{\\partial}{\\partial \\kappa} \\ln L(\\kappa \\mid \\hat{\\ell}_+,\\hat{\\ell}_-).\n$$\n通过在迹下对 $\\kappa$ 求导，直接从迹表达式中表示 $S_z(\\kappa)$，并使用矩阵运算实现它。在您的实现中，请勿使用任何预先简化的角分布公式。\n\n数值和算法要求：\n- 使用自旋基，其中 $z$ 轴为自旋量子化轴。角度使用弧度。对于相对于此基由极角 $\\theta$ 和方位角 $\\phi$ 指定的轻子，构造单位向量 $\\hat{\\ell} = (\\sin\\theta\\cos\\phi,\\sin\\theta\\sin\\phi,\\cos\\theta)$。\n- 对两个轻子均设置分析能力 $\\alpha_\\ell = 1$。\n- 确保实现使用 $2\\times 2$ 复数矩阵表示自旋态，并使用线性代数精确计算迹。不要硬编码任何简化的 $w$ 最终形式；通过构造 $\\rho$、$D(\\hat{\\ell}_+)$、$D(\\hat{\\ell}_-)$，然后对乘积求迹来计算它。\n- 角度是无量纲的；所有角度都用弧度表示。\n\n测试套件：\n使用以下四个事件，每个事件由 $(\\theta_+,\\phi_+,\\theta_-,\\phi_-)$（以弧度为单位）定义，以及两个关联假设：\n- 假设 $H_0$：不相关，其中 $C_{xx}=0, C_{yy}=0, C_{zz}=0$。\n- 假设 $H_{z,0.5}$：纯 $z$ 轴关联，其中 $C_{xx}=0, C_{yy}=0, C_{zz}=0.5$。\n- 假设 $H_{\\mathrm{diag}}$：一般对角关联，其中 $C_{xx}=0.3, C_{yy}=-0.2, C_{zz}=0.5$。\n\n事件：\n- 事件 1：$\\theta_+ = \\pi/3$, $\\phi_+ = 0.7$, $\\theta_- = \\pi/6$, $\\phi_- = -1.0$。\n- 事件 2：$\\theta_+ = 0.0$, $\\phi_+ = 0.0$, $\\theta_- = 0.0$, $\\phi_- = 0.0$。\n- 事件 3：$\\theta_+ = 0.0$, $\\phi_+ = 2.0$, $\\theta_- = \\pi$, $\\phi_- = -0.3$。\n- 事件 4：$\\theta_+ = \\pi/2$, $\\phi_+ = \\pi/4$, $\\theta_- = \\pi/2$, $\\phi_- = 3\\pi/4$。\n\n对于每个事件 $i$，计算以下四个量：\n- $R^{(i)}_{z,0.5} \\equiv \\ln \\dfrac{L(H_{z,0.5} \\mid \\hat{\\ell}_+^{(i)},\\hat{\\ell}_-^{(i)})}{L(H_0 \\mid \\hat{\\ell}_+^{(i)},\\hat{\\ell}_-^{(i)})}$。\n- $S^{(i)}_{z}(0) \\equiv \\left.\\dfrac{\\partial}{\\partial \\kappa} \\ln L(\\kappa \\mid \\hat{\\ell}_+^{(i)},\\hat{\\ell}_-^{(i)})\\right|_{\\kappa=0}$，其中只有 $C_{zz}=\\kappa$ 变化，且 $C_{xx}=C_{yy}=0$。\n- $R^{(i)}_{\\mathrm{diag}} \\equiv \\ln \\dfrac{L(H_{\\mathrm{diag}} \\mid \\hat{\\ell}_+^{(i)},\\hat{\\ell}_-^{(i)})}{L(H_0 \\mid \\hat{\\ell}_+^{(i)},\\hat{\\ell}_-^{(i)})}$。\n- $S^{(i)}_{z}(0.2) \\equiv \\left.\\dfrac{\\partial}{\\partial \\kappa} \\ln L(\\kappa \\mid \\hat{\\ell}_+^{(i)},\\hat{\\ell}_-^{(i)})\\right|_{\\kappa=0.2}$，同样只有 $C_{zz}=\\kappa$ 变化。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含 16 个结果，以逗号分隔列表的形式并用方括号括起来，按事件排序，并在每个事件内按以下顺序排列\n$$\n\\left[R^{(1)}_{z,0.5},\\, S^{(1)}_{z}(0),\\, R^{(1)}_{\\mathrm{diag}},\\, S^{(1)}_{z}(0.2),\\, \\dots,\\, R^{(4)}_{z,0.5},\\, S^{(4)}_{z}(0),\\, R^{(4)}_{\\mathrm{diag}},\\, S^{(4)}_{z}(0.2)\\right].\n$$", "solution": "该问题要求使用自旋密度矩阵形式体系，为顶夸克-反顶夸克自旋关联构建逐事件似然及相关统计量。实现必须基于第一性原理，通过显式地构造和操作相关矩阵来计算逐事件权重。\n\n此分析的基础是在窄宽度近似下，对于涉及两个衰变的自旋为 $1/2$ 的粒子的过程（例如 $t\\bar{t}$ 产生后进行轻子衰变），其微分截面（或率）的因子分解。对于给定的一组末态运动学，逐事件权重 $w$（与全微分率成正比）由产生密度矩阵 $\\rho$ 和每个粒子的衰变密度矩阵的乘积对自旋指标求迹得到。对于观测到轻子 $\\ell^+$ 和 $\\ell^-$ 的 $t\\bar{t}$ 系统，这表示为：\n$$\nw(C_{ij} \\mid \\hat{\\ell}_+, \\hat{\\ell}_-) \\propto \\mathrm{Tr}\\left[ \\rho(C_{ij}) \\, \\left(D(\\hat{\\ell}_+) \\otimes D(\\hat{\\ell}_-)\\right) \\right]\n$$\n此处，$\\hat{\\ell}_+$ 和 $\\hat{\\ell}_-$ 是带电轻子在其各自母顶夸克静止参考系中的方向单位向量，迹运算是在 $t\\bar{t}$ 系统的四维自旋空间上进行的。\n\n首先，我们确定所涉及矩阵的显式形式。$t\\bar{t}$ 对的产生自旋密度矩阵 $\\rho$ 以 Pauli 矩阵 $\\sigma_i$ ($i \\in \\{x,y,z\\}$) 为基展开给出。在无净极化 ($P_i = \\bar{P}_i = 0$) 且仅有对角自旋关联 ($C_{ij} = 0$ for $i \\neq j$) 的指定约束下，$\\rho$ 简化为：\n$$\n\\rho(C_{xx}, C_{yy}, C_{zz}) = \\frac{1}{4}\\left(I \\otimes I + C_{xx} \\, \\sigma_x \\otimes \\sigma_x + C_{yy} \\, \\sigma_y \\otimes \\sigma_y + C_{zz} \\, \\sigma_z \\otimes \\sigma_z \\right)\n$$\n其中 $I$ 是 $2 \\times 2$ 单位矩阵，$\\otimes$ 表示克罗内克（张量）积。在标准的 $z$ 轴自旋量子化基中，Pauli 矩阵为：\n$$\nI = \\begin{pmatrix} 1  0 \\\\ 0  1 \\end{pmatrix}, \\quad \\sigma_x = \\begin{pmatrix} 0  1 \\\\ 1  0 \\end{pmatrix}, \\quad \\sigma_y = \\begin{pmatrix} 0  -i \\\\ i  0 \\end{pmatrix}, \\quad \\sigma_z = \\begin{pmatrix} 1  0 \\\\ 0  -1 \\end{pmatrix}\n$$\n这些表示为 $2 \\times 2$ 的复数矩阵。因此，矩阵 $\\rho$ 是一个 $4 \\times 4$ 的复数矩阵。\n\n极化顶夸克衰变为带电轻子的过程充当了自旋分析器。单个衰变的衰变密度矩阵 $D(\\hat{\\ell})$ 取决于顶夸克静止参考系中轻子的方向单位向量 $\\hat{\\ell}$ 及其分析能力 $\\alpha_\\ell$。对于最大分析能力 $\\alpha_\\ell=1$，表达式为：\n$$\nD(\\hat{\\ell}) = \\frac{1}{2}\\left(I + \\hat{\\ell} \\cdot \\vec{\\sigma}\\right) = \\frac{1}{2}\\left(I + \\ell_x \\sigma_x + \\ell_y \\sigma_y + \\ell_z \\sigma_z\\right)\n$$\n单位向量 $\\hat{\\ell} = (\\ell_x, \\ell_y, \\ell_z)$ 由轻子的极角 $\\theta$ 和方位角 $\\phi$ 构成为 $\\hat{\\ell} = (\\sin\\theta\\cos\\phi, \\sin\\theta\\sin\\phi, \\cos\\theta)$。$t\\bar{t}$ 系统的完整衰变矩阵是单个衰变矩阵的张量积，$D(\\hat{\\ell}_+) \\otimes D(\\hat{\\ell}_-)$，它是一个 $4 \\times 4$ 矩阵。为了计算权重 $w$，我们为给定的事件和关联假设构造矩阵 $\\rho$、$D(\\hat{\\ell}_+)$ 和 $D(\\hat{\\ell}_-)$，计算它们的乘积和张量积，最后评估所得 $4 \\times 4$ 矩阵的迹。\n\n第二个任务是为两个由不同自旋关联张量表征的假设 $H_1$ 和 $H_0$ 定义逐事件对数似然比 $R$。似然 $L(H \\mid \\text{data})$ 与逐事件权重 $w(H \\mid \\text{data})$ 成正比。因此，该比值为：\n$$\nR \\equiv \\ln \\frac{L(H_1 \\mid \\hat{\\ell}_+, \\hat{\\ell}_-)}{L(H_0 \\mid \\hat{\\ell}_+, \\hat{\\ell}_-)} = \\ln \\frac{w(H_1 \\mid \\hat{\\ell}_+, \\hat{\\ell}_-)}{w(H_0 \\mid \\hat{\\ell}_+, \\hat{\\ell}_-)}\n$$\n在 $w$ 中任何与关联参数 $C_{ij}$ 无关的总体归一化常数将在此比值中抵消。计算过程包括计算两次 $w$，一次使用 $H_1$ 的参数，一次使用 $H_0$ 的参数，然后取它们比值的自然对数。\n\n第三个任务是计算逐事件得分 $S_z(\\kappa)$，它被定义为对数似然对某个感兴趣参数的导数。这里，我们考虑一个模型，其中只有 $C_{zz}$ 非零，并由 $\\kappa$ 参数化，即 $C_{xx}=C_{yy}=0$ 且 $C_{zz}=\\kappa$。得分为：\n$$\nS_z(\\kappa) \\equiv \\frac{\\partial}{\\partial \\kappa} \\ln L(\\kappa \\mid \\hat{\\ell}_+, \\hat{\\ell}_-)\n$$\n使用链式法则和 $L \\propto w$ 的正比关系，这变为：\n$$\nS_z(\\kappa) = \\frac{1}{L(\\kappa)} \\frac{\\partial L(\\kappa)}{\\partial \\kappa} = \\frac{1}{w(\\kappa)} \\frac{\\partial w(\\kappa)}{\\partial \\kappa}\n$$\n权重 $w(\\kappa)$ 正比于 $\\mathrm{Tr}\\left[ \\rho(\\kappa) (D_+ \\otimes D_-) \\right]$，其中 $D_\\pm = D(\\hat{\\ell}_\\pm)$。该模型的密度矩阵为 $\\rho(\\kappa) = \\frac{1}{4}(I \\otimes I + \\kappa \\, \\sigma_z \\otimes \\sigma_z)$。由于迹是线性算子且矩阵元是 $\\kappa$ 的光滑函数，我们可以在迹下进行微分：\n$$\n\\frac{\\partial w(\\kappa)}{\\partial \\kappa} \\propto \\frac{\\partial}{\\partial \\kappa} \\mathrm{Tr}\\left[ \\rho(\\kappa) (D_+ \\otimes D_-) \\right] = \\mathrm{Tr}\\left[ \\left(\\frac{\\partial \\rho(\\kappa)}{\\partial \\kappa}\\right) (D_+ \\otimes D_-) \\right]\n$$\n产生密度矩阵的导数为：\n$$\n\\frac{\\partial \\rho(\\kappa)}{\\partial \\kappa} = \\frac{\\partial}{\\partial \\kappa} \\left[ \\frac{1}{4}(I \\otimes I + \\kappa \\, \\sigma_z \\otimes \\sigma_z) \\right] = \\frac{1}{4}(\\sigma_z \\otimes \\sigma_z)\n$$\n将此代入得分表达式中，归一化因子 $1/4$ 会抵消，从而得到一个可计算的得分表达式，形式为两个迹的比值：\n$$\nS_z(\\kappa) = \\frac{\\mathrm{Tr}\\left[ (\\sigma_z \\otimes \\sigma_z) (D(\\hat{\\ell}_+) \\otimes D(\\hat{\\ell}_-)) \\right]}{\\mathrm{Tr}\\left[ (I \\otimes I + \\kappa \\, \\sigma_z \\otimes \\sigma_z) (D(\\hat{\\ell}_+) \\otimes D(\\hat{\\ell}_-)) \\right]}\n$$\n该表达式通过为分子和分母构造相关矩阵并评估其迹来实现。分母本身与权重 $w(\\kappa)$ 成正比。这个完全基于矩阵运算的过程，符合问题的约束条件。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\n# --- Global Definitions ---\n# Define Pauli matrices and Identity as 2x2 complex matrices.\nI = np.eye(2, dtype=complex)\nSIGMA_X = np.array([[0, 1], [1, 0]], dtype=complex)\nSIGMA_Y = np.array([[0, -1j], [1j, 0]], dtype=complex)\nSIGMA_Z = np.array([[1, 0], [0, -1]], dtype=complex)\nSIGMA_VEC = [SIGMA_X, SIGMA_Y, SIGMA_Z]\n\n# --- Helper Functions for Matrix Construction ---\n\ndef get_lepton_vector(theta, phi):\n    \"\"\"Constructs a 3D unit vector from spherical coordinates.\"\"\"\n    lx = np.sin(theta) * np.cos(phi)\n    ly = np.sin(theta) * np.sin(phi)\n    lz = np.cos(theta)\n    return np.array([lx, ly, lz])\n\ndef get_decay_matrix(l_vec):\n    \"\"\"Constructs the decay density matrix D(l) for a lepton vector.\"\"\"\n    # Analyzing power alpha_ell is 1.\n    ell_dot_sigma = l_vec[0] * SIGMA_X + l_vec[1] * SIGMA_Y + l_vec[2] * SIGMA_Z\n    return 0.5 * (I + ell_dot_sigma)\n\ndef get_production_matrix(C_diag):\n    \"\"\"Constructs the production density matrix rho for diagonal correlations.\"\"\"\n    c_xx, c_yy, c_zz = C_diag\n    rho = (np.kron(I, I) +\n           c_xx * np.kron(SIGMA_X, SIGMA_X) +\n           c_yy * np.kron(SIGMA_Y, SIGMA_Y) +\n           c_zz * np.kron(SIGMA_Z, SIGMA_Z))\n    return 0.25 * rho\n\n# --- Core Calculation Functions ---\n\ndef calculate_weight(C_diag, l_plus_angles, l_minus_angles):\n    \"\"\"\n    Calculates the per-event weight w by constructing all matrices from scratch.\n    w ~ Tr[rho * (D_plus x D_minus)]\n    \"\"\"\n    theta_p, phi_p = l_plus_angles\n    theta_m, phi_m = l_minus_angles\n\n    # 1. Construct lepton vectors\n    l_plus_vec = get_lepton_vector(theta_p, phi_p)\n    l_minus_vec = get_lepton_vector(theta_m, phi_m)\n\n    # 2. Construct decay matrices\n    D_plus = get_decay_matrix(l_plus_vec)\n    D_minus = get_decay_matrix(l_minus_vec)\n    D_full = np.kron(D_plus, D_minus)\n\n    # 3. Construct production matrix\n    rho = get_production_matrix(C_diag)\n\n    # 4. Calculate trace of the product\n    weight_matrix = rho @ D_full\n    \n    # Trace should be real; take real part to discard floating-point noise\n    return np.trace(weight_matrix).real\n\ndef calculate_score_z(kappa, l_plus_angles, l_minus_angles):\n    \"\"\"\n    Calculates the per-event score S_z(kappa).\n    S_z(k) = (d/dk Tr[...]) / Tr[...]\n    \"\"\"\n    theta_p, phi_p = l_plus_angles\n    theta_m, phi_m = l_minus_angles\n\n    # Common components for numerator and denominator\n    l_plus_vec = get_lepton_vector(theta_p, phi_p)\n    l_minus_vec = get_lepton_vector(theta_m, phi_m)\n    D_plus = get_decay_matrix(l_plus_vec)\n    D_minus = get_decay_matrix(l_minus_vec)\n    D_full = np.kron(D_plus, D_minus)\n    \n    # --- Numerator calculation: Tr[(d(rho)/dk) * D_full] ---\n    # d(rho)/dk = (1/4) * (sigma_z x sigma_z)\n    d_rho_d_kappa = 0.25 * np.kron(SIGMA_Z, SIGMA_Z)\n    numerator_matrix = d_rho_d_kappa @ D_full\n    numerator = np.trace(numerator_matrix).real\n\n    # --- Denominator calculation: Tr[rho(kappa) * D_full] ---\n    # This is promotional to the weight w(kappa). We can reuse the weight function.\n    # The normalization constant (0.25) is included in both numerator and\n    # denominator calculations, so it cancels perfectly.\n    C_diag_kappa = (0.0, 0.0, kappa)\n    rho_kappa = get_production_matrix(C_diag_kappa)\n    denominator_matrix = rho_kappa @ D_full\n    denominator = np.trace(denominator_matrix).real\n    \n    # Avoid division by zero, though unlikely in physical scenarios\n    if np.isclose(denominator, 0):\n        return np.inf if numerator > 0 else -np.inf if numerator  0 else 0.0\n\n    return numerator / denominator\n\ndef solve():\n    # --- Test Suite Definition ---\n    # Correlation hypotheses\n    H0 = (0.0, 0.0, 0.0)         # Uncorrelated\n    H_z_05 = (0.0, 0.0, 0.5)     # Pure z-axis correlation\n    H_diag = (0.3, -0.2, 0.5)    # General diagonal correlation\n\n    # Events defined by (theta+, phi+, theta-, phi-) in radians\n    events = [\n        (np.pi/3, 0.7, np.pi/6, -1.0),\n        (0.0, 0.0, 0.0, 0.0),\n        (0.0, 2.0, np.pi, -0.3),\n        (np.pi/2, np.pi/4, np.pi/2, 3*np.pi/4),\n    ]\n\n    results = []\n    for event_angles in events:\n        # Unpack angles for the current event\n        plus_angles = event_angles[:2]\n        minus_angles = event_angles[2:]\n        \n        # Calculate weights for the two hypotheses needed for LLRs\n        w0 = calculate_weight(H0, plus_angles, minus_angles)\n        w_z_05 = calculate_weight(H_z_05, plus_angles, minus_angles)\n        w_diag = calculate_weight(H_diag, plus_angles, minus_angles)\n        \n        # 1. R_z,0.5 = ln(L(H_z,0.5)/L(H0))\n        r_z_05 = np.log(w_z_05 / w0)\n\n        # 2. S_z(0)\n        s_z_0 = calculate_score_z(0.0, plus_angles, minus_angles)\n        \n        # 3. R_diag = ln(L(H_diag)/L(H0))\n        r_diag = np.log(w_diag / w0)\n        \n        # 4. S_z(0.2)\n        s_z_02 = calculate_score_z(0.2, plus_angles, minus_angles)\n        \n        results.extend([r_z_05, s_z_0, r_diag, s_z_02])\n\n    # Final print statement in the exact required format.\n    # Using a high precision format string for floating point numbers\n    print(f\"[{','.join(f'{x:.15f}' for x in results)}]\")\n\nsolve()\n```", "id": "3522028"}]}