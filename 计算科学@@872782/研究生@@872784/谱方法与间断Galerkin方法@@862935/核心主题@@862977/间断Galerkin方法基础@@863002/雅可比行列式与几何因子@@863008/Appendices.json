{"hands_on_practices": [{"introduction": "在处理曲线网格的数值方法中，我们通常在一个简单的参考单元上进行计算，然后将结果映射到复杂的物理单元上。雅可比行列式是这一变换的基石，它将一个空间中的无穷小面积（或体积）与另一个空间中对应的部分联系起来。第一个实践练习 [@problem_id:3393863] 要求直接计算给定映射的雅可比行列式，从而加深你对其作为局部面积缩放因子这一关键角色的理解。", "problem": "在高阶谱元法 (SEM) 和间断 Galerkin (DG) 公式中，物理单元上的积分是通过光滑映射从参考单元上拉回计算的。考虑一个二维参考正方形 $[-1,1]^2$，其坐标为 $(\\xi,\\eta)$，以及一个到物理平面的曲线等参映射 $\\boldsymbol{x}(\\xi,\\eta) = \\big(x(\\xi,\\eta),y(\\xi,\\eta)\\big)$，定义为\n$$\nx(\\xi,\\eta) = \\xi + 0.1\\,\\xi\\,\\eta,\\qquad y(\\xi,\\eta) = \\eta + 0.2\\,\\eta^{2}.\n$$\n从第一性原理出发，即曲面积分的变量替换定理和雅可比矩阵作为映射偏导数矩阵的定义，推导该映射的雅可比矩阵行列式 $J(\\xi,\\eta)$。使用你推导的表达式，在点 $(\\xi,\\eta)=(0.5,-0.5)$ 处计算 $J(\\xi,\\eta)$ 及其绝对值 $|J(\\xi,\\eta)|$。简要解释行列式的值，将其视为一个局部面积缩放因子，它将参考空间中的无穷小面积元与其在物理空间中的像联系起来。将你的最终答案表示为 $|J(0.5,-0.5)|$ 的精确值（不要四舍五入）。", "solution": "该问题要求推导给定从参考单元到物理单元映射的雅可比行列式，在特定点处求值，并解释其几何意义。\n\n从正方形 $[-1,1]^2$ 中的参考坐标 $(\\xi, \\eta)$ 到物理坐标 $(x,y)$ 的映射由 $\\boldsymbol{x}(\\xi,\\eta) = \\big(x(\\xi,\\eta), y(\\xi,\\eta)\\big)$ 给出，其分量为：\n$$\nx(\\xi,\\eta) = \\xi + 0.1\\,\\xi\\,\\eta\n$$\n$$\ny(\\xi,\\eta) = \\eta + 0.2\\,\\eta^{2}\n$$\n根据第一性原理，此变换的雅可比矩阵，记为 $\\mathbf{J}(\\xi, \\eta)$，是映射函数所有一阶偏导数的矩阵：\n$$\n\\mathbf{J}(\\xi, \\eta) = \\frac{\\partial(x,y)}{\\partial(\\xi,\\eta)} = \\begin{pmatrix} \\frac{\\partial x}{\\partial \\xi} & \\frac{\\partial x}{\\partial \\eta} \\\\ \\frac{\\partial y}{\\partial \\xi} & \\frac{\\partial y}{\\partial \\eta} \\end{pmatrix}\n$$\n我们计算每个偏导数：\n1.  $\\frac{\\partial x}{\\partial \\xi} = \\frac{\\partial}{\\partial \\xi} (\\xi + 0.1\\,\\xi\\,\\eta) = 1 + 0.1\\,\\eta$\n2.  $\\frac{\\partial x}{\\partial \\eta} = \\frac{\\partial}{\\partial \\eta} (\\xi + 0.1\\,\\xi\\,\\eta) = 0.1\\,\\xi$\n3.  $\\frac{\\partial y}{\\partial \\xi} = \\frac{\\partial}{\\partial \\xi} (\\eta + 0.2\\,\\eta^{2}) = 0$\n4.  $\\frac{\\partial y}{\\partial \\eta} = \\frac{\\partial}{\\partial \\eta} (\\eta + 0.2\\,\\eta^{2}) = 1 + 0.4\\,\\eta$\n\n将这些代入矩阵，得到该映射的雅可比矩阵：\n$$\n\\mathbf{J}(\\xi, \\eta) = \\begin{pmatrix} 1 + 0.1\\,\\eta & 0.1\\,\\xi \\\\ 0 & 1 + 0.4\\,\\eta \\end{pmatrix}\n$$\n雅可比矩阵的行列式，记为 $J(\\xi,\\eta)$，计算如下：\n$$\nJ(\\xi,\\eta) = \\det(\\mathbf{J}(\\xi, \\eta)) = (1 + 0.1\\,\\eta)(1 + 0.4\\,\\eta) - (0.1\\,\\xi)(0)\n$$\n因此，雅可比行列式的表达式为：\n$$\nJ(\\xi,\\eta) = (1 + 0.1\\,\\eta)(1 + 0.4\\,\\eta)\n$$\n接下来，我们在指定点 $(\\xi, \\eta) = (0.5, -0.5)$ 处计算该行列式。\n代入 $\\xi = 0.5$ 和 $\\eta = -0.5$：\n$$\nJ(0.5, -0.5) = \\big(1 + 0.1 \\times (-0.5)\\big) \\big(1 + 0.4 \\times (-0.5)\\big)\n$$\n$$\nJ(0.5, -0.5) = (1 - 0.05)(1 - 0.20)\n$$\n$$\nJ(0.5, -0.5) = (0.95)(0.80)\n$$\n为了求精确值，我们可以使用分数：$0.95 = \\frac{95}{100} = \\frac{19}{20}$ 和 $0.80 = \\frac{80}{100} = \\frac{4}{5}$。\n$$\nJ(0.5, -0.5) = \\left(\\frac{19}{20}\\right) \\left(\\frac{4}{5}\\right) = \\frac{19 \\times 4}{20 \\times 5} = \\frac{19}{5 \\times 5} = \\frac{19}{25}\n$$\n这个精确值也可以表示为小数 $0.76$。\n在该点雅可比行列式的值为 $J(0.5,-0.5) = 0.76$。\n绝对值为 $|J(0.5, -0.5)| = |0.76| = 0.76$。\n\n雅可比行列式的解释来自于多重积分的变量替换定理。参考空间中的无穷小面积元 $dA_{ref} = d\\xi\\,d\\eta$ 被映射到物理空间中的无穷小面积元 $dA_{phys} = dx\\,dy$，它们的面积关系为：\n$$\ndA_{phys} = |J(\\xi,\\eta)| \\, dA_{ref}\n$$\n因此，值 $|J(\\xi,\\eta)|$ 是局部面积缩放因子。在点 $(\\xi, \\eta) = (0.5, -0.5)$ 处，其值为 $|J| = 0.76$。这意味着在该点周围的参考空间中的无穷小面积被变换为物理空间中大小为其 $0.76$ 倍的面积。由于 $|J| < 1$，该映射是面积的局部压缩。$J = 0.76$ 的符号为正，这表明该映射在该点是保向的。", "answer": "$$\n\\boxed{\\frac{19}{25}}\n$$", "id": "3393863"}, {"introduction": "尽管雅可比行列式实现了坐标变换，但在数值格式中其离散表示需要格外小心。对于移动或曲线网格上的任何数值格式，一个基本要求是满足几何守恒律 (Geometric Conservation Law, GCL)，它确保均匀流场在计算后仍保持均匀。本练习 [@problem_id:3393877] 将揭示违反该定律的后果：通过对度量张量采用一种看似合理但不一致的近似，你将分析证明即使对于一个常数解，该格式也会产生伪残差 (spurious residuals)。", "problem": "考虑在参考正方形 $\\hat{\\Omega} = [-1,1] \\times [-1,1]$ 上的二维节点谱元离散，其采用多项式次数为 $N=2$ 的张量积 Gauss–Lobatto–Legendre (GLL) 网格。每个坐标方向上的节点为 $s \\in \\{-1,0,1\\}$ 和 $r \\in \\{-1,0,1\\}$，相应的一维 GLL 微分矩阵为\n$$\nD \\;=\\;\n\\begin{pmatrix}\n-\\tfrac{3}{2} & 2 & -\\tfrac{1}{2} \\\\[4pt]\n-\\tfrac{1}{2} & 0 & \\tfrac{1}{2} \\\\[4pt]\n\\tfrac{1}{2} & -2 & \\tfrac{3}{2}\n\\end{pmatrix}.\n$$\n设从参考坐标 $(r,s)$ 到物理坐标 $(x,y)$ 的曲线映射为\n$$\nx(r,s) \\;=\\; r \\;+\\; r\\,s^{2}, \n\\qquad\ny(r,s) \\;=\\; s.\n$$\n采用标准协变基向量 $\\mathbf{a}_{r} = \\partial \\mathbf{x}/\\partial r$ 和 $\\mathbf{a}_{s} = \\partial \\mathbf{x}/\\partial s$、雅可比行列式 $J = \\det[\\mathbf{a}_{r}\\ \\mathbf{a}_{s}]$，以及由协变基向量的平面 $90^{\\circ}$ 旋转定义的逆变度量向量 $J\\,\\mathbf{a}^{r}$ 和 $J\\,\\mathbf{a}^{s}$：\n$$\nJ\\,\\mathbf{a}^{r} \\;=\\; \\big(a_{s,y},\\,-a_{s,x}\\big),\n\\qquad\nJ\\,\\mathbf{a}^{s} \\;=\\; \\big(-a_{r,y},\\,a_{r,x}\\big),\n$$\n其中 $\\mathbf{a}_{r}=(a_{r,x},a_{r,y})$ 且 $\\mathbf{a}_{s}=(a_{s,x},a_{s,y})$。对于此映射，逆变度量向量的精确 $y$ 分量为\n$$\nG^{r}_{y}(r,s) \\;=\\; -\\,2\\,r\\,s,\n\\qquad\nG^{s}_{y}(r,s) \\;=\\; 1 \\;+\\; s^{2}.\n$$\n它们满足连续度量恒等式 $\\partial_{r} G^{r}_{y} + \\partial_{s} G^{s}_{y} = 0$。\n\n现在，通过仅使用端点节点 $s=\\pm 1$ 在 $s$ 方向上进行一次插值来定义 $J\\,\\mathbf{a}^{s}$ 的 $y$ 分量，从而构造一个违反度量恒等式的离散度量近似：\n$$\n\\tilde{G}^{s}_{y}(r,s) \\;:=\\; I_{1}\\big[\\,1+s^{2}\\,\\big](s)\n\\;=\\; \\tfrac{1+s}{2}\\big(1+1^{2}\\big) \\;+\\; \\tfrac{1-s}{2}\\big(1+(-1)^{2}\\big)\n\\;=\\; 2,\n$$\n使得 $\\tilde{G}^{s}_{y}$ 在 $s$ 方向上为常数。在节点上保持 $G^{r}_{y}$ 为精确值。\n\n考虑一个常数解 $u(r,s)\\equiv u_{0}$ 在恒定的物理平流速度 $\\mathbf{a}=(0,1)$ 下的映射线性平流问题。在强形式下，节点 $(r_{i},s_{j})$ 处的半离散体积残差是通过将张量积微分算子应用于映射后的逆变通量分量来计算的\n$$\n\\phi^{r}(r_{i},s_{j}) \\;=\\; u_{0}\\,G^{r}_{y}(r_{i},s_{j}), \n\\qquad\n\\phi^{s}(r_{i},s_{j}) \\;=\\; u_{0}\\,\\tilde{G}^{s}_{y}(r_{i},s_{j}),\n$$\n即\n$$\n\\mathcal{R}_{ij} \\;=\\; \\sum_{k=1}^{3} D_{ik}\\,\\phi^{r}(r_{k},s_{j}) \\;+\\; \\sum_{\\ell=1}^{3} D_{j\\ell}\\,\\phi^{s}(r_{i},s_{\\ell}).\n$$\n\n使用 $u_{0}=1$，计算节点 $(r_{i},s_{j})=(0,1)$ 处的半离散体积残差 $\\mathcal{R}_{ij}$。以单个实数形式给出最终答案，无需四舍五入。", "solution": "该问题是有效的。其设定是自洽的，在偏微分方程数值分析领域内是科学合理的，并且是适定的。计算所需的所有必要数据和定义均已提供。\n\n目标是计算节点 $(r_{i},s_{j})=(0,1)$ 处的半离散体积残差 $\\mathcal{R}_{ij}$。对于多项式次数 $N=2$，节点网格点为 $r, s \\in \\{-1, 0, 1\\}$。我们可以将其索引为 $r_1=-1, r_2=0, r_3=1$ 以及 $s_1=-1, s_2=0, s_3=1$。因此，目标节点 $(r,s)=(0,1)$ 对应的索引为 $(i,j)=(2,3)$。\n\n节点 $(r_i, s_j)$ 处的半离散体积残差公式为：\n$$\n\\mathcal{R}_{ij} \\;=\\; \\sum_{k=1}^{3} D_{ik}\\,\\phi^{r}(r_{k},s_{j}) \\;+\\; \\sum_{\\ell=1}^{3} D_{j\\ell}\\,\\phi^{s}(r_{i},s_{\\ell})\n$$\n我们需要计算 $(i,j)=(2,3)$ 时的情况：\n$$\n\\mathcal{R}_{23} \\;=\\; \\sum_{k=1}^{3} D_{2k}\\,\\phi^{r}(r_{k},s_{3}) \\;+\\; \\sum_{\\ell=1}^{3} D_{3\\ell}\\,\\phi^{s}(r_{2},s_{\\ell})\n$$\n计算分为两个部分。\n\n第 1 部分：$r$ 方向的导数。\n该项是第一个求和：$\\sum_{k=1}^{3} D_{2k}\\,\\phi^{r}(r_{k},s_{3})$。这对应于将微分矩阵 $D$ 的第二行应用于在 $s=s_3=1$ 这条线上计算的通量值向量 $\\phi^r$。\n微分矩阵 $D$ 的第二行由 $(D_{21}, D_{22}, D_{23}) = (-\\frac{1}{2}, 0, \\frac{1}{2})$ 给出。\n逆变通量分量 $\\phi^r$ 定义为 $\\phi^{r}(r,s) = u_{0}\\,G^{r}_{y}(r,s)$。当 $u_0=1$ 且精确度量分量为 $G^{r}_{y}(r,s) = -2rs$ 时，通量变为 $\\phi^{r}(r,s) = -2rs$。\n我们在 $s_j=s_3=1$ 处对每个 $r$ 节点 $r_k \\in \\{-1, 0, 1\\}$ 计算此通量：\n\\begin{itemize}\n    \\item 对于 $k=1, r_1=-1$：$\\phi^{r}(r_{1},s_{3}) = \\phi^{r}(-1,1) = -2(-1)(1) = 2$。\n    \\item 对于 $k=2, r_2=0$：$\\phi^{r}(r_{2},s_{3}) = \\phi^{r}(0,1) = -2(0)(1) = 0$。\n    \\item 对于 $k=3, r_3=1$：$\\phi^{r}(r_{3},s_{3}) = \\phi^{r}(1,1) = -2(1)(1) = -2$。\n\\end{itemize}\n残差的第一项是 $D$ 的第二行与通量值向量 $(\\phi^{r}(-1,1), \\phi^{r}(0,1), \\phi^{r}(1,1))$ 的点积：\n$$\n\\sum_{k=1}^{3} D_{2k}\\,\\phi^{r}(r_{k},s_{3}) = D_{21}\\phi^{r}(r_1,s_3) + D_{22}\\phi^{r}(r_2,s_3) + D_{23}\\phi^{r}(r_3,s_3)\n= \\left(-\\frac{1}{2}\\right)(2) \\;+\\; (0)(0) \\;+\\; \\left(\\frac{1}{2}\\right)(-2) = -1 - 1 = -2.\n$$\n\n第 2 部分：$s$ 方向的导数。\n该项是第二个求和：$\\sum_{\\ell=1}^{3} D_{3\\ell}\\,\\phi^{s}(r_{2},s_{\\ell})$。这对应于将微分矩阵 $D$ 的第三行应用于在 $r=r_2=0$ 这条线上计算的通量值向量 $\\phi^s$。\n微分矩阵 $D$ 的第三行由 $(D_{31}, D_{32}, D_{33}) = (\\frac{1}{2}, -2, \\frac{3}{2})$ 给出。\n逆变通量分量 $\\phi^s$ 使用近似度量定义，即 $\\phi^{s}(r,s) = u_{0}\\,\\tilde{G}^{s}_{y}(r,s)$。当 $u_0=1$ 且给定的近似为 $\\tilde{G}^{s}_{y}(r,s) = 2$ 时，通量变为 $\\phi^{s}(r,s) = 2$。\n该通量为常数。我们在 $r_i=r_2=0$ 处对每个 $s$ 节点 $s_\\ell \\in \\{-1, 0, 1\\}$ 计算此通量：\n\\begin{itemize}\n    \\item 对于 $\\ell=1, s_1=-1$：$\\phi^{s}(r_{2},s_{1}) = \\phi^{s}(0,-1) = 2$。\n    \\item 对于 $\\ell=2, s_2=0$：$\\phi^{s}(r_{2},s_{2}) = \\phi^{s}(0,0) = 2$。\n    \\item 对于 $\\ell=3, s_3=1$：$\\phi^{s}(r_{2},s_{3}) = \\phi^{s}(0,1) = 2$。\n\\end{itemize}\n残差的第二项是 $D$ 的第三行与通量值向量 $(\\phi^{s}(0,-1), \\phi^{s}(0,0), \\phi^{s}(0,1))$ 的点积：\n$$\n\\sum_{\\ell=1}^{3} D_{3\\ell}\\,\\phi^{s}(r_{2},s_{\\ell}) = D_{31}\\phi^{s}(r_2,s_1) + D_{32}\\phi^{s}(r_2,s_2) + D_{33}\\phi^{s}(r_2,s_3)\n= \\left(\\frac{1}{2}\\right)(2) \\;+\\; (-2)(2) \\;+\\; \\left(\\frac{3}{2}\\right)(2) = 1 - 4 + 3 = 0.\n$$\n这个结果是符合预期的，因为用一个相容的离散算子对常数函数进行微分会得到零。GLL 微分矩阵任意一行的元素之和为零，这保证了这一性质。\n\n最后，我们将两部分相加得到总残差 $\\mathcal{R}_{23}$：\n$$\n\\mathcal{R}_{23} = (-2) + (0) = -2.\n$$\n非零残差表明，所选的度量因子离散近似违反了离散几何守恒律 (GCL)，即使对于常数解，也会导致伪源项的产生。", "answer": "$$\\boxed{-2}$$", "id": "3393877"}, {"introduction": "为了解决先前练习中凸显的问题，我们必须构造能够内在地满足几何守恒律的离散度量张量。“守恒旋度形式” (conservative curl formulation) 是一种标准而巧妙的技术，它能确保度量张量离散导数的和恒等于零。在最后一个动手实践 [@problem_id:3393941] 中，你将通过编程实现这一公式，并数值验证该方法能够将一个恒定的平流场（即“自由流”）保持到机器精度，从而证实几何守恒律得到了满足。", "problem": "考虑一个通过从具有坐标 $\\xi,\\eta \\in [-1,1]$ 的参考正方形进行光滑映射得到的单一曲线四边形单元。设映射由 $\\boldsymbol{X}(\\xi,\\eta)=(x(\\xi,\\eta),y(\\xi,\\eta))$ 给出。协变基向量定义为 $\\boldsymbol{a}_{\\xi} = \\partial \\boldsymbol{X}/\\partial \\xi$ 和 $\\boldsymbol{a}_{\\eta} = \\partial \\boldsymbol{X}/\\partial \\eta$，雅可比行列式为 $J = \\det \\begin{pmatrix} \\partial x/\\partial \\xi  \\partial x/\\partial \\eta \\\\ \\partial y/\\partial \\xi  \\partial y/\\partial \\eta \\end{pmatrix}$。需要使用离散守恒旋度格式构造逆变度量向量 $J \\boldsymbol{a}^{\\xi}$ 和 $J \\boldsymbol{a}^{\\eta}$，使得离散度量恒等式 $\\partial (J \\boldsymbol{a}^{\\xi})/\\partial \\xi + \\partial (J \\boldsymbol{a}^{\\eta})/\\partial \\eta = \\boldsymbol{0}$ 在离散层面精确成立。\n\n您将在这个单一映射单元上，使用多项式阶数 $N=4$（因此每个坐标方向有 $N+1=5$ 个节点）的 Gauss–Lobatto–Legendre 节点上的张量积谱元法，来离散化守恒形式的常系数线性平流方程。在每个坐标方向上，使用基于 Gauss–Lobatto–Legendre 节点上的重心坐标公式构建的强形式分部求和离散导数。角度必须以弧度为单位进行解释。\n\n从协变和逆变基以及雅可比的基本定义出发，推导二维情况下逆变度量向量的离散守恒旋度构造，并用它来组装在常数标量场 $q(\\xi,\\eta) \\equiv 1$ 和恒定物理速度 $\\boldsymbol{u}=(u_x,u_y)$（其中 $u_x=1.3$，$u_y=-0.7$）下的映射平流通量。证明由于离散度量恒等式，半离散残差（映射通量的离散散度）在机器精度下为零。\n\n在您的程序中实现以下细节：\n- 通过求 $N$ 阶 Legendre 多项式导数的根并包含端点 $\\xi=\\pm 1$，构造 $N=4$ 的一维 Gauss–Lobatto–Legendre 节点。\n- 使用这些节点的重心权重构建一维的一阶导数矩阵。在二维中，沿 $\\xi$ 方向应用导数时，将一维导数矩阵沿第一轴进行左乘；沿 $\\eta$ 方向应用导数时，将一维导数矩阵的转置沿第二轴进行右乘。\n- 使用离散守恒旋度构造，从映射 $\\boldsymbol{X}(\\xi,\\eta)$ 计算逆变度量向量 $J \\boldsymbol{a}^{\\xi}$ 和 $J \\boldsymbol{a}^{\\eta}$。\n- 组装映射通量分量 $F^{\\xi} = (J \\boldsymbol{a}^{\\xi} \\cdot \\boldsymbol{u}) q$ 和 $F^{\\eta} = (J \\boldsymbol{a}^{\\eta} \\cdot \\boldsymbol{u}) q$，并通过如上所述沿各轴应用一维导数矩阵，计算 Gauss–Lobatto–Legendre 节点上的半离散残差 $R = -\\left(\\partial F^{\\xi}/\\partial \\xi + \\partial F^{\\eta}/\\partial \\eta\\right)$。不要添加任何边界面项；因为 $q$ 是常数，且对于相等状态，数值通量与物理通量一致，所以边界贡献为零。\n\n测试套件：\n- 使用形式为\n  $$\n  x(\\xi,\\eta) = \\xi + \\frac{\\alpha}{4}\\sin(\\pi \\xi)\\sin(\\pi \\eta), \\quad\n  y(\\xi,\\eta) = \\eta + \\frac{\\alpha}{4}\\sin(\\pi \\xi)\\sin(\\pi \\eta),\n  $$\n  的三个映射，参数为 $\\alpha \\in \\{0.0,\\,0.2,\\,0.45\\}$。对于每个 $\\alpha$，计算在 $5 \\times 5$ Gauss–Lobatto–Legendre 节点的张量网格上残差 $R$ 的上确界范数，即 $\\max_{i,j} |R(\\xi_i,\\eta_j)|$。\n- 所有三角函数的参数必须以弧度为单位进行解释。\n\n要求的最终输出格式：\n- 您的程序应生成单行输出，其中包含对应于三种 $\\alpha$ 选择的三个残差上确界范数，形式为用方括号括起来的逗号分隔列表（例如，“[r0,r1,r2]”）。每个条目必须是浮点数。\n\n您的目标是数值验证，当度量项通过在 $N=4$ 的 Gauss–Lobatto 网格上使用守恒旋度格式构造时，自由流 $q \\equiv 1$ 在平流问题中能在机器精度下被保持。", "solution": "该问题要求使用谱元法，对在曲线单元上离散化的常系数平流方程的自由流保持特性进行数值验证。这一特性对于确保数值格式在流动均匀的区域不产生伪解至关重要。这种保持特性是通过以满足连续几何恒等式的离散模拟的方式构造几何度量项来实现的。\n\n设物理域由坐标 $(x,y)$ 参数化，参考单元（一个正方形）由逻辑坐标 $(\\xi, \\eta)$ 参数化，其中 $\\xi, \\eta \\in [-1, 1]$。映射由 $\\boldsymbol{X}(\\xi,\\eta) = (x(\\xi,\\eta), y(\\xi,\\eta))$ 给出。对于一个量 $q$ 和一个恒定速度场 $\\boldsymbol{u} = (u_x, u_y)$，其标量平流方程的守恒形式为：\n$$\n\\frac{\\partial q}{\\partial t} + \\nabla_x \\cdot (\\boldsymbol{u} q) = 0\n$$\n其中 $\\nabla_x$ 是物理坐标中的散度算子。为了在参考单元上求解此方程，我们对其进行变换。利用链式法则和映射的雅可比矩阵的性质，方程在逻辑坐标下变为：\n$$\n\\frac{\\partial (J q)}{\\partial t} + \\frac{\\partial (F^\\xi q)}{\\partial \\xi} + \\frac{\\partial (F^\\eta q)}{\\partial \\eta} = 0\n$$\n这里，$J$ 是映射的雅可比矩阵 $\\boldsymbol{A} = \\frac{\\partial(x,y)}{\\partial(\\xi,\\eta)}$ 的行列式。项 $F^\\xi$ 和 $F^\\eta$ 是逆变通量的分量，定义为：\n$$\nF^\\xi = (J \\boldsymbol{a}^\\xi) \\cdot \\boldsymbol{u} \\quad \\text{and} \\quad F^\\eta = (J \\boldsymbol{a}^\\eta) \\cdot \\boldsymbol{u}\n$$\n其中 $\\boldsymbol{a}^\\xi$ 和 $\\boldsymbol{a}^\\eta$ 是逆变基向量。缩放后的逆变基向量 $J\\boldsymbol{a}^\\xi$ 和 $J\\boldsymbol{a}^\\eta$ 是编码了通量变换的几何因子。它们可以用映射坐标的偏导数表示：\n$$\nJ \\boldsymbol{a}^\\xi = \\begin{pmatrix} \\partial y / \\partial \\eta \\\\ -\\partial x / \\partial \\eta \\end{pmatrix}, \\quad J \\boldsymbol{a}^\\eta = \\begin{pmatrix} -\\partial y / \\partial \\xi \\\\ \\partial x / \\partial \\xi \\end{pmatrix}\n$$\n这些连续解析因子的一个关键性质是几何守恒律，或称度量恒等式：\n$$\n\\frac{\\partial (J \\boldsymbol{a}^\\xi)}{\\partial \\xi} + \\frac{\\partial (J \\boldsymbol{a}^\\eta)}{\\partial \\eta} = \\frac{\\partial}{\\partial \\xi} \\begin{pmatrix} \\frac{\\partial y}{\\partial \\eta} \\\\ -\\frac{\\partial x}{\\partial \\eta} \\end{pmatrix} + \\frac{\\partial}{\\partial \\eta} \\begin{pmatrix} -\\frac{\\partial y}{\\partial \\xi} \\\\ \\frac{\\partial x}{\\partial \\xi} \\end{pmatrix} = \\begin{pmatrix} \\frac{\\partial^2 y}{\\partial \\xi \\partial \\eta} - \\frac{\\partial^2 y}{\\partial \\eta \\partial \\xi} \\\\ -\\frac{\\partial^2 x}{\\partial \\xi \\partial \\eta} + \\frac{\\partial^2 x}{\\partial \\eta \\partial \\xi} \\end{pmatrix} = \\boldsymbol{0}\n$$\n由于混合偏导数的相等性（Clairaut 定理），只要映射足够光滑，该恒等式就成立。\n\n对于常数场 $q(\\xi, \\eta) \\equiv 1$ 和恒定速度 $\\boldsymbol{u}$，空间算子的半离散残差 $R$ 为：\n$$\nR = -\\left( \\frac{\\partial F^\\xi}{\\partial \\xi} + \\frac{\\partial F^\\eta}{\\partial \\eta} \\right) = -\\left( \\frac{\\partial ((J \\boldsymbol{a}^\\xi) \\cdot \\boldsymbol{u})}{\\partial \\xi} + \\frac{\\partial ((J \\boldsymbol{a}^\\eta) \\cdot \\boldsymbol{u})}{\\partial \\eta} \\right)\n$$\n由于 $\\boldsymbol{u}$ 是常数，它可以从导数中提出：\n$$\nR = -\\boldsymbol{u} \\cdot \\left( \\frac{\\partial (J \\boldsymbol{a}^\\xi)}{\\partial \\xi} + \\frac{\\partial (J \\boldsymbol{a}^\\eta)}{\\partial \\eta} \\right) = - \\boldsymbol{u} \\cdot \\boldsymbol{0} = 0\n$$\n因此，在连续层面上，常数解被完美保持。为了使数值格式能够复制这一点，离散算子必须满足度量恒等式的离散模拟。\n\n我们使用多项式阶数 $N=4$ 的 $(N+1) \\times (N+1)$ Gauss-Lobatto-Legendre (GLL) 节点的张量积网格来离散化该区域。设 $X$ 和 $Y$ 是包含节点 $x$ 和 $y$ 坐标的矩阵。设 $D$ 是与 GLL 节点对应的 $(N+1) \\times (N+1)$ 一维微分矩阵。关于 $\\xi$ 的离散微分通过左乘 $D$ 来执行，关于 $\\eta$ 的离散微分通过右乘 $D^T$ 来执行。\n\n“离散守恒旋度格式”通过直接将 $J\\boldsymbol{a}^\\xi$ 和 $J\\boldsymbol{a}^\\eta$ 表达式中的偏导数替换为其离散对应物来定义离散度量因子：\n$$\n\\widetilde{(J \\boldsymbol{a}^\\xi)}_x = Y D^T, \\quad \\widetilde{(J \\boldsymbol{a}^\\xi)}_y = -X D^T\n$$\n$$\n\\widetilde{(J \\boldsymbol{a}^\\eta)}_x = -D Y, \\quad \\widetilde{(J \\boldsymbol{a}^\\eta)}_y = D X\n$$\n其中波浪号表示一个离散量。现在我们检查离散度量恒等式是否成立：\n$$\n\\frac{\\partial \\widetilde{(J \\boldsymbol{a}^\\xi)}}{\\partial \\xi} + \\frac{\\partial \\widetilde{(J \\boldsymbol{a}^\\eta)}}{\\partial \\eta} \\stackrel{?}{=} \\boldsymbol{0}\n$$\n$x$ 分量左侧的离散形式是 $D \\widetilde{(J \\boldsymbol{a}^\\xi)}_x + \\widetilde{(J \\boldsymbol{a}^\\eta)}_x D^T$。代入定义：\n$$\nD (Y D^T) + (-D Y) D^T = D Y D^T - D Y D^T = \\boldsymbol{0}\n$$\n对于 $y$ 分量：$D \\widetilde{(J \\boldsymbol{a}^\\xi)}_y + \\widetilde{(J \\boldsymbol{a}^\\eta)}_y D^T$：\n$$\nD (-X D^T) + (D X) D^T = -D X D^T + D X D^T = \\boldsymbol{0}\n$$\n由于矩阵乘法的结合律，这两个恒等式在矩阵级别上都精确成立。这证明了离散度量恒等式是通过构造得到满足的。\n\n对于 $q=1$ 和恒定速度 $\\boldsymbol{u}=(u_x, u_y)$，离散残差 $R$ 计算如下：\n$$\nR = -\\left( D F^\\xi + F^\\eta D^T \\right)\n$$\n其中 $F^\\xi = u_x \\widetilde{(J \\boldsymbol{a}^\\xi)}_x + u_y \\widetilde{(J \\boldsymbol{a}^\\xi)}_y$ 和 $F^\\eta = u_x \\widetilde{(J \\boldsymbol{a}^\\eta)}_x + u_y \\widetilde{(J \\boldsymbol{a}^\\eta)}_y$ 是离散通量分量矩阵。将这些代入残差表达式：\n$$\nR = -\\left( D(u_x Y D^T - u_y X D^T) + (-u_x D Y + u_y D X)D^T \\right)\n$$\n由于 $u_x$ 和 $u_y$ 是标量，它们可以与矩阵运算交换位置：\n$$\nR = -u_x(D Y D^T - D Y D^T) - u_y(-D X D^T + D X D^T) = \\boldsymbol{0}\n$$\n残差矩阵恒等于零矩阵。因此，数值实现应产生一个量级为机器浮点精度的残差范数，从而证实自由流保持特性。\n\n数值实现过程如下：\n1.  设置多项式阶数 $N=4$。\n2.  计算 $N+1=5$ 个 Gauss-Lobatto-Legendre 节点 $\\xi_i \\in [-1,1]$。这些节点是端点 $\\pm 1$ 以及 Legendre 多项式 $P_4(\\xi)$ 导数的根。\n3.  构造 $5 \\times 5$ 微分矩阵 $D$，其中 $D_{ij} = L'_j(\\xi_i)$，$L_j$ 是第 $j$ 个 Lagrange 基多项式。这是使用 GLL 节点的标准重心坐标公式构建的。\n4.  对于每个给定的参数 $\\alpha \\in \\{0.0, 0.2, 0.45\\}$：\n    a. 形成一个 $5 \\times 5$ 的节点张量网格 $(\\xi_i, \\eta_j)$。\n    b. 在这些网格点上评估映射函数 $x(\\xi, \\eta)$ 和 $y(\\xi, \\eta)$，以获得坐标矩阵 $X$ 和 $Y$。\n    c. 使用守恒旋度格式计算四个离散度量因子矩阵：$\\widetilde{(J \\boldsymbol{a}^\\xi)}_x, \\widetilde{(J \\boldsymbol{a}^\\xi)}_y, \\widetilde{(J \\boldsymbol{a}^\\eta)}_x, \\widetilde{(J \\boldsymbol{a}^\\eta)}_y$。\n    d. 使用恒定速度 $\\boldsymbol{u}=(1.3, -0.7)$ 组装通量矩阵 $F^\\xi$ 和 $F^\\eta$。\n    e. 计算残差矩阵 $R = -(D F^\\xi + F^\\eta D^T)$。\n    f. 计算 $R$ 元素上确界范数（最大绝对值）。\n5.  报告计算出的三个范数。", "answer": "```python\nimport numpy as np\nfrom scipy.special import legendre, roots_jacobi\n\ndef get_gll_and_diff_matrix(N):\n    \"\"\"\n    Computes Gauss-Lobatto-Legendre (GLL) nodes and the corresponding \n    first-derivative matrix for a given polynomial degree N.\n\n    Args:\n        N (int): The polynomial degree.\n\n    Returns:\n        tuple[np.ndarray, np.ndarray]: A tuple containing:\n            - nodes (np.ndarray): The N+1 GLL nodes.\n            - D (np.ndarray): The (N+1)x(N+1) differentiation matrix.\n    \"\"\"\n    if N == 0:\n        return np.array([0.0]), np.array([[0.0]])\n    \n    # GLL nodes: endpoints and roots of P_N'(x)\n    # The interior nodes are the roots of the Jacobi polynomial P_{N-1}^{(1,1)}(x)\n    if N > 1:\n        interior_nodes = roots_jacobi(N - 1, 1, 1)[0]\n    else: # N=1\n        interior_nodes = np.array([])\n    \n    nodes = np.concatenate(([-1.0], interior_nodes, [1.0]))\n    nodes.sort()\n    \n    n_pts = N + 1\n    D = np.zeros((n_pts, n_pts))\n\n    # Use the explicit formula for the GLL differentiation matrix, which is a\n    # specific case of a barycentric formula.\n    # D_ij = P_N(xi_i) / (P_N(xi_j) * (xi_i - xi_j)) for i != j\n    # Diagonal elements have specific values for GLL nodes.\n    PN = legendre(N)\n    p_vals_at_nodes = PN(nodes)\n\n    for i in range(n_pts):\n        for j in range(n_pts):\n            if i != j:\n                D[i, j] = p_vals_at_nodes[i] / (p_vals_at_nodes[j] * (nodes[i] - nodes[j]))\n    \n    D[0, 0] = -N * (N + 1) / 4.0\n    D[n_pts - 1, n_pts - 1] = N * (N + 1) / 4.0\n    \n    # For N>1, interior diagonal elements are 0. They are already 0 from initialization.\n\n    return nodes, D\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem.\n    It verifies free-stream preservation for a spectral element method\n    by computing the residual for a constant state on a mapped element.\n    \"\"\"\n    # Problem parameters\n    N = 4 # Polynomial degree\n    u_vec = np.array([1.3, -0.7]) # Constant velocity field (u_x, u_y)\n    \n    # Test cases for the mapping parameter alpha\n    test_cases = [0.0, 0.2, 0.45]\n    results = []\n\n    # 1. Compute 1D GLL nodes and differentiation matrix\n    nodes, D = get_gll_and_diff_matrix(N)\n    \n    # 2. Create the 2D tensor-product grid in the reference element\n    xi_mesh, eta_mesh = np.meshgrid(nodes, nodes)\n    \n    for alpha in test_cases:\n        # 3. Evaluate the mapping to get physical coordinates\n        # x(xi,eta) = xi + (alpha/4)*sin(pi*xi)*sin(pi*eta)\n        # y(xi,eta) = eta + (alpha/4)*sin(pi*xi)*sin(pi*eta)\n        common_term = (alpha / 4.0) * np.sin(np.pi * xi_mesh) * np.sin(np.pi * eta_mesh)\n        X = xi_mesh + common_term\n        Y = eta_mesh + common_term\n    \n        # 4. Compute discrete metric factors using the conservative curl formulation\n        # Metric factors are matrices of size (N+1)x(N+1)\n        # (J a^xi)_x = dy/deta  ~ Y @ D.T\n        # (J a^xi)_y = -dx/deta ~ -X @ D.T\n        # (J a^eta)_x = -dy/dxi ~ -D @ Y\n        # (J a^eta)_y = dx/dxi  ~ D @ X\n        Ja_x_xi = Y @ D.T\n        Ja_y_xi = -X @ D.T\n        Ja_x_eta = -D @ Y\n        Ja_y_eta = D @ X\n\n        # 5. Assemble the mapped flux components for q=1\n        # F^xi = u_x * (J a^xi)_x + u_y * (J a^xi)_y\n        # F^eta = u_x * (J a^eta)_x + u_y * (J a^eta)_y\n        F_xi = u_vec[0] * Ja_x_xi + u_vec[1] * Ja_y_xi\n        F_eta = u_vec[0] * Ja_x_eta + u_vec[1] * Ja_y_eta\n\n        # 6. Compute the semi-discrete residual\n        # R = -(d(F^xi)/dxi + d(F^eta)/deta)\n        #   ~ -(D @ F_xi + F_eta @ D.T)\n        R = -(D @ F_xi + F_eta @ D.T)\n\n        # 7. Compute the supremum norm of the residual matrix\n        residual_norm = np.max(np.abs(R))\n        results.append(residual_norm)\n\n    # Final print statement in the exact required format\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```", "id": "3393941"}]}