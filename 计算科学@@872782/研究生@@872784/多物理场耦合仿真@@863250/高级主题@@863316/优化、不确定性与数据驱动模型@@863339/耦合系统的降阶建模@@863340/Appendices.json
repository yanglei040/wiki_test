{"hands_on_practices": [{"introduction": "在耦合系统的分区求解策略中，子系统通过共享界面进行信息交换。因此，界面的精确表示对于整个模型的保真度至关重要。一种生成最优界面基的常用技术是对界面传递算子（例如，从界面力到界面位移的映射）进行奇异值分解（SVD）。该练习将引导您从第一性原理出发，推导当使用由SVD生成的最优基进行降阶时，由于基截断所引入的最坏情况误差[@problem_id:3524751]。理解这一误差界限对于在模型精度和计算成本之间做出明智的权衡至关重要。", "problem": "考虑一个线性时不变（LTI）的分区多物理场系统，其包含两个通过一个界面耦合的子系统，其中子系统 $\\mathcal{A}$ 在局部由一个线性传递算子 $T \\in \\mathbb{R}^{m \\times p}$ 表征，该算子通过 $y = T g$ 将界面数据（例如，广义界面力）$g \\in \\mathbb{R}^{p}$ 映射到子系统界面响应（例如，广义界面位移）$y \\in \\mathbb{R}^{m}$。假设 $T$ 是有界的，并且源于在标准界面条件下对一个强制椭圆或抛物边界值问题的适定离散化，因此对于物理上容许的 $g$，该映射是线性和稳定的。在一个分区降阶建模（ROM）框架中，子系统 $\\mathcal{A}$ 的界面模态由奇异值分解（SVD）构造，即奇异值分解（SVD）$T = U \\Sigma V^{\\top}$，其中 $U \\in \\mathbb{R}^{m \\times m}$ 和 $V \\in \\mathbb{R}^{p \\times p}$ 是正交的，$\\Sigma \\in \\mathbb{R}^{m \\times p}$ 在其对角线上包含奇异值 $\\sigma_{1} \\geq \\sigma_{2} \\geq \\cdots \\geq \\sigma_{q} \\geq 0$，其中 $q = \\min\\{m,p\\}$。定义ROM界面基为前 $r$ 个左奇异向量 $U_{r} \\in \\mathbb{R}^{m \\times r}$，并通过正交投影 $y_{r} = U_{r} U_{r}^{\\top} y$ 来近似完整的界面响应。\n\n仅使用线性算子、正交投影和奇异值分解的基本性质，推导因将界面基截断至维度 $r$ 而引起的最坏情况界面匹配误差，该误差以算子诱导的残差衡量\n$$\nE_{r}^{\\star} \\equiv \\sup_{\\|g\\|_{2} = 1} \\left\\| y - y_{r} \\right\\|_{2} = \\sup_{\\|g\\|_{2} = 1} \\left\\| (I - U_{r} U_{r}^{\\top}) T g \\right\\|_{2}.\n$$\n将最终答案表示为关于 $T$ 的奇异值的单个闭式解析表达式。答案必须是单个表达式，且不含任何不等式或附加文本。无需四舍五入，也无需报告物理单位。", "solution": "我们从线性映射 $y = T g$ 开始，其中 $T \\in \\mathbb{R}^{m \\times p}$ 且 $g \\in \\mathbb{R}^{p}$。根据定义，分区降阶建模（ROM）的界面基被选为 $T = U \\Sigma V^{\\top}$ 的奇异值分解（SVD）中左奇异向量矩阵 $U$ 的前 $r$ 列。$y$ 在ROM界面子空间上的投影为 $y_{r} = U_{r} U_{r}^{\\top} y$，其中 $U_{r} \\in \\mathbb{R}^{m \\times r}$ 具有标准正交列，且 $U_{r}^{\\top} U_{r} = I_{r}$。\n\n对于给定的 $g$，界面匹配误差为\n$$\ne_{r}(g) \\equiv \\left\\| y - y_{r} \\right\\|_{2} = \\left\\| (I - U_{r} U_{r}^{\\top}) y \\right\\|_{2} = \\left\\| (I - U_{r} U_{r}^{\\top}) T g \\right\\|_{2}.\n$$\n我们需要计算在单位范数输入下的最坏情况误差，\n$$\nE_{r}^{\\star} = \\sup_{\\|g\\|_{2} = 1} \\left\\| (I - U_{r} U_{r}^{\\top}) T g \\right\\|_{2}.\n$$\n为继续推导，使用SVD $T = U \\Sigma V^{\\top}$，其中 $U$ 和 $V$ 是正交的。将到 $\\operatorname{range}(U_{r})$ 的正交补空间上的正交投影写为 $P_{\\perp} \\equiv I - U_{r} U_{r}^{\\top}$。注意到 $P_{\\perp} U_{r} = 0$ 并且 $P_{\\perp}$ 保持相对于 $U$ 的正交性。考虑 $U$ 的分解 $U = [U_{r} \\;\\; U_{\\perp}]$，其中 $U_{\\perp} \\in \\mathbb{R}^{m \\times (m-r)}$ 包含余下的左奇异向量。那么 $P_{\\perp} U = [0 \\;\\; U_{\\perp}]$，所以\n$$\nP_{\\perp} T = P_{\\perp} U \\Sigma V^{\\top} = [0 \\;\\; U_{\\perp}] \\Sigma V^{\\top}.\n$$\n设奇异值与该分区相容地分组：$\\Sigma = \\operatorname{diag}(\\sigma_{1}, \\ldots, \\sigma_{r}, \\sigma_{r+1}, \\ldots, \\sigma_{q})$ 位于 $q \\times q$ 主对角线上，若 $m \\neq p$ 则补零。那么\n$$\nP_{\\perp} T = U_{\\perp} \\Sigma_{\\perp} V^{\\top},\n$$\n其中 $\\Sigma_{\\perp} = \\operatorname{diag}(\\sigma_{r+1}, \\ldots, \\sigma_{q})$ 位于 $(q-r) \\times (q-r)$ 对角线上，其余项为零。\n\n因此，对于任意 $g$，\n$$\n\\left\\| (I - U_{r} U_{r}^{\\top}) T g \\right\\|_{2} = \\left\\| U_{\\perp} \\Sigma_{\\perp} V^{\\top} g \\right\\|_{2}.\n$$\n因为 $U_{\\perp}$ 是正交的（其列是标准正交的，并将 $U_{r}$ 扩展为 $\\mathbb{R}^{m}$ 的一个标准正交基），所以 $2$-范数在左乘 $U_{\\perp}$ 时保持不变，得到\n$$\n\\left\\| U_{\\perp} \\Sigma_{\\perp} V^{\\top} g \\right\\|_{2} = \\left\\| \\Sigma_{\\perp} V^{\\top} g \\right\\|_{2}.\n$$\n类似地，由于 $V$ 是正交的，定义 $h \\equiv V^{\\top} g$，因此 $\\|h\\|_{2} = \\|g\\|_{2}$。对于单位范数的 $g$，我们有 $\\|h\\|_{2} = 1$，因此\n$$\n\\left\\| \\Sigma_{\\perp} h \\right\\|_{2}^{2} = \\sum_{i=r+1}^{q} \\sigma_{i}^{2} h_{i}^{2}.\n$$\n在所有 $\\|h\\|_{2} = 1$ 的 $h$ 中，此量的上确界是通过选择与最大被舍弃奇异值对应的坐标对齐的 $h$ 来达到的，即 $h = e_{j}$，其中 $j$ 在 $j \\in \\{r+1, \\ldots, q\\}$ 上最大化 $\\sigma_{j}$。因为奇异值是按非增顺序排列的，所以被舍弃的奇异值中最大的是 $\\sigma_{r+1}$。因此，\n$$\n\\sup_{\\|g\\|_{2} = 1} \\left\\| (I - U_{r} U_{r}^{\\top}) T g \\right\\|_{2} = \\sup_{\\|h\\|_{2} = 1} \\left\\| \\Sigma_{\\perp} h \\right\\|_{2} = \\sigma_{r+1}.\n$$\n这正是算子范数 $\\|P_{\\perp} T\\|_{2}$，它等于 $T$ 在秩 $r$ 截断后的下一个奇异值。因此，因将基于SVD的界面基截断至维度 $r$ 而引起的最坏情况界面匹配误差是 $T$ 的第 $(r+1)$ 个奇异值。\n\n所要求的最终表达式是\n$$\nE_{r}^{\\star} = \\sigma_{r+1}.\n$$", "answer": "$$\\boxed{\\sigma_{r+1}}$$", "id": "3524751"}, {"introduction": "降阶模型的一个核心优势是其计算效率，但这通常需要对非线性项或复杂源项的计算进行加速，超降阶（hyper-reduction）是实现这一目标的关键技术。然而，设计不当的超降阶方案可能会破坏原始高保真模型所遵循的基本物理守恒律。本实践练习[@problem_id:3524769]要求您通过一个具体的有限体积法案例，编码实现并对比两种不同的超降阶方案。您将亲身体会到，一个看似合理的“朴素”采样方法如何导致守恒律的破坏，并学会如何设计一种能够精确保持离散守恒性的方案。", "problem": "考虑一个一维、双场、耦合守恒问题，该问题定义在一个具有 $N$ 个控制体（单元）的均匀网格上，单元宽度为 $\\Delta x$，有 $N+1$ 个面，索引为 $f=0,1,\\dots,N$。状态场为定义在单元中心 $i=0,1,\\dots,N-1$ 处的 $a_i$ 和 $b_i$。控制方程由守恒定律的积分形式构建，并通过有限体积法进行离散化：对于每个单元 $i$，其半离散残差为\n$$\nR_i^a = F_{i+1/2}^a - F_{i-1/2}^a + S_i^a,\\qquad R_i^b = F_{i+1/2}^b - F_{i-1/2}^b + S_i^b,\n$$\n其中 $F_{i\\pm 1/2}^{(\\cdot)}$ 是面上的数值通量，$S_i^{(\\cdot)}$ 是局部源项。设平流速度为 $c0$，场 $b$ 的扩散系数为 $D\\ge 0$，线性耦合系数为 $k\\ge 0$，源项为\n$$\nS_i^a = -k\\,(a_i - b_i),\\qquad S_i^b = +k\\,(a_i - b_i).\n$$\n假设在左边界对 $a$ 和 $b$ 均采用入流狄利克雷边界条件，给定值为 $a_{\\text{in}}$ 和 $b_{\\text{in}}$，在右边界为出流且扩散通量为零。对 $a$ 和 $b$ 的平流项（$c0$）均使用迎风格式，对 $b$ 的扩散通量使用中心差分格式。具体来说，对于面 $f=0,\\dots,N$ 和单元 $i=0,\\dots,N-1$：\n- 对于平流项，$F_f^a = c \\, \\tilde{a}_f$ 和 $F_f^{\\text{adv},b} = c \\, \\tilde{b}_f$，其中 $\\tilde{a}_0 = a_{\\text{in}}$，对于 $f\\ge 1$ 有 $\\tilde{a}_f = a_{f-1}$；类似地，$\\tilde{b}_0=b_{\\text{in}}$，对于 $f\\ge 1$ 有 $\\tilde{b}_f=b_{f-1}$。\n- 对于扩散项，$F_f^{\\text{diff},b} = -D\\,\\frac{b_{R(f)} - b_{L(f)}}{\\Delta x}$，其中对于内部面 $f=1,\\dots,N-1$，$L(f)=f-1$，$R(f)=f$；$F_0^{\\text{diff},b}=-D\\,\\frac{b_0 - b_{\\text{in}}}{\\Delta x}$；以及 $F_N^{\\text{diff},b}=0$（零梯度）。\n- 场 $b$ 的总通量为 $F_f^b = F_f^{\\text{adv},b} + F_f^{\\text{diff},b}$。\n\n这种离散构造在控制体层面强制守恒：对于内部面，面通量通过伸缩求和相抵消，只剩下边界贡献，而源项则在局部起作用。在降阶建模（ROM）中，常采用超降阶技术，即只对控制体的一个子集进行采样以评估残差，而未采样部分的贡献则被忽略或近似处理。考虑一个采样控制体集合 $\\mathcal{S}\\subset\\{0,1,\\dots,N-1\\}$。\n\n定义两种应用于离散有限体积残差的超降阶格式：\n- 一种朴素格式：对于每个 $i\\in\\mathcal{S}$，仅使用由两个采样控制体共享的面（即面 $f$ 的两个相邻单元都在 $\\mathcal{S}$ 中）来构造残差。源项 $S_i^{(\\cdot)}$ 总是被包含在内。\n- 一种守恒格式：对于每个 $i\\in\\mathcal{S}$，使用其两个相邻面 $i-1/2$ 和 $i+1/2$ 并赋予单位权重来构造残差，无论相邻单元是否被采样，并包含源项。\n\n你的任务是：\n1. 从有限体积积分守恒定律出发，推导为什么朴素超降阶格式通常会违反采样控制体的离散守恒性，因为它破坏了内部面通量的伸缩抵消，并忽略了采样区域的边界或外部面。\n2. 设计一个采样和加权方案，以恢复采样控制体上的精确离散守恒性。具体来说，为采样单元提出一种面向通量的残差组装方法，该方法利用面的有向关联以及对每个采样单元相邻的两个面使用单位权重，从而确保对于每个 $i\\in\\mathcal{S}$，超降阶残差与全阶残差完全相等。\n3. 实现一个程序，该程序使用上述通量和源项构建一个测试问题，评估精确残差，并为每个测试用例计算超降阶残差与精确残差在采样单元上的最大绝对偏差。每个测试用例报告两个数：朴素格式的最大偏差和守恒格式的最大偏差。\n\n使用以下具有固定参数和采样集的测试套件：\n- 测试用例 1：$N=10$，$\\Delta x = 1/N$，$c = 1.2$，$D = 0.05$，$k = 2.0$，$a_{\\text{in}}=1.0$，$b_{\\text{in}}=0.5$，状态确定性地初始化为 $a_i = \\sin(2\\pi i/N) + 1.0$ 和 $b_i = \\cos(2\\pi i/N) + 0.5$，采样集 $\\mathcal{S}=\\{3,4,5\\}$。\n- 测试用例 2：参数同上，采样集 $\\mathcal{S}=\\{0\\}$。\n- 测试用例 3：参数同上，采样集 $\\mathcal{S}=\\{0,1,2,3,4,5,6,7,8,9\\}$ (所有控制体)。\n- 测试用例 4：参数同上，采样集 $\\mathcal{S}=\\{5,6\\}$。\n\n你的程序应该：\n- 为 $a$ 和 $b$ 组装面通量和精确残差。\n- 根据指定的采样集，为两种格式构建超降阶残差。\n- 对每个测试用例，首先计算朴素格式，然后计算守恒格式在采样单元和两个场上的最大绝对误差。\n\n最终输出格式：你的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，每个元素是一个包含单个测试用例的两个浮点数的列表。例如，输出应类似于 $[[e_{1,\\text{naive}},e_{1,\\text{cons}}],[e_{2,\\text{naive}},e_{2,\\text{cons}}],\\dots]$，其中每个 $e$ 都以普通十进制表示法报告。", "solution": "该问题陈述具有科学依据、适定且完整。它描述了一个耦合平流-扩散-反应系统的典型有限体积离散化，并就降阶建模中使用的超降阶格式的守恒性质提出了一个标准问题。所有参数和定义都清晰且在数学上一致。因此，该问题是有效的，下面提供了完整的解决方案。\n\n此问题的核心在于有限体积法固有的离散守恒原理。一个有效的数值格式必须确保一个体积内守恒量的变化率与其边界上的通量以及内部的任何源或汇精确平衡。我们将首先将此原理形式化，然后分析不同的超降阶格式如何维持或违反它。\n\n守恒量 $u$ 的守恒定律的积分形式由下式给出\n$$\n\\frac{d}{dt}\\int_{V} u \\,dV + \\int_{\\partial V} \\mathbf{F} \\cdot d\\mathbf{A} = \\int_{V} S \\,dV\n$$\n其中 $V$ 是一个控制体，$\\partial V$ 是其边界，$\\mathbf{F}$ 是通量向量，$S$ 是源项。在一维情况下，对宽度为 $\\Delta x$、从面 $i-1/2$ 到面 $i+1/2$ 的单元 $i$ 进行离散化，上式变为\n$$\n\\Delta x \\frac{du_i}{dt} + F_{i+1/2} - F_{i-1/2} = \\Delta x S_i\n$$\n半离散残差 $R_i$ 代表空间算子，使得 $\\frac{du_i}{dt} = - \\frac{1}{\\Delta x} R_i$。问题中定义的残差不包含 $\\Delta x$ 缩放因子，即\n$$\nR_i = F_{i+1/2} - F_{i-1/2} + S_i^{\\text{vol}}\n$$\n其中 $S_i^{\\text{vol}} = \\Delta x S_i$。所提供的源项 $S_i^a$ 和 $S_i^b$ 已经是单元体积上的积分。为清晰起见，我们将用整数索引来表示面，其中面 $f$ 位于单元 $f-1$ 和单元 $f$ 之间。因此，单元 $i$ 的残差为 $R_i = F_{i+1} - F_i + S_i$。\n\n此公式的一个关键特性是，当对一个连续的单元块求和时，内部面上的通量会在伸缩求和中相互抵消。例如，对于单元 $i$ 和 $i+1$：\n$$\nR_i + R_{i+1} = (F_{i+1} - F_i + S_i) + (F_{i+2} - F_{i+1} + S_{i+1}) = F_{i+2} - F_i + S_i + S_{i+1}\n$$\n共享面上的通量 $F_{i+1}$ 被消去。对整个域 $\\{0, \\dots, N-1\\}$ 求和可得：\n$$\n\\sum_{i=0}^{N-1} R_i = \\sum_{i=0}^{N-1} (F_{i+1} - F_i) + \\sum_{i=0}^{N-1} S_i = (F_N - F_0) + \\sum_{i=0}^{N-1} S_i\n$$\n这展示了全局离散守恒性：总变化仅由域边界（$F_0$ 和 $F_N$）上的通量和所有源项的总和决定。\n\n### 1. 朴素超降阶格式中的守恒性违反\n\n超降阶通过仅在采样控制体的一个小子集 $\\mathcal{S} \\subset \\{0, 1, \\dots, N-1\\}$ 上评估残差来近似完整系统。朴素格式试图通过进一步简化残差计算本身来进行这种近似。\n\n问题将朴素格式定义为“仅使用由两个采样控制体共享的面来构造残差”。让我们将其形式化。如果一个面 $f$ 的相邻单元 $f-1$ 和 $f$ 都在 $\\mathcal{S}$ 中，则该面被两个采样控制体共享。对于一个给定的采样单元 $i \\in \\mathcal{S}$，其残差涉及面 $i$ 和 $i+1$。\n- 如果面 $i+1$ 是“共享的”，即单元 $i$ 和单元 $i+1$ 都在 $\\mathcal{S}$ 中，则通量 $F_{i+1}$ 对 $R_i$ 有贡献。\n- 如果面 $i$ 是“共享的”，即单元 $i-1$ 和单元 $i$ 都在 $\\mathcal{S}$ 中，则通量 $F_i$ 对 $R_i$ 有贡献。\n\n因此，对于单元 $i \\in \\mathcal{S}$，其朴素超降阶残差 $\\hat{R}_i^{\\text{naive}}$ 为：\n$$\n\\hat{R}_i^{\\text{naive}} = \\delta_{i+1 \\in \\mathcal{S}} F_{i+1} - \\delta_{i-1 \\in \\mathcal{S}} F_i + S_i\n$$\n其中 $\\delta$ 是一个指示函数，如果其条件为真，则值为 $1$，否则为 $0$。（对于边界单元 $i=0$ 和 $i=N-1$，$i-1$ 和 $i+1$ 超出域索引集，因此它们在 $\\mathcal{S}$ 中的成员资格为假）。\n\n精确的全阶残差为 $R_i = F_{i+1} - F_i + S_i$。朴素残差的误差为：\n$$\nE_i = R_i - \\hat{R}_i^{\\text{naive}} = (1 - \\delta_{i+1 \\in \\mathcal{S}}) F_{i+1} - (1 - \\delta_{i-1 \\in \\mathcal{S}}) F_i\n$$\n只要与采样单元 $i$ 相邻的面是采样区域的边界，该误差就非零。具体来说：\n- 如果 $i \\in \\mathcal{S}$ 但其右邻居 $i+1 \\notin \\mathcal{S}$，那么 $\\delta_{i+1 \\in \\mathcal{S}} = 0$。朴素残差忽略了 $F_{i+1}$ 项，引入了 $F_{i+1}$ 的误差。\n- 如果 $i \\in \\mathcal{S}$ 但其左邻居 $i-1 \\notin \\mathcal{S}$，那么 $\\delta_{i-1 \\in \\mathcal{S}} = 0$。朴素残差忽略了 $-F_i$ 项，引入了 $-F_i$ 的误差。\n\n这种忽略破坏了守恒的基本原理。采样区域的边界通量（即分隔 $\\mathcal{S}$ 与其补集的面集合）被丢弃，这意味着超降阶系统没有考虑采样域和非采样域之间的相互作用。这导致了一个不正确、非守恒的近似。\n\n### 2. 守恒超降阶格式的设计\n\n为了在采样单元层级上恢复离散守恒性，每个 $i \\in \\mathcal{S}$ 的超降阶残差必须等于精确的全阶残差。这不是对残差公式的近似，而是对真实残差的选择性评估。根据定义，实现这一目标的采样和加权方案是为全阶残差中出现的所有项应用单位权重。\n\n问题陈述描述了这样一种“守恒格式”，即对于每个 $i \\in \\mathcal{S}$，使用“两个相邻面 $i-1/2$ 和 $i+1/2$ 并赋予单位权重”。这导致了对单元 $i \\in \\mathcal{S}$ 的守恒超降阶残差 $\\hat{R}_i^{\\text{cons}}$ 的以下公式：\n$$\n\\hat{R}_i^{\\text{cons}} = (1) \\cdot F_{i+1} - (1) \\cdot F_i + S_i = R_i\n$$\n这种设计是“守恒的”，因为它正确地计算了采样单元的全残差，从而精确地遵守了该控制体的守恒定律。其关键含义，也是像 DEIM（离散经验插值法）等方法的核心，是评估 $R_i$ 需要知道算子模板内的状态变量（例如 $a_i$, $b_i$）。对于给定的有限体积格式，由于最近邻通量计算，$R_i$ 的模板由单元 $\\{i-1, i, i+1\\}$ 组成。\n\n因此，一个真正守恒的超降阶格式包含两个组成部分：\n1.  **方程采样**：选择将要评估残差的控制体集合 $\\mathcal{S}$。\n2.  **状态采样/重构**：确保每个采样残差的完整模板上的状态变量是可用的。在本问题的背景下，给出了完整的状态向量，因此我们可以直接访问相邻非采样单元中的状态（例如，如果 $i-1 \\notin \\mathcal{S}$，则可以访问 $a_{i-1}$）。\n\n通过这种构造，对于任何采样单元 $i \\in \\mathcal{S}$，“守恒”超降阶残差与精确残差之间的偏差根据定义为零。实现部分将数值地验证这一性质。\n\n### 3. 实现与评估\n\n我们现在将实现一个 Python 程序，为给定的测试用例计算精确残差和两种超降阶残差。该程序将为每种格式计算在所有采样单元和两个场（$a$ 和 $b$）上的最大绝对偏差。\n\n步骤如下：\n- 定义系统参数（$N, \\Delta x, c, D, k, a_{\\text{in}}, b_{\\text{in}}$）。\n- 按规定初始化状态向量 $a$ 和 $b$。\n- 计算所有 $N+1$ 个面的完整面通量 $F^a$ 和 $F^b$。\n- 计算所有 $N$ 个单元的精确残差 $R^a$ 和 $R^b$。\n- 对于由采样集 $\\mathcal{S}$ 定义的每个测试用例：\n    - 通过仅包含 $\\mathcal{S}$ 内部面的通量来计算 $i \\in \\mathcal{S}$ 的朴素残差 $\\hat{R}^{\\text{naive}}$。\n    - 通过使用完整的残差公式来计算 $i \\in \\mathcal{S}$ 的守恒残差 $\\hat{R}^{\\text{cons}}$。\n    - 计算两种格式和两个场的误差 $E_i = R_i - \\hat{R}_i$。\n    - 找出朴素格式和守恒格式的最大绝对误差。\n- 收集并以指定格式打印结果。守恒格式的误差预计将恒等于零。\n```python\nimport numpy as np\n\ndef compute_full_residuals(N, dx, c, D, k, a_in, b_in, a, b):\n    \"\"\"\n    Computes the full-order finite-volume residuals for the coupled system.\n\n    Args:\n        N (int): Number of control volumes.\n        dx (float): Width of a control volume.\n        c (float): Advection speed.\n        D (float): Diffusion coefficient for field b.\n        k (float): Coupling coefficient.\n        a_in (float): Inflow boundary value for a.\n        b_in (float): Inflow boundary value for b.\n        a (np.ndarray): State vector for field a (size N).\n        b (np.ndarray): State vector for field b (size N).\n\n    Returns:\n        tuple: A tuple containing:\n            - Ra (np.ndarray): Exact residual vector for field a.\n            - Rb (np.ndarray): Exact residual vector for field b.\n            - Fa (np.ndarray): Face flux vector for field a.\n            - Fb (np.ndarray): Face flux vector for field b.\n    \"\"\"\n    # Initialize flux arrays of size N+1\n    Fa = np.zeros(N + 1)\n    Fb = np.zeros(N + 1)\n\n    # Face f=0 (left boundary)\n    Fa[0] = c * a_in\n    Fb[0] = c * b_in - D * (b[0] - b_in) / dx\n\n    # Interior faces f=1 to N-1\n    for f in range(1, N):\n        # Advection flux (upwind)\n        Fa[f] = c * a[f - 1]\n        F_adv_b = c * b[f - 1]\n        # Diffusion flux (central)\n        F_diff_b = -D * (b[f] - b[f - 1]) / dx\n        Fb[f] = F_adv_b + F_diff_b\n\n    # Face f=N (right boundary)\n    Fa[N] = c * a[N - 1]\n    F_adv_b = c * b[N - 1]\n    F_diff_b = 0.0  # Zero diffusive flux\n    Fb[N] = F_adv_b + F_diff_b\n\n    # Initialize residual arrays of size N\n    Ra = np.zeros(N)\n    Rb = np.zeros(N)\n\n    # Compute residuals for cells i=0 to N-1\n    for i in range(N):\n        # Source terms\n        Sa = -k * (a[i] - b[i])\n        Sb = k * (a[i] - b[i])\n        # Residuals\n        Ra[i] = Fa[i + 1] - Fa[i] + Sa\n        Rb[i] = Fb[i + 1] - Fb[i] + Sb\n\n    return Ra, Rb, Fa, Fb\n\n\ndef solve():\n    \"\"\"\n    Main function to run the test cases and compute hyper-reduction errors.\n    \"\"\"\n    # Fixed problem parameters\n    N = 10\n    dx = 1.0 / N\n    c = 1.2\n    D = 0.05\n    k = 2.0\n    a_in = 1.0\n    b_in = 0.5\n\n    # Test cases defined by their sampled sets\n    test_cases = [\n        {\"S\": {3, 4, 5}},\n        {\"S\": {0}},\n        {\"S\": set(range(N))},\n        {\"S\": {5, 6}},\n    ]\n\n    # Initialize state vectors based on the problem description\n    i_vals = np.arange(N)\n    a_init = np.sin(2 * np.pi * i_vals / N) + 1.0\n    b_init = np.cos(2 * np.pi * i_vals / N) + 0.5\n    \n    # Compute the exact full-order residuals and fluxes once\n    Ra_exact, Rb_exact, Fa, Fb = compute_full_residuals(N, dx, c, D, k, a_in, b_in, a_init, b_init)\n\n    results = []\n    \n    for case in test_cases:\n        S = case[\"S\"]\n        max_error_naive = 0.0\n        max_error_cons = 0.0\n\n        for i in S:\n            # Source terms are always included in both schemes\n            Sa = -k * (a_init[i] - b_init[i])\n            Sb = k * (a_init[i] - b_init[i])\n\n            # --- Naive Scheme Residual Calculation ---\n            # Include flux terms only if the face is shared by two sampled cells\n            is_left_neighbor_sampled = (i > 0) and ((i - 1) in S)\n            is_right_neighbor_sampled = (i  N - 1) and ((i + 1) in S)\n            \n            # Use indicator flags to include/exclude flux terms\n            Ra_naive_i = (is_right_neighbor_sampled * Fa[i + 1]) - (is_left_neighbor_sampled * Fa[i]) + Sa\n            Rb_naive_i = (is_right_neighbor_sampled * Fb[i + 1]) - (is_left_neighbor_sampled * Fb[i]) + Sb\n\n            # --- Conservative Scheme Residual Calculation ---\n            # Use all flux terms with unit weights\n            Ra_cons_i = Fa[i + 1] - Fa[i] + Sa\n            Rb_cons_i = Fb[i + 1] - Fb[i] + Sb\n\n            # --- Error Calculation for cell i ---\n            # Compare naive residuals with exact residuals\n            error_a_naive = abs(Ra_naive_i - Ra_exact[i])\n            error_b_naive = abs(Rb_naive_i - Rb_exact[i])\n            max_error_naive = max(max_error_naive, error_a_naive, error_b_naive)\n\n            # Compare conservative residuals with exact residuals\n            error_a_cons = abs(Ra_cons_i - Ra_exact[i])\n            error_b_cons = abs(Rb_cons_i - Rb_exact[i])\n            max_error_cons = max(max_error_cons, error_a_cons, error_b_cons)\n\n        results.append([max_error_naive, max_error_cons])\n\n    # Format the output string as specified\n    # e.g., [[err1_n, err1_c], [err2_n, err2_c]]\n    output_str = \"[\" + \",\".join([f\"[{naive_err},{cons_err}]\" for naive_err, cons_err in results]) + \"]\"\n    print(output_str)\n\nsolve()\n```", "answer": "[[2.062868530707928,0.0],[1.7,0.0],[0.0,0.0],[2.062868530707928,0.0]]", "id": "3524769"}, {"introduction": "构建降阶模型后，我们最终需要求解一个规模更小但仍可能高度耦合的代数方程组。对于强耦合问题，通常采用诸如拟牛顿法之类的迭代方法来求解降阶后的界面变量。整个仿真流程的效率在很大程度上取决于这个降阶求解器的收敛速度。在本练习[@problem_id:3524781]中，您将深入分析一个用于降阶界面问题的拟牛顿求解器。通过推导降阶雅可比矩阵并分析其迭代收敛谱半径，您将理解近似雅可比矩阵的选择如何直接影响求解器的性能。", "problem": "考虑一个双物理场强耦合系统，其全阶单体界面规约得到一个对称正定舒尔补算子 $S \\in \\mathbb{R}^{3 \\times 3}$，该算子将界面状态映射到残余牵引力。通过向一个二维标准正交界面基 $U_{r} \\in \\mathbb{R}^{3 \\times 2}$（其列向量为 $u_{1} = [1, 0, 0]^{\\top}$ 和 $u_{2} = [0, 1/\\sqrt{2}, 1/\\sqrt{2}]^{\\top}$）作伽辽金投影，构建一个降阶模型 (ROM)。全阶算子为\n$$\nS = \\operatorname{diag}(6, 5, 4).\n$$\n降阶残差为 $R_{r}(y) = \\tilde{J}_{\\star} y - \\tilde{g}$，其中 $y \\in \\mathbb{R}^{2}$，精确降阶界面雅可比矩阵是伽辽金投影 $\\tilde{J}_{\\star} = U_{r}^{\\top} S U_{r}$，而 $\\tilde{g} \\in \\mathbb{R}^{2}$ 是降阶强迫项。在降阶空间中，应用拟牛顿界面求解器求解 $R_{r}(y) = 0$，其迭代格式为\n$$\ny_{k+1} = y_{k} - \\tilde{J}_{k}^{-1} R_{r}(y_{k}),\n$$\n其中 $\\tilde{J}_{k}$ 是 $\\tilde{J}_{\\star}$ 的一个近似。假设 $y_{0} = 0$，并选择 $\\tilde{g}$ 使得初始降阶残差等于第一个标准基向量，即 $R_{r}(y_{0}) = r_{0} = e_{1}$。初始雅可比矩阵猜测是各向同性的，$\\tilde{J}_{0} = \\gamma I_{2}$，其中 $\\gamma  0$。雅可比矩阵近似的更新使用单个割线条件和弗罗贝尼乌斯范数下的最小变化原则（也就是说，雅可比矩阵近似求解的是一个受割线约束的最小偏差问题）。\n\n在当前多物理场降阶背景下，从第一性原理出发：\n- 由 $S$ 和 $U_{r}$ 推导出精确降阶界面雅可比矩阵 $\\tilde{J}_{\\star}$。\n- 使用割线条件和最小变化原则，推导出一次迭代后的第一个拟牛顿降阶雅可比矩阵 $\\tilde{J}_{1}$，并用 $\\gamma$ 和问题数据明确表示。\n- 通过计算降阶迭代矩阵 $I - \\tilde{J}_{1}^{-1} \\tilde{J}_{\\star}$ 的谱半径来分析局部线性收敛性，并将结果简化为关于 $\\gamma$ 的单个闭式解析表达式。\n\n将谱半径的简化表达式作为最终答案报告。无需四舍五入。最终答案必须是无单位的单个闭式表达式。", "solution": "本问题要求推导应用于降阶模型的拟牛顿法的局部收敛矩阵的谱半径。该过程包含三个主要步骤：首先，确定精确降阶雅可比矩阵 $\\tilde{J}_{\\star}$；其次，计算第一次更新后的拟牛顿雅可比矩阵近似 $\\tilde{J}_{1}$；最后，计算所得迭代误差传播矩阵的谱半径。\n\n首先，我们推导精确降阶界面雅可比矩阵 $\\tilde{J}_{\\star}$。这是通过将全阶舒尔补算子 $S$ 伽辽金投影到降阶基 $U_r$ 上得到的。其公式为 $\\tilde{J}_{\\star} = U_{r}^{\\top} S U_{r}$。\n\n全阶算子为 $S = \\operatorname{diag}(6, 5, 4)$，可以写成矩阵形式：\n$$\nS = \\begin{pmatrix} 6  0  0 \\\\ 0  5  0 \\\\ 0  0  4 \\end{pmatrix}\n$$\n降阶基 $U_r$ 由两个标准正交列向量 $u_1 = [1, 0, 0]^{\\top}$ 和 $u_2 = [0, 1/\\sqrt{2}, 1/\\sqrt{2}]^{\\top}$ 组成：\n$$\nU_r = \\begin{pmatrix} 1  0 \\\\ 0  \\frac{1}{\\sqrt{2}} \\\\ 0  \\frac{1}{\\sqrt{2}} \\end{pmatrix}\n$$\n该基矩阵的转置为：\n$$\nU_{r}^{\\top} = \\begin{pmatrix} 1  0  0 \\\\ 0  \\frac{1}{\\sqrt{2}}  \\frac{1}{\\sqrt{2}} \\end{pmatrix}\n$$\n我们现在进行矩阵乘法来求解 $\\tilde{J}_{\\star}$：\n$$\n\\tilde{J}_{\\star} = U_{r}^{\\top} S U_{r} = \\begin{pmatrix} 1  0  0 \\\\ 0  \\frac{1}{\\sqrt{2}}  \\frac{1}{\\sqrt{2}} \\end{pmatrix} \\begin{pmatrix} 6  0  0 \\\\ 0  5  0 \\\\ 0  0  4 \\end{pmatrix} \\begin{pmatrix} 1  0 \\\\ 0  \\frac{1}{\\sqrt{2}} \\\\ 0  \\frac{1}{\\sqrt{2}} \\end{pmatrix}\n$$\n$$\n\\tilde{J}_{\\star} = \\begin{pmatrix} 1  0  0 \\\\ 0  \\frac{1}{\\sqrt{2}}  \\frac{1}{\\sqrt{2}} \\end{pmatrix} \\begin{pmatrix} 6  0 \\\\ 0  \\frac{5}{\\sqrt{2}} \\\\ 0  \\frac{4}{\\sqrt{2}} \\end{pmatrix} = \\begin{pmatrix} 6  0 \\\\ 0  \\frac{5}{2} + \\frac{4}{2} \\end{pmatrix} = \\begin{pmatrix} 6  0 \\\\ 0  \\frac{9}{2} \\end{pmatrix}\n$$\n因此，精确降阶雅可比矩阵为 $\\tilde{J}_{\\star} = \\operatorname{diag}(6, 4.5)$。\n\n其次，我们推导第一个拟牛顿降阶雅可比矩阵 $\\tilde{J}_{1}$。从初始猜测 $\\tilde{J}_{0}$ 到 $\\tilde{J}_{1}$ 的更新是基于满足割线条件，同时最小化与 $\\tilde{J}_{0}$ 在弗罗贝尼乌斯范数下的变化。这被称为 Broyden 的“好”方法，其更新公式为：\n$$\n\\tilde{J}_{k+1} = \\tilde{J}_{k} + \\frac{(v_k - \\tilde{J}_{k} s_k) s_k^{\\top}}{s_k^{\\top} s_k}\n$$\n其中 $s_k = y_{k+1} - y_k$ 且 $v_k = R_r(y_{k+1}) - R_r(y_k)$。我们需要计算 $k=0$ 时这些量的值。\n\n初始状态为 $y_0 = 0$。初始雅可比矩阵为 $\\tilde{J}_{0} = \\gamma I_{2} = \\operatorname{diag}(\\gamma, \\gamma)$。给定的初始降阶残差为 $R_r(y_0) = r_0 = e_1 = [1, 0]^{\\top}$。\n拟牛顿迭代的第一步是：\n$$\ny_1 = y_0 - \\tilde{J}_{0}^{-1} R_r(y_0) = 0 - (\\gamma I_2)^{-1} e_1 = -\\frac{1}{\\gamma} e_1 = \\begin{pmatrix} -1/\\gamma \\\\ 0 \\end{pmatrix}\n$$\n由此，步长向量 $s_0$ 为：\n$$\ns_0 = y_1 - y_0 = \\begin{pmatrix} -1/\\gamma \\\\ 0 \\end{pmatrix}\n$$\n接下来，我们确定残差的变化量 $v_0$。降阶残差函数为 $R_r(y) = \\tilde{J}_{\\star} y - \\tilde{g}$。使用初始条件 $R_r(y_0) = \\tilde{J}_{\\star} \\cdot 0 - \\tilde{g} = e_1$，这意味着 $\\tilde{g} = -e_1$。因此，$R_r(y) = \\tilde{J}_{\\star} y + e_1$。\n我们计算 $y_1$ 处的残差：\n$$\nR_r(y_1) = \\tilde{J}_{\\star} y_1 + e_1 = \\begin{pmatrix} 6  0 \\\\ 0  \\frac{9}{2} \\end{pmatrix} \\begin{pmatrix} -1/\\gamma \\\\ 0 \\end{pmatrix} + \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix} = \\begin{pmatrix} -6/\\gamma \\\\ 0 \\end{pmatrix} + \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix} = \\begin{pmatrix} 1 - 6/\\gamma \\\\ 0 \\end{pmatrix}\n$$\n残差的变化量 $v_0$ 为：\n$$\nv_0 = R_r(y_1) - R_r(y_0) = \\begin{pmatrix} 1 - 6/\\gamma \\\\ 0 \\end{pmatrix} - \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix} = \\begin{pmatrix} -6/\\gamma \\\\ 0 \\end{pmatrix}\n$$\n现在我们计算 Broyden 更新的各项：\n$$\n\\tilde{J}_{0} s_0 = \\begin{pmatrix} \\gamma  0 \\\\ 0  \\gamma \\end{pmatrix} \\begin{pmatrix} -1/\\gamma \\\\ 0 \\end{pmatrix} = \\begin{pmatrix} -1 \\\\ 0 \\end{pmatrix}\n$$\n$$\nv_0 - \\tilde{J}_{0} s_0 = \\begin{pmatrix} -6/\\gamma \\\\ 0 \\end{pmatrix} - \\begin{pmatrix} -1 \\\\ 0 \\end{pmatrix} = \\begin{pmatrix} 1 - 6/\\gamma \\\\ 0 \\end{pmatrix}\n$$\n$$\ns_0^{\\top} s_0 = (-1/\\gamma)^2 + 0^2 = \\frac{1}{\\gamma^2}\n$$\n更新项为：\n$$\n\\frac{(v_0 - \\tilde{J}_{0} s_0) s_0^{\\top}}{s_0^{\\top} s_0} = \\frac{\\begin{pmatrix} 1 - 6/\\gamma \\\\ 0 \\end{pmatrix} \\begin{pmatrix} -1/\\gamma  0 \\end{pmatrix}}{1/\\gamma^2} = \\gamma^2 \\begin{pmatrix} (1-6/\\gamma)(-1/\\gamma)  0 \\\\ 0  0 \\end{pmatrix} = \\begin{pmatrix} -\\gamma(1-6/\\gamma)  0 \\\\ 0  0 \\end{pmatrix} = \\begin{pmatrix} 6-\\gamma  0 \\\\ 0  0 \\end{pmatrix}\n$$\n最后，我们计算 $\\tilde{J}_1$：\n$$\n\\tilde{J}_1 = \\tilde{J}_0 + \\begin{pmatrix} 6-\\gamma  0 \\\\ 0  0 \\end{pmatrix} = \\begin{pmatrix} \\gamma  0 \\\\ 0  \\gamma \\end{pmatrix} + \\begin{pmatrix} 6-\\gamma  0 \\\\ 0  0 \\end{pmatrix} = \\begin{pmatrix} 6  0 \\\\ 0  \\gamma \\end{pmatrix}\n$$\n\n第三，我们通过计算降阶迭代矩阵 $M = I - \\tilde{J}_{1}^{-1} \\tilde{J}_{\\star}$ 的谱半径来分析局部线性收敛性。谱半径 $\\rho(M)$ 是 $M$ 的特征值的最大绝对值。\n$\\tilde{J}_1$ 的逆矩阵为（给定 $\\gamma  0$）：\n$$\n\\tilde{J}_{1}^{-1} = \\begin{pmatrix} 1/6  0 \\\\ 0  1/\\gamma \\end{pmatrix}\n$$\n我们计算乘积 $\\tilde{J}_{1}^{-1} \\tilde{J}_{\\star}$：\n$$\n\\tilde{J}_{1}^{-1} \\tilde{J}_{\\star} = \\begin{pmatrix} 1/6  0 \\\\ 0  1/\\gamma \\end{pmatrix} \\begin{pmatrix} 6  0 \\\\ 0  \\frac{9}{2} \\end{pmatrix} = \\begin{pmatrix} 1  0 \\\\ 0  \\frac{9}{2\\gamma} \\end{pmatrix}\n$$\n现在，我们求迭代矩阵 $M$：\n$$\nM = I - \\tilde{J}_{1}^{-1} \\tilde{J}_{\\star} = \\begin{pmatrix} 1  0 \\\\ 0  1 \\end{pmatrix} - \\begin{pmatrix} 1  0 \\\\ 0  \\frac{9}{2\\gamma} \\end{pmatrix} = \\begin{pmatrix} 0  0 \\\\ 0  1 - \\frac{9}{2\\gamma} \\end{pmatrix}\n$$\n对角矩阵的特征值是其对角线上的元素。$M$ 的特征值为 $\\lambda_1 = 0$ 和 $\\lambda_2 = 1 - \\frac{9}{2\\gamma}$。\n谱半径是特征值绝对值的最大值：\n$$\n\\rho(M) = \\max(|\\lambda_1|, |\\lambda_2|) = \\max\\left( |0|, \\left|1 - \\frac{9}{2\\gamma}\\right| \\right) = \\left|1 - \\frac{9}{2\\gamma}\\right|\n$$\n这就是作为 $\\gamma$ 函数的谱半径的最终简化闭式表达式。", "answer": "$$\n\\boxed{\\left|1 - \\frac{9}{2\\gamma}\\right|}\n$$", "id": "3524781"}]}