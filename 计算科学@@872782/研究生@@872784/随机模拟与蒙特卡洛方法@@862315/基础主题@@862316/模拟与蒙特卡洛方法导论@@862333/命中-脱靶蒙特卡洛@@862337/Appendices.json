{"hands_on_practices": [{"introduction": "击中-或-错过蒙特卡洛方法的效率不仅取决于样本数量，还取决于我们如何构建采样区域。这个练习将引导您从第一性原理出发，推导出估计量方差与采样域体积之间的关键关系。通过这个过程，您将掌握优化此方法效率的基本原则：即尽可能地缩小“靶”的面积 [@problem_id:3312364]。", "problem": "考虑一个具有紧支集 $S\\subset\\mathbb{R}^{d}$ 的非负可积函数 $g:\\mathbb{R}^{d}\\to[0,\\infty)$，并定义积分 $I=\\int_{\\mathbb{R}^{d}} g(x)\\,\\mathrm{d}x=\\int_{S} g(x)\\,\\mathrm{d}x$。设 $D_{1}$ 和 $D_{2}$ 是 $\\mathbb{R}^{d}$ 中的两个轴对齐边界框（超矩形），使得 $S\\subset D_{1}$ 和 $S\\subset D_{2}$，其体积分别为 $|D_1|$ 和 $|D_2|$，其中 $|\\cdot|$ 表示勒贝格测度。假设存在一个已知的有限常数 $H$ 满足 $H\\ge \\sup_{x\\in\\mathbb{R}^{d}} g(x)$，并且对于 $D_{1}$ 和 $D_{2}$，$H$ 是相同的。\n\n对于每个 $k\\in\\{1,2\\}$，通过抽取 $M$ 个独立同分布（i.i.d.）的样本 $(X_{i}^{(k)},U_{i}^{(k)})$（$i=1,\\dots,M$）来构建 $I$ 的一个命中或脱靶蒙特卡洛（hit-or-miss Monte Carlo, MC）估计量，其中 $X_{i}^{(k)}$ 在 $D_{k}$ 上均匀分布，$U_{i}^{(k)}$ 在 $[0,H]$ 上均匀分布，且与 $X_{i}^{(k)}$ 相互独立。定义 $Y_{i}^{(k)}=\\mathbf{1}\\{U_{i}^{(k)}\\le g(X_{i}^{(k)})\\}$ 以及估计量\n$$\n\\widehat{I}_{k} = |D_{k}|\\,H\\,\\frac{1}{M}\\sum_{i=1}^{M} Y_{i}^{(k)}.\n$$\n\n从概率论的第一性原理（指示函数的期望和独立伯努利随机变量样本均值的方差）出发，推导方差之比 $\\mathrm{Var}(\\widehat{I}_{1})/\\mathrm{Var}(\\widehat{I}_{2})$ 的闭式表达式，用 $|D_{1}|$, $|D_{2}|$, $H$ 和 $I$ 表示。将最终答案表示为单个解析表达式。无需四舍五入。", "solution": "首先验证问题，以确保其具有科学依据、良态（well-posed）且客观。\n\n### 步骤 1：提取已知条件\n- 一个具有紧支集 $S\\subset\\mathbb{R}^{d}$ 的非负可积函数 $g:\\mathbb{R}^{d}\\to[0,\\infty)$。\n- 积分 $I=\\int_{\\mathbb{R}^{d}} g(x)\\,\\mathrm{d}x=\\int_{S} g(x)\\,\\mathrm{d}x$。\n- $\\mathbb{R}^{d}$ 中的两个轴对齐边界框 $D_{1}$ 和 $D_{2}$，使得 $S\\subset D_{1}$ 和 $S\\subset D_{2}$。\n- 体积分别为 $|D_1|$ 和 $|D_2|$，其中 $|\\cdot|$ 表示勒贝格测度。\n- 一个已知的有限常数 $H$ 满足 $H\\ge \\sup_{x\\in\\mathbb{R}^{d}} g(x)$。\n- 对于每个 $k\\in\\{1,2\\}$，抽取 $M$ 个独立同分布（i.i.d.）的样本 $(X_{i}^{(k)},U_{i}^{(k)})$，其中 $i=1,\\dots,M$。\n- $X_{i}^{(k)}$ 在 $D_{k}$ 上均匀分布。\n- $U_{i}^{(k)}$ 在 $[0,H]$ 上均匀分布，且与 $X_{i}^{(k)}$ 相互独立。\n- 随机变量 $Y_{i}^{(k)}=\\mathbf{1}\\{U_{i}^{(k)}\\le g(X_{i}^{(k)})\\}$。\n- $I$ 的估计量为 $\\widehat{I}_{k} = |D_{k}|\\,H\\,\\frac{1}{M}\\sum_{i=1}^{M} Y_{i}^{(k)}$。\n- 任务是推导方差之比 $\\mathrm{Var}(\\widehat{I}_{1})/\\mathrm{Var}(\\widehat{I}_{2})$ 的闭式表达式。\n\n### 步骤 2：使用提取的已知条件进行验证\n问题陈述描述了一个标准的命中或脱靶蒙特卡洛积分场景。\n- **科学依据**：该问题基于蒙特卡洛方法的成熟数学理论，这是数值分析和计算科学中的一个核心课题。所有原理都是合理的。\n- **良态性**：该问题提供了推导估计量方差及其比值所需的所有定义和条件。各个量都定义明确，并且预期会有一个唯一的解。\n- **客观性**：该问题使用精确的数学语言陈述，没有歧义或主观内容。\n\n该问题不存在任何无效性缺陷。它是随机模拟领域中一个有效、定义明确的问题。\n\n### 步骤 3：结论与行动\n问题有效。将提供完整解答。\n\n### 推导过程\n我们的目标是计算比值 $\\mathrm{Var}(\\widehat{I}_{1})/\\mathrm{Var}(\\widehat{I}_{2})$。我们首先推导 $k \\in \\{1, 2\\}$ 时 $\\mathrm{Var}(\\widehat{I}_{k})$ 的一般表达式。\n\n估计量由下式给出\n$$\n\\widehat{I}_{k} = |D_{k}|\\,H\\,\\frac{1}{M}\\sum_{i=1}^{M} Y_{i}^{(k)}\n$$\n该估计量的方差可以通过使用方差的性质来求得。由于 $Y_{i}^{(k)}$（$i=1,\\dots,M$）是独立同分布的，\n$$\n\\mathrm{Var}(\\widehat{I}_{k}) = \\mathrm{Var}\\left( |D_{k}|\\,H\\,\\frac{1}{M}\\sum_{i=1}^{M} Y_{i}^{(k)} \\right) = \\left( \\frac{|D_{k}|\\,H}{M} \\right)^2 \\mathrm{Var}\\left( \\sum_{i=1}^{M} Y_{i}^{(k)} \\right) = \\frac{(|D_{k}|\\,H)^2}{M^2} \\sum_{i=1}^{M} \\mathrm{Var}(Y_{i}^{(k)})\n$$\n由于这些变量是同分布的，因此对于所有的 $i$，都有 $\\mathrm{Var}(Y_{i}^{(k)}) = \\mathrm{Var}(Y_{1}^{(k)})$。为简单起见，我们将 $Y_1^{(k)}$ 表示为 $Y^{(k)}$。\n$$\n\\mathrm{Var}(\\widehat{I}_{k}) = \\frac{(|D_{k}|\\,H)^2}{M^2} \\cdot M \\cdot \\mathrm{Var}(Y^{(k)}) = \\frac{(|D_{k}|\\,H)^2}{M} \\mathrm{Var}(Y^{(k)})\n$$\n随机变量 $Y^{(k)} = \\mathbf{1}\\{U^{(k)} \\le g(X^{(k)})\\}$ 是一个指示变量。因此，它服从参数为 $p_k = P(Y^{(k)}=1)$ 的伯努利分布。伯努利随机变量的方差由 $\\mathrm{Var}(Y^{(k)}) = p_k(1-p_k)$ 给出。\n\n我们必须求出 $p_k$。参数 $p_k$ 是“命中”的概率，即 $p_k = P(U^{(k)} \\le g(X^{(k)}))$。我们可以通过在区域 $u \\le g(x)$ 上对 $(X^{(k)}, U^{(k)})$ 的联合概率密度函数（PDF）进行积分来计算这个概率。\n\n随机变量 $X^{(k)}$ 在 $D_k$ 上均匀分布，因此其 PDF 为 $f_{X^{(k)}}(x) = \\frac{1}{|D_k|}$（当 $x \\in D_k$ 时），否则为 $0$。\n随机变量 $U^{(k)}$ 在 $[0,H]$ 上均匀分布，因此其 PDF 为 $f_{U^{(k)}}(u) = \\frac{1}{H}$（当 $u \\in [0,H]$ 时），否则为 $0$。\n由于 $X^{(k)}$ 和 $U^{(k)}$ 是独立的，它们的联合 PDF 为 $f_{X^{(k)},U^{(k)}}(x,u) = f_{X^{(k)}}(x)f_{U^{(k)}}(u) = \\frac{1}{|D_k|H}$（当 $(x,u) \\in D_k \\times [0,H]$ 时），否则为 $0$。\n\n现在我们计算 $p_k$：\n$$\np_k = P(U^{(k)} \\le g(X^{(k)})) = \\int_{\\mathbb{R}^d} \\int_{\\mathbb{R}} \\mathbf{1}\\{u \\le g(x)\\} f_{X^{(k)},U^{(k)}}(x,u) \\,\\mathrm{d}u \\,\\mathrm{d}x\n$$\n该积分仅在域 $D_k \\times [0,H]$ 上非零：\n$$\np_k = \\int_{D_k} \\int_{0}^{H} \\mathbf{1}\\{u \\le g(x)\\} \\frac{1}{|D_k|H} \\,\\mathrm{d}u \\,\\mathrm{d}x = \\frac{1}{|D_k|H} \\int_{D_k} \\left( \\int_{0}^{H} \\mathbf{1}\\{u \\le g(x)\\} \\,\\mathrm{d}u \\right) \\,\\mathrm{d}x\n$$\n内层积分的计算结果为 $\\int_{0}^{g(x)} 1 \\,\\mathrm{d}u = g(x)$。这是有效的，因为我们已知 $g(x) \\ge 0$ 且 $g(x) \\le \\sup g \\le H$。\n$$\np_k = \\frac{1}{|D_k|H} \\int_{D_k} g(x) \\,\\mathrm{d}x\n$$\n我们已知 $g$ 的支集是 $S$，并且 $S \\subset D_k$。这意味着对于任何 $x \\in D_k \\setminus S$，$g(x)=0$。因此，$g(x)$ 在 $D_k$ 上的积分等于其在整个 $\\mathbb{R}^d$ 上的积分：\n$$\n\\int_{D_k} g(x) \\,\\mathrm{d}x = \\int_{S} g(x) \\,\\mathrm{d}x = I\n$$\n将此代入 $p_k$ 的表达式中，我们得到：\n$$\np_k = \\frac{I}{|D_k|H}\n$$\n现在我们可以用问题的参数来表示 $Y^{(k)}$ 的方差：\n$$\n\\mathrm{Var}(Y^{(k)}) = p_k(1-p_k) = \\frac{I}{|D_k|H} \\left( 1 - \\frac{I}{|D_k|H} \\right)\n$$\n将此代回估计量 $\\widehat{I}_k$ 的方差公式中：\n$$\n\\mathrm{Var}(\\widehat{I}_{k}) = \\frac{(|D_k|\\,H)^2}{M} \\mathrm{Var}(Y^{(k)}) = \\frac{(|D_k|\\,H)^2}{M} \\left[ \\frac{I}{|D_k|H} \\left( 1 - \\frac{I}{|D_k|H} \\right) \\right]\n$$\n简化表达式：\n$$\n\\mathrm{Var}(\\widehat{I}_{k}) = \\frac{|D_k|\\,H \\cdot I}{M} \\left( 1 - \\frac{I}{|D_k|H} \\right) = \\frac{|D_k|\\,H \\cdot I}{M} \\left( \\frac{|D_k|\\,H - I}{|D_k|\\,H} \\right)\n$$\n$$\n\\mathrm{Var}(\\widehat{I}_{k}) = \\frac{I}{M} (|D_k|\\,H - I)\n$$\n这就是对于给定的边界框 $D_k$，估计量的方差。现在我们可以构建 $k=1$ 和 $k=2$ 时的方差之比。\n$$\n\\frac{\\mathrm{Var}(\\widehat{I}_{1})}{\\mathrm{Var}(\\widehat{I}_{2})} = \\frac{\\frac{I}{M} (|D_{1}|\\,H - I)}{\\frac{I}{M} (|D_{2}|\\,H - I)}\n$$\n假设 $I > 0$，则 $\\frac{I}{M}$ 项可以消去。如果 $I=0$，则 $g(x)$ 几乎处处为零，两个方差都为零，其比值是不确定的。对于一个非平凡问题，我们假设 $I>0$。\n$$\n\\frac{\\mathrm{Var}(\\widehat{I}_{1})}{\\mathrm{Var}(\\widehat{I}_{2})} = \\frac{|D_{1}|\\,H - I}{|D_{2}|\\,H - I}\n$$\n此表达式即为最终结果，完全由 $|D_{1}|$, $|D_{2}|$, $H$ 和 $I$ 表示，符合题目要求。", "answer": "$$\n\\boxed{\\frac{|D_{1}|\\,H - I}{|D_{2}|\\,H - I}}\n$$", "id": "3312364"}, {"introduction": "尽管击中-或-错过是一种直观而强大的工具，但它并非总是最佳选择。这个练习将让您直接比较它与常规蒙特卡洛积分方法的效率。通过分析两种不同类型的函数，您将建立起深刻的直觉，理解在何种情况下击中-或-错过方法表现出色，以及在何种情况下其效率会变得非常低下 [@problem_id:3312391]。", "problem": "设 $D=[0,1]$ 为配备了勒贝格测度的单位区间。考虑使用两种方法估计积分 $I=\\int_{0}^{1} g(x)\\,dx$：\n- 命中或错失蒙特卡洛 (Hit-or-miss Monte Carlo, HOM)：抽取独立同分布的配对 $(X_i,U_i)$，其中 $X_i \\sim \\text{Uniform}[0,1]$ 且 $U_i \\sim \\text{Uniform}[0,1]$，且 $U_i$ 与 $X_i$ 独立，然后定义 $H_i=\\mathbf{1}\\{U_i \\le g(X_i)\\}$。使用估计量 $\\hat{I}_{\\text{hom}}=\\frac{1}{N}\\sum_{i=1}^{N} H_i$。\n- 简单蒙特卡洛 (Simple Monte Carlo, SMC)：抽取独立同分布的 $X_i \\sim \\text{Uniform}[0,1]$，并使用估计量 $\\hat{I}_{\\text{smc}}=\\frac{1}{N}\\sum_{i=1}^{N} g(X_i)$。\n\n从独立同分布平均值的期望和方差的核心定义以及示性变量的构造出发。对于与HOM方法一致的固定包络界限，假设对所有 $x\\in[0,1]$ 都有 $g(x)\\in[0,1]$，这样HOM的构造无需缩放即可成立。\n\n构造两个具体的函数 $g$，并通过计算它们的渐近方差（即由 $N$ 缩放后的估计量方差）的精确比率来分析HOM相对于SMC的效率，该比率定义为\n$$\nR(g)\\equiv \\frac{\\operatorname{Var}(\\hat{I}_{\\text{hom}})}{\\operatorname{Var}(\\hat{I}_{\\text{smc}})}.\n$$\n具体来说，使用以下两个函数：\n- 近似最优情况：$g_1(x)=\\mathbf{1}\\{x\\le p\\}$，其中 $p\\in(0,1)$ 是一个任意但固定的参数。\n- 显著次优情况：$g_2(x)=\\begin{cases}\n1, x\\in[0,q],\\\\\n\\epsilon, x\\in(q,1],\n\\end{cases}$，其中 $q\\in(0,1)$ 和 $\\epsilon\\in(0,1)$ 是固定参数。\n\n以 $p$、$q$ 和 $\\epsilon$ 的闭式解析表达式精确计算 $R(g_1)$ 和 $R(g_2)$，并将最终结果以一个二元行矩阵 $\\begin{pmatrix} R(g_1)  R(g_2)\\end{pmatrix}$ 的形式给出。不需要进行数值四舍五入。", "solution": "该问题是有效的，因为它是随机模拟和蒙特卡洛方法领域内一个适定且有科学依据的问题。所有术语都得到了正式定义，所要求的计算是可行的，并且其前提建立在概率论和统计学的既定原则之上。\n\n设 $I = \\int_{0}^{1} g(x)\\,dx$。两个估计量由下式给出：\n1.  命中或错失蒙特卡洛 (HOM)：$\\hat{I}_{\\text{hom}}=\\frac{1}{N}\\sum_{i=1}^{N} H_i$，其中 $H_i=\\mathbf{1}\\{U_i \\le g(X_i)\\}$。\n2.  简单蒙特卡洛 (SMC)：$\\hatI_{\\text{smc}}=\\frac{1}{N}\\sum_{i=1}^{N} g(X_i)$。\n\n样本 $\\{H_i\\}_{i=1}^N$ 是独立同分布 (i.i.d.) 的随机变量。类似地，$\\{g(X_i)\\}_{i=1}^N$ 也是独立同分布的。$N$ 个独立同分布随机变量 $Y_i$ 的平均值的方差是 $\\frac{1}{N}\\operatorname{Var}(Y_1)$。因此，渐近方差（由 $N$ 缩放）分别为 $\\operatorname{Var}(H_1)$ 和 $\\operatorname{Var}(g(X_1))$。这些方差的比率为：\n$$\nR(g) = \\frac{N \\operatorname{Var}(\\hat{I}_{\\text{hom}})}{N \\operatorname{Var}(\\hat{I}_{\\text{smc}})} = \\frac{\\operatorname{Var}(H_1)}{\\operatorname{Var}(g(X_1))}\n$$\n\n我们首先推导这两个方差的一般表达式。\n\n对于HOM估计量，变量 $H_1 = \\mathbf{1}\\{U_1 \\le g(X_1)\\}$ 是一个伯努利随机变量。其期望 $\\pi$ 是“命中”的概率：\n$$\n\\pi = P(H_1=1) = E[H_1] = E[\\mathbf{1}\\{U_1 \\le g(X_1)\\}]\n$$\n根据全期望定律，我们可以对 $X_1=x$ 取条件：\n$$\n\\pi = E[ P(U_1 \\le g(X_1) | X_1=x) ] = E[g(X_1)]\n$$\n由于 $X_1 \\sim \\text{Uniform}[0,1]$，其概率密度函数在 $x \\in [0,1]$ 上为 $f_X(x)=1$，我们有：\n$$\n\\pi = \\int_{0}^{1} g(x)f_X(x)\\,dx = \\int_{0}^{1} g(x)\\,dx = I\n$$\n参数为 $\\pi$ 的伯努利变量的方差是 $\\pi(1-\\pi)$。因此：\n$$\n\\operatorname{Var}(H_1) = I(1-I)\n$$\n\n对于SMC估计量，随机变量 $g(X_1)$ 的方差由标准公式给出：\n$$\n\\operatorname{Var}(g(X_1)) = E[g(X_1)^2] - (E[g(X_1)])^2\n$$\n我们已经证明了 $E[g(X_1)] = I$。平方的期望是：\n$$\nE[g(X_1)^2] = \\int_{0}^{1} g(x)^2 f_X(x)\\,dx = \\int_{0}^{1} g(x)^2 \\,dx\n$$\n所以，SMC方法的方差为：\n$$\n\\operatorname{Var}(g(X_1)) = \\int_{0}^{1} g(x)^2 \\,dx - I^2\n$$\n\n结合这些结果，相对效率的一般表达式为：\n$$\nR(g) = \\frac{I(1-I)}{\\int_{0}^{1} g(x)^2 \\,dx - I^2}\n$$\n\n现在我们将此公式应用于两个指定的函数。\n\n情况1：$g_1(x) = \\mathbf{1}\\{x \\le p\\}$，其中 $p \\in (0,1)$。\n首先，我们计算积分 $I_1$：\n$$\nI_1 = \\int_{0}^{1} g_1(x)\\,dx = \\int_{0}^{1} \\mathbf{1}\\{x \\le p\\}\\,dx = \\int_{0}^{p} 1 \\,dx = p\n$$\n接下来，我们计算函数平方的积分。由于 $g_1(x)$ 只取值 $0$ 和 $1$，因此 $g_1(x)^2 = g_1(x)$。\n$$\n\\int_{0}^{1} g_1(x)^2 \\,dx = \\int_{0}^{1} g_1(x)\\,dx = p\n$$\n现在，我们将这些代入 $R(g_1)$ 的表达式中：\n$$\nR(g_1) = \\frac{I_1(1-I_1)}{\\int_{0}^{1} g_1(x)^2 \\,dx - I_1^2} = \\frac{p(1-p)}{p - p^2} = \\frac{p(1-p)}{p(1-p)} = 1\n$$\n这个结果是符合预期的，因为对于一个示性函数，SMC随机变量 $g_1(X_1)$ 本身就是一个参数为 $p$ 的伯努利变量，其分布与HOM变量 $H_1$ 相同。\n\n情况2：$g_2(x)=\\begin{cases} 1, x\\in[0,q] \\\\ \\epsilon, x\\in(q,1] \\end{cases}$，其中 $q \\in (0,1)$ 且 $\\epsilon \\in (0,1)$。\n首先，我们计算积分 $I_2$：\n$$\nI_2 = \\int_{0}^{1} g_2(x)\\,dx = \\int_{0}^{q} 1\\,dx + \\int_{q}^{1} \\epsilon\\,dx = q + \\epsilon(1-q)\n$$\n接下来，我们计算函数平方的积分：\n$$\n\\int_{0}^{1} g_2(x)^2 \\,dx = \\int_{0}^{q} 1^2\\,dx + \\int_{q}^{1} \\epsilon^2\\,dx = q + \\epsilon^2(1-q)\n$$\n现在我们计算 $R(g_2)$ 的分子和分母。\n分子是：\n$$\nI_2(1-I_2) = (q + \\epsilon(1-q))(1 - (q + \\epsilon(1-q))) = (q + \\epsilon(1-q))(1-q - \\epsilon(1-q))\n$$\n提取公因式：\n$$\nI_2(1-I_2) = (q(1-\\epsilon)+\\epsilon) \\cdot (1-q)(1-\\epsilon)\n$$\n分母是：\n$$\n\\int_{0}^{1} g_2(x)^2 \\,dx - I_2^2 = (q + \\epsilon^2(1-q)) - (q + \\epsilon(1-q))^2\n$$\n展开并简化：\n$$\n(q + \\epsilon^2(1-q)) - (q^2 + 2q\\epsilon(1-q) + \\epsilon^2(1-q)^2)\n$$\n$$\n= q - q^2 - 2q\\epsilon(1-q) + \\epsilon^2(1-q) - \\epsilon^2(1-q)^2\n$$\n提取因子 $(1-q)$：\n$$\n= (1-q)[q - 2q\\epsilon + \\epsilon^2 - \\epsilon^2(1-q)]\n$$\n$$\n= (1-q)[q - 2q\\epsilon + \\epsilon^2 - \\epsilon^2 + q\\epsilon^2]\n$$\n$$\n= (1-q)[q - 2q\\epsilon + q\\epsilon^2]\n$$\n提取因子 $q$：\n$$\n= q(1-q)[1 - 2\\epsilon + \\epsilon^2] = q(1-q)(1-\\epsilon)^2\n$$\n现在，我们构造比率 $R(g_2)$：\n$$\nR(g_2) = \\frac{(q(1-\\epsilon)+\\epsilon)(1-q)(1-\\epsilon)}{q(1-q)(1-\\epsilon)^2}\n$$\n由于 $q \\in (0,1)$ 且 $\\epsilon \\in (0,1)$，我们有 $1-q \\ne 0$ 和 $1-\\epsilon \\ne 0$，所以我们可以消去这些项：\n$$\nR(g_2) = \\frac{q(1-\\epsilon)+\\epsilon}{q(1-\\epsilon)} = \\frac{q(1-\\epsilon)}{q(1-\\epsilon)} + \\frac{\\epsilon}{q(1-\\epsilon)} = 1 + \\frac{\\epsilon}{q(1-\\epsilon)}\n$$\n该表达式表明，对于 $g_2$，HOM方法的效率严格低于（即方差更大，因为 $R(g_2)>1$）SMC方法。当 $q \\to 0^+$ 时，其低效性会任意增大。\n\n两个结果是 $R(g_1)=1$ 和 $R(g_2)=1 + \\frac{\\epsilon}{q(1-\\epsilon)}$。", "answer": "$$\n\\boxed{\\begin{pmatrix} 1 & 1 + \\frac{\\epsilon}{q(1-\\epsilon)} \\end{pmatrix}}\n$$", "id": "3312391"}, {"introduction": "从理论走向实践，我们必须认识到所有蒙特卡洛方法的理论保证都建立在高质量随机数的基础之上。这个动手编程练习模拟了一个常见的现实世界陷阱：使用有缺陷的伪随机数生成器。您将亲眼看到，生成器中隐藏的相关性会如何引入系统性偏差，并学习如何通过数值诊断来发现这些问题，从而体会到随机数源质量的关键性 [@problem_id:3253644]。", "problem": "考虑通过击中-脱靶蒙特卡洛方法估计数学常数 $\\pi$。该方法在单位正方形 $[0,1]^2$ 中采样点，并计算落在单位四分之一圆 $\\{(x,y)\\in[0,1]^2 \\mid x^2+y^2\\le 1\\}$ 内的点的比例。将包含 $n$ 个点的估计量定义为\n$$\n\\widehat{\\pi}_n \\;=\\; \\frac{4}{n}\\sum_{k=1}^{n}\\mathbf{1}\\big\\{X_k^2+Y_k^2\\le 1\\big\\},\n$$\n其中每个 $(X_k,Y_k)$ 是 $[0,1]^2$ 中的一个点。对于独立同分布 (i.i.d.) 的均匀输入，已知该过程在标准条件下是一致且无偏的。\n\n在本问题中，您将：\n- 推导当点由线性同余生成器 (LCG) 生成时估计量的偏差。LCG 定义为 $U_{k+1}=(aU_k+c)\\bmod m$，其中 $U_k\\in\\{0,1,\\dots,m-1\\}$，$a,c,m$ 是整数且 $m\\ge 2$，并且到单位正方形的映射为 $X_k=U_k/m$，$Y_k=U_{k+1}/m$。\n- 使用有原则的数值诊断方法检测生成点集中的相关性伪影。\n\n从以下基本基础开始：\n- 对于在 $[0,1]^2$ 上独立同分布的均匀变量 $(X_k,Y_k)$，指示函数 $\\mathbf{1}\\{X_k^2+Y_k^2\\le 1\\}$ 的期望值等于四分之一圆的面积，即 $\\pi/4$。\n- 对于一个在 $U\\in\\{0,1,\\dots,m-1\\}$ 上进行完全遍历的 LCG，点对 $(X,Y)=(U/m,((aU+c)\\bmod m)/m)$ 的导出二维分布是在 $m$ 个点的集合 $\\mathcal{S}_m=\\{(U/m,((aU+c)\\bmod m)/m):U\\in\\{0,1,\\dots,m-1\\}\\}$ 上的离散均匀分布。\n\n任务：\n1. 从第一性原理出发，推导在 $[0,1]^2$ 上独立同分布的均匀变量 $(X_k,Y_k)$ 的情况下 $\\widehat{\\pi}_n$ 的期望值，并判断在该设置下估计量是否是无偏的，并说明原因。\n2. 对于 LCG 在 $\\mathcal{S}_m$ 上导出的离散分布，纯粹根据有限集 $\\mathcal{S}_m$ 上的期望定义，推导精确的全周期偏差公式\n$$\nb_m \\;=\\; \\frac{4}{m}\\sum_{U=0}^{m-1}\\mathbf{1}\\Big\\{\\Big(\\frac{U}{m}\\Big)^2+\\Big(\\frac{(aU+c)\\bmod m}{m}\\Big)^2\\le 1\\Big\\}\\;-\\;\\pi,\n$$\n并解释该偏差如何以及为何可以不为 $0$。\n3. 提出并论证两种数值诊断方法，用于检测经验点集 $\\{(X_k,Y_k)\\}_{k=1}^n$ 中的相关性伪影：\n   - $X_k$ 和 $Y_k$ 之间的样本 Pearson 相关系数，定义为\n   $$\n   r \\;=\\; \\frac{\\operatorname{Cov}(X,Y)}{\\sqrt{\\operatorname{Var}(X)}\\sqrt{\\operatorname{Var}(Y)}},\n   $$\n   根据 $n$ 个点计算，约定当 $n<2$ 时 $r=0$，如果任一经验标准差为 $0$，则设置 $r=1$ 以反映完全退化。\n   - 在 $[0,1]^2$ 上的一个 $B\\times B$ 网格上使用 $\\chi^2$ 统计量进行二维均匀性检验：\n   $$\n   \\chi^2 \\;=\\; \\sum_{i=1}^{B}\\sum_{j=1}^{B}\\frac{(O_{ij}-E)^2}{E},\n   $$\n   其中 $O_{ij}$ 是在单元格 $(i,j)$ 中的观测计数，$E=n/B^2$ 是在均匀性假设下的期望计数。使用 $B=20$。自由度视为 $\\nu=B^2-1$。如果 $|r|>0.05$ 或 $\\chi^2 > \\nu + 3\\sqrt{2\\nu}$，则判定存在伪影。\n\n实现要求：\n- 实现一个 LCG 点生成器，给定 $(a,c,m)$、种子 $U_0$ 和点数 $n$，通过 $X_k=U_k/m$，$Y_k=U_{k+1}/m$ 生成 $(X_k,Y_k)$。\n- 使用指定的诊断方法和决策规则，计算样本估计值 $\\widehat{\\pi}_n$、样本偏差 $b_n=\\widehat{\\pi}_n-\\pi$、如上定义的全周期格点偏差 $b_m$ 以及伪影标志 (一个布尔值)。\n- 本问题中不使用角度，因此无需指定角度单位。\n\n测试套件：\n使用以下参数集来评估和报告结果。每个测试用例是一个元组 $(a,c,m,U_0,n)$。\n- 案例 1：$(6137,17,9973,42,10000)$。\n- 案例 2：$(1,1,9973,0,5000)$。\n- 案例 3：$(5,1,64,1,64)$。\n- 案例 4：$(1,0,100,7,100)$。\n- 案例 5：$(6137,17,9973,123,1)$。\n\n答案规格：\n- 对每个案例，按顺序计算并输出四个值：估计量 $\\widehat{\\pi}_n$、样本偏差 $b_n$、全周期格点偏差 $b_m$ 和伪影标志 (一个布尔值)。\n- 您的程序应生成单行输出，其中包含所有案例的结果，形式为一个用方括号括起来的逗号分隔列表，将各案例的结果按顺序聚合为一个扁平列表，即 $[\\widehat{\\pi}_n^{(1)},b_n^{(1)},b_m^{(1)},\\text{artifact}^{(1)},\\widehat{\\pi}_n^{(2)},b_n^{(2)},b_m^{(2)},\\text{artifact}^{(2)},\\dots]$。\n\n执行约束：\n- 最终答案必须是一个完整的、可运行的 Python 程序，版本为 $3.12$，仅使用标准库和 Numerical Python (NumPy) 库版本 $1.23.5$。\n- 程序必须是自包含的，且不要求任何输入。", "solution": "该问题是有效的。它在科学上基于蒙特卡洛方法和伪随机数生成器分析的原理。问题提法恰当，提供了所有必要的定义、常数和测试用例，以推导和计算出唯一且有意义的解。所有任务都可以在概率论、统计学和数值分析领域内形式化。\n\n我们通过解决三个指定的任务来继续解答。\n\n### 任务 1：对于独立同分布均匀点的估计量的无偏性\n\n$\\pi$ 的估计量定义为\n$$\n\\widehat{\\pi}_n = \\frac{4}{n}\\sum_{k=1}^{n}\\mathbf{1}\\big\\{X_k^2+Y_k^2\\le 1\\big\\}\n$$\n其中假设 $(X_k, Y_k)$ 是独立同分布 (i.i.d.) 的随机变量，从单位正方形 $[0,1]^2$ 中均匀采样。\n\n为了确定估计量是否是无偏的，我们必须计算其期望值 $E[\\widehat{\\pi}_n]$，并检查它是否等于真实值 $\\pi$。\n\n根据期望的线性性质，我们有：\n$$\nE[\\widehat{\\pi}_n] = E\\left[\\frac{4}{n}\\sum_{k=1}^{n}\\mathbf{1}\\{X_k^2+Y_k^2\\le 1\\}\\right] = \\frac{4}{n}\\sum_{k=1}^{n}E\\left[\\mathbf{1}\\{X_k^2+Y_k^2\\le 1\\}\\right]\n$$\n\n由于点 $(X_k, Y_k)$ 是独立同分布的，因此指示函数的期望值对于所有 $k \\in \\{1, \\dots, n\\}$ 都是相同的。我们用 $(X, Y)$ 表示一个一般点。指示函数的期望是它所指示事件的概率：\n$$\nE\\left[\\mathbf{1}\\{X^2+Y^2\\le 1\\}\\right] = P(X^2+Y^2 \\le 1)\n$$\n\n点 $(X, Y)$ 是从单位正方形 $[0,1]^2$ 中均匀抽取的，其面积为 $1^2=1$。对于 $(X,Y) \\in [0,1]^2$，事件 $X^2+Y^2 \\le 1$ 描述了位于第一象限的单位圆区域，即一个半径为 $1$ 的四分之一圆。这个四分之一圆的面积是 $\\frac{1}{4}\\pi r^2 = \\frac{1}{4}\\pi (1)^2 = \\frac{\\pi}{4}$。\n\n一个均匀抽取的点落入该区域的概率是面积之比：\n$$\nP(X^2+Y^2 \\le 1) = \\frac{\\text{Area of quarter circle}}{\\text{Area of unit square}} = \\frac{\\pi/4}{1} = \\frac{\\pi}{4}\n$$\n\n将这个常数期望代回到 $E[\\widehat{\\pi}_n]$ 的表达式中：\n$$\nE[\\widehat{\\pi}_n] = \\frac{4}{n}\\sum_{k=1}^{n}\\left(\\frac{\\pi}{4}\\right) = \\frac{4}{n} \\cdot n \\cdot \\frac{\\pi}{4} = \\pi\n$$\n\n由于 $E[\\widehat{\\pi}_n] = \\pi$，因此在独立同分布均匀随机点的假设下，该估计量是无偏的。\n\n### 任务 2：线性同余生成器 (LCG) 的全周期偏差\n\n对于一个周期长度为 $m$ 的 LCG，生成的点对 $(X,Y)$ 集合不是一个连续均匀分布，而是在一个包含 $m$ 个点的有限集上的离散均匀分布：\n$$\n\\mathcal{S}_m = \\left\\{\\left(\\frac{U}{m}, \\frac{(aU+c)\\bmod m}{m}\\right) : U \\in \\{0, 1, \\dots, m-1\\}\\right\\}\n$$\n$\\mathcal{S}_m$ 中的每个点出现的概率为 $1/m$。\n\n在这个离散分布上，估计量的期望值（我们称之为 $E_m[\\widehat{\\pi}]$）表示估计量在一个完整周期内的平均值。这可以通过考虑一个从 $\\mathcal{S}_m$ 中均匀抽取的单点 $(X,Y)$ 来计算。\n$$\nE_m[\\widehat{\\pi}] = E_m\\left[4 \\cdot \\mathbf{1}\\{X^2+Y^2\\le 1\\}\\right] = 4 \\cdot E_m\\left[\\mathbf{1}\\{X^2+Y^2\\le 1\\}\\right]\n$$\n\n指示函数在离散集 $\\mathcal{S}_m$ 上的期望是其在每个点上的值乘以该点的概率（$1/m$）后的总和：\n$$\nE_m\\left[\\mathbf{1}\\{X^2+Y^2\\le 1\\}\\right] = \\sum_{(x,y) \\in \\mathcal{S}_m} P((X,Y)=(x,y)) \\cdot \\mathbf{1}\\{x^2+y^2\\le 1\\} = \\frac{1}{m}\\sum_{(x,y) \\in \\mathcal{S}_m} \\mathbf{1}\\{x^2+y^2\\le 1\\}\n$$\n代入 $\\mathcal{S}_m$ 中点的显式形式：\n$$\nE_m\\left[\\mathbf{1}\\{X^2+Y^2\\le 1\\}\\right] = \\frac{1}{m}\\sum_{U=0}^{m-1}\\mathbf{1}\\left\\{\\left(\\frac{U}{m}\\right)^2 + \\left(\\frac{(aU+c)\\bmod m}{m}\\right)^2 \\le 1\\right\\}\n$$\n因此，估计量在一个完整周期内的期望值为：\n$$\nE_m[\\widehat{\\pi}] = \\frac{4}{m}\\sum_{U=0}^{m-1}\\mathbf{1}\\left\\{\\left(\\frac{U}{m}\\right)^2 + \\left(\\frac{(aU+c)\\bmod m}{m}\\right)^2 \\le 1\\right\\}\n$$\n偏差 $b_m$ 定义为估计量的期望值减去真实值 $\\pi$。这就得出了指定的公式：\n$$\nb_m = E_m[\\widehat{\\pi}] - \\pi = \\frac{4}{m}\\sum_{U=0}^{m-1}\\mathbf{1}\\left\\{\\left(\\frac{U}{m}\\right)^2 + \\left(\\frac{(aU+c)\\bmod m}{m}\\right)^2 \\le 1\\right\\} - \\pi\n$$\n这个偏差 $b_m$ 可能不为零，因为 LCG 生成的点并不均匀地覆盖单位正方形。相反，它们位于一个确定性的网格或格点结构上。公式中的求和是在这个特定的、高度结构化的网格上进行的数值求积（积分的近似）。与真正的连续均匀分布相比，点的离散性和规则模式可能导致对四分之一圆内点的系统性多算或少算，从而产生一个结构性偏差 $b_m \\neq 0$。\n\n### 任务 3：数值诊断方法的论证\n\n问题提出了两种诊断方法来检测 LCGs 中固有的相关性伪影，这些伪影违反了独立同分布均匀假设。\n\n1.  **样本 Pearson 相关系数 ($r$)**：\n    LCG 生成的点对 $(X_k, Y_k)$ 是 $(U_k/m, U_{k+1}/m)$。LCG 的递推关系是 $U_{k+1} = (aU_k+c) \\bmod m$。这意味着 $Y_k = ((a m X_k + c) \\bmod m) / m$。这是 $X_k$ 和 $Y_k$ 之间的一种分段线性关系。真正的独立同分布均匀变量具有零相关性。LCG 中的确定性、类线性关系会引发非零相关性。样本 Pearson 相关系数 $r$ 是量化两个变量之间线性关联强度的标准统计度量。$|r|$ 的值显著大于零（此处为 $|r| > 0.05$）是一个直接而有力的指标，表明样本不是独立的，揭示了生成器潜在的序列依赖性。\n\n2.  **二维均匀性检验（$\\chi^2$ 统计量）**：\n    在 $[0,1]^2$ 上的独立同分布均匀样本的一个基本特性是空间均匀性；点应该均匀地分布在整个正方形内。然而，LCG 生成的点被限制在平行超平面的一个格点上。在二维中，这意味着所有点 $(X_k, Y_k)$ 都落在少数几条平行线上。因此，单位正方形内将存在大片完全不包含任何点的区域。$\\chi^2$ 拟合优度检验旨在检测与假设分布（此处为均匀分布）的这种偏差。通过将正方形划分为一个 $B \\times B$ 的网格，并将每个单元格中的观测计数（$O_{ij}$）与期望计数（$E=n/B^2$）进行比较，$\\chi^2$ 统计量可以量化与均匀性的偏离程度。LCG 的格点结构将导致许多单元格为空（$O_{ij}=0$），而其他单元格则点数过多，从而导致一个很大的 $\\chi^2$ 值。这标志着空间均匀性假设不成立。阈值 $\\nu + 3\\sqrt{2\\nu}$ 是一个标记显著偏差的合理标准，对于具有大量自由度 $\\nu$ 的 $\\chi^2$ 分布，这对应于一个比均值高出三个以上标准差的值。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the Monte Carlo problem for all specified test cases.\n    \"\"\"\n    # Define the constant pi for bias calculations.\n    PI = np.pi\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (a, c, m, U0, n)\n        (6137, 17, 9973, 42, 10000),\n        (1, 1, 9973, 0, 5000),\n        (5, 1, 64, 1, 64),\n        (1, 0, 100, 7, 100),\n        (6137, 17, 9973, 123, 1),\n    ]\n\n    results = []\n    for a, c, m, u0, n in test_cases:\n        # --- 1. Generate LCG points ---\n        # U_vals stores the sequence U_0, U_1, ..., U_n\n        # Use np.int64 to prevent overflow on intermediate products (a * U_k)\n        u_vals = np.zeros(n + 1, dtype=np.int64)\n        u_vals[0] = u0\n        for k in range(n):\n            u_vals[k+1] = (a * u_vals[k] + c) % m\n        \n        # Create n points (X_k, Y_k) where X_k = U_k/m, Y_k = U_{k+1}/m\n        # X is from U_0, ..., U_{n-1}\n        # Y is from U_1, ..., U_{n}\n        X = u_vals[:-1] / m\n        Y = u_vals[1:] / m\n\n        # --- 2. Compute estimator and sample bias ---\n        pi_hat_n = 0.0\n        b_n = -PI\n        if n > 0:\n            is_inside_sample = (X**2 + Y**2) = 1\n            pi_hat_n = 4 * np.sum(is_inside_sample) / n\n            b_n = pi_hat_n - PI\n\n        # --- 3. Compute full-period lattice bias ---\n        # Generate all m points of the LCG lattice\n        U_full = np.arange(m, dtype=np.int64)\n        Y_full_ints = (a * U_full + c) % m\n        \n        X_full = U_full / m\n        Y_full = Y_full_ints / m\n        \n        is_inside_full = (X_full**2 + Y_full**2) = 1\n        pi_hat_full = 4 * np.sum(is_inside_full) / m\n        b_m = pi_hat_full - PI\n\n        # --- 4. Compute artifact flag ---\n        # 4a. Pearson correlation artifact\n        r = 0.0\n        if n >= 2:\n            # Using population variance (ddof=0) as per numpy default.\n            # The definition of Pearson r is invariant to ddof.\n            var_X = np.var(X)\n            var_Y = np.var(Y)\n            if var_X == 0 or var_Y == 0:\n                r = 1.0  # As per problem specification for degenerate cases\n            else:\n                # Manual calculation of covariance for clarity\n                cov_XY = np.mean((X - np.mean(X)) * (Y - np.mean(Y)))\n                r = cov_XY / np.sqrt(var_X * var_Y)\n\n        corr_artifact = abs(r) > 0.05\n        \n        # 4b. Chi-squared uniformity artifact\n        B = 20\n        chi2_artifact = False\n        if n > 0:\n            E = n / (B**2)\n            # np.histogram2d bins the data into a 2D grid\n            O, _, _ = np.histogram2d(X, Y, bins=B, range=[[0, 1], [0, 1]])\n            \n            # The formula is valid for E > 0, which holds for n > 0\n            chi2_val = np.sum((O - E)**2 / E)\n            \n            nu = B**2 - 1  # Degrees of freedom\n            chi2_threshold = nu + 3 * np.sqrt(2 * nu)\n            \n            chi2_artifact = chi2_val > chi2_threshold\n\n        # 4c. Combine flags for final verdict\n        artifact = corr_artifact or chi2_artifact\n\n        results.extend([pi_hat_n, b_n, b_m, artifact])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3253644"}]}