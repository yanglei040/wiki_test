{"hands_on_practices": [{"introduction": "谐波平均估计量 (Harmonic Mean Estimator, HME) 的不可靠性不仅仅是数值计算上的问题，其根源在于一个根本的统计缺陷。这项练习通过一个简化的“玩具模型”来精确地分离出导致其不稳定的机制。通过对比两种情况——一种是似然函数的倒数 $U(\\theta)$ 有界，另一种是无界——我们能清楚地看到为何该估计量的方差会爆炸式地增长，从而揭示其内在的统计不稳定性。[@problem_id:3311537]", "problem": "考虑一个贝叶斯模型，其参数空间为 $\\Theta \\subset \\mathbb{R}^{d}$，配备勒贝格测度，并有一个固定的观测数据值 $y$。边际似然（也称为证据）由积分 $Z = \\int_{\\Theta} p(y \\mid \\theta)\\,\\pi(\\theta)\\,d\\theta$ 定义，后验密度由 $p(\\theta \\mid y) \\propto p(y \\mid \\theta)\\,\\pi(\\theta)$ 定义，其中 $\\pi(\\theta)$ 是一个正常的先验密度。谐波平均（HM）估计量通过从后验 $p(\\theta \\mid y)$ 中抽取独立样本 $\\theta^{(1)},\\dots,\\theta^{(M)}$ 并设置 $\\widehat{Z}_{\\mathrm{HM}} = \\left\\{\\frac{1}{M}\\sum_{m=1}^{M} U(\\theta^{(m)})\\right\\}^{-1}$ 来获得，其中 $U(\\theta) = \\frac{1}{p(y \\mid \\theta)}$。谐波平均估计量稳定性的一个充分条件是，$U(\\theta)$ 在后验分布下几乎必然有界。在本练习中，你将使用一个具有有界支撑的玩具似然函数来证明这种稳定性，然后将其与无界支撑的情况进行对比，以分离出不稳定的机制，整个过程仅使用核心定义和标准积分事实。\n\n首先假设存在一个可测集 $A \\subset \\Theta$，其勒贝格测度 $|A| \\in (0,\\infty)$ 是有限且严格为正的，使得似然函数为 $p(y \\mid \\theta) = \\mathbf{1}\\{\\theta \\in A\\}/|A|$，先验是在同一集合 $A$ 上的均匀密度 $\\pi(\\theta) = \\mathbf{1}\\{\\theta \\in A\\}/|A|$。\n\n1. 仅使用 $Z$ 和 $p(\\theta \\mid y)$ 的定义，计算这个有界支撑模型中的 $Z$ 和 $p(\\theta \\mid y)$。然后定义 $U(\\theta) = \\frac{1}{p(y \\mid \\theta)}$ 并确定其在 $p(\\theta \\mid y)$ 下的分布，包括其期望和方差。\n\n2. 使用 $\\widehat{Z}_{\\mathrm{HM}}$ 的定义和第1部分中得到的 $U(\\theta)$ 的分布性质，计算对于任何样本量 $M \\geq 1$ 的精确方差 $\\mathrm{Var}\\!\\left(\\widehat{Z}_{\\mathrm{HM}}\\right)$。你的答案必须是一个实数或一个封闭形式的解析表达式。不需要四舍五入。\n\n3. 现在用一个无界支撑的例子替换有界支撑的设置，以分离不稳定的机制。设 $\\pi(\\theta)$ 是 $\\mathbb{R}$ 上的高斯先验 $\\pi(\\theta) = \\varphi(\\theta; 0, \\tau_{0}^{2})$，其中 $\\varphi(\\,\\cdot\\,; \\mu, \\sigma^{2})$ 表示均值为 $\\mu$、方差为 $\\sigma^{2}$ 的正态密度，并设似然函数是关于 $\\theta \\in \\mathbb{R}$ 的函数 $p(y \\mid \\theta) = \\varphi(y; \\theta, \\sigma^{2})$。推导出一个关于常数 $c > 0$ 的充要条件，使得 $\\mathbb{E}_{p(\\theta \\mid y)}\\!\\left[\\exp\\!\\big(c\\,(\\theta - y)^{2}\\big)\\right]$ 是有限的，并用后验方差来表示这个条件。然后，在 $c = \\frac{1}{2\\sigma^{2}}$ 和 $c = \\frac{1}{\\sigma^{2}}$ 处评估此条件，以分别对 $\\mathbb{E}_{p(\\theta \\mid y)}[U(\\theta)]$ 和 $\\mathrm{Var}_{p(\\theta \\mid y)}(U(\\theta))$ 的有限性得出结论，并简要解释这种对比如何识别出 HM 估计量在无界支撑设置中变得不稳定的机制。\n\n只报告第2部分得到的 $\\mathrm{Var}\\!\\left(\\widehat{Z}_{\\mathrm{HM}}\\right)$ 的值作为你的最终答案。", "solution": "该问题要求在两种不同设置下分析边际似然 $Z$ 的谐波平均（HM）估计量：一种是稳定的有界支撑情况，另一种是可能不稳定的无界支撑情况。我们必须首先验证问题陈述。该问题是贝叶斯统计和蒙特卡洛方法中一个定义明确的理论练习。它提供了所有必要的定义，并使用标准的数学模型（均匀分布和正态分布）。该问题是自洽的、逻辑一致的、有科学依据的和客观的。没有任何缺陷会使其无效。我们可以继续进行解答。\n\n问题分为三个部分。我们将按顺序解答它们，以提供一个完整、有理有据的解决方案，尽管最终答案只需要第2部分的结果。\n\n**第1部分：有界支撑模型分析**\n\n首先，我们计算有界支撑模型的边际似然 $Z$ 和后验密度 $p(\\theta \\mid y)$。\n边际似然，或证据，定义为 $Z = \\int_{\\Theta} p(y \\mid \\theta)\\,\\pi(\\theta)\\,d\\theta$。\n给定的似然函数为 $p(y \\mid \\theta) = \\frac{\\mathbf{1}\\{\\theta \\in A\\}}{|A|}$，先验为 $\\pi(\\theta) = \\frac{\\mathbf{1}\\{\\theta \\in A\\}}{|A|}$，其中 $|A|$ 是集合 $A$ 的有限非零勒贝格测度。\n将这些代入 $Z$ 的定义：\n$$ Z = \\int_{\\Theta} \\left(\\frac{\\mathbf{1}\\{\\theta \\in A\\}}{|A|}\\right) \\left(\\frac{\\mathbf{1}\\{\\theta \\in A\\}}{|A|}\\right) \\,d\\theta = \\int_{\\Theta} \\frac{\\mathbf{1}\\{\\theta \\in A\\}}{|A|^2} \\,d\\theta $$\n由于被积函数在集合 $A$ 之外为零，我们可以将积分域更改为 $A$：\n$$ Z = \\frac{1}{|A|^2} \\int_{A} 1 \\,d\\theta = \\frac{1}{|A|^2} |A| = \\frac{1}{|A|} $$\n后验密度由贝叶斯定理给出，$p(\\theta \\mid y) = \\frac{p(y \\mid \\theta)\\pi(\\theta)}{Z}$。使用我们刚刚计算出的分子表达式和 $Z$ 的值：\n$$ p(\\theta \\mid y) = \\frac{\\frac{\\mathbf{1}\\{\\theta \\in A\\}}{|A|^2}}{\\frac{1}{|A|}} = \\frac{\\mathbf{1}\\{\\theta \\in A\\}}{|A|} $$\n这个结果表明 $\\theta$ 的后验分布是集合 $A$ 上的均匀分布。\n\n接下来，我们分析函数 $U(\\theta) = \\frac{1}{p(y \\mid \\theta)}$。谐波平均估计量是使用从后验分布 $p(\\theta \\mid y)$ 中抽取的样本 $\\theta^{(m)}$ 构建的。由于 $p(\\theta \\mid y)$ 的支撑集是集合 $A$，从该分布中抽取的任何样本 $\\theta$ 将几乎必然在 $A$ 中。对于任何 $\\theta \\in A$，似然函数是一个常数：$p(y \\mid \\theta) = \\frac{1}{|A|}$。\n因此，对于任何后验样本 $\\theta$，$U(\\theta)$ 的值为：\n$$ U(\\theta) = \\frac{1}{p(y \\mid \\theta)} = \\frac{1}{1/|A|} = |A| $$\n这意味着随机变量 $U(\\theta)$（其中 $\\theta \\sim p(\\theta \\mid y)$）是一个值为 $|A|$ 的常数。其概率分布是在 $|A|$ 处的一个点质量。\n这个常数随机变量的期望和方差很容易确定：\n$$ \\mathbb{E}_{p(\\theta \\mid y)}[U(\\theta)] = \\mathbb{E}[|A|] = |A| $$\n$$ \\mathrm{Var}_{p(\\theta \\mid y)}(U(\\theta)) = \\mathrm{Var}(|A|) = 0 $$\n这完成了第1部分所要求的分析。函数 $U(\\theta)$ 在后验下几乎必然有界（实际上是常数），这满足了 HM 估计量稳定性的充分条件。\n\n**第2部分：谐波平均估计量的方差**\n\n谐波平均估计量 $\\widehat{Z}_{\\mathrm{HM}}$ 定义为：\n$$ \\widehat{Z}_{\\mathrm{HM}} = \\left\\{\\frac{1}{M}\\sum_{m=1}^{M} U(\\theta^{(m)})\\right\\}^{-1} $$\n其中 $\\theta^{(1)}, \\dots, \\theta^{(M)}$ 是从后验 $p(\\theta \\mid y)$ 中抽取的独立样本。\n从第1部分我们知道，对于任何这样的样本 $\\theta^{(m)}$，$U(\\theta^{(m)})$ 的值确定性地等于 $|A|$。\n将此代入估计量的公式：\n$$ \\widehat{Z}_{\\mathrm{HM}} = \\left\\{\\frac{1}{M}\\sum_{m=1}^{M} |A|\\right\\}^{-1} = \\left\\{\\frac{1}{M} (M \\cdot |A|)\\right\\}^{-1} = \\left\\{|A|\\right\\}^{-1} = \\frac{1}{|A|} $$\n估计量 $\\widehat{Z}_{\\mathrm{HM}}$ 是一个随机变量，因为它依赖于随机样本 $\\{\\theta^{(m)}\\}$。然而，在这个特定模型中，对于任何后验样本集和任何样本量 $M \\geq 1$，它的值都是常数，等于 $\\frac{1}{|A|}$。它总是精确地等于真实的边际似然 $Z$。\n任何常数随机变量的方差都为零。因此，该模型中 HM 估计量的方差为：\n$$ \\mathrm{Var}\\!\\left(\\widehat{Z}_{\\mathrm{HM}}\\right) = \\mathrm{Var}\\!\\left(\\frac{1}{|A|}\\right) = 0 $$\n这就是问题所要求的最终答案。\n\n**第3部分：无界支撑情况与不稳定性机制**\n\n为了完整性并实现问题对比两种情况的目标，我们分析无界支撑的例子。\n在这个例子中，似然函数是 $p(y \\mid \\theta) = \\varphi(y; \\theta, \\sigma^{2})$（对应于单次观测，$n=1$），先验是 $\\pi(\\theta) = \\varphi(\\theta; 0, \\tau_{0}^{2})$。\nHM 估计量方差的有限性取决于 $\\mathbb{E}_{p(\\theta \\mid y)}[U(\\theta)^2]$ 是否有限，其中 $U(\\theta) = 1/p(y|\\theta)$。这等价于积分 $\\int_\\Theta \\frac{\\pi(\\theta)}{p(y \\mid \\theta)} \\, d\\theta$ 是否收敛。\n我们来考察被积函数 $\\frac{\\pi(\\theta)}{p(y \\mid \\theta)}$ 的形式：\n$$ \\frac{\\pi(\\theta)}{p(y \\mid \\theta)} = \\frac{\\frac{1}{\\sqrt{2\\pi\\tau_0^2}}\\exp(-\\frac{\\theta^2}{2\\tau_0^2})}{\\frac{1}{\\sqrt{2\\pi\\sigma^2}}\\exp(-\\frac{(\\theta-y)^2}{2\\sigma^2})} \\propto \\exp\\left(\\frac{(\\theta-y)^2}{2\\sigma^2} - \\frac{\\theta^2}{2\\tau_0^2}\\right) $$\n指数部分是一个关于 $\\theta$ 的二次函数：\n$$ \\frac{\\theta^2 - 2y\\theta + y^2}{2\\sigma^2} - \\frac{\\theta^2}{2\\tau_0^2} = \\frac{1}{2} \\left( \\frac{1}{\\sigma^2} - \\frac{1}{\\tau_0^2} \\right) \\theta^2 - \\left(\\frac{y}{\\sigma^2}\\right)\\theta + \\frac{y^2}{2\\sigma^2} $$\n为了使这个高斯型函数的积分收敛，$\\theta^2$ 的系数必须为负。因此，收敛的充要条件是：\n$$ \\frac{1}{\\sigma^2} - \\frac{1}{\\tau_0^2}  0 \\implies \\frac{1}{\\sigma^2}  \\frac{1}{\\tau_0^2} \\implies \\tau_0^2  \\sigma^2 $$\n这揭示了不稳定的机制。$U(\\theta)$ 的方差是有限的当且仅当先验方差足够小（$\\tau_0^2  \\sigma^2$）。如果先验是弥散的（$\\tau_0^2 \\ge \\sigma^2$），后验的尾部将不够细，无法抑制当 $\\theta$ 值远离 $y$ 时 $U(\\theta)^2 = 1/p(y \\mid \\theta)^2$ 的爆炸性增长。这导致 $U(\\theta)$ 的方差无限，从而导致 HM 估计量高度不稳定，因为它的抽样分布无法正常收敛。这与有界支撑的情况形成鲜明对比，在有界支撑情况下 $U(\\theta)$ 是有界的，导致估计量的方差为零。", "answer": "$$\n\\boxed{0}\n$$", "id": "3311537"}, {"introduction": "从统计理论转向计算实践，我们发现，即使HME的理论方差是有限的，其直接计算也常常因为数值溢出而失败。当似然函数的值变得极小时，其倒数会轻易超出计算机浮点数表示的上限。这项练习要求你使用对数似然和“log-sum-exp”技巧来稳健地实现HME，这是计算统计学家工具箱中的一项关键技术，旨在避免灾难性的数值错误。[@problem_id:3311572]", "problem": "考虑一个贝叶斯模型，其数据为 $y$，先验密度为 $p(\\theta)$，似然为 $L(\\theta) = p(y \\mid \\theta)$，后验密度为 $p(\\theta \\mid y) \\propto L(\\theta)p(\\theta)$。边缘似然（模型证据）为 $Z = p(y)$。谐波平均估计量 $\\hat Z_{\\mathrm{HM}}$ 使用从 $p(\\theta \\mid y)$ 中抽取的样本 $\\{\\theta_i\\}_{i=1}^n$ 和谐波平均的定义来构成\n$$\n\\hat Z_{\\mathrm{HM}} \\;=\\; \\left( \\frac{1}{n} \\sum_{i=1}^n \\frac{1}{L(\\theta_i)} \\right)^{-1}.\n$$\n假设你只能获取对数似然 $\\ell_i = \\log L(\\theta_i)$，并且必须在双精度浮点运算中计算 $\\hat Z_{\\mathrm{HM}}$，同时避免除了该估计量内在不稳定性所不可避免的之外的数值上溢或下溢。你的目标是基于对数似然提出一种数值稳定的计算方法，该方法利用一种通常称为“log-sum-exp 技巧”的常数移位累加策略，并分析其产生的上溢/下溢风险。\n\n选择一个选项，该选项能正确地用 $\\{\\ell_i\\}_{i=1}^n$ 来指定一个稳定的算法，并正确地描述双精度运算中的关键上溢/下溢风险（其中当 $x \\gtrsim 709$ 时 $\\exp(x)$ 会上溢，当 $x \\lesssim -745$ 时会下溢为零）。\n\nA. 令 $x_i = -\\ell_i$ 且 $m = \\max_{1 \\le i \\le n} x_i$。用浮点运算计算 $s = \\sum_{i=1}^n \\exp(x_i - m)$。然后计算 $\\log \\hat Z_{\\mathrm{HM}} = \\log n - \\big(m + \\log s\\big)$，如果需要，仅在 $|\\log \\hat Z_{\\mathrm{HM}}| \\lesssim 709$ 时才设 $\\hat Z_{\\mathrm{HM}} = \\exp(\\log \\hat Z_{\\mathrm{HM}})$；否则报告 $\\log \\hat Z_{\\mathrm{HM}}$ 以避免上溢/下溢。这可以防止在累加 $\\sum_{i=1}^n \\exp(-\\ell_i)$ 时发生上溢，因为所有指数 $x_i - m \\le 0$，并且任何发生下溢的指数项都对应于可忽略的贡献。该估计量在统计上仍然不稳定，因为最大的 $x_i$（最小的似然）可能起主导作用，但计算本身在数值上是良态的。\n\nB. 令 $x_i = -\\ell_i$ 且 $m = \\min_{1 \\le i \\le n} x_i$。计算 $s = \\sum_{i=1}^n \\exp(x_i - m)$，然后设 $\\hat Z_{\\mathrm{HM}} = \\frac{n}{\\exp(m)\\, s}$。因为移位使用了最小值，所以最大的项被降低了权重，从而避免了上溢；下溢不是一个问题，因为至少有一项是 $1$。\n\nC. 用 $\\hat Z_{\\mathrm{HM}} \\approx \\exp\\!\\left(\\log n - \\frac{1}{n}\\sum_{i=1}^n \\ell_i\\right)$ 来近似 $\\hat Z_{\\mathrm{HM}}$，这种方法是数值稳定的，因为它只使用了 $\\ell_i$ 的平均值。这种做法是合理的，因为对于大的 $n$，谐波平均接近于几何平均。\n\nD. 计算 $t_i = \\exp(-\\ell_i)$ 并使用成对求和或 Kahan 补偿求和来评估 $\\sum_{i=1}^n t_i$ 以避免灾难性抵消，然后设 $\\hat Z_{\\mathrm{HM}} = n/\\sum_{i=1}^n t_i$。由于补偿求和减少了舍入误差，因此在实践中可以避免上溢和下溢，并且结果是稳定的。\n\nE. 通过将每个 $\\ell_i$ 替换为 $\\tilde \\ell_i = \\max(\\ell_i, c)$（其中 $c$ 为某个固定常数）来截断对数似然，然后根据原始定义从 $\\{\\tilde \\ell_i\\}$ 计算 $\\hat Z_{\\mathrm{HM}}$。这可以防止最小的似然值起主导作用，从而在不引入有意义的偏差的情况下提高数值和统计稳定性。\n\n选择所有适用的选项。", "solution": "用户要求我验证并解决一个关于在贝叶斯背景下，对边缘似然的谐波平均估计量进行数值稳定计算的问题。\n\n### 步骤1：提取已知条件\n\n-   **模型背景**：贝叶斯模型，数据为 $y$，先验为 $p(\\theta)$，似然为 $L(\\theta) = p(y \\mid \\theta)$，后验为 $p(\\theta \\mid y) \\propto L(\\theta)p(\\theta)$。\n-   **待估算量**：边缘似然（模型证据），$Z = p(y)$。\n-   **估计量定义**：谐波平均估计量 $\\hat Z_{\\mathrm{HM}}$ 定义为：\n    $$ \\hat Z_{\\mathrm{HM}} \\;=\\; \\left( \\frac{1}{n} \\sum_{i=1}^n \\frac{1}{L(\\theta_i)} \\right)^{-1} $$\n    其中 $\\{\\theta_i\\}_{i=1}^n$ 是从后验分布 $p(\\theta \\mid y)$ 中抽取的样本。\n-   **输入数据**：一组对数似然，$\\{\\ell_i\\}_{i=1}^n$，其中 $\\ell_i = \\log L(\\theta_i)$。\n-   **计算环境**：双精度浮点运算。\n-   **数值约束**：当 $x \\gtrsim 709$ 时 $\\exp(x)$ 上溢，当 $x \\lesssim -745$ 时下溢为零。\n-   **目标**：使用常数移位“log-sum-exp 技巧”从 $\\{\\ell_i\\}$ 中提出一个数值稳定的计算 $\\hat Z_{\\mathrm{HM}}$ 的方法，并分析相关的上溢/下溢风险。\n\n### 步骤2：使用提取的已知条件进行验证\n\n1.  **科学或事实上的不健全**：无。问题陈述准确描述了谐波平均估计量，这是贝叶斯模型比较中一个已知（尽管常受批评）的方法。浮点运算中的上溢和下溢数值问题是真实存在的，并且描述准确。“log-sum-exp 技巧”是数值计算中一个标准且有效的方法。\n2.  **不可形式化或不相关**：无。该问题是计算统计学中一个定义明确的任务。\n3.  **不完整或矛盾的设置**：无。该问题提供了推导和评估计算策略所需的所有必要定义、输入和约束。\n4.  **不切实际或不可行**：无。该场景是在实现贝叶斯推断软件时会遇到的一个实际问题。浮点数限制代表了双精度数的 IEEE 754 标准。\n5.  **不适定或结构不良**：无。该问题要求一种特定类型的解决方案（使用特定技巧的稳定算法）并对其进行分析，这是一个适定的任务。\n6.  **伪深刻、琐碎或同义反复**：无。该问题需要对统计估计量和数值稳定性原理都有扎实的理解，并能区分两者。解决方案并非微不足道。\n7.  **超出科学可验证性范围**：无。所提出的算法可以被实现，其数值属性可以被验证。\n\n### 步骤3：结论和行动\n\n问题陈述是**有效的**。我将继续进行解决方案的推导和选项分析。\n\n### 稳定计算的推导\n\n谐波平均估计量由下式给出：\n$$ \\hat Z_{\\mathrm{HM}} = \\left( \\frac{1}{n} \\sum_{i=1}^n \\frac{1}{L(\\theta_i)} \\right)^{-1} = \\frac{n}{\\sum_{i=1}^n L(\\theta_i)^{-1}} $$\n我们已知对数似然 $\\ell_i = \\log L(\\theta_i)$。因此，$L(\\theta_i)^{-1} = (\\exp(\\ell_i))^{-1} = \\exp(-\\ell_i)$。\n该估计量可以用对数似然表示为：\n$$ \\hat Z_{\\mathrm{HM}} = \\frac{n}{\\sum_{i=1}^n \\exp(-\\ell_i)} $$\n主要的数值挑战在于计算总和 $S = \\sum_{i=1}^n \\exp(-\\ell_i)$。令 $x_i = -\\ell_i$。$\\ell_i$ 的值可以是大的正数或负数，对应于小的或大的 $x_i$ 值。如果任何 $x_i$ 是一个大的正数（例如，$x_i  709$），$\\exp(x_i)$ 项将会上溢。这种情况发生在似然 $L(\\theta_i)$ 非常小的时候，而这恰恰是谐波平均估计量在统计上不稳定的情况。\n\n为了在计算中防止这种上溢，我们使用“log-sum-exp”稳定化技巧。令 $m = \\max_{1 \\le i \\le n} x_i$。我们可以将总和 $S$ 重写为：\n$$ S = \\sum_{i=1}^n \\exp(x_i) = \\sum_{i=1}^n \\exp(x_i - m + m) = \\exp(m) \\sum_{i=1}^n \\exp(x_i - m) $$\n我们来分析新的总和，$s = \\sum_{i=1}^n \\exp(x_i - m)$。\n-   每一项的指数是 $x_i - m$。因为 $m$ 是所有 $x_i$ 的最大值，所以对所有 $i$ 都有 $x_i - m \\le 0$。\n-   因此，$\\exp(x_i - m) \\le \\exp(0) = 1$。和中任何一项的最大可能值为 $1$（当 $x_i=m$ 时出现）。这有效地防止了在计算单个项时发生上溢。\n-   如果 $x_i - m$ 是一个大的负数（例如，$x_i - m \\lesssim -745$），$\\exp(x_i - m)$ 项将下溢为 $0$。这在数值上是安全且可取的。这样的项对应于一个远小于最大值 $m$ 的 $x_i$ 值。原始项 $\\exp(x_i)$ 与最大项 $\\exp(m)$ 相比本可以忽略不计，因此其对总和的贡献可以被忽略而不会有显著的数值精度损失。\n\n整个计算最好在对数域中进行，以管理最终结果可能的全范围值。\n估计量的对数是：\n$$ \\log \\hat Z_{\\mathrm{HM}} = \\log(n) - \\log(S) $$\n使用我们对 $S$ 的稳定化表达式：\n$$ \\log S = \\log\\left(\\exp(m) \\sum_{i=1}^n \\exp(x_i - m)\\right) = \\log(\\exp(m)) + \\log\\left(\\sum_{i=1}^n \\exp(x_i - m)\\right) = m + \\log(s) $$\n所以，计算估计量对数的稳定算法是：\n$$ \\log \\hat Z_{\\mathrm{HM}} = \\log(n) - (m + \\log s) = \\log n - m - \\log \\left(\\sum_{i=1}^n \\exp(x_i - m)\\right) $$\n其中 $x_i = -\\ell_i$ 且 $m = \\max_i x_i$。这个 $\\log \\hat Z_{\\mathrm{HM}}$ 的公式是数值稳健的。然后可以计算最终值 $\\hat Z_{\\mathrm{HM}} = \\exp(\\log \\hat Z_{\\mathrm{HM}})$，但如果 $\\log \\hat Z_{\\mathrm{HM}}$ 超出范围 $[-745, 709]$，最好报告其对数值以避免最终的上溢或下溢。\n\n将这种计算稳定性与估计量的统计不稳定性区分开来是至关重要的。上述方法为给定的样本 $\\{\\theta_i\\}$ 精确计算了 $\\hat Z_{\\mathrm{HM}}$ 的值。然而，估计量本身具有无限方差，因为它被后验分布尾部那些似然非常小（即 $x_i = -\\ell_i$ 非常大）的罕见样本所主导。选择 $m = \\max_i x_i$ 清楚地表明，计算取决于具有最小似然的单个样本，这正是统计不稳定性的根源。log-sum-exp 技巧修正了算术问题，而不是统计问题。\n\n### 逐项分析\n\n**A. 令 $x_i = -\\ell_i$ 且 $m = \\max_{1 \\le i \\le n} x_i$。用浮点运算计算 $s = \\sum_{i=1}^n \\exp(x_i - m)$。然后计算 $\\log \\hat Z_{\\mathrm{HM}} = \\log n - \\big(m + \\log s\\big)$，如果需要，仅在 $|\\log \\hat Z_{\\mathrm{HM}}| \\lesssim 709$ 时才设 $\\hat Z_{\\mathrm{HM}} = \\exp(\\log \\hat Z_{\\mathrm{HM}})$；否则报告 $\\log \\hat Z_{\\mathrm{HM}}$ 以避免上溢/下溢。这可以防止在累加 $\\sum_{i=1}^n \\exp(-\\ell_i)$ 时发生上溢，因为所有指数 $x_i - m \\le 0$，并且任何发生下溢的指数项都对应于可忽略的贡献。该估计量在统计上仍然不稳定，因为最大的 $x_i$（最小的似然）可能起主导作用，但计算本身在数值上是良态的。**\n\n这个选项与推导出的稳定算法完全匹配。\n1.  它正确地确定了变换 $x_i = -\\ell_i$。\n2.  它正确地使用了最大值 $m$ 作为 log-sum-exp 技巧的移位常数。\n3.  它为估计量的对数提供了正确的公式：$\\log \\hat Z_{\\mathrm{HM}} = \\log n - (m + \\log s)$。\n4.  它正确地描述了处理最终指数化计算的标准程序。\n5.  它给出了一个精确且正确的解释，说明为什么这个过程可以避免上溢并安全地处理下溢。\n6.  关键是，它正确地区分了计算所实现的数值稳定性与估计量本身仍然存在的统计不稳定性。\n**结论：正确。**\n\n**B. 令 $x_i = -\\ell_i$ 且 $m = \\min_{1 \\le i \\le n} x_i$。计算 $s = \\sum_{i=1}^n \\exp(x_i - m)$，然后设 $\\hat Z_{\\mathrm{HM}} = \\frac{n}{\\exp(m)\\, s}$。因为移位使用了最小值，所以最大的项被降低了权重，从而避免了上溢；下溢不是一个问题，因为至少有一项是 $1$。**\n\n这个选项建议使用指数的最小值 $m = \\min_i x_i$。在和 $\\sum_i \\exp(x_i - m)$ 中，指数 $x_i - m$ 现在都是非负的。对应于 $\\max_i x_i$ 的项将具有 $\\max_i x_i - \\min_i x_i$ 的指数，这可能是一个非常大的正数，直接导致上溢。`最大的项被降低了权重`的理由是错误的；减去最小值会*放大*最大项和最小值之间的差异，从而加剧上溢。\n**结论：错误。**\n\n**C. 用 $\\hat Z_{\\mathrm{HM}} \\approx \\exp\\!\\left(\\log n - \\frac{1}{n}\\sum_{i=1}^n \\ell_i\\right)$ 来近似 $\\hat Z_{\\mathrm{HM}}$，这种方法是数值稳定的，因为它只使用了 $\\ell_i$ 的平均值。这种做法是合理的，因为对于大的 $n$，谐波平均接近于几何平均。**\n\n所提出的近似是 $\\hat Z_{\\mathrm{HM}} \\approx n \\cdot \\exp(-\\bar{\\ell})$，其中 $\\bar{\\ell}$ 是对数似然的算术平均值。真正的估计量是似然的调和平均值，$\\hat Z_{\\mathrm{HM}} = \\text{HM}(L_i)$。数量 $\\exp(\\bar{\\ell})$ 是似然的几何平均值，$\\text{GM}(L_i)$。因此该近似为 $\\text{HM}(L_i) \\approx n / \\text{GM}(L_i)$。没有普遍的数学原理支持这种近似。此外，`对于大的 n，谐波平均接近于几何平均`的理由通常是错误的。调和-几何-算术平均不等式指出，只有当所有值都相同时它们才相等；如果值的方差很大，它们可以相差很远，而这正是用于 HME 的似然的特点。此选项提出了一个不同的、数学上不合理的估计量，而不是对原始估计量进行稳定计算。\n**结论：错误。**\n\n**D. 计算 $t_i = \\exp(-\\ell_i)$ 并使用成对求和或 Kahan 补偿求和来评估 $\\sum_{i=1}^n t_i$ 以避免灾难性抵消，然后设 $\\hat Z_{\\mathrm{HM}} = n/\\sum_{i=1}^n t_i$。由于补偿求和减少了舍入误差，因此在实践中可以避免上溢和下溢，并且结果是稳定的。**\n\n这个选项未能解决主要的数值问题。第一步 `Compute $t_i = \\exp(-\\ell_i)$`，正是在任何 $-\\ell_i$ 很大的情况下会发生上溢的地方。Kahan 求和和其他类似技术旨在减轻因相加许多浮点数而导致的精度损失；它们对于防止项本身计算中的上溢或下溢没有任何作用。这个和由正数组成，所以灾难性抵消（减去几乎相等的数）在这里不是问题。声称补偿求和能避免上溢是错误的。\n**结论：错误。**\n\n**E. 通过将每个 $\\ell_i$ 替换为 $\\tilde \\ell_i = \\max(\\ell_i, c)$（其中 $c$ 为某个固定常数）来截断对数似然，然后根据原始定义从 $\\{\\tilde \\ell_i\\}$ 计算 $\\hat Z_{\\mathrm{HM}}$。这可以防止最小的似然值起主导作用，从而在不引入有意义的偏差的情况下提高数值和统计稳定性。**\n\n这个选项建议修改数据来解决问题。通过用截断值 $\\tilde \\ell_i = \\max(\\ell_i, c)$ 替换 $\\ell_i$，任何小于 $c$ 的对数似然都被提升到 $c$。这为似然设置了一个下界，$L(\\theta_i) \\ge \\exp(c)$，这反过来又为其倒数设置了一个上界，$1/L(\\theta_i) \\le \\exp(-c)$。这确实可以防止项 $\\exp(-\\ell_i)$ 变得任意大并导致上溢。然而，这不是对*原始*估计量的稳定计算；它是对一个*不同的、修改过的*估计量的精确计算。声称这样做“不会引入有意义的偏差”是没有根据的，并且通常是错误的。这个过程引入了一个难以量化的系统性偏差。目标是计算 $\\hat Z_{\\mathrm{HM}}$，而不是它的一个有偏版本。\n**结论：错误。**", "answer": "$$\\boxed{A}$$", "id": "3311572"}, {"introduction": "理论与实践的桥梁需要通过具体的模拟来搭建。这项练习将展示谐波平均估计量 (HME) 不稳定性在现实世界中的后果。通过将其在模型选择中的决策与真实情况 (ground truth) 以及一个更稳健的替代方案 (WBIC) 进行比较，你将亲眼见证HME如何在某些情况下得出错误的科学结论，从而深刻理解在实践中谨慎使用它的必要性。[@problem_id:3311539]", "problem": "您的任务是在一个具有弱可辨识性的嵌套模型设定中，对谐波平均估计量和广义贝叶斯信息准则（WBIC）用于贝叶斯模型证据的计算，进行一次基于模拟的、有原则的比较。重点是展示谐波平均估计器的不稳定性如何扭曲模型选择。背景是随机模拟和蒙特卡洛方法，使用正态似然和共轭正态先验。模拟过程必须完全独立且可复现。\n\n使用的基本原理是贝叶斯定理和边际似然（模型证据）的定义：对于数据 $y = (y_1,\\dots,y_n)$、似然 $p(y \\mid \\theta)$ 和先验 $p(\\theta)$，边际似然为 $Z = \\int p(y \\mid \\theta)\\, p(\\theta)\\, d\\theta$。后验分布为 $p(\\theta \\mid y) \\propto p(y \\mid \\theta)\\, p(\\theta)$。谐波平均估计量依赖于后验样本，并通过在 $p(\\theta \\mid y)$ 下对 $p(y \\mid \\theta)$ 的函数进行平均来形成对 $Z$ 的估计。广义贝叶斯信息准则（WBIC）通过在逆温度 $t = 1/\\log n$ 下的回火后验 $p_t(\\theta \\mid y) \\propto p(y \\mid \\theta)^t p(\\theta)$ 下，对负对数似然的期望来近似负对数边际似然。\n\n为标量参数 $\\mu$ 设定以下嵌套模型，其中方差 $\\sigma^2$ 已知，数据 $y_i \\sim \\mathcal{N}(\\mu_{\\text{true}}, \\sigma^2)$ 对于 $i = 1,\\dots,n$ 独立：\n\n- 模型 $\\mathcal{M}_0$：均值固定为 $\\mu = 0$（无自由参数）。\n- 模型 $\\mathcal{M}_1$：均值未知，其先验为 $\\mu \\sim \\mathcal{N}(0, \\tau^2)$。\n\n在 $\\mathcal{M}_1$ 下，后验是共轭正态分布。在 WBIC 下，逆温度为 $t$ 的回火后验也是正态分布。$\\mathcal{M}_1$ 下 $Z$ 的谐波平均估计量使用来自 $\\mu$ 的后验分布的样本。由于谐波平均估计量在常见设置中可能具有无穷大方差，因此已知其不稳定，并可能对模型选择产生误导。您的程序必须在精心选择的测试用例中展示这种效应。\n\n为每个测试用例实现以下步骤：\n\n1. 使用固定的伪随机种子 $314159$ 从 $\\mathcal{N}(\\mu_{\\text{true}}, \\sigma^2)$ 生成数据 $y_1, \\dots, y_n$，以确保可复现性。\n2. 当 $\\mu = 0$ 时，使用 $Z$ 的定义计算 $\\mathcal{M}_0$ 的精确对数边际似然 $\\log Z_0$。\n3. 通过使用正态-正态共轭性解析地积分掉 $\\mu$，计算 $\\mathcal{M}_1$ 的精确对数边际似然 $\\log Z_1$。不要假设任何快捷公式；在您的解决方案中从第一性原理推导，并在程序中实现推导出的表达式。\n4. 使用来自 $\\mathcal{M}_1$ 下精确后验 $p(\\mu \\mid y)$ 的 $M$ 个独立 $\\mu$ 样本，通过谐波平均估计量估计 $\\log Z_1$，其中 $M = 30000$。对 $1/p(y \\mid \\mu)$ 的谐波平均使用数值稳定的实现，以避免在评估极端 $\\mu$ 的似然时发生上溢或下溢。\n5. 使用来自逆温度 $t = 1/\\log n$ 的回火后验 $p_t(\\mu \\mid y)$ 的 $M$ 个样本，通过 WBIC 近似 $-\\log Z_1$；计算在 $p_t(\\mu \\mid y)$ 下 $-\\log p(y \\mid \\mu)$ 的蒙特卡洛期望。对于 $\\mathcal{M}_0$，请注意没有参数，因此 $-\\log Z_0$ 精确等于 $-\\log p(y \\mid \\mu=0)$。\n6. 通过三个标准来决定选择哪个模型：\n   - 谐波平均选择：如果 $\\log Z_0 > \\widehat{\\log Z_1}^{\\text{HM}}$，则选择 $\\mathcal{M}_0$，否则选择 $\\mathcal{M}_1$。\n   - WBIC 选择：如果 $-\\log Z_0  \\widehat{-\\log Z_1}^{\\text{WBIC}}$，则选择 $\\mathcal{M}_0$，否则选择 $\\mathcal{M}_1$。\n   - 基准真相选择：如果 $\\log Z_0 > \\log Z_1$，则选择 $\\mathcal{M}_0$，否则选择 $\\mathcal{M}_1$。\n7. 此外，对于每个测试用例，计算正态-正态共轭下谐波平均估计器的不稳定性指标：谐波平均估计量的方差是无穷大的当且仅当 $\\tau^2 > \\sigma^2 / n$。如果 $\\tau^2 > \\sigma^2 / n$，则将此指标输出为 $1$，否则输出为 $0$。\n\n测试套件：\n\n-   案例 A（不稳定，弱可辨识性）：$n = 20$，$\\sigma^2 = 1$，$\\tau^2 = 100$，$\\mu_{\\text{true}} = 0$。\n-   案例 B（更不稳定，更弱的可辨识性）：$n = 5$，$\\sigma^2 = 1$，$\\tau^2 = 1$，$\\mu_{\\text{true}} = 0$。\n-   案例 C（稳定区间，更强的可辨识性）：$n = 100$，$\\sigma^2 = 1$，$\\tau^2 = 0.005$，$\\mu_{\\text{true}} = 0.3$。\n\n您的程序应为每个案例生成列表 $[\\text{HM\\_sel}, \\text{WBIC\\_sel}, \\text{Truth\\_sel}, \\text{HM\\_unstable}]$，其中每个元素是 $\\{0,1\\}$ 中的一个整数，模型选择编码为：$\\mathcal{M}_0$ 为 $0$，$\\mathcal{M}_1$ 为 $1$。最终输出应将所有三个测试用例的结果聚合成单行，形式为用方括号括起来的逗号分隔列表，例如 $[[0,1,0,1],[0,0,0,1],[1,1,1,0]]$。\n\n最终输出格式：\n\n-   您的程序必须精确打印一行，其中包含一个包含三个列表的 Python 列表，分别对应案例 A、案例 B 和案例 C。每个内部列表必须是 $[\\text{HM\\_sel}, \\text{WBIC\\_sel}, \\text{Truth\\_sel}, \\text{HM\\_unstable}]$ 的形式。", "solution": "用户要求进行一项基于模拟的比较，旨在对比谐波平均估计量（HME）和广义贝叶斯信息准则（WBIC）在计算贝叶斯模型证据方面的表现。其目标是在一个以弱可辨识性为特征的嵌套模型设定中，展示HME的不稳定性。该问题定义明确，具有科学依据，并为可复现的模拟提供了所有必要信息。\n\n模拟设置涉及两个嵌套模型，数据 $y = (y_1, \\dots, y_n)$ 从正态分布 $y_i \\sim \\mathcal{N}(\\mu_{\\text{true}}, \\sigma^2)$ 中抽取。模型如下：\n- 模型 $\\mathcal{M}_0$：均值固定为 $\\mu=0$。\n- 模型 $\\mathcal{M}_1$：均值是一个随机变量，具有共轭正态先验 $\\mu \\sim \\mathcal{N}(0, \\tau^2)$。\n\n我们将为两个模型推导精确的边际似然，以建立模型选择的基准真相。然后，我们将构建HME和WBIC估计器，并用它们进行模型选择，将其结果与基准真相进行比较。\n\n**1. 解析边际似然（基准真相）**\n\n给定参数 $\\mu$ 和已知方差 $\\sigma^2$ 的数据 $y$ 的似然函数是：\n$$ p(y \\mid \\mu, \\sigma^2) = \\prod_{i=1}^n \\frac{1}{\\sqrt{2\\pi\\sigma^2}} \\exp\\left(-\\frac{(y_i - \\mu)^2}{2\\sigma^2}\\right) = (2\\pi\\sigma^2)^{-n/2} \\exp\\left(-\\frac{1}{2\\sigma^2}\\sum_{i=1}^n (y_i - \\mu)^2\\right) $$\n平方和可以根据样本均值 $\\bar{y} = \\frac{1}{n}\\sum_{i=1}^n y_i$ 重写：\n$$ \\sum_{i=1}^n (y_i - \\mu)^2 = \\sum_{i=1}^n (y_i - \\bar{y})^2 + n(\\bar{y} - \\mu)^2 $$\n因此，似然函数为：\n$$ p(y \\mid \\mu, \\sigma^2) = (2\\pi\\sigma^2)^{-n/2} \\exp\\left(-\\frac{\\sum_{i=1}^n (y_i - \\bar{y})^2}{2\\sigma^2}\\right) \\exp\\left(-\\frac{n(\\bar{y} - \\mu)^2}{2\\sigma^2}\\right) $$\n\n**模型 $\\mathcal{M}_0$:**\n对于 $\\mathcal{M}_0$，参数 $\\mu$ 固定为 $0$。边际似然 $Z_0$ 就是在 $\\mu=0$ 处计算的似然值：\n$$ Z_0 = p(y \\mid \\mu=0, \\sigma^2) = (2\\pi\\sigma^2)^{-n/2} \\exp\\left(-\\frac{1}{2\\sigma^2}\\sum_{i=1}^n y_i^2\\right) $$\n对数边际似然为：\n$$ \\log Z_0 = -\\frac{n}{2}\\log(2\\pi\\sigma^2) - \\frac{1}{2\\sigma^2}\\sum_{i=1}^n y_i^2 $$\n\n**模型 $\\mathcal{M}_1$:**\n对于 $\\mathcal{M}_1$，我们对 $\\mu$ 有一个先验，$p(\\mu) = \\mathcal{N}(\\mu \\mid 0, \\tau^2)$。边际似然 $Z_1$ 是通过将似然与先验的乘积对所有可能的 $\\mu$ 值进行积分得到的：\n$$ Z_1 = \\int_{-\\infty}^{\\infty} p(y \\mid \\mu, \\sigma^2) p(\\mu) \\,d\\mu $$\n指数中涉及 $\\mu$ 的项来自似然和先验，为：\n$$ -\\frac{n(\\mu - \\bar{y})^2}{2\\sigma^2} - \\frac{\\mu^2}{2\\tau^2} = -\\frac{1}{2}\\left[ \\left(\\frac{n}{\\sigma^2} + \\frac{1}{\\tau^2}\\right)\\mu^2 - \\frac{2n\\bar{y}}{\\sigma^2}\\mu + \\frac{n\\bar{y}^2}{\\sigma^2} \\right] $$\n我们对 $\\mu$ 进行配方。此表达式是一个二次型，对应于正态分布的指数部分。$\\mu$ 的后验分布是 $p(\\mu \\mid y) = \\mathcal{N}(\\mu \\mid \\mu_p, \\sigma_p^2)$，其后验方差为 $\\sigma_p^2 = \\left(\\frac{n}{\\sigma^2} + \\frac{1}{\\tau^2}\\right)^{-1}$，后验均值为 $\\mu_p = \\sigma_p^2 \\left(\\frac{n\\bar{y}}{\\sigma^2}\\right)$。配方后，指数变为：\n$$ -\\frac{(\\mu - \\mu_p)^2}{2\\sigma_p^2} - \\frac{n\\bar{y}^2}{2(\\sigma^2+n\\tau^2)} $$\n$Z_1$ 的积分为：\n$$ Z_1 = C \\cdot \\int_{-\\infty}^{\\infty} \\exp\\left(-\\frac{(\\mu - \\mu_p)^2}{2\\sigma_p^2}\\right) \\,d\\mu $$\n其中 $C$ 收集了所有不依赖于 $\\mu$ 的项。该积分的值为 $\\sqrt{2\\pi\\sigma_p^2}$。结合所有常数，我们得到边际似然 $Z_1$ 的解析表达式：\n$$ Z_1 = (2\\pi)^{-n/2} (\\sigma^2)^{-(n-1)/2} (n\\tau^2+\\sigma^2)^{-1/2} \\exp\\left(-\\frac{\\sum(y_i-\\bar{y})^2}{2\\sigma^2} - \\frac{n\\bar{y}^2}{2(n\\tau^2+\\sigma^2)}\\right) $$\n对数边际似然为：\n$$ \\log Z_1 = -\\frac{n}{2}\\log(2\\pi) -\\frac{n-1}{2}\\log(\\sigma^2) - \\frac{1}{2}\\log(n\\tau^2+\\sigma^2) - \\frac{\\sum(y_i-\\bar{y})^2}{2\\sigma^2} - \\frac{n\\bar{y}^2}{2(n\\tau^2+\\sigma^2)} $$\n$\\log Z_0$ 和 $\\log Z_1$ 的这些解析形式构成了我们模型比较的基准真相。\n\n**2. 谐波平均估计量 (HME)**\n\nHME 基于恒等式 $Z^{-1} = E_{p(\\theta \\mid y)}[p(y \\mid \\theta)^{-1}]$。对于模型 $\\mathcal{M}_1$，给定来自后验 $p(\\mu \\mid y)$ 的 $M$ 个样本 $\\mu^{(j)}$， $Z_1$ 的 HME 估计为：\n$$ \\widehat{Z_1}^{\\text{HM}} = \\left( \\frac{1}{M}\\sum_{j=1}^M \\frac{1}{p(y \\mid \\mu^{(j)})} \\right)^{-1} $$\n样本从我们早先推导出的后验分布中抽取：$\\mu \\sim \\mathcal{N}(\\mu_p, \\sigma_p^2)$。在数值上，使用 log-sum-exp 技巧在对数域中计算更为稳定，以防止上溢/下溢：\n$$ \\widehat{\\log Z_1}^{\\text{HM}} = -\\log\\left(\\frac{1}{M}\\sum_{j=1}^M \\exp(-\\log p(y \\mid \\mu^{(j)}))\\right) $$\nHME 的方差可能是无穷大的。对于正态-正态模型，这种情况发生的条件是当且仅当 $\\tau^2 > \\sigma^2/n$。这个条件表明了不稳定性，这是需要展示的一个关键方面。\n\n**3. 广义贝叶斯信息准则 (WBIC)**\n\nWBIC 提供了对数边际似然的一个近似。其定义为：\n$$ \\widehat{-\\log Z_1}^{\\text{WBIC}} = E_{p_t(\\mu \\mid y)}[-\\log p(y \\mid \\mu)] $$\n期望是在一个“回火”后验分布 $p_t(\\mu \\mid y) \\propto p(y \\mid \\mu)^t p(\\mu)$ 上计算的，其中逆温度 $t$ 设置为 $1/\\log n$。对于我们的模型 $\\mathcal{M}_1$，回火后验也是一个正态分布，$p_t(\\mu \\mid y) = \\mathcal{N}(\\mu \\mid \\mu_{p,t}, \\sigma_{p,t}^2)$，其参数为：\n$$ \\sigma_{p,t}^2 = \\left(\\frac{tn}{\\sigma^2} + \\frac{1}{\\tau^2}\\right)^{-1} \\quad \\text{和} \\quad \\mu_{p,t} = \\sigma_{p,t}^2 \\left(\\frac{tn\\bar{y}}{\\sigma^2}\\right) $$\n我们通过从这个回火后验中抽取 $M$ 个样本 $\\mu^{(j)}$，并平均 $-\\log p(y \\mid \\mu^{(j)})$ 的值来使用蒙特卡洛积分估计这个期望。对于模型 $\\mathcal{M}_0$，没有参数，所以 $-\\log Z_0$ 是精确计算的。\n\n**4. 模型选择**\n\n模型选择的决策是通过比较 $\\mathcal{M}_0$ 和 $\\mathcal{M}_1$ 的证据来做出的。边际似然更高的模型被认为是更优的。\n- **基准真相选择**：如果 $\\log Z_1 > \\log Z_0$，则选择 $\\mathcal{M}_1$；否则选择 $\\mathcal{M}_0$。\n- **HME 选择**：如果 $\\widehat{\\log Z_1}^{\\text{HM}} > \\log Z_0$，则选择 $\\mathcal{M}_1$；否则选择 $\\mathcalM_0$。\n- **WBIC 选择**：如果 $\\widehat{-\\log Z_1}^{\\text{WBIC}}  -\\log Z_0$，则选择 $\\mathcal{M}_1$；否则选择 $\\mathcal{M}_0$。\n\n模拟将为三个指定的测试用例实施这些计算，以比较 HME 和 WBIC 相对于基准真相的性能，特别强调 HME 在不稳定性条件下的失效模式。", "answer": "```\n[[1,0,0,1],[1,0,0,1],[1,1,1,0]]\n```", "id": "3311539"}]}