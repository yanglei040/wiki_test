{"hands_on_practices": [{"introduction": "重采样是序贯蒙特卡洛（SMC）方法中对抗粒子权重退化的关键步骤，但它自身会引入额外的随机性，即所谓的“采样方差”。不同的重采样方案在控制这种方差方面表现各异。本练习通过一个具体的数值计算，让您亲手量化并比较四种常见重采样方案——多项式、分层、残差和系统重采样——所引入的方差，从而将抽象的理论差异转化为切实的感受。", "problem": "考虑一个用于静态目标分布的序贯蒙特卡洛（SMC）采样器。在某次迭代中，假设一个加权粒子系统对于 $K=5$ 个不同的粒子，其粒子权重为 $\\mathbf{w} = (0.10,\\,0.25,\\,0.05,\\,0.30,\\,0.30)$，并且要生成的后代总数为 $N=12$。令 $N_i$ 表示在重采样步骤中，以权重向量 $\\mathbf{w}$ 为条件，分配给粒子 $i$ 的后代随机数量。我们关注粒子 $i=3$，其权重为 $w_3 = 0.05$。使用多项式重采样、分层重采样、残差重采样和系统重采样的标准定义，计算每种方案下的条件方差 $\\operatorname{Var}(N_3 \\mid \\mathbf{w})$。\n\n以精确值的形式给出这四种方差，然后按条件方差的升序对这些方案进行排序。将最终答案表示为一个单行矩阵，按升序（从左到右）列出这四个方差，矩阵中的条目对应于按方差升序排列的方案。不需要四舍五入。不涉及物理单位。", "solution": "该问题要求在一个序贯蒙特卡洛（SMC）框架下，计算并比较特定粒子（其后代数量记为 $N_3$）在四种不同重采样方案下的条件方差。给定的参数是要生成的后代总数 $N=12$，以及 $K=5$ 个粒子的归一化粒子权重向量 $\\mathbf{w} = (0.10, 0.25, 0.05, 0.30, 0.30)$。我们关注的是粒子 $i=3$，其权重为 $w_3 = 0.05$。权重之和为 $\\sum_{i=1}^5 w_i = 0.10 + 0.25 + 0.05 + 0.30 + 0.30 = 1.00$，这证实了它们是归一化的。我们将为四种指定的重采样方案中的每一种计算 $\\operatorname{Var}(N_3 \\mid \\mathbf{w})$。\n\n**1. 多项式重采样**\n在多项式重采样中，后代数量向量 $(N_1, N_2, \\dots, N_K)$ 是从一个多项式分布中随机抽取的，该分布有 $N$ 次试验，成功概率由权重向量 $\\mathbf{w}$ 给出。\n$$\n(N_1, N_2, \\dots, N_K) \\sim \\text{Multinomial}(N, \\mathbf{w})\n$$\n单个粒子 $i$ 的后代数量 $N_i$ 的边际分布是二项分布，有 $N$ 次试验，成功概率为 $w_i$。\n$$\nN_i \\sim \\text{Binomial}(N, w_i)\n$$\n二项分布 $\\text{Binomial}(n, p)$ 的方差由 $np(1-p)$ 给出。因此，$N_i$ 的条件方差为：\n$$\n\\operatorname{Var}(N_i \\mid \\mathbf{w}) = N w_i (1-w_i)\n$$\n对于粒子 $i=3$，$N=12$ 且 $w_3=0.05$，其方差为：\n$$\n\\operatorname{Var}(N_3 \\mid \\mathbf{w}) = 12 \\times 0.05 \\times (1 - 0.05) = 12 \\times 0.05 \\times 0.95 = 0.6 \\times 0.95 = 0.57\n$$\n\n**2. 分层重采样**\n在分层重采样中，区间 $[0,1)$ 被划分为 $N$ 个长度相等的层，每层长度为 $1/N$。从每个层中抽取一个均匀分布的随机数。然后使用这 $N$ 个有序指针来选择祖先。粒子 $i$ 的后代数量 $N_i$ 是一个随机变量，只能取两个相邻的整数值：$\\lfloor N w_i \\rfloor$ 或 $\\lceil N w_i \\rceil$。\n令 $N w_i = I_i + f_i$，其中 $I_i = \\lfloor N w_i \\rfloor$ 是整数部分，$f_i = \\{N w_i\\}$ 是小数部分。后代数量为 $N_i = I_i$ 的概率是 $1-f_i$，为 $N_i = I_i+1$ 的概率是 $f_i$。这意味着随机变量 $N_i - I_i$ 服从参数为 $f_i$ 的伯努利分布。\n$$\nN_i - \\lfloor N w_i \\rfloor \\sim \\text{Bernoulli}(\\{N w_i\\})\n$$\n参数为 $p$ 的伯努利试验的方差是 $p(1-p)$。因此，$N_i$ 的方差仅取决于其被 $N$ 缩放后的小数部分：\n$$\n\\operatorname{Var}(N_i \\mid \\mathbf{w}) = \\operatorname{Var}(N_i - I_i) = f_i(1-f_i) = \\{N w_i\\}(1 - \\{N w_i\\})\n$$\n对于粒子 $i=3$，我们首先计算 $N w_3 = 12 \\times 0.05 = 0.6$。小数部分是 $f_3 = \\{0.6\\} = 0.6$。方差为：\n$$\n\\operatorname{Var}(N_3 \\mid \\mathbf{w}) = 0.6 \\times (1 - 0.6) = 0.6 \\times 0.4 = 0.24\n$$\n\n**3. 系统重采样**\n系统重采样与分层重采样类似，但不是抽取 $N$ 个独立的随机数，而是抽取一个随机数 $u \\sim U[0,1)$ 来定义一个指针网格 $\\{ \\frac{u}{N}, \\frac{u+1}{N}, \\dots, \\frac{u+N-1}{N} \\}$。这在后代数量 $N_i$ 之间引入了强的负相关。然而，单个数量 $N_i$ 的边际分布与分层重采样中的相同。后代数量 $N_i$ 仍然只能是 $\\lfloor N w_i \\rfloor$ 或 $\\lceil N w_i \\rceil$，并且 $N_i = \\lfloor N w_i \\rfloor + 1$ 的概率为 $\\{N w_i\\}$。\n因此，$N_i$ 的边际方差公式与分层重采样的相同：\n$$\n\\operatorname{Var}(N_i \\mid \\mathbf{w}) = \\{N w_i\\}(1 - \\{N w_i\\})\n$$\n对于粒子 $i=3$，计算与分层情况相同：\n$$\n\\operatorname{Var}(N_3 \\mid \\mathbf{w}) = 0.24\n$$\n\n**4. 残差重采样**\n残差重采样是一个旨在减少采样方差的两阶段过程。\n在第一阶段，将确定性数量的后代 $\\tilde{N}_i = \\lfloor N w_i \\rfloor$ 分配给每个粒子 $i$。\n确定性分配的后代总数为 $N_{det} = \\sum_{i=1}^K \\tilde{N}_i$。\n在第二阶段，剩余的 $N_{res} = N - N_{det}$ 个后代被随机分配。这是通过对 $N_{res}$ 个新粒子执行重采样（通常是多项式重采样）来完成的，使用一组新的权重 $\\mathbf{w}'$，其中每个 $w'_i$ 与原始权重的残差部分成正比，即 $w'_i \\propto N w_i - \\lfloor N w_i \\rfloor = \\{N w_i\\}$。正确归一化的权重是 $w'_i = \\frac{\\{N w_i\\}}{\\sum_{j=1}^K \\{N w_j\\}} = \\frac{\\{N w_i\\}}{N_{res}}$。\n粒子 $i$ 的后代总数是 $N_i = \\tilde{N}_i + R_i$，其中 $R_i$ 是来自第二阶段的后代随机数量。由于 $\\tilde{N}_i$ 是确定性的，所以 $\\operatorname{Var}(N_i \\mid \\mathbf{w}) = \\operatorname{Var}(R_i \\mid \\mathbf{w})$。向量 $(R_1, \\dots, R_K)$ 服从 $\\text{Multinomial}(N_{res}, \\mathbf{w}')$ 分布。\n因此，$R_i$ 的边际方差是 $\\operatorname{Var}(R_i \\mid \\mathbf{w}) = N_{res} w'_i (1-w'_i)$。\n\n让我们计算所有粒子的必要数量：\n缩放后的权重为 $N\\mathbf{w} = (1.2, 3.0, 0.6, 3.6, 3.6)$。\n确定性计数为 $\\tilde{\\mathbf{N}} = (\\lfloor 1.2 \\rfloor, \\lfloor 3.0 \\rfloor, \\lfloor 0.6 \\rfloor, \\lfloor 3.6 \\rfloor, \\lfloor 3.6 \\rfloor) = (1, 3, 0, 3, 3)$。\n$N_{det} = 1+3+0+3+3 = 10$。\n$N_{res} = N - N_{det} = 12 - 10 = 2$。\n小数部分为 $\\{\\mathbf{Nw}\\} = (0.2, 0.0, 0.6, 0.6, 0.6)$。它们的和为 $0.2+0.0+0.6+0.6+0.6 = 2.0$，这正确地等于 $N_{res}$。\n用于残差重采样的新权重为 $\\mathbf{w}' = \\frac{1}{2.0}(0.2, 0.0, 0.6, 0.6, 0.6) = (0.1, 0.0, 0.3, 0.3, 0.3)$。\n对于粒子 $i=3$，我们有 $w'_3 = 0.3$。方差为：\n$$\n\\operatorname{Var}(N_3 \\mid \\mathbf{w}) = N_{res} w'_3 (1-w'_3) = 2 \\times 0.3 \\times (1 - 0.3) = 2 \\times 0.3 \\times 0.7 = 0.42\n$$\n\n**总结与排序**\n计算出的 $N_3$ 的条件方差为：\n- 多项式重采样: $0.57$\n- 分层重采样: $0.24$\n- 系统重采样: $0.24$\n- 残差重采样: $0.42$\n\n按 $N_3$ 的条件方差升序对重采样方案进行排序：\n1. 分层重采样 (方差 = $0.24$)\n1. 系统重采样 (方差 = $0.24$)\n3. 残差重采样 (方差 = $0.42$)\n4. 多项式重采样 (方差 = $0.57$)\n\n排序后的方差列表为 $(0.24, 0.24, 0.42, 0.57)$。", "answer": "$$\n\\boxed{\\begin{pmatrix} 0.24 & 0.24 & 0.42 & 0.57 \\end{pmatrix}}\n$$", "id": "3345072"}, {"introduction": "在通过练习 [@problem_id:3345072] 了解了不同方案在有限样本下的方差表现后，我们现在将目光投向更长远的行为，即当粒子数 $N$ 趋于无穷时的渐近性质。本练习利用一个简化的双原子模型，推导中心极限定理（CLT）背景下的渐近方差，揭示了多项式重采样与残差重采样等方案在收敛速度上的深刻差异。它将阐明为何某些“低方差”方案对于大规模问题在根本上更为高效。", "problem": "考虑一个以静态概率测度为目标的序贯蒙特卡洛（SMC; Sequential Monte Carlo）采样器。设静态目标测度 $\\pi$ 支持在两个原子 $\\{x_{1}, x_{2}\\}$ 上，其中 $\\pi(\\{x_{1}\\}) = p \\in (0,1)$ 且 $\\pi(\\{x_{2}\\}) = 1-p$。设 $f$ 是一个有界可测函数，满足 $f(x_{1}) = f_{1} \\in \\mathbb{R}$ 和 $f(x_{2}) = f_{2} \\in \\mathbb{R}$。假设该SMC采样器使用恒等变异核（即马尔可夫转移不移动粒子），并应用单个重采样步骤将加权粒子系统转换为大小为 $N$ 的无权粒子系统，从而得到估计量 $\\hat{\\pi}_{t}^{N}(f)$，其定义为重采样后粒子上 $f$ 的样本均值。\n\n假设在重采样之前，加权粒子系统被理想化如下：位于 $x_{1}$ 的粒子集合共同携带的归一化总权重为 $p$，而位于 $x_{2}$ 的粒子集合共同携带的归一化总权重为 $1-p$。因此，在任何一次重采样抽取中，抽中位于 $x_{1}$ 的父粒子的概率为 $p$，抽中位于 $x_{2}$ 的父粒子的概率为 $1-p$。\n\n考虑两种重采样方案：\n- 多项式重采样：以概率 $p$ 在 $x_{1}$ 和概率 $1-p$ 在 $x_{2}$ 进行 $N$ 次独立的父粒子抽取。\n- 残差重采样：每个位置分别接收 $\\lfloor N p \\rfloor$ 和 $\\lfloor N(1-p) \\rfloor$ 个确定性副本，剩余的 $R = N - \\lfloor N p \\rfloor - \\lfloor N(1-p) \\rfloor$ 个副本（在此双原子情况下 $R \\in \\{0,1\\}$）通过一次随机抽取进行分配，抽取概率与残差权重成正比。\n\n仅从这些定义以及二项分布和伯努利分布方差的标准性质出发，为每种重采样方案推导中心极限定理（CLT; Central Limit Theorem）中的渐近方差常数 $\\sigma^{2}$，其形式为\n$$\n\\sqrt{N}\\big(\\hat{\\pi}_{t}^{N}(f) - \\pi(f)\\big) \\Longrightarrow \\mathcal{N}(0,\\sigma^{2}),\n$$\n其中 $\\Longrightarrow$ 表示依分布收敛。然后计算差值\n$$\n\\Delta \\sigma^{2} \\equiv \\sigma^{2}_{\\text{multinomial}} - \\sigma^{2}_{\\text{residual}}\n$$\n为一个用 $p$、$f_{1}$ 和 $f_{2}$ 表示的闭式解析表达式。将您的最终答案表示为单个闭式表达式。无需四舍五入，该量没有单位。", "solution": "该问题要求计算两种不同重采样方案下，序贯蒙特卡洛（SMC）估计量的渐近方差。\n\n### 问题设定\n-   **目标分布**：一个在两个点 $\\{x_1, x_2\\}$ 上的静态概率测度 $\\pi$。\n-   **概率**：$\\pi(\\{x_1\\}) = p$ 且 $\\pi(\\{x_2\\}) = 1-p$，其中 $p \\in (0,1)$。\n-   **函数**：一个有界可测函数 $f$，满足 $f(x_1) = f_1 \\in \\mathbb{R}$ 和 $f(x_2) = f_2 \\in \\mathbb{R}$。\n-   **SMC采样器**：使用恒等变异核（即无MCMC移动步骤）。\n-   **估计量**：$\\hat{\\pi}_{t}^{N}(f)$，即一次重采样后，大小为 $N$ 的粒子系统上 $f$ 的样本均值。\n-   **重采样前状态**：一个理想化的加权粒子系统，从 $x_1$ 抽样的概率为 $p$，从 $x_2$ 抽样的概率为 $1-p$。\n-   **目标**：\n    1.  为多项式重采样和残差重采样推导中心极限定理（CLT）$\\sqrt{N}\\big(\\hat{\\pi}_{t}^{N}(f) - \\pi(f)\\big) \\Longrightarrow \\mathcal{N}(0,\\sigma^{2})$ 中的渐近方差常数 $\\sigma^2$。\n    2.  计算差值 $\\Delta \\sigma^{2} \\equiv \\sigma^{2}_{\\text{multinomial}} - \\sigma^{2}_{\\text{residual}}$。\n\n### 推导过程\n首先，函数 $f$ 关于目标测度 $\\pi$ 的期望值为\n$$\n\\pi(f) = E_{\\pi}[f(X)] = f(x_1) \\pi(\\{x_1\\}) + f(x_2) \\pi(\\{x_2\\}) = p f_1 + (1-p) f_2.\n$$\n中心极限定理（CLT）中的渐近方差常数 $\\sigma^2$ 由以下极限给出\n$$\n\\sigma^2 = \\lim_{N\\to\\infty} \\text{Var}\\left[\\sqrt{N}\\left(\\hat{\\pi}_{t}^{N}(f) - \\pi(f)\\right)\\right] = \\lim_{N\\to\\infty} N \\text{Var}\\left[\\hat{\\pi}_{t}^{N}(f)\\right].\n$$\n\n#### 多项式重采样的渐近方差\n在多项式重采样中，我们从一个分类分布中独立抽取 $N$ 个粒子 $\\{X_1, \\dots, X_N\\}$，其在位置 $x_1$ 和 $x_2$ 的概率分别为 $(p, 1-p)$。估计量为\n$$\n\\hat{\\pi}_{\\text{multi}}^{N}(f) = \\frac{1}{N} \\sum_{i=1}^{N} f(X_i).\n$$\n这是一个 $N$ 个独立同分布（i.i.d.）随机变量的平均值。每个 $f(X_i)$ 是一个随机变量 $Z_i$，它以概率 $p$ 取值 $f_1$，以概率 $1-p$ 取值 $f_2$。\n$Z_i$ 的均值为 $E[Z_i] = p f_1 + (1-p) f_2 = \\pi(f)$。\n$Z_i$ 的方差为\n$$\n\\text{Var}(Z_i) = E[Z_i^2] - (E[Z_i])^2 = (p f_1^2 + (1-p) f_2^2) - (p f_1 + (1-p) f_2)^2.\n$$\n展开此表达式：\n$$\n\\text{Var}(Z_i) = p f_1^2 + (1-p) f_2^2 - (p^2 f_1^2 + 2p(1-p)f_1 f_2 + (1-p)^2 f_2^2)\n$$\n$$\n= (p-p^2)f_1^2 + ( (1-p) - (1-p)^2 )f_2^2 - 2p(1-p)f_1 f_2\n$$\n$$\n= p(1-p)f_1^2 + (1-p)(1-(1-p))f_2^2 - 2p(1-p)f_1 f_2\n$$\n$$\n= p(1-p)f_1^2 + p(1-p)f_2^2 - 2p(1-p)f_1 f_2\n$$\n$$\n= p(1-p)(f_1^2 - 2f_1 f_2 + f_2^2) = p(1-p)(f_1 - f_2)^2.\n$$\n根据独立同分布样本的标准中心极限定理，$\\sqrt{N}(\\hat{\\pi}_{\\text{multi}}^{N}(f) - \\pi(f)) \\Longrightarrow \\mathcal{N}(0, \\text{Var}(Z_i))$。\n因此，多项式重采样的渐近方差为\n$$\n\\sigma^2_{\\text{multinomial}} = \\text{Var}(Z_i) = p(1-p)(f_1 - f_2)^2.\n$$\n\n#### 残差重采样的渐近方差\n设 $M_1$ 是残差重采样后在位置 $x_1$ 的粒子数，$M_2$ 是在 $x_2$ 的粒子数，其中 $M_1 + M_2 = N$。估计量为\n$$\n\\hat{\\pi}_{\\text{res}}^{N}(f) = \\frac{1}{N}(M_1 f_1 + M_2 f_2) = \\frac{1}{N}(M_1 f_1 + (N-M_1)f_2) = \\frac{M_1}{N}(f_1-f_2) + f_2.\n$$\n位置 $x_1$ 的粒子数由一个确定性部分和一个随机部分给出：\n$$\nM_1 = \\lfloor Np \\rfloor + R_1,\n$$\n其中 $R_1$ 是分配给 $x_1$ 的残差粒子数。残差粒子的总数为 $R = N - \\lfloor Np \\rfloor - \\lfloor N(1-p) \\rfloor$。由于 $p \\in (0,1)$，$Np + N(1-p) = N$。令 $\\{x\\} = x - \\lfloor x \\rfloor$ 为 $x$ 的小数部分。那么 $N = \\lfloor Np \\rfloor + \\{Np\\} + \\lfloor N(1-p) \\rfloor + \\{N(1-p)\\}$，这意味着 $R = \\{Np\\} + \\{N(1-p)\\}$。如果 $Np$ 不是整数，则 $\\{Np\\} + \\{N(1-p)\\} = 1$。如果 $Np$ 是整数，则 $R=0$。因此 $R \\in \\{0, 1\\}$。\n\n$R$ 个残差粒子通过一次随机抽取进行分配。\n如果 $R=0$，$R_1=0$ 是确定性的。\n如果 $R=1$，则从一个概率与残差小数权重成正比的分布中抽取，对于 $x_1$ 是 $\\{Np\\}$，对于 $x_2$ 是 $\\{N(1-p)\\}$。它们的和为 $R=1$。将这个唯一的残差粒子分配给 $x_1$ 的概率是 $p_{res} = \\frac{\\{Np\\}}{R} = \\{Np\\}$。因此，$R_1$ 是一个伯努利随机变量，$R_1 \\sim \\text{Bernoulli}(\\{Np\\})$。\n\n$M_1$ 的期望值为 $E[M_1] = \\lfloor Np \\rfloor + E[R_1] = \\lfloor Np \\rfloor + \\{Np\\} = Np$。\n因此，该估计量是无偏的：$E[\\hat{\\pi}_{\\text{res}}^{N}(f)] = \\frac{E[M_1]}{N}(f_1-f_2) + f_2 = p(f_1-f_2) + f_2 = \\pi(f)$。\n\n现在我们计算方差。估计量的误差为\n$$\n\\hat{\\pi}_{\\text{res}}^{N}(f) - \\pi(f) = \\left(\\frac{M_1}{N}(f_1-f_2) + f_2\\right) - (p f_1 + (1-p)f_2) = \\frac{M_1-Np}{N}(f_1-f_2).\n$$\n方差为\n$$\n\\text{Var}\\left[\\hat{\\pi}_{\\text{res}}^{N}(f)\\right] = \\text{Var}\\left[\\frac{M_1-Np}{N}(f_1-f_2)\\right] = \\frac{(f_1-f_2)^2}{N^2} \\text{Var}[M_1].\n$$\n$M_1$ 的方差为 $\\text{Var}[M_1] = \\text{Var}[\\lfloor Np \\rfloor + R_1] = \\text{Var}[R_1]$。\n在所有情况下，$\\text{Var}[M_1] = \\{Np\\}(1-\\{Np\\})$。\n\n对于一个固定的 $N$，估计量的方差为\n$$\n\\text{Var}\\left[\\hat{\\pi}_{\\text{res}}^{N}(f)\\right] = \\frac{(f_1-f_2)^2}{N^2} \\{Np\\}(1-\\{Np\\}).\n$$\n渐近方差常数为\n$$\n\\sigma^2_{\\text{residual}} = \\lim_{N\\to\\infty} N \\text{Var}\\left[\\hat{\\pi}_{\\text{res}}^{N}(f)\\right] = \\lim_{N\\to\\infty} N \\frac{(f_1-f_2)^2}{N^2} \\{Np\\}(1-\\{Np\\})\n$$\n$$\n= \\lim_{N\\to\\infty} \\frac{(f_1-f_2)^2}{N} \\{Np\\}(1-\\{Np\\}).\n$$\n项 $\\{Np\\}$ 在 $[0,1)$ 中振荡，而 $1-\\{Np\\}$ 在 $(0,1]$ 中振荡。因此，乘积 $\\{Np\\}(1-\\{Np\\})$ 是有界的，具体来说 $\\{Np\\}(1-\\{Np\\}) \\in [0, 1/4]$。由于分子有界而分母 $N$ 趋于无穷大，该极限为零。\n$$\n\\sigma^2_{\\text{residual}} = 0.\n$$\n零渐近方差常数意味着 $\\sqrt{N}(\\hat{\\pi}_{\\text{res}}^{N}(f) - \\pi(f))$ 依概率收敛于 $0$。极限分布是在 $0$ 处的点质量，这是一个方差为零的退化高斯分布，即 $\\mathcal{N}(0,0)$。\n\n### 渐近方差的差异\n我们需要计算 $\\Delta \\sigma^{2} = \\sigma^{2}_{\\text{multinomial}} - \\sigma^{2}_{\\text{residual}}$。\n代入上面推导出的结果：\n$$\n\\Delta \\sigma^{2} = p(1-p)(f_1 - f_2)^2 - 0.\n$$\n$$\n\\Delta \\sigma^{2} = p(1-p)(f_1 - f_2)^2.\n$$\n这个结果量化了在这种理想化设置下，使用残差重采样相对于多项式重采样所实现的渐近方差的减少。在 $\\mathcal{O}(1/N)$ 阶上，由采样步骤引入的方差被有效消除。", "answer": "$$\n\\boxed{p(1-p)(f_1-f_2)^2}\n$$", "id": "3345037"}, {"introduction": "一个高效的SMC采样器设计需要超越单个环节的优化，综合平衡多个相互制约的因素。本高级练习将引导您解决一个整体性的设计问题：如何选择最优的退火路径。您将学习在保证最终估计值达到目标精度（以对数归一化常数估计的方差为约束）的前提下，最小化总计算成本，从而将有效样本量（ESS）、MCMC混合效率以及估计量方差等关键概念联系起来。", "problem": "考虑一个用于静态目标的序贯蒙特卡洛 (SMC) 采样器，该采样器采用退火路径 $\\{\\pi_{t}: t \\in [0,1]\\}$，其离散化为 $\\{0=t_{0}, t_{1}, \\dots, t_{K}=1\\}$，增量为 $\\delta_{k} \\equiv t_{k}-t_{k-1}$。在每个阶段 $k \\in \\{1,\\dots,K\\}$，该算法执行重要性重加权，然后进行重采样，接着应用 $m_{k}$ 步以 $\\pi_{t_{k}}$ 为目标分布的马尔可夫链蒙特卡洛 (MCMC) 移动核。假设存在以下建模基元，这些是基于退火的 SMC 采样器的标准小步长近似：\n\n- 在阶段 $k$ 重加权后的有效样本量 (ESS) 满足 $\\mathrm{ESS}_{k} \\approx \\dfrac{N}{1+\\omega^{2}\\delta_{k}^{2}}$，其中 $N$ 是粒子数，$\\omega^{2} > 0$ 是一个局部曲率常数，用于刻画沿路径的增量对数权重的方差。\n- 通过在每个阶段都进行重采样的 SMC 估计量产生的估计归一化常数 $\\hat{Z}$ 的对数的方差满足 $\\mathrm{Var}[\\ln \\hat{Z}] \\approx \\dfrac{\\omega^{2}}{N} \\sum_{k=1}^{K} \\delta_{k}^{2}$。\n- 阶段 $k$ 的 MCMC 移动核具有与局部退火步长成正比的谱隙，谱隙大小为 $\\gamma \\delta_{k}$，其中某个 $\\gamma>0$ 量化了单位退火的混合率。为了达到一个固定的阶段内去相关水平，MCMC 迭代次数按 $m_{k} = \\dfrac{\\vartheta}{\\gamma \\delta_{k}}$ 的比例缩放，其中 $\\vartheta>0$ 是某个常数。\n- 每个粒子在每个阶段的计算成本包括基础评估成本 $\\eta>0$（例如，用于权重计算）加上 $m_{k}$ 步 MCMC 的成本，整个运行过程的总成本为 $C = \\sum_{k=1}^{K} N\\big(\\eta + \\dfrac{\\vartheta}{\\gamma \\delta_{k}}\\big)$。\n\n你的任务是设计一个 ESS 阈值方案 $\\{\\tau_{k}\\}_{k=1}^{K}$，其中 $\\tau_{k} \\in (0,1]$ 是通过选择 $\\delta_{k}$ 以满足 $\\dfrac{\\mathrm{ESS}_{k}}{N} = \\tau_{k}$ 来强制执行的，因此有 $\\tau_{k} = \\dfrac{1}{1+\\omega^{2}\\delta_{k}^{2}}$。你的目标是在对数归一化常数估计量的目标误差容限 $\\mathrm{Var}[\\ln \\hat{Z}] \\le \\epsilon^{2}$（对于给定的 $\\epsilon>0$）和路径约束 $\\sum_{k=1}^{K} \\delta_{k} = 1$ 的条件下，最小化总成本 $C$。\n\n从第一性原理和上述建模基元出发，完成以下任务：\n\n- 推导刻画最小化方案的最优性条件，并证明任何最优方案都具有相等的步长，即对所有 $k \\in \\{1,\\dots,K\\}$ 都有 $\\delta_{k} \\equiv \\delta$，因此 ESS 分数也是一个常数 $\\tau_{k} \\equiv \\tau^{\\star}$。\n- 用 $N$、$\\epsilon$ 和 $\\omega$ 表示相应的最优阶段数 $K^{\\star}$ 和步长 $\\delta^{\\star}$。\n- 提供最优恒定 ESS 分数 $\\tau^{\\star}$ 作为 $N$、$\\epsilon$ 和 $\\omega$ 的函数的闭式表达式。\n\n此外，解释 MCMC 核混合率参数 $\\gamma$ 如何进入一阶最优性条件和最小化的总成本，以及它是否影响最优 ESS 分数 $\\tau^{\\star}$。你最终报告的答案必须仅为 $\\tau^{\\star}$ 的单个闭式表达式。无需四舍五入。", "solution": "该问题要求我们为序贯蒙特卡洛 (SMC) 采样器找到一个最优方案，以在对数归一化常数估计量的方差约束下最小化计算成本。\n\n该优化问题可以形式化地表述如下。我们想要最小化总成本函数：\n$$\nC(\\{\\delta_{k}\\}_{k=1}^{K}, K) = \\sum_{k=1}^{K} N\\left(\\eta + \\frac{\\vartheta}{\\gamma \\delta_{k}}\\right)\n$$\n服从两个约束条件：\n1.  方差约束： $\\mathrm{Var}[\\ln \\hat{Z}] \\approx \\dfrac{\\omega^{2}}{N} \\sum_{k=1}^{K} \\delta_{k}^{2} \\le \\epsilon^{2}$\n2.  路径约束： $\\sum_{k=1}^{K} \\delta_{k} = 1$\n其中对于所有 $k \\in \\{1, \\dots, K\\}$ 都有 $\\delta_{k} > 0$。优化是针对步长集合 $\\{\\delta_{k}\\}_{k=1}^{K}$ 和阶段数 $K$ 进行的。\n\n我们首先在阶段数 $K$ 固定的情况下，推导步长 $\\{\\delta_k\\}$ 的最优性条件。成本函数是一个常数项 $N K \\eta$ 和一个与 $\\sum_{k=1}^{K} \\frac{1}{\\delta_{k}}$ 成比例的项之和。要最小化 $C$，我们必须最小化 $\\sum_{k=1}^{K} \\frac{1}{\\delta_{k}}$。在最优点，关于方差的不等式约束必须是激活的（即取等号）。如果不是，我们可以调整 $\\{\\delta_k\\}$ 来减少成本，同时仍然满足约束。因此，我们求解时使用约束 $\\frac{\\omega^{2}}{N} \\sum_{k=1}^{K} \\delta_{k}^{2} = \\epsilon^{2}$。\n\n我们使用拉格朗日乘子法。这个约束优化问题的拉格朗日函数 $\\mathcal{L}$（为清晰起见，省略常数项）是：\n$$\n\\mathcal{L}(\\{\\delta_{k}\\}, \\lambda_1, \\lambda_2) = \\sum_{k=1}^{K} \\frac{1}{\\delta_{k}} + \\lambda_1 \\left( \\sum_{k=1}^{K} \\delta_{k}^{2} - \\frac{N\\epsilon^{2}}{\\omega^{2}} \\right) + \\lambda_2 \\left( \\sum_{k=1}^{K} \\delta_{k} - 1 \\right)\n$$\n为了找到最小值，我们计算 $\\mathcal{L}$ 关于任意步长 $\\delta_j$ 的偏导数并令其为零：\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial \\delta_j} = -\\frac{1}{\\delta_j^2} + 2\\lambda_1\\delta_j + \\lambda_2 = 0\n$$\n这个条件必须对所有 $j \\in \\{1, \\dots, K\\}$ 成立。我们定义一个函数 $f(x) = -x^{-2} + 2\\lambda_1 x + \\lambda_2$。最优性条件是对于所有 $j$ 都有 $f(\\delta_j) = 0$。该函数的导数是 $f'(x) = 2x^{-3} + 2\\lambda_1$。乘子 $\\lambda_1$ 必须为正，因为增加允许的方差（约束的右侧）会导致更低的成本。对于 $x > 0$ 和 $\\lambda_1 > 0$，$f'(x) > 0$，这意味着 $f(x)$ 是严格单调递增的。一个严格单调函数只能在一个点上等于零。由于对所有 $j$ 都有 $f(\\delta_j) = 0$，因此必然有所有 $\\delta_j$ 都相等。\n$$\n\\delta_1 = \\delta_2 = \\dots = \\delta_K \\equiv \\delta^{\\star}\n$$\n这证明了最优方案必须具有相等的步长。这也意味着 ESS 分数在各个阶段是恒定的：$\\tau_k = \\frac{1}{1+\\omega^2 \\delta_k^2} = \\frac{1}{1+\\omega^2 (\\delta^\\star)^2} \\equiv \\tau^\\star$。\n\n现在，我们可以用恒定的步长 $\\delta$ 和阶段数 $K$ 来表示约束和成本函数。\n路径约束变为：\n$$\n\\sum_{k=1}^{K} \\delta = K\\delta = 1 \\implies \\delta = \\frac{1}{K}\n$$\n激活的方差约束变为：\n$$\n\\frac{\\omega^2}{N} \\sum_{k=1}^{K} \\delta^2 = \\frac{\\omega^2}{N} K \\left(\\frac{1}{K}\\right)^2 = \\frac{\\omega^2}{NK} = \\epsilon^2\n$$\n由此，我们可以解出最优阶段数 $K^\\star$。为了优化的目的，我们将 $K$ 视为一个连续变量，这是此类分析中的一种标准方法。\n$$\nK^{\\star} = \\frac{\\omega^2}{N\\epsilon^2}\n$$\n相应的最优步长 $\\delta^{\\star}$ 是：\n$$\n\\delta^{\\star} = \\frac{1}{K^{\\star}} = \\frac{N\\epsilon^2}{\\omega^2}\n$$\n这个解在 $K^\\star \\ge 1$ 的情况下是有效的，即当 $\\omega^2/N \\ge \\epsilon^2$ 时，这种情况是指从 $t=0$ 到 $t=1$ 的单步操作会违反方差容限，因此需要采用多阶段方法。\n\n总成本函数现在可以只写成 $K$ 的函数：\n$$\nC(K) = \\sum_{k=1}^{K} N\\left(\\eta + \\frac{\\vartheta}{\\gamma (1/K)}\\right) = NK\\left(\\eta + \\frac{\\vartheta K}{\\gamma}\\right) = N\\eta K + \\frac{N\\vartheta}{\\gamma}K^2\n$$\n关于 $K$ 的导数是 $\\frac{dC}{dK} = N\\eta + \\frac{2N\\vartheta}{\\gamma}K$。由于所有参数 $N, \\eta, \\vartheta, \\gamma$ 都是正的，所以当 $K>0$ 时 $\\frac{dC}{dK} > 0$。因此，$C(K)$ 是 $K$ 的一个严格单调递增函数。为了最小化成本，我们必须选择满足方差约束的最小可能的 $K$ 值，这正是我们找到的值 $K^\\star$。\n\n现在，我们可以推导最优恒定 ESS 分数 $\\tau^{\\star}$ 的表达式。根据定义：\n$$\n\\tau^{\\star} = \\frac{1}{1 + \\omega^2 (\\delta^{\\star})^2}\n$$\n代入 $\\delta^{\\star}$ 的表达式：\n$$\n\\tau^{\\star} = \\frac{1}{1 + \\omega^2 \\left(\\frac{N\\epsilon^2}{\\omega^2}\\right)^2} = \\frac{1}{1 + \\omega^2 \\frac{N^2\\epsilon^4}{\\omega^4}} = \\frac{1}{1 + \\frac{N^2\\epsilon^4}{\\omega^2}}\n$$\n这可以写成一个更紧凑的形式：\n$$\n\\tau^{\\star} = \\frac{\\omega^2}{\\omega^2 + N^2\\epsilon^4}\n$$\n\n最后，我们讨论 MCMC 核混合率参数 $\\gamma$ 的作用。使用完整的成本函数，一阶最优性条件 $\\frac{\\partial \\mathcal{L}}{\\partial \\delta_j} = 0$ 的形式变为：\n$$\n- \\frac{N\\vartheta}{\\gamma \\delta_j^2} + 2\\lambda_1' \\delta_j + \\lambda_2' = 0\n$$\n其中 $\\lambda_1'$ 和 $\\lambda_2'$ 是拉格朗日乘子。参数 $\\gamma$ 对源于 MCMC 成本的第一项进行缩放。然而，所有 $\\delta_j$ 必须相等的逻辑是基于方程的函数形式及其单调性，而不是基于系数的具体值。因此，最优方案具有相等步长的结论与 $\\gamma$ 无关。\n因此，最优阶段数 $K^\\star = \\frac{\\omega^2}{N\\epsilon^2}$ 和最优步长 $\\delta^\\star = \\frac{N\\epsilon^2}{\\omega^2}$ 也与 $\\gamma$ 无关。一个直接的结果是，只依赖于 $\\omega$、$N$ 和 $\\epsilon$ 的最优 ESS 分数 $\\tau^\\star$ 不受 MCMC 混合率 $\\gamma$ 的影响。\n然而，参数 $\\gamma$ 确实进入了最小化的总成本 $C^\\star = C(K^\\star)$ 中：\n$$\nC^\\star = N\\eta K^\\star + \\frac{N\\vartheta}{\\gamma}(K^\\star)^2 = \\frac{\\eta\\omega^2}{\\epsilon^2} + \\frac{N\\vartheta}{\\gamma}\\left(\\frac{\\omega^2}{N\\epsilon^2}\\right)^2 = \\frac{\\eta\\omega^2}{\\epsilon^2} + \\frac{\\vartheta \\omega^4}{N\\gamma\\epsilon^4}\n$$\n最小化成本随着 $\\gamma$ 的增加而减小。这是因为更大的 $\\gamma$ 意味着混合更快的 MCMC 核，这减少了每个阶段所需的迭代次数 $m_k$，从而降低了与 MCMC 更新相关的计算成本。\n\n最终答案是 $\\tau^{\\star}$ 的闭式表达式。", "answer": "$$\\boxed{\\frac{\\omega^{2}}{\\omega^{2} + N^{2}\\epsilon^{4}}}$$", "id": "3345022"}]}