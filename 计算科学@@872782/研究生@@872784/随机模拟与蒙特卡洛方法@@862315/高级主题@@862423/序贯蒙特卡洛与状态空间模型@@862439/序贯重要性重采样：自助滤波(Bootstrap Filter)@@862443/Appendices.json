{"hands_on_practices": [{"introduction": "粒子滤波器的核心在于其权重更新步骤，它将先验信念与新观测的证据（似然）结合起来。这个练习 [@problem_id:3338877] 的目标是将序贯重要性采样（SIS）的权重更新公式转化为针对非线性模型的代码。这个实践强调了在计算中使用对数权重以保证数值稳定性的重要性，这是一个在实际应用中至关重要的考虑因素。", "problem": "考虑一个隐马尔可夫模型，其潜在状态序列为 $\\{x_t\\}_{t \\ge 0}$，观测序列为 $\\{y_t\\}_{t \\ge 1}$，其中状态转移由密度为 $p(x_t \\mid x_{t-1})$ 的马尔可夫核给出，观测模型是非线性的，其密度为 $p(y_t \\mid x_t)$，由 $y_t = h(x_t) + \\epsilon_t$ 导出，其中 $h(\\cdot)$ 是已知函数，$\\epsilon_t$ 是独立噪声。假设在时间 $t-1$，您有一个加权粒子系统 $\\{x_{t-1}^{(i)}, w_{t-1}^{(i)}\\}_{i=1}^N$，它通过加权经验测度来近似滤波分布 $p(x_{t-1} \\mid y_{1:t-1})$。对于时间-$t$ 的更新，您需要从一个提议分布 $q_t$ 中独立地为 $i = 1, \\dots, N$ 采样 $x_t^{(i)} \\sim q_t(\\cdot \\mid x_{t-1}^{(i)}, y_t)$，然后计算归一化权重 $\\tilde{w}_t^{(i)}$。\n\n仅从重要性采样和贝叶斯法则的原理出发，为一个特定情况实现单时间步 $t$ 的一步序贯重要性采样 (SIS) 权重更新，无需重采样：\n- 状态转移密度是高斯的，\n$$\np(x_t \\mid x_{t-1}) = \\mathcal{N}\\!\\left(x_t; a x_{t-1} + b \\sin(x_{t-1}), \\sigma_x^2\\right),\n$$\n- 观测模型是\n$$\ny_t = h(x_t) + \\epsilon_t, \\quad h(x) = \\tfrac{1}{2} x^2, \\quad \\epsilon_t \\sim \\mathcal{N}(0, \\sigma_y^2),\n$$\n因此\n$$\np(y_t \\mid x_t) = \\mathcal{N}\\!\\left(y_t; \\tfrac{1}{2} x_t^2, \\sigma_y^2\\right),\n$$\n- 提议分布 $q_t$ 要么是转移分布（自助提议），要么是均值依赖于 $x_{t-1}$ 的高斯分布，\n$$\nq_t(x_t \\mid x_{t-1}, y_t) =\n\\begin{cases}\n\\mathcal{N}\\!\\left(x_t; a x_{t-1} + b \\sin(x_{t-1}), \\sigma_x^2\\right),  \\text{自助情况} \\\\\n\\mathcal{N}\\!\\left(x_t; a_p x_{t-1} + c x_{t-1}^3, \\sigma_q^2\\right),  \\text{一般情况}\n\\end{cases}\n$$\n\n您的程序必须：\n- 使用对数权重以保持数值稳定性，然后通过取指数和归一化返回归一化权重 $\\tilde{w}_t^{(i)}$。\n- 对于每个粒子 $i$，使用应用于目标 $p(x_t, x_{t-1} \\mid y_{1:t})$ 和提议 $q_t(x_t \\mid x_{t-1}, y_t)$ 的重要性采样原理，计算未归一化的权重增量。\n- 归一化权重，使得 $\\sum_{i=1}^N \\tilde{w}_t^{(i)} = 1$。\n\n您必须为以下测试套件实现并评估更新。在每种情况下，使用指定的随机种子来可复现地生成提议 $x_t^{(i)}$。所有数组和常量都以精确值给出，必须未经更改地使用。在所有情况下，函数 $h(x)$ 都固定为 $h(x) = \\tfrac{1}{2} x^2$。\n\n测试用例 A（一般提议，中等状况）：\n- 粒子数 $N = 5$，\n- 前一时刻的粒子 $x_{t-1}^{(i)}$ 设置为 $[-1.0, -0.2, 0.3, 1.0, 2.0]$，\n- 前一时刻的归一化权重 $w_{t-1}^{(i)}$ 设置为 $[0.1, 0.2, 0.4, 0.2, 0.1]$，\n- 参数：$a = 0.7$, $b = 0.3$, $\\sigma_x = 0.5$, $\\sigma_y = 0.8$，\n- 提议参数（一般）：$a_p = 0.5$, $c = -0.1$, $\\sigma_q = 0.7$，\n- 观测值 $y_t = 1.25$，\n- 随机种子 $= 123$。\n\n测试用例 B（自助提议，随机游走转移）：\n- 粒子数 $N = 4$，\n- 前一时刻的粒子 $x_{t-1}^{(i)}$ 设置为 $[-0.5, 0.0, 0.5, 1.5]$，\n- 前一时刻的归一化权重 $w_{t-1}^{(i)}$ 设置为 $[0.25, 0.25, 0.25, 0.25]$，\n- 参数：$a = 1.0$, $b = 0.0$, $\\sigma_x = 0.3$, $\\sigma_y = 0.4$，\n- 提议：自助（即等于转移），\n- 观测值 $y_t = 0.5$，\n- 随机种子 $= 7$。\n\n测试用例 C（一般提议，近简并似然状况）：\n- 粒子数 $N = 3$，\n- 前一时刻的粒子 $x_{t-1}^{(i)}$ 设置为 $[-2.0, 0.0, 2.0]$，\n- 前一时刻的归一化权重 $w_{t-1}^{(i)}$ 设置为 $[0.2, 0.6, 0.2]$，\n- 参数：$a = 0.9$, $b = 0.1$, $\\sigma_x = 0.2$, $\\sigma_y = 0.05$，\n- 提议参数（一般）：$a_p = 0.9$, $c = 0.0$, $\\sigma_q = 1.0$，\n- 观测值 $y_t = 10.0$，\n- 随机种子 $= 42$。\n\n测试用例 D（单粒子边缘情况）：\n- 粒子数 $N = 1$，\n- 前一时刻的粒子 $x_{t-1}^{(i)}$ 设置为 $[0.3]$，\n- 前一时刻的归一化权重 $w_{t-1}^{(i)}$ 设置为 $[1.0]$，\n- 参数：$a = 0.5$, $b = 0.5$, $\\sigma_x = 1.2$, $\\sigma_y = 0.3$，\n- 提议参数（一般）：$a_p = 0.5$, $c = 0.0$, $\\sigma_q = 0.8$，\n- 观测值 $y_t = 0.1$，\n- 随机种子 $= 99$。\n\n您的程序必须完全按照每个测试用例的描述实现采样和权重更新。最终输出格式必须是一行，包含所有测试用例（按 A、B、C、D 顺序）的串接归一化权重，形式为方括号内以逗号分隔的列表。每个浮点数必须四舍五入到恰好 $10$ 位小数。例如，一个包含两个数字的输出看起来会像 $[0.1234567890,0.8765432110]$。不涉及物理单位或角度，因此不需要单位转换。最终答案所需的数据类型是浮点数，最终输出是这样一个浮点数列表。", "solution": "当前任务是为序贯重要性采样 (SIS) 粒子滤波器实现一步权重更新。更新规则的推导必须基于贝叶斯推断和重要性采样的基本原理。\n\n我们考虑一个由潜在状态过程 $\\{x_t\\}_{t \\ge 0}$ 和观测过程 $\\{y_t\\}_{t \\ge 1}$ 定义的状态空间模型。该模型由以下部分指定：\n1.  初始分布 $p(x_0)$。\n2.  状态转移模型，其密度为 $p(x_t \\mid x_{t-1})$。\n3.  观测模型，其密度为 $p(y_t \\mid x_t)$。\n\n滤波的目标是递归地计算给定截至时间 $t$ 的所有观测值时状态 $x_t$ 的后验分布，记作 $p(x_t \\mid y_{1:t})$。贝叶斯滤波递归分为两个步骤：预测和更新。\n\n预测步骤通过状态动态演化前一个滤波分布 $p(x_{t-1} \\mid y_{1:t-1})$，以获得 $x_t$ 的预测分布：\n$$\np(x_t \\mid y_{1:t-1}) = \\int p(x_t \\mid x_{t-1}) p(x_{t-1} \\mid y_{1:t-1}) dx_{t-1}\n$$\n然后，更新步骤通过贝叶斯法则引入新的观测值 $y_t$：\n$$\np(x_t \\mid y_{1:t}) = \\frac{p(y_t \\mid x_t) p(x_t \\mid y_{1:t-1})}{p(y_t \\mid y_{1:t-1})} \\propto p(y_t \\mid x_t) p(x_t \\mid y_{1:t-1})\n$$\n对于非线性或非高斯模型，这些步骤通常是解析上难解的。SIS 提供了一种数值近似方法。\n\n在时间 $t-1$，我们假设滤波分布由一个加权经验测度近似：\n$$\np(x_{t-1} \\mid y_{1:t-1}) \\approx \\sum_{i=1}^N w_{t-1}^{(i)} \\delta_{x_{t-1}^{(i)}}(x_{t-1})\n$$\n其中 $\\{x_{t-1}^{(i)}\\}_{i=1}^N$ 是粒子，$\\{w_{t-1}^{(i)}\\}_{i=1}^N$ 是它们对应的归一化权重（$\\sum_i w_{t-1}^{(i)} = 1$），而 $\\delta_a(x)$ 是在 $a$ 处的狄拉克δ测度。\n\n为了近似时间-$t$ 的分布 $p(x_t \\mid y_{1:t})$，我们可以应用重要性采样。SIS 更新的目标分布与 $p(y_t \\mid x_t) p(x_t \\mid x_{t-1}) p(x_{t-1} \\mid y_{1:t-1})$ 成正比。我们从一个提议分布 $q_t(x_t \\mid x_{t-1}, y_t)$ 中抽样得到一组新的粒子 $\\{x_t^{(i)}\\}_{i=1}^N$。对于每个以 $x_{t-1}^{(i)}$ 结尾的现有粒子路径，我们采样一个新的状态 $x_t^{(i)} \\sim q_t(\\cdot \\mid x_{t-1}^{(i)}, y_t)$。\n\n状态轨迹的重要性权重是递归更新的。以 $(x_{t-1}^{(i)}, x_t^{(i)})$ 结尾的路径的权重 $w_t^{(i)}$ 由下式给出：\n$$\nw_t^{(i)} \\propto w_{t-1}^{(i)} \\times \\alpha_t^{(i)}\n$$\n其中 $\\alpha_t^{(i)}$ 是增量重要性权重。这个增量权重用于校正目标动态与提议分布之间的差异。它被定义为目标密度与提议密度的比率：\n$$\n\\alpha_t^{(i)} = \\frac{p(y_t \\mid x_t^{(i)}) p(x_t^{(i)} \\mid x_{t-1}^{(i)})}{q_t(x_t^{(i)} \\mid x_{t-1}^{(i)}, y_t)}\n$$\n新的未归一化权重是 $w_t^{\\prime(i)} = w_{t-1}^{(i)} \\alpha_t^{(i)}$。然后将这些权重归一化以使其总和为一：$\\tilde{w}_t^{(i)} = w_t^{\\prime(i)} / \\sum_{j=1}^N w_t^{\\prime(j)}$。\n\n为了提高数值稳定性，特别是在处理小概率的乘积时，计算在对数域中进行。未归一化的对数权重为：\n$$\n\\log w_t^{\\prime(i)} = \\log w_{t-1}^{(i)} + \\log \\alpha_t^{(i)}\n$$\n其中对数增量权重为：\n$$\n\\log \\alpha_t^{(i)} = \\log p(y_t \\mid x_t^{(i)}) + \\log p(x_t^{(i)} \\mid x_{t-1}^{(i)}) - \\log q_t(x_t^{(i)} \\mid x_{t-1}^{(i)}, y_t)\n$$\n高斯分布 $\\mathcal{N}(x; \\mu, \\sigma^2)$ 的对数概率密度由下式给出：\n$$\n\\log \\mathcal{N}(x; \\mu, \\sigma^2) = -\\frac{(x-\\mu)^2}{2\\sigma^2} - \\frac{1}{2}\\log(2\\pi\\sigma^2)\n$$\n将此应用于问题特定的密度：\n1.  **对数似然：** 从 $p(y_t \\mid x_t) = \\mathcal{N}(y_t; \\tfrac{1}{2} x_t^2, \\sigma_y^2)$，我们有：\n    $$\n    \\log p(y_t \\mid x_t^{(i)}) = -\\frac{(y_t - \\frac{1}{2}(x_t^{(i)})^2)^2}{2\\sigma_y^2} - \\frac{1}{2}\\log(2\\pi\\sigma_y^2)\n    $$\n2.  **对数转移：** 从 $p(x_t \\mid x_{t-1}) = \\mathcal{N}(x_t; a x_{t-1} + b \\sin(x_{t-1}), \\sigma_x^2)$，令 $\\mu_{trans}^{(i)} = a x_{t-1}^{(i)} + b \\sin(x_{t-1}^{(i)})$。则：\n    $$\n    \\log p(x_t^{(i)} \\mid x_{t-1}^{(i)}) = -\\frac{(x_t^{(i)} - \\mu_{trans}^{(i)})^2}{2\\sigma_x^2} - \\frac{1}{2}\\log(2\\pi\\sigma_x^2)\n    $$\n3.  **对数提议：** 提议分布 $q_t$ 有两种形式。\n    - **一般情况：** $q_t(x_t \\mid x_{t-1}, y_t) = \\mathcal{N}(x_t; a_p x_{t-1} + c x_{t-1}^3, \\sigma_q^2)$。令 $\\mu_{prop}^{(i)} = a_p x_{t-1}^{(i)} + c (x_{t-1}^{(i)})^3$。则：\n      $$\n      \\log q_t(x_t^{(i)} \\mid x_{t-1}^{(i)}, y_t) = -\\frac{(x_t^{(i)} - \\mu_{prop}^{(i)})^2}{2\\sigma_q^2} - \\frac{1}{2}\\log(2\\pi\\sigma_q^2)\n      $$\n    - **自助情况：** 提议分布是状态转移先验，即 $q_t(x_t \\mid x_{t-1}, y_t) = p(x_t \\mid x_{t-1})$。在这种情况下，$\\mu_{prop}^{(i)} = \\mu_{trans}^{(i)}$ 且 $\\sigma_q^2 = \\sigma_x^2$。对数转移项和对数提议项相互抵消，将对数增量权重简化为仅剩对数似然：\n      $$\n      \\log \\alpha_t^{(i)} = \\log p(y_t \\mid x_t^{(i)})\n      $$\n\n最后，为了将未归一化的对数权重 $\\log w_t^{\\prime(i)}$ 转换回归一化权重 $\\tilde{w}_t^{(i)}$，我们使用 log-sum-exp 技巧来防止数值上溢和下溢。令 $L_i = \\log w_t^{\\prime(i)}$ 且 $L_{max} = \\max_j L_j$。则：\n$$\n\\tilde{w}_t^{(i)} = \\frac{\\exp(L_i)}{\\sum_{j=1}^N \\exp(L_j)} = \\frac{\\exp(L_i - L_{max})}{\\sum_{j=1}^N \\exp(L_j - L_{max})}\n$$\n该过程为执行一步 SIS 更新提供了一种数值稳定的方法。实现将遵循这些推导出的公式来处理每个测试用例。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import norm\n\ndef solve():\n    \"\"\"\n    Main solver function that processes all test cases for the SIS weight update.\n    \"\"\"\n    test_cases = [\n        # Test case A (general proposal, moderate regime)\n        {\n            \"N\": 5,\n            \"x_tm1\": np.array([-1.0, -0.2, 0.3, 1.0, 2.0]),\n            \"w_tm1\": np.array([0.1, 0.2, 0.4, 0.2, 0.1]),\n            \"a\": 0.7, \"b\": 0.3, \"sigma_x\": 0.5, \"sigma_y\": 0.8,\n            \"proposal_type\": \"general\",\n            \"a_p\": 0.5, \"c\": -0.1, \"sigma_q\": 0.7,\n            \"y_t\": 1.25,\n            \"seed\": 123\n        },\n        # Test case B (bootstrap proposal, random-walk transition)\n        {\n            \"N\": 4,\n            \"x_tm1\": np.array([-0.5, 0.0, 0.5, 1.5]),\n            \"w_tm1\": np.array([0.25, 0.25, 0.25, 0.25]),\n            \"a\": 1.0, \"b\": 0.0, \"sigma_x\": 0.3, \"sigma_y\": 0.4,\n            \"proposal_type\": \"bootstrap\",\n            \"a_p\": None, \"c\": None, \"sigma_q\": None, # Will be set from transition\n            \"y_t\": 0.5,\n            \"seed\": 7\n        },\n        # Test case C (general proposal, near-degenerate likelihood regime)\n        {\n            \"N\": 3,\n            \"x_tm1\": np.array([-2.0, 0.0, 2.0]),\n            \"w_tm1\": np.array([0.2, 0.6, 0.2]),\n            \"a\": 0.9, \"b\": 0.1, \"sigma_x\": 0.2, \"sigma_y\": 0.05,\n            \"proposal_type\": \"general\",\n            \"a_p\": 0.9, \"c\": 0.0, \"sigma_q\": 1.0,\n            \"y_t\": 10.0,\n            \"seed\": 42\n        },\n        # Test case D (single-particle edge case)\n        {\n            \"N\": 1,\n            \"x_tm1\": np.array([0.3]),\n            \"w_tm1\": np.array([1.0]),\n            \"a\": 0.5, \"b\": 0.5, \"sigma_x\": 1.2, \"sigma_y\": 0.3,\n            \"proposal_type\": \"general\",\n            \"a_p\": 0.5, \"c\": 0.0, \"sigma_q\": 0.8,\n            \"y_t\": 0.1,\n            \"seed\": 99\n        }\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        # Extract parameters\n        N = case[\"N\"]\n        x_tm1 = case[\"x_tm1\"]\n        w_tm1 = case[\"w_tm1\"]\n        a, b, sigma_x, sigma_y = case[\"a\"], case[\"b\"], case[\"sigma_x\"], case[\"sigma_y\"]\n        y_t = case[\"y_t\"]\n        seed = case[\"seed\"]\n        \n        # Set up random number generator for reproducibility\n        rng = np.random.default_rng(seed)\n\n        # Define proposal parameters based on type\n        if case[\"proposal_type\"] == \"bootstrap\":\n            # For bootstrap, proposal is the transition prior\n            a_p, c, sigma_q = a, 0.0, sigma_x\n        else: # general\n            a_p, c, sigma_q = case[\"a_p\"], case[\"c\"], case[\"sigma_q\"]\n\n        # 1. Sample new particles x_t from the proposal distribution q_t\n        # mean of the proposal distribution\n        mu_prop = a_p * x_tm1 + c * x_tm1**3\n        # sample new particles\n        x_t = mu_prop + sigma_q * rng.standard_normal(size=N)\n\n        # 2. Compute importance weights in log-domain\n        # Log of previous weights\n        # np.log can produce -inf for w=0, but all given weights are  0.\n        log_w_tm1 = np.log(w_tm1)\n\n        # Calculate the three components of the log-incremental weight\n        # a) Log-likelihood: log p(y_t | x_t)\n        log_p_yt_xt = norm.logpdf(y_t, loc=0.5 * x_t**2, scale=sigma_y)\n        \n        # b) Log-transition: log p(x_t | x_{t-1})\n        mu_trans = a * x_tm1 + b * np.sin(x_tm1)\n        log_p_xt_xtm1 = norm.logpdf(x_t, loc=mu_trans, scale=sigma_x)\n\n        # c) Log-proposal: log q(x_t | x_{t-1}, y_t)\n        # The means mu_prop were already computed for sampling\n        log_q_xt = norm.logpdf(x_t, loc=mu_prop, scale=sigma_q)\n        \n        # Log-incremental weight\n        log_alpha_t = log_p_yt_xt + log_p_xt_xtm1 - log_q_xt\n\n        # Unnormalized log-weights at time t\n        log_w_t_unnormalized = log_w_tm1 + log_alpha_t\n        \n        # 3. Normalize weights using log-sum-exp trick for numerical stability\n        if N  0:\n            log_w_max = np.max(log_w_t_unnormalized)\n            # Subtract max for stability, then exponentiate\n            w_t_shifted = np.exp(log_w_t_unnormalized - log_w_max)\n            # Normalize\n            w_t_normalized = w_t_shifted / np.sum(w_t_shifted)\n        else:\n            w_t_normalized = np.array([])\n            \n        # Append formatted results to the final list\n        for w in w_t_normalized:\n            all_results.append(f\"{w:.10f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(all_results)}]\")\n\nsolve()\n```", "id": "3338877"}, {"introduction": "随着时间的推移，序贯重要性采样会面临一个被称为“权重退化”的关键挑战：即少数粒子的权重会趋近于1，而其他所有粒子的权重则变得可以忽略不计，导致滤波器效率低下。有效样本量（ESS）是衡量这种退化程度的标准诊断工具。这个练习 [@problem_id:3338911] 不仅要求你计算ESS，还要求你从其第一性原理出发推导出其常用公式，从而加深对该指标真实含义的理解，并为重采样步骤的必要性提供依据。", "problem": "在一个序贯重要性重采样 (SIR) 自举滤波器中，特定时间步 $t$ 产生了一个包含 $N = 5$ 个粒子 $\\{X_{t}^{(i)}\\}_{i=1}^{5}$ 的粒子系统，以及相关的未归一化重要性权重 $\\{w_{t}^{(i)}\\}_{i=1}^{5}$。这些未归一化的权重仅在一个未知的正比例因子 $k  0$ 的尺度下已知，其值为\n$$\nw_{t}^{(1)} = 3k,\\quad w_{t}^{(2)} = 0,\\quad w_{t}^{(3)} = k,\\quad w_{t}^{(4)} = k,\\quad w_{t}^{(5)} = 5k.\n$$\n令 $\\tilde{w}_{t}^{(i)} = w_{t}^{(i)}\\big/\\sum_{j=1}^{N} w_{t}^{(j)}$ 表示归一化权重。对于一个有界测试函数 $h$，其自归一化重要性采样估计量为\n$$\n\\hat{I}_{t}(h) = \\sum_{i=1}^{N} \\tilde{w}_{t}^{(i)}\\, h\\!\\left(X_{t}^{(i)}\\right).\n$$\n从有效样本量 (ESS) 的基本定义出发，ESS 是唯一的 $N_{\\mathrm{eff}}$，使得在独立性和等方差假设下，$\\hat{I}_{t}(h)$ 的方差与一个基于 $N_{\\mathrm{eff}}$ 个等权重且独立的样本的标准蒙特卡罗估计量的方差相匹配。仅使用此定义和独立和的标准方差性质，首先推导出一个用归一化权重 $\\{\\tilde{w}_{t}^{(i)}\\}_{i=1}^{N}$ 表示 $N_{\\mathrm{eff}}$ 的表达式。然后使用你的表达式计算上述给定权重向量的 $N_{\\mathrm{eff}}$，并明确证明它与未知的比例因子 $k$ 无关。\n\n该算法在时间 $t$ 的重采样规则是：当且仅当 $N_{\\mathrm{eff}}  \\tau_{t}$ 时触发重采样，其中阈值为 $\\tau_{t} = \\alpha N$ 且 $\\alpha = \\tfrac{1}{2}$。请根据此规则确定在时间 $t$ 是否应执行重采样。\n\n请将你的最终答案表示为 $N_{\\mathrm{eff}}$ 的精确值，写成最简分数形式，不带单位。最终数值答案中不要包含重采样决策。", "solution": "首先验证问题以确保其科学上合理、提法恰当且客观。\n\n### 步骤 1：提取已知条件\n- 粒子数：$N = 5$\n- 未归一化重要性权重：$\\{w_{t}^{(i)}\\}_{i=1}^{5}$，其值为 $w_{t}^{(1)} = 3k$，$w_{t}^{(2)} = 0$，$w_{t}^{(3)} = k$，$w_{t}^{(4)} = k$，$w_{t}^{(5)} = 5k$，其中 $k  0$ 是一个未知的正比例因子。\n- 归一化权重：$\\tilde{w}_{t}^{(i)} = w_{t}^{(i)}\\big/\\sum_{j=1}^{N} w_{t}^{(j)}$。\n- 自归一化重要性采样估计量：对于一个有界测试函数 $h$，$\\hat{I}_{t}(h) = \\sum_{i=1}^{N} \\tilde{w}_{t}^{(i)}\\, h\\!\\left(X_{t}^{(i)}\\right)$。\n- 有效样本量 ($N_{\\mathrm{eff}}$) 的基本定义：$N_{\\mathrm{eff}}$ 是唯一的数值，使得在独立性和等方差假设下，$\\hat{I}_{t}(h)$ 的方差与一个基于 $N_{\\mathrm{eff}}$ 个等权重且独立的样本的标准蒙特卡罗估计量的方差相匹配。\n- 重采样规则：如果 $N_{\\mathrm{eff}}  \\tau_{t}$ 则重采样。\n- 重采样阈值：$\\tau_{t} = \\alpha N$ 且 $\\alpha = \\tfrac{1}{2}$。\n\n### 步骤 2：使用提取的已知条件进行验证\n该问题是序贯蒙特卡罗方法（粒子滤波器）领域的一个标准练习题。它要求从有效样本量 (ESS) 的概念性定义出发，推导这个基本量，并为一组给定的参数计算其值。所有概念（重要性权重、自归一化估计量、ESS、重采样）在文献中都是标准且定义明确的。该问题是自洽的，数学上一致的，并且没有任何科学或逻辑上的缺陷。所提供的值是用于教授该主题的典型“玩具”示例。\n\n### 步骤 3：结论与行动\n问题被判定为**有效**。将提供完整解答。\n\n### 有效样本量 ($N_{\\mathrm{eff}}$) 的推导\n\n问题要求从 $N_{\\mathrm{eff}}$ 的基本定义出发推导其表达式。给定自归一化重要性采样估计量：\n$$\n\\hat{I}_{t}(h) = \\sum_{i=1}^{N} \\tilde{w}_{t}^{(i)}\\, h\\!\\left(X_{t}^{(i)}\\right)\n$$\n为了求其方差，我们将归一化权重 $\\{\\tilde{w}_{t}^{(i)}\\}$ 视为固定常数，并将粒子 $\\{X_{t}^{(i)}\\}$ 视为独立抽取的。这意味着随机变量 $h(X_{t}^{(i)})$ 是独立的。问题要求假设它们具有相同的方差，我们将其表示为 $\\sigma^2 = \\mathrm{Var}(h(X_{t}^{(i)}))$。\n\n使用独立随机变量加权和的方差性质 $\\mathrm{Var}(\\sum a_i Y_i) = \\sum a_i^2 \\mathrm{Var}(Y_i)$，我们有：\n$$\n\\mathrm{Var}(\\hat{I}_{t}(h)) = \\mathrm{Var}\\left(\\sum_{i=1}^{N} \\tilde{w}_{t}^{(i)}\\, h(X_{t}^{(i)})\\right) = \\sum_{i=1}^{N} (\\tilde{w}_{t}^{(i)})^2 \\mathrm{Var}(h(X_{t}^{(i)}))\n$$\n应用等方差假设：\n$$\n\\mathrm{Var}(\\hat{I}_{t}(h)) = \\sum_{i=1}^{N} (\\tilde{w}_{t}^{(i)})^2 \\sigma^2 = \\sigma^2 \\sum_{i=1}^{N} (\\tilde{w}_{t}^{(i)})^2\n$$\n接下来，考虑针对同一数量的标准蒙特卡罗估计量，但该估计量基于从目标分布中直接抽取的 $N_{\\mathrm{eff}}$ 个独立同分布的样本 $\\{Y_j\\}_{j=1}^{N_{\\mathrm{eff}}}$。该估计量是样本均值：\n$$\n\\hat{J}_{N_{\\mathrm{eff}}}(h) = \\frac{1}{N_{\\mathrm{eff}}} \\sum_{j=1}^{N_{\\mathrm{eff}}} h(Y_j)\n$$\n假设 $\\mathrm{Var}(h(Y_j)) = \\sigma^2$，这个标准估计量的方差是：\n$$\n\\mathrm{Var}(\\hat{J}_{N_{\\mathrm{eff}}}(h)) = \\mathrm{Var}\\left(\\frac{1}{N_{\\mathrm{eff}}} \\sum_{j=1}^{N_{\\mathrm{eff}}} h(Y_j)\\right) = \\frac{1}{(N_{\\mathrm{eff}})^2} \\sum_{j=1}^{N_{\\mathrm{eff}}} \\mathrm{Var}(h(Y_j)) = \\frac{1}{(N_{\\mathrm{eff}})^2}} N_{\\mathrm{eff}} \\sigma^2 = \\frac{\\sigma^2}{N_{\\mathrm{eff}}}\n$$\n$N_{\\mathrm{eff}}$ 的定义要求这两个方差相等：\n$$\n\\mathrm{Var}(\\hat{I}_{t}(h)) = \\mathrm{Var}(\\hat{J}_{N_{\\mathrm{eff}}}(h))\n$$\n$$\n\\sigma^2 \\sum_{i=1}^{N} (\\tilde{w}_{t}^{(i)})^2 = \\frac{\\sigma^2}{N_{\\mathrm{eff}}}\n$$\n假设存在一个非平凡的测试函数 $h$ 使得 $\\sigma^2  0$，我们可以将两边同除以 $\\sigma^2$：\n$$\n\\sum_{i=1}^{N} (\\tilde{w}_{t}^{(i)})^2 = \\frac{1}{N_{\\mathrm{eff}}}\n$$\n解出 $N_{\\mathrm{eff}}$ 即可得到所需的表达式：\n$$\nN_{\\mathrm{eff}} = \\frac{1}{\\sum_{i=1}^{N} (\\tilde{w}_{t}^{(i)})^2}\n$$\n\n### $N_{\\mathrm{eff}}$ 的计算和重采样决策\n\n给定 $N=5$ 和未归一化的权重：\n$w_{t}^{(1)} = 3k$，$w_{t}^{(2)} = 0$，$w_{t}^{(3)} = k$，$w_{t}^{(4)} = k$，$w_{t}^{(5)} = 5k$。\n\n首先，我们计算未归一化权重的和，即归一化常数：\n$$\n\\sum_{j=1}^{5} w_{t}^{(j)} = 3k + 0 + k + k + 5k = 10k\n$$\n接下来，我们计算归一化权重 $\\tilde{w}_{t}^{(i)} = w_{t}^{(i)} / \\sum_{j=1}^{5} w_{t}^{(j)}$：\n$$\n\\tilde{w}_{t}^{(1)} = \\frac{3k}{10k} = \\frac{3}{10}\n$$\n$$\n\\tilde{w}_{t}^{(2)} = \\frac{0}{10k} = 0\n$$\n$$\n\\tilde{w}_{t}^{(3)} = \\frac{k}{10k} = \\frac{1}{10}\n$$\n$$\n\\tilde{w}_{t}^{(4)} = \\frac{k}{10k} = \\frac{1}{10}\n$$\n$$\n\\tilde{w}_{t}^{(5)} = \\frac{5k}{10k} = \\frac{5}{10} = \\frac{1}{2}\n$$\n如图所示，未知的比例因子 $k0$ 在归一化过程中被消除了，这表明归一化权重以及因此得到的 $N_{\\mathrm{eff}}$ 不受此因子的影响。\n\n现在，我们计算归一化权重的平方和：\n$$\n\\sum_{i=1}^{5} (\\tilde{w}_{t}^{(i)})^2 = \\left(\\frac{3}{10}\\right)^2 + 0^2 + \\left(\\frac{1}{10}\\right)^2 + \\left(\\frac{1}{10}\\right)^2 + \\left(\\frac{1}{2}\\right)^2\n$$\n$$\n= \\frac{9}{100} + 0 + \\frac{1}{100} + \\frac{1}{100} + \\frac{1}{4} = \\frac{9}{100} + \\frac{1}{100} + \\frac{1}{100} + \\frac{25}{100}\n$$\n$$\n= \\frac{9+1+1+25}{100} = \\frac{36}{100}\n$$\n使用推导出的 $N_{\\mathrm{eff}}$ 公式：\n$$\nN_{\\mathrm{eff}} = \\frac{1}{\\sum_{i=1}^{5} (\\tilde{w}_{t}^{(i)})^2} = \\frac{1}{36/100} = \\frac{100}{36}\n$$\n将分数化为最简形式：\n$$\nN_{\\mathrm{eff}} = \\frac{100 \\div 4}{36 \\div 4} = \\frac{25}{9}\n$$\n\n最后，我们确定是否应执行重采样。重采样阈值为 $\\tau_{t} = \\alpha N$，其中 $\\alpha = \\frac{1}{2}$ 且 $N=5$：\n$$\n\\tau_{t} = \\frac{1}{2} \\times 5 = \\frac{5}{2}\n$$\n规则是如果 $N_{\\mathrm{eff}}  \\tau_{t}$ 则进行重采样。我们将计算出的 $N_{\\mathrm{eff}}$ 与阈值 $\\tau_t$ 进行比较：\n$$\nN_{\\mathrm{eff}} = \\frac{25}{9} \\quad \\text{且} \\quad \\tau_{t} = \\frac{5}{2}\n$$\n为了比较这两个分数，我们可以通分，公分母为 $18$：\n$$\nN_{\\mathrm{eff}} = \\frac{25 \\times 2}{9 \\times 2} = \\frac{50}{18}\n$$\n$$\n\\tau_{t} = \\frac{5 \\times 9}{2 \\times 9} = \\frac{45}{18}\n$$\n由于 $\\frac{50}{18} > \\frac{45}{18}$，我们有 $N_{\\mathrm{eff}} > \\tau_{t}$。重采样的条件 ($N_{\\mathrm{eff}}  \\tau_{t}$) 未被满足。因此，在时间 $t$ 不应执行重采样。\n\n要求的最终答案是 $N_{\\mathrm{eff}}$ 以最简分数表示的精确值。", "answer": "$$\\boxed{\\frac{25}{9}}$$", "id": "3338911"}]}