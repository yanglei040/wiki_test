{"hands_on_practices": [{"introduction": "Marsaglia 极坐标法是一种拒绝抽样方法，其效率取决于接受一个样本所需的平均尝试次数。这个练习将从第一性原理出发，推导成功接受一次所需的期望尝试次数及其方差，从而帮助你深入理解该方法的计算成本 [@problem_id:3324394]。这项分析对于任何拒绝抽样算法的性能评估都至关重要。", "problem": "考虑用于生成独立标准正态变量的 Marsaglia 极坐标法的接受阶段。在每次提议中，从正方形 $[-1,1] \\times [-1,1]$ 上均匀抽取一对 $(V_1,V_2)$，如果 $S = V_1^2 + V_2^2  1$，则该提议被接受。独立地重复提议，直到首次接受发生。令 $N$ 为获得第一个被接受的对所需的总提议对数。\n\n从连续均匀分布和平面（勒贝格）测度的定义出发，推导单次提议的接受概率 $p$。然后，使用几何分布作为首次成功前独立同分布的伯努利试验次数的定义，并且不使用预先计算的均值或方差公式，推导出期望值 $\\mathbb{E}[N]$ 和方差 $\\operatorname{Var}(N)$ 的闭式解析表达式（用 $\\pi$ 表示）。你的推导应从你根据基本原理证明的级数恒等式出发。\n\n提供 $\\mathbb{E}[N]$ 和 $\\operatorname{Var}(N)$ 的最终答案，形式为精确的解析表达式。无需四舍五入，不涉及单位。", "solution": "用户希望通过验证问题陈述来开始解决问题。\n\n### 第 1 步：提取已知条件\n- 一对随机变量 $(V_1, V_2)$ 在正方形 $[-1, 1] \\times [-1, 1]$ 上均匀抽取。\n- 如果 $S = V_1^2 + V_2^2  1$，则提议被接受。\n- 提议是独立的，并重复进行直到首次接受。\n- 随机变量 $N$ 是获得第一个被接受的对所需的总提议对数。\n- 接受概率 $p$ 的推导必须从连续均匀分布和平面测度的定义开始。\n- 期望值 $\\mathbb{E}[N]$ 和方差 $\\operatorname{Var}(N)$ 的推导必须从基本原理出发，使用经过证明的级数恒等式，而不是调用几何分布的预计算均值或方差公式。\n- $\\mathbb{E}[N]$ 和 $\\operatorname{Var}(N)$ 的最终答案必须是关于 $\\pi$ 的精确解析表达式。\n\n### 第 2 步：使用提取的已知条件进行验证\n- **科学依据：** 该问题基于成熟的 Marsaglia 极坐标法，这是计算统计学和蒙特卡洛方法领域的标准算法。所有前提在事实上都是正确的。\n- **适定性：** 问题陈述清晰，所有量都有明确定义。问题要求推导一个由清晰的概率过程定义的随机变量的特定统计属性。存在唯一、稳定且有意义的解。\n- **客观性：** 问题以精确、客观的数学语言陈述，没有歧义或主观论断。\n- **完备性与一致性：** 问题是自洽的。它提供了推导所求量所需的所有必要信息（抽样域、接受准则、随机变量 $N$ 的定义）。没有矛盾之处。\n- **其他缺陷：** 问题没有表现出任何其他缺陷，如不切实际、不可形式化、不适定、同义反复或无法验证。要求从基本原理推导结果是检验基本理解的标准教学工具。\n\n### 第 3 步：结论与行动\n问题是有效的。将按要求提供解答。\n\n### 解题推导\n\n解题过程按要求分为两部分：首先，推导接受概率 $p$；其次，从基本原理推导期望 $\\mathbb{E}[N]$ 和方差 $\\operatorname{Var}(N)$。\n\n**第 1 部分：接受概率 $p$ 的推导**\n\n随机变量对 $(V_1, V_2)$ 从正方形区域 $\\mathcal{C} = [-1, 1] \\times [-1, 1]$ 上的连续均匀分布中抽取。这个正方形的面积，即一个平面勒贝格测度，由下式给出\n$$\n\\text{Area}(\\mathcal{C}) = (1 - (-1)) \\times (1 - (-1)) = 2 \\times 2 = 4\n$$\n根据一个区域上连续均匀分布的定义，其联合概率密度函数 (PDF) $f_{V_1, V_2}(v_1, v_2)$ 在区域内为常数，在区域外为零。该常数的值是该区域面积的倒数。\n$$\nf_{V_1, V_2}(v_1, v_2) =\n\\begin{cases}\n\\frac{1}{\\text{Area}(\\mathcal{C})} = \\frac{1}{4}  \\text{if } (v_1, v_2) \\in \\mathcal{C} \\\\\n0  \\text{otherwise}\n\\end{cases}\n$$\n如果抽取的对 $(V_1, V_2)$ 满足条件 $S = V_1^2 + V_2^2  1$，则提议被接受。该条件定义了一个以原点 $(0,0)$ 为中心、半径 $r=1$ 的开圆盘 $\\mathcal{D}$。接受概率 $p$ 是从正方形 $\\mathcal{C}$ 中均匀选择的一个点位于圆盘 $\\mathcal{D}$ 内的概率。该概率通过在接受区域 $\\mathcal{D}$ 上对联合 PDF 进行积分来计算。\n$$\np = P(V_1^2 + V_2^2  1) = \\iint_{\\mathcal{D}} f_{V_1, V_2}(v_1, v_2) \\, dv_1 \\, dv_2\n$$\n圆盘 $\\mathcal{D}$ 完全包含在正方形 $\\mathcal{C}$ 内（因为对于 $\\mathcal{D}$ 内的任何点 $(v_1,v_2)$，我们有 $v_1^2  1$ 和 $v_2^2  1$，这意味着 $|v_1|  1$ 和 $|v_2|  1$）。因此，在整个积分域 $\\mathcal{D}$ 上，PDF 是常数 $\\frac{1}{4}$。\n$$\np = \\iint_{\\mathcal{D}} \\frac{1}{4} \\, dv_1 \\, dv_2 = \\frac{1}{4} \\iint_{\\mathcal{D}} \\, dv_1 \\, dv_2\n$$\n积分 $\\iint_{\\mathcal{D}} \\, dv_1 \\, dv_2$ 就是圆盘 $\\mathcal{D}$ 的面积。半径为 $r=1$ 的圆盘面积是 $\\pi r^2 = \\pi(1)^2 = \\pi$。\n因此，接受概率是接受区域的面积与抽样区域的面积之比：\n$$\np = \\frac{\\text{Area}(\\mathcal{D})}{\\text{Area}(\\mathcalC)} = \\frac{\\pi}{4}\n$$\n\n**第 2 部分：$\\mathbb{E}[N]$ 和 $\\operatorname{Var}(N)$ 的推导**\n\n随机变量 $N$ 表示获得首次成功所需的独立同分布伯努利试验的次数。每次试验都是一次提议，而“成功”就是一次被接受的提议。在任何单次试验中，成功的概率是 $p = \\frac{\\pi}{4}$。这对 $N$ 定义了一个几何分布。$N$ 的概率质量函数 (PMF) 由下式给出\n$$\nP(N=k) = (1-p)^{k-1}p \\quad \\text{for } k \\in \\{1, 2, 3, \\ldots\\}\n$$\n为方便起见，令 $q = 1-p$。则 PMF 为 $P(N=k) = q^{k-1}p$。\n\n要从基本原理推导期望和方差，我们依赖于几何级数及其导数的公式。对于任何实数 $|x|  1$，几何级数为\n$$\n\\sum_{k=0}^{\\infty} x^k = \\frac{1}{1-x}\n$$\n对 $x$ 求导（对于 $|x|1$ 是有效的）得到\n$$\n\\frac{d}{dx} \\sum_{k=0}^{\\infty} x^k = \\sum_{k=1}^{\\infty} kx^{k-1} = \\frac{d}{dx} (1-x)^{-1} = ( -1)(1-x)^{-2}(-1) = \\frac{1}{(1-x)^2}\n$$\n再次求导得到\n$$\n\\frac{d}{dx} \\sum_{k=1}^{\\infty} kx^{k-1} = \\sum_{k=2}^{\\infty} k(k-1)x^{k-2} = \\frac{d}{dx} (1-x)^{-2} = (-2)(1-x)^{-3}(-1) = \\frac{2}{(1-x)^3}\n$$\n\n**$\\mathbb{E}[N]$ 的推导**\n根据离散随机变量期望值的定义：\n$$\n\\mathbb{E}[N] = \\sum_{k=1}^{\\infty} k \\cdot P(N=k) = \\sum_{k=1}^{\\infty} k q^{k-1} p = p \\sum_{k=1}^{\\infty} k q^{k-1}\n$$\n由于 $p = \\frac{\\pi}{4}$，我们有 $0  p  1$，这意味着 $0  q  1$。我们可以使用上面推导的关于 $x=q$ 的一阶导数恒等式：\n$$\n\\mathbb{E}[N] = p \\left( \\frac{1}{(1-q)^2} \\right)\n$$\n代入 $1-q = 1-(1-p) = p$，我们得到：\n$$\n\\mathbb{E}[N] = p \\left( \\frac{1}{p^2} \\right) = \\frac{1}{p}\n$$\n最后，代入 $p = \\frac{\\pi}{4}$：\n$$\n\\mathbb{E}[N] = \\frac{1}{\\pi/4} = \\frac{4}{\\pi}\n$$\n\n**$\\operatorname{Var}(N)$ 的推导**\n方差定义为 $\\operatorname{Var}(N) = \\mathbb{E}[N^2] - (\\mathbb{E}[N])^2$。我们首先需要计算 $\\mathbb{E}[N^2]$。\n$$\n\\mathbb{E}[N^2] = \\sum_{k=1}^{\\infty} k^2 \\cdot P(N=k) = \\sum_{k=1}^{\\infty} k^2 q^{k-1} p = p \\sum_{k=1}^{\\infty} k^2 q^{k-1}\n$$\n我们使用恒等式 $k^2 = k(k-1) + k$ 来分解这个和：\n$$\n\\sum_{k=1}^{\\infty} k^2 q^{k-1} = \\sum_{k=1}^{\\infty} (k(k-1) + k) q^{k-1} = \\sum_{k=1}^{\\infty} k(k-1)q^{k-1} + \\sum_{k=1}^{\\infty} k q^{k-1}\n$$\n和中的第一项在 $k=1$ 时为零，因此更精确的形式是 $\\sum_{k=2}^{\\infty} k(k-1)q^{k-1}$。\n第二个和是我们为期望值计算过的那个：$\\sum_{k=1}^{\\infty} k q^{k-1} = \\frac{1}{(1-q)^2} = \\frac{1}{p^2}$。\n对于第一个和，我们使用二阶导数恒等式。\n$$\n\\sum_{k=2}^{\\infty} k(k-1)q^{k-1} = q \\sum_{k=2}^{\\infty} k(k-1)q^{k-2}\n$$\n使用我们的恒等式，并令 $x=q$：\n$$\n\\sum_{k=2}^{\\infty} k(k-1)q^{k-1} = q \\left( \\frac{2}{(1-q)^3} \\right) = \\frac{2q}{(1-q)^3} = \\frac{2q}{p^3}\n$$\n现在，我们可以组合出 $\\mathbb{E}[N^2]$ 的表达式：\n$$\n\\mathbb{E}[N^2] = p \\left( \\frac{2q}{p^3} + \\frac{1}{p^2} \\right) = \\frac{2q}{p^2} + \\frac{1}{p}\n$$\n现在，我们计算方差：\n$$\n\\operatorname{Var}(N) = \\mathbb{E}[N^2] - (\\mathbb{E}[N])^2 = \\left( \\frac{2q}{p^2} + \\frac{1}{p} \\right) - \\left( \\frac{1}{p} \\right)^2 = \\frac{2q}{p^2} + \\frac{1}{p} - \\frac{1}{p^2}\n$$\n$$\n\\operatorname{Var}(N) = \\frac{2q + p - 1}{p^2}\n$$\n代入 $q=1-p$：\n$$\n\\operatorname{Var}(N) = \\frac{2(1-p) + p - 1}{p^2} = \\frac{2 - 2p + p - 1}{p^2} = \\frac{1-p}{p^2}\n$$\n最后，代入 $p = \\frac{\\pi}{4}$：\n$$\n\\operatorname{Var}(N) = \\frac{1 - \\frac{\\pi}{4}}{(\\frac{\\pi}{4})^2} = \\frac{\\frac{4-\\pi}{4}}{\\frac{\\pi^2}{16}} = \\frac{4-\\pi}{4} \\cdot \\frac{16}{\\pi^2} = \\frac{4(4-\\pi)}{\\pi^2} = \\frac{16-4\\pi}{\\pi^2}\n$$\n所要求的期望值和方差的表达式已从基本原理推导得出。", "answer": "$$\n\\boxed{\\begin{pmatrix} \\frac{4}{\\pi}  \\frac{16-4\\pi}{\\pi^2} \\end{pmatrix}}\n$$", "id": "3324394"}, {"introduction": "在将理论算法转化为实际代码时，我们常常需要处理浮点数运算带来的数值稳定性问题。这个练习模拟了一个常见场景：通过引入一个小的阈值 $\\epsilon$ 来避免对接近零的数值取对数或做除法 [@problem_id:3324458]。你将需要严格分析这种为保证数值稳定性而做的修改会给最终结果引入多大的统计偏差，这是实践者必须掌握的关键技能。", "problem": "考虑用于生成独立标准正态分布随机变量的 Marsaglia 极坐标法。设 $U_1$ 和 $U_2$ 为独立同分布的随机变量，均在区间 $(-1,1)$ 上均匀分布。定义 $S = U_1^2 + U_2^2$，并且当且仅当 $S \\in (0,1)$ 时接受点对 $(U_1,U_2)$。在接受的条件下，该方法输出\n$$\nZ_1 = U_1 \\sqrt{\\frac{-2 \\ln S}{S}}。\n$$\n在实践中，为避免 $S$ 值过小时出现数值不稳定性，可以用阈值化后的量 $S_\\epsilon = \\max(S,\\epsilon)$ 替换 $S$（其中 $\\epsilon > 0$ 为一个很小的数），并定义相应的输出为\n$$\nZ_1^{(\\epsilon)} = U_1 \\sqrt{\\frac{-2 \\ln S_\\epsilon}{S_\\epsilon}}。\n$$\n从随机模拟和几何概率的基本原理出发，推导在这种阈值化下对 $Z_1$ 的估计方差所产生的偏差的精确表达式，该偏差定义为\n$$\n\\mathrm{Bias}(\\epsilon) = \\mathbb{E}\\!\\left[\\left(Z_1^{(\\epsilon)}\\right)^2\\right] - 1,\n$$\n其中期望是针对被接受的点对 $(U_1,U_2)$ 计算的。你的推导过程必须包括：刻画在接受条件下 $(U_1,U_2)$ 的联合分布，确定 $S$ 的诱导分布，以及通过条件法计算 $\\mathbb{E}\\!\\left[\\left(Z_1^{(\\epsilon)}\\right)^2\\right]$。然后，给出当 $\\epsilon \\to 0^+$ 时 $\\mathrm{Bias}(\\epsilon)$ 的渐近误差率，并确定其主项和次高阶项。将你的最终答案表示为 $\\mathrm{Bias}(\\epsilon)$ 的单个闭式解析表达式。无需四舍五入；不要包含单位。", "solution": "该问题要求推导修正的 Marsaglia 极坐标法生成的随机变量方差的偏差的精确表达式。偏差定义为 $\\mathrm{Bias}(\\epsilon) = \\mathbb{E}\\!\\left[\\left(Z_1^{(\\epsilon)}\\right)^2\\right] - 1$，其中期望是针对被接受的随机变量对 $(U_1, U_2)$ 计算的。\n\n首先，我们必须刻画在接受条件下 $(U_1, U_2)$ 的联合分布。变量 $U_1$ 和 $U_2$ 独立同分布，服从区间 $(-1,1)$ 上的均匀分布。它们的联合概率密度函数 (PDF) 为 $f_{U_1,U_2}(u_1, u_2) = \\frac{1}{4}$，其中 $(u_1, u_2) \\in [-1,1] \\times [-1,1]$。接受条件是 $S = U_1^2 + U_2^2 \\in (0,1)$，这定义了单位圆盘的内部，记为 $\\mathcal{D}$。初始采样正方形的面积是 $4$，而接受区域圆盘 $\\mathcal{D}$ 的面积是 $\\pi(1)^2 = \\pi$。接受概率是这两个面积的比值，$P(S  1) = \\frac{\\pi}{4}$。在接受的条件下，点对 $(U_1, U_2)$ 在单位圆盘 $\\mathcal{D}$ 上均匀分布。因此，条件联合 PDF 为：\n$$\nf(u_1, u_2 | S  1) = \\begin{cases} \\frac{1}{\\pi}  \\text{若 } u_1^2 + u_2^2  1 \\\\ 0  \\text{其他情况} \\end{cases}\n$$\n需要计算的量是 $\\mathbb{E}\\!\\left[\\left(Z_1^{(\\epsilon)}\\right)^2\\right]$，其中期望是关于此条件分布计算的。$\\left(Z_1^{(\\epsilon)}\\right)^2$ 的表达式为：\n$$\n\\left(Z_1^{(\\epsilon)}\\right)^2 = \\left(U_1 \\sqrt{\\frac{-2 \\ln S_\\epsilon}{S_\\epsilon}}\\right)^2 = U_1^2 \\frac{-2 \\ln S_\\epsilon}{S_\\epsilon}\n$$\n其中 $S = U_1^2 + U_2^2$ 且 $S_\\epsilon = \\max(S, \\epsilon)$，对于某个小的 $\\epsilon > 0$。\n\n我们使用全期望定律，以 $S=s$ 为条件进行计算：\n$$\n\\mathbb{E}\\!\\left[\\left(Z_1^{(\\epsilon)}\\right)^2\\right] = \\mathbb{E}_S\\left[ \\mathbb{E}\\left[ U_1^2 \\frac{-2 \\ln S_\\epsilon}{S_\\epsilon} \\Big| S=s \\right] \\right] = \\mathbb{E}_S\\left[ \\frac{-2 \\ln s_\\epsilon}{s_\\epsilon} \\mathbb{E}\\left[ U_1^2 \\Big| S=s \\right] \\right]\n$$\n其中 $s_\\epsilon = \\max(s, \\epsilon)$。\n\n接下来，我们求条件期望 $\\mathbb{E}[U_1^2 | S=s]$。给定 $U_1^2 + U_2^2 = s$，点 $(U_1, U_2)$ 在半径为 $\\sqrt{s}$ 的圆周上均匀分布。我们可以用极坐标表示该点为 $U_1 = \\sqrt{s}\\cos\\Theta$ 和 $U_2 = \\sqrt{s}\\sin\\Theta$，其中 $\\Theta$ 是一个在 $[0, 2\\pi)$ 上均匀分布的随机变量。根据 $U_1$ 和 $U_2$ 分布的对称性，我们有 $\\mathbb{E}[U_1^2 | S=s] = \\mathbb{E}[U_2^2 | S=s]$。它们的和为：\n$$\n\\mathbb{E}[U_1^2 | S=s] + \\mathbb{E}[U_2^2 | S=s] = \\mathbb{E}[U_1^2 + U_2^2 | S=s] = \\mathbb{E}[s | S=s] = s\n$$\n这意味着 $2\\mathbb{E}[U_1^2 | S=s] = s$，所以 $\\mathbb{E}[U_1^2 | S=s] = \\frac{s}{2}$。\n\n将此结果代回到全期望的表达式中，得到：\n$$\n\\mathbb{E}\\!\\left[\\left(Z_1^{(\\epsilon)}\\right)^2\\right] = \\mathbb{E}_S\\left[ \\frac{-2 \\ln s_\\epsilon}{s_\\epsilon} \\cdot \\frac{S}{2} \\right] = \\mathbb{E}_S\\left[ -S \\frac{\\ln S_\\epsilon}{S_\\epsilon} \\right]\n$$\n为了计算这个期望，我们需要在接受条件 ($S1$) 下 $S$ 的概率密度函数 (PDF)。对于 $s \\in [0,1)$， $S$ 的条件累积分布函数 (CDF) 是一个从单位圆盘中均匀选取的点位于半径为 $\\sqrt{s}$ 的圆盘内的概率：\n$$\nF_S(s) = P(S \\le s | S  1) = \\frac{\\text{半径为 } \\sqrt{s} \\text{ 的圆盘面积}}{\\text{半径为 } 1 \\text{ 的圆盘面积}} = \\frac{\\pi (\\sqrt{s})^2}{\\pi (1)^2} = s\n$$\nPDF 是 CDF 的导数，$f_S(s) = \\frac{d}{ds}s = 1$ (对于 $s \\in (0,1)$)。因此，在接受条件下，$S$ 在 $(0,1)$ 上均匀分布。\n\n现在我们可以将期望计算为一个积分：\n$$\n\\mathbb{E}\\!\\left[\\left(Z_1^{(\\epsilon)}\\right)^2\\right] = \\int_0^1 \\left(-s \\frac{\\ln(\\max(s,\\epsilon))}{\\max(s,\\epsilon)}\\right) \\cdot f_S(s) \\, ds = \\int_0^1 -s \\frac{\\ln(\\max(s,\\epsilon))}{\\max(s,\\epsilon)} \\, ds\n$$\n由于被积函数的形式在 $s=\\epsilon$ 处发生变化，我们将积分在这一点拆分：\n$$\n\\mathbb{E}\\!\\left[\\left(Z_1^{(\\epsilon)}\\right)^2\\right] = \\int_0^\\epsilon \\left(-s \\frac{\\ln \\epsilon}{\\epsilon}\\right) ds + \\int_\\epsilon^1 \\left(-s \\frac{\\ln s}{s}\\right) ds\n$$\n我们分别计算每个积分。对于第一个积分：\n$$\n\\int_0^\\epsilon \\left(-\\frac{s \\ln \\epsilon}{\\epsilon}\\right) ds = -\\frac{\\ln \\epsilon}{\\epsilon} \\int_0^\\epsilon s \\, ds = -\\frac{\\ln \\epsilon}{\\epsilon} \\left[ \\frac{s^2}{2} \\right]_0^\\epsilon = -\\frac{\\ln \\epsilon}{\\epsilon} \\frac{\\epsilon^2}{2} = -\\frac{\\epsilon \\ln \\epsilon}{2}\n$$\n对于第二个积分：\n$$\n\\int_\\epsilon^1 (-\\ln s) \\, ds\n$$\n使用分部积分法，令 $u = -\\ln s$ 且 $dv = ds$，我们得到 $du = -\\frac{1}{s} \\, ds$ 且 $v=s$。\n$$\n\\int (-\\ln s) \\, ds = s(-\\ln s) - \\int s\\left(-\\frac{1}{s}\\right)ds = -s\\ln s + \\int 1 \\, ds = -s\\ln s + s + C\n$$\n计算该定积分：\n$$\n[-s\\ln s + s]_\\epsilon^1 = (-1\\ln 1 + 1) - (-\\epsilon\\ln\\epsilon + \\epsilon) = (0 + 1) - (-\\epsilon\\ln\\epsilon + \\epsilon) = 1 + \\epsilon\\ln\\epsilon - \\epsilon\n$$\n将两个积分的结果合并，得到期望平方值：\n$$\n\\mathbb{E}\\!\\left[\\left(Z_1^{(\\epsilon)}\\right)^2\\right] = \\left(-\\frac{\\epsilon \\ln \\epsilon}{2}\\right) + (1 + \\epsilon\\ln\\epsilon - \\epsilon) = 1 + \\frac{\\epsilon \\ln \\epsilon}{2} - \\epsilon\n$$\n最后，通过减去真实方差 $1$ 来计算偏差：\n$$\n\\mathrm{Bias}(\\epsilon) = \\mathbb{E}\\!\\left[\\left(Z_1^{(\\epsilon)}\\right)^2\\right] - 1 = \\left(1 + \\frac{\\epsilon \\ln \\epsilon}{2} - \\epsilon\\right) - 1 = \\frac{\\epsilon \\ln \\epsilon}{2} - \\epsilon\n$$\n按照要求，我们分析当 $\\epsilon \\to 0^+$ 时的渐近率。极限 $\\lim_{\\epsilon \\to 0^+} \\frac{\\epsilon}{\\epsilon \\ln \\epsilon} = \\lim_{\\epsilon \\to 0^+} \\frac{1}{\\ln \\epsilon} = 0$ 表明，项 $-\\epsilon$ 是比 $\\frac{1}{2}\\epsilon\\ln\\epsilon$ 更高阶的无穷小。因此，偏差的主项是 $\\frac{1}{2}\\epsilon\\ln\\epsilon$，次高阶项是 $-\\epsilon$。", "answer": "$$\n\\boxed{\\frac{\\epsilon \\ln \\epsilon}{2} - \\epsilon}\n$$", "id": "3324458"}, {"introduction": "随机模拟的质量在很大程度上取决于其最基础的构件——均匀随机数生成器。这个高级练习将引导你探讨“垃圾进，垃圾出”的原则，即有缺陷的输入如何污染 Marsaglia 极坐标法的输出 [@problem_id:3324468]。通过设计并实施一套诊断测试，你将学会检测底层均匀随机数生成器的缺陷如何传播并导致最终生成的正态变量出现非预期的相关性。", "problem": "您的任务是研究依赖性如何从一个均匀随机输入序列通过用于生成正态变量的 Marsaglia 极坐标法进行传播，并设计和实现能够检测由此产生的正态数对输出中的诱导相关性的诊断工具。实现必须是一个完整的、可运行的程序，并产生单行输出。\n\n请从以下基础理论开始：\n\n- 一对独立同分布 (i.i.d.) 的标准正态随机变量 $(Z_1,Z_2)$ 的联合概率密度函数 (PDF) 为 $f(z_1,z_2) = \\frac{1}{2\\pi}\\exp\\!\\left(-\\frac{z_1^2+z_2^2}{2}\\right)$，其半径的平方 $R^2 = Z_1^2 + Z_2^2$ 服从自由度为 $2$ 的卡方分布，这等价于均值为 $2$ 的指数分布。在极坐标中，角度 $\\Theta = \\operatorname{atan2}(Z_2,Z_1)$ 在 $[-\\pi,\\pi)$ 上均匀分布，且与 $R$ 独立。\n- Marsaglia 极坐标法是一种接受-拒绝法，它将一对在 $[-1,1]$ 上独立的均匀变量转换为一对标准正态变量。该方法首先从单位圆盘内均匀地接受点，然后应用适当的径向缩放，使得最终的分布与 $(Z_1,Z_2)$ 的分布相匹配。您必须实现标准的接受-拒绝映射，以产生正确的正态分布律，但除了输入序列所蕴含的独立性外，您不能假设任何额外的虚假独立性。\n- 线性同余生成器 (LCG) 由递推关系 $X_{n+1} = (a X_n + c) \\bmod m$ 定义，其中包含整数模数 $m$、乘数 $a$、增量 $c$ 和种子 $X_0$。生成的均匀数是 $U_n = X_n / m \\in [0,1)$。\n- 随机变量中的依赖性在可测映射下得以保持：如果 $(U_1,U_2,U_3,\\dots)$ 是一个依赖序列，而 $T$ 是一个确定性变换，那么 $(T(U_1,U_2),T(U_3,U_4),\\dots)$ 通常仍然是依赖的。基于输入函数的接受-拒绝法也可能与输入依赖性相互作用，可能产生复杂的选择偏差。\n\n需要完成的任务：\n\n1. 实现 Marsaglia 极坐标法，该方法使用一个在 $[-1,1]^2$ 上均匀分布的数对流 $(V_1,V_2)$，拒绝任何满足 $S = V_1^2 + V_2^2 \\ge 1$ 或 $S=0$ 的数对，并使用确定性缩放将接受的数对转换为标准正态数对 $(Z_1,Z_2)$，以产生正确的 $(Z_1,Z_2)$ 分布律。您的实现除非得到输入生成器的保证，否则不得假设独立性。\n2. 实现具有以下配置的均匀序列源：\n   - 使用现代数值库提供的置换同余生成器 (PCG) 作为独立基线。由此生成在 $[0,1)$ 上的独立同分布均匀变量，并形成独立的数对。\n   - 使用参数 $m=2^{31}$、$a=65539$、$c=0$（通常称为 RANDU）的一个劣质线性同余生成器 (LCG) 来生成单个均匀流 $U_n$，并形成连续数对 $(U_{2k},U_{2k+1})$。\n   - 一种退化配对，通过为每个候选数对设置 $U_{2k+1}=U_{2k}$ 来强制实现数对内的完全相关，其中 $U_{2k}$ 使用相同的底层 LCG 流。\n3. 提出并实现诊断工具，以检测由 Marsaglia 极坐标法产生的 $(Z_1,Z_2)$ 中的诱导相关性或结构性偏差：\n   - 组内 Pearson 相关系数 $\\hat\\rho = \\operatorname{Corr}(Z_1,Z_2)$。\n   - 角度均匀性检验：计算 $\\Theta = \\operatorname{atan2}(Z_2,Z_1) \\in (-\\pi,\\pi]$，将其重新缩放为 $W = (\\Theta + \\pi)/(2\\pi) \\in [0,1)$，并对 $[0,1)$ 上的均匀分布执行单样本 Kolmogorov–Smirnov (K-S) 检验；报告 $p$-值。\n   - 扁平化输出序列 $Y = (Z_1^{(1)}, Z_2^{(1)}, Z_1^{(2)}, Z_2^{(2)}, \\dots)$ 的滞后-1 自相关，定义为 $\\hat\\rho_1 = \\frac{\\sum_{t=1}^{N-1} (Y_t - \\bar Y)(Y_{t+1}-\\bar Y)}{\\sum_{t=1}^{N} (Y_t - \\bar Y)^2}$，其中 $N$ 是 $Y$ 的总长度。\n   - 使用 $b \\times b$ 网格（其中 $b=6$）进行独立性卡方检验，该网格基于标准正态边缘分布的分位数分箱：在一个由概率为 $i/b$（其中 $i=0,1,\\dots,b$）的标准正态分位数定义的网格上计算单元格计数，并计算卡方统计量 $\\sum_{i,j} \\frac{(O_{ij}-E_{ij})^2}{E_{ij}}$，其自由度为 $(b-1)(b-1)$，其中 $E_{ij}$ 是根据边缘分布计算出的独立性假设下的期望计数；报告 $p$-值。\n4. 为保证可复现性，请使用以下测试套件。每个用例指定了生成器配置、种子和要生成的输出数对的数量：\n   - 用例 A（独立基线）：PCG 种子 $= 20231011$，输出数对数量 $= 40000$。\n   - 用例 B（LCG RANDU 顺序数对）：参数 $m=2^{31}$、$a=65539$、$c=0$，种子 $=1$，输出数对数量 $= 40000$。\n   - 用例 C（退化等值对映射）：与用例 B 相同的 RANDU 参数，但在候选数对中强制 $U_{2k+1}=U_{2k}$，种子 $=1$，输出数对数量 $= 40000$。\n   - 用例 D（小样本独立性健全性检查）：PCG 种子 $= 42$，输出数对数量 $= 500$。\n5. 输出格式：您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果。每个测试用例的结果本身也必须是一个列表，顺序为 $[\\hat\\rho, p_{\\text{angle}}, \\hat\\rho_1, p_{\\chi^2}]$，因此最终输出是按 A、B、C、D 用例顺序排列的四个列表的列表，例如 $[[r_{A},p_{A},a_{A},q_{A}],[r_{B},p_{B},a_{B},q_{B}],[r_{C},p_{C},a_{C},q_{C}],[r_{D},p_{D},a_{D},q_{D}]]$.", "solution": "该问题要求研究输入序列的依赖性对用于生成标准正态随机变量的 Marsaglia 极坐标法输出的影响。为实现此目的，需要实现该方法，从不同质量的随机数生成器获取输入，并对输出应用一套统计诊断工具。\n\n该问题在科学和数学上是适定的。它基于随机数生成和统计检验的既定理论。所有参数、算法和测试用例都得到了明确无误的指定，从而可以得到一个唯一且可验证的解决方案。所选择的测试用例——一个高质量生成器、一个臭名昭著的劣质生成器和一个病态依赖的生成器——为展示缺陷如何通过非线性变换进行传播提供了一个稳健的框架。\n\n**1. Marsaglia 极坐标法的基础理论**\n\nMarsaglia 极坐标法通过变换一对从单位圆盘内部均匀选取的随机变量 $(V_1, V_2)$ 来生成一对独立标准正态随机变量 $(Z_1, Z_2)$。一对独立同分布标准正态变量的联合概率密度函数 (PDF) 在笛卡尔坐标下由 $f(z_1, z_2) = \\frac{1}{2\\pi} e^{-(z_1^2 + z_2^2)/2}$ 给出。在极坐标中，其中 $z_1 = r \\cos\\theta$ 且 $z_2 = r \\sin\\theta$，半径的平方 $R^2 = Z_1^2 + Z_2^2$ 服从均值为 $2$ 的指数分布（即自由度为 $2$ 的卡方分布），而角度 $\\Theta = \\operatorname{atan2}(Z_2, Z_1)$ 在 $[-\\pi, \\pi)$ 上均匀分布，并与 $R$ 独立。\n\n该方法按以下步骤进行：\n1.  生成一对在 $[0,1)$ 上独立的均匀变量 $(U_1, U_2)$。\n2.  将它们变换到在 $[-1,1]$ 上均匀分布：$V_1 = 2U_1 - 1$ 和 $V_2 = 2U_2 - 1$。数对 $(V_1, V_2)$ 在正方形 $[-1,1]^2$ 上均匀分布。\n3.  计算 $S = V_1^2 + V_2^2$。\n4.  如果 $S=0$ 或 $S \\ge 1$，则拒绝该数对并返回步骤 1。否则，接受。被接受的数对 $(V_1, V_2)$ 在单位圆盘内部均匀分布。\n5.  如果我们将接受的点写成极坐标形式，$V_1 = \\tilde{R} \\cos\\Phi$ 和 $V_2 = \\tilde{R} \\sin\\Phi$，那么角度 $\\Phi$ 在 $[0, 2\\pi)$ 上均匀分布，而半径的平方 $S = \\tilde{R}^2$ 在 $(0,1)$ 上均匀分布。该方法的核心是将这个平方半径 $S$ 变换为一个具有正确指数分布的新平方半径 $R^2$。所需的变换是 $R^2 = -2 \\ln S$。由于 $S \\sim U(0,1)$，对于 $y>0$，$Y = -2 \\ln S$ 的累积分布函数 (CDF) 是 $P(Y \\le y) = P(-2 \\ln S \\le y) = P(\\ln S \\ge -y/2) = P(S \\ge e^{-y/2}) = 1 - e^{-y/2}$。这是均值为 $2$ 的指数分布的 CDF。\n6.  最终的标准正态变量是通过将原始坐标 $(V_1, V_2)$ 乘以一个缩放因子来构造的，该因子用新生成的半径替换了它们的原始半径。新半径为 $R = \\sqrt{-2\\ln S}$。原始半径为 $\\tilde{R} = \\sqrt{S}$。缩放因子是 $R/\\tilde{R} = \\sqrt{-2\\ln S / S}$。\n    $$ Z_1 = V_1 \\cdot \\sqrt{\\frac{-2 \\ln S}{S}} $$\n    $$ Z_2 = V_2 \\cdot \\sqrt{\\frac{-2 \\ln S}{S}} $$\n    生成的数对 $(Z_1, Z_2)$ 的角度与 $(V_1, V_2)$ 的角度相同，后者是均匀分布的。因此，只要输入均匀变量 $(U_1, U_2)$ 是独立同分布的，$(Z_1,Z_2)$ 就是一对独立同分布的标准正态变量。\n\n**2. 输入序列生成器**\n\n该问题指定了三个用于初始均匀序列的源，它们被设计为具有不同的依赖结构。\n\n-   **独立基线 (PCG):** 使用一个现代的、高质量的置换同余生成器 (PCG)。它以其出色的统计特性而闻名，其产生的变量流 $(U_0, U_1, U_2, \\dots)$ 在所有实际应用中都可以被视为在 $[0,1)$ 上独立同分布的均匀变量。数对形成为 $(U_{2k}, U_{2k+1})$。\n-   **劣质 LCG (RANDU):** 一个由递推关系 $X_{n+1} = (a X_n + c) \\pmod m$ 定义的线性同余生成器，参数为 $a=65539$，$c=0$，$m=2^{31}$。均匀数为 $U_n = X_n / m$。该生成器因其连续值之间的强相关性而臭名昭著。例如，其三元组 $(U_i, U_{i+1}, U_{i+2})$ 落在少数几个平面上。我们将其形成为数对 $(U_{2k}, U_{2k+1})$，这将继承这种依赖性。\n-   **退化配对:** 这使用相同的 RANDU 生成器，但通过设置 $U_{2k+1} = U_{2k}$ 来强制在候选数对内实现完全相关。因此，输入到 Marsaglia 方法的是形如 $(v,v)$ 的数对，其中 $v = 2U_{2k}-1$。\n\n**3. 统计诊断**\n\n为了量化输出的正态数对 $(Z_1^{(i)}, Z_2^{(i)})$ 的质量，实现了四种诊断检验。\n\n-   **组内 Pearson 相关系数 ($\\hat\\rho$):** 这衡量了每个生成的数对内 $Z_1$ 和 $Z_2$ 之间的线性相关性。对于真正独立的标准正态变量，理论相关性为 $0$。\n-   **角度均匀性 (K-S 检验):** 角度 $\\Theta_i = \\operatorname{atan2}(Z_2^{(i)}, Z_1^{(i)})$ 应在 $(-\\pi, \\pi]$ 上均匀分布。我们将角度重新缩放为 $W_i = (\\Theta_i + \\pi) / (2\\pi)$，使其位于 $[0,1)$ 上，并针对标准均匀分布执行单样本 Kolmogorov-Smirnov (K-S) 检验。所得的 $p$-值表明，如果底层分布是均匀的，观察到给定样本的可能性；一个小的 $p$-值表明非均匀性。\n-   **滞后-1 自相关 ($\\hat\\rho_1$):** 这检验了扁平化输出序列 $Y = (Z_1^{(1)}, Z_2^{(1)}, Z_1^{(2)}, Z_2^{(2)}, \\dots)$ 中连续值之间的相关性。它对组内相关（例如 $Z_1^{(1)}$ 和 $Z_2^{(1)}$ 之间）和组间相关（例如 $Z_2^{(1)}$ 和 $Z_1^{(2)}$ 之间）都很敏感。该统计量计算为 $\\hat\\rho_1 = \\frac{\\sum_{t=1}^{N-1} (Y_t - \\bar Y)(Y_{t+1}-\\bar Y)}{\\sum_{t=1}^{N} (Y_t - \\bar Y)^2}$，其中 $N$ 是 $Y$ 的总长度。\n-   **独立性卡方检验 ($p_{\\chi^2}$):** 这是一个用于检验 $Z_1$ 和 $Z_2$ 之间独立性的非参数检验。联合样本空间被划分为一个 $b \\times b$ 的网格，其中 $b=6$。分箱边界由标准正态分布的分位数定义，使得每个边缘分箱的期望概率为 $1/b$。卡方统计量 $\\chi^2 = \\sum_{i,j} \\frac{(O_{ij}-E_{ij})^2}{E_{ij}}$ 比较了每个单元格 $(i,j)$ 中的观测计数 $O_{ij}$ 与在独立性零假设下的期望计数 $E_{ij}$。一个大的 $\\chi^2$ 值（以及相应的小 $p$-值）表明与独立性存在显著偏差。自由度为 $(b-1)^2 = 25$。\n\n**4. 测试用例分析**\n\n-   **用例 A (PCG, $N=40000$):** 作为基线，预计所有测试都将通过。$\\hat\\rho$ 和 $\\hat\\rho_1$ 应接近 $0$，K-S 检验和 $\\chi^2$ 检验的 $p$-值应较高（例如 $ 0.05$），表明与独立同分布正态变量的理想属性没有统计学上的显著偏差。\n-   **用例 B (RANDU, $N=40000$):** 预计 RANDU 的已知缺陷会传播。非线性的接受-拒绝步骤和变换可能会掩盖或放大这些缺陷。我们预计至少有一种诊断方法会检测到统计学上显著的异常，可能是非零的 $\\hat\\rho_1$ 和 $\\chi^2$ 检验的低 $p$-值。\n-   **用例 C (退化, $N=40000$):** 此用例作为一个阳性对照。由于 $V_1=V_2$，因此 $Z_1=Z_2$。因此，我们预计 $\\hat\\rho$ 将恰好为 $1$。角度将聚集在 $\\pi/4$ 和 $-3\\pi/4$ 处，导致 K-S 检验的 $p$-值极小。$\\chi^2$ 检验将显示所有数据都在对角线上，导致 $p$-值实际上为 $0$。滞后-1 自相关 $\\hat\\rho_1$ 也将是大的正值。\n-   **用例 D (PCG, $N=500$):** 这是一个使用较小样本量的健全性检查。我们预计结果与用例 A 相似，但统计方差更大。例如，估计的相关性可能离 $0$ 更远，而 $p$-值可能仅仅因为抽样变异性而较低，但通常不应表明对零假设的强烈拒绝。\n\n实现将遵循这些原则，为每个用例生成随机变量并计算指定的四种诊断统计数据。", "answer": "```python\nimport numpy as np\nfrom scipy import stats\n\ndef solve():\n    \"\"\"\n    Main function to run the simulation and diagnostics for all test cases.\n    \"\"\"\n\n    def lcg_randu_stream(seed):\n        \"\"\"Generator for the RANDU LCG.\"\"\"\n        m = 2**31\n        a = 65539\n        c = 0\n        x = seed\n        while True:\n            x = (a * x + c) % m\n            yield x / m\n\n    def pcg_stream(seed):\n        \"\"\"Generator for a PCG-based uniform stream.\"\"\"\n        rng = np.random.default_rng(seed)\n        while True:\n            yield rng.random()\n\n    def v_pairs_stream(u_stream_gen, seed, degenerate=False):\n        \"\"\"\n        Generator for V pairs on [-1,1]^2 from a uniform stream.\n        - `u_stream_gen`: A function that creates a uniform stream generator (e.g., lcg_randu_stream).\n        - `seed`: The seed for the uniform stream.\n        - `degenerate`: If True, sets V2 = V1.\n        \"\"\"\n        u_stream = u_stream_gen(seed)\n        while True:\n            u1 = next(u_stream)\n            if degenerate:\n                u2 = u1\n            else:\n                u2 = next(u_stream)\n            v1 = 2 * u1 - 1\n            v2 = 2 * u2 - 1\n            yield v1, v2\n\n    def generate_z_pairs(v_stream_producer, num_pairs):\n        \"\"\"\n        Generates N pairs of standard normal variates using the Marsaglia polar method.\n        - `v_stream_producer`: A function that returns a generator of (v1, v2) pairs.\n        \"\"\"\n        z_pairs = []\n        v_stream = v_stream_producer()\n        num_generated = 0\n        while num_generated  num_pairs:\n            v1, v2 = next(v_stream)\n            s = v1**2 + v2**2\n            if 0  s  1:\n                scale = np.sqrt(-2 * np.log(s) / s)\n                z1 = v1 * scale\n                z2 = v2 * scale\n                z_pairs.append([z1, z2])\n                num_generated += 1\n        return np.array(z_pairs)\n\n    def calculate_diagnostics(z_pairs):\n        \"\"\"Calculates the four diagnostic metrics for a set of Z pairs.\"\"\"\n        num_pairs = z_pairs.shape[0]\n        if num_pairs  2:\n            return [np.nan, np.nan, np.nan, np.nan]\n\n        z1 = z_pairs[:, 0]\n        z2 = z_pairs[:, 1]\n\n        # 1. Within-pair Pearson correlation\n        # Using np.corrcoef, check for constant input to avoid warnings.\n        if np.all(z1 == z1[0]) or np.all(z2 == z2[0]):\n             rho_corr = 1.0 if np.all(z1==z2) else np.nan\n        else:\n             rho_corr = np.corrcoef(z1, z2)[0, 1]\n\n        # 2. Angular uniformity K-S test\n        angles = np.arctan2(z2, z1)\n        angles_rescaled = (angles + np.pi) / (2 * np.pi)\n        # scipy.stats.kstest requires at least 2 data points\n        if angles_rescaled.size > 1:\n            ks_stat, p_ks = stats.kstest(angles_rescaled, 'uniform')\n        else:\n            p_ks = np.nan\n\n        # 3. Lag-1 autocorrelation of flattened sequence\n        y = z_pairs.flatten()\n        n_y = len(y)\n        if n_y > 1:\n            y_bar = np.mean(y)\n            num = np.sum((y[:-1] - y_bar) * (y[1:] - y_bar))\n            den = np.sum((y - y_bar)**2)\n            rho_lag1 = num / den if den != 0 else np.nan\n        else:\n            rho_lag1 = np.nan\n\n        # 4. Chi-square test for independence\n        b = 6\n        if num_pairs >= b*b: # Ensure enough data for a meaningful test\n            # Define bins using quantiles of standard normal distribution\n            q = np.arange(1, b) / b\n            bin_edges = stats.norm.ppf(q)\n            bins = [-np.inf] + bin_edges.tolist() + [np.inf]\n            \n            observed_counts, _, _ = np.histogram2d(z1, z2, bins=(bins, bins))\n            \n            # chi2_contingency can fail if all data lies in a way that gives 0 marginals\n            if np.sum(observed_counts) > 0 and np.all(observed_counts.sum(axis=0) > 0) and np.all(observed_counts.sum(axis=1) > 0):\n                chi2_stat, p_chi2, dof, expected = stats.chi2_contingency(observed_counts, correction=False)\n            else:\n                 p_chi2 = 0.0 # Extreme case, e.g., all on diagonal\n        else:\n            p_chi2 = np.nan\n\n        return [rho_corr, p_ks, rho_lag1, p_chi2]\n\n    test_cases = [\n        {'name': 'A', 'gen': pcg_stream, 'seed': 20231011, 'pairs': 40000, 'degen': False},\n        {'name': 'B', 'gen': lcg_randu_stream, 'seed': 1, 'pairs': 40000, 'degen': False},\n        {'name': 'C', 'gen': lcg_randu_stream, 'seed': 1, 'pairs': 40000, 'degen': True},\n        {'name': 'D', 'gen': pcg_stream, 'seed': 42, 'pairs': 500, 'degen': False}\n    ]\n\n    results = []\n    for case in test_cases:\n        v_stream_producer = lambda: v_pairs_stream(case['gen'], case['seed'], degenerate=case['degen'])\n        z_pairs = generate_z_pairs(v_stream_producer, case['pairs'])\n        diag_results = calculate_diagnostics(z_pairs)\n        results.append(diag_results)\n\n    # Format the final output string as a list of lists.\n    # The `str` representation of a Python list is the desired format \"[...]\".\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3324468"}]}