{"hands_on_practices": [{"introduction": "定量校正是光谱化学计量学中的一项基本任务。虽然经典最小二乘法广为人知，但贝叶斯方法通过对参数和预测进行完全的概率量化，为我们提供了更丰富的不确定性理解。本练习 [@problem_id:3711449] 将指导您推导并应用一个完整的贝叶斯线性回归模型，这是构建现代概率化学计量学模型的基石。", "problem": "一个有机混合物中含有一种目标分析物，其浓度 $c$ 需要通过近红外（NIR）吸光度特征进行校准。在感兴趣的小浓度范围内，根据比尔-朗伯定律和仪器线性，浓度与光谱特征之间存在近似线性的关系，并伴有加性噪声。考虑一个贝叶斯线性校准模型，其中样本 $i$ 的浓度 $c$ 被建模为 $c_{i} = \\mathbf{x}_{i}^{\\top}\\mathbf{w} + \\varepsilon_{i}$，这里 $\\mathbf{x}_{i} \\in \\mathbb{R}^{p}$ 是在选定波长下的吸光度特征向量，$\\mathbf{w} \\in \\mathbb{R}^{p}$ 是回归系数，噪声 $\\varepsilon_{i}$ 是独立同分布的零均值高斯噪声，其方差为 $\\sigma^{2}$。假设一个共轭正态-逆伽马先验：$\\mathbf{w} \\mid \\sigma^{2} \\sim \\mathcal{N}(\\mathbf{m}_{0}, \\sigma^{2}\\mathbf{V}_{0})$ 且 $\\sigma^{2} \\sim \\mathrm{InvGamma}(a_{0}, b_{0})$，其中逆伽马密度正比于 $(\\sigma^{2})^{-a_{0}-1}\\exp(-b_{0}/\\sigma^{2})$。\n\n从给定 $(\\mathbf{w},\\sigma^{2})$ 时 $\\mathbf{y} = (c_{1},\\dots,c_{n})^{\\top}$ 的高斯似然和上述指定的正态-逆伽马先验出发，推导在给定校准数据集 $(\\mathbf{X},\\mathbf{y})$（其中 $\\mathbf{X} \\in \\mathbb{R}^{n \\times p}$）下 $(\\mathbf{w},\\sigma^{2})$ 的后验分布，然后推导新光谱 $\\mathbf{x}_{\\ast} \\in \\mathbb{R}^{p}$ 浓度 $c_{\\ast}$ 的闭式后验预测分布。\n\n您将获得一个真实的校准数据集，其中浓度通过参考方法高效液相色谱法获得，光谱通过近红外光谱法获得：\n- 特征维度 $p = 2$，特征为两个波长处的吸光度。\n- 校准样本数 $n = 3$。\n- 设计矩阵 $\\mathbf{X}$ 的行为 $\\mathbf{x}_{1}^{\\top} = (1.0, 0.5)$，$\\mathbf{x}_{2}^{\\top} = (1.5, 1.0)$，$\\mathbf{x}_{3}^{\\top} = (0.5, 0.2)$。\n- 参考浓度（单位 $\\mathrm{mmol}\\,\\mathrm{L}^{-1}$）为 $\\mathbf{y}^{\\top} = (2.0, 3.0, 1.2)$。\n- 先验参数为 $\\mathbf{m}_{0} = (0, 0)^{\\top}$，$\\mathbf{V}_{0} = \\mathbf{I}_{2}$，$a_{0} = 2$，$b_{0} = 1$。\n\n使用您推导的公式，计算新光谱 $\\mathbf{x}_{\\ast}^{\\top} = (1.2, 0.8)$ 的后验预测平均浓度。将您的答案四舍五入到四位有效数字。最终浓度以 $\\mathrm{mmol}\\,\\mathrm{L}^{-1}$ 为单位表示。", "solution": "### 步骤 1：提取已知条件\n-   模型：浓度 $c_i$ 被建模为光谱特征 $\\mathbf{x}_i \\in \\mathbb{R}^p$ 的线性函数，并带有加性高斯噪声：$c_{i} = \\mathbf{x}_{i}^{\\top}\\mathbf{w} + \\varepsilon_{i}$。\n-   噪声分布：$\\varepsilon_{i} \\sim \\mathcal{N}(0, \\sigma^{2})$，独立同分布。\n-   数据：一组 $n$ 个观测值 $(\\mathbf{X}, \\mathbf{y})$，其中 $\\mathbf{X} = (\\mathbf{x}_1, \\dots, \\mathbf{x}_n)^{\\top} \\in \\mathbb{R}^{n \\times p}$ 是设计矩阵，$\\mathbf{y} = (c_1, \\dots, c_n)^{\\top}$ 是浓度向量。\n-   参数 $(\\mathbf{w}, \\sigma^2)$ 的先验分布：一个正态-逆伽马共轭先验，具体如下：\n    -   $p(\\mathbf{w} \\mid \\sigma^{2}) = \\mathcal{N}(\\mathbf{m}_{0}, \\sigma^{2}\\mathbf{V}_{0})$\n    -   $p(\\sigma^{2}) = \\mathrm{InvGamma}(a_{0}, b_{0})$，其概率密度函数为 $p(\\sigma^2) \\propto (\\sigma^{2})^{-a_{0}-1}\\exp(-b_{0}/\\sigma^{2})$。\n-   新样本：一个新光谱 $\\mathbf{x}_{\\ast} \\in \\mathbb{R}^{p}$，其浓度 $c_{\\ast}$ 待预测。\n-   校准数据集和先验的数值：\n    -   特征维度：$p = 2$。\n    -   样本数：$n = 3$。\n    -   设计矩阵：$\\mathbf{X} = \\begin{pmatrix} 1.0  0.5 \\\\ 1.5  1.0 \\\\ 0.5  0.2 \\end{pmatrix}$。\n    -   浓度向量：$\\mathbf{y} = \\begin{pmatrix} 2.0 \\\\ 3.0 \\\\ 1.2 \\end{pmatrix}$。\n    -   权重先验均值：$\\mathbf{m}_{0} = \\begin{pmatrix} 0 \\\\ 0 \\end{pmatrix}$。\n    -   权重先验协方差矩阵因子：$\\mathbf{V}_{0} = \\mathbf{I}_{2} = \\begin{pmatrix} 1  0 \\\\ 0  1 \\end{pmatrix}$。\n    -   逆方差的先验形状参数：$a_{0} = 2$。\n    -   逆方差的先验尺度参数：$b_{0} = 1$。\n-   测试样本的数值：\n    -   新特征向量：$\\mathbf{x}_{\\ast} = \\begin{pmatrix} 1.2 \\\\ 0.8 \\end{pmatrix}$。\n\n### 步骤 2：使用提取的已知条件进行验证\n-   **科学依据**：该问题使用了贝叶斯线性回归，这是机器学习和化学计量学中一种标准且成熟的方法。基于比尔-朗伯定律，在小浓度范围内假设线性关系是光谱校准中一种常见且有效的简化。选择正态-逆伽马先验是典型的做法，因为它是具有未知均值和方差的高斯噪声线性模型的共轭先验。该问题在科学和数学上是合理的。\n-   **适定性**：该问题是完全指定的。所有必要的数据、模型形式和先验参数都已提供。目标是推导标准的理论结果，并将其应用于一个具体的数值例子。数据点数（$n=3$）大于特征数（$p=2$），且矩阵 $\\mathbf{X}^{\\top}\\mathbf{X}$ 是可逆的，这确保了后验均值存在唯一解。该问题是适定的。\n-   **客观性**：该问题以精确的数学和统计语言陈述，没有任何主观或模棱两可的术语。\n\n### 步骤 3：结论与行动\n问题有效。我将继续进行推导和计算。\n\n### 后验分布的推导\n参数 $(\\mathbf{w}, \\sigma^2)$ 的后验分布通过应用贝叶斯定理得到：\n$$p(\\mathbf{w}, \\sigma^2 \\mid \\mathbf{y}, \\mathbf{X}) \\propto p(\\mathbf{y} \\mid \\mathbf{X}, \\mathbf{w}, \\sigma^2) p(\\mathbf{w}, \\sigma^2)$$\n对于 $\\mathbf{y} = \\mathbf{X}\\mathbf{w} + \\boldsymbol{\\varepsilon}$，其中 $\\boldsymbol{\\varepsilon} \\sim \\mathcal{N}(\\mathbf{0}, \\sigma^2\\mathbf{I}_n)$，似然函数为：\n$$p(\\mathbf{y} \\mid \\mathbf{X}, \\mathbf{w}, \\sigma^2) = (2\\pi\\sigma^2)^{-n/2} \\exp\\left(-\\frac{1}{2\\sigma^2}(\\mathbf{y} - \\mathbf{X}\\mathbf{w})^{\\top}(\\mathbf{y} - \\mathbf{X}\\mathbf{w})\\right)$$\n先验为 $p(\\mathbf{w}, \\sigma^2) = p(\\mathbf{w} \\mid \\sigma^2)p(\\sigma^2)$：\n$$p(\\mathbf{w}, \\sigma^2) \\propto (\\sigma^2)^{-p/2} \\exp\\left(-\\frac{1}{2\\sigma^2}(\\mathbf{w} - \\mathbf{m}_0)^{\\top}\\mathbf{V}_0^{-1}(\\mathbf{w} - \\mathbf{m}_0)\\right) \\cdot (\\sigma^2)^{-a_0-1} \\exp\\left(-\\frac{b_0}{\\sigma^2}\\right)$$\n结合这些，后验分布正比于：\n$$p(\\mathbf{w}, \\sigma^2 \\mid \\mathbf{y}, \\mathbf{X}) \\propto (\\sigma^2)^{-(a_0 + n/2 + p/2) - 1} \\exp\\left(-\\frac{1}{\\sigma^2}\\left[b_0 + \\frac{1}{2}(\\mathbf{y} - \\mathbf{X}\\mathbf{w})^{\\top}(\\mathbf{y} - \\mathbf{X}\\mathbf{w}) + \\frac{1}{2}(\\mathbf{w} - \\mathbf{m}_0)^{\\top}\\mathbf{V}_0^{-1}(\\mathbf{w} - \\mathbf{m}_0)\\right]\\right)$$\n指数中的表达式是关于 $\\mathbf{w}$ 的二次型。我们对 $\\mathbf{w}$ 进行配方：\n$$(\\mathbf{y} - \\mathbf{X}\\mathbf{w})^{\\top}(\\mathbf{y} - \\mathbf{X}\\mathbf{w}) + (\\mathbf{w} - \\mathbf{m}_0)^{\\top}\\mathbf{V}_0^{-1}(\\mathbf{w} - \\mathbf{m}_0) = \\mathbf{w}^{\\top}(\\mathbf{X}^{\\top}\\mathbf{X} + \\mathbf{V}_0^{-1})\\mathbf{w} - 2(\\mathbf{y}^{\\top}\\mathbf{X} + \\mathbf{m}_0^{\\top}\\mathbf{V}_0^{-1})\\mathbf{w} + \\mathbf{y}^{\\top}\\mathbf{y} + \\mathbf{m}_0^{\\top}\\mathbf{V}_0^{-1}\\mathbf{m}_0$$\n这个表达式可以重写为后验参数 $(\\mathbf{m}_n, \\mathbf{V}_n)$ 的形式：\n令 $\\mathbf{V}_n^{-1} = \\mathbf{V}_0^{-1} + \\mathbf{X}^{\\top}\\mathbf{X}$ 且 $\\mathbf{m}_n = \\mathbf{V}_n(\\mathbf{V}_0^{-1}\\mathbf{m}_0 + \\mathbf{X}^{\\top}\\mathbf{y})$。\n二次项变为 $(\\mathbf{w} - \\mathbf{m}_n)^{\\top}\\mathbf{V}_n^{-1}(\\mathbf{w} - \\mathbf{m}_n) + \\mathbf{y}^{\\top}\\mathbf{y} + \\mathbf{m}_0^{\\top}\\mathbf{V}_0^{-1}\\mathbf{m}_0 - \\mathbf{m}_n^{\\top}\\mathbf{V}_n^{-1}\\mathbf{m}_n$。\n将此代回，后验分布变为：\n$$p(\\mathbf{w}, \\sigma^2 \\mid \\mathbf{y}, \\mathbf{X}) \\propto (\\sigma^2)^{-p/2}\\exp\\left(-\\frac{1}{2\\sigma^2}(\\mathbf{w} - \\mathbf{m}_n)^{\\top}\\mathbf{V}_n^{-1}(\\mathbf{w} - \\mathbf{m}_n)\\right) \\cdot (\\sigma^2)^{-(a_n)-1}\\exp\\left(-\\frac{b_n}{\\sigma^2}\\right)$$\n其中后验参数为：\n$$a_n = a_0 + \\frac{n}{2}$$\n$$b_n = b_0 + \\frac{1}{2}\\left(\\mathbf{y}^{\\top}\\mathbf{y} + \\mathbf{m}_0^{\\top}\\mathbf{V}_0^{-1}\\mathbf{m}_0 - \\mathbf{m}_n^{\\top}\\mathbf{V}_n^{-1}\\mathbf{m}_n\\right)$$\n这表明后验分布是一个正态-逆伽马分布，$p(\\mathbf{w}, \\sigma^2 \\mid \\mathbf{y}, \\mathbf{X}) = \\mathcal{N}(\\mathbf{w} \\mid \\mathbf{m}_n, \\sigma^2\\mathbf{V}_n)\\mathrm{InvGamma}(\\sigma^2 \\mid a_n, b_n)$。\n\n### 后验预测分布的推导\n新观测值 $c_{\\ast}$ 的后验预测分布通过对参数 $(\\mathbf{w}, \\sigma^2)$ 进行边缘化得到：\n$$p(c_{\\ast} \\mid \\mathbf{x}_{\\ast}, \\mathbf{y}, \\mathbf{X}) = \\iint p(c_{\\ast} \\mid \\mathbf{x}_{\\ast}, \\mathbf{w}, \\sigma^2)p(\\mathbf{w}, \\sigma^2 \\mid \\mathbf{y}, \\mathbf{X}) \\,d\\mathbf{w}\\,d\\sigma^2$$\n预测似然为 $p(c_{\\ast} \\mid \\mathbf{x}_{\\ast}, \\mathbf{w}, \\sigma^2) = \\mathcal{N}(c_{\\ast} \\mid \\mathbf{x}_{\\ast}^{\\top}\\mathbf{w}, \\sigma^2)$。\n首先，我们对 $\\mathbf{w}$ 进行积分，这等价于求在 $\\sigma^2$ 条件下 $c_{\\ast}$ 的分布：\n$$p(c_{\\ast} \\mid \\mathbf{x}_{\\ast}, \\mathbf{y}, \\mathbf{X}, \\sigma^2) = \\int \\mathcal{N}(c_{\\ast} \\mid \\mathbf{x}_{\\ast}^{\\top}\\mathbf{w}, \\sigma^2)\\mathcal{N}(\\mathbf{w} \\mid \\mathbf{m}_n, \\sigma^2\\mathbf{V}_n)\\,d\\mathbf{w}$$\n这是两个相关高斯变量之和的分布（隐含地，因为 $c_{\\ast}=\\mathbf{x}_\\ast^\\top\\mathbf{w}+\\varepsilon_\\ast$）。均值为 $\\mathbb{E}[c_{\\ast} \\mid \\sigma^2] = \\mathbf{x}_{\\ast}^{\\top}\\mathbb{E}[\\mathbf{w} \\mid \\sigma^2] = \\mathbf{x}_{\\ast}^{\\top}\\mathbf{m}_n$。方差为 $\\mathrm{Var}(c_{\\ast} \\mid \\sigma^2) = \\mathrm{Var}(\\mathbf{x}_{\\ast}^{\\top}\\mathbf{w} + \\varepsilon_{\\ast} \\mid \\sigma^2) = \\mathbf{x}_{\\ast}^{\\top}\\mathrm{Var}(\\mathbf{w} \\mid \\sigma^2)\\mathbf{x}_{\\ast} + \\mathrm{Var}(\\varepsilon_{\\ast} \\mid \\sigma^2) = \\mathbf{x}_{\\ast}^{\\top}(\\sigma^2\\mathbf{V}_n)\\mathbf{x}_{\\ast} + \\sigma^2 = \\sigma^2(1 + \\mathbf{x}_{\\ast}^{\\top}\\mathbf{V}_n\\mathbf{x}_{\\ast})$。所以，\n$$p(c_{\\ast} \\mid \\mathbf{x}_{\\ast}, \\mathbf{y}, \\mathbf{X}, \\sigma^2) = \\mathcal{N}(c_{\\ast} \\mid \\mathbf{x}_{\\ast}^{\\top}\\mathbf{m}_n, \\sigma^2(1 + \\mathbf{x}_{\\ast}^{\\top}\\mathbf{V}_n\\mathbf{x}_{\\ast}))$$\n接下来，我们使用其后验分布 $p(\\sigma^2 \\mid \\mathbf{y}, \\mathbf{X}) = \\mathrm{InvGamma}(\\sigma^2 \\mid a_n, b_n)$ 对 $\\sigma^2$ 进行积分。\n$$p(c_{\\ast} \\mid \\mathbf{x}_{\\ast}, \\mathbf{y}, \\mathbf{X}) = \\int p(c_{\\ast} \\mid \\mathbf{x}_{\\ast}, \\mathbf{y}, \\mathbf{X}, \\sigma^2)p(\\sigma^2 \\mid \\mathbf{y}, \\mathbf{X})\\,d\\sigma^2$$\n该积分得到一个非标准化的学生t分布，$\\mathrm{t}_{\\nu}(\\mu, s^2)$，其参数为：\n-   自由度：$\\nu = 2a_n$\n-   位置（均值）：$\\mu = \\mathbf{x}_{\\ast}^{\\top}\\mathbf{m}_n$\n-   尺度平方：$s^2 = \\frac{b_n}{a_n}(1 + \\mathbf{x}_{\\ast}^{\\top}\\mathbf{V}_n\\mathbf{x}_{\\ast})$\n\n### 后验预测均值的计算\n问题要求计算后验预测平均浓度 $\\mathbb{E}[c_{\\ast} \\mid \\mathbf{x}_{\\ast}, \\mathbf{y}, \\mathbf{X}]$。根据推导出的分布，该值为 $\\mu = \\mathbf{x}_{\\ast}^{\\top}\\mathbf{m}_n$。我们需要计算权重的后验均值 $\\mathbf{m}_n$。\n\n给定数据为：\n$\\mathbf{X} = \\begin{pmatrix} 1.0  0.5 \\\\ 1.5  1.0 \\\\ 0.5  0.2 \\end{pmatrix}$, $\\mathbf{y} = \\begin{pmatrix} 2.0 \\\\ 3.0 \\\\ 1.2 \\end{pmatrix}$, $\\mathbf{m}_{0} = \\mathbf{0}$, $\\mathbf{V}_{0} = \\mathbf{I}_{2}$, $\\mathbf{x}_{\\ast} = \\begin{pmatrix} 1.2 \\\\ 0.8 \\end{pmatrix}$。\n\n1.  计算中间矩阵：\n    $$\\mathbf{X}^{\\top}\\mathbf{X} = \\begin{pmatrix} 1.0  1.5  0.5 \\\\ 0.5  1.0  0.2 \\end{pmatrix} \\begin{pmatrix} 1.0  0.5 \\\\ 1.5  1.0 \\\\ 0.5  0.2 \\end{pmatrix} = \\begin{pmatrix} 1.0^2 + 1.5^2 + 0.5^2  1.0(0.5)+1.5(1.0)+0.5(0.2) \\\\ 0.5(1.0)+1.0(1.5)+0.2(0.5)  0.5^2+1.0^2+0.2^2 \\end{pmatrix} = \\begin{pmatrix} 3.5  2.1 \\\\ 2.1  1.29 \\end{pmatrix}$$\n    $$\\mathbf{X}^{\\top}\\mathbf{y} = \\begin{pmatrix} 1.0  1.5  0.5 \\\\ 0.5  1.0  0.2 \\end{pmatrix} \\begin{pmatrix} 2.0 \\\\ 3.0 \\\\ 1.2 \\end{pmatrix} = \\begin{pmatrix} 1.0(2.0) + 1.5(3.0) + 0.5(1.2) \\\\ 0.5(2.0) + 1.0(3.0) + 0.2(1.2) \\end{pmatrix} = \\begin{pmatrix} 7.1 \\\\ 4.24 \\end{pmatrix}$$\n\n2.  计算 $\\mathbf{w}$ 的后验参数。\n    因为 $\\mathbf{V}_0 = \\mathbf{I}_2$，我们有 $\\mathbf{V}_0^{-1} = \\mathbf{I}_2$。\n    $\\mathbf{w}$ 的后验精度矩阵为：\n    $$\\mathbf{V}_n^{-1} = \\mathbf{V}_0^{-1} + \\mathbf{X}^{\\top}\\mathbf{X} = \\begin{pmatrix} 1  0 \\\\ 0  1 \\end{pmatrix} + \\begin{pmatrix} 3.5  2.1 \\\\ 2.1  1.29 \\end{pmatrix} = \\begin{pmatrix} 4.5  2.1 \\\\ 2.1  2.29 \\end{pmatrix}$$\n    权重的后验均值 $\\mathbf{m}_n$ 由 $\\mathbf{m}_n = \\mathbf{V}_n(\\mathbf{V}_0^{-1}\\mathbf{m}_0 + \\mathbf{X}^{\\top}\\mathbf{y})$ 给出。\n    当 $\\mathbf{m}_0=\\mathbf{0}$ 时，这简化为 $\\mathbf{m}_n = (\\mathbf{V}_n^{-1})^{-1}(\\mathbf{X}^{\\top}\\mathbf{y})$。\n    我们计算 $\\mathbf{V}_n^{-1}$ 的逆矩阵：\n    $$\\det(\\mathbf{V}_n^{-1}) = (4.5)(2.29) - (2.1)^2 = 10.305 - 4.41 = 5.895$$\n    $$\\mathbf{V}_n = (\\mathbf{V}_n^{-1})^{-1} = \\frac{1}{5.895} \\begin{pmatrix} 2.29  -2.1 \\\\ -2.1  4.5 \\end{pmatrix}$$\n    现在我们可以计算 $\\mathbf{m}_n$：\n    $$\\mathbf{m}_n = \\frac{1}{5.895} \\begin{pmatrix} 2.29  -2.1 \\\\ -2.1  4.5 \\end{pmatrix} \\begin{pmatrix} 7.1 \\\\ 4.24 \\end{pmatrix} = \\frac{1}{5.895} \\begin{pmatrix} 2.29(7.1) - 2.1(4.24) \\\\ -2.1(7.1) + 4.5(4.24) \\end{pmatrix}$$\n    $$\\mathbf{m}_n = \\frac{1}{5.895} \\begin{pmatrix} 16.259 - 8.904 \\\\ -14.91 + 19.08 \\end{pmatrix} = \\frac{1}{5.895} \\begin{pmatrix} 7.355 \\\\ 4.17 \\end{pmatrix}$$\n\n3.  计算后验预测平均浓度。\n    $$\\mathbb{E}[c_{\\ast}] = \\mathbf{x}_{\\ast}^{\\top}\\mathbf{m}_n = \\begin{pmatrix} 1.2  0.8 \\end{pmatrix} \\frac{1}{5.895} \\begin{pmatrix} 7.355 \\\\ 4.17 \\end{pmatrix}$$\n    $$\\mathbb{E}[c_{\\ast}] = \\frac{1}{5.895} \\left( 1.2 \\times 7.355 + 0.8 \\times 4.17 \\right)$$\n    $$\\mathbb{E}[c_{\\ast}] = \\frac{1}{5.895} \\left( 8.826 + 3.336 \\right) = \\frac{12.162}{5.895}$$\n    $$\\mathbb{E}[c_{\\ast}] \\approx 2.0631043257$$\n四舍五入到四位有效数字，后验预测平均浓度为 $2.063 \\, \\mathrm{mmol}\\,\\mathrm{L}^{-1}$。", "answer": "$$\\boxed{2.063}$$", "id": "3711449"}, {"introduction": "原始光谱数据很少被直接用于建模，有效的预处理是释放其信息潜力的关键。本练习 [@problem_id:3711432] 聚焦于 Savitzky–Golay 滤波器这一光谱处理的基石，并超越了简单的参数选择，要求您设计一个数据驱动的优化框架。通过解决这个实际问题，您将学会如何构建一个目标函数来平衡信号增强和噪声伪影抑制这两个相互竞争的目标。", "problem": "您需要设计并实现一个数据驱动的算法，该算法为 Savitzky–Golay (SG) 滤波器选择参数，以在模拟的红外吸收光谱中最大化官能团的类别可分性，同时控制伪导数伪影。该方法必须基于成熟的化学计量学原理和信号处理定义，从比尔-朗伯定律和作为 SG 滤波器基础的局部多项式逼近出发。您的解决方案必须为每个测试用例产生一个单一的数值结果，并以指定的输出格式汇总所有结果。\n\n从比尔-朗伯定律开始：对于由 $\\nu$ 表示的波数轴上的点，一个多组分有机样品的吸光度 $A(\\nu)$ 模型如下：\n$$\nA(\\nu) = \\sum_{i=1}^{K} \\varepsilon_i(\\nu)\\,c_i\\,L + \\beta(\\nu) + \\eta(\\nu),\n$$\n其中 $\\varepsilon_i(\\nu)$ 是组分 $i$ 的摩尔吸光系数，$c_i$ 是其浓度，$L$ 是光程长度，$\\beta(\\nu)$ 是一个缓慢变化的基线贡献，$\\eta(\\nu)$ 是加性随机噪声。在没有精确的 $\\varepsilon_i(\\nu)$ 表格数据的情况下，通过高斯谱带之和来模拟每个官能团的特征：\n$$\n\\varepsilon_i(\\nu) \\propto \\sum_{j=1}^{M_i} I_{ij}\\,\\exp\\left(-\\frac{(\\nu-\\nu_{ij})^2}{2\\,\\sigma_{ij}^2}\\right),\n$$\n其中心位置 $\\nu_{ij}$、宽度 $\\sigma_{ij}$ 和强度 $I_{ij}$ 的选择旨在模拟已知的红外特征（例如，醇和烷烃官能团）。Savitzky–Golay (SG) 滤波器在长度为 $m$ 的奇数窗口上执行 $p$ 阶局部多项式回归，以估计平滑值和导数；应用一阶导数会强调与吸收谱带边缘相关的斜率变化，这通常会增强类别可分性。然而，过于激进地设置 $(m,p)$ 会放大高频噪声，引入伪导数伪影。\n\n为了量化 SG 微分后的类别可分性，使用来自线性判别分析 (LDA) 的经典 Fisher 迹准则。设 $G$ 为类别数（此处 $G=2$），$n_g$ 为类别 $g$ 的样本数，$\\boldsymbol{\\mu}_g$ 为类别 $g$ 经过 SG 一阶导数变换后的平均特征向量，$\\boldsymbol{\\mu}$ 为全局均值。定义类间散度迹和类内散度迹如下：\n$$\n\\mathrm{tr}(S_B) = \\sum_{g=1}^{G} n_g\\,\\lVert \\boldsymbol{\\mu}_g - \\boldsymbol{\\mu} \\rVert_2^2,\\qquad\n\\mathrm{tr}(S_W) = \\sum_{g=1}^{G} \\sum_{i=1}^{n_g} \\lVert \\mathbf{x}_i^{(g)} - \\boldsymbol{\\mu}_g \\rVert_2^2,\n$$\n其中 $\\mathbf{x}_i^{(g)}$ 表示类别 $g$ 的第 $i$ 个样本（完整的导数谱向量）。可分性得分则为：\n$$\nJ = \\frac{\\mathrm{tr}(S_B)}{\\mathrm{tr}(S_W)}.\n$$\n为了量化伪导数伪影，使用二阶导数域中的离散傅里叶变换 (DFT) 能量比。设 $\\widehat{\\mathbf{y}}^{(2)}$ 为单个样本的 SG 二阶导数的实值谱，并令 $\\mathcal{F}\\{\\widehat{\\mathbf{y}}^{(2)}\\}$ 表示其单边实值 DFT（例如，使用实数输入快速傅里叶变换）。根据帕塞瓦尔定理，总能量可以在频域中测量。对于奈奎斯特频率的一个截止比例 $\\alpha \\in (0,1)$，定义单个样本的伪影比率如下：\n$$\nr = \\frac{\\sum_{f \\geq f_c(\\alpha)} \\lvert Y(f) \\rvert^2}{\\sum_{f \\geq 0} \\lvert Y(f) \\rvert^2},\n$$\n其中 $Y(f)$ 是 DFT 系数，$f_c(\\alpha)$ 是对应于分数 $\\alpha$ 的索引。整体伪影度量 $A$ 是所有样本的 $r$ 值的平均值。将可分性和伪影惩罚组合成一个单一的标量目标：\n$$\nO(m,p;\\lambda,\\alpha) = J(m,p) - \\lambda\\,A(m,p;\\alpha),\n$$\n其中 $\\lambda \\ge 0$ 控制惩罚强度。参数选择问题是在 $m$ 为奇数且 $m > p$ 的约束下，选择使 $O$ 最大化的 $(m,p)$。\n\n算法设计要求：\n- 使用高斯谱带、加性基线和随机噪声，根据比尔-朗伯模型模拟两个官能团的吸收光谱。每个测试用例使用固定的随机种子以确保可复现性。\n- 对于给定网格中的每个候选对 $(m,p)$，计算 SG 一阶和二阶导数，评估 $J$，评估 $A$，并计算 $O$。选择具有最大 $O$ 值的对。若出现平局，则优先选择较小的 $A$，其次选择较小的 $m$。\n- 不要估计或使用任何用于求解最优 $(m,p)$ 的捷径闭式解；唯一可接受的方法是遵循上述定义的显式计算。\n\n单位：由于输出是纯粹的数值参数选择，最终答案中不需要物理单位。不涉及角度。所有数值输出必须是纯整数。\n\n测试套件：\n- 用例 1 (正常路径): 两个类别，谱带中度分离，噪声中等。\n  - 轴长度 $N=1024$，波数轴 $\\nu \\in [650, 4000]$，均匀采样 $N$ 个点。\n  - 每个类别的样本数 $n_g=40$。\n  - 基线斜率 $b=10^{-4}$，噪声标准差 $\\sigma=2\\times 10^{-3}$。\n  - 伪影截止比例 $\\alpha=0.5$，惩罚权重 $\\lambda=0.1$。\n  - 候选窗口 $m \\in \\{5,7,9,11\\}$，候选多项式阶数 $p \\in \\{2,3,4\\}$。\n- 用例 2 (边界条件：高噪声): 相同的轴，但基线和噪声更强。\n  - $N=1024$，$n_g=40$，$b=2\\times 10^{-4}$，$\\sigma=1\\times 10^{-2}$。\n  - $\\alpha=0.4$，$\\lambda=1.0$。\n  - $m \\in \\{7,9,11,13\\}$，$p \\in \\{2,3,4\\}$。\n- 用例 3 (边缘情况：高分辨率，窄谱带): 一个类别的吸收特征更紧凑、更窄，且噪声较低。\n  - $N=2048$，$n_g=30$，$b=0$，$\\sigma=1\\times 10^{-3}$。\n  - $\\alpha=0.6$，$\\lambda=0.05$。\n  - $m \\in \\{5,7\\}$，$p \\in \\{2,3\\}$。\n  - 一个类别应至少有两个窄高斯谱带（全宽约 $20$–$30$ 波数单位）以测试分辨率。\n\n官能团建模：\n- 类别 0 (类醇): 在 $\\nu\\approx 3300$ 附近有宽度 $\\sigma\\approx 120$、强度 $I\\approx 1.0$ 的宽谱带，并在 $\\nu\\approx 1710$ 附近有 $\\sigma\\approx 25$、$I\\approx 0.5$ 的附加谱带，在 $\\nu\\approx 1050$ 附近有 $\\sigma\\approx 30$、$I\\approx 0.7$ 的附加谱带。\n- 类别 1 (类烷烃): 在 $\\nu\\approx 2960$ 附近有 $\\sigma\\approx 40$、$I\\approx 1.0$ 的谱带，在 $\\nu\\approx 2870$ 附近有 $\\sigma\\approx 40$、$I\\approx 0.8$ 的谱带，在 $\\nu\\approx 1460$ 附近有 $\\sigma\\approx 30$、$I\\approx 0.6$ 的谱带。对于用例 3，将 $\\nu\\approx 2960$ 和 $\\nu\\approx 1460$ 处的两个谱带变窄为 $\\sigma\\approx 20$，强度 $I$ 与上述相似。\n\n实现约束：\n- 每个用例使用固定种子：种子 $=123+\\text{case\\_index}$，其中用例 1 的 case index 为 0，用例 2 为 1，用例 3 为 2。\n- 对于每个类别的每个样本，为每个谱带从 $[0.8, 1.2]$ 中均匀抽取一个乘性强度因子 $c$，将所有谱带求和，然后添加基线 $b\\,(\\nu-\\nu_{\\min})$，最后添加标准差为 $\\sigma$ 的独立高斯噪声。\n- 应用具有指定 $(m,p)$ 的 SG 滤波器来计算光谱的一阶导数 ($\\text{deriv}=1$) 和二阶导数 ($\\text{deriv}=2$)。\n\n最终输出规范：\n- 对于每个测试用例，输出所选的 SG 参数对，形式为双元素列表 $[m,p]$。\n- 您的程序应生成单行输出，其中包含一个以逗号分隔的列表，列表用方括号括起，每对参数的格式为 $[m,p]$。例如：$[[7,3],[11,3],[5,2]]$。", "solution": "问题陈述已经过分析，并被确定为**有效**。它在科学上是合理的，问题定义清晰，并包含了构建唯一且可验证解决方案所需的所有必要信息和定义。该方法论基于成熟的化学计量学和信号处理原理。\n\n任务是设计一个数据驱动的算法，为 Savitzky–Golay (SG) 滤波器选择最优参数。优化目标是最大化代表不同化学官能团的光谱类别的可分性，同时惩罚由噪声放大引起的导数伪影。这个问题被表述为对 SG 滤波器的窗口大小 $m$ 和多项式阶数 $p$ 的网格搜索优化问题。\n\n对于每个测试用例，算法分三个主要阶段进行：数据模拟，为每个参数对进行特征提取和度量评估，最后选择最优参数对。\n\n**1. 光谱数据模拟**\n\n模拟的基础是比尔-朗伯定律，该定律将特定波数 $\\nu$ 处的吸光度 $A$ 建模为来自不同化学组分的贡献、基线漂移和噪声的总和：\n$$\nA(\\nu) = \\sum_{i=1}^{K} \\varepsilon_i(\\nu)\\,c_i\\,L + \\beta(\\nu) + \\eta(\\nu)\n$$\n此处，$\\varepsilon_i(\\nu)$ 是组分 $i$ 在浓度为 $c_i$ 时的摩尔吸光系数，$L$ 是光程长度（通过将其并入 $\\varepsilon_i$，我们可以不失一般性地将其设为 1），$\\beta(\\nu)$ 是背景基线，$\\eta(\\nu)$ 是随机噪声。\n\n遵循问题规范，我们将每个官能团（类别）的特征信号 $\\varepsilon_i(\\nu)$ 建模为高斯谱带之和：\n$$\n\\varepsilon_i(\\nu) \\propto \\sum_{j=1}^{M_i} I_{ij}\\,\\exp\\left(-\\frac{(\\nu-\\nu_{ij})^2}{2\\,\\sigma_{ij}^2}\\right)\n$$\n其中 $I_{ij}$、$\\nu_{ij}$ 和 $\\sigma_{ij}$ 分别是第 $i$ 个类别的第 $j$ 个谱带的强度、中心位置和宽度。代表类醇和类烷烃基团的两个类别的参数已给出。\n\n对于每个模拟样本，通过将每个高斯谱带的强度 $I_{ij}$ 乘以一个从均匀分布 $U(0.8, 1.2)$ 中抽取的随机因子，来引入类似于浓度波动的样本间变异性。基线被建模为线性函数 $\\beta(\\nu) = b\\,(\\nu - \\nu_{\\min})$，噪声 $\\eta(\\nu)$ 从均值为 0、标准差为指定值 $\\sigma$ 的高斯分布中抽取。重复此过程，在长度为 $N$ 的离散波数轴 $\\nu$ 上为 $G=2$ 个类别中的每一个生成 $n_g$ 个样本光谱。每个测试用例使用固定的随机种子以确保可复现性。\n\n**2. 特征提取与目标函数评估**\n\n对于每个候选 SG 参数对 $(m, p)$，其中 $m$ 是窗口大小，$p$ 是多项式阶数（$m>p$，$m$ 为奇数），我们评估一个复合目标函数 $O(m,p)$。该函数旨在平衡类别可分性与伪影控制。\n\n首先，使用 SG 滤波器对原始吸光度光谱进行变换，计算其一阶和二阶导数。这些导数作为评估的特征。\n\n**2.1. 类别可分性度量 ($J$)**\n\n光谱的一阶导数能增强谱带边缘等尖锐特征，从而改善类别区分度。为量化这一点，我们使用源自线性判别分析 (LDA) 的 Fisher 迹准则 $J$。它是类间散度与类内散度之比：\n$$\nJ(m,p) = \\frac{\\mathrm{tr}(S_B)}{\\mathrm{tr}(S_W)}\n$$\n设 $\\mathbf{x}_i^{(g)}$ 表示类别 $g$ 的第 $i$ 个样本的一阶导数光谱（一个在每个波数点上都有值的向量）。类别 $g$ 的平均光谱是 $\\boldsymbol{\\mu}_g$，全局平均光谱是 $\\boldsymbol{\\mu}$。类间散度矩阵 $S_B$ 和类内散度矩阵 $S_W$ 的迹计算如下：\n$$\n\\mathrm{tr}(S_B) = \\sum_{g=1}^{G} n_g\\,\\lVert \\boldsymbol{\\mu}_g - \\boldsymbol{\\mu} \\rVert_2^2\n$$\n$$\n\\mathrm{tr}(S_W) = \\sum_{g=1}^{G} \\sum_{i=1}^{n_g} \\lVert \\mathbf{x}_i^{(g)} - \\boldsymbol{\\mu}_g \\rVert_2^2\n$$\n$J$ 值越高，表示相对于类别内部的变化，类别之间的分离度越大。\n\n**2.2. 伪影惩罚度量 ($A$)**\n\n虽然微分可以增强特征，但它也会放大高频噪声。过于激进的滤波（例如，小 $m$、高 $p$）会在导数光谱中产生伪峰，即“伪导数伪影”。为了量化这一点，我们分析了对噪声更为敏感的二阶导数光谱在频域中的能量分布。\n\n对于每个二阶导数光谱 $\\widehat{\\mathbf{y}}^{(2)}$，计算其单边实值离散傅里叶变换 (DFT)，记作 $\\mathcal{F}\\{\\widehat{\\mathbf{y}}^{(2)}\\}$。设 $Y(f)$ 为 DFT 系数。此单个样本的伪影比率 $r$ 是高频区域能量与总能量之比：\n$$\nr = \\frac{\\sum_{f \\geq f_c(\\alpha)} \\lvert Y(f) \\rvert^2}{\\sum_{f \\geq 0} \\lvert Y(f) \\rvert^2}\n$$\n截止频率索引 $f_c(\\alpha)$ 由奈奎斯特频率范围的一个指定比例 $\\alpha$ 确定。整体伪影度量 $A(m,p;\\alpha)$ 是来自所有类别的所有样本的 $r$ 值的平均值。$A$ 值越高，表示高频成分的比例越大，这归因于噪声引起的伪影。\n\n**2.3. 组合目标函数 ($O$)**\n\n将这两个度量组合成一个待最大化的单一标量目标函数 $O$：\n$$\nO(m,p;\\lambda,\\alpha) = J(m,p) - \\lambda\\,A(m,p;\\alpha)\n$$\n超参数 $\\lambda \\ge 0$ 是一个控制权衡的惩罚权重：$\\lambda$ 越大，表示越重视抑制伪影。\n\n**3. 优化与参数选择**\n\n算法对提供的候选对 $(m, p)$ 集合执行网格搜索。对于每个有效对，它会模拟完整的光谱数据集，应用 SG 滤波器计算一阶和二阶导数，并计算目标函数 $O(m,p)$。\n\n在评估完网格中的所有对之后，产生最大 $O$ 值的 $(m,p)$ 对被选为最优对。问题规定了明确的平局打破规则：如果多个对产生相同的最大 $O$ 值，则选择伪影度量 $A$ 较小的那个。如果仍然平局，则选择窗口大小 $m$ 较小的那个。此过程保证了对于每个测试用例，从候选集中能得到一个唯一的最优参数对。最终输出是这一系列测试用例的最优参数对列表。", "answer": "[[7,3],[11,3],[5,2]]", "id": "3711432"}, {"introduction": "在掌握了建模和预处理等独立模块后，将它们集成为一个稳健、可重复的系统是实现可靠分析的最后一步。本练习 [@problem_id:3711419] 要求您像机器学习工程师一样思考，设计一个完整的化学计量学流程，并特别关注如何避免“数据泄漏”这一致命陷阱。掌握这些原则对于构建可信赖并能实际部署的光谱分析解决方案至关重要。", "problem": "一个实验室正在构建一个可复现的化学计量学流程，用于从近红外 (NIR) 光谱中鉴定有机化合物。原始数据表示为一个矩阵 $X_{\\mathrm{raw}} \\in \\mathbb{R}^{n \\times m}$，包含 $n$ 个样本和 $m$ 个波长，其类别标签 $y \\in \\{1, \\dots, C\\}$ 指示化合物的身份。每个样本的光谱是一个向量 $x \\in \\mathbb{R}^{m}$。目标是设计一个流程对象，该对象封装从原始光谱到预测的所有步骤，包括预处理、特征提取和建模，并论证为何序列化已拟合的流程可以防止数据泄露并确保可复现性。\n\n可用的化学计量学预处理阶段包括：\n- 使用不对称最小二乘法 (Asymmetric Least Squares, ALS) 进行基线去除，它通过最小化一个带平滑参数 $\\lambda$ 和不对称参数 $p$ 的加权惩罚最小二乘目标来求解基线 $\\beta \\in \\mathbb{R}^{m}$，从而得到校正后的光谱 $x' = x - \\beta$。\n- 标准正态变量 (Standard Normal Variate, SNV)，逐条光谱应用以产生 $S(x) = \\dfrac{x - \\bar{x}\\mathbf{1}}{s_x}$，其中 $\\bar{x}$ 是 $x$ 中各条目的均值，$s_x$ 是它们的标准差，$\\mathbf{1} \\in \\mathbb{R}^{m}$ 是全1向量。\n- Savitzky–Golay (SG) 导数滤波，$D_{\\mathrm{SG}}(x)$，由窗口长度和多项式阶数参数化。\n\n特征提取的选择包括具有 $k$ 个主成分的主成分分析 (Principal Component Analysis, PCA) 和具有 $k$ 个潜变量的偏最小二乘法 (Partial Least Squares, PLS)。分类器包括线性判别分析 (Linear Discriminant Analysis, LDA) 和支持向量机 (Support Vector Machine, SVM)。团队将使用交叉验证 (Cross-Validation, CV) 进行模型选择，可能使用嵌套CV进行超参数调优，并会考虑重复测量值，这些值绝不能在各折之间泄露。\n\n从第一性原理的统计学习视角来看，一个流程是多个映射的复合 $f = M_{\\theta_M} \\circ E_{\\theta_E} \\circ D_{\\theta_D} \\circ S_{\\theta_S} \\circ B_{\\theta_B}$，其中 $B_{\\theta_B}$、$S_{\\theta_S}$、$D_{\\theta_D}$ 和 $E_{\\theta_E}$ 是预处理和特征提取映射，其参数 $\\theta_B$、$\\theta_S$、$\\theta_D$ 和 $\\theta_E$ 仅在训练数据上学习得到，而 $M_{\\theta_M}$ 是由 $\\theta_M$ 参数化的分类器。期望泛化风险为 $R(f) = \\mathbb{E}_{(x,y)\\sim \\mathcal{D}}[\\ell(f(x), y)]$，其中 $\\ell$ 是损失函数，通过CV进行无偏估计依赖于保持训练折和验证折之间的独立性，以使任何参数都不受验证或测试数据的影响。序列化是指将已拟合的流程 $(\\hat{\\theta}_B, \\hat{\\theta}_S, \\hat{\\theta}_D, \\hat{\\theta}_E, \\hat{\\theta}_M)$ 持久化到存储中，并在之后加载它以应用 $f$ 而无需任何重新拟合。\n\n考虑以下选项，它们提出了不同的流程设计和CV策略。选择所有正确指定了从原始光谱到预测的可复现、无泄露风险的流程，并正确论证了序列化如何在部署中避免数据泄露的选项。\n\nA. 使用所有 $X_{\\mathrm{raw}}$ 数据一次性拟合 $B_{\\theta_B}$、$S_{\\theta_S}$ 和 $E_{\\theta_E}$ (具有 $k$ 个主成分的PCA)；然后仅对 $M_{\\theta_M}$ (SVM) 使用预先计算好的转换后数据执行CV。训练后，仅序列化 $M_{\\theta_M}$；对于新光谱 $x_{\\mathrm{new}}$，在预测前，在包括 $x_{\\mathrm{new}}$ 在内的所有可用数据上重新计算 $B_{\\theta_B}$、$S_{\\theta_S}$ 和 $E_{\\theta_E}$。\n\nB. 构建一个单一的流程对象 $f = M_{\\theta_M} \\circ E_{\\theta_E} \\circ D_{\\theta_D} \\circ S_{\\theta_S} \\circ B_{\\theta_B}$，其中每一步都是一个具有独立 $\\mathrm{fit}$ 和 $\\mathrm{transform}$ 语义的估计器。使用嵌套CV：内层循环调优超参数（包括SG窗口长度/阶数、PCA或PLS维度 $k$ 以及分类器的正则化/核函数），外层循环估计 $R(f)$。在每个CV折中，仅使用训练子集拟合所有步骤以产生 $(\\hat{\\theta}_B, \\hat{\\theta}_S, \\hat{\\theta}_D, \\hat{\\theta}_E, \\hat{\\theta}_M)$，然后使用流程的 $\\mathrm{predict}$ 方法在验证子集上进行评估，无需重新拟合。固定随机步骤中的伪随机种子以确保可复现性。序列化整个已拟合的流程（所有 $\\hat{\\theta}$），以便在部署时 $f(x_{\\mathrm{new}})$ 使用固定的转换和模型；不对 $x_{\\mathrm{new}}$ 重新计算任何参数，从而防止数据泄露并保留确切的训练状态。\n\nC. 将PCA放入流程中，但在CV之前，使用从所有 $X_{\\mathrm{raw}}$ 估计的 $\\mu$ 和 $\\sigma$ 对样本进行全局中心化和缩放，即 $x \\mapsto \\dfrac{x - \\mu}{\\sigma}$。对分类器使用分层CV。序列化整个流程；论证因为序列化固定了 $\\mu$ 和 $\\sigma$，所以可以防止泄露。\n\nD. 构建一个顺序为 $E_{\\theta_E}$ (PCA) $\\rightarrow S_{\\theta_S}$ (SNV) $\\rightarrow D_{\\theta_D}$ (SG导数) $\\rightarrow B_{\\theta_B}$ (基线) 的流程，后接 $M_{\\theta_M}$ (SVM)。使用所有 $X_{\\mathrm{raw}}$ 来调优PCA的主成分以稳定方向。在部署期间，使用传入的批次重新计算 $S_{\\theta_S}$ 和 $D_{\\theta_D}$ 的参数以适应仪器漂移，但保持序列化的PCA和SVM固定；声称这种自适应减少了泄露，因为它只使用了未标记的测试数据。\n\nE. 使用分组CV (GroupKFold) 以确保来自同一物理样本的重复光谱被分组，从而永远不会被分割到不同的折中。定义 $f = M_{\\theta_M} \\circ E_{\\theta_E} \\circ D_{\\theta_D} \\circ S_{\\theta_S} \\circ B_{\\theta_B}$，其中 $B_{\\theta_B}$ (ALS基线)、$S_{\\theta_S}$ (逐光谱SNV)、$D_{\\theta_D}$ (SG导数) 和 $E_{\\theta_E}$ (具有 $k$ 个潜变量的PLS)。执行嵌套CV，其中内层循环调优ALS的 $\\lambda$、$p$ 参数，SG的窗口长度和阶数，PLS的维度 $k$ 以及分类器的正则化参数。在每个折中，仅在训练子集上拟合所有步骤，并在留出的组上进行评估。将整个已拟合的流程连同CV配置（随机状态和分组分配）一起序列化，以便在部署时 $f(x_{\\mathrm{new}})$ 使用固定的已学习参数 $(\\hat{\\theta}_B, \\hat{\\theta}_D, \\hat{\\theta}_E, \\hat{\\theta}_M)$ 和逐光谱的 $S(x_{\\mathrm{new}})$，不对 $x_{\\mathrm{new}}$ 进行重新拟合，从而防止数据泄露并实现选择过程的精确可复现性。\n\n哪些选项是正确的？", "solution": "在进行求解之前，对问题陈述的有效性进行了严格评估。\n\n### 第1步：提取已知信息\n- **数据矩阵**: $X_{\\mathrm{raw}} \\in \\mathbb{R}^{n \\times m}$ ($n$ 个样本, $m$ 个波长)。\n- **标签**: $y \\in \\{1, \\dots, C\\}$ (化合物身份)。\n- **样本向量**: $x \\in \\mathbb{R}^{m}$。\n- **目标**: 设计一个可复现的化学计量学流程用于光谱鉴定。论证序列化如何防止数据泄露并确保可复现性。\n- **预处理操作**:\n    - 不对称最小二乘法 (ALS) 基线去除: $x' = x - \\beta$, 参数 $\\lambda, p$。\n    - 标准正态变量 (SNV): $S(x) = \\dfrac{x - \\bar{x}\\mathbf{1}}{s_x}$。\n    - Savitzky–Golay (SG) 导数滤波: $D_{\\mathrm{SG}}(x)$, 参数为窗口长度、多项式阶数。\n- **特征提取操作**:\n    - 主成分分析 (PCA)，含 $k$ 个主成分。\n    - 偏最小二乘法 (PLS)，含 $k$ 个潜变量。\n- **分类器**: 线性判别分析 (LDA), 支持向量机 (SVM)。\n- **验证**: 交叉验证 (CV)，可能为嵌套CV。提及了绝不能在折之间泄露的重复测量值。\n- **形式化的流程定义**: 映射的复合 $f = M_{\\theta_M} \\circ E_{\\theta_E} \\circ D_{\\theta_D} \\circ S_{\\theta_S} \\circ B_{\\theta_B}$。参数 $\\theta$ 需在训练数据上学习。\n- **风险估计**: $R(f) = \\mathbb{E}_{(x,y)\\sim \\mathcal{D}}[\\ell(f(x), y)]$。通过CV进行无偏估计需要训练折和验证折之间的独立性。\n- **序列化**: 持久化已拟合的流程状态 $(\\hat{\\theta}_B, \\hat{\\theta}_S, \\hat{\\theta}_D, \\hat{\\theta}_E, \\hat{\\theta}_M)$，以便之后应用而无需重新拟合。\n\n### 第2步：使用提取的已知信息进行验证\n- **科学依据**: 该问题基于分析化学（光谱学）、化学计量学和统计学习理论的既定原则。列出的所有方法（NIR, ALS, SNV, SG, PCA, PLS, SVM, CV）都是标准方法且描述正确。数据泄露、可复现性和模型持久化（序列化）等核心概念是现代应用机器学习的核心。\n- **适定性**: 该问题是适定的。它要求根据提示本身提供的统计模型验证基本原则来评估几种提议的方法。目标明确，可以通过应用这些原则确定一组唯一的正确选项。\n- **客观性**: 问题使用精确的数学和技术术语客观陈述。没有歧义或主观声明。\n\n### 第3步：结论与行动\n问题陈述是**有效的**。它在科学上是合理的、适定的且客观的。我将通过分析每个选项来推导解决方案。\n\n### 解决方案推导\n\n验证机器学习流程并估计其泛化性能的基本原则是防止**数据泄露**。当来自训练数据集之外的信息被用于创建模型时，就会发生数据泄露。在交叉验证（CV）的背景下，这意味着任何及所有数据驱动的参数学习——包括预处理、特征提取和模型拟合——都必须在每个CV折中*仅*在数据的训练部分上执行。验证部分必须被视为未见过的数据，使用从训练折中学到的参数进行转换，然后用于评估。一个可复现的流程是指，当使用相同的数据、代码和随机种子执行时，能够产生完全相同的结果。序列化一个*完全拟合*的流程可确保通过CV验证的精确模型就是部署用于未来预测的模型，从而防止来自新数据的数据泄露并确保一致性。\n\n我们现在根据这些原则评估每个选项。\n\n**A. 使用所有 $X_{\\mathrm{raw}}$ 数据一次性拟合 $B_{\\theta_B}$、$S_{\\theta_S}$ 和 $E_{\\theta_E}$ (具有 $k$ 个主成分的PCA)；然后仅对 $M_{\\theta_M}$ (SVM) 使用预先计算好的转换后数据执行CV。训练后，仅序列化 $M_{\\theta_M}$；对于新光谱 $x_{\\mathrm{new}}$，在预测前，在包括 $x_{\\mathrm{new}}$ 在内的所有可用数据上重新计算 $B_{\\theta_B}$、$S_{\\theta_S}$ 和 $E_{\\theta_E}$。**\n\n这个提议包含多个关键缺陷。\n1.  **训练/验证期间的数据泄露**: 在执行交叉验证之前，对整个数据集 $X_{\\mathrm{raw}}$ 拟合PCA变换 $E_{\\theta_E}$ 是数据泄露的典型例子。主成分（新特征空间的基向量）是由*整个*数据集的方差结构决定的，包括那些将在每个CV折中用于验证的样本。这使得验证集被模型构建过程“看到”，从而导致对泛化风险 $R(f)$ 的估计产生乐观偏差。同样的逻辑也适用于任何其他参数从数据分布中学习的变换（如 $B_{\\theta_B}$）。\n2.  **不正确的序列化**: 仅序列化分类器 $M_{\\theta_M}$ 是不够的。完整的函数 $f$ 包括预处理和特征提取步骤。为了进行有效预测，新数据必须以与训练数据完全相同的方式进行转换，即使用训练期间学到的参数 $(\\hat{\\theta}_B, \\hat{\\theta}_S, \\hat{\\theta}_E)$。\n3.  **部署期间的数据泄露**: 在包含 $x_{\\mathrm{new}}$ 的新数据集上重新计算变换，意味着应用于 $x_{\\mathrm{new}}$ 的函数与经过验证的函数不同。预测结果变得依赖于同时预测的其他数据点，这违反了应用固定、已验证模型的原则。\n\n**对A的裁定**: **错误**。\n\n**B. 构建一个单一的流程对象 $f = M_{\\theta_M} \\circ E_{\\theta_E} \\circ D_{\\theta_D} \\circ S_{\\theta_S} \\circ B_{\\theta_B}$，其中每一步都是一个具有独立 $\\mathrm{fit}$ 和 $\\mathrm{transform}$ 语义的估计器。使用嵌套CV：内层循环调优超参数（包括SG窗口长度/阶数、PCA或PLS维度 $k$ 以及分类器的正则化/核函数），外层循环估计 $R(f)$。在每个CV折中，仅使用训练子集拟合所有步骤以产生 $(\\hat{\\theta}_B, \\hat{\\theta}_S, \\hat{\\theta}_D, \\hat{\\theta}_E, \\hat{\\theta}_M)$，然后使用流程的 $\\mathrm{predict}$ 方法在验证子集上进行评估，无需重新拟合。固定随机步骤中的伪随机种子以确保可复现性。序列化整个已拟合的流程（所有 $\\hat{\\theta}$），以便在部署时 $f(x_{\\mathrm{new}})$ 使用固定的转换和模型；不对 $x_{\\mathrm{new}}$ 重新计算任何参数，从而防止数据泄露并保留确切的训练状态。**\n\n该选项正确地描述了构建和验证机器学习模型的“黄金标准”。\n1.  **流程完整性**: 将所有步骤封装在遵守 `fit`/`transform` 约定的单一流程对象中，可确保所有依赖数据的步骤在CV循环内得到正确处理。\n2.  **正确的CV流程**: 使用嵌套CV进行超参数调优和性能估计是严谨的。关键在于，它指出“在每个CV折中，仅使用训练子集拟合所有步骤”。这正确地隔离了验证集并防止了数据泄露，从而得到对 $R(f)$ 的无偏估计。\n3.  **可复现性**: 固定随机种子是确保计算可复现性的正确做法。\n4.  **正确的部署策略**: 序列化*整个*已拟合的流程——包括从所有数据的最终训练运行中学到的所有预处理和特征提取参数——是正确的方法。将这个固定的流程应用于新数据 $x_{\\mathrm{new}}$ 而不进行任何重新拟合，确保了部署的模型与经过验证的模型完全相同，并防止了来自 $x_{\\mathrm{new}}$ 的任何泄露。声明“不对 $x_{\\mathrm{new}}$ 重新计算任何参数”正确地指代从训练总体中学到的参数（例如PCA基）。像SNV这样的逐样本操作由流程的 `transform` 逻辑正确处理。\n\n**对B的裁定**: **正确**。\n\n**C. 将PCA放入流程中，但在CV之前，使用从所有 $X_{\\mathrm{raw}}$ 估计的 $\\mu$ 和 $\\sigma$ 对样本进行全局中心化和缩放，即 $x \\mapsto \\dfrac{x - \\mu}{\\sigma}$。对分类器使用分层CV。序列化整个流程；论证因为序列化固定了 $\\mu$ 和 $\\sigma$，所以可以防止泄露。**\n\n这个选项是有缺陷的。\n1.  **预处理期间的数据泄露**: 初始步骤，“在CV之前，使用从所有 $X_{\\mathrm{raw}}$ 估计的 $\\mu$ 和 $\\sigma$ 进行全局中心化和缩放”，引入了数据泄露。均值 $\\mu$ 和标准差 $\\sigma$ 是从数据中学到的参数。通过在整个数据集上计算它们，来自验证折的信息被泄露到每个折的训练过程中。\n2.  **有缺陷的论证**: “序列化固定了 $\\mu$ 和 $\\sigma$，所以可以防止泄露”的论证是不合逻辑的推论。序列化在*部署*时防止泄露，但它不能追溯性地修复在*验证*阶段发生的泄露。从这个有缺陷的CV流程中获得的性能估计是无效的，因此我们没有对序列化模型的真实性能的可靠估计。\n\n**对C的裁定**: **错误**。\n\n**D. 构建一个顺序为 $E_{\\theta_E}$ (PCA) $\\rightarrow S_{\\theta_S}$ (SNV) $\\rightarrow D_{\\theta_D}$ (SG导数) $\\rightarrow B_{\\theta_B}$ (基线) 的流程，后接 $M_{\\theta_M}$ (SVM)。使用所有 $X_{\\mathrm{raw}}$ 来调优PCA的主成分以稳定方向。在部署期间，使用传入的批次重新计算 $S_{\\theta_S}$ 和 $D_{\\theta_D}$ 的参数以适应仪器漂移，但保持序列化的PCA和SVM固定；声称这种自适应减少了泄露，因为它只使用了未标记的测试数据。**\n\n这个选项因几个原因而错误。\n1.  **有问题的流程顺序**: 从化学计量学的角度来看，提议的操作顺序（$PCA \\rightarrow SNV \\rightarrow ...$）是高度可疑的。PCA对基线偏移和尺度伪影很敏感，而基线校正和SNV正是为了减轻这些问题。标准、有效的顺序通常是相反的：首先校正伪影，然后提取特征。\n2.  **训练期间的数据泄露**: “使用所有 $X_{\\mathrm{raw}}$ 来调优PCA的主成分”再次明显违反了无泄露原则，与选项A和C中的缺陷相同。\n3.  **有缺陷的部署策略和论证**: 在部署时对“传入的批次”重新计算参数是无效的。它使得模型对给定样本的输出依赖于批次中的其他样本。声称这“减少了泄露，因为它只使用了未标记的测试数据”是荒谬的。使用测试数据（无论是否标记）来拟合转换或模型的*任何*部分都是一种信息泄露（具体来说，是直推式推断），它使来自原始CV流程的性能保证失效。\n\n**对D的裁定**: **错误**。\n\n**E. 使用分组CV (GroupKFold) 以确保来自同一物理样本的重复光谱被分组，从而永远不会被分割到不同的折中。定义 $f = M_{\\theta_M} \\circ E_{\\theta_E} \\circ D_{\\theta_D} \\circ S_{\\theta_S} \\circ B_{\\theta_B}$，其中 $B_{\\theta_B}$ (ALS基线)、$S_{\\theta_S}$ (逐光谱SNV)、$D_{\\theta_D}$ (SG导数) 和 $E_{\\theta_E}$ (具有 $k$ 个潜变量的PLS)。执行嵌套CV，其中内层循环调优ALS的 $\\lambda$、$p$ 参数，SG的窗口长度和阶数，PLS的维度 $k$ 以及分类器的正则化参数。在每个折中，仅在训练子集上拟合所有步骤，并在留出的组上进行评估。将整个已拟合的流程连同CV配置（随机状态和分组分配）一起序列化，以便在部署时 $f(x_{\\mathrm{new}})$ 使用固定的已学习参数 $(\\hat{\\theta}_B, \\hat{\\theta}_D, \\hat{\\theta}_E, \\hat{\\theta}_M)$ 和逐光谱的 $S(x_{\\mathrm{new}})$，不对 $x_{\\mathrm{new}}$ 进行重新拟合，从而防止数据泄露并实现选择过程的精确可复现性。**\n\n该选项描述了一种高度严谨和正确的方法论，它建立在选项B的原则之上，并增加了更多的特异性。\n1.  **正确处理依赖数据**: 问题陈述明确提到了“重复测量”。使用分组CV（例如 `GroupKFold`）是处理这种非独立同分布（non-i.i.d.）数据结构的正确统计程序，可以防止因在训练集和验证集中都存在高度相似的重复光谱而导致的人为虚高的性能估计。\n2.  **流程完整性和正确的CV**: 与选项B一样，它正确地提出了一个完整的流程、嵌套CV，并在训练折内严格拟合所有参数（包括ALS、SG和PLS的参数）。\n3.  **正确而精确的部署策略**: 它正确地指出必须序列化整个已拟合的流程。它敏锐地区分了从总体中学到的参数 $(\\hat{\\theta}_B, \\hat{\\theta}_D, \\hat{\\theta}_E, \\hat{\\theta}_M)$（这些是固定的）和逐光谱变换（如SNV, $S(x_{\\mathrm{new}})$）的应用（这仅使用新样本自身的数据正确地应用于该样本）。这种细节水平更胜一筹。\n4.  **完全的可复现性**: 提及序列化CV配置（种子、分组分配）解决了使整个*模型选择过程*可复现的目标，这是一种先进且值得称赞的做法。\n\n**对E的裁定**: **正确**。\n\n选项B和E都描述了有效、无泄露且可复现的流程。选项E通过明确并正确地解决问题描述中提到的重复样本问题，提供了一个更完整的解决方案。", "answer": "$$\\boxed{BE}$$", "id": "3711419"}]}