{"hands_on_practices": [{"introduction": "任何精确的测量都始于一个经过良好校准的仪器。在DOSY实验中，设定的梯度强度与实际施加的梯度强度之间可能存在偏差，而快速切换梯度场产生的涡流也会影响有效梯度。本练习 [@problem_id:3699340] 将指导您如何利用已知扩散系数的标准样品来校准实验系统，从而获得准确的扩散数据。这个过程是确保DOSY实验结果可靠性的关键第一步。", "problem": "为了分析混合物，使用脉冲梯度自旋回波（PGSE）序列进行扩散排序谱（DOSY）测量，以估算有机分析物的扩散系数。检测核为质子，其旋磁比为 $\\gamma = 2.675 \\times 10^{8}\\,\\mathrm{rad\\,s^{-1}\\,T^{-1}}$。梯度波形名义上是矩形，具有可编程的幅度 $g_{\\text{set}}$（单位为 $\\mathrm{T\\,m^{-1}}$）、脉冲持续时间 $\\delta$ 和扩散时间 $\\Delta$。然而，存在两种仪器上的非理想性：\n\n1. 梯度校准：实际梯度幅度按因子 $\\kappa$ 进行缩放，因此 $g_{\\text{actual}} = \\kappa\\,g_{\\text{set}}$。\n2. 涡流：在此探头配置中，所有梯度瓣的有效梯度幅度都会因一个因子 $(1 - \\epsilon)$ 而 multiplicative 地减小，这个减小是共通的，其中 $\\epsilon$ 是通过对硬件进行独立的涡流表征得到的。\n\n已知在高斯扩散和小角度相位累积的条件下，回波衰减遵循 $S/S_0 = \\exp(-bD)$，其中 $b$ 由时间积分的梯度波形确定。对于理想的矩形 PGSE 脉冲，经过充分检验的 Stejskal–Tanner 结果给出的 $b$ 值与 $g^2$ 成正比，即 $b(g) = \\gamma^2 g^2 \\delta^2 (\\Delta - \\delta/3)$。在此处的实践中，观测到的是半对数图 $\\ln(S/S_0)$ 对 $g_{\\text{set}}^2$ 的斜率，而上述两种非理想性将有效斜率缩放了 $\\kappa^2(1 - \\epsilon)^2$ 倍。\n\n为您提供了以下实验参数和校准数据：\n- 脉冲持续时间 $\\delta = 2.50 \\times 10^{-3}\\,\\mathrm{s}$。\n- 扩散时间 $\\Delta = 5.00 \\times 10^{-2}\\,\\mathrm{s}$。\n- 涡流幅度因子 $\\epsilon = 0.10$（无量纲）。\n- 具有已知扩散系数 $D_{\\text{ref}} = 2.30 \\times 10^{-9}\\,\\mathrm{m^2\\,s^{-1}}$ 的参考样品，该样品在相同的温度和序列时序下测量。\n- 参考样品的测量斜率 $m_{\\text{ref}} = 40.0\\,\\mathrm{m^2\\,T^{-2}}$，由 $\\ln(S/S_0)$ 对 $g_{\\text{set}}^2$ 的线性拟合得到。\n- 混合物中乙醇共振峰的测量斜率 $m_{\\text{eth}} = 35.0\\,\\mathrm{m^2\\,T^{-2}}$，在相同条件下得到。\n\n利用扩散驱动的相位弥散与 PGSE 的 $b$ 值之间的第一性原理关系，推导出所需的表达式以：\n1. 根据参考样品的测量值确定梯度校准因子 $\\kappa$。\n2. 根据 $m_{\\text{eth}}$ 计算混合物中乙醇的校正后扩散系数 $D_{\\text{eth}}$。\n\n以 $\\mathrm{m^2\\,s^{-1}}$ 为单位表示乙醇的最终扩散系数，并将您的最终数值答案四舍五入到三位有效数字。最终答案必须是一个实数值。", "solution": "该问题要求推导用于确定梯度校准因子 $\\kappa$ 和乙醇扩散系数 $D_{\\text{eth}}$ 的表达式，然后计算 $D_{\\text{eth}}$。解题过程将从脉冲梯度自旋回波（PGSE）核磁共振的基本原理出发。\n\n在 PGSE 实验中，信号衰减 $S$ 作为梯度幅度 $g$ 的函数由下式给出：\n$$ \\frac{S}{S_0} = \\exp(-b D) $$\n其中 $S_0$ 是未施加梯度时的信号强度，$D$ 是分析物的扩散系数，$b$ 是“b 值”，它包含了实验参数。\n\n对于一个具有理想矩形梯度脉冲（持续时间为 $\\delta$、幅度为 $g$、间隔为 $\\Delta$）的序列，b 值由 Stejskal-Tanner 方程给出：\n$$ b(g) = \\gamma^2 g^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) $$\n其中 $\\gamma$ 是观测核的旋磁比。\n\n在本问题中，两个非理想性因素影响了梯度幅度。可编程梯度幅度 $g_{\\text{set}}$ 通过校准因子 $\\kappa$ 与实际施加的梯度 $g_{\\text{actual}}$ 相关：\n$$ g_{\\text{actual}} = \\kappa g_{\\text{set}} $$\n此外，涡流将有效梯度幅度减小了一个因子 $(1 - \\epsilon)$。因此，核自旋感受到的有效梯度幅度 $g_{\\text{eff}}$ 为：\n$$ g_{\\text{eff}} = g_{\\text{actual}} (1 - \\epsilon) = \\kappa (1 - \\epsilon) g_{\\text{set}} $$\n将 $g_{\\text{eff}}$ 代替 $g$ 入 Stejskal-Tanner 方程，得到真实的 b 值作为设定梯度幅度 $g_{\\text{set}}$ 的函数：\n$$ b(g_{\\text{set}}) = \\gamma^2 g_{\\text{eff}}^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) = \\gamma^2 \\left(\\kappa (1 - \\epsilon) g_{\\text{set}}\\right)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) $$\n$$ b(g_{\\text{set}}) = \\left[ \\gamma^2 \\kappa^2 (1 - \\epsilon)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) \\right] g_{\\text{set}}^2 $$\n现在，信号衰减方程可以写作：\n$$ \\ln\\left(\\frac{S}{S_0}\\right) = -b(g_{\\text{set}}) D = - \\left[ \\gamma^2 \\kappa^2 (1 - \\epsilon)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) D \\right] g_{\\text{set}}^2 $$\n实验测量了 $\\ln(S/S_0)$ 对 $g_{\\text{set}}^2$ 作图的斜率。我们称此斜率为 $m'$。根据上式，\n$$ m' = \\frac{\\mathrm{d}}{\\mathrm{d}(g_{\\text{set}}^2)} \\ln\\left(\\frac{S}{S_0}\\right) = - \\gamma^2 \\kappa^2 (1 - \\epsilon)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) D $$\n问题给出的测量斜率（$m_{\\text{ref}}$ 和 $m_{\\text{eth}}$）为正值，这是 DOSY 分析中的常见约定。这意味着报告的斜率 $m$ 是变化的绝对值，即 $m = -m'$。\n$$ m = \\gamma^2 \\kappa^2 (1 - \\epsilon)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) D $$\n这就是连接可观测量 $m$ 与物理参数的核心第一性原理关系。\n\n1.  确定梯度校准因子 $\\kappa$。\n    我们使用参考样品的测量数据。参考样品的斜率方程为：\n    $$ m_{\\text{ref}} = \\gamma^2 \\kappa^2 (1 - \\epsilon)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) D_{\\text{ref}} $$\n    为了确定 $\\kappa$，我们重排此表达式：\n    $$ \\kappa^2 = \\frac{m_{\\text{ref}}}{\\gamma^2 (1 - \\epsilon)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) D_{\\text{ref}}} $$\n    因此，$\\kappa$ 的表达式为：\n    $$ \\kappa = \\sqrt{\\frac{m_{\\text{ref}}}{\\gamma^2 (1 - \\epsilon)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) D_{\\text{ref}}}} $$\n    这是第一个需要推导的表达式。\n\n2.  计算校正后的扩散系数 $D_{\\text{eth}}$。\n    对乙醇样品的测量是在相同条件下进行的，因此同样的斜率方程适用：\n    $$ m_{\\text{eth}} = \\gamma^2 \\kappa^2 (1 - \\epsilon)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) D_{\\text{eth}} $$\n    整理以求解 $D_{\\text{eth}}$，我们得到：\n    $$ D_{\\text{eth}} = \\frac{m_{\\text{eth}}}{\\gamma^2 \\kappa^2 (1 - \\epsilon)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right)} $$\n    这是第二个需要推导的表达式。\n\n为了计算 $D_{\\text{eth}}$ 的数值，我们可以先计算 $\\kappa$ 并代入其值，或者我们可以组合这两个表达式。一种更直接且计算上更稳健的方法是取乙醇和参考样品两个斜率方程的比值：\n$$ \\frac{m_{\\text{eth}}}{m_{\\text{ref}}} = \\frac{\\gamma^2 \\kappa^2 (1 - \\epsilon)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) D_{\\text{eth}}}{\\gamma^2 \\kappa^2 (1 - \\epsilon)^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) D_{\\text{ref}}} $$\n所有的仪器参数（$\\gamma, \\kappa, \\epsilon, \\delta, \\Delta$）都消掉了，从而提供了一个简单的关系：\n$$ \\frac{m_{\\text{eth}}}{m_{\\text{ref}}} = \\frac{D_{\\text{eth}}}{D_{\\text{ref}}} $$\n由此，我们推导出计算 $D_{\\text{eth}}$ 的最终表达式：\n$$ D_{\\text{eth}} = D_{\\text{ref}} \\frac{m_{\\text{eth}}}{m_{\\text{ref}}} $$\n该表达式有效地利用参考样品的测量来校准整个实验，而无需显式计算中间参数 $\\kappa$。\n\n现在，我们代入给定的数值：\n-   $D_{\\text{ref}} = 2.30 \\times 10^{-9}\\,\\mathrm{m^2\\,s^{-1}}$\n-   $m_{\\text{ref}} = 40.0\\,\\mathrm{m^2\\,T^{-2}}$\n-   $m_{\\text{eth}} = 35.0\\,\\mathrm{m^2\\,T^{-2}}$\n\n$$ D_{\\text{eth}} = (2.30 \\times 10^{-9}\\,\\mathrm{m^2\\,s^{-1}}) \\times \\frac{35.0\\,\\mathrm{m^2\\,T^{-2}}}{40.0\\,\\mathrm{m^2\\,T^{-2}}} $$\n$$ D_{\\text{eth}} = (2.30 \\times 10^{-9}\\,\\mathrm{m^2\\,s^{-1}}) \\times 0.875 $$\n$$ D_{\\text{eth}} = 2.0125 \\times 10^{-9}\\,\\mathrm{m^2\\,s^{-1}} $$\n问题要求最终答案四舍五入到三位有效数字。\n$$ D_{\\text{eth}} \\approx 2.01 \\times 10^{-9}\\,\\mathrm{m^2\\,s^{-1}} $$", "answer": "$$\\boxed{2.01 \\times 10^{-9}}$$", "id": "3699340"}, {"introduction": "DOSY技术最强大的应用之一是分析化学成分复杂且谱峰严重重叠的混合物。当不同分子的信号在化学位移维度上无法区分时，我们可以利用它们在扩散维度上的差异。本练习 [@problem_id:3699346] 模拟了一个典型场景：两种物质的核磁共振信号重叠在一起，您需要利用它们在不同梯度强度下的信号衰减差异，计算出它们的摩尔浓度比。这个练习不仅能巩固您对Stejskal-Tanner方程的理解，还能展示DOSY在定量分析中的独特优势。", "problem": "采用质子核磁共振 (NMR) 的脉冲场梯度刺激回波 (PGSTE) 实验，对由两种有机溶质（物种A和物种B）组成的混合物进行扩散排序谱 (DOSY) 分析。脉冲场梯度 (PFG) 参数为：矩形梯度脉冲，持续时间 $ \\delta = 2.50 \\,\\mathrm{ms} $，由扩散延迟 $ \\Delta = 100.0 \\,\\mathrm{ms} $ 分隔。质子旋磁比为 $ \\gamma = 2.675 \\times 10^{8} \\,\\mathrm{rad\\,s^{-1}\\,T^{-1}} $。假设扩散为自由、各向同性的，并且没有对流。\n\n通过对未重叠共振峰的独立测量，确定了在 $ 298 \\,\\mathrm{K} $ 时，两种物质的自扩散系数分别为 $ D_{A} = 6.00 \\times 10^{-10} \\,\\mathrm{m^{2}\\,s^{-1}} $ 和 $ D_{B} = 1.20 \\times 10^{-10} \\,\\mathrm{m^{2}\\,s^{-1}} $。考虑一个单一的芳香族 $ ^{1}\\mathrm{H} $ 重叠共振峰，其信号由每个物种分子中恰好一个化学等价的质子贡献（即，物种A的一个质子和物种B的一个质子在相同的化学位移处共振）。假设两种物种的射频激发和检测灵敏度相同，并且纵向和横向弛豫效应在整个梯度列表中是相同且不变的。\n\n在三个梯度强度 $ g $ 下测得的重叠共振峰的回波振幅（已针对一致的接收器增益和采集进行归一化）如下：\n- 在 $ g = 0.10 \\,\\mathrm{T\\,m^{-1}} $ 时，观测到的振幅为 $ S(0.10) = 2.48064 $（任意归一化单位）。\n- 在 $ g = 0.20 \\,\\mathrm{T\\,m^{-1}} $ 时，观测到的振幅为 $ S(0.20) = 1.49806 $。\n- 在 $ g = 0.30 \\,\\mathrm{T\\,m^{-1}} $ 时，观测到的振幅为 $ S(0.30) = 0.801026 $。\n\n从自由布朗运动的微观描述（其中位移呈高斯分布，方差随时间线性增长）以及脉冲场梯度下自旋相位累积的定义出发，\n- 推导在由扩散延迟隔开的两个相同矩形梯度脉冲作用下，单一扩散物种的回波衰减函数形式（您可以假设梯度脉冲沿单一空间轴施加），\n- 然后将重叠共振峰的信号表达为两个不发生交换的物种贡献的叠加。\n\n使用您推导的表达式和所提供的数据，计算摩尔浓度比 $ c_{A}/c_{B} $。将最终比值表示为无单位的小数，并将答案四舍五入到三位有效数字。", "solution": "该问题要求完成两个主要任务：第一，推导脉冲场梯度刺激回波（PGSTE）实验中信号衰减的方程；第二，使用该方程从混合物中两种物质的重叠NMR信号中确定它们的摩尔浓度比。\n\n### 第1部分：回波衰减函数的推导\n\n我们首先考虑在磁场梯度存在下的单个自旋。自旋的拉莫尔频率与位置相关。对于沿 $z$ 轴施加的梯度 $g(t)$，位于位置 $z(t)$ 的自旋的频率偏移为 $\\Delta\\omega(t) = \\gamma g(t) z(t)$，其中 $\\gamma$ 是旋磁比。此自旋在时间 $T$ 内累积的相位为 $\\phi = \\int_0^T \\Delta\\omega(t) dt$。\n\nPGSTE序列使用两个强度为 $g$、持续时间为 $\\delta$ 的相同矩形梯度脉冲，它们之间由扩散时间 $\\Delta$ 隔开。由于回波形成的本质，第二个梯度脉冲期间累积的相位有效地从第一个梯度脉冲期间累积的相位中减去。等效的梯度波形可以表示为在时间间隔 $[0, \\delta]$ 内为 $+g$，在时间间隔 $[\\Delta, \\Delta+\\delta]$ 内为 $-g$。\n\n因此，遵循轨迹 $z(t)$ 的单个自旋的净累积相位为：\n$$\n\\phi = \\gamma g \\left( \\int_0^{\\delta} z(t) \\,dt - \\int_{\\Delta}^{\\Delta+\\delta} z(t) \\,dt \\right)\n$$\n观测到的NMR信号 $S$ 是样品中所有自旋的横向磁化强度的系综平均。对于每个自旋，信号贡献正比于 $\\exp(i\\phi)$。因此，总信号正比于系综平均 $\\langle \\exp(i\\phi) \\rangle$。\n$$\n\\frac{S(g)}{S(0)} = \\langle \\exp(i\\phi) \\rangle\n$$\n题目指出，我们必须从自由布朗运动的微观描述出发，其中位移是高斯分布的。由于 $z(t)$ 描述了一个高斯随机过程，作为不同时刻 $z(t)$ 的线性组合，相位 $\\phi$ 也是一个高斯随机变量。不失一般性地（通过考虑相对于质心的运动），平均位置 $\\langle z(t) \\rangle$ 可以取为零，因此平均相位 $\\langle \\phi \\rangle = 0$。\n\n对于一个零均值的高斯随机变量 $X$，其指数的期望值由 $\\langle \\exp(iX) \\rangle = \\exp(-\\langle X^2 \\rangle / 2)$ 给出。因此，信号衰减为：\n$$\n\\frac{S(g)}{S(0)} = \\exp\\left(-\\frac{1}{2}\\langle \\phi^2 \\rangle\\right)\n$$\n我们现在必须计算均方相位涨落 $\\langle \\phi^2 \\rangle$：\n$$\n\\langle \\phi^2 \\rangle = \\gamma^2 g^2 \\left\\langle \\left( \\int_0^\\delta z(t) \\,dt - \\int_\\Delta^{\\Delta+\\delta} z(t) \\,dt \\right)^2 \\right\\rangle\n$$\n展开平方项：\n$$\n\\langle \\phi^2 \\rangle = \\gamma^2 g^2 \\left[ \\left\\langle \\left(\\int_0^\\delta z(t) \\,dt\\right)^2 \\right\\rangle - 2\\left\\langle \\left(\\int_0^\\delta z(t) \\,dt\\right) \\left(\\int_\\Delta^{\\Delta+\\delta} z(t') \\,dt'\\right) \\right\\rangle + \\left\\langle \\left(\\int_\\Delta^{\\Delta+\\delta} z(t) \\,dt\\right)^2 \\right\\rangle \\right]\n$$\n这可以重写为二重积分：\n$$\n\\langle \\phi^2 \\rangle = \\gamma^2 g^2 \\left[ \\int_0^\\delta\\int_0^\\delta \\langle z(t)z(t') \\rangle \\,dt\\,dt' - 2\\int_0^\\delta\\int_\\Delta^{\\Delta+\\delta} \\langle z(t)z(t') \\rangle \\,dt\\,dt' + \\int_\\Delta^{\\Delta+\\delta}\\int_\\Delta^{\\Delta+\\delta} \\langle z(t)z(t') \\rangle \\,dt\\,dt' \\right]\n$$\n对于扩散系数为 $D$、从 $z(0) = 0$ 开始的自由一维布朗运动，时间相关函数为 $\\langle z(t)z(t') \\rangle = 2D \\min(t, t')$. 我们用它来计算这些积分。\n\n1.  第一项：\n    $$\n    \\int_0^\\delta\\int_0^\\delta 2D \\min(t, t') \\,dt\\,dt' = 2 \\int_0^\\delta \\left( \\int_0^t 2Dt' \\,dt' \\right) \\,dt = 4D \\int_0^\\delta \\frac{t^2}{2} \\,dt = 2D \\left[\\frac{t^3}{3}\\right]_0^\\delta = \\frac{2D\\delta^3}{3}\n    $$\n2.  第二项（交叉项）：对于 $t \\in [0, \\delta]$ 和 $t' \\in [\\Delta, \\Delta+\\delta]$，我们有 $t  t'$，因此 $\\min(t, t') = t$。\n    $$\n    -2 \\int_0^\\delta\\int_\\Delta^{\\Delta+\\delta} 2D t \\,dt'\\,dt = -4D \\int_0^\\delta t \\left( \\int_\\Delta^{\\Delta+\\delta} \\,dt' \\right) \\,dt = -4D \\int_0^\\delta t\\delta \\,dt = -4D\\delta \\left[\\frac{t^2}{2}\\right]_0^\\delta = -2D\\delta^3\n    $$\n3.  第三项：令 $u=t-\\Delta$ 和 $v=t'-\\Delta$。\n    $$\n    \\int_\\Delta^{\\Delta+\\delta}\\int_\\Delta^{\\Delta+\\delta} 2D \\min(t, t') \\,dt\\,dt' = \\int_0^\\delta\\int_0^\\delta 2D \\min(u+\\Delta, v+\\Delta) \\,du\\,dv\n    $$\n    由于 $\\min(u+\\Delta, v+\\Delta) = \\min(u,v)+\\Delta$：\n    $$\n    \\int_0^\\delta\\int_0^\\delta 2D(\\min(u,v)+\\Delta) \\,du\\,dv = \\int_0^\\delta\\int_0^\\delta 2D\\min(u,v) \\,du\\,dv + \\int_0^\\delta\\int_0^\\delta 2D\\Delta \\,du\\,dv = \\frac{2D\\delta^3}{3} + 2D\\Delta\\delta^2\n    $$\n合并这三项：\n$$\n\\langle \\phi^2 \\rangle = \\gamma^2 g^2 \\left( \\frac{2D\\delta^3}{3} - 2D\\delta^3 + \\frac{2D\\delta^3}{3} + 2D\\Delta\\delta^2 \\right) = \\gamma^2 g^2 \\left( 2D\\Delta\\delta^2 - \\frac{2D\\delta^3}{3} \\right)\n$$\n$$\n\\langle \\phi^2 \\rangle = 2 \\gamma^2 g^2 D \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right)\n$$\n最后，将此结果代入信号衰减的表达式中：\n$$\n\\frac{S(g)}{S(0)} = \\exp\\left[-\\frac{1}{2} \\left( 2 \\gamma^2 g^2 D \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) \\right) \\right] = \\exp\\left[-\\gamma^2 g^2 D \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right)\\right]\n$$\n这就是针对矩形梯度脉冲的著名的Stejskal-Tanner方程。\n\n### 第2部分：混合物分析\n\n重叠共振信号 $S(g)$ 是物种A和B信号的总和：\n$$\nS(g) = S_A(g) + S_B(g)\n$$\n对每个物种使用推导出的衰减公式：\n$$\nS(g) = S_{A,0} \\exp\\left(-K D_A g^2\\right) + S_{B,0} \\exp\\left(-K D_B g^2\\right)\n$$\n其中 $S_{A,0}$ 和 $S_{B,0}$ 是 $g=0$ 时的信号振幅，而 $K$ 是一个由实验参数决定的常数：\n$$\nK = \\gamma^2 \\delta^2 \\left(\\Delta - \\frac{\\delta}{3}\\right)\n$$\n题目说明，信号贡献来自于A和B每个分子中的一个质子，且激发和检测灵敏度相同。因此，$g=0$ 时的信号振幅与摩尔浓度 $c_A$ 和 $c_B$ 成正比。所求的比值为 $c_A/c_B = S_{A,0}/S_{B,0}$。\n\n对于未知数 $S_{A,0}$ 和 $S_{B,0}$，我们有一个线性方程组，数据在三个梯度强度下给出。我们可以使用任意两个数据点来求解该比值。我们使用前两个数据点（$i=1, 2$）。\n$$\nS(g_1) = S_{A,0} \\exp(-K D_A g_1^2) + S_{B,0} \\exp(-K D_B g_1^2)\n$$\n$$\nS(g_2) = S_{A,0} \\exp(-K D_A g_2^2) + S_{B,0} \\exp(-K D_B g_2^2)\n$$\n令 $R = S_{A,0}/S_{B,0}$，$a_i = \\exp(-K D_A g_i^2)$，以及 $b_i = \\exp(-K D_B g_i^2)$。\n$$\nS(g_1) = S_{B,0} (R a_1 + b_1)\n$$\n$$\nS(g_2) = S_{B,0} (R a_2 + b_2)\n$$\n将这两个方程相除可以消去 $S_{B,0}$：\n$$\n\\frac{S(g_1)}{S(g_2)} = \\frac{R a_1 + b_1}{R a_2 + b_2}\n$$\n求解 $R$：\n$$\nS(g_1)(R a_2 + b_2) = S(g_2)(R a_1 + b_1)\n$$\n$$\nR (S(g_1) a_2 - S(g_2) a_1) = S(g_2) b_1 - S(g_1) b_2\n$$\n$$\nR = \\frac{c_A}{c_B} = \\frac{S(g_2) b_1 - S(g_1) b_2}{S(g_1) a_2 - S(g_2) a_1}\n$$\n\n### 第3部分：计算\n\n首先，我们计算常数 $K$。\n已知：$\\gamma = 2.675 \\times 10^{8} \\,\\mathrm{rad\\,s^{-1}\\,T^{-1}}$，$\\delta = 2.50 \\times 10^{-3} \\,\\mathrm{s}$，$\\Delta = 100.0 \\times 10^{-3} \\,\\mathrm{s}$。\n$$\n\\Delta - \\frac{\\delta}{3} = 1.000 \\times 10^{-1} - \\frac{2.50 \\times 10^{-3}}{3} = (0.1 - 0.0008333...) \\,\\mathrm{s} \\approx 0.0991667 \\,\\mathrm{s}\n$$\n这等于 $\\frac{0.3 - 0.0025}{3} = \\frac{0.2975}{3}\\,\\mathrm{s}$。\n$$\nK = (2.675 \\times 10^{8})^2 (2.50 \\times 10^{-3})^2 \\left( \\frac{0.2975}{3} \\right) \\approx 4.435594 \\times 10^{10} \\,\\mathrm{s\\,T^{-2}}\n$$\n接下来，我们计算指数项 $\\alpha_A = K D_A$ 和 $\\alpha_B = K D_B$。\n已知：$D_A = 6.00 \\times 10^{-10} \\,\\mathrm{m^2\\,s^{-1}}$，$D_B = 1.20 \\times 10^{-10} \\,\\mathrm{m^2\\,s^{-1}}$。\n$$\n\\alpha_A = (4.435594 \\times 10^{10}) \\times (6.00 \\times 10^{-10}) \\approx 26.61356 \\,\\mathrm{m^2\\,T^{-2}}\n$$\n$$\n\\alpha_B = (4.435594 \\times 10^{10}) \\times (1.20 \\times 10^{-10}) \\approx 5.32271 \\,\\mathrm{m^2\\,T^{-2}}\n$$\n现在我们计算 $g_1 = 0.10 \\,\\mathrm{T\\,m^{-1}}$（$g_1^2 = 0.01$）和 $g_2 = 0.20 \\,\\mathrm{T\\,m^{-1}}$（$g_2^2 = 0.04$）时的衰减因子 $a_i$ 和 $b_i$。\n$$\na_1 = \\exp(-\\alpha_A g_1^2) = \\exp(-26.61356 \\times 0.01) = \\exp(-0.2661356) \\approx 0.766320\n$$\n$$\nb_1 = \\exp(-\\alpha_B g_1^2) = \\exp(-5.32271 \\times 0.01) = \\exp(-0.0532271) \\approx 0.948164\n$$\n$$\na_2 = \\exp(-\\alpha_A g_2^2) = \\exp(-26.61356 \\times 0.04) = \\exp(-1.0645424) \\approx 0.344884\n$$\n$$\nb_2 = \\exp(-\\alpha_B g_2^2) = \\exp(-5.32271 \\times 0.04) = \\exp(-0.2129084) \\approx 0.808228\n$$\n信号数据为 $S(g_1) = 2.48064$ 和 $S(g_2) = 1.49806$。现在我们将这些值代入 $R$ 的表达式中。\n\n分子：$S(g_2) b_1 - S(g_1) b_2 = (1.49806)(0.948164) - (2.48064)(0.808228) \\approx 1.420444 - 2.004928 = -0.584484$\n分母：$S(g_1) a_2 - S(g_2) a_1 = (2.48064)(0.344884) - (1.49806)(0.766320) \\approx 0.855734 - 1.147988 = -0.292254$\n$$\nR = \\frac{-0.584484}{-0.292254} \\approx 1.9999\n$$\n摩尔浓度比 $c_A/c_B$ 约等于 $1.9999$。四舍五入到三位有效数字，该比值为 $2.00$。", "answer": "$$\\boxed{2.00}$$", "id": "3699346"}, {"introduction": "对于含有多个组分的复杂体系，手动求解方程组变得不切实际，我们需要更强大的自动化分析工具。现代DOSY数据处理通常依赖于计算方法来求解所谓的“逆问题”，即从衰减信号中反演出扩散系数的分布。本编程练习 [@problem_id:3699327] 将引导您实现一种核心的多变量分析方法——非负最小二乘法（NNLS），以解析含有重叠信号的复杂混合物的DOSY数据。通过这个实践，您将掌握将DOSY数据处理构建为逆拉普拉斯变换问题的思想，并获得解决这类问题的实际编程经验。", "problem": "一个研究实验室使用核磁共振（NMR）中的扩散排序谱（DOSY）技术来表征产生严重重叠谱信号的小有机分子混合物。在脉冲场梯度下，扩散的自旋会累积随机相位，其系综平均会使测得的横向磁化强度衰减。从 Bloch–Torrey 方程和布朗运动出发，推导在采用矩形梯度脉冲的脉冲场梯度自旋回波序列中，信号衰减对自由平移扩散系数 $D$ 和梯度波形的函数依赖关系。然后，对于一个包含 $K$ 种化学上不同组分的混合物，将一组梯度编码下的多指数衰减模型形式化为一个数据矩阵的双线性分解，其中矩阵的列代表不同的谱变量（例如，频率单元），行代表梯度编码。你的推导必须从扩散作为高斯随机过程的基本定义（均方位移为 $\\langle r^2 \\rangle = 6 D t$）、磁场梯度下的相位累积，以及 Bloch–Torrey 方程在空间变化场下的线性性质开始。\n\n你的任务是实现一种多元方法，用于从模拟的 DOSY 测量数据中估计具有重叠信号的混合物中各组分的扩散系数 $D$。你必须在 $D$ 上使用一个非参数基（一个在对数网格上的候选 $D$ 值字典），并在每个谱变量上独立求解一个非负最小二乘（NNLS）问题以获得非负系数权重，然后跨谱变量进行聚合以恢复全局扩散剖面，并选择 $K$ 个最显著的扩散率。你可以选择性地使用奇异值分解（SVD）来推断秩，但核心数值步骤必须是针对非负指数字典的 NNLS。所有估计值必须以 $\\mathrm{m^2 s^{-1}}$ 为单位表示，并四舍五入到三位有效数字。\n\n用于生成测试用合成测量数据的正向模型应按如下方式推导。考虑一个脉冲场梯度自旋回波，其具有两个相同的矩形梯度脉冲，脉冲幅度为 $g$（单位 $\\mathrm{T\\, m^{-1}}$），持续时间为 $\\delta$（单位 $\\mathrm{s}$），由一个扩散时间 $\\Delta$（单位 $\\mathrm{s}$）分隔。设旋磁比为 $\\gamma$（单位 $\\mathrm{rad\\, s^{-1}\\, T^{-1}}$）。对于一个扩散系数为 $D$（单位 $\\mathrm{m^2\\, s^{-1}}$）的组分，通过将布朗运动的高斯位移统计与梯度下的相位累积以及磁化演化的线性性质相结合，可以获得作为梯度幅度序列函数的系综平均回波衰减。利用这一点，为每个组分构建一个衰减因子，该因子是依赖于 $\\gamma$、$g$、$\\delta$、$\\Delta$ 和 $D$ 的编码参数的函数。对于一个具有 $K$ 个组分且在谱变量索引 $j$ 处具有非负谱振幅 $s_{k j}$ 的混合物，在编码索引 $i$ 和谱变量索引 $j$ 处的测量数据是各组分的叠加。添加具有指定标准差的零均值高斯噪声以模拟实验噪声。所有合成数据必须由你的程序使用这些物理上一致的定义进行数值生成。\n\n测试套件。你的程序必须使用物理推导的衰减模型，通过合成 DOSY 数据矩阵来生成三个独立的测试用例，参数集如下。在每个用例中，除非明确指明为数组或矩阵，否则所有量均为标量。\n\n- 用例 1（扩散率分离良好，中度重叠）：\n  - 旋磁比 $\\gamma = 2.6752218744 \\times 10^{8}\\ \\mathrm{rad\\, s^{-1}\\, T^{-1}}$。\n  - 梯度脉冲持续时间 $\\delta = 3.2 \\times 10^{-3}\\ \\mathrm{s}$。\n  - 扩散时间 $\\Delta = 4.8 \\times 10^{-2}\\ \\mathrm{s}$。\n  - 梯度幅度 $g$（单位 $\\mathrm{T\\, m^{-1}}$）：$\\{0.05, 0.08, 0.11, 0.14, 0.17, 0.20, 0.23, 0.26, 0.29, 0.32, 0.35, 0.38\\}$。\n  - 真实扩散系数 $D_\\text{true}$（单位 $\\mathrm{m^2\\, s^{-1}}$）：$\\{1.20 \\times 10^{-9}, 3.50 \\times 10^{-10}\\}$，其中 $K=2$。\n  - 非负谱振幅矩阵 $S \\in \\mathbb{R}_{\\ge 0}^{K \\times J}$，其中 $J=3$：\n    - 行 1：$\\{1.0, 0.5, 0.0\\}$。\n    - 行 2：$\\{0.3, 0.9, 1.0\\}$。\n  - 加性噪声：零均值高斯噪声，标准差 $\\sigma = 1.0 \\times 10^{-2}$（相对于单位振幅）。\n- 用例 2（扩散率相近，严重重叠）：\n  - 旋磁比 $\\gamma = 2.6752218744 \\times 10^{8}\\ \\mathrm{rad\\, s^{-1}\\, T^{-1}}$。\n  - 梯度脉冲持续时间 $\\delta = 2.8 \\times 10^{-3}\\ \\mathrm{s}$。\n  - 扩散时间 $\\Delta = 4.0 \\times 10^{-2}\\ \\mathrm{s}$。\n  - 梯度幅度 $g$（单位 $\\mathrm{T\\, m^{-1}}$）：$\\{0.06, 0.09, 0.12, 0.15, 0.18, 0.21, 0.24, 0.27, 0.30, 0.33\\}$。\n  - 真实扩散系数 $D_\\text{true}$（单位 $\\mathrm{m^2\\, s^{-1}}$）：$\\{8.00 \\times 10^{-10}, 6.50 \\times 10^{-10}\\}$，其中 $K=2$。\n  - 非负谱振幅矩阵 $S \\in \\mathbb{R}_{\\ge 0}^{K \\times J}$，其中 $J=4$：\n    - 行 1：$\\{0.6, 0.7, 0.5, 0.0\\}$。\n    - 行 2：$\\{0.5, 0.6, 0.7, 1.0\\}$。\n  - 加性噪声：零均值高斯噪声，标准差 $\\sigma = 2.0 \\times 10^{-2}$（相对于单位振幅）。\n- 用例 3（单组分，最小重叠）：\n  - 旋磁比 $\\gamma = 2.6752218744 \\times 10^{8}\\ \\mathrm{rad\\, s^{-1}\\, T^{-1}}$。\n  - 梯度脉冲持续时间 $\\delta = 3.0 \\times 10^{-3}\\ \\mathrm{s}$。\n  - 扩散时间 $\\Delta = 6.0 \\times 10^{-2}\\ \\mathrm{s}$。\n  - 梯度幅度 $g$（单位 $\\mathrm{T\\, m^{-1}}$）：$\\{0.05, 0.10, 0.15, 0.20, 0.25, 0.30, 0.35, 0.40\\}$。\n  - 真实扩散系数 $D_\\text{true}$（单位 $\\mathrm{m^2\\, s^{-1}}$）：$\\{2.50 \\times 10^{-10}\\}$，其中 $K=1$。\n  - 非负谱振幅矩阵 $S \\in \\mathbb{R}_{\\ge 0}^{K \\times J}$，其中 $J=2$：\n    - 行 1：$\\{1.2, 0.7\\}$。\n  - 加性噪声：零均值高斯噪声，标准差 $\\sigma = 5.0 \\times 10^{-3}$（相对于单位振幅）。\n\n算法要求和输出规范：\n- 构建一个包含 $N_D$ 个扩散系数的对数间隔候选网格 $D_\\mathrm{grid}$，该网格至少覆盖区间 $[1.0 \\times 10^{-10}, 2.0 \\times 10^{-9}]$（单位 $\\mathrm{m^2\\, s^{-1}}$），且 $N_D \\ge 200$。\n- 对于每个用例，使用在 $D_\\mathrm{grid}$ 上求值的物理推导衰减函数，构建编码上的指数字典，并在每个谱变量处求解 NNLS 问题，以获得 $D_\\mathrm{grid}$ 上的非负权重向量。跨谱变量聚合权重以形成全局扩散剖面，并通过在网格上进行非极大值抑制来选择 $K$ 个最显著的扩散系数。可选地，通过对相邻网格点的局部加权质心来精炼每个选定的系数。\n- 对于每个用例，返回 $K$ 个估计扩散系数的列表，按升序排列，以 $\\mathrm{m^2\\, s^{-1}}$ 为单位表示，并四舍五入到三位有效数字。\n\n你的程序应生成单行输出，其中包含结果，格式为由逗号分隔的三个方括号列表，每个用例一个列表，严格遵循以下格式：“[[case1_estimates],[case2_estimates],[case3_estimates]]”。每个内部列表必须包含 $K$ 个浮点数，采用科学记数法，并四舍五入到三位有效数字（例如，$1.20\\mathrm{e}{-9}$ 应打印为 \"1.20e-09\"）。", "solution": "### 基于原理的设计\n\n#### 1. 脉冲梯度自旋回波（PGSE）信号衰减的推导\n\nDOSY 的核心原理是在存在磁场梯度的情况下，测量由分子平移运动引起的信号衰减。该实验依赖于通过相移对核自旋的空间位置进行编码，然后在扩散时间后对其进行解码。在此期间的任何净位移都会导致不完全的相位重聚焦，从而造成信号损失。\n\n在随时间变化的磁场梯度 $\\mathbf{G}(t)$ 下，位于位置 $\\mathbf{r}(t)$ 且旋磁比为 $\\gamma$ 的核自旋所累积的相位 $\\phi$ 由在实验持续时间 $T_E$ 内的积分给出：\n$$\n\\phi = \\int_0^{T_E} \\gamma \\mathbf{G}(t) \\cdot \\mathbf{r}(t) dt\n$$\n测量的信号是样品体积内所有自旋的横向磁化强度的系综平均。对于进行布朗运动的自旋，其位置 $\\mathbf{r}(t)$ 是随机变量。假设初始相位为零，信号衰减 $A$ 由系综平均给出：\n$$\nA = \\left\\langle e^{i\\phi} \\right\\rangle\n$$\n对于一个 PGSE 序列，它有两个幅度为 $g$、持续时间为 $\\delta$、沿 z 轴方向的矩形梯度脉冲，并由一个允许扩散的时间间隔分开，其有效梯度剖面考虑了一个反转相位演化的 $180^\\circ$ 射频脉冲。自旋累积的净相位是其在扩散期间沿 z 轴位移的函数。\n\n相位 $\\phi$ 是一个随机变量，对于像扩散这样的高斯过程，它服从均值为零（$\\langle \\phi \\rangle = 0$）的高斯分布。信号衰减简化为：\n$$\nA = e^{-\\frac{1}{2}\\langle \\phi^2 \\rangle}\n$$\n通过对扩散粒子的随机路径进行积分来计算 PGSE 序列的均方相位 $\\langle \\phi^2 \\rangle$ 是核磁共振理论中的一个标准结果。它产生了 Stejskal-Tanner 方程：\n$$\nA(g) = \\exp \\left( -(\\gamma g \\delta)^2 \\left(\\Delta - \\frac{\\delta}{3}\\right) D \\right)\n$$\n此处，$D$ 是平移扩散系数，$\\Delta$ 是扩散时间（两个梯度脉冲前沿之间的时间），而项 $(\\Delta - \\delta/3)$ 是有效扩散时间，它考虑了在有限持续时间的梯度脉冲期间的运动。\n\n为方便起见，我们为每个梯度幅度 $g_i$ 定义一个单一的编码参数 $b_i$：\n$$\nb_i = (\\gamma g_i \\delta)^2 \\left(\\Delta - \\frac{\\delta}{3}\\right)\n$$\n对于扩散系数为 $D$ 的单一分子种类，其衰减是一个简单的指数衰减：\n$$\nA(g_i) = e^{-b_i D}\n$$\n\n#### 2. 混合物分析与双线性分解\n\n对于一个包含 $K$ 个化学上不同组分的混合物，每个组分都有其自身的扩散系数 $D_k$ 和谱特征，观测到的总信号是来自每个组分信号的线性叠加。设 $Y \\in \\mathbb{R}^{M \\times J}$ 为数据矩阵，其中 $M$ 是梯度步数（编码数），$J$ 是谱变量数（例如，频率单元数）。设 $S \\in \\mathbb{R}_{\\ge 0}^{K \\times J}$ 为非负谱振幅矩阵，其中 $S_{kj}$ 是组分 $k$ 在谱变量 $j$ 处的振幅。\n\n在编码 $i$ 和谱变量 $j$ 处的信号，记为 $Y_{ij}$，模型如下：\n$$\nY_{ij} = \\sum_{k=1}^K S_{kj} e^{-b_i D_k} + E_{ij}\n$$\n其中 $E_{ij}$ 代表加性噪声。该方程描述了一个双线性模型。我们可以用矩阵形式表示。设 $A \\in \\mathbb{R}^{M \\times K}$ 是依赖于扩散的衰减因子矩阵，其元素为 $A_{ik} = e^{-b_i D_k}$。数据矩阵可以写为：\n$$\nY = A S + E\n$$\n这就是数据矩阵 $Y$ 分解为一个扩散衰减矩阵 $A$ 和一个组分谱矩阵 $S$ 的双线性分解，正如所要求的那样。\n\n#### 3. 通过非负最小二乘（NNLS）进行数值反演\n\n反问题是从测量的数据矩阵 $Y$ 中估计扩散系数 $\\{D_k\\}_{k=1}^K$。这是一个拉普拉斯逆变换的实例，而该问题是出了名的不适定。一个正则化此问题的稳健方法是离散化扩散系数域。\n\n我们定义一个包含 $N_D$ 个候选扩散系数的网格，$D_\\text{grid} = \\{D_l\\}_{l=1}^{N_D}$，通常在一个合理的范围内对数间隔分布。对于每个谱变量 $j$（$Y$ 的每一列），我们将信号衰减 $\\mathbf{y}_j \\in \\mathbb{R}^M$ 建模为与字典 $D_\\text{grid}$ 相对应的指数衰减的线性组合：\n$$\n\\mathbf{y}_j = \\mathcal{A} \\mathbf{c}_j + \\mathbf{e}_j\n$$\n此处，$\\mathcal{A} \\in \\mathbb{R}^{M \\times N_D}$ 是字典或基矩阵，其元素为 $\\mathcal{A}_{il} = e^{-b_i D_l}$，而 $\\mathbf{c}_j \\in \\mathbb{R}_{\\ge 0}^{N_D}$ 是谱通道 $j$ 的非负系数（或权重）向量。每个元素 $c_{lj}$ 代表具有扩散系数 $D_l$ 的组分对谱变量 $j$ 处信号的贡献。\n\n系数的非负性在物理上是合理的，因为谱振幅不能为负。我们通过最小化残差的 L2 范数平方，并在非负性约束下，为每个谱变量 $j$ 求解系数向量 $\\mathbf{c}_j$。这就是非负最小二乘（NNLS）问题：\n$$\n\\min_{\\mathbf{c}_j \\ge 0} || \\mathbf{y}_j - \\mathcal{A} \\mathbf{c}_j ||_2^2\n$$\n此操作对数据矩阵 $Y$ 的每一列独立执行。\n\n#### 4. 扩散系数的估计\n\n在求解系数矩阵 $C \\in \\mathbb{R}^{N_D \\times J}$（其列为向量 $\\mathbf{c}_j$）之后，我们通过将所有谱变量的系数相加，得到一个全局扩散剖面，或称“扩散谱”（diffusogram）：\n$$\n\\mathbf{c}_\\text{total} = \\sum_{j=1}^{J} \\mathbf{c}_j\n$$\n向量 $\\mathbf{c}_\\text{total} \\in \\mathbb{R}_{\\ge 0}^{N_D}$ 代表整个混合物的扩散系数分布。此向量中的峰值对应于样品中存在的组分的扩散系数。\n\n为了识别 $K$ 个扩散系数，我们执行以下步骤：\n1.  **峰值检测**：沿 $D_\\text{grid}$ 识别 $\\mathbf{c}_\\text{total}$ 中的所有局部最大值。\n2.  **峰值选择**：选择 $K$ 个最显著的峰，即在 $\\mathbf{c}_\\text{total}$ 中振幅最大的那些峰。\n3.  **精炼**：对于在网格索引 $p$ 处选定的每个峰，通过在一个小的相邻网格点窗口上计算局部加权质心来精炼估计的 $D$ 值。如果窗口是 $[p-w, p+w]$，则精炼后的估计值 $D_{k, \\text{est}}$ 为：\n    $$\n    D_{k, \\text{est}} = \\frac{\\sum_{l=p-w}^{p+w} c_{\\text{total},l} \\cdot D_{\\text{grid},l}}{\\sum_{l=p-w}^{p+w} c_{\\text{total},l}}\n    $$\n这个精炼步骤提高了估计的准确性，使其超越了网格的离散化限制。最终得到的 $K$ 个精炼扩散系数集合构成了单个测试用例的解。", "answer": "```python\nimport numpy as np\nfrom scipy.optimize import nnls\nfrom scipy.signal import find_peaks\n\ndef solve():\n    \"\"\"\n    Solves for diffusion coefficients from simulated DOSY NMR data.\n\n    The function processes three predefined test cases. For each case, it:\n    1. Synthesizes a noisy DOSY data matrix based on the Stejskal-Tanner equation.\n    2. Constructs a dictionary of exponential decays over a logarithmic grid of\n       candidate diffusion coefficients.\n    3. Solves a Non-Negative Least Squares (NNLS) problem for each spectral\n       variable to find the distribution of diffusion coefficients.\n    4. Aggregates the results into a global diffusion profile.\n    5. Identifies the K most prominent diffusion coefficients by finding the K\n       strongest peaks in the profile.\n    6. Refines each estimate using a local center-of-mass calculation.\n    7. Collects and formats the results according to the problem specification.\n    \"\"\"\n    # Case definitions\n    test_cases = [\n        {\n            # Case 1: well-separated diffusivities, moderate overlap\n            \"gamma\": 2.6752218744e8,\n            \"delta\": 3.2e-3,\n            \"Delta\": 4.8e-2,\n            \"g\": np.array([0.05, 0.08, 0.11, 0.14, 0.17, 0.20, 0.23, 0.26, 0.29, 0.32, 0.35, 0.38]),\n            \"D_true\": np.array([1.20e-9, 3.50e-10]),\n            \"K\": 2,\n            \"S\": np.array([[1.0, 0.5, 0.0], [0.3, 0.9, 1.0]]),\n            \"noise_sigma\": 1.0e-2\n        },\n        {\n            # Case 2: closely spaced diffusivities, severe overlap\n            \"gamma\": 2.6752218744e8,\n            \"delta\": 2.8e-3,\n            \"Delta\": 4.0e-2,\n            \"g\": np.array([0.06, 0.09, 0.12, 0.15, 0.18, 0.21, 0.24, 0.27, 0.30, 0.33]),\n            \"D_true\": np.array([8.00e-10, 6.50e-10]),\n            \"K\": 2,\n            \"S\": np.array([[0.6, 0.7, 0.5, 0.0], [0.5, 0.6, 0.7, 1.0]]),\n            \"noise_sigma\": 2.0e-2\n        },\n        {\n            # Case 3: single component, minimal overlap\n            \"gamma\": 2.6752218744e8,\n            \"delta\": 3.0e-3,\n            \"Delta\": 6.0e-2,\n            \"g\": np.array([0.05, 0.10, 0.15, 0.20, 0.25, 0.30, 0.35, 0.40]),\n            \"D_true\": np.array([2.50e-10]),\n            \"K\": 1,\n            \"S\": np.array([[1.2, 0.7]]),\n            \"noise_sigma\": 5.0e-3\n        }\n    ]\n\n    all_results = []\n    \n    # Define the non-parametric basis for diffusion coefficients\n    N_D = 256\n    D_grid = np.logspace(np.log10(1.0e-10), np.log10(2.0e-9), N_D)\n\n    for case in test_cases:\n        gamma = case[\"gamma\"]\n        delta = case[\"delta\"]\n        Delta = case[\"Delta\"]\n        g_array = case[\"g\"]\n        D_true = case[\"D_true\"]\n        K = case[\"K\"]\n        S = case[\"S\"]\n        sigma = case[\"noise_sigma\"]\n\n        # 1. Generate Synthetic Data\n        # Calculate b-values based on the Stejskal-Tanner equation\n        b_values = (gamma * g_array * delta)**2 * (Delta - delta / 3.0)\n\n        # Reshape for broadcasting\n        b_col = b_values[:, np.newaxis]\n        D_row = D_true[np.newaxis, :]\n        \n        # Attenuation matrix A (M x K)\n        A_true = np.exp(-b_col * D_row)\n        \n        # Noiseless data matrix Y = A * S (M x J)\n        Y_noiseless = A_true @ S\n\n        # Add zero-mean Gaussian noise\n        noise = np.random.normal(0, sigma, Y_noiseless.shape)\n        Y_noisy = Y_noiseless + noise\n\n        # 2. Set up the Inverse Problem\n        # Dictionary matrix A_dict (M x N_D)\n        A_dict = np.exp(-b_col * D_grid[np.newaxis, :])\n\n        # 3. Solve NNLS and Aggregate\n        J = S.shape[1] # Number of spectral variables\n        C_matrix = np.zeros((N_D, J))\n        \n        for j in range(J):\n            y_j = Y_noisy[:, j]\n            # Ensure data is non-negative before NNLS, as negative values are unphysical\n            y_j[y_j  0] = 0\n            c_j, _ = nnls(A_dict, y_j)\n            C_matrix[:, j] = c_j\n\n        # Aggregate to form global diffusion profile\n        c_total = np.sum(C_matrix, axis=1)\n\n        # 4. Peak Picking and Refinement\n        # Find all peaks in the total coefficient vector\n        peak_indices, _ = find_peaks(c_total, prominence=c_total.max()*0.01) # Use small prominence to catch all relevant peaks\n\n        if len(peak_indices)  K:\n            # If not enough peaks found, take the indices with highest values\n            peak_indices = np.argsort(c_total)[-K:]\n        else:\n            # Select K most prominent peaks\n            peak_heights = c_total[peak_indices]\n            top_k_peak_indices = np.argsort(peak_heights)[-K:]\n            peak_indices = peak_indices[top_k_peak_indices]\n        \n        # Refine estimates using a local center-of-mass (3-point window)\n        estimated_D = []\n        refinement_window_half_width = 1\n        for p_idx in peak_indices:\n            start = max(0, p_idx - refinement_window_half_width)\n            end = min(N_D, p_idx + refinement_window_half_width + 1)\n            \n            window_coeffs = c_total[start:end]\n            window_D_values = D_grid[start:end]\n            \n            numerator = np.sum(window_coeffs * window_D_values)\n            denominator = np.sum(window_coeffs)\n            \n            if denominator  0:\n                refined_d = numerator / denominator\n                estimated_D.append(refined_d)\n            else: # Fallback to grid value if window coefficients are all zero\n                estimated_D.append(D_grid[p_idx])\n\n        # 5. Format Results\n        estimated_D.sort()\n        \n        # Format to 3 significant figures in scientific notation\n        formatted_results = [f\"{d:.2e}\" for d in estimated_D]\n        all_results.append(f\"[{','.join(formatted_results)}]\")\n\n    # Final print statement in the exact required format\n    print(f\"[{','.join(all_results)}]\")\n\nif __name__ == \"__main__\":\n    # Ensure deterministic results for reproducibility\n    np.random.seed(42)\n    solve()\n```", "id": "3699327"}]}