{"hands_on_practices": [{"introduction": "在构建近似黎曼求解器之前，我们必须首先理解欧拉方程的基本波结构。本练习 ([@problem_id:3291767]) 将引导你推导特征波速和黎曼不变量，它们构成了可压缩流中信息传播方式的理论基础。掌握这一分析是设计和理解数值求解器的第一步。", "problem": "考虑一个热力学和量热学上的理想气体的一维、无粘、可压缩流动，该流动由以原始变量 $(\\rho,u,p)$ 表示的欧拉方程控制，其中 $\\rho$ 是密度， $u$ 是速度， $p$ 是压力。在计算流体动力学（CFD）中使用的近似黎曼求解器（例如 Harten–Lax–van Leer with Contact (HLLC) 求解器）的背景下，欧拉方程的通量雅可比矩阵的特征结构决定了波速以及沿这些波传播的特征变量。\n\n从欧拉方程和理想气体的基本热力学关系出发，推导声波速度以及等熵族的相关特征变量（黎曼不变量）。然后，对于数值状态\n$$\n\\rho = 1.2\\ \\text{kg m}^{-3},\\quad u = 120\\ \\text{m s}^{-1},\\quad p = 101325\\ \\text{Pa},\\quad \\gamma = 1.4,\n$$\n计算声速并验证严格双曲性排序 $u-c  u  u+c$。使用推导出的对应于左行和右行声波族的特征变量，计算量\n$$\nJ \\equiv w_{+} - w_{-},\n$$\n其中，对于理想气体，$w_{+}$ 和 $w_{-}$ 分别是与右行和左行声波相关的黎曼不变量。\n\n将您的 $J$ 的最终数值以 $\\text{m s}^{-1}$ 为单位表示，并将答案四舍五入到四位有效数字。", "solution": "该问题要求推导一维欧拉方程的声波速度和黎曼不变量，然后对给定状态进行数值计算。\n\n对于无粘、可压缩流动，以原始变量 $\\mathbf{W} = (\\rho, u, p)^T$ 表示的一维欧拉方程为：\n$$\n\\frac{\\partial \\rho}{\\partial t} + \\frac{\\partial (\\rho u)}{\\partial x} = 0 \\quad (\\text{连续性方程})\n$$\n$$\n\\frac{\\partial u}{\\partial t} + u \\frac{\\partial u}{\\partial x} + \\frac{1}{\\rho}\\frac{\\partial p}{\\partial x} = 0 \\quad (\\text{动量方程})\n$$\n$$\n\\frac{\\partial p}{\\partial t} + u \\frac{\\partial p}{\\partial x} + \\gamma p \\frac{\\partial u}{\\partial x} = 0 \\quad (\\text{能量方程})\n$$\n这种形式的能量方程是在量热学理想气体的假设下，从能量守恒和连续性方程推导出来的。\n\n我们将此系统写成准线性形式 $\\frac{\\partial \\mathbf{W}}{\\partial t} + \\mathbf{A}(\\mathbf{W}) \\frac{\\partial \\mathbf{W}}{\\partial x} = \\mathbf{0}$。通过将连续性方程展开为 $\\frac{\\partial \\rho}{\\partial t} + u\\frac{\\partial \\rho}{\\partial x} + \\rho\\frac{\\partial u}{\\partial x} = 0$，我们可以确定通量雅可比矩阵 $\\mathbf{A}$：\n$$\n\\mathbf{A} = \\begin{pmatrix} u  \\rho  0 \\\\ 0  u  \\frac{1}{\\rho} \\\\ 0  \\gamma p  u \\end{pmatrix}\n$$\n系统的波速是矩阵 $\\mathbf{A}$ 的特征值 $\\lambda$。它们通过求解特征方程 $\\det(\\mathbf{A} - \\lambda \\mathbf{I}) = 0$ 得到：\n$$\n\\det \\begin{pmatrix} u - \\lambda  \\rho  0 \\\\ 0  u - \\lambda  \\frac{1}{\\rho} \\\\ 0  \\gamma p  u - \\lambda \\end{pmatrix} = 0\n$$\n沿第一列展开行列式可得：\n$$\n(u - \\lambda) \\left[ (u - \\lambda)^2 - (\\gamma p)\\left(\\frac{1}{\\rho}\\right) \\right] = 0\n$$\n引入声速平方的定义 $c^2 = \\frac{\\gamma p}{\\rho}$，我们有：\n$$\n(u - \\lambda) \\left[ (u - \\lambda)^2 - c^2 \\right] = 0\n$$\n这产生了三个不同的实特征值，从而证实了欧拉方程的双曲性：\n$$\n\\lambda_1 = u - c \\quad (\\text{左行声波})\n$$\n$$\n\\lambda_2 = u \\quad (\\text{接触/熵波})\n$$\n$$\n\\lambda_3 = u + c \\quad (\\text{右行声波})\n$$\n问题要求的是声波速度，即 $\\lambda_1 = u - c$ 和 $\\lambda_3 = u + c$。\n\n接下来，我们推导黎曼不变量。这些量是沿着由 $\\frac{dx}{dt} = \\lambda$ 定义的特征曲线保持不变的量。特征变量由 $\\mathbf{A}$ 的左特征向量 $\\mathbf{l}_k^T$ 确定，它们满足 $\\mathbf{l}_k^T \\mathbf{A} = \\lambda_k \\mathbf{l}_k^T$。这导致了沿特征线的特征相容性方程 $\\mathbf{l}_k^T d\\mathbf{W} = 0$。\n\n设 $\\mathbf{l}^T = (l_1, l_2, l_3)$。左特征向量方程为 $\\mathbf{l}^T(\\mathbf{A} - \\lambda \\mathbf{I}) = \\mathbf{0}^T$：\n$$\n(l_1, l_2, l_3) \\begin{pmatrix} u - \\lambda  \\rho  0 \\\\ 0  u - \\lambda  \\frac{1}{\\rho} \\\\ 0  \\gamma p  u - \\lambda \\end{pmatrix} = (0, 0, 0)\n$$\n这给出了方程组：\n1. $l_1(u - \\lambda) = 0$\n2. $l_1 \\rho + l_2(u - \\lambda) + l_3 \\gamma p = 0$\n3. $l_2 \\frac{1}{\\rho} + l_3(u - \\lambda) = 0$\n\n对于声波，$\\lambda = u \\pm c$，所以 $u - \\lambda = \\mp c \\neq 0$。\n从方程（1）可知，$l_1(\\mp c) = 0$，这意味着 $l_1 = 0$。\n方程组简化为：\n2. $l_2(\\mp c) + l_3 \\gamma p = 0$\n3. $l_2 \\frac{1}{\\rho} + l_3(\\mp c) = 0 \\implies l_2 = \\pm l_3 \\rho c$\n将 $l_2$ 代入方程（2）：\n$$\n(\\pm l_3 \\rho c)(\\mp c) + l_3 \\gamma p = 0 \\implies -l_3 \\rho c^2 + l_3 \\gamma p = 0 \\implies l_3(-\\rho c^2 + \\gamma p) = 0\n$$\n由于 $c^2 = \\gamma p / \\rho$，该方程对 $l_3$ 的任何选择都成立。我们可以选择 $l_3 = 1$。这得到 $l_2 = \\pm \\rho c$。\n声波族的左特征向量为：\n对于 $\\lambda_1 = u - c$：$\\mathbf{l}_1^T = (0, -\\rho c, 1)$\n对于 $\\lambda_3 = u + c$：$\\mathbf{l}_3^T = (0, \\rho c, 1)$\n\n相应的特征相容性关系为 $\\mathbf{l}^T d\\mathbf{W} = 0$：\n$$-\\rho c \\, du + dp = 0 \\quad \\text{沿着} \\quad \\frac{dx}{dt} = u - c$$\n$$\\rho c \\, du + dp = 0 \\quad \\text{沿着} \\quad \\frac{dx}{dt} = u + c$$\n这些可以合并为 $dp \\pm \\rho c \\, du = 0$。为了找到黎曼不变量，我们必须对这些微分形式进行积分。穿过声波的流动是等熵的，意味着熵是恒定的。对于理想气体，这意味着对于某个常数 $K$，$p = K\\rho^\\gamma$。由此，我们有 $dp = K\\gamma\\rho^{\\gamma-1}d\\rho$。同样，$c^2 = \\frac{\\gamma p}{\\rho} = \\gamma K \\rho^{\\gamma-1}$，所以 $dp = c^2 d\\rho$。\n相容性关系可以写成 $\\frac{dp}{\\rho c} \\pm du = 0$。让我们找一个函数，它的微分是 $\\frac{dp}{\\rho c}$：\n$$\n\\int \\frac{dp}{\\rho c} = \\int \\frac{c^2 d\\rho}{\\rho c} = \\int \\frac{c}{\\rho} d\\rho\n$$\n由于 $c = \\sqrt{\\gamma K \\rho^{\\gamma-1}}$，让我们用 $c$ 来表示这个积分。\n$c^2 = \\gamma K \\rho^{\\gamma-1} \\implies \\ln(c^2) = \\ln(\\gamma K) + (\\gamma-1)\\ln(\\rho) \\implies 2\\ln(c) = \\text{const} + (\\gamma-1)\\ln(\\rho)$。\n对 $\\rho$ 求导：$\\frac{2}{c}\\frac{dc}{d\\rho} = \\frac{\\gamma-1}{\\rho} \\implies d\\rho = \\frac{2\\rho}{(\\gamma-1)c}dc$。\n将 $d\\rho$ 代入积分中：\n$$\n\\int \\frac{c}{\\rho} d\\rho = \\int \\frac{c}{\\rho} \\frac{2\\rho}{(\\gamma-1)c} dc = \\int \\frac{2}{\\gamma-1} dc = \\frac{2c}{\\gamma-1}\n$$\n所以，$d\\left(\\frac{2c}{\\gamma-1}\\right) = \\frac{dp}{\\rho c}$。\n相容性关系现在是恰当微分：\n$$ d\\left(\\frac{2c}{\\gamma-1}\\right) \\pm du = 0 \\implies d\\left(u \\pm \\frac{2c}{\\gamma-1}\\right) = 0 $$\n黎曼不变量是沿其各自特征线守恒的量：\n$$\nw_{-} = u - \\frac{2c}{\\gamma-1} \\quad (\\text{沿 } \\frac{dx}{dt} = u - c \\text{ 保持不变})\n$$\n$$\nw_{+} = u + \\frac{2c}{\\gamma-1} \\quad (\\text{沿 } \\frac{dx}{dt} = u + c \\text{ 保持不变})\n$$\n这里，$w_{+}$ 与右行波相关，$w_{-}$ 与左行波相关。\n\n现在我们使用给定的状态进行数值计算：\n$$\n\\rho = 1.2\\ \\text{kg m}^{-3},\\quad u = 120\\ \\text{m s}^{-1},\\quad p = 101325\\ \\text{Pa},\\quad \\gamma = 1.4\n$$\n首先，计算声速 $c$：\n$$\nc = \\sqrt{\\frac{\\gamma p}{\\rho}} = \\sqrt{\\frac{1.4 \\times 101325}{1.2}} = \\sqrt{\\frac{141855}{1.2}} = \\sqrt{118212.5}\\ \\text{m s}^{-1}\n$$\n$$\nc \\approx 343.82043\\ \\text{m s}^{-1}\n$$\n声波速度为：\n$$\n\\lambda_1 = u - c = 120 - 343.82043 = -223.82043\\ \\text{m s}^{-1}\n$$\n$$\n\\lambda_3 = u + c = 120 + 343.82043 = 463.82043\\ \\text{m s}^{-1}\n$$\n接触波的波速为 $\\lambda_2 = u = 120\\ \\text{m s}^{-1}$。\n我们验证严格双曲性排序 $u-c  u  u+c$：\n$$\n-223.82043\\ \\text{m s}^{-1}  120\\ \\text{m s}^{-1}  463.82043\\ \\text{m s}^{-1}\n$$\n排序得到确认，这对于 $c>0$ 的物理有效流动是必需的。\n\n最后，我们计算量 $J \\equiv w_{+} - w_{-}$：\n$$\nJ = \\left(u + \\frac{2c}{\\gamma-1}\\right) - \\left(u - \\frac{2c}{\\gamma-1}\\right) = u + \\frac{2c}{\\gamma-1} - u + \\frac{2c}{\\gamma-1} = \\frac{4c}{\\gamma-1}\n$$\n代入 $c$ 和 $\\gamma$ 的数值：\n$$\nJ = \\frac{4 \\times \\sqrt{118212.5}}{1.4 - 1} = \\frac{4 \\times \\sqrt{118212.5}}{0.4} = 10 \\times \\sqrt{118212.5}\n$$\n$$\nJ = 10 \\times 343.82043... = 3438.2043...\\ \\text{m s}^{-1}\n$$\n问题要求将答案四舍五入到四位有效数字。\n$$\nJ \\approx 3438\\ \\text{m s}^{-1}\n$$", "answer": "$$\\boxed{3438}$$", "id": "3291767"}, {"introduction": "在掌握了理论基础之后，本练习 ([@problem_id:3291811]) 将通过让你实现一个戈杜诺夫（Godunov）型有限体积格式，从而将理论知识转化为实践应用。你将编写一个广泛使用的 HLL（Harten-Lax-van Leer）近似黎曼求解器，该求解器利用对最快波速的估计来构建一个既稳健又简洁的数值通量。这项动手任务将巩固你对黎曼求解器在真实CFD代码中如何更新解的理解。", "problem": "您需要为一个一阶 Godunov 有限体积格式实现一个显式时间步，用于求解一维可压缩欧拉方程，其中使用分段常数重构和指定的近似黎曼求解器。控制方程为质量、动量和能量的守恒律，其状态向量为 $U = [\\rho, \\rho u, E]^\\top$，通量为 $F(U) = [\\rho u, \\rho u^2 + p, u (E + p)]^\\top$。状态方程为理想气体定律，比热比为 $\\gamma$，压力由 $p = (\\gamma - 1)\\left(E - \\tfrac{1}{2}\\rho u^2\\right)$ 给出。采用分段常数重构的离散更新根据 $U_i^{n+1} = U_i^n - \\dfrac{\\Delta t}{\\Delta x}\\left(F_{i+\\frac{1}{2}} - F_{i-\\frac{1}{2}}\\right)$ 演化单元平均值，其中 $F_{i\\pm \\frac{1}{2}}$ 是在单元交界面处由近似黎曼求解器计算出的数值通量。使用透射（零梯度）边界条件，通过在每个区域边界设置一个虚拟单元来实现。\n\n您的程序必须实现 Harten–Lax–van Leer (HLL) 近似黎曼求解器。您应该使用从左右状态和状态方程导出的信号速度估计来构建 HLL 通量。Courant–Friedrichs–Lewy (CFL) 数 $0  \\text{CFL} \\le 1$ 通过 $\\Delta t = \\text{CFL}\\,\\Delta x / a_{\\max}$ 控制显式时间步长，其中 $a_{\\max}$ 是整个区域内特征速度的一个合适的全局上界。将 $a_{\\max}$ 计算为所有单元中 $|u| + c$ 的最大值，其中声速 $c = \\sqrt{\\gamma p / \\rho}$ 是根据每个单元中的原始变量计算得出的。\n\n您将在域 $[0,1]$ 上进行模拟，该域包含 $N$ 个大小为 $\\Delta x = 1/N$ 的均匀单元，初始数据为分段常数，由位于 $x_0 \\in (0,1)$ 的单个间断点定义：对于单元中心 $x_i  x_0$，设置左状态 $(\\rho_L, u_L, p_L)$，否则设置右状态 $(\\rho_R, u_R, p_R)$。将这些原始变量转换为守恒变量 $U = [\\rho, \\rho u, E]^\\top$，其中 $E = p/(\\gamma - 1) + \\tfrac{1}{2}\\rho u^2$。\n\n对于下面的每个测试用例，完全按照规定执行一个时间步，并在更新后计算并返回以下三个量：\n- 时间步长 $\\Delta t$，以浮点数形式表示。\n- 更新后的总质量 $M = \\sum_{i=1}^{N} \\rho_i^{n+1} \\Delta x$，以浮点数形式表示。\n- 更新后所有内部单元的最小压力 $\\min_i p_i^{n+1}$，以浮点数形式表示。\n\n此无量纲问题不需要物理单位。不涉及角度。所有输出均以十进制浮点数表示。\n\n使用以下测试套件，每个测试由 $(N, \\text{CFL}, \\gamma, (\\rho_L,u_L,p_L), (\\rho_R,u_R,p_R), x_0)$ 指定：\n1. $N = 200$, $\\text{CFL} = 0.5$, $\\gamma = 1.4$, $(\\rho_L,u_L,p_L) = (1.0, 0.0, 1.0)$, $(\\rho_R,u_R,p_R) = (0.125, 0.0, 0.1)$, $x_0 = 0.5$。\n2. $N = 200$, $\\text{CFL} = 0.5$, $\\gamma = 1.4$, $(\\rho_L,u_L,p_L) = (0.445, 0.698, 3.528)$, $(\\rho_R,u_R,p_R) = (0.5, 0.0, 0.571)$, $x_0 = 0.5$。\n3. $N = 200$, $\\text{CFL} = 0.2$, $\\gamma = 1.4$, $(\\rho_L,u_L,p_L) = (1.0, 0.0, 1.0)$, $(\\rho_R,u_R,p_R) = (0.001, 0.0, 0.000001)$, $x_0 = 0.5$。\n4. $N = 200$, $\\text{CFL} = 0.5$, $\\gamma = 1.4$, $(\\rho_L,u_L,p_L) = (1.0, 3.0, 1.0)$, $(\\rho_R,u_R,p_R) = (1.0, 3.0, 1.0)$, $x_0 = 0.25$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果，每个测试用例贡献一个包含三个值的子列表，顺序为 $[\\Delta t, M, \\min p]$。例如，最终输出格式必须是\n$[\\,[\\Delta t_1, M_1, \\min p_1],\\,[\\Delta t_2, M_2, \\min p_2],\\,[\\Delta t_3, M_3, \\min p_3],\\,[\\Delta t_4, M_4, \\min p_4]\\,]$,\n行中不包含任何其他文本和空格。", "solution": "用户要求实现一个用于求解一维可压缩欧拉方程的一阶 Godunov 型有限体积格式的显式单时间步。该解法必须使用 Harten–Lax–van Leer (HLL) 近似黎曼求解器。\n\n一维欧拉方程是一个守恒律系统，由 $\\partial_t U + \\partial_x F(U) = 0$ 给出，其中 $U$ 是守恒变量向量，$F(U)$ 是通量向量。\n状态向量 $U$ 和通量向量 $F(U)$ 定义如下：\n$$\nU = \\begin{pmatrix} \\rho \\\\ \\rho u \\\\ E \\end{pmatrix}, \\quad\nF(U) = \\begin{pmatrix} \\rho u \\\\ \\rho u^2 + p \\\\ u(E+p) \\end{pmatrix}\n$$\n此处，$\\rho$ 是流体密度，$u$ 是速度，$E$ 是单位体积的总能量，$p$ 是压力。该系统通过理想气体状态方程封闭，该方程将压力与守恒变量联系起来：\n$$\np = (\\gamma - 1) \\left( E - \\frac{1}{2}\\rho u^2 \\right)\n$$\n其中 $\\gamma$ 是比热比。\n\n有限体积法将空间域 $[0, 1]$ 离散为 $N$ 个计算单元 $C_i = [x_{i-1/2}, x_{i+1/2}]$，其中 $i=1, \\dots, N$。每个单元的宽度均匀，为 $\\Delta x = 1/N$。单元平均状态变量为 $U_i(t) = \\frac{1}{\\Delta x} \\int_{C_i} U(x, t) dx$。\n对于一阶格式，我们假设采用分段常数重构，即每个单元内的状态是均匀的，$U(x, t) = U_i(t)$ 对 $x \\in C_i$ 成立。\n将守恒律在单元 $C_i$ 和时间区间 $[t^n, t^{n+1}]$ 上积分，得到显式时间推进公式：\n$$\nU_i^{n+1} = U_i^n - \\frac{\\Delta t}{\\Delta x} \\left( F_{i+1/2} - F_{i-1/2} \\right)\n$$\n其中 $\\Delta t = t^{n+1} - t^n$ 是时间步长，$F_{i\\pm 1/2}$ 是单元交界面 $x_{i\\pm 1/2}$ 处的数值通量。这些通量通过在每个交界面求解黎曼问题来计算。\n\nHLL 近似黎曼求解器基于左右状态 $U_L = U_i^n$ 和 $U_R = U_{i+1}^n$ 为交界面通量 $F_{i+1/2}$ 提供一个估计值。该方法估计从交界面发出的最快的左行 ($S_L$) 和右行 ($S_R$) 信号速度。一个常用且稳健的估计（Davis, 1988）是：\n$$\nS_L = \\min(u_L - c_L, u_R - c_R)\n$$\n$$\nS_R = \\max(u_L + c_L, u_R + c_R)\n$$\n其中 $c = \\sqrt{\\gamma p / \\rho}$ 是声速。HLL 通量 $F_{HLL}$ 则由下式给出：\n$$\nF_{HLL}(U_L, U_R) = \\begin{cases}\nF(U_L)  \\text{if } S_L \\ge 0 \\\\\nF(U_R)  \\text{if } S_R \\le 0 \\\\\n\\dfrac{S_R F(U_L) - S_L F(U_R) + S_L S_R (U_R - U_L)}{S_R - S_L}  \\text{if } S_L  0  S_R\n\\end{cases}\n$$\n\n显式格式在 Courant–Friedrichs–Lewy (CFL) 条件下是稳定的。时间步长 $\\Delta t$ 计算如下：\n$$\n\\Delta t = \\text{CFL} \\frac{\\Delta x}{a_{\\max}}\n$$\n其中 $\\text{CFL}$ 是 CFL 数（$0  \\text{CFL} \\le 1$），$a_{\\max}$ 是在时间 $t^n$ 时整个区域上的最大特征速度：\n$$\na_{\\max} = \\max_i(|u_i^n| + c_i^n)\n$$\n\n实现过程如下：\n1.  **初始化**：设置包含 $N$ 个单元的空间网格。根据给定的分段常数原始变量 $(\\rho, u, p)$，使用转换公式 $E = p/(\\gamma-1) + \\frac{1}{2}\\rho u^2$ 初始化 $i=1, \\dots, N$ 的单元平均守恒变量 $U_i^0$。\n2.  **时间步长计算**：计算所有单元上的最大特征速度 $a_{\\max}$，并使用 CFL 条件计算时间步长 $\\Delta t$。\n3.  **边界条件**：在两边各用一个虚拟单元扩展区域。对于透射（零梯度）边界，左侧虚拟单元的状态设置为等于第一个内部单元的状态（$U_0 = U_1$），右侧虚拟单元的状态设置为等于最后一个内部单元的状态（$U_{N+1} = U_N$）。这将创建一个大小为 $N+2$ 的扩展状态向量。\n4.  **通量计算**：遍历从 $x_{1/2}$ 到 $x_{N+1/2}$ 的所有 $N+1$ 个交界面。在每个交界面 $x_{i+1/2}$ 处，使用扩展网格中的状态 $U_i$ 和 $U_{i+1}$ 作为 HLL 求解器的左右输入，以计算数值通量 $F_{i+1/2}$。\n5.  **状态更新**：使用离散守恒律更新所有内部单元 $i=1, \\dots, N$ 的守恒变量 $U_i$。\n6.  **输出计算**：一个时间步后，将新的守恒变量 $U_i^{n+1}$ 转换回原始变量 $(\\rho_i^{n+1}, u_i^{n+1}, p_i^{n+1})$。计算总质量 $M = \\sum_{i=1}^{N} \\rho_i^{n+1} \\Delta x$ 和最小压力 $\\min_i p_i^{n+1}$。\n\n将此过程应用于每个测试用例以生成所需的输出。为提高效率，使用了向量化的 `numpy` 操作。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\nclass Euler1DHLLSolver:\n    \"\"\"\n    Implements a single step of a first-order Godunov scheme for the\n    1D Euler equations using the HLL approximate Riemann solver.\n    \"\"\"\n    def __init__(self, N, CFL, gamma, left_prim, right_prim, x0):\n        self.N = N\n        self.CFL = CFL\n        self.gamma = gamma\n        self.dx = 1.0 / self.N\n        self.U = self._initialize_state(left_prim, right_prim, x0)\n\n    def _primitives_to_conserved(self, rho, u, p):\n        return np.array([rho, rho * u, p / (self.gamma - 1.0) + 0.5 * rho * u**2])\n\n    def _conserved_to_primitives_vec(self, U):\n        rho = U[:, 0]\n        rho_u = U[:, 1]\n        E = U[:, 2]\n        u = rho_u / rho\n        # Prevent negative pressure from floating point errors\n        p = np.maximum(1e-12, (self.gamma - 1.0) * (E - 0.5 * rho * u**2))\n        return rho, u, p\n\n    def _get_flux_vec(self, U):\n        rho, u, p = self._conserved_to_primitives_vec(U)\n        rho_u = U[:, 1]\n        E = U[:, 2]\n        \n        F = np.zeros_like(U)\n        F[:, 0] = rho_u\n        F[:, 1] = rho_u * u + p\n        F[:, 2] = u * (E + p)\n        return F\n\n    def _get_hll_flux_vec(self, U_L, U_R):\n        gamma = self.gamma\n        rho_L, u_L, p_L = self._conserved_to_primitives_vec(U_L)\n        rho_R, u_R, p_R = self._conserved_to_primitives_vec(U_R)\n\n        F_L = self._get_flux_vec(U_L)\n        F_R = self._get_flux_vec(U_R)\n\n        c_L = np.sqrt(gamma * p_L / rho_L)\n        c_R = np.sqrt(gamma * p_R / rho_R)\n\n        S_L = np.minimum(u_L - c_L, u_R - c_R)\n        S_R = np.maximum(u_L + c_L, u_R + c_R)\n\n        # Broadcasting for array operations\n        S_L_b = S_L[:, np.newaxis]\n        S_R_b = S_R[:, np.newaxis]\n        \n        # HLL flux formula vectorized\n        num = S_R_b * F_L - S_L_b * F_R + S_L_b * S_R_b * (U_R - U_L)\n        den = S_R - S_L\n        \n        F_hll = np.zeros_like(U_L)\n\n        # Conditions for HLL cases\n        cond_L = S_L >= 0\n        cond_R = S_R = 0\n        cond_star = (~cond_L)  (~cond_R)\n        \n        F_hll[cond_L] = F_L[cond_L]\n        F_hll[cond_R] = F_R[cond_R]\n\n        # For the star region, handle possible division by zero\n        den_star = den[cond_star]\n        is_zero_den = np.isclose(den_star, 0)\n        \n        F_star = np.zeros_like(F_L[cond_star])\n        \n        # Non-zero denominator case\n        non_zero_mask = ~is_zero_den\n        if np.any(non_zero_mask):\n            F_star[non_zero_mask] = num[cond_star][non_zero_mask] / den_star[non_zero_mask, np.newaxis]\n\n        # Zero denominator case (uniform flow U_L=U_R) -> flux is physical flux\n        if np.any(is_zero_den):\n            F_star[is_zero_den] = F_L[cond_star][is_zero_den]\n        \n        F_hll[cond_star] = F_star\n        \n        return F_hll\n\n    def _initialize_state(self, left_prim, right_prim, x0):\n        x_centers = (np.arange(self.N) + 0.5) * self.dx\n        \n        left_U = self._primitives_to_conserved(*left_prim)\n        right_U = self._primitives_to_conserved(*right_prim)\n        \n        mask = (x_centers  x0)[:, np.newaxis]\n        U = np.where(mask, left_U, right_U)\n        return U\n\n    def run_one_step(self):\n        # 1. Calculate time step dt\n        rho, u, p = self._conserved_to_primitives_vec(self.U)\n        c = np.sqrt(self.gamma * p / rho)\n        a_max = np.max(np.abs(u) + c)\n        dt = self.CFL * self.dx / a_max\n        \n        # 2. Apply boundary conditions (1 ghost cell on each side)\n        U_ext = np.zeros((self.N + 2, 3))\n        U_ext[1:-1, :] = self.U\n        U_ext[0, :] = U_ext[1, :]   # zero-gradient BC on left\n        U_ext[-1, :] = U_ext[-2, :] # zero-gradient BC on right\n\n        # 3. Compute fluxes at cell interfaces\n        U_L = U_ext[:-1, :]\n        U_R = U_ext[1:, :]\n        F_half = self._get_hll_flux_vec(U_L, U_R)\n\n        # 4. Update cell averages\n        F_L_cell = F_half[:-1, :] # Fluxes at i-1/2\n        F_R_cell = F_half[1:, :]  # Fluxes at i+1/2\n        U_new = self.U - (dt / self.dx) * (F_R_cell - F_L_cell)\n\n        # 5. Compute required outputs\n        rho_new, _, p_new = self._conserved_to_primitives_vec(U_new)\n        total_mass = np.sum(rho_new) * self.dx\n        min_pressure = np.min(p_new)\n\n        return dt, total_mass, min_pressure\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (200, 0.5, 1.4, (1.0, 0.0, 1.0), (0.125, 0.0, 0.1), 0.5),\n        (200, 0.5, 1.4, (0.445, 0.698, 3.528), (0.5, 0.0, 0.571), 0.5),\n        (200, 0.2, 1.4, (1.0, 0.0, 1.0), (0.001, 0.0, 0.000001), 0.5),\n        (200, 0.5, 1.4, (1.0, 3.0, 1.0), (1.0, 3.0, 1.0), 0.25),\n    ]\n\n    results = []\n    for case in test_cases:\n        N, CFL, gamma, left_prim, right_prim, x0 = case\n        solver = Euler1DHLLSolver(N, CFL, gamma, left_prim, right_prim, x0)\n        res = solver.run_one_step()\n        results.append(list(res))\n\n    # Final print statement in the exact required format.\n    result_strs = [f\"[{r[0]},{r[1]},{r[2]}]\" for r in results]\n    print(f\"[{','.join(result_strs)}]\")\n\nsolve()\n```", "id": "3291811"}, {"introduction": "近似黎曼求解器功能强大，但理解其局限性也至关重要。本练习 ([@problem_id:3291766]) 将探讨广受欢迎的 Roe 求解器的一个经典失效案例，展示其在处理跨音速稀疏波等特定流动现象时如何产生负压等非物理解。通过分析这个反例，你将对熵条件的重要性以及对更先进的保正数值格式的需求获得深刻的认识。", "problem": "考虑理想气体的一维可压缩欧拉方程，\n$$\n\\frac{\\partial}{\\partial t}\n\\begin{pmatrix}\n\\rho \\\\\n\\rho u \\\\\nE\n\\end{pmatrix}\n+\n\\frac{\\partial}{\\partial x}\n\\begin{pmatrix}\n\\rho u \\\\\n\\rho u^{2} + p \\\\\nu\\,(E + p)\n\\end{pmatrix}\n= 0,\n$$\n具有热力学封闭关系\n$$\nE = \\frac{p}{\\gamma - 1} + \\frac{1}{2}\\,\\rho u^{2},\n$$\n其中 $\\rho$ 是密度，$u$ 是速度，$p$ 是压力，$E$ 是总能量，$\\gamma$ 是恒定的比热比。所有变量均为无量纲。\n\n定义一个具有左右状态的黎曼问题\n$$\n(\\rho_{L}, u_{L}, p_{L}) = (1, -2, 0.1), \\qquad (\\rho_{R}, u_{R}, p_{R}) = (1, 2, 0.1),\n$$\n针对理想气体，其中 $\\gamma = 1.4$。\n\n使用 Roe 线性化（无任何熵修正），构造此黎曼问题的分段常数近似解，并确定中间常数状态 $U_{*}$，该状态对应于严格位于最小和最大 Roe 特征速度之间的自相似变量 $x/t$。然后，通过理想气体关系从守恒变量计算该中间状态的压力 $p_{*}$。\n\n解释在此情况下 Roe 求解器失去不变域（密度和压力的正性）的机制，并将其与线性化的结构以及数据的跨音速稀疏特征联系起来。\n\n以无量纲单位提供 $p_{*}$ 的值，表示为单个实数，并将您的答案四舍五入至四位有效数字。", "solution": "本问题要求使用 Roe 近似黎曼求解器对一维可压缩欧拉方程的一个特定黎曼问题进行分析。我将首先验证问题陈述，然后进行详细的解题推导。\n\n该方程组由下式给出\n$$\n\\frac{\\partial \\mathbf{U}}{\\partial t} + \\frac{\\partial \\mathbf{F}(\\mathbf{U})}{\\partial x} = 0,\n$$\n其中守恒变量向量 $\\mathbf{U}$ 和通量向量 $\\mathbf{F}$ 为\n$$\n\\mathbf{U} = \\begin{pmatrix} \\rho \\\\ \\rho u \\\\ E \\end{pmatrix}, \\qquad \\mathbf{F}(\\mathbf{U}) = \\begin{pmatrix} \\rho u \\\\ \\rho u^{2} + p \\\\ u(E + p) \\end{pmatrix}.\n$$\n该系统由理想气体状态方程封闭，它将总能量 $E$ 与压力 $p$、密度 $\\rho$ 和速度 $u$ 联系起来：\n$$\nE = \\frac{p}{\\gamma - 1} + \\frac{1}{2}\\rho u^{2}.\n$$\n给定的黎曼问题具有以下左（$L$）和右（$R$）状态：\n$$\n(\\rho_{L}, u_{L}, p_{L}) = (1, -2, 0.1)\n$$\n$$\n(\\rho_{R}, u_{R}, p_{R}) = (1, 2, 0.1)\n$$\n比热比为 $\\gamma = 1.4$。\n\nRoe 方法通过求解线性化系统 $\\frac{\\partial \\mathbf{U}}{\\partial t} + \\tilde{A} \\frac{\\partial \\mathbf{U}}{\\partial x} = 0$ 来近似黎曼问题的解，其中 Roe 矩阵 $\\tilde{A}(\\mathbf{U}_L, \\mathbf{U}_R)$ 是一个常数矩阵，满足性质 $\\mathbf{F}_R - \\mathbf{F}_L = \\tilde{A}(\\mathbf{U}_R - \\mathbf{U}_L)$。该矩阵使用 Roe 平均变量构造。\n\n首先，我们计算左右状态所需的原始变量和派生量。\n对于左状态：\n$$\nE_L = \\frac{p_L}{\\gamma - 1} + \\frac{1}{2}\\rho_L u_L^2 = \\frac{0.1}{1.4 - 1} + \\frac{1}{2}(1)(-2)^2 = \\frac{0.1}{0.4} + 2 = 0.25 + 2 = 2.25\n$$\n比总焓为 $h = (E+p)/\\rho$。\n$$\nh_L = \\frac{E_L + p_L}{\\rho_L} = \\frac{2.25 + 0.1}{1} = 2.35\n$$\n对于右状态，问题是对称的：\n$$\nE_R = \\frac{p_R}{\\gamma - 1} + \\frac{1}{2}\\rho_R u_R^2 = \\frac{0.1}{1.4 - 1} + \\frac{1}{2}(1)(2)^2 = 0.25 + 2 = 2.25\n$$\n$$\nh_R = \\frac{E_R + p_R}{\\rho_R} = \\frac{2.25 + 0.1}{1} = 2.35\n$$\n接下来，我们计算用波浪号表示的 Roe 平均变量：\n$$\n\\tilde{\\rho} = \\sqrt{\\rho_L \\rho_R} = \\sqrt{1 \\times 1} = 1\n$$\n$$\n\\tilde{u} = \\frac{\\sqrt{\\rho_L}u_L + \\sqrt{\\rho_R}u_R}{\\sqrt{\\rho_L} + \\sqrt{\\rho_R}} = \\frac{\\sqrt{1}(-2) + \\sqrt{1}(2)}{\\sqrt{1} + \\sqrt{1}} = \\frac{-2 + 2}{2} = 0\n$$\n$$\n\\tilde{h} = \\frac{\\sqrt{\\rho_L}h_L + \\sqrt{\\rho_R}h_R}{\\sqrt{\\rho_L} + \\sqrt{\\rho_R}} = \\frac{\\sqrt{1}(2.35) + \\sqrt{1}(2.35)}{\\sqrt{1} + \\sqrt{1}} = 2.35\n$$\nRoe 平均声速 $\\tilde{c}$ 由 $\\tilde{c}^2 = (\\gamma - 1)(\\tilde{h} - \\frac{1}{2}\\tilde{u}^2)$ 给出。\n$$\n\\tilde{c}^2 = (1.4 - 1)(2.35 - \\frac{1}{2}(0)^2) = 0.4 \\times 2.35 = 0.94\n$$\n$$\n\\tilde{c} = \\sqrt{0.94}\n$$\nRoe 矩阵 $\\tilde{A}$ 的特征值是在平均状态下计算的特征速度：\n$$\n\\tilde{\\lambda}_1 = \\tilde{u} - \\tilde{c} = -\\sqrt{0.94}\n$$\n$$\n\\tilde{\\lambda}_2 = \\tilde{u} = 0\n$$\n$$\n\\tilde{\\lambda}_3 = \\tilde{u} + \\tilde{c} = \\sqrt{0.94}\n$$\n状态向量的跳跃 $\\Delta \\mathbf{U} = \\mathbf{U}_R - \\mathbf{U}_L$ 被分解到 $\\tilde{A}$ 的右特征向量 $\\tilde{\\mathbf{r}}_k$ 的基上，其系数（波强度）为 $\\tilde{\\alpha}_k$：$\\Delta \\mathbf{U} = \\sum_{k=1}^3 \\tilde{\\alpha}_k \\tilde{\\mathbf{r}}_k$。\n波强度根据原始变量的跳跃计算得出：\n$$\n\\Delta\\rho = \\rho_R - \\rho_L = 1 - 1 = 0\n$$\n$$\n\\Delta u = u_R - u_L = 2 - (-2) = 4\n$$\n$$\n\\Delta p = p_R - p_L = 0.1 - 0.1 = 0\n$$\n波强度的公式为：\n$$\n\\tilde{\\alpha}_1 = \\frac{1}{2\\tilde{c}^2}(\\Delta p - \\tilde{\\rho}\\tilde{c}\\Delta u) = \\frac{1}{2(0.94)}(0 - (1)(\\sqrt{0.94})(4)) = -\\frac{4\\sqrt{0.94}}{2(0.94)} = -\\frac{2}{\\sqrt{0.94}}\n$$\n$$\n\\tilde{\\alpha}_2 = \\Delta\\rho - \\frac{\\Delta p}{\\tilde{c}^2} = 0 - \\frac{0}{0.94} = 0\n$$\n$$\n\\tilde{\\alpha}_3 = \\frac{1}{2\\tilde{c}^2}(\\Delta p + \\tilde{\\rho}\\tilde{c}\\Delta u) = \\frac{1}{2(0.94)}(0 + (1)(\\sqrt{0.94})(4)) = \\frac{4\\sqrt{0.94}}{2(0.94)} = \\frac{2}{\\sqrt{0.94}}\n$$\n近似解由常数状态组成，这些状态被以速度 $\\tilde{\\lambda}_k$ 移动的间断点分隔。位于 $\\tilde{\\lambda}_1$ 和 $\\tilde{\\lambda}_2$ 之间的状态是 $\\mathbf{U}_{*L} = \\mathbf{U}_L + \\tilde{\\alpha}_1 \\tilde{\\mathbf{r}}_1$。位于 $\\tilde{\\lambda}_2$ 和 $\\tilde{\\lambda}_3$ 之间的状态是 $\\mathbf{U}_{*R} = \\mathbf{U}_{*L} + \\tilde{\\alpha}_2 \\tilde{\\mathbf{r}}_2$。由于接触波强度 $\\tilde{\\alpha}_2 = 0$，因此只有一个中间状态，即 $\\mathbf{U}_* = \\mathbf{U}_{*L} = \\mathbf{U}_{*R}$。\n\nRoe 矩阵的第一个右特征向量是 $\\tilde{\\mathbf{r}}_1 = (1, \\tilde{u}-\\tilde{c}, \\tilde{h}-\\tilde{u}\\tilde{c})^T$。在 Roe 平均状态下计算：\n$$\n\\tilde{\\mathbf{r}}_1 = (1, 0-\\sqrt{0.94}, 2.35 - 0 \\times \\sqrt{0.94})^T = (1, -\\sqrt{0.94}, 2.35)^T\n$$\n左状态向量为 $\\mathbf{U}_L = (\\rho_L, \\rho_L u_L, E_L)^T = (1, -2, 2.25)^T$。\n中间状态 $\\mathbf{U}_* = (\\rho_*, (\\rho u)_*, E_*)^T$ 计算如下：\n$$\n\\mathbf{U}_* = \\mathbf{U}_L + \\tilde{\\alpha}_1 \\tilde{\\mathbf{r}}_1 = \\begin{pmatrix} 1 \\\\ -2 \\\\ 2.25 \\end{pmatrix} + \\left(-\\frac{2}{\\sqrt{0.94}}\\right) \\begin{pmatrix} 1 \\\\ -\\sqrt{0.94} \\\\ 2.35 \\end{pmatrix}\n$$\n我们计算 $\\mathbf{U}_*$ 的分量：\n$$\n\\rho_* = 1 - \\frac{2}{\\sqrt{0.94}}\n$$\n$$\n(\\rho u)_* = -2 - \\frac{2}{\\sqrt{0.94}}(-\\sqrt{0.94}) = -2 + 2 = 0\n$$\n$$\nE_* = 2.25 - \\frac{2 \\times 2.35}{\\sqrt{0.94}} = 2.25 - \\frac{4.7}{\\sqrt{0.94}}\n$$\n从这些守恒变量，我们找到中间状态的原始变量。速度为：\n$$\nu_* = \\frac{(\\rho u)_*}{\\rho_*} = \\frac{0}{\\rho_*} = 0\n$$\n压力 $p_*$ 从总能量中求得：\n$$\nE_* = \\frac{p_*}{\\gamma - 1} + \\frac{1}{2}\\rho_* u_*^2 \\implies p_* = (\\gamma - 1) E_* \\quad (\\text{因为 } u_*=0)\n$$\n代入 $E_*$ 的表达式：\n$$\np_* = (1.4 - 1) \\left( 2.25 - \\frac{4.7}{\\sqrt{0.94}} \\right) = 0.4 \\left( 2.25 - \\frac{4.7}{\\sqrt{0.94}} \\right)\n$$\n数值上，$\\sqrt{0.94} \\approx 0.969536$。\n$$\np_* \\approx 0.4 \\left( 2.25 - \\frac{4.7}{0.969536} \\right) \\approx 0.4 (2.25 - 4.84765) = 0.4 (-2.59765) \\approx -1.03906\n$$\n四舍五入到四位有效数字，我们得到 $p_* = -1.039$。\n\n负压是非物理的，这突显了 Roe 求解器的一个已知失效。这种失效的机制如下：\n1.  **跨音速稀疏波：** 初始数据代表一个强烈的对称膨胀。与声波相关的特征速度在整个问题域内改变符号。对于左状态，速度为 $(u_L-c_L, u_L, u_L+c_L)$，其中 $c_L = \\sqrt{\\gamma p_L / \\rho_L} = \\sqrt{1.4 \\times 0.1 / 1} = \\sqrt{0.14} \\approx 0.374$。所有特征速度 $u_L \\pm c_L$ 和 $u_L$ 均为负值：$(-2.374, -2.0, -1.626)$。对于右状态，所有速度均为正值：$(1.626, 2.0, 2.374)$。这种情况，即特征场（例如 $u-c$ 或 $u+c$ 场）在两侧都是亚音速的，但特征速度穿过零点，被称为跨音速稀疏波。精确解包含一个在中心形成的真空状态（$p=0, \\rho=0$）。\n2.  **线性化与非物理激波：** Roe 求解器基于非线性欧拉方程的线性化。它用单个间断（一个“稀疏激波”）取代了精确解中的光滑稀疏扇。这个跳跃满足线性化系统的 Rankine-Hugoniot 条件，但违反了真实非线性系统的熵条件，因为激波必须是压缩性的。问题指定不使用熵修正，这是一种设计用于在这种情况下增加数值耗散以抹平稀疏波并防止这种非物理解的修正方法。\n3.  **不变域的丧失：** 欧拉方程的状态向量必须位于由物理约束 $\\rho > 0$ 和 $p > 0$ 定义的“不变域”内。Roe 线性化本身并不能保证中间状态 $(\\mathbf{U}_*)$ 会保持在该域内。对于像这样的强膨胀，从初始状态 $\\mathbf{U}_L$ 到中间状态 $\\mathbf{U}_*$ 的跳跃由波强度 $\\tilde{\\alpha}_1$ 表征。这个跳跃 $\\tilde{\\alpha}_1 \\tilde{\\mathbf{r}}_1$ 足够大，以至于“过冲”出物理区域。具体来说，新的密度为 $\\rho_* = \\rho_L + \\tilde{\\alpha}_1 (\\tilde{\\mathbf{r}}_1)_1 = 1 - 2/\\sqrt{0.94}$。由于 $2 > \\sqrt{0.94}$，得到的密度 $\\rho_*$ 为负。因此，从 $E_*$ 导出的压力 $p_*$ 也变为负值。线性化无法捕捉导致真空的非线性动力学，而是产生了一个数学上一致但物理上不可能的状态。", "answer": "$$\n\\boxed{-1.039}\n$$", "id": "3291766"}]}