{"hands_on_practices": [{"introduction": "显式时间推进格式的成功与否，其基石在于数值稳定性。本练习 [@problem_id:3373678] 将引导你理解和应用Courant-Friedrichs-Lewy (CFL) 条件，这是防止数值解发散的关键。你将首先从理论上推导该条件如何与双曲系统的特征波速度相关联，然后在一个具体的流场设定中，动手计算出保证模拟稳定的最大允许时间步长。", "problem": "考虑一种无粘理想气体的一维欧拉方程，其比热比为 $\\gamma$，\n$$\n\\frac{\\partial \\boldsymbol{U}}{\\partial t} + \\frac{\\partial \\boldsymbol{F}(\\boldsymbol{U})}{\\partial x} = 0,\n$$\n其中 $\\boldsymbol{U} = \\begin{pmatrix} \\rho \\\\ \\rho u \\\\ E \\end{pmatrix}$ 且 $\\boldsymbol{F}(\\boldsymbol{U}) = \\begin{pmatrix} \\rho u \\\\ \\rho u^{2} + p \\\\ u\\left(E + p\\right) \\end{pmatrix}$，压力由理想气体状态方程 $p = (\\gamma - 1)\\left(E - \\tfrac{1}{2}\\rho u^{2}\\right)$ 给出。一个采用前向欧拉时间积分的显式有限体积守恒格式通过平衡界面上的数值通量来推进单元平均值。此类格式的 Courant-Friedrichs-Lewy (CFL) 稳定性条件可以通过线性化方程并使用通量雅可比矩阵的谱半径来限制时间步长来证明。\n\n从这些原理出发，证明为何每个单元的最大允许时间步长由线性化双曲系统的最大特征速度决定，并表明在一维情况下，这将导致一个以当地流速 $u$ 和当地声速 $c$ (其中 $c = \\sqrt{\\gamma p / \\rho}$) 表示的单元限制。\n\n然后，对于一个由四个单元组成的均匀笛卡尔网格段，其宽度为\n$$\n\\Delta x_{1} = 0.010,\\quad \\Delta x_{2} = 0.008,\\quad \\Delta x_{3} = 0.012,\\quad \\Delta x_{4} = 0.009,\n$$\n单元中心的状态为\n$$\n(\\rho_{1}, u_{1}, p_{1}) = (1.0,\\ 50,\\ 1.0\\times 10^{5}),\\quad (\\rho_{2}, u_{2}, p_{2}) = (0.8,\\ -30,\\ 0.9\\times 10^{5}),\n$$\n$$\n(\\rho_{3}, u_{3}, p_{3}) = (1.2,\\ 80,\\ 1.1\\times 10^{5}),\\quad (\\rho_{4}, u_{4}, p_{4}) = (0.9,\\ 10,\\ 0.95\\times 10^{5}),\n$$\n取 $\\gamma = 1.4$ 和 Courant-Friedrichs-Lewy 数 $\\mathrm{CFL} = 0.60$。计算与导出的稳定性限制一致的全局最大允许显式时间步长 $\\Delta t_{\\max}$。以秒为单位表示最终时间步长，并将您的答案四舍五入到四位有效数字。", "solution": "该问题提出了一个由两部分组成的任务：首先，对应用于一维欧拉方程的显式有限体积格式的 Courant-Friedrichs-Lewy (CFL) 稳定性条件进行理论证明；其次，对此条件进行数值应用，以确定给定流动配置下的最大全局允许时间步长。\n\n问题陈述已经过验证，被认为是合理的。它在科学上基于流体动力学和数值分析的原理，是适定的，提供了所有必要信息，并且没有歧义或矛盾。因此，我们可以进行正式的求解。\n\n第1部分：CFL条件的理论证明\n\n无粘理想气体的一维欧拉方程构成一个非线性双曲守恒律系统：\n$$\n\\frac{\\partial \\boldsymbol{U}}{\\partial t} + \\frac{\\partial \\boldsymbol{F}(\\boldsymbol{U})}{\\partial x} = 0\n$$\n其中 $\\boldsymbol{U}$ 是守恒变量的向量，$\\boldsymbol{F}(\\boldsymbol{U})$ 是通量向量。为了分析该系统所描述的信息传播，我们考虑其准线性形式：\n$$\n\\frac{\\partial \\boldsymbol{U}}{\\partial t} + \\boldsymbol{A}(\\boldsymbol{U}) \\frac{\\partial \\boldsymbol{U}}{\\partial x} = 0\n$$\n此处，$\\boldsymbol{A}(\\boldsymbol{U}) = \\frac{\\partial \\boldsymbol{F}}{\\partial \\boldsymbol{U}}$ 是通量雅可比矩阵。该系统是双曲的，因为对于任何物理有效状态 $\\boldsymbol{U}$，矩阵 $\\boldsymbol{A}(\\boldsymbol{U})$ 都具有实特征值和一组完备的线性无关特征向量。\n\n$\\boldsymbol{A}(\\boldsymbol{U})$ 的特征值代表信息在介质中传播的特征速度。对于一维欧拉方程，通过严格推导（包括对通量向量 $\\boldsymbol{F}$ 关于状态向量 $\\boldsymbol{U}$ 求导并求解特征方程 $\\det(\\boldsymbol{A} - \\lambda\\boldsymbol{I}) = 0$）可得到以下三个特征值：\n$$\n\\lambda_1 = u - c, \\quad \\lambda_2 = u, \\quad \\lambda_3 = u + c\n$$\n其中 $u$ 是当地流体速度，$c = \\sqrt{\\gamma p / \\rho}$ 是当地声速。这些速度对应于相对于流动向上游（$u-c$）和下游（$u+c$）传播的声波，以及随流动输运的熵波/接触波（$u$）。\n\n显式有限体积格式根据单元界面上的通量，将时间 $t^n$ 时单元 $j$ 中的单元平均状态 $\\boldsymbol{U}_j^n$ 更新为时间 $t^{n+1} = t^n + \\Delta t$ 时的新状态 $\\boldsymbol{U}_j^{n+1}$。使用前向欧拉时间积分，更新公式为：\n$$\n\\boldsymbol{U}_j^{n+1} = \\boldsymbol{U}_j^n - \\frac{\\Delta t}{\\Delta x_j} [\\boldsymbol{\\hat{F}}_{j+1/2} - \\boldsymbol{\\hat{F}}_{j-1/2}]\n$$\n其中 $\\boldsymbol{\\hat{F}}_{j\\pm1/2}$ 是单元 $j$ 界面上的数值通量，它依赖于相邻单元的状态。这意味着新状态 $\\boldsymbol{U}_j^{n+1}$ 依赖于时间 $t^n$ 时单元 $j-1$、$j$ 和 $j+1$ 的信息。此信息的空间范围是区间 $[x_{j-1}, x_{j+1}]$，称为数值依赖域。\n\nCourant-Friedrichs-Lewy (CFL) 条件是此类显式格式稳定和收敛的必要条件。它要求数值依赖域必须包含物理依赖域。在 $(x_j, t^{n+1})$ 处解的物理依赖域是时间 $t^n$ 时的空间区域，该区域内的物理信号可以影响该点的解。信号以特征速度 $\\lambda_k$ 传播。信号传播的最快速度由雅可比矩阵的谱半径给出，即 $\\rho(\\boldsymbol{A}) = \\max_k |\\lambda_k|$。\n$$\n\\rho(\\boldsymbol{A}) = \\max(|u - c|, |u|, |u + c|)\n$$\n由于声速 $c$ 是非负的，这三个值的最大值总是 $|u| + c$。我们来验证这一点。如果 $u \\ge 0$，那么 $u+c > u$ 且 $u+c > |u-c|$。如果 $u  0$，令 $u = -v$，其中 $v > 0$。则速度为 $|-v-c|=v+c$、 $|-v|=v$ 和 $|-v+c|=|c-v|$。最大值为 $v+c = |u|+c$。因此，最大特征速度为 $S = |u| + c$。\n\n对于点 $(x_j, t^{n+1})$，其在时间 $t^n$ 的物理依赖域是区间 $[x_j - S\\Delta t, x_j + S\\Delta t]$。对于在宽度为 $\\Delta x$ 的均匀网格上使用涉及相邻单元的模板的格式，其数值依赖域是 $[x_j - \\Delta x, x_j + \\Delta x]$。CFL 条件要求该数值依赖域包含物理依赖域：\n$$\n[x_j - S\\Delta t, x_j + S\\Delta t] \\subseteq [x_j - \\Delta x, x_j + \\Delta x]\n$$\n这种包含关系意味着 $S\\Delta t \\le \\Delta x$。这就证明了为什么时间步长必须受最大特征速度的限制。我们可以将其写为：\n$$\n\\frac{(|u|+c)\\Delta t}{\\Delta x} \\le 1\n$$\n在实践中，会引入一个安全因子，称为 CFL 数（$\\mathrm{CFL} \\le 1$）。这导出了稳定性判据：\n$$\n\\Delta t \\le \\mathrm{CFL} \\frac{\\Delta x}{|u| + c}\n$$\n这表明每个单元的允许时间步长由单元宽度 $\\Delta x$ 决定，并与当地流速大小 $|u|$ 和当地声速 $c$ 的和成反比。理论证明至此完成。\n\n第2部分：全局时间步长的数值计算\n\n为确保整个计算域的稳定性，必须选择时间步长 $\\Delta t$，使得 CFL 条件在每个单元中都得到满足。对于非均匀网格，这意味着全局时间步长受需要最小时间步长的单元的限制：\n$$\n\\Delta t_{\\max} = \\min_{i} \\left( \\mathrm{CFL} \\frac{\\Delta x_i}{|u_i| + c_i} \\right)\n$$\n其中索引 $i$ 遍历网格中的所有单元。给定 $\\mathrm{CFL} = 0.60$ 和 $\\gamma=1.4$。我们接下来为四个单元中的每一个计算局部时间步长限制 $\\Delta t_i$。\n\n首先，我们为每个单元 $i \\in \\{1, 2, 3, 4\\}$ 计算当地声速 $c_i = \\sqrt{\\gamma p_i / \\rho_i}$。所有数值均采用国际单位制单位。\n\n单元 1: $(\\rho_1, u_1, p_1) = (1.0, 50, 1.0 \\times 10^5)$, $\\Delta x_1 = 0.010$.\n$$\nc_1 = \\sqrt{\\frac{1.4 \\times 1.0 \\times 10^{5}}{1.0}} = \\sqrt{140000} \\approx 374.1657 \\, \\mathrm{m/s}\n$$\n$$\n\\Delta t_1 = 0.60 \\times \\frac{0.010}{|50| + 374.1657} = \\frac{0.006}{424.1657} \\approx 1.41455 \\times 10^{-5} \\, \\mathrm{s}\n$$\n\n单元 2: $(\\rho_2, u_2, p_2) = (0.8, -30, 0.9 \\times 10^5)$, $\\Delta x_2 = 0.008$.\n$$\nc_2 = \\sqrt{\\frac{1.4 \\times 0.9 \\times 10^{5}}{0.8}} = \\sqrt{157500} \\approx 396.8627 \\, \\mathrm{m/s}\n$$\n$$\n\\Delta t_2 = 0.60 \\times \\frac{0.008}{|-30| + 396.8627} = \\frac{0.0048}{426.8627} \\approx 1.12448 \\times 10^{-5} \\, \\mathrm{s}\n$$\n\n单元 3: $(\\rho_3, u_3, p_3) = (1.2, 80, 1.1 \\times 10^5)$, $\\Delta x_3 = 0.012$.\n$$\nc_3 = \\sqrt{\\frac{1.4 \\times 1.1 \\times 10^{5}}{1.2}} = \\sqrt{\\frac{1.54 \\times 10^5}{1.2}} \\approx 358.2364 \\, \\mathrm{m/s}\n$$\n$$\n\\Delta t_3 = 0.60 \\times \\frac{0.012}{|80| + 358.2364} = \\frac{0.0072}{438.2364} \\approx 1.64299 \\times 10^{-5} \\, \\mathrm{s}\n$$\n\n单元 4: $(\\rho_4, u_4, p_4) = (0.9, 10, 0.95 \\times 10^5)$, $\\Delta x_4 = 0.009$.\n$$\nc_4 = \\sqrt{\\frac{1.4 \\times 0.95 \\times 10^{5}}{0.9}} = \\sqrt{\\frac{1.33 \\times 10^5}{0.9}} \\approx 384.4176 \\, \\mathrm{m/s}\n$$\n$$\n\\Delta t_4 = 0.60 \\times \\frac{0.009}{|10| + 384.4176} = \\frac{0.0054}{394.4176} \\approx 1.36911 \\times 10^{-5} \\, \\mathrm{s}\n$$\n\n全局最大允许显式时间步长是这些局部时间步长限制的最小值：\n$$\n\\Delta t_{\\max} = \\min(\\Delta t_1, \\Delta t_2, \\Delta t_3, \\Delta t_4)\n$$\n$$\n\\Delta t_{\\max} = \\min(1.41455, 1.12448, 1.64299, 1.36911) \\times 10^{-5} \\, \\mathrm{s}\n$$\n$$\n\\Delta t_{\\max} = 1.12448 \\times 10^{-5} \\, \\mathrm{s}\n$$\n按要求将此值四舍五入到四位有效数字，得到 $1.124 \\times 10^{-5}$ 秒。限制单元是单元2，因为它具有小单元宽度、大流速和高声速的组合。", "answer": "$$\\boxed{1.124 \\times 10^{-5}}$$", "id": "3373678"}, {"introduction": "一个优秀的数值格式不仅应是稳定的，还必须尊重其所模拟的物理定律的基本对称性。本练习 [@problem_id:3373731] 提供了一个测试伽利略不变性的实用框架，通过模拟一个平流输运的涡旋来完成。通过比较不同整体速度下的数值耗散，你可以验证所用的离散格式是否能正确处理参考系的变化，这是衡量格式物理保真度的重要指标。", "problem": "构建一个完整的、可运行的程序，通过在不同的均匀体积速度下输运一个光滑的等熵涡，并量化离散耗散在这些体积速度下的不变性，从而数值上验证可压缩欧拉方程的伽利略不变性。在二维空间中使用周期性边界，并采用一种有限体积、中心加标量耗散的通量格式。该格式通过相对于局部平均界面坐标系测量耗散，从而显式地满足伽利略不变性。\n\n控制方程为二维可压缩欧拉方程，适用于理想气体，\n$$\n\\frac{\\partial \\mathbf{U}}{\\partial t} + \\frac{\\partial \\mathbf{F}(\\mathbf{U})}{\\partial x} + \\frac{\\partial \\mathbf{G}(\\mathbf{U})}{\\partial y} = \\mathbf{0},\n$$\n其中守恒变量为 $\\mathbf{U} = [\\rho,\\ \\rho u,\\ \\rho v,\\ E]^{\\top}$，压力为 $p = (\\gamma - 1)\\left(E - \\tfrac{1}{2}\\rho(u^2+v^2)\\right)$，通量为\n$$\n\\mathbf{F}(\\mathbf{U}) = \n\\begin{bmatrix}\n\\rho u\\\\\n\\rho u^2 + p\\\\\n\\rho u v\\\\\nu(E + p)\n\\end{bmatrix},\\qquad\n\\mathbf{G}(\\mathbf{U}) = \n\\begin{bmatrix}\n\\rho v\\\\\n\\rho u v\\\\\n\\rho v^2 + p\\\\\nv(E + p)\n\\end{bmatrix}.\n$$\n\n在均匀笛卡尔网格上实现半离散有限体积法，采用周期性边界条件，每个界面上的数值通量形式如下：\n$$\n\\widehat{\\mathbf{F}}_{i+\\frac{1}{2},j} = \\frac{1}{2}\\left(\\mathbf{F}(\\mathbf{U}_{L}) + \\mathbf{F}(\\mathbf{U}_{R})\\right) - \\frac{1}{2}\\, s^{(x)}_{\\max}\\,(\\mathbf{U}_{R} - \\mathbf{U}_{L}),\n$$\n$$\n\\widehat{\\mathbf{G}}_{i,j+\\frac{1}{2}} = \\frac{1}{2}\\left(\\mathbf{G}(\\mathbf{U}_{B}) + \\mathbf{G}(\\mathbf{U}_{T})\\right) - \\frac{1}{2}\\, s^{(y)}_{\\max}\\,(\\mathbf{U}_{T} - \\mathbf{U}_{B}),\n$$\n其中 $\\mathbf{U}_{L}$ 和 $\\mathbf{U}_{R}$ 是 $x$ 方向界面左右的单元状态，而 $\\mathbf{U}_{B}$ 和 $\\mathbf{U}_{T}$ 是 $y$ 方向界面上下方的单元状态。标量耗散项使用相对于界面的特征速度来强制实现伽利略不变性：\n$$\ns^{(x)}_{\\max} = \\max\\left(\\left|u_{L} - u_{\\mathrm{ref}}\\right| + a_{L},\\ \\left|u_{R} - u_{\\mathrm{ref}}\\right| + a_{R}\\right),\\quad u_{\\mathrm{ref}} = \\frac{u_{L} + u_{R}}{2},\n$$\n$$\ns^{(y)}_{\\max} = \\max\\left(\\left|v_{B} - v_{\\mathrm{ref}}\\right| + a_{B},\\ \\left|v_{T} - v_{\\mathrm{ref}}\\right| + a_{T}\\right),\\quad v_{\\mathrm{ref}} = \\frac{v_{B} + v_{T}}{2},\n$$\n其中 $a = \\sqrt{\\gamma p/\\rho}$ 是当地声速。在界面处使用分段常数重构（一阶），以分离出伽利略不变耗散的影响。使用三阶强保稳龙格-库塔格式进行时间推进。\n\n使用由均匀体积流 $(U_0, 0)$ 对流的精确等熵涡解进行初始化，这是欧拉方程的标准光滑解。在无量纲变量中，理想气体常数等于1，设置环境状态为 $\\rho_{\\infty} = 1$, $p_{\\infty} = 1$, $T_{\\infty} = 1$，并选择涡强度 $\\beta  0$。令计算域为 $[0,L] \\times [0,L]$ 上的周期性区域，涡心位于 $(x_0,y_0)$。定义 $r^2 = (x-x_0)^2 + (y-y_0)^2$ 以及\n$$\nu(x,y) = U_0 - \\frac{\\beta}{2\\pi}\\exp\\!\\left(\\frac{1 - r^2}{2}\\right)(y - y_0),\\qquad\nv(x,y) = \\frac{\\beta}{2\\pi}\\exp\\!\\left(\\frac{1 - r^2}{2}\\right)(x - x_0),\n$$\n$$\nT(x,y) = 1 - \\frac{(\\gamma - 1)\\beta^2}{8\\gamma\\pi^2}\\exp\\!\\left(1 - r^2\\right),\\qquad\n\\rho(x,y) = T(x,y)^{\\frac{1}{\\gamma - 1}},\\qquad\np(x,y) = \\rho(x,y)^{\\gamma},\n$$\n$$\nE(x,y) = \\frac{p(x,y)}{\\gamma - 1} + \\frac{1}{2}\\rho(x,y)\\left(u(x,y)^2 + v(x,y)^2\\right).\n$$\n该精确解在 $x$ 方向上以速度 $U_0$ 平移而不发生畸变。\n\n选择参数 $\\gamma = 1.4$, $L = 10$, $(x_0,y_0) = (5,5)$, $\\beta = 5$，最终时间 $T_{\\mathrm{final}} = 2$，以及一个 $N_x = 64$, $N_y = 64$ 单元的均匀网格。使用库朗-弗里德里希斯-列维（CFL）数 $\\mathrm{CFL} = 0.3$ 来选择时间步长\n$$\n\\Delta t = \\mathrm{CFL}\\cdot \\min\\!\\left(\\frac{\\Delta x}{\\max |u| + a},\\ \\frac{\\Delta y}{\\max |v| + a}\\right),\n$$\n该步长根据测试组速度中的最坏初始情况保守地计算，以确保所有运行中的 $\\Delta t$ 都相同；然后选择一个整数步数，使总时间恰好等于 $T_{\\mathrm{final}}$。\n\n定义在时间 $t$ 的扰动动能（不包括均匀体积流）为\n$$\nK'(t;U_0) = \\iint \\frac{1}{2}\\,\\rho(x,y,t)\\left(\\left(u(x,y,t) - U_0\\right)^2 + v(x,y,t)^2\\right)\\,dx\\,dy.\n$$\n令分数耗散为\n$$\n\\alpha(U_0) = \\frac{K'(0;U_0) - K'(T_{\\mathrm{final}};U_0)}{K'(0;U_0)}.\n$$\n离散化的伽利略不变性意味着，对于不同的 $U_0$ 值，$\\alpha(U_0)$ 应该相同，除了数值时间积分和舍入误差的影响。\n\n实现程序以：\n- 按规定组装具有伽利略不变标量耗散的有限体积更新。\n- 为每个体积速度初始化等熵涡，并使用相同的 $\\Delta t$ 将其演化到 $T_{\\mathrm{final}}$。\n- 使用梯形法则等效的单元积分（即，将单元总和乘以 $\\Delta x\\,\\Delta y$）为每个案例计算 $\\alpha(U_0)$。\n\n测试组：\n- 体积速度 $U_0 \\in \\{\\,0.0,\\ 0.5,\\ -0.5,\\ 1.5\\,\\}$。\n\n要求的最终输出：\n- 你的程序应生成一行输出，其中包含一个以方括号括起来的、逗号分隔的 Python 风格浮点数列表，使用科学记数法，小数点后保留 $6$ 位数字。\n- 对于给定顺序的每个测试案例，输出绝对差\n$$\nd(U_0) = \\big|\\alpha(U_0) - \\alpha(0.0)\\big|.\n$$\n- 因此，输出格式必须为 $[d(0.0),d(0.5),d(-0.5),d(1.5)]$，每个条目使用字符串格式说明符 $\\mathtt{\\texttt{\\%.6e}}$ 进行格式化。\n\n单位和角度：\n- 所有量都是无量纲的。不使用角度单位。\n\n你的实现必须是自包含的，不需要任何输入，并遵守指定的输出格式。答案值为浮点数。", "solution": "用户提供了一个在计算流体力学领域科学上合理且适定的问题。任务是数值上验证一个特定的有限体积格式对二维可压缩欧拉方程的伽利略不变性。这将通过在不同体积速度下模拟等熵涡的对流并比较数值耗散来完成。\n\n### 1. 控制方程与离散化\n\n该问题由守恒形式的二维可压缩欧拉方程控制：\n$$\n\\frac{\\partial \\mathbf{U}}{\\partial t} + \\frac{\\partial \\mathbf{F}(\\mathbf{U})}{\\partial x} + \\frac{\\partial \\mathbf{G}(\\mathbf{U})}{\\partial y} = \\mathbf{0}\n$$\n其中 $\\mathbf{U} = [\\rho, \\rho u, \\rho v, E]^{\\top}$ 是守恒变量（密度、动量分量和总能量密度）的向量。压力 $p$ 由理想气体状态方程给出，$p = (\\gamma - 1)\\left(E - \\frac{1}{2}\\rho(u^2+v^2)\\right)$。通量向量 $\\mathbf{F}(\\mathbf{U})$ 和 $\\mathbf{G}(\\mathbf{U})$ 是问题描述中指定的状态变量的函数。\n\n在一个大小为 $N_x \\times N_y$、单元尺寸为 $\\Delta x \\times \\Delta y$ 的均匀笛卡尔网格上采用半离散有限体积法。空间导数通过单元界面上数值通量的散度来近似，从而得到一个关于单元平均状态 $\\mathbf{U}_{i,j}$ 的常微分方程组：\n$$\n\\frac{d\\mathbf{U}_{i,j}}{dt} = -\\frac{1}{\\Delta x}\\left(\\widehat{\\mathbf{F}}_{i+\\frac{1}{2},j} - \\widehat{\\mathbf{F}}_{i-\\frac{1}{2},j}\\right) - \\frac{1}{\\Delta y}\\left(\\widehat{\\mathbf{G}}_{i,j+\\frac{1}{2}} - \\widehat{\\mathbf{G}}_{i,j-\\frac{1}{2}}\\right)\n$$\n使用分段常数重构（一种一阶方法），这意味着每个单元内的状态被假定为均匀的，因此界面左右的状态就是相邻单元的状态，即 $\\mathbf{U}_L = \\mathbf{U}_{i,j}$ 和 $\\mathbf{U}_R = \\mathbf{U}_{i+1,j}$。\n\n### 2. 伽利略不变数值通量\n\n一个物理系统的动力学与观察者惯性参考系的恒定速度无关。这就是伽利略不变性原理。一个用于此类系统的数值格式在理想情况下应保持此属性；否则，仅仅改变体积速度就可能改变数值解的定性特征，例如人工耗散的量。\n\n指定的数值通量是一种中心通量外加一个标量耗散项，是一种人工粘性或Lax-Friedrichs型通量。对于 $x$ 方向，它表示为：\n$$\n\\widehat{\\mathbf{F}}_{i+\\frac{1}{2},j} = \\frac{1}{2}\\left(\\mathbf{F}(\\mathbf{U}_{L}) + \\mathbf{F}(\\mathbf{U}_{R})\\right) - \\frac{1}{2} s^{(x)}_{\\max} (\\mathbf{U}_{R} - \\mathbf{U}_{L})\n$$\n实现伽利略不变性的关键在于耗散系数 $s^{(x)}_{\\max}$ 的定义。标准的Lax-Friedrichs格式可能会使用 $s^{(x)}_{\\max} = \\max(|u_L|+a_L, |u_R|+a_R)$，这不是伽利略不变的，因为绝对速度 $u_L$ 和 $u_R$ 会随参考系而改变。\n\n问题指定了一种不变的形式：\n$$\ns^{(x)}_{\\max} = \\max\\left(\\left|u_{L} - u_{\\mathrm{ref}}\\right| + a_{L},\\ \\left|u_{R} - u_{\\mathrm{ref}}\\right| + a_{R}\\right), \\quad \\text{with } u_{\\mathrm{ref}} = \\frac{u_{L} + u_{R}}{2}\n$$\n当地声速 $a = \\sqrt{\\gamma p/\\rho}$ 是一个热力学性质，本身就是伽利略不变的。速度项 $|u_L - u_{\\mathrm{ref}}|$ 和 $|u_R - u_{\\mathrm{ref}}|$ 也是不变的。为了看到这一点，考虑一个以恒定速度 $U_0$ 移动的加速参考系。新参考系中的速度为 $u' = u - U_0$。参考速度变为 $u'_{\\mathrm{ref}} = (u'_L + u'_R)/2 = ((u_L-U_0) + (u_R-U_0))/2 = u_{\\mathrm{ref}} - U_0$。因此，差值保持不变：$u'_L - u'_{\\mathrm{ref}} = (u_L - U_0) - (u_{\\mathrm{ref}} - U_0) = u_L - u_{\\mathrm{ref}}$。\n一个简单的代数变换表明 $|u_L - u_{\\mathrm{ref}}| = |u_R - u_{\\mathrm{ref}}| = \\frac{1}{2}|u_R - u_L|$。因此，耗散系数的表达式简化为：\n$$\ns^{(x)}_{\\max} = \\frac{1}{2}|u_R - u_L| + \\max(a_L, a_R)\n$$\n这种形式明确地只依赖于跨界面的速度差和热力学量，所有这些都是伽利略不变的。对称的论证适用于 $y$ 方向的通量。\n\n### 3. 初始条件与时间演化\n\n初始条件是一个等熵涡，它是欧拉方程的一个精确、光滑的解，以恒定速度平移而不改变其形状或强度。这使其成为理想的测试案例，因为在数值模拟中涡的任何衰减都是由格式的耗散引起的。通过叠加不同的体积速度 $(U_0, 0)$ 并在固定的时间 $T_{\\mathrm{final}}$ 内运行模拟，我们可以测量耗散如何随参考系变化。\n\n时间积分使用三阶强保稳龙格-库塔（SSP-RK3）格式。为确保测试案例之间的公平比较，所有模拟都使用一个固定的时间步长 $\\Delta t$。这个 $\\Delta t$ 是基于一个全局CFL条件计算的，考虑了在所有初始速度配置（$U_0 \\in \\{0.0, 0.5, -0.5, 1.5\\}$）中整个域上的最大特征波速 $(\\max(|u|+a), \\max(|v|+a))$。选择时间步数，以使总模拟时间恰好为 $T_{\\mathrm{final}}$。\n\n### 4. 验证与实现策略\n\n为了量化数值耗散，我们测量扰动动能 $K'(t; U_0)$ 的衰减，该能量不包括体积流的动能。模拟时间内的分数耗散为\n$$\n\\alpha(U_0) = \\frac{K'(0;U_0) - K'(T_{\\mathrm{final}};U_0)}{K'(0;U_0)}\n$$\n如果格式是完美的伽利略不变，那么对于所有的 $U_0$，$\\alpha(U_0)$ 都应该相同。我们通过计算 $d(U_0) = |\\alpha(U_0) - \\alpha(0.0)|$ 来衡量与此理想情况的偏差。$d(U_0)$ 的小值将证实所实现方法的近似不变性。\n\n实现将按以下结构组织：\n1.  定义所有物理和数值参数。设置计算网格。\n2.  计算全局保守的时间步长 $\\Delta t$ 和所需的步数。\n3.  遍历测试组中的每个体积速度 $U_0$。\n4.  对于每个 $U_0$：\n    a. 生成初始状态数组 $\\mathbf{U}(t=0)$。\n    b. 计算并存储初始扰动动能 $K'(0; U_0)$。\n    c. 使用SSP-RK3积分器将系统演化至 $T_{\\mathrm{final}}$。积分器的核心是计算右端项（空间残差）的函数，这涉及伽利略不变数值通量的向量化计算。周期性边界条件通过 `numpy.roll` 高效处理。\n    d. 计算最终扰动动能 $K'(T_{\\mathrm{final}}; U_0)$。\n    e. 计算分数耗散 $\\alpha(U_0)$。\n5.  循环结束后，为每个案例计算最终度量 $d(U_0)$，并按指定格式打印结果。", "answer": "```python\n# 完整的、可运行的 Python 3 代码在此处。\n# 导入必须遵守指定的执行环境。\nimport numpy as np\nimport math\n\ndef solve():\n    \"\"\"\n    Main function to set up and run the Galilean invariance test for the Euler equations.\n    \"\"\"\n    # --- Problem Parameters ---\n    GAMMA = 1.4\n    L = 10.0\n    X0, Y0 = 5.0, 5.0\n    BETA = 5.0\n    T_FINAL = 2.0\n    NX, NY = 64, 64\n    CFL = 0.3\n    U0_CASES = [0.0, 0.5, -0.5, 1.5]\n\n    # --- Derived Parameters and Grid Setup ---\n    DX = L / NX\n    DY = L / NY\n    X = np.linspace(0 + DX/2, L - DX/2, NX)\n    Y = np.linspace(0 + DY/2, L - DY/2, NY)\n    GRID_X, GRID_Y = np.meshgrid(X, Y)\n\n    # --- Helper Functions ---\n    def get_primitives(U):\n        \"\"\"\n        Decode primitive variables [rho, u, v, p, a] from the conservative state vector U.\n        \"\"\"\n        rho = U[..., 0]\n        u = U[..., 1] / rho\n        v = U[..., 2] / rho\n        E = U[..., 3]\n        p = (GAMMA - 1.0) * (E - 0.5 * rho * (u**2 + v**2))\n        a = np.sqrt(GAMMA * p / rho)\n        return rho, u, v, p, a\n\n    def get_fluxes(U, primitives):\n        \"\"\"\n        Calculate the Euler fluxes F(U) and G(U).\n        \"\"\"\n        rho, u, v, p, _ = primitives\n        E = U[..., 3]\n        \n        F = np.zeros_like(U)\n        F[..., 0] = rho * u\n        F[..., 1] = rho * u**2 + p\n        F[..., 2] = rho * u * v\n        F[..., 3] = u * (E + p)\n        \n        G = np.zeros_like(U)\n        G[..., 0] = rho * v\n        G[..., 1] = rho * u * v\n        G[..., 2] = rho * v**2 + p\n        G[..., 3] = v * (E + p)\n        \n        return F, G\n\n    def get_initial_state(U0):\n        \"\"\"\n        Initialize the isentropic vortex with a given bulk velocity U0.\n        \"\"\"\n        r_sq = (GRID_X - X0)**2 + (GRID_Y - Y0)**2\n        \n        exp_factor = np.exp((1.0 - r_sq) / 2.0)\n        u_prime = - (BETA / (2.0 * math.pi)) * exp_factor * (GRID_Y - Y0)\n        v_prime = (BETA / (2.0 * math.pi)) * exp_factor * (GRID_X - X0)\n        \n        u = U0 + u_prime\n        v = v_prime\n        \n        T = 1.0 - ((GAMMA - 1.0) * BETA**2) / (8.0 * GAMMA * math.pi**2) * np.exp(1.0 - r_sq)\n        rho = T**(1.0 / (GAMMA - 1.0))\n        p = rho**GAMMA\n        \n        E = p / (GAMMA - 1.0) + 0.5 * rho * (u**2 + v**2)\n        \n        U_init = np.zeros((NY, NX, 4), dtype=np.float64)\n        U_init[..., 0] = rho\n        U_init[..., 1] = rho * u\n        U_init[..., 2] = rho * v\n        U_init[..., 3] = E\n        \n        return U_init\n\n    def get_rhs(U):\n        \"\"\"\n        Calculates the right-hand side of the semi-discrete finite-volume formulation.\n        This corresponds to the negative divergence of the numerical flux.\n        \"\"\"\n        primitives = get_primitives(U)\n        F_flux, G_flux = get_fluxes(U, primitives)\n\n        # --- X-direction fluxes ---\n        U_R = np.roll(U, -1, axis=1)\n        _, u_L, _, _, a_L = primitives\n        _, u_R, _, _, a_R = get_primitives(U_R)\n        F_L = F_flux\n        F_R = np.roll(F_flux, -1, axis=1)\n        \n        s_max_x = 0.5 * np.abs(u_R - u_L) + np.maximum(a_L, a_R)\n        s_max_x = s_max_x[..., np.newaxis]\n        F_hat = 0.5 * (F_L + F_R) - 0.5 * s_max_x * (U_R - U)\n        \n        # --- Y-direction fluxes ---\n        U_T = np.roll(U, -1, axis=0)\n        _, _, v_B, _, a_B = primitives\n        _, _, v_T, _, a_T = get_primitives(U_T)\n        G_B = G_flux\n        G_T = np.roll(G_flux, -1, axis=0)\n        \n        s_max_y = 0.5 * np.abs(v_T - v_B) + np.maximum(a_B, a_T)\n        s_max_y = s_max_y[..., np.newaxis]\n        G_hat = 0.5 * (G_B + G_T) - 0.5 * s_max_y * (U_T - U)\n\n        # --- Divergence of fluxes ---\n        F_hat_imh = np.roll(F_hat, 1, axis=1)\n        G_hat_jmh = np.roll(G_hat, 1, axis=0)\n        \n        rhs = - (F_hat - F_hat_imh) / DX - (G_hat - G_hat_jmh) / DY\n        return rhs\n\n    def compute_perturbation_kinetic_energy(U, U0):\n        \"\"\"\n        Calculates the total perturbation kinetic energy over the domain.\n        \"\"\"\n        rho, u, v, _, _ = get_primitives(U)\n        integrand = 0.5 * rho * ((u - U0)**2 + v**2)\n        return np.sum(integrand) * DX * DY\n\n    # 1. Determine the global time step from the worst-case scenario\n    max_wave_speed = 0.0\n    for u0 in U0_CASES:\n        U_init = get_initial_state(u0)\n        _, u, v, _, a = get_primitives(U_init)\n        max_wave_speed = max(max_wave_speed, np.max(np.abs(u) + a), np.max(np.abs(v) + a))\n\n    dt_cfl = CFL * min(DX, DY) / max_wave_speed\n    num_steps = int(np.ceil(T_FINAL / dt_cfl))\n    dt = T_FINAL / num_steps\n    \n    alpha_results = {}\n\n    # 2. Run simulation for each case\n    for u0 in U0_CASES:\n        U = get_initial_state(u0)\n        K_initial = compute_perturbation_kinetic_energy(U, u0)\n        \n        # SSP-RK3 Time Integration\n        for _ in range(num_steps):\n            rhs1 = get_rhs(U)\n            U1 = U + dt * rhs1\n            \n            rhs2 = get_rhs(U1)\n            U2 = 0.75 * U + 0.25 * (U1 + dt * rhs2)\n            \n            rhs3 = get_rhs(U2)\n            U = (1.0/3.0) * U + (2.0/3.0) * (U2 + dt * rhs3)\n            \n        K_final = compute_perturbation_kinetic_energy(U, u0)\n        \n        alpha = (K_initial - K_final) / K_initial\n        alpha_results[u0] = alpha\n        \n    # 3. Compute the final metric and format output\n    alpha_0 = alpha_results[0.0]\n    d_values = [abs(alpha_results[u0] - alpha_0) for u0 in U0_CASES]\n    \n    formatted_results = [f\"{val:.6e}\" for val in d_values]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "3373731"}, {"introduction": "从验证转向构建，本练习关注如何设计出既能精确捕捉间断（如激波），又足够鲁棒以处理极端条件（如低压或低密度）而不会产生非物理结果的求解器。这项高级实践 [@problem_id:3373670] 融合了理论与实现，要求你构建一个保持正性的Roe格式，这是许多现代CFD代码核心的关键组成部分。通过这个挑战，你将深入理解近似黎曼求解器的复杂性与精妙之处。", "problem": "考虑守恒形式的一维可压缩无粘流欧拉方程，\n$$\n\\frac{\\partial}{\\partial t}\n\\begin{bmatrix}\n\\rho \\\\\n\\rho u \\\\\nE\n\\end{bmatrix}\n+\n\\frac{\\partial}{\\partial x}\n\\begin{bmatrix}\n\\rho u \\\\\n\\rho u^2 + p \\\\\nu (E + p)\n\\end{bmatrix}\n= 0,\n$$\n其中 $\\rho$ 是质量密度，$u$ 是速度，$E$ 是总能量密度，$p$ 是热力学压力。总能量满足 $E = \\rho e + \\tfrac{1}{2} \\rho u^2$，其中 $e$ 是比内能。设热力学封闭关系由凸状态方程 (EOS) $p = p(\\rho, e)$ 给出，凸性意味着比亥姆霍茲自由能的海森矩阵是正定的，这保证了严格双曲性和熱力学声速的正性。对于任何 EOS，比焓定义为 $h = e + \\tfrac{p}{\\rho}$，总焓为 $H = \\tfrac{E + p}{\\rho} = h + \\tfrac{1}{2} u^2$。\n\n将正标量的对数平均值定义为\n$$\nL(a,b) = \n\\begin{cases}\n\\dfrac{b - a}{\\ln b - \\ln a},  a \\neq b,\\quad a  0,\\ b  0, \\\\\na,  a = b,\\quad a  0.\n\\end{cases}\n$$\n\n您的任务如下。\n\n1) 从上述守恒律和热力学定义出发，为通用凸 EOS 构建一个 Roe 型近似 Riemann 求解器，该求解器对热力学量使用对数平均以保持正性。具体来说：\n- 基于特征值 $\\lambda_1 = u - a$，$\\lambda_2 = u$，$\\lambda_3 = u + a$（其中 $a$ 是满足 $a^2 = \\left(\\tfrac{\\partial p}{\\partial \\rho}\\right)_{s}$ 的热力学声速）推导特征分解，并用 $u$、$H$ 和 $a$ 表示相应的右特征向量。\n- 将 Roe 型平均状态定义为\n$$\n\\tilde{u} = \\frac{\\sqrt{\\rho_L}\\, u_L + \\sqrt{\\rho_R}\\, u_R}{\\sqrt{\\rho_L} + \\sqrt{\\rho_R}},\\quad \n\\tilde{H} = \\frac{\\sqrt{\\rho_L}\\, H_L + \\sqrt{\\rho_R}\\, H_R}{\\sqrt{\\rho_L} + \\sqrt{\\rho_R}},\n$$\n并在需要时，于波强度公式中使用密度的对数平均 $\\tilde{\\rho} = L(\\rho_L,\\rho_R)$ 以强制保持正性。对于 Roe 状态下的热力学声速平方，要求以下特定于 EOS 的封闭关系：\n- 对于理想气体 EOS，$p = (\\gamma - 1)\\rho e$，推导出 $a^2 = \\gamma \\tfrac{p}{\\rho}$ 并证明在 Roe 状态下，\n$$\n\\tilde{a}^2 = (\\gamma - 1)\\left(\\tilde{H} - \\tfrac{1}{2} \\tilde{u}^2\\right).\n$$\n- 对于刚性气体 EOS，$p = (\\gamma - 1)\\rho e - \\gamma p_\\infty$，推导出 $a^2 = \\gamma \\tfrac{p + p_\\infty}{\\rho}$ 并证明在 Roe 状态下，\n$$\n\\tilde{a}^2 = (\\gamma - 1)\\left(\\tilde{H} - \\tfrac{1}{2} \\tilde{u}^2\\right) - (\\gamma - 1)\\frac{p_\\infty}{\\tilde{\\rho}}.\n$$\n使用上述内容构建 Roe 通量，并对特征值的绝对值应用 Harten–Hyman 熵修正。\n\n2) 证明对于满足上述理想气体和刚性气体情况封闭关系的任何凸 EOS，有限体积更新\n$$\nU_i^{n+1} = U_i^n - \\frac{\\Delta t}{\\Delta x}\\left(F_{i+1/2} - F_{i-1/2}\\right),\n$$\n在 $F_{i+1/2}$ 由带有 Harten–Hyman 熵修正的 Roe 型求解器计算，并在检测到退化时采用一致的保正性 Harten–Lax–van Leer–Einfeldt (HLLE) 通量作为备用方案的情况下，该更新在 Courant–Friedrichs–Lewy (CFL) 条件 $0  \\text{CFL} \\leq 0.5$ 下保持 $\\rho$ 和 $e$ 的非负性。证明熵修正与正性证明的兼容性，即熵修正仅修改特征速度的绝对值，其方式能维持通量的凸性，且不会破坏 HLLE 备用方案的正性保证。\n\n3) 实现带有对数平均和熵修正的 Roe 型求解器，并在表现出强温度梯度的激波管问题上进行测试。全程使用无量纲单位。在单位长度域 $x \\in [0,1]$ 上采用透射边界条件，初始间断位于 $x = 0.5$。\n\n使用以下测试套件：\n- 测试用例 A (理想气体): $\\gamma = 1.4$; 左态 $(\\rho_L, u_L, p_L) = (1.0, 0.0, 100.0)$; 右态 $(\\rho_R, u_R, p_R) = (0.125, 0.0, 0.1)$; 网格单元数 $N = 200$; 最终时间 $t_{\\text{end}} = 0.003$; CFL $= 0.4$。\n- 测试用例 B (刚性气体): $\\gamma = 1.67$, $p_\\infty = 1.0$; 左态 $(\\rho_L, u_L, p_L) = (1.0, 0.0, 200.0)$; 右态 $(\\rho_R, u_R, p_R) = (0.5, 0.0, 10.0)$; 网格单元数 $N = 200$; 最终时间 $t_{\\text{end}} = 0.003$; CFL $= 0.4$。\n- 测试用例 C (近真空稀疏波, 理想气体): $\\gamma = 1.4$; 左态 $(\\rho_L, u_L, p_L) = (0.1, 0.0, 10^{-6})$; 右态 $(\\rho_R, u_R, p_R) = (1.0, 0.0, 1.0)$; 网格单元数 $N = 200$; 最终时间 $t_{\\text{end}} = 0.002$; CFL $= 0.4$。\n\n对于每个测试用例，在 $t_{\\text{end}}$ 时计算：\n- 最小密度 $\\min_i \\rho_i$。\n- 最小压力 $\\min_i p_i$。\n- 最小内能 $\\min_i e_i$。\n- 因检测到退化或可能失去正性而激活 HLLE 备用方案的界面总数。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，每个测试用例的结果都按上述顺序报告为一个包含四个量的列表。例如，输出格式应如下所示\n$$\n[[\\text{min}\\ \\rho_A, \\text{min}\\ p_A, \\text{min}\\ e_A, \\text{count}_A],[\\text{min}\\ \\rho_B, \\text{min}\\ p_B, \\text{min}\\ e_B, \\text{count}_B],[\\text{min}\\ \\rho_C, \\text{min}\\ p_C, \\text{min}\\ e_C, \\text{count}_C]].\n$$\n所有值都是无量纲的，浮点数量必须以标准十进制表示法打印。不需要进行物理单位转换。", "solution": "用户提供了一个有效但要求极高的计算流体力学问题。该问题要求对一维欧拉方程推导、进行理论论证并实现一个保正的 Roe 型数值格式。\n\n根据问题陈述的要求，解答将分三部分呈现。\n\n### 第 1 部分：Roe 型求解器的构建\n\n我们从守恒形式的一维欧拉方程开始：\n$$\n\\frac{\\partial \\mathbf{U}}{\\partial t} + \\frac{\\partial \\mathbf{F}(\\mathbf{U})}{\\partial x} = 0\n$$\n其中 $\\mathbf{U}$ 是守恒变量向量，$\\mathbf{F}(\\mathbf{U})$ 是通量向量：\n$$\n\\mathbf{U} = \\begin{bmatrix} \\rho \\\\ \\rho u \\\\ E \\end{bmatrix}, \\quad \\mathbf{F} = \\begin{bmatrix} \\rho u \\\\ \\rho u^2 + p \\\\ u(E+p) \\end{bmatrix}\n$$\n该系统通过状态方程 (EOS) $p = p(\\rho, e)$ 封闭，其中比内能 $e$ 通过 $E = \\rho e + \\frac{1}{2}\\rho u^2$ 与总能量密度 $E$ 相关联。\n\n#### **特征分解**\n欧拉方程的拟线性形式为 $\\frac{\\partial \\mathbf{U}}{\\partial t} + \\mathbf{A}(\\mathbf{U}) \\frac{\\partial \\mathbf{U}}{\\partial x} = 0$，其中 $\\mathbf{A}(\\mathbf{U}) = \\frac{\\partial \\mathbf{F}}{\\partial \\mathbf{U}}$ 是通量雅可比矩阵。$\\mathbf{A}$ 的特征值是系统的特征速度。对于欧拉方程，它们是：\n$$\n\\lambda_1 = u - a, \\quad \\lambda_2 = u, \\quad \\lambda_3 = u + a\n$$\n其中 $a$ 是热力学声速，定义为 $a^2 = \\left(\\frac{\\partial p}{\\partial \\rho}\\right)_s$，其中 $s$ 是比熵。相应的右特征向量 $\\mathbf{r}_k$（对于 $k=1,2,3$）是使 $\\mathbf{A}$ 对角化的矩阵 $\\mathbf{R}$ 的列，使得 $\\mathbf{A} = \\mathbf{R} \\mathbf{\\Lambda} \\mathbf{R}^{-1}$。以速度 $u$、总焓 $H = (E+p)/\\rho$ 和声速 $a$ 表示的右特征向量的标准选择是：\n$$\n\\mathbf{r}_1 = \\begin{bmatrix} 1 \\\\ u - a \\\\ H - ua \\end{bmatrix}, \\quad\n\\mathbf{r}_2 = \\begin{bmatrix} 1 \\\\ u \\\\ \\frac{1}{2}u^2 \\end{bmatrix}, \\quad\n\\mathbf{r}_3 = \\begin{bmatrix} 1 \\\\ u + a \\\\ H + ua \\end{bmatrix}\n$$\n特征向量 $\\mathbf{r}_2$ 代表熵波，而 $\\mathbf{r}_1$ 和 $\\mathbf{r}_3$ 分别代表向左和向右传播的声波。\n\n#### **Roe 型平均状态**\nRoe 求解器基于在左态 $\\mathbf{U}_L$ 和右态 $\\mathbf{U}_R$ 之间找到一个平均状态 $\\tilde{\\mathbf{U}}$，使得 Roe 条件得到满足：\n$$\n\\mathbf{F}(\\mathbf{U}_R) - \\mathbf{F}(\\mathbf{U}_L) = \\mathbf{A}(\\tilde{\\mathbf{U}})(\\mathbf{U}_R - \\mathbf{U}_L)\n$$\n此条件确保如果初始数据由单个间断分隔的两个状态组成，则近似 Riemann 问题的解是精确的。问题将 Roe 平均速度 $\\tilde{u}$ 和总焓 $\\tilde{H}$ 定义为：\n$$\n\\tilde{u} = \\frac{\\sqrt{\\rho_L}\\, u_L + \\sqrt{\\rho_R}\\, u_R}{\\sqrt{\\rho_L} + \\sqrt{\\rho_R}}, \\quad\n\\tilde{H} = \\frac{\\sqrt{\\rho_L}\\, H_L + \\sqrt{\\rho_R}\\, H_R}{\\sqrt{\\rho_L} + \\sqrt{\\rho_R}}\n$$\n这些特定的平均值最初是由 Roe 为理想气体 EOS 构建的，以满足 Roe 条件。对于更一般的 EOS，需要额外的平均值或封闭关系。问题指定在需要时对密度使用对数平均值 $\\tilde{\\rho} = L(\\rho_L, \\rho_R)$。\n\n#### **特定于 EOS 的声速封闭关系**\nRoe 平均状态下的声速 $\\tilde{a}$ 必须被一致地定义。\n\n**理想气体 EOS：**\nEOS 为 $p = (\\gamma-1)\\rho e$。比焓为 $h = e + p/\\rho = \\frac{p}{(\\gamma-1)\\rho} + \\frac{p}{\\rho} = \\frac{\\gamma p}{(\\gamma-1)\\rho}$。声速由 $a^2 = (\\partial p / \\partial \\rho)_s$ 推导。对于理想气体，等熵关系为 $p = K\\rho^\\gamma$。因此，\n$$\na^2 = \\frac{\\partial}{\\partial \\rho}(K\\rho^\\gamma) = K\\gamma\\rho^{\\gamma-1} = \\frac{p}{\\rho^\\gamma}\\gamma\\rho^{\\gamma-1} = \\gamma \\frac{p}{\\rho}\n$$\n此关系将声速与热力学状态变量联系起来。根据总焓的定义 $H = h + \\frac{1}{2}u^2$，我们有 $H - \\frac{1}{2}u^2 = h = \\frac{\\gamma p}{(\\gamma-1)\\rho} = \\frac{a^2}{\\gamma-1}$。因此，$a^2 = (\\gamma-1)(H - \\frac{1}{2}u^2)$。此关系对任何物理状态都成立。对于理想气体情况下专门构建的 Roe 平均值 $\\tilde{u}$ 和 $\\tilde{H}$，可以证明，将 Roe 平均声速平方定义为\n$$\n\\tilde{a}^2 = (\\gamma-1)\\left(\\tilde{H} - \\frac{1}{2}\\tilde{u}^2\\right)\n$$\n恰好满足 Roe 条件。这个表达式至关重要，因为它允许直接从 Roe 平均量 $\\tilde{u}$ 和 $\\tilde{H}$ 计算 $\\tilde{a}^2$。\n\n**刚性气体 EOS：**\nEOS 为 $p = (\\gamma-1)\\rho e - \\gamma p_\\infty$。我们给出的形式是 $p = (\\gamma-1)\\rho e - \\gamma p_\\infty$。比焓为 $h=e+p/\\rho = \\frac{p+\\gamma p_\\infty}{\\rho(\\gamma-1)} + \\frac{p}{\\rho} = \\frac{\\gamma(p+p_\\infty)}{\\rho(\\gamma-1)}$。声速为 $a^2 = (\\partial p / \\partial \\rho)_s$。使用吉布斯关系 $dh = Tds + dp/\\rho$，对于等熵变化，$dp = \\rho dh$。对 $h$ 微分：\n$$\ndp = \\rho \\frac{\\gamma}{\\gamma-1} d\\left(\\frac{p+p_\\infty}{\\rho}\\right) = \\frac{\\rho\\gamma}{\\gamma-1}\\left(\\frac{dp}{\\rho} - \\frac{p+p_\\infty}{\\rho^2}d\\rho\\right) = \\frac{\\gamma}{\\gamma-1}dp - \\frac{\\gamma(p+p_\\infty)}{\\rho(\\gamma-1)}d\\rho\n$$\n重新整理各项以求 $dp/d\\rho$：\n$$\ndp\\left(1-\\frac{\\gamma}{\\gamma-1}\\right) = -\\frac{\\gamma(p+p_\\infty)}{\\rho(\\gamma-1)}d\\rho \\implies dp\\left(\\frac{-1}{\\gamma-1}\\right) = -\\frac{\\gamma(p+p_\\infty)}{\\rho(\\gamma-1)}d\\rho \\implies \\frac{dp}{d\\rho} = \\frac{\\gamma(p+p_\\infty)}{\\rho}\n$$\n因此，对于刚性气体 EOS，$a^2 = \\gamma \\frac{p+p_\\infty}{\\rho}$。\n对于通用 EOS，标准的 $u$ 和 $H$ 的 Roe 平均值不能保证 Roe 条件成立。问题指定了 Roe 平均声速的一个特定封闭关系：\n$$\n\\tilde{a}^2 = (\\gamma - 1)\\left(\\tilde{H} - \\tfrac{1}{2} \\tilde{u}^2\\right) - (\\gamma - 1)\\frac{p_\\infty}{\\tilde{\\rho}}\n$$\n其中 $\\tilde{\\rho} = L(\\rho_L, \\rho_R)$。这是来自现代文献（例如 Ismail  Roe, 2009）的一个专门结果，旨在为刚性气体 EOS 构建一个守恒格式，同时保持某些期望的性质。\n\n#### **带熵修正的数值通量**\n界面 $i+1/2$ 处的 Roe 数值通量由中心差分加上一个耗散项给出：\n$$\n\\mathbf{F}_{i+1/2} = \\frac{1}{2}\\left(\\mathbf{F}(\\mathbf{U}_L) + \\mathbf{F}(\\mathbf{U}_R)\\right) - \\frac{1}{2}\\sum_{k=1}^3 |\\tilde{\\lambda}_k|_\\delta \\tilde{\\alpha}_k \\tilde{\\mathbf{r}}_k\n$$\n波强度 $\\tilde{\\alpha}_k$ 是守恒变量跳跃量 $\\Delta \\mathbf{U} = \\mathbf{U}_R - \\mathbf{U}_L$ 在右特征向量基上的展开系数：$\\Delta \\mathbf{U} = \\sum_{k=1}^3 \\tilde{\\alpha}_k \\tilde{\\mathbf{r}}_k$。求解该系统得到 $\\tilde{\\alpha}_k$：\n\\begin{align*}\n\\tilde{\\alpha}_1 = \\frac{\\Delta p - \\tilde{\\rho} \\tilde{a} \\Delta u}{2\\tilde{a}^2} \\\\\n\\tilde{\\alpha}_2 = \\Delta\\rho - \\frac{\\Delta p}{\\tilde{a}^2} \\\\\n\\tilde{\\alpha}_3 = \\frac{\\Delta p + \\tilde{\\rho} \\tilde{a} \\Delta u}{2\\tilde{a}^2}\n\\end{align*}\n其中 $\\Delta p = p_R-p_L$，$\\Delta u = u_R-u_L$，$\\Delta\\rho = \\rho_R-\\rho_L$，并且 $\\tilde{\\rho}$ 取为对数平均值 $L(\\rho_L, \\rho_R)$ 以确保与保正框架的一致性。\n\n项 $|\\tilde{\\lambda}_k|_\\delta$ 表示带有熵修正的特征值的绝对值，以防止非物理膨胀激波。Harten-Hyman 熵修正应用于趋近于零的特征值：\n$$\n|\\lambda|_\\delta = \n\\begin{cases}\n\\dfrac{\\lambda^2 + \\delta^2}{2\\delta},  |\\lambda|  \\delta \\\\\n|\\lambda|,  |\\lambda| \\ge \\delta\n\\end{cases}\n$$\n阈值 $\\delta$ 必须仔细选择。一个常见的选择是将其与跨界面的特征速度传播范围联系起来，例如 $\\delta_k = \\max(0, \\lambda_k(\\mathbf{U}_R)-\\tilde{\\lambda}_k, \\tilde{\\lambda}_k-\\lambda_k(\\mathbf{U}_L))$。\n\n### 第 2 部分：有限体积格式的正性证明\n\n我们要证明有限体积更新\n$$\n\\mathbf{U}_i^{n+1} = \\mathbf{U}_i^n - \\frac{\\Delta t}{\\Delta x}\\left(\\mathbf{F}_{i+1/2} - \\mathbf{F}_{i-1/2}\\right)\n$$\n在 CFL 条件 $0  \\text{CFL} \\leq 0.5$ 下保持密度 $\\rho$ 和比内能 $e$ 的非负性。该格式采用所描述的 Roe 求解器，并有一个回退到 Harten-Lax-van Leer-Einfeldt (HLLE) 通量的机制。\n\n**关于保正性的论证：**\n该证明并不依赖于 Roe 求解器本身是保正的，因为它通常不是。相反，它依赖于 HLLE 求解器的性质，在特定条件下，格式会回退到 HLLE 求解器。\n\n1.  **HLLE 通量的正性：** HLLE 通量定义为：\n    $$\n    \\mathbf{F}^{HLLE} = \\frac{s_R \\mathbf{F}_L - s_L \\mathbf{F}_R + s_L s_R (\\mathbf{U}_R - \\mathbf{U}_L)}{s_R - s_L}\n    $$\n    其中 $s_L = \\min(0, \\lambda_{1,L}, \\lambda_{1,R})$ 和 $s_R = \\max(0, \\lambda_{3,L}, \\lambda_{3,R})$ 是界面处的最小和最大信号速度。一个公认的结论是，使用 HLLE 通量的一阶有限体积格式在 CFL 条件 $\\frac{\\Delta t}{\\Delta x} \\max(|s_L|, |s_R|) \\le 1$ 下，对密度和压力（因此也包括内能）都是保正的。该格式可以写成允许状态的凸组合，确保如果对所有单元 $\\rho^n > 0$ 和 $e^n > 0$，那么 $\\rho^{n+1} > 0$ 和 $e^{n+1} > 0$。\n\n2.  **回退机制：** 所提出的格式默认使用计算效率高的 Roe 求解器，但在任何检测到“退化或可能失去正性”的界面处切换到鲁棒的 HLLE 求解器。这必须实现为一组具体的条件。如果 Roe 平均状态是非物理的，例如计算出的声速平方 $\\tilde{a}^2$ 为负，则发生退化。如果界面邻近的状态具有非常低的密度或压力（这是数值失效的前兆），则检测到可能失去正性。因此，如果 $\\tilde{a}^2  0$，或者如果 $\\rho_i, \\rho_{i-1}, p_i,$ 或 $p_{i-1}$ 低于一个小的正阈值 $\\epsilon$，则实现将在界面 $(i-1/2)$ 切换到 HLLE。\n\n3.  **格式的整体正性：** 整个格式通过构造是保正的。对于任何单元更新，如果通量 $\\mathbf{F}_{i-1/2}$ 和 $\\mathbf{F}_{i+1/2}$ 是用 Roe 求解器计算的，那是因为局部状态被认为是“安全的”（非退化且不接近真空）。如果一个状态使得 Roe 通量更新可能违反正性，则会触发回退条件，相应的通量将使用可证明保正的 HLLE 格式重新计算。由于单元 $i$ 的更新仅取决于其相邻通量，确保这些通量是“安全的”（要么是在非临界状态上的 Roe，要么是 HLLE）保证了更新后状态 $\\mathbf{U}_i^{n+1}$ 的正性。\n\n4.  **CFL 条件和熵修正的兼容性：** 全局时间步长 $\\Delta t$ 必须满足所有界面的 CFL 条件，无论使用哪种通量。HLLE 的信号速度 ($s_L, s_R$) 总是物理特征速度的外包络，即 $|s_{L/R}| \\ge |\\lambda_k|$。因此，HLLE 的 CFL 条件通常比 Roe 的更严格。全局 CFL 数 $0.5$ 是一个保守的选择，它尊重了两种格式的稳定性限制。在文献（例如 Perthame  Shu, 1996）中，约束 CFL $\\le 0.5$ 被证明是某些类别的格式保正的充分条件，这增加了一层鲁棒性。\n\n    Harten-Hyman 熵修正修改了数值耗散项。当 $\\tilde{\\lambda}_k$ 很小时，它用一个稍大的值替换 $|\\tilde{\\lambda}_k|$。这*增加*了数值耗散量，使 Roe 通量在跨音速区域的行为更像高耗散（且高度稳定/正性）的 Lax-Friedrichs 通量。耗散的增加通常会加强格式的正性，因此熵修正不仅与保正目标兼容，而且对其有益。它不会以一种会使基于 HLLE 回退的论证失效的方式改变格式的基本结构。\n\n总而言之，该格式通过将“危险”界面的处理责任委托给已知的保正 HLLE 通量，并在足够严格的 CFL 条件下，保证了 $\\rho$ 和 $e$ 的非负性。\n\n### 第 3 部分：实现与测试\n\n如上所述的求解器是使用 Python 的 NumPy 库实现的。实现包括：\n-   用于在理想气体和刚性气体 EOS 下，在原始变量 $(\\rho, u, p)$ 和守恒变量 $(\\rho, \\rho u, E)$ 之间转换的函数。\n-   一个主时间步进循环，根据最大波速和给定的 CFL 数计算稳定的 $\\Delta t$。\n-   一个通量计算例程，循环遍历每个单元界面。在每个界面上，它计算 Roe 平均状态，并检查是否存在退化（$\\tilde{a}^2  0$）或低压/低密度条件。\n-   如果满足回退条件，则为该界面计算 HLLE 通量，并且计数器加一。\n-   否则，计算 Roe 通量，包括对声波的 Harten-Hyman 熵修正。\n-   通过将虚拟单元中的状态设置为最邻近的内部单元的状态来实现透射边界条件。\n-   程序运行三个指定的测试用例，并在最终时刻计算整个网格上的最小密度、最小压力和最小内能，以及 HLLE 回退激活的总次数。", "answer": "```python\nimport numpy as np\n\ndef log_mean(a, b):\n    \"\"\"Computes the logarithmic mean of two positive scalars.\"\"\"\n    if np.isclose(a, b):\n        return a\n    if a = 0 or b = 0:\n        # Fallback for safety, though should be avoided by physical states\n        return (a + b) / 2.0\n    return (b - a) / (np.log(b) - np.log(a))\n\ndef get_primitives(U, gamma, p_inf):\n    \"\"\"Converts conserved variables to primitive variables for a stiffened gas.\"\"\"\n    rho = U[0]\n    u = U[1] / rho\n    E = U[2]\n    e = E/rho - 0.5 * u**2\n    p = (gamma - 1) * rho * e - gamma * p_inf\n    return rho, u, p, e\n\ndef get_conserved(rho, u, p, gamma, p_inf):\n    \"\"\"Converts primitive variables to conserved variables for a stiffened gas.\"\"\"\n    e = (p + gamma * p_inf) / ((gamma - 1) * rho)\n    E = rho * e + 0.5 * rho * u**2\n    return np.array([rho, rho * u, E])\n\ndef get_flux(U, gamma, p_inf):\n    \"\"\"Computes the Euler flux vector from conserved variables.\"\"\"\n    rho, u, p, _ = get_primitives(U, gamma, p_inf)\n    E = U[2]\n    return np.array([rho * u, rho * u**2 + p, u * (E + p)])\n\ndef run_simulation(gamma, p_inf, state_L, state_R, N, t_end, CFL):\n    \"\"\"\n    Main function to run one shock tube simulation.\n    EOS: Stiffened Gas. Ideal Gas is a special case with p_inf = 0.\n    \"\"\"\n    # Grid setup\n    dx = 1.0 / N\n    x = np.linspace(-dx / 2, 1 + dx / 2, N + 2)\n    \n    # State vectors (with 1 ghost cell on each side)\n    U = np.zeros((3, N + 2))\n    rho_L, u_L, p_L = state_L\n    rho_R, u_R, p_R = state_R\n\n    # Initial conditions\n    U_L = get_conserved(rho_L, u_L, p_L, gamma, p_inf)\n    U_R = get_conserved(rho_R, u_R, p_R, gamma, p_inf)\n\n    mid_point_idx = np.where(x >= 0.5)[0][0]\n    U[:, :mid_point_idx] = U_L[:, np.newaxis]\n    U[:, mid_point_idx:] = U_R[:, np.newaxis]\n    \n    t = 0.0\n    hlle_fallback_count = 0\n\n    # Low-state threshold for HLLE fallback\n    LOW_DENSITY_THRESHOLD = 1e-9\n    LOW_PRESSURE_THRESHOLD = 1e-9\n\n    while t  t_end:\n        # Transmissive boundary conditions\n        U[:, 0] = U[:, 1]\n        U[:, -1] = U[:, -2]\n\n        # Calculate timestep dt from CFL condition\n        rho_vals, u_vals, p_vals, _ = get_primitives(U, gamma, p_inf)\n        # Avoid division by zero in sound speed calculation\n        safe_rho = np.maximum(rho_vals, LOW_DENSITY_THRESHOLD)\n        a_sq = gamma * (p_vals + p_inf) / safe_rho\n        a_vals = np.sqrt(np.maximum(a_sq, 0))\n        max_wave_speed = np.max(np.abs(u_vals) + a_vals)\n        \n        if max_wave_speed == 0:\n            dt = t_end - t\n        else:\n            dt = CFL * dx / max_wave_speed\n\n        if t + dt > t_end:\n            dt = t_end - t\n\n        # Compute fluxes at interfaces\n        fluxes = np.zeros((3, N + 1))\n        \n        for i in range(N + 1):\n            U_l, U_r = U[:, i], U[:, i+1]\n            rho_l, u_l, p_l, _ = get_primitives(U_l, gamma, p_inf)\n            rho_r, u_r, p_r, _ = get_primitives(U_r, gamma, p_inf)\n            \n            use_hlle = False\n            if rho_l  LOW_DENSITY_THRESHOLD or rho_r  LOW_DENSITY_THRESHOLD or \\\n               p_l  LOW_PRESSURE_THRESHOLD or p_r  LOW_PRESSURE_THRESHOLD:\n                use_hlle = True\n            \n            if not use_hlle:\n                # Roe Averages\n                sqrt_rho_l, sqrt_rho_r = np.sqrt(rho_l), np.sqrt(rho_r)\n                u_tilde = (sqrt_rho_l * u_l + sqrt_rho_r * u_r) / (sqrt_rho_l + sqrt_rho_r)\n                \n                E_l, E_r = U_l[2], U_r[2]\n                H_l = (E_l + p_l) / rho_l\n                H_r = (E_r + p_r) / rho_r\n                H_tilde = (sqrt_rho_l * H_l + sqrt_rho_r * H_r) / (sqrt_rho_l + sqrt_rho_r)\n\n                # Sound speed closure\n                if p_inf == 0.0: # Ideal Gas\n                    a_tilde_sq = (gamma - 1.0) * (H_tilde - 0.5 * u_tilde**2)\n                else: # Stiffened Gas\n                    rho_tilde_lm = log_mean(rho_l, rho_r)\n                    a_tilde_sq = (gamma - 1.0) * (H_tilde - 0.5 * u_tilde**2) - (gamma - 1.0) * p_inf / rho_tilde_lm\n\n                if a_tilde_sq = 0:\n                    use_hlle = True\n                else:\n                    a_tilde = np.sqrt(a_tilde_sq)\n                    \n                    # Eigenvalues  Entropy Fix (Harten-Hyman)\n                    lambda_tilde = np.array([u_tilde - a_tilde, u_tilde, u_tilde + a_tilde])\n                    \n                    a_l_sq = gamma * (p_l + p_inf) / rho_l\n                    a_r_sq = gamma * (p_r + p_inf) / rho_r\n                    a_l = np.sqrt(max(0, a_l_sq))\n                    a_r = np.sqrt(max(0, a_r_sq))\n\n                    lambda_L = np.array([u_l - a_l, u_l, u_l + a_l])\n                    lambda_R = np.array([u_r - a_r, u_r, u_r + a_r])\n                    \n                    delta = np.maximum(0., np.maximum(lambda_R - lambda_tilde, lambda_tilde - lambda_L))\n                    delta[1] = 0 # No fix for contact wave\n                    \n                    abs_lambda_tilde = np.abs(lambda_tilde)\n                    mask = abs_lambda_tilde  delta\n                    if np.any(mask):\n                        # Ensure no division by zero\n                        safe_delta = np.where(delta > 0, delta, 1.0)\n                        abs_lambda_tilde[mask] = (lambda_tilde[mask]**2 + safe_delta[mask]**2) / (2 * safe_delta[mask])\n                    \n                    # Wave strengths\n                    delta_p = p_r - p_l\n                    delta_u = u_r - u_l\n                    delta_rho = rho_r - rho_l\n                    rho_tilde_lm = log_mean(rho_l, rho_r)\n\n                    inv_a_sq = 1.0 / a_tilde_sq\n                    alpha_1 = 0.5 * (delta_p - rho_tilde_lm * a_tilde * delta_u) * inv_a_sq\n                    alpha_3 = 0.5 * (delta_p + rho_tilde_lm * a_tilde * delta_u) * inv_a_sq\n                    alpha_2 = delta_rho - (alpha_1 + alpha_3)\n                    \n                    # Right eigenvectors\n                    r1 = np.array([1, u_tilde - a_tilde, H_tilde - u_tilde * a_tilde])\n                    r2 = np.array([1, u_tilde, 0.5 * u_tilde**2])\n                    r3 = np.array([1, u_tilde + a_tilde, H_tilde + u_tilde * a_tilde])\n\n                    # Roe Flux\n                    flux_l = get_flux(U_l, gamma, p_inf)\n                    flux_r = get_flux(U_r, gamma, p_inf)\n                    \n                    dissipation = (abs_lambda_tilde[0] * alpha_1 * r1 +\n                                   abs_lambda_tilde[1] * alpha_2 * r2 +\n                                   abs_lambda_tilde[2] * alpha_3 * r3)\n                    \n                    fluxes[:, i] = 0.5 * (flux_l + flux_r) - 0.5 * dissipation\n\n            if use_hlle:\n                hlle_fallback_count += 1\n                # HLLE Flux\n                rho_l, u_l, p_l, _ = get_primitives(U_l, gamma, p_inf)\n                rho_r, u_r, p_r, _ = get_primitives(U_r, gamma, p_inf)\n                \n                a_l_sq = gamma * (p_l + p_inf) / rho_l if rho_l > 0 else 0\n                a_r_sq = gamma * (p_r + p_inf) / rho_r if rho_r > 0 else 0\n                a_l = np.sqrt(a_l_sq) if a_l_sq > 0 else 0\n                a_r = np.sqrt(a_r_sq) if a_r_sq > 0 else 0\n                \n                sL = min(u_l - a_l, u_r - a_r, 0.)\n                sR = max(u_l + a_l, u_r + a_r, 0.)\n                \n                flux_l = get_flux(U_l, gamma, p_inf)\n                flux_r = get_flux(U_r, gamma, p_inf)\n                \n                if np.isclose(sR, sL):\n                    fluxes[:, i] = flux_l\n                else:\n                    fluxes[:, i] = (sR * flux_l - sL * flux_r + sL * sR * (U_r - U_l)) / (sR - sL)\n\n        # Update conserved variables\n        U[:, 1:-1] -= (dt / dx) * (fluxes[:, 1:] - fluxes[:, :-1])\n        \n        t += dt\n\n    # Final analysis\n    final_rho, _, final_p, final_e = get_primitives(U[:, 1:-1], gamma, p_inf)\n    min_rho = np.min(final_rho)\n    min_p = np.min(final_p)\n    min_e = np.min(final_e)\n\n    return [min_rho, min_p, min_e, hlle_fallback_count]\n\ndef solve():\n    test_cases = [\n        # Test Case A (Ideal Gas)\n        {'gamma': 1.4, 'p_inf': 0.0, 'state_L': (1.0, 0.0, 100.0), 'state_R': (0.125, 0.0, 0.1),\n         'N': 200, 't_end': 0.003, 'CFL': 0.4},\n        # Test Case B (Stiffened Gas)\n        {'gamma': 1.67, 'p_inf': 1.0, 'state_L': (1.0, 0.0, 200.0), 'state_R': (0.5, 0.0, 10.0),\n         'N': 200, 't_end': 0.003, 'CFL': 0.4},\n        # Test Case C (Near Vacuum Rarefaction, Ideal Gas)\n        {'gamma': 1.4, 'p_inf': 0.0, 'state_L': (0.1, 0.0, 1e-6), 'state_R': (1.0, 0.0, 1.0),\n         'N': 200, 't_end': 0.002, 'CFL': 0.4}\n    ]\n\n    all_results = []\n    for case in test_cases:\n        result = run_simulation(**case)\n        all_results.append(result)\n\n    # Format output as required: [[...],[...],[...]]\n    output_str = \"[\"\n    for i, res in enumerate(all_results):\n        res_str = f\"[{res[0]},{res[1]},{res[2]},{res[3]}]\"\n        output_str += res_str\n        if i  len(all_results) - 1:\n            output_str += \",\"\n    output_str += \"]\"\n    \n    print(output_str)\n\nsolve()\n```", "id": "3373670"}]}