{"hands_on_practices": [{"introduction": "在交错网格上，即使是像流体静力平衡这样简单的物理状态，也需要精确的实现。一个常见的错误是施加边界条件时，将物理边界上的值赋给了错误的网格点。本练习将通过一个一维流体静力学测试，帮助您诊断这种由于半个网格单元的偏移导致的微妙但常见的实现错误。通过分析由此产生的伪速度，您将加深对离散算子如何与交错网格上的边界数据相互作用的理解。", "problem": "考虑一个密度为 $\\rho$ 的不可压缩流体的垂直一维流体柱，其在负 $y$ 方向上受到重力加速度 $g$ 的作用。区域范围为 $y \\in [0,L]$，并在一个标记网格法（Marker-and-Cell, MAC）交错网格上进行离散化：压力未知数 $p_j$ 存储在单元中心 $y_j = (j - \\tfrac{1}{2}) \\Delta y$，$j = 1,\\dots,N$；垂直速度未知数 $u_i$ 存储在单元面 $y_{i} = i \\Delta y$，$i = 0,\\dots,N$，其中 $\\Delta y = L/N$。假设边界处为无穿透边界，因此 $u_0 = u_N = 0$。\n\n在静水力平衡状态下，连续压力为 $p(y) = p_{\\mathrm{ref}} - \\rho g\\, y$，因此 $\\partial p/\\partial y = -\\rho g$ 且真实的流体速度为 $u(y) \\equiv 0$。在离散的 MAC 网格上，内部面 $y_i$ 处的压力梯度由中心差分近似：\n$$\n\\left.\\frac{\\partial p}{\\partial y}\\right|_{y_i} \\approx \\frac{p_{i+1} - p_i}{\\Delta y}, \\quad i = 1,\\dots,N-1.\n$$\n一个常见的实现错误是，在施加狄利克雷（Dirichlet）压力边界条件时，使用了错误索引处的物理边界值，即设置 $p_1 \\leftarrow p(0)$ 和 $p_N \\leftarrow p(L)$，而不是使用适用于单元中心 $y = \\tfrac{1}{2}\\Delta y$ 和 $y = L - \\tfrac{1}{2}\\Delta y$ 的值。假设这种偏离半个单元的错误在两端都发生了。在所有内部中心点 $j = 2,\\dots,N-1$ 处，假设压力完全符合静水力学分布，即 $p_j = p\\big((j - \\tfrac{1}{2})\\Delta y\\big)$。\n\n为了诊断由此产生的静水力不平衡，考虑从静止状态 $u_i^n = 0$ 开始，对垂直速度进行单步显式预测更新，该更新仅包含体积力和离散压力梯度（为此诊断忽略粘性项和投影步骤）：\n$$\nu_i^{n+1} = u_i^n - \\frac{\\Delta t}{\\rho} \\frac{p_{i+1} - p_i}{\\Delta y} - g \\,\\Delta t, \\quad i = 1,\\dots,N-1.\n$$\n这里 $\\Delta t$ 是一个任意的时间步长，仅用于对不平衡进行无量纲化。你可以认为 $p_{\\mathrm{ref}}$ 是任意的。\n\n哪个陈述最能描述由偏离半个单元的压力边界条件产生的伪速度模式 $u_i^{n+1}$，并为在 MAC 网格上放置边界条件提供了正确的补救措施？\n\nA. 在最靠近边界的内部面 $i=1$ 和 $i=N-1$ 处，离散压力梯度变得过负，具体为 $(p_{i+1} - p_i)/\\Delta y = -\\tfrac{3}{2}\\rho g$，产生向上的伪速度 $u_1^{n+1} = u_{N-1}^{n+1} = +\\tfrac{1}{2} g \\Delta t$，而对于 $i=2,\\dots,N-2$，则有 $u_i^{n+1} = 0$。正确的修正是，通过将单元中心的值赋为 $y = \\tfrac{1}{2}\\Delta y$ 和 $y = L - \\tfrac{1}{2}\\Delta y$ 处的静水力值，来在正确的索引上施加狄利克雷压力，或者等效地，设置虚拟单元（ghost-cell）压力，使得线性插值能得到物理边界上的压力值。\n\nB. 不平衡产生了一个均匀的剪切，使得所有内部面的速度都满足 $u_i^{n+1} = +\\tfrac{1}{2} g \\Delta t$，$i=1,\\dots,N-1$。正确的修正是将压力和速度未知数并置在同一个网格上。\n\nC. 该错误激发了压力-速度解耦模式，在所有内部面上产生了振幅为 $\\tfrac{1}{2} g \\Delta t$ 的交错正负符号的棋盘格模式 $u_i^{n+1}$。正确的修正是切换到并置网格并使用 Rhie–Chow 插值。\n\nD. 压力边界错误在两端相互抵消，因此在这个静水力测试中，对所有 $i$ 都有 $u_i^{n+1} = 0$。唯一实际的补救措施是减小 $\\Delta t$ 以抑制瞬态效应。", "solution": "本问题旨在诊断在交错网格上因边界条件施加不当而引起的流体静力学不平衡。我们将逐步推导伪速度模式的产生，并分析各个选项。\n\n**已知条件与设置**\n- **物理情景**: 一维流体静力平衡，受重力 $g$ 作用。\n- **连续压力场**: $p(y) = p_{\\mathrm{ref}} - \\rho g y$。\n- **离散网格**: MAC交错网格。压力 $p_j$ 位于单元中心 $y_j = (j - \\tfrac{1}{2})\\Delta y$，$j=1,\\dots,N$。速度 $u_i$ 位于单元面 $y_i = i\\Delta y$，$i=0,\\dots,N$。\n- **内部压力**: 在内部点 $j=2,\\dots,N-1$，压力被正确设置: $p_j = p(y_j) = p_{\\mathrm{ref}} - \\rho g (j - \\tfrac{1}{2})\\Delta y$。\n- **错误的边界条件**: 压力边界值被错误地设置在单元中心：\n  - $p_1 = p(0) = p_{\\mathrm{ref}}$\n  - $p_N = p(L) = p(N\\Delta y) = p_{\\mathrm{ref}} - \\rho g N \\Delta y$\n- **速度更新方程**: $u_i^{n+1} = u_i^n - \\frac{\\Delta t}{\\rho} \\frac{p_{i+1} - p_i}{\\Delta y} - g \\,\\Delta t$，初始条件为 $u_i^n=0$。\n\n**求解推导**\n\n我们的目标是计算在每个内部面 $i=1, \\dots, N-1$ 上的新速度 $u_i^{n+1}$。\n\n1.  **计算最靠近底部边界的面 ($i=1$) 的压力梯度**:\n    该梯度为 $\\frac{p_2 - p_1}{\\Delta y}$。\n    - 根据错误的边界条件，$p_1 = p_{\\mathrm{ref}}$。\n    - 根据内部压力设置，$p_2 = p(y_2) = p((2 - \\tfrac{1}{2})\\Delta y) = p_{\\mathrm{ref}} - \\rho g (\\tfrac{3}{2}\\Delta y)$。\n    - 因此，离散梯度为：\n      $$\n      \\frac{p_2 - p_1}{\\Delta y} = \\frac{(p_{\\mathrm{ref}} - \\frac{3}{2}\\rho g \\Delta y) - p_{\\mathrm{ref}}}{\\Delta y} = -\\frac{3}{2}\\rho g\n      $$\n\n2.  **计算内部面 ($i=2, \\dots, N-2$) 的压力梯度**:\n    该梯度为 $\\frac{p_{i+1} - p_i}{\\Delta y}$。\n    - 根据内部压力设置，$p_i = p(y_i) = p_{\\mathrm{ref}} - \\rho g (i - \\tfrac{1}{2})\\Delta y$。\n    - 同样，$p_{i+1} = p(y_{i+1}) = p_{\\mathrm{ref}} - \\rho g ((i+1) - \\tfrac{1}{2})\\Delta y = p_{\\mathrm{ref}} - \\rho g (i + \\tfrac{1}{2})\\Delta y$。\n    - 因此，离散梯度为：\n      $$\n      \\frac{p_{i+1} - p_i}{\\Delta y} = \\frac{[p_{\\mathrm{ref}} - \\rho g (i + \\tfrac{1}{2})\\Delta y] - [p_{\\mathrm{ref}} - \\rho g (i - \\tfrac{1}{2})\\Delta y]}{\\Delta y} = \\frac{-\\rho g \\Delta y}{\\Delta y} = -\\rho g\n      $$\n    这与连续情况下的精确梯度 $\\partial p / \\partial y = -\\rho g$ 一致。\n\n3.  **计算最靠近顶部边界的面 ($i=N-1$) 的压力梯度**:\n    该梯度为 $\\frac{p_N - p_{N-1}}{\\Delta y}$。\n    - 根据错误的边界条件，$p_N = p_{\\mathrm{ref}} - \\rho g N \\Delta y$。\n    - 根据内部压力设置，$p_{N-1} = p(y_{N-1}) = p_{\\mathrm{ref}} - \\rho g ((N-1) - \\tfrac{1}{2})\\Delta y = p_{\\mathrm{ref}} - \\rho g (N - \\tfrac{3}{2})\\Delta y$。\n    - 因此，离散梯度为：\n      $$\n      \\frac{p_N - p_{N-1}}{\\Delta y} = \\frac{[p_{\\mathrm{ref}} - \\rho g N \\Delta y] - [p_{\\mathrm{ref}} - \\rho g (N - \\tfrac{3}{2})\\Delta y]}{\\Delta y} = \\frac{-\\rho g (N - (N - \\tfrac{3}{2}))\\Delta y}{\\Delta y} = -\\frac{3}{2}\\rho g\n      $$\n\n**计算伪速度**\n\n现在我们将这些梯度代入速度更新方程 $u_i^{n+1} = - \\frac{\\Delta t}{\\rho} \\left(\\frac{p_{i+1} - p_i}{\\Delta y}\\right) - g \\Delta t$。\n\n-   对于 $i=1$ 和 $i=N-1$：\n    $$\n    u^{n+1} = - \\frac{\\Delta t}{\\rho} \\left(-\\frac{3}{2}\\rho g\\right) - g \\Delta t = \\frac{3}{2} g \\Delta t - g \\Delta t = +\\frac{1}{2} g \\Delta t\n    $$\n-   对于 $i=2, \\dots, N-2$：\n    $$\n    u_i^{n+1} = - \\frac{\\Delta t}{\\rho} (-\\rho g) - g \\Delta t = g \\Delta t - g \\Delta t = 0\n    $$\n\n**结论**: 错误的边界条件在最靠近边界的两个内部面（$i=1$ 和 $i=N-1$）上产生了大小为 $+\\frac{1}{2} g \\Delta t$ 的伪速度，而所有其他内部面保持静止。\n\n**选项分析**\n\n-   **A**: 陈述“在最靠近边界的内部面 $i=1$ 和 $i=N-1$ 处，离散压力梯度变得过负，具体为 ... $= -\\tfrac{3}{2}\\rho g$，产生向上的伪速度 $u_1^{n+1} = u_{N-1}^{n+1} = +\\tfrac{1}{2} g \\Delta t$，而对于 $i=2,\\dots,N-2$，则有 $u_i^{n+1} = 0$。” 这与我们的推导完全一致。建议的补救措施——在单元中心使用正确的压力值，或使用虚拟单元方法——是处理此类问题的标准正确方法。**因此，该选项正确。**\n-   **B**: 陈述产生了“均匀的剪切”，即所有内部面速度相同。这与我们的结果（只有边界附近的面有速度）相矛盾。将压力和速度并置会引入更严重的棋盘格问题，而不是解决这个问题。**因此，该选项不正确。**\n-   **C**: 陈述激发了“棋盘格模式”。我们的结果显示了两个孤立的非零速度点，而不是交替的正负模式。Rhie-Chow插值是为并置网格设计的，与MAC网格无关。**因此，该选项不正确。**\n-   **D**: 陈述“压力边界错误在两端相互抵消”，导致零速度。这与我们的计算结果直接矛盾。减小 $\\Delta t$ 只会减小伪速度的大小，但不会消除不平衡的根源，因此不是一个真正的补救措施。**因此，该选项不正确。**", "answer": "$$\\boxed{A}$$", "id": "3365549"}, {"introduction": "使用交错网格的主要动机是为了避免在更简单的同位网格（colocated grid）上经常出现的非物理性压力振荡。本练习探讨了“棋盘格”压力模式，这是一种高频数值伪影，它恰好存在于同位网格上朴素压力梯度算子的零空间中，从而使其对动量方程“不可见”。然而，MAC交错网格的梯度算子能够稳健地将相邻的压力差与动量耦合起来，从而抑制这些振荡。通过数值方法激发这种模式并比较其在两种网格类型上的影响，您将对压力-速度解耦问题以及为何交错网格是其根本解决方案获得深刻的第一手理解。[@problem_id:3365597]", "problem": "考虑在每个方向长度为 $L=1$ 的二维周期性区域上的稳态、不可压缩斯托克斯方程，其空间坐标为 $(x,y)$，速度场为 $\\mathbf{u}(x,y) = (u(x,y), v(x,y))$：\n$$\n-\\nabla p + \\nu \\nabla^2 \\mathbf{u} = \\mathbf{f}, \\quad \\nabla \\cdot \\mathbf{u} = 0,\n$$\n其中 $p(x,y)$ 是压力，$\\nu$ 是运动粘度，$\\mathbf{f}(x,y)$ 是给定的彻体力。在分步投影法中，压力场 $p$ 是通过求解以下与施加离散不可压缩性约束相关的压力泊松方程来恢复的：\n$$\n\\nabla^2 p = s,\n$$\n其中 $s$ 是一个由中间速度场的散度构造的离散源项。在间距为 $\\Delta x = \\Delta y$ 的均匀笛卡尔网格上，不同的网格布置会导致不同的离散梯度和散度算子。具体来说：\n- 同位（中心）网格布置将 $u$、$v$ 和 $p$ 都放置在网格中心。一种常见的朴素中心差分实现使用每个坐标方向上的最近邻点来计算中心的离散压力梯度：\n$$\n\\left(\\frac{\\partial p}{\\partial x}\\right)_{i,j}^{\\text{col}} = \\frac{p_{i+1,j} - p_{i-1,j}}{2 \\Delta x}, \\quad\n\\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j}^{\\text{col}} = \\frac{p_{i,j+1} - p_{i,j-1}}{2 \\Delta x}.\n$$\n- 标记网格(Marker-And-Cell, MAC)交错网格布置将 $u$ 放置在 $(i+\\tfrac{1}{2}, j)$ 的垂直面上，$v$ 放置在 $(i, j+\\tfrac{1}{2})$ 的水平面上，$p$ 放置在网格中心 $(i,j)$。离散压力梯度自然地出现在面上：\n$$\n\\left(\\frac{\\partial p}{\\partial x}\\right)_{i+\\frac{1}{2},j}^{\\text{MAC}} = \\frac{p_{i+1,j} - p_{i,j}}{\\Delta x}, \\quad\n\\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j+\\frac{1}{2}}^{\\text{MAC}} = \\frac{p_{i,j+1} - p_{i,j}}{\\Delta x}.\n$$\n\n众所周知，同位中心差分容许一种伪压力模式，通常称为棋盘模式，它在 $N_x \\times N_y$ 均匀周期性网格上定义为\n$$\np_{i,j}^{\\text{chk}} = (-1)^{i+j}, \\quad i = 0,1,\\dots,N_x-1, \\quad j = 0,1,\\dots,N_y-1,\n$$\n并对应于最高可分辨空间频率（奈奎斯特模式）。该模式可被某些离散强迫项激发，并且在同位网格上，通过从中心到面的朴素插值，它会与动量方程解耦，导致 $p$ 中出现不驱动动量的非物理振荡。相比之下，MAC交错网格抑制了这种解耦，因为面心离散梯度直接对相邻的网格中心压力进行采样，棋盘模式的差分在面上不为零。\n\n你的任务是：\n1. 使用人造源项 $s_{i,j} = (-1)^{i+j}$ 来激发具有周期性边界条件的离散压力泊松方程中的棋盘模式，该方程用标准五点拉普拉斯算子离散。在间距为 $\\Delta x$ 的均匀网格上，五点拉普拉斯算子的离散傅里叶符号为\n$$\n\\lambda(k_x,k_y) = \\frac{2}{\\Delta x^2}\\left(\\cos(k_x \\Delta x)-1\\right) + \\frac{2}{\\Delta x^2}\\left(\\cos(k_y \\Delta x)-1\\right),\n$$\n对于离散波数 $k_x = \\frac{2\\pi m}{L}$，$k_y = \\frac{2\\pi n}{L}$，其中 $m = 0,1,\\dots,N_x-1$ 且 $n = 0,1,\\dots,N_y-1$。当 $N_x$ 和 $N_y$ 为偶数时，棋盘模式对应于 $(m,n) = (N_x/2, N_y/2)$，这给出 $\\cos(\\pi) = -1$，因此\n$$\n\\lambda_{\\text{chk}} = -\\frac{4}{\\Delta x^2} - \\frac{4}{\\Delta x^2} = -\\frac{8}{\\Delta x^2}.\n$$\n由此，与棋盘模式强迫项相关的压力振幅按以下比例缩放\n$$\nA_p(\\Delta x) = \\frac{1}{|\\lambda_{\\text{chk}}|} = \\frac{\\Delta x^2}{8}.\n$$\n2. 在傅里叶域中使用上述离散拉普拉斯符号数值求解一系列均匀网格上的离散周期性泊松方程 $\\nabla^2 p = s$，并通过将计算出的 $p$ 投影到 $p^{\\text{chk}}$ 上来提取棋盘模式分量的数值振幅 $A_p(\\Delta x)$。\n3. 计算并比较在以下情况下将进入动量方程的面心压力梯度的均方根(RMS)大小：\n   - 通过将相邻网格中心的梯度平均到面上得到的同位网格朴素面梯度：\n   $$\n   \\left(\\frac{\\partial p}{\\partial x}\\right)_{i+\\frac{1}{2},j}^{\\text{col-face}} = \\frac{1}{2}\\left[\\left(\\frac{\\partial p}{\\partial x}\\right)_{i,j}^{\\text{col}} + \\left(\\frac{\\partial p}{\\partial x}\\right)_{i+1,j}^{\\text{col}}\\right], \\quad\n   \\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j+\\frac{1}{2}}^{\\text{col-face}} = \\frac{1}{2}\\left[\\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j}^{\\text{col}} + \\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j+1}^{\\text{col}}\\right].\n   $$\n   - 如上定义的MAC面梯度。均方根大小定义为\n   $$\n   G_{\\text{RMS}} = \\sqrt{\\frac{1}{N_f}\\sum_{f} g_f^2},\n   $$\n   其中 $g_f$ 遍历两个方向上的所有面梯度分量，$N_f$ 是面的数量。\n4. 数值上证明：\n   - 同位网格的朴素面梯度对棋盘模式分量不敏感，因此对于人造强迫项，其均方根大小在数值上为零，这解释了解耦现象。\n   - MAC面梯度与棋盘模式耦合，并且对于人造强迫项，其均方根大小按 $\\mathcal{O}(\\Delta x)$ 比例缩放，因为 $A_p(\\Delta x) \\sim \\Delta x^2$ 且面梯度按 $A_p(\\Delta x)/\\Delta x$ 比例缩放。\n\n实现一个程序，该程序：\n- 在长度为 $L=1$ 的周期性区域上构建人造源项 $s_{i,j} = (-1)^{i+j}$。\n- 在傅里叶空间中使用离散拉普拉斯符号求解离散泊松方程以获得 $p_{i,j}$。\n- 通过投影到 $(-1)^{i+j}$ 上来计算数值棋盘模式振幅 $A_p(\\Delta x)$。\n- 为得到的 $p_{i,j}$ 计算 $G_{\\text{RMS}}^{\\text{col-face}}$ 和 $G_{\\text{RMS}}^{\\text{MAC}}$。\n- 报告每个网格的元组 $(A_p(\\Delta x), G_{\\text{RMS}}^{\\text{col-face}}, G_{\\text{RMS}}^{\\text{MAC}})$。\n\n测试套件：\n- 对以下情况使用 $N_x=N_y$ 且 $L=1$ 的方形网格：\n  1. $N_x=N_y=8$ (粗网格, $\\Delta x = 1/8$)。\n  2. $N_x=N_y=16$ (中等网格, $\\Delta x = 1/16$)。\n  3. $N_x=N_y=32$ (细网格, $\\Delta x = 1/32$)。\n  4. $N_x=N_y=64$ (极细网格, $\\Delta x = 1/64$)。\n所有报告的量均为无量纲。你的程序应生成单行输出，其中包含结果，形式为由逗号分隔的四个带括号的元组列表，每个元组按 $(A_p(\\Delta x), G_{\\text{RMS}}^{\\text{col-face}}, G_{\\text{RMS}}^{\\text{MAC}})$ 的顺序排列，与测试用例的顺序相同，例如：\n\"[(a1,b1,c1),(a2,b2,c2),(a3,b3,c3),(a4,b4,c4)]\"。", "solution": "我们从稳态不可压缩斯托克斯方程开始\n$$\n-\\nabla p + \\nu \\nabla^2 \\mathbf{u} = \\mathbf{f}, \\quad \\nabla \\cdot \\mathbf{u} = 0,\n$$\n在分步投影法下，这导致通过压力泊松方程来施加离散不可压缩性约束\n$$\n\\nabla^2 p = s,\n$$\n其中源项 $s$ 由中间速度的散度得到。在均匀周期性网格上，在离散傅里叶空间中求解此泊松方程是很自然的方法，并且能揭示某些空间模式如何传播到压力中。我们关注棋盘（奈奎斯特）模式，\n$$\np_{i,j}^{\\text{chk}} = (-1)^{i+j},\n$$\n它在相邻的网格中心之间符号交替。\n\n对于间距为 $\\Delta x$ 且具有周期性边界条件的均匀网格，标准五点离散拉普拉斯算子具有傅里叶符号\n$$\n\\lambda(k_x,k_y) = \\frac{2}{\\Delta x^2}\\left(\\cos(k_x \\Delta x)-1\\right) + \\frac{2}{\\Delta x^2}\\left(\\cos(k_y \\Delta x)-1\\right),\n$$\n其离散波数为 $k_x = \\frac{2\\pi m}{L}$ 和 $k_y = \\frac{2\\pi n}{L}$，$m=0,\\dots,N_x-1$，$n=0,\\dots,N_y-1$，且 $L=1$。对于棋盘模式，$(m,n)=(N_x/2, N_y/2)$ 且 $k_x \\Delta x = \\pi$, $k_y \\Delta x = \\pi$，得到\n$$\n\\lambda_{\\text{chk}} = \\frac{2}{\\Delta x^2}\\left(\\cos \\pi - 1\\right) + \\frac{2}{\\Delta x^2}\\left(\\cos \\pi - 1\\right) = \\frac{2}{\\Delta x^2}\\left(-1 - 1\\right) + \\frac{2}{\\Delta x^2}\\left(-1 - 1\\right) = -\\frac{8}{\\Delta x^2}.\n$$\n用 $s_{i,j}=(-1)^{i+j}$ 强迫泊松方程意味着右端项仅包含此模式。因此，解与该模式成正比：\n$$\np_{i,j} = A_p(\\Delta x)\\, (-1)^{i+j}.\n$$\n代入傅里叶空间中的离散泊松方程，得到\n$$\n\\lambda_{\\text{chk}} A_p(\\Delta x) = 1 \\quad \\Rightarrow \\quad A_p(\\Delta x) = -\\frac{1}{\\lambda_{\\text{chk}}} = \\frac{\\Delta x^2}{8}.\n$$\n因此，计算出的压力中棋盘模式分量的振幅按 $\\Delta x^2$ 比例缩放。\n\n同位网格和标记网格(MAC)交错网格之间的区别在于压力梯度在动量方程中的表示方式：\n- 在同位（中心）格式中，一种常见的朴素实现使用中心差分来估计网格中心的 $\\left(\\frac{\\partial p}{\\partial x}\\right)_{i,j}^{\\text{col}}$ 和 $\\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j}^{\\text{col}}$。对于棋盘压力 $p_{i,j} = A_p(\\Delta x)\\,(-1)^{i+j}$，\n$$\n\\left(\\frac{\\partial p}{\\partial x}\\right)_{i,j}^{\\text{col}} = \\frac{p_{i+1,j} - p_{i-1,j}}{2 \\Delta x}\n= \\frac{A_p(\\Delta x)\\left[(-1)^{i+1+j} - (-1)^{i-1+j}\\right]}{2\\Delta x}\n= \\frac{A_p(\\Delta x)\\,(-1)^{i+j}\\left[-1 - (-1)\\right]}{2\\Delta x} = 0,\n$$\n类似的计算表明 $\\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j}^{\\text{col}}=0$。如果接着通过平均相邻中心梯度来朴素地形成面梯度，则驱动动量方程的最终面压力梯度仍然为零。这证明了解耦现象：在同位朴素格式中，棋盘压力不产生面心压力。\n- 在MAC交错网格布置中，面心离散梯度直接取相邻中心压力的差值：\n$$\n\\left(\\frac{\\partial p}{\\partial x}\\right)_{i+\\frac{1}{2},j}^{\\text{MAC}} = \\frac{p_{i+1,j} - p_{i,j}}{\\Delta x}\n= \\frac{A_p(\\Delta x)\\left[(-1)^{i+1+j} - (-1)^{i+j}\\right]}{\\Delta x}\n= \\frac{A_p(\\Delta x)\\,(-1)^{i+j}(-1 - 1)}{\\Delta x}\n= -\\frac{2\\,A_p(\\Delta x)}{\\Delta x}\\,(-1)^{i+j}.\n$$\n$\\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j+\\frac{1}{2}}^{\\text{MAC}}$ 也有类似的表达式。因此，MAC面梯度与棋盘模式强耦合，并驱动动量修正以抑制此类振荡。对于人造强迫项，MAC面梯度的大小按 $\\frac{A_p(\\Delta x)}{\\Delta x} \\sim \\frac{\\Delta x^2}{\\Delta x} = \\mathcal{O}(\\Delta x)$ 比例缩放。\n\n程序的算法设计：\n1. 对于每个具有 $N_x=N_y$ 和 $\\Delta x = 1/N_x$ 的测试网格，构建人造源项 $s_{i,j} = (-1)^{i+j}$。\n2. 计算 $s$ 的二维离散傅里叶变换，得到 $\\hat{s}(m,n)$。\n3. 对于每个傅里叶模式 $(m,n)$，使用以下公式计算离散拉普拉斯符号 $\\lambda(m,n)$\n$$\n\\lambda(m,n) = \\frac{2}{\\Delta x^2}\\left(\\cos\\left(\\frac{2\\pi m}{N_x}\\right)-1\\right) + \\frac{2}{\\Delta x^2}\\left(\\cos\\left(\\frac{2\\pi n}{N_y}\\right)-1\\right).\n$$\n4. 对所有 $\\lambda(m,n) \\neq 0$ 的 $(m,n)$ 计算 $\\hat{p}(m,n) = \\hat{s}(m,n) / \\lambda(m,n)$。由于交替模式，零模式 $(m,n)=(0,0)$ 在 $\\hat{s}$ 中不存在，因此不会发生除以零的情况。\n5. 进行逆变换以在物理空间中获得 $p_{i,j}$。\n6. 将 $p$ 投影到棋盘模式上以提取振幅，\n$$\nA_p(\\Delta x) = \\frac{1}{N_x N_y} \\sum_{i=0}^{N_x-1}\\sum_{j=0}^{N_y-1} p_{i,j}(-1)^{i+j}.\n$$\n7. 使用中心差分计算同位网格的中心梯度，然后通过将相邻中心梯度平均到面上来获得同位网格的面梯度。计算所有面上的均方根大小：\n$$\nG_{\\text{RMS}}^{\\text{col-face}} = \\sqrt{\\frac{1}{N_f}\\sum_{f}\\left(g_{f}^{\\text{col-face}}\\right)^2}.\n$$\n8. 根据相邻中心压力计算MAC面梯度及其相应的均方根大小：\n$$\nG_{\\text{RMS}}^{\\text{MAC}} = \\sqrt{\\frac{1}{N_f}\\sum_{f}\\left(g_{f}^{\\text{MAC}}\\right)^2}.\n$$\n9. 对于测试套件中的每个网格，输出 $(A_p(\\Delta x), G_{\\text{RMS}}^{\\text{col-face}}, G_{\\text{RMS}}^{\\text{MAC}})$，并按规定汇总到单行中。\n\n预期行为：\n- 数值 $A_p(\\Delta x)$ 应与 $\\Delta x^2/8$ 非常接近地缩放（在浮点精度和离散变换归一化的范围内）。\n- $G_{\\text{RMS}}^{\\text{col-face}}$ 应数值上为零（达到机器精度），这表明同位朴素梯度对棋盘压力不敏感。\n- 对于此人造强迫项，$G_{\\text{RMS}}^{\\text{MAC}}$ 应与 $\\Delta x$ 线性缩放，因为面梯度大小的行为类似于 $2 A_p(\\Delta x)/\\Delta x$。\n\n这直接展示了标记网格(MAC)交错网格抑制棋盘压力模式的机理：通过将速度放置在面上，离散压力梯度被计算为相邻压力的差值，该差值对于交替模式不为零，从而将伪模式耦合到动量中，并在其中被阻尼。相比之下，同位网格上在中心点计算压力梯度的朴素中心差分会消除交替分量，从而允许伪压力模式持续存在而不影响速度场。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef discrete_laplacian_symbol(nx, ny, dx):\n    \"\"\"\n    Build the discrete Laplacian symbol lambda(m,n) for a periodic grid\n    using the five-point stencil central differences on a uniform grid.\n    \"\"\"\n    # Wavenumber indices m, n\n    m = np.arange(nx)\n    n = np.arange(ny)\n    # Cosine terms for each axis\n    cos_m = np.cos(2.0 * np.pi * m / nx)\n    cos_n = np.cos(2.0 * np.pi * n / ny)\n    # Broadcast to 2D grid of (m,n)\n    lam = (2.0 / dx**2) * (cos_m[:, None] - 1.0) + (2.0 / dx**2) * (cos_n[None, :] - 1.0)\n    return lam\n\ndef solve_poisson_checkerboard(nx, ny, L=1.0):\n    \"\"\"\n    Solve the discrete periodic Poisson equation for s_{i,j} = (-1)^{i+j}\n    using the discrete Laplacian symbol in Fourier space.\n\n    Returns:\n        p: computed pressure field (nx x ny)\n        Ap: numerical checkerboard amplitude via projection onto (-1)^{i+j}\n    \"\"\"\n    dx = L / nx\n    # Manufactured source s = (-1)^{i+j}\n    i = np.arange(nx)[:, None]\n    j = np.arange(ny)[None, :]\n    s = ((-1.0) ** (i + j)).astype(np.float64)\n\n    # FFT of source\n    s_hat = np.fft.fft2(s)\n\n    # Discrete Laplacian symbol\n    lam = discrete_laplacian_symbol(nx, ny, dx)\n\n    # Avoid division by zero: source has zero mean, so lam[0,0] won't be used\n    # Construct p_hat = s_hat / lam\n    # Use where to handle potential zeros robustly (though s_hat[0,0]==0)\n    p_hat = np.zeros_like(s_hat, dtype=np.complex128)\n    mask = lam != 0.0\n    p_hat[mask] = s_hat[mask] / lam[mask]\n\n    # Inverse FFT to get p\n    p = np.real(np.fft.ifft2(p_hat))\n\n    # Compute checkerboard amplitude Ap = mean(p * (-1)^{i+j})\n    pattern = ((-1.0) ** (i + j)).astype(np.float64)\n    Ap = np.sum(p * pattern) / (nx * ny)\n\n    return p, Ap, dx\n\ndef colocated_face_gradient_rms(p, dx):\n    \"\"\"\n    Compute colocated center gradients via central differences and then\n    naive face gradients by averaging adjacent center gradients.\n    Return RMS magnitude over all faces.\n    \"\"\"\n    nx, ny = p.shape\n\n    # Periodic shifts\n    p_ip = np.roll(p, -1, axis=0)\n    p_im = np.roll(p,  1, axis=0)\n    p_jp = np.roll(p, -1, axis=1)\n    p_jm = np.roll(p,  1, axis=1)\n\n    # Center gradients (central difference)\n    gx_c = (p_ip - p_im) / (2.0 * dx)\n    gy_c = (p_jp - p_jm) / (2.0 * dx)  # dx == dy\n\n    # Face gradients: average adjacent center gradients to faces\n    # x-faces at (i+1/2, j): average gx_c[i,j] and gx_c[i+1,j]\n    gx_face = 0.5 * (gx_c + np.roll(gx_c, -1, axis=0))\n    # y-faces at (i, j+1/2): average gy_c[i,j] and gy_c[i,j+1]\n    gy_face = 0.5 * (gy_c + np.roll(gy_c, -1, axis=1))\n\n    # RMS over all faces (both directions)\n    # Number of faces: 2 * nx * ny\n    rms = np.sqrt((np.sum(gx_face**2) + np.sum(gy_face**2)) / (2.0 * nx * ny))\n    return rms\n\ndef mac_face_gradient_rms(p, dx):\n    \"\"\"\n    Compute MAC face gradients directly from adjacent center pressures.\n    Return RMS magnitude over all faces.\n    \"\"\"\n    nx, ny = p.shape\n\n    # x-face gradient: (p_{i+1,j} - p_{i,j}) / dx\n    p_ip = np.roll(p, -1, axis=0)\n    gx_face = (p_ip - p) / dx\n\n    # y-face gradient: (p_{i,j+1} - p_{i,j}) / dx\n    p_jp = np.roll(p, -1, axis=1)\n    gy_face = (p_jp - p) / dx\n\n    rms = np.sqrt((np.sum(gx_face**2) + np.sum(gy_face**2)) / (2.0 * nx * ny))\n    return rms\n\ndef run_test_case(nx):\n    ny = nx\n    p, Ap, dx = solve_poisson_checkerboard(nx, ny, L=1.0)\n    rms_col = colocated_face_gradient_rms(p, dx)\n    rms_mac = mac_face_gradient_rms(p, dx)\n    return (Ap, rms_col, rms_mac)\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [8, 16, 32, 64]\n\n    results = []\n    for nx in test_cases:\n        Ap, rms_col, rms_mac = run_test_case(nx)\n        # Format each tuple with reasonable precision\n        results.append(f\"({Ap:.10f},{rms_col:.10e},{rms_mac:.10e})\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```", "id": "3365597"}, {"introduction": "一个稳健的数值格式不仅应能收敛到正确的解，还应在可能的情况下精确地保持某些基本的解析解。本练习涉及一个基于刚体旋转的验证测试，其中离心力与一个二次压力场精确平衡。由于MAC网格的中心差分压力梯度对于二次多项式是精确的，离散格式应能在此情况下将流体静力平衡维持到机器精度。完成这项练习将展示MAC离散化方案一个强大的“精确性”属性，并增强您对其准确模拟曲线流动能力的信心。[@problem_id:3365551]", "problem": "构建一个程序，在标记-网格 (MAC) 交错网格布局上，验证对于刚体旋转速度场，离散压力梯度与离心力完全抵消。物理背景是：一个密度恒定的流体进行稳态、无粘性的刚体旋转，其角速度矢量为 $\\boldsymbol{\\Omega}$，速度由 $\\mathbf{u} = \\boldsymbol{\\Omega} \\times \\mathbf{r}$ 给出，其中 $\\mathbf{r}$ 是位置矢量。验证必须在旋转坐标系中进行，其中离心加速度被建模为体积力，对于恒定密度 $\\rho$，静水力平衡为 $-\\nabla p + \\rho \\mathbf{a}_{\\mathrm{cf}} = \\mathbf{0}$，其中 $\\mathbf{a}_{\\mathrm{cf}}$ 是离心加速度。使用经过充分检验的公式 $\\mathbf{a}_{\\mathrm{cf}} = -\\boldsymbol{\\Omega}\\times(\\boldsymbol{\\Omega}\\times \\mathbf{r})$。所有物理量都必须使用国际单位制 (SI) 处理：位置单位为米，时间单位为秒，质量单位为千克，角速度单位为弧度/秒。最终残差必须以 $\\mathrm{N/m^3}$ 为单位表示。\n\n在嵌入平面 $z = z_0$ 的均匀、正交、二维网格上，使用以下 MAC 网格定义：\n- 压力 $p$ 存储在网格中心，坐标为 $(x_{i+\\frac{1}{2}}, y_{j+\\frac{1}{2}})$，其中 $x_{i+\\frac{1}{2}} = x_{\\min} + (i+\\frac{1}{2})\\Delta x$ 且 $y_{j+\\frac{1}{2}} = y_{\\min} + (j+\\frac{1}{2})\\Delta y$，对于整数 $i \\in \\{0,\\dots,N_x-1\\}$ 和 $j \\in \\{0,\\dots,N_y-1\\}$。\n- x方向动量（u速度位置）位于x面的中心，坐标为 $(x_{i+1}, y_{j+\\frac{1}{2}})$，其中 $x_{i+1} = x_{\\min} + (i+1)\\Delta x$，对于 $i \\in \\{0,\\dots,N_x-2\\}$ 和 $j \\in \\{0,\\dots,N_y-1\\}$。位于 $(i+\\frac{1}{2},j+\\frac{1}{2})$ 处的x方向动量方程中的MAC离散压力梯度定义为 $-\\partial p/\\partial x \\approx -\\left(p_{i+1,j} - p_{i,j}\\right)/\\Delta x$。\n- y方向动量（v速度位置）位于y面的中心，坐标为 $(x_{i+\\frac{1}{2}}, y_{j+1})$，其中 $y_{j+1} = y_{\\min} + (j+1)\\Delta y$，对于 $i \\in \\{0,\\dots,N_x-1\\}$ 和 $j \\in \\{0,\\dots,N_y-2\\}$。位于 $(i+\\frac{1}{2},j+\\frac{1}{2})$ 处的y方向动量方程中的MAC离散压力梯度定义为 $-\\partial p/\\partial y \\approx -\\left(p_{i,j+1} - p_{i,j}\\right)/\\Delta y$。\n\n您必须：\n- 从第一性原理出发，为恒定密度 $\\rho$ 在刚体旋转下的流体推导出一个压力场 $p(\\mathbf{r})$，使其满足连续静水力平衡方程 $-\\nabla p + \\rho \\mathbf{a}_{\\mathrm{cf}} = \\mathbf{0}$。\n- 使用该 $p(\\mathbf{r})$，在所有网格中心处计算 $p$ 的值，在面中心处计算MAC离散压力梯度，在相同的面中心处计算 $\\rho \\mathbf{a}_{\\mathrm{cf}}$ 的值，然后计算x和y方向动量方程中的逐点残差：在x面上，$R_x = -\\left(p_{i+1,j}-p_{i,j}\\right)/\\Delta x + \\rho \\, a_{\\mathrm{cf},x}$；在y面上，$R_y = -\\left(p_{i,j+1}-p_{i,j}\\right)/\\Delta y + \\rho \\, a_{\\mathrm{cf},y}$。\n- 通过报告所有内部面和两个分量的最大绝对残差来汇总结果，即 $\\max\\left(\\max_{i,j} |R_x|, \\max_{i,j} |R_y|\\right)$，单位为 $\\mathrm{N/m^3}$。\n\n角度单位：角速度矢量 $\\boldsymbol{\\Omega} = (\\Omega_x,\\Omega_y,\\Omega_z)$ 的分量单位为弧度/秒。距离单位为米。密度单位为 $\\mathrm{kg/m^3}$。残差必须以 $\\mathrm{N/m^3}$ 为单位报告。\n\n测试套件：\n对于以下每组参数，计算上述的单一标量输出。\n\n- 测试 1（理想情况，方形网格，轴对齐角速度）：\n  - $\\rho = 1000$，\n  - $\\boldsymbol{\\Omega} = (0,0,10)$,\n  - 域：$x \\in [0,1]$, $y \\in [0,1]$, $z_0 = 0$,\n  - 网格：$N_x = 64$, $N_y = 64$。\n- 测试 2（矩形网格，轴对齐角速度，偏心域）：\n  - $\\rho = 1$,\n  - $\\boldsymbol{\\Omega} = (0,0,2.5)$,\n  - 域：$x \\in [-2,3]$, $y \\in [-1,1]$, $z_0 = 0$,\n  - 网格：$N_x = 50$, $N_y = 20$。\n- 测试 3（非轴对齐角速度，非零平面偏移）：\n  - $\\rho = 1.2$,\n  - $\\boldsymbol{\\Omega} = (3,4,5)$,\n  - 域：$x \\in [1,2]$, $y \\in [-0.3,0.7]$, $z_0 = 0.2$,\n  - 网格：$N_x = 37$, $N_y = 29$。\n- 测试 4（最少内部面）：\n  - $\\rho = 850$,\n  - $\\boldsymbol{\\Omega} = (0,0,0.1)$,\n  - 域：$x \\in [-1,1]$, $y \\in [-1,1]$, $z_0 = 0$,\n  - 网格：$N_x = 2$, $N_y = 2$。\n- 测试 5（较大角速度，小计算域）：\n  - $\\rho = 997$,\n  - $\\boldsymbol{\\Omega} = (0,0,1000)$,\n  - 域：$x \\in [0.1,0.2]$, $y \\in [-0.05,0.05]$, $z_0 = 0$,\n  - 网格：$N_x = 16$, $N_y = 16$。\n\n您的程序必须为每个测试计算单一标量 $\\max\\left(\\max_{i,j} |R_x|, \\max_{i,j} |R_y|\\right)$，并最终打印一行，其中包含所有测试的结果，格式为方括号内由逗号分隔的列表，例如 $[r_1,r_2,r_3,r_4,r_5]$，其中每个 $r_k$ 是一个以 $\\mathrm{N/m^3}$ 为单位的浮点值。", "solution": "用户提供的问题是计算流体力学中一个适定的验证练习。该问题在科学上是合理的，并提供了所有必需的信息。\n\n该问题要求在一个特定案例中，验证标记-网格 (MAC) 交错网格离散化的一种特性。物理场景是流体处于稳态、无粘性的刚体旋转状态。在随流体一同旋转的参考系中，静态流体的控制方程是压力梯度和体积力之间的静水力平衡。除了可以被吸收到修正压力项中的均匀引力场外，唯一考虑的体积力是离心力。平衡方程如下：\n$$-\\nabla p + \\rho \\mathbf{a}_{\\mathrm{cf}} = \\mathbf{0}$$\n其中 $p$ 是压力，$\\rho$ 是恒定的流体密度，而 $\\mathbf{a}_{\\mathrm{cf}}$ 是离心加速度。问题在于证明，当使用精确的解析压力场时，此方程的标准MAC网格离散化会产生一个在机器精度内为零的残差。这是对该离散化方法精确表示某类解析解能力的验证。\n\n## 基于原理的设计与推导\n\n### 1. 解析压力场推导\n首先，我们推导满足连续静水力平衡方程的解析压力场 $p(\\mathbf{r})$。该方程可写为：\n$$\\nabla p = \\rho \\mathbf{a}_{\\mathrm{cf}}$$\n离心加速度由公式 $\\mathbf{a}_{\\mathrm{cf}} = -\\boldsymbol{\\Omega} \\times (\\boldsymbol{\\Omega} \\times \\mathbf{r})$ 给出，其中 $\\boldsymbol{\\Omega}$ 是恒定的角速度矢量，$\\mathbf{r}$ 是位置矢量。\n\n使用矢量三重积恒等式 $\\mathbf{A} \\times (\\mathbf{B} \\times \\mathbf{C}) = \\mathbf{B}(\\mathbf{A} \\cdot \\mathbf{C}) - \\mathbf{C}(\\mathbf{A} \\cdot \\mathbf{B})$，我们展开 $\\mathbf{a}_{\\mathrm{cf}}$ 的表达式：\n$$\\mathbf{a}_{\\mathrm{cf}} = -[\\boldsymbol{\\Omega}(\\boldsymbol{\\Omega} \\cdot \\mathbf{r}) - \\mathbf{r}(\\boldsymbol{\\Omega} \\cdot \\boldsymbol{\\Omega})]$$\n$$\\mathbf{a}_{\\mathrm{cf}} = (\\boldsymbol{\\Omega} \\cdot \\boldsymbol{\\Omega})\\mathbf{r} - (\\boldsymbol{\\Omega} \\cdot \\mathbf{r})\\boldsymbol{\\Omega}$$\n令 $\\Omega^2 = |\\boldsymbol{\\Omega}|^2 = \\boldsymbol{\\Omega} \\cdot \\boldsymbol{\\Omega}$。因此压力梯度为：\n$$\\nabla p = \\rho [ \\Omega^2 \\mathbf{r} - (\\boldsymbol{\\Omega} \\cdot \\mathbf{r})\\boldsymbol{\\Omega} ]$$\n该矢量场是一个标量势的梯度。我们可以通过积分求得 $p(\\mathbf{r})$。我们识别出表达式中的部分可作为标量场的梯度：\n$$\\nabla(\\frac{1}{2} r^2) = \\nabla(\\frac{1}{2} \\mathbf{r} \\cdot \\mathbf{r}) = \\mathbf{r}$$\n$$\\nabla(\\frac{1}{2}(\\boldsymbol{\\Omega} \\cdot \\mathbf{r})^2) = (\\boldsymbol{\\Omega} \\cdot \\mathbf{r}) \\nabla(\\boldsymbol{\\Omega} \\cdot \\mathbf{r}) = (\\boldsymbol{\\Omega} \\cdot \\mathbf{r})\\boldsymbol{\\Omega}$$\n将这些代入 $\\nabla p$ 的表达式中：\n$$\\nabla p = \\rho [ \\Omega^2 \\nabla(\\frac{1}{2} r^2) - \\nabla(\\frac{1}{2}(\\boldsymbol{\\Omega} \\cdot \\mathbf{r})^2) ] = \\nabla \\left[ \\frac{1}{2}\\rho ( \\Omega^2 r^2 - (\\boldsymbol{\\Omega} \\cdot \\mathbf{r})^2 ) \\right]$$\n对 $\\mathbf{r}$ 积分，得到压力场，结果相差一个任意常数 $p_0$：\n$$p(\\mathbf{r}) = \\frac{1}{2}\\rho (\\Omega^2 r^2 - (\\boldsymbol{\\Omega} \\cdot \\mathbf{r})^2) + p_0$$\n使用恒等式 $|\\mathbf{A} \\times \\mathbf{B}|^2 = |\\mathbf{A}|^2 |\\mathbf{B}|^2 - (\\mathbf{A} \\cdot \\mathbf{B})^2$，可以更紧凑地表示为：\n$$p(\\mathbf{r}) = \\frac{1}{2}\\rho |\\boldsymbol{\\Omega} \\times \\mathbf{r}|^2 + p_0$$\n由于只有压力差有意义，我们可以将参考压力 $p_0$ 设为 $0$。\n\n### 2. 离散化与残差分析\n问题指定了在平面 $z=z_0$ 上的一个二维MAC网格。压力 $p$ 位于网格中心 $(x_{i+1/2}, y_{j+1/2})$，而速度分量（以及动量方程残差）位于面中心。\nx方向动量方程的残差 $R_x$ 在垂直面的中心，即位置 $(x_{i+1}, y_{j+1/2})$ 处进行评估。该残差定义为：\n$$R_x = -\\frac{p_{i+1,j} - p_{i,j}}{\\Delta x} + \\rho \\, a_{\\mathrm{cf},x}|_{(x_{i+1}, y_{j+1/2})}$$\n其中 $p_{i,j}$ 表示网格 $(i,j)$ 中心的压力，即 $p(x_{i+1/2}, y_{j+1/2}, z_0)$。\n\n一个关键的观察是，解析压力场 $p(x,y,z_0)$ 是关于空间坐标 $x$ 和 $y$ 的二次多项式。让我们用 $\\mathbf{r}=(x,y,z_0)$ 和 $\\boldsymbol{\\Omega}=(\\Omega_x, \\Omega_y, \\Omega_z)$ 来展开 $p$ 的表达式：\n$$p(x,y) = \\frac{1}{2}\\rho [(\\Omega_x^2+\\Omega_y^2+\\Omega_z^2)(x^2+y^2+z_0^2) - (\\Omega_x x + \\Omega_y y + \\Omega_z z_0)^2]$$\n$$p(x,y) = A x^2 + B y^2 + C xy + D x + E y + F$$\n其中 $A, B, C, D, E, F$ 是依赖于 $\\rho, \\boldsymbol{\\Omega},$ 和 $z_0$ 的常数。\n\n离散压力梯度项 $-\\frac{p_{i+1,j} - p_{i,j}}{\\Delta x}$ 是 $-\\frac{\\partial p}{\\partial x}$ 的一个中心有限差分近似。压力值取自网格中心 $(x_{i+1/2}, y_{j+1/2})$ 和 $(x_{i+3/2}, y_{j+1/2})$。这两点之间的中点是 $(x_{i+1}, y_{j+1/2})$，这正是计算残差 $R_x$ 的位置。\n\n对于任何二次多项式 $f(x) = ax^2 + bx + c$，中心有限差分是精确的，意味着它等于中点处的解析导数：\n$$\\frac{f(x_0 + h/2) - f(x_0 - h/2)}{h} = \\frac{[a(x_0+h/2)^2 + b(x_0+h/2)+c] - [a(x_0-h/2)^2 + b(x_0-h/2)+c]}{h} = 2ax_0 + b = f'(x_0)$$\n由于我们的压力场 $p(x,y)$ 是关于 $x$ 的二次函数（对于固定的 $y$），离散梯度精确地等于面中心的连续梯度：\n$$\\frac{p_{i+1,j} - p_{i,j}}{\\Delta x} = \\left. \\frac{\\partial p}{\\partial x} \\right|_{(x_{i+1}, y_{j+1/2})}$$\n从我们最初的推导可知，连续压力场精确地平衡离心力，即 $\\nabla p = \\rho \\mathbf{a}_{\\mathrm{cf}}$。这意味着在空间中的每一点都有 $\\frac{\\partial p}{\\partial x} = \\rho a_{\\mathrm{cf},x}$。\n因此，在面中心 $(x_{i+1}, y_{j+1/2})$ 处：\n$$\\frac{p_{i+1,j} - p_{i,j}}{\\Delta x} = \\left. \\rho a_{\\mathrm{cf},x} \\right|_{(x_{i+1}, y_{j+1/2})}$$\n将此代入残差 $R_x$ 的定义中：\n$$R_x = -\\left(\\rho a_{\\mathrm{cf},x}\\right) + \\rho a_{\\mathrm{cf},x} = 0$$\n同样的逻辑也适用于y分量残差 $R_y$。因此，离散残差在解析上为零。数值实现应产生在浮点精度限制内为零的结果。\n\n### 3. 算法实现\n程序将通过以下步骤对每个测试用例实施验证：\n1.  解析测试用例参数：$\\rho$、$\\boldsymbol{\\Omega}$、域边界、$z_0$ 以及网格分辨率 $N_x, N_y$。\n2.  计算网格间距 $\\Delta x$ 和 $\\Delta y$。\n3.  使用 NumPy 的广播功能高效地生成压力网格中心的坐标数组。\n4.  在所有网格中心处计算解析压力场 $p(\\mathbf{r})$，以填充一个二维压力数组 `p_grid`。\n5.  对于x方向动量残差：\n    a. 为内部垂直面的中心生成坐标数组。\n    b. 为所有相关面计算离散压力梯度 $-\\left(p_{i+1,j}-p_{i,j}\\right)/\\Delta x$。\n    c. 在相同的面中心处计算离心力项 $\\rho a_{\\mathrm{cf},x}$。\n    d. 将两项相加计算残差 $R_x$。\n6.  在内部水平面上对y方向动量残差 $R_y$ 重复此过程。\n7.  确定所有计算出的 $R_x$ 和 $R_y$ 值中的最大绝对值。这是该测试用例的最终结果。\n8.  收集所有测试用例的结果，并按规定格式化。\n\n该算法直接实现了问题陈述中的公式和定义，并利用上面推导的解析解来测试数值格式的特性。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the verification for all test cases and print the results.\n    \"\"\"\n\n    def calculate_max_residual(params):\n        \"\"\"\n        Calculates the maximum absolute residual for a single test case.\n\n        Args:\n            params (tuple): A tuple containing all parameters for the test case:\n                (rho, Omega_vec, domain_x, domain_y, z0, Nx, Ny).\n\n        Returns:\n            float: The maximum absolute residual found on the grid.\n        \"\"\"\n        rho, Omega_vec, domain_x, domain_y, z0, Nx, Ny = params\n        Omega_vec = np.array(Omega_vec, dtype=float)\n        x_min, x_max = domain_x\n        y_min, y_max = domain_y\n\n        dx = (x_max - x_min) / Nx\n        dy = (y_max - y_min) / Ny\n\n        # --- 1. Calculate pressure at cell centers ---\n        # Use broadcasting to create coordinate grids implicitly\n        i_p = np.arange(Nx, dtype=float).reshape(-1, 1)\n        j_p = np.arange(Ny, dtype=float).reshape(1, -1)\n        x_p = x_min + (i_p + 0.5) * dx\n        y_p = y_min + (j_p + 0.5) * dy\n\n        # Evaluate analytical pressure field p(r) = 0.5 * rho * |Omega x r|^2\n        omega_sq = np.dot(Omega_vec, Omega_vec)\n        r_sq = x_p**2 + y_p**2 + z0**2\n        omega_dot_r = Omega_vec[0] * x_p + Omega_vec[1] * y_p + Omega_vec[2] * z0\n        p_grid = 0.5 * rho * (omega_sq * r_sq - omega_dot_r**2)\n\n        max_res = 0.0\n\n        # --- 2. Calculate x-momentum residual Rx ---\n        if Nx > 1:\n            # Coordinates of x-face centers (where Rx is evaluated)\n            i_rx = np.arange(Nx - 1, dtype=float).reshape(-1, 1)\n            j_rx = np.arange(Ny, dtype=float).reshape(1, -1)\n            x_fx = x_min + (i_rx + 1.0) * dx\n            y_fx = y_min + (j_rx + 0.5) * dy\n\n            # Discrete pressure gradient component in x\n            grad_p_x = (p_grid[1:, :] - p_grid[:-1, :]) / dx\n\n            # Centrifugal force component at x-faces: rho * a_cf,x\n            # a_cf = Omega^2 * r - (Omega . r) * Omega\n            omega_dot_r_fx = Omega_vec[0] * x_fx + Omega_vec[1] * y_fx + Omega_vec[2] * z0\n            a_cf_x = omega_sq * x_fx - omega_dot_r_fx * Omega_vec[0]\n            force_x = rho * a_cf_x\n\n            # Calculate residual\n            Rx = -grad_p_x + force_x\n            max_res = max(max_res, np.max(np.abs(Rx)))\n\n        # --- 3. Calculate y-momentum residual Ry ---\n        if Ny > 1:\n            # Coordinates of y-face centers (where Ry is evaluated)\n            i_ry = np.arange(Nx, dtype=float).reshape(-1, 1)\n            j_ry = np.arange(Ny - 1, dtype=float).reshape(1, -1)\n            x_fy = x_min + (i_ry + 0.5) * dx\n            y_fy = y_min + (j_ry + 1.0) * dy\n\n            # Discrete pressure gradient component in y\n            grad_p_y = (p_grid[:, 1:] - p_grid[:, :-1]) / dy\n\n            # Centrifugal force component at y-faces: rho * a_cf,y\n            omega_dot_r_fy = Omega_vec[0] * x_fy + Omega_vec[1] * y_fy + Omega_vec[2] * z0\n            a_cf_y = omega_sq * y_fy - omega_dot_r_fy * Omega_vec[1]\n            force_y = rho * a_cf_y\n\n            # Calculate residual\n            Ry = -grad_p_y + force_y\n            max_res = max(max_res, np.max(np.abs(Ry)))\n\n        return max_res\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Test 1: rho, Omega, domain_x, domain_y, z0, Nx, Ny\n        (1000.0, (0.0, 0.0, 10.0), (0.0, 1.0), (0.0, 1.0), 0.0, 64, 64),\n        # Test 2\n        (1.0, (0.0, 0.0, 2.5), (-2.0, 3.0), (-1.0, 1.0), 0.0, 50, 20),\n        # Test 3\n        (1.2, (3.0, 4.0, 5.0), (1.0, 2.0), (-0.3, 0.7), 0.2, 37, 29),\n        # Test 4\n        (850.0, (0.0, 0.0, 0.1), (-1.0, 1.0), (-1.0, 1.0), 0.0, 2, 2),\n        # Test 5\n        (997.0, (0.0, 0.0, 1000.0), (0.1, 0.2), (-0.05, 0.05), 0.0, 16, 16),\n    ]\n\n    results = []\n    for case in test_cases:\n        result = calculate_max_residual(case)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3365551"}]}