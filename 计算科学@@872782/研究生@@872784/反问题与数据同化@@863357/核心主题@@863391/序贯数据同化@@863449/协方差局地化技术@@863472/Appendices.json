{"hands_on_practices": [{"introduction": "要真正掌握协方差局域化的精髓，通过一个具体的例子亲手进行计算是理解其内在机制的有效途径。本练习将引导你为一个简化的三维系统构建所有必需的矩阵，包括背景误差协方差矩阵 $B$、观测误差协方差矩阵 $R$ 以及高斯锥化矩阵 $L$。通过这些步骤，你将计算出局域化后的分析方差，从而将抽象的理论付诸实践，并加深对舒尔积（Hadamard product）在局域化过程中作用的理解。[@problem_id:3373230]", "problem": "考虑一个一维三分量状态向量 $x \\in \\mathbb{R}^{3}$，定义在位于 $x_{1}=-1$、$x_{2}=0$ 和 $x_{3}=1$ 的网格点上。先验分布是高斯分布，其均值为 $x_{b}$，先验（背景）协方差矩阵为 $B$。$B$ 由一个平稳指数相关模型指定，该模型的方差为 $\\sigma_{b}^{2}$，相关长度为 $L_{b}$。具体来说，对于网格点间距 $d_{ij}=|x_{i}-x_{j}|$，$B$ 的元素为\n$$\nB_{ij}=\\sigma_{b}^{2}\\exp\\!\\left(-\\frac{d_{ij}}{L_{b}}\\right).\n$$\n观测直接测量每个分量，即线性观测算子为 $H=I_{3}$。观测误差是零均值的高斯分布，其协方差矩阵 $R$ 同样由一个平稳指数相关模型定义，该模型的方差为 $\\sigma_{r}^{2}$，相关长度为 $L_{r}$：\n$$\nR_{ij}=\\sigma_{r}^{2}\\exp\\!\\left(-\\frac{d_{ij}}{L_{r}}\\right).\n$$\n为了减弱与密集观测网络和有限样本效应相关的虚假长程相关，通过将先验协方差与一个高斯相关矩阵 $L$ 进行哈达玛（舒尔）积来实现协方差局地化（锥削）。$L$ 的元素为\n$$\nL_{ij}=\\exp\\!\\left(-\\frac{d_{ij}^{2}}{\\ell^{2}}\\right).\n$$\n局地化先验协方差为 $\\tilde{B}=L\\circ B$，其中 $\\circ$ 表示逐元素相乘。\n\n假设以下参数值，这些值的选择是基于解析易处理性和科学合理性：\n- 先验方差 $\\sigma_{b}^{2}=2$ 和先验相关长度 $L_{b}=1/\\ln(2)$，因此 $\\exp(-d_{ij}/L_{b})=2^{-d_{ij}}$。\n- 观测误差方差 $\\sigma_{r}^{2}=1$ 和观测相关长度 $L_{r}=1/\\ln(2)$，因此 $\\exp(-d_{ij}/L_{r})=2^{-d_{ij}}$。\n- 局地化长度 $\\ell$ 满足 $\\ell^{2}=1/\\ln(2)$，因此 $\\exp(-d_{ij}^{2}/\\ell^{2})=2^{-d_{ij}^{2}}$。\n\n对于这些选择，矩阵 $B$、$L$ 和 $R$ 完全由网格间距 $d_{12}=d_{23}=1$ 和 $d_{13}=2$ 确定。在线性高斯反问题中，局地化分析（后验）协方差定义为\n$$\nP_{a}^{\\mathrm{loc}}=\\tilde{B}-\\tilde{B}\\big(H\\tilde{B}H^{\\top}+R\\big)^{-1}\\tilde{B}.\n$$\n仅使用这些定义和事实，推导出中间网格点 $x_{2}$ 处的局地化分析方差 $P_{a}^{\\mathrm{loc}}(2,2)$，结果表示为一个实数。将最终数值结果四舍五入到四位有效数字。答案不带单位。", "solution": "用户要求我计算一个三分量线性高斯反问题中局地化分析协方差矩阵的一个特定元素。\n\n### 步骤 1：问题验证\n\n该问题是有效的。这是一个适定的、有科学依据的应用线性代数练习。我将继续进行求解。\n\n### 步骤 2：求解推导\n\n分析需要根据网格点间距构造几个矩阵。网格点为 $x_{1}=-1$、$x_{2}=0$ 和 $x_{3}=1$。距离为：\n- $d_{12} = |x_{1}-x_{2}| = |-1-0| = 1$\n- $d_{23} = |x_{2}-x_{3}| = |0-1| = 1$\n- $d_{13} = |x_{1}-x_{3}| = |-1-1| = 2$\n且对于 $i=1,2,3$，$d_{ii}=0$。由于对称性，$d_{ji}=d_{ij}$。\n\n**2.1. 构造矩阵**\n首先，我们构造先验协方差矩阵 $B$、局地化矩阵 $L$ 和观测误差协方差矩阵 $R$。\n\n- **先验协方差 $B$**：$B_{ij} = 2^{1-d_{ij}}$\n$$ B = \\begin{pmatrix} 2^{1-0} & 2^{1-1} & 2^{1-2} \\\\ 2^{1-1} & 2^{1-0} & 2^{1-1} \\\\ 2^{1-2} & 2^{1-1} & 2^{1-0} \\end{pmatrix} = \\begin{pmatrix} 2 & 1 & \\frac{1}{2} \\\\ 1 & 2 & 1 \\\\ \\frac{1}{2} & 1 & 2 \\end{pmatrix} $$\n\n- **局地化矩阵 $L$**：$L_{ij} = 2^{-d_{ij}^{2}}$\n距离的平方为 $d_{12}^2=1$，$d_{23}^2=1$，$d_{13}^2=4$。\n$$ L = \\begin{pmatrix} 2^{-0^2} & 2^{-1^2} & 2^{-2^2} \\\\ 2^{-1^2} & 2^{-0^2} & 2^{-1^2} \\\\ 2^{-2^2} & 2^{-1^2} & 2^{-0^2} \\end{pmatrix} = \\begin{pmatrix} 1 & \\frac{1}{2} & \\frac{1}{16} \\\\ \\frac{1}{2} & 1 & \\frac{1}{2} \\\\ \\frac{1}{16} & \\frac{1}{2} & 1 \\end{pmatrix} $$\n\n- **局地化先验协方差 $\\tilde{B}$**：$\\tilde{B} = L \\circ B$ (哈达玛积)\n$$ \\tilde{B} = \\begin{pmatrix} 1 \\cdot 2 & \\frac{1}{2} \\cdot 1 & \\frac{1}{16} \\cdot \\frac{1}{2} \\\\ \\frac{1}{2} \\cdot 1 & 1 \\cdot 2 & \\frac{1}{2} \\cdot 1 \\\\ \\frac{1}{16} \\cdot \\frac{1}{2} & \\frac{1}{2} \\cdot 1 & 1 \\cdot 2 \\end{pmatrix} = \\begin{pmatrix} 2 & \\frac{1}{2} & \\frac{1}{32} \\\\ \\frac{1}{2} & 2 & \\frac{1}{2} \\\\ \\frac{1}{32} & \\frac{1}{2} & 2 \\end{pmatrix} $$\n\n- **观测误差协方差 $R$**：$R_{ij} = 2^{-d_{ij}}$\n$$ R = \\begin{pmatrix} 2^{-0} & 2^{-1} & 2^{-2} \\\\ 2^{-1} & 2^{-0} & 2^{-1} \\\\ 2^{-2} & 2^{-1} & 2^{-0} \\end{pmatrix} = \\begin{pmatrix} 1 & \\frac{1}{2} & \\frac{1}{4} \\\\ \\frac{1}{2} & 1 & \\frac{1}{2} \\\\ \\frac{1}{4} & \\frac{1}{2} & 1 \\end{pmatrix} $$\n\n**2.2. 计算分析协方差**\n由于 $H=I_{3}$，公式简化为：\n$$ P_{a}^{\\mathrm{loc}} = \\tilde{B} - \\tilde{B} (\\tilde{B} + R)^{-1} \\tilde{B} $$\n令 $S = \\tilde{B} + R$。\n$$ S = \\begin{pmatrix} 2 & \\frac{1}{2} & \\frac{1}{32} \\\\ \\frac{1}{2} & 2 & \\frac{1}{2} \\\\ \\frac{1}{32} & \\frac{1}{2} & 2 \\end{pmatrix} + \\begin{pmatrix} 1 & \\frac{1}{2} & \\frac{1}{4} \\\\ \\frac{1}{2} & 1 & \\frac{1}{2} \\\\ \\frac{1}{4} & \\frac{1}{2} & 1 \\end{pmatrix} = \\begin{pmatrix} 3 & 1 & \\frac{9}{32} \\\\ 1 & 3 & 1 \\\\ \\frac{9}{32} & 1 & 3 \\end{pmatrix} $$\n我们需要求解 $P_{a}^{\\mathrm{loc}}(2,2)$，即 $P_{a}^{\\mathrm{loc}}$ 的第二行第二列的元素。\n$$ P_{a}^{\\mathrm{loc}}(2,2) = \\tilde{B}_{22} - (\\tilde{B} S^{-1} \\tilde{B})_{22} $$\n从 $\\tilde{B}$ 可知，$\\tilde{B}_{22} = 2$。项 $(\\tilde{B} S^{-1} \\tilde{B})_{22}$ 由 $\\tilde{b}_{2}^{T} S^{-1} \\tilde{b}_{2}$ 给出，其中 $\\tilde{b}_{2}$ 是 $\\tilde{B}$ 的第二列（或行）。\n$$ \\tilde{b}_{2} = \\begin{pmatrix} \\frac{1}{2} \\\\ 2 \\\\ \\frac{1}{2} \\end{pmatrix} $$\n下一步是计算 $S^{-1} = \\frac{1}{\\det(S)}\\text{adj}(S)$。$S$ 的行列式可以通过沿第一行展开代数余子式来计算：\n$$ \\det(S) = 3 \\cdot \\det\\begin{pmatrix} 3 & 1 \\\\ 1 & 3 \\end{pmatrix} - 1 \\cdot \\det\\begin{pmatrix} 1 & 1 \\\\ \\frac{9}{32} & 3 \\end{pmatrix} + \\frac{9}{32} \\cdot \\det\\begin{pmatrix} 1 & 3 \\\\ \\frac{9}{32} & 1 \\end{pmatrix} $$\n$$ \\det(S) = 3(9-1) - 1(3 - \\frac{9}{32}) + \\frac{9}{32}(1 - \\frac{27}{32}) = 24 - \\frac{87}{32} + \\frac{9}{32}\\frac{5}{32} = 24 - \\frac{87}{32} + \\frac{45}{1024} $$\n$$ \\det(S) = \\frac{24 \\cdot 1024 - 87 \\cdot 32 + 45}{1024} = \\frac{24576 - 2784 + 45}{1024} = \\frac{21837}{1024} $$\n为了计算 $(\\tilde{B} S^{-1} \\tilde{B})_{22} = \\tilde{b}_{2}^{T} S^{-1} \\tilde{b}_{2}$，我们可以通过求解线性方程组 $Sy = \\tilde{b}_2$ 来得到 $y = S^{-1} \\tilde{b}_2$，然后计算 $\\tilde{b}_2^T y$。由于 $S$ 和 $\\tilde{B}$ 都是对称且中心对称的，我们可以推断 $y$ 也将是中心对称的，即 $y_1=y_3$。这简化了方程组：\n1. $3y_1 + y_2 + \\frac{9}{32}y_3 = \\frac{1}{2} \\implies (3+\\frac{9}{32})y_1 + y_2 = \\frac{1}{2} \\implies \\frac{105}{32}y_1 + y_2 = \\frac{1}{2}$\n2. $y_1 + 3y_2 + y_3 = 2 \\implies 2y_1 + 3y_2 = 2$\n从第二个方程，我们得到 $y_1 = 1 - \\frac{3}{2}y_2$。代入第一个方程：\n$$ \\frac{105}{32}(1 - \\frac{3}{2}y_2) + y_2 = \\frac{1}{2} $$\n$$ \\frac{105}{32} - \\frac{315}{64}y_2 + y_2 = \\frac{1}{2} \\implies \\frac{105}{32} - \\frac{1}{2} = (\\frac{315}{64} - \\frac{64}{64})y_2 $$\n$$ \\frac{105-16}{32} = \\frac{251}{64}y_2 \\implies \\frac{89}{32} = \\frac{251}{64}y_2 \\implies y_2 = \\frac{89}{32} \\cdot \\frac{64}{251} = \\frac{178}{251} $$\n现在我们计算 $y_1 = 1 - \\frac{3}{2} \\cdot \\frac{178}{251} = 1 - \\frac{267}{251} = \\frac{251-267}{251} = -\\frac{16}{251}$。\n所以 $y = S^{-1}\\tilde{b}_2 = \\frac{1}{251} \\begin{pmatrix} -16, 178, -16 \\end{pmatrix}^T$。\n最后，计算二次型：\n$$ (\\tilde{B} S^{-1} \\tilde{B})_{22} = \\tilde{b}_2^T y = \\frac{1}{2}y_1 + 2y_2 + \\frac{1}{2}y_3 = y_1 + 2y_2 $$\n$$ = -\\frac{16}{251} + 2 \\cdot \\frac{178}{251} = \\frac{-16+356}{251} = \\frac{340}{251} $$\n最后，我们计算 $P_{a}^{\\mathrm{loc}}(2,2)$：\n$$ P_{a}^{\\mathrm{loc}}(2,2) = \\tilde{B}_{22} - (\\tilde{B} S^{-1} \\tilde{B})_{22} = 2 - \\frac{340}{251} = \\frac{2 \\cdot 251 - 340}{251} = \\frac{502 - 340}{251} = \\frac{162}{251} $$\n\n**2.3. 最终数值**\n问题要求答案为一个实数，并四舍五入到四位有效数字。\n$$ \\frac{162}{251} \\approx 0.6454183... $$\n四舍五入到四位有效数字得到 $0.6454$。", "answer": "$$\n\\boxed{0.6454}\n$$", "id": "3373230"}, {"introduction": "协方差局域化的真正威力，在那些简单的欧几里得距离不足以衡量变量间实际关联的非规则领域中，表现得尤为突出。本练习以一个交通网络为背景——这是一个经典的图结构领域范例——你将基于真实的道路图距离来实现一个局域化方案。这个练习旨在解决交通拥堵回溢场景下的数据同化问题，让你能直观地看到局域化如何精确地将观测信息约束在相关路段，并有效防止其“泄漏”到不相关的支路。[@problem_id:3373233]", "problem": "考虑一个为有限道路图上定义的交通密度而设的线性高斯数据同化问题。设状态向量为 $x \\in \\mathbb{R}^n$，表示各路段的车辆密度，单位为车辆数/公里。设预报（先验）被建模为一个高斯随机向量 $x \\sim \\mathcal{N}(m^f, P^f)$，其均值为 $m^f \\in \\mathbb{R}^n$，协方差为 $P^f \\in \\mathbb{R}^{n \\times n}$。假设观测是线性的且带有噪声，$y = H x + \\eta$，其中 $H \\in \\mathbb{R}^{p \\times n}$ 是作用于一部分路段子集上的选择算子（因此 $H$ 的行是标准基向量），并且 $\\eta \\sim \\mathcal{N}(0, R)$，其中 $R \\in \\mathbb{R}^{p \\times p}$ 是对称正定矩阵。\n\n在协方差局地化中，我们基于一个应用于缩放后道路图距离的相关函数 $\\rho(\\cdot)$ 来构建一个局地化矩阵 $L \\in \\mathbb{R}^{n \\times n}$，并用舒尔（逐元素）积 $P^f_{\\text{loc}} = L \\circ P^f$ 替换先验协方差。具体来说，定义一个包含 $n$ 个路段的道路图，具有无向邻接关系和以公里为单位的路段长度。将道路图距离 $d_{\\text{road}}(i,j)$ 定义为路段 $i$ 和 $j$ 中心之间的最短路径长度，该路径长度使用等于两个相邻路段长度之和一半的边长计算得出。设局地化矩阵的元素为 $L_{ij} = \\rho\\!\\left( d_{\\text{road}}(i,j) / \\ell \\right)$，其中局地化半径 $\\ell > 0$ 的单位为公里。相关函数 $\\rho(r)$ 是 Gaspari 和 Cohn 提出的五阶紧支集函数（为分段多项式，在 $r \\ge 2$ 时为零）：\n- 对于 $0 \\le r \\le 1$，\n$$\n\\rho(r) = 1 - \\frac{5}{3} r^2 + \\frac{5}{8} r^3 + \\frac{1}{2} r^4 - \\frac{1}{4} r^5.\n$$\n- 对于 $1  r  2$，\n$$\n\\rho(r) = -\\frac{2}{3}\\frac{1}{r} + 4 - 5 r + \\frac{5}{3} r^2 + \\frac{5}{8} r^3 - \\frac{1}{2} r^4 + \\frac{1}{12} r^5.\n$$\n- 对于 $r \\ge 2$，$\\rho(r) = 0$。\n\n假设一个固定的道路图，有 $n = 8$ 个路段，标记为 $0,1,\\dots,7$，路段长度（单位：公里）\n$$\n\\ell_0 = 0.3,\\ \\ell_1 = 0.4,\\ \\ell_2 = 0.5,\\ \\ell_3 = 0.5,\\ \\ell_4 = 0.4,\\ \\ell_5 = 0.3,\\ \\ell_6 = 0.4,\\ \\ell_7 = 0.5,\n$$\n以及如下描述的无向邻接关系：主干道是一条连接 $(0\\text{--}1), (1\\text{--}2), (2\\text{--}3), (3\\text{--}4), (4\\text{--}5)$ 的链；一条支路在路段 $2$ 处连接，并延续为 $(2\\text{--}6), (6\\text{--}7)$。道路图距离 $d_{\\text{road}}(i,j)$ 对相邻路段使用边权重 $w_{ij} = (\\ell_i + \\ell_j)/2$，并且是 $i$ 和 $j$ 之间此类权重的最短路径总和。\n\n设基准自由流密度为 20 辆车/公里。定义一个由严重性参数 $s \\in [0,1]$ 参数化的拥堵回溢场景。真实状态 $x^{\\text{true}}(s) \\in \\mathbb{R}^8$（单位：车辆数/公里）为\n- 在主干道上：$x^{\\text{true}}_5 = 120$， $x^{\\text{true}}_4 = 120$， $x^{\\text{true}}_3 = 20 + 80 s$， $x^{\\text{true}}_2 = 20 + 60 s$， $x^{\\text{true}}_1 = 20 + 40 s$， $x^{\\text{true}}_0 = 20 + 20 s$。\n- 在支路上：$x^{\\text{true}}_6 = 20$， $x^{\\text{true}}_7 = 20$。\n\n假设预报均值 $m^f \\in \\mathbb{R}^8$ 有偏差且低估了拥堵回溢：\n- $m^f_4 = 80$， $m^f_5 = 90$，对于所有其他路段 $i \\in \\{0,1,2,3,6,7\\}$，$m^f_i = 20$。\n\n假设先验协方差 $P^f$ 遵循一个稳态图指数模型，\n$$\nP^f_{ij} = \\sigma_b^2 \\exp\\!\\left(-\\frac{d_{\\text{road}}(i,j)}{\\xi}\\right),\n$$\n背景方差为 $\\sigma_b^2 = 400$ (车辆数/公里)$^2$，相关长度为 $\\xi = 1.2$ 公里。\n\n观测是在两个路段（$p=2$，索引为 4 和 2，位于主干道的下游和中游）获取的带噪声的密度。观测算子 $H$ 选择 $x$ 的这两个分量。观测噪声协方差为 $R = \\operatorname{diag}(9,9)$ (车辆数/公里)$^2$。实现的观测向量为\n$$\ny = \\begin{bmatrix} x^{\\text{true}}_4(s) + 2.0 \\\\ x^{\\text{true}}_2(s) - 1.5 \\end{bmatrix}.\n$$\n\n任务：\n1. 从线性高斯贝叶斯估计的基本原理出发，推导分析（后验）均值 $m^a$ 作为局地化先验协方差 $P^f_{\\text{loc}}$、预报均值 $m^f$、观测算子 $H$、观测噪声协方差 $R$ 和观测值 $y$ 的函数。不要假设任何预先推导出的滤波器公式；从高斯条件作用或二次优化的第一性原理进行推导。\n2. 实现道路图距离 $d_{\\text{road}}(i,j)$、Gaspari–Cohn 相关函数 $\\rho(r)$ 以及局地化矩阵 $L$，其中 $L_{ij} = \\rho\\!\\left(d_{\\text{road}}(i,j)/\\ell\\right)$，$\\ell$ 为给定的局地化半径。在分析步骤中使用 $P^f_{\\text{loc}} = L \\circ P^f$。\n3. 对下面指定的每个测试用例，计算分析均值 $m^a$，然后计算两个误差指标：\n   - 主干道路段 0 到 5 的均方根误差，\n   $$\n   \\operatorname{RMSE}_{\\text{main}} = \\sqrt{ \\frac{1}{6} \\sum_{i=0}^{5} \\left( m^a_i - x^{\\text{true}}_i(s) \\right)^2 }.\n   $$\n   - 支路路段 6 和 7 的均方根误差，\n   $$\n   \\operatorname{RMSE}_{\\text{branch}} = \\sqrt{ \\frac{1}{2} \\sum_{i=6}^{7} \\left( m^a_i - x^{\\text{true}}_i(s) \\right)^2 }.\n   $$\n   两个误差指标都必须以浮点数形式表示，单位为车辆数/公里。\n4. 通过报告每个测试用例的两个误差指标，评估局地化半径 $\\ell$ 在拥堵回溢情况下对估计的影响。\n\n测试套件：\n- 用例 A (理想路径)：$s = 1.0$，$\\ell = 0.2$ 公里。\n- 用例 B (中等局地化)：$s = 1.0$，$\\ell = 0.6$ 公里。\n- 用例 C (弱局地化)：$s = 1.0$，$\\ell = 2.0$ 公里。\n- 用例 D (无局地化)：$s = 1.0$，$\\ell \\to \\infty$（视为 $L_{ij} = 1$ 对所有 $i,j$ 成立）。\n- 用例 E (拥堵回溢严重性降低)：$s = 0.5$，$\\ell = 0.6$ 公里。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表。列表中的每个元素是一个包含两个浮点数的列表 $[\\operatorname{RMSE}_{\\text{main}}, \\operatorname{RMSE}_{\\text{branch}}]$，单位为车辆数/公里，顺序与上述测试套件一致。例如，它应该看起来像\n$$\n\\text{[}[r_1^{\\text{main}}, r_1^{\\text{branch}}],[r_2^{\\text{main}}, r_2^{\\text{branch}}],\\dots\\text{]}.\n$$", "solution": "用户提供的问题是一个适定且科学合理的数据同化练习，专门用于演示协方差局地化在集合卡尔曼滤波器类分析步骤（通常称为 3D-Var）中的概念和影响。该问题是自洽的，提供了所有必要的数据和函数形式。经过彻底审查，未发现任何会妨礙严谨求解的矛盾、模糊之处或事实错误。因此，该问题被认定为**有效**。\n\n解决方案分为两个主要部分：首先是分析均值的理论推导，其次是针对指定测试用例的数值实现和计算。\n\n### 第 1 部分：分析均值的推导\n\n分析状态，或称后验均值 $m^a$，是在给定 $x$ 的先验分布和观测值 $y$ 的似然性的情况下，使后验概率密度 $p(x|y)$ 最大化的状态向量 $x$。在线性高斯框架中，这等同于找到二次代价函数 $J(x)$ 的最小值。\n\n先验信息是状态 $x$ 是一个高斯随机变量，其均值为 $m^f$，协方差为 $P^f_{\\text{loc}}$。其概率密度正比于 $\\exp(-\\frac{1}{2} (x - m^f)^T (P^f_{\\text{loc}})^{-1} (x - m^f))$。\n观测值 $y$ 通过 $y = Hx + \\eta$ 与状态相关，其中噪声 $\\eta$ 是一个均值为 $0$、协方差为 $R$ 的高斯随机变量。这定义了似然函数 $p(y|x)$，它正比于 $\\exp(-\\frac{1}{2} (y - Hx)^T R^{-1} (y - Hx))$。\n\n根据贝叶斯定理，后验概率 $p(x|y)$ 正比于似然函数与先验概率的乘积，即 $p(x|y) \\propto p(y|x) p(x)$。最大化后验概率等同于最小化其负对数。这定义了代价函数 $J(x)$：\n$$\nJ(x) = \\frac{1}{2} (x - m^f)^T (P^f_{\\text{loc}})^{-1} (x - m^f) + \\frac{1}{2} (y - Hx)^T R^{-1} (y - Hx)\n$$\n分析均值 $m^a$ 是使 $J(x)$ 最小化的 $x$ 值。我们通过计算 $J(x)$ 对 $x$ 的梯度并将其设为零来找到这个值。\n$$\n\\nabla_x J(x) = (P^f_{\\text{loc}})^{-1} (x - m^f) - H^T R^{-1} (y - Hx)\n$$\n令 $\\nabla_x J(m^a) = 0$：\n$$\n(P^f_{\\text{loc}})^{-1} (m^a - m^f) - H^T R^{-1} (y - Hm^a) = 0\n$$\n重新整理各项以求解 $m^a$：\n$$\n(P^f_{\\text{loc}})^{-1} m^a - (P^f_{\\text{loc}})^{-1} m^f + H^T R^{-1} H m^a - H^T R^{-1} y = 0\n$$\n$$\n((P^f_{\\text{loc}})^{-1} + H^T R^{-1} H) m^a = (P^f_{\\text{loc}})^{-1} m^f + H^T R^{-1} y\n$$\n$$\nm^a = ((P^f_{\\text{loc}})^{-1} + H^T R^{-1} H)^{-1} ((P^f_{\\text{loc}})^{-1} m^f + H^T R^{-1} y)\n$$\n该形式需要对一个 $n \\times n$ 矩阵求逆。一种在卡尔曼滤波中更常见、计算效率更高的形式可以使用 Woodbury 矩阵恒等式推导得出。该恒等式为 $(A+UCV)^{-1} = A^{-1} - A^{-1}U(C^{-1}+VA^{-1}U)^{-1}VA^{-1}$。应用该恒等式可得到等价表达式：\n$$\nm^a = m^f + K (y - H m^f)\n$$\n其中 $K$ 是卡尔曼增益矩阵，由下式给出：\n$$\nK = P^f_{\\text{loc}} H^T (H P^f_{\\text{loc}} H^T + R)^{-1}\n$$\n这种表述方式的优势在于它需要对矩阵 $(H P^f_{\\text{loc}} H^T + R)$ 求逆，而该矩阵的大小为 $p \\times p$。在本问题中，$n=8$ 且 $p=2$，因此对一个 $2 \\times 2$ 矩阵求逆比对一个 $8 \\times 8$ 矩阵求逆要简单得多。我们将在计算中使用后一种形式。\n\n### 第 2 部分：数值实现与计算\n\n解决方案通过以下步骤实现：\n\n1.  **构建道路图并计算距离**：道路网络表示为一个有 $n=8$ 个节点（路段）的无向图。相邻路段 $i$ 和 $j$ 之间边的权重设置为 $w_{ij} = (\\ell_i + \\ell_j)/2$，其中 $\\ell_i$ 是路段 $i$ 的长度。使用 Floyd-Warshall 算法计算所有节点对之间的最短路径距离 $d_{\\text{road}}(i,j)$。\n\n2.  **定义模型组件**：根据问题说明构建预报均值向量 $m^f$、先验协方差矩阵 $P^f$、观测算子 $H$ 和观测误差协方差矩阵 $R$。$P^f$ 使用计算出的 $d_{\\text{road}}(i,j)$ 矩阵构建。\n\n3.  **实现相关函数**：实现所提供的五阶分段多项式相关函数 $\\rho(r)$。该函数在其过渡点是连续且二阶可微的 ($C^2$)。\n\n4.  **处理测试用例**：对于每个由参数 $s$（拥堵回溢严重性）和 $\\ell$（局地化半径）定义的测试用例：\n    a.  计算真实状态 $x^{\\text{true}}(s)$ 和观测向量 $y(s)$。\n    b.  计算局地化矩阵 $L$，其中 $L_{ij} = \\rho(d_{\\text{road}}(i,j) / \\ell)$。对于特殊情况 $\\ell \\to \\infty$，$L$ 是一个全为 1 的矩阵。\n    c.  通过舒尔积计算局地化的先验协方差：$P^f_{\\text{loc}} = L \\circ P^f$。\n    d.  使用上面推导的卡尔曼更新公式计算分析均值 $m^a$。\n    e.  通过将分析均值 $m^a$ 与真实状态 $x^{\\text{true}}(s)$进行比较，计算主干道 ($\\operatorname{RMSE}_{\\text{main}}$) 和支路 ($\\operatorname{RMSE}_{\\text{branch}}$) 的均方根误差。\n\n收集每个测试用例的结果，并将其格式化为所需的输出字符串。这些计算展示了局地化的作用：通过调整半径 $\\ell$，可以控制来自观测的信息传播。较小的 $\\ell$ 可以防止主干道上的观测对不相关的支路产生虚假影响，从而降低 `RMSE_branch`。然而，如果 $\\ell$ 太小，也可能抑制有用信息在主干道自身的传播。无限大的 $\\ell$（无局地化）导致标准的分析更新，其中虚假相关性可能会降低在未观测或弱相关区域的状态估计质量。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the traffic data assimilation problem for all test cases.\n    \"\"\"\n    # ------------------ Fixed Problem Parameters ------------------\n    \n    # Graph definition\n    n = 8\n    seg_lengths = np.array([0.3, 0.4, 0.5, 0.5, 0.4, 0.3, 0.4, 0.5])\n    adjacency = {\n        0: [1], 1: [0, 2], 2: [1, 3, 6], 3: [2, 4], 4: [3, 5],\n        5: [4], 6: [2, 7], 7: [6]\n    }\n\n    # Forecast (prior) model parameters\n    mf = np.full(n, 20.0)\n    mf[4] = 80.0\n    mf[5] = 90.0\n    sigma_b2 = 400.0\n    xi = 1.2\n\n    # Observation model parameters\n    p = 2\n    H = np.zeros((p, n))\n    H[0, 4] = 1.0  # Observation of segment 4\n    H[1, 2] = 1.0  # Observation of segment 2\n    R = np.diag([9.0, 9.0])\n\n    # ------------------ Pre-computations ------------------\n\n    # 1. Compute road-graph distance matrix d_road\n    d_road = np.full((n, n), np.inf)\n    np.fill_diagonal(d_road, 0)\n    for i in range(n):\n        for j in adjacency.get(i, []):\n            d_road[i, j] = (seg_lengths[i] + seg_lengths[j]) / 2.0\n\n    # Floyd-Warshall algorithm for all-pairs shortest paths\n    for k in range(n):\n        for i in range(n):\n            for j in range(n):\n                d_road[i, j] = min(d_road[i, j], d_road[i, k] + d_road[k, j])\n\n    # 2. Compute prior covariance matrix Pf\n    Pf = sigma_b2 * np.exp(-d_road / xi)\n    \n    # 3. Define Gaspari-Cohn correlation function\n    def gaspari_cohn_rho(r_in):\n        r_in = np.asarray(r_in)\n        r = np.abs(r_in)\n        rho = np.zeros_like(r, dtype=float)\n\n        # 0 = r = 1\n        mask1 = r = 1.0\n        r1 = r[mask1]\n        rho[mask1] = (1.0 - (5.0/3.0)*r1**2 + (5.0/8.0)*r1**3 + \n                      (1.0/2.0)*r1**4 - (1.0/4.0)*r1**5)\n\n        # 1  r  2\n        mask2 = (r > 1.0)  (r  2.0)\n        r2 = r[mask2]\n        rho[mask2] = ((-2.0/3.0)/r2 + 4.0 - 5.0*r2 + (5.0/3.0)*r2**2 + \n                      (5.0/8.0)*r2**3 - (1.0/2.0)*r2**4 + (1.0/12.0)*r2**5)\n\n        # r >= 2 -> rho = 0, which is the default\n        return rho\n\n    # ------------------ Test Case Processing ------------------\n\n    test_cases = [\n        (1.0, 0.2),       # Case A\n        (1.0, 0.6),       # Case B\n        (1.0, 2.0),       # Case C\n        (1.0, np.inf),    # Case D\n        (0.5, 0.6)        # Case E\n    ]\n\n    results = []\n    for s, ell in test_cases:\n        # a. Compute true state and observation\n        xtrue = np.full(n, 20.0)\n        xtrue[5] = 120.0\n        xtrue[4] = 120.0\n        xtrue[3] = 20.0 + 80.0 * s\n        xtrue[2] = 20.0 + 60.0 * s\n        xtrue[1] = 20.0 + 40.0 * s\n        xtrue[0] = 20.0 + 20.0 * s\n        \n        y = np.array([xtrue[4] + 2.0, xtrue[2] - 1.5])\n\n        # b. Compute localization matrix L\n        if np.isinf(ell):\n            L = np.ones((n, n))\n        else:\n            L = gaspari_cohn_rho(d_road / ell)\n\n        # c. Compute localized prior covariance\n        Pf_loc = L * Pf\n\n        # d. Compute analysis mean ma\n        innovation = y - H @ mf\n        innovation_cov = H @ Pf_loc @ H.T + R\n        kalman_gain = Pf_loc @ H.T @ np.linalg.inv(innovation_cov)\n        ma = mf + kalman_gain @ innovation\n\n        # e. Compute RMSE metrics\n        diff = ma - xtrue\n        rmse_main = np.sqrt(np.mean(diff[0:6]**2))\n        rmse_branch = np.sqrt(np.mean(diff[6:8]**2))\n        \n        results.append([rmse_main, rmse_branch])\n\n    # ------------------ Final Output ------------------\n    # Convert lists of floats to strings for the specific output format\n    print(f\"[[{results[0][0]},{results[0][1]}],[{results[1][0]},{results[1][1]}],[{results[2][0]},{results[2][1]}],[{results[3][0]},{results[3][1]}],[{results[4][0]},{results[4][1]}]]\")\n\nsolve()\n```", "id": "3373233"}, {"introduction": "在实际应用协方差局域化时，一个至关重要的问题是如何确定最佳的局域化长度尺度 $\\ell$。这个高级练习将引导你超越依赖经验或试错的传统方法，为你介绍一种基于最大化边缘似然（marginal likelihood）的原则性统计方法。通过从第一性原理出发，推导对数似然函数关于 $\\ell$ 的梯度，你将掌握使用优化算法来寻找由数据本身驱动的最佳局域化半径的核心技术。[@problem_id:3373258]", "problem": "考虑一个线性逆问题，其中未知状态向量 $x \\in \\mathbb{R}^{n}$ 服从一个协方差矩阵为 $P_{b} \\in \\mathbb{R}^{n \\times n}$ 的零均值高斯先验分布，且观测值 $y \\in \\mathbb{R}^{m}$ 通过一个线性观测算子 $H \\in \\mathbb{R}^{m \\times n}$ 和加性高斯噪声与状态相关联。具体来说，假设 $x \\sim \\mathcal{N}(0, P_{b,\\ell})$ 且 $y \\mid x \\sim \\mathcal{N}(H x, R)$，其中 $R \\in \\mathbb{R}^{m \\times m}$ 是一个对称正定的观测误差协方差。先验协方差 $P_{b,\\ell}$ 是通过对一个给定的对称半正定背景协方差 $P_{b}$ 使用长度标度为 $\\ell  0$ 的锥化函数进行协方差局域化得到的，具体为\n$$\nP_{b,\\ell} \\;=\\; P_{b} \\circ \\rho_{\\ell},\n$$\n其中 $\\circ$ 表示阿达玛（逐元素）积，且 $\\rho_{\\ell} \\in \\mathbb{R}^{n \\times n}$ 定义为\n$$\n(\\rho_{\\ell})_{ij} \\;=\\; \\exp\\!\\left(-\\frac{d_{ij}^{2}}{\\ell^{2}}\\right),\n$$\n其中 $d_{ij} \\geq 0$ 表示状态网格点 $i$ 和 $j$ 之间的已知物理距离。令 $D \\in \\mathbb{R}^{n \\times n}$ 表示距离矩阵，其元素为 $D_{ij} = d_{ij}$，并令 $D^{\\circ 2}$ 表示其逐元素平方，即 $(D^{\\circ 2})_{ij} = d_{ij}^{2}$。定义边缘数据协方差\n$$\nS(\\ell) \\;=\\; H P_{b,\\ell} H^{\\top} + R,\n$$\n因此给定 $\\ell$ 时 $y$ 的边缘似然是协方差为 $S(\\ell)$ 的高斯分布。\n\n您的任务是构建用于选择锥化长度标度 $\\ell$ 的最大边缘似然问题，并从第一性原理出发，推导对数边缘似然关于 $\\ell$ 的梯度。您的推导必须从高斯边缘化和标准矩阵微积分恒等式的定义出发，不得假设任何预先给出的专用公式。仅使用诸如高斯密度形式、迹算子性质以及矩阵对数导数等经过充分检验的事实。\n\n说明：\n- 从线性高斯模型导出的边缘似然 $p(y \\mid \\ell)$ 的定义开始，并用 $S(\\ell)$ 表示 $\\ln p(y \\mid \\ell)$。\n- 通过对您的表达式求导，推导出 $\\partial \\ln p(y \\mid \\ell)/\\partial \\ell$，并用 $S(\\ell)$、其逆矩阵以及导数 $\\partial S(\\ell)/\\partial \\ell$ 来表示结果。\n- 用 $H$、$P_{b}$、$\\rho_{\\ell}$、$D^{\\circ 2}$ 和 $\\ell$ 显式计算 $\\partial S(\\ell)/\\partial \\ell$。\n- 根据您的梯度表达式，陈述刻画任何最大化子 $\\ell^{\\star}$ 的一阶最优性条件（您无需求解 $\\ell^{\\star}$ 的数值）。\n\n您的最终答案应该是 $\\partial \\ln p(y \\mid \\ell)/\\partial \\ell$ 的一个单一闭式解析表达式，仅用 $y$、$H$、$P_{b}$、$R$、$D^{\\circ 2}$、$\\rho_{\\ell}$ 和 $\\ell$ 表示。不应包含任何单位。不应提供数值计算。", "solution": "该问题要求构建锥化长度标度 $\\ell$ 的最大边缘似然问题，并推导对数边缘似然函数关于 $\\ell$ 的梯度。\n\n### 问题验证\n该问题定义明确、科学上可靠，并且处于贝叶斯逆问题和数据同化的标准框架内。所有术语都有正式定义，设置是一致且自洽的，目标是一个特定的数学推导。该问题依赖于概率论、线性代数和矩阵微积分的既定原理。未发现任何缺陷。该问题被认为是有效的。\n\n### 推导\n\n问题在于找到超参数 $\\ell$ 的值，以最大化边缘似然 $p(y \\mid \\ell)$。这等同于最大化对数边缘似然 $\\ln p(y \\mid \\ell)$。该优化问题表述为：\n$$\n\\ell^{\\star} = \\arg\\max_{\\ell  0} \\ln p(y \\mid \\ell)\n$$\n\n**第 1 步：构建对数边缘似然**\n\n观测值 $y$ 的模型是 $y = Hx + \\epsilon$，其中 $x \\sim \\mathcal{N}(0, P_{b,\\ell})$ 和 $\\epsilon \\sim \\mathcal{N}(0, R)$ 是独立的高斯随机向量。$y$ 的最终边缘分布也是高斯的。其均值为：\n$$\n\\mathbb{E}[y \\mid \\ell] = \\mathbb{E}[Hx + \\epsilon] = H\\mathbb{E}[x] + \\mathbb{E}[\\epsilon] = H \\cdot 0 + 0 = 0\n$$\n$y$ 的协方差，记为 $S(\\ell)$，是：\n$$\n\\text{Cov}(y \\mid \\ell) = \\mathbb{E}[y y^{\\top}] = \\mathbb{E}[(Hx+\\epsilon)(Hx+\\epsilon)^{\\top}] = \\mathbb{E}[Hxx^{\\top}H^{\\top} + Hx\\epsilon^{\\top} + \\epsilon x^{\\top}H^{\\top} + \\epsilon\\epsilon^{\\top}]\n$$\n由于 $x$ 和 $\\epsilon$ 是独立的且均值为零，交叉项消失：$\\mathbb{E}[Hx\\epsilon^{\\top}] = H\\mathbb{E}[x]\\mathbb{E}[\\epsilon^{\\top}] = 0$。因此，\n$$\nS(\\ell) = H\\mathbb{E}[xx^{\\top}]H^{\\top} + \\mathbb{E}[\\epsilon\\epsilon^{\\top}] = H P_{b,\\ell} H^{\\top} + R\n$$\n因此，$y$ 的边缘分布是 $y \\mid \\ell \\sim \\mathcal{N}(0, S(\\ell))$。作为边缘似然的概率密度函数是：\n$$\np(y \\mid \\ell) = (2\\pi)^{-m/2} (\\det(S(\\ell)))^{-1/2} \\exp\\left(-\\frac{1}{2} y^{\\top} S(\\ell)^{-1} y\\right)\n$$\n因此，对数边缘似然为：\n$$\n\\ln p(y \\mid \\ell) = -\\frac{m}{2} \\ln(2\\pi) - \\frac{1}{2} \\ln(\\det(S(\\ell))) - \\frac{1}{2} y^{\\top} S(\\ell)^{-1} y\n$$\n\n**第 2 步：对对数边缘似然求导**\n\n为了求得关于 $\\ell$ 的梯度，我们对 $\\ln p(y \\mid \\ell)$ 的表达式进行微分。项 $-\\frac{m}{2}\\ln(2\\pi)$ 相对于 $\\ell$ 是常数，因此其导数为零。\n$$\n\\frac{\\partial}{\\partial \\ell} \\ln p(y \\mid \\ell) = -\\frac{1}{2} \\frac{\\partial}{\\partial \\ell} \\left( \\ln(\\det(S(\\ell))) \\right) - \\frac{1}{2} \\frac{\\partial}{\\partial \\ell} \\left( y^{\\top} S(\\ell)^{-1} y \\right)\n$$\n我们使用两个标准的矩阵微积分恒等式。对于一个依赖于标量 $t$ 的对称可逆矩阵 $A(t)$：\n1.  雅可比公式 (Jacobi's formula)：$\\frac{\\partial}{\\partial t} \\ln(\\det(A(t))) = \\text{tr}\\left(A(t)^{-1} \\frac{\\partial A(t)}{\\partial t}\\right)$\n2.  逆矩阵的导数：$\\frac{\\partial}{\\partial t} A(t)^{-1} = -A(t)^{-1} \\frac{\\partial A(t)}{\\partial t} A(t)^{-1}$\n\n将第一个恒等式应用于对数行列式项：\n$$\n\\frac{\\partial}{\\partial \\ell} \\ln(\\det(S(\\ell))) = \\text{tr}\\left(S(\\ell)^{-1} \\frac{\\partial S(\\ell)}{\\partial \\ell}\\right)\n$$\n将第二个恒等式应用于二次型项：\n$$\n\\frac{\\partial}{\\partial \\ell} \\left( y^{\\top} S(\\ell)^{-1} y \\right) = y^{\\top} \\left( \\frac{\\partial S(\\ell)^{-1}}{\\partial \\ell} \\right) y = y^{\\top} \\left( -S(\\ell)^{-1} \\frac{\\partial S(\\ell)}{\\partial \\ell} S(\\ell)^{-1} \\right) y = -y^{\\top} S(\\ell)^{-1} \\frac{\\partial S(\\ell)}{\\partial \\ell} S(\\ell)^{-1} y\n$$\n将这些结果代回到对数似然的导数中：\n$$\n\\frac{\\partial}{\\partial \\ell} \\ln p(y \\mid \\ell) = -\\frac{1}{2} \\text{tr}\\left(S(\\ell)^{-1} \\frac{\\partial S(\\ell)}{\\partial \\ell}\\right) - \\frac{1}{2} \\left(-y^{\\top} S(\\ell)^{-1} \\frac{\\partial S(\\ell)}{\\partial \\ell} S(\\ell)^{-1} y\\right)\n$$\n$$\n\\frac{\\partial}{\\partial \\ell} \\ln p(y \\mid \\ell) = \\frac{1}{2} \\left( y^{\\top} S(\\ell)^{-1} \\frac{\\partial S(\\ell)}{\\partial \\ell} S(\\ell)^{-1} y - \\text{tr}\\left(S(\\ell)^{-1} \\frac{\\partial S(\\ell)}{\\partial \\ell}\\right) \\right)\n$$\n\n**第 3 步：计算边缘协方差 $S(\\ell)$ 的导数**\n\n接下来，我们必须求出 $S(\\ell)$ 关于 $\\ell$ 的导数。\n$$\nS(\\ell) = H P_{b,\\ell} H^{\\top} + R\n$$\n由于 $H$ 和 $R$ 不依赖于 $\\ell$，我们有：\n$$\n\\frac{\\partial S(\\ell)}{\\partial \\ell} = H \\frac{\\partial P_{b,\\ell}}{\\partial \\ell} H^{\\top}\n$$\n局域化协方差 $P_{b,\\ell}$ 定义为阿达玛积 $P_{b,\\ell} = P_b \\circ \\rho_{\\ell}$。由于 $P_b$ 相对于 $\\ell$ 是常数，其导数为：\n$$\n\\frac{\\partial P_{b,\\ell}}{\\partial \\ell} = P_b \\circ \\frac{\\partial \\rho_{\\ell}}{\\partial \\ell}\n$$\n锥化矩阵 $\\rho_{\\ell}$ 的元素由 $(\\rho_{\\ell})_{ij} = \\exp(-d_{ij}^2/\\ell^2)$ 给出。我们逐元素地对它关于 $\\ell$ 求导：\n$$\n\\frac{\\partial (\\rho_{\\ell})_{ij}}{\\partial \\ell} = \\frac{\\partial}{\\partial \\ell} \\exp\\left(-\\frac{d_{ij}^2}{\\ell^2}\\right) = \\exp\\left(-\\frac{d_{ij}^2}{\\ell^2}\\right) \\cdot \\frac{\\partial}{\\partial \\ell}\\left(-d_{ij}^2 \\ell^{-2}\\right)\n$$\n$$\n\\frac{\\partial (\\rho_{\\ell})_{ij}}{\\partial \\ell} = \\exp\\left(-\\frac{d_{ij}^2}{\\ell^2}\\right) \\cdot \\left(-d_{ij}^2 (-2)\\ell^{-3}\\right) = \\exp\\left(-\\frac{d_{ij}^2}{\\ell^2}\\right) \\cdot \\frac{2d_{ij}^2}{\\ell^3} = (\\rho_{\\ell})_{ij} \\cdot \\frac{2d_{ij}^2}{\\ell^3}\n$$\n以矩阵形式，使用距离矩阵的逐元素平方 $D^{\\circ 2}$，这变为：\n$$\n\\frac{\\partial \\rho_{\\ell}}{\\partial \\ell} = \\rho_{\\ell} \\circ \\left(\\frac{2}{\\ell^3} D^{\\circ 2}\\right)\n$$\n将其代回，我们得到：\n$$\n\\frac{\\partial P_{b,\\ell}}{\\partial \\ell} = P_b \\circ \\left( \\rho_{\\ell} \\circ \\left(\\frac{2}{\\ell^3} D^{\\circ 2}\\right) \\right) = \\frac{2}{\\ell^3} \\left( P_b \\circ \\rho_{\\ell} \\circ D^{\\circ 2} \\right)\n$$\n最后，我们得到 $S(\\ell)$ 的导数：\n$$\n\\frac{\\partial S(\\ell)}{\\partial \\ell} = \\frac{2}{\\ell^3} H \\left( P_b \\circ \\rho_{\\ell} \\circ D^{\\circ 2} \\right) H^{\\top}\n$$\n\n**第 4 步：陈述梯度的最终表达式**\n\n将 $\\frac{\\partial S(\\ell)}{\\partial \\ell}$ 的表达式代入我们的对数似然梯度方程中：\n$$\n\\frac{\\partial \\ln p(y \\mid \\ell)}{\\partial \\ell} = \\frac{1}{2} \\left[ y^{\\top} S(\\ell)^{-1} \\left(\\frac{2}{\\ell^3} H (P_b \\circ \\rho_{\\ell} \\circ D^{\\circ 2}) H^{\\top}\\right) S(\\ell)^{-1} y - \\text{tr}\\left(S(\\ell)^{-1} \\left(\\frac{2}{\\ell^3} H (P_b \\circ \\rho_{\\ell} \\circ D^{\\circ 2}) H^{\\top}\\right)\\right) \\right]\n$$\n将标量项 $\\frac{1}{\\ell^3}$ 因子分解出来：\n$$\n\\frac{\\partial \\ln p(y \\mid \\ell)}{\\partial \\ell} = \\frac{1}{\\ell^3} \\left( y^{\\top} S(\\ell)^{-1} H (P_b \\circ \\rho_{\\ell} \\circ D^{\\circ 2}) H^{\\top} S(\\ell)^{-1} y - \\text{tr}\\left(S(\\ell)^{-1} H (P_b \\circ \\rho_{\\ell} \\circ D^{\\circ 2}) H^{\\top}\\right) \\right)\n$$\n对于最终答案，我们代入 $S(\\ell) = H (P_b \\circ \\rho_{\\ell}) H^{\\top} + R$。\n\n**第 5 步：陈述一阶最优性条件**\n\n对数边缘似然函数存在内部最大值 $\\ell^{\\star}$ 的一阶必要条件是，其关于 $\\ell$ 的梯度在 $\\ell^{\\star}$ 处必须为零。因此，任何最大化子 $\\ell^{\\star} \\in (0, \\infty)$ 必须满足：\n$$\n\\frac{\\partial \\ln p(y \\mid \\ell)}{\\partial \\ell} \\bigg|_{\\ell=\\ell^{\\star}} = 0\n$$\n这意味着在 $\\ell = \\ell^{\\star}$ 时：\n$$\ny^{\\top} S(\\ell^{\\star})^{-1} H (P_b \\circ \\rho_{\\ell^{\\star}} \\circ D^{\\circ 2}) H^{\\top} S(\\ell^{\\star})^{-1} y = \\text{tr}\\left(S(\\ell^{\\star})^{-1} H (P_b \\circ \\rho_{\\ell^{\\star}} \\circ D^{\\circ 2}) H^{\\top}\\right)\n$$\n至此按要求完成了推导。", "answer": "$$\\boxed{\\frac{1}{\\ell^3} \\left( y^{\\top} \\left(H (P_{b} \\circ \\rho_{\\ell}) H^{\\top} + R\\right)^{-1} H (P_b \\circ \\rho_{\\ell} \\circ D^{\\circ 2}) H^{\\top} \\left(H (P_{b} \\circ \\rho_{\\ell}) H^{\\top} + R\\right)^{-1} y - \\text{tr}\\left(\\left(H (P_{b} \\circ \\rho_{\\ell}) H^{\\top} + R\\right)^{-1} H (P_b \\circ \\rho_{\\ell} \\circ D^{\\circ 2}) H^{\\top} \\right) \\right)}$$", "id": "3373258"}]}