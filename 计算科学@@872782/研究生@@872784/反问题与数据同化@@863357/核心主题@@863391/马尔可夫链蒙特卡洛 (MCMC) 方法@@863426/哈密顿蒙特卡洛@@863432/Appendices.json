{"hands_on_practices": [{"introduction": "在许多实际的逆问题中，未知参数（如物理量或浓度）天然地受到边界约束。标准的哈密顿蒙特卡洛（HMC）算法要求势能函数$U(u)$处处可微，这使得简单的“硬边界”方法不再适用。本练习介绍了一种标准技术——对数障碍势（logarithmic barrier potential），它能将边界约束平滑地编码到势能函数中。通过推导此障碍势的梯度和Hessian矩阵，你将掌握在HMC框架内处理约束参数的基本数学工具。[@problem_id:3388143]", "problem": "考虑一个贝叶斯逆问题，其中未知参数向量 $u \\in \\mathbb{R}^{n}$ 的每个分量 $i=1,\\dots,n$ 都受到箱式约束 $a_{i}  u_{i}  b_{i}$ 的限制，其中边界 $a_{i} \\in \\mathbb{R}$ 和 $b_{i} \\in \\mathbb{R}$ 为已知，且满足 $a_{i}  b_{i}$。在哈密顿蒙特卡洛 (HMC) 中，势能通常是负对数后验。为了以适用于 HMC 的可微方式来表示这些约束，一种标准方法是添加一个对数障碍势\n$$\nU_{\\mathrm{bar}}(u) = \\sum_{i=1}^{n} \\left( -\\ln\\big(b_{i} - u_{i}\\big) - \\ln\\big(u_{i} - a_{i}\\big) \\right),\n$$\n定义在可行集 $\\{u \\in \\mathbb{R}^{n} : a_{i}  u_{i}  b_{i} \\ \\text{for all } i\\}$ 上。\n\n从微积分基本原理以及梯度和海森矩阵的定义出发，\n$$\n\\nabla U_{\\mathrm{bar}}(u) = \\left( \\frac{\\partial U_{\\mathrm{bar}}}{\\partial u_{1}}, \\dots, \\frac{\\partial U_{\\mathrm{bar}}}{\\partial u_{n}} \\right)^{\\top}, \\qquad \\nabla^{2} U_{\\mathrm{bar}}(u) = \\left[ \\frac{\\partial^{2} U_{\\mathrm{bar}}}{\\partial u_{i} \\partial u_{j}} \\right]_{i,j=1}^{n},\n$$\n在可行集上推导 $U_{\\mathrm{bar}}(u)$ 的梯度向量和海森矩阵的显式闭式表达式。确保您的推导过程从第一性原理（例如，复合函数和自然对数的求导法则）出发并得到充分论证。然后，给出梯度和海森矩阵的最终表达式。\n\n你的最终答案必须是一个单一的闭式解析表达式，并且只包含梯度和海森矩阵的表达式。如果您提供多个表达式，请使用 LaTeX $\\texttt{pmatrix}$ 环境将它们排列成单行。不需要进行数值计算或四舍五入。", "solution": "问题陈述已经过验证，被认为是有效的。它在科学上基于标准的多元微积分及其在贝叶斯统计中的应用，特别是在哈密顿蒙特卡洛方法的背景下。该问题是适定的、自洽的，所有术语都得到了形式上明确无误的定义。不存在矛盾、事实错误或不可行的条件。因此，我们可以开始进行推导。\n\n目标是推导对数障碍势 $U_{\\mathrm{bar}}(u)$ 的梯度向量 $\\nabla U_{\\mathrm{bar}}(u)$ 和海森矩阵 $\\nabla^{2} U_{\\mathrm{bar}}(u)$。该势是为参数向量 $u \\in \\mathbb{R}^{n}$ 定义的，其分量 $u_i$ 受 $a_{i}  u_{i}  b_{i}$（$i=1, \\dots, n$）约束。该函数由下式给出：\n$$\nU_{\\mathrm{bar}}(u) = \\sum_{i=1}^{n} \\left( -\\ln\\big(b_{i} - u_{i}\\big) - \\ln\\big(u_{i} - a_{i}\\big) \\right)\n$$\n约束 $a_{i}  u_{i}  b_{i}$ 确保自然对数的自变量 $b_{i} - u_{i}$ 和 $u_{i} - a_{i}$ 严格为正，从而保证函数在可行集上是良定义的和实值的。\n\n**1. 梯度向量的推导**\n\n梯度向量 $\\nabla U_{\\mathrm{bar}}(u)$ 是一个向量，其分量是 $U_{\\mathrm{bar}}(u)$ 对每个变量 $u_k$ 的偏导数。梯度的第 $k$ 个分量由 $\\frac{\\partial U_{\\mathrm{bar}}}{\\partial u_{k}}$ 给出，其中 $k \\in \\{1, \\dots, n\\}$。\n\n我们将偏导数算子 $\\frac{\\partial}{\\partial u_k}$ 应用于 $U_{\\mathrm{bar}}(u)$ 的表达式：\n$$\n\\frac{\\partial U_{\\mathrm{bar}}}{\\partial u_{k}} = \\frac{\\partial}{\\partial u_{k}} \\left[ \\sum_{i=1}^{n} \\left( -\\ln\\big(b_{i} - u_{i}\\big) - \\ln\\big(u_{i} - a_{i}\\big) \\right) \\right]\n$$\n根据微分求和法则，和的导数等于导数的和。我们可以将偏导数算子移到求和符号内部：\n$$\n\\frac{\\partial U_{\\mathrm{bar}}}{\\partial u_{k}} = \\sum_{i=1}^{n} \\frac{\\partial}{\\partial u_{k}} \\left( -\\ln\\big(b_{i} - u_{i}\\big) - \\ln\\big(u_{i} - a_{i}\\big) \\right)\n$$\n求和号内的项仅依赖于变量 $u_i$。因此，对于所有 $i \\neq k$，它关于 $u_k$ 的偏导数为零。对求和的唯一非零贡献来自 $i=k$ 的项。\n$$\n\\frac{\\partial U_{\\mathrm{bar}}}{\\partial u_{k}} = \\frac{\\partial}{\\partial u_{k}} \\left( -\\ln\\big(b_{k} - u_{k}\\big) - \\ln\\big(u_{k} - a_{k}\\big) \\right)\n$$\n我们对每一项分别求导。根据微积分的第一性原理，自然对数函数 $\\ln(x)$ 的导数是 $\\frac{1}{x}$。我们使用链式法则，即对于复合函数 $f(g(x))$，其导数为 $f'(g(x))g'(x)$。\n\n对于第一项 $-\\ln(b_{k} - u_{k})$，令 $f(v) = -\\ln(v)$ 且 $v(u_k) = b_k - u_k$。那么 $f'(v) = -\\frac{1}{v}$ 且 $v'(u_k) = -1$。应用链式法则：\n$$\n\\frac{\\partial}{\\partial u_{k}} \\left( -\\ln\\big(b_{k} - u_{k}\\big) \\right) = \\left( -\\frac{1}{b_{k} - u_{k}} \\right) \\cdot (-1) = \\frac{1}{b_{k} - u_{k}}\n$$\n对于第二项 $-\\ln(u_{k} - a_{k})$，令 $f(v) = -\\ln(v)$ 且 $v(u_k) = u_k - a_k$。那么 $f'(v) = -\\frac{1}{v}$ 且 $v'(u_k) = 1$。应用链式法则：\n$$\n\\frac{\\partial}{\\partial u_{k}} \\left( -\\ln\\big(u_{k} - a_{k}\\big) \\right) = \\left( -\\frac{1}{u_{k} - a_{k}} \\right) \\cdot (1) = -\\frac{1}{u_{k} - a_{k}}\n$$\n结合这些结果，得到梯度的第 $k$ 个分量：\n$$\n\\frac{\\partial U_{\\mathrm{bar}}}{\\partial u_{k}} = \\frac{1}{b_{k} - u_{k}} - \\frac{1}{u_{k} - a_{k}}\n$$\n因此，完整的梯度向量 $\\nabla U_{\\mathrm{bar}}(u)$ 是一个列向量，其第 $k$ 个元素是上述表达式。\n\n**2. 海森矩阵的推导**\n\n海森矩阵 $\\nabla^{2} U_{\\mathrm{bar}}(u)$ 是一个 $n \\times n$ 矩阵，其第 $j$ 行第 $k$ 列的元素是二阶偏导数 $\\frac{\\partial^{2} U_{\\mathrm{bar}}}{\\partial u_{j} \\partial u_{k}}$。我们可以通过对我们刚刚推导出的梯度分量进行求导来得到它：\n$$\n\\left[ \\nabla^{2} U_{\\mathrm{bar}}(u) \\right]_{jk} = \\frac{\\partial^{2} U_{\\mathrm{bar}}}{\\partial u_{j} \\partial u_{k}} = \\frac{\\partial}{\\partial u_{j}} \\left( \\frac{\\partial U_{\\mathrm{bar}}}{\\partial u_{k}} \\right) = \\frac{\\partial}{\\partial u_{j}} \\left( \\frac{1}{b_{k} - u_{k}} - \\frac{1}{u_{k} - a_{k}} \\right)\n$$\n我们考虑下标 $j$ 和 $k$ 的两种情况。\n\n情况1：非对角元素 ($j \\neq k$)。\n$\\frac{\\partial U_{\\mathrm{bar}}}{\\partial u_{k}}$ 的表达式只依赖于变量 $u_k$。因此，它对任何其他变量 $u_j$（其中 $j \\neq k$）的偏导数为零。\n$$\n\\left[ \\nabla^{2} U_{\\mathrm{bar}}(u) \\right]_{jk} = 0 \\quad \\text{for } j \\neq k\n$$\n这意味着海森矩阵是一个对角矩阵。\n\n情况2：对角元素 ($j = k$)。\n我们需要计算关于 $u_k$ 的二阶偏导数：\n$$\n\\left[ \\nabla^{2} U_{\\mathrm{bar}}(u) \\right]_{kk} = \\frac{\\partial^{2} U_{\\mathrm{bar}}}{\\partial u_{k}^{2}} = \\frac{\\partial}{\\partial u_{k}} \\left( \\frac{1}{b_{k} - u_{k}} - \\frac{1}{u_{k} - a_{k}} \\right)\n$$\n我们使用负指数重写这些项，以便结合链式法则应用幂法则 $(x^p)' = p x^{p-1}$。\n$$\n\\frac{\\partial^{2} U_{\\mathrm{bar}}}{\\partial u_{k}^{2}} = \\frac{\\partial}{\\partial u_{k}} \\left( (b_k - u_k)^{-1} - (u_k - a_k)^{-1} \\right)\n$$\n对第一项求导：\n$$\n\\frac{\\partial}{\\partial u_{k}} \\left( (b_{k} - u_{k})^{-1} \\right) = -1 \\cdot (b_{k} - u_{k})^{-2} \\cdot \\frac{\\partial}{\\partial u_k}(b_k - u_k) = -1 \\cdot (b_{k} - u_{k})^{-2} \\cdot (-1) = \\frac{1}{(b_{k} - u_{k})^{2}}\n$$\n对第二项求导：\n$$\n\\frac{\\partial}{\\partial u_{k}} \\left( -(u_{k} - a_{k})^{-1} \\right) = - \\left( -1 \\cdot (u_{k} - a_{k})^{-2} \\cdot \\frac{\\partial}{\\partial u_k}(u_k - a_k) \\right) = (u_{k} - a_{k})^{-2} \\cdot (1) = \\frac{1}{(u_{k} - a_{k})^{2}}\n$$\n结合这些结果，得到海森矩阵的对角元素：\n$$\n\\left[ \\nabla^{2} U_{\\mathrm{bar}}(u) \\right]_{kk} = \\frac{1}{(b_{k} - u_{k})^{2}} + \\frac{1}{(u_{k} - a_{k})^{2}}\n$$\n因此，海森矩阵是一个对角矩阵，其主对角线上的元素为这些项。\n\n**结果总结**\n\n$U_{\\mathrm{bar}}(u)$ 的梯度是一个向量，其分量是 $u$ 相应分量的函数：\n$$\n\\nabla U_{\\mathrm{bar}}(u) = \\begin{pmatrix}\n\\frac{1}{b_{1} - u_{1}} - \\frac{1}{u_{1} - a_{1}} \\\\\n\\vdots \\\\\n\\frac{1}{b_{n} - u_{n}} - \\frac{1}{u_{n} - a_{n}}\n\\end{pmatrix}\n$$\n$U_{\\mathrm{bar}}(u)$ 的海森矩阵是一个对角矩阵，可以使用 $\\mathrm{diag}(\\cdot)$ 算子表示：\n$$\n\\nabla^2 U_{\\mathrm{bar}}(u) = \\mathrm{diag}\\left( \\frac{1}{(b_{1} - u_{1})^{2}} + \\frac{1}{(u_{1} - a_{1})^{2}}, \\dots, \\frac{1}{(b_{n} - u_{n})^{2}} + \\frac{1}{(u_{n} - a_{n})^{2}} \\right)\n$$\n这些就是给定对数障碍势的梯度和海森矩阵的显式闭式表达式。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\nabla U_{\\mathrm{bar}}(u)  \\nabla^2 U_{\\mathrm{bar}}(u)\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n\\left( \\frac{1}{b_{k} - u_{k}} - \\frac{1}{u_{k} - a_{k}} \\right)_{k=1}^{n}\n\n\\mathrm{diag}\\left( \\frac{1}{(b_{k} - u_{k})^{2}} + \\frac{1}{(u_{k} - a_{k})^{2}} \\right)_{k=1}^{n}\n\\end{pmatrix}\n}\n$$", "id": "3388143"}, {"introduction": "将HMC应用于大数据问题时，计算完整梯度的成本可能高得令人望而却步，这是一个核心挑战。随机梯度哈密顿蒙特卡洛（SGHMC）是为应对此挑战而设计的强大变体，它使用小批量数据估算的随机梯度。本练习深入探讨SGHMC的理论核心，要求你推导出一个关键条件，即如何通过引入人工摩擦项来精确抵消随机梯度带来的噪声，从而满足涨落-耗散定理，并确保算法最终能从正确的目标后验分布中采样。[@problem_id:3388133]", "problem": "考虑一个逆问题，其中状态向量 $u \\in \\mathbb{R}^{d}$ 需要从数据 $y$ 中推断，其后验密度为 $\\pi(u \\mid y)$，势能为 $U(u) = -\\ln \\pi(u \\mid y)$（不考虑一个相加常数）。为了有效地对该后验进行采样以用于数据同化，引入了辅助动量 $p \\in \\mathbb{R}^{d}$，并以哈密顿量 $H(u,p) = U(u) + \\frac{1}{2} p^{\\top} M^{-1} p$ 为目标的联合密度进行采样，其中 $M \\in \\mathbb{R}^{d \\times d}$ 是一个对称正定质量矩阵。随机梯度哈密顿蒙特卡洛（SGHMC）方法使用小批量随机梯度 $\\widehat{\\nabla U}(u)$，满足 $\\mathbb{E}[\\widehat{\\nabla U}(u)] = \\nabla U(u)$ 和零均值梯度噪声。假设每次迭代的梯度噪声模型为 $\\eta_{k} = \\widehat{\\nabla U}(u_{k}) - \\nabla U(u_{k})$，且 $\\mathbb{E}[\\eta_{k}] = 0$ 以及 $\\mathrm{Cov}(\\eta_{k}) = B$，其中 $B$ 是一个不依赖于 $k$ 的对称半正定矩阵。\n\n设 SGHMC 的更新由下式给出\n$$\np_{k+1} = (1 - \\alpha) p_{k} - \\epsilon \\,\\widehat{\\nabla U}(u_{k}) + \\xi_{k}, \\qquad\nu_{k+1} = u_{k} + \\epsilon M^{-1} p_{k+1},\n$$\n其中 $\\epsilon  0$ 是积分步长，$\\alpha \\geq 0$ 是无量纲摩擦系数，$\\xi_{k} \\sim \\mathcal{N}(0, \\Sigma)$ 是一个独立于 $\\eta_{k}$ 的零均值高斯扰动，其协方差矩阵 $\\Sigma = \\mathrm{Cov}(\\xi_{k})$ 待定。假设 $M \\succ 0$，并且摩擦-噪声耦合应强制实现正确的涨落-耗散平衡，以便在小步长极限下，离散化动力学的不变分布能够逼近与 $\\exp\\!\\big(-U(u) - \\frac{1}{2} p^{\\top} M^{-1} p\\big)$ 成正比的目标联合密度。\n\n仅从目标联合密度的定义和针对涨落-耗散的欠阻尼朗之万原理出发，推导动量更新中总附加噪声必须满足的必要条件，以使平稳分布在 $\\epsilon$ 的主导阶上得以保持。然后，计算 $\\mathrm{Cov}(\\xi_{k})$ 的显式闭式解，该解用于补偿离散时间更新中的小批量梯度噪声 $\\eta_{k}$。\n\n你的最终答案必须是 $\\mathrm{Cov}(\\xi_{k})$ 关于 $\\alpha$、$\\epsilon$、 $M$ 和 $B$ 的单个闭式解析表达式。不需要进行数值计算。如果需要任何正半定性的条件，请在推导中说明，但最终答案必须仅为 $\\mathrm{Cov}(\\xi_{k})$ 的表达式。", "solution": "这个问题是有效的，因为它是计算统计学和数据同化领域内一个适定且有科学依据的问题，具体涉及随机梯度哈密顿蒙特卡洛（SGHMC）算法。所有术语都定义清晰，前提与随机微分方程和马尔可夫链蒙特卡洛方法的既定理论一致。\n\n目标是确定 SGHMC 更新规则中注入噪声 $\\xi_k$ 的协方差矩阵 $\\mathrm{Cov}(\\xi_k)$。正确选择 $\\mathrm{Cov}(\\xi_k)$ 可以确保生成的马尔可夫链的平稳分布逼近目标后验分布 $\\pi(u \\mid y) \\propto \\exp(-U(u))$，或更精确地说，逼近联合密度 $\\pi(u, p) \\propto \\exp(-H(u,p))$，其中 $H(u,p) = U(u) + \\frac{1}{2} p^{\\top} M^{-1} p$。这是通过满足离散时间版本的涨落-耗散定理来实现的。\n\nSGHMC 算法是连续时间欠阻尼朗之万方程的数值离散化：\n$$\n\\begin{cases}\ndu = M^{-1} p \\, dt \\\\\ndp = -\\nabla U(u) \\, dt - C p \\, dt + d\\mathcal{W}_t\n\\end{cases}\n$$\n此处，$C$ 是一个摩擦矩阵，$d\\mathcal{W}_t$ 代表一个连续时间随机过程。要使该随机微分方程（SDEs）系统的平稳分布为 $\\pi(u, p) \\propto \\exp(-H(u,p))$，必须满足涨落-耗散定理。该定理规定了摩擦项 $-C p \\, dt$ 和噪声项 $d\\mathcal{W}_t$ 之间的特定关系。具体来说，噪声必须是一个零均值高斯过程，其协方差为 $\\mathrm{Cov}(d\\mathcal{W}_t) = 2 C M \\, dt$。这意味着动量 $p$ 的 SDE 为：\n$$\ndp = -\\nabla U(u) \\, dt - C p \\, dt + \\sqrt{2 C M} \\, dW_t\n$$\n其中 $W_t$ 是一个标准的 $d$ 维维纳过程。\n\n问题给出了动量 $p$ 的离散时间 SGHMC 更新：\n$$\np_{k+1} = (1 - \\alpha) p_{k} - \\epsilon \\,\\widehat{\\nabla U}(u_{k}) + \\xi_{k}\n$$\n我们可以重写此更新，以表示一步内动量的变化 $\\Delta p_k = p_{k+1} - p_k$：\n$$\n\\Delta p_k = -\\alpha p_k - \\epsilon \\,\\widehat{\\nabla U}(u_{k}) + \\xi_{k}\n$$\n我们将积分步长确定为 $\\epsilon$。除以 $\\epsilon$ 可以与连续时间 SDE 进行直接比较：\n$$\n\\frac{\\Delta p_k}{\\epsilon} = -\\frac{\\alpha}{\\epsilon} p_k - \\widehat{\\nabla U}(u_{k}) + \\frac{1}{\\epsilon}\\xi_{k}\n$$\n这个离散更新逼近了连续 SDE。通过比较摩擦项，我们确定连续极限下的有效摩擦矩阵为 $C = \\frac{\\alpha}{\\epsilon} I$，其中 $I$ 是 $d \\times d$ 的单位矩阵。更新规则中的标量摩擦系数 $\\alpha \\ge 0$ 对应于一个各向同性的摩擦矩阵。\n\n根据涨落-耗散定理，在时间间隔 $\\epsilon$ 内引入的总噪声必须具有一个能够抵消摩擦引起的耗散的协方差。在一步中添加的总噪声所需的协方差为 $2 \\epsilon C M$。代入我们确定的有效摩擦 $C$：\n$$\n\\text{所需噪声协方差} = 2 \\epsilon \\left(\\frac{\\alpha}{\\epsilon} I\\right) M = 2\\alpha M\n$$\n这是为了使平稳分布在 $\\epsilon$ 的主导阶上得以保持，对动量更新中总附加噪声所必须满足的条件。\n\n接下来，我们计算 SGHMC 动量更新中实际存在的总噪声的协方差。该更新由两个随机源驱动：来自随机梯度的噪声 $\\eta_k$ 和显式注入的噪声 $\\xi_k$。首先，我们将随机梯度的定义 $\\widehat{\\nabla U}(u_{k}) = \\nabla U(u_k) + \\eta_k$ 代入 $\\Delta p_k$ 的更新方程：\n$$\n\\Delta p_k = -\\alpha p_k - \\epsilon (\\nabla U(u_k) + \\eta_k) + \\xi_k\n$$\n重新排列各项，将确定性部分和随机性部分分组：\n$$\n\\Delta p_k = (-\\alpha p_k - \\epsilon \\nabla U(u_k)) + (\\xi_k - \\epsilon \\eta_k)\n$$\n单步中的总附加随机扰动，我们称之为 $N_k$，是：\n$$\nN_k = \\xi_k - \\epsilon \\eta_k\n$$\n问题陈述了 $\\mathbb{E}[\\eta_k] = 0$ 和 $\\mathbb{E}[\\xi_k] = 0$，因此总噪声 $N_k$ 也是零均值的：$\\mathbb{E}[N_k] = \\mathbb{E}[\\xi_k] - \\epsilon \\mathbb{E}[\\eta_k] = 0$。\n问题还陈述了 $\\eta_k$ 和 $\\xi_k$ 是独立的。因此，总噪声的协方差是它们各自协方差的和：\n$$\n\\mathrm{Cov}(N_k) = \\mathrm{Cov}(\\xi_k - \\epsilon \\eta_k) = \\mathrm{Cov}(\\xi_k) + \\mathrm{Cov}(-\\epsilon \\eta_k)\n$$\n$$\n\\mathrm{Cov}(N_k) = \\mathrm{Cov}(\\xi_k) + (-\\epsilon)^2 \\mathrm{Cov}(\\eta_k) = \\mathrm{Cov}(\\xi_k) + \\epsilon^2 \\mathrm{Cov}(\\eta_k)\n$$\n使用给定的定义 $\\mathrm{Cov}(\\xi_k) = \\Sigma$ 和 $\\mathrm{Cov}(\\eta_k)=B$，我们有：\n$$\n\\mathrm{Cov}(N_k) = \\Sigma + \\epsilon^2 B\n$$\n为了满足涨落-耗散定理，我们将实际噪声协方差与所需噪声协方差相等：\n$$\n\\Sigma + \\epsilon^2 B = 2\\alpha M\n$$\n求解 $\\Sigma = \\mathrm{Cov}(\\xi_k)$，得到注入噪声协方差的显式闭式表达式：\n$$\n\\mathrm{Cov}(\\xi_k) = 2\\alpha M - \\epsilon^2 B\n$$\n为使 $\\mathrm{Cov}(\\xi_k)$ 成为一个有效的协方差矩阵，它必须是对称且半正定的。由于 $M$ 和 $B$ 已知为对称矩阵，因此 $\\mathrm{Cov}(\\xi_k)$ 也是对称的。半正定性的条件是 $2\\alpha M - \\epsilon^2 B \\succeq 0$。这对算法超参数（$\\alpha$, $\\epsilon$）的选择施加了约束，该约束与质量矩阵（$M$）和梯度噪声（$B$）的性质有关。如果不满足此条件，则摩擦太小，无法抵消随机梯度带来的噪声，并且算法无法通过增加更多噪声来稳定，因为协方差矩阵不能是负定的。", "answer": "$$ \\boxed{2\\alpha M - \\epsilon^2 B} $$", "id": "3388133"}]}