{"hands_on_practices": [{"introduction": "Metropolis-Hastings 接受准则并非一个随意的公式，它经过精心设计，以确保马尔可夫链针对目标分布满足细致平衡条件。本练习通过分析一个对标准准则看似微小但至关重要的修改，挑战您深入探究这一原理 [@problem_id:2465253]。通过推导这个有缺陷的规则所导致的稳态分布，您将对为何细致平衡是 MCMC 正确采样的基石建立更深刻的直觉。", "problem": "一个经典分子系统的势能函数为 $E(\\mathbf{x})$，定义在一个体积有限的有界构型域 $\\Omega \\subset \\mathbb{R}^{3N}$ 上。您希望使用 Metropolis 蒙特卡洛方法，在温度 $T$ 下对正则（粒子数、体积、温度恒定）系综进行抽样，其中提议从满足 $q(\\mathbf{x} \\to \\mathbf{y}) = q(\\mathbf{y} \\to \\mathbf{x})$ 的对称提议核 $q(\\mathbf{x} \\to \\mathbf{y})$ 中抽取。令 $\\beta = 1/(k_{\\mathrm{B}} T)$，其中 $k_{\\mathrm{B}}$ 是玻尔兹曼常数。对于一个提议的移动 $\\mathbf{x} \\to \\mathbf{y}$，标准的 Metropolis 接受概率为 $a_{\\mathrm{std}}(\\mathbf{x} \\to \\mathbf{y}) = \\min\\{1, \\exp[-\\beta (E(\\mathbf{y}) - E(\\mathbf{x}))]\\}$。\n\n假设您错误地对所有提议的移动使用了修改后的接受概率 $a_{\\mathrm{abs}}(\\mathbf{x} \\to \\mathbf{y}) = \\min\\{1, \\exp[-\\beta |E(\\mathbf{y}) - E(\\mathbf{x})|]\\}$。\n\n在这些条件下，选择所有正确的陈述。\n\nA. 使用 $a_{\\mathrm{abs}}(\\mathbf{x} \\to \\mathbf{y})$ 时，相对于玻尔兹曼分布 $\\pi(\\mathbf{x}) \\propto \\exp[-\\beta E(\\mathbf{x})]$ 的细致平衡被违反，因此马尔可夫链不抽样正则系综。\n\nB. 使用 $a_{\\mathrm{abs}}(\\mathbf{x} \\to \\mathbf{y})$ 时，任何降低能量的提议，$E(\\mathbf{y}) \\le E(\\mathbf{x})$，都以概率 $1$ 被接受，与标准 Metropolis 规则完全相同。\n\nC. 对于有界域 $\\Omega$ 上的对称提议，规则 $a_{\\mathrm{abs}}(\\mathbf{x} \\to \\mathbf{y})$ 满足相对于 $\\Omega$ 上均匀分布的细致平衡。\n\nD. 在低温极限 $\\beta \\to \\infty$ 下，规则 $a_{\\mathrm{abs}}(\\mathbf{x} \\to \\mathbf{y})$ 只接受能量满足 $E(\\mathbf{y}) = E(\\mathbf{x})$ 的移动，这通常会破坏遍历性，除非存在具有非零测度的能量完全相等的连通构型集。\n\nE. 对于任何 $\\beta > 0$，由 $a_{\\mathrm{abs}}(\\mathbf{x} \\to \\mathbf{y})$ 导出的稳态分布与标准 Metropolis 规则 $a_{\\mathrm{std}}(\\mathbf{x} \\to \\mathbf{y})$ 的稳态分布重合。", "solution": "首先必须验证问题陈述的科学性和逻辑合理性。\n\n### 第1步：提取已知条件\n\n- 系统：一个经典分子系统。\n- 势能函数：$E(\\mathbf{x})$。\n- 构型域：$\\Omega \\subset \\mathbb{R}^{3N}$，有界且体积有限。\n- 系综：正则（$N$, $V$, $T$ 恒定）。\n- 温度：$T$。\n- 方法：Metropolis 蒙特卡洛。\n- 提议核：$q(\\mathbf{x} \\to \\mathbf{y})$，对称，即 $q(\\mathbf{x} \\to \\mathbf{y}) = q(\\mathbf{y} \\to \\mathbf{x})$。\n- 逆温度：$\\beta = 1/(k_{\\mathrm{B}} T)$。\n- 标准 Metropolis 接受概率：$a_{\\mathrm{std}}(\\mathbf{x} \\to \\mathbf{y}) = \\min\\{1, \\exp[-\\beta (E(\\mathbf{y}) - E(\\mathbf{x}))]\\}$。\n- 修改后的接受概率：$a_{\\mathrm{abs}}(\\mathbf{x} \\to \\mathbf{y}) = \\min\\{1, \\exp[-\\beta |E(\\mathbf{y}) - E(\\mathbf{x})|]\\}$。\n\n### 第2步：使用提取的已知条件进行验证\n\n- **科学基础：** 该问题设置在统计力学和计算化学的严谨框架内。它研究了由一个修改过的类 Metropolis 规则定义的马尔可夫链的性质。所有概念——正则系综、玻尔兹曼分布、细致平衡和接受准则——都是基本且明确定义的。\n- **适定性：** 该问题为一个非标准的接受规则提供了清晰的数学定义，并要求评估其性质。所提出的问题是精确的，并且可以使用马尔可夫链蒙特卡洛方法的既定理论来回答。\n- **客观性：** 该问题以正式、客观的语言陈述，没有歧义或主观内容。\n- **完整性：** 提供了所有必要的信息。提议核的性质（对称）和域的性质（有界）都已指明，这些对于分析至关重要。\n\n### 第3步：结论与行动\n\n问题陈述是内部一致、科学合理且适定的。它提出了一个计算统计力学中有效的理论问题。我们可以继续进行解答。\n\n建立马尔可夫链稳态分布 $\\pi(\\mathbf{x})$ 的核心原理是**细致平衡**条件。对于一个具有转移概率 $P(\\mathbf{x} \\to \\mathbf{y})$ 的马尔可夫链，如果满足以下条件，则细致平衡成立：\n$$ \\pi(\\mathbf{x}) P(\\mathbf{x} \\to \\mathbf{y}) = \\pi(\\mathbf{y}) P(\\mathbf{y} \\to \\mathbf{x}) $$\n对于 Metropolis 型算法，当 $\\mathbf{x} \\neq \\mathbf{y}$ 时，转移概率由提议概率 $q(\\mathbf{x} \\to \\mathbf{y})$ 和接受概率 $a(\\mathbf{x} \\to \\mathbf{y})$ 的乘积给出。对于对称提议核，$q(\\mathbf{x} \\to \\mathbf{y}) = q(\\mathbf{y} \\to \\mathbf{x})$，细致平衡条件简化为：\n$$ \\pi(\\mathbf{x}) a(\\mathbf{x} \\to \\mathbf{y}) = \\pi(\\mathbf{y}) a(\\mathbf{y} \\to \\mathbf{x}) $$\n这可以重写为 Metropolis-Hastings 比率条件：\n$$ \\frac{a(\\mathbf{x} \\to \\mathbf{y})}{a(\\mathbf{y} \\to \\mathbf{x})} = \\frac{\\pi(\\mathbf{y})}{\\pi(\\mathbf{x})} $$\n我们将使用这个条件来分析所提供的陈述。\n\n修改后的接受规则是 $a_{\\mathrm{abs}}(\\mathbf{x} \\to \\mathbf{y}) = \\min\\{1, \\exp[-\\beta |E(\\mathbf{y}) - E(\\mathbf{x})|]\\}$。\n由于绝对值 $|E(\\mathbf{y}) - E(\\mathbf{x})| = |E(\\mathbf{x}) - E(\\mathbf{y})|$，接受概率对于状态的交换是对称的：\n$$ a_{\\mathrm{abs}}(\\mathbf{x} \\to \\mathbf{y}) = a_{\\mathrm{abs}}(\\mathbf{y} \\to \\mathbf{x}) $$\n因此，接受概率的比率恒为1：\n$$ \\frac{a_{\\mathrm{abs}}(\\mathbf{x} \\to \\mathbf{y})}{a_{\\mathrm{abs}}(\\mathbf{y} \\to \\mathbf{x})} = 1 $$\n\n现在我们评估每个选项。\n\n**A. 使用 $a_{\\mathrm{abs}}(\\mathbf{x} \\to \\mathbf{y})$ 时，相对于玻尔兹曼分布 $\\pi(\\mathbf{x}) \\propto \\exp[-\\beta E(\\mathbf{x})]$ 的细致平衡被违反，因此马尔可夫链不抽样正则系综。**\n\n正则系综的目标分布是玻尔兹曼分布，$\\pi(\\mathbf{x}) = Z^{-1} \\exp[-\\beta E(\\mathbf{x})]$，其中 $Z$ 是配分函数。要使细致平衡对该分布成立，我们必须有：\n$$ \\frac{a_{\\mathrm{abs}}(\\mathbf{x} \\to \\mathbf{y})}{a_{\\mathrm{abs}}(\\mathbf{y} \\to \\mathbf{x})} = \\frac{\\pi(\\mathbf{y})}{\\pi(\\mathbf{x})} = \\frac{\\exp[-\\beta E(\\mathbf{y})]}{\\exp[-\\beta E(\\mathbf{x})]} = \\exp[-\\beta (E(\\mathbf{y}) - E(\\mathbf{x}))] $$\n如前所述，等式左边是 $1$。该条件变为：\n$$ 1 = \\exp[-\\beta (E(\\mathbf{y}) - E(\\mathbf{x}))] $$\n此等式仅在 $E(\\mathbf{y}) - E(\\mathbf{x}) = 0$ 时成立。对于任何在不同能量状态之间提议的移动，$E(\\mathbf{y}) \\neq E(\\mathbf{x})$，细致平衡条件被违反。由于一个分子系统通常具有连续的可及能级谱，这种违反是持续且根本的。一个不满足相对于玻尔兹曼分布的细致平衡的马尔可夫链，不会收敛到该分布作为其稳态分布。因此，它不会抽样正则系综。\n结论：**正确**。\n\n**B. 使用 $a_{\\mathrm{abs}}(\\mathbf{x} \\to \\mathbf{y})$ 时，任何降低能量的提议，$E(\\mathbf{y}) \\le E(\\mathbf{x})$，都以概率 $1$ 被接受，与标准 Metropolis 规则完全相同。**\n\n考虑一个能量降低的移动，$E(\\mathbf{y})  E(\\mathbf{x})$。\n对于标准规则，$E(\\mathbf{y}) - E(\\mathbf{x})  0$，这意味着 $-\\beta(E(\\mathbf{y}) - E(\\mathbf{x})) > 0$。那么 $\\exp[-\\beta(E(\\mathbf{y}) - E(\\mathbf{x}))] > 1$，且 $a_{\\mathrm{std}}(\\mathbf{x} \\to \\mathbf{y}) = \\min\\{1, \\text{大于1的值}\\} = 1$。该陈述对于标准规则是正确的。\n现在，对于修改后的规则 $a_{\\mathrm{abs}}$：\n如果 $E(\\mathbf{y})  E(\\mathbf{x})$，则 $|E(\\mathbf{y}) - E(\\mathbf{x})| = E(\\mathbf{x}) - E(\\mathbf{y}) > 0$。接受概率为：\n$$ a_{\\mathrm{abs}}(\\mathbf{x} \\to \\mathbf{y}) = \\min\\{1, \\exp[-\\beta (E(\\mathbf{x}) - E(\\mathbf{y}))]\\} $$\n由于 $\\beta > 0$ 且 $E(\\mathbf{x}) - E(\\mathbf{y}) > 0$，指数为负。因此，$\\exp[-\\beta (E(\\mathbf{x}) - E(\\mathbf{y}))]  1$。\n接受概率是 $a_{\\mathrm{abs}}(\\mathbf{x} \\to \\mathbf{y}) = \\exp[-\\beta (E(\\mathbf{x}) - E(\\mathbf{y}))]$，它严格小于 $1$。实际上，这个规则对降低能量的移动的惩罚方式，与它对增加相同能量的移动的惩罚方式相同。该陈述是错误的。\n结论：**不正确**。\n\n**C. 对于有界域 $\\Omega$ 上的对称提议，规则 $a_{\\mathrm{abs}}(\\mathbf{x} \\to \\mathbf{y})$ 满足相对于 $\\Omega$ 上均匀分布的细致平衡。**\n\n令均匀分布为 $\\pi_U(\\mathbf{x}) = C$ 对所有 $\\mathbf{x} \\in \\Omega$ 成立，其中 $C$ 是一个归一化常数（$\\Omega$ 体积的倒数）。概率的比值为：\n$$ \\frac{\\pi_U(\\mathbf{y})}{\\pi_U(\\mathbf{x})} = \\frac{C}{C} = 1 $$\n细致平衡条件要求：\n$$ \\frac{a_{\\mathrm{abs}}(\\mathbf{x} \\to \\mathbf{y})}{a_{\\mathrm{abs}}(\\mathbf{y} \\to \\mathbf{x})} = 1 $$\n如前所示，$a_{\\mathrm{abs}}(\\mathbf{x} \\to \\mathbf{y}) = a_{\\mathrm{abs}}(\\mathbf{y} \\to \\mathbf{x})$，所以这个条件总是满足的。因此，修改后的接受规则满足相对于均匀分布的细致平衡。假设马尔可夫链是遍历的（对于连通域上的标准提议核，这通常是成立的），其稳态分布就是 $\\Omega$ 上的均匀分布。\n结论：**正确**。\n\n**D. 在低温极限 $\\beta \\to \\infty$ 下，规则 $a_{\\mathrm{abs}}(\\mathbf{x} \\to \\mathbf{y})$ 只接受能量满足 $E(\\mathbf{y}) = E(\\mathbf{x})$ 的移动，这通常会破坏遍历性，除非存在具有非零测度的能量完全相等的连通构型集。**\n\n我们分析当 $\\beta \\to \\infty$ 时 $a_{\\mathrm{abs}}(\\mathbf{x} \\to \\mathbf{y}) = \\min\\{1, \\exp[-\\beta |E(\\mathbf{y}) - E(\\mathbf{x})|]\\}$ 的行为。\n- 如果 $E(\\mathbf{y}) = E(\\mathbf{x})$，那么 $|E(\\mathbf{y}) - E(\\mathbf{x})| = 0$，所以 $a_{\\mathrm{abs}} = \\min\\{1, \\exp[0]\\} = 1$。在等能面上的移动总是被接受。\n- 如果 $E(\\mathbf{y}) \\neq E(\\mathbf{x})$，那么 $|E(\\mathbf{y}) - E(\\mathbf{x})| = \\Delta E > 0$。当 $\\beta \\to \\infty$ 时，指数 $-\\beta \\Delta E \\to -\\infty$，因此 $\\exp[-\\beta \\Delta E] \\to 0$。任何改变能量的移动的接受概率趋近于零。\n在极限情况下，该链只接受 $\\Delta E = 0$ 的移动。这意味着系统被困在其初始能量 $E(\\mathbf{x}_0)$ 定义的等能超曲面上。它无法访问具有不同能量的状态。因此，遍历性——即链最终可以访问状态空间 $\\Omega$ 的任何部分的性质——被破坏了。该链成为在特定能量壳层上的微正则系综的抽样器，而不是整个空间 $\\Omega$ 的抽样器。关于恒定能量的连通集的附带说明是一个形式上的技术细节：如果存在这样的集合，链可能在该集合*内部*是遍历的，但不是在整个 $\\Omega$ 上。\n结论：**正确**。\n\n**E. 对于任何 $\\beta > 0$，由 $a_{\\mathrm{abs}}(\\mathbf{x} \\to \\mathbf{y})$ 导出的稳态分布与标准 Metropolis 规则 $a_{\\mathrm{std}}(\\mathbf{x} \\to \\mathbf{y})$ 的稳态分布重合。**\n\n标准 Metropolis 规则 $a_{\\mathrm{std}}$ 的稳态分布是玻尔兹曼分布，$\\pi_{\\mathrm{std}}(\\mathbf{x}) \\propto \\exp[-\\beta E(\\mathbf{x})]$。\n如选项 C 的分析所确定，修改后规则 $a_{\\mathrm{abs}}$ 的稳态分布是均匀分布，$\\pi_{\\mathrm{abs}}(\\mathbf{x}) \\propto 1$。\n玻尔兹曼分布仅在势能 $E(\\mathbf{x})$ 在整个域 $\\Omega$ 上为常数的平凡情况下才等于均匀分布。对于任何非平凡的分子系统，$E(\\mathbf{x})$ 不是恒定的。因此，对于任何有限的 $\\beta > 0$，这两个分布是不同的。\n结论：**不正确**。", "answer": "$$\\boxed{ACD}$$", "id": "2465253"}, {"introduction": "在巩固了理论基础之后，我们现在转向数据同化中一个常见的实践难题：从多模态后验分布中采样。本练习使用一个简化的单维高斯混合模型作为“实验室”，以探索采样器在单个模式中被长期“困住”的亚稳态现象 [@problem_id:3362440]。您将分析局部提议机制与接受准则的相互作用如何使得模式间的跳转变得极其罕见，从而对复杂能量景观中的采样效率低下问题获得定量的理解。", "problem": "考虑一个源于数据同化的一维逆问题，其中一个标量参数 $x$ 需要在两种相互竞争的物理机制下从观测中推断出来。参数 $x$ 的后验密度被建模为一个高斯混合模型，\n$$\n\\pi(x) \\propto w_{1}\\,\\frac{1}{\\sqrt{2\\pi}\\,\\sigma_{1}}\\exp\\!\\left(-\\frac{(x-\\mu_{1})^{2}}{2\\sigma_{1}^{2}}\\right) + w_{2}\\,\\frac{1}{\\sqrt{2\\pi}\\,\\sigma_{2}}\\exp\\!\\left(-\\frac{(x-\\mu_{2})^{2}}{2\\sigma_{2}^{2}}\\right),\n$$\n其中 $w_{1},w_{2}\\in(0,1)$ 且 $w_{1}+w_{2}=1$，均值 $\\mu_{1},\\mu_{2}\\in\\mathbb{R}$ 是良好分离的，即 $\\Delta\\equiv|\\mu_{2}-\\mu_{1}|\\gg \\max\\{\\sigma_{1},\\sigma_{2}\\}$，而 $\\sigma_{1},\\sigma_{2}0$ 是各分量的标准差。假设使用一个Metropolis–Hastings (MH) 马尔可夫链蒙特卡洛 (MCMC) 算法，其提议密度为对称高斯随机游走 $q(y\\,|\\,x)=\\frac{1}{\\sqrt{2\\pi}\\,s}\\exp\\!\\big(-\\frac{(y-x)^{2}}{2s^{2}}\\big)$，其中步长 $s0$ 是固定的且满足 $s\\ll \\Delta$。因此，该提议在 $q(y\\,|\\,x)=q(x\\,|\\,y)$ 的意义上是对称的。\n\n从马尔可夫链的细致平衡条件出发，并且只使用后验的贝叶斯法则和Metropolis–Hastings转移核的定义等基本原理，推导对此对称提议强制满足细致平衡的接受准则。然后，通过对试图在模式之间跳跃的提议进行形式化的条件化，来刻画由多模态性和固定步长引起的亚稳态：定义事件 $A_{\\varepsilon}$ 为从当前状态 $x$（满足 $|x-\\mu_{1}|\\le \\varepsilon$）到提议状态 $y$（满足 $|y-\\mu_{2}|\\le \\varepsilon$）的提议，其中 $\\varepsilon0$ 是一个小的邻域半径，满足 $\\varepsilon\\ll \\min\\{\\sigma_{1},\\sigma_{2}\\}$ 和 $\\varepsilon\\ll \\Delta$。在极限 $\\varepsilon\\to 0$ 下，计算对于给定的具有固定步长 $s$ 的MH算法，以 $A_{\\varepsilon}$ 为条件下的期望接受概率。\n\n你的最终答案必须是仅含 $w_{1}$、$w_{2}$、$\\sigma_{1}$ 和 $\\sigma_{2}$ 的单个闭式解析表达式。无需进行数值近似。此外，请从第一性原理出发，简要解释在此设置中多模态性和亚稳态是如何通过接受率和提议机制引入的。最终答案必须精确地以解析表达式的形式给出；不要包含任何单位。", "solution": "后验密度被指定为一个高斯混合模型。根据贝叶斯法则，对于数据同化，我们有 $\\pi(x)\\propto p(y_{\\text{obs}}\\,|\\,x)\\,p(x)$，在这里，该后验由该混合模型明确表示。Metropolis–Hastings (MH) 算法定义了一条马尔可夫链，其提议密度为 $q(y\\,|\\,x)$，接受概率为 $\\alpha(x,y)$，从而得到从 $x$ 到 $y$ 的转移概率为 $P(x\\to y)=q(y\\,|\\,x)\\,\\alpha(x,y)$ (对于 $y\\neq x$) 以及 $P(x\\to x)=1-\\int q(z\\,|\\,x)\\,\\alpha(x,z)\\,\\mathrm{d}z$。要求该链以 $\\pi$ 为其不变分布，并且关于 $\\pi$ 是可逆的，即为细致平衡条件：\n$$\n\\pi(x)\\,P(x\\to y)=\\pi(y)\\,P(y\\to x),\\quad \\text{对所有 }x,y.\n$$\n对于 $x\\neq y$，代入 $P$ 得到\n$$\n\\pi(x)\\,q(y\\,|\\,x)\\,\\alpha(x,y) = \\pi(y)\\,q(x\\,|\\,y)\\,\\alpha(y,x).\n$$\n标准的MH构造选择\n$$\n\\alpha(x,y)=\\min\\!\\left(1,\\frac{\\pi(y)\\,q(x\\,|\\,y)}{\\pi(x)\\,q(y\\,|\\,x)}\\right),\n$$\n这满足了细致平衡条件，并在该约束下最大化了接受率。因为提议是对称的，即 $q(y\\,|\\,x)=q(x\\,|\\,y)$，所以上式简化为\n$$\n\\alpha(x,y)=\\min\\!\\left(1,\\frac{\\pi(y)}{\\pi(x)}\\right).\n$$\n\n我们被要求计算在试图在两个模式之间跳跃的提议的条件下，期望的接受概率。形式上，定义 $A_{\\varepsilon}$ 为\n$$\nA_{\\varepsilon}=\\left\\{|x-\\mu_{1}|\\le \\varepsilon,\\;|y-\\mu_{2}|\\le \\varepsilon\\right\\},\\quad \\varepsilon\\ll \\min\\{\\sigma_{1},\\sigma_{2}\\},\\;\\varepsilon\\ll \\Delta.\n$$\n在模式良好分离的条件 $\\Delta\\gg \\max\\{\\sigma_{1},\\sigma_{2}\\}$ 和半径为 $\\varepsilon$ 的小邻域下，另一个高斯分量对每个模式附近后验的贡献是可以忽略的。因此，对于满足 $|x-\\mu_{1}|\\le \\varepsilon$ 的 $x$，\n$$\n\\pi(x)\\approx C\\, w_{1}\\,\\frac{1}{\\sqrt{2\\pi}\\,\\sigma_{1}}\\exp\\!\\left(-\\frac{(x-\\mu_{1})^{2}}{2\\sigma_{1}^{2}}\\right),\n$$\n以及对于满足 $|y-\\mu_{2}|\\le \\varepsilon$ 的 $y$，\n$$\n\\pi(y)\\approx C\\, w_{2}\\,\\frac{1}{\\sqrt{2\\pi}\\,\\sigma_{2}}\\exp\\!\\left(-\\frac{(y-\\mu_{2})^{2}}{2\\sigma_{2}^{2}}\\right),\n$$\n其中 $C0$ 是后验的（未知的）归一化常数，它在比值中被消去。在极限 $\\varepsilon\\to 0$ 下，我们有 $x\\to \\mu_{1}$ 和 $y\\to \\mu_{2}$，因此指数因子趋向于 $\\exp(0)=1$，我们得到\n$$\n\\frac{\\pi(y)}{\\pi(x)} \\xrightarrow[\\varepsilon\\to 0]{} \\frac{w_{2}\\,\\frac{1}{\\sqrt{2\\pi}\\,\\sigma_{2}}}{w_{1}\\,\\frac{1}{\\sqrt{2\\pi}\\,\\sigma_{1}}}=\\frac{w_{2}\\,\\sigma_{1}}{w_{1}\\,\\sigma_{2}}.\n$$\n因此，对于对称提议，\n$$\n\\alpha(x,y)\\xrightarrow[\\varepsilon\\to 0]{}\\min\\!\\left(1,\\frac{w_{2}\\,\\sigma_{1}}{w_{1}\\,\\sigma_{2}}\\right).\n$$\n因为当 $\\varepsilon\\to 0$ 时，这个极限值在 $A_{\\varepsilon}$ 上是常数，所以给定 $A_{\\varepsilon}$ 的接受概率的条件期望等于这个常数：\n$$\n\\lim_{\\varepsilon\\to 0}\\,\\mathbb{E}\\!\\left[\\alpha(X,Y)\\,\\big|\\,A_{\\varepsilon}\\right] = \\min\\!\\left(1,\\frac{w_{2}\\,\\sigma_{1}}{w_{1}\\,\\sigma_{2}}\\right).\n$$\n\n最后，我们从第一性原理出发，解释多模态性和亚稳态与接受率和固定步长之间的相互作用。多模态性的出现是因为 $\\pi$ 在 $\\mu_{1}$ 和 $\\mu_{2}$ 处有两个良好分离的峰。马尔可夫链中的亚稳态是提议机制具有固定步长 $s$ 的结果，该步长相对于分离距离 $\\Delta$ 很小。在高斯随机游走下，从 $\\mu_{1}$ 的邻域提议跳跃到 $\\mu_{2}$ 的邻域的概率，在 $\\Delta^{2}/s^{2}$ 上是指数级小的；更精确地说，如果 $X\\approx \\mu_{1}$，那么 $Y\\sim \\mathcal{N}(X,s^{2})$ 必须实现一个罕见的尾部事件 $|Y-\\mu_{2}|\\le \\varepsilon$，其概率在忽略多项式因子的情况下，与 $\\exp\\!\\big(-\\Delta^{2}/(2s^{2})\\big)$ 成比例。因此，即使这类跨模式提议的接受率（当它们发生时）很高，如上式所示，成功的模式间转换的总体速率也主要由提议跨模式移动的稀有性所主导。这导致了在单个模式内的长停留时间（亚稳态）、慢混合，以及模式间转换时间对比例 $\\Delta/s$ 的强依赖性。接受准则本身由细致平衡条件决定，并取决于两个模式附近的局部后验质量比，这里由高斯分量的权重和尺度捕捉；而提议机制决定了这类有利的提议实际被尝试的频率。", "answer": "$$\\boxed{\\min\\!\\left(1,\\frac{w_{2}\\,\\sigma_{1}}{w_{1}\\,\\sigma_{2}}\\right)}$$", "id": "3362440"}, {"introduction": "我们的最后一个实践练习处理逆问题中的另一个常见需求：对参数施加硬约束。标准的随机游走提议不适用于有边界的区域，这需要更复杂的提议策略。这个高级问题将指导您设计在边界处运作的“反射”和“折射”提议 [@problem_id:3362451]。其核心挑战在于，通过首先计算非对称的提议密度来推导相应的 Hastings 比率，这再次强调了对于任何有效的 MCMC 采样器，满足细致平衡条件的普遍重要性。", "problem": "考虑以下带有硬可行性约束的约束贝叶斯逆问题。一个标量参数 $\\theta \\in \\mathbb{R}$ 具有高斯似然和高斯先验，但其后验支撑集被一个凸不等式约束所截断。数据模型为 $d \\mid \\theta \\sim \\mathcal{N}(\\theta,\\sigma_y^2)$，先验为 $\\theta \\sim \\mathcal{N}(0,\\sigma_0^2)$，并受到约束 $C(\\theta) \\le 0$ 的限制，其中 $C(\\theta) = -\\theta$，因此可行集为 $\\{\\theta \\in \\mathbb{R} : \\theta \\ge 0\\}$。因此，未归一化的截断后验为\n$$\n\\pi_T(\\theta) \\propto \\exp\\left(-\\tfrac{1}{2}\\bigg(\\frac{(d-\\theta)^2}{\\sigma_y^2} + \\frac{\\theta^2}{\\sigma_0^2}\\bigg)\\right)\\,\\mathbf{1}_{\\{\\theta \\ge 0\\}},\n$$\n其中 $\\mathbf{1}_{\\{\\cdot\\}}$ 是指示函数。\n\n我们寻求一个 Metropolis-Hastings (MH) 转移核，它相对于 $\\pi_T(\\theta)$ 保持细致平衡，同时使用在边界附近修改以强制执行约束的高斯随机游走来提议移动。\n\n从当前的可行状态 $x \\ge 0$ 开始，抽取一个无约束的高斯增量 $\\varepsilon \\sim \\mathcal{N}(0,\\tau^2)$，并设置无约束的提议 $u = x + \\varepsilon$。定义两种不同的边界处理映射，以从 $u$ 生成一个可行的提议状态 $y \\ge 0$：\n\n1. 反射：$y = |u|$。\n\n2. 折射，压缩因子为 $\\rho \\in (0,1]$：\n   $$\n   y = \n   \\begin{cases}\n   u,  \\text{if } u \\ge 0,\\\\\n   -\\rho\\,u,  \\text{if } u  0.\n   \\end{cases}\n   $$\n\n令 $\\varphi_\\tau(z) = \\dfrac{1}{\\sqrt{2\\pi}\\tau}\\exp\\!\\left(-\\dfrac{z^2}{2\\tau^2}\\right)$ 表示标准差为 $\\tau$ 的高斯密度。所得到的提议密度 $q(x \\to y)$ 是 $\\varepsilon$ 通过从 $u$ 到 $y$ 的映射的前推，并且由于在边界处的折叠，可能具有多个原像。从第一性原理出发，不借助任何预先推导的接受准则，通过为每种边界处理映射显式计算 $q(x \\to y)$，推导正确的 Metropolis-Hastings 接受概率\n$$\n\\alpha(x \\to y) = \\min\\!\\left(1,\\; \\frac{\\pi_T(y)\\,q(y \\to x)}{\\pi_T(x)\\,q(x \\to y)}\\right),\n$$\n您的推导必须从基本的细致平衡条件开始，对于目标密度 $\\pi_T$ 和马尔可夫转移核 $K$，该条件要求\n$$\n\\pi_T(x)\\,K(x,dy) = \\pi_T(y)\\,K(y,dx),\n$$\n对于带有提议核 $q$ 和接受率 $\\alpha$ 的 Metropolis-Hastings 算法，该条件简化为\n$$\n\\pi_T(x)\\,q(x \\to y)\\,\\alpha(x \\to y) = \\pi_T(y)\\,q(y \\to x)\\,\\alpha(y \\to x).\n$$\n由此，得到 $\\alpha(x \\to y)$ 的表达式。\n\n将您的提议密度 $q(x \\to y)$ 的表达式特化到边界为 $0$ 的标量半线情况，如下所示：\n\n- 对于反射，证明\n$$\nq_{\\mathrm{refl}}(x \\to y) = \\varphi_\\tau(y-x) + \\varphi_\\tau(y+x), \\quad \\text{for } x \\ge 0,\\, y \\ge 0.\n$$\n\n- 对于压缩因子为 $\\rho \\in (0,1]$ 的折射，证明\n$$\nq_{\\mathrm{refr},\\rho}(x \\to y) = \\varphi_\\tau(y-x) + \\frac{1}{\\rho}\\,\\varphi_\\tau\\!\\Big(-\\frac{y}{\\rho} - x\\Big), \\quad \\text{for } x \\ge 0,\\, y \\ge 0.\n$$\n\n然后，实现一个程序，对于给定的参数，使用推导出的表达式计算接受概率 $\\alpha(x \\to y)$，并通过标量 $\\Delta(x,y)$ 对偶 $(x,y)$ 进行数值验证细致平衡。\n$$\n\\Delta(x,y) = \\frac{\\pi_T(x)\\,q(x \\to y)\\,\\alpha(x \\to y) - \\pi_T(y)\\,q(y \\to x)\\,\\alpha(y \\to x)}{\\max\\big(\\pi_T(x)\\,q(x \\to y)\\,\\alpha(x \\to y),\\; \\pi_T(y)\\,q(y \\to x)\\,\\alpha(y \\to x)\\big)},\n$$\n当细致平衡成立时，其绝对值应接近 $0$。\n\n使用以下固定的数据和超参数：$d = 1$，$\\sigma_y = 0.5$（因此 $\\sigma_y^2 = 0.25$），以及 $\\sigma_0 = 1$（因此 $\\sigma_0^2 = 1$）。为了数值稳定性，您可以使用对数和稳定求和来实现所有量的计算。\n\n您的程序必须评估以下包含五个案例的测试套件，每个案例指定为一个元组 $(\\text{method}, x, y, \\tau, \\rho)$，其中折射因子 $\\rho$ 对于反射方法被忽略：\n\n1. 反射内部移动：$(\\text{reflect},\\, 0.8,\\, 0.9,\\, 0.3,\\, 1.0)$。\n\n2. 反射跨越主导移动：$(\\text{reflect},\\, 0.2,\\, 0.7,\\, 0.5,\\, 1.0)$。\n\n3. 边界反射：$(\\text{reflect},\\, 0.0,\\, 0.1,\\, 0.4,\\, 1.0)$。\n\n4. 压缩因子 $\\rho = 0.5$ 的折射跨越：$(\\text{refract},\\, 0.2,\\, 0.9,\\, 0.6,\\, 0.5)$。\n\n5. 压缩因子 $\\rho = 0.5$ 的折射内部移动：$(\\text{refract},\\, 0.9,\\, 1.1,\\, 0.4,\\, 0.5)$。\n\n对于每个测试案例，计算并报告如上定义的浮点数对 $[\\alpha(x \\to y), \\Delta(x,y)]$。您的程序应生成单行输出，其中包含所有结果，这些结果被展平并放入一个由方括号括起来的逗号分隔列表中，顺序与测试套件一致，每个测试案例贡献两个连续的条目。也就是说，要求的输出格式为\n\"[a1,d1,a2,d2,a3,d3,a4,d4,a5,d5]\"\n不带任何附加文本。所有角度（如果存在）都将以弧度为单位进行测量，但此问题不包含角度。所有量纲均为无量纲。输出值必须是表示为标准十进制浮点数的实数。", "solution": "该问题被评估为有效，因为它科学地基于贝叶斯统计和马尔可夫链蒙特卡洛（MCMC）方法的原理，问题设定良好，目标明确，并为其解决提供了完整且一致的信息集。\n\n问题的核心是为两种旨在处理边界约束的不同提议机制推导 Metropolis-Hastings (MH) 接受概率 $\\alpha(x \\to y)$。这需要为每种机制推导提议转移密度 $q(x \\to y)$。\n\n目标分布是在 $\\theta \\ge 0$ 上的截断后验：\n$$\n\\pi_T(\\theta) \\propto \\exp\\left(-\\tfrac{1}{2}\\bigg(\\frac{(d-\\theta)^2}{\\sigma_y^2} + \\frac{\\theta^2}{\\sigma_0^2}\\bigg)\\right)\\,\\mathbf{1}_{\\{\\theta \\ge 0\\}}\n$$\n为方便起见，我们定义势能函数 $U(\\theta)$，使得对于 $\\theta \\ge 0$，有 $\\pi_T(\\theta) \\propto \\exp(-U(\\theta))$。\n$$\nU(\\theta) = \\frac{1}{2}\\left(\\frac{(d-\\theta)^2}{\\sigma_y^2} + \\frac{\\theta^2}{\\sigma_0^2}\\right)\n$$\n那么目标密度的比值为 $\\frac{\\pi_T(y)}{\\pi_T(x)} = \\exp(U(x) - U(y))$，其中 $x, y \\ge 0$。\n\n### 接受概率形式的推导\nMetropolis-Hastings 更新的细致平衡条件给出如下：\n$$\n\\pi_T(x)\\,q(x \\to y)\\,\\alpha(x \\to y) = \\pi_T(y)\\,q(y \\to x)\\,\\alpha(y \\to x)\n$$\n其中 $x$ 和 $y$是可行域中的状态，即 $x \\ge 0$ 和 $y \\ge 0$。我们寻求一个在 $[0, 1]$ 范围内的接受函数 $\\alpha$，使其满足此方程。我们定义 Metropolis 比率 $R$：\n$$\nR(x, y) = \\frac{\\pi_T(y)\\,q(y \\to x)}{\\pi_T(x)\\,q(x \\to y)}\n$$\n细致平衡方程可以重写为 $\\alpha(x \\to y) = R(x, y) \\cdot \\alpha(y \\to x)$。为了最大化接受率，从而提高采样器的效率，我们应该选择满足此关系且受限于它们是概率（即小于或等于 $1$）的 $\\alpha(x \\to y)$ 和 $\\alpha(y \\to x)$ 的最大可能值。\n\n如果 $R(x, y)  1$，我们可以设置 $\\alpha(y \\to x) = 1$（其最大可能值）。这个选择随后确定了 $\\alpha(x \\to y) = R(x, y)$。\n如果 $R(x, y) \\ge 1$，我们可以设置 $\\alpha(x \\to y) = 1$。这意味着 $\\alpha(y \\to x) = 1 / R(x, y)$。由于 $R(x, y) \\ge 1$，这个 $\\alpha(y \\to x)$ 的值也小于或等于 $1$。\n\n结合这两种情况，我们得到标准的 Metropolis-Hastings 接受概率：\n$$\n\\alpha(x \\to y) = \\min\\left(1, R(x,y)\\right) = \\min\\left(1, \\frac{\\pi_T(y)\\,q(y \\to x)}{\\pi_T(x)\\,q(x \\to y)}\\right)\n$$\n这个推导满足了从给定的细致平衡方程中获得 $\\alpha(x \\to y)$ 表达式的要求。\n\n### 提议密度 $q(x \\to y)$ 的推导\n下一步是找到提议密度 $q(x \\to y)$ 的表达式。提议的生成过程是：首先从概率密度函数（PDF）为 $\\varphi_\\tau(\\varepsilon)$ 的分布中抽取一个增量 $\\varepsilon \\sim \\mathcal{N}(0, \\tau^2)$，形成一个无约束的提议 $u = x + \\varepsilon$，然后将 $u$ 映射到一个可行状态 $y = M(u) \\ge 0$。给定 $x$ 时 $u$ 的密度为 $p(u|x) = \\varphi_\\tau(u-x)$。\n\n提议密度 $q(x \\to y)$ 是 $u$ 的密度在映射 $M$ 下的前推。对于给定的提议状态 $y > 0$，可能存在多个无约束值 $u_i$ 使得 $M(u_i) = y$。在 $y$ 处的密度是所有这些原像贡献的总和。根据概率密度的变量替换公式，每个原像 $u_i$ 的贡献是 $p(u_i|x) \\left| \\frac{du_i}{dy} \\right|$。因此，\n$$\nq(x \\to y) = \\sum_{i \\text{ s.t. } M(u_i)=y} p(u_i|x) \\left| \\frac{du_i}{dy} \\right| = \\sum_{i \\text{ s.t. } M(u_i)=y} \\varphi_\\tau(u_i - x) \\left| \\frac{du_i}{dy} \\right|\n$$\n该密度是相对于可行域 $[0, \\infty)$ 上的勒贝格测度而言的。\n\n#### 1. 反射映射：$y = |u|$\n对于给定的 $y>0$，在绝对值映射 $M(u)=|u|$ 下的原像是 $u_1 = y$ 和 $u_2 = -y$。\n\n- 对于 $u_1 = y$，所需的增量是 $\\varepsilon_1 = y-x$。雅可比项为 $|\\frac{du_1}{dy}| = |1| = 1$。对密度的贡献是 $\\varphi_\\tau(y-x)$。\n- 对于 $u_2 = -y$，所需的增量是 $\\varepsilon_2 = -y-x$。雅可比项为 $|\\frac{du_2}{dy}| = |-1| = 1$。对密度的贡献是 $\\varphi_\\tau(-y-x)$。因为高斯 PDF 是一个偶函数，$\\varphi_\\tau(-z) = \\varphi_\\tau(z)$，所以这等于 $\\varphi_\\tau(y+x)$。\n\n将这两个贡献相加，得到反射的提议密度，对 $x \\ge 0, y \\ge 0$ 有效：\n$$\nq_{\\mathrm{refl}}(x \\to y) = \\varphi_\\tau(y-x) + \\varphi_\\tau(y+x)\n$$\n这证实了问题陈述中提供的表达式。\n\n#### 2. 折射映射：当 $u \\ge 0$ 时 $y = u$，当 $u  0$ 时 $y = -\\rho u$\n对于给定的 $y>0$ 和压缩因子 $\\rho \\in (0,1]$，我们找到折射映射下的原像。\n\n- 如果无约束提议 $u$ 是非负的（$u \\ge 0$），则 $y=u$。原像是 $u_1 = y$。由于我们考虑 $y>0$，所以 $u_1>0$，这与条件 $u \\ge 0$ 一致。雅可比项为 $|\\frac{du_1}{dy}| = 1$。密度贡献为 $\\varphi_\\tau(y-x)$。\n- 如果无约束提议 $u$ 是负的（$u  0$），则 $y = -\\rho u$。原像是 $u_2 = -y/\\rho$。由于 $y>0$ 且 $\\rho>0$，所以 $u_20$，这与条件 $u0$ 一致。雅可比项为 $|\\frac{du_2}{dy}| = |-1/\\rho| = 1/\\rho$。密度贡献为 $\\varphi_\\tau(-y/\\rho - x) \\cdot \\frac{1}{\\rho}$。\n\n将这两个贡献相加，得到折射的提議密度，对 $x \\ge 0, y \\ge 0$ 有效：\n$$\nq_{\\mathrm{refr},\\rho}(x \\to y) = \\varphi_\\tau(y-x) + \\frac{1}{\\rho}\\,\\varphi_\\tau\\!\\Big(-\\frac{y}{\\rho} - x\\Big)\n$$\n这也证实了问题陈述中提供的表达式。\n\n### 数值实现\n计算在对数域中进行，以增强数值稳定性。接受概率 $\\alpha(x \\to y)$ 通过以下方式计算：\n$$\n\\log R(x,y) = (U(x) - U(y)) + (\\log q(y \\to x) - \\log q(x \\to y))\n$$\n$$\n\\alpha(x \\to y) = \\min(1, \\exp(\\log R(x,y)))\n$$\n项 $\\log q(x \\to y)$ 使用稳定的 `log-sum-exp` 操作计算，即 $\\log(A+B) = \\log(\\exp(\\log A) + \\exp(\\log B))$。\n\n细致平衡检验量 $\\Delta(x,y)$ 定义为：\n$$\n\\Delta(x,y) = \\frac{T_1 - T_2}{\\max(T_1, T_2)}, \\quad \\text{where } T_1 = \\pi_T(x)\\,q(x \\to y)\\,\\alpha(x \\to y) \\text{ and } T_2 = \\pi_T(y)\\,q(y \\to x)\\,\\alpha(y \\to x)\n$$\n根据构造，$T_1$ 和 $T_2$ 应该是相同的。任何偏差都源于浮点算术误差。为了稳定地计算 $\\Delta(x,y)$，我们计算它们的对数 $\\log T_1$ 和 $\\log T_2$。令 $\\text{diff} = \\log T_1 - \\log T_2$。那么，如果 $T_2 > T_1$ (即 diff  0)，$\\Delta(x,y)$ 可以计算为 $\\exp(\\text{diff})-1$；如果 $T_1 > T_2$ (即 diff > 0)，则可以计算为 $1-\\exp(-\\text{diff})$。使用 `numpy.expm1` 函数可以提供一个稳健的实现，该函数能为小的 $z$ 精确计算 $\\exp(z)-1$。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes MH acceptance probabilities and detailed balance checks for a\n    constrained Bayesian inverse problem.\n    \"\"\"\n    # Fixed parameters\n    d = 1.0\n    sigma_y = 0.5\n    sigma_0 = 1.0\n    sigma_y2 = sigma_y**2\n    sigma_02 = sigma_0**2\n\n    # Test cases from the problem statement\n    test_cases = [\n        ('reflect', 0.8, 0.9, 0.3, 1.0),\n        ('reflect', 0.2, 0.7, 0.5, 1.0),\n        ('reflect', 0.0, 0.1, 0.4, 1.0),\n        ('refract', 0.2, 0.9, 0.6, 0.5),\n        ('refract', 0.9, 1.1, 0.4, 0.5),\n    ]\n\n    def log_potential(theta):\n        \"\"\"Computes the log-potential U(theta) for theta = 0.\"\"\"\n        if theta  0:\n            return np.inf\n        return 0.5 * (((d - theta)**2 / sigma_y2) + (theta**2 / sigma_02))\n\n    def log_phi_tau(z, tau):\n        \"\"\"Computes the log of the Gaussian PDF with std dev tau.\"\"\"\n        return -np.log(tau * np.sqrt(2 * np.pi)) - (z**2) / (2 * tau**2)\n\n    def log_q(method, x, y, tau, rho):\n        \"\"\"Computes the log of the proposal density q(x - y).\"\"\"\n        if method == 'reflect':\n            log_term1 = log_phi_tau(y - x, tau)\n            log_term2 = log_phi_tau(y + x, tau)\n            return np.logaddexp(log_term1, log_term2)\n        elif method == 'refract':\n            log_term1 = log_phi_tau(y - x, tau)\n            log_term2 = -np.log(rho) + log_phi_tau(-y / rho - x, tau)\n            return np.logaddexp(log_term1, log_term2)\n        else:\n            raise ValueError(\"Unknown method\")\n\n    results = []\n    for case in test_cases:\n        method, x, y, tau, rho = case\n\n        # Calculate acceptance probability alpha(x - y)\n        U_x = log_potential(x)\n        U_y = log_potential(y)\n        log_pi_ratio = U_x - U_y\n\n        log_q_forward = log_q(method, x, y, tau, rho)\n        log_q_reverse = log_q(method, y, x, tau, rho)\n        \n        log_R_forward = log_pi_ratio + log_q_reverse - log_q_forward\n        alpha_forward = min(1.0, np.exp(log_R_forward))\n        \n        results.append(alpha_forward)\n\n        # Calculate detailed balance check Delta(x, y)\n        log_alpha_forward = np.log(alpha_forward)\n        \n        # We also need alpha(y - x)\n        log_R_reverse = (U_y - U_x) + log_q_forward - log_q_reverse\n        alpha_reverse = min(1.0, np.exp(log_R_reverse))\n        log_alpha_reverse = np.log(alpha_reverse)\n\n        # Compute log transition probabilities T1 = pi(x)K(x,y) and T2 = pi(y)K(y,x)\n        log_T1 = -U_x + log_q_forward + log_alpha_forward\n        log_T2 = -U_y + log_q_reverse + log_alpha_reverse\n        \n        # Stably compute Delta = (T1-T2)/max(T1,T2)\n        diff = log_T1 - log_T2\n        if diff > 0:\n            # Delta = 1 - T2/T1 = 1 - exp(log_T2 - log_T1) = 1 - exp(-diff)\n            # -expm1(-x) is more numerically stable for small x than 1-exp(-x)\n            delta = -np.expm1(-diff)\n        else:\n            # Delta = T1/T2 - 1 = exp(log_T1 - log_T2) - 1 = exp(diff) - 1\n            delta = np.expm1(diff)\n            \n        results.append(delta)\n\n    # Format and print the final output\n    print(f\"[{','.join(f'{r:.15g}' for r in results)}]\")\n\nsolve()\n```", "id": "3362451"}]}