## 引言
[空间转录组学](@entry_id:270096)正在彻底改变我们对组织生物学的理解，它通过在完整的组织空间背景下测量基因表达，以前所未有的分辨率揭示了细胞的分子状态与其微环境之间的复杂联系。这一技术突破的核心价值在于将“什么基因在表达”与“它们在哪里表达”这两个基本问题联系起来。然而，这种蕴含丰富空间信息的数据也带来了独特的计算与统计挑战。简单的分析方法往往会忽略关键的空间结构，导致对生物学过程的错误解读。因此，如何开发并正确应用能够充分利用空间信息的分析方法，成为释放该技术全部潜力的关键瓶颈。

为了应对这一挑战，本文系统地构建了一套关于[空间转录组学](@entry_id:270096)数据分析的知识体系。读者将通过本文的学习，从底层原理出发，逐步掌握高级分析技术，并最终理解这些技术在真实科研问题中的应用。本文内容分为三个核心部分：在“原则与机制”章节中，我们将深入剖析空间[转录组](@entry_id:274025)数据的统计特性，介绍[数据预处理](@entry_id:197920)、空间模式量化和核心建模技术。接着，在“应用与跨学科连接”章节中，我们将展示这些方法如何在发育生物学、神经科学等多个领域中催生新的发现，并探讨其与[计算机视觉](@entry_id:138301)、生态学等学科的[交叉](@entry_id:147634)融合。最后，通过“动手实践”部分，读者将有机会将理论知识应用于解决具体的计算问题。

## 原则与机制

本章深入探讨了空间转录组学数据分析背后的核心原则与关键机制。我们将从空间转录组数据的基本构成出发，系统地介绍[数据预处理](@entry_id:197920)、空间模式的量化与建模，直至高级分析技术，如空间可变基因的识别、组织域的无监督发现、细胞成分的解构，以及多样本数据的整合。

### [空间转录组学](@entry_id:270096)数据的本质

空间转录组学的核心是**在组织切片的原始空间背景下测量核糖核酸（RNA）的丰度**。这意味着每一个测量值都包含两部分信息：基因表达量和其在组织中的空间坐标。不同的技术平台以截然不同的方式获取这两部分信息，从而产生了具有不同[特征和](@entry_id:189446)统计特性的数据。理解这些差异对于选择合适的分析策略至关重要。我们可以将主流技术大致分为两大类：基于捕获点的技术和基于原位成像的技术。[@problem_id:3350153]

**基于捕获点（Spot-based）的技术**，如 [10x Genomics Visium](@entry_id:181467)，其工作原理是在载玻片上预置一个[微阵列](@entry_id:270888)，每个阵列上的“捕获点”（spot）都包含了能捕获信使RNA（mRNA）的探针。组织切片被放置在该阵列上，经过透化处理后，mRNA分子会[扩散](@entry_id:141445)并被附近的捕获点捕获。每个捕获点上的探针都带有一个独特的[空间条形码](@entry_id:267996)，因此，通过后续的**高通量测序**，我们可以知道哪些转录本来自哪个捕获点。

这种方法具有以下关键特征：
- **空间分辨率**：分辨率由捕获点的大小和间距决定。例如，Visium的捕获点直径约为 $55\,\mu\mathrm{m}$，而典型细胞的直径约为 $10$–$20\,\mu\mathrm{m}$。这意味着每个捕获点通常会捕获来自多个细胞（以及细胞外基质）的mRNA。因此，其分辨率是**超细胞（supra-cellular）**级别而非单细胞或亚细胞级别。
- **分子计数**：计数是间接的。原始mRNA分子以一定概率被捕获，然后经过逆转录、[聚合酶链式反应](@entry_id:142924)（PCR）扩增和测序。最终得到的计数（通常使用**[唯一分子标识符](@entry_id:192673) UMI**进行校正）反映了捕获到的分子数量，但并非组织中原始分子数的绝对量度。这个过程受到捕获效率、[逆转录](@entry_id:141572)效率和PCR扩增偏好等多种因素的影响。
- **噪声来源**：主要的噪声来源包括：(1) **采样噪声**，源于mRNA分子被捕获的不完整性；(2) **聚合变异**，由于混合了多个不同类型和状态的细胞，单个捕获点的基因表达计数的[方差](@entry_id:200758)会显著高于简单泊松过程的预期，这种现象称为**过离散（overdispersion）**；(3) **生化与测序噪声**，如PCR扩增偏好和测序错误。

**基于原位成像（Imaging-based）的技术**，如多重抗错[荧光原位杂交](@entry_id:272648)（[MERFISH](@entry_id:191159)），则采用了完全不同的策略。它直接在完整固定的组织切片中对单个mRNA分子进行标记和成像。通过多轮杂交和成像，并结合组合条形码策略，可以在单个细胞内同时定位和计数成千上万个mRNA分子。

其关键特征如下：
- **空间分辨率**：分辨率由光学系统的衍射极限决定，通常在亚微米级别（例如 $200\,\mathrm{nm}$）。这个分辨率远高于细胞大小，因此能够实现**亚细胞（subcellular）**级别的定位，精确解析出mRNA分子在细胞质、细胞核或其他亚[细胞结构](@entry_id:147666)中的位置。
- **分子计数**：计数是直接的。通过识别和解码每个荧光信号点，该技术能近似实现对单个分子的绝对计数。其保真度主要受限于探针检测效率（可能导致假阴性）和条形码解码错误率（可能导致假阳性或基因误认）。
- **噪声来源**：噪声主要源于光学和解码过程。(1) **检测噪声**，包括漏检（binomial thinning）和因非特异性探针结合或解码错误导致的误检；(2) **光学伪影**，如在[高分子](@entry_id:150543)密度区域，不同分子的[点扩散函数](@entry_id:183154)（PSF）发生重叠（**光学拥挤 optical crowding**），导致计数偏低；(3) **解码错误**，在多轮杂交中读错荧光信号序列，导致基因身份的错误分配。与测序技术不同，其噪声来源与[测序深度](@entry_id:178191)无关。

### [数据表示](@entry_id:636977)与预处理

在对空间[转录组](@entry_id:274025)数据进行生物学分析之前，必须进行一系列关键的预处理步骤，以建立空间坐标与基因表达数据之间的精确对应关系，并对原始计数数据进行恰当的[统计建模](@entry_id:272466)。

#### [坐标系统](@entry_id:156346)与图像配准

[空间转录组学](@entry_id:270096)实验通常涉及两种主要的[坐标系统](@entry_id:156346)：芯片制造商提供的物理[坐标系](@entry_id:156346)和[组织学染色](@entry_id:273995)图像的像素[坐标系](@entry_id:156346)。[@problem_id:3350233]

- **物理[坐标系](@entry_id:156346)**：捕获点阵列的位置通常由一个以微米（$\mu\mathrm{m}$）为单位的物理[坐标系](@entry_id:156346) $(x,y)$ 定义。这个[坐标系](@entry_id:156346)的原点和方向通常与载玻片上的基准标记物（fiducials）相关联。

- **像素[坐标系](@entry_id:156346)**：[组织学](@entry_id:147494)图像的像素[坐标系](@entry_id:156346)以 $(u,v)$ 表示，以像素为单位，原点通常在图像的左上角。图像扫描仪会提供一个分辨率参数 $\rho$（例如，$0.5\,\mu\mathrm{m}/\text{pixel}$），用于在物理单位和像素单位之间转换。例如，如果一个芯片上相邻捕获点的物理间距为 $P=100\,\mu\mathrm{m}$，那么在忽略旋转和拉伸的情况下，它们在图像中的预期像素间距就是 $P/\rho = 100/0.5 = 200$ 像素。

将这两个[坐标系](@entry_id:156346)对齐的过程称为**图像配准（image registration）**。这通常需要一个几何变换，以补偿两者之间可能存在的平移、旋转、缩放甚至形变。

- **仿射变换（Affine Transformation）**：这是一种[线性变换](@entry_id:149133)，可以表示为：
  $$ \begin{pmatrix} u \\ v \end{pmatrix} = \begin{pmatrix} a_{11} & a_{12} \\ a_{21} & a_{22} \end{pmatrix} \begin{pmatrix} x \\ y \end{pmatrix} + \begin{pmatrix} t_x \\ t_y \end{pmatrix} $$
  一个二维[仿射变换](@entry_id:144885)具有 **$6$ 个自由度**（矩阵中的4个元素和2个平移项）。它能保持直线的共线性，但通常不保持角度或距离，因此可以实现旋转、缩放、平移和剪切（shear）等操作。对于刚性的组织切片，[仿射变换](@entry_id:144885)通常足以实现良好的配准。

- **[非线性变换](@entry_id:636115)（Non-linear Transformation）**：当组织在处理过程中发生非均匀形变时，需要更灵活的[非线性变换](@entry_id:636115)。**薄板[样条](@entry_id:143749)（Thin-Plate Splines, TPS）**是一种常用的方法。TPS是一种平滑的、可变形的变换，其灵活性由一组**控制点（control points）**的数量 $K$ 决定。对于一个由 $K$ 个控制点定义的二维TPS变换，其自由参数数量与 $K$ 成正比（每个输出维度有 $K+3$ 个参数）。这使得TPS能够模拟复杂的局部拉伸和压缩，同时保持变换的整体平滑性，非常适合校正组织切片上不规则的扭曲。

#### 基因表达计数的[统计建模](@entry_id:272466)

基于捕获点和UMI技术的空间转录组学数据本质上是计数数据，即每个基因在每个捕获点的UMI数量 $y_{ig}$。对这些非负整数进行恰当的[统计建模](@entry_id:272466)是所有下游定量分析的基础。[@problem_id:3350205]

**[广义线性模型](@entry_id:171019)（Generalized Linear Model, GLM）**为这类数据提供了一个强大的框架。模型的核心思想是将[期望计数](@entry_id:162854) $\mu_{ig} = \mathbb{E}[y_{ig}]$ 与预测变量联系起来。对于计数数据，最自然的[连接函数](@entry_id:636388)是对数连接（log link），它确保了预测的[期望值](@entry_id:153208)为正。一个关键的组成部分是**大小因子（size factor）** $s_i$，它代表了捕获点 $i$ 的总采样深度或捕获效率。在GLM中，它被当作一个**偏移（offset）**项处理，从而模型可以写作：
$$ \log(\mu_{ig}) = \log(s_i) + \log(\lambda_g) $$
这里，$\lambda_g$ 代表基因 $g$ 的单位采样深度的基础表达率。这种 multiplicative 结构 $\mu_{ig} = s_i \lambda_g$ 符合我们对测序计数的直观理解：在其他条件相同的情况下，一个点的总UMI越多，其中任何一个基因的UMI也应按比例越多。

- **泊松（Poisson）模型**：最基础的计数模型是泊松分布，其假设计数的[方差](@entry_id:200758)等于其均值：$\mathrm{Var}(y_{ig}) = \mu_{ig}$。这对应于一个理想化的独立采样过程。然而，由于生物学上的[异质性](@entry_id:275678)（例如，一个捕获点内细胞类型和状态的混合），真实数据的[方差](@entry_id:200758)通常远大于均值，即存在**过离散（overdispersion）**。

- **负二项（Negative Binomial, NB）模型**：为了处理过离散，负二项分布模型被广泛使用。它可以被看作是一个**伽马-泊松[混合模型](@entry_id:266571)**：即我们假设每个点的真实表达率本身是一个服从伽马[分布](@entry_id:182848)的[随机变量](@entry_id:195330)，这解释了生物学上的额外变异。N[B模型](@entry_id:159413)的均值与泊松模型相同，$\mathbb{E}[y_{ig}] = \mu_{ig}$，但其[方差](@entry_id:200758)具有二次项：
  $$ \mathrm{Var}(y_{ig}) = \mu_{ig} + \alpha_g \mu_{ig}^2 $$
  其中，$\alpha_g \ge 0$ 是基因特异性的**离散度参数（dispersion parameter）**。当 $\alpha_g = 0$ 时，N[B模型](@entry_id:159413)退化为泊松模型。这个二次[方差](@entry_id:200758)结构能够很好地拟合[RNA测序](@entry_id:178187)数据中观察到的均值-[方差](@entry_id:200758)关系。

- **关于零膨胀（Zero-Inflation）**：早期的[RNA测序](@entry_id:178187)（非UMI）技术中，由于PCR扩增效率低下和技术性dropout，观察到的零值远多于标准计数模型（如泊松或NB）所能解释的，因此需要**[零膨胀模型](@entry_id:756817)**（例如ZINB）来额外增加一个产生零值的过程。然而，对于现代UMI数据，情况有所不同。UMI有效地消除了PCR扩增导致的偏差。大量的零值通常是真实的生物学信号（基因未表达）或深度采样不足的自然结果。经验和理论研究表明，只要模型恰当地包含了捕获点特异的大小因子 $s_i$ 并通过N[B模型](@entry_id:159413)的[离散度](@entry_id:168823)参数 $\alpha_g$ 来捕捉生物[异质性](@entry_id:275678)，**通常就不需要一个额外的零膨胀组件**。标准N[B模型](@entry_id:159413)本身就能很好地解释UMI数据中观察到的零值频率。

### 分析空间模式

[空间转录组学分析](@entry_id:173771)的核心任务是发现和量化基因表达的空间模式。这需要我们首先在数学上定义“空间关系”，然后利用统计量来描述基因表达值在这些关系上的结构。

#### 定义空间邻域

为了分析空间模式，我们必须首先将离散的捕获点坐标转化为一个能表达邻近关系的结构，这通常是一个**空间邻域图（spatial neighborhood graph）** $G=(V, E)$，其中节点 $V$ 是捕获点，边 $E$ 连接着空间上相邻的节点。构建这个图有多种策略，每种策略都有其自身的假设和适用场景。[@problem_id:3350231]

- **$k$-最近邻（kNN）图**：对于每个捕获点，连接到其空间距离最近的 $k$ 个点。这种方法的优点是具有**适应性**：在点密度稀疏的区域，它会自动连接到更远的点；在稠密区域，连接则非常局部。在[kNN图](@entry_id:751051)中，每个节点的[出度](@entry_id:263181)（out-degree）固定为 $k$，而入度（in-degree）则是一个[随机变量](@entry_id:195330)，其[期望值](@entry_id:153208)为 $k$ 但[方差](@entry_id:200758)不为零。[kNN图](@entry_id:751051)的拓扑结构对点的绝对密度（$\lambda$）不敏感，因为它是基于距离的排序。

- **$\epsilon$-半径图**：连接任意两个距离小于或等于阈值 $\epsilon$ 的点。这种方法的优点是定义了一个物理尺度上的“局部”概念。但其缺点是，节点的度数（邻居数量）对局部点密度非常敏感。在一个均匀的泊松点过程（PPP）中，一个点的度数服从泊松分布，其[期望值](@entry_id:153208)为 $\lambda \pi \epsilon^2$，与点过程的强度 $\lambda$ 成正比。在密度不均的组织中，这可能导致部分区域节点高度连接，而部分区域节点孤立。

- **Delaunay三角剖分图**：这是一种基于计算几何的构造，它将所有点连接成一个不重叠的三角形网络。其一个关键性质是任何三角形的[外接圆](@entry_id:165300)内部都不包含其他任何点（[空外接圆性质](@entry_id:635047)）。Delaunay图是平面的，对于大规模随机点集，其节点的[平均度](@entry_id:261638)数收敛于 $6$。与[kNN图](@entry_id:751051)类似，它的拓扑结构也是[尺度不变的](@entry_id:178566)，即不受点过程强度 $\lambda$ 的影响。然而，它可能会在稀疏区域产生非常长的边来“填补”空隙，因此其边的长度没有固定的上界。

在实践中，[kNN图](@entry_id:751051)因其对密度变化的鲁棒性而常被选用，但选择哪种图取决于具体的生物学问题和组织结构。

#### 量化[空间自相关](@entry_id:177050)

定义了空间邻域图之后，我们便可以量化**[空间自相关](@entry_id:177050)（spatial autocorrelation）**，即一个基因的表达值在空间上是否呈现出聚集（高值与高值相邻，低值与低值相邻）、分散（高值与低值相邻）或随机[分布](@entry_id:182848)的模式。

**[Moran's I](@entry_id:192667)** 是衡量全局[空间自相关](@entry_id:177050)的经典统计量。[@problem_id:3350202] 它的定义如下：
$$ I = \frac{n}{\sum_{i \ne j} w_{ij}} \cdot \frac{\sum_{i \ne j} w_{ij}(x_i-\bar{x})(x_j-\bar{x})}{\sum_i (x_i-\bar{x})^2} $$
其中，$n$ 是捕获点总数，$x_i$ 是基因在点 $i$ 的表达值，$\bar{x}$ 是均值，$w_{ij}$ 是空间权重矩阵 $W$ 的元素，表示点 $i$ 和 $j$ 的邻近程度（例如，如果 $j$ 是 $i$ 的kNN邻居则为1，否则为0）。

这个公式可以直观地理解为：
- 分子是**空间协[方差](@entry_id:200758)**：它度量了相邻位置（由 $w_{ij} > 0$ 定义）的表达值与全局均值的偏差乘[积之和](@entry_id:266697)。如果相邻点的值倾向于同时高于或低于均值，此项为正。
- 分母是**总[方差](@entry_id:200758)**的一个代理。
- 前面的缩放因子 $\frac{n}{\sum w_{ij}}$ 对权重矩阵的总大小进行归一化，使得不同权重矩阵下的 $I$ 值具有可比性。

[Moran's I](@entry_id:192667) 的值通常接近 $[-1, 1]$ 范围。正值表示正自相关（聚集），负值表示负自相关（分散），接近于其[期望值](@entry_id:153208)则表示空间随机性。在**[置换](@entry_id:136432)[零假设](@entry_id:265441)**（即基因表达值在空间位置上随机[排列](@entry_id:136432)）下，[Moran's I](@entry_id:192667) 的[期望值](@entry_id:153208)为 $E[I] = -1/(n-1)$。

[空间自相关](@entry_id:177050)的存在对标准的统计检验有着深远的影响。[@problem_id:3350184] 考虑一个[线性模型](@entry_id:178302)来检验不同组织域的表达差异：$y = X\beta + \epsilon$。如果基因表达存在正[空间自相关](@entry_id:177050)，那么残差项 $\epsilon$ 的协方差矩阵 $\Sigma$ 就不是对角阵。在这种情况下：
- **[普通最小二乘法](@entry_id:137121)（OLS）**虽然仍然是无偏的，但不再是最佳线性无偏估计（BLUE）。更严重的是，OLS对参数[方差](@entry_id:200758)的估计是有偏的。它忽略了数据的冗余性（相邻点的信息是相关的，[有效样本量](@entry_id:271661)小于 $n$），通常会**低估标准误**。这导致[检验统计量](@entry_id:167372)被人为地夸大，从而使 $p$ 值偏小，**[I型错误](@entry_id:163360)率（Type I error rate）膨胀**，即我们更容易错误地声称存在显著差异。这种检验被称为是**反保守的（anti-conservative）**。
- **[广义最小二乘法](@entry_id:272590)（GLS）**是正确的处理方法。GLS估计量为 $\hat{\beta}_{\mathrm{GLS}} = (X^\top \Sigma^{-1} X)^{-1} X^\top \Sigma^{-1} y$，它通过 $\Sigma^{-1}$ 对数据进行了“白化”（pre-whitening）处理，有效地消除了相关性，从而得到最优的估计和有效的[假设检验](@entry_id:142556)。在实践中，$\Sigma$ 通常是未知的，需要从数据中估计，这种方法被称为可行GLS（feasible GLS）。

### 高级空间建模技术

基于上述基本原则，研究人员开发了多种高级模型来解决空间转录组学中的特定生物学问题。

#### 识别空间可变基因

一个核心任务是识别那些表达模式与空间位置相关的**空间可变基因（Spatially Variable Genes, SVGs）**。这可以被形式化为一个统计检验问题。**高斯过程（Gaussian Process, GP）**为此提供了一个优雅的非参数框架。[@problem_id:3350230]

我们可以将一个基因的（经过标准化和[回归残差](@entry_id:163301)处理后的）表达向量 $x$ 建模为一个均值为零的高斯过程。其协方差矩阵 $\Sigma$ 被分解为两部分：
$$ \Sigma(\tau^2, \sigma^2, \theta) = \tau^2 K(\theta) + \sigma^2 I $$
- $K(\theta)$ 是一个**空间核矩阵**，其元素 $K_{ij}$ 是由点 $i$ 和 $j$ 之间距离决定的函数（例如，指数核 $k(\|s_i - s_j\|) = \exp(-\|s_i-s_j\|/\rho)$）。它捕捉了平滑的空间相关结构。
- $\tau^2$ 是**空间[方差](@entry_id:200758)组分**，它控制了空间相关结构的总强度。
- $\sigma^2 I$ 代表**独立同分布的噪声**（nugget effect），捕捉了非空间相关的技术或生物学变异。

识别SVG的任务就转化为检验空间[方差](@entry_id:200758)组分是否为零的假设：
$$ H_0: \tau^2 = 0 \quad \text{vs.} \quad H_1: \tau^2 > 0 $$
这是一个**在参数空间边界上的检验**，因为[方差](@entry_id:200758) $\tau^2$ 不能为负。在这种情况下，标准的[似然比检验](@entry_id:268070)的卡方分布假设不再成立。

一种有效的检验方法是**分数检验（score test）**。其[检验统计量](@entry_id:167372)通常可以写成如下形式：
$$ T = \frac{1}{2} \frac{\left( \frac{x^\top K x}{\hat{\sigma}^2} - \operatorname{tr}(K) \right)^2}{\operatorname{tr}(K^2)} $$
其中 $\hat{\sigma}^2 = \frac{1}{n} x^\top x$ 是在[零假设](@entry_id:265441)下 $\sigma^2$ 的[最大似然估计](@entry_id:142509)。这个统计量的直观含义是比较数据的二次型 $x^\top K x$ (一个衡量空间共[变性](@entry_id:165583)的量) 与其在[零假设](@entry_id:265441)下的[期望值](@entry_id:153208) $\hat{\sigma}^2 \operatorname{tr}(K)$ 之间的差异。

由于检验是在边界上进行的，该检验统计量在零假设下的[渐近分布](@entry_id:272575)是一个**混合[卡方分布](@entry_id:165213)**：
$$ T \sim \frac{1}{2}\chi^2_0 + \frac{1}{2}\chi^2_1 $$
其中 $\chi^2_0$ 是在0处的一个点质量。这种特殊的[分布](@entry_id:182848)形式必须被用来计算正确的 $p$ 值。

#### 空间域的无监督发现

另一个关键任务是基于基因表达数据来识别组织中具有不同生物学功能的**空间域（spatial domains）**。这是一个空间感知的聚类问题。**隐[马尔可夫随机场](@entry_id:751685)（Hidden Markov Random Field, HMRF）**是一个强大的生成模型，非常适合此任务。[@problem_id:3350168]

HMRF模型包含两个层面：
- **隐状态层（Prior）**：每个捕获点 $i$ 都有一个未知的离散标签 $z_i \in \{1, \dots, K\}$，代表其所属的域。这些标签被假设遵循一个**[马尔可夫随机场](@entry_id:751685)**，这意味着一个点的标签只依赖于其邻居的标签。一个常用的先验模型是**[Potts模型](@entry_id:139361)**：
  $$ P(\mathbf{z}) \propto \exp\left(\beta \sum_{(i,j)\in E} \mathbb{I}[z_i=z_j]\right) $$
  其中 $E$ 是空间邻域图的[边集](@entry_id:267160)，$\mathbb{I}[\cdot]$ 是指示函数。参数 $\beta \ge 0$ 控制[空间平滑](@entry_id:202768)的强度：$\beta$ 越大，模型越倾向于将相邻点分配给相同的标签，从而产生更平滑、更连续的域。

- **观测层（Likelihood）**：给定一个点的标签 $z_i=k$，其观测到的基因表达数据 $\mathbf{y}_i$（通常是经过降维处理后的主成分向量）被假设服从一个特定于该域的[分布](@entry_id:182848)，通常是**[高斯分布](@entry_id:154414)**：
  $$ \mathbf{y}_i \mid z_i=k \sim \mathcal{N}(\boldsymbol{\mu}_k, \boldsymbol{\Sigma}_k) $$
  其中 $\boldsymbol{\mu}_k$ 和 $\boldsymbol{\Sigma}_k$ 分别是域 $k$ 的[均值向量](@entry_id:266544)和协方差矩阵。

模型的参数（$\beta$, $\boldsymbol{\mu}_k$, $\boldsymbol{\Sigma}_k$）和隐标签 $\mathbf{z}$ 通常使用[期望最大化](@entry_id:273892)（EM）算法或迭代条件模式（ICM）等方法进行推断。这些算法的核心是计算一个点的标签的**全[条件概率](@entry_id:151013)（full conditional probability）**，即给定所有其他点的标签和所有观测数据，该点的标签概率。根据贝叶斯定理和模型的[条件独立性](@entry_id:262650)，这个概率可以推导为：
$$ P(z_i=k \mid \mathbf{z}_{-i}, \mathbf{y}) \propto \underbrace{\mathcal{N}(\mathbf{y}_i; \boldsymbol{\mu}_k, \boldsymbol{\Sigma}_k)}_{\text{似然项}} \times \underbrace{\exp\left(\beta \sum_{j \in \partial i} \mathbb{I}[k=z_j]\right)}_{\text{先验项}} $$
这个表达式清晰地展示了HMRF如何整合信息：一个点的标签既取决于它自身的表达数据（[似然](@entry_id:167119)项），也受到其邻居标签的“社会影响”（先验项）。

#### 细胞成分的反卷积

由于基于捕获点的技术测量的是多个细胞的混合物，一个重要的分析挑战是**细胞类型[反卷积](@entry_id:141233)（cell type deconvolution）**，即估计每个捕获点中各种细胞类型的比例。这通常需要一个外部的[单细胞RNA测序](@entry_id:142269)（scRNA-seq）数据集作为**参考**，该参考提供了每种细胞类型 $c$ 的典型基因表达谱 $\mu_{cg}$。[@problem_id:3350170]

反卷积的核心是一个**[线性混合模型](@entry_id:139702)（linear mixing model）**。该模型假设一个捕获点 $i$ 中基因 $g$ 的总表达量是其内部所有细胞类型贡献的加权和。设 $\pi_{ic}$ 是细胞类型 $c$ 在点 $i$ 的比例（满足 $\pi_{ic} \ge 0$ 和 $\sum_c \pi_{ic}=1$），那么该基因的期望UMI计数可以模型化为：
$$ \mathbb{E}[y_{ig}] = s_i \sum_c \pi_{ic} \mu_{cg} $$
其中 $s_i$ 仍然是捕获点 $i$ 的大小因子。

将这个均值结构与我们之前讨论的[负二项分布](@entry_id:262151)相结合，我们就得到了一个完整的概率模型：
$$ y_{ig} \sim \text{NB}\left(s_i \sum_c \pi_{ic} \mu_{cg}, \theta_g\right) $$
给定观测数据 $y_{ig}$、参考表达谱 $\mu_{cg}$ 以及估计出的大小因子 $s_i$ 和离散度 $\theta_g$，我们就可以通过最大化[似然](@entry_id:167119)或贝叶斯方法来推断未知的细胞比例 $\pi_{ic}$。

### 多数据集整合

当分析来自多个组织切片、不同批次或不同条件下的空间转录组数据时，一个严峻的挑战是**[批次效应](@entry_id:265859)（batch effects）**——由技术差异（如试剂批次、[测序深度](@entry_id:178191)）而非生物学差异引起的系统性变异。消除这些效应以实现数据的有效整合至关重要。[@problem_id:3350198]

整合的目标是学习一个校正映射 $h_s$，将每个样本 $s$ 的原始表达数据 $\mathbf{g}_{si}$ 转换到一个共同的[潜在空间](@entry_id:171820)中，使得生物学上相似的细胞在该空间中彼此靠近，而不管它们来自哪个批次。一个先进的整合策略通常需要平衡三个目标，这可以通过一个组合的[目标函数](@entry_id:267263)来实现：

1.  **锚点对齐（Anchor-based Alignment）**：首先识别跨样本的高置信度对应关系，即**锚点（anchors）**。一种有效的方法是寻找**[相互最近邻](@entry_id:752351)（Mutual Nearest Neighbors, MNNs）**，即在表达空间中互为最近邻的细胞对。为了增加空间数据的特异性，可以进一步要求这些MNN对在物理空间上也是邻近的。然后，通过一个损失项强制这些锚点对在整合后的空间中彼此靠近：
    $$ L_{\text{anchor}} = \sum_{(i,j)\in \mathcal{A}} \left\| h_{1}(\mathbf{g}_{1i}) - h_{2}(\mathbf{g}_{2j}) \right\|^{2} $$
    其中 $\mathcal{A}$ 是锚点对的集合。

2.  **样本内结构保持（Intra-sample Structure Preservation）**：在拉近跨样本细胞的同时，必须保持每个样本内部原有的生物学结构，尤其是空间邻近关系。这可以通过一个图[拉普拉斯正则化](@entry_id:634509)项来实现，惩罚整合后空间中相邻点之间的距离：
    $$ L_{\text{smooth}} = \sum_{s \in \{1,2\}} \sum_{(i,k)\in \mathcal{E}_{s}} w_{ik}^{(s)} \left\| h_{s}(\mathbf{g}_{si}) - h_{s}(\mathbf{g}_{sk}) \right\|^{2} $$
    其中 $\mathcal{E}_s$ 和 $w_{ik}^{(s)}$ 定义了每个样本内的空间邻域图。

3.  **全局[分布](@entry_id:182848)对齐（Global Distribution Alignment）**：为了确保整合后的数据[分布](@entry_id:182848)在全局上是一致的，而不仅仅是在锚点周围局部对齐，可以引入一个度量两个[分布](@entry_id:182848)差异的损失项。**[最大均值差异](@entry_id:636886)（Maximum Mean Discrepancy, MMD）**是一种强大的[非参数方法](@entry_id:138925)，可以度量两个点云在[再生核希尔伯特空间](@entry_id:633928)中的距离：
    $$ L_{\text{align}} = \mathrm{MMD}_{k}\left(\{h_{1}(\mathbf{g}_{1i})\}_{i}, \{h_{2}(\mathbf{g}_{2j})\}_{j}\right) $$

一个综合的[目标函数](@entry_id:267263)会将这三项结合起来，通过超参数 $\lambda$ 和 $\mu$ 来平衡它们的重要性：
$$ \min_{h_{1},h_{2}} L_{\text{anchor}} + \lambda L_{\text{smooth}} + \mu L_{\text{align}} $$
通过优化这个[目标函数](@entry_id:267263)，可以学习到既能有效校正[批次效应](@entry_id:265859)，又能忠实保留原始空间生物学结构的表达嵌入。