{"hands_on_practices": [{"introduction": "在构建复杂的代谢网络模型之前，我们必须首先认识到细胞生长受到物理和化学基本定律的根本制约。这项练习将剥离代谢网络的复杂性，专注于原子守恒和电子守恒这些绝对限制[@problem_id:3292219]。通过这个练习，你将学习如何仅从化学计量和氧化还原平衡的基本原理出发，推导出任何生物过程理论上的最大产率。", "problem": "单一碳底物和电子守恒的必要性，对底物碳能被整合到细胞生物质中的比例施加了严格的限制。考虑一个以葡萄糖为碳源、氨为氮源的好氧化学营养细胞。假设存在以下可交换物质：葡萄糖 $\\mathrm{C_{6}H_{12}O_{6}}$、氨 $\\mathrm{NH_{3}}$、双氧 $\\mathrm{O_{2}}$、水 $\\mathrm{H_{2}O}$ 和二氧化碳 $\\mathrm{CO_{2}}$。生物质由每个碳原子的经验化学式 $\\mathrm{CH_{1.8}O_{0.5}N_{0.2}}$ 表示。假设生长仅受元素守恒（碳、氢、氧、氮）和通过氧化还原平衡实现的电子守恒的限制，并忽略三磷酸腺苷（ATP）需求、维持消耗和动力学因素。假设除了 $\\mathrm{CO_{2}}$ 外没有其他有机副产物。\n\n从原子守恒和氧化还原守恒的基本原理出发，使用还原度来处理电子守恒，还原度定义为各原子贡献的总和：每个碳原子贡献 $+4$，每个氢原子贡献 $+1$，每个氧原子贡献 $-2$，每个氮原子贡献 $-3$。利用此方法，确定对于所有化学计量上可行的、形式如下的反应\n$$\n\\mathrm{C_{6}H_{12}O_{6}} + b\\,\\mathrm{NH_{3}} + c\\,\\mathrm{O_{2}} \\;\\longrightarrow\\; n\\,\\mathrm{CH_{1.8}O_{0.5}N_{0.2}} + m\\,\\mathrm{CO_{2}} + d\\,\\mathrm{H_{2}O},\n$$\n葡萄糖碳能被整合到生物质碳中的比例的理论上限。该比例定义为 $f = \\frac{n}{6}$，因为一摩尔生物质经验单位含有一个碳原子。\n\n计算由元素和氧化还原平衡所蕴含的 $f$ 的最大可行值。将最终答案以小数形式表示，并四舍五入到四位有效数字。答案不应附加单位。", "solution": "该问题要求计算从葡萄糖底物中能被整合到细胞生物质中的碳的比例的理论上限。这是一个受元素守恒和电子守恒约束的化学计量分析问题。\n\n总反应式如下：\n$$\n\\mathrm{C_{6}H_{12}O_{6}} + b\\,\\mathrm{NH_{3}} + c\\,\\mathrm{O_{2}} \\;\\longrightarrow\\; n\\,\\mathrm{CH_{1.8}O_{0.5}N_{0.2}} + m\\,\\mathrm{CO_{2}} + d\\,\\mathrm{H_{2}O}\n$$\n其中 $b, c, n, m, d$ 是待确定的化学计量系数。该反应以1摩尔葡萄糖为基准进行归一化。目标是最大化碳整合比例 $f = \\frac{n}{6}$。\n\n首先，我们为每种元素建立平衡方程：碳（C）、氢（H）、氧（O）和氮（N）。\n1.  **碳（C）平衡：** 反应物中的碳原子数必须等于生成物中的碳原子数。\n    $$\n    6 \\times 1 = n \\times 1 + m \\times 1 \\implies 6 = n + m\n    $$\n2.  **氮（N）平衡：** 氨是唯一的氮源。\n    $$\n    b \\times 1 = n \\times 0.2 \\implies b = 0.2n\n    $$\n3.  **氢（H）平衡：**\n    $$\n    12 \\times 1 + b \\times 3 = n \\times 1.8 + d \\times 2 \\implies 12 + 3b = 1.8n + 2d\n    $$\n4.  **氧（O）平衡：**\n    $$\n    6 \\times 1 + c \\times 2 = n \\times 0.5 + m \\times 2 + d \\times 1 \\implies 6 + 2c = 0.5n + 2m + d\n    $$\n\n这个系统有4个线性方程和5个未知系数（$b, c, n, m, d$），这意味着存在一个自由度。\n\n接下来，我们引入电子守恒（氧化还原平衡）原理。问题定义了每个原子的还原度 $\\gamma$：C ($+4$)、H ($+1$)、O ($-2$) 和 N ($-3$)。我们计算反应中每个分子的 $\\gamma$：\n-   葡萄糖 ($\\mathrm{C_{6}H_{12}O_{6}}$): $\\gamma_{glc} = 6(+4) + 12(+1) + 6(-2) = 24 + 12 - 12 = 24$\n-   氨 ($\\mathrm{NH_{3}}$): $\\gamma_{amm} = 1(-3) + 3(+1) = 0$\n-   双氧 ($\\mathrm{O_{2}}$): $\\gamma_{O_2} = 2(-2) = -4$\n-   生物质 ($\\mathrm{CH_{1.8}O_{0.5}N_{0.2}}$): $\\gamma_{bio} = 1(+4) + 1.8(+1) + 0.5(-2) + 0.2(-3) = 4 + 1.8 - 1.0 - 0.6 = 4.2$\n-   二氧化碳 ($\\mathrm{CO_{2}}$): $\\gamma_{CO_2} = 1(+4) + 2(-2) = 0$\n-   水 ($\\mathrm{H_{2}O}$): $\\gamma_{H_2O} = 2(+1) + 1(-2) = 0$\n\n通过总还原度守恒得到氧化还原平衡方程：\n$$\n1 \\cdot \\gamma_{glc} + b \\cdot \\gamma_{amm} + c \\cdot \\gamma_{O_2} = n \\cdot \\gamma_{bio} + m \\cdot \\gamma_{CO_2} + d \\cdot \\gamma_{H_2O}\n$$\n代入计算出的值：\n$$\n1(24) + b(0) + c(-4) = n(4.2) + m(0) + d(0) \\implies 24 - 4c = 4.2n\n$$\n这个氧化还原平衡方程不是独立于元素平衡方程的；它是它们的线性组合。然而，它提供了一个底物、氧气和生物质之间的便捷关系。\n\n为了找到 $n$ 的最大值，我们使用平衡方程将所有其他系数用 $n$ 表示。\n根据碳平衡：$m = 6 - n$。\n根据氮平衡：$b = 0.2n$。\n根据氧化还原平衡：$4c = 24 - 4.2n \\implies c = 6 - 1.05n$。\n将 $b$ 代入氢平衡方程以求出 $d$：\n$12 + 3(0.2n) = 1.8n + 2d$\n$12 + 0.6n = 1.8n + 2d$\n$12 = 1.2n + 2d \\implies d = 6 - 0.6n$。\n\n化学计量系数代表物理量，因此必须是非负的。这对 $n$ 的可能取值施加了约束。\n-   $n \\ge 0$：生成的生物质量必须是非负的。\n-   $m = 6 - n \\ge 0 \\implies n \\le 6$。\n-   $b = 0.2n \\ge 0 \\implies n \\ge 0$。\n-   $d = 6 - 0.6n \\ge 0 \\implies 0.6n \\le 6 \\implies n \\le 10$。\n-   $c = 6 - 1.05n \\ge 0 \\implies 1.05n \\le 6 \\implies n \\le \\frac{6}{1.05}$。\n\n我们来评估由 $c$ 带来的约束：\n$n \\le \\frac{6}{1.05} = \\frac{6}{21/20} = \\frac{6 \\times 20}{21} = \\frac{120}{21} = \\frac{40}{7}$。\n因此，$n \\le \\frac{40}{7} \\approx 5.714$。\n\n综合所有对 $n$ 的约束：\n$0 \\le n \\le 6$\n$n \\le 10$\n$n \\le \\frac{40}{7}$\n\n对 $n$ 最严格的上限是 $n \\le \\frac{40}{7}$。因此，$n$ 的最大可行值为 $n_{max} = \\frac{40}{7}$。\n这个最大生物质产率发生在 $c=0$ 时，这对应于不消耗氧气的点。这代表了碳和电子通量最大化地导向生物质合成的理论极限。\n\n问题要求的是葡萄糖碳被整合到生物质中的最大比例，$f = \\frac{n}{6}$。\n该比例的最大值为：\n$$\nf_{max} = \\frac{n_{max}}{6} = \\frac{40/7}{6} = \\frac{40}{7 \\times 6} = \\frac{40}{42} = \\frac{20}{21}\n$$\n为了给出最终答案，我们计算其小数值并四舍五入到四位有效数字：\n$$\nf_{max} = \\frac{20}{21} \\approx 0.95238095...\n$$\n四舍五入到四位有效数字得到 $0.9524$。", "answer": "$$\\boxed{0.9524}$$", "id": "3292219"}, {"introduction": "虽然化学计量学设定了可能性的边界，但通量平衡分析（Flux Balance Analysis, FBA）使我们能够在这个可行空间内找到最佳的操作点。这项练习将引导你通过编程实践FBA的核心技术，并介绍一个关键的解释性概念——影子价格（shadow prices）[@problem_id:3292147]。通过完成这项练习，你将学会如何量化一种资源（如葡萄糖或氧气）对于细胞目标的价值，从而深入理解代谢瓶颈的本质。", "problem": "考虑流平衡分析 (Flux Balance Analysis, FBA) 的公式，它被定义为一个在稳态质量平衡下的代谢网络的线性优化问题。假设有一组反应，其通量由向量 $v \\in \\mathbb{R}^n$ 表示，一个化学计量矩阵 $S \\in \\mathbb{R}^{m \\times n}$，以及一个线性的生物目标函数 $c^{\\top} v$，该函数编码了一个与生长相关的反应（生物质合成）。稳态假设意味着胞内代谢物满足质量平衡约束 $S v = 0$，而生物物理上合理的约束意味着通量具有下界和上界 $l \\leq v \\leq u$。原优化问题是在约束 $S v = 0$ 和界限 $l \\leq v \\leq u$ 下，最大化线性目标 $c^{\\top} v$。\n\n使用以下科学上一致的最小网络，该网络将底物的摄取与三磷酸腺苷 (ATP) 的生成和生物质合成联系起来。该网络包含 $5$ 个反应和 $3$ 种胞内代谢物：\n\n- 反应和通量：\n    1. 葡萄糖摄取 $v_1$，界限为 $0 \\leq v_1 \\leq U_{\\mathrm{glc}}$。\n    2. 糖酵解 $v_2$，界限为 $0 \\leq v_2 \\leq +\\infty$。\n    3. 氧气摄取 $v_3$，界限为 $0 \\leq v_3 \\leq U_{\\mathrm{O_2}}$。\n    4. 呼吸作用 $v_4$，界限为 $0 \\leq v_4 \\leq +\\infty$。\n    5. 生物质（ATP 汇）$v_5$，界限为 $0 \\leq v_5 \\leq +\\infty$，在目标函数 $c^{\\top} v$ 中的系数为 $1$。\n\n- 胞内代谢物：葡萄糖 $G$、氧气 $O$ 和三磷酸腺苷 $ATP$。\n\n- 化学计量矩阵 $S$，其行按 $\\{G, O, ATP\\}$ 顺序排列，列按 $\\{v_1, v_2, v_3, v_4, v_5\\}$ 顺序排列：\n$$\nS \\;=\\;\n\\begin{bmatrix}\n1  -1  0  -1  0 \\\\\n0  0  1  -6  0 \\\\\n0  2  0  10  -1\n\\end{bmatrix}.\n$$\n\n该矩阵编码了以下质量平衡：\n- 葡萄糖：$v_1 - v_2 - v_4 = 0$。\n- 氧气：$v_3 - 6 v_4 = 0$。\n- ATP：$2 v_2 + 10 v_4 - v_5 = 0$。\n\n生物目标是在稳态下最大化生物质通量 $v_5$。所有通量均以毫摩尔每克干重每小时表示，即 $\\mathrm{mmol}\\,\\mathrm{gDW}^{-1}\\,\\mathrm{h}^{-1}$。您的程序必须计算：\n1. 最优目标值 $v_5^\\star$（生物质通量），单位为 $\\mathrm{mmol}\\,\\mathrm{gDW}^{-1}\\,\\mathrm{h}^{-1}$。\n2. 与葡萄糖摄取上界 $v_1 \\leq U_{\\mathrm{glc}}$ 和氧气摄取上界 $v_3 \\leq U_{\\mathrm{O_2}}$ 相关联的影子价格（拉格朗日乘子），在最大化设定中分别解释为灵敏度 $\\frac{\\partial v_5^\\star}{\\partial U_{\\mathrm{glc}}}$ 和 $\\frac{\\partial v_5^\\star}{\\partial U_{\\mathrm{O_2}}}$。\n3. 使用对相应上界的小有限差分微扰并重新计算最优目标，对影子价格进行数值验证，以检查灵敏度是否在指定容差内等于影子价格。\n\n您的推理和计算应基于以下经过充分检验的基础：\n- 稳态模型 $S v = 0$，体现了胞内代谢物的质量守恒。\n- 将线性规划对偶中的拉格朗日乘子（影子价格）解释为目标对右侧项和界限参数的灵敏度。\n- 线性规划的包络定理，该定理指出在正则条件下，最优目标关于某个参数的导数等于相关的最优拉格朗日乘子。\n\n实现一个程序，该程序使用可靠的求解器构建并求解原线性规划问题，提取上界的对偶信息（影子价格），将其适当地转换为最大化约定，并通过有限差分验证灵敏度。\n\n使用以下上界参数 $\\left(U_{\\mathrm{glc}}, U_{\\mathrm{O_2}}\\right)$ 的测试套件，单位均为 $\\mathrm{mmol}\\,\\mathrm{gDW}^{-1}\\,\\mathrm{h}^{-1}$：\n- 测试用例 A（平衡，两个界限都可能激活）：$\\left(U_{\\mathrm{glc}}, U_{\\mathrm{O_2}}\\right) = \\left(10, 15\\right)$。\n- 测试用例 B（氧气非限制性）：$\\left(U_{\\mathrm{glc}}, U_{\\mathrm{O_2}}\\right) = \\left(10, 60\\right)$。\n- 测试用例 C（严格厌氧）：$\\left(U_{\\mathrm{glc}}, U_{\\mathrm{O_2}}\\right) = \\left(2, 0\\right)$。\n- 测试用例 D（无碳源）：$\\left(U_{\\mathrm{glc}}, U_{\\mathrm{O_2}}\\right) = \\left(0, 100\\right)$。\n\n对于每个测试用例，您的程序必须计算：\n- $v_5^\\star$，作为浮点数，单位为 $\\mathrm{mmol}\\,\\mathrm{gDW}^{-1}\\,\\mathrm{h}^{-1}$。\n- 葡萄糖上界的影子价格 $\\frac{\\partial v_5^\\star}{\\partial U_{\\mathrm{glc}}}$，作为浮点数。\n- 氧气上界的影子价格 $\\frac{\\partial v_5^\\star}{\\partial U_{\\mathrm{O_2}}}$，作为浮点数。\n- 一个布尔值，指示葡萄糖的有限差分灵敏度是否在绝对容差 $\\varepsilon_{\\mathrm{tol}} = 10^{-6}$ 内与相应的影子价格匹配。\n- 一个布尔值，指示氧气的有限差分灵敏度是否在绝对容差 $\\varepsilon_{\\mathrm{tol}} = 10^{-6}$ 内与相应的影子价格匹配。\n\n对 $U_{\\mathrm{glc}}$ 和 $U_{\\mathrm{O_2}}$ 的微扰使用有限差分步长 $\\delta = 10^{-4}$。数值求解器应通过在适当时将上界表示为无界来处理界限 $[0, +\\infty)$。明确地，所有通量和灵敏度都以 $\\mathrm{mmol}\\,\\mathrm{gDW}^{-1}\\,\\mathrm{h}^{-1}$ 表示。\n\n最终输出格式规范：\n- 您的程序应生成单行输出，其中包含跨四个测试用例聚合的结果，平铺成一个用方括号括起来的逗号分隔列表。每个测试用例的顺序必须严格如下：\n    1. $v_5^\\star$\n    2. $U_{\\mathrm{glc}}$ 的影子价格\n    3. $U_{\\mathrm{O_2}}$ 的影子价格\n    4. 葡萄糖的有限差分检查（布尔值）\n    5. 氧气的有限差分检查（布尔值）\n- 对于四个测试用例，这将产生一个包含 $20$ 个条目的列表。例如，输出应具有 $[r_1,r_2,\\dots,r_{20}]$ 的句法形式，仅包含浮点数和布尔值，没有单位或其他文本。", "solution": "该问题要求对一个最小代谢网络构建并求解一个流平衡分析（FBA）问题，计算底物摄取的影子价格，并对其进行数值验证。该问题在科学和数学上是适定的，为获得唯一解提供了所有必要信息。我们按部就班地进行推导和计算策略。\n\n**1. 线性规划的构建**\n\n流平衡分析（FBA）使用线性规划来模拟稳态下的代谢网络。问题的核心是优化一个生物目标函数（通常是生物质产量），同时满足质量平衡和生物物理约束。\n\n令反应通量向量为 $v = [v_1, v_2, v_3, v_4, v_5]^{\\top} \\in \\mathbb{R}^5$。目标是最大化生物质通量 $v_5$。这等价于最大化线性函数 $c^{\\top}v$，其中目标向量为 $c = [0, 0, 0, 0, 1]^{\\top}$。\n\n约束条件如下：\na) **稳态质量平衡**：每种胞内代谢物的净生成量必须为零。这表示为一个线性方程组 $S v = 0$，其中 $S$ 是化学计量矩阵。\n$$\nS v = \\begin{bmatrix}\n1  -1  0  -1  0 \\\\\n0  0  1  -6  0 \\\\\n0  2  0  10  -1\n\\end{bmatrix}\n\\begin{bmatrix}\nv_1 \\\\ v_2 \\\\ v_3 \\\\ v_4 \\\\ v_5\n\\end{bmatrix}\n=\n\\begin{bmatrix}\n0 \\\\ 0 \\\\ 0\n\\end{bmatrix}\n$$\nb) **通量界限**：每个通量 $v_i$ 都受下界和上界约束，$l_i \\le v_i \\le u_i$。根据问题描述，这些界限是：\n- $0 \\le v_1 \\le U_{\\mathrm{glc}}$\n- $0 \\le v_2 \\le +\\infty$\n- $0 \\le v_3 \\le U_{\\mathrm{O_2}}$\n- $0 \\le v_4 \\le +\\infty$\n- $0 \\le v_5 \\le +\\infty$\n\n完整的原线性规划（LP）问题是：\n$$\n\\begin{array}{ll}\n\\text{最大化}  v_5 \\\\\n\\text{约束于}  S v = 0 \\\\\n 0 \\le v_1 \\le U_{\\mathrm{glc}} \\\\\n 0 \\le v_3 \\le U_{\\mathrm{O_2}} \\\\\n v_2, v_4, v_5 \\ge 0\n\\end{array}\n$$\n\n**2. 使用数值求解器求解原LP问题**\n\n标准的数值求解器，如 `scipy.optimize.linprog`，通常被构建为最小化问题。为了最大化 $v_5$，我们可以最小化 $-v_5$。因此，求解器的目标函数是最小化 $c_{\\text{obj}}^{\\top} v$，其中 $c_{\\text{obj}} = [0, 0, 0, 0, -1]^{\\top}$。\n\n`scipy.optimize.linprog` 的参数是：\n- `c`：要最小化的目标向量，$c_{\\text{obj}} = [0, 0, 0, 0, -1]^{\\top}$。\n- `A_eq`：等式约束的矩阵，即化学计量矩阵 $S$。\n- `b_eq`：等式约束的右侧项，是一个大小为 $m=3$ 的零向量。\n- `bounds`：每个通量变量的 `(min, max)` 对序列。对于无上界的情况，使用 `None`。\n    - $v_1$：$(0, U_{\\mathrm{glc}})$\n    - $v_2$：$(0, \\text{None})$\n    - $v_3$：$(0, U_{\\mathrm{O_2}})$\n    - $v_4$：$(0, \\text{None})$\n    - $v_5$：$(0, \\text{None})$\n\n求解这个LP问题可以得到最优通量向量 $v^\\star$，从中可以获得最优生物质通量 $v_5^\\star$。$v_5$ 的最大值是求解器返回的最小值（即 $-(\\text{res.fun})$）的相反数。\n\n**3. 对偶、影子价格和灵敏度分析**\n\n在线性规划中，对偶问题提供了有价值的经济学解释。对偶变量，也称为拉格朗日乘子或影子价格，衡量最优目标值对约束条件变化的敏感度。\n\n我们感兴趣的是最优生物质 $v_5^\\star$ 相对于葡萄糖 ($U_{\\mathrm{glc}}$) 和氧气 ($U_{\\mathrm{O_2}}$) 摄取上界的灵敏度。这些是与约束 $v_1 \\le U_{\\mathrm{glc}}$ 和 $v_3 \\le U_{\\mathrm{O_2}}$ 相关联的影子价格。\n\n设最小化问题的最优值为 $Z_{\\text{min}} = -v_5^\\star$。由 `scipy.optimize.linprog` 返回的（例如，通过 `res.upper.marginals`）上界约束 $v_i \\le u_i$ 的影子价格（边际值）代表目标函数 $Z_{\\text{min}}$ 相对于界限 $u_i$ 增加的变化率。即，$\\mu_{u_i} = \\frac{\\partial Z_{\\text{min}}}{\\partial u_i}$。\n\n由于我们感兴趣的是最大化目标 $v_5^\\star$ 的灵敏度，我们有：\n$$\n\\frac{\\partial v_5^\\star}{\\partial u_i} = \\frac{\\partial (-Z_{\\text{min}})}{\\partial u_i} = - \\frac{\\partial Z_{\\text{min}}}{\\partial u_i} = -\\mu_{u_i}\n$$\n因此，葡萄糖上界的影子价格是求解器为 $v_1$ 的上界返回的边际值的相反数。氧气和 $v_3$ 的情况也类似。\n- $\\frac{\\partial v_5^\\star}{\\partial U_{\\mathrm{glc}}} = -(\\text{res.upper.marginals}[0])$\n- $\\frac{\\partial v_5^\\star}{\\partial U_{\\mathrm{O_2}}} = -(\\text{res.upper.marginals}[2])$\n\n在正则条件下（即当对偶解唯一时），这种关系由线性规划的包络定理保证。\n\n**4. 通过有限差分进行数值验证**\n\n为了数值验证影子价格，我们可以使用前向有限差分公式来近似导数。对于一个小的扰动 $\\delta > 0$：\n$$\n\\frac{\\partial v_5^\\star}{\\partial U_{\\mathrm{glc}}} \\approx \\frac{v_5^\\star(U_{\\mathrm{glc}} + \\delta, U_{\\mathrm{O_2}}) - v_5^\\star(U_{\\mathrm{glc}}, U_{\\mathrm{O_2}})}{\\delta}\n$$\n$$\n\\frac{\\partial v_5^\\star}{\\partial U_{\\mathrm{O_2}}} \\approx \\frac{v_5^\\star(U_{\\mathrm{glc}}, U_{\\mathrm{O_2}} + \\delta) - v_5^\\star(U_{\\mathrm{glc}}, U_{\\mathrm{O_2}})}{\\delta}\n$$\n计算过程包括：\n1. 求解基础参数 $(U_{\\mathrm{glc}}, U_{\\mathrm{O_2}})$ 的LP问题，得到 $v_5^\\star$ 和影子价格。\n2. 用扰动后的葡萄糖界限 $(U_{\\mathrm{glc}} + \\delta, U_{\\mathrm{O_2}})$ 求解LP问题，得到新的最优值 $v_{5, \\text{pert_glc}}^\\star$。\n3. 用扰动后的氧气界限 $(U_{\\mathrm{glc}}, U_{\\mathrm{O_2}} + \\delta)$ 求解LP问题，得到新的最优值 $v_{5, \\text{pert_o2}}^\\star$。\n4. 计算灵敏度的有限差分近似值。\n5. 在给定的容差 $\\varepsilon_{\\mathrm{tol}}$ 内，比较计算出的影子价格与其相应的有限差分近似值。\n\n如果最优解位于目标函数关于参数的梯度不连续的点（一个“扭结”点），影子价格（一个对偶变量）和有限差分（一个单边导数）可能不匹配。这不是一个错误，而是非光滑优化的一个基本属性，我们的布尔检查将正确地捕捉到这种差异。\n\n以下程序为每个指定的测试用例实现了这一逻辑。", "answer": "```python\nimport numpy as np\nfrom scipy.optimize import linprog\n\ndef solve():\n    \"\"\"\n    Solves the FBA problem for a minimal metabolic network across several test cases,\n    computes optimal biomass flux and shadow prices for substrate uptake, and verifies\n    the shadow prices using finite differences.\n    \"\"\"\n\n    # Stoichiometric matrix S (rows: G, O, ATP; cols: v1-v5)\n    S = np.array([\n        [1, -1, 0, -1, 0],\n        [0, 0, 1, -6, 0],\n        [0, 2, 0, 10, -1]\n    ])\n\n    # Objective: maximize v5, which is equivalent to minimizing -v5\n    c_obj = np.array([0, 0, 0, 0, -1])\n\n    # Steady-state constraint Sv = 0\n    b_eq = np.zeros(S.shape[0])\n\n    # Test suite of upper bounds (U_glc, U_O2)\n    test_cases = [\n        (10, 15),    # Case A: Balanced\n        (10, 60),    # Case B: Oxygen non-limiting\n        (2, 0),      # Case C: Strictly anaerobic\n        (0, 100),    # Case D: No carbon\n    ]\n    \n    # Numerical parameters\n    delta = 1e-4  # Finite difference step\n    tol = 1e-6    # Absolute tolerance for verification\n\n    results = []\n\n    def run_fba(U_glc, U_o2):\n        \"\"\"\n        Helper function to set up and solve the LP for given uptake bounds.\n        Returns optimal biomass flux and shadow prices for uptake bounds.\n        \"\"\"\n        bounds = [\n            (0, U_glc),    # v1: Glucose uptake\n            (0, None),     # v2: Glycolysis\n            (0, U_o2),     # v3: Oxygen uptake\n            (0, None),     # v4: Respiration\n            (0, None)      # v5: Biomass (ATP sink)\n        ]\n\n        # Use 'highs' method for robustness and access to duals\n        res = linprog(c=c_obj, A_eq=S, b_eq=b_eq, bounds=bounds, method='highs')\n\n        if not res.success:\n            # Handle cases with no feasible solution, e.g., negative bounds not used here.\n            return 0.0, 0.0, 0.0\n\n        # Optimal objective value (biomass flux)\n        # res.fun is the minimum of -v5, so -res.fun is the maximum of v5\n        v5_star = -res.fun\n\n        # Shadow prices (sensitivities) for the maximization problem\n        # The marginals from scipy are for the minimization problem.\n        # sensitivity = -marginal, as derived in the solution text.\n        sp_glc = -res.upper.marginals[0] if res.upper.marginals is not None else 0.0\n        sp_o2 = -res.upper.marginals[2] if res.upper.marginals is not None else 0.0\n        \n        return v5_star, sp_glc, sp_o2\n\n    for U_glc_base, U_o2_base in test_cases:\n        # 1. Solve for the base case\n        v5_base, sp_glc_base, sp_o2_base = run_fba(U_glc_base, U_o2_base)\n\n        # 2. Solve for perturbed glucose uptake\n        v5_pert_glc, _, _ = run_fba(U_glc_base + delta, U_o2_base)\n        \n        # 3. Solve for perturbed oxygen uptake\n        v5_pert_o2, _, _ = run_fba(U_glc_base, U_o2_base + delta)\n\n        # 4. Calculate finite difference sensitivities\n        fd_sens_glc = (v5_pert_glc - v5_base) / delta\n        fd_sens_o2 = (v5_pert_o2 - v5_base) / delta\n        \n        # 5. Verify shadow prices against finite difference sensitivities\n        check_glc = np.isclose(sp_glc_base, fd_sens_glc, atol=tol)\n        check_o2 = np.isclose(sp_o2_base, fd_sens_o2, atol=tol)\n\n        # Append results for this test case\n        results.extend([\n            v5_base,\n            sp_glc_base,\n            sp_o2_base,\n            bool(check_glc),\n            bool(check_o2)\n        ])\n\n    # Format and print the final aggregated results\n    # Use a custom formatter to handle boolean capitalization\n    def format_item(item):\n        if isinstance(item, bool):\n            return str(item).lower()\n        if isinstance(item, float):\n            return f\"{item:.8f}\" # Use sufficient precision for floats\n        return str(item)\n\n    print(f\"[{','.join(map(format_item, results))}]\")\n\nsolve()\n```", "id": "3292147"}, {"introduction": "细胞的“目标”并非一成不变，它不总是追求最快生长。根据环境条件，细胞可能会优先考虑资源利用效率或特定化合物的生产。本练习将探讨如何通过在FBA框架内构建不同的目标函数来模拟这些多样的生物策略[@problem_id:3292204]。这项实践突显了FBA作为建模工具的强大灵活性，教你如何将定性的生物学情景（例如，在最低限度培养基与丰富培养基中的生长）转化为定量的、可预测的模型。", "problem": "考虑一个用于单细胞生物体在最低或丰富培养基中生长时进行通量平衡分析（FBA）的玩具但科学一致的代谢网络。其目标是比较适用于最低培养基（最大化生长）与丰富培养基（在维持生长的同时优化资源使用或生产）的目标函数。使用以下基本原理：稳态下的质量守恒、化学计量约束和用于计算最优通量分布的线性规划。稳态假设意味着每种内源代谢物的净生成速率为零。\n\n设内源代谢物为 $C$（碳池）、$O$（氧气）、$N$（氮）、$A$（三磷酸腺苷，ATP）和 $W$（废物）。定义通量向量 $v \\in \\mathbb{R}^8$，其分量为：\n- $v_1$：碳摄取，\n- $v_2$：氧气摄取，\n- $v_3$：氮摄取，\n- $v_4$：有氧分解代谢（呼吸作用），\n- $v_5$：无氧分解代谢（发酵作用），\n- $v_6$：生物质合成（生物生长目标通量），\n- $v_7$：产物合成（生产目标通量），\n- $v_8$：废物排出。\n\n化学计量矩阵 $S \\in \\mathbb{R}^{5 \\times 8}$ 强制实施 $S v = 0$ 以实现内源代谢物的稳态质量平衡，其行序为 $(C,O,N,A,W)$，列序为 $(v_1,\\dots,v_8)$：\n$$\nS \\;=\\;\n\\begin{bmatrix}\n+1  0  0  -1  -1  -1  -2  0 \\\\\n0  +1  0  -1  0  0  0  0 \\\\\n0  0  +1  0  0  -1  0  0 \\\\\n0  0  0  +4  +1  -2  -1  0 \\\\\n0  0  0  +1  +1  0  0  -1 \\\\\n\\end{bmatrix}.\n$$\n\n所有通量都限制为非负，并具有如下上界：\n- 摄取通量界限：$0 \\le v_1 \\le C_{\\max}$，$0 \\le v_2 \\le O_{\\max}$，$0 \\le v_3 \\le N_{\\max}$，\n- 内部反应界限：$0 \\le v_j \\le 1000$ 对 $j \\in \\{4,5,6,7,8\\}$。\n\n该网络结构捕捉了以下生物物理学陈述：\n- 有氧分解代谢消耗 $C$ 和 $O$ 以产生 $A$ 和 $W$（此处为每单位 $C$ 和 $O$ 产生 $4$ 单位 $A$），由 $v_4$ 代表，其化学计量为 $-C - O + 4A + W$。\n- 发酵作用消耗 $C$ 以产生 $A$ 和 $W$（此处为每单位 $C$ 产生 $1$ 单位 $A$），由 $v_5$ 代表，其化学计量为 $-C + A + W$。\n- 生物质合成消耗 $C$、$N$ 和 $A$（此处为每单位生物质消耗 $1C + 1N + 2A$），并耗尽这些内部池，由 $v_6$ 代表，其化学计量为 $-C - N - 2A$。\n- 产物合成消耗 $C$ 和 $A$（此处为每单位产物消耗 $2C + 1A$），并耗尽这些内部池，由 $v_7$ 代表，其化学计量为 $-2C - A$。\n- 废物排出消耗 $W$，由 $v_8$ 代表，其化学计量为 $-W$。\n\n定义生物学目标函数：\n- 最低培养基目标：在 $S v = 0$ 和通量界限的约束下，通过最大化 $v_6$ 来最大化生长。\n- 丰富培养基目标变体A（资源优化）：对于目标生长水平 $v_6 \\ge \\alpha \\cdot v_6^{\\max}$，在 $S v = 0$ 和通量界限的约束下，最小化碳摄取 $v_1$。\n- 丰富培养基目标变体B（带生存力的生产）：在 $v_6 \\ge \\beta \\cdot v_6^{\\max}$、$S v = 0$ 和通量界限的约束下，最大化产物合成 $v_7$。\n\n此处，$v_6^{\\max}$ 表示在相同摄取界限下，最低培养基目标中 $v_6$ 的最优值。所有通量均应以毫摩尔/克干重·小时 (mmol/(gDW·h)) 为单位报告。\n\n您的任务是实现一个程序，对于下面套件中的每个测试用例，计算并返回一个包含三个浮点数的列表：\n- 最大生长速率 $v_6^{\\max}$，\n- 达到至少 $\\alpha \\cdot v_6^{\\max}$ 生长所需的最小碳摄取 $v_1$，\n- 在维持 $v_6 \\ge \\beta \\cdot v_6^{\\max}$ 的同时可实现的最大产物生成速率 $v_7$。\n\n测试套件（每个用例为 $(C_{\\max}, O_{\\max}, N_{\\max}, \\alpha, \\beta)$）：\n1. $(10, 15, 5, 0.9, 0.2)$：一个相对于碳而言氧气和氮充足的最低培养基案例。\n2. $(100, 100, 100, 0.9, 0.2)$：一个资源丰富的丰富培养基案例。\n3. $(10, 0, 5, 0.9, 0.2)$：一个氧气受限的案例（无氧边界）。\n4. $(4, 100, 100, 0.9, 0.2)$：一个在其他条件丰富的情况下碳受限的案例。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，每个元素对应一个测试用例，并且本身是按指定顺序包含三个计算出的浮点数的列表。例如，输出应类似于 $[\\,[v_{6,\\text{case1}}^{\\max}, v_{1,\\text{case1}}^{\\min}, v_{7,\\text{case1}}^{\\max}],\\,[v_{6,\\text{case2}}^{\\max}, \\dots],\\,\\dots\\,]$。所有报告值必须以 mmol/(gDW·h) 为单位。", "solution": "所提出的问题是通量平衡分析（FBA）的一个有效、适定且具有科学依据的应用。它需要求解一系列线性规划（LP）问题，以确定在不同生物学目标和环境条件下的最优代谢通量分布。化学计量矩阵 $S$、通量界限和目标函数都已明确定义，不存在内部矛盾或违反科学原理之处。\n\n该方法的核心是将关于细胞目标的生物学假设转化为数学优化问题。细胞的代谢网络在稳态假设下被建模为一个线性方程组 $S v = 0$，其中 $S$ 是化学计量矩阵，$v$ 是代谢通量向量。该系统通常是欠定的，从而形成一个可行通量分布的空间。FBA通过最大化或最小化一个给定的线性目标函数 $Z = c^T v$，在该空间中识别出单一的最优通量分布，同时受制于稳态约束以及对单个通量的物理化学约束（例如，热力学不可逆性和营养物可用性），这些约束表示为界限 $v_{lb} \\le v \\le v_{ub}$。\n\n对于由摄取界限和目标参数元组 $(C_{\\max}, O_{\\max}, N_{\\max}, \\alpha, \\beta)$ 定义的每个测试用例，将执行一个三步计算过程。\n\n1.  **最大化生长速率（$v_6^{\\max}$）**：第一步是确定最大可能的生物质生成速率，由通量 $v_6$ 表示。这是一个典型的FBA问题，常用于模拟在最低培养基中的生长，此时生物体的主要目标是尽可能快地增殖。其被构造成如下的LP问题：\n    $$\n    \\begin{array}{ll}\n    \\text{maximize}  Z_1 = v_6 \\\\\n    \\text{subject to}  S v = 0 \\\\\n     0 \\le v_1 \\le C_{\\max} \\\\\n     0 \\le v_2 \\le O_{\\max} \\\\\n     0 \\le v_3 \\le N_{\\max} \\\\\n     0 \\le v_j \\le 1000 \\quad \\text{for } j \\in \\{4, 5, 6, 7, 8\\}\n    \\end{array}\n    $$\n    这等同于最小化 $-v_6$，因此目标向量 $c$ 为 $[0, 0, 0, 0, 0, -1, 0, 0]^T$。该问题的解产生最大生长速率 $v_6^{\\max}$。\n\n2.  **为次最大生长最小化碳摄取**：第二步模拟了细胞旨在提高资源效率的情景，这在丰富培养基中具有现实意义。它计算维持至少为理论最大值特定分数 $\\alpha$ 的生长速率所需的最小碳摄取量 $v_1$。约束 $v_6 \\ge \\alpha \\cdot v_6^{\\max}$ 被添加到模型中。这被构造成一个新的LP问题：\n    $$\n    \\begin{array}{ll}\n    \\text{minimize}  Z_2 = v_1 \\\\\n    \\text{subject to}  S v = 0 \\\\\n     v_6 \\ge \\alpha \\cdot v_6^{\\max} \\\\\n     \\text{and all original flux bounds.}\n    \\end{array}\n    $$\n    这个最小化问题的目标向量 $c$ 是 $[1, 0, 0, 0, 0, 0, 0, 0]^T$。对 $v_6$ 的新约束通过调整其下界来处理。\n\n3.  **在保证生存力的情况下最大化产物合成**：第三步模拟了一个生物工程目标：最大化有价值产物（$v_7$）的合成，同时确保细胞保持存活。生存力被定义为维持一个不低于最大值特定分数 $\\beta$ 的生长速率，即 $v_6 \\ge \\beta \\cdot v_6^{\\max}$。这种生长与生产之间的权衡是代谢工程中的一个经典问题。其LP构成为：\n    $$\n    \\begin{array}{ll}\n    \\text{maximize}  Z_3 = v_7 \\\\\n    \\text{subject to}  S v = 0 \\\\\n     v_6 \\ge \\beta \\cdot v_6^{\\max} \\\\\n     \\text{and all original flux bounds.}\n    \\end{array}\n    $$\n    为求解此最大化问题，我们最小化 $-v_7$，将目标向量 $c$ 设为 $[0, 0, 0, 0, 0, 0, -1, 0]^T$。\n\n这一系列优化被系统地应用于每个测试用例。该实现使用了来自 `scipy.optimize` 库的 `linprog` 函数，这是一个用于解决线性规划问题的稳健工具。化学计量矩阵 $S$ 表示为等式约束矩阵 `A_eq`，相应的 `b_eq` 向量全为零。通量界限，包括对 $v_6$ 的动态调整界限，通过 `bounds` 参数传递。每个测试用例的三个步骤的结果被收集起来，并格式化为指定的输出结构。", "answer": "```python\nimport numpy as np\nfrom scipy.optimize import linprog\n\ndef solve():\n    \"\"\"\n    Solves a series of Flux Balance Analysis (FBA) problems for a toy metabolic network.\n\n    For each test case, the function performs a three-step optimization:\n    1. Maximizes the biomass flux (v6) to find the theoretical maximum growth rate.\n    2. Minimizes carbon uptake (v1) while maintaining growth at a certain percentage of the maximum.\n    3. Maximizes product synthesis (v7) while maintaining a baseline viability growth rate.\n    \"\"\"\n\n    # The stoichiometric matrix S, where rows correspond to metabolites (C, O, N, A, W)\n    # and columns correspond to fluxes (v1 to v8).\n    S = np.array([\n        [1, 0, 0, -1, -1, -1, -2, 0],  # C: Carbon balance\n        [0, 1, 0, -1,  0,  0,  0, 0],  # O: Oxygen balance\n        [0, 0, 1,  0,  0, -1,  0, 0],  # N: Nitrogen balance\n        [0, 0, 0,  4,  1, -2, -1, 0],  # A: ATP balance\n        [0, 0, 0,  1,  1,  0,  0, -1]   # W: Waste balance\n    ], dtype=float)\n\n    # The steady-state condition Sv = 0 implies the right-hand side is a vector of zeros.\n    b_eq = np.zeros(S.shape[0])\n\n    # Upper bound for internal reaction fluxes.\n    v_internal_max = 1000.0\n\n    # Test suite: (C_max, O_max, N_max, alpha, beta)\n    test_cases = [\n        (10.0, 15.0, 5.0, 0.9, 0.2),   # Minimal media, N-limited\n        (100.0, 100.0, 100.0, 0.9, 0.2), # Rich media\n        (10.0, 0.0, 5.0, 0.9, 0.2),     # Anaerobic, C-limited\n        (4.0, 100.0, 100.0, 0.9, 0.2)      # Carbon-limited\n    ]\n\n    all_results_formatted = []\n\n    for case in test_cases:\n        C_max, O_max, N_max, alpha, beta = case\n\n        # --- Step 1: Maximize growth rate (v6) ---\n        # Objective function to maximize v6 is equivalent to minimizing -v6.\n        c_v6_max = np.array([0, 0, 0, 0, 0, -1, 0, 0], dtype=float)\n        \n        # Base flux bounds for this test case.\n        bounds_base = [\n            (0, C_max), (0, O_max), (0, N_max),\n            (0, v_internal_max), (0, v_internal_max), (0, v_internal_max),\n            (0, v_internal_max), (0, v_internal_max)\n        ]\n        \n        res1 = linprog(c_v6_max, A_eq=S, b_eq=b_eq, bounds=bounds_base, method='highs')\n        \n        v6_max = res1.x[5] if res1.success else 0.0\n\n        # --- Step 2: Minimize carbon uptake (v1) for a target growth rate ---\n        # Objective function to minimize v1.\n        c_v1_min = np.array([1, 0, 0, 0, 0, 0, 0, 0], dtype=float)\n        \n        # New constraint: v6 >= alpha * v6_max\n        v6_min_for_v1_opt = alpha * v6_max\n        bounds_for_v1_opt = list(bounds_base)\n        bounds_for_v1_opt[5] = (v6_min_for_v1_opt, v_internal_max)\n        \n        res2 = linprog(c_v1_min, A_eq=S, b_eq=b_eq, bounds=bounds_for_v1_opt, method='highs')\n        \n        v1_min = res2.x[0] if res2.success else float('nan')\n\n        # --- Step 3: Maximize product synthesis (v7) for a viability growth rate ---\n        # Objective function to maximize v7 is equivalent to minimizing -v7.\n        c_v7_max = np.array([0, 0, 0, 0, 0, 0, -1, 0], dtype=float)\n\n        # New constraint: v6 >= beta * v6_max\n        v6_min_for_v7_opt = beta * v6_max\n        bounds_for_v7_opt = list(bounds_base)\n        bounds_for_v7_opt[5] = (v6_min_for_v7_opt, v_internal_max)\n\n        res3 = linprog(c_v7_max, A_eq=S, b_eq=b_eq, bounds=bounds_for_v7_opt, method='highs')\n        \n        v7_max = res3.x[6] if res3.success else 0.0\n\n        # Collect results for the current case.\n        case_results = [v6_max, v1_min, v7_max]\n        \n        # Format the results for this case into the required string format '[f1,f2,f3]'.\n        # Using map and join avoids extra spaces from `str(list)`.\n        formatted_case_str = f\"[{','.join(map(str, case_results))}]\"\n        all_results_formatted.append(formatted_case_str)\n\n    # Print the final output in the format [[...],[...],...]\n    print(f\"[{','.join(all_results_formatted)}]\")\n\nsolve()\n```", "id": "3292204"}]}