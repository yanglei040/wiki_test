{"hands_on_practices": [{"introduction": "在基因表达分析中，一个最基础但也最关键的决策是如何衡量样本或基因之间的“距离”。这个选择直接影响聚类结果。本练习将通过一个具体的计算任务，让您亲身体验两种常用方法——原始欧氏距离和基于z-score标准化的余弦相似度——如何对样本的相似性评估产生截然不同的影响。通过这个实践，您将深刻理解为何在关注表达谱“形状”而非“绝对值”时，标准化和相关性度量是必不可少的。[@problem_id:3295705]", "problem": "一个实验室对 $4$ 个样本中的 $6$ 个基因进行了基因表达分析，得到了以下人工合成但生物学上合理的数据集，其数值以每百万转录本 (TPM) 为单位。设样本表示为 $S_{1}, S_{2}, S_{3}, S_{4}$，基因表示为 $G_{1}, \\dots, G_{6}$。测量值如下：\n- $G_{1}$：$S_{1}=100$, $S_{2}=150$, $S_{3}=95$, $S_{4}=60$\n- $G_{2}$：$S_{1}=50$, $S_{2}=75$, $S_{3}=49$, $S_{4}=30$\n- $G_{3}$：$S_{1}=10$, $S_{2}=15$, $S_{3}=12$, $S_{4}=8$\n- $G_{4}$：$S_{1}=5$, $S_{2}=8$, $S_{3}=4$, $S_{4}=7$\n- $G_{5}$：$S_{1}=200$, $S_{2}=290$, $S_{3}=210$, $S_{4}=170$\n- $G_{6}$：$S_{1}=100$, $S_{2}=155$, $S_{3}=90$, $S_{4}=120$\n\n你将比较样本邻域在表达谱聚类中常用的两种度量标准下的情况：原始数据上的原始欧几里得距离，以及基因层面 $z$-score 化后计算的余弦相似度。\n\n你的推理和计算应仅基于以下核心定义。\n- 对于表达向量为 $\\mathbf{x}_{i}, \\mathbf{x}_{j} \\in \\mathbb{R}^{6}$ 的两个样本 $S_{i}$ 和 $S_{j}$ 之间的原始欧几里得距离，使用 $d_{E}(i,j) = \\|\\mathbf{x}_{i} - \\mathbf{x}_{j}\\|_{2} = \\sqrt{\\sum_{g=1}^{6} (x_{gi} - x_{gj})^{2}}$。\n- 对于基因层面的 $z$-score 化，对每个基因 $g$ 在 $n=4$ 个样本中的值，计算总体均值 $\\mu_{g} = \\frac{1}{n}\\sum_{s=1}^{n} x_{gs}$ 和总体标准差 $\\sigma_{g} = \\sqrt{\\frac{1}{n}\\sum_{s=1}^{n} (x_{gs}-\\mu_{g})^{2}}$，然后将 $x_{gs}$ 转换为 $z_{gs} = \\frac{x_{gs} - \\mu_{g}}{\\sigma_{g}}$。\n- 对于两个经过 $z$-score 化的样本向量 $\\mathbf{z}_{i}, \\mathbf{z}_{j} \\in \\mathbb{R}^{6}$ 之间的余弦相似度，使用 $\\cos(i,j) = \\frac{\\mathbf{z}_{i}^{\\top}\\mathbf{z}_{j}}{\\|\\mathbf{z}_{i}\\|_{2}\\,\\|\\mathbf{z}_{j}\\|_{2}}$。\n\n按以下步骤进行。\n1. 计算样本间的所有成对原始欧几里得距离 $d_{E}(i,j)$，并且，对于每个样本 $S_{i}$，确定其在 $d_{E}$ 度量下的最近邻为最小化 $d_{E}(i,j)$ 的不同样本 $S_{j}$。\n2. 对这 $4$ 个样本进行基因层面的 $z$-score 化，以获得所有基因和样本的 $z_{gs}$ 值。计算经过 $z$-score 化的样本向量之间的所有成对余弦相似度 $\\cos(i,j)$，并且，对于每个样本 $S_{i}$，确定其在余弦相似度下的最近邻为最大化 $\\cos(i,j)$ 的不同样本 $S_{j}$。\n3. 设 $\\Delta$ 为这样一个样本的比例（以小数表示）：这些样本在余弦相似度下的最近邻与在原始欧几里得距离下的最近邻不同。\n\n$\\Delta$ 的值是多少？将你的最终答案表示为单个小数。如果需要四舍五入，将最终结果保留四位有效数字；否则，提供精确值。", "solution": "该问题要求比较 $4$ 个基因表达样本在两种不同度量标准下的最近邻：原始欧几里得距离和 $z$-score 化数据上的余弦相似度。我们将首先验证问题，然后按要求分三个不同步骤进行计算。\n\n### 问题验证\n**第一步：提取已知条件**\n- 数据：一个 $6 \\times 4$ 的基因表达值矩阵（单位为TPM），包含 $6$ 个基因（$G_1, \\dots, G_6$）和 $4$ 个样本（$S_1, \\dots, S_4$）。\n  - $G_{1}$：$S_{1}=100$, $S_{2}=150$, $S_{3}=95$, $S_{4}=60$\n  - $G_{2}$：$S_{1}=50$, $S_{2}=75$, $S_{3}=49$, $S_{4}=30$\n  - $G_{3}$：$S_{1}=10$, $S_{2}=15$, $S_{3}=12$, $S_{4}=8$\n  - $G_{4}$：$S_{1}=5$, $S_{2}=8$, $S_{3}=4$, $S_{4}=7$\n  - $G_{5}$：$S_{1}=200$, $S_{2}=290$, $S_{3}=210$, $S_{4}=170$\n  - $G_{6}$：$S_{1}=100$, $S_{2}=155$, $S_{3}=90$, $S_{4}=120$\n- 定义：\n  - 原始欧几里得距离：$d_{E}(i,j) = \\|\\mathbf{x}_{i} - \\mathbf{x}_{j}\\|_{2} = \\sqrt{\\sum_{g=1}^{6} (x_{gi} - x_{gj})^{2}}$。\n  - 基因层面 $z$-score 化：对每个基因 $g$，使用总体均值 $\\mu_{g} = \\frac{1}{n}\\sum_{s=1}^{n} x_{gs}$ 和总体标准差 $\\sigma_{g} = \\sqrt{\\frac{1}{n}\\sum_{s=1}^{n} (x_{gs}-\\mu_{g})^{2}}$，其中 $n=4$。转换后的值为 $z_{gs} = \\frac{x_{gs} - \\mu_{g}}{\\sigma_{g}}$。\n  - 余弦相似度：$\\cos(i,j) = \\frac{\\mathbf{z}_{i}^{\\top}\\mathbf{z}_{j}}{\\|\\mathbf{z}_{i}\\|_{2}\\,\\|\\mathbf{z}_{j}\\|_{2}}$。\n- 任务：\n  1. 在 $d_E$ 度量下找到每个样本的最近邻。\n  2. 在余弦相似度下找到每个样本的最近邻（最大化其值）。\n  3. 计算 $\\Delta$，即在这两种度量标准下最近邻发生变化的样本比例。\n\n**第二步：使用提取的已知条件进行验证**\n该问题具有科学依据，使用了计算生物学的标准方法。定义精确无歧义，使得问题定义良好。尽管在真实世界的分析中，对小样本使用总体标准差公式可能会有争议，但在此处已明确定义，因此它是一个自洽有效问题的一部分。该问题是客观且完整的。\n\n**第三步：结论与行动**\n问题有效。我将继续进行解答。\n\n### 第一步：原始欧几里得距离与最近邻\n设样本向量为 $\\mathbf{x}_1, \\mathbf{x}_2, \\mathbf{x}_3, \\mathbf{x}_4$，它们是数据矩阵的列。\n$\\mathbf{x}_1 = (100, 50, 10, 5, 200, 100)^{\\top}$\n$\\mathbf{x}_2 = (150, 75, 15, 8, 290, 155)^{\\top}$\n$\\mathbf{x}_3 = (95, 49, 12, 4, 210, 90)^{\\top}$\n$\\mathbf{x}_4 = (60, 30, 8, 7, 170, 120)^{\\top}$\n\n我们计算平方欧几里得距离 $d_E^2(i,j) = \\sum_{g=1}^{6} (x_{gi} - x_{gj})^{2}$，对于所有 $i \\neq j$ 的配对。\n\n$d_E^2(1, 2) = (100-150)^2 + (50-75)^2 + (10-15)^2 + (5-8)^2 + (200-290)^2 + (100-155)^2 = (-50)^2 + (-25)^2 + (-5)^2 + (-3)^2 + (-90)^2 + (-55)^2 = 2500 + 625 + 25 + 9 + 8100 + 3025 = 14284$。\n\n$d_E^2(1, 3) = (100-95)^2 + (50-49)^2 + (10-12)^2 + (5-4)^2 + (200-210)^2 + (100-90)^2 = 5^2 + 1^2 + (-2)^2 + 1^2 + (-10)^2 + 10^2 = 25 + 1 + 4 + 1 + 100 + 100 = 231$。\n\n$d_E^2(1, 4) = (100-60)^2 + (50-30)^2 + (10-8)^2 + (5-7)^2 + (200-170)^2 + (100-120)^2 = 40^2 + 20^2 + 2^2 + (-2)^2 + 30^2 + (-20)^2 = 1600 + 400 + 4 + 4 + 900 + 400 = 3308$。\n\n$d_E^2(2, 3) = (150-95)^2 + (75-49)^2 + (15-12)^2 + (8-4)^2 + (290-210)^2 + (155-90)^2 = 55^2 + 26^2 + 3^2 + 4^2 + 80^2 + 65^2 = 3025 + 676 + 9 + 16 + 6400 + 4225 = 14351$。\n\n$d_E^2(2, 4) = (150-60)^2 + (75-30)^2 + (15-8)^2 + (8-7)^2 + (290-170)^2 + (155-120)^2 = 90^2 + 45^2 + 7^2 + 1^2 + 120^2 + 35^2 = 8100 + 2025 + 49 + 1 + 14400 + 1225 = 25800$。\n\n$d_E^2(3, 4) = (95-60)^2 + (49-30)^2 + (12-8)^2 + (4-7)^2 + (210-170)^2 + (90-120)^2 = 35^2 + 19^2 + 4^2 + (-3)^2 + 40^2 + (-30)^2 = 1225 + 361 + 16 + 9 + 1600 + 900 = 4111$。\n\n对于每个样本 $S_i$，其最近邻是使 $d_E(i,j)$ 最小化的样本 $S_j$，这等同于最小化 $d_E^2(i,j)$。\n- 对于 $S_1$：$\\min(d_E^2(1,2), d_E^2(1,3), d_E^2(1,4)) = \\min(14284, 231, 3308) = 231$。最近邻是 $S_3$。\n- 对于 $S_2$：$\\min(d_E^2(2,1), d_E^2(2,3), d_E^2(2,4)) = \\min(14284, 14351, 25800) = 14284$。最近邻是 $S_1$。\n- 对于 $S_3$：$\\min(d_E^2(3,1), d_E^2(3,2), d_E^2(3,4)) = \\min(231, 14351, 4111) = 231$。最近邻是 $S_1$。\n- 对于 $S_4$：$\\min(d_E^2(4,1), d_E^2(4,2), d_E^2(4,3)) = \\min(3308, 25800, 4111) = 3308$。最近邻是 $S_1$。\n\n在原始欧几里得距离下的最近邻（$NN_E$）是：\n$NN_E(S_1) = S_3$，$NN_E(S_2) = S_1$，$NN_E(S_3) = S_1$，$NN_E(S_4) = S_1$。\n\n### 第二步：余弦相似度与最近邻\n首先，我们进行基因层面的 $z$-score 化。对于每个基因 $g$，我们计算它在 $4$ 个样本中的均值 $\\mu_g$ 和总体标准差 $\\sigma_g$。\n$G_1: \\mu_1 = 101.25, \\sigma_1^2 = 1029.6875$\n$G_2: \\mu_2 = 51, \\sigma_2^2 = 255.5$\n$G_3: \\mu_3 = 11.25, \\sigma_3^2 = 6.6875$\n$G_4: \\mu_4 = 6, \\sigma_4^2 = 2.5$\n$G_5: \\mu_5 = 217.5, \\sigma_5^2 = 1968.75$\n$G_6: \\mu_6 = 116.25, \\sigma_6^2 = 617.1875$\n\n我们为每个样本计算 $z$-score 化的向量 $\\mathbf{z}_i$。其分量为 $z_{gs} = (x_{gs} - \\mu_g) / \\sigma_g$。得到的 $z$-score 矩阵 $Z$ 如下：\n$$\nZ =\n\\begin{pmatrix}\n-0.03895   1.51918  -0.19477  -1.28546 \\\\\n-0.06256   1.50148  -0.12512  -1.31380 \\\\\n-0.48337   1.44971   0.28994  -1.25678 \\\\\n-0.63246   1.26491  -1.26491   0.63246 \\\\\n-0.39442   1.63403  -0.16904  -1.07057 \\\\\n-0.65410   1.55982  -1.05663   0.15091\n\\end{pmatrix}\n$$\n样本向量 $\\mathbf{z}_1, \\mathbf{z}_2, \\mathbf{z}_3, \\mathbf{z}_4$ 是该矩阵的列。我们计算成对的余弦相似度 $\\cos(i,j) = \\frac{\\mathbf{z}_i \\cdot \\mathbf{z}_j}{\\|\\mathbf{z}_i\\| \\|\\mathbf{z}_j\\|}$。\n\n首先，我们计算平方范数 $\\|\\mathbf{z}_i\\|^2_2 = \\sum_{g=1}^6 z_{gi}^2$：\n$\\|\\mathbf{z}_1\\|^2 = 1.2225$，所以 $\\|\\mathbf{z}_1\\| = 1.1057$\n$\\|\\mathbf{z}_2\\|^2 = 13.3679$，所以 $\\|\\mathbf{z}_2\\| = 3.6562$\n$\\|\\mathbf{z}_3\\|^2 = 2.8827$，所以 $\\|\\mathbf{z}_3\\| = 1.6979$\n$\\|\\mathbf{z}_4\\|^2 = 6.5258$，所以 $\\|\\mathbf{z}_4\\| = 2.5546$\n\n接下来，我们计算点积 $\\mathbf{z}_i \\cdot \\mathbf{z}_j = \\sum_{g=1}^6 z_{gi} z_{gj}$：\n$\\mathbf{z}_1 \\cdot \\mathbf{z}_2 = -3.3188$\n$\\mathbf{z}_1 \\cdot \\mathbf{z}_3 = 1.4330$\n$\\mathbf{z}_1 \\cdot \\mathbf{z}_4 = 0.6632$\n$\\mathbf{z}_2 \\cdot \\mathbf{z}_3 = -3.5875$\n$\\mathbf{z}_2 \\cdot \\mathbf{z}_4 = -6.4627$\n$\\mathbf{z}_3 \\cdot \\mathbf{z}_4 = -0.7283$\n\n最后，我们计算余弦相似度：\n$\\cos(1, 2) = \\frac{-3.3188}{(1.1057)(3.6562)} \\approx -0.8210$\n$\\cos(1, 3) = \\frac{1.4330}{(1.1057)(1.6979)} \\approx 0.7634$\n$\\cos(1, 4) = \\frac{0.6632}{(1.1057)(2.5546)} \\approx 0.2348$\n$\\cos(2, 3) = \\frac{-3.5875}{(3.6562)(1.6979)} \\approx -0.5779$\n$\\cos(2, 4) = \\frac{-6.4627}{(3.6562)(2.5546)} \\approx -0.6919$\n$\\cos(3, 4) = \\frac{-0.7283}{(1.6979)(2.5546)} \\approx -0.1679$\n\n$S_i$ 的最近邻是使 $\\cos(i,j)$ 最大化的样本 $S_j$。\n- 对于 $S_1$：$\\max(\\cos(1,2), \\cos(1,3), \\cos(1,4)) = \\max(-0.8210, 0.7634, 0.2348) = 0.7634$。最近邻是 $S_3$。\n- 对于 $S_2$：$\\max(\\cos(2,1), \\cos(2,3), \\cos(2,4)) = \\max(-0.8210, -0.5779, -0.6919) = -0.5779$。最近邻是 $S_3$。\n- 对于 $S_3$：$\\max(\\cos(3,1), \\cos(3,2), \\cos(3,4)) = \\max(0.7634, -0.5779, -0.1679) = 0.7634$。最近邻是 $S_1$。\n- 对于 $S_4$：$\\max(\\cos(4,1), \\cos(4,2), \\cos(4,3)) = \\max(0.2348, -0.6919, -0.1679) = 0.2348$。最近邻是 $S_1$。\n\n在余弦相似度下的最近邻（$NN_{cos}$）是：\n$NN_{cos}(S_1) = S_3$，$NN_{cos}(S_2) = S_3$，$NN_{cos}(S_3) = S_1$，$NN_{cos}(S_4) = S_1$。\n\n### 第三步：比较与计算 $\\Delta$\n我们比较第一步和第二步中找到的最近邻。\n\n| 样本 | $NN_E$ | $NN_{cos}$ | 最近邻是否改变？ |\n|---|---|---|---|\n| $S_1$ | $S_3$ | $S_3$ | 否 |\n| $S_2$ | $S_1$ | $S_3$ | 是 |\n| $S_3$ | $S_1$ | $S_1$ | 否 |\n| $S_4$ | $S_1$ | $S_1$ | 否 |\n\n在 $4$ 个样本中，当度量标准从原始欧几里得距离变为 $z$-score 化数据上的余弦相似度时，只有 $S_2$ 的最近邻不同。\n最近邻不同的样本数量为 $1$。\n样本总数为 $4$。\n比例 $\\Delta$ 是这两个数的比值。\n$$\n\\Delta = \\frac{1}{4} = 0.25\n$$", "answer": "$$\\boxed{0.25}$$", "id": "3295705"}, {"introduction": "运行层次聚类后，我们得到一个树状图（dendrogram），但下一个问题是：应该将其切割成多少个簇（cluster）才最合理？一个好的聚类结果应该是“内部紧密，外部疏远”。本练习将指导您使用一种强大的内部验证指标——轮廓系数（silhouette width）——来量化评估不同聚类方案的质量。您将学会如何通过计算和比较不同 $k$ 值下的平均轮廓系数，从而以数据驱动的方式，而非主观判断，来确定最佳的聚类数量。[@problem_id:3295659]", "problem": "给定在 $2$ 个条件下测量的 $6$ 个基因的表达谱，表示为 $\\mathbb{R}^2$ 中的点。设基因表达向量为\n$G_1=(0,0)$, $G_2=\\left(\\frac{1}{5},\\frac{1}{10}\\right)$, $G_3=\\left(5,\\frac{51}{10}\\right)$, $G_4=\\left(\\frac{51}{10},\\frac{49}{10}\\right)$, $G_5=(10,0)$, $G_6=\\left(\\frac{51}{5},-\\frac{1}{10}\\right)$。\n所有两两之间的相异度均为欧几里得距离。使用非加权组平均法（UPGMA，平均连锁）进行层次凝聚聚类。生成的树状图按以下顺序和指定的合并高度合并簇（相等情况按所示顺序处理）：\n$1)$ 在高度 $h_{\\mathrm{pair}}=\\sqrt{\\frac{1}{20}}=\\frac{1}{2\\sqrt{5}}$ 合并 $\\{G_1\\}$ 和 $\\{G_2\\}$，\n$2)$ 在高度 $h_{\\mathrm{pair}}$ 合并 $\\{G_3\\}$ 和 $\\{G_4\\}$，\n$3)$ 在高度 $h_{\\mathrm{pair}}$ 合并 $\\{G_5\\}$ 和 $\\{G_6\\}$，\n$4)$ 在高度\n$$h_2=\\frac{1}{40}\\Big(\\sqrt{5101}+\\sqrt{5002}+2\\sqrt{1201}+\\sqrt{4705}\\Big)$$\n合并 $\\{G_1,G_2\\}$ 和 $\\{G_3,G_4\\}$，\n$5)$ 在高度\n$$h_3=\\frac{1}{2}\\left(\\frac{5}{2}+\\frac{1}{40}\\big(\\sqrt{10405}+\\sqrt{9605}+2\\sqrt{2501}\\big)+\\frac{1}{20}\\sqrt{5101}+\\frac{101}{40}\\sqrt{2}\\right)$$\n合并 $\\{G_1,G_2,G_3,G_4\\}$ 和 $\\{G_5,G_6\\}$。\n您将评估产生 $k\\in\\{2,3,4\\}$ 个簇的切割的平均轮廓宽度。使用观测值 $i$ 的标准轮廓系数定义，\n$$s(i)=\\frac{b(i)-a(i)}{\\max\\{a(i),b(i)\\}},$$\n其中 $a(i)$ 是 $i$ 与其所在簇的所有其他成员的平均相异度，而 $b(i)$ 是 $i$ 到其他簇成员的平均相異度的最小值（在所有其他簇中取）。遵循一个通用约定，如果 $i$ 所在的簇大小为 $1$，则 $a(i)=0$ 且 $s(i)=0$。\n使用 $G_1,\\dots,G_6$ 之间的原始两两距离，计算在每次切割下对于 $k\\in\\{2,3,4\\}$ 的平均轮廓宽度，然后选择使平均轮廓宽度最大化的切割，并定量地证明该选择的合理性。将最佳簇数 $k^{\\star}$ 以整数形式报告。最终答案无需四舍五入。", "solution": "用户提供了一个问题，要求通过计算不同簇数 $k$ 下的平均轮廓宽度来验证聚类结果。最终目标是确定使该指标最大化的最佳簇数 $k^{\\star}$。\n\n### 第一步：问题验证\n\n首先，我们必须仔细验证问题陈述。\n\n#### 第1.1步：提取给定条件\n给定的数据点是 $\\mathbb{R}^2$ 中的六个基因表达向量：\n$G_1=(0,0)$, $G_2=\\left(\\frac{1}{5},\\frac{1}{10}\\right)$, $G_3=\\left(5,\\frac{51}{10}\\right)$, $G_4=\\left(\\frac{51}{10},\\frac{49}{10}\\right)$, $G_5=(10,0)$, $G_6=\\left(\\frac{51}{5},-\\frac{1}{10}\\right)$。\n\n相异度度量是欧几里得距离 $d(G_i, G_j)$。\n聚类方法是使用 UPGMA（平均连锁）的层次凝聚聚类。\n合并顺序如下：\n1. 在高度 $h_{\\mathrm{pair}}=\\sqrt{\\frac{1}{20}}$ 合并 $\\{G_1\\}, \\{G_2\\}$。\n2. 在高度 $h_{\\mathrm{pair}}$ 合并 $\\{G_3\\}, \\{G_4\\}$。\n3. 在高度 $h_{\\mathrm{pair}}$ 合并 $\\{G_5\\}, \\{G_6\\}$。\n4. 在高度 $h_2=\\frac{1}{40}\\Big(\\sqrt{5101}+\\sqrt{5002}+2\\sqrt{1201}+\\sqrt{4705}\\Big)$ 合并 $\\{G_1, G_2\\}, \\{G_3, G_4\\}$。\n5. 在高度 $h_3=\\frac{1}{2}\\left(\\frac{5}{2}+\\frac{1}{40}\\big(\\sqrt{10405}+\\sqrt{9605}+2\\sqrt{2501}\\big)+\\frac{1}{20}\\sqrt{5101}+\\frac{101}{40}\\sqrt{2}\\right)$ 合并 $\\{G_1, G_2, G_3, G_4\\}, \\{G_5, G_6\\}$。\n\n观测值 $i$ 的轮廓系数为 $s(i)=\\frac{b(i)-a(i)}{\\max\\{a(i),b(i)\\}}$，其中 $a(i)$ 是 $i$ 与其自身簇成员的平均相异度，$b(i)$ 是 $i$ 到其他簇的平均相异度的最小值。如果包含 $i$ 的簇大小为 $1$，则 $a(i)=0$ 且 $s(i)=0$。\n\n任务是找到使平均轮廓宽度最大化的最佳簇数 $k^{\\star} \\in \\{2, 3, 4\\}$。\n\n#### 第1.2步：使用提取的已知条件进行验证\n该问题在计算生物学中有科学依据，并且是客观陈述的。需要验证的关键点是其内部一致性：所提供的 UPGMA 层次结构是否与给定的数据点正确对应？\n\n两个簇 $C_A$ 和 $C_B$ 之间的 UPGMA 距离是其成员之间所有两两距离的平均值：$d(C_A, C_B) = \\frac{1}{|C_A||C_B|} \\sum_{i \\in C_A, j \\in C_B} d(G_i, G_j)$。对于两个单点簇 $\\{G_i\\}$ 和 $\\{G_j\\}$，这便是 $d(G_i, G_j)$。\n\n让我们验证在高度 $h_{\\mathrm{pair}}$ 的初始合并：\n$d(G_1,G_2)^2 = (\\frac{1}{5}-0)^2 + (\\frac{1}{10}-0)^2 = \\frac{1}{25} + \\frac{1}{100} = \\frac{4+1}{100} = \\frac{5}{100} = \\frac{1}{20}$。因此，$d(G_1,G_2) = \\sqrt{\\frac{1}{20}}$。\n$d(G_3,G_4)^2 = (\\frac{51}{10}-5)^2 + (\\frac{49}{10}-\\frac{51}{10})^2 = (\\frac{1}{10})^2 + (-\\frac{2}{10})^2 = \\frac{1}{100} + \\frac{4}{100} = \\frac{5}{100} = \\frac{1}{20}$。因此，$d(G_3,G_4) = \\sqrt{\\frac{1}{20}}$。\n$d(G_5,G_6)^2 = (\\frac{51}{5}-10)^2 + (-\\frac{1}{10}-0)^2 = (\\frac{1}{5})^2 + (-\\frac{1}{10})^2 = \\frac{1}{25} + \\frac{1}{100} = \\frac{1}{20}$。因此，$d(G_5,G_6) = \\sqrt{\\frac{1}{20}}$。\n前三个在高度 $h_{\\mathrm{pair}} = \\sqrt{1/20}$ 的合并与数据一致。\n\n接下来，我们验证簇 $C_{12}=\\{G_1, G_2\\}$ 和 $C_{34}=\\{G_3, G_4\\}$ 的合并高度 $h_2$。\n$h_2 = d(C_{12}, C_{34}) = \\frac{1}{4}(d(G_1,G_3) + d(G_1,G_4) + d(G_2,G_3) + d(G_2,G_4))$。\n所需的距离平方是：\n$d(G_1,G_3)^2 = 5^2 + (\\frac{51}{10})^2 = 25 + \\frac{2601}{100} = \\frac{5101}{100}$。\n$d(G_1,G_4)^2 = (\\frac{51}{10})^2 + (\\frac{49}{10})^2 = \\frac{2601+2401}{100} = \\frac{5002}{100}$。\n$d(G_2,G_3)^2 = (5-\\frac{1}{5})^2 + (\\frac{51}{10}-\\frac{1}{10})^2 = (\\frac{24}{5})^2 + 5^2 = \\frac{576}{25}+25 = \\frac{576+625}{25} = \\frac{1201}{25}$。因此 $d(G_2,G_3) = \\frac{\\sqrt{1201}}{5} = \\frac{2\\sqrt{1201}}{10}$。\n$d(G_2,G_4)^2 = (\\frac{51}{10}-\\frac{1}{5})^2 + (\\frac{49}{10}-\\frac{1}{10})^2 = (\\frac{49}{10})^2 + (\\frac{48}{10})^2 = \\frac{2401+2304}{100} = \\frac{4705}{100}$。\n将距离求和并取平均：\n$h_2 = \\frac{1}{4}\\left(\\frac{\\sqrt{5101}}{10} + \\frac{\\sqrt{5002}}{10} + \\frac{2\\sqrt{1201}}{10} + \\frac{\\sqrt{4705}}{10}\\right) = \\frac{1}{40}(\\sqrt{5101}+\\sqrt{5002}+2\\sqrt{1201}+\\sqrt{4705})$，这与问题陈述相符。问题看起来内部一致。一个类似但更繁琐的验证表明 $h_3$ 也是正确的。\n\n#### 第1.3步：结论与行动\n该问题定义明确、客观、科学上合理且内部一致。这是一个有效的问题。我们着手解决它。\n\n### 第二步：求解\n\n层次聚类定义了一组嵌套划分。在不同层次上切割树状图会产生不同数量的簇。对应于 $k \\in \\{2, 3, 4\\}$ 的划分是通过在剩下 $k$ 个簇的步骤停止凝聚过程来确定的。\n- 对于 $k=4$，在第二次合并后，簇为 $\\{G_1, G_2\\}, \\{G_3, G_4\\}, \\{G_5\\}, \\{G_6\\}$。但是，问题中描述的合并顺序意味着在第三次合并后我们有三个簇，因此 $k=4$ 应该是前两次合并之后的情况，即 $\\{G_1, G_2\\}, \\{G_3, G_4\\}, \\{G_5\\}, \\{G_6\\}$。然而，由于前三次合并发生在相同的高度，它们可以看作是同时发生的。因此，在 $h_{pair}$ 之后，我们从6个簇变为3个簇。所以，没有一个自然的切割点能产生4个簇。但是，我们可以通过在 $h_{pair}$ 之前切割来获得超过3个簇。问题要求我们评估 $k=4$。这可能是指在第一次合并后，我们有 $\\{G_1,G_2\\}$ 和其他4个单点簇。让我们假设一个更合理的切割方案：$k=3$ 在 $h_{pair}$ 和 $h_2$ 之间的任何高度切割树状图；$k=2$ 在 $h_2$ 和 $h_3$ 之间切割。对于 $k=4$，这可能是指一种不那么稳定的划分。最可能的解释是，问题希望我们考虑将其中一个自然对分开的划分。例如 $\\{G_1\\}, \\{G_2\\}, \\{G_3, G_4\\}, \\{G_5, G_6\\}$。这会使分析变得复杂。一个更简单的解释是， problem's merge order is slightly simplified. Let's stick to the problem's stated hierarchy. The hierarchy implies partitions:\n$k=3: C^{(3)}_1=\\{G_1, G_2\\}, C^{(3)}_2=\\{G_3, G_4\\}, C^{(3)}_3=\\{G_5, G_6\\}$\n$k=2: C^{(2)}_1=\\{G_1, G_2, G_3, G_4\\}, C^{(2)}_2=\\{G_5, G_6\\}$\n对于 $k=4$, 如果我们严格遵循树状图的结构，我们不能得到4个簇。然而，如果我们考虑一个略微不同的合并顺序（例如，$d(G_1,G_2)$ 略小于 $d(G_3,G_4)$），那么 $k=4$ 的划分将是 $\\{G_1,G_2\\}, \\{G_3,G_4\\}, \\{G_5\\}, \\{G_6\\}$。让我们以此为基础进行比较。\n\n#### 对 $k=3$ 的分析\n这种聚类对应于三个自然成对的点。\n$C^{(3)}_1=\\{G_1, G_2\\}, C^{(3)}_2=\\{G_3, G_4\\}, C^{(3)}_3=\\{G_5, G_6\\}$。\n让我们分析一个一般点（例如 $G_1 \\in C^{(3)}_1$）的轮廓分数。\n- 簇内相异度： $a_3(1) = d(G_1, G_2) = \\sqrt{1/20} \\approx 0.224$。\n- 簇间相异度： $b_3(1) = \\min\\{d(G_1, C^{(3)}_2), d(G_1, C^{(3)}_3)\\}$。\n  $d(G_1, C^{(3)}_2) = \\frac{1}{2}(d(G_1,G_3)+d(G_1,G_4)) = \\frac{1}{20}(\\sqrt{5101}+\\sqrt{5002}) \\approx 7.1$。\n  $d(G_1, C^{(3)}_3) = \\frac{1}{2}(d(G_1,G_5)+d(G_1,G_6)) = \\frac{1}{2}(10+\\sqrt{104.05}) \\approx 10.1$。\n  所以 $b_3(1) = \\frac{1}{20}(\\sqrt{5101}+\\sqrt{5002}) \\approx 7.1$。\n由于 $b_3(1) \\gg a_3(1)$，轮廓分数 $s_3(1) = \\frac{b_3(1)-a_3(1)}{b_3(1)} = 1 - \\frac{a_3(1)}{b_3(1)}$ 将非常接近 $1$。\n根据点的几何排列，所有六个点都存在类似情况。对于任何点 $G_i$，其簇内距离 $a_3(i)$ 是一个很小的值 $\\sqrt{1/20}$，而其到“相邻”簇的平均距离 $b_3(i)$ 很大。因此，所有六个轮廓分数 $s_3(i)$ 都将是正数且接近 $1$。这表明聚类结构非常强。\n\n#### $k=3$ 和 $k=4$ 的比较\n对于 $k=4$ 的划分 $C^{(4)}_1=\\{G_1, G_2\\}$, $C^{(4)}_2=\\{G_3, G_4\\}$, $C^{(4)}_3=\\{G_5\\}$, $C^{(4)}_4=\\{G_6\\}$。\n- 对于 $i \\in \\{1,2,3,4\\}$，该点自身的簇与 $k=3$ 的情况相同，且最近的邻近簇也相同。例如，对于 $G_1$，$a_4(1) = d(G_1,G_2) = a_3(1)$。\n- 对于 $G_1$，$b_4(1) = \\min\\{d(G_1,C^{(4)}_2), d(G_1,C^{(4)}_3), d(G_1,C^{(4)}_4) \\}$.\n  $d(G_1,C^{(4)}_2) = \\frac{1}{2}(d(G_1,G_3)+d(G_1,G_4)) \\approx 7.1$。\n  $d(G_1,C^{(4)}_3) = d(G_1,G_5)=10$。\n  $d(G_1,C^{(4)}_4) = d(G_1,G_6)=\\sqrt{104.05}\\approx 10.2$。\n  最小值不变：$b_4(1) = d(G_1,C^{(4)}_2) = b_3(1)$。\n  因此，对于 $i \\in \\{1,2,3,4\\}$，我们有 $s_4(i) = s_3(i)$。\n- 对于 $i \\in \\{5,6\\}$，这些点位于单点簇中。根据问题的约定，$s_4(5)=0$ 且 $s_4(6)=0$。\n平均轮廓宽度为：\n$\\bar{S}_3 = \\frac{1}{6} \\left( \\sum_{i=1}^4 s_3(i) + s_3(5) + s_3(6) \\right)$\n$\\bar{S}_4 = \\frac{1}{6} \\left( \\sum_{i=1}^4 s_4(i) + s_4(5) + s_4(6) \\right) = \\frac{1}{6} \\left( \\sum_{i=1}^4 s_3(i) + 0 + 0 \\right)$\n在 $k=3$ 的情况下，$s_3(5)$ 和 $s_3(6)$ 是正数，因为 $\\{G_5,G_6\\}$ 是一个紧凑的簇，远离其他簇。因此，可以严格确定 $\\bar{S}_3 > \\bar{S}_4$。\n\n#### $k=3$ 和 $k=2$ 的比较\n对于 $k=2$ 的划分，簇是 $C^{(2)}_1=\\{G_1,G_2,G_3,G_4\\}$ 和 $C^{(2)}_2=\\{G_5,G_6\\}$。\n让我们分析新合并的簇中的一个点，例如 $G_1 \\in C^{(2)}_1$。\n- 簇内相异度：$a_2(1) = \\frac{1}{3}(d(G_1,G_2) + d(G_1,G_3) + d(G_1,G_4))$。\n  $a_2(1) = \\frac{1}{3}(\\sqrt{1/20} + \\sqrt{51.01} + \\sqrt{50.02}) \\approx \\frac{1}{3}(0.224+7.14+7.07) \\approx 4.81$。\n  这比 $a_3(1) \\approx 0.224$ 有了急剧增加。点 $G_3$ 和 $G_4$ 现在被认为与 $G_1$ “在同一个簇中”，但它们在几何上相距很远。\n- 簇间相异度：$b_2(1) = d(G_1, C^{(2)}_2) = \\frac{1}{2}(d(G_1,G_5)+d(G_1,G_6)) \\approx \\frac{1}{2}(10 + 10.2) \\approx 10.1$。\n轮廓分数为 $s_2(1) = \\frac{b_2(1)-a_2(1)}{b_2(1)} \\approx \\frac{10.1 - 4.81}{10.1} \\approx 0.52$。\n这比 $s_3(1) \\approx 1 - \\frac{0.224}{7.1} \\approx 0.97$ 有了急剧下降。\n对于 $C^{(2)}_1$ 中的所有点（$G_1, G_2, G_3, G_4$），轮廓分数都出现了这种急剧下降，因为合并两个空间上分离的簇 $\\{G_1,G_2\\}$ 和 $\\{G_3,G_4\\}$ 会产生一个内部距离较大的非紧凑簇。\n现在考虑另一个簇中的点，$G_5 \\in C^{(2)}_2$。\n- $a_2(5) = d(G_5,G_6) = \\sqrt{1/20}$。这与 $a_3(5)$ 相同。\n- $b_2(5) = d(G_5, C^{(2)}_1) = \\frac{1}{4}(d_{51}+d_{52}+d_{53}+d_{54})$，这个值会比 $b_3(5)$ 大，因为现在平均到了更多的点上。\n  $b_3(5) = \\min\\{d(G_5,C_1^{(3)}), d(G_5,C_2^{(3)})\\} \\approx \\min\\{9.9, 7.0\\} = 7.0$。\n  $s_2(5)$ 可能略大于 $s_3(5)$。\n然而，对于 $G_1, \\dots, G_4$ 的四个分数的大幅减少远超过了 $G_5, G_6$ 的两个分数的微小增加。因此，对于 $k=2$ 的平均轮廓宽度将显著低于 $k=3$ 的情况。\n因此，我们可以得出结论 $\\bar{S}_2  \\bar{S}_3$。\n\n#### 结论\n我们已经通过定量推理证明了 $\\bar{S}_2  \\bar{S}_3$ 和 $\\bar{S}_4  \\bar{S}_3$。平均轮廓宽度在 $k=3$ 时最大化。这对应于数据在视觉上明显的聚类，即三个不同的点对。最佳簇数是 $k^{\\star}=3$。", "answer": "$$\\boxed{3}$$", "id": "3295659"}, {"introduction": "单一的聚类分析结果可能并不可靠，它可能因算法选择、参数设置或数据的微小扰动而改变。为了获得在生物学上更可信的结论，我们需要识别那些在不同分析条件下都能稳定出现的“鲁棒簇”。本练习将介绍一种高级技术——一致性聚类（consensus clustering）。您将学习如何整合来自多个不同聚类运行的结果，通过构建一个共现矩阵（co-association matrix）并提取其中的强连接部分，来发现核心且稳定的基因群体。[@problem_id:3295668]", "problem": "在计算系统生物学中，评估不同聚类算法多次运行所产生的基因表达谱聚类的稳定性的一种常用方法是，计算共识矩阵 (consensus matrix)，然后从一个阈值化的共识图中提取稳健的聚类作为其连通分量。考虑一个小型基因表达研究，其中有 $n=7$ 个基因，标记为 $g_1,\\dots,g_7$，在 $p$ 种生物条件下进行了分析。假设在同一个标准化表达矩阵上进行了三次独立的聚类运行（$R=3$）：一次是采用平均连锁的凝聚层次聚类，切割成 $k=3$ 个簇；一次是 $k=3$ 的 $k$-均值运行；还有一次是采用 Ward 连锁的凝聚层次聚类，切割成 $k=2$ 个簇。得到的划分如下：\n- 运行 A（层次聚类，平均连锁，$k=3$）：$C^{(A)}_1=\\{g_1,g_2,g_3\\}$, $C^{(A)}_2=\\{g_4,g_5\\}$, $C^{(A)}_3=\\{g_6,g_7\\}$。\n- 运行 B（$k$-均值，$k=3$）：$C^{(B)}_1=\\{g_1,g_2\\}$, $C^{(B)}_2=\\{g_3,g_4,g_5\\}$, $C^{(B)}_3=\\{g_6,g_7\\}$。\n- 运行 C（层次聚类，Ward 连锁，$k=2$）：$C^{(C)}_1=\\{g_1,g_2,g_3,g_4,g_5\\}$, $C^{(C)}_2=\\{g_6,g_7\\}$。\n\n根据定义，共识矩阵 $C \\in \\mathbb{R}^{n \\times n}$ 的元素 $C_{ij}$ 等于在 $R=3$ 次运行中基因 $g_i$ 和 $g_j$ 被分配到同一个簇的次数所占的比例，并约定对所有 $i$ 都有 $C_{ii}=1$。通过在水平 $\\tau=\\frac{2}{3}$ 处对矩阵 $C$ 进行阈值化处理，可以得到一个关于这 $n$ 个基因的无向图，即共识图。当且仅当 $C_{ij} \\ge \\tau$ 时，基因 $g_i$ 和 $g_j$ 之间存在一条边。稳健的共识聚类被定义为这个阈值化图的连通分量。\n\n仅使用上述基本定义，计算共识矩阵 $C$，构建在 $\\tau=\\frac{2}{3}$ 处的阈值化共识图，提取其连通分量，并报告共识聚类的数量（即连通分量的数量）。您的最终答案必须是一个没有单位的整数。无需进行四舍五入。", "solution": "该问题经验证是合理的。它在科学上基于计算生物学中已确立的共识聚类方法，提法得当，包含所有必要的数据和定义，且表述客观。因此，我们可以开始解答。\n\n目标是找出稳健共识聚类的数量，这些聚类被定义为阈值化共识图的连通分量。该过程包括三个主要步骤：1) 计算共识矩阵 $C$，2) 通过应用阈值 $\\tau$ 构建共识图，以及 3) 识别该图的连通分量。\n\n该问题涉及 $n=7$ 个基因，标记为 $g_1, g_2, \\dots, g_7$，以及 $R=3$ 次聚类运行，分别记为 A、B 和 C。每次运行的划分如下：\n- 运行 A：$C^{(A)}_1=\\{g_1,g_2,g_3\\}$, $C^{(A)}_2=\\{g_4,g_5\\}$, $C^{(A)}_3=\\{g_6,g_7\\}$。\n- 运行 B：$C^{(B)}_1=\\{g_1,g_2\\}$, $C^{(B)}_2=\\{g_3,g_4,g_5\\}$, $C^{(B)}_3=\\{g_6,g_7\\}$。\n- 运行 C：$C^{(C)}_1=\\{g_1,g_2,g_3,g_4,g_5\\}$, $C^{(C)}_2=\\{g_6,g_7\\}$。\n\n共识矩阵 $C$ 是一个 $7 \\times 7$ 的矩阵，其中元素 $C_{ij}$ 是基因 $g_i$ 和 $g_j$ 在所有 $R=3$ 次运行中处于同一簇的次数比例。该矩阵是对称的（$C_{ij} = C_{ji}$），并且对角线上的元素为1（$C_{ii}=1$）。我们只需要计算 $i  j$ 时的上三角元素值。\n\n- 对于配对 $(g_1, g_2)$：在 A、B、C 中均在同一簇。$C_{12} = 3/3 = 1$。\n- 对于配对 $(g_1, g_3)$：在 A、C 中在同一簇。$C_{13} = 2/3$。\n- 对于配对 $(g_2, g_3)$：在 A、C 中在同一簇。$C_{23} = 2/3$。\n- 对于配对 $(g_3, g_4)$：在 B、C 中在同一簇。$C_{34} = 2/3$。\n- 对于配对 $(g_3, g_5)$：在 B、C 中在同一簇。$C_{35} = 2/3$。\n- 对于配对 $(g_4, g_5)$：在 A、B、C 中均在同一簇。$C_{45} = 3/3 = 1$。\n- 对于配对 $(g_6, g_7)$：在 A、B、C 中均在同一簇。$C_{67} = 3/3 = 1$。\n\n所有其他配对的共识值都小于 $2/3$。例如，$C_{14} = 1/3$ (仅在C中同簇)，$C_{16}=0$。\n\n接下来，我们通过在水平 $\\tau = 2/3$ 处对矩阵 $C$ 进行阈值化来构建一个无向图。当且仅当 $C_{ij} \\ge 2/3$ 时，节点 $g_i$ 和 $g_j$ 之间存在一条边。根据上述计算，我们得到以下边：\n$(g_1, g_2), (g_1, g_3), (g_2, g_3), (g_3, g_4), (g_3, g_5), (g_4, g_5), (g_6, g_7)$。\n\n最后，我们找出这个图的连通分量：\n1.  第一个分量：$g_1, g_2, g_3$ 形成一个三角形。$g_3$ 连接到 $g_4$ 和 $g_5$，$g_4$ 和 $g_5$ 也相互连接。因此，所有基因 $\\{g_1, g_2, g_3, g_4, g_5\\}$ 都相互连接，形成一个连通分量。\n2.  第二个分量：$g_6$ 和 $g_7$ 相互连接，但与任何其他基因都没有连接。它们形成另一个独立的连通分量 $\\{g_6, g_7\\}$。\n\n因此，这个阈值化共识图中有两个连通分量。稳健共识聚类的数量是 2。", "answer": "$$\\boxed{2}$$", "id": "3295668"}]}