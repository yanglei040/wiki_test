{"hands_on_practices": [{"introduction": "在构建复杂的跨维度采样器之前，理解其核心的马尔可夫链动力学至关重要。本练习通过一个简单的双状态马尔可夫链模型，模拟了在不同维度模型（例如，单层与双层地质模型）之间切换的简化情景 [@problem_id:3609582]。通过推导其稳态分布和分析其收敛速度，您将深入理解转移概率如何直接影响MCMC采样器的混合时间（mixing time）和收敛效率，这是设计高效算法的基础。", "problem": "在用于计算地球物理学的跨维马尔可夫链蒙特卡洛 (MCMC) 方法中，通常使用可逆跳转马尔可夫链蒙特卡洛 (RJMCMC) 在不同维度的模型空间之间切换。考虑一个针对分层地下介质的贝叶斯反演问题，其中模型维度指示符 $K$ 在 $K=1$ 层和 $K=2$ 层之间切换。假设在 RJMCMC 的提议-接受机制下，$K$ 的边际动态可以近似为一个在 $\\{1,2\\}$ 上的双态齐次马尔可夫链，其转移矩阵为\n$$\nP \\;=\\; \\begin{pmatrix}\n1-a   a \\\\\nb   1-b\n\\end{pmatrix},\n$$\n其中 $a \\in (0,1)$ 是从 $K=1$ 提议并接受一个移动到 $K=2$ 的单步概率，而 $b \\in (0,1)$ 是从 $K=2$ 移动到 $K=1$ 的类似概率。假设 $0  a+b  2$，以确保链是不可约且非周期的。\n\n该链收敛到唯一平稳分布的速度由转移矩阵 $P$ 的谱隙（spectral gap）决定，谱隙定义为 $1 - |\\lambda_2|$，其中 $|\\lambda_2|$ 是 $P$ 的第二大特征值模（SLEM）。一个更大的谱隙意味着更快的收敛和更好的维度间混合。\n\n从线性代数和概率论的基本原理出发，推导出该马尔可夫链的谱隙。您的答案应该表示为仅含 $a$ 和 $b$ 的封闭形式解析表达式。", "solution": "此问题被认为是有效的，因为它具有科学依据、良定且客观。它是在有限状态马尔可夫链研究中的一个标准理论练习，而有限状态马尔可夫链是 MCMC方法的核心组成部分。该问题是自洽的，并且在数学上是一致的。\n\n该问题要求解决与由转移矩阵 $P$ 描述的双态齐次马尔可夫链相关的三个项目。我们将依次解决它们。\n\n1.  平稳分布 $\\pi$ 的推导。\n平稳分布 $\\pi = (\\pi_1, \\pi_2)$ 是一个在转移矩阵 $P$ 的作用下保持不变的概率分布。它由两个条件定义：\n1.  平衡方程：$\\pi P = \\pi$。\n2.  归一化条件：$\\sum_{i} \\pi_i = 1$。\n\n对于给定的 $2 \\times 2$ 矩阵 $P$，平衡方程 $\\pi P = \\pi$ 可写作：\n$$\n\\begin{pmatrix} \\pi_1   \\pi_2 \\end{pmatrix} \\begin{pmatrix} 1-a   a \\\\ b   1-b \\end{pmatrix} = \\begin{pmatrix} \\pi_1   \\pi_2 \\end{pmatrix}\n$$\n该矩阵方程得出一个包含两个线性方程的方程组：\n$$\n\\begin{cases} \\pi_1 (1-a) + \\pi_2 b = \\pi_1   (1) \\\\ \\pi_1 a + \\pi_2 (1-b) = \\pi_2   (2) \\end{cases}\n$$\n让我们简化方程 $(1)$：\n$$\n\\pi_1 - \\pi_1 a + \\pi_2 b = \\pi_1\n$$\n$$\n-\\pi_1 a + \\pi_2 b = 0\n$$\n$$\n\\pi_1 a = \\pi_2 b\n$$\n简化方程 $(2)$ 会得到完全相同的关系，这对于随机矩阵是预料之中的，因为全为1的向量是其对应于特征值 $1$ 的右特征向量。\n现在我们使用第二个条件，即归一化条件 $\\pi_1 + \\pi_2 = 1$。由 $\\pi_1 a = \\pi_2 b$，我们可以用 $\\pi_2$ 表示 $\\pi_1$（因为 $a \\in (0,1)$，所以 $a \\neq 0$）：\n$$\n\\pi_1 = \\pi_2 \\frac{b}{a}\n$$\n将此代入归一化方程：\n$$\n\\pi_2 \\frac{b}{a} + \\pi_2 = 1\n$$\n$$\n\\pi_2 \\left( \\frac{b}{a} + 1 \\right) = 1\n$$\n$$\n\\pi_2 \\left( \\frac{b+a}{a} \\right) = 1\n$$\n解出 $\\pi_2$ 可得：\n$$\n\\pi_2 = \\frac{a}{a+b}\n$$\n现在我们可以求出 $\\pi_1$：\n$$\n\\pi_1 = 1 - \\pi_2 = 1 - \\frac{a}{a+b} = \\frac{(a+b)-a}{a+b} = \\frac{b}{a+b}\n$$\n因此，平稳分布为：\n$$\n\\pi = \\left( \\frac{b}{a+b}, \\frac{a}{a+b} \\right)\n$$\n\n2.  $P$ 的特征值和第二大特征值模 (SLEM)。\n矩阵 $P$ 的特征值 $\\lambda$ 是特征方程 $\\det(P - \\lambda I) = 0$ 的解，其中 $I$ 是单位矩阵。\n$$\n\\det \\begin{pmatrix} 1-a-\\lambda   a \\\\ b   1-b-\\lambda \\end{pmatrix} = 0\n$$\n行列式计算如下：\n$$\n(1-a-\\lambda)(1-b-\\lambda) - ab = 0\n$$\n让我们重新排列括号内的项：\n$$\n((1-\\lambda)-a)((1-\\lambda)-b) - ab = 0\n$$\n展开此乘积可得：\n$$\n(1-\\lambda)^2 - b(1-\\lambda) - a(1-\\lambda) + ab - ab = 0\n$$\n$$\n(1-\\lambda)^2 - (a+b)(1-\\lambda) = 0\n$$\n我们可以提出公因子 $(1-\\lambda)$：\n$$\n(1-\\lambda) \\left[ (1-\\lambda) - (a+b) \\right] = 0\n$$\n该方程给出 $\\lambda$ 的两个解：\n第一个解来自 $1-\\lambda = 0$，即 $\\lambda_1 = 1$。这是最大特征值，对于不可约随机矩阵，该值恒为 $1$，对应于平稳分布。\n第二个解来自 $(1-\\lambda) - (a+b) = 0$，即 $1 - (a+b) = \\lambda$，所以 $\\lambda_2 = 1-a-b$。\n\n$P$ 的特征值为 $\\lambda_1 = 1$ 和 $\\lambda_2 = 1-a-b$。\n问题要求第二大特征值模 (SLEM)。这是除主特征值 $\\lambda_1 = 1$ 外所有特征值中的最大模。在本例中，它就是 $|\\lambda_2|$。\n给定约束条件 $a \\in (0,1)$ 和 $b \\in (0,1)$，我们有 $0  a+b  2$。这意味着 $-1  1-(a+b)  1$，所以 $|\\lambda_2| = |1-a-b|  1$。因此，SLEM 是 $|\\lambda_2| = |1-a-b|$。\n\n3.  收敛性、松弛与混合。\n马尔可夫链向其平稳分布的收敛性由其特征值决定。根据随机矩阵的 Perron-Frobenius 定理，一个不可约且非周期的链有唯一的最大特征值 $\\lambda_1 = 1$，所有其他特征值 $\\lambda_i$ 均满足 $|\\lambda_i|  1$。\n\n设任意初始分布为 $v_0$。$n$ 步后的分布为 $v_n = v_0 P^n$。此分布与平稳分布 $\\pi$ 的偏差为 $v_n - \\pi$。当 $n \\to \\infty$ 时，此偏差衰减到零的速率由 SLEM 决定。\n\n矩阵 $P$ 可以写成其谱分解形式。对于分布向量 $v_n$，其与平稳分布 $\\pi$ 的距离（在某个合适的范数下，如全变差距离）受一个与 $(\\text{SLEM})^n$ 成正比的项的约束。即，\n$$\nd(v_n, \\pi) \\le C \\cdot |\\lambda_2|^n = C \\cdot |1-a-b|^n\n$$\n其中 $C$ 是一个依赖于初始状态的常数。项 $|1-a-b|^n$ 决定了渐近衰减率。较小的 SLEM 导致更快的衰减，意味着链能更快地“忘记”其初始状态并收敛到平稳状态。这个过程被称为松弛。\n\n谱隙，定义为 $1 - \\text{SLEM} = 1 - |1-a-b|$，是收敛速度的直接度量。更大的谱隙意味着更快的收敛。\n\n对跨维指示符 $K$ 的意义：\n量 SLEM $= |1-a-b|$ 控制了 MCMC 采样器对处于状态 $K=1$ 或 $K=2$ 的后验概率的估计值收敛到真实平稳概率 $\\pi_1$ 和 $\\pi_2$ 的速度。\n-   如果 $a+b \\approx 1$，那么 $1-a-b \\approx 0$，SLEM 非常小。这导致了大的谱隙和非常快的收敛。链的混合性很好，意味着它能在 1 层和 2 层模型之间高效切换，从而能够快速探索不同的模型空间。这是 RJMCMC 采样器的理想情况。\n-   如果 $a+b \\approx 0$（即 $a$ 和 $b$ 都非常小），那么 $1-a-b \\approx 1$，SLEM 接近于 $1$。谱隙很小，收敛非常慢。链会在一个维度上“卡住”很长时间，导致混合性差和采样效率低下。\n-   如果 $a+b \\approx 2$（即 $a$ 和 $b$ 都接近于 $1$），那么 $1-a-b \\approx -1$，SLEM 同样接近于 $1$。收敛也非常慢。链的行为是高度反相关的，倾向于几乎每一步都在维度间跳转，这也阻碍了在每个维度内对参数空间的有效探索。\n\n总之，为了使跨维采样器具有良好的混合性和快速的松弛，模型维度间的提议和接受概率 $a$ 和 $b$ 应被调整，使其和 $a+b$ 接近于 $1$，这样可以最小化 SLEM 并最大化谱隙。\n\n最终要求的答案是谱隙，即 $1 - \\text{SLEM}$。谱隙 $= 1 - |1-a-b|$。", "answer": "$$\n\\boxed{1 - |1-a-b|}\n$$", "id": "3609582"}, {"introduction": "可逆跳转MCMC（RJMCMC）的一个核心技术挑战是处理参数空间维度变化时的细致平衡条件。当采样器从一个维度跳到另一个维度时（例如，将一个地层“分裂”为两个），必须对变量变换引起的“体积”变化进行校正，雅可比行列式（Jacobian determinant）正是完成此校正的关键数学工具 [@problem_id:3609556]。本练习将带您亲手计算一个典型的“分裂”移动的雅可比行列式，这是构建任何RJMCMC采样器都必须掌握的步骤。", "problem": "在用于跨维地球物理反演的可逆跳跃马尔可夫链蒙特卡洛 (RJMCMC) 方法中，一种常见的提议是“分裂移动”，它通过将一个厚度为 $h$ 的单一地层分裂成两个厚度分别为 $h_1$ 和 $h_2$ 的子层来增加模型维度，同时也将地震速度 $v$ 等地层属性扰动为两个子属性 $v_1$ 和 $v_2$。假设分裂移动是通过抽取一个辅助变量 $r \\in (0,1)$ 和一个扰动 $\\delta \\in \\mathbb{R}$ 来构建的，并定义了如下的前向维度匹配变换：\n$$\n(h, r, v, \\delta) \\mapsto (h_1, h_2, v_1, v_2)\n$$\n其关系式如下：\n$$\nh_1 = r\\, h, \\quad h_2 = (1 - r)\\, h, \\quad v_1 = v - \\frac{\\delta}{2}, \\quad v_2 = v + \\frac{\\delta}{2}.\n$$\n假设物理约束 $h > 0$ 成立。在 RJMCMC 中，变量替换下的细致平衡条件要求上述变换的雅可比行列式的绝对值。\n\n从可微双射的变量替换法则以及雅可比矩阵（定义为目标变量对源变量的一阶偏导数矩阵）的定义出发，计算从 $(h, r, v, \\delta)$ 到 $(h_1, h_2, v_1, v_2)$ 的组合映射的雅可比行列式的绝对值。请将最终答案表示为仅含 $h$ 的封闭形式解析表达式。", "solution": "本题要求计算在可逆跳跃马尔可夫链蒙特卡洛 (RJMCMC) 中使用的给定跨维变换的雅可比行列式的绝对值。该变换将源变量 $(h, r, v, \\delta)$ 映射到目标变量 $(h_1, h_2, v_1, v_2)$。\n\n令源变量向量为 $\\mathbf{x} = (x_1, x_2, x_3, x_4) = (h, r, v, \\delta)$，目标变量向量为 $\\mathbf{y} = (y_1, y_2, y_3, y_4) = (h_1, h_2, v_1, v_2)$。该变换由以下方程组定义：\n$$\nh_1 = r h\n$$\n$$\nh_2 = (1 - r) h\n$$\n$$\nv_1 = v - \\frac{\\delta}{2}\n$$\n$$\nv_2 = v + \\frac{\\delta}{2}\n$$\n\n雅可比矩阵（记为 $J$）是所有目标变量对源变量的一阶偏导数构成的矩阵。$J$ 的第 $i$ 行第 $j$ 列的元素由 $J_{ij} = \\frac{\\partial y_i}{\\partial x_j}$ 给出。因此，雅可比矩阵是一个 $4 \\times 4$ 的矩阵：\n$$\nJ = \\frac{\\partial(h_1, h_2, v_1, v_2)}{\\partial(h, r, v, \\delta)} = \\begin{pmatrix}\n\\frac{\\partial h_1}{\\partial h}   \\frac{\\partial h_1}{\\partial r}   \\frac{\\partial h_1}{\\partial v}   \\frac{\\partial h_1}{\\partial \\delta} \\\\\n\\frac{\\partial h_2}{\\partial h}   \\frac{\\partial h_2}{\\partial r}   \\frac{\\partial h_2}{\\partial v}   \\frac{\\partial h_2}{\\partial \\delta} \\\\\n\\frac{\\partial v_1}{\\partial h}   \\frac{\\partial v_1}{\\partial r}   \\frac{\\partial v_1}{\\partial v}   \\frac{\\partial v_1}{\\partial \\delta} \\\\\n\\frac{\\partial v_2}{\\partial h}   \\frac{\\partial v_2}{\\partial r}   \\frac{\\partial v_2}{\\partial v}   \\frac{\\partial v_2}{\\partial \\delta}\n\\end{pmatrix}\n$$\n我们根据给定的变换方程计算每个偏导数。\n\n对于第一行（$h_1 = r h$ 的导数）：\n$\\frac{\\partial h_1}{\\partial h} = r$\n$\\frac{\\partial h_1}{\\partial r} = h$\n$\\frac{\\partial h_1}{\\partial v} = 0$\n$\\frac{\\partial h_1}{\\partial \\delta} = 0$\n\n对于第二行（$h_2 = (1 - r) h$ 的导数）：\n$\\frac{\\partial h_2}{\\partial h} = 1 - r$\n$\\frac{\\partial h_2}{\\partial r} = -h$\n$\\frac{\\partial h_2}{\\partial v} = 0$\n$\\frac{\\partial h_2}{\\partial \\delta} = 0$\n\n对于第三行（$v_1 = v - \\frac{\\delta}{2}$ 的导数）：\n$\\frac{\\partial v_1}{\\partial h} = 0$\n$\\frac{\\partial v_1}{\\partial r} = 0$\n$\\frac{\\partial v_1}{\\partial v} = 1$\n$\\frac{\\partial v_1}{\\partial \\delta} = -\\frac{1}{2}$\n\n对于第四行（$v_2 = v + \\frac{\\delta}{2}$ 的导数）：\n$\\frac{\\partial v_2}{\\partial h} = 0$\n$\\frac{\\partial v_2}{\\partial r} = 0$\n$\\frac{\\partial v_2}{\\partial v} = 1$\n$\\frac{\\partial v_2}{\\partial \\delta} = \\frac{1}{2}$\n\n将这些导数代入雅可比矩阵，得到：\n$$\nJ = \\begin{pmatrix}\nr   h   0   0 \\\\\n1 - r   -h   0   0 \\\\\n0   0   1   -\\frac{1}{2} \\\\\n0   0   1   \\frac{1}{2}\n\\end{pmatrix}\n$$\n该矩阵具有块对角结构：\n$$\nJ = \\begin{pmatrix} A   0 \\\\ 0   B \\end{pmatrix}\n$$\n其中 $A = \\begin{pmatrix} r   h \\\\ 1 - r   -h \\end{pmatrix}$ 且 $B = \\begin{pmatrix} 1   -\\frac{1}{2} \\\\ 1   \\frac{1}{2} \\end{pmatrix}$。\n块对角矩阵的行列式是其对角块的行列式的乘积。因此，$\\det(J) = \\det(A) \\det(B)$。\n\n首先，我们计算块 $A$ 的行列式：\n$$\n\\det(A) = \\det \\begin{pmatrix} r   h \\\\ 1 - r   -h \\end{pmatrix} = (r)(-h) - (h)(1 - r) = -rh - h + rh = -h\n$$\n接下来，我们计算块 $B$ 的行列式：\n$$\n\\det(B) = \\det \\begin{pmatrix} 1   -\\frac{1}{2} \\\\ 1   \\frac{1}{2} \\end{pmatrix} = (1)\\left(\\frac{1}{2}\\right) - \\left(-\\frac{1}{2}\\right)(1) = \\frac{1}{2} + \\frac{1}{2} = 1\n$$\n完整的雅可比矩阵 $J$ 的行列式是这两个行列式的乘积：\n$$\n\\det(J) = \\det(A) \\det(B) = (-h)(1) = -h\n$$\n题目要求的是雅可比行列式的绝对值 $|\\det(J)|$。\n$$\n|\\det(J)| = |-h|\n$$\n考虑到地层厚度必须为正的物理约束 $h > 0$，绝对值可简化为：\n$$\n|\\det(J)| = h\n$$\n结果是仅含 $h$ 的封闭形式表达式，符合题目要求。", "answer": "$$\\boxed{h}$$", "id": "3609556"}, {"introduction": "本练习将前述的理论和计算技巧融会贯通，要求您为一个实际的地球物理问题构建一个完整的跨维度采样器。您将为一维分层地球模型设计并实现“诞生”（birth）和“消亡”（death）移动，这是RJMCMC中最经典的移动类型 [@problem_id:3609577]。这个过程要求您正确地组合似然函数、先验分布、提议分布以及雅可比行列式，以计算出完整的Metropolis-Hastings-Green接受概率，从而在实践中真正掌握RJMCMC算法的精髓。", "problem": "您的任务是为一个一维分层地球模型实现一个 Metropolis–Hastings–Green 跨维度采样器组件，其中层数是未知的。该模型由一系列具有正厚度和正 P 波速度的水平地层组成。正演模型将分层模型映射到一个零偏移距垂直走时，该走时是每层走时之和。\n\n您必须设计并实现“诞生”和“消亡”移动，这些移动会使层数加一或减一，同时通过一个辅以辅助随机变量的确定性、可微且可逆的映射来保持可逆性。您的实现必须利用贝叶斯推断原理和马尔可夫链的细致平衡条件，计算单个提议移动的接受概率。所有计算都必须基于指定的先验和提议分布，并且接受概率必须考虑到模型维度的变化、层数的先验、参数的先验、似然、提议密度以及映射的雅可比行列式的绝对值。\n\n使用以下基本原理：\n\n- 用于后验概率的贝叶斯法则。\n- 确保可逆性的马尔可夫链细致平衡条件。\n- 可逆跳转马尔可夫链蒙特卡洛方法中，用于跨维度映射的维度匹配原理和雅可比行列式的引入。\n\n模型规范：\n\n- 一个模型有 $K$ 个层，其中 $K \\in \\{K_{\\min},\\ldots,K_{\\max}\\}$，$K_{\\min} = 1$ 且 $K_{\\max} = 5$。每个层 $i \\in \\{1,\\ldots,K\\}$ 都有厚度 $h_i \\in \\mathbb{R}_{+}$（单位：米）和 P 波速度 $v_i \\in \\mathbb{R}_{+}$（单位：米/秒）。\n- 零偏移距垂直走时为\n$$\nT(m) = \\sum_{i=1}^{K} \\frac{h_i}{v_i} \\quad \\text{秒}.\n$$\n- 数据由单个观测值 $T_{\\text{obs}}$ 组成，该观测值带有标准差已知的独立高斯噪声 $\\sigma_T$（单位：秒）。\n\n先验：\n\n- 层数 $K$ 的先验是一个在 $\\{K_{\\min},\\ldots,K_{\\max}\\}$ 上的截断泊松分布，其率为 $\\lambda$：\n$$\np(K) = \\frac{\\exp(-\\lambda)\\lambda^{K}/K!}{\\sum_{k=K_{\\min}}^{K_{\\max}} \\exp(-\\lambda)\\lambda^{k}/k!}.\n$$\n- 给定 $K$，各层厚度是独立同分布的，服从率为 $\\beta_h$ 的指数分布：\n$$\np(h_i) = \\beta_h \\exp(-\\beta_h h_i), \\quad h_i > 0.\n$$\n- 给定 $K$，各层速度是独立同分布的，服从参数为 $\\mu_v$ 和 $\\sigma_v$ 的对数正态分布：\n$$\n\\ln v_i \\sim \\mathcal{N}(\\mu_v,\\sigma_v^2), \\quad v_i > 0.\n$$\n\n似然：\n\n- 单个观测值的似然是高斯分布：\n$$\np(T_{\\text{obs}}\\mid m) \\propto \\exp\\!\\left(-\\frac{(T(m) - T_{\\text{obs}})^2}{2\\sigma_T^2}\\right).\n$$\n\n移动类型和提议：\n\n- 在给定的 $K$ 值下，以概率 $p_b(K)$ 选择诞生移动，以概率 $p_d(K)$ 选择消亡移动：\n  - 当 $K = K_{\\min}$ 时：$p_b(K_{\\min}) = 1$ 且 $p_d(K_{\\min}) = 0$。\n  - 当 $K = K_{\\max}$ 时：$p_b(K_{\\max}) = 0$ 且 $p_d(K_{\\max}) = 1$。\n  - 其他情况下：$p_b(K) = p_d(K) = 1/2$。\n- 诞生移动（$K \\to K+1$）：从 $\\{1,\\ldots,K\\}$ 中均匀选择一个层索引 $j$。抽取 $r \\sim \\text{Beta}(1,1)$（即 $(0,1)$ 上的均匀分布）和 $\\delta \\sim \\mathcal{N}(0,\\sigma_{\\delta}^2)$。对于选定的参数为 $(h, v)$ 的层，提议将其分裂为两个层，参数为\n$$\nh_1 = r h, \\quad h_2 = (1-r) h, \\quad v_1 = v\\,\\exp(\\delta), \\quad v_2 = v\\,\\exp(-\\delta).\n$$\n将这两个新层插入以替换原始层。从 $(h,v,r,\\delta)$ 到 $(h_1,h_2,v_1,v_2)$ 的变换的雅可比行列式的绝对值必须被包含在内。\n- 消亡移动（$K \\to K-1$）：从 $\\{(1,2),(2,3),\\ldots,(K-1,K)\\}$ 中均匀选择一个相邻对 $(j,j+1)$。将其合并为单个层，参数为\n$$\nh = h_1 + h_2, \\quad v = \\sqrt{v_1 v_2}.\n$$\n逆映射产生辅助变量\n$$\nr = \\frac{h_1}{h_1 + h_2}, \\quad \\delta = \\tfrac{1}{2}\\ln\\!\\left(\\frac{v_1}{v_2}\\right),\n$$\n它们必须用于评估诞生移动的逆向提议密度，并包含正确的逆雅可比行列式的绝对值。\n\n提议密度：\n\n- 对于诞生移动的正向提议，密度因子包括移动类型概率 $p_b(K)$、均匀选择 $j$ 的概率 $1/K$，以及辅助变量 $r$ 和 $\\delta$ 的密度：\n$$\nf_r(r) = 1 \\ \\text{for} \\ r \\in (0,1), \\quad f_{\\delta}(\\delta) = \\frac{1}{\\sigma_{\\delta}\\sqrt{2\\pi}}\\exp\\!\\left(-\\frac{\\delta^2}{2\\sigma_{\\delta}^2}\\right).\n$$\n- 对于消亡移动的正向提议，密度因子包括移动类型概率 $p_d(K)$ 和均匀选择对 $(j,j+1)$ 的概率 $1/(K-1)$。\n\n您的程序必须通过组合后验因子、正向和逆向提议密度以及雅可比行列式的绝对值，为下面测试套件中的每个提议移动计算 Metropolis–Hastings–Green 接受概率。如果提议的移动因违反 $K$ 的边界而无效（例如，在 $K = K_{\\min}$ 时进行消亡移动或在 $K = K_{\\max}$ 时进行诞生移动），则接受概率必须返回为 $0.0$。\n\n所有测试用例的全局常量：\n\n- 使用 $\\lambda = 2.5$，$K_{\\min}=1$，$K_{\\max}=5$。\n- 使用 $\\beta_h = 1/1000$（单位 $\\text{m}^{-1}$）。\n- 使用 $\\mu_v = \\ln(2200)$ 和 $\\sigma_v = 0.25$。\n- 使用 $\\sigma_{\\delta} = 0.2$。\n- 使用 $T_{\\text{obs}} = 0.6$ 秒和 $\\sigma_T = 0.02$ 秒。\n\n角度单位不适用。所有物理量必须采用国际单位制：厚度单位为米，速度单位为米/秒，时间单位为秒。\n\n测试套件：\n\n每个测试用例指定移动类型、当前层数 $K$、当前的厚度和速度列表、为移动选择的索引以及任何所需的辅助变量。所选索引的解释如下：\n- 对于诞生，所选索引 $j$ 是要分裂的层（从 1 开始计数）。\n- 对于消亡，所选索引 $j$ 是要合并的相邻对 $(j, j+1)$ 中的第一个层（从 1 开始计数）。\n\n为每个案例提供接受概率，形式为单个浮点数。\n\n- 案例 1 (happy-path birth):\n  - 移动：诞生\n  - $K = 2$\n  - 厚度 $[500.0, 700.0]$ 米\n  - 速度 $[2000.0, 2500.0]$ 米/秒\n  - 选择的索引 $j = 2$\n  - $r = 0.4$\n  - $\\delta = 0.1$\n- 案例 2 (happy-path death):\n  - 移动：消亡\n  - $K = 3$\n  - 厚度 $[500.0, 280.0, 420.0]$ 米\n  - 速度 $[2000.0, 2762.925465, 2262.093545]$ 米/秒\n  - 选择的索引 $j = 2$ (合并第 2 和第 3 层)\n- 案例 3 (boundary invalid death):\n  - 移动：消亡\n  - $K = 1$\n  - 厚度 $[1200.0]$ 米\n  - 速度 $[2300.0]$ 米/秒\n  - 选择的索引 $j = 1$\n- 案例 4 (boundary invalid birth):\n  - 移动：诞生\n  - $K = 5$\n  - 厚度 $[300.0, 400.0, 500.0, 600.0, 700.0]$ 米\n  - 速度 $[1800.0, 2000.0, 2200.0, 2400.0, 2600.0]$ 米/秒\n  - 选择的索引 $j = 3$\n  - $r = 0.5$\n  - $\\delta = 0.0$\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，“[result1,result2,result3,result4]”），结果顺序与测试用例相同。每个结果必须是 $[0,1]$ 范围内的浮点数，代表相应测试用例的接受概率。没有用户输入，程序必须使用上述指定的值确定性地运行。", "solution": "该问题要求在一个地球物理反演问题中，为跨维度的诞生和消亡移动计算 Metropolis–Hastings–Green 接受概率。该模型将地球的地下表示为一系列一维地层，其中层数 $K$ 是一个待推断的未知参数。解决方案涉及应用可逆跳转马尔可夫链蒙特卡洛（RJMCMC）的原理。\n\n从当前模型状态 $m$ 移动到提议模型状态 $m'$ 的接受概率 $\\alpha$ 由下式给出：\n$$\n\\alpha(m'|m) = \\min \\left(1, A \\right)\n$$\n其中 $A$ 是接受率。对于参数空间维度发生变化的跨维度移动，该比率由后验概率比、提议概率比以及在空间之间映射的变换的雅可比行列式的绝对值组成。\n\n后验概率 $p(m|d)$ 由贝叶斯法则给出，$p(m|d) \\propto p(d|m) p(m)$，其中 $p(d|m)$ 是似然，$p(m)$ 是先验。完整的先验是 $p(m) = p(\\mathbf{h}, \\mathbf{v}, K) = p(\\mathbf{h}, \\mathbf{v}|K) p(K)$。给定 $K$，所有层参数 $(h_i, v_i)$ 都是独立的，因此 $p(\\mathbf{h}, \\mathbf{v}|K) = \\prod_{i=1}^K p(h_i) p(v_i)$。\n\n从 $m$ 移动到 $m'$ 的接受率的一般形式是：\n$$\nA = \\frac{p(m'|d)}{p(m|d)} \\frac{q(m|m')}{q(m'|m)} |J| = \\underbrace{\\frac{p(d|m')}{p(d|m)}}_{\\text{似然比}} \\underbrace{\\frac{p(m')}{p(m)}}_{\\text{先验比}} \\underbrace{\\frac{q(m|m')}{q(m'|m)}}_{\\text{提议比}} \\underbrace{|J|}_{\\text{雅可比项}}\n$$\n这里，$q(m'|m)$ 是正向提议密度，$q(m|m')$ 是逆向提议密度，$|J|$ 是用于维度匹配变换的雅可比项。我们将分别分析诞生和消亡移动。为避免数值下溢，所有计算都使用对数概率进行。对数接受率是 $\\log A$，且 $\\alpha = \\min(1, \\exp(\\log A))$。\n\n### 函数定义\n首先，我们根据问题规范为各个组件定义对数概率。\n- 走时：$T(m) = \\sum_{i=1}^{K} h_i/v_i$\n- 对数似然（忽略在比率中会抵消的常数）：$\\log p(d|m) = -\\frac{(T(m) - T_{\\text{obs}})^2}{2\\sigma_T^2}$\n- $K$ 的对数先验：$\\log p(K) = -\\lambda + K\\log\\lambda - \\ln(K!) - \\log C$，其中 $C$ 是在 $\\{K_{\\min}, ..., K_{\\max}\\}$ 上的截断泊松分布的归一化常数。\n- 厚度 $h_i$ 的对数先验：对于 $h_i > 0$，$\\log p(h_i) = \\log\\beta_h - \\beta_h h_i$。\n- 速度 $v_i$ 的对数先验：对于 $v_i > 0$，$\\log p(v_i) = -\\ln v_i - \\ln(\\sigma_v\\sqrt{2\\pi}) - \\frac{(\\ln v_i - \\mu_v)^2}{2\\sigma_v^2}$。\n- 辅助变量 $\\delta$ 的对数提议：$\\log f_\\delta(\\delta) = -\\ln(\\sigma_\\delta\\sqrt{2\\pi}) - \\frac{\\delta^2}{2\\sigma_\\delta^2}$。$r$ 的提议分布是 $U(0,1)$，因此其密度为 $f_r(r)=1$，对数密度为 $\\log f_r(r)=0$。\n\n### 诞生移动 ($K \\to K+1$)\n诞生移动提议将层数从 $K$ 增加到 $K+1$。\n1.  **状态与提议**：当前模型是 $m_c$，有 $K$ 层。均匀地（以 $1/K$ 的概率）选择一个层 $j$，其参数为 $(h_j, v_j)$。抽取两个辅助变量 $r \\sim U(0,1)$ 和 $\\delta \\sim \\mathcal{N}(0, \\sigma_\\delta^2)$。提议的模型 $m_p$ 有 $K+1$ 层，其中第 $j$ 层被两个新层替换，参数为 $(h_{p1}, v_{p1})$ 和 $(h_{p2}, v_{p2})$。\n2.  **变换**：确定性映射为 $(h_j, v_j, r, \\delta) \\mapsto (h_{p1}, h_{p2}, v_{p1}, v_{p2})$，其中：\n    $h_{p1} = r h_j$，$h_{p2} = (1-r) h_j$，$v_{p1} = v_j e^\\delta$，$v_{p2} = v_j e^{-\\delta}$。\n3.  **雅可比行列式**：此变换的雅可比矩阵是 $J = \\frac{\\partial(h_{p1}, h_{p2}, v_{p1}, v_{p2})}{\\partial(h_j, v_j, r, \\delta)}$。其行列式为 $\\det(J) = -2h_j v_j$。绝对值为 $|J| = 2h_j v_j$。\n4.  **提议密度**：\n    -   正向提议密度：$q(m_p|m_c) = p_b(K) \\cdot \\frac{1}{K} \\cdot f_r(r) \\cdot f_\\delta(\\delta)$。\n    -   逆向提议（从 $K+1$ 层进行消亡）：从 $K$ 个可用的相邻对中均匀选择一个进行合并。逆向提议密度为 $q(m_c|m_p) = p_d(K+1) \\cdot \\frac{1}{K}$。\n5.  **接受率**：完整的对数接受率为：\n$\\log A_{\\text{birth}} = \\log\\left(\\frac{p(d|m_p)}{p(d|m_c)}\\right) + \\log\\left(\\frac{p(m_p)}{p(m_c)}\\right) + \\log\\left(\\frac{q(m_c|m_p)}{q(m_p|m_c)}\\right) + \\log|J|$\n代入各个部分：\n$\\log A_{\\text{birth}} = \\left(\\log p(d|m_p) - \\log p(d|m_c)\\right) + \\left(\\log p(K+1) - \\log p(K)\\right) + \\left(\\log p(h_{p1}) + \\log p(h_{p2}) - \\log p(h_j)\\right) + \\left(\\log p(v_{p1}) + \\log p(v_{p2}) - \\log p(v_j)\\right) + \\left(\\log p_d(K+1) + \\log(K) - \\log p_b(K)\\right) - \\log f_\\delta(\\delta) + \\log(2 h_j v_j)$。\n问题规定，如果 $K=K_{\\max}$，则该移动无效，接受概率为 $0$。\n\n### 消亡移动 ($K \\to K-1$)\n消亡移动提议将层数从 $K$ 减少到 $K-1$。它是诞生移动的逆操作。\n1.  **状态与提议**：当前模型是 $m_c$，有 $K$ 层。均匀地（以 $1/(K-1)$ 的概率）选择一个相邻层对 $(j, j+1)$，其参数为 $(h_j, v_j, h_{j+1}, v_{j+1})$。将它们合并为单个层，形成具有 $K-1$ 层的提议模型 $m_p$。\n2.  **变换**：确定性合并操作为：\n    $h_p = h_j + h_{j+1}$，$v_p = \\sqrt{v_j v_{j+1}}$。\n3.  **雅可比行列式**：此移动是诞生移动的逆。接受率中的雅可比项是诞生移动雅可比行列式的倒数，即 $1/|J| = 1/(2h_p v_p)$。\n4.  **提议密度**：\n    -   正向提议密度：$q(m_p|m_c) = p_d(K) \\cdot \\frac{1}{K-1}$。\n    -   逆向提议（从 $K-1$ 层进行诞生）：合并后的层被选择进行分裂。此逆向移动的辅助变量是确定性计算的：$r = h_j / (h_j + h_{j+1})$ 和 $\\delta = \\frac{1}{2}\\ln(v_j/v_{j+1})$。逆向提议密度为 $q(m_c|m_p) = p_b(K-1) \\cdot \\frac{1}{K-1} \\cdot f_r(r) \\cdot f_\\delta(\\delta)$。\n5.  **接受率**：对数接受率为：\n$\\log A_{\\text{death}} = \\log\\left(\\frac{p(d|m_p)}{p(d|m_c)}\\right) + \\log\\left(\\frac{p(m_p)}{p(m_c)}\\right) + \\log\\left(\\frac{q(m_c|m_p)}{q(m_p|m_c)}\\right) + \\log\\left(\\frac{1}{|J|}\\right)$\n代入各个部分：\n$\\log A_{\\text{death}} = \\left(\\log p(d|m_p) - \\log p(d|m_c)\\right) + \\left(\\log p(K-1) - \\log p(K)\\right) + \\left(\\log p(h_{p}) - \\log p(h_j) - \\log p(h_{j+1})\\right) + \\left(\\log p(v_{p}) - \\log p(v_j) - \\log p(v_{j+1})\\right) + \\left(\\log p_b(K-1) - \\log p_d(K)\\right) + \\log f_\\delta(\\delta) - \\log(2 h_p v_p)$。\n问题规定，如果 $K=K_{\\min}$，则该移动无效，导致接受概率为 $0$。\n\n下面的实现为所提供的测试用例计算这些接受概率。", "answer": "```python\nimport numpy as np\nfrom scipy.special import gammaln, logsumexp\n\ndef solve():\n    \"\"\"\n    Main solver function that processes test cases and prints results.\n    \"\"\"\n    # Define global constants for the model\n    LAMBDA = 2.5\n    K_MIN = 1\n    K_MAX = 5\n    BETA_H = 1.0 / 1000.0\n    MU_V = np.log(2200.0)\n    SIGMA_V = 0.25\n    SIGMA_DELTA = 0.2\n    T_OBS = 0.6\n    SIGMA_T = 0.02\n    \n    # Pre-compute the normalization constant for the truncated Poisson prior on K\n    log_poisson_k_terms = [\n        k * np.log(LAMBDA) - gammaln(k + 1) for k in range(K_MIN, K_MAX + 1)\n    ]\n    log_poisson_k_norm_const = -LAMBDA + logsumexp(log_poisson_k_terms)\n\n    def log_p_k(k):\n        \"\"\"Computes the log-prior probability for the number of layers, log p(K).\"\"\"\n        if not (K_MIN = k = K_MAX):\n            return -np.inf\n        log_unnorm_prob = -LAMBDA + k * np.log(LAMBDA) - gammaln(k + 1)\n        return log_unnorm_prob - log_poisson_k_norm_const\n\n    def log_p_h(h):\n        \"\"\"Computes the log-prior probability for a layer thickness, log p(h).\"\"\"\n        if h = 0:\n            return -np.inf\n        return np.log(BETA_H) - BETA_H * h\n\n    def log_p_v(v):\n        \"\"\"Computes the log-prior probability for a layer velocity, log p(v).\"\"\"\n        if v = 0:\n            return -np.inf\n        log_v = np.log(v)\n        return -log_v - np.log(SIGMA_V * np.sqrt(2 * np.pi)) - \\\n               (log_v - MU_V)**2 / (2 * SIGMA_V**2)\n\n    def log_f_delta(delta):\n        \"\"\"Computes the log-density of the auxiliary variable delta.\"\"\"\n        return -np.log(SIGMA_DELTA * np.sqrt(2 * np.pi)) - \\\n               delta**2 / (2 * SIGMA_DELTA**2)\n\n    def travel_time(h_list, v_list):\n        \"\"\"Computes the total vertical travel time.\"\"\"\n        return np.sum(np.array(h_list) / np.array(v_list))\n\n    def get_move_prob(k, move_type):\n        \"\"\"Gets the probability of proposing a birth or death move at K layers.\"\"\"\n        if move_type == 'birth':\n            if k == K_MAX: return 0.0\n            if k == K_MIN: return 1.0\n            return 0.5\n        elif move_type == 'death':\n            if k == K_MIN: return 0.0\n            if k == K_MAX: return 1.0\n            return 0.5\n        return 0.0\n\n    def calculate_acceptance_prob(case):\n        \"\"\"Calculates the Metropolis-Hastings-Green acceptance probability for a given case.\"\"\"\n        move = case['move']\n        k_c = case['k']\n        h_c = case['h']\n        v_c = case['v']\n        j_idx = case['j'] - 1  # 1-based to 0-based index\n\n        # --- Handle BIRTH move ---\n        if move == 'birth':\n            if k_c == K_MAX:\n                return 0.0\n\n            r = case['r']\n            delta = case['delta']\n            \n            h_j_split = h_c[j_idx]\n            v_j_split = v_c[j_idx]\n            T_c = travel_time(h_c, v_c)\n\n            k_p = k_c + 1\n            h_p1, h_p2 = r * h_j_split, (1 - r) * h_j_split\n            v_p1, v_p2 = v_j_split * np.exp(delta), v_j_split * np.exp(-delta)\n            \n            h_p = h_c[:j_idx] + [h_p1, h_p2] + h_c[j_idx+1:]\n            v_p = v_c[:j_idx] + [v_p1, v_p2] + v_c[j_idx+1:]\n            T_p = travel_time(h_p, v_p)\n            \n            log_likelihood_ratio = -0.5 / SIGMA_T**2 * ((T_p - T_OBS)**2 - (T_c - T_OBS)**2)\n            log_k_prior_ratio = log_p_k(k_p) - log_p_k(k_c)\n            log_h_prior_ratio = log_p_h(h_p1) + log_p_h(h_p2) - log_p_h(h_j_split)\n            log_v_prior_ratio = log_p_v(v_p1) + log_p_v(v_p2) - log_p_v(v_j_split)\n            \n            log_proposal_ratio = np.log(get_move_prob(k_p, 'death') / k_p) - np.log(get_move_prob(k_c, 'birth') / k_c)\n            \n            log_aux_proposal_ratio = -log_f_delta(delta) # log_f_r(r) is 0\n            log_jacobian = np.log(2 * h_j_split * v_j_split)\n            \n            log_A = (log_likelihood_ratio + log_k_prior_ratio + log_h_prior_ratio + \n                     log_v_prior_ratio + log_proposal_ratio + log_aux_proposal_ratio + \n                     log_jacobian)\n\n            return min(1.0, np.exp(log_A))\n\n        # --- Handle DEATH move ---\n        elif move == 'death':\n            if k_c == K_MIN:\n                return 0.0\n\n            h_j1, h_j2 = h_c[j_idx], h_c[j_idx+1]\n            v_j1, v_j2 = v_c[j_idx], v_c[j_idx+1]\n            T_c = travel_time(h_c, v_c)\n            \n            k_p = k_c - 1\n            h_p_merged = h_j1 + h_j2\n            v_p_merged = np.sqrt(v_j1 * v_j2)\n\n            h_p = h_c[:j_idx] + [h_p_merged] + h_c[j_idx+2:]\n            v_p = v_c[:j_idx] + [v_p_merged] + v_c[j_idx+2:]\n            T_p = travel_time(h_p, v_p)\n            \n            r = h_j1 / h_p_merged\n            delta = 0.5 * np.log(v_j1 / v_j2)\n\n            log_likelihood_ratio = -0.5 / SIGMA_T**2 * ((T_p - T_OBS)**2 - (T_c - T_OBS)**2)\n            log_k_prior_ratio = log_p_k(k_p) - log_p_k(k_c)\n            log_h_prior_ratio = log_p_h(h_p_merged) - (log_p_h(h_j1) + log_p_h(h_j2))\n            log_v_prior_ratio = log_p_v(v_p_merged) - (log_p_v(v_j1) + log_p_v(v_j2))\n            \n            log_proposal_ratio = np.log(get_move_prob(k_p, 'birth') / k_p) - np.log(get_move_prob(k_c, 'death') / (k_c-1))\n\n            log_aux_proposal_ratio = log_f_delta(delta) # log_f_r(r) is 0\n            log_inv_jacobian = -np.log(2 * h_p_merged * v_p_merged)\n            \n            log_A = (log_likelihood_ratio + log_k_prior_ratio + log_h_prior_ratio + \n                     log_v_prior_ratio + log_proposal_ratio + log_aux_proposal_ratio +\n                     log_inv_jacobian)\n\n            return min(1.0, np.exp(log_A))\n            \n        return 0.0\n\n    test_cases = [\n        {'move': 'birth', 'k': 2, 'h': [500.0, 700.0], 'v': [2000.0, 2500.0], 'j': 2, 'r': 0.4, 'delta': 0.1},\n        {'move': 'death', 'k': 3, 'h': [500.0, 280.0, 420.0], 'v': [2000.0, 2762.925465, 2262.093545], 'j': 2},\n        {'move': 'death', 'k': 1, 'h': [1200.0], 'v': [2300.0], 'j': 1},\n        {'move': 'birth', 'k': 5, 'h': [300.0, 400.0, 500.0, 600.0, 700.0], 'v': [1800.0, 2000.0, 2200.0, 2400.0, 2600.0], 'j': 3, 'r': 0.5, 'delta': 0.0},\n    ]\n\n    results = [calculate_acceptance_prob(case) for case in test_cases]\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3609577"}]}