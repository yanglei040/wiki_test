{"hands_on_practices": [{"introduction": "在位场理论中，理解简单、理想化地质体的位场响应是进行数据解释的第一步。这些解析解不仅是构建复杂模型的基石，也为我们提供了关于场源和异常形态之间关系的关键直觉。本练习 [@problem_id:3613236] 要求您从基本物理原理出发，推导无限长水平圆柱体的重力和磁异常，这是一个在地球物理勘探中至关重要的二维模型。", "problem": "一个半径为 $a$ 的无限长、水平、直圆柱体埋在一个均匀的半空间中。该圆柱体的轴线平行于 $y$ 轴，其中心位于 $(x,z)=(0,z_{0})$，其中 $z$ 轴正方向朝下，观测面位于 $z=0$。假设 $z_{0}>a$，以确保观测点位于圆柱体外部。考虑两种独立的物理性质差异：\n\n1. 重力：圆柱体与围岩之间存在一个恒定的密度差 $\\Delta \\rho$。\n2. 磁学：圆柱体具有一个限于 $x$–$z$ 平面内的均匀磁化矢量 $\\mathbf{M}$，即 $\\mathbf{M} = M_{x}\\,\\hat{\\mathbf{x}} + M_{z}\\,\\hat{\\mathbf{z}}$，其沿圆柱体轴线方向没有分量。\n\n仅从以下基本原理出发：\n\n- 国际单位制（SI）下的牛顿引力理论：引力场 $\\mathbf{g}$ 为 $\\mathbf{g}(\\mathbf{r}) = -\\nabla \\Phi(\\mathbf{r})$，其中引力势 $\\Phi$ 满足 $\\nabla^{2}\\Phi = 4\\pi G \\rho$，$G$ 为引力常数，$\\rho$ 为质量密度。\n- 自由空间中的静磁学（观测区域内无传导电流）：在磁化强度为零的区域，磁场强度 $\\mathbf{H}$ 可由一个标量势 $U$ 导出，即 $\\mathbf{H} = -\\nabla U$，且 $U$ 在物体外部满足拉普拉斯方程 $\\nabla^{2}U = 0$。物体的均匀磁化强度 $\\mathbf{M}$ 产生一个等效的单位长度磁偶极矩，其大小等于截面积乘以 $\\mathbf{M}$。\n\n推导以下物理量沿地表剖面的闭合形式表达式：\n\n- 仅由该圆柱体引起的重力加速度异常的向下（$z$ 轴正向）分量 $g_{z}(x)$。\n- 仅由该圆柱体引起的自由空间中磁感应强度异常的向下（$z$ 轴正向）分量 $B_{z}(x)$，使用 $B_{z} = \\mu_{0} H_{z}$，其中 $\\mu_{0}$ 是自由空间的磁导率。\n\n你的推导必须考虑所有几何因素，包括沿剖面相对于圆柱体轴线上方垂直线的水平偏移 $x$ 和埋深 $z_{0}$。将最终结果表示为 $x$、$a$、$z_{0}$、$\\Delta \\rho$、$G$、$\\mu_{0}$、$M_{x}$ 和 $M_{z}$ 的显式函数。假设观测在 $z=0$ 处的空气中进行。提供：\n\n- $g_{z}(x)$，单位为 $\\mathrm{m}\\,\\mathrm{s}^{-2}$。\n- $B_{z}(x)$，单位为 $\\mathrm{T}$。\n\n无需进行数值计算；将每个结果以闭合解析形式呈现。最终答案必须是仅用指定符号表示的单一解析表达式，将 $g_{z}(x)$ 和 $B_{z}(x)$ 整合为一个包含两个元素的行矩阵。", "solution": "该问题被评估为有效，因为它在科学上基于牛顿引力理论和静磁学，提法恰当、客观，并包含足够的信息以获得唯一解。\n\n该问题要求推导由一个无限长水平圆柱体产生的重力异常 $g_z(x)$ 和磁异常 $B_z(x)$ 的向下垂直分量。圆柱体沿 $y$ 轴的无限延伸特性将问题简化为 $x$-$z$ 平面内的二维问题。\n\n**第一部分：重力异常 $g_z(x)$**\n\n问题提供了重力的基本原理：引力场 $\\mathbf{g}$ 是一个势 $\\Phi$ 的负梯度，$\\mathbf{g} = -\\nabla \\Phi$，其中 $\\Phi$ 满足泊松方程 $\\nabla^2\\Phi = 4\\pi G \\rho$。\n\n由于质量分布的圆柱对称性，对于圆柱体外的任何观测点，其引力场与位于圆柱体轴线上、具有相同单位长度质量的一条无限长线质量所产生的引力场相同。这是牛顿壳层定理在圆柱几何中的推广，可由引力高斯定律推导得出。\n\n圆柱体半径为 $a$，与围岩介质存在恒定的密度差 $\\Delta \\rho$。圆柱体的截面积为 $A_{cyl} = \\pi a^2$。异常质量的单位长度质量（线质量密度）为 $\\lambda = \\Delta \\rho A_{cyl} = \\pi \\Delta \\rho a^2$。\n\n圆柱体的轴线位于 $(x,z) = (0,z_0)$，观测沿地表剖面 $z=0$ 进行。因此，我们可以将源模拟为位于 $(0, z_0)$ 的无限长线质量 $\\lambda$。\n\n为了求出观测点 $\\mathbf{r}_{obs} = (x,0,0)$ 处的引力加速度 $\\mathbf{g}$，我们对位于 $\\mathbf{r}_{src} = (0, y', z_0)$ 的线源上每个质量元 $dm = \\lambda dy'$ 的贡献进行积分。从源元到观测点的矢量为 $\\mathbf{R} = \\mathbf{r}_{obs} - \\mathbf{r}_{src} = (x, -y', -z_0)$。引力场是吸引力场，因此它从观测点指向源，方向为 $-\\mathbf{R} = (-x, y', z_0)$。\n\n来自质量元 $dm$ 的场贡献由牛顿万有引力定律给出：\n$$\nd\\mathbf{g} = G \\frac{dm}{|\\mathbf{R}|^2} \\frac{-\\mathbf{R}}{|\\mathbf{R}|} = -G \\lambda dy' \\frac{(x, -y', -z_0)}{(x^2 + y'^2 + z_0^2)^{3/2}}\n$$\n我们将此表达式对 $y'$ 从 $-\\infty$ 到 $\\infty$ 积分，以求得总场 $\\mathbf{g}$。根据对称性，场的 $y$ 分量为零。我们关心的是 $z$ 分量，其定义为向下为正。\n$$\ng_z(x) = \\int_{-\\infty}^{\\infty} -G \\lambda \\frac{-z_0}{(x^2 + y'^2 + z_0^2)^{3/2}} dy' = G \\lambda z_0 \\int_{-\\infty}^{\\infty} \\frac{dy'}{(x^2 + y'^2 + z_0^2)^{3/2}}\n$$\n令 $r_p^2 = x^2+z_0^2$。该积分为一个标准形式：\n$$\n\\int_{-\\infty}^{\\infty} \\frac{dy'}{(r_p^2 + y'^2)^{3/2}} = \\left[ \\frac{y'}{r_p^2 \\sqrt{r_p^2 + y'^2}} \\right]_{-\\infty}^{\\infty} = \\frac{2}{r_p^2} = \\frac{2}{x^2+z_0^2}\n$$\n将此结果代回到 $g_z(x)$ 的表达式中：\n$$\ng_z(x) = G \\lambda z_0 \\left(\\frac{2}{x^2+z_0^2}\\right) = \\frac{2G\\lambda z_0}{x^2+z_0^2}\n$$\n最后，我们代入线质量密度 $\\lambda = \\pi \\Delta \\rho a^2$ 的表达式：\n$$\ng_z(x) = \\frac{2G(\\pi \\Delta \\rho a^2) z_0}{x^2+z_0^2} = \\frac{2\\pi G \\Delta\\rho a^2 z_0}{x^2+z_0^2}\n$$\n\n**第二部分：磁异常 $B_z(x)$**\n\n问题指出，在磁化体外部，磁场强度 $\\mathbf{H}$ 可以表示为一个标量势 $U$ 的负梯度，$\\mathbf{H} = -\\nabla U$，其中 $U$ 满足拉普拉斯方程 $\\nabla^2 U = 0$。圆柱体具有均匀磁化强度 $\\mathbf{M} = M_x \\hat{\\mathbf{x}} + M_z \\hat{\\mathbf{z}}$。等效的单位长度磁偶极矩为 $\\mathbf{m} = A_{cyl} \\mathbf{M} = \\pi a^2 \\mathbf{M}$。\n\n均匀磁化圆柱体的外部势等效于位于其中心的磁性线偶极子产生的势。我们首先推导二维线偶极子的势。三维点偶极子 $\\mathbf{p}$ 的磁标势为 $U_{3D}(\\mathbf{r}) = -\\frac{1}{4\\pi} \\frac{\\mathbf{p} \\cdot \\mathbf{r}}{r^3}$，其中 $\\mathbf{r}$ 是从偶极子到观测点的矢量。\n\n为了求出单位长度偶极矩为 $\\mathbf{m}$ 的无限长偶极子线的势，我们将三维势对无限长线源进行积分。源线位于 $x=0, z=z_0$ 且平行于 $y$ 轴。因此，一个源元位于 $(0, y', z_0)$。设观测点位于 $x-z$ 平面内的 $(x,z)$（即三维坐标为 $(x, 0, z)$）。从源元到观测点的矢量为 $\\mathbf{R} = (x, -y', z-z_0)$。偶极矩元为 $d\\mathbf{p} = \\mathbf{m} dy'$。\n$$\nU(x,z) = \\int_{-\\infty}^{\\infty} -\\frac{1}{4\\pi} \\frac{(\\mathbf{m}dy') \\cdot (x, -y', z-z_0)}{ (x^2 + y'^2 + (z-z_0)^2)^{3/2} }\n$$\n由于 $\\mathbf{m}$ 在 $x-z$ 平面内，所以 $\\mathbf{m} \\cdot (x, -y', z-z_0) = m_x x + m_z (z-z_0)$。\n$$\nU(x,z) = -\\frac{m_x x + m_z(z-z_0)}{4\\pi} \\int_{-\\infty}^{\\infty} \\frac{dy'}{(x^2 + (z-z_0)^2 + y'^2)^{3/2}}\n$$\n使用与重力情况相同的积分结果，其中 $r_p^2 = x^2+(z-z_0)^2$：\n$$\nU(x,z) = -\\frac{m_x x + m_z(z-z_0)}{4\\pi} \\left( \\frac{2}{x^2+(z-z_0)^2} \\right) = -\\frac{1}{2\\pi} \\frac{m_x x + m_z(z-z_0)}{x^2+(z-z_0)^2}\n$$\n代入 $\\mathbf{m} = \\pi a^2 \\mathbf{M} = \\pi a^2 (M_x \\hat{\\mathbf{x}} + M_z \\hat{\\mathbf{z}})$：\n$$\nU(x,z) = -\\frac{\\pi a^2}{2\\pi} \\frac{M_x x + M_z(z-z_0)}{x^2+(z-z_0)^2} = -\\frac{a^2}{2} \\frac{M_x x + M_z(z-z_0)}{x^2+(z-z_0)^2}\n$$\n磁场强度的向下分量为 $H_z = -\\frac{\\partial U}{\\partial z}$。\n$$\nH_z(x,z) = -\\frac{\\partial}{\\partial z} \\left( -\\frac{a^2}{2} \\frac{M_x x + M_z(z-z_0)}{x^2+(z-z_0)^2} \\right) = \\frac{a^2}{2} \\frac{\\partial}{\\partial z} \\left( \\frac{M_x x + M_z(z-z_0)}{x^2+(z-z_0)^2} \\right)\n$$\n使用商法则，我们得到：\n$$\nH_z(x,z) = \\frac{a^2}{2} \\frac{ M_z(x^2+(z-z_0)^2) - (M_x x + M_z(z-z_0))(2(z-z_0)) }{ (x^2+(z-z_0)^2)^2 }\n$$\n$$\nH_z(x,z) = \\frac{a^2}{2} \\frac{ M_z x^2 + M_z(z-z_0)^2 - 2M_x x (z-z_0) - 2M_z(z-z_0)^2 }{ (x^2+(z-z_0)^2)^2 }\n$$\n$$\nH_z(x,z) = \\frac{a^2}{2} \\frac{ M_z(x^2 - (z-z_0)^2) - 2M_x x (z-z_0) }{ (x^2+(z-z_0)^2)^2 }\n$$\n我们在观测表面 $z=0$ 上计算此表达式的值：\n$$\nH_z(x) = \\frac{a^2}{2} \\frac{ M_z(x^2 - (-z_0)^2) - 2M_x x (-z_0) }{ (x^2+(-z_0)^2)^2 } = \\frac{a^2}{2} \\frac{ M_z(x^2-z_0^2) + 2M_x x z_0 }{ (x^2+z_0^2)^2 }\n$$\n问题要求的是磁感应强度异常 $B_z(x) = \\mu_0 H_z(x)$。\n$$\nB_z(x) = \\frac{\\mu_0 a^2}{2} \\frac{2M_x x z_0 + M_z(x^2-z_0^2)}{(x^2+z_0^2)^2}\n$$\n推导出的 $g_z(x)$ 和 $B_z(x)$ 的表达式以所要求的矩阵格式提供。", "answer": "$$\n\\boxed{\\begin{pmatrix} \\frac{2\\pi G \\Delta\\rho a^2 z_0}{x^2+z_0^2} & \\frac{\\mu_0 a^2}{2} \\frac{2 M_x x z_0 + M_z(x^2-z_0^2)}{(x^2+z_0^2)^2} \\end{pmatrix}}\n$$", "id": "3613236"}, {"introduction": "从正演模拟转向反演解释是位场数据处理的核心环节。欧拉反褶积是一种直接根据网格化数据估算场源位置和深度的有效技术，其强大功能源于对位场齐次性的假设。本练习 [@problem_id:3613216] 将引导您推导该方法，通过编程实现它，并以定量方式检验当其核心假设被违背时方法的稳定性与误差来源。", "problem": "您将研究使用基于标量位场代理的局部均匀性的欧拉反卷积来估计源深度的稳定性。您必须从第一性原理出发，推导欧拉反卷积中使用的线性关系，不得使用任何预先推导的快捷公式；实现一个求解器，根据合成数据估计源深度；构建以可控方式违反均匀性假设的合成示例，并定量地诊断由此产生的估计误差。\n\n从以下基本基础开始：\n- 由孤立源产生的标量位场代理 $T(\\mathbf{r})$ 在源位置 $\\mathbf{r}_0$ 附近是局部 $-N$ 次齐次的，这意味着对于源附近的任何标量 $\\lambda > 0$，都有 $T(\\lambda(\\mathbf{r}-\\mathbf{r}_0)) = \\lambda^{-N} T(\\mathbf{r}-\\mathbf{r}_0)$，其中 $N$ 是一个已知的正整数，称为构造指数。\n- 齐次函数的欧拉定理指出，如果函数 $f(\\mathbf{r})$ 是 $k$ 次齐次的，则 $\\mathbf{r} \\cdot \\nabla f(\\mathbf{r}) = k f(\\mathbf{r})$。\n- 测量场可以包含一个恒定的基底水平 $B$ 和勘测区域内的平滑区域趋势。\n- 所有测量都在 $z=0$ 的水平面上进行。\n\n任务要求：\n1. 利用 $T$ 的均匀性假设和欧拉定理，从第一性原理出发，推导测量坐标 $(x,y,0)$、一阶空间导数 $\\partial T/\\partial x$、$\\partial T/\\partial y$、$\\partial T/\\partial z$、场 $T$、构造指数 $N$ 以及未知数 $(x_0,y_0,z_0,B)$ 之间的线性关系。在均匀性假设下，该关系必须对每个数据点都成立，并且必须适用于通过线性最小二乘法求解 $(x_0,y_0,z_0,B)$。\n2. 实现一个程序，该程序：\n   - 使用振幅为 $A$、位置为 $(x_0,y_0,z_0)$、构造指数为 $N_{\\text{true}}$ 的孤立源，在规则网格上生成合成标量场，其解析形式为\n     $$T(\\mathbf{r}) = \\sum_{s=1}^{S} \\frac{A_s}{\\left\\|\\mathbf{r} - \\mathbf{r}_{0,s}\\right\\|^{N_{\\text{true},s}}} + B + L_x x + L_y y,$$\n     其中 $\\mathbf{r}=(x,y,0)$ 表示观测点，$\\mathbf{r}_{0,s}=(x_{0,s},y_{0,s},z_{0,s})$ 表示第 $s$ 个源的位置。区域趋势是线性的，系数为 $L_x$ 和 $L_y$。\n   - 对构建的场解析地计算所需的空间导数。对于单个源项 $\\frac{A}{r^{N}}$，其中 $r=\\sqrt{(x-x_0)^2+(y-y_0)^2+z_0^2}$，使用链式法则推导在 $z=0$ 处的 $\\partial T/\\partial x$、$\\partial T/\\partial y$ 和 $\\partial T/\\partial z$ 的表达式。当存在多个源以及添加区域趋势时，线性叠加原理适用。\n   - 为您在第1项中的推导所隐含的线性系统组装所有网格点，并假设用户选择的构造指数为 $N_{\\text{assumed}}$，以最小二乘法求解 $(\\hat{x}_0,\\hat{y}_0,\\hat{z}_0,\\hat{B})$。\n   - 为每个合成测试案例计算两个诊断量：\n     a) 绝对深度误差 $|\\hat{z}_0 - z_{0,\\text{primary}}|$（单位：米），其中 $z_{0,\\text{primary}}$ 是目标主源的真实深度。\n     b) 归一化欧拉残差，定义为\n     $$R_{\\text{norm}} = \\frac{\\sqrt{\\frac{1}{M}\\sum_{i=1}^{M} r_i^2}}{\\sqrt{\\frac{1}{M}\\sum_{i=1}^{M} b_i^2} + \\varepsilon},$$\n     其中 $r_i$ 是代入 $(\\hat{x}_0,\\hat{y}_0,\\hat{z}_0,\\hat{B})$ 后第 $i$ 个方程的代数残差，$b_i$ 是您的推导所隐含的第 $i$ 个线性方程的右侧项，$M$ 是网格点数，$\\varepsilon$ 是一个小的正常数稳定器，以避免除以零。该残差衡量了所选模型和假设下局部均匀性被违反的程度。\n3. 使用以下网格和单位：\n   - 观测平面：$z=0$。\n   - 网格范围：$x \\in [-500, 500]$ 米，$y \\in [-500, 500]$ 米。\n   - 网格分辨率：$21 \\times 21$ 个均匀间隔点。\n   - 所有最终深度误差均以米表示，并按默认浮点表示进行四舍五入。不使用角度。\n4. 实现以下五个测试案例，以探究稳定性和均匀性违反情况。在所有案例中，计算深度误差时，应报告相对于列出的第一个源（“主源”）的结果。对于每个案例，在您的欧拉反演中使用指定的 $N_{\\text{assumed}}$，并使用指定的 $N_{\\text{true}}$ 值构建场。\n   - 案例1（孤立齐次源，理想情况）：\n     - 源：$S=1$，位置 $(x_0,y_0,z_0) = (0,0,200)$ 米，振幅 $A=1$，$N_{\\text{true}}=2$。\n     - 基底水平和趋势：$B=0$，$L_x=0$，$L_y=0$。\n     - 反演：$N_{\\text{assumed}}=2$。\n   - 案例2（存在恒定基底水平并进行建模）：\n     - 源：$S=1$，位置 $(x_0,y_0,z_0) = (0,0,200)$ 米，$A=1$，$N_{\\text{true}}=2$。\n     - 基底水平和趋势：$B=10^{-5}$，$L_x=0$，$L_y=0$。\n     - 反演：$N_{\\text{assumed}}=2$。\n   - 案例3（线性区域趋势违反均匀性）：\n     - 源：$S=1$，位置 $(x_0,y_0,z_0) = (0,0,200)$ 米，$A=1$，$N_{\\text{true}}=2$。\n     - 基底水平和趋势：$B=0$，$L_x=10^{-8}$，$L_y=-10^{-8}$。\n     - 反演：$N_{\\text{assumed}}=2$。\n   - 案例4（附近源的叠加违反了单源均匀性）：\n     - 源：$S=2$，主源 $(x_0,y_0,z_0) = (0,0,200)$ 米，振幅 $A=1$，$N_{\\text{true}}=2$；次源 $(x_0,y_0,z_0) = (150,0,150)$ 米，振幅 $A=0.6$，$N_{\\text{true}}=2$。\n     - 基底水平和趋势：$B=0$，$L_x=0$，$L_y=0$。\n     - 反演：$N_{\\text{assumed}}=2$。\n   - 案例5（构造指数不匹配）：\n     - 源：$S=1$，位置 $(x_0,y_0,z_0) = (0,0,200)$ 米，$A=1$，$N_{\\text{true}}=3$。\n     - 基底水平和趋势：$B=0$，$L_x=0$，$L_y=0$。\n     - 反演：$N_{\\text{assumed}}=2$。\n5. 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，其中每个元素是案例1到5的二元列表 $[\\text{depth\\_error\\_m}, \\text{normalized\\_residual}]$。例如：“[[e1,r1],[e2,r2],[e3,r3],[e4,r4],[e5,r5]]”。每个 $e_k$ 和 $r_k$ 都必须是浮点数。\n\n所有计算必须是自包含的，并且不得要求任何用户输入。唯一允许的外部库在执行环境中指定。最终结果必须能够根据提供的规范精确复现。", "solution": "用户希望研究用于位场解释的欧拉反卷积的稳定性。这需要从第一性原理出发进行推导，实现一个用于合成数据的求解器，并分析旨在探究该方法局限性的几个测试案例的结果。\n\n### **问题验证**\n\n**步骤1：提取已知条件**\n\n- **基本基础：**\n    - 关于源位置 $\\mathbf{r}_0$ 的标量位场代理 $T(\\mathbf{r})$ 是局部 $-N$ 次齐次的，意味着 $T(\\lambda(\\mathbf{r}-\\mathbf{r}_0)) = \\lambda^{-N} T(\\mathbf{r}-\\mathbf{r}_0)$，其中 $\\lambda > 0$ 是一个标量。$N$ 是构造指数。\n    - 齐次函数的欧拉定理：如果 $f(\\mathbf{r})$ 是 $k$ 次齐次的，则 $\\mathbf{r} \\cdot \\nabla f(\\mathbf{r}) = k f(\\mathbf{r})$。\n    - 测量场可以包含一个恒定的基底水平 $B$ 和平滑的区域趋势。\n    - 所有测量都在 $z=0$ 的水平面上进行。\n- **任务1：推导：**\n    - 使用提供的基本假设，推导未知数 $(x_0, y_0, z_0, B)$ 的线性关系。\n- **任务2：实现：**\n    - 在网格上生成合成场 $T(\\mathbf{r}) = \\sum_{s=1}^{S} \\frac{A_s}{\\left\\|\\mathbf{r} - \\mathbf{r}_{0,s}\\right\\|^{N_{\\text{true},s}}} + B + L_x x + L_y y$。\n    - 解析计算导数 $\\partial T/\\partial x$, $\\partial T/\\partial y$, $\\partial T/\\partial z$。\n    - 组装并求解线性系统，以获得 $(\\hat{x}_0, \\hat{y}_0, \\hat{z}_0, \\hat{B})$，使用选定的 $N_{\\text{assumed}}$。\n    - 计算诊断量：绝对深度误差 $|\\hat{z}_0 - z_{0,\\text{primary}}|$ 和归一化欧拉残差 $R_{\\text{norm}} = \\frac{\\sqrt{\\frac{1}{M}\\sum r_i^2}}{\\sqrt{\\frac{1}{M}\\sum b_i^2} + \\varepsilon}$。\n- **任务3：网格和单位：**\n    - 观测平面：$z=0$。\n    - 网格：$x, y \\in [-500, 500]$ 米，$21 \\times 21$ 个点。\n    - 所有深度误差单位为米。\n- **任务4：测试案例：**\n    - 案例1：理想情况。$S=1, (0,0,200), A=1, N_{\\text{true}}=2$。无区域场。$N_{\\text{assumed}}=2$。\n    - 案例2：带基底水平的理想情况。$S=1, (0,0,200), A=1, N_{\\text{true}}=2$。$B=10^{-5}$。$N_{\\text{assumed}}=2$。\n    - 案例3：区域趋势导致的违反。$S=1, (0,0,200), A=1, N_{\\text{true}}=2$。$L_x=10^{-8}, L_y=-10^{-8}$。$N_{\\text{assumed}}=2$。\n    - 案例4：源干涉导致的违反。$S=2$。主源：$(0,0,200), A=1, N_{\\text{true}}=2$。次源：$(150,0,150), A=0.6, N_{\\text{true}}=2$。$N_{\\text{assumed}}=2$。\n    - 案例5：构造指数不匹配导致的违反。$S=1, (0,0,200), A=1, N_{\\text{true}}=3$。$N_{\\text{assumed}}=2$。\n- **任务5：输出格式：**\n    - 单行：`[[e1,r1],[e2,r2],[e3,r3],[e4,r4],[e5,r5]]`。\n\n**步骤2：使用提取的已知条件进行验证**\n\n该问题在科学上基于位场理论，特别是欧拉定理在齐次场源参数估计中的应用。它定义明确，提供了构建和解决确定性计算问题所需的所有参数、方程和定义。该问题是客观的，避免了歧义。这些测试案例被系统地设计出来，用以测试该方法在面对其基本假设（存在未建模的区域趋势、多个源的干扰、不正确的模型参数化）的常见违反情况时的稳健性。该问题是自包含的，并且可以通过计算进行验证。\n\n**步骤3：结论与行动**\n\n问题是 **有效的**。将提供完整的解决方案。\n\n---\n\n### **第一部分：欧拉反卷积方程的推导**\n\n我们从提供的第一性原理出发。设总测量场为 $T_m(\\mathbf{r})$，其中 $\\mathbf{r}=(x,y,z)$ 是观测点。该场是孤立源场、恒定基底水平 $B$ 和区域趋势的叠加。欧拉反卷积方法假设源场本身是齐次的。我们定义一个代理场 $T_p(\\mathbf{r})$，它是信号中被假设为齐次的部分。在求解恒定背景 $B$ 的标准公式中，代理场是 $T_p(\\mathbf{r}) = T_m(\\mathbf{r}) - B$。区域趋势项 $L_x x + L_y y$ 被视为违反均匀性假设的未建模干扰。\n\n关键假设是源场 $T_p(\\mathbf{r})$ 是关于源位置 $\\mathbf{r}_0 = (x_0, y_0, z_0)$ 的一个 $-N$ 次齐次函数。这个性质可以通过定义一个新函数 $F(\\mathbf{v}) = T_p(\\mathbf{r}_0 + \\mathbf{v})$ 来更正式地陈述。$T_p$ 关于 $\\mathbf{r}_0$ 的齐次性意味着 $F$ 是关于原点的 $-N$ 次齐次函数。因此，对于任何标量 $\\lambda > 0$，它满足：\n$$F(\\lambda \\mathbf{v}) = \\lambda^{-N} F(\\mathbf{v})$$\n根据齐次函数的欧拉定理，$F(\\mathbf{v})$ 必须满足：\n$$\\mathbf{v} \\cdot \\nabla_{\\mathbf{v}} F(\\mathbf{v}) = -N F(\\mathbf{v})$$\n其中 $\\nabla_{\\mathbf{v}}$ 是相对于 $\\mathbf{v}$ 分量的梯度。我们现在将这个方程转换回原始坐标系 $(\\mathbf{r})$。\n令 $\\mathbf{v} = \\mathbf{r} - \\mathbf{r}_0$。微分的链式法则给出 $\\nabla_{\\mathbf{v}} = \\nabla_{\\mathbf{r}}$。代入回去，我们有：\n- $F(\\mathbf{v}) = T_p(\\mathbf{r}_0 + (\\mathbf{r}-\\mathbf{r}_0)) = T_p(\\mathbf{r})$\n- $\\nabla_{\\mathbf{v}} F(\\mathbf{v}) = \\nabla_{\\mathbf{r}} T_p(\\mathbf{r})$\n\n这导出了代理场 $T_p$ 的欧拉齐次性方程：\n$$(\\mathbf{r} - \\mathbf{r}_0) \\cdot \\nabla T_p(\\mathbf{r}) = -N T_p(\\mathbf{r})$$\n现在我们引入测量场 $T_m$ 和恒定基底水平 $B$。由于 $T_p = T_m - B$，我们有 $\\nabla T_p = \\nabla (T_m - B) = \\nabla T_m$。将这些代入齐次性方程得到：\n$$(\\mathbf{r} - \\mathbf{r}_0) \\cdot \\nabla T_m(\\mathbf{r}) = -N (T_m(\\mathbf{r}) - B)$$\n用 $\\mathbf{r}=(x,y,z)$ 和 $\\mathbf{r}_0=(x_0,y_0,z_0)$ 展开点积：\n$$(x - x_0) \\frac{\\partial T_m}{\\partial x} + (y - y_0) \\frac{\\partial T_m}{\\partial y} + (z - z_0) \\frac{\\partial T_m}{\\partial z} = -N (T_m - B)$$\n测量在 $z=0$ 的水平面上进行。代入 $z=0$ 得：\n$$(x - x_0) \\frac{\\partial T_m}{\\partial x} + (y - y_0) \\frac{\\partial T_m}{\\partial y} - z_0 \\frac{\\partial T_m}{\\partial z} = -N T_m + N B$$\n我们的目标是为未知数 $(x_0, y_0, z_0, B)$ 找到一个线性关系。我们重新整理方程，将包含未知数的项归到一边：\n$$x \\frac{\\partial T_m}{\\partial x} - x_0 \\frac{\\partial T_m}{\\partial x} + y \\frac{\\partial T_m}{\\partial y} - y_0 \\frac{\\partial T_m}{\\partial y} - z_0 \\frac{\\partial T_m}{\\partial z} = -N T_m + N B$$\n$$x_0 \\frac{\\partial T_m}{\\partial x} + y_0 \\frac{\\partial T_m}{\\partial y} + z_0 \\frac{\\partial T_m}{\\partial z} + N B = x \\frac{\\partial T_m}{\\partial x} + y \\frac{\\partial T_m}{\\partial y} + N T_m$$\n这是所需的线性关系。对于每个测量点 $(x_i, y_i)$，我们有测量场 $T_{m,i}$ 及其空间导数。构造指数 $N$ 假定为已知 ($N = N_{\\text{assumed}}$)。对于单个点 $i$，该方程可以写成矩阵形式：\n$$\n\\begin{bmatrix} \\frac{\\partial T_m}{\\partial x} & \\frac{\\partial T_m}{\\partial y} & \\frac{\\partial T_m}{\\partial z} & N_{\\text{assumed}} \\end{bmatrix}_i\n\\begin{bmatrix} x_0 \\\\ y_0 \\\\ z_0 \\\\ B \\end{bmatrix}\n=\n\\left[ x \\frac{\\partial T_m}{\\partial x} + y \\frac{\\partial T_m}{\\partial y} + N_{\\text{assumed}} T_m \\right]_i\n$$\n通过为所有 $M$ 个测量点收集这些方程，我们形成一个超定线性系统 $\\mathbf{G}\\mathbf{m} = \\mathbf{d}$，该系统可以通过线性最小二乘法求解模型参数 $\\mathbf{m} = [x_0, y_0, z_0, B]^T$。\n\n### **第二部分：解析导数**\n对于单个源项 $T_s(\\mathbf{r}) = A_s / \\|\\mathbf{r} - \\mathbf{r}_{0,s}\\|^{N_{\\text{true},s}}$，其中 $\\|\\mathbf{r} - \\mathbf{r}_{0,s}\\| = r_s$，我们可以写成 $T_s = A_s r_s^{-N_{\\text{true},s}}$。导数通过链式法则求得。其中 $r_s^2 = (x-x_{0,s})^2 + (y-y_{0,s})^2 + (z-z_{0,s})^2$：\n$$ \\frac{\\partial r_s}{\\partial x} = \\frac{x-x_{0,s}}{r_s}, \\quad \\frac{\\partial r_s}{\\partial y} = \\frac{y-y_{0,s}}{r_s}, \\quad \\frac{\\partial r_s}{\\partial z} = \\frac{z-z_{0,s}}{r_s} $$\n场项的导数是：\n$$ \\frac{\\partial T_s}{\\partial x} = \\frac{d T_s}{d r_s} \\frac{\\partial r_s}{\\partial x} = (-N_{\\text{true},s} A_s r_s^{-N_{\\text{true},s}-1}) \\left(\\frac{x-x_{0,s}}{r_s}\\right) = -N_{\\text{true},s} A_s \\frac{x-x_{0,s}}{r_s^{N_{\\text{true},s}+2}} $$\n$$ \\frac{\\partial T_s}{\\partial y} = -N_{\\text{true},s} A_s \\frac{y-y_{0,s}}{r_s^{N_{\\text{true},s}+2}} $$\n$$ \\frac{\\partial T_s}{\\partial z} = -N_{\\text{true},s} A_s \\frac{z-z_{0,s}}{r_s^{N_{\\text{true},s}+2}} $$\n对于总场 $T_m = \\sum_s T_s + B + L_x x + L_y y$，导数通过叠加获得：\n$$ \\frac{\\partial T_m}{\\partial x} = \\sum_s \\frac{\\partial T_s}{\\partial x} + L_x, \\quad \\frac{\\partial T_m}{\\partial y} = \\sum_s \\frac{\\partial T_s}{\\partial y} + L_y, \\quad \\frac{\\partial T_m}{\\partial z} = \\sum_s \\frac{\\partial T_s}{\\partial z} $$\n这些表达式在测量平面 $z=0$ 处求值。对于这个问题，我们采用一个坐标系，其中 z 轴正方向朝下。因此，深度为200米的源的坐标为 $z_0=200$。\n\n### **第三部分：测试案例的实现与分析**\n对五个指定的测试案例，实现并求解所推导的线性系统。代码生成合成数据，计算解析导数，构建矩阵系统 $\\mathbf{G}\\mathbf{m} = \\mathbf{d}$，通过最小二乘法求解 $\\mathbf{m}$，并计算所需的诊断指标：绝对深度误差和归一化欧拉残差。每个案例的结果展示了违反基本均匀性假设如何影响深度估计的准确性。\n- **案例1和2**（理想条件）：该方法表现出色，误差和残差可忽略不计，证实了推导和实现的正确性。模型求解恒定背景 $B$ 的能力得到了验证。\n- **案例3**（区域趋势）：未建模的线性趋势给计算出的导数带来了系统误差，违反了均匀性假设。这导致了显著的估计误差和更高的残差，量化了模型的不匹配程度。\n- **案例4**（源干涉）：两个不同源的场叠加产生的总场，关于任何单一点都不是齐次的。这种干涉充当了空间变化的“地质噪声”，导致主源位置的估计出现巨大误差。\n- **案例5**（构造指数不匹配）：使用不正确的构造指数 ($N_{\\text{assumed}} \\neq N_{\\text{true}}$) 从根本上错误地指定了模型中场的预期衰减率。这导致了一个病态系统和估计参数的巨大误差，突显了该方法对这一关键参数的敏感性。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n# from scipy import ...\n\ndef generate_field_and_derivatives(x_coords, y_coords, sources, regional):\n    \"\"\"\n    Generates synthetic potential field data and its spatial derivatives on a grid.\n    \n    Args:\n        x_coords (np.ndarray): 1D array of x-coordinates for the grid.\n        y_coords (np.ndarray): 1D array of y-coordinates for the grid.\n        sources (list): A list of source parameters. Each source is a dict:\n                        {'A': amplitude, 'x0': x_coord, 'y0': y_coord, \n                         'z0': z_coord, 'N_true': structural_index}.\n        regional (dict): A dict with regional field parameters:\n                         {'B': base_level, 'Lx': x_trend, 'Ly': y_trend}.\n\n    Returns:\n        tuple: A tuple containing flattened 1D arrays for T, Tx, Ty, Tz.\n    \"\"\"\n    xx, yy = np.meshgrid(x_coords, y_coords)\n    x_flat = xx.flatten()\n    y_flat = yy.flatten()\n    z_obs = 0.0\n\n    T = np.zeros_like(x_flat, dtype=np.float64)\n    Tx = np.zeros_like(x_flat, dtype=np.float64)\n    Ty = np.zeros_like(x_flat, dtype=np.float64)\n    Tz = np.zeros_like(x_flat, dtype=np.float64)\n\n    for src in sources:\n        A, x0, y0, z0, N_true = src['A'], src['x0'], src['y0'], src['z0'], src['N_true']\n        \n        r_sq = (x_flat - x0)**2 + (y_flat - y0)**2 + (z_obs - z0)**2\n        # Avoid division by zero at the source epicenter if it's on the plane\n        r_sq[r_sq == 0] = 1e-12\n        r = np.sqrt(r_sq)\n\n        r_inv_N = r**(-N_true)\n        r_inv_N_plus_2 = r**(-(N_true + 2))\n        \n        T += A * r_inv_N\n        Tx += -N_true * A * (x_flat - x0) * r_inv_N_plus_2\n        Ty += -N_true * A * (y_flat - y0) * r_inv_N_plus_2\n        Tz += -N_true * A * (z_obs - z0) * r_inv_N_plus_2\n\n    B, Lx, Ly = regional['B'], regional['Lx'], regional['Ly']\n    T += B + Lx * x_flat + Ly * y_flat\n    Tx += Lx\n    Ty += Ly\n    \n    return T, Tx, Ty, Tz\n\n\ndef solve_euler_deconvolution(x_coords, y_coords, T, Tx, Ty, Tz, N_assumed):\n    \"\"\"\n    Solves the Euler deconvolution linear system.\n\n    Args:\n        x_coords, y_coords (np.ndarray): Flattened 1D arrays of grid coordinates.\n        T, Tx, Ty, Tz (np.ndarray): Flattened 1D arrays of field and derivatives.\n        N_assumed (int): The assumed structural index for the inversion.\n\n    Returns:\n        tuple: (m_hat, G, d) where m_hat is the solution vector [x0, y0, z0, B],\n               G is the system matrix, and d is the data vector.\n    \"\"\"\n    M = len(x_coords)\n    G = np.zeros((M, 4), dtype=np.float64)\n    G[:, 0] = Tx\n    G[:, 1] = Ty\n    G[:, 2] = Tz\n    G[:, 3] = N_assumed\n\n    d = x_coords * Tx + y_coords * Ty + N_assumed * T\n\n    m_hat, _, _, _ = np.linalg.lstsq(G, d, rcond=None)\n    \n    return m_hat, G, d\n\n\ndef calculate_diagnostics(m_hat, G, d, z0_primary):\n    \"\"\"\n    Calculates the depth error and normalized residual.\n\n    Args:\n        m_hat (np.ndarray): Estimated model parameters [x0, y0, z0, B].\n        G (np.ndarray): System matrix.\n        d (np.ndarray): Data vector.\n        z0_primary (float): True depth of the primary source.\n\n    Returns:\n        tuple: (depth_error, normalized_residual).\n    \"\"\"\n    # Absolute depth error\n    z0_hat = m_hat[2]\n    depth_error = np.abs(z0_hat - z0_primary)\n\n    # Normalized Euler residual\n    residuals = d - (G @ m_hat)\n    rms_residuals = np.sqrt(np.mean(residuals**2))\n    rms_d = np.sqrt(np.mean(d**2))\n    \n    epsilon = np.finfo(float).eps\n    R_norm = rms_residuals / (rms_d + epsilon)\n    \n    return depth_error, R_norm\n\ndef run_case(case_params):\n    \"\"\"\n    Runs a single test case for Euler deconvolution.\n    \"\"\"\n    # Grid setup\n    x_grid = np.linspace(-500.0, 500.0, 21)\n    y_grid = np.linspace(-500.0, 500.0, 21)\n    \n    # Generate synthetic data\n    T, Tx, Ty, Tz = generate_field_and_derivatives(\n        x_grid, y_grid, case_params['sources'], case_params['regional']\n    )\n    \n    # Solve system\n    m_hat, G, d = solve_euler_deconvolution(\n        np.meshgrid(x_grid, y_grid)[0].flatten(),\n        np.meshgrid(x_grid, y_grid)[1].flatten(),\n        T, Tx, Ty, Tz, case_params['N_assumed']\n    )\n    \n    # Calculate diagnostics\n    depth_error, R_norm = calculate_diagnostics(\n        m_hat, G, d, case_params['primary_depth']\n    )\n    \n    return [depth_error, R_norm]\n\ndef solve():\n    \"\"\"\n    Main function to define test cases, run them, and print results.\n    \"\"\"\n    test_cases = [\n        # Case 1 (isolated homogeneous source, happy path)\n        {\n            'sources': [{'A': 1.0, 'x0': 0.0, 'y0': 0.0, 'z0': 200.0, 'N_true': 2}],\n            'regional': {'B': 0.0, 'Lx': 0.0, 'Ly': 0.0},\n            'N_assumed': 2,\n            'primary_depth': 200.0,\n        },\n        # Case 2 (constant base level present but modeled)\n        {\n            'sources': [{'A': 1.0, 'x0': 0.0, 'y0': 0.0, 'z0': 200.0, 'N_true': 2}],\n            'regional': {'B': 1e-5, 'Lx': 0.0, 'Ly': 0.0},\n            'N_assumed': 2,\n            'primary_depth': 200.0,\n        },\n        # Case 3 (linear regional trend violates homogeneity)\n        {\n            'sources': [{'A': 1.0, 'x0': 0.0, 'y0': 0.0, 'z0': 200.0, 'N_true': 2}],\n            'regional': {'B': 0.0, 'Lx': 1e-8, 'Ly': -1e-8},\n            'N_assumed': 2,\n            'primary_depth': 200.0,\n        },\n        # Case 4 (superposition of nearby sources violates single-origin homogeneity)\n        {\n            'sources': [\n                {'A': 1.0, 'x0': 0.0, 'y0': 0.0, 'z0': 200.0, 'N_true': 2},\n                {'A': 0.6, 'x0': 150.0, 'y0': 0.0, 'z0': 150.0, 'N_true': 2},\n            ],\n            'regional': {'B': 0.0, 'Lx': 0.0, 'Ly': 0.0},\n            'N_assumed': 2,\n            'primary_depth': 200.0,\n        },\n        # Case 5 (structural index mismatch)\n        {\n            'sources': [{'A': 1.0, 'x0': 0.0, 'y0': 0.0, 'z0': 200.0, 'N_true': 3}],\n            'regional': {'B': 0.0, 'Lx': 0.0, 'Ly': 0.0},\n            'N_assumed': 2,\n            'primary_depth': 200.0,\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        result = run_case(case)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3613216"}, {"introduction": "对复杂地质结构进行建模通常需要依赖于边界元法（BEM）等数值技术。其中的一个关键挑战是如何精确计算近场单元的贡献，因为此时的积分核函数呈现出近奇异性。本练习 [@problem_id:3613227] 将直面这一难题，通过对比朴素数值积分与更为精巧的奇异性减法技术，展示如何在近场计算中获得高精度的数值解。", "problem": "考虑一个质量密度恒定的均匀物体的牛顿引力，其外部的引力势满足拉普拉斯方程。在势场理论中，边界上的单层表面势表示是边界元法（BEM）的核心。设引力势由一个平面面元上的单层表示，该单层面元可能具有空间变化的等效面密度。场点的势由核函数的面积分给出。在边界元法的近场求值中需要势的法向导数，而该导数对核函数奇点很敏感。\n\n你必须实现一个程序，该程序采用两种数值策略和一个解析奇异积分，来计算由多边形棱柱顶部矩形面产生的引力势的近场法向导数，然后比较其精度。该矩形面由固定平面 $z = z_{\\mathrm{top}}$ 上的笛卡尔坐标 $x \\in [x_1,x_2]$，$y \\in [y_1,y_2]$ 定义。由面密度 $\\sigma(x,y)$ 在场点 $(x_0,y_0,z_0)$ 产生的引力势由单层积分定义为\n$$\n\\Phi(x_0,y_0,z_0) \\;=\\; G \\int_{y_1}^{y_2} \\int_{x_1}^{x_2} \\frac{\\sigma(x,y)}{\\sqrt{(x-x_0)^2 + (y-y_0)^2 + (z_{\\mathrm{top}} - z_0)^2}} \\, \\mathrm{d}x \\, \\mathrm{d}y,\n$$\n其中 $G$ 是牛顿引力常数。我们关心的沿着顶面外法向单位向量（取 $+\\hat{z}$ 方向）的法向导数是\n$$\n\\partial_n \\Phi(x_0,y_0,z_0) \\;=\\; \\frac{\\partial \\Phi}{\\partial z_0}(x_0,y_0,z_0) \\;=\\; -G \\int_{y_1}^{y_2} \\int_{x_1}^{x_2} \\frac{z_0 - z_{\\mathrm{top}}}{\\left[(x-x_0)^2 + (y-y_0)^2 + (z_{\\mathrm{top}} - z_0)^2\\right]^{3/2}} \\, \\sigma(x,y) \\, \\mathrm{d}x \\, \\mathrm{d}y.\n$$\n定义局部偏移量 $u = x - x_0$，$v = y - y_0$ 和 $z = z_0 - z_{\\mathrm{top}}$，因此对于顶面上方的场点有 $z > 0$。为了在 $z$ 很小时控制近场行为，推导并使用恒定面密度情况下的解析奇异积分。具体来说，对于矩形面元和恒定的 $\\sigma$，证明\n$$\nI_z(x_0,y_0,z; x_1,x_2,y_1,y_2) \\;=\\; \\int_{y1}^{y_2} \\int_{x1}^{x_2} \\frac{z}{\\left[u^2 + v^2 + z^2\\right]^{3/2}} \\, \\mathrm{d}x \\, \\mathrm{d}y \\;=\\; \\sum_{i \\in \\{1,2\\}} \\sum_{j \\in \\{1,2\\}} \\arctan\\!\\left( \\frac{U_i V_j}{z \\sqrt{U_i^2 + V_j^2 + z^2}} \\right),\n$$\n其中 $U_1 = x_0 - x_1$，$U_2 = x_2 - x_0$，$V_1 = y_0 - y_1$，$V_2 = y_2 - y_0$，并假设 $(x_0,y_0)$ 投影在面元内部，因此 $U_i > 0$ 且 $V_j > 0$。那么对于恒定密度 $\\sigma = \\sigma_0$，法向导数为\n$$\n\\partial_n \\Phi_{\\mathrm{const}}(x_0,y_0,z_0) \\;=\\; -G \\, \\sigma_0 \\, I_z(x_0,y_0,z; x_1,x_2,y_1,y_2).\n$$\n为了比较数值策略，考虑一个线性变化的面密度\n$$\n\\sigma(x,y) \\;=\\; \\sigma_0 \\left( 1 + \\alpha x + \\beta y \\right),\n$$\n其中 $\\alpha$ 和 $\\beta$ 为给定参数。实现 $\\partial_n \\Phi$ 的两种数值计算方法：\n\n- 对给定 $\\sigma(x,y)$ 的 $\\partial_n \\Phi$ 积分进行朴素的张量积高斯-勒让德求积，使用一个固定的、不是过高的阶数。\n- 一种带奇点相减的求积法，其中将 $\\sigma(x,y)$ 写成 $\\sigma(x,y) = \\sigma(x_0,y_0) + \\Delta\\sigma(x,y)$，使用上述公式解析地计算 $-G \\, \\sigma(x_0,y_0) \\, I_z$，然后用相同阶数的高斯-勒让德求积法对更平滑的余项\n$$\n-G \\int_{y_1}^{y_2} \\int_{x_1}^{x_2} \\Delta\\sigma(x,y) \\, \\frac{z}{\\left[u^2 + v^2 + z^2\\right]^{3/2}} \\, \\mathrm{d}x \\, \\mathrm{d}y\n$$\n进行数值积分。\n\n作为参考，使用高阶张量积高斯-勒让德求积法计算相同 $\\sigma(x,y)$ 的 $\\partial_n \\Phi$ 的高精度估计值，并将此结果视为误差评估的基准真值。使用牛顿引力常数 $G = 6.67430 \\times 10^{-11}$ $\\mathrm{m}^3 \\, \\mathrm{kg}^{-1} \\, \\mathrm{s}^{-2}$，基本面密度 $\\sigma_0$ 的单位为 $\\mathrm{kg} \\, \\mathrm{m}^{-2}$，并且所有输出都以 $\\mathrm{m} \\, \\mathrm{s}^{-2}$ 表示。反正切函数内的角度是无量纲的，但由于所有参数都是长度之比，因此不需要角度单位。\n\n几何形状与参数：\n- 矩形面元：$x \\in [0,1]$ $\\mathrm{m}$，$y \\in [0,2]$ $\\mathrm{m}$。\n- 顶部平面：$z_{\\mathrm{top}} = 1$ $\\mathrm{m}$。\n- 基本面密度：$\\sigma_0 = 5000$ $\\mathrm{kg} \\, \\mathrm{m}^{-2}$。\n- 高斯-勒让德阶数：朴素求积法和奇点相减法应在每个方向上使用 $n = 16$ 阶；参考值应在每个方向上使用 $n_{\\mathrm{ref}} = 120$ 阶。\n\n场点和密度参数的测试套件：\n- 情况 1：$(x_0,y_0,z_0) = (0.5,1.0,1.0 + 10^{-3})$ $\\mathrm{m}$，$\\alpha = 0$，$\\beta = 0$。\n- 情况 2：$(x_0,y_0,z_0) = (0.5,1.0,1.0 + 10^{-3})$ $\\mathrm{m}$，$\\alpha = 0.5$ $\\mathrm{m}^{-1}$，$\\beta = -0.3$ $\\mathrm{m}^{-1}$。\n- 情况 3：$(x_0,y_0,z_0) = (1.0 - 10^{-6},1.0,1.0 + 10^{-4})$ $\\mathrm{m}$，$\\alpha = 0$，$\\beta = 0$。\n- 情况 4：$(x_0,y_0,z_0) = (1.0 - 10^{-6},2.0 - 10^{-6},1.0 + 10^{-4})$ $\\mathrm{m}$，$\\alpha = 0.5$ $\\mathrm{m}^{-1}$，$\\beta = 0.5$ $\\mathrm{m}^{-1}$。\n- 情况 5：$(x_0,y_0,z_0) = (0.5,1.0,1.0 + 10^{-1})$ $\\mathrm{m}$，$\\alpha = 0$，$\\beta = 0$。\n\n你的程序必须：\n- 实现上述的解析奇异积分 $I_z$。\n- 对给定的 $\\sigma(x,y)$，实现 $\\partial_n \\Phi$ 的朴素求积法和奇点相减求积法。\n- 实现高阶参考求积法并将其用作基准真值。\n- 对每个测试用例，计算两个浮点数：朴素求积法相对于参考值的绝对误差，以及奇点相减求积法相对于参考值的绝对误差。这些值必须以 $\\mathrm{m} \\, \\mathrm{s}^{-2}$ 表示。\n\n最终输出格式：\n你的程序应生成一行输出，其中包含一个逗号分隔的列表，用方括号括起来，值的顺序如下\n$$\n[\\mathrm{err}_{\\mathrm{naive},1},\\mathrm{err}_{\\mathrm{sub},1},\\mathrm{err}_{\\mathrm{naive},2},\\mathrm{err}_{\\mathrm{sub},2},\\mathrm{err}_{\\mathrm{naive},3},\\mathrm{err}_{\\mathrm{sub},3},\\mathrm{err}_{\\mathrm{naive},4},\\mathrm{err}_{\\mathrm{sub},4},\\mathrm{err}_{\\mathrm{naive},5},\\mathrm{err}_{\\mathrm{sub},5}],\n$$\n其中 $\\mathrm{err}_{\\mathrm{naive},k}$ 和 $\\mathrm{err}_{\\mathrm{sub},k}$ 分别表示情况 $k$ 的绝对误差，单位为 $\\mathrm{m} \\, \\mathrm{s}^{-2}$，不含任何附加文本或空格。", "solution": "基本任务是计算在一个位于恒定高程 $z=z_{\\mathrm{top}}$、由 $x \\in [x_1, x_2]$ 和 $y \\in [y_1, y_2]$ 定义的平面矩形表面附近的点 $(x_0, y_0, z_0)$ 处的引力势法向导数 $\\partial_n\\Phi$。该势是由具有空间变化面密度 $\\sigma(x,y)$ 的单层质量产生的。法向取为正 $\\hat{z}$ 方向。\n\n势 $\\Phi$ 的法向导数由以下积分给出：\n$$\n\\partial_n \\Phi(x_0,y_0,z_0) \\;=\\; \\frac{\\partial \\Phi}{\\partial z_0}(x_0,y_0,z_0) \\;=\\; -G \\int_{y_1}^{y_2} \\int_{x_1}^{x_2} \\frac{z_0 - z_{\\mathrm{top}}}{\\left[(x-x_0)^2 + (y-y_0)^2 + (z_{\\mathrm{top}} - z_0)^2\\right]^{3/2}} \\, \\sigma(x,y) \\, \\mathrm{d}x \\, \\mathrm{d}y\n$$\n其中 $G$ 是引力常数。使用局部坐标 $u=x-x_0$，$v=y-y_0$ 和 $z=z_0-z_{\\mathrm{top}}$（其中 $z>0$ 表示场点位于表面上方），表达式简化为：\n$$\n\\partial_n \\Phi \\;=\\; -G \\int_{y_1}^{y_2} \\int_{x_1}^{x_2} \\sigma(x,y) \\, K(x-x_0, y-y_0, z) \\, \\mathrm{d}x \\, \\mathrm{d}y\n$$\n其中积分核为 $K(u,v,z) = z / (u^2 + v^2 + z^2)^{3/2}$。\n\n主要挑战出现在“近场”求值中，此时距离 $z$ 相对于面元的尺寸很小。在这种情况下，当积分点 $(x,y)$ 趨近于场点的投影 $(x_0,y_0)$ 时，核函数 $K$ 会变得非常尖锐。核函数在 $(u,v)=(0,0)$ 处的值为 $1/z^2$，当 $z \\to 0$ 时，该值迅速增大。这种近奇异行为对标准数值求积方案（如高斯-勒让德求积法）构成了重大挑战，因为这些方案是为平滑函数设计的。\n\n对于恒定面密度 $\\sigma(x,y) = \\sigma_0$ 的特殊情况，该积分可以解析求解。此时法向导数为：\n$$\n\\partial_n \\Phi_{\\mathrm{const}} = -G \\sigma_0 I_z, \\quad \\text{其中} \\quad I_z = \\int_{y_1}^{y_2} \\int_{x_1}^{x_2} \\frac{z}{\\left[(x-x_0)^2 + (y-y_0)^2 + z^2\\right]^{3/2}} \\, \\mathrm{d}x \\, \\mathrm{d}y\n$$\n矩形上的定积分 $I_z$ 有一个以反正切函数表示的封闭解，其物理意义是矩形在场点所张的立体角：\n$$\nI_z(x_0,y_0,z; x_1,x_2,y_1,y_2) \\;=\\; \\sum_{i \\in \\{1,2\\}} \\sum_{j \\in \\{1,2\\}} \\arctan\\!\\left( \\frac{U_i V_j}{z \\sqrt{U_i^2 + V_j^2 + z^2}} \\right)\n$$\n其中 $U_1 = x_0 - x_1$，$U_2 = x_2 - x_0$，$V_1 = y_0 - y_1$ 和 $V_2 = y_2 - y_0$。此公式在投影点 $(x_0,y_0)$ 位于面元内部时有效，确保了 $U_i > 0$ 和 $V_j > 0$。\n\n对于线性变化密度 $\\sigma(x,y) = \\sigma_0 ( 1 + \\alpha x + \\beta y )$，我们比较两种数值策略。\n\n1.  **朴素高斯-勒让德求积法：** 此方法直接将一个 $n \\times n$ 张量积高斯-勒让德求积法则应用于 $\\partial_n\\Phi$ 的完整积分。这包括将积分域 $[x_1, x_2] \\times [y_1, y_2]$ 变换到规范正方形 $[-1, 1]^2$，并将积分近似为被积函数在映射后的高斯节点上求值的加权和。由于核函数在 $z$ 很小时具有尖峰特性，除非使用非常高的求积阶数 $n$，否则该方法预计精度较低。\n\n2.  **奇点相减法：** 该技术在数值积分前对被积函数进行正则化。面密度 $\\sigma(x,y)$ 被分为两部分：其在场点投影处的值 $\\sigma(x_0,y_0)$ 和余项 $\\Delta\\sigma(x,y) = \\sigma(x,y) - \\sigma(x_0,y_0)$。\n    $$\n    \\sigma(x,y) = \\sigma(x_0, y_0) + \\Delta\\sigma(x,y)\n    $$\n    $\\partial_n\\Phi$ 的积分相应地分为奇异部分和正则部分：\n    $$\n    \\partial_n\\Phi = \\underbrace{-G \\sigma(x_0, y_0) \\int_{y_1}^{y_2} \\int_{x_1}^{x_2} K \\, \\mathrm{d}x\\mathrm{d}y}_{\\text{奇异部分（解析）}} \\quad \\underbrace{-G \\int_{y_1}^{y_2} \\int_{x_1}^{x_2} \\Delta\\sigma(x,y) K \\, \\mathrm{d}x\\mathrm{d}y}_{\\text{正则部分（数值）}}\n    $$\n    奇异部分在数学上与恒定密度 $\\sigma(x_0, y_0)$ 的积分相同，因此可以使用 $I_z$ 公式进行解析计算。正则部分涉及被积函数 $\\Delta\\sigma(x,y) K$。对于给定的线性密度，$\\Delta\\sigma(x,y) = \\sigma_0(\\alpha(x-x_0) + \\beta(y-y_0))$。当 $(x,y) \\to (x_0,y_0)$ 时，此项趋于 $0$，有效地消除了核函数 $K$ 的奇点。得到的被积函数是一个平滑、性质良好的函数，可以使用低阶高斯-勒让德求积法精确积分。\n\n为了评估精度，将两种方法的结果与一个高精度参考解进行比较，该参考解是使用一个非常高阶的高斯-勒让德求积法（$n_{\\mathrm{ref}}=120 \\times 120$）对原始积分计算得出的。每种方法的结果与此参考值之间的绝对差量化了数值误差。该实现将表明，对于近场求值，奇点相减法在相同计算成本下（即相同的求積阶数 $n$），其精度相比朴素方法有显著提高。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import roots_legendre\n\ndef solve():\n    \"\"\"\n    Solves the potential field theory problem by comparing naive quadrature\n    and singularity subtraction for evaluating a nearly singular integral.\n    \"\"\"\n    \n    # Define physical and geometric constants\n    G_CONST = 6.67430e-11  # m^3 kg^-1 s^-2\n    SIGMA0 = 5000.0  # kg m^-2\n    X1, X2 = 0.0, 1.0  # m\n    Y1, Y2 = 0.0, 2.0  # m\n    Z_TOP = 1.0  # m\n\n    # Define numerical parameters\n    N_QUAD = 16\n    N_REF = 120\n\n    # Define the test cases from the problem statement.\n    # Format: ((x0, y0, z0), (alpha, beta))\n    test_cases = [\n        ((0.5, 1.0, 1.0 + 1e-3), (0.0, 0.0)),\n        ((0.5, 1.0, 1.0 + 1e-3), (0.5, -0.3)),\n        ((1.0 - 1e-6, 1.0, 1.0 + 1e-4), (0.0, 0.0)),\n        ((1.0 - 1e-6, 2.0 - 1e-6, 1.0 + 1e-4), (0.5, 0.5)),\n        ((0.5, 1.0, 1.0 + 1e-1), (0.0, 0.0)),\n    ]\n\n    memoized_quad_nodes = {}\n\n    def get_quad_nodes(n):\n        \"\"\"Memoized retrieval of Gauss-Legendre nodes and weights.\"\"\"\n        if n in memoized_quad_nodes:\n            return memoized_quad_nodes[n]\n        else:\n            nodes, weights = roots_legendre(n)\n            memoized_quad_nodes[n] = (nodes, weights)\n            return nodes, weights\n\n    def analytic_I_z(x0, y0, z, x1, x2, y1, y2):\n        \"\"\"Computes the analytic integral for constant density.\"\"\"\n        U = np.array([x0 - x1, x2 - x0])\n        V = np.array([y0 - y1, y2 - y0])\n        total_angle = 0.0\n        for u_val in U:\n            for v_val in V:\n                root_term = np.sqrt(u_val**2 + v_val**2 + z**2)\n                # The problem constraints ensure z > 0 and root_term > 0\n                arg = (u_val * v_val) / (z * root_term)\n                total_angle += np.arctan(arg)\n        return total_angle\n\n    def gauss_quad_2d(func, x1, x2, y1, y2, n):\n        \"\"\"Performs 2D Gauss-Legendre quadrature of func using n*n points.\"\"\"\n        nodes, weights = get_quad_nodes(n)\n        \n        x_mapped = 0.5 * (x2 - x1) * nodes + 0.5 * (x2 + x1)\n        y_mapped = 0.5 * (y2 - y1) * nodes + 0.5 * (y2 + y1)\n\n        xv, yv = np.meshgrid(x_mapped, y_mapped)\n        wv = np.outer(weights, weights)\n\n        f_vals = func(xv, yv)\n        \n        integral = np.sum(wv * f_vals)\n        integral *= 0.25 * (x2 - x1) * (y2 - y1)\n        return integral\n\n    results = []\n    for case in test_cases:\n        (x0, y0, z0), (alpha, beta) = case\n        z = z0 - Z_TOP\n        \n        def sigma_func(x, y):\n            return SIGMA0 * (1.0 + alpha * x + beta * y)\n\n        def kernel(x, y):\n            return z / ((x - x0)**2 + (y - y0)**2 + z**2)**1.5\n\n        # 1. High-accuracy reference calculation\n        integrand_ref = lambda x, y: sigma_func(x, y) * kernel(x, y)\n        ref_val = -G_CONST * gauss_quad_2d(integrand_ref, X1, X2, Y1, Y2, N_REF)\n\n        # 2. Naive quadrature calculation\n        integrand_naive = lambda x, y: sigma_func(x, y) * kernel(x, y)\n        naive_val = -G_CONST * gauss_quad_2d(integrand_naive, X1, X2, Y1, Y2, N_QUAD)\n\n        # 3. Singularity subtraction calculation\n        sigma_at_x0y0 = sigma_func(x0, y0)\n        \n        # Analytic part\n        analytic_part_integral = analytic_I_z(x0, y0, z, X1, X2, Y1, Y2)\n        analytic_val = -G_CONST * sigma_at_x0y0 * analytic_part_integral\n        \n        # Numerical part (regular integrand)\n        def integrand_sub(x, y):\n            delta_sigma = SIGMA0 * (alpha * (x - x0) + beta * (y - y0))\n            return delta_sigma * kernel(x, y)\n        \n        # Only compute if there is a variable part\n        if abs(alpha) > 0 or abs(beta) > 0:\n            numeric_val = -G_CONST * gauss_quad_2d(integrand_sub, X1, X2, Y1, Y2, N_QUAD)\n        else: # delta_sigma is zero everywhere\n            numeric_val = 0.0\n\n        sub_val = analytic_val + numeric_val\n\n        # Calculate and store absolute errors\n        err_naive = abs(naive_val - ref_val)\n        err_sub = abs(sub_val - ref_val)\n        results.extend([err_naive, err_sub])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.15e}' for r in results)}]\")\n\nsolve()\n```", "id": "3613227"}]}