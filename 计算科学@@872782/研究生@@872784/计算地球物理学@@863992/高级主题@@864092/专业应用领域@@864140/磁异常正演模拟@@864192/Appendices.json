{"hands_on_practices": [{"introduction": "正演模拟的基础是从已知的磁源分布计算其产生的磁场。这个实践练习将从最基本的第一性原理出发，指导你通过将一个三维地质体（长方体）离散化为大量微小的磁偶极子点源，并利用叠加原理，来构建一个完整的正演模型。通过从零开始实现这一过程，你将具体理解连续的物理定律如何转化为可执行的计算算法，并为模拟更复杂的地质结构建立核心技能[@problem_id:3597743]。", "problem": "一个均匀磁化的长方体棱镜被埋在一个平坦的观测表面之下。该棱镜沿东（$x$）轴方向尺寸为 $200\\,\\mathrm{m}$，沿北（$y$）轴方向尺寸为 $300\\,\\mathrm{m}$，沿垂直（$z$）轴方向厚度为 $100\\,\\mathrm{m}$。坐标系定义为 $x$ 轴指向东，$y$ 轴指向北，$z$ 轴指向上，地面位于 $z=0$。该棱镜水平中心位于原点 $\\left(x=0,y=0\\right)$，其顶面位于 $z=-50\\,\\mathrm{m}$，底面位于 $z=-150\\,\\mathrm{m}$。磁化矢量 $\\mathbf{M}$ 在棱镜内部是均匀的，与地球主磁场方向 $\\mathbf{H}_0$ 对齐，其磁倾角 $I=65^\\circ$（向下为正），磁偏角 $D=-20^\\circ$（从北向东顺时针）。磁化强度的大小为 $\\|\\mathbf{M}\\|=3\\,\\mathrm{A/m}$，自由空间的磁导率为 $\\mu_0=4\\pi\\times 10^{-7}\\,\\mathrm{H/m}$。\n\n任务是在离地面指定高度的水平观测网格上，对总场磁异常进行正演模拟。总场磁异常的定义使用了相对于地球主磁场强度而言对于小异常有效的线性化方法，即异常磁感应强度 $\\mathbf{B}_{\\text{anom}}$ 在沿 $\\mathbf{H}_0$ 方向的单位矢量上的投影。设单位矢量为 $\\hat{\\mathbf{u}}_H$，则观测点的总场磁异常为 $b_T=\\hat{\\mathbf{u}}_H\\cdot \\mathbf{B}_{\\text{anom}}$，单位为纳特斯拉（nanotesla）。单位矢量 $\\hat{\\mathbf{u}}_H$ 必须根据给定的磁倾角和磁偏角（单位为度），并基于上述定义的坐标轴来构建。\n\n从静磁学的第一性原理和一个物理上合理的数值近似出发，推导一种算法来计算异常场。该算法将均匀磁化的棱镜表示为许多小磁偶极子的叠加，每个偶极子的磁矩为 $\\mathrm{d}\\mathbf{m}=\\mathbf{M}\\,\\mathrm{d}V$，并在观测点上对它们的贡献求和。位于位置 $\\mathbf{r}_0$、磁矩为 $\\mathbf{m}$ 的点偶极子在 $\\mathbf{r}$ 处产生的磁感应强度必须作为物理上正确的叠加核函数。在构建 $\\hat{\\mathbf{u}}_H$ 之前，您必须明确地将角度 $I$ 和 $D$ 从度转换为弧度。\n\n定义“峰值振幅”为整个网格上总场磁异常绝对值的最大值，即 $\\max|\\!b_T\\!|$，并定义“足迹面积”为网格节点上 $|b_T|\\ge 0.5\\times \\max|\\!b_T\\!|$ 的区域面积（单位为平方米），通过使用网格间距平方的黎曼和进行近似计算。\n\n您必须将该算法实现为一个完整的、可运行的程序，为以下测试套件生成数值结果。所有给定的角度都必须按度处理，但内部数值计算必须使用弧度。所有磁异常振幅必须以纳特斯拉报告，足迹面积必须以平方米报告。\n\n测试套件：\n1. 基准案例：高度 $z=+100\\,\\mathrm{m}$（地面以上），观测网格覆盖 $x\\in[-500,500]\\,\\mathrm{m}$ 和 $y\\in[-500,500]\\,\\mathrm{m}$，均匀间距 $\\Delta=25\\,\\mathrm{m}$。\n2. 远场案例：高度 $z=+500\\,\\mathrm{m}$，观测网格覆盖 $x\\in[-500,500]\\,\\mathrm{m}$ 和 $y\\in[-500,500]\\,\\mathrm{m}$，均匀间距 $\\Delta=25\\,\\mathrm{m}$。\n3. 粗分辨率案例：高度 $z=+100\\,\\mathrm{m}$，观测网格覆盖 $x\\in[-300,300]\\,\\mathrm{m}$ 和 $y\\in[-300,300]\\,\\mathrm{m}$，均匀间距 $\\Delta=50\\,\\mathrm{m}$。\n\n对于每个案例，计算：\n- 峰值振幅 $\\max|\\!b_T\\!|$，单位为纳特斯拉，四舍五入到一位小数，\n- 足迹面积，单位为平方米，计算方式为 $\\text{count}\\times \\Delta^2$ 并报告为整数。\n\n您的程序应生成单行输出，包含一个由方括号括起来的逗号分隔列表。其中每个测试案例的结果本身是一个双元素列表 $[\\text{peak},\\text{area}]$。例如，输出格式必须与以下完全一样：\n$[\\,[p_1,a_1],[p_2,a_2],[p_3,a_3]\\,]$\n其中 $p_i$ 是以纳特斯拉为单位的浮点值，$a_i$ 是以平方米为单位的整数。", "solution": "该问题要求计算由一个均匀磁化的长方体棱镜产生的总场磁异常。解决方案将从第一性原理出发，使用数值近似方法进行开发，即把连续的源体积离散化为一系列点磁偶极子。然后根据叠加原理计算总场。\n\n该问题被确定为有效，因为它在静磁学方面有科学依据，所有必要参数均已提供，问题设定良好，并且其表述是客观的。它代表了计算地球物理学中的一个标准正演模拟任务。\n\n推导和算法设计过程如下：\n\n**1. 坐标系与场方向的定义**\n问题指定了一个右手笛卡尔坐标系，其中 $x$ 轴指向东，$y$ 轴指向北，$z$ 轴指向上。地面是 $z=0$ 平面。\n\n地球主磁场的方向由磁傾角 $I=65^\\circ$ 和磁偏角 $D=-20^\\circ$ 给出，该方向既定义了磁化强度 $\\mathbf{M}$ 的方向，也定义了总场磁异常的投影方向。磁倾角是与水平面之间的夹角，向下为正。磁偏角是与正北方向的夹角，问题中说明负角度对应于从北向东的顺时针旋转。假设采用标准的地球物理约定，即正磁偏角为北偏东，则 $D=-20^\\circ$ 的磁偏角对应于北偏西 $20^\\circ$ 的方向。\n\n沿主磁场方向的单位矢量 $\\hat{\\mathbf{u}}_H$ 在 $(x, y, z)$ 坐标系中构建。首先，必须将角度转换为弧度：$I_{rad} = I \\cdot \\pi/180$ 和 $D_{rad} = D \\cdot \\pi/180$。然后，$\\hat{\\mathbf{u}}_H$ 的分量为：\n$$ \\hat{u}_{H,x} = \\cos(I_{rad}) \\sin(D_{rad}) $$\n$$ \\hat{u}_{H,y} = \\cos(I_{rad}) \\cos(D_{rad}) $$\n$$ \\hat{u}_{H,z} = -\\sin(I_{rad}) $$\n$z$ 分量中的负号是因为磁倾角 $I$ 向下为正，而 $z$ 轴向上为正。磁化矢量 $\\mathbf{M}$ 由 $\\mathbf{M} = \\|\\mathbf{M}\\| \\hat{\\mathbf{u}}_H$ 给出，其大小为 $\\|\\mathbf{M}\\| = 3\\,\\mathrm{A/m}$。\n\n**2. 点磁偶极子的磁场**\n我们模型的基本构建单元是点磁偶极子产生的磁感应场 $\\mathbf{B}$。对于一个位于位置 $\\mathbf{r}'$、磁矩为 $\\mathbf{m}$ 的偶极子，在观测点 $\\mathbf{r}$ 处的场由以下表达式给出：\n$$ \\mathbf{B}(\\mathbf{r}) = \\frac{\\mu_0}{4\\pi} \\left( \\frac{3(\\mathbf{m} \\cdot \\mathbf{R})\\mathbf{R}}{\\|\\mathbf{R}\\|^5} - \\frac{\\mathbf{m}}{\\|\\mathbf{R}\\|^3} \\right) $$\n其中 $\\mathbf{R} = \\mathbf{r} - \\mathbf{r}'$ 是从源点到观测点的位移矢量，$\\mu_0 = 4\\pi \\times 10^{-7}\\,\\mathrm{H/m}$ 是自由空间的磁导率。\n\n**3. 源棱镜的离散化**\n源是一个长方体棱镜，尺寸为 $200\\,\\mathrm{m}$（$x$ 轴）、$300\\,\\mathrm{m}$（$y$ 轴）和 $100\\,\\mathrm{m}$（$z$ 轴），中心位于 $(x=0, y=0)$。其顶面位于 $z=-50\\,\\mathrm{m}$，底面位于 $z=-150\\,\\mathrm{m}$。因此，该棱镜占据了由 $x \\in [-100, 100]\\,\\mathrm{m}$、$y \\in [-150, 150]\\,\\mathrm{m}$ 和 $z \\in [-150, -50]\\,\\mathrm{m}$ 定义的体积。\n\n为了数值计算该场，我们将此体积离散化为一组小的、连续的立方体素。设棱镜被划分为 $N_x \\times N_y \\times N_z$个体素。每个由 $(i,j,k)$ 索引的体素，其微小体积为 $\\mathrm{d}V$。由于磁化强度 $\\mathbf{M}$ 是均匀的，每个体素的磁矩为：\n$$ \\mathbf{m}_{ijk} = \\mathbf{M} \\, \\mathrm{d}V $$\n每个体素由一个具有此磁矩的点偶极子表示，该偶极子位于体素中心 $\\mathbf{r}'_{ijk}$。\n\n**4. 总异常场的叠加**\n观测点 $\\mathbf{r}_{obs}$ 处的总异常磁感应强度 $\\mathbf{B}_{\\text{anom}}$ 是所有单个偶极子产生场的矢量和：\n$$ \\mathbf{B}_{\\text{anom}}(\\mathbf{r}_{obs}) = \\sum_{i,j,k} \\mathbf{B}_{ijk}(\\mathbf{r}_{obs}) = \\sum_{i,j,k} \\frac{\\mu_0}{4\\pi} \\left( \\frac{3(\\mathbf{m}_{ijk} \\cdot \\mathbf{R}_{ijk})\\mathbf{R}_{ijk}}{\\|\\mathbf{R}_{ijk}\\|^5} - \\frac{\\mathbf{m}_{ijk}}{\\|\\mathbf{R}_{ijk}\\|^3} \\right) $$\n其中 $\\mathbf{R}_{ijk} = \\mathbf{r}_{obs} - \\mathbf{r}'_{ijk}$。由于对所有体素而言 $\\mathbf{m}_{ijk} = \\mathbf{M} \\, \\mathrm{d}V$ 都是相同的，这可以写作：\n$$ \\mathbf{B}_{\\text{anom}}(\\mathbf{r}_{obs}) = \\frac{\\mu_0 \\, \\mathrm{d}V}{4\\pi} \\sum_{i,j,k} \\left( \\frac{3(\\mathbf{M} \\cdot \\mathbf{R}_{ijk})\\mathbf{R}_{ijk}}{\\|\\mathbf{R}_{ijk}\\|^5} - \\frac{\\mathbf{M}}{\\|\\mathbf{R}_{ijk}\\|^3} \\right) $$\n\n**5. 总场异常的推导**\n总场异常 $b_T$ 是异常场矢量 $\\mathbf{B}_{\\text{anom}}$ 在地球主磁场方向 $\\hat{\\mathbf{u}}_H$ 上的投影。\n$$ b_T(\\mathbf{r}_{obs}) = \\hat{\\mathbf{u}}_H \\cdot \\mathbf{B}_{\\text{anom}}(\\mathbf{r}_{obs}) $$\n代入 $\\mathbf{B}_{\\text{anom}}$ 的表达式并分配点积，得到：\n$$ b_T(\\mathbf{r}_{obs}) = \\frac{\\mu_0 \\, \\mathrm{d}V}{4\\pi} \\sum_{i,j,k} \\left( \\frac{3(\\mathbf{M} \\cdot \\mathbf{R}_{ijk})(\\hat{\\mathbf{u}}_H \\cdot \\mathbf{R}_{ijk})}{\\|\\mathbf{R}_{ijk}\\|^5} - \\frac{\\hat{\\mathbf{u}}_H \\cdot \\mathbf{M}}{\\|\\mathbf{R}_{ijk}\\|^3} \\right) $$\n一个关键的简化来自于磁化是感应产生的，因此与地球磁场对齐：$\\mathbf{M} = \\|\\mathbf{M}\\| \\hat{\\mathbf{u}}_H$。将此代入方程得到：\n$$ \\hat{\\mathbf{u}}_H \\cdot \\mathbf{M} = \\hat{\\mathbf{u}}_H \\cdot (\\|\\mathbf{M}\\| \\hat{\\mathbf{u}}_H) = \\|\\mathbf{M}\\| (\\hat{\\mathbf{u}}_H \\cdot \\hat{\\mathbf{u}}_H) = \\|\\mathbf{M}\\| $$\n$$ \\mathbf{M} \\cdot \\mathbf{R}_{ijk} = (\\|\\mathbf{M}\\| \\hat{\\mathbf{u}}_H) \\cdot \\mathbf{R}_{ijk} = \\|\\mathbf{M}\\| (\\hat{\\mathbf{u}}_H \\cdot \\mathbf{R}_{ijk}) $$\n$b_T$ 的表达式简化为：\n$$ b_T(\\mathbf{r}_{obs}) = \\frac{\\mu_0 \\|\\mathbf{M}\\| \\mathrm{d}V}{4\\pi} \\sum_{i,j,k} \\left( \\frac{3(\\hat{\\mathbf{u}}_H \\cdot \\mathbf{R}_{ijk})^2}{\\|\\mathbf{R}_{ijk}\\|^5} - \\frac{1}{\\|\\mathbf{R}_{ijk}\\|^3} \\right) $$\n这个最终形式在计算上是高效的，因为它涉及使用预先计算好的矢量的标量运算。结果必须乘以 $10^9$ 以从特斯拉（$T$）转换为纳特斯拉（$nT$）。\n\n**6. 算法和度量指标**\n算法流程如下：\n1.  定义物理常数和问题参数。\n2.  计算单位矢量 $\\hat{\\mathbf{u}}_H$ 的分量。\n3.  将源棱镜离散化为体素网格，并确定它们的中心坐标 $\\mathbf{r}'_{ijk}$ 和体积 $\\mathrm{d}V$。为平衡精度和计算成本，选择 $10\\,\\mathrm{m} \\times 10\\,\\mathrm{m} \\times 10\\,\\mathrm{m}$ 的体素大小是合理的。\n4.  对每个测试案例，定义观测点网格 $\\mathbf{r}_{obs}$。\n5.  对每个观测点，计算 $b_T$ 最终表达式中的求和。为提高效率，最好使用矢量化计算来执行此操作。\n6.  将求和结果乘以预因子 $\\frac{\\mu_0 \\|\\mathbf{M}\\| \\mathrm{d}V}{4\\pi}$（简化为 $10^{-7} \\|\\mathbf{M}\\| \\mathrm{d}V$）并转换为纳特斯拉。\n7.  在整个网格上计算出异常 $b_T$ 后，计算所需的度量指标：\n    -   峰值振幅：$\\max|\\!b_T\\!|$。\n    -   足迹面积：$|b_T| \\geq 0.5 \\times \\max|\\!b_T\\!|$ 的区域面积。通过计算满足此条件的网格节点数并乘以每个节点的面积 $\\Delta^2$ 来近似。\n然后按规定格式化结果。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the total-field magnetic anomaly from a uniformly magnetized prism\n    using a dipole summation method for specified observation grids.\n    \"\"\"\n    \n    # 1. Define constants and source parameters\n    MU0 = 4 * np.pi * 1e-7  # Permeability of free space (H/m)\n    M_mag = 3.0  # Magnitude of magnetization (A/m)\n    I_deg = 65.0  # Inclination (degrees, positive down)\n    D_deg = -20.0  # Declination (degrees, clockwise from north towards east)\n\n    # Prism geometry\n    prism_bounds = {\n        'x': np.array([-100.0, 100.0]),\n        'y': np.array([-150.0, 150.0]),\n        'z': np.array([-150.0, -50.0])\n    }\n\n    # 2. Vector definitions\n    # Convert angles to radians\n    I_rad = np.deg2rad(I_deg)\n    D_rad = np.deg2rad(D_deg)\n\n    # Unit vector for Earth's main field (and magnetization)\n    # x: East, y: North, z: Up\n    uH = np.array([\n        np.cos(I_rad) * np.sin(D_rad),\n        np.cos(I_rad) * np.cos(D_rad),\n        -np.sin(I_rad)\n    ])\n\n    # 3. Discretize the source prism into dipole sources\n    cell_dim = 10.0  # Voxel edge length in meters\n    dV = cell_dim**3  # Voxel volume\n\n    nx = int((prism_bounds['x'][1] - prism_bounds['x'][0]) / cell_dim)\n    ny = int((prism_bounds['y'][1] - prism_bounds['y'][0]) / cell_dim)\n    nz = int((prism_bounds['z'][1] - prism_bounds['z'][0]) / cell_dim)\n\n    # Voxel center coordinates\n    x_src = np.linspace(prism_bounds['x'][0] + cell_dim / 2, prism_bounds['x'][1] - cell_dim / 2, nx)\n    y_src = np.linspace(prism_bounds['y'][0] + cell_dim / 2, prism_bounds['y'][1] - cell_dim / 2, ny)\n    z_src = np.linspace(prism_bounds['z'][0] + cell_dim / 2, prism_bounds['z'][1] - cell_dim / 2, nz)\n\n    xx_src, yy_src, zz_src = np.meshgrid(x_src, y_src, z_src, indexing='ij')\n    r_prime = np.vstack([xx_src.ravel(), yy_src.ravel(), zz_src.ravel()]).T\n\n    # 4. Define Test Cases\n    test_cases = [\n        # (altitude, x_lims, y_lims, grid_spacing)\n        (100.0, [-500.0, 500.0], [-500.0, 500.0], 25.0),  # Baseline\n        (500.0, [-500.0, 500.0], [-500.0, 500.0], 25.0),  # Far-field\n        (100.0, [-300.0, 300.0], [-300.0, 300.0], 50.0),  # Coarse-resolution\n    ]\n\n    all_results = []\n    \n    # Pre-factor for bT calculation in Tesla\n    # (MU0 / (4 * pi)) * M_mag * dV = 1e-7 * M_mag * dV\n    pre_factor_T = 1e-7 * M_mag * dV\n\n    # 5. Loop through test cases and compute anomalies\n    for alt, x_lim, y_lim, delta in test_cases:\n        # Create observation grid\n        x_obs = np.arange(x_lim[0], x_lim[1] + delta, delta)\n        y_obs = np.arange(y_lim[0], y_lim[1] + delta, delta)\n\n        xx_obs, yy_obs = np.meshgrid(x_obs, y_obs, indexing='ij')\n        zz_obs = np.full_like(xx_obs, alt)\n\n        r_obs = np.vstack([xx_obs.ravel(), yy_obs.ravel(), zz_obs.ravel()]).T\n        \n        # Vectorized computation of the anomaly\n        # R = r_obs - r_prime (using broadcasting)\n        # R has shape (N_obs, N_dipoles, 3)\n        R = r_obs[:, np.newaxis, :] - r_prime[np.newaxis, :, :]\n\n        R_sq_norm = np.sum(R**2, axis=2)\n        uH_dot_R = np.dot(R, uH)\n        \n        # Term inside the summation\n        term_matrix = 3 * uH_dot_R**2 / R_sq_norm**2.5 - 1 / R_sq_norm**1.5\n        \n        # Sum over all dipoles for each observation point\n        bT_sum_term = np.sum(term_matrix, axis=1)\n\n        # Calculate final anomaly in nanotesla\n        bT_tesla = pre_factor_T * bT_sum_term\n        bT_nT = bT_tesla * 1e9\n\n        # 6. Calculate and store metrics\n        peak_amplitude = np.max(np.abs(bT_nT))\n        threshold = 0.5 * peak_amplitude\n        \n        footprint_count = np.sum(np.abs(bT_nT) >= threshold)\n        footprint_area = footprint_count * delta**2\n\n        all_results.append([round(peak_amplitude, 1), int(footprint_area)])\n\n    # 7. Print results in the specified format\n    formatted_results = [f\"[{p},{a}]\" for p, a in all_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\n\nsolve()\n```", "id": "3597743"}, {"introduction": "真实的地质材料通常表现出复杂的磁学性质，其响应远超简单的线性关系。这个实践将引入一种非线性、可饱和的磁化模型，其挑战在于求解一个自洽方程：磁体内部的磁化强度依赖于它自身产生的磁场（即退磁场）。你将学习实现一个不动点迭代求解器，这是一种处理物理和工程领域中常见的非线性问题的强大技术，从而深化对岩石磁学物理以及精确模拟所需数值方法的理解[@problem_id:3597732]。", "problem": "要求您实现一个完整的、可运行的程序，对具有非线性饱和磁化特性的均匀可磁化椭球体进行磁异常正演模拟。由于退磁效应，未知的磁化强度满足一个自洽的非线性方程。您的程序必须通过不动点迭代构建并求解此方程，评估不同初始猜测和退磁张量下的收敛行为，然后使用偶极子近似计算指定观测点处的垂直磁感应异常。\n\n请从以下基本原理开始：\n- 在静磁学中，磁感应强度和磁场强度满足 $\\mathbf{B}=\\mu_0(\\mathbf{H}+\\mathbf{M})$，其中 $\\mu_0$ 是自由空间磁导率，$\\mathbf{H}$ 是磁场强度，$\\mathbf{M}$ 是磁化强度。\n- 对于一个均匀磁化的椭球体，其内部的局部场为 $\\mathbf{H}_{\\text{loc}}=\\mathbf{H}_{\\text{ext}}-\\mathbf{N}\\,\\mathbf{M}$，其中 $\\mathbf{H}_{\\text{ext}}$ 是一个均匀的外部磁场，$\\mathbf{N}$ 是退磁张量，它是一个实对称半正定矩阵，其特征值在 $[0,1]$ 区间内，且对于自由空间中的椭球体满足 $\\mathrm{tr}(\\mathbf{N})=1$。\n- 假设一个与饱和现象一致的各向同性、非线性、饱和的本构关系 $\\mathbf{M}=\\mathbf{K}(\\mathbf{H}_{\\text{loc}})\\,\\mathbf{H}_{\\text{loc}}$。使用唯象律 $\\mathbf{M}=M_s \\tanh\\!\\big(\\alpha\\|\\mathbf{H}_{\\text{loc}}\\|\\big)\\,\\widehat{\\mathbf{H}}_{\\text{loc}}$，其中 $\\alpha=\\chi_0/M_s$，$M_s$ 是饱和磁化强度，$\\chi_0$ 是低场磁化率，$\\|\\cdot\\|$ 是欧几里得范数，当 $\\|\\mathbf{H}_{\\text{loc}}\\|0$ 时 $\\widehat{\\mathbf{H}}_{\\text{loc}}=\\mathbf{H}_{\\text{loc}}/\\|\\mathbf{H}_{\\text{loc}}\\|$，否则为 $\\mathbf{0}$。这意味着一个各向同性标量核，当 $\\|\\mathbf{H}\\|0$ 时为 $K(\\mathbf{H})=M_s \\tanh(\\alpha\\|\\mathbf{H}\\|)/\\|\\mathbf{H}\\|$，且 $K(\\mathbf{0})=\\chi_0$。\n- 在偶极子近似中，一个体积为 $V$、均匀磁化强度为 $\\mathbf{M}$ 的均匀磁化紧致体，其磁偶极矩为 $\\mathbf{m}=V\\,\\mathbf{M}$，在观测位置 $\\mathbf{r}\\neq \\mathbf{0}$ 处产生的磁感应强度由 $\\mathbf{B}_{\\text{dip}}(\\mathbf{r})=\\dfrac{\\mu_0}{4\\pi r^3}\\left[3(\\mathbf{m}\\cdot \\widehat{\\mathbf{r}})\\,\\widehat{\\mathbf{r}}-\\mathbf{m}\\right]$ 给出，其中 $r=\\|\\mathbf{r}\\|$ 且 $\\widehat{\\mathbf{r}}=\\mathbf{r}/r$。\n\n您的任务是：\n- 建立从本构关系和退磁关系导出的不动点迭代 $\\mathbf{M}^{(k+1)}=\\mathcal{F}(\\mathbf{M}^{(k)})$，并实现它以求解每个测试案例的自洽磁化强度。使用停止准则 $\\|\\mathbf{M}^{(k+1)}-\\mathbf{M}^{(k)}\\|  \\varepsilon$（容差为 $\\varepsilon$）和迭代次数上限 $k_{\\max}$ 来防止无限循环。\n- 收敛后，使用偶极子表达式计算位于物体中心上方对称轴上的观测点处的偶极子磁感应异常的垂直分量 $\\Delta B_z$。以纳特斯拉（nanotesla）为单位报告 $\\Delta B_z$。\n\n科学和数值规格：\n- 使用 $\\mu_0=4\\pi\\times 10^{-7}\\,\\mathrm{N/A^2}$。\n- 使用一系列等体积 $V=\\dfrac{4}{3}\\pi R^3$ 的椭球体，其中 $R$ 是一个等效半径参数。取 $R=50\\,\\mathrm{m}$，因此在所有测试案例中 $V=\\dfrac{4}{3}\\pi \\times 50^3\\,\\mathrm{m^3}$ 保持不变。\n- 设外部磁场是均匀的，与 $z$ 轴对齐，大小为 $\\|\\mathbf{H}_{\\text{ext}}\\|=40\\,\\mathrm{A/m}$，即 $\\mathbf{H}_{\\text{ext}}=(0,0,40)\\,\\mathrm{A/m}$。\n- 使用饱和磁化强度 $M_s=480000\\,\\mathrm{A/m}$ 和低场磁化率 $\\chi_0=1.0$（无量纲）。\n- 使用观测点 $\\mathbf{r}=(0,0,z_o)$，其中 $z_o=100\\,\\mathrm{m}$，位于物体中心上方。\n- 使用不动点迭代容差 $\\varepsilon=10^{-10}\\,\\mathrm{A/m}$ 和最大迭代次数 $k_{\\max}=10000$。\n- 对于特殊情况 $\\|\\mathbf{H}_{\\text{loc}}\\|=0$，将该次迭代的 $\\mathbf{M}$ 设置为 $\\mathbf{0}$。\n\n测试套件：\n为以下四个测试案例实现您的求解器，这些案例旨在探究收敛行为作为初始猜测和退磁张量 $\\mathbf{N}$ 的函数。在所有案例中，$\\mathbf{H}_{\\text{ext}}=(0,0,40)\\,\\mathrm{A/m}$，$M_s=480000\\,\\mathrm{A/m}$，$\\chi_0=1.0$，$R=50\\,\\mathrm{m}$，且 $z_o=100\\,\\mathrm{m}$。\n\n- 案例 1（基准球体，中性初始猜测）：\n  - $\\mathbf{N}=\\mathrm{diag}\\!\\big(\\tfrac{1}{3},\\tfrac{1}{3},\\tfrac{1}{3}\\big)$。\n  - 初始猜测 $\\mathbf{M}^{(0)}=(0,0,0)\\,\\mathrm{A/m}$。\n\n- 案例 2（扁球状退磁，中性初始猜测）：\n  - $\\mathbf{N}=\\mathrm{diag}(0.495,0.495,0.01)$。\n  - 初始猜测 $\\mathbf{M}^{(0)}=(0,0,0)\\,\\mathrm{A/m}$。\n\n- 案例 3（长球状退磁，中性初始猜测）：\n  - $\\mathbf{N}=\\mathrm{diag}(0.499,0.499,0.002)$。\n  - 初始猜测 $\\mathbf{M}^{(0)}=(0,0,0)\\,\\mathrm{A/m}$。\n\n- 案例 4（基准球体，接近反向饱和的不利初始猜测）：\n  - $\\mathbf{N}=\\mathrm{diag}\\!\\big(\\tfrac{1}{3},\\tfrac{1}{3},\\tfrac{1}{3}\\big)$。\n  - 初始猜测 $\\mathbf{M}^{(0)}=(0,0,-480000)\\,\\mathrm{A/m}$。\n\n程序要求：\n- 按上述方法，通过不动点迭代计算每个案例的收敛磁化强度 $\\mathbf{M}$。\n- 使用 $\\mathbf{m}=V\\,\\mathbf{M}$ 和偶极子公式，计算在 $\\mathbf{r}=(0,0,100)\\,\\mathrm{m}$ 处的垂直异常 $\\Delta B_z$。将 $\\Delta B_z$ 以纳特斯拉（nanotesla）为单位表示，并四舍五入到 $6$ 位小数。\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，按案例 1 到 4 的顺序排列结果，例如 '[x1,x2,x3,x4]'，其中每个条目都是以纳特斯拉为单位、四舍五入到 6 位小数的浮点数，并且在打印输出中不带单位。\n\n本问题不使用角度单位。计算中的所有物理量必须统一使用国际单位制，并且报告的异常值必须按规定以纳特斯拉为单位。", "solution": "该问题要求对具有非线性饱和磁化响应的均匀可磁化椭球体产生的磁异常进行正演模拟。问题的核心是确定自洽的磁化强度矢量 $\\mathbf{M}$，该矢量需同时满足材料的本构关系和内部的退磁场。一旦求得 $\\mathbf{M}$，便可使用磁偶极子近似计算指定观测点处的磁异常。\n\n**1. 磁化自洽方程的建立**\n\n物体的磁状态由外场、材料响应以及与几何相关的退磁场之间的相互作用决定。基本关系如下：\n1.  椭球体内部的局部磁场 $\\mathbf{H}_{\\text{loc}}$ 是均匀外磁场 $\\mathbf{H}_{\\text{ext}}$ 与退磁场 $\\mathbf{H}_{\\text{demag}}$ 的和。退磁场通过退磁张量 $\\mathbf{N}$ 与磁化强度 $\\mathbf{M}$ 线性相关：\n    $$\n    \\mathbf{H}_{\\text{loc}} = \\mathbf{H}_{\\text{ext}} + \\mathbf{H}_{\\text{demag}} = \\mathbf{H}_{\\text{ext}} - \\mathbf{N}\\mathbf{M}\n    $$\n2.  磁化强度 $\\mathbf{M}$ 是局部场 $\\mathbf{H}_{\\text{loc}}$ 的非线性函数。问题指定了一个各向同性、饱和的唯象律：\n    $$\n    \\mathbf{M} = M_s \\tanh\\left(\\alpha \\|\\mathbf{H}_{\\text{loc}}\\|\\right) \\frac{\\mathbf{H}_{\\text{loc}}}{\\|\\mathbf{H}_{\\text{loc}}\\|}\n    $$\n    其中 $M_s$ 是饱和磁化强度，$\\alpha = \\chi_0/M_s$，$\\chi_0$ 是低场磁化率。此关系在 $\\|\\mathbf{H}_{\\text{loc}}\\|  0$ 时成立。若 $\\|\\mathbf{H}_{\\text{loc}}\\| = 0$，则 $\\mathbf{M} = \\mathbf{0}$。该表达式可以使用恒等式 $\\tanh(x) \\frac{\\mathbf{v}}{\\|\\mathbf{v}\\|} = \\tanh(\\|\\mathbf{v}\\| \\frac{x}{\\|\\mathbf{v}\\|}) \\frac{\\mathbf{v}}{\\|\\mathbf{v}\\|}$ 写得更紧凑，但这不完全正确。更好的方式是 $\\tanh(x) \\hat{v}$。对于矢量参数 $\\mathbf{u}$，我们可以定义一个矢量 tanh 函数，使得 $\\tanh(\\mathbf{u}) = \\tanh(\\|\\mathbf{u}\\|)\\hat{\\mathbf{u}}$。使用这种方式，本构关系为 $\\mathbf{M} = M_s \\tanh(\\alpha \\mathbf{H}_{\\text{loc}})$。\n\n结合这两个方程，可以得到一个关于未知磁化强度 $\\mathbf{M}$ 的单一、自洽的非线性矢量方程：\n$$\n\\mathbf{M} = M_s \\tanh\\left(\\alpha \\|\\mathbf{H}_{\\text{ext}} - \\mathbf{N}\\mathbf{M}\\|\\right) \\frac{\\mathbf{H}_{\\text{ext}} - \\mathbf{N}\\mathbf{M}}{\\|\\mathbf{H}_{\\text{ext}} - \\mathbf{N}\\mathbf{M}\\|}\n$$\n此方程的形式为 $\\mathbf{M} = \\mathcal{F}(\\mathbf{M})$，适合通过不动点迭代求解。\n\n**2. 不动点迭代方案**\n\n我们构造一个迭代序列 $\\mathbf{M}^{(k)}$，该序列收敛后即为解。从一个初始猜测 $\\mathbf{M}^{(0)}$ 开始，该序列通过以下方式生成：\n$$\n\\mathbf{M}^{(k+1)} = \\mathcal{F}(\\mathbf{M}^{(k)})\n$$\n每次迭代的步骤如下：\n1.  给定当前的磁化强度估计值 $\\mathbf{M}^{(k)}$，计算相应的局部场：\n    $$\n    \\mathbf{H}_{\\text{loc}}^{(k)} = \\mathbf{H}_{\\text{ext}} - \\mathbf{N}\\mathbf{M}^{(k)}\n    $$\n2.  计算局部场的范数 $\\|\\mathbf{H}_{\\text{loc}}^{(k)}\\|$。\n3.  如果 $\\|\\mathbf{H}_{\\text{loc}}^{(k)}\\|$ 为零（或数值上接近于零），则下一个磁化强度估计值为零矢量，即 $\\mathbf{M}^{(k+1)} = \\mathbf{0}$。\n4.  否则，使用本构关系计算下一个磁化强度估计值：\n    $$\n    \\mathbf{M}^{(k+1)} = M_s \\tanh\\left(\\alpha \\|\\mathbf{H}_{\\text{loc}}^{(k)}\\|\\right) \\frac{\\mathbf{H}_{\\text{loc}}^{(k)}}{\\|\\mathbf{H}_{\\text{loc}}^{(k)}\\|}\n    $$\n迭代持续进行，直到连续迭代值之间的变化小于指定的容差 $\\varepsilon$，即 $\\|\\mathbf{M}^{(k+1)} - \\mathbf{M}^{(k)}\\|  \\varepsilon$。为防止在不收敛的情况下出现无限循环，设置了最大迭代次数 $k_{\\max}$。\n\n**3. 因对称性而产生的简化**\n\n在所有指定的测试案例中，外磁场 $\\mathbf{H}_{\\text{ext}} = (0, 0, H_{ext,z})$ 与 $z$ 轴对齐，并且退磁张量 $\\mathbf{N}$ 是对角的。此外，初始猜测 $\\mathbf{M}^{(0)}$ 也与 $z$ 轴对齐。因此，所有后续的 $\\mathbf{M}$ 迭代值也必定与 $z$ 轴对齐。\n设 $\\mathbf{M}^{(k)} = (0, 0, M_z^{(k)})$。则：\n$$\n\\mathbf{H}_{\\text{loc}}^{(k)} = (0, 0, H_{ext,z}) - \\begin{pmatrix} N_{xx}  0  0 \\\\ 0  N_{yy}  0 \\\\ 0  0  N_{zz} \\end{pmatrix} \\begin{pmatrix} 0 \\\\ 0 \\\\ M_z^{(k)} \\end{pmatrix} = (0, 0, H_{ext,z} - N_{zz}M_z^{(k)})\n$$\n问题从一个三维矢量迭代简化为一个关于磁化强度 $z$ 分量 $M_z$ 的一维标量迭代：\n$$\nM_z^{(k+1)} = M_s \\tanh\\left(\\frac{\\chi_0}{M_s} |H_{ext,z} - N_{zz}M_z^{(k)}|\\right) \\cdot \\mathrm{sgn}(H_{ext,z} - N_{zz}M_z^{(k)})\n$$\n利用属性 $\\tanh(x) = \\mathrm{sgn}(x)\\tanh(|x|)$，可以简化为：\n$$\nM_z^{(k+1)} = M_s \\tanh\\left(\\frac{\\chi_0}{M_s} (H_{ext,z} - N_{zz}M_z^{(k)})\\right)\n$$\n这种标量不动点迭代的计算效率更高。所实现的代码将求解完整的矢量方程，这自然会得到相同的结果。\n\n**4. 磁异常的计算**\n\n一旦求得收敛后的磁化强度 $\\mathbf{M} = (0, 0, M_z)$，椭球体的磁偶极矩计算为 $\\mathbf{m} = V\\mathbf{M}$，其中 $V = \\frac{4}{3}\\pi R^3$ 是体积。\n$$\n\\mathbf{m} = \\left(0, 0, \\frac{4}{3}\\pi R^3 M_z\\right)\n$$\n观测点 $\\mathbf{r}$ 处的磁感应异常由偶极子场公式给出：\n$$\n\\Delta\\mathbf{B}(\\mathbf{r}) = \\mathbf{B}_{\\text{dip}}(\\mathbf{r}) = \\frac{\\mu_0}{4\\pi \\|\\mathbf{r}\\|^3} \\left[ 3(\\mathbf{m} \\cdot \\hat{\\mathbf{r}})\\hat{\\mathbf{r}} - \\mathbf{m} \\right]\n$$\n对于 $z$ 轴上的指定观测点 $\\mathbf{r} = (0, 0, z_o)$，我们有 $\\|\\mathbf{r}\\| = z_o$ 且 $\\hat{\\mathbf{r}} = (0, 0, 1)$。点积为 $\\mathbf{m} \\cdot \\hat{\\mathbf{r}} = m_z = \\frac{4}{3}\\pi R^3 M_z$。代入公式：\n$$\n\\Delta\\mathbf{B}(0,0,z_o) = \\frac{\\mu_0}{4\\pi z_o^3} \\left[ 3\\left(\\frac{4}{3}\\pi R^3 M_z\\right)(0, 0, 1) - \\left(0, 0, \\frac{4}{3}\\pi R^3 M_z\\right) \\right]\n$$\n$$\n\\Delta\\mathbf{B}(0,0,z_o) = \\frac{\\mu_0}{4\\pi z_o^3} \\left[ 2 \\left(\\frac{4}{3}\\pi R^3 M_z\\right) (0, 0, 1) \\right]\n$$\n因此，异常的垂直分量 $\\Delta B_z$ 为：\n$$\n\\Delta B_z = \\frac{2 \\mu_0 (\\frac{4}{3}\\pi R^3 M_z)}{4\\pi z_o^3} = \\frac{2 \\mu_0 R^3 M_z}{3 z_o^3}\n$$\n\n**5. 算法实现**\n\n对每个测试案例，算法按以下步骤进行：\n1.  初始化常数：$\\mu_0 = 4\\pi \\times 10^{-7}\\,\\mathrm{N/A^2}$， $R=50\\,\\mathrm{m}$， $V=\\frac{4}{3}\\pi R^3$， $z_o=100\\,\\mathrm{m}$， $\\mathbf{H}_{\\text{ext}}=(0,0,40)\\,\\mathrm{A/m}$， $M_s=480000\\,\\mathrm{A/m}$， $\\chi_0=1.0$， $\\alpha = \\chi_0/M_s$， $\\varepsilon=10^{-10}\\,\\mathrm{A/m}$， $k_{\\max}=10000$。\n2.  为特定案例设置退磁张量 $\\mathbf{N}$ 和初始猜测 $\\mathbf{M}^{(0)}$。\n3.  对 $k = 0, 1, \\dots, k_{\\max}-1$ 执行不动点迭代：\n    a.  计算 $\\mathbf{H}_{\\text{loc}}^{(k)} = \\mathbf{H}_{\\text{ext}} - \\mathbf{N}\\mathbf{M}^{(k)}$。\n    b.  使用非线性定律计算 $\\mathbf{M}^{(k+1)}$。\n    c.  检查收敛性：如果 $\\|\\mathbf{M}^{(k+1)} - \\mathbf{M}^{(k)}\\|  \\varepsilon$，退出循环。\n    d.  更新 $\\mathbf{M}^{(k)} \\leftarrow \\mathbf{M}^{(k+1)}$。\n4.  使用收敛后的磁化强度 $M_z$，计算垂直磁异常 $\\Delta B_z = \\frac{2 \\mu_0 R^3 M_z}{3 z_o^3}$。\n5.  将结果从特斯拉（T）转换为纳特斯拉（$\\mathrm{nT}$），乘以 $10^9$。\n6.  将最终值四舍五入到 6 位小数并存储。\n7.  对所有测试案例重复此过程，并将输出格式化为逗号分隔的列表。\n\n这四个案例测试了物体形状（通过 $\\mathbf{N}$）以及迭代相对于初始猜测的鲁棒性。对于给定的物理参数和特征值在 $[0,1]$ 内的对角退磁张量 $\\mathbf{N}$，该不动点迭代是一个压缩映射，确保无论初始猜测如何，都能收敛到唯一的不动点。因此，案例 1 和案例 4 预期将产生相同的结果。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the magnetic anomaly for a nonlinear, magnetizable ellipsoidal body.\n\n    This function performs forward modeling by:\n    1. Solving for the self-consistent magnetization using a fixed-point iteration.\n    2. Calculating the magnetic anomaly at a specified point using the dipole approximation.\n    \"\"\"\n\n    # --- Scientific and numerical specifications ---\n    MU0 = 4 * np.pi * 1e-7  # Magnetic permeability of free space (N/A^2)\n    R = 50.0  # Equivalent-radius of the ellipsoidal body (m)\n    V = (4.0 / 3.0) * np.pi * R**3  # Volume of the body (m^3)\n    H_EXT = np.array([0.0, 0.0, 40.0])  # External magnetic field (A/m)\n    MS = 480000.0  # Saturation magnetization (A/m)\n    CHI0 = 1.0  # Low-field susceptibility (dimensionless)\n    ALPHA = CHI0 / MS  # Parameter in the constitutive law\n    Z_O = 100.0  # Observation height on the z-axis (m)\n    \n    # --- Iteration parameters ---\n    EPSILON = 1e-10  # Convergence tolerance (A/m)\n    K_MAX = 10000  # Maximum number of iterations\n\n    # --- Test case definitions ---\n    test_cases = [\n        {\n            \"name\": \"Case 1: Sphere, neutral guess\",\n            \"N\": np.diag([1.0/3.0, 1.0/3.0, 1.0/3.0]),\n            \"M0\": np.array([0.0, 0.0, 0.0])\n        },\n        {\n            \"name\": \"Case 2: Oblate-like, neutral guess\",\n            \"N\": np.diag([0.495, 0.495, 0.01]),\n            \"M0\": np.array([0.0, 0.0, 0.0])\n        },\n        {\n            \"name\": \"Case 3: Prolate-like, neutral guess\",\n            \"N\": np.diag([0.499, 0.499, 0.002]),\n            \"M0\": np.array([0.0, 0.0, 0.0])\n        },\n        {\n            \"name\": \"Case 4: Sphere, adverse guess\",\n            \"N\": np.diag([1.0/3.0, 1.0/3.0, 1.0/3.0]),\n            \"M0\": np.array([0.0, 0.0, -480000.0])\n        }\n    ]\n\n    results = []\n\n    for case in test_cases:\n        N = case[\"N\"]\n        M = case[\"M0\"].copy()\n\n        for _ in range(K_MAX):\n            H_loc = H_EXT - N @ M\n            norm_H_loc = np.linalg.norm(H_loc)\n\n            if norm_H_loc == 0.0:\n                M_next = np.zeros_like(M)\n            else:\n                H_loc_hat = H_loc / norm_H_loc\n                M_next = MS * np.tanh(ALPHA * norm_H_loc) * H_loc_hat\n\n            if np.linalg.norm(M_next - M)  EPSILON:\n                M = M_next\n                break\n            \n            M = M_next\n        \n        # After convergence, M holds the self-consistent magnetization\n        Mz = M[2]\n\n        # Compute the vertical component of the dipole magnetic induction anomaly\n        # Formula: delta_Bz = (2 * MU0 * R^3 * Mz) / (3 * Z_O^3)\n        delta_Bz = (2.0 * MU0 * R**3 * Mz) / (3.0 * Z_O**3)\n        \n        # Convert from Tesla to nanotesla and round\n        delta_Bz_nT = delta_Bz * 1e9\n        \n        results.append(round(delta_Bz_nT, 6))\n\n    # Print the results in the specified format\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == '__main__':\n    solve()\n```", "id": "3597732"}, {"introduction": "对于大规模的地球物理勘探，空间域中的直接求和方法在计算上变得不可行，而基于快速傅里叶变换（FFT）的谱方法提供了一种高效的替代方案。本练习将带你探索频率域中的正演模拟，推导并应用“向上延拓”这一在位场地球物理学中至关重要的谱算子。通过量化其影响并推导缓解策略，你将对离散化连续场时产生的关键数值问题——“混叠”（aliasing）——有更深入的理解，并掌握在计算效率与数值精度之间进行权衡的专业能力[@problem_id:3597756]。", "problem": "我们建立一个二维正演模拟实验，以量化磁异常谱方法模拟在向上延拓后产生的混叠。考虑一个边长为 $L$ 米、具有周期性边界条件的方形域。一个合成磁化场 $M(x,y)$ 被指定为平面波的叠加，其频率单位为“周/米”。观测高度为磁化片（位于 $z=0$）上方 $z$ 米处。你将实现谱方法正演模拟，使用离散傅里叶变换（DFT）和根据物理原理推导的向上延拓算子，从 $M(x,y)$ 计算垂向磁异常场 $B_z(x,y;z)$。然后，通过比较两个计算流程，你将测量在向上延拓前，当 $M(x,y)$ 在粗网格上采样时由混叠引起的泄漏。最后，你将提出并评估一个过采样准则，该准则将混叠限制在预设的容差范围内。\n\n使用的基本原理：\n- 静磁学：在平面层上方的无源区域中，磁标势 $\\Phi$ 满足拉普拉斯方程 $\\nabla^2 \\Phi = 0$，因此其傅里叶模式随高度呈指数衰减。垂向磁异常 $B_z$ 通过 $B_z = -\\mu_0 \\partial \\Phi/\\partial z$ 与 $\\Phi$ 相关，其中 $\\mu_0$ 是自由空间磁导率。\n- 采样与混叠：在间距为 $\\Delta x$ 和 $\\Delta y$ 的空间网格上对连续场进行采样，会导致其频谱以等于采样频率的周期进行周期性复制，当其谱支撑超过奈奎斯特极限时，高频分量会折叠到基带中。向上延拓对谐波场起到低通滤波器的作用。\n- 离散傅里叶变换（DFT）实现：使用快速傅里叶变换（FFT）在均匀网格上近似连续谱操作。\n\n你不能假设任何快捷公式。相反，应从拉普拉斯方程推导谱向上延拓算子 $T(\\mathbf{f},z)$，并在你的算法中使用它。使用单位为“周/米”的傅里叶频率。所有变量、符号和数字都必须用 LaTeX 书写。所有长度量必须以米为单位处理。本问题不使用角度。\n\n要实现的算法任务：\n- 在一个能够无混叠地解析所有指定频率的细网格上，以及在不能解析的指定粗网格上，构建 $M(x,y)$。使用周期性边界条件和DFT。将域定义为在 $x$ 和 $y$ 方向上均为 $[0,L)$。\n- 推导并实现适用于垂向磁异常 $B_z$ 的谱向上延拓算子 $T(\\mathbf{f},z)$，该算子用傅里叶频率大小 $|\\mathbf{f}|$（单位：周/米）和高度 $z$（单位：米）表示。将 $T(\\mathbf{f},z)$ 应用于 $M(x,y)$ 的DFT，以计算 $B_z(x,y;z)$。\n- 通过在细网格上应用向上延拓，然后降采样到粗网格来计算参考“真值”。通过在粗网格上对 $M(x,y)$ 进行采样，然后在该粗网格上应用向上延拓来计算“粗网格优先”的结果。将泄漏量化为“粗网格优先”结果与降采样后真值之差的 $\\ell_2$ 范数与降采样后真值的 $\\ell_2$ 范数之比。此泄漏值是无量纲的，必须以浮点数形式报告。\n- 提出一个源于向上延拓指数衰减的过采样准则，确保超出粗网格奈奎斯特频率的残余频谱内容被限制在容差 $\\varepsilon$ 以内。根据你的推导，将得出的建议最大粗网格间距 $\\Delta x_{\\max}$（单位为米）表示为浮点数。评估测试所用的粗网格间距 $\\Delta x$ 是否满足该准则，结果以布尔值报告。\n\n合成磁化：\n- 使用 $M(x,y) = \\cos(2\\pi f_1 x) + 0.5\\,\\cos(2\\pi f_2 y) + 0.8\\,\\cos(2\\pi (u x + v y))$，其中 $f_1$、$f_2$、$u$、$v$ 的单位为“周/米”。\n\n谱正演模拟细节：\n- 在均匀网格上使用二维DFT。使用DFT频率函数返回的傅里叶频率数组，单位为“周/米”，并将域视为周期性的。\n- 观测高度 $z$ 的单位为米。\n- 最终的泄漏度量是在谱域中应用向上延拓后，在粗网格上的空间域中计算的。\n\n单位：\n- 长度（包括 $L$、$z$、$\\Delta x$ 和 $\\Delta y$）必须以米为单位。\n- 频率必须以“周/米”为单位。\n- 报告 $\\Delta x_{\\max}$，单位为米。\n\n测试套件：\n- 域大小：所有测试中 $L = 1000$ 米。\n- 细网格：所有测试中每轴 $N_{\\text{fine}} = 512$ 个样本；这可以无混叠地解析合成的 $M(x,y)$。\n- 磁化频率：所有测试中 $f_1 = 0.030$ 周/米，$f_2 = 0.045$ 周/米，$u = 0.040$ 周/米，$v = 0.015$ 周/米。\n- 容差：所有测试中 $\\varepsilon = 0.01$。\n- 测试用例：\n  $1.$ 粗网格每轴 $N_{\\text{coarse}} = 64$，观测高度 $z = 50$ 米。\n  $2.$ 粗网格每轴 $N_{\\text{coarse}} = 64$，观测高度 $z = 200$ 米。\n  $3.$ 粗网格每轴 $N_{\\text{coarse}} = 32$，观测高度 $z = 50$ 米。\n\n输出规范：\n- 对于每个测试用例，生成一个包含三个条目的列表：$[\\ell, \\Delta x_{\\max}, \\text{criterion\\_satisfied}]$，其中 $\\ell$ 是泄漏比率（浮点数），$\\Delta x_{\\max}$ 是建议的最大粗网格间距（浮点数，单位为米），$\\text{criterion\\_satisfied}$ 是一个布尔值，指示测试所用的粗网格间距是否满足该准则。\n- 你的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，例如 $[[\\ell_1,\\Delta x_{\\max,1},b_1],[\\ell_2,\\Delta x_{\\max,2},b_2],[\\ell_3,\\Delta x_{\\max,3},b_3]]$。", "solution": "问题陈述被认为是有效的。它在科学上基于静磁学和傅里叶分析的原理，参数齐全、问题适定，并且陈述客观。可以根据所提供的信息构建一个严谨的解决方案。\n\n### 第1部分：谱向上延拓算子的推导\n\n目标是找到算子 $T(\\mathbf{f}, z)$，该算子将表面磁化 $M(x,y)$ 的傅里叶变换映射到高度 $z$ 处垂向磁异常 $B_z(x,y,z)$ 的傅里叶变换。推导过程从提供的基本原理出发。\n\n1. 在无源区域 $z0$ 中，磁标势 $\\Phi$ 满足拉普拉斯方程：\n$$ \\nabla^2 \\Phi(x,y,z) = \\left( \\frac{\\partial^2}{\\partial x^2} + \\frac{\\partial^2}{\\partial y^2} + \\frac{\\partial^2}{\\partial z^2} \\right) \\Phi = 0 $$\n令 $\\hat{\\Phi}(\\mathbf{f},z)$ 为 $\\Phi(x,y,z)$ 关于 $x$ 和 $y$ 的二维傅里叶变换，其中 $\\mathbf{f}=(f_x, f_y)$ 是频率矢量，单位为周/米。关于 $x$ 和 $y$ 的偏导数的傅里叶变换分别为 $(i 2\\pi f_x)^2$ 和 $(i 2\\pi f_y)^2$。将该变换应用于拉普拉斯方程，得到一个关于 $z$ 的常微分方程：\n$$ \\left( -(2\\pi f_x)^2 - (2\\pi f_y)^2 + \\frac{d^2}{dz^2} \\right) \\hat{\\Phi}(\\mathbf{f},z) = 0 $$\n$$ \\frac{d^2 \\hat{\\Phi}}{dz^2} - (2\\pi)^2 (f_x^2 + f_y^2) \\hat{\\Phi} = 0 $$\n$$ \\frac{d^2 \\hat{\\Phi}}{dz^2} - (2\\pi |\\mathbf{f}|)^2 \\hat{\\Phi} = 0 $$\n其中 $|\\mathbf{f}| = \\sqrt{f_x^2 + f_y^2}$ 是频率矢量的大小。\n\n2. 这个二阶常微分方程的通解是：\n$$ \\hat{\\Phi}(\\mathbf{f},z) = A(\\mathbf{f}) e^{2\\pi |\\mathbf{f}| z} + B(\\mathbf{f}) e^{-2\\pi |\\mathbf{f}| z} $$\n为使势在 $z \\to \\infty$ 时保持物理上有界，指数增长项的系数 $A(\\mathbf{f})$ 必须为零。这样剩下：\n$$ \\hat{\\Phi}(\\mathbf{f},z) = B(\\mathbf{f}) e^{-2\\pi |\\mathbf{f}| z} $$\n在 $z=0$ 处，我们有 $\\hat{\\Phi}(\\mathbf{f},0) = B(\\mathbf{f})$。因此，解为：\n$$ \\hat{\\Phi}(\\mathbf{f},z) = \\hat{\\Phi}(\\mathbf{f},0) e^{-2\\pi |\\mathbf{f}| z} $$\n该方程描述了磁势的向上延拓。项 $e^{-2\\pi |\\mathbf{f}| z}$ 是一个低通滤波器，随着高度 $z$ 的增加，对较高频率的衰减更强。\n\n3. 垂向磁异常 $B_z$ 通过 $B_z = -\\mu_0 \\frac{\\partial \\Phi}{\\partial z}$ 与势相关。进行傅里叶变换：\n$$ \\hat{B}_z(\\mathbf{f},z) = -\\mu_0 \\frac{\\partial}{\\partial z} \\hat{\\Phi}(\\mathbf{f},z) $$\n代入 $\\hat{\\Phi}(\\mathbf{f},z)$ 的表达式：\n$$ \\hat{B}_z(\\mathbf{f},z) = -\\mu_0 \\frac{\\partial}{\\partial z} \\left( \\hat{\\Phi}(\\mathbf{f},0) e^{-2\\pi |\\mathbf{f}| z} \\right) = -\\mu_0 \\hat{\\Phi}(\\mathbf{f},0) \\left( -2\\pi |\\mathbf{f}| \\right) e^{-2\\pi |\\mathbf{f}| z} $$\n$$ \\hat{B}_z(\\mathbf{f},z) = 2\\pi \\mu_0 |\\mathbf{f}| \\hat{\\Phi}(\\mathbf{f},0) e^{-2\\pi |\\mathbf{f}| z} $$\n\n4. 最后一步是将 $\\hat{\\Phi}(\\mathbf{f},0)$ 与磁化的傅里叶变换 $\\hat{M}(\\mathbf{f})$ 联系起来。问题没有明确指定这种关系，它取决于源层的精确物理特性（例如，垂直偶极子、感应磁化）。在这种情况下，一个常见且简单的假设是直接成正比，即 $\\hat{\\Phi}(\\mathbf{f},0) \\propto \\hat{M}(\\mathbf{f})$。这意味着磁化场 $M(x,y)$ 直接作为平面上势 $\\Phi(x,y,0)$ 的源。在此假设下，我们可以写出：\n$$ \\hat{B}_z(\\mathbf{f},z) = C \\cdot \\left( 2\\pi |\\mathbf{f}| e^{-2\\pi |\\mathbf{f}| z} \\right) \\hat{M}(\\mathbf{f}) $$\n其中 $C$ 是一个包含 $\\mu_0$ 和比例因子的常数。由于最终的泄漏度量是一个比率，这个常数将被抵消。因此，我们可以将谱正演算子定义为：\n$$ T(\\mathbf{f}, z) = 2\\pi |\\mathbf{f}| e^{-2\\pi |\\mathbf{f}| z} $$\n对于直流分量（$|\\mathbf{f}|=0$），$T(0,z)=0$，这正确地说明了均匀的磁化片不产生外部磁异常。\n\n### 第2部分：过采样准则的推导\n\n目标是提出一个关于粗网格间距 $\\Delta x$ 的准则，使混叠效应低于容差 $\\varepsilon$。当信号的采样率低于其最高频率的两倍时，会发生混叠。向上延拓算子自然会衰减高频，这可以减轻混叠。我们可以将其形式化为一个准则。\n\n1. 在间距为 $\\Delta x$ 的网格上采样的信号，其谱支撑被限制在奈奎斯特频率 $f_{Ny} = 1/(2\\Delta x)$ 内。任何频率 $|f| > f_{Ny}$ 的信号内容都将被混叠（折叠）到基带 $[-f_{Ny}, f_{Ny}]$ 中。\n\n2. 向上延拓算子通过项 $e^{-2\\pi |\\mathbf{f}| z}$ 提供衰减。一个合理的准则是，要求滤波器在奈奎斯特边界 $f_{Ny}$ 处的衰减至少与容差 $\\varepsilon$ 一样强。这确保了在奈奎斯特频率或之外的任何频谱内容都被抑制到低于 $\\varepsilon$ 的水平。\n\n3. 我们将此条件形式化为：\n$$ e^{-2\\pi f_{Ny} z} \\le \\varepsilon $$\n这主要关注从拉普拉斯方程推导出的主要衰减因子。\n\n4. 我们解出 $f_{Ny}$ 以找到所需的最小奈奎斯特频率：\n$$ -2\\pi f_{Ny} z \\le \\ln(\\varepsilon) $$\n$$ 2\\pi f_{Ny} z \\ge -\\ln(\\varepsilon) = \\ln(1/\\varepsilon) $$\n$$ f_{Ny} \\ge \\frac{\\ln(1/\\varepsilon)}{2\\pi z} $$\n\n5. 代入 $f_{Ny} = 1/(2\\Delta x)$，其中 $\\Delta x$ 是粗网格间距，我们可以解出允许的最大间距 $\\Delta x_{\\max}$：\n$$ \\frac{1}{2\\Delta x} \\ge \\frac{\\ln(1/\\varepsilon)}{2\\pi z} $$\n$$ \\Delta x \\le \\frac{2\\pi z}{2\\ln(1/\\varepsilon)} = \\frac{\\pi z}{\\ln(1/\\varepsilon)} $$\n因此，建议的最大粗网格间距是：\n$$ \\Delta x_{\\max} = \\frac{\\pi z}{\\ln(1/\\varepsilon)} $$\n如果 $\\Delta x_{\\text{coarse}} \\le \\Delta x_{\\max}$，则测试所用的 $\\Delta x_{\\text{coarse}}$ 满足此准则。该准则正确地表明，更大的观测高度 $z$ 允许使用更大（更粗）的网格间距 $\\Delta x$，因为场在离源更远的地方自然更平滑。\n\n### 第3部分：算法实现\n\n该算法通过为每个测试案例实现两个计算路径并比较其结果来进行。\n\n1.  **参考（“真值”）路径：**\n    a. 定义一个间距为 $\\Delta x_{\\text{fine}} = L/N_{\\text{fine}}$ 的 $N_{\\text{fine}} \\times N_{\\text{fine}}$ 细网格。\n    b. 在此网格上构建磁化场 $M_{\\text{fine}}(x,y)$。\n    c. 计算其二维DFT，$\\hat{M}_{\\text{fine}}(\\mathbf{f})$。\n    d. 应用推导出的谱算子 $T(\\mathbf{f}_{\\text{fine}}, z)$ 得到 $\\hat{B}_{z,\\text{fine}} = \\hat{M}_{\\text{fine}} \\cdot T(\\mathbf{f}_{\\text{fine}}, z)$。\n    e. 计算二维逆DFT以获得空间场 $B_{z,\\text{fine}}(x,y)$。\n    f. 通过每 $R = N_{\\text{fine}}/N_{\\text{coarse}}$ 个样本取一个的方式，将 $B_{z,\\text{fine}}(x,y)$ 降采样到粗网格尺寸。此结果为 $B_{z,\\text{truth}}$。这模拟了采样前的理想低通滤波。\n\n2.  **粗网格优先路径：**\n    a. 定义一个间距为 $\\Delta x_{\\text{coarse}} = L/N_{\\text{coarse}}$ 的 $N_{\\text{coarse}} \\times N_{\\text{coarse}}$ 粗网格。\n    b. 在此粗网格上构建磁化场 $M_{\\text{coarse}}(x,y)$（对连续函数进行采样）。如果 $\\Delta x_{\\text{coarse}}$ 太大，此步骤会引入混叠。\n    c. 计算其二维DFT，$\\hat{M}_{\\text{coarse}}(\\mathbf{f})$。\n    d. 应用谱算子 $T(\\mathbf{f}_{\\text{coarse}}, z)$ 得到 $\\hat{B}_{z,\\text{coarse}} = \\hat{M}_{\\text{coarse}} \\cdot T(\\mathbf{f}_{\\text{coarse}}, z)$。\n    e. 计算二维逆DFT以获得空间场 $B_{z,\\text{coarse}}(x,y)$。\n\n3.  **分析：**\n    a. 计算泄漏比率 $\\ell = \\frac{\\|B_{z,\\text{coarse}} - B_{z,\\text{truth}}\\|_2}{\\|B_{z,\\text{truth}}\\|_2}$，其中 $\\|\\cdot\\|_2$ 是欧几里得（$\\ell_2$）范数。\n    b. 使用推导的公式计算 $\\Delta x_{\\max}$。\n    c. 判断准则是否满足：$\\Delta x_{\\text{coarse}} \\le \\Delta x_{\\max}$。\n    d. 报告元组 $[\\ell, \\Delta x_{\\max}, \\text{criterion\\_satisfied}]$。\n对每个测试用例重复此过程。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the computational geophysics problem on aliasing in magnetic forward modeling.\n    \"\"\"\n    \n    # Global parameters from the problem statement\n    L = 1000.0  # Domain size in meters\n    N_fine = 512  # Fine grid samples per axis\n    \n    # Magnetization frequencies in cycles/meter\n    f1 = 0.030\n    f2 = 0.045\n    u = 0.040\n    v = 0.015\n    \n    # Tolerance for oversampling criterion\n    epsilon = 0.01\n\n    test_cases = [\n        # (N_coarse, z_height)\n        (64, 50.0),\n        (64, 200.0),\n        (32, 50.0),\n    ]\n\n    results = []\n\n    for N_coarse, z in test_cases:\n        # --- 1. Grid and Frequency Setup ---\n        \n        # Fine Grid\n        dx_fine = L / N_fine\n        x_fine_1d = np.arange(N_fine) * dx_fine\n        y_fine_1d = np.arange(N_fine) * dx_fine\n        x_fine, y_fine = np.meshgrid(x_fine_1d, y_fine_1d, indexing='xy')\n        \n        fx_fine_1d = np.fft.fftfreq(N_fine, d=dx_fine)\n        fy_fine_1d = np.fft.fftfreq(N_fine, d=dx_fine)\n        fx_fine, fy_fine = np.meshgrid(fx_fine_1d, fy_fine_1d, indexing='xy')\n        f_mag_fine = np.sqrt(fx_fine**2 + fy_fine**2)\n\n        # Coarse Grid\n        dx_coarse = L / N_coarse\n        x_coarse_1d = np.arange(N_coarse) * dx_coarse\n        y_coarse_1d = np.arange(N_coarse) * dx_coarse\n        x_coarse, y_coarse = np.meshgrid(x_coarse_1d, y_coarse_1d, indexing='xy')\n\n        fx_coarse_1d = np.fft.fftfreq(N_coarse, d=dx_coarse)\n        fy_coarse_1d = np.fft.fftfreq(N_coarse, d=dx_coarse)\n        fx_coarse, fy_coarse = np.meshgrid(fx_coarse_1d, fy_coarse_1d, indexing='xy')\n        f_mag_coarse = np.sqrt(fx_coarse**2 + fy_coarse**2)\n\n        # --- 2. Synthetic Magnetization ---\n        def magnetization(x, y):\n            term1 = np.cos(2 * np.pi * f1 * x)\n            term2 = 0.5 * np.cos(2 * np.pi * f2 * y)\n            term3 = 0.8 * np.cos(2 * np.pi * (u * x + v * y))\n            return term1 + term2 + term3\n\n        # --- 3. Spectral Upward Continuation Operator ---\n        def get_operator(f_mag, z_height):\n            # T(f, z) = 2 * pi * |f| * exp(-2 * pi * |f| * z)\n            # Handle f=0 case to avoid 0 * inf -> nan\n            op = np.zeros_like(f_mag)\n            non_zero_f = f_mag > 0\n            op[non_zero_f] = (2 * np.pi * f_mag[non_zero_f] * \n                              np.exp(-2 * np.pi * f_mag[non_zero_f] * z_height))\n            return op\n\n        # --- 4. Compute \"Truth\" Result ---\n        # a. Create magnetization on fine grid\n        M_fine = magnetization(x_fine, y_fine)\n        \n        # b. FFT\n        M_hat_fine = np.fft.fft2(M_fine)\n        \n        # c. Apply upward continuation operator in spectral domain\n        T_fine = get_operator(f_mag_fine, z)\n        Bz_hat_fine = M_hat_fine * T_fine\n        \n        # d. IFFT to get spatial domain result\n        Bz_fine = np.fft.ifft2(Bz_hat_fine).real\n        \n        # e. Decimate to coarse grid size to get the 'truth'\n        R = N_fine // N_coarse\n        Bz_truth = Bz_fine[::R, ::R]\n\n        # --- 5. Compute \"Coarse-First\" Result ---\n        # a. Create magnetization on coarse grid (introduces aliasing)\n        M_coarse = magnetization(x_coarse, y_coarse)\n\n        # b. FFT\n        M_hat_coarse = np.fft.fft2(M_coarse)\n\n        # c. Apply upward continuation operator on coarse grid\n        T_coarse = get_operator(f_mag_coarse, z)\n        Bz_hat_coarse = M_hat_coarse * T_coarse\n\n        # d. IFFT\n        Bz_coarse = np.fft.ifft2(Bz_hat_coarse).real\n\n        # --- 6. Quantify Leakage ---\n        diff_norm = np.linalg.norm(Bz_coarse - Bz_truth)\n        truth_norm = np.linalg.norm(Bz_truth)\n        \n        leakage = diff_norm / truth_norm if truth_norm > 0 else 0.0\n\n        # --- 7. Evaluate Oversampling Criterion ---\n        # dx_max = (pi * z) / ln(1/epsilon)\n        dx_max = (np.pi * z) / np.log(1.0 / epsilon)\n        \n        # Check if the actual coarse grid spacing satisfies the criterion\n        criterion_satisfied = dx_coarse = dx_max\n\n        # --- 8. Store Results ---\n        results.append([leakage, dx_max, criterion_satisfied])\n\n    # Format output as specified in the problem statement\n    # Example: [[l_1,dx_max_1,b_1],[l_2,dx_max_2,b_2],[l_3,dx_max_3,b_3]]\n    output_str = \"[\" + \",\".join([f\"[{l},{dxm},{b}]\".lower() for l, dxm, b in results]) + \"]\"\n    print(output_str)\n\nsolve()\n```", "id": "3597756"}]}