{"hands_on_practices": [{"introduction": "从标量守恒定律进阶到方程组，能量守恒成为分析的核心。在有限计算域中模拟波传播时，通常需要使用完美匹配层（PML）来创建无反射的人工边界，而这些层会充当能量吸收器。此实践 [@problem_id:3580942] 演示了如何为一个带有人工阻尼的系统构建一个能量稳定的数值格式，其关键在于验证一个离散的能量*平衡*恒等式，即初始能量精确等于最终能量与PML耗散的总能量之和，从而确保格式的稳定性和物理合理性。", "problem": "你需要从质量、动量和能量守恒定律出发，为一维线性弹性剪切水平波的传播推导、离散化并验证一个能量稳定的完美匹配层。工作将在长度为 $L$ 的一维域中进行，空间坐标为 $x \\in [0,L]$，时间为 $t \\ge 0$。假设一个均匀、各向同性的弹性固体，其密度为 $\\rho$，剪切模量为 $\\mu$，并考虑剪切水平极化，使得唯一非零的运动学场是横向质点速度 $v(x,t)$，唯一非零的应力是剪应力 $\\tau(x,t)$。控制动量守恒和本构关系的是以下一阶双曲系统\n$$\n\\rho \\,\\partial_t v = \\partial_x \\tau, \\qquad \\partial_t \\tau = \\mu\\, \\partial_x v,\n$$\n其中 $\\partial_t$ 和 $\\partial_x$ 分别表示对 $t$ 和 $x$ 的偏导数。物理能量密度为\n$$\n\\mathcal{E}(x,t) = \\tfrac{1}{2}\\,\\rho\\, v^2 + \\tfrac{1}{2}\\,\\mu^{-1}\\,\\tau^2,\n$$\n在没有源项和外力做功的情况下，总能量 \n$$\nE_{\\mathrm{tot}}(t) = \\int_{0}^{L} \\mathcal{E}(x,t)\\, dx\n$$\n在边界通量（由机械功率 $\\tau v$ 给出）的意义下是守恒的。\n\n为了在界面 $x=x_{\\mathrm{p}}$ 处吸收出射波而不产生反射，引入一个占据域最右侧部分 $x \\in [x_{\\mathrm{p}}, L]$（其中 $x_{\\mathrm{p}} \\in (0,L)$）的完美匹配层（PML）。使用通过在PML子域内向一阶系统添加匹配的线性阻尼得到的分裂场、能量稳定的PML：\n$$\n\\rho \\,\\partial_t v + \\rho\\, \\sigma(x)\\, v = \\partial_x \\tau, \\qquad \\partial_t \\tau + \\sigma(x)\\, \\tau = \\mu\\, \\partial_x v,\n$$\n其中阻尼剖面 $\\sigma(x) \\ge 0$ 是光滑的，对于 $x \\in [0,x_{\\mathrm{p}}]$ 满足 $\\sigma(x)=0$，对于 $x \\in (x_{\\mathrm{p}}, L]$ 满足 $\\sigma(x) > 0$。物理-PML界面位于 $x=x_{\\mathrm{p}}$，此处的系数是连续的，且没有添加任何惩罚项或源项。\n\n你的任务是：\n\n- 从上述基本定律出发，推导PML下的连续能量平衡，证明\n$$\n\\frac{d}{dt} E_{\\mathrm{tot}}(t) = - \\int_{0}^{L} \\Big( \\rho\\, \\sigma(x)\\, v^2 + \\mu^{-1}\\, \\sigma(x)\\, \\tau^2 \\Big) \\, dx \\;-\\; \\left[\\tau v\\right]_{x=0}^{x=L}.\n$$\n解释为什么 $\\sigma$ 项是非负的，以及为什么在物理-PML界面 $x=x_{\\mathrm{p}}$ 处没有出现人为的源项。\n\n- 使用具有 $N_x$ 个单元和间距 $\\Delta x = L/N_x$ 的均匀交错网格对空间进行离散化。将 $v$ 置于单元中心 $x_i = (i+\\tfrac{1}{2}) \\Delta x$（$i=0,1,\\dots,N_x-1$），将 $\\tau$ 置于单元面 $x_{j} = j \\Delta x$（$j=0,1,\\dots,N_x$）。使用与此交错结构一致的中心差分：\n$$\n\\left(D_x \\tau\\right)_i = \\frac{\\tau_{i+1} - \\tau_i}{\\Delta x}, \\qquad \\left(D_x v\\right)_j = \\frac{v_{j} - v_{j-1}}{\\Delta x},\n$$\n并遵循明显的索引对应关系。通过施加 $\\tau_{0}(t)=0$ 和 $\\tau_{N_x}(t)=0$（对所有 $t$）来使用自由牵引边界。证明半离散（空间离散，时间连续）能量\n$$\nE_h(t) = \\sum_{i=0}^{N_x-1} \\tfrac{1}{2}\\,\\rho\\, v_i(t)^2 \\,\\Delta x \\;+\\; \\sum_{j=0}^{N_x} \\tfrac{1}{2}\\,\\mu^{-1}\\, \\tau_j(t)^2 \\,\\Delta x\n$$\n满足精确的半离散恒等式\n$$\n\\frac{d}{dt} E_h(t) \\;=\\; - \\sum_{i=0}^{N_x-1} \\rho\\, \\sigma_i\\, v_i(t)^2\\, \\Delta x \\;-\\; \\sum_{j=0}^{N_x} \\mu^{-1}\\, \\sigma_j\\, \\tau_j(t)^2\\, \\Delta x,\n$$\n前提是离散边界通量在自由牵引条件下消失，并且其中 $\\sigma_i=\\sigma(x_i)$ 和 $\\sigma_j=\\sigma(x_j)$。\n\n- 使用蛙跳格式在交错网格上对双曲耦合项进行时间离散化，并对线性阻尼项应用梯形法则（Crank–Nicolson）。用 $v_i^{n+\\tfrac{1}{2}} \\approx v(x_i, t^{n+\\tfrac{1}{2}})$ 和 $\\tau_j^{n} \\approx \\tau(x_j, t^n)$ 表示，其中 $t^n = n \\Delta t$。更新格式应为\n$$\n\\rho\\, \\frac{v_i^{n+\\tfrac{1}{2}} - v_i^{n-\\tfrac{1}{2}}}{\\Delta t} + \\rho\\, \\sigma_i\\, \\frac{v_i^{n+\\tfrac{1}{2}} + v_i^{n-\\tfrac{1}{2}}}{2} = \\left(D_x \\tau^{n}\\right)_i,\n$$\n$$\n\\frac{\\tau_j^{n+1} - \\tau_j^{n}}{\\Delta t} + \\sigma_j\\, \\frac{\\tau_j^{n+1} + \\tau_j^{n}}{2} = \\mu\\, \\left(D_x v^{n+\\tfrac{1}{2}}\\right)_j,\n$$\n其中对所有 $n$ 有 $\\tau_0^n = \\tau_{N_x}^n = 0$。定义全离散总能量\n$$\nE_h^n = \\sum_{i=0}^{N_x-1} \\tfrac{1}{2}\\,\\rho\\, \\left(v_i^{n+\\tfrac{1}{2}}\\right)^2 \\,\\Delta x \\;+\\; \\sum_{j=0}^{N_x} \\tfrac{1}{2}\\,\\mu^{-1}\\, \\left(\\tau_j^{n}\\right)^2 \\,\\Delta x\n$$\n和截至时间层 $n$ 的通过梯形法则计算的全离散累积PML耗散\n$$\n\\mathcal{D}_{\\mathrm{PML}}^{n} = \\sum_{k=0}^{n-1} \\Delta t \\left[ \\sum_{i=0}^{N_x-1} \\rho\\, \\sigma_i\\, \\frac{\\left(v_i^{k+\\tfrac{1}{2}}\\right)^2 + \\left(v_i^{k-\\tfrac{1}{2}}\\right)^2}{2}\\, \\Delta x \\;+\\; \\sum_{j=0}^{N_x} \\mu^{-1}\\, \\sigma_j\\, \\frac{\\left(\\tau_j^{k+1}\\right)^2 + \\left(\\tau_j^{k}\\right)^2}{2}\\, \\Delta x \\right].\n$$\n数值上证明，对于稳定的时间步长，离散能量恒等式\n$$\nE_h^{n} + \\mathcal{D}_{\\mathrm{PML}}^{n} \\approx E_h^{0}\n$$\n在一个小容差范围内成立，并且在物理-PML界面 $x=x_{\\mathrm{p}}$ 处没有伪源。\n\n- 在一个程序中实现上述格式，通过在 $t=0$ 时设置初始场来初始化一个纯右行波\n$$\nv(x,0) = A \\exp\\!\\left(-\\frac{(x-x_0)^2}{2 s^2}\\right), \\qquad \\tau(x,0) = Z\\, v(x,0), \\qquad Z = \\sqrt{\\rho\\, \\mu},\n$$\n其中 $x_0 \\in (0, x_{\\mathrm{p}})$ 且 $s>0$。使用 Courant–Friedrichs–Lewy (CFL) 时间步长 $\\Delta t = \\mathrm{CFL}\\, \\Delta x / c$，其中 $c = \\sqrt{\\mu/\\rho}$，以及一个多项式PML剖面\n$$\n\\sigma(x) = \\begin{cases}\n0,  x \\le x_{\\mathrm{p}}, \\\\[4pt]\n\\sigma_0 \\left( \\dfrac{x - x_{\\mathrm{p}}}{L_{\\mathrm{pml}}} \\right)^m,  x > x_{\\mathrm{p}},\n\\end{cases}\n$$\n其中 $L_{\\mathrm{pml}} = L - x_{\\mathrm{p}}$ 是PML厚度，$\\sigma_0  0$ 是峰值阻尼参数，$m \\in \\mathbb{N}$ 是一个小的偶数。在所有测试中，施加自由牵引边界 $\\tau(0,t)=0$ 和 $\\tau(L,t)=0$。计算在最终时间 $t = n \\Delta t$ 的残差\n$$\nR = \\left|\\, E_h^n + \\mathcal{D}_{\\mathrm{PML}}^{n} - E_h^{0}\\, \\right|\n$$\n并报告 $R$。\n\n使用以下物理单位和参数值：$\\rho$ 单位为 $\\mathrm{kg}\\,\\mathrm{m}^{-3}$，$\\mu$ 单位为 $\\mathrm{Pa}$，距离单位为 $\\mathrm{m}$，时间单位为 $\\mathrm{s}$，速度单位为 $\\mathrm{m}\\,\\mathrm{s}^{-1}$，应力单位为 $\\mathrm{Pa}$。使用 $\\rho = 2500$ 和 $\\mu = 10^{10}$。设置初始振幅 $A = 10^{-3}$，$x_0 = L/4$，$s = 50$。不使用角度。所有数值答案必须是无量纲的残差，以实值小数形式给出。\n\n测试套件。你的程序必须对以下四个测试用例运行该格式，并以单个列表的形式输出四个残差 $R$。\n\n- 案例1（基准PML）：$L=2000$, $N_x=800$, $\\mathrm{CFL}=0.5$, $N_{\\mathrm{pml}} = 200$, $\\sigma_0 = 200$, $m = 2$, $T=0.8$。\n- 案例2（无PML）：$L=2000$, $N_x=800$, $\\mathrm{CFL}=0.5$, $N_{\\mathrm{pml}} = 0$, $\\sigma_0 = 0$, $m = 2$, $T=0.4$。\n- 案例3（强PML）：$L=2000$, $N_x=800$, $\\mathrm{CFL}=0.5$, $N_{\\mathrm{pml}} = 160$, $\\sigma_0 = 800$, $m = 2$, $T=0.6$。\n- 案例4（薄PML层）：$L=2000$, $N_x=800$, $\\mathrm{CFL}=0.5$, $N_{\\mathrm{pml}} = 20$, $\\sigma_0 = 400$, $m = 2$, $T=0.5$。\n\n此处，$N_{\\mathrm{pml}}$ 是PML中的网格单元数，因此 $x_{\\mathrm{p}} = L - N_{\\mathrm{pml}} \\Delta x$ 且 $L_{\\mathrm{pml}} = N_{\\mathrm{pml}} \\Delta x$。时间步长为 $\\Delta t = \\mathrm{CFL}\\, \\Delta x / c$，其中 $c=\\sqrt{\\mu/\\rho}$，步数为 $n=\\lfloor T/\\Delta t \\rfloor$。在每个案例中，将残差 $R$ 报告为一个浮点数。\n\n最终输出格式。你的程序应该生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，按对应案例1到4的顺序排列为 $[R_1,R_2,R_3,R_4]$。", "solution": "该问题要求为一维线性弹性剪切水平（SH）波推导、离散化并验证一个能量稳定的完美匹配层（PML）。此过程分为几个任务，将依次进行处理。\n\n### 任务1：连续能量平衡推导\n\n系统在域 $[0, L]$ 内的总能量由下式给出\n$$\nE_{\\mathrm{tot}}(t) = \\int_{0}^{L} \\mathcal{E}(x,t)\\, dx = \\int_{0}^{L} \\left( \\tfrac{1}{2}\\,\\rho\\, v^2 + \\tfrac{1}{2}\\,\\mu^{-1}\\,\\tau^2 \\right) dx.\n$$\n为了找到能量平衡，我们计算 $E_{\\mathrm{tot}}(t)$ 的时间导数。假设场足够光滑，我们可以在积分号下进行微分：\n$$\n\\frac{dE_{\\mathrm{tot}}}{dt} = \\int_{0}^{L} \\partial_t \\mathcal{E}(x,t) dx = \\int_{0}^{L} \\left( \\rho v\\, \\partial_t v + \\mu^{-1} \\tau\\, \\partial_t \\tau \\right) dx.\n$$\n包含PML阻尼项 $\\sigma(x)$ 的控制方程为：\n$$\n\\rho \\,\\partial_t v = \\partial_x \\tau - \\rho\\, \\sigma(x)\\, v, \\qquad \\partial_t \\tau = \\mu\\, \\partial_x v - \\sigma(x)\\, \\tau.\n$$\n我们可以将第二个方程重写为 $\\mu^{-1} \\partial_t \\tau = \\partial_x v - \\mu^{-1}\\sigma(x)\\tau$。将这些关于 $\\rho\\,\\partial_t v$ 和 $\\mu^{-1}\\,\\partial_t \\tau$ 的表达式代入能量变化率的被积函数中，得到：\n$$\n\\partial_t \\mathcal{E} = v \\left( \\partial_x \\tau - \\rho\\, \\sigma v \\right) + \\tau \\left( \\partial_x v - \\mu^{-1} \\sigma \\tau \\right)\n$$\n$$\n\\partial_t \\mathcal{E} = (v\\, \\partial_x \\tau + \\tau\\, \\partial_x v) - \\left( \\rho\\, \\sigma v^2 + \\mu^{-1} \\sigma \\tau^2 \\right).\n$$\n使用导数的乘法法则，$v\\, \\partial_x \\tau + \\tau\\, \\partial_x v = \\partial_x(\\tau v)$。因此，能量密度的变化率为：\n$$\n\\partial_t \\mathcal{E} = \\partial_x(\\tau v) - \\left( \\rho\\, \\sigma v^2 + \\mu^{-1} \\sigma \\tau^2 \\right).\n$$\n将此表达式在域 $[0, L]$ 上积分，得到总能量平衡：\n$$\n\\frac{dE_{\\mathrm{tot}}}{dt} = \\int_{0}^{L} \\partial_x(\\tau v) dx - \\int_{0}^{L} \\left( \\rho\\, \\sigma(x)\\, v^2 + \\mu^{-1}\\, \\sigma(x)\\, \\tau^2 \\right) dx.\n$$\n对第一个积分应用微积分基本定理，我们得到 $\\int_{0}^{L} \\partial_x(\\tau v) dx = [\\tau v]_{x=0}^{x=L}$。项 $-[\\tau v]_{x=0}^{x=L}$ 表示流入域内的净能量通量。标准惯例是将能量平衡写为能量变化率等于净功率输入减去任何耗散。在边界处流出域的功率通量由机械功率 $\\tau v$ 给出。因此，总能量变化率为：\n$$\n\\frac{dE_{\\mathrm{tot}}}{dt} = - \\int_{0}^{L} \\left( \\rho\\, \\sigma(x)\\, v^2 + \\mu^{-1}\\, \\sigma(x)\\, \\tau^2 \\right) dx - \\left[\\tau v\\right]_{x=0}^{x=L}.\n$$\n这与问题陈述中给出的表达式相符。\n\n项 $\\mathcal{W}_{\\mathrm{PML}} = \\rho\\, \\sigma(x)\\, v^2 + \\mu^{-1}\\, \\sigma(x)\\, \\tau^2$ 表示PML单位长度的能量耗散率。由于材料属性 $\\rho$ 和 $\\mu$ 是正的，并且阻尼剖面定义为非负，即 $\\sigma(x) \\ge 0$，因此 $\\mathcal{W}_{\\mathrm{PML}}$ 中的每一项都是非负的。因此，积分 $\\int_0^L \\mathcal{W}_{\\mathrm{PML}}(x, t) dx$ 也是非负的，这证实了PML项对应于能量耗散（或在 $\\sigma=0$ 的地方为零），绝不会产生能量。\n\n在物理-PML界面 $x=x_{\\mathrm{p}}$ 处没有出现人为的源项，因为控制方程的构建使其在整个域 $[0,L]$ 上都有效。阻尼剖面 $\\sigma(x)$ 被定义为连续的（实际上是光滑的），因此偏微分方程的系数在 $x=x_{\\mathrm{p}}$ 处是连续的。推导过程涉及标准的微积分运算（乘法法则、分部积分），在函数及其系数连续的界面上，这些运算不会引入任何奇异项或跳跃条件。\n\n### 任务2：半离散能量平衡推导\n\n半离散系统是通过仅在空间上进行离散化得到的。方程如下：\n$$\n\\rho \\frac{d v_i}{dt} = \\frac{\\tau_{i+1} - \\tau_i}{\\Delta x} - \\rho \\sigma_i v_i, \\qquad i=0,\\dots,N_x-1\n$$\n$$\n\\frac{d \\tau_j}{dt} = \\mu \\frac{v_j - v_{j-1}}{\\Delta x} - \\sigma_j \\tau_j, \\qquad j=1,\\dots,N_x-1\n$$\n边界条件为 $\\tau_0(t)=\\tau_{N_x}(t)=0$。因此时间导数 $\\dot{\\tau}_0$ 和 $\\dot{\\tau}_{N_x}$ 也为零。\n\n半离散总能量由下式给出：\n$$\nE_h(t) = \\sum_{i=0}^{N_x-1} \\tfrac{1}{2}\\,\\rho\\, v_i^2 \\,\\Delta x + \\sum_{j=0}^{N_x} \\tfrac{1}{2}\\,\\mu^{-1}\\, \\tau_j^2 \\,\\Delta x.\n$$\n对时间求导：\n$$\n\\frac{dE_h}{dt} = \\sum_{i=0}^{N_x-1} \\rho v_i \\frac{dv_i}{dt} \\Delta x + \\sum_{j=0}^{N_x} \\mu^{-1} \\tau_j \\frac{d\\tau_j}{dt} \\Delta x.\n$$\n由于 $\\dot{\\tau}_0=\\dot{\\tau}_{N_x}=0$，第二个求和实际上是从 $j=1$ 到 $N_x-1$。代入半离散方程：\n$$\n\\frac{dE_h}{dt} = \\sum_{i=0}^{N_x-1} v_i (\\tau_{i+1} - \\tau_i) - \\sum_{i=0}^{N_x-1} \\rho \\sigma_i v_i^2 \\Delta x + \\sum_{j=1}^{N_x-1} \\tau_j (v_j - v_{j-1}) - \\sum_{j=1}^{N_x-1} \\mu^{-1} \\sigma_j \\tau_j^2 \\Delta x.\n$$\n我们使用分部求和法来分析通量项：\n$$\n\\sum_{i=0}^{N_x-1} v_i (\\tau_{i+1} - \\tau_i) = \\sum_{i=0}^{N_x-1} v_i \\tau_{i+1} - \\sum_{i=0}^{N_x-1} v_i \\tau_i.\n$$\n在第一项中改变求和指标（$k=i+1$）：\n$$\n\\sum_{k=1}^{N_x} v_{k-1} \\tau_k - \\sum_{i=0}^{N_x-1} v_i \\tau_i = (v_{N_x-1}\\tau_{N_x} - v_0\\tau_0) + \\sum_{i=1}^{N_x-1} (v_{i-1} - v_i)\\tau_i = (v_{N_x-1}\\tau_{N_x} - v_0\\tau_0) - \\sum_{i=1}^{N_x-1} \\tau_i (v_i - v_{i-1}).\n$$\n对 $\\frac{dE_h}{dt}$ 的总通量贡献（非耗散部分）是：\n$$\n\\sum_{i=0}^{N_x-1} v_i (\\tau_{i+1} - \\tau_i) + \\sum_{j=1}^{N_x-1} \\tau_j(v_j-v_{j-1}) = (v_{N_x-1}\\tau_{N_x} - v_0\\tau_0) - \\sum_{j=1}^{N_x-1} \\tau_j (v_j - v_{j-1}) + \\sum_{j=1}^{N_x-1} \\tau_j(v_j - v_{j-1}).\n$$\n求和项相互抵消，剩下离散边界通量：$v_{N_x-1}\\tau_{N_x} - v_0\\tau_0$。考虑到自由牵引边界条件 $\\tau_0=0$ 和 $\\tau_{N_x}=0$，此边界通量项为零。\n\n完整的能量平衡就只剩下耗散项之和：\n$$\n\\frac{dE_h}{dt} = - \\sum_{i=0}^{N_x-1} \\rho \\sigma_i v_i^2 \\Delta x - \\sum_{j=1}^{N_x-1} \\mu^{-1} \\sigma_j \\tau_j^2 \\Delta x.\n$$\n由于 $\\tau_0 = \\tau_{N_x} = 0$，它们对 $\\tau$ 的耗散求和的贡献为零。因此，我们可以将求和写成遍历所有应力点 $j=0, \\dots, N_x$ 而不改变结果，从而与要求的表达式匹配：\n$$\n\\frac{d}{dt} E_h(t) = - \\sum_{i=0}^{N_x-1} \\rho\\, \\sigma_i\\, v_i^2\\, \\Delta x - \\sum_{j=0}^{N_x} \\mu^{-1}\\, \\sigma_j\\, \\tau_j^2\\, \\Delta x.\n$$\n\n### 任务3和4：全离散格式、能量恒等式及实现\n\n所提供的全离散格式在交错的时间层级上更新速度 $v$ 和应力 $\\tau$。实现过程需要仔细处理蛙跳格式的初始化、主时间步进循环以及离散能量和耗散项的计算。\n\n**格式重排**：可以重排更新方程，以求解新时间层级上的场。\n对于 $v_i^{n+1/2}$：\n$$\nv_i^{n+\\tfrac{1}{2}} = \\frac{ 1 - \\frac{\\sigma_i \\Delta t}{2} }{ 1 + \\frac{\\sigma_i \\Delta t}{2} } v_i^{n-\\tfrac{1}{2}} + \\frac{\\Delta t/\\rho}{ 1 + \\frac{\\sigma_i \\Delta t}{2} } \\left(\\frac{\\tau_{i+1}^{n} - \\tau_i^n}{\\Delta x}\\right)\n$$\n对于 $\\tau_j^{n+1}$：\n$$\n\\tau_j^{n+1} = \\frac{1 - \\frac{\\sigma_j \\Delta t}{2}}{1 + \\frac{\\sigma_j \\Delta t}{2}} \\tau_j^n + \\frac{\\mu \\Delta t}{1 + \\frac{\\sigma_j \\Delta t}{2}} \\left(\\frac{v_j^{n+\\tfrac{1}{2}} - v_{j-1}^{n+\\tfrac{1}{2}}}{\\Delta x}\\right)\n$$\n\n**初始化**：为了实现二阶精度的蛙跳格式启动，我们需要 $t=-\\Delta t/2$ 时的 $v$。这可以通过使用泰勒展开从 $t=0$ 的条件来近似：$v(x, -\\Delta t/2) \\approx v(x,0) - \\frac{\\Delta t}{2}\\partial_t v(x,0)$。使用偏微分方程，$\\partial_t v(0) = \\frac{1}{\\rho}\\partial_x \\tau(0)$。这导致了离散初始化 $v_i^{-1/2} = v_i(0) - \\frac{\\Delta t}{2\\rho}(D_x\\tau^0)_i$。\n\n**能量平衡解释**：问题要求在最终时刻验证 $E_h^{n} + \\mathcal{D}_{\\mathrm{PML}}^{n} \\approx E_h^{0}$。$E_h^n$ 和 $\\mathcal{D}_{\\mathrm{PML}}^n$ 的定义略显不寻常但很明确。设总时间步数为 $N_t = \\lfloor T/\\Delta t \\rfloor$。一个一致的解释是在倒数第二个时间步检查该恒等式，即 $n=N_t-1$。这意味着我们检查：\n$$\nE_h^{N_t-1} + \\mathcal{D}_{\\mathrm{PML}}^{N_t-1} \\approx E_h^0.\n$$\n各项为：\n- $E_h^0 = \\sum_{i} \\tfrac{1}{2}\\,\\rho\\,(v_i^{1/2})^2 \\Delta x + \\sum_{j} \\tfrac{1}{2}\\,\\mu^{-1}\\,(\\tau_j^0)^2 \\Delta x$。这是在一次速度半步更新后计算的。\n- $E_h^{N_t-1} = \\sum_{i} \\tfrac{1}{2}\\,\\rho\\,(v_i^{N_t-1/2})^2 \\Delta x + \\sum_{j} \\tfrac{1}{2}\\,\\mu^{-1}\\,(\\tau_j^{N_t-1})^2 \\Delta x$。这是使用最后可用的场计算的能量。\n- $\\mathcal{D}_{\\mathrm{PML}}^{N_t-1} = \\sum_{k=0}^{N_t-2} \\Delta t \\left[ \\dots \\right]$。这是在 $N_t-1$ 步内的累积耗散。\n\n数值实现将执行时间步进循环 $N_t-1$ 次，在每一步计算并累积离散耗散。最后，将初始能量与最终能量和总累积耗散之和进行比较，以求得残差 $R$。", "answer": "```python\nimport numpy as np\n\ndef run_simulation(L, Nx, CFL, Npml, sigma0, m, T, rho, mu, A, x0_factor, s):\n    # Numerical and physical parameter setup\n    dx = L / Nx\n    c = np.sqrt(mu / rho)\n    dt = CFL * dx / c\n    Nt = int(T / dt)\n    Z = np.sqrt(rho * mu)\n    x0 = L * x0_factor\n\n    # Staggered grids for velocity (v) and stress (tau)\n    x_v = (np.arange(Nx) + 0.5) * dx\n    x_tau = np.arange(Nx + 1) * dx\n\n    # PML damping profile setup\n    sigma_v = np.zeros(Nx)\n    sigma_tau = np.zeros(Nx + 1)\n    if Npml > 0:\n        xp = L - Npml * dx\n        Lpml = Npml * dx\n        \n        idx_v_pml = np.where(x_v > xp)\n        sigma_v[idx_v_pml] = sigma0 * ((x_v[idx_v_pml] - xp) / Lpml)**m\n\n        idx_tau_pml = np.where(x_tau > xp)\n        sigma_tau[idx_tau_pml] = sigma0 * ((x_tau[idx_tau_pml] - xp) / Lpml)**m\n    \n    # Pre-compute update coefficients for efficiency\n    Cv1 = (1 - sigma_v * dt / 2) / (1 + sigma_v * dt / 2)\n    Cv2 = (dt / rho) / (1 + sigma_v * dt / 2)\n    Ctau1 = (1 - sigma_tau * dt / 2) / (1 + sigma_tau * dt / 2)\n    Ctau2 = (mu * dt) / (1 + sigma_tau * dt / 2)\n\n    # Initialization of fields\n    # v_ic and tau_ic are the fields at t=0\n    v_ic = A * np.exp(-(x_v - x0)**2 / (2 * s**2))\n    tau_ic = Z * A * np.exp(-(x_tau - x0)**2 / (2 * s**2))\n    \n    tau_curr = tau_ic.copy()\n    tau_curr[0] = 0\n    tau_curr[Nx] = 0\n\n    # Leapfrog startup: v_prev is v at t = -dt/2\n    dtau_dx_0 = (tau_curr[1:] - tau_curr[:-1]) / dx\n    v_prev = v_ic - (dt / (2 * rho)) * (dtau_dx_0 - sigma_v * v_ic)\n\n    # Calculate initial energy E_h^0\n    # First, compute v_curr (v at t = dt/2)\n    dtau_dx = (tau_curr[1:] - tau_curr[:-1]) / dx\n    v_curr = Cv1 * v_prev + Cv2 * dtau_dx\n    \n    KE0 = 0.5 * rho * np.sum(v_curr**2) * dx\n    PE0 = 0.5 / mu * np.sum(tau_curr**2) * dx\n    E_h0 = KE0 + PE0\n    \n    # Main time-stepping loop\n    D_pml_total = 0.0\n    \n    n_final = Nt if T/dt == Nt else Nt + 1\n    \n    # We loop n_final-1 times to compute fields up to tau^{n_final-1} and v^{n_final-1/2}\n    for n in range(n_final - 1):\n        # Update tau from time n to n+1\n        dv_dx = (v_curr[1:] - v_curr[:-1]) / dx\n        tau_next = np.zeros_like(tau_curr)\n        tau_next[1:-1] = Ctau1[1:-1] * tau_curr[1:-1] + Ctau2[1:-1] * dv_dx\n        \n        # Update cumulative dissipation using trapezoidal rule for the step\n        diss_v = rho * sigma_v * (v_curr**2 + v_prev**2) / 2\n        diss_tau = (1/mu) * sigma_tau * (tau_next**2 + tau_curr**2) / 2\n        D_pml_total += dt * dx * (np.sum(diss_v) + np.sum(diss_tau))\n        \n        # Cycle states for the next iteration\n        v_prev = v_curr\n        tau_curr = tau_next\n        \n        # Update v from time n+1/2 to n+3/2\n        dtau_dx = (tau_curr[1:] - tau_curr[:-1]) / dx\n        v_curr = Cv1 * v_prev + Cv2 * dtau_dx\n\n    # Calculate final energy and residual\n    # v_curr is now v at t = (n_final-1/2)*dt\n    # tau_curr is now tau at t = (n_final-1)*dt\n    KE_final = 0.5 * rho * np.sum(v_curr**2) * dx\n    PE_final = 0.5 / mu * np.sum(tau_curr**2) * dx\n    E_h_final = KE_final + PE_final\n    \n    # R = | E_final + Dissipation - E_initial |\n    residual = np.abs(E_h_final + D_pml_total - E_h0)\n    \n    return residual\n\ndef solve():\n    # Define physical parameters\n    rho = 2500.0  # kg/m^3\n    mu = 1e10    # Pa\n    A = 1e-3     # m/s\n    s = 50.0     # m\n    x0_factor = 0.25 # x0 = L/4\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (L, Nx, CFL, Npml, sigma0, m, T)\n        (2000.0, 800, 0.5, 200, 200.0, 2, 0.8), # Case 1\n        (2000.0, 800, 0.5, 0, 0.0, 2, 0.4),    # Case 2\n        (2000.0, 800, 0.5, 160, 800.0, 2, 0.6), # Case 3\n        (2000.0, 800, 0.5, 20, 400.0, 2, 0.5),  # Case 4\n    ]\n\n    results = []\n    for L, Nx, CFL, Npml, sigma0, m, T in test_cases:\n        residual = run_simulation(L, Nx, CFL, Npml, sigma0, m, T, rho, mu, A, x0_factor, s)\n        results.append(residual)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.15e}' for r in results)}]\")\n\nsolve()\n```", "id": "3580942"}, {"introduction": "现在我们考虑一个更复杂的系统，它同时包含物理耗散（塑性）和数值耗散。对于弹塑性动力学这类问题，确保数值格式是“熵稳定”的至关重要，这可以防止非物理的能量增长。本高级练习 [@problem_id:3580945] 要求实现间断Galerkin（DG）方法和塑性返回映射算法，以验证一个离散的能量不等式，从而证实总能量的减少正确地来源于物理塑性做功和格式固有的数值耗散，这是一个鲁棒熵稳定格式的标志。", "problem": "考虑一维小应变弹性动力学，其在空间域 $x \\in [0,L]$ 上具有弹塑性流变学特性和周期性边界条件。主要场是速度 $v(x,t)$ 和柯西应力 $\\sigma(x,t)$。密度为 $\\rho  0$，弹性模量为 $E  0$。设总应变为 $\\varepsilon(x,t)$，塑性应变为 $\\varepsilon^p(x,t)$。第一性原理基础包括：(i) 线性动量守恒 $\\rho \\, \\partial_t v = \\partial_x \\sigma$，(ii) 运动学相容性 $\\partial_t \\varepsilon = \\partial_x v$，(iii) 描述弹性响应的胡克定律 $\\sigma = E (\\varepsilon - \\varepsilon^p)$，以及 (iv) 具有屈服应力 $\\sigma_y \\ge 0$ 和关联流动的理想塑性，该流动强制 $|\\sigma| \\le \\sigma_y$ 且塑性耗散密度率 $\\mathcal{D} = \\sigma \\, \\dot{\\varepsilon}^p \\ge 0$。结合 (i)-(iii) 可得带源项的对称双曲一阶系统，\n$$\n\\partial_t \\begin{bmatrix} v \\\\ \\sigma \\end{bmatrix}\n+ \\partial_x \\begin{bmatrix} -\\sigma/\\rho \\\\ -E v \\end{bmatrix}\n= \\begin{bmatrix} 0 \\\\ -E \\, \\dot{\\varepsilon}^p \\end{bmatrix}.\n$$\n定义机械能密度\n$$\n\\eta(v,\\sigma) = \\tfrac{1}{2} \\rho v^2 + \\tfrac{1}{2}\\, \\sigma^2/E,\n$$\n及相应的能量通量 $g(v,\\sigma) = -\\sigma v$。(i)-(iv) 所蕴含的连续介质能量平衡为\n$$\n\\frac{d}{dt} \\int_0^L \\eta \\, dx = \\left[ g \\right]_0^L - \\int_0^L \\sigma \\, \\dot{\\varepsilon}^p \\, dx,\n$$\n对于周期性边界，由于通量项抵消，该式简化为\n$$\n\\frac{d}{dt} \\int_0^L \\eta \\, dx = - \\int_0^L \\sigma \\, \\dot{\\varepsilon}^p \\, dx \\le 0\n$$\n\n您的任务是构建一个分片常数间断伽辽金 (DG) 方法（该方法与迎风有限体积格式一致），该方法是熵稳定的，即它满足能量不等式的离散对应形式：\n$$\n\\frac{d}{dt} E_h(t) \\le - \\sum_{K} \\int_{K} \\sigma \\, \\dot{\\varepsilon}^p \\, dx,\n$$\n其中 $E_h(t)$ 是半离散总能量。您必须基于以下原则构建您的方法，不使用快捷公式：\n\n1. 从上述一阶系统在 $[0,L]$ 的一个剖分（划分为 $N$ 个大小为 $\\Delta x = L/N$ 的单元）上的弱形式出发，并采用周期性边界条件。\n2. 每个单元使用单自由度（分片常数基），以及一个双分量状态 $q = [v,\\sigma]^T$。\n3. 推导半离散格式\n$$\n\\frac{d}{dt} q_i(t) = - \\frac{1}{\\Delta x} \\left( f^*_{i+1/2} - f^*_{i-1/2} \\right) + s(q_i),\n$$\n其中 $f(q) = [-\\sigma/\\rho,\\ -E v]^T$， $s(q) = [0,\\ -E \\dot{\\varepsilon}^p]^T$，且 $f^*_{i \\pm 1/2}$ 是相容的数值通量。\n4. 在每个界面上使用波速界为 $\\alpha \\ge \\sqrt{E/\\rho}$ 的局部 Lax-Friedrichs (Rusanov) 通量：\n$$\nf^*(q_L,q_R) = \\tfrac{1}{2}\\left(f(q_L) + f(q_R)\\right) - \\tfrac{1}{2}\\, \\alpha \\, (q_R - q_L).\n$$\n5. 证明该系统是对称双曲系统，其对称化子为 $H = \\mathrm{diag}(\\rho, 1/E)$，并且上述通量能够导出一个形式如下的离散能量不等式\n$$\n\\frac{d}{dt} E_h(t) + \\sum_{\\text{interfaces}} \\tfrac{1}{2}\\, \\alpha \\, \\| \\![ q ]\\!\\|_H^2 \\le - \\sum_{i} \\Delta x \\, \\sigma_i \\, \\dot{\\varepsilon}_i^p,\n$$\n其中 $E_h(t) = \\sum_i \\Delta x \\, \\eta(v_i,\\sigma_i)$，跳跃为 $\\![ q ]\\! = q_R - q_L$，且 $\\|w\\|_H^2 = w^T H w$。\n6. 对于时间离散化，对齐次部分（不含塑性）使用强稳定性保持龙格-库塔 (SSP-RK) 积分器，然后应用一个局部的、基于单元的塑性返回映射投影，该投影强制 $|\\sigma| \\le \\sigma_y$ 并考虑塑性耗散。在一维空间和理想塑性条件下，当 $|\\sigma^{\\mathrm{tr}}|  \\sigma_y$ 时，从试验应力 $\\sigma^{\\mathrm{tr}}$ 到容许应力 $\\sigma^{\\mathrm{ad}} = \\sigma_y \\, \\mathrm{sign}(\\sigma^{\\mathrm{tr}})$ 的一个相容的、能量耗散的修正确认了塑性应变增量\n$$\n\\Delta \\varepsilon^p = \\frac{|\\sigma^{\\mathrm{tr}}| - \\sigma_y}{E},\n$$\n以及一个单位体积的塑性耗散增量，该增量等于应力沿修正路径的线积分，\n$$\n\\Delta \\mathcal{D} = \\int \\sigma \\, d\\varepsilon^p = \\tfrac{1}{2}\\left(|\\sigma^{\\mathrm{tr}}|+\\sigma_y\\right)\\Delta \\varepsilon^p = \\frac{|\\sigma^{\\mathrm{tr}}|^2 - \\sigma_y^2}{2E} \\ge 0,\n$$\n这恰好等于投影过程中弹性势能密度 $\\tfrac{1}{2}(\\sigma^2/E)$ 的减少量。\n\n您必须在单个程序中实现上述方法，以推进具有周期性边界的解。使用满足 Courant-Friedrichs-Lewy (CFL) 条件的显式时间步长。通过在每个时间步将每个单元的塑性耗散增量乘以单元体积再求和，来累积总塑性耗散 $D_{\\mathrm{tot}}$。\n\n数值单位与最终输出：\n\n- 使用国际单位制。具体来说，长度 $L$ 单位为 $\\mathrm{m}$，密度 $\\rho$ 单位为 $\\mathrm{kg/m^3}$，弹性模量 $E$ 单位为 $\\mathrm{Pa}$，应力 $\\sigma$ 和屈服应力 $\\sigma_y$ 单位为 $\\mathrm{Pa}$，时间 $t$ 单位为 $\\mathrm{s}$，能量单位为 $\\mathrm{J}$。\n- 程序必须在单行输出一个用方括号括起来的逗号分隔列表，不含空格，包含三个浮点数和三个布尔值：$[e_1,e_2,e_3,b_1,b_2,b_3]$，其中\n  - $e_1$ 是纯弹性测试的最终总能量减去初始总能量 $E_h(T) - E_h(0)$，单位为 $\\mathrm{J}$，\n  - $e_2$ 是弹塑性测试中相对于塑性耗散的最终能量亏损 $E_h(T) - (E_h(0) - D_{\\mathrm{tot}})$，单位为 $\\mathrm{J}$，\n  - $e_3$ 是接近CFL极限的弹性测试的最终能量减去初始能量 $E_h(T) - E_h(0)$，单位为 $\\mathrm{J}$，\n  - $b_1$ 是一个布尔值，如果 $e_1 \\le \\tau_1$ 且 $\\tau_1 = 10^{-8} E_h(0)$，则必须为真（无虚假弹性势能增长），\n  - $b_2$ 是一个布尔值，如果 $E_h(T) \\le E_h(0) + \\tau_2$ 和 $e_2 \\le \\tau_2$ 同时成立，且 $\\tau_2 = 10^{-8} \\max\\{E_h(0), D_{\\mathrm{tot}}, 1\\}$，则必须为真（塑性耗散得到遵守且无虚假增长），\n  - $b_3$ 是一个布尔值，如果 $e_3 \\le \\tau_3$ 且 $\\tau_3 = 10^{-8} E_h(0)$，则必须为真（在稳定性极限附近无虚假增长）。\n\n测试套件：\n\n为以下三个具有周期性边界的测试案例实现该方法，并按上述规定报告指标。在所有情况下，设横截面积等于 $1\\,\\mathrm{m}^2$，以便能量单位为 $\\mathrm{J}$。\n\n- 测试 $1$（纯弹性，中等 CFL）：\n  - $L = 1\\,\\mathrm{m}$，\n  - $N = 200$ 个单元，\n  - $\\rho = 2500\\,\\mathrm{kg/m^3}$，\n  - $E = 10^{10}\\,\\mathrm{Pa}$，\n  - $\\sigma_y = 10^{18}\\,\\mathrm{Pa}$（等效于弹性），\n  - 初始条件 $v(x,0) = 0$，$\\sigma(x,0) = S_0 \\sin(2\\pi x/L)$，其中 $S_0 = 5 \\times 10^{6}\\,\\mathrm{Pa}$，\n  - CFL 数 = $0.5$，\n  - 最终时间 $T = 2 \\times 10^{-4}\\,\\mathrm{s}$。\n- 测试 $2$（弹塑性，中等 CFL）：\n  - $L = 1\\,\\mathrm{m}$，\n  - $N = 200$ 个单元，\n  - $\\rho = 2500\\,\\mathrm{kg/m^3}$，\n  - $E = 10^{10}\\,\\mathrm{Pa}$，\n  - $\\sigma_y = 10^{6}\\,\\mathrm{Pa}$，\n  - 初始条件 $v(x,0) = 0$，$\\sigma(x,0) = S_0 \\sin(2\\pi x/L)$，其中 $S_0 = 3 \\times 10^{6}\\,\\mathrm{Pa}$，\n  - CFL 数 = $0.5$，\n  - 最终时间 $T = 2 \\times 10^{-4}\\,\\mathrm{s}$。\n- 测试 $3$（纯弹性，接近CFL极限）：\n  - $L = 1\\,\\mathrm{m}$，\n  - $N = 200$ 个单元，\n  - $\\rho = 2500\\,\\mathrm{kg/m^3}$，\n  - $E = 5 \\times 10^{10}\\,\\mathrm{Pa}$，\n  - $\\sigma_y = 10^{18}\\,\\mathrm{Pa}$，\n  - 初始条件 $v(x,0) = 0$，$\\sigma(x,0) = S_0 \\sin(2\\pi x/L)$，其中 $S_0 = 5 \\times 10^{6}\\,\\mathrm{Pa}$，\n  - CFL 数 = $0.95$，\n  - 最终时间 $T = 1 \\times 10^{-4}\\,\\mathrm{s}$。\n\n算法要求：\n\n- 使用所述的 Rusanov 通量和三阶强稳定性保持龙格-库塔积分器处理齐次部分，\n- 在每个完整时间步结束时应用局部塑性投影，并使用上述线积分表达式累积塑性耗散，\n- 在计算数值通量时，一致地使用周期性边界，\n- 计算并报告 $e_1$、$e_2$、$e_3$（单位 $\\mathrm{J}$）以及定义的布尔值 $b_1$、$b_2$、$b_3$。\n\n您的程序应产生单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果（例如，\"[result1,result2,result3]\"），不含空格，严格按照 $[e_1,e_2,e_3,b_1,b_2,b_3]$ 的顺序。", "solution": "该问题是有效的。它提出了一个基于连续介质力学原理（具体为具有率无关塑性的一维弹性动力学）的、适定的物理系统。控制方程、初始条件、边界条件和材料参数都得到了清晰且一致的规定。任务涉及推导和实现一个标准的、熵稳定的数值方法（有限体积格式，等同于分片常数间断伽辽金方法）来求解该系统，这在计算地球物理学和力学中是一项常见而有意义的练习。所有必要信息均已提供，问题没有科学缺陷、模糊性或矛盾之处。\n\n我们继续推导数值格式并按要求证明其能量稳定性。\n\n控制方程以带源项的一阶守恒律系统形式给出：\n$$\n\\partial_t \\mathbf{q} + \\partial_x \\mathbf{f}(\\mathbf{q}) = \\mathbf{s}(\\mathbf{q})\n$$\n其中状态向量为 $\\mathbf{q} = [v, \\sigma]^T$，通量函数为 $\\mathbf{f}(\\mathbf{q}) = [-\\sigma/\\rho, -E v]^T$，模拟塑性效应的源项为 $\\mathbf{s}(\\mathbf{q}) = [0, -E \\dot{\\varepsilon}^p]^T$。\n\n为了构建有限体积格式，我们将该系统在一个大小为 $\\Delta x$ 的计算单元 $K_i = [x_{i-1/2}, x_{i+1/2}]$ 上积分。\n$$\n\\int_{K_i} \\partial_t \\mathbf{q} \\, dx + \\int_{K_i} \\partial_x \\mathbf{f}(\\mathbf{q}) \\, dx = \\int_{K_i} \\mathbf{s}(\\mathbf{q}) \\, dx\n$$\n对通量项使用微积分基本定理，并使用单元平均值 $\\mathbf{q}_i(t) \\approx \\frac{1}{\\Delta x} \\int_{K_i} \\mathbf{q}(x,t) \\, dx$ 来近似单元积分，我们得到：\n$$\n\\Delta x \\frac{d\\mathbf{q}_i}{dt} + \\left( \\mathbf{f}( \\mathbf{q}(x_{i+1/2},t) ) - \\mathbf{f}( \\mathbf{q}(x_{i-1/2},t) ) \\right) = \\Delta x \\, \\mathbf{s}(\\mathbf{q}_i)\n$$\n在单元界面 $x_{i \\pm 1/2}$ 处，状态 $\\mathbf{q}$ 是不连续的。我们用一个相容且稳定的数值通量函数 $\\mathbf{f}^*(\\mathbf{q}_L, \\mathbf{q}_R)$ 替换精确通量 $\\mathbf{f}$，其中 $\\mathbf{q}_L = \\mathbf{q}_i$ 和 $\\mathbf{q}_R = \\mathbf{q}_{i+1}$ 分别是界面左右两侧的状态。这产生了半离散格式：\n$$\n\\frac{d\\mathbf{q}_i}{dt} = - \\frac{1}{\\Delta x} \\left( \\mathbf{f}^*_{i+1/2} - \\mathbf{f}^*_{i-1/2} \\right) + \\mathbf{s}(\\mathbf{q}_i)\n$$\n其中 $\\mathbf{f}^*_{i \\pm 1/2}$ 表示 $\\mathbf{f}^*(\\mathbf{q}_{i \\pm 1}, \\mathbf{q}_i)$。问题指定了局部 Lax-Friedrichs (Rusanov) 通量：\n$$\n\\mathbf{f}^*(\\mathbf{q}_L, \\mathbf{q}_R) = \\frac{1}{2}\\left(\\mathbf{f}(\\mathbf{q}_L) + \\mathbf{f}(\\mathbf{q}_R)\\right) - \\frac{1}{2}\\, \\alpha \\, (\\mathbf{q}_R - \\mathbf{q}_L)\n$$\n其稳定化参数 $\\alpha$ 必须超过最大波速，即 $\\alpha \\ge c = \\sqrt{E/\\rho}$。\n\n接下来，我们证明该格式的熵稳定性。机械能密度为 $\\eta(\\mathbf{q}) = \\frac{1}{2} \\rho v^2 + \\frac{1}{2} \\sigma^2/E$。我们可以将其写成二次型 $\\eta(\\mathbf{q}) = \\frac{1}{2} \\mathbf{q}^T H \\mathbf{q}$，其中对称化子矩阵为 $H = \\mathrm{diag}(\\rho, 1/E)$。总离散能量为 $E_h(t) = \\sum_i \\Delta x \\, \\eta(\\mathbf{q}_i)$。\n\n通量雅可比矩阵是 $A = \\nabla_\\mathbf{q} \\mathbf{f} = \\begin{bmatrix} 0  -1/\\rho \\\\ -E  0 \\end{bmatrix}$。该系统是对称双曲的，因为矩阵乘积 $HA$ 是对称的：\n$$\nHA = \\begin{bmatrix} \\rho  0 \\\\ 0  1/E \\end{bmatrix} \\begin{bmatrix} 0  -1/\\rho \\\\ -E  0 \\end{bmatrix} = \\begin{bmatrix} 0  -1 \\\\ -1  0 \\end{bmatrix}\n$$\n总离散能量的变化率通过对 $E_h(t)$ 求时间导数得到：\n$$\n\\frac{dE_h}{dt} = \\sum_i \\Delta x \\frac{d\\eta_i}{dt} = \\sum_i \\Delta x (\\nabla_\\mathbf{q} \\eta_i)^T \\frac{d\\mathbf{q}_i}{dt}\n$$\n能量的梯度是 $\\nabla_\\mathbf{q} \\eta = H\\mathbf{q}$。代入此式和半离散格式：\n$$\n\\frac{dE_h}{dt} = \\sum_i \\Delta x (H\\mathbf{q}_i)^T \\left[ - \\frac{1}{\\Delta x} \\left( \\mathbf{f}^*_{i+1/2} - \\mathbf{f}^*_{i-1/2} \\right) + \\mathbf{s}(\\mathbf{q}_i) \\right]\n$$\n$$\n\\frac{dE_h}{dt} = \\sum_i -(H\\mathbf{q}_i)^T \\left( \\mathbf{f}^*_{i+1/2} - \\mathbf{f}^*_{i-1/2} \\right) + \\sum_i \\Delta x (H\\mathbf{q}_i)^T \\mathbf{s}(\\mathbf{q}_i)\n$$\n源项的贡献是塑性耗散率：\n$$\n\\sum_i \\Delta x (H\\mathbf{q}_i)^T \\mathbf{s}(\\mathbf{q}_i) = \\sum_i \\Delta x [\\rho v_i, \\sigma_i/E]^T [0, -E \\dot{\\varepsilon}^p_i]^T = - \\sum_i \\Delta x \\, \\sigma_i \\dot{\\varepsilon}^p_i \\le 0\n$$\n通量项可以通过分部求和法进行重排。对于周期性边界，这给出：\n$$\n\\sum_i -(H\\mathbf{q}_i)^T \\left( \\mathbf{f}^*_{i+1/2} - \\mathbf{f}^*_{i-1/2} \\right) = \\sum_{i+1/2} (H\\mathbf{q}_{i+1} - H\\mathbf{q}_i)^T \\mathbf{f}^*_{i+1/2} = \\sum_{i+1/2} (\\mathbf{q}_{i+1} - \\mathbf{q}_i)^T H \\mathbf{f}^*_{i+1/2}\n$$\n这里我们利用了 $H$ 是对称的。设 $\\![ \\mathbf{q} ]\\! = \\mathbf{q}_{i+1} - \\mathbf{q}_i$。该和为 $\\sum_{i+1/2} \\![ \\mathbf{q} ]\\!^T H \\mathbf{f}^*$。代入 Rusanov 通量：\n$$\n\\![ \\mathbf{q} ]\\!^T H \\mathbf{f}^* = \\![ \\mathbf{q} ]\\!^T H \\left[ \\frac{1}{2}(\\mathbf{f}_i + \\mathbf{f}_{i+1}) - \\frac{1}{2}\\alpha \\![ \\mathbf{q} ]\\! \\right] = \\frac{1}{2} \\![ \\mathbf{q} ]\\!^T H (\\mathbf{f}_i + \\mathbf{f}_{i+1}) - \\frac{1}{2}\\alpha \\![ \\mathbf{q} ]\\!^T H \\![ \\mathbf{q} ]\\!\n$$\n由于 $\\mathbf{f}(\\mathbf{q}) = A\\mathbf{q}$ 且 $HA$ 是对称的，我们有 $\\mathbf{q}_i^T H \\mathbf{f}_{i+1} = \\mathbf{q}_i^T H A \\mathbf{q}_{i+1} = (A \\mathbf{q}_i)^T H \\mathbf{q}_{i+1} = \\mathbf{f}_i^T H \\mathbf{q}_{i+1}$。更直接地，$\\mathbf{q}_{i+1}^T H A \\mathbf{q}_i = \\mathbf{q}_i^T (HA)^T \\mathbf{q}_{i+1} = \\mathbf{q}_i^T H A \\mathbf{q}_{i+1}$。\n第一项展开为 $\\frac{1}{2}(\\mathbf{q}_{i+1}^T H\\mathbf{f}_{i+1} - \\mathbf{q}_i^T H\\mathbf{f}_i)$。对所有界面求和得到一个伸缩和，由于周期性边界，其值为零。第二项是数值耗散，$-\\frac{1}{2}\\alpha \\|\\![ \\mathbf{q} ]\\!\\|_H^2$，其中 $\\|\\mathbf{w}\\|_H^2 = \\mathbf{w}^T H \\mathbf{w}$。\n整合所有项得到半离散能量平衡：\n$$\n\\frac{dE_h}{dt} = - \\sum_{i+1/2} \\frac{1}{2}\\alpha \\|\\![ \\mathbf{q} ]\\!\\|_H^2 - \\sum_i \\Delta x \\, \\sigma_i \\dot{\\varepsilon}^p_i\n$$\n重排并注意到塑性耗散率是非负的，我们得到所期望的不等式：\n$$\n\\frac{dE_h}{dt} + \\sum_{i+1/2} \\frac{1}{2}\\alpha \\|\\![ \\mathbf{q} ]\\!\\|_H^2 = - \\sum_i \\Delta x \\, \\sigma_i \\dot{\\varepsilon}^p_i \\le 0\n$$\n这证明了该格式是熵稳定的：离散总能量 $E_h$ 只能因界面处的数值耗散和塑性产生的物理耗散而减少。\n\n时间积分采用算子分裂法进行。双曲部分使用三阶强稳定性保持龙格-库塔（SSP-RK3）方法推进，以获得试验状态 $\\mathbf{q}^{\\mathrm{tr}}$。然后，应用塑性修正步骤。对于每个试验应力 $|\\sigma_i^{\\mathrm{tr}}|$ 超过屈服应力 $\\sigma_y$ 的单元，应力被投影回屈服面：$\\sigma_i^{\\mathrm{ad}} = \\sigma_y \\, \\mathrm{sign}(\\sigma_i^{\\mathrm{tr}})$。此投影所移除的能量 $\\frac{1}{2E}((\\sigma_i^{\\mathrm{tr}})^2 - \\sigma_y^2)$，恰好等于单位体积的塑性耗散增量，该增量被累积以追踪总耗散 $D_{\\mathrm{tot}}$。", "answer": "```python\nimport numpy as np\n\ndef run_simulation(L, N, rho, E, sigma_y, initial_sigma_func, cfl, T, area=1.0):\n    \"\"\"\n    Runs a single simulation for the 1D elastodynamics problem.\n\n    Args:\n        L (float): Length of the domain in meters.\n        N (int): Number of cells.\n        rho (float): Density in kg/m^3.\n        E (float): Elastic modulus in Pa.\n        sigma_y (float): Yield stress in Pa.\n        initial_sigma_func (callable): Function to set initial stress.\n        cfl (float): CFL number for time step calculation.\n        T (float): Final time in seconds.\n        area (float): Cross-sectional area in m^2.\n\n    Returns:\n        tuple: (initial_energy, final_energy, total_plastic_dissipation).\n    \"\"\"\n    # Grid setup\n    dx = L / N\n    x = np.linspace(dx / 2.0, L - dx / 2.0, N)\n\n    # Physical and numerical parameters\n    c_wave = np.sqrt(E / rho)  # Wave speed\n    alpha = c_wave  # Rusanov flux parameter\n    \n    # Time step determined by CFL condition\n    dt = cfl * dx / alpha\n    num_steps = int(np.ceil(T / dt))\n    dt = T / num_steps # Adjust dt to hit T exactly\n\n    # State vector q = [v, sigma], shape (2, N)\n    q = np.zeros((2, N))\n    # q[0, :] is velocity v(x), initially zero\n    q[1, :] = initial_sigma_func(x, L)  # q[1, :] is stress sigma(x)\n\n    def calculate_energy(q_state):\n        v, sigma = q_state[0, :], q_state[1, :]\n        eta_density = 0.5 * rho * v**2 + 0.5 * sigma**2 / E\n        return np.sum(eta_density) * dx * area\n\n    def flux_function(q_state):\n        v, sigma = q_state[0, :], q_state[1, :]\n        f = np.zeros_like(q_state)\n        f[0, :] = -sigma / rho\n        f[1, :] = -E * v\n        return f\n\n    def rhs_hyperbolic(q_state):\n        \"\"\"Computes the spatial part of the semi-discrete scheme (hyperbolic part).\"\"\"\n        # Periodic boundary conditions are handled using np.roll\n        q_L = q_state\n        q_R = np.roll(q_state, -1, axis=1)\n        \n        f_L = flux_function(q_L)\n        f_R = flux_function(q_R)\n        \n        # Rusanov (Lax-Friedrichs) flux at interfaces i+1/2\n        f_star = 0.5 * (f_L + f_R) - 0.5 * alpha * (q_R - q_L)\n        \n        # Flux at interfaces i-1/2 by rolling\n        f_star_left = np.roll(f_star, 1, axis=1)\n        \n        # RHS = - (f*_{i+1/2} - f*_{i-1/2}) / dx\n        return -(f_star - f_star_left) / dx\n\n    e_initial = calculate_energy(q)\n    d_total = 0.0\n    \n    for _ in range(num_steps):\n        # Time integration for the hyperbolic part using SSP-RK3\n        q_n = q\n        \n        # Stage 1\n        k1 = rhs_hyperbolic(q_n)\n        q1 = q_n + dt * k1\n        \n        # Stage 2\n        k2 = rhs_hyperbolic(q1)\n        q2 = 0.75 * q_n + 0.25 * (q1 + dt * k2)\n        \n        # Stage 3\n        k3 = rhs_hyperbolic(q2)\n        q_trial = (1.0/3.0) * q_n + (2.0/3.0) * (q2 + dt * k3)\n        \n        # Plastic projection step (return mapping)\n        v_trial, sigma_trial = q_trial[0, :], q_trial[1, :]\n        \n        # Identify cells where the trial stress exceeds the yield stress\n        yield_mask = np.abs(sigma_trial) > sigma_y\n        \n        sigma_new = sigma_trial.copy()\n        \n        if np.any(yield_mask):\n            # Calculate dissipation increment per unit volume for yielding cells\n            diss_inc_density = (sigma_trial[yield_mask]**2 - sigma_y**2) / (2.0 * E)\n            \n            # Update total dissipation (integral over volume)\n            d_total += np.sum(diss_inc_density) * dx * area\n            \n            # Project stress back to the yield surface\n            sigma_new[yield_mask] = sigma_y * np.sign(sigma_trial[yield_mask])\n\n        q = np.array([v_trial, sigma_new])\n        \n    e_final = calculate_energy(q)\n    return e_initial, e_final, d_total\n\n\ndef solve():\n    \"\"\"Main function to run test cases and print results.\"\"\"\n    # Define the three test cases from the problem statement.\n    test_cases = {\n        \"case1\": {\n            \"L\": 1.0, \"N\": 200, \"rho\": 2500.0, \"E\": 1e10, \"sigma_y\": 1e18,\n            \"initial_sigma_func\": lambda x, L: 5e6 * np.sin(2 * np.pi * x / L),\n            \"cfl\": 0.5, \"T\": 2e-4\n        },\n        \"case2\": {\n            \"L\": 1.0, \"N\": 200, \"rho\": 2500.0, \"E\": 1e10, \"sigma_y\": 1e6,\n            \"initial_sigma_func\": lambda x, L: 3e6 * np.sin(2 * np.pi * x / L),\n            \"cfl\": 0.5, \"T\": 2e-4\n        },\n        \"case3\": {\n            \"L\": 1.0, \"N\": 200, \"rho\": 2500.0, \"E\": 5e10, \"sigma_y\": 1e18,\n            \"initial_sigma_func\": lambda x, L: 5e6 * np.sin(2 * np.pi * x / L),\n            \"cfl\": 0.95, \"T\": 1e-4\n        }\n    }\n\n    # Run simulations and calculate metrics\n    \n    # Test 1\n    e0_1, ef_1, _ = run_simulation(**test_cases[\"case1\"])\n    e1 = ef_1 - e0_1\n    tau1 = 1e-8 * e0_1\n    b1 = e1 = tau1\n\n    # Test 2\n    e0_2, ef_2, d_tot_2 = run_simulation(**test_cases[\"case2\"])\n    e2 = ef_2 - (e0_2 - d_tot_2)\n    tau2 = 1e-8 * max(e0_2, d_tot_2, 1.0)\n    b2 = (ef_2 = e0_2 + tau2) and (e2 = tau2)\n\n    # Test 3\n    e0_3, ef_3, _ = run_simulation(**test_cases[\"case3\"])\n    e3 = ef_3 - e0_3\n    tau3 = 1e-8 * e0_3\n    b3 = e3 = tau3\n\n    # Aggregate results into the specified order\n    final_results = [e1, e2, e3, b1, b2, b3]\n\n    # Print results in the exact required format\n    print(f\"[{','.join(map(str, final_results))}]\")\n\nsolve()\n```", "id": "3580945"}]}