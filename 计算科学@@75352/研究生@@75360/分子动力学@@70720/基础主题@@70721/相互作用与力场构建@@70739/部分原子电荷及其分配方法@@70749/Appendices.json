{"hands_on_practices": [{"introduction": "在确定原子部分电荷时，直接利用分子的对称性可以提供强有力的、源于物理现实的约束。这些约束不仅能确保电荷模型符合分子的内在结构，还能显著简化拟合问题，减少需要优化的独立参数数量。本练习 [@problem_id:3433005] 将以高度对称的苯分子为例，指导你如何系统地运用群论概念来识别等价原子，从而确定独立的电荷参数个数。", "problem": "考虑一个处于平衡构型的电中性苯分子，其化学式为 $C_{6}H_{6}$，点群对称性为 $D_{6h}$。在一个约束静电势 (RESP) 拟合程序中，通过位于原子核位置 $\\{\\mathbf{R}_{i}\\}$ 的一组原子部分电荷 $\\{q_{i}\\}$ 来模拟场点 $\\{\\mathbf{r}_{k}\\}$ 处的分子静电势。根据经典静电势的定义，由电荷产生的电势为 $V(\\mathbf{r}) = \\sum_{i} q_{i} \\, \\Phi(\\mathbf{r}-\\mathbf{R}_{i})$，其中 $\\Phi(\\mathbf{r}-\\mathbf{R}_{i})$ 是与 $|\\mathbf{r}-\\mathbf{R}_{i}|^{-1}$ 成正比的库仑核，成本函数在正则化 $\\{q_{i}\\}$ 的同时，惩罚与量子力学静电势 $V_{\\mathrm{QM}}(\\mathbf{r})$ 的偏差。\n\n令对称群 $G = D_{6h}$ 通过分子刚性运动引起的原子核置换，作用于原子指数集。对于每个 $g \\in G$，用 $\\pi_{g}$ 表示原子指数的置换，用 $P(g)$ 表示作用于电荷向量 $\\mathbf{q} \\in \\mathbb{R}^{N}$（$N = 12$）的相应置换矩阵。假设 RESP 目标函数在此群作用下是不变的，即构型、场点集以及 $V_{\\mathrm{QM}}(\\mathbf{r})$ 都是 $G$-对称的，因此存在一个最优电荷向量 $\\mathbf{q}^{\\star}$，它位于由 $G$ 固定的子空间中，即对于所有 $g \\in G$ 都有 $P(g)\\mathbf{q}^{\\star} = \\mathbf{q}^{\\star}$。该分子整体呈电中性，因此电荷满足净电荷约束 $\\sum_{i=1}^{N} q_{i} = 0$。\n\n仅使用：\n- 群在集合上的作用及导出轨道（orbit）的定义，\n- RESP 目标函数在 $G$ 下的不变性，\n- 以及电中性约束，\n\n推导苯分子的 $D_{6h}$ 对称性所蕴含的原子电荷的等式约束，并确定在施加对称性等价类和电中性约束后，独立电荷参数的数量。请给出一个整数作为最终答案，该整数等于在这些约束下独立电荷参数空间的维度。答案无需四舍五入，也无需单位。", "solution": "本题要求确定一个电中性苯分子 ($C_6H_6$) 在 $D_{6h}$ 点群对称性和整体电中性约束下，独立原子电荷参数的数量。\n\n问题的核心在于规定了最优电荷向量 $\\mathbf{q}^{\\star} \\in \\mathbb{R}^{N}$（其中 $N=12$）在对称群 $G = D_{6h}$ 的作用下是不变的。这被形式化地表述为对于所有群元素 $g \\in G$，都有 $P(g)\\mathbf{q}^{\\star} = \\mathbf{q}^{\\star}$，其中 $P(g)$ 是对应于对称操作 $g$ 对原子指数集作用的置换矩阵。\n\n这个数学条件的物理含义是，任何两个可以通过该群的某个对称操作相互映射的原子，必须被赋予相同的部分电荷。用群论的语言来说，在群 $G$ 的作用下，所有属于同一轨道的原子必须具有相同的电荷值。因此，我们的第一步是确定这些轨道。\n\n被群作用置换的对象集合 $\\mathcal{S}$ 由苯分子的 12 个原子组成。这个集合可以划分为一个包含 6 个碳原子的集合 $\\mathcal{S}_C = \\{C_1, \\dots, C_6\\}$ 和一个包含 6 个氢原子的集合 $\\mathcal{S}_H = \\{H_1, \\dots, H_6\\}$。苯的平衡构型拥有一个垂直于分子平面并穿过其中心的主 $C_6$ 旋转轴。\n\n1.  我们分析在群 $G = D_{6h}$ 作用下，集合 $\\mathcal{S}$ 中原子的轨道。一个原子 $s \\in \\mathcal{S}$ 的轨道是指， $s$ 可以通过 $G$ 中的各种对称操作映射到的所有原子的集合。\n    -   考虑任意一个碳原子，例如 $C_1$。$C_6$ 旋转操作及其各次幂（$C_6^k$，$k=1, \\dots, 5$）将 $C_1$ 映射到芳香环中的其他五个碳原子。因此，所有 6 个碳原子都通过对称性相联系，属于同一个轨道。我们将此轨道记为 $\\mathcal{O}_C = \\mathcal{S}_C$。\n    -   类似地，考虑一个氢原子，例如与 $C_1$ 成键的 $H_1$。置换碳原子的那些对称操作同样也会置换与它们成键的氢原子。$C_6$ 旋转将 $H_1$ 映射到 $H_2$，$H_2$ 映射到 $H_3$，以此类推。因此，所有 6 个氢原子也是对称等价的，并构成第二个不同的轨道。我们将此轨道记为 $\\mathcal{O}_H = \\mathcal{S}_H$。\n\n对称操作是将分子映射到其自身并保持每个原子化学特性的等距变换。碳原子永远不能被映射到氢原子上。因此，所有原子的集合 $\\mathcal{S}$ 被精确地划分为两个不相交的轨道：$\\mathcal{O}_C$ 和 $\\mathcal{O}_H$。\n\n两个轨道的存在意味着整个分子只有两种不同的电荷值。设 $q_C$ 为 6 个碳原子上各自的电荷， $q_H$ 为 6 个氢原子上各自的电荷。\n$$ q_i = q_C \\quad \\forall i \\in \\mathcal{O}_C $$\n$$ q_j = q_H \\quad \\forall j \\in \\mathcal{O}_H $$\n因此，$D_{6h}$ 对称性约束将 12 维的可能电荷向量空间简化为一个由两个参数 $q_C$ 和 $q_H$ 定义的 2 维子空间。\n\n接下来，我们应用电中性约束。题目说明该分子整体呈电中性，意味着所有原子电荷的总和必须为零。\n$$ \\sum_{k=1}^{12} q_k = 0 $$\n我们可以用我们通过对称性得到的两个参数 $q_C$ 和 $q_H$ 来表示这个约束。由于有 6 个碳原子和 6 个氢原子，该方程变为：\n$$ 6q_C + 6q_H = 0 $$\n该方程可简化为对这两个参数的单个线性约束：\n$$ q_C + q_H = 0 $$\n这个约束意味着一个参数由另一个参数决定（例如，$q_C = -q_H$）。\n\n为了求出独立参数的数量，我们从对称性所要求的参数数量开始，然后减去独立线性约束的数量。\n独立电荷参数的数量等于不同原子轨道的数量减去电荷约束的数量。对于单个中性分子，总是有这样一个约束。\n\n独立参数数量 = (轨道数) - $1$\n独立参数数量 = $2 - 1 = 1$\n\n因此，在同时施加 $D_{6h}$ 对称性要求和净电荷约束后，该系统由单个独立电荷参数描述。", "answer": "$$\\boxed{1}$$", "id": "3433005"}, {"introduction": "在确定了对称性和电中性等约束条件后，下一步是如何在数学上严格地施加这些约束。本练习 [@problem_id:3433040] 深入探讨了约束电荷拟合的核心技术——拉格朗日乘子法和卡罗需-库恩-塔克（KKT）条件。你将从第一性原理出发，推导将约束最小二乘问题转化为可解线性方程组的核心方程，并通过一个具体的数值实例，将抽象的优化理论付诸实践。", "problem": "在分子动力学 (MD) 中，部分原子电荷 $q$ 通常通过将分子周围网格上测量的静电势 (ESP) 模型拟合到原子贡献的线性叠加来确定。考虑一个加权最小二乘公式，其中电荷 $q \\in \\mathbb{R}^{n}$ 通过最小化 $ \\frac{1}{2} \\| M q - y \\|_{W}^{2}$ 来确定，其中 $M \\in \\mathbb{R}^{m \\times n}$ 将电荷映射到网格上的预测 ESP 值，$y \\in \\mathbb{R}^{m}$ 是目标 ESP 值，$W \\in \\mathbb{R}^{m \\times m}$ 是一个对称正定加权矩阵。假设电荷必须满足线性等式约束 $A q = b$，其中 $A \\in \\mathbb{R}^{p \\times n}$ 且 $b \\in \\mathbb{R}^{p}$，例如，该约束编码了分子总电荷等于一个指定值以及某些原子是对称等价的。\n\n1. 从加权最小二乘法的基本定义和拉格朗日乘子法出发，推导该约束问题的拉格朗日函数和 Karush–Kuhn–Tucker (KKT) 最优性条件。您的推导应从目标函数 $\\frac{1}{2}(M q - y)^{\\top} W (M q - y)$ 和约束条件 $A q = b$ 开始，并逐步导出驻点条件和可行性条件，而不引用任何预先给定的“快捷”公式。\n\n2. 证明 KKT 条件可以写成一个单一的分块线性系统。然后，对于以下代表一个简化为其正规方程组的 ESP 拟合的具体实例，其中预先计算的正规矩阵 $H = M^{\\top} W M$ 和向量 $f = M^{\\top} W y$ 为\n$$\nH = \\begin{pmatrix}\n4  0  0  0 \\\\\n0  6  0  0 \\\\\n0  0  5  0 \\\\\n0  0  0  3\n\\end{pmatrix}, \\quad\nf = \\begin{pmatrix}\n2 \\\\\n3 \\\\\n1 \\\\\n0\n\\end{pmatrix},\n$$\n以及编码对称性和总电荷的等式约束为\n$$\nA = \\begin{pmatrix}\n1  -1  0  0 \\\\\n1  \\phantom{-}1  1  1\n\\end{pmatrix}, \\quad\nb = \\begin{pmatrix}\n0 \\\\\n1\n\\end{pmatrix},\n$$\n求解最优电荷 $q \\in \\mathbb{R}^{4}$ 和与约束相关的拉格朗日乘子 $\\lambda \\in \\mathbb{R}^{2}$。\n\n3. 从线性代数和优化的第一性原理出发，解释正规矩阵 $H$ 的数值条件以及与约束相关的舒尔补如何影响计算出的电荷和乘子的稳定性和准确性。在您的解释中，阐述 $M$ 的列之间的近线性相关或 $W$ 中的不良缩放如何影响条件数，这种影响如何在 KKT 系统中传播，以及有哪些基于原理的补救措施可用。\n\n以基本电荷 $e$ 为单位表示部分原子电荷；仅报告数值，不带单位。对于此实例，不要进行四舍五入；以精确有理数形式报告您的最终数值答案。使用精确分数，在单行中提供六个值 $(q_1, q_2, q_3, q_4, \\lambda_1, \\lambda_2)$。", "solution": "该问题要求完成三项任务：1. 推导约束加权最小二乘问题的 Karush–Kuhn–Tucker (KKT) 条件。2. 求解该问题的一个具体实例。3. 讨论该问题的数值条件。\n\n### 第 1 部分：拉格朗日函数和 KKT 条件的推导\n\n问题是找到部分原子电荷向量 $q \\in \\mathbb{R}^{n}$，它在满足线性等式约束 $A q = b$ 的条件下，最小化加权最小二乘目标函数\n$$ J(q) = \\frac{1}{2} \\| M q - y \\|_{W}^{2} $$\n\n加权范数的平方定义为 $\\|v\\|_{W}^{2} = v^{\\top} W v$。因此，目标函数可以写成：\n$$ J(q) = \\frac{1}{2} (M q - y)^{\\top} W (M q - y) $$\n我们展开这个表达式：\n$$ J(q) = \\frac{1}{2} (q^{\\top} M^{\\top} - y^{\\top}) W (M q - y) $$\n$$ J(q) = \\frac{1}{2} (q^{\\top} M^{\\top} W M q - q^{\\top} M^{\\top} W y - y^{\\top} W M q + y^{\\top} W y) $$\n由于 $y^{\\top} W M q$ 是一个标量，它等于其转置 $(y^{\\top} W M q)^{\\top} = q^{\\top} M^{\\top} W^{\\top} y$。鉴于加权矩阵 $W$ 是对称的（$W^{\\top} = W$），此项变为 $q^{\\top} M^{\\top} W y$。两个交叉项是相同的。\n$$ J(q) = \\frac{1}{2} q^{\\top} (M^{\\top} W M) q - q^{\\top} (M^{\\top} W y) + \\frac{1}{2} y^{\\top} W y $$\n项 $\\frac{1}{2} y^{\\top} W y$ 是一个关于 $q$ 的常数，不影响最小值的位置。\n\n这是一个约束优化问题。我们使用拉格朗日乘子法。约束条件是 $A q - b = 0$。我们引入一个拉格朗日乘子向量 $\\lambda \\in \\mathbb{R}^{p}$ 并构造拉格朗日函数 $\\mathcal{L}(q, \\lambda)$：\n$$ \\mathcal{L}(q, \\lambda) = J(q) + \\lambda^{\\top} (A q - b) $$\n$$ \\mathcal{L}(q, \\lambda) = \\frac{1}{2} q^{\\top} (M^{\\top} W M) q - q^{\\top} (M^{\\top} W y) + \\frac{1}{2} y^{\\top} W y + \\lambda^{\\top} (A q - b) $$\n\n最优性的 Karush–Kuhn–Tucker (KKT) 条件是通过将拉格朗日函数对主变量 $q$ 和对偶变量 $\\lambda$ 的梯度设置为零来找到的。\n\n1.  **驻点条件**：关于 $q$ 的梯度必须为零：$\\nabla_{q} \\mathcal{L}(q, \\lambda) = 0$。\n    我们使用标准的矩阵微积分恒等式 $\\nabla_{x} (x^{\\top} B x) = (B+B^{\\top})x$（如果 $B$ 是对称的，则为 $2Bx$）和 $\\nabla_{x} (c^{\\top} x) = c$。\n    令 $H = M^{\\top} W M$ 和 $f = M^{\\top} W y$。由于 $W$ 是对称的，矩阵 $H$ 也是对称的。\n    $$ \\nabla_{q} \\mathcal{L}(q, \\lambda) = \\nabla_{q} \\left( \\frac{1}{2} q^{\\top} H q - q^{\\top} f + \\lambda^{\\top} A q - \\lambda^{\\top} b \\right) $$\n    $$ \\nabla_{q} \\mathcal{L}(q, \\lambda) = H q - f + A^{\\top} \\lambda $$\n    将此设置为零得到驻点条件：\n    $$ H q + A^{\\top} \\lambda = f $$\n    或者，用原始矩阵表示：\n    $$ (M^{\\top} W M) q + A^{\\top} \\lambda = M^{\\top} W y $$\n\n2.  **原始可行性条件**：关于 $\\lambda$ 的梯度必须为零：$\\nabla_{\\lambda} \\mathcal{L}(q, \\lambda) = 0$。\n    $$ \\nabla_{\\lambda} \\mathcal{L}(q, \\lambda) = \\nabla_{\\lambda} \\left( \\dots + \\lambda^{\\top} (A q - b) \\right) = A q - b $$\n    将此设置为零可恢复原始约束：\n    $$ A q = b $$\n\n因此，此问题的 KKT 条件是由驻点条件和原始可行性条件组成的线性方程组：\n1.  $(M^{\\top} W M) q + A^{\\top} \\lambda = M^{\\top} W y$\n2.  $A q = b$\n\n### 第 2 部分：具体实例的求解\n\n上面推导的 KKT 条件构成了关于变量 $q$ 和 $\\lambda$ 的一个线性方程组。使用 $H = M^{\\top} W M$ 和 $f = M^{\\top} W y$，这些条件是：\n$$ Hq + A^{\\top} \\lambda = f $$\n$$ Aq = b $$\n这些可以写成一个单一的分块线性系统：\n$$\n\\begin{pmatrix}\nH  A^{\\top} \\\\\nA  0\n\\end{pmatrix}\n\\begin{pmatrix}\nq \\\\\n\\lambda\n\\end{pmatrix}\n=\n\\begin{pmatrix}\nf \\\\\nb\n\\end{pmatrix}\n$$\n这就是 KKT 系统。对于给定的实例，我们有 $n=4$ 个电荷和 $p=2$ 个约束。\n给定的矩阵是：\n$$\nH = \\begin{pmatrix}\n4  0  0  0 \\\\\n0  6  0  0 \\\\\n0  0  5  0 \\\\\n0  0  0  3\n\\end{pmatrix}, \\quad\nf = \\begin{pmatrix}\n2 \\\\\n3 \\\\\n1 \\\\\n0\n\\end{pmatrix}, \\quad\nA = \\begin{pmatrix}\n1  -1  0  0 \\\\\n1  \\phantom{-}1  1  1\n\\end{pmatrix}, \\quad\nb = \\begin{pmatrix}\n0 \\\\\n1\n\\end{pmatrix}\n$$\n$A$ 的转置是 $A^{\\top} = \\begin{pmatrix} 1  1 \\\\ -1  1 \\\\ 0  1 \\\\ 0  1 \\end{pmatrix}$。\n该分块系统变成一个 $6 \\times 6$ 的方程组：\n$$\n\\begin{pmatrix}\n4  0  0  0  1  1 \\\\\n0  6  0  0  -1  1 \\\\\n0  0  5  0  0  1 \\\\\n0  0  0  3  0  1 \\\\\n1  -1  0  0  0  0 \\\\\n1  1  1  1  0  0\n\\end{pmatrix}\n\\begin{pmatrix} q_1 \\\\ q_2 \\\\ q_3 \\\\ q_4 \\\\ \\lambda_1 \\\\ \\lambda_2 \\end{pmatrix}\n=\n\\begin{pmatrix} 2 \\\\ 3 \\\\ 1 \\\\ 0 \\\\ 0 \\\\ 1 \\end{pmatrix}\n$$\n我们可以将其写成六个线性方程：\n(1) $4q_1 + \\lambda_1 + \\lambda_2 = 2$\n(2) $6q_2 - \\lambda_1 + \\lambda_2 = 3$\n(3) $5q_3 + \\lambda_2 = 1$\n(4) $3q_4 + \\lambda_2 = 0$\n(5) $q_1 - q_2 = 0$\n(6) $q_1 + q_2 + q_3 + q_4 = 1$\n\n从(5)式，我们有 $q_1 = q_2$。\n从(3)式，$q_3 = \\frac{1 - \\lambda_2}{5}$。\n从(4)式，$q_4 = \\frac{-\\lambda_2}{3}$。\n将 $q_1 = q_2$ 代入 (1) 和 (2)：\n(1') $4q_1 + \\lambda_1 + \\lambda_2 = 2$\n(2') $6q_1 - \\lambda_1 + \\lambda_2 = 3$\n将 (1') 和 (2') 相加：$10q_1 + 2\\lambda_2 = 5 \\implies 5q_1 + \\lambda_2 = \\frac{5}{2}$。由此，$\\lambda_2 = \\frac{5}{2} - 5q_1$。\n将 (1') 从 (2') 中减去：$2q_1 - 2\\lambda_1 = 1 \\implies \\lambda_1 = q_1 - \\frac{1}{2}$。\n\n现在我们用 $q_1$ 来表示 $q_3$ 和 $q_4$：\n$q_3 = \\frac{1 - (\\frac{5}{2} - 5q_1)}{5} = \\frac{-\\frac{3}{2} + 5q_1}{5} = q_1 - \\frac{3}{10}$。\n$q_4 = \\frac{-(\\frac{5}{2} - 5q_1)}{3} = \\frac{5q_1 - \\frac{5}{2}}{3}$。\n\n现在将所有变量代入最后一个约束方程 (6)，注意 $q_2=q_1$：\n$q_1 + q_1 + \\left(q_1 - \\frac{3}{10}\\right) + \\frac{5q_1 - \\frac{5}{2}}{3} = 1$\n$3q_1 - \\frac{3}{10} + \\frac{5q_1}{3} - \\frac{5}{6} = 1$\n为了合并各项，我们找到公分母 30：\n$3q_1(30/30) - 3/10(3/3) + 5q_1/3(10/10) - 5/6(5/5) = 1(30/30)$\n$\\frac{90q_1 - 9 + 50q_1 - 25}{30} = \\frac{30}{30}$\n$140q_1 - 34 = 30$\n$140q_1 = 64$\n$q_1 = \\frac{64}{140} = \\frac{16}{35}$。\n\n现在我们求解其他变量：\n$q_2 = q_1 = \\frac{16}{35}$\n$\\lambda_2 = \\frac{5}{2} - 5q_1 = \\frac{5}{2} - 5\\left(\\frac{16}{35}\\right) = \\frac{5}{2} - \\frac{16}{7} = \\frac{35 - 32}{14} = \\frac{3}{14}$\n$\\lambda_1 = q_1 - \\frac{1}{2} = \\frac{16}{35} - \\frac{1}{2} = \\frac{32 - 35}{70} = -\\frac{3}{70}$\n$q_3 = q_1 - \\frac{3}{10} = \\frac{16}{35} - \\frac{3}{10} = \\frac{32 - 21}{70} = \\frac{11}{70}$\n$q_4 = \\frac{-\\lambda_2}{3} = \\frac{-(3/14)}{3} = -\\frac{1}{14}$\n\n解是 $(q_1, q_2, q_3, q_4, \\lambda_1, \\lambda_2) = \\left(\\frac{16}{35}, \\frac{16}{35}, \\frac{11}{70}, -\\frac{1}{14}, -\\frac{3}{70}, \\frac{3}{14}\\right)$。\n\n### 第 3 部分：数值条件的解释\n\n计算出的电荷 $q$ 和乘子 $\\lambda$ 的稳定性和准确性由必须求解的线性系统的数值条件决定。\n\n1.  **正规矩阵 H 的条件**：正规矩阵是 $H = M^{\\top} W M$。其条件数 $\\kappa(H) = \\|H\\|\\|H^{-1}\\|$ 是一个主要因素。\n    - **M 的影响**：矩阵 $M$ 将原子电荷映射到网格上的 ESP。如果 $M$ 的列是近线性相关的，这意味着两个或多个原子产生的 ESP 分布非常相似。这使得很难区分它们对总 ESP 的各自贡献，从而导致一个近奇异（病态）的 $H$。这对于空间上接近或深埋在分子内部的原子来说是一个常见问题。在近线性相关的极限情况下，$M$ 将是秩亏的，$H$ 将是奇异且不可逆的，这意味着没有约束的情况下问题没有唯一解。$H$ 的条件数大约是 $M$ (或 $\\sqrt{W}M$) 的条件数的平方，即 $\\kappa(H) \\approx \\kappa(M)^{2}$。这种平方效应意味着即使是中度病态的映射矩阵 $M$ 也可能导致严重病态的正规矩阵 $H$。\n    - **W 的影响**：加权矩阵 $W$ 考虑了不同网格点上 ESP 值重要性或不确定性的变化。如果 $W$ 的元素值相差多个数量级（不良缩放），它会以一种显著增加 $H$ 条件数的方式拉伸问题空间，即使 $M$ 本身是良态的。\n\n2.  **在 KKT 系统中的传播**：解是从 KKT 系统 $\\begin{pmatrix} H  A^{\\top} \\\\ A  0 \\end{pmatrix} \\begin{pmatrix} q \\\\ \\lambda \\end{pmatrix} = \\begin{pmatrix} f \\\\ b \\end{pmatrix}$ 中获得的。$H$ 的病态性直接影响该系统的稳定性。通过舒尔补方法形式上求解该系统可以说明这一点。首先从 $(A H^{-1} A^{\\top}) \\lambda = A H^{-1} f - b$ 求解 $\\lambda$，然后通过 $q = H^{-1}(f - A^{\\top}\\lambda)$ 求出 $q$。\n    - 矩阵 $S = A H^{-1} A^{\\top}$ 是 KKT 矩阵中 $H$ 的舒尔补。计算 $\\lambda$ 的稳定性取决于 $\\kappa(S)$。如果 $H$ 是病态的，$H^{-1}$ 会有很大的数值误差，这些误差会传播到 $S$、$A H^{-1} f$ 的计算中，从而影响到 $\\lambda$。\n    - $q$ 的计算直接涉及到 $H^{-1}$。因此，在求 $H$ 的逆或用其求解方程组时的任何数值不稳定性都会直接影响计算出的电荷 $q$ 的准确性。输入数据（影响 $f$ 的 $y$）中的小扰动可能被一个与 $\\kappa(H)$ 成正比的因子放大，导致 $q$ 的解出现巨大变化。\n\n3.  **基于原理的补救措施**：\n    - **正则化**：一种广泛使用的技术是 Tikhonov 正则化（或岭回归）。在目标函数中加入一个惩罚项，通常是 $\\frac{1}{2}\\alpha \\|q\\|^2$（其中 $\\alpha > 0$ 是一个小数）。这将驻点条件变为 $(H + \\alpha I)q + A^{\\top}\\lambda = f$。矩阵 $(H + \\alpha I)$ 保证比 $H$ 的条件更好，因为加上 $\\alpha I$ 会将 $H$ 的所有特征值增加 $\\alpha$，使最小的特征值远离零。这通过引入一个偏向于较小量值电荷的偏置来稳定解。\n    - **对增广系统使用直接法**：可以完全不构造正规矩阵 $H$，而是对原始“高瘦”矩阵 $M$ 的增广版本使用像 QR 或 SVD 分解这样的方法。这避免了构造 $H = M^{\\top}W M$ 时带来的条件数平方问题，并且通常在数值上更稳定。对于约束问题，可以使用像广义 QR 分解这样的专门方法。\n    - **预处理**：对于迭代求解器，可以使用一个预处理器矩阵 $P$ 将 KKT 系统转换为一个条件更好的系统。目标是找到一个能够近似 KKT 矩阵的 $P$，并且对于该 $P$，系统 $Pz=r$ 容易求解。为 KKT 系统设计有效的预处理器是数值线性代数的一个主要领域。\n    - **加强约束**：如果病态性源于物理上的模糊性（例如，近等价原子），增加更多约束（例如，强制对称等价原子的电荷相等）可以移除自由度并正则化问题。这本质上就是本问题中约束矩阵 $A$ 所起的部分作用。", "answer": "$$ \\boxed{ \\begin{pmatrix} \\frac{16}{35}  \\frac{16}{35}  \\frac{11}{70}  -\\frac{1}{14}  -\\frac{3}{70}  \\frac{3}{14} \\end{pmatrix} } $$", "id": "3433040"}, {"introduction": "仅仅施加约束有时并不足以解决电荷拟合中的所有问题，特别是对于分子内部的原子，其对外部静电势的贡献可能难以区分，导致拟合问题是“不适定的”（ill-posed）。本练习 [@problem_id:3433001] 探究了此问题的关键解决方案——正则化，这也是RESP等方法的核心思想。你将推导正则化项如何修正拟合方程，并分析其引入的基本统计学原理——偏差-方差权衡，从而深刻理解为何稳健的电荷模型并不仅仅是完美地拟合数据。", "problem": "考虑一个分子动力学工作流，其中部分原子电荷是通过将一个分子的静电势拟合到一个线性模型来确定的。该静电势是在 $M$ 个格点上通过电子结构计算得出的。设势向量为 $y \\in \\mathbb{R}^{M}$，对于 $n$ 个原子，未知电荷为 $q \\in \\mathbb{R}^{n}$，设计矩阵为 $X \\in \\mathbb{R}^{M \\times n}$，其中元素 $(i,j)$ $X_{ij}$ 表示在固定几何构型下，原子 $j$ 对格点 $i$ 处电势的库仑贡献。假设数据由线性模型 $y = X q + \\varepsilon$ 生成，其中噪声 $\\varepsilon \\in \\mathbb{R}^{M}$ 的均值为零，协方差为 $\\sigma^{2} I_{M}$，且 $\\sigma^{2} > 0$。普通最小二乘估计器通过最小化残差平方范数来求解正规方程，而 Tikhonov 正则化和约束静电势 (RESP) 方法则对电荷引入二次约束以稳定拟合。在本问题中，考虑一个以零为中心的二次 RESP/Tikhonov 惩罚项，得到目标函数 $L(q) = \\|X q - y\\|_{2}^{2} + \\lambda \\|q\\|_{2}^{2}$，其中 $\\lambda \\geq 0$。\n\n从最小二乘和二次正则化的定义出发，并假设上述噪声模型，执行以下操作：\n\n1. 推导 $L(q)$ 最小化子的平稳性条件，并证明修正后的正规方程为 $(X^{\\top} X + \\lambda I_{n}) q = X^{\\top} y$。\n\n2. 令 $\\widehat{q}_{\\lambda} = (X^{\\top} X + \\lambda I_{n})^{-1} X^{\\top} y$ 表示正则化估计器。对于一个固定的真实电荷向量 $q$，在所述噪声模型下，推导其偏置向量 $\\mathrm{bias}(\\widehat{q}_{\\lambda} \\mid q) = \\mathbb{E}[\\widehat{q}_{\\lambda} \\mid q] - q$ 和协方差矩阵 $\\mathrm{Cov}(\\widehat{q}_{\\lambda} \\mid q)$，并定性解释增大 $\\lambda$ 如何影响偏置和方差。\n\n3. 进一步假设真实电荷是随机的，服从各向同性的高斯先验分布 $q \\sim \\mathcal{N}(0, \\tau^{2} I_{n})$，其中 $\\tau^{2} > 0$，且与 $\\varepsilon$ 无关。使用此分层模型，推导期望均方误差 $\\mathbb{E}\\big[\\|\\widehat{q}_{\\lambda} - q\\|_{2}^{2}\\big]$ 作为 $\\lambda$ 的函数，并解析地确定使该期望误差最小化的 $\\lambda$ 值。\n\n以 $\\sigma^{2}$ 和 $\\tau^{2}$ 的单个闭式解析表达式形式，给出最优正则化参数 $\\lambda$ 的最终结果。不要计算任何数值，最终答案中也不要包含单位。", "solution": "线性模型为 $y = X q + \\varepsilon$，其中 $\\varepsilon$ 的均值为零，协方差为 $\\sigma^{2} I_{M}$。正则化目标函数为 $L(q) = \\|X q - y\\|_{2}^{2} + \\lambda \\|q\\|_{2}^{2}$。\n\n对于第 1 项，我们推导平稳性条件。将 $L(q)$ 展开为 $L(q) = (X q - y)^{\\top} (X q - y) + \\lambda q^{\\top} q$。其关于 $q$ 的梯度为\n$$\n\\nabla_{q} L(q) = 2 X^{\\top} (X q - y) + 2 \\lambda q.\n$$\n令 $\\nabla_{q} L(q) = 0$ 可得\n$$\nX^{\\top} (X q - y) + \\lambda q = 0 \\quad \\Rightarrow \\quad X^{\\top} X q - X^{\\top} y + \\lambda q = 0,\n$$\n可以重新整理为\n$$\n(X^{\\top} X + \\lambda I_{n}) q = X^{\\top} y.\n$$\n这就是由二次 RESP/Tikhonov 正则化导出的修正正规方程。\n\n对于第 2 项，定义 $A = X^{\\top} X$ 和 $H_{\\lambda} = (A + \\lambda I_{n})^{-1}$。正则化估计器为\n$$\n\\widehat{q}_{\\lambda} = H_{\\lambda} X^{\\top} y = H_{\\lambda} X^{\\top} (X q + \\varepsilon) = H_{\\lambda} A q + H_{\\lambda} X^{\\top} \\varepsilon.\n$$\n在给定 $q$ 的条件下，对 $\\varepsilon$ 求条件期望，\n$$\n\\mathbb{E}[\\widehat{q}_{\\lambda} \\mid q] = H_{\\lambda} A q + H_{\\lambda} X^{\\top} \\mathbb{E}[\\varepsilon] = H_{\\lambda} A q.\n$$\n因此，偏置向量为\n$$\n\\mathrm{bias}(\\widehat{q}_{\\lambda} \\mid q) = \\mathbb{E}[\\widehat{q}_{\\lambda} \\mid q] - q = (H_{\\lambda} A - I_{n}) q.\n$$\n使用恒等式 $H_{\\lambda} A = (A + \\lambda I_{n})^{-1} A = I_{n} - \\lambda (A + \\lambda I_{n})^{-1}$，我们有\n$$\n\\mathrm{bias}(\\widehat{q}_{\\lambda} \\mid q) = - \\lambda (A + \\lambda I_{n})^{-1} q,\n$$\n因此偏置的大小随 $\\lambda$ 增大而增大。接下来，计算协方差。由于 $\\varepsilon$ 的协方差为 $\\sigma^{2} I_{M}$ 且均值为零，\n$$\n\\mathrm{Cov}(\\widehat{q}_{\\lambda} \\mid q) = \\mathrm{Cov}(H_{\\lambda} X^{\\top} \\varepsilon) = H_{\\lambda} X^{\\top} \\mathrm{Cov}(\\varepsilon) X H_{\\lambda}^{\\top} = \\sigma^{2} H_{\\lambda} A H_{\\lambda}^{\\top}.\n$$\n因为当 $A$ 是对称半正定矩阵时，$A$ 和 $H_{\\lambda}$ 都是对称的，所以这可以简化为\n$$\n\\mathrm{Cov}(\\widehat{q}_{\\lambda} \\mid q) = \\sigma^{2} (A + \\lambda I_{n})^{-1} A (A + \\lambda I_{n})^{-1}.\n$$\n随着 $\\lambda$ 的增加，$(A + \\lambda I_{n})^{-1}$ 的大小减小，因此协方差减小，这说明了偏置-方差权衡：较大的 $\\lambda$ 会增加偏置但减小方差。\n\n对于第 3 项，假设 $q \\sim \\mathcal{N}(0, \\tau^{2} I_{n})$ 且与 $\\varepsilon$ 无关。误差为\n$$\n\\widehat{q}_{\\lambda} - q = (H_{\\lambda} A - I_{n}) q + H_{\\lambda} X^{\\top} \\varepsilon.\n$$\n由于 $q$ 和 $\\varepsilon$ 相互独立且均值为零，期望均方误差是这两项的期望平方范数之和：\n$$\n\\mathbb{E}\\big[\\|\\widehat{q}_{\\lambda} - q\\|_{2}^{2}\\big] = \\mathbb{E}\\big[\\|(H_{\\lambda} A - I_{n}) q\\|_{2}^{2}\\big] + \\mathbb{E}\\big[\\|H_{\\lambda} X^{\\top} \\varepsilon\\|_{2}^{2}\\big].\n$$\n对于第一项，因为 $q$ 的协方差为 $\\tau^{2} I_{n}$，\n$$\n\\mathbb{E}\\big[\\|(H_{\\lambda} A - I_{n}) q\\|_{2}^{2}\\big] = \\tau^{2} \\,\\mathrm{tr}\\!\\left((H_{\\lambda} A - I_{n})^{\\top} (H_{\\lambda} A - I_{n})\\right).\n$$\n使用 $H_{\\lambda} A - I_{n} = - \\lambda (A + \\lambda I_{n})^{-1}$，\n$$\n\\mathbb{E}\\big[\\|(H_{\\lambda} A - I_{n}) q\\|_{2}^{2}\\big] = \\tau^{2} \\lambda^{2} \\,\\mathrm{tr}\\!\\left((A + \\lambda I_{n})^{-2}\\right).\n$$\n对于第二项，由于 $\\varepsilon$ 的协方差为 $\\sigma^{2} I_{M}$，\n$$\n\\mathbb{E}\\big[\\|H_{\\lambda} X^{\\top} \\varepsilon\\|_{2}^{2}\\big] = \\mathrm{tr}\\!\\left(\\mathrm{Cov}(H_{\\lambda} X^{\\top} \\varepsilon)\\right) = \\sigma^{2} \\,\\mathrm{tr}\\!\\left(H_{\\lambda} A H_{\\lambda}\\right) = \\sigma^{2} \\,\\mathrm{tr}\\!\\left((A + \\lambda I_{n})^{-1} A (A + \\lambda I_{n})^{-1}\\right).\n$$\n结合起来，期望均方误差为\n$$\n\\mathbb{E}\\big[\\|\\widehat{q}_{\\lambda} - q\\|_{2}^{2}\\big] = \\tau^{2} \\lambda^{2} \\,\\mathrm{tr}\\!\\left((A + \\lambda I_{n})^{-2}\\right) + \\sigma^{2} \\,\\mathrm{tr}\\!\\left((A + \\lambda I_{n})^{-1} A (A + \\lambda I_{n})^{-1}\\right).\n$$\n设 $A$ 的特征值分解为 $A = U \\,\\mathrm{diag}(s_{1}, \\dots, s_{n}) U^{\\top}$，其中 $s_{i} \\geq 0$ 且 $U$ 是正交矩阵。因为迹在正交相似变换下是不变的，所以迹可以简化为特征值的和：\n$$\n\\mathbb{E}\\big[\\|\\widehat{q}_{\\lambda} - q\\|_{2}^{2}\\big] = \\sum_{i=1}^{n} \\left( \\frac{\\tau^{2} \\lambda^{2}}{(s_{i} + \\lambda)^{2}} + \\frac{\\sigma^{2} s_{i}}{(s_{i} + \\lambda)^{2}} \\right) = \\sum_{i=1}^{n} \\frac{\\tau^{2} \\lambda^{2} + \\sigma^{2} s_{i}}{(s_{i} + \\lambda)^{2}}.\n$$\n为求最优 $\\lambda$，对 $\\lambda$ 求导：\n$$\n\\frac{\\mathrm{d}}{\\mathrm{d}\\lambda} \\left( \\frac{\\tau^{2} \\lambda^{2} + \\sigma^{2} s_{i}}{(s_{i} + \\lambda)^{2}} \\right) = \\frac{2 s_{i} \\left(\\tau^{2} \\lambda - \\sigma^{2}\\right)}{(s_{i} + \\lambda)^{3}}.\n$$\n对 $i$ 求和，\n$$\n\\frac{\\mathrm{d}}{\\mathrm{d}\\lambda} \\,\\mathbb{E}\\big[\\|\\widehat{q}_{\\lambda} - q\\|_{2}^{2}\\big] = \\sum_{i=1}^{n} \\frac{2 s_{i} \\left(\\tau^{2} \\lambda - \\sigma^{2}\\right)}{(s_{i} + \\lambda)^{3}} = \\left(\\tau^{2} \\lambda - \\sigma^{2}\\right) \\sum_{i=1}^{n} \\frac{2 s_{i}}{(s_{i} + \\lambda)^{3}}.\n$$\n对于 $\\lambda \\geq 0$ 和 $s_{i} \\geq 0$，该和是非负的，并且除非所有 $s_{i}=0$，否则该和是严格为正的。因此，使期望均方误差最小化的唯一驻点满足\n$$\n\\tau^{2} \\lambda - \\sigma^{2} = 0 \\quad \\Rightarrow \\quad \\lambda^{\\star} = \\frac{\\sigma^{2}}{\\tau^{2}}.\n$$\n该值平衡了由约束引起的偏置和由测量噪声引起的方差，并且它不依赖于 $X^{\\top} X$ 的具体谱。\n\n因此，在所述假设下，最优正则化参数为 $\\lambda^{\\star} = \\sigma^{2} / \\tau^{2}$。", "answer": "$$\\boxed{\\frac{\\sigma^{2}}{\\tau^{2}}}$$", "id": "3433001"}]}