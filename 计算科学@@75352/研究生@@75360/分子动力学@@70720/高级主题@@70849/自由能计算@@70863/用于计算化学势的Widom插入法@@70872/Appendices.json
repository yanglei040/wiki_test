{"hands_on_practices": [{"introduction": "在实际的分子模拟中，为了节省计算成本，通常会在一个截断半径 $r_c$ 处截断分子间相互作用势。然而，这种做法会引入系统性误差。本练习 [@problem_id:3461858] 将指导你完成计算物理学中的一个基本步骤：推导过剩化学势的解析“尾部校正”。通过运用Widom插入法的原理和一个常见的平均场近似，你将学会如何弥补被忽略的长程相互作用的贡献，从而确保你的模拟结果能准确反映完整势函数下的物理性质。", "problem": "一种由球形粒子组成的单组分流体，粒子间通过标准的 $12$–$6$ Lennard-Jones 对势 $u_{\\mathrm{LJ}}(r) = 4 \\epsilon \\left[ \\left( \\frac{\\sigma}{r} \\right)^{12} - \\left( \\frac{\\sigma}{r} \\right)^{6} \\right]$ 相互作用。在数密度为 $\\rho$、温度为 $T$ 的正则系综分子模拟中，超额化学势 $\\mu^{\\mathrm{ex}}$ 使用 Widom 插入法进行估算，但对势在截断半径 $r_c$ 处被截断（而非移位），因此 $u_{\\mathrm{trunc}}(r) = u_{\\mathrm{LJ}}(r)$ (当 $r  r_c$ 时) 且 $u_{\\mathrm{trunc}}(r) = 0$ (当 $r \\ge r_c$ 时)。为了恢复全势能的结果，必须添加一个尾部校正，以考虑被忽略的超出 $r_c$ 的相互作用。\n\n从正则系综中超额化学势的 Widom 插入法估计量的定义出发，仅使用基本的统计力学恒等式和 Lennard-Jones 势的定义，在以下假设下推导必须添加到截断结果中的超额化学势尾部校正的解析表达式：\n- 对于间距 $r > r_c$，径向分布函数 $g(r)$ 近似为 $g(r) \\approx 1$。\n- 对 Widom 玻尔兹曼因子被忽略的长程贡献，在领头阶上通过对势能在被忽略的空间区域（$r>r_c$）上积分来处理。\n\n您必须：\n- 从 $\\mu^{\\mathrm{ex}}$ 的 Widom 插入法定义的第一性原理出发，并证明导致在被忽略区域 $r > r_c$ 上进行平均场积分的近似方法的合理性。\n- 对 $12$–$6$ Lennard-Jones 形式显式地计算得到的空间积分。\n- 将最终结果表示为以 $\\rho$、$\\sigma$ 和 $r_c$ 表示的约化尾部校正 $\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}}/\\epsilon$ 的单一闭合形式符号表达式。\n\n以单一解析表达式给出最终答案。不要代入数值。最终表达式中不应包含单位；以约化形式 $\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}}/\\epsilon$ 报告结果。", "solution": "该问题要求推导在使用截断对势的模拟中，Lennard-Jones 流体超额化学势的尾部校正 $\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}}$ 的解析表达式。推导必须从 Widom 插入法开始，并采用指定的近似。\n\n### 第 1 步：问题验证\n问题陈述已经过验证，被认为是科学上合理的、适定的、客观的且内部一致的。它提出了一个统计力学和分子模拟理论中标准的、不平凡的问题。所给定的条件和假设对于进行严格推导是充分且适当的。因此，该问题被视为有效，并将提供解答。\n\n### 第 2 步：从第一性原理推导\n\n**1. 超额化学势的 Widom 插入法**\n\n超额化学势 $\\mu^{\\mathrm{ex}}$ 代表由粒子间相互作用引起的化学势贡献。在正则 ($NVT$) 系综中，它通过 Widom 测试粒子插入法定义。基本公式为：\n$$\n\\mu^{\\mathrm{ex}} = -k_B T \\ln \\left\\langle \\exp(-\\beta \\Delta U) \\right\\rangle_N\n$$\n此处，$k_B$ 是玻尔兹曼常数，$T$ 是绝对温度，且 $\\beta = 1/(k_B T)$。项 $\\Delta U$ 表示在一个包含 $N$ 个粒子的系统中，于随机位置 $\\mathbf{r}_0$ 插入一个“测试”粒子所产生的总势能。该能量是测试粒子与 $N$ 个现有粒子之间对相互作用的总和：\n$$\n\\Delta U = \\sum_{i=1}^N u(|\\mathbf{r}_i - \\mathbf{r}_0|)\n$$\n尖括号 $\\langle \\dots \\rangle_N$ 表示对 $N$ 粒子系统构型的系综平均。\n\n**2. 全势与截断势**\n\n该问题涉及两种形式的势能：\n- 全 Lennard-Jones 势：对于所有 $r$，有 $u_{\\mathrm{full}}(r) = u_{\\mathrm{LJ}}(r) = 4 \\epsilon \\left[ \\left( \\frac{\\sigma}{r} \\right)^{12} - \\left( \\frac{\\sigma}{r} \\right)^{6} \\right]$。\n- 模拟中使用的截断势：当 $r  r_c$ 时 $u_{\\mathrm{trunc}}(r) = u_{\\mathrm{LJ}}(r)$，当 $r \\ge r_c$ 时 $u_{\\mathrm{trunc}}(r) = 0$。\n\n在模拟中测得的超额化学势，它同时使用截断势来生成构型和测量测试粒子能量，其表达式为：\n$$\n\\mu^{\\mathrm{ex}}_{\\mathrm{trunc}} = -k_B T \\ln \\left\\langle \\exp(-\\beta \\Delta U_{\\mathrm{trunc}}) \\right\\rangle_{\\mathrm{trunc}}\n$$\n其中 $\\Delta U_{\\mathrm{trunc}} = \\sum_{i=1}^N u_{\\mathrm{trunc}}(|\\mathbf{r}_i - \\mathbf{r}_0|)$，平均值是在由 $u_{\\mathrm{trunc}}$ 生成的系综上计算的。\n\n对应于全势的真实超额化学势为：\n$$\n\\mu^{\\mathrm{ex}}_{\\mathrm{full}} = -k_B T \\ln \\left\\langle \\exp(-\\beta \\Delta U_{\\mathrm{full}}) \\right\\rangle_{\\mathrm{full}}\n$$\n其中 $\\Delta U_{\\mathrm{full}} = \\sum_{i=1}^N u_{\\mathrm{full}}(|\\mathbf{r}_i - \\mathbf{r}_0|)$。\n\n尾部校正 $\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}}$ 定义为必须加到模拟结果上以恢复全势结果的差值：$\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}} = \\mu^{\\mathrm{ex}}_{\\mathrm{full}} - \\mu^{\\mathrm{ex}}_{\\mathrm{trunc}}$。在此类校正中，一个隐含的标准近似是假设流体结构（例如径向分布函数）可以很好地由截断势描述。然后，校正涉及计算被忽略的势能尾部的能量贡献，并在截断系统的构型上取平均。因此，我们通过在截断系综上计算 $\\langle \\exp(-\\beta \\Delta U_{\\mathrm{full}}) \\rangle$ 来近似 $\\mu^{\\mathrm{ex}}_{\\mathrm{full}}$：\n$$\n\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}} \\approx -k_B T \\ln \\left\\langle \\exp(-\\beta \\Delta U_{\\mathrm{full}}) \\right\\rangle_{\\mathrm{trunc}} - (-k_B T \\ln \\left\\langle \\exp(-\\beta \\Delta U_{\\mathrm{trunc}}) \\right\\rangle_{\\mathrm{trunc}})\n$$\n$$\n\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}} \\approx -k_B T \\ln \\left( \\frac{\\left\\langle \\exp(-\\beta \\Delta U_{\\mathrm{full}}) \\right\\rangle_{\\mathrm{trunc}}}{\\left\\langle \\exp(-\\beta \\Delta U_{\\mathrm{trunc}}) \\right\\rangle_{\\mathrm{trunc}}} \\right) = -k_B T \\ln \\left\\langle \\exp(-\\beta[\\Delta U_{\\mathrm{full}} - \\Delta U_{\\mathrm{trunc}}]) \\right\\rangle_{\\mathrm{trunc}}\n$$\n令 $\\Delta U_{\\mathrm{tail}} = \\Delta U_{\\mathrm{full}} - \\Delta U_{\\mathrm{trunc}}$。这是测试粒子与所有其他超出截断半径 $r_c$ 的粒子之间的相互作用能。\n\n**3. 领头阶（平均场）近似**\n\n问题指出校正应在领头阶上处理。势能 $u_{\\mathrm{LJ}}(r)$ 随距离迅速衰减，因此当 $r > r_c$ 时其值很小。因此，来自尾部的测试粒子能量贡献 $\\Delta U_{\\mathrm{tail}}$ 也很小，即 $\\beta \\Delta U_{\\mathrm{tail}} \\ll 1$。这为一阶展开提供了依据。使用对于小 $x$ 的近似 $\\exp(-x) \\approx 1-x$ 和对于小 $y$ 的近似 $\\ln(1-y) \\approx -y$：\n$$\n\\left\\langle \\exp(-\\beta \\Delta U_{\\mathrm{tail}}) \\right\\rangle \\approx \\left\\langle 1 - \\beta \\Delta U_{\\mathrm{tail}} \\right\\rangle = 1 - \\beta \\left\\langle \\Delta U_{\\mathrm{tail}} \\right\\rangle\n$$\n$$\n\\ln \\left\\langle \\exp(-\\beta \\Delta U_{\\mathrm{tail}}) \\right\\rangle \\approx \\ln(1 - \\beta \\left\\langle \\Delta U_{\\mathrm{tail}} \\right\\rangle) \\approx -\\beta \\left\\langle \\Delta U_{\\mathrm{tail}} \\right\\rangle\n$$\n将此代入尾部校正的表达式中：\n$$\n\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}} \\approx -k_B T (-\\beta \\left\\langle \\Delta U_{\\mathrm{tail}} \\right\\rangle) = \\left\\langle \\Delta U_{\\mathrm{tail}} \\right\\rangle\n$$\n这表明，对超额化学势的领头阶尾部校正就是测试粒子由于与超出截断半径 $r_c$ 的粒子相互作用而产生的平均势能。\n\n**4. 平均场积分**\n\n我们现在将 $\\langle \\Delta U_{\\mathrm{tail}} \\rangle$ 表示为积分形式。在距离测试粒子 $r$ 处，体积为 $dV = 4\\pi r^2 dr$ 的球壳中的平均粒子数由 $\\rho g(r) dV$ 给出，其中 $\\rho$ 是数密度，$g(r)$ 是径向分布函数。通过将对势乘以该粒子密度，并在相关体积上积分，可以获得平均相互作用能：\n$$\n\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}} \\approx \\left\\langle \\Delta U_{\\mathrm{tail}} \\right\\rangle = \\int_{r_c}^{\\infty} u_{\\mathrm{LJ}}(r) \\rho g(r) (4\\pi r^2 dr)\n$$\n问题指出，使用这样的近似：对于超出截断半径的间距，流体是无结构的，即当 $r \\ge r_c$ 时 $g(r) \\approx 1$。积分简化为：\n$$\n\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}} = 4\\pi\\rho \\int_{r_c}^{\\infty} u_{\\mathrm{LJ}}(r) r^2 dr\n$$\n\n**5. 计算 Lennard-Jones 势的积分**\n\n我们现在将 Lennard-Jones 势代入积分中：\n$$\n\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}} = 4\\pi\\rho \\int_{r_c}^{\\infty} 4\\epsilon \\left[ \\left( \\frac{\\sigma}{r} \\right)^{12} - \\left( \\frac{\\sigma}{r} \\right)^{6} \\right] r^2 dr\n$$\n问题要求的是约化校正 $\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}}/\\epsilon$：\n$$\n\\frac{\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}}}{\\epsilon} = 16\\pi\\rho \\int_{r_c}^{\\infty} \\left[ \\sigma^{12}r^{-12} - \\sigma^6 r^{-6} \\right] r^2 dr\n$$\n$$\n\\frac{\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}}}{\\epsilon} = 16\\pi\\rho \\int_{r_c}^{\\infty} \\left( \\sigma^{12}r^{-10} - \\sigma^6 r^{-4} \\right) dr\n$$\n进行定积分计算：\n$$\n\\int_{r_c}^{\\infty} \\left( \\sigma^{12}r^{-10} - \\sigma^6 r^{-4} \\right) dr = \\left[ \\frac{\\sigma^{12}r^{-9}}{-9} - \\frac{\\sigma^6 r^{-3}}{-3} \\right]_{r_c}^{\\infty}\n$$\n$$\n= \\left[ -\\frac{\\sigma^{12}}{9r^9} + \\frac{\\sigma^6}{3r^3} \\right]_{r_c}^{\\infty}\n$$\n在积分上下限（$r \\to \\infty$ 和 $r = r_c$）处求值：\n$$\n= \\left( \\lim_{r\\to\\infty} \\left( -\\frac{\\sigma^{12}}{9r^9} + \\frac{\\sigma^6}{3r^3} \\right) \\right) - \\left( -\\frac{\\sigma^{12}}{9r_c^9} + \\frac{\\sigma^6}{3r_c^3} \\right)\n$$\n$$\n= (0 + 0) - \\left( -\\frac{\\sigma^{12}}{9r_c^9} + \\frac{\\sigma^6}{3r_c^3} \\right) = \\frac{\\sigma^{12}}{9r_c^9} - \\frac{\\sigma^6}{3r_c^3}\n$$\n将此结果代回我们的约化校正表达式中：\n$$\n\\frac{\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}}}{\\epsilon} = 16\\pi\\rho \\left( \\frac{\\sigma^{12}}{9r_c^9} - \\frac{\\sigma^6}{3r_c^3} \\right)\n$$\n这就是以 $\\rho$、$\\sigma$ 和 $r_c$ 为函数的约化尾部校正的最终闭合形式符号表达式。", "answer": "$$\n\\boxed{16\\pi\\rho \\left( \\frac{\\sigma^{12}}{9r_c^9} - \\frac{\\sigma^6}{3r_c^3} \\right)}\n$$", "id": "3461858"}, {"introduction": "Widom插入法巧妙地将宏观的化学势与微观的插入能统计分布联系起来。本练习 [@problem_id:3461880] 邀请你超越简单的平均值，运用累积量展开这一更有力的工具。通过将展开式截断至二阶，你将推导出插入能 $\\Delta U$ 的平均值和方差如何共同决定过剩化学势，从而揭示热力学性质与统计涨落之间的深刻联系。", "problem": "考虑一个处于正则系综中的均匀单组分经典流体，其数密度为 $\\rho$，温度为 $T$，体积为 $V$。超额化学势 $\\mu^{\\mathrm{ex}}$ 定义为在相同温度 $T$ 和数密度 $\\rho$ 下，总化学势与理想气体化学势之差。在分子模拟中，评估 $\\mu^{\\mathrm{ex}}$ 的一个标准途径是 Widom 测试粒子插入法。在该方法中，一个示踪粒子被假设性地插入到平衡的溶剂构型中，并测量相应的插入能 $\\Delta U$，该能量定义为在随机位置添加示踪粒子但不弛豫溶剂时总势能的变化。\n\n从 $\\mu$ 基于 Helmholtz 自由能和构型积分的正则系综定义出发，并利用测试粒子插入思想实验，推导 $\\mu^{\\mathrm{ex}}$ 关于随机变量 $\\Delta U$ 的累积量展开表达式。然后，假设在给定的温度范围内，$\\Delta U$ 的前两个累积量遵循经验温度标度关系\n$\\langle \\Delta U \\rangle(T) = u_{0} + u_{1}\\,T$ 和 $\\mathrm{Var}(\\Delta U)(T) = v_{0} + v_{1}\\,T$，其中 $u_{0}$、$u_{1}$、$v_{0}$ 和 $v_{1}$ 是与温度无关的常数，而 $k_{B}$ 是 Boltzmann 常数。将累积量展开在二阶截断（即，只保留第一和第二累积量），并假设此截断在所述温度范围内有效。\n\n在这些条件下，推导 $\\mu^{\\mathrm{ex}}(T)$ 作为 $T$、$k_{B}$、$u_{0}$、$u_{1}$、$v_{0}$ 和 $v_{1}$ 的函数的闭合形式解析表达式。请以单一简化表达式的形式提供最终答案。不要代入任何数值。最终答案必须是一个闭合形式的解析表达式，表达式本身不包含任何单位。", "solution": "问题陈述已经过验证，被认为是具有科学依据、良定且客观的。它代表了统计力学中的一个标准推导，在特定的、明确定义的假设下，将 Widom 插入法与累积量展开相结合。因此，我们可以开始求解。\n\n在正则系综中，化学势 $\\mu$ 定义为 Helmholtz 自由能 $A$ 对粒子数 $N$ 的偏导数，其中体积 $V$ 和温度 $T$ 保持恒定：\n$$\n\\mu = \\left(\\frac{\\partial A}{\\partial N}\\right)_{V,T}\n$$\n在热力学极限下，该导数可以表示为有限差分：\n$$\n\\mu = A(N+1, V, T) - A(N, V, T)\n$$\nHelmholtz 自由能通过 $A = -k_B T \\ln Q_N$ 与正则配分函数 $Q_N$ 相关，其中 $k_B$ 是 Boltzmann 常数。因此，化学势可以写成：\n$$\n\\mu = -k_B T \\ln\\left(\\frac{Q_{N+1}}{Q_N}\\right)\n$$\n对于一个由 $N$ 个全同、不可区分的经典粒子组成的系统，其正则配分函数由下式给出：\n$$\nQ_N = \\frac{1}{N! \\Lambda^{3N}} Z_N\n$$\n其中 $\\Lambda$ 是 de Broglie 热波长，$Z_N$ 是构型积分：\n$$\nZ_N = \\int_V \\dots \\int_V \\exp(-\\beta U_N(\\mathbf{r}^N)) d\\mathbf{r}^N\n$$\n此处，$\\beta = (k_B T)^{-1}$，$U_N(\\mathbf{r}^N)$ 是 $N$ 个粒子的总势能，其坐标为 $\\mathbf{r}^N$，积分在体积 $V$ 上进行。\n\n配分函数之比为：\n$$\n\\frac{Q_{N+1}}{Q_N} = \\frac{N! \\Lambda^{3N}}{(N+1)! \\Lambda^{3(N+1)}} \\frac{Z_{N+1}}{Z_N} = \\frac{1}{(N+1)\\Lambda^3} \\frac{Z_{N+1}}{Z_N}\n$$\n在热力学极限下（$N \\to \\infty$），我们可以近似为 $N+1 \\approx N$ 并使用数密度 $\\rho = N/V$。\n化学势变为：\n$$\n\\mu = -k_B T \\ln\\left(\\frac{V}{(N+1)\\Lambda^3} \\frac{Z_{N+1}}{V Z_N}\\right) \\approx -k_B T \\ln\\left(\\frac{1}{\\rho\\Lambda^3}\\right) - k_B T \\ln\\left(\\frac{Z_{N+1}}{V Z_N}\\right)\n$$\n第一项对应于理想气体化学势 $\\mu^{\\mathrm{id}} = k_B T \\ln(\\rho\\Lambda^3)$。因此，超额化学势 $\\mu^{\\mathrm{ex}} = \\mu - \\mu^{\\mathrm{id}}$ 为：\n$$\n\\mu^{\\mathrm{ex}} = -k_B T \\ln\\left(\\frac{Z_{N+1}}{V Z_N}\\right)\n$$\n该表达式是 Widom 插入法的出发点。我们现在分析构型积分之比。$(N+1)$ 粒子系统的势能可以写为原始 $N$ 个粒子势能 $U_N$ 与第 $(N+1)$ 个粒子（测试粒子）同原始 $N$ 个粒子相互作用能之和。这个相互作用能就是插入能 $\\Delta U$。\n$$\nU_{N+1}(\\mathbf{r}^{N+1}) = U_N(\\mathbf{r}^N) + \\Delta U(\\mathbf{r}_{N+1}; \\mathbf{r}^N)\n$$\n那么 $N+1$ 个粒子的构型积分是：\n$$\nZ_{N+1} = \\int_V d\\mathbf{r}_{N+1} \\int d\\mathbf{r}^N \\exp(-\\beta U_N(\\mathbf{r}^N)) \\exp(-\\beta \\Delta U(\\mathbf{r}_{N+1}; \\mathbf{r}^N))\n$$\n我们可以通过识别 N 粒子系统构型的正则平均 $\\langle \\dots \\rangle_N$ 的定义来重写此式：\n$$\nZ_{N+1} = \\int_V d\\mathbf{r}_{N+1} \\left( \\int d\\mathbf{r}^N \\exp(-\\beta U_N) \\right) \\left( \\frac{\\int d\\mathbf{r}^N \\exp(-\\beta U_N) \\exp(-\\beta \\Delta U)}{\\int d\\mathbf{r}^N \\exp(-\\beta U_N)} \\right)\n$$\n$$\nZ_{N+1} = Z_N \\int_V \\langle \\exp(-\\beta \\Delta U(\\mathbf{r}_{N+1})) \\rangle_N d\\mathbf{r}_{N+1}\n$$\n由于流体是均匀的，系综平均 $\\langle \\exp(-\\beta \\Delta U) \\rangle_N$ 与测试粒子的位置 $\\mathbf{r}_{N+1}$ 无关。对 $\\mathbf{r}_{N+1}$ 的积分仅得到一个体积因子 $V$。\n$$\nZ_{N+1} = Z_N V \\langle \\exp(-\\beta \\Delta U) \\rangle\n$$\n此处，尖括号 $\\langle \\dots \\rangle$ 表示对 N 粒子系统的构型和测试粒子的随机位置两者同时进行的平均。将此结果代入 $\\mu^{\\mathrm{ex}}$ 的表达式中，得到 Widom 插入公式：\n$$\n\\mu^{\\mathrm{ex}} = -k_B T \\ln\\left(\\frac{Z_N V \\langle \\exp(-\\beta \\Delta U) \\rangle}{V Z_N}\\right) = -k_B T \\ln\\langle \\exp(-\\beta \\Delta U) \\rangle\n$$\n问题要求用累积量展开来表示此式。随机变量 $X$ 的矩生成函数的对数 $\\ln\\langle \\exp(tX) \\rangle$ 是累积量生成函数 $K_X(t)$，其级数展开定义了累积量 $\\kappa_n$：\n$$\nK_X(t) = \\ln\\langle \\exp(tX) \\rangle = \\sum_{n=1}^\\infty \\kappa_n \\frac{t^n}{n!}\n$$\n在我们的情况中，随机变量是插入能 $\\Delta U$，参数是 $t = -\\beta = -1/(k_B T)$。因此：\n$$\n\\mu^{\\mathrm{ex}} = -k_B T \\left( \\sum_{n=1}^\\infty \\kappa_n(\\Delta U) \\frac{(-\\beta)^n}{n!} \\right)\n$$\n问题指定将此展开在二阶（$n=2$）截断。前两个累积量是均值和方差：\n$\\kappa_1 = \\langle \\Delta U \\rangle$\n$\\kappa_2 = \\langle (\\Delta U - \\langle \\Delta U \\rangle)^2 \\rangle = \\mathrm{Var}(\\Delta U)$\n$\\mu^{\\mathrm{ex}}$ 的截断表达式为：\n$$\n\\mu^{\\mathrm{ex}} \\approx -k_B T \\left( \\kappa_1 \\frac{(-\\beta)}{1!} + \\kappa_2 \\frac{(-\\beta)^2}{2!} \\right) = -k_B T \\left( -\\beta \\kappa_1 + \\frac{\\beta^2}{2} \\kappa_2 \\right)\n$$\n代入 $\\beta = 1/(k_B T)$：\n$$\n\\mu^{\\mathrm{ex}}(T) \\approx -k_B T \\left( -\\frac{1}{k_B T} \\langle \\Delta U \\rangle + \\frac{1}{2(k_B T)^2} \\mathrm{Var}(\\Delta U) \\right)\n$$\n简化此表达式得到超额化学势的二阶近似：\n$$\n\\mu^{\\mathrm{ex}}(T) \\approx \\langle \\Delta U \\rangle - \\frac{1}{2k_B T} \\mathrm{Var}(\\Delta U)\n$$\n现在，我们代入给定的均值和方差的经验温度标度关系：\n$\\langle \\Delta U \\rangle(T) = u_{0} + u_{1}T$\n$\\mathrm{Var}(\\Delta U)(T) = v_{0} + v_{1}T$\n这得到：\n$$\n\\mu^{\\mathrm{ex}}(T) = (u_{0} + u_{1}T) - \\frac{1}{2k_B T} (v_{0} + v_{1}T)\n$$\n为了得到最终的闭合形式表达式，我们将项 $-1/(2k_B T)$ 分配进去：\n$$\n\\mu^{\\mathrm{ex}}(T) = u_{0} + u_{1}T - \\frac{v_{0}}{2k_B T} - \\frac{v_{1}T}{2k_B T}\n$$\n最后一项简化为：\n$$\n\\mu^{\\mathrm{ex}}(T) = u_{0} + u_{1}T - \\frac{v_{0}}{2k_B T} - \\frac{v_{1}}{2k_B}\n$$\n最后，为了清晰起见，我们将各项分组，尽管这对结果的正确性并非严格必要。我们可以将常数项、T 的线性项以及与 T 成反比的项分组：\n$$\n\\mu^{\\mathrm{ex}}(T) = \\left(u_{0} - \\frac{v_{1}}{2k_{B}}\\right) + u_{1}T - \\frac{v_{0}}{2k_{B}T}\n$$\n将此展开得到最终的简化表达式。\n$$\n\\mu^{\\mathrm{ex}}(T) = u_{0} + u_{1}T - \\frac{v_{1}}{2k_{B}} - \\frac{v_{0}}{2k_{B}T}\n$$\n该表达式是在给定假设下 $\\mu^{\\mathrm{ex}}(T)$ 的闭合形式表示。", "answer": "$$\\boxed{u_{0} + u_{1}T - \\frac{v_{1}}{2k_{B}} - \\frac{v_{0}}{2k_{B}T}}$$", "id": "3461880"}, {"introduction": "理论的理解最好通过动手实践来巩固。这最后一个综合性练习 [@problem_id:3461917] 将挑战你在计算环境中从零开始构建Widom插入法。你将实现整个工作流程，包括在周期性边界条件的盒子中生成粒子构型、对测试粒子进行插入采样、计算相互作用能以及正确应用统计平均。这项实践弥合了抽象公式与可触摸的数值结果之间的鸿沟，为你提供了计算统计力学方面全面的动手经验。", "problem": "要求您设计并实现一个完整的、确定性的程序，为刚性双原子测试粒子在三维立方模拟盒子中采样随机插入位置和方向，该过程需遵循周期性边界条件（PBC），符合最小镜像约定（MIC），并严格避免键合排斥区域。目标是通过对插入引起的能量变化的玻尔兹曼因子进行采样，从第一性原理估算无量纲过剩化学势。实现必须是鲁棒的、科学上自洽的，并且数值稳定。\n\n从正则系综以及化学势作为亥姆霍兹自由能对粒子数的导数（在恒定温度和体积下）的定义开始。该程序必须基于统计力学描述推导出要估算的适当可观测量，并且不得依赖本声明中提供的任何快捷公式。\n\n该系统由 $N$ 个点粒子组成，它们通过截断的 Lennard-Jones (LJ) 势相互作用，在约化单位下，特征长度 $\\sigma$ 和势阱深度 $\\varepsilon$ 均设置为 $1$。双原子测试粒子包含两个 LJ 位点，由固定的键长 $\\ell$ 分隔。对于每次随机插入尝试，在盒子内为二聚体中心采样一个均匀分布的位置，并在单位球面上为二聚体轴采样一个均匀分布的方向。在位置 $\\mathbf{r}_\\mathrm{center} \\pm (\\ell/2)\\,\\hat{\\mathbf{u}}$ 处构建两个插入位点，其中 $\\hat{\\mathbf{u}}$ 是采样的单位方向向量。应用与周期性边界条件兼容的最小镜像约定来计算所有位点间的位移和距离。当任一插入位点位于围绕指定的“键合”锚定原子定义的任何键合排斥区域内时，通过将其玻尔兹曼权重设置为零来拒绝插入。键合排斥区域是以任何被归类为键合的原子为中心、半径为 $r_\\mathrm{excl}$ 的球体。键合锚定的分类是确定性的，并基于规则，如下面的测试套件中所定义。\n\n对于有效插入的能量计算，计算相互作用能变化 $\\Delta U$，其值为两个插入位点与所有现有原子之间的成对截断 LJ 相互作用之和，并使用最小镜像约定计算间距。使用标准的约化 Lennard-Jones 形式\n$$\nu_\\mathrm{LJ}(r) = \\begin{cases}\n4 \\varepsilon \\left[\\left(\\frac{\\sigma}{r}\\right)^{12} - \\left(\\frac{\\sigma}{r}\\right)^6 \\right],  r  r_\\mathrm{c},\\\\\n0,  r \\ge r_\\mathrm{c},\n\\end{cases}\n$$\n其中 $\\sigma = 1$ 且 $\\varepsilon = 1$。不应用长程校正。插入中心的采样域是整个盒子；对于其构建的位点落入任何排斥球内的任何插入，键合排斥会施加零玻尔兹曼权重。\n\n方向采样必须在单位球面上均匀。一种可接受的方法是抽取一个具有独立高斯分量的三维向量，并将其归一化为单位长度以获得 $\\hat{\\mathbf{u}}$。\n\n设 $M$ 为每个测试用例的独立插入尝试次数。对于每次尝试 $i$，如果插入有效，则计算玻尔兹曼因子 $w_i = \\exp\\!\\left(-\\beta \\Delta U_i\\right)$；如果任一位点违反键合排斥规则，则 $w_i = 0$。这里 $\\beta = 1/(k_\\mathrm{B} T)$，在约化单位中玻尔兹曼常数 $k_\\mathrm{B} = 1$。使用该采样生成统计力学所要求的形式的无量纲过剩化学势（相对于理想贡献的过剩部分），表示为无物理单位的无量纲量。\n\n科学和数值约束：\n- 在边长为 $L$ 的立方盒子中使用周期性边界条件，并对所有位移计算使用最小镜像约定。\n- 确保随机方向采样在球面上均匀，随机中心采样在盒子中均匀。\n- 使用约化 Lennard-Jones 单位，其中 $\\sigma = 1$，$\\varepsilon = 1$， $k_\\mathrm{B} = 1$。\n- 通过分配零玻尔兹曼权重来严格拒绝违反键合排斥规则的插入。\n- 使用截断势，截断半径为 $r_\\mathrm{c}$。\n\n测试套件规范：\n对于每个测试用例，使用指定的种子为每个笛卡尔分量在 $[0,L)$ 范围内均匀生成 $N$ 个原子位置。对于从零开始的索引，将索引满足 $i \\bmod 3 = 0$ 的原子确定性地分类为键合锚定原子。键合排斥半径为 $r_\\mathrm{excl}$。每个测试用例的最终输出是通过上述玻尔兹曼因子采样程序获得的无量纲过剩化学势。\n\n四个测试用例如下：\n\n- 案例 1：\n  - $L = 10$\n  - $N = 64$\n  - 种子 $= 12345$\n  - $T = 1.5$\n  - $\\ell = 1.0$\n  - $r_\\mathrm{excl} = 0.9$\n  - $r_\\mathrm{c} = 2.5$\n  - $M = 10000$\n\n- 案例 2：\n  - $L = 6$\n  - $N = 64$\n  - 种子 $= 67890$\n  - $T = 1.0$\n  - $\\ell = 1.0$\n  - $r_\\mathrm{excl} = 0.9$\n  - $r_\\mathrm{c} = 2.5$\n  - $M = 10000$\n\n- 案例 3：\n  - $L = 4$\n  - $N = 96$\n  - 种子 $= 13579$\n  - $T = 0.8$\n  - $\\ell = 1.5$\n  - $r_\\mathrm{excl} = 1.0$\n  - $r_\\mathrm{c} = 2.5$\n  - $M = 10000$\n\n- 案例 4：\n  - $L = 8$\n  - $N = 128$\n  - 种子 $= 24680$\n  - $T = 1.2$\n  - $\\ell = 2.0$\n  - $r_\\mathrm{excl} = 0.9$\n  - $r_\\mathrm{c} = 2.5$\n  - $M = 10000$\n\n最终输出格式：\n您的程序必须生成一行输出，其中包含案例 1-4 的四个无量纲过剩化学势，格式为用方括号括起来的逗号分隔列表，例如 $\\left[\\mu_1,\\mu_2,\\mu_3,\\mu_4\\right]$。每个条目必须是一个浮点数。答案应表示为无单位的无量纲量，格式为定点小数表示法，小数点后保留 $6$ 位。如果估计器得出的平均玻尔兹曼因子为零，则为相应案例打印 $\\mathrm{inf}$。", "solution": "该问题要求设计并实现一个程序，用以计算在由 $N$ 个 Lennard-Jones 粒子组成的流体中，刚性双原子测试粒子的无量纲过剩化学势 $\\beta \\mu^{ex}$。指定的方法是 Widom 测试粒子插入法，这是统计力学中用于在计算机模拟中计算化学势的一项基本技术。由于每个测试用例都使用了指定的随机数生成器种子，整个过程是确定性的。\n\n首先，我们必须按照规定从第一性原理推导过剩化学势的表达式。我们从正则 ($N,V,T$) 系综开始。化学势 $\\mu$ 与亥姆霍兹自由能 $A$ 在增加一个粒子时的变化有关：\n$$\n\\mu = \\left(\\frac{\\partial A}{\\partial N}\\right)_{V,T}\n$$\n对于一个大系统，这个导数可以用有限差分来近似：\n$$\n\\mu \\approx A(N+1, V, T) - A(N, V, T)\n$$\n亥姆霍兹自由能通过 $A = -k_B T \\ln Z$ 与正则配分函数 $Z$ 相关联。因此，\n$$\n\\mu \\approx -k_B T \\ln\\left(\\frac{Z(N+1, V, T)}{Z(N, V, T)}\\right)\n$$\n一个由 $N$ 个相同、不可区分的经典粒子组成的系统的配分函数由下式给出\n$$\nZ(N,V,T) = \\frac{1}{N!\\Lambda^{3N}} \\int_V \\dots \\int_V e^{-\\beta U_N(\\mathbf{r}^N)} d\\mathbf{r}^N = \\frac{Q_N}{N!\\Lambda^{3N}}\n$$\n其中 $\\Lambda$ 是热德布罗意波长，$\\beta = 1/(k_B T)$，$U_N$ 是 $N$ 粒子系统的势能，$Q_N$ 是构型积分。因此，配分函数之比为：\n$$\n\\frac{Z_{N+1}}{Z_N} = \\frac{N!\\Lambda^{3N}}{(N+1)!\\Lambda^{3(N+1)}} \\frac{Q_{N+1}}{Q_N} = \\frac{1}{(N+1)\\Lambda^3} \\frac{Q_{N+1}}{Q_N}\n$$\n构型积分 $Q_{N+1}$ 可以用 $Q_N$ 来表示。$(N+1)$ 粒子系统的总势能 $U_{N+1}$ 可以分解为原始 $N$ 个粒子的能量 $U_N$ 和第 $(N+1)$ 个粒子与原始 $N$ 个粒子之间的相互作用能 $\\Delta U$。\n$$\nU_{N+1}(\\mathbf{r}^{N}, \\mathbf{r}_{N+1}) = U_N(\\mathbf{r}^N) + \\Delta U(\\mathbf{r}_{N+1}; \\mathbf{r}^N)\n$$\n这里，$\\mathbf{r}_{N+1}$ 代表测试粒子的坐标。对于双原子分子，这些坐标包括质心位置 $\\mathbf{r}_\\text{center}$ 和方向 $\\mathbf{\\Omega}$。相应的积分元是 $d\\mathbf{r}_{N+1} = d\\mathbf{r}_\\text{center} d\\mathbf{\\Omega}$。\n将此代入 $Q_{N+1}$ 的表达式中：\n$$\nQ_{N+1} = \\int d\\mathbf{r}^N \\int d\\mathbf{r}_{N+1} e^{-\\beta (U_N + \\Delta U)} = \\int d\\mathbf{r}^N e^{-\\beta U_N} \\int d\\mathbf{r}_{N+1} e^{-\\beta \\Delta U}\n$$\n比值 $Q_{N+1}/Q_N$ 是对测试粒子坐标的内部积分的正则平均：\n$$\n\\frac{Q_{N+1}}{Q_N} = \\frac{\\int d\\mathbf{r}^N e^{-\\beta U_N} \\int d\\mathbf{r}_{N+1} e^{-\\beta \\Delta U}}{\\int d\\mathbf{r}^N e^{-\\beta U_N}} = \\left\\langle \\int d\\mathbf{r}_{N+1} e^{-\\beta \\Delta U} \\right\\rangle_N\n$$\n对测试粒子自由度的积分是在盒子体积 $V$ 上对其质心进行的，以及在整个立体角 $4\\pi$ 上对其方向进行的。因此，$\\int d\\mathbf{r}_{N+1} = \\int_V d\\mathbf{r}_\\text{center} \\int_{4\\pi} d\\mathbf{\\Omega}$。\n化学势可以分解为理想气体部分和过剩部分，$\\mu = \\mu^{id} + \\mu^{ex}$。理想部分是 $\\mu^{id} = k_B T \\ln(\\rho \\Lambda^3)$，其中 $\\rho = (N+1)/V$ 是数密度。结合这些关系，过剩化学势由下式给出：\n$$\ne^{-\\beta \\mu^{ex}} = \\left\\langle \\frac{1}{V(4\\pi)} \\int_V d\\mathbf{r}_\\text{center} \\int_{4\\pi} d\\mathbf{\\Omega} \\ e^{-\\beta \\Delta U(\\mathbf{r}_\\text{center}, \\mathbf{\\Omega})} \\right\\rangle_N\n$$\n右边的表达式是在所有可能的测试粒子插入上的平均值，再对 $N$ 粒子流体的所有构型 $\\langle \\dots \\rangle_N$ 进行平均。该问题通过使用 $N$ 个粒子的单个固定构型来简化此过程。任务随后简化为计算插入平均值：\n$$\n\\langle e^{-\\beta \\Delta U} \\rangle_\\text{ins} = \\frac{1}{V(4\\pi)} \\int_V d\\mathbf{r}_\\text{center} \\int_{4\\pi} d\\mathbf{\\Omega} \\ e^{-\\beta \\Delta U(\\mathbf{r}_\\text{center}, \\mathbf{\\Omega})}\n$$\n这个积分使用蒙特卡洛程序进行估算。我们生成 $M$ 个随机、均匀分布的插入构型（中心和方向），并对玻尔兹曼因子 $\\exp(-\\beta \\Delta U)$ 进行平均：\n$$\n\\langle e^{-\\beta \\Delta U} \\rangle_\\text{ins} \\approx \\frac{1}{M} \\sum_{i=1}^M \\exp(-\\beta \\Delta U_i)\n$$\n然后通过下式获得无量纲过剩化学势：\n$$\n\\beta \\mu^{ex} = -\\ln \\left( \\langle e^{-\\beta \\Delta U} \\rangle_\\text{ins} \\right) = -\\ln \\left( \\frac{1}{M} \\sum_{i=1}^M w_i \\right)\n$$\n其中 $w_i = \\exp(-\\beta \\Delta U_i)$ 是第 $i$ 次插入的玻尔兹曼权重。\n\n算法流程如下：\n1.  对于每个测试用例，初始化系统参数：盒子长度 $L$、粒子数 $N$、温度 $T$、双原子键长 $\\ell$、排斥半径 $r_\\text{excl}$、势能截断半径 $r_\\mathrm{c}$ 和插入尝试次数 $M$。使用指定的种子设置随机数生成器。所有计算均使用约化单位，其中 $\\sigma=1$，$\\varepsilon=1$ 和 $k_B=1$。\n\n2.  通过从区间 $[0, L)$ 均匀抽取它们的笛卡尔坐标来生成 $N$ 个宿主粒子的位置 $\\mathbf{r}_j$（其中 $j=1, \\dots, N$）。\n\n3.  识别“键合”锚定原子的子集。根据问题描述，这些是其零基索引 $i$ 满足 $i \\pmod 3 = 0$ 的原子。存储它们的位置。\n\n4.  初始化变量 `boltzmann_sum` 为 $0.0$。迭代 $M$ 次以执行测试粒子插入。\n\n5.  在每次迭代 $i$ 中：\n    a.  在体积为 $V=L^3$ 的立方盒子内均匀采样一个质心位置 $\\mathbf{r}_\\text{center}$。\n    b.  从单位球体表面均匀采样一个随机方向向量 $\\hat{\\mathbf{u}}$。这是通过生成一个分量服从标准正态分布的3D向量然后将其归一化来完成的。\n    c.  构建双原子分子的两个位点的位置：$\\mathbf{r}_a = \\mathbf{r}_\\text{center} - (\\ell/2)\\hat{\\mathbf{u}}$ 和 $\\mathbf{r}_b = \\mathbf{r}_\\text{center} + (\\ell/2)\\hat{\\mathbf{u}}$。\n\n6.  检查是否违反键合排斥约束。对于两个位点 $\\mathbf{r}_a$ 和 $\\mathbf{r}_b$ 中的每一个，计算其到每个键合锚定原子的距离。所有距离必须使用周期性边界条件的最小镜像约定（MIC）来计算。对于边长为 $L$ 的立方盒子中的位移向量 $\\Delta\\mathbf{r}$，MIC 位移为 $\\Delta\\mathbf{r}' = \\Delta\\mathbf{r} - L \\cdot \\text{round}(\\Delta\\mathbf{r}/L)$。距离是其模 $\\|\\Delta\\mathbf{r}'\\|$。如果任何此类距离小于 $r_\\text{excl}$，则插入无效。\n\n7.  如果插入无效，则玻尔兹曼权重 $w_i$ 为 $0$。循环继续到下一次迭代。\n\n8.  如果插入有效，则计算相互作用能变化 $\\Delta U_i$。这是两个插入位点与 $N$ 个现有粒子之间所有成对相互作用的总和：\n    $$\n    \\Delta U_i = \\sum_{j=1}^{N} \\left[ u_\\text{LJ}(\\|\\mathbf{r}_a - \\mathbf{r}_j\\|_\\text{MIC}) + u_\\text{LJ}(\\|\\mathbf{r}_b - \\mathbf{r}_j\\|_\\text{MIC}) \\right]\n    $$\n    势能 $u_\\text{LJ}(r)$ 是截断的 Lennard-Jones 势：\n    $$\n    u_\\mathrm{LJ}(r) = \\begin{cases} 4 \\left( r^{-12} - r^{-6} \\right),  r  r_\\mathrm{c} \\\\ 0,  r \\ge r_\\mathrm{c} \\end{cases}\n    $$\n    \n9.  计算玻尔兹曼权重 $w_i = \\exp(-\\beta \\Delta U_i)$（其中 $\\beta = 1/T$），并将其加到 `boltzmann_sum` 中。\n\n10. 在 $M$ 次迭代后，计算平均玻尔兹曼因子 $\\langle w \\rangle = \\text{boltzmann\\_sum} / M$。\n\n11. 无量纲过剩化学势为 $\\beta \\mu^{ex} = -\\ln(\\langle w \\rangle)$。如果 $\\langle w \\rangle = 0$，则结果为 $\\infty$。在非常稠密的系统中，有效插入变得极其不可能，因此这个结果在物理上是合理的。\n\n为指定的四个测试用例中的每一个都实施了此程序。", "answer": "```python\nimport numpy as np\n\ndef pbc_displacement(pos1, pos2, box_length):\n    \"\"\"Calculates the displacement vector obeying the Minimum Image Convention.\"\"\"\n    displacement = pos1 - pos2\n    displacement -= box_length * np.round(displacement / box_length)\n    return displacement\n\ndef lj_potential(r_sq, rc_sq):\n    \"\"\"Calculates the truncated Lennard-Jones potential given squared distance.\"\"\"\n    if r_sq >= rc_sq:\n        return 0.0\n    r2_inv = 1.0 / r_sq\n    r6_inv = r2_inv**3\n    return 4.0 * (r6_inv**2 - r6_inv)\n\ndef calculate_mu_ex_beta(L, N, seed, T, l, r_excl, rc, M):\n    \"\"\"\n    Calculates the dimensionless excess chemical potential for a diatomic molecule.\n    \n    The calculation follows the Widom insertion method for a single, static\n    configuration of N particles.\n    \"\"\"\n    rng = np.random.default_rng(seed)\n    \n    # 1. Generate the N-particle system configuration\n    positions = rng.uniform(0.0, L, size=(N, 3))\n    \n    # 2. Identify bonded anchor atoms\n    anchor_indices = [i for i in range(N) if i % 3 == 0]\n    anchor_positions = positions[anchor_indices]\n    \n    boltzmann_sum = 0.0\n    beta = 1.0 / T\n    rc_sq = rc**2\n    r_excl_sq = r_excl**2\n    \n    # 3. Perform M insertion attempts\n    for _ in range(M):\n        # 3a. Sample a random position and orientation for the test particle\n        center = rng.uniform(0.0, L, size=3)\n        orientation_vec = rng.normal(size=3)\n        norm = np.linalg.norm(orientation_vec)\n        if norm == 0:  # Highly improbable, but a safe check\n            continue\n        u_hat = orientation_vec / norm\n        \n        site1 = center - (l / 2.0) * u_hat\n        site2 = center + (l / 2.0) * u_hat\n        \n        # 3b. Check for bonded-exclusion violations\n        is_valid = True\n        if anchor_positions.shape[0] > 0:\n            for site in [site1, site2]:\n                disp_vectors = pbc_displacement(np.tile(site, (anchor_positions.shape[0], 1)), anchor_positions, L)\n                distances_sq = np.sum(disp_vectors**2, axis=1)\n                if np.any(distances_sq  r_excl_sq):\n                    is_valid = False\n                    break\n            if not is_valid:\n                continue\n\n        # 3c. If valid, calculate the interaction energy change delta_U\n        delta_u = 0.0\n        # Interactions between site1 and all N particles\n        disp_vectors_1 = pbc_displacement(np.tile(site1, (N, 1)), positions, L)\n        distances_sq_1 = np.sum(disp_vectors_1**2, axis=1)\n\n        # Interactions between site2 and all N particles\n        disp_vectors_2 = pbc_displacement(np.tile(site2, (N, 1)), positions, L)\n        distances_sq_2 = np.sum(disp_vectors_2**2, axis=1)\n        \n        for r_sq in np.concatenate((distances_sq_1, distances_sq_2)):\n            delta_u += lj_potential(r_sq, rc_sq)\n            \n        # 3d. Accumulate the Boltzmann factor\n        boltzmann_sum += np.exp(-beta * delta_u)\n        \n    # 4. Calculate the final result\n    avg_boltzmann = boltzmann_sum / M\n    \n    if avg_boltzmann == 0.0:\n        return np.inf\n    else:\n        mu_ex_beta = -np.log(avg_boltzmann)\n        return mu_ex_beta\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print results.\n    \"\"\"\n    test_cases = [\n        {'L': 10, 'N': 64, 'seed': 12345, 'T': 1.5, 'l': 1.0, 'r_excl': 0.9, 'rc': 2.5, 'M': 10000},\n        {'L': 6, 'N': 64, 'seed': 67890, 'T': 1.0, 'l': 1.0, 'r_excl': 0.9, 'rc': 2.5, 'M': 10000},\n        {'L': 4, 'N': 96, 'seed': 13579, 'T': 0.8, 'l': 1.5, 'r_excl': 1.0, 'rc': 2.5, 'M': 10000},\n        {'L': 8, 'N': 128, 'seed': 24680, 'T': 1.2, 'l': 2.0, 'r_excl': 0.9, 'rc': 2.5, 'M': 10000},\n    ]\n\n    results = []\n    for case in test_cases:\n        result = calculate_mu_ex_beta(**case)\n        if result == np.inf:\n            results.append(\"inf\")\n        else:\n            results.append(f\"{result:.6f}\")\n    \n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```", "id": "3461917"}]}