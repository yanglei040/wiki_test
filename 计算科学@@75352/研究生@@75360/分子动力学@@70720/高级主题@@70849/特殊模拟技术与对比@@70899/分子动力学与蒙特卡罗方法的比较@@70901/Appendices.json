{"hands_on_practices": [{"introduction": "理论知识为我们提供了坚实的基础，但真正的理解来自于动手实践。在本章中，我们将通过一系列精心设计的练习，深入探讨分子动力学（MD）和蒙特卡洛（MC）方法的核心机制和实际应用。这些练习将引导我们从分析算法的内在属性，到量化比较它们的采样效率，从而将抽象的概念转化为具体的解决问题的能力。\n\n## 分子动力学中的稳定性：理解时间步长的限制\n\n分子动力学模拟的魅力在于它能再现系统随时间的真实演化。然而，这种确定性的演化依赖于对牛顿运动方程的数值积分，这引入了一个关键的限制：时间步长。在这个练习中，我们将通过分析应用于简谐振子的速度-Verlet算法，从第一性原理推导出其稳定性的上限，从而揭示任何MD模拟中都必须仔细选择时间步长的根本原因 ([@problem_id:3403189])。", "problem": "考虑一个质量为 $m$ 的一维粒子在谐振子势 $U(x) = \\frac{1}{2} k x^{2}$ 中运动。设 $\\omega = \\sqrt{\\frac{k}{m}}$。由速度-Verlet积分方法生成的分子动力学 (MD) 轨迹，根据牛顿第二定律在离散时间点 $t_{n} = n \\Delta t$ 更新位置和速度。从第一性原理（牛顿第二定律和速度-Verlet方法的定义）出发，完成以下任务：\n\n- 推导将状态向量 $y_{n} = \\begin{pmatrix} x_{n} \\\\ v_{n} \\end{pmatrix}$ 推进到 $y_{n+1}$ 的线性齐次递推关系（时间步长为 $\\Delta t$），并将其表示为 $y_{n+1} = M(\\Delta t) \\, y_{n}$ 的形式，其中 $M(\\Delta t)$ 是一个用 $\\omega$ 和 $\\Delta t$ 表示的显式 $2 \\times 2$ 放大矩阵。\n\n- 仅使用常系数线性递推的稳定性判据（即为了保证线性稳定性，$M(\\Delta t)$ 的谱半径不得超过 $1$），推导在此条件下速度-Verlet积分方法对该谐振子保持线性稳定的 $\\Delta t$ 条件。以 $\\omega$ 的闭式表达式形式报告最大稳定时间步长。\n\n- 从 $M(\\Delta t)$ 的特征值出发，求出离散振荡频率 $\\Omega(\\Delta t, \\omega)$，并确定在小 $\\Delta t$ 情况下积分方法的领头阶相位误差。解释稳定性边界如何影响分子动力学在构型抽样和能量守恒方面的准确性，并提及影子（修正的）哈密顿量的存在。\n\n- 在与蒙特卡洛 (MC) 方法的比较中，简要论证为何针对同一谐振子系统、以温度 $T$ 下的玻尔兹曼分布为目标的 Metropolis 算法，在其提议步长尺度上没有类似的线性稳定性限制，并解释提议步长大小影响 MC 准确性和效率的不同机制。\n\n将最终答案表示为关于 $\\omega$ 的最大稳定时间步长的闭式表达式。最终数值答案中不要包含单位。无需四舍五入。", "solution": "所提出的问题是有效的，因为它在科学上基于经典力学和数值分析的原理，问题陈述清晰且信息充分，足以得到唯一解，并且陈述客观。我们可以开始求解。\n\n该问题要求对应用于一维谐振子的速度-Verlet算法进行多部分分析，然后与 Metropolis 蒙特卡洛方法进行概念性比较。\n\n系统是一个质量为 $m$ 的粒子，处于谐振子势 $U(x) = \\frac{1}{2} k x^2$ 中。其运动方程由牛顿第二定律给出：\n$$F = m \\ddot{x} = -\\frac{dU}{dx} = -kx$$\n这可以根据角频率 $\\omega = \\sqrt{k/m}$ 改写为：\n$$\\ddot{x} + \\omega^2 x = 0$$\n任何时刻的加速度都是位置的函数：$a(x) = -\\omega^2 x$。我们将时间 $t_n = n \\Delta t$ 时的加速度记为 $a_n = a(x_n) = -\\omega^2 x_n$。\n\n**第一部分：放大矩阵的推导**\n\n速度-Verlet积分方法包含以下在一个时间步长 $\\Delta t$ 内更新位置 $x$ 和速度 $v$ 的步骤：\n$$x_{n+1} = x_n + v_n \\Delta t + \\frac{1}{2} a_n (\\Delta t)^2$$\n$$v_{n+1} = v_n + \\frac{1}{2} (a_n + a_{n+1}) \\Delta t$$\n我们将这些更新表示为作用于状态向量 $y_n = \\begin{pmatrix} x_n \\\\ v_n \\end{pmatrix}$ 的矩阵变换形式。\n\n首先，我们将 $a_n = -\\omega^2 x_n$ 代入位置更新方程：\n$$x_{n+1} = x_n + v_n \\Delta t - \\frac{1}{2} \\omega^2 x_n (\\Delta t)^2$$\n$$x_{n+1} = \\left(1 - \\frac{1}{2}\\omega^2 (\\Delta t)^2\\right) x_n + (\\Delta t) v_n$$\n这个方程给出了放大矩阵 $M(\\Delta t)$ 的第一行。\n\n接下来，我们处理速度更新。这需要下一时间步的加速度 $a_{n+1} = -\\omega^2 x_{n+1}$。我们代入刚才推导出的 $x_{n+1}$ 的表达式：\n$$a_{n+1} = -\\omega^2 \\left[ \\left(1 - \\frac{1}{2}\\omega^2 (\\Delta t)^2\\right) x_n + (\\Delta t) v_n \\right]$$\n现在，将 $a_n$ 和 $a_{n+1}$ 都代入速度更新方程：\n$$v_{n+1} = v_n + \\frac{1}{2} \\Delta t \\left( -\\omega^2 x_n - \\omega^2 \\left[ \\left(1 - \\frac{1}{2}\\omega^2 (\\Delta t)^2\\right) x_n + (\\Delta t) v_n \\right] \\right)$$\n$$v_{n+1} = v_n - \\frac{\\omega^2 \\Delta t}{2} \\left( x_n + \\left(1 - \\frac{1}{2}\\omega^2 (\\Delta t)^2\\right) x_n + (\\Delta t) v_n \\right)$$\n$$v_{n+1} = v_n - \\frac{\\omega^2 \\Delta t}{2} \\left( \\left(2 - \\frac{1}{2}\\omega^2 (\\Delta t)^2\\right) x_n + (\\Delta t) v_n \\right)$$\n展开各项可得：\n$$v_{n+1} = -\\omega^2 \\Delta t \\left(1 - \\frac{1}{4}\\omega^2 (\\Delta t)^2\\right) x_n + \\left(1 - \\frac{1}{2}\\omega^2 (\\Delta t)^2\\right) v_n$$\n这就给出了放大矩阵的第二行。\n\n结合 $x_{n+1}$ 和 $v_{n+1}$ 的表达式，我们可以写出完整的递推关系：\n$$ y_{n+1} = \\begin{pmatrix} x_{n+1} \\\\ v_{n+1} \\end{pmatrix} = \\begin{pmatrix} 1 - \\frac{1}{2}\\omega^2 (\\Delta t)^2  \\Delta t \\\\ -\\omega^2 \\Delta t \\left(1 - \\frac{1}{4}\\omega^2 (\\Delta t)^2\\right)  1 - \\frac{1}{2}\\omega^2 (\\Delta t)^2 \\end{pmatrix} \\begin{pmatrix} x_n \\\\ v_n \\end{pmatrix} $$\n因此，放大矩阵为：\n$$ M(\\Delta t) = \\begin{pmatrix} 1 - \\frac{1}{2}(\\omega \\Delta t)^2  \\Delta t \\\\ -\\omega^2 \\Delta t \\left(1 - \\frac{1}{4}(\\omega \\Delta t)^2\\right)  1 - \\frac{1}{2}(\\omega \\Delta t)^2 \\end{pmatrix} $$\n\n**第二部分：稳定性条件的推导**\n\n线性稳定性要求放大矩阵的谱半径 $\\rho(M) = \\max_i |\\lambda_i|$ 不超过 $1$。$M$ 的特征值 $\\lambda$ 可通过特征方程 $\\det(M - \\lambda I) = 0$ 求得。\n设 $c = 1 - \\frac{1}{2}(\\omega \\Delta t)^2$。特征方程为：\n$$ (c - \\lambda)^2 - (\\Delta t) \\left[ -\\omega^2 \\Delta t \\left(1 - \\frac{1}{4}(\\omega \\Delta t)^2\\right) \\right] = 0 $$\n$$ (c - \\lambda)^2 = - (\\omega \\Delta t)^2 \\left(1 - \\frac{1}{4}(\\omega \\Delta t)^2\\right) $$\n$$ \\lambda - c = \\pm i (\\omega \\Delta t) \\sqrt{1 - \\frac{1}{4}(\\omega \\Delta t)^2} $$\n特征值为：\n$$ \\lambda_{\\pm} = 1 - \\frac{1}{2}(\\omega \\Delta t)^2 \\pm i (\\omega \\Delta t) \\sqrt{1 - \\frac{1}{4}(\\omega \\Delta t)^2} $$\n稳定性取决于平方根号下项的性质。\n\n情况1：$1 - \\frac{1}{4}(\\omega \\Delta t)^2 \\ge 0$，这意味着 $(\\omega \\Delta t)^2 \\le 4$，或者 $\\omega \\Delta t \\le 2$。\n在这种情况下，特征值是一对共轭复数。每个特征值的模的平方是：\n$$ |\\lambda|^2 = \\left(1 - \\frac{1}{2}(\\omega \\Delta t)^2\\right)^2 + \\left((\\omega \\Delta t) \\sqrt{1 - \\frac{1}{4}(\\omega \\Delta t)^2}\\right)^2 $$\n$$ |\\lambda|^2 = \\left(1 - (\\omega \\Delta t)^2 + \\frac{1}{4}(\\omega \\Delta t)^4\\right) + (\\omega \\Delta t)^2 \\left(1 - \\frac{1}{4}(\\omega \\Delta t)^2\\right) $$\n$$ |\\lambda|^2 = 1 - (\\omega \\Delta t)^2 + \\frac{1}{4}(\\omega \\Delta t)^4 + (\\omega \\Delta t)^2 - \\frac{1}{4}(\\omega \\Delta t)^4 = 1 $$\n因此，对于所有 $\\omega \\Delta t \\le 2$ 的情况，都有 $|\\lambda| = 1$。在此范围内，该方法是稳定的。\n\n情况2：$\\omega \\Delta t > 2$。\n在这种情况下，平方根号下的项为负，特征值变为实数：\n$$ \\lambda_{\\pm} = 1 - \\frac{1}{2}(\\omega \\Delta t)^2 \\pm (\\omega \\Delta t) \\sqrt{\\frac{1}{4}(\\omega \\Delta t)^2 - 1} $$\n考虑特征值 $\\lambda_{-}$。由于 $\\omega \\Delta t > 2$，项 $1 - \\frac{1}{2}(\\omega \\Delta t)^2$ 小于 $1 - \\frac{1}{2}(4) = -1$。第二项也是负的。因此，$\\lambda_{-}  -1$，且 $|\\lambda_{-}| > 1$。\n谱半径 $\\rho(M)$ 大于 $1$，积分是不稳定的。\n\n稳定性边界恰好在 $\\omega \\Delta t = 2$。因此，线性稳定性的条件是 $\\omega \\Delta t \\le 2$。最大稳定时间步长为：\n$$ \\Delta t_{\\text{max}} = \\frac{2}{\\omega} $$\n这对应于每个振荡周期 $T = 2\\pi/\\omega$ 大约有 $3$ 个积分步长，因为 $ T / \\Delta t_{\\text{max}} = \\pi \\approx 3.14$。\n\n**第三部分：离散频率、相位误差及其影响**\n\n在稳定区域，特征值为 $\\lambda_{\\pm} = \\exp(\\pm i \\Omega \\Delta t)$，其中 $\\Omega$ 是离散（数值）频率。矩阵的迹为 $\\text{Tr}(M) = \\lambda_{+} + \\lambda_{-} = 2 \\cos(\\Omega \\Delta t)$。从我们的矩阵 $M$ 可知，$\\text{Tr}(M) = 2 \\left(1 - \\frac{1}{2}(\\omega \\Delta t)^2\\right)$。令二者相等，得到：\n$$ 2 \\cos(\\Omega \\Delta t) = 2 - (\\omega \\Delta t)^2 $$\n$$ \\cos(\\Omega \\Delta t) = 1 - \\frac{1}{2}(\\omega \\Delta t)^2 $$\n这个方程隐式地定义了 $\\Omega$。对于小的 $\\Delta t$，我们可以找到领头阶误差。我们使用 $\\cos(\\theta) = 1 - \\theta^2/2! + \\theta^4/4! - \\dots$ 的泰勒级数。设 $\\theta = \\Omega \\Delta t$ 且 $z = \\omega \\Delta t$。\n$$ 1 - \\frac{(\\Omega \\Delta t)^2}{2} + \\frac{(\\Omega \\Delta t)^4}{24} - \\dots = 1 - \\frac{(\\omega \\Delta t)^2}{2} $$\n假设对于小的 $\\Delta t$，$\\Omega \\approx \\omega$，我们可以在一阶修正项中近似 $(\\Omega \\Delta t)^4 \\approx (\\omega \\Delta t)^4$：\n$$ \\frac{(\\Omega \\Delta t)^2}{2} \\approx \\frac{(\\omega \\Delta t)^2}{2} + \\frac{(\\omega \\Delta t)^4}{24} $$\n$$ \\Omega^2 \\approx \\omega^2 \\left(1 + \\frac{(\\omega \\Delta t)^2}{12}\\right) $$\n$$ \\Omega \\approx \\omega \\sqrt{1 + \\frac{(\\omega \\Delta t)^2}{12}} \\approx \\omega \\left(1 + \\frac{(\\omega \\Delta t)^2}{24}\\right) $$\n领头阶相对相位误差为 $(\\Omega - \\omega) / \\omega = (\\omega \\Delta t)^2 / 24$。这是一个相位超前，意味着数值振荡器比真实振荡器稍快。\n\n稳定性边界和准确性具有重要意义。速度-Verlet算法是辛算法，这意味着在稳定区域内的任何 $\\Delta t$，数值轨迹都能精确地守恒一个“影子哈密顿量” $H_{\\text{shadow}}$，该哈密顿量与真实的哈密顿量 $H$ 很接近。误差为 $H_{\\text{shadow}} - H = O((\\Delta t)^2)$。这确保了优异的长期能量守恒（无漂移），真实能量 $H$ 仅有有界振荡。\n然而，构型抽样的准确性要求 $H_{\\text{shadow}}$ 是 $H$ 的一个良好近似，这仅在 $\\Delta t \\ll \\Delta t_{\\text{max}}$ 时成立。当 $\\Delta t$ 接近稳定性极限 $2/\\omega$ 时，相位误差变大，轨迹会显著偏离真实动力学，尽管它仍停留在受扰动（影子）的恒定能量面上。对于计算静态属性，这可能是可以容忍的，但对于时间依赖的属性，这种相位误差会引入显著的不准确性。\n\n**第四部分：与蒙特卡洛方法的比较**\n\n对同一谐振子系统进行的 Metropolis 蒙特卡洛 (MC) 模拟，旨在生成一个遵循玻尔兹曼分布 $P(x) \\propto \\exp(-U(x)/k_B T)$ 的位置序列 $x$。提出一个试探移动，$x_{\\text{trial}} = x_{\\text{old}} + \\delta$，其中 $\\delta$ 是一个随机位移。该移动以概率 $p_{\\text{acc}} = \\min(1, \\exp(-\\Delta U/k_B T))$ 被接受。\n\n该过程与MD的线性稳定性限制没有类似之处，原因如下：\n1.  **随机与确定性动力学：** MD 积分的是一个确定性的运动方程。大的时间步长会导致离散化误差灾难性地放大，从而导致不稳定。MC 生成的是一个随机的马尔可夫链。没有会变得不稳定的“动力学”过程。\n2.  **内置稳定机制：** 接受判据 $\\min(1, \\exp(-\\Delta U/k_B T))$ 内在地防止系统“爆炸”。一个非常大的提议步长 $\\delta$ 很可能会导致一个大的正能量变化 $\\Delta U$，使得接受概率 $\\exp(-\\Delta U/k_B T)$ 趋近于零。系统将简单地拒绝该移动并保持在当前有限能量的状态。不存在能量无限增长的机制。\n\nMC 中的提议步长大小不影响稳定性，但深刻影响**效率**。\n-   如果提议步长太小，几乎所有的移动都被接受，但系统探索构型空间的速度非常慢（连续状态之间存在高度相关性）。\n-   如果提议步长太大，几乎所有的移动都被拒绝，系统探索构型空间的速度也非常慢（它会停留在同一个状态）。\nMC 模拟的效率通过调整提议步长以达到一个适中的接受率（通常在 $20-50\\%$ 范围内）来优化，这最大化了状态的去相关速率，并允许快速探索相空间。这通过减少计算平均值的统计误差，影响了有限长度模拟的实际“准确性”。", "answer": "$$\\boxed{\\frac{2}{\\omega}}$$", "id": "3403189"}, {"introduction": "## 蒙特卡洛中的效率：探索接受准则的奥秘\n\n与MD的确定性路径不同，蒙特卡洛方法通过随机抽样探索构型空间，其效率并非由积分稳定性决定，而是由其核心的概率法则——接受准则——巧妙地控制。本练习将深入MC算法的心脏，通过对比标准的Metropolis-Hastings准则和Barker准则，揭示接受概率的不同数学形式如何深刻影响采样效率 ([@problem_id:3403184])。这个分析将阐明为什么Metropolis准则在小步长极限下更具优势，这对于高维系统中的高效采样至关重要。", "problem": "考虑一个一维马尔可夫链蒙特卡洛方案，其设计用于在逆温度 $\\beta=1$下对正则高斯目标密度 $\\pi(x) \\propto \\exp(-x^{2}/2)$ 进行采样。从稳态出发，提出 $y = x + \\sigma z$，其中 $\\sigma > 0$ 是一个小步长，而 $z \\sim \\mathcal{N}(0,1)$ 独立于 $x$。比较对于同一对称提议的以下两种接受准则：\n- Metropolis–Hastings (MH): $\\alpha_{\\mathrm{M}}(x,y) = \\min\\{1, \\pi(y)/\\pi(x)\\}$。\n- Barker: $\\alpha_{\\mathrm{B}}(x,y) = \\pi(y)\\big/(\\pi(x) + \\pi(y))$。\n\n将给定接受准则 $\\alpha$ 的期望平方跳跃距离 (ESJD) 定义为\n$$\n\\mathrm{ESJD}(\\sigma;\\alpha) \\equiv \\mathbb{E}_{x \\sim \\pi,\\, z \\sim \\mathcal{N}(0,1)}\\Big[\\, (y-x)^{2}\\, \\alpha(x,y) \\,\\Big],\n$$\n其中 $y = x + \\sigma z$ 如上所述。作为小步长区域 $\\sigma \\to 0$ 中渐近效率的度量，假设展开式为\n$$\n\\mathrm{ESJD}(\\sigma;\\alpha) = C(\\alpha)\\,\\sigma^{2} + o(\\sigma^{2}),\n$$\n并称 $C(\\alpha)$ 为主阶效率常数。\n\n从第一性原理（提议的对称性、接受/拒绝准则的细致平衡形式以及高斯目标的基本性质）出发，推导目标 $\\pi(x) \\propto \\exp(-x^{2}/2)$ 的 $C(\\alpha_{\\mathrm{M}})$ 和 $C(\\alpha_{\\mathrm{B}})$，并由此确定比率\n$$\n\\rho \\equiv \\frac{C(\\alpha_{\\mathrm{B}})}{C(\\alpha_{\\mathrm{M}})}.\n$$\n将 $\\rho$ 的值作为你的最终答案报告。\n\n最后，利用你的推导，简要解释为什么在高维分子模拟相关的小步长区域中，Barker 准则可能劣于 Metropolis–Hastings 准则，即使 Barker 接受率是对数密度差的更平滑函数。你的解释应该是定性的，但你报告的最终答案必须是 $\\rho$ 的单一值。", "solution": "该问题要求在小步长极限下，比较一维马尔可夫链蒙特卡洛方案中的 Metropolis-Hastings (MH) 和 Barker 接受准则。效率通过期望平方跳跃距离 (ESJD) 来衡量。\n\n首先，我们对问题陈述进行验证。\n\n**第1步：提取已知条件**\n- 目标概率密度：$\\pi(x) \\propto \\exp(-x^{2}/2)$。这是一个标准正态分布。\n- 提议机制：从状态 $x$ 出发，提议一个新状态 $y = x + \\sigma z$，其中 $\\sigma > 0$ 是步长，$z \\sim \\mathcal{N}(0,1)$ 是一个标准正态随机变量。提议密度 $q(y|x)$ 是对称的，即 $q(y|x) = q(x|y)$。\n- Metropolis-Hastings 接受准则：$\\alpha_{\\mathrm{M}}(x,y) = \\min\\{1, \\pi(y)/\\pi(x)\\}$。\n- Barker 接受准则：$\\alpha_{\\mathrm{B}}(x,y) = \\pi(y)/(\\pi(x) + \\pi(y))$。\n- 期望平方跳跃距离 (ESJD) 的定义：$\\mathrm{ESJD}(\\sigma;\\alpha) \\equiv \\mathbb{E}_{x \\sim \\pi,\\, z \\sim \\mathcal{N}(0,1)}\\Big[\\, (y-x)^{2}\\, \\alpha(x,y) \\,\\Big]$。\n- ESJD 的渐近行为：对于小 $\\sigma$，$\\mathrm{ESJD}(\\sigma;\\alpha) = C(\\alpha)\\,\\sigma^{2} + o(\\sigma^{2})$。\n- 任务是求出比率 $\\rho \\equiv C(\\alpha_{\\mathrm{B}})/C(\\alpha_{\\mathrm{M}})$ 并对结果提供定性解释。\n\n**第2步：使用提取的已知条件进行验证**\n该问题具有科学依据，涉及计算统计力学（MCMC方法）和概率论中的基本概念。问题定义明确，提供了所有必要的定义和充分的信息，以推导出比率 $\\rho$ 的唯一、有意义的答案。语言客观且数学上精确。设置是自洽和一致的。不存在问题验证标准中列出的任何缺陷。\n\n**第3步：结论与行动**\n问题有效。我们继续进行推导。\n\n期望平方跳跃距离定义为：\n$$\n\\mathrm{ESJD}(\\sigma;\\alpha) = \\mathbb{E}_{x \\sim \\pi,\\, z \\sim \\mathcal{N}(0,1)}\\Big[\\, (y-x)^{2}\\, \\alpha(x,y) \\,\\Big]\n$$\n代入提议 $y = x + \\sigma z$，平方跳跃距离变为 $(y-x)^2 = (\\sigma z)^2 = \\sigma^2 z^2$。因此，ESJD 可以重写为：\n$$\n\\mathrm{ESJD}(\\sigma;\\alpha) = \\mathbb{E}_{x \\sim \\pi,\\, z \\sim \\mathcal{N}(0,1)}\\Big[\\, \\sigma^2 z^2 \\alpha(x, x+\\sigma z) \\,\\Big]\n$$\n由于 $\\sigma^2$ 相对于期望是常数，我们可以将其提出：\n$$\n\\mathrm{ESJD}(\\sigma;\\alpha) = \\sigma^2 \\mathbb{E}_{x \\sim \\pi,\\, z \\sim \\mathcal{N}(0,1)}\\Big[\\, z^2 \\alpha(x, x+\\sigma z) \\,\\Big]\n$$\n问题指出，对于小 $\\sigma$，ESJD 具有展开式 $\\mathrm{ESJD}(\\sigma;\\alpha) = C(\\alpha)\\sigma^2 + o(\\sigma^2)$。因此，主阶效率常数 $C(\\alpha)$ 由以下极限给出：\n$$\nC(\\alpha) = \\lim_{\\sigma \\to 0} \\frac{\\mathrm{ESJD}(\\sigma;\\alpha)}{\\sigma^2} = \\lim_{\\sigma \\to 0} \\mathbb{E}_{x \\sim \\pi,\\, z \\sim \\mathcal{N}(0,1)}\\Big[\\, z^2 \\alpha(x, x+\\sigma z) \\,\\Big]\n$$\n为计算此极限，我们可以使用控制收敛定理。令 $f_{\\sigma}(x,z) = z^2 \\alpha(x, x+\\sigma z)$。接受概率 $\\alpha(x,y)$ 必须在区间 $[0,1]$ 内。因此，函数 $f_{\\sigma}(x,z)$ 受一个可积函数 $g(x,z) = z^2$ 的约束：\n$$\n|f_{\\sigma}(x,z)| = |z^2 \\alpha(x, x+\\sigma z)| \\le z^2 = g(x,z)\n$$\n控制函数 $g(x,z)$ 的期望是有限的：\n$$\n\\mathbb{E}_{x,z}[g(x,z)] = \\mathbb{E}_{x,z}[z^2] = \\mathbb{E}_{x \\sim \\pi}[1] \\cdot \\mathbb{E}_{z \\sim \\mathcal{N}(0,1)}[z^2] = 1 \\cdot \\mathrm{Var}(z) = 1\n$$\n由于 $\\mathbb{E}[g(x,z)]  \\infty$，满足控制收敛定理的条件，我们可以交换极限和期望的顺序：\n$$\nC(\\alpha) = \\mathbb{E}_{x,z}\\Big[\\, \\lim_{\\sigma \\to 0} f_{\\sigma}(x,z) \\,\\Big] = \\mathbb{E}_{x,z}\\Big[\\, \\lim_{\\sigma \\to 0} z^2 \\alpha(x, x+\\sigma z) \\,\\Big] = \\mathbb{E}_{x,z}\\Big[\\, z^2 \\lim_{\\sigma \\to 0} \\alpha(x, x+\\sigma z) \\,\\Big]\n$$\n现在，我们必须计算当 $\\sigma \\to 0$ 时，每个准则的接受概率的极限。在此极限下，提议的状态 $y = x+\\sigma z$ 趋近于当前状态 $x$。由于目标密度 $\\pi(x)$ 是连续的，$\\pi(y) \\to \\pi(x)$。令 $r(x,y) = \\pi(y)/\\pi(x)$。那么，当 $\\sigma \\to 0$ 时，$r(x,y) \\to 1$。\n\n对于 Metropolis-Hastings 准则：\n$$\n\\alpha_{\\mathrm{M}}(x,y) = \\min\\{1, r(x,y)\\}\n$$\n取 $\\sigma \\to 0$ 的极限：\n$$\n\\lim_{\\sigma \\to 0} \\alpha_{\\mathrm{M}}(x, x+\\sigma z) = \\min\\{1, \\lim_{\\sigma \\to 0} r(x, x+\\sigma z)\\} = \\min\\{1, 1\\} = 1\n$$\n因此，Metropolis-Hastings 的效率常数为：\n$$\nC(\\alpha_{\\mathrm{M}}) = \\mathbb{E}_{x,z}[z^2 \\cdot 1] = \\mathbb{E}_{z \\sim \\mathcal{N}(0,1)}[z^2] = 1\n$$\n\n对于 Barker 准则：\n$$\n\\alpha_{\\mathrm{B}}(x,y) = \\frac{\\pi(y)}{\\pi(x) + \\pi(y)} = \\frac{r(x,y)}{1 + r(x,y)}\n$$\n取 $\\sigma \\to 0$ 的极限：\n$$\n\\lim_{\\sigma \\to 0} \\alpha_{\\mathrm{B}}(x, x+\\sigma z) = \\frac{\\lim_{\\sigma \\to 0} r(x, x+\\sigma z)}{1 + \\lim_{\\sigma \\to 0} r(x, x+\\sigma z)} = \\frac{1}{1+1} = \\frac{1}{2}\n$$\nBarker 准则的效率常数为：\n$$\nC(\\alpha_{\\mathrm{B}}) = \\mathbb{E}_{x,z}\\Big[z^2 \\cdot \\frac{1}{2}\\Big] = \\frac{1}{2} \\mathbb{E}_{z \\sim \\mathcal{N}(0,1)}[z^2] = \\frac{1}{2} \\cdot 1 = \\frac{1}{2}\n$$\n最后，我们计算比率 $\\rho$：\n$$\n\\rho = \\frac{C(\\alpha_{\\mathrm{B}})}{C(\\alpha_{\\mathrm{M}})} = \\frac{1/2}{1} = \\frac{1}{2}\n$$\n\n推导表明，在小步长极限下，Barker 采样器的渐近效率是 Metropolis-Hastings 采样器的一半。这可以通过它们各自接受准则的极限行为来解释。\n\n当 $\\sigma \\to 0$ 时，提议的移动 $y$ 变得无限接近于 $x$。Metropolis-Hastings 准则 $\\alpha_{\\mathrm{M}} = \\min\\{1, \\pi(y)/\\pi(x)\\}$ 以概率 $1$ 接受任何增加概率密度的移动（“上坡”移动，$\\pi(y) > \\pi(x)$）。对于无穷小的步长，几乎所有移动都导致比率 $\\pi(y)/\\pi(x)$ 非常接近 $1$。因此，MH 的接受概率趋近于 $1$。\n\n相比之下，Barker 准则 $\\alpha_{\\mathrm{B}} = \\pi(y)/(\\pi(x)+\\pi(y))$ 更对称地对待上坡和下坡移动。当 $y \\to x$ 时，比率 $\\pi(y)/\\pi(x) \\to 1$，接受概率 $\\alpha_{\\mathrm{B}} \\to 1/(1+1) = 1/2$。这意味着在小步长极限下，Barker 准则会拒绝大约一半的提议移动，无论它们是上坡还是下坡。\n\nESJD 是衡量采样器在状态空间中扩散速率的指标。通过几乎接受每一步小移动，MH 采样器在每一步都会移动。而通过拒绝一半的小移动，Barker 采样器实际上有一半的时间在“暂停”。这使其在该区域的有效探索率相较于 MH 减半。虽然 Barker 接受函数的光滑性在理论上可能很有吸引力，但 MH 准则在接受所有上坡移动方面的“贪婪”性质，导致其在小步长极限下表现更优，而这在高维模拟中是一个具有实际重要性的区域，因为在高维模拟中通常需要小步长来维持合理的总接受率。", "answer": "$$\n\\boxed{\\frac{1}{2}}\n$$", "id": "3403184"}, {"introduction": "## 实践中的对决：量化MD与MC的采样效率\n\n在理解了MD和MC各自的内在机制后，我们来解决一个终极的实践问题：对于一个给定的计算任务和预算，哪种方法更有效？本练习提供了一个定量评估的框架 ([@problem_id:3403222])。我们将利用积分自相关时间和有效样本量（Effective Sample Size）这两个强大的统计工具，来分析假设的模拟数据，从而在固定的计算成本下，严格比较MD和MC在产生统计独立样本方面的最终效率。", "problem": "一个标量可观测量 $A$ 在分子动力学 (MD) 轨迹和蒙特卡洛 (MC) 马尔可夫链的每一步中都被记录下来，这两种方法都对同一个正则系综进行采样。对于每种方法，长时间的引导性运行产生了延迟为 $k \\in \\{1,2,\\ldots\\}$ 的经验拟合归一化离散自相关函数，其形式如下\n$$\n\\rho^{\\mathrm{MD}}_{k} = p_{\\mathrm{MD}}\\, a_{\\mathrm{MD}}^{k} + \\left(1 - p_{\\mathrm{MD}}\\right)\\, b_{\\mathrm{MD}}^{k}, \\quad \\rho^{\\mathrm{MC}}_{k} = p_{\\mathrm{MC}}\\, a_{\\mathrm{MC}}^{k} + \\left(1 - p_{\\mathrm{MC}}\\right)\\, b_{\\mathrm{MC}}^{k},\n$$\n经验确定的参数为\n$$\np_{\\mathrm{MD}} = 0.6,\\quad a_{\\mathrm{MD}} = 0.85,\\quad b_{\\mathrm{MD}} = 0.30,\\qquad p_{\\mathrm{MC}} = 0.5,\\quad a_{\\mathrm{MC}} = 0.50,\\quad b_{\\mathrm{MC}} = 0.10.\n$$\n假设两个时间序列都是平稳和遍历的，采样在每一步记录一个值，并且积分自相关可以通过上述拟合所隐含的对所有延迟的无穷求和得到很好的近似。MD每步的计算成本为 $c_{\\mathrm{MD}} = 2.0 \\times 10^{-6}~\\mathrm{s}$，MC每步的计算成本为 $c_{\\mathrm{MC}} = 3.0 \\times 10^{-6}~\\mathrm{s}$。在固定的总计算时间预算 $W = 120~\\mathrm{s}$ 下，使用相关时间序列采样的基本原理来估计预算 $W$ 内的有效样本量 $N_{\\mathrm{eff},\\mathrm{MD}}$ 和 $N_{\\mathrm{eff},\\mathrm{MC}}$，然后计算效率比 $R = N_{\\mathrm{eff},\\mathrm{MD}} / N_{\\mathrm{eff},\\mathrm{MC}}$。将 $R$ 的最终数值四舍五入到四位有效数字，并将其表示为一个无量纲数。", "solution": "该问题要求计算在固定的总计算时间预算 $W$ 下运行的分子动力学 (MD) 和蒙特卡洛 (MC) 模拟的有效样本量之比，$R = N_{\\mathrm{eff},\\mathrm{MD}} / N_{\\mathrm{eff},\\mathrm{MC}}$。\n\n分析始于长度为 $N$ 的平稳遍历时间序列的有效样本量 $N_{\\mathrm{eff}}$ 的基本概念。由于样本之间的序列相关性，有效独立样本的数量会减少。这通过积分自相关时间 $\\tau_{\\mathrm{int}}$ 来量化，使得：\n$$\nN_{\\mathrm{eff}} = \\frac{N}{\\tau_{\\mathrm{int}}}\n$$\n积分自相关时间由延迟为 $k$ 的离散归一化自相关函数 $\\rho_k$ 定义为：\n$$\n\\tau_{\\mathrm{int}} = 1 + 2 \\sum_{k=1}^{\\infty} \\rho_k\n$$\n问题给出了MD和MC方法中 $\\rho_k$ 的函数形式，这使我们能够计算它们各自的积分自相关时间。\n\n首先，我们计算 $\\tau_{\\mathrm{int,MD}}$。自相关函数由下式给出：\n$$\n\\rho^{\\mathrm{MD}}_{k} = p_{\\mathrm{MD}}\\, a_{\\mathrm{MD}}^{k} + \\left(1 - p_{\\mathrm{MD}}\\right)\\, b_{\\mathrm{MD}}^{k}\n$$\n这个无穷和是两个几何级数的和。对于公比为 $r$ 且 $|r|  1$ 的几何级数，从 $k=1$ 到无穷大的和为 $\\sum_{k=1}^{\\infty} r^k = \\frac{r}{1-r}$。\n$$\n\\sum_{k=1}^{\\infty} \\rho^{\\mathrm{MD}}_{k} = \\sum_{k=1}^{\\infty} \\left[ p_{\\mathrm{MD}}\\, a_{\\mathrm{MD}}^{k} + \\left(1 - p_{\\mathrm{MD}}\\right)\\, b_{\\mathrm{MD}}^{k} \\right] = p_{\\mathrm{MD}} \\left( \\sum_{k=1}^{\\infty} a_{\\mathrm{MD}}^{k} \\right) + \\left(1 - p_{\\mathrm{MD}}\\right) \\left( \\sum_{k=1}^{\\infty} b_{\\mathrm{MD}}^{k} \\right)\n$$\n$$\n\\sum_{k=1}^{\\infty} \\rho^{\\mathrm{MD}}_{k} = p_{\\mathrm{MD}} \\frac{a_{\\mathrm{MD}}}{1 - a_{\\mathrm{MD}}} + \\left(1 - p_{\\mathrm{MD}}\\right) \\frac{b_{\\mathrm{MD}}}{1 - b_{\\mathrm{MD}}}\n$$\n代入给定的MD参数（$p_{\\mathrm{MD}} = 0.6$，$a_{\\mathrm{MD}} = 0.85$，$b_{\\mathrm{MD}} = 0.30$）：\n$$\n\\sum_{k=1}^{\\infty} \\rho^{\\mathrm{MD}}_{k} = (0.6) \\frac{0.85}{1 - 0.85} + (1 - 0.6) \\frac{0.30}{1 - 0.30} = (0.6) \\frac{0.85}{0.15} + (0.4) \\frac{0.30}{0.70}\n$$\n$$\n\\sum_{k=1}^{\\infty} \\rho^{\\mathrm{MD}}_{k} = (0.6) \\left(\\frac{17}{3}\\right) + (0.4) \\left(\\frac{3}{7}\\right) = \\frac{3}{5} \\cdot \\frac{17}{3} + \\frac{2}{5} \\cdot \\frac{3}{7} = \\frac{17}{5} + \\frac{6}{35} = \\frac{119}{35} + \\frac{6}{35} = \\frac{125}{35} = \\frac{25}{7}\n$$\n现在，我们求MD的积分自相关时间：\n$$\n\\tau_{\\mathrm{int,MD}} = 1 + 2 \\sum_{k=1}^{\\infty} \\rho^{\\mathrm{MD}}_{k} = 1 + 2 \\left(\\frac{25}{7}\\right) = 1 + \\frac{50}{7} = \\frac{7+50}{7} = \\frac{57}{7}\n$$\n\n接下来，我们对MC方法进行相同的计算。自相关函数为：\n$$\n\\rho^{\\mathrm{MC}}_{k} = p_{\\mathrm{MC}}\\, a_{\\mathrm{MC}}^{k} + \\left(1 - p_{\\mathrm{MC}}\\right)\\, b_{\\mathrm{MC}}^{k}\n$$\n代入MC的参数（$p_{\\mathrm{MC}} = 0.5$，$a_{\\mathrm{MC}} = 0.50$，$b_{\\mathrm{MC}} = 0.10$）：\n$$\n\\sum_{k=1}^{\\infty} \\rho^{\\mathrm{MC}}_{k} = p_{\\mathrm{MC}} \\frac{a_{\\mathrm{MC}}}{1 - a_{\\mathrm{MC}}} + \\left(1 - p_{\\mathrm{MC}}\\right) \\frac{b_{\\mathrm{MC}}}{1 - b_{\\mathrm{MC}}} = (0.5) \\frac{0.50}{1 - 0.50} + (1 - 0.5) \\frac{0.10}{1 - 0.10}\n$$\n$$\n\\sum_{k=1}^{\\infty} \\rho^{\\mathrm{MC}}_{k} = (0.5) \\frac{0.5}{0.5} + (0.5) \\frac{0.1}{0.9} = (0.5)(1) + (0.5)\\left(\\frac{1}{9}\\right) = \\frac{1}{2}\\left(1 + \\frac{1}{9}\\right) = \\frac{1}{2}\\left(\\frac{10}{9}\\right) = \\frac{5}{9}\n$$\nMC的积分自相关时间为：\n$$\n\\tau_{\\mathrm{int,MC}} = 1 + 2 \\sum_{k=1}^{\\infty} \\rho^{\\mathrm{MC}}_{k} = 1 + 2 \\left(\\frac{5}{9}\\right) = 1 + \\frac{10}{9} = \\frac{9+10}{9} = \\frac{19}{9}\n$$\n在总计算时间预算 $W$ 内，以每步成本 $c$ 可以执行的总步数 $N$ 为 $N = W/c$。\n因此，对于MD，有 $N_{\\mathrm{MD}} = W/c_{\\mathrm{MD}}$；对于MC，有 $N_{\\mathrm{MC}} = W/c_{\\mathrm{MC}}$。\n\n那么有效样本量为：\n$$\nN_{\\mathrm{eff,MD}} = \\frac{N_{\\mathrm{MD}}}{\\tau_{\\mathrm{int,MD}}} = \\frac{W/c_{\\mathrm{MD}}}{\\tau_{\\mathrm{int,MD}}} = \\frac{W}{c_{\\mathrm{MD}} \\tau_{\\mathrm{int,MD}}}\n$$\n$$\nN_{\\mathrm{eff,MC}} = \\frac{N_{\\mathrm{MC}}}{\\tau_{\\mathrm{int,MC}}} = \\frac{W/c_{\\mathrm{MC}}}{\\tau_{\\mathrm{int,MC}}} = \\frac{W}{c_{\\mathrm{MC}} \\tau_{\\mathrm{int,MC}}}\n$$\n效率比 $R$ 是这些有效样本量之比：\n$$\nR = \\frac{N_{\\mathrm{eff,MD}}}{N_{\\mathrm{eff,MC}}} = \\frac{W / (c_{\\mathrm{MD}} \\tau_{\\mathrm{int,MD}})}{W / (c_{\\mathrm{MC}} \\tau_{\\mathrm{int,MC}})} = \\frac{c_{\\mathrm{MC}} \\tau_{\\mathrm{int,MC}}}{c_{\\mathrm{MD}} \\tau_{\\mathrm{int,MD}}}\n$$\n总预算 $W$ 被消掉，因为只要模拟时间足够长，效率之比就与总模拟时间无关。\n我们代入给定的每步成本 $c_{\\mathrm{MD}} = 2.0 \\times 10^{-6}~\\mathrm{s}$ 和 $c_{\\mathrm{MC}} = 3.0 \\times 10^{-6}~\\mathrm{s}$，以及我们计算出的 $\\tau_{\\mathrm{int}}$ 值：\n$$\nR = \\frac{(3.0 \\times 10^{-6}) \\left(\\frac{19}{9}\\right)}{(2.0 \\times 10^{-6}) \\left(\\frac{57}{7}\\right)} = \\frac{3 \\cdot \\frac{19}{9}}{2 \\cdot \\frac{57}{7}} = \\frac{\\frac{19}{3}}{\\frac{114}{7}}\n$$\n由于 $114 = 6 \\times 19$，我们可以简化表达式：\n$$\nR = \\frac{19}{3} \\cdot \\frac{7}{114} = \\frac{19}{3} \\cdot \\frac{7}{6 \\cdot 19} = \\frac{7}{3 \\cdot 6} = \\frac{7}{18}\n$$\n为了给出数值答案，我们计算其十进制值并四舍五入到四位有效数字：\n$$\nR = \\frac{7}{18} \\approx 0.388888... \\approx 0.3889\n$$\n这一结果表明，对于给定的可观测量和系统，在固定的时间预算下，MC模拟在生成独立样本方面的效率比MD模拟高，效率大约是MD的 $1/R \\approx 2.57$ 倍。", "answer": "$$\n\\boxed{0.3889}\n$$", "id": "3403222"}]}