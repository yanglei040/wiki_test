{"hands_on_practices": [{"introduction": "在构建复杂的数值模拟之前，理解控制无碰撞系统平衡的解析关系至关重要。本练习使用从弗拉索夫方程（Vlasov equation）推导出的金斯方程（Jeans equations），将系统的质量分布与其内部运动联系起来 [@problem_id:3518280]。通过将此框架应用于经典的普卢默模型（Plummer model），您将推导出速度弥散剖面，从而亲身体验分析星系和星团结构的基本工具。", "problem": "考虑一个自引力、无碰撞的恒星系统，该系统由单粒子分布函数 $f(\\mathbf{x},\\mathbf{v},t)$ 描述，并在 Vlasov–Poisson 系统下演化，即无碰撞玻尔兹曼方程 (CBE) 与泊松方程耦合。CBE 为\n$$\n\\frac{\\partial f}{\\partial t}+\\mathbf{v}\\cdot\\nabla_{\\mathbf{x}} f-\\nabla_{\\mathbf{x}}\\Phi\\cdot\\nabla_{\\mathbf{v}} f=0,\n$$\n泊松方程为\n$$\n\\nabla^{2}\\Phi=4\\pi G\\rho,\\qquad \\rho(\\mathbf{x})=\\int f(\\mathbf{x},\\mathbf{v},t)\\,d^{3}\\mathbf{v}.\n$$\n假设系统处于稳态 ($\\partial/\\partial t=0$)、球对称且无旋转。令 $\\rho(r)$ 为质量密度，速度各向异性参数定义为\n$$\n\\beta(r)\\equiv 1-\\frac{\\sigma_{\\theta}^{2}(r)+\\sigma_{\\phi}^{2}(r)}{2\\,\\sigma_{r}^{2}(r)},\n$$\n其中 $\\sigma_{r}^{2}$、$\\sigma_{\\theta}^{2}$ 和 $\\sigma_{\\phi}^{2}$ 是球坐标方向上的速度弥散。您可以假设各向异性为常数，并且将专门研究各向同性情况 $\\beta=0$。施加具有物理动机的边界条件，即当 $\\,r\\to\\infty\\,$ 时，$\\,\\rho(r)\\,\\sigma_{r}^{2}(r)\\to 0\\,$。\n\n在球对称条件下，对 CBE 取一阶速度矩，以获得常数 $\\beta$ 的径向 Jeans 关系，然后专门研究各向同性情况 $\\beta=0$。利用该结果，考虑一个总质量为 $M$、标长为 $a$ 的自洽 Plummer 模型，其密度和引力势为\n$$\n\\rho(r)=\\frac{3M}{4\\pi a^{3}}\\left(1+\\frac{r^{2}}{a^{2}}\\right)^{-5/2},\\qquad \\Phi(r)=-\\frac{GM}{\\sqrt{r^{2}+a^{2}}}.\n$$\n计算所得的各向同性径向速度弥散剖面 $\\sigma_{r}^{2}(r)$，以 $G$、$M$、$a$ 和 $r$ 的闭式解析表达式表示。将您的最终答案表示为单个解析表达式。无需进行数值计算。", "solution": "该问题要求推导自洽、各向同性的 Plummer 模型的径向速度弥散剖面 $\\sigma_{r}^{2}(r)$。推导过程分两个主要阶段：首先，从无碰撞玻尔兹曼方程 (CBE) 得到相应的 Jeans 方程；其次，针对给定的 Plummer 密度和引力势剖面求解该方程。\n\n起点是稳态 CBE，对于分布函数 $f(\\mathbf{x}, \\mathbf{v})$ 和引力势 $\\Phi(\\mathbf{x})$，其形式为：\n$$\n\\mathbf{v}\\cdot\\nabla_{\\mathbf{x}} f - \\nabla_{\\mathbf{x}}\\Phi\\cdot\\nabla_{\\mathbf{v}} f = 0\n$$\n为获得 Jeans 方程，我们对 CBE 取一阶速度矩。这包括乘以速度分量 $v_k$ 并对所有速度 $d^3\\mathbf{v}$ 进行积分：\n$$\n\\int v_k (\\mathbf{v}\\cdot\\nabla_{\\mathbf{x}} f) \\,d^3\\mathbf{v} - \\int v_k (\\nabla_{\\mathbf{x}}\\Phi\\cdot\\nabla_{\\mathbf{v}} f) \\,d^3\\mathbf{v} = 0\n$$\n使用求和约定，以分量形式写出：\n$$\n\\int v_k v_j \\frac{\\partial f}{\\partial x_j} \\,d^3\\mathbf{v} - \\int v_k \\frac{\\partial \\Phi}{\\partial x_j} \\frac{\\partial f}{\\partial v_j} \\,d^3\\mathbf{v} = 0\n$$\n第一项可以写成 $\\frac{\\partial}{\\partial x_j} \\int v_k v_j f \\,d^3\\mathbf{v}$。令质量密度为 $\\rho = \\int f d^3\\mathbf{v}$，平均速度为 $\\langle v_i \\rangle = \\frac{1}{\\rho} \\int v_i f d^3\\mathbf{v}$。速度弥散张量为 $\\sigma_{jk}^2 = \\langle (v_j - \\langle v_j \\rangle)(v_k - \\langle v_k \\rangle) \\rangle = \\langle v_j v_k \\rangle - \\langle v_j \\rangle \\langle v_k \\rangle$。对于稳态下的无旋转系统，平均速度为零，因此对所有 $i$ 都有 $\\langle v_i \\rangle = 0$。于是，$\\int v_j v_k f d^3\\mathbf{v} = \\rho \\langle v_j v_k \\rangle = \\rho \\sigma_{jk}^2$。第一项变为 $\\frac{\\partial}{\\partial x_j}(\\rho \\sigma_{jk}^2)$。\n\n对于第二项，我们对速度变量 $v_j$ 进行分部积分：\n$$\n-\\frac{\\partial \\Phi}{\\partial x_j} \\int v_k \\frac{\\partial f}{\\partial v_j} \\,d^3\\mathbf{v} = -\\frac{\\partial \\Phi}{\\partial x_j} \\left( [v_k f]_{v_j\\to\\pm\\infty} - \\int f \\frac{\\partial v_k}{\\partial v_j} \\,d^3\\mathbf{v} \\right)\n$$\n边界项 $[v_k f]$ 在无穷大速度时为零，因为没有恒星具有无穷大速度。导数 $\\frac{\\partial v_k}{\\partial v_j}$ 是 Kronecker δ函数, $\\delta_{kj}$。积分变为 $\\int f \\delta_{kj} d^3\\mathbf{v} = \\delta_{kj} \\rho$。因此，第二项简化为 $\\frac{\\partial \\Phi}{\\partial x_j} \\delta_{kj} \\rho = \\rho \\frac{\\partial \\Phi}{\\partial x_k}$。\n\n合并各项，我们得到 Jeans 方程的张量形式：\n$$\n\\frac{\\partial}{\\partial x_j}(\\rho \\sigma_{jk}^2) + \\rho \\frac{\\partial \\Phi}{\\partial x_k} = 0\n$$\n对于球对称系统，很自然地在球坐标 $(r, \\theta, \\phi)$ 中进行处理。在该坐标系中，如果坐标轴与坐标对齐，速度弥散张量是对角的，即当 $i \\neq j$ 时 $\\sigma_{ij}^2 = 0$。由于球对称性，我们有 $\\sigma_{\\theta}^2 = \\sigma_{\\phi}^2$。取 Jeans 方程的径向 ($k=r$) 分量可得：\n$$\n\\frac{d}{dr}(\\rho \\sigma_r^2) + \\frac{2}{r}\\rho \\sigma_r^2 - \\frac{1}{r}\\rho(\\sigma_\\theta^2+\\sigma_\\phi^2) + \\rho \\frac{d\\Phi}{dr} = 0\n$$\n这可以重排为：\n$$\n\\frac{d(\\rho \\sigma_r^2)}{dr} + \\frac{\\rho}{r} [2\\sigma_r^2 - (\\sigma_\\theta^2+\\sigma_\\phi^2)] = -\\rho \\frac{d\\Phi}{dr}\n$$\n引入速度各向异性参数 $\\beta(r) = 1 - \\frac{\\sigma_\\theta^2+\\sigma_\\phi^2}{2\\sigma_r^2}$，方括号中的项变为 $2\\sigma_r^2 \\beta(r)$。方程简化为：\n$$\n\\frac{d(\\rho \\sigma_r^2)}{dr} + \\frac{2\\beta}{r}(\\rho \\sigma_r^2) = -\\rho \\frac{d\\Phi}{dr}\n$$\n问题指定了常数各向异性参数 $\\beta$，然后要求专门研究各向同性情况，即 $\\beta=0$。对于 $\\beta=0$，方程变为：\n$$\n\\frac{d}{dr}(\\rho \\sigma_r^2) = -\\rho \\frac{d\\Phi}{dr}\n$$\n在各向同性情况下，$\\sigma_r^2 = \\sigma_\\theta^2 = \\sigma_\\phi^2$，我们可以将共同的速度弥散表示为 $\\sigma^2(r) = \\sigma_r^2(r)$。\n我们将此方程从半径 $r$ 积分到无穷大：\n$$\n\\int_r^\\infty \\frac{d}{ds}(\\rho(s) \\sigma^2(s)) \\,ds = -\\int_r^\\infty \\rho(s) \\frac{d\\Phi(s)}{ds} \\,ds\n$$\n$$\n[\\rho(s) \\sigma^2(s)]_r^\\infty = -\\int_r^\\infty \\rho(s) \\frac{d\\Phi(s)}{ds} \\,ds\n$$\n应用边界条件 $\\rho(r)\\sigma^2(r) \\to 0$ as $r \\to \\infty$，左侧的上限为零。\n$$\n-\\rho(r) \\sigma^2(r) = -\\int_r^\\infty \\rho(s) \\frac{d\\Phi(s)}{ds} \\,ds\n$$\n求解 $\\sigma^2(r)$，在各向同性情况下它等价于 $\\sigma_r^2(r)$：\n$$\n\\sigma_r^2(r) = \\frac{1}{\\rho(r)} \\int_r^\\infty \\rho(s) \\frac{d\\Phi(s)}{ds} \\,ds\n$$\n现在，我们代入 Plummer 模型的密度 $\\rho(r)$ 和引力势 $\\Phi(r)$ 的表达式：\n$$\n\\rho(r) = \\frac{3M}{4\\pi a^3} \\left(1+\\frac{r^2}{a^2}\\right)^{-5/2} = \\frac{3Ma^2}{4\\pi} (r^2+a^2)^{-5/2}\n$$\n$$\n\\Phi(r) = -\\frac{GM}{\\sqrt{r^2+a^2}} = -GM(r^2+a^2)^{-1/2}\n$$\n首先，我们计算引力势对径向坐标的导数：\n$$\n\\frac{d\\Phi}{dr} = -GM \\left(-\\frac{1}{2}\\right) (r^2+a^2)^{-3/2} (2r) = \\frac{GMr}{(r^2+a^2)^{3/2}}\n$$\n被积函数为 $\\rho(s) \\frac{d\\Phi(s)}{ds}$：\n$$\n\\rho(s) \\frac{d\\Phi(s)}{ds} = \\left( \\frac{3Ma^2}{4\\pi} (s^2+a^2)^{-5/2} \\right) \\left( \\frac{GMs}{(s^2+a^2)^{3/2}} \\right) = \\frac{3G M^2 a^2}{4\\pi} s(s^2+a^2)^{-4}\n$$\n现在我们计算从 $r$ 到 $\\infty$ 的积分：\n$$\n\\int_r^\\infty \\rho(s) \\frac{d\\Phi(s)}{ds} \\,ds = \\frac{3G M^2 a^2}{4\\pi} \\int_r^\\infty s(s^2+a^2)^{-4} \\,ds\n$$\n令 $u = s^2+a^2$，则 $du = 2s\\,ds$。积分限从 $s=r$ 变为 $u=r^2+a^2$，从 $s\\to\\infty$ 变为 $u\\to\\infty$。\n$$\n\\frac{3G M^2 a^2}{4\\pi} \\int_{r^2+a^2}^\\infty u^{-4} \\frac{du}{2} = \\frac{3G M^2 a^2}{8\\pi} \\left[ \\frac{u^{-3}}{-3} \\right]_{r^2+a^2}^\\infty\n$$\n$$\n= \\frac{3G M^2 a^2}{8\\pi} \\left( 0 - \\frac{(r^2+a^2)^{-3}}{-3} \\right) = \\frac{G M^2 a^2}{8\\pi} (r^2+a^2)^{-3}\n$$\n最后，我们将此结果除以 $\\rho(r)$ 来求得 $\\sigma_r^2(r)$：\n$$\n\\sigma_r^2(r) = \\frac{\\frac{G M^2 a^2}{8\\pi} (r^2+a^2)^{-3}}{\\frac{3Ma^2}{4\\pi} (r^2+a^2)^{-5/2}}\n$$\n我们通过消去项来化简表达式：\n$$\n\\sigma_r^2(r) = \\left(\\frac{G M^2 a^2}{8\\pi}\\right) \\left(\\frac{4\\pi}{3Ma^2}\\right) (r^2+a^2)^{-3 - (-5/2)}\n$$\n$$\n\\sigma_r^2(r) = \\frac{GM}{6} (r^2+a^2)^{-3 + 5/2} = \\frac{GM}{6} (r^2+a^2)^{-1/2}\n$$\nPlummer 模型的各向同性径向速度弥散的最终闭式表达式为：\n$$\n\\sigma_r^2(r) = \\frac{GM}{6\\sqrt{r^2+a^2}}\n$$", "answer": "$$\\boxed{\\frac{GM}{6\\sqrt{r^2+a^2}}}$$", "id": "3518280"}, {"introduction": "N体方法是模拟无碰撞系统最常用的工具，它用有限数量的粒子来近似连续的相空间流体。然而，从连续到离散的转变并非没有代价，它会引入所谓的“离散噪声”或“散粒噪声”。本练习将探讨初始粒子排布策略如何直接影响这种数值噪声 [@problem_id:3518281]。通过比较不同的采样方法，您将理解设置高质量N体模拟的关键一步，并学会如何最小化虚假的初始涨落。", "problem": "构建一个程序，通过测量指定傅里叶模式下伪密度涨落的振幅，来量化不同粒子采样策略如何将一维周期性区域上的均匀无碰撞质量分布离散化。在一个长度为 $L=1$ 的无量纲周期性区间上进行操作。考虑一个由 $N$ 个等质量粒子表示的均匀质量密度，其位置为 $\\{x_i\\}_{i=1}^N$，且 $x_i \\in [0,L)$。定义在整数模式指数 $n \\in \\mathbb{Z}$ 下的离散密度衬比的复傅里叶振幅为\n$$\n\\delta_k(n) \\equiv \\frac{1}{N}\\sum_{i=1}^N \\exp\\!\\left(-\\mathrm{i}\\,k_n\\,x_i\\right),\\quad k_n \\equiv \\frac{2\\pi n}{L},\n$$\n并将模式 $n$ 下的测量功率定义为\n$$\nP_\\mathrm{meas}(n) \\equiv \\left|\\delta_k(n)\\right|^2.\n$$\n您必须实现三种粒子位置的采样策略：\n\n- 泊松采样（独立同分布均匀采样）：从 $[0,L)$ 上的均匀分布中独立抽取 $x_i$。\n- 静态晶格采样（也称静态启动）：对于 $i \\in \\{1,2,\\dots,N\\}$，设置 $x_i = \\left(i-\\tfrac{1}{2}\\right)\\frac{L}{N}$。\n- 高斯位移抖动晶格采样：设置 $x_i = \\left(i-\\tfrac{1}{2}\\right)\\frac{L}{N} + \\varepsilon_i$，其中 $\\varepsilon_i$ 是独立的、均值为 $0$、方差为 $\\sigma^2$ 的高斯随机变量。\n\n从无碰撞系统在位形空间中表示为狄拉克δ函数之和、在 $[0,L)$ 上的周期性傅里叶表示以及独立随机变量的基本性质出发，推导以下对于 $n \\neq 0$ 的期望值：\n- 对于泊松采样，期望功率满足 $ \\mathbb{E}\\!\\left[P_\\mathrm{meas}(n)\\right] = \\frac{1}{N}$。\n- 对于静态晶格采样，对于所有满足 $1 \\le n  N$ 的整数 $n$，$P_\\mathrm{meas}(n) = 0$。\n- 对于方差为 $\\sigma^2$ 的独立高斯位移抖动晶格采样，单个位移的特征函数是 $\\phi(k) = \\exp\\!\\left(-\\tfrac{1}{2}\\sigma^2 k^2\\right)$，模式 $n$ 的期望功率是\n$$\n\\mathbb{E}\\!\\left[P_\\mathrm{meas}(n)\\right] = \\frac{1}{N}\\left(1 - \\left|\\phi(k_n)\\right|^2\\right) = \\frac{1}{N}\\left(1 - \\exp\\!\\left(-\\sigma^2 k_n^2\\right)\\right).\n$$\n\n实现一个程序，对于每个指定的测试用例，根据所选的采样策略构建 $\\{x_i\\}_{i=1}^N$，计算 $P_\\mathrm{meas}(n)$，并根据上述公式计算相应的理论预测值 $P_\\mathrm{theory}(n)$。在涉及随机性时，使用固定的随机数生成器种子以确保可复现性。\n\n使用以下测试套件，它探测了一个典型情况、静态启动中的精确抵消、弱抖动以及接近类奈奎斯特区域的强抖动：\n- 情况 A（泊松采样）：$N = 1024$，$L = 1$，$n = 1$，随机种子 $= 7$。\n- 情况 B（静态晶格）：$N = 64$，$L = 1$，$n = 1$。\n- 情况 C（抖动晶格）：$N = 256$，$L = 1$，$n = 3$，$\\sigma = 0.01$，随机种子 $= 123$。\n- 情况 D（抖动晶格）：$N = 64$，$L = 1$，$n = 31$，$\\sigma = 0.1$，随机种子 $= 1$。\n\n对于每种情况，您的程序必须计算并输出两个浮点数：首先是该情况下的 $P_\\mathrm{meas}(n)$，然后是 $P_\\mathrm{theory}(n)$。您的程序应生成一行输出，包含一个逗号分隔的列表，用方括号括起来，顺序为 $[\\text{情况 A }P_\\mathrm{meas}, \\text{情况 A }P_\\mathrm{theory}, \\text{情况 B }P_\\mathrm{meas}, \\text{情况 B }P_\\mathrm{theory}, \\text{情况 C }P_\\mathrm{meas}, \\text{情况 C }P_\\mathrm{theory}, \\text{情况 D }P_\\mathrm{meas}, \\text{情况 D }P_\\mathrm{theory}]$。所有量都是无量纲的，不需要物理单位。通过傅里叶相位 $k_n x$，角度已隐式地以弧度为单位。", "solution": "该问题要求推导在一维周期性区域中三种不同粒子采样策略产生的伪密度涨落的期望功率谱，然后通过数值实现来验证这些理论预测。我们首先给出每种情况的推导。\n\n物理系统是一个在周期性区间 $[0, L)$ 上的均匀质量分布，被离散化为 $N$ 个等质量粒子。第 $i$ 个粒子的位置是 $x_i$。与完美均匀连续介质的偏离由粒子分布的傅里叶分量来量化。模式 $n$ 下的密度衬比的复振幅定义为\n$$\n\\delta_k(n) \\equiv \\frac{1}{N}\\sum_{i=1}^N \\exp\\!\\left(-\\mathrm{i}\\,k_n\\,x_i\\right)\n$$\n其中 $k_n = \\frac{2\\pi n}{L}$ 是整数模式指数 $n \\in \\mathbb{Z}$ 对应的波数。功率谱 $P_\\mathrm{meas}(n)$ 是此振幅的模的平方：\n$$\nP_\\mathrm{meas}(n) \\equiv \\left|\\delta_k(n)\\right|^2 = \\delta_k(n) \\delta_k^*(n)\n$$\n其中 $\\delta_k^*(n)$ 是 $\\delta_k(n)$ 的复共轭。我们感兴趣的是该功率的期望值 $\\mathbb{E}\\!\\left[P_\\mathrm{meas}(n)\\right]$（对于随机采样方法），或者是其直接值（对于确定性方法）。我们将考虑 $n \\neq 0$ 的情况，因为 $n=0$ 模式对应于平均密度，而不是涨落。\n\n**1. 泊松采样**\n\n在泊松采样中，粒子位置 $\\{x_i\\}_{i=1}^N$ 是从区间 $[0, L)$ 上的均匀概率分布中抽取的独立同分布（i.i.d.）随机变量。功率谱的期望值为\n$$\n\\mathbb{E}\\!\\left[P_\\mathrm{meas}(n)\\right] = \\mathbb{E}\\!\\left[ \\left( \\frac{1}{N}\\sum_{i=1}^N e^{-\\mathrm{i}k_n x_i} \\right) \\left( \\frac{1}{N}\\sum_{j=1}^N e^{\\mathrm{i}k_n x_j} \\right) \\right] = \\frac{1}{N^2} \\sum_{i=1}^N \\sum_{j=1}^N \\mathbb{E}\\!\\left[ e^{-\\mathrm{i}k_n(x_i - x_j)} \\right]\n$$\n我们将双重求和分为对角项（$i=j$）和非对角项（$i \\neq j$）。\n\n对于对角项（$i=j$），我们有 $x_i - x_j = 0$，所以 $e^{-\\mathrm{i}k_n(x_i - x_j)} = e^0 = 1$。其期望为 $\\mathbb{E}[1] = 1$。共有 $N$ 个这样的项。它们对和的贡献是 $N$。\n\n对于非对角项（$i \\neq j$），位置 $x_i$ 和 $x_j$ 是独立的随机变量。因此，乘积的期望等于期望的乘积：\n$$\n\\mathbb{E}\\!\\left[ e^{-\\mathrm{i}k_n(x_i - x_j)} \\right] = \\mathbb{E}\\!\\left[ e^{-\\mathrm{i}k_n x_i} \\right] \\mathbb{E}\\!\\left[ e^{\\mathrm{i}k_n x_j} \\right]\n$$\n对于一个在 $[0, L)$ 上均匀分布的随机变量 $x$， $e^{-\\mathrm{i}k_n x}$ 的期望是\n$$\n\\mathbb{E}\\!\\left[ e^{-\\mathrm{i}k_n x} \\right] = \\int_0^L \\frac{1}{L} e^{-\\mathrm{i}k_n x} dx = \\frac{1}{L} \\left[ \\frac{e^{-\\mathrm{i}k_n x}}{-\\mathrm{i}k_n} \\right]_0^L\n$$\n代入 $k_n = 2\\pi n / L$ 并假设 $n \\neq 0$：\n$$\n\\mathbb{E}\\!\\left[ e^{-\\mathrm{i}k_n x} \\right] = \\frac{1}{L} \\frac{L}{-\\mathrm{i}2\\pi n} \\left( e^{-\\mathrm{i}2\\pi n} - e^0 \\right) = \\frac{1}{-\\mathrm{i}2\\pi n} (1 - 1) = 0\n$$\n由于 $\\mathbb{E}[e^{\\mathrm{i}k_n x_j}]$ 也为零，所以每个非对角项的期望都是 $0$。共有 $N^2 - N$ 个这样的项。\n\n结合对角项和非对角项的贡献，总和为 $N + 0 = N$。期望功率为：\n$$\n\\mathbb{E}\\!\\left[P_\\mathrm{meas}(n)\\right] = \\frac{1}{N^2} (N) = \\frac{1}{N}\n$$\n这个结果是粒子泊松分布的著名散粒噪声水平。\n\n**2. 静态晶格采样**\n\n在静态晶格（或静态启动）采样中，粒子被放置在一个规则的网格上。其位置是确定性的：\n$$\nx_i = \\left(i - \\frac{1}{2}\\right)\\frac{L}{N} \\quad \\text{for } i \\in \\{1, 2, \\dots, N\\}\n$$\n复振幅 $\\delta_k(n)$ 为\n$$\n\\delta_k(n) = \\frac{1}{N} \\sum_{i=1}^N \\exp\\!\\left(-\\mathrm{i}k_n x_i\\right) = \\frac{1}{N} \\sum_{i=1}^N \\exp\\!\\left(-\\mathrm{i}\\frac{2\\pi n}{L} \\left(i - \\frac{1}{2}\\right)\\frac{L}{N}\\right) = \\frac{1}{N} \\sum_{i=1}^N \\exp\\!\\left(-\\mathrm{i}\\frac{2\\pi n}{N}\\left(i - \\frac{1}{2}\\right)\\right)\n$$\n我们可以分解出一个相位项：\n$$\n\\delta_k(n) = \\frac{1}{N} \\exp\\!\\left(\\mathrm{i}\\frac{\\pi n}{N}\\right) \\sum_{i=1}^N \\exp\\!\\left(-\\mathrm{i}\\frac{2\\pi n i}{N}\\right)\n$$\n这个和是一个几何级数。令 $r = \\exp(-\\mathrm{i} \\frac{2\\pi n}{N})$。和为 $\\sum_{i=1}^N r^i = r + r^2 + \\dots + r^N = r \\frac{1-r^N}{1-r}$。问题指定了范围 $1 \\le n  N$，这确保了 $n$ 不是 $N$ 的倍数。因此，$r \\neq 1$。项 $r^N$ 是\n$$\nr^N = \\left(\\exp\\!\\left(-\\mathrm{i}\\frac{2\\pi n}{N}\\right)\\right)^N = \\exp(-\\mathrm{i} 2\\pi n) = 1\n$$\n因为 $n$ 是一个整数。和的分子是 $1 - r^N = 1 - 1 = 0$。因此，整个和为零。\n这意味着 $\\delta_k(n) = 0$，所以功率为\n$$\nP_\\mathrm{meas}(n) = \\left|\\delta_k(n)\\right|^2 = 0\n$$\n对于所有满足 $1 \\le n  N$ 的整数模式 $n$。这种完美的抵消是该方法被称为“静态”启动的原因。\n\n**3. 抖动晶格采样**\n\n抖动晶格采样从一个静态晶格开始，并添加小的随机位移。其位置为\n$$\nx_i = x_{i,0} + \\varepsilon_i = \\left(i - \\frac{1}{2}\\right)\\frac{L}{N} + \\varepsilon_i\n$$\n其中 $\\varepsilon_i$ 是从均值为 $0$、方差为 $\\sigma^2$ 的高斯分布中抽取的独立同分布随机变量。期望功率的分析与泊松采样的初始步骤相同：\n$$\n\\mathbb{E}\\!\\left[P_\\mathrm{meas}(n)\\right] = \\frac{1}{N^2} \\sum_{i=1}^N \\sum_{j=1}^N \\mathbb{E}\\!\\left[ e^{-\\mathrm{i}k_n(x_i - x_j)} \\right]\n$$\n期望项为 $\\mathbb{E}\\!\\left[ e^{-\\mathrm{i}k_n(x_{i,0} - x_{j,0})} e^{-\\mathrm{i}k_n(\\varepsilon_i - \\varepsilon_j)} \\right] = e^{-\\mathrm{i}k_n(x_{i,0} - x_{j,0})} \\mathbb{E}\\!\\left[ e^{-\\mathrm{i}k_n(\\varepsilon_i - \\varepsilon_j)} \\right]$。\n\n对于对角项（$i=j$），$x_{i,0} - x_{j,0} = 0$ 且 $\\varepsilon_i - \\varepsilon_j = 0$。该项为 $1$。共有 $N$ 个这样的项。\n\n对于非对角项（$i \\neq j$），位移 $\\varepsilon_i$ 和 $\\varepsilon_j$ 是独立的。因此，\n$$\n\\mathbb{E}\\!\\left[ e^{-\\mathrm{i}k_n(\\varepsilon_i - \\varepsilon_j)} \\right] = \\mathbb{E}\\!\\left[ e^{-\\mathrm{i}k_n \\varepsilon_i} \\right] \\mathbb{E}\\!\\left[ e^{\\mathrm{i}k_n \\varepsilon_j} \\right]\n$$\n项 $\\mathbb{E}[e^{-\\mathrm{i}k \\varepsilon}]$ 是随机变量 $\\varepsilon$ 的特征函数的定义，记为 $\\phi(k)$。所以，$\\mathbb{E}[e^{-\\mathrm{i}k_n \\varepsilon_i}] = \\phi(k_n)$ 且 $\\mathbb{E}[e^{\\mathrm{i}k_n \\varepsilon_j}] = \\phi(-k_n)$。对于实值概率分布，$\\phi(-k) = \\phi^*(k)$，即复共轭。因此，乘积为 $|\\phi(k_n)|^2$。一个非对角项的期望变为 $e^{-\\mathrm{i}k_n(x_{i,0} - x_{j,0})} |\\phi(k_n)|^2$。\n\n总期望为：\n$$\n\\mathbb{E}\\!\\left[P_\\mathrm{meas}(n)\\right] = \\frac{1}{N^2} \\left( N + \\sum_{i \\neq j} e^{-\\mathrm{i}k_n(x_{i,0} - x_{j,0})} |\\phi(k_n)|^2 \\right)\n$$\n对 $i \\neq j$ 的求和可以重写为：\n$$\n\\sum_{i \\neq j} (\\dots) = \\left( \\sum_{i,j} e^{-\\mathrm{i}k_n(x_{i,0} - x_{j,0})} \\right) - \\left( \\sum_{i=j} e^0 \\right) = \\left| \\sum_i e^{-\\mathrm{i}k_n x_{i,0}} \\right|^2 - N\n$$\n从静态晶格的推导中，我们知道对于 $1 \\le n  N$，和 $\\sum_i e^{-\\mathrm{i}k_n x_{i,0}}$ 为零。因此，对 $i \\neq j$ 的求和结果为 $-N$。\n将此代回，非对角项的贡献为 $-N|\\phi(k_n)|^2$。\n总期望功率为：\n$$\n\\mathbb{E}\\!\\left[P_\\mathrm{meas}(n)\\right] = \\frac{1}{N^2} \\left( N - N|\\phi(k_n)|^2 \\right) = \\frac{1}{N}\\left(1 - |\\phi(k_n)|^2\\right)\n$$\n对于高斯位移 $\\varepsilon \\sim \\mathcal{N}(0, \\sigma^2)$，其特征函数为 $\\phi(k) = \\exp(-\\frac{1}{2}\\sigma^2 k^2)$。它是实数，所以 $|\\phi(k_n)|^2 = \\left(\\exp(-\\frac{1}{2}\\sigma^2 k_n^2)\\right)^2 = \\exp(-\\sigma^2 k_n^2)$。\n这得出了最终的表达式：\n$$\n\\mathbb{E}\\!\\left[P_\\mathrm{meas}(n)\\right] = \\frac{1}{N}\\left(1 - \\exp(-\\sigma^2 k_n^2)\\right)\n$$\n此推导证实了问题陈述中提供的理论公式。它们构成了后续数值计算的基础。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes measured and theoretical power of density fluctuations\n    for different particle sampling strategies.\n    \"\"\"\n    test_cases = [\n        {'type': 'poisson', 'N': 1024, 'L': 1.0, 'n': 1, 'seed': 7},\n        {'type': 'quiet', 'N': 64, 'L': 1.0, 'n': 1},\n        {'type': 'jittered', 'N': 256, 'L': 1.0, 'n': 3, 'sigma': 0.01, 'seed': 123},\n        {'type': 'jittered', 'N': 64, 'L': 1.0, 'n': 31, 'sigma': 0.1, 'seed': 1},\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        N = case['N']\n        L = case['L']\n        n = case['n']\n        \n        # Calculate the wavenumber\n        k_n = 2 * np.pi * n / L\n\n        # Generate particle positions based on the sampling strategy\n        if case['type'] == 'poisson':\n            rng = np.random.default_rng(case['seed'])\n            x = L * rng.random(size=N)\n            p_theory = 1.0 / N\n        \n        elif case['type'] == 'quiet':\n            # Particle positions for quiet lattice sampling\n            # x_i = (i - 1/2) * L / N for i = 1, ..., N\n            i = np.arange(1, N + 1)\n            x = (i - 0.5) * L / N\n            p_theory = 0.0\n\n        elif case['type'] == 'jittered':\n            sigma = case['sigma']\n            rng = np.random.default_rng(case['seed'])\n            \n            # Base lattice positions\n            i = np.arange(1, N + 1)\n            x_lattice = (i - 0.5) * L / N\n            \n            # Add Gaussian displacements\n            displacements = rng.normal(loc=0.0, scale=sigma, size=N)\n            \n            # Final positions with periodic boundary conditions\n            x = (x_lattice + displacements) % L\n            \n            p_theory = (1.0 / N) * (1.0 - np.exp(-sigma**2 * k_n**2))\n\n        # Calculate the measured power\n        # delta_k(n) = 1/N * sum(exp(-i * k_n * x_i))\n        # The mean of the complex exponentials is equivalent to the normalized sum\n        delta_k = np.mean(np.exp(-1j * k_n * x))\n        p_meas = np.abs(delta_k)**2\n        \n        results.append(p_meas)\n        results.append(p_theory)\n\n    # Format the final output as a single comma-separated line in brackets\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3518281"}, {"introduction": "在设置好初始粒子分布后，N体模拟的下一步是随时间积分它们的轨道。积分的准确性和稳定性对获得可靠结果至关重要。本练习聚焦于实现和比较辛积分器（symplectic integrators），因其出色的长期能量守恒特性，已成为N体模拟的黄金标准 [@problem_id:3518329]。您将构建一个标准的二阶蛙跳式积分器和一个更高级的四阶方案，并验证它们的理论精度和相空间体积保持特性，从而深入了解驱动现代引力模拟的核心引擎。", "problem": "您必须实现并比较在一个静态、孤立的 Hernquist 晕势中，用于无碰撞示踪粒子时间积分器。该系统模拟了单个相空间点在固定球对称势下的演化，这是由 Vlasov 方程所描述的、具有不随时变且通过泊松方程求解的场的无碰撞动力学的一个特例。基本模型是牛顿引力，使用哈密顿力学和正则坐标。请使用以下基本事实，不要使用任何现成公式：\n- 牛顿定律表明 $d\\boldsymbol{r}/dt = \\boldsymbol{v}$ 且 $d\\boldsymbol{v}/dt = \\boldsymbol{a}(\\boldsymbol{r})$，其中 $\\boldsymbol{a}(\\boldsymbol{r})$ 是加速度场。\n- 对于一个不随时变的势 $\\Phi(\\boldsymbol{r})$，单位质量粒子的哈密顿量为 $H = T + V = \\tfrac{1}{2}\\lvert \\boldsymbol{v} \\rvert^{2} + \\Phi(\\boldsymbol{r})$。\n- Hernquist 晕势为 $\\Phi(r) = -\\dfrac{G M}{r + a}$，其中 $r = \\lVert \\boldsymbol{r} \\rVert$；其产生的力为 $\\boldsymbol{F}(\\boldsymbol{r}) = -\\nabla \\Phi = -\\dfrac{G M}{(r + a)^{2}} \\dfrac{\\boldsymbol{r}}{r}$。\n- 辛分裂源于将哈密顿流分解为由 $T(\\boldsymbol{v})$ 和 $V(\\boldsymbol{r})$ 生成的精确子流，这些子流组合后可产生辛映射。\n\n您的任务：\n1. 使用踢-漂-踢 (kick-drift-kick) 组合实现一个二阶蛙跳积分器。推导并在代码中实现通过组合 $T$ 和 $V$ 的精确流在一个大小为 $h$ 的步长上所隐含的正则更新。\n2. 实现一个四阶辛分裂方法，该方法通过组合具有适当选择的标量系数的二阶踢-漂-踢步骤来获得形式上的四阶精度。推导该组合的结构，并论证产生四阶方法的系数选择。\n3. 对于每种方法，通过在步长 $h$ 和 $h/2$ 下对轨道进行总时间为 $T$ 的积分，计算整个轨迹相对于初始能量 $E_{0}$ 的最大绝对相对能量偏差，并报告在步长 $h$ 下计算出的 $\\max_{t \\in [0,T]} \\lvert E(t) - E_{0} \\rvert / \\lvert E_{0} \\rvert$ 值与在步长 $h/2$ 下计算出的相同量之比，来量化长时间能量误差的标度行为。\n4. 通过在六维 $(\\boldsymbol{r}, \\boldsymbol{v})$ 空间上使用有限差分来近似初始条件下单步映射的雅可比行列式，并报告其绝对偏差 $\\lvert \\det(J) - 1 \\rvert$，以此来评估相空间体积的守恒性。使用足够小的扰动大小以捕捉局部线性化。\n\n使用无量纲单位，其中 $G = 1$，$M = 1$，$a = 1$，单位质量 $m=1$。位置单位为 $a$，时间单位为 $(a^{3}/G M)^{1/2}$，速度单位为 $(G M / a)^{1/2}$。所有输出均表示为无量纲浮点数。\n\n测试组：\n- 情况 1（大半径近圆形轨道）：$\\boldsymbol{r}_{0} = (5, 0, 0)$，$\\boldsymbol{v}_{0} = (0, v_{\\mathrm{circ}}(5), 0)$ 其中 $v_{\\mathrm{circ}}(r) = \\sqrt{ r \\, \\dfrac{G M}{(r + a)^{2}} }$；使用 $h = 0.02$ 和 $T = 200$。\n- 情况 2（低于逃逸速度的径向轨道）：$\\boldsymbol{r}_{0} = (2, 0, 0)$，$\\boldsymbol{v}_{0} = (0.5 \\, v_{\\mathrm{esc}}(2), 0, 0)$ 其中 $v_{\\mathrm{esc}}(r) = \\sqrt{ \\dfrac{2 G M}{r + a} }$；使用 $h = 0.02$ 和 $T = 200$。\n- 情况 3（低角动量穿心轨道）：$\\boldsymbol{r}_{0} = (0.5, 0, 0)$，$\\boldsymbol{v}_{0} = (-0.2 \\, v_{\\mathrm{circ}}(0.5), 0.2 \\, v_{\\mathrm{circ}}(0.5), 0)$；使用 $h = 0.02$ 和 $T = 200$。\n\n对于每种情况，计算：\n- 蛙跳积分器的能量误差标度比：$\\mathsf{ratio}_{\\mathrm{LF}} = \\dfrac{\\max_{t} \\lvert E_{h}(t) - E_{0} \\rvert / \\lvert E_{0} \\rvert}{\\max_{t} \\lvert E_{h/2}(t) - E_{0} \\rvert / \\lvert E_{0} \\rvert}$。\n- 四阶方法的能量误差标度比：$\\mathsf{ratio}_{\\mathrm{S4}}$ 的定义与此类似。\n- 蛙跳积分器的相空间体积偏差：$\\delta_{\\mathrm{vol, LF}} = \\lvert \\det(J_{\\mathrm{LF}}) - 1 \\rvert$，在步长为 $h$ 的单步中计算。\n- 四阶方法的相空间体积偏差：$\\delta_{\\mathrm{vol, S4}} = \\lvert \\det(J_{\\mathrm{S4}}) - 1 \\rvert$，在步长为 $h$ 的单步中计算。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，按情况 1、2、3 的顺序包含以下结果： $[\\mathsf{ratio}_{\\mathrm{LF},1}, \\mathsf{ratio}_{\\mathrm{S4},1}, \\delta_{\\mathrm{vol, LF},1}, \\delta_{\\mathrm{vol, S4},1}, \\mathsf{ratio}_{\\mathrm{LF},2}, \\mathsf{ratio}_{\\mathrm{S4},2}, \\delta_{\\mathrm{vol, LF},2}, \\delta_{\\mathrm{vol, S4},2}, \\mathsf{ratio}_{\\mathrm{LF},3}, \\mathsf{ratio}_{\\mathrm{S4},3}, \\delta_{\\mathrm{vol, LF},3}, \\delta_{\\mathrm{vol, S4},3}]$。\n所有量均为浮点数。\n\n角度不是必需的；不要输出任何角度。无需打印物理单位，因为所有量都指定为无量纲。答案仅为数值浮点数。测试组是自足的，涵盖了近圆形轨道、径向轨道和通过中心附近的低角动量轨道，旨在探究不同动力学区间下的精度和体积守恒性。", "solution": "该问题要求为一个在静态 Hernquist 势中运动的示踪粒子实现并比较两种辛积分器——二阶蛙跳法和四阶分裂法。分析涉及量化几种不同轨道的能量守恒误差和相空间体积守恒性。\n\n该系统由一个单位质量（$m=1$）粒子的不随时变的哈密顿量控制：\n$$\nH(\\boldsymbol{r}, \\boldsymbol{v}) = T(\\boldsymbol{v}) + V(\\boldsymbol{r}) = \\frac{1}{2} |\\boldsymbol{v}|^2 + \\Phi(\\boldsymbol{r})\n$$\n其中 $\\boldsymbol{r}$ 是位置向量，$\\boldsymbol{v}$ 是速度向量，$\\Phi(\\boldsymbol{r})$ 是引力势。Hernquist 势由下式给出：\n$$\n\\Phi(r) = -\\frac{G M}{r + a}\n$$\n其中 $r = \\lVert \\boldsymbol{r} \\rVert$ 是径向距离。在指定的无量纲单位中，$G=1$，$M=1$，$a=1$，因此势简化为 $\\Phi(r) = -1/(r+1)$。运动方程是哈密顿方程：\n$$\n\\frac{d\\boldsymbol{r}}{dt} = \\frac{\\partial H}{\\partial \\boldsymbol{v}} = \\boldsymbol{v}\n$$\n$$\n\\frac{d\\boldsymbol{v}}{dt} = -\\frac{\\partial H}{\\partial \\boldsymbol{r}} = -\\nabla\\Phi(\\boldsymbol{r})\n$$\n加速度 $\\boldsymbol{a}(\\boldsymbol{r}) = -\\nabla\\Phi(\\boldsymbol{r})$ 从势计算得出：\n$$\n\\boldsymbol{a}(\\boldsymbol{r}) = -\\frac{d\\Phi}{dr} \\frac{\\boldsymbol{r}}{r} = -\\left( \\frac{d}{dr} \\left(-\\frac{1}{r+1}\\right) \\right) \\frac{\\boldsymbol{r}}{r} = -\\frac{1}{(r+1)^2} \\frac{\\boldsymbol{r}}{r}\n$$\n\n运动方程的形式解通过李算子 $\\mathcal{L}_H = \\{\\cdot, H\\}$ 的指数，将状态向量 $\\boldsymbol{z} = (\\boldsymbol{r}, \\boldsymbol{v})$ 在一个时间步长 $h$ 内进行演化：$\\boldsymbol{z}(t+h) = \\exp(h \\mathcal{L}_H) \\boldsymbol{z}(t)$。辛积分器是通过使用 Baker-Campbell-Hausdorff (BCH) 公式分裂此算子来构造的。我们将哈密顿量分裂成其动能部分 $T$ 和势能部分 $V$。算子变为 $\\mathcal{L}_H = \\mathcal{L}_T + \\mathcal{L}_V$。在每个部分下的演化都可以简单地精确求解：\n1. 由 $T(\\boldsymbol{v})$ 在时间 $h$ 内生成的流，记作 $\\exp(h\\mathcal{L}_T)$，对应于 $\\dot{\\boldsymbol{r}} = \\boldsymbol{v}$ 和 $\\dot{\\boldsymbol{v}} = 0$。其精确解是一个“漂移” (drift)：\n$$\n\\boldsymbol{r}(t+h) = \\boldsymbol{r}(t) + h \\boldsymbol{v}(t), \\quad \\boldsymbol{v}(t+h) = \\boldsymbol{v}(t)\n$$\n2. 由 $V(\\boldsymbol{r})$ 在时间 $h$ 内生成的流，记作 $\\exp(h\\mathcal{L}_V)$，对应于 $\\dot{\\boldsymbol{r}} = 0$ 和 $\\dot{\\boldsymbol{v}} = \\boldsymbol{a}(\\boldsymbol{r})$。其精确解是一个“踢” (kick)：\n$$\n\\boldsymbol{r}(t+h) = \\boldsymbol{r}(t), \\quad \\boldsymbol{v}(t+h) = \\boldsymbol{v}(t) + h \\boldsymbol{a}(\\boldsymbol{r}(t))\n$$\n通过组合这些精确的基本流，我们构造了辛数值积分器。\n\n**1. 二阶蛙跳 (Kick-Drift-Kick) 积分器**\n二阶蛙跳法可以从 Strang 分裂推导出来。漂移和踢算子的对称组合产生一个二阶精度的映射。踢-漂-踢 (KDK) 的公式为：\n$$\n\\mathcal{M}_{\\mathrm{LF}}(h) = \\exp\\left(\\frac{h}{2} \\mathcal{L}_V\\right) \\exp\\left(h \\mathcal{L}_T\\right) \\exp\\left(\\frac{h}{2} \\mathcal{L}_V\\right)\n$$\n将此算子序列应用于时间 $t_n$ 的状态 $(\\boldsymbol{r}_n, \\boldsymbol{v}_n)$ 以求得 $t_{n+1} = t_n+h$ 时的状态，可得出以下算法步骤：\n1. **第一次踢（半步）**：应用 $\\exp(\\frac{h}{2}\\mathcal{L}_V)$。这使用当前位置的加速度来更新速度。计算出一个临时速度 $\\boldsymbol{v}_{n+1/2}$。\n$$\n\\boldsymbol{v}_{n+1/2} = \\boldsymbol{v}_n + \\frac{h}{2} \\boldsymbol{a}(\\boldsymbol{r}_n)\n$$\n2. **漂移（全步）**：应用 $\\exp(h\\mathcal{L}_T)$。这使用新的中间速度来更新位置。\n$$\n\\boldsymbol{r}_{n+1} = \\boldsymbol{r}_n + h \\boldsymbol{v}_{n+1/2}\n$$\n3. **第二次踢（半步）**：应用 $\\exp(\\frac{h}{2}\\mathcal{L}_V)$。这使用新位置 $\\boldsymbol{r}_{n+1}$ 处的加速度来完成速度更新。\n$$\n\\boldsymbol{v}_{n+1} = \\boldsymbol{v}_{n+1/2} + \\frac{h}{2} \\boldsymbol{a}(\\boldsymbol{r}_{n+1})\n$$\n该方案是对称、显式的，并具有二阶精度，意味着其局部截断误差为 $\\mathcal{O}(h^3)$。\n\n**2. 四阶辛积分器**\n更高阶的辛积分器可以通过组合一个对称的二阶方法来构造。设 $S_2(h)$ 表示步长为 $h$ 的二阶蛙跳映射。一个四阶对称方法 $S_4(h)$ 可以构造成三个具有特定时间步长的二阶步骤的组合：\n$$\nS_4(h) = S_2(c_1 h) S_2(c_2 h) S_2(c_1 h)\n$$\n为使所得方法具有四阶精度，系数 $c_1$ 和 $c_2$ 必须满足从 BCH 展开式推导出的一个方程组。对于对称组合，条件是：\n$$\n2c_1 + c_2 = 1 \\quad \\text{and} \\quad 2c_1^3 + c_2^3 = 0\n$$\n第一个条件确保总时间步长为 $h$。第二个条件消除了组合映射的三阶误差项。解此方程组可得：\n$$\nc_1 = \\frac{1}{2 - 2^{1/3}}, \\quad c_2 = \\frac{-2^{1/3}}{2 - 2^{1/3}}\n$$\n因此，一个大小为 $h$ 的四阶单步算法是，连续三次应用二阶蛙跳步骤，时间步长分别为 $c_1 h$、$c_2 h$ 和 $c_1 h$。该方法的局部截断误差为 $\\mathcal{O}(h^5)$。\n\n**3. 能量误差标度**\n对于哈密顿系统，能量是一个运动积分。虽然辛积分器不能精确守恒真实的哈密顿量 $H$，但它们能精确守恒一个附近的“影子”哈密顿量 $H'$。这导致了长期的稳定性和有界的能量涨落，而不是长期漂移。对于一个 $p$ 阶积分器，在固定时间间隔 $T$ 内的全局能量误差预计会以 $\\mathcal{O}(h^p)$ 的方式标度。我们可以通过数值方法来验证这一点。最大绝对相对能量误差定义为 $\\epsilon_{\\max}(h) = \\max_{t \\in [0,T]} \\lvert E(t) - E_0 \\rvert / \\lvert E_0 \\rvert$。用步长 $h$ 和 $h/2$ 计算此误差的比率应为：\n$$\n\\mathsf{ratio} = \\frac{\\epsilon_{\\max}(h)}{\\epsilon_{\\max}(h/2)} \\approx \\frac{C h^p}{C (h/2)^p} = 2^p\n$$\n对于二阶蛙跳法 ($p=2$)，我们预计 $\\mathsf{ratio}_{\\mathrm{LF}} \\approx 2^2 = 4$。对于四阶方法 ($p=4$)，我们预计 $\\mathsf{ratio}_{\\mathrm{S4}} \\approx 2^4 = 16$。\n\n**4. 相空间体积守恒**\n刘维尔定理指出，哈密顿系统的流在相空间中保持体积元不变。这意味着，如果我们考虑一个初始条件区域，其体积会随着时间演化而保持不变。这个性质在数学上等价于流映射的雅可比行列式为 1 的表述。\n一个数值积分器是辛的，当且仅当其单步映射 $\\mathcal{M}: \\boldsymbol{z}_n \\mapsto \\boldsymbol{z}_{n+1}$ 的雅可比行列式为 1，即 $\\det(J) = \\det(\\partial \\boldsymbol{z}_{n+1} / \\partial \\boldsymbol{z}_n) = 1$。通过分裂哈密顿量构造的积分器在构造上就是辛的。我们通过在六维相空间向量 $\\boldsymbol{z} = (r_x, r_y, r_z, v_x, v_y, v_z)$ 上使用中心差分法计算单步映射的雅可比矩阵 $J$ 来进行数值验证。$J$ 的第 $j$ 列通过 $(\\mathcal{M}(\\boldsymbol{z}_0 + \\delta \\boldsymbol{e}_j) - \\mathcal{M}(\\boldsymbol{z}_0 - \\delta \\boldsymbol{e}_j)) / (2\\delta)$ 来近似，其中 $\\boldsymbol{e}_j$ 是第 $j$ 个标准基向量，$\\delta$ 是一个小的扰动。我们关心的量是偏差 $\\delta_{\\mathrm{vol}} = |\\det(J) - 1|$，对于一个正确的实现，这个值应该在机器浮点精度的量级。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements and compares second-order and fourth-order symplectic integrators\n    for orbital motion in a Hernquist potential.\n    \"\"\"\n\n    # Dimensionless constants\n    G_const = 1.0\n    M_const = 1.0\n    a_const = 1.0\n\n    # Fourth-order integrator coefficients (Yoshida 1990)\n    cbrt_2 = 2**(1/3)\n    c1 = 1.0 / (2.0 - cbrt_2)\n    c2 = -cbrt_2 / (2.0 - cbrt_2)\n    S4_COEFFS = [c1, c2, c1]\n\n    def acceleration(r_vec):\n        \"\"\"Computes acceleration for a Hernquist potential.\"\"\"\n        r_mag = np.linalg.norm(r_vec)\n        if r_mag == 0.0:\n            return np.zeros(3)\n        # a(r) = - (GM / (r+a)^2) * (r_vec / r)\n        magnitude = - (G_const * M_const) / (r_mag + a_const)**2\n        return magnitude * (r_vec / r_mag)\n\n    def energy(r_vec, v_vec):\n        \"\"\"Computes specific energy for a Hernquist potential.\"\"\"\n        r_mag = np.linalg.norm(r_vec)\n        # H = 0.5*|v|^2 - GM/(r+a)\n        kinetic = 0.5 * np.dot(v_vec, v_vec)\n        potential = - (G_const * M_const) / (r_mag + a_const)\n        return kinetic + potential\n\n    def leapfrog_step(r, v, h):\n        \"\"\"Performs one step of the KDK leapfrog integrator.\"\"\"\n        v_half = v + 0.5 * h * acceleration(r)\n        r_new = r + h * v_half\n        v_new = v_half + 0.5 * h * acceleration(r_new)\n        return r_new, v_new\n\n    def s4_step(r, v, h):\n        \"\"\"Performs one step of the 4th-order symplectic integrator.\"\"\"\n        r_curr, v_curr = r, v\n        for coeff in S4_COEFFS:\n            r_curr, v_curr = leapfrog_step(r_curr, v_curr, h * coeff)\n        return r_curr, v_curr\n\n    def compute_energy_error_max(integrator, r0, v0, h, T):\n        \"\"\"Integrates an orbit and returns the max relative energy error.\"\"\"\n        n_steps = int(round(T / h))\n        r, v = r0.copy(), v0.copy()\n        \n        e0 = energy(r0, v0)\n        \n        max_err = 0.0\n        for _ in range(n_steps):\n            r, v = integrator(r, v, h)\n            e_t = energy(r, v)\n            err = abs((e_t - e0) / e0)\n            if err  max_err:\n                max_err = err\n        return max_err\n\n    def compute_volume_deviation(integrator, r0, v0, h):\n        \"\"\"Computes |det(J) - 1| for the one-step map using finite differences.\"\"\"\n        dim = 6\n        J = np.zeros((dim, dim))\n        z0 = np.concatenate((r0, v0))\n        eps = 1e-8\n\n        # Central difference for Jacobian columns\n        for j in range(dim):\n            z_plus = z0.copy()\n            z_plus[j] += eps\n            \n            z_minus = z0.copy()\n            z_minus[j] -= eps\n\n            r_p, v_p = integrator(z_plus[:3], z_plus[3:], h)\n            z1_p = np.concatenate((r_p, v_p))\n\n            r_m, v_m = integrator(z_minus[:3], z_minus[3:], h)\n            z1_m = np.concatenate((r_m, v_m))\n            \n            J[:, j] = (z1_p - z1_m) / (2 * eps)\n            \n        det_J = np.linalg.det(J)\n        return abs(det_J - 1.0)\n\n\n    # Case 1: Near-circular orbit\n    r1 = 5.0\n    v_circ1 = np.sqrt(r1 * G_const * M_const / (r1 + a_const)**2)\n    r0_1 = np.array([r1, 0.0, 0.0])\n    v0_1 = np.array([0.0, v_circ1, 0.0])\n\n    # Case 2: Radial orbit\n    r2 = 2.0\n    v_esc2 = np.sqrt(2 * G_const * M_const / (r2 + a_const))\n    r0_2 = np.array([r2, 0.0, 0.0])\n    v0_2 = np.array([0.5 * v_esc2, 0.0, 0.0])\n\n    # Case 3: Low-angular-momentum orbit\n    r3 = 0.5\n    v_circ3 = np.sqrt(r3 * G_const * M_const / (r3 + a_const)**2)\n    r0_3 = np.array([r3, 0.0, 0.0])\n    v0_3 = np.array([-0.2 * v_circ3, 0.2 * v_circ3, 0.0])\n\n    test_cases = [\n        (r0_1, v0_1),\n        (r0_2, v0_2),\n        (r0_3, v0_3)\n    ]\n    \n    h = 0.02\n    T = 200.0\n\n    results = []\n    \n    for r0, v0 in test_cases:\n        # Leapfrog analysis\n        e_err_lf_h = compute_energy_error_max(leapfrog_step, r0, v0, h, T)\n        e_err_lf_h2 = compute_energy_error_max(leapfrog_step, r0, v0, h/2, T)\n        ratio_lf = e_err_lf_h / e_err_lf_h2 if e_err_lf_h2  0 else 0.0\n        \n        vol_dev_lf = compute_volume_deviation(leapfrog_step, r0, v0, h)\n        \n        # S4 analysis\n        e_err_s4_h = compute_energy_error_max(s4_step, r0, v0, h, T)\n        e_err_s4_h2 = compute_energy_error_max(s4_step, r0, v0, h/2, T)\n        ratio_s4 = e_err_s4_h / e_err_s4_h2 if e_err_s4_h2  0 else 0.0\n        \n        vol_dev_s4 = compute_volume_deviation(s4_step, r0, v0, h)\n\n        results.extend([ratio_lf, ratio_s4, vol_dev_lf, vol_dev_s4])\n        \n    print(f\"[{','.join(f'{x:.8f}' for x in results)}]\")\n\nsolve()\n```", "id": "3518329"}]}