{"hands_on_practices": [{"introduction": "仿星器中的磁场是通过叠加不同的傅里叶谐波来精心设计的。本练习让您亲身体验设计者如何通过调整这些谐波的属性（特别是它们的相对相位）来“调节”磁场，以获得理想的磁场拓扑结构。这项实践 [@problem_id:3715773] 将帮助您建立关于傅里叶谱与约束场真实空间结构之间关系的直观理解。", "problem": "给定在一个 Boozer 坐标系中单个磁通面上的简化静磁场强度表示，其中角向角为 $\\theta \\in [0,2\\pi)$，环向角为 $\\zeta \\in [0,2\\pi)$。磁场强度被建模为两个具有相位差的主导螺旋傅里叶模式的叠加。具体定义如下：\n$$\nB(\\theta,\\zeta) = B_0\\left[1 + \\epsilon_1 \\cos\\left(m_1 \\theta - n_1 \\zeta + \\phi_1\\right) + \\epsilon_2 \\cos\\left(m_2 \\theta - n_2 \\zeta + \\phi_2\\right)\\right],\n$$\n其中 $B_0$ 是一个恒定的基线磁场强度，$\\epsilon_1$ 和 $\\epsilon_2$ 是无量纲的小振幅，$(m_1,n_1)$ 和 $(m_2,n_2)$ 是整数模式数，$\\phi_1$ 和 $\\phi_2$ 是相位。本问题中所有角度都必须以弧度处理。\n\n从以下基本且广泛使用的依据出发：\n- Boozer 坐标系中磁通面上的静磁平衡意味着 $B(\\theta,\\zeta)$ 可以展开为 $(\\theta,\\zeta)$ 的傅里叶级数。\n- $B$ 的等值线与 $\\nabla B$ 正交；因此，在点 $(\\theta,\\zeta)$ 处等值线的局部切线方向与 $(-\\partial B/\\partial \\zeta,\\partial B/\\partial \\theta)$ 成正比。\n- 准等动力学（Quasi-Isodynamic, QI）性质指的是在磁通面上，磁场强度 $B$ 具有角向闭合的等值线，这些等值线可以最小化捕获粒子的弹跳平均径向漂移。在这个简化的分析中，我们通过量化 $B$ 等值线中角向方向的主导性来近似 QI 趋势。\n\n你的任务是分析，对于一组固定的 $(m_1,n_1)$ 和 $(m_2,n_2)$ 值以及振幅 $(\\epsilon_1,\\epsilon_2)$，改变两个模式之间的相位差 $\\Delta \\phi = \\phi_2 - \\phi_1$ 如何改变 $B$ 等值线的拓扑结构和准等动力学（QI）趋势。\n\n需要实现的算法：\n1. 用 $N_\\theta \\times N_\\zeta$ 个网格点对域进行离散化，其中 $N_\\theta = N_\\zeta = 256$，对于整数 $i,j$，$\\theta_i = 2\\pi i/N_\\theta$，$\\zeta_j = 2\\pi j/N_\\zeta$。\n2. 在网格上计算 $B(\\theta,\\zeta)$。\n3. 使用带周期性边界条件的二阶中心差分近似偏导数：\n   $$\n   \\frac{\\partial B}{\\partial \\theta}\\Big|_{i,j} \\approx \\frac{B(\\theta_{i+1},\\zeta_j) - B(\\theta_{i-1},\\zeta_j)}{2\\Delta \\theta}, \\quad \\frac{\\partial B}{\\partial \\zeta}\\Big|_{i,j} \\approx \\frac{B(\\theta_i,\\zeta_{j+1}) - B(\\theta_i,\\zeta_{j-1})}{2\\Delta \\zeta},\n   $$\n   其中 $\\Delta \\theta = 2\\pi/N_\\theta$ 且 $\\Delta \\zeta = 2\\pi/N_\\zeta$。\n4. 定义局部 $B$ 等值线的（未归一化）切线为 $\\mathbf{t} = (-\\partial B/\\partial \\zeta,\\partial B/\\partial \\theta)$，并将其逐点归一化为单位长度以获得分量 $(t_\\theta,t_\\zeta)$，其中\n   $$\n   t_\\theta = \\frac{\\partial B/\\partial \\theta}{\\sqrt{\\left(\\partial B/\\partial \\theta\\right)^2 + \\left(\\partial B/\\partial \\zeta\\right)^2}},\\quad\n   t_\\zeta = \\frac{-\\partial B/\\partial \\zeta}{\\sqrt{\\left(\\partial B/\\partial \\theta\\right)^2 + \\left(\\partial B/\\partial \\zeta\\right)^2}}.\n   $$\n5. 为避免数值奇异点，舍弃梯度大小过小的点。具体来说，定义一个掩码，其中\n   $$\n   \\sqrt{\\left(\\partial B/\\partial \\theta\\right)^2 + \\left(\\partial B/\\partial \\zeta\\right)^2} > f \\cdot \\max_{\\theta,\\zeta} \\sqrt{\\left(\\partial B/\\partial \\theta\\right)^2 + \\left(\\partial B/\\partial \\zeta\\right)^2},\n   $$\n   其中 $f = 10^{-3}$。\n6. 在保留的点上，计算两个标量度量：\n   - 方向比\n     $$\n     R = \\frac{\\langle |t_\\zeta| \\rangle}{\\langle |t_\\theta| \\rangle},\n     $$\n     其中 $\\langle \\cdot \\rangle$ 表示对保留点的平均值。$R  1$ 的值表示等值线平均而言比环向更偏向角向。\n   - QI 品质指数\n     $$\n     Q = \\frac{\\#\\text{ of retained points with } |t_\\zeta|  |t_\\theta|}{\\#\\text{ of retained points}},\n     $$\n     这是一个在 $[0,1]$ 区间内的无量纲分数。较大的 $Q$ 值表示趋向于角向闭合 $B$ 等值线的趋势更强，在此用作准等动力学性质的代理指标。\n\n测试套件：\n使用 $B_0 = 1$, $\\phi_1 = 0$，并按指定设置 $\\phi_2 = \\Delta \\phi$。角度以弧度为单位。评估以下四种情况：\n- 情况 1（螺旋反向缠绕对，同相）：\n  $(m_1,n_1) = (2,5)$, $(m_2,n_2) = (2,-5)$, $\\epsilon_1 = 0.08$, $\\epsilon_2 = 0.08$, $\\Delta \\phi = 0$。\n- 情况 2（螺旋反向缠绕对，四分之一相移）：\n  $(m_1,n_1) = (2,5)$, $(m_2,n_2) = (2,-5)$, $\\epsilon_1 = 0.08$, $\\epsilon_2 = 0.08$, $\\Delta \\phi = \\pi/2$。\n- 情况 3（螺旋模式与纯角向伴随模式，反相）：\n  $(m_1,n_1) = (2,5)$, $(m_2,n_2) = (1,0)$, $\\epsilon_1 = 0.06$, $\\epsilon_2 = 0.12$, $\\Delta \\phi = \\pi$。\n- 情况 4（两个不相关的螺旋模式，通用相位）：\n  $(m_1,n_1) = (3,1)$, $(m_2,n_2) = (4,7)$, $\\epsilon_1 = 0.07$, $\\epsilon_2 = 0.05$, $\\Delta \\phi = \\pi/3$。\n\n最终输出规范：\n你的程序应生成单行输出，其中包含一个方括号内的逗号分隔列表，该列表按顺序串联了每个情况的两个浮点数 $R$ 和 $Q$：\n$$\n[\\;R_1,Q_1,R_2,Q_2,R_3,Q_3,R_4,Q_4\\;].\n$$\n所有输出值都是无量纲的。角度在内部必须以弧度处理。不应打印任何其他文本。", "solution": "该问题要求对仿星器磁通面上磁场强度 $B$ 的简化模型进行数值分析。目标是量化场中两个螺旋傅里叶模式之间的相对相位 $\\Delta\\phi$ 如何影响其等值线的方向，这可作为准等动力学（QI）性质的代理指标。解决方案涉及将域离散化、计算偏导数，并评估两个特定的度量：方向比 $R$ 和 QI 品质指数 $Q$。\n\n由 Boozer 坐标 $(\\theta, \\zeta)$ 描述的磁通面上的磁场强度 $B$ 建模为：\n$$\nB(\\theta,\\zeta) = B_0\\left[1 + \\epsilon_1 \\cos\\left(m_1 \\theta - n_1 \\zeta + \\phi_1\\right) + \\epsilon_2 \\cos\\left(m_2 \\theta - n_2 \\zeta + \\phi_2\\right)\\right]\n$$\n此处，$\\theta$ 是角向角，$\\zeta$ 是环向角，两者都在 $[0, 2\\pi)$ 范围内。参数 $B_0, \\epsilon_1, \\epsilon_2, m_1, n_1, m_2, n_2, \\phi_1, \\phi_2$ 是定义特定磁位形的常数。通过改变这些参数，对四种不同情况进行分析。\n\n分析等值线拓扑结构的基本原理是，标量场 $\\nabla B(\\theta, \\zeta)$ 的梯度处处垂直于该场的等值线（$B$ 为常数的线）。在 $(\\theta, \\zeta)$ 坐标系中，梯度向量为 $\\nabla B = (\\partial B / \\partial \\theta) \\hat{\\theta} + (\\partial B / \\partial \\zeta) \\hat{\\zeta}$。局部等值线的切向量 $\\mathbf{t}$ 必须与 $\\nabla B$ 正交。一个方便的切向量选择是 $\\mathbf{t} = (\\partial B / \\partial \\theta) \\hat{\\theta} - (\\partial B / \\partial \\zeta) \\hat{\\zeta}$，或以分量形式表示，与 $(-\\partial B/\\partial \\zeta, \\partial B/\\partial \\theta)$ 成正比。本问题在磁通面的 $(\\theta, \\zeta)$ 平面表示中使用此分量形式。\n\n算法流程如下：\n\n1.  **离散化**：将连续域 $(\\theta, \\zeta) \\in [0, 2\\pi) \\times [0, 2\\pi)$ 离散化为 $N_\\theta \\times N_\\zeta$ 个点的均匀网格，其中 $N_\\theta = N_\\zeta = 256$。网格坐标为 $\\theta_i = 2\\pi i/N_\\theta$ 和 $\\zeta_j = 2\\pi j/N_\\zeta$。在每个点 $(\\theta_i, \\zeta_j)$ 上计算场 $B(\\theta, \\zeta)$，以生成一个 $256 \\times 256$ 的矩阵。\n\n2.  **数值微分**：为确定切向量，需要偏导数 $\\partial B/\\partial \\theta$ 和 $\\partial B/\\partial \\zeta$。这些偏导数使用带周期性边界条件的二阶中心差分格式来近似。对于网格点 $(i, j)$，导数为：\n    $$\n    \\frac{\\partial B}{\\partial \\theta}\\Big|_{i,j} \\approx \\frac{B_{i+1,j} - B_{i-1,j}}{2\\Delta \\theta}, \\quad \\frac{\\partial B}{\\partial \\zeta}\\Big|_{i,j} \\approx \\frac{B_{i,j+1} - B_{i,j-1}}{2\\Delta \\zeta}\n    $$\n    其中 $\\Delta\\theta = 2\\pi/N_\\theta$ 且 $\\Delta\\zeta = 2\\pi/N_\\zeta$。周期性通过环绕网格索引来处理（例如，$i=N_\\theta$ 变为 $i=0$）。在实现中，这可以通过使用 `numpy.roll` 来高效完成。\n\n3.  **切向量归一化和掩码**：逐点计算归一化的切向量分量 $(t_\\theta, t_\\zeta)$。$\\theta$ 分量为 $t_\\theta$，$\\zeta$ 分量为 $t_\\zeta$：\n    $$\n    t_\\theta = \\frac{\\partial B/\\partial \\theta}{\\sqrt{\\left(\\partial B/\\partial \\theta\\right)^2 + \\left(\\partial B/\\partial \\zeta\\right)^2}}, \\quad t_\\zeta = \\frac{-\\partial B/\\partial \\zeta}{\\sqrt{\\left(\\partial B/\\partial \\theta\\right)^2 + \\left(\\partial B/\\partial \\zeta\\right)^2}}\n    $$\n    在 $\\nabla B = 0$ 的点（即 $B$ 的局部极值点或鞍点），切线未定义。为防止数值不稳定性（除以零）并仅分析具有明确定义的等值线的区域，梯度大小非常小的点被排除。创建一个掩码以仅保留梯度大小超过阈值的点：\n    $$\n    \\sqrt{\\left(\\frac{\\partial B}{\\partial \\theta}\\right)^2 + \\left(\\frac{\\partial B}{\\partial \\zeta}\\right)^2} > f \\cdot \\max_{\\text{grid}} \\sqrt{\\left(\\frac{\\partial B}{\\partial \\theta}\\right)^2 + \\left(\\frac{\\partial B}{\\partial \\zeta}\\right)^2}\n    $$\n    其中分数 $f$ 设为 $10^{-3}$。所有后续计算都仅在这个“保留”点子集上执行。\n\n4.  **度量计算**：在保留点的集合上计算两个度量，以量化 QI 趋势。\n    -   **方向比** $R$ 是平均绝对环向切向分量与平均绝对角向切向分量的比值：\n        $$\n        R = \\frac{\\langle |t_\\zeta| \\rangle}{\\langle |t_\\theta| \\rangle}\n        $$\n        $R  1$ 的值表示，平均而言，等值线与角向（$\\theta$）方向的对齐程度高于环向（$\\zeta$）方向。\n    -   **QI 品质指数** $Q$ 测量的是切向量更偏向角向而非环向的保留点所占的比例：\n        $$\n        Q = \\frac{\\#\\{\\text{points where } |t_\\zeta|  |t_\\theta|\\}}{\\text{Total } \\# \\text{ of retained points}}\n        $$\n        接近 1 的 $Q$ 值表示角向闭合等值线的强烈普遍性，这是准等动力学位形的一个关键特征。\n\n对于四个测试用例中的每一个，都执行这些步骤，并计算得到的无量纲度量对 $(R, Q)$。最终输出将这些结果串联成一个列表。", "answer": "```python\nimport numpy as np\n\ndef calculate_metrics(params):\n    \"\"\"\n    Calculates QI metrics for a given set of magnetic field parameters.\n    \"\"\"\n    m1, n1, m2, n2, eps1, eps2, delta_phi = params\n\n    # 1. Discretization\n    N = 256\n    phi1 = 0.0\n    B0 = 1.0\n    f = 1e-3\n    \n    theta_vals = (2 * np.pi / N) * np.arange(N)\n    zeta_vals = (2 * np.pi / N) * np.arange(N)\n    THETA, ZETA = np.meshgrid(theta_vals, zeta_vals, indexing='ij')\n\n    delta_theta = 2 * np.pi / N\n    delta_zeta = 2 * np.pi / N\n\n    # 2. Evaluate B on the grid\n    arg1 = m1 * THETA - n1 * ZETA + phi1\n    arg2 = m2 * THETA - n2 * ZETA + delta_phi\n    B = B0 * (1.0 + eps1 * np.cos(arg1) + eps2 * np.cos(arg2))\n\n    # 3. Approximate partial derivatives using central differences\n    # np.roll handles periodic boundary conditions efficiently.\n    # axis=0 corresponds to theta, axis=1 corresponds to zeta due to indexing='ij'.\n    dB_dtheta = (np.roll(B, -1, axis=0) - np.roll(B, 1, axis=0)) / (2 * delta_theta)\n    dB_dzeta = (np.roll(B, -1, axis=1) - np.roll(B, 1, axis=1)) / (2 * delta_zeta)\n\n    # Calculate gradient magnitude\n    grad_B_mag = np.sqrt(dB_dtheta**2 + dB_dzeta**2)\n    \n    # 5. Define mask to exclude points with small gradients\n    max_grad_mag = np.max(grad_B_mag)\n    if max_grad_mag == 0:\n        return 0.0, 0.0 # Field is constant, no contours to analyze.\n    \n    threshold = f * max_grad_mag\n    mask = grad_B_mag > threshold\n\n    num_total_retained = np.sum(mask)\n    if num_total_retained == 0:\n        return 0.0, 0.0 # No points passed the threshold.\n    \n    # Apply mask to select only retained points\n    grad_theta_retained = dB_dtheta[mask]\n    grad_zeta_retained = dB_dzeta[mask]\n    grad_mag_retained = grad_B_mag[mask]\n    \n    # 4. Calculate normalized tangent components for retained points\n    t_theta = grad_theta_retained / grad_mag_retained\n    t_zeta = -grad_zeta_retained / grad_mag_retained\n\n    # 6. Compute scalar metrics\n    # Orientation Ratio R\n    mean_abs_t_theta = np.mean(np.abs(t_theta))\n    if mean_abs_t_theta == 0:\n        # Avoid division by zero if all tangents are purely toroidal.\n        R = np.inf if np.mean(np.abs(t_zeta)) > 0 else 0.0\n    else:\n        R = np.mean(np.abs(t_zeta)) / mean_abs_t_theta\n    \n    # QI Quality Index Q\n    num_qi_points = np.sum(np.abs(t_zeta)  np.abs(t_theta))\n    Q = num_qi_points / num_total_retained\n    \n    return R, Q\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print results.\n    \"\"\"\n    # Test suite parameters\n    test_cases = [\n        # Case 1: (m1,n1)=(2,5), (m2,n2)=(2,-5), e1=0.08, e2=0.08, dphi=0\n        (2, 5, 2, -5, 0.08, 0.08, 0.0),\n        # Case 2: (m1,n1)=(2,5), (m2,n2)=(2,-5), e1=0.08, e2=0.08, dphi=pi/2\n        (2, 5, 2, -5, 0.08, 0.08, np.pi / 2),\n        # Case 3: (m1,n1)=(2,5), (m2,n2)=(1,0), e1=0.06, e2=0.12, dphi=pi\n        (2, 5, 1, 0, 0.06, 0.12, np.pi),\n        # Case 4: (m1,n1)=(3,1), (m2,n2)=(4,7), e1=0.07, e2=0.05, dphi=pi/3\n        (3, 1, 4, 7, 0.07, 0.05, np.pi / 3),\n    ]\n\n    results = []\n    for case in test_cases:\n        R, Q = calculate_metrics(case)\n        results.append(R)\n        results.append(Q)\n\n    # Format and print the final output as a single line\n    print(f\"[{','.join(f'{x:.8f}' for x in results)}]\")\n\nsolve()\n```", "id": "3715773"}, {"introduction": "在理解了如何构造磁场几何形态后，下一步是探究其背后的物理动机。本练习将深入探讨准等动力学设计的核心原理：对捕获粒子的约束。通过为不同的磁场模型计算并比较第二绝热不变量 $J_{\\parallel}$ 的变化，您将直接量化为何准等动力学设计在减少粒子漂移损失方面表现更优越 [@problem_id:3715774]。", "problem": "给定两个无量纲的模型磁场谱，一个用于表示准对称 (QS) 位形，另一个用于表示准等动力 (QI) 位形。这两个磁场谱定义在一个由角向角 $\\theta$ 和环向角 $\\zeta$（单位均为弧度）参数化的环面上。QS 模型使用单个螺旋谐波，而 QI 模型主要使用环向变化并带有弱角向变化。磁力线标签为 $\\alpha = \\theta - \\iota \\,\\zeta$，其中 $\\iota$ 是旋转变换，因此沿着一条磁力线有 $\\theta(\\zeta) = \\alpha + \\iota \\,\\zeta$。在无量纲导心理论中，对于一个能量为 $E$、螺距参数为 $\\lambda$ 的无量纲捕获粒子，其第二绝热不变量 $J_{\\parallel}$ 定义为反弹积分 $J_{\\parallel}(\\alpha, E, \\lambda) = \\oint v_{\\parallel} \\, dl$。其中，平行速度为 $v_{\\parallel}(\\zeta) = \\sqrt{2E}\\,\\sqrt{\\max\\{0,\\,1 - \\lambda \\, B(\\theta(\\zeta),\\zeta)\\}}$，为简化起见，线元因子取为 $dl/d\\zeta = 1$。所有角度均使用弧度单位，并将所有物理量视为无量纲。\n\n您的任务是，对多个测试案例，计算两种磁场谱的导数 $\\partial J_{\\parallel} / \\partial \\alpha$ 的数值中心有限差分近似值，然后通过比较这些导数的幅值来评估哪种设计能更好地约束捕获粒子。$\\partial J_{\\parallel} / \\partial \\alpha$ 的幅值越小，意味着对捕获粒子的约束越好。\n\n使用以下磁场谱，其参数对于一个简化模型是科学上合理且自洽的：\n- QS 谱：$B_{\\mathrm{QS}}(\\theta,\\zeta) = B_0 \\left[ 1 + \\varepsilon \\cos(m\\,\\theta - n\\,\\zeta) \\right]$。\n- QI 谱：$B_{\\mathrm{QI}}(\\theta,\\zeta) = B_0 \\left[ 1 + \\varepsilon_{\\zeta}\\cos(n\\,\\zeta) + \\varepsilon_{\\theta}\\cos(m\\,\\theta) \\right]$。\n\n使用 $B_0 = 1$, $\\varepsilon = 0.3$, $\\varepsilon_{\\zeta} = 0.25$, $\\varepsilon_{\\theta} = 0.05$, $m = 1$, $n = 4$ 和 $\\iota = 0.45$。这些选择使得两种谱具有相同的极值，即 $B_{\\min} \\approx 0.7$ 和 $B_{\\max} \\approx 1.3$，从而确保对于所选的螺距，两种设计中的捕获粒子条件是可比的。\n\n将反弹不变量数值化定义为\n$$\nJ_{\\parallel}(\\alpha, E, \\lambda) = 2 \\sqrt{2E}\\,\\int_{0}^{2\\pi} \\sqrt{\\max\\{0,\\,1 - \\lambda\\,B(\\alpha + \\iota \\zeta, \\zeta)\\}}\\, d\\zeta,\n$$\n该式对平行速度的正值部分在一个完整周期上进行积分，并将结果加倍以覆盖两个反弹转折点之间的完整反弹周期。通过中心差分近似导数\n$$\n\\frac{\\partial J_{\\parallel}}{\\partial \\alpha}(\\alpha, E, \\lambda) \\approx \\frac{J_{\\parallel}(\\alpha + \\delta\\alpha, E, \\lambda) - J_{\\parallel}(\\alpha - \\delta\\alpha, E, \\lambda)}{2\\,\\delta\\alpha},\n$$\n其中 $\\delta\\alpha$ 是一个很小的步长。\n\n使用在 $\\zeta \\in [0, 2\\pi]$ 上的均匀网格实现数值积分，该网格应具有足够精细的分辨率以捕捉由磁场谱引起的的反弹转折点。使用 $\\delta\\alpha = 10^{-4}$ 和一个在 $\\zeta$ 上包含 $N = 20001$ 个点的网格。\n\n对于下面的每个测试案例，计算两种谱的 $\\left|\\partial J_{\\parallel}/\\partial \\alpha\\right|$，并输出一个布尔值，该布尔值指示 QI 谱是否产生比 QS 谱严格更小的幅值（true 表示在该案例中 QI 更好）。如果在给定案例中，粒子在任一谱中都未被捕获，则在计算中设置 $J_{\\parallel} = 0$，这将导致导数为 $0$，然后按前述方式进行比较。\n\n参数三元组 $(\\alpha, E, \\lambda)$ 的测试套件，所有参数均为无量纲，角度单位为弧度：\n1. $(\\alpha, E, \\lambda) = (0.7, 0.5, 1.0)$，一个典型的捕获案例。\n2. $(\\alpha, E, \\lambda) = (2.2, 1.5, 1.3)$，一个接近捕获上边界的案例。\n3. $(\\alpha, E, \\lambda) = (3.0, 0.2, 0.77)$，一个接近捕获下边界的案例。\n4. $(\\alpha, E, \\lambda) = (1.1, 1.0, 0.9)$，另一个典型的捕获案例。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，例如 $[\\text{result}_1,\\text{result}_2,\\text{result}_3,\\text{result}_4]$，其中每个条目是对应于相应测试案例的布尔值。", "solution": "该问题要求比较两种简化的仿星器磁场位形中的捕获粒子约束：准对称 (QS) 模型和准等动力 (QI) 模型。所测试的核心原理是，当第二绝热不变量 $J_{\\parallel}$ 在给定磁通面上近似恒定时，磁约束聚变装置能实现对捕获粒子的更优约束。磁通面是磁力线所在的曲面。在这个简化模型中，磁力线标签 $\\alpha$ 作为磁通面上垂直于磁力线本身的空间坐标的代表。因此，更好的约束对应于 $J_{\\parallel}$ 相对于 $\\alpha$ 的梯度幅值更小，即 $|\\partial J_{\\parallel}/\\partial\\alpha|$ 的值更小。我们的任务是，对于一组给定的测试参数，计算 QS 和 QI 两种磁场谱的这个量，并确定哪种位形产生更小的值，从而表明其在约束捕获粒子方面具有更好的性能。\n\n首先，我们定义问题的数学组成部分。磁力线的轨迹由 $\\theta(\\zeta) = \\alpha + \\iota\\,\\zeta$ 给出，其中 $\\theta$ 是角向角，$\\zeta$ 是环向角，$\\alpha$ 是磁力线标签，$\\iota$ 是旋转变换。所有角度均以弧度为单位。\n\n两种模型磁场谱如下：\n1.  准对称 (QS) 谱：$B_{\\mathrm{QS}}(\\theta,\\zeta) = B_0 \\left[ 1 + \\varepsilon \\cos(m\\,\\theta - n\\,\\zeta) \\right]$。该形式依赖于单个螺旋角 $m\\theta - n\\zeta$，这是准对称设计的特征。\n2.  准等动力 (QI) 谱：$B_{\\mathrm{QI}}(\\theta,\\zeta) = B_0 \\left[ 1 + \\varepsilon_{\\zeta}\\cos(n\\,\\zeta) + \\varepsilon_{\\theta}\\cos(m\\,\\theta) \\right]$。该形式以环向变化为主导，是某些准等动力设计的特点。\n\n问题指定了以下无量纲参数：$B_0 = 1$, $\\varepsilon = 0.3$, $\\varepsilon_{\\zeta} = 0.25$, $\\varepsilon_{\\theta} = 0.05$, $m = 1$, $n = 4$ 和 $\\iota = 0.45$。\n\n对于能量为 $E$、螺距参数为 $\\lambda$ 的捕获粒子，其第二绝热不变量 $J_{\\parallel}$ 由其平行速度 $v_{\\parallel}$ 沿磁力线的反弹积分定义。问题提供了一个特定的数值公式，该公式在一个完整的环向周期 ($\\zeta \\in [0, 2\\pi]$) 上进行积分，并将结果加倍以计及两个转折点之间的完整反弹运动：\n$$\nJ_{\\parallel}(\\alpha, E, \\lambda) = 2 \\sqrt{2E}\\,\\int_{0}^{2\\pi} \\sqrt{\\max\\{0,\\,1 - \\lambda\\,B(\\alpha + \\iota \\zeta, \\zeta)\\}}\\, d\\zeta\n$$\n$\\max\\{0, \\dots\\}$ 项确保了在粒子被反射的区域（即 $1 - \\lambda B \\le 0$ 的区域，这些区域在捕获阱之外），被积函数为零。如果一个粒子完全不被捕获（即对于所有 $\\zeta$，都有 $1 - \\lambda B \\le 0$），该积分将正确地得出 $J_{\\parallel} = 0$。\n\n为了评估约束质量，我们必须计算导数 $\\partial J_{\\parallel}/\\partial\\alpha$。我们将使用步长 $\\delta\\alpha$ 很小的中心有限差分近似：\n$$\n\\frac{\\partial J_{\\parallel}}{\\partial \\alpha}(\\alpha, E, \\lambda) \\approx \\frac{J_{\\parallel}(\\alpha + \\delta\\alpha, E, \\lambda) - J_{\\parallel}(\\alpha - \\delta\\alpha, E, \\lambda)}{2\\,\\delta\\alpha}\n$$\n问题指定步长为 $\\delta\\alpha = 10^{-4}$。\n\n数值计算步骤如下：\n1.  对于四个测试案例 $(\\alpha, E, \\lambda)$ 中的每一个，以及对于每一种磁场谱（$B_{\\mathrm{QS}}$ 和 $B_{\\mathrm{QI}}$），我们将计算 $J_{\\parallel}$。\n2.  $J_{\\parallel}$ 的积分将使用梯形法则，在 $\\zeta$ 的范围 $[0, 2\\pi]$ 上一个包含 $N=20001$ 个点的精细均匀网格上进行数值计算。\n3.  为了计算导数 $\\partial J_{\\parallel}/\\partial\\alpha$，我们在磁力线标签的两个微扰值 $\\alpha + \\delta\\alpha$ 和 $\\alpha - \\delta\\alpha$ 处计算 $J_{\\parallel}$。\n4.  然后我们将这两个值代入中心差分公式，得到 $\\partial J_{\\parallel}/\\partial\\alpha$ 的近似值。\n5.  最后，我们取两种谱的导数的绝对值，即 $|\\partial J_{\\parallel}/\\partial\\alpha|_{\\mathrm{QS}}$ 和 $|\\partial J_{\\parallel}/\\partial\\alpha|_{\\mathrm{QI}}$。\n6.  每个测试案例的结果是一个布尔值，指示 QI 位形是否更优，当且仅当 $|\\partial J_{\\parallel}/\\partial\\alpha|_{\\mathrm{QI}}  |\\partial J_{\\parallel}/\\partial\\alpha|_{\\mathrm{QS}}$ 时为真。整个过程将通过一个 Python 脚本实现，并严格遵守指定的库和格式。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes and compares the gradient of the second adiabatic invariant for\n    Quasi-Symmetric (QS) and Quasi-Isodynamic (QI) stellarator magnetic fields.\n    \"\"\"\n\n    # Define physical and numerical constants from the problem statement\n    B0 = 1.0\n    EPSILON = 0.3\n    EPSILON_ZETA = 0.25\n    EPSILON_THETA = 0.05\n    M_MODE = 1\n    N_MODE = 4\n    IOTA = 0.45\n    \n    # Numerical parameters for the calculation\n    DELTA_ALPHA = 1e-4\n    N_POINTS = 20001\n    \n    # Define the grid for the toroidal angle zeta\n    ZETA_GRID = np.linspace(0, 2 * np.pi, N_POINTS)\n\n    # Define the model magnetic field spectra\n    def b_qs(theta, zeta):\n        \"\"\"QS spectrum: B = B0 * (1 + epsilon * cos(m*theta - n*zeta))\"\"\"\n        return B0 * (1 + EPSILON * np.cos(M_MODE * theta - N_MODE * zeta))\n\n    def b_qi(theta, zeta):\n        \"\"\"QI spectrum: B = B0 * (1 + epsilon_zeta*cos(n*zeta) + epsilon_theta*cos(m*theta))\"\"\"\n        return B0 * (1 + EPSILON_ZETA * np.cos(N_MODE * zeta) + EPSILON_THETA * np.cos(M_MODE * theta))\n\n    def compute_j_parallel(b_func, alpha, E, lambda_val):\n        \"\"\"\n        Computes the second adiabatic invariant J_parallel numerically.\n        The variable lambda is a keyword in Python, so lambda_val is used.\n        \"\"\"\n        if E == 0:\n            return 0.0\n            \n        # Calculate theta along the field line for the given alpha\n        theta = alpha + IOTA * ZETA_GRID\n        \n        # Calculate the magnetic field strength along the field line\n        b_values = b_func(theta, ZETA_GRID)\n        \n        # Calculate the integrand for J_parallel, handling the turning points\n        integrand = np.sqrt(np.maximum(0, 1 - lambda_val * b_values))\n        \n        # Perform the numerical integration using the trapezoidal rule\n        integral_val = np.trapz(integrand, ZETA_GRID)\n        \n        # Final formula for J_parallel\n        return 2 * np.sqrt(2 * E) * integral_val\n\n    # Define the test cases from the problem statement\n    test_cases = [\n        (0.7, 0.5, 1.0),  # Case 1\n        (2.2, 1.5, 1.3),  # Case 2\n        (3.0, 0.2, 0.77), # Case 3\n        (1.1, 1.0, 0.9),  # Case 4\n    ]\n\n    results = []\n    for alpha, E, lambda_val in test_cases:\n        # --- QS Calculation ---\n        # J_parallel for alpha + delta_alpha\n        j_plus_qs = compute_j_parallel(b_qs, alpha + DELTA_ALPHA, E, lambda_val)\n        # J_parallel for alpha - delta_alpha\n        j_minus_qs = compute_j_parallel(b_qs, alpha - DELTA_ALPHA, E, lambda_val)\n        # Central difference for the derivative\n        dj_dalpha_qs = (j_plus_qs - j_minus_qs) / (2 * DELTA_ALPHA)\n\n        # --- QI Calculation ---\n        # J_parallel for alpha + delta_alpha\n        j_plus_qi = compute_j_parallel(b_qi, alpha + DELTA_ALPHA, E, lambda_val)\n        # J_parallel for alpha - delta_alpha\n        j_minus_qi = compute_j_parallel(b_qi, alpha - DELTA_ALPHA, E, lambda_val)\n        # Central difference for the derivative\n        dj_dalpha_qi = (j_plus_qi - j_minus_qi) / (2 * DELTA_ALPHA)\n        \n        # Compare the magnitudes of the derivatives\n        # A smaller magnitude implies better confinement\n        is_qi_better = np.abs(dj_dalpha_qi)  np.abs(dj_dalpha_qs)\n        results.append(is_qi_better)\n\n    # Format the output as a comma-separated list of booleans in brackets\n    # The str() of a boolean is 'True' or 'False' (capitalized)\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3715774"}, {"introduction": "最后，我们将物理原理置于真实的工程背景之中。设计聚变反应堆不仅要实现理想的物理性能，它还是一个必须在性能与可行性之间取得平衡的多目标挑战。这最后一个练习 [@problem_id:3715782] 将引导您体验这种权衡，要求您在准等动力学约束质量和磁体线圈复杂度的代理指标之间进行权衡，以找到一个最优的设计方案。", "problem": "您的任务是构建并评估一个简化的、但有物理基础的多目标优化问题，以量化准等动力（QI）仿星器指标与线圈复杂度之间的权衡。目标是确定哪种由一小组傅里叶谐波表示的磁场设计，在指定的权重下，能够最好地平衡趋向准等动力行为的趋势与线圈设计的简易性。您最终的程序必须实现所述的公式，并生成一个单行结果，该结果汇总了所有给定测试用例的答案。\n\n从导心不变量和 Boozer 坐标中磁力线标记的定义开始。使用以下基本基础：\n\n- 第二绝热不变量 $J_{\\parallel}$ 定义为弹跳积分 $J_{\\parallel} = \\oint v_{\\parallel} \\, \\mathrm{d}l$，其中 $v_{\\parallel}$ 是粒子速度的平行分量，$l$ 是沿磁力线的坐标。\n- 准等动力（QI）要求可以表示为 $J_{\\parallel}$ 相对于磁力线标签的变化很小，即 $|\\partial J_{\\parallel} / \\partial \\alpha|$ 很小，其中 $\\alpha$ 是 Boozer 磁力线标签。\n- 在 Boozer 坐标中，使用 $\\alpha = \\theta - \\iota \\, \\zeta$，其中 $\\theta$ 是角向角，$\\zeta$ 是环向角，$\\iota$ 是旋转变换。\n- 假设磁通面上的磁场强度模型由截断的傅里叶级数给出：\n$$\nB(\\theta,\\zeta) = B_0 \\left( 1 + \\sum_{k=1}^{K} A_k \\cos(m_k \\theta - n_k \\zeta) \\right),\n$$\n其中 $B_0$ 是参考磁场强度，$(m_k,n_k)$ 是整数谐波指数，$A_k$ 是对应的振幅。取 $B_0 = 1$（无量纲单位）。\n- 假设粒子速度已归一化为 $v=1$，并定义螺距参数 $\\lambda$ 使得 $v_{\\parallel}^2 = 1 - \\lambda B(\\theta,\\zeta)$。通过设置 $v_{\\parallel}(\\theta,\\zeta) = \\sqrt{\\max\\{0,\\,1 - \\lambda B(\\theta,\\zeta)\\}}$ 来模拟捕获-通行行为。\n\n将 QI 变化度量构建为 $J_{\\parallel}$ 相对于 $\\alpha$ 的导数在 $\\alpha$ 值均匀网格上的均方根：\n$$\nQ = \\sqrt{\\frac{1}{N_\\alpha} \\sum_{j=1}^{N_\\alpha} \\left( \\frac{\\partial J_{\\parallel}(\\alpha_j)}{\\partial \\alpha} \\right)^2 },\n$$\n其中导数使用有限差分法进行近似，并在 $\\alpha \\in [0,2\\pi)$ 上采用周期性边界条件。\n\n使用磁力线映射 $\\theta(\\zeta) = \\alpha + \\iota \\zeta$ 和一个恒定的线元因子，通过沿由 $\\zeta \\in [0,2\\pi)$ 参数化的磁力线积分来近似 $J_{\\parallel}(\\alpha)$，使得：\n$$\nJ_{\\parallel}(\\alpha) \\approx \\int_0^{2\\pi} \\sqrt{\\max\\{0,\\,1 - \\lambda B(\\alpha + \\iota \\zeta,\\,\\zeta)\\}} \\,\\mathrm{d}\\zeta,\n$$\n在所述的归一化条件下，该式是无量纲的。角度单位使用弧度。\n\n通过加权振幅平方和来定义一个线圈复杂度代理指标：\n$$\nC = \\sum_{k=1}^{K} w_k A_k^2, \\quad \\text{其中} \\quad w_k = m_k^2 + n_k^2,\n$$\n这会惩罚高阶谐波，从而代表增加的线圈复杂度。\n\n为每个候选设计构建一个加权和多目标标量化成本：\n$$\n\\Phi = w_{\\text{QI}} \\, \\tilde{Q} + w_{\\text{coil}} \\, \\tilde{C},\n$$\n其中 $\\tilde{Q}$ 和 $\\tilde{C}$ 是在同一测试用例下，对所有被比较的候选设计进行最小-最大归一化后的值，\n$$\n\\tilde{Q} = \\frac{Q - Q_{\\min}}{Q_{\\max} - Q_{\\min} + \\epsilon}, \\quad \\tilde{C} = \\frac{C - C_{\\min}}{C_{\\max} - C_{\\min} + \\epsilon},\n$$\n其中有一个小的 $\\epsilon$ 以避免除以零。这种归一化确保了权重 $w_{\\text{QI}}$ 和 $w_{\\text{coil}}$ 在两个目标的可比尺度上运作。所有量均为无量纲。\n\n您的程序必须评估以下固定的谐波集和候选振幅向量：\n- 谐波集（相位设为零）：对于 $k=1,\\dots,5$，有 $(m_k,n_k) \\in \\{(1,0),(0,1),(1,1),(2,1),(2,3)\\}$。\n- 候选振幅向量 $\\mathbf{A}$：\n    1. $\\mathbf{A}^{(0)} = [0.02, 0.03, 0.04, 0.00, 0.00]$\n    2. $\\mathbf{A}^{(1)} = [0.05, 0.03, 0.08, 0.04, 0.02]$\n    3. $\\mathbf{A}^{(2)} = [0.01, 0.02, 0.06, 0.00, 0.03]$\n    4. $\\mathbf{A}^{(3)} = [0.00, 0.00, 0.10, 0.00, 0.00]$\n\n使用以下测试用例套件，每个用例由 $(w_{\\text{QI}}, w_{\\text{coil}}, \\iota, \\lambda)$ 定义：\n- 用例 1（平衡）：$(0.6, 0.4, 0.9, 0.7)$\n- 用例 2（仅QI）：$(1.0, 0.0, 0.9, 0.7)$\n- 用例 3（仅线圈）：$(0.0, 1.0, 0.9, 0.7)$\n- 用例 4（近弹跳点强调）：$(0.6, 0.4, 0.5, 0.85)$\n\n对于数值实现：\n- 在 $[0,2\\pi)$ 上使用 $N_{\\alpha} = 64$ 个等距样本。\n- 对于 $J_{\\parallel}(\\alpha)$ 的积分近似，在 $[0,2\\pi)$ 上使用 $N_{\\zeta} = 512$ 个等距样本。\n- 使用周期性中心差分从离散的 $J_{\\parallel}(\\alpha_j)$ 序列来近似 $\\partial J_{\\parallel}/\\partial \\alpha$。\n\n任务：\n- 对于每个测试用例，为每个候选振幅向量计算标量化成本 $\\Phi$。\n- 找出在该测试用例中使 $\\Phi$ 最小化的候选索引（使用与上述列表一致的从零开始的索引）。\n\n角度单位必须是弧度。所有计算量均为无量纲。您的程序应生成单行输出，其中包含四个测试用例的最小化候选者索引，格式为用方括号括起来的逗号分隔列表，例如 $[\\text{idx}_1,\\text{idx}_2,\\text{idx}_3,\\text{idx}_4]$。", "solution": "经评估，用户提供的问题是 **有效的**。这是一个在仿星器等离子体物理领域内的、适定的、有科学依据的计算问题。所有必要的参数、方程和约束都已提供，从而可以得到一个唯一且可验证的解。其基础模型虽然是对真实世界设计问题的简化，但它基于磁约束聚变的既定原理，包括 Boozer 坐标、第二绝热不变量和磁场的傅里叶表示。任务是实现一个指定的多目标优化算法，以便在不同的权重情景下，从一组候选者中确定最佳的磁场配置。\n\n问题的核心是实现一个计算过程，该过程针对四个测试用例中的每一个，确定四个候选仿星器磁场设计中的哪一个是最优的。最优性通过最小化标量化成本函数 $\\Phi$ 来定义，该函数代表了基于物理的准等动力（QI）质量指标 $Q$ 与工程线圈复杂度代理指标 $C$ 之间的加权权衡。\n\n该过程可分解为以下逻辑步骤，并将为每个测试用例实施。\n\n**1. 候选设计和目标函数的定义**\n\n四个候选设计中的每一个都由一个傅里叶振幅向量 $\\mathbf{A} = [A_1, \\dots, A_5]$ 定义，对应一组固定的谐波模数 $(m_k, n_k)$。总成本函数由下式给出：\n$$\n\\Phi = w_{\\text{QI}} \\, \\tilde{Q} + w_{\\text{coil}} \\, \\tilde{C}\n$$\n此处，$w_{\\text{QI}}$ 和 $w_{\\text{coil}}$ 是由测试用例指定的权重。$\\tilde{Q}$ 和 $\\tilde{C}$ 分别是 QI 指标和线圈复杂度指标的归一化值。\n\n**2. 线圈复杂度指标（$C$）的计算**\n\n线圈复杂度指标 $C$ 是一个代理指标，它对具有较高模数的磁场谐波进行惩罚，因为这些谐波通常需要更复杂且难以制造的磁体线圈。它被计算为振幅平方的加权和：\n$$\nC = \\sum_{k=1}^{K} w_k A_k^2, \\quad \\text{其中} \\quad w_k = m_k^2 + n_k^2\n$$\n固定的谐波模数为 $(m_k,n_k) \\in \\{(1,0),(0,1),(1,1),(2,1),(2,3)\\}$。相应的权重为 $w_k \\in \\{1, 1, 2, 5, 13\\}$。对四个候选振幅向量 $\\mathbf{A}^{(0)}, \\mathbf{A}^{(1)}, \\mathbf{A}^{(2)}, \\mathbf{A}^{(3)}$ 中的每一个计算 $C$ 的值。由于此计算不依赖于测试用例参数 $(\\iota, \\lambda)$，因此可以预先计算这四个 $C$ 值。\n\n**3. 准等动力指标（$Q$）的计算**\n\nQI 指标 $Q$ 量化了与理想准等动力条件的偏差，该条件要求第二绝热不变量 $J_{\\parallel}$ 在磁通面上不发生变化。这种变化是相对于 Boozer 磁力线标签 $\\alpha = \\theta - \\iota \\zeta$ 来测量的。较小的 $Q$ 值表示对 QI 状态的更好近似。\n\n对于单个候选设计和给定的测试用例 $(\\iota, \\lambda)$， $Q$ 的计算涉及几个子步骤：\n\n**a. 离散化**：我们为磁力线标签建立一个包含 $N_{\\alpha}=64$ 个点的均匀网格 $\\alpha_j \\in [0, 2\\pi)$，并为环向角建立一个包含 $N_{\\zeta}=512$ 个点的均匀网格 $\\zeta_l \\in [0, 2\\pi)$，以执行数值积分和微分。\n\n**b. 计算 $J_{\\parallel}(\\alpha)$**：对于每个离散值 $\\alpha_j$，第二绝热不变量 $J_{\\parallel}$ 通过以下积分进行近似：\n$$\nJ_{\\parallel}(\\alpha_j) \\approx \\int_0^{2\\pi} \\sqrt{\\max\\{0,\\,1 - \\lambda B(\\alpha_j + \\iota \\zeta,\\,\\zeta)\\}} \\,\\mathrm{d}\\zeta\n$$\n该积分使用梯形法则进行数值计算。对于积分网格上的每个点 $\\zeta_l$，我们首先计算相应的角向角 $\\theta_l = \\alpha_j + \\iota \\zeta_l$。然后，使用其傅里叶级数表示来计算磁场强度 $B(\\theta_l, \\zeta_l)$：\n$$\nB(\\theta_l,\\zeta_l) = 1 + \\sum_{k=1}^{K} A_k \\cos(m_k \\theta_l - n_k \\zeta_l)\n$$\n被积函数 $\\sqrt{\\max\\{0, 1-\\lambda B\\}}$ 在每个 $\\zeta_l$ 处进行求值，然后将这些值求和并乘以步长 $d\\zeta = 2\\pi / N_{\\zeta}$，从而得到 $J_{\\parallel}(\\alpha_j)$。对所有 $j=1, \\dots, N_{\\alpha}$ 重复此过程，生成一个 $J_{\\parallel}$ 值的数组。\n\n**c. 计算导数 $\\partial J_{\\parallel} / \\partial \\alpha$**：使用周期性中心差分格式，从 $J_{\\parallel}(\\alpha_j)$ 值的离散数组中近似计算 $J_{\\parallel}$ 相对于 $\\alpha$ 的导数：\n$$\n\\frac{\\partial J_{\\parallel}}{\\partial \\alpha}\\bigg|_{\\alpha_j} \\approx \\frac{J_{\\parallel}(\\alpha_{j+1}) - J_{\\parallel}(\\alpha_{j-1})}{2 \\, d\\alpha}\n$$\n其中 $d\\alpha = 2\\pi / N_{\\alpha}$。在 $\\alpha$ 网格的端点应用周期性边界条件。\n\n**d. 计算 $Q$**：最后，QI 指标 $Q$ 计算为所求导数值的均方根：\n$$\nQ = \\sqrt{\\frac{1}{N_\\alpha} \\sum_{j=1}^{N_\\alpha} \\left( \\frac{\\partial J_{\\parallel}(\\alpha_j)}{\\partial \\alpha} \\right)^2 }\n$$\n\n对四个候选设计中的每一个都执行此完整过程，以获得当前测试用例的一组四个 $Q$ 值。\n\n**4. 归一化与优化**\n\n计算出四组原始值 $\\{C^{(i)}\\}_{i=0}^3$ 和 $\\{Q^{(i)}\\}_{i=0}^3$ 后，使用最小-最大缩放将它们分别归一化到 $[0, 1]$ 范围，以确保它们在进行加权求和时具有可比的基础：\n$$\n\\tilde{X} = \\frac{X - X_{\\min}}{X_{\\max} - X_{\\min} + \\epsilon}\n$$\n其中 $X$ 为 $Q$ 或 $C$，$\\epsilon$ 是一个小的正常数（例如，$10^{-9}$），用于在目标的所有值都相同的情况下防止除以零。\n\n然后，使用当前测试用例的权重 $w_{\\text{QI}}$ 和 $w_{\\text{coil}}$ 为每个候选者 $i$ 计算最终的标量化成本 $\\Phi^{(i)}$。与 $\\Phi^{(i)}$ 最小值相对应的索引 $i$ 被确定为该测试用例的最优选择。\n\n对所有四个测试用例重复此完整过程，并将得到的最优候选者索引汇总到一个最终列表中。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the stellarator design optimization problem by calculating the optimal\n    candidate index for each test case.\n    \"\"\"\n    # Define fixed problem parameters\n    harmonics_mn = np.array([(1, 0), (0, 1), (1, 1), (2, 1), (2, 3)])\n    m_k = harmonics_mn[:, 0]\n    n_k = harmonics_mn[:, 1]\n    \n    candidate_A = [\n        np.array([0.02, 0.03, 0.04, 0.00, 0.00]),\n        np.array([0.05, 0.03, 0.08, 0.04, 0.02]),\n        np.array([0.01, 0.02, 0.06, 0.00, 0.03]),\n        np.array([0.00, 0.00, 0.10, 0.00, 0.00]),\n    ]\n\n    test_cases = [\n        # (w_QI, w_coil, iota, lambda)\n        (0.6, 0.4, 0.9, 0.7),   # Case 1: balanced\n        (1.0, 0.0, 0.9, 0.7),   # Case 2: QI-only\n        (0.0, 1.0, 0.9, 0.7),   # Case 3: coil-only\n        (0.6, 0.4, 0.5, 0.85),  # Case 4: near-bounce emphasis\n    ]\n\n    # Numerical integration and differentiation parameters\n    N_alpha = 64\n    N_zeta = 512\n    epsilon = 1e-9\n\n    # --- Helper Functions ---\n\n    def calculate_C(A, m, n):\n        \"\"\"Calculates the coil complexity metric C.\"\"\"\n        w = m**2 + n**2\n        return np.sum(w * A**2)\n\n    def calculate_Q(A, m, n, iota, lambda_val):\n        \"\"\"Calculates the quasi-isodynamic metric Q.\"\"\"\n        alpha_grid = np.linspace(0, 2 * np.pi, N_alpha, endpoint=False)\n        zeta_grid = np.linspace(0, 2 * np.pi, N_zeta, endpoint=False)\n        d_zeta = 2 * np.pi / N_zeta\n        d_alpha = 2 * np.pi / N_alpha\n\n        J_parallel_values = np.zeros(N_alpha)\n\n        for j, alpha_j in enumerate(alpha_grid):\n            theta_vals = alpha_j + iota * zeta_grid\n\n            # Calculate B field strength across the zeta grid for this alpha\n            B_vals = np.ones_like(zeta_grid) # B0 = 1\n            for k in range(len(A)):\n                if A[k] != 0:\n                    B_vals += A[k] * np.cos(m[k] * theta_vals - n[k] * zeta_grid)\n            \n            # Calculate the integrand for J_parallel\n            integrand = np.sqrt(np.maximum(0, 1 - lambda_val * B_vals))\n            \n            # Approximate the integral using the trapezoidal rule (sum * step)\n            J_parallel_values[j] = np.sum(integrand) * d_zeta\n        \n        # Calculate derivative using periodic central differences\n        dJ_dalpha = (np.roll(J_parallel_values, -1) - np.roll(J_parallel_values, 1)) / (2 * d_alpha)\n        \n        # Calculate Q as the RMS of the derivative\n        Q = np.sqrt(np.mean(np.square(dJ_dalpha)))\n        return Q\n\n    def normalize(values):\n        \"\"\"Performs min-max normalization on a numpy array.\"\"\"\n        val_min = np.min(values)\n        val_max = np.max(values)\n        denominator = val_max - val_min + epsilon\n        if denominator = epsilon:\n            return np.zeros_like(values)\n        return (values - val_min) / denominator\n\n    # --- Main Calculation Loop ---\n    \n    # Pre-calculate C values as they are constant across test cases\n    c_values_all = np.array([calculate_C(A, m_k, n_k) for A in candidate_A])\n\n    results = []\n    for case in test_cases:\n        w_qi, w_coil, iota, lambda_val = case\n        \n        # Calculate Q values for each candidate for the current test case\n        q_values_case = np.array([calculate_Q(A, m_k, n_k, iota, lambda_val) for A in candidate_A])\n        \n        # Normalize Q and C values across the candidates for this case\n        q_norm = normalize(q_values_case)\n        c_norm = normalize(c_values_all)\n        \n        # Calculate the scalarized cost function Phi for each candidate\n        phi_values = w_qi * q_norm + w_coil * c_norm\n        \n        # Find the index of the candidate with the minimum cost\n        best_idx = np.argmin(phi_values)\n        results.append(best_idx)\n        \n    # Print the final result in the specified format\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3715782"}]}