{"hands_on_practices": [{"introduction": "在我们领会守恒与非守恒格式的数值差异之前，必须首先理解它们在数学结构上的根本区别。本练习将引导你对一维欧拉方程，分别在守恒变量和原始变量下，进行通量雅可比矩阵的解析推导。通过比较它们的结构和特征值，你将深刻理解这些矩阵中所蕴含的特征波传播信息，而这正是许多高级CFD格式的理论基石 ([@problem_id:3304162])。", "problem": "考虑量热完全气体的一维欧拉方程的守恒形式，\n$$\n\\frac{\\partial \\mathbf{U}}{\\partial t} + \\frac{\\partial \\mathbf{F}(\\mathbf{U})}{\\partial x} = 0,\n$$\n其中守恒变量矢量为 $\\mathbf{U} = \\begin{pmatrix} \\rho \\\\ \\rho u \\\\ \\rho E \\end{pmatrix}$，通量矢量为 $\\mathbf{F}(\\mathbf{U}) = \\begin{pmatrix} \\rho u \\\\ \\rho u^{2} + p \\\\ u(\\rho E + p) \\end{pmatrix}$，压力由理想气体闭合关系 $p = (\\gamma - 1)\\left(\\rho E - \\tfrac{1}{2}\\rho u^{2}\\right)$ 给出，其中 $\\gamma > 1$ 为常数，声速为 $c^{2} = \\gamma p / \\rho$。令原始变量矢量为 $\\mathbf{V} = \\begin{pmatrix} \\rho \\\\ u \\\\ p \\end{pmatrix}$。\n\n从这些定义和守恒律出发，完成以下任务：\n- 推导守恒变量下的通量雅可比矩阵 $\\mathbf{A}(\\mathbf{U}) = \\partial \\mathbf{F}/\\partial \\mathbf{U}$，并确定其特征值和一组相容的右特征矢量。\n- 计算转换矩阵 $\\mathbf{U}_{\\mathbf{V}} = \\partial \\mathbf{U}/\\partial \\mathbf{V}$，并用它得到与 $\\mathbf{V}$ 的演化相关的准线性原始变量雅可比矩阵 $\\mathbf{B}(\\mathbf{V}) = \\mathbf{U}_{\\mathbf{V}}^{-1}\\,\\mathbf{A}(\\mathbf{U})\\,\\mathbf{U}_{\\mathbf{V}}$。\n- 比较 $\\mathbf{A}(\\mathbf{U})$ 和 $\\mathbf{B}(\\mathbf{V})$ 的特征结构，并解释 $\\partial \\mathbf{F}/\\partial \\mathbf{V}$ 和 $\\mathbf{B}(\\mathbf{V})$ 之间的区别。\n作为该比较的一个标量度量，给出原始变量雅可比矩阵的行列式 $\\det(\\mathbf{B}(\\mathbf{V}))$，仅用 $u$ 和 $c$ 表示。将最终答案表示为无单位的单个闭式解析表达式。", "solution": "该问题提法恰当，有科学依据，是客观的，并包含了完整推导所需的所有信息。这是分析双曲守恒律（特别是欧拉方程）的一个标准练习，因此是有效的。\n\n该过程涉及几个步骤：推导守恒变量下的通量雅可比矩阵及其特征结构，找到到原始变量的转换矩阵，计算相应的原始变量雅可比矩阵，比较两个系统，最后计算原始变量雅可比矩阵的行列式。\n\n**第一部分：通量雅可比矩阵 $\\mathbf{A}(\\mathbf{U})$ 及其特征结构**\n\n守恒变量的矢量为 $\\mathbf{U} = (U_1, U_2, U_3)^T = (\\rho, \\rho u, \\rho E)^T$。通量矢量为 $\\mathbf{F}(\\mathbf{U}) = (\\rho u, \\rho u^2+p, u(\\rho E+p))^T$。为计算雅可比矩阵 $\\mathbf{A}(\\mathbf{U}) = \\partial \\mathbf{F}/\\partial \\mathbf{U}$，我们首先用 $U_1, U_2, U_3$ 表示通量分量 $F_1, F_2, F_3$。\n原始变量为 $\\rho = U_1$ 和 $u = U_2/U_1$。\n压力 $p$ 由状态方程给出：\n$$p = (\\gamma - 1)\\left(\\rho E - \\frac{1}{2}\\rho u^2\\right) = (\\gamma - 1)\\left(U_3 - \\frac{1}{2}U_1 \\left(\\frac{U_2}{U_1}\\right)^2\\right) = (\\gamma - 1)\\left(U_3 - \\frac{U_2^2}{2U_1}\\right)$$\n通量矢量分量为：\n$$F_1 = \\rho u = U_2$$\n$$F_2 = \\rho u^2 + p = U_1\\left(\\frac{U_2}{U_1}\\right)^2 + (\\gamma - 1)\\left(U_3 - \\frac{U_2^2}{2U_1}\\right) = \\frac{U_2^2}{U_1} + (\\gamma-1)U_3 - \\frac{\\gamma-1}{2}\\frac{U_2^2}{U_1} = \\frac{3-\\gamma}{2}\\frac{U_2^2}{U_1} + (\\gamma-1)U_3$$\n$$F_3 = u(\\rho E + p) = \\frac{U_2}{U_1}(U_3 + p) = \\frac{U_2}{U_1}\\left[U_3 + (\\gamma-1)\\left(U_3 - \\frac{U_2^2}{2U_1}\\right)\\right] = \\frac{U_2}{U_1}\\left[\\gamma U_3 - \\frac{\\gamma-1}{2}\\frac{U_2^2}{U_1}\\right] = \\frac{\\gamma U_2 U_3}{U_1} - \\frac{\\gamma-1}{2}\\frac{U_2^3}{U_1^2}$$\n通量雅可比矩阵 $\\mathbf{A}(\\mathbf{U})_{ij} = \\partial F_i/\\partial U_j$ 通过微分计算。为清晰起见，方便将最终矩阵用原始变量 $\\rho, u, p$ 及相关量如总焓 $H = E + p/\\rho = \\frac{\\rho E + p}{\\rho}$ 和声速 $c = \\sqrt{\\gamma p/\\rho}$ 表示。总焓可以写为 $H = \\frac{c^2}{\\gamma-1} + \\frac{u^2}{2}$。得到的雅可比矩阵为：\n$$\n\\mathbf{A}(\\mathbf{U}) = \\begin{pmatrix}\n0 & 1 & 0 \\\\\n\\frac{\\gamma-3}{2}u^2 & (3-\\gamma)u & \\gamma-1 \\\\\nu\\left(\\frac{\\gamma-1}{2}u^2 - H\\right) & H - (\\gamma-1)u^2 & \\gamma u\n\\end{pmatrix}\n$$\n该矩阵的特征值是系统的特征波速。对于一维欧拉方程，已知它们是：\n$$\n\\lambda_1 = u - c, \\quad \\lambda_2 = u, \\quad \\lambda_3 = u + c\n$$\n一组满足 $\\mathbf{A}\\mathbf{r}_k = \\lambda_k\\mathbf{r}_k$ 的相容的右特征矢量 $\\mathbf{r}_k$ 是：\n$$\n\\mathbf{r}_1 = \\begin{pmatrix} 1 \\\\ u-c \\\\ H-uc \\end{pmatrix}, \\quad\n\\mathbf{r}_2 = \\begin{pmatrix} 1 \\\\ u \\\\ \\frac{1}{2}u^2 \\end{pmatrix}, \\quad\n\\mathbf{r}_3 = \\begin{pmatrix} 1 \\\\ u+c \\\\ H+uc \\end{pmatrix}\n$$\n这些特征矢量存在不同的缩放方式；上面的选择是一种常见且简单的选择。\n\n**第二部分：转换矩阵和原始变量雅可比矩阵**\n\n从原始变量 $\\mathbf{V} = (\\rho, u, p)^T$ 到守恒变量 $\\mathbf{U} = (\\rho, \\rho u, \\rho E)^T$ 的转换需要用 $\\mathbf{V}$ 表示 $\\mathbf{U}$。使用关系式 $\\rho E = \\frac{p}{\\gamma-1} + \\frac{1}{2}\\rho u^2$，我们有：\n$$\n\\mathbf{U}(\\mathbf{V}) = \\begin{pmatrix} \\rho \\\\ \\rho u \\\\ \\frac{p}{\\gamma-1} + \\frac{1}{2}\\rho u^2 \\end{pmatrix}\n$$\n转换矩阵 $\\mathbf{U}_{\\mathbf{V}}$ 是此转换的雅可比矩阵，$\\mathbf{U}_{\\mathbf{V}} = \\partial \\mathbf{U}/\\partial \\mathbf{V}$：\n$$\n\\mathbf{U}_{\\mathbf{V}} = \\begin{pmatrix} \\partial U_1/\\partial \\rho & \\partial U_1/\\partial u & \\partial U_1/\\partial p \\\\ \\partial U_2/\\partial \\rho & \\partial U_2/\\partial u & \\partial U_2/\\partial p \\\\ \\partial U_3/\\partial \\rho & \\partial U_3/\\partial u & \\partial U_3/\\partial p \\end{pmatrix} = \\begin{pmatrix}\n1 & 0 & 0 \\\\\nu & \\rho & 0 \\\\\n\\frac{1}{2}u^2 & \\rho u & \\frac{1}{\\gamma-1}\n\\end{pmatrix}\n$$\n逆转换矩阵 $\\mathbf{U}_{\\mathbf{V}}^{-1} = \\partial \\mathbf{V}/\\partial \\mathbf{U}$ 可以通过直接矩阵求逆或通过对 $\\mathbf{V}$ 关于 $\\mathbf{U}$ 的表达式进行微分来计算：$\\rho = U_1$, $u=U_2/U_1$, $p=(\\gamma-1)(U_3 - U_2^2/(2U_1))$。\n$$\n\\mathbf{U}_{\\mathbf{V}}^{-1} = \\begin{pmatrix}\n1 & 0 & 0 \\\\\n-u/\\rho & 1/\\rho & 0 \\\\\n\\frac{\\gamma-1}{2}u^2 & -(\\gamma-1)u & \\gamma-1\n\\end{pmatrix}\n$$\n准线性原始变量雅可比矩阵 $\\mathbf{B}(\\mathbf{V})$ 通过对 $\\mathbf{A}$ 进行相似变换得到：$\\mathbf{B}(\\mathbf{V}) = \\mathbf{U}_{\\mathbf{V}}^{-1}\\,\\mathbf{A}\\,\\mathbf{U}_{\\mathbf{V}}$。一种计算它的便捷方法是首先求积 $\\mathbf{A}\\mathbf{U}_{\\mathbf{V}}$，根据链式法则，它等于 $\\partial \\mathbf{F}/\\partial \\mathbf{V}$：\n$$ \\mathbf{A}\\mathbf{U}_{\\mathbf{V}} = \\frac{\\partial \\mathbf{F}}{\\partial \\mathbf{U}}\\frac{\\partial \\mathbf{U}}{\\partial \\mathbf{V}} = \\frac{\\partial \\mathbf{F}}{\\partial \\mathbf{V}} $$\n我们通过首先用 $\\mathbf{V}$ 表示 $\\mathbf{F}$ 来计算 $\\partial \\mathbf{F}/\\partial \\mathbf{V}$：\n$$ \\mathbf{F}(\\mathbf{V}) = \\begin{pmatrix} \\rho u \\\\ \\rho u^2+p \\\\ u(\\frac{\\gamma p}{\\gamma-1} + \\frac{1}{2}\\rho u^2) \\end{pmatrix} $$\n微分得到：\n$$ \\frac{\\partial \\mathbf{F}}{\\partial \\mathbf{V}} = \\begin{pmatrix}\nu & \\rho & 0 \\\\\nu^2 & 2\\rho u & 1 \\\\\n\\frac{1}{2}u^3 & \\frac{\\gamma p}{\\gamma-1} + \\frac{3}{2}\\rho u^2 & \\frac{\\gamma u}{\\gamma-1}\n\\end{pmatrix}\n$$\n现在我们可以将 $\\mathbf{B}$ 求为 $\\mathbf{B} = \\mathbf{U}_{\\mathbf{V}}^{-1} (\\partial \\mathbf{F}/\\partial \\mathbf{V})$：\n$$\n\\mathbf{B}(\\mathbf{V}) = \\begin{pmatrix}\n1 & 0 & 0 \\\\\n-u/\\rho & 1/\\rho & 0 \\\\\n\\frac{\\gamma-1}{2}u^2 & -(\\gamma-1)u & \\gamma-1\n\\end{pmatrix} \\begin{pmatrix}\nu & \\rho & 0 \\\\\nu^2 & 2\\rho u & 1 \\\\\n\\frac{1}{2}u^3 & \\frac{\\gamma p}{\\gamma-1} + \\frac{3}{2}\\rho u^2 & \\frac{\\gamma u}{\\gamma-1}\n\\end{pmatrix} = \\begin{pmatrix}\nu & \\rho & 0 \\\\\n0 & u & 1/\\rho \\\\\n0 & \\gamma p & u\n\\end{pmatrix}\n$$\n使用 $c^2=\\gamma p/\\rho$，我们可以将其写为：\n$$\n\\mathbf{B}(\\mathbf{V}) = \\begin{pmatrix}\nu & \\rho & 0 \\\\\n0 & u & 1/\\rho \\\\\n0 & \\rho c^2 & u\n\\end{pmatrix}\n$$\n\n**第三部分：特征结构和雅可比矩阵的比较**\n\n由于 $\\mathbf{B}$ 是通过相似变换与 $\\mathbf{A}$ 相关联的，它们共享相同的特征值。我们可以通过计算 $\\mathbf{B}$ 的特征多项式来验证这一点：\n$$ \\det(\\mathbf{B}-\\lambda\\mathbf{I}) = \\begin{vmatrix} u-\\lambda & \\rho & 0 \\\\ 0 & u-\\lambda & 1/\\rho \\\\ 0 & \\rho c^2 & u-\\lambda \\end{vmatrix} = (u-\\lambda)\\left( (u-\\lambda)^2 - (\\rho c^2)(1/\\rho) \\right) = (u-\\lambda)( (u-\\lambda)^2 - c^2 ) = 0 $$\n这得出的特征值 $\\lambda = u, u \\pm c$ 与 $\\mathbf{A}$ 的特征值相同。\n\n然而，它们的特征矢量是不同的。$\\mathbf{B}$ 的右特征矢量是：\n$$\n\\mathbf{r}_{B,1} = \\begin{pmatrix} 1 \\\\ 0 \\\\ 0 \\end{pmatrix}, \\quad\n\\mathbf{r}_{B,2} = \\begin{pmatrix} \\rho \\\\ -c \\\\ \\rho c^2 \\end{pmatrix}, \\quad\n\\mathbf{r}_{B,3} = \\begin{pmatrix} \\rho \\\\ c \\\\ \\rho c^2 \\end{pmatrix}\n$$\n这些特征矢量表示原始变量空间 $(\\delta\\rho, \\delta u, \\delta p)^T$ 中的扰动，而 $\\mathbf{A}$ 的特征矢量表示守恒变量空间中的扰动。\n\n$\\mathbf{B}(\\mathbf{V})$ 和 $\\partial \\mathbf{F}/\\partial \\mathbf{V}$ 之间的区别是根本性的。守恒律 $\\partial_t \\mathbf{U} + \\partial_x \\mathbf{F}(\\mathbf{U}) = 0$ 可以使用链式法则以原始变量重写：\n$$ \\frac{\\partial \\mathbf{U}}{\\partial \\mathbf{V}}\\frac{\\partial \\mathbf{V}}{\\partial t} + \\frac{\\partial \\mathbf{F}}{\\partial \\mathbf{V}}\\frac{\\partial \\mathbf{V}}{\\partial x} = 0 \\implies \\mathbf{U}_{\\mathbf{V}} \\frac{\\partial \\mathbf{V}}{\\partial t} + \\frac{\\partial \\mathbf{F}}{\\partial \\mathbf{V}} \\frac{\\partial \\mathbf{V}}{\\partial x} = 0 $$\n为了得到标准的准线性形式 $\\partial_t \\mathbf{V} + \\mathbf{B} \\partial_x \\mathbf{V} = 0$，我们必须乘以 $\\mathbf{U}_{\\mathbf{V}}^{-1}$：\n$$ \\frac{\\partial \\mathbf{V}}{\\partial t} + \\left(\\mathbf{U}_{\\mathbf{V}}^{-1} \\frac{\\partial \\mathbf{F}}{\\partial \\mathbf{V}}\\right) \\frac{\\partial \\mathbf{V}}{\\partial x} = 0 $$\n因此，$\\mathbf{B}(\\mathbf{V}) = \\mathbf{U}_{\\mathbf{V}}^{-1}(\\partial \\mathbf{F}/\\partial \\mathbf{V})$ 是原始变量形式下真正的系统雅可比矩阵，其特征值是特征波速。相比之下，$\\partial \\mathbf{F}/\\partial \\mathbf{V}$ 是一个中间矩阵，它本身并不代表系统的特征结构。原始变量形式的欧拉方程不是守恒形式，这意味着不存在通量函数 $\\mathbf{G}(\\mathbf{V})$ 使得 $\\mathbf{B} = \\partial \\mathbf{G}/\\partial \\mathbf{V}$。\n\n**第四部分：原始变量雅可比矩阵的行列式**\n\n矩阵的行列式是其特征值的乘积。对于 $\\mathbf{B}(\\mathbf{V})$，特征值为 $u, u-c, u+c$。因此：\n$$ \\det(\\mathbf{B}(\\mathbf{V})) = (u)(u-c)(u+c) = u(u^2-c^2) $$\n这可以通过对 $\\mathbf{B}(\\mathbf{V})$ 的矩阵形式直接计算来证实：\n$$ \\det(\\mathbf{B}(\\mathbf{V})) = \\det \\begin{pmatrix}\nu & \\rho & 0 \\\\\n0 & u & 1/\\rho \\\\\n0 & \\rho c^2 & u\n\\end{pmatrix} = u \\begin{vmatrix} u & 1/\\rho \\\\ \\rho c^2 & u \\end{vmatrix} - \\rho \\begin{vmatrix} 0 & 1/\\rho \\\\ 0 & u \\end{vmatrix} = u(u^2 - (\\rho c^2)(1/\\rho)) - 0 = u(u^2 - c^2) $$\n最终表达式仅用 $u$ 和 $c$ 表示，符合要求。", "answer": "$$\n\\boxed{u(u^2 - c^2)}\n$$", "id": "3304162"}, {"introduction": "理论告诉我们，守恒格式对于正确捕捉激波等间断至关重要。本次编程实践将让你通过为伯格斯方程 (Burgers' equation) 实现一个简单的非守恒数值格式，来亲手验证这一原理 ([@problem_id:3304192])。通过模拟一个激波问题，你将直接观察到该格式会收敛到一个错误的解，其激波传播速度严重偏离了物理上必须满足的朗金-雨贡纽 (Rankine–Hugoniot) 条件。", "problem": "你需要设计并分析一个用于一维标量守恒律的数值方法，其方式应能区分计算流体动力学（CFD）中的守恒与非守恒形式。核心重点是通过一个可复现的数值实验来证明，一个相容但非守恒的格式可以收敛到一个违反 Rankine–Hugoniot 跳跃条件的弱解。\n\n考虑一维无粘 Burgers 方程的标量守恒律，\n$$\nu_t + \\left(\\tfrac{1}{2} u^2\\right)_x = 0,\n$$\n该方程定义在区间 $[-1,1]$ 的均匀网格上，具有黎曼初值数据\n$$\nu(x,0) = \\begin{cases}\nu_L, & x  0,\\\\\nu_R,  x \\ge 0.\n\\end{cases}\n$$\n这里 $u$ 是无量纲的。在进行形式化相容性分析时，你可以在任何需要的地方假设标准的数学光滑性。\n\n你的任务是：\n\n- 构造一个对于光滑解是相容的，但对于间断解是非守恒的有限差分时间推进格式。你的构造应基于拟线性形式\n$$\nu_t + a(u)\\,u_x = 0,\\quad a(u) = f'(u) = u,\n$$\n并使用基于局部特征速度的迎风格式。选择一个满足 Courant–Friedrichs–Lewy (CFL) 条件的时间步长，该条件使用指定的 Courant 数和最大局部特征速度的绝对值。不要将该格式改写为守恒的通量差分形式。你的格式必须在均匀网格上演化单元中心值，并且你必须在区间的两端实现出流（常数外推）边界条件。\n\n- 使用守恒律的 Rankine–Hugoniot 跳跃条件，\n$$\ns_{\\mathrm{RH}} = \\frac{f(u_L) - f(u_R)}{u_L - u_R},\n$$\n其中 $f(u)=\\tfrac{1}{2}u^2$，定义一个数值诊断方法，用于从 $u_L  u_R$ 的黎曼问题的计算结果中估计最终时刻 $T$ 的激波速度。通过定位数值解穿过中点值 $m = \\tfrac{1}{2}(u_L + u_R)$ 的位置来估计瞬时激波位置，并将其位置除以 $T$ 以得到估计速度。对于稀疏波数据 $u_L  u_R$，计算与精确自相似稀疏解的 $L^1$ 误差\n$$\nu(x,T) = \\begin{cases}\nu_L,  x/T \\le u_L,\\\\\nx/T,  u_L  x/T  u_R,\\\\\nu_R,  x/T \\ge u_R.\n\\end{cases}\n$$\n对于常数数据 $u_L = u_R$，计算最终时刻 $T$ 的 $L^\\infty$ 误差。\n\n- 所有量都是无量纲的。以无量纲化所隐含的“网格长度/单位时间”为单位报告速度。不需要进行其他单位转换。\n\n你的程序必须实现上述非守恒、相容的迎风格式，并为以下测试套件生成一行包含聚合数值结果的输出：\n\n- 测试 A（激波）：$u_L=2$, $u_R=0$，最终时间 $T=0.2$，Courant 数 $\\mathrm{CFL}=0.4$，在 $[-1,1]$ 上使用 $N \\in \\{200, 400, 800\\}$ 个单元的均匀网格。对于每个 $N$，如上所述估计数值激波速度 $s_{\\mathrm{num}}(N)$。同时计算这些数据的 Rankine–Hugoniot 速度 $s_{\\mathrm{RH}}$ 和绝对差 $\\lvert s_{\\mathrm{num}}(800) - s_{\\mathrm{RH}}\\rvert$。此外，报告一个布尔值，指示 $\\lvert s_{\\mathrm{num}}(800) - s_{\\mathrm{RH}}\\rvert  0.25$ 是否成立。\n\n- 测试 B（稀疏波）：$u_L=0$, $u_R=2$，最终时间 $T=0.2$，Courant 数 $\\mathrm{CFL}=0.4$，以及 $N=800$。计算在 $[-1,1]$ 上与精确稀疏波剖面的 $L^1$ 误差。\n\n- 测试 C（常数状态）：$u_L=u_R=1$，最终时间 $T=0.2$，Courant 数 $\\mathrm{CFL}=0.4$，以及 $N=200$。计算在时刻 $T$ 的 $L^\\infty$ 误差。\n\n你的程序应生成一行输出，其中包含一个逗号分隔的列表，用方括号括起来，结果按以下顺序排列：\n$$\n\\big[s_{\\mathrm{num}}(200),\\, s_{\\mathrm{num}}(400),\\, s_{\\mathrm{num}}(800),\\, s_{\\mathrm{RH}},\\, \\lvert s_{\\mathrm{num}}(800)-s_{\\mathrm{RH}}\\rvert,\\, \\text{violation\\_boolean},\\, L^1\\_B,\\, L^\\infty\\_C\\big].\n$$\n值 $s_{\\mathrm{num}}(N)$ 和 $s_{\\mathrm{RH}}$ 必须是浮点数，绝对差必须是浮点数，违规标志必须是布尔值，$L^1\\_B$ 必须是浮点数，$L^\\infty\\_C$ 必须是浮点数。计算必须完全自包含，不需要用户输入，并完全按照指定使用给定的参数值。这单行输出必须是唯一的打印输出。", "solution": "所提出的问题是计算流体动力学中一个有效的数值分析练习。它具有科学依据，是适定的和客观的。它要求我们展示一个基本概念：非守恒数值格式无法捕捉守恒律的正确弱解，具体表现为收敛到一个以违反 Rankine-Hugoniot 条件的速度传播的激波。\n\n该问题围绕一维无粘 Burgers 方程展开，这是一个双曲守恒律的典型模型。其守恒形式为\n$$\n\\frac{\\partial u}{\\partial t} + \\frac{\\partial}{\\partial x} \\left( \\frac{1}{2} u^2 \\right) = 0.\n$$\n对于光滑解，链式法则允许将其写成拟线性形式，\n$$\n\\frac{\\partial u}{\\partial t} + u \\frac{\\partial u}{\\partial x} = 0,\n$$\n其中 $a(u) = u$ 是特征速度。虽然这两种形式对于光滑解是等价的，但它们的弱解（允许间断，即激波）并不等价。守恒形式是物理上正确的形式，源自积分平衡律。一个数值格式必须是守恒形式，才能保证其解收敛到满足正确跳跃条件的弱解。\n\n我们将基于非守恒的拟线性形式构造一个数值格式，并证明对于产生激波的黎曼问题（$u_L > u_R$），它会收敛到一个传播速度不正确的激波。\n\n**1. 数值离散化**\n\n我们将空间域 $x \\in [-1, 1]$ 离散为 $N$ 个均匀单元。网格间距为 $\\Delta x = 2/N$。解由单元中心值 $U_j^n$ 表示，它近似了在单元中心 $x_j = -1 + (j+0.5)\\Delta x$（对于 $j=0, 1, \\dots, N-1$）和时间 $t_n = n\\Delta t$ 的解 $u(x_j, t_n)$。\n\n初始条件是黎曼问题，\n$$\nu(x,0) = \\begin{cases}\nu_L,  x  0,\\\\\nu_R,  x \\ge 0.\n\\end{cases}\n$$\n通过设置 $U_j^0 = u_L$（如果 $x_j  0$）和 $U_j^0 = u_R$（如果 $x_j \\ge 0$）来进行离散化。\n\n**2. 非守恒迎风格式**\n\n我们的任务是基于拟线性形式 $u_t + u u_x = 0$ 创建一个格式。我们使用前向欧拉法进行时间积分，并使用一阶迎风格式处理空间导数 $u_x$。迎风方向由局部特征速度 $a(u_j) = U_j^n$ 的符号决定。\n\n在单元 $j$ 的半离散近似为\n$$\n\\frac{dU_j}{dt} = -U_j (u_x)_j.\n$$\n$(u_x)_j$ 的迎风离散格式为：\n$$\n(u_x)_j \\approx \\begin{cases}\n(U_j^n - U_{j-1}^n)/\\Delta x,  \\text{if } U_j^n \\ge 0 \\\\\n(U_{j+1}^n - U_j^n)/\\Delta x,  \\text{if } U_j^n  0\n\\end{cases}\n$$\n将这些与前向欧拉时间步进相结合，完整的更新规则是：\n$$\nU_j^{n+1} = U_j^n - \\frac{\\Delta t}{\\Delta x} U_j^n \\times \\begin{cases}\n(U_j^n - U_{j-1}^n),  \\text{if } U_j^n \\ge 0 \\\\\n(U_{j+1}^n - U_j^n),  \\text{if } U_j^n  0\n\\end{cases}\n$$\n该格式是非守恒的，因为它不能被写成通量差分形式 $U_j^{n+1} = U_j^n - \\frac{\\Delta t}{\\Delta x}(F_{j+1/2} - F_{j-1/2})$，其中 $F$ 是一个相容的数值通量。对网格上的更新求和不会产生通量的伸缩求和，这意味着离散总质量 $\\sum_j U_j \\Delta x$ 除了边界通量外不守恒。\n\n**3. 时间步长和边界条件**\n\n为了确保数值稳定性，时间步长 $\\Delta t$ 的选择需要满足 Courant-Friedrichs-Lewy (CFL) 条件。对于显式格式，我们必须确保数值依赖域包含物理依赖域。这要求\n$$\n\\Delta t \\le \\mathrm{CFL} \\frac{\\Delta x}{\\max_j |a(U_j^n)|} \\implies \\Delta t = \\mathrm{CFL} \\frac{\\Delta x}{\\max_j |U_j^n|}.\n$$\n时间步长在每次迭代时根据当前域内的最大波速重新计算。为了精确到达最终时间 $T$，必要时会调整最后一个时间步长。\n\n出流边界条件通过虚拟单元实现。我们在域的每一端添加一个虚拟单元，$U_{-1}$ 和 $U_N$。其值通过常数外推设置：$U_{-1}^n = U_0^n$ 和 $U_N^n = U_{N-1}^n$。\n\n**4. 数值诊断**\n\n- **测试 A (激波):** 对于 $u_L  u_R$ 的情况，会形成一个激波。理论上正确的激波速度 $s_{\\mathrm{RH}}$ 由守恒方程（通量 $f(u) = \\frac{1}{2}u^2$）的 Rankine-Hugoniot 跳跃条件给出：\n$$\ns_{\\mathrm{RH}} = \\frac{f(u_L) - f(u_R)}{u_L - u_R} = \\frac{\\frac{1}{2}u_L^2 - \\frac{1}{2}u_R^2}{u_L - u_R} = \\frac{1}{2}(u_L + u_R).\n$$\n对于 $u_L=2$ 和 $u_R=0$，我们有 $s_{\\mathrm{RH}} = \\frac{1}{2}(2+0) = 1$。数值激波速度 $s_{\\mathrm{num}}$ 从时间 $T$ 的最终解剖面估计。我们找到解穿过中点值 $m = \\frac{1}{2}(u_L+u_R) = 1$ 的位置 $x_{\\mathrm{shock}}$。这个位置通过在包围值 $m$ 的两个网格单元之间进行线性插值找到。然后速度为 $s_{\\mathrm{num}} = x_{\\mathrm{shock}} / T$。\n\n- **测试 B (稀疏波):** 对于 $u_L  u_R$ 的情况，会发展出一个光滑的稀疏波。精确解是自相似的，仅依赖于 $\\xi = x/t$。我们将我们在时间 $T$ 的数值解 $U_{\\mathrm{final}}$ 与精确解 $u_{\\mathrm{exact}}(x_j, T)$ 进行比较，并计算 $L^1$ 误差：\n$$\nL^1 \\text{ 误差} = \\sum_{j=0}^{N-1} |U_{\\mathrm{final},j} - u_{\\mathrm{exact}}(x_j, T)| \\Delta x.\n$$\n\n- **测试 C (常数状态):** 对于 $u_L=u_R=c$ 的情况，精确解是 $u(x,t)=c$。非守恒迎风格式在这种情况下是精确的，因为空间差分项为零。误差应该在机器精度级别。我们计算 $L^\\infty$ 误差：\n$$\nL^\\infty \\text{ 误差} = \\max_{j} |U_{\\mathrm{final},j} - c|.\n$$\n\n将对三个测试案例执行指定的计算，并按要求汇总结果。这将通过数值验证，证明非守恒格式尽管对于光滑流动是相容的（如测试B和C中的小误差所示），但在间断流动（测试A）的激波速度上产生一个大的、持续的误差，从而收敛到一个不正确的弱解。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef run_simulation(u_l, u_r, N, T_final, CFL):\n    \"\"\"\n    Solves the 1D Burgers' equation using a non-conservative upwind scheme.\n    \"\"\"\n    # Grid setup\n    L_domain = 2.0\n    dx = L_domain / N\n    x = -1.0 + (np.arange(N) + 0.5) * dx\n\n    # Initial condition\n    u = np.full(N, u_r)\n    u[x  0] = u_l\n\n    t = 0.0\n    while t  T_final:\n        # Calculate time step based on CFL condition\n        max_abs_u = np.max(np.abs(u))\n        if max_abs_u == 0:\n            # If u is zero everywhere, dt can be T_final - t\n            # or a large number. Let's make it not infinite.\n            dt = T_final - t\n        else:\n            dt = CFL * dx / max_abs_u\n\n        # Ensure we do not step past the final time\n        if t + dt > T_final:\n            dt = T_final - t\n\n        # Pad the solution array with ghost cells for boundary conditions\n        # Outflow (constant extrapolation)\n        u_padded = np.pad(u, 1, mode='edge')\n        \n        # Vectorized calculation of the spatial derivative term\n        u_conv = np.zeros_like(u)\n\n        # Positive speeds: upwind from left\n        pos_mask = u >= 0\n        if np.any(pos_mask):\n            u_j = u_padded[1:-1][pos_mask]\n            u_jm1 = u_padded[:-2][pos_mask]\n            u_conv[pos_mask] = u_j * (u_j - u_jm1)\n\n        # Negative speeds: upwind from right\n        neg_mask = u  0\n        if np.any(neg_mask):\n            u_j = u_padded[1:-1][neg_mask]\n            u_jp1 = u_padded[2:][neg_mask]\n            u_conv[neg_mask] = u_j * (u_jp1 - u_j)\n\n        # Forward Euler update\n        u = u - (dt / dx) * u_conv\n        t += dt\n\n    return x, u\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and produce the final output.\n    \"\"\"\n    # --- Test A: Schock Problem ---\n    u_l_A, u_r_A = 2.0, 0.0\n    T_A = 0.2\n    CFL_A = 0.4\n    N_vals_A = [200, 400, 800]\n    \n    s_num_list = []\n    for N in N_vals_A:\n        x, u_final = run_simulation(u_l_A, u_r_A, N, T_A, CFL_A)\n        dx = x[1] - x[0]\n        \n        # Find shock position by interpolation\n        mid_val = 0.5 * (u_l_A + u_r_A)\n        \n        # Find index j where u[j] >= mid_val and u[j+1]  mid_val\n        cross_indices = np.where((u_final[:-1] >= mid_val)  (u_final[1:]  mid_val))[0]\n        \n        if len(cross_indices) > 0:\n            j = cross_indices[0]\n            x_j = x[j]\n            u_j = u_final[j]\n            u_jp1 = u_final[j+1]\n            \n            # Linear interpolation to find x_shock\n            x_shock = x_j + dx * (u_j - mid_val) / (u_j - u_jp1)\n            s_num = x_shock / T_A\n        else:\n            # Fallback if no crossing is found (should not happen for this problem)\n            s_num = np.nan\n            \n        s_num_list.append(s_num)\n\n    s_rh = 0.5 * (u_l_A**2 - u_r_A**2) / (u_l_A - u_r_A)\n    abs_diff = np.abs(s_num_list[-1] - s_rh)\n    violation_boolean = abs_diff > 0.25\n\n    # --- Test B: Rarefaction Problem ---\n    u_l_B, u_r_B = 0.0, 2.0\n    T_B = 0.2\n    CFL_B = 0.4\n    N_B = 800\n    \n    x_B, u_final_B = run_simulation(u_l_B, u_r_B, N_B, T_B, CFL_B)\n    dx_B = x_B[1] - x_B[0]\n    \n    # Exact solution for rarefaction\n    xt = x_B / T_B\n    u_exact_B = np.zeros_like(x_B)\n    mask1 = xt = u_l_B\n    mask2 = xt >= u_r_B\n    mask3 = (~mask1)  (~mask2)\n    u_exact_B[mask1] = u_l_B\n    u_exact_B[mask2] = u_r_B\n    u_exact_B[mask3] = xt[mask3]\n    \n    l1_error_B = np.sum(np.abs(u_final_B - u_exact_B)) * dx_B\n\n    # --- Test C: Constant State ---\n    u_l_C, u_r_C = 1.0, 1.0\n    T_C = 0.2\n    CFL_C = 0.4\n    N_C = 200\n\n    x_C, u_final_C = run_simulation(u_l_C, u_r_C, N_C, T_C, CFL_C)\n    \n    l_inf_error_C = np.max(np.abs(u_final_C - u_l_C))\n    \n    # --- Final Output ---\n    results = [\n        s_num_list[0],\n        s_num_list[1],\n        s_num_list[2],\n        s_rh,\n        abs_diff,\n        violation_boolean,\n        l1_error_B,\n        l_inf_error_C\n    ]\n    \n    # Format the output string\n    formatted_results = []\n    for r in results:\n        if isinstance(r, bool):\n            formatted_results.append(str(r).lower())\n        else:\n            formatted_results.append(f\"{r}\")\n\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "3304192"}, {"introduction": "非守恒格式的失效在处理激波时表现得最为显著，但它们在光滑流场中同样会引入不易察觉的误差。这最后一个数值实验将进行一次直接对比：你将为完整的欧拉方程组同时实现一个守恒的有限体积格式和一个非守恒的有限差分格式 ([@problem_id:3304148])。通过将它们应用于相同的光滑初始条件，你将能够精确地量化由非守恒格式导致的质量、动量和能量的人为增减，从而证明其内在的不可靠性。", "problem": "考虑定义在长度为 $L$ 的周期性域上的一维可压缩欧拉方程，该方程描述了量热完全理想气体。其原始变量为 $(\\rho, u, p)$，守恒变量为 $(\\rho, \\rho u, \\rho E)$，状态方程 (EOS) 为 $p = (\\gamma - 1)\\rho e$，其中 $\\gamma$ 为常数比热比，$e$ 为比内能。单位质量总能量 $E$ 满足 $E = e + \\tfrac{1}{2}u^2$。守恒形式的方程组为\n$$\n\\partial_t \\rho + \\partial_x (\\rho u) = 0,\\quad\n\\partial_t (\\rho u) + \\partial_x\\!\\left(\\rho u^2 + p\\right) = 0,\\quad\n\\partial_t (\\rho E) + \\partial_x\\!\\left(u(\\rho E + p)\\right) = 0.\n$$\n对于光滑解，与之代数等价的（通过乘法法则和理想气体状态方程推导）原始变量方程组为\n$$\n\\partial_t \\rho + u\\,\\partial_x \\rho + \\rho\\,\\partial_x u = 0,\\quad\n\\partial_t u + u\\,\\partial_x u + \\frac{1}{\\rho}\\,\\partial_x p = 0,\\quad\n\\partial_t p + u\\,\\partial_x p + \\gamma p\\,\\partial_x u = 0.\n$$\n您将设计一个思想实验，并通过数值方法将其实现，以比较两种离散格式在单个时间步内推进相同光滑初始数据的表现：\n- 一种有限体积格式，该格式使用面通量更新守恒变量 $(\\rho, \\rho u, \\rho E)$，在周期性边界条件下确保精确的离散守恒。\n- 一种代数等价但非守恒的格式，该格式通过使用单元空间导数离散化原始变量方程组来更新原始变量 $(\\rho, u, p)$。\n\n仅从上述基本定律和定义出发，您必须：\n1. 实现一个具有 $N$ 个宽度为 $\\Delta x = L/N$ 的均匀单元的一维周期性网格。\n2. 通过库朗-弗里德里希斯-列维 (CFL) 条件选择单个显式时间步 $\\Delta t$，即 $\\Delta t = \\mathrm{CFL}\\,\\Delta x / a_{\\max}$，其中 $a_{\\max} = \\max_i \\left(|u_i| + c_i\\right)$ 且 $c_i = \\sqrt{\\gamma p_i/\\rho_i}$ 是当地声速。\n3. 守恒有限体积更新：\n   - 通过状态方程从单元中心的原始变量构造单元中心的守恒变量。\n   - 使用任意相容的单调数值通量计算面通量 $F_{i+\\frac{1}{2}}$；为具体起见，使用局部 Lax–Friedrichs (Rusanov) 通量 $F^\\ast(U_L,U_R) = \\tfrac{1}{2}\\left(F(U_L)+F(U_R)\\right) - \\tfrac{1}{2} a_{\\max}(U_R-U_L)$，其中 $a_{\\max} = \\max\\left(|u_L|+c_L, |u_R|+c_R\\right)$，$F(U) = \\left(\\rho u,\\ \\rho u^2 + p,\\ u(\\rho E + p)\\right)$ 且 $U_L, U_R$ 是每个面上的左/右状态。更新 $U_i^{n+1} = U_i^n - \\frac{\\Delta t}{\\Delta x}\\left(F_{i+\\frac{1}{2}} - F_{i-\\frac{1}{2}}\\right)$。\n4. 原始变量更新：\n   - 在周期性网格上，使用中心差分来离散化原始系统中的空间导数：对于 $w \\in \\{\\rho,u,p\\}$，$\\partial_x w \\approx (w_{i+1}-w_{i-1})/(2\\Delta x)$。\n   - 使用原始变量方程，通过显式欧拉方法更新 $(\\rho, u, p)$。\n5. 对于两种格式，计算单个时间步前后质量、动量和能量的全局积分：\n   - 质量 $M = \\sum_i \\rho_i\\,\\Delta x$。\n   - 动量 $P = \\sum_i \\rho_i u_i\\,\\Delta x$。\n   - 能量 $E_{\\mathrm{tot}} = \\sum_i \\rho_i E_i\\,\\Delta x = \\sum_i \\left(\\frac{p_i}{\\gamma - 1} + \\frac{1}{2}\\rho_i u_i^2\\right)\\Delta x$。\n6. 对于每种格式，将导致的非守恒性量化为初始总量与更新后总量之间的绝对变化量 $\\Delta M$、$\\Delta P$、$\\Delta E$。\n\n所有变量均为无量纲。初始条件中的角度参数以弧度为单位指定，并且必须按此处理。\n\n在 $x \\in [0,L)$ 上（其中 $L = 2\\pi$）、周期性边界条件和 $\\gamma = 1.4$ 的情况下，实现以下光滑初始条件的测试套件。每个测试使用指定的 $N$ 和 $\\mathrm{CFL}$。对于每个测试用例，定义\n$$\n\\rho(x) = \\rho_0 + a_\\rho \\sin(kx + \\phi_\\rho),\\quad\nu(x) = u_0 + a_u \\sin(kx + \\phi_u),\\quad\np(x) = p_0 + a_p \\cos(kx + \\phi_p),\n$$\n参数如下：\n\n- 测试 $1$：$N=128$, $\\mathrm{CFL}=0.5$, $k=2$, $\\rho_0=1$, $u_0=0$, $p_0=1$, $a_\\rho=0.1$, $a_u=0.1$, $a_p=0.1$, $\\phi_\\rho=0$, $\\phi_u=0$, $\\phi_p=0$。\n- 测试 $2$：$N=128$, $\\mathrm{CFL}=0.5$, $k=3$, $\\rho_0=1$, $u_0=0$, $p_0=1$, $a_\\rho=10^{-8}$, $a_u=10^{-8}$, $a_p=10^{-8}$, $\\phi_\\rho=0$, $\\phi_u=0$, $\\phi_p=0$。\n- 测试 $3$：$N=128$, $\\mathrm{CFL}=0.5$, $k=1$, $\\rho_0=1$, $u_0=0$, $p_0=1$, $a_\\rho=0.2$, $a_u=0$, $a_p=0.2$, $\\phi_\\rho=0$, $\\phi_u=0$, $\\phi_p=0$。\n- 测试 $4$：$N=128$, $\\mathrm{CFL}=0.5$, $k=4$, $\\rho_0=1$, $u_0=0$, $p_0=1$, $a_\\rho=0$, $a_u=0.3$, $a_p=0.3$, $\\phi_\\rho=0$, $\\phi_u=\\pi/3$, $\\phi_p=-\\pi/4$。\n\n您的程序必须产生单行输出，其中包含一个列表的列表，每个内部列表对应一个测试用例。每个内部列表包含六个浮点数，顺序为 $[\\Delta M_{\\mathrm{cons}}, \\Delta P_{\\mathrm{cons}}, \\Delta E_{\\mathrm{cons}}, \\Delta M_{\\mathrm{prim}}, \\Delta P_{\\mathrm{prim}}, \\Delta E_{\\mathrm{prim}}]$。这些数字必须以原始十进制值的形式打印，采用默认的 Python 格式，打印在单行上，并用方括号括起来，例如：$[[m_1,p_1,e_1,m'_1,p'_1,e'_1],[m_2,p_2,e_2,m'_2,p'_2,e'_2],\\dots]$。", "solution": "该问题要求在周期性域上比较两种用于一维可压缩欧拉方程的数值格式：一种是守恒的有限体积格式，另一种是非守恒的有限差分格式。分析的核心是量化几种光滑初始条件在单个时间步后总质量、总动量和总能量的守恒情况。\n\n首先，我们建立数学和物理背景。流体的状态由原始变量描述：密度 $\\rho$、速度 $u$ 和压力 $p$。或者，它也可以由守恒变量描述：质量密度 $\\rho$、动量密度 $\\rho u$ 和总能量密度 $\\rho E$。该系统通过量热完全理想气体的状态方程 (EOS) $p = (\\gamma - 1)\\rho e$ 封闭，其中 $\\gamma$ 是比热比，$e$ 是比内能。单位质量的总能量是内能和动能之和，$E = e + \\frac{1}{2}u^2$。根据这些定义，总能量密度可以用原始变量表示为：$\\rho E = \\frac{p}{\\gamma-1} + \\frac{1}{2}\\rho u^2$。\n\n控制方程是欧拉方程，它表示质量、动量和能量的守恒。其守恒形式为 $\\partial_t U + \\partial_x F(U) = 0$，其中 $U = [\\rho, \\rho u, \\rho E]^T$ 是守恒变量的向量，$F(U) = [\\rho u, \\rho u^2 + p, u(\\rho E + p)]^T$ 是通量向量。具体表达式为：\n$$\n\\partial_t \\rho + \\partial_x (\\rho u) = 0\n$$\n$$\n\\partial_t (\\rho u) + \\partial_x (\\rho u^2 + p) = 0\n$$\n$$\n\\partial_t (\\rho E) + \\partial_x (u(\\rho E + p)) = 0\n$$\n对于光滑解，对守恒形式应用乘法求导法则，可以得到一个用原始变量表示的、代数等价的非守恒形式系统：\n$$\n\\partial_t \\rho + u\\,\\partial_x \\rho + \\rho\\,\\partial_x u = 0\n$$\n$$\n\\partial_t u + u\\,\\partial_x u + \\frac{1}{\\rho}\\,\\partial_x p = 0\n$$\n$$\n\\partial_t p + u\\,\\partial_x p + \\gamma p\\,\\partial_x u = 0\n$$\n虽然在连续意义上它们在数学上是等价的，但它们的离散对应形式在守恒性质方面表现出根本不同的行为。\n\n数值实验在一维周期性域 $x \\in [0, L)$ 上进行，其中 $L=2\\pi$，该域被离散为 $N$ 个宽度为 $\\Delta x = L/N$ 的均匀单元。单元中心为 $x_i = (i+0.5)\\Delta x$，其中 $i=0, 1, \\dots, N-1$。单个显式时间步 $\\Delta t$ 由库朗-弗里德里希斯-列维 (CFL) 条件确定：$\\Delta t = \\mathrm{CFL} \\cdot \\Delta x / a_{\\max}$，其中 $\\mathrm{CFL}$ 是一个给定数值，$a_{\\max} = \\max_i(|u_i| + c_i)$ 是整个网格上的最大特征波速，$c_i = \\sqrt{\\gamma p_i / \\rho_i}$ 是当地声速。\n\n每个测试用例的初始条件由 $\\rho(x)$、$u(x)$ 和 $p(x)$ 的光滑正弦函数给出。我们首先在单元中心 $x_i$ 处计算这些函数，以获得初始离散状态 $(\\rho^n_i, u^n_i, p^n_i)$。\n\n对于每个测试用例，该过程包括以下步骤：\n\n1.  **初始化**：建立网格并计算单元中心的初始原始变量 $(\\rho^n, u^n, p^n)$。从原始变量计算初始守恒变量 $U^n$。通过在网格上求和来计算初始总质量 $M^n$、总动量 $P^n$ 和总能量 $E_{\\mathrm{tot}}^n$：$M^n = \\sum_i \\rho^n_i \\Delta x$，$P^n = \\sum_i (\\rho u)^n_i \\Delta x$，$E_{\\mathrm{tot}}^n = \\sum_i (\\rho E)^n_i \\Delta x$。根据初始状态计算时间步 $\\Delta t$。\n\n2.  **守恒有限体积格式**：该格式更新单元平均的守恒变量 $U_i$。更新公式为：\n    $$\n    U_i^{n+1} = U_i^n - \\frac{\\Delta t}{\\Delta x} (F^*_{i+1/2} - F^*_{i-1/2})\n    $$\n    其中 $F^*_{i+1/2}$ 是单元 $i$ 和单元 $i+1$ 之间界面的数值通量。我们使用局部 Lax–Friedrichs (Rusanov) 通量：\n    $$\n    F^*(U_L, U_R) = \\frac{1}{2}(F(U_L) + F(U_R)) - \\frac{1}{2} a_{\\max, \\text{face}} (U_R - U_L)\n    $$\n    这里，$U_L = U_i^n$ 和 $U_R = U_{i+1}^n$ 是界面左侧和右侧的状态（最后一个界面使用周期性索引）。波速 $a_{\\max, \\text{face}}$ 在每个界面上局部计算为 $a_{\\max, \\text{face}} = \\max(|u_L|+c_L, |u_R|+c_R)$。计算完所有 $i$ 的 $U_i^{n+1}$ 后，计算最终的总守恒量 $M_{\\mathrm{cons}}^{n+1}$、$P_{\\mathrm{cons}}^{n+1}$ 和 $E_{\\mathrm{tot}, \\mathrm{cons}}^{n+1}$。该格式在周期性网格上的关键特性是通量差值的总和会伸缩为零，即 $\\sum_{i=0}^{N-1} (F^*_{i+1/2} - F^*_{i-1/2}) = 0$，从而确保 $\\sum_i U_i^{n+1} = \\sum_i U_i^n$。因此，总守恒量的任何变化将仅由浮点运算误差引起。\n\n3.  **非守恒原始变量格式**：该格式直接离散化欧拉方程的非守恒形式并更新原始变量。空间导数使用二阶中心差分近似，例如 $\\partial_x w |_i \\approx (w_{i+1} - w_{i-1}) / (2\\Delta x)$。在每个单元中心使用离散化的非守恒方程计算时间导数 $(\\partial_t \\rho, \\partial_t u, \\partial_t p)$。一个显式欧拉时间步更新原始变量：\n    $$\n    \\rho_i^{n+1} = \\rho_i^n + \\Delta t (\\partial_t \\rho)_i^n\n    $$\n    $$\n    u_i^{n+1} = u_i^n + \\Delta t (\\partial_t u)_i^n\n    $$\n    $$\n    p_i^{n+1} = p_i^n + \\Delta t (\\partial_t p)_i^n\n    $$\n    在获得新的原始变量 $(\\rho_{\\mathrm{prim}}^{n+1}, u_{\\mathrm{prim}}^{n+1}, p_{\\mathrm{prim}}^{n+1})$ 后，将它们转换回守恒变量。然后计算最终的总量 $M_{\\mathrm{prim}}^{n+1}$、$P_{\\mathrm{prim}}^{n+1}$ 和 $E_{\\mathrm{tot}, \\mathrm{prim}}^{n+1}$。该格式不具备伸缩求和的特性，因此即使对于光滑流动，也预计不会守恒总量。离散化误差会引入人为的质量、动量和能量的源或汇。\n\n4.  **分析**：对于两种格式，每个守恒量的变化都计算为最终总量和初始总量之间的绝对差值。对于守恒格式，这些变化表示为 $\\Delta M_{\\mathrm{cons}}$、$\\Delta P_{\\mathrm{cons}}$、$\\Delta E_{\\mathrm{cons}}$。对于原始变量格式，它们是 $\\Delta M_{\\mathrm{prim}}$、$\\Delta P_{\\mathrm{prim}}$、$\\Delta E_{\\mathrm{prim}}$。每个测试用例报告这六个值。正如理论所预测的，守恒格式的变化量应在机器精度级别，而非守恒格式的变化量将显著更大，这表明其未能保持离散守恒。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the numerical experiment comparing conservative and \n    non-conservative schemes for the 1D Euler equations.\n    \"\"\"\n    \n    test_cases = [\n        # Test 1\n        {'N': 128, 'CFL': 0.5, 'k': 2, 'rho0': 1.0, 'u0': 0.0, 'p0': 1.0,\n         'arho': 0.1, 'au': 0.1, 'ap': 0.1, 'phirho': 0.0, 'phiu': 0.0, 'phip': 0.0},\n        # Test 2\n        {'N': 128, 'CFL': 0.5, 'k': 3, 'rho0': 1.0, 'u0': 0.0, 'p0': 1.0,\n         'arho': 1e-8, 'au': 1e-8, 'ap': 1e-8, 'phirho': 0.0, 'phiu': 0.0, 'phip': 0.0},\n        # Test 3\n        {'N': 128, 'CFL': 0.5, 'k': 1, 'rho0': 1.0, 'u0': 0.0, 'p0': 1.0,\n         'arho': 0.2, 'au': 0.0, 'ap': 0.2, 'phirho': 0.0, 'phiu': 0.0, 'phip': 0.0},\n        # Test 4\n        {'N': 128, 'CFL': 0.5, 'k': 4, 'rho0': 1.0, 'u0': 0.0, 'p0': 1.0,\n         'arho': 0.0, 'au': 0.3, 'ap': 0.3, 'phirho': 0.0, 'phiu': np.pi / 3.0, 'phip': -np.pi / 4.0},\n    ]\n\n    L = 2.0 * np.pi\n    gamma = 1.4\n    all_results = []\n\n    def prim_to_cons(rho, u, p, gamma_val):\n        rhoE = p / (gamma_val - 1.0) + 0.5 * rho * u**2\n        return np.stack([rho, rho * u, rhoE], axis=-1)\n\n    def cons_to_prim(U, gamma_val):\n        rho = U[..., 0]\n        u = U[..., 1] / rho\n        rhoE = U[..., 2]\n        p = (gamma_val - 1.0) * (rhoE - 0.5 * rho * u**2)\n        return rho, u, p\n\n    def get_flux(rho, u, p, gamma_val):\n        rhoE = p / (gamma_val - 1.0) + 0.5 * rho * u**2\n        return np.stack([rho * u, rho * u**2 + p, u * (rhoE + p)], axis=-1)\n\n    for params in test_cases:\n        N = params['N']\n        CFL = params['CFL']\n        \n        # 1. Setup grid and initial conditions\n        dx = L / N\n        x = (np.arange(N) + 0.5) * dx\n\n        rho_n = params['rho0'] + params['arho'] * np.sin(params['k'] * x + params['phirho'])\n        u_n = params['u0'] + params['au'] * np.sin(params['k'] * x + params['phiu'])\n        p_n = params['p0'] + params['ap'] * np.cos(params['k'] * x + params['phip'])\n\n        # 2. Time Step Calculation\n        c_n = np.sqrt(gamma * p_n / rho_n)\n        a_max = np.max(np.abs(u_n) + c_n)\n        dt = CFL * dx / a_max\n        \n        # 3. Initial State Analysis\n        U_n = prim_to_cons(rho_n, u_n, p_n, gamma)\n        M_n = np.sum(U_n[:, 0]) * dx\n        P_n = np.sum(U_n[:, 1]) * dx\n        E_n = np.sum(U_n[:, 2]) * dx\n        \n        # --- Scheme 1: Conservative Finite-Volume Update ---\n        U_cons = np.copy(U_n)\n        fluxes = np.zeros_like(U_n)\n\n        # Loop over faces i + 1/2\n        for i in range(N):\n            i_right = (i + 1) % N\n            \n            U_L = U_cons[i, :]\n            U_R = U_cons[i_right, :]\n            \n            rho_L, u_L, p_L = cons_to_prim(U_L, gamma)\n            rho_R, u_R, p_R = cons_to_prim(U_R, gamma)\n            \n            c_L = np.sqrt(gamma * p_L / rho_L)\n            c_R = np.sqrt(gamma * p_R / rho_R)\n            \n            F_L = get_flux(rho_L, u_L, p_L, gamma)\n            F_R = get_flux(rho_R, u_R, p_R, gamma)\n            \n            a_max_face = max(np.abs(u_L) + c_L, np.abs(u_R) + c_R)\n            \n            fluxes[i, :] = 0.5 * (F_L + F_R) - 0.5 * a_max_face * (U_R - U_L)\n        \n        U_cons_np1 = U_cons - (dt / dx) * (fluxes - np.roll(fluxes, 1, axis=0))\n        \n        M_cons_np1 = np.sum(U_cons_np1[:, 0]) * dx\n        P_cons_np1 = np.sum(U_cons_np1[:, 1]) * dx\n        E_cons_np1 = np.sum(U_cons_np1[:, 2]) * dx\n        \n        delta_M_cons = np.abs(M_cons_np1 - M_n)\n        delta_P_cons = np.abs(P_cons_np1 - P_n)\n        delta_E_cons = np.abs(E_cons_np1 - E_n)\n        \n        # --- Scheme 2: Non-Conservative Primitive-Variable Update ---\n        rho_prim, u_prim, p_prim = np.copy(rho_n), np.copy(u_n), np.copy(p_n)\n        \n        # Central differences for spatial derivatives\n        d_rho_dx = (np.roll(rho_prim, -1) - np.roll(rho_prim, 1)) / (2.0 * dx)\n        d_u_dx = (np.roll(u_prim, -1) - np.roll(u_prim, 1)) / (2.0 * dx)\n        d_p_dx = (np.roll(p_prim, -1) - np.roll(p_prim, 1)) / (2.0 * dx)\n        \n        # Time derivatives from primitive equations\n        d_rho_dt = -u_prim * d_rho_dx - rho_prim * d_u_dx\n        d_u_dt = -u_prim * d_u_dx - (1.0 / rho_prim) * d_p_dx\n        d_p_dt = -u_prim * d_p_dx - gamma * p_prim * d_u_dx\n        \n        # Explicit Euler update\n        rho_prim_np1 = rho_prim + dt * d_rho_dt\n        u_prim_np1 = u_prim + dt * d_u_dt\n        p_prim_np1 = p_prim + dt * d_p_dt\n        \n        U_prim_np1 = prim_to_cons(rho_prim_np1, u_prim_np1, p_prim_np1, gamma)\n        \n        M_prim_np1 = np.sum(U_prim_np1[:, 0]) * dx\n        P_prim_np1 = np.sum(U_prim_np1[:, 1]) * dx\n        E_prim_np1 = np.sum(U_prim_np1[:, 2]) * dx\n\n        delta_M_prim = np.abs(M_prim_np1 - M_n)\n        delta_P_prim = np.abs(P_prim_np1 - P_n)\n        delta_E_prim = np.abs(E_prim_np1 - E_n)\n        \n        all_results.append([\n            delta_M_cons, delta_P_cons, delta_E_cons,\n            delta_M_prim, delta_P_prim, delta_E_prim\n        ])\n\n    print(f\"[{','.join([f'[{\",\".join(map(str, r))}]' for r in all_results])}]\")\n\nsolve()\n```", "id": "3304148"}]}