{"hands_on_practices": [{"introduction": "欧拉-欧拉双流体模型的一个核心挑战是处理相间耦合项，例如曳力。这些项通常具有非常快的时间尺度，导致控制方程组变得“刚性”。本练习将指导您分析这种刚性对显式时间积分格式稳定性的影响。通过对曳力耦合算子进行线性化并计算其特征值，您将亲手推导出稳定时间步长的上限，从而深刻理解为何在多相流模拟中，显式格式的计算成本可能过高，而隐式或隐式-显式（IMEX）方法往往是必需的 [@problem_id:3315453]。", "problem": "考虑一个均匀、充分混合的气-液系统，该系统采用计算流体动力学 (CFD) 中的欧拉-欧拉 (Eulerian–Eulerian) 两流体模型进行建模。关注单个计算单元，在该单元中，与相间曳力相比，对流项、压力梯度项和粘性应力项可以忽略不计。气相的密度为 $\\rho_{g} = 1.2$ $\\mathrm{kg/m^{3}}$，体积分数为 $\\alpha_{g} = 0.10$；而液相的密度为 $\\rho_{\\ell} = 1000$ $\\mathrm{kg/m^{3}}$，体积分数为 $\\alpha_{\\ell} = 0.90$。在所关注的时间步长内，相间动量交换系数（曳力系数）取为常数 $K = 150$ $\\mathrm{kg/(m^{3}\\,s)}$。\n\n从单位体积的相动量平衡方程和针对相间曳力的牛顿第三定律出发，推导两相纯曳力耦合速度动力学的线性化算子。确定其特征值，并由此计算仅针对曳力源项的显式前向欧拉 (Forward Euler) 时间离散化的最大稳定时间步长 $\\Delta t_{\\max}$，使用线性化曳力耦合算子的谱半径作为控制稳定性的量。以秒为单位表示最终的时间步长界限，并将答案四舍五入到四位有效数字。", "solution": "首先根据所需标准对问题进行验证。\n\n### 问题验证\n\n**步骤 1：提取已知条件**\n\n-   模型：计算流体动力学 (CFD) 中的欧拉-欧拉 (Eulerian–Eulerian) 两流体模型。\n-   系统：单个计算单元内的均匀、充分混合的气-液系统。\n-   假设：对流项、压力梯度项和粘性应力项可忽略不计。相间动量交换以曳力为主导。\n-   气相密度：$\\rho_{g} = 1.2$ $\\mathrm{kg/m^{3}}$。\n-   气相体积分数：$\\alpha_{g} = 0.10$。\n-   液相密度：$\\rho_{\\ell} = 1000$ $\\mathrm{kg/m^{3}}$。\n-   液体积分数：$\\alpha_{\\ell} = 0.90$。\n-   相间动量交换系数：$K = 150$ $\\mathrm{kg/(m^{3}\\,s)}$。\n-   数值格式：针对曳力源项的显式前向欧拉 (Forward Euler) 时间离散化。\n-   目标：推导线性化曳力耦合算子，求其特征值，并使用谱半径求最大稳定时间步长 $\\Delta t_{\\max}$。\n-   结果要求：将最终答案四舍五入到四位有效数字。\n\n**步骤 2：使用提取的已知条件进行验证**\n\n-   **科学基础（关键）：** 该问题基于成熟的欧拉-欧拉两流体模型，这是多相流 CFD 的标准框架。动量方程和相间曳力公式植根于基本守恒定律和经典力学。对于像曳力这样的刚性源项的数值稳定性分析是计算科学中的一个标准且关键的课题。物理参数对于空气-水系统是符合实际的。\n-   **适定性：** 问题定义清晰，数据充分且一致 ($\\alpha_{g} + \\alpha_{\\ell} = 0.10 + 0.90 = 1.0$)。所做的简化导出一个可解的线性常微分方程组，对于指定的数值格式，可以确定唯一的稳定性界限。\n-   **客观性（关键）：** 问题以精确、定量且无偏见的技术语言陈述。它不含任何主观或基于意见的内容。\n\n**步骤 3：结论与行动**\n\n该问题有效，因为它科学合理、适定且客观。将提供完整的解答。\n\n### 解答\n\n出发点是根据问题陈述简化的每一相 $k$（其中 $k$ 可以是气相 $g$ 或液相 $\\ell$）的相动量平衡方程。通过忽略对流项、压力梯度项和粘性项，相 $k$ 的单位体积动量方程简化为：\n$$\n\\frac{\\partial}{\\partial t}(\\alpha_{k} \\rho_{k} \\mathbf{u}_{k}) = \\mathbf{M}_{k}\n$$\n其中 $\\alpha_{k}$ 是体积分数，$\\rho_{k}$ 是密度，$\\mathbf{u}_{k}$ 是相 $k$ 的速度，$\\mathbf{M}_{k}$ 是相间动量传递项（曳力）。由于在一个时间步长内，单元中的属性 $\\alpha_{k}$ 和 $\\rho_{k}$ 是常数，我们可以写出：\n$$\n\\alpha_{k} \\rho_{k} \\frac{d\\mathbf{u}_{k}}{dt} = \\mathbf{M}_{k}\n$$\n相间动量传递是由曳力引起的，根据牛顿第三定律，$\\mathbf{M}_{g} = -\\mathbf{M}_{\\ell}$。液相作用于气相的曳力由下式给出：\n$$\n\\mathbf{M}_{g} = K (\\mathbf{u}_{\\ell} - \\mathbf{u}_{g})\n$$\n因此，作用于液相的曳力为：\n$$\n\\mathbf{M}_{\\ell} = K (\\mathbf{u}_{g} - \\mathbf{u}_{\\ell})\n$$\n其中 $K$ 是相间动量交换系数。\n\n将这些曳力项代入气相 ($g$) 和液相 ($\\ell$) 的简化动量方程，我们得到：\n$$\n\\alpha_{g} \\rho_{g} \\frac{d\\mathbf{u}_{g}}{dt} = K (\\mathbf{u}_{\\ell} - \\mathbf{u}_{g})\n$$\n$$\n\\alpha_{\\ell} \\rho_{\\ell} \\frac{d\\mathbf{u}_{\\ell}}{dt} = K (\\mathbf{u}_{g} - \\mathbf{u}_{\\ell})\n$$\n速度分量之间的耦合是线性的和各向同性的，因此我们可以分析单个速度分量（例如，$x$方向）而不失一般性。设 $u_g$ 和 $u_\\ell$ 为这些分量。常微分方程组 (ODEs) 变为：\n$$\n\\frac{du_{g}}{dt} = \\frac{K}{\\alpha_{g} \\rho_{g}} (u_{\\ell} - u_{g})\n$$\n$$\n\\frac{du_{\\ell}}{dt} = \\frac{K}{\\alpha_{\\ell} \\rho_{\\ell}} (u_{g} - u_{\\ell})\n$$\n这个系统可以写成矩阵形式 $\\frac{d\\mathbf{u}}{dt} = \\mathbf{J}\\mathbf{u}$，其中 $\\mathbf{u} = \\begin{pmatrix} u_g \\\\ u_\\ell \\end{pmatrix}$：\n$$\n\\frac{d}{dt} \\begin{pmatrix} u_g \\\\ u_\\ell \\end{pmatrix} = \n\\begin{pmatrix} \n-\\frac{K}{\\alpha_{g} \\rho_{g}} & \\frac{K}{\\alpha_{g} \\rho_{g}} \\\\\n\\frac{K}{\\alpha_{\\ell} \\rho_{\\ell}} & -\\frac{K}{\\alpha_{\\ell} \\rho_{\\ell}}\n\\end{pmatrix}\n\\begin{pmatrix} u_g \\\\ u_\\ell \\end{pmatrix}\n$$\n矩阵 $\\mathbf{J}$ 是曳力耦合速度动力学的线性化算子：\n$$\n\\mathbf{J} = \\begin{pmatrix} \n-C_g & C_g \\\\\nC_\\ell & -C_\\ell\n\\end{pmatrix}\n$$\n这里我们定义了逆松弛时间 $C_g = \\frac{K}{\\alpha_{g} \\rho_{g}}$ 和 $C_\\ell = \\frac{K}{\\alpha_{\\ell} \\rho_{\\ell}}$。\n\n接下来，我们通过求解特征方程 $\\det(\\mathbf{J} - \\lambda \\mathbf{I}) = 0$ 来确定算子 $\\mathbf{J}$ 的特征值 $\\lambda$：\n$$\n\\det \\begin{pmatrix} \n-C_g - \\lambda & C_g \\\\\nC_\\ell & -C_\\ell - \\lambda\n\\end{pmatrix} = 0\n$$\n$$\n(-C_g - \\lambda)(-C_\\ell - \\lambda) - (C_g)(C_\\ell) = 0\n$$\n$$\nC_g C_\\ell + C_g \\lambda + C_\\ell \\lambda + \\lambda^2 - C_g C_\\ell = 0\n$$\n$$\n\\lambda^2 + (C_g + C_\\ell)\\lambda = 0\n$$\n$$\n\\lambda(\\lambda + C_g + C_\\ell) = 0\n$$\n特征值为：\n$$\n\\lambda_1 = 0\n$$\n$$\n\\lambda_2 = -(C_g + C_\\ell)\n$$\n特征值 $\\lambda_1 = 0$ 对应于封闭系统中总动量的守恒。特征值 $\\lambda_2$ 控制速度滑移向共同速度的指数松弛过程。\n\n对于常微分方程组 $\\frac{d\\mathbf{u}}{dt} = \\mathbf{J}\\mathbf{u}$ 的显式前向欧拉 (Forward Euler) 离散，其格式为 $\\mathbf{u}^{n+1} = \\mathbf{u}^{n} + \\Delta t \\mathbf{J} \\mathbf{u}^{n} = (\\mathbf{I} + \\Delta t \\mathbf{J})\\mathbf{u}^{n}$。数值稳定性的条件是，放大矩阵 $(\\mathbf{I} + \\Delta t \\mathbf{J})$ 的所有特征值的模都必须小于或等于 $1$。该矩阵的特征值为 $1 + \\Delta t \\lambda_k$，其中 $\\lambda_k$ 是 $\\mathbf{J}$ 的特征值。\n对于 $\\lambda_1 = 0$，条件为 $|1 + \\Delta t \\cdot 0| = 1 \\le 1$，此条件总是满足。\n对于 $\\lambda_2 = -(C_g + C_\\ell)$，条件为 $|1 + \\Delta t \\lambda_2| \\le 1$：\n$$\n|1 - \\Delta t (C_g + C_\\ell)| \\le 1\n$$\n由于 $\\Delta t$、$C_g$ 和 $C_\\ell$ 均为正值，这展开为：\n$$\n-1 \\le 1 - \\Delta t (C_g + C_\\ell) \\le 1\n$$\n右侧不等式 $1 - \\Delta t(C_g + C_\\ell) \\le 1$ 意味着 $-\\Delta t(C_g + C_\\ell) \\le 0$，这总是成立的。\n左侧不等式给出了稳定性极限：\n$$\n-1 \\le 1 - \\Delta t (C_g + C_\\ell)\n$$\n$$\n\\Delta t (C_g + C_\\ell) \\le 2\n$$\n$$\n\\Delta t \\le \\frac{2}{C_g + C_\\ell}\n$$\n该算子的谱半径为 $\\rho(\\mathbf{J}) = \\max(|\\lambda_1|, |\\lambda_2|) = |-(C_g + C_\\ell)| = C_g + C_\\ell$。因此，最大稳定时间步长 $\\Delta t_{\\max}$ 为：\n$$\n\\Delta t_{\\max} = \\frac{2}{C_g + C_\\ell} = \\frac{2}{\\frac{K}{\\alpha_{g} \\rho_{g}} + \\frac{K}{\\alpha_{\\ell} \\rho_{\\ell}}}\n$$\n现在，我们代入给定的数值：\n$\\rho_{g} = 1.2$ $\\mathrm{kg/m^{3}}$，$\\alpha_{g} = 0.10$，所以 $\\alpha_{g} \\rho_{g} = 0.10 \\times 1.2 = 0.12$ $\\mathrm{kg/m^{3}}$。\n$\\rho_{\\ell} = 1000$ $\\mathrm{kg/m^{3}}$，$\\alpha_{\\ell} = 0.90$，所以 $\\alpha_{\\ell} \\rho_{\\ell} = 0.90 \\times 1000 = 900$ $\\mathrm{kg/m^{3}}$。\n$K = 150$ $\\mathrm{kg/(m^{3}\\,s)}$。\n\n我们计算 $C_g$ 和 $C_\\ell$：\n$$\nC_g = \\frac{150}{0.12} = 1250 \\text{ s}^{-1}\n$$\n$$\nC_\\ell = \\frac{150}{900} = \\frac{1}{6} \\text{ s}^{-1}\n$$\n它们的和是：\n$$\nC_g + C_\\ell = 1250 + \\frac{1}{6} = \\frac{7500}{6} + \\frac{1}{6} = \\frac{7501}{6} \\text{ s}^{-1}\n$$\n最大稳定时间步长是：\n$$\n\\Delta t_{\\max} = \\frac{2}{C_g + C_\\ell} = \\frac{2}{7501/6} = \\frac{12}{7501} \\text{ s}\n$$\n最后，我们计算数值并四舍五入到四位有效数字：\n$$\n\\Delta t_{\\max} = \\frac{12}{7501} \\approx 0.0015997867 \\text{ s}\n$$\n四舍五入到四位有效数字，我们得到 $0.001600$ s。", "answer": "$$\\boxed{0.001600}$$", "id": "3315453"}, {"introduction": "即使数值格式在时间上是稳定的，在强激波或刚性相间松弛等极端情况下，显式更新仍可能导致非物理结果，例如负密度或超出 $[0, 1]$ 范围的体积分数。确保解的物理真实性是构建鲁棒求解器的关键。本练习将介绍一种强大的技术——保正限制器，通过动态缩放更新增量来强制施加物理约束，从而确保求解器在各种条件下都能保持稳定和可靠 [@problem_id:3315467]。", "problem": "考虑在计算流体动力学（CFD）中，采用欧拉-欧拉双流体公式建模的可压缩气液混合物的一维、有限体积显式更新。对于每个相 $k\\in\\{g,\\ell\\}$，单位体积的相质量为 $m_k=\\alpha_k\\rho_k$，其中 $\\alpha_k$ 是相体积分数，$\\rho_k$ 是相密度。一个时间步长的显式更新可以写成对守恒变量的前向欧拉步，\n$$\nm_k^{\\star} \\equiv m_k^{n} + \\Delta m_k, \\quad \\alpha_g^{\\star} \\equiv \\alpha_g^{n} + \\Delta \\alpha_g,\n$$\n其中 $m_k^{n}$ 和 $\\alpha_g^{n}$ 表示旧状态，$m_k^{\\star}$ 和 $\\alpha_g^{\\star}$ 表示限制前的新状态，而 $\\Delta m_k,\\Delta \\alpha_g$ 表示由数值通量和源项（包括刚性松弛）产生的总显式增量。液体体积分数为 $\\alpha_{\\ell}=1-\\alpha_g$。基本依据是相质量守恒，\n$$\n\\partial_t(\\alpha_k\\rho_k) + \\partial_x(\\alpha_k\\rho_ku_k) = S_{m,k},\n$$\n其中 $S_{m,k}$ 代表相间质量交换。在显式格式中，强激波或刚性源项下的大通量可能导致 $m_k^{\\star}\\le 0$ 或 $\\alpha_k^{\\star}\\notin[0,1]$，这是不可接受的。容许集定义为\n$$\n\\mathcal{A}=\\left\\{(\\alpha_g,\\alpha_{\\ell},m_g,m_{\\ell}) \\,\\middle|\\, \\epsilon_{\\alpha}\\le \\alpha_g \\le 1-\\epsilon_{\\alpha},\\ \\alpha_{\\ell}=1-\\alpha_g,\\ m_g\\ge \\epsilon_{m},\\ m_{\\ell}\\ge \\epsilon_{m}\\right\\},\n$$\n其中选择小的下限值 $\\epsilon_{\\alpha}>0$ 和 $\\epsilon_{m}>0$ 以避免除以零并保持严格正性。密度通过以下方式从 $m_k$ 和 $\\alpha_k$ 中恢复：\n$$\n\\rho_k = \\frac{m_k}{\\alpha_k}.\n$$\n您的任务是从 $\\mathcal{A}$ 的凸性和显式更新结构出发，推导一个单一标量的保正限制器，该限制器构造一个受限的更新\n$$\nm_k^{n+1} = m_k^{n} + \\theta\\,\\Delta m_k,\\quad \\alpha_g^{n+1} = \\alpha_g^{n} + \\theta\\,\\Delta \\alpha_g,\\quad \\alpha_{\\ell}^{n+1}=1-\\alpha_g^{n+1},\n$$\n其缩放因子 $0\\le \\theta \\le 1$ 使得受限状态位于 $\\mathcal{A}$ 内，并产生严格为正的密度 $\\rho_k^{n+1}>0$。从基本质量平衡和作为凸约束集的 $\\mathcal{A}$ 的定义出发，推导对 $\\theta$ 的条件，以同时强制执行：\n- 质量下限 $m_k^{n+1}\\ge \\epsilon_{m}$（对于 $k\\in\\{g,\\ell\\}$），\n- 体积分数下限和上限 $\\epsilon_{\\alpha}\\le \\alpha_g^{n+1}\\le 1-\\epsilon_{\\alpha}$，\n并证明选择\n$$\n\\theta=\\min\\Big(1,\\ \\theta_{m,g},\\ \\theta_{m,\\ell},\\ \\theta_{\\alpha,\\mathrm{low}},\\ \\theta_{\\alpha,\\mathrm{up}}\\Big)\n$$\n其中适当定义的特定于约束的缩放因子 $\\theta_{(\\cdot)}\\in[0,1]$，可以保证 $m_k^{n+1}\\ge \\epsilon_{m}$ 和 $\\epsilon_{\\alpha}\\le \\alpha_g^{n+1}\\le 1-\\epsilon_{\\alpha}$，从而保证 $\\rho_k^{n+1}>0$。\n\n然后，在一个程序中实现所推导的限制器，对于一组给定的测试用例，该程序计算受限更新，并返回限制后的 $(\\theta,\\alpha_g^{n+1},\\alpha_{\\ell}^{n+1},\\rho_g^{n+1},\\rho_{\\ell}^{n+1})$ 以及一个布尔值，该布尔值指示是否所有约束都得到满足。使用以下物理上合理的测试套件，该套件对限制器的不同方面进行压力测试。密度必须以 $\\mathrm{kg/m^3}$ 表示：\n\n- 测试用例 1 (正常路径，适度更新)：\n  - $\\alpha_g^{n}=0.4$，$\\rho_g^{n}=5\\,\\mathrm{kg/m^3}$，$\\rho_{\\ell}^{n}=950\\,\\mathrm{kg/m^3}$，\n  - $\\Delta \\alpha_g=-0.02$，$\\Delta m_g=-0.1\\,\\mathrm{kg/m^3}$，$\\Delta m_{\\ell}=+0.1\\,\\mathrm{kg/m^3}$。\n\n- 测试用例 2 (强激波，无限制时气体质量变为负值)：\n  - $\\alpha_g^{n}=0.3$，$\\rho_g^{n}=8\\,\\mathrm{kg/m^3}$，$\\rho_{\\ell}^{n}=1000\\,\\mathrm{kg/m^3}$，\n  - $\\Delta \\alpha_g=-0.05$，$\\Delta m_g=-3.0\\,\\mathrm{kg/m^3}$，$\\Delta m_{\\ell}=+2.0\\,\\mathrm{kg/m^3}$。\n\n- 测试用例 3 (刚性松弛，体积分数超过 1)：\n  - $\\alpha_g^{n}=0.5$，$\\rho_g^{n}=2\\,\\mathrm{kg/m^3}$，$\\rho_{\\ell}^{n}=900\\,\\mathrm{kg/m^3}$，\n  - $\\Delta \\alpha_g=+0.8$，$\\Delta m_g=+0.1\\,\\mathrm{kg/m^3}$，$\\Delta m_{\\ell}=-0.1\\,\\mathrm{kg/m^3}$。\n\n- 测试用例 4 (接近真空的气体分数，可能出现下溢)：\n  - $\\alpha_g^{n}=10^{-6}$，$\\rho_g^{n}=0.8\\,\\mathrm{kg/m^3}$，$\\rho_{\\ell}^{n}=1000\\,\\mathrm{kg/m^3}$，\n  - $\\Delta \\alpha_g=-10^{-3}$，$\\Delta m_g=-10^{-5}\\,\\mathrm{kg/m^3}$，$\\Delta m_{\\ell}=+10^{-2}\\,\\mathrm{kg/m^3}$。\n\n- 测试用例 5 (几乎纯液体，无限制时违反气体分数上限)：\n  - $\\alpha_g^{n}=1-10^{-9}$，$\\rho_g^{n}=10\\,\\mathrm{kg/m^3}$，$\\rho_{\\ell}^{n}=1000\\,\\mathrm{kg/m^3}$，\n  - $\\Delta \\alpha_g=+0.1$，$\\Delta m_g=+1.0\\,\\mathrm{kg/m^3}$，$\\Delta m_{\\ell}=-1.0\\,\\mathrm{kg/m^3}$。\n\n使用下限值 $\\epsilon_{\\alpha}=10^{-9}$ 和 $\\epsilon_{m}=10^{-12}\\,\\mathrm{kg/m^3}$。密度必须计算为 $\\rho_k^{n+1}=m_k^{n+1}/\\max(\\alpha_k^{n+1},\\epsilon_{\\alpha})$ 以避免除以零，并且必须以 $\\mathrm{kg/m^3}$ 为单位报告。当且仅当 $0\\le \\alpha_g^{n+1}\\le 1$、$0\\le \\alpha_{\\ell}^{n+1}\\le 1$、$\\rho_g^{n+1}>0$ 和 $\\rho_{\\ell}^{n+1}>0$ 时，该布尔值必须为真。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，每个测试用例的结果本身就是一个按 $[\\theta,\\alpha_g^{n+1},\\alpha_{\\ell}^{n+1},\\rho_g^{n+1},\\rho_{\\ell}^{n+1},\\mathrm{ok}]$ 顺序排列的列表。例如，最终输出必须如下所示\n$$\n\\big[\\,[\\cdots],\\,[\\cdots],\\,[\\cdots],\\,[\\cdots],\\,[\\cdots]\\,\\big],\n$$\n其中 $\\theta$、$\\alpha_g^{n+1}$、$\\alpha_{\\ell}^{n+1}$、$\\rho_g^{n+1}$ 和 $\\rho_{\\ell}^{n+1}$ 为浮点数（单位为 $\\mathrm{kg/m^3}$），$\\mathrm{ok}$ 为布尔值。", "solution": "该问题要求推导并实现一个用于一维可压缩双流体模型的保正限制器，该模型使用显式时间步进格式。其目标是确保更新后的状态变量保持在物理容许集 $\\mathcal{A}$ 内，该集合由相质量的下限以及相体积分数的下限/上限定义。\n\n新时间层 $n+1$ 的状态是通过使用单一标量因子 $\\theta \\in [0, 1]$ 缩放显式增量 $(\\Delta m_k, \\Delta \\alpha_g)$，从旧时间层 $n$ 的状态构造得出的。更新后的状态由以下公式给出：\n$$\nm_k^{n+1} = m_k^{n} + \\theta\\,\\Delta m_k, \\quad k \\in \\{g, \\ell\\}\n$$\n$$\n\\alpha_g^{n+1} = \\alpha_g^{n} + \\theta\\,\\Delta \\alpha_g\n$$\n$$\n\\alpha_{\\ell}^{n+1} = 1-\\alpha_g^{n+1} = \\alpha_{\\ell}^{n} - \\theta\\,\\Delta \\alpha_g\n$$\n我们假设旧状态 $(m_g^n, m_\\ell^n, \\alpha_g^n)$ 位于容许集 $\\mathcal{A}$ 中，即 $m_k^n \\ge \\epsilon_m$ 且 $\\epsilon_\\alpha \\le \\alpha_g^n \\le 1-\\epsilon_\\alpha$。我们的目标是找到最大的 $\\theta \\in [0, 1]$，使得新状态 $(m_g^{n+1}, m_\\ell^{n+1}, \\alpha_g^{n+1})$ 也位于 $\\mathcal{A}$ 中。这需要同时满足四个不等式约束。我们为每个约束分别推导对 $\\theta$ 的条件。\n\n**1. 气体质量下限：$m_g^{n+1} \\ge \\epsilon_{m}$**\n\n约束为 $m_g^{n} + \\theta\\,\\Delta m_g \\ge \\epsilon_{m}$。对 $\\theta$ 进行整理，我们得到 $\\theta\\,\\Delta m_g \\ge \\epsilon_{m} - m_g^{n}$。我们考虑增量 $\\Delta m_g$ 的两种情况：\n- 如果 $\\Delta m_g \\ge 0$，质量不减少。由于 $m_g^{n} \\ge \\epsilon_{m}$，对于所有 $\\theta \\ge 0$，该约束都得到满足。此约束没有对 $\\theta$ 施加上限。\n- 如果 $\\Delta m_g  0$，质量减少。除以负的 $\\Delta m_g$ 会反转不等号：\n$$\n\\theta \\le \\frac{\\epsilon_{m} - m_g^{n}}{\\Delta m_g} = \\frac{m_g^{n} - \\epsilon_{m}}{-\\Delta m_g}\n$$\n由于 $m_g^{n} \\ge \\epsilon_{m}$，分子为非负，且 $-\\Delta m_g > 0$，因此该比值为非负。我们定义一个特定于约束的缩放因子 $\\theta_{m,g}$ 来表示此上限：\n$$\n\\theta_{m,g} = \\begin{cases} \\frac{\\epsilon_{m} - m_g^{n}}{\\Delta m_g}  \\text{if } \\Delta m_g  0 \\\\ \\infty  \\text{if } \\Delta m_g \\ge 0 \\end{cases}\n$$\n使用 $\\infty$ 表示对于不减少的质量，该约束是无效的。\n\n**2. 液体质量下限：$m_{\\ell}^{n+1} \\ge \\epsilon_{m}$**\n\n推导过程与气相相同。约束为 $m_{\\ell}^{n} + \\theta\\,\\Delta m_{\\ell} \\ge \\epsilon_{m}$。这导致缩放因子 $\\theta_{m,\\ell}$：\n$$\n\\theta_{m,\\ell} = \\begin{cases} \\frac{\\epsilon_{m} - m_{\\ell}^{n}}{\\Delta m_{\\ell}}  \\text{if } \\Delta m_{\\ell}  0 \\\\ \\infty  \\text{if } \\Delta m_{\\ell} \\ge 0 \\end{cases}\n$$\n\n**3. 气体体积分数下限：$\\alpha_g^{n+1} \\ge \\epsilon_{\\alpha}$**\n\n约束为 $\\alpha_g^{n} + \\theta\\,\\Delta \\alpha_g \\ge \\epsilon_{\\alpha}$。分析方法与质量约束类似。\n- 如果 $\\Delta \\alpha_g \\ge 0$，由于 $\\alpha_g^{n} \\ge \\epsilon_{\\alpha}$，该约束得到满足。\n- 如果 $\\Delta \\alpha_g  0$，我们需要对 $\\theta$ 施加上限：\n$$\n\\theta \\le \\frac{\\epsilon_{\\alpha} - \\alpha_g^{n}}{\\Delta \\alpha_g}\n$$\n相应的缩放因子 $\\theta_{\\alpha,\\mathrm{low}}$ 为：\n$$\n\\theta_{\\alpha,\\mathrm{low}} = \\begin{cases} \\frac{\\epsilon_{\\alpha} - \\alpha_g^{n}}{\\Delta \\alpha_g}  \\text{if } \\Delta \\alpha_g  0 \\\\ \\infty  \\text{if } \\Delta \\alpha_g \\ge 0 \\end{cases}\n$$\n\n**4. 气体体积分数上限：$\\alpha_g^{n+1} \\le 1 - \\epsilon_{\\alpha}$**\n\n约束为 $\\alpha_g^{n} + \\theta\\,\\Delta \\alpha_g \\le 1 - \\epsilon_{\\alpha}$。整理后得到 $\\theta\\,\\Delta \\alpha_g \\le 1 - \\epsilon_{\\alpha} - \\alpha_g^{n}$。在这里，情况分析对 $\\Delta \\alpha_g$ 符号的依赖性有所不同。\n- 如果 $\\Delta \\alpha_g \\le 0$，体积分数不增加。由于 $\\alpha_g^{n} \\le 1 - \\epsilon_{\\alpha}$，对于 $\\theta \\ge 0$，该约束总是满足的。\n- 如果 $\\Delta \\alpha_g > 0$，我们必须限制 $\\theta$：\n$$\n\\theta \\le \\frac{1 - \\epsilon_{\\alpha} - \\alpha_g^{n}}{\\Delta \\alpha_g}\n$$\n相应的缩放因子 $\\theta_{\\alpha,\\mathrm{up}}$ 为：\n$$\n\\theta_{\\alpha,\\mathrm{up}} = \\begin{cases} \\frac{1 - \\epsilon_{\\alpha} - \\alpha_g^{n}}{\\Delta \\alpha_g}  \\text{if } \\Delta \\alpha_g > 0 \\\\ \\infty  \\text{if } \\Delta \\alpha_g \\le 0 \\end{cases}\n$$\n\n**限制器的综合**\n\n为确保同时满足所有四个约束，$\\theta$ 必须小于或等于每个推导出的上限。我们还要求限制器不放大更新，因此 $\\theta \\le 1$。为获得保持有效的最大可能更新，我们选择所有这些界限中最严格的（即最小值）。这证明了 $\\theta$ 的正确选择是：\n$$\n\\theta = \\min\\Big(1,\\ \\theta_{m,g},\\ \\theta_{m,\\ell},\\ \\theta_{\\alpha,\\mathrm{low}},\\ \\theta_{\\alpha,\\mathrm{up}}\\Big)\n$$\n这种形式明确地构造了限制器。集合 $\\mathcal{A}$ 由一组线性不等式定义，使其成为一个凸集。旧状态 $X^n = (m_g^n, m_\\ell^n, \\alpha_g^n)$ 位于 $\\mathcal{A}$ 中，而受限的新状态 $X^{n+1}$ 是 $X^n$ 和限制前状态 $X^\\star$ 的凸组合，即 $X^{n+1} = (1-\\theta)X^n + \\theta X^\\star$。我们对 $\\theta$ 的构造找到了在 $[0,1]$ 中的最大值，使得 $X^{n+1}$ 位于 $X^n$ 和 $X^\\star$ 之间的线段上，并且仍然在 $\\mathcal{A}$ 内部。\n\n**密度的正性**\n\n限制器的应用保证了新状态位于 $\\mathcal{A}$ 内。具体来说：\n- 对于 $k\\in\\{g, \\ell\\}$，$m_k^{n+1} \\ge \\epsilon_m > 0$。\n- $\\epsilon_\\alpha \\le \\alpha_g^{n+1} \\le 1-\\epsilon_\\alpha$。这意味着 $\\alpha_g^{n+1} > 0$ 且 $\\alpha_\\ell^{n+1} = 1 - \\alpha_g^{n+1} \\ge \\epsilon_\\alpha > 0$。\n\n相密度恢复为 $\\rho_k^{n+1} = m_k^{n+1} / \\alpha_k^{n+1}$。由于分子（$m_k^{n+1}$）和分母（$\\alpha_k^{n+1}$）都保证为严格正值，因此得到的密度 $\\rho_k^{n+1}$ 也严格为正。问题指定将密度计算为 $\\rho_k^{n+1}=m_k^{n+1}/\\max(\\alpha_k^{n+1},\\epsilon_{\\alpha})$，这加强了此结论，因为分母被明确阻止为零或负，并由 $\\epsilon_\\alpha > 0$ 从下方限定。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Derives and applies a positivity-preserving limiter for a two-fluid model.\n    \"\"\"\n    \n    # Define physical floors\n    eps_alpha = 1e-9\n    eps_m = 1e-12\n\n    # Test cases: (alpha_g_n, rho_g_n, rho_l_n, delta_alpha_g, delta_m_g, delta_m_l)\n    test_cases = [\n        # Test case 1 (happy path, moderate update)\n        (0.4, 5.0, 950.0, -0.02, -0.1, 0.1),\n        # Test case 2 (strong shock, gas mass goes negative without limiting)\n        (0.3, 8.0, 1000.0, -0.05, -3.0, 2.0),\n        # Test case 3 (stiff relaxation, volume fraction overshoot above unity)\n        (0.5, 2.0, 900.0, 0.8, 0.1, -0.1),\n        # Test case 4 (near-vacuum gas fraction, potential underflow)\n        (1e-6, 0.8, 1000.0, -1e-3, -1e-5, 1e-2),\n        # Test case 5 (almost pure liquid, upper bound on gas fraction violated without limiting)\n        (1.0 - 1e-9, 10.0, 1000.0, 0.1, 1.0, -1.0),\n    ]\n\n    def compute_limited_update(case_params):\n        \"\"\"\n        Computes the limited update for a single test case.\n        \"\"\"\n        alpha_g_n, rho_g_n, rho_l_n, delta_alpha_g, delta_m_g, delta_m_l = case_params\n\n        # 1. Calculate initial conservative variables\n        alpha_l_n = 1.0 - alpha_g_n\n        m_g_n = alpha_g_n * rho_g_n\n        m_l_n = alpha_l_n * rho_l_n\n\n        # 2. Calculate individual theta limiter values\n        # Note: we use (X - X_min) / (-delta_X) instead of (X_min - X) / delta_X\n        # to avoid potential floating point issues with (small_positive - large_positive).\n        \n        # theta for gas mass lower bound\n        if delta_m_g  0:\n            theta_m_g = (m_g_n - eps_m) / (-delta_m_g)\n        else:\n            theta_m_g = np.inf\n\n        # theta for liquid mass lower bound\n        if delta_m_l  0:\n            theta_m_l = (m_l_n - eps_m) / (-delta_m_l)\n        else:\n            theta_m_l = np.inf\n\n        # theta for gas volume fraction lower bound\n        if delta_alpha_g  0:\n            theta_alpha_low = (alpha_g_n - eps_alpha) / (-delta_alpha_g)\n        else:\n            theta_alpha_low = np.inf\n\n        # theta for gas volume fraction upper bound\n        if delta_alpha_g > 0:\n            theta_alpha_up = (1.0 - eps_alpha - alpha_g_n) / delta_alpha_g\n        else:\n            theta_alpha_up = np.inf\n\n        # 3. Calculate the final limiter theta\n        theta = min(1.0, theta_m_g, theta_m_l, theta_alpha_low, theta_alpha_up)\n        \n        # 4. Calculate the limited new state (n+1)\n        alpha_g_n1 = alpha_g_n + theta * delta_alpha_g\n        alpha_l_n1 = 1.0 - alpha_g_n1\n        m_g_n1 = m_g_n + theta * delta_m_g\n        m_l_n1 = m_l_n + theta * delta_m_l\n\n        # 5. Calculate new densities with floor on alpha\n        rho_g_n1 = m_g_n1 / max(alpha_g_n1, eps_alpha)\n        rho_l_n1 = m_l_n1 / max(alpha_l_n1, eps_alpha)\n        \n        # 6. Check validity (ok boolean)\n        ok = (0.0 = alpha_g_n1 = 1.0 and\n              0.0 = alpha_l_n1 = 1.0 and\n              rho_g_n1 > 0.0 and\n              rho_l_n1 > 0.0)\n\n        return [theta, alpha_g_n1, alpha_l_n1, rho_g_n1, rho_l_n1, ok]\n\n    results = []\n    for case in test_cases:\n        result = compute_limited_update(case)\n        results.append(result)\n\n    # Custom formatter to match the requested output style\n    def format_list(lst):\n        items = []\n        for item in lst:\n            if isinstance(item, list):\n                items.append(format_list(item))\n            elif isinstance(item, bool):\n                items.append(str(item).lower())\n            else:\n                items.append(f\"{item}\")\n        return f\"[{','.join(items)}]\"\n        \n    print(format_list(results))\n\nsolve()\n```", "id": "3315467"}, {"introduction": "在许多多相流问题中，流体状态由大项之间的精细平衡所决定，例如分层流或沉降流中的重力与压力梯度平衡。一个设计不佳的数值格式会破坏这种平衡，即使在静止的流体中也会产生虚假的非物理速度，从而严重影响模拟的准确性。本练习旨在探讨“井平衡格式”（well-balanced scheme）的概念，它通过特殊设计来在离散层面精确维持这些物理平衡态，从而避免数值伪影并确保高精度 [@problem_id:3315457]。", "problem": "考虑计算流体动力学（CFD）中的一个一维、垂直、欧拉-欧拉（EE）双流体模型，其中有两个不互溶的相，由 $k \\in \\{1,2\\}$ 索引，占据的体积分数为 $\\alpha_k(z,t)$ 且 $\\alpha_1 + \\alpha_2 = 1$，相密度为 $\\rho_k$（每相在空间和时间上为常数），相压力为 $p_k(z,t)$（两相之间不一定相等），相速度为 $v_k(z,t)$。设垂直坐标 $z$ 从顶部边界 $z=0$ 向下增加，重力加速度矢量为 $\\mathbf{g} = g \\mathbf{e}_z$，其中 $g0$ 且 $\\mathbf{e}_z$ 为 $+z$ 方向的单位矢量。假设没有相间动量交换，并忽略对流项和粘性项，因此第 $k$ 相的动量方程简化为源-压力平衡\n$$\n\\frac{\\partial}{\\partial t}\\big(\\alpha_k \\rho_k v_k\\big) = - \\alpha_k \\frac{\\partial p_k}{\\partial z} + \\alpha_k \\rho_k g.\n$$\n每相的静水平衡定义为\n$$\n\\frac{\\partial p_k}{\\partial z} = \\rho_k g, \\quad v_k = 0,\n$$\n该关系必须对任意的 $\\alpha_k(z)$（满足 $0 \\le \\alpha_k \\le 1$ 和 $\\alpha_1+\\alpha_2=1$）成立。您必须在均匀网格上构建一个有限体积离散化格式，该格式是“良态平衡的”（well-balanced），即对于任意 $\\alpha_k(z)$，它能精确地保持每相的静水稳态达到机器精度，同时能够处理 $\\alpha_k$ 的小扰动而不产生伪速度。\n\n从上述基本平衡定律和静水关系出发，在包含 $N$ 个单元、间距为 $\\Delta z$ 的均匀网格上，推导一个使用二阶中心差分来处理空间导数的一致的半离散格式。考虑在由 $i$ 索引的单元中心处，对压力-源项的两种替代离散化方法：\n\n- 一种近似 $\\alpha_k p_k$ 散度的“保守型”中心格式，\n$$\nR^{\\mathrm{C}}_{k,i} = - \\frac{\\big(\\alpha_{k,i+1} p_{k,i+1} - \\alpha_{k,i-1} p_{k,i-1}\\big)}{2 \\Delta z} + \\alpha_{k,i} \\rho_k g,\n$$\n- 一种将离散压力梯度乘以 $\\alpha_k$ 的“良态平衡分裂”中心格式，\n$$\nR^{\\mathrm{WB}}_{k,i} = - \\alpha_{k,i} \\frac{\\big(p_{k,i+1} - p_{k,i-1}\\big)}{2 \\Delta z} + \\alpha_{k,i} \\rho_k g.\n$$\n\n此处，$R_{k,i}$ 表示在单元 $i$ 处第 $k$ 相动量方程的离散残差（单位体积的净源项）。静水压力分布通过对静水方程从 $z=0$ 处的指定顶部边界值 $p_{k,0}$ 进行积分来定义：\n$$\np_k(z) = p_{k,0} + \\rho_k g z.\n$$\n\n通过下式定义每个单元中相速度 $v_{k,i}$ 的显式欧拉时间更新：\n$$\nv_{k,i}^{n+1} = v_{k,i}^n + \\Delta t \\, \\frac{R_{k,i}}{\\alpha_{k,i} \\rho_k},\n$$\n其中 $\\Delta t$ 是时间步长。为避免当 $\\alpha_{k,i}$ 极小时出现除以零的情况，在计算速度更新时，使用最小值裁剪 $\\alpha_{k,i} \\leftarrow \\max(\\alpha_{k,i}, \\alpha_{\\min})$，其中 $\\alpha_{\\min} = 10^{-6}$。\n\n您的程序必须实现 $R^{\\mathrm{C}}_{k,i}$ 和 $R^{\\mathrm{WB}}_{k,i}$ 两种格式，并对每种格式和每个相，在内部单元 $i=1,\\dots,N-2$ 上评估以下定量诊断指标：\n\n- 残差的离散 $L^2$ 范数，\n$$\n\\|R\\|_2 = \\sqrt{ \\frac{1}{N-2} \\sum_{i=1}^{N-2} R_{k,i}^2 },\n$$\n以牛顿每立方米（N/m$^3$）表示。\n- 最大单步速度更新绝对值，\n$$\nU_{\\max} = \\max_{1 \\le i \\le N-2} \\left| \\Delta t \\, \\frac{R_{k,i}}{\\alpha_{k,i} \\rho_k} \\right|,\n$$\n以米每秒（m/s）表示。\n\n使用以下测试套件，其中所有量都必须在国际单位制（SI）中进行解释。对于每个测试，定义网格 $z_i = i \\, \\Delta z$（$i=0,\\dots,N-1$），按 $p_{k,i} = p_{k,0} + \\rho_k g z_i$ 设置 $p_{k,i}$，按规定设置 $\\alpha_1$，然后设置 $\\alpha_2 = 1 - \\alpha_1$。在有扰动的测试中，定义 $\\alpha_1 \\leftarrow \\mathrm{clip}\\big(\\alpha_1 + \\delta \\alpha, \\alpha_{\\min}, 1 - \\alpha_{\\min}\\big)$，其中 $\\delta \\alpha$ 是给定的。\n\n- 测试 1（带有小扰动的平滑非均匀 $\\alpha_1$）：\n  - $N = 50$，$\\Delta z = 0.1$ m，$\\Delta t = 10^{-3}$ s，$g = 9.81$ m/s$^2$。\n  - $\\rho_1 = 1000$ kg/m$^3$，$\\rho_2 = 1.2$ kg/m$^3$。\n  - $p_{1,0} = 10^5$ Pa，$p_{2,0} = 10^5$ Pa。\n  - 设 $H = N \\Delta z$，$z_{\\mathrm{mid}} = H/2$，及 $L = 1.0$ m。\n  - 基础分布：$\\alpha_1(z) = 0.5 + 0.4 \\tanh\\!\\big((z - z_{\\mathrm{mid}})/L\\big)$。\n  - 扰动：$\\delta \\alpha(z) = 10^{-6} \\sin\\!\\big(2 \\pi z / H\\big)$。\n\n- 测试 2（均匀 $\\alpha_1$；零梯度的边界情况）：\n  - $N = 64$，$\\Delta z = 0.05$ m，$\\Delta t = 10^{-3}$ s，$g = 9.81$ m/s$^2$。\n  - $\\rho_1 = 1000$ kg/m$^3$，$\\rho_2 = 1.2$ kg/m$^3$。\n  - $p_{1,0} = 10^5$ Pa，$p_{2,0} = 10^5$ Pa。\n  - 基础分布：对于所有 $z$，$\\alpha_1(z) = 0.3$。\n  - 扰动：无，即 $\\delta \\alpha(z) = 0$。\n\n- 测试 3（带有不连续 $\\alpha_1$ 阶跃的粗网格；边缘情况）：\n  - $N = 4$，$\\Delta z = 0.5$ m，$\\Delta t = 10^{-3}$ s，$g = 9.81$ m/s$^2$。\n  - $\\rho_1 = 500$ kg/m$^3$，$\\rho_2 = 1500$ kg/m$^3$。\n  - $p_{1,0} = 10^5$ Pa，$p_{2,0} = 10^5$ Pa。\n  - 基础分布：当 $z  H/2$ 时 $\\alpha_1(z) = 0.9$，当 $z \\ge H/2$ 时 $\\alpha_1(z) = 0.1$，其中 $H = N \\Delta z$。\n  - 扰动：无，即 $\\delta \\alpha(z) = 0$。\n\n对于每个测试和每个相 $k$，计算四个诊断指标：保守型格式的 $L^2$ 残差范数 $\\|R^{\\mathrm{C}}\\|_2$，良态平衡分裂格式的 $L^2$ 残差范数 $\\|R^{\\mathrm{WB}}\\|_2$，保守型格式的最大绝对单步速度更新 $U^{\\mathrm{C}}_{\\max}$，以及良态平衡分裂格式的相同指标 $U^{\\mathrm{WB}}_{\\max}$。\n\n最终输出格式要求：您的程序应生成单行输出，其中包含所有结果，形式为方括号内以逗号分隔的列表，顺序如下并使用指定单位：对于测试1相1，输出 $\\|R^{\\mathrm{C}}\\|_2$ (N/m$^3$)，$\\|R^{\\mathrm{WB}}\\|_2$ (N/m$^3$)，$U^{\\mathrm{C}}_{\\max}$ (m/s)，$U^{\\mathrm{WB}}_{\\max}$ (m/s)；然后以相同顺序输出测试1相2的结果；接着是测试2相1，测试2相2，测试3相1和测试3相2。所有值必须以 SI 单位的浮点数形式打印，不含任何额外文本。示例结构（非实际值）：“[rC11,rWB11,uC11,uWB11,rC12,rWB12,uC12,uWB12,rC21, ...]”。", "solution": "该问题要求在静水条件下，对一个简化的一维双流体动量方程的两种有限体积离散格式进行分析和实现。核心任务是评估这些格式的“良态平衡”特性，这指的是一种数值方法能够精确地保持已知的物理平衡态至机器精度的能力。在此背景下，平衡态是静水平衡，其中压力梯度完全抵消重力，导致流体速度为零。\n\n首先，我们分析相动量方程中压力-源项的两种建议离散格式。相 $k$ 的简化动量平衡由下式给出：\n$$\n\\frac{\\partial}{\\partial t}\\big(\\alpha_k \\rho_k v_k\\big) = - \\alpha_k \\frac{\\partial p_k}{\\partial z} + \\alpha_k \\rho_k g.\n$$\n静水平衡由条件 $v_k = 0$ 和 $\\frac{\\partial p_k}{\\partial z} = \\rho_k g$ 定义，这必须对任意空间变化的体积分数分布 $\\alpha_k(z)$ 成立。对于处于静水平衡的系统，动量方程的右侧（RHS）必须为零。将静水压力关系代入RHS，得到：\n$$\nRHS = - \\alpha_k (\\rho_k g) + \\alpha_k \\rho_k g = 0.\n$$\n一个良态平衡的数值格式必须在离散层面上复现这种抵消，确保对于离散的静水状态，计算出的残差在机器精度内为零。\n\n问题指定了一个在间距为 $\\Delta z$、单元中心为 $z_i = i \\Delta z$ 的均匀网格上的离散静水压力分布。单元 $i$ 处的压力为 $p_{k,i} = p_{k,0} + \\rho_k g z_i$。对于这个分布，压力梯度的二阶中心差分近似是精确的：\n$$\n\\frac{p_{k,i+1} - p_{k,i-1}}{2 \\Delta z} = \\frac{(p_{k,0} + \\rho_k g z_{i+1}) - (p_{k,0} + \\rho_k g z_{i-1})}{2 \\Delta z} = \\frac{\\rho_k g (z_{i+1} - z_{i-1})}{2 \\Delta z} = \\frac{\\rho_k g (2 \\Delta z)}{2 \\Delta z} = \\rho_k g.\n$$\n\n现在，我们在内部单元 $i=1, \\dots, N-2$ 上检验两种建议的离散残差 $R^{\\mathrm{C}}_{k,i}$ 和 $R^{\\mathrm{WB}}_{k,i}$。\n\n“良态平衡分裂”格式由下式给出：\n$$\nR^{\\mathrm{WB}}_{k,i} = - \\alpha_{k,i} \\frac{p_{k,i+1} - p_{k,i-1}}{2 \\Delta z} + \\alpha_{k,i} \\rho_k g.\n$$\n代入精确的离散压力梯度，我们发现：\n$$\nR^{\\mathrm{WB}}_{k,i} = - \\alpha_{k,i} (\\rho_k g) + \\alpha_{k,i} \\rho_k g = 0.\n$$\n这表明，只要压力是静水的，“良态平衡分裂”格式的残差对于任何体积分数分布 $\\alpha_{k,i}$ 在解析上都为零。因此，该格式是良态平衡的。我们期望使用此格式的计算将产生在浮点表示误差范围内的零残差和零速度更新。\n\n“保守型”格式由下式给出：\n$$\nR^{\\mathrm{C}}_{k,i} = - \\frac{\\alpha_{k,i+1} p_{k,i+1} - \\alpha_{k,i-1} p_{k,i-1}}{2 \\Delta z} + \\alpha_{k,i} \\rho_k g.\n$$\n这种形式离散了 $-\\frac{\\partial (\\alpha_k p_k)}{\\partial z}$ 项，但没有正确表示完整的源项 $-\\alpha_k \\frac{\\partial p_k}{\\partial z}$。使用乘法法则，连续源项等价于 $-\\frac{\\partial (\\alpha_k p_k)}{\\partial z} + p_k \\frac{\\partial \\alpha_k}{\\partial z}$。“保守型”格式忽略了对 $p_k \\frac{\\partial \\alpha_k}{\\partial z}$ 项的离散化。我们来分析其在静水条件下的行为。代入 $p_{k,i} = p_{k,0} + \\rho_k g z_i$：\n$$\nR^{\\mathrm{C}}_{k,i} = - \\frac{\\alpha_{k,i+1}(p_{k,0} + \\rho_k g z_{i+1}) - \\alpha_{k,i-1}(p_{k,0} + \\rho_k g z_{i-1})}{2 \\Delta z} + \\alpha_{k,i} \\rho_k g.\n$$\n整理各项：\n$$\nR^{\\mathrm{C}}_{k,i} = - p_{k,0} \\frac{\\alpha_{k,i+1} - \\alpha_{k,i-1}}{2 \\Delta z} - \\rho_k g \\frac{\\alpha_{k,i+1} z_{i+1} - \\alpha_{k,i-1} z_{i-1}}{2 \\Delta z} + \\alpha_{k,i} \\rho_k g.\n$$\n第一项是 $-p_{k,0} \\frac{\\partial \\alpha_k}{\\partial z}$ 的离散近似。第二项近似于 $-\\rho_k g \\frac{\\partial (\\alpha_k z)}{\\partial z} = -\\rho_k g (\\alpha_k + z \\frac{\\partial \\alpha_k}{\\partial z})$。除非 $\\alpha_k$ 是常数（此时 $\\alpha_{k,i+1} = \\alpha_{k,i-1} = \\alpha_{k,i}$，表达式简化为良态平衡形式），否则得到的表达式通常不会抵消为零。当 $\\alpha_k$ 不是常数时，该格式将产生一个非零残差，这是一个数值伪影，可以从静止状态产生伪速度。\n\n实现将通过定义一个执行单个测试用例的函数来进行。该函数将：\n1.  构建一维网格 $z_i$。\n2.  根据测试用例规范，计算体积分数数组 $\\alpha_{1,i}$ 和 $\\alpha_{2,i}$，并根据需要应用扰动和裁剪。\n3.  对于每个相 $k \\in \\{1,2\\}$，计算离散静水压力数组 $p_{k,i}$。\n4.  使用与指定有限差分公式相对应的向量化的 NumPy 操作，为所有内部单元（$i=1, \\dots, N-2$）计算残差 $R^{\\mathrm{C}}_{k,i}$ 和 $R^{\\mathrm{WB}}_{k,i}$。\n5.  为每种格式计算两个所需的诊断指标：残差的离散 $L^2$ 范数 $\\|R\\|_2$ 和最大绝对单步速度更新 $U_{\\max}$。速度更新的计算将在分母中使用裁剪后的体积分数 $\\max(\\alpha_{k,i}, 10^{-6})$ 以确保稳定性。\n主程序将遍历三个指定的测试用例，调用此函数，并将结果整理成一个列表以供最终输出。根据我们的分析，我们期望 $R^{\\mathrm{WB}}$ 格式的诊断指标在所有测试中都接近于零。对于 $R^{\\mathrm{C}}$ 格式，我们期望在测试2（常数 $\\alpha_k$）中诊断指标接近于零，但在测试1（平滑变化的 $\\alpha_k$）和测试3（不连续的 $\\alpha_k$）中诊断指标为非零。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef run_test(N, dz, dt, g, rho1, rho2, p1_0, p2_0, alpha1_func, d_alpha_func=None):\n    \"\"\"\n    Runs a single test case for the well-balanced scheme problem.\n\n    Args:\n        N (int): Number of grid cells.\n        dz (float): Grid spacing.\n        dt (float): Time step.\n        g (float): Gravitational acceleration.\n        rho1 (float): Density of phase 1.\n        rho2 (float): Density of phase 2.\n        p1_0 (float): Pressure of phase 1 at z=0.\n        p2_0 (float): Pressure of phase 2 at z=0.\n        alpha1_func (callable): Function to compute the base alpha1 profile.\n        d_alpha_func (callable, optional): Function for alpha perturbation.\n\n    Returns:\n        list: A list of 8 floating-point numbers representing the diagnostics\n              (R^C_norm, R^WB_norm, U^C_max, U^WB_max) for phase 1, then phase 2.\n    \"\"\"\n    alpha_min = 1e-6\n    \n    # 1. Grid and volume fraction setup\n    z = np.arange(N) * dz\n    \n    alpha1 = alpha1_func(z, N, dz)\n    if d_alpha_func:\n        delta_alpha = d_alpha_func(z, N, dz)\n        alpha1 = np.clip(alpha1 + delta_alpha, alpha_min, 1 - alpha_min)\n        \n    alpha2 = 1.0 - alpha1\n    \n    alphas = {1: alpha1, 2: alpha2}\n    rhos = {1: rho1, 2: rho2}\n    p0s = {1: p1_0, 2: p2_0}\n    \n    results_for_test = []\n    \n    # 2. Loop over phases\n    for k in [1, 2]:\n        rho_k = rhos[k]\n        p_k0 = p0s[k]\n        alpha_k = alphas[k]\n        \n        # 3. Hydrostatic pressure profile\n        p_k = p_k0 + rho_k * g * z\n        \n        # Slicing for interior cells i=1,...,N-2:\n        # i   -> [1:-1]\n        # i+1 -> [2:]\n        # i-1 -> [:-2]\n        num_interior_cells = N - 2\n        \n        if num_interior_cells = 0:\n            results_for_test.extend([0.0, 0.0, 0.0, 0.0])\n            continue\n\n        # 4. Calculate residuals\n        # Conservative-like residual R^C\n        term1_C = -(alpha_k[2:] * p_k[2:] - alpha_k[:-2] * p_k[:-2]) / (2 * dz)\n        term2_C = alpha_k[1:-1] * rho_k * g\n        R_C = term1_C + term2_C\n        \n        # Well-balanced residual R^WB\n        term1_WB = -alpha_k[1:-1] * (p_k[2:] - p_k[:-2]) / (2 * dz)\n        term2_WB = alpha_k[1:-1] * rho_k * g\n        R_WB = term1_WB + term2_WB\n        \n        # 5. Calculate diagnostics\n        # L2 norm of residuals\n        norm_R_C = np.sqrt(np.mean(R_C**2))\n        norm_R_WB = np.sqrt(np.mean(R_WB**2))\n\n        # Max velocity update\n        # Denominator alpha for velocity update is clipped to alpha_min\n        alpha_k_denom = np.maximum(alpha_k[1:-1], alpha_min)\n        \n        # Check for division by zero in case rho_k is zero\n        if rho_k == 0:\n             U_max_C = 0.0\n             U_max_WB = 0.0\n        else:\n             U_max_C = np.max(np.abs(dt * R_C / (alpha_k_denom * rho_k)))\n             U_max_WB = np.max(np.abs(dt * R_WB / (alpha_k_denom * rho_k)))\n            \n        results_for_test.extend([norm_R_C, norm_R_WB, U_max_C, U_max_WB])\n        \n    return results_for_test\n\ndef solve():\n    \"\"\"\n    Main solver function to run all test cases and print results.\n    \"\"\"\n    test_cases = [\n        # Test 1: smooth nonuniform alpha1 with small perturbation\n        {\n            'N': 50, 'dz': 0.1, 'dt': 1e-3, 'g': 9.81,\n            'rho1': 1000.0, 'rho2': 1.2,\n            'p1_0': 1e5, 'p2_0': 1e5,\n            'alpha1_func': lambda z, N, dz: 0.5 + 0.4 * np.tanh((z - (N * dz) / 2) / 1.0),\n            'd_alpha_func': lambda z, N, dz: 1e-6 * np.sin(2 * np.pi * z / (N * dz))\n        },\n        # Test 2: uniform alpha1\n        {\n            'N': 64, 'dz': 0.05, 'dt': 1e-3, 'g': 9.81,\n            'rho1': 1000.0, 'rho2': 1.2,\n            'p1_0': 1e5, 'p2_0': 1e5,\n            'alpha1_func': lambda z, N, dz: 0.3 * np.ones_like(z),\n            'd_alpha_func': None\n        },\n        # Test 3: coarse grid with discontinuous alpha1 step\n        {\n            'N': 4, 'dz': 0.5, 'dt': 1e-3, 'g': 9.81,\n            'rho1': 500.0, 'rho2': 1500.0,\n            'p1_0': 1e5, 'p2_0': 1e5,\n            'alpha1_func': lambda z, N, dz: np.where(z  (N * dz) / 2, 0.9, 0.1),\n            'd_alpha_func': None\n        }\n    ]\n\n    all_results = []\n    for params in test_cases:\n        test_results = run_test(**params)\n        all_results.extend(test_results)\n\n    print(f\"[{','.join(map(str, all_results))}]\")\n\nsolve()\n```", "id": "3315457"}]}