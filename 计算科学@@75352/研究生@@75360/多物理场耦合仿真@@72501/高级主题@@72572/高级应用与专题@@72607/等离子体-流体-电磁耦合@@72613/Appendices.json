{"hands_on_practices": [{"introduction": "数值模拟的基石在于其能否精确地反映物理世界的基本守恒律。本练习将指导您设计一个能够严格保证电荷守恒的数值格式。通过在交错网格（Yee网格）上巧妙地布置电场、磁场和电流等变量，您将构建一个有限差分时间域（FDTD）格式，使得离散的电荷连续性方程能够达到机器精度，从而深刻理解如何从根本上构建物理上自洽且稳健的计算方法。[@problem_id:3522863]", "problem": "为耦合的等离子体-流体-电磁系统设计一个二维、周期性、均匀笛卡尔时域格式，该格式需保证离散电荷连续性在机器精度下精确成立。目标是确定未知量的交错空间布局和时间交错方式，以及一个更新序列，使得离散连续性方程在舍入误差范围内得到满足。请使用以下基本出发点和假设。\n\n1. 基本原理：\n   - 真空中有源电流密度下的麦克斯韦方程组：$\\nabla \\times \\mathbf{E}=-\\partial_t \\mathbf{B}$ 和 $\\nabla \\times \\mathbf{H}=\\partial_t \\mathbf{D}+\\mathbf{J}$，其中 $\\mathbf{D}=\\varepsilon_0 \\mathbf{E}$ 且 $\\mathbf{B}=\\mu_0 \\mathbf{H}$。电荷连续性方程为 $\\partial_t \\rho_e + \\nabla \\cdot \\mathbf{J}=0$，高斯定律为 $\\nabla \\cdot \\mathbf{D}=\\rho_e$。\n   - 传导电流密度的流体（Drude）模型：$\\partial_t \\mathbf{J} + \\nu \\mathbf{J} = \\varepsilon_0 \\omega_p^2 \\mathbf{E}$，其中 $\\nu$ 是有效碰撞频率，$\\omega_p$ 是（可能与空间相关的）等离子体频率。\n   - 二维横磁（TM$_z$）极化，磁场垂直于平面：平面内电场 $\\mathbf{E}=(E_x,E_y,0)$，平面外磁场 $\\mathbf{H}=(0,0,H_z)$，以及平面内电流密度 $\\mathbf{J}=(J_x,J_y,0)$。\n\n2. 交错网格设计要求：\n   - 在矩形网格上采用Yee型交错空间布局，以确保离散旋度和散度算子满足守恒所需的恒等式。将$E_x$置于垂直面上，$E_y$置于水平面上，$H_z$置于单元中心，将$J_x$与$E_x$同位放置，$J_y$与$E_y$同位放置，$\\rho_e$置于单元中心。选择一种时间交错方式，使得用于$\\mathbf{E}$的离散安培-麦克斯韦更新在空间和时间上都使用同位的$\\mathbf{J}$，并且得到的离散连续性方程$\\frac{\\rho_e^{n+1}-\\rho_e^n}{\\Delta t}+\\nabla_h\\cdot \\mathbf{J}^{n+1/2}=0$在机器精度下成立。此处$\\nabla_h \\cdot$表示面到中心的离散散度。\n\n3. 离散化约束：\n   - 使用一个具有$N_x \\times N_y$个单元的均匀网格，在两个方向上均采用周期性边界条件，单元尺寸为$\\Delta x=L_x/N_x$和$\\Delta y=L_y/N_y$，时间步长为$\\Delta t$。使用与交错布局一致的离散算子来构建一个格式，使得在周期性条件下，离散恒等式$\\nabla_h \\cdot (\\nabla_h \\times \\cdot)=0$精确成立。\n   - 对电磁场使用与时域有限差分（FDTD）一致的时间蛙跳格式交错，并对Drude模型使用时间中心离散化，从而在不违反连续性恒等式的情况下，由$\\mathbf{J}^{n-1/2}$和$\\mathbf{E}^n$得到$\\mathbf{J}^{n+1/2}$。初始条件必须满足离散高斯定律$\\rho_e^0=\\varepsilon_0 \\nabla_h \\cdot \\mathbf{E}^0$。\n\n4. 构造的初始条件和参数：\n   - 物理常数：$\\varepsilon_0=8.8541878128\\times 10^{-12}$ 法拉/米，$\\mu_0=4\\pi\\times 10^{-7}$ 亨利/米，以及 $c=1/\\sqrt{\\varepsilon_0 \\mu_0}$ 米/秒。\n   - 域：$L_x=0.1$ 米，$L_y=0.1$ 米。在两个方向上均使用周期性边界条件。\n   - 初始场由在适当的交错位置上求值的解析函数给出，\n     $$\n     E_x(x,y)=\\cos\\left(\\frac{2\\pi x}{L_x}\\right)+\\frac{1}{2}\\sin\\left(\\frac{4\\pi y}{L_y}\\right),\\quad\n     E_y(x,y)=0.7\\cos\\left(\\frac{2\\pi y}{L_y}\\right)-0.3\\sin\\left(\\frac{2\\pi x}{L_x}\\right),\\quad\n     H_z(x,y)=\\sin\\left(\\frac{2\\pi x}{L_x}\\right)\\sin\\left(\\frac{2\\pi y}{L_y}\\right).\n     $$\n   - 传导电流由Drude模型控制。对于空间变化的等离子体频率，使用\n     $$\n     \\omega_p(x,y)=\\omega_0\\left[1+0.5\\sin\\left(\\frac{2\\pi x}{L_x}\\right)\\cos\\left(\\frac{2\\pi y}{L_y}\\right)\\right].\n     $$\n     在每个测试案例中，碰撞频率$\\nu$在空间上是均匀的。\n\n5. 时间步长：\n   - 设$\\Delta t=\\theta \\,\\Delta t_{\\mathrm{CFL}}$，其中$\\Delta t_{\\mathrm{CFL}}=\\left(c\\sqrt{(\\Delta x)^{-2}+(\\Delta y)^{-2}}\\right)^{-1}$，$\\theta\\in(0,1]$是为每个测试案例给定的因子。三角函数内的角度以弧度为单位。\n\n6. 计算内容及结果报告方式：\n   - 在每个时间步$n\\to n+1$，使用与空间交错一致的面到中心散度定义离散电荷密度$\\rho_e^n=\\varepsilon_0 \\,\\nabla_h\\cdot \\mathbf{E}^n$。令$\\mathbf{J}^{n+1/2}$为半时间步上与$\\mathbf{E}$在空间上同位的电流。定义离散连续性残差场\n     $$\n     \\mathcal{R}^{n+1/2}=\\frac{\\rho_e^{n+1}-\\rho_e^n}{\\Delta t}+\\nabla_h\\cdot \\mathbf{J}^{n+1/2}.\n     $$\n     对于每个测试案例，运行指定时间步数的格式，并报告在所有网格单元和所有时间步中$\\mathcal{R}^{n+1/2}$的最大绝对值。将此最大值表示为一个浮点数，单位为库仑/立方米/秒（$\\mathrm{C}\\,\\mathrm{m}^{-3}\\,\\mathrm{s}^{-1}$）。\n\n7. 测试套件：\n   对于所有案例，使用上述相同的域和初始条件。每个测试案例由元组$(N_x,N_y,\\theta,\\text{steps},\\omega_0,\\nu,\\text{profile})$指定，其中profile是“vacuum”、“uniform”或“varying”之一，并按如下方式确定$\\omega_p(x,y)$：\n   - “vacuum”：$\\omega_p(x,y)\\equiv 0$。\n   - “uniform”：$\\omega_p(x,y)\\equiv \\omega_0$。\n   - “varying”：$\\omega_p(x,y)$由上述公式和指定的$\\omega_0$给出。\n\n   使用以下四个案例：\n   - 案例1（理想情况，真空）：$(16,16,0.9,10,0.0,0.0,\\text{vacuum})$。\n   - 案例2（均匀等离子体，中等碰撞）：$(8,8,0.95,20,2.0\\times 10^{11},1.0\\times 10^{10},\\text{uniform})$。\n   - 案例3（空间变化等离子体，低碰撞）：$(10,6,0.8,15,1.5\\times 10^{11},5.0\\times 10^{9},\\text{varying})$。\n   - 案例4（边界情况，微小网格，无碰撞）：$(2,2,0.5,5,1.0\\times 10^{11},0.0,\\text{uniform})$。\n\n8. 要求的最终输出格式：\n   - 你的程序应产生单行输出，包含一个用方括号括起来的逗号分隔列表，按上述案例的顺序给出结果，例如：“[r1,r2,r3,r4]”，其中每个$r_k$是案例$k$的最大绝对残差，单位为$\\mathrm{C}\\,\\mathrm{m}^{-3}\\,\\mathrm{s}^{-1}$。\n\n您的任务是：\n- 确定$E_x$、$E_y$、$H_z$、$J_x$、$J_y$和$\\rho_e$的具体交错空间布局和时间交错方式，使其与上述要求一致，推导出一个强制执行离散连续性恒等式的二阶精度更新格式，并予以实现。\n- 必须选择离散算子，使得在周期性边界条件下，进入安培定律的旋度项的散度恒为零，从而在满足$\\rho_e^0=\\varepsilon_0 \\nabla_h \\cdot \\mathbf{E}^0$的条件下，使离散连续性方程在机器精度下成立。\n- 为测试套件实现该格式，并以确切的输出格式报告所要求的结果。所有矢量微积分和代数必须在离散化的框架内表达和论证；除非能根据您的离散算子证明，否则不要假设任何连续恒等式在离散情况下也成立。", "solution": "用户提供了一个有效的、适定的计算等离子体物理问题。任务是设计并实现一个用于耦合等离子体-流体-电磁系统的数值格式，该格式能在机器精度下离散地保持电荷守恒。\n\n### 1. 问题陈述的验证\n该问题具有科学依据，基于麦克斯韦方程组和等离子体电导率的Drude模型。对数值格式的约束（交错网格、蛙跳时间步进、特定形式的离散连续性方程）在时域有限差分（FDTD）方法领域是标准的。所有必需的参数、初始条件和测试案例都已提供，使问题自洽且客观。设计一个满足离散守恒律的格式的目标是计算物理学中一项非凡但已被充分理解的任务，这证实了问题的有效性。\n\n### 2. 电荷守恒格式的设计\n\n#### 2.1. 空间和时间交错\n为了满足问题的约束，包括离散矢量恒等式$\\nabla_h \\cdot (\\nabla_h \\times \\cdot) = 0$，我们采用标准的Yee交错网格用于二维TM$_z$问题，并使用节点中心的电荷密度。设网格索引为$(i,j)$。\n- 电场分量$E_x$和同位放置的电流密度$J_x$位于$x=(i+1/2)\\Delta x, y=j\\Delta y$。\n- 电场分量$E_y$和同位放置的电流密度$J_y$位于$x=i\\Delta x, y=(j+1/2)\\Delta y$。\n- 磁场分量$H_z$位于单元中心，$x=(i+1/2)\\Delta x, y=(j+1/2)\\Delta y$。\n- 电荷密度$\\rho_e$位于网格节点，$x=i\\Delta x, y=j\\Delta y$。\n\n对于时间交错，我们使用蛙跳格式：\n- 电场$\\mathbf{E}$在整数时间步计算：$t=n\\Delta t$。\n- 磁场$\\mathbf{H}$和电流密度$\\mathbf{J}$在半整数时间步计算：$t=(n+1/2)\\Delta t$。\n\n#### 2.2. 离散方程的推导\n控制方程按如下方式离散化，以确保在空间和时间上具有二阶精度。\n\n**法拉第定律：** $\\mu_0 \\partial_t \\mathbf{H} = -\\nabla \\times \\mathbf{E}$。\n这用于将$H_z$从步$n-1/2$更新到$n+1/2$，时间中心在$n$：\n$$\n\\mu_0 \\frac{H_z^{n+1/2} - H_z^{n-1/2}}{\\Delta t} = -(\\nabla_h \\times \\mathbf{E}^n)_z\n$$\n离散旋度算子，在$H_z$位置$(i+1/2, j+1/2)$处计算：\n$$\n(\\nabla_h \\times \\mathbf{E}^n)_{i+1/2, j+1/2} = \\frac{E_{y, i+1, j+1/2}^n - E_{y, i, j+1/2}^n}{\\Delta x} - \\frac{E_{x, i+1/2, j+1}^n - E_{x, i+1/2, j}^n}{\\Delta y}\n$$\n\n**安培-麦克斯韦定律：** $\\varepsilon_0 \\partial_t \\mathbf{E} + \\mathbf{J} = \\nabla \\times \\mathbf{H}$。\n这用于将$\\mathbf{E}$从步$n$更新到$n+1$，时间中心在$n+1/2$：\n$$\n\\varepsilon_0 \\frac{\\mathbf{E}^{n+1} - \\mathbf{E}^n}{\\Delta t} + \\mathbf{J}^{n+1/2} = (\\nabla_h \\times \\mathbf{H})^{n+1/2}\n$$\n离散旋度算子，在$\\mathbf{E}$分量位置处计算：\n$$\n(\\nabla_h \\times \\mathbf{H})_{x, i+1/2, j} = \\frac{H_{z, i+1/2, j+1/2} - H_{z, i+1/2, j-1/2}}{\\Delta y}\n$$\n$$\n(\\nabla_h \\times \\mathbf{H})_{y, i, j+1/2} = -\\frac{H_{z, i+1/2, j+1/2} - H_{z, i-1/2, j+1/2}}{\\Delta x}\n$$\n\n**Drude模型：** $\\partial_t \\mathbf{J} + \\nu \\mathbf{J} = \\varepsilon_0 \\omega_p^2 \\mathbf{E}$。\n这用于将$\\mathbf{J}$从步$n-1/2$更新到$n+1/2$，时间中心在$n$：\n$$\n\\frac{\\mathbf{J}^{n+1/2} - \\mathbf{J}^{n-1/2}}{\\Delta t} + \\nu \\frac{\\mathbf{J}^{n+1/2} + \\mathbf{J}^{n-1/2}}{2} = \\varepsilon_0 \\omega_p^2 \\mathbf{E}^n\n$$\n解出$\\mathbf{J}^{n+1/2}$得到一个显式更新式：\n$$\n\\mathbf{J}^{n+1/2} = \\left(\\frac{1/\\Delta t - \\nu/2}{1/\\Delta t + \\nu/2}\\right) \\mathbf{J}^{n-1/2} + \\left(\\frac{\\varepsilon_0 \\omega_p^2}{1/\\Delta t + \\nu/2}\\right) \\mathbf{E}^n\n$$\n\n#### 2.3. 离散电荷守恒的证明\n问题要求检查离散连续性方程的残差$\\mathcal{R}^{n+1/2} = \\frac{\\rho_e^{n+1} - \\rho_e^n}{\\Delta t} + \\nabla_h \\cdot \\mathbf{J}^{n+1/2}$。电荷密度由高斯定律定义：$\\rho_e^n = \\varepsilon_0 \\nabla_h \\cdot \\mathbf{E}^n$。将此代入残差表达式：\n$$\n\\mathcal{R}^{n+1/2} = \\frac{\\varepsilon_0 \\nabla_h \\cdot \\mathbf{E}^{n+1} - \\varepsilon_0 \\nabla_h \\cdot \\mathbf{E}^n}{\\Delta t} + \\nabla_h \\cdot \\mathbf{J}^{n+1/2}\n$$\n利用离散散度算子$\\nabla_h \\cdot$的线性性：\n$$\n\\mathcal{R}^{n+1/2} = \\nabla_h \\cdot \\left( \\varepsilon_0 \\frac{\\mathbf{E}^{n+1} - \\mathbf{E}^n}{\\Delta t} + \\mathbf{J}^{n+1/2} \\right)\n$$\n根据我们的离散安培-麦克斯韦定律，括号中的项等于$(\\nabla_h \\times \\mathbf{H})^{n+1/2}$。因此，\n$$\n\\mathcal{R}^{n+1/2} = \\nabla_h \\cdot ((\\nabla_h \\times \\mathbf{H})^{n+1/2})\n$$\n所选的交错网格和中心差分算子确保了对于在周期性边界条件下的网格上定义的任何场，离散旋度的离散散度恒为零（$\\nabla_h \\cdot (\\nabla_h \\times \\cdot) \\equiv 0$）。因此，残差$\\mathcal{R}^{n+1/2}$在每个时间步上数学上为零。实现将产生一个与机器浮点精度相当的值。\n\n### 3. 实现算法\n模拟按以下步骤进行：\n\n1.  **初始化：**\n    - 定义网格参数$(\\Delta x, \\Delta y, \\Delta t)$。\n    - 为所有交错场分量设置坐标数组。\n    - 使用给定的解析函数在$t=0$时初始化电场$\\mathbf{E}^0 = (E_x^0, E_y^0)$。\n    - 在$t=-\\Delta t/2$时初始化磁场$H_z^{-1/2}$。我们假设为$H_z$提供的函数是为此时刻求值的，这是当所有场的$t=0$初始条件都指定时，FDTD为了方便而采用的标准约定。\n    - 假设系统在$t0$时是静止的，将电流密度$\\mathbf{J}^{-1/2} = (J_x^{-1/2}, J_y^{-1/2})$初始化为零。\n    - 预计算Drude模型更新的系数，这些系数依赖于等离子体分布（$\\omega_p$）和碰撞频率（$\\nu$）。\n\n2.  **时间步进循环：** 对每个时间步$n$从$0$到`steps-1`：\n    a. 使用$\\mathbf{E}^n$更新磁场$H_z^{n-1/2} \\to H_z^{n+1/2}$。\n    b. 使用$\\mathbf{E}^n$更新电流密度$\\mathbf{J}^{n-1/2} \\to \\mathbf{J}^{n+1/2}$。\n    c. 使用$H_z^{n+1/2}$和$\\mathbf{J}^{n+1/2}$更新电场$\\mathbf{E}^n \\to \\mathbf{E}^{n+1}$。\n    d. 使用$\\mathbf{E}^{n+1}$、$\\mathbf{E}^n$和$\\mathbf{J}^{n+1/2}$在网格节点上计算残差场$\\mathcal{R}^{n+1/2}$。其离散散度算子为$(\\nabla_h \\cdot \\mathbf{F})_{i,j} = \\frac{F_{x,i+1/2,j} - F_{x,i-1/2,j}}{\\Delta x} + \\frac{F_{y,i,j+1/2} - F_{y,i,j-1/2}}{\\Delta y}$。\n    e. 记录网格上残差场的最大绝对值，并更新迄今为止找到的总最大值。\n    f. 为下一次迭代推进场。\n\n3.  **结果：** 循环结束后，报告在所有步和所有网格点上找到的最大绝对残差，用于该测试案例。周期性边界条件通过`numpy.roll`处理，以实现有限差分算子的高效和正确实现。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print results.\n    \"\"\"\n    # Physical constants in SI units\n    EPS0 = 8.8541878128e-12  # F/m\n    MU0 = 4 * np.pi * 1e-7   # H/m\n    C0 = 1 / np.sqrt(EPS0 * MU0) # m/s\n\n    def _solve_case(Nx, Ny, theta, steps, omega0, nu, profile):\n        \"\"\"\n        Solves one case of the coupled plasma-fluid-electromagnetic system.\n        The numerical scheme is designed to guarantee exact discrete charge continuity.\n        \"\"\"\n        # --- 1. Setup Grid, Time Step, and Domain ---\n        Lx = 0.1  # m\n        Ly = 0.1  # m\n        dx = Lx / Nx\n        dy = Ly / Ny\n        dt_cfl = 1 / (C0 * np.sqrt(1/dx**2 + 1/dy**2))\n        dt = theta * dt_cfl\n\n        # --- 2. Staggered Grid Coordinates ---\n        # Ex/Jx components are at face centers (i+1/2, j)\n        x_Ex = (np.arange(Nx) + 0.5) * dx\n        y_Ex = np.arange(Ny) * dy\n        X_Ex, Y_Ex = np.meshgrid(x_Ex, y_Ex, indexing='ij')\n        \n        # Ey/Jy components are at face centers (i, j+1/2)\n        x_Ey = np.arange(Nx) * dx\n        y_Ey = (np.arange(Ny) + 0.5) * dy\n        X_Ey, Y_Ey = np.meshgrid(x_Ey, y_Ey, indexing='ij')\n\n        # Hz components are at cell centers (i+1/2, j+1/2)\n        x_Hz = (np.arange(Nx) + 0.5) * dx\n        y_Hz = (np.arange(Ny) + 0.5) * dy\n        X_Hz, Y_Hz = np.meshgrid(x_Hz, y_Hz, indexing='ij')\n        \n        # --- 3. Initial Field Conditions ---\n        # E-field components are at t=0\n        Ex = np.cos(2 * np.pi * X_Ex / Lx) + 0.5 * np.sin(4 * np.pi * Y_Ex / Ly)\n        Ey = 0.7 * np.cos(2 * np.pi * Y_Ey / Ly) - 0.3 * np.sin(2 * np.pi * X_Ey / Lx)\n        \n        # H and J fields are staggered in time (leapfrog), initialized at t=-dt/2\n        # As is conventional, we use the t=0 analytic function for H at t=-dt/2\n        Hz_prev = np.sin(2 * np.pi * X_Hz / Lx) * np.sin(2 * np.pi * Y_Hz / Ly)\n        \n        # Current is assumed to be zero for t0\n        Jx_prev = np.zeros((Nx, Ny), dtype=float)\n        Jy_prev = np.zeros((Nx, Ny), dtype=float)\n        \n        # --- 4. Plasma Parameters and Update Coefficients ---\n        if profile == \"vacuum\":\n            omega_p_sq_x = np.zeros((Nx, Ny), dtype=float)\n            omega_p_sq_y = np.zeros((Nx, Ny), dtype=float)\n        elif profile == \"uniform\":\n            omega_p_sq_x = np.full((Nx, Ny), omega0**2, dtype=float)\n            omega_p_sq_y = np.full((Nx, Ny), omega0**2, dtype=float)\n        elif profile == \"varying\":\n            omega_p_x = omega0 * (1 + 0.5 * np.sin(2*np.pi*X_Ex/Lx) * np.cos(2*np.pi*Y_Ex/Ly))\n            omega_p_sq_x = omega_p_x**2\n            omega_p_y = omega0 * (1 + 0.5 * np.sin(2*np.pi*X_Ey/Lx) * np.cos(2*np.pi*Y_Ey/Ly))\n            omega_p_sq_y = omega_p_y**2\n        \n        # Drude model update coefficients for J^{n+1/2} = C1*J^{n-1/2} + C2*E^n\n        if nu == 0.0:\n            C1 = 1.0\n            C2_x = EPS0 * omega_p_sq_x * dt\n            C2_y = EPS0 * omega_p_sq_y * dt\n        else:\n            den = 1.0 / dt + nu / 2.0\n            C1 = (1.0 / dt - nu / 2.0) / den\n            C2x_num = EPS0 * omega_p_sq_x\n            C2_x = C2x_num / den\n            C2y_num = EPS0 * omega_p_sq_y\n            C2_y = C2y_num / den\n\n        max_abs_residual = 0.0\n\n        # --- 5. FDTD Time-stepping Loop ---\n        for _ in range(steps):\n            # Current state: Ex, Ey at time n; Hz_prev, Jx_prev, Jy_prev at n-1/2\n            \n            # --- Update H-field from n-1/2 to n+1/2 ---\n            curl_E_z = (np.roll(Ey, -1, axis=0) - Ey) / dx - \\\n                       (np.roll(Ex, -1, axis=1) - Ex) / dy\n            Hz = Hz_prev - (dt / MU0) * curl_E_z\n            \n            # --- Update J-field from n-1/2 to n+1/2 ---\n            Jx = C1 * Jx_prev + C2_x * Ex\n            Jy = C1 * Jy_prev + C2_y * Ey\n            \n            # --- Update E-field from n to n+1 ---\n            curl_H_x = (Hz - np.roll(Hz, 1, axis=1)) / dy\n            curl_H_y = -(Hz - np.roll(Hz, 1, axis=0)) / dx\n            Ex_next = Ex + (dt / EPS0) * (curl_H_x - Jx)\n            Ey_next = Ey + (dt / EPS0) * (curl_H_y - Jy)\n            \n            # --- Calculate Charge Continuity Residual at t=n+1/2 ---\n            # rho^n = eps0 * div(E^n) at nodes (i, j)\n            div_E_n = (Ex - np.roll(Ex, 1, axis=0)) / dx + \\\n                      (Ey - np.roll(Ey, 1, axis=1)) / dy\n            rho_n = EPS0 * div_E_n\n            \n            # rho^{n+1} = eps0 * div(E^{n+1}) at nodes (i, j)\n            div_E_n_plus_1 = (Ex_next - np.roll(Ex_next, 1, axis=0)) / dx + \\\n                             (Ey_next - np.roll(Ey_next, 1, axis=1)) / dy\n            rho_n_plus_1 = EPS0 * div_E_n_plus_1\n            \n            # div(J^{n+1/2}) at nodes (i, j)\n            div_J_n_half = (Jx - np.roll(Jx, 1, axis=0)) / dx + \\\n                           (Jy - np.roll(Jy, 1, axis=1)) / dy\n            \n            # Residual R^{n+1/2} = (rho^{n+1} - rho^n)/dt + div(J^{n+1/2})\n            residual = (rho_n_plus_1 - rho_n) / dt + div_J_n_half\n            \n            # Update the maximum absolute residual found so far\n            current_max_abs_res = np.max(np.abs(residual))\n            if current_max_abs_res > max_abs_residual:\n                max_abs_residual = current_max_abs_res\n\n            # --- Advance fields for the next iteration ---\n            Ex, Ey = Ex_next, Ey_next\n            Hz_prev = Hz\n            Jx_prev, Jy_prev = Jx, Jy\n            \n        return max_abs_residual\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (Nx, Ny, theta, steps, omega0, nu, profile)\n        (16, 16, 0.9, 10, 0.0, 0.0, \"vacuum\"),\n        (8, 8, 0.95, 20, 2.0e11, 1.0e10, \"uniform\"),\n        (10, 6, 0.8, 15, 1.5e11, 5.0e9, \"varying\"),\n        (2, 2, 0.5, 5, 1.0e11, 0.0, \"uniform\"),\n    ]\n\n    results = []\n    for case in test_cases:\n        result = _solve_case(*case)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.18e}' for r in results)}]\")\n\nsolve()\n\n```", "id": "3522863"}, {"introduction": "在模拟等离子体时，显式时间积分方法常因“刚性”问题而受到严格的时间步长限制，霍尔磁流体动力学中的高频哨声波便是一个典型例子。本练习将引导您从理论上分析哨声波的色散关系，量化其对显式格式（如四阶龙格-库塔法）稳定性的严苛制约。接着，您将设计一种隐式-显式（IMEX）混合格式，通过对引发刚性的霍尔项进行隐式处理，从而突破稳定性瓶颈，实现更高效的多尺度等离子体模拟。[@problem_id:3522825]", "problem": "考虑包含霍尔效应（通过广义欧姆定律引入）的单流体磁流体动力学系统。研究对象为非相对论性的、准中性的磁化等离子体，其离子数密度 $n$ 和离子质量 $m_i$ 为常数。设 $\\mathbf{B}$ 表示磁场，$\\mathbf{u}$ 表示整体离子速度，$\\mathbf{J}$ 表示电流密度，$\\mu_0$ 表示真空磁导率，$e$ 表示元电荷。其控制关系式为以下基本定律和标准本构关系：法拉第定律 $\\partial_t \\mathbf{B} = -\\nabla \\times \\mathbf{E}$，无位移电流的安培定律 $\\mathbf{J} = \\nabla \\times \\mathbf{B}/\\mu_0$，以及广义欧姆定律（忽略电子压力和电阻率）$\\mathbf{E} + \\mathbf{u} \\times \\mathbf{B} = \\left(\\mathbf{J} \\times \\mathbf{B}\\right)/(n e)$。结合这些关系式可得出感应方程\n$$\n\\partial_t \\mathbf{B} = \\nabla \\times \\left( \\mathbf{u} \\times \\mathbf{B} \\right) + \\nabla \\times \\left( \\frac{\\mathbf{J} \\times \\mathbf{B}}{n e} \\right),\n$$\n其中 $\\mathbf{J} = \\nabla \\times \\mathbf{B}/\\mu_0$。对于幅度为 $B_0 = \\|\\mathbf{B}_0\\|$ 的均匀背景磁场，定义阿尔芬速度 $v_A = B_0/\\sqrt{\\mu_0 n m_i}$，以及离子趋肤深度 $d_i = \\sqrt{m_i/(\\mu_0 n e^2)}$。考虑波矢平行于均匀背景场的小振幅一维微扰，并研究由感应方程中的霍尔项所控制的线性哨声模。您必须仅使用上述基本定律和定义，并做出线性平面波拟设，以：\n1) 在上述霍尔磁流体动力学极限下，推导物理（国际单位制）单位下的哨声模色散关系，其形式为 $\\omega = C \\, k^2$，其中 $C$ 必须用 $B_0$、$n$、$e$ 和 $\\mu_0$ 表示（并说明其也等于 $v_A d_i$）。\n2) 考虑使用经典四阶显式 Runge-Kutta 方法对线性振荡模 $\\partial_t q = i \\omega q$ 进行时间推进。推导标量放大因子，并根据无量纲参数 $z = i \\omega \\Delta t$，确定最大正值 $\\alpha_\\star$，使得对于纯虚数 $z = i \\alpha$（其中 $0 \\le \\alpha \\le \\alpha_\\star$），该格式是能量有界的。您的推导必须从 Runge-Kutta 更新的第一性原理出发。然后，在间距为 $\\Delta x$ 的均匀网格上，针对给定的最大可分辨波数 $k_{\\max}$，写出由哨声波色散对时间步长 $\\Delta t_{\\mathrm{exp}}$ 施加的显式稳定性约束。\n3) 为感应方程提出一个隐式-显式（IMEX）时间离散化方案，其中霍尔项 $\\nabla \\times \\left((\\mathbf{J} \\times \\mathbf{B})/(n e)\\right)$ 被隐式处理，而平流项 $\\nabla \\times (\\mathbf{u} \\times \\mathbf{B})$ 被显式处理。您的 IMEX 格式对于霍尔项必须是时间二阶精度的，对于显式平流项必须是一阶精度的。在假设 $\\mathbf{u}$ 是一个给定的、不随时间变化的场的情况下，给出从 $\\mathbf{B}^n$ 到 $\\mathbf{B}^{n+1}$ 的离散更新。在线性常系数极限下（围绕 $\\mathbf{B}_0$），分析隐式霍尔子步的无条件能量稳定性，并说明是哪个剩余约束限制了 IMEX 时间步长。\n4) 在一个由 $N$ 个均匀间隔的单元格解析的、长度为 $L$ 的周期性一维域上，使用 $k_{\\max} = \\pi/\\Delta x$（其中 $\\Delta x = L/N$）作为最大可分辨波数。对于第 2 项中的显式格式，最严格的哨声波时间步长是由最高波数设定的 $\\Delta t_{\\mathrm{exp}}$。对于第 3 项中的 IMEX 格式，假设霍尔项的贡献由 Crank-Nicolson 隐式步处理并且是能量稳定的，因此剩余的时间步长约束来自显式平流项，其 Courant-Friedrichs-Lewy (CFL) 数为 $\\mathrm{CFL}_{\\mathrm{adv}}$，即\n$$\n\\Delta t_{\\mathrm{IMEX}} = \\mathrm{CFL}_{\\mathrm{adv}} \\frac{\\Delta x}{U},\n$$\n其中 $U = \\|\\mathbf{u}\\|$ 是一个给定的常数平流速度。将所有时间步长以秒为单位表示，并由您的程序作为浮点数进行四舍五入。\n您的程序必须使用您提供的推导，为每个测试用例计算数对 $[\\Delta t_{\\mathrm{exp}}, \\Delta t_{\\mathrm{IMEX}}]$，所有量均采用国际单位制（SI）。在您的程序中，请使用以下国际单位制下的物理常数：$\\mu_0 = 4 \\pi \\times 10^{-7}$，$e = 1.602176634 \\times 10^{-19}$。需要时，使用质子质量 $m_p = 1.67262192369 \\times 10^{-27}$ 作为参考。\n\n测试套件（每个用例为 $(L, N, B_0, n, m_i, U, \\mathrm{CFL}_{\\mathrm{adv}})$）：\n- 用例 A（一般情况）：$L = 1.0$, $N = 256$, $B_0 = 0.1$, $n = 10^{19}$, $m_i = m_p$, $U = 10^{4}$, $\\mathrm{CFL}_{\\mathrm{adv}} = 0.5$。\n- 用例 B（网格细化）：$L = 1.0$, $N = 4096$, $B_0 = 0.1$, $n = 10^{19}$, $m_i = m_p$, $U = 10^{4}$, $\\mathrm{CFL}_{\\mathrm{adv}} = 0.5$。\n- 用例 C（离子质量变化）：$L = 1.0$, $N = 256$, $B_0 = 0.1$, $n = 10^{19}$, $m_i = 4 m_p$, $U = 10^{4}$, $\\mathrm{CFL}_{\\mathrm{adv}} = 0.5$。\n- 用例 D（低密度边缘）：$L = 1.0$, $N = 256$, $B_0 = 0.1$, $n = 10^{17}$, $m_i = m_p$, $U = 10^{4}$, $\\mathrm{CFL}_{\\mathrm{adv}} = 0.5$。\n\n要求的最终输出格式：您的程序应生成单行输出，其中包含一个列表的列表形式的结果，每个数字使用科学记数法表示并保留十二位有效数字，格式完全如下：\n$[\\,[\\Delta t_{\\mathrm{exp}}^{(A)},\\Delta t_{\\mathrm{IMEX}}^{(A)}],\\,[\\Delta t_{\\mathrm{exp}}^{(B)},\\Delta t_{\\mathrm{IMEX}}^{(B)}],\\,[\\Delta t_{\\mathrm{exp}}^{(C)},\\Delta t_{\\mathrm{IMEX}}^{(C)}],\\,[\\Delta t_{\\mathrm{exp}}^{(D)},\\Delta t_{\\mathrm{IMEX}}^{(D)}]\\,]$,\n无空格。所有时间步长必须以秒为单位。", "solution": "该问题被验证为具有科学依据、适定且客观。所有必要信息均已提供，任务逻辑结构清晰，具有一定难度，并且直接与计算等离子体物理相关。我们开始进行解答。\n\n**修正：** 原始问题在广义欧姆定律和最终感应方程中的霍尔项符号不一致。欧姆定律 $\\mathbf{E} + \\mathbf{u} \\times \\mathbf{B} = \\frac{\\mathbf{J} \\times \\mathbf{B}}{n e}$（忽略电子压力/电阻）和法拉第定律 $\\partial_t \\mathbf{B} = -\\nabla \\times \\mathbf{E}$ 结合，得到感应方程 $\\partial_t \\mathbf{B} = \\nabla \\times (\\mathbf{u} \\times \\mathbf{B}) - \\nabla \\times \\left( \\frac{\\mathbf{J} \\times \\mathbf{B}}{n e} \\right)$。问题陈述中的感应方程意外地使用了加号。为了保持与标准物理学和后续推导的一致性，我们在推导中将使用正确的减号。\n\n### 第 1 部分：哨声模色散关系\n\n我们从感应方程开始，忽略流体平流项 $(\\mathbf{u} \\times \\mathbf{B})$ 来研究纯霍尔（哨声）波：\n$$\n\\partial_t \\mathbf{B} = - \\nabla \\times \\left( \\frac{\\mathbf{J} \\times \\mathbf{B}}{n e} \\right)\n$$\n我们将安培定律 $\\mathbf{J} = (\\nabla \\times \\mathbf{B}) / \\mu_0$ 代入此方程：\n$$\n\\partial_t \\mathbf{B} = - \\frac{1}{n e \\mu_0} \\nabla \\times \\left( (\\nabla \\times \\mathbf{B}) \\times \\mathbf{B} \\right)\n$$\n我们围绕一个均匀、静态的背景磁场 $\\mathbf{B}_0$ 对小振幅微扰 $\\delta\\mathbf{B}$ 进行线性化。设 $\\mathbf{B} = \\mathbf{B}_0 + \\delta\\mathbf{B}$。由于 $\\mathbf{B}_0$ 是常数，$\\nabla \\times \\mathbf{B}_0 = 0$。线性化后的方程为：\n$$\n\\partial_t \\delta\\mathbf{B} = - \\frac{1}{n e \\mu_0} \\nabla \\times \\left( (\\nabla \\times \\delta\\mathbf{B}) \\times \\mathbf{B}_0 \\right)\n$$\n我们对微扰采用平面波拟设，$\\delta\\mathbf{B} \\propto \\exp(i(\\mathbf{k} \\cdot \\mathbf{r} - \\omega t))$。在此形式下，算子 $\\partial_t$ 和 $\\nabla$ 变换为代数乘子：$\\partial_t \\rightarrow -i\\omega$ 和 $\\nabla \\rightarrow i\\mathbf{k}$。线性化方程变为：\n$$\n-i\\omega \\delta\\mathbf{B} = - \\frac{1}{n e \\mu_0} (i\\mathbf{k}) \\times \\left( (i\\mathbf{k} \\times \\delta\\mathbf{B}) \\times \\mathbf{B}_0 \\right)\n$$\n问题指定波矢 $\\mathbf{k}$ 平行于背景场 $\\mathbf{B}_0$。我们调整坐标系，使得 $\\mathbf{B}_0 = B_0 \\hat{z}$ 和 $\\mathbf{k} = k \\hat{z}$。无散条件 $\\nabla \\cdot \\delta\\mathbf{B} = 0$ 意味着 $i \\mathbf{k} \\cdot \\delta\\mathbf{B} = ik \\delta B_z = 0$，所以 $\\delta B_z = 0$。微扰是纯横向的。\n方程简化为：\n$$\n\\omega \\delta\\mathbf{B} = \\frac{k}{n e \\mu_0} \\hat{z} \\times \\left( (i k \\hat{z} \\times \\delta\\mathbf{B}) \\times B_0 \\hat{z} \\right) = \\frac{i k^2 B_0}{n e \\mu_0} \\hat{z} \\times \\left( (\\hat{z} \\times \\delta\\mathbf{B}) \\times \\hat{z} \\right)\n$$\n使用矢量恒等式 $\\mathbf{A} \\times (\\mathbf{B} \\times \\mathbf{C}) = \\mathbf{B}(\\mathbf{A} \\cdot \\mathbf{C}) - \\mathbf{C}(\\mathbf{A} \\cdot \\mathbf{B})$，并注意 $\\delta\\mathbf{B}$ 垂直于 $\\hat{z}$：\n$$\n(\\hat{z} \\times \\delta\\mathbf{B}) \\times \\hat{z} = \\delta\\mathbf{B}(\\hat{z} \\cdot \\hat{z}) - \\hat{z}(\\hat{z} \\cdot \\delta\\mathbf{B}) = \\delta\\mathbf{B}\n$$\n方程变为：\n$$\n\\omega \\delta\\mathbf{B} = \\frac{i k^2 B_0}{n e \\mu_0} (\\hat{z} \\times \\delta\\mathbf{B})\n$$\n这个方程描述了圆偏振波。其特征值（频率）为 $\\omega = \\pm \\frac{B_0}{n e \\mu_0} k^2$。取正常数 $C$ 的正根：\n$$\nC = \\frac{B_0}{n e \\mu_0}\n$$\n接下来，我们证明 $C = v_A d_i$。使用给定的定义：\n$$\nv_A d_i = \\left( \\frac{B_0}{\\sqrt{\\mu_0 n m_i}} \\right) \\left( \\sqrt{\\frac{m_i}{\\mu_0 n e^2}} \\right) = \\frac{B_0 \\sqrt{m_i}}{\\sqrt{\\mu_0 n m_i} \\sqrt{\\mu_0 n e^2}} = \\frac{B_0}{\\sqrt{\\mu_0 n} \\sqrt{\\mu_0 n e^2}} = \\frac{B_0}{\\mu_0 n e}\n$$\n这证实了 $C = v_A d_i$。\n\n### 第 2 部分：RK4 稳定性分析\n\n我们分析经典四阶 Runge-Kutta (RK4) 方法对线性测试方程 $\\partial_t q = i\\omega q$ 的稳定性。单步的放大因子 $g(z)$，其中 $q^{n+1} = g(z) q^n$ 且 $z = i\\omega \\Delta t$，由下式给出：\n$$\ng(z) = 1 + z + \\frac{z^2}{2!} + \\frac{z^3}{3!} + \\frac{z^4}{4!}\n$$\n对于哨声模，频率 $\\omega$ 是实数，所以我们考虑纯虚数 $z = i\\alpha$，其中 $\\alpha = \\omega \\Delta t$。稳定性条件是 $|g(i\\alpha)|^2 \\le 1$。\n$$\n|g(i\\alpha)|^2 = \\left(1 - \\frac{\\alpha^2}{2} + \\frac{\\alpha^4}{24}\\right)^2 + \\left(\\alpha - \\frac{\\alpha^3}{6}\\right)^2 \\le 1\n$$\n展开并简化得到：\n$$\n\\frac{\\alpha^8}{576} - \\frac{\\alpha^6}{72} \\le 0 \\implies \\alpha^2 \\le \\frac{576}{72} = 8\n$$\n稳定性边界是 $\\alpha^2 = 8$，这意味着该格式保持稳定的最大正值为 $\\alpha_\\star = \\sqrt{8} = 2\\sqrt{2}$。\n\n时间步长 $\\Delta t$ 的显式稳定性约束为 $|\\omega \\Delta t| \\le \\alpha_\\star$。我们必须使用最大频率 $\\omega_{\\max}$，它对应于最大波数 $k_{\\max} = \\pi/\\Delta x$。\n$$\n\\Delta t_{\\mathrm{exp}} \\le \\frac{\\alpha_\\star}{|\\omega_{\\max}|} = \\frac{2\\sqrt{2}}{|\\omega(k_{\\max})|} = \\frac{2\\sqrt{2}}{C k_{\\max}^2} = \\frac{2\\sqrt{2} \\mu_0 n e}{B_0 (\\pi/\\Delta x)^2}\n$$\n\n### 第 3 部分：IMEX 格式与稳定性\n\n感应方程为 $\\partial_t \\mathbf{B} = \\mathcal{F}(\\mathbf{B}) + \\mathcal{G}(\\mathbf{B})$，其中 $\\mathcal{F}(\\mathbf{B}) = \\nabla \\times (\\mathbf{u} \\times \\mathbf{B})$ 是显式平流项，$\\mathcal{G}(\\mathbf{B}) = - \\nabla \\times ((\\mathbf{J} \\times \\mathbf{B})/(ne))$ 是隐式霍尔项。一个满足精度要求的 IMEX 格式是前向欧拉/Crank-Nicolson 格式：\n$$\n\\frac{\\mathbf{B}^{n+1} - \\mathbf{B}^n}{\\Delta t} = \\mathcal{F}(\\mathbf{B}^n) + \\frac{1}{2}\\left(\\mathcal{G}(\\mathbf{B}^{n+1}) + \\mathcal{G}(\\mathbf{B}^n)\\right)\n$$\n在常系数线性极限下，霍尔算子 $\\mathcal{G}$ 变为线性算子 $\\mathcal{L}_{\\text{Hall}}$。$\\mathbf{B}^{n+1}$ 的离散更新为：\n$$\n\\left(I - \\frac{\\Delta t}{2}\\mathcal{L}_{\\text{Hall}}\\right)\\mathbf{B}^{n+1} = \\left(I + \\frac{\\Delta t}{2}\\mathcal{L}_{\\text{Hall}}\\right)\\mathbf{B}^n + \\Delta t \\, \\nabla \\times (\\mathbf{u} \\times \\mathbf{B}^n)\n$$\n霍尔算子是斜埃尔米特算子。Crank-Nicolson 格式应用于由斜埃尔米特算子演化的系统时，其放大算子是酉的，这意味着它保持了 L2 范数（能量）。因此，隐式霍尔子步对于任何 $\\Delta t$ 都是无条件能量稳定的。\n因此，整个 IMEX 格式的时间步长受限于显式平流部分的 CFL 条件：\n$$\n\\Delta t_{\\mathrm{IMEX}} \\le \\mathrm{CFL}_{\\mathrm{adv}} \\frac{\\Delta x}{U}\n$$\n\n### 第 4 部分：计算公式\n\n1.  来自哨声模 RK4 稳定性分析的最大显式时间步长是：\n    $$\n    \\Delta t_{\\mathrm{exp}} = \\frac{2\\sqrt{2} \\mu_0 n e (\\Delta x)^2}{B_0 \\pi^2} = \\frac{2\\sqrt{2} \\mu_0 n e (L/N)^2}{B_0 \\pi^2}\n    $$\n2.  受显式平流 CFL 条件限制的最大 IMEX 时间步长为：\n    $$\n    \\Delta t_{\\mathrm{IMEX}} = \\mathrm{CFL}_{\\mathrm{adv}} \\frac{\\Delta x}{U} = \\mathrm{CFL}_{\\mathrm{adv}} \\frac{L/N}{U}\n    $$\n这些公式将用于所提供的测试用例。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem by calculating explicit and IMEX time step limits\n    for several test cases in Hall-MHD.\n    \"\"\"\n    \n    # Physical constants in SI units\n    MU_0 = 4 * np.pi * 1e-7  # Vacuum permeability (H/m or T*m/A)\n    E_CHARGE = 1.602176634e-19  # Elementary charge (C)\n    M_PROTON = 1.67262192369e-27  # Proton mass (kg)\n\n    # Test suite: (L, N, B0, n, mi, U, CFL_adv)\n    test_cases = [\n        # Case A (general regime)\n        (1.0, 256, 0.1, 1e19, M_PROTON, 1e4, 0.5),\n        # Case B (grid-refined boundary)\n        (1.0, 4096, 0.1, 1e19, M_PROTON, 1e4, 0.5),\n        # Case C (ion-mass variation)\n        (1.0, 256, 0.1, 1e19, 4 * M_PROTON, 1e4, 0.5),\n        # Case D (low density edge)\n        (1.0, 256, 0.1, 1e17, M_PROTON, 1e4, 0.5),\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        L, N, B0, n, mi, U, CFL_adv = case\n\n        # Grid spacing\n        delta_x = L / N\n\n        # Part 1: Whistler dispersion constant and explicit time step calculation\n        # The whistler dispersion relation is omega = C * k^2 where C = B0 / (mu0 * n * e)\n        # The RK4 stability limit for this purely oscillatory system is omega_max * dt = 2*sqrt(2).\n        # omega_max corresponds to k_max = pi / delta_x.\n        # dt_exp = (2*sqrt(2)) / omega_max = (2*sqrt(2)) / (C * k_max^2)\n        # dt_exp = (2*sqrt(2) * mu0 * n * e) / (B0 * (pi/delta_x)^2)\n        #        = (2*sqrt(2) * mu0 * n * e * delta_x^2) / (B0 * pi^2)\n        \n        numerator_exp = 2 * np.sqrt(2) * MU_0 * n * E_CHARGE * (delta_x**2)\n        denominator_exp = B0 * (np.pi**2)\n        dt_exp = numerator_exp / denominator_exp\n\n        # Part 2: IMEX time step calculation\n        # The IMEX time step is limited by the advective CFL condition.\n        # dt_imex = CFL_adv * delta_x / U\n        \n        dt_imex = CFL_adv * delta_x / U\n        \n        results.append([dt_exp, dt_imex])\n\n    # Format the output as specified: [[...],[...],...] with twelve significant digits.\n    # The format string for 12 significant digits is \"{:.11e}\"\n    result_strings = []\n    for res_pair in results:\n        s1 = np.format_float_scientific(res_pair[0], precision=11, unique=False)\n        s2 = np.format_float_scientific(res_pair[1], precision=11, unique=False)\n        result_strings.append(f\"[{s1},{s2}]\")\n        \n    print(f\"[{','.join(result_strings)}]\")\n\nsolve()\n```", "id": "3522825"}, {"introduction": "采用隐式或IMEX格式（如上一练习所设计的）求解偏微分方程，会将问题转化为在每个时间步求解一个大型线性方程组，而整个模拟的效率便取决于该方程组的求解速度。本项高级实践将带您进入加速迭代求解器的关键技术领域：基于物理的预处理。您将为一个耦合的MHD-Maxwell系统构建雅可比矩阵，并设计一个基于舒尔补的块预条件子，该技巧通过将问题分解为流体和电磁两个子块，巧妙地利用了系统的物理结构。通过分析预处理后算子的特征值分布，您将评估预条件子的性能，并深入理解如何为复杂的多物理场问题设计高效的求解算法。[@problem_id:3522804]", "problem": "考虑一个一维线性化的电阻性磁流体动力学（MHD）-麦克斯韦系统，该系统通过无量纲形式的欧姆定律将可压缩流体与电磁场耦合。从以下基本定律开始：\n- 法拉第定律：$\\partial_t \\mathbf{B} = -\\nabla \\times \\mathbf{E}$，\n- 安培-麦克斯韦定律：$\\mu_0 \\epsilon_0 \\partial_t \\mathbf{E} = \\nabla \\times \\mathbf{B} - \\mu_0 \\mathbf{J}$，\n- 质量连续性方程：$\\partial_t \\rho + \\nabla \\cdot \\mathbf{u} = 0$，\n- 动量方程：$\\rho_0 \\partial_t \\mathbf{u} = -\\nabla p + \\mathbf{J} \\times \\mathbf{B}_0$，\n- 欧姆定律（电阻性）：$\\mathbf{J} = \\sigma \\left( \\mathbf{E} + \\mathbf{u} \\times \\mathbf{B}_0 \\right)$，\n- 等熵闭合：$\\partial_t p + c_s^2 \\nabla \\cdot \\mathbf{u} = 0$，\n以及基本关系式 $c^2 = \\frac{1}{\\mu_0 \\epsilon_0}$。\n\n使用特征长度 $L$ 和阿尔芬速度 $v_A = \\frac{B_0}{\\sqrt{\\mu_0 \\rho_0}}$ 进行无量纲化，定义无量纲变量为 $x \\mapsto x/L$，$t \\mapsto t \\, v_A/L$，$\\mathbf{u} \\mapsto \\mathbf{u}/v_A$，$\\mathbf{B} \\mapsto \\mathbf{B}/B_0$，$\\mathbf{E} \\mapsto \\mathbf{E}/(v_A B_0)$，$\\rho \\mapsto \\rho/\\rho_0$，$p \\mapsto p/(\\rho_0 v_A^2)$，以及无量纲光速比 $\\hat{c} = c / v_A$。伦奎斯特数（S）定义为 $S = \\mu_0 \\sigma v_A L$。\n\n围绕均匀平衡态进行线性化，该平衡态具有背景磁场 $\\mathbf{B}_0 = \\hat{\\mathbf{z}}$、零流速和恒定密度。对于一个波矢为 $k \\hat{\\mathbf{x}}$ 的平面波傅里叶模式，我们将状态变量限制为 $[\\rho, u, p, B, E]^\\top$，其中 $u$ 是速度的 $x$ 分量，$B$ 是磁场的 $z$ 分量，$E$ 是电场的 $y$ 分量。在这些变量中，无量纲化的线性演化方程为：\n- $\\partial_t \\rho = - i k \\, u$，\n- $\\partial_t u = - i k \\, p + S \\left( E - u \\right)$，\n- $\\partial_t p = - c_s^2 \\, i k \\, u$，\n- $\\partial_t B = - i k \\, E$，\n- $\\frac{1}{\\hat{c}^2} \\partial_t E = - i k \\, B - S \\left( E - u \\right)$。\n\n考虑使用时间步长为 $\\Delta t$ 的后向欧拉时间离散化，这导致使用雅可比矩阵 $\\mathbf{J} = \\mathbf{M} - \\Delta t \\, \\mathbf{L}$ 对增量进行 Newton–Krylov (NK) 线性求解，其中 $\\mathbf{M}$ 是收集时间导数系数的“质量”矩阵，而 $\\mathbf{L}$ 是线性化的空间-源算子。在变量排序为 $[\\rho, u, p, B, E]^\\top$ 的情况下，矩阵为：\n- $\\mathbf{M} = \\mathrm{diag}(1, 1, 1, 1, 1/\\hat{c}^2)$，\n- $\\mathbf{L}$ 满足\n  - $\\rho$ 行：$L_{\\rho,u} = - i k$，\n  - $u$ 行：$L_{u,p} = - i k$, $L_{u,E} = S$, $L_{u,u} = - S$，\n  - $p$ 行：$L_{p,u} = - c_s^2 \\, i k$，\n  - $B$ 行：$L_{B,E} = - i k$，\n  - $E$ 行：$L_{E,B} = - i k$, $L_{E,E} = - S$, $L_{E,u} = + S$，\n  所有其他项均为零。\n\n在变量 $[B, E]^\\top$ 中定义一个 $2 \\times 2$ 的麦克斯韦块，在变量 $[\\rho, u, p]^\\top$ 中定义一个 $3 \\times 3$ 的流体块。考虑一个基于舒尔补的分块预条件子，该预条件子隐式处理麦克斯韦块，并通过将麦克斯韦块替换为其 $k = 0$ 的近似（即，在麦克斯韦子矩阵中去掉与 $i k$ 成正比的旋度耦合项）来近似其在流体块上的舒尔补。设精确的雅可比矩阵分块为\n$$\n\\mathbf{J} =\n\\begin{bmatrix}\n\\mathbf{J}_{ff}  \\mathbf{J}_{fm} \\\\\n\\mathbf{J}_{mf}  \\mathbf{J}_{mm}\n\\end{bmatrix},\n$$\n并定义 $k=0$ 的麦克斯韦块近似 $\\mathbf{M}_0$ 和相应的近似流体舒尔补\n$$\n\\tilde{\\mathbf{S}}_f = \\mathbf{J}_{ff} - \\mathbf{J}_{fm} \\, \\mathbf{M}_0^{-1} \\, \\mathbf{J}_{mf}.\n$$\n使用带有此近似舒尔补的分块因式分解来定义预条件子逆\n$$\n\\mathbf{P}^{-1} =\n\\begin{bmatrix}\n\\mathbf{I}  \\mathbf{0}\\\\\n-\\mathbf{M}_0^{-1}\\mathbf{J}_{mf}  \\mathbf{I}\n\\end{bmatrix}\n\\begin{bmatrix}\n\\tilde{\\mathbf{S}}_f^{-1}  \\mathbf{0}\\\\\n\\mathbf{0}  \\mathbf{M}_0^{-1}\n\\end{bmatrix}\n\\begin{bmatrix}\n\\mathbf{I}  -\\mathbf{J}_{fm}\\mathbf{M}_0^{-1}\\\\\n\\mathbf{0}  \\mathbf{I}\n\\end{bmatrix}\n,\n$$\n这是标准的舒尔补预条件子，它将麦克斯韦块和流体块分开。\n\n您的任务：\n1. 根据给定的参数 $(k, c_s, \\hat{c}, \\Delta t, S)$，使用上述线性化模型和排序显式构造 $\\mathbf{J}$。\n2. 使用所述的舒尔补分裂方法和 $k=0$ 麦克斯韦近似 $\\mathbf{M}_0$ 来构造 $\\mathbf{P}^{-1}$。\n3. 对于下面的每个测试用例，计算右预处理算子 $\\mathbf{P}^{-1}\\mathbf{J}$ 的所有特征值 $\\{\\lambda_i\\}$，并报告聚类度量\n$$\nr_{\\max} = \\max_i \\left| \\lambda_i - 1 \\right|.\n$$\n4. 将每个 $r_{\\max}$ 作为浮点数报告，并四舍五入到六位小数。\n\n在所有测试中使用以下固定参数：$k = 1$，$c_s = 0.5$，$\\hat{c} = 100$，以及 $\\Delta t = 0.1$（均为无量纲）。伦奎斯特数（S）在每个测试用例中有所不同：\n- 测试 A（理想情况，中等耦合）：$S = 10^{-3}$。\n- 测试 B（中间状态）：$S = 1$。\n- 测试 C（刚性，高电导率极限）：$S = 10^{3}$。\n- 测试 D（极端刚性极限以探测渐近行为）：$S = 10^{6}$。\n\n您的程序应生成单行输出，其中包含四个 $r_{\\max}$ 值的列表，顺序为 [A, B, C, D]，格式为逗号分隔的 Python 风格列表，例如 $[x_A, x_B, x_C, x_D]$，每个条目四舍五入到六位小数。不应打印其他任何文本。", "solution": "用户希望分析一个分块舒尔补预条件子对线性化电阻性MHD-麦克斯韦系统的有效性。我将首先验证问题陈述。\n\n### 问题验证\n\n**步骤1：提取给定条件**\n\n- **基本定律**：\n  - 法拉第定律：$\\partial_t \\mathbf{B} = -\\nabla \\times \\mathbf{E}$\n  - 安培-麦克斯韦定律：$\\mu_0 \\epsilon_0 \\partial_t \\mathbf{E} = \\nabla \\times \\mathbf{B} - \\mu_0 \\mathbf{J}$\n  - 质量连续性方程：$\\partial_t \\rho + \\nabla \\cdot \\mathbf{u} = 0$\n  - 动量方程：$\\rho_0 \\partial_t \\mathbf{u} = -\\nabla p + \\mathbf{J} \\times \\mathbf{B}_0$\n  - 欧姆定律（电阻性）：$\\mathbf{J} = \\sigma \\left( \\mathbf{E} + \\mathbf{u} \\times \\mathbf{B}_0 \\right)$\n  - 等熵闭合：$\\partial_t p + c_s^2 \\nabla \\cdot \\mathbf{u} = 0$\n- **基本关系式**：$c^2 = 1/(\\mu_0 \\epsilon_0)$\n- **无量纲化**：特征长度 $L$，阿尔芬速度 $v_A = B_0/\\sqrt{\\mu_0 \\rho_0}$。无量纲变量：$x \\mapsto x/L$, $t \\mapsto t \\, v_A/L$, $\\mathbf{u} \\mapsto \\mathbf{u}/v_A$, $\\mathbf{B} \\mapsto \\mathbf{B}/B_0$, $\\mathbf{E} \\mapsto \\mathbf{E}/(v_A B_0)$, $\\rho \\mapsto \\rho/\\rho_0$, $p \\mapsto p/(\\rho_0 v_A^2)$。\n- **无量纲参数**：$\\hat{c} = c / v_A$，$S = \\mu_0 \\sigma v_A L$。\n- **线性化系统**：对于波矢为 $k \\hat{\\mathbf{x}}$ 的平面波傅里叶模式和线性化状态向量 $[\\rho, u, p, B, E]^\\top$（其中 u 是 $u_x$，B 是 $B_z$，E 是 $E_y$）。\n  - $\\partial_t \\rho = - i k \\, u$\n  - $\\partial_t u = - i k \\, p + S \\left( E - u \\right)$\n  - $\\partial_t p = - c_s^2 \\, i k \\, u$\n  - $\\partial_t B = - i k \\, E$\n  - $\\frac{1}{\\hat{c}^2} \\partial_t E = - i k \\, B - S \\left( E - u \\right)$\n- **离散化**：使用时间步长 $\\Delta t$ 的后向欧拉法，得到雅可比矩阵 $\\mathbf{J} = \\mathbf{M} - \\Delta t \\, \\mathbf{L}$。\n- **矩阵定义**：变量排序为 $[\\rho, u, p, B, E]^\\top$。\n  - $\\mathbf{M} = \\mathrm{diag}(1, 1, 1, 1, 1/\\hat{c}^2)$\n  - $\\mathbf{L}$ 的元素：$L_{\\rho,u} = -ik$；$L_{u,p} = -ik$, $L_{u,E} = S$, $L_{u,u} = -S$；$L_{p,u} = -c_s^2 ik$；$L_{B,E} = -ik$；$L_{E,B} = -ik$, $L_{E,E} = -S$, $L_{E,u} = S$。其他元素为零。\n- **预条件子定义**：\n  - 将 $\\mathbf{J}$ 分块为流体（$ff$，对应 $\\rho, u, p$ 的索引）和麦克斯韦（$mm$，对应 $B, E$ 的索引）块。\n  - 麦克斯韦块近似 $\\mathbf{M}_0$ 是 $\\mathbf{J}$ 的麦克斯韦块的 $k=0$ 版本。\n  - 近似舒尔补：$\\tilde{\\mathbf{S}}_f = \\mathbf{J}_{ff} - \\mathbf{J}_{fm} \\, \\mathbf{M}_0^{-1} \\, \\mathbf{J}_{mf}$。\n  - 预条件子逆矩阵：$\\mathbf{P}^{-1} = \\begin{bmatrix} \\mathbf{I}  \\mathbf{0}\\\\ -\\mathbf{M}_0^{-1}\\mathbf{J}_{mf}  \\mathbf{I} \\end{bmatrix} \\begin{bmatrix} \\tilde{\\mathbf{S}}_f^{-1}  \\mathbf{0}\\\\ \\mathbf{0}  \\mathbf{M}_0^{-1} \\end{bmatrix} \\begin{bmatrix} \\mathbf{I}  -\\mathbf{J}_{fm}\\mathbf{M}_0^{-1}\\\\ \\mathbf{0}  \\mathbf{I} \\end{bmatrix}$。\n- **任务**：对于给定的参数，计算 $\\mathbf{P}^{-1}\\mathbf{J}$ 的特征值 $\\{\\lambda_i\\}$ 并报告 $r_{\\max} = \\max_i |\\lambda_i-1|$。\n- **参数**：\n  - 固定值：$k = 1$，$c_s = 0.5$，$\\hat{c} = 100$，$\\Delta t = 0.1$。\n  - $S$ 的测试用例：(A) $10^{-3}$，(B) $1$，(C) $10^3$，(D) $10^6$。\n\n**步骤2：使用提取的给定条件进行验证**\n\n- **科学依据**：该问题描述了线性化电阻性MHD的标准框架，这是等离子体物理学的基石。无量纲化、线性化和离散化过程都是计算物理学中的标准技术。从基本定律推导出的线性化方程可以被验证并且是一致的（例如，在右手坐标系和 $e^{ikx}$ 傅里叶约定下，安培-麦克斯韦定律中 $ikB$ 项的符号是正确的，因为 $\\nabla\\times(B_z(x)\\hat{z}) = -\\partial_x B_z \\hat{y}$）。该问题在科学和数学上是合理的。\n- **适定性**：这些任务是一系列定义明确的矩阵构造和一个特征值计算。给定参数后，矩阵是唯一确定的，所得预处理矩阵的特征值也是一个唯一的集合。该问题是适定的。\n- **客观性**：该问题以精确的技术语言陈述，没有主观或模糊的元素。\n- **完整性和一致性**：所有必要的方程、常数、矩阵定义、变量排序和测试用例参数都已提供。没有矛盾之处。矩阵 $\\mathbf{M}$ 和 $\\mathbf{L}$ 的结构与所提供的微分方程组是一致的。\n\n**步骤3：结论和行动**\n\n问题是有效的。我将继续进行求解。\n\n### 求解方案\n\n目标是评估一个特定的基于物理的预条件子在一个耦合的MHD-麦克斯韦系统中的效果。任务的核心是根据提供的规范构造系统雅可比矩阵 $\\mathbf{J}$ 和预条件子逆矩阵 $\\mathbf{P}^{-1}$，然后分析预处理算子 $\\mathbf{P}^{-1}\\mathbf{J}$ 的谱。\n\n**1. 构造系统雅可比矩阵 $\\mathbf{J}$**\n\n该系统使用后向欧拉方法进行时间离散化。对于方程组 $\\mathbf{M} \\frac{d\\mathbf{X}}{dt} = \\mathbf{L}\\mathbf{X}$，从 $t^n$ 到 $t^{n+1}$ 的一个时间步长近似为 $\\mathbf{M}\\frac{\\mathbf{X}^{n+1} - \\mathbf{X}^n}{\\Delta t} = \\mathbf{L}\\mathbf{X}^{n+1}$。整理后得到 $(\\mathbf{M} - \\Delta t \\mathbf{L})\\mathbf{X}^{n+1} = \\mathbf{M}\\mathbf{X}^n$。乘以未知状态 $\\mathbf{X}^{n+1}$ 的矩阵即为系统雅可比矩阵 $\\mathbf{J} = \\mathbf{M} - \\Delta t \\mathbf{L}$。\n\n状态向量为 $\\mathbf{X} = [\\rho, u, p, B, E]^\\top$。矩阵为 $5 \\times 5$。\n\n质量矩阵 $\\mathbf{M}$ 由下式给出：\n$$ \\mathbf{M} = \\mathrm{diag}(1, 1, 1, 1, 1/\\hat{c}^2) $$\n算子矩阵 $\\mathbf{L}$ 根据线性化方程构造：\n$$\n\\mathbf{L} = \\begin{pmatrix}\n0  -ik  0  0  0 \\\\\n0  -S  -ik  0  S \\\\\n0  -ic_s^2 k  0  0  0 \\\\\n0  0  0  0  -ik \\\\\n0  S  0  -ik  -S\n\\end{pmatrix}\n$$\n因此，雅可比矩阵 $\\mathbf{J} = \\mathbf{M} - \\Delta t \\mathbf{L}$ 为：\n$$\n\\mathbf{J} = \\begin{pmatrix}\n1  ik\\Delta t  0  0  0 \\\\\n0  1+S\\Delta t  ik\\Delta t  0  -S\\Delta t \\\\\n0  ic_s^2 k \\Delta t  1  0  0 \\\\\n0  0  0  1  ik\\Delta t \\\\\n0  -S\\Delta t  0  ik\\Delta t  1/\\hat{c}^2+S\\Delta t\n\\end{pmatrix}\n$$\n\n**2. 构造预条件子逆矩阵 $\\mathbf{P}^{-1}$**\n\n该预条件子基于将 $\\mathbf{J}$ 分块为一个 $3 \\times 3$ 的流体块（变量 $\\rho, u, p$）和一个 $2 \\times 2$ 的麦克斯韦块（变量 $B, E$）。\n$$\n\\mathbf{J} =\n\\begin{bmatrix}\n\\mathbf{J}_{ff}  \\mathbf{J}_{fm} \\\\\n\\mathbf{J}_{mf}  \\mathbf{J}_{mm}\n\\end{bmatrix}\n$$\n从完整的 $\\mathbf{J}$ 矩阵中，这些块为：\n$$\n\\mathbf{J}_{ff} = \\begin{pmatrix} 1  ik\\Delta t  0 \\\\ 0  1+S\\Delta t  ik\\Delta t \\\\ 0  ic_s^2 k \\Delta t  1 \\end{pmatrix}, \\quad\n\\mathbf{J}_{fm} = \\begin{pmatrix} 0  0 \\\\ 0  -S\\Delta t \\\\ 0  0 \\end{pmatrix}\n$$\n$$\n\\mathbf{J}_{mf} = \\begin{pmatrix} 0  0  0 \\\\ 0  -S\\Delta t  0 \\end{pmatrix}, \\quad\n\\mathbf{J}_{mm} = \\begin{pmatrix} 1  ik\\Delta t \\\\ ik\\Delta t  1/\\hat{c}^2+S\\Delta t \\end{pmatrix}\n$$\n预条件子用麦克斯韦块 $\\mathbf{J}_{mm}$ 的 $k=0$ 极限（记为 $\\mathbf{M}_0$）来近似它：\n$$\n\\mathbf{M}_0 = \\mathbf{J}_{mm}(k=0) = \\begin{pmatrix} 1  0 \\\\ 0  1/\\hat{c}^2+S\\Delta t \\end{pmatrix}\n$$\n这种近似使得麦克斯韦块成为对角矩阵，易于求逆：\n$$\n\\mathbf{M}_0^{-1} = \\begin{pmatrix} 1  0 \\\\ 0  (1/\\hat{c}^2+S\\Delta t)^{-1} \\end{pmatrix}\n$$\n然后计算近似的流体舒尔补 $\\tilde{\\mathbf{S}}_f$：\n$$\n\\tilde{\\mathbf{S}}_f = \\mathbf{J}_{ff} - \\mathbf{J}_{fm} \\mathbf{M}_0^{-1} \\mathbf{J}_{mf}\n$$\n项 $\\mathbf{J}_{fm} \\mathbf{M}_0^{-1} \\mathbf{J}_{mf}$ 是对流体块的一个修正，它解释了与麦克斯韦场的简化耦合。\n最后，使用提供的分块因式分解来组装预条件子的逆矩阵 $\\mathbf{P}^{-1}$，这代表了对近似系统 $\\mathbf{P} = \\begin{bsmallmatrix} \\mathbf{J}_{ff}  \\mathbf{J}_{fm} \\\\ \\mathbf{J}_{mf}  \\mathbf{M}_0 \\end{bsmallmatrix}$ 求逆的操作。\n\n**3. 特征值分析**\n\n预条件子的质量通过预处理算子 $\\mathbf{P}^{-1}\\mathbf{J}$ 的特征值在 1 附近的聚集程度来评估。一个完美的预条件子 $\\mathbf{P}=\\mathbf{J}$ 将导致 $\\mathbf{P}^{-1}\\mathbf{J} = \\mathbf{I}$，所有特征值都等于 1。度量 $r_{\\max} = \\max_i |\\lambda_i - 1|$ 量化了包含所有特征值的、以 1 为中心的最小圆的半径。较小的 $r_{\\max}$ 表示预条件子更有效，这通常会使像 GMRES 这样的迭代线性求解器收敛得更快。\n\n下面的 Python 代码对伦奎斯特数 $S$ 的每个指定值实施此过程，计算 $r_{\\max}$，并报告结果。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef compute_rmax_for_case(S, k, cs, chat, dt):\n    \"\"\"\n    Constructs the Jacobian and Preconditioner for a given set of physical parameters,\n    and computes the spectral radius of the preconditioned operator minus the identity.\n\n    Args:\n        S (float): Lundquist number.\n        k (float): Wavenumber.\n        cs (float): Sound speed.\n        chat (float): Speed-of-light ratio.\n        dt (float): Time step.\n\n    Returns:\n        float: The clustering metric r_max.\n    \"\"\"\n    # Define complex wavenumber and other constants\n    ik = 1j * k\n    cs2 = cs**2\n    chat2_inv = 1 / chat**2\n\n    # 1. Construct the Jacobian matrix J = M - dt*L\n    J = np.zeros((5, 5), dtype=complex)\n    \n    # M part\n    J[0, 0] = 1.0\n    J[1, 1] = 1.0\n    J[2, 2] = 1.0\n    J[3, 3] = 1.0\n    J[4, 4] = chat2_inv\n    \n    # -dt*L part\n    J[0, 1] -= dt * (-ik)\n    J[1, 1] -= dt * (-S)\n    J[1, 2] -= dt * (-ik)\n    J[1, 4] -= dt * (S)\n    J[2, 1] -= dt * (-cs2 * ik)\n    J[3, 4] -= dt * (-ik)\n    J[4, 1] -= dt * (S)\n    J[4, 3] -= dt * (-ik)\n    J[4, 4] -= dt * (-S)\n    \n    # 2. Construct the preconditioner inverse P_inv\n    # Partition J into fluid and Maxwell blocks\n    J_ff = J[0:3, 0:3]\n    J_fm = J[0:3, 3:5]\n    J_mf = J[3:5, 0:3]\n\n    # M0 is the k=0 approximation of the Maxwell block J_mm\n    M0 = np.array([\n        [1.0, 0.0],\n        [0.0, chat2_inv + S * dt]\n    ], dtype=complex)\n    \n    # Inverse of the approximate Maxwell block\n    M0_inv = np.linalg.inv(M0)\n\n    # Approximate Schur complement on the fluid block\n    S_f_tilde = J_ff - J_fm @ M0_inv @ J_mf\n    S_f_tilde_inv = np.linalg.inv(S_f_tilde)\n\n    # Assemble P_inv using its block LU factorization form\n    # P_inv = (L_block)(D_block)(U_block)\n    L_block = np.identity(5, dtype=complex)\n    L_block[3:5, 0:3] = -M0_inv @ J_mf\n\n    D_block = np.zeros((5, 5), dtype=complex)\n    D_block[0:3, 0:3] = S_f_tilde_inv\n    D_block[3:5, 3:5] = M0_inv\n\n    U_block = np.identity(5, dtype=complex)\n    U_block[0:3, 3:5] = -J_fm @ M0_inv\n\n    P_inv = L_block @ D_block @ U_block\n\n    # 3. Compute the eigenvalues and the clustering metric r_max\n    # Form the right-preconditioned operator\n    A = P_inv @ J\n\n    eigenvalues = np.linalg.eigvals(A)\n    \n    # The metric is the maximum absolute deviation of eigenvalues from 1\n    r_max = np.max(np.abs(eigenvalues - 1.0))\n\n    return r_max\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for all test cases.\n    \"\"\"\n    # Define fixed parameters from the problem statement.\n    k = 1.0\n    cs = 0.5\n    chat = 100.0\n    dt = 0.1\n\n    # Define the test cases for the Lundquist number S.\n    test_cases = [10**-3, 1.0, 10**3, 10**6]\n\n    results = []\n    for S_val in test_cases:\n        r_max = compute_rmax_for_case(S_val, k, cs, chat, dt)\n        results.append(f\"{r_max:.6f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```", "id": "3522804"}]}