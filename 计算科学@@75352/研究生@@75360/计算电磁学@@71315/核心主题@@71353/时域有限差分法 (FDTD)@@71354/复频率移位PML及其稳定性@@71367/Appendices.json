{"hands_on_practices": [{"introduction": "在深入研究CFS-PML的复杂性之前，我们首先需要理解PML概念为何如此强大。这项练习 [@problem_id:3293614] 将通过推导证明，在理想的连续模型中，PML的设计保证了其与相邻介质（如真空）的界面在所有入射角和频率下都是无反射的。掌握这一“完美匹配”的理论基础，是理解PML作为吸收边界条件核心原理的关键。", "problem": "一个角频率为 $\\omega$ 的平面波从真空（$x<0$）入射到一个占据 $x>0$ 的半无限复频移完美匹配层（CFS-PML）上。该 CFS-PML 由沿 $x$ 方向的空间均匀复数拉伸因子定义，\n$$\ns_{x}(\\omega)=\\kappa_{x}+\\frac{\\sigma_{x}}{\\mathrm{j}\\,\\omega+\\omega_{c}},\n$$\n其中 $\\kappa_{x}>0$、$\\sigma_{x}\\geq 0$ 且 $\\omega_{c}\\geq 0$，并通过在频域麦克斯韦方程组中进行替换 $\\partial/\\partial x\\mapsto (1/s_{x})\\,\\partial/\\partial x$ 来实现。考虑一个二维横电（TE）偏振，其非零分量为 $E_{z}$，在 $x$-$y$ 平面内以相对于 $x$ 轴（界面法线）成 $\\theta$ 角入射。真空波数为 $k_{0}=\\omega\\sqrt{\\mu_{0}\\epsilon_{0}}$，其中 $\\mu_{0}$ 为真空磁导率，$\\epsilon_{0}$ 为真空介电常数。切向波数为 $k_{y}=k_{0}\\sin\\theta$，真空中的法向波数为 $k_{x}=k_{0}\\cos\\theta$。\n\n从频域麦克斯韦旋度方程出发，并仅使用与坐标拉伸实现一致的物理有效变换，推导 $x=0$ 处 TE 场的边界关系。然后，计算真空-PML 界面处的平面波反射系数 $R(\\theta,\\omega)$（用 $s_{x}$ 表示），并证明在具有空间均匀 $s_{x}$ 的连续设置中，对于所有的 $\\theta$ 和 $\\omega$，该结果恒为零。将最终答案表示为 $R(\\theta,\\omega)$ 的单个闭合形式表达式。不需要数值四舍五入，最终答案中不应包含任何单位。", "solution": "问题要求推导从真空（$x<0$）入射到占据 $x>0$ 的半无限复频移完美匹配层（CFS-PML）上的横电（TE）平面波的反射系数 $R(\\theta, \\omega)$，并证明其恒等于零。\n\n我们采用时谐约定 $e^{-\\mathrm{j}\\omega t}$，其中 $\\omega$ 是角频率。在无源、线性和各向同性介质中，频域麦克斯韦旋度方程为：\n$$\n\\nabla\\times\\vec{E} = \\mathrm{j}\\omega\\mu\\vec{H}\n$$\n$$\n\\nabla\\times\\vec{H} = -\\mathrm{j}\\omega\\epsilon\\vec{E}\n$$\n\n对于指定的二维 TE 偏振，电场只有一个 $z$ 分量，$\\vec{E} = E_z(x,y)\\hat{z}$，磁场位于 $x-y$ 平面内，$\\vec{H} = H_x(x,y)\\hat{x} + H_y(x,y)\\hat{y}$。旋度方程简化为：\n$$\n\\frac{\\partial E_z}{\\partial y} = \\mathrm{j}\\omega\\mu H_x \\quad(1)\n$$\n$$\n-\\frac{\\partial E_z}{\\partial x} = \\mathrm{j}\\omega\\mu H_y \\quad(2)\n$$\n$$\n\\frac{\\partial H_y}{\\partial x} - \\frac{\\partial H_x}{\\partial y} = -\\mathrm{j}\\omega\\epsilon E_z \\quad(3)\n$$\n\n首先，我们推导界面 $x=0$ 处的边界条件。PML 是一种体等效介质，而不是带有表面电流或电荷的边界层。因此，从麦克斯韦方程组的积分形式推导出的标准边界条件适用。将 $\\nabla\\times\\vec{E} = \\mathrm{j}\\omega\\vec{B}$ 在一个跨越 $x=0$ 界面的 $y-z$ 平面内的小矩形回路上积分，并将其在 $x$ 方向的宽度收缩到零，证明了 $\\vec{E}$ 的切向分量的连续性。对于此 TE 情况，这意味着 $E_z$ 的连续性。\n$$\nE_z(x=0^-, y) = E_z(x=0^+, y)\n$$\n类似地，将 $\\nabla\\times\\vec{H} = -\\mathrm{j}\\omega\\vec{D}$ 在一个跨越 $x=0$ 界面的 $x-z$ 平面内的小矩形回路上积分，并收缩其宽度，显示了 $\\vec{H}$ 的切向分量的连续性。对于该界面，切向分量是 $H_y$。\n$$\nH_y(x=0^-, y) = H_y(x=0^+, y)\n$$\n\n入射平面波的空间依赖关系为 $e^{\\mathrm{j}(k_x x + k_y y)}$，其中 $k_x = k_0\\cos\\theta$ 和 $k_y = k_0\\sin\\theta$ 是真空中的波矢量分量，且 $k_0=\\omega\\sqrt{\\mu_0\\epsilon_0}$。真空区域（$x<0$）中的场是入射波（I）和反射波（R）的叠加：\n$$\nE_z^{(1)}(x,y) = (E_I e^{\\mathrm{j}k_x x} + E_R e^{-\\mathrm{j}k_x x}) e^{\\mathrm{j} k_y y}\n$$\n相应的切向磁场 $H_y^{(1)}$ 可由方程 (2) 在 $\\mu=\\mu_0$ 的条件下求得：\n$$\n-\\frac{\\partial E_z^{(1)}}{\\partial x} = \\mathrm{j}\\omega\\mu_0 H_y^{(1)} \\implies H_y^{(1)} = \\frac{-1}{\\mathrm{j}\\omega\\mu_0} \\frac{\\partial E_z^{(1)}}{\\partial x} = \\frac{-1}{\\mathrm{j}\\omega\\mu_0} \\mathrm{j}(k_x E_I e^{\\mathrm{j} k_x x} - k_x E_R e^{-\\mathrm{j} k_x x}) e^{\\mathrm{j} k_y y}\n$$\n$$\nH_y^{(1)}(x,y) = -\\frac{k_x}{\\omega\\mu_0} (E_I e^{\\mathrm{j} k_x x} - E_R e^{-\\mathrm{j} k_x x}) e^{\\mathrm{j} k_y y}\n$$\n反射系数定义为 $R(\\theta, \\omega) = E_R/E_I$。\n\n反射为零的充分必要条件是波阻抗在边界上连续。对于沿 $+x$ 方向传播的 TE 波，其横向波阻抗为 $Z_{TE} = E_z / (-H_y)$。\n在真空（$x<0$）中，对于入射波分量：\n$$\nZ_{vac} = \\frac{E_I e^{\\mathrm{j} k_x x}}{-H_{y,I}} = \\frac{E_I e^{\\mathrm{j} k_x x}}{-(-\\frac{k_x}{\\omega\\mu_0} E_I e^{\\mathrm{j} k_x x})} = \\frac{\\omega\\mu_0}{k_x}\n$$\n为了没有反射，PML 介质的波阻抗 $Z_{PML}$ 必须等于 $Z_{vac}$。我们现在计算 $Z_{PML}$。\n\n问题指出，PML 是通过替换 $\\partial/\\partial x \\mapsto (1/s_x)\\partial/\\partial x$ 实现的。这是一个关于坐标拉伸变换的陈述。将此变换严格应用于麦克斯韦方程组，已知等效于用各向异性的介电常数和磁导率张量来建模该介质。对于沿 $x$ 轴实现的 PML，这些张量为：\n$$\n\\bar{\\bar{\\epsilon}} = \\epsilon_0 \\Lambda, \\quad \\bar{\\bar{\\mu}} = \\mu_0 \\Lambda, \\quad \\text{with} \\quad \\Lambda = \\begin{pmatrix} 1/s_x & 0 & 0 \\\\ 0 & s_x & 0 \\\\ 0 & 0 & s_x \\end{pmatrix}\n$$\n在 PML 介质（$x>0$）中的麦克斯韦方程组为：\n$$\n\\nabla\\times\\vec{E} = \\mathrm{j}\\omega\\bar{\\bar{\\mu}}\\vec{H}\n$$\n$$\n\\nabla\\times\\vec{H} = -\\mathrm{j}\\omega\\bar{\\bar{\\epsilon}}\\vec{E}\n$$\n对于 TE 情况，PML 中的分量方程为：\n$$\n\\frac{\\partial E_z}{\\partial y} = \\mathrm{j}\\omega\\mu_x H_x = \\mathrm{j}\\omega(\\mu_0/s_x) H_x \\quad(1')\n$$\n$$\n-\\frac{\\partial E_z}{\\partial x} = \\mathrm{j}\\omega\\mu_y H_y = \\mathrm{j}\\omega(\\mu_0 s_x) H_y \\quad(2')\n$$\n$$\n\\frac{\\partial H_y}{\\partial x} - \\frac{\\partial H_x}{\\partial y} = -\\mathrm{j}\\omega\\epsilon_z E_z = -\\mathrm{j}\\omega(\\epsilon_0 s_x) E_z \\quad(3')\n$$\n为了求出波阻抗，我们首先需要色散关系。我们结合这三个方程来求出 $E_z$ 的波动方程。由 (1') 和 (2')：\n$$\nH_x = \\frac{s_x}{\\mathrm{j}\\omega\\mu_0} \\frac{\\partial E_z}{\\partial y}, \\qquad H_y = \\frac{-1}{\\mathrm{j}\\omega\\mu_0 s_x} \\frac{\\partial E_z}{\\partial x}\n$$\n将这些代入 (3')：\n$$\n\\frac{\\partial}{\\partial x}\\left(\\frac{-1}{\\mathrm{j}\\omega\\mu_0 s_x} \\frac{\\partial E_z}{\\partial x}\\right) - \\frac{\\partial}{\\partial y}\\left(\\frac{s_x}{\\mathrm{j}\\omega\\mu_0} \\frac{\\partial E_z}{\\partial y}\\right) = -\\mathrm{j}\\omega\\epsilon_0 s_x E_z\n$$\n假设 $s_x$ 在空间上是均匀的：\n$$\n\\frac{-1}{s_x} \\frac{\\partial^2 E_z}{\\partial x^2} - s_x \\frac{\\partial^2 E_z}{\\partial y^2} = (\\mathrm{j}\\omega)^2\\mu_0\\epsilon_0 s_x E_z = -\\omega^2\\mu_0\\epsilon_0 s_x E_z = -k_0^2 s_x E_z\n$$\n除以 $-s_x$：\n$$\n\\frac{1}{s_x^2} \\frac{\\partial^2 E_z}{\\partial x^2} + \\frac{\\partial^2 E_z}{\\partial y^2} + k_0^2 E_z = 0\n$$\n现在，我们假设一个形式为 $E_z^{(2)}(x,y) = E_T e^{\\mathrm{j} k_{px} x} e^{\\mathrm{j} k_y y}$ 的透射平面波解。代入波动方程得到色散关系：\n$$\n\\frac{1}{s_x^2} (\\mathrm{j} k_{px})^2 + (\\mathrm{j} k_y)^2 + k_0^2 = 0 \\implies -\\frac{k_{px}^2}{s_x^2} - k_y^2 + k_0^2 = 0\n$$\n$$\nk_{px}^2 = s_x^2 (k_0^2 - k_y^2) = s_x^2 (k_0^2 - k_0^2 \\sin^2\\theta) = s_x^2 (k_0^2 \\cos^2\\theta) = (s_x k_x)^2\n$$\n因此，PML 中波矢量的法向分量是 $k_{px} = s_x k_x$。我们为前向传播波选择正号。透射波为 $E_z^{(2)} = E_T e^{\\mathrm{j} s_x k_x x} e^{\\mathrm{j} k_y y}$。注意，为了衰减，我们需要 $\\mathrm{Im}(s_x k_x)>0$。给定的 $s_x = \\kappa_x + \\frac{\\sigma_x}{\\mathrm{j}\\omega+\\omega_c}$ 对于 $\\omega>0$ 有 $\\mathrm{Im}(s_x) = \\frac{-\\sigma_x\\omega}{\\omega_c^2+\\omega^2} \\le 0$。因此，$e^{\\mathrm{j} s_x k_x x}$ 的振幅是增长的。问题陈述中用于 $s_x$ 的约定是针对 $e^{\\mathrm{j}\\omega t}$ 的，而我们使用了 $e^{-\\mathrm{j}\\omega t}$。让我们切换到 $e^{\\mathrm{j}\\omega t}$ 约定。麦克斯韦方程组变为 $\\nabla\\times\\vec{E} = -\\mathrm{j}\\omega\\bar{\\bar{\\mu}}\\vec{H}$ 和 $\\nabla\\times\\vec{H} = \\mathrm{j}\\omega\\bar{\\bar{\\epsilon}}\\vec{E}$。结果是所有的 $\\mathrm{j}$ 都变号。波动方程和色散关系不变。前向波是 $e^{\\mathrm{j} s_x k_x x}$。为了使其衰减，我们需要 $\\mathrm{Im}(s_x) > 0$。给定的 $s_x$ 具有 $\\mathrm{Im}(s_x) \\le 0$。必须选择一个物理上可实现的衰减波。波 $e^{-\\mathrm{j}s_x k_x x}$ 的振幅为 $\\exp(\\mathrm{Im}(s_x k_x)x)$，当 $\\mathrm{Im}(s_x)<0$ 时会衰减。我们继续，阻抗的计算与此选择无关。\n\n现在，我们计算 PML 介质中前向传播波的波阻抗。使用 $e^{-\\mathrm{j}\\omega t}$ 约定下的方程 (2')：\n$$\n-\\frac{\\partial E_z^{(2)}}{\\partial x} = \\mathrm{j}\\omega(\\mu_0 s_x) H_y^{(2)}\n$$\n对于前向波 $E_z^{(2)} \\propto e^{\\mathrm{j} s_x k_x x}$：\n$$\n-(\\mathrm{j} s_x k_x) E_z^{(2)} = \\mathrm{j}\\omega\\mu_0 s_x H_y^{(2)}\n$$\n$$\n-k_x E_z^{(2)} = \\omega\\mu_0 H_y^{(2)} \\implies H_y^{(2)} = -\\frac{k_x}{\\omega\\mu_0} E_z^{(2)}\n$$\nPML 的横向波阻抗为：\n$$\nZ_{PML} = \\frac{E_z^{(2)}}{-H_y^{(2)}} = \\frac{E_z^{(2)}}{-(-\\frac{k_x}{\\omega\\mu_0} E_z^{(2)})} = \\frac{\\omega\\mu_0}{k_x}\n$$\n我们看到 $Z_{PML}$ 是纯实数，并且与真空波阻抗 $Z_{vac}$ 完全相同：\n$$\nZ_{PML} = Z_{vac} = \\frac{\\omega\\mu_0}{k_x}\n$$\n两个介质界面处的反射系数 $R$ 由标准公式给出：\n$$\nR = \\frac{Z_{PML} - Z_{vac}}{Z_{PML} + Z_{vac}}\n$$\n由于阻抗是完美匹配的，我们有：\n$$\nR(\\theta, \\omega) = \\frac{\\frac{\\omega\\mu_0}{k_x} - \\frac{\\omega\\mu_0}{k_x}}{\\frac{\\omega\\mu_0}{k_x} + \\frac{\\omega\\mu_0}{k_x}} = \\frac{0}{2\\frac{\\omega\\mu_0}{k_x}} = 0\n$$\n这对所有 $\\theta$ (使得 $k_x \\neq 0$) 和所有 $\\omega$ 都成立。对于掠射入射 $\\theta=\\pi/2$，$k_x=0$ 且阻抗为无穷大，但反射的概念定义不明确。对于所有其他角度，反射为零。\n\n反射系数恒为零，因为 CFS-PML 根据其设计，其波阻抗不依赖于其吸收参数 $s_x$，并且对于所有入射角和所有频率，都与周围介质（本例中为真空）的阻抗完美匹配。", "answer": "$$\n\\boxed{0}\n$$", "id": "3293614"}, {"introduction": "理论上的完美性能在实际数值计算中并非总能实现，尤其对于掠入射波或倏逝场。这项练习 [@problem_id:3293635] 是一个计算实验，旨在通过编程比较传统PML（$\\alpha = 0$）与CFS-PML（$\\alpha > 0$）的吸收效果。你将通过数值结果直观地看到，复数频率移动参数 $\\alpha$ 如何显著改善对这类挑战性波的吸收能力，这正是发展CFS-PML的主要动机。", "problem": "考虑一个二维平面波在真空中入射到一个均匀的完美匹配层（PML），该PML占据半空间 $x \\ge 0$ 且参数恒定。PML通过沿 $x$ 方向的复坐标拉伸进行建模。设自由空间波速为 $c = 299\\,792\\,458 \\, \\text{m/s}$。入射波的角频率为 $\\omega$，入射角 $\\theta$ 从表面法线量起（因此 $\\theta = 0$ 对应法向入射，$\\theta \\to \\frac{\\pi}{2}$ 对应掠射）。PML采用复频移坐标拉伸函数\n$$\ns_x(\\omega) = \\kappa + \\frac{\\sigma}{\\alpha + \\mathrm{j} \\omega},\n$$\n其中 $\\kappa \\ge 1$ 是无量纲的，$\\sigma \\ge 0$ 的单位是 $\\text{s}^{-1}$，$\\alpha \\ge 0$ 的单位是 $\\text{s}^{-1}$。$\\alpha = 0$ 的情况对应于经典PML，而 $\\alpha > 0$ 对应于复频移PML。\n\n真空中的时谐平面波满足色散关系 $k_0 = \\omega/c$，其 $x$ 方向的波数分量为 $k_x = k_0 \\cos \\theta$。在复坐标拉伸下，PML中的平面波解的形式为 $\\exp\\!\\left(j k_x \\int_0^x \\frac{dx'}{s_x(\\omega)}\\right)$，因此沿 $x$ 方向的单位长度振幅衰减由 $1/s_x(\\omega)$ 的虚部决定。定义\n$$\nb(\\omega) = \\operatorname{Im}\\!\\left(\\frac{1}{s_x(\\omega)}\\right),\n\\quad\n\\gamma(\\omega,\\theta) = k_x \\, b(\\omega) = \\frac{\\omega}{c}\\cos\\theta \\; b(\\omega),\n$$\n因此单次通过厚度为 $d$ 的PML板会产生一个振幅因子 $\\exp(-\\gamma(\\omega,\\theta) d)$。如果一个理想电导体在 $x=d$ 处终止PML，那么对于频率为 $\\omega$ 的单色分量，从该终端反射回真空的能量（双程）近似为\n$$\n\\mathcal{R}(\\omega,\\theta) \\approx \\exp\\left(-4 \\, \\gamma(\\omega,\\theta) \\, d\\right).\n$$\n\n现在考虑一个因果高斯带限脉冲，其谱能量密度为\n$$\nS(\\omega) = \\exp\\!\\left(-\\frac{(\\omega - \\omega_0)^2}{2 \\sigma_\\omega^2}\\right), \\quad \\omega \\ge 0,\n$$\n其中 $\\omega_0 > 0$ 是中心角频率，$\\sigma_\\omega > 0$ 是谱标准差。该脉冲的总能量归一化反射由下式估算\n$$\n\\mathcal{E}(\\theta; \\kappa,\\sigma,\\alpha,d,\\omega_0,\\sigma_\\omega) = \\frac{\\int_0^\\infty S(\\omega) \\, \\exp\\!\\left(-4 \\gamma(\\omega,\\theta) d \\right) \\, d\\omega}{\\int_0^\\infty S(\\omega) \\, d\\omega}.\n$$\n\n您的任务是编写一个程序，对下面描述的每个测试用例，计算标量 $\\mathcal{E}$，结果为一个浮点数（无量綱，因为它是一个能量比）。所有角度在输入参数中必须以度为单位解释，所有距离必须以米为单位。在公式内部，频率必须以弧度/秒为单位，因此如果中心频率和带宽以赫兹给出，则必须通过乘以 $2\\pi$ 将它们转换为弧度/秒。\n\n使用以下测试套件。每个测试用例是一个元组 $(\\alpha,\\kappa,\\sigma,d,\\theta_{\\text{deg}},f_0,\\Delta f)$，其单位规定如下：\n- $\\alpha$ 单位为 $\\text{s}^{-1}$，\n- $\\kappa$ 无单位，\n- $\\sigma$ 单位为 $\\text{s}^{-1}$，\n- $d$ 单位为 $\\text{m}$，\n- $\\theta_{\\text{deg}}$ 单位为度，\n- $f_0$ 单位为 $\\text{Hz}$，\n- $\\Delta f$ 单位为 $\\text{Hz}$，\n并且有 $\\omega_0 = 2\\pi f_0$ 和 $\\sigma_\\omega = 2\\pi \\Delta f$。\n\n测试用例：\n1. $(0.0, \\, 1.0, \\, 5.0\\times 10^9, \\, 0.2, \\, 89.0, \\, 1.0\\times 10^9, \\, 0.5\\times 10^9)$\n2. $(2\\pi \\times 0.2\\times 10^9, \\, 1.0, \\, 5.0\\times 10^9, \\, 0.2, \\, 89.0, \\, 1.0\\times 10^9, \\, 0.5\\times 10^9)$\n3. $(0.0, \\, 1.0, \\, 5.0\\times 10^9, \\, 0.2, \\, 89.9, \\, 1.0\\times 10^9, \\, 0.5\\times 10^9)$\n4. $(0.0, \\, 1.0, \\, 5.0\\times 10^9, \\, 0.0, \\, 85.0, \\, 1.0\\times 10^9, \\, 0.5\\times 10^9)$\n5. $(0.0, \\, 1.0, \\, 5.0\\times 10^9, \\, 0.4, \\, 85.0, \\, 2.0\\times 10^9, \\, 0.5\\times 10^9)$\n\n实现要求和数值指导：\n- 在有限区间 $[\\omega_{\\min},\\omega_{\\max}]$ 上计算关于 $\\omega$ 的积分，选择该区间以有效捕捉高斯谱。一个合理的选择是 $\\omega_{\\min} = \\max\\{0, \\omega_0 - L \\sigma_\\omega\\}$ 和 $\\omega_{\\max} = \\omega_0 + L \\sigma_\\omega$，其中 $L=8$。\n- 使用一致的单位：在三角函数内部以弧度表示 $\\theta$，所有角频率以弧度/秒表示。\n- 对于每个测试用例，以合理的数值精度计算 $\\mathcal{E}$。\n- 您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果（例如，“[r1,r2,r3,r4,r5]”），其中每个 $r_i$ 是第 $i$ 个测试用例计算出的 $\\mathcal{E}$ 值。\n\n所有距离以米表示，所有角度按指定以度表示，并以指定格式在单行上生成无量纲浮点数的最终输出。输出中不需要其他单位，因为根据定义 $\\mathcal{E}$ 是无量纲的。", "solution": "已根据指定标准对用户提供的问题进行了分析和验证。\n\n### 步骤 1：提取已知条件\n- **物理系统**：真空中的二维平面波入射到 PML 半空间 $x \\ge 0$。\n- **常数**：真空中的光速，$c = 299\\,792\\,458 \\, \\text{m/s}$。\n- **入射波参数**：角频率 $\\omega$，从表面法线量起的入射角 $\\theta$。\n- **PML模型**：复坐标拉伸函数 $s_x(\\omega) = \\kappa + \\frac{\\sigma}{\\alpha + \\mathrm{j} \\omega}$。\n- **PML参数**：$\\kappa \\ge 1$（无量纲），$\\sigma \\ge 0$（$\\text{s}^{-1}$），$\\alpha \\ge 0$（$\\text{s}^{-1}$）。\n- **关键函数**：\n    - 真空波数：$k_0 = \\omega/c$。\n    - 波数分量：$k_x = k_0 \\cos \\theta$。\n    - 衰减函数：$b(\\omega) = \\operatorname{Im}(1/s_x(\\omega))$。\n    - 衰减率：$\\gamma(\\omega,\\theta) = k_x b(\\omega) = \\frac{\\omega}{c}\\cos\\theta \\, b(\\omega)$。\n- **反射模型**：对于由理想电导体终止的厚度为 $d$ 的PML，双程能量反射为 $\\mathcal{R}(\\omega,\\theta) \\approx \\exp\\left(-4 \\, \\gamma(\\omega,\\theta) \\, d\\right)$。\n- **脉冲模型**：高斯带限脉冲，其谱能量密度为 $S(\\omega) = \\exp(-\\frac{(\\omega - \\omega_0)^2}{2 \\sigma_\\omega^2})$（对于 $\\omega \\ge 0$）。\n- **待计算量**：总能量归一化反射 $\\mathcal{E} = \\frac{\\int_0^\\infty S(\\omega) \\, \\exp\\left(-4 \\gamma(\\omega,\\theta) d \\right) \\, d\\omega}{\\int_0^\\infty S(\\omega) \\, d\\omega}$。\n- **输入参数和测试用例**：提供了五个测试用例，形式为元组 $(\\alpha,\\kappa,\\sigma,d,\\theta_{\\text{deg}},f_0,\\Delta f)$，指定的单位需要转换：$\\omega_0 = 2\\pi f_0$ 和 $\\sigma_\\omega = 2\\pi \\Delta f$。\n- **数值指导**：在 $[\\omega_{\\min},\\omega_{\\max}] = [\\max\\{0, \\omega_0 - L \\sigma_\\omega\\}, \\omega_0 + L \\sigma_\\omega]$ 上积分，其中 $L=8$。\n\n### 步骤 2：使用提取的已知条件进行验证\n该问题在计算电磁学中完美匹配层的既定理论上具有科学依据。复数拉伸函数、产生的波衰减以及能量反射积分的公式都是标准的。该问题是适定的，提供了计算唯一数值结果所需的所有必要定义、常数和参数。测试用例中的参数是物理上现实的，旨在测试经典（$\\alpha=0$）与复频移（$\\alpha>0$）PML的性能，尤其是在具有挑战性的掠射角下。$d=0$的特殊情况提供了一个简单的健全性检查，其中反射 $\\mathcal{E}$ 必须等于 $1$。问题陈述是自洽、客观且数学上一致的。未发现任何缺陷。\n\n### 步骤 3：结论与行动\n问题是**有效的**。将提供一个解决方案。\n\n### 基于原理的解决方案设计\n任务是计算高斯脉冲的总能量归一化反射 $\\mathcal{E}$。该量定义为关于角频率 $\\omega$ 的两个积分之比：\n$$\n\\mathcal{E} = \\frac{\\mathcal{N}}{\\mathcal{D}} = \\frac{\\int_0^\\infty S(\\omega) \\, \\exp\\!\\left(-4 \\, \\gamma(\\omega,\\theta) \\, d \\right) \\, d\\omega}{\\int_0^\\infty S(\\omega) \\, d\\omega}\n$$\n分母 $\\mathcal{D}$ 是入射脉冲的总能量，而分子 $\\mathcal{N}$ 是双程通过厚度为 $d$ 的PML后的总反射能量。解决方案涉及这些积分的数值评估。\n\n问题的核心在于函数 $\\gamma(\\omega, \\theta)$，它决定了衰减。其定义为：\n$$\n\\gamma(\\omega,\\theta) = \\frac{\\omega}{c}\\cos\\theta \\; \\operatorname{Im}\\!\\left(\\frac{1}{s_x(\\omega)}\\right)\n$$\n其中 $s_x(\\omega) = \\kappa + \\frac{\\sigma}{\\alpha + \\mathrm{j} \\omega}$。$\\gamma(\\omega, \\theta)$ 的实现细节必须小心处理，以保持数值稳定性，特别是对于经典PML情况（$\\alpha=0$）。\n\n对于经典PML情况（$\\alpha=0$），拉伸函数为 $s_x(\\omega) = \\kappa + \\frac{\\sigma}{\\mathrm{j}\\omega} = \\kappa - \\mathrm{j}\\frac{\\sigma}{\\omega}$。其倒数的虚部 $b(\\omega)$ 可以通过解析方法找到，以避免在 $\\omega=0$ 附近的数值问题：\n$$\n\\frac{1}{s_x(\\omega)} = \\frac{1}{\\kappa - \\mathrm{j}\\frac{\\sigma}{\\omega}} = \\frac{\\kappa + \\mathrm{j}\\frac{\\sigma}{\\omega}}{\\kappa^2 + (\\sigma/\\omega)^2} = \\frac{\\omega^2\\kappa + \\mathrm{j}\\omega\\sigma}{\\omega^2\\kappa^2 + \\sigma^2}\n$$\n$$\nb(\\omega) = \\operatorname{Im}\\!\\left(\\frac{1}{s_x(\\omega)}\\right) = \\frac{\\omega\\sigma}{\\omega^2\\kappa^2 + \\sigma^2}\n$$\n因此，对于 $\\alpha=0$，衰减率由数值稳定的形式给出：\n$$\n\\gamma(\\omega,\\theta) = \\frac{\\omega}{c}\\cos\\theta \\left( \\frac{\\omega\\sigma}{\\omega^2\\kappa^2 + \\sigma^2} \\right) = \\frac{\\sigma \\omega^2 \\cos\\theta}{c (\\kappa^2\\omega^2 + \\sigma^2)}\n$$\n此表达式对于所有 $\\omega \\ge 0$ 都是良态的。\n\n对于复频移（CFS）PML情况（$\\alpha > 0$），对于 $\\omega \\ge 0$，分母 $\\alpha + \\mathrm{j}\\omega$ 永远不为零。因此，$s_x(\\omega)$ 是良定义的，其倒数可以使用复数算术直接计算。衰减率 $\\gamma(\\omega,\\theta)$ 可以实现为：\n$$\n\\gamma(\\omega,\\theta) = \\frac{\\omega}{c}\\cos\\theta \\; \\operatorname{Im}\\!\\left(\\frac{1}{\\kappa + \\frac{\\sigma}{\\alpha + \\mathrm{j} \\omega}}\\right)\n$$\n\n数值实现过程如下：\n1.  对于每个测试用例，将输入参数转换为国际单位制单位和弧度：$\\theta_{\\text{deg}} \\to \\theta$ (弧度)，$f_0 \\to \\omega_0$ (rad/s)，以及 $\\Delta f \\to \\sigma_\\omega$ (rad/s)。\n2.  处理PML厚度 $d=0$ 的简单情况。在这种情况下，反射因子 $\\exp(-4\\gamma d)$ 为 $\\exp(0)=1$，使得 $\\mathcal{E}=1$。\n3.  按规定定义积分范围 $[\\omega_{\\min}, \\omega_{\\max}]$，其中 $\\omega_{\\min} = \\max\\{0, \\omega_0 - 8 \\sigma_\\omega\\}$ 和 $\\omega_{\\max} = \\omega_0 + 8 \\sigma_\\omega$。这个范围足够宽，可以捕捉到高斯脉冲几乎所有的能量。\n4.  实现被积函数。定义一个函数 `gamma_func(w)`，它根据 $\\alpha$ 的值进行分支，以使用适当的稳定公式。然后，分子被积函数是 $S(\\omega) \\exp(-4\\gamma(\\omega, \\theta)d)$，分母被积函数是 $S(\\omega)$。\n5.  使用高质量的数值求积例程，例如 `scipy.integrate.quad`，在确定的范围 $[\\omega_{\\min}, \\omega_{\\max}]$ 上计算分子积分 $\\mathcal{N}$ 和分母积分 $\\mathcal{D}$。\n6.  测试用例的最终结果是比率 $\\mathcal{E} = \\mathcal{N}/\\mathcal{D}$。\n对所有测试用例重复此过程，并将结果格式化为所需的输出字符串。", "answer": "```python\nimport numpy as np\nfrom scipy.integrate import quad\n\ndef solve():\n    \"\"\"\n    Solves the PML reflection problem for the given test cases.\n    \"\"\"\n    # Define the constant for the speed of light in vacuum.\n    C_LIGHT = 299792458.0\n\n    # Define the test cases from the problem statement.\n    # Each tuple: (alpha, kappa, sigma, d, theta_deg, f0, delta_f)\n    # Units: alpha (s^-1), kappa (unitless), sigma (s^-1), d (m),\n    #        theta_deg (degrees), f0 (Hz), delta_f (Hz).\n    test_cases = [\n        (0.0, 1.0, 5.0e9, 0.2, 89.0, 1.0e9, 0.5e9),\n        (2 * np.pi * 0.2e9, 1.0, 5.0e9, 0.2, 89.0, 1.0e9, 0.5e9),\n        (0.0, 1.0, 5.0e9, 0.2, 89.9, 1.0e9, 0.5e9),\n        (0.0, 1.0, 5.0e9, 0.0, 85.0, 1.0e9, 0.5e9),\n        (0.0, 1.0, 5.0e9, 0.4, 85.0, 2.0e9, 0.5e9),\n    ]\n\n    def calculate_reflection(params):\n        \"\"\"\n        Computes the energy-normalized reflection E for a single test case.\n        \"\"\"\n        alpha, kappa, sigma, d, theta_deg, f0, df = params\n\n        # Trivial case: If PML thickness is zero, reflection is total (E=1).\n        if d == 0.0:\n            return 1.0\n\n        # Convert input parameters to standard units for calculation (rad, rad/s).\n        theta_rad = np.deg2rad(theta_deg)\n        w0 = 2.0 * np.pi * f0\n        sigma_w = 2.0 * np.pi * df\n\n        cos_theta = np.cos(theta_rad)\n\n        # Define the numerical integration range based on the Gaussian spectrum.\n        L = 8.0\n        w_min = max(0.0, w0 - L * sigma_w)\n        w_max = w0 + L * sigma_w\n\n        # Spectral energy density function S(w)\n        def S(w):\n            return np.exp(-((w - w0)**2) / (2.0 * sigma_w**2))\n\n        # Numerically stable function for the attenuation rate gamma(w, theta).\n        # We branch based on alpha to ensure stability at w=0 for the classical PML.\n        if alpha == 0.0:\n            def gamma_func(w):\n                # Analytical form for alpha=0 case, stable for all w >= 0.\n                numerator = sigma * w**2 * cos_theta\n                denominator = C_LIGHT * (kappa**2 * w**2 + sigma**2)\n                if denominator == 0: return 0.0\n                return numerator / denominator\n        else:  # alpha > 0\n            def gamma_func(w):\n                # Direct computation using complex numbers for CFS-PML (alpha > 0).\n                # This is stable for w >= 0 since alpha > 0.\n                if w == 0.0: return 0.0\n                s_x = kappa + sigma / (alpha + 1j * w)\n                b_w = np.imag(1.0 / s_x)\n                return (w / C_LIGHT) * cos_theta * b_w\n\n        # Integrand for the numerator of E\n        def numerator_integrand(w):\n            gamma = gamma_func(w)\n            attenuation_factor = np.exp(-4.0 * gamma * d)\n            return S(w) * attenuation_factor\n\n        # Integrand for the denominator of E is just S(w)\n        denominator_integrand = S\n\n        # Perform numerical integration using scipy.integrate.quad\n        # Set tolerance for higher accuracy\n        quad_opts = {'epsabs': 1e-12, 'epsrel': 1e-12}\n        num_integral, _ = quad(numerator_integrand, w_min, w_max, **quad_opts)\n        den_integral, _ = quad(denominator_integrand, w_min, w_max, **quad_opts)\n\n        # The result is the ratio of the two integrals.\n        if den_integral == 0.0:\n            return 0.0  # Should not happen for valid pulse parameters\n        \n        return num_integral / den_integral\n\n    # Calculate reflection for each test case\n    results = [calculate_reflection(case) for case in test_cases]\n\n    # Print the results in the specified format\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3293635"}, {"introduction": "在时域求解器中实现CFS-PML会引入新的数值稳定性挑战，特别是当频率移动参数 $\\alpha$ 很大时。这项练习 [@problem_id:3293618] 将带你探究PML辅助变量更新方程中潜在的数值下溢和灾难性抵消误差问题，并指导你实现稳健的解决方案。掌握这些技术对于构建包含CFS-PML的可靠时域仿真代码至关重要。", "problem": "考虑计算电磁学中复频移完美匹配层（CFS-PML）的辅助微分方程公式。在单个笛卡尔坐标方向上，一个常见的记忆变量 $\\psi(t)$ 遵循由源 $g(t)$ 驱动的一阶线性常微分方程，该源项依赖于场导数：\n$$\n\\frac{d\\psi}{dt} + \\gamma\\,\\psi = g(t),\n$$\n其中 $\\gamma = \\sigma/\\kappa + \\alpha$，$\\sigma/\\kappa \\ge 0$ 表示有效电导率与拉伸系数之比，$\\alpha \\ge 0$ 表示复频移。假设对于给定的空间位置，$\\sigma/\\kappa$ 和 $\\alpha$ 在时间上是恒定的。考虑大小为 $\\Delta t$ 的均匀时间步长和离散时间 $t_n = n\\Delta t$。\n\n在物理上标准的假设下，即 $g(t)$ 在每个时间步内是常数（即，对于 $t \\in [t_n,t_{n+1})$，有 $g(t) \\equiv g_n$），对一个步长进行精确时间积分会得到一个形如下式的线性递推关系\n$$\n\\psi_{n+1} = a\\,\\psi_n + b\\,g_n,\n$$\n其中 $a$ 和 $b$ 是由 $\\gamma$ 和 $\\Delta t$ 决定的、与时间步长相关的系数。较大的 $\\alpha$ 和/或 $\\sigma/\\kappa$ 值可能会由于以下原因，在双精度算术中引起严重的数值问题：\n- 当 $\\gamma \\Delta t$ 很大时，$a = e^{-\\gamma \\Delta t}$ 发生下溢，\n- 当 $\\gamma \\Delta t$ 非常小时，$b$ 发生灾难性抵消，\n- 在长时间运行时，递推关系中出现次正规数或零的传播。\n\n您的任务是编写一个完整的程序，该程序：\n1) 在朴素更新方法中，实现系数下溢和迭代状态次正规性/零的检测器，\n2) 实现两种数值鲁棒的策略，这两种策略保持相同的物理模型（不改变连续方程），即：\n   - 策略 S1 (系数稳定化)：使用避免抵消的原语来评估系数，以便对所有 $\\gamma \\Delta t$ 值都能鲁棒地计算 $b$，\n   - 策略 S2 (级数累加)：使用补偿求和从等效的几何级数表示中计算 $\\psi_N$，而无需迭代状态更新，\n3) 将朴素更新、S1 和 S2 的结果与根据精确模型构建的高精度参考值进行比较。\n\n从时域电磁学满足麦克斯韦旋度方程这一基本基础出发，并且在 CFS-PML 中，辅助变量遵循线性定律 $d\\psi/dt + \\gamma \\psi = g(t)$。基于此，通过对每个步长内分段常数 $g(t)$ 进行精确积分，来离散化该辅助常微分方程，以确定递推关系。\n\n程序要求：\n- 假设在每个测试中，对于所有 $n$， $g_n \\equiv u$ 都是一个常数。\n- 主要计算使用双精度浮点数。\n- 使用任意精度十进制算术，为在 $\\psi_0 = 0$ 和常数 $u$ 条件下 $n=N$ 处的精确闭式解构建一个高精度参考值。\n- 实现三种数值方法来计算 $\\psi_N$：\n  - 朴素法：以双精度计算 $a = \\exp(-\\gamma \\Delta t)$ 和 $b = \\frac{1-a}{\\gamma}$；迭代 $\\psi_{n+1} = a \\psi_n + b u$ 进行 $n=0,\\dots,N-1$ 次，如果 $\\psi_n$ 曾变为精确零或次正规数，即 $0 < |\\psi_n| < \\text{tiny}$（其中 $\\text{tiny}$ 是最小的正规双精度数），则进行标记。\n  - 策略 S1 (系数稳定化)：计算 $a = \\exp(-\\gamma \\Delta t)$ 并以 $b = -\\mathrm{expm1}(-\\gamma \\Delta t)/\\gamma$ 的形式以双精度计算 $b$ 以避免抵消；像朴素法一样进行迭代，并仅报告最终的 $\\psi_N$。\n  - 策略 S2 (级数累加)：使用 Kahan 补偿求和计算\n    $$\n    \\psi_N = b u \\sum_{k=0}^{N-1} a^k,\n    $$\n    其中几何级数项更新为 $\\text{term} \\leftarrow a \\cdot \\text{term}$ 以防止有效位数损失；使用与 S1 中相同的稳定化 $a$ 和 $b$。\n- 实现系数下溢检测：如果 $a$ 在双精度中下溢为零，则进行标记。\n- 实现灾难性抵消风险检测：如果 $x = \\gamma \\Delta t$ 低于一个指定的阈值，在该阈值下 $1 - e^{-x}$ 在双精度计算中会遭受灾难性抵消，则进行标记。\n- 计算每种方法相对于高精度参考值的绝对相对误差，公式为 $|\\psi_N^{(\\cdot)} - \\psi_N^{\\text{ref}}|/\\max(|\\psi_N^{\\text{ref}}|, \\tau)$，其中 $\\tau = 10^{-300}$ 以避免除以零。\n\n物理和数值单位：\n- 使用国际单位制 (SI)：$\\alpha$ 和 $\\sigma/\\kappa$ 的单位是 $\\mathrm{s}^{-1}$，$\\Delta t$ 的单位是 $\\mathrm{s}$，$N$ 是无量纲的。在本测试中，常数输入 $u$ 是无量纲的。\n- 所有输出必须以十进制数报告（无百分号），不带单位。\n\n测试套件：\n对于每个测试用例，使用 $\\psi_0 = 0$ 和 $u = 1.0$。提供四个覆盖稳定区域、大 $\\alpha$ 下溢、小 $x$ 抵消和中等情况的案例：\n- 情况 1 (理想路径，强阻尼)：$\\sigma/\\kappa = 5\\times 10^7\\,\\mathrm{s}^{-1},\\ \\alpha = 10^8\\,\\mathrm{s}^{-1},\\ \\Delta t = 10^{-9}\\,\\mathrm{s},\\ N=10000$。\n- 情况 2 (大 $\\alpha$ 导致系数下溢)：$\\sigma/\\kappa = 0\\,\\mathrm{s}^{-1},\\ \\alpha = 10^{12}\\,\\mathrm{s}^{-1},\\ \\Delta t = 10^{-9}\\,\\mathrm{s},\\ N=100$。\n- 情况 3 (小 $x$ 抵消压力测试)：$\\sigma/\\kappa = 0\\,\\mathrm{s}^{-1},\\ \\alpha = 10^{-6}\\,\\mathrm{s}^{-1},\\ \\Delta t = 10^{-9}\\,\\mathrm{s},\\ N=100000$。\n- 情况 4 (中等情况)：$\\sigma/\\kappa = 10^7\\,\\mathrm{s}^{-1},\\ \\alpha = 0\\,\\mathrm{s}^{-1},\\ \\Delta t = 10^{-8}\\,\\mathrm{s},\\ N=1000$。\n\n对于每个测试用例，您的程序必须按以下顺序输出一个包含五个条目的列表：\n1) 一个布尔值，指示 $a$ 是否在双精度中下溢为零，\n2) 一个布尔值，指示朴素迭代状态是否曾变为次正规数或零，\n3) 一个浮点数，给出朴素方法的相对误差，\n4) 一个浮点数，给出策略 S1 的相对误差，\n5) 一个浮点数，给出策略 S2 的相对误差。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含结果，格式为四个按案例排列的列表组成的逗号分隔列表，并由一对总方括号包围，例如：\n[[bool,bool,float,float,float],[...],[...],[...]]\n不应打印任何其他文本。", "solution": "用户提供了一个在计算电磁学领域科学合理且定义明确的问题，该问题关注复频移完美匹配层（CFS-PML）中辅助变量更新的数值稳定性。该问题是有效的，并将提供一个完整、论证充分的解决方案。\n\n问题的核心在于对控制 PML 辅助记忆变量 $\\psi(t)$ 的一阶线性常微分方程 (ODE) 进行时间积分：\n$$\n\\frac{d\\psi}{dt} + \\gamma\\,\\psi(t) = g(t)\n$$\n其中 $\\gamma = \\sigma/\\kappa + \\alpha$ 是一个在给定空间位置上不随时间变化的参数，且 $\\sigma/\\kappa \\ge 0$ 和 $\\alpha \\ge 0$。源项 $g(t)$ 被假设在每个时间步 $\\Delta t$ 内是分段常数，即对于 $t \\in [t_n, t_{n+1})$，有 $g(t) = g_n$。\n\n为了推导离散更新规则，我们使用积分因子法在区间 $[t_n, t_{n+1}]$ 上求解该 ODE。积分因子是 $e^{\\gamma t}$。将 ODE 乘以该因子得到：\n$$\ne^{\\gamma t} \\frac{d\\psi}{dt} + \\gamma e^{\\gamma t} \\psi(t) = e^{\\gamma t} g(t)\n$$\n左侧是乘积的导数：\n$$\n\\frac{d}{dt} \\left( \\psi(t) e^{\\gamma t} \\right) = e^{\\gamma t} g(t)\n$$\n将此方程从 $t_n$ 积分到 $t_{n+1}$：\n$$\n\\left[ \\psi(t') e^{\\gamma t'} \\right]_{t_n}^{t_{n+1}} = \\int_{t_n}^{t_{n+1}} e^{\\gamma t'} g(t') \\,dt'\n$$\n$$\n\\psi(t_{n+1}) e^{\\gamma t_{n+1}} - \\psi(t_n) e^{\\gamma t_n} = \\int_{t_n}^{t_{n+1}} e^{\\gamma t'} g_n \\,dt'\n$$\n由于 $g_n$ 是常数，可以将其移出积分：\n$$\n\\psi(t_{n+1}) e^{\\gamma t_{n+1}} - \\psi(t_n) e^{\\gamma t_n} = g_n \\left[ \\frac{e^{\\gamma t'}}{\\gamma} \\right]_{t_n}^{t_{n+1}} = g_n \\frac{e^{\\gamma t_{n+1}} - e^{\\gamma t_n}}{\\gamma}\n$$\n此式在 $\\gamma \\neq 0$ 时成立。求解 $\\psi(t_{n+1})$（记为 $\\psi_{n+1}$），并注意到 $t_{n+1} - t_n = \\Delta t$，可得：\n$$\n\\psi_{n+1} = \\psi_n e^{-\\gamma(t_{n+1} - t_n)} + g_n \\frac{1 - e^{-\\gamma(t_{n+1} - t_n)}}{\\gamma}\n$$\n$$\n\\psi_{n+1} = e^{-\\gamma \\Delta t} \\psi_n + \\frac{1 - e^{-\\gamma \\Delta t}}{\\gamma} g_n\n$$\n这是一个形如 $\\psi_{n+1} = a\\,\\psi_n + b\\,g_n$ 的线性递推关系，其系数为：\n$$\na = e^{-\\gamma \\Delta t}\n$$\n$$\nb = \\frac{1 - e^{-\\gamma \\Delta t}}{\\gamma}\n$$\n在 $\\gamma = 0$ 的特殊情况下，ODE 变为 $\\frac{d\\psi}{dt} = g(t)$，积分得到 $\\psi_{n+1} = \\psi_n + g_n \\Delta t$。这对应于 $\\gamma \\to 0$ 时 $a \\to 1$ 和 $b \\to \\Delta t$ 的极限。\n\n该问题要求分析在标准双精度浮点数算术中直接计算这些系数时出现的数值问题。\n\n**1. 朴素实现中的数值病态问题**\n\n*   **系数下溢：** 当乘积 $\\gamma \\Delta t$ 很大且为正时，系数 $a = e^{-\\gamma \\Delta t}$ 可能会变得比可表示的最小正浮点数还小，从而下溢为零。对于 IEEE 754 双精度，当 $\\gamma \\Delta t \\gtrsim 710$ 时会发生这种情况。这在情况 2 中进行了测试。实现了一个下溢标志来检测 $a$ 何时变为精确的 $0.0$。\n\n*   **灾难性抵消：** 当 $\\gamma \\Delta t$ 非常接近零时，$e^{-\\gamma \\Delta t} \\approx 1 - \\gamma \\Delta t$。$b$ 的分子 $1 - e^{-\\gamma \\Delta t}$ 涉及两个几乎相等的数相减，这会导致相对精度的严重损失。这被称为灾难性抵消，在情况 3 中进行了测试。\n\n*   **迭代状态退化：** 如果 $a$ 下溢为零，递推关系简化为 $\\psi_{n+1} = b\\,g_n$。如果 $b$ 和 $g_n$ 很小，状态 $\\psi_n$ 本身可能成为一个次正规数或零。次正规数的精度较低，如果 $\\psi_n$（对于 $n > 0$）变为精确零，系统的“记忆”就会丢失。实现了一个标志来检测 $\\psi_n$（对于 $n > 0$）是否落入次正规范围 $(0, \\text{tiny})$ 或变为精确零。\n\n**2. 数值鲁棒策略**\n\n为了缓解这些问题，我们实现并比较了两种鲁棒策略。\n\n*   **策略 S1 (系数稳定化)：** 该策略直接解决了 $b$ 中的灾难性抵消问题。这里使用了数学恒等式 $\\mathrm{expm1}(x) = e^x - 1$。函数 $\\mathrm{expm1}(x)$ 在标准数值库中被实现，用于为 $x \\approx 0$ 的情况返回精确结果。系数 $b$ 被重构为：\n    $$\n    b = \\frac{1 - e^{-\\gamma \\Delta t}}{\\gamma} = \\frac{-\\left(e^{-\\gamma \\Delta t} - 1\\right)}{\\gamma} = \\frac{-\\mathrm{expm1}(-\\gamma \\Delta t)}{\\gamma}\n    $$\n    这种形式对于所有 $\\gamma \\Delta t$ 的值都是数值稳定的。系数 $a$ 的计算方式与之前相同。然后迭代递推关系 $\\psi_{n+1} = a\\,\\psi_n + b\\,g_n$。\n\n*   **策略 S2 (级数累加)：** 该策略完全避免了迭代递推关系。对于初始条件 $\\psi_0 = 0$ 和常数源 $g_n = u$，在第 $N$ 步的解可以写成一个几何级数：\n    $$\n    \\psi_N = b u \\sum_{k=0}^{N-1} a^k\n    $$\n    虽然这个公式是精确的，但在浮点数算术中对其进行朴素计算可能会累积舍入误差，特别是在 $N$ 很大时。为了最小化此误差，使用 Kahan 补偿求和来计算总和。该算法维护一个运行的补偿项，以跟踪每次加法中丢失的误差，从而显著提高最终和的准确性。所使用的系数 $a$ 和 $b$ 是来自策略 S1 的稳定化版本。\n\n**3. 高精度参考解**\n\n为了给误差分析提供一个“基准真相”，我们计算了一个参考解 $\\psi_N^{\\text{ref}}$。该几何级数有一个闭式和：\n$$\n\\psi_N = b u \\left( \\frac{1 - a^N}{1-a} \\right) = u \\frac{1 - e^{-\\gamma \\Delta t}}{\\gamma} \\frac{1 - (e^{-\\gamma \\Delta t})^N}{1 - e^{-\\gamma \\Delta t}} = u \\frac{1 - e^{-N\\gamma \\Delta t}}{\\gamma}\n$$\n这个闭式表达式使用 Python 的 `decimal` 模块提供的任意精度算术进行计算，精度设置为 $100$ 位，以确保其值远比任何双精度结果精确。这个参考值 $\\psi_N^{\\text{ref}}$ 用于计算朴素法、S1 和 S2 方法的相对误差。误差定义为 $\\frac{|\\psi_N^{(\\cdot)} - \\psi_N^{\\text{ref}}|}{\\max(|\\psi_N^{\\text{ref}}|, \\tau)}$，其中 $\\tau = 10^{-300}$ 以防止除以接近零的参考值。\n\n随附的 Python 程序实现了这三种方法、指定的检测以及针对所提供测试套件的误差计算，展示了鲁棒数值策略的有效性。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom decimal import Decimal, getcontext\n\ndef solve():\n    \"\"\"\n    Solves the CFS-PML numerical stability problem as specified.\n    \"\"\"\n    \n    # Define test cases: (sigma/kappa, alpha, dt, N)\n    test_cases = [\n        (5e7, 1e8, 1e-9, 10000),      # Case 1: Happy path\n        (0.0, 1e12, 1e-9, 100),       # Case 2: Large alpha, underflow\n        (0.0, 1e-6, 1e-9, 100000),    # Case 3: Small x, cancellation\n        (10e6, 0.0, 1e-8, 1000)        # Case 4: Moderate case\n    ]\n    \n    # Constants for computation\n    u = 1.0\n    psi0 = 0.0\n    TINY_DOUBLE = np.finfo(np.float64).tiny\n    TAU_ERROR = Decimal('1e-300')\n    HIGH_PRECISION = 100\n\n    # List to store results for all cases\n    all_results = []\n\n    for case in test_cases:\n        sigma_kappa, alpha, dt, N = case\n        \n        gamma = sigma_kappa + alpha\n        x = gamma * dt\n        \n        # --- 1. High-Precision Reference Calculation ---\n        getcontext().prec = HIGH_PRECISION\n        gamma_d = Decimal(gamma)\n        dt_d = Decimal(dt)\n        N_d = Decimal(N)\n        u_d = Decimal(u)\n        \n        if gamma_d == 0:\n            psi_N_ref = u_d * N_d * dt_d\n        else:\n            x_d_N = -N_d * gamma_d * dt_d\n            psi_N_ref = u_d * (1 - x_d_N.exp()) / gamma_d\n        \n        ref_val_float = float(psi_N_ref)\n\n        # --- 2. Naive Method ---\n        a_naive = np.exp(-x)\n        if gamma == 0.0:\n            b_naive = dt\n        else:\n            b_naive = (1 - a_naive) / gamma\n        \n        # Flags for naive method\n        a_underflowed = (a_naive == 0.0 and x > 0)\n        state_subnormal_or_zero = False\n        \n        psi_n = psi0\n        for n in range(N):\n            psi_n = a_naive * psi_n + b_naive * u\n            if n > 0: \n                if (psi_n != 0.0 and np.abs(psi_n)  TINY_DOUBLE) or (psi_n == 0.0):\n                     state_subnormal_or_zero = True\n\n\n        psi_N_naive = psi_n\n\n        # --- 3. Strategy S1: Coefficient Stabilization ---\n        a_s1 = np.exp(-x) # same as a_naive\n        if gamma == 0.0:\n            b_s1 = dt\n        else:\n            b_s1 = -np.expm1(-x) / gamma\n        \n        psi_n = psi0\n        for _ in range(N):\n            psi_n = a_s1 * psi_n + b_s1 * u\n        psi_N_s1 = psi_n\n\n        # --- 4. Strategy S2: Series Accumulation with Kahan Summation ---\n        a_s2 = a_s1 # Use stabilized coefficients\n        b_s2 = b_s1\n        \n        sum_val = 0.0\n        c = 0.0  # Compensation for lost low-order bits\n        term = 1.0 # Represents a^k\n        \n        # Kahan summation for sum(a^k) for k=0 to N-1\n        for _ in range(N):\n            y = term - c\n            t = sum_val + y\n            c = (t - sum_val) - y\n            sum_val = t\n            term *= a_s2\n        \n        psi_N_s2 = b_s2 * u * sum_val\n\n        # --- 5. Calculate Relative Errors ---\n        error_denom = max(np.abs(ref_val_float), float(TAU_ERROR))\n        \n        err_naive = np.abs(psi_N_naive - ref_val_float) / error_denom\n        err_s1 = np.abs(psi_N_s1 - ref_val_float) / error_denom\n        err_s2 = np.abs(psi_N_s2 - ref_val_float) / error_denom\n        \n        # Re-check subnormal condition for clarity, the loop above is sufficient but let's be explicit\n        psi_n_test = psi0\n        state_subnormal_or_zero_final = False\n        for n in range(N):\n             psi_n_test = a_naive * psi_n_test + b_naive * u\n             if n > 0: # only check state for n > 0\n                if (np.abs(psi_n_test) > 0 and np.abs(psi_n_test)  TINY_DOUBLE) or psi_n_test == 0.0:\n                   state_subnormal_or_zero_final = True\n                   break\n\n        case_results = [\n            a_underflowed,\n            state_subnormal_or_zero_final,\n            err_naive,\n            err_s1,\n            err_s2\n        ]\n        all_results.append(case_results)\n\n    # Format the final output string\n    def format_list(lst):\n        return f\"[{lst[0]},{lst[1]},{lst[2]},{lst[3]},{lst[4]}]\".replace(\"True\", \"true\").replace(\"False\", \"false\")\n\n    output_str = f\"[{','.join(map(format_list, all_results))}]\"\n    print(output_str)\n\nsolve()\n```", "id": "3293618"}]}