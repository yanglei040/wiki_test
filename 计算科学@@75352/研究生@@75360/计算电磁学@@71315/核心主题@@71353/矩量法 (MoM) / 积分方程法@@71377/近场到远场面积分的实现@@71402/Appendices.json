{"hands_on_practices": [{"introduction": "这项首个练习是一项奠基石般的实践。你将从第一性原理出发，实现一个完整的近场到远场变换，用以数值验证基本的电磁互易定理。这项实践将巩固你对整个过程的理解——从计算近场到通过积分获得远场，并为更高级的应用构建一个基础代码库 [@problem_id:3317922]。", "problem": "您需要基于电磁学第一性原理实现一个完整算法，通过一个由封闭表面上的切向场构建的近场到远场表面积分来验证电磁互易性。其目标是仅使用在惠更斯面上测得的场来计算两个微分天线之间的复传输量，然后验证在发射机和接收机角色互换时，传输函数在由离散化引起的指定容差范围内是对称的。\n\n从自由空间中的基本时谐麦克斯韦方程组出发，其中角频率为 $\\omega$、波数为 $k$、介电常数为 $\\varepsilon_0$、磁导率为 $\\mu_0$、本征阻抗为 $\\eta_0$。利用封闭表面上的电磁等效原理，通过由表面上的切向近场构建的等效电表面电流和磁表面电流来表示辐射场。将每个天线建模为表面内具有指定电偶极矩矢量 $\\mathbf{p}$ 的微分电偶极子。推导点电偶极子源在整个近区都有效的近场表达式，然后通过基于这些等效电流的近场到远场变换，将任意观测方向上的远场表示为仅与表面相关的量。使用这些推导出的表达式来数值计算传输函数并测试对称性。\n\n场景规范：\n- 介质：自由空间，介电常数 $\\varepsilon_0$（单位 $\\mathrm{F/m}$），磁导率 $\\mu_0$（单位 $\\mathrm{H/m}$），波数 $k = \\omega \\sqrt{\\mu_0 \\varepsilon_0}$（单位 $\\mathrm{rad/m}$），本征阻抗 $\\eta_0 = \\sqrt{\\mu_0 / \\varepsilon_0}$（单位 $\\Omega$）。\n- 源模型：位于原点的微分电偶极子，电偶极矩矢量为 $\\mathbf{p}$（单位 $\\mathrm{C \\cdot m}$），时间依赖性为 $\\mathrm{e}^{j \\omega t}$。\n- 测量表面 $S$：以原点为中心、边长为 $L$ 的立方体，每个面被离散化为 $N \\times N$ 个面元。对于每个面元，使用其中心位置 $\\mathbf{r}'$、单位法向矢量 $\\hat{\\mathbf{n}}(\\mathbf{r}')$ 和面积 $\\Delta S$。\n- $S$ 上的等效电流：使用 $S$ 上的切向电场 $\\mathbf{E}(\\mathbf{r}')$ 和磁场 $\\mathbf{H}(\\mathbf{r}')$ 构建。\n- 远场评估：在沿单位方向 $\\hat{\\mathbf{k}}$、距离为 $R$ 的一点，通过在 $S$ 上对等效电流的适当组合进行积分，计算辐射的远区电场 $\\mathbf{E}_\\infty(\\hat{\\mathbf{k}};R)$。\n- 传输量：对于一个单位方向矢量为 $\\hat{\\mathbf{u}}_{\\mathrm{rx}}$ 的接收微分偶极子，当天线 $\\mathrm{A}$ 发射、$\\mathrm{B}$ 接收时，定义一个与感应电压成正比的复标量为 $S_{21} = \\hat{\\mathbf{u}}_{\\mathrm{rx}} \\cdot \\mathbf{E}_\\infty(\\hat{\\mathbf{k}};R)$。当角色互换时，类似地定义 $S_{12}$。您必须检查 $|S_{21} - S_{12}| \\le \\delta$，其中 $\\delta$ 是一个指定的非负容差。\n\n算法要求：\n1. 推导由位于原点、力矩为 $\\mathbf{p}$ 的点电偶极子在表面 $S$ 上产生的精确近场 $\\mathbf{E}(\\mathbf{r}')$ 和 $\\mathbf{H}(\\mathbf{r}')$。\n2. 根据这些表面场，利用 $S$ 上的等效原理构建等效电表面电流和磁表面电流。\n3. 推导一个基于这些等效电流的近场到远场表面积分，该积分可得到观测方向 $\\hat{\\mathbf{k}}$ 和距离 $R$ 处的远区电场 $\\mathbf{E}_\\infty(\\hat{\\mathbf{k}};R)$。\n4. 在离散化的立方体 $S$ 上数值实现该表面积分。\n5. 对指定的天线方向和观测方向，计算复传输标量 $S_{21}$ 和 $S_{12}$，并在给定容差 $\\delta$ 内验证对称性条件。\n\n单位：\n- 距离必须以米表示。\n- 频率必须以赫兹表示。\n- 传输量 $S_{21}$ 和 $S_{12}$ 以及它们的绝对差值必须分别视为无量纲的复数量和实数量。\n\n测试套件：\n对于每个测试，发射机是一个位于原点的微分电偶极子，被同一个立方体表面 $S$ 包围。接收机放置在远区，位于指定单位方向上，距离为 $R$。当角色互换时，重复该过程，发射机仍在原点，但接收机放置在相反方向，以保持对称的自由空间路径长度。使用以下参数的测试用例：\n\n- 测试 1 (正常路径):\n  - 立方体边长 $L = 1.0$ 米。\n  - 离散化 $N = 24$ (每个面维度上的面元数)。\n  - 频率 $f = 300 \\times 10^6$ 赫兹。\n  - 距离 $R = 20.0$ 米。\n  - 发射机方向 $\\hat{\\mathbf{u}}_{\\mathrm{A}} = [0, 1, 0]$。\n  - 接收机方向 $\\hat{\\mathbf{u}}_{\\mathrm{B}} = [1, 0, 0]$。\n  - 接收机方向 $\\hat{\\mathbf{k}}_{\\mathrm{B}} = [1, 0, 0]$；交换后的接收机方向 $\\hat{\\mathbf{k}}_{\\mathrm{A}} = [-1, 0, 0]$。\n  - 容差 $\\delta = 1 \\times 10^{-3}$。\n\n- 测试 2 (更粗糙的离散化，更宽松的容差):\n  - $L = 1.0$ 米, $N = 8$, $f = 300 \\times 10^6$ 赫兹, $R = 20.0$ 米。\n  - $\\hat{\\mathbf{u}}_{\\mathrm{A}} = [0, 1, 0]$, $\\hat{\\mathbf{u}}_{\\mathrm{B}} = [1, 0, 0]$。\n  - $\\hat{\\mathbf{k}}_{\\mathrm{B}} = [1, 0, 0]$, $\\hat{\\mathbf{k}}_{\\mathrm{A}} = [-1, 0, 0]$。\n  - $\\delta = 1 \\times 10^{-2}$。\n\n- 测试 3 (轴向零点边界情况):\n  - $L = 1.0$ 米, $N = 12$, $f = 300 \\times 10^6$ 赫兹, $R = 20.0$ 米。\n  - $\\hat{\\mathbf{u}}_{\\mathrm{A}} = [0, 0, 1]$, $\\hat{\\mathbf{u}}_{\\mathrm{B}} = [0, 0, 1]$。\n  - $\\hat{\\mathbf{k}}_{\\mathrm{B}} = [0, 0, 1]$, $\\hat{\\mathbf{k}}_{\\mathrm{A}} = [0, 0, -1]$。\n  - $\\delta = 2 \\times 10^{-3}$。\n\n程序输出规范：\n您的程序必须生成单行输出，其中包含一个逗号分隔的 Python 布尔值列表，按所列顺序对应于三个测试。如果该测试的对称性条件 $|S_{21} - S_{12}| \\le \\delta$ 得到满足，则相应的布尔值为 $\\mathrm{True}$，否则为 $\\mathrm{False}$。例如，输出格式必须与 $\\left[\\mathrm{True},\\mathrm{False},\\mathrm{True}\\right]$ 完全一样。", "solution": "用户问题是计算电磁学中一个有效且适定的任务。它要求实现一个数值算法来验证电磁互易性原理。解决方案将首先从第一性原理推导必要的理论表达式，然后详细说明其实现的数值算法。\n\n### 1. 理论基础\n\n分析基于自由空间中的时谐麦克斯韦方程组，并假设时间依赖性为 $e^{j \\omega t}$。介质由介电常数 $\\varepsilon_0$、磁导率 $\\mu_0$、角频率 $\\omega$、波数 $k = \\omega / c = \\omega\\sqrt{\\mu_0\\varepsilon_0}$ 和本征阻抗 $\\eta_0 = \\sqrt{\\mu_0/\\varepsilon_0}$ 来表征。\n\n#### 1.1 微分电偶极子的场\n\n位于原点、偶极矩矢量为 $\\mathbf{p}$ 的微分电偶极子在整个空间中产生电场和磁场。在位置矢量 $\\mathbf{r}$ (其中 $r=|\\mathbf{r}|$ 且 $\\hat{\\mathbf{r}}=\\mathbf{r}/r$) 处，这些场的精确表达式为：\n\n电场 $\\mathbf{E}(\\mathbf{r})$ 为：\n$$\n\\mathbf{E}(\\mathbf{r}; \\mathbf{p}) = \\frac{e^{-jkr}}{4\\pi\\varepsilon_0} \\left\\{ k^2 \\frac{(\\hat{\\mathbf{r}} \\times \\mathbf{p}) \\times \\hat{\\mathbf{r}}}{r} + \\left(\\frac{1}{r^3} + \\frac{jk}{r^2}\\right) \\left(3\\hat{\\mathbf{r}}(\\hat{\\mathbf{r}}\\cdot\\mathbf{p}) - \\mathbf{p}\\right) \\right\\}\n$$\n磁场 $\\mathbf{H}(\\mathbf{r})$ 为：\n$$\n\\mathbf{H}(\\mathbf{r}; \\mathbf{p}) = \\frac{j\\omega}{4\\pi} \\left(jk + \\frac{1}{r}\\right) \\frac{e^{-jkr}}{r} (\\mathbf{p} \\times \\hat{\\mathbf{r}})\n$$\n这些公式在近场和远场区域均有效，并将用于确定惠更斯面上的切向场。为了数值计算的目的，偶极矩的量值取为单位1，即 $\\mathbf{p} = \\hat{\\mathbf{u}}$，其中 $\\hat{\\mathbf{u}}$ 是指定的方向矢量。\n\n#### 1.2 电磁等效原理\n\n电磁等效原理（惠更斯原理的一种形式）允许通过将封闭表面 $S$ 内的源替换为 $S$ 上的一组等效电表面电流和磁表面电流，来计算该源所辐射的场。这些电流根据表面上场的切向分量来定义。对于 $S$ 上一点 $\\mathbf{r}'$ 处向外的单位法向矢量 $\\hat{\\mathbf{n}}(\\mathbf{r}')$，等效电流定义为：\n\n等效电表面电流：\n$$\n\\mathbf{J}_s(\\mathbf{r}') = \\hat{\\mathbf{n}}(\\mathbf{r}') \\times \\mathbf{H}(\\mathbf{r}')\n$$\n等效磁表面电流：\n$$\n\\mathbf{M}_s(\\mathbf{r}') = -\\hat{\\mathbf{n}}(\\mathbf{r}') \\times \\mathbf{E}(\\mathbf{r}')\n$$\n这些电流在自由空间中辐射，它们在 $S$ 外部的任何地方都能复现原始源的场。\n\n#### 1.3 近场到远场变换 (NTFF)\n\n由这些表面电流产生的远区电场可以通过表面积分来计算。远场近似简化了积分公式中的格林函数。我们首先为给定的远场观测方向 $\\hat{\\mathbf{k}}$ 定义辐射矢量 $\\mathbf{N}(\\hat{\\mathbf{k}})$ 和 $\\mathbf{L}(\\hat{\\mathbf{k}})$：\n$$\n\\mathbf{N}(\\hat{\\mathbf{k}}) = \\iint_S \\mathbf{J}_s(\\mathbf{r}') e^{jk\\hat{\\mathbf{k}}\\cdot\\mathbf{r}'} dS'\n$$\n$$\n\\mathbf{L}(\\hat{\\mathbf{k}}) = \\iint_S \\mathbf{M}_s(\\mathbf{r}') e^{jk\\hat{\\mathbf{k}}\\cdot\\mathbf{r}'} dS'\n$$\n在方向 $\\hat{\\mathbf{k}}$ 上、距离为 $R$ 的远区电场 $\\mathbf{E}_\\infty$ 随后由下式给出：\n$$\n\\mathbf{E}_\\infty(R\\hat{\\mathbf{k}}) \\approx \\frac{-jk e^{-jkR}}{4\\pi R} \\left[ \\eta_0 \\left(\\mathbf{N}(\\hat{\\mathbf{k}}) - \\left(\\mathbf{N}(\\hat{\\mathbf{k}}) \\cdot \\hat{\\mathbf{k}}\\right)\\hat{\\mathbf{k}}\\right) + \\left(\\mathbf{L}(\\hat{\\mathbf{k}}) \\times \\hat{\\mathbf{k}}\\right) \\right]\n$$\n项 $\\mathbf{N} - (\\mathbf{N} \\cdot \\hat{\\mathbf{k}})\\hat{\\mathbf{k}}$ 代表 $\\mathbf{N}$ 垂直于传播方向 $\\hat{\\mathbf{k}}$ 的分量。叉积 $\\mathbf{L} \\times \\hat{\\mathbf{k}}$ 本身也是横向的。\n\n### 2. 互易性验证\n\n将洛伦兹互易定理应用于两组源 $(\\mathbf{J}_1, \\mathbf{M}_1)$ 和 $(\\mathbf{J}_2, \\mathbf{M}_2)$，可以得到它们所产生的场之间的关系。对于位于 $\\mathbf{r}_1$ 的微分电偶极子 $\\mathbf{p}_1$ 和位于 $\\mathbf{r}_2$ 的微分电偶极子 $\\mathbf{p}_2$，该定理意味着 $\\mathbf{p}_1 \\cdot \\mathbf{E}_2(\\mathbf{r}_1) = \\mathbf{p}_2 \\cdot \\mathbf{E}_1(\\mathbf{r}_2)$。\n\n在此问题中，互易性的具体测试定义如下：\n1.  **对于 $S_{21}$**：一个力矩为 $\\mathbf{p}_A$ 的发射机（A）位于原点。在方向 $\\hat{\\mathbf{k}}_B$ 处测量远场 $\\mathbf{E}_{\\infty, A}$。传输量是该场在接收机（B）方向 $\\hat{\\mathbf{u}}_B$ 上的投影：$S_{21} = \\hat{\\mathbf{u}}_B \\cdot \\mathbf{E}_{\\infty, A}(R\\hat{\\mathbf{k}}_B; \\mathbf{p}_A)$。\n\n2.  **对于 $S_{12}$**：角色互换。力矩为 $\\mathbf{p}_B$ 的发射机（B）现在位于原点。接收机（A）位于远场的相反方向，即 $\\hat{\\mathbf{k}}_A = -\\hat{\\mathbf{k}}_B$。传输量为 $S_{12} = \\hat{\\mathbf{u}}_A \\cdot \\mathbf{E}_{\\infty, B}(R\\hat{\\mathbf{k}}_A; \\mathbf{p}_B)$。\n\n解析上，位于原点的偶极子 $\\mathbf{p}$ 的远场为 $\\mathbf{E}_\\infty \\propto (\\hat{\\mathbf{k}} \\times \\mathbf{p}) \\times \\hat{\\mathbf{k}}$。\n$S_{21}$ 正比于 $\\hat{\\mathbf{u}}_B \\cdot ((\\hat{\\mathbf{k}}_B \\times \\mathbf{p}_A) \\times \\hat{\\mathbf{k}}_B) = (\\mathbf{p}_A \\cdot \\hat{\\mathbf{u}}_B) - (\\mathbf{p}_A \\cdot \\hat{\\mathbf{k}}_B)(\\hat{\\mathbf{u}}_B \\cdot \\hat{\\mathbf{k}}_B)$。\n$S_{12}$ 正比于 $\\hat{\\mathbf{u}}_A \\cdot ((\\hat{\\mathbf{k}}_A \\times \\mathbf{p}_B) \\times \\hat{\\mathbf{k}}_A)$。代入 $\\hat{\\mathbf{k}}_A = -\\hat{\\mathbf{k}}_B$，这变为 $\\hat{\\mathbf{u}}_A \\cdot ((\\hat{\\mathbf{k}}_B \\times \\mathbf{p}_B) \\times \\hat{\\mathbf{k}}_B) = (\\mathbf{p}_B \\cdot \\hat{\\mathbf{u}}_A) - (\\mathbf{p}_B \\cdot \\hat{\\mathbf{k}}_B)(\\hat{\\mathbf{u}}_A \\cdot \\hat{\\mathbf{k}}_B)$。\n当 $\\mathbf{p}_A = \\hat{\\mathbf{u}}_A$ 且 $\\mathbf{p}_B = \\hat{\\mathbf{u}}_B$ 时，这两个表达式是相同的，从而解析地证实了 $S_{21}=S_{12}$。数值计算会引入误差，目标是验证这些误差很小，且对称性在容差 $\\delta$ 内成立。\n\n### 3. 数值算法\n\n辐射矢量 $\\mathbf{N}$ 和 $\\mathbf{L}$ 的表面积分通过在离散化表面上的求和来近似。\n\n1.  **表面离散化**：边长为 $L$ 的立方体惠更斯面被划分为6个面。每个面被离散化为一个 $N \\times N$ 的方形面元网格。对于每个面元 $i$，计算其中心位置 $\\mathbf{r}'_i$、向外的单位法向矢量 $\\hat{\\mathbf{n}}_i$ 和面积 $\\Delta S = (L/N)^2$。\n\n2.  **通过求和进行积分**：$\\mathbf{N}$ 和 $\\mathbf{L}$ 的积分通过黎曼和计算：\n    $$\n    \\mathbf{N}(\\hat{\\mathbf{k}}) \\approx \\sum_{i=1}^{6N^2} \\mathbf{J}_s(\\mathbf{r}'_i) e^{jk\\hat{\\mathbf{k}}\\cdot\\mathbf{r}'_i} \\Delta S\n    $$\n    $$\n    \\mathbf{L}(\\hat{\\mathbf{k}}) \\approx \\sum_{i=1}^{6N^2} \\mathbf{M}_s(\\mathbf{r}'_i) e^{jk\\hat{\\mathbf{k}}\\cdot\\mathbf{r}'_i} \\Delta S\n    $$\n\n3.  **计算步骤**：对于每个测试用例，算法按以下步骤进行：\n    a. 根据给定的频率 $f$ 计算物理常数：$\\omega=2\\pi f$, $k=\\omega/c$。\n    b. 生成立方体表面的面元网格。\n    c. **计算 $S_{21}$**：\n        i. 设置 $\\mathbf{p} = \\hat{\\mathbf{u}}_A$。\n        ii. 通过对所有面元求和来数值计算 $\\mathbf{N}_A(\\hat{\\mathbf{k}}_B)$ 和 $\\mathbf{L}_A(\\hat{\\mathbf{k}}_B)$。对每个面元，这涉及到评估 $\\mathbf{E}(\\mathbf{r}'_i; \\mathbf{p})$ 和 $\\mathbf{H}(\\mathbf{r}'_i; \\mathbf{p})$ 以找到等效电流。\n        iii. 使用 NTFF 公式，借助 $\\mathbf{N}_A$、$\\mathbf{L}_A$ 和 $\\hat{\\mathbf{k}}_B$ 计算 $\\mathbf{E}_{\\infty, A}$。\n        iv. 计算 $S_{21} = \\hat{\\mathbf{u}}_B \\cdot \\mathbf{E}_{\\infty, A}$。\n    d. **计算 $S_{12}$**：\n        i. 设置 $\\mathbf{p} = \\hat{\\mathbf{u}}_B$。\n        ii. 使用远场方向 $\\hat{\\mathbf{k}}_A$，通过对所有面元求和来数值计算 $\\mathbf{N}_B(\\hat{\\mathbf{k}}_A)$ 和 $\\mathbf{L}_B(\\hat{\\mathbf{k}}_A)$。\n        iii. 使用 NTFF 公式，借助 $\\mathbf{N}_B$、$\\mathbf{L}_B$ 和 $\\hat{\\mathbf{k}}_A$ 计算 $\\mathbf{E}_{\\infty, B}$。\n        iv. 计算 $S_{12} = \\hat{\\mathbf{u}}_A \\cdot \\mathbf{E}_{\\infty, B}$。\n    e. **验证**：检查条件 $|S_{21} - S_{12}| \\le \\delta$ 是否满足。结果是一个布尔值。\n\n此过程对问题陈述中指定的所有测试用例重复执行。测试用例均为解析零点这一事实，为数值方法保持底层物理对称性的能力提供了一个严格的测试，因为任何计算出的非零场都是由数值近似误差引起的。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import constants\n\ndef solve():\n    \"\"\"\n    Main solver function that iterates through test cases and prints the results.\n    \"\"\"\n    # Physical constants\n    c0 = constants.c\n    eps0 = constants.epsilon_0\n    mu0 = constants.mu_0\n    eta0 = np.sqrt(mu0 / eps0)\n    \n    # Test cases from the problem statement\n    test_cases = [\n        {\n            \"L\": 1.0, \"N\": 24, \"f\": 300e6, \"R\": 20.0,\n            \"u_A\": np.array([0, 1, 0]), \"u_B\": np.array([1, 0, 0]),\n            \"k_B\": np.array([1, 0, 0]), \"k_A\": np.array([-1, 0, 0]),\n            \"delta\": 1e-3\n        },\n        {\n            \"L\": 1.0, \"N\": 8, \"f\": 300e6, \"R\": 20.0,\n            \"u_A\": np.array([0, 1, 0]), \"u_B\": np.array([1, 0, 0]),\n            \"k_B\": np.array([1, 0, 0]), \"k_A\": np.array([-1, 0, 0]),\n            \"delta\": 1e-2\n        },\n        {\n            \"L\": 1.0, \"N\": 12, \"f\": 300e6, \"R\": 20.0,\n            \"u_A\": np.array([0, 0, 1]), \"u_B\": np.array([0, 0, 1]),\n            \"k_B\": np.array([0, 0, 1]), \"k_A\": np.array([0, 0, -1]),\n            \"delta\": 2e-3\n        }\n    ]\n\n    results = []\n    for params in test_cases:\n        # Unpack parameters\n        L, N, f, R = params[\"L\"], params[\"N\"], params[\"f\"], params[\"R\"]\n        u_A, u_B = params[\"u_A\"], params[\"u_B\"]\n        k_B, k_A = params[\"k_B\"], params[\"k_A\"]\n        delta = params[\"delta\"]\n\n        # Derived parameters\n        omega = 2 * np.pi * f\n        k = omega / c0\n        \n        # Generate the surface mesh\n        patches = generate_cube_surface(L, N)\n        \n        # Calculate S21 and S12\n        s21 = calculate_transfer_quantity(u_A, u_B, k_B, patches, k, omega, R, eps0, eta0)\n        s12 = calculate_transfer_quantity(u_B, u_A, k_A, patches, k, omega, R, eps0, eta0)\n        \n        # Verify reciprocity\n        is_symmetric = np.abs(s21 - s12) = delta\n        results.append(is_symmetric)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\n\ndef generate_cube_surface(L, N):\n    \"\"\"\n    Generates a list of patches for a cube surface centered at the origin.\n    Each patch is represented by its center, normal vector, and area.\n    \"\"\"\n    patches = []\n    dL = L / N\n    dS = dL * dL\n    \n    # Grid for one face\n    grid_coords = np.linspace(-L/2 + dL/2, L/2 - dL/2, N)\n    \n    # +/- X faces\n    for i in range(N):\n        for j in range(N):\n            # +X face\n            patches.append((np.array([L/2, grid_coords[i], grid_coords[j]]), np.array([1, 0, 0]), dS))\n            # -X face\n            patches.append((np.array([-L/2, grid_coords[i], grid_coords[j]]), np.array([-1, 0, 0]), dS))\n    \n    # +/- Y faces\n    for i in range(N):\n        for j in range(N):\n            # +Y face\n            patches.append((np.array([grid_coords[i], L/2, grid_coords[j]]), np.array([0, 1, 0]), dS))\n            # -Y face\n            patches.append((np.array([grid_coords[i], -L/2, grid_coords[j]]), np.array([0, -1, 0]), dS))\n    \n    # +/- Z faces\n    for i in range(N):\n        for j in range(N):\n            # +Z face\n            patches.append((np.array([grid_coords[i], grid_coords[j], L/2]), np.array([0, 0, 1]), dS))\n            # -Z face\n            patches.append((np.array([grid_coords[i], grid_coords[j], -L/2]), np.array([0, 0, -1]), dS))\n            \n    return patches\n\n\ndef get_dipole_fields(r_prime, p, k, omega, eps0):\n    \"\"\"\n    Calculates the E and H fields from an infinitesimal dipole at the origin.\n    Args:\n        r_prime (np.ndarray): Position vector of the observation point.\n        p (np.ndarray): Dipole moment vector.\n        k (float): Wavenumber.\n        omega (float): Angular frequency.\n        eps0 (float): Vacuum permittivity.\n    Returns:\n        (E_field, H_field) tuple of np.ndarray.\n    \"\"\"\n    r_norm = np.linalg.norm(r_prime)\n    if r_norm == 0:\n        # Avoid singularity at the origin, though not expected for surface points\n        return (np.zeros(3, dtype=complex), np.zeros(3, dtype=complex))\n    \n    r_hat = r_prime / r_norm\n    \n    # Common phase factor\n    exp_term = np.exp(-1j * k * r_norm)\n\n    # E-field calculation\n    r_hat_dot_p = np.dot(r_hat, p)\n    term1_E = k**2 * np.cross(np.cross(r_hat, p), r_hat) / r_norm\n    term2_E = (1 / r_norm**3 + 1j * k / r_norm**2) * (3 * r_hat * r_hat_dot_p - p)\n    E_field = (exp_term / (4 * np.pi * eps0)) * (term1_E + term2_E)\n    \n    # H-field calculation\n    p_cross_r_hat = np.cross(p, r_hat)\n    term1_H = (1j * k + 1 / r_norm) * (exp_term / r_norm) * p_cross_r_hat\n    H_field = (1j * omega / (4 * np.pi)) * term1_H\n    \n    return E_field, H_field\n\ndef calculate_transfer_quantity(p_tx, u_rx, k_hat_rx, patches, k, omega, R, eps0, eta0):\n    \"\"\"\n    Calculates a single transfer quantity S_ij using the NFFT algorithm.\n    Args:\n        p_tx (np.ndarray): Transmitter dipole orientation vector.\n        u_rx (np.ndarray): Receiver dipole orientation vector.\n        k_hat_rx (np.ndarray): Receiver far-field direction vector.\n        patches (list): List of surface patches.\n        k, omega, R, eps0, eta0: Physical parameters.\n    Returns:\n        Complex scalar transfer quantity S_ij.\n    \"\"\"\n    # Dipole moment p0 is assumed to be 1 C.m\n    p_vec = p_tx.astype(float)\n    \n    N_rad = np.zeros(3, dtype=complex)\n    L_rad = np.zeros(3, dtype=complex)\n    \n    for r_prime, n_hat, dS in patches:\n        # Calculate near fields on the patch\n        E_near, H_near = get_dipole_fields(r_prime, p_vec, k, omega, eps0)\n\n        # Calculate equivalent currents\n        Js = np.cross(n_hat, H_near)\n        Ms = -np.cross(n_hat, E_near)\n        \n        # Phase term for NFFT integral\n        phase_term = np.exp(1j * k * np.dot(k_hat_rx, r_prime))\n        \n        # Accumulate radiation vectors (numerical integration)\n        N_rad += Js * phase_term * dS\n        L_rad += Ms * phase_term * dS\n        \n    # Calculate far-field vector F\n    N_transverse = N_rad - np.dot(N_rad, k_hat_rx) * k_hat_rx\n    L_cross_k = np.cross(L_rad, k_hat_rx)\n    F_vector = eta0 * N_transverse + L_cross_k\n    \n    # Calculate full far-field E_infinity\n    prefactor = (-1j * k * np.exp(-1j * k * R)) / (4 * np.pi * R)\n    E_inf = prefactor * F_vector\n    \n    # Compute transfer quantity\n    S = np.dot(u_rx, E_inf)\n    \n    return S\n\nif __name__ == '__main__':\n    solve()\n```", "id": "3317922"}, {"introduction": "在基础转换之上，本实践将解决一个在实际测量和仿真中常见的挑战：合并来自多个不相交表面的数据。你将研究相位失准如何导致相消干涉，并开发一个校准程序来纠正这些误差。这项练习对于理解相控阵和分布式孔径系统的实际问题至关重要 [@problem_id:3317903]。", "problem": "考虑一个在计算电磁学中基于电磁等效原理的频域近远场变换。两个不相交的惠更斯面捕获了已知参考平面波的切向电场和磁场。由于测量链路中的相位失校，其中一个表面上的场的复相位出现偏移，导致由这两个表面计算出的聚合远场在某些方向上表现出相消干涉。您的任务是实现一个计算实验来演示此效应，然后构建一个校准程序，利用已知的参考平面波来估计并校正相位偏移，从而在远场中恢复两个表面的相长组合。\n\n从线性、均匀、各向同性、无源介质中的基本宏观麦克斯韦方程组以及电磁等效原理出发。使用在具有外向单位法向量的封闭表面上的等效面电流的标准定义来表示表面外部的场。在这些基础上，推导出一个在辐射区内有效、可数值实现的频域近远场表面积分表示。您必须应用此表示来计算沿 $z$ 轴正向传播的观测方向上的远场电场。不要假定任何预先推导的辐射积分公式；相反，应从第一性原理构建表示。\n\n建立以下实验：\n- 使用一个角频率为 $\\omega$ 的时谐平面波，在自由空间中沿 $+\\hat{\\mathbf{z}}$ 方向传播。该波的切向电场沿 $\\hat{\\mathbf{x}}$ 方向极化，复振幅为 $E_{0}$，相应的磁场沿 $\\hat{\\mathbf{y}}$ 方向，振幅为 $H_{0} = E_{0}/\\eta_{0}$，其中 $\\eta_{0}$ 是自由空间波阻抗。\n- 构建两个不相交的平面方形惠更斯面 $S_{1}$ 和 $S_{2}$，位于 $z=0$ 平面内，外向单位法向量为 $\\hat{\\mathbf{n}}=\\hat{\\mathbf{z}}$，边长分别为 $L_{1}$ 和 $L_{2}$，在 $x$-$y$ 平面内的位置不重叠。只要表面不重叠且位于 $z=0$ 平面内，其位置可以是任意的。\n- 假定在 $S_{1}$ 上测得的复切向场与参考平面波相匹配。在 $S_{2}$ 上测得的复切向场具有一个未知的恒定相位偏移 $\\Delta\\phi$（切向电场和磁场的相位偏移相同），用以模拟采集链路中的失校。\n\n实现以下内容：\n1. 一个数值近远场表面积分，用于计算方向 $\\hat{\\mathbf{r}}=\\hat{\\mathbf{z}}$ 上的远场电场矢量，该积分使用由 $S_{1}$ 和 $S_{2}$ 上测得的切向场形成的等效面电流，并假定为自由空间。您的实现必须基于上述基本定律和定义，不得依赖任何预先提供的简化公式。将每个表面均匀离散为 $N\\times N$ 个样本，并用黎曼和近似表面积分。使用弧度作为角度单位。如果需要任何物理参数，请以一致的国际单位制明确赋值。\n2. 一个校准程序，在给定已知参考平面波的极化和传播方向的情况下，仅使用两个表面上测得的复切向场来估计 $S_{2}$ 和 $S_{1}$ 之间的相对相位偏移 $\\Delta\\phi$，然后应用一个校正因子来对齐相位，以使两个表面在远场中实现相长组合。\n\n归一化和输出：\n- 计算校准前和校准后在 $\\hat{\\mathbf{z}}$ 方向上的远场电场幅值。\n- 将两个幅值都用单独的 $S_{1}$ 在完美校准并被相同平面波照射时所产生的远场幅值进行归一化。此归一化使输出成为无量纲值。\n- 将最终输出表示为无量纲浮点数。\n- 您的程序必须生成单行输出，其中包含一个用方括号括起来的、针对规定测试套件的结果的逗号分隔列表，其中每个测试用例结果本身是按 $[$before\\_calibration, after\\_calibration$]$ 顺序排列的两个浮点数的列表。\n\n使用以下物理常数和参数：\n- 真空中的光速 $c = 299{,}792{,}458\\ \\text{m/s}$。\n- 自由空间波阻抗 $\\eta_{0} \\approx 376.730313\\ \\Omega$。\n- 频率 $f = 3\\times 10^{9}\\ \\text{Hz}$ 和波数 $k = 2\\pi f / c$（必须计算并一致地使用 $k$ 的值）。\n- 平面波电场振幅 $E_{0} = 1.0\\ \\text{V/m}$。\n- 角度单位必须是弧度。\n- 离散化必须在每个表面的每条边上使用 $N=64$ 个样本。\n\n测试套件：\n- 情况 1（因失校导致的相消干涉）：$L_{1} = 0.5\\ \\text{m}$，$L_{2} = 0.5\\ \\text{m}$，$\\Delta\\phi = \\pi\\ \\text{rad}$。\n- 情况 2（无失校）：$L_{1} = 0.5\\ \\text{m}$，$L_{2} = 0.5\\ \\text{m}$，$\\Delta\\phi = 0\\ \\text{rad}$。\n- 情况 3（面积不等，部分抵消）：$L_{1} = 0.6\\ \\text{m}$，$L_{2} = 0.3\\ \\text{m}$，$\\Delta\\phi = \\pi\\ \\text{rad}$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，格式应完全如下：\n$[[$before_{1}$,$after_{1}$],[$before_{2}$,$after_{2}$],[$before_{3}$,$after_{3}$]]$，\n其中每个 $before_{i}$ 和 $after_{i}$ 是一个浮点数，分别表示测试用例 $i$ 在校准前和校准后的归一化远场幅值。", "solution": "解决此问题需要从基本电磁理论出发，对近远场变换积分进行原理性推导，然后将其应用于两个平面孔径的特定场景。\n\n### 1. 远场辐射积分的基本推导\n\n我们从线性、均匀、各向同性、无源介质中的时谐麦克斯韦方程组开始，假定时间依赖关系为 $e^{j\\omega t}$：\n$$ \\nabla \\times \\mathbf{E} = -j\\omega\\mu_0 \\mathbf{H} $$\n$$ \\nabla \\times \\mathbf{H} = j\\omega\\epsilon_0 \\mathbf{E} $$\n其中 $\\mathbf{E}$ 和 $\\mathbf{H}$ 是复数电场和磁场相量，$\\omega$ 是角频率，$\\mu_0$ 和 $\\epsilon_0$ 分别是自由空间的磁导率和介电常数。\n\n电磁等效原理（惠更斯原理的一种形式）指出，空间无源区域 $V$ 内的场可以由包围 $V$ 的表面 $S$ 上的切向电场和磁场确定。移除（$V$ 外部的）原始源，并在 $S$ 上放置等效电面流 $\\mathbf{J}_s$ 和磁面流 $\\mathbf{M}_s$。这些电流辐射到无界介质中（在本问题中为自由空间）。等效电流定义为：\n$$ \\mathbf{J}_s(\\mathbf{r}') = \\hat{\\mathbf{n}} \\times \\mathbf{H}(\\mathbf{r}') $$\n$$ \\mathbf{M}_s(\\mathbf{r}') = -\\hat{\\mathbf{n}} \\times \\mathbf{E}(\\mathbf{r}') = \\mathbf{E}(\\mathbf{r}') \\times \\hat{\\mathbf{n}} $$\n其中 $\\mathbf{r}'$ 是表面 $S$ 上的源点，$\\hat{\\mathbf{n}}$ 是从该表面出发的外向单位法向量。对于本问题，表面 $S_1$ 和 $S_2$ 位于 $z=0$ 平面，我们关心的是 $z0$ 区域的场。因此，“外向”法向量为 $\\hat{\\mathbf{n}} = \\hat{\\mathbf{z}}$。\n\n这些面电流辐射的场可以通过磁矢量位 $\\mathbf{A}$ 和电矢量位 $\\mathbf{F}$ 计算得出：\n$$ \\mathbf{A}(\\mathbf{r}) = \\mu_0 \\iint_S \\mathbf{J}_s(\\mathbf{r}') \\frac{e^{-jkR}}{4\\pi R} dS' $$\n$$ \\mathbf{F}(\\mathbf{r}) = \\epsilon_0 \\iint_S \\mathbf{M}_s(\\mathbf{r}') \\frac{e^{-jkR}}{4\\pi R} dS' $$\n此处，$\\mathbf{r}$ 是观测点， $k=\\omega/c$ 是自由空间波数，其中 $c=1/\\sqrt{\\mu_0\\epsilon_0}$，而 $R = |\\mathbf{r} - \\mathbf{r}'|$ 是从源点 $\\mathbf{r}'$ 到观测点 $\\mathbf{r}$ 的距离。\n\n在远场（辐射）区，观测距离 $r = |\\mathbf{r}|$ 远大于源的尺寸（$r \\gg |\\mathbf{r}'|$）和波长（$r \\gg 2\\pi/k$），我们可以做以下近似：\n1. 对于幅度项：$R \\approx r$。\n2. 对于相位项：$R = \\sqrt{(\\mathbf{r}-\\mathbf{r}')\\cdot(\\mathbf{r}-\\mathbf{r}')} = \\sqrt{r^2 - 2\\mathbf{r}\\cdot\\mathbf{r}' + r'^2} \\approx r\\sqrt{1-2\\frac{\\hat{\\mathbf{r}}\\cdot\\mathbf{r}'}{r}} \\approx r - \\hat{\\mathbf{r}} \\cdot \\mathbf{r}'$。\n\n应用这些近似，矢量位变为：\n$$ \\mathbf{A}(\\mathbf{r}) \\approx \\mu_0 \\frac{e^{-jkr}}{4\\pi r} \\iint_S \\mathbf{J}_s(\\mathbf{r}') e^{jk\\hat{\\mathbf{r}} \\cdot \\mathbf{r}'} dS' = \\mu_0 \\frac{e^{-jkr}}{4\\pi r} \\mathbf{N}(\\hat{\\mathbf{r}}) $$\n$$ \\mathbf{F}(\\mathbf{r}) \\approx \\epsilon_0 \\frac{e^{-jkr}}{4\\pi r} \\iint_S \\mathbf{M}_s(\\mathbf{r}') e^{jk\\hat{\\mathbf{r}} \\cdot \\mathbf{r}'} dS' = \\epsilon_0 \\frac{e^{-jkr}}{4\\pi r} \\mathbf{L}(\\hat{\\mathbf{r}}) $$\n其中 $\\mathbf{L}(\\hat{\\mathbf{r}})$ 和 $\\mathbf{N}(\\hat{\\mathbf{r}})$ 是辐射矢量。\n\n远场电场垂直于传播方向 $\\hat{\\mathbf{r}}$，即 $\\mathbf{E} \\cdot \\hat{\\mathbf{r}} \\approx 0$。在球坐标系中，横向分量由下式给出：\n$$ E_\\theta(\\mathbf{r}) \\approx -jk \\frac{e^{-jkr}}{4\\pi r} [L_\\phi(\\hat{\\mathbf{r}}) + \\eta_0 N_\\theta(\\hat{\\mathbf{r}})] $$\n$$ E_\\phi(\\mathbf{r}) \\approx +jk \\frac{e^{-jkr}}{4\\pi r} [L_\\theta(\\hat{\\mathbf{r}}) - \\eta_0 N_\\phi(\\hat{\\mathbf{r}})] $$\n其中 $\\eta_0 = \\sqrt{\\mu_0/\\epsilon_0}$ 是自由空间的本征阻抗，带下标的变量表示辐射矢量在球坐标系中的分量。\n\n### 2. 在特定问题中的应用\n\n该问题指定一个平面波沿 $+\\hat{\\mathbf{z}}$ 方向传播，其 $\\mathbf{E}_{inc} = E_0 e^{-jkz} \\hat{\\mathbf{x}}$ 和 $\\mathbf{H}_{inc} = (E_0/\\eta_0) e^{-jkz} \\hat{\\mathbf{y}}$。惠更斯面位于 $z=0$ 平面。因此，这些表面上的切向场是恒定的：\n$$ \\mathbf{E}_t = E_0 \\hat{\\mathbf{x}} $$\n$$ \\mathbf{H}_t = (E_0/\\eta_0) \\hat{\\mathbf{y}} $$\n当 $\\hat{\\mathbf{n}}=\\hat{\\mathbf{z}}$ 时，等效面电流在表面上也是恒定的：\n$$ \\mathbf{J}_s = \\hat{\\mathbf{z}} \\times \\mathbf{H}_t = \\hat{\\mathbf{z}} \\times [(E_0/\\eta_0) \\hat{\\mathbf{y}}] = -(E_0/\\eta_0) \\hat{\\mathbf{x}} $$\n$$ \\mathbf{M}_s = -\\hat{\\mathbf{z}} \\times \\mathbf{E}_t = -\\hat{\\mathbf{z}} \\times [E_0 \\hat{\\mathbf{x}}] = -E_0 \\hat{\\mathbf{y}} $$\n我们需要计算方向为 $\\hat{\\mathbf{r}}=\\hat{\\mathbf{z}}$ 的远场，这在球坐标中对应于 $\\theta=0$。此时，球坐标基矢不是唯一确定的。但是，我们可以取 $\\theta \\to 0$ 的极限。我们从 $\\phi=0$ 方向（$x-z$ 平面）逼近。在此极限下，球坐标单位矢量对应笛卡尔单位矢量如下：$\\hat{\\mathbf{r}} \\to \\hat{\\mathbf{z}}$，$\\hat{\\theta} \\to \\hat{\\mathbf{x}}$，以及 $\\hat{\\phi} \\to \\hat{\\mathbf{y}}$。\n\n辐射积分中的相位项是 $e^{jk\\hat{\\mathbf{r}} \\cdot \\mathbf{r}'}$。对于 $\\hat{\\mathbf{r}}=\\hat{\\mathbf{z}}$ 和表面上的 $\\mathbf{r}' = x'\\hat{\\mathbf{x}} + y'\\hat{\\mathbf{y}}$，有 $\\hat{\\mathbf{r}} \\cdot \\mathbf{r}' = 0$。指数项变为 $e^0=1$。\n对于面积为 $A$ 的单个表面 $S$，辐射矢量为：\n$$ \\mathbf{N}(\\hat{\\mathbf{z}}) = \\iint_S \\mathbf{J}_s dS' = \\mathbf{J}_s A = -(E_0 A / \\eta_0) \\hat{\\mathbf{x}} $$\n$$ \\mathbf{L}(\\hat{\\mathbf{z}}) = \\iint_S \\mathbf{M}_s dS' = \\mathbf{M}_s A = -E_0 A \\hat{\\mathbf{y}} $$\n我们在 $\\theta \\to 0$ 极限下找到这些矢量的球坐标分量：\n$N_\\theta = \\mathbf{N} \\cdot \\hat{\\theta} \\to \\mathbf{N} \\cdot \\hat{\\mathbf{x}} = -E_0 A / \\eta_0$。\n$N_\\phi = \\mathbf{N} \\cdot \\hat{\\phi} \\to \\mathbf{N} \\cdot \\hat{\\mathbf{y}} = 0$。\n$L_\\theta = \\mathbf{L} \\cdot \\hat{\\theta} \\to \\mathbf{L} \\cdot \\hat{\\mathbf{x}} = 0$。\n$L_\\phi = \\mathbf{L} \\cdot \\hat{\\phi} \\to \\mathbf{L} \\cdot \\hat{\\mathbf{y}} = -E_0 A$。\n\n将这些代入远场方程：\n$$ E_\\theta \\approx -jk \\frac{e^{-jkr}}{4\\pi r} [L_\\phi + \\eta_0 N_\\theta] = -jk \\frac{e^{-jkr}}{4\\pi r} [-E_0 A + \\eta_0(-E_0 A / \\eta_0)] = -jk \\frac{e^{-jkr}}{4\\pi r} [-2 E_0 A] $$\n$$ E_\\theta \\approx jk \\frac{E_0 A}{2\\pi r} e^{-jkr} $$\n$$ E_\\phi \\approx +jk \\frac{e^{-jkr}}{4\\pi r} [L_\\theta - \\eta_0 N_\\phi] = 0 $$\n由于 $\\hat{\\theta} \\to \\hat{\\mathbf{x}}$，远场电场为 $\\mathbf{E}_{ff} \\approx (jk \\frac{E_0 A}{2\\pi r} e^{-jkr})\\hat{\\mathbf{x}}$。其幅值为 $|E_{ff}| = \\frac{k E_0 A}{2\\pi r}$。关键在于，远场幅值与惠更斯面的面积 $A$ 成正比。根据要求，使用 $N \\times N$ 个单元上的黎曼和进行数值实现，对于正方形可以得到精确的面积，因此 $\\sum_i \\Delta A_i = A$。\n\n### 3. 双表面系统分析与校准\n\n总远场是来自表面 $S_1$ 和 $S_2$ 的场的叠加：\n$$ \\mathbf{E}_{total} = \\mathbf{E}_1 + \\mathbf{E}_2 $$\n对于 $S_1$，面积为 $A_1 = L_1^2$，相位为标称相位。\n对于 $S_2$，面积为 $A_2 = L_2^2$，但切向场被相位偏移了 $\\Delta\\phi$。此相位偏移在计算中传播，使得等效电流以及最终的场贡献乘以 $e^{j\\Delta\\phi}$。\n设 $K = (jk \\frac{E_0}{2\\pi r} e^{-jkr})\\hat{\\mathbf{x}}$，这是一个复矢量常数。\n$$ \\mathbf{E}_1 = K A_1 $$\n$$ \\mathbf{E}_2 = K A_2 e^{j\\Delta\\phi} $$\n校准前的总场为 $\\mathbf{E}_{before} = K (A_1 + A_2 e^{j\\Delta\\phi})$。其幅值为：\n$$ |\\mathbf{E}_{before}| = |K| |A_1 + A_2 e^{j\\Delta\\phi}| $$\n归一化基于单独来自 $S_1$ 的场：$|\\mathbf{E}_{norm}| = |K| A_1$。\n校准前的归一化幅值为：\n$$ \\text{before\\_cal} = \\frac{|\\mathbf{E}_{before}|}{|\\mathbf{E}_{norm}|} = \\frac{|A_1 + A_2 e^{j\\Delta\\phi}|}{A_1} = \\frac{|L_1^2 + L_2^2 e^{j\\Delta\\phi}|}{L_1^2} $$\n校准程序必须估计 $\\Delta\\phi$。由于可以访问两个表面上的复切向场，我们可以在 $S_1$ 上的一个点采样电场 $E_{t1} = E_0$，以及在 $S_2$ 上的一个点采样电场 $E_{t2} = E_0 e^{j\\Delta\\phi}$。相位偏移就是它们辐角的差：\n$$ \\Delta\\hat{\\phi} = \\arg(E_{t2}) - \\arg(E_{t1}) $$\n利用此估计值，我们对 $S_2$ 上所有测量的场应用一个校正因子 $e^{-j\\Delta\\hat{\\phi}}$。来自 $S_2$ 的校正后贡献变为：\n$$ \\mathbf{E}_{2,corr} = K A_2 e^{j\\Delta\\phi} e^{-j\\Delta\\hat{\\phi}} = K A_2 $$\n校准后的总场变为 $\\mathbf{E}_{after} = K(A_1 + A_2)$。现在场是相长叠加的。其幅值为：\n$$ |\\mathbf{E}_{after}| = |K| (A_1 + A_2) $$\n校准后的归一化幅值为：\n$$ \\text{after\\_cal} = \\frac{|\\mathbf{E}_{after}|}{|\\mathbf{E}_{norm}|} = \\frac{A_1 + A_2}{A_1} = \\frac{L_1^2 + L_2^2}{L_1^2} $$\n这些最终表达式用于计算测试套件的结果。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the computational electromagnetics problem involving a near-to-far-field\n    transformation, phase miscalibration, and correction.\n    \"\"\"\n    \n    # Define physical constants and parameters from the problem statement.\n    # Speed of light in vacuum (m/s)\n    C0 = 299792458.0\n    # Free-space wave impedance (Ohms)\n    ETA0 = 376.730313\n    # Frequency (Hz)\n    FREQ = 3.0e9\n    # Plane-wave electric-field amplitude (V/m)\n    E0 = 1.0\n    # Discretization samples along each side of the square surfaces\n    N = 64\n    \n    # Derived parameters\n    # Angular frequency (rad/s)\n    OMEGA = 2.0 * np.pi * FREQ\n    # Wavenumber (rad/m)\n    K = OMEGA / C0\n\n    # Test suite from the problem statement.\n    # Each case is a tuple (L1, L2, delta_phi)\n    # L1, L2: side lengths of surfaces S1, S2 in meters.\n    # delta_phi: phase offset on S2 in radians.\n    test_cases = [\n        (0.5, 0.5, np.pi),   # Case 1: destructive interference\n        (0.5, 0.5, 0.0),     # Case 2: no miscalibration\n        (0.6, 0.3, np.pi)    # Case 3: unequal areas, partial cancellation\n    ]\n\n    results = []\n    \n    # Process each test case\n    for case in test_cases:\n        l1, l2, delta_phi = case\n        \n        # The derivation shows the far-field amplitude is proportional to the\n        # aperture area. The Riemann sum of dA over a constant grid is simply the area.\n        # A_i = N*N * (L_i/N)^2 = L_i^2\n        a1 = l1**2\n        a2 = l2**2\n\n        # --- Before Calibration ---\n        \n        # The far-field electric field is a superposition of contributions from\n        # S1 and S2. The complex amplitude from S2 has a phase error e^(j*delta_phi).\n        # We can analyze the coherent sum of the complex amplitudes, which are\n        # proportional to the areas.\n        # Let the complex amplitude from S1 be A1.\n        # The complex amplitude from S2 is A2 * exp(j*delta_phi).\n        \n        # Total complex amplitude before calibration\n        total_amplitude_before = a1 + a2 * np.exp(1j * delta_phi)\n        \n        # Magnitude of the total field before calibration\n        mag_before = np.abs(total_amplitude_before)\n\n        # --- Calibration Step ---\n        \n        # The calibration routine estimates the phase offset and applies a correction.\n        # 1. Simulate measuring complex tangential E-fields at one point on each surface.\n        #    On S1, the field is E0 (real).\n        #    On S2, the field is E0 * exp(j*delta_phi) due to miscalibration.\n        e_field_s1 = E0 + 0j\n        e_field_s2 = E0 * np.exp(1j * delta_phi)\n        \n        # 2. Estimate the phase offset.\n        est_delta_phi = np.angle(e_field_s2) - np.angle(e_field_s1)\n        \n        # 3. Compute the correction factor.\n        correction_factor = np.exp(-1j * est_delta_phi)\n        \n        # --- After Calibration ---\n        \n        # Apply the correction to the contribution from S2.\n        corrected_amplitude_s2 = (a2 * np.exp(1j * delta_phi)) * correction_factor\n        \n        # Total complex amplitude after calibration\n        total_amplitude_after = a1 + corrected_amplitude_s2\n        \n        # Magnitude of the total field after calibration.\n        # In ideal correction, this simplifies to a1 + a2.\n        mag_after = np.abs(total_amplitude_after)\n        \n        # --- Normalization ---\n        \n        # The normalization factor is the magnitude of the field from S1 alone,\n        # which is proportional to its area, a1.\n        normalization_factor = a1\n        \n        norm_mag_before = mag_before / normalization_factor\n        norm_mag_after = mag_after / normalization_factor\n        \n        results.append([norm_mag_before, norm_mag_after])\n\n    # Format the final output string as specified.\n    # The problem specifies float representation.\n    # Using a generic formatter that handles floats appropriately.\n    result_str = \",\".join([f\"[{b:g},{a:g}]\" for b, a in results])\n    \n    print(f\"[{result_str}]\")\n\nsolve()\n\n```", "id": "3317903"}, {"introduction": "高保真仿真要求我们密切关注数值伪影。这项高级实践旨在处理由离散化引起的误差，这些误差可能会在惠更斯曲面上引入非物理的法向场分量。你将推导并实现一个投影算子，以强制执行正确的物理边界条件，从而显著提高远场预测的准确性 [@problem_id:3317900]。", "problem": "考虑一个均匀、各向同性、无源介质中的时谐电磁场，其时间因子约定为 $e^{+i\\omega t}$，介质的介电常数为 $\\epsilon$，磁导率为 $\\mu$，波数为 $k=\\omega\\sqrt{\\mu\\epsilon}$，波阻抗为 $\\eta=\\sqrt{\\mu/\\epsilon}$。设 $\\mathcal{S}$ 是一个闭合的惠更斯面 (Huygens surface)，由一个以原点为中心、边长为 $L$ 的立方体的六个面组成。记 $\\hat{\\mathbf{n}}(\\mathbf{r})$ 为曲面 $\\mathcal{S}$ 上点 $\\mathbf{r}\\in\\mathcal{S}$ 处的外向单位法向量。近远场变换的曲面积分利用 $\\mathcal{S}$ 上的等效电、磁表面流来计算在给定观测方向 $\\hat{\\mathbf{r}}$ 上的辐射远场。\n\n从宏观麦克斯韦方程组 (Maxwell's equations) 的微分形式\n$$\\nabla\\times\\mathbf{E}= -i\\omega\\mu\\,\\mathbf{H},\\qquad \\nabla\\times\\mathbf{H}= i\\omega\\epsilon\\,\\mathbf{E},\\qquad \\nabla\\cdot\\epsilon\\mathbf{E}=0,\\qquad \\nabla\\cdot\\mu\\mathbf{H}=0,$$\n以及曲面等效原理出发，推导远区电场 $\\mathbf{E}_\\infty(\\hat{\\mathbf{r}})$ 的表达式，该表达式应通过定义在 $\\mathcal{S}$ 上的等效电、磁流的曲面积分来表示。您的推导必须明确指出由离散化引起的 $\\mathcal{S}$ 上场的法向分量的影响，并且必须论证为何对于惠更斯面上的 Love 等效公式，只有切向分量在物理上是可接受的。\n\n您需要构建近远场变换的离散实现，并评估离散化在 $\\mathcal S$ 上引入的非物理法向分量的影响。具体而言：\n\n- 推导一个投影算子 $\\mathcal{Q}(\\hat{\\mathbf{n}})$，它作用于曲面上一点的矢量场样本 $\\mathbf{v}\\in\\mathbb{R}^3$，并强制执行离散约束 $\\hat{\\mathbf{n}}\\cdot\\mathbf{E}=0$ 和 $\\hat{\\mathbf{n}}\\cdot\\mathbf{H}=0$，同时在欧几里得范数下对 $\\mathbf{v}$ 的扰动最小。请用 $\\hat{\\mathbf{n}}$ 显式表示 $\\mathcal{Q}$。\n\n- 使用曲面等效原理，将远区场 $\\mathbf{E}_\\infty(\\hat{\\mathbf{r}})$ 表示为等效表面流的泛函。然后，提供一个离散求积公式，通过对立方体每个面上均匀离散化的曲面点集上的加权和来近似连续曲面积分。该求积公式必须包含在每个曲面点上求值的相位因子 $e^{ik\\,\\hat{\\mathbf{r}}\\cdot\\mathbf{r}}$。\n\n- 实现一个测试场景，其中切向场 $\\mathbf{E}_t(\\mathbf{r})$ 和 $\\mathbf{H}_t(\\mathbf{r})=(1/\\eta)\\,\\hat{\\mathbf{n}}(\\mathbf{r})\\times \\mathbf{E}_t(\\mathbf{r})$ 通过一个平滑的、面局域化的分布在 $\\mathcal{S}$ 上合成\n$$\\mathbf{E}_t(\\mathbf{r})=\\mathbf{t}_{\\text{face}}(\\mathbf{r})\\,E_0\\,\\exp\\!\\left(-\\frac{\\|\\mathbf{u}_{\\text{face}}(\\mathbf{r})\\|^2}{\\sigma^2}\\right),$$\n其中 $\\mathbf{t}_{\\text{face}}(\\mathbf{r})$ 是该面上的单位切向方向，$\\mathbf{u}_{\\text{face}}(\\mathbf{r})$ 是从该面中心测量的面内位置矢量。利用此式，通过 $\\mathbf{M}_s(\\mathbf{r})=-\\hat{\\mathbf{n}}(\\mathbf{r})\\times\\mathbf{E}_t(\\mathbf{r})$ 和 $\\mathbf{J}_s(\\mathbf{r})=\\hat{\\mathbf{n}}(\\mathbf{r})\\times\\mathbf{H}_t(\\mathbf{r})$ 定义 $\\mathcal{S}$ 上的精确切向等效流，并通过您的离散近远场变换计算一个参考远场 $\\mathbf{E}_\\infty^{\\text{ref}}(\\hat{\\mathbf{r}})$。\n\n- 通过用法向噪声污染测量场，并使用通过将 $\\hat{\\mathbf{n}}(\\mathbf{r})$ 绕一固定轴旋转一个小角度得到的受扰动（未对准）的法向量 $\\tilde{\\mathbf{n}}(\\mathbf{r})$，来模拟离散化引起的非物理法向分量。根据受污染的测量值定义朴素电流 $\\mathbf{M}_s^{\\text{naive}}(\\mathbf{r})=-\\tilde{\\mathbf{n}}(\\mathbf{r})\\times\\mathbf{E}_{\\text{meas}}(\\mathbf{r})$ 和 $\\mathbf{J}_s^{\\text{naive}}(\\mathbf{r})=\\tilde{\\mathbf{n}}(\\mathbf{r})\\times\\mathbf{H}_{\\text{meas}}(\\mathbf{r})$。同时定义投影场 $\\mathbf{E}_{\\text{proj}}(\\mathbf{r})=\\mathcal{Q}(\\hat{\\mathbf{n}}(\\mathbf{r}))\\,\\mathbf{E}_{\\text{meas}}(\\mathbf{r})$ 和 $\\mathbf{H}_{\\text{proj}}(\\mathbf{r})=\\mathcal{Q}(\\hat{\\mathbf{n}}(\\mathbf{r}))\\,\\mathbf{H}_{\\text{meas}}(\\mathbf{r})$，并形成校正后的电流 $\\mathbf{M}_s^{\\text{proj}}(\\mathbf{r})=-\\hat{\\mathbf{n}}(\\mathbf{r})\\times\\mathbf{E}_{\\text{proj}}(\\mathbf{r})$ 和 $\\mathbf{J}_s^{\\text{proj}}(\\mathbf{r})=\\hat{\\mathbf{n}}(\\mathbf{r})\\times\\mathbf{H}_{\\text{proj}}(\\mathbf{r})$。\n\n- 对于一组由极角 $\\theta$ 和方位角 $\\phi$（单位为弧度）参数化的观测方向 $\\{\\hat{\\mathbf{r}}_m\\}$，计算朴素远场和投影远场的相对 $\\ell^2$ 误差，\n$$\\varepsilon_{\\text{naive}}=\\sqrt{\\frac{\\sum_m\\|\\mathbf{E}_\\infty^{\\text{naive}}(\\hat{\\mathbf{r}}_m)-\\mathbf{E}_\\infty^{\\text{ref}}(\\hat{\\mathbf{r}}_m)\\|_2^2}{\\sum_m\\|\\mathbf{E}_\\infty^{\\text{ref}}(\\hat{\\mathbf{r}}_m)\\|_2^2}},\\qquad \\varepsilon_{\\text{proj}}=\\sqrt{\\frac{\\sum_m\\|\\mathbf{E}_\\infty^{\\text{proj}}(\\hat{\\mathbf{r}}_m)-\\mathbf{E}_\\infty^{\\text{ref}}(\\hat{\\mathbf{r}}_m)\\|_2^2}{\\sum_m\\|\\mathbf{E}_\\infty^{\\text{ref}}(\\hat{\\mathbf{r}}_m)\\|_2^2}}.$$\n报告改善因子 $\\rho=\\varepsilon_{\\text{naive}}/\\varepsilon_{\\text{proj}}$。\n\n在数值计算中使用以下符合物理现实的常数和几何结构：立方体边长 $L=1\\,\\mathrm{m}$，光速 $c=299{,}792{,}458\\,\\mathrm{m/s}$，频率 $f=300\\,\\mathrm{MHz}$，波长 $\\lambda=c/f=1\\,\\mathrm{m}$，波数 $k=2\\pi/\\lambda=2\\pi\\,\\mathrm{rad/m}$，以及阻抗 $\\eta\\approx 376.730313668\\,\\Omega$。使用场振幅 $E_0=1\\,\\mathrm{V/m}$ 和高斯宽度 $\\sigma=L/3\\,\\mathrm{m}$。观测方向应由 $(\\theta,\\phi)$（单位为弧度）指定。法向扰动角输入必须以度为单位指定。曲面求积应在每个面上使用 $N\\times N$ 个点，置于单元中心，并采用均匀的面积权重。\n\n设计一个包含 4 种情况的测试套件，以探究不同的离散化效应：\n- 情况 1：法向扰动角 $5^\\circ$，污染幅度 $\\alpha_E=0$ 和 $\\alpha_H=0$，以及 $N=20$。\n- 情况 2：法向扰动角 $5^\\circ$，污染幅度 $\\alpha_E=0.1$ 和 $\\alpha_H=0.1$，以及 $N=20$。\n- 情况 3：法向扰动角 $15^\\circ$，污染幅度 $\\alpha_E=0.5$ 和 $\\alpha_H=0.5$，以及 $N=20$。\n- 情况 4：法向扰动角 $10^\\circ$，污染幅度 $\\alpha_E=0.2$ 和 $\\alpha_H=0.2$，以及 $N=8$。\n\n您的程序必须为这四种情况计算改善因子 $\\rho$，并使用固定的随机种子以保证可复现性，然后生成一行输出，其中包含一个用方括号括起来的逗号分隔的结果列表（例如，$[\\rho_1,\\rho_2,\\rho_3,\\rho_4]$）。输出条目必须是浮点数。观测集中的所有角度都必须是弧度。最终的数值输出中无需包含物理单位，因为报告的量是无量綱的。", "solution": "该问题要求推导并实现一个闭合立方体表面上电磁场的近远场变换，并特别关注评估和校正由离散化引起的非物理场分量所产生的误差。\n\n### 1. 理论基础：曲面等效原理与远场辐射\n\n近远场变换的基础是曲面等效原理，它是从矢量格林定理 (Green's theorem) 或 Stratton-Chu 公式推导出的惠更斯原理 (Huygens' principle) 的推广。该原理指出，无源体积 $V$ 内的电磁场 $(\\mathbf{E}, \\mathbf{H})$ 可以由放置在包围 $V$ 的闭合曲面 $\\mathcal{S}$ 上的一组等效电、磁表面流 $\\mathbf{J}_s$ 和 $\\mathbf{M}_s$ 精确再现。这些电流在与填充 $V$ 的介质相同的均匀介质中辐射。时谐约定取为 $e^{+i\\omega t}$。\n\n等效电流根据 $\\mathcal{S}$ 上场的切向分量定义：\n$$ \\mathbf{J}_s(\\mathbf{r}') = \\hat{\\mathbf{n}}(\\mathbf{r}') \\times \\mathbf{H}(\\mathbf{r}') $$\n$$ \\mathbf{M}_s(\\mathbf{r}') = -\\hat{\\mathbf{n}}(\\mathbf{r}') \\times \\mathbf{E}(\\mathbf{r}') $$\n其中 $\\mathbf{r}' \\in \\mathcal{S}$ 是曲面上的一点，$\\hat{\\mathbf{n}}(\\mathbf{r}')$ 是外向单位法向量。\n\n这些电流在整个空间中产生场。距离原点大距离 $r = \\|\\mathbf{r}\\|$ 处、方向为 $\\hat{\\mathbf{r}}=\\mathbf{r}/r$ 的远区电场 $\\mathbf{E}_\\infty$ 可以通过辐射积分的远场近似得到。关键步骤是将从源点 $\\mathbf{r}'$ 到观测点 $\\mathbf{r}$ 的距离近似为 $\\|\\mathbf{r}-\\mathbf{r}'\\| \\approx r - \\hat{\\mathbf{r}}\\cdot\\mathbf{r}'$。对于空间依赖性为 $e^{-ikr}$ 的出射波，格林函数 (Green's function) 变为 $\\frac{e^{-ik\\|\\mathbf{r}-\\mathbf{r}'\\|}}{4\\pi\\|\\mathbf{r}-\\mathbf{r}'\\|} \\approx \\frac{e^{-ikr}}{4\\pi r}e^{ik\\hat{\\mathbf{r}}\\cdot\\mathbf{r}'}$。\n\n远场可以方便地用两个辐射矢量 $\\mathbf{N}(\\hat{\\mathbf{r}})$ 和 $\\mathbf{L}(\\hat{\\mathbf{r}})$ 来表示，它们是表面电流的空间傅里叶变换：\n$$ \\mathbf{N}(\\hat{\\mathbf{r}}) = \\iint_{\\mathcal{S}} \\mathbf{J}_s(\\mathbf{r}') e^{ik\\hat{\\mathbf{r}}\\cdot\\mathbf{r}'} dS' $$\n$$ \\mathbf{L}(\\hat{\\mathbf{r}}) = \\iint_{\\mathcal{S}} \\mathbf{M}_s(\\mathbf{r}') e^{ik\\hat{\\mathbf{r}}\\cdot\\mathbf{r}'} dS' $$\n其中 $k=\\omega\\sqrt{\\mu\\epsilon}$ 是波数。\n\n远区电场横向于传播方向 $\\hat{\\mathbf{r}}$，由下式给出：\n$$ \\mathbf{E}_\\infty(\\mathbf{r}) \\approx C(r) \\left[ -\\eta \\hat{\\mathbf{r}}\\times(\\hat{\\mathbf{r}}\\times\\mathbf{N}(\\hat{\\mathbf{r}})) - \\hat{\\mathbf{r}}\\times\\mathbf{L}(\\hat{\\mathbf{r}}) \\right] $$\n其中 $C(r) = \\frac{-ik e^{-ikr}}{4\\pi r}$ 是一个表示传播和衰减的复标量，$\\eta=\\sqrt{\\mu/\\epsilon}$ 是波阻抗。由于误差度量涉及场幅值的比率，这个公共因子 $C(r)$ 将会抵消。因此，我们只关心远场的矢量部分：\n$$ \\mathbf{E}_{\\infty,\\text{vec}}(\\hat{\\mathbf{r}}) = -\\eta \\hat{\\mathbf{r}}\\times(\\hat{\\mathbf{r}}\\times\\mathbf{N}(\\hat{\\mathbf{r}})) - \\hat{\\mathbf{r}}\\times\\mathbf{L}(\\hat{\\mathbf{r}}) $$\n这个表达式正确地表明了远场是横向的，因为 $\\hat{\\mathbf{r}} \\cdot \\mathbf{E}_{\\infty,\\text{vec}}(\\hat{\\mathbf{r}}) = 0$。\n\n### 2. 场分量的作用与离散化误差\n\n等效原理中 $\\mathbf{J}_s$ 和 $\\mathbf{M}_s$ 的定义仅涉及 $\\mathcal{S}$ 上场的切向分量，因为与 $\\hat{\\mathbf{n}}$ 的叉积会消除任何法向分量。在一个无源区域内的精确物理场景中，麦克斯韦方程组 (Maxwell's equations) 要求 $\\nabla\\cdot\\mathbf{E}=0$ 和 $\\nabla\\cdot\\mathbf{H}=0$。这意味着法向场分量与切向分量的曲面散度之间存在关系，该关系由等效电荷和电流的连续性方程决定：$\\nabla_s \\cdot \\mathbf{J}_s = -i\\omega (\\epsilon \\hat{\\mathbf{n}}\\cdot\\mathbf{E})$ 和 $\\nabla_s \\cdot \\mathbf{M}_s = -i\\omega (\\mu \\hat{\\mathbf{n}}\\cdot\\mathbf{H})$。\n\n在数值模拟（例如 FDTD、FEM）中，离散化误差可能导致违反无散条件，从而在惠更斯面上产生虚假的、非物理的法向分量。这些采样场 $(\\mathbf{E}_{\\text{meas}}, \\mathbf{H}_{\\text{meas}})$ 可能存在 $\\hat{\\mathbf{n}}\\cdot\\mathbf{E}_{\\text{meas}} \\neq 0$ 和 $\\hat{\\mathbf{n}}\\cdot\\mathbf{H}_{\\text{meas}} \\neq 0$ 的情况，且其方式与切向场不一致。此外，曲面的离散表示可能导致受扰动的法向量 $\\tilde{\\mathbf{n}} \\neq \\hat{\\mathbf{n}}$。\n\n如果使用这些不完美的数据朴素地计算电流，例如 $\\mathbf{J}_s^{\\text{naive}}=\\tilde{\\mathbf{n}}\\times\\mathbf{H}_{\\text{meas}}$，则误差是双重的：\n1. 使用了扰动法向量 $\\tilde{\\mathbf{n}}$ 而非真实法向量 $\\hat{\\mathbf{n}}$。\n2. $\\mathbf{H}_{\\text{meas}}$ 的非物理法向分量本不应贡献于电流，但由于当 $\\tilde{\\mathbf{n}}$ 与 $\\hat{\\mathbf{n}}$ 不平行时 $\\tilde{\\mathbf{n}}\\times(\\mathbf{H}_{\\text{meas}}\\cdot\\hat{\\mathbf{n}})\\hat{\\mathbf{n}} \\neq 0$，它被错误地“泄漏”到计算中。\n\n### 3. 通过切向投影缓解误差\n\n为了解决这些误差，我们可以强制施加物理约束，即只有切向场对电流有贡献。这可以通过将测量场投影到由真实法向量 $\\hat{\\mathbf{n}}$ 定义的切平面上来实现。\n我们寻求一个投影算子 $\\mathcal{Q}(\\hat{\\mathbf{n}})$，它对于任意矢量 $\\mathbf{v}$，生成一个矢量 $\\mathbf{v}_{\\text{proj}}$，使得 $\\hat{\\mathbf{n}}\\cdot\\mathbf{v}_{\\text{proj}}=0$，同时最小化欧几里得距离 $\\|\\mathbf{v}-\\mathbf{v}_{\\text{proj}}\\|_2$。这可以通过标准正交投影来解决。任何矢量 $\\mathbf{v}$ 都可以分解为 $\\mathbf{v} = \\mathbf{v}_{\\|} + \\mathbf{v}_{\\perp}$，其中 $\\mathbf{v}_{\\|} = (\\mathbf{v}\\cdot\\hat{\\mathbf{n}})\\hat{\\mathbf{n}}$ 是平行于 $\\hat{\\mathbf{n}}$ 的分量，$\\mathbf{v}_{\\perp}$ 是垂直于 $\\hat{\\mathbf{n}}$ 的分量。所需的投影即为 $\\mathbf{v}_{\\perp}$。\n$$ \\mathcal{Q}(\\hat{\\mathbf{n}})\\mathbf{v} = \\mathbf{v}_{\\perp} = \\mathbf{v} - \\mathbf{v}_{\\|} = \\mathbf{v} - (\\mathbf{v}\\cdot\\hat{\\mathbf{n}})\\hat{\\mathbf{n}} $$\n在矩阵形式中，若将 $\\hat{\\mathbf{n}}$ 视为列向量，则此算子为 $\\mathcal{Q}(\\hat{\\mathbf{n}}) = \\mathbf{I} - \\hat{\\mathbf{n}}\\hat{\\mathbf{n}}^T$，其中 $\\mathbf{I}$ 是 $3 \\times 3$ 单位矩阵。\n\n通过将此算子应用于测量场，我们定义了投影场：\n$$ \\mathbf{E}_{\\text{proj}}(\\mathbf{r}) = \\mathcal{Q}(\\hat{\\mathbf{n}}(\\mathbf{r}))\\,\\mathbf{E}_{\\text{meas}}(\\mathbf{r}) \\qquad \\mathbf{H}_{\\text{proj}}(\\mathbf{r}) = \\mathcal{Q}(\\hat{\\mathbf{n}}(\\mathbf{r}))\\,\\mathbf{H}_{\\text{meas}}(\\mathbf{r}) $$\n这些投影场保证与真实曲面相切。然后使用真实法向量和这些投影场计算校正后的电流：\n$$ \\mathbf{M}_s^{\\text{proj}}(\\mathbf{r})=-\\hat{\\mathbf{n}}(\\mathbf{r})\\times\\mathbf{E}_{\\text{proj}}(\\mathbf{r}) \\qquad \\mathbf{J}_s^{\\text{proj}}(\\mathbf{r})=\\hat{\\mathbf{n}}(\\mathbf{r})\\times\\mathbf{H}_{\\text{proj}}(\\mathbf{r}) $$\n\n### 4. 在立方体表面上的离散实现\n\n辐射矢量 $\\mathbf{N}$ 和 $\\mathbf{L}$ 的曲面积分使用求积法则进行数值计算。惠更斯面 $\\mathcal{S}$ 是一个由六个面组成的边长为 $L$ 的立方体，$\\mathcal{S} = \\bigcup_{j=1}^6 \\mathcal{S}_j$。每个面 $\\mathcal{S}_j$ 被离散化成一个 $N \\times N$ 的均匀单元网格。对 $\\mathcal{S}$ 的积分变成了对 $6N^2$ 个单元积分的总和。使用中点法则，该积分通过对单元中心的加权和来近似。\n设 $\\mathcal{S}$ 上所有单元中心的集合为 $\\{\\mathbf{r}_i\\}_{i=1}^{6N^2}$，每个单元的面积为 $\\Delta S = (L/N)^2$。辐射矢量的离散近似为：\n$$ \\mathbf{N}(\\hat{\\mathbf{r}}) \\approx \\sum_{i=1}^{6N^2} \\mathbf{J}_s(\\mathbf{r}_i) e^{ik\\hat{\\mathbf{r}}\\cdot\\mathbf{r}_i} \\Delta S $$\n$$ \\mathbf{L}(\\hat{\\mathbf{r}}) \\approx \\sum_{i=1}^{6N^2} \\mathbf{M}_s(\\mathbf{r}_i) e^{ik\\hat{\\mathbf{r}}\\cdot\\mathbf{r}_i} \\Delta S $$\n\n### 5. 数值测试流程总结\n\n该问题指定了一个数值实验来量化投影方法的有效性。\n1.  **参考计算**：从精确曲面几何上的理想切向场 $\\mathbf{E}_t, \\mathbf{H}_t$ 计算参考远场 $\\mathbf{E}_\\infty^{\\text{ref}}$。电流为 $\\mathbf{M}_s^{\\text{ref}} = -\\hat{\\mathbf{n}}\\times\\mathbf{E}_t$ 和 $\\mathbf{J}_s^{\\text{ref}} = \\hat{\\mathbf{n}}\\times\\mathbf{H}_t$，其中 $\\mathbf{E}_t$ 是通过构造而成的切向场。\n2.  **朴素计算**：用法向噪声污染场以产生 $\\mathbf{E}_{\\text{meas}}, \\mathbf{H}_{\\text{meas}}$，并将曲面法向量扰动为 $\\tilde{\\mathbf{n}}$。从电流 $\\mathbf{M}_s^{\\text{naive}} = -\\tilde{\\mathbf{n}}\\times\\mathbf{E}_{\\text{meas}}$ 和 $\\mathbf{J}_s^{\\text{naive}} = \\tilde{\\mathbf{n}}\\times\\mathbf{H}_{\\text{meas}}$ 计算朴素远场 $\\mathbf{E}_\\infty^{\\text{naive}}$。\n3.  **投影计算**：从电流 $\\mathbf{M}_s^{\\text{proj}}$ 和 $\\mathbf{J}_s^{\\text{proj}}$ 计算校正后的远场 $\\mathbf{E}_\\infty^{\\text{proj}}$，这些电流是从使用真实法向量 $\\hat{\\mathbf{n}}$ 的投影场 $\\mathbf{E}_{\\text{proj}} = \\mathcal{Q}(\\hat{\\mathbf{n}})\\mathbf{E}_{\\text{meas}}$ 和 $\\mathbf{H}_{\\text{proj}} = \\mathcal{Q}(\\hat{\\mathbf{n}})\\mathbf{H}_{\\text{meas}}$ 推导出来的。\n\n相对 $\\ell^2$ 误差 $\\varepsilon_{\\text{naive}}$ 和 $\\varepsilon_{\\text{proj}}$ 是通过在一组观测方向 $\\{\\hat{\\mathbf{r}}_m\\}$ 上将朴素远场和投影远场与参考远场进行比较来计算的。改善因子是比率 $\\rho = \\varepsilon_{\\text{naive}} / \\varepsilon_{\\text{proj}}$，它量化了投影方法所实现的误差减小程度。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the near-to-far-field simulation for the given test cases.\n    \"\"\"\n    # Physical and numerical constants\n    L = 1.0  # Cube side length in meters\n    f = 300.0e6  # Frequency in Hz\n    c = 299792458.0  # Speed of light in m/s\n    # The problem implies using lambda=1m and k=2pi for simplicity.\n    lambda_ = 1.0\n    k = 2 * np.pi / lambda_\n    eta = 376.730313668  # Impedance of free space in Ohms\n    E0 = 1.0  # Field amplitude in V/m\n    sigma = L / 3.0  # Gaussian width\n    \n    # Set fixed random seed for reproducibility\n    np.random.seed(0)\n\n    # Define the observation grid\n    n_theta = 30\n    n_phi = 60\n    theta_vals = np.linspace(1e-3, np.pi - 1e-3, n_theta)  # Avoid poles\n    phi_vals = np.linspace(0, 2 * np.pi, n_phi, endpoint=False)\n    theta_grid, phi_grid = np.meshgrid(theta_vals, phi_vals)\n    r_hats = np.array([\n        np.sin(theta_grid) * np.cos(phi_grid),\n        np.sin(theta_grid) * np.sin(phi_grid),\n        np.cos(theta_grid)\n    ]).T.reshape(-1, 3)\n\n    # Test cases from the problem statement\n    test_cases = [\n        {'angle_deg': 5, 'alpha_E': 0.0, 'alpha_H': 0.0, 'N': 20},\n        {'angle_deg': 5, 'alpha_E': 0.1, 'alpha_H': 0.1, 'N': 20},\n        {'angle_deg': 15, 'alpha_E': 0.5, 'alpha_H': 0.5, 'N': 20},\n        {'angle_deg': 10, 'alpha_E': 0.2, 'alpha_H': 0.2, 'N': 8},\n    ]\n\n    results = []\n\n    for case in test_cases:\n        N = case['N']\n        angle_deg = case['angle_deg']\n        alpha_E = case['alpha_E']\n        alpha_H = case['alpha_H']\n\n        # 1. Generate surface points and normals for the cube\n        ds = (L / N)**2\n        face_centers = L / 2.0 * np.array([\n            [1, 0, 0], [-1, 0, 0], [0, 1, 0], [0, -1, 0], [0, 0, 1], [0, 0, -1]\n        ])\n        \n        # Define tangent vectors for each face for E-field polarization\n        t_vectors = np.array([\n            [0, 1, 0], [0, 1, 0], [0, 0, 1], [0, 0, 1], [1, 0, 0], [1, 0, 0]\n        ])\n\n        u_coords = np.linspace(-L / 2 + L / (2 * N), L / 2 - L / (2 * N), N)\n        v_coords = np.linspace(-L / 2 + L / (2 * N), L / 2 - L / (2 * N), N)\n        u_grid, v_grid = np.meshgrid(u_coords, v_coords)\n        uv_pairs = np.stack([u_grid.ravel(), v_grid.ravel()], axis=-1)\n\n        surface_points = []\n        surface_normals = []\n        tangent_vecs_on_surface = []\n        in_face_vecs_sq_norm = np.sum(uv_pairs**2, axis=1)\n\n        for i, center in enumerate(face_centers):\n            normal = center / np.linalg.norm(center)\n            \n            # Map uv_pairs to 3D points on the face\n            u_ax = t_vectors[i]\n            v_ax = np.cross(normal, u_ax)\n            \n            points_on_face = center + uv_pairs[:, 0, None] * u_ax + uv_pairs[:, 1, None] * v_ax\n            surface_points.append(points_on_face)\n            surface_normals.extend([normal] * (N * N))\n            tangent_vecs_on_surface.extend([u_ax] * (N * N))\n        \n        r_primes = np.concatenate(surface_points)\n        n_hats = np.array(surface_normals)\n        t_faces = np.array(tangent_vecs_on_surface)\n        u_face_sq_norms = np.tile(in_face_vecs_sq_norm, 6)\n\n        # 2. Synthesize fields and currents (Reference, Naive, Projected)\n        \n        # Reference fields (purely tangential)\n        gauss_factor = E0 * np.exp(-u_face_sq_norms / sigma**2)\n        E_t = t_faces * gauss_factor[:, np.newaxis]\n        H_t = (1/eta) * np.cross(n_hats, E_t)\n\n        M_ref = -np.cross(n_hats, E_t)\n        J_ref = np.cross(n_hats, H_t)\n\n        # Measured fields (with noise) and perturbed normals\n        noise_E = np.random.randn(len(r_primes))\n        noise_H = np.random.randn(len(r_primes))\n        E_meas = E_t + n_hats * (alpha_E * E0 * noise_E)[:, np.newaxis]\n        H_meas = H_t + n_hats * (alpha_H * (E0/eta) * noise_H)[:, np.newaxis]\n        \n        rot_axis = np.array([0, 1, 0])\n        angle_rad = np.deg2rad(angle_deg)\n        n_tildes = np.array([\n            v * np.cos(angle_rad) + np.cross(rot_axis, v) * np.sin(angle_rad) + \n            rot_axis * np.dot(rot_axis, v) * (1 - np.cos(angle_rad))\n            for v in n_hats\n        ])\n        \n        # Naive currents\n        M_naive = -np.cross(n_tildes, E_meas)\n        J_naive = np.cross(n_tildes, H_meas)\n        \n        # Projected fields and currents\n        E_proj = E_meas - np.sum(E_meas * n_hats, axis=1)[:, np.newaxis] * n_hats\n        H_proj = H_meas - np.sum(H_meas * n_hats, axis=1)[:, np.newaxis] * n_hats\n        M_proj = -np.cross(n_hats, E_proj)\n        J_proj = np.cross(n_hats, H_proj)\n\n        # 3. Calculate far fields for each case\n        \n        def calculate_far_field(J_s, M_s):\n            phase_matrix = np.exp(1j * k * (r_hats @ r_primes.T))\n            \n            # Using (M, P) @ (P, 3) -> (M, 3) for vectorized calculation\n            N_vecs = phase_matrix @ (J_s * ds)\n            L_vecs = phase_matrix @ (M_s * ds)\n            \n            r_hats_x_L = np.cross(r_hats, L_vecs)\n            r_hats_x_N = np.cross(r_hats, N_vecs)\n            r_hats_x_r_hats_x_N = np.cross(r_hats, r_hats_x_N)\n\n            E_vec = -eta * r_hats_x_r_hats_x_N - r_hats_x_L\n            return E_vec\n\n        E_ff_ref = calculate_far_field(J_ref, M_ref)\n        E_ff_naive = calculate_far_field(J_naive, M_naive)\n        E_ff_proj = calculate_far_field(J_proj, M_proj)\n\n        # 4. Compute errors and improvement factor\n        \n        norm_ref_sq = np.sum(np.abs(E_ff_ref)**2)\n        \n        diff_naive_sq = np.sum(np.abs(E_ff_naive - E_ff_ref)**2)\n        diff_proj_sq = np.sum(np.abs(E_ff_proj - E_ff_ref)**2)\n\n        eps_naive = np.sqrt(diff_naive_sq / norm_ref_sq) if norm_ref_sq > 0 else 0\n        eps_proj = np.sqrt(diff_proj_sq / norm_ref_sq) if norm_ref_sq > 0 else 0\n\n        if eps_proj  1e-15: # If projected error is numerically zero\n            rho = np.inf if eps_naive > 1e-15 else 1.0\n        else:\n            rho = eps_naive / eps_proj\n            \n        results.append(rho)\n\n    print(f\"[{','.join(f'{r:.10f}' for r in results)}]\")\n\nsolve()\n```", "id": "3317900"}]}