{"hands_on_practices": [{"introduction": "在构建任何数值求解器时，首要步骤是在离散网格上选择微分算符的表示方法。薛定谔方程本质上是一个波动方程，因此对数值色散（numerical dispersion）——即不同波长的波以错误的相速度传播的现象——极为敏感。本练习旨在引导您分析几种常见离散化方案的色散特性，从而阐明为何谱方法（spectral methods）通常是模拟波动现象的理想选择。理解这一点是后续实践中采用伪谱方法求解器的理论基础 [@problem_id:3485474]。", "problem": "考虑模糊（超轻）暗物质的自由薛定谔方程，\n$$\ni \\hbar \\,\\frac{\\partial \\psi}{\\partial t} \\;=\\; -\\,\\frac{\\hbar^{2}}{2 m}\\,\\nabla^{2}\\psi \\,,\n$$\n该方程定义在一个长度为 $L$ 的一维周期性区域上，该区域被 $N$ 个均匀间隔的网格点离散化，间距为 $h = L/N$。忽略引力势以分离色散行为。对于与周期性区域一致的平面波模式，设 $k = 2\\pi n/L$，其中 $n$ 为整数，并定义网格相位 $\\theta = k h$（所有三角函数均使用弧度）。精确的色散关系为\n$$\n\\omega_{\\text{exact}}(k) \\;=\\; \\frac{\\hbar k^{2}}{2 m} \\,.\n$$\n考虑拉普拉斯算子的三种空间离散化方法：\n\n1. 中心二阶有限差分：\n$$\n\\left[\\nabla^{2}\\psi\\right]_{j} \\;=\\; \\frac{\\psi_{j+1} - 2 \\psi_{j} + \\psi_{j-1}}{h^{2}} \\,.\n$$\n\n2. 用于二阶导数的三对角紧致四阶有限差分（Padé型），由以下隐式定义\n$$\n\\alpha\\, \\psi^{\\prime\\prime}_{j-1} \\;+\\; \\psi^{\\prime\\prime}_{j} \\;+\\; \\alpha\\, \\psi^{\\prime\\prime}_{j+1}\n\\;=\\;\n\\frac{a}{h^{2}}\\left(\\psi_{j-1} - 2 \\psi_{j} + \\psi_{j+1}\\right)\n\\quad\\text{with}\\quad \\alpha = \\frac{1}{10},\\;\\; a = \\frac{6}{5}\\,,\n$$\n使得 $\\psi^{\\prime\\prime}_{j}$ 近似于 $\\left[\\nabla^{2}\\psi\\right]_{j}$。\n\n3. 周期性网格上的伪谱傅里叶拉普拉斯算子，对于任何网格可分辨的傅里叶模式，其均可产生精确的特征值 $-k^{2}$。\n\n对于每种离散化方法，通过作用于平面波 $\\psi_{j} = \\exp(i j \\theta)$ 的离散拉普拉斯算子特征值将离散修正波数 $k_{\\text{num}}$ 定义为 $-\\left(k_{\\text{num}}\\right)^{2}$。相应的数值角频率为\n$$\n\\omega_{\\text{num}}(k) \\;=\\; \\frac{\\hbar \\left(k_{\\text{num}}\\right)^{2}}{2 m} \\,,\n$$\n数值相速度为 $v_{p,\\text{num}}(k) = \\omega_{\\text{num}}(k)/k$。\n\n从以上定义和离散算子出发，推导相对色散误差的闭式表达式\n$$\n\\varepsilon(\\theta) \\;=\\; \\frac{\\omega_{\\text{num}}(k) - \\omega_{\\text{exact}}(k)}{\\omega_{\\text{exact}}(k)} \\;=\\; \\frac{\\left(k_{\\text{num}}\\right)^{2} - k^{2}}{k^{2}}\n$$\n该表达式是针对三种格式并以网格相位 $\\theta$ 表示的。将最终答案表示为一个单行矩阵，其中分别包含 $\\varepsilon_{\\text{cen}}(\\theta)$、$\\varepsilon_{\\text{comp}}(\\theta)$ 和 $\\varepsilon_{\\text{spec}}(\\theta)$ 的简化闭式形式。不需要进行数值计算，最终表达式中不应包含任何单位。", "solution": "用户提供了一个问题陈述，在尝试解答之前需要进行形式验证。\n\n### 问题验证\n\n**步骤1：提取已知条件**\n- **控制方程**：自由薛定谔方程， $i \\hbar \\,\\frac{\\partial \\psi}{\\partial t} = -\\,\\frac{\\hbar^{2}}{2 m}\\,\\nabla^{2}\\psi$。\n- **区域**：长度为 $L$ 的一维周期性区域，用 $N$ 个点离散化，网格间距为 $h = L/N$。\n- **测试函数**：平面波模式，$\\psi_j = \\exp(i j \\theta)$，其中 $k = 2\\pi n/L$（$n$ 为整数），$\\theta = k h$。\n- **精确色散关系**：$\\omega_{\\text{exact}}(k) = \\frac{\\hbar k^{2}}{2 m}$。\n- **数值色散关系**：$\\omega_{\\text{num}}(k) = \\frac{\\hbar \\left(k_{\\text{num}}\\right)^{2}}{2 m}$。量 $-\\left(k_{\\text{num}}\\right)^{2}$ 是离散拉普拉斯算子作用于模式 $\\exp(i j \\theta)$ 时的特征值。\n- **色散误差**：$\\varepsilon(\\theta) = \\frac{\\left(k_{\\text{num}}\\right)^{2} - k^{2}}{k^{2}}$。\n- **格式1（中心二阶）**：$\\left[\\nabla^{2}\\psi\\right]_{j} = \\frac{\\psi_{j+1} - 2 \\psi_{j} + \\psi_{j-1}}{h^{2}}$。\n- **格式2（紧致四阶）**：$\\alpha\\, \\psi^{\\prime\\prime}_{j-1} + \\psi^{\\prime\\prime}_{j} + \\alpha\\, \\psi^{\\prime\\prime}_{j+1} = \\frac{a}{h^{2}}\\left(\\psi_{j-1} - 2 \\psi_{j} + \\psi_{j+1}\\right)$，其中 $\\alpha = \\frac{1}{10}$ 且 $a = \\frac{6}{5}$。\n- **格式3（伪谱）**：对于任何网格可分辨的傅里叶模式，均可得到精确特征值 $-k^{2}$。\n\n**步骤2：使用提取的已知条件进行验证**\n根据所需标准对问题进行评估：\n- **科学基础**：该问题植根于偏微分方程（特别是薛定谔方程）的标准数值分析。所描述的方法（有限差分、紧致有限差分、伪谱法）是计算物理学中的经典技术。其在模糊暗物质上的应用是数值宇宙学中一个公认的课题。该问题在科学和数学上是合理的。\n- **适定性**：提供了所有必要的定义、方程和参数。任务是推导特定的解析表达式，根据给定的条件，存在唯一解。\n- **客观性**：问题使用精确、无歧义的数学和技术语言陈述。它不含主观或基于观点的内容。\n\n问题陈述没有表现出无效清单中列出的任何缺陷。它是一个在应用数学和计算物理学中完整、一致且可形式化的问题。\n\n**步骤3：结论与行动**\n该问题是**有效的**。将提供完整解答。\n\n### 解答推导\n\n核心任务是确定三种数值格式中每一种的相对色散误差 $\\varepsilon(\\theta)$。误差的定义由下式给出：\n$$\n\\varepsilon(\\theta) = \\frac{\\omega_{\\text{num}}(k) - \\omega_{\\text{exact}}(k)}{\\omega_{\\text{exact}}(k)} = \\frac{\\left(k_{\\text{num}}\\right)^{2} - k^{2}}{k^{2}} = \\frac{\\left(k_{\\text{num}}\\right)^{2}}{k^{2}} - 1\n$$\n为求得 $\\varepsilon(\\theta)$，我们必须找到每种格式下修正波数平方 $\\left(k_{\\text{num}}\\right)^{2}$ 的表达式。根据定义，$-\\left(k_{\\text{num}}\\right)^{2}$ 是离散拉普拉斯算子作用于平面波时的特征值。设离散拉普拉斯算子表示为 $\\hat{\\nabla}^{2}$。对于平面波模式 $\\psi_{j} = \\exp(i j k h) = \\exp(i j \\theta)$，其作用由下式给出：\n$$\n\\hat{\\nabla}^{2} \\psi_{j} = -\\left(k_{\\text{num}}\\right)^{2} \\psi_{j}\n$$\n我们将分析每个离散算子对 $\\psi_{j} = \\exp(i j \\theta)$ 的作用，注意 $\\psi_{j\\pm 1} = \\psi_{j} \\exp(\\pm i \\theta)$。我们还使用关系式 $k = \\theta/h$。\n\n**1. 中心二阶有限差分 ($\\varepsilon_{\\text{cen}}(\\theta)$)**\n\n离散拉普拉斯算子由下式给出：\n$$\n\\left[\\hat{\\nabla}^{2}\\psi\\right]_{j} = \\frac{\\psi_{j+1} - 2 \\psi_{j} + \\psi_{j-1}}{h^{2}}\n$$\n将此算子应用于 $\\psi_j = \\exp(i j \\theta)$：\n$$\n\\left[\\hat{\\nabla}^{2}\\psi\\right]_{j} = \\frac{\\exp(i \\theta) \\psi_{j} - 2 \\psi_{j} + \\exp(-i \\theta) \\psi_{j}}{h^{2}} = \\frac{\\psi_j}{h^2} \\left( \\exp(i \\theta) + \\exp(-i \\theta) - 2 \\right)\n$$\n使用恒等式 $2\\cos(\\theta) = \\exp(i \\theta) + \\exp(-i \\theta)$，我们得到：\n$$\n\\left[\\hat{\\nabla}^{2}\\psi\\right]_{j} = \\frac{\\psi_j}{h^2} \\left( 2\\cos(\\theta) - 2 \\right) = \\frac{2\\left(\\cos(\\theta) - 1\\right)}{h^2} \\psi_j\n$$\n使用半角恒等式 $1 - \\cos(\\theta) = 2\\sin^{2}(\\theta/2)$：\n$$\n\\left[\\hat{\\nabla}^{2}\\psi\\right]_{j} = \\frac{-4\\sin^{2}(\\theta/2)}{h^{2}} \\psi_j\n$$\n特征值为 $-\\frac{4\\sin^{2}(\\theta/2)}{h^{2}}$。根据定义，这等于 $-\\left(k_{\\text{num, cen}}\\right)^{2}$。\n$$\n\\left(k_{\\text{num, cen}}\\right)^{2} = \\frac{4\\sin^{2}(\\theta/2)}{h^{2}}\n$$\n因此，相对色散误差为：\n$$\n\\varepsilon_{\\text{cen}}(\\theta) = \\frac{\\left(k_{\\text{num, cen}}\\right)^{2}}{k^{2}} - 1 = \\frac{4\\sin^{2}(\\theta/2)/h^{2}}{(\\theta/h)^{2}} - 1 = \\frac{4\\sin^{2}(\\theta/2)}{\\theta^{2}} - 1\n$$\n\n**2. 紧致四阶有限差分 ($\\varepsilon_{\\text{comp}}(\\theta)$)**\n\n该格式被隐式定义为：\n$$\n\\alpha\\, \\psi^{\\prime\\prime}_{j-1} \\;+\\; \\psi^{\\prime\\prime}_{j} \\;+\\; \\alpha\\, \\psi^{\\prime\\prime}_{j+1} \\;=\\; \\frac{a}{h^{2}}\\left(\\psi_{j-1} - 2 \\psi_{j} + \\psi_{j+1}\\right)\n$$\n其中 $\\psi^{\\prime\\prime}_{j}$ 是二阶导数的数值近似。对于平面波，$\\psi^{\\prime\\prime}_{j} = -\\left(k_{\\text{num, comp}}\\right)^{2} \\psi_j$。因此，$\\psi^{\\prime\\prime}_{j\\pm 1} = -\\left(k_{\\text{num, comp}}\\right)^{2} \\psi_{j\\pm 1} = -\\left(k_{\\text{num, comp}}\\right)^{2} \\psi_j \\exp(\\pm i\\theta)$。\n代入左侧（LHS）：\n$$\n\\text{LHS} = -\\left(k_{\\text{num, comp}}\\right)^{2} \\psi_j \\left( \\alpha \\exp(-i\\theta) + 1 + \\alpha \\exp(i\\theta) \\right) = -\\left(k_{\\text{num, comp}}\\right)^{2} \\psi_j \\left( 1 + 2\\alpha\\cos(\\theta) \\right)\n$$\n右侧（RHS）的形式与中心差分算子相同，只是按 $a$ 进行了缩放：\n$$\n\\text{RHS} = \\frac{a}{h^{2}}\\left(\\psi_j \\exp(-i\\theta) - 2\\psi_j + \\psi_j \\exp(i\\theta) \\right) = \\frac{a\\psi_j}{h^2}\\left(2\\cos(\\theta)-2\\right)\n$$\n令 LHS 和 RHS 相等，并消去 $\\psi_j$：\n$$\n-\\left(k_{\\text{num, comp}}\\right)^{2} \\left( 1 + 2\\alpha\\cos(\\theta) \\right) = \\frac{a}{h^{2}} \\left(2\\cos(\\theta)-2\\right)\n$$\n解出 $\\left(k_{\\text{num, comp}}\\right)^{2}$：\n$$\n\\left(k_{\\text{num, comp}}\\right)^{2} = - \\frac{2a\\left(\\cos(\\theta)-1\\right)}{h^{2}\\left(1 + 2\\alpha\\cos(\\theta)\\right)} = \\frac{2a\\left(1-\\cos(\\theta)\\right)}{h^{2}\\left(1 + 2\\alpha\\cos(\\theta)\\right)}\n$$\n代入给定值 $\\alpha = 1/10$ 和 $a = 6/5$：\n$$\n\\left(k_{\\text{num, comp}}\\right)^{2} = \\frac{2(6/5)\\left(1-\\cos(\\theta)\\right)}{h^{2}\\left(1 + 2(1/10)\\cos(\\theta)\\right)} = \\frac{(12/5)\\left(1-\\cos(\\theta)\\right)}{h^{2}\\left(1 + (1/5)\\cos(\\theta)\\right)} = \\frac{12\\left(1-\\cos(\\theta)\\right)}{h^{2}\\left(5 + \\cos(\\theta)\\right)}\n$$\n使用恒等式 $1-\\cos(\\theta) = 2\\sin^2(\\theta/2)$：\n$$\n\\left(k_{\\text{num, comp}}\\right)^{2} = \\frac{24\\sin^{2}(\\theta/2)}{h^{2}\\left(5 + \\cos(\\theta)\\right)}\n$$\n相对色散误差为：\n$$\n\\varepsilon_{\\text{comp}}(\\theta) = \\frac{\\left(k_{\\text{num, comp}}\\right)^{2}}{k^{2}} - 1 = \\frac{24\\sin^{2}(\\theta/2)}{h^{2}\\left(5 + \\cos(\\theta)\\right)} \\frac{1}{(\\theta/h)^2} - 1 = \\frac{24\\sin^{2}(\\theta/2)}{\\theta^{2}\\left(5 + \\cos(\\theta)\\right)} - 1\n$$\n\n**3. 伪谱傅里叶拉普拉斯算子 ($\\varepsilon_{\\text{spec}}(\\theta)$)**\n\n问题陈述指出，对于一个网格可分辨的傅里叶模式，伪谱拉普拉斯算子会产生精确的特征值 $-k^{2}$。平面波 $\\psi_j = \\exp(ijkh)$，其中 $k=2\\pi n/L$，就是这样一个模式。\n因此，伪谱算子 $\\hat{\\nabla}^2_{\\text{spec}}$ 对 $\\psi_j$ 的作用是：\n$$\n\\hat{\\nabla}^2_{\\text{spec}} \\psi_j = -k^2 \\psi_j\n$$\n根据定义，特征值也等于 $-\\left(k_{\\text{num, spec}}\\right)^2$。因此，我们有：\n$$\n-\\left(k_{\\text{num, spec}}\\right)^2 = -k^2 \\quad \\implies \\quad \\left(k_{\\text{num, spec}}\\right)^2 = k^2\n$$\n相对色散误差为：\n$$\n\\varepsilon_{\\text{spec}}(\\theta) = \\frac{\\left(k_{\\text{num, spec}}\\right)^{2} - k^{2}}{k^{2}} = \\frac{k^{2} - k^{2}}{k^{2}} = 0\n$$\n这对任何非零波数 $k$ 都成立。如果 $k=0$，模式是常数，$\\omega_{\\text{exact}}$ 和 $\\omega_{\\text{num}}$ 都为零，使得相对误差未定义，形式为 $0/0$。然而，其极限为 $0$，并且对于任何色散分析，我们都考虑 $k \\neq 0$。\n\n**结论**\n\n三种格式的相对色散误差的闭式表达式为：\n- $\\varepsilon_{\\text{cen}}(\\theta) = \\frac{4\\sin^{2}(\\theta/2)}{\\theta^{2}} - 1$\n- $\\varepsilon_{\\text{comp}}(\\theta) = \\frac{24\\sin^{2}(\\theta/2)}{\\theta^{2}(5+\\cos\\theta)} - 1$\n- $\\varepsilon_{\\text{spec}}(\\theta) = 0$\n\n这些结果将以单行矩阵的形式提供。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{4\\sin^{2}(\\theta/2)}{\\theta^{2}} - 1 & \\frac{24\\sin^{2}(\\theta/2)}{\\theta^{2}(5+\\cos\\theta)} - 1 & 0\n\\end{pmatrix}\n}\n$$", "id": "3485474"}, {"introduction": "编写完求解器后，必须对其进行严格的验证。一个强有力的验证方法是测试其是否遵循基本的物理对称性。本练习将探讨伽利略不变性（Galilean invariance），该原理规定了在移动参考系下观测时系统应有的行为。通过数值模拟验证这一不变性，可以对整个时间演化算法进行一次非平凡的检验，确保代码能够正确处理波包的整体传播动力学 [@problem_id:3485529]。", "problem": "考虑一个长度为 $L$ 的周期性区域中，用于模糊或超轻暗物质的一维薛定谔-泊松系统：\n$$\ni\\hbar \\frac{\\partial \\psi(x,t)}{\\partial t} \\;=\\; -\\frac{\\hbar^2}{2m}\\frac{\\partial^2 \\psi(x,t)}{\\partial x^2} \\;+\\; m\\,\\phi(x,t)\\,\\psi(x,t),\n$$\n该系统与牛顿引力势的泊松方程耦合，\n$$\n\\frac{\\partial^2 \\phi(x,t)}{\\partial x^2} \\;=\\; 4\\pi G\\left(\\rho(x,t) - \\overline{\\rho}\\right),\n$$\n其中质量密度为 $\\rho(x,t)=|\\psi(x,t)|^2$，空间平均值为 $\\overline{\\rho}=\\frac{1}{L}\\int_0^L \\rho(x,t)\\,dx$。假设采用周期性边界条件，并使用无量纲的代码单位，使得 $\\hbar=1$，$m=1$，并将 $4\\pi G$ 写为无量纲耦合常数 $\\gamma$。\n\n薛定谔方程的伽利略增强对称性意味着，将初始波函数乘以一个平面波相位因子 $e^{i k x}$ 会增加一个均匀速度场，而不会改变初始密度。在 Madelung 表象中，写作 $\\psi(x,t)=\\sqrt{\\rho(x,t)}\\,e^{i S(x,t)}$，速度场为 $v(x,t)=\\frac{\\hbar}{m}\\,\\frac{\\partial S}{\\partial x}$，局部流为 $j(x,t)=\\frac{\\hbar}{m}\\,\\mathrm{Im}\\left(\\psi^*(x,t)\\,\\frac{\\partial \\psi(x,t)}{\\partial x}\\right)$。当对一个初始为实数且为正的 $\\psi$ 应用增强 $\\psi\\to e^{i k x}\\psi$ 时，预期的均匀速度为 $v=\\frac{\\hbar}{m}k$。\n\n您的任务是使用 Strang 分步法，在均匀网格上为上述系统实现一个数值求解器：\n- 在构型空间中，使用势能项 $e^{-i(m/\\hbar)\\phi\\,\\Delta t/2}$ 将波函数推进半个时间步长。\n- 在傅里叶空间中，使用动能项 $e^{-i(\\hbar k^2/2m)\\,\\Delta t}$ 将波函数推进一个完整的时间步长，其中 $k$ 是波数。\n- 使用更新后的势能再次推进半个时间步长。\n在每一步，通过在傅里叶空间中求解泊松方程来计算 $\\phi$：\n$$\n\\widehat{\\phi}(k) \\;=\\; -\\frac{\\gamma}{k^2}\\,\\widehat{\\rho - \\overline{\\rho}}\\,(k) \\quad \\text{for } k\\neq 0, \\quad \\widehat{\\phi}(0)=0,\n$$\n其中帽子符号表示傅里叶变换。使用谱方法计算的周期性傅里叶导数 $\\frac{\\partial \\psi}{\\partial x}$ 来提取速度。\n\n您必须通过以下方式对伽利略增强进行数值检验：\n1. 初始化一个归一化的高斯波函数，\n$$\n\\psi_0(x) = A\\,\\exp\\!\\left(-\\frac{(x-x_0)^2}{2\\sigma^2}\\right),\n$$\n其中 $A$ 的选择应使得 $\\int_0^L |\\psi_0(x)|^2\\,dx = 1$，且 $x_0=L/2$。\n2. 创建一个增强的初始条件 $\\psi_b(x,0) = e^{i k x}\\,\\psi_0(x)$，其中 $k=\\frac{2\\pi n}{L}$，$n$ 为整数。\n3. 使用相同的参数，将未增强和增强的初始条件都演化到一个共同的最终时间 $T$。\n4. 计算从增强的初始条件中提取的质量加权平均速度，\n$$\n\\overline{v} \\;=\\; \\frac{\\int_0^L \\rho(x,0)\\,v(x,0)\\,dx}{\\int_0^L \\rho(x,0)\\,dx} \\;=\\; \\frac{\\int_0^L j(x,0)\\,dx}{\\int_0^L \\rho(x,0)\\,dx},\n$$\n并将其与理论值 $v=\\frac{\\hbar}{m}k$ 进行比较。\n5. 通过将增强后的密度 $\\rho_b(x,t)$ 与未增强密度的空间平移版本 $\\rho_0(x-vt,t)$ 进行比较，来验证动力学的参考系不变性，其中平移量使用傅里叶平移定理在模 $L$ 的意义下计算。使用相对 $L^2$ 误差来量化差异：\n$$\n\\epsilon(t) \\;=\\; \\frac{\\left\\|\\rho_b(x,t) - \\rho_0(x-vt,t)\\right\\|_{L^2}}{\\left\\|\\rho_0(x,t)\\right\\|_{L^2}}.\n$$\n报告在多个时间快照中的最大误差。\n\n在这些代码单位中，所有量都是无量纲的，因此输出中不需要物理单位。由于使用了傅里叶变换，角度隐含地以弧度为单位。\n\n实现您的程序以运行以下测试套件，其中每个测试用例是一个指定 $(N, L, \\Delta t, \\text{steps}, n, \\sigma, \\gamma)$ 的元组：\n- 用例 1（基线，零增强）：$(256, 1.0, 1\\times 10^{-4}, 800, 0, 0.08, 1.0)$。\n- 用例 2（中等增强）：$(256, 1.0, 1\\times 10^{-4}, 800, 1, 0.08, 1.0)$。\n- 用例 3（较粗网格，较强增强）：$(128, 1.0, 1\\times 10^{-4}, 800, 3, 0.12, 1.0)$。\n- 用例 4（精细网格，高增强）：$(512, 1.0, 1\\times 10^{-4}, 800, 10, 0.05, 1.0)$。\n\n对于每个测试用例，输出两个浮点数：\n- 从增强的初始条件在 $t=0$ 时提取的质量加权平均速度 $\\overline{v}$。\n- 在快照时间 $t\\in\\{0, T/4, T/2, 3T/4, T\\}$ 上的最大相对 $L^2$ 误差 $\\max_t \\epsilon(t)$，其中 $T = \\text{steps}\\times \\Delta t$。\n\n最终输出格式：您的程序应生成单行输出，其中包含按测试用例顺序排列的结果，形式为方括号括起来的逗号分隔列表，每个测试用例依次贡献其两个浮点数。例如，输出必须类似于\n\"[v1,e1,v2,e2,v3,e3,v4,e4]\"。", "solution": "用户提供了一个在数值宇宙学领域定义明确的计算问题，具体涉及用于模糊或超轻暗物质的薛定谔-泊松方程的模拟。我将首先正式验证问题陈述，然后进行详细的、基于原理的求解。\n\n### 步骤 1：提取给定条件\n\n- **控制方程：**\n    1. 含时薛定谔方程：\n        $$\n        i\\hbar \\frac{\\partial \\psi(x,t)}{\\partial t} \\;=\\; -\\frac{\\hbar^2}{2m}\\frac{\\partial^2 \\psi(x,t)}{\\partial x^2} \\;+\\; m\\,\\phi(x,t)\\,\\psi(x,t)\n        $$\n    2. 引力势 $\\phi$ 的泊松方程：\n        $$\n        \\frac{\\partial^2 \\phi(x,t)}{\\partial x^2} \\;=\\; 4\\pi G\\left(\\rho(x,t) - \\overline{\\rho}\\right)\n        $$\n- **定义：**\n    - 质量密度：$\\rho(x,t)=|\\psi(x,t)|^2$\n    - 空间平均密度：$\\overline{\\rho}=\\frac{1}{L}\\int_0^L \\rho(x,t)\\,dx$\n    - 流：$j(x,t)=\\frac{\\hbar}{m}\\,\\mathrm{Im}\\left(\\psi^*(x,t)\\,\\frac{\\partial \\psi(x,t)}{\\partial x}\\right)$\n    - 伽利略增强：$\\psi \\to e^{i k x}\\psi$\n    - 源于增强的理论速度：$v=\\frac{\\hbar}{m}k$\n- **边界条件：** 在长度为 $L$ 的区域上周期性。\n- **代码单位：** $\\hbar=1$，$m=1$，以及 $\\gamma = 4\\pi G$。\n- **数值方法：**\n    - **时间积分：** Strang 分步法。\n        - 势能步：使用 $e^{-i(m/\\hbar)\\phi\\,\\Delta t/2}$ 推进 $\\Delta t/2$。\n        - 动能步：在傅里叶空间中使用 $e^{-i(\\hbar k_{wave}^2/2m)\\,\\Delta t}$ 推进 $\\Delta t$。\n    - **泊松求解器：** 在傅里叶空间中，对于 $k_{wave}\\neq 0$，$\\widehat{\\phi}(k) = -\\frac{\\gamma}{k_{wave}^2}\\,\\widehat{\\rho - \\overline{\\rho}}\\,(k)$，且 $\\widehat{\\phi}(0)=0$。\n    - **导数：** 使用谱方法计算 $\\frac{\\partial \\psi}{\\partial x}$。\n- **初始条件：**\n    - 未增强：$\\psi_0(x) = A\\,\\exp\\!\\left(-\\frac{(x-x_0)^2}{2\\sigma^2}\\right)$，归一化使得 $\\int_0^L |\\psi_0(x)|^2\\,dx = 1$，其中 $x_0=L/2$。\n    - 增强：$\\psi_b(x,0) = e^{i k x}\\,\\psi_0(x)$，其中 $k=\\frac{2\\pi n}{L}$，$n$ 为整数。\n- **任务与输出：**\n    1.  计算在 $t=0$ 时的质量加权平均速度：$\\overline{v} = \\frac{\\int_0^L j(x,0)\\,dx}{\\int_0^L \\rho(x,0)\\,dx}$。\n    2.  计算在快照时间 $t\\in\\{0, T/4, T/2, 3T/4, T\\}$ 上的最大相对 $L^2$ 误差 $\\max_t \\epsilon(t)$，其中 $T = \\text{steps}\\times \\Delta t$ 且\n        $$\n        \\epsilon(t) = \\frac{\\left\\|\\rho_b(x,t) - \\rho_0(x-vt,t)\\right\\|_{L^2}}{\\left\\|\\rho_0(x,t)\\right\\|_{L^2}}\n        $$\n- **测试用例：** 一套四个元组 $(N, L, \\Delta t, \\text{steps}, n, \\sigma, \\gamma)$：\n    - 用例 1：$(256, 1.0, 1\\times 10^{-4}, 800, 0, 0.08, 1.0)$\n    - 用例 2：$(256, 1.0, 1\\times 10^{-4}, 800, 1, 0.08, 1.0)$\n    - 用例 3：$(128, 1.0, 1\\times 10^{-4}, 800, 3, 0.12, 1.0)$\n    - 用例 4：$(512, 1.0, 1\\times 10^{-4}, 800, 10, 0.05, 1.0)$\n\n### 步骤 2：使用提取的给定条件进行验证\n\n- **科学基础：** 该问题描述了薛定谔-泊松系统，这是天体物理学中用于研究超轻或模糊暗物质的一个标准且广泛使用的模型。数值方法（分步傅里叶方法）是解决此类问题的典型技术。对伽利略不变性的检验是一项基本的物理验证。该问题在科学上是合理的。\n- **适定性：** 该问题是一个定义明确的偏微分方程组初值问题。所有必要的参数、初始条件、常数和算法规范都已提供，使得问题是适定且可解的。\n- **客观性：** 问题陈述使用了精确、形式化的数学和计算语言，没有任何主观性或模糊性。\n- **完整性与一致性：** 问题是自洽的。泊松求解器中处理 $k_{wave}=0$ 模式的规范，即 $\\widehat{\\phi}(0)=0$，与减去平均密度 $\\overline{\\rho}$ 的做法一致，这确保了在周期性区域上的质量守恒。\n- **可行性：** 指定的网格大小、时间步长和步数参数对于现代计算硬件都在合理范围内，使得模拟是可行的。\n- **结构：** 问题结构清晰，有一组特定的任务和明确定义的输出格式，没有解释的空间。\n\n### 步骤 3：结论与行动\n\n基于所有验证标准，该问题是**有效的**。将开发并实现一个解决方案。\n\n### 基于原理的解决方案设计\n\n该解决方案将围绕一个实现指定算法的数值求解器构建。所有计算都将在 $\\hbar=1$ 和 $m=1$ 的无量纲代码单位中执行。\n\n**1. 离散化：**\n长度为 $L$ 的一维周期性区域被离散化为一个包含 $N$ 个点的均匀网格，$x_j = j \\Delta x$，$j=0, \\dots, N-1$，其中 $\\Delta x = L/N$。离散傅里叶变换对应的波数为 $k_q = \\frac{2\\pi q}{L}$，其中 $q$ 是由快速傅里叶变换 (FFT) 例程提供的离散频率。\n\n**2. 时间演化（Strang 分裂法）：**\n薛定谔方程的形式为 $i\\frac{\\partial\\psi}{\\partial t} = (\\hat{T} + \\hat{V})\\psi$，其中 $\\hat{T} = -\\frac{\\hbar^2}{2m}\\nabla^2$ 是动能算符，$\\hat{V} = m\\phi$ 是势能算符。Strang 分裂法为时间演化算符提供了一个二阶精确的近似：\n$$\n\\psi(t+\\Delta t) \\approx e^{-i\\hat{V}(t+\\Delta t/2)\\Delta t/2} \\, e^{-i\\hat{T}\\Delta t} \\, e^{-i\\hat{V}(t)\\Delta t/2} \\, \\psi(t)\n$$\n因为势能 $\\hat{V}$ 是非线性的（它通过 $\\phi$ 依赖于 $\\psi$），我们在每个半步重新计算它。数值实现遵循一个“踢-漂移-踢”(kick-drift-kick) 方案：\n- **踢（势能半步）：** 从当前波函数 $\\psi$ 计算势能 $\\phi$。然后通过将波函数乘以相位因子 $e^{-i\\phi \\Delta t/2}$（因为 $m=1$）来更新它。此步在位置空间中执行。\n- **漂移（动能全步）：** 动能演化最容易在傅里叶空间中执行，其中二阶导数算符 $\\frac{\\partial^2}{\\partial x^2}$ 变为乘以 $-k_{wave}^2$。波函数 $\\psi$ 被变换到傅里叶空间（$\\hat{\\psi}$），乘以相位因子 $e^{-i(k_{wave}^2/2) \\Delta t}$（因为 $\\hbar=1, m=1$），然后变换回位置空间。\n- **踢（势能半步）：** 用从动能步获得的新波函数重复势能步。\n\n**3. 泊松求解器：**\n在每个势能步，必须确定引力势 $\\phi$。这是通过在傅里叶空间中求解泊松方程来完成的：\n1. 计算密度 $\\rho(x) = |\\psi(x)|^2$ 及其空间平均值 $\\overline{\\rho}$。\n2. 计算密度涨落的傅里叶变换 $\\widehat{\\rho-\\overline{\\rho}}(k_{wave})$。\n3. 求解势的傅里叶模式：$\\widehat{\\phi}(k_{wave}) = -\\frac{\\gamma}{k_{wave}^2} \\widehat{\\rho-\\overline{\\rho}}(k_{wave})$。通过设置 $\\widehat{\\phi}(0)=0$ 来处理 $k_{wave}=0$ 的情况，这避免了除以零，并且与问题设置在物理上一致。\n4. 计算 $\\widehat{\\phi}(k_{wave})$ 的傅里叶逆变换以获得 $\\phi(x)$。由于势必须是实数，因此丢弃由数值噪声产生的微小虚部。\n\n**4. 可观测量计算：**\n- **平均速度：** 从初始增强波函数 $\\psi_b(x,0)$ 计算质量加权平均速度 $\\overline{v}$。使用谱导数找到流 $j(x,0)$：$\\frac{\\partial \\psi_b}{\\partial x} = \\mathcal{F}^{-1}\\{i k_{wave} \\mathcal{F}\\{\\psi_b\\}\\}$。然后计算 $j = \\mathrm{Im}(\\psi_b^* \\frac{\\partial \\psi_b}{\\partial x})$，其在区域上的积分给出 $\\overline{v}$（因为总质量已归一化为 1）。分析结果 $\\overline{v} = (\\hbar/m)k = k$ 作为此数值计算的验证。\n- **参考系不变性误差：** 为计算误差 $\\epsilon(t)$，演化未增强密度 $\\rho_0(x,t)$ 并存储快照。对于每个快照，密度被空间平移一个量 $v \\cdot t$，其中 $v$ 是理论增强速度 $k$。此平移使用移位定理在傅里叶空间中精确执行：$\\mathcal{F}\\{f(x-a)\\} = e^{-ik_{wave}a}\\mathcal{F}\\{f(x)\\}$。计算增强密度 $\\rho_b(x,t)$ 与平移后的未增强密度 $\\rho_0(x-vt, t)$ 之差的 $L^2$ 范数，并用 $\\rho_0(x,t)$ 的 $L^2$ 范数进行归一化。报告所有快照中这些相对误差的最大值。$L^2$ 范数的数值表示为 $\\|\\cdot\\|_{L^2} \\approx \\sqrt{\\sum (\\cdot)^2 \\Delta x}$。\n\n将使用一个把此逻辑封装在求解器类中的 Python 实现来运行指定的测试用例，并生成所需格式的最终输出。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the Schrödinger-Poisson simulation test suite.\n    \"\"\"\n\n    class SchrodingerPoissonSolver:\n        \"\"\"\n        Solves the 1D Schrödinger-Poisson system using a Strang split-step Fourier method.\n        \"\"\"\n        def __init__(self, N, L, dt, gamma):\n            self.N = N\n            self.L = L\n            self.dt = dt\n            self.gamma = gamma\n\n            self.dx = L / N\n            self.x = np.linspace(0, L, N, endpoint=False)\n            \n            # Wavenumbers (k) for Fourier transforms\n            freq = np.fft.fftfreq(N, d=self.dx)\n            self.k_wave = 2 * np.pi * freq\n            \n            # Pre-calculate the kinetic evolution operator for a full time step.\n            # The operator is exp(-i * T * dt), where T is the kinetic energy operator.\n            # In Fourier space, T becomes hbar^2*k^2/(2m). With hbar=m=1, T_k = k^2/2.\n            self.kinetic_op = np.exp(-1j * (self.k_wave**2) / 2.0 * self.dt)\n\n            # Pre-calculate the inverse of k^2 for the Poisson solver.\n            # The operator in k-space is -gamma/k^2 for k != 0.\n            self.poisson_k_op = np.zeros_like(self.k_wave)\n            nonzero_k_indices = self.k_wave != 0\n            self.poisson_k_op[nonzero_k_indices] = -self.gamma / (self.k_wave[nonzero_k_indices]**2)\n\n        def _solve_poisson(self, rho):\n            \"\"\"Solves the Poisson equation in Fourier space.\"\"\"\n            rho_mean = np.mean(rho)\n            rho_minus_mean = rho - rho_mean\n            \n            rho_k = np.fft.fft(rho_minus_mean)\n            phi_k = self.poisson_k_op * rho_k\n            \n            phi = np.fft.ifft(phi_k)\n            return phi.real\n\n        def _potential_step(self, psi):\n            \"\"\"Applies the potential operator for half a time step.\"\"\"\n            rho = np.abs(psi)**2\n            phi = self._solve_poisson(rho)\n            potential_op_half_step = np.exp(-1j * phi * self.dt / 2.0)\n            return psi * potential_op_half_step\n\n        def _kinetic_step(self, psi):\n            \"\"\"Applies the kinetic operator for a full time step.\"\"\"\n            psi_k = np.fft.fft(psi)\n            psi_k_evolved = psi_k * self.kinetic_op\n            return np.fft.ifft(psi_k_evolved)\n\n        def evolve_step(self, psi):\n            \"\"\"Performs one full time step using Strang splitting (kick-drift-kick).\"\"\"\n            psi = self._potential_step(psi)\n            psi = self._kinetic_step(psi)\n            psi = self._potential_step(psi)\n            return psi\n\n    def run_case(params):\n        \"\"\"\n        Runs a single test case for the Schrödinger-Poisson simulation.\n        \"\"\"\n        N, L, dt, steps, n, sigma, gamma = params\n        \n        solver = SchrodingerPoissonSolver(N, L, dt, gamma)\n        x, dx, k_wave = solver.x, solver.dx, solver.k_wave\n\n        # 1. Initialize unboosted wavefunction (normalized Gaussian)\n        psi0_unnormalized = np.exp(-(x - L / 2.0)**2 / (2 * sigma**2))\n        norm = np.sqrt(np.sum(np.abs(psi0_unnormalized)**2) * dx)\n        psi0 = psi0_unnormalized / norm\n\n        # 2. Create boosted initial condition\n        boost_k = (2.0 * np.pi * n) / L\n        psi_b_t0 = psi0 * np.exp(1j * boost_k * x)\n        \n        # 4. Compute mass-weighted mean velocity at t=0\n        psi_b_t0_k = np.fft.fft(psi_b_t0)\n        d_psi_b_dx = np.fft.ifft(1j * k_wave * psi_b_t0_k)\n        j_b_t0 = np.imag(np.conj(psi_b_t0) * d_psi_b_dx)\n        v_mean = np.sum(j_b_t0) * dx\n        \n        v_theory = boost_k\n\n        # 3/5. Evolve both ICs and compute discrepancy\n        snapshot_steps = sorted(list(set([0, steps // 4, steps // 2, 3 * steps // 4, steps])))\n        \n        sim_results = {}\n        for sim_type, psi_initial in [('unboosted', psi0), ('boosted', psi_b_t0)]:\n            snapshots = {}\n            psi = np.copy(psi_initial)\n            \n            if 0 in snapshot_steps:\n                snapshots[0] = np.abs(psi)**2\n                \n            for step in range(1, steps + 1):\n                psi = solver.evolve_step(psi)\n                if step in snapshot_steps:\n                    snapshots[step] = np.abs(psi)**2\n            sim_results[sim_type] = snapshots\n\n        rho0_snapshots = sim_results['unboosted']\n        rhob_snapshots = sim_results['boosted']\n        \n        errors = []\n        for step_num in snapshot_steps:\n            t = step_num * dt\n            rho_b = rhob_snapshots[step_num]\n            rho_0 = rho0_snapshots[step_num]\n            \n            shift = (v_theory * t) % L\n            rho_0_k = np.fft.fft(rho_0)\n            shift_phase = np.exp(-1j * k_wave * shift)\n            rho_0_shifted = np.fft.ifft(rho_0_k * shift_phase).real\n            \n            diff_rho_sq = (rho_b - rho_0_shifted)**2\n            numerator = np.sqrt(np.sum(diff_rho_sq) * dx)\n            \n            rho_0_sq = rho_0**2\n            denominator = np.sqrt(np.sum(rho_0_sq) * dx)\n            \n            error = numerator / denominator if denominator != 0 else (0.0 if numerator == 0.0 else np.inf)\n            errors.append(error)\n            \n        max_error = np.max(errors)\n        \n        return v_mean, max_error\n\n    test_cases = [\n        (256, 1.0, 1e-4, 800, 0, 0.08, 1.0),\n        (256, 1.0, 1e-4, 800, 1, 0.08, 1.0),\n        (128, 1.0, 1e-4, 800, 3, 0.12, 1.0),\n        (512, 1.0, 1e-4, 800, 10, 0.05, 1.0),\n    ]\n\n    results = []\n    for case in test_cases:\n        v_mean, max_error = run_case(case)\n        results.extend([v_mean, max_error])\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3485529"}, {"introduction": "一个经过验证的求解器还必须足够稳健，尤其是在模拟具有高密度对比度的复杂宇宙学结构时。本练习聚焦于一个关键的数值挑战：如何在密度趋近于零（即波函数相位未明确定义的区域）时，依然能精确地保持质量守恒。理解如何构建一个守恒的质量通量表达式，对于防止数值模拟中出现非物理的质量增减至关重要，从而保证模拟结果的长期物理保真度 [@problem_id:3485515]。", "problem": "考虑一个非膨胀区域中用于模糊或超轻暗物质的薛定谔-泊松系统，该系统由薛定谔方程\n$$\ni \\hbar \\,\\partial_t \\psi(\\mathbf{x},t) \\;=\\; -\\frac{\\hbar^2}{2 m}\\,\\nabla^2 \\psi(\\mathbf{x},t) \\;+\\; m\\,\\Phi(\\mathbf{x},t)\\,\\psi(\\mathbf{x},t),\n$$\n与泊松方程耦合\n$$\n\\nabla^2 \\Phi(\\mathbf{x},t) \\;=\\; 4\\pi G \\left(\\rho(\\mathbf{x},t) - \\bar{\\rho}\\right),\n$$\n其中质量密度定义为 $\\rho(\\mathbf{x},t) \\equiv |\\psi(\\mathbf{x},t)|^2$（将任何常数归一化因子吸收到单位中），$\\bar{\\rho}$ 是一个常数平均背景密度。连续性方程可以从薛定谔方程导出，其形式为\n$$\n\\partial_t \\rho \\;+\\; \\nabla\\cdot \\mathbf{J} \\;=\\; 0,\n$$\n其中规范不变流为\n$$\n\\mathbf{J} \\;\\equiv\\; \\frac{\\hbar}{m}\\,\\mathrm{Im}\\!\\left(\\psi^*\\,\\nabla \\psi\\right).\n$$\nMadelung变换 $\\psi = \\sqrt{\\rho}\\,\\exp(i S)$ 引入了相位 $S(\\mathbf{x},t)$ 和速度 $\\mathbf{v} \\equiv \\frac{\\hbar}{m}\\,\\nabla S$，从而在光滑条件下，形式上有 $\\mathbf{J} = \\rho\\,\\mathbf{v}$。在实际的数值求解器中，相位 $S$ 是从 $\\psi$ 重构的，并用于计算 $\\mathbf{v}$ 和平流质量通量。然而，在密度 $\\rho \\to 0$ 的节点附近，$S$ 会变得病态（ill-defined），并且 $\\nabla S$ 会表现出巨大的数值误差，这会产生虚假的质量通量和表观上的质量损失。\n\n假设你正在一个均匀的笛卡尔网格上为 $\\rho$ 实现一个守恒的有限体积更新方法，其中 $\\rho_{i,j,k}$ 是单元平均密度，通量位于面心。你观察到，从 $\\nabla S$ 重构 $\\mathbf{v}$ 并使用 $\\rho \\mathbf{v}$ 来更新 $\\rho$ 会在 $\\rho$ 局部趋于0时导致显著的质量不守恒。你的目标是从第一性原理分析这个误差的来源，并选择一个方案，该方案既能正则化节点附近的相位或密度，又能将质量守恒保持到机器精度，同时不改变 $\\psi$ 的幺正演化。\n\n以下哪个陈述正确地指出了虚假质量损失的机制和一个能保持守恒性的数值上合理的补救措施？\n\nA. 施加一个硬性下限 $\\rho \\ge \\rho_{\\mathrm{floor}}$，并在所有 $\\rho \\le \\rho_{\\mathrm{floor}}$ 的地方设置 $\\mathbf{v} = \\mathbf{0}$，同时继续通过平流通量 $\\rho \\mathbf{v}$ 来更新 $\\rho$。这消除了来自低密度单元的通量，因此保证了质量守恒。\n\nB. 使用连续性方程更新 $\\rho$，其面心流直接通过 $\\mathbf{J} = \\frac{\\hbar}{m}\\,\\mathrm{Im}(\\psi^* \\nabla \\psi)$ 从 $\\psi$ 计算，使用中心差分进行离散，并且时间中心化与 $\\psi$ 积分器一致。如果需要速度用于诊断，计算 $\\mathbf{v} \\equiv \\mathbf{J}/\\max(\\rho,\\rho_{\\mathrm{floor}})$，但不要将这个 $\\mathbf{v}$ 反馈回 $\\rho$ 的更新中。这避免了在节点附近除以 $\\rho$ 的操作，并保持了精确的离散守恒。\n\nC. 在势中添加一个小的虚部，$m\\Phi \\to m\\Phi - i \\epsilon$，其中 $\\epsilon$ 与 $|\\nabla S|$ 成正比，以抑制节点附近的快速相位振荡。这稳定了相位并防止了虚假质量通量，同时不影响质量守恒。\n\nD. 在每个时间步对 $S$ 进行全局相位解缠以移除分支切割，然后在为 $\\rho$ 的更新计算 $\\mathbf{J} = \\rho \\frac{\\hbar}{m} \\nabla S$ 之前，通过强制 $|\\nabla S| \\le S_{\\mathrm{max}}$ 来限制 $\\nabla S$ 的大小。这防止了大的速度，从而产生守恒的通量。\n\nE. 使用交错网格离散化，该方案使用幺正、时间可逆的格式在单元中心演化 $\\psi$，使用满足分部求和恒等式的中心差分计算面心流 $\\mathbf{J}$，并通过 $\\partial_t \\rho + \\nabla\\cdot \\mathbf{J} = 0$ 更新 $\\rho$。仅在构建诊断量 $\\mathbf{v} = \\mathbf{J}/\\rho$ 时应用密度下限，决不在计算 $\\mathbf{J}$ 或更新 $\\psi$ 或 $\\rho$ 时使用。这在 $\\rho \\to 0$ 附近正则化了派生出的速度，同时保持了精确的离散质量守恒。\n\n选择所有适用项。从薛定谔连续性方程和 $\\mathbf{J}$ 的定义开始，给出你的推理过程，并解释为什么在 $\\rho \\to 0$ 附近的相位梯度误差会在使用 $\\rho \\mathbf{v}$ 平流的方案中导致虚假的质量损失，以及为什么你选择的补救措施避免了这个问题，同时保持了守恒性和 $\\psi$ 的幺正演化。", "solution": "问题陈述提出了一个关于薛定谔-泊松系统模拟中数值质量守恒的问题。我将首先验证问题陈述的有效性，然后进行完整的解答。\n\n### 第1步：提取已知信息\n问题提供了以下方程和定义：\n- 波函数 $\\psi(\\mathbf{x},t)$ 的薛定谔方程：\n$$\ni \\hbar \\,\\partial_t \\psi(\\mathbf{x},t) \\;=\\; -\\frac{\\hbar^2}{2 m}\\,\\nabla^2 \\psi(\\mathbf{x},t) \\;+\\; m\\,\\Phi(\\mathbf{x},t)\\,\\psi(\\mathbf{x},t)\n$$\n- 引力势 $\\Phi(\\mathbf{x},t)$ 的泊松方程：\n$$\n\\nabla^2 \\Phi(\\mathbf{x},t) \\;=\\; 4\\pi G \\left(\\rho(\\mathbf{x},t) - \\bar{\\rho}\\right)\n$$\n- 用波函数定义的质量密度：\n$$\n\\rho(\\mathbf{x},t) \\equiv |\\psi(\\mathbf{x},t)|^2\n$$\n- 从薛定谔方程导出的连续性方程：\n$$\n\\partial_t \\rho \\;+\\; \\nabla\\cdot \\mathbf{J} \\;=\\; 0\n$$\n- 规范不变概率流（或根据单位，质量通量）的定义：\n$$\n\\mathbf{J} \\;\\equiv\\; \\frac{\\hbar}{m}\\,\\mathrm{Im}\\!\\left(\\psi^*\\,\\nabla \\psi\\right)\n$$\n- Madelung变换，它将复波函数 $\\psi$ 表示为一个实振幅 $\\sqrt{\\rho}$ 和一个实相位 $S$：\n$$\n\\psi = \\sqrt{\\rho}\\,\\exp(i S)\n$$\n- 用相位梯度定义的速度场 $\\mathbf{v}$：\n$$\n\\mathbf{v} \\equiv \\frac{\\hbar}{m}\\,\\nabla S\n$$\n- 在光滑条件下，流 $\\mathbf{J}$ 和平流通量 $\\rho\\mathbf{v}$ 之间的形式等价性：\n$$\n\\mathbf{J} = \\rho\\,\\mathbf{v}\n$$\n- 数值问题：在 $\\rho \\to 0$ 的节点附近，相位 $S$ 是病态的，导致 $\\nabla S$ 以及 $\\mathbf{v}$ 中出现巨大误差。在 $\\rho$ 的有限体积更新中使用通量 $\\rho\\mathbf{v}$ 会导致虚假的质量通量和对质量守恒的违反。\n- 目标：确定一种数值方案，该方案通过将质量守恒保持到机器精度来解决此问题，同时不改变 $\\psi$ 的幺正演化。\n\n### 第2步：使用提取的已知信息进行验证\n问题陈述在科学上是合理的，并且是适定的（well-posed）。\n- **科学依据**：薛定谔-泊松方程是模糊/超轻暗物质在非相对论极限下的标准模型。连续性方程和流 $\\mathbf{J}$ 的推导是量子力学的基本结果。Madelung变换是在流体动力学框架下解释薛定谔方程的标准理论工具。所描述的数值困难，即密度节点处相位的奇异性，是该领域一个有据可查且关键的挑战。\n- **适定性和客观性**：该问题以客观的方式呈现，使用了精确的数学和物理语言。它构建了一个关于数值方法的清晰、可验证的问题。其设定是自洽的，没有矛盾或歧义。它描述了一个真实的问题，并要求从一组提议中找到一个有效的解决方案。\n\n### 第3步：结论与行动\n该问题是**有效的**。我现在将进行完整的推导和分析。\n\n### 推导与分析\n\n问题的核心在于质量通量表达式的选择。从第一性原理出发，薛定谔方程意味着连续性方程 $\\partial_t \\rho + \\nabla \\cdot \\mathbf{J} = 0$，其中 $\\rho \\equiv |\\psi|^2$ 且 $\\mathbf{J} \\equiv \\frac{\\hbar}{m}\\,\\mathrm{Im}(\\psi^* \\nabla \\psi)$。这是精确成立的。薛定谔演化（对于实势 $\\Phi$）的幺正性保证了总质量 $M = \\int \\rho \\, d^3x$ 是守恒的。一个数值方案应该在离散层面上保持这一性质。\n\nMadelung变换 $\\psi = \\sqrt{\\rho} e^{iS}$ 导致了关系 $\\mathbf{J} = \\rho \\mathbf{v}$，其中 $\\mathbf{v} = \\frac{\\hbar}{m} \\nabla S$。虽然在 $\\rho > 0$ 的连续统中数学上等价，但这两种通量形式，$\\mathbf{J}$ 和 $\\rho\\mathbf{v}$，具有截然不同的数值性质。\n\n表达式 $\\mathbf{J} = \\frac{\\hbar}{m}\\,\\mathrm{Im}(\\psi^* \\nabla \\psi)$ 是鲁棒的。由于 $\\psi$ 是数值方案演化的基本量，它总是良定义的。当 $\\psi \\to 0$ 时，我们自然有 $\\mathbf{J} \\to 0$。在网格上对此通量进行中心差分离散，例如对于单元 $i$ 和 $i+1$ 之间面上的通量 $x$ 分量，可以写成：\n$$\nJ_{x, i+1/2} = \\frac{\\hbar}{m} \\mathrm{Im}\\left( \\left(\\frac{\\psi_{i+1}^* + \\psi_i^*}{2}\\right) \\left(\\frac{\\psi_{i+1} - \\psi_i}{\\Delta x}\\right) \\right) = \\frac{\\hbar}{2m\\,\\Delta x} \\mathrm{Im}(\\psi_i^* \\psi_{i+1} - \\psi_{i+1}^* \\psi_i) = \\frac{\\hbar}{m\\,\\Delta x} \\mathrm{Im}(\\psi_i^* \\psi_{i+1})\n$$\n这个离散化的通量仅取决于相邻单元中 $\\psi$ 的值。对单元平均密度 $\\rho_i$ 进行有限体积更新，$\\frac{d\\rho_i}{dt} = - \\frac{1}{\\Delta x} (J_{x, i+1/2} - J_{x, i-1/2})$，会导致总质量变化的伸缩求和（telescoping sum），即 $\\frac{d}{dt}\\sum_i \\rho_i \\Delta x = 0$（假设有适当的边界条件）。这确保了质量守恒达到机器精度。这个通量表达式不涉及除法，并且即使在 $\\psi \\to 0$ 时也保持良态。\n\n相比之下，$\\rho\\mathbf{v}$ 的形式在数值上是有问题的。它需要计算相位 $S = \\arg(\\psi)$，然后计算其梯度 $\\nabla S$。在一个 $\\rho \\to 0$ 的节点处，波函数 $\\psi \\to 0$。复数 0 的相位是未定义的。在数值上，对于一个小的 $\\psi = \\epsilon_1 + i\\epsilon_2$，相位 $S = \\mathrm{atan2}(\\epsilon_2, \\epsilon_1)$ 对噪声极其敏感，并且可能在相邻网格单元之间剧烈波动。这导致离散化的 $\\nabla S$ 出现巨大的虚假值，从而导致速度 $\\mathbf{v}$ 也出现巨大虚假值。将这个虚假的速度乘以一个小的密度 $\\rho$ 并不能保证得到一个小的、行为正确的通量。$\\nabla S$ 的离散算子与 $\\rho$ 的值之间的这种不匹配，破坏了确保守恒的精妙抵消，导致人为的质量产生或湮灭。\n\n因此，一个鲁棒的、守恒的数值方案必须使用 $\\mathbf{J}$ 的基本定义直接从波函数 $\\psi$ 计算通量。速度场 $\\mathbf{v}$ 应被视为一个派生的、诊断性的量，如果必须计算它，那么除以 $\\rho$ 的操作应该被正则化（例如，$\\mathbf{v} = \\mathbf{J} / \\max(\\rho, \\rho_{\\text{floor}})$），但这个正则化后的速度决不能用于计算演化方程的通量。\n\n### 逐项分析\n\n**A. 施加一个硬性下限 $\\rho \\ge \\rho_{\\mathrm{floor}}$，并在所有 $\\rho \\le \\rho_{\\mathrm{floor}}$ 的地方设置 $\\mathbf{v} = \\mathbf{0}$，同时继续通过平流通量 $\\rho \\mathbf{v}$ 来更新 $\\rho$。这消除了来自低密度单元的通量，因此保证了质量守恒。**\n这个陈述是不正确的。首先，它坚持使用数值上不稳定的平流形式通量 $\\rho\\mathbf{v}$。其次，将速度设为零是一种临时的修复，其作用类似于人工屏障，错误地阻碍了质量流动。第三，声称这“保证了质量守恒”是错误的。简单地阻止通量从低密度单元流出并不能确保整个方案是守恒的；这是一个粗糙的补丁，它改变了物理过程，并且不尊重离散守恒所需的数学结构。**不正确。**\n\n**B. 使用连续性方程更新 $\\rho$，其面心流直接通过 $\\mathbf{J} = \\frac{\\hbar}{m}\\,\\mathrm{Im}(\\psi^* \\nabla \\psi)$ 从 $\\psi$ 计算，使用中心差分进行离散，并且时间中心化与 $\\psi$ 积分器一致。如果需要速度用于诊断，计算 $\\mathbf{v} \\equiv \\mathbf{J}/\\max(\\rho,\\rho_{\\mathrm{floor}})$，但不要将这个 $\\mathbf{v}$ 反馈回 $\\rho$ 的更新中。这避免了在节点附近除以 $\\rho$ 的操作，并保持了精确的离散守恒。**\n这个陈述是正确的。它正确地指出了补救措施：使用直接从 $\\psi$ 计算的基本流 $\\mathbf{J}$ 来评估质量通量。如上述分析所示，这种形式在节点处行为良好，并且在有限体积框架中使用时，可以实现精确的离散质量守恒。它还正确地区分了基本演化（不应使用 $\\mathbf{v}$）和作为诊断量计算 $\\mathbf{v}$（此时正则化是适当且安全的）。提及与时间积分器的一致性也是一个精心设计的方案的标志。**正确。**\n\n**C. 在势中添加一个小的虚部，$m\\Phi \\to m\\Phi - i \\epsilon$，其中 $\\epsilon$ 与 $|\\nabla S|$ 成正比，以抑制节点附近的快速相位振荡。这稳定了相位并防止了虚假质量通量，同时不影响质量守恒。**\n这个陈述是根本错误的。在势中添加虚部会使哈密顿算符非厄米。这明确地破坏了时间演化的幺正性。连续性方程会增加一个源/汇项：$\\partial_t \\rho + \\nabla \\cdot \\mathbf{J} = - (2\\epsilon/\\hbar)\\rho$。这意味着质量明确不守恒。这样的项用于模拟吸收或耗散，这与保持质量的既定目标背道而驰。声称这样做“不影响质量守恒”是与引入虚势的后果直接矛盾的。**不正确。**\n\n**D. 在每个时间步对 $S$ 进行全局相位解缠以移除分支切割，然后在为 $\\rho$ 的更新计算 $\\mathbf{J} = \\rho \\frac{\\hbar}{m} \\nabla S$ 之前，通过强制 $|\\nabla S| \\le S_{\\mathrm{max}}$ 来限制 $\\nabla S$ 的大小。这防止了大的速度，从而产生守恒的通量。**\n这个陈述是不正确的。它描述了应用于有缺陷的 $\\rho\\mathbf{v}$ 公式的另一组临时补丁。相位解缠可以解决 $2\\pi$ 的跳跃，但无法修复在真正节点（$\\rho=0$）处相位未定义的问题。限制梯度 $|\\nabla S|$ 是一种形式的人工粘性或通量限制，它不是从 underlying 物理推导出来的，也不能保证守恒。一个方案是“守恒的”，如果它的离散散度是一个完全差分算子，能导致伸缩求和。仅仅限制通量的大小并不能赋予这个性质，并且通常不会将质量守恒到机器精度。**不正确。**\n\n**E. 使用交错网格离散化，该方案使用幺正、时间可逆的格式在单元中心演化 $\\psi$，使用满足分部求和恒等式的中心差分计算面心流 $\\mathbf{J}$，并通过 $\\partial_t \\rho + \\nabla\\cdot \\mathbf{J} = 0$ 更新 $\\rho$。仅在构建诊断量 $\\mathbf{v} = \\mathbf{J}/\\rho$ 时应用密度下限，决不在计算 $\\mathbf{J}$ 或更新 $\\psi$ 或 $\\rho$ 时使用。这在 $\\rho \\to 0$ 附近正则化了派生出的速度，同时保持了精确的离散质量守恒。**\n这个陈述是正确的。它提供了选项 B 中概述原理的更详细的、实现层面的描述。交错网格、用于 $\\psi$ 的幺正积分器，以及满足分部求和（Summation-By-Parts, SBP）性质的 $\\mathbf{J}$ 通量计算，是用于该系统的高质量、守恒代码的典型要素。差分算子的 SBP 性质正是保证离散散度模仿连续统分部积分的关键，从而导致伸缩求和和精确的离散守恒。关于 $\\rho$ 的更新与 $\\partial_t \\rho + \\nabla \\cdot \\mathbf{J} = 0$ 一致的陈述是这样一个精心构建的方案所期望的结果。对诊断速度的处理也描述正确。这代表了解决该问题的最先进方法。**正确。**\n\nB 和 E 都描述了一个正确且合理的方法。B 陈述了核心原则，而 E 为其实施提供了更具体和严谨的方案。由于问题要求选择所有适用项，因此两者都是有效的正确答案。", "answer": "$$\\boxed{B, E}$$", "id": "3485515"}]}