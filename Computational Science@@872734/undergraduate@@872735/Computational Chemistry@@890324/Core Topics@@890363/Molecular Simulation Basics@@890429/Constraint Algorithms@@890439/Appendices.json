{"hands_on_practices": [{"introduction": "The best way to understand an algorithm is to implement it. This first exercise guides you through coding a simplified version of the SHAKE algorithm for a triatomic molecule [@problem_id:2453574]. By investigating how the number of iterations required for convergence changes with the integration time step, you will develop a practical understanding of the relationship between the unconstrained dynamics and the work required by the constraint solver.", "problem": "A rigid triatomic system of three point masses labeled $0$, $1$, and $2$ in three-dimensional Euclidean space is considered. The positions are vectors $\\mathbf{r}_i \\in \\mathbb{R}^3$ and the velocities are vectors $\\mathbf{v}_i \\in \\mathbb{R}^3$ for $i \\in \\{0,1,2\\}$. The system is subject to two holonomic constraints that fix the distances between atom $0$ and atom $1$, and between atom $0$ and atom $2$. All quantities are dimensionless.\n\nInitial data:\n- Masses: $m_0 = 16$, $m_1 = 1$, $m_2 = 1$.\n- Distance constraints: $d_{01} = 1$, $d_{02} = 1$.\n- Initial positions: $\\mathbf{r}_0 = (0,0,0)$, $\\mathbf{r}_1 = (1,0,0)$, $\\mathbf{r}_2 = (-1,0,0)$.\n- Initial velocities: $\\mathbf{v}_0 = (0,0,0)$, $\\mathbf{v}_1 = (0.5,0.2,0)$, $\\mathbf{v}_2 = (-0.5,0.2,0)$.\n\nFor a given time step $\\Delta t > 0$, define unconstrained trial positions by a forward Euler kinematic update\n$$\n\\mathbf{r}_i^{(0)} = \\mathbf{r}_i + \\Delta t\\, \\mathbf{v}_i \\quad \\text{for each } i \\in \\{0,1,2\\}.\n$$\nDefine the two constraint functions for a configuration $\\mathbf{r} = (\\mathbf{r}_0,\\mathbf{r}_1,\\mathbf{r}_2)$ by\n$$\ng_{01}(\\mathbf{r}) = \\|\\mathbf{r}_0 - \\mathbf{r}_1\\|^2 - d_{01}^2, \\quad g_{02}(\\mathbf{r}) = \\|\\mathbf{r}_0 - \\mathbf{r}_2\\|^2 - d_{02}^2.\n$$\nStarting from $\\mathbf{r}^{(0)}$, enforce the constraints iteratively by repeated linearized projections applied sequentially to the two constraints in the fixed order $(0,1)$ then $(0,2)$. One outer iteration consists of one sweep over both constraints in this order, applying the following update rule to the currently held positions.\n\nFor a single constraint between atoms $i$ and $j$ with target distance $d_{ij}$, define\n$$\n\\mathbf{r}_{ij} = \\mathbf{r}_i - \\mathbf{r}_j, \\quad S = \\mathbf{r}_{ij} \\cdot \\mathbf{r}_{ij}, \\quad g = S - d_{ij}^2.\n$$\nLet\n$$\n\\alpha = \\frac{g}{2\\,S \\left(\\frac{1}{m_i} + \\frac{1}{m_j}\\right)}.\n$$\nUpdate the two atomic positions by\n$$\n\\mathbf{r}_i \\leftarrow \\mathbf{r}_i - \\frac{\\alpha}{m_i}\\, \\mathbf{r}_{ij}, \\qquad\n\\mathbf{r}_j \\leftarrow \\mathbf{r}_j + \\frac{\\alpha}{m_j}\\, \\mathbf{r}_{ij}.\n$$\n\nDefine the constraint violation measure at any configuration $\\mathbf{r}$ as\n$$\n\\varepsilon(\\mathbf{r}) = \\max\\left( \\left| g_{01}(\\mathbf{r}) \\right|, \\left| g_{02}(\\mathbf{r}) \\right| \\right).\n$$\nGiven a tolerance $\\tau > 0$, the iteration is said to have converged when $\\varepsilon(\\mathbf{r}) \\le \\tau$. The iteration count is defined as the number of outer iterations (complete sweeps over both constraints) required to achieve convergence, with the convention that if $\\varepsilon(\\mathbf{r}^{(0)}) \\le \\tau$ then the iteration count is $0$. If convergence is not achieved within a maximum of $N_{\\max} = 10000$ outer iterations, report the iteration count as $-1$.\n\nTasks:\n- For each pair $(\\Delta t, \\tau)$ in the test suite below, starting from the given initial data, construct $\\mathbf{r}^{(0)}$ and perform the iterative enforcement as defined. Compute and return the iteration count.\n\nThe test suite consists of the following pairs $(\\Delta t, \\tau)$:\n- $(0, 10^{-12})$,\n- $(5 \\times 10^{-3}, 10^{-12})$,\n- $(2 \\times 10^{-2}, 10^{-12})$,\n- $(10^{-1}, 10^{-12})$,\n- $(10^{-1}, 10^{-30})$.\n\nAll quantities are dimensionless. Your program should produce a single line of output containing the results as a comma-separated list of integers enclosed in square brackets with no spaces, in the same order as the test suite.", "solution": "The problem statement is found to be valid upon critical examination. It is scientifically grounded, well-posed, objective, and self-contained. The problem describes the application of a simplified SHAKE algorithm, a standard iterative method in computational molecular dynamics for satisfying holonomic constraints. All necessary data, initial conditions, and algorithmic rules are provided without ambiguity or contradiction. We may therefore proceed with the formulation of a solution.\n\nThe task is to determine the number of iterations required for a sequential constraint projection algorithm to converge for a triatomic system. The system consists of three masses, $m_0$, $m_1$, and $m_2$, with fixed distance constraints between pairs $(0,1)$ and $(0,2)$.\n\nThe process begins with an unconstrained update of atomic positions over a time step $\\Delta t$ using a forward Euler integration scheme. Given the initial positions $\\mathbf{r}_i$ and velocities $\\mathbf{v}_i$, the trial positions, which we denote as $\\mathbf{r}^{(k)}$ with $k=0$, are calculated as:\n$$\n\\mathbf{r}_i^{(0)} = \\mathbf{r}_i + \\Delta t\\, \\mathbf{v}_i \\quad \\text{for } i \\in \\{0, 1, 2\\}\n$$\nThese trial positions $\\mathbf{r}^{(0)} = (\\mathbf{r}_0^{(0)}, \\mathbf{r}_1^{(0)}, \\mathbf{r}_2^{(0)})$ generally do not satisfy the distance constraints. The constraints are given in terms of squared distances:\n$$\ng_{01}(\\mathbf{r}) = \\|\\mathbf{r}_0 - \\mathbf{r}_1\\|^2 - d_{01}^2 = 0\n$$\n$$\ng_{02}(\\mathbf{r}) = \\|\\mathbf{r}_0 - \\mathbf{r}_2\\|^2 - d_{02}^2 = 0\n$$\nThe core of the problem is the iterative procedure to correct the trial positions until these two constraint equations are satisfied to within a given tolerance $\\tau$. The convergence is measured by the maximum absolute violation:\n$$\n\\varepsilon(\\mathbf{r}) = \\max\\left( \\left| g_{01}(\\mathbf{r}) \\right|, \\left| g_{02}(\\mathbf{r}) \\right| \\right)\n$$\nThe iteration halts when $\\varepsilon(\\mathbf{r}) \\le \\tau$.\n\nOne outer iteration of the algorithm consists of applying a correction for each constraint sequentially. This is a Gauss-Seidel type iteration, where the updates from one constraint satisfaction step are immediately used in the next.\n\nFor a generic constraint between atoms $i$ and $j$, the algorithm corrects the positions $\\mathbf{r}_i$ and $\\mathbf{r}_j$. The correction is derived from a linearized approximation of the constraint equation. Let the current positions be $\\mathbf{r}_i$ and $\\mathbf{r}_j$. The proposed updates are:\n$$\n\\mathbf{r}_i^{\\text{new}} = \\mathbf{r}_i - \\frac{\\alpha}{m_i} (\\mathbf{r}_i - \\mathbf{r}_j)\n$$\n$$\n\\mathbf{r}_j^{\\text{new}} = \\mathbf{r}_j + \\frac{\\alpha}{m_j} (\\mathbf{r}_i - \\mathbf{r}_j)\n$$\nThe relative position vector transforms as:\n$$\n\\mathbf{r}_{ij}^{\\text{new}} = \\mathbf{r}_i^{\\text{new}} - \\mathbf{r}_j^{\\text{new}} = (\\mathbf{r}_i - \\mathbf{r}_j) - \\alpha \\left(\\frac{1}{m_i} + \\frac{1}{m_j}\\right)(\\mathbf{r}_i - \\mathbf{r}_j) = \\left(1 - \\alpha \\left(\\frac{1}{m_i} + \\frac{1}{m_j}\\right)\\right) \\mathbf{r}_{ij}\n$$\nThe squared length is $\\|\\mathbf{r}_{ij}^{\\text{new}}\\|^2 = \\left(1 - \\alpha \\left(\\frac{1}{m_i} + \\frac{1}{m_j}\\right)\\right)^2 \\|\\mathbf{r}_{ij}\\|^2$.\nThe key step in the specified algorithm is to linearize this relation with respect to $\\alpha$, which is assumed to be small:\n$$\n\\|\\mathbf{r}_{ij}^{\\text{new}}\\|^2 \\approx \\left(1 - 2\\alpha \\left(\\frac{1}{m_i} + \\frac{1}{m_j}\\right)\\right) \\|\\mathbf{r}_{ij}\\|^2\n$$\nWe want the new squared distance to be $d_{ij}^2$. Setting $\\|\\mathbf{r}_{ij}^{\\text{new}}\\|^2 = d_{ij}^2$ yields:\n$$\nd_{ij}^2 \\approx \\|\\mathbf{r}_{ij}\\|^2 - 2\\alpha \\left(\\frac{1}{m_i} + \\frac{1}{m_j}\\right) \\|\\mathbf{r}_{ij}\\|^2\n$$\nRearranging to solve for $\\alpha$ gives:\n$$\n2\\alpha \\left(\\frac{1}{m_i} + \\frac{1}{m_j}\\right) \\|\\mathbf{r}_{ij}\\|^2 \\approx \\|\\mathbf{r}_{ij}\\|^2 - d_{ij}^2\n$$\nWith $S = \\|\\mathbf{r}_{ij}\\|^2 = \\mathbf{r}_{ij} \\cdot \\mathbf{r}_{ij}$ and $g = S - d_{ij}^2$, we obtain the expression for $\\alpha$ as given in the problem:\n$$\n\\alpha = \\frac{g}{2 S \\left(\\frac{1}{m_i} + \\frac{1}{m_j}\\right)}\n$$\nThis confirms the scientific validity of the prescribed update rule.\n\nThe overall algorithm for each test case $(\\Delta t, \\tau)$ is implemented as follows:\n1.  Initialize the system masses ($m_0=16, m_1=1, m_2=1$), initial positions ($\\mathbf{r}_0=(0,0,0), \\mathbf{r}_1=(1,0,0), \\mathbf{r}_2=(-1,0,0)$), initial velocities ($\\mathbf{v}_0=(0,0,0), \\mathbf{v}_1=(0.5,0.2,0), \\mathbf{v}_2=(-0.5,0.2,0)$), and squared distances ($d_{01}^2=1, d_{02}^2=1$).\n2.  Calculate the trial positions $\\mathbf{r}^{(0)}$ using the forward Euler step with the given $\\Delta t$.\n3.  Compute the initial constraint violation $\\varepsilon(\\mathbf{r}^{(0)})$. If it is less than or equal to $\\tau$, the iteration count is $0$. This handles the trivial case where $\\Delta t = 0$.\n4.  If the initial violation exceeds $\\tau$, enter a loop that runs for a maximum of $N_{\\max} = 10000$ outer iterations.\n5.  In each outer iteration $k = 1, 2, \\ldots, N_{\\max}$:\n    a. Apply the update rule for the constraint between atoms $0$ and $1$, updating their positions $\\mathbf{r}_0$ and $\\mathbf{r}_1$.\n    b. Using the newly updated position for $\\mathbf{r}_0$, apply the update rule for the constraint between atoms $0$ and $2$, updating positions $\\mathbf{r}_0$ and $\\mathbf{r}_2$.\n    c. Re-calculate the constraint violation $\\varepsilon$ with the fully updated positions.\n    d. If $\\varepsilon \\le \\tau$, convergence is achieved. The iteration count is $k$. The loop terminates.\n6.  If the loop completes without achieving convergence, the iteration count is reported as $-1$.\n\nThis procedure is implemented in Python using the `numpy` library for efficient vector and matrix operations. The implementation carefully handles the sequential updates and termination conditions for each of the five test cases. The resulting iteration counts are collected and formatted as specified. For the case with a very small tolerance, $\\tau = 10^{-30}$, convergence is limited by the machine precision of standard double-precision floating-point arithmetic (approximately $10^{-16}$). If the error cannot be reduced below this limit, the algorithm will not converge to the specified tolerance and will time out, resulting in an iteration count of $-1$.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test cases.\n    \"\"\"\n    test_cases = [\n        (0.0, 1e-12),\n        (5e-3, 1e-12),\n        (2e-2, 1e-12),\n        (1e-1, 1e-12),\n        (1e-1, 1e-30),\n    ]\n\n    results = []\n    for dt, tau in test_cases:\n        count = calculate_iterations(dt, tau)\n        results.append(count)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef calculate_iterations(dt, tau):\n    \"\"\"\n    Calculates the number of SHAKE iterations for a given time step and tolerance.\n    \"\"\"\n    # Initial data\n    masses = np.array([16.0, 1.0, 1.0])\n    d_sq = np.array([1.0, 1.0])  # d_01^2, d_02^2\n    r_initial = np.array([[0.0, 0.0, 0.0], [1.0, 0.0, 0.0], [-1.0, 0.0, 0.0]])\n    v_initial = np.array([[0.0, 0.0, 0.0], [0.5, 0.2, 0.0], [-0.5, 0.2, 0.0]])\n    N_max = 10000\n\n    # Unconstrained trial positions\n    r = r_initial + dt * v_initial\n    \n    # Check initial violation\n    g01 = np.sum((r[0] - r[1])**2) - d_sq[0]\n    g02 = np.sum((r[0] - r[2])**2) - d_sq[1]\n    error = max(abs(g01), abs(g02))\n    \n    if error = tau:\n        return 0\n\n    # Iterative enforcement loop\n    for k in range(1, N_max + 1):\n        # Apply constraint (0, 1)\n        r_ij = r[0] - r[1]\n        S = np.dot(r_ij, r_ij)\n        if S == 0.0: return -1 # Atom collision, invalid state\n        g = S - d_sq[0]\n        inv_mass_sum = 1.0/masses[0] + 1.0/masses[1]\n        alpha = g / (2.0 * S * inv_mass_sum)\n        \n        delta_r0 = - (alpha / masses[0]) * r_ij\n        delta_r1 = + (alpha / masses[1]) * r_ij\n        \n        r[0] += delta_r0\n        r[1] += delta_r1\n\n        # Apply constraint (0, 2)\n        r_ij = r[0] - r[2]\n        S = np.dot(r_ij, r_ij)\n        if S == 0.0: return -1 # Atom collision, invalid state\n        g = S - d_sq[1]\n        inv_mass_sum = 1.0/masses[0] + 1.0/masses[2]\n        alpha = g / (2.0 * S * inv_mass_sum)\n\n        delta_r0 = - (alpha / masses[0]) * r_ij\n        delta_r2 = + (alpha / masses[2]) * r_ij\n        \n        r[0] += delta_r0\n        r[2] += delta_r2\n\n        # Check for convergence\n        g01 = np.sum((r[0] - r[1])**2) - d_sq[0]\n        g02 = np.sum((r[0] - r[2])**2) - d_sq[1]\n        error = max(abs(g01), abs(g02))\n\n        if error = tau:\n            return k\n            \n    return -1 # Not converged within N_max iterations\n\nsolve()\n```", "id": "2453574"}, {"introduction": "Molecular dynamics simulations of bulk materials rely on Periodic Boundary Conditions (PBC) to mimic an infinite system. This introduces a new challenge: how to correctly apply a distance constraint to two atoms that may be on opposite sides of the simulation box? This problem [@problem_id:2453492] challenges you to apply the Minimum Image Convention, a fundamental concept in computational physics, to ensure the SHAKE algorithm operates on the true physical separation between atoms.", "problem": "You are simulating a diatomic molecule with a fixed bond length using the SHAKE constraint algorithm in Molecular Dynamics (MD) under Periodic Boundary Conditions (PBC). The system is an orthorhombic periodic box with edge lengths $L_x$, $L_y$, and $L_z$. At the end of an unconstrained integration step, atom $i$ has position $\\mathbf{r}_i^{\\ast}$ and atom $j$ has position $\\mathbf{r}_j^{\\ast}$. The bond between $i$ and $j$ is constrained to a target distance $d_{0}$, but at this step the two atoms happen to lie on opposite sides of a periodic boundary, so that the raw difference $\\mathbf{r}_j^{\\ast} - \\mathbf{r}_i^{\\ast}$ points across the box. You now need to apply SHAKE to enforce the bond-length constraint for this pair.\n\nWhich procedure best ensures that the constraint is enforced correctly and consistently with PBC while preserving linear momentum conservation at the level of the SHAKE corrections?\n\nA. Compute the relative vector using periodic imaging so that it is the minimum-image separation $\\mathbf{r}_{ij}^{\\text{min}}$, solve the SHAKE correction along $\\mathbf{r}_{ij}^{\\text{min}}$ with mass-weighted equal-and-opposite displacements of atoms $i$ and $j$, update the positions, and then rewrap the corrected positions into the primary simulation box.\n\nB. Temporarily disable PBC for this bond by unwrapping the coordinates of atoms $i$ and $j$ into the same image, enforce SHAKE in absolute coordinates without any image mapping, and keep the unwrapped positions thereafter to avoid future crossings.\n\nC. Use the raw coordinate difference $\\mathbf{r}_j^{\\ast} - \\mathbf{r}_i^{\\ast}$ across the boundary to compute and apply the SHAKE corrections, because SHAKE enforces the scalar distance $d_{0}$ irrespective of the orientation and magnitude of the correction vector.\n\nD. Translate both atoms by the same vector so that they lie in the same box image, apply SHAKE using the in-box difference, and retain the common translation so that other interactions are unaffected by the constraint update.", "solution": "The problem statement must first be validated for scientific and logical integrity.\n\n### Step 1: Extract Givens\n- **System**: A diatomic molecule with atoms $i$ and $j$.\n- **Algorithm**: SHAKE constraint algorithm for Molecular Dynamics (MD).\n- **Boundary Conditions**: Periodic Boundary Conditions (PBC) in an orthorhombic box.\n- **Box Dimensions**: Edge lengths $L_x$, $L_y$, and $L_z$.\n- **Constraint**: The bond length between atoms $i$ and $j$ is fixed to a target distance $d_{0}$.\n- **Initial State (Unconstrained)**: After an integration step, atom positions are $\\mathbf{r}_i^{\\ast}$ and $\\mathbf{r}_j^{\\ast}$.\n- **Specific Condition**: Atoms $i$ and $j$ are on opposite sides of a periodic boundary, meaning the raw difference vector $\\mathbf{r}_j^{\\ast} - \\mathbf{r}_i^{\\ast}$ spans the simulation box.\n- **Objective**: Determine the correct procedure to enforce the bond-length constraint that is consistent with PBC and conserves linear momentum for the SHAKE correction.\n\n### Step 2: Validate Using Extracted Givens\nThe problem describes a standard, fundamental challenge in implementing constraint algorithms within periodic boundary conditions for molecular simulations.\n- **Scientifically Grounded**: The problem is based on established principles of computational chemistry and physics. The SHAKE algorithm and Periodic Boundary Conditions are cornerstone techniques in Molecular Dynamics. The scenario of a bond crossing a periodic boundary is a common occurrence that simulation software must handle correctly.\n- **Well-Posed**: The problem is clearly stated and asks for the correct procedure among a set of options. A unique, correct methodology exists and is well-documented in the literature of molecular simulation.\n- **Objective**: The language is technical, precise, and free of subjective content.\n\nThe problem statement is scientifically sound, well-posed, objective, and contains no internal contradictions or missing information necessary to evaluate the proposed procedures. It does not violate any of the specified invalidity criteria.\n\n### Step 3: Verdict and Action\nThe problem is **valid**. A solution will be derived and the options evaluated.\n\n### Derivation of the Correct Procedure\n\nIn Molecular Dynamics simulations with Periodic Boundary Conditions (PBC), the simulation box is conceptually replicated infinitely in space. The physical interaction between any two particles, say $i$ and $j$, must be based on the shortest possible distance between them, considering all periodic images of particle $j$ relative to particle $i$ (or vice-versa). This principle is known as the **Minimum Image Convention (MIC)**.\n\nLet the unconstrained positions at the end of a time step be $\\mathbf{r}_i^{\\ast}$ and $\\mathbf{r}_j^{\\ast}$. The raw vector difference is $\\mathbf{d} = \\mathbf{r}_j^{\\ast} - \\mathbf{r}_i^{\\ast}$. To apply the MIC, we adjust this vector by integer multiples of the box vectors ($\\mathbf{L} = (L_x, L_y, L_z)$) to find the vector with the minimum magnitude. For an orthorhombic box, this is done component-wise. For the $x$-component, for instance:\n$d_x^{\\text{min}} = d_x - L_x \\cdot \\text{round}(d_x / L_x)$.\nThe resulting vector, $\\mathbf{r}_{ij}^{\\text{min}}$, with components $(d_x^{\\text{min}}, d_y^{\\text{min}}, d_z^{\\text{min}})$, represents the true, physical separation of the two bonded atoms.\n\nThe SHAKE algorithm is designed to correct positions to satisfy geometric constraints. For a distance constraint $\\sigma = |\\mathbf{r}_{ij}|^2 - d_0^2 = 0$, the positions are updated as:\n$$ \\mathbf{r}_k = \\mathbf{r}_k^{\\ast} + \\delta \\mathbf{r}_k $$\nThe corrections $\\delta \\mathbf{r}_k$ are directed along the gradient of the constraint function. For the bond between atoms $i$ and $j$, the constraint force is internal to the pair and acts along the vector connecting them. To conserve the linear momentum of the pair, the sum of the momentum corrections must be zero: $m_i \\delta \\mathbf{r}_i + m_j \\delta \\mathbf{r}_j = \\mathbf{0}$. This is achieved by setting the position corrections to be parallel to the bond vector $\\mathbf{r}_{ij}$ and inversely proportional to the mass:\n$$ \\delta \\mathbf{r}_i = -\\frac{\\lambda}{m_i} \\mathbf{r}_{ij} $$\n$$ \\delta \\mathbf{r}_j = +\\frac{\\lambda}{m_j} \\mathbf{r}_{ij} $$\nwhere $\\lambda$ is a Lagrange multiplier determined by solving the constraint equation $|\\mathbf{r}_j - \\mathbf{r}_i|^2 = d_0^2$.\n\nCrucially, the vector $\\mathbf{r}_{ij}$ used in these equations must be the physically meaningful separation, which under PBC is the minimum image vector, $\\mathbf{r}_{ij}^{\\text{min}}$. Using the raw, \"unwrapped\" vector that crosses the box would correspond to an immense, unphysical distance, leading to a catastrophically large and incorrect corrective force.\n\nThe correct sequence of operations is therefore:\n1.  For the constrained pair $(i, j)$, calculate the difference vector $\\mathbf{r}_j^{\\ast} - \\mathbf{r}_i^{\\ast}$.\n2.  Apply the Minimum Image Convention to this vector to obtain the physically correct separation vector, $\\mathbf{r}_{ij}^{\\text{min}}$.\n3.  Use $\\mathbf{r}_{ij}^{\\text{min}}$ to solve the SHAKE equations, yielding mass-weighted, momentum-conserving position corrections $\\delta \\mathbf{r}_i$ and $\\delta \\mathbf{r}_j$.\n4.  Apply these corrections to obtain the final, constrained positions: $\\mathbf{r}_i = \\mathbf{r}_i^{\\ast} + \\delta \\mathbf{r}_i$ and $\\mathbf{r}_j = \\mathbf{r}_j^{\\ast} + \\delta \\mathbf{r}_j$.\n5.  After all constraints for all atoms have been satisfied (which may take several iterative SHAKE loops), the final positions may be re-wrapped into the primary simulation box (e.g., mapping all coordinates into $[0, L_x)$, etc.). This re-wrapping is a cosmetic step for bookkeeping and does not affect the physics of the system.\n\n### Evaluation of Options\n\n**A. Compute the relative vector using periodic imaging so that it is the minimum-image separation $\\mathbf{r}_{ij}^{\\text{min}}$, solve the SHAKE correction along $\\mathbf{r}_{ij}^{\\text{min}}$ with mass-weighted equal-and-opposite displacements of atoms $i$ and $j$, update the positions, and then rewrap the corrected positions into the primary simulation box.**\nThis procedure precisely matches the derived correct methodology.\n- It correctly prioritizes the MIC to find the physical separation vector $\\mathbf{r}_{ij}^{\\text{min}}$.\n- It correctly applies the SHAKE correction along this vector.\n- The phrase \"mass-weighted equal-and-opposite displacements\" is a slightly imprecise but common description for the momentum-conserving updates where $\\delta \\mathbf{r}_i$ and $\\delta \\mathbf{r}_j$ are oppositely directed and scaled by the inverse of their respective masses.\n- It correctly identifies re-wrapping as a final, post-update step.\n**Verdict: Correct.**\n\n**B. Temporarily disable PBC for this bond by unwrapping the coordinates of atoms $i$ and $j$ into the same image, enforce SHAKE in absolute coordinates without any image mapping, and keep the unwrapped positions thereafter to avoid future crossings.**\nThis procedure begins correctly by \"unwrapping,\" which is equivalent to finding the minimum image separation. However, the instruction to \"keep the unwrapped positions thereafter\" is a fatal error. This breaks the PBC framework for the entire system. If an atom's coordinates are allowed to drift far outside the primary box, its interactions with all other particles in the system will be calculated incorrectly, as they will no longer be subject to the minimum image convention. This corrupts the simulation of a periodic system.\n**Verdict: Incorrect.**\n\n**C. Use the raw coordinate difference $\\mathbf{r}_j^{\\ast} - \\mathbf{r}_i^{\\ast}$ across the boundary to compute and apply the SHAKE corrections, because SHAKE enforces the scalar distance $d_{0}$ irrespective of the orientation and magnitude of the correction vector.**\nThis is fundamentally incorrect. The raw coordinate difference is an unphysical vector whose magnitude is determined by the box size, not the bond length. Using it in the SHAKE algorithm would generate enormous, unphysical forces that would attempt to pull the atoms across the box, completely disrupting the simulation. The justification provided is also false; the SHAKE correction's magnitude and direction are directly dependent on the current inter-atomic vector. This procedure violates the Minimum Image Convention, a mandatory principle for force and constraint calculations in PBC.\n**Verdict: Incorrect.**\n\n**D. Translate both atoms by the same vector so that they lie in the same box image, apply SHAKE using the in-box difference, and retain the common translation so that other interactions are unaffected by the constraint update.**\nThis option is logically flawed. If you translate **both** atoms by the **same** vector $\\mathbf{V}$, their relative vector $(\\mathbf{r}_j+\\mathbf{V}) - (\\mathbf{r}_i+\\mathbf{V}) = \\mathbf{r}_j - \\mathbf{r}_i$ remains unchanged. This does not solve the problem of the bond crossing the boundary. The premise of the proposed action is nonsensical. Furthermore, \"retaining the common translation\" constitutes a shift of the center of mass of the pair, which violates conservation of linear momentum. This procedure is ill-defined and physically incorrect.\n**Verdict: Incorrect.**", "answer": "$$\\boxed{A}$$", "id": "2453492"}, {"introduction": "A successful simulation is not just one that runs without crashing, but one that is physically correct. In a constant-energy (NVE) ensemble, the total energy of the system should be conserved, but numerical errors can cause it to drift over time. This practice problem [@problem_id:2453550] places you in the role of a researcher debugging an energy drift, forcing you to devise a diagnostic test to distinguish between errors originating from the integrator and those from the SHAKE constraint solver.", "problem": "You have implemented the SHAKE constraint algorithm (commonly referred to as SHAKE) to enforce holonomic bond-length constraints of the form $g_k(\\mathbf{r}) = \\left\\lVert \\mathbf{r}_i - \\mathbf{r}_j \\right\\rVert^2 - \\ell_{ij}^2 = 0$ in a Molecular Dynamics (MD) code that uses the Velocity Verlet (VV) integrator. Positions are corrected iteratively by solving for Lagrange multipliers $\\boldsymbol{\\lambda}$ and applying mass-weighted displacements $\\delta \\mathbf{r} = \\mathbf{M}^{-1} \\mathbf{G}^\\top \\boldsymbol{\\lambda}$ until the maximum absolute constraint residual is below a tolerance $\\varepsilon = 10^{-6}$ (in internal units) or a maximum number of iterations $N_{\\mathrm{max}} = 100$ is reached. Velocities are corrected consistently at the end of the step. You run a constant Number, Volume, Energy ensemble (NVE) simulation of a rigid water model where the constrained bonds are time-independent, with a time step $\\Delta t = 1\\,\\mathrm{fs}$, and $N_{\\mathrm{max}} = 100$. Over $10^5$ steps, the total energy exhibits a nearly linear drift of about $1\\,\\%$. You have verified that nonbonded forces are computed using the constrained positions. \n\nWhich of the following is the most appropriate first diagnostic test to determine whether the observed energy drift is primarily due to the constraint solver versus the base integrator settings?\n\nA. Halve the time step to $\\Delta t = 0.5\\,\\mathrm{fs}$ while keeping $\\varepsilon$ and $N_{\\mathrm{max}}$ unchanged, and compare the energy drift per unit time; a strong reduction in drift upon halving $\\Delta t$ indicates time-step or integrator error, whereas little change suggests constraint-solver error.\n\nB. Disable constraints entirely and rerun the simulation at the same $\\Delta t$; if the unconstrained system conserves energy, conclude that the SHAKE algorithm is the root cause.\n\nC. Switch all arithmetic from double precision to single precision to reduce cancellation error in the iterative solver and assess whether the drift improves.\n\nD. Reduce the maximum number of SHAKE iterations to $N_{\\mathrm{max}} = 1$ to avoid overcorrecting the constraints and thereby prevent numerical energy injection.\n\nE. Increase the target temperature by applying a thermostat at $600\\,\\mathrm{K}$ to mask the drift and check if the average energy becomes stationary.", "solution": "The problem statement must first be validated for scientific and logical integrity.\n\n### Step 1: Extract Givens\n- **Ensemble:** Constant Number, Volume, Energy (NVE).\n- **Integrator:** Velocity Verlet (VV).\n- **Constraint Algorithm:** SHAKE.\n- **System:** Rigid water model with time-independent holonomic bond-length constraints.\n- **Constraint Form:** $g_k(\\mathbf{r}) = \\left\\lVert \\mathbf{r}_i - \\mathbf{r}_j \\right\\rVert^2 - \\ell_{ij}^2 = 0$.\n- **SHAKE Update:** Positions are corrected iteratively via $\\delta \\mathbf{r} = \\mathbf{M}^{-1} \\mathbf{G}^\\top \\boldsymbol{\\lambda}$.\n- **Simulation Parameters:**\n    - Time step: $\\Delta t = 1\\,\\mathrm{fs}$.\n    - SHAKE tolerance: $\\varepsilon = 10^{-6}$ (in internal units).\n    - SHAKE max iterations: $N_{\\mathrm{max}} = 100$.\n- **Observation:** Total energy exhibits a nearly linear drift of approximately $1\\,\\%$ over $10^5$ steps.\n- **Verification:** Nonbonded forces are computed using the constrained positions.\n- **Objective:** Identify the most appropriate first diagnostic test to differentiate between energy drift caused by the constraint solver versus the base integrator.\n\n### Step 2: Validate Using Extracted Givens\nThe problem describes a standard scenario in molecular dynamics (MD) simulations. A Velocity Verlet integrator is combined with the SHAKE algorithm to simulate a rigid molecule in the NVE ensemble. Energy conservation is a critical test of correctness for such simulations.\n\n- **Scientifically Grounded:** The setup is entirely standard. The VV integrator, the SHAKE algorithm, the form of the constraint equations, the use of an NVE ensemble to check energy conservation, and the parameters for simulating water are all consistent with established practices in computational chemistry and physics. The observed energy drift is a common artifact that requires diagnosis. The statement is scientifically sound.\n- **Well-Posed:** The problem asks for a methodological choice—a diagnostic test—to distinguish between two potential sources of error. Given the context, this is a well-posed question in the domain of scientific computing and simulation validation.\n- **Objective:** The problem is stated in precise, technical terms, free of subjectivity.\n- **Completeness and Consistency:** The provided information is sufficient to evaluate the proposed diagnostic tests. There are no internal contradictions. For example, it is correctly noted that nonbonded forces are computed with the *constrained* positions, which is a necessary condition for a correct implementation.\n\n### Step 3: Verdict and Action\nThe problem statement is valid. It is scientifically sound, well-posed, and provides sufficient context for a rigorous analysis of the proposed options. I will proceed with the solution.\n\n### Derivation and Option Analysis\n\nThe total energy of the system is $E_{\\text{tot}} = E_{\\text{kin}}(\\mathbf{v}) + V(\\mathbf{r})$. In a perfect NVE simulation of a Hamiltonian system, $\\frac{dE_{\\text{tot}}}{dt} = 0$. In a numerical simulation, we observe drift, $\\Delta E_{\\text{tot}} \\neq 0$, due to multiple sources of error. The challenge is to identify the dominant source.\n\nThe Velocity Verlet algorithm, when applied to an unconstrained system, is symplectic. This means it conserves a \"shadow\" Hamiltonian that is close to the true Hamiltonian, resulting in excellent long-term energy conservation, characterized by bounded fluctuations around a constant value, with minimal to no systematic drift. The magnitude of these fluctuations scales as $O(\\Delta t^2)$.\n\nThe introduction of holonomic constraints via an iterative algorithm like SHAKE, which is applied *after* the unconstrained VV step, breaks the symplecticity of the integrator. The total algorithm, VV-SHAKE, is no longer symplectic. This non-symplecticity is a primary source of systematic energy drift. The total error in a VV-SHAKE simulation arises from two main components:\n1.  **Integrator Discretization Error:** This error is inherent to the Velocity Verlet algorithm itself and is a function of the time step $\\Delta t$. The local error is $O(\\Delta t^4)$, and the global drift in energy is expected to show a strong dependence on $\\Delta t$, typically scaling as some power like $O(\\Delta t^p)$ where $p \\ge 2$.\n2.  **Constraint Solver Error:** This error stems from the fact that the SHAKE algorithm solves the constraint equations iteratively and to a finite tolerance $\\varepsilon$. If the algorithm fails to converge within $N_{\\mathrm{max}}$ iterations, or if the tolerance $\\varepsilon$ is too large, the constraints $g_k(\\mathbf{r}) = 0$ are not perfectly satisfied. This means the work done by the constraint forces is not exactly zero, leading to a net injection or removal of energy from the system in each step. This error depends on $\\varepsilon$, $N_{\\mathrm{max}}$, and properties of the system, but also on $\\Delta t$, as a smaller time step results in a smaller unconstrained displacement, making it easier for SHAKE to converge.\n\nThe goal is to design a test that can distinguish a failure in component (1) from a failure in component (2).\n\n**Option A: Halve the time step to $\\Delta t = 0.5\\,\\mathrm{fs}$ while keeping $\\varepsilon$ and $N_{\\mathrm{max}}$ unchanged, and compare the energy drift per unit time; a strong reduction in drift upon halving $\\Delta t$ indicates time-step or integrator error, whereas little change suggests constraint-solver error.**\n\nThis is a standard and rigorous approach to diagnosing time-step-related errors. The error contribution from the VV integrator is highly sensitive to $\\Delta t$. If the observed drift of $1\\,\\%$ is primarily due to the time step being too large for the potential energy surface, halving $\\Delta t$ from $1\\,\\mathrm{fs}$ to $0.5\\,\\mathrm{fs}$ should drastically reduce the energy drift rate. For instance, if the drift rate scales as $O(\\Delta t^2)$, it should decrease by a factor of $4$. Conversely, if the problem lies fundamentally with the SHAKE solver (e.g., a bug in the implementation, or a particularly stiff configuration that causes convergence issues irrespective of a reasonable $\\Delta t$), the drift may not be as sensitive to the change in $\\Delta t$. While a smaller $\\Delta t$ helps SHAKE convergence, a persistent, large drift that is only marginally reduced would point toward the constraint solver as the primary culprit. This method effectively isolates the influence of the time step, which is the defining parameter of the base integrator's accuracy.\n\n**Verdict: Correct.**\n\n**Option B: Disable constraints entirely and rerun the simulation at the same $\\Delta t$; if the unconstrained system conserves energy, conclude that the SHAKE algorithm is the root cause.**\n\nThis is an invalid diagnostic procedure. The system is a rigid water model. The \"rigidity\" is enforced by constraints. If constraints are disabled, the model becomes flexible. The intramolecular bond-stretching and angle-bending vibrations in a flexible water model have very high frequencies. To integrate these motions stably using the Velocity Verlet algorithm, a much smaller time step is required, typically on the order of $0.1\\,\\mathrm{fs}$ to $0.2\\,\\mathrm{fs}$. Attempting to simulate a flexible water model with $\\Delta t = 1\\,\\mathrm{fs}$ will lead to resonance and immediate numerical instability, causing the energy to explode. The simulation will not conserve energy; it will fail catastrophically. Therefore, the comparison proposed is physically and numerically meaningless. One cannot learn anything about SHAKE's performance by comparing it to an unstable simulation.\n\n**Verdict: Incorrect.**\n\n**Option C: Switch all arithmetic from double precision to single precision to reduce cancellation error in the iterative solver and assess whether the drift improves.**\n\nThis suggestion is counter-intuitive and incorrect. Double precision uses approximately $64$ bits to represent a floating-point number, offering about $15-17$ decimal digits of precision. Single precision uses $32$ bits, offering about $7$ decimal digits. The iterative solution of the coupled non-linear equations in SHAKE is sensitive to numerical precision. Switching to single precision will increase round-off errors, not decrease them. Cancellation error, which occurs when subtracting nearly equal numbers, is a form of round-off error that becomes more severe with lower precision. Therefore, this change would almost certainly worsen the satisfaction of constraints and lead to a larger, not smaller, energy drift.\n\n**Verdict: Incorrect.**\n\n**Option D: Reduce the maximum number of SHAKE iterations to $N_{\\mathrm{max}} = 1$ to avoid overcorrecting the constraints and thereby prevent numerical energy injection.**\n\nThis demonstrates a misunderstanding of iterative solvers. SHAKE corrects positions to satisfy constraints. For a system like water, it typically requires several iterations (e.g., $3-8$) per time step to converge to a tight tolerance. Limiting it to $N_{\\mathrm{max}} = 1$ ensures that the algorithm terminates prematurely, far from the correct solution. The constraints will be poorly satisfied at the end of the step. This failure to enforce the geometry correctly is a direct cause of energy drift. The concept of \"overcorrecting\" is not applicable here; the problem is \"undercorrecting\" due to insufficient iteration. This action would increase, not decrease, the energy drift.\n\n**Verdict: Incorrect.**\n\n**Option E: Increase the target temperature by applying a thermostat at $600\\,\\mathrm{K}$ to mask the drift and check if the average energy becomes stationary.**\n\nThis approach invalidates the very premise of the diagnosis. The problem is observed in an NVE ensemble, where total energy is the conserved quantity of interest. Applying a thermostat changes the ensemble to NVT. A thermostat's function is to add or remove energy to maintain a target temperature, thereby breaking energy conservation by design. Any intrinsic drift from the integrator or constraint algorithm would be completely obscured by the much larger energy fluctuations imposed by the thermostat. Checking if the \"average energy becomes stationary\" is not a meaningful diagnostic for an NVT simulation, where energy is expected to fluctuate around a mean value determined by the temperature. This procedure does not diagnose the problem; it hides it.\n\n**Verdict: Incorrect.**\n\nIn summary, the only scientifically sound and standard diagnostic procedure among the options is to test the system's sensitivity to the integration time step, as described in option A.", "answer": "$$\\boxed{A}$$", "id": "2453550"}]}