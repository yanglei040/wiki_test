{"hands_on_practices": [{"introduction": "The power of adaptive solvers lies in their ability to automatically adjust the step size $h$ to meet a desired accuracy. This process is not arbitrary; it's based on a clear control principle. This first practice invites you to derive this principle from the ground up, using the difference between two numerical methods of different orders to create an error estimate and formulate a rule for choosing the next, optimal step size.", "problem": "In the field of numerical analysis, adaptive step-size methods are crucial for efficiently solving an Ordinary Differential Equation (ODE) of the form $y'(t) = f(t, y)$ with an initial condition $y(t_0) = y_0$. These methods adjust the step size, $h$, to maintain a desired level of accuracy.\n\nConsider two numerical methods for approximating the solution at $t_0+h$:\n1.  **Forward Euler Method**: The approximation, which we will call $y_1$, is given by:\n    $$y_1 = y_0 + h f(t_0, y_0)$$\n2.  **Heun's Method (Improved Euler)**: The approximation, which we will call $y_2$, is given by:\n    $$y_2 = y_0 + \\frac{h}{2} \\left[ f(t_0, y_0) + f(t_0+h, y_0 + hf(t_0,y_0)) \\right]$$\n\nThe local truncation error of the Forward Euler method is second-order, meaning it is proportional to the square of the step size, $h^2$. Heun's method, being more accurate, has a local truncation error of a higher order. A common strategy for step-size control is to use the difference between the two approximations, $|y_2 - y_1|$, as an estimate for the error of the less accurate method (Forward Euler) for the current step size $h$.\n\nYour task is to derive a control rule for the next step size, $h_{\\text{new}}$. Assume the current step of size $h$ produced the approximations $y_1$ and $y_2$. The goal is to choose $h_{\\text{new}}$ such that the estimated error for the next step would be equal to a predefined target tolerance, $\\epsilon$. Find an expression for $h_{\\text{new}}$ in terms of $h$, $\\epsilon$, $y_1$, and $y_2$.", "solution": "Let $y(t)$ denote the exact solution. The Forward Euler method has local truncation error of order $h^{2}$, so for some constant $K$ depending on derivatives of $f$ at $(t_{0},y_{0})$,\n$$\ny_{1}=y(t_{0}+h)-K h^{2}+O(h^{3}).\n$$\nHeun’s method is of higher order, with local truncation error $O(h^{3})$, so\n$$\ny_{2}=y(t_{0}+h)+O(h^{3}).\n$$\nSubtracting gives\n$$\ny_{2}-y_{1}=K h^{2}+O(h^{3}),\n$$\nhence the magnitude of the Forward Euler local error at step size $h$ can be estimated by\n$$\nE(h)\\approx |y_{2}-y_{1}|\\approx |K| h^{2}.\n$$\nAssuming the same local constant $K$ applies at the next step, the error for a new step size $h_{\\text{new}}$ satisfies\n$$\nE(h_{\\text{new}})\\approx |K| h_{\\text{new}}^{2}.\n$$\nEliminate $|K|$ using $|K|\\approx |y_{2}-y_{1}|/h^{2}$ to obtain\n$$\nE(h_{\\text{new}})\\approx \\frac{|y_{2}-y_{1}|}{h^{2}}\\,h_{\\text{new}}^{2}.\n$$\nImpose the control target $E(h_{\\text{new}})=\\epsilon$ and solve for $h_{\\text{new}}$:\n$$\n\\epsilon=\\frac{|y_{2}-y_{1}|}{h^{2}}\\,h_{\\text{new}}^{2}\n\\quad\\Longrightarrow\\quad\nh_{\\text{new}}=h\\left(\\frac{\\epsilon}{|y_{2}-y_{1}|}\\right)^{\\frac{1}{2}}.\n$$\nThis expresses the next step size in terms of $h$, $\\epsilon$, $y_{1}$, and $y_{2}$ using the error estimate provided by the embedded pair (Forward Euler, Heun).", "answer": "$$\\boxed{h\\left(\\frac{\\epsilon}{|y_{2}-y_{1}|}\\right)^{\\frac{1}{2}}}$$", "id": "2181287"}, {"introduction": "Now that we understand the basic mechanism for step-size control [@problem_id:2181287], let's put it under pressure. This exercise examines a critical scenario where an explicit solver tackles a stiff ODE, with its step size right on the boundary of stability. By calculating the very next proposed step, you will uncover the dramatic conflict between the solver's accuracy-based error estimate and the unforgiving demands of numerical stability, a key challenge in scientific computing.", "problem": "An engineer is using a numerical routine to simulate a process governed by a first-order stiff Ordinary Differential Equation (ODE). The routine employs an adaptive step size strategy. The integration is performed using Heun's method (also known as the improved Euler method or a second-order Runge-Kutta method), which advances the solution from time $t_n$ to $t_{n+1} = t_n + h$ using the following steps:\n1.  $k_1 = f(t_n, y_n)$\n2.  $k_2 = f(t_n + h, y_n + h k_1)$\n3.  $y_{n+1} = y_n + \\frac{h}{2}(k_1 + k_2)$\n\nTo control the step size, the local error at each step is estimated by comparing the result of Heun's method, $y_{n+1}$, with the result from the simpler forward Euler method, $\\hat{y}_{n+1} = y_n + h k_1$. The local error estimate is defined as $\\text{err}_{n+1} = |y_{n+1} - \\hat{y}_{n+1}|$.\n\nThe step size is then adjusted using the standard proportional-integral controller formula, simplified for this analysis to its proportional part:\n$$h_{n+1} = h_n \\left( \\frac{\\text{TOL}}{\\text{err}_{n+1}} \\right)^{p}$$\nwhere $h_n$ is the current step size, $h_{n+1}$ is the proposed next step size, $\\text{TOL}$ is the desired error tolerance, and the exponent $p$ is given by $p = 1/(q+1)$, where $q$ is the order of the lower-order method used for error estimation (in this case, the forward Euler method, which has order $q=1$).\n\nThe system being modeled is the stiff problem $y' = -\\lambda y$, with $\\lambda = 5 \\times 10^5~\\text{s}^{-1}$. The simulation starts at $t_0=0$ with an initial value $y(0) = y_0 = 0.1$. The error tolerance is set to $\\text{TOL} = 2.0 \\times 10^{-8}$.\n\nSuppose that, due to the sharp initial transient, the step size controller has chosen an initial step size $h_0$ that places the dimensionless product $h_0 \\lambda$ precisely at the extreme negative real boundary of the absolute stability region of Heun's method.\n\nCalculate the ratio of the proposed next step size, $h_1$, to the current step size, $h_0$. Round your final answer to four significant figures.", "solution": "For the linear test equation $y'=-\\lambda y$ with $\\lambda>0$, applying Heun's method gives\n$$\nk_{1}=-\\lambda y_{n},\\quad k_{2}=-\\lambda\\left(y_{n}+h k_{1}\\right)=-\\lambda y_{n}+h\\lambda^{2}y_{n}.\n$$\nThus\n$$\ny_{n+1}=y_{n}+\\frac{h}{2}\\left(k_{1}+k_{2}\\right)=y_{n}-h\\lambda y_{n}+\\frac{h^{2}}{2}\\lambda^{2}y_{n}.\n$$\nThe forward Euler result is\n$$\n\\hat{y}_{n+1}=y_{n}+h k_{1}=y_{n}-h\\lambda y_{n}.\n$$\nTherefore the local error estimate is\n$$\n\\text{err}_{n+1}=\\left|y_{n+1}-\\hat{y}_{n+1}\\right|=\\left|\\frac{h^{2}}{2}\\lambda^{2}y_{n}\\right|=\\frac{h^{2}}{2}\\lambda^{2}\\left|y_{n}\\right|.\n$$\n\nFor Heun's method, the stability function is $R(z)=1+z+\\frac{z^{2}}{2}$. Along the negative real axis, the absolute stability interval is $z\\in[-2,0]$, with the extreme negative boundary at $z=-2$. For $y'=-\\lambda y$, one has $z=-h\\lambda$, so the condition $z=-2$ implies\n$$\nh_{0}\\lambda=2.\n$$\nAt the first step, $y_{0}=0.1$, hence\n$$\n\\text{err}_{1}=\\frac{h_{0}^{2}}{2}\\lambda^{2}\\left|y_{0}\\right|=\\frac{1}{2}\\left(h_{0}\\lambda\\right)^{2}\\left|y_{0}\\right|=\\frac{1}{2}\\cdot 4 \\cdot 0.1=0.2.\n$$\n\nWith proportional controller exponent $p=\\frac{1}{q+1}=\\frac{1}{2}$ (since $q=1$ for Euler), the step update is\n$$\n\\frac{h_{1}}{h_{0}}=\\left(\\frac{\\text{TOL}}{\\text{err}_{1}}\\right)^{1/2}=\\left(\\frac{2.0\\times 10^{-8}}{0.2}\\right)^{1/2}=\\left(10^{-7}\\right)^{1/2}=10^{-3.5}=3.162277660\\ldots\\times 10^{-4}.\n$$\nRounded to four significant figures, this ratio is $3.162\\times 10^{-4}$.", "answer": "$$\\boxed{3.162 \\times 10^{-4}}$$", "id": "2153280"}, {"introduction": "After analyzing a single, critical step [@problem_id:2153280], we now zoom out to view the entire journey of the solver. The history of the step size, $h(t)$, is like a diagnostic log that reveals the hidden nature of the ODE system. This practice teaches you to interpret these logs to distinguish between a well-behaved (non-stiff) problem and a numerically 'stiff' one, a crucial practical skill for any computational scientist.", "problem": "Two ordinary differential equation (ODE) initial value problems are integrated over $t\\in[0,10]$ with the same explicit embedded Runge–Kutta method of order $p=5$, using standard local error control with relative tolerance $\\mathrm{rtol}=10^{-6}$, absolute tolerance $\\mathrm{atol}=10^{-12}$, a safety factor $S\\in(0,1)$, and initial step $h(0)=10^{-3}$. The problems are:\n- System $S$: $y^{\\prime}(t)=-\\lambda\\,y(t)$ with $\\lambda=10^{4}$ and $y(0)=1$.\n- System $N$: $y^{\\prime}(t)=-y(t)$ with $y(0)=1$.\n\nTwo runs are performed, one on each system, producing the following observed step-size histories $h(t)$:\n- Run $\\mathrm{R1}$: After initial adaptation, $h(t)$ settles near a nearly constant plateau $h(t)\\approx 5\\times 10^{-4}$ for most of $t\\in[0,10]$. Repeating the run with $\\mathrm{rtol}$ multiplied by $10$ or divided by $10$ leaves this plateau essentially unchanged.\n- Run $\\mathrm{R2}$: $h(t)$ increases by orders of magnitude during the early part of the interval and eventually reaches $h(t)\\approx 5\\times 10^{-1}$ with mild fluctuations. When $\\mathrm{rtol}$ is tightened by a factor of $10$, the asymptotic $h(t)$ decreases systematically; when $\\mathrm{rtol}$ is relaxed by a factor of $10$, the asymptotic $h(t)$ increases systematically.\n\nUsing only the information in the step-size history $h(t)$ as a diagnostic, which of the following statements are valid for comparing solver performance on the stiff versus non-stiff system? Select all that apply.\n\nA. Run $\\mathrm{R1}$ corresponds to the stiff system $S$; the observed $h(t)$ plateau and its insensitivity to changes in $\\mathrm{rtol}$ indicate that the step size is limited primarily by linear stability, i.e., by a constraint of the form $\\lvert h\\,\\lambda\\rvert\\lesssim \\gamma$ for some method-dependent constant $\\gamma$, rather than by accuracy.\n\nB. Run $\\mathrm{R2}$ corresponds to the stiff system $S$; the growing $h(t)$ shows that the explicit method can take very large steps across the fast transient because stiffness permits skipping over rapidly decaying modes.\n\nC. For the non-stiff system $N$, under an adaptive embedded method of order $p$ with local error control, the asymptotic accepted step size scales as $h\\propto \\mathrm{rtol}^{1/(p+1)}$ when the solution varies on an $\\mathcal{O}(1)$ scale, which explains the sensitivity of $\\mathrm{R2}$ to changes in $\\mathrm{rtol}$.\n\nD. If both runs were repeated with an implicit $A$-stable (absolutely stable for the entire left half-plane) method of comparable order and the same tolerances, the stiff case would still exhibit a small-$h$ plateau for the same stability reason, so the presence of a plateau in $h(t)$ would not help diagnose stiffness.\n\nE. The presence of frequent step rejections alone conclusively proves stiffness, so the run with more rejections must be the stiff one regardless of other $h(t)$ features.", "solution": "First, we must identify the stiff and non-stiff systems. Stiffness arises from the presence of multiple time scales in the system, specifically a very rapidly decaying transient component.\n- System $S$: $y'(t) = -10^4 y(t)$. The eigenvalue is $-\\lambda = -10^4$. The solution is $y(t) = e^{-10^4 t}$. The characteristic time scale is $\\tau_S = 1/\\lambda = 10^{-4}$. This is extremely short compared to the integration interval of $[0, 10]$. This system is very **stiff**.\n- System $N$: $y'(t) = -y(t)$. The eigenvalue is $-1$. The solution is $y(t) = e^{-t}$. The characteristic time scale is $\\tau_N = 1$. This is on the order of the integration interval. This system is **non-stiff**.\n\nAn adaptive step-size controller for an explicit method must satisfy two constraints simultaneously. The step size $h$ is chosen to be the minimum of what is required for accuracy and for stability: $h \\approx \\min(h_{\\text{accuracy}}, h_{\\text{stability}})$.\n\nFor an explicit Runge-Kutta method applied to $y' = -\\lambda y$, the numerical stability constraint is that the product $h\\lambda$ must lie within the method's region of absolute stability. This takes the form $|h\\lambda| \\le \\gamma$, where $\\gamma$ is a method-dependent constant. Thus, the stability-limited step size is $h_{\\text{stability}} \\le \\gamma / \\lambda$.\n\nThe accuracy constraint is determined by the local error control mechanism. For a method of order $p$, the local truncation error (LTE) is of the form $LTE = C h^{p+1} y^{(p+1)}(t) + \\mathcal{O}(h^{p+2})$. The controller adjusts $h$ to keep an estimate of this error below a given tolerance, $\\mathrm{Tol}(t) = \\mathrm{rtol}|y(t)| + \\mathrm{atol}$. This leads to an accuracy-limited step size $h_{\\text{accuracy}} \\propto (\\mathrm{Tol})^{1/(p+1)}$.\n\nNow we analyze the behavior for each system:\n\n- **System $S$ (stiff):** With $\\lambda = 10^4$, the stability constraint is $h_{\\text{stability}} \\le \\gamma/10^4$. For a typical explicit RK method of order $p=5$ (like the Dormand-Prince $5(4)$ pair), the stability boundary is approximately $\\gamma \\approx 5.1$. This imposes a severe restriction on the step size: $h_{\\text{stability}} \\lesssim 5.1 \\times 10^{-4}$. After a very brief transient (for $t \\gg 10^{-4}$), the true solution $y(t)$ and all its derivatives are nearly zero. The accuracy requirement becomes extremely loose, determined mainly by $\\mathrm{atol}$, and would permit a very large $h_{\\text{accuracy}}$. However, the solver is forced to respect the stability limit. Therefore, the step size will be dominated by stability: $h(t) \\approx h_{\\text{stability}} \\approx 5 \\times 10^{-4}$. This step size depends only on $\\lambda$ and the method's stability region, not the tolerance $\\mathrm{rtol}$. This behavior precisely matches the description of Run $\\mathrm{R1}$.\n\n- **System $N$ (non-stiff):** With $\\lambda = 1$, the stability constraint is $h_{\\text{stability}} \\le \\gamma/1 \\approx 5.1$. This is a very mild constraint. The step size will be determined by accuracy. Since $p=5$, we have $h \\approx h_{\\text{accuracy}} \\propto (\\mathrm{Tol})^{1/(p+1)} = (\\mathrm{rtol}|e^{-t}| + \\mathrm{atol})^{1/6}$. This step size is clearly dependent on $\\mathrm{rtol}$. As $t$ increases, $y(t)=e^{-t}$ decays, accuracy becomes easier to achieve, and the controller will increase the step size. This behavior precisely matches the description of Run $\\mathrm{R2}$.\n\nHaving matched $\\mathrm{R1}$ to the stiff system $S$ and $\\mathrm{R2}$ to the non-stiff system $N$, we evaluate the options.\n\n**Option-by-Option Analysis:**\n\n**A. Run $\\mathrm{R1}$ corresponds to the stiff system $S$; the observed $h(t)$ plateau and its insensitivity to changes in $\\mathrm{rtol}$ indicate that the step size is limited primarily by linear stability, i.e., by a constraint of the form $\\lvert h\\,\\lambda\\rvert\\lesssim \\gamma$ for some method-dependent constant $\\gamma$, rather than by accuracy.**\nThis statement is perfectly aligned with our analysis. Run $\\mathrm{R1}$ is indeed the stiff system $S$. The flat plateau at $h(t) \\approx 5 \\times 10^{-4}$ is the manifestation of the stability limit $h \\le \\gamma/\\lambda$. This limit is independent of the tolerance $\\mathrm{rtol}$, which explains the observed insensitivity.\nVerdict: **Correct**.\n\n**B. Run $\\mathrm{R2}$ corresponds to the stiff system $S$; the growing $h(t)$ shows that the explicit method can take very large steps across the fast transient because stiffness permits skipping over rapidly decaying modes.**\nThis statement is incorrect on two counts. First, as established, Run $\\mathrm{R2}$ corresponds to the non-stiff system $N$. Second, the claim that an *explicit* method can take large steps on a stiff problem is a fundamental misunderstanding. It is precisely the stability limitation of explicit methods that prevents them from \"skipping over\" the decayed fast modes. This ability is the primary characteristic of suitable *implicit* methods, such as those that are A-stable.\nVerdict: **Incorrect**.\n\n**C. For the non-stiff system $N$, under an adaptive embedded method of order $p$ with local error control, the asymptotic accepted step size scales as $h\\propto \\mathrm{rtol}^{1/(p+1)}$ when the solution varies on an $\\mathcal{O}(1)$ scale, which explains the sensitivity of $\\mathrm{R2}$ to changes in $\\mathrm{rtol}$.**\nThis statement is correct. Run $\\mathrm{R2}$ corresponds to the non-stiff system $N$. For an order $p$ method, the step size required to meet a given tolerance $\\mathrm{Tol}$ scales as $h \\propto (\\mathrm{Tol})^{1/(p+1)}$. When the absolute tolerance $\\mathrm{atol}$ is small and the solution is not close to zero, $\\mathrm{Tol} \\approx \\mathrm{rtol}|y|$, leading to the scaling $h \\propto \\mathrm{rtol}^{1/(p+1)}$. With $p=5$, this is $h \\propto \\mathrm{rtol}^{1/6}$. This theoretical scaling correctly explains the observed systematic dependence of the step size on $\\mathrm{rtol}$ in Run $\\mathrm{R2}$.\nVerdict: **Correct**.\n\n**D. If both runs were repeated with an implicit $A$-stable (absolutely stable for the entire left half-plane) method of comparable order and the same tolerances, the stiff case would still exhibit a small-$h$ plateau for the same stability reason, so the presence of a plateau in $h(t)$ would not help diagnose stiffness.**\nThis statement is fundamentally flawed. An A-stable method is, by definition, numerically stable for any step size $h > 0$ when applied to $y' = -\\lambda y$ with $\\lambda > 0$. Therefore, for the stiff system $S$, there would be **no** stability-induced restriction on the step size. The step size would be governed solely by accuracy demands. After the initial fast transient, the solution is essentially zero, and an A-stable method would be able to take very large steps. The absence of a stability-induced plateau is the entire reason for using such methods on stiff problems.\nVerdict: **Incorrect**.\n\n**E. The presence of frequent step rejections alone conclusively proves stiffness, so the run with more rejections must be the stiff one regardless of other $h(t)$ features.**\nThis is a gross oversimplification. While solving a stiff problem with an explicit method often leads to step rejections as the step size attempts to grow beyond the stability boundary, frequent rejections are not a conclusive proof of stiffness. They can also be caused by other issues, such as integrating near a singularity, a problem with high-frequency oscillations, or simply a poor choice of initial step size. The characteristic plateau in $h(t)$ that is insensitive to tolerance is a far more reliable diagnostic for stiffness when using an explicit method than the mere count of rejections.\nVerdict: **Incorrect**.", "answer": "$$\\boxed{AC}$$", "id": "2372234"}]}