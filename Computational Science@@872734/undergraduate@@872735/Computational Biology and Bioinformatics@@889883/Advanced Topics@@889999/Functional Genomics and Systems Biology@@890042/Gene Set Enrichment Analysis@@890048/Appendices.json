{"hands_on_practices": [{"introduction": "To truly master Gene Set Enrichment Analysis (GSEA), we begin by deconstructing its core engine: the running sum statistic. This exercise simplifies the complex algorithm to its most fundamental state by analyzing a gene set containing just a single gene [@problem_id:2393962]. By analytically deriving the Enrichment Score ($ES$) in this scenario, you will build a clear and intuitive understanding of how a gene's position in a ranked list directly translates into the final score, providing a solid foundation for interpreting more realistic, multi-gene results.", "problem": "Consider Gene Set Enrichment Analysis (GSEA) applied to a ranked list of genes. Let there be a ranked list $\\mathcal{L}$ of $N$ distinct genes ordered from rank $1$ (top) to rank $N$ (bottom). Let the gene set $\\mathcal{S}$ contain exactly one gene (so $N_H = |\\mathcal{S}| = 1$), and suppose that this gene appears at rank $k \\in \\{1,2,\\dots,N\\}$ in $\\mathcal{L}$. Use the standard weighted running-sum definition of GSEA with exponent $p \\ge 0$: when scanning down the list from $i=1$ to $i=N$, define the running sum $R(i)$ as follows. If the $i$-th ranked gene is in $\\mathcal{S}$, increase $R(i)$ by $|r_i|^{p} / NR$, where $NR = \\sum_{g \\in \\mathcal{S}} |r_g|^{p}$, and if it is not in $\\mathcal{S}$, decrease $R(i)$ by $1/(N - N_H)$. Define the Enrichment Score $ES$ to be the maximum value of the running sum encountered along the walk, i.e., $ES = \\max_{1 \\le i \\le N} R(i)$. Express $ES$ solely as a closed-form function of $N$ and $k$. No numerical evaluation or rounding is required, and no units are to be reported.", "solution": "The problem as stated is subjected to validation.\n\n**Step 1: Extract Givens**\n- A ranked list $\\mathcal{L}$ of $N$ distinct genes. Ranks are from $1$ to $N$.\n- A gene set $\\mathcal{S}$ with size $N_H = |\\mathcal{S}| = 1$.\n- The single gene in $\\mathcal{S}$ is located at rank $k$, where $k \\in \\{1, 2, \\dots, N\\}$.\n- The GSEA exponent is $p \\ge 0$.\n- The running sum $R(i)$ is computed by scanning from $i=1$ to $i=N$.\n- If the $i$-th gene is in $\\mathcal{S}$ (a \"hit\"), the increment is $|r_i|^p / NR$. The term $r_i$ denotes the correlation or metric value for the gene at rank $i$.\n- $NR$ is defined as $NR = \\sum_{g \\in \\mathcal{S}} |r_g|^p$.\n- If the $i$-th gene is not in $\\mathcal{S}$ (a \"miss\"), the decrement is $1/(N - N_H)$.\n- The Enrichment Score is $ES = \\max_{1 \\le i \\le N} R(i)$.\n- The initial condition is implicitly $R(0)=0$.\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is scientifically grounded, as it is based on the well-established Gene Set Enrichment Analysis (GSEA) methodology. The setup with a single-gene set ($N_H=1$) is a simplification that renders the problem analytically tractable, but does not violate any fundamental principles. The problem is well-posed and objective.\n\nA potential ambiguity regarding the correlation values $r_i$ is resolved by careful inspection of the definitions. Since the gene set $\\mathcal{S}$ contains only one gene, which is at rank $k$, let its associated metric value be $r_k$. The normalization factor $NR$ is then $NR = \\sum_{g \\in \\mathcal{S}} |r_g|^p = |r_k|^p$. The increment for a hit, which occurs only at step $i=k$, is calculated as $|r_k|^p / NR = |r_k|^p / |r_k|^p = 1$. This holds for $p > 0$ under the reasonable assumption that the metric value $r_k$ is non-zero. For the case $p=0$, which corresponds to the unweighted GSEA statistic, the increment is $|r_k|^0 / NR = 1 / \\sum_{g \\in \\mathcal{S}} |r_g|^0 = 1 / N_H = 1/1 = 1$. Thus, for any $p \\ge 0$, the increment at a hit is precisely $1$.\n\nThe decrement for a miss is given by $1/(N-N_H)$. With $N_H=1$, this is $1/(N-1)$. This term is undefined if $N=1$. However, if $N=1$, then $N_H=1$ and the set of \"misses\" is empty. The problem implicitly assumes $N > 1$ for the decrement step to be meaningful, which is a standard condition in such analyses. The problem is therefore deemed self-contained and consistent.\n\n**Step 3: Verdict and Action**\nThe problem is valid. A solution will be derived.\n\n**Derivation of the Solution**\nWe define the running sum $R(i)$ starting from $R(0)=0$. The change in the running sum at each step $j \\in \\{1, 2, \\dots, N\\}$ is $\\Delta_j$.\nA \"hit\" occurs only at rank $i=k$. The increment is $\\Delta_k = 1$.\nA \"miss\" occurs at any rank $i \\neq k$. The decrement is $-\\frac{1}{N-N_H}$. Since $N_H=1$, the decrement is $-\\frac{1}{N-1}$.\nSo, $\\Delta_j = 1$ if $j=k$, and $\\Delta_j = -\\frac{1}{N-1}$ if $j \\neq k$.\n\nThe running sum at step $i$ is given by $R(i) = \\sum_{j=1}^{i} \\Delta_j$. We analyze $R(i)$ in three cases based on the value of $i$ relative to $k$.\n\nCase 1: $1 \\le i < k$.\nIn this range, every step is a \"miss\".\n$$R(i) = \\sum_{j=1}^{i} \\left(-\\frac{1}{N-1}\\right) = i \\left(-\\frac{1}{N-1}\\right) = -\\frac{i}{N-1}$$\nSince $i \\ge 1$ and $N > 1$, all values of $R(i)$ in this range are negative. The function is strictly decreasing with $i$. The value just before the hit is $R(k-1) = -\\frac{k-1}{N-1}$.\n\nCase 2: $i=k$.\nThe running sum includes $k-1$ misses and one hit at step $k$.\n$$R(k) = R(k-1) + \\Delta_k = -\\frac{k-1}{N-1} + 1 = \\frac{-(k-1) + (N-1)}{N-1} = \\frac{N-k}{N-1}$$\nSince $1 \\le k \\le N$, we have $0 \\le N-k \\le N-1$, so $0 \\le R(k) \\le 1$.\n\nCase 3: $k < i \\le N$.\nThe running sum at step $i$ is the sum at step $k$ plus the decrements for all steps from $k+1$ to $i$. There are $i-k$ such steps, all of which are misses.\n$$R(i) = R(k) + \\sum_{j=k+1}^{i} \\left(-\\frac{1}{N-1}\\right) = R(k) - \\frac{i-k}{N-1}$$\nSubstituting the expression for $R(k)$:\n$$R(i) = \\frac{N-k}{N-1} - \\frac{i-k}{N-1} = \\frac{(N-k) - (i-k)}{N-1} = \\frac{N-i}{N-1}$$\nFor this range $k < i \\le N$, as $i$ increases, $N-i$ decreases, so $R(i)$ is a strictly decreasing function of $i$. The sequence of values starts at $R(k+1) = \\frac{N-(k+1)}{N-1}$ and ends at $R(N) = \\frac{N-N}{N-1}=0$.\n\nTo find the Enrichment Score, $ES = \\max_{1 \\le i \\le N} R(i)$, we must find the maximum value among the expressions for $R(i)$.\n- For $1 \\le i < k$, $R(i) = -i/(N-1) < 0$.\n- For $i \\ge k$, $R(i) = (N-i)/(N-1)$ for $i>k$ and $R(k)=(N-k)/(N-1)$. Since $i>k$, $N-i < N-k$, which implies $R(i) < R(k)$ for all $i > k$ (assuming $N-1>0$).\nThe sequence of values $R(i)$ for $i \\ge k$ is $R(k), R(k+1), \\dots, R(N)$, which is a strictly decreasing sequence.\nThus, the maximum value in the range $i \\ge k$ is $R(k)$.\nSince all values for $i<k$ are negative and $R(k) \\ge 0$, the global maximum over $1 \\le i \\le N$ must be $R(k)$.\n\nTherefore, the Enrichment Score is:\n$$ES = R(k) = \\frac{N-k}{N-1}$$\nThis expression is a closed-form function dependent only on $N$ and $k$, as required.\nFor verification, if the gene is ranked first ($k=1$), $ES = \\frac{N-1}{N-1} = 1$, the maximum possible score. If the gene is ranked last ($k=N$), $ES = \\frac{N-N}{N-1} = 0$. In this case, $R(i) = -i/(N-1)$ for $i < N$, all negative, and $R(N)=0$, so the maximum is indeed $0$. The result is consistent.", "answer": "$$\\boxed{\\frac{N-k}{N-1}}$$", "id": "2393962"}, {"introduction": "A common point of confusion when interpreting GSEA results is encountering a gene set with a high, seemingly impressive Enrichment Score ($ES$) but a poor, non-significant False Discovery Rate ($FDR$). This practice exercise [@problem_id:2393971] delves into this critical scenario, challenging you to look beyond the raw score and consider the statistical context. Successfully navigating this problem requires understanding the crucial distinction between effect size (the $ES$) and statistical significance (the $FDR$), especially within the multiple-hypothesis testing framework inherent to genomics.", "problem": "You run Gene Set Enrichment Analysis (GSEA) on a ranked list of genes derived from a case–control study. For one biological pathway (gene set), the Enrichment Score (ES) is reported near $1$ (for example, $ES \\approx 0.95$), but the False Discovery Rate (FDR) for that pathway is high (for example, $FDR > 0.25$). In GSEA, the Enrichment Score (ES) summarizes the degree to which the genes in a set are concentrated at the top or bottom of the ranked list, and the False Discovery Rate (FDR) estimates the expected proportion of false positives among findings at least as extreme, accounting for multiple testing across all gene sets. Which statements best explain how this result is possible and what it implies?\n\nA. A large $ES$ indicates strong concentration of the set’s genes near one end of the ranked list, but a high $FDR$ can arise if many gene sets (or phenotype label permutations) attain similar or larger scores; after correcting for multiple testing, the observed enrichment is not statistically significant.\n\nB. This discrepancy occurs only because the number of permutations is too small; as the number of permutations increases, a large $ES$ will always yield a small $FDR$, so the pathway is in fact significantly enriched.\n\nC. Overlap and co-regulation among gene sets can cause many sets to achieve high scores under the observed ranking, inflating the across-set null and increasing $FDR$; the signal is non-specific and may reflect a broad shift rather than pathway-specific enrichment.\n\nD. Because $ES \\in [-1,1]$, values near $1$ guarantee statistical significance; therefore an $FDR > 0.25$ with $ES \\approx 1$ indicates a computational error.\n\nE. Small gene sets can attain extreme $ES$ by chance; after normalizing by gene set size and comparing to a null built from label permutations, the score may be common for sets of similar size, resulting in high $FDR$, so no pathway-level claim should be made.", "solution": "The problem statement is submitted to validation.\n\n**Step 1: Extract Givens**\n- Analysis Method: Gene Set Enrichment Analysis (GSEA)\n- Input Data: A ranked list of genes from a case–control study.\n- Observation: For a specific biological pathway (gene set), the Enrichment Score ($ES$) is approximately $0.95$.\n- Observation: For the same pathway, the False Discovery Rate ($FDR$) is greater than $0.25$.\n- Provided Definition of $ES$: The Enrichment Score summarizes the degree to which the genes in a set are concentrated at the top or bottom of the ranked list.\n- Provided Definition of $FDR$: The False Discovery Rate estimates the expected proportion of false positives among findings at least as extreme, accounting for multiple testing across all gene sets.\n- Question: Explain how this result ($ES \\approx 0.95$ and $FDR > 0.25$) is possible and what it implies.\n\n**Step 2: Validate Using Extracted Givens**\n- **Scientific Grounding**: The problem is grounded in the established principles of computational biology and statistics, specifically the GSEA method developed by Subramanian et al. The concepts of Enrichment Score, phenotype permutation, and False Discovery Rate correction are central to this field. The stated values ($ES \\approx 0.95$, $FDR > 0.25$) are plausible and represent a common scenario in real-world data analysis.\n- **Well-Posedness**: The problem is well-posed. It presents a non-contradictory set of observations and asks for a logical explanation based on the underlying methodology. A meaningful and specific set of explanations can be derived.\n- **Objectivity**: The problem is stated in objective, technical language.\n- **Completeness**: The problem provides sufficient information and definitions to proceed with a rigorous analysis. The apparent paradox of a high $ES$ and high $FDR$ is the core of the question, not a flaw in the setup.\n\n**Step 3: Verdict and Action**\nThe problem statement is scientifically sound, well-posed, and complete. It is therefore **valid**. The solution will proceed.\n\n**Derivation of Principles**\n\nThe Gene Set Enrichment Analysis (GSEA) methodology is built upon several key statistical concepts that must be understood to resolve the apparent discrepancy.\n\n$1$. **The Enrichment Score ($ES$)**: Given a ranked list of all genes $L$ (from most up-regulated to most down-regulated in the 'case' phenotype, for example) and a pre-defined gene set $S$, the analysis proceeds by walking down the list $L$. A running-sum statistic is calculated. This sum is increased for each gene encountered that is a member of $S$ (a 'hit') and decreased for each gene that is not (a 'miss'). The magnitude of the increment for a hit is weighted by the gene's rank correlation. The Enrichment Score, $ES$, is defined as the maximum deviation of this running-sum from zero. An $ES$ value approaching $+1$ indicates that the genes in set $S$ are predominantly found at the top of the ranked list $L$. An $ES$ approaching $-1$ indicates concentration at the bottom. An $ES$ near $0$ indicates a random distribution. The observed $ES \\approx 0.95$ correctly signifies a very strong concentration of the pathway's genes at one end of the list. It is, in essence, a measure of effect size for the gene set.\n\n$2$. **Significance Testing and the Null Distribution**: A large $ES$ is not, in itself, proof of statistical significance. The score's significance is assessed by comparing it to a null distribution. GSEA generates this null distribution by permuting the phenotype labels (case vs. control) a large number of times (e.g., $N = 1000$). For each permutation, the entire gene ranking and subsequent $ES$ calculation for the set $S$ are repeated. This creates a distribution of $ES_{null}$ scores, representing the range of scores that can be expected for this set by chance under the null hypothesis that there is no association between the gene set and the phenotype. The nominal p-value for the set $S$ is the fraction of permutations where $|ES_{null}| \\ge |ES_{obs}|$.\n\n$3$. **Correction for Multiple Hypothesis Testing (FDR)**: In a typical analysis, thousands of gene sets are tested simultaneously. This constitutes a massive multiple testing problem, which mandates a stringent correction. GSEA uses the False Discovery Rate ($FDR$) for this purpose. The procedure involves normalizing the observed $ES$ for each set to account for differences in gene set size. This is done by dividing the observed $ES$ by the mean of the absolute values of the $ES_{null}$ scores for that set, yielding a Normalized Enrichment Score ($NES$). A similar normalization is applied to all $ES_{null}$ scores for all sets. The $FDR$ is then calculated by comparing the observed $NES$ for our pathway of interest against the aggregated distribution of all $NES_{null}$ scores from all sets across all permutations. An $FDR > 0.25$ indicates that if we declare all pathways with an $NES$ at least as large as the one observed to be significant, we expect over $25\\%$ of those declarations to be false positives. By convention, this is not considered statistically significant.\n\nThe core of the problem is to explain why a large effect size ($ES \\approx 0.95$) does not translate to statistical significance ($FDR > 0.25$). This occurs when the observed (and normalized) score, while large in absolute terms, is not sufficiently extreme relative to the null distribution constructed from all tested sets and permutations.\n\n**Option-by-Option Analysis**\n\nA. A large $ES$ indicates strong concentration of the set’s genes near one end of the ranked list, but a high $FDR$ can arise if many gene sets (or phenotype label permutations) attain similar or larger scores; after correcting for multiple testing, the observed enrichment is not statistically significant.\n\nThis statement is a precise and accurate description of the GSEA multiple testing correction procedure. The $ES$ measures concentration, as stated. The statistical significance, quantified by the $FDR$, is determined by comparing the observed Normalized Enrichment Score ($NES$) to a null distribution pooled from all permutations and all tested gene sets. If many other gene sets (in the actual data) or many permuted instances (in the null model) achieve scores comparable to or greater than the one observed for the pathway in question, the finding is not exceptional. The resulting high $FDR$ correctly reflects that the enrichment is not statistically significant after accounting for the full burden of multiple tests.\n\nVerdict: **Correct**.\n\nB. This discrepancy occurs only because the number of permutations is too small; as the number of permutations increases, a large $ES$ will always yield a small $FDR$, so the pathway is in fact significantly enriched.\n\nThis statement is fundamentally flawed. Increasing the number of permutations improves the resolution and stability of the $p$-value and $FDR$ estimates, but it does not change the underlying statistical reality. If the observed enrichment is not truly significant relative to the null distribution, more permutations will simply converge on a more precise, but still high, $FDR$ value. The claim that a large $ES$ *will always* yield a small $FDR$ with enough permutations is false. It ignores the critical context of the other gene sets being tested and the results from the permutations.\n\nVerdict: **Incorrect**.\n\nC. Overlap and co-regulation among gene sets can cause many sets to achieve high scores under the observed ranking, inflating the across-set null and increasing $FDR$; the signal is non-specific and may reflect a broad shift rather than pathway-specific enrichment.\n\nThis statement provides a sophisticated and common biological explanation for the statistical phenomenon. Biological pathways are not independent; they often share genes due to functional relationships. If a set of coregulated genes is strongly perturbed and appears at the top of the ranked list, every gene set containing a substantial fraction of these genes will exhibit a high $ES$. This leads to a situation where many observed sets have high $NES$ values. The $FDR$ calculation correctly captures this non-specificity. The statistical significance of any single set is diminished because the enrichment signal is diluted across many correlated sets. Thus, the high $FDR$ implies the signal is not specific to our single pathway of interest. This is a primary reason why the scenario described in option A occurs.\n\nVerdict: **Correct**.\n\nD. Because $ES \\in [-1,1]$, values near $1$ guarantee statistical significance; therefore an $FDR > 0.25$ with $ES \\approx 1$ indicates a computational error.\n\nThis statement demonstrates a basic misunderstanding of statistical inference. The magnitude of a statistic ($ES$, an effect size) is distinct from its statistical significance ($p$-value or $FDR$). A large effect can be observed by chance, and its significance can only be judged relative to a proper null distribution and after correcting for multiple comparisons. The range of the $ES$ being $[-1, 1]$ is irrelevant to this principle. Attributing this common and well-understood statistical outcome to a \"computational error\" is unscientific and incorrect.\n\nVerdict: **Incorrect**.\n\nE. Small gene sets can attain extreme $ES$ by chance; after normalizing by gene set size and comparing to a null built from label permutations, the score may be common for sets of similar size, resulting in high $FDR$, so no pathway-level claim should be made.\n\nThis statement identifies another valid mechanism. Due to sampling variability, a small gene set can achieve a very high $ES$ if just a few of its members happen to fall at the top of the ranked list. The GSEA methodology explicitly accounts for this by normalizing the raw $ES$ to produce the $NES$. This normalization is based on the distribution of $ES$ values for sets of a similar size under permutation. If high $ES$ values are common for small sets by chance, the normalization will reduce the score's magnitude, leading to a non-extreme $NES$ and consequently a high $FDR$. The conclusion that no pathway-level claim should be made is the correct interpretation of a high $FDR$.\n\nVerdict: **Correct**.", "answer": "$$\\boxed{ACE}$$", "id": "2393971"}, {"introduction": "The final step in mastering a computational method is often to move from using it to building it. This hands-on coding challenge [@problem_id:2393970] provides an opportunity to do just that by implementing a modified version of the GSEA algorithm from the ground up. You will extend the classic GSEA framework by introducing a custom weighting scheme designed to down-weight the influence of \"promiscuous\" genes that belong to many pathways. This exercise not only solidifies your procedural understanding of GSEA but also demonstrates how core bioinformatics algorithms can be adapted to test more nuanced biological hypotheses.", "problem": "You are given a ranked list of genes of length $N$ with real-valued ranking scores $\\{r_{1}, r_{2}, \\ldots, r_{N}\\}$, a subset of indices $S \\subseteq \\{1,2,\\ldots,N\\}$ denoting a candidate gene set, and a vector of positive integers $\\{d_{1}, d_{2}, \\ldots, d_{N}\\}$ where $d_{i}$ is the number of distinct pathways that gene $i$ is annotated to. Define a modified enrichment running sum that down-weights genes that appear in many pathways by the following rules.\n\nLet $k = |S|$. For parameters $p \\ge 0$ and $\\beta \\ge 0$, define hit-weights\n$$\nw_{i} =\n\\begin{cases}\n\\displaystyle \\frac{|r_{i}|^{p}}{d_{i}^{\\beta}},  \\text{if } i \\in S \\\\\n0,  \\text{if } i \\notin S\n\\end{cases}\n\\quad\\text{and}\\quad\nW = \\sum_{i \\in S} w_{i}.\n$$\nFor $k \\in \\{1,2,\\ldots,N-1\\}$, define the miss step as $a = \\dfrac{1}{N-k}$. The running sum $\\{S_{j}\\}_{j=0}^{N}$ is defined by $S_{0} = 0$ and for $j = 1,2,\\ldots,N$,\n$$\nS_{j} =\n\\begin{cases}\nS_{j-1} + \\dfrac{w_{j}}{W},  \\text{if } j \\in S \\\\\nS_{j-1} - a,  \\text{if } j \\notin S\n\\end{cases}\n$$\nDefine the enrichment score as the signed extreme deviation\n$$\n\\mathrm{ES} =\n\\begin{cases}\n\\max_{1 \\le j \\le N} S_{j},  \\text{if } \\left|\\max_{1 \\le j \\le N} S_{j}\\right| \\ge \\left|\\min_{1 \\le j \\le N} S_{j}\\right| \\\\\n\\min_{1 \\le j \\le N} S_{j},  \\text{otherwise}\n\\end{cases}\n$$\nFor boundary cases, define $\\mathrm{ES} = -1$ if $k = 0$ and $\\mathrm{ES} = +1$ if $k = N$. All indices in $S$ are to be interpreted as $1$-based positions with respect to the ranking order $\\{r_{1}, \\ldots, r_{N}\\}$.\n\nYour task is to implement a program that computes $\\mathrm{ES}$ for each of the following test cases and prints the results rounded to six decimal places. The final output must be a single line containing the results as a comma-separated list enclosed in square brackets, in the same order as the test cases. No additional text should be printed.\n\nTest suite (each test case lists $N$, the sequence $\\{r_{i}\\}$, the set $S$, the degrees $\\{d_{i}\\}$, and the parameters $p$ and $\\beta$):\n\n- Test case (1): $N = 10$; $\\{r_{i}\\} = [\\,5,4,3,2,1,-1,-2,-3,-4,-5\\,]$; $S = \\{\\,1,4,7\\,\\}$; $\\{d_{i}\\} = [\\,1,1,1,1,1,1,1,1,1,1\\,]$; $p = 0$; $\\beta = 0$.\n- Test case (2): $N = 10$; $\\{r_{i}\\} = [\\,5,4,3,2,1,-1,-2,-3,-4,-5\\,]$; $S = \\{\\,1,4,7\\,\\}$; $\\{d_{i}\\} = [\\,1,1,1,10,1,1,1,1,1,1\\,]$; $p = 0$; $\\beta = 1$.\n- Test case (3): $N = 10$; $\\{r_{i}\\} = [\\,5,4,3,2,1,-1,-2,-3,-4,-5\\,]$; $S = \\{\\,2,3,10\\,\\}$; $\\{d_{i}\\} = [\\,1,1,2,1,1,1,1,1,1,1\\,]$; $p = 1$; $\\beta = 1$.\n- Test case (4): $N = 5$; $\\{r_{i}\\} = [\\,2,1,0,-1,-2\\,]$; $S = \\varnothing$; $\\{d_{i}\\} = [\\,1,1,1,1,1\\,]$; $p = 1$; $\\beta = 1$.\n- Test case (5): $N = 6$; $\\{r_{i}\\} = [\\,6,5,4,3,2,1\\,]$; $S = \\{\\,1,2,3,4,5,6\\,\\}$; $\\{d_{i}\\} = [\\,1,1,1,1,1,1\\,]$; $p = 0$; $\\beta = 2$.\n\nFinal output format: Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each result is the enrichment score for the corresponding test case rounded to six decimal places (for example, $[\\,0.123456,-0.500000,1.000000\\,]$). Angles and physical units do not apply in this problem. All answers must be expressed as real numbers with six digits after the decimal point.", "solution": "The problem presented is a variant of the Gene Set Enrichment Analysis (GSEA), a computational method in bioinformatics used to determine whether a predefined set of genes shows statistically significant, concordant differences between two biological states. The problem is scientifically grounded, well-posed, and all necessary parameters and formulae are provided for a unique solution. It is therefore deemed valid.\n\nThe central task is to compute a modified Enrichment Score ($\\mathrm{ES}$) for several test cases. The calculation proceeds as follows:\n\nFirst, we address the two boundary conditions. The size of the gene set is denoted by $k = |S|$, and the total number of ranked genes is $N$.\n- If the gene set $S$ is empty ($k=0$), the $\\mathrm{ES}$ is defined as $-1$. This represents maximal negative enrichment, as none of the genes in the set appear in the ranked list.\n- If the gene set $S$ comprises all genes ($k=N$), the $\\mathrm{ES}$ is defined as $+1$. This represents maximal positive enrichment.\n\nFor the main case, where $0  k  N$, the calculation involves constructing a running sum. The steps are as follows:\n\n1.  **Calculate Hit Weights**: For each gene $i$ in the ranked list from $1$ to $N$, a weight $w_i$ is calculated. The problem states that the indices in $S$ are $1$-based. If gene $i$ is in the gene set $S$, its weight is a function of its ranking score $r_i$, its degree $d_i$ (number of pathways it belongs to), and two non-negative parameters $p$ and $\\beta$. The formula is:\n    $$\n    w_{i} = \\frac{|r_{i}|^{p}}{d_{i}^{\\beta}}, \\quad \\text{if } i \\in S\n    $$\n    The parameter $p$ controls the influence of the ranking score; a higher $p$ gives more weight to genes with larger scores. The parameter $\\beta$ down-weights \"promiscuous\" genes that are part of many pathways. If gene $i$ is not in the set $S$, its weight is zero, i.e., $w_i=0$. It is important to note the use of $1$-based indexing for $i \\in S$ must be mapped to $0$-based indices for array access in implementation.\n\n2.  **Normalize Weights**: The individual hit weights are then normalized. First, we compute the sum of all weights for genes within the set $S$:\n    $$\n    W = \\sum_{i \\in S} w_{i}\n    $$\n    If $W=0$, which could occur if $p  0$ and all genes in $S$ have $r_i=0$, the hit increment would be undefined. However, the provided test cases do not encounter this scenario. For $p=0$ and an assumption of $0^0=1$, $w_i=1/d_i^\\beta$, which is always positive since $d_i$ are positive integers. Thus, $W$ is guaranteed to be positive.\n\n3.  **Define Step Sizes**: The running sum moves up for a \"hit\" (gene is in $S$) and down for a \"miss\" (gene is not in $S$).\n    - The **hit step** for a gene $j \\in S$ is its normalized weight: $\\dfrac{w_{j}}{W}$.\n    - The **miss step** is a constant penalty, calculated as: $a = \\dfrac{1}{N-k}$, where $N-k$ is the number of genes not in the set $S$.\n\n4.  **Compute the Running Sum**: The running sum, $\\{S_j\\}_{j=0}^{N}$, starts at $S_0=0$. It is updated iteratively for each gene $j$ from $1$ to $N$:\n    $$\n    S_{j} =\n    \\begin{cases}\n    S_{j-1} + \\dfrac{w_{j}}{W},  \\text{if } j \\in S \\\\\n    S_{j-1} - a,  \\text{if } j \\notin S\n    \\end{cases}\n    $$\n    This process generates a sequence of values $S_1, S_2, \\ldots, S_N$.\n\n5.  **Determine the Enrichment Score ($\\mathrm{ES}$)**: The $\\mathrm{ES}$ is the maximum deviation of the running sum from zero. It is defined as the signed extreme value of the running sum sequence $\\{S_j\\}_{j=1}^{N}$:\n    $$\n    \\mathrm{ES} =\n    \\begin{cases}\n    \\max_{1 \\le j \\le N} S_{j},  \\text{if } \\left|\\max_{1 \\le j \\le N} S_{j}\\right| \\ge \\left|\\min_{1 \\le j \\le N} S_{j}\\right| \\\\\n    \\min_{1 \\le j \\le N} S_{j},  \\text{otherwise}\n    \\end{cases}\n    $$\n    This value quantifies the degree to which the gene set $S$ is overrepresented at the extremes (top or bottom) of the ranked list of all genes. A positive $\\mathrm{ES}$ indicates enrichment at the top of the ranked list, while a negative $\\mathrm{ES}$ indicates enrichment at the bottom.\n\nThe implementation will follow these steps for each test case provided, handling the data structures and index conversions (from $1$-based to $0$-based) as required. The final numerical results will be rounded to six decimal places as specified.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef calculate_es(N, r, S, d, p, beta):\n    \"\"\"\n    Calculates the modified Enrichment Score (ES).\n\n    Args:\n        N (int): Total number of genes.\n        r (list or np.array): Real-valued ranking scores.\n        S (set): 1-based indices of genes in the candidate set.\n        d (list or np.array): Positive integer degrees for each gene.\n        p (float): Exponent for the ranking score.\n        beta (float): Exponent for the degree.\n\n    Returns:\n        float: The calculated Enrichment Score.\n    \"\"\"\n    k = len(S)\n\n    # Handle boundary cases\n    if k == 0:\n        return -1.0\n    if k == N:\n        return 1.0\n\n    # Convert to numpy arrays for vectorized operations\n    r = np.array(r, dtype=float)\n    d = np.array(d, dtype=float)\n\n    # Convert 1-based set S to 0-based indices for array access\n    S_0based = {idx - 1 for idx in S}\n\n    # Calculate weights for genes in the set S\n    weights = np.zeros(N)\n    for idx in S_0based:\n        # Note: np.power(0, 0) correctly evaluates to 1.\n        weights[idx] = (np.abs(r[idx])**p) / (d[idx]**beta)\n    \n    W = np.sum(weights)\n    \n    # If W is zero, hits have no contribution. This case is not specified\n    # but based on test cases, it is not expected.\n    if W == 0:\n        # Fallback logic assumes runningsum only decreases.\n        # This part is an assumption as it is not specified in the problem.\n        # But for the given test cases, W is never zero for 0  k  N.\n        miss_step = 1.0 / (N - k)\n        return -N * miss_step\n        \n    hit_increments = weights / W\n    miss_decrement = 1.0 / (N - k)\n\n    running_sum = 0.0\n    running_sum_values = []\n\n    for j in range(N):\n        if j in S_0based:\n            running_sum += hit_increments[j]\n        else:\n            running_sum -= miss_decrement\n        running_sum_values.append(running_sum)\n    \n    max_dev = np.max(running_sum_values)\n    min_dev = np.min(running_sum_values)\n\n    if np.abs(max_dev) = np.abs(min_dev):\n        return max_dev\n    else:\n        return min_dev\n\ndef solve():\n    \"\"\"\n    Solves the problem for the given test suite.\n    \"\"\"\n    test_cases = [\n        # Test case (1): N, r, S, d, p, beta\n        (10, [5, 4, 3, 2, 1, -1, -2, -3, -4, -5], {1, 4, 7}, [1]*10, 0, 0),\n        # Test case (2)\n        (10, [5, 4, 3, 2, 1, -1, -2, -3, -4, -5], {1, 4, 7}, [1, 1, 1, 10, 1, 1, 1, 1, 1, 1], 0, 1),\n        # Test case (3)\n        (10, [5, 4, 3, 2, 1, -1, -2, -3, -4, -5], {2, 3, 10}, [1, 1, 2, 1, 1, 1, 1, 1, 1, 1], 1, 1),\n        # Test case (4)\n        (5, [2, 1, 0, -1, -2], set(), [1]*5, 1, 1),\n        # Test case (5)\n        (6, [6, 5, 4, 3, 2, 1], {1, 2, 3, 4, 5, 6}, [1]*6, 0, 2)\n    ]\n\n    results = []\n    for N, r, S, d, p, beta in test_cases:\n        es_score = calculate_es(N, r, S, d, p, beta)\n        results.append(f\"{es_score:.6f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```", "id": "2393970"}]}