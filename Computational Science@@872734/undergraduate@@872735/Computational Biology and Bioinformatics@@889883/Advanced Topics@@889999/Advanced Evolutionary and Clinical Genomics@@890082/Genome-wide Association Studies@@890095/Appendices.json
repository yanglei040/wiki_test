{"hands_on_practices": [{"introduction": "A Genome-Wide Association Study (GWAS) tests millions of genetic variants, creating a significant statistical challenge. This practice explores the problem of multiple testing, where the sheer number of tests inflates the chance of finding false-positive associations. You will apply the Bonferroni correction, a foundational method used to adjust significance thresholds and control the overall error rate, a crucial first step in any GWAS analysis [@problem_id:1494362].", "problem": "A team of geneticists is conducting a Genome-Wide Association Study (GWAS) to identify genetic markers associated with a newly discovered complex disorder. A GWAS involves scanning the genomes of many individuals to determine if any specific genetic variants are more frequent in people with the disease compared to a control group. The genetic variants being analyzed in this study are Single Nucleotide Polymorphisms (SNPs).\n\nIn this particular study, the researchers are simultaneously testing $m = 1,000,000$ independent SNPs for a statistical association with the disorder. Conventionally, for a single statistical test, a p-value threshold (alpha level) for significance is set at $\\alpha = 0.05$. However, performing such a large number of tests significantly inflates the probability of obtaining at least one \"false positive\" result (a Type I error) purely by chance.\n\nTo counteract this multiple testing problem, the research team decides to control the Family-Wise Error Rate (FWER), defined as the probability of making one or more Type I errors among all the tests performed. They aim to keep the FWER at or below 0.05. To achieve this, they will apply the Bonferroni correction to their significance threshold.\n\nGiven the number of independent SNPs being tested and the desired FWER, calculate the new, Bonferroni-corrected p-value threshold that a single SNP must meet to be considered statistically significant. Express your answer in scientific notation.", "solution": "The family-wise error rate under the Bonferroni procedure satisfies the Bonferroni inequality:\n$$\n\\text{FWER} \\leq \\sum_{i=1}^{m} \\alpha_{i}.\n$$\nIf each of the $m$ tests is conducted at the same per-test significance level $\\alpha^{*}$, then\n$$\n\\text{FWER} \\leq m \\alpha^{*}.\n$$\nTo control the FWER at the desired level $\\alpha$, choose $\\alpha^{*}$ such that\n$$\nm \\alpha^{*} \\leq \\alpha \\quad \\Rightarrow \\quad \\alpha^{*} = \\frac{\\alpha}{m}.\n$$\nWith $\\alpha = 0.05$ and $m = 1{,}000{,}000 = 10^{6}$, write $0.05 = 5 \\times 10^{-2}$ and compute\n$$\n\\alpha^{*} = \\frac{5 \\times 10^{-2}}{10^{6}} = 5 \\times 10^{-2-6} = 5 \\times 10^{-8}.\n$$\nThus, the Bonferroni-corrected p-value threshold is $5 \\times 10^{-8}$.", "answer": "$$\\boxed{5 \\times 10^{-8}}$$", "id": "1494362"}, {"introduction": "Before searching for true associations, it is essential to ensure the quality of the genetic data. This exercise guides you through implementing a critical quality control (QC) filter based on the principle of Hardy-Weinberg Equilibrium (HWE). Significant deviation from HWE in control subjects can indicate genotyping errors, and filtering these variants is a standard step to increase the reliability of GWAS results [@problem_id:2394652].", "problem": "You are given the task of constructing a program that implements a quality control filter for a Genome-Wide Association Study (GWAS). The filter must detect and mark single-nucleotide polymorphisms (SNPs) in control samples that show a statistically significant deviation from Hardy-Weinberg equilibrium (HWE). A SNP is biallelic with alleles denoted by $A$ and $a$. For each SNP, you are provided the genotype counts in controls: $n_{AA}$ for homozygous $AA$, $n_{Aa}$ for heterozygous $Aa$, and $n_{aa}$ for homozygous $aa$. Let $n = n_{AA} + n_{Aa} + n_{aa}$ denote the number of control individuals.\n\nUnder the null hypothesis of Hardy-Weinberg equilibrium (HWE), the population is assumed to arise from random mating given the underlying allele frequencies. Consider the exact conditional test for HWE that conditions on the total number of copies of one allele in the sample. Let there be $2n$ chromosomal positions and let $r$ denote the number of copies of the rarer allele among these $2n$ positions. Assume that every allocation of the $r$ rarer-allele copies to the $2n$ chromosomal positions is equally likely under the null hypothesis. Define the two-sided exact $p$-value for a given observed genotype configuration as the sum of the conditional probabilities of all genotype configurations that have the same total allele count and are at least as unlikely as the observed configuration under the null hypothesis.\n\nFor each SNP, use the following decision rule: remove the SNP (mark it as $1$) if the exact two-sided HWE $p$-value is strictly less than the given significance level $\\alpha$, otherwise keep it (mark it as $0$).\n\nImplement a single program that applies this rule to the following test suite of independent SNPs, each specified as a tuple $(n_{AA}, n_{Aa}, n_{aa}, \\alpha)$:\n\n- Test $1$: $(50, 20, 30, 10^{-6})$, i.e., $n_{AA} = 50$, $n_{Aa} = 20$, $n_{aa} = 30$, $\\alpha = 10^{-6}$.\n- Test $2$: $(36, 48, 16, 10^{-6})$, i.e., $n_{AA} = 36$, $n_{Aa} = 48$, $n_{aa} = 16$, $\\alpha = 10^{-6}$.\n- Test $3$: $(100, 0, 0, 10^{-6})$, i.e., $n_{AA} = 100$, $n_{Aa} = 0$, $n_{aa} = 0$, $\\alpha = 10^{-6}$.\n- Test $4$: $(18, 2, 0, 0.05)$, i.e., $n_{AA} = 18$, $n_{Aa} = 2$, $n_{aa} = 0$, $\\alpha = 0.05$.\n- Test $5$: $(0, 10, 0, 0.01)$, i.e., $n_{AA} = 0$, $n_{Aa} = 10$, $n_{aa} = 0$, $\\alpha = 0.01$.\n- Test $6$: $(405, 90, 5, 0.05)$, i.e., $n_{AA} = 405$, $n_{Aa} = 90$, $n_{aa} = 5$, $\\alpha = 0.05$.\n\nYour program should produce a single line of output containing the results as a comma-separated list of integers enclosed in square brackets, in the same order as the tests above, where each entry is $1$ if the SNP is to be removed and $0$ otherwise. For example, a valid output format is $[1,0,1]$ (this is only an example of formatting, not the correct answers).", "solution": "The problem requires the implementation of an exact test for Hardy-Weinberg Equilibrium (HWE). This test is a standard procedure for quality control in genetic studies, as significant deviations from HWE can indicate genotyping errors. The solution involves calculating a two-sided $p$-value for a given set of observed genotype counts and comparing it to a significance level $\\alpha$.\n\nLet the observed genotype counts for a biallelic SNP be $n_{AA}$, $n_{Aa}$, and $n_{aa}$. The total number of individuals in the sample is $n = n_{AA} + n_{Aa} + n_{aa}$. The counts of the two alleles, which we denote as $A$ and $a$, are:\n- Number of $A$ alleles: $N_A = 2n_{AA} + n_{Aa}$\n- Number of $a$ alleles: $N_a = 2n_{aa} + n_{Aa}$\nThe total number of alleles in the sample is $2n = N_A + N_a$.\n\nThe exact test for HWE is conditional on the observed allele counts, $N_A$ and $N_a$. Under the null hypothesis of HWE, we can conceptualize the $2n$ alleles in the sample as being randomly paired to form $n$ diploid individuals. Keeping the allele counts $N_A$ and $N_a$ fixed restricts the possible genotype configurations. Specifically, if we know the number of heterozygotes, $n_{Aa}$, the counts of homozygotes are determined:\n$$ n_{AA} = \\frac{N_A - n_{Aa}}{2} $$\n$$ n_{aa} = \\frac{N_a - n_{Aa}}{2} $$\nSince $n_{AA}$ and $n_{aa}$ must be non-negative integers, the number of heterozygotes, $n_{Aa}$, uniquely defines the genotype counts for a fixed $N_A$ and $N_a$. The probability of observing a specific count of heterozygotes, $k$, given the allele counts, follows a specific probability distribution derived from combinatorial arguments. The probability mass function (PMF) is:\n$$ P(n_{Aa} = k | n, N_A, N_a) = \\frac{n! N_A! N_a! 2^k}{(2n)! n_{AA_k}! k! n_{aa_k}!} $$\nwhere $n_{AA_k} = (N_A - k)/2$ and $n_{aa_k} = (N_a - k)/2$.\n\nThe range of possible values for $k$ (the support of the distribution) is determined by the constraints that genotype counts must be non-negative integers.\n1.  $k \\geq 0$\n2.  $n_{AA_k} \\geq 0 \\implies k \\leq N_A$\n3.  $n_{aa_k} \\geq 0 \\implies k \\leq N_a$\n4.  Furthermore, for $n_{AA_k}$ and $n_{aa_k}$ to be integers, $(N_A - k)$ and $(N_a - k)$ must be even. This implies that $k$ must have the same parity (even or odd) as $N_A$ and $N_a$. Note that $N_A$ and $N_a$ always have the same parity because their sum, $2n$, is even.\n\nThe two-sided $p$-value is defined as the sum of probabilities of all possible configurations that are as probable or less probable than the observed configuration. Let the observed heterozygote count be $n_{Aa,obs}$. The probability of this observation is $P_{obs} = P(n_{Aa} = n_{Aa,obs})$. The $p$-value is then:\n$$ p = \\sum_{k \\in \\text{support}} P(n_{Aa} = k) \\quad \\text{such that} \\quad P(n_{Aa} = k) \\leq P_{obs} $$\n\nThe calculation involves factorials of large numbers, which can lead to numerical overflow or underflow. To maintain precision, computations should be performed in log-space. The logarithm of the PMF is:\n$$ \\ln P(k) = \\ln(n!) + \\ln(N_A!) + \\ln(N_a!) + k\\ln(2) - \\ln((2n)!) - \\ln(n_{AA_k}!) - \\ln(k!) - \\ln(n_{aa_k}!) $$\nThe log-factorial, $\\ln(x!)$, can be computed using the log-gamma function, `gammaln`, as $\\ln(x!) = \\text{gammaln}(x+1)$.\n\nThe algorithm proceeds as follows for each test case:\n1.  Calculate $n, N_A, N_a$ from the input genotype counts $n_{AA,obs}, n_{Aa,obs}, n_{aa,obs}$.\n2.  Handle the trivial case where the SNP is monomorphic (i.e., $N_A=0$ or $N_a=0$). In this situation, only one genotype configuration is possible, its probability is $1$, and thus the $p$-value is $1$.\n3.  Determine the support for $n_{Aa}$: iterate from the minimum possible value (0 or 1, depending on parity) to the maximum possible value, $\\min(N_A, N_a)$, with a step of $2$.\n4.  Calculate the log-probability of the observed configuration, $\\ln(P_{obs})$.\n5.  Initialize the $p$-value to $0$. Iterate through all possible values $k$ in the support. For each $k$, calculate its log-probability, $\\ln(P_k)$.\n6.  If $\\ln(P_k) \\leq \\ln(P_{obs})$, add the probability $P_k = \\exp(\\ln(P_k))$ to the total $p$-value.\n7.  Finally, compare the calculated $p$-value with the given significance level $\\alpha$. If $p  \\alpha$, the result is $1$ (remove). Otherwise, the result is $0$ (keep).\n\nThis procedure is implemented for each of the specified test cases to produce the final output.", "answer": "```python\nimport numpy as np\nfrom scipy.special import gammaln\n\ndef solve():\n    \"\"\"\n    Main solver function to process the test suite for Hardy-Weinberg Equilibrium.\n    \"\"\"\n    test_cases = [\n        (50, 20, 30, 1e-6),\n        (36, 48, 16, 1e-6),\n        (100, 0, 0, 1e-6),\n        (18, 2, 0, 0.05),\n        (0, 10, 0, 0.01),\n        (405, 90, 5, 0.05),\n    ]\n\n    results = []\n    for n_AA, n_Aa, n_aa, alpha in test_cases:\n        p_value = calculate_hwe_exact_p_value(n_AA, n_Aa, n_aa)\n        if p_value  alpha:\n            results.append(1)\n        else:\n            results.append(0)\n\n    # Format output as a comma-separated list of integers in square brackets.\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef calculate_hwe_exact_p_value(n_AA_obs, n_Aa_obs, n_aa_obs):\n    \"\"\"\n    Calculates the two-sided exact p-value for Hardy-Weinberg Equilibrium.\n\n    Args:\n        n_AA_obs (int): Observed count of homozygous genotype AA.\n        n_Aa_obs (int): Observed count of heterozygous genotype Aa.\n        n_aa_obs (int): Observed count of homozygous genotype aa.\n\n    Returns:\n        float: The calculated p-value.\n    \"\"\"\n    n = n_AA_obs + n_Aa_obs + n_aa_obs\n    if n == 0:\n        return 1.0\n\n    n_A = 2 * n_AA_obs + n_Aa_obs\n    n_a = 2 * n_aa_obs + n_Aa_obs\n    \n    # If the SNP is monomorphic, HWE is trivially satisfied.\n    if n_A == 0 or n_a == 0:\n        return 1.0\n\n    # Determine the range of possible heterozygote counts\n    n_het_min = 0 if n_A % 2 == 0 else 1\n    n_het_max = min(n_A, n_a)\n\n    # Pre-calculate the constant part of the log-probability\n    log_const_term = (gammaln(n + 1) + gammaln(n_A + 1) + gammaln(n_a + 1) -\n                      gammaln(2 * n + 1))\n    \n    log_probs = {}\n    \n    # Calculate log-probability for all possible heterozygote counts\n    for k in range(n_het_min, n_het_max + 1, 2):\n        n_AA_k = (n_A - k) / 2\n        n_aa_k = (n_a - k) / 2\n        \n        # Ensure counts are valid integers, though the loop structure should guarantee this\n        if n_AA_k  0 or n_aa_k  0 or n_AA_k != int(n_AA_k) or n_aa_k != int(n_aa_k):\n            continue\n            \n        log_prob = (log_const_term + k * np.log(2) -\n                    gammaln(n_AA_k + 1) - gammaln(k + 1) - gammaln(n_aa_k + 1))\n        log_probs[k] = log_prob\n\n    # Find the log-probability of the observed configuration\n    # If observed het count is impossible given allele counts, its prob is 0.\n    if n_Aa_obs not in log_probs:\n        # This case should not happen with valid inputs. \n        # If it did, p-value would cover all possible outcomes, so 1.0.\n        return 1.0 \n    \n    log_p_obs = log_probs[n_Aa_obs]\n\n    # Calculate the p-value by summing probabilities of configurations\n    # that are as likely or less likely than the observed one.\n    p_value = 0.0\n    for k, log_p_k in log_probs.items():\n        if log_p_k = log_p_obs:\n            p_value += np.exp(log_p_k)\n            \n    # Clamp p-value to ensure it is within [0, 1] due to potential floating point inaccuracies\n    return max(0.0, min(1.0, p_value))\n\nsolve()\n```", "id": "2394652"}, {"introduction": "Even with high-quality data, systemic biases like population stratification can lead to widespread spurious associations, confounding the results of a GWAS. This practice introduces the genomic inflation factor, $\\lambda$, a key diagnostic tool used to detect and quantify such inflation in test statistics. By calculating $\\lambda$ from summary statistics, you will learn how to assess the overall validity of a study's findings and identify the potential need for further statistical correction [@problem_id:2394670].", "problem": "In Genome-Wide Association Studies (GWAS), the genomic inflation factor ($\\lambda$) quantifies systematic inflation of test statistics that can arise from confounding such as population stratification. Consider two simulated scenarios for single-nucleotide polymorphisms (SNPs): a null scenario with no stratification and a stratified scenario with strong population structure. For each scenario, an additive association test yields a one degree-of-freedom ($1$ d.f.) chi-square statistic for each SNP. The observed chi-square statistics are:\n\nNull scenario ($n = 21$ SNPs):\n$$\\{0.03,\\, 0.07,\\, 0.12,\\, 0.19,\\, 0.26,\\, 0.31,\\, 0.37,\\, 0.41,\\, 0.44,\\, 0.45,\\, 0.46,\\, 0.49,\\, 0.53,\\, 0.61,\\, 0.74,\\, 0.88,\\, 1.02,\\, 1.18,\\, 1.36,\\, 1.57,\\, 1.82\\}.$$\n\nStratified scenario ($n = 21$ SNPs):\n$$\\{0.054,\\, 0.126,\\, 0.216,\\, 0.342,\\, 0.468,\\, 0.558,\\, 0.666,\\, 0.738,\\, 0.792,\\, 0.81,\\, 0.828,\\, 0.882,\\, 0.954,\\, 1.098,\\, 1.332,\\, 1.584,\\, 1.836,\\, 2.124,\\, 2.448,\\, 2.826,\\, 3.276\\}.$$\n\nBy definition, for an association test with $1$ degree of freedom, the genomic inflation factor is\n$$\\lambda \\;=\\; \\frac{\\operatorname{median}\\!\\left(\\chi^{2}_{\\text{obs}}\\right)}{\\operatorname{median}\\!\\left(\\chi^{2}_{1,\\text{null}}\\right)},$$\nwhere $\\operatorname{median}\\!\\left(\\chi^{2}_{1,\\text{null}}\\right)$ is the population median of a chi-square distribution with $1$ degree of freedom under the null hypothesis.\n\nCompute $\\lambda$ for the null scenario and for the stratified scenario. Report your final answers as two numbers in a single row matrix $\\bigl[\\lambda_{\\text{null}}\\;\\;\\lambda_{\\text{stratified}}\\bigr]$, rounded to $4$ significant figures. No units are required.", "solution": "The task is to compute the genomic inflation factor $\\lambda$ for two scenarios: a null scenario and a stratified scenario. The calculation requires three components: the median of the observed $\\chi^{2}$ statistics for each scenario and the theoretical median of a $\\chi^{2}$ distribution with $1$ degree of freedom.\n\nFirst, we determine the theoretical median, $\\operatorname{median}\\!\\left(\\chi^{2}_{1,\\text{null}}\\right)$. A random variable $X$ that follows a chi-square distribution with one degree of freedom ($X \\sim \\chi^{2}_{1}$) can be represented as the square of a standard normal random variable, $X = Z^2$, where $Z \\sim N(0,1)$. The median of $X$ is the value $m$ such that $P(X \\le m) = 0.5$. This is equivalent to $P(Z^2 \\le m) = 0.5$, which simplifies to $P(-\\sqrt{m} \\le Z \\le \\sqrt{m}) = 0.5$.\n\nLet $\\Phi(z)$ be the cumulative distribution function (CDF) of the standard normal distribution. Then, $P(-\\sqrt{m} \\le Z \\le \\sqrt{m}) = \\Phi(\\sqrt{m}) - \\Phi(-\\sqrt{m})$. Due to the symmetry of the normal distribution, $\\Phi(-z) = 1 - \\Phi(z)$, so the expression becomes $2\\Phi(\\sqrt{m}) - 1$.\nWe set this equal to $0.5$:\n$$2\\Phi(\\sqrt{m}) - 1 = 0.5$$\n$$\\Phi(\\sqrt{m}) = \\frac{1.5}{2} = 0.75$$\nTherefore, $\\sqrt{m}$ is the $0.75$-quantile of the standard normal distribution, often denoted $z_{0.75}$. The median $m$ is the square of this quantile.\n$$m = \\left(z_{0.75}\\right)^2$$\nThe value of $z_{0.75}$ is a standard statistical constant, approximately $0.67449$.\n$$\\operatorname{median}\\!\\left(\\chi^{2}_{1,\\text{null}}\\right) = (0.67449)^2 \\approx 0.454936$$\n\nNext, we compute the median of the observed $\\chi^{2}$ statistics for each scenario. For both scenarios, the number of observations is $n = 21$, which is an odd number. For a sorted dataset of size $n$, the median is the value at position $\\frac{n+1}{2}$.\nFor $n = 21$, the median is the value at position $\\frac{21+1}{2} = 11$.\n\nFor the **null scenario**, the provided list of statistics is already sorted in ascending order. The $11^{th}$ value is $0.46$.\n$$\\operatorname{median}(\\chi^{2}_{\\text{obs, null}}) = 0.46$$\n\nFor the **stratified scenario**, the list is also sorted. The $11^{th}$ value is $0.828$.\n$$\\operatorname{median}(\\chi^{2}_{\\text{obs, stratified}}) = 0.828$$\n\nNow we apply the formula for $\\lambda$ to each scenario.\n\nFor the null scenario:\n$$\\lambda_{\\text{null}} = \\frac{\\operatorname{median}(\\chi^{2}_{\\text{obs, null}})}{\\operatorname{median}(\\chi^{2}_{1,\\text{null}})} = \\frac{0.46}{0.454936} \\approx 1.01113$$\nRounding to $4$ significant figures, we get $\\lambda_{\\text{null}} = 1.011$. This value is very close to $1$, which is expected under the null hypothesis of no population stratification.\n\nFor the stratified scenario:\n$$\\lambda_{\\text{stratified}} = \\frac{\\operatorname{median}(\\chi^{2}_{\\text{obs, stratified}})}{\\operatorname{median}(\\chi^{2}_{1,\\text{null}})} = \\frac{0.828}{0.454936} \\approx 1.82001$$\nRounding to $4$ significant figures, we get $\\lambda_{\\text{stratified}} = 1.820$. This value is substantially greater than $1$, indicating a systematic inflation of the test statistics, consistent with the presence of population structure.\n\nThe final answer is the row matrix containing these two values.", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n1.011  1.820\n\\end{pmatrix}\n}\n$$", "id": "2394670"}]}