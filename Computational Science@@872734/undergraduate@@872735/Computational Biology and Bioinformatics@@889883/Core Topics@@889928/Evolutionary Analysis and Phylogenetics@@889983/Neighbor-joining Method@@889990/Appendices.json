{"hands_on_practices": [{"introduction": "To build a phylogenetic tree with the Neighbor-Joining method, we start with a distance matrix and iteratively join the \"closest\" pairs of taxa. This exercise walks you through the crucial first step of the algorithm, where you will apply the NJ criterion to a genetic distance matrix for five sunflower species. By calculating the $Q$-matrix, you'll learn how the method identifies the initial pair to merge, forming the first internal node of the tree [@problem_id:1771208].", "problem": "A team of botanists is studying the evolutionary relationships among five recently discovered species of sunflowers. They have sequenced a specific gene from each species and calculated a pairwise genetic distance matrix, which quantifies the divergence between each pair. The species are *Helianthus arcanus* (HA), *Helianthus borealis* (HB), *Helianthus campestris* (HC), *Helianthus deserticola* (HD), and *Helianthus elegans* (HE).\n\nThe botanists decide to construct a phylogenetic tree using the Neighbor-Joining (NJ) algorithm. Your task is to perform the very first step of this algorithm to determine which two species are the first to be grouped together and form a new internal node.\n\nThe genetic distance matrix, where values represent a unitless measure of genetic divergence, is given below:\n\n|        | HA | HB | HC | HD | HE |\n| :----: | :-: | :-: | :-: | :-: | :-: |\n| **HA** | 0  | 5  | 4  | 7  | 6  |\n| **HB** | 5  | 0  | 7  | 10 | 9  |\n| **HC** | 4  | 7  | 0  | 7  | 6  |\n| **HD** | 7  | 10 | 7  | 0  | 5  |\n| **HE** | 6  | 9  | 6  | 5  | 0  |\n\nBased on this matrix, which of the following statements correctly describes the outcome of the first joining step of the Neighbor-Joining algorithm?\n\nA. The pair (*H. deserticola*, *H. elegans*) is joined. The new distances from this node are: 4 to *H. arcanus*, 7 to *H. borealis*, and 4 to *H. campestris*.\n\nB. The pair (*H. arcanus*, *H. borealis*) is joined. The new distances from this node are: 3 to *H. campestris*, 6 to *H. deserticola*, and 5 to *H. elegans*.\n\nC. The pair (*H. arcanus*, *H. campestris*) is joined. The new distances from this node are: 4 to *H. borealis*, 5 to *H. deserticola*, and 4 to *H. elegans*.\n\nD. The pair (*H. deserticola*, *H. elegans*) is joined. The new distances from this node are: 3 to *H. arcanus*, 2 to *H. borealis*, and 3 to *H. campestris*.\n\nE. The pair (*H. campestris*, *H. deserticola*) is joined. The new distances from this node are: 5.5 to *H. arcanus*, 8 to *H. borealis*, and 4 to *H. elegans*.", "solution": "To perform the first step of the Neighbor-Joining (NJ) algorithm with taxa $\\{\\mathrm{HA}, \\mathrm{HB}, \\mathrm{HC}, \\mathrm{HD}, \\mathrm{HE}\\}$ and distance matrix $d(i,j)$, compute the row sums $r_{i}=\\sum_{k} d(i,k)$ and the $Q$-matrix entries\n$$\nQ(i,j)=(n-2)\\,d(i,j)-r_{i}-r_{j},\n$$\nwhere $n=5$.\n\nFirst compute the row sums:\n$$\n\\begin{aligned}\nr_{\\mathrm{HA}}=d(\\mathrm{HA},\\mathrm{HB})+d(\\mathrm{HA},\\mathrm{HC})+d(\\mathrm{HA},\\mathrm{HD})+d(\\mathrm{HA},\\mathrm{HE})=5+4+7+6=22,\\\\\nr_{\\mathrm{HB}}=5+7+10+9=31,\\\\\nr_{\\mathrm{HC}}=4+7+7+6=24,\\\\\nr_{\\mathrm{HD}}=7+10+7+5=29,\\\\\nr_{\\mathrm{HE}}=6+9+6+5=26.\n\\end{aligned}\n$$\nWith $n-2=3$, compute the $Q$-values:\n$$\n\\begin{aligned}\nQ(\\mathrm{HA},\\mathrm{HB})=3\\cdot 5-22-31=15-53=-38,\\\\\nQ(\\mathrm{HA},\\mathrm{HC})=3\\cdot 4-22-24=12-46=-34,\\\\\nQ(\\mathrm{HA},\\mathrm{HD})=3\\cdot 7-22-29=21-51=-30,\\\\\nQ(\\mathrm{HA},\\mathrm{HE})=3\\cdot 6-22-26=18-48=-30,\\\\\nQ(\\mathrm{HB},\\mathrm{HC})=3\\cdot 7-31-24=21-55=-34,\\\\\nQ(\\mathrm{HB},\\mathrm{HD})=3\\cdot 10-31-29=30-60=-30,\\\\\nQ(\\mathrm{HB},\\mathrm{HE})=3\\cdot 9-31-26=27-57=-30,\\\\\nQ(\\mathrm{HC},\\mathrm{HD})=3\\cdot 7-24-29=21-53=-32,\\\\\nQ(\\mathrm{HC},\\mathrm{HE})=3\\cdot 6-24-26=18-50=-32,\\\\\nQ(\\mathrm{HD},\\mathrm{HE})=3\\cdot 5-29-26=15-55=-40.\n\\end{aligned}\n$$\nThe minimum $Q$ is $Q(\\mathrm{HD},\\mathrm{HE})=-40$, so the first joined pair is $(\\mathrm{HD},\\mathrm{HE})$.\n\nThe NJ reduction gives the distances from the new node $U$ joining $\\mathrm{HD}$ and $\\mathrm{HE}$ to any remaining taxon $k$ by\n$$\nd(U,k)=\\frac{d(\\mathrm{HD},k)+d(\\mathrm{HE},k)-d(\\mathrm{HD},\\mathrm{HE})}{2}.\n$$\nCompute these for $k\\in\\{\\mathrm{HA},\\mathrm{HB},\\mathrm{HC}\\}$ using $d(\\mathrm{HD},\\mathrm{HE})=5$:\n$$\n\\begin{aligned}\nd(U,\\mathrm{HA})=\\frac{d(\\mathrm{HD},\\mathrm{HA})+d(\\mathrm{HE},\\mathrm{HA})-d(\\mathrm{HD},\\mathrm{HE})}{2}=\\frac{7+6-5}{2}=4,\\\\\nd(U,\\mathrm{HB})=\\frac{10+9-5}{2}=7,\\\\\nd(U,\\mathrm{HC})=\\frac{7+6-5}{2}=4.\n\\end{aligned}\n$$\nThus the first join is $(\\mathrm{HD},\\mathrm{HE})$ with new distances $4$ to $\\mathrm{HA}$, $7$ to $\\mathrm{HB}$, and $4$ to $\\mathrm{HC}$, which matches option A.", "answer": "$$\\boxed{A}$$", "id": "1771208"}, {"introduction": "While powerful, the Neighbor-Joining algorithm is not foolproof and can be misled by certain patterns of evolution, a phenomenon known as long-branch attraction. This exercise places you in the classic \"Felsenstein zone,\" where uncorrected distances can cause the algorithm to infer an incorrect topology by grouping distantly related, long-branched taxa. By working through this famous example, you will see firsthand how the method can fail, underscoring the critical link between algorithmic inputs and the accuracy of phylogenetic inference [@problem_id:2408887].", "problem": "A four-taxon case illustrating the long-branch attraction configuration known as the Felsenstein zone is constructed as follows. The true unrooted topology is the split $(A,B)\\,|\\,(C,D)$, with taxa $A$ and $C$ having long external branches and taxa $B$ and $D$ having short external branches, separated by a short internal branch. Suppose that, instead of using a model-corrected evolutionary distance, one uses the uncorrected Hamming distance (also called the $p$-distance) estimated from sufficiently long independent and identically distributed sites, yielding the following symmetric distance matrix $D = (d_{ij})$ on taxa $\\{A,B,C,D\\}$:\n$$\nD \\;=\\;\n\\begin{pmatrix}\n0  0.6669  0.7366  0.6692 \\\\\n0.6669  0  0.6692  0.2603 \\\\\n0.7366  0.6692  0  0.6669 \\\\\n0.6692  0.2603  0.6669  0\n\\end{pmatrix}.\n$$\nApply the neighbor-joining (NJ) method to $D$ step-by-step to determine the unrooted topology NJ would infer, and explain why that topology is incorrect relative to the true split $(A,B)\\,|\\,(C,D)$. As your reported numerical result, compute the most negative entry of the NJ $Q$-matrix in the first NJ iteration. Round your answer to four significant figures. Express the final answer as a pure number without units.", "solution": "The problem requires the application of the neighbor-joining (NJ) method to a given distance matrix for four taxa $\\{A, B, C, D\\}$. The objective is to determine the inferred topology, explain why it is incorrect with respect to the given true topology, and compute the most negative value in the NJ $Q$-matrix during the first iteration.\n\nThe problem is first validated.\nGivens:\n1.  Set of four taxa: $\\{A, B, C, D\\}$.\n2.  True unrooted topology: the split $(A,B)\\,|\\,(C,D)$.\n3.  Branch length characterization (Felsenstein zone): long external branches for $A$ and $C$; short external branches for $B$ and $D$; short internal branch.\n4.  The distance matrix $D$ is a symmetric matrix of uncorrected Hamming distances:\n    $$\n    D =\n    \\begin{pmatrix}\n    0  0.6669  0.7366  0.6692 \\\\\n    0.6669  0  0.6692  0.2603 \\\\\n    0.7366  0.6692  0  0.6669 \\\\\n    0.6692  0.2603  0.6669  0\n    \\end{pmatrix}\n    $$\n5.  The final numerical result must be the most negative entry of the initial $Q$-matrix, rounded to four significant figures.\n\nValidation Verdict: The problem is scientifically grounded, well-posed, and objective. It describes a classic scenario of long-branch attraction in phylogenetics, providing all necessary data for the application of the standard neighbor-joining algorithm. The problem is valid.\n\nWe proceed with the solution.\n\nThe neighbor-joining algorithm begins by constructing a $Q$-matrix from the distance matrix $D$. For a set of $n$ taxa, the entries of the $Q$-matrix are defined as:\n$$\nQ_{ij} = (n-2)d_{ij} - \\sum_{k=1}^{n} d_{ik} - \\sum_{k=1}^{n} d_{jk}\n$$\nwhere $d_{ij}$ is the distance between taxa $i$ and $j$.\n\nIn this problem, we have $n=4$ taxa. Thus, the coefficient $(n-2)$ is equal to $2$. Let us define $u_i = \\sum_{k=1}^{4} d_{ik}$, which represents the sum of distances from taxon $i$ to all other taxa. The formula for $Q_{ij}$ becomes:\n$$\nQ_{ij} = 2d_{ij} - u_i - u_j\n$$\n\nFirst, we calculate the values of $u_i$ for each taxon $i \\in \\{A, B, C, D\\}$.\n$$\nu_A = d_{AB} + d_{AC} + d_{AD} = 0.6669 + 0.7366 + 0.6692 = 2.0727\n$$\n$$\nu_B = d_{BA} + d_{BC} + d_{BD} = 0.6669 + 0.6692 + 0.2603 = 1.5964\n$$\n$$\nu_C = d_{CA} + d_{CB} + d_{CD} = 0.7366 + 0.6692 + 0.6669 = 2.0727\n$$\n$$\nu_D = d_{DA} + d_{DB} + d_{DC} = 0.6692 + 0.2603 + 0.6669 = 1.5964\n$$\n\nNext, we compute the off-diagonal entries of the $Q$-matrix for all pairs of distinct taxa.\n$$\nQ_{AB} = 2d_{AB} - u_A - u_B = 2(0.6669) - 2.0727 - 1.5964 = 1.3338 - 3.6691 = -2.3353\n$$\n$$\nQ_{AC} = 2d_{AC} - u_A - u_C = 2(0.7366) - 2.0727 - 2.0727 = 1.4732 - 4.1454 = -2.6722\n$$\n$$\nQ_{AD} = 2d_{AD} - u_A - u_D = 2(0.6692) - 2.0727 - 1.5964 = 1.3384 - 3.6691 = -2.3307\n$$\n$$\nQ_{BC} = 2d_{BC} - u_B - u_C = 2(0.6692) - 1.5964 - 2.0727 = 1.3384 - 3.6691 = -2.3307\n$$\n$$\nQ_{BD} = 2d_{BD} - u_B - u_D = 2(0.2603) - 1.5964 - 1.5964 = 0.5206 - 3.1928 = -2.6722\n$$\n$$\nQ_{CD} = 2d_{CD} - u_C - u_D = 2(0.6669) - 2.0727 - 1.5964 = 1.3338 - 3.6691 = -2.3353\n$$\n\nThe complete $Q$-matrix (with diagonal entries undefined) is:\n$$\nQ =\n\\begin{pmatrix}\n-  -2.3353  -2.6722  -2.3307 \\\\\n-2.3353  -  -2.3307  -2.6722 \\\\\n-2.6722  -2.3307  -  -2.3353 \\\\\n-2.3307  -2.6722  -2.3353  -\n\\end{pmatrix}\n$$\n\nThe most negative entry in this $Q$-matrix is $-2.6722$. This value appears for two pairs: $(A,C)$ and $(B,D)$. Rounding this value to four significant figures gives $-2.672$. This is the required numerical result.\n\nTo determine the inferred topology, we continue the NJ algorithm. The algorithm identifies the pair of taxa $(i,j)$ for which $Q_{ij}$ is minimum. In this case, there is a tie between $(A,C)$ and $(B,D)$. The NJ algorithm can proceed by choosing either pair. Let us choose to join taxa $A$ and $C$. A new node, let's call it $U$, is created, and the branch lengths from $U$ to $A$ and $C$ are calculated. A new distance matrix is then computed for the remaining taxa $\\{B, D, U\\}$. With only three taxa remaining, the algorithm terminates by joining them to a central node. The resulting unrooted tree structure connects the clade $(A,C)$ as a sister group to $B$ and $D$. This corresponds to the unrooted topology defined by the split $(A,C)\\,|\\,(B,D)$. Had we chosen the pair $(B,D)$ to join first, the result would be identical, yielding the same topology.\n\nThe problem states that the true topology is the split $(A,B)\\,|\\,(C,D)$. The NJ algorithm, however, inferred the topology $(A,C)\\,|\\,(B,D)$. Therefore, the NJ algorithm returned an incorrect result.\n\nThe reason for this failure is a well-known artifact in phylogenetic reconstruction called long-branch attraction (LBA). The problem is set up in what is known as the Felsenstein zone, which is designed to induce LBA. The true tree has long external branches leading to taxa $A$ and $C$. On these long branches, a large number of substitutions occur. The use of uncorrected Hamming ($p$-)distances fails to account for multiple substitutions occurring at the same site (saturation). This leads to a systematic underestimation of the evolutionary distance between distantly related taxa. Consequently, the measured distance $d_{AC}$ is shorter than the true evolutionary path length.\n\nFurthermore, due to the large number of independent substitutions along the two long branches, there is a significant probability that taxa $A$ and $C$ will coincidentally acquire the same character state (homoplasy). This makes them appear more similar to each other than they are to their true, more closely related sister taxa ($B$ and $D$, respectively), which are on short branches and have undergone less change.\n\nThe NJ algorithm, being a distance-based method, is sensitive to inaccuracies in the input distance matrix. The non-additive nature of the uncorrected distances, distorted by saturation and homoplasy, misleads the algorithm. The $Q$-matrix minimization criterion incorrectly identifies the long-branched pair $(A,C)$ as neighbors because their underestimated distance makes them appear artifactually close. This causes the algorithm to \"attract\" the long branches together, resulting in the incorrect topology $(A,C)\\,|\\,(B,D)$ instead of the true topology $(A,B)\\,|\\,(C,D)$. This demonstrates a classic case where distance-based methods can fail if not used with a proper model of evolution to correct for multiple hits.", "answer": "$$\n\\boxed{-2.672}\n$$", "id": "2408887"}, {"introduction": "This computational practice challenges you to think critically about algorithmic design by exploring how the standard NJ criterion can be improved. The standard formula uses a sum of distances, making it sensitive to outliers. Here, you will compare it against a modified version that uses a more robust statistic, the median, to see if it can better handle taxa with unusually long branches, which can otherwise lead to incorrect tree topologies [@problem_id:2408937].", "problem": "You are given finite sets of taxa with pairwise dissimilarities encoded as symmetric distance matrices that satisfy nonnegativity and zero diagonal. For a current set of taxa indices $\\mathcal{T}$ with $|\\mathcal{T}|=n$, the classical Neighbor-Joining (NJ) pair-selection criterion defines, for each unordered pair $\\{i,j\\}\\subset\\mathcal{T}$ with $i\\neq j$, the score\n$$\nQ(i,j) \\;=\\; (n-2)\\,d(i,j)\\;-\\;\\sum_{k\\in\\mathcal{T}} d(i,k)\\;-\\;\\sum_{k\\in\\mathcal{T}} d(j,k).\n$$\nConsider a robust alternative where the summation terms are replaced by the median of the set of distances, namely\n$$\nQ_{\\mathrm{med}}(i,j) \\;=\\; (n-2)\\,d(i,j)\\;-\\;\\mathrm{median}\\big(\\{d(i,k)\\;:\\;k\\in\\mathcal{T},\\,k\\neq i\\}\\big)\\;-\\;\\mathrm{median}\\big(\\{d(j,k)\\;:\\;k\\in\\mathcal{T},\\,k\\neq j\\}\\big).\n$$\nThe median of a finite multiset of real numbers is defined as the middle element after sorting; in the case of an even count, it is the arithmetic mean of the two middle elements.\n\nYour task is to write a complete program that, for each test case below, does all of the following in purely mathematical terms:\n- Treat the taxa as labeled by consecutive integers starting at $0$.\n- Compute the unordered pair $\\{i,j\\}$ that minimizes $Q(i,j)$ and the unordered pair that minimizes $Q_{\\mathrm{med}}(i,j)$ over all $\\{i,j\\}\\subset\\mathcal{T}$ with $i\\neq j$. In the event of a tie in the minimum value, break ties by choosing the lexicographically smallest ordered pair $(i,j)$ with $ij$ among the tied unordered pairs.\n- A designated subset $\\mathcal{O}\\subseteq\\mathcal{T}$ of “outlier” taxa and a designated set $\\mathcal{S}$ of “target sibling” unordered pairs are provided for each test case. Define an indicator $I$ as follows: $I=1$ if the classical minimum pair is a “bad” pair consisting of two elements of $\\mathcal{O}$, while the robust-median minimum pair is one of the pairs in $\\mathcal{S}$; otherwise $I=0$.\n\nTest suite. Each test case specifies $(\\mathcal{T},D,\\mathcal{O},\\mathcal{S})$, where $D=(d(i,j))_{i,j\\in\\mathcal{T}}$ is the distance matrix.\n\n- Test case $1$ (balanced, no outlier):\n  - $\\mathcal{T}=\\{0,1,2,3\\}$.\n  - Distance matrix\n    $$\n    D^{(1)}=\\begin{pmatrix}\n    0  2  6  6\\\\\n    2  0  6  6\\\\\n    6  6  0  2\\\\\n    6  6  2  0\n    \\end{pmatrix}.\n    $$\n  - Outliers $\\mathcal{O}=\\varnothing$.\n  - Target siblings $\\mathcal{S}=\\big\\{\\{0,1\\},\\{2,3\\}\\big\\}$.\n\n- Test case $2$ (two long-branch outliers that are close to each other):\n  - $\\mathcal{T}=\\{0,1,2,3,4,5\\}$.\n  - Distance matrix\n    $$\n    D^{(2)}=\\begin{pmatrix}\n    0  2  20  20  50  50\\\\\n    2  0  20  20  50  50\\\\\n    20  20  0  2  50  50\\\\\n    20  20  2  0  50  50\\\\\n    50  50  50  50  0  30\\\\\n    50  50  50  50  30  0\n    \\end{pmatrix}.\n    $$\n  - Outliers $\\mathcal{O}=\\{4,5\\}$.\n  - Target siblings $\\mathcal{S}=\\big\\{\\{0,1\\},\\{2,3\\}\\big\\}$.\n\n- Test case $3$ (boundary with $3$ taxa and one outlier):\n  - $\\mathcal{T}=\\{0,1,2\\}$.\n  - Distance matrix\n    $$\n    D^{(3)}=\\begin{pmatrix}\n    0  2  50\\\\\n    2  0  50\\\\\n    50  50  0\n    \\end{pmatrix}.\n    $$\n  - Outliers $\\mathcal{O}=\\{2\\}$.\n  - Target siblings $\\mathcal{S}=\\big\\{\\{0,1\\}\\big\\}$.\n\nFinal output format. Your program must produce a single line containing a list of results for all test cases, in order. The result for each test case is a list of five integers $[c_i,c_j,r_i,r_j,I]$, where $(c_i,c_j)$ with $c_ic_j$ is the classical $Q$-minimizing pair, $(r_i,r_j)$ with $r_ir_j$ is the robust $Q_{\\mathrm{med}}$-minimizing pair, and $I\\in\\{0,1\\}$ is the indicator defined above. The combined output must be emitted as a single line with no extra characters, for example\n[[c^(1)_i,c^(1)_j,r^(1)_i,r^(1)_j,I^(1)], [c^(2)_i,c^(2)_j,r^(2)_i,r^(2)_j,I^(2)], [c^(3)_i,c^{(3)}_j,r^{(3)}_i,r^{(3)}_j,I^{(3)}]].\nThere are no physical units involved. Angles are not used. All numerical outputs are plain integers as specified.", "solution": "The problem is subjected to validation before a solution is attempted.\n\n**Step 1: Extract Givens**\n\n- **Taxa Set**: A finite set of taxa indices, $\\mathcal{T}$, with size $n=|\\mathcal{T}|$.\n- **Distance Matrix**: A symmetric matrix $D=(d(i,j))$ for $i,j \\in \\mathcal{T}$ such that $d(i,j) \\ge 0$ and $d(i,i)=0$.\n- **Classical NJ Score**: For an unordered pair $\\{i,j\\}\\subset\\mathcal{T}$ with $i\\neq j$, the score is $Q(i,j) = (n-2)d(i,j) - \\sum_{k\\in\\mathcal{T}} d(i,k) - \\sum_{k\\in\\mathcal{T}} d(j,k)$.\n- **Robust-Median NJ Score**: For an unordered pair $\\{i,j\\}\\subset\\mathcal{T}$ with $i\\neq j$, the score is $Q_{\\mathrm{med}}(i,j) = (n-2)d(i,j) - \\mathrm{median}(\\{d(i,k) : k\\in\\mathcal{T}, k\\neq i\\}) - \\mathrm{median}(\\{d(j,k) : k\\in\\mathcal{T}, k\\neq j\\})$.\n- **Median Definition**: For a finite multiset of real numbers, it is the middle element after sorting. If the count is even, it is the arithmetic mean of the two middle elements.\n- **Minimization Task**: Find the unordered pair $\\{i,j\\}$ that minimizes $Q(i,j)$ and the unordered pair that minimizes $Q_{\\mathrm{med}}(i,j)$.\n- **Tie-Breaking Rule**: In case of a tie for the minimum value, select the lexicographically smallest ordered pair $(i,j)$ with $ij$.\n- **Indicator $I$**: $I=1$ if the classical minimum pair consists of two elements from a designated \"outlier\" set $\\mathcal{O}$ AND the robust-median minimum pair is in a designated set of \"target sibling\" pairs $\\mathcal{S}$. Otherwise, $I=0$.\n- **Test Cases**: Three test cases are provided, each specifying $(\\mathcal{T}, D, \\mathcal{O}, \\mathcal{S})$.\n    - **Test Case 1**: $\\mathcal{T}=\\{0,1,2,3\\}$, $D^{(1)}$, $\\mathcal{O}=\\varnothing$, $\\mathcal{S}=\\big\\{\\{0,1\\},\\{2,3\\}\\big\\}$.\n    - **Test Case 2**: $\\mathcal{T}=\\{0,1,2,3,4,5\\}$, $D^{(2)}$, $\\mathcal{O}=\\{4,5\\}$, $\\mathcal{S}=\\big\\{\\{0,1\\},\\{2,3\\}\\big\\}$.\n    - **Test Case 3**: $\\mathcal{T}=\\{0,1,2\\}$, $D^{(3)}$, $\\mathcal{O}=\\{2\\}$, $\\mathcal{S}=\\big\\{\\{0,1\\}\\big\\}$.\n- **Output Format**: For each test case, a list $[c_i,c_j,r_i,r_j,I]$, where $(c_i,c_j)$ is the classical minimizing pair ($c_ic_j$), $(r_i,r_j)$ is the robust minimizing pair ($r_ir_j$), and $I$ is the indicator.\n\n**Step 2: Validate Using Extracted Givens**\n\n- **Scientifically Grounded**: The problem is well-grounded in computational biology and phylogenetics. The Neighbor-Joining (NJ) method is a standard, widely used algorithm for phylogenetic tree reconstruction. The introduction of a median-based criterion is a legitimate modification to address the sensitivity of the standard NJ method to long-branch attraction, a known artifact. The problem is a formal mathematical exploration of this modification.\n- **Well-Posed**: The problem is mathematically precise. The scoring functions $Q(i,j)$ and $Q_{\\mathrm{med}}(i,j)$ are unambiguously defined. The objective is to find the minimum of these functions over a finite set of pairs. The existence of a minimum is guaranteed. The specified tie-breaking rule ensures the uniqueness of the solution.\n- **Objective**: The problem statement uses formal, objective language and avoids any subjective or speculative claims.\n\nThe problem does not exhibit any flaws related to scientific soundness, formalizability, completeness, realism, or structure. All terms are defined, all data is provided, and the task is directly solvable using the given information.\n\n**Step 3: Verdict and Action**\n\nThe problem is **valid**. A solution will be provided.\n\n**Solution**\n\nThe methodology involves computing the scores $Q(i,j)$ and $Q_{\\mathrm{med}}(i,j)$ for all unique unordered pairs $\\{i,j\\}$ of taxa for each test case. The minimizing pairs are identified, adhering to the specified tie-breaking rule. Finally, the indicator $I$ is calculated based on the identified pairs and the given sets $\\mathcal{O}$ and $\\mathcal{S}$.\n\nLet a test case be defined by $(\\mathcal{T}, D, \\mathcal{O}, \\mathcal{S})$. Let $n = |\\mathcal{T}|$. The taxa are labeled by integers from $0$ to $n-1$.\n\nFor each ordered pair $(i,j)$ with $0 \\le i  j  n$:\n1.  **Calculate $Q(i,j)$:**\n    - Compute the row sums $S_i = \\sum_{k=0}^{n-1} d(i,k)$ and $S_j = \\sum_{k=0}^{n-1} d(j,k)$.\n    - The score is $Q(i,j) = (n-2)d(i,j) - S_i - S_j$.\n2.  **Calculate $Q_{\\mathrm{med}}(i,j)$:**\n    - For taxon $i$, form the multiset of distances to all other taxa: $D_i = \\{d(i,k) : k \\in \\mathcal{T}, k \\neq i\\}$.\n    - Compute the median $M_i = \\mathrm{median}(D_i)$.\n    - Similarly, compute $M_j = \\mathrm{median}(D_j)$.\n    - The score is $Q_{\\mathrm{med}}(i,j) = (n-2)d(i,j) - M_i - M_j$.\n3.  After computing all scores, find the minimum value for $Q$ and $Q_{\\mathrm{med}}$ and their corresponding pairs. The iteration over pairs in lexicographical order $(i,j)$ with $ij$ automatically handles the tie-breaking rule: the first pair found to achieve the minimum value is the correct one.\n4.  Let $(c_i, c_j)$ be the minimizing pair for $Q$ and $(r_i, r_j)$ be the minimizing pair for $Q_{\\mathrm{med}}$.\n5.  **Calculate Indicator $I$**:\n    - The classical pair is \"bad\" if $\\{c_i, c_j\\} \\subseteq \\mathcal{O}$.\n    - The robust pair is \"good\" if $\\{r_i, r_j\\} \\in \\mathcal{S}$.\n    - $I=1$ if both conditions are met; otherwise, $I=0$.\n\n**Test Case 1**\n- $\\mathcal{T}=\\{0,1,2,3\\}$, $n=4$, $n-2=2$.\n- $D^{(1)} = \\begin{pmatrix} 0  2  6  6\\\\ 2  0  6  6\\\\ 6  6  0  2\\\\ 6  6  2  0 \\end{pmatrix}$.\n- $\\mathcal{O}=\\varnothing$, $\\mathcal{S}=\\big\\{\\{0,1\\},\\{2,3\\}\\big\\}$.\n\n**Classical Score $Q(i,j)$**:\nThe matrix is symmetric, so all row sums are equal: $S_0=S_1=S_2=S_3 = 2+6+6=14$.\n- $Q(0,1) = 2 \\cdot d(0,1) - S_0 - S_1 = 2 \\cdot 2 - 14 - 14 = -24$.\n- $Q(0,2) = 2 \\cdot d(0,2) - S_0 - S_2 = 2 \\cdot 6 - 14 - 14 = -16$.\n- $Q(0,3) = 2 \\cdot d(0,3) - S_0 - S_3 = 2 \\cdot 6 - 14 - 14 = -16$.\n- $Q(1,2) = 2 \\cdot d(1,2) - S_1 - S_2 = 2 \\cdot 6 - 14 - 14 = -16$.\n- $Q(1,3) = 2 \\cdot d(1,3) - S_1 - S_3 = 2 \\cdot 6 - 14 - 14 = -16$.\n- $Q(2,3) = 2 \\cdot d(2,3) - S_2 - S_3 = 2 \\cdot 2 - 14 - 14 = -24$.\nThe minimum value is $-24$, achieved by pairs $\\{0,1\\}$ and $\\{2,3\\}$. By the tie-breaking rule, we choose the lexicographically smallest pair $(0,1)$.\nThus, $(c_i, c_j) = (0,1)$.\n\n**Robust-Median Score $Q_{\\mathrm{med}}(i,j)$**:\nThe multisets of distances from each taxon (excluding self-distance) are:\n- $D_0 = \\{2,6,6\\}$, median $M_0=6$.\n- $D_1 = \\{2,6,6\\}$, median $M_1=6$.\n- $D_2 = \\{6,6,2\\}$, median $M_2=6$.\n- $D_3 = \\{6,6,2\\}$, median $M_3=6$.\nAll medians are $6$.\n- $Q_{\\mathrm{med}}(0,1) = 2 \\cdot d(0,1) - M_0 - M_1 = 2 \\cdot 2 - 6 - 6 = -8$.\n- $Q_{\\mathrm{med}}(0,2) = 2 \\cdot d(0,2) - M_0 - M_2 = 2 \\cdot 6 - 6 - 6 = 0$.\n- $Q_{\\mathrm{med}}(0,3) = 2 \\cdot d(0,3) - M_0 - M_3 = 2 \\cdot 6 - 6 - 6 = 0$.\n- $Q_{\\mathrm{med}}(1,2) = 2 \\cdot d(1,2) - M_1 - M_2 = 2 \\cdot 6 - 6 - 6 = 0$.\n- $Q_{\\mathrm{med}}(1,3) = 2 \\cdot d(1,3) - M_1 - M_3 = 2 \\cdot 6 - 6 - 6 = 0$.\n- $Q_{\\mathrm{med}}(2,3) = 2 \\cdot d(2,3) - M_2 - M_3 = 2 \\cdot 2 - 6 - 6 = -8$.\nThe minimum value is $-8$, for pairs $\\{0,1\\}$ and $\\{2,3\\}$. The lexicographically smallest is $(0,1)$.\nThus, $(r_i, r_j) = (0,1)$.\n\n**Indicator $I$**:\n- Classical pair $\\{0,1\\}$. $\\mathcal{O}=\\varnothing$. Is $\\{0,1\\} \\subseteq \\varnothing$? No.\nThe first condition for $I=1$ is not met. Thus, $I=0$.\nResult for Test Case 1: $[0, 1, 0, 1, 0]$.\n\n---\n\n**Test Case 2**\n- $\\mathcal{T}=\\{0,1,2,3,4,5\\}$, $n=6$, $n-2=4$.\n- $D^{(2)}=\\begin{pmatrix} 0  2  20  20  50  50\\\\ 2  0  20  20  50  50\\\\ 20  20  0  2  50  50\\\\ 20  20  2  0  50  50\\\\ 50  50  50  50  0  30\\\\ 50  50  50  50  30  0 \\end{pmatrix}$.\n- $\\mathcal{O}=\\{4,5\\}$, $\\mathcal{S}=\\big\\{\\{0,1\\},\\{2,3\\}\\big\\}$.\n\n**Classical Score $Q(i,j)$**:\nRow sums:\n- $S_0=S_1=S_2=S_3 = 2+20+20+50+50 = 142$.\n- $S_4=S_5 = 50+50+50+50+30 = 230$.\n- $Q(0,1) = 4 \\cdot 2 - 142 - 142 = -276$.\n- $Q(2,3) = 4 \\cdot 2 - 142 - 142 = -276$.\n- $Q(4,5) = 4 \\cdot 30 - 230 - 230 = 120 - 460 = -340$.\n- $Q(0,2) = 4 \\cdot 20 - 142 - 142 = 80 - 284 = -204$.\n- $Q(0,4) = 4 \\cdot 50 - 142 - 230 = 200 - 372 = -172$.\nThe minimum value is $-340$, uniquely achieved by pair $\\{4,5\\}$.\nThus, $(c_i, c_j) = (4,5)$.\n\n**Robust-Median Score $Q_{\\mathrm{med}}(i,j)$**:\nThe multisets of distances have size $n-1=5$. The median is the 3rd element.\n- $D_{0,1,2,3} = \\{2,20,20,50,50\\}$ (in some order). Median $M_0=M_1=M_2=M_3=20$.\n- $D_{4,5} = \\{30,50,50,50,50\\}$ (in some order). Median $M_4=M_5=50$.\n- $Q_{\\mathrm{med}}(0,1) = 4 \\cdot 2 - 20 - 20 = -32$.\n- $Q_{\\mathrm{med}}(2,3) = 4 \\cdot 2 - 20 - 20 = -32$.\n- $Q_{\\mathrm{med}}(4,5) = 4 \\cdot 30 - 50 - 50 = 20$.\n- $Q_{\\mathrm{med}}(0,2) = 4 \\cdot 20 - 20 - 20 = 40$.\n- $Q_{\\mathrm{med}}(0,4) = 4 \\cdot 50 - 20 - 50 = 130$.\nThe minimum is $-32$, for pairs $\\{0,1\\}$ and $\\{2,3\\}$. The lexicographically smallest is $(0,1)$.\nThus, $(r_i, r_j) = (0,1)$.\n\n**Indicator $I$**:\n- Classical pair $\\{4,5\\}$. $\\mathcal{O}=\\{4,5\\}$. Is $\\{4,5\\} \\subseteq \\{4,5\\}$? Yes.\n- Robust pair $\\{0,1\\}$. $\\mathcal{S}=\\big\\{\\{0,1\\},\\{2,3\\}\\big\\}$. Is $\\{0,1\\} \\in \\mathcal{S}$? Yes.\nBoth conditions are met. Thus, $I=1$.\nResult for Test Case 2: $[4, 5, 0, 1, 1]$.\n\n---\n\n**Test Case 3**\n- $\\mathcal{T}=\\{0,1,2\\}$, $n=3$, $n-2=1$.\n- $D^{(3)}=\\begin{pmatrix} 0  2  50\\\\ 2  0  50\\\\ 50  50  0 \\end{pmatrix}$.\n- $\\mathcal{O}=\\{2\\}$, $\\mathcal{S}=\\big\\{\\{0,1\\}\\big\\}$.\n\nThis case is a boundary condition for NJ, which requires $n \\ge 3$. Here $n=3$, so $(n-2)=1$. All pairs will have the same $Q$ value if the distance matrix is ultrametric, which is not the case here.\n\n**Classical Score $Q(i,j)$**:\nRow sums:\n- $S_0 = 2+50=52$.\n- $S_1 = 2+50=52$.\n- $S_2 = 50+50=100$.\n- $Q(0,1) = 1 \\cdot d(0,1) - S_0 - S_1 = 2 - 52 - 52 = -102$.\n- $Q(0,2) = 1 \\cdot d(0,2) - S_0 - S_2 = 50 - 52 - 100 = -102$.\n- $Q(1,2) = 1 \\cdot d(1,2) - S_1 - S_2 = 50 - 52 - 100 = -102$.\nThe minimum value is $-102$, achieved by all three pairs. The lexicographically smallest is $(0,1)$.\nThus, $(c_i, c_j) = (0,1)$.\n\n**Robust-Median Score $Q_{\\mathrm{med}}(i,j)$**:\nThe multisets of distances have size $n-1=2$. The median is the average of the two elements.\n- $D_0 = \\{2,50\\}$, median $M_0 = (2+50)/2 = 26$.\n- $D_1 = \\{2,50\\}$, median $M_1 = (2+50)/2 = 26$.\n- $D_2 = \\{50,50\\}$, median $M_2 = (50+50)/2 = 50$.\n- $Q_{\\mathrm{med}}(0,1) = 1 \\cdot d(0,1) - M_0 - M_1 = 2 - 26 - 26 = -50$.\n- $Q_{\\mathrm{med}}(0,2) = 1 \\cdot d(0,2) - M_0 - M_2 = 50 - 26 - 50 = -26$.\n- $Q_{\\mathrm{med}}(1,2) = 1 \\cdot d(1,2) - M_1 - M_2 = 50 - 26 - 50 = -26$.\nThe minimum value is $-50$, uniquely achieved by pair $\\{0,1\\}$.\nThus, $(r_i, r_j) = (0,1)$.\n\n**Indicator $I$**:\n- Classical pair $\\{0,1\\}$. $\\mathcal{O}=\\{2\\}$. Is $\\{0,1\\} \\subseteq \\{2\\}$? No. The condition requires a pair of two elements from $\\mathcal{O}$, which is impossible as $|\\mathcal{O}|=1$.\nThe first condition is not met. Thus, $I=0$.\nResult for Test Case 3: $[0, 1, 0, 1, 0]$.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the phylogenetic pair selection problem for the given test cases.\n    \"\"\"\n\n    test_cases = [\n        {\n            \"D\": np.array([\n                [0, 2, 6, 6],\n                [2, 0, 6, 6],\n                [6, 6, 0, 2],\n                [6, 6, 2, 0]\n            ]),\n            \"O\": { },\n            \"S\": {frozenset({0, 1}), frozenset({2, 3})}\n        },\n        {\n            \"D\": np.array([\n                [0, 2, 20, 20, 50, 50],\n                [2, 0, 20, 20, 50, 50],\n                [20, 20, 0, 2, 50, 50],\n                [20, 20, 2, 0, 50, 50],\n                [50, 50, 50, 50, 0, 30],\n                [50, 50, 50, 50, 30, 0]\n            ]),\n            \"O\": {4, 5},\n            \"S\": {frozenset({0, 1}), frozenset({2, 3})}\n        },\n        {\n            \"D\": np.array([\n                [0, 2, 50],\n                [2, 0, 50],\n                [50, 50, 0]\n            ]),\n            \"O\": {2},\n            \"S\": {frozenset({0, 1})}\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        result = solve_case(case[\"D\"], case[\"O\"], case[\"S\"])\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    # The format is a list of lists, so we manually build the string.\n    print(f\"[{','.join(map(str, results))}]\")\n\n\ndef solve_case(D, O, S):\n    \"\"\"\n    Computes the Q-minimizing and Q_med-minimizing pairs for a single test case.\n\n    Args:\n        D (np.ndarray): The distance matrix.\n        O (set): The set of outlier taxa indices.\n        S (set): The set of target sibling pairs (as frozensets).\n\n    Returns:\n        list: A list containing [c_i, c_j, r_i, r_j, I].\n    \"\"\"\n    n = D.shape[0]\n\n    # Pre-calculate row sums for Q and medians for Q_med\n    row_sums = np.sum(D, axis=1)\n    \n    # The set of distances from a taxon i has size n-1. \n    # To compute the median, we need to consider all distances d(i,k) where k is not i.\n    row_medians = np.zeros(n)\n    for i in range(n):\n        distances_from_i = np.delete(D[i, :], i)\n        row_medians[i] = np.median(distances_from_i)\n\n    # Initialize variables to find the minimums\n    # Tie-breaking for lexicographically smallest pair is handled by iterating\n    # through pairs in lexicographical order (i from 0 to n-1, j from i+1 to n-1).\n    # The first pair found that achieves the minimum score will be the correct one.\n    min_q = float('inf')\n    c_pair = (-1, -1)\n    min_q_med = float('inf')\n    r_pair = (-1, -1)\n\n    # Iterate over all unique unordered pairs {i,j}\n    for i in range(n):\n        for j in range(i + 1, n):\n            # Calculate classical Q score\n            q_val = (n - 2) * D[i, j] - row_sums[i] - row_sums[j]\n            if q_val  min_q:\n                min_q = q_val\n                c_pair = (i, j)\n\n            # Calculate robust median Q_med score\n            q_med_val = (n - 2) * D[i, j] - row_medians[i] - row_medians[j]\n            if q_med_val  min_q_med:\n                min_q_med = q_med_val\n                r_pair = (i, j)\n\n    # Calculate the indicator I\n    c_i, c_j = c_pair\n    r_i, r_j = r_pair\n\n    # Condition 1: classical pair is \"bad\" (both taxa are outliers)\n    # The pair {c_i, c_j} must be a subset of O.\n    cond1 = (c_i in O) and (c_j in O)\n\n    # Condition 2: robust pair is a target sibling pair\n    cond2 = frozenset(r_pair) in S\n\n    indicator_I = 1 if cond1 and cond2 else 0\n\n    return [c_i, c_j, r_i, r_j, indicator_I]\n\nsolve()\n```", "id": "2408937"}]}