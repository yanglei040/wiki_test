{"hands_on_practices": [{"introduction": "The introduction of artificial viscosity is not without consequences for the numerical integration of the system. By design, it creates a dissipative signal that propagates between particles, and the stability of any explicit time-integration scheme requires that the timestep is small enough to resolve this propagation. This exercise [@problem_id:3465304] provides hands-on practice with the Courant-Friedrichs-Lewy (CFL) condition, guiding you to calculate the maximum allowed timestep as a function of the local smoothing length and artificial viscosity signal speed.", "problem": "In Smoothed Particle Hydrodynamics (SPH) used for numerical cosmology, artificial viscosity introduces a characteristic pairwise signal velocity that bounds the speed at which compressive disturbances propagate between neighbors. For an explicitly time-integrated method, stability and causality impose that information must not traverse more than an order-unity fraction of the local resolution scale in a single time step, a requirement commonly captured by the Courant–Friedrichs–Lewy (CFL) condition. Consider a single SPH particle evolving under hydrodynamics and gravity in a cosmological setting, with local smoothing length $h$ and an estimate of the maximum pairwise artificial-viscosity signal speed over its neighbors, $v_{\\text{sig}}$. Assume a standard explicit scheme in which the only relevant bound is that set by finite signal propagation over the kernel scale, modulated by a dimensionless Courant factor $C_{\\text{CFL}} \\in (0,1)$.\n\nStarting from these principles and definitions, derive a general expression for the particle’s maximum allowed time step $\\Delta t_{\\max}$ in terms of $h$, $v_{\\text{sig}}$, and $C_{\\text{CFL}}$. Then evaluate this maximum time step for a particle with $h = 0.005$, neighbor-maximum $v_{\\text{sig}} = 30$, and $C_{\\text{CFL}} = 0.25$. All quantities are given in consistent code units so that the resulting time step is in code time units. Round your final numerical answer to $4$ significant figures. Finally, based on your derivation, discuss the implications of this bound for local time-stepping strategies in cosmological simulations, particularly in regions with strong shocks and large density contrasts. Your final reported answer must be the single numerical value of $\\Delta t_{\\max}$ in code time units.", "solution": "The relevant starting point is the stability constraint for explicit time integration in hyperbolic systems with finite signal propagation speeds. In such systems, the Courant–Friedrichs–Lewy (CFL) condition enforces that in one time step, the fastest signal should not traverse more than an order-unity fraction of the local resolution scale. In Smoothed Particle Hydrodynamics (SPH), the local resolution scale is set by the smoothing length $h$, while the maximal neighbor-to-neighbor propagation speed of compressive disturbances in the presence of artificial viscosity is captured by an estimate $v_{\\text{sig}}$ constructed from pairwise interactions.\n\nThe fundamental requirement is that the distance traversed by the fastest relevant signal during a time step $\\Delta t$ is bounded by a fraction of the resolution length. Writing this causality and stability constraint,\n$$\nv_{\\text{sig}} \\, \\Delta t \\lesssim C_{\\text{CFL}} \\, h,\n$$\nwhere $C_{\\text{CFL}} \\in (0,1)$ is a dimensionless Courant factor that encodes the geometric constants of the kernel support, details of the explicit scheme, and a safety margin for nonlinearities and multi-dimensional effects. Solving this for the time step bound gives the general expression\n$$\n\\Delta t_{\\max} = \\frac{C_{\\text{CFL}} \\, h}{v_{\\text{sig}}}.\n$$\n\nThis follows directly from (i) the definition of the SPH smoothing length $h$ as the characteristic kernel scale over which interactions are resolved, (ii) the identification of $v_{\\text{sig}}$ as an upper bound to the neighbor-to-neighbor information speed introduced by artificial viscosity to capture compressive shocks, and (iii) the stability requirement of explicit methods that the domain of dependence of the discrete scheme must contain that of the continuum problem.\n\nWe now evaluate this expression for the specified particle data. Given $h = 0.005$, $v_{\\text{sig}} = 30$, and $C_{\\text{CFL}} = 0.25$, all in consistent code units, we substitute into\n$$\n\\Delta t_{\\max} = \\frac{C_{\\text{CFL}} \\, h}{v_{\\text{sig}}}.\n$$\nCompute the numerator:\n$$\nC_{\\text{CFL}} \\, h = 0.25 \\times 0.005 = 0.00125.\n$$\nDivide by $v_{\\text{sig}}$:\n$$\n\\Delta t_{\\max} = \\frac{0.00125}{30} = 0.000041666\\ldots = 4.166666\\ldots \\times 10^{-5}.\n$$\nRounding to $4$ significant figures yields\n$$\n\\Delta t_{\\max} = 4.167 \\times 10^{-5},\n$$\nin code time units.\n\nImplications for local time-stepping in cosmological simulations: The derived bound shows that $\\Delta t_{\\max} \\propto h / v_{\\text{sig}}$. In cosmological structure formation, high-density regions such as virialized halos and shock fronts typically have smaller $h$ (due to Lagrangian adaptivity concentrating resolution) and larger $v_{\\text{sig}}$ (due to enhanced sound speeds and relative velocities across compressive flows that trigger stronger artificial viscosity). Consequently, $\\Delta t_{\\max}$ can decrease by orders of magnitude in these regions compared to the diffuse intergalactic medium. Local time-stepping schemes exploit this by assigning smaller time steps only where needed, thus maintaining accuracy and stability near shocks while avoiding a global time step limited by a tiny subset of particles. However, this introduces challenges: synchronization between hydrodynamics and long-range gravity solvers, conservation errors if neighboring particles evolve with disparate time steps, and the need for time-step limiters to prevent large disparities across interacting neighbors. In comoving formulations, care must also be taken that $v_{\\text{sig}}$ and $h$ are consistently defined in the same (physical or comoving) frame so that the CFL bound remains meaningful. Overall, the scaling $\\Delta t_{\\max} \\sim h / v_{\\text{sig}}$ motivates hierarchical local time-stepping with neighbor-aware limiters in realistic cosmological flows.", "answer": "$$\\boxed{4.167 \\times 10^{-5}}$$", "id": "3465304"}, {"introduction": "The standard form of artificial viscosity in SPH is a two-component model, and understanding the distinct role of each is key to its effective use. While the linear term provides a bulk viscosity, the quadratic term is a purely numerical construct essential for handling strong shocks. This practice [@problem_id:3465341] explores the physical justification for this quadratic term, connecting it to the momentum flux balance at high Mach numbers and allowing you to determine the regime in which it becomes the dominant dissipative force.", "problem": "In cosmological shock capturing for gas dynamics modeled with Smoothed Particle Hydrodynamics (SPH), the compressible Euler equations,\n$$\n\\frac{\\partial \\rho}{\\partial t} + \\nabla \\cdot (\\rho \\mathbf{v}) = 0, \\qquad\n\\frac{\\partial (\\rho \\mathbf{v})}{\\partial t} + \\nabla \\cdot (\\rho \\mathbf{v}\\mathbf{v} + P \\mathbf{I}) = 0,\n$$\nlack physical viscosity and therefore do not dissipate the kinetic energy flux at a shock. To stabilize shocks and prevent particle interpenetration, an artificial viscosity is introduced that damps approaching motions. Consider a pair of equal-mass SPH particles with separation vector $\\mathbf{r}_{ij}$ and approaching radial speed $v_{r} \\equiv -\\mathbf{v}_{ij} \\cdot \\hat{\\mathbf{r}}_{ij} > 0$ (where $\\hat{\\mathbf{r}}_{ij} \\equiv \\mathbf{r}_{ij}/r_{ij}$). The artificial viscosity is built from a dimensionless approach measure,\n$$\n\\mu_{ij} \\equiv \\frac{h v_{r}}{r_{ij}},\n$$\nwhere $h$ is the local smoothing length, and two contributions often referred to as a linear term and a quadratic term with coefficients $\\alpha$ and $\\beta$. Let the characteristic sound speed be $c_{s}$ and the Mach number be $\\mathcal{M} \\equiv v_{r}/c_{s}$.\n\nUsing the compressible Euler equations as the fundamental base and arguing from momentum flux balance across a shock, justify why a quadratic-in-velocity dissipation is required at high Mach number to prevent particle interpenetration, and deduce the Mach-number threshold $\\mathcal{M}_{\\star}$ above which the quadratic contribution (proportional to $\\beta \\mu_{ij}^{2}$) dominates the linear contribution (proportional to $\\alpha c_{s} \\mu_{ij}$). Express $\\mathcal{M}_{\\star}$ in terms of $\\alpha$, $\\beta$, and $h/r_{ij}$, assuming $v_{r} > 0$ and neglecting any small regularization terms.\n\nThen, for typical cosmological SPH configurations in which neighboring particles are separated by a distance comparable to the smoothing length, take $\\alpha = 1$, $\\beta = 2$, and $h/r_{ij} = 1$ to estimate a numerical value of $\\mathcal{M}_{\\star}$. Express your final answer as a pure number (dimensionless) and round your estimate to three significant figures.", "solution": "The justification for a quadratic-in-velocity dissipation term stems from the momentum balance across a strong shock. In the framework of the compressible Euler equations, the momentum flux must be conserved. For a strong shock where the Mach number $\\mathcal{M} \\gg 1$, the ram pressure ($\\rho v^2$) of the incoming flow far exceeds the thermal pressure ($P$). To decelerate this flow, the post-shock pressure must be on the order of the incoming ram pressure. An effective artificial viscosity must therefore generate a pressure term, $P_{\\text{visc}}$, that scales with the square of the approach velocity, i.e., $P_{\\text{visc}} \\propto v_r^2$.\nThe linear term in the SPH artificial viscosity formulation scales as $P_{\\text{visc, lin}} \\propto \\alpha c_s \\mu_{ij} \\propto v_r$, which is insufficient to halt a high-Mach flow. The quadratic term, however, scales as $P_{\\text{visc, quad}} \\propto \\beta \\mu_{ij}^2 \\propto v_r^2$. This quadratic dependence correctly mimics the scaling of the physical ram pressure, making it essential for preventing particle interpenetration in strong shocks.\n\nTo find the Mach-number threshold $\\mathcal{M}_{\\star}$ where the quadratic contribution dominates, we set the two viscous pressure terms equal:\n$$ \\beta \\mu_{ij}^2 = \\alpha c_{s} \\mu_{ij} $$\nSince $\\mu_{ij} > 0$ for approaching particles, we can divide by $\\mu_{ij}$:\n$$ \\beta \\mu_{ij} = \\alpha c_s $$\nSubstituting the definition $\\mu_{ij} = \\frac{h v_{r}}{r_{ij}}$:\n$$ \\beta \\left( \\frac{h v_{r}}{r_{ij}} \\right) = \\alpha c_s $$\nThe Mach number is $\\mathcal{M} = v_r/c_s$. Solving for this ratio gives the threshold $\\mathcal{M}_\\star$:\n$$ \\mathcal{M}_\\star = \\frac{v_r}{c_s} = \\frac{\\alpha}{\\beta} \\frac{r_{ij}}{h} = \\frac{\\alpha}{\\beta} \\left( \\frac{h}{r_{ij}} \\right)^{-1} $$\n\nFor the given typical values, $\\alpha = 1$, $\\beta = 2$, and $h/r_{ij} = 1$:\n$$ \\mathcal{M}_\\star = \\frac{1}{2} (1)^{-1} = 0.5 $$\nRounding to three significant figures, the estimated numerical value is $0.500$.", "answer": "$$\\boxed{0.500}$$", "id": "3465341"}, {"introduction": "An ideal artificial viscosity should act only in compressive shocks, while leaving other types of flows, such as shear or rotation, unaffected. To achieve this, practitioners employ \"switches\" that modulate the viscosity strength based on local flow kinematics. In this exercise [@problem_id:3465306], you will derive from first principles the most common form of such a switch, which uses the ratio of the flow's divergence to its vorticity to intelligently suppress dissipation in non-compressive regions.", "problem": "In cosmological Smoothed Particle Hydrodynamics (SPH), artificial viscosity is introduced to capture shocks while avoiding spurious dissipation in vortical or shear-dominated flows. A common strategy is to modulate the artificial viscosity coefficient by a switch factor that suppresses viscosity in regions where vorticity dominates over compression. Consider a switch function $f$ that multiplies a base artificial viscosity coefficient $\\alpha$, so that the effective coefficient is $f \\alpha$. The switch $f$ should satisfy the following principles derived from first principles and dimensional analysis:\n\n- It depends only on kinematic invariants that distinguish compression from rotation, namely the divergence magnitude $\\left|\\nabla \\cdot \\mathbf{v}\\right|$ and the vorticity magnitude $\\left|\\nabla \\times \\mathbf{v}\\right|$.\n- It is dimensionless, bounded between $0$ and $1$, increases monotonically with $\\left|\\nabla \\cdot \\mathbf{v}\\right|$ at fixed $\\left|\\nabla \\times \\mathbf{v}\\right|$, and decreases monotonically with $\\left|\\nabla \\times \\mathbf{v}\\right|$ at fixed $\\left|\\nabla \\cdot \\mathbf{v}\\right|$.\n- It remains well-defined in quiescent flows by including a regularizing term constructed from the local signal speed $c$ and smoothing length $h$, combined with a small dimensionless parameter $\\epsilon>0$, such that the combination has the same dimensions as $\\left|\\nabla \\cdot \\mathbf{v}\\right|$ and $\\left|\\nabla \\times \\mathbf{v}\\right|$.\n\n(a) Using these requirements, construct the simplest admissible form of $f$ built from nonnegative linear contributions of the admissible invariants that respects the stated monotonicity, boundedness, and dimensional constraints.\n\n(b) For a locally vortical flow in a cosmological SPH calculation with $\\left|\\nabla \\cdot \\mathbf{v}\\right|=0.01$, $\\left|\\nabla \\times \\mathbf{v}\\right|=10$, $c=1$, $h=0.05$, $\\epsilon=0.1$, and base coefficient $\\alpha=1$, evaluate the switch $f$ and the effective artificial viscosity coefficient $f\\alpha$.\n\nRound your numerical results for $f$ and $f\\alpha$ to four significant figures. Report your final answers as two numbers without units in the order $\\left(f, f\\alpha\\right)$.", "solution": "**Part (a): Construction of the Switch Function**\nLet $D = \\left|\\nabla \\cdot \\mathbf{v}\\right|$ and $W = \\left|\\nabla \\times \\mathbf{v}\\right|$. Both have dimensions of inverse time ($[T^{-1}]$). To construct a dimensionless switch function $f$ that increases with $D$ and decreases with $W$, we form a ratio with $D$ in the numerator and $W$ in the denominator. The simplest form built from linear contributions that is bounded between 0 and 1 is:\n$$f = \\frac{D}{D+W} = \\frac{\\left|\\nabla \\cdot \\mathbf{v}\\right|}{\\left|\\nabla \\cdot \\mathbf{v}\\right| + \\left|\\nabla \\times \\mathbf{v}\\right|}$$\nThis is the standard form of the Balsara switch.\n\nTo make the switch well-defined in quiescent flows where both $D$ and $W$ might be zero, a regularization term is required. This term must have the same dimensions as $D$ and $W$, i.e., $[T^{-1}]$. It is constructed from the signal speed $c$ (units $[L T^{-1}]$), smoothing length $h$ (units $[L]$), and a dimensionless parameter $\\epsilon$. The combination $\\epsilon \\frac{c}{h}$ has the required dimensions. Adding this to the denominator to prevent division by zero gives the final form of the switch:\n$$f = \\frac{\\left|\\nabla \\cdot \\mathbf{v}\\right|}{\\left|\\nabla \\cdot \\mathbf{v}\\right| + \\left|\\nabla \\times \\mathbf{v}\\right| + \\epsilon \\frac{c}{h}}$$\nThis function satisfies all the requirements: it is dimensionless, bounded ($0 \\le f \\le 1$), monotonic in the desired ways, and regularized.\n\n**Part (b): Numerical Evaluation**\nWe are given the values:\n- $\\left|\\nabla \\cdot \\mathbf{v}\\right| = 0.01$\n- $\\left|\\nabla \\times \\mathbf{v}\\right| = 10$\n- $c = 1$\n- $h = 0.05$\n- $\\epsilon = 0.1$\n- $\\alpha = 1$\n\nFirst, calculate the regularization term:\n$$ \\epsilon \\frac{c}{h} = (0.1) \\frac{1}{0.05} = 0.1 \\times 20 = 2 $$\nNow, substitute all values into the expression for $f$:\n$$ f = \\frac{0.01}{0.01 + 10 + 2} = \\frac{0.01}{12.01} \\approx 0.000832639... $$\nRounded to four significant figures, the switch factor is $f = 0.0008326$.\n\nThe effective artificial viscosity coefficient is $f\\alpha$. Since $\\alpha = 1$:\n$$ f\\alpha = 0.0008326 \\times 1 = 0.0008326 $$\nThe final answer is the pair $(f, f\\alpha)$.", "answer": "$$ \\boxed{ \\begin{pmatrix} 0.0008326  0.0008326 \\end{pmatrix} } $$", "id": "3465306"}]}