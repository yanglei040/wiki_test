{"hands_on_practices": [{"introduction": "This first exercise forms the bedrock of our practical understanding of the Matrix Element Method. We will construct a complete, albeit simplified, MEM likelihood for the classic Quantum Electrodynamics (QED) process $e^+e^- \\to \\mu^+\\mu^-$. This practice [@problem_id:3522061] guides you through deriving the squared matrix element, defining the phase space, and incorporating a detector transfer function to build and numerically evaluate the likelihood, solidifying the core components of any MEM analysis.", "problem": "You will design and implement a numerical Matrix Element Method (MEM) likelihood evaluator for the scattering process $e^+ e^- \\to \\mu^+ \\mu^-$ in Quantum Electrodynamics (QED). The objective is to start from first principles of scattering theory, derive the unpolarized, spin-averaged squared matrix element $|\\mathcal{M}|^2$ for the process at tree level under the high-energy approximation where the muon mass is negligible, and then insert it into a MEM event likelihood of the form\n$$\nL(x \\mid \\theta) \\;=\\; \\frac{1}{\\sigma(\\theta)} \\int d\\Phi_2 \\;\\frac{d\\sigma}{d\\Phi_2}(\\theta)\\; W(x \\mid \\phi;\\theta),\n$$\nwhere $x$ denotes the measured event observables, $\\theta$ denotes the model parameter(s), $d\\Phi_2$ denotes the two-body final-state phase space, $d\\sigma/d\\Phi_2$ is the differential cross-section, and $W(x \\mid \\phi;\\theta)$ is a transfer function modeling the detector response.\n\nYou must implement this expression numerically for the following specific setup:\n\n- Fundamental base and assumptions:\n  - Use tree-level Quantum Electrodynamics (QED) for $e^+ e^- \\to \\mu^+ \\mu^-$ with only photon exchange.\n  - Assume the high-energy limit where the muon mass is negligible compared to the center-of-mass energy $\\sqrt{s}$ of the $e^+ e^-$ beams. Electrons are treated as massless.\n  - Use the fine-structure constant $\\alpha$ as a fixed numerical constant $\\alpha = 1/137.035999084$.\n  - The center-of-mass frame coincides with the laboratory frame, and there is no initial-state radiation.\n  - The parameter $\\theta$ is the center-of-mass energy $\\sqrt{s}$ in $\\mathrm{GeV}$, so that $s = (\\sqrt{s})^2$.\n\n- Scattering theory and phase space:\n  - Start from the $S$-matrix and Fermi’s Golden Rule for relativistic scattering, with the standard flux and phase-space factors for $2\\to 2$ scattering.\n  - For massless final-state muons, in the center-of-mass frame, let $\\theta$ (polar) and $\\varphi$ (azimuth) parametrize the direction of the $\\mu^+$ momentum. Then $d\\Phi_2$ can be written as $d\\Omega = d\\varphi\\, d(\\cos\\theta)$ times known constants, and the differential cross-section can be expressed as a function of $s$ and $\\cos\\theta$.\n  - The unpolarized, spin-averaged squared matrix element $|\\mathcal{M}|^2$ must be derived from QED trace technology, and the resulting differential cross section $d\\sigma/d\\Omega$ must be expressed in terms of $|\\mathcal{M}|^2$, $s$, and constants.\n\n- Transfer function:\n  - The detector transfer function $W(x \\mid \\phi;\\theta)$ is a product of independent Gaussian resolutions on the three Cartesian momentum components of each muon. Let the measured three-momenta be $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^+}$ and $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^-}$, and the true three-momenta (which are functions of $\\phi \\equiv (\\theta,\\varphi)$ and $\\sqrt{s}$) be $\\mathbf{p}^{\\,\\mathrm{true}}_{\\mu^+}(\\phi;\\sqrt{s})$ and $\\mathbf{p}^{\\,\\mathrm{true}}_{\\mu^-}(\\phi;\\sqrt{s}) = -\\mathbf{p}^{\\,\\mathrm{true}}_{\\mu^+}(\\phi;\\sqrt{s})$. The Gaussian transfer function is:\n    $$\n    W(x \\mid \\phi;\\sqrt{s}) \\;=\\; \\prod_{i=1}^{3} \\frac{1}{\\sqrt{2\\pi}\\,\\sigma}\\exp\\!\\left(-\\frac{\\left(p^{\\,\\mathrm{meas}}_{\\mu^+,i}-p^{\\,\\mathrm{true}}_{\\mu^+,i}(\\phi;\\sqrt{s})\\right)^2}{2\\sigma^2}\\right)\\;\n    \\prod_{i=1}^{3} \\frac{1}{\\sqrt{2\\pi}\\,\\sigma}\\exp\\!\\left(-\\frac{\\left(p^{\\,\\mathrm{meas}}_{\\mu^-,i}-p^{\\,\\mathrm{true}}_{\\mu^-,i}(\\phi;\\sqrt{s})\\right)^2}{2\\sigma^2}\\right),\n    $$\n    where $\\sigma$ is the momentum resolution (the same for each Cartesian component).\n  - The true three-momentum magnitude for each muon is $|\\mathbf{p}^{\\,\\mathrm{true}}_{\\mu^\\pm}| = \\sqrt{s}/2$ and the direction of $\\mu^+$ is given by $(\\theta,\\varphi)$, with $\\mu^-$ back-to-back.\n\n- Likelihood and normalization:\n  - Use\n    $$\n    L(x \\mid \\sqrt{s}) \\;=\\; \\frac{1}{\\sigma(s)} \\int d\\Omega \\;\\frac{d\\sigma}{d\\Omega}(s,\\cos\\theta)\\; W(x\\mid \\theta,\\varphi;\\sqrt{s}),\n    $$\n    where $s = (\\sqrt{s})^2$, $d\\Omega = d\\varphi\\, d(\\cos\\theta)$, and $\\sigma(s)$ is the total tree-level cross-section.\n  - All integrations must be performed numerically with deterministic quadrature. Angles must be in radians. The integration domain is $\\cos\\theta \\in [-1,1]$ and $\\varphi \\in [0,2\\pi)$.\n  - You must explicitly compute $\\sigma(s)$ from the same theory as $d\\sigma/d\\Omega$ to ensure a properly normalized likelihood in the sense of the MEM definition above.\n\n- Units:\n  - All momenta must be in $\\mathrm{GeV}$, all energies in $\\mathrm{GeV}$, and all angles in radians.\n  - The final likelihood has units of $\\mathrm{GeV}^{-6}$ due to the Gaussian transfer function being a density in three-momentum space for two particles. Your program must output floating-point values in these units.\n\n- Numerical implementation guidance:\n  - Use Gauss-Legendre quadrature in $u \\equiv \\cos\\theta$ and a uniform trapezoidal rule in $\\varphi$ for $d\\Omega = d\\varphi \\, du$, with sufficiently many points to achieve stable values.\n  - Your code must be self-contained and must not read external input.\n\n- Test suite:\n  - Use the fine-structure constant $\\alpha = 1/137.035999084$.\n  - For each test case below, evaluate $L(x \\mid \\sqrt{s})$ with the specified $\\sqrt{s}$, Gaussian width $\\sigma$ (in $\\mathrm{GeV}$), and measured momenta (in $\\mathrm{GeV}$):\n    1. Happy path:\n       - $\\sqrt{s} = 10.0$\n       - $\\sigma = 0.5$\n       - $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^+} = (4.10,\\,1.10,\\,2.60)$\n       - $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^-} = (-4.00,\\,-1.30,\\,-2.80)$\n    2. Different energy scale:\n       - $\\sqrt{s} = 5.0$\n       - $\\sigma = 0.3$\n       - $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^+} = (-0.70,\\,1.70,\\,-1.60)$\n       - $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^-} = (0.90,\\,-1.80,\\,1.40)$\n    3. Edge case with inconsistent back-to-back topology:\n       - $\\sqrt{s} = 10.0$\n       - $\\sigma = 0.5$\n       - $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^+} = (3.00,\\,0.00,\\,3.00)$\n       - $\\mathbf{p}^{\\,\\mathrm{meas}}_{\\mu^-} = (-2.00,\\,0.50,\\,-3.40)$\n\n- Final output format:\n  - Your program must produce a single line of output containing the three likelihood values, in a Python-style list with commas and no spaces, for example: $\\texttt{[v1,v2,v3]}$. Each $v_i$ must be a floating-point number.\n\nExpress all final answers in units of $\\mathrm{GeV}^{-6}$, and angles in radians. Your program must be fully deterministic and self-contained.", "solution": "The problem is valid as it constitutes a well-defined and self-contained task in computational high-energy physics. It is grounded in the established principles of Quantum Electrodynamics (QED) and scattering theory, and provides all necessary information to derive and implement a numerical solution.\n\nThe objective is to compute the Matrix Element Method (MEM) likelihood $L(x \\mid \\sqrt{s})$ for the process $e^+ e^- \\to \\mu^+ \\mu^-$. The likelihood is given by:\n$$\nL(x \\mid \\sqrt{s}) = \\frac{1}{\\sigma(s)} \\int d\\Omega \\;\\frac{d\\sigma}{d\\Omega}(s,\\cos\\theta)\\; W(x\\mid \\theta,\\varphi;\\sqrt{s})\n$$\nwhere $s = (\\sqrt{s})^2$ is the square of the center-of-mass energy, $d\\Omega = d\\varphi\\, d(\\cos\\theta)$ is the solid angle element, $d\\sigma/d\\Omega$ is the differential cross section, $\\sigma(s)$ is the total cross section, and $W$ is the detector transfer function. The solution requires deriving these components from first principles.\n\n**1. Derivation of the Differential Cross Section $d\\sigma/d\\Omega$**\n\nThe differential cross section for a $2 \\to 2$ scattering process in the center-of-mass (CM) frame, for massless final state particles, is given by Fermi's Golden Rule:\n$$\n\\frac{d\\sigma}{d\\Omega} = \\frac{1}{64\\pi^2 s} \\overline{|\\mathcal{M}|^2}\n$$\nwhere $\\overline{|\\mathcal{M}|^2}$ is the spin-averaged squared matrix element.\n\nThe process is $e^-(p_1) + e^+(p_2) \\to \\mu^-(p_3) + \\mu^+(p_4)$. At tree level in QED, this proceeds via a single virtual photon in the $s$-channel. The matrix element $\\mathcal{M}$ is:\n$$\n\\mathcal{M} = \\frac{e^2}{s} \\left[ \\bar{v}(p_2)\\gamma^\\mu u(p_1) \\right] \\left[ \\bar{u}(p_3)\\gamma_\\mu v(p_4) \\right]\n$$\nwhere $e$ is the elementary charge, $\\gamma^\\mu$ are the Dirac matrices, and $u, v, \\bar{u}, \\bar{v}$ are the particle and anti-particle spinors.\n\nTo compute the unpolarized cross section, we average over initial state spins (a factor of $1/2 \\times 1/2 = 1/4$) and sum over final state spins:\n$$\n\\overline{|\\mathcal{M}|^2} = \\frac{1}{4} \\sum_{\\text{spins}} |\\mathcal{M}|^2 = \\frac{1}{4} \\frac{e^4}{s^2} L_e^{\\mu\\nu} L_{\\mu\\nu}^{\\mu}\n$$\nThe leptonic tensors $L_e^{\\mu\\nu}$ and $L_{\\mu\\nu}^{\\mu}$ result from the spin sums. Using trace technology in the high-energy limit (massless fermions), where $\\sum_s u_s(p)\\bar{u}_s(p) = \\not p$ and $\\sum_s v_s(p)\\bar{v}_s(p) = \\not p$:\n$$\nL_e^{\\mu\\nu} = \\mathrm{Tr}[\\not p_2 \\gamma^\\mu \\not p_1 \\gamma^\\nu] = 4 \\left( p_1^\\mu p_2^\\nu + p_1^\\nu p_2^\\mu - g^{\\mu\\nu}(p_1 \\cdot p_2) \\right)\n$$\n$$\nL_{\\mu\\nu}^{\\mu} = \\mathrm{Tr}[\\not p_3 \\gamma_\\mu \\not p_4 \\gamma_\\nu] = 4 \\left( p_{3\\mu} p_{4\\nu} + p_{3\\nu} p_{4\\mu} - g_{\\mu\\nu}(p_3 \\cdot p_4) \\right)\n$$\nThe contraction of these tensors is most easily expressed using Mandelstam variables. For a massless process, $s=(p_1+p_2)^2$, $t=(p_1-p_3)^2$, $u=(p_1-p_4)^2$, with $s+t+u=0$.\n$p_1 \\cdot p_2 = s/2$, $p_3 \\cdot p_4 = s/2$.\n$p_1 \\cdot p_3 = p_2 \\cdot p_4 = -t/2$.\n$p_1 \\cdot p_4 = p_2 \\cdot p_3 = -u/2$.\nThe tensor contraction yields:\n$$\nL_e^{\\mu\\nu} L_{\\mu\\nu}^{\\mu} = 32 \\left( (p_1 \\cdot p_3)(p_2 \\cdot p_4) + (p_1 \\cdot p_4)(p_2 \\cdot p_3) \\right) = 32 \\left( \\frac{t^2}{4} + \\frac{u^2}{4} \\right) = 8(t^2+u^2)\n$$\nThus, the squared matrix element is:\n$$\n\\overline{|\\mathcal{M}|^2} = \\frac{1}{4} \\frac{e^4}{s^2} \\left[ 8(t^2+u^2) \\right] = \\frac{2e^4}{s^2}(t^2+u^2)\n$$\nIn the CM frame, let $\\theta$ be the angle between the incoming electron and the outgoing $\\mu^-$. The Mandelstam variables are:\n$t = (p_1-p_3)^2 = -2 p_1 \\cdot p_3 = -2 \\frac{\\sqrt{s}}{2} \\frac{\\sqrt{s}}{2} (1 - \\cos\\theta) = -\\frac{s}{2}(1-\\cos\\theta)$\n$u = (p_1-p_4)^2 = -2 p_1 \\cdot p_4 = -2 \\frac{\\sqrt{s}}{2} \\frac{\\sqrt{s}}{2} (1 + \\cos\\theta) = -\\frac{s}{2}(1+\\cos\\theta)$\nSubstituting these into the expression for $\\overline{|\\mathcal{M}|^2}$:\n$$\n\\overline{|\\mathcal{M}|^2} = \\frac{2e^4}{s^2} \\left[ \\frac{s^2}{4}(1-\\cos\\theta)^2 + \\frac{s^2}{4}(1+\\cos\\theta)^2 \\right] = \\frac{e^4}{2} \\left[ (1-2\\cos\\theta+\\cos^2\\theta) + (1+2\\cos\\theta+\\cos^2\\theta) \\right] = e^4(1+\\cos^2\\theta)\n$$\nUsing the fine-structure constant $\\alpha = e^2/(4\\pi)$ in natural units, we have $e^4 = 16\\pi^2\\alpha^2$.\n$$\n\\overline{|\\mathcal{M}|^2} = 16\\pi^2\\alpha^2(1+\\cos^2\\theta)\n$$\nFinally, the differential cross section is:\n$$\n\\frac{d\\sigma}{d\\Omega} = \\frac{1}{64\\pi^2 s} \\left[ 16\\pi^2\\alpha^2(1+\\cos^2\\theta) \\right] = \\frac{\\alpha^2}{4s}(1+\\cos^2\\theta)\n$$\n\n**2. Calculation of the Total Cross Section $\\sigma(s)$**\n\nThe total cross section $\\sigma(s)$ is the normalization factor for the likelihood. It is obtained by integrating the differential cross section over the full solid angle:\n$$\n\\sigma(s) = \\int \\frac{d\\sigma}{d\\Omega} d\\Omega = \\int_0^{2\\pi} d\\varphi \\int_{-1}^{1} d(\\cos\\theta) \\frac{\\alpha^2}{4s}(1+\\cos^2\\theta)\n$$\nThe integral over $\\varphi$ gives $2\\pi$. Let $u = \\cos\\theta$:\n$$\n\\sigma(s) = 2\\pi \\frac{\\alpha^2}{4s} \\int_{-1}^{1} (1+u^2) du = \\frac{\\pi\\alpha^2}{2s} \\left[ u + \\frac{u^3}{3} \\right]_{-1}^{1} = \\frac{\\pi\\alpha^2}{2s} \\left[ \\left(1+\\frac{1}{3}\\right) - \\left(-1-\\frac{1}{3}\\right) \\right] = \\frac{\\pi\\alpha^2}{2s} \\left(\\frac{8}{3}\\right)\n$$\n$$\n\\sigma(s) = \\frac{4\\pi\\alpha^2}{3s}\n$$\n\n**3. Assembling the Likelihood Integrand**\n\nThe likelihood expression involves the ratio $\\frac{1}{\\sigma(s)}\\frac{d\\sigma}{d\\Omega}$, which defines a normalized probability distribution over the solid angle:\n$$\n\\frac{1}{\\sigma(s)}\\frac{d\\sigma}{d\\Omega} = \\frac{3s}{4\\pi\\alpha^2} \\cdot \\frac{\\alpha^2}{4s}(1+\\cos^2\\theta) = \\frac{3}{16\\pi}(1+\\cos^2\\theta)\n$$\nThe full likelihood expression is therefore:\n$$\nL(x \\mid \\sqrt{s}) = \\int_0^{2\\pi} d\\varphi \\int_{-1}^{1} d(\\cos\\theta) \\left( \\frac{3}{16\\pi}(1+\\cos^2\\theta) \\right) W(x \\mid \\theta,\\varphi;\\sqrt{s})\n$$\n\n**4. Transfer Function**\n\nThe transfer function $W(x \\mid \\phi;\\sqrt{s})$ connects the true partonic momenta $\\mathbf{p}^{\\text{true}}_{\\mu^\\pm}$ to the measured momenta $\\mathbf{p}^{\\text{meas}}_{\\mu^\\pm}$. It is a product of six Gaussians:\n$$\nW(x \\mid \\phi;\\sqrt{s}) = \\left(\\frac{1}{\\sqrt{2\\pi}\\,\\sigma}\\right)^6 \\exp\\left(-\\frac{\\left|\\mathbf{p}^{\\text{meas}}_{\\mu^+} - \\mathbf{p}^{\\text{true}}_{\\mu^+}\\right|^2 + \\left|\\mathbf{p}^{\\text{meas}}_{\\mu^-} - \\mathbf{p}^{\\text{true}}_{\\mu^-}\\right|^2}{2\\sigma^2}\\right)\n$$\nIn the CM frame, $\\mathbf{p}^{\\text{true}}_{\\mu^-} = -\\mathbf{p}^{\\text{true}}_{\\mu^+}$. The magnitude is $|\\mathbf{p}^{\\text{true}}_{\\mu^+}| = \\sqrt{s}/2$. The direction of $\\mathbf{p}^{\\text{true}}_{\\mu^+}$ is parametrized by the integration variables $(\\theta, \\varphi)$:\n$$\n\\mathbf{p}^{\\text{true}}_{\\mu^+}(\\theta, \\varphi) = \\frac{\\sqrt{s}}{2} \\begin{pmatrix} \\sin\\theta\\cos\\varphi \\\\ \\sin\\theta\\sin\\varphi \\\\ \\cos\\theta \\end{pmatrix}\n$$\nThe exponent's argument can be expanded for efficient computation:\n$$ \\mathcal{E} = -\\frac{1}{2\\sigma^2} \\left[ |\\mathbf{p}^{\\text{meas}}_{\\mu^+}|^2 + |\\mathbf{p}^{\\text{meas}}_{\\mu^-}|^2 + 2|\\mathbf{p}^{\\text{true}}_{\\mu^+}|^2 - 2(\\mathbf{p}^{\\text{meas}}_{\\mu^+} - \\mathbf{p}^{\\text{meas}}_{\\mu^-}) \\cdot \\mathbf{p}^{\\text{true}}_{\\mu^+} \\right] $$\n$$ \\mathcal{E} = -\\frac{1}{2\\sigma^2} \\left[ |\\mathbf{p}^{\\text{meas}}_{\\mu^+}|^2 + |\\mathbf{p}^{\\text{meas}}_{\\mu^-}|^2 + \\frac{s}{2} - 2(\\mathbf{p}^{\\text{meas}}_{\\mu^+} - \\mathbf{p}^{\\text{meas}}_{\\mu^-}) \\cdot \\mathbf{p}^{\\text{true}}_{\\mu^+}(\\theta, \\varphi) \\right] $$\nThe terms in brackets that do not depend on $(\\theta, \\varphi)$ can be pre-calculated.\n\n**5. Numerical Integration**\n\nThe final integral is computed numerically. We use Gauss-Legendre quadrature for the integration over $u = \\cos\\theta \\in [-1, 1]$ and the trapezoidal rule for the integration over $\\varphi \\in [0, 2\\pi)$.\nLet $u_i, w_i$ be the $N_u$ Gauss-Legendre points and weights. Let $\\varphi_j = j \\frac{2\\pi}{N_\\varphi}$ for $j=0, \\dots, N_\\varphi-1$ be the uniform points for the trapezoidal rule. The discretized integral is:\n$$\nL \\approx \\sum_{i=1}^{N_u} w_i \\left( \\frac{2\\pi}{N_\\varphi} \\sum_{j=0}^{N_\\varphi-1} \\left[ \\frac{3}{16\\pi}(1+u_i^2) \\right] W(x \\mid \\theta_i, \\varphi_j; \\sqrt{s}) \\right)\n$$\nwhere $\\cos\\theta_i = u_i$. This provides a deterministic and accurate evaluation of the likelihood.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import roots_legendre\n\ndef solve():\n    \"\"\"\n    Main function to calculate MEM likelihood for specified test cases.\n    \"\"\"\n    # Define constants\n    N_U = 64  # Number of points for cos(theta) integration (Gauss-Legendre)\n    N_PHI = 64  # Number of points for phi integration (Trapezoidal)\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (sqrt_s, sigma, p_mu_plus_meas, p_mu_minus_meas) in GeV\n        (10.0, 0.5, (4.10, 1.10, 2.60), (-4.00, -1.30, -2.80)),\n        (5.0, 0.3, (-0.70, 1.70, -1.60), (0.90, -1.80, 1.40)),\n        (10.0, 0.5, (3.00, 0.00, 3.00), (-2.00, 0.50, -3.40)),\n    ]\n\n    results = []\n    for case in test_cases:\n        sqrt_s, sigma, p_plus_meas, p_minus_meas = case\n        likelihood = calculate_likelihood(sqrt_s, sigma, p_plus_meas, p_minus_meas, N_U, N_PHI)\n        results.append(f\"{likelihood:.6e}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef calculate_likelihood(sqrt_s, sigma, p_mu_plus_meas, p_mu_minus_meas, n_u, n_phi):\n    \"\"\"\n    Calculates the MEM likelihood for a single event.\n\n    Args:\n        sqrt_s (float): Center-of-mass energy in GeV.\n        sigma (float): Momentum resolution (Gaussian width) in GeV.\n        p_mu_plus_meas (tuple): 3-momentum of the measured mu+.\n        p_mu_minus_meas (tuple): 3-momentum of the measured mu-.\n        n_u (int): Number of integration points for cos(theta).\n        n_phi (int): Number of integration points for phi.\n\n    Returns:\n        float: The calculated likelihood value in GeV^-6.\n    \"\"\"\n    s = sqrt_s**2\n\n    # Convert measured momenta to numpy arrays\n    p_plus = np.array(p_mu_plus_meas)\n    p_minus = np.array(p_mu_minus_meas)\n\n    # --- Pre-calculate terms for the transfer function exponent ---\n    # The exponent is -(constant_part + vector_part . p_true) / (2*sigma^2)\n    \n    # Constant part of the numerator: |p_meas+|^2 + |p_meas-|^2 + 2*|p_true|^2\n    # where |p_true|^2 = (sqrt_s/2)^2 = s/4\n    exp_const_part = np.dot(p_plus, p_plus) + np.dot(p_minus, p_minus) + s / 2.0\n\n    # Coefficient for the vector part of the numerator: -2 * (p_meas+ - p_meas-)\n    exp_vec_coeff = -2.0 * (p_plus - p_minus)\n    \n    # Overall prefactor for the transfer function W\n    w_prefactor = (1.0 / (np.sqrt(2 * np.pi) * sigma))**6\n    \n    # --- Numerical Integration Setup ---\n    # Gauss-Legendre quadrature for u = cos(theta) in [-1, 1]\n    u_points, u_weights = roots_legendre(n_u)\n    # Trapezoidal rule for phi in [0, 2*pi)\n    phi_points = np.linspace(0, 2 * np.pi, n_phi, endpoint=False)\n    d_phi = 2 * np.pi / n_phi\n    \n    integral_sum = 0.0\n    true_p_mag = sqrt_s / 2.0\n    \n    # Outer loop: integration over u = cos(theta)\n    for i in range(n_u):\n        u = u_points[i]\n        w_u = u_weights[i]\n        \n        # sin(theta) can be derived from u = cos(theta)\n        sin_theta = np.sqrt(1.0 - u**2)\n        \n        # The normalized QED matrix element part of the integrand\n        # P(Omega) = (3 / (16*pi)) * (1 + cos_theta^2)\n        matrix_element_part = (3.0 / (16.0 * np.pi)) * (1.0 + u**2)\n        \n        phi_integral_sum = 0.0\n        # Inner loop: integration over phi\n        for j in range(n_phi):\n            phi = phi_points[j]\n            \n            # Construct the true mu+ momentum vector for this integration point\n            p_true = np.array([\n                true_p_mag * sin_theta * np.cos(phi),\n                true_p_mag * sin_theta * np.sin(phi),\n                true_p_mag * u\n            ])\n            \n            # --- Calculate the Transfer Function W ---\n            dot_product = np.dot(exp_vec_coeff, p_true)\n            exponent_numerator = exp_const_part + dot_product\n            exponent = -exponent_numerator / (2.0 * sigma**2)\n            \n            w_val = w_prefactor * np.exp(exponent)\n            \n            # Full integrand for this (u_i, phi_j) point\n            integrand = matrix_element_part * w_val\n            phi_integral_sum += integrand\n\n        # Accumulate the phi-integrated result (trapezoidal sum)\n        # weighted by the Gauss-Legendre weight for this u_i\n        integral_sum += w_u * (phi_integral_sum * d_phi)\n        \n    return integral_sum\n\nif __name__ == \"__main__\":\n    solve()\n```", "id": "3522061"}, {"introduction": "Real-world applications of MEM, especially at hadron colliders like the LHC, face the daunting challenge of combinatorial ambiguity when multiple jets are produced from quarks and gluons. This exercise [@problem_id:3522033] tackles this central problem by having you formulate the full likelihood expression for a semi-leptonic $t\\bar{t}$ event with a multi-jet final state. You will learn how to correctly sum over all possible jet-parton assignments and incorporate crucial external information from tools like $b$-tagging to construct a realistic and computationally tractable likelihood.", "problem": "Consider a single event consistent with top–antitop production and decay in the Standard Model (SM) channel $t\\bar{t} \\to W^{+}b\\, W^{-}\\bar{b} \\to \\ell \\nu + 4 \\text{ jets}$, where exactly $4$ reconstructed jets are present and all come from the partons $\\{b_{\\text{lep}}, b_{\\text{had}}, q, q^{\\prime}\\}$, with $\\ell$ denoting an electron or muon and $\\nu$ the corresponding neutrino. You will use the Matrix Element Method (MEM) to write down the event probability density, including a sum over jet–parton assignments and per-jet $b$-tag information. Assume the following idealizations, which are standard and scientifically consistent for this purpose:\n\n- The two light quarks $\\{q, q^{\\prime}\\}$ from hadronic $W$ decay are indistinguishable in the squared matrix element.\n- The observed event record $x$ consists of the measured lepton four-momentum, missing transverse momentum, the four jet four-momenta $\\{p_{1},p_{2},p_{3},p_{4}\\}$, and binary $b$-tag bits $\\{t_{1},t_{2},t_{3},t_{4}\\}$ with $t_{j}\\in\\{0,1\\}$.\n- The $b$-tag response model is independent across jets and depends only on the true parton flavor assigned to that jet: for a jet originating from a $b$ quark, $P(t_{j}=1|b)=\\varepsilon_{b}$ and $P(t_{j}=0|b)=1-\\varepsilon_{b}$; for a jet originating from a light quark ($u$, $d$, $s$) or a gluon, $P(t_{j}=1|\\text{light})=\\varepsilon_{q}$ and $P(t_{j}=0|\\text{light})=1-\\varepsilon_{q}$, with $0 < \\varepsilon_{q} < \\varepsilon_{b} < 1$.\n- The event probability density in MEM is constructed by convolving the fully differential partonic cross section with detector transfer functions and normalizing by the inclusive cross section. Use a factorized transfer function $W(x|y;\\alpha)$ that encodes the mapping, under a given jet–parton assignment $\\alpha$, from the parton-level kinematics $y$ to the measured $x$; you may keep $W(x|y;\\alpha)$ symbolic.\n- The initial-state hadrons are unpolarized protons, and the initial parton momentum fractions are integrated over with Parton Distribution Functions (PDFs). Denote the hadronic center-of-mass energy by $\\sqrt{s}$, the partonic center-of-mass energy by $\\hat{s}=x_{1}x_{2}s$, and include the usual flux factor.\n\nTasks:\n\n(a) Using only the particle content of the final state and the indistinguishability of the hadronic $W\\to q q^{\\prime}$ decay products in the squared matrix element, compute the number of inequivalent jet–parton permutations that must be summed in MEM for this topology when there are exactly $4$ reconstructed jets.\n\n(b) Starting from the definition that the MEM event probability density is proportional to the partonic differential cross section convolved with detector transfer functions and normalized by the total cross section, construct the permutation-summed event likelihood $L(x|\\theta)$ for model parameters $\\theta$. Your expression must:\n- Sum over all inequivalent jet–parton assignments obtained in part (a).\n- Sum over initial-state parton flavors.\n- Integrate over the parton momentum fractions and the full final-state phase space for $t\\bar{t}\\to \\ell \\nu b \\bar{b} q q^{\\prime}$.\n- Include the flux factor and the squared matrix element.\n- Multiply each assignment’s kinematic integral by the product of per-jet $b$-tag probabilities implied by that assignment and the observed tag bits $\\{t_{j}\\}$.\n\n(c) Provide your final result as a single, closed-form analytic expression for $L(x|\\theta)$ in which the upper limit of the permutation sum is the explicit number obtained in part (a), and where the per-jet $b$-tag factor is written using indicator functions that identify whether, under a given assignment, a jet is mapped to a $b$ or a light quark. The expression must be a single line mathematical formula. No numerical evaluation is required and no units should be included in the final expression.", "solution": "The user has provided a problem in computational high-energy physics concerning the Matrix Element Method (MEM). I will first validate the problem statement.\n\n### Problem Validation\n\n**Step 1: Extract Givens**\n- **Process**: Top-antitop production and decay $t\\bar{t} \\to W^{+}b\\, W^{-}\\bar{b} \\to \\ell \\nu + 4 \\text{ jets}$.\n- **Partons giving rise to jets**: $\\{b_{\\text{lep}}, b_{\\text{had}}, q, q^{\\prime}\\}$.\n- **Indistinguishability**: The light quarks $\\{q, q^{\\prime}\\}$ from the hadronic $W$ boson decay are indistinguishable in the squared matrix element.\n- **Observed Event Data ($x$)**: Measured lepton four-momentum, missing transverse momentum, four jet four-momenta $\\{p_{1},p_{2},p_{3},p_{4}\\}$, and four binary $b$-tagging bits $\\{t_{1},t_{2},t_{3},t_{4}\\}$ where $t_{j}\\in\\{0,1\\}$.\n- **B-tagging Model**:\n    - Per-jet independence.\n    - $P(t_{j}=1|b)=\\varepsilon_{b}$ and $P(t_{j}=0|b)=1-\\varepsilon_{b}$.\n    - $P(t_{j}=1|\\text{light})=\\varepsilon_{q}$ and $P(t_{j}=0|\\text{light})=1-\\varepsilon_{q}$.\n    - Efficiency and mistag rate constraint: $0 < \\varepsilon_{q} < \\varepsilon_{b} < 1$.\n- **MEM Formulation**:\n    - The event probability density is proportional to the convolution of the fully differential partonic cross section with detector transfer functions, normalized by the inclusive cross section.\n    - Transfer function is a factorized function $W(x|y;\\alpha)$ kept in symbolic form.\n- **Initial State**: Unpolarized protons, integration over parton momentum fractions $x_1, x_2$ with Parton Distribution Functions (PDFs), hadronic center-of-mass energy $\\sqrt{s}$, partonic center-of-mass energy $\\hat{s}=x_{1}x_{2}s$, and inclusion of the flux factor.\n\n**Step 2: Validate Using Extracted Givens**\n- **Scientifically Grounded**: The problem is firmly rooted in the Standard Model of particle physics and employs the Matrix Element Method, a standard, well-established technique in experimental high-energy physics data analysis. All concepts, including $t\\bar{t}$ production, PDFs, matrix elements, transfer functions, and $b$-tagging, are standard and scientifically sound.\n- **Well-Posed**: The problem is structured into three clear, sequential tasks. Part (a) is a well-defined combinatorial problem. Part (b) and (c) request the construction of a mathematical object (the likelihood function) based on explicitly stated physical principles and components. The level of abstraction (e.g., symbolic matrix element and transfer function) is appropriate for a theoretical problem and does not render it unsolvable.\n- **Objective**: The language is technical, precise, and free of any subjectivity or ambiguity.\n\nThe problem statement does not violate any of the invalidity criteria. It is scientifically sound, well-posed, objective, complete, and non-trivial.\n\n**Verdict**: The problem is **valid**.\n\n### Solution\n\nThe solution proceeds by addressing each of the three tasks in order.\n\n**(a) Number of Inequivalent Jet–Parton Permutations**\n\nThe task is to determine the number of distinct ways to assign the four final-state partons $\\{b_{\\text{lep}}, b_{\\text{had}}, q, q^{\\prime}\\}$ to the four reconstructed jets $\\{p_1, p_2, p_3, p_4\\}$. A specific assignment is a permutation that maps each jet to a unique parton.\n\n- The four jets are distinguishable by their measured properties (e.g., four-momenta).\n- The four partons must be carefully considered. The labels $b_{\\text{lep}}$ and $b_{\\text{had}}$ denote the $b$-quarks originating from the top quarks that decay leptonically and hadronically, respectively. These are distinct physical hypotheses in the context of event reconstruction, as associating a jet with $b_{\\text{lep}}$ versus $b_{\\text{had}}$ leads to different kinematic configurations for the parent top quarks. Therefore, $b_{\\text{lep}}$ and $b_{\\text{had}}$ are treated as distinguishable.\n- The problem states that the light quarks from the hadronic $W$ decay, $\\{q, q^{\\prime}\\}$, are \"indistinguishable in the squared matrix element\". This is a standard simplification in MEM that implies that any two permutations that differ only by swapping the assignments of $q$ and $q^{\\prime}$ between two jets will yield the same value for the kinematic part of the likelihood integrand. Consequently, they do not represent distinct hypotheses and should be counted as a single \"inequivalent\" permutation.\n\nWe are therefore counting the number of permutations of a multiset of parton roles to be assigned to the four distinct jets. The set of roles is $\\{b_{\\text{lep}}, b_{\\text{had}}, \\text{light}, \\text{light}\\}$. We have $N=4$ items (the jet slots) and want to arrange $k_1=1$ object of type $b_{\\text{lep}}$, $k_2=1$ object of type $b_{\\text{had}}$, and $k_3=2$ objects of type 'light quark'. The number of such distinct permutations is given by the multinomial coefficient:\n$$ \\frac{N!}{k_1! k_2! k_3!} = \\frac{4!}{1! \\, 1! \\, 2!} = \\frac{24}{2} = 12 $$\nThus, there are $12$ inequivalent jet-parton permutations that must be summed over.\n\n**(b) Construction of the Event Likelihood**\n\nThe event probability density, which we take as the likelihood $L(x|\\theta)$, is defined as the normalized differential cross section for producing the observed event $x$, given model parameters $\\theta$. The general formula is:\n$$ L(x|\\theta) = \\frac{1}{\\sigma_{\\text{tot}}(\\theta)} \\frac{d\\sigma(x|\\theta)}{dx} $$\nThe term $\\frac{d\\sigma(x|\\theta)}{dx}$ is obtained by summing over all possible intermediate steps that could lead to the observation $x$. This involves:\n1.  A sum over all possible initial-state parton pairings, denoted by indices $a, b$.\n2.  An integral over the momentum fractions $x_1, x_2$ of these partons, weighted by their respective PDFs, $f_{a,b}(x,Q^2)$.\n3.  The partonic interaction itself, described by the squared matrix element $|\\mathcal{M}_{ab \\to f}(y;\\theta)|^2$, where $y$ represents the final-state parton momenta. This is weighted by the relativistic flux factor, $1/(2\\hat{s}) = 1/(2x_1x_2s)$.\n4.  An integral over the full Lorentz-invariant phase space $d\\Phi(y)$ of the final-state partons.\n5.  Convolution with a detector transfer function $W(x|y;\\alpha)$, which gives the probability of observing the state $x$ given the partonic state $y$ and a specific jet-parton assignment $\\alpha$.\n6.  A sum over all inequivalent jet-parton assignments, $\\alpha_k$, as determined in part (a).\n7.  A multiplicative factor for the probability of observing the $b$-tag configuration $\\{t_j\\}$ given an assignment $\\alpha_k$.\n\nCombining these elements, the unnormalized probability is constructed as a sum over permutations, where each term involves an integral over the latent variables (parton kinematics). The b-tagging probability for a given assignment $\\alpha_k$, $P_b(\\{t_j\\}|\\alpha_k)$, is constant with respect to the kinematic integrals and can be factored out. This probability is the product of individual jet tagging probabilities, which depend on the true flavor of the parton assigned to the jet.\n$$ P_b(\\{t_j\\}|\\alpha_k) = \\prod_{j=1}^4 P(t_j|\\text{flavor}(\\alpha_k(p_j))) $$\nThe full expression is then constructed by assembling these components, following the structure prescribed by the MEM framework.\n\n**(c) Final Analytic Expression for the Likelihood**\n\nHere we write the complete expression for $L(x|\\theta)$, incorporating the results from (a) and (b). Let $\\mathcal{A} = \\{\\alpha_k\\}_{k=1}^{12}$ be the set of the $12$ inequivalent jet-parton assignments. Let $I_b(\\alpha_k, j)$ be an indicator function that is $1$ if jet $j$ is assigned to a $b$-quark ($b_{\\text{lep}}$ or $b_{\\text{had}}$) under assignment $\\alpha_k$, and $0$ otherwise. Similarly, let $I_q(\\alpha_k, j) = 1 - I_b(\\alpha_k, j)$ be the indicator for assignment to a light quark ($q$ or $q^{\\prime}$). The final state is $f = \\{\\ell, \\nu, b, \\bar{b}, q, q^{\\prime}\\}$, with parton momenta collectively denoted by $y$. The normalization factor $\\sigma(\\theta)$ is the total theoretical cross section for the signal process, given by integrating the differential partonic cross section over the full phase space and PDFs, without the transfer function or b-tagging probabilities. The likelihood is:\n$$ L(x|\\theta) = \\frac{1}{\\sigma(\\theta)} \\sum_{a,b} \\sum_{k=1}^{12} \\left( \\prod_{j=1}^4 \\left[\\varepsilon_b^{t_j}(1-\\varepsilon_b)^{1-t_j}\\right]^{I_b(\\alpha_k,j)} \\left[\\varepsilon_q^{t_j}(1-\\varepsilon_q)^{1-t_j}\\right]^{I_q(\\alpha_k,j)} \\right) \\int_0^1 \\!\\! dx_1 \\int_0^1 \\!\\! dx_2 \\frac{f_a(x_1,Q^2)f_b(x_2,Q^2)}{2x_1x_2s} \\int \\! d\\Phi(y) |\\mathcal{M}_{ab \\to f}(y;\\theta)|^2 W(x|y;\\alpha_k) $$\n\nThis expression represents the complete probability density for observing the event $x$ under the specified model and assumptions. It sums over all contributing initial states ($a,b$) and all distinguishable final-state configurations (the $12$ permutations), weighting each by its corresponding $b$-tagging probability and convolving the theoretical prediction with the detector response.", "answer": "$$\\boxed{L(x|\\theta) = \\frac{1}{\\sigma(\\theta)} \\sum_{a,b} \\sum_{k=1}^{12} \\left( \\prod_{j=1}^4 \\left[\\varepsilon_b^{t_j}(1-\\varepsilon_b)^{1-t_j}\\right]^{I_b(\\alpha_k,j)} \\left[\\varepsilon_q^{t_j}(1-\\varepsilon_q)^{1-t_j}\\right]^{I_q(\\alpha_k,j)} \\right) \\int_0^1 \\!\\! dx_1 \\int_0^1 \\!\\! dx_2 \\frac{f_a(x_1,Q^2)f_b(x_2,Q^2)}{2x_1x_2s} \\int \\! d\\Phi(y) |\\mathcal{M}_{ab \\to f}(y;\\theta)|^2 W(x|y;\\alpha_k)}$$", "id": "3522033"}, {"introduction": "Beyond event discovery or mass measurement, the Matrix Element Method is a premier tool for precision physics that can probe subtle quantum mechanical effects. This advanced practice [@problem_id:3522028] demonstrates how to use the spin-density matrix formalism within a MEM likelihood to measure the spin correlations in $t\\bar{t}$ production. By working directly with the fundamental quantum description of spin, you will build an observable sensitive to the underlying spin state of the top-antitop system, showcasing the ultimate power of the MEM approach.", "problem": "You will implement a minimal, but fully general, matrix-element-based per-event likelihood for top–antitop spin correlations using the spin-density matrix formalism, and then quantify per-event sensitivity using lepton angles. Work entirely in the narrow-width approximation, in which the squared matrix element factorizes into a production spin-density matrix and decay spin analyzers. The goal is to construct, from first principles, a normalized per-event likelihood ratio and per-event score for specified correlation hypotheses, using only lepton directions in the respective top and antitop rest frames.\n\nStart from the following fundamental base:\n- In the narrow-width approximation, the fully differential rate for a process with two decaying spin-$\\tfrac{1}{2}$ parents factorizes into a production spin-density matrix and decay density matrices. This can be expressed in terms of traces over spin indices without loss of generality.\n- The production spin-density matrix for top–antitop at leading order can be expanded on the Pauli basis as\n$$\n\\rho = \\frac{1}{4}\\left(I \\otimes I + \\sum_{i} P_i \\, \\sigma_i \\otimes I + \\sum_{i} \\bar{P}_i \\, I \\otimes \\sigma_i + \\sum_{i,j} C_{ij} \\, \\sigma_i \\otimes \\sigma_j \\right),\n$$\nwhere $I$ is the identity matrix on the spin-$\\tfrac{1}{2}$ space, $\\sigma_i$ are the Pauli matrices for $i \\in \\{x,y,z\\}$, and $C_{ij}$ is the spin-correlation tensor. Assume no single-spin polarization, i.e., $P_i = \\bar{P}_i = 0$, but keep the full correlation structure in the diagonal entries $C_{xx}$, $C_{yy}$, $C_{zz}$.\n- For a charged lepton from a polarized top (or antitop) decay, the lepton is a maximal spin analyzer with analyzing power $\\alpha_\\ell = 1$. The decay density matrix for a single lepton direction unit vector $\\hat{\\ell} = (\\ell_x,\\ell_y,\\ell_z)$ in the parent rest frame is\n$$\nD(\\hat{\\ell}) = \\frac{1}{2}\\left(I + \\alpha_\\ell \\, \\hat{\\ell}\\cdot \\vec{\\sigma}\\right),\n$$\nwith $\\vec{\\sigma} = (\\sigma_x,\\sigma_y,\\sigma_z)$.\n- The per-event weight (proportional to the differential rate) for observed lepton unit vectors $\\hat{\\ell}_+$ and $\\hat{\\ell}_-$ is given by the spin trace\n$$\nw(C_{xx},C_{yy},C_{zz} \\mid \\hat{\\ell}_+,\\hat{\\ell}_-) \\propto \\mathrm{Tr}\\left[ \\rho(C_{xx},C_{yy},C_{zz}) \\, D(\\hat{\\ell}_+) \\otimes D(\\hat{\\ell}_-) \\right].\n$$\nWork in a common fixed spin-quantization basis across production and decays. You may assume that overall normalization factors that are independent of the correlation parameters cancel in any likelihood ratio.\n\nYour tasks:\n1. Derive an explicit computable expression for the per-event weight $w$ in terms of the Pauli matrices, the decay density matrices, and the diagonal elements $(C_{xx},C_{yy},C_{zz})$ of the correlation tensor, starting from the trace expression and using only the algebraic properties of Pauli matrices. Then implement a function to compute $w$ directly via matrix operations without using any shortcut formulas.\n2. Define the per-event log-likelihood ratio for two hypotheses $H_1$ and $H_0$ with different correlation tensors as\n$$\nR \\equiv \\ln \\frac{L(H_1 \\mid \\hat{\\ell}_+,\\hat{\\ell}_-)}{L(H_0 \\mid \\hat{\\ell}_+,\\hat{\\ell}_-)},\n$$\nwith $L$ proportional to $w$. Because overall normalization independent of $(C_{xx},C_{yy},C_{zz})$ cancels, you may compute $R$ via the ratio of the corresponding weights.\n3. Define the per-event score for a scalar parameter $\\kappa$ appearing only as $C_{zz}=\\kappa$ (with $C_{xx}=C_{yy}=0$) as the derivative of the per-event log-likelihood with respect to $\\kappa$,\n$$\nS_z(\\kappa) \\equiv \\frac{\\partial}{\\partial \\kappa} \\ln L(\\kappa \\mid \\hat{\\ell}_+,\\hat{\\ell}_-).\n$$\nExpress $S_z(\\kappa)$ directly from the trace expression by differentiating with respect to $\\kappa$ under the trace, and implement it using matrix operations. Do not use any pre-simplified angular distribution formulas in your implementation.\n\nNumerical and algorithmic requirements:\n- Use the spin basis where the $z$-axis is the spin-quantization axis. Use angles in radians. For a lepton specified by polar angle $\\theta$ and azimuthal angle $\\phi$ relative to this basis, construct the unit vector $\\hat{\\ell} = (\\sin\\theta\\cos\\phi,\\sin\\theta\\sin\\phi,\\cos\\theta)$.\n- Set the analyzing power to $\\alpha_\\ell = 1$ for both leptons.\n- Ensure that the implementation uses $2\\times 2$ complex matrices for spin states and evaluates traces exactly using linear algebra. Do not hard-code any simplified final form for $w$; compute it by constructing $\\rho$, $D(\\hat{\\ell}_+)$, $D(\\hat{\\ell}_-)$, then tracing the product.\n- Angles are dimensionless; express all angles in radians.\n\nTest suite:\nUse the following four events, each defined by $(\\theta_+,\\phi_+,\\theta_-,\\phi_-)$ in radians, and two correlation hypotheses:\n- Hypothesis $H_0$: uncorrelated, with $C_{xx}=0$, $C_{yy}=0$, $C_{zz}=0$.\n- Hypothesis $H_{z,0.5}$: pure $z$-axis correlation, with $C_{xx}=0$, $C_{yy}=0$, $C_{zz}=0.5$.\n- Hypothesis $H_{\\mathrm{diag}}$: general diagonal correlation, with $C_{xx}=0.3$, $C_{yy}=-0.2$, $C_{zz}=0.5$.\n\nEvents:\n- Event 1: $\\theta_+ = \\pi/3$, $\\phi_+ = 0.7$, $\\theta_- = \\pi/6$, $\\phi_- = -1.0$.\n- Event 2: $\\theta_+ = 0.0$, $\\phi_+ = 0.0$, $\\theta_- = 0.0$, $\\phi_- = 0.0$.\n- Event 3: $\\theta_+ = 0.0$, $\\phi_+ = 2.0$, $\\theta_- = \\pi$, $\\phi_- = -0.3$.\n- Event 4: $\\theta_+ = \\pi/2$, $\\phi_+ = \\pi/4$, $\\theta_- = \\pi/2$, $\\phi_- = 3\\pi/4$.\n\nFor each event $i$, compute the following four quantities:\n- $R^{(i)}_{z,0.5} \\equiv \\ln \\dfrac{L(H_{z,0.5} \\mid \\hat{\\ell}_+^{(i)},\\hat{\\ell}_-^{(i)})}{L(H_0 \\mid \\hat{\\ell}_+^{(i)},\\hat{\\ell}_-^{(i)})}$.\n- $S^{(i)}_{z}(0) \\equiv \\left.\\dfrac{\\partial}{\\partial \\kappa} \\ln L(\\kappa \\mid \\hat{\\ell}_+^{(i)},\\hat{\\ell}_-^{(i)})\\right|_{\\kappa=0}$, where only $C_{zz}=\\kappa$ varies and $C_{xx}=C_{yy}=0$.\n- $R^{(i)}_{\\mathrm{diag}} \\equiv \\ln \\dfrac{L(H_{\\mathrm{diag}} \\mid \\hat{\\ell}_+^{(i)},\\hat{\\ell}_-^{(i)})}{L(H_0 \\mid \\hat{\\ell}_+^{(i)},\\hat{\\ell}_-^{(i)})}$.\n- $S^{(i)}_{z}(0.2) \\equiv \\left.\\dfrac{\\partial}{\\partial \\kappa} \\ln L(\\kappa \\mid \\hat{\\ell}_+^{(i)},\\hat{\\ell}_-^{(i)})\\right|_{\\kappa=0.2}$, again with only $C_{zz}=\\kappa$ varied.\n\nFinal output format:\nYour program should produce a single line of output containing the $16$ results as a comma-separated list enclosed in square brackets, ordered by event and, within each event, in the order\n$$\n\\left[R^{(1)}_{z,0.5},\\, S^{(1)}_{z}(0),\\, R^{(1)}_{\\mathrm{diag}},\\, S^{(1)}_{z}(0.2),\\, \\dots,\\, R^{(4)}_{z,0.5},\\, S^{(4)}_{z}(0),\\, R^{(4)}_{\\mathrm{diag}},\\, S^{(4)}_{z}(0.2)\\right].\n$$", "solution": "The problem requires the construction of a per-event likelihood and related statistical measures for top-antitop spin correlations using the spin-density matrix formalism. The implementation must be based on first principles, calculating the per-event weight by explicitly constructing and manipulating the relevant matrices.\n\nThe foundation of this analysis is the factorization of the differential cross-section (or rate) in the narrow-width approximation for a process involving two decaying spin-$1/2$ particles, such as $t\\bar{t}$ production followed by leptonic decays. The per-event weight $w$, which is proportional to the fully differential rate for a given set of final-state kinematics, is given by the trace over spin indices of the product of a production density matrix $\\rho$ and the decay density matrices for each particle. For the $t\\bar{t}$ system with observed leptons $\\ell^+$ and $\\ell^-$, this is expressed as:\n$$\nw(C_{ij} \\mid \\hat{\\ell}_+, \\hat{\\ell}_-) \\propto \\mathrm{Tr}\\left[ \\rho(C_{ij}) \\, \\left(D(\\hat{\\ell}_+) \\otimes D(\\hat{\\ell}_-)\\right) \\right]\n$$\nHere, $\\hat{\\ell}_+$ and $\\hat{\\ell}_-$ are the unit vectors of the charged lepton directions in their respective parent top-quark rest frames, and the trace is over the $4$-dimensional spin space of the $t\\bar{t}$ system.\n\nFirst, we establish the explicit forms of the matrices involved. The production spin-density matrix $\\rho$ for the $t\\bar{t}$ pair is given as an expansion on the basis of Pauli matrices $\\sigma_i$ ($i \\in \\{x,y,z\\}$). With the specified constraints of no net polarization ($P_i = \\bar{P}_i = 0$) and only diagonal spin correlations ($C_{ij} = 0$ for $i \\neq j$), $\\rho$ simplifies to:\n$$\n\\rho(C_{xx}, C_{yy}, C_{zz}) = \\frac{1}{4}\\left(I \\otimes I + C_{xx} \\, \\sigma_x \\otimes \\sigma_x + C_{yy} \\, \\sigma_y \\otimes \\sigma_y + C_{zz} \\, \\sigma_z \\otimes \\sigma_z \\right)\n$$\nwhere $I$ is the $2 \\times 2$ identity matrix and $\\otimes$ denotes the Kronecker (tensor) product. The Pauli matrices in the standard $z$-axis spin quantization basis are:\n$$\nI = \\begin{pmatrix} 1 & 0 \\\\ 0 & 1 \\end{pmatrix}, \\quad \\sigma_x = \\begin{pmatrix} 0 & 1 \\\\ 1 & 0 \\end{pmatrix}, \\quad \\sigma_y = \\begin{pmatrix} 0 & -i \\\\ i & 0 \\end{pmatrix}, \\quad \\sigma_z = \\begin{pmatrix} 1 & 0 \\\\ 0 & -1 \\end{pmatrix}\n$$\nThese are represented as $2 \\times 2$ complex matrices. The matrix $\\rho$ is therefore a $4 \\times 4$ complex matrix.\n\nThe decay of a polarized top quark into a charged lepton acts as a spin analyzer. The decay density matrix $D(\\hat{\\ell})$ for a single decay depends on the lepton's direction unit vector $\\hat{\\ell}$ in the top quark's rest frame and its analyzing power $\\alpha_\\ell$. For a maximal analyzing power $\\alpha_\\ell=1$, the expression is:\n$$\nD(\\hat{\\ell}) = \\frac{1}{2}\\left(I + \\hat{\\ell} \\cdot \\vec{\\sigma}\\right) = \\frac{1}{2}\\left(I + \\ell_x \\sigma_x + \\ell_y \\sigma_y + \\ell_z \\sigma_z\\right)\n$$\nThe unit vector $\\hat{\\ell} = (\\ell_x, \\ell_y, \\ell_z)$ is constructed from the lepton's polar angle $\\theta$ and azimuthal angle $\\phi$ as $\\hat{\\ell} = (\\sin\\theta\\cos\\phi, \\sin\\theta\\sin\\phi, \\cos\\theta)$. The full decay matrix for the $t\\bar{t}$ system is the tensor product of the individual decay matrices, $D(\\hat{\\ell}_+) \\otimes D(\\hat{\\ell}_-)$, which is a $4 \\times 4$ matrix. To compute the weight $w$, we construct the matrices $\\rho$, $D(\\hat{\\ell}_+)$, and $D(\\hat{\\ell}_-)$ for a given event and correlation hypothesis, compute their products and tensor products, and finally evaluate the trace of the resulting $4 \\times 4$ matrix.\n\nThe second task is to define the per-event log-likelihood ratio $R$ between two hypotheses, $H_1$ and $H_0$, characterized by different spin correlation tensors. The likelihood $L(H \\mid \\text{data})$ is proportional to the per-event weight $w(H \\mid \\text{data})$. The ratio is therefore:\n$$\nR \\equiv \\ln \\frac{L(H_1 \\mid \\hat{\\ell}_+, \\hat{\\ell}_-)}{L(H_0 \\mid \\hat{\\ell}_+, \\hat{\\ell}_-)} = \\ln \\frac{w(H_1 \\mid \\hat{\\ell}_+, \\hat{\\ell}_-)}{w(H_0 \\mid \\hat{\\ell}_+, \\hat{\\ell}_-)}\n$$\nAny overall normalization constants in $w$ that are independent of the correlation parameters $C_{ij}$ will cancel in this ratio. The computation involves calculating $w$ twice, once for the parameters of $H_1$ and once for $H_0$, and then taking the natural logarithm of their ratio.\n\nThe third task is to compute the per-event score $S_z(\\kappa)$, defined as the derivative of the log-likelihood with respect to a parameter of interest. Here, we consider a model where only $C_{zz}$ is non-zero, parameterized by $\\kappa$, i.e., $C_{xx}=C_{yy}=0$ and $C_{zz}=\\kappa$. The score is:\n$$\nS_z(\\kappa) \\equiv \\frac{\\partial}{\\partial \\kappa} \\ln L(\\kappa \\mid \\hat{\\ell}_+, \\hat{\\ell}_-)\n$$\nUsing the chain rule and the proportionality $L \\propto w$, this becomes:\n$$\nS_z(\\kappa) = \\frac{1}{L(\\kappa)} \\frac{\\partial L(\\kappa)}{\\partial \\kappa} = \\frac{1}{w(\\kappa)} \\frac{\\partial w(\\kappa)}{\\partial \\kappa}\n$$\nThe weight $w(\\kappa)$ is proportional to $\\mathrm{Tr}\\left[ \\rho(\\kappa) (D_+ \\otimes D_-) \\right]$, where $D_\\pm = D(\\hat{\\ell}_\\pm)$. The density matrix for this model is $\\rho(\\kappa) = \\frac{1}{4}(I \\otimes I + \\kappa \\, \\sigma_z \\otimes \\sigma_z)$. We can differentiate under the trace, as the trace is a linear operator and the matrix elements are smooth functions of $\\kappa$:\n$$\n\\frac{\\partial w(\\kappa)}{\\partial \\kappa} \\propto \\frac{\\partial}{\\partial \\kappa} \\mathrm{Tr}\\left[ \\rho(\\kappa) (D_+ \\otimes D_-) \\right] = \\mathrm{Tr}\\left[ \\left(\\frac{\\partial \\rho(\\kappa)}{\\partial \\kappa}\\right) (D_+ \\otimes D_-) \\right]\n$$\nThe derivative of the production density matrix is:\n$$\n\\frac{\\partial \\rho(\\kappa)}{\\partial \\kappa} = \\frac{\\partial}{\\partial \\kappa} \\left[ \\frac{1}{4}(I \\otimes I + \\kappa \\, \\sigma_z \\otimes \\sigma_z) \\right] = \\frac{1}{4}(\\sigma_z \\otimes \\sigma_z)\n$$\nSubstituting this into the score expression, the normalization factors of $1/4$ cancel, yielding a computable expression for the score as a ratio of two traces:\n$$\nS_z(\\kappa) = \\frac{\\mathrm{Tr}\\left[ (\\sigma_z \\otimes \\sigma_z) (D(\\hat{\\ell}_+) \\otimes D(\\hat{\\ell}_-)) \\right]}{\\mathrm{Tr}\\left[ (I \\otimes I + \\kappa \\, \\sigma_z \\otimes \\sigma_z) (D(\\hat{\\ell}_+) \\otimes D(\\hat{\\ell}_-)) \\right]}\n$$\nThis expression is implemented by constructing the relevant matrices for the numerator and denominator and evaluating their traces. The denominator is proportional to the weight $w(\\kappa)$ itself. This procedure, based entirely on matrix operations, adheres to the problem's constraints.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\n# --- Global Definitions ---\n# Define Pauli matrices and Identity as 2x2 complex matrices.\nI = np.eye(2, dtype=complex)\nSIGMA_X = np.array([[0, 1], [1, 0]], dtype=complex)\nSIGMA_Y = np.array([[0, -1j], [1j, 0]], dtype=complex)\nSIGMA_Z = np.array([[1, 0], [0, -1]], dtype=complex)\nSIGMA_VEC = [SIGMA_X, SIGMA_Y, SIGMA_Z]\n\n# --- Helper Functions for Matrix Construction ---\n\ndef get_lepton_vector(theta, phi):\n    \"\"\"Constructs a 3D unit vector from spherical coordinates.\"\"\"\n    lx = np.sin(theta) * np.cos(phi)\n    ly = np.sin(theta) * np.sin(phi)\n    lz = np.cos(theta)\n    return np.array([lx, ly, lz])\n\ndef get_decay_matrix(l_vec):\n    \"\"\"Constructs the decay density matrix D(l) for a lepton vector.\"\"\"\n    # Analyzing power alpha_ell is 1.\n    ell_dot_sigma = l_vec[0] * SIGMA_X + l_vec[1] * SIGMA_Y + l_vec[2] * SIGMA_Z\n    return 0.5 * (I + ell_dot_sigma)\n\ndef get_production_matrix(C_diag):\n    \"\"\"Constructs the production density matrix rho for diagonal correlations.\"\"\"\n    c_xx, c_yy, c_zz = C_diag\n    rho = (np.kron(I, I) +\n           c_xx * np.kron(SIGMA_X, SIGMA_X) +\n           c_yy * np.kron(SIGMA_Y, SIGMA_Y) +\n           c_zz * np.kron(SIGMA_Z, SIGMA_Z))\n    return 0.25 * rho\n\n# --- Core Calculation Functions ---\n\ndef calculate_weight(C_diag, l_plus_angles, l_minus_angles):\n    \"\"\"\n    Calculates the per-event weight w by constructing all matrices from scratch.\n    w ~ Tr[rho * (D_plus x D_minus)]\n    \"\"\"\n    theta_p, phi_p = l_plus_angles\n    theta_m, phi_m = l_minus_angles\n\n    # 1. Construct lepton vectors\n    l_plus_vec = get_lepton_vector(theta_p, phi_p)\n    l_minus_vec = get_lepton_vector(theta_m, phi_m)\n\n    # 2. Construct decay matrices\n    D_plus = get_decay_matrix(l_plus_vec)\n    D_minus = get_decay_matrix(l_minus_vec)\n    D_full = np.kron(D_plus, D_minus)\n\n    # 3. Construct production matrix\n    rho = get_production_matrix(C_diag)\n\n    # 4. Calculate trace of the product\n    weight_matrix = rho @ D_full\n    \n    # Trace should be real; take real part to discard floating-point noise\n    return np.trace(weight_matrix).real\n\ndef calculate_score_z(kappa, l_plus_angles, l_minus_angles):\n    \"\"\"\n    Calculates the per-event score S_z(kappa).\n    S_z(k) = (d/dk Tr[...]) / Tr[...]\n    \"\"\"\n    theta_p, phi_p = l_plus_angles\n    theta_m, phi_m = l_minus_angles\n\n    # Common components for numerator and denominator\n    l_plus_vec = get_lepton_vector(theta_p, phi_p)\n    l_minus_vec = get_lepton_vector(theta_m, phi_m)\n    D_plus = get_decay_matrix(l_plus_vec)\n    D_minus = get_decay_matrix(l_minus_vec)\n    D_full = np.kron(D_plus, D_minus)\n    \n    # --- Numerator calculation: Tr[(d(rho)/dk) * D_full] ---\n    # d(rho)/dk = (1/4) * (sigma_z x sigma_z)\n    d_rho_d_kappa = 0.25 * np.kron(SIGMA_Z, SIGMA_Z)\n    numerator_matrix = d_rho_d_kappa @ D_full\n    numerator = np.trace(numerator_matrix).real\n\n    # --- Denominator calculation: Tr[rho(kappa) * D_full] ---\n    # This is promotional to the weight w(kappa). We can reuse the weight function.\n    # The normalization constant (0.25) is included in both numerator and\n    # denominator calculations, so it cancels perfectly.\n    C_diag_kappa = (0.0, 0.0, kappa)\n    rho_kappa = get_production_matrix(C_diag_kappa)\n    denominator_matrix = rho_kappa @ D_full\n    denominator = np.trace(denominator_matrix).real\n    \n    # Avoid division by zero, though unlikely in physical scenarios\n    if np.isclose(denominator, 0):\n        return np.inf if numerator > 0 else -np.inf if numerator  0 else 0.0\n\n    return numerator / denominator\n\ndef solve():\n    # --- Test Suite Definition ---\n    # Correlation hypotheses\n    H0 = (0.0, 0.0, 0.0)         # Uncorrelated\n    H_z_05 = (0.0, 0.0, 0.5)     # Pure z-axis correlation\n    H_diag = (0.3, -0.2, 0.5)    # General diagonal correlation\n\n    # Events defined by (theta+, phi+, theta-, phi-) in radians\n    events = [\n        (np.pi/3, 0.7, np.pi/6, -1.0),\n        (0.0, 0.0, 0.0, 0.0),\n        (0.0, 2.0, np.pi, -0.3),\n        (np.pi/2, np.pi/4, np.pi/2, 3*np.pi/4),\n    ]\n\n    results = []\n    for event_angles in events:\n        # Unpack angles for the current event\n        plus_angles = event_angles[:2]\n        minus_angles = event_angles[2:]\n        \n        # Calculate weights for the two hypotheses needed for LLRs\n        w0 = calculate_weight(H0, plus_angles, minus_angles)\n        w_z_05 = calculate_weight(H_z_05, plus_angles, minus_angles)\n        w_diag = calculate_weight(H_diag, plus_angles, minus_angles)\n        \n        # 1. R_z,0.5 = ln(L(H_z,0.5)/L(H0))\n        r_z_05 = np.log(w_z_05 / w0)\n\n        # 2. S_z(0)\n        s_z_0 = calculate_score_z(0.0, plus_angles, minus_angles)\n        \n        # 3. R_diag = ln(L(H_diag)/L(H0))\n        r_diag = np.log(w_diag / w0)\n        \n        # 4. S_z(0.2)\n        s_z_02 = calculate_score_z(0.2, plus_angles, minus_angles)\n        \n        results.extend([r_z_05, s_z_0, r_diag, s_z_02])\n\n    # Final print statement in the exact required format.\n    # Using a high precision format string for floating point numbers\n    print(f\"[{','.join(f'{x:.15f}' for x in results)}]\")\n\nsolve()\n```", "id": "3522028"}]}