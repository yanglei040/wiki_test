{"hands_on_practices": [{"introduction": "This exercise is fundamental to the finite volume method. We begin with the integral form of the mass conservation law and apply it to a single control volume on a staggered grid. This practice demonstrates how the staggered arrangement of variables leads directly to a discrete equation that rigorously enforces mass conservation for each cell, a critical property for any reliable CFD simulation. [@problem_id:3346588]", "problem": "Consider a two-dimensional Cartesian domain discretized by a uniform staggered grid used in Computational Fluid Dynamics (CFD). Pressure and density are stored at cell centers indexed by $(i,j)$, the $x$-momentum velocity component $u$ is stored at vertical faces indexed by $(i+\\tfrac{1}{2},j)$, and the $y$-momentum velocity component $v$ is stored at horizontal faces indexed by $(i,j+\\tfrac{1}{2})$. The cell-centered control volume has dimensions $\\Delta x$ by $\\Delta y$. Assume no volumetric mass source within the cell. The governing principle is the integral mass conservation over a fixed control volume: \n$$\\frac{\\mathrm{d}}{\\mathrm{d} t}\\int_{V}\\rho\\,\\mathrm{d}V+\\oint_{\\partial V}\\rho\\,\\boldsymbol{u}\\cdot \\boldsymbol{n}\\,\\mathrm{d}A=0,$$\nwhere $\\rho$ is the mass density and $\\boldsymbol{u}$ is the velocity vector.\n\nDefine the discrete face mass fluxes \n$$m^{x}_{i+\\tfrac{1}{2},j}=\\rho_{i+\\tfrac{1}{2},j}\\,u_{i+\\tfrac{1}{2},j}\\,\\Delta y,\\qquad m^{x}_{i-\\tfrac{1}{2},j}=\\rho_{i-\\tfrac{1}{2},j}\\,u_{i-\\tfrac{1}{2},j}\\,\\Delta y,$$\n$$m^{y}_{i,j+\\tfrac{1}{2}}=\\rho_{i,j+\\tfrac{1}{2}}\\,v_{i,j+\\tfrac{1}{2}}\\,\\Delta x,\\qquad m^{y}_{i,j-\\tfrac{1}{2}}=\\rho_{i,j-\\tfrac{1}{2}}\\,v_{i,j-\\tfrac{1}{2}}\\,\\Delta x,$$\nwith the convention that $m^{x}_{i+\\tfrac{1}{2},j}$ is positive for flow in the $+x$ direction across the east face, $m^{x}_{i-\\tfrac{1}{2},j}$ is positive for flow in the $+x$ direction across the west face, $m^{y}_{i,j+\\tfrac{1}{2}}$ is positive for flow in the $+y$ direction across the north face, and $m^{y}_{i,j-\\tfrac{1}{2}}$ is positive for flow in the $+y$ direction across the south face. Let the cell-centered density at time levels $n$ and $n+1$ be $\\rho^{n}_{i,j}$ and $\\rho^{n+1}_{i,j}$, respectively, and adopt a backward Euler time integration over a time step $\\Delta t$ for the cell-averaged storage term.\n\nStarting strictly from the given integral mass conservation principle and applying the finite-volume discretization on the staggered grid, derive the conservative continuity balance per pressure cell $(i,j)$ that must vanish in the fully discrete form. Express your final answer as a single closed-form analytic expression for the residual (i.e., the left-hand side that equals zero), in terms of $\\rho^{n+1}_{i,j}$, $\\rho^{n}_{i,j}$, $\\Delta x$, $\\Delta y$, $\\Delta t$, $m^{x}_{i\\pm\\tfrac{1}{2},j}$, and $m^{y}_{i,j\\pm\\tfrac{1}{2}}$. Do not include an equality sign in your final answer. No numerical evaluation is required.", "solution": "The objective is to derive the fully discrete form of the mass conservation equation for a control volume centered at $(i,j)$ using the finite-volume method on a staggered grid. The starting point is the integral form of the continuity equation for a fixed control volume $V$:\n$$ \\frac{\\mathrm{d}}{\\mathrm{d} t}\\int_{V}\\rho\\,\\mathrm{d}V+\\oint_{\\partial V}\\rho\\,\\boldsymbol{u}\\cdot \\boldsymbol{n}\\,\\mathrm{d}A=0 $$\nThis equation states that the rate of increase of mass within the control volume is equal to the net rate of mass flowing into it.\n\nWe apply this principle to the control volume $V_{i,j}$ associated with the cell center $(i,j)$. This control volume is a rectangular region with dimensions $\\Delta x \\times \\Delta y$. For a two-dimensional analysis, we assume a unit depth, so the volume of the cell is $\\Delta V = \\Delta x \\Delta y$.\n\nThe two terms in the conservation law are discretized separately.\n\n**1. Discretization of the Storage Term**\n\nThe first term, $\\frac{\\mathrm{d}}{\\mathrm{d} t}\\int_{V}\\rho\\,\\mathrm{d}V$, represents the rate of change of mass within the control volume. For the control volume $V_{i,j}$, we approximate the integral by assuming the cell-centered density $\\rho_{i,j}$ is representative of the average density over the cell:\n$$ \\int_{V_{i,j}}\\rho\\,\\mathrm{d}V \\approx \\rho_{i,j} \\Delta V = \\rho_{i,j} \\Delta x \\Delta y $$\nThe time derivative is then applied to this expression. Since the grid is fixed, $\\Delta x$ and $\\Delta y$ are constant in time:\n$$ \\frac{\\mathrm{d}}{\\mathrm{d} t}\\int_{V_{i,j}}\\rho\\,\\mathrm{d}V \\approx \\frac{\\mathrm{d}}{\\mathrm{d} t}(\\rho_{i,j} \\Delta x \\Delta y) = \\Delta x \\Delta y \\frac{\\mathrm{d}\\rho_{i,j}}{\\mathrm{d}t} $$\nThe problem specifies a backward Euler scheme for time integration over a time step $\\Delta t = t^{n+1} - t^{n}$. This scheme approximates the time derivative using values at the beginning and end of the time step:\n$$ \\frac{\\mathrm{d}\\rho_{i,j}}{\\mathrm{d}t} \\approx \\frac{\\rho^{n+1}_{i,j} - \\rho^{n}_{i,j}}{\\Delta t} $$\nSubstituting this into the expression for the storage term gives its fully discrete form:\n$$ \\Delta x \\Delta y \\frac{\\rho^{n+1}_{i,j} - \\rho^{n}_{i,j}}{\\Delta t} $$\nThe backward Euler method is an implicit scheme, so the flux terms, which are not part of the time derivative, are evaluated at the new time level, $n+1$.\n\n**2. Discretization of the Flux Term**\n\nThe second term, $\\oint_{\\partial V}\\rho\\,\\boldsymbol{u}\\cdot \\boldsymbol{n}\\,\\mathrm{d}A$, represents the net mass flux out of the control volume across its boundary $\\partial V$. The boundary of the cell $V_{i,j}$ consists of four faces: east (e), west (w), north (n), and south (s). The surface integral is thus the sum of the fluxes through these four faces:\n$$ \\oint_{\\partial V_{i,j}}\\rho\\,\\boldsymbol{u}\\cdot \\boldsymbol{n}\\,\\mathrm{d}A = \\int_{A_e} (\\rho\\boldsymbol{u}\\cdot\\boldsymbol{n}_e)\\mathrm{d}A + \\int_{A_w} (\\rho\\boldsymbol{u}\\cdot\\boldsymbol{n}_w)\\mathrm{d}A + \\int_{A_n} (\\rho\\boldsymbol{u}\\cdot\\boldsymbol{n}_n)\\mathrm{d}A + \\int_{A_s} (\\rho\\boldsymbol{u}\\cdot\\boldsymbol{n}_s)\\mathrm{d}A $$\nWe evaluate each face integral:\n*   **East face (e)**: This face is located at $x_{i+\\frac{1}{2}}$. The outward unit normal is $\\boldsymbol{n}_e = (1, 0)$. The face area is $A_e = \\Delta y$. The dot product is $\\rho\\boldsymbol{u}\\cdot\\boldsymbol{n}_e = \\rho u$. The flux is approximated as $(\\rho u)_{i+\\frac{1}{2},j} A_e = (\\rho u)_{i+\\frac{1}{2},j} \\Delta y$. The problem provides the discrete mass flux $m^{x}_{i+\\frac{1}{2},j}=\\rho_{i+\\frac{1}{2},j}\\,u_{i+\\frac{1}{2},j}\\,\\Delta y$, which is defined as positive for flow in the $+x$ direction (outward). Thus, the mass outflow rate is precisely $m^{x}_{i+\\frac{1}{2},j}$.\n*   **West face (w)**: This face is at $x_{i-\\frac{1}{2}}$. The outward unit normal is $\\boldsymbol{n}_w = (-1, 0)$. The face area is $A_w = \\Delta y$. The dot product is $\\rho\\boldsymbol{u}\\cdot\\boldsymbol{n}_w = -\\rho u$. The outward flux is approximated as $(-\\rho u)_{i-\\frac{1}{2},j} A_w = -(\\rho u)_{i-\\frac{1}{2},j} \\Delta y$. The problem provides the discrete mass flux $m^{x}_{i-\\frac{1}{2},j}=\\rho_{i-\\frac{1}{2},j}\\,u_{i-\\frac{1}{2},j}\\,\\Delta y$, defined as positive for flow in the $+x$ direction. A positive $m^{x}_{i-\\frac{1}{2},j}$ represents an inflow to the cell $V_{i,j}$. Therefore, the mass outflow rate through the west face is $-m^{x}_{i-\\frac{1}{2},j}$.\n*   **North face (n)**: This face is at $y_{j+\\frac{1}{2}}$. The outward unit normal is $\\boldsymbol{n}_n = (0, 1)$. The face area is $A_n = \\Delta x$. The dot product is $\\rho\\boldsymbol{u}\\cdot\\boldsymbol{n}_n = \\rho v$. The outward flux is approximated as $(\\rho v)_{i,j+\\frac{1}{2}} A_n = (\\rho v)_{i,j+\\frac{1}{2}} \\Delta x$. The given mass flux $m^{y}_{i,j+\\frac{1}{2}}=\\rho_{i,j+\\frac{1}{2}}\\,v_{i,j+\\frac{1}{2}}\\,\\Delta x$ is positive for flow in the $+y$ direction (outward). Thus, the mass outflow rate is $m^{y}_{i,j+\\frac{1}{2}}$.\n*   **South face (s)**: This face is at $y_{j-\\frac{1}{2}}$. The outward unit normal is $\\boldsymbol{n}_s = (0, -1)$. The face area is $A_s = \\Delta x$. The dot product is $\\rho\\boldsymbol{u}\\cdot\\boldsymbol{n}_s = -\\rho v$. The outward flux is approximated as $(-\\rho v)_{i,j-\\frac{1}{2}} A_s = -(\\rho v)_{i,j-\\frac{1}{2}} \\Delta x$. The given mass flux $m^{y}_{i,j-\\frac{1}{2}}=\\rho_{i,j-\\frac{1}{2}}\\,v_{i,j-\\frac{1}{2}}\\,\\Delta x$ is positive for flow in the $+y$ direction, which is an inflow. The mass outflow rate through the south face is therefore $-m^{y}_{i,j-\\frac{1}{2}}$.\n\nSumming the contributions from all four faces gives the net mass outflow rate:\n$$ \\oint_{\\partial V_{i,j}}\\rho\\,\\boldsymbol{u}\\cdot \\boldsymbol{n}\\,\\mathrm{d}A \\approx m^{x}_{i+\\frac{1}{2},j} - m^{x}_{i-\\frac{1}{2},j} + m^{y}_{i,j+\\frac{1}{2}} - m^{y}_{i,j-\\frac{1}{2}} $$\n\n**3. Assembling the Final Equation**\n\nCombining the discretized storage and flux terms yields the fully discrete mass conservation equation:\n$$ \\Delta x \\Delta y \\frac{\\rho^{n+1}_{i,j} - \\rho^{n}_{i,j}}{\\Delta t} + \\left( m^{x}_{i+\\frac{1}{2},j} - m^{x}_{i-\\frac{1}{2},j} \\right) + \\left( m^{y}_{i,j+\\frac{1}{2}} - m^{y}_{i,j-\\frac{1}{2}} \\right) = 0 $$\nThe problem asks for the expression for the residual, which is the left-hand side of this equation. This expression represents the \"conservative continuity balance per pressure cell\" that must be driven to zero by the numerical solver.", "answer": "$$ \\boxed{\\Delta x \\Delta y \\frac{\\rho^{n+1}_{i,j} - \\rho^{n}_{i,j}}{\\Delta t} + m^{x}_{i+\\frac{1}{2},j} - m^{x}_{i-\\frac{1}{2},j} + m^{y}_{i,j+\\frac{1}{2}} - m^{y}_{i,j-\\frac{1}{2}}} $$", "id": "3346588"}, {"introduction": "Having addressed mass conservation, we now turn to the momentum equation, specifically the viscous diffusion term represented by the Laplacian operator. This practice illustrates how to construct a consistent and accurate finite difference approximation for a second derivative on a staggered grid. You will see how the staggered storage of velocity components allows for a natural and compact five-point stencil for the Laplacian, which is essential for modeling viscous effects in a fluid flow. [@problem_id:3346623]", "problem": "Consider a two-dimensional incompressible flow discretized on a Marker-and-Cell (MAC) staggered grid. The pressure $p$ is stored at cell centers $(i,j)$ with coordinates $(x_i,y_j)$, the horizontal velocity component $u$ is stored at cell faces normal to the $x$-direction at $(i+\\tfrac{1}{2},j)$ with coordinates $(x_{i+\\frac{1}{2}},y_j)$, and the vertical velocity component $v$ is stored at cell faces normal to the $y$-direction at $(i,j+\\tfrac{1}{2})$ with coordinates $(x_i,y_{j+\\frac{1}{2}})$. The Cartesian grid is uniform with spacings $\\Delta x$ and $\\Delta y$ so that $x_{i+1}-x_i=\\Delta x$ and $y_{j+1}-y_j=\\Delta y$.\n\nStarting from the definition of the Laplacian in Cartesian coordinates, $\\nabla^{2} u \\equiv \\frac{\\partial^{2} u}{\\partial x^{2}} + \\frac{\\partial^{2} u}{\\partial y^{2}}$, derive the second-order central difference approximation to $\\nabla^{2} u$ at the staggered grid location $(i+\\tfrac{1}{2},j)$ that is consistent with the storage of $u$ on $x$-faces. Use Taylor series expansions about $(x_{i+\\frac{1}{2}},y_j)$ to justify the order of accuracy and explicitly demonstrate why any cross-derivative terms (mixed derivatives involving $\\frac{\\partial^{2} u}{\\partial x \\partial y}$) vanish on a Cartesian uniform grid for the central difference stencil you construct.\n\nExpress your final discrete operator for $\\nabla^{2} u$ at $(i+\\tfrac{1}{2},j)$ solely in terms of neighboring face-centered values $u_{i+\\frac{3}{2},\\,j}$, $u_{i+\\frac{1}{2},\\,j}$, $u_{i-\\frac{1}{2},\\,j}$, $u_{i+\\frac{1}{2},\\,j+1}$, and $u_{i+\\frac{1}{2},\\,j-1}$, as a single closed-form analytical expression. No numerical evaluation is required.", "solution": "The starting point is the definition of the Laplacian in Cartesian coordinates,\n$$\n\\nabla^{2} u(x,y) \\equiv \\frac{\\partial^{2} u}{\\partial x^{2}}(x,y) + \\frac{\\partial^{2} u}{\\partial y^{2}}(x,y).\n$$\nOn a Marker-And-Cell (MAC) staggered grid, the horizontal velocity component $u$ is defined at locations $(x_{i+\\frac{1}{2}},y_j)$, which lie at the centers of faces normal to the $x$-direction. The aim is to construct second-order central difference approximations of $\\frac{\\partial^{2} u}{\\partial x^{2}}$ and $\\frac{\\partial^{2} u}{\\partial y^{2}}$ evaluated at $(x_{i+\\frac{1}{2}},y_j)$ using the neighboring face-centered $u$ values.\n\nFor the second derivative in the $x$-direction at $(x_{i+\\frac{1}{2}},y_j)$, we use the points $(x_{i+\\frac{3}{2}},y_j)$ and $(x_{i-\\frac{1}{2}},y_j)$. The uniform grid implies $x_{i+\\frac{3}{2}} - x_{i+\\frac{1}{2}} = \\Delta x$ and $x_{i+\\frac{1}{2}} - x_{i-\\frac{1}{2}} = \\Delta x$. Perform Taylor series expansions of $u$ about $(x_{i+\\frac{1}{2}},y_j)$:\n$$\nu(x_{i+\\frac{3}{2}},y_j) = u(x_{i+\\frac{1}{2}},y_j) + \\Delta x\\, u_{x}(x_{i+\\frac{1}{2}},y_j) + \\frac{(\\Delta x)^{2}}{2}\\, u_{xx}(x_{i+\\frac{1}{2}},y_j) + \\frac{(\\Delta x)^{3}}{6}\\, u_{xxx}(x_{i+\\frac{1}{2}},y_j) + \\frac{(\\Delta x)^{4}}{24}\\, u_{xxxx}(x_{i+\\frac{1}{2}},y_j) + \\mathcal{O}((\\Delta x)^{5}),\n$$\n$$\nu(x_{i-\\frac{1}{2}},y_j) = u(x_{i+\\frac{1}{2}},y_j) - \\Delta x\\, u_{x}(x_{i+\\frac{1}{2}},y_j) + \\frac{(\\Delta x)^{2}}{2}\\, u_{xx}(x_{i+\\frac{1}{2}},y_j) - \\frac{(\\Delta x)^{3}}{6}\\, u_{xxx}(x_{i+\\frac{1}{2}},y_j) + \\frac{(\\Delta x)^{4}}{24}\\, u_{xxxx}(x_{i+\\frac{1}{2}},y_j) + \\mathcal{O}((\\Delta x)^{5}),\n$$\nwhere subscripts denote partial derivatives evaluated at $(x_{i+\\frac{1}{2}},y_j)$. Adding these two expressions and subtracting twice $u(x_{i+\\frac{1}{2}},y_j)$ gives\n$$\nu(x_{i+\\frac{3}{2}},y_j) - 2\\,u(x_{i+\\frac{1}{2}},y_j) + u(x_{i-\\frac{1}{2}},y_j) = (\\Delta x)^{2}\\, u_{xx}(x_{i+\\frac{1}{2}},y_j) + \\frac{(\\Delta x)^{4}}{12}\\, u_{xxxx}(x_{i+\\frac{1}{2}},y_j) + \\mathcal{O}((\\Delta x)^{6}).\n$$\nDividing by $(\\Delta x)^{2}$ yields the second-order central difference approximation\n$$\n\\frac{u_{i+\\frac{3}{2},\\,j} - 2\\,u_{i+\\frac{1}{2},\\,j} + u_{i-\\frac{1}{2},\\,j}}{(\\Delta x)^{2}} = u_{xx}(x_{i+\\frac{1}{2}},y_j) + \\frac{(\\Delta x)^{2}}{12}\\, u_{xxxx}(x_{i+\\frac{1}{2}},y_j) + \\mathcal{O}((\\Delta x)^{4}),\n$$\nwhich is second-order accurate in $\\Delta x$.\n\nFor the second derivative in the $y$-direction at $(x_{i+\\frac{1}{2}},y_j)$, use the points $(x_{i+\\frac{1}{2}},y_{j+1})$ and $(x_{i+\\frac{1}{2}},y_{j-1})$, with $y_{j+1} - y_j = \\Delta y$ and $y_j - y_{j-1} = \\Delta y$. Taylor expansions about $(x_{i+\\frac{1}{2}},y_j)$ are\n$$\nu(x_{i+\\frac{1}{2}},y_{j+1}) = u(x_{i+\\frac{1}{2}},y_j) + \\Delta y\\, u_{y}(x_{i+\\frac{1}{2}},y_j) + \\frac{(\\Delta y)^{2}}{2}\\, u_{yy}(x_{i+\\frac{1}{2}},y_j) + \\frac{(\\Delta y)^{3}}{6}\\, u_{yyy}(x_{i+\\frac{1}{2}},y_j) + \\frac{(\\Delta y)^{4}}{24}\\, u_{yyyy}(x_{i+\\frac{1}{2}},y_j) + \\mathcal{O}((\\Delta y)^{5}),\n$$\n$$\nu(x_{i+\\frac{1}{2}},y_{j-1}) = u(x_{i+\\frac{1}{2}},y_j) - \\Delta y\\, u_{y}(x_{i+\\frac{1}{2}},y_j) + \\frac{(\\Delta y)^{2}}{2}\\, u_{yy}(x_{i+\\frac{1}{2}},y_j) - \\frac{(\\Delta y)^{3}}{6}\\, u_{yyy}(x_{i+\\frac{1}{2}},y_j) + \\frac{(\\Delta y)^{4}}{24}\\, u_{yyyy}(x_{i+\\frac{1}{2}},y_j) + \\mathcal{O}((\\Delta y)^{5}).\n$$\nSumming and subtracting twice $u(x_{i+\\frac{1}{2}},y_j)$ gives\n$$\nu(x_{i+\\frac{1}{2}},y_{j+1}) - 2\\,u(x_{i+\\frac{1}{2}},y_j) + u(x_{i+\\frac{1}{2}},y_{j-1}) = (\\Delta y)^{2}\\, u_{yy}(x_{i+\\frac{1}{2}},y_j) + \\frac{(\\Delta y)^{4}}{12}\\, u_{yyyy}(x_{i+\\frac{1}{2}},y_j) + \\mathcal{O}((\\Delta y)^{6}),\n$$\nso the second-order central difference approximation is\n$$\n\\frac{u_{i+\\frac{1}{2},\\,j+1} - 2\\,u_{i+\\frac{1}{2},\\,j} + u_{i+\\frac{1}{2},\\,j-1}}{(\\Delta y)^{2}} = u_{yy}(x_{i+\\frac{1}{2}},y_j) + \\frac{(\\Delta y)^{2}}{12}\\, u_{yyyy}(x_{i+\\frac{1}{2}},y_j) + \\mathcal{O}((\\Delta y)^{4}),\n$$\nwhich is second-order accurate in $\\Delta y$.\n\nAdding the two approximations yields a discrete Laplacian at $(x_{i+\\frac{1}{2}},y_j)$:\n$$\n\\frac{u_{i+\\frac{3}{2},\\,j} - 2\\,u_{i+\\frac{1}{2},\\,j} + u_{i-\\frac{1}{2},\\,j}}{(\\Delta x)^{2}} + \\frac{u_{i+\\frac{1}{2},\\,j+1} - 2\\,u_{i+\\frac{1}{2},\\,j} + u_{i+\\frac{1}{2},\\,j-1}}{(\\Delta y)^{2}} = \\nabla^{2} u(x_{i+\\frac{1}{2}},y_j) + \\mathcal{O}((\\Delta x)^{2}) + \\mathcal{O}((\\Delta y)^{2}).\n$$\n\nIt remains to explain why cross-derivative terms $u_{xy}(x_{i+\\frac{1}{2}},y_j)$ do not appear in the constructed discrete operator. Consider the two-dimensional Taylor expansion of $u$ about $(x_{0},y_{0})$ evaluated at $(x_{0}+h,y_{0}+k)$:\n$$\nu(x_{0}+h,y_{0}+k) = u(x_{0},y_{0}) + h\\, u_{x} + k\\, u_{y} + \\frac{h^{2}}{2}\\, u_{xx} + h k\\, u_{xy} + \\frac{k^{2}}{2}\\, u_{yy} + \\cdots,\n$$\nwhere all derivatives are evaluated at $(x_{0},y_{0})$. The mixed derivative $u_{xy}$ appears multiplied by the product $h k$. In the stencils used above to approximate $u_{xx}$ and $u_{yy}$, the offsets are purely along one coordinate: for $u_{xx}$, points have $(h,k)=(\\pm \\Delta x,0)$, and for $u_{yy}$, points have $(h,k)=(0,\\pm \\Delta y)$. In both cases, $h k = 0$, so the mixed derivative terms vanish identically in the expansions of the chosen stencil points. Moreover, the Laplacian in Cartesian coordinates does not contain cross derivatives by definition, $\\nabla^{2} u = u_{xx} + u_{yy}$, reflecting the orthogonality of the coordinate directions and the uniformity of the metric coefficients. Therefore, when forming the discrete Laplacian as the sum of the two decoupled second derivatives, no cross-derivative terms are introduced, and the constructed operator is a five-point stencil centered at $(i+\\tfrac{1}{2},j)$ involving only neighbors aligned along the coordinate axes.\n\nThus, the second-order central difference approximation to $\\nabla^{2} u$ at $(i+\\tfrac{1}{2},j)$ on a uniform Cartesian MAC staggered grid is\n$$\n\\frac{u_{i+\\frac{3}{2},\\,j} - 2\\,u_{i+\\frac{1}{2},\\,j} + u_{i-\\frac{1}{2},\\,j}}{(\\Delta x)^{2}} + \\frac{u_{i+\\frac{1}{2},\\,j+1} - 2\\,u_{i+\\frac{1}{2},\\,j} + u_{i+\\frac{1}{2},\\,j-1}}{(\\Delta y)^{2}},\n$$\nwith truncation error $\\mathcal{O}((\\Delta x)^{2}) + \\mathcal{O}((\\Delta y)^{2})$, and with all cross-derivative terms vanishing due to the orthogonality of the grid and the axial alignment of the stencil points.", "answer": "$$\\boxed{\\frac{u_{i+\\frac{3}{2},\\,j} - 2\\,u_{i+\\frac{1}{2},\\,j} + u_{i-\\frac{1}{2},\\,j}}{(\\Delta x)^{2}} + \\frac{u_{i+\\frac{1}{2},\\,j+1} - 2\\,u_{i+\\frac{1}{2},\\,j} + u_{i+\\frac{1}{2},\\,j-1}}{(\\Delta y)^{2}}}$$", "id": "3346623"}, {"introduction": "Theory meets practice in this final exercise, where you will implement a numerical test to diagnose a common source of error in CFD: handling curved boundaries on a Cartesian grid. Using the discrete divergence operator, you will quantify how different boundary condition schemes fail to perfectly conserve mass, leading to artificial sources or sinks. This coding challenge highlights the practical consequences of discretization choices and the importance of careful boundary treatment in complex geometries. [@problem_id:3346576]", "problem": "You are asked to implement a quantitative test for numerical slip at a curved solid boundary on a two-dimensional Marker-And-Cell (MAC) staggered grid using a ghost-cell style treatment of the momentum components. The intent is to measure how the interpolation of wall-normal velocity to face centers changes the discrete divergence in near-wall fluid cells, thereby assessing mass conservation errors introduced by boundary enforcement at curved walls.\n\nFundamentals and Setup:\n- Begin from the mass conservation law for incompressible flow, namely the continuity equation $\\nabla \\cdot \\boldsymbol{u} = 0$, where $\\boldsymbol{u} = (u,v)$ is the velocity.\n- Use a two-dimensional MAC grid on the unit square domain $[0,1] \\times [0,1]$ with $N \\times N$ control volumes. The grid spacing is $\\Delta x = \\Delta y = 1/N$.\n- Stagger velocity components: the horizontal component $u$ is stored at vertical face centers $(x_{i+\\frac{1}{2}}, y_j)$ and the vertical component $v$ is stored at horizontal face centers $(x_i, y_{j+\\frac{1}{2}})$, where $x_i = (i+\\tfrac{1}{2}) \\Delta x$ for cell centers and $x_{i+\\frac{1}{2}} = i \\Delta x$ for faces, and analogously for $y$.\n- Embed a circular solid obstacle using an indicator function on cell centers. The solid is the disk of radius $R$ centered at $(c_x,c_y) = (0.5,0.5)$. A cell at center $(x_i,y_j)$ is solid if $(x_i - c_x)^2 + (y_j - c_y)^2 < R^2$, otherwise it is fluid.\n- Adopt a smooth, divergence-free manufactured velocity field as a baseline: solid-body rotation about $(c_x,c_y)$ with angular speed $\\omega = 1$, namely $u(x,y) = -\\omega (y - c_y)$ and $v(x,y) = \\omega (x - c_x)$, which satisfies $\\partial u/\\partial x + \\partial v/\\partial y = 0$ identically.\n\nDiscrete divergence:\n- For any fluid cell $(i,j)$, define the discrete divergence operator\n$$\n(\\nabla_h \\cdot \\boldsymbol{u})_{i,j} \\equiv \\frac{u_{i+\\frac{1}{2},j} - u_{i-\\frac{1}{2},j}}{\\Delta x} + \\frac{v_{i,j+\\frac{1}{2}} - v_{i,j-\\frac{1}{2}}}{\\Delta y}.\n$$\n- A “near-wall” cell is any fluid cell with at least one of its four neighboring cells (sharing a face) marked solid.\n\nCurved boundary treatment on a staggered grid:\n- For any face that lies between a fluid cell and a solid cell (a “boundary face”), you must replace the baseline face-normal velocity with a boundary-consistent value. Consider two schemes:\n  1. Naive zeroing (denoted \"zero\"): set the face-normal velocity at a boundary face to $0$.\n  2. Linear interpolation to the wall (denoted \"linear\"): treat the wall as lying a distance $d$ from the face center along the face-normal direction. Let $U_1$ be the face-normal velocity at the next interior face one grid-spacing away from the wall along the same normal direction. Enforce the wall value $U(0)=0$ linearly by setting the boundary-face velocity $U_0$ to\n  $$\n  U_0 \\equiv U_1 \\frac{d}{d+\\Delta},\n  $$\n  where $\\Delta$ is the face-normal grid spacing (i.e., $\\Delta x$ for $u$-faces and $\\Delta y$ for $v$-faces). The distance $d$ is computed geometrically from the face center to the circle intersection along the corresponding coordinate line:\n  - For a $u$-face at $(x_f, y_f)$ adjacent to a solid cell on its right, use $x_w = c_x + \\sqrt{R^2 - (y_f - c_y)^2}$ and $d = x_w - x_f$. If the solid is on its left, use $x_w = c_x - \\sqrt{R^2 - (y_f - c_y)^2}$ and $d = x_f - x_w$.\n  - For a $v$-face at $(x_f, y_f)$ adjacent to a solid cell on its top, use $y_w = c_y + \\sqrt{R^2 - (x_f - c_x)^2}$ and $d = y_w - y_f$. If the solid is on its bottom, use $y_w = c_y - \\sqrt{R^2 - (x_f - c_x)^2}$ and $d = y_f - y_w$.\n  - For non-boundary faces (both adjacent cells fluid), use the baseline (manufactured) velocity sampled at the face center.\n\nTask:\n- Implement a program to:\n  1. Build the MAC grid for given $N$ and $R$.\n  2. Mark fluid versus solid cells using the circular obstacle.\n  3. Sample the manufactured divergence-free field at all faces to get baseline face velocities.\n  4. Replace face-normal velocities at boundary faces according to the specified scheme (\"zero\" or \"linear\").\n  5. Compute the discrete divergence in all near-wall cells and report the mean absolute divergence over near-wall cells.\n\nNumerical units and output:\n- All quantities are dimensionless. Report mean absolute divergence as floating-point numbers.\n- For each test case, output a single floating-point value equal to the mean of the absolute value of discrete divergence over near-wall cells. Round each reported value to $8$ decimal places.\n\nTest suite:\n- Use the following six test cases, each specified by the tuple $(N,R,\\text{scheme})$:\n  - $(32, 0.30, \\text{\"zero\"})$,\n  - $(32, 0.30, \\text{\"linear\"})$,\n  - $(64, 0.30, \\text{\"zero\"})$,\n  - $(64, 0.30, \\text{\"linear\"})$,\n  - $(64, 0.45, \\text{\"zero\"})$,\n  - $(64, 0.45, \\text{\"linear\"})$.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. The list elements must be the six rounded floating-point results in the same order as the test suite above. For example, an acceptable output format is\n- $[a_1,a_2,a_3,a_4,a_5,a_6]$,\nwhere each $a_k$ is a floating-point number rounded to $8$ decimal places.", "solution": "The solution is implemented by following these steps for each test case $(N, R, \\text{scheme})$.\n\n1.  **Grid and Geometry Definition**: An $N \\times N$ grid is established over the $[0,1] \\times [0,1]$ domain, with grid spacing $\\Delta x = \\Delta y = 1/N$. A boolean array, `is_solid`, of size $N \\times N$ is created. Each cell $(i,j)$ is marked as solid if its center lies within the circle of radius $R$ centered at $(0.5,0.5)$.\n\n2.  **Baseline Velocity Field Initialization**: Two arrays, `U_base` of size $(N+1) \\times N$ and `V_base` of size $N \\times (N+1)$, are populated with the values of the manufactured velocity field, $u(x,y) = -(y-0.5)$ and $v(x,y) = x-0.5$, sampled at the respective face centers. This baseline field has an analytical divergence of zero, and its discrete divergence on the MAC grid is also identically zero.\n\n3.  **Boundary Condition Enforcement**: Copies of the baseline velocity arrays, `U` and `V`, are created. These arrays are then modified at the boundary faces, which are faces separating a fluid cell from a solid cell.\n    -   For each such boundary face, the normal velocity is re-calculated based on the specified scheme.\n    -   **\"zero\" scheme**: The face-normal velocity is set to $0$.\n    -   **\"linear\" scheme**: The face-normal velocity $U_0$ is calculated as $U_0 = U_1 \\frac{d}{d+\\Delta}$. Here, $d$ is the distance from the face center to the wall, computed using the explicit (if simplified) formulas from the problem statement. $U_1$ is the velocity of the manufactured field at the next interior face, and $\\Delta$ is the grid spacing. This procedure is applied to all vertical ($u$) and horizontal ($v$) boundary faces.\n\n4.  **Divergence Calculation**: A list of \"near-wall\" fluid cells (fluid cells with at least one solid neighbor) is identified. For each cell in this list, the discrete divergence is calculated using the modified velocity fields `U` and `V`:\n    $$\n    (\\nabla_h \\cdot \\boldsymbol{u})_{i,j} = \\frac{U_{i+1,j} - U_{i,j}}{\\Delta x} + \\frac{V_{i,j+1} - V_{i,j}}{\\Delta y}\n    $$\n    where the indices on $U$ and $V$ correspond to the faces of cell $(i,j)$.\n\n5.  **Result Aggregation**: The absolute value of the computed divergence is taken for each near-wall cell. The mean of these absolute values is then calculated. This final value represents the average mass conservation error introduced by the boundary scheme for the given parameters. The process is repeated for all six test cases.\n\nThis procedure correctly quantifies the error introduced by each boundary condition scheme, as any non-zero divergence arises solely from the modifications made at the boundary faces.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print results.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (32, 0.30, \"zero\"),\n        (32, 0.30, \"linear\"),\n        (64, 0.30, \"zero\"),\n        (64, 0.30, \"linear\"),\n        (64, 0.45, \"zero\"),\n        (64, 0.45, \"linear\"),\n    ]\n\n    results = []\n    for N, R, scheme in test_cases:\n        result = run_simulation(N, R, scheme)\n        results.append(f\"{result:.8f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\ndef run_simulation(N, R, scheme):\n    \"\"\"\n    Performs the simulation for a single test case.\n\n    Args:\n        N (int): Grid resolution (N x N).\n        R (float): Radius of the circular obstacle.\n        scheme (str): Boundary condition scheme (\"zero\" or \"linear\").\n\n    Returns:\n        float: The mean absolute divergence over near-wall cells.\n    \"\"\"\n    # 1. Grid setup\n    dx = 1.0 / N\n    dy = 1.0 / N\n    cx, cy = 0.5, 0.5\n    omega = 1.0\n\n    # 2. Mark solid vs. fluid cells\n    # Cell centers are at ((i+0.5)*dx, (j+0.5)*dy)\n    cell_centers_x = (np.arange(N) + 0.5) * dx\n    cell_centers_y = (np.arange(N) + 0.5) * dy\n    is_solid = np.zeros((N, N), dtype=bool)\n    for i in range(N):\n        for j in range(N):\n            dist_sq = (cell_centers_x[i] - cx)**2 + (cell_centers_y[j] - cy)**2\n            if dist_sq < R**2:\n                is_solid[i, j] = True\n\n    # 3. Sample baseline manufactured velocity field\n    # U-velocities at vertical faces: (i*dx, (j+0.5)*dy) for i in 0..N, j in 0..N-1\n    U_base = np.zeros((N + 1, N))\n    u_face_y_coords = (np.arange(N) + 0.5) * dy\n    U_base[:, :] = -omega * (u_face_y_coords[np.newaxis, :] - cy)\n    \n    # V-velocities at horizontal faces: ((i+0.5)*dx, j*dy) for i in 0..N-1, j in 0..N\n    V_base = np.zeros((N, N + 1))\n    v_face_x_coords = (np.arange(N) + 0.5) * dx\n    V_base[:, :] = omega * (v_face_x_coords[:, np.newaxis] - cx)\n\n    # 4. Apply boundary conditions\n    U = np.copy(U_base)\n    V = np.copy(V_base)\n\n    # Modify U on vertical boundary faces\n    # Face U[i, j] is between cells (i-1, j) and (i, j)\n    for i in range(1, N): # Internal vertical faces only\n        for j in range(N):\n            is_left_solid = is_solid[i - 1, j]\n            is_right_solid = is_solid[i, j]\n\n            if is_left_solid != is_right_solid:\n                if scheme == 'zero':\n                    U[i, j] = 0.0\n                elif scheme == 'linear':\n                    xf = i * dx\n                    yf = (j + 0.5) * dy\n                    sqrt_arg = R**2 - (yf - cy)**2\n                    if sqrt_arg >= 0:\n                        sqrt_val = np.sqrt(sqrt_arg)\n                        if is_right_solid:\n                            # Formula as specified in the problem for solid on right\n                            xw = cx + sqrt_val\n                            d = xw - xf\n                            U1 = U_base[i - 1, j]\n                            U[i, j] = U1 * d / (d + dx) if (d + dx) > 1e-12 else 0.0\n                        else: # is_left_solid\n                            # Formula as specified for solid on left\n                            xw = cx - sqrt_val\n                            d = xf - xw\n                            U1 = U_base[i + 1, j]\n                            U[i, j] = U1 * d / (d + dx) if (d + dx) > 1e-12 else 0.0\n    \n    # Modify V on horizontal boundary faces\n    # Face V[i, j] is between cells (i, j-1) and (i, j)\n    for j in range(1, N): # Internal horizontal faces only\n        for i in range(N):\n            is_bottom_solid = is_solid[i, j - 1]\n            is_top_solid = is_solid[i, j]\n\n            if is_bottom_solid != is_top_solid:\n                if scheme == 'zero':\n                    V[i, j] = 0.0\n                elif scheme == 'linear':\n                    xf = (i + 0.5) * dx\n                    yf = j * dy\n                    # Using corrected formula (xf-cx) instead of (xf-cy) as per validation\n                    sqrt_arg = R**2 - (xf - cx)**2\n                    if sqrt_arg >= 0:\n                        sqrt_val = np.sqrt(sqrt_arg)\n                        if is_top_solid:\n                            yw = cy + sqrt_val\n                            d = yw - yf\n                            U1 = V_base[i, j - 1]\n                            V[i, j] = U1 * d / (d + dy) if (d + dy) > 1e-12 else 0.0\n                        else: # is_bottom_solid\n                            yw = cy - sqrt_val\n                            d = yf - yw\n                            U1 = V_base[i, j + 1]\n                            V[i, j] = U1 * d / (d + dy) if (d + dy) > 1e-12 else 0.0\n\n    # 5. Compute mean absolute divergence in near-wall cells\n    total_abs_div = 0.0\n    near_wall_cell_count = 0\n\n    for i in range(N):\n        for j in range(N):\n            if not is_solid[i, j]: # Must be a fluid cell\n                is_near_wall = False\n                if i > 0 and is_solid[i - 1, j]: is_near_wall = True\n                if not is_near_wall and i < N - 1 and is_solid[i + 1, j]: is_near_wall = True\n                if not is_near_wall and j > 0 and is_solid[i, j - 1]: is_near_wall = True\n                if not is_near_wall and j < N - 1 and is_solid[i, j + 1]: is_near_wall = True\n                \n                if is_near_wall:\n                    near_wall_cell_count += 1\n                    u_east = U[i + 1, j]\n                    u_west = U[i, j]\n                    v_north = V[i, j + 1]\n                    v_south = V[i, j]\n                    \n                    div = (u_east - u_west) / dx + (v_north - v_south) / dy\n                    total_abs_div += abs(div)\n\n    if near_wall_cell_count == 0:\n        return 0.0\n    \n    mean_abs_div = total_abs_div / near_wall_cell_count\n    return mean_abs_div\n\nif __name__ == '__main__':\n    solve()\n```", "id": "3346576"}]}