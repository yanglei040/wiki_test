{"hands_on_practices": [{"introduction": "The transition from the continuous differential form of the momentum equation to a discrete algebraic system is fraught with subtleties. The non-linear convective term, $\\nabla \\cdot (\\mathbf{u} \\otimes \\mathbf{u})$, is particularly challenging, as different discretization choices can lead to numerical schemes with vastly different conservation properties. This exercise [@problem_id:3335999] delves into the discrete analysis of several common approximations, forcing a critical evaluation of whether they conserve total momentum, kinetic energy, or neither, providing fundamental insights into the stability and accuracy of a numerical method.", "problem": "An incompressible, inviscid, constant-density flow with velocity field $\\mathbf{u}(\\mathbf{x},t)$ and pressure $p(\\mathbf{x},t)$ evolves under conservation of momentum. Consider the momentum equation in integral form over a control volume $\\mathcal{V}$ with boundary $\\partial\\mathcal{V}$ and outward unit normal $\\mathbf{n}$, and in differential form in a periodic box $\\Omega$:\n- Integral form: the rate of change of momentum in $\\mathcal{V}$ equals the net flux of momentum through $\\partial\\mathcal{V}$ plus surface forces.\n- Differential form: $\\partial_t \\mathbf{u} + \\nabla \\cdot (\\mathbf{u}\\otimes \\mathbf{u}) + \\nabla p = \\mathbf{0}$, with $\\nabla \\cdot \\mathbf{u} = 0$.\n\nA semi-discrete spatial approximation is constructed on a uniform, periodic, Cartesian grid that is consistent with these laws as follows:\n- The grid has spacings $\\Delta x$, $\\Delta y$, $\\Delta z$ and cell volume $\\Delta V = \\Delta x\\,\\Delta y\\,\\Delta z$. Vectors are stored at cell centers. The discrete inner product is $\\langle \\mathbf{a}, \\mathbf{b} \\rangle_h = \\sum_{\\text{cells}} \\mathbf{a}\\cdot\\mathbf{b}\\,\\Delta V$ and the corresponding discrete norm is $\\|\\mathbf{a}\\|_h^2 = \\langle \\mathbf{a}, \\mathbf{a} \\rangle_h$.\n- Let $D_\\ell$ denote the centered finite-difference derivative in direction $\\ell \\in \\{x,y,z\\}$, assembled into the discrete gradient $\\nabla_h = (D_x,D_y,D_z)$ and discrete divergence $\\nabla_h\\cdot$. Assume periodic boundaries and that the centered differences satisfy discrete summation by parts: for scalar grid functions $\\phi$ and $\\psi$, $\\langle \\phi, D_\\ell \\psi \\rangle_h = - \\langle D_\\ell \\phi, \\psi \\rangle_h$.\n- The discrete pressure is used to enforce discrete incompressibility $\\nabla_h \\cdot \\mathbf{u} = 0$ at all times. With periodic boundaries, the pressure gradient does no net work in the discrete kinetic energy balance.\n\nThree alternative semi-discrete convective operators are considered:\n- Central conservative (flux) form: $N_c(\\mathbf{u}) = \\nabla_h \\cdot (\\mathbf{u}\\otimes \\mathbf{u})$, assembled from centered flux differences consistent with $D_\\ell$ so that fluxes strictly telescope across faces in the grid.\n- Upwind flux form: $N_u(\\mathbf{u})$ uses a standard upwind bias in constructing the face fluxes of $\\mathbf{u}\\otimes \\mathbf{u}$, and can be written as $N_u(\\mathbf{u}) = N_c(\\mathbf{u}) - \\mathcal{D}(\\mathbf{u})$ where $\\mathcal{D}(\\mathbf{u})$ is a consistent numerical dissipation term that is symmetric and nonnegative in the discrete inner product in the sense that $\\langle \\mathbf{v}, \\mathcal{D}(\\mathbf{v}) \\rangle_h \\ge 0$ for any grid velocity $\\mathbf{v}$.\n- Skew-symmetric split form: $N_s(\\mathbf{u}) = \\tfrac{1}{2}\\big[(\\mathbf{u}\\cdot \\nabla_h)\\mathbf{u} + \\nabla_h \\cdot (\\mathbf{u}\\otimes \\mathbf{u})\\big]$, where $(\\mathbf{u}\\cdot \\nabla_h)\\mathbf{u}$ is built from centered differences and pointwise products.\n\nAssume time integration is exact (so only spatial discretization is considered), and that the discrete incompressibility constraint $\\nabla_h\\cdot\\mathbf{u} = 0$ holds for all $t$.\n\nSelect all statements that are correct about the discrete total momentum $\\mathbf{P}_h(t) = \\sum_{\\text{cells}} \\mathbf{u}\\,\\Delta V$ and the discrete total kinetic energy $K_h(t) = \\tfrac{1}{2}\\|\\mathbf{u}\\|_h^2$ under the three convective discretizations described:\n\nA. With periodic boundaries and centered differences satisfying discrete summation by parts, the skew-symmetric convective discretization $N_s(\\mathbf{u})$ produces exactly zero discrete kinetic energy change due to convection for any discretely divergence-free velocity field; that is, $\\langle \\mathbf{u}, N_s(\\mathbf{u}) \\rangle_h = 0$.\n\nB. The central conservative flux-difference form $N_c(\\mathbf{u})$ is exactly conservative of discrete total momentum for periodic boundaries, but it generally does not conserve discrete kinetic energy for arbitrary discretely divergence-free velocity fields because the discrete product rule does not hold exactly.\n\nC. For standard first-order upwind fluxes, the convective term’s contribution to the time derivative of discrete kinetic energy is non-positive for any velocity field; that is, $\\langle \\mathbf{u}, N_u(\\mathbf{u}) \\rangle_h \\le 0$, with strict negativity unless the flow is locally uniform.\n\nD. Any convective discretization that exactly conserves discrete total kinetic energy on a periodic grid must also exactly conserve discrete total momentum on the same grid.\n\nE. The skew-symmetric split form $N_s(\\mathbf{u})$ is automatically exactly conservative of discrete total momentum on periodic grids even when it is not written in a strict flux-difference (finite-volume) form.", "solution": "The user wants a critical analysis of a problem concerning conservation properties of different numerical schemes for the incompressible Euler equations.\n\n### Problem Validation\n\nThe problem statement is examined for validity.\n\n**Step 1: Extract Givens**\n- **Continuum Model**: Incompressible, inviscid, constant-density flow, velocity $\\mathbf{u}(\\mathbf{x}, t)$, pressure $p(\\mathbf{x}, t)$, momentum equation $\\partial_t \\mathbf{u} + \\nabla \\cdot (\\mathbf{u}\\otimes \\mathbf{u}) + \\nabla p = \\mathbf{0}$, incompressibility $\\nabla \\cdot \\mathbf{u} = 0$. The domain is a periodic box $\\Omega$.\n- **Discrete Setting**: Uniform periodic Cartesian grid with spacings $\\Delta x, \\Delta y, \\Delta z$ and cell volume $\\Delta V$.\n- **Discrete Inner Product**: $\\langle \\mathbf{a}, \\mathbf{b} \\rangle_h = \\sum_{\\text{cells}} \\mathbf{a}\\cdot\\mathbf{b}\\,\\Delta V$. Discrete norm is $\\|\\mathbf{a}\\|_h^2 = \\langle \\mathbf{a}, \\mathbf{a} \\rangle_h$.\n- **Discrete Operators**: Centered finite-difference derivative $D_\\ell$ for $\\ell \\in \\{x,y,z\\}$. Discrete gradient $\\nabla_h = (D_x,D_y,D_z)$ and divergence $\\nabla_h\\cdot$.\n- **Operator Properties**: The operators satisfy discrete summation by parts (SBP) on the periodic grid: $\\langle \\phi, D_\\ell \\psi \\rangle_h = - \\langle D_\\ell \\phi, \\psi \\rangle_h$.\n- **Discrete Constraints**: Discrete incompressibility $\\nabla_h \\cdot \\mathbf{u} = 0$ is maintained. The discrete pressure gradient is energy-orthogonal: $\\langle \\mathbf{v}, \\nabla_h p \\rangle_h = 0$ for any discretely divergence-free field $\\mathbf{v}$.\n- **Convective Operators**:\n    1. Central conservative: $N_c(\\mathbf{u}) = \\nabla_h \\cdot (\\mathbf{u}\\otimes \\mathbf{u})$, a telescoping flux-difference form.\n    2. Upwind flux: $N_u(\\mathbf{u}) = N_c(\\mathbf{u}) - \\mathcal{D}(\\mathbf{u})$, where $\\mathcal{D}(\\mathbf{u})$ is a symmetric non-negative dissipation operator, $\\langle \\mathbf{v}, \\mathcal{D}(\\mathbf{v}) \\rangle_h \\ge 0$.\n    3. Skew-symmetric: $N_s(\\mathbf{u}) = \\tfrac{1}{2}\\big[(\\mathbf{u}\\cdot \\nabla_h)\\mathbf{u} + \\nabla_h \\cdot (\\mathbf{u}\\otimes \\mathbf{u})\\big]$.\n- **Quantities of Interest**: Discrete total momentum $\\mathbf{P}_h(t) = \\sum_{\\text{cells}} \\mathbf{u}\\,\\Delta V$ and discrete total kinetic energy $K_h(t) = \\tfrac{1}{2}\\|\\mathbf{u}\\|_h^2$.\n\n**Step 2: Validate Using Extracted Givens**\n- **Scientifically Grounded**: Yes. The problem is rooted in the numerical analysis of partial differential equations, specifically the Euler equations, a core topic in computational fluid dynamics. The concepts (SBP, flux forms, conservation) are fundamental.\n- **Well-Posed**: Yes. The problem defines all operators and quantities with sufficient mathematical precision to allow for a rigorous evaluation of the given statements.\n- **Objective**: Yes. The language is formal and devoid of subjective claims.\n- **Completeness and Consistency**: Yes. The problem provides a self-contained framework for the analysis.\n- **Realism**: Yes. The formulations are standard in CFD literature and practice.\n- **Structure**: Yes. The problem is well-structured and not ill-posed.\n\n**Step 3: Verdict and Action**\nThe problem is valid. A rigorous derivation and evaluation may proceed.\n\n### Derivation and Analysis\n\nThe semi-discrete momentum equation is $\\partial_t \\mathbf{u} + N(\\mathbf{u}) + \\nabla_h p = \\mathbf{0}$, where $N(\\mathbf{u})$ is one of the three convective operators. We analyze the conservation of discrete total momentum $\\mathbf{P}_h$ and discrete total kinetic energy $K_h$.\n\n**1. Conservation of Discrete Total Momentum**\n\nThe time derivative of the total momentum vector $\\mathbf{P}_h(t) = \\sum_{\\text{cells}} \\mathbf{u}\\,\\Delta V$ is:\n$$ \\frac{d\\mathbf{P}_h}{dt} = \\sum_{\\text{cells}} (\\partial_t \\mathbf{u}) \\Delta V = \\sum_{\\text{cells}} (-N(\\mathbf{u}) - \\nabla_h p) \\Delta V = - \\sum_{\\text{cells}} N(\\mathbf{u}) \\Delta V - \\sum_{\\text{cells}} \\nabla_h p \\Delta V $$\nFor a centered difference operator on a periodic grid, the sum of derivatives of any grid function is zero (a telescoping sum). Thus, $\\sum_{\\text{cells}} \\nabla_h p \\Delta V = \\mathbf{0}$.\nMomentum is conserved if and only if $\\sum_{\\text{cells}} N(\\mathbf{u}) \\Delta V = \\mathbf{0}$. This property holds if the operator $N(\\mathbf{u})$ can be written as a discrete divergence of a flux tensor, as the sum will telescope to zero over the periodic domain.\n\n- **$N_c(\\mathbf{u})$ and $N_u(\\mathbf{u})$**: Both are defined as being in a \"flux-difference\" or \"flux\" form. $N_c(\\mathbf{u}) = \\nabla_h \\cdot (\\mathbf{u}\\otimes \\mathbf{u})$ is explicitly a discrete divergence. A standard upwind scheme $N_u(\\mathbf{u})$ is also constructed in a flux-difference form. Therefore, $\\sum N_c(\\mathbf{u}) \\Delta V = \\mathbf{0}$ and $\\sum N_u(\\mathbf{u}) \\Delta V = \\mathbf{0}$. Both operators conserve total momentum.\n\n- **$N_s(\\mathbf{u})$**: $N_s(\\mathbf{u}) = \\tfrac{1}{2}\\big[(\\mathbf{u}\\cdot \\nabla_h)\\mathbf{u} + \\nabla_h \\cdot (\\mathbf{u}\\otimes \\mathbf{u})\\big]$.\nThe sum over the domain is:\n$$ \\sum_{\\text{cells}} N_s(\\mathbf{u}) \\Delta V = \\frac{1}{2} \\sum_{\\text{cells}} (\\mathbf{u}\\cdot \\nabla_h)\\mathbf{u} \\Delta V + \\frac{1}{2} \\sum_{\\text{cells}} \\nabla_h \\cdot (\\mathbf{u}\\otimes \\mathbf{u}) \\Delta V $$\nThe second term is zero, as it is a divergence form. The first term, $\\sum (\\mathbf{u}\\cdot \\nabla_h)\\mathbf{u} \\Delta V$, is not in a divergence form and is not generally zero. Thus, $N_s(\\mathbf{u})$ does not conserve total momentum.\n\n**2. Conservation of Discrete Kinetic Energy**\n\nThe time derivative of the total kinetic energy $K_h(t) = \\tfrac{1}{2} \\langle \\mathbf{u}, \\mathbf{u} \\rangle_h$ is:\n$$ \\frac{dK_h}{dt} = \\langle \\mathbf{u}, \\partial_t \\mathbf{u} \\rangle_h = \\langle \\mathbf{u}, -N(\\mathbf{u}) - \\nabla_h p \\rangle_h = -\\langle \\mathbf{u}, N(\\mathbf{u}) \\rangle_h - \\langle \\mathbf{u}, \\nabla_h p \\rangle_h $$\nThe pressure term's contribution is zero. Using SBP and the incompressibility condition:\n$$ \\langle \\mathbf{u}, \\nabla_h p \\rangle_h = - \\langle \\nabla_h \\cdot \\mathbf{u}, p \\rangle_h = - \\langle 0, p \\rangle_h = 0 $$\nKinetic energy is conserved if and only if $\\langle \\mathbf{u}, N(\\mathbf{u}) \\rangle_h = 0$. The operator $N(\\mathbf{u})$ must be skew-symmetric with respect to the discrete inner product.\n\n- **$N_s(\\mathbf{u})$**: We evaluate $\\langle \\mathbf{u}, N_s(\\mathbf{u}) \\rangle_h$. Let $A(\\mathbf{u}) = (\\mathbf{u}\\cdot \\nabla_h)\\mathbf{u}$ and $C(\\mathbf{u}) = \\nabla_h \\cdot (\\mathbf{u}\\otimes \\mathbf{u})$.\n$$ \\langle \\mathbf{u}, N_s(\\mathbf{u}) \\rangle_h = \\frac{1}{2} \\left[ \\langle \\mathbf{u}, A(\\mathbf{u}) \\rangle_h + \\langle \\mathbf{u}, C(\\mathbf{u}) \\rangle_h \\right] $$\nLet us analyze the two terms. For any vector fields $\\mathbf{v}$ and $\\mathbf{w}$ and the discretely divergence-free field $\\mathbf{u}$ ($\\nabla_h \\cdot \\mathbf{u} = 0$), we can use SBP:\n$$ \\langle \\mathbf{v}, \\nabla_h \\cdot (\\mathbf{u} \\otimes \\mathbf{w}) \\rangle_h = \\sum_{i} \\langle v_i, \\sum_j D_j (u_j w_i) \\rangle_h = \\sum_{i} \\sum_j -\\langle D_j v_i, u_j w_i \\rangle_h $$\n$$ = -\\sum_{i} \\langle w_i, \\sum_j u_j D_j v_i \\rangle_h = -\\langle \\mathbf{w}, (\\mathbf{u} \\cdot \\nabla_h)\\mathbf{v} \\rangle_h $$\nThis identity shows that the group of operators $(\\cdot \\cdot \\nabla_h)\\cdot$ and $\\nabla_h \\cdot (\\cdot \\otimes \\cdot)$ are skew-adjoint under the inner product when the advecting field is divergence-free. Setting $\\mathbf{v}=\\mathbf{w}=\\mathbf{u}$, we get:\n$$ \\langle \\mathbf{u}, \\nabla_h \\cdot (\\mathbf{u} \\otimes \\mathbf{u}) \\rangle_h = -\\langle \\mathbf{u}, (\\mathbf{u} \\cdot \\nabla_h)\\mathbf{u} \\rangle_h \\implies \\langle \\mathbf{u}, C(\\mathbf{u}) \\rangle_h = -\\langle \\mathbf{u}, A(\\mathbf{u}) \\rangle_h $$\nSubstituting this into the energy expression for $N_s(\\mathbf{u})$:\n$$ \\langle \\mathbf{u}, N_s(\\mathbf{u}) \\rangle_h = \\frac{1}{2} \\left[ \\langle \\mathbf{u}, A(\\mathbf{u}) \\rangle_h - \\langle \\mathbf{u}, A(\\mathbf{u}) \\rangle_h \\right] = 0 $$\nThus, $N_s(\\mathbf{u})$ conserves kinetic energy.\n\n- **$N_c(\\mathbf{u})$**: Energy conservation requires $\\langle \\mathbf{u}, N_c(\\mathbf{u}) \\rangle_h = 0$. From the above derivation, $\\langle \\mathbf{u}, N_c(\\mathbf{u}) \\rangle_h = -\\langle \\mathbf{u}, (\\mathbf{u} \\cdot \\nabla_h)\\mathbf{u} \\rangle_h$. This is not zero in general. The reason lies in the fact that discrete chain/product rules for centered differences do not perfectly mimic their continuum counterparts, leading to aliasing errors that manifest as unphysical energy production or decay.\n\n- **$N_u(\\mathbf{u})$**: The contribution of the convective term to the energy derivative is $-\\langle \\mathbf{u}, N_u(\\mathbf{u}) \\rangle_h$.\n$$ -\\langle \\mathbf{u}, N_u(\\mathbf{u}) \\rangle_h = -\\langle \\mathbf{u}, N_c(\\mathbf{u}) - \\mathcal{D}(\\mathbf{u}) \\rangle_h = -\\langle \\mathbf{u}, N_c(\\mathbf{u}) \\rangle_h + \\langle \\mathbf{u}, \\mathcal{D}(\\mathbf{u}) \\rangle_h $$\n\"Standard first-order upwind fluxes\" are known to be numerically dissipative, meaning they cause a net decay of kinetic energy. This property is by design to ensure stability. This implies that the total energy change rate must be non-positive: $\\frac{dK_h}{dt} = -\\langle \\mathbf{u}, N_u(\\mathbf{u}) \\rangle_h \\le 0$. This is equivalent to the condition $\\langle \\mathbf{u}, N_u(\\mathbf{u}) \\rangle_h \\ge 0$. While the term $-\\langle \\mathbf{u}, N_c(\\mathbf{u}) \\rangle_h$ can have any sign, the dissipation term $\\langle \\mathbf{u}, \\mathcal{D}(\\mathbf{u}) \\rangle_h \\ge 0$ is constructed to be large enough to dominate and ensure overall dissipation. The dissipation is zero only for a uniform flow field, where all gradients vanish.\n\n### Option-by-Option Analysis\n\n**A. With periodic boundaries and centered differences satisfying discrete summation by parts, the skew-symmetric convective discretization $N_s(\\mathbf{u})$ produces exactly zero discrete kinetic energy change due to convection for any discretely divergence-free velocity field; that is, $\\langle \\mathbf{u}, N_s(\\mathbf{u}) \\rangle_h = 0$.**\nAs derived above, SBP and the discrete incompressibility condition directly lead to $\\langle \\mathbf{u}, N_s(\\mathbf{u}) \\rangle_h = 0$.\n**Verdict: Correct.**\n\n**B. The central conservative flux-difference form $N_c(\\mathbf{u})$ is exactly conservative of discrete total momentum for periodic boundaries, but it generally does not conserve discrete kinetic energy for arbitrary discretely divergence-free velocity fields because the discrete product rule does not hold exactly.**\nThe first part is correct: as a flux-difference (divergence) form, its sum over a periodic domain is zero, conserving momentum. The second part is also correct: $\\langle \\mathbf{u}, N_c(\\mathbf{u}) \\rangle_h \\neq 0$ due to aliasing errors, which can be attributed to the failure of discrete operators to satisfy continuum product/chain rules. This is why the skew-symmetric form is needed for energy conservation.\n**Verdict: Correct.**\n\n**C. For standard first-order upwind fluxes, the convective term’s contribution to the time derivative of discrete kinetic energy is non-positive for any velocity field; that is, $\\langle \\mathbf{u}, N_u(\\mathbf{u}) \\rangle_h \\le 0$, with strict negativity unless the flow is locally uniform.**\nThe contribution to the time derivative of kinetic energy is $-\\langle \\mathbf{u}, N_u(\\mathbf{u}) \\rangle_h$. The statement claims this is $\\le 0$, which is equivalent to $\\langle \\mathbf{u}, N_u(\\mathbf{u}) \\rangle_h \\ge 0$. This is the mathematical definition of a dissipative scheme for this PDE. Standard first-order upwind schemes are constructed to be dissipative for stability. The dissipation vanishes for uniform flow. The statement is a correct description of the behavior of upwind schemes.\n**Verdict: Correct.**\n\n**D. Any convective discretization that exactly conserves discrete total kinetic energy on a periodic grid must also exactly conserve discrete total momentum on the same grid.**\nThis is a false implication. The skew-symmetric operator $N_s(\\mathbf{u})$ is a direct counterexample. As shown, it conserves kinetic energy ($\\langle \\mathbf{u}, N_s(\\mathbf{u}) \\rangle_h = 0$) but does not conserve total momentum ($\\sum N_s(\\mathbf{u}) \\Delta V \\neq \\mathbf{0}$).\n**Verdict: Incorrect.**\n\n**E. The skew-symmetric split form $N_s(\\mathbf{u})$ is automatically exactly conservative of discrete total momentum on periodic grids even when it is not written in a strict flux-difference (finite-volume) form.**\nThis statement is false. As shown in the momentum analysis, $N_s(\\mathbf{u})$ contains the term $(\\mathbf{u}\\cdot \\nabla_h)\\mathbf{u}$ which is not in a divergence form and does not sum to zero over the domain. Therefore, $N_s(\\mathbf{u})$ does not conserve total momentum.\n**Verdict: Incorrect.**", "answer": "$$\\boxed{ABC}$$", "id": "3335999"}, {"introduction": "When moving beyond idealized flows, we must account for source terms like gravity, which are crucial in many real-world applications. A key challenge is ensuring that the numerical discretization of the source term is consistent with the discretization of the flux divergence, a property known as a 'well-balanced' scheme. This hands-on coding practice [@problem_id:3335974] demonstrates how an inconsistent treatment can generate spurious momentum, violating the integral balance even in a simple hydrostatic state, and guides you to implement a robust fix that is essential for accurate geophysical and astrophysical simulations.", "problem": "Consider a one-dimensional vertical column of fluid of height $H$ and cross-sectional area $A$, aligned with the vertical coordinate $z$ that increases upward. Let gravity be represented by the body force density $\\rho \\mathbf{g}$ with $\\mathbf{g} = -g(z)\\,\\hat{\\mathbf{z}}$, where $g(z) \\ge 0$ is the gravitational acceleration magnitude, potentially dependent on $z$. Assume no motion ($\\mathbf{u} = \\mathbf{0}$) and consider hydrostatic conditions. The integral form of momentum conservation for a stationary control volume states that the sum of the surface forces and body forces is zero. In this setting, the only surface force is pressure, and the only body force is gravity.\n\nStarting from Newton's second law and the integral form of momentum conservation, derive the discrete residual of the vertical momentum balance for the entire column in terms of pressures at the top and bottom faces and the column-wise integral of the gravitational body force. Then design and implement a finite-volume benchmark that demonstrates how an inconsistent discrete treatment of gravity $\\rho \\mathbf{g}$ in hydrostatic balance causes a nonzero net residual (spurious momentum) in the integral sense, and propose a pressure-based fix that restores exact discrete hydrostatic balance.\n\nYour benchmark must adhere to the following specifications:\n\n- Fundamental base:\n  - Use Newton's second law and the integral form of momentum conservation to reason about the stationary hydrostatic column.\n  - Define $z$-component outward unit normals on the top and bottom faces, and use these to write the $z$-component of the pressure contribution.\n  - Use physically consistent definitions for $\\rho(z)$, $p(z)$, and $g(z)$ in hydrostatic equilibrium.\n- Geometry and discretization:\n  - Use a uniform grid with $N$ control volumes of equal thickness $\\Delta z = H/N$, with cell centers at $z_i = \\left(i + \\tfrac{1}{2}\\right)\\Delta z$ for $i = 0,1,\\dots,N-1$.\n  - Use cross-sectional area $A = 1$ to report forces in Newtons ($\\mathrm{N}$) without additional scaling.\n- Two discrete treatments to be compared:\n  1. A \"naive\" discrete treatment in which the net surface pressure force uses continuous hydrostatic boundary pressures $p_{\\mathrm{top}}$ and $p_{\\mathrm{bot}}$ evaluated from the continuous hydrostatic solution at $z=H$ and $z=0$, while the body force is approximated by the midpoint rule $\\sum_{i=0}^{N-1} \\rho_i\\,g_i\\,\\Delta z$ with $\\rho_i$ and $g_i$ evaluated at cell centers. This produces a discrete residual because the two sides of the hydrostatic balance are evaluated with different quadrature.\n  2. A \"pressure-based fix\" that constructs a discrete hydrostatic face pressure field $\\{p_{i+\\tfrac{1}{2}}\\}$ such that the discrete pressure difference across each cell exactly balances the discrete gravitational body force in that cell, thereby ensuring that the net integral momentum residual across the entire column is identically zero in the discrete sense for hydrostatic data. Use the given top boundary pressure $p_{\\mathrm{top}}$ and a discrete recursion consistent with the gravitational source to compute $p_{\\mathrm{bot}}$; then evaluate the net residual for the whole column using these discrete hydrostatic face pressures.\n- Physics specifications for test cases:\n  - Isothermal ideal gas: For constant temperature $T$, ideal gas constant $R$, and constant $g$, use $\\rho(z) = \\rho_0 \\exp\\!\\left(-\\frac{z}{H_s}\\right)$ and $p(z) = p_0 \\exp\\!\\left(-\\frac{z}{H_s}\\right)$, where $H_s = \\frac{R T}{g}$, $p_0$ is the bottom pressure at $z=0$, and $\\rho_0 = \\frac{p_0}{R T}$.\n  - Isothermal ideal gas with vertically varying gravity $g(z) = g_0\\left(1 - \\alpha z\\right)$ for small $\\alpha$; then $\\ln\\!\\left(\\frac{p(H)}{p(0)}\\right) = -\\frac{1}{R T}\\int_0^H g(z)\\,\\mathrm{d}z$ must be used to provide a physically consistent top boundary pressure $p_{\\mathrm{top}}$ from $p_0$.\n- Units:\n  - All input physical quantities must be in SI units: $H$ in meters ($\\mathrm{m}$), $g$ in meters per second squared ($\\mathrm{m/s^2}$), $R$ in joules per kilogram per kelvin ($\\mathrm{J/(kg\\,K)}$), $T$ in kelvin ($\\mathrm{K}$), $p$ in pascals ($\\mathrm{Pa}$), $\\rho$ in kilograms per cubic meter ($\\mathrm{kg/m^3}$), and forces in Newtons ($\\mathrm{N}$).\n- Numerical tasks to implement:\n  - For each test case, construct the hydrostatic $\\rho_i$ and $p_{\\mathrm{top}}$ appropriate to that case.\n  - Compute the net integral momentum residual $R_{\\mathrm{naive}}$ for the \"naive\" treatment as the difference of the net surface pressure force and the discrete gravitational body force.\n  - Construct the discrete hydrostatic face pressures consistent with the body force quadrature and compute the net residual $R_{\\mathrm{fix}}$.\n  - Report both residuals in Newtons ($\\mathrm{N}$).\n- Test suite:\n  - Case $1$ (happy path): Isothermal ideal gas with constant gravity and moderate resolution.\n    - Parameters: $H = 1000\\,\\mathrm{m}$, $N = 10$, $g = 9.81\\,\\mathrm{m/s^2}$, $T = 300\\,\\mathrm{K}$, $R = 287\\,\\mathrm{J/(kg\\,K)}$, $p_0 = 101325\\,\\mathrm{Pa}$.\n  - Case $2$ (coarse resolution): Same physics as Case $1$ but very coarse grid.\n    - Parameters: $H = 1000\\,\\mathrm{m}$, $N = 2$, $g = 9.81\\,\\mathrm{m/s^2}$, $T = 300\\,\\mathrm{K}$, $R = 287\\,\\mathrm{J/(kg\\,K)}$, $p_0 = 101325\\,\\mathrm{Pa}$.\n  - Case $3$ (extreme coarse edge case): Same physics as Case $1$ but with $N = 1$ cell.\n    - Parameters: $H = 1000\\,\\mathrm{m}$, $N = 1$, $g = 9.81\\,\\mathrm{m/s^2}$, $T = 300\\,\\mathrm{K}$, $R = 287\\,\\mathrm{J/(kg\\,K)}$, $p_0 = 101325\\,\\mathrm{Pa}$.\n  - Case $4$ (variable gravity): Isothermal ideal gas with gravity decreasing linearly with altitude.\n    - Parameters: $H = 2000\\,\\mathrm{m}$, $N = 20$, $g_0 = 9.81\\,\\mathrm{m/s^2}$, $\\alpha = 10^{-5}\\,\\mathrm{m^{-1}}$, $T = 300\\,\\mathrm{K}$, $R = 287\\,\\mathrm{J/(kg\\,K)}$, $p_0 = 101325\\,\\mathrm{Pa}$.\n- Final output format:\n  - Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. For each test case, output a two-element list $[R_{\\mathrm{naive}}, R_{\\mathrm{fix}}]$ in Newtons ($\\mathrm{N}$). Aggregate these per-case lists into a single list. For example, the output should look like $[[r_1^{\\mathrm{naive}}, r_1^{\\mathrm{fix}}],[r_2^{\\mathrm{naive}}, r_2^{\\mathrm{fix}}],\\dots]$ where each $r$ is a floating-point number representing Newtons ($\\mathrm{N}$).", "solution": "The problem requires the derivation and implementation of a numerical benchmark to demonstrate the importance of a \"well-balanced\" discretization for hydrostatic problems in computational fluid dynamics. We must compare a \"naive\" finite-volume discretization, which produces a spurious net force due to inconsistent numerical approximations, against a \"pressure-based fix\" that guarantees discrete hydrostatic balance.\n\n### 1. Continuous Integral Momentum Balance\n\nWe begin with the integral form of the momentum conservation law for a control volume $V$ with surface $S$. For a fluid with density $\\rho$, velocity $\\mathbf{u}$, and pressure $p$, under a body force density $\\mathbf{f}_b$, Newton's second law is:\n$$\n\\frac{d}{dt}\\int_V \\rho \\mathbf{u} \\, dV = \\oint_S (-p \\mathbf{n}) \\, dS + \\int_V \\mathbf{f}_b \\, dV\n$$\nwhere $\\mathbf{n}$ is the outward-pointing unit normal on the surface $S$.\n\nFor the specified one-dimensional vertical column of fluid at rest ($\\mathbf{u} = \\mathbf{0}$) under gravity, the problem is one of hydrostatic equilibrium. The time derivative vanishes. The body force is $\\mathbf{f}_b = \\rho \\mathbf{g}$, where $\\mathbf{g} = -g(z) \\hat{\\mathbf{z}}$. We consider the vertical ($\\hat{\\mathbf{z}}$) component of the momentum equation. The control volume is the entire column, from $z=0$ to $z=H$, with a constant cross-sectional area $A$.\n\nThe surface integral has contributions only from the top face ($S_{\\text{top}}$ at $z=H$) and the bottom face ($S_{\\text{bot}}$ at $z=0$), as contributions from the side walls cancel due to symmetry or have normals orthogonal to $\\hat{\\mathbf{z}}$.\n- On $S_{\\text{top}}$: $\\mathbf{n} = \\hat{\\mathbf{z}}$, so the pressure force component is $\\int_{S_{\\text{top}}} (-p \\hat{\\mathbf{z}}) \\cdot \\hat{\\mathbf{z}} \\, dS = -p(H) A$.\n- On $S_{\\text{bot}}$: $\\mathbf{n} = -\\hat{\\mathbf{z}}$, so the pressure force component is $\\int_{S_{\\text{bot}}} (-p (-\\hat{\\mathbf{z}})) \\cdot \\hat{\\mathbf{z}} \\, dS = p(0) A$.\n\nThe net surface force in the $z$-direction is $F_{S,z} = A(p(0) - p(H))$.\n\nThe total body force in the $z$-direction is the volume integral of the $z$-component of $\\rho \\mathbf{g}$:\n$$\nF_{B,z} = \\int_V (\\rho \\mathbf{g}) \\cdot \\hat{\\mathbf{z}} \\, dV = \\int_0^H \\int_A \\rho(z)(-g(z)) \\, dA \\, dz = -A \\int_0^H \\rho(z) g(z) \\, dz\n$$\nThe integral momentum balance equation is the sum of forces, which must be zero for equilibrium:\n$$\nF_{S,z} + F_{B,z} = 0 \\implies A(p(0) - p(H)) - A \\int_0^H \\rho(z) g(z) \\, dz = 0\n$$\nDividing by $A$ and rearranging gives the familiar hydrostatic relation: $p(0) - p(H) = \\int_0^H \\rho(z) g(z) \\, dz$. The net force, or residual, on the continuous system is identically zero.\n\n### 2. Finite-Volume Discretization\n\nThe column of height $H$ is discretized into $N$ uniform control volumes (cells), indexed $i = 0, 1, \\dots, N-1$. Each cell has thickness $\\Delta z = H/N$. The $i$-th cell occupies the spatial domain $[i\\Delta z, (i+1)\\Delta z]$ and has its center at $z_i = (i + \\frac{1}{2})\\Delta z$. The problem sets the cross-sectional area to $A=1$ for simplicity, so forces are numerically equal to pressure differences or integrated source terms.\n\nThe discrete form of the momentum balance for the entire column is an approximation of the continuous integral form. The net residual, $R_{\\text{discrete}}$, is the sum of the discretized surface and body forces.\n$$\nR_{\\text{discrete}} = F_{S,z}^{\\text{discrete}} + F_{B,z}^{\\text{discrete}}\n$$\n\n### 3. The \"Naive\" Discrete Treatment\n\nThe \"naive\" approach inconsistently mixes continuous and discrete representations.\n- **Surface Force:** The net surface force is evaluated using the exact, continuous hydrostatic pressures at the domain boundaries: $p_{\\text{bot}} = p(0)$ and $p_{\\text{top}} = p(H)$.\n  $$\n  F_{S,z}^{\\text{naive}} = p(0) - p(H) = \\int_0^H \\rho(z) g(z) \\, dz\n  $$\n- **Body Force:** The total body force is approximated by summing the contributions from each cell. The integral over each cell is approximated using the midpoint rule, with density and gravity evaluated at the cell center $z_i$.\n  $$\n  F_{B,z}^{\\text{naive}} = \\sum_{i=0}^{N-1} \\left( -\\int_{i\\Delta z}^{(i+1)\\Delta z} \\rho(z) g(z) \\, dz \\right) \\approx \\sum_{i=0}^{N-1} \\left( - \\rho(z_i)g(z_i) \\Delta z \\right) = - \\sum_{i=0}^{N-1} \\rho_i g_i \\Delta z\n  $$\nThe naive residual, $R_{\\text{naive}}$, is the sum of these two terms:\n$$\nR_{\\text{naive}} = \\left( p(0) - p(H) \\right) - \\sum_{i=0}^{N-1} \\rho_i g_i \\Delta z = \\int_0^H \\rho(z) g(z) \\, dz - \\sum_{i=0}^{N-1} \\rho_i g_i \\Delta z\n$$\nThis residual is precisely the global quadrature error of the midpoint rule for the integral $\\int_0^H \\rho(z) g(z) \\, dz$. Unless $\\rho(z)g(z)$ is a linear function of $z$ (which is not the case for an ideal gas in a gravitational field), this error is non-zero. This non-zero net force is a numerical artifact, or \"spurious momentum,\" that can corrupt a dynamic simulation.\n\n### 4. The \"Pressure-Based Fix\" (Well-Balanced Approach)\n\nThis approach enforces discrete hydrostatic balance at the level of a single control volume. For cell $i$, the pressure force on its faces must exactly balance the discrete body force within it. Let $p_{f,i}$ be the pressure at the face at $z = i\\Delta z$. The balance for cell $i$ is:\n$$\n(p_{f,i} - p_{f,i+1}) - \\rho_i g_i \\Delta z = 0\n$$\nThis establishes a relationship between the discrete pressure gradient and the discrete source term, ensuring they are modeled consistently. This equation can be written as a recursion for the face pressures:\n$$\np_{f,i} = p_{f,i+1} + \\rho_i g_i \\Delta z\n$$\nTo construct the full field of face pressures $\\{p_{f,j}\\}_{j=0}^N$, we start with a boundary condition. Following the problem, we set the pressure at the top face, $p_{f,N}$, to the continuous value $p(H)$. We then recurse downward from $i=N-1$ to $i=0$ to find all face pressures, culminating in the discrete bottom pressure, $p_{f,0}$.\n\nThe net residual for this \"fixed\" scheme, $R_{\\text{fix}}$, is calculated using the boundary pressures derived from this method, $p_{f,0}$ and $p_{f,N}$.\n$$\nR_{\\text{fix}} = (p_{f,0} - p_{f,N}) - \\sum_{i=0}^{N-1} \\rho_i g_i \\Delta z\n$$\nBy summing the per-cell balance equation from $i=0$ to $N-1$, we get a telescoping sum for the pressure term:\n$$\n\\sum_{i=0}^{N-1} (p_{f,i} - p_{f,i+1}) = p_{f,0} - p_{f,N}\n$$\nFrom the per-cell balance, we also have $\\sum_{i=0}^{N-1} (p_{f,i} - p_{f,i+1}) = \\sum_{i=0}^{N-1} \\rho_i g_i \\Delta z$.\nSubstituting this into the expression for $R_{\\text{fix}}$:\n$$\nR_{\\text{fix}} = \\left( \\sum_{i=0}^{N-1} \\rho_i g_i \\Delta z \\right) - \\sum_{i=0}^{N-1} \\rho_i g_i \\Delta z = 0\n$$\nThus, the residual for the pressure-based fix is identically zero (to machine precision) by construction, demonstrating a well-balanced scheme free of spurious momentum in the hydrostatic state.\n\n### 5. Implementation for Test Cases\n\nThe solution is implemented by defining the continuous physics for each case, from which the discrete quantities are derived.\n\n- **Constant Gravity:** For constant $g$, temperature $T$, and gas constant $R$, the scale height is $H_s = RT/g$. The hydrostatic solution for an isothermal ideal gas is $p(z) = p_0 e^{-z/H_s}$ and $\\rho(z) = p(z)/(RT)$.\n- **Variable Gravity:** For $g(z) = g_0(1 - \\alpha z)$, the hydrostatic relation $dp/p = -g(z)/(RT) \\, dz$ integrates to give $p(z) = p_0 \\exp\\left(-\\frac{g_0}{RT}(z - \\frac{\\alpha z^2}{2})\\right)$.\n\nFor each test case, we compute $R_{\\text{naive}}$ and $R_{\\text{fix}}$ following the methodologies described above. The results, particularly for coarse grids ($N=1, 2$), will starkly illustrate the failure of the naive method and the robustness of the well-balanced approach.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef calculate_residuals(params):\n    \"\"\"\n    Calculates the naive and fixed momentum residuals for a given test case.\n    \"\"\"\n    # Extract parameters\n    H = params['H']\n    N = params['N']\n    T = params['T']\n    R = params['R']\n    p0 = params['p0']\n    \n    A = 1.0  # Cross-sectional area is 1 m^2\n    dz = H / N\n\n    # Define cell centers\n    # z_i corresponds to the center of cell i, for i in 0..N-1\n    z_i = (np.arange(N) + 0.5) * dz\n    \n    # Define continuous physics functions based on the case type\n    if params['type'] == 'const_g':\n        g_const = params['g']\n        g_func = lambda z: np.full_like(np.atleast_1d(z), g_const)\n        \n        # Scale height for isothermal atmosphere with constant g\n        Hs = R * T / g_const\n        \n        # Continuous pressure and density profiles\n        p_func = lambda z: p0 * np.exp(-z / Hs)\n        rho_func = lambda z: p_func(z) / (R * T)\n    \n    elif params['type'] == 'var_g':\n        g0 = params['g0']\n        alpha = params['alpha']\n        g_func = lambda z: g0 * (1.0 - alpha * z)\n        \n        # Continuous pressure and density for variable g\n        # Derived from integrating dp/p = -g(z)/(RT) dz\n        exponent_func = lambda z: -(g0 / (R * T)) * (z - 0.5 * alpha * z**2)\n        p_func = lambda z: p0 * np.exp(exponent_func(z))\n        rho_func = lambda z: p_func(z) / (R * T)\n\n    # Evaluate density and gravity at cell centers\n    rho_i = rho_func(z_i)\n    g_i = g_func(z_i)\n\n    # --- 1. Naive Residual Calculation ---\n    \n    # Net surface force from continuous pressure profile at domain boundaries\n    p_top_cont = p_func(H)\n    p_bot_cont = p_func(0.0) # This is p0\n    net_surface_force_naive = A * (p_bot_cont - p_top_cont)\n\n    # Total body force from midpoint rule sum over cells\n    total_body_force_discrete = A * np.sum(rho_i * g_i) * dz\n    \n    # Residual is the sum of forces (surface + body). Body force is negative.\n    # In the problem's terms: difference of surface force and magnitude of body force.\n    R_naive = net_surface_force_naive - total_body_force_discrete\n\n    # --- 2. Pressure-Based Fix Residual Calculation ---\n    \n    # Create an array for face pressures. N+1 faces for N cells.\n    # Face j is at z = j * dz.\n    p_face = np.zeros(N + 1)\n    \n    # Set the top boundary face pressure as the starting point for recursion\n    p_face[N] = p_top_cont\n\n    # Recurse downwards from top to bottom to find all face pressures\n    # p_face[i] = p_face[i+1] + rho_i[i] * g_i[i] * dz\n    for i in range(N - 1, -1, -1):\n        p_face[i] = p_face[i+1] + rho_i[i] * g_i[i] * dz\n        \n    p_bot_fix = p_face[0]\n    p_top_fix = p_face[N]\n\n    # Net surface force using the newly computed consistent boundary pressures\n    net_surface_force_fix = A * (p_bot_fix - p_top_fix)\n    \n    # The discrete body force sum is the same as before\n    # The residual for the fix should be zero by construction\n    R_fix = net_surface_force_fix - total_body_force_discrete\n    \n    return [R_naive, R_fix]\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test suite.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1 (happy path): Isothermal ideal gas with constant gravity\n        {'H': 1000.0, 'N': 10, 'g': 9.81, 'T': 300.0, 'R': 287.0, 'p0': 101325.0, \n         'g0': None, 'alpha': None, 'type': 'const_g'},\n        # Case 2 (coarse resolution): Same as Case 1, coarser grid\n        {'H': 1000.0, 'N': 2, 'g': 9.81, 'T': 300.0, 'R': 287.0, 'p0': 101325.0, \n         'g0': None, 'alpha': None, 'type': 'const_g'},\n        # Case 3 (extreme coarse edge case): N=1 cell\n        {'H': 1000.0, 'N': 1, 'g': 9.81, 'T': 300.0, 'R': 287.0, 'p0': 101325.0, \n         'g0': None, 'alpha': None, 'type': 'const_g'},\n        # Case 4 (variable gravity): Isothermal ideal gas with linearly varying g\n        {'H': 2000.0, 'N': 20, 'g': None, 'T': 300.0, 'R': 287.0, 'p0': 101325.0, \n         'g0': 9.81, 'alpha': 1e-5, 'type': 'var_g'}\n    ]\n\n    results = []\n    for case in test_cases:\n        result = calculate_residuals(case)\n        results.append(result)\n\n    # Format the output string exactly as specified\n    formatted_results = [f\"[{res[0]},{res[1]}]\" for res in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "3335974"}, {"introduction": "Modern numerical methods, such as the Discontinuous Galerkin (DG) method, are often founded on the weak or variational form of the conservation laws, which naturally handles discontinuities and complex geometries. This formulation relies on the careful design of numerical fluxes at element interfaces to communicate information and ensure global conservation. This final practice [@problem_id:3336007] provides a capstone experience, bridging theory and implementation by tasking you with building a simple DG solver and verifying that, despite the local discontinuities in the solution, the total momentum of the system is conserved exactly due to the properties of the underlying weak form and the conservative numerical flux.", "problem": "Consider a compressible, Newtonian fluid with mass density $\\rho$, velocity $\\mathbf{u}$, pressure $p$, Cauchy stress deviator $\\boldsymbol{\\tau}$, and identity tensor $\\mathbf{I}$. The integral momentum balance on a fixed control volume $\\Omega$ with boundary $\\partial \\Omega$ and outward unit normal $\\mathbf{n}$, neglecting body forces, follows from Newton's second law as a conservation law: the time rate of change of total momentum equals the net traction flux through the boundary. Starting from this fundamental base, derive the differential (strong) form by invoking the divergence theorem and appropriate smoothness assumptions, and then the weak Galerkin form by multiplying the strong form by a sufficiently smooth test function $\\boldsymbol{\\phi}$ with compact support and integrating over $\\Omega$, performing integration by parts to move spatial derivatives onto $\\boldsymbol{\\phi}$. Explicitly discuss which boundary terms appear and under what boundary conditions the weak and strong forms are equivalent.\n\nNext, specialize to a one-dimensional inviscid case (set $\\boldsymbol{\\tau}=\\mathbf{0}$ and let $\\mathbf{u}=u\\mathbf{e}_x$) so that the momentum equation for the conserved variable $m=\\rho u$ can be written as a conservation law with a physical flux $f(m,\\rho,p)=\\rho u^2+p$. For numerical discretization, consider the Discontinuous Galerkin (DG) method with piecewise-constant basis functions (polynomial degree $0$, also known as $P0$) on a uniform mesh of $N$ cells covering a one-dimensional domain of length $L$ with constant cell size $\\Delta x=L/N$. Denote by $m_i$ the cell-average of momentum in cell $i$ and by $(\\rho_i,p_i)$ the cell-averaged density and pressure, which you may treat as independent inputs for the purpose of designing and testing conservation.\n\nDesign a single-valued numerical interface flux $F^\\star$ for the inviscid momentum equation that satisfies the two essential properties required for global conservation in DG:\n- Consistency: $F^\\star(U,U)=f(U)$ when the left and right states coincide, where $U$ denotes the set of state variables needed to evaluate the physical flux.\n- Conservation symmetry: the contribution of an interior interface to adjacent cells must be equal and opposite so that, when summing over all cells, interior contributions telescope and only boundary fluxes remain.\n\nA concrete choice that satisfies these properties is the local Lax–Friedrichs (also called Rusanov) flux tailored to the momentum equation. In one space dimension, let $U_L=(\\rho_L,m_L,p_L)$ and $U_R=(\\rho_R,m_R,p_R)$ be the left and right states at an interface, with $u_L=m_L/\\rho_L$, $u_R=m_R/\\rho_R$, and sound speeds $c_L=\\sqrt{\\gamma p_L/\\rho_L}$, $c_R=\\sqrt{\\gamma p_R/\\rho_R}$ for a calorically perfect gas with ratio of specific heats $\\gamma$. Define the maximum characteristic speed $a=\\max\\left(\\lvert u_L\\rvert+c_L,\\lvert u_R\\rvert+c_R\\right)$. The numerical momentum flux is a consistent central average of the physical flux minus a stabilizing term proportional to the jump in momentum:\n$$\nF^\\star(U_L,U_R)=\\tfrac{1}{2}\\left(\\rho_L u_L^2+p_L+\\rho_R u_R^2+p_R\\right)-\\tfrac{1}{2}a\\left(m_R-m_L\\right).\n$$\nImplement a semi-discrete $P0$ DG update with forward Euler time integration,\n$$\nm_i^{n+1}=m_i^n-\\frac{\\Delta t}{\\Delta x}\\left(F^\\star_{i+\\tfrac{1}{2}}-F^\\star_{i-\\tfrac{1}{2}}\\right),\n$$\nwhere $F^\\star_{i+\\tfrac{1}{2}}$ is the numerical momentum flux at the interface between cells $i$ and $i+1$, computed from the left and right states. For periodic boundary conditions, identify cell $0$’s left neighbor with cell $N-1$.\n\nUse dimensionless units throughout. Angles do not appear. Your implementation should verify discrete global momentum conservation properties implied by the strong and weak forms, namely that the sum of cell-averaged momenta only changes due to boundary fluxes:\n$$\n\\sum_{i=0}^{N-1} m_i^{n+1}-\\sum_{i=0}^{N-1} m_i^n=-\\frac{\\Delta t}{\\Delta x}\\left(F^\\star_{\\text{right boundary}}-F^\\star_{\\text{left boundary}}\\right).\n$$\nOn a periodic domain, the right and left boundary are the same interface so the net change is zero.\n\nImplement the program to run the following test suite, each specified by $(N,L,\\Delta t,\\text{steps},\\gamma,\\text{boundary type},\\text{initial fields},\\text{boundary states})$:\n\n- Test $1$ (general periodic, nonuniform “happy path”): $N=50$, $L=1$, $\\Delta t=10^{-3}$, $\\text{steps}=100$, $\\gamma=1.4$, periodic boundaries; initial fields defined by $\\rho(x)=1+0.2\\sin(2\\pi x)$, $u(x)=0.5+0.3\\cos(2\\pi x)$, and $p(x)=1+0.1\\sin(4\\pi x)$. Report a boolean indicating whether the total momentum is preserved to within a tolerance of $10^{-12}$, i.e., whether $\\left\\lvert\\sum_i m_i^{\\text{final}}-\\sum_i m_i^{\\text{initial}}\\right\\rvert\\le 10^{-12}$.\n\n- Test $2$ (uniform periodic state): $N=20$, $L=1$, $\\Delta t=10^{-3}$, $\\text{steps}=50$, $\\gamma=1.4$, periodic boundaries; initial fields $\\rho(x)=1$, $u(x)=1$, $p(x)=1$. Report a boolean with the same $10^{-12}$ tolerance.\n\n- Test $3$ (non-periodic with prescribed open boundary states; single-step discrete balance): $N=40$, $L=1$, $\\Delta t=10^{-3}$, $\\text{steps}=1$, $\\gamma=1.4$, non-periodic boundaries; interior initial fields $\\rho(x)=1+0.1\\cos(2\\pi x)$, $u(x)=0.2+0.1\\sin(2\\pi x)$, $p(x)=1+0.05\\cos(2\\pi x)$; left boundary ghost state $U_L=(\\rho,p,u)=(1.1,1.05,0.3)$ and right boundary ghost state $U_R=(\\rho,p,u)=(0.9,0.95,0.1)$, each converted to $(\\rho,m=\\rho u,p)$ when computing $F^\\star$. Report the absolute float difference between the numerically observed change in total momentum and the theoretically predicted $-\\frac{\\Delta t}{\\Delta x}\\left(F^\\star_{\\text{right boundary}}-F^\\star_{\\text{left boundary}}\\right)$ for that single step.\n\n- Test $4$ (edge case with very few cells, random periodic state): $N=2$, $L=1$, $\\Delta t=10^{-3}$, $\\text{steps}=10$, $\\gamma=1.4$, periodic boundaries; initial fields generated deterministically by $\\rho(x)=1+0.3\\sin(6\\pi x)$, $u(x)=0.4+0.2\\cos(6\\pi x)$, $p(x)=1+0.2\\sin(8\\pi x)$. Report a boolean with the same $10^{-12}$ tolerance.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of Tests $1$ through $4$, for example, $[result_1,result_2,result_3,result_4]$, where $result_1$, $result_2$, and $result_4$ are booleans and $result_3$ is a float in dimensionless units.", "solution": "The problem requires a two-part response: firstly, a theoretical derivation and discussion of various forms of the momentum conservation law in fluid dynamics, and secondly, a numerical implementation to verify discrete conservation for a specific scheme.\n\n### Part 1: Theoretical Derivation and Discussion\n\nWe begin with the fundamental integral form of the momentum conservation law for a compressible, Newtonian fluid in a fixed control volume $\\Omega$ with boundary $\\partial \\Omega$.\n\n**From Integral to Strong Form**\n\nThe momentum balance is a statement of Newton's second law for a continuous medium. For a fixed control volume $\\Omega$, the time rate of change of momentum within the volume plus the net rate at which momentum is convected out through the boundary $\\partial \\Omega$ is equal to the sum of all forces acting on the fluid within the volume. Neglecting body forces, the only forces are surface forces (pressure and viscous stresses). The integral form is:\n$$\n\\frac{d}{dt}\\int_{\\Omega} \\rho \\mathbf{u} \\,d V + \\oint_{\\partial\\Omega} (\\rho \\mathbf{u}) (\\mathbf{u}\\cdot\\mathbf{n}) \\,dA = \\oint_{\\partial\\Omega} \\boldsymbol{\\sigma} \\cdot \\mathbf{n} \\,dA\n$$\nwhere $\\rho$ is the mass density, $\\mathbf{u}$ is the velocity vector, $\\mathbf{n}$ is the outward unit normal to the boundary, and $\\boldsymbol{\\sigma}$ is the Cauchy stress tensor, given by $\\boldsymbol{\\sigma} = -p\\mathbf{I} + \\boldsymbol{\\tau}$, with $p$ being the pressure, $\\mathbf{I}$ the identity tensor, and $\\boldsymbol{\\tau}$ the deviatoric stress tensor.\n\nThe convective flux term can be rewritten using the tensor product $\\otimes$ as $\\rho \\mathbf{u} (\\mathbf{u}\\cdot\\mathbf{n}) = (\\rho \\mathbf{u} \\otimes \\mathbf{u}) \\cdot \\mathbf{n}$. For a fixed control volume, the time derivative can be moved inside the integral. The equation becomes:\n$$\n\\int_{\\Omega} \\frac{\\partial (\\rho \\mathbf{u})}{\\partial t} \\,d V + \\oint_{\\partial\\Omega} (\\rho \\mathbf{u} \\otimes \\mathbf{u}) \\cdot \\mathbf{n} \\,dA = \\oint_{\\partial\\Omega} \\boldsymbol{\\sigma} \\cdot \\mathbf{n} \\,dA\n$$\nBy invoking the divergence theorem, which states that $\\oint_{\\partial \\Omega} \\mathbf{F} \\cdot \\mathbf{n} \\, dA = \\int_{\\Omega} \\nabla \\cdot \\mathbf{F} \\, dV$ for a sufficiently smooth tensor field $\\mathbf{F}$, we can convert the surface integrals to volume integrals:\n$$\n\\int_{\\Omega} \\frac{\\partial (\\rho \\mathbf{u})}{\\partial t} \\,d V + \\int_{\\Omega} \\nabla \\cdot (\\rho \\mathbf{u} \\otimes \\mathbf{u}) \\,d V = \\int_{\\Omega} \\nabla \\cdot \\boldsymbol{\\sigma} \\,d V\n$$\nCombining the terms under a single integral:\n$$\n\\int_{\\Omega} \\left[ \\frac{\\partial (\\rho \\mathbf{u})}{\\partial t} + \\nabla \\cdot (\\rho \\mathbf{u} \\otimes \\mathbf{u} - \\boldsymbol{\\sigma}) \\right] d V = \\mathbf{0}\n$$\nUnder the assumption of sufficient smoothness of the integrand (e.g., continuity), for this integral to be zero for any arbitrary control volume $\\Omega$, the integrand itself must be zero everywhere. This yields the differential (strong) form of the momentum conservation law:\n$$\n\\frac{\\partial (\\rho \\mathbf{u})}{\\partial t} + \\nabla \\cdot (\\rho \\mathbf{u} \\otimes \\mathbf{u} - \\boldsymbol{\\sigma}) = \\mathbf{0}\n$$\nSubstituting $\\boldsymbol{\\sigma} = -p\\mathbf{I} + \\boldsymbol{\\tau}$, we arrive at the final form:\n$$\n\\frac{\\partial (\\rho \\mathbf{u})}{\\partial t} + \\nabla \\cdot (\\rho \\mathbf{u} \\otimes \\mathbf{u} + p\\mathbf{I} - \\boldsymbol{\\tau}) = \\mathbf{0}\n$$\nThis is a system of conservation laws of the form $\\frac{\\partial \\mathbf{q}}{\\partial t} + \\nabla \\cdot \\mathbf{F} = \\mathbf{0}$, where $\\mathbf{q} = \\rho\\mathbf{u}$ is the vector of conserved momentum components and $\\mathbf{F} = \\rho \\mathbf{u} \\otimes \\mathbf{u} + p\\mathbf{I} - \\boldsymbol{\\tau}$ is the momentum flux tensor.\n\n**Derivation of the Weak Galerkin Form**\n\nThe weak form is derived by multiplying the strong form by a sufficiently smooth vector test function $\\boldsymbol{\\phi}$ (from a suitable function space, e.g., $H^1(\\Omega)$) and integrating over the domain $\\Omega$:\n$$\n\\int_{\\Omega} \\boldsymbol{\\phi} \\cdot \\left[ \\frac{\\partial (\\rho \\mathbf{u})}{\\partial t} + \\nabla \\cdot (\\rho \\mathbf{u} \\otimes \\mathbf{u} + p\\mathbf{I} - \\boldsymbol{\\tau}) \\right] d V = 0\n$$\nWe analyze the terms separately. The time-derivative term, assuming $\\boldsymbol{\\phi}$ is not a function of time, is $\\int_{\\Omega} \\boldsymbol{\\phi} \\cdot \\frac{\\partial(\\rho\\mathbf{u})}{\\partial t} dV = \\frac{d}{dt} \\int_{\\Omega} \\boldsymbol{\\phi} \\cdot (\\rho\\mathbf{u}) dV$. For the flux term, we use integration by parts (a multidimensional version which is a consequence of the divergence theorem). For a vector $\\mathbf{v}$ and a tensor $\\mathbf{F}$, a relevant identity is $\\nabla\\cdot(\\mathbf{F}^T\\mathbf{v}) = (\\nabla\\cdot\\mathbf{F})\\cdot\\mathbf{v} + \\mathbf{F}:\\nabla\\mathbf{v}$. Since the flux tensor $\\mathbf{F} = \\rho \\mathbf{u} \\otimes \\mathbf{u} + p\\mathbf{I} - \\boldsymbol{\\tau}$ is symmetric, $\\mathbf{F}^T=\\mathbf{F}$. Thus:\n$$\n\\int_\\Omega \\boldsymbol{\\phi} \\cdot (\\nabla \\cdot \\mathbf{F}) dV = \\int_\\Omega (\\nabla \\cdot (\\mathbf{F}\\boldsymbol{\\phi})) dV - \\int_\\Omega \\mathbf{F} : \\nabla\\boldsymbol{\\phi} \\, dV\n$$\nApplying the divergence theorem to the first term on the right-hand side gives:\n$$\n\\int_\\Omega \\boldsymbol{\\phi} \\cdot (\\nabla \\cdot \\mathbf{F}) dV = \\oint_{\\partial\\Omega} (\\mathbf{F}\\boldsymbol{\\phi}) \\cdot \\mathbf{n} \\, dA - \\int_\\Omega \\mathbf{F} : \\nabla\\boldsymbol{\\phi} \\, dV = \\oint_{\\partial\\Omega} \\boldsymbol{\\phi} \\cdot (\\mathbf{F} \\cdot \\mathbf{n}) \\, dA - \\int_\\Omega \\mathbf{F} : \\nabla\\boldsymbol{\\phi} \\, dV\n$$\nSubstituting this back into the integrated equation, we obtain the weak Galerkin form:\n$$\n\\frac{d}{dt} \\int_{\\Omega} \\boldsymbol{\\phi} \\cdot (\\rho\\mathbf{u}) \\, dV - \\int_{\\Omega} (\\rho \\mathbf{u} \\otimes \\mathbf{u} + p\\mathbf{I} - \\boldsymbol{\\tau}) : \\nabla\\boldsymbol{\\phi} \\, dV + \\oint_{\\partial\\Omega} \\boldsymbol{\\phi} \\cdot ((\\rho \\mathbf{u} \\otimes \\mathbf{u} + p\\mathbf{I} - \\boldsymbol{\\tau}) \\cdot \\mathbf{n}) \\, dA = 0\n$$\nThis form is \"weak\" because it has transferred the spatial derivatives from the state variables $(\\rho, \\mathbf{u}, p, \\boldsymbol{\\tau})$ to the smooth test function $\\boldsymbol{\\phi}$, thereby lowering the smoothness requirement on the solution itself. This is crucial for handling solutions with discontinuities, such as shock waves.\n\n**Equivalence and Boundary Conditions**\n\nThe boundary integral term, $\\oint_{\\partial\\Omega} \\boldsymbol{\\phi} \\cdot (\\mathbf{F} \\cdot \\mathbf{n}) \\, dA$, is where boundary conditions are naturally applied.\nA solution satisfying the strong form (a \"strong solution\") is by definition smooth enough for all derivatives to exist, and by reversing the integration by parts, it is straightforward to show it also satisfies the weak form.\nEquivalence in the other direction (from weak to strong) is more subtle. If a solution satisfies the weak form for all possible test functions $\\boldsymbol{\\phi}$ in a sufficiently large space, one can argue for a pointwise satisfaction of the strong form. If we specifically choose test functions $\\boldsymbol{\\phi}$ that have compact support within $\\Omega$ (i.e., $\\boldsymbol{\\phi} = \\mathbf{0}$ on $\\partial\\Omega$), the boundary integral vanishes. The weak form becomes:\n$$\n\\frac{d}{dt} \\int_{\\Omega} \\boldsymbol{\\phi} \\cdot (\\rho\\mathbf{u}) \\, dV - \\int_{\\Omega} (\\rho \\mathbf{u} \\otimes \\mathbf{u} + p\\mathbf{I} - \\boldsymbol{\\tau}) : \\nabla\\boldsymbol{\\phi} \\, dV = 0\n$$\nIf the solution is assumed to be smooth, we can integrate by parts in reverse to recover the integral of the strong form's differential operator multiplied by $\\boldsymbol{\\phi}$. By the fundamental lemma of calculus of variations, this implies the operator itself is zero, thus recovering the strong form. Therefore, for smooth solutions and test functions with compact support, the weak and strong forms are equivalent. The weak form, however, is more general as it admits non-smooth solutions.\n\n### Part 2: Numerical Implementation\n\nThe problem specializes to a 1D, inviscid ($\\boldsymbol{\\tau}=\\mathbf{0}$) case. The state vector is $\\mathbf{u} = u\\mathbf{e}_x$. The momentum equation becomes:\n$$\n\\frac{\\partial (\\rho u)}{\\partial t} + \\frac{\\partial (\\rho u^2 + p)}{\\partial x} = 0\n$$\nThis is a conservation law $\\frac{\\partial m}{\\partial t} + \\frac{\\partial f}{\\partial x} = 0$ for the conserved variable $m = \\rho u$ and the physical flux $f = \\rho u^2 + p$.\n\nWe use a Discontinuous Galerkin method with piecewise-constant basis functions ($P0$), which on a uniform grid is equivalent to a finite volume method. We integrate the PDE over a cell $i$, $[x_{i-1/2}, x_{i+1/2}]$ of size $\\Delta x$:\n$$\n\\int_{x_{i-1/2}}^{x_{i+1/2}} \\frac{\\partial m}{\\partial t} dx + \\int_{x_{i-1/2}}^{x_{i+1/2}} \\frac{\\partial f}{\\partial x} dx = 0 \\quad \\implies \\quad \\frac{d}{dt} \\int_{x_{i-1/2}}^{x_{i+1/2}} m \\, dx + \\left[f(x_{i+1/2}) - f(x_{i-1/2})\\right] = 0\n$$\nDefining the cell-average $m_i(t) = \\frac{1}{\\Delta x} \\int_{x_{i-1/2}}^{x_{i+1/2}} m(x,t) dx$, we get $\\Delta x \\frac{dm_i}{dt} + [f(x_{i+1/2}) - f(x_{i-1/2})] = 0$. Since the solution is discontinuous at cell interfaces, we replace the physical flux $f$ with a single-valued numerical flux $F^\\star$ that depends on the states to the left ($U_L$) and right ($U_R$) of the interface. This gives the semi-discrete scheme:\n$$\n\\frac{dm_i}{dt} = -\\frac{1}{\\Delta x} \\left[ F^\\star(U_i, U_{i+1}) - F^\\star(U_{i-1}, U_i) \\right]\n$$\nwhere $F^\\star_{i+1/2} = F^\\star(U_i, U_{i+1})$. Applying a forward Euler time-integration step $\\frac{m_i^{n+1}-m_i^n}{\\Delta t} = \\frac{dm_i}{dt}$ yields the fully-discrete update rule provided.\n\nThe chosen numerical flux is the local Lax-Friedrichs (Rusanov) flux:\n$$\nF^\\star(U_L,U_R)=\\tfrac{1}{2}\\left(f(U_L)+f(U_R)\\right)-\\tfrac{1}{2}a\\left(m_R-m_L\\right)\n$$\nwhere $a=\\max\\left(\\lvert u_L\\rvert+c_L,\\lvert u_R\\rvert+c_R\\right)$ is an estimate of the maximum signal speed. This flux is consistent ($F^\\star(U,U) = f(U)$) and conservative.\n\nFor a periodic domain, the sum of all updates is $\\sum_{i=0}^{N-1} (m_i^{n+1}-m_i^n) = -\\frac{\\Delta t}{\\Delta x} \\sum_{i=0}^{N-1} (F^\\star_{i+1/2}-F^\\star_{i-1/2})$. This is a telescoping sum which, due to periodicity ($F^\\star_{-1/2} = F^\\star_{N-1/2}$), evaluates to zero. Thus, total momentum $\\sum m_i$ is conserved. For non-periodic domains, the sum telescopes to the boundary fluxes: $\\sum_{i=0}^{N-1} (m_i^{n+1}-m_i^n) = -\\frac{\\Delta t}{\\Delta x} (F^\\star_{\\text{right bdy}} - F^\\star_{\\text{left bdy}})$. The implementation will verify these properties. For cell-average initialization, we approximate the integral by the function value at the cell center, a standard second-order-accurate choice for smooth functions.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef rusanov_flux(rho_L, m_L, p_L, rho_R, m_R, p_R, gamma):\n    \"\"\"\n    Computes the Rusanov (local Lax-Friedrichs) numerical flux for the\n    1D inviscid momentum equation.\n    \"\"\"\n    # Left state velocity and flux\n    u_L = m_L / rho_L\n    f_L = rho_L * u_L**2 + p_L\n    \n    # Right state velocity and flux\n    u_R = m_R / rho_R\n    f_R = rho_R * u_R**2 + p_R\n    \n    # Sound speeds\n    c_L = np.sqrt(gamma * p_L / rho_L)\n    c_R = np.sqrt(gamma * p_R / rho_R)\n    \n    # Maximum characteristic speed at the interface\n    a = max(abs(u_L) + c_L, abs(u_R) + c_R)\n    \n    # Rusanov flux\n    flux = 0.5 * (f_L + f_R) - 0.5 * a * (m_R - m_L)\n    \n    return flux\n\ndef run_simulation(N, L, dt, steps, gamma, boundary_type, rho0, m0, p0, ghost_L_state=None, ghost_R_state=None):\n    \"\"\"\n    Runs the DG-P0 simulation and returns the result for the specified test.\n    \"\"\"\n    dx = L / N\n    rho, m, p = rho0.copy(), m0.copy(), p0.copy()\n    \n    initial_total_momentum = np.sum(m)\n\n    for _ in range(steps):\n        m_old = m.copy()\n        \n        # Calculate fluxes at all N interfaces (periodic) or N+1 interfaces (non-periodic)\n        if boundary_type == 'periodic':\n            fluxes = np.zeros(N)\n            for i in range(N):\n                i_L = i\n                i_R = (i + 1) % N\n                fluxes[i] = rusanov_flux(rho[i_L], m[i_L], p[i_L], rho[i_R], m[i_R], p[i_R], gamma)\n            \n            # Update momentum in each cell\n            for i in range(N):\n                flux_L = fluxes[(i - 1 + N) % N]\n                flux_R = fluxes[i]\n                m[i] = m_old[i] - (dt / dx) * (flux_R - flux_L)\n        \n        else: # non-periodic\n            fluxes = np.zeros(N + 1)\n            # Left boundary flux\n            fluxes[0] = rusanov_flux(ghost_L_state[0], ghost_L_state[1], ghost_L_state[2], rho[0], m[0], p[0], gamma)\n            \n            # Interior fluxes\n            for i in range(N - 1):\n                fluxes[i+1] = rusanov_flux(rho[i], m[i], p[i], rho[i+1], m[i+1], p[i+1], gamma)\n            \n            # Right boundary flux\n            fluxes[N] = rusanov_flux(rho[N-1], m[N-1], p[N-1], ghost_R_state[0], ghost_R_state[1], ghost_R_state[2], gamma)\n\n            # Update momentum in each cell\n            for i in range(N):\n                flux_L = fluxes[i]\n                flux_R = fluxes[i+1]\n                m[i] = m_old[i] - (dt / dx) * (flux_R - flux_L)\n\n    # Calculate and return the required metric for the test case\n    if boundary_type == 'periodic':\n        final_total_momentum = np.sum(m)\n        conservation_error = abs(final_total_momentum - initial_total_momentum)\n        return conservation_error <= 1e-12\n    else: # non-periodic for Test 3\n        final_total_momentum = np.sum(m)\n        observed_change = final_total_momentum - initial_total_momentum\n        \n        F_left_bdy = fluxes[0]\n        F_right_bdy = fluxes[N]\n        predicted_change = -(dt / dx) * (F_right_bdy - F_left_bdy)\n        \n        return abs(observed_change - predicted_change)\n\ndef solve():\n    results = []\n\n    # Test 1\n    N, L, dt, steps, gamma = 50, 1.0, 1e-3, 100, 1.4\n    x = (np.arange(N) + 0.5) * (L / N)\n    rho0_1 = 1.0 + 0.2 * np.sin(2 * np.pi * x)\n    u0_1 = 0.5 + 0.3 * np.cos(2 * np.pi * x)\n    p0_1 = 1.0 + 0.1 * np.sin(4 * np.pi * x)\n    m0_1 = rho0_1 * u0_1\n    results.append(run_simulation(N, L, dt, steps, gamma, 'periodic', rho0_1, m0_1, p0_1))\n    \n    # Test 2\n    N, L, dt, steps, gamma = 20, 1.0, 1e-3, 50, 1.4\n    rho0_2 = np.full(N, 1.0)\n    u0_2 = np.full(N, 1.0)\n    p0_2 = np.full(N, 1.0)\n    m0_2 = rho0_2 * u0_2\n    results.append(run_simulation(N, L, dt, steps, gamma, 'periodic', rho0_2, m0_2, p0_2))\n\n    # Test 3\n    N, L, dt, steps, gamma = 40, 1.0, 1e-3, 1, 1.4\n    x = (np.arange(N) + 0.5) * (L / N)\n    rho0_3 = 1.0 + 0.1 * np.cos(2 * np.pi * x)\n    u0_3 = 0.2 + 0.1 * np.sin(2 * np.pi * x)\n    p0_3 = 1.0 + 0.05 * np.cos(2 * np.pi * x)\n    m0_3 = rho0_3 * u0_3\n    \n    ghost_L_pu, ghost_R_pu = (1.1, 1.05, 0.3), (0.9, 0.95, 0.1)\n    ghost_L_state = (ghost_L_pu[0], ghost_L_pu[0] * ghost_L_pu[2], ghost_L_pu[1]) # (rho, m, p)\n    ghost_R_state = (ghost_R_pu[0], ghost_R_pu[0] * ghost_R_pu[2], ghost_R_pu[1]) # (rho, m, p)\n    results.append(run_simulation(N, L, dt, steps, gamma, 'non-periodic', rho0_3, m0_3, p0_3, ghost_L_state, ghost_R_state))\n\n    # Test 4\n    N, L, dt, steps, gamma = 2, 1.0, 1e-3, 10, 1.4\n    x = (np.arange(N) + 0.5) * (L / N)\n    rho0_4 = 1.0 + 0.3 * np.sin(6 * np.pi * x)\n    u0_4 = 0.4 + 0.2 * np.cos(6 * np.pi * x)\n    p0_4 = 1.0 + 0.2 * np.sin(8 * np.pi * x)\n    m0_4 = rho0_4 * u0_4\n    results.append(run_simulation(N, L, dt, steps, gamma, 'periodic', rho0_4, m0_4, p0_4))\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```", "id": "3336007"}]}