{"hands_on_practices": [{"introduction": "A cornerstone of understanding molecular behavior is projecting the system's high-dimensional free energy landscape onto a few key reaction coordinates. This exercise provides a foundational look into how the nature of the coordinate itself—whether it describes an internal molecular rearrangement or the interaction between separate molecules—shapes the resulting Potential of Mean Force (PMF). By deriving the mean force from first principles for both an intramolecular dihedral angle and an intermolecular distance, you will uncover the crucial role of entropic contributions that arise from the geometry of the coordinate space, a distinction that is fundamental to separating intramolecular and intermolecular effects [@problem_id:3418858].", "problem": "Consider a classical canonical ensemble at temperature $T$ with configuration vector $x$ and potential energy $U(x)$. The probability density is $p(x) \\propto \\exp(-\\beta U(x))$ with $\\beta = 1/(k_\\mathrm{B} T)$, where $k_\\mathrm{B}$ is the Boltzmann constant. For a reaction coordinate $q(x)$, the potential of mean force (PMF) $W(q)$ is defined by the constrained partition function $Z(q) = \\int \\mathrm{d}x \\, \\exp(-\\beta U(x)) \\, \\delta(q - q(x))$, via $W(q) = -k_\\mathrm{B} T \\ln Z(q) + C$, where $C$ is an additive constant independent of $q$. The mean force along $q$ is defined by $\\langle F_q \\rangle = - \\mathrm{d}W/\\mathrm{d}q$.\n\nYou will compare intramolecular versus intermolecular contributions by evaluating $\\langle F_q \\rangle$ along two reaction coordinates that are physically decoupled in the following model:\n\n- Intramolecular dihedral coordinate $q_\\mathrm{dihedral} = \\theta \\in [0, 2\\pi)$ with an intramolecular torsion potential $U_\\mathrm{intra}(\\theta) = k_t \\left(1 - \\cos(n \\theta)\\right)$, where $k_t > 0$ and $n \\in \\mathbb{N}$.\n- Intermolecular contact coordinate $q_\\mathrm{contact} = r > 0$ equal to the separation between two point particles interacting via a Lennard–Jones potential $U_\\mathrm{inter}(r) = 4 \\varepsilon \\left[(\\sigma/r)^{12} - (\\sigma/r)^6\\right]$.\n\nAssume the full potential energy is separable as $U(x) = U_\\mathrm{intra}(\\theta) + U_\\mathrm{inter}(r) + U_\\mathrm{other}(\\text{all other independent degrees of freedom})$, and that the remaining degrees of freedom do not couple to $\\theta$ or $r$ beyond the usual metric factors implied by the choice of coordinates. Angles must be expressed in radians. Work in reduced Lennard–Jones units where the unit of length is $\\sigma$, the unit of energy is $\\varepsilon$, and the unit of force is $\\varepsilon/\\sigma$. Set $k_\\mathrm{B} = 1$ in these reduced units.\n\nYour task is to, from first principles, derive expressions that allow computation of the mean force $\\langle F_{q} \\rangle$ along $q_\\mathrm{dihedral}$ and $q_\\mathrm{contact}$ using only the definitions above and standard coordinate-measure considerations. Then, implement a program that evaluates the mean force for each of the following independent test cases:\n\nDihedral-based reaction coordinate cases (intramolecular):\n1. $k_t = 4.0$, $n = 3$, $\\theta = \\pi/6$.\n2. $k_t = 4.0$, $n = 3$, $\\theta = \\pi/3$.\n3. $k_t = 4.0$, $n = 3$, $\\theta = \\pi/2$.\n4. $k_t = 2.5$, $n = 2$, $\\theta = \\pi/4$.\n\nContact-based reaction coordinate cases (intermolecular):\n5. $\\varepsilon = 1.0$, $\\sigma = 1.0$, $T = 1.0$, $r = 2^{1/6} \\, \\sigma$.\n6. $\\varepsilon = 1.0$, $\\sigma = 1.0$, $T = 1.0$, $r = 0.9 \\, \\sigma$.\n7. $\\varepsilon = 1.0$, $\\sigma = 1.0$, $T = 1.0$, $r = 3.0 \\, \\sigma$.\n8. $\\varepsilon = 1.0$, $\\sigma = 1.0$, $T = 0.1$, $r = 3.0 \\, \\sigma$.\n9. $\\varepsilon = 1.0$, $\\sigma = 1.0$, $T = 0.01$, $r = 1.5 \\, \\sigma$.\n\nAll answers must be expressed in reduced Lennard–Jones force units $\\varepsilon/\\sigma$. Your program should produce a single line of output containing the results for the $9$ test cases as a comma-separated list of floats, rounded to six decimal places, enclosed in square brackets (for example, $[a_1,a_2,\\dots,a_9]$). No additional text may be printed.\n\nDesign considerations:\n- Begin from $p(x) \\propto \\exp(-\\beta U(x))$ and the definition of $W(q)$. Do not assume any specialized or black-box formulas not derivable from these bases. Carefully account for the coordinate-space measure when forming $Z(q)$ for the contact coordinate $r$.\n- Ensure your expressions are valid within the stated separability assumptions and that the units are consistent.\n- The program must be self-contained and require no input. It must compute and print the nine results in the exact format specified.", "solution": "The objective is to derive expressions for the mean force, $\\langle F_q \\rangle$, along an intramolecular dihedral coordinate, $q=\\theta$, and an intermolecular contact coordinate, $q=r$, and then to compute these forces for a series of test cases. The derivation will start from the first principles of statistical mechanics as laid out in the problem statement. We will work in reduced Lennard-Jones units, where the characteristic energy $\\varepsilon$, length $\\sigma$, and the Boltzmann constant $k_\\mathrm{B}$ are all set to unity. Consequently, temperature $T$ is in units of $\\varepsilon$, and the parameter $\\beta = 1/(k_\\mathrm{B}T)$ becomes $\\beta=1/T$.\n\nThe mean force along a reaction coordinate $q$ is defined as the negative derivative of the Potential of Mean Force (PMF), $W(q)$:\n$$\n\\langle F_q \\rangle = - \\frac{\\mathrm{d}W}{\\mathrm{d}q}\n$$\nThe PMF is defined via the constrained partition function, $Z(q)$, as:\n$$\nW(q) = -k_\\mathrm{B} T \\ln Z(q) + C = -T \\ln Z(q) + C\n$$\nwhere $C$ is a constant and $Z(q) = \\int \\mathrm{d}x \\, \\exp(-\\beta U(x)) \\, \\delta(q - q(x))$. The integral is over the entire configuration space $x$. The key to solving the problem is to evaluate $Z(q)$ for each coordinate type by properly accounting for the potential energy separability and the integration measure.\n\n### Case 1: Intramolecular Dihedral Coordinate ($q_\\mathrm{dihedral} = \\theta$)\n\nFor the intramolecular case, the reaction coordinate is the dihedral angle $\\theta$. The potential energy is given as separable:\n$$\nU(x) = U_\\mathrm{intra}(\\theta) + U_\\mathrm{rest}(y)\n$$\nwhere $y$ represents all other degrees of freedom (including the intermolecular distance $r$ and others), and $U_\\mathrm{rest}(y) = U_\\mathrm{inter}(r) + U_\\mathrm{other}(\\dots)$. The problem states that other degrees of freedom are independent, which implies that the integration measure (the Jacobian determinant) is also separable. For a dihedral angle as a generalized coordinate, the corresponding metric tensor component is typically constant. Thus, the volume element can be written as $\\mathrm{d}x = c \\cdot \\mathrm{d}\\theta \\mathrm{d}y$, where $c$ is a constant.\n\nThe constrained partition function $Z(\\theta')$ for a specific value of the dihedral angle $\\theta'$ is:\n$$\nZ(\\theta') = \\int c_1 \\mathrm{d}\\theta \\mathrm{d}y \\, e^{-\\beta (U_\\mathrm{intra}(\\theta) + U_\\mathrm{rest}(y))} \\, \\delta(\\theta'-\\theta)\n$$\nPerforming the integration over $\\theta$ using the property of the Dirac delta function, we get:\n$$\nZ(\\theta') = c_1 \\int \\mathrm{d}y \\, e^{-\\beta (U_\\mathrm{intra}(\\theta') + U_\\mathrm{rest}(y))} = c_1 e^{-\\beta U_\\mathrm{intra}(\\theta')} \\int \\mathrm{d}y \\, e^{-\\beta U_\\mathrm{rest}(y)}\n$$\nThe remaining integral, $Z_\\mathrm{rest} = \\int \\mathrm{d}y \\, e^{-\\beta U_\\mathrm{rest}(y)}$, is a constant with respect to $\\theta'$. Therefore, $Z(\\theta')$ is proportional to the Boltzmann factor of the intramolecular potential itself:\n$$\nZ(\\theta') = C_1 e^{-\\beta U_\\mathrm{intra}(\\theta')}\n$$\nwhere $C_1$ is a constant. The PMF is then:\n$$\nW(\\theta') = -T \\ln(C_1 e^{-\\beta U_\\mathrm{intra}(\\theta')}) + C = -T \\ln(C_1) -T(-\\beta U_\\mathrm{intra}(\\theta')) + C = U_\\mathrm{intra}(\\theta') + C_2\n$$\nwhere $C_2$ is another constant. This shows that when a degree of freedom is fully decoupled, its PMF is identical to its potential energy, up to an additive constant.\n\nThe mean force (in this case, a mean torque) is:\n$$\n\\langle F_\\theta \\rangle = -\\frac{\\mathrm{d}W}{\\mathrm{d}\\theta} = -\\frac{\\mathrm{d}}{\\mathrm{d}\\theta} (U_\\mathrm{intra}(\\theta) + C_2) = -\\frac{\\mathrm{d}U_\\mathrm{intra}}{\\mathrm{d}\\theta}\n$$\nGiven the form of the dihedral potential, $U_\\mathrm{intra}(\\theta) = k_t (1 - \\cos(n \\theta))$, the derivative is:\n$$\n\\frac{\\mathrm{d}U_\\mathrm{intra}}{\\mathrm{d}\\theta} = k_t (n \\sin(n \\theta))\n$$\nThus, the expression for the mean torque is:\n$$\n\\langle F_\\theta \\rangle = -n k_t \\sin(n \\theta)\n$$\nThis quantity has units of energy. The problem requests the answer in units of force, $\\varepsilon/\\sigma$. In reduced units where $\\sigma=1$, the unit of force becomes numerically equal to the unit of energy. Therefore, we report the numerical value of the torque calculated in reduced energy units.\n\n### Case 2: Intermolecular Contact Coordinate ($q_\\mathrm{contact} = r$)\n\nFor the intermolecular case, the reaction coordinate $q$ is the separation distance $r$ between two particles. The potential energy is separable: $U(x) = U_\\mathrm{inter}(r) + U_\\mathrm{rest}(y)$, where $y$ now includes the dihedral angle $\\theta$ and other degrees of freedom.\nThe constrained partition function for a specific distance $r'$ is:\n$$\nZ(r') = \\int \\mathrm{d}x \\, e^{-\\beta (U_\\mathrm{inter}(r(x)) + U_\\mathrm{rest}(y))} \\, \\delta(r' - r(x))\n$$\nFactoring out the integral over the rest coordinates, we get:\n$$\nZ(r') = C_3 \\int_{\\text{pair}} e^{-\\beta U_\\mathrm{inter}(r)} \\, \\delta(r' - r)\n$$\nwhere the integral is over the degrees of freedom of the interacting pair. Let their positions be $\\mathbf{r}_1$ and $\\mathbf{r}_2$. The configuration element is $\\mathrm{d}\\mathbf{r}_1 \\mathrm{d}\\mathbf{r}_2$. We change to center-of-mass $\\mathbf{R} = (\\mathbf{r}_1 + \\mathbf{r}_2)/2$ and relative $\\mathbf{r} = \\mathbf{r}_1 - \\mathbf{r}_2$ coordinates. The integration element becomes $\\mathrm{d}\\mathbf{R} \\mathrm{d}\\mathbf{r}$. The potential $U_\\mathrm{inter}$ only depends on the magnitude $r = |\\mathbf{r}|$. The integral over $\\mathbf{R}$ gives the system volume $V$, another constant. We are left with the integral over the relative coordinate $\\mathbf{r}$:\n$$\nZ(r') \\propto \\int \\mathrm{d}\\mathbf{r} \\, e^{-\\beta U_\\mathrm{inter}(r)} \\, \\delta(r' - r)\n$$\nTo evaluate this, we switch to spherical coordinates for $\\mathbf{r}$. The volume element is $\\mathrm{d}\\mathbf{r} = r^2 \\sin\\phi \\, \\mathrm{d}r \\mathrm{d}\\phi \\mathrm{d}\\psi$. This Jacobian factor $r^2$ is the crucial \"coordinate-space measure\" referenced in the problem.\n$$\nZ(r') \\propto \\int_0^{2\\pi} \\mathrm{d}\\psi \\int_0^\\pi \\mathrm{d}\\phi \\, \\sin\\phi \\int_0^\\infty \\mathrm{d}r \\, r^2 e^{-\\beta U_\\mathrm{inter}(r)} \\, \\delta(r' - r)\n$$\nThe angular integrals yield $4\\pi$. The radial integral is solved by the delta function:\n$$\nZ(r') \\propto 4\\pi (r')^2 e^{-\\beta U_\\mathrm{inter}(r')}\n$$\nThe PMF $W(r')$ is then:\n$$\nW(r') = -T \\ln(Z(r')) + C = -T \\ln(C_4 (r')^2 e^{-\\beta U_\\mathrm{inter}(r')}) + C = U_\\mathrm{inter}(r') - 2T \\ln(r') + C_5\n$$\nThe PMF is the sum of the direct potential energy $U_\\mathrm{inter}(r')$ and an entropic term $-2T\\ln(r')$, which arises because the volume of phase space available in a spherical shell of radius $r'$ and thickness $\\mathrm{d}r$ is proportional to $4\\pi (r')^2 \\mathrm{d}r$.\n\nThe mean force is the negative derivative of the PMF with respect to $r$:\n$$\n\\langle F_r \\rangle = -\\frac{\\mathrm{d}W}{\\mathrm{d}r} = -\\frac{\\mathrm{d}U_\\mathrm{inter}}{\\mathrm{d}r} - \\frac{\\mathrm{d}}{\\mathrm{d}r}(-2T\\ln(r)) = -\\frac{\\mathrm{d}U_\\mathrm{inter}}{\\mathrm{d}r} + \\frac{2T}{r}\n$$\nThe first term is the direct force from the Lennard-Jones potential. For $U_\\mathrm{inter}(r) = 4\\varepsilon [(\\sigma/r)^{12} - (\\sigma/r)^6]$, its negative derivative in reduced units ($\\varepsilon=1, \\sigma=1$) is $F_\\mathrm{direct} = 24(2r^{-13} - r^{-7})$. The total mean force is:\n$$\n\\langle F_r \\rangle = 24(2r^{-13} - r^{-7}) + \\frac{2T}{r}\n$$\nThis expression is in the correct units of force, $\\varepsilon/\\sigma$.\n\n### Implementation\nThe provided Python code implements these two derived formulas. For the intramolecular cases (1-4), it computes $\\langle F_\\theta \\rangle = -n k_t \\sin(n\\theta)$. For the intermolecular cases (5-9), it computes $\\langle F_r \\rangle = 24(2r^{-13} - r^{-7}) + 2T/r$ using the given parameters in reduced units. The results for all nine cases are collected and printed in the specified format, rounded to six decimal places.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Calculates the mean force for 9 test cases, based on derived formulas for\n    intramolecular (dihedral) and intermolecular (contact) reaction coordinates.\n    \"\"\"\n\n    # Test cases are defined as tuples. The first element is a string identifier.\n    # For 'dihedral': (kt, n, theta_rad)\n    # For 'contact': (T, r)\n    test_cases = [\n        ('dihedral', (4.0, 3, np.pi/6)),\n        ('dihedral', (4.0, 3, np.pi/3)),\n        ('dihedral', (4.0, 3, np.pi/2)),\n        ('dihedral', (2.5, 2, np.pi/4)),\n        ('contact', (1.0, 2**(1/6))),\n        ('contact', (1.0, 0.9)),\n        ('contact', (1.0, 3.0)),\n        ('contact', (0.1, 3.0)),\n        ('contact', (0.01, 1.5)),\n    ]\n\n    results = []\n    \n    for case_type, params in test_cases:\n        if case_type == 'dihedral':\n            # Mean force (torque) for a dihedral potential U = kt * (1 - cos(n*theta))\n            # <F_theta> = -dU/dtheta = -n * kt * sin(n*theta)\n            # The result is a torque (energy units), but in reduced units with sigma=1,\n            # the numerical value is the same as for force units (energy/sigma).\n            kt, n, theta = params\n            mean_force = -n * kt * np.sin(n * theta)\n            results.append(mean_force)\n        \n        elif case_type == 'contact':\n            # Mean force for a Lennard-Jones contact distance r.\n            # W(r) = U_LJ(r) - 2*T*ln(r) + const.\n            # <F_r> = -dW/dr = -dU_LJ/dr + 2*T/r\n            # In reduced units (epsilon=1, sigma=1):\n            # U_LJ(r) = 4 * (r**-12 - r**-6)\n            # -dU_LJ/dr = 24 * (2*r**-13 - r**-7)\n            T, r = params\n            direct_force = 24.0 * (2.0 * r**-13 - r**-7)\n            entropic_force = 2.0 * T / r\n            mean_force = direct_force + entropic_force\n            results.append(mean_force)\n\n    # Format the output string as a list of floats with 6 decimal places.\n    # The f-string formatting {x:.6f} handles rounding correctly.\n    formatted_results = [f\"{res:.6f}\" for res in results]\n    \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "3418858"}, {"introduction": "Building upon the concept of distinct energy contributions, this practice explores how their statistical fluctuations give rise to macroscopic thermodynamic properties. Based on the fluctuation-dissipation theorem, the heat capacity at constant volume, $C_V$, is directly related to the variance of the total potential energy. Because the total energy is a sum of intramolecular and intermolecular terms, $U = U_{\\mathrm{intra}} + U_{\\mathrm{inter}}$, its variance necessarily includes a cross-correlation term, $2\\,\\mathrm{Cov}(U_{\\mathrm{intra}}, U_{\\mathrm{inter}})$, which quantifies the coupling between internal and external motions. This computational experiment challenges you to build a surrogate model to dissect the heat capacity into its constituent parts, offering a powerful lesson on how the interplay between interaction types dictates a system's thermal response [@problem_id:3418835].", "problem": "Consider a canonical-ensemble Molecular Dynamics (MD) experiment in the constant Number, Volume, and Temperature (NVT) ensemble, where the total potential energy is decomposed as $U = U_{\\mathrm{intra}} + U_{\\mathrm{inter}}$. The configurational contribution to the heat capacity at constant volume is obtained from potential energy fluctuations via the widely accepted canonical fluctuation relation $C_V^{\\mathrm{conf}} = \\left(\\langle U^2 \\rangle - \\langle U \\rangle^2\\right) / \\left(k_B T^2\\right)$, where $k_B$ is the Boltzmann constant and $T$ is the absolute temperature. Your task is to design a computational experiment that, using a statistically grounded surrogate for MD fluctuations, attributes $C_V^{\\mathrm{conf}}$ to intramolecular and intermolecular components, and explores how a solvent polarity parameter shifts this partition.\n\nYou must implement a program that constructs a Gaussian surrogate for the joint fluctuations of $U_{\\mathrm{intra}}$ and $U_{\\mathrm{inter}}$, motivated by the Central Limit Theorem and the near-harmonic character of small-amplitude fluctuations near equilibrium. Specifically, assume:\n- $U_{\\mathrm{intra}}$ arises from $N_{\\mathrm{intra}}$ independent quadratic (harmonic) intramolecular modes at temperature $T$. This implies a variance scaling consistent with quadratic degrees of freedom.\n- $U_{\\mathrm{inter}}$ arises from $N_{\\mathrm{inter}}$ effective intermolecular modes whose fluctuation amplitude depends on a dimensionless solvent polarity parameter $p$, capturing the strengthening of polar interactions. Introduce a dimensionless amplitude factor $\\beta(p)$ and a dimensionless cross-coupling $\\gamma(p)$ that modulates the covariance between $U_{\\mathrm{intra}}$ and $U_{\\mathrm{inter}}$.\n\nDefine the following for the surrogate:\n- The Boltzmann constant is $k_B = 1.380649 \\times 10^{-23}\\ \\mathrm{J}\\ \\mathrm{K}^{-1}$.\n- The variance of intramolecular fluctuations is $\\mathrm{Var}\\!\\left(U_{\\mathrm{intra}}\\right) = N_{\\mathrm{intra}} \\left(k_B^2 T^2\\right) / 2$.\n- The variance of intermolecular fluctuations is $\\mathrm{Var}\\!\\left(U_{\\mathrm{inter}}\\right) = \\beta(p)\\, N_{\\mathrm{inter}} \\left(k_B^2 T^2\\right) / 2$, where $\\beta(p) = 1 + b_1 p$ with $b_1 = 0.5$.\n- The covariance is $\\mathrm{Cov}\\!\\left(U_{\\mathrm{intra}}, U_{\\mathrm{inter}}\\right) = \\gamma(p)\\, \\sqrt{\\mathrm{Var}\\!\\left(U_{\\mathrm{intra}}\\right)\\, \\mathrm{Var}\\!\\left(U_{\\mathrm{inter}}\\right)}$, where $\\gamma(p) = c_0 \\tanh(p)$ with $c_0 = 0.5$. This choice ensures a positive semidefinite covariance matrix for all $p \\ge 0$.\n\nGenerate $N$ samples of the bivariate fluctuation vector $\\left(U_{\\mathrm{intra}}, U_{\\mathrm{inter}}\\right)$ from a zero-mean multivariate normal distribution with covariance matrix determined by the above variances and covariance, where $N = 100000$. For any case where $\\mathrm{Var}\\!\\left(U_{\\mathrm{inter}}\\right) = 0$, treat $U_{\\mathrm{inter}}$ as identically zero and sample $U_{\\mathrm{intra}}$ from a univariate normal distribution with the specified variance.\n\nFor each test case, compute and report the following quantities, all expressed in joules per kelvin ($\\mathrm{J}\\ \\mathrm{K}^{-1}$):\n- $C_{\\mathrm{intra}} = \\mathrm{Var}\\!\\left(U_{\\mathrm{intra}}\\right) / \\left(k_B T^2\\right)$,\n- $C_{\\mathrm{inter}} = \\mathrm{Var}\\!\\left(U_{\\mathrm{inter}}\\right) / \\left(k_B T^2\\right)$,\n- $C_{\\mathrm{cross}} = 2\\, \\mathrm{Cov}\\!\\left(U_{\\mathrm{intra}}, U_{\\mathrm{inter}}\\right) / \\left(k_B T^2\\right)$,\n- $C_{\\mathrm{total}} = \\left(\\langle U^2 \\rangle - \\langle U \\rangle^2\\right) / \\left(k_B T^2\\right)$, with $U = U_{\\mathrm{intra}} + U_{\\mathrm{inter}}$.\n\nYour program must implement the above construction and compute the four quantities using empirical moments from the generated samples, not closed-form expressions. Use a fixed random seed for reproducibility. Express all outputs in scientific notation with $6$ significant digits.\n\nTest Suite:\n- Case $1$: $T = 300\\ \\mathrm{K}$, $N_{\\mathrm{intra}} = 9$, $N_{\\mathrm{inter}} = 12$, $p = 0.2$.\n- Case $2$: $T = 300\\ \\mathrm{K}$, $N_{\\mathrm{intra}} = 9$, $N_{\\mathrm{inter}} = 12$, $p = 1.0$.\n- Case $3$: $T = 300\\ \\mathrm{K}$, $N_{\\mathrm{intra}} = 9$, $N_{\\mathrm{inter}} = 0$, $p = 0.5$.\n- Case $4$: $T = 600\\ \\mathrm{K}$, $N_{\\mathrm{intra}} = 9$, $N_{\\mathrm{inter}} = 12$, $p = 0.2$.\n- Case $5$: $T = 300\\ \\mathrm{K}$, $N_{\\mathrm{intra}} = 9$, $N_{\\mathrm{inter}} = 12$, $p = 5.0$.\n\nFinal Output Format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each element is an inner list $[C_{\\mathrm{intra}}, C_{\\mathrm{inter}}, C_{\\mathrm{cross}}, C_{\\mathrm{total}}]$ for the corresponding test case, expressed in $\\mathrm{J}\\ \\mathrm{K}^{-1}$ in scientific notation with $6$ significant digits. For example, the outer list should look like $[[\\cdots],[\\cdots],\\ldots]$ with no additional text before or after.", "solution": "The problem requires the design and implementation of a computational experiment to partition the configurational heat capacity at constant volume, $C_V^{\\mathrm{conf}}$, into components arising from intramolecular and intermolecular potential energy fluctuations. The core of the problem lies in statistical mechanics, specifically the fluctuation-dissipation theorem, which relates thermodynamic response functions (like heat capacity) to the statistical fluctuations of microscopic quantities (like energy) in thermal equilibrium.\n\nThe fundamental relationship in the canonical ($NVT$) ensemble is:\n$$\nC_V^{\\mathrm{conf}} = \\frac{\\langle U^2 \\rangle - \\langle U \\rangle^2}{k_B T^2} = \\frac{\\mathrm{Var}(U)}{k_B T^2}\n$$\nwhere $U$ is the total potential energy, $k_B$ is the Boltzmann constant ($1.380649 \\times 10^{-23}\\ \\mathrm{J}\\ \\mathrm{K}^{-1}$), $T$ is the absolute temperature, and $\\mathrm{Var}(U)$ is the variance of the potential energy.\n\nThe total potential energy is decomposed into intramolecular and intermolecular contributions, $U = U_{\\mathrm{intra}} + U_{\\mathrm{inter}}$. Using the properties of variance, the variance of the total energy can be expanded as:\n$$\n\\mathrm{Var}(U) = \\mathrm{Var}(U_{\\mathrm{intra}} + U_{\\mathrm{inter}}) = \\mathrm{Var}(U_{\\mathrm{intra}}) + \\mathrm{Var}(U_{\\mathrm{inter}}) + 2 \\mathrm{Cov}(U_{\\mathrm{intra}}, U_{\\mathrm{inter}})\n$$\nSubstituting this decomposition into the expression for $C_V^{\\mathrm{conf}}$ yields a partition of the heat capacity:\n$$\nC_V^{\\mathrm{conf}} = \\frac{\\mathrm{Var}(U_{\\mathrm{intra}})}{k_B T^2} + \\frac{\\mathrm{Var}(U_{\\mathrm{inter}})}{k_B T^2} + \\frac{2 \\mathrm{Cov}(U_{\\mathrm{intra}}, U_{\\mathrm{inter}})}{k_B T^2}\n$$\nThis naturally defines the three components we are asked to compute:\n1.  The intramolecular contribution: $C_{\\mathrm{intra}} = \\mathrm{Var}(U_{\\mathrm{intra}}) / (k_B T^2)$\n2.  The intermolecular contribution: $C_{\\mathrm{inter}} = \\mathrm{Var}(U_{\\mathrm{inter}}) / (k_B T^2)$\n3.  The cross-correlation contribution: $C_{\\mathrm{cross}} = 2 \\mathrm{Cov}(U_{\\mathrm{intra}}, U_{\\mathrm{inter}}) / (k_B T^2)$\n\nThe total configurational heat capacity is the sum of these three terms: $C_{\\mathrm{total}} = C_{\\mathrm{intra}} + C_{\\mathrm{inter}} + C_{\\mathrm{cross}}$.\n\nThe problem instructs us to use a surrogate model for the energy fluctuations, motivated by the Central Limit Theorem, which suggests that the sum of many independent random variables tends toward a normal distribution. We model the joint fluctuations of $(U_{\\mathrm{intra}}, U_{\\mathrm{inter}})$ as a bivariate normal distribution. Since we are interested in fluctuations around the mean energy, we can model them with a zero-mean distribution, $\\mathcal{N}(\\mathbf{0}, \\Sigma)$, where $\\mathbf{0}$ is the zero vector and $\\Sigma$ is the $2 \\times 2$ covariance matrix.\n\nThe elements of the covariance matrix $\\Sigma$ are defined by the problem statement as follows:\n- The variance of intramolecular energy, $\\sigma_{11} = \\mathrm{Var}(U_{\\mathrm{intra}})$, is given by a model of $N_{\\mathrm{intra}}$ independent harmonic modes. For a classical harmonic oscillator, the variance of its potential energy is $(k_B T)^2/2$. Thus, for $N_{\\mathrm{intra}}$ modes:\n  $$\n  \\sigma_{11} = \\mathrm{Var}(U_{\\mathrm{intra}}) = N_{\\mathrm{intra}} \\frac{(k_B T)^2}{2} = N_{\\mathrm{intra}} \\frac{k_B^2 T^2}{2}\n  $$\n- The variance of intermolecular energy, $\\sigma_{22} = \\mathrm{Var}(U_{\\mathrm{inter}})$, is modeled similarly but modulated by a solvent polarity parameter $p$:\n  $$\n  \\sigma_{22} = \\mathrm{Var}(U_{\\mathrm{inter}}) = \\beta(p) N_{\\mathrm{inter}} \\frac{k_B^2 T^2}{2}\n  $$\n  where the amplitude factor is $\\beta(p) = 1 + b_1 p$, with $b_1 = 0.5$.\n\n- The covariance between the two energy components, $\\sigma_{12} = \\mathrm{Cov}(U_{\\mathrm{intra}}, U_{\\mathrm{inter}})$, is determined by a dimensionless cross-coupling function $\\gamma(p)$:\n  $$\n  \\sigma_{12} = \\mathrm{Cov}(U_{\\mathrm{intra}}, U_{\\mathrm{inter}}) = \\gamma(p) \\sqrt{\\mathrm{Var}(U_{\\mathrm{intra}}) \\mathrm{Var}(U_{\\mathrm{inter}})} = \\gamma(p) \\sqrt{\\sigma_{11} \\sigma_{22}}\n  $$\n  where $\\gamma(p) = c_0 \\tanh(p)$, with $c_0 = 0.5$. This form ensures that the correlation coefficient $\\rho = \\gamma(p)$ is bounded, $|\\rho| \\le 0.5$, which guarantees the covariance matrix is positive semidefinite.\n\nThe computational procedure is as follows:\n1.  For each test case, specified by ($T, N_{\\mathrm{intra}}, N_{\\mathrm{inter}}, p$), first calculate the theoretical values of the covariance matrix elements, $\\sigma_{11}$, $\\sigma_{22}$, and $\\sigma_{12}$. If $N_{\\mathrm{inter}} = 0$, then $\\sigma_{22} = 0$ and $\\sigma_{12} = 0$.\n2.  Construct the $2 \\times 2$ covariance matrix $\\Sigma = \\begin{pmatrix} \\sigma_{11} & \\sigma_{12} \\\\ \\sigma_{12} & \\sigma_{22} \\end{pmatrix}$.\n3.  Generate a large number of samples, $N = 100000$, from the bivariate normal distribution $\\mathcal{N}(\\mathbf{0}, \\Sigma)$. Each sample is a vector $(\\delta U_{\\mathrm{intra}}^{(i)}, \\delta U_{\\mathrm{inter}}^{(i)})$.\n4.  Crucially, as per the problem, we do not use the theoretical variances and covariance to compute the heat capacities. Instead, we compute the *empirical* moments from the generated samples. For a set of $N$ samples, the unbiased empirical covariance matrix is calculated. Let the generated samples be $\\mathbf{u}_i = (U_{\\mathrm{intra}}^{(i)}, U_{\\mathrm{inter}}^{(i)})$. The empirical variances and covariance are:\n    $$\n    \\widehat{\\mathrm{Var}}(U_{\\mathrm{intra}}) = \\frac{1}{N-1} \\sum_{i=1}^{N} (U_{\\mathrm{intra}}^{(i)} - \\bar{U}_{\\mathrm{intra}})^2\n    $$\n    $$\n    \\widehat{\\mathrm{Var}}(U_{\\mathrm{inter}}) = \\frac{1}{N-1} \\sum_{i=1}^{N} (U_{\\mathrm{inter}}^{(i)} - \\bar{U}_{\\mathrm{inter}})^2\n    $$\n    $$\n    \\widehat{\\mathrm{Cov}}(U_{\\mathrm{intra}}, U_{\\mathrm{inter}}) = \\frac{1}{N-1} \\sum_{i=1}^{N} (U_{\\mathrm{intra}}^{(i)} - \\bar{U}_{\\mathrm{intra}})(U_{\\mathrm{inter}}^{(i)} - \\bar{U}_{\\mathrm{inter}})\n    $$\n    where $\\bar{U}$ denotes the sample mean.\n5.  The total energy fluctuation for each sample is $U^{(i)} = U_{\\mathrm{intra}}^{(i)} + U_{\\mathrm{inter}}^{(i)}$. The empirical variance of the total energy, $\\widehat{\\mathrm{Var}}(U)$, is also computed from the sample set $\\{U^{(i)}\\}$.\n6.  Finally, the four heat capacity quantities are calculated by substituting these empirical moments into the defining equations:\n    - $C_{\\mathrm{intra}} = \\widehat{\\mathrm{Var}}(U_{\\mathrm{intra}}) / (k_B T^2)$\n    - $C_{\\mathrm{inter}} = \\widehat{\\mathrm{Var}}(U_{\\mathrm{inter}}) / (k_B T^2)$\n    - $C_{\\mathrm{cross}} = 2 \\widehat{\\mathrm{Cov}}(U_{\\mathrm{intra}}, U_{\\mathrm{inter}}) / (k_B T^2)$\n    - $C_{\\mathrm{total}} = \\widehat{\\mathrm{Var}}(U) / (k_B T^2)$\n\nThis process simulates a computational experiment, distinguishing the underlying theoretical model (used to generate data) from the statistical analysis of the resulting data (used to compute the observables). A fixed random seed is used to ensure the reproducibility of the pseudo-randomly generated samples.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the computational problem of partitioning heat capacity\n    based on a surrogate model of molecular energy fluctuations.\n    \"\"\"\n    # Define constants\n    k_B = 1.380649e-23  # Boltzmann constant in J/K\n    b_1 = 0.5\n    c_0 = 0.5\n    N_samples = 100000\n\n    # Test suite from the problem statement\n    test_cases = [\n        # (T in K, N_intra, N_inter, p)\n        (300.0, 9, 12, 0.2),\n        (300.0, 9, 12, 1.0),\n        (300.0, 9, 0, 0.5),\n        (600.0, 9, 12, 0.2),\n        (300.0, 9, 12, 5.0),\n    ]\n\n    # Set a fixed random seed for reproducibility\n    np.random.seed(42)\n\n    all_case_results = []\n\n    for T, N_intra, N_inter, p in test_cases:\n        # Step 1: Calculate the theoretical covariance matrix elements\n        k_B_T_sq = (k_B * T)**2\n        \n        # Variance of intramolecular energy\n        var_intra = N_intra * k_B_T_sq / 2.0\n        \n        # Variance of intermolecular energy\n        if N_inter > 0:\n            beta_p = 1.0 + b_1 * p\n            var_inter = beta_p * N_inter * k_B_T_sq / 2.0\n        else:\n            var_inter = 0.0\n\n        # Covariance\n        if var_intra > 0 and var_inter > 0:\n            gamma_p = c_0 * np.tanh(p)\n            covar = gamma_p * np.sqrt(var_intra * var_inter)\n        else:\n            covar = 0.0\n\n        # Step 2: Construct the covariance matrix\n        cov_matrix = np.array([[var_intra, covar], [covar, var_inter]])\n        \n        # Step 3: Generate samples from the bivariate normal distribution\n        # The mean vector is zero, representing fluctuations\n        mean_vec = [0.0, 0.0]\n        samples = np.random.multivariate_normal(mean_vec, cov_matrix, size=N_samples)\n        \n        u_intra_samples = samples[:, 0]\n        u_inter_samples = samples[:, 1]\n        \n        # Step 4: Compute empirical moments from the samples\n        # We use ddof=1 for the unbiased sample variance/covariance\n        \n        # Calculate empirical individual variances and covariance\n        # np.cov returns the covariance matrix of the samples\n        emp_cov_matrix = np.cov(samples, rowvar=False, ddof=1)\n        emp_var_intra = emp_cov_matrix[0, 0]\n        emp_var_inter = emp_cov_matrix[1, 1]\n        emp_covar = emp_cov_matrix[0, 1]\n\n        # Step 5: Compute empirical total energy variance\n        u_total_samples = u_intra_samples + u_inter_samples\n        emp_var_total = np.var(u_total_samples, ddof=1)\n\n        # Step 6: Calculate heat capacity components\n        denom = k_B * T**2\n        \n        C_intra = emp_var_intra / denom\n        C_inter = emp_var_inter / denom\n        C_cross = 2.0 * emp_covar / denom\n        C_total = emp_var_total / denom\n\n        # Store results for this case\n        current_results = [C_intra, C_inter, C_cross, C_total]\n        all_case_results.append(current_results)\n\n    # Final print statement in the exact required format.\n    # Format each number to scientific notation with 6 significant digits (1.dddddde+xx)\n    formatted_results = []\n    for res_list in all_case_results:\n        formatted_list = [f\"{val:.5e}\" for val in res_list]\n        formatted_results.append(f\"[{','.join(formatted_list)}]\")\n    \n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "3418835"}, {"introduction": "While the conceptual separation between intramolecular and intermolecular interactions is clear, the algorithms used in modern simulations can introduce subtle and complex couplings. This exercise delves into one of the most important and intricate aspects of molecular dynamics: the calculation of long-range electrostatic interactions using Ewald summation under periodic boundary conditions. You will investigate a common but problematic shortcut where scaling factors for intramolecular $1$-$4$ interactions are applied only to the real-space component of the Ewald sum. By implementing the calculation yourself, you will quantify the resulting long-range energy artifact, providing a critical, hands-on understanding of how algorithmic choices can compromise the clean separation of forces we often assume in our models [@problem_id:3418808].", "problem": "Consider a single small, neutral, four-site linear molecule placed in a cubic simulation box with Periodic Boundary Conditions (PBC). Each site is a point charge, and intramolecular bonded topology is $1\\text{-}2$, $2\\text{-}3$, and $3\\text{-}4$. The $1\\text{-}4$ nonbonded interaction is scaled by a factor $s_{1\\text{-}4} \\in [0,1]$ while all other nonbonded interactions are unscaled. The molecule is simulated using Ewald summation for electrostatics with conducting (tin-foil) boundary conditions.\n\nFundamental base:\n- Newton's Second Law ($\\mathbf{F} = m \\, d\\mathbf{v}/dt$) ensures that forces derive from a potential energy $U(\\mathbf{r})$ and energy conservation requires $U(\\mathbf{r})$ to be internally consistent.\n- Coulomb's law in reduced units ($4\\pi \\epsilon_0 = 1$) gives the pair potential $u(r) = q_i q_j / r$, where $q_i$ are dimensionless charges and $r$ is a dimensionless distance.\n- Ewald summation splits the electrostatic energy into a direct (real-space) term, a reciprocal (Fourier-space) term, and a self-interaction correction. For point charges in a cubic box of side $L$ and volume $V=L^3$, with screening parameter $\\alpha$, the energy is\n$$\nU_{\\mathrm{tot}} = U_{\\mathrm{real}} + U_{\\mathrm{recip}} + U_{\\mathrm{self}},\n$$\nwhere\n$$\nU_{\\mathrm{real}} = \\sum_{i<j} \\sum_{\\mathbf{n}\\in\\mathbb{Z}^3} q_i q_j \\, \\frac{\\mathrm{erfc}(\\alpha \\, \\|\\mathbf{r}_{ij} + \\mathbf{n}L\\|)}{\\|\\mathbf{r}_{ij} + \\mathbf{n}L\\|}, \\quad \\|\\mathbf{r}\\| < r_c,\n$$\n$$\nU_{\\mathrm{recip}} = \\frac{2\\pi}{V}\\sum_{\\mathbf{k}\\neq \\mathbf{0}} \\frac{e^{- \\|\\mathbf{k}\\|^2 / (4\\alpha^2)}}{\\|\\mathbf{k}\\|^2} \\left| \\sum_j q_j e^{i \\mathbf{k}\\cdot \\mathbf{r}_j} \\right|^2, \\quad \\mathbf{k} = \\frac{2\\pi}{L}\\mathbf{m},\\ \\mathbf{m}\\in\\mathbb{Z}^3,\\ \\|\\mathbf{m}\\|\\le K_{\\max},\n$$\n$$\nU_{\\mathrm{self}} = -\\frac{\\alpha}{\\sqrt{\\pi}} \\sum_i q_i^2.\n$$\nThe real-space sum uses a finite cutoff $r_c$ and includes all lattice vectors $\\mathbf{n}$ such that the image distance is less than $r_c$, while the reciprocal-space sum uses a finite integer wave index cutoff $K_{\\max}$ (that is, $\\mathbf{m}$ within a cube of edge $2K_{\\max}+1$ excluding $\\mathbf{m}=\\mathbf{0}$).\n\nDefinitions and objective:\n- Let the molecule have positions $\\mathbf{r}_1, \\mathbf{r}_2, \\mathbf{r}_3, \\mathbf{r}_4$ and charges $q_1, q_2, q_3, q_4$ with $\\sum_{i=1}^4 q_i = 0$.\n- The $1\\text{-}4$ pair is $(1,4)$ and its intramolecular electrostatic interaction is scaled by $s_{1\\text{-}4}$. In many practical algorithms, $s_{1\\text{-}4}$ is applied only in the direct (real-space) part but not in the reciprocal-space part, which can introduce a long-range inconsistency.\n- Define the pair-specific Ewald energy contribution for the $1\\text{-}4$ pair as\n$$\nU_{14}^{\\mathrm{real}} = q_1 q_4 \\sum_{\\mathbf{n}} \\frac{\\mathrm{erfc}(\\alpha \\, \\|\\mathbf{r}_{14} + \\mathbf{n}L\\|)}{\\|\\mathbf{r}_{14} + \\mathbf{n}L\\|}, \\quad \\|\\mathbf{r}_{14}+\\mathbf{n}L\\| < r_c,\n$$\n$$\nU_{14}^{\\mathrm{recip}} = \\frac{2\\pi}{V}\\sum_{\\mathbf{k}\\neq \\mathbf{0}} \\frac{e^{- \\|\\mathbf{k}\\|^2 / (4\\alpha^2)}}{\\|\\mathbf{k}\\|^2} \\, 2 q_1 q_4 \\cos\\left(\\mathbf{k}\\cdot(\\mathbf{r}_1 - \\mathbf{r}_4)\\right),\n$$\nso that the full pair Ewald contribution is $U_{14}^{\\mathrm{Ewald}} = U_{14}^{\\mathrm{real}} + U_{14}^{\\mathrm{recip}}$ (the self term has no cross-pair contribution).\n- Consider two scaling schemes:\n    1. A consistent scheme applies $s_{1\\text{-}4}$ uniformly across both real and reciprocal components by subtracting $(1-s_{1\\text{-}4}) U_{14}^{\\mathrm{Ewald}}$ from $U_{\\mathrm{tot}}$.\n    2. An inconsistent scheme applies $s_{1\\text{-}4}$ to the real-space component only by subtracting $(1-s_{1\\text{-}4}) U_{14}^{\\mathrm{real}}$ from $U_{\\mathrm{tot}}$.\n- Define the long-range scaling artifact as the absolute difference between the consistent and inconsistent energies:\n$$\n\\Delta U_{\\mathrm{artifact}} = \\left| \\left( U_{\\mathrm{tot}} - (1-s_{1\\text{-}4}) U_{14}^{\\mathrm{Ewald}} \\right) - \\left( U_{\\mathrm{tot}} - (1-s_{1\\text{-}4}) U_{14}^{\\mathrm{real}} \\right) \\right| = (1-s_{1\\text{-}4}) \\left| U_{14}^{\\mathrm{recip}} \\right|.\n$$\nThis quantity isolates the long-range error introduced when scaling is applied only in the real-space component.\n\nYour task is to implement these computations in reduced, dimensionless units (no physical unit conversion is required), using the specified approximations for the sums. Then, for the given test suite, compute either $\\Delta U_{\\mathrm{artifact}}$ or an energy-splitting invariance residual defined as\n$$\n\\Delta U_{\\alpha} = \\left| U_{\\mathrm{tot}}(\\alpha_1) - U_{\\mathrm{tot}}(\\alpha_2) \\right|,\n$$\nwhich assesses the numerical invariance of the total energy to the Ewald splitting parameter when the real- and reciprocal-space truncations are fixed.\n\nMolecular geometry and parameters (common to all tests unless otherwise specified):\n- Positions: $\\mathbf{r}_1=(0.000,0,0)$, $\\mathbf{r}_2=(0.154,0,0)$, $\\mathbf{r}_3=(0.308,0,0)$, $\\mathbf{r}_4=(0.462,0,0)$.\n- Charges: $q_1=-0.3$, $q_2=0.1$, $q_3=0.1$, $q_4=0.1$.\n- The simulation box is cubic with side $L$; volume $V=L^3$.\n- Real-space cutoff $r_c$ and reciprocal cutoff $K_{\\max}$ are provided per test case.\n- Use conducting boundary conditions (no surface term) and the self term $U_{\\mathrm{self}} = -\\alpha \\, \\sum_i q_i^2 / \\sqrt{\\pi}$.\n- Use the integer wave index truncation $\\mathbf{k} = \\frac{2\\pi}{L}\\mathbf{m}$ with $\\mathbf{m}\\in\\{-K_{\\max},\\ldots,+K_{\\max}\\}^3 \\setminus \\{(0,0,0)\\}$.\n\nTest suite:\n1. Artifact, moderate box: $L=3.0$, $\\alpha=3.5$, $r_c=1.0$, $K_{\\max}=5$, $s_{1\\text{-}4}=0.5$.\n2. Artifact, large box: $L=10.0$, $\\alpha=3.5$, $r_c=1.0$, $K_{\\max}=5$, $s_{1\\text{-}4}=0.5$.\n3. Artifact, no scaling: $L=3.0$, $\\alpha=3.5$, $r_c=1.0$, $K_{\\max}=5$, $s_{1\\text{-}4}=1.0$.\n4. Artifact, full exclusion of $1\\text{-}4$: $L=3.0$, $\\alpha=3.5$, $r_c=1.0$, $K_{\\max}=5$, $s_{1\\text{-}4}=0.0$.\n5. Splitting invariance residual: $L=3.0$, $\\alpha_1=2.0$, $\\alpha_2=4.0$, $r_c=1.0$, $K_{\\max}=6$.\n\nRequired final output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,result3,result4,result5]\").\n- For tests 1–4, each result is the float $\\Delta U_{\\mathrm{artifact}}$.\n- For test 5, the result is the float $\\Delta U_{\\alpha}$.\n- All outputs are in reduced, dimensionless energy units. No angles or percentages are involved; express everything as floats.", "solution": "The task is to compute two specific quantities related to the Ewald summation method for calculating electrostatic energies in a periodic system. The first is an energy artifact, $\\Delta U_{\\mathrm{artifact}}$, arising from an inconsistent application of scaling factors for $1-4$ intramolecular interactions. The second is an energy residual, $\\Delta U_{\\alpha}$, which measures the numerical dependence of the total Ewald energy on the choice of the splitting parameter $\\alpha$. All calculations are performed in reduced, dimensionless units as specified.\n\n### Part 1: Calculation of $\\Delta U_{\\mathrm{artifact}}$\n\nThe scaling artifact is defined as $\\Delta U_{\\mathrm{artifact}} = (1-s_{1\\text{-}4}) \\left| U_{14}^{\\mathrm{recip}} \\right|$, where $s_{1\\text{-}4}$ is the scaling factor for the $1\\text{-}4$ interaction. The core of this calculation is the reciprocal energy component for the pair $(1,4)$, given by:\n$$\nU_{14}^{\\mathrm{recip}} = \\frac{2\\pi}{V}\\sum_{\\mathbf{k}\\neq \\mathbf{0}} \\frac{e^{- \\|\\mathbf{k}\\|^2 / (4\\alpha^2)}}{\\|\\mathbf{k}\\|^2} \\, 2 q_1 q_4 \\cos\\left(\\mathbf{k}\\cdot(\\mathbf{r}_1 - \\mathbf{r}_4)\\right)\n$$\nThe sum is over a grid of wave vectors $\\mathbf{k} = \\frac{2\\pi}{L}\\mathbf{m}$, where $\\mathbf{m} = (m_x, m_y, m_z)$ is a vector of integers. The problem specifies a cubic truncation where each component $m_i$ ranges from $-K_{\\max}$ to $+K_{\\max}$, excluding the term where $\\mathbf{m}=(0,0,0)$. The volume of the cubic box is $V=L^3$.\n\nThe molecular geometry is linear and aligned with the x-axis, i.e., $\\mathbf{r}_j = (r_{j,x}, 0, 0)$. This simplifies the dot product in the cosine term:\n$$\n\\mathbf{k}\\cdot(\\mathbf{r}_1 - \\mathbf{r}_4) = k_x (r_{1,x} - r_{4,x}) = \\frac{2\\pi m_x}{L} (r_{1,x} - r_{4,x})\n$$\nThe implementation involves a triple loop over $m_x, m_y, m_z$ within the specified range, calculating each term of the sum and accumulating the result. The final value is then multiplied by the prefactor $(1-s_{1\\text{-}4})$ and its absolute value is taken.\n\n### Part 2: Calculation of $\\Delta U_{\\alpha}$\n\nThe splitting invariance residual, $\\Delta U_{\\alpha}$, requires computing the total Ewald energy, $U_{\\mathrm{tot}} = U_{\\mathrm{real}} + U_{\\mathrm{recip}} + U_{\\mathrm{self}}$, for two parameters, $\\alpha_1$ and $\\alpha_2$, and finding the absolute difference.\n\n**1. Real-Space Energy ($U_{\\mathrm{real}}$):**\nThe real-space energy for a collection of point charges is sum over pairs $(i,j)$:\n$$\nU_{\\mathrm{real}} = \\sum_{i<j} \\sum_{\\mathbf{n}\\in\\mathbb{Z}^3} q_i q_j \\, \\frac{\\mathrm{erfc}(\\alpha \\, \\|\\mathbf{r}_{ij} + \\mathbf{n}L\\|)}{\\|\\mathbf{r}_{ij} + \\mathbf{n}L\\|}\n$$\nThe sum is truncated at a cutoff distance $r_c$. The problem parameters are such that the box side $L$ is significantly larger than the molecule, and the real-space cutoff $r_c$ is smaller than $L/2$. For intramolecular pairs, the distance to the closest periodic image, $\\|\\mathbf{r}_{ij}+\\mathbf{n}L\\|$ with $\\mathbf{n}\\neq\\mathbf{0}$, is greater than $r_c$. Consequently, the sum over lattice vectors $\\mathbf{n}$ simplifies to just the $\\mathbf{n}=(0,0,0)$ term. The calculation thus reduces to a single sum over pairs within the primary simulation box:\n$$\nU_{\\mathrm{real}} = \\sum_{i<j, \\, \\|\\mathbf{r}_{ij}\\| < r_c} q_i q_j \\, \\frac{\\mathrm{erfc}(\\alpha \\, \\|\\mathbf{r}_{ij}\\|)}{\\|\\mathbf{r}_{ij}\\|}\n$$\nThe complementary error function, $\\mathrm{erfc}(x)$, is computed using `scipy.special.erfc`.\n\n**2. Reciprocal-Space Energy ($U_{\\mathrm{recip}}$):**\nThe reciprocal-space energy is given by:\n$$\nU_{\\mathrm{recip}} = \\frac{2\\pi}{V}\\sum_{\\mathbf{k}\\neq \\mathbf{0}} \\frac{e^{- \\|\\mathbf{k}\\|^2 / (4\\alpha^2)}}{\\|\\mathbf{k}\\|^2} \\left| S(\\mathbf{k}) \\right|^2\n$$\nwhere $S(\\mathbf{k})$ is the structure factor, $S(\\mathbf{k}) = \\sum_j q_j e^{i \\mathbf{k}\\cdot \\mathbf{r}_j}$. Again, the sum is over the cubic grid of $\\mathbf{k}$ vectors up to the cutoff $K_{\\max}$. As the molecule lies on the x-axis, $\\mathbf{k}\\cdot \\mathbf{r}_j = k_x r_{j,x}$. The squared modulus of the structure factor is calculated as:\n$$\n|S(\\mathbf{k})|^2 = \\left(\\sum_j q_j \\cos(k_x r_{j,x})\\right)^2 + \\left(\\sum_j q_j \\sin(k_x r_{j,x})\\right)^2\n$$\nThis is computed for each $\\mathbf{k}$ vector in the sum.\n\n**3. Self-Interaction Correction ($U_{\\mathrm{self}}$):**\nThis term corrects for the self-interaction of the Gaussian charge distributions used in the Ewald derivation. It is given by a simple sum over all particles:\n$$\nU_{\\mathrm{self}} = -\\frac{\\alpha}{\\sqrt{\\pi}} \\sum_i q_i^2\n$$\nThe total energy $U_{\\mathrm{tot}}(\\alpha)$ is the sum of these three components. This calculation is performed for $\\alpha_1$ and $\\alpha_2$, and the absolute difference is the desired residual $\\Delta U_{\\alpha}$.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import erfc\n\ndef calculate_U14_recip(q1, q4, r14_vec, L, alpha, K_max):\n    \"\"\"\n    Calculates the reciprocal-space energy contribution for the 1-4 pair.\n    U_14^recip = (2*pi/V) * sum_k[exp(-k^2/(4*alpha^2))/k^2 * 2*q1*q4*cos(k*(r1-r4))]\n    \"\"\"\n    q1q4 = q1 * q4\n    if q1q4 == 0:\n        return 0.0\n\n    # Molecule is on x-axis, so r14_vec = (x, 0, 0)\n    r14_x = r14_vec[0]\n    \n    recip_sum = 0.0\n    m_range = range(-K_max, K_max + 1)\n    \n    for mx in m_range:\n        for my in m_range:\n            for mz in m_range:\n                if mx == 0 and my == 0 and mz == 0:\n                    continue\n                \n                m_sq = float(mx*mx + my*my + mz*mz)\n                k_sq = (2.0 * np.pi / L)**2 * m_sq\n                \n                # k . (r1 - r4) = k_x * (r1_x - r4_x)\n                kx_r14x = (2.0 * np.pi / L) * mx * r14_x\n                \n                cos_term = np.cos(kx_r14x)\n                \n                term = (np.exp(-k_sq / (4.0 * alpha**2)) / k_sq) * 2.0 * q1q4 * cos_term\n                recip_sum += term\n\n    return (2.0 * np.pi / (L**3)) * recip_sum\n\ndef calculate_total_ewald(positions, charges, L, alpha, r_c, K_max):\n    \"\"\"\n    Calculates the total Ewald energy U_tot = U_real + U_recip + U_self.\n    \"\"\"\n    num_particles = len(charges)\n    V = L**3\n    \n    # 1. Real-space energy\n    # For intramolecular interactions, only n=(0,0,0) image contributes\n    # because r_c < L/2 and molecule is small.\n    U_real = 0.0\n    for i in range(num_particles):\n        for j in range(i + 1, num_particles):\n            rij_vec = positions[i] - positions[j]\n            r = np.linalg.norm(rij_vec)\n            if r < r_c:\n                U_real += charges[i] * charges[j] * erfc(alpha * r) / r\n\n    # 2. Reciprocal-space energy\n    U_recip = 0.0\n    m_range = range(-K_max, K_max + 1)\n    \n    for mx in m_range:\n        for my in m_range:\n            for mz in m_range:\n                if mx == 0 and my == 0 and mz == 0:\n                    continue\n                \n                m_sq = float(mx*mx + my*my + mz*mz)\n                k_sq = (2.0 * np.pi / L)**2 * m_sq\n                \n                # Structure factor S(k). Only k_x component matters for k.r\n                kx = (2.0 * np.pi / L) * mx\n                kx_rx = kx * positions[:, 0]\n                \n                S_real = np.sum(charges * np.cos(kx_rx))\n                S_imag = np.sum(charges * np.sin(kx_rx))\n                S_k_sq = S_real**2 + S_imag**2\n                \n                U_recip += (np.exp(-k_sq / (4.0 * alpha**2)) / k_sq) * S_k_sq\n\n    U_recip *= (2.0 * np.pi / V)\n\n    # 3. Self-interaction energy\n    U_self = - (alpha / np.sqrt(np.pi)) * np.sum(charges**2)\n\n    return U_real + U_recip + U_self\n\ndef solve():\n    # Common molecular parameters\n    positions = np.array([\n        [0.000, 0.0, 0.0],\n        [0.154, 0.0, 0.0],\n        [0.308, 0.0, 0.0],\n        [0.462, 0.0, 0.0]\n    ])\n    charges = np.array([-0.3, 0.1, 0.1, 0.1])\n    q1, q4 = charges[0], charges[3]\n    # Use r1 - r4 for dot product consistency with formula\n    r14_vec = positions[0] - positions[3] \n    \n    results = []\n\n    # --- Test Case 1: Artifact, moderate box ---\n    L, alpha, r_c, K_max, s14 = 3.0, 3.5, 1.0, 5, 0.5\n    U14_recip_1 = calculate_U14_recip(q1, q4, r14_vec, L, alpha, K_max)\n    artifact_1 = (1.0 - s14) * np.abs(U14_recip_1)\n    results.append(artifact_1)\n    \n    # --- Test Case 2: Artifact, large box ---\n    L, alpha, r_c, K_max, s14 = 10.0, 3.5, 1.0, 5, 0.5\n    U14_recip_2 = calculate_U14_recip(q1, q4, r14_vec, L, alpha, K_max)\n    artifact_2 = (1.0 - s14) * np.abs(U14_recip_2)\n    results.append(artifact_2)\n\n    # --- Test Case 3: Artifact, no scaling ---\n    s14 = 1.0\n    # Artifact is trivially 0, as (1 - s14) = 0\n    artifact_3 = (1.0 - s14) * np.abs(U14_recip_1) # U14_recip is same as case 1\n    results.append(artifact_3)\n\n    # --- Test Case 4: Artifact, full exclusion ---\n    s14 = 0.0\n    # Artifact is |U14_recip|, using same Ewald params as case 1\n    artifact_4 = (1.0 - s14) * np.abs(U14_recip_1)\n    results.append(artifact_4)\n    \n    # --- Test Case 5: Splitting invariance residual ---\n    L, r_c, K_max = 3.0, 1.0, 6\n    alpha1, alpha2 = 2.0, 4.0\n    \n    U_tot_alpha1 = calculate_total_ewald(positions, charges, L, alpha1, r_c, K_max)\n    U_tot_alpha2 = calculate_total_ewald(positions, charges, L, alpha2, r_c, K_max)\n    residual_5 = np.abs(U_tot_alpha1 - U_tot_alpha2)\n    results.append(residual_5)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3418808"}]}