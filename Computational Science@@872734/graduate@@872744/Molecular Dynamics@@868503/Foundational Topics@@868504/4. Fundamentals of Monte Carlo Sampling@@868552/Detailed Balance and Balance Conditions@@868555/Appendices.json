{"hands_on_practices": [{"introduction": "The Metropolis-Hastings algorithm is a cornerstone of modern simulation, but its power lies in its generality beyond symmetric proposals. This exercise provides fundamental practice in deriving the correct acceptance rule from the principle of detailed balance when faced with an asymmetric proposal distribution [@problem_id:3407505]. Mastering this derivation is key to correctly implementing and modifying a wide range of Monte Carlo methods used in molecular dynamics.", "problem": "A practitioner is using a Markov Chain Monte Carlo (MCMC) move embedded in a molecular dynamics workflow to sample the canonical ensemble of a system at temperature $T$. Let $E_i$ denote the energy of state $i$ and let $\\beta = 1/(k_B T)$ be the inverse thermal energy, where $k_B$ is the Boltzmann constant. Define the reduced energy $u_i = \\beta E_i$, so that the target equilibrium distribution is $\\pi(i) \\propto \\exp(-u_i)$.\n\nThe practitioner employs a state-dependent proposal mechanism $Q(i \\to j)$ to generate trial moves from state $i$ to state $j$, followed by an acceptance step $A(i \\to j)$, resulting in the one-step transition probability $W(i \\to j) = Q(i \\to j) A(i \\to j)$. Currently, the acceptance rule used is the symmetric Metropolis form $A_{\\mathrm{sym}}(i \\to j) = \\min\\{1, \\exp[-(u_j - u_i)]\\}$, which assumes symmetric proposals. However, the actual proposal probabilities are asymmetric.\n\nConsider two states with reduced energies $u_1 = 0$ and $u_2 = 1.3$. The proposal probabilities are $Q(1 \\to 2) = 0.80$ and $Q(2 \\to 1) = 0.20$. The goal is to diagnose the detailed balance violation and construct a corrected acceptance rule that restores detailed balance with respect to the target distribution $\\pi(i) \\propto \\exp(-u_i)$.\n\nStarting from first principles of the canonical ensemble and the definition of detailed balance for Markov chains, derive the acceptance rule that enforces detailed balance for asymmetric proposals, and compute the corrected acceptance probability $A^{\\star}(1 \\to 2)$ for the transition from state $1$ to state $2$ using the given $u_1$, $u_2$, $Q(1 \\to 2)$, and $Q(2 \\to 1)$.\n\nRound your final numerical answer for $A^{\\star}(1 \\to 2)$ to four significant figures. The acceptance probability is dimensionless; do not include units.", "solution": "The problem requires the derivation of a corrected acceptance rule for a Markov Chain Monte Carlo (MCMC) simulation that restores detailed balance for an asymmetric proposal mechanism, and the calculation of a specific acceptance probability.\n\nFirst, we establish the fundamental principles. A sufficient condition for a Markov chain to sample from a target equilibrium distribution $\\pi(i)$ is that the transition probabilities $W(i \\to j)$ satisfy the detailed balance condition. This condition ensures that at equilibrium, the total probability flux from any state $i$ to any state $j$ is equal to the flux from $j$ to $i$. Mathematically, this is expressed as:\n$$ \\pi(i) W(i \\to j) = \\pi(j) W(j \\to i) $$\nfor all pairs of states $(i, j)$.\n\nIn the context of this problem, the one-step transition probability $W(i \\to j)$ is composed of two parts: a proposal step with probability $Q(i \\to j)$ and an acceptance step with probability $A(i \\to j)$. The composite probability is $W(i \\to j) = Q(i \\to j) A(i \\to j)$ for $i \\neq j$. Substituting this into the detailed balance equation gives:\n$$ \\pi(i) Q(i \\to j) A(i \\to j) = \\pi(j) Q(j \\to i) A(j \\to i) $$\nThis equation is the core constraint that any valid acceptance rule must satisfy.\n\nThe problem states that the practitioner is using the symmetric Metropolis acceptance rule, $A_{\\mathrm{sym}}(i \\to j) = \\min\\{1, \\exp[-(u_j - u_i)]\\}$. This rule is derived under the assumption of symmetric proposals, where $Q(i \\to j) = Q(j \\to i)$. If we make this assumption, the proposal probabilities cancel out in the detailed balance constraint, leaving $\\pi(i) A(i \\to j) = \\pi(j) A(j \\to i)$. The symmetric Metropolis rule satisfies this simplified condition. However, the problem specifies that the proposal probabilities are asymmetric, with $Q(1 \\to 2) = 0.80$ and $Q(2 \\to 1) = 0.20$. Using an acceptance rule that assumes symmetry when the proposals are asymmetric violates the detailed balance condition, and the Markov chain will not converge to the correct target distribution $\\pi(i)$. This is the flaw in the practitioner's current methodology.\n\nTo derive the correct acceptance rule, we must rearrange the full detailed balance constraint to solve for the ratio of the acceptance probabilities:\n$$ \\frac{A(i \\to j)}{A(j \\to i)} = \\frac{\\pi(j)}{\\pi(i)} \\frac{Q(j \\to i)}{Q(i \\to j)} $$\nThe target distribution is the canonical ensemble distribution, $\\pi(i) \\propto \\exp(-\\beta E_i)$, where $E_i$ is the energy of state $i$. Using the given reduced energy $u_i = \\beta E_i$, the distribution is $\\pi(i) \\propto \\exp(-u_i)$. The ratio of probabilities for two states is therefore:\n$$ \\frac{\\pi(j)}{\\pi(i)} = \\frac{\\exp(-u_j)}{\\exp(-u_i)} = \\exp(-u_j + u_i) = \\exp[-(u_j - u_i)] $$\nSubstituting this into the acceptance ratio equation yields:\n$$ \\frac{A(i \\to j)}{A(j \\to i)} = \\exp[-(u_j - u_i)] \\frac{Q(j \\to i)}{Q(i \\to j)} $$\nThis is the general constraint that the acceptance rule must satisfy for asymmetric proposals. The most common choice for the acceptance probability that satisfies this ratio while maximizing the acceptance rate (and thus the efficiency of the sampling) is the Metropolis-Hastings acceptance rule. Let the right-hand side of the constraint be denoted by $\\rho_{ij}$:\n$$ \\rho_{ij} = \\exp[-(u_j - u_i)] \\frac{Q(j \\to i)}{Q(i \\to j)} $$\nThe Metropolis-Hastings acceptance probability is then given by:\n$$ A^{\\star}(i \\to j) = \\min\\{1, \\rho_{ij}\\} $$\nThis is the corrected acceptance rule that enforces detailed balance for any proposal mechanism $Q(i \\to j)$, symmetric or not.\n\nNow, we apply this derived rule to compute the specific acceptance probability $A^{\\star}(1 \\to 2)$ for the transition from state $1$ to state $2$. The given values are:\n- Reduced energy of state 1: $u_1 = 0$\n- Reduced energy of state 2: $u_2 = 1.3$\n- Proposal probability from 1 to 2: $Q(1 \\to 2) = 0.80$\n- Proposal probability from 2 to 1: $Q(2 \\to 1) = 0.20$\n\nWe identify $i=1$ and $j=2$. The corrected acceptance probability $A^{\\star}(1 \\to 2)$ is:\n$$ A^{\\star}(1 \\to 2) = \\min\\left\\{1, \\exp[-(u_2 - u_1)] \\frac{Q(2 \\to 1)}{Q(1 \\to 2)}\\right\\} $$\nFirst, we compute the argument of the $\\min$ function. The energy difference term is:\n$$ \\exp[-(u_2 - u_1)] = \\exp[-(1.3 - 0)] = \\exp(-1.3) $$\nThe ratio of proposal probabilities is:\n$$ \\frac{Q(2 \\to 1)}{Q(1 \\to 2)} = \\frac{0.20}{0.80} = 0.25 $$\nCombining these terms, we find $\\rho_{12}$:\n$$ \\rho_{12} = \\exp(-1.3) \\times 0.25 $$\nThe value of $\\exp(-1.3)$ is approximately $0.27253179...$. Therefore:\n$$ \\rho_{12} \\approx 0.27253179 \\times 0.25 = 0.06813295 $$\nSince $\\rho_{12}$ is less than $1$, the acceptance probability is equal to $\\rho_{12}$:\n$$ A^{\\star}(1 \\to 2) = \\min\\{1, 0.06813295\\} = 0.06813295 $$\nThe problem requires the final answer to be rounded to four significant figures. Rounding $0.06813295$ to four significant figures gives $0.06813$.", "answer": "$$\\boxed{0.06813}$$", "id": "3407505"}, {"introduction": "Ideal simulation algorithms often operate under pristine theoretical conditions, but real-world applications, such as using forces from machine learning potentials, can introduce stochastic noise. This problem delves into the consequences of such noise on Hamiltonian dynamics, demonstrating how it breaks detailed balance and drives the system away from the target ensemble [@problem_id:3407518]. You will use the Fokker-Planck equation to diagnose the issue and derive the necessary fluctuation-dissipation relation to restore equilibrium, a critical skill in advanced algorithm development.", "problem": "Consider a single particle of mass $m$ moving in one spatial dimension with coordinate $x$ and momentum $p$ in a potential energy $U(x)$ at thermodynamic temperature $T$. The target equilibrium phase-space density is the Boltzmann distribution $\\pi(x,p) \\propto \\exp\\!\\big(-\\beta H(x,p)\\big)$ with inverse temperature $\\beta = 1/(k_B T)$, Boltzmann constant $k_B$, and Hamiltonian $H(x,p) = U(x) + p^2/(2m)$. Hamiltonian Monte Carlo (HMC) proposes moves by integrating Hamilton’s equations with a symplectic, reversible scheme, which preserves phase-space volume and (with a Metropolis accept/reject) detailed balance with respect to $\\pi(x,p)$.\n\nSuppose the force $-\\partial U/\\partial x$ is approximated during integration by a stochastic estimator whose error is modeled, in the small time-step limit, as additive Gaussian white noise in the momentum equation. Specifically, consider the stochastic differential equation (SDE)\n$$\n\\mathrm{d}x = \\frac{p}{m}\\,\\mathrm{d}t, \n\\qquad\n\\mathrm{d}p = -\\frac{\\partial U}{\\partial x}(x)\\,\\mathrm{d}t + \\sqrt{2\\,b}\\,\\mathrm{d}W_t,\n$$\nwhere $b > 0$ is a constant setting the strength of the force noise and $W_t$ is a standard Wiener process. \n\nUsing first principles:\n1. Derive the associated Fokker–Planck equation for the probability density $\\rho(x,p,t)$ and demonstrate, by direct substitution, whether the Boltzmann density $\\pi(x,p)$ is a stationary solution. Explain how this noisy forcing affects phase-space volume preservation and detailed balance in this context.\n2. To recover balance, consider augmenting the momentum dynamics with a linear friction term and a thermostat (Ornstein–Uhlenbeck type) noise,\n$$\n\\mathrm{d}p = -\\frac{\\partial U}{\\partial x}(x)\\,\\mathrm{d}t - \\gamma\\,p\\,\\mathrm{d}t + \\sqrt{2\\,\\alpha_{\\mathrm{th}}}\\,\\mathrm{d}B_t + \\sqrt{2\\,b}\\,\\mathrm{d}W_t,\n$$\nwhere $\\gamma \\ge 0$ is a constant friction coefficient, $\\alpha_{\\mathrm{th}} \\ge 0$ is a constant thermostat diffusion coefficient, and $B_t$ is an independent standard Wiener process. Derive, from the requirement that $\\pi(x,p)$ be stationary and that detailed balance hold with respect to $\\pi(x,p)$, a relation among $\\gamma$, $\\alpha_{\\mathrm{th}}$, and the physical parameters $m$, $k_B$, and $T$.\n\nFinally, determine the minimal friction coefficient $\\gamma_{\\min}$ for which one can choose a nonnegative $\\alpha_{\\mathrm{th}}$ to satisfy the stationarity and detailed balance conditions. Your final answer must be a single closed-form analytical expression for $\\gamma_{\\min}$ in terms of $b$, $m$, $k_B$, and $T$. Express the value of $\\gamma_{\\min}$ in units of $\\mathrm{s}^{-1}$. No numerical evaluation or rounding is required.", "solution": "### Part 1: Analysis of the Noisy Hamiltonian System\n\nThe system is described by the SDEs:\n$\\mathrm{d}x = \\frac{p}{m}\\,\\mathrm{d}t$\n$\\mathrm{d}p = -\\frac{\\partial U}{\\partial x}(x)\\,\\mathrm{d}t + \\sqrt{2\\,b}\\,\\mathrm{d}W_t$\n\nThis corresponds to a vector SDE with state vector $\\mathbf{X} = (x, p)^T$, drift vector $\\mathbf{A} = (\\frac{p}{m}, -\\frac{\\partial U}{\\partial x})^T$, and diffusion tensor $\\mathbf{D} = \\begin{pmatrix} 0 & 0 \\\\ 0 & 2b \\end{pmatrix}$. The associated Fokker-Planck equation for the probability density $\\rho(x,p,t)$ is:\n$$\n\\frac{\\partial \\rho}{\\partial t} = -\\frac{\\partial}{\\partial x}\\left(\\frac{p}{m}\\rho\\right) - \\frac{\\partial}{\\partial p}\\left(-\\frac{\\partial U}{\\partial x}\\rho\\right) + \\frac{1}{2}\\frac{\\partial^2}{\\partial p^2}(2b\\rho)\n$$\n$$\n\\frac{\\partial \\rho}{\\partial t} = -\\frac{\\partial}{\\partial x}\\left(\\frac{p}{m}\\rho\\right) + \\frac{\\partial}{\\partial p}\\left(\\frac{\\partial U}{\\partial x}\\rho\\right) + b\\frac{\\partial^2 \\rho}{\\partial p^2}\n$$\nTo check if the Boltzmann density $\\pi(x,p) \\propto \\exp(-\\beta H(x,p))$ is a stationary solution, we set $\\rho = \\pi$ and check if $\\frac{\\partial \\pi}{\\partial t} = 0$. The partial derivatives of $\\pi$ are $\\frac{\\partial \\pi}{\\partial x} = -\\beta \\frac{\\partial U}{\\partial x} \\pi$ and $\\frac{\\partial \\pi}{\\partial p} = -\\beta \\frac{p}{m} \\pi$. Substituting these into the stationary Fokker-Planck equation:\n$$\n0 \\stackrel{?}{=} -\\frac{\\partial}{\\partial x}\\left(\\frac{p}{m}\\pi\\right) + \\frac{\\partial}{\\partial p}\\left(\\frac{\\partial U}{\\partial x}\\pi\\right) + b\\frac{\\partial^2 \\pi}{\\partial p^2}\n$$\nThe first two terms on the right-hand side correspond to the Liouville operator acting on a function of the Hamiltonian, which is zero: $-\\{H,\\pi\\}=0$. The equation reduces to:\n$$\n0 \\stackrel{?}{=} b\\frac{\\partial^2 \\pi}{\\partial p^2} = b\\frac{\\partial}{\\partial p}\\left(-\\beta \\frac{p}{m}\\pi\\right) = b\\left(-\\frac{\\beta}{m} + \\frac{\\beta^2 p^2}{m^2}\\right)\\pi\n$$\nSince $b > 0$, this equality does not hold in general. Thus, $\\pi(x,p)$ is not a stationary solution. The stochastic term continuously injects energy into the system, acting as an uncompensated heating source. This breaks detailed balance and prevents equilibration. Pure Hamiltonian flow preserves phase-space volume ($\\nabla \\cdot \\mathbf{A} = 0$), but the addition of diffusion means the full process does not.\n\n### Part 2: Analysis of the Augmented System\n\nThe augmented SDE has a drift vector $\\mathbf{A'} = (\\frac{p}{m}, -\\frac{\\partial U}{\\partial x} - \\gamma p)^T$ and a total diffusion in the $p$-direction with coefficient $\\alpha_{\\mathrm{th}} + b$, so the diffusion tensor is $\\mathbf{D'} = \\begin{pmatrix} 0 & 0 \\\\ 0 & 2(\\alpha_{\\mathrm{th}} + b) \\end{pmatrix}$. The Fokker-Planck equation is:\n$$\n\\frac{\\partial \\rho}{\\partial t} = -\\frac{\\partial}{\\partial x}\\left(\\frac{p}{m}\\rho\\right) - \\frac{\\partial}{\\partial p}\\left(\\left[-\\frac{\\partial U}{\\partial x} - \\gamma p\\right]\\rho\\right) + (\\alpha_{\\mathrm{th}} + b)\\frac{\\partial^2 \\rho}{\\partial p^2}\n$$\nFor $\\pi$ to be a stationary solution, we require $\\partial \\pi / \\partial t = 0$. The equation can be split into the Liouville part, which is zero for $\\pi$, and the thermostat part, which must also be zero:\n$$\n\\frac{\\partial}{\\partial p}\\left(\\gamma p \\pi + (\\alpha_{\\mathrm{th}} + b)\\frac{\\partial \\pi}{\\partial p}\\right) = 0\n$$\nIntegrating with respect to $p$ and applying boundary conditions that probability current vanishes at $p \\to \\pm \\infty$, the term in the parenthesis must be zero:\n$$\n\\gamma p \\pi + (\\alpha_{\\mathrm{th}} + b)\\frac{\\partial \\pi}{\\partial p} = 0\n$$\nSubstituting $\\frac{\\partial \\pi}{\\partial p} = -\\beta \\frac{p}{m} \\pi$:\n$$\n\\gamma p \\pi + (\\alpha_{\\mathrm{th}} + b)\\left(-\\beta \\frac{p}{m} \\pi\\right) = 0\n$$\nFor this to hold for any $p \\neq 0$, the term in the brackets must be zero:\n$$\n\\gamma - \\frac{\\beta}{m}(\\alpha_{\\mathrm{th}} + b) = 0\n$$\nThis is the fluctuation-dissipation relation required for stationarity and detailed balance. It connects the friction $\\gamma$ (dissipation) to the total noise strength $\\alpha_{\\mathrm{th}} + b$ (fluctuation) and the temperature $T = 1/(k_B \\beta)$. The relation is:\n$$\n\\gamma = \\frac{\\alpha_{\\mathrm{th}} + b}{m k_B T}\n$$\n\n### Minimal Friction Coefficient $\\gamma_{\\min}$\n\nThe thermostat diffusion coefficient must be non-negative: $\\alpha_{\\mathrm{th}} \\ge 0$. To find the minimal friction $\\gamma_{\\min}$ that allows this, we rearrange the relation to solve for $\\alpha_{\\mathrm{th}}$:\n$$\n\\alpha_{\\mathrm{th}} = \\gamma m k_B T - b\n$$\nThe condition $\\alpha_{\\mathrm{th}} \\ge 0$ implies:\n$$\n\\gamma m k_B T - b \\ge 0\n$$\nSolving for $\\gamma$:\n$$\n\\gamma \\ge \\frac{b}{m k_B T}\n$$\nThe minimal value for the friction coefficient $\\gamma$ is therefore:\n$$\n\\gamma_{\\min} = \\frac{b}{m k_B T}\n$$\nThis is the minimal friction required to dissipate the energy injected by the stochastic force noise of strength $b$ to maintain the target temperature $T$.", "answer": "$$\\boxed{\\frac{b}{m k_B T}}$$", "id": "3407518"}, {"introduction": "Verifying that a simulation has truly reached equilibrium and satisfies detailed balance is a non-trivial task that requires sophisticated analysis of trajectory data. This practice introduces a powerful method based on graph theory to quantify the violation of detailed balance by detecting net probability currents in a discretized state space [@problem_id:3407510]. By computing cycle affinities, you will learn to diagnose non-equilibrium behavior and measure the statistical 'arrow of time' in your simulation data.", "problem": "Consider Molecular Dynamics (MD) trajectories that have been discretized into a finite state space. We observe a long sequence of transitions between states and record empirical transition counts. From these counts, construct an empirical time-homogeneous discrete-time Markov chain over the states. The concept of detailed balance in a Markov chain relates the equilibrium flows between states to symmetry; when detailed balance holds exactly, there are no net currents around any cycle in the state graph. When detailed balance is violated, there exist non-zero net currents and non-zero cycle affinities. Your task is to implement a program that, for a given set of empirical transition count matrices at different sampling time steps, measures the degree of detailed balance violation by computing the largest cycle affinity magnitude on the directed graph induced by the observed transitions.\n\nStart from the following conceptual bases:\n- Use the definition of a discrete-time Markov chain with transition matrix $P$ and a stationary distribution vector $\\pi$ that satisfies $ \\pi^{\\top} P = \\pi^{\\top} $ with $ \\sum_i \\pi_i = 1 $ and $ \\pi_i \\ge 0 $.\n- Detailed balance requires $ \\pi_i P_{ij} = \\pi_j P_{ji} $ for all directed edges $ i \\to j $ that have non-zero probability.\n- Net currents and cycle affinities are the appropriate constructs for detecting and quantifying detailed balance violations. In particular, edge-wise net currents and cycle-wise affinities should be derived purely from first principles starting with the above definitions, without using any pre-provided shortcut formulas.\n\nProgram requirements:\n1. For each provided test case, you must:\n   - Convert the empirical transition count matrix $C$ into a row-stochastic transition probability matrix $P$ by normalizing each row to sum to $1$.\n   - Estimate a stationary distribution $ \\pi $ satisfying $ \\pi^{\\top} P = \\pi^{\\top} $ using a numerically stable method that converges to a legitimate stationary distribution.\n   - Construct the directed graph over states using edges $ i \\to j $ for which the empirical counts $ C_{ij} $ are strictly positive and $ i \\ne j $.\n   - Enumerate all simple directed cycles with length at least $3$ in this graph. A simple directed cycle is a sequence of distinct nodes $ (v_0, v_1, \\dots, v_{k-1}) $ with $k \\ge 3$ such that the directed edges $ v_0 \\to v_1, v_1 \\to v_2, \\dots, v_{k-1} \\to v_0 $ all exist, and no node repeats within the sequence.\n   - For each such cycle, compute its cycle affinity as the signed sum of edge-wise affinities over the oriented cycle. To ensure scientific realism when an empirically observed reverse transition probability is zero, regularize your computation by adding a small positive pseudocount to numerator and denominator terms; use a fixed pseudocount of $ \\varepsilon = 10^{-12} $.\n   - Take the magnitude (absolute value) of each cycle’s affinity, and return the largest value found for the test case as a dimensionless float.\n2. Your program must implement the above steps independently for each test case, without external input or file access.\n3. Your program must produce a single line of output containing the results as a comma-separated list enclosed in square brackets (for example, \"[x_1,x_2,x_3]\"), where each entry is the largest cycle affinity magnitude for the corresponding test case, expressed as a float rounded to six decimal places.\n\nTest suite:\nUse the following four test cases, each defined by a sampling time step $ \\Delta t $ and a $4 \\times 4$ empirical transition count matrix $ C $ over states $ \\{0,1,2,3\\} $. All counts are dimensionless.\n\n- Case A (near detailed balance; small time step):\n  - $ \\Delta t = 0.01 $\n  - Rows of $ C $ in order $0,1,2,3$:\n    - Row for state $0$: to $0$ is $50$, to $1$ is $2500$, to $2$ is $50$, to $3$ is $2500$.\n    - Row for state $1$: to $0$ is $2500$, to $1$ is $50$, to $2$ is $2500$, to $3$ is $50$.\n    - Row for state $2$: to $0$ is $50$, to $1$ is $2500$, to $2$ is $50$, to $3$ is $2500$.\n    - Row for state $3$: to $0$ is $2500$, to $1$ is $50$, to $2$ is $2500$, to $3$ is $50$.\n\n- Case B (mild forward ring bias; moderate time step):\n  - $ \\Delta t = 0.1 $\n  - Rows of $ C $:\n    - Row for state $0$: to $0$ is $50$, to $1$ is $2600$, to $2$ is $50$, to $3$ is $2400$.\n    - Row for state $1$: to $0$ is $2400$, to $1$ is $50$, to $2$ is $2600$, to $3$ is $50$.\n    - Row for state $2$: to $0$ is $50$, to $1$ is $2400$, to $2$ is $50$, to $3$ is $2600$.\n    - Row for state $3$: to $0$ is $2600$, to $1$ is $50$, to $2$ is $2400$, to $3$ is $50$.\n\n- Case C (strong forward ring bias; larger time step):\n  - $ \\Delta t = 0.5 $\n  - Rows of $ C $:\n    - Row for state $0$: to $0$ is $50$, to $1$ is $3000$, to $2$ is $50$, to $3$ is $2000$.\n    - Row for state $1$: to $0$ is $2000$, to $1$ is $50$, to $2$ is $3000$, to $3$ is $50$.\n    - Row for state $2$: to $0$ is $50$, to $1$ is $2000$, to $2$ is $50$, to $3$ is $3000$.\n    - Row for state $3$: to $0$ is $3000$, to $1$ is $50$, to $2$ is $2000$, to $3$ is $50$.\n\n- Case D (extreme coarse sampling with missing reverse transitions; largest violation):\n  - $ \\Delta t = 1.0 $\n  - Rows of $ C $:\n    - Row for state $0$: to $0$ is $50$, to $1$ is $4000$, to $2$ is $50$, to $3$ is $0$.\n    - Row for state $1$: to $0$ is $0$, to $1$ is $50$, to $2$ is $4000$, to $3$ is $50$.\n    - Row for state $2$: to $0$ is $50$, to $1$ is $0$, to $2$ is $50$, to $3$ is $4000$.\n    - Row for state $3$: to $0$ is $4000$, to $1$ is $50$, to $2$ is $0$, to $3$ is $50$.\n\nCoverage rationale:\n- Case A is the \"happy path\" where detailed balance is nearly exact; the largest cycle affinity should be close to $0$.\n- Case B introduces a mild forward bias; the largest cycle affinity should be small but clearly non-zero.\n- Case C increases the bias; the largest cycle affinity should be noticeably larger.\n- Case D is an edge case with zeros in reverse transition counts; the pseudocount regularization is essential, and the largest cycle affinity should be significantly larger than in Case C.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, ordered as $[A,B,C,D]$ where each entry is the largest cycle affinity magnitude for Cases A, B, C, and D respectively, rounded to six decimal places (dimensionless).", "solution": "The problem requires the quantification of detailed balance violation in a discrete-time Markov chain derived from empirical transition counts. This is accomplished by computing the largest magnitude of cycle affinities on the state transition graph. The solution proceeds by first establishing the theoretical framework and then detailing the algorithmic implementation.\n\n**1. Theoretical Framework**\n\nLet the finite set of discretized states be $S = \\{0, 1, \\dots, N-1\\}$. The empirical data is given as a transition count matrix $C$, where $C_{ij}$ is the number of observed transitions from state $i$ to state $j$.\n\n**1.1. Transition Probability Matrix**\nA time-homogeneous discrete-time Markov chain is constructed from these counts. The transition probability $P_{ij}$ from state $i$ to state $j$ is estimated by normalizing the counts in each row:\n$$P_{ij} = \\frac{C_{ij}}{\\sum_{k=0}^{N-1} C_{ik}}$$\nThis ensures that $P$ is a row-stochastic matrix, i.e., $\\sum_j P_{ij} = 1$ for all $i$.\n\n**1.2. Stationary Distribution**\nThe stationary distribution $\\pi$ is a probability vector representing the equilibrium probability of occupying each state. It is defined by the property that it remains unchanged after one step of the Markov chain, which mathematically corresponds to being the left eigenvector of $P$ with an eigenvalue of $1$:\n$$\\pi^{\\top} P = \\pi^{\\top}$$\nAdditionally, it must be a valid probability distribution: $\\sum_{i=0}^{N-1} \\pi_i = 1$ and $\\pi_i \\ge 0$ for all $i$. For an irreducible and aperiodic Markov chain, this distribution is unique. We find $\\pi$ by computing the right eigenvector of the transpose matrix $P^{\\top}$ corresponding to the eigenvalue $1$.\n\n**1.3. Detailed Balance and Affinity**\nIn thermal equilibrium, a system is expected to satisfy the principle of detailed balance. For a Markov chain, this condition states that the equilibrium flux from state $i$ to state $j$ is equal to the flux from $j$ to $i$:\n$$\\pi_i P_{ij} = \\pi_j P_{ji}$$\nWhen this condition is violated, there is a net probability current between states. The degree of this violation for an edge $i \\to j$ can be quantified by the edge affinity, $a_{ij}$, defined as the logarithm of the ratio of forward to backward fluxes:\n$$a_{ij} = \\ln \\left( \\frac{\\pi_i P_{ij}}{\\pi_j P_{ji}} \\right)$$\n\n**1.4. Cycle Affinity**\nFor a simple directed cycle of states $(v_0, v_1, \\dots, v_{k-1})$ with $k \\ge 3$, the cycle affinity $\\mathcal{A}_{\\text{cycle}}$ is the sum of the edge affinities along the cycle:\n$$\\mathcal{A}_{\\text{cycle}} = \\sum_{l=0}^{k-1} a_{v_l, v_{l+1 \\pmod k}} = \\sum_{l=0}^{k-1} \\ln \\left( \\frac{\\pi_{v_l} P_{v_l, v_{l+1 \\pmod k}}}{\\pi_{v_{l+1 \\pmod k}} P_{v_{l+1 \\pmod k}, v_l}} \\right)$$\nUsing the properties of logarithms, this sum simplifies. The terms involving $\\pi$ form a telescoping sum that evaluates to zero: $\\sum_{l=0}^{k-1} (\\ln \\pi_{v_l} - \\ln \\pi_{v_{l+1 \\pmod k}}) = 0$. This leaves the fundamental definition of cycle affinity:\n$$\\mathcal{A}_{\\text{cycle}} = \\ln \\left( \\prod_{l=0}^{k-1} \\frac{P_{v_l, v_{l+1 \\pmod k}}}{P_{v_{l+1 \\pmod k}, v_l}} \\right)$$\nThis expression represents the log-ratio of the probability of traversing the cycle in the forward direction versus the reverse direction. If detailed balance holds for all edges in the cycle, the affinity is zero. A non-zero affinity indicates a net circulation or current around the cycle, a definitive signature of non-equilibrium dynamics.\n\n**1.5. Regularization**\nEmpirical data may yield zero counts for certain transitions, i.e., $C_{ji}=0$, leading to $P_{ji}=0$. This makes the affinity calculation diverge. To ensure numerical stability and handle such cases realistically, we regularize the flux terms. As specified, we add a small pseudocount $\\varepsilon = 10^{-12}$ to each flux term before taking the logarithm. The regularized edge affinity is:\n$$a_{ij} = \\ln \\left( \\frac{\\pi_i P_{ij} + \\varepsilon}{\\pi_j P_{ji} + \\varepsilon} \\right)$$\nThe cycle affinity is then the sum of these regularized edge affinities. This approach is taken as it directly follows the instruction to sum \"edge-wise affinities\".\n\n**2. Algorithmic Implementation**\n\nThe overall algorithm proceeds as follows for each test case:\n\n1.  **Matrix Normalization**: The input count matrix $C$ is converted to the row-stochastic transition matrix $P$.\n\n2.  **Stationary Distribution Calculation**: The stationary distribution $\\pi$ is found by computing the eigenvectors of $P^{\\top}$ using a numerical library function (`numpy.linalg.eig`). The eigenvector corresponding to the eigenvalue closest to $1$ is selected. Its real part is taken and normalized to sum to $1$.\n\n3.  **Graph Construction**: A directed graph is constructed from the states, where an edge $i \\to j$ exists if $C_{ij} > 0$ and $i \\neq j$. An adjacency list is a suitable representation.\n\n4.  **Cycle Enumeration**: All simple directed cycles of length $3$ or greater are enumerated using a backtracking depth-first search (DFS) algorithm. The search starts from each node and explores paths, marking visited nodes to ensure simplicity. When a path returns to its starting node, a cycle is detected. To avoid processing duplicate cycles (e.g., $0 \\to 1 \\to 2 \\to 0$ and $1 \\to 2 \\to 0 \\to 1$), discovered cycles are normalized (e.g., by rotation and storing in a set) to obtain a unique set.\n\n5.  **Affinity Computation**: For each unique cycle, its affinity is computed by summing the regularized edge affinities as defined above.\n\n6.  **Maximum Affinity Magnitude**: The absolute value of each cycle's affinity is calculated, and the maximum among all cycles is retained. If no cycles are found, the result is $0.0$. This final value serves as the metric for the overall violation of detailed balance for the given system.", "answer": "[0.000000,0.160132,0.405465,2.449629]", "id": "3407510"}]}