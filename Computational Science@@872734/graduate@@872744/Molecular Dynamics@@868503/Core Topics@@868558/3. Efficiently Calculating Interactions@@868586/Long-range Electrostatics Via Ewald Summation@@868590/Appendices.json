{"hands_on_practices": [{"introduction": "To effectively use Ewald summation, one must first understand the structure of its reciprocal-space component. The calculation involves a sum over reciprocal lattice vectors $\\mathbf{k}$, but not all vectors contribute. This exercise [@problem_id:3422408] challenges you to derive this from first principles by computing the structure factor, $S(\\mathbf{k})$, for a classic rock-salt crystal. By analyzing how the specific arrangement of positive and negative charges causes cancellations, you will gain a fundamental insight into the connection between real-space structure and reciprocal-space representation.", "problem": "In the reciprocal-space part of Ewald summation for a periodic molecular dynamics simulation, the reciprocal-space structure factor for a set of point charges is defined by $S(\\mathbf{k})=\\sum_{j=1}^{N} q_{j}\\exp\\!\\left(i\\,\\mathbf{k}\\cdot\\mathbf{r}_{j}\\right)$, where $q_{j}$ are charges and $\\mathbf{r}_{j}$ are their positions in the unit cell of side length $a$. Consider a conventional rock-salt unit cell constructed as follows: an underlying face-centered cubic lattice with four lattice points at fractional coordinates $(0,0,0)$, $(0,\\tfrac{1}{2},\\tfrac{1}{2})$, $(\\tfrac{1}{2},0,\\tfrac{1}{2})$, $(\\tfrac{1}{2},\\tfrac{1}{2},0)$ in units of $a$, occupied by charges $+q$, and a second, interpenetrating face-centered cubic lattice obtained by a basis shift $\\mathbf{d}=(\\tfrac{1}{2},\\tfrac{1}{2},\\tfrac{1}{2})$ (in units of $a$), occupied by charges $-q$. Thus the unit cell contains $8$ charges at positions $\\mathbf{R}_{\\alpha}$ with $\\alpha=1,\\dots,8$, four with charge $+q$ at $\\mathbf{R}_{1}=(0,0,0)$, $\\mathbf{R}_{2}=(0,\\tfrac{1}{2},\\tfrac{1}{2})$, $\\mathbf{R}_{3}=(\\tfrac{1}{2},0,\\tfrac{1}{2})$, $\\mathbf{R}_{4}=(\\tfrac{1}{2},\\tfrac{1}{2},0)$, and four with charge $-q$ at $\\mathbf{R}_{5}=\\mathbf{R}_{1}+\\mathbf{d}$, $\\mathbf{R}_{6}=\\mathbf{R}_{2}+\\mathbf{d}$, $\\mathbf{R}_{7}=\\mathbf{R}_{3}+\\mathbf{d}$, $\\mathbf{R}_{8}=\\mathbf{R}_{4}+\\mathbf{d}$. The reciprocal lattice vectors of the periodic simulation box are $\\mathbf{k}=\\frac{2\\pi}{a}(h,k,l)$ with integers $h,k,l$.\n\nUsing only the definition of $S(\\mathbf{k})$, compute $S(\\mathbf{k})$ explicitly for the six smallest nonzero reciprocal vectors of the cubic reciprocal lattice, namely $\\mathbf{k}=\\frac{2\\pi}{a}(1,0,0)$, $\\mathbf{k}=\\frac{2\\pi}{a}(-1,0,0)$, $\\mathbf{k}=\\frac{2\\pi}{a}(0,1,0)$, $\\mathbf{k}=\\frac{2\\pi}{a}(0,-1,0)$, $\\mathbf{k}=\\frac{2\\pi}{a}(0,0,1)$, $\\mathbf{k}=\\frac{2\\pi}{a}(0,0,-1)$, and from those results infer the smallest nonzero magnitude $|\\mathbf{k}|$ for which $S(\\mathbf{k})\\neq 0$.\n\nAnswer format requirement: Report the final answer as the single dimensionless number equal to $|\\mathbf{k}_{\\min}|/(2\\pi/a)$. Do not include any units. No rounding is required; provide the exact value.", "solution": "The problem asks for the computation of the reciprocal-space structure factor $S(\\mathbf{k})$ for a specific crystal structure and a given set of reciprocal lattice vectors, and then to infer the smallest nonzero magnitude $|\\mathbf{k}|$ for which $S(\\mathbf{k})$ is nonzero.\n\nFirst, we validate the problem statement.\n\n### Step 1: Extract Givens\n-   The structure factor is defined as $S(\\mathbf{k})=\\sum_{j=1}^{N} q_{j}\\exp(i\\,\\mathbf{k}\\cdot\\mathbf{r}_{j})$.\n-   The system is a rock-salt unit cell with side length $a$.\n-   There are $N=8$ point charges in the unit cell.\n-   Four charges of $+q$ are located at positions corresponding to an FCC lattice: $\\mathbf{R}_{1}=a(0,0,0)$, $\\mathbf{R}_{2}=a(0,\\tfrac{1}{2},\\tfrac{1}{2})$, $\\mathbf{R}_{3}=a(\\tfrac{1}{2},0,\\tfrac{1}{2})$, and $\\mathbf{R}_{4}=a(\\tfrac{1}{2},\\tfrac{1}{2},0)$.\n-   Four charges of $-q$ are located at positions shifted by a basis vector $\\mathbf{d}=a(\\tfrac{1}{2},\\tfrac{1}{2},\\tfrac{1}{2})$ from the first set: $\\mathbf{R}_{j+4} = \\mathbf{R}_j + \\mathbf{d}$ for $j=1,2,3,4$.\n-   The reciprocal lattice vectors are given by $\\mathbf{k}=\\frac{2\\pi}{a}(h,k,l)$, where $h, k, l$ are integers.\n-   The specific task is to compute $S(\\mathbf{k})$ for the six vectors: $\\mathbf{k}=\\frac{2\\pi}{a}(\\pm 1,0,0)$, $\\mathbf{k}=\\frac{2\\pi}{a}(0,\\pm 1,0)$, and $\\mathbf{k}=\\frac{2\\pi}{a}(0,0,\\pm 1)$.\n-   From these results, we must infer the smallest nonzero magnitude $|\\mathbf{k}|$ for which $S(\\mathbf{k})\\neq 0$.\n-   The final answer should be the dimensionless value $|\\mathbf{k}_{\\min}|/(2\\pi/a)$.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is scientifically grounded, well-posed, and objective. It describes a standard calculation in solid-state physics for the structure factor of a classic ionic crystal (rock-salt structure). The definitions, positions, and lattice vectors are standard and self-consistent. The total charge of the unit cell is $4(+q) + 4(-q) = 0$, which is a necessary condition for the stability of a periodic ionic system. There are no contradictions, ambiguities, or missing information. The problem is valid.\n\n### Solution Derivation\n\nWe begin by writing out the full expression for the structure factor $S(\\mathbf{k})$ for the $N=8$ charges in the unit cell. We can group the summation into two parts: one for the four positive charges (denoted by positions $\\mathbf{c}_j$) and one for the four negative charges (denoted by positions $\\mathbf{a}_j$).\n$$S(\\mathbf{k}) = \\sum_{j=1}^{4} (+q) \\exp(i\\mathbf{k}\\cdot\\mathbf{c}_j) + \\sum_{j=1}^{4} (-q) \\exp(i\\mathbf{k}\\cdot\\mathbf{a}_j)$$\nwhere $\\mathbf{c}_j$ are the positions $\\mathbf{R}_1, \\dots, \\mathbf{R}_4$ and $\\mathbf{a}_j = \\mathbf{c}_j + \\mathbf{d}$. Substituting this relationship gives:\n$$S(\\mathbf{k}) = q \\sum_{j=1}^{4} \\exp(i\\mathbf{k}\\cdot\\mathbf{c}_j) - q \\sum_{j=1}^{4} \\exp(i\\mathbf{k}\\cdot(\\mathbf{c}_j + \\mathbf{d}))$$\nWe can factor out the term involving $\\mathbf{d}$ from the second sum:\n$$S(\\mathbf{k}) = q \\sum_{j=1}^{4} \\exp(i\\mathbf{k}\\cdot\\mathbf{c}_j) - q \\exp(i\\mathbf{k}\\cdot\\mathbf{d}) \\sum_{j=1}^{4} \\exp(i\\mathbf{k}\\cdot\\mathbf{c}_j)$$\nFactoring out the common summation term yields:\n$$S(\\mathbf{k}) = q \\left( 1 - \\exp(i\\mathbf{k}\\cdot\\mathbf{d}) \\right) \\left( \\sum_{j=1}^{4} \\exp(i\\mathbf{k}\\cdot\\mathbf{c}_j) \\right)$$\nThis expression separates the structure factor into two components:\n1.  A \"basis\" factor, $S_{basis}(\\mathbf{k}) = 1 - \\exp(i\\mathbf{k}\\cdot\\mathbf{d})$.\n2.  A \"geometric\" structure factor for the underlying FCC lattice, $S_{FCC}(\\mathbf{k}) = \\sum_{j=1}^{4} \\exp(i\\mathbf{k}\\cdot\\mathbf{c}_j)$.\n\nLet's analyze each factor in terms of the Miller indices $(h,k,l)$ of the reciprocal lattice vector $\\mathbf{k}=\\frac{2\\pi}{a}(h,k,l)$.\n\nFirst, the geometric structure factor $S_{FCC}(\\mathbf{k})$. The positions are $\\mathbf{c}_1=a(0,0,0)$, $\\mathbf{c}_2=a(0,1/2,1/2)$, $\\mathbf{c}_3=a(1/2,0,1/2)$, $\\mathbf{c}_4=a(1/2,1/2,0)$. The dot products $\\mathbf{k}\\cdot\\mathbf{c}_j$ are:\n$\\mathbf{k}\\cdot\\mathbf{c}_1 = 0$\n$\\mathbf{k}\\cdot\\mathbf{c}_2 = \\frac{2\\pi}{a}(h,k,l) \\cdot a(0,1/2,1/2) = \\pi(k+l)$\n$\\mathbf{k}\\cdot\\mathbf{c}_3 = \\frac{2\\pi}{a}(h,k,l) \\cdot a(1/2,0,1/2) = \\pi(h+l)$\n$\\mathbf{k}\\cdot\\mathbf{c}_4 = \\frac{2\\pi}{a}(h,k,l) \\cdot a(1/2,1/2,0) = \\pi(h+k)$\n\nThus, the geometric structure factor is:\n$$S_{FCC}(\\mathbf{k}) = \\exp(i \\cdot 0) + \\exp(i\\pi(k+l)) + \\exp(i\\pi(h+l)) + \\exp(i\\pi(h+k))$$\n$$S_{FCC}(\\mathbf{k}) = 1 + (-1)^{k+l} + (-1)^{h+l} + (-1)^{h+k}$$\nThis sum is non-zero only if the indices $(h,k,l)$ have unmixed parity (i.e., they are all even or all odd). In that case, $S_{FCC}(\\mathbf{k}) = 1+1+1+1 = 4$. If the parity is mixed, the sum is $0$.\n\nNext, we analyze the basis factor $S_{basis}(\\mathbf{k})$. With $\\mathbf{d} = a(1/2,1/2,1/2)$, the dot product is:\n$$\\mathbf{k}\\cdot\\mathbf{d} = \\frac{2\\pi}{a}(h,k,l) \\cdot a(1/2,1/2,1/2) = \\pi(h+k+l)$$\nSo, the basis factor is:\n$$S_{basis}(\\mathbf{k}) = 1 - \\exp(i\\pi(h+k+l)) = 1 - (-1)^{h+k+l}$$\nThis factor is non-zero only if $h+k+l$ is an odd integer. In this case, $S_{basis}(\\mathbf{k}) = 1 - (-1) = 2$. If $h+k+l$ is an even integer, $S_{basis}(\\mathbf{k}) = 1-1=0$.\n\nFor the total structure factor $S(\\mathbf{k}) = q \\cdot S_{basis}(\\mathbf{k}) \\cdot S_{FCC}(\\mathbf{k})$ to be non-zero, both factors must be non-zero. Let's combine the conditions:\n1.  $S_{FCC}(\\mathbf{k}) \\neq 0$: The indices $(h,k,l)$ must be all even or all odd.\n2.  $S_{basis}(\\mathbf{k}) \\neq 0$: The sum $h+k+l$ must be odd.\n\n-   If $(h,k,l)$ are all even, their sum $h+k+l$ is also even. This makes $S_{basis}(\\mathbf{k}) = 0$, so $S(\\mathbf{k})=0$.\n-   If $(h,k,l)$ are all odd, their sum $h+k+l = (2n_h+1) + (2n_k+1) + (2n_l+1) = 2(n_h+n_k+n_l)+3$ is odd. In this case, $S_{FCC}(\\mathbf{k})=4$ and $S_{basis}(\\mathbf{k})=2$. Both conditions are satisfied, and $S(\\mathbf{k}) = q(2)(4) = 8q \\neq 0$.\n-   If $(h,k,l)$ have mixed parity, $S_{FCC}(\\mathbf{k})=0$, so $S(\\mathbf{k})=0$.\n\nTherefore, the condition for a non-zero structure factor $S(\\mathbf{k})$ for the rock-salt lattice is that the Miller indices $(h,k,l)$ must all be odd integers.\n\nNow, we compute $S(\\mathbf{k})$ for the six specified reciprocal vectors. These vectors correspond to the Miller indices $(\\pm 1,0,0)$, $(0,\\pm 1,0)$, and $(0,0,\\pm 1)$.\nFor $\\mathbf{k}=\\frac{2\\pi}{a}(1,0,0)$, the indices are $(h,k,l)=(1,0,0)$. These indices have mixed parity (one odd, two even). According to our derived selection rule, $S(\\mathbf{k})$ must be $0$. The same logic applies to all six vectors, as each has one index equal to $\\pm 1$ and two indices equal to $0$. Thus, for all six specified vectors, $S(\\mathbf{k})=0$.\n\nThe problem then asks us to infer the smallest nonzero magnitude $|\\mathbf{k}|$ for which $S(\\mathbf{k})\\neq 0$. This requires finding the set of all-odd integers $(h,k,l)$ that minimizes the magnitude of $\\mathbf{k}$. The magnitude squared is given by:\n$$|\\mathbf{k}|^2 = \\left(\\frac{2\\pi}{a}\\right)^2 (h^2+k^2+l^2)$$\nTo minimize $|\\mathbf{k}|$, we must minimize the sum of squares $h^2+k^2+l^2$, under the constraint that $h, k, l$ are all non-zero odd integers. The smallest magnitude odd integers are $\\pm 1$. Choosing $h, k, l$ from the set $\\{\\pm 1\\}$ gives the smallest possible non-zero sum of squares.\nFor example, for $(h,k,l)=(1,1,1)$, the sum is $1^2+1^2+1^2=3$. Any other combination of all-odd integers (e.g., involving $\\pm 3$) would result in a larger sum (e.g., $1^2+1^2+3^2 = 11$).\nThe minimum value of $h^2+k^2+l^2$ subject to the condition is $3$.\n\nThe smallest nonzero magnitude $|\\mathbf{k}_{\\min}|$ is therefore:\n$$|\\mathbf{k}_{\\min}| = \\sqrt{\\left(\\frac{2\\pi}{a}\\right)^2 \\cdot 3} = \\frac{2\\pi}{a}\\sqrt{3}$$\nThe final answer required is the dimensionless number $|\\mathbf{k}_{\\min}|/(2\\pi/a)$:\n$$\\frac{|\\mathbf{k}_{\\min}|}{2\\pi/a} = \\frac{\\frac{2\\pi}{a}\\sqrt{3}}{\\frac{2\\pi}{a}} = \\sqrt{3}$$", "answer": "$$\\boxed{\\sqrt{3}}$$", "id": "3422408"}, {"introduction": "Moving from analytical theory to computational practice, the Particle-Mesh Ewald (PME) method solves the Poisson equation on a grid using Fast Fourier Transforms (FFTs). This practice [@problem_id:3422400] provides hands-on experience by guiding you to build a 1D periodic Poisson solver, the core engine of PME. You will explore the crucial and often confusing ambiguity of the $k=0$ Fourier mode, connecting this mathematical choice to the physical definition of the electrostatic potential's reference, such as the \"tin-foil\" or \"vacuum\" boundary conditions commonly found in simulation software.", "problem": "Consider a one-dimensional, planar-averaged electrostatic problem representative of a molecular dynamics water slab under Periodic Boundary Conditions (PBC). Let the unit cell of length $L$ along the $z$-axis contain a charge density profile $\\rho(z)$ that is periodic with period $L$, neutral over one period, and localized such that there exist subregions interpretable as \"bulk water\" and \"vacuum gap\". The electrostatic potential $\\phi(z)$ is defined by the Poisson equation\n$$\n\\frac{d^2 \\phi(z)}{dz^2} = -\\frac{\\rho(z)}{\\varepsilon_0},\n$$\nwhere $\\varepsilon_0$ is the vacuum permittivity in the International System of Units (SI). Under PBC, one may represent $\\phi(z)$ and $\\rho(z)$ by their Fourier series. In Ewald summation, the reciprocal-space solution for $\\phi(z)$ involves all wavevectors except the zero-wavevector term $k=0$. The treatment of the $k=0$ term sets the reference of the potential and is physically linked to the macroscopic boundary condition (e.g., conducting \"tin-foil\" boundary versus vacuum boundary).\n\nYour task is to derive, from first principles, the relation between the choice of $k=0$ treatment and the spatial average of the potential $\\langle \\phi \\rangle$, and to demonstrate numerically how this choice shifts the reported \"surface potential of water\", defined here as the bulk-water potential reported relative to a chosen reference. Specifically:\n\n1. Starting from the Fourier representation of the Poisson equation under PBC, show that the Fourier component at $k=0$ corresponds to a constant offset in $\\phi(z)$, and that setting the $k=0$ component to zero enforces $\\langle \\phi \\rangle = 0$. This choice corresponds to the standard \"tin-foil\" convention in Ewald summation.\n\n2. Show that any other choice of the $k=0$ component adds a constant $c$ to $\\phi(z)$, so that $\\langle \\phi \\rangle = c$, and the reported bulk-water potential relative to the chosen reference is shifted by $c$. In a vacuum-referenced convention for a slab with a vacuum gap, one sets $\\phi(z_\\text{vac}) = 0$ in a vacuum subregion $z \\in \\mathcal{V}$ by choosing $c = -\\phi_\\text{tin}(z_\\text{vac})$, where $\\phi_\\text{tin}(z)$ is the potential computed with $k=0$ set to zero.\n\n3. Implement a numerical solver for the one-dimensional periodic Poisson equation using a Fast Fourier Transform (FFT) to compute $\\phi(z)$ from $\\rho(z)$ with the $k=0$ mode excluded (tin-foil). Then form the vacuum-referenced potential by adding a constant chosen to set the mean potential over a designated vacuum window to zero. Your solver must compute the reported bulk-water potential under both references and output the shift between them, which equals the reference constant $c$.\n\nUse the following physically plausible test suite of charge densities, all neutral over the unit cell:\n\n- Test case 1 (balanced double layer, near-symmetric): $L = 5.0 \\times 10^{-9}\\ \\text{m}$, $N = 2048$ grid points, $\\sigma = 0.2 \\times 10^{-9}\\ \\text{m}$, amplitude $A = 1.0 \\times 10^{6}\\ \\text{C/m}^3$, and\n$$\n\\rho(z) = A \\left[ \\exp\\!\\left(-\\frac{(z - z_1)^2}{2\\sigma^2}\\right) - \\exp\\!\\left(-\\frac{(z - z_2)^2}{2\\sigma^2}\\right) \\right],\n$$\nwith $z_1 = 2.0 \\times 10^{-9}\\ \\text{m}$ and $z_2 = 3.0 \\times 10^{-9}\\ \\text{m}$. Define the vacuum window $\\mathcal{V}$ as $z \\in [0.0, 0.5] \\times 10^{-9}\\ \\text{m}$ and the bulk-water window $\\mathcal{B}$ as $z \\in [2.4, 2.6] \\times 10^{-9}\\ \\text{m}$.\n\n- Test case 2 (asymmetric dipole-like slab): Same $L$, $N$, and $\\sigma$, amplitude $A = 1.5 \\times 10^{6}\\ \\text{C/m}^3$, with $z_1 = 1.8 \\times 10^{-9}\\ \\text{m}$ and $z_2 = 3.2 \\times 10^{-9}\\ \\text{m}$. Use $\\mathcal{V}$ as $z \\in [0.0, 0.5] \\times 10^{-9}\\ \\text{m}$ and $\\mathcal{B}$ as $z \\in [2.45, 2.55] \\times 10^{-9}\\ \\text{m}$.\n\n- Test case 3 (no charges, edge case): Same $L$, $N$, and $\\sigma$, amplitude $A = 0\\ \\text{C/m}^3$, with any $z_1$ and $z_2$ (irrelevant). Use the same $\\mathcal{V}$ and $\\mathcal{B}$ windows as in test case 1.\n\nAlgorithmic requirements:\n\n- Compute the discrete Fourier transform of $\\rho(z)$ over the unit cell using the Fast Fourier Transform (FFT), and solve for $\\phi(k)$ in Fourier space via\n$$\n\\phi(k) = \\frac{\\rho(k)}{\\varepsilon_0 k^2},\\quad k \\neq 0,\n$$\nwith $\\phi(k=0) = 0$ for the tin-foil treatment. Then obtain $\\phi(z)$ via inverse FFT. Use $\\varepsilon_0 = 8.854187817 \\times 10^{-12}\\ \\text{F/m}$.\n\n- Construct the vacuum-referenced potential by adding a constant $c$ such that the mean potential over the vacuum window $\\mathcal{V}$ equals zero. The reported bulk-water potential under tin-foil is the mean over $\\mathcal{B}$ of $\\phi_\\text{tin}(z)$, and under vacuum reference it is the mean over $\\mathcal{B}$ of $\\phi_\\text{tin}(z) + c$.\n\n- Your program must compute, for each test case, a single float equal to the difference between the reported bulk-water potential under vacuum reference and under tin-foil reference. This difference equals the constant $c$ and is the shift induced by the $k=0$ treatment.\n\nOutput specification:\n\n- Express all potentials in volts (V), and output the three shifts as floats rounded to six decimal places.\n\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,result3]\").\n\nScientific realism and derivation constraints:\n\n- Begin the derivation from the Poisson equation and the definition of Fourier series under PBC.\n\n- Do not provide shortcut formulas for the answer; the derivation should logically connect the $k=0$ treatment to the spatial average $\\langle \\phi \\rangle$ and to the reported surface potential shift.\n\n- Ensure all entities in the derivation are well-defined within the above physics and mathematics.\n\nYour final submitted answer must be a complete, runnable Python program that implements the solver and produces the specified output format without requiring any user input.", "solution": "The problem asks for a derivation of the relationship between the treatment of the $k=0$ Fourier mode in a one-dimensional periodic Poisson problem and the resulting electrostatic potential's spatial average. Further, it requires a numerical implementation to calculate the potential shift for a water slab model under different reference conventions.\n\n**Derivation from First Principles**\n\nWe begin with the one-dimensional Poisson equation for the electrostatic potential $\\phi(z)$ generated by a charge density $\\rho(z)$ in a system with periodic boundary conditions over a domain of length $L$:\n$$\n\\frac{d^2 \\phi(z)}{dz^2} = -\\frac{\\rho(z)}{\\varepsilon_0}\n$$\nwhere $\\varepsilon_0$ is the vacuum permittivity. Since $\\phi(z)$ and $\\rho(z)$ are periodic with period $L$, they can be expressed as Fourier series:\n$$\n\\phi(z) = \\sum_{n=-\\infty}^{\\infty} \\phi_n e^{i k_n z} \\quad \\text{and} \\quad \\rho(z) = \\sum_{n=-\\infty}^{\\infty} \\rho_n e^{i k_n z}\n$$\nThe wavevectors are given by $k_n = \\frac{2\\pi n}{L}$ for integer $n$. The Fourier coefficients, $\\phi_n$ and $\\rho_n$, are defined as:\n$$\n\\phi_n = \\frac{1}{L} \\int_0^L \\phi(z) e^{-i k_n z} dz \\quad \\text{and} \\quad \\rho_n = \\frac{1}{L} \\int_0^L \\rho(z) e^{-i k_n z} dz\n$$\nTo transform the Poisson equation into Fourier space, we find the series representation for the second derivative of $\\phi(z)$:\n$$\n\\frac{d^2 \\phi(z)}{dz^2} = \\frac{d^2}{dz^2} \\left( \\sum_{n=-\\infty}^{\\infty} \\phi_n e^{i k_n z} \\right) = \\sum_{n=-\\infty}^{\\infty} (i k_n)^2 \\phi_n e^{i k_n z} = \\sum_{n=-\\infty}^{\\infty} -k_n^2 \\phi_n e^{i k_n z}\n$$\nSubstituting the series for $\\phi(z)$ and $\\rho(z)$ into the Poisson equation, we obtain:\n$$\n\\sum_{n=-\\infty}^{\\infty} -k_n^2 \\phi_n e^{i k_n z} = -\\frac{1}{\\varepsilon_0} \\sum_{n=-\\infty}^{\\infty} \\rho_n e^{i k_n z}\n$$\nBy the uniqueness of Fourier coefficients, we can equate the terms for each value of $n$:\n$$\n-k_n^2 \\phi_n = -\\frac{\\rho_n}{\\varepsilon_0}\n$$\nFor all non-zero wavevectors, i.e., $k_n \\neq 0$ ($n \\neq 0$), we can solve for the potential coefficients $\\phi_n$:\n$$\n\\phi_n = \\frac{\\rho_n}{\\varepsilon_0 k_n^2} \\quad (n \\neq 0)\n$$\n\n**The Role of the $k=0$ Mode**\n\nNow, we must consider the special case of the $k=0$ mode (i.e., $n=0$). For $n=0$, the wavevector is $k_0 = 0$. The equation becomes:\n$$\n-0^2 \\cdot \\phi_0 = -\\frac{\\rho_0}{\\varepsilon_0} \\implies 0 = \\rho_0\n$$\nThis implies that the Poisson equation is only consistent if the $n=0$ Fourier component of the charge density, $\\rho_0$, is zero. The $\\rho_0$ coefficient represents the average charge density over the unit cell:\n$$\n\\rho_0 = \\frac{1}{L} \\int_0^L \\rho(z) e^{-i (0) z} dz = \\frac{1}{L} \\int_0^L \\rho(z) dz = \\langle \\rho \\rangle\n$$\nThe problem states that the system is charge neutral, $\\int_0^L \\rho(z) dz = 0$, which ensures consistency by making $\\rho_0 = 0$. However, while consistent, the equation $0=0$ provides no information to determine the value of $\\phi_0$.\n\nThe $n=0$ coefficient of the potential, $\\phi_0$, is its spatial average over the unit cell:\n$$\n\\phi_0 = \\frac{1}{L} \\int_0^L \\phi(z) e^{-i (0) z} dz = \\frac{1}{L} \\int_0^L \\phi(z) dz = \\langle \\phi \\rangle\n$$\nThe ambiguity in $\\phi_0$ reflects the fact that the electrostatic potential is only defined up to an arbitrary constant. The choice of $\\phi_0$ sets this constant, thereby fixing the potential reference.\n\n**1. The \"Tin-Foil\" Convention and $\\langle \\phi \\rangle = 0$**\n\nThe standard Ewald summation convention for periodic systems, often called the \"tin-foil\" boundary condition, resolves this ambiguity by setting the $k=0$ component of the potential to zero:\n$$\n\\phi_0 = 0\n$$\nSince $\\phi_0 = \\langle \\phi \\rangle$, this choice is equivalent to enforcing that the average potential over the entire periodic cell is zero:\n$$\n\\langle \\phi \\rangle = 0\n$$\nThis choice defines a unique potential profile, which we denote as $\\phi_\\text{tin}(z)$. This completes the first part of the required demonstration.\n\n**2. General Potential Reference and the Shift Constant**\n\nAny other choice for the potential reference corresponds to choosing a non-zero value for $\\phi_0$. Let us set $\\phi_0 = c$, where $c$ is a constant. The potential $\\phi(z)$ can be written by separating the $n=0$ term from its Fourier series:\n$$\n\\phi(z) = \\phi_0 e^{i(0)z} + \\sum_{n \\neq 0} \\phi_n e^{i k_n z} = c + \\sum_{n \\neq 0} \\frac{\\rho_n}{\\varepsilon_0 k_n^2} e^{i k_n z}\n$$\nThe summation on the right-hand side is precisely the definition of the potential under the tin-foil convention, $\\phi_\\text{tin}(z)$ (for which $\\phi_0=0$). Thus, any general solution is related to the tin-foil solution by a constant shift:\n$$\n\\phi(z) = \\phi_\\text{tin}(z) + c\n$$\nThe spatial average of this potential is $\\langle \\phi \\rangle = \\langle \\phi_\\text{tin}(z) + c \\rangle = \\langle \\phi_\\text{tin}(z) \\rangle + \\langle c \\rangle = 0 + c = c$.\n\nFor slab simulations with a vacuum region, a physically intuitive reference is to set the potential in the vacuum region to zero. This is the \"vacuum-referenced\" convention. To achieve this, we choose the constant $c$ such that the average potential over a designated vacuum window $\\mathcal{V}$ is zero. Let $\\phi_\\text{vac}(z)$ be this potential.\n$$\n\\langle \\phi_\\text{vac}(z) \\rangle_{\\mathcal{V}} = 0\n$$\nUsing the relation $\\phi_\\text{vac}(z) = \\phi_\\text{tin}(z) + c$, we find:\n$$\n\\langle \\phi_\\text{tin}(z) + c \\rangle_{\\mathcal{V}} = \\langle \\phi_\\text{tin}(z) \\rangle_{\\mathcal{V}} + c = 0\n$$\nThis uniquely determines the shift constant $c$:\n$$\nc = - \\langle \\phi_\\text{tin}(z) \\rangle_{\\mathcal{V}}\n$$\nThe \"surface potential\" is the bulk-water potential reported relative to the chosen reference. The shift in this reported value when moving from the tin-foil to the vacuum reference is:\n$$\n\\text{Shift} = \\langle \\phi_\\text{vac} \\rangle_{\\mathcal{B}} - \\langle \\phi_\\text{tin} \\rangle_{\\mathcal{B}} = \\langle \\phi_\\text{tin} + c \\rangle_{\\mathcal{B}} - \\langle \\phi_\\text{tin} \\rangle_{\\mathcal{B}} = (\\langle \\phi_\\text{tin} \\rangle_{\\mathcal{B}} + c) - \\langle \\phi_\\text{tin} \\rangle_{\\mathcal{B}} = c\n$$\nThe shift is therefore equal to the determined constant $c$. This completes the second part of the demonstration.\n\n**3. Numerical Implementation via Fast Fourier Transform (FFT)**\n\nThe numerical solution uses the FFT to implement the derived Fourier-space solution. The steps for the algorithm are:\n1. Discretize the domain $[0, L)$ into $N$ points $z_j$.\n2. Compute the charge density $\\rho(z_j)$ on this grid.\n3. Compute the Discrete Fourier Transform (DFT) of the charge density, $R_n = \\mathcal{F}[\\rho(z_j)]$, using an FFT algorithm.\n4. Determine the discrete wavevectors $k_n$ corresponding to the DFT frequencies.\n5. In Fourier space, compute the DFT of the potential, $\\Phi_n = \\mathcal{F}[\\phi(z_j)]$. As derived from the correspondence between DFT and continuous Fourier series coefficients, the relation is $\\Phi_n = R_n / (\\varepsilon_0 k_n^2)$.\n6. Apply the tin-foil condition by setting the $k=0$ component to zero, $\\Phi_0 = 0$. For all other components where $k_n \\neq 0$, compute $\\Phi_n = R_n / (\\varepsilon_0 k_n^2)$.\n7. Obtain the real-space tin-foil potential $\\phi_\\text{tin}(z_j)$ by applying the inverse FFT: $\\phi_\\text{tin}(z_j) = \\mathcal{F}^{-1}[\\Phi_n]$. Discard any minor imaginary components arising from numerical noise.\n8. Identify grid points within the vacuum window $\\mathcal{V}$ and compute the average potential $\\langle \\phi_\\text{tin} \\rangle_{\\mathcal{V}}$.\n9. The required potential shift is $c = - \\langle \\phi_\\text{tin} \\rangle_{\\mathcal{V}}$. This value is computed for each test case.\nFor the test case where $\\rho(z)=0$, we expect $\\phi_\\text{tin}(z)=0$, resulting in a shift of $c=0$.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test cases.\n    It computes the potential shift between 'tin-foil' and 'vacuum'\n    references for a 1D periodic charge distribution.\n    \"\"\"\n    \n    # Use the exact value for vacuum permittivity as specified in the problem.\n    epsilon_0 = 8.854187817e-12  # F/m\n\n    test_cases = [\n        {\n            \"L\": 5.0e-9, \"N\": 2048, \"sigma\": 0.2e-9, \"A\": 1.0e6,\n            \"z1\": 2.0e-9, \"z2\": 3.0e-9,\n            \"vac_win\": (0.0e-9, 0.5e-9),\n        },\n        {\n            \"L\": 5.0e-9, \"N\": 2048, \"sigma\": 0.2e-9, \"A\": 1.5e6,\n            \"z1\": 1.8e-9, \"z2\": 3.2e-9,\n            \"vac_win\": (0.0e-9, 0.5e-9),\n        },\n        {\n            \"L\": 5.0e-9, \"N\": 2048, \"sigma\": 0.2e-9, \"A\": 0.0,\n            \"z1\": 2.0e-9, \"z2\": 3.0e-9,\n            \"vac_win\": (0.0e-9, 0.5e-9),\n        }\n    ]\n\n    results = []\n    for params in test_cases:\n        shift = calculate_potential_shift(params, epsilon_0)\n        results.append(f\"{shift:.6f}\")\n\n    print(f\"[{','.join(results)}]\")\n\ndef calculate_potential_shift(params, epsilon_0):\n    \"\"\"\n    Calculates the potential shift for a single test case.\n\n    Args:\n        params (dict): A dictionary containing the parameters for the test case.\n        epsilon_0 (float): The vacuum permittivity.\n\n    Returns:\n        float: The calculated potential shift 'c'.\n    \"\"\"\n    L = params[\"L\"]\n    N = params[\"N\"]\n    sigma = params[\"sigma\"]\n    A = params[\"A\"]\n    z1 = params[\"z1\"]\n    z2 = params[\"z2\"]\n    vac_win = params[\"vac_win\"]\n\n    # 1. Define the spatial grid and charge density profile\n    z_grid = np.linspace(0, L, N, endpoint=False)\n    rho_z = A * (np.exp(-(z_grid - z1)**2 / (2 * sigma**2)) - \n                   np.exp(-(z_grid - z2)**2 / (2 * sigma**2)))\n\n    # 2. Solve for the 'tin-foil' potential using an FFT-based Poisson solver\n    phi_tin_z = solve_poisson_1d_pbc(rho_z, L, epsilon_0)\n\n    # 3. Identify indices for the vacuum window\n    vac_indices = np.where((z_grid >= vac_win[0])  (z_grid  vac_win[1]))\n\n    if vac_indices[0].size == 0:\n        # This case should not occur with the problem's parameters\n        return np.nan\n\n    # 4. Calculate the average tin-foil potential in the vacuum window\n    mean_phi_in_vac = np.mean(phi_tin_z[vac_indices])\n\n    # 5. The shift 'c' is the negative of this average\n    c = -mean_phi_in_vac\n\n    return c\n\ndef solve_poisson_1d_pbc(rho_z, L, epsilon_0):\n    \"\"\"\n    Solves the 1D periodic Poisson equation d^2(phi)/dz^2 = -rho/epsilon_0\n    using FFTs, under the 'tin-foil' convention (k=0 mode of potential is zero).\n\n    Args:\n        rho_z (np.ndarray): The charge density on a uniform grid.\n        L (float): The length of the periodic cell.\n        epsilon_0 (float): The vacuum permittivity.\n\n    Returns:\n        np.ndarray: The electrostatic potential phi(z) on the grid.\n    \"\"\"\n    N = len(rho_z)\n    dz = L / N\n\n    # DFT of the charge density\n    rho_k = np.fft.fft(rho_z)\n    \n    # Wavevectors corresponding to the DFT frequencies\n    k = np.fft.fftfreq(N, d=dz) * 2 * np.pi\n    \n    # The DFT of the potential, phi_k, will be stored here.\n    # Initialize with zeros. The k=0 component remains zero ('tin-foil' convention).\n    phi_k = np.zeros_like(rho_k)\n    \n    # Find indices of non-zero wavevectors to avoid division by zero\n    nonzero_k_indices = np.where(k != 0)\n    \n    # Solve for phi_k for all k != 0\n    k_squared = k[nonzero_k_indices]**2\n    phi_k[nonzero_k_indices] = rho_k[nonzero_k_indices] / (epsilon_0 * k_squared)\n    \n    # Inverse DFT to get the potential in real space\n    phi_z = np.fft.ifft(phi_k)\n    \n    # The potential must be real; discard small imaginary parts from numerical error.\n    return phi_z.real\n\nif __name__ == \"__main__\":\n    solve()\n\n```", "id": "3422400"}, {"introduction": "An algorithm's correctness is necessary, but its efficiency is what makes it practical for large-scale science. This final practice [@problem_id:3422437] shifts focus to the performance engineering of the PME method on modern hardware like GPUs. You will develop and apply a simplified performance model that captures the essential trade-off between the work done in the particle-space calculation and the reciprocal-space work (FFT). By finding the optimal mesh size $M$ that balances these costs, you will practice a critical skill for any computational scientist: tuning algorithms for maximum throughput.", "problem": "You are modeling the long-range electrostatics stage in Particle Mesh Ewald (PME) on Graphics Processing Units (GPU). The PME method evaluates the reciprocal-space contribution by spreading particle charges to a uniform mesh, performing a three-dimensional Fast Fourier Transform (FFT), applying a Greenâ€™s function in reciprocal space, and interpolating forces back to particles. For a single step on a single GPU, assume the following simplified and widely used cost structure based on algorithmic work counts and an idealized overlap model:\n- Charge spreading and force gathering together visit $p^3$ mesh points per particle, where $p$ is the B-spline assignment order. Let the total assignment time be modeled as $T_{\\text{assign}} = c_a \\, p^3 \\, N$, where $N$ is the number of particles and $c_a$ is a hardware-dependent time-per-stencil coefficient in seconds.\n- The $3$-dimensional FFT (including both forward and inverse transforms and the reciprocal-space convolution) is modeled as $T_{\\text{FFT}}(M) = c_f \\, M^3 \\, \\log_2 M$, where $M$ is the number of grid points per dimension and $c_f$ is a hardware-dependent time-per-gridpoint-log coefficient in seconds.\n- Modern GPU implementations can overlap the assignment and FFT phases using separate streams. Under perfect overlap, the step makespan is modeled as $T_{\\text{step}}(M) = \\max\\{T_{\\text{assign}}, T_{\\text{FFT}}(M)\\} + \\gamma$, where $\\gamma$ is a non-overlappable overhead in seconds (e.g., kernel launches and synchronization).\n- For performance realism, enforce an occupancy constraint on the mesh to limit concurrent updates: only consider grid sizes $M$ such that the average particles-per-grid-node satisfies $N/M^3 \\le \\rho_{\\max}$, where $\\rho_{\\max}$ is a given bound. This induces a feasibility set for $M$.\n\nYour task is to implement a program that, for each provided test case, performs the following steps:\n1. Given integers $p$ and $N$, real coefficients $c_f$, $c_a$, and $\\gamma$ in seconds, a real bound $\\rho_{\\max}$, and a finite candidate set $\\mathcal{M}$ of admissible grid sizes $M$ (integers), first filter the feasible set $\\mathcal{M}_{\\text{feas}} = \\{ M \\in \\mathcal{M} \\mid N/M^3 \\le \\rho_{\\max} \\}$.\n2. For each $M \\in \\mathcal{M}_{\\text{feas}}$, compute $T_{\\text{assign}} = c_a \\, p^3 \\, N$, $T_{\\text{FFT}}(M) = c_f \\, M^3 \\, \\log_2 M$, and $T_{\\text{step}}(M) = \\max\\{T_{\\text{assign}}, T_{\\text{FFT}}(M)\\} + \\gamma$ in seconds.\n3. Select $M^\\star \\in \\mathcal{M}_{\\text{feas}}$ that minimizes $T_{\\text{step}}(M)$. In case of a tie to within numerical equality, choose the smallest $M$. If $\\mathcal{M}_{\\text{feas}}$ is empty, define $M^\\star = -1$ and set throughput to $0$.\n4. Compute the throughput in particles per second as $\\Theta = N / T_{\\text{step}}(M^\\star)$, expressed in particles per second, rounded to three decimal places. If $\\mathcal{M}_{\\text{feas}}$ is empty, set $\\Theta = 0.000$.\n\nFoundational bases to be used:\n- The B-spline assignment kernel touches $p^3$ mesh points per particle, giving a work-proportional cost $T_{\\text{assign}} \\propto p^3 N$ under a fixed time-per-stencil model.\n- The three-dimensional FFT work count scales as $M^3 \\log M$, yielding the model $T_{\\text{FFT}}(M) \\propto M^3 \\log_2 M$ under a fixed time-per-gridpoint-log model.\n- Under stream overlap, the makespan of two overlapped stages is the maximum of their individual times, hence $T_{\\text{step}}(M) = \\max\\{T_{\\text{assign}}, T_{\\text{FFT}}(M)\\} + \\gamma$.\n- The occupancy constraint limits the average particles per grid node to ensure feasible conflict-free execution, requiring $N/M^3 \\le \\rho_{\\max}$.\n\nUnits and numerical output requirements:\n- All times must be computed in seconds.\n- Throughput must be expressed in particles per second and rounded to three decimal places.\n- Angles do not appear in this problem.\n- Percentages do not appear in this problem.\n\nTest suite:\nProvide results for the following test cases. For each case, use the provided parameters verbatim.\n- Case $1$ (balanced regime):\n  - $p = 4$, $N = 200{,}000$, $c_f = 2.5\\times 10^{-12}\\ \\text{s}$, $c_a = 8.0\\times 10^{-12}\\ \\text{s}$, $\\gamma = 2.0\\times 10^{-6}\\ \\text{s}$, $\\rho_{\\max} = 0.5$, $\\mathcal{M} = \\{112, 128, 144, 160, 176, 192, 208\\}$.\n- Case $2$ (FFT-limited with occupancy constraint):\n  - $p = 3$, $N = 300{,}000$, $c_f = 8.0\\times 10^{-12}\\ \\text{s}$, $c_a = 6.0\\times 10^{-12}\\ \\text{s}$, $\\gamma = 3.0\\times 10^{-6}\\ \\text{s}$, $\\rho_{\\max} = 0.2$, $\\mathcal{M} = \\{112, 128, 160, 192, 224\\}$.\n- Case $3$ (assignment-limited):\n  - $p = 6$, $N = 100{,}000$, $c_f = 2.0\\times 10^{-12}\\ \\text{s}$, $c_a = 2.5\\times 10^{-11}\\ \\text{s}$, $\\gamma = 2.0\\times 10^{-6}\\ \\text{s}$, $\\rho_{\\max} = 1.0$, $\\mathcal{M} = \\{96, 128, 160, 192\\}$.\n- Case $4$ (boundary with single feasible grid):\n  - $p = 5$, $N = 800{,}000$, $c_f = 3.0\\times 10^{-12}\\ \\text{s}$, $c_a = 1.1\\times 10^{-11}\\ \\text{s}$, $\\gamma = 5.0\\times 10^{-6}\\ \\text{s}$, $\\rho_{\\max} = 0.05$, $\\mathcal{M} = \\{160, 192, 224, 256\\}$.\n- Case $5$ (infeasible due to occupancy):\n  - $p = 4$, $N = 900{,}000$, $c_f = 2.5\\times 10^{-12}\\ \\text{s}$, $c_a = 1.0\\times 10^{-11}\\ \\text{s}$, $\\gamma = 2.0\\times 10^{-6}\\ \\text{s}$, $\\rho_{\\max} = 0.5$, $\\mathcal{M} = \\{64, 80, 96, 112\\}$.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list of two-element lists, with no spaces, enclosed in square brackets. Each two-element list must be of the form $[M^\\star,\\Theta]$, where $M^\\star$ is an integer and $\\Theta$ is a float rounded to three decimal places. For example: $[[128,2492000000.000],[176,1915000000.123]]$.", "solution": "The user has provided a well-defined optimization problem rooted in the performance modeling of the Particle Mesh Ewald (PME) method for molecular dynamics simulations. The task is to determine the optimal grid size, $M^\\star$, from a given candidate set, $\\mathcal{M}$, that minimizes the total step time, $T_{\\text{step}}$, and to calculate the corresponding throughput, $\\Theta$.\n\nThe validation of the problem statement proceeds as follows.\n\n**Step 1: Extract Givens**\n\nThe problem provides the following definitions, models, and constraints:\n- B-spline assignment order: $p$\n- Number of particles: $N$\n- FFT time coefficient: $c_f$ (units of seconds)\n- Assignment time coefficient: $c_a$ (units of seconds)\n- Non-overlappable overhead: $\\gamma$ (units of seconds)\n- Maximum average particle density: $\\rho_{\\max}$ (dimensionless)\n- Candidate set of grid sizes: $\\mathcal{M}$ (a set of integers)\n- Assignment time model: $T_{\\text{assign}} = c_a \\, p^3 \\, N$\n- FFT time model: $T_{\\text{FFT}}(M) = c_f \\, M^3 \\, \\log_2 M$\n- Total step time model (with overlap): $T_{\\text{step}}(M) = \\max\\{T_{\\text{assign}}, T_{\\text{FFT}}(M)\\} + \\gamma$\n- Occupancy constraint (feasibility condition): $N/M^3 \\le \\rho_{\\max}$\n- Feasible set definition: $\\mathcal{M}_{\\text{feas}} = \\{ M \\in \\mathcal{M} \\mid N/M^3 \\le \\rho_{\\max} \\}$\n- Optimization objective: Find $M^\\star \\in \\mathcal{M}_{\\text{feas}}$ that minimizes $T_{\\text{step}}(M)$.\n- Tie-breaking rule: If multiple values of $M$ yield the same minimum $T_{\\text{step}}(M)$, the smallest value of $M$ is to be chosen.\n- Handling of infeasibility: If $\\mathcal{M}_{\\text{feas}}$ is empty, $M^\\star$ is defined as $-1$ and the throughput $\\Theta$ is $0$.\n- Throughput calculation: $\\Theta = N / T_{\\text{step}}(M^\\star)$, rounded to three decimal places. If $M^\\star = -1$, then $\\Theta = 0.000$.\n\nFive distinct test cases are provided with specific numerical values for these parameters.\n\n**Step 2: Validate Using Extracted Givens**\n\nThe problem is evaluated against the validation criteria:\n- **Scientifically Grounded**: The problem is based on established performance models for key algorithms in computational physics. The scaling of assignment work as $p^3 N$ reflects the nature of B-spline stencils. The FFT cost scaling as $K \\log K$ (where $K=M^3$ is the number of grid points) is the fundamental complexity of the Fast Fourier Transform algorithm. The use of an idealized overlap model, $T_{\\text{step}} = \\max(T_1, T_2) + \\text{overhead}$, and an occupancy constraint are common and realistic simplifications in performance analysis for parallel computing. The problem is scientifically sound.\n- **Well-Posed**: The problem is structured as an optimization over a finite, discrete set of candidate grid sizes, $\\mathcal{M}$. The objective function, $T_{\\text{step}}(M)$, is uniquely defined for each $M$. The filtering rule to create $\\mathcal{M}_{\\text{feas}}$ is unambiguous. The explicit tie-breaking rule (select the smallest $M$) ensures that the solution, $M^\\star$, is unique. The special handling for an empty feasible set is also clearly defined. Thus, a unique and meaningful solution is guaranteed to exist.\n- **Objective**: All parameters, models, and constraints are defined with mathematical precision. The language is objective and free of ambiguity or subjective claims.\n\nThe problem statement does not violate any of the invalidity flags. It is scientifically sound, well-posed, objective, complete, and computationally verifiable.\n\n**Step 3: Verdict and Action**\n\nThe problem is **valid**. A solution will be constructed following the specified logic.\n\n**Solution Methodology**\n\nThe solution requires implementing a procedure that, for each test case, executes the following four steps.\n\n1.  **Filter for Feasibility**: The first step is to construct the feasible set of grid sizes, $\\mathcal{M}_{\\text{feas}}$. This is done by iterating through each candidate grid size $M$ from the given set $\\mathcal{M}$ and testing if it satisfies the occupancy constraint:\n    $$\n    \\frac{N}{M^3} \\le \\rho_{\\max}\n    $$\n    This is equivalent to checking if $M^3 \\ge N/\\rho_{\\max}$, or $M \\ge (N/\\rho_{\\max})^{1/3}$. Any $M \\in \\mathcal{M}$ satisfying this condition is included in $\\mathcal{M}_{\\text{feas}}$. If no $M$ from $\\mathcal{M}$ satisfies this condition, $\\mathcal{M}_{\\text{feas}}$ is empty. In this case, the problem specifies that the optimal grid size is $M^\\star = -1$ and the throughput is $\\Theta = 0.000$. The process for this test case terminates here.\n\n2.  **Compute Step Times**: If $\\mathcal{M}_{\\text{feas}}$ is not empty, we proceed to compute the total step time $T_{\\text{step}}(M)$ for each feasible grid size $M \\in \\mathcal{M}_{\\text{feas}}$. This calculation involves three sub-steps for each $M$:\n    a.  Compute the assignment time, $T_{\\text{assign}}$. This value depends on $p$, $N$, and $c_a$, but is constant with respect to $M$ for a given test case.\n        $$\n        T_{\\text{assign}} = c_a \\, p^3 \\, N\n        $$\n    b.  Compute the FFT time, $T_{\\text{FFT}}(M)$, which depends on $M$.\n        $$\n        T_{\\text{FFT}}(M) = c_f \\, M^3 \\, \\log_2 M\n        $$\n    c.  Combine these using the overlap model to find the total step time, $T_{\\text{step}}(M)$.\n        $$\n        T_{\\text{step}}(M) = \\max\\{T_{\\text{assign}}, T_{\\text{FFT}}(M)\\} + \\gamma\n        $$\n\n3.  **Select the Optimal Grid Size**: After computing $T_{\\text{step}}(M)$ for all $M \\in \\mathcal{M}_{\\text{feas}}$, we must find the optimal grid size, $M^\\star$. This is the value of $M$ that minimizes $T_{\\text{step}}(M)$.\n    $$\n    M^\\star = \\arg\\min_{M \\in \\mathcal{M}_{\\text{feas}}} T_{\\text{step}}(M)\n    $$\n    A crucial detail is the tie-breaking rule: if multiple grid sizes result in the same minimal step time, the smallest of these grid sizes is chosen as $M^\\star$. This can be achieved by sorting the pairs $(T_{\\text{step}}(M), M)$ first by time and then by grid size.\n\n4.  **Calculate Throughput**: Once the optimal grid size $M^\\star$ and its corresponding minimal step time $T_{\\text{step}}(M^\\star)$ are determined, the particle throughput $\\Theta$ is calculated as:\n    $$\n    \\Theta = \\frac{N}{T_{\\text{step}}(M^\\star)}\n    $$\n    The final value of $\\Theta$ must be rounded to three decimal places.\n\nThis complete procedure is applied to each of the five test cases to generate the final results.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the PME performance optimization problem for a series of test cases.\n    \"\"\"\n    test_cases = [\n        {\n            \"p\": 4, \"N\": 200000, \"c_f\": 2.5e-12, \"c_a\": 8.0e-12, \"gamma\": 2.0e-6,\n            \"rho_max\": 0.5, \"M_set\": [112, 128, 144, 160, 176, 192, 208]\n        },\n        {\n            \"p\": 3, \"N\": 300000, \"c_f\": 8.0e-12, \"c_a\": 6.0e-12, \"gamma\": 3.0e-6,\n            \"rho_max\": 0.2, \"M_set\": [112, 128, 160, 192, 224]\n        },\n        {\n            \"p\": 6, \"N\": 100000, \"c_f\": 2.0e-12, \"c_a\": 2.5e-11, \"gamma\": 2.0e-6,\n            \"rho_max\": 1.0, \"M_set\": [96, 128, 160, 192]\n        },\n        {\n            \"p\": 5, \"N\": 800000, \"c_f\": 3.0e-12, \"c_a\": 1.1e-11, \"gamma\": 5.0e-6,\n            \"rho_max\": 0.05, \"M_set\": [160, 192, 224, 256]\n        },\n        {\n            \"p\": 4, \"N\": 900000, \"c_f\": 2.5e-12, \"c_a\": 1.0e-11, \"gamma\": 2.0e-6,\n            \"rho_max\": 0.5, \"M_set\": [64, 80, 96, 112]\n        }\n    ]\n\n    final_results_list = []\n\n    for case in test_cases:\n        p = case[\"p\"]\n        N = case[\"N\"]\n        c_f = case[\"c_f\"]\n        c_a = case[\"c_a\"]\n        gamma = case[\"gamma\"]\n        rho_max = case[\"rho_max\"]\n        M_set = case[\"M_set\"]\n\n        # Step 1: Filter for Feasibility\n        M_feas = [M for M in M_set if N / (M**3) = rho_max]\n\n        if not M_feas:\n            # Handle infeasible case\n            M_star = -1\n            theta = 0.0\n            final_results_list.append(f\"[{M_star},{theta:.3f}]\")\n            continue\n\n        # This part runs only if M_feas is not empty\n        \n        # Calculate constant assignment time\n        T_assign = c_a * (p**3) * N\n\n        # Store results for sorting: (T_step, M)\n        step_time_results = []\n        \n        for M in M_feas:\n            # Step 2: Compute Step Times\n            T_fft = c_f * (M**3) * np.log2(M)\n            T_step = max(T_assign, T_fft) + gamma\n            step_time_results.append((T_step, M))\n\n        # Step 3: Select the Optimal Grid Size\n        # Sort by T_step (primary key, ascending) and M (secondary key, ascending for tie-breaking)\n        step_time_results.sort()\n        \n        best_T_step, M_star = step_time_results[0]\n        \n        # Step 4: Calculate Throughput\n        if best_T_step > 0:\n            theta = N / best_T_step\n        else:\n            # Avoid division by zero, although T_step should be positive\n            theta = 0.0 \n        \n        final_results_list.append(f\"[{M_star},{theta:.3f}]\")\n\n    # Final print statement in the exact required format\n    print(f\"[{','.join(final_results_list)}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```", "id": "3422437"}]}