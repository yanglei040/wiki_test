{"hands_on_practices": [{"introduction": "The primary goal of any thermostat is to ensure that a molecular dynamics simulation correctly samples the statistical properties of a target thermodynamic ensemble, such as the canonical ensemble. This practice reinforces this fundamental concept by asking you to derive a key equilibrium property—the variance of the instantaneous temperature—directly from the principles of statistical mechanics. By showing that this variance is determined by the system's degrees of freedom and target temperature, you will see that it is an intrinsic feature of the ensemble, independent of the thermostat's specific dynamical parameters like $\\tau$ or $\\Delta t$, provided the thermostat is working correctly.", "problem": "Consider a classical molecular dynamics (MD) system with $f$ quadratic velocity degrees of freedom, instantaneous kinetic energy $K=\\sum_{i=1}^{f}\\frac{1}{2}m_i v_i^{2}$, and target absolute temperature $T$. Define the instantaneous temperature by\n$$\nT_{\\text{inst}}=\\frac{2K}{f k_B},\n$$\nwhere $k_B$ is the Boltzmann constant.\n\nAssume the system is thermostatted using the stochastic velocity rescaling (SVR) method, characterized by a relaxation time parameter $\\tau$ and an integration time step $\\Delta t$. In its stationary regime, this thermostat preserves the canonical distribution for velocities at temperature $T$. Starting from first principles of the canonical ensemble and the Maxwell–Boltzmann distribution for velocities, derive the variance of $T_{\\text{inst}}$ under SVR in the stationary regime, and assess how $\\tau$ and $\\Delta t$ affect the fluctuations of $T_{\\text{inst}}$ relative to the canonical target.\n\nYour final result must be a single closed-form analytic expression in terms of $f$ and $T$. Express the variance in Kelvin squared ($\\text{K}^2$). No numerical evaluation is required.", "solution": "The problem asks for the variance of the instantaneous temperature, $T_{\\text{inst}}$, for a system in its stationary state under a stochastic velocity rescaling (SVR) thermostat. The problem statement provides the crucial information that in this regime, the thermostat preserves the canonical distribution for velocities at a target temperature $T$. This means the statistical properties of any quantity dependent on velocity, such as the kinetic energy $K$ and the instantaneous temperature $T_{\\text{inst}}$, can be derived directly from the principles of the canonical ensemble in statistical mechanics.\n\nThe instantaneous temperature is defined as:\n$$\nT_{\\text{inst}} = \\frac{2K}{f k_B}\n$$\nwhere $K$ is the instantaneous kinetic energy, $f$ is the number of quadratic velocity degrees of freedom, and $k_B$ is the Boltzmann constant.\n\nOur goal is to compute the variance of $T_{\\text{inst}}$, which is defined as $\\text{Var}(T_{\\text{inst}}) = \\langle T_{\\text{inst}}^2 \\rangle - \\langle T_{\\text{inst}} \\rangle^2$. Using the properties of the variance operator, we can relate the variance of $T_{\\text{inst}}$ to the variance of the kinetic energy $K$:\n$$\n\\text{Var}(T_{\\text{inst}}) = \\text{Var}\\left(\\frac{2K}{f k_B}\\right) = \\left(\\frac{2}{f k_B}\\right)^2 \\text{Var}(K)\n$$\nThus, the problem reduces to finding the variance of the kinetic energy, $\\text{Var}(K)$, in the canonical ensemble.\n\nThe total kinetic energy $K$ is the sum of energies from $f$ individual quadratic degrees of freedom:\n$$\nK = \\sum_{i=1}^{f} \\frac{1}{2}m_i v_i^{2}\n$$\nIn the canonical ensemble at temperature $T$, the velocity components are independent random variables, each following a Maxwell-Boltzmann distribution. Specifically, each velocity component $v_i$ is a Gaussian random variable with mean $0$ and variance $\\langle v_i^2 \\rangle = \\frac{k_B T}{m_i}$.\n\nTo derive the variance of $K$, it is convenient to express $K$ in terms of dimensionless standard normal variables. Let us define a set of variables $u_i$ such that $u_i = v_i / \\sqrt{k_B T / m_i}$. Each $u_i$ is a random variable drawn from a standard normal distribution, $N(0,1)$, meaning $\\langle u_i \\rangle = 0$ and $\\langle u_i^2 \\rangle = 1$. The kinetic energy can be rewritten in terms of these variables:\n$$\nK = \\sum_{i=1}^{f} \\frac{1}{2}m_i \\left(u_i \\sqrt{\\frac{k_B T}{m_i}}\\right)^2 = \\sum_{i=1}^{f} \\frac{1}{2} m_i u_i^2 \\frac{k_B T}{m_i} = \\frac{1}{2}k_B T \\sum_{i=1}^{f} u_i^2\n$$\nThe sum of the squares of $f$ independent standard normal variables, $X = \\sum_{i=1}^{f} u_i^2$, is a random variable that follows a chi-squared distribution with $f$ degrees of freedom, denoted as $X \\sim \\chi^2_f$. The mean and variance of a chi-squared distribution with $f$ degrees of freedom are well-known:\n$$\n\\langle X \\rangle = f\n$$\n$$\n\\text{Var}(X) = 2f\n$$\nWe can now express the kinetic energy as $K = \\frac{1}{2}k_B T X$. The expected value of the kinetic energy is:\n$$\n\\langle K \\rangle = \\left\\langle \\frac{1}{2}k_B T X \\right\\rangle = \\frac{1}{2}k_B T \\langle X \\rangle = \\frac{1}{2}k_B T f\n$$\nThis result is consistent with the equipartition theorem, which states that each quadratic degree of freedom contributes $\\frac{1}{2}k_B T$ to the average energy.\n\nThe variance of the kinetic energy is:\n$$\n\\text{Var}(K) = \\text{Var}\\left(\\frac{1}{2}k_B T X\\right) = \\left(\\frac{1}{2}k_B T\\right)^2 \\text{Var}(X) = \\frac{(k_B T)^2}{4} (2f) = \\frac{f}{2} (k_B T)^2\n$$\nNow, we can substitute this result back into the expression for the variance of the instantaneous temperature:\n$$\n\\text{Var}(T_{\\text{inst}}) = \\left(\\frac{2}{f k_B}\\right)^2 \\text{Var}(K) = \\frac{4}{f^2 k_B^2} \\left[ \\frac{f}{2} (k_B T)^2 \\right] = \\frac{4f k_B^2 T^2}{2f^2 k_B^2}\n$$\nSimplifying this expression yields the final result for the variance of $T_{\\text{inst}}$:\n$$\n\\text{Var}(T_{\\text{inst}}) = \\frac{2}{f} T^2\n$$\nThe units of this expression are Kelvin squared ($\\text{K}^2$), as required.\n\nFinally, we must assess how the SVR parameters $\\tau$ and $\\Delta t$ affect the fluctuations of $T_{\\text{inst}}$. The derived variance, $\\text{Var}(T_{\\text{inst}}) = \\frac{2}{f}T^2$, depends only on the number of degrees of freedom $f$ and the target temperature $T$. It does not depend on the dynamical parameters $\\tau$ (the relaxation time) or $\\Delta t$ (the integration time step). This is a fundamental consequence of the problem's premise: that the system is in a stationary state where the thermostat correctly samples the canonical ensemble. The variance of a quantity in a given statistical ensemble is an equilibrium property of that ensemble and is independent of the specific algorithm used to generate the state, provided the algorithm is correct.\n\nThe parameters $\\tau$ and $\\Delta t$ do, however, influence the *temporal characteristics* of the fluctuations.\n- The relaxation time $\\tau$ controls the strength of the coupling to the heat bath. A smaller $\\tau$ implies a stronger coupling, causing any deviation of $T_{\\text{inst}}$ from $T$ to be corrected more rapidly. This results in a shorter autocorrelation time for the temperature fluctuations. Conversely, a larger $\\tau$ leads to a weaker coupling, and fluctuations persist for longer, increasing the autocorrelation time.\n- The time step $\\Delta t$ must be chosen to be sufficiently small compared to the physical timescales of the system, including $\\tau$. If $\\Delta t$ is too large, the numerical integration of the equations of motion becomes inaccurate, and the thermostat may fail to preserve the canonical distribution. The problem's assumption that the canonical distribution is preserved implies that $\\Delta t$ is chosen appropriately.\n\nIn summary, under the specified conditions of a stationary state that correctly reproduces the canonical ensemble, the magnitude of the thermal fluctuations, as quantified by the variance of $T_{\\text{inst}}$, is an intrinsic property of the system's statistical mechanics and is independent of the SVR parameters $\\tau$ and $\\Delta t$. These parameters govern the dynamics of how these fluctuations evolve in time.", "answer": "$$\n\\boxed{\\frac{2}{f}T^2}\n$$", "id": "3449865"}, {"introduction": "Having established the statistical target, we now turn to the mechanics of the algorithm designed to reach it. This exercise delves into the constructive details of the stochastic velocity rescaling method. By deriving the step-by-step procedure for sampling the new kinetic energy and analyzing the conditional moments of the scaling factor $\\alpha$, you will gain a deep, first-principles understanding of how the stochastic update is engineered to guide the system towards thermal equilibrium over a characteristic timescale.", "problem": "Consider a classical molecular dynamics system with $f$ quadratic velocity degrees of freedom and instantaneous kinetic energy $K = \\frac{1}{2} \\sum_{i=1}^{f} m_{i} v_{i}^{2}$. The system is coupled to a thermal bath via stochastic velocity rescaling, implemented at the end of each integration step by uniformly scaling all velocities $v_{i} \\mapsto \\alpha v_{i}$ so that the kinetic energy updates as $K' = \\alpha^{2} K$. The target kinetic energy is $\\bar{K} = \\frac{f}{2} k_{B} T$, where $k_{B}$ is the Boltzmann constant and $T$ is the bath temperature. The stochastic velocity rescaling is designed so that the stationary distribution of the kinetic energy $K$ is the canonical (Gamma) distribution compatible with the Maxwell–Boltzmann velocity distribution, and it relaxes toward equilibrium on a characteristic time scale $\\tau$.\n\nStarting from these principles and the requirement that the stochastic map $(K \\mapsto K')$ preserves the canonical distribution with relaxation time $\\tau$, derive an explicit and implementable, step-by-step sampling procedure for $K'$ over a finite time step $\\Delta t$ in terms of standard random variables with known distributions. Then, using your sampling representation and working consistently to first order in $\\Delta t$, compute the first two conditional moments of the velocity scaling factor $\\alpha$ given the current kinetic energy $K$, namely the conditional mean $\\mathbb{E}[\\alpha \\mid K]$ and the conditional variance $\\mathrm{Var}(\\alpha \\mid K)$, both accurate up to $\\mathcal{O}(\\Delta t)$.\n\nYou must:\n- Express the sampling procedure for $K'$ using only standard normal and chi-square random variables, and include all necessary constants as functions of $(f, \\bar{K}, K, \\tau, \\Delta t)$.\n- Define precisely the conditional moments you compute and show how they result from your sampling representation to first order in $\\Delta t$.\n- Provide your final expressions for $\\mathbb{E}[\\alpha \\mid K]$ and $\\mathrm{Var}(\\alpha \\mid K)$ as closed-form analytic expressions in terms of $f$, $\\bar{K}$, $K$, $\\tau$, and $\\Delta t$.\n\nExpress the final answer as a single analytical expression. No numerical evaluation or rounding is required.", "solution": "The core of the stochastic velocity rescaling method is to modify the system's kinetic energy $K$ at discrete time steps $\\Delta t$ by scaling all particle velocities $v_i$ by a common factor $\\alpha$. The new kinetic energy $K'$ is related to the old kinetic energy $K$ by $K' = \\alpha^2 K$. The scaling factor $\\alpha$ is a random variable chosen such that the stationary distribution of $K$ is the canonical Gamma distribution, $P(K) \\propto K^{f/2-1} \\exp(-K/\\beta)$, where $\\beta=k_B T = 2\\bar{K}/f$, and the system relaxes towards this distribution with a characteristic time $\\tau$.\n\n**Part 1: Derivation of the Sampling Procedure for $K'$**\n\nThe stochastic update rule is designed to be equivalent to weakly coupling the system to a bath, which can be modeled by a stochastic differential equation. A robust way to construct the finite-time-step update is to consider the evolution in the space of mass-weighted velocities, $\\mathbf{x} = \\{\\sqrt{m_i}v_i\\}$, a vector in an $f$-dimensional space. The kinetic energy is $K = \\frac{1}{2}\\|\\mathbf{x}\\|^2$. The evolution over a time step $\\Delta t$ can be modeled as a relaxation process:\n$$ \\mathbf{x}(t+\\Delta t) = \\sqrt{c} \\mathbf{x}(t) + \\sqrt{1-c} \\mathbf{x}_{\\text{ran}} $$\nwhere $c = \\exp(-\\Delta t/\\tau)$ and $\\mathbf{x}_{\\text{ran}}$ is a random vector drawn from the equilibrium distribution, i.e., its components are independent Gaussian random variables with variance $k_B T$. The new kinetic energy $K'$ is $K'=\\frac{1}{2}\\|\\mathbf{x}(t+\\Delta t)\\|^2$.\n$$ K' = \\frac{1}{2} \\left( \\sqrt{c} \\mathbf{x}(t) + \\sqrt{1-c} \\mathbf{x}_{\\text{ran}} \\right) \\cdot \\left( \\sqrt{c} \\mathbf{x}(t) + \\sqrt{1-c} \\mathbf{x}_{\\text{ran}} \\right) $$\n$$ K' = \\frac{c}{2}\\|\\mathbf{x}(t)\\|^2 + \\frac{1-c}{2}\\|\\mathbf{x}_{\\text{ran}}\\|^2 + \\sqrt{c(1-c)} (\\mathbf{x}(t) \\cdot \\mathbf{x}_{\\text{ran}}) $$\n$$ K' = cK + (1-c)K_{\\text{ran}} + \\sqrt{c(1-c)} (\\mathbf{x} \\cdot \\mathbf{x}_{\\text{ran}}) $$\nTo express this in terms of standard random variables, we analyze each term. $K_{\\text{ran}} = \\frac{1}{2}\\|\\mathbf{x}_{\\text{ran}}\\|^2$ is the kinetic energy of a random system drawn from the canonical ensemble. It follows a Gamma distribution, which can be constructed from a sum of squared Gaussian variables. Specifically, $K_{\\text{ran}} = \\frac{1}{2}k_B T S_f = \\frac{\\bar{K}}{f}S_f$, where $S_f$ is a random variate from a chi-square distribution with $f$ degrees of freedom, $S_f \\sim \\chi^2_f$.\n\nThe dot product term $\\mathbf{x} \\cdot \\mathbf{x}_{\\text{ran}}$ can be simplified by projecting $\\mathbf{x}_{\\text{ran}}$ onto the direction of $\\mathbf{x}$, defined by the unit vector $\\hat{\\mathbf{u}} = \\mathbf{x}/\\|\\mathbf{x}\\| = \\mathbf{x}/\\sqrt{2K}$.\n$$ \\mathbf{x}_{\\text{ran}} = (\\mathbf{x}_{\\text{ran}} \\cdot \\hat{\\mathbf{u}})\\hat{\\mathbf{u}} + \\mathbf{x}_{\\text{ran},\\perp} $$\nThe parallel projection $\\mathbf{x}_{\\text{ran}} \\cdot \\hat{\\mathbf{u}}$ is a linear combination of independent Gaussian variables (the components of $\\mathbf{x}_{\\text{ran}}$), and is thus itself a Gaussian variable. Its mean is zero and its variance is $k_B T$. We can write it as $\\sqrt{k_B T} Z$, where $Z \\sim \\mathcal{N}(0,1)$. The orthogonal part $\\mathbf{x}_{\\text{ran},\\perp}$ lives in an $(f-1)$-dimensional subspace.\nThe kinetic energy of the random vector decomposes accordingly:\n$$ K_{\\text{ran}} = \\frac{1}{2} (\\mathbf{x}_{\\text{ran}} \\cdot \\hat{\\mathbf{u}})^2 + \\frac{1}{2} \\|\\mathbf{x}_{\\text{ran},\\perp}\\|^2 = \\frac{1}{2}k_B T Z^2 + \\frac{1}{2}k_B T S_{f-1} = \\frac{\\bar{K}}{f}(Z^2 + S_{f-1})$$\nwhere $S_{f-1} \\sim \\chi^2_{f-1}$ is drawn independently of $Z$. This confirms that $Z^2+S_{f-1}$ is a $\\chi^2_f$ variate, as expected.\n\nThe cross term in the expression for $K'$ becomes:\n$$ \\mathbf{x} \\cdot \\mathbf{x}_{\\text{ran}} = \\|\\mathbf{x}\\| (\\hat{\\mathbf{u}} \\cdot \\mathbf{x}_{\\text{ran}}) = \\sqrt{2K} (\\sqrt{k_B T} Z) = Z\\sqrt{2K k_B T} = Z\\sqrt{2K \\frac{2\\bar{K}}{f}} = 2Z\\sqrt{\\frac{K\\bar{K}}{f}} $$\nSubstituting these components back into the equation for $K'$:\n$$ K' = cK + (1-c)\\frac{\\bar{K}}{f}(Z^2 + S_{f-1}) + \\sqrt{c(1-c)} \\left(2Z\\sqrt{\\frac{K\\bar{K}}{f}}\\right) $$\nThis provides the explicit sampling procedure for $K'$. In summary:\n1.  Let $c = \\exp(-\\Delta t/\\tau)$.\n2.  Generate a standard normal random variate $Z \\sim \\mathcal{N}(0,1)$.\n3.  Generate a chi-square random variate $S_{f-1} \\sim \\chi^2_{f-1}$, independent of $Z$.\n4.  Calculate the new kinetic energy $K'$ using the formula:\n    $$ K' = cK + (1-c)\\frac{\\bar K}{f}(Z^2+S_{f-1}) + 2Z\\sqrt{c(1-c)\\frac{K\\bar K}{f}} $$\n\n**Part 2: Calculation of the Conditional Moments of $\\alpha$**\n\nWe need to compute the conditional mean $\\mathbb{E}[\\alpha \\mid K]$ and variance $\\mathrm{Var}(\\alpha \\mid K)$ to first order in $\\Delta t$. The velocity scaling factor $\\alpha$ is given by $\\alpha = \\sqrt{K'/K}$. We first find an expression for $\\alpha^2 = K'/K$:\n$$ \\alpha^2 = c + (1-c)\\frac{\\bar K}{fK}(Z^2+S_{f-1}) + 2Z\\sqrt{c(1-c)\\frac{\\bar K}{fK}} $$\nWe expand for small $\\Delta t$. Let $\\gamma = \\sqrt{\\Delta t/\\tau}$. Then $c = \\exp(-\\Delta t/\\tau) \\approx 1 - (\\Delta t/\\tau) = 1-\\gamma^2$. So $1-c \\approx \\gamma^2$ and $\\sqrt{c(1-c)} \\approx \\sqrt{1 \\cdot \\gamma^2} = \\gamma$.\nSubstituting these approximations, we get $\\alpha^2$ up to order $\\gamma^2 = \\Delta t/\\tau$:\n$$ \\alpha^2 \\approx (1-\\gamma^2) + \\gamma^2\\frac{\\bar K}{fK}(Z^2+S_{f-1}) + 2\\gamma Z\\sqrt{\\frac{\\bar K}{fK}} $$\n$$ \\alpha^2 \\approx 1 + 2\\gamma Z\\sqrt{\\frac{\\bar K}{fK}} + \\gamma^2 \\left( \\frac{\\bar K}{fK}(Z^2+S_{f-1}) - 1 \\right) $$\nTo find $\\alpha$, we take the square root, using the expansion $\\sqrt{1+x} \\approx 1 + x/2 - x^2/8$.\nLet $A = Z\\sqrt{\\frac{\\bar K}{fK}}$ and $B = \\frac{\\bar K}{fK}(Z^2+S_{f-1}) - 1$.\nThen $\\alpha^2 \\approx 1 + 2\\gamma A + \\gamma^2 B$.\n$$ \\alpha = (1 + 2\\gamma A + \\gamma^2 B)^{1/2} \\approx 1 + \\frac{1}{2}(2\\gamma A + \\gamma^2 B) - \\frac{1}{8}(2\\gamma A)^2 $$\n$$ \\alpha \\approx 1 + \\gamma A + \\frac{1}{2}\\gamma^2 B - \\frac{1}{2}\\gamma^2 A^2 $$\nKeeping terms up to $\\mathcal{O}(\\gamma^2) = \\mathcal{O}(\\Delta t)$:\n$$ \\alpha \\approx 1 + \\gamma Z\\sqrt{\\frac{\\bar K}{fK}} + \\frac{1}{2}\\gamma^2 \\left[ \\left(\\frac{\\bar K}{fK}(Z^2+S_{f-1}) - 1\\right) - Z^2\\frac{\\bar K}{fK} \\right] $$\n$$ \\alpha \\approx 1 + \\sqrt{\\frac{\\Delta t}{\\tau}} Z\\sqrt{\\frac{\\bar K}{fK}} + \\frac{1}{2}\\frac{\\Delta t}{\\tau} \\left( \\frac{\\bar K}{fK}S_{f-1} - 1 \\right) $$\n\nNow we compute the conditional moments using this expansion. The random variables are $Z$ and $S_{f-1}$, with moments $\\mathbb{E}[Z]=0$, $\\mathbb{E}[Z^2]=1$, $\\mathbb{E}[S_{f-1}]=f-1$, and $\\mathrm{Var}(S_{f-1})=2(f-1)$.\n\nThe conditional mean $\\mathbb{E}[\\alpha \\mid K]$ is:\n$$ \\mathbb{E}[\\alpha \\mid K] \\approx \\mathbb{E}\\left[ 1 + \\sqrt{\\frac{\\Delta t}{\\tau}} Z\\sqrt{\\frac{\\bar K}{fK}} + \\frac{1}{2}\\frac{\\Delta t}{\\tau} \\left( \\frac{\\bar K}{fK}S_{f-1} - 1 \\right) \\right] $$\n$$ \\mathbb{E}[\\alpha \\mid K] \\approx 1 + \\sqrt{\\frac{\\Delta t}{\\tau}}\\sqrt{\\frac{\\bar K}{fK}}\\mathbb{E}[Z] + \\frac{1}{2}\\frac{\\Delta t}{\\tau} \\left( \\frac{\\bar K}{fK}\\mathbb{E}[S_{f-1}] - 1 \\right) $$\n$$ \\mathbb{E}[\\alpha \\mid K] \\approx 1 + 0 + \\frac{1}{2}\\frac{\\Delta t}{\\tau} \\left( \\frac{\\bar K}{fK}(f-1) - 1 \\right) = 1 + \\frac{\\Delta t}{2\\tau} \\left( \\frac{\\bar K}{K}\\frac{f-1}{f} - 1 \\right) $$\nThis is the conditional mean to first order in $\\Delta t$.\n\nThe conditional variance is $\\mathrm{Var}(\\alpha \\mid K) = \\mathbb{E}[\\alpha^2 \\mid K] - (\\mathbb{E}[\\alpha \\mid K])^2$.\nFirst, $\\mathbb{E}[\\alpha^2 \\mid K]$ to $\\mathcal{O}(\\Delta t)$:\n$$ \\mathbb{E}[\\alpha^2 \\mid K] = \\mathbb{E}\\left[ c + (1-c)\\frac{\\bar K}{fK}(Z^2+S_{f-1}) + 2Z\\sqrt{c(1-c)\\frac{\\bar K}{fK}} \\right] $$\n$$ \\mathbb{E}[\\alpha^2 \\mid K] = c + (1-c)\\frac{\\bar K}{fK}(\\mathbb{E}[Z^2]+\\mathbb{E}[S_{f-1}]) = c+(1-c)\\frac{\\bar K}{fK}(1+f-1) = c+(1-c)\\frac{\\bar K}{K} $$\n$$ \\mathbb{E}[\\alpha^2 \\mid K] \\approx \\left(1-\\frac{\\Delta t}{\\tau}\\right) + \\frac{\\Delta t}{\\tau}\\frac{\\bar K}{K} = 1 + \\frac{\\Delta t}{\\tau}\\left(\\frac{\\bar K}{K}-1\\right) $$\nNext, $(\\mathbb{E}[\\alpha \\mid K])^2$ to $\\mathcal{O}(\\Delta t)$:\n$$ (\\mathbb{E}[\\alpha \\mid K])^2 \\approx \\left( 1 + \\frac{\\Delta t}{2\\tau} \\left( \\frac{\\bar K}{K}\\frac{f-1}{f} - 1 \\right) \\right)^2 \\approx 1 + 2 \\cdot \\frac{\\Delta t}{2\\tau} \\left( \\frac{\\bar K}{K}\\frac{f-1}{f} - 1 \\right) $$\n$$ (\\mathbb{E}[\\alpha \\mid K])^2 \\approx 1 + \\frac{\\Delta t}{\\tau}\\left(\\frac{\\bar K}{K} - \\frac{\\bar K}{fK} - 1\\right) $$\nFinally, the variance:\n$$ \\mathrm{Var}(\\alpha \\mid K) \\approx \\left(1 + \\frac{\\Delta t}{\\tau}\\left(\\frac{\\bar K}{K}-1\\right)\\right) - \\left(1 + \\frac{\\Delta t}{\\tau}\\left(\\frac{\\bar K}{K} - \\frac{\\bar K}{fK} - 1\\right)\\right) $$\n$$ \\mathrm{Var}(\\alpha \\mid K) \\approx \\frac{\\Delta t}{\\tau} \\left( \\left(\\frac{\\bar K}{K}-1\\right) - \\left(\\frac{\\bar K}{K} - \\frac{\\bar K}{fK} - 1\\right) \\right) = \\frac{\\Delta t}{\\tau} \\frac{\\bar K}{fK} $$\nThis is the conditional variance to first order in $\\Delta t$.", "answer": "$$ \\boxed{ \\begin{pmatrix} 1 + \\frac{\\Delta t}{2\\tau} \\left( \\frac{\\bar{K}}{K}\\frac{f-1}{f} - 1 \\right) & \\frac{\\Delta t}{\\tau} \\frac{\\bar{K}}{fK} \\end{pmatrix} } $$", "id": "3449852"}, {"introduction": "A theoretically sound algorithm must be implemented with care to yield reliable results. This final practice addresses the crucial, practical issue of choosing appropriate parameters for the SVR thermostat to ensure both stability and accuracy. You will derive a quantitative relationship between the thermostat coupling strength, represented by the ratio $\\Delta t / \\tau$, and the magnitude of the fluctuations it introduces, providing a clear criterion for preventing unphysical behavior and maintaining the integrity of the canonical sampling.", "problem": "Consider a molecular dynamics system with $N_{f}$ kinetic degrees of freedom coupled to a single global Stochastic Velocity Rescaling (SVR) thermostat as introduced by Bussi, Donadio, and Parrinello. Let $K$ denote the instantaneous total kinetic energy and $T$ the target temperature. The thermostat relaxation time is $\\tau$, and the molecular dynamics time step is $\\Delta t$. Define $c \\equiv \\exp(-\\Delta t/\\tau)$. Assume the thermostatting substep is applied exactly (i.e., using the analytically exact propagator for the kinetic energy), and the subsequent deterministic integration conserves $K$ over the thermostatting substep.\n\nFundamental base and definitions:\n- The total kinetic energy is $K = \\frac{1}{2}\\sum_{i=1}^{N_{f}} m_{i} v_{i}^{2}$, and its canonical stationary mean is $\\theta \\equiv \\frac{N_{f}}{2} k_{B} T$, where $k_{B}$ is the Boltzmann constant.\n- Under global SVR, the thermostat drives $K$ according to the Cox–Ingersoll–Ross (CIR) process, a mean-reverting square-root diffusion with stationary Gamma law corresponding to the canonical distribution for $K$. The exact one-step transition of the CIR process over duration $\\Delta t$ has the form $K' = a\\,Y$, where $Y$ is a noncentral chi-square random variable with degrees of freedom $\\nu$ and noncentrality parameter $\\lambda$. The scale $a$ and parameters $(\\nu,\\lambda)$ depend on $(\\Delta t,\\tau,N_{f},K,T)$ through the relaxation factor $c$ and are such that the conditional mean and variance of $K'$ satisfy the well-tested CIR relations $\\mathbb{E}[K' \\mid K] = c\\,K + (1-c)\\,\\theta$ and $\\operatorname{Var}(K' \\mid K) = \\sigma_{K}^{2}(c,N_{f},K,\\theta)$, with a closed form determined by properties of the noncentral chi-square distribution.\n\nLet $\\alpha$ denote the random global scaling factor applied to all velocities by the thermostat over the substep, so that $K' = \\alpha^{2} K$. At equilibrium (i.e., conditioning on $K = \\theta$), the distribution of $\\alpha$ is centered near $1$ for weak coupling. Excessively strong coupling (large $\\Delta t/\\tau$) leads to a broad distribution of $\\alpha$ and can degrade sampling accuracy; in extreme cases, it can push the kinetic energy close to the $K=0$ boundary. The CIR boundary classification implies that for $N_{f} \\geq 2$ the boundary at $K=0$ is unattainable in continuous time, but large discrete steps can still induce an unacceptably broad transition.\n\nAdopt the following practical stability criterion at equilibrium:\n- Accuracy requirement: the equilibrium standard deviation of the instantaneous rescaling factor $\\alpha$ must not exceed a user-specified fraction $\\varepsilon$ of its mean, i.e., $\\sqrt{\\operatorname{Var}(\\alpha \\mid K=\\theta)} \\leq \\varepsilon$, with $0<\\varepsilon<1/\\sqrt{2N_{f}}$ to ensure a meaningful bound.\n- Assume $N_{f} \\geq 2$ so that the $K=0$ boundary is unattainable for the underlying CIR process, and use the exact one-step statistics to connect the variance of $\\alpha$ to $c=\\exp(-\\Delta t/\\tau)$.\n\nStarting from the CIR exact-step characterization of $K'$ and the relation $K'=\\alpha^{2}K$, derive an explicit closed-form expression for the maximum allowable thermostat coupling ratio\n$$\nr_{\\max}(N_{f},\\varepsilon) \\equiv \\frac{\\Delta t}{\\tau}\n$$\nthat guarantees the above accuracy requirement at equilibrium. Your final answer must be a single analytic expression for $r_{\\max}(N_{f},\\varepsilon)$ in terms of $N_{f}$ and $\\varepsilon$. Do not introduce any additional free parameters. Do not round; provide the exact closed form with no units.", "solution": "The objective is to find the maximum value of $r \\equiv \\Delta t/\\tau$ that satisfies the accuracy requirement. The requirement is stated as:\n$$\n\\sqrt{\\operatorname{Var}(\\alpha \\mid K=\\theta)} \\leq \\varepsilon\n$$\nwhere $\\alpha$ is the velocity scaling factor, $K$ is the instantaneous kinetic energy, and $\\theta = \\frac{N_{f}}{2} k_{B} T$ is the mean kinetic energy at the target temperature $T$. The condition is evaluated at equilibrium, which means we condition on the system having the mean kinetic energy, $K = \\theta$.\n\nThe scaling factor $\\alpha$ relates the kinetic energy before ($K$) and after ($K'$) the thermostatting step via $K' = \\alpha^{2} K$. At equilibrium, with $K=\\theta$, this relation becomes $K' = \\alpha^{2} \\theta$. From this, we can express $\\alpha$ in terms of the random variable $K'$:\n$$\n\\alpha = \\sqrt{\\frac{K'}{\\theta}}\n$$\nWe need to find the variance of $\\alpha$. The criterion is posed for small $\\varepsilon$, which corresponds to weak coupling and small fluctuations of $K'$ around its mean value, $\\mathbb{E}[K' \\mid K=\\theta] = \\theta$. In this regime, we can approximate the variance of the function $\\alpha(K')$ using the propagation of uncertainty formula (which is equivalent to a first-order Taylor expansion). For a function $f(X)$, the variance is approximately $\\operatorname{Var}(f(X)) \\approx (f'(\\mathbb{E}[X]))^{2} \\operatorname{Var}(X)$.\nHere, the function is $\\alpha(K') = \\sqrt{K'/\\theta}$ and the random variable is $K'$. The expectation of $K'$ at equilibrium is $\\mathbb{E}[K' \\mid K=\\theta] = \\theta$.\nThe derivative of $\\alpha(K')$ with respect to $K'$ is:\n$$\n\\frac{d\\alpha}{dK'} = \\frac{d}{dK'} \\left(\\frac{\\sqrt{K'}}{\\sqrt{\\theta}}\\right) = \\frac{1}{\\sqrt{\\theta}} \\frac{1}{2\\sqrt{K'}} = \\frac{1}{2\\sqrt{\\theta K'}}\n$$\nEvaluating the derivative at the mean value $K' = \\theta$:\n$$\n\\left. \\frac{d\\alpha}{dK'} \\right|_{K'=\\theta} = \\frac{1}{2\\sqrt{\\theta \\cdot \\theta}} = \\frac{1}{2\\theta}\n$$\nThe variance of $\\alpha$ can thus be approximated as:\n$$\n\\operatorname{Var}(\\alpha \\mid K=\\theta) \\approx \\left(\\frac{1}{2\\theta}\\right)^{2} \\operatorname{Var}(K' \\mid K=\\theta) = \\frac{\\operatorname{Var}(K' \\mid K=\\theta)}{4\\theta^{2}}\n$$\nThe next step is to find the expression for $\\operatorname{Var}(K' \\mid K=\\theta)$. The problem states that the kinetic energy $K$ follows a Cox-Ingersoll-Ross (CIR) process. The exact one-step propagator for a CIR process gives the conditional variance of $K' = K(t+\\Delta t)$ given $K=K(t)$. This variance is a standard result from stochastic calculus:\n$$\n\\operatorname{Var}(K' \\mid K) = \\frac{2\\theta^{2}(1-c)^{2}}{N_{f}} + \\frac{4\\theta c(1-c)}{N_{f}} K\n$$\nwhere $c \\equiv \\exp(-\\Delta t/\\tau)$. We are interested in the equilibrium case, where we condition on $K=\\theta$:\n$$\n\\operatorname{Var}(K' \\mid K=\\theta) = \\frac{2\\theta^{2}(1-c)^{2}}{N_{f}} + \\frac{4\\theta c(1-c)}{N_{f}} \\theta\n$$\n$$\n\\operatorname{Var}(K' \\mid K=\\theta) = \\frac{2\\theta^{2}(1-c)}{N_{f}} \\left[ (1-c) + 2c \\right] = \\frac{2\\theta^{2}(1-c)(1+c)}{N_{f}}\n$$\nUsing the identity $(1-c)(1+c) = 1-c^{2}$, we get:\n$$\n\\operatorname{Var}(K' \\mid K=\\theta) = \\frac{2\\theta^{2}(1-c^{2})}{N_{f}}\n$$\nNow, we substitute this result back into our approximation for the variance of $\\alpha$:\n$$\n\\operatorname{Var}(\\alpha \\mid K=\\theta) \\approx \\frac{1}{4\\theta^{2}} \\left( \\frac{2\\theta^{2}(1-c^{2})}{N_{f}} \\right) = \\frac{1-c^{2}}{2N_{f}}\n$$\nWith this expression, we can apply the stability criterion:\n$$\n\\sqrt{\\frac{1-c^{2}}{2N_{f}}} \\leq \\varepsilon\n$$\nSquaring both sides of the inequality yields:\n$$\n\\frac{1-c^{2}}{2N_{f}} \\leq \\varepsilon^{2}\n$$\nWe now solve for $c$.\n$$\n1-c^{2} \\leq 2N_{f}\\varepsilon^{2}\n$$\n$$\nc^{2} \\geq 1 - 2N_{f}\\varepsilon^{2}\n$$\nSince $c = \\exp(-\\Delta t/\\tau)$ is positive, we can take the square root of both sides. The condition $0 < \\varepsilon < 1/\\sqrt{2N_{f}}$ given in the problem ensures that the term $1 - 2N_{f}\\varepsilon^{2}$ is positive.\n$$\nc \\geq \\sqrt{1 - 2N_{f}\\varepsilon^{2}}\n$$\nFinally, we substitute $c = \\exp(-\\Delta t/\\tau) = \\exp(-r)$:\n$$\n\\exp(-r) \\geq \\sqrt{1 - 2N_{f}\\varepsilon^{2}}\n$$\nTo solve for $r$, we take the natural logarithm of both sides. Since $\\ln(x)$ is a monotonically increasing function, the direction of the inequality is preserved.\n$$\n-r \\geq \\ln\\left(\\sqrt{1 - 2N_{f}\\varepsilon^{2}}\\right) = \\frac{1}{2}\\ln\\left(1 - 2N_{f}\\varepsilon^{2}\\right)\n$$\nMultiplying by $-1$ reverses the inequality:\n$$\nr \\leq -\\frac{1}{2}\\ln\\left(1 - 2N_{f}\\varepsilon^{2}\\right)\n$$\nThis inequality defines the allowed values for the coupling ratio $r$. The maximum value, $r_{\\max}$, is the upper bound of this range.\n$$\nr_{\\max}(N_{f},\\varepsilon) = -\\frac{1}{2}\\ln\\left(1 - 2N_{f}\\varepsilon^{2}\\right)\n$$\nThis is the desired closed-form expression for the maximum allowable thermostat coupling ratio.", "answer": "$$\\boxed{-\\frac{1}{2}\\ln\\left(1 - 2N_{f}\\varepsilon^{2}\\right)}$$", "id": "3449859"}]}