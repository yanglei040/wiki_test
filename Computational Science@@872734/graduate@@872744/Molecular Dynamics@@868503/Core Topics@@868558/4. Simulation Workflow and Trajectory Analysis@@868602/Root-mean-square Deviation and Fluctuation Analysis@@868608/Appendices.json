{"hands_on_practices": [{"introduction": "The root-mean-square deviation (RMSD) is a cornerstone metric for comparing molecular structures, but its calculation requires first finding the optimal rigid-body alignment. This practice guides you through the foundational, first-principles derivation of this superposition, which is based on minimizing the mass-weighted sum of squared atomic distances. By deriving the expressions for the optimal translation and the covariance matrix that determines rotation, you will gain a deep understanding of the mathematical machinery behind ubiquitous structural alignment tools [@problem_id:3443709].", "problem": "Consider two conformations of a macromolecule in three-dimensional space used for root-mean-square deviation (RMSD) analysis in molecular dynamics. The conformations are represented by atom coordinate sets $\\{x_{i}\\}_{i=1}^{N}$ and $\\{y_{i}\\}_{i=1}^{N}$ with $x_{i}, y_{i} \\in \\mathbb{R}^{3}$, and strictly positive atomic masses $\\{m_{i}\\}_{i=1}^{N}$. An optimal superposition is defined as a rigid motion with rotation $R \\in \\mathrm{SO}(3)$ (the special orthogonal group of dimension $3$, i.e., $R^{\\top}R = I$ and $\\det(R) = 1$) and translation $t \\in \\mathbb{R}^{3}$ that minimizes the mass-weighted sum of squared deviations\n$$\nJ(R,t) = \\sum_{i=1}^{N} m_{i} \\left\\| R x_{i} + t - y_{i} \\right\\|^{2}.\n$$\nStarting from first principles (the definition of the mass-weighted least squares objective and the constraints on $R$), derive the mass-weighted optimal superposition by minimizing $J(R,t)$ with respect to the translation $t$ and then re-express the objective in terms of centered coordinates to identify the quantity used to compute the optimal rotation $R$. In particular, obtain explicit analytic expressions for:\n- the mass-weighted centroid of the $x$-coordinates,\n- the mass-weighted centroid of the $y$-coordinates,\n- the mass-weighted covariance matrix that enters the rotation computation (for example, via singular value decomposition (SVD)),\n- and the optimal translation $t^{\\star}$ in terms of $R$ and the centroids.\n\nYour final answer must be a single closed-form analytic expression collecting these four quantities. No numerical evaluation is required. If any intermediate scalar normalization is needed, express it symbolically. Do not include any units in your final answer.", "solution": "The objective is to find the optimal rotation $R \\in \\mathrm{SO}(3)$ and translation $t \\in \\mathbb{R}^{3}$ that minimize the mass-weighted sum of squared deviations between two sets of atomic coordinates, $\\{x_{i}\\}_{i=1}^{N}$ and $\\{y_{i}\\}_{i=1}^{N}$. The objective function is given by:\n$$\nJ(R,t) = \\sum_{i=1}^{N} m_{i} \\left\\| R x_{i} + t - y_{i} \\right\\|^{2}\n$$\nwhere $\\{m_{i}\\}_{i=1}^{N}$ are the strictly positive atomic masses.\n\nThe minimization can be carried out in two steps: first with respect to the translation vector $t$, and then with respect to the rotation matrix $R$.\n\n**Step 1: Minimization with Respect to Translation $t$**\n\nFor a fixed rotation $R$, the optimal translation $t^{\\star}$ is found by setting the gradient of $J(R,t)$ with respect to $t$ to the zero vector. The gradient $\\nabla_{t} J$ is computed as follows:\n$$\n\\nabla_{t} J(R,t) = \\nabla_{t} \\sum_{i=1}^{N} m_{i} (R x_{i} + t - y_{i})^{\\top}(R x_{i} + t - y_{i})\n$$\nUsing the identity $\\nabla_{v} (u^{\\top}u) = 2 u^{\\top} \\nabla_{v}u$, and noting that $\\nabla_{t}(R x_{i} + t - y_{i}) = I$ (the identity matrix), we get:\n$$\n\\nabla_{t} J(R,t) = \\sum_{i=1}^{N} m_{i} \\cdot 2(R x_{i} + t - y_{i})^{\\top}\n$$\nSetting the gradient (transposed to a column vector) to zero:\n$$\n\\sum_{i=1}^{N} 2 m_{i} (R x_{i} + t^{\\star} - y_{i}) = 0\n$$\nSince $m_i > 0$, we can divide by $2$ and rearrange the summation:\n$$\n\\sum_{i=1}^{N} m_{i} R x_{i} + \\sum_{i=1}^{N} m_{i} t^{\\star} - \\sum_{i=1}^{N} m_{i} y_{i} = 0\n$$\n$$\nR \\left(\\sum_{i=1}^{N} m_{i} x_{i}\\right) + t^{\\star} \\left(\\sum_{i=1}^{N} m_{i}\\right) - \\left(\\sum_{i=1}^{N} m_{i} y_{i}\\right) = 0\n$$\nTo simplify this expression, we define the total mass $M$ and the mass-weighted centroids of the two coordinate sets. Let the total mass be $M = \\sum_{k=1}^{N} m_{k}$. The mass-weighted centroids are:\n- The centroid of the $\\{x_{i}\\}$ coordinates: $x_{c} = \\frac{1}{M} \\sum_{i=1}^{N} m_{i} x_{i}$.\n- The centroid of the $\\{y_{i}\\}$ coordinates: $y_{c} = \\frac{1}{M} \\sum_{i=1}^{N} m_{i} y_{i}$.\n\nSubstituting these definitions into the equation for $t^{\\star}$:\n$$\nR (M x_{c}) + M t^{\\star} - M y_{c} = 0\n$$\nSince $M > 0$, we can divide by $M$ to obtain:\n$$\nR x_{c} + t^{\\star} - y_{c} = 0\n$$\nThis yields the expression for the optimal translation $t^{\\star}$ in terms of the rotation $R$ and the centroids:\n$$\nt^{\\star} = y_{c} - R x_{c}\n$$\nThis is the fourth quantity required by the problem. The first two quantities are the explicit expressions for the centroids $x_c$ and $y_c$.\n\n**Step 2: Re-expressing the Objective and Identifying the Covariance Matrix**\n\nNow, we substitute the optimal translation $t^{\\star}$ back into the objective function $J(R,t)$ to obtain a function that depends only on the rotation $R$:\n$$\nJ(R) = J(R, t^{\\star}) = \\sum_{i=1}^{N} m_{i} \\left\\| R x_{i} + (y_{c} - R x_{c}) - y_{i} \\right\\|^{2}\n$$\nRearranging the terms inside the norm:\n$$\nJ(R) = \\sum_{i=1}^{N} m_{i} \\left\\| (R x_{i} - R x_{c}) - (y_{i} - y_{c}) \\right\\|^{2} = \\sum_{i=1}^{N} m_{i} \\left\\| R(x_{i} - x_{c}) - (y_{i} - y_{c}) \\right\\|^{2}\n$$\nWe introduce the centered coordinates:\n- $x'_{i} = x_{i} - x_{c}$\n- $y'_{i} = y_{i} - y_{c}$\nThe objective function becomes a problem of finding the rotation that best aligns the centered coordinate sets:\n$$\nJ(R) = \\sum_{i=1}^{N} m_{i} \\left\\| R x'_{i} - y'_{i} \\right\\|^{2}\n$$\nExpanding the squared norm:\n$$\n\\left\\| R x'_{i} - y'_{i} \\right\\|^{2} = (R x'_{i} - y'_{i})^{\\top}(R x'_{i} - y'_{i}) = (R x'_{i})^{\\top}(R x'_{i}) - 2(R x'_{i})^{\\top}y'_{i} + (y'_{i})^{\\top}y'_{i}\n$$\nSince $R$ is an orthogonal matrix ($R^{\\top}R = I$), we have $(R x'_{i})^{\\top}(R x'_{i}) = (x'_{i})^{\\top}R^{\\top}R x'_{i} = (x'_{i})^{\\top}I x'_{i} = \\|x'_{i}\\|^{2}$.\nThe expanded term is $\\|x'_{i}\\|^{2} - 2(x'_{i})^{\\top}R^{\\top}y'_{i} + \\|y'_{i}\\|^{2}$.\nSubstituting this back into the expression for $J(R)$:\n$$\nJ(R) = \\sum_{i=1}^{N} m_{i} \\left( \\|x'_{i}\\|^{2} + \\|y'_{i}\\|^{2} \\right) - 2 \\sum_{i=1}^{N} m_{i} (x'_{i})^{\\top}R^{\\top}y'_{i}\n$$\nTo minimize $J(R)$, we must maximize the term that depends on $R$. The first part of the sum, $\\sum_{i=1}^{N} m_{i} ( \\|x'_{i}\\|^{2} + \\|y'_{i}\\|^{2} )$, is constant with respect to $R$. Therefore, minimizing $J(R)$ is equivalent to maximizing the quantity $S(R)$:\n$$\nS(R) = \\sum_{i=1}^{N} m_{i} (x'_{i})^{\\top}R^{\\top}y'_{i}\n$$\nWe can express this sum using the trace operator. For any scalar $a$, $a = \\mathrm{Tr}(a)$.\n$$\nS(R) = \\sum_{i=1}^{N} m_{i} \\mathrm{Tr}\\left( (x'_{i})^{\\top}R^{\\top}y'_{i} \\right)\n$$\nUsing the cyclic property of the trace, $\\mathrm{Tr}(ABC) = \\mathrm{Tr}(BCA)$:\n$$\nS(R) = \\sum_{i=1}^{N} m_{i} \\mathrm{Tr}\\left( R^{\\top}y'_{i}(x'_{i})^{\\top} \\right)\n$$\nBy the linearity of the trace operator:\n$$\nS(R) = \\mathrm{Tr}\\left( R^{\\top} \\left( \\sum_{i=1}^{N} m_{i} y'_{i}(x'_{i})^{\\top} \\right) \\right)\n$$\nThis expression identifies the matrix that governs the rotational part of the problem. This is the mass-weighted covariance matrix $C$:\n$$\nC = \\sum_{i=1}^{N} m_{i} y'_{i}(x'_{i})^{\\top} = \\sum_{i=1}^{N} m_{i} (y_{i} - y_{c})(x_{i} - x_{c})^{\\top}\n$$\nThe problem of finding the optimal rotation $R$ is thus reduced to maximizing $\\mathrm{Tr}(R^{\\top}C)$. This is typically solved by computing the singular value decomposition (SVD) of the matrix $C$. This matrix $C$ is the third quantity required by the problem.\n\nThe four required quantities are thus:\n1.  The mass-weighted centroid of the $x$-coordinates: $x_{c} = \\frac{\\sum_{i=1}^{N} m_{i} x_{i}}{\\sum_{k=1}^{N} m_{k}}$.\n2.  The mass-weighted centroid of the $y$-coordinates: $y_{c} = \\frac{\\sum_{i=1}^{N} m_{i} y_{i}}{\\sum_{k=1}^{N} m_{k}}$.\n3.  The mass-weighted covariance matrix: $C = \\sum_{i=1}^{N} m_{i} (y_{i} - y_{c})(x_{i} - x_{c})^{\\top}$.\n4.  The optimal translation: $t^{\\star} = y_{c} - R x_{c}$.\n\nThese are collected into a single analytical expression in the final answer.", "answer": "$$\n\\boxed{\n\\pmatrix{\n\\frac{\\sum_{i=1}^{N} m_{i} x_{i}}{\\sum_{k=1}^{N} m_{k}} & \n\\frac{\\sum_{i=1}^{N} m_{i} y_{i}}{\\sum_{k=1}^{N} m_{k}} & \n\\sum_{i=1}^{N} m_{i} \\left(y_{i} - \\frac{\\sum_{j=1}^{N} m_{j} y_{j}}{\\sum_{k=1}^{N} m_{k}}\\right)\\left(x_{i} - \\frac{\\sum_{l=1}^{N} m_{l} x_{l}}{\\sum_{k=1}^{N} m_{k}}\\right)^{\\top} & \n\\frac{\\sum_{i=1}^{N} m_{i} y_{i}}{\\sum_{k=1}^{N} m_{k}} - R\\left(\\frac{\\sum_{i=1}^{N} m_{i} x_{i}}{\\sum_{k=1}^{N} m_{k}}\\right)\n}\n}\n$$", "id": "3443709"}, {"introduction": "After understanding the ideal mathematical framework for alignment, we must confront a key challenge in analyzing simulation data: periodic boundary conditions (PBC). This practice explores the minimal-image convention (MIC), which corrects for artificial coordinate jumps that occur when a molecule crosses the simulation box boundary, ensuring that calculated deviations reflect true physical motion. By implementing and comparing naive versus corrected RMSD and RMSF calculations, you will quantify the critical impact of PBCs and develop an essential coding skill for robust trajectory analysis [@problem_id:3443654].", "problem": "You must write a complete and runnable program that, for trajectories of atoms in an orthorhombic periodic box, quantifies the impact of Periodic Boundary Conditions (PBC) on Root-Mean-Square Deviation (RMSD) and Root-Mean-Square Fluctuation (RMSF) by comparing naive wrapped coordinates versus minimal-image corrected displacements. The program must be self-contained and produce the requested numerical results for the specified test suite in the exact output format.\n\nFundamental base and definitions to use:\n- Euclidean geometry: for any vector $\\mathbf{a}\\in\\mathbb{R}^3$, its squared norm is $\\|\\mathbf{a}\\|^2 = a_x^2 + a_y^2 + a_z^2$ and $\\|\\mathbf{a}\\| = \\sqrt{\\|\\mathbf{a}\\|^2}$.\n- Time averaging: for a time sequence $\\{x(t)\\}_{t=1}^T$, the average is $\\overline{x} = \\frac{1}{T}\\sum_{t=1}^T x(t)$.\n- Periodic Boundary Conditions (PBC) in an orthorhombic box: the box lengths are given by $\\mathbf{L} = (L_x, L_y, L_z)$ and positions are wrapped into the interval $[0,L_\\alpha)$ in each Cartesian component $\\alpha\\in\\{x,y,z\\}$.\n- Minimal-image correction: for each atom $i$ at time $t$, choose $\\mathbf{n}_{i}(t)\\in \\mathbb{Z}^3$ component-wise so that the corrected displacement vector $\\Delta\\mathbf{r}_i^{MIC}(t) = \\Delta\\mathbf{r}_i^{wrap}(t) + \\mathbf{n}_i(t)\\circ \\mathbf{L}$ has minimal Euclidean norm, where $\\Delta\\mathbf{r}_i^{wrap}(t) = \\mathbf{r}_i(t) - \\mathbf{r}_i^{ref}$ and $\\circ$ denotes element-wise multiplication. The choice must be made independently in each component by selecting the nearest integer to $\\Delta r_{i,\\alpha}(t)/L_\\alpha$; ties at exactly half a box ($\\Delta r_{i,\\alpha}(t)/L_\\alpha = \\pm \\tfrac{1}{2}$) must be resolved to the nearest even integer to ensure deterministic behavior.\n- Root-Mean-Square Deviation (RMSD): for $N$ atoms, at time $t$ with a displacement convention $\\Delta\\mathbf{r}_i(t)$, define $R(t) = \\sqrt{\\frac{1}{N}\\sum_{i=1}^N \\|\\Delta\\mathbf{r}_i(t)\\|^2}$ and report the time average $\\overline{R} = \\frac{1}{T}\\sum_{t=1}^T R(t)$.\n- Root-Mean-Square Fluctuation (RMSF): for each atom $i$, reconstruct coordinates $\\mathbf{u}_i(t)$ by adding the displacement to the reference, $\\mathbf{u}_i(t) = \\mathbf{r}_i^{ref} + \\Delta\\mathbf{r}_i(t)$, compute the time average $\\overline{\\mathbf{u}}_i = \\frac{1}{T}\\sum_{t=1}^T \\mathbf{u}_i(t)$, and define $\\mathrm{RMSF}_i = \\sqrt{\\frac{1}{T}\\sum_{t=1}^T \\|\\mathbf{u}_i(t) - \\overline{\\mathbf{u}}_i\\|^2}$. Report the mean across atoms, $\\overline{\\mathrm{F}} = \\frac{1}{N}\\sum_{i=1}^N \\mathrm{RMSF}_i$.\n- Two displacement conventions must be compared:\n  1. Naive wrapped displacements: $\\Delta\\mathbf{r}_i^{wrap}(t) = \\mathbf{r}_i(t) - \\mathbf{r}_i^{ref}$.\n  2. Minimal-image corrected displacements: $\\Delta\\mathbf{r}_i^{MIC}(t)$ constructed as above.\nFor each test case, compute and report four floats: $\\overline{R}^{wrap}$, $\\overline{R}^{MIC}$, $\\overline{\\mathrm{F}}^{wrap}$, $\\overline{\\mathrm{F}}^{MIC}$.\n\nAll positions and box lengths are given in nanometers and all outputs must be reported in nanometers, rounded to $6$ decimal places.\n\nTest suite:\n- Case $1$ (single atom crossing a boundary):\n  - Box: $\\mathbf{L} = (\\,1.0,\\,1.0,\\,1.0\\,)$ in $\\mathrm{nm}$.\n  - Number of atoms: $N=1$.\n  - Number of frames: $T=4$.\n  - Reference positions: $\\mathbf{r}_1^{ref} = (\\,0.90,\\,0.00,\\,0.00\\,)$ in $\\mathrm{nm}$.\n  - Trajectory frames (wrapped coordinates, in $\\mathrm{nm}$):\n    $t=1$: $\\mathbf{r}_1(1) = (\\,0.90,\\,0.00,\\,0.00\\,)$,\n    $t=2$: $\\mathbf{r}_1(2) = (\\,0.95,\\,0.00,\\,0.00\\,)$,\n    $t=3$: $\\mathbf{r}_1(3) = (\\,0.98,\\,0.00,\\,0.00\\,)$,\n    $t=4$: $\\mathbf{r}_1(4) = (\\,0.02,\\,0.00,\\,0.00\\,)$.\n- Case $2$ (three atoms with crossings in different dimensions):\n  - Box: $\\mathbf{L} = (\\,2.0,\\,1.0,\\,1.5\\,)$ in $\\mathrm{nm}$.\n  - Number of atoms: $N=3$.\n  - Number of frames: $T=3$.\n  - Reference positions (in $\\mathrm{nm}$):\n    $\\mathbf{r}_1^{ref} = (\\,1.80,\\,0.20,\\,0.75\\,)$,\n    $\\mathbf{r}_2^{ref} = (\\,0.10,\\,0.90,\\,0.10\\,)$,\n    $\\mathbf{r}_3^{ref} = (\\,1.99,\\,0.05,\\,1.49\\,)$.\n  - Trajectory frames (wrapped coordinates, in $\\mathrm{nm}$):\n    $t=1$:\n      $\\mathbf{r}_1(1) = (\\,1.85,\\,0.22,\\,0.78\\,)$,\n      $\\mathbf{r}_2(1) = (\\,0.15,\\,0.92,\\,0.14\\,)$,\n      $\\mathbf{r}_3(1) = (\\,1.98,\\,0.06,\\,1.48\\,)$.\n    $t=2$:\n      $\\mathbf{r}_1(2) = (\\,0.05,\\,0.22,\\,0.78\\,)$,\n      $\\mathbf{r}_2(2) = (\\,0.15,\\,0.02,\\,0.14\\,)$,\n      $\\mathbf{r}_3(2) = (\\,1.98,\\,0.06,\\,0.01\\,)$.\n    $t=3$:\n      $\\mathbf{r}_1(3) = (\\,0.10,\\,0.24,\\,0.77\\,)$,\n      $\\mathbf{r}_2(3) = (\\,0.18,\\,0.05,\\,0.08\\,)$,\n      $\\mathbf{r}_3(3) = (\\,0.02,\\,0.04,\\,0.02\\,)$.\n- Case $3$ (edge case at exactly half-box displacements in components):\n  - Box: $\\mathbf{L} = (\\,1.0,\\,1.0,\\,1.0\\,)$ in $\\mathrm{nm}$.\n  - Number of atoms: $N=2$.\n  - Number of frames: $T=2$.\n  - Reference positions (in $\\mathrm{nm}$):\n    $\\mathbf{r}_1^{ref} = (\\,0.25,\\,0.25,\\,0.25\\,)$,\n    $\\mathbf{r}_2^{ref} = (\\,0.75,\\,0.75,\\,0.75\\,)$.\n  - Trajectory frames (wrapped coordinates, in $\\mathrm{nm}$):\n    $t=1$:\n      $\\mathbf{r}_1(1) = (\\,0.75,\\,0.25,\\,0.25\\,)$,\n      $\\mathbf{r}_2(1) = (\\,0.25,\\,0.75,\\,0.75\\,)$.\n    $t=2$:\n      $\\mathbf{r}_1(2) = (\\,0.75,\\,0.75,\\,0.25\\,)$,\n      $\\mathbf{r}_2(2) = (\\,0.25,\\,0.25,\\,0.75\\,)$.\n\nProgram requirements:\n- Implement functions to compute $\\overline{R}^{wrap}$, $\\overline{R}^{MIC}$, $\\overline{\\mathrm{F}}^{wrap}$, and $\\overline{\\mathrm{F}}^{MIC}$ exactly as described above, using the specified tie-breaking rule for the minimal-image selection (nearest integer with ties resolved to the even integer) independently in each Cartesian component.\n- Units: inputs are in $\\mathrm{nm}$ and outputs must be in $\\mathrm{nm}$.\n- Output rounding: round each reported float to $6$ decimal places.\n- Final output format: a single line containing a list of results for all test cases, where each test case contributes a list of four floats in the order $[\\,\\overline{R}^{wrap},\\,\\overline{R}^{MIC},\\,\\overline{\\mathrm{F}}^{wrap},\\,\\overline{\\mathrm{F}}^{MIC}\\,]$. The overall output must be a single list of these lists, printed exactly as a Python list literal, for example, $[\\,[a_1,b_1,c_1,d_1],\\,[a_2,b_2,c_2,d_2],\\,[a_3,b_3,c_3,d_3]\\,]$.", "solution": "The core of this problem is to compare a \"naive\" calculation of RMSD and RMSF, which ignores particles crossing periodic boundaries, with a \"corrected\" calculation that accounts for such crossings using the minimal-image convention (MIC). We are tasked with quantifying this difference for both metrics. The computational procedure is outlined below based on the provided definitions.\n\nAll positions $\\mathbf{r}$ and box lengths $\\mathbf{L}$ are vectors in $\\mathbb{R}^3$. We are given a set of $N$ atoms, a reference configuration $\\{\\mathbf{r}_i^{ref}\\}_{i=1}^N$, and a trajectory of $T$ time frames, $\\{\\mathbf{r}_i(t)\\}_{i=1, t=1}^{N, T}$.\n\n**1. Displacement Conventions**\n\n*   **Naive Wrapped Displacement ($\\Delta\\mathbf{r}^{wrap}$):** This is the simple vector difference between the wrapped coordinates at time $t$ and the reference coordinates.\n    $$ \\Delta\\mathbf{r}_i^{wrap}(t) = \\mathbf{r}_i(t) - \\mathbf{r}_i^{ref} $$\n\n*   **Minimal-Image Corrected Displacement ($\\Delta\\mathbf{r}^{MIC}$):** This convention corrects the wrapped displacement by finding the periodic image of atom $i$ at time $t$ that is closest to its reference position. For an orthorhombic box with side lengths $\\mathbf{L}=(L_x, L_y, L_z)$, the corrected displacement is:\n    $$ \\Delta\\mathbf{r}_i^{MIC}(t) = \\Delta\\mathbf{r}_i^{wrap}(t) + \\mathbf{n}_i(t) \\circ \\mathbf{L} $$\n    where $\\circ$ is the element-wise product and $\\mathbf{n}_i(t)$ is a vector of integers chosen to minimize the norm $\\|\\Delta\\mathbf{r}_i^{MIC}(t)\\|$. This is achieved for each Cartesian component $\\alpha$ by choosing an integer $n_{i, \\alpha}(t) = -\\text{round}\\left(\\frac{\\Delta r_{i, \\alpha}^{wrap}(t)}{L_{\\alpha}}\\right)$, with the specified tie-breaking rule.\n\n**2. Root-Mean-Square Deviation (RMSD)**\n\nFirst, for each time frame $t$, we compute the instantaneous root-mean-square distance, $R(t)$:\n$$ R(t) = \\sqrt{\\frac{1}{N}\\sum_{i=1}^N \\|\\Delta\\mathbf{r}_i(t)\\|^2} $$\nThe final reported RMSD, $\\overline{R}$, is the time-average of $R(t)$:\n$$ \\overline{R} = \\frac{1}{T}\\sum_{t=1}^T R(t) $$\nThis is computed for both displacement conventions to get $\\overline{R}^{wrap}$ and $\\overline{R}^{MIC}$.\n\n**3. Root-Mean-Square Fluctuation (RMSF)**\n\nFirst, we reconstruct a continuous (unwrapped) trajectory, $\\mathbf{u}_i(t)$:\n$$ \\mathbf{u}_i(t) = \\mathbf{r}_i^{ref} + \\Delta\\mathbf{r}_i(t) $$\nNext, we find the time-averaged position for each atom, $\\overline{\\mathbf{u}}_i$:\n$$ \\overline{\\mathbf{u}}_i = \\frac{1}{T}\\sum_{t=1}^T \\mathbf{u}_i(t) $$\nThe RMSF for atom $i$, $\\mathrm{RMSF}_i$, is:\n$$ \\mathrm{RMSF}_i = \\sqrt{\\frac{1}{T}\\sum_{t=1}^T \\|\\mathbf{u}_i(t) - \\overline{\\mathbf{u}}_i\\|^2} $$\nThe final reported value, $\\overline{\\mathrm{F}}$, is the average of the individual atomic RMSF values:\n$$ \\overline{\\mathrm{F}} = \\frac{1}{N}\\sum_{i=1}^N \\mathrm{RMSF}_i $$\nThis is computed for both displacement conventions to get $\\overline{\\mathrm{F}}^{wrap}$ and $\\overline{\\mathrm{F}}^{MIC}$.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to process all test cases and print the final results.\n    \"\"\"\n    test_cases = [\n        {\n            \"L\": (1.0, 1.0, 1.0),\n            \"N\": 1,\n            \"T\": 4,\n            \"ref_pos\": [[0.90, 0.00, 0.00]],\n            \"traj\": [\n                [[0.90, 0.00, 0.00]],\n                [[0.95, 0.00, 0.00]],\n                [[0.98, 0.00, 0.00]],\n                [[0.02, 0.00, 0.00]],\n            ],\n        },\n        {\n            \"L\": (2.0, 1.0, 1.5),\n            \"N\": 3,\n            \"T\": 3,\n            \"ref_pos\": [\n                [1.80, 0.20, 0.75],\n                [0.10, 0.90, 0.10],\n                [1.99, 0.05, 1.49],\n            ],\n            \"traj\": [\n                [\n                    [1.85, 0.22, 0.78],\n                    [0.15, 0.92, 0.14],\n                    [1.98, 0.06, 1.48],\n                ],\n                [\n                    [0.05, 0.22, 0.78],\n                    [0.15, 0.02, 0.14],\n                    [1.98, 0.06, 0.01],\n                ],\n                [\n                    [0.10, 0.24, 0.77],\n                    [0.18, 0.05, 0.08],\n                    [0.02, 0.04, 0.02],\n                ],\n            ],\n        },\n        {\n            \"L\": (1.0, 1.0, 1.0),\n            \"N\": 2,\n            \"T\": 2,\n            \"ref_pos\": [\n                [0.25, 0.25, 0.25],\n                [0.75, 0.75, 0.75],\n            ],\n            \"traj\": [\n                [\n                    [0.75, 0.25, 0.25],\n                    [0.25, 0.75, 0.75],\n                ],\n                [\n                    [0.75, 0.75, 0.25],\n                    [0.25, 0.25, 0.75],\n                ]\n            ],\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        case_results = _compute_metrics_for_case(case)\n        results.append(case_results)\n\n    # The string representation of a list of lists is the required format.\n    print(str(results))\n\ndef _get_mic_displacements(delta_r_wrap, L_array):\n    \"\"\"\n    Computes minimal-image corrected displacements from wrapped displacements.\n    The tie-breaking rule (round half to nearest even integer) is the default\n    behavior of numpy.round().\n    \"\"\"\n    scaled_dr = delta_r_wrap / L_array\n    n = -np.round(scaled_dr)\n    delta_r_mic = delta_r_wrap + n * L_array\n    return delta_r_mic\n\ndef _compute_avg_rmsd(displacements, N, T):\n    \"\"\"Computes time-averaged RMSD from a displacement array.\"\"\"\n    sq_norms = np.sum(displacements**2, axis=2)  # Shape: (T, N)\n    msd_t = np.mean(sq_norms, axis=1)           # Shape: (T,)\n    R_t = np.sqrt(msd_t)\n    avg_R = np.mean(R_t)\n    return avg_R\n\ndef _compute_avg_rmsf(displacements, ref_pos, N, T):\n    \"\"\"Computes atom-averaged RMSF from a displacement array and reference positions.\"\"\"\n    # Reconstruct continuous trajectory u_i(t) = r_ref_i + delta_r_i(t)\n    # ref_pos has shape (N, 3). Add new axis to broadcast to (T, N, 3)\n    u = ref_pos[np.newaxis, :, :] + displacements\n    \n    # Compute time-averaged position for each atom, u_mean has shape (N, 3)\n    u_mean = np.mean(u, axis=0)\n    \n    # Calculate deviations from the mean: u(t) - u_mean\n    # u_mean has shape (N, 3). Add new axis to broadcast to (T, N, 3)\n    dev_from_mean = u - u_mean[np.newaxis, :, :]\n    \n    # Compute RMSF per atom\n    sq_norms_dev = np.sum(dev_from_mean**2, axis=2) # Shape: (T, N)\n    msd_i = np.mean(sq_norms_dev, axis=0)          # Shape: (N,)\n    RMSF_i = np.sqrt(msd_i)\n    \n    # Average RMSF over all atoms\n    avg_F = np.mean(RMSF_i)\n    return avg_F\n\ndef _compute_metrics_for_case(case_data):\n    \"\"\"\n    Processes a single test case to compute all four required metrics.\n    \"\"\"\n    L = np.array(case_data[\"L\"])\n    ref_pos = np.array(case_data[\"ref_pos\"])\n    traj = np.array(case_data[\"traj\"])\n    N = case_data[\"N\"]\n    T = case_data[\"T\"]\n\n    # Calculate wrapped displacements: traj - ref_pos\n    # ref_pos has shape (N, 3). Add a new axis to broadcast to (T, N, 3).\n    delta_r_wrap = traj - ref_pos[np.newaxis, :, :]\n\n    # Calculate minimal-image corrected displacements\n    delta_r_mic = _get_mic_displacements(delta_r_wrap, L)\n\n    # Compute RMSD for both conventions\n    R_wrap = _compute_avg_rmsd(delta_r_wrap, N, T)\n    R_mic = _compute_avg_rmsd(delta_r_mic, N, T)\n\n    # Compute RMSF for both conventions\n    F_wrap = _compute_avg_rmsf(delta_r_wrap, ref_pos, N, T)\n    F_mic = _compute_avg_rmsf(delta_r_mic, ref_pos, N, T)\n\n    # Round results to 6 decimal places\n    return [\n        round(R_wrap, 6),\n        round(R_mic, 6),\n        round(F_wrap, 6),\n        round(F_mic, 6)\n    ]\n\n# Run the solution\nsolve()\n```", "id": "3443654"}, {"introduction": "Calculating a Root-Mean-Square Fluctuation (RMSF) profile provides a descriptive map of a molecule's flexibility, but the ultimate scientific goal is often to compare flexibility between different conditions. Simply observing differences in RMSF plots is not enough; we must determine if these differences are statistically significant or due to random sampling variation. This exercise introduces a rigorous statistical framework for comparing RMSF profiles from two simulations, culminating in the application of the Benjamini-Hochberg procedure to control the false discovery rate across multiple atomic comparisons, a crucial step in translating simulation data into robust scientific insights [@problem_id:3443697].", "problem": "Consider two independent all-atom Molecular Dynamics (MD) simulations of the same protein under two conditions. For each atom index $i \\in \\{1,\\dots,m\\}$, define the per-atom Root-Mean-Square Fluctuation (RMSF) as $f_{i}(t) = \\sqrt{\\langle \\|\\mathbf{r}_{i}(t) - \\langle \\mathbf{r}_{i}(t) \\rangle_{t}\\|^{2} \\rangle_{t}}$, where $\\mathbf{r}_{i}(t)$ is the Cartesian position of atom $i$ at time $t$, and $\\langle \\cdot \\rangle_{t}$ denotes a time average over the trajectory of a single simulation. To mitigate time correlation, each simulation is partitioned into $n$ non-overlapping blocks of equal duration. Within each block, a block-level RMSF estimate is computed; the across-block sample mean is taken as the per-simulation RMSF summary for atom $i$, and the across-block sample variance quantifies between-block variability. Assume stationarity, ergodicity, and that the block size is sufficiently large so that block-level RMSF estimates are approximately independent across blocks.\n\nYou are given the following per-atom, per-simulation summary statistics aggregated over $n^{(1)} = n^{(2)} = n = 40$ blocks for $m = 6$ atoms. For each atom $i$, $\\bar{f}_{i}^{(1)}$ and $s_{i,1}^{2}$ denote the across-block sample mean and sample variance of the block-level RMSF estimates in simulation $1$; analogously, $\\bar{f}_{i}^{(2)}$ and $s_{i,2}^{2}$ are from simulation $2$. All variances are in units of squared Ångströms, and all means are in Ångströms. The data are:\n- Atom $1$: $\\bar{f}_{1}^{(1)} = 1.934164079$, $s_{1,1}^{2} = 0.04$; $\\bar{f}_{1}^{(2)} = 1.800000000$, $s_{1,2}^{2} = 0.04$.\n- Atom $2$: $\\bar{f}_{2}^{(1)} = 2.061803399$, $s_{2,1}^{2} = 0.04$; $\\bar{f}_{2}^{(2)} = 1.950000000$, $s_{2,2}^{2} = 0.04$.\n- Atom $3$: $\\bar{f}_{3}^{(1)} = 2.198386991$, $s_{3,1}^{2} = 0.04$; $\\bar{f}_{3}^{(2)} = 2.100000000$, $s_{3,2}^{2} = 0.04$.\n- Atom $4$: $\\bar{f}_{4}^{(1)} = 1.780498447$, $s_{4,1}^{2} = 0.04$; $\\bar{f}_{4}^{(2)} = 1.700000000$, $s_{4,2}^{2} = 0.04$.\n- Atom $5$: $\\bar{f}_{5}^{(1)} = 2.267082040$, $s_{5,1}^{2} = 0.04$; $\\bar{f}_{5}^{(2)} = 2.200000000$, $s_{5,2}^{2} = 0.04$.\n- Atom $6$: $\\bar{f}_{6}^{(1)} = 1.622360680$, $s_{6,1}^{2} = 0.04$; $\\bar{f}_{6}^{(2)} = 1.600000000$, $s_{6,2}^{2} = 0.04$.\n\nTasks:\n- Starting from the definition of Root-Mean-Square Fluctuation (RMSF) and basic limit theorems for sample means, formulate a two-sample hypothesis test to assess, for each atom $i$, the null hypothesis that the long-time mean block-level RMSF is equal between the two simulations, against a two-sided alternative. Explicitly identify the test statistic and its asymptotic sampling distribution under the null when block counts are large and block-level estimates are independent.\n- Using only the given summary statistics, compute the two-sided $p$-value for each atom under your test.\n- To control the False Discovery Rate (FDR; defined as the expected proportion of false rejections among all rejections) at target level $q = 0.10$ across the $m = 6$ atom-wise hypotheses, derive the Benjamini–Hochberg (BH) decision rule from first principles of ordering $p$-values, and apply it to your six $p$-values.\n- Report the number $k$ of atoms declared significantly different between the two simulations at FDR level $q = 0.10$. Your final answer must be a single integer (unitless). Do not round any intermediate $p$-values; the BH decision depends only on their order and comparison to rational thresholds of $q$ and $m$.", "solution": "**Task 1: Formulate the Hypothesis Test**\n\nFor each atom $i \\in \\{1,\\dots,6\\}$, we want to test if the true long-time mean of the block-level RMSF is the same in both simulations. Let $\\mu_{i}^{(1)}$ and $\\mu_{i}^{(2)}$ be the true mean block-level RMSF for atom $i$ in simulation $1$ and $2$, respectively. We formulate a two-sample hypothesis test for each atom:\n- Null Hypothesis $H_{0,i}: \\mu_{i}^{(1)} = \\mu_{i}^{(2)}$\n- Alternative Hypothesis $H_{A,i}: \\mu_{i}^{(1)} \\neq \\mu_{i}^{(2)}$ (two-sided)\n\nWe are given sample means ($\\bar{f}_{i}^{(1)}$, $\\bar{f}_{i}^{(2)}$), sample variances ($s_{i,1}^{2}$, $s_{i,2}^{2}$), and sample sizes ($n^{(1)}=n^{(2)}=n=40$) from two independent simulations. The block size is assumed to be large enough for the block-level estimates to be approximately independent. Since the number of blocks $n=40$ is large, by the Central Limit Theorem, the sampling distribution of the sample mean $\\bar{f}_{i}^{(k)}$ is approximately normal.\n\nThe appropriate test statistic is the Welch's t-statistic for two independent samples, which does not assume equal population variances. The statistic for atom $i$ is:\n$$ T_i = \\frac{(\\bar{f}_{i}^{(1)} - \\bar{f}_{i}^{(2)}) - (\\mu_{i}^{(1)} - \\mu_{i}^{(2)})}{ \\sqrt{ \\frac{s_{i,1}^{2}}{n^{(1)}} + \\frac{s_{i,2}^{2}}{n^{(2)}} } } $$\nUnder the null hypothesis $H_{0,i}$, $\\mu_{i}^{(1)} - \\mu_{i}^{(2)} = 0$. For large sample sizes ($n \\ge 30$), the t-distribution converges to the standard normal distribution. Thus, the asymptotic sampling distribution of the test statistic under the null is the standard normal distribution, $Z \\sim N(0,1)$. We will denote the value of the test statistic as $Z_i$:\n$$ Z_i = \\frac{\\bar{f}_{i}^{(1)} - \\bar{f}_{i}^{(2)}}{ \\sqrt{ \\frac{s_{i,1}^{2}}{n^{(1)}} + \\frac{s_{i,2}^{2}}{n^{(2)}} } } $$\n\n**Task 2: Compute p-values**\n\nFirst, we compute the standard error of the difference in means. Since $s_{i,1}^{2} = s_{i,2}^{2} = 0.04$ and $n^{(1)}=n^{(2)}=40$ for all atoms, this term is constant:\n$$ SE_{\\Delta} = \\sqrt{\\frac{0.04}{40} + \\frac{0.04}{40}} = \\sqrt{2 \\times \\frac{0.04}{40}} = \\sqrt{0.002} = \\frac{\\sqrt{5}}{50} $$\nNext, we compute the $Z_i$ statistic for each atom:\n- Atom $1$: $\\Delta_1 = 1.934164079 - 1.8 = 0.134164079$.\n  $Z_1 = \\frac{0.134164079}{\\sqrt{5}/50} \\approx 3.00$\n- Atom $2$: $\\Delta_2 = 2.061803399 - 1.95 = 0.111803399$.\n  $Z_2 = \\frac{0.111803399}{\\sqrt{5}/50} \\approx 2.50$\n- Atom $3$: $\\Delta_3 = 2.198386991 - 2.1 = 0.098386991$.\n  $Z_3 = \\frac{0.098386991}{\\sqrt{5}/50} \\approx 2.20$\n- Atom $4$: $\\Delta_4 = 1.780498447 - 1.7 = 0.080498447$.\n  $Z_4 = \\frac{0.080498447}{\\sqrt{5}/50} \\approx 1.80$\n- Atom $5$: $\\Delta_5 = 2.267082040 - 2.2 = 0.067082040$.\n  $Z_5 = \\frac{0.067082040}{\\sqrt{5}/50} \\approx 1.50$\n- Atom $6$: $\\Delta_6 = 1.622360680 - 1.6 = 0.022360680$.\n  $Z_6 = \\frac{0.022360680}{\\sqrt{5}/50} \\approx 0.50$\n\nThe two-sided $p$-value for each atom is $p_i = 2 \\cdot P(Z > |Z_i|) = 2(1 - \\Phi(|Z_i|))$, where $\\Phi$ is the cumulative distribution function of the standard normal distribution.\n- $p_1 = 2(1 - \\Phi(3.0)) \\approx 0.0027$\n- $p_2 = 2(1 - \\Phi(2.5)) \\approx 0.0124$\n- $p_3 = 2(1 - \\Phi(2.2)) \\approx 0.0278$\n- $p_4 = 2(1 - \\Phi(1.8)) \\approx 0.0719$\n- $p_5 = 2(1 - \\Phi(1.5)) \\approx 0.1336$\n- $p_6 = 2(1 - \\Phi(0.5)) \\approx 0.6171$\n\n**Task 3: Apply the Benjamini–Hochberg (BH) Procedure**\n\nThe Benjamini-Hochberg procedure controls the False Discovery Rate (FDR). The decision rule is as follows:\n1.  Let the $m=6$ individual $p$-values be $p_1, \\dots, p_6$.\n2.  Order these $p$-values from smallest to largest: $p_{(1)} \\le p_{(2)} \\le \\dots \\le p_{(6)}$. Since $|Z_1| > |Z_2| > \\dots > |Z_6|$, the $p$-values are already ordered: $p_{(j)} = p_j$.\n3.  For each ordered $p$-value, find the largest integer $k$ such that $p_{(k)} \\le \\frac{k}{m}q$. Here $m=6$ and $q=0.10$.\n4.  Reject the null hypotheses $H_{0,(1)}, \\dots, H_{0,(k)}$.\n\nWe compare each $p_{(j)}$ to its critical value $\\frac{j}{6}(0.10)$:\n\n- For $j=1$: $p_{(1)} \\approx 0.0027$. Threshold is $\\frac{1}{6}(0.10) \\approx 0.0167$.\n  $0.0027 \\le 0.0167$. The condition holds.\n- For $j=2$: $p_{(2)} \\approx 0.0124$. Threshold is $\\frac{2}{6}(0.10) \\approx 0.0333$.\n  $0.0124 \\le 0.0333$. The condition holds.\n- For $j=3$: $p_{(3)} \\approx 0.0278$. Threshold is $\\frac{3}{6}(0.10) = 0.05$.\n  $0.0278 \\le 0.05$. The condition holds.\n- For $j=4$: $p_{(4)} \\approx 0.0719$. Threshold is $\\frac{4}{6}(0.10) \\approx 0.0667$.\n  $0.0719 > 0.0667$. The condition fails.\n\nThe largest index $k$ for which the condition $p_{(k)} \\le \\frac{k}{m}q$ is satisfied is $k=3$.\n\n**Task 4: Report the number of significant differences**\n\nAccording to the BH procedure, we reject the null hypotheses for the first $k=3$ atoms (atom $1$, atom $2$, and atom $3$). The number of atoms declared to have a significantly different RMSF between the two simulations, at an FDR level of $q=0.10$, is $3$.", "answer": "$$\n\\boxed{3}\n$$", "id": "3443697"}]}