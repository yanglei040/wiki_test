{"hands_on_practices": [{"introduction": "To effectively use constant pH molecular dynamics (cpHMD), one must first grasp its statistical mechanical foundation. These methods work by coupling the simulated system to a theoretical proton reservoir, which is governed by the semi-grand canonical ensemble. The key thermodynamic quantity is the semi-grand potential, which incorporates the chemical potential of protons, $\\mu_{\\mathrm{H}^{+}}$, and thus the macroscopic pH. This foundational exercise guides you through the first-principles derivation that connects the pH of the reservoir to the equilibrium probability ratio of a site being protonated versus deprotonated, providing a concrete link between the simulation parameters and the underlying physical chemistry.", "problem": "A single titratable site in a solute undergoes the unimolecular deprotonation reaction $\\mathrm{AH} \\rightleftharpoons \\mathrm{A}^{-} + \\mathrm{H}^{+}$. In a constant potential of hydrogen (pH) molecular dynamics (MD) simulation, proton exchange with a reservoir is modeled using the semi-grand canonical (SGC) ensemble, in which the appropriate thermodynamic potential for a state that differs by the number of bound protons is the semi-grand potential. Assume an ideal solution for the proton so that the hydrogen ion activity is $a_{\\mathrm{H}^{+}} = 10^{-\\mathrm{pH}}$. The chemical potential of the proton in the reservoir is $\\mu_{\\mathrm{H}^{+}} = \\mu_{\\mathrm{H}^{+}}^{\\circ} + R T \\ln a_{\\mathrm{H}^{+}}$, where $R$ is the molar gas constant and $T$ is the absolute temperature. The standard deprotonation free energy $\\Delta G^{\\circ}$ is defined as the reaction free energy at unit hydrogen activity ($a_{\\mathrm{H}^{+}} = 1$).\n\nStarting only from the definitions above (chemical potentials, Boltzmann weights, and ideal activities), and without assuming any target formula, do the following:\n\n1. Derive the semi-grand potential difference $\\Delta G_{\\mathrm{sg}}$ between the deprotonated state $\\mathrm{A}^{-}$ and the protonated state $\\mathrm{AH}$ as an explicit function of $\\Delta G^{\\circ}$, $R$, $T$, and $\\mathrm{pH}$. Clearly state any ensemble or statistical assumptions you use. Use the molar inverse thermal energy $\\beta \\equiv \\frac{1}{R T}$.\n\n2. Using your result from part 1, derive the ratio of probabilities, $\\frac{P(\\mathrm{A}^{-})}{P(\\mathrm{AH})}$, implied by the SGC Boltzmann weights at temperature $T$, and show how this ratio depends on $\\Delta G^{\\circ}$ and $\\mathrm{pH}$.\n\nFinally, evaluate the ratio numerically for the specific case:\n- $T = 298.15 \\,\\mathrm{K}$,\n- $\\mathrm{pH} = 7.000$,\n- $\\Delta G^{\\circ} = 6.000\\, R T \\ln 10$.\n\nReport the final probability ratio $\\frac{P(\\mathrm{A}^{-})}{P(\\mathrm{AH})}$ as a pure number with no units, rounded to three significant figures. Do not report any intermediate quantities as your final answer.", "solution": "The problem has been validated and is deemed a well-posed, scientifically sound problem in physical chemistry and statistical mechanics.\n\nThis problem requires the derivation of thermodynamic and statistical mechanical properties of a titratable site in a constant pH molecular dynamics simulation. The derivation will proceed in three parts as requested.\n\n**Part 1: Derivation of the semi-grand potential difference $\\Delta G_{\\mathrm{sg}}$**\n\nThe system consists of a solute with a single titratable site, which can exist in a protonated state, $\\mathrm{AH}$, or a deprotonated state, $\\mathrm{A}^{-}$. The simulation is performed in the semi-grand canonical (SGC) ensemble at constant temperature $T$ and pressure $P$, where the system can exchange protons with a reservoir at a fixed chemical potential $\\mu_{\\mathrm{H}^{+}}$.\n\nThe thermodynamic potential for a state $i$ in this ensemble is the semi-grand potential, $G_{\\mathrm{sg},i}$, defined as:\n$$G_{\\mathrm{sg},i} = G_i - N_i \\mu_{\\mathrm{H}^{+}}$$\nwhere $G_i$ is the Gibbs free energy of the system in state $i$, and $N_i$ is the number of protons bound to the titratable site in that state.\n\nLet's define the two states of the system:\n1.  The protonated state, $\\mathrm{AH}$. The Gibbs free energy of the system with the solute in this state is $G_{\\mathrm{AH}}$. The number of bound protons is $N_{\\mathrm{AH}} = 1$.\n2.  The deprotonated state, $\\mathrm{A}^{-}$. The Gibbs free energy of the system with the solute in this state is $G_{\\mathrm{A}^{-}}$. The number of bound protons is $N_{\\mathrm{A}^{-}} = 0$.\n\nThe semi-grand potentials for these two states are:\n$$G_{\\mathrm{sg}}(\\mathrm{AH}) = G_{\\mathrm{AH}} - (1) \\mu_{\\mathrm{H}^{+}} = G_{\\mathrm{AH}} - \\mu_{\\mathrm{H}^{+}}$$\n$$G_{\\mathrm{sg}}(\\mathrm{A}^{-}) = G_{\\mathrm{A}^{-}} - (0) \\mu_{\\mathrm{H}^{+}} = G_{\\mathrm{A}^{-}}$$\n\nThe problem asks for the semi-grand potential difference $\\Delta G_{\\mathrm{sg}}$ between the deprotonated state $\\mathrm{A}^{-}$ and the protonated state $\\mathrm{AH}$:\n$$\\Delta G_{\\mathrm{sg}} = G_{\\mathrm{sg}}(\\mathrm{A}^{-}) - G_{\\mathrm{sg}}(\\mathrm{AH}) = G_{\\mathrm{A}^{-}} - (G_{\\mathrm{AH}} - \\mu_{\\mathrm{H}^{+}}) = (G_{\\mathrm{A}^{-}} - G_{\\mathrm{AH}}) + \\mu_{\\mathrm{H}^{+}}$$\n\nThe term $(G_{\\mathrm{A}^{-}} - G_{\\mathrm{AH}})$ represents the intrinsic Gibbs free energy change of deprotonating the site within the solution, which we can denote as $\\Delta G_{\\mathrm{deprot, intrinsic}}$. Thus,\n$$\\Delta G_{\\mathrm{sg}} = \\Delta G_{\\mathrm{deprot, intrinsic}} + \\mu_{\\mathrm{H}^{+}}$$\n\nNext, we must relate $\\Delta G_{\\mathrm{deprot, intrinsic}}$ to the standard deprotonation free energy, $\\Delta G^{\\circ}$. The problem states that $\\Delta G^{\\circ}$ is the reaction free energy for $\\mathrm{AH} \\rightleftharpoons \\mathrm{A}^{-} + \\mathrm{H}^{+}$ at unit hydrogen activity ($a_{\\mathrm{H}^{+}} = 1$). The reaction free energy under any condition is the sum of the free energies of the products minus the reactants. For this heterogeneous reaction (solute deprotonates, proton enters the reservoir), this is precisely $\\Delta G_{\\mathrm{sg}}$.\n\nA more formal approach is to define $\\Delta G^{\\circ}$ based on the standard chemical potentials. The reaction free energy is:\n$$\\Delta G_{\\mathrm{rxn}} = (\\mu_{\\mathrm{A}^{-}} + \\mu_{\\mathrm{H}^{+}}) - \\mu_{\\mathrm{AH}}$$\nThe standard free energy change $\\Delta G^{\\circ}$ is:\n$$\\Delta G^{\\circ} = (\\mu_{\\mathrm{A}^{-}}^{\\circ} + \\mu_{\\mathrm{H}^{+}}^{\\circ}) - \\mu_{\\mathrm{AH}}^{\\circ}$$\nwhere $\\mu^{\\circ}$ denotes the standard chemical potential. The intrinsic free energy difference $(G_{\\mathrm{A}^{-}} - G_{\\mathrm{AH}})$ corresponds to the difference in standard chemical potentials of the two solute forms, $(\\mu_{\\mathrm{A}^{-}}^{\\circ} - \\mu_{\\mathrm{AH}}^{\\circ})$.\nFrom the definition of $\\Delta G^{\\circ}$, we can write:\n$$\\mu_{\\mathrm{A}^{-}}^{\\circ} - \\mu_{\\mathrm{AH}}^{\\circ} = \\Delta G^{\\circ} - \\mu_{\\mathrm{H}^{+}}^{\\circ}$$\nSo, $\\Delta G_{\\mathrm{deprot, intrinsic}} = G_{\\mathrm{A}^{-}} - G_{\\mathrm{AH}} = \\Delta G^{\\circ} - \\mu_{\\mathrm{H}^{+}}^{\\circ}$.\n\nSubstituting this into our expression for $\\Delta G_{\\mathrm{sg}}$:\n$$\\Delta G_{\\mathrm{sg}} = (\\Delta G^{\\circ} - \\mu_{\\mathrm{H}^{+}}^{\\circ}) + \\mu_{\\mathrm{H}^{+}} = \\Delta G^{\\circ} + (\\mu_{\\mathrm{H}^{+}} - \\mu_{\\mathrm{H}^{+}}^{\\circ})$$\nThe problem provides the expression for the proton chemical potential in the reservoir:\n$$\\mu_{\\mathrm{H}^{+}} = \\mu_{\\mathrm{H}^{+}}^{\\circ} + R T \\ln a_{\\mathrm{H}^{+}}$$\nTherefore, the difference $(\\mu_{\\mathrm{H}^{+}} - \\mu_{\\mathrm{H}^{+}}^{\\circ})$ is $R T \\ln a_{\\mathrm{H}^{+}}$.\nSubstituting this gives:\n$$\\Delta G_{\\mathrm{sg}} = \\Delta G^{\\circ} + R T \\ln a_{\\mathrm{H}^{+}}$$\nWe are given that $a_{\\mathrm{H}^{+}} = 10^{-\\mathrm{pH}}$. Using the property of logarithms $\\ln(x^y) = y \\ln x$:\n$$\\ln a_{\\mathrm{H}^{+}} = \\ln(10^{-\\mathrm{pH}}) = -\\mathrm{pH} \\ln 10$$\nSubstituting this into the expression for $\\Delta G_{\\mathrm{sg}}$ yields the final result for Part 1:\n$$\\Delta G_{\\mathrm{sg}} = \\Delta G^{\\circ} - R T \\cdot \\mathrm{pH} \\ln 10$$\nUsing the molar inverse thermal energy $\\beta \\equiv \\frac{1}{R T}$, this can be written as:\n$$\\Delta G_{\\mathrm{sg}} = \\Delta G^{\\circ} - \\frac{1}{\\beta} \\mathrm{pH} \\ln 10$$\n\n**Part 2: Derivation of the probability ratio $\\frac{P(\\mathrm{A}^{-})}{P(\\mathrm{AH})}$**\n\nIn the SGC ensemble, the probability $P_i$ of a system being in a state $i$ with semi-grand potential $G_{\\mathrm{sg},i}$ is given by the Boltzmann weight:\n$$P_i \\propto \\exp(-\\beta G_{\\mathrm{sg},i})$$\nwhere $\\beta = \\frac{1}{R T}$ is the molar inverse thermal energy.\n\nThe probabilities of the deprotonated and protonated states are:\n$$P(\\mathrm{A}^{-}) \\propto \\exp(-\\beta G_{\\mathrm{sg}}(\\mathrm{A}^{-}))$$\n$$P(\\mathrm{AH}) \\propto \\exp(-\\beta G_{\\mathrm{sg}}(\\mathrm{AH}))$$\n\nThe ratio of these probabilities is:\n$$\\frac{P(\\mathrm{A}^{-})}{P(\\mathrm{AH})} = \\frac{\\exp(-\\beta G_{\\mathrm{sg}}(\\mathrm{A}^{-}))}{\\exp(-\\beta G_{\\mathrm{sg}}(\\mathrm{AH}))} = \\exp[-\\beta (G_{\\mathrm{sg}}(\\mathrm{A}^{-}) - G_{\\mathrm{sg}}(\\mathrm{AH}))]$$\nThe term in the exponent is the semi-grand potential difference, $\\Delta G_{\\mathrm{sg}}$, derived in Part 1.\n$$\\frac{P(\\mathrm{A}^{-})}{P(\\mathrm{AH})} = \\exp(-\\beta \\Delta G_{\\mathrm{sg}})$$\nSubstituting the expression for $\\Delta G_{\\mathrm{sg}}$:\n$$\\frac{P(\\mathrm{A}^{-})}{P(\\mathrm{AH})} = \\exp(-\\beta (\\Delta G^{\\circ} - R T \\cdot \\mathrm{pH} \\ln 10))$$\nExpanding the exponent:\n$$\\frac{P(\\mathrm{A}^{-})}{P(\\mathrm{AH})} = \\exp(-\\beta \\Delta G^{\\circ} + \\beta R T \\cdot \\mathrm{pH} \\ln 10)$$\nSince $\\beta R T = (\\frac{1}{R T}) R T = 1$, the expression simplifies to:\n$$\\frac{P(\\mathrm{A}^{-})}{P(\\mathrm{AH})} = \\exp(-\\beta \\Delta G^{\\circ} + \\mathrm{pH} \\ln 10)$$\nThis expression gives the probability ratio as a function of $\\Delta G^{\\circ}$ and $\\mathrm{pH}$, as required.\n\n**Part 3: Numerical Evaluation**\n\nWe are asked to evaluate the probability ratio for the following specific case:\n- $T = 298.15 \\,\\mathrm{K}$\n- $\\mathrm{pH} = 7.000$\n- $\\Delta G^{\\circ} = 6.000\\, R T \\ln 10$\n\nWe use the formula derived in Part 2:\n$$\\frac{P(\\mathrm{A}^{-})}{P(\\mathrm{AH})} = \\exp(-\\beta \\Delta G^{\\circ} + \\mathrm{pH} \\ln 10)$$\nFirst, let's evaluate the term $-\\beta \\Delta G^{\\circ}$:\n$$-\\beta \\Delta G^{\\circ} = -\\frac{1}{R T} (6.000\\, R T \\ln 10) = -6.000 \\ln 10$$\nNow, substitute this and the value for $\\mathrm{pH}$ into the exponent:\n$$\\text{Exponent} = -6.000 \\ln 10 + 7.000 \\ln 10$$\n$$\\text{Exponent} = (7.000 - 6.000) \\ln 10 = 1.000 \\ln 10$$\nNow we compute the ratio:\n$$\\frac{P(\\mathrm{A}^{-})}{P(\\mathrm{AH})} = \\exp(1.000 \\ln 10) = \\exp(\\ln(10^{1.000})) = 10^{1.000} = 10.00$$\nThe problem requires the final answer to be rounded to three significant figures. A value of $10.00$ has four significant figures. Rounding this to three significant figures gives $10.0$.\nThis result is consistent with the Henderson-Hasselbalch equation. The given $\\Delta G^{\\circ}$ corresponds to a $\\mathrm{p}K_{\\mathrm{a}}$ value, since $\\Delta G^{\\circ} = -R T \\ln K_a = R T \\ln(10) \\cdot \\mathrm{p}K_a$. Comparing this with $\\Delta G^{\\circ} = 6.000 R T \\ln 10$, we find $\\mathrm{p}K_a = 6.000$. The ratio is then given by $10^{\\mathrm{pH}-\\mathrm{p}K_a} = 10^{7.000 - 6.000} = 10^{1.000} = 10.00$. Rounded to three significant figures, the result is $10.0$.", "answer": "$$\n\\boxed{10.0}\n$$", "id": "3404536"}, {"introduction": "Moving from ideal theory to computational practice reveals challenges that must be addressed for accurate results. A crucial aspect of simulating charged molecules is the use of periodic boundary conditions and Ewald summation methods for electrostatics. This practice problem [@problem_id:3404560] delves into the finite-size artifacts that arise, specifically the artificial interaction of a solute's net charge with its periodic images and the neutralizing background charge required in such calculations. Understanding and quantifying this effect is essential, as it introduces a systematic, size-dependent error in the calculation of free energies and, consequently, in the predicted $\\mathrm{p}K_{\\mathrm{a}}$ values.", "problem": "In a constant pH Molecular Dynamics (MD) simulation using Particle Mesh Ewald (PME) electrostatics under conducting boundary conditions, consider a deprotonation/protonation step that changes the solute net charge by $\\Delta q = +1\\,e$ in a periodically replicated, explicit-water, cubic simulation cell of side length $L = 6\\,\\mathrm{nm}$ at temperature $T = 298\\,\\mathrm{K}$. Assume that the dominant finite-size artifact in the computed charging free energy arises from the interaction of the net charge with its periodic images and the uniform neutralizing background, and that higher multipole contributions can be neglected. The periodic Green’s function implies that the electrostatic potential at the position of a point charge due to its periodic images and the neutralizing background scales as $1/L$ times a geometry-dependent, dimensionless constant. For a simple-cubic lattice, this constant is $\\xi = 2.837297$. Take the solvent as a homogeneous dielectric with relative permittivity $\\varepsilon_{r} = 78.5$ (liquid water at $T=298\\,\\mathrm{K}$). Use the Coulomb constant in Molecular Dynamics units $k_{\\mathrm{e}} = 138.935456\\,\\mathrm{kJ\\,mol^{-1}\\,nm\\,e^{-2}}$, the universal gas constant $R = 8.314462618\\,\\mathrm{J\\,mol^{-1}\\,K^{-1}}$, and $\\ln 10 = 2.302585093$.\n\nStarting only from basic electrostatics and thermodynamics, namely that the work to charge from $0$ to $q$ in a linear medium is $W = \\int_{0}^{q} \\phi(q^{\\prime})\\,\\mathrm{d}q^{\\prime}$ with $\\phi$ the electrostatic potential at the charging site, and that the standard free energy of reaction satisfies $\\Delta G = - R T \\ln K$ with $\\mathrm{p}K = -\\log_{10} K$, do the following:\n\n1. Derive the scaling form for the image-interaction contribution to the charging free energy error and use it to estimate the magnitude of the finite-size correction $\\lvert \\Delta G_{\\mathrm{fs}} \\rvert$ for the given $\\Delta q$ and $L$.\n2. Translate this $\\lvert \\Delta G_{\\mathrm{fs}} \\rvert$ into the corresponding absolute shift in the inferred acid dissociation constant, $\\lvert \\Delta \\mathrm{p}K_{\\mathrm{a}} \\rvert$, at $T=298\\,\\mathrm{K}$.\n\nReport two values in order: first the magnitude of the free energy correction $\\lvert \\Delta G_{\\mathrm{fs}} \\rvert$ in $\\mathrm{kJ\\,mol^{-1}}$, and second the magnitude of the shift $\\lvert \\Delta \\mathrm{p}K_{\\mathrm{a}} \\rvert$ (dimensionless). Round both values to two significant figures. Express the final energy in $\\mathrm{kJ\\,mol^{-1}}$ and the final $\\mathrm{p}K_{\\mathrm{a}}$ shift as a pure number.", "solution": "### Solution Derivation\n\nThe problem requires a two-part calculation: first, the magnitude of the finite-size free energy artifact, $\\lvert \\Delta G_{\\mathrm{fs}} \\rvert$, and second, the corresponding shift in the acid dissociation constant, $\\lvert \\Delta \\mathrm{p}K_{\\mathrm{a}} \\rvert$.\n\n**Part 1: Finite-Size Free Energy Correction $\\lvert \\Delta G_{\\mathrm{fs}} \\rvert$**\n\nThe finite-size artifact in the electrostatic energy for a single point charge $q$ in a periodic cubic cell of side $L$ with dielectric constant $\\varepsilon_{r}$ and conducting boundary conditions is given by the work required to charge the particle from $0$ to $q$ against the potential created by its own periodic images and the neutralizing background.\n\nThe potential at the site of a charge $q'$ due to its images and the background is given as $\\phi_{\\mathrm{img}}(q')$. Based on the provided scaling law and fundamental electrostatics, this potential is:\n$$\n\\phi_{\\mathrm{img}}(q') = \\frac{k_{\\mathrm{e}} \\xi q'}{\\varepsilon_{r} L}\n$$\nHere, the charge $q'$ is in units of elementary charge $e$.\n\nThe work to create a charge $q$, which corresponds to its electrostatic self-energy contribution from the periodic setup, $G_{\\mathrm{fs}}(q)$, is obtained by integrating the potential, as per the given formula:\n$$\nG_{\\mathrm{fs}}(q) = W(q) = \\int_{0}^{q} \\phi_{\\mathrm{img}}(q') \\, \\mathrm{d}q' = \\int_{0}^{q} \\frac{k_{\\mathrm{e}} \\xi q'}{\\varepsilon_{r} L} \\, \\mathrm{d}q' = \\frac{k_{\\mathrm{e}} \\xi}{2 \\varepsilon_{r} L} q^2\n$$\nA chemical reaction, such as a protonation/deprotonation event, changes the charge of the solute from an initial state $q_{\\mathrm{i}}$ to a final state $q_{\\mathrm{f}}$. The change in the free energy artifact is the difference in the self-energies of the final and initial states:\n$$\n\\Delta G_{\\mathrm{fs}} = G_{\\mathrm{fs}}(q_{\\mathrm{f}}) - G_{\\mathrm{fs}}(q_{\\mathrm{i}}) = \\frac{k_{\\mathrm{e}} \\xi}{2 \\varepsilon_{r} L} (q_{\\mathrm{f}}^2 - q_{\\mathrm{i}}^2)\n$$\nThe problem specifies the change in charge is $\\Delta q = q_{\\mathrm{f}} - q_{\\mathrm{i}} = +1\\,e$. The expression for $\\Delta G_{\\mathrm{fs}}$ can be rewritten as:\n$$\n\\Delta G_{\\mathrm{fs}} = \\frac{k_{\\mathrm{e}} \\xi}{2 \\varepsilon_{r} L} (q_{\\mathrm{f}} - q_{\\mathrm{i}})(q_{\\mathrm{f}} + q_{\\mathrm{i}}) = \\frac{k_{\\mathrm{e}} \\xi}{2 \\varepsilon_{r} L} \\Delta q (2q_{\\mathrm{i}} + \\Delta q)\n$$\nThis expression depends on the initial charge $q_{\\mathrm{i}}$. For the problem to have a unique solution, a specific reaction must be assumed. The most common protonation/deprotonation events involve a neutral species, i.e., either $q_{\\mathrm{i}}=0$ or $q_{\\mathrm{f}}=0$.\nCase 1: Protonation of a neutral species. $q_{\\mathrm{i}}=0$, $q_{\\mathrm{f}}=+1\\,e$. $\\Delta q = +1\\,e$.\n$$\n\\Delta G_{\\mathrm{fs}} = \\frac{k_{\\mathrm{e}} \\xi}{2 \\varepsilon_{r} L} ((+1)^2 - 0^2) = \\frac{k_{\\mathrm{e}} \\xi}{2 \\varepsilon_{r} L}\n$$\nCase 2: Deprotonation to a neutral species. $q_{\\mathrm{i}}=-1\\,e$, $q_{\\mathrm{f}}=0$. $\\Delta q = +1\\,e$.\n$$\n\\Delta G_{\\mathrm{fs}} = \\frac{k_{\\mathrm{e}} \\xi}{2 \\varepsilon_{r} L} (0^2 - (-1)^2) = -\\frac{k_{\\mathrm{e}} \\xi}{2 \\varepsilon_{r} L}\n$$\nIn both fundamental cases consistent with $\\Delta q = +1\\,e$, the magnitude of the free energy correction is identical. We thus proceed with this magnitude.\n$$\n\\lvert \\Delta G_{\\mathrm{fs}} \\rvert = \\frac{k_{\\mathrm{e}} \\xi}{2 \\varepsilon_{r} L} (\\Delta q)^2\n$$\nSubstituting the given values, where $\\Delta q = 1$ in units of $e$:\n$k_{\\mathrm{e}} = 138.935456\\,\\mathrm{kJ\\,mol^{-1}\\,nm\\,e^{-2}}$, $\\xi = 2.837297$, $\\varepsilon_{r} = 78.5$, $L = 6\\,\\mathrm{nm}$.\n$$\n\\lvert \\Delta G_{\\mathrm{fs}} \\rvert = \\frac{(138.935456\\,\\mathrm{kJ\\,mol^{-1}\\,nm\\,e^{-2}}) \\times (2.837297)}{2 \\times 78.5 \\times (6\\,\\mathrm{nm})} \\times (1\\,e)^2\n$$\n$$\n\\lvert \\Delta G_{\\mathrm{fs}} \\rvert = \\frac{394.2150...}{942} \\,\\mathrm{kJ\\,mol^{-1}} \\approx 0.418487\\,\\mathrm{kJ\\,mol^{-1}}\n$$\nRounding to two significant figures, we get $\\lvert \\Delta G_{\\mathrm{fs}} \\rvert = 0.42\\,\\mathrm{kJ\\,mol^{-1}}$.\n\n**Part 2: Shift in Acid Dissociation Constant $\\lvert \\Delta \\mathrm{p}K_{\\mathrm{a}} \\rvert$**\n\nThe relationship between the standard free energy of reaction $\\Delta G$ and the equilibrium constant $K$ is given by $\\Delta G = -RT \\ln K$. The $\\mathrm{p}K_{\\mathrm{a}}$ is defined as $\\mathrm{p}K_{\\mathrm{a}} = -\\log_{10} K_{\\mathrm{a}}$.\nWe can relate these two expressions using the change of logarithm base: $\\ln K = (\\ln 10)(\\log_{10} K)$.\n$$\n\\Delta G = -RT (\\ln 10)(\\log_{10} K) = RT (\\ln 10)(-\\log_{10} K) = RT (\\ln 10) \\mathrm{p}K\n$$\nTherefore, the $\\mathrm{p}K_{\\mathrm{a}}$ can be calculated from the free energy as:\n$$\n\\mathrm{p}K_{\\mathrm{a}} = \\frac{\\Delta G}{RT \\ln 10}\n$$\nThe finite-size artifact $\\Delta G_{\\mathrm{fs}}$ represents an error in the computed free energy, $\\Delta G_{\\mathrm{computed}} = \\Delta G_{\\mathrm{true}} + \\Delta G_{\\mathrm{fs}}$. This error propagates directly to the computed $\\mathrm{p}K_{\\mathrm{a}}$:\n$$\n\\mathrm{p}K_{\\mathrm{a, computed}} = \\frac{\\Delta G_{\\mathrm{true}} + \\Delta G_{\\mathrm{fs}}}{RT \\ln 10} = \\mathrm{p}K_{\\mathrm{a, true}} + \\frac{\\Delta G_{\\mathrm{fs}}}{RT \\ln 10}\n$$\nThe shift in the $\\mathrm{p}K_{\\mathrm{a}}$, denoted as $\\Delta \\mathrm{p}K_{\\mathrm{a}}$, is the error term:\n$$\n\\Delta \\mathrm{p}K_{\\mathrm{a}} = \\frac{\\Delta G_{\\mathrm{fs}}}{RT \\ln 10}\n$$\nWe need to compute the magnitude of this shift, $\\lvert \\Delta \\mathrm{p}K_{\\mathrm{a}} \\rvert$:\n$$\n\\lvert \\Delta \\mathrm{p}K_{\\mathrm{a}} \\rvert = \\frac{\\lvert \\Delta G_{\\mathrm{fs}} \\rvert}{RT \\ln 10}\n$$\nFirst, let's calculate the denominator $RT \\ln 10$. It is crucial to use consistent units. Since $\\lvert \\Delta G_{\\mathrm{fs}} \\rvert$ was calculated in $\\mathrm{kJ\\,mol^{-1}}$, we must convert it to $\\mathrm{J\\,mol^{-1}}$ to match the units of $R$.\n$\\lvert \\Delta G_{\\mathrm{fs}} \\rvert = 0.418487\\,\\mathrm{kJ\\,mol^{-1}} = 418.487\\,\\mathrm{J\\,mol^{-1}}$.\nThe given constants are $R = 8.314462618\\,\\mathrm{J\\,mol^{-1}\\,K^{-1}}$, $T = 298\\,\\mathrm{K}$, and $\\ln 10 = 2.302585093$.\n$$\nRT \\ln 10 = (8.314462618\\,\\mathrm{J\\,mol^{-1}\\,K^{-1}}) \\times (298\\,\\mathrm{K}) \\times (2.302585093)\n$$\n$$\nRT \\ln 10 = 5708.836...\\,\\mathrm{J\\,mol^{-1}}\n$$\nNow we can compute the magnitude of the shift:\n$$\n\\lvert \\Delta \\mathrm{p}K_{\\mathrm{a}} \\rvert = \\frac{418.487... \\,\\mathrm{J\\,mol^{-1}}}{5708.836... \\,\\mathrm{J\\,mol^{-1}}} \\approx 0.073305\n$$\nRounding to two significant figures, we get $\\lvert \\Delta \\mathrm{p}K_{\\mathrm{a}} \\rvert = 0.073$.\n\nThe final results are the magnitude of the free energy correction, $0.42\\,\\mathrm{kJ\\,mol^{-1}}$, and the magnitude of the p$K_{\\mathrm{a}}$ shift, $0.073$.", "answer": "$$\n\\boxed{\\begin{pmatrix} 0.42 & 0.073 \\end{pmatrix}}\n$$", "id": "3404560"}, {"introduction": "A successful suite of constant pH simulations yields raw data in the form of protonation counts at various pH values. The final, crucial step is to transform this data into a physically meaningful result, such as a $\\mathrm{p}K_{\\mathrm{a}}$, complete with a robust estimate of its uncertainty. This coding exercise [@problem_id:3404590] provides hands-on practice in this critical data analysis stage. You will implement a workflow to determine the $\\mathrm{p}K_{\\mathrm{a}}$ using Maximum Likelihood Estimation, construct confidence intervals, and apply statistical tests to diagnose potential problems like overdispersion, which can hint at complex underlying dynamics not captured by a simple titration model.", "problem": "You are given independent titration observations from constant pH molecular dynamics in the form of counts of protonated versus deprotonated states at several solution acidity values. Assume a single titratable site that follows acid-base equilibrium consistent with the Henderson–Hasselbalch isotherm. Model each observation at acidity value $pH_i$ as $y_i$ protonated counts out of $N_i$ trials, with $y_i$ distributed as a binomial random variable with success probability $p_i$. For an acid-type site, the protonated fraction is given by the equilibrium occupancy\n$$\np_i = \\frac{1}{1 + 10^{\\,pH_i - pK_a}},\n$$\nwhere $pK_a$ is the acid dissociation constant on the logarithmic scale. Assume observations at different $pH_i$ are independent given $pK_a$.\n\nTasks:\n1. Using the binomial likelihood and the independence assumption, determine the maximum likelihood estimate (MLE) $\\widehat{pK_a}$ by maximizing the log-likelihood with respect to $pK_a$ based on the provided data.\n2. Construct a two-sided $95\\%$ confidence interval for $pK_a$ via a profile likelihood method. Specifically, define the negative log-likelihood $-\\ell(pK_a)$ up to an additive constant and find the set of $pK_a$ values that satisfy\n$$\n2\\left(\\ell(\\widehat{pK_a}) - \\ell(pK_a)\\right) \\le \\chi^2_{1, 0.95},\n$$\nwhere $\\chi^2_{1, 0.95}$ is the $0.95$ quantile of the chi-square distribution with $1$ degree of freedom. If the interval extends beyond physically plausible acidity constants, truncate to the range $[0, 14]$.\n3. Assess overdispersion by computing the Pearson dispersion statistic\n$$\n\\phi = \\frac{1}{K - 1} \\sum_{i=1}^{K} \\frac{\\left(y_i - N_i \\widehat{p}_i\\right)^2}{N_i \\widehat{p}_i \\left(1 - \\widehat{p}_i\\right)},\n$$\nwhere $K$ is the number of acidity points, and $\\widehat{p}_i$ is the fitted protonated probability at $pH_i$ using $\\widehat{pK_a}$. Under the binomial model, the Pearson chi-square statistic\n$$\nX^2 = \\sum_{i=1}^{K} \\frac{\\left(y_i - N_i \\widehat{p}_i\\right)^2}{N_i \\widehat{p}_i \\left(1 - \\widehat{p}_i\\right)}\n$$\nis approximately $\\chi^2$ distributed with $K - 1$ degrees of freedom. Use this to compute a $p$-value. Declare the data overdispersed if $\\phi > 1$ and the $p$-value is below a significance level $\\alpha = 0.01$. Interpret overdispersion as suggestive of time-correlation or hidden substates beyond the single-site model.\n\nYour program must implement this estimation and diagnostic for the following test suite of cases. Each case provides $pH$ values, total counts $N_i$, and protonated counts $y_i$:\n\n- Case A (well-behaved binomial sampling, moderate sizes):\n  - $pH$: $[4.0, 5.5, 6.0, 6.5, 7.0, 8.0, 9.0]$\n  - $N$: $[500, 500, 500, 500, 500, 500, 500]$\n  - $y$: $[498, 455, 374, 250, 125, 12, 1]$\n\n- Case B (apparent overdispersion at most $pH$ values):\n  - $pH$: $[4.0, 5.5, 6.0, 6.5, 7.0, 8.0, 9.0]$\n  - $N$: $[500, 500, 500, 500, 500, 500, 500]$\n  - $y$: $[485, 420, 340, 280, 160, 30, 6]$\n\n- Case C (edge-heavy sampling with small sizes):\n  - $pH$: $[3.0, 4.0, 6.0, 9.0, 10.0]$\n  - $N$: $[50, 50, 50, 50, 50]$\n  - $y$: $[50, 49, 25, 2, 0]$\n\n- Case D (hidden-state-like shape suggestive of mixtures):\n  - $pH$: $[5.0, 5.5, 6.0, 6.5, 7.0, 7.5, 8.0]$\n  - $N$: $[400, 400, 400, 400, 400, 400, 400]$\n  - $y$: $[372, 352, 300, 170, 140, 70, 45]$\n\nRequirements:\n- For each case, compute and report a list of four items: $\\widehat{pK_a}$, the lower confidence limit, the upper confidence limit, and a boolean overdispersion flag. Round all three $pK_a$-related numbers to $3$ decimals. The boolean must be reported as a language-native boolean.\n- The final output must be a single line containing a list of results, one per case, where each case’s result is itself a list in the order described above. The line must be formatted as a comma-separated list enclosed in square brackets with no spaces, for example: $[[x_1,y_1,z_1,b_1],[x_2,y_2,z_2,b_2],\\dots]$.\n- All acidity values and $pK_a$ values are dimensionless, so no units are required. Use the physical plausibility range $[0, 14]$ for $pK_a$ throughout the computation.", "solution": "We model each observation as follows. For each acidity point $pH_i$, the protonation state indicator $X_{ij}$ for trial $j$ is a Bernoulli random variable with success probability $p_i$, independent across $j$ and $i$ given $pK_a$. The binomial count at that point is $Y_i = \\sum_{j=1}^{N_i} X_{ij}$, so $Y_i \\sim \\mathrm{Binomial}(N_i, p_i)$. For an acid-type site at equilibrium, the protonated fraction is\n$$\np_i = \\frac{1}{1 + 10^{\\,pH_i - pK_a}},\n$$\nwhich follows from the law of mass action and the definition of the Henderson–Hasselbalch relation. The independence assumption implies the joint likelihood across $K$ acidity values is\n$$\nL(pK_a) = \\prod_{i=1}^{K} \\binom{N_i}{y_i} p_i^{y_i} (1 - p_i)^{N_i - y_i}.\n$$\nThe corresponding log-likelihood is\n$$\n\\ell(pK_a) = \\sum_{i=1}^{K} \\left[ \\log \\binom{N_i}{y_i} + y_i \\log p_i + (N_i - y_i) \\log(1 - p_i) \\right].\n$$\nThe combinatorial terms do not depend on $pK_a$, so maximizing $\\ell(pK_a)$ is equivalent to minimizing the negative log-likelihood without those constants:\n$$\n-\\tilde{\\ell}(pK_a) = -\\sum_{i=1}^{K} \\left[ y_i \\log p_i + (N_i - y_i) \\log(1 - p_i) \\right].\n$$\nWe compute the maximum likelihood estimate $\\widehat{pK_a}$ by minimizing $-\\tilde{\\ell}(pK_a)$ over the physically plausible range $[0, 14]$. Numerically, we evaluate $p_i$ from $pK_a$ using $p_i = 1/(1 + 10^{\\,pH_i - pK_a})$, clip $p_i$ to $[10^{-12}, 1 - 10^{-12}]$ to avoid logarithm of zero, and use a bounded one-dimensional optimizer.\n\nFor the confidence interval, we invoke the asymptotic profile likelihood result: under regularity conditions, the likelihood ratio statistic\n$$\n\\Lambda(pK_a) = 2\\left(\\ell(\\widehat{pK_a}) - \\ell(pK_a)\\right)\n$$\nconverges in distribution to a chi-square distribution with $1$ degree of freedom. Thus the $95\\%$ profile likelihood confidence set is all $pK_a$ such that\n$$\n\\Lambda(pK_a) \\le \\chi^2_{1, 0.95}.\n$$\nIn terms of negative log-likelihood, this is equivalent to\n$$\n-\\tilde{\\ell}(pK_a) \\le -\\tilde{\\ell}(\\widehat{pK_a}) + \\frac{1}{2} \\chi^2_{1,0.95}.\n$$\nWe compute the threshold $-\\tilde{\\ell}(\\widehat{pK_a}) + \\frac{1}{2} \\chi^2_{1,0.95}$ and then numerically find the left and right intersection points of $-\\tilde{\\ell}(pK_a)$ with this level. We first scan a grid over $[0, 14]$ to bracket the crossings and then use a root finder locally to refine each bound. If a crossing is not found on one side within $[0, 14]$, we truncate that bound to $0$ or $14$ accordingly.\n\nTo assess overdispersion, we use the Pearson chi-square statistic at the MLE:\n$$\nX^2 = \\sum_{i=1}^{K} \\frac{\\left(y_i - N_i \\widehat{p}_i\\right)^2}{N_i \\widehat{p}_i \\left(1 - \\widehat{p}_i\\right)},\n$$\nwhere $\\widehat{p}_i = \\frac{1}{1 + 10^{\\,pH_i - \\widehat{pK_a}}}$. Under the binomial model with one fitted parameter $pK_a$, $X^2$ is approximately chi-square distributed with $K - 1$ degrees of freedom. The dispersion estimate is\n$$\n\\phi = \\frac{X^2}{K - 1}.\n$$\nWe compute the $p$-value from the chi-square survival function, and then declare overdispersion if $\\phi > 1$ and the $p$-value is below $\\alpha = 0.01$. Such overdispersion can arise from time-correlation in the samples or hidden substates that violate the single-site, independently sampled binomial assumptions, which are precisely the phenomena of interest in constant pH molecular dynamics when dynamics are slow or multiple microstates contribute.\n\nAlgorithmic steps implemented in the program for each case:\n1. Parse arrays $\\{pH_i\\}_{i=1}^{K}$, $\\{N_i\\}_{i=1}^{K}$, $\\{y_i\\}_{i=1}^{K}$.\n2. Compute $\\widehat{pK_a}$ by minimizing $-\\tilde{\\ell}(pK_a)$ over $[0, 14]$ with a bounded optimizer.\n3. Compute the profile likelihood threshold using $\\chi^2_{1, 0.95}$, bracket crossings on a grid, and refine with a root finder to obtain the lower and upper bounds; truncate to $[0, 14]$ as needed.\n4. Compute $\\phi$ and the chi-square $p$-value with $K - 1$ degrees of freedom; set the overdispersion flag using $\\alpha = 0.01$.\n5. Round $\\widehat{pK_a}$ and both bounds to $3$ decimals and return a list $[\\widehat{pK_a}, \\mathrm{lower}, \\mathrm{upper}, \\mathrm{flag}]$.\n\nThe program aggregates the four case results into a single list and prints it on one line in the specified format with no spaces.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import optimize, stats\n\ndef occupancy_fraction(pH, pKa):\n    # Acid-site protonated fraction under Henderson–Hasselbalch\n    return 1.0 / (1.0 + np.power(10.0, pH - pKa))\n\ndef neg_log_likelihood(pKa, pH, N, y):\n    p = occupancy_fraction(pH, pKa)\n    # Numerical stability clipping\n    p = np.clip(p, 1e-12, 1.0 - 1e-12)\n    # Binomial log-likelihood up to additive constants\n    ll = y * np.log(p) + (N - y) * np.log(1.0 - p)\n    return -np.sum(ll)\n\ndef mle_pKa(pH, N, y):\n    res = optimize.minimize_scalar(\n        neg_log_likelihood,\n        bounds=(0.0, 14.0),\n        args=(pH, N, y),\n        method=\"bounded\",\n        options={\"xatol\": 1e-9, \"maxiter\": 500}\n    )\n    return res.x, res.fun\n\ndef profile_ci(pH, N, y, pKa_hat, nll_min, alpha=0.05):\n    # Compute threshold for NLL increase using likelihood ratio\n    chi2crit = stats.chi2.ppf(1.0 - alpha, df=1)\n    target = nll_min + 0.5 * chi2crit\n\n    def g(x):\n        return neg_log_likelihood(x, pH, N, y) - target\n\n    # Grid to bracket crossings\n    grid = np.linspace(0.0, 14.0, 7001)\n    nll_vals = np.array([neg_log_likelihood(x, pH, N, y) for x in grid])\n    g_vals = nll_vals - target\n    i_min = int(np.argmin(nll_vals))\n\n    # Find left crossing index (g crosses from >0 to <=0 when moving right)\n    left_idx = None\n    for i in range(i_min, 0, -1):\n        if g_vals[i] <= 0 and g_vals[i - 1] > 0:\n            left_idx = i - 1\n            break\n    # Find right crossing index (g crosses from <=0 to >0 when moving right)\n    right_idx = None\n    for i in range(i_min, len(grid) - 1):\n        if g_vals[i] <= 0 and g_vals[i + 1] > 0:\n            right_idx = i\n            break\n\n    # Refine with brentq where possible; else truncate to bounds\n    # Left bound\n    if left_idx is not None:\n        a = grid[left_idx]\n        b = grid[left_idx + 1]\n        fa = g_vals[left_idx]\n        fb = g_vals[left_idx + 1]\n        if fa == 0.0:\n            left_bound = a\n        elif fb == 0.0:\n            left_bound = b\n        elif fa * fb < 0:\n            left_bound = optimize.brentq(lambda x: g(x), a, b, maxiter=100, xtol=1e-10)\n        else:\n            left_bound = a  # fallback to bracket edge\n    else:\n        left_bound = 0.0\n\n    # Right bound\n    if right_idx is not None:\n        a = grid[right_idx]\n        b = grid[right_idx + 1]\n        fa = g_vals[right_idx]\n        fb = g_vals[right_idx + 1]\n        if fa == 0.0:\n            right_bound = a\n        elif fb == 0.0:\n            right_bound = b\n        elif fa * fb < 0:\n            right_bound = optimize.brentq(lambda x: g(x), a, b, maxiter=100, xtol=1e-10)\n        else:\n            right_bound = b  # fallback to bracket edge\n    else:\n        right_bound = 14.0\n\n    # Ensure within [0,14]\n    left_bound = max(0.0, min(14.0, left_bound))\n    right_bound = max(0.0, min(14.0, right_bound))\n\n    # Order check\n    if right_bound < left_bound:\n        left_bound, right_bound = right_bound, left_bound\n\n    return left_bound, right_bound\n\ndef pearson_overdispersion(pH, N, y, pKa_hat):\n    p = occupancy_fraction(pH, pKa_hat)\n    # Avoid division by zero in variance terms\n    p = np.clip(p, 1e-12, 1.0 - 1e-12)\n    var = N * p * (1.0 - p)\n    resid = y - N * p\n    chi2 = np.sum((resid ** 2) / var)\n    df = len(pH) - 1  # one fitted parameter\n    phi = chi2 / df\n    p_value = stats.chi2.sf(chi2, df)\n    return phi, p_value\n\ndef round_float(x, digits=3):\n    return float(f\"{x:.{digits}f}\")\n\ndef format_nested_list_no_spaces(nested):\n    # Formats nested list of simple types into a no-space string like JSON arrays\n    def format_value(v):\n        if isinstance(v, bool):\n            # Use capitalized boolean to match Python's default\n            return \"True\" if v else \"False\"\n        elif isinstance(v, float):\n            # Already rounded floats should be passed; ensure standard formatting\n            s = f\"{v:.3f}\"\n            # Remove trailing zeros and dot? Problem requires 3 decimals explicitly, so keep them\n            return s\n        elif isinstance(v, int):\n            return str(v)\n        elif isinstance(v, list):\n            return \"[\" + \",\".join(format_value(vi) for vi in v) + \"]\"\n        else:\n            # Fallback: convert to string directly\n            return str(v)\n    return \"[\" + \",\".join(format_value(item) for item in nested) + \"]\"\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each case is a tuple: (pH array, N array, y array)\n    test_cases = [\n        # Case A\n        (np.array([4.0, 5.5, 6.0, 6.5, 7.0, 8.0, 9.0]),\n         np.array([500, 500, 500, 500, 500, 500, 500], dtype=float),\n         np.array([498, 455, 374, 250, 125, 12, 1], dtype=float)),\n        # Case B\n        (np.array([4.0, 5.5, 6.0, 6.5, 7.0, 8.0, 9.0]),\n         np.array([500, 500, 500, 500, 500, 500, 500], dtype=float),\n         np.array([485, 420, 340, 280, 160, 30, 6], dtype=float)),\n        # Case C\n        (np.array([3.0, 4.0, 6.0, 9.0, 10.0]),\n         np.array([50, 50, 50, 50, 50], dtype=float),\n         np.array([50, 49, 25, 2, 0], dtype=float)),\n        # Case D\n        (np.array([5.0, 5.5, 6.0, 6.5, 7.0, 7.5, 8.0]),\n         np.array([400, 400, 400, 400, 400, 400, 400], dtype=float),\n         np.array([372, 352, 300, 170, 140, 70, 45], dtype=float)),\n    ]\n\n    alpha_overdispersion = 0.01  # significance level for overdispersion decision\n    results = []\n    for pH, N, y in test_cases:\n        # MLE\n        pKa_hat, nll_min = mle_pKa(pH, N, y)\n        # Profile likelihood 95% CI\n        ci_low, ci_high = profile_ci(pH, N, y, pKa_hat, nll_min, alpha=0.05)\n        # Overdispersion\n        phi, p_value = pearson_overdispersion(pH, N, y, pKa_hat)\n        overdispersed = (phi > 1.0) and (p_value < alpha_overdispersion)\n\n        # Round outputs\n        pKa_hat_r = round_float(pKa_hat, 3)\n        ci_low_r = round_float(ci_low, 3)\n        ci_high_r = round_float(ci_high, 3)\n\n        results.append([pKa_hat_r, ci_low_r, ci_high_r, overdispersed])\n\n    # Final print statement in the exact required format (no spaces).\n    print(format_nested_list_no_spaces(results))\n\nif __name__ == \"__main__\":\n    solve()\n```", "id": "3404590"}]}