{"hands_on_practices": [{"introduction": "In computational practice, intermolecular potentials are often truncated at a cutoff distance $r_c$ to save computational cost. This practical shortcut, however, introduces a systematic error. This exercise guides you through the process of correcting for this error by deriving the analytical 'tail correction' for the excess chemical potential, a fundamental skill for any practitioner performing molecular simulations. By working through this problem [@problem_id:3461858], you will connect the formal Widom insertion formula to the realities of finite-range potentials, using standard statistical mechanical approximations.", "problem": "A one-component fluid of spherical particles interacts via the standard $12$–$6$ Lennard–Jones pair potential $u_{\\mathrm{LJ}}(r) = 4 \\epsilon \\left[ \\left( \\frac{\\sigma}{r} \\right)^{12} - \\left( \\frac{\\sigma}{r} \\right)^{6} \\right]$. In a canonical-ensemble molecular simulation at number density $\\rho$ and temperature $T$, the excess chemical potential $\\mu^{\\mathrm{ex}}$ is estimated using the Widom insertion method, but the pair potential is truncated (not shifted) at a cutoff $r_c$, so that $u_{\\mathrm{trunc}}(r) = u_{\\mathrm{LJ}}(r)$ for $r < r_c$ and $u_{\\mathrm{trunc}}(r) = 0$ for $r \\ge r_c$. To recover the full-potential result, a tail correction must be added to account for the neglected interactions beyond $r_c$.\n\nStarting from the definition of the Widom insertion estimator for the excess chemical potential in the canonical ensemble and using only fundamental statistical-mechanical identities and the definition of the Lennard–Jones potential, derive the analytical expression for the tail correction to the excess chemical potential that must be added to the truncated result under the following assumptions:\n- For separations $r > r_c$, the radial distribution function $g(r)$ is approximated by $g(r) \\approx 1$.\n- The neglected long-range contribution to the Widom Boltzmann factor is treated at leading order by integrating the truncated potential’s contribution over space.\n\nYou must:\n- Begin from first principles for the Widom insertion definition of $\\mu^{\\mathrm{ex}}$ and justify the approximations leading to a mean-field integral over the neglected region $r > r_c$.\n- Evaluate the resulting spatial integral explicitly for the $12$–$6$ Lennard–Jones form.\n- Present your final result as a single closed-form symbolic expression for the reduced tail correction $\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}}/\\epsilon$ in terms of $\\rho$, $\\sigma$, and $r_c$.\n\nExpress the final answer as a single analytic expression. Do not substitute numerical values. Do not include units in your final expression; report the result in reduced form as $\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}}/\\epsilon$.", "solution": "### Derivation from First Principles\n\n**1. The Widom Insertion Method for Excess Chemical Potential**\n\nThe excess chemical potential, $\\mu^{\\mathrm{ex}}$, represents the contribution to the chemical potential arising from interactions between particles. In the canonical ($NVT$) ensemble, it is defined via the Widom test particle insertion method. The fundamental formula is:\n$$\n\\mu^{\\mathrm{ex}} = -k_\\mathrm{B} T \\ln \\left\\langle \\exp(-\\beta \\Delta U) \\right\\rangle_N\n$$\nHere, $k_\\mathrm{B}$ is the Boltzmann constant, $T$ is the absolute temperature, and $\\beta = 1/(k_\\mathrm{B} T)$. The term $\\Delta U$ represents the total potential energy of a \"test\" particle inserted at a random position $\\mathbf{r}_0$ in a system of $N$ particles. This energy is the sum of pairwise interactions between the test particle and the $N$ existing particles:\n$$\n\\Delta U = \\sum_{i=1}^N u(|\\mathbf{r}_i - \\mathbf{r}_0|)\n$$\nThe angled brackets $\\langle \\dots \\rangle_N$ denote an ensemble average over the configurations of the $N$-particle system.\n\n**2. Full vs. Truncated Potentials**\n\nThe problem involves two forms of the potential energy:\n- The full Lennard-Jones potential: $u_{\\mathrm{full}}(r) = u_{\\mathrm{LJ}}(r) = 4 \\epsilon \\left[ \\left( \\frac{\\sigma}{r} \\right)^{12} - \\left( \\frac{\\sigma}{r} \\right)^{6} \\right]$ for all $r$.\n- The truncated potential used in the simulation: $u_{\\mathrm{trunc}}(r) = u_{\\mathrm{LJ}}(r)$ for $r < r_c$ and $u_{\\mathrm{trunc}}(r) = 0$ for $r \\ge r_c$.\n\nThe excess chemical potential measured in the simulation, using the truncated potential for both generating configurations and measuring the test particle energy, is:\n$$\n\\mu^{\\mathrm{ex}}_{\\mathrm{trunc}} = -k_\\mathrm{B} T \\ln \\left\\langle \\exp(-\\beta \\Delta U_{\\mathrm{trunc}}) \\right\\rangle_{\\mathrm{trunc}}\n$$\nwhere $\\Delta U_{\\mathrm{trunc}} = \\sum_{i=1}^N u_{\\mathrm{trunc}}(|\\mathbf{r}_i - \\mathbf{r}_0|)$ and the average is over the ensemble generated with $u_{\\mathrm{trunc}}$.\n\nThe true excess chemical potential corresponding to the full potential is:\n$$\n\\mu^{\\mathrm{ex}}_{\\mathrm{full}} = -k_\\mathrm{B} T \\ln \\left\\langle \\exp(-\\beta \\Delta U_{\\mathrm{full}}) \\right\\rangle_{\\mathrm{full}}\n$$\nwhere $\\Delta U_{\\mathrm{full}} = \\sum_{i=1}^N u_{\\mathrm{full}}(|\\mathbf{r}_i - \\mathbf{r}_0|)$.\n\nThe tail correction, $\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}}$, is defined as the difference that must be added to the simulation result to recover the full-potential result: $\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}} = \\mu^{\\mathrm{ex}}_{\\mathrm{full}} - \\mu^{\\mathrm{ex}}_{\\mathrm{trunc}}$. A standard approximation, implicit in such corrections, is to assume the fluid structure (e.g., the radial distribution function) is well-described by the truncated potential. The correction then involves calculating the energetic contribution of the neglected tail of the potential, averaged over the configurations of the truncated system. Thus, we approximate $\\mu^{\\mathrm{ex}}_{\\mathrm{full}}$ by evaluating $\\langle \\exp(-\\beta \\Delta U_{\\mathrm{full}}) \\rangle$ over the truncated ensemble:\n$$\n\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}} \\approx -k_\\mathrm{B} T \\ln \\left\\langle \\exp(-\\beta \\Delta U_{\\mathrm{full}}) \\right\\rangle_{\\mathrm{trunc}} - (-k_\\mathrm{B} T \\ln \\left\\langle \\exp(-\\beta \\Delta U_{\\mathrm{trunc}}) \\right\\rangle_{\\mathrm{trunc}})\n$$\n$$\n\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}} \\approx -k_\\mathrm{B} T \\ln \\left( \\frac{\\left\\langle \\exp(-\\beta \\Delta U_{\\mathrm{full}}) \\right\\rangle_{\\mathrm{trunc}}}{\\left\\langle \\exp(-\\beta \\Delta U_{\\mathrm{trunc}}) \\right\\rangle_{\\mathrm{trunc}}} \\right) = -k_\\mathrm{B} T \\ln \\left\\langle \\exp(-\\beta[\\Delta U_{\\mathrm{full}} - \\Delta U_{\\mathrm{trunc}}]) \\right\\rangle_{\\mathrm{trunc}}\n$$\nLet $\\Delta U_{\\mathrm{tail}} = \\Delta U_{\\mathrm{full}} - \\Delta U_{\\mathrm{trunc}}$. This is the interaction energy of the test particle with all other particles beyond the cutoff $r_c$.\n\n**3. The Leading-Order (Mean-Field) Approximation**\n\nThe problem states that the correction should be treated at leading order. The potential $u_{\\mathrm{LJ}}(r)$ decays rapidly with distance, so its value for $r > r_c$ is small. Consequently, the test particle energy contribution from the tail, $\\Delta U_{\\mathrm{tail}}$, is also small, meaning $\\beta \\Delta U_{\\mathrm{tail}} \\ll 1$. This justifies a first-order expansion. Using the approximations $\\exp(-x) \\approx 1-x$ for small $x$ and $\\ln(1-y) \\approx -y$ for small $y$:\n$$\n\\left\\langle \\exp(-\\beta \\Delta U_{\\mathrm{tail}}) \\right\\rangle \\approx \\left\\langle 1 - \\beta \\Delta U_{\\mathrm{tail}} \\right\\rangle = 1 - \\beta \\left\\langle \\Delta U_{\\mathrm{tail}} \\right\\rangle\n$$\n$$\n\\ln \\left\\langle \\exp(-\\beta \\Delta U_{\\mathrm{tail}}) \\right\\rangle \\approx \\ln(1 - \\beta \\left\\langle \\Delta U_{\\mathrm{tail}} \\right\\rangle) \\approx -\\beta \\left\\langle \\Delta U_{\\mathrm{tail}} \\right\\rangle\n$$\nSubstituting this into the expression for the tail correction:\n$$\n\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}} \\approx -k_\\mathrm{B} T (-\\beta \\left\\langle \\Delta U_{\\mathrm{tail}} \\right\\rangle) = \\left\\langle \\Delta U_{\\mathrm{tail}} \\right\\rangle\n$$\nThis shows that the leading-order tail correction to the excess chemical potential is simply the average potential energy of a test particle due to interactions with particles beyond the cutoff $r_c$.\n\n**4. The Mean-Field Integral**\n\nWe now express $\\langle \\Delta U_{\\mathrm{tail}} \\rangle$ as an integral. The average number of particles in a spherical shell of volume $dV = 4\\pi r^2 dr$ at a distance $r$ from the test particle is given by $\\rho g(r) dV$, where $\\rho$ is the number density and $g(r)$ is the radial distribution function. The average interaction energy is obtained by integrating the pair potential multiplied by this particle density over the relevant volume:\n$$\n\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}} \\approx \\left\\langle \\Delta U_{\\mathrm{tail}} \\right\\rangle = \\int_{r_c}^{\\infty} u_{\\mathrm{LJ}}(r) \\rho g(r) (4\\pi r^2 dr)\n$$\nThe problem states to use the approximation that for separations beyond the cutoff, the fluid is unstructured, i.e., $g(r) \\approx 1$ for $r \\ge r_c$. The integral simplifies to:\n$$\n\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}} = 4\\pi\\rho \\int_{r_c}^{\\infty} u_{\\mathrm{LJ}}(r) r^2 dr\n$$\n\n**5. Evaluating the Integral for the Lennard-Jones Potential**\n\nWe now substitute the Lennard-Jones potential into the integral:\n$$\n\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}} = 4\\pi\\rho \\int_{r_c}^{\\infty} 4\\epsilon \\left[ \\left( \\frac{\\sigma}{r} \\right)^{12} - \\left( \\frac{\\sigma}{r} \\right)^{6} \\right] r^2 dr\n$$\nThe problem asks for the reduced correction $\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}}/\\epsilon$:\n$$\n\\frac{\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}}}{\\epsilon} = 16\\pi\\rho \\int_{r_c}^{\\infty} \\left[ \\sigma^{12}r^{-12} - \\sigma^6 r^{-6} \\right] r^2 dr\n$$\n$$\n\\frac{\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}}}{\\epsilon} = 16\\pi\\rho \\int_{r_c}^{\\infty} \\left( \\sigma^{12}r^{-10} - \\sigma^6 r^{-4} \\right) dr\n$$\nPerforming the definite integration:\n$$\n\\int_{r_c}^{\\infty} \\left( \\sigma^{12}r^{-10} - \\sigma^6 r^{-4} \\right) dr = \\left[ \\frac{\\sigma^{12}r^{-9}}{-9} - \\frac{\\sigma^6 r^{-3}}{-3} \\right]_{r_c}^{\\infty}\n$$\n$$\n= \\left[ -\\frac{\\sigma^{12}}{9r^9} + \\frac{\\sigma^6}{3r^3} \\right]_{r_c}^{\\infty}\n$$\nEvaluating at the limits of integration ($r \\to \\infty$ and $r = r_c$):\n$$\n= \\left( \\lim_{r\\to\\infty} \\left( -\\frac{\\sigma^{12}}{9r^9} + \\frac{\\sigma^6}{3r^3} \\right) \\right) - \\left( -\\frac{\\sigma^{12}}{9r_c^9} + \\frac{\\sigma^6}{3r_c^3} \\right)\n$$\n$$\n= (0 + 0) - \\left( -\\frac{\\sigma^{12}}{9r_c^9} + \\frac{\\sigma^6}{3r_c^3} \\right) = \\frac{\\sigma^{12}}{9r_c^9} - \\frac{\\sigma^6}{3r_c^3}\n$$\nSubstituting this result back into our expression for the reduced correction:\n$$\n\\frac{\\Delta \\mu^{\\mathrm{ex}}_{\\mathrm{tail}}}{\\epsilon} = 16\\pi\\rho \\left( \\frac{\\sigma^{12}}{9r_c^9} - \\frac{\\sigma^6}{3r_c^3} \\right)\n$$\nThis is the final closed-form symbolic expression for the reduced tail correction as a function of $\\rho$, $\\sigma$, and $r_c$.", "answer": "$$\n\\boxed{16\\pi\\rho \\left( \\frac{\\sigma^{12}}{9r_c^9} - \\frac{\\sigma^6}{3r_c^3} \\right)}\n$$", "id": "3461858"}, {"introduction": "A calculated value is only as good as its statistical uncertainty. The Widom insertion method is notoriously susceptible to poor convergence, where a few rare, low-energy insertions dominate the average, leading to unreliable results. This practice [@problem_id:3461886] introduces a critical diagnostic tool: the effective sample size, $N_{\\mathrm{eff}}$. By working through its derivation and application, you will learn how to quantify the statistical quality of your Widom calculation and establish a robust criterion for trusting the resulting chemical potential.", "problem": "A molecular dynamics practitioner seeks to estimate the excess chemical potential of a tracer using the Widom test-particle insertion method. Consider a system at temperature $T$, with inverse thermal energy $\\beta = 1/(k_{\\mathrm{B}} T)$, where $k_{\\mathrm{B}}$ is the Boltzmann constant. From $N$ equilibrium configurations sampled from the unperturbed system, the practitioner computes insertion energy changes $\\Delta U_i$ and associated Boltzmann weights $w_i = \\exp(-\\beta \\Delta U_i)$ for $i=1,\\dots,N$. The Widom estimator for the excess chemical potential is defined by the well-tested formula of statistical mechanics,\n$$\n\\hat{\\mu}_{\\mathrm{ex}} = -k_{\\mathrm{B}} T \\ln\\left(\\frac{1}{N}\\sum_{i=1}^N w_i\\right).\n$$\nBecause the weights $w_i$ are typically heavy-tailed in dense or strongly interacting systems, only a small subset of configurations may contribute appreciably to the average, leading to loss of precision and bias in $\\hat{\\mu}_{\\mathrm{ex}}$. One way to quantify this is to define an effective sample size based on the weight concentration, and to identify a threshold below which the Widom result should be considered unreliable for a target precision. Using only general statistical principles (independence of samples, the central limit theorem for sample means, and smooth-function error propagation), and the definitions above, determine which option correctly specifies:\n- a consistent definition of the effective sample size $N_{\\mathrm{eff}}$ from the set $\\{w_i\\}_{i=1}^N$; and\n- a scientifically justified rule-of-thumb threshold for deeming the Widom estimate unreliable if the target standard error in $\\hat{\\mu}_{\\mathrm{ex}}$ is tighter than $0.1\\,k_{\\mathrm{B}} T$.\n\nChoose the single best option.\n\nA. $N_{\\mathrm{eff}} = \\dfrac{\\left(\\sum_{i=1}^N w_i\\right)^2}{\\sum_{i=1}^N w_i^2}$, and the Widom estimate should be deemed unreliable if $N_{\\mathrm{eff}} < 100$ when targeting a standard error $\\lesssim 0.1\\,k_{\\mathrm{B}} T$.\n\nB. $N_{\\mathrm{eff}} = \\dfrac{\\sum_{i=1}^N w_i^2}{\\left(\\sum_{i=1}^N w_i\\right)^2}$, and the Widom estimate should be deemed unreliable if $N_{\\mathrm{eff}}/N < 0.5$.\n\nC. $N_{\\mathrm{eff}} = \\dfrac{\\left(\\sum_{i=1}^N w_i\\right)^2}{\\sum_{i=1}^N w_i^2}$, and the Widom estimate should be deemed unreliable only if $N_{\\mathrm{eff}} < 5$, because the law of large numbers guarantees convergence otherwise.\n\nD. $N_{\\mathrm{eff}} = N$, and the Widom estimate should be deemed unreliable if the “acceptance fraction” of trial insertions is below $10\\%$, since only actual insertions contribute to the average.", "solution": "The excess chemical potential is given by the exact relation $\\mu_{\\mathrm{ex}} = -k_{\\mathrm{B}} T \\ln \\langle w \\rangle$, where $w = \\exp(-\\beta \\Delta U)$. The practitioner uses a numerical estimator based on a finite sample of size $N$:\n$$\n\\hat{\\mu}_{\\mathrm{ex}} = -k_{\\mathrm{B}} T \\ln(\\bar{w})\n$$\nwhere $\\bar{w} = \\frac{1}{N}\\sum_{i=1}^N w_i$ is the sample mean of the Boltzmann weights.\n\nTo find the standard error of this estimator, $\\sigma_{\\hat{\\mu}_{\\mathrm{ex}}}$, we use the formula for propagation of uncertainty. For a function $f(x)$, the variance is $\\sigma_{f}^2 \\approx \\left(\\frac{df}{dx}\\right)^2 \\sigma_x^2$. Here, $f(\\bar{w}) = \\hat{\\mu}_{\\mathrm{ex}}$. The derivative is:\n$$\n\\frac{d\\hat{\\mu}_{\\mathrm{ex}}}{d\\bar{w}} = -k_{\\mathrm{B}} T \\frac{1}{\\bar{w}}\n$$\nThe variance of the sample mean, $\\sigma_{\\bar{w}}^2$, for $N$ independent samples is given by the Central Limit Theorem:\n$$\n\\sigma_{\\bar{w}}^2 = \\frac{\\sigma_w^2}{N} = \\frac{\\langle w^2 \\rangle - \\langle w \\rangle^2}{N}\n$$\nwhere $\\sigma_w^2$ is the variance of the underlying distribution of $w$. Combining these and evaluating the derivative at the true mean $\\langle w \\rangle$, we get the variance of the chemical potential estimator:\n$$\n\\sigma_{\\hat{\\mu}_{\\mathrm{ex}}}^2 \\approx \\left(-k_{\\mathrm{B}} T \\frac{1}{\\langle w \\rangle}\\right)^2 \\left(\\frac{\\langle w^2 \\rangle - \\langle w \\rangle^2}{N}\\right) = (k_{\\mathrm{B}} T)^2 \\frac{1}{N} \\left(\\frac{\\langle w^2 \\rangle}{\\langle w \\rangle^2} - 1\\right)\n$$\nIn systems where the distribution of $w$ is heavy-tailed, $\\langle w^2 \\rangle \\gg \\langle w \\rangle^2$, so we can approximate this as:\n$$\n\\sigma_{\\hat{\\mu}_{\\mathrm{ex}}}^2 \\approx (k_{\\mathrm{B}} T)^2 \\frac{1}{N} \\frac{\\langle w^2 \\rangle}{\\langle w \\rangle^2}\n$$\nThe standard definition of the effective sample size for a set of importance weights $\\{w_i\\}$ is:\n$$\nN_{\\mathrm{eff}} = \\frac{\\left(\\sum_{i=1}^N w_i\\right)^2}{\\sum_{i=1}^N w_i^2} = N \\frac{\\left(\\frac{1}{N}\\sum w_i\\right)^2}{\\frac{1}{N}\\sum w_i^2} \\approx N \\frac{\\langle w \\rangle^2}{\\langle w^2 \\rangle}\n$$\nBy rearranging this definition, we get $\\frac{1}{N_{\\mathrm{eff}}} \\approx \\frac{1}{N} \\frac{\\langle w^2 \\rangle}{\\langle w \\rangle^2}$. Substituting this into our expression for the variance gives a remarkably simple result:\n$$\n\\sigma_{\\hat{\\mu}_{\\mathrm{ex}}}^2 \\approx \\frac{(k_{\\mathrm{B}} T)^2}{N_{\\mathrm{eff}}}\n$$\nThe standard error is therefore $\\sigma_{\\hat{\\mu}_{\\mathrm{ex}}} \\approx \\frac{k_{\\mathrm{B}} T}{\\sqrt{N_{\\mathrm{eff}}}}$.\n\nThe problem requires a threshold for when the estimate is unreliable, defined as failing to meet a target standard error of $0.1\\,k_{\\mathrm{B}} T$. We set up the inequality:\n$$\n\\frac{k_{\\mathrm{B}} T}{\\sqrt{N_{\\mathrm{eff}}}} \\lesssim 0.1\\,k_{\\mathrm{B}} T\n$$\n$$\n\\frac{1}{\\sqrt{N_{\\mathrm{eff}}}} \\lesssim 0.1 \\implies \\sqrt{N_{\\mathrm{eff}}} \\gtrsim 10 \\implies N_{\\mathrm{eff}} \\gtrsim 100\n$$\nTherefore, for the estimate to be considered reliable with the target precision, the effective sample size should be at least 100. If $N_{\\mathrm{eff}}  100$, the result should be deemed unreliable. This matches option A, which provides both the correct formula for $N_{\\mathrm{eff}}$ and the correctly derived threshold.", "answer": "$$\\boxed{A}$$", "id": "3461886"}, {"introduction": "Theory and analysis are now put into practice through direct implementation. This final capstone exercise [@problem_id:3461917] challenges you to write a complete algorithm for Widom test-particle insertion of a rigid diatomic molecule. You will tackle essential details of molecular simulation, including sampling random positions and orientations, applying periodic boundary conditions with the minimum image convention, and handling complex insertion constraints. This hands-on coding problem solidifies your understanding by translating the abstract statistical mechanical formulas into a concrete, working simulation routine.", "problem": "You are asked to design and implement a complete, deterministic procedure to sample random insertion positions and orientations for a rigid diatomic test particle within a three-dimensional cubic simulation box under Periodic Boundary Conditions (PBC), consistent with the Minimum-Image Convention (MIC) and with strict avoidance of bonded-exclusion regions. The target is to estimate the dimensionless excess chemical potential from first principles by sampling the Boltzmann factors of energy changes upon insertion. The implementation must be robust, scientifically self-consistent, and numerically stable.\n\nBegin from the canonical ensemble and the definition of chemical potential as the derivative of the Helmholtz free energy with respect to particle number at constant temperature and volume. The procedure must deduce the appropriate observable to estimate based on the statistical mechanics description, and must not rely on any shortcut formula provided in this statement.\n\nThe system consists of $N$ point particles interacting via a truncated Lennard–Jones (LJ) potential in reduced units with characteristic length $\\sigma$ and well depth $\\varepsilon$, both set to $1$. The diatomic test particle comprises two LJ sites separated by a fixed bond length $\\ell$. For each random insertion attempt, sample a uniformly distributed position for the dimer center within the box and a uniformly distributed orientation for the dimer axis over the unit sphere. Construct the two insertion sites at positions $\\mathbf{r}_\\mathrm{center} \\pm (\\ell/2)\\,\\hat{\\mathbf{u}}$, where $\\hat{\\mathbf{u}}$ is the sampled unit orientation vector. Apply the Minimum-Image Convention compatible with Periodic Boundary Conditions to compute all inter-site displacements and distances. Reject insertions by setting their Boltzmann weight to zero whenever either insertion site lies within any bonded-exclusion region defined around specified “bonded” anchor atoms. A bonded-exclusion region is a sphere of radius $r_\\mathrm{excl}$ centered at any atom classified as bonded. The classification of bonded anchors is deterministic and rule-based, as defined in the test suite below.\n\nFor energy calculation on valid insertions, compute the interaction energy change $\\Delta U$ as the sum of pairwise truncated LJ interactions between the two inserted sites and all existing atoms, using the Minimum-Image Convention for the separations. Use the standard reduced Lennard–Jones form\n$$\nu_\\mathrm{LJ}(r) = \\begin{cases}\n4 \\varepsilon \\left[\\left(\\frac{\\sigma}{r}\\right)^{12} - \\left(\\frac{\\sigma}{r}\\right)^6 \\right],  r  r_\\mathrm{c},\\\\\n0,  r \\ge r_\\mathrm{c},\n\\end{cases}\n$$\nwith $\\sigma = 1$ and $\\varepsilon = 1$. No long-range corrections are to be applied. The sampling domain for insertion centers is the whole box; bonded-exclusion imposes zero Boltzmann weight for any insertion whose constructed sites fall within any exclusion sphere.\n\nOrientation sampling must be uniform over the unit sphere. One acceptable method is to draw a three-dimensional vector with independent Gaussian components and normalize it to unit length to obtain $\\hat{\\mathbf{u}}$.\n\nLet $M$ be the number of independent insertion attempts per test case. For each attempt $i$, compute the Boltzmann factor $w_i = \\exp\\!\\left(-\\beta \\Delta U_i\\right)$ if the insertion is valid, and $w_i = 0$ if either site violates bonded-exclusion. Here $\\beta = 1/(k_\\mathrm{B} T)$, with Boltzmann constant $k_\\mathrm{B} = 1$ in reduced units. Use the sampling to produce the dimensionless excess chemical potential (excess relative to the ideal contribution) in the form required by statistical mechanics, expressed as a dimensionless quantity without physical units.\n\nScientific and numerical constraints:\n- Use Periodic Boundary Conditions in a cubic box of edge length $L$ and the Minimum-Image Convention for all displacement computations.\n- Ensure the random orientation sampling is uniform over the sphere, and the random center sampling is uniform over the box.\n- Use reduced Lennard–Jones units with $\\sigma = 1$, $\\varepsilon = 1$, $k_\\mathrm{B} = 1$.\n- Reject bonded-exclusion violations strictly by assigning zero Boltzmann weight.\n- Use a truncated potential with cutoff $r_\\mathrm{c}$.\n\nTest suite specification:\nFor each test case, generate $N$ atom positions uniformly in $[0,L)$ for each Cartesian component with the specified seed. Classify bonded anchors deterministically as those atoms whose indices satisfy $i \\bmod 3 = 0$ for zero-based indexing. The bonded-exclusion radius is $r_\\mathrm{excl}$. The final output for each test case is the dimensionless excess chemical potential obtained from the Boltzmann-factor sampling procedure described above.\n\nThe four test cases are:\n\n- Case $1$:\n  - $L = 10$\n  - $N = 64$\n  - seed $= 12345$\n  - $T = 1.5$\n  - $\\ell = 1.0$\n  - $r_\\mathrm{excl} = 0.9$\n  - $r_\\mathrm{c} = 2.5$\n  - $M = 10000$\n\n- Case $2$:\n  - $L = 6$\n  - $N = 64$\n  - seed $= 67890$\n  - $T = 1.0$\n  - $\\ell = 1.0$\n  - $r_\\mathrm{excl} = 0.9$\n  - $r_\\mathrm{c} = 2.5$\n  - $M = 10000$\n\n- Case $3$:\n  - $L = 4$\n  - $N = 96$\n  - seed $= 13579$\n  - $T = 0.8$\n  - $\\ell = 1.5$\n  - $r_\\mathrm{excl} = 1.0$\n  - $r_\\mathrm{c} = 2.5$\n  - $M = 10000$\n\n- Case $4$:\n  - $L = 8$\n  - $N = 128$\n  - seed $= 24680$\n  - $T = 1.2$\n  - $\\ell = 2.0$\n  - $r_\\mathrm{excl} = 0.9$\n  - $r_\\mathrm{c} = 2.5$\n  - $M = 10000$\n\nFinal output format:\nYour program must produce a single line of output containing the four dimensionless excess chemical potentials for Cases $1$–$4$ as a comma-separated list enclosed in square brackets, for example, $\\left[\\mu_1,\\mu_2,\\mu_3,\\mu_4\\right]$. Each entry must be a floating-point number. Express the answers as dimensionless quantities without units, formatted with fixed decimal notation to $6$ digits after the decimal point. If the estimator yields a zero average Boltzmann factor, print $\\mathrm{inf}$ for the corresponding case.", "solution": "The problem requires the design and implementation of a procedure to compute the dimensionless excess chemical potential, $\\beta \\mu^{ex}$, of a rigid diatomic test particle in a fluid of $N$ Lennard-Jones particles. The method specified is the Widom test particle insertion method, which is a fundamental technique in statistical mechanics for computing chemical potentials in computer simulations. The entire procedure is deterministic due to the use of specified random number generator seeds for each test case.\n\nFirst, we must derive the expression for the excess chemical potential from first principles, as stipulated. We begin in the canonical ($N,V,T$) ensemble. The chemical potential $\\mu$ relates to the change in Helmholtz free energy $A$ upon adding a particle:\n$$\n\\mu = \\left(\\frac{\\partial A}{\\partial N}\\right)_{V,T}\n$$\nFor a large system, this derivative can be approximated by a finite difference:\n$$\n\\mu \\approx A(N+1, V, T) - A(N, V, T)\n$$\nThe Helmholtz free energy is related to the canonical partition function $Z$ by $A = -k_\\mathrm{B} T \\ln Z$. Thus,\n$$\n\\mu \\approx -k_\\mathrm{B} T \\ln\\left(\\frac{Z(N+1, V, T)}{Z(N, V, T)}\\right)\n$$\nThe partition function for a system of $N$ identical, indistinguishable classical particles is given by\n$$\nZ(N,V,T) = \\frac{1}{N!\\Lambda^{3N}} \\int_V \\dots \\int_V e^{-\\beta U_N(\\mathbf{r}^N)} d\\mathbf{r}^N = \\frac{Q_N}{N!\\Lambda^{3N}}\n$$\nwhere $\\Lambda$ is the thermal de Broglie wavelength, $\\beta = 1/(k_\\mathrm{B} T)$, $U_N$ is the potential energy of the $N$-particle system, and $Q_N$ is the configuration integral. The ratio of partition functions is therefore:\n$$\n\\frac{Z_{N+1}}{Z_N} = \\frac{N!\\Lambda^{3N}}{(N+1)!\\Lambda^{3(N+1)}} \\frac{Q_{N+1}}{Q_N} = \\frac{1}{(N+1)\\Lambda^3} \\frac{Q_{N+1}}{Q_N}\n$$\nThe configuration integral $Q_{N+1}$ can be expressed in terms of $Q_N$. The total potential energy of the $(N+1)$-particle system, $U_{N+1}$, can be split into the energy of the original $N$ particles, $U_N$, and the interaction energy of the $(N+1)$-th particle with the original $N$ particles, $\\Delta U$.\n$$\nU_{N+1}(\\mathbf{r}^{N}, \\mathbf{r}_{N+1}) = U_N(\\mathbf{r}^N) + \\Delta U(\\mathbf{r}_{N+1}; \\mathbf{r}^N)\n$$\nHere, $\\mathbf{r}_{N+1}$ represents the coordinates of the test particle. For a diatomic molecule, these coordinates consist of the center of mass position $\\mathbf{r}_\\text{center}$ and the orientation $\\mathbf{\\Omega}$. The corresponding integration element is $d\\mathbf{r}_{N+1} = d\\mathbf{r}_\\text{center} d\\mathbf{\\Omega}$.\nSubstituting this into the expression for $Q_{N+1}$:\n$$\nQ_{N+1} = \\int d\\mathbf{r}^N \\int d\\mathbf{r}_{N+1} e^{-\\beta (U_N + \\Delta U)} = \\int d\\mathbf{r}^N e^{-\\beta U_N} \\int d\\mathbf{r}_{N+1} e^{-\\beta \\Delta U}\n$$\nThe ratio $Q_{N+1}/Q_N$ is the canonical average of the inner integral over the test particle's coordinates:\n$$\n\\frac{Q_{N+1}}{Q_N} = \\frac{\\int d\\mathbf{r}^N e^{-\\beta U_N} \\int d\\mathbf{r}_{N+1} e^{-\\beta \\Delta U}}{\\int d\\mathbf{r}^N e^{-\\beta U_N}} = \\left\\langle \\int d\\mathbf{r}_{N+1} e^{-\\beta \\Delta U} \\right\\rangle_N\n$$\nThe integral over the test particle's degrees of freedom is performed over the box volume $V$ for its center of mass and the full solid angle $4\\pi$ for its orientation. Thus, $\\int d\\mathbf{r}_{N+1} = \\int_V d\\mathbf{r}_\\text{center} \\int_{4\\pi} d\\mathbf{\\Omega}$.\nThe chemical potential can be decomposed into an ideal gas part and an excess part, $\\mu = \\mu^{id} + \\mu^{ex}$. The ideal part is $\\mu^{id} = k_\\mathrm{B} T \\ln(\\rho \\Lambda^3)$, where $\\rho = (N+1)/V$ is the number density. Combining these relations, the excess chemical potential is given by:\n$$\ne^{-\\beta \\mu^{ex}} = \\left\\langle \\frac{1}{V(4\\pi)} \\int_V d\\mathbf{r}_\\text{center} \\int_{4\\pi} d\\mathbf{\\Omega} \\ e^{-\\beta \\Delta U(\\mathbf{r}_\\text{center}, \\mathbf{\\Omega})} \\right\\rangle_N\n$$\nThe expression on the right is an average over all configurations of the $N$-particle fluid, $\\langle \\dots \\rangle_N$, of an average over all possible test particle insertions. The problem simplifies this by using a single, fixed configuration of the $N$ particles. The task then reduces to computing the insertion average:\n$$\n\\langle e^{-\\beta \\Delta U} \\rangle_\\text{ins} = \\frac{1}{V(4\\pi)} \\int_V d\\mathbf{r}_\\text{center} \\int_{4\\pi} d\\mathbf{\\Omega} \\ e^{-\\beta \\Delta U(\\mathbf{r}_\\text{center}, \\mathbf{\\Omega})}\n$$\nThis integral is estimated using a Monte Carlo procedure. We generate $M$ random, uniformly distributed insertion configurations (center and orientation) and average the Boltzmann factor $\\exp(-\\beta \\Delta U)$:\n$$\n\\langle e^{-\\beta \\Delta U} \\rangle_\\text{ins} \\approx \\frac{1}{M} \\sum_{i=1}^M \\exp(-\\beta \\Delta U_i)\n$$\nThe dimensionless excess chemical potential is then obtained by:\n$$\n\\beta \\mu^{ex} = -\\ln \\left( \\langle e^{-\\beta \\Delta U} \\rangle_\\text{ins} \\right) = -\\ln \\left( \\frac{1}{M} \\sum_{i=1}^M w_i \\right)\n$$\nwhere $w_i = \\exp(-\\beta \\Delta U_i)$ is the Boltzmann weight of the $i$-th insertion.\n\nThe algorithmic procedure is as follows:\n1.  For each test case, initialize the system parameters: box length $L$, number of particles $N$, temperature $T$, diatomic bond length $\\ell$, exclusion radius $r_\\text{excl}$, potential cutoff $r_\\mathrm{c}$, and number of insertion attempts $M$. Set up a random number generator with the specified seed. All calculations use reduced units where $\\sigma=1$, $\\varepsilon=1$, and $k_\\mathrm{B}=1$.\n\n2.  Generate the positions of the $N$ host particles, $\\mathbf{r}_j$ for $j=1, \\dots, N$, by drawing their Cartesian coordinates uniformly from the interval $[0, L)$.\n\n3.  Identify the subset of \"bonded\" anchor atoms. According to the problem, these are atoms whose zero-based index $i$ satisfies $i \\pmod 3 = 0$. Store their positions.\n\n4.  Initialize a variable `boltzmann_sum` to $0.0$. Iterate $M$ times to perform the test particle insertions.\n\n5.  In each iteration $i$:\n    a.  Sample a center of mass position $\\mathbf{r}_\\text{center}$ uniformly within the cubic box of volume $V=L^3$.\n    b.  Sample a random orientation vector $\\hat{\\mathbf{u}}$ uniformly from the surface of a unit sphere. This is done by generating a 3D vector with components drawn from a standard normal distribution and then normalizing the vector.\n    c.  Construct the positions of the two sites of the diatomic molecule: $\\mathbf{r}_a = \\mathbf{r}_\\text{center} - (\\ell/2)\\hat{\\mathbf{u}}$ and $\\mathbf{r}_b = \\mathbf{r}_\\text{center} + (\\ell/2)\\hat{\\mathbf{u}}$.\n\n6.  Check for violations of the bonded-exclusion constraint. For each of the two sites $\\mathbf{r}_a$ and $\\mathbf{r}_b$, calculate the distance to every bonded anchor atom. All distances must be computed using the Minimum Image Convention (MIC) for the periodic boundary conditions. For a displacement vector $\\Delta\\mathbf{r}$ in a cubic box of side length $L$, the MIC displacement is $\\Delta\\mathbf{r}' = \\Delta\\mathbf{r} - L \\cdot \\text{round}(\\Delta\\mathbf{r}/L)$. The distance is the magnitude $\\|\\Delta\\mathbf{r}'\\|$. If any such distance is less than $r_\\text{excl}$, the insertion is invalid.\n\n7.  If the insertion is invalid, the Boltzmann weight $w_i$ is $0$. The loop continues to the next iteration.\n\n8.  If the insertion is valid, calculate the interaction energy change, $\\Delta U_i$. This is the sum of all pairwise interactions between the two inserted sites and the $N$ existing particles:\n    $$\n    \\Delta U_i = \\sum_{j=1}^{N} \\left[ u_\\text{LJ}(\\|\\mathbf{r}_a - \\mathbf{r}_j\\|_\\text{MIC}) + u_\\text{LJ}(\\|\\mathbf{r}_b - \\mathbf{r}_j\\|_\\text{MIC}) \\right]\n    $$\n    The potential $u_\\text{LJ}(r)$ is the truncated Lennard-Jones potential:\n    $$\n    u_\\mathrm{LJ}(r) = \\begin{cases} 4 \\left( r^{-12} - r^{-6} \\right),  r  r_\\mathrm{c} \\\\ 0,  r \\ge r_\\mathrm{c} \\end{cases}\n    $$\n    \n9.  Calculate the Boltzmann weight $w_i = \\exp(-\\beta \\Delta U_i)$ with $\\beta = 1/T$, and add it to `boltzmann_sum`.\n\n10. After $M$ iterations, compute the average Boltzmann factor $\\langle w \\rangle = \\text{boltzmann\\_sum} / M$.\n\n11. The dimensionless excess chemical potential is $\\beta \\mu^{ex} = -\\ln(\\langle w \\rangle)$. If $\\langle w \\rangle = 0$, the result is $\\infty$. This outcome is physically plausible in very dense systems where valid insertion becomes exceedingly improbable.\n\nThis procedure is implemented for each of the four test cases specified.", "answer": "```python\nimport numpy as np\n\ndef pbc_displacement(pos1, pos2, box_length):\n    \"\"\"Calculates the displacement vector obeying the Minimum Image Convention.\"\"\"\n    displacement = pos1 - pos2\n    displacement -= box_length * np.round(displacement / box_length)\n    return displacement\n\ndef lj_potential(r_sq, rc_sq):\n    \"\"\"Calculates the truncated Lennard-Jones potential given squared distance.\"\"\"\n    if r_sq = rc_sq:\n        return 0.0\n    r2_inv = 1.0 / r_sq\n    r6_inv = r2_inv**3\n    return 4.0 * (r6_inv**2 - r6_inv)\n\ndef calculate_mu_ex_beta(L, N, seed, T, l, r_excl, rc, M):\n    \"\"\"\n    Calculates the dimensionless excess chemical potential for a diatomic molecule.\n    \n    The calculation follows the Widom insertion method for a single, static\n    configuration of N particles.\n    \"\"\"\n    rng = np.random.default_rng(seed)\n    \n    # 1. Generate the N-particle system configuration\n    positions = rng.uniform(0.0, L, size=(N, 3))\n    \n    # 2. Identify bonded anchor atoms\n    anchor_indices = [i for i in range(N) if i % 3 == 0]\n    anchor_positions = positions[anchor_indices]\n    \n    boltzmann_sum = 0.0\n    beta = 1.0 / T\n    rc_sq = rc**2\n    r_excl_sq = r_excl**2\n    \n    # 3. Perform M insertion attempts\n    for _ in range(M):\n        # 3a. Sample a random position and orientation for the test particle\n        center = rng.uniform(0.0, L, size=3)\n        orientation_vec = rng.normal(size=3)\n        norm = np.linalg.norm(orientation_vec)\n        if norm == 0:  # Highly improbable, but a safe check\n            continue\n        u_hat = orientation_vec / norm\n        \n        site1 = center - (l / 2.0) * u_hat\n        site2 = center + (l / 2.0) * u_hat\n        \n        # 3b. Check for bonded-exclusion violations\n        is_valid = True\n        if anchor_positions.shape[0]  0:\n            for site in [site1, site2]:\n                disp_vectors = pbc_displacement(np.tile(site, (anchor_positions.shape[0], 1)), anchor_positions, L)\n                distances_sq = np.sum(disp_vectors**2, axis=1)\n                if np.any(distances_sq  r_excl_sq):\n                    is_valid = False\n                    break\n            if not is_valid:\n                continue\n\n        # 3c. If valid, calculate the interaction energy change delta_U\n        delta_u = 0.0\n        # Interactions between site1 and all N particles\n        disp_vectors_1 = pbc_displacement(np.tile(site1, (N, 1)), positions, L)\n        distances_sq_1 = np.sum(disp_vectors_1**2, axis=1)\n\n        # Interactions between site2 and all N particles\n        disp_vectors_2 = pbc_displacement(np.tile(site2, (N, 1)), positions, L)\n        distances_sq_2 = np.sum(disp_vectors_2**2, axis=1)\n        \n        for r_sq in np.concatenate((distances_sq_1, distances_sq_2)):\n            delta_u += lj_potential(r_sq, rc_sq)\n            \n        # 3d. Accumulate the Boltzmann factor\n        boltzmann_sum += np.exp(-beta * delta_u)\n        \n    # 4. Calculate the final result\n    avg_boltzmann = boltzmann_sum / M\n    \n    if avg_boltzmann = 0.0:\n        return np.inf\n    else:\n        mu_ex_beta = -np.log(avg_boltzmann)\n        return mu_ex_beta\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print results.\n    \"\"\"\n    test_cases = [\n        {'L': 10, 'N': 64, 'seed': 12345, 'T': 1.5, 'l': 1.0, 'r_excl': 0.9, 'rc': 2.5, 'M': 10000},\n        {'L': 6, 'N': 64, 'seed': 67890, 'T': 1.0, 'l': 1.0, 'r_excl': 0.9, 'rc': 2.5, 'M': 10000},\n        {'L': 4, 'N': 96, 'seed': 13579, 'T': 0.8, 'l': 1.5, 'r_excl': 1.0, 'rc': 2.5, 'M': 10000},\n        {'L': 8, 'N': 128, 'seed': 24680, 'T': 1.2, 'l': 2.0, 'r_excl': 0.9, 'rc': 2.5, 'M': 10000},\n    ]\n\n    results = []\n    for case in test_cases:\n        result = calculate_mu_ex_beta(**case)\n        if result == np.inf:\n            results.append(\"inf\")\n        else:\n            results.append(f\"{result:.6f}\")\n    \n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```", "id": "3461917"}]}