{"hands_on_practices": [{"introduction": "The defining feature of the discontinuous Galerkin method is its use of 'broken' function spaces, where solutions can be discontinuous across element boundaries. To resolve these discontinuities and ensure a consistent and stable scheme, a numerical flux is introduced at each interface. This first exercise [@problem_id:3584949] takes you to the heart of this concept by asking you to derive and compute the fundamental upwind flux, which correctly models the direction of information flow for hyperbolic transport phenomena.", "problem": "In computational geophysics, transport of a scalar property (for example, a nondimensionalized tracer concentration) along a prescribed one-dimensional flow can be modeled by the linear advection Partial Differential Equation (PDE) $u_{t} + a\\,u_{x} = 0$, where $u(x,t)$ is the scalar field and $a$ is the (constant) advection speed. Consider a Discontinuous Galerkin (DG) spatial discretization on a one-dimensional mesh, and focus on the semi-discrete interface term at a single shared face between two adjacent elements. Let the interior trace approaching the face from the left element be $u^{-}$ and from the right element be $u^{+}$. The face-normal flux is given by the physical flux $f(u) = a\\,u$, and the DG method replaces the physical flux at the face by a consistent numerical flux that is derived by solving the local Riemann problem.\n\nStarting from the governing conservation law $u_{t} + (f(u))_{x} = 0$ with $f(u) = a\\,u$, and invoking the characteristic structure of linear hyperbolic transport, derive the upwind numerical flux at the shared face. Then, for the specific states $u^{-} = 2$, $u^{+} = -1$, and wave speed $a = 3$ (all nondimensional), compute the resulting upwind numerical flux at the face. Provide a single real number as your final answer. No rounding is required. The variables are nondimensional, so no physical units are needed in the final answer.", "solution": "The problem is validated as scientifically grounded, well-posed, objective, and complete. It presents a standard exercise in the numerical analysis of hyperbolic partial differential equations, specifically concerning the derivation and application of an upwind numerical flux for the linear advection equation within the framework of a Discontinuous Galerkin (DG) method.\n\nThe governing equation is the linear advection equation in one spatial dimension, written in conservation form as:\n$$\nu_{t} + (f(u))_{x} = 0\n$$\nwhere $u(x,t)$ is a scalar quantity, and $f(u)$ is the physical flux function. For this problem, the flux is linear, given by $f(u) = a\\,u$, where $a$ is a constant advection speed. The equation can be written in its non-conservative (or advective) form as:\n$$\nu_{t} + a\\,u_{x} = 0\n$$\nThis is a first-order hyperbolic partial differential equation. The characteristic curves of this equation are given by the ordinary differential equation $\\frac{dx}{dt} = a$. The solution $u$ is constant along these characteristic lines. This means that information propagates with speed $a$ in the direction determined by the sign of $a$.\n\nIn the Discontinuous Galerkin method, the solution is allowed to be discontinuous across element faces. At a given face, we have two values for the solution: $u^{-}$ representing the limit from the element on the left, and $u^{+}$ representing the limit from the element on the right. To compute the flux across this face, a numerical flux function, $\\hat{f}(u^{-}, u^{+})$, is used, which must be consistent with the physical flux (i.e., $\\hat{f}(u, u) = f(u)$).\n\nThe upwind numerical flux is derived by solving the local Riemann problem at the interface. The Riemann problem has the initial data:\n$$\nu(x, 0) = \n\\begin{cases} \nu^{-} & \\text{for } x < x_f \\\\\nu^{+} & \\text{for } x > x_f \n\\end{cases}\n$$\nwhere $x_f$ is the position of the face. The solution to this Riemann problem for the linear advection equation is a single wave (a contact discontinuity) propagating with speed $a$. The value of the solution at the interface location $x_f$ for any time $t > 0$, denoted $u(x_f, t)$, is determined by which side of the discontinuity the information is coming from. This is the \"upwind\" direction.\n\nThere are two cases based on the sign of the advection speed $a$:\n\nCase 1: $a > 0$.\nThe characteristics are directed from left to right. Information flows from the region where $x < x_f$ to the region where $x > x_f$. Therefore, the solution at the interface $x_f$ for $t > 0$ will be the value from the left, $u^{-}$. This is the upwind state. The upwind numerical flux, $\\hat{f}_{upwind}$, is the physical flux function $f(u) = a\\,u$ evaluated at this upwind state:\n$$\n\\hat{f}_{upwind}(u^{-}, u^{+}) = f(u^{-}) = a\\,u^{-}\n$$\n\nCase 2: $a < 0$.\nThe characteristics are directed from right to left. Information flows from the region where $x > x_f$ to the region where $x < x_f$. The solution at the interface $x_f$ for $t > 0$ will be the value from the right, $u^{+}$. This is the upwind state. The upwind numerical flux is therefore:\n$$\n\\hat{f}_{upwind}(u^{-}, u^{+}) = f(u^{+}) = a\\,u^{+}\n$$\n\n(The case $a = 0$ is trivial; the flux is $f(u) = 0$ and there is no transport.)\n\nIn summary, the upwind numerical flux for the linear advection equation is given by:\n$$\n\\hat{f}_{upwind}(u^{-}, u^{+}) = \n\\begin{cases} \na\\,u^{-} & \\text{if } a > 0 \\\\\na\\,u^{+} & \\text{if } a < 0 \n\\end{cases}\n$$\n\nWe are asked to compute this flux for the specific values:\n- Left state: $u^{-} = 2$\n- Right state: $u^{+} = -1$\n- Advection speed: $a = 3$\n\nSince the advection speed is $a = 3$, which is greater than $0$, we must use the first case of the derived formula. Information flows from left to right, so the upwind state is $u^{-}$. The numerical flux is:\n$$\n\\hat{f}_{upwind} = a\\,u^{-}\n$$\nSubstituting the given numerical values:\n$$\n\\hat{f}_{upwind} = (3) \\cdot (2) = 6\n$$\nThe resulting upwind numerical flux at the face is $6$.", "answer": "$$\n\\boxed{6}\n$$", "id": "3584949"}, {"introduction": "While numerical fluxes govern the interactions between elements, the behavior within each element is determined by its basis functions. The elemental mass matrix, which arises from the $L^2$ inner product of these basis functions, is a cornerstone of the DG semi-discretization. This practice [@problem_id:3584924] provides a concrete look at this process, guiding you through the construction of the exact mass matrix for a higher-order nodal basis and revealing its non-diagonal structure, a key feature that distinguishes it from computationally simpler 'lumped' mass matrices.", "problem": "In one-dimensional Discontinuous Galerkin (DG) discretizations used in computational geophysics for wave propagation and transport, the elemental mass matrix arises from the $L^{2}$ inner product of basis functions on a reference element under the standard pullback. Consider the reference interval $[-1,1]$ and polynomial degree $p=2$ with a nodal Lagrange basis built at Gauss–Lobatto–Legendre (GLL) nodes. Let the nodes be $x_{0}=-1$, $x_{1}=0$, and $x_{2}=1$, and let $\\{\\ell_{i}(x)\\}_{i=0}^{2}$ denote the Lagrange basis polynomials satisfying $\\ell_{i}(x_{j})=\\delta_{ij}$.\n\nUsing the exact $L^{2}$ inner product on $[-1,1]$, the elemental mass matrix $\\boldsymbol{M}$ is defined by\n$$\nM_{ij}=\\int_{-1}^{1}\\ell_{i}(x)\\,\\ell_{j}(x)\\,\\mathrm{d}x,\\quad i,j\\in\\{0,1,2\\}.\n$$\nStarting from the fundamental definition of the Lagrange basis and the inner product above, explicitly construct all entries of $\\boldsymbol{M}$ for this basis on $[-1,1]$ and determine whether the resulting exact mass matrix is diagonal. Then, as a single quantitative metric of the matrix, compute the determinant of the exact mass matrix.\n\nProvide a complete derivation from first principles. State clearly whether the mass matrix is diagonal under exact integration, and use exact arithmetic throughout. Report the determinant of the exact mass matrix as your final answer in exact closed form. No rounding is required, and no units are involved. The final answer must be a single exact number.", "solution": "The problem requires the explicit construction of the elemental mass matrix $\\boldsymbol{M}$ for a one-dimensional Discontinuous Galerkin (DG) method on the reference interval $[-1, 1]$. The basis is a nodal Lagrange basis of polynomial degree $p=2$ constructed at the Gauss-Lobatto-Legendre (GLL) nodes, which for $p=2$ are given as $x_0 = -1$, $x_1 = 0$, and $x_2 = 1$. The entries of the mass matrix are defined by the $L^2$ inner product of the basis functions:\n$$\nM_{ij} = \\int_{-1}^{1} \\ell_i(x) \\ell_j(x) \\, \\mathrm{d}x, \\quad i, j \\in \\{0, 1, 2\\}\n$$\nwhere $\\{\\ell_i(x)\\}_{i=0}^{2}$ are the Lagrange basis polynomials.\n\nFirst, we construct the Lagrange basis polynomials. A Lagrange polynomial $\\ell_i(x)$ of degree $p=2$ is defined by the property $\\ell_i(x_j) = \\delta_{ij}$, where $\\delta_{ij}$ is the Kronecker delta. The general formula is:\n$$\n\\ell_i(x) = \\prod_{j=0, j \\neq i}^{2} \\frac{x - x_j}{x_i - x_j}\n$$\n\nFor $i=0$ and node $x_0 = -1$:\n$$\n\\ell_0(x) = \\frac{x - x_1}{x_0 - x_1} \\cdot \\frac{x - x_2}{x_0 - x_2} = \\frac{x - 0}{-1 - 0} \\cdot \\frac{x - 1}{-1 - 1} = \\left(\\frac{x}{-1}\\right) \\left(\\frac{x-1}{-2}\\right) = \\frac{1}{2}x(x-1) = \\frac{1}{2}(x^2 - x)\n$$\n\nFor $i=1$ and node $x_1 = 0$:\n$$\n\\ell_1(x) = \\frac{x - x_0}{x_1 - x_0} \\cdot \\frac{x - x_2}{x_1 - x_2} = \\frac{x - (-1)}{0 - (-1)} \\cdot \\frac{x - 1}{0 - 1} = \\left(\\frac{x+1}{1}\\right) \\left(\\frac{x-1}{-1}\\right) = -(x+1)(x-1) = 1 - x^2\n$$\n\nFor $i=2$ and node $x_2 = 1$:\n$$\n\\ell_2(x) = \\frac{x - x_0}{x_2 - x_0} \\cdot \\frac{x - x_1}{x_2 - x_1} = \\frac{x - (-1)}{1 - (-1)} \\cdot \\frac{x - 0}{1 - 0} = \\left(\\frac{x+1}{2}\\right) \\left(\\frac{x}{1}\\right) = \\frac{1}{2}x(x+1) = \\frac{1}{2}(x^2 + x)\n$$\n\nNext, we calculate the entries of the mass matrix $\\boldsymbol{M}$ by integrating the products of these polynomials over the interval $[-1, 1]$. We will use the fact that for an integer $n \\ge 0$, $\\int_{-1}^{1} x^n \\, \\mathrm{d}x = \\frac{2}{n+1}$ if $n$ is even, and $\\int_{-1}^{1} x^n \\, \\mathrm{d}x = 0$ if $n$ is odd.\n\nThe matrix $\\boldsymbol{M}$ is symmetric ($M_{ij} = M_{ji}$), so we only need to compute the diagonal and upper-triangular entries.\n\nDiagonal entries:\n$$\nM_{00} = \\int_{-1}^{1} [\\ell_0(x)]^2 \\, \\mathrm{d}x = \\int_{-1}^{1} \\left(\\frac{1}{2}(x^2 - x)\\right)^2 \\, \\mathrm{d}x = \\frac{1}{4} \\int_{-1}^{1} (x^4 - 2x^3 + x^2) \\, \\mathrm{d}x = \\frac{1}{4}\\left(\\frac{2}{5} - 0 + \\frac{2}{3}\\right) = \\frac{1}{4}\\left(\\frac{6+10}{15}\\right) = \\frac{1}{4}\\left(\\frac{16}{15}\\right) = \\frac{4}{15}\n$$\n$$\nM_{11} = \\int_{-1}^{1} [\\ell_1(x)]^2 \\, \\mathrm{d}x = \\int_{-1}^{1} (1 - x^2)^2 \\, \\mathrm{d}x = \\int_{-1}^{1} (1 - 2x^2 + x^4) \\, \\mathrm{d}x = 2 - 2\\left(\\frac{2}{3}\\right) + \\frac{2}{5} = 2 - \\frac{4}{3} + \\frac{2}{5} = \\frac{30 - 20 + 6}{15} = \\frac{16}{15}\n$$\nBy symmetry, $\\ell_2(x) = \\ell_0(-x)$. Thus, $M_{22} = \\int_{-1}^{1} [\\ell_2(x)]^2 \\, \\mathrm{d}x = \\int_{-1}^{1} [\\ell_0(-x)]^2 \\, \\mathrm{d}x$. Letting $u = -x$, this becomes $\\int_{1}^{-1} [\\ell_0(u)]^2 (- \\mathrm{d}u) = \\int_{-1}^{1} [\\ell_0(u)]^2 \\, \\mathrm{d}u = M_{00}$.\n$$\nM_{22} = M_{00} = \\frac{4}{15}\n$$\n\nOff-diagonal entries:\n$$\nM_{01} = \\int_{-1}^{1} \\ell_0(x) \\ell_1(x) \\, \\mathrm{d}x = \\int_{-1}^{1} \\frac{1}{2}(x^2 - x)(1 - x^2) \\, \\mathrm{d}x = \\frac{1}{2} \\int_{-1}^{1} (x^2 - x^4 - x + x^3) \\, \\mathrm{d}x = \\frac{1}{2}\\left(\\frac{2}{3} - \\frac{2}{5} - 0 + 0\\right) = \\frac{1}{2}\\left(\\frac{10-6}{15}\\right) = \\frac{1}{2}\\left(\\frac{4}{15}\\right) = \\frac{2}{15}\n$$\nBy symmetry, $M_{10} = M_{01} = \\frac{2}{15}$.\n$$\nM_{12} = \\int_{-1}^{1} \\ell_1(x) \\ell_2(x) \\, \\mathrm{d}x = \\int_{-1}^{1} (1 - x^2)\\frac{1}{2}(x^2 + x) \\, \\mathrm{d}x = \\frac{1}{2} \\int_{-1}^{1} (x^2 + x - x^4 - x^3) \\, \\mathrm{d}x = \\frac{1}{2}\\left(\\frac{2}{3} + 0 - \\frac{2}{5} - 0\\right) = \\frac{1}{2}\\left(\\frac{4}{15}\\right) = \\frac{2}{15}\n$$\nBy symmetry, $M_{21} = M_{12} = \\frac{2}{15}$.\n$$\nM_{02} = \\int_{-1}^{1} \\ell_0(x) \\ell_2(x) \\, \\mathrm{d}x = \\int_{-1}^{1} \\frac{1}{2}(x^2 - x)\\frac{1}{2}(x^2 + x) \\, \\mathrm{d}x = \\frac{1}{4} \\int_{-1}^{1} (x^4 - x^2) \\, \\mathrm{d}x = \\frac{1}{4}\\left(\\frac{2}{5} - \\frac{2}{3}\\right) = \\frac{1}{4}\\left(\\frac{6-10}{15}\\right) = \\frac{1}{4}\\left(-\\frac{4}{15}\\right) = -\\frac{1}{15}\n$$\nBy symmetry, $M_{20} = M_{02} = -\\frac{1}{15}$.\n\nThe complete exact elemental mass matrix is:\n$$\n\\boldsymbol{M} = \\begin{pmatrix} M_{00} & M_{01} & M_{02} \\\\ M_{10} & M_{11} & M_{12} \\\\ M_{20} & M_{21} & M_{22} \\end{pmatrix} = \\begin{pmatrix} 4/15 & 2/15 & -1/15 \\\\ 2/15 & 16/15 & 2/15 \\\\ -1/15 & 2/15 & 4/15 \\end{pmatrix} = \\frac{1}{15} \\begin{pmatrix} 4 & 2 & -1 \\\\ 2 & 16 & 2 \\\\ -1 & 2 & 4 \\end{pmatrix}\n$$\nThe problem asks whether the resulting exact mass matrix is diagonal. Since there are non-zero off-diagonal entries (e.g., $M_{01} = 2/15$), the exact mass matrix is **not** diagonal. A diagonal mass matrix can be obtained via numerical quadrature with the GLL nodes themselves (a technique known as mass lumping), but the question specified using the exact $L^2$ inner product.\n\nFinally, we compute the determinant of the exact mass matrix $\\boldsymbol{M}$.\n$$\n\\det(\\boldsymbol{M}) = \\det\\left( \\frac{1}{15} \\begin{pmatrix} 4 & 2 & -1 \\\\ 2 & 16 & 2 \\\\ -1 & 2 & 4 \\end{pmatrix} \\right)\n$$\nUsing the property $\\det(c\\boldsymbol{A}) = c^n \\det(\\boldsymbol{A})$ for an $n \\times n$ matrix $\\boldsymbol{A}$ (here $n=3$):\n$$\n\\det(\\boldsymbol{M}) = \\left(\\frac{1}{15}\\right)^3 \\det \\begin{pmatrix} 4 & 2 & -1 \\\\ 2 & 16 & 2 \\\\ -1 & 2 & 4 \\end{pmatrix}\n$$\nThe determinant of the integer matrix is calculated using the cofactor expansion along the first row:\n$$\n\\det \\begin{pmatrix} 4 & 2 & -1 \\\\ 2 & 16 & 2 \\\\ -1 & 2 & 4 \\end{pmatrix} = 4 \\begin{vmatrix} 16 & 2 \\\\ 2 & 4 \\end{vmatrix} - 2 \\begin{vmatrix} 2 & 2 \\\\ -1 & 4 \\end{vmatrix} + (-1) \\begin{vmatrix} 2 & 16 \\\\ -1 & 2 \\end{vmatrix}\n$$\n$$\n= 4(16 \\cdot 4 - 2 \\cdot 2) - 2(2 \\cdot 4 - 2 \\cdot (-1)) - 1(2 \\cdot 2 - 16 \\cdot (-1))\n$$\n$$\n= 4(64 - 4) - 2(8 + 2) - (4 + 16)\n$$\n$$\n= 4(60) - 2(10) - 20 = 240 - 20 - 20 = 200\n$$\nSubstituting this back into the expression for $\\det(\\boldsymbol{M})$:\n$$\n\\det(\\boldsymbol{M}) = \\frac{200}{15^3} = \\frac{200}{3375}\n$$\nWe simplify the fraction:\n$$\n\\frac{200}{3375} = \\frac{8 \\times 25}{135 \\times 25} = \\frac{8}{135}\n$$\nThe determinant of the exact mass matrix is $\\frac{8}{135}$.", "answer": "$$\\boxed{\\frac{8}{135}}$$", "id": "3584924"}, {"introduction": "The ultimate test of a numerical method is not just its mathematical correctness, but its ability to faithfully reproduce the physics of the system it models. This final practice [@problem_id:3584942] bridges the gap from theoretical components to applied geophysical insight by designing a numerical experiment. You will investigate how different choices of the numerical flux—a core DG component—affect the preservation of acoustic reciprocity, a fundamental symmetry principle in wave propagation, thereby developing critical skills in verifying and validating computational models.", "problem": "Consider the one-dimensional linear acoustics initial value problem on a periodic domain of length $L$, with spatial coordinate $x \\in [0,L)$ and time $t \\ge 0$. The fields are the acoustic pressure $p(x,t)$ and the particle velocity $u(x,t)$. The governing equations follow from conservation of linear momentum and mass for a compressible, non-viscous medium, yielding the symmetric hyperbolic system\n$$\n\\partial_t p(x,t) + \\partial_x\\big(K(x)\\,u(x,t)\\big) = 0,\\qquad \\partial_t u(x,t) + \\partial_x\\left(\\frac{1}{\\rho(x)}\\,p(x,t)\\right) = 0,\n$$\nwhere $K(x)$ is the bulk modulus, $\\rho(x)$ is the density, and the local wave speed and acoustic impedance are $c(x)=\\sqrt{\\frac{K(x)}{\\rho(x)}}$ and $Z(x)=\\sqrt{\\rho(x)K(x)}$, respectively. On a periodic domain with homogeneous medium and exact arithmetic, the continuous Green’s function $G(x_r,t;x_s)$ for this system satisfies the acoustic reciprocity relation $G(x_r,t;x_s)=G(x_s,t;x_r)$ for all receiver locations $x_r$, source locations $x_s$, and times $t$. \n\nA Discontinuous Galerkin (DG) method discretizes the domain into $N$ non-overlapping elements (cells) and approximates $(p,u)$ by element-local functions. In the piecewise-constant case (polynomial degree $p=0$), the method reduces to a first-order DG scheme that coincides with a conservative finite-volume update for hyperbolic systems and uses inter-element numerical fluxes to connect discontinuities at cell interfaces. Let the cell-averaged state in cell $i$ be $\\mathbf{q}_i(t)=\\begin{bmatrix}p_i(t)\\\\u_i(t)\\end{bmatrix}$, and let the interface numerical flux at $x_{i+\\frac{1}{2}}$ be $\\mathbf{F}_{i+\\frac{1}{2}}$. The semi-discrete update is\n$$\n\\frac{d\\mathbf{q}_i}{dt} = -\\frac{1}{\\Delta x}\\left(\\mathbf{F}_{i+\\frac{1}{2}} - \\mathbf{F}_{i-\\frac{1}{2}}\\right),\n$$\nwith periodic indexing and uniform cell size $\\Delta x = L/N$. The role of numerical fluxes is pivotal: different flux choices may or may not preserve discrete analogues of the reciprocity inherent in the continuous problem. This exercise asks you to design a program that computes a discrete Green’s function symmetry metric under source–receiver swapping for several flux choices and media, quantifying how well reciprocity is preserved.\n\nFlux definitions at an interface between a left state $\\mathbf{q}_L=\\begin{bmatrix}p_L\\\\u_L\\end{bmatrix}$ with parameters $K_L$, $\\rho_L$ and a right state $\\mathbf{q}_R=\\begin{bmatrix}p_R\\\\u_R\\end{bmatrix}$ with parameters $K_R$, $\\rho_R$:\n\n- Central flux:\n$$\n\\mathbf{F}^{\\text{central}}=\\frac{1}{2}\\begin{bmatrix}K_L u_L\\\\ \\frac{p_L}{\\rho_L}\\end{bmatrix}+\\frac{1}{2}\\begin{bmatrix}K_R u_R\\\\ \\frac{p_R}{\\rho_R}\\end{bmatrix}.\n$$\n\n- Rusanov (Lax–Friedrichs) flux with maximum characteristic speed $\\alpha=\\max\\left(\\sqrt{\\frac{K_L}{\\rho_L}},\\sqrt{\\frac{K_R}{\\rho_R}}\\right)$:\n$$\n\\mathbf{F}^{\\text{rusanov}}=\\frac{1}{2}\\begin{bmatrix}K_L u_L\\\\ \\frac{p_L}{\\rho_L}\\end{bmatrix}+\\frac{1}{2}\\begin{bmatrix}K_R u_R\\\\ \\frac{p_R}{\\rho_R}\\end{bmatrix}-\\frac{\\alpha}{2}\\left(\\mathbf{q}_R-\\mathbf{q}_L\\right).\n$$\n\n- Characteristic upwind flux based on interface star states constructed from left and right impedances $Z_L=\\sqrt{\\rho_L K_L}$ and $Z_R=\\sqrt{\\rho_R K_R}$:\n$$\np^*=\\frac{Z_R p_L+Z_L p_R+Z_L Z_R\\left(u_L-u_R\\right)}{Z_L+Z_R},\\qquad\nu^*=\\frac{p_L-p_R+Z_R u_L+Z_L u_R}{Z_L+Z_R},\n$$\nwith a single numerical flux defined by arithmetic averages $K_{\\text{hat}}=\\frac{K_L+K_R}{2}$ and $\\rho_{\\text{hat}}=\\frac{\\rho_L+\\rho_R}{2}$,\n$$\n\\mathbf{F}^{\\text{upwind}}=\\begin{bmatrix}K_{\\text{hat}}\\,u^*\\\\ \\frac{p^*}{\\rho_{\\text{hat}}}\\end{bmatrix}.\n$$\n\nTo test reciprocity, define the discrete Green’s function response for a given source cell index $s$ as follows: initialize $p_i(0)=A\\,\\delta_{i,s}/\\Delta x$ with amplitude $A$ and $u_i(0)=0$ for all $i$, integrate to time $T$, and record $p_r(T)$ at a receiver cell index $r$. Repeat with the source at $r$ and record $p_s(T)$. A scalar symmetry metric that measures reciprocity is\n$$\n\\mathcal{E}=\\frac{\\left|p_r(T;\\text{source at }s)-p_s(T;\\text{source at }r)\\right|}{\\max\\left(\\left|p_r(T;\\text{source at }s)\\right|+\\left|p_s(T;\\text{source at }r)\\right|,\\varepsilon\\right)},\n$$\nwith a small regularization $\\varepsilon>0$ to avoid division by zero. Smaller $\\mathcal{E}$ indicates better reciprocity.\n\nStarting from conservation laws and the definition of the DG semi-discretization, implement a program that for each specified test case constructs a medium, applies the chosen numerical flux, advances the solution with an explicit second-order Runge–Kutta method, and computes $\\mathcal{E}$.\n\nUse $L$ in meters, $\\Delta x$ in meters, $t$ and $T$ in seconds, $K$ in pascals, $\\rho$ in kilograms per cubic meter, $p$ in pascals, $u$ in meters per second. The final metric $\\mathcal{E}$ is dimensionless. Use a Courant–Friedrichs–Lewy (CFL) number to select the time-step, and report $\\mathcal{E}$ as a float.\n\nTest Suite:\n- Case $1$: $N=64$, $L=1$ meter, homogeneous medium $K_1=1$ pascal, $\\rho_1=1$ kilogram per cubic meter, $K_2=1$ pascal, $\\rho_2=1$ kilogram per cubic meter, layer fraction $\\phi=0.5$ (unused in homogeneous case), flux type “central”, $A=1$, $T=0.3$ seconds, source index $s=\\lfloor N/4\\rfloor$, receiver index $r=\\lfloor 3N/4\\rfloor$.\n- Case $2$: Same as Case $1$ but flux type “rusanov”.\n- Case $3$: $N=64$, $L=1$ meter, two-layer medium with left fraction $\\phi=0.5$ using $K_1=1$ pascal, $\\rho_1=1$ kilogram per cubic meter, and right fraction using $K_2=4$ pascals, $\\rho_2=1$ kilogram per cubic meter, flux type “central”, $A=1$, $T=0.3$ seconds, $s=\\lfloor N/4\\rfloor$, $r=\\lfloor 3N/4\\rfloor$.\n- Case $4$: Same as Case $3$ but flux type “upwind”.\n- Case $5$: $N=32$, $L=1$ meter, two-layer medium with $\\phi=0.5$, $K_1=1$ pascal, $\\rho_1=1$ kilogram per cubic meter, $K_2=4$ pascals, $\\rho_2=1$ kilogram per cubic meter, flux type “upwind”, $A=1$, $T=0.3$ seconds, $s=\\lfloor N/4\\rfloor$, $r=\\lfloor 3N/4\\rfloor$.\n\nAlgorithmic requirements:\n- Use a uniform mesh with periodic indexing.\n- Use an explicit second-order Runge–Kutta method (Heun’s method) with a Courant–Friedrichs–Lewy (CFL) number of $0.4$: $\\Delta t = 0.4\\,\\Delta x / \\max_i c_i$, and then use an integer number of time steps to reach $T$ exactly by setting $n=\\lceil T/\\Delta t\\rceil$ and $\\Delta t=T/n$.\n- For each test case, compute and store the metric $\\mathcal{E}$ as defined above.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (for example, “$[\\text{result1},\\text{result2},\\text{result3}]$”), where each result corresponds to $\\mathcal{E}$ for one test case in the order given above. The outputs are dimensionless floats without units.", "solution": "The problem presented is a well-posed and scientifically sound exercise in computational geophysics, specifically concerning the numerical verification of the acoustic reciprocity principle using a Discontinuous Galerkin (DG) method. The task is to quantify the degree to which different numerical flux functions preserve the symmetry of the discrete Green's function under the interchange of source and receiver positions. The problem is valid, and a full solution follows.\n\nThe governing equations for one-dimensional linear acoustics with spatially varying material properties, bulk modulus $K(x)$ and density $\\rho(x)$, can be expressed as a first-order hyperbolic system. Let the state vector be $\\mathbf{q}(x,t) = [p(x,t), u(x,t)]^T$, where $p$ is the acoustic pressure and $u$ is the particle velocity. The system is formulated in conservation law form with a spatially dependent flux:\n$$\n\\frac{\\partial \\mathbf{q}}{\\partial t} + \\frac{\\partial \\mathbf{f}(\\mathbf{q}, x)}{\\partial x} = \\mathbf{0}\n$$\nwhere the state vector $\\mathbf{q}$ and the flux vector $\\mathbf{f}$ are given by:\n$$\n\\mathbf{q} = \\begin{bmatrix} p \\\\ u \\end{bmatrix}, \\quad \\mathbf{f}(\\mathbf{q}, x) = \\begin{bmatrix} K(x) u \\\\ p / \\rho(x) \\end{bmatrix}\n$$\nThis formulation is valid for media with piecewise-constant properties, where derivatives of $K(x)$ and $\\rho(x)$ are interpreted in a distributional sense as Dirac delta functions at material interfaces.\n\nWe employ a first-order DG method, which is equivalent to a conservative finite volume scheme. The spatial domain $x \\in [0, L)$ is partitioned into $N$ uniform cells, each of width $\\Delta x = L/N$. The state vector is approximated by a cell-averaged quantity $\\mathbf{q}_i(t)$ in each cell $i$. Integrating the conservation law over cell $i = [x_{i-1/2}, x_{i+1/2}]$ yields the semi-discrete ordinary differential equation (ODE) for each cell average:\n$$\n\\frac{d\\mathbf{q}_i}{dt} = -\\frac{1}{\\Delta x} \\left( \\mathbf{F}_{i+1/2} - \\mathbf{F}_{i-1/2} \\right)\n$$\nHere, $\\mathbf{F}_{i+1/2}$ is the numerical flux at the interface $x_{i+1/2}$ between cell $i$ and cell $i+1$. The numerical flux function's role is to resolve the discontinuity at the interface by approximating the solution to a local Riemann problem. It depends on the states from the left ($\\mathbf{q}_L = \\mathbf{q}_i$) and right ($\\mathbf{q}_R = \\mathbf{q}_{i+1}$), as well as the material properties on either side of the interface ($K_L, \\rho_L$ and $K_R, \\rho_R$). The problem specifies three flux functions:\n\n1.  **Central Flux**: $\\mathbf{F}^{\\text{central}} = \\frac{1}{2}\\left(\\mathbf{f}(\\mathbf{q}_L, x_L) + \\mathbf{f}(\\mathbf{q}_R, x_R)\\right) = \\frac{1}{2}\\begin{bmatrix}K_L u_L \\\\ p_L/\\rho_L \\end{bmatrix} + \\frac{1}{2}\\begin{bmatrix}K_R u_R \\\\ p_R/\\rho_R \\end{bmatrix}$. This flux is simple but non-dissipative and is known to be unstable for hyperbolic systems, leading to spurious oscillations.\n\n2.  **Rusanov (Lax–Friedrichs) Flux**: $\\mathbf{F}^{\\text{rusanov}} = \\mathbf{F}^{\\text{central}} - \\frac{\\alpha}{2}(\\mathbf{q}_R - \\mathbf{q}_L)$, where $\\alpha$ is a dissipation coefficient equal to the maximum local characteristic speed, $\\alpha = \\max(c_L, c_R) = \\max\\left(\\sqrt{K_L/\\rho_L}, \\sqrt{K_R/\\rho_R}\\right)$. This flux introduces numerical dissipation, which stabilizes the scheme.\n\n3.  **Characteristic Upwind Flux**: This flux is constructed using the solution to the exact Riemann problem for the linearized system, denoted by the \"star\" states $(p^*, u^*)$. These are given by:\n    $$\n    p^*=\\frac{Z_R p_L+Z_L p_R+Z_L Z_R\\left(u_L-u_R\\right)}{Z_L+Z_R}, \\qquad u^*=\\frac{p_L-p_R+Z_R u_L+Z_L u_R}{Z_L+Z_R}\n    $$\n    where $Z_L = \\sqrt{\\rho_L K_L}$ and $Z_R = \\sqrt{\\rho_R K_R}$ are the acoustic impedances. The final flux vector is formed using arithmetically averaged material properties, $\\hat{K} = (K_L+K_R)/2$ and $\\hat{\\rho} = (\\rho_L+\\rho_R)/2$:\n    $$\n    \\mathbf{F}^{\\text{upwind}} = \\begin{bmatrix} \\hat{K} u^* \\\\ p^*/\\hat{\\rho} \\end{bmatrix}\n    $$\n    This choice of parameter averaging is one of several possibilities and affects properties like discrete reciprocity.\n\nThe system of ODEs is advanced in time using an explicit second-order Runge-Kutta method, specifically Heun's method. For a system $\\frac{d\\mathbf{y}}{dt} = G(\\mathbf{y})$, a single time step from $t_n$ to $t_{n+1}=t_n+\\Delta t$ is computed as:\n$$\n\\begin{align*}\n\\mathbf{k}_1 &= G(\\mathbf{y}_n) \\\\\n\\mathbf{y}^* &= \\mathbf{y}_n + \\Delta t \\, \\mathbf{k}_1 \\\\\n\\mathbf{k}_2 &= G(\\mathbf{y}^*) \\\\\n\\mathbf{y}_{n+1} &= \\mathbf{y}_n + \\frac{\\Delta t}{2}(\\mathbf{k}_1 + \\mathbf{k}_2)\n\\end{align*}\nHere, $\\mathbf{y}$ is the global state vector containing all $\\mathbf{q}_i$, and $G$ is the right-hand side spatial discretization operator. The time step $\\Delta t$ is chosen to satisfy a Courant–Friedrichs–Lewy (CFL) stability condition. The raw time step $\\Delta t_{\\text{raw}} = \\text{CFL} \\cdot \\Delta x / \\max_i(c_i)$ with $\\text{CFL}=0.4$ is calculated, and then adjusted to $\\Delta t = T/n$ where $n=\\lceil T/\\Delta t_{\\text{raw}}\\rceil$ to ensure the simulation ends exactly at time $T$.\n\nTo evaluate reciprocity, we compute a numerical Green's function by initializing the system with a discrete delta function source. A source at cell $s$ is modeled by the initial condition $p_i(0) = A \\delta_{i,s} / \\Delta x$ and $u_i(0)=0$. We run two simulations for each test case:\n1.  Source at cell $s$, receiver at cell $r$: compute $p_r(T; \\text{source at } s)$.\n2.  Source at cell $r$, receiver at cell $s$: compute $p_s(T; \\text{source at } r)$.\n\nThe reciprocity error is quantified by the symmetry metric $\\mathcal{E}$:\n$$\n\\mathcal{E} = \\frac{\\left|p_r(T;\\text{source at }s)-p_s(T;\\text{source at }r)\\right|}{\\max\\left(\\left|p_r(T;\\text{source at }s)\\right|+\\left|p_s(T;\\text{source at }r)\\right|,\\varepsilon\\right)}\n$$\nA small regularization parameter, $\\varepsilon = 10^{-16}$, is used to prevent division by zero or near-zero values. A smaller value of $\\mathcal{E}$ indicates a better numerical preservation of the reciprocity principle.\n\nFor media with two layers, the domain $[0,L)$ is split at $x = \\phi L$. Cells with centers $x_i < \\phi L$ are assigned material properties $(K_1, \\rho_1)$, and cells with $x_i \\ge \\phi L$ are assigned $(K_2, \\rho_2)$. All boundaries are handled using periodic indexing, where the neighbor to the right of cell $N-1$ is cell $0$.\n\nThe implementation will proceed by defining a function that executes a full simulation for a given set of parameters, which is then called twice for each test case to compute the two required pressure values for the metric $\\mathcal{E}$. The results for all test cases are collected and reported.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nimport math\n\n# from scipy import ...\n\ndef get_rhs(q, N, dx, K, rho, flux_type):\n    \"\"\"\n    Computes the right-hand side of the semi-discrete ODE system, d(q_i)/dt.\n    This represents the spatial discretization.\n    \"\"\"\n    # q is the state vector of shape (N, 2), where q[:, 0] is pressure and q[:, 1] is velocity.\n    # K and rho are material properties vectors of shape (N,).\n\n    # Get left and right states at each of the N interfaces\n    q_L = q\n    q_R = np.roll(q, -1, axis=0)  # q_{i+1} for cell i\n\n    # Get material properties for left and right states\n    K_L, rho_L = K, rho\n    K_R, rho_R = np.roll(K, -1), np.roll(rho, -1)\n    \n    # Compute physical fluxes f(q) = [K*u, p/rho]\n    f_L = np.zeros_like(q_L)\n    f_L[:, 0] = K_L * q_L[:, 1]\n    f_L[:, 1] = q_L[:, 0] / rho_L\n\n    f_R = np.zeros_like(q_R)\n    f_R[:, 0] = K_R * q_R[:, 1]\n    f_R[:, 1] = q_R[:, 0] / rho_R\n\n    # Compute numerical flux at interfaces\n    if flux_type == \"central\":\n        flux = 0.5 * (f_L + f_R)\n    elif flux_type == \"rusanov\":\n        c_L = np.sqrt(K_L / rho_L)\n        c_R = np.sqrt(K_R / rho_R)\n        alpha = np.maximum(c_L, c_R)\n        # alpha must be broadcast to shape (N, 1) for multiplication with (N, 2) array\n        flux = 0.5 * (f_L + f_R) - 0.5 * alpha[:, np.newaxis] * (q_R - q_L)\n    elif flux_type == \"upwind\":\n        p_L, u_L = q_L[:, 0], q_L[:, 1]\n        p_R, u_R = q_R[:, 0], q_R[:, 1]\n\n        Z_L = np.sqrt(rho_L * K_L)\n        Z_R = np.sqrt(rho_R * K_R)\n        \n        # Denominators for p_star and u_star\n        Z_sum = Z_L + Z_R\n\n        p_star = (Z_R * p_L + Z_L * p_R + Z_L * Z_R * (u_L - u_R)) / Z_sum\n        u_star = (p_L - p_R + Z_R * u_L + Z_L * u_R) / Z_sum\n\n        K_hat = 0.5 * (K_L + K_R)\n        rho_hat = 0.5 * (rho_L + rho_R)\n\n        flux = np.zeros_like(q)\n        flux[:, 0] = K_hat * u_star\n        flux[:, 1] = p_star / rho_hat\n    else:\n        raise ValueError(f\"Unknown flux type: {flux_type}\")\n\n    # Compute divergence of numerical flux: (F_{i+1/2} - F_{i-1/2})\n    # flux_right corresponds to F_{i+1/2} for cell i\n    # flux_left corresponds to F_{i-1/2} for cell i\n    flux_right = flux\n    flux_left = np.roll(flux, 1, axis=0)\n\n    dqdt = -(flux_right - flux_left) / dx\n    return dqdt\n\ndef run_simulation(N, L, K, rho, flux_type, A, T, source_idx, CFL=0.4):\n    \"\"\"\n    Runs a single simulation for a given source and returns the final state vector.\n    \"\"\"\n    dx = L / N\n    \n    # Time step calculation\n    c_max = np.max(np.sqrt(K / rho))\n    dt_raw = CFL * dx / c_max\n    num_steps = math.ceil(T / dt_raw)\n    dt = T / num_steps\n    \n    # Initial conditions\n    q = np.zeros((N, 2))\n    q[source_idx, 0] = A / dx  # p(0)\n    # q[:, 1] is u(0), already initialized to 0\n    \n    # Time integration using Heun's method (RK2)\n    for _ in range(num_steps):\n        k1 = get_rhs(q, N, dx, K, rho, flux_type)\n        q_star = q + dt * k1\n        k2 = get_rhs(q_star, N, dx, K, rho, flux_type)\n        q = q + 0.5 * dt * (k1 + k2)\n        \n    return q\n\ndef solve():\n    test_cases_params = [\n        # Case 1: Homogeneous, central flux\n        {'N': 64, 'L': 1.0, 'K1': 1.0, 'rho1': 1.0, 'K2': 1.0, 'rho2': 1.0, 'phi': 0.5, 'flux_type': 'central', 'A': 1.0, 'T': 0.3},\n        # Case 2: Homogeneous, rusanov flux\n        {'N': 64, 'L': 1.0, 'K1': 1.0, 'rho1': 1.0, 'K2': 1.0, 'rho2': 1.0, 'phi': 0.5, 'flux_type': 'rusanov', 'A': 1.0, 'T': 0.3},\n        # Case 3: Heterogeneous, central flux\n        {'N': 64, 'L': 1.0, 'K1': 1.0, 'rho1': 1.0, 'K2': 4.0, 'rho2': 1.0, 'phi': 0.5, 'flux_type': 'central', 'A': 1.0, 'T': 0.3},\n        # Case 4: Heterogeneous, upwind flux\n        {'N': 64, 'L': 1.0, 'K1': 1.0, 'rho1': 1.0, 'K2': 4.0, 'rho2': 1.0, 'phi': 0.5, 'flux_type': 'upwind', 'A': 1.0, 'T': 0.3},\n        # Case 5: Heterogeneous, upwind flux, coarser grid\n        {'N': 32, 'L': 1.0, 'K1': 1.0, 'rho1': 1.0, 'K2': 4.0, 'rho2': 1.0, 'phi': 0.5, 'flux_type': 'upwind', 'A': 1.0, 'T': 0.3},\n    ]\n\n    results = []\n    epsilon = 1e-16 # Regularization for the symmetry metric\n\n    for params in test_cases_params:\n        N = params['N']\n        L = params['L']\n        phi = params['phi']\n        \n        # Setup material properties\n        K = np.zeros(N)\n        rho = np.zeros(N)\n        num_cells_1 = int(N * phi)\n        K[:num_cells_1] = params['K1']\n        K[num_cells_1:] = params['K2']\n        rho[:num_cells_1] = params['rho1']\n        rho[num_cells_1:] = params['rho2']\n\n        # Source and receiver indices\n        s_idx = N // 4\n        r_idx = 3 * N // 4\n\n        # Simulation 1: source at s, receiver at r\n        q_final_s_to_r = run_simulation(N, L, K, rho, params['flux_type'], params['A'], params['T'], s_idx)\n        p_r_from_s = q_final_s_to_r[r_idx, 0]\n\n        # Simulation 2: source at r, receiver at s\n        q_final_r_to_s = run_simulation(N, L, K, rho, params['flux_type'], params['A'], params['T'], r_idx)\n        p_s_from_r = q_final_r_to_s[s_idx, 0]\n\n        # Calculate symmetry metric E\n        numerator = abs(p_r_from_s - p_s_from_r)\n        denominator = max(abs(p_r_from_s) + abs(p_s_from_r), epsilon)\n        metric_E = numerator / denominator\n        \n        results.append(metric_E)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3584942"}]}