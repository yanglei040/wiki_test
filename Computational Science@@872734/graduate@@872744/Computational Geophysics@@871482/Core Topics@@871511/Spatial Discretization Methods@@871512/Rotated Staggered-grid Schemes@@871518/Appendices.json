{"hands_on_practices": [{"introduction": "The foundation of any finite-difference scheme lies in its discrete operators. This practice focuses on constructing and validating these fundamental building blocks for a rotated staggered-grid arrangement. By implementing approximations for rotated directional derivatives and verifying their accuracy against an analytical solution, you will gain hands-on experience with the practical details of staggered-grid discretization and the critical process of code verification. [@problem_id:3613900]", "problem": "Consider a two-dimensional uniform grid used in computational geophysics with a Rotated Staggered Grid (RSG) arrangement, where a scalar field $u(x,y)$ is stored at cell centers and discrete differential operators are evaluated at staggered locations. Let the domain be periodic and rectangular with lengths $L_x$ and $L_y$ in the $x$ and $y$ directions, respectively. The grid has $N_x$ cells along $x$ and $N_y$ cells along $y$, so that the spacings are $h_x = L_x/N_x$ and $h_y = L_y/N_y$. Cell centers are located at positions $\\left((i+\\tfrac{1}{2})h_x,(j+\\tfrac{1}{2})h_y\\right)$ for integer indices $i \\in \\{0,\\dots,N_x-1\\}$ and $j \\in \\{0,\\dots,N_y-1\\}$. The $x$-faces (vertical faces) are located at positions $\\left(I h_x,(j+\\tfrac{1}{2})h_y\\right)$ with $I \\in \\{0,\\dots,N_x-1\\}$ and $j \\in \\{0,\\dots,N_y-1\\}$; the $y$-faces (horizontal faces) are located at positions $\\left((i+\\tfrac{1}{2})h_x, J h_y\\right)$ with $i \\in \\{0,\\dots,N_x-1\\}$ and $J \\in \\{0,\\dots,N_y-1\\}$. All indexing is interpreted with periodic wrap-around.\n\nDefine a rotated orthonormal basis $\\{\\mathbf{e}_1,\\mathbf{e}_2\\}$ in the plane obtained by rotating the standard basis $\\{\\hat{\\mathbf{x}},\\hat{\\mathbf{y}}\\}$ by an angle $\\theta$ (in radians) such that\n$$\n\\mathbf{e}_1 = (\\cos\\theta)\\,\\hat{\\mathbf{x}} + (\\sin\\theta)\\,\\hat{\\mathbf{y}},\\qquad\n\\mathbf{e}_2 = (-\\sin\\theta)\\,\\hat{\\mathbf{x}} + (\\cos\\theta)\\,\\hat{\\mathbf{y}}.\n$$\nThe directional derivatives of a sufficiently smooth scalar field $u$ along $\\mathbf{e}_1$ and $\\mathbf{e}_2$ are\n$$\nD_{\\mathbf{e}_1} u = (\\cos\\theta)\\,\\frac{\\partial u}{\\partial x} + (\\sin\\theta)\\,\\frac{\\partial u}{\\partial y},\\qquad\nD_{\\mathbf{e}_2} u = (-\\sin\\theta)\\,\\frac{\\partial u}{\\partial x} + (\\cos\\theta)\\,\\frac{\\partial u}{\\partial y}.\n$$\nOn a staggered grid, consistent second-order accurate approximations of $\\tfrac{\\partial u}{\\partial x}$ and $\\tfrac{\\partial u}{\\partial y}$ at face locations can be defined using only cell-centered samples of $u$:\n- At an $x$-face $(I h_x,(j+\\tfrac{1}{2})h_y)$,\n$$\n\\left.\\frac{\\partial u}{\\partial x}\\right|_{x\\text{-face}} \\approx \\frac{u_{I,j} - u_{I-1,j}}{h_x},\\qquad\n\\left.\\frac{\\partial u}{\\partial y}\\right|_{x\\text{-face}} \\approx \\frac{1}{2}\\left(\\left.\\frac{\\partial u}{\\partial y}\\right|_{i=I,j} + \\left.\\frac{\\partial u}{\\partial y}\\right|_{i=I-1,j}\\right),\n$$\nwhere the cell-centered $y$-derivative is approximated by the central difference\n$$\n\\left.\\frac{\\partial u}{\\partial y}\\right|_{i,j} \\approx \\frac{u_{i,j+1} - u_{i,j-1}}{2 h_y}.\n$$\n- At a $y$-face $\\left((i+\\tfrac{1}{2})h_x, J h_y\\right)$,\n$$\n\\left.\\frac{\\partial u}{\\partial y}\\right|_{y\\text{-face}} \\approx \\frac{u_{i,J} - u_{i,J-1}}{h_y},\\qquad\n\\left.\\frac{\\partial u}{\\partial x}\\right|_{y\\text{-face}} \\approx \\frac{1}{2}\\left(\\left.\\frac{\\partial u}{\\partial x}\\right|_{i,j=J} + \\left.\\frac{\\partial u}{\\partial x}\\right|_{i,j=J-1}\\right),\n$$\nwhere the cell-centered $x$-derivative is approximated by the central difference\n$$\n\\left.\\frac{\\partial u}{\\partial x}\\right|_{i,j} \\approx \\frac{u_{i+1,j} - u_{i-1,j}}{2 h_x}.\n$$\nUsing these face-centered approximations, define rotated directional derivatives at faces as\n$$\n\\left.D_{\\mathbf{e}_1} u\\right|_{\\text{face}} \\approx (\\cos\\theta)\\,\\left.\\frac{\\partial u}{\\partial x}\\right|_{\\text{face}} + (\\sin\\theta)\\,\\left.\\frac{\\partial u}{\\partial y}\\right|_{\\text{face}},\n$$\n$$\n\\left.D_{\\mathbf{e}_2} u\\right|_{\\text{face}} \\approx (-\\sin\\theta)\\,\\left.\\frac{\\partial u}{\\partial x}\\right|_{\\text{face}} + (\\cos\\theta)\\,\\left.\\frac{\\partial u}{\\partial y}\\right|_{\\text{face}}.\n$$\n\nIn this problem, you must:\n- Derive the above discrete face-centered formulas starting from fundamental definitions of directional derivatives and Taylor expansions, ensuring they achieve second-order accuracy at the corresponding face locations.\n- Implement a program that, for a given periodic analytic scalar field\n$$\nu(x,y) = \\sin\\!\\left(\\frac{2\\pi m_x}{L_x}\\,x\\right)\\,\\cos\\!\\left(\\frac{2\\pi m_y}{L_y}\\,y\\right),\n$$\nevaluates the exact directional derivatives $D_{\\mathbf{e}_1} u$ and $D_{\\mathbf{e}_2} u$ at all face locations and compares them to the discrete rotated face-centered approximations. Use the analytic partial derivatives\n$$\n\\frac{\\partial u}{\\partial x}(x,y) = \\frac{2\\pi m_x}{L_x}\\,\\cos\\!\\left(\\frac{2\\pi m_x}{L_x}\\,x\\right)\\,\\cos\\!\\left(\\frac{2\\pi m_y}{L_y}\\,y\\right),\n$$\n$$\n\\frac{\\partial u}{\\partial y}(x,y) = -\\frac{2\\pi m_y}{L_y}\\,\\sin\\!\\left(\\frac{2\\pi m_x}{L_x}\\,x\\right)\\,\\sin\\!\\left(\\frac{2\\pi m_y}{L_y}\\,y\\right).\n$$\nCompute the maximum absolute pointwise error across all faces for both $\\left.D_{\\mathbf{e}_1} u\\right|_{\\text{face}}$ and $\\left.D_{\\mathbf{e}_2} u\\right|_{\\text{face}}$, and report, for each test case, the single float equal to the maximum of these two facewise maxima. Angles must be in radians. Express each reported error in $\\text{m}^{-1}$ (inverse meters), rounded by the default floating-point representation of the programming language.\n\nTest Suite:\n- Case $1$: $N_x=64$, $N_y=64$, $L_x=1.0$ $\\text{m}$, $L_y=1.0$ $\\text{m}$, $m_x=3$, $m_y=2$, $\\theta=0.0$ $\\text{rad}$.\n- Case $2$: $N_x=64$, $N_y=64$, $L_x=1.0$ $\\text{m}$, $L_y=1.0$ $\\text{m}$, $m_x=7$, $m_y=5$, $\\theta=\\pi/4$ $\\text{rad}$.\n- Case $3$: $N_x=32$, $N_y=48$, $L_x=2.0$ $\\text{m}$, $L_y=1.5$ $\\text{m}$, $m_x=4$, $m_y=1$, $\\theta=\\pi/3$ $\\text{rad}$.\n\nFinal Output Format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $\\left[\\text{result}_1,\\text{result}_2,\\text{result}_3\\right]$), where each $\\text{result}_k$ is the maximum absolute error in $\\text{m}^{-1}$ for the corresponding test case.", "solution": "The starting point is the definition of directional derivatives and the rotation of axes. For a scalar field $u(x,y)$, the gradient is $\\nabla u = \\left(\\tfrac{\\partial u}{\\partial x},\\tfrac{\\partial u}{\\partial y}\\right)$ and the directional derivative along a unit vector $\\mathbf{e}$ is $D_{\\mathbf{e}} u = \\nabla u \\cdot \\mathbf{e}$. If the basis $\\{\\mathbf{e}_1,\\mathbf{e}_2\\}$ is obtained by rotating the standard basis $\\{\\hat{\\mathbf{x}},\\hat{\\mathbf{y}}\\}$ by angle $\\theta$, then the rotation matrix is\n$$\n\\mathbf{R}(\\theta)=\\begin{pmatrix}\n\\cos\\theta & \\sin\\theta\\\\\n-\\sin\\theta & \\cos\\theta\n\\end{pmatrix},\n$$\nwhich maps vector components from the rotated basis to the original basis. The unit vectors are $\\mathbf{e}_1=(\\cos\\theta,\\sin\\theta)$ and $\\mathbf{e}_2=(-\\sin\\theta,\\cos\\theta)$. Therefore,\n$$\nD_{\\mathbf{e}_1}u = \\nabla u \\cdot \\mathbf{e}_1 = (\\cos\\theta)\\,\\frac{\\partial u}{\\partial x} + (\\sin\\theta)\\,\\frac{\\partial u}{\\partial y},\n$$\n$$\nD_{\\mathbf{e}_2}u = \\nabla u \\cdot \\mathbf{e}_2 = (-\\sin\\theta)\\,\\frac{\\partial u}{\\partial x} + (\\cos\\theta)\\,\\frac{\\partial u}{\\partial y}.\n$$\n\nOn a staggered grid, $u$ is stored at cell centers $\\left((i+\\tfrac{1}{2})h_x,(j+\\tfrac{1}{2})h_y\\right)$, while derivatives are evaluated at faces. To construct second-order accurate approximations at faces, we use Taylor series expansions. Consider an $x$-face located at $(x_f,y_f)=(I h_x,(j+\\tfrac{1}{2})h_y)$, with adjacent cell centers at $(x_f-\\tfrac{h_x}{2},y_f)$ and $(x_f+\\tfrac{h_x}{2},y_f)$. A Taylor expansion of $u$ about $(x_f,y_f)$ gives:\n$$\nu\\left(x_f+\\tfrac{h_x}{2},y_f\\right) = u(x_f,y_f) + \\tfrac{h_x}{2}\\left.\\frac{\\partial u}{\\partial x}\\right|_{(x_f,y_f)} + \\tfrac{h_x^2}{8}\\left.\\frac{\\partial^2 u}{\\partial x^2}\\right|_{(x_f,y_f)} + \\mathcal{O}(h_x^3),\n$$\n$$\nu\\left(x_f-\\tfrac{h_x}{2},y_f\\right) = u(x_f,y_f) - \\tfrac{h_x}{2}\\left.\\frac{\\partial u}{\\partial x}\\right|_{(x_f,y_f)} + \\tfrac{h_x^2}{8}\\left.\\frac{\\partial^2 u}{\\partial x^2}\\right|_{(x_f,y_f)} + \\mathcal{O}(h_x^3).\n$$\nSubtracting the two and dividing by $h_x$ yields\n$$\n\\frac{u\\left(x_f+\\tfrac{h_x}{2},y_f\\right) - u\\left(x_f-\\tfrac{h_x}{2},y_f\\right)}{h_x} = \\left.\\frac{\\partial u}{\\partial x}\\right|_{(x_f,y_f)} + \\mathcal{O}(h_x^2),\n$$\nwhich is the standard midpoint central difference yielding second-order accuracy. Identifying $u\\left(x_f+\\tfrac{h_x}{2},y_f\\right)$ with $u_{I,j}$ and $u\\left(x_f-\\tfrac{h_x}{2},y_f\\right)$ with $u_{I-1,j}$ gives\n$$\n\\left.\\frac{\\partial u}{\\partial x}\\right|_{x\\text{-face}} \\approx \\frac{u_{I,j} - u_{I-1,j}}{h_x}.\n$$\n\nFor $\\left.\\tfrac{\\partial u}{\\partial y}\\right|_{x\\text{-face}}$ at $(x_f,y_f)$, we cannot directly apply a central difference in $y$ because $u$ is stored only at cell centers offset in $x$. Instead, we approximate $\\left.\\tfrac{\\partial u}{\\partial y}\\right|_{(x_f,y_f)}$ by averaging the central differences in $y$ at the two adjacent cell centers. Letting $y_c=y_f$ and $x_{c,\\pm}=x_f\\pm\\tfrac{h_x}{2}$, we have second-order accurate approximations at each adjacent center:\n$$\n\\left.\\frac{\\partial u}{\\partial y}\\right|_{(x_{c,+},y_c)} \\approx \\frac{u(x_{c,+},y_c+\\tfrac{h_y}{2}) - u(x_{c,+},y_c-\\tfrac{h_y}{2})}{h_y},\n$$\n$$\n\\left.\\frac{\\partial u}{\\partial y}\\right|_{(x_{c,-},y_c)} \\approx \\frac{u(x_{c,-},y_c+\\tfrac{h_y}{2}) - u(x_{c,-},y_c-\\tfrac{h_y}{2})}{h_y}.\n$$\nA Taylor expansion in $x$ around $(x_f,y_f)$ shows that\n$$\n\\left.\\frac{\\partial u}{\\partial y}\\right|_{(x_{c,\\pm},y_c)} = \\left.\\frac{\\partial u}{\\partial y}\\right|_{(x_f,y_f)} \\pm \\tfrac{h_x}{2}\\left.\\frac{\\partial^2 u}{\\partial x\\,\\partial y}\\right|_{(x_f,y_f)} + \\mathcal{O}(h_x^2).\n$$\nAveraging the two cancels the first-order term and yields a second-order approximation:\n$$\n\\left.\\frac{\\partial u}{\\partial y}\\right|_{x\\text{-face}} \\approx \\frac{1}{2}\\left(\\left.\\frac{\\partial u}{\\partial y}\\right|_{(x_{c,+},y_c)} + \\left.\\frac{\\partial u}{\\partial y}\\right|_{(x_{c,-},y_c)}\\right) = \\left.\\frac{\\partial u}{\\partial y}\\right|_{(x_f,y_f)} + \\mathcal{O}(h_x^2 + h_y^2).\n$$\nIn discrete terms,\n$$\n\\left.\\frac{\\partial u}{\\partial y}\\right|_{x\\text{-face}} \\approx \\frac{1}{2}\\left(\\frac{u_{I,j+1} - u_{I,j-1}}{2 h_y} + \\frac{u_{I-1,j+1} - u_{I-1,j-1}}{2 h_y}\\right) = \\frac{(u_{I,j+1} - u_{I,j-1}) + (u_{I-1,j+1} - u_{I-1,j-1})}{4 h_y}.\n$$\n\nBy symmetry, at a $y$-face $(x_f,y_f)=((i+\\tfrac{1}{2})h_x,J h_y)$ we have\n$$\n\\left.\\frac{\\partial u}{\\partial y}\\right|_{y\\text{-face}} \\approx \\frac{u_{i,J} - u_{i,J-1}}{h_y},\n$$\nand we approximate $\\left.\\tfrac{\\partial u}{\\partial x}\\right|_{y\\text{-face}}$ by averaging the cell-centered $x$-derivative on the two adjacent cell centers above and below:\n$$\n\\left.\\frac{\\partial u}{\\partial x}\\right|_{y\\text{-face}} \\approx \\frac{1}{2}\\left(\\frac{u_{i+1,J} - u_{i-1,J}}{2 h_x} + \\frac{u_{i+1,J-1} - u_{i-1,J-1}}{2 h_x}\\right) = \\frac{(u_{i+1,J} - u_{i-1,J}) + (u_{i+1,J-1} - u_{i-1,J-1})}{4 h_x}.\n$$\nThese constructions are consistent with second-order accuracy because they use midpoint central differences and cancellation of odd-order error terms via averaging.\n\nThe rotated face-centered directional derivatives are then formed by linear combinations with $\\cos\\theta$ and $\\sin\\theta$, which preserves second-order accuracy because linear combinations of second-order accurate approximations remain second-order accurate.\n\nFor an analytic periodic field\n$$\nu(x,y) = \\sin\\!\\left(\\frac{2\\pi m_x}{L_x}\\,x\\right)\\,\\cos\\!\\left(\\frac{2\\pi m_y}{L_y}\\,y\\right),\n$$\nthe exact partial derivatives are\n$$\n\\frac{\\partial u}{\\partial x}(x,y) = \\frac{2\\pi m_x}{L_x}\\,\\cos\\!\\left(\\frac{2\\pi m_x}{L_x}\\,x\\right)\\,\\cos\\!\\left(\\frac{2\\pi m_y}{L_y}\\,y\\right),\n$$\n$$\n\\frac{\\partial u}{\\partial y}(x,y) = -\\frac{2\\pi m_y}{L_y}\\,\\sin\\!\\left(\\frac{2\\pi m_x}{L_x}\\,x\\right)\\,\\sin\\!\\left(\\frac{2\\pi m_y}{L_y}\\,y\\right),\n$$\nso the exact directional derivatives are\n$$\nD_{\\mathbf{e}_1} u(x,y) = (\\cos\\theta)\\,\\frac{2\\pi m_x}{L_x}\\,\\cos\\!\\left(\\frac{2\\pi m_x}{L_x}\\,x\\right)\\,\\cos\\!\\left(\\frac{2\\pi m_y}{L_y}\\,y\\right) - (\\sin\\theta)\\,\\frac{2\\pi m_y}{L_y}\\,\\sin\\!\\left(\\frac{2\\pi m_x}{L_x}\\,x\\right)\\,\\sin\\!\\left(\\frac{2\\pi m_y}{L_y}\\,y\\right),\n$$\n$$\nD_{\\mathbf{e}_2} u(x,y) = -(\\sin\\theta)\\,\\frac{2\\pi m_x}{L_x}\\,\\cos\\!\\left(\\frac{2\\pi m_x}{L_x}\\,x\\right)\\,\\cos\\!\\left(\\frac{2\\pi m_y}{L_y}\\,y\\right) - (\\cos\\theta)\\,\\frac{2\\pi m_y}{L_y}\\,\\sin\\!\\left(\\frac{2\\pi m_x}{L_x}\\,x\\right)\\,\\sin\\!\\left(\\frac{2\\pi m_y}{L_y}\\,y\\right).\n$$\n\nAlgorithmic design:\n- Construct the cell-centered coordinate arrays and evaluate $u_{i,j}$.\n- Compute cell-centered central differences for $\\left.\\tfrac{\\partial u}{\\partial x}\\right|_{i,j}$ and $\\left.\\tfrac{\\partial u}{\\partial y}\\right|_{i,j}$ via periodic rolls.\n- Form face-centered derivatives using the above averaging formulas:\n  - At $x$-faces: $\\left.\\tfrac{\\partial u}{\\partial x}\\right|_{x\\text{-face}}$ via a midpoint difference of adjacent cell centers; $\\left.\\tfrac{\\partial u}{\\partial y}\\right|_{x\\text{-face}}$ via averaging of cell-centered $y$-derivatives at the adjacent centers.\n  - At $y$-faces: $\\left.\\tfrac{\\partial u}{\\partial y}\\right|_{y\\text{-face}}$ via a midpoint difference of adjacent cell centers; $\\left.\\tfrac{\\partial u}{\\partial x}\\right|_{y\\text{-face}}$ via averaging of cell-centered $x$-derivatives at the adjacent centers.\n- Combine to obtain discrete $\\left.D_{\\mathbf{e}_1} u\\right|_{\\text{face}}$ and $\\left.D_{\\mathbf{e}_2} u\\right|_{\\text{face}}$.\n- Evaluate exact $D_{\\mathbf{e}_1} u$ and $D_{\\mathbf{e}_2} u$ at the corresponding face coordinates.\n- Compute the pointwise absolute errors, take the maxima over all $x$-faces and $y$-faces for each rotated direction, and report the single float equal to the maximum across both directions. This float has units $\\text{m}^{-1}$ because $u$ is dimensionless and derivatives scale as inverse length.\n\nThe test suite explores:\n- A baseline rotation $\\theta=0$ $\\text{rad}$ and moderate wavenumbers ($m_x=3$, $m_y=2$) on an isotropic grid ($N_x=N_y=64$, $L_x=L_y=1.0$ $\\text{m}$).\n- A nontrivial rotation $\\theta=\\pi/4$ $\\text{rad}$ with higher wavenumbers ($m_x=7$, $m_y=5$), testing dispersion sensitivity on the same grid.\n- An anisotropic grid ($N_x=32$, $N_y=48$, $L_x=2.0$ $\\text{m}$, $L_y=1.5$ $\\text{m}$) and rotation $\\theta=\\pi/3$ $\\text{rad}$ with ($m_x=4$, $m_y=1$), testing accuracy under non-square cells.\n\nThe program outputs a single line containing the three maximum absolute errors in $\\text{m}^{-1}$ for the three cases, in the specified bracketed comma-separated format.", "answer": "```python\nimport numpy as np\n\ndef rotated_face_errors(Nx, Ny, Lx, Ly, mx, my, theta):\n    # Grid spacings\n    hx = Lx / Nx\n    hy = Ly / Ny\n\n    # Cell-centered coordinates\n    x_c = (np.arange(Nx) + 0.5) * hx\n    y_c = (np.arange(Ny) + 0.5) * hy\n    Xc, Yc = np.meshgrid(x_c, y_c, indexing='ij')\n\n    # Scalar field u at cell centers\n    kx = 2 * np.pi * mx / Lx\n    ky = 2 * np.pi * my / Ly\n    u = np.sin(kx * Xc) * np.cos(ky * Yc)\n\n    # Cell-centered central derivatives\n    # dudx at cell centers\n    u_ip = np.roll(u, -1, axis=0)\n    u_im = np.roll(u, 1, axis=0)\n    dudx_cc = (u_ip - u_im) / (2 * hx)\n    # dudy at cell centers\n    u_jp = np.roll(u, -1, axis=1)\n    u_jm = np.roll(u, 1, axis=1)\n    dudy_cc = (u_jp - u_jm) / (2 * hy)\n\n    # Face-centered derivatives at x-faces (shape Nx x Ny)\n    # x-face locations: (I*hx, (j+0.5)*hy)\n    # dudx at x-faces: midpoint difference of adjacent cell centers\n    dudx_xf = (u - np.roll(u, 1, axis=0)) / hx\n    # dudy at x-faces: average of cell-centered dudy at i and i-1\n    dudy_xf = 0.5 * (dudy_cc + np.roll(dudy_cc, 1, axis=0))\n\n    # Face-centered derivatives at y-faces (shape Nx x Ny)\n    # y-face locations: ((i+0.5)*hx, J*hy)\n    # dudy at y-faces: midpoint difference of adjacent cell centers\n    dudy_yf = (u - np.roll(u, 1, axis=1)) / hy\n    # dudx at y-faces: average of cell-centered dudx at j and j-1\n    dudx_yf = 0.5 * (dudx_cc + np.roll(dudx_cc, 1, axis=1))\n\n    # Rotated directional derivatives at faces: discrete approximations\n    cth = np.cos(theta)\n    sth = np.sin(theta)\n    # D_e1 at faces\n    De1_xf = cth * dudx_xf + sth * dudy_xf\n    De1_yf = cth * dudx_yf + sth * dudy_yf\n    # D_e2 at faces\n    De2_xf = -sth * dudx_xf + cth * dudy_xf\n    De2_yf = -sth * dudx_yf + cth * dudy_yf\n\n    # Exact derivatives at face coordinates\n    # x-face coordinates\n    Xx = (np.arange(Nx)) * hx\n    Yx = (np.arange(Ny) + 0.5) * hy\n    Xxg, Yxg = np.meshgrid(Xx, Yx, indexing='ij')\n    # y-face coordinates\n    Xy = (np.arange(Nx) + 0.5) * hx\n    Yy = (np.arange(Ny)) * hy\n    Xyg, Yyg = np.meshgrid(Xy, Yy, indexing='ij')\n\n    # Exact partials\n    dudx_exact_xf = (kx) * np.cos(kx * Xxg) * np.cos(ky * Yxg)\n    dudy_exact_xf = -(ky) * np.sin(kx * Xxg) * np.sin(ky * Yxg)\n\n    dudx_exact_yf = (kx) * np.cos(kx * Xyg) * np.cos(ky * Yyg)\n    dudy_exact_yf = -(ky) * np.sin(kx * Xyg) * np.sin(ky * Yyg)\n\n    # Exact rotated directional derivatives at faces\n    De1_exact_xf = cth * dudx_exact_xf + sth * dudy_exact_xf\n    De1_exact_yf = cth * dudx_exact_yf + sth * dudy_exact_yf\n\n    De2_exact_xf = -sth * dudx_exact_xf + cth * dudy_exact_xf\n    De2_exact_yf = -sth * dudx_exact_yf + cth * dudy_exact_yf\n\n    # Errors\n    err_De1_xf = np.abs(De1_xf - De1_exact_xf)\n    err_De1_yf = np.abs(De1_yf - De1_exact_yf)\n    err_De2_xf = np.abs(De2_xf - De2_exact_xf)\n    err_De2_yf = np.abs(De2_yf - De2_exact_yf)\n\n    # Max errors across all faces\n    max_err_De1 = max(err_De1_xf.max(), err_De1_yf.max())\n    max_err_De2 = max(err_De2_xf.max(), err_De2_yf.max())\n\n    # Report the maximum across both rotated directions, in 1/m\n    return float(max(max_err_De1, max_err_De2))\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each case: (Nx, Ny, Lx [m], Ly [m], mx, my, theta [rad])\n    test_cases = [\n        (64, 64, 1.0, 1.0, 3, 2, 0.0),\n        (64, 64, 1.0, 1.0, 7, 5, np.pi/4),\n        (32, 48, 2.0, 1.5, 4, 1, np.pi/3),\n    ]\n\n    results = []\n    for case in test_cases:\n        Nx, Ny, Lx, Ly, mx, my, theta = case\n        result = rotated_face_errors(Nx, Ny, Lx, Ly, mx, my, theta)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3613900"}, {"introduction": "A numerical scheme's behavior is encoded in its discrete dispersion relation, which links a wave's frequency to its wavenumber. Deriving this relation is a crucial skill for understanding and predicting numerical artifacts like dispersion and anisotropy. This exercise guides you through a plane-wave analysis to find the dispersion relation for a rotated staggered-grid Finite-Difference Time-Domain (FDTD) scheme, uncovering a key property that makes this approach advantageous for wave propagation modeling. [@problem_id:3613907]", "problem": "Consider a two-dimensional homogeneous, isotropic acoustic medium with constant density $\\rho$ and constant sound speed $c$. The acoustic field is governed by the first-order velocity-pressure formulation of the acoustic wave equation,\n$$\n\\partial_{t} p = -\\kappa \\nabla \\cdot \\mathbf{v}, \\qquad \\partial_{t} \\mathbf{v} = -\\frac{1}{\\rho} \\nabla p,\n$$\nwhere $p$ is pressure, $\\mathbf{v}$ is particle velocity, and $\\kappa = \\rho c^{2}$ is the bulk modulus. The domain is discretized on a uniform Cartesian grid with spacing $h$ in both $x$ and $y$, but the finite-difference operators are constructed in a rotated staggered-grid fashion: define orthonormal axes $\\mathbf{e}_{u}$ and $\\mathbf{e}_{v}$ obtained by rotating the Cartesian axes by an angle $\\alpha$, with\n$$\n\\mathbf{e}_{u} = (\\cos \\alpha, \\sin \\alpha), \\qquad \\mathbf{e}_{v} = (-\\sin \\alpha, \\cos \\alpha).\n$$\nLet $v_{u} = \\mathbf{v} \\cdot \\mathbf{e}_{u}$ and $v_{v} = \\mathbf{v} \\cdot \\mathbf{e}_{v}$. Use a standard second-order staggered-in-time and staggered-in-space Finite-Difference Time-Domain (FDTD) scheme: $p$ is located at cell centers at integer times $t^{n} = n \\Delta t$, and $v_{u}, v_{v}$ are located at appropriately staggered spatial positions and at half-integer times $t^{n+\\frac{1}{2}} = (n+\\frac{1}{2}) \\Delta t$. Spatial derivatives are approximated by centered differences consistent with the staggered layout. Denote the discrete directional derivative operators along $x$ and $y$ by $D_{x}$ and $D_{y}$, and define the rotated directional derivatives\n$$\nD_{u} = \\cos \\alpha \\, D_{x} + \\sin \\alpha \\, D_{y}, \\qquad D_{v} = -\\sin \\alpha \\, D_{x} + \\cos \\alpha \\, D_{y}.\n$$\nThe discrete update equations are\n$$\nv_{u}^{\\,n+\\frac{1}{2}} = v_{u}^{\\,n-\\frac{1}{2}} - \\frac{\\Delta t}{\\rho} \\, D_{u} p^{\\,n}, \\qquad\nv_{v}^{\\,n+\\frac{1}{2}} = v_{v}^{\\,n-\\frac{1}{2}} - \\frac{\\Delta t}{\\rho} \\, D_{v} p^{\\,n},\n$$\n$$\np^{\\,n+1} = p^{\\,n} - \\kappa \\Delta t \\left( D_{u} v_{u}^{\\,n+\\frac{1}{2}} + D_{v} v_{v}^{\\,n+\\frac{1}{2}} \\right).\n$$\nFor plane-wave analysis on the staggered grid, the centered difference acting between staggered locations has the well-tested discrete Fourier symbol: for a plane wave with wavenumber components $k_{x}$ and $k_{y}$,\n$$\nD_{x} \\;\\longleftrightarrow\\; i \\,\\hat{k}_{x}, \\quad \\hat{k}_{x} = \\frac{2}{h} \\sin\\!\\left(\\frac{k_{x} h}{2}\\right), \\qquad\nD_{y} \\;\\longleftrightarrow\\; i \\,\\hat{k}_{y}, \\quad \\hat{k}_{y} = \\frac{2}{h} \\sin\\!\\left(\\frac{k_{y} h}{2}\\right).\n$$\nAssume a monochromatic plane wave of the form $p(\\mathbf{x},t) = P \\exp\\!\\left( i (k_{x} x + k_{y} y - \\omega t) \\right)$, with propagation angle $\\theta$ defined by $k_{x} = k \\cos \\theta$ and $k_{y} = k \\sin \\theta$. Starting from the governing equations and the discrete scheme specified above, derive the exact discrete dispersion relation and solve it to obtain the numerical angular frequency $\\omega$ as an analytic function of $k$, $\\theta$, $c$, $h$, and $\\Delta t$ (keep $\\alpha$ symbolic and do not assume a particular rotation). Express the final answer for $\\omega$ in radians per second. The angle $\\theta$ must be treated in radians. Provide your final expression in closed form. No numerical evaluation is required, and no rounding is needed.", "solution": "The user wants me to derive the discrete dispersion relation for an acoustic wave equation solved using a Rotated Staggered-Grid Finite-Difference Time-Domain (FDTD) scheme.\n\n### Step 1: Extract Givens\n- **Governing Equations**:\n  $$ \\partial_{t} p = -\\kappa \\nabla \\cdot \\mathbf{v}, \\qquad \\partial_{t} \\mathbf{v} = -\\frac{1}{\\rho} \\nabla p $$\n- **Constants and Definitions**:\n  - Pressure: $p$\n  - Particle velocity: $\\mathbf{v} = (v_x, v_y)$\n  - Density (constant): $\\rho$\n  - Sound speed (constant): $c$\n  - Bulk modulus: $\\kappa = \\rho c^2$\n- **Grid and Discretization**:\n  - Uniform Cartesian grid with spacing $h$ in both $x$ and $y$.\n  - Time step: $\\Delta t$.\n  - Rotated orthonormal axes: $\\mathbf{e}_{u} = (\\cos \\alpha, \\sin \\alpha)$, $\\mathbf{e}_{v} = (-\\sin \\alpha, \\cos \\alpha)$\n  - Rotated velocity components: $v_{u} = \\mathbf{v} \\cdot \\mathbf{e}_{u}$, $v_{v} = \\mathbf{v} \\cdot \\mathbf{e}_{v}$\n  - Staggering: $p$ is at cell centers $(x_j, y_l)$ at integer times $t^n = n \\Delta t$. $v_u, v_v$ are at staggered spatial positions and half-integer times $t^{n+1/2} = (n+1/2)\\Delta t$.\n- **Discrete Operators**:\n  - Rotated directional derivative operators:\n    $$ D_{u} = \\cos \\alpha \\, D_{x} + \\sin \\alpha \\, D_{y} $$\n    $$ D_{v} = -\\sin \\alpha \\, D_{x} + \\cos \\alpha \\, D_{y} $$\n- **Discrete Update Equations**:\n  $$ v_{u}^{\\,n+\\frac{1}{2}} = v_{u}^{\\,n-\\frac{1}{2}} - \\frac{\\Delta t}{\\rho} \\, D_{u} p^{\\,n} $$\n  $$ v_{v}^{\\,n+\\frac{1}{2}} = v_{v}^{\\,n-\\frac{1}{2}} - \\frac{\\Delta t}{\\rho} \\, D_{v} p^{\\,n} $$\n  $$ p^{\\,n+1} = p^{\\,n} - \\kappa \\Delta t \\left( D_{u} v_{u}^{\\,n+\\frac{1}{2}} + D_{v} v_{v}^{\\,n+\\frac{1}{2}} \\right) $$\n- **Fourier Symbols for Derivatives**:\n  - For a centered difference between staggered locations:\n    $$ D_{x} \\;\\longleftrightarrow\\; i \\,\\hat{k}_{x}, \\quad \\hat{k}_{x} = \\frac{2}{h} \\sin\\left(\\frac{k_{x} h}{2}\\right) $$\n    $$ D_{y} \\;\\longleftrightarrow\\; i \\,\\hat{k}_{y}, \\quad \\hat{k}_{y} = \\frac{2}{h} \\sin\\left(\\frac{k_{y} h}{2}\\right) $$\n- **Plane-Wave Ansatz**:\n  - Form: $p(\\mathbf{x}, t) = P \\exp(i (k_x x + k_y y - \\omega t))$\n  - Wavenumber vector components: $k_x = k \\cos\\theta$, $k_y = k \\sin\\theta$\n\n### Step 2: Validate Using Extracted Givens\n- **Scientifically Grounded (Critical)**: The problem is based on the first-order acoustic wave equation, a fundamental model in physics and geophysics. The numerical method described, a Rotated Staggered-Grid FDTD scheme, is a well-established technique in computational seismology. The method of analysis (plane-wave analysis or von Neumann analysis) is the standard procedure for deriving numerical dispersion relations. All aspects are scientifically sound.\n- **Well-Posed**: The problem is clearly structured. It provides all necessary equations, definitions, and discrete operators to derive the required expression for the numerical frequency $\\omega$. A unique analytical solution is expected.\n- **Objective (Critical)**: The problem is stated in precise, formal mathematical and physical language, free of any subjectivity or ambiguity.\n- **Other Flaws**: The problem is self-contained, consistent, and formalizable. It is not trivial and does not exhibit any of the other invalidity criteria.\n\n### Step 3: Verdict and Action\nThe problem is valid. A complete solution will be provided.\n\n### Solution Derivation\nThe goal is to find the numerical dispersion relation, which connects the angular frequency $\\omega$ to the wavenumber components $k_x$ and $k_y$ for the given numerical scheme. We achieve this by substituting a plane-wave solution into the discrete FDTD equations.\n\nLet the discrete plane-wave solutions for pressure $p$ and the rotated velocity components $v_u$ and $v_v$ be of the form:\n$$ p^n \\propto P \\, \\exp(-i \\omega n \\Delta t) $$\n$$ v_u^{n \\pm 1/2} \\propto V_u \\, \\exp(-i \\omega (n \\pm 1/2) \\Delta t) $$\n$$ v_v^{n \\pm 1/2} \\propto V_v \\, \\exp(-i \\omega (n \\pm 1/2) \\Delta t) $$\nHere, $P$, $V_u$, and $V_v$ are the complex amplitudes, which implicitly contain the spatial phase factor $\\exp(i(k_x x + k_y y))$. The spatial derivative operators $D_x$ and $D_y$ acting on these plane waves transform into multiplications by their Fourier symbols $i\\hat{k}_x$ and $i\\hat{k}_y$, respectively.\n\nFirst, we determine the Fourier symbols for the rotated derivative operators $D_u$ and $D_v$:\n$$ D_u \\longleftrightarrow i \\hat{k}_u = \\cos \\alpha (i \\hat{k}_x) + \\sin \\alpha (i \\hat{k}_y) = i (\\hat{k}_x \\cos \\alpha + \\hat{k}_y \\sin \\alpha) $$\n$$ D_v \\longleftrightarrow i \\hat{k}_v = -\\sin \\alpha (i \\hat{k}_x) + \\cos \\alpha (i \\hat{k}_y) = i (-\\hat{k}_x \\sin \\alpha + \\hat{k}_y \\cos \\alpha) $$\n\nNow, substitute the plane-wave forms into the discrete update equations. Let's rewrite the update equations using central differences in time for clarity:\n$$ \\frac{v_u^{n+1/2} - v_u^{n-1/2}}{\\Delta t} = -\\frac{1}{\\rho} D_u p^n $$\n$$ \\frac{v_v^{n+1/2} - v_v^{n-1/2}}{\\Delta t} = -\\frac{1}{\\rho} D_v p^n $$\n$$ \\frac{p^{n+1} - p^n}{\\Delta t} = -\\kappa (D_u v_u^{n+1/2} + D_v v_v^{n+1/2}) $$\n\nSubstituting the plane-wave ansatz and the operator symbols into the first equation (for $v_u$):\n$$ \\frac{V_u e^{-i\\omega(n+1/2)\\Delta t} - V_u e^{-i\\omega(n-1/2)\\Delta t}}{\\Delta t} = -\\frac{1}{\\rho} (i \\hat{k}_u) P e^{-i\\omega n \\Delta t} $$\nFactoring out common terms:\n$$ \\frac{V_u e^{-i\\omega n \\Delta t} (e^{-i\\omega \\Delta t/2} - e^{i\\omega \\Delta t/2})}{\\Delta t} = - \\frac{i}{\\rho} \\hat{k}_u P e^{-i\\omega n \\Delta t} $$\nUsing the identity $\\sin(z) = \\frac{e^{iz} - e^{-iz}}{2i}$:\n$$ \\frac{V_u (-2i \\sin(\\frac{\\omega \\Delta t}{2}))}{\\Delta t} = -\\frac{i}{\\rho} \\hat{k}_u P $$\nSolving for the amplitude $V_u$:\n$$ V_u = \\frac{\\Delta t \\hat{k}_u}{2 \\rho \\sin(\\frac{\\omega \\Delta t}{2})} P $$\nBy an identical derivation, the equation for $v_v$ yields:\n$$ V_v = \\frac{\\Delta t \\hat{k}_v}{2 \\rho \\sin(\\frac{\\omega \\Delta t}{2})} P $$\n\nNext, substitute the ansatz into the pressure update equation:\n$$ \\frac{P e^{-i\\omega(n+1)\\Delta t} - P e^{-i\\omega n \\Delta t}}{\\Delta t} = -\\kappa \\left( (i \\hat{k}_u) V_u e^{-i\\omega(n+1/2)\\Delta t} + (i \\hat{k}_v) V_v e^{-i\\omega(n+1/2)\\Delta t} \\right) $$\nFactor out common terms:\n$$ \\frac{P e^{-i\\omega(n+1/2)\\Delta t} (e^{-i\\omega \\Delta t/2} - e^{i\\omega \\Delta t/2})}{\\Delta t} = -i \\kappa (\\hat{k}_u V_u + \\hat{k}_v V_v) e^{-i\\omega(n+1/2)\\Delta t} $$\n$$ \\frac{P (-2i \\sin(\\frac{\\omega \\Delta t}{2}))}{\\Delta t} = -i \\kappa (\\hat{k}_u V_u + \\hat{k}_v V_v) $$\n$$ 2P \\sin\\left(\\frac{\\omega \\Delta t}{2}\\right) = \\kappa \\Delta t (\\hat{k}_u V_u + \\hat{k}_v V_v) $$\n\nNow, substitute the expressions for $V_u$ and $V_v$ into this equation:\n$$ 2P \\sin\\left(\\frac{\\omega \\Delta t}{2}\\right) = \\kappa \\Delta t \\left( \\hat{k}_u \\left( \\frac{\\Delta t \\hat{k}_u}{2 \\rho \\sin(\\frac{\\omega \\Delta t}{2})} P \\right) + \\hat{k}_v \\left( \\frac{\\Delta t \\hat{k}_v}{2 \\rho \\sin(\\frac{\\omega \\Delta t}{2})} P \\right) \\right) $$\nAssuming a non-trivial wave ($P \\neq 0$), we can cancel $P$ from both sides:\n$$ 2 \\sin\\left(\\frac{\\omega \\Delta t}{2}\\right) = \\frac{\\kappa (\\Delta t)^2}{2 \\rho \\sin(\\frac{\\omega \\Delta t}{2})} (\\hat{k}_u^2 + \\hat{k}_v^2) $$\nRearranging gives the dispersion relation:\n$$ 4 \\sin^2\\left(\\frac{\\omega \\Delta t}{2}\\right) = \\frac{\\kappa (\\Delta t)^2}{\\rho} (\\hat{k}_u^2 + \\hat{k}_v^2) $$\nUsing the definition $\\kappa = \\rho c^2$, this simplifies to:\n$$ 4 \\sin^2\\left(\\frac{\\omega \\Delta t}{2}\\right) = c^2 (\\Delta t)^2 (\\hat{k}_u^2 + \\hat{k}_v^2) $$\n\nAn important step is to evaluate the term $\\hat{k}_u^2 + \\hat{k}_v^2$:\n$$ \\hat{k}_u^2 = (\\hat{k}_x \\cos \\alpha + \\hat{k}_y \\sin \\alpha)^2 = \\hat{k}_x^2 \\cos^2 \\alpha + \\hat{k}_y^2 \\sin^2 \\alpha + 2 \\hat{k}_x \\hat{k}_y \\cos \\alpha \\sin \\alpha $$\n$$ \\hat{k}_v^2 = (-\\hat{k}_x \\sin \\alpha + \\hat{k}_y \\cos \\alpha)^2 = \\hat{k}_x^2 \\sin^2 \\alpha + \\hat{k}_y^2 \\cos^2 \\alpha - 2 \\hat{k}_x \\hat{k}_y \\sin \\alpha \\cos \\alpha $$\nSumming these two expressions, we see that the cross-terms cancel:\n$$ \\hat{k}_u^2 + \\hat{k}_v^2 = \\hat{k}_x^2 (\\cos^2 \\alpha + \\sin^2 \\alpha) + \\hat{k}_y^2 (\\sin^2 \\alpha + \\cos^2 \\alpha) = \\hat{k}_x^2 + \\hat{k}_y^2 $$\nThis result demonstrates that the effective squared wavenumber for this numerical scheme is invariant under the rotation of the velocity components, a key feature of this specific rotated staggered grid. The rotation angle $\\alpha$ thus drops out of the dispersion relation.\n\nSubstituting this back into the dispersion relation:\n$$ 4 \\sin^2\\left(\\frac{\\omega \\Delta t}{2}\\right) = c^2 (\\Delta t)^2 (\\hat{k}_x^2 + \\hat{k}_y^2) $$\nNow, insert the definitions of $\\hat{k}_x$ and $\\hat{k}_y$:\n$$ \\hat{k}_x^2 + \\hat{k}_y^2 = \\left(\\frac{2}{h} \\sin\\left(\\frac{k_x h}{2}\\right)\\right)^2 + \\left(\\frac{2}{h} \\sin\\left(\\frac{k_y h}{2}\\right)\\right)^2 = \\frac{4}{h^2} \\left[ \\sin^2\\left(\\frac{k_x h}{2}\\right) + \\sin^2\\left(\\frac{k_y h}{2}\\right) \\right] $$\nThe dispersion relation becomes:\n$$ 4 \\sin^2\\left(\\frac{\\omega \\Delta t}{2}\\right) = c^2 (\\Delta t)^2 \\left( \\frac{4}{h^2} \\left[ \\sin^2\\left(\\frac{k_x h}{2}\\right) + \\sin^2\\left(\\frac{k_y h}{2}\\right) \\right] \\right) $$\n$$ \\sin^2\\left(\\frac{\\omega \\Delta t}{2}\\right) = \\frac{c^2 (\\Delta t)^2}{h^2} \\left[ \\sin^2\\left(\\frac{k_x h}{2}\\right) + \\sin^2\\left(\\frac{k_y h}{2}\\right) \\right] $$\nTaking the square root of both sides (and choosing the positive root corresponding to forward-propagating waves, $\\omega > 0$):\n$$ \\sin\\left(\\frac{\\omega \\Delta t}{2}\\right) = \\frac{c \\Delta t}{h} \\sqrt{ \\sin^2\\left(\\frac{k_x h}{2}\\right) + \\sin^2\\left(\\frac{k_y h}{2}\\right) } $$\nSolving for $\\omega$ by applying the arcsin function:\n$$ \\frac{\\omega \\Delta t}{2} = \\arcsin\\left( \\frac{c \\Delta t}{h} \\sqrt{ \\sin^2\\left(\\frac{k_x h}{2}\\right) + \\sin^2\\left(\\frac{k_y h}{2}\\right) } \\right) $$\n$$ \\omega = \\frac{2}{\\Delta t} \\arcsin\\left( \\frac{c \\Delta t}{h} \\sqrt{ \\sin^2\\left(\\frac{k_x h}{2}\\right) + \\sin^2\\left(\\frac{k_y h}{2}\\right) } \\right) $$\n\nFinally, we express the result in terms of the total wavenumber $k$ and propagation angle $\\theta$, using $k_x = k \\cos\\theta$ and $k_y = k \\sin\\theta$:\n$$ \\omega = \\frac{2}{\\Delta t} \\arcsin\\left( \\frac{c \\Delta t}{h} \\sqrt{ \\sin^2\\left(\\frac{k h \\cos\\theta}{2}\\right) + \\sin^2\\left(\\frac{k h \\sin\\theta}{2}\\right) } \\right) $$\nThis is the final analytical expression for the numerical angular frequency.", "answer": "$$\\boxed{\\frac{2}{\\Delta t} \\arcsin\\left( \\frac{c \\Delta t}{h} \\sqrt{ \\sin^2\\left(\\frac{k h \\cos\\theta}{2}\\right) + \\sin^2\\left(\\frac{k h \\sin\\theta}{2}\\right) } \\right)}$$", "id": "3613907"}, {"introduction": "Moving beyond forward simulation, many geophysical applications involve inverse problems, such as estimating Earth's subsurface properties from recorded data. Gradient-based inversion methods rely on the adjoint-state method, which requires the adjoint of the forward modeling operator. This practice provides a concrete introduction to this advanced concept by guiding you through the derivation of a discrete adjoint operator and its verification via the dot-product test, a cornerstone of reliable inverse modeling codes. [@problem_id:3613858]", "problem": "Consider the two-dimensional first-order linear acoustics system in rotated coordinates with angle $\\theta=\\pi/4$ (angles in radians). Let the rotated unit directions be $\\mathbf{e}_{s_1}=(\\mathbf{e}_x+\\mathbf{e}_y)/\\sqrt{2}$ and $\\mathbf{e}_{s_2}=(\\mathbf{e}_x-\\mathbf{e}_y)/\\sqrt{2}$. The continuum equations are\n$$\n\\partial_t p \\;=\\; -\\kappa\\left(\\partial_{s_1} v_1 + \\partial_{s_2} v_2\\right),\\qquad\n\\partial_t v_1 \\;=\\; -\\frac{1}{\\rho}\\,\\partial_{s_1} p,\\qquad\n\\partial_t v_2 \\;=\\; -\\frac{1}{\\rho}\\,\\partial_{s_2} p,\n$$\nwhere $p$ is pressure, $v_1$ and $v_2$ are the velocity components along $s_1$ and $s_2$, respectively, and $\\kappa$ is the bulk modulus while $\\rho$ is the density.\n\nDiscretize this system on a rotated staggered grid with spatial steps $\\Delta x=\\Delta y=1$ and periodic boundary conditions on a $2\\times 2$ cell domain. Place $p_{i,j}$ at cell centers $(i,j)\\in\\{0,1\\}\\times\\{0,1\\}$, $v_1$ at diagonal-edge locations $(i+\\tfrac{1}{2},j+\\tfrac{1}{2})$ indexed by $(i,j)\\in\\{0,1\\}^2$, and $v_2$ at anti-diagonal-edge locations $(i+\\tfrac{1}{2},j-\\tfrac{1}{2})$ indexed by $(i,j)\\in\\{0,1\\}^2$. Define the discrete directional derivatives by\n$$\n\\left[\\partial_{s_1} p\\right]_{i+\\frac{1}{2},\\,j+\\frac{1}{2}} \\;=\\; \\frac{p_{i+1,\\,j+1}-p_{i,\\,j}}{\\sqrt{2}},\\qquad\n\\left[\\partial_{s_2} p\\right]_{i+\\frac{1}{2},\\,j-\\frac{1}{2}} \\;=\\; \\frac{p_{i+1,\\,j}-p_{i,\\,j-1}}{\\sqrt{2}},\n$$\nand the discrete divergences by\n$$\n\\left[\\partial_{s_1} v_1\\right]_{i,\\,j} \\;=\\; \\frac{v_{1,\\,i+\\frac{1}{2},\\,j+\\frac{1}{2}}-v_{1,\\,i-\\frac{1}{2},\\,j-\\frac{1}{2}}}{\\sqrt{2}},\\qquad\n\\left[\\partial_{s_2} v_2\\right]_{i,\\,j} \\;=\\; \\frac{v_{2,\\,i+\\frac{1}{2},\\,j-\\frac{1}{2}}-v_{2,\\,i-\\frac{1}{2},\\,j+\\frac{1}{2}}}{\\sqrt{2}},\n$$\nwith all indices understood modulo $2$ to enforce periodicity.\n\nDefine the linear spatial operator (propagator) $\\mathcal{L}$ acting on the state vector $\\mathbf{u}=[p,\\;v_1,\\;v_2]$ by\n$$\n\\left[\\mathcal{L}\\,\\mathbf{u}\\right]_p \\;=\\; \\kappa\\left(\\partial_{s_1} v_1 + \\partial_{s_2} v_2\\right),\\qquad\n\\left[\\mathcal{L}\\,\\mathbf{u}\\right]_{v_1} \\;=\\; \\frac{1}{\\rho}\\,\\partial_{s_1} p,\\qquad\n\\left[\\mathcal{L}\\,\\mathbf{u}\\right]_{v_2} \\;=\\; \\frac{1}{\\rho}\\,\\partial_{s_2} p.\n$$\n\nUse the discrete inner product\n$$\n\\langle \\mathbf{a},\\mathbf{b}\\rangle \\;=\\; \\sum_{i,j} a_{p,\\,i,j}\\,b_{p,\\,i,j}\n\\;+\\; \\sum_{i,j} a_{v_1,\\,i,j}\\,b_{v_1,\\,i,j}\n\\;+\\; \\sum_{i,j} a_{v_2,\\,i,j}\\,b_{v_2,\\,i,j},\n$$\nwhere the sums run over $(i,j)\\in\\{0,1\\}^2$, and set the physical parameters to $\\rho=1$ and $\\kappa=2$.\n\n1) Starting from the above discrete definitions and the fundamental property of adjoints with respect to an inner product, derive the explicit discrete adjoint operator $\\mathcal{L}^\\dagger$ such that $\\langle \\mathbf{a}, \\mathcal{L}\\,\\mathbf{b}\\rangle = \\langle \\mathcal{L}^\\dagger \\mathbf{a}, \\mathbf{b}\\rangle$ holds for all $\\mathbf{a}$ and $\\mathbf{b}$.\n\n2) Using your derived $\\mathcal{L}^\\dagger$, perform a gradient check by evaluating both $\\langle \\mathbf{a}, \\mathcal{L}\\,\\mathbf{b}\\rangle$ and $\\langle \\mathcal{L}^\\dagger \\mathbf{a}, \\mathbf{b}\\rangle$ for the following specific fields:\n- For $\\mathbf{b}$:\n  - $p^{(b)}_{0,0}=1$, $p^{(b)}_{1,0}=2$, $p^{(b)}_{0,1}=0$, $p^{(b)}_{1,1}=-1$.\n  - $v^{(b)}_{1,\\,0,0}=1$, $v^{(b)}_{1,\\,1,0}=0$, $v^{(b)}_{1,\\,0,1}=2$, $v^{(b)}_{1,\\,1,1}=-1$.\n  - $v^{(b)}_{2,\\,0,0}=3$, $v^{(b)}_{2,\\,1,0}=-2$, $v^{(b)}_{2,\\,0,1}=0$, $v^{(b)}_{2,\\,1,1}=1$.\n- For $\\mathbf{a}$:\n  - $p^{(a)}_{0,0}=0$, $p^{(a)}_{1,0}=1$, $p^{(a)}_{0,1}=-2$, $p^{(a)}_{1,1}=3$.\n  - $v^{(a)}_{1,\\,0,0}=2$, $v^{(a)}_{1,\\,1,0}=-1$, $v^{(a)}_{1,\\,0,1}=1$, $v^{(a)}_{1,\\,1,1}=0$.\n  - $v^{(a)}_{2,\\,0,0}=0$, $v^{(a)}_{2,\\,1,0}=1$, $v^{(a)}_{2,\\,0,1}=-1$, $v^{(a)}_{2,\\,1,1}=2$.\n\nExpress your final scalar value as an exact analytical expression. No rounding is required and no physical units are involved.", "solution": "The problem is divided into two parts: first, to derive the discrete adjoint operator $\\mathcal{L}^\\dagger$ for a given linear operator $\\mathcal{L}$ and a specified inner product; and second, to perform a numerical gradient check using specific fields $\\mathbf{a}$ and $\\mathbf{b}$.\n\n### Part 1: Derivation of the Adjoint Operator $\\mathcal{L}^\\dagger$\n\nThe adjoint operator $\\mathcal{L}^\\dagger$ is defined by the relation $\\langle \\mathbf{a}, \\mathcal{L}\\,\\mathbf{b}\\rangle = \\langle \\mathcal{L}^\\dagger \\mathbf{a}, \\mathbf{b}\\rangle$ for all state vectors $\\mathbf{a}=[p^{(a)}, v_1^{(a)}, v_2^{(a)}]$ and $\\mathbf{b}=[p^{(b)}, v_1^{(b)}, v_2^{(b)}]$. The inner product is given by:\n$$\n\\langle \\mathbf{a},\\mathbf{b}\\rangle \\;=\\; \\sum_{i,j=0,1} p^{(a)}_{i,j}\\,p^{(b)}_{i,j}\n\\;+\\; \\sum_{i,j=0,1} v^{(a)}_{1,\\,i,j}\\,v^{(b)}_{1,\\,i,j}\n\\;+\\; \\sum_{i,j=0,1} v^{(a)}_{2,\\,i,j}\\,v^{(b)}_{2,\\,i,j}\n$$\nHere, the integer indices $(i,j)$ are used as a shorthand for the staggered grid locations.\n\nWe start by writing out the left-hand side of the adjoint definition, $\\langle \\mathbf{a}, \\mathcal{L}\\,\\mathbf{b}\\rangle$:\n$$\n\\langle \\mathbf{a}, \\mathcal{L}\\,\\mathbf{b}\\rangle = \\sum_{i,j} p^{(a)}_{i,j} [\\mathcal{L}\\,\\mathbf{b}]_{p,i,j} + \\sum_{i,j} v^{(a)}_{1,i,j} [\\mathcal{L}\\,\\mathbf{b}]_{v_1,i,j} + \\sum_{i,j} v^{(a)}_{2,i,j} [\\mathcal{L}\\,\\mathbf{b}]_{v_2,i,j}\n$$\nThe components of $\\mathcal{L}\\mathbf{b}$ are:\n$$\n[\\mathcal{L}\\,\\mathbf{b}]_{p,i,j} = \\kappa\\left([\\partial_{s_1} v_1^{(b)}]_{i,j} + [\\partial_{s_2} v_2^{(b)}]_{i,j}\\right)\n$$\n$$\n[\\mathcal{L}\\,\\mathbf{b}]_{v_1,i,j} = \\frac{1}{\\rho}\\,[\\partial_{s_1} p^{(b)}]_{i,j}\n$$\n$$\n[\\mathcal{L}\\,\\mathbf{b}]_{v_2,i,j} = \\frac{1}{\\rho}\\,[\\partial_{s_2} p^{(b)}]_{i,j}\n$$\nSubstituting the discrete operators:\n$$\n\\langle \\mathbf{a}, \\mathcal{L}\\,\\mathbf{b}\\rangle = \\sum_{i,j} p^{(a)}_{i,j} \\kappa\\left( \\frac{v^{(b)}_{1,i,j}-v^{(b)}_{1,i-1,j-1}}{\\sqrt{2}} + \\frac{v^{(b)}_{2,i,j}-v^{(b)}_{2,i-1,j+1}}{\\sqrt{2}} \\right) \\\\\n+ \\sum_{i,j} v^{(a)}_{1,i,j} \\frac{1}{\\rho} \\left( \\frac{p^{(b)}_{i+1,j+1}-p^{(b)}_{i,j}}{\\sqrt{2}} \\right) \\\\\n+ \\sum_{i,j} v^{(a)}_{2,i,j} \\frac{1}{\\rho} \\left( \\frac{p^{(b)}_{i+1,j}-p^{(b)}_{i,j-1}}{\\sqrt{2}} \\right)\n$$\nWe perform a discrete summation by parts for each term to move the derivative operators from $\\mathbf{b}$ to $\\mathbf{a}$. All indices are modulo $2$.\n\nFor the term involving $v_1^{(b)}$ in the first sum:\n$$\n\\sum_{i,j} p^{(a)}_{i,j} (v^{(b)}_{1,i,j}-v^{(b)}_{1,i-1,j-1}) = \\sum_{i,j} p^{(a)}_{i,j} v^{(b)}_{1,i,j} - \\sum_{i,j} p^{(a)}_{i,j} v^{(b)}_{1,i-1,j-1}\n$$\nApplying an index shift $i' = i-1, j' = j-1$ to the second part gives $\\sum_{i',j'} p^{(a)}_{i'+1,j'+1} v^{(b)}_{1,i',j'}$. Thus, the sum becomes:\n$$\n\\sum_{i,j} (p^{(a)}_{i,j} - p^{(a)}_{i+1,j+1}) v^{(b)}_{1,i,j}\n$$\nFor the term involving $v_2^{(b)}$ in the first sum:\n$$\n\\sum_{i,j} p^{(a)}_{i,j} (v^{(b)}_{2,i,j}-v^{(b)}_{2,i-1,j+1}) = \\sum_{i,j} p^{(a)}_{i,j} v^{(b)}_{2,i,j} - \\sum_{i,j} p^{(a)}_{i,j} v^{(b)}_{2,i-1,j+1}\n$$\nApplying an index shift $i' = i-1, j' = j+1$ to the second part gives $\\sum_{i',j'} p^{(a)}_{i'+1,j'-1} v^{(b)}_{2,i',j'}$. The sum becomes:\n$$\n\\sum_{i,j} (p^{(a)}_{i,j} - p^{(a)}_{i+1,j-1}) v^{(b)}_{2,i,j}\n$$\nFor the term involving $p^{(b)}$ in the second sum (from the $v_1$ equation):\n$$\n\\sum_{i,j} v^{(a)}_{1,i,j} (p^{(b)}_{i+1,j+1}-p^{(b)}_{i,j}) = \\sum_{i,j} v^{(a)}_{1,i,j} p^{(b)}_{i+1,j+1} - \\sum_{i,j} v^{(a)}_{1,i,j} p^{(b)}_{i,j}\n$$\nApplying an index shift $i' = i+1, j' = j+1$ to the first part gives $\\sum_{i',j'} v^{(a)}_{1,i'-1,j'-1} p^{(b)}_{i',j'}$. The sum becomes:\n$$\n\\sum_{i,j} (v^{(a)}_{1,i-1,j-1} - v^{(a)}_{1,i,j}) p^{(b)}_{i,j}\n$$\nFor the term involving $p^{(b)}$ in the third sum (from the $v_2$ equation):\n$$\n\\sum_{i,j} v^{(a)}_{2,i,j} (p^{(b)}_{i+1,j}-p^{(b)}_{i,j-1}) = \\sum_{i,j} v^{(a)}_{2,i,j} p^{(b)}_{i+1,j} - \\sum_{i,j} v^{(a)}_{2,i,j} p^{(b)}_{i,j-1}\n$$\nShifting indices $i' = i+1, j' = j$ in the first part and $i'=i, j'=j-1$ in the second part gives $\\sum_{i',j'} (v^{(a)}_{2,i'-1,j'} - v^{(a)}_{2,i',j'+1}) p^{(b)}_{i',j'}$. The sum becomes:\n$$\n\\sum_{i,j} (v^{(a)}_{2,i-1,j} - v^{(a)}_{2,i,j+1}) p^{(b)}_{i,j}\n$$\nNow, we collect terms multiplying $p^{(b)}$, $v_1^{(b)}$, and $v_2^{(b)}$ to construct $\\langle \\mathcal{L}^\\dagger \\mathbf{a}, \\mathbf{b}\\rangle$:\n$$\n\\langle \\mathcal{L}^\\dagger \\mathbf{a}, \\mathbf{b}\\rangle = \\sum_{i,j} p^{(b)}_{i,j} \\frac{1}{\\rho \\sqrt{2}} \\left( (v^{(a)}_{1,i-1,j-1} - v^{(a)}_{1,i,j}) + (v^{(a)}_{2,i-1,j} - v^{(a)}_{2,i,j+1}) \\right) \\\\\n+ \\sum_{i,j} v^{(b)}_{1,i,j} \\frac{\\kappa}{\\sqrt{2}} (p^{(a)}_{i,j} - p^{(a)}_{i+1,j+1}) \\\\\n+ \\sum_{i,j} v^{(b)}_{2,i,j} \\frac{\\kappa}{\\sqrt{2}} (p^{(a)}_{i,j} - p^{(a)}_{i+1,j-1})\n$$\nBy comparing this with the definition of the inner product $\\langle \\mathcal{L}^\\dagger \\mathbf{a}, \\mathbf{b}\\rangle$, we identify the components of $\\mathcal{L}^\\dagger \\mathbf{a}$:\n$$\n[\\mathcal{L}^\\dagger\\mathbf{a}]_{p,i,j} = \\frac{1}{\\rho\\sqrt{2}} \\left( v^{(a)}_{1,i-1,j-1} - v^{(a)}_{1,i,j} + v^{(a)}_{2,i-1,j} - v^{(a)}_{2,i,j+1} \\right) = -\\frac{1}{\\rho}\\left( \\frac{v^{(a)}_{1,i,j} - v^{(a)}_{1,i-1,j-1}}{\\sqrt{2}} + \\frac{v^{(a)}_{2,i,j+1} - v^{(a)}_{2,i-1,j}}{\\sqrt{2}} \\right)\n$$\n$$\n[\\mathcal{L}^\\dagger\\mathbf{a}]_{v_1,i,j} = \\frac{\\kappa}{\\sqrt{2}} (p^{(a)}_{i,j} - p^{(a)}_{i+1,j+1}) = -\\kappa \\frac{p^{(a)}_{i+1,j+1} - p^{(a)}_{i,j}}{\\sqrt{2}}\n$$\n$$\n[\\mathcal{L}^\\dagger\\mathbf{a}]_{v_2,i,j} = \\frac{\\kappa}{\\sqrt{2}} (p^{(a)}_{i,j} - p^{(a)}_{i+1,j-1}) = -\\kappa \\frac{p^{(a)}_{i+1,j-1} - p^{(a)}_{i,j}}{\\sqrt{2}}\n$$\nThese equations define the explicit discrete adjoint operator $\\mathcal{L}^\\dagger$.\n\n### Part 2: Gradient Check\n\nWe now perform the gradient check by computing both $\\langle \\mathbf{a}, \\mathcal{L}\\,\\mathbf{b}\\rangle$ and $\\langle \\mathcal{L}^\\dagger \\mathbf{a}, \\mathbf{b}\\rangle$ for the given numerical values and parameters $\\rho=1$, $\\kappa=2$. All indices are modulo $2$.\n\nThe input fields are:\n$p^{(b)} = \\begin{pmatrix} 1 & 2 \\\\ 0 & -1 \\end{pmatrix}$, $v^{(b)}_1 = \\begin{pmatrix} 1 & 0 \\\\ 2 & -1 \\end{pmatrix}$, $v^{(b)}_2 = \\begin{pmatrix} 3 & -2 \\\\ 0 & 1 \\end{pmatrix}$\n$p^{(a)} = \\begin{pmatrix} 0 & 1 \\\\ -2 & 3 \\end{pmatrix}$, $v^{(a)}_1 = \\begin{pmatrix} 2 & -1 \\\\ 1 & 0 \\end{pmatrix}$, $v^{(a)}_2 = \\begin{pmatrix} 0 & 1 \\\\ -1 & 2 \\end{pmatrix}$\n\n**Calculation of $\\langle \\mathbf{a}, \\mathcal{L}\\,\\mathbf{b}\\rangle$**\n\nFirst, we compute $\\mathbf{c} = \\mathcal{L}\\mathbf{b}$:\n$c_{p,i,j} = \\frac{2}{\\sqrt{2}}\\left( (v^{(b)}_{1,i,j}-v^{(b)}_{1,i-1,j-1}) + (v^{(b)}_{2,i,j}-v^{(b)}_{2,i-1,j+1}) \\right)$\n$c_{p,0,0} = \\sqrt{2}[(1 - (-1)) + (3 - 1)] = 4\\sqrt{2}$\n$c_{p,1,0} = \\sqrt{2}[(0 - 2) + (-2 - 0)] = -4\\sqrt{2}$\n$c_{p,0,1} = \\sqrt{2}[(2 - 0) + (0 - (-2))] = 4\\sqrt{2}$\n$c_{p,1,1} = \\sqrt{2}[(-1 - 1) + (1 - 3)] = -4\\sqrt{2}$\n\n$c_{v_1,i,j} = \\frac{1}{\\sqrt{2}}(p^{(b)}_{i+1,j+1}-p^{(b)}_{i,j})$\n$c_{v_1,0,0} = \\frac{1}{\\sqrt{2}}(-1-1) = -2/\\sqrt{2}$\n$c_{v_1,1,0} = \\frac{1}{\\sqrt{2}}(0-2) = -2/\\sqrt{2}$\n$c_{v_1,0,1} = \\frac{1}{\\sqrt{2}}(2-0) = 2/\\sqrt{2}$\n$c_{v_1,1,1} = \\frac{1}{\\sqrt{2}}(1-(-1)) = 2/\\sqrt{2}$\n\n$c_{v_2,i,j} = \\frac{1}{\\sqrt{2}}(p^{(b)}_{i+1,j}-p^{(b)}_{i,j-1})$\n$c_{v_2,0,0} = \\frac{1}{\\sqrt{2}}(2-0) = 2/\\sqrt{2}$\n$c_{v_2,1,0} = \\frac{1}{\\sqrt{2}}(1-(-1)) = 2/\\sqrt{2}$\n$c_{v_2,0,1} = \\frac{1}{\\sqrt{2}}(-1-1) = -2/\\sqrt{2}$\n$c_{v_2,1,1} = \\frac{1}{\\sqrt{2}}(0-2) = -2/\\sqrt{2}$\n\nNow, compute the inner product $\\langle \\mathbf{a}, \\mathbf{c} \\rangle = \\sum p^{(a)}_{i,j}c_{p,i,j} + \\sum v^{(a)}_{1,i,j}c_{v_1,i,j} + \\sum v^{(a)}_{2,i,j}c_{v_2,i,j}$:\n$\\sum p^{(a)}c_p = 0(4\\sqrt{2}) + 1(-4\\sqrt{2}) + (-2)(4\\sqrt{2}) + 3(-4\\sqrt{2}) = (-4 - 8 - 12)\\sqrt{2} = -24\\sqrt{2}$\n$\\sum v^{(a)}_1 c_{v_1} = \\frac{1}{\\sqrt{2}}[2(-2) + (-1)(-2) + 1(2) + 0(2)] = \\frac{1}{\\sqrt{2}}[-4 + 2 + 2] = 0$\n$\\sum v^{(a)}_2 c_{v_2} = \\frac{1}{\\sqrt{2}}[0(2) + 1(2) + (-1)(-2) + 2(-2)] = \\frac{1}{\\sqrt{2}}[2 + 2 - 4] = 0$\nThus, $\\langle \\mathbf{a}, \\mathcal{L}\\,\\mathbf{b}\\rangle = -24\\sqrt{2}$.\n\n**Calculation of $\\langle \\mathcal{L}^\\dagger \\mathbf{a}, \\mathbf{b}\\rangle$**\n\nFirst, we compute $\\mathbf{d} = \\mathcal{L}^\\dagger\\mathbf{a}$:\n$d_{p,i,j} = -\\frac{1}{\\sqrt{2}} \\left( (v^{(a)}_{1,i,j}-v^{(a)}_{1,i-1,j-1}) + (v^{(a)}_{2,i,j+1}-v^{(a)}_{2,i-1,j}) \\right)$\n$d_{p,0,0} = -\\frac{1}{\\sqrt{2}}[(2-0) + (-1-1)] = 0$\n$d_{p,1,0} = -\\frac{1}{\\sqrt{2}}[(-1-1) + (2-0)] = 0$\n$d_{p,0,1} = -\\frac{1}{\\sqrt{2}}[(1-(-1)) + (0-2)] = 0$\n$d_{p,1,1} = -\\frac{1}{\\sqrt{2}}[(0-2) + (1-(-1))] = 0$\n\n$d_{v_1,i,j} = -\\frac{2}{\\sqrt{2}} (p^{(a)}_{i+1,j+1} - p^{(a)}_{i,j})$\n$d_{v_1,0,0} = -\\sqrt{2}(3-0) = -3\\sqrt{2}$\n$d_{v_1,1,0} = -\\sqrt{2}(-2-1) = 3\\sqrt{2}$\n$d_{v_1,0,1} = -\\sqrt{2}(1-(-2)) = -3\\sqrt{2}$\n$d_{v_1,1,1} = -\\sqrt{2}(0-3) = 3\\sqrt{2}$\n\n$d_{v_2,i,j} = -\\frac{2}{\\sqrt{2}} (p^{(a)}_{i+1,j-1} - p^{(a)}_{i,j})$\n$d_{v_2,0,0} = -\\sqrt{2}(p^{(a)}_{1,1}-p^{(a)}_{0,0}) = -\\sqrt{2}(3-0) = -3\\sqrt{2}$\n$d_{v_2,1,0} = -\\sqrt{2}(p^{(a)}_{0,1}-p^{(a)}_{1,0}) = -\\sqrt{2}(-2-1) = 3\\sqrt{2}$\n$d_{v_2,0,1} = -\\sqrt{2}(p^{(a)}_{1,0}-p^{(a)}_{0,1}) = -\\sqrt{2}(1-(-2)) = -3\\sqrt{2}$\n$d_{v_2,1,1} = -\\sqrt{2}(p^{(a)}_{0,0}-p^{(a)}_{1,1}) = -\\sqrt{2}(0-3) = 3\\sqrt{2}$\n\nNow, compute the inner product $\\langle \\mathbf{d}, \\mathbf{b} \\rangle = \\sum d_{p,i,j}p^{(b)}_{i,j} + \\sum d_{v_1,i,j}v^{(b)}_{1,i,j} + \\sum d_{v_2,i,j}v^{(b)}_{2,i,j}$:\n$\\sum d_p p^{(b)} = 0$\n$\\sum d_{v_1}v^{(b)}_1 = (-3\\sqrt{2})(1) + (3\\sqrt{2})(0) + (-3\\sqrt{2})(2) + (3\\sqrt{2})(-1) = (-3 - 6 - 3)\\sqrt{2} = -12\\sqrt{2}$\n$\\sum d_{v_2}v^{(b)}_2 = (-3\\sqrt{2})(3) + (3\\sqrt{2})(-2) + (-3\\sqrt{2})(0) + (3\\sqrt{2})(1) = (-9 - 6 + 3)\\sqrt{2} = -12\\sqrt{2}$\nThus, $\\langle \\mathcal{L}^\\dagger \\mathbf{a}, \\mathbf{b}\\rangle = 0 - 12\\sqrt{2} - 12\\sqrt{2} = -24\\sqrt{2}$.\n\nThe two calculations yield the same result, confirming the correctness of the derived adjoint operator $\\mathcal{L}^\\dagger$ and the successful completion of the gradient check. The final scalar value is $-24\\sqrt{2}$.", "answer": "$$\\boxed{-24\\sqrt{2}}$$", "id": "3613858"}]}