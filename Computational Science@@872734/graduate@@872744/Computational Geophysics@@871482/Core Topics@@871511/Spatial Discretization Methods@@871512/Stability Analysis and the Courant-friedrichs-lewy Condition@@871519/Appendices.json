{"hands_on_practices": [{"introduction": "A deep understanding of numerical stability begins with deriving the constraints from first principles. This first exercise walks you through the foundational von Neumann stability analysis for the linear advection equation, a cornerstone of numerical methods for hyperbolic PDEs. By deriving the Courant-Friedrichs-Lewy (CFL) condition for the Lax-Friedrichs scheme [@problem_id:3518916], you will build the mathematical intuition for why an explicit time step is limited by the wave speed and grid spacing.", "problem": "In a multiphysics coupled simulation employing operator splitting, an advection substep is modeled by the linear advection equation $u_{t} + a\\,u_{x} = 0$ with constant wave speed $a \\in \\mathbb{R}$ on a uniform grid with spatial step $\\Delta x$ and time step $\\Delta t$. Consider a fully discrete finite volume method with forward Euler time stepping and a Lax-Friedrichs numerical flux. Starting from the conservation law form and invoking the definitions of consistency and conservation for numerical fluxes, construct the fully discrete update associated with the Lax-Friedrichs flux\n$$\nF_{j+\\frac{1}{2}} = \\frac{1}{2}\\big(f(u_{j}) + f(u_{j+1})\\big) - \\frac{\\alpha}{2}\\,\\big(u_{j+1} - u_{j}\\big),\n$$\nwhere $f(u) = a\\,u$ and the classical Lax-Friedrichs dissipation coefficient is chosen as $\\alpha = \\frac{\\Delta x}{\\Delta t}$ by dimensional analysis and the requirement that the scheme reduces to a convex average in the zero-advection limit. Perform a von Neumann Fourier stability analysis to derive the Courant-Friedrichs-Lewy (CFL) condition, defined as the necessary bound on the ratio $\\frac{|a|\\,\\Delta t}{\\Delta x}$ that ensures the modulus of the amplification factor does not exceed one for all Fourier modes. From this condition, determine the maximal stable time step $\\Delta t_{\\max}$ as an analytic expression in terms of $a$ and $\\Delta x$. Express your final answer as a closed-form expression in terms of $a$ and $\\Delta x$.", "solution": "The problem statement is assessed to be valid, as it is scientifically grounded in the principles of numerical analysis for partial differential equations, is well-posed with sufficient information for a unique solution, and is expressed in objective, formal language. We may therefore proceed with the solution.\n\nThe problem asks for the derivation of the Courant-Friedrichs-Lewy (CFL) condition for a specific numerical scheme and the resulting maximal stable time step. The process involves three main steps: constructing the fully discrete numerical scheme, performing a von Neumann stability analysis to find the amplification factor, and deriving the stability condition from the modulus of this factor.\n\nFirst, we construct the fully discrete update equation. The governing partial differential equation is the linear advection equation, which is a form of a conservation law, $u_t + (au)_x = 0$. For a finite volume method, the semi-discrete form for a cell $j$ is obtained by integrating the PDE over the cell volume $[x_{j-1/2}, x_{j+1/2}]$ of width $\\Delta x = x_{j+1/2} - x_{j-1/2}$. This yields:\n$$\n\\frac{d u_j}{dt} + \\frac{1}{\\Delta x} \\left( F_{j+1/2} - F_{j-1/2} \\right) = 0\n$$\nwhere $u_j$ is the cell-averaged value of the solution in cell $j$, and $F_{j \\pm 1/2}$ are the numerical fluxes at the cell interfaces.\n\nApplying the forward Euler method for time integration, we discretize the time derivative as $\\frac{du_j}{dt} \\approx \\frac{u_j^{n+1} - u_j^n}{\\Delta t}$, where the superscript $n$ denotes the time level. The fully discrete scheme is:\n$$\n\\frac{u_j^{n+1} - u_j^n}{\\Delta t} = - \\frac{1}{\\Delta x} \\left( F_{j+1/2}^n - F_{j-1/2}^n \\right)\n$$\nRearranging for $u_j^{n+1}$ gives the update formula:\n$$\nu_j^{n+1} = u_j^n - \\frac{\\Delta t}{\\Delta x} \\left( F_{j+1/2}^n - F_{j-1/2}^n \\right)\n$$\nThe problem specifies the Lax-Friedrichs numerical flux:\n$$\nF_{j+\\frac{1}{2}} = \\frac{1}{2}\\big(f(u_{j}) + f(u_{j+1})\\big) - \\frac{\\alpha}{2}\\,\\big(u_{j+1} - u_{j}\\big)\n$$\nwith the physical flux $f(u) = a u$ and the dissipation coefficient $\\alpha = \\frac{\\Delta x}{\\Delta t}$. Substituting these into the flux definition, we get the flux at interface $j+1/2$ at time level $n$:\n$$\nF_{j+1/2}^n = \\frac{1}{2}\\left(a u_j^n + a u_{j+1}^n\\right) - \\frac{1}{2}\\frac{\\Delta x}{\\Delta t}\\left(u_{j+1}^n - u_j^n\\right)\n$$\nand similarly for the flux at interface $j-1/2$:\n$$\nF_{j-1/2}^n = \\frac{1}{2}\\left(a u_{j-1}^n + a u_j^n\\right) - \\frac{1}{2}\\frac{\\Delta x}{\\Delta t}\\left(u_j^n - u_{j-1}^n\\right)\n$$\nWe now compute the flux difference required in the update formula:\n$$\nF_{j+1/2}^n - F_{j-1/2}^n = \\left[ \\frac{a}{2}(u_j^n + u_{j+1}^n) - \\frac{\\Delta x}{2\\Delta t}(u_{j+1}^n - u_j^n) \\right] - \\left[ \\frac{a}{2}(u_{j-1}^n + u_j^n) - \\frac{\\Delta x}{2\\Delta t}(u_j^n - u_{j-1}^n) \\right]\n$$\n$$\nF_{j+1/2}^n - F_{j-1/2}^n = \\frac{a}{2}(u_{j+1}^n - u_{j-1}^n) - \\frac{\\Delta x}{2\\Delta t}(u_{j+1}^n - 2u_j^n + u_{j-1}^n)\n$$\nSubstituting this difference back into the update formula for $u_j^{n+1}$:\n$$\nu_j^{n+1} = u_j^n - \\frac{\\Delta t}{\\Delta x} \\left[ \\frac{a}{2}(u_{j+1}^n - u_{j-1}^n) - \\frac{\\Delta x}{2\\Delta t}(u_{j+1}^n - 2u_j^n + u_{j-1}^n) \\right]\n$$\n$$\nu_j^{n+1} = u_j^n - \\frac{a \\Delta t}{2\\Delta x}(u_{j+1}^n - u_{j-1}^n) + \\frac{1}{2}(u_{j+1}^n - 2u_j^n + u_{j-1}^n)\n$$\nLet the Courant number be $\\nu = \\frac{a \\Delta t}{\\Delta x}$. The equation becomes:\n$$\nu_j^{n+1} = u_j^n - \\frac{\\nu}{2}(u_{j+1}^n - u_{j-1}^n) + \\frac{1}{2}u_{j+1}^n - u_j^n + \\frac{1}{2}u_{j-1}^n\n$$\nCombining terms with respect to their spatial indices $j-1$, $j$, and $j+1$:\n$$\nu_j^{n+1} = (u_j^n - u_j^n) + \\left(\\frac{1}{2} - \\frac{\\nu}{2}\\right) u_{j+1}^n + \\left(\\frac{1}{2} + \\frac{\\nu}{2}\\right) u_{j-1}^n\n$$\n$$\nu_j^{n+1} = \\frac{1-\\nu}{2} u_{j+1}^n + \\frac{1+\\nu}{2} u_{j-1}^n\n$$\nThis is the fully discrete update scheme, which is equivalent to the classic Lax method.\n\nSecond, we perform a von Neumann stability analysis. We seek a Fourier mode solution of the form $u_j^n = \\hat{u}^n(k) \\exp(i k x_j)$, where $x_j = j \\Delta x$, $k$ is the wavenumber, and $i = \\sqrt{-1}$. Substituting this into the discrete scheme:\n$$\n\\hat{u}^{n+1} \\exp(i k j \\Delta x) = \\frac{1-\\nu}{2} \\hat{u}^n \\exp(i k (j+1) \\Delta x) + \\frac{1+\\nu}{2} \\hat{u}^n \\exp(i k (j-1) \\Delta x)\n$$\nThe amplification factor is defined as $G(k) = \\frac{\\hat{u}^{n+1}}{\\hat{u}^n}$. Dividing by $\\hat{u}^n \\exp(i k j \\Delta x)$:\n$$\nG(k) = \\frac{1-\\nu}{2} \\exp(i k \\Delta x) + \\frac{1+\\nu}{2} \\exp(-i k \\Delta x)\n$$\nUsing Euler's formula, $\\exp(\\pm i \\theta) = \\cos(\\theta) \\pm i\\sin(\\theta)$, with $\\theta = k \\Delta x$:\n$$\nG(k) = \\frac{1-\\nu}{2} \\left(\\cos(k\\Delta x) + i\\sin(k\\Delta x)\\right) + \\frac{1+\\nu}{2} \\left(\\cos(k\\Delta x) - i\\sin(k\\Delta x)\\right)\n$$\nWe group the real and imaginary parts:\n$$\nG(k) = \\left(\\frac{1-\\nu}{2} + \\frac{1+\\nu}{2}\\right) \\cos(k\\Delta x) + i \\left(\\frac{1-\\nu}{2} - \\frac{1+\\nu}{2}\\right) \\sin(k\\Delta x)\n$$\n$$\nG(k) = \\frac{2}{2} \\cos(k\\Delta x) + i \\left(\\frac{-2\\nu}{2}\\right) \\sin(k\\Delta x)\n$$\n$$\nG(k) = \\cos(k\\Delta x) - i\\nu\\sin(k\\Delta x)\n$$\nFor the scheme to be stable, the modulus of the amplification factor must not exceed $1$ for all possible wavenumbers $k$, i.e., $|G(k)| \\le 1$. We compute the square of the modulus:\n$$\n|G(k)|^2 = (\\text{Re}[G(k)])^2 + (\\text{Im}[G(k)])^2 = \\cos^2(k\\Delta x) + (-\\nu\\sin(k\\Delta x))^2\n$$\n$$\n|G(k)|^2 = \\cos^2(k\\Delta x) + \\nu^2\\sin^2(k\\Delta x)\n$$\nThe stability condition is $|G(k)|^2 \\le 1$:\n$$\n\\cos^2(k\\Delta x) + \\nu^2\\sin^2(k\\Delta x) \\le 1\n$$\nUsing the trigonometric identity $\\cos^2(\\theta) = 1 - \\sin^2(\\theta)$:\n$$\n1 - \\sin^2(k\\Delta x) + \\nu^2\\sin^2(k\\Delta x) \\le 1\n$$\n$$\n(\\nu^2 - 1)\\sin^2(k\\Delta x) \\le 0\n$$\nSince $\\sin^2(k\\Delta x) \\ge 0$ for all real values of $k\\Delta x$, the inequality holds if and only if the coefficient $(\\nu^2 - 1)$ is non-positive:\n$$\n\\nu^2 - 1 \\le 0 \\implies \\nu^2 \\le 1\n$$\nTaking the square root gives the CFL condition for this scheme:\n$$\n|\\nu| \\le 1\n$$\n\nThird, we determine the maximal stable time step $\\Delta t_{\\max}$. We substitute the definition of the Courant number, $\\nu = \\frac{a \\Delta t}{\\Delta x}$, into the stability condition:\n$$\n\\left|\\frac{a \\Delta t}{\\Delta x}\\right| \\le 1\n$$\nSince $\\Delta t$ and $\\Delta x$ are positive physical quantities, we can write:\n$$\n\\frac{|a|\\Delta t}{\\Delta x} \\le 1\n$$\nThis inequality must be satisfied for the simulation to remain stable. The maximal allowable time step, $\\Delta t_{\\max}$, is found when the equality holds. Assuming a non-zero wave speed, $a \\neq 0$:\n$$\n\\frac{|a|\\Delta t_{\\max}}{\\Delta x} = 1\n$$\nSolving for $\\Delta t_{\\max}$ yields the final expression:\n$$\n\\Delta t_{\\max} = \\frac{\\Delta x}{|a|}\n$$\nThis is the required analytic expression for the maximal stable time step. In the degenerate case where $a=0$, the CFL condition $|\\nu| \\le 1$ becomes $0 \\le 1$, which is always true, implying unconditional stability and no finite maximum time step. The derived expression for $\\Delta t_{\\max}$ correctly captures this by becoming singular as $|a| \\to 0$.", "answer": "$$\n\\boxed{\\frac{\\Delta x}{|a|}}\n$$", "id": "3518916"}, {"introduction": "While linear analysis provides the foundation, many real-world geophysical phenomena are inherently nonlinear. This practice explores the crucial extension of the CFL condition to nonlinear conservation laws, such as the Burgers’ equation, where the characteristic wave speed depends on the solution itself. You will learn how to determine a global, stable time step by identifying the maximum propagation speed across the entire computational domain, a fundamental technique for ensuring stability in nonlinear simulations [@problem_id:3220247].", "problem": "Consider the nonlinear conservation law for the inviscid Burgers’ equation, $$u_t + \\big(f(u)\\big)_x = 0,$$ with flux $$f(u) = \\tfrac{1}{2} u^2,$$ so that the characteristic speed is $$a(u) = f'(u) = u.$$ You use an explicit finite-volume method with a monotone Riemann solver on a uniform grid of spacing $$\\Delta x > 0,$$ where the update at each face in one time step depends only on adjacent cell states. The Courant-Friedrichs-Lewy (CFL) condition must be chosen so that the numerical domain of dependence covers the physical domain of dependence dictated by the characteristic propagation speeds.\n\nAt the current time $$t^n,$$ you have cell-averaged values $$u_i^n$$ on a uniform grid with $$\\Delta x = 0.05$$ and the CFL number $$C = 0.8.$$ On five consecutive cells, the state is $$[0.6,\\,-1.1,\\,0.2,\\,0.9,\\,-0.4],$$ with indices $$i = 1,2,3,4,5.$$ You must pick a single global time step $$\\Delta t$$ to be used for all cells during the update from $$t^n$$ to $$t^{n+1}.$$\n\nWhich option correctly describes how the CFL condition must be adapted to account for the solution-dependent wave speed and, for the given state, yields the largest admissible $$\\Delta t$$?\n\nA. Use the global maximum of the magnitude of the characteristic speed computed from the current state, enforcing $$\\max_i \\big|f'(u_i^n)\\big| \\,\\frac{\\Delta t}{\\Delta x} \\le C.$$ For Burgers’ equation, this gives $$\\Delta t = \\dfrac{C\\,\\Delta x}{\\max_i |u_i^n|} \\approx 0.03636.$$\n\nB. Use the smallest magnitude of the characteristic speed across the domain to avoid over-restriction, i.e., $$\\Delta t = \\dfrac{C\\,\\Delta x}{\\min_i |u_i^n|} \\approx 0.20.$$\n\nC. Use the domain average of the absolute characteristic speed to set the time step, i.e., $$\\overline{|u|} = \\dfrac{0.6 + 1.1 + 0.2 + 0.9 + 0.4}{5} = 0.64,$$ so $$\\Delta t = \\dfrac{C\\,\\Delta x}{\\overline{|u|}} = 0.0625.$$\n\nD. Use only the largest positive characteristic speed on the domain, ignoring negative speeds, i.e., $$\\Delta t = \\dfrac{C\\,\\Delta x}{\\max\\{u_i^n : u_i^n > 0\\}} \\approx 0.04444.$$", "solution": "The Courant-Friedrichs-Lewy (CFL) condition is a necessary condition for the stability of explicit numerical methods for solving hyperbolic partial differential equations. It states that the numerical domain of dependence of a computational cell must contain the physical domain of dependence.\n\nFor a one-dimensional hyperbolic equation of the form $$u_t + a(u)u_x = 0$$, information propagates along characteristic curves with speed $$a(u)$$. For an explicit finite-volume or finite-difference scheme that uses information from immediately adjacent cells, the value at a grid point $$x_i$$ at the new time step $$t^{n+1} = t^n + \\Delta t$$ is computed using values from cells $$i-1$$, $$i$$, and $$i+1$$ at time $$t^n$$.\n\nFor the numerical scheme to be stable, any characteristic originating in cell $$i$$ must not travel further than one grid spacing $$\\Delta x$$ in a single time step $$\\Delta t$$. The speed of propagation is given by the magnitude of the characteristic speed, $$|a(u)|$$. Thus, the condition is $$|a(u)| \\Delta t \\le \\Delta x$$.\n\nFor a nonlinear problem, the characteristic speed $$a(u)$$ is not constant; it varies with the solution $$u$$. Since a single global time step $$\\Delta t$$ must be used for all cells to advance the solution synchronously, $$\\Delta t$$ must be chosen to be small enough to ensure stability everywhere in the domain. This means $$\\Delta t$$ must be restricted by the maximum characteristic speed present anywhere in the domain at time $$t^n$$. The stability condition therefore becomes:\n$$ \\left( \\max_i |a(u_i^n)| \\right) \\frac{\\Delta t}{\\Delta x} \\le 1 $$\n\nThe problem introduces a CFL number, $$C$$, which is a factor (typically $$C \\le 1$$) that tightens this constraint for practical stability:\n$$ \\left( \\max_i |a(u_i^n)| \\right) \\frac{\\Delta t}{\\Delta x} \\le C $$\n\nTo find the largest admissible time step $$\\Delta t$$, we solve this inequality for $$\\Delta t$$:\n$$ \\Delta t \\le \\frac{C \\Delta x}{\\max_i |a(u_i^n)|} $$\nThe largest value is obtained by taking the equality:\n$$ \\Delta t = \\frac{C \\Delta x}{\\max_i |a(u_i^n)|} $$\n\nNow, we apply this to the specific problem:\n*   The characteristic speed for Burgers' equation is $$a(u) = u$$.\n*   The given cell-averaged values are $$u_i^n = [0.6, -1.1, 0.2, 0.9, -0.4]$$.\n*   We must find the maximum of the absolute values of these speeds:\n    $$ |u_i^n| = [|0.6|, |-1.1|, |0.2|, |0.9|, |-0.4|] = [0.6, 1.1, 0.2, 0.9, 0.4] $$\n*   The maximum of these values is:\n    $$ \\max_i |u_i^n| = 1.1 $$\n*   The given parameters are $$C=0.8$$ and $$\\Delta x = 0.05$$.\n*   We can now calculate the largest admissible time step $$\\Delta t$$:\n    $$ \\Delta t = \\frac{C \\Delta x}{\\max_i |u_i^n|} = \\frac{0.8 \\times 0.05}{1.1} = \\frac{0.04}{1.1} $$\n*   Performing the division:\n    $$ \\Delta t = \\frac{0.04}{1.1} = \\frac{4}{110} = \\frac{2}{55} \\approx 0.0363636... $$\n\n### Option-by-Option Analysis\n\n*   **Option A:** This option states that one must use the global maximum of the magnitude of the characteristic speed, enforcing $$\\max_i \\big|f'(u_i^n)\\big| \\,\\frac{\\Delta t}{\\Delta x} \\le C$$. It then calculates $$\\Delta t = \\dfrac{C\\,\\Delta x}{\\max_i |u_i^n|} \\approx 0.03636$$.\n    - This is the correct principle for choosing a global time step for a nonlinear hyperbolic problem. The formula is a direct application of this principle to Burgers' equation ($$f'(u)=u$$). The calculation, as shown above, is $$\\frac{0.8 \\times 0.05}{1.1} \\approx 0.03636$$. The principle, formula, and calculation are all correct.\n    - **Verdict: Correct**\n\n*   **Option B:** This option suggests using the smallest magnitude of the characteristic speed, $$\\min_i |u_i^n|$$, yielding $$\\Delta t \\approx 0.20$$.\n    - This is fundamentally incorrect. The CFL condition is a restriction based on the *fastest* information propagation speed, not the slowest. Using the minimum speed would result in a time step that is far too large, leading to numerical instability in regions where the speed is higher than the minimum. The minimum absolute speed is $$\\min\\{0.6, 1.1, 0.2, 0.9, 0.4\\} = 0.2$$. The calculated $$\\Delta t = \\frac{0.8 \\times 0.05}{0.2} = 0.2$$ would result in a local CFL number of $$1.1 \\times \\frac{0.2}{0.05} = 1.1 \\times 4 = 4.4$$ at the cell with speed $$-1.1$$. This is much larger than the allowed CFL number $$C=0.8$$.\n    - **Verdict: Incorrect**\n\n*   **Option C:** This option suggests using the domain average of the absolute characteristic speeds, $$\\overline{|u|} = 0.64$$, yielding $$\\Delta t = 0.0625$$.\n    - This is also incorrect. Stability must be guaranteed for the \"worst-case\" scenario, which is the cell with the maximum speed. An average speed masks this maximum. The resulting time step, $$\\Delta t = 0.0625$$, is larger than the maximum allowed stable time step ($$0.03636$$). At the cell with speed $$-1.1$$, the local CFL number would be $$|-1.1| \\frac{0.0625}{0.05} = 1.1 \\times 1.25 = 1.375$$, which exceeds $$C=0.8$$. The scheme would be unstable.\n    - **Verdict: Incorrect**\n\n*   **Option D:** This option suggests using only the largest positive characteristic speed, ignoring negative speeds, yielding $$\\Delta t \\approx 0.04444$$.\n    - This is incorrect. The restriction on $$\\Delta t$$ is related to the propagation *speed*, which is the magnitude of the velocity. A wave propagating to the left (negative velocity) is just as relevant to stability as a wave propagating to the right. Both directions must be accounted for by using the absolute value of the characteristic speed. The largest positive speed is $$0.9$$. The resulting time step, $$\\Delta t \\approx 0.04444$$, is larger than the stable limit. The cell with speed $$-1.1$$ would be unstable, with a local CFL number of $$|-1.1| \\frac{0.04444}{0.05} \\approx 1.1 \\times 0.8888 = 0.97768$$, which exceeds $$C=0.8$$.\n    - **Verdict: Incorrect**", "answer": "$$\\boxed{A}$$", "id": "3220247"}, {"introduction": "The final step in mastering the CFL condition is translating theory into robust computational practice. This exercise challenges you to design and implement an algorithm for computing a stable time step in a complex, multi-dimensional setting with spatially varying material properties and grid spacings [@problem_id:3615177]. This practice bridges the gap between a simple formula and a practical algorithm, a core skill for developing reliable and efficient geophysical simulation software.", "problem": "You are asked to derive, implement, and test an algorithm to compute a global stable time step for explicit time integration of a linear hyperbolic conservation law used in computational geophysics, consistent with the stability requirement known as the Courant–Friedrichs–Lewy (CFL) condition. The computation must be based on scanning local maximum characteristic speeds and mesh spacings per cell and applying a safety factor, while updating the global time step dynamically as the fields evolve in time.\n\nStarting point and assumptions: Consider the linear hyperbolic system in $D$ spatial dimensions,\n$$\n\\frac{\\partial \\mathbf{q}}{\\partial t} + \\sum_{d=1}^{D} \\mathbf{A}_d(\\mathbf{x}) \\frac{\\partial \\mathbf{q}}{\\partial x_d} = \\mathbf{0},\n$$\nwhere $\\mathbf{q}(\\mathbf{x},t)$ is a vector of conserved variables and $\\mathbf{A}_d(\\mathbf{x})$ are spatially varying flux Jacobian matrices. At each cell $i$ in a rectilinear mesh, let the grid spacing in direction $d$ be $h_{i,d} > 0$, and let the local maximum characteristic speed magnitude in direction $d$ be $s_{t,i,d} \\ge 0$ at time index $t$ (that is, the largest magnitude eigenvalue of $\\mathbf{A}_d$ evaluated in cell $i$ at time $t$). Assume an explicit, monotone finite volume method whose numerical fluxes are consistent with the local characteristic speeds. You must work from well-tested facts: for such explicit methods, stability requires that a suitable linear combination of directional Courant numbers be bounded by a constant of order unity, and that the time step $\\Delta t$ respects a global bound enforced by the most restrictive cell.\n\nYour tasks:\n- From the base definitions and principles above, perform a first-principles stability analysis argument to obtain a necessary stability condition that constrains $\\Delta t$ in terms of the local quantities $s_{t,i,d}$ and $h_{i,d}$, together with a user-chosen safety factor $\\sigma$ with $0 < \\sigma < 1$. This argument must not rely on pre-stated shortcut formulas; it must be explained and derived from the properties of explicit schemes for hyperbolic systems and the requirement that their Courant numbers remain within stability limits.\n- Design an algorithm that, at each time index $t$, scans all cells $i$ and all directions $d$, combines the local characteristic speeds $s_{t,i,d}$ and spacings $h_{i,d}$ to determine a single global $\\Delta t_t$ satisfying the derived stability condition plus the safety factor $\\sigma$, and includes a maximum allowable time step cap $\\Delta t_{\\mathrm{cap}}$ to ensure numerical practicality. The algorithm must handle edge cases such as cells with $s_{t,i,d} = 0$ for some or all directions, and the case where all cells have zero characteristic speeds simultaneously.\n- Implement the algorithm as a complete, runnable program that, for each test case provided below, processes a sequence of time steps $t = 0,1,2,\\dots$ with given arrays of $s_{t,i,d}$ and $h_{i,d}$, computes the dynamic sequence of global time steps $\\Delta t_t$, and returns the value at the last time index for that test case.\n- Units: All spacings $h_{i,d}$ are in meters (m), all characteristic speeds $s_{t,i,d}$ are in meters per second (m/s), and $\\Delta t$ must be expressed in seconds (s). Your program must print the final results in seconds.\n- Output format: Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, with each floating-point number formatted to exactly $6$ decimal places (e.g., $\\left[0.012345,0.100000\\right]$).\n\nTest suite specification (arrays are organized as time-major, then cell-major, then dimension-major; that is, $s_{t,i,d}$ is provided as a three-dimensional array ordered by $t$, then $i$, then $d$):\n\n- Test case $1$ (one-dimensional, uniform grid, dynamic speeds, happy path):\n  - Dimensions $D = 1$, number of cells $N = 5$, number of times $T = 3$.\n  - Spacings $h_{i,1} = 10$ m for all cells $i \\in \\{0,1,2,3,4\\}$.\n  - Safety factor $\\sigma = 0.9$, cap $\\Delta t_{\\mathrm{cap}} = 1.0$ s.\n  - Speeds (m/s):\n    - $t = 0$: $\\left[50,40,60,55,45\\right]$,\n    - $t = 1$: $\\left[70,30,65,40,50\\right]$,\n    - $t = 2$: $\\left[80,90,85,75,65\\right]$.\n  - Required result: the program must return the last computed $\\Delta t$ in s.\n\n- Test case $2$ (two-dimensional, anisotropic spacings, dynamic speeds):\n  - Dimensions $D = 2$, number of cells $N = 3$, number of times $T = 2$.\n  - Spacings (m):\n    - Cell $0$: $\\left(h_{0,1},h_{0,2}\\right) = \\left(20,10\\right)$,\n    - Cell $1$: $\\left(h_{1,1},h_{1,2}\\right) = \\left(25,15\\right)$,\n    - Cell $2$: $\\left(h_{2,1},h_{2,2}\\right) = \\left(15,15\\right)$.\n  - Safety factor $\\sigma = 0.8$, cap $\\Delta t_{\\mathrm{cap}} = 0.5$ s.\n  - Speeds (m/s):\n    - $t = 0$: cells $0$ to $2$ have $\\left(30,20\\right)$, $\\left(40,10\\right)$, $\\left(35,35\\right)$ respectively,\n    - $t = 1$: cells $0$ to $2$ have $\\left(25,25\\right)$, $\\left(45,5\\right)$, $\\left(30,40\\right)$ respectively.\n  - Required result: the program must return the last computed $\\Delta t$ in s.\n\n- Test case $3$ (three-dimensional, includes zero speeds, binding cap edge case):\n  - Dimensions $D = 3$, number of cells $N = 2$, number of times $T = 2$.\n  - Spacings (m): all cells have $\\left(10,10,10\\right)$.\n  - Safety factor $\\sigma = 0.7$, cap $\\Delta t_{\\mathrm{cap}} = 0.05$ s.\n  - Speeds (m/s):\n    - $t = 0$: cells $0$ and $1$ have $\\left(0,0,0\\right)$ and $\\left(5,5,5\\right)$ respectively,\n    - $t = 1$: cells $0$ and $1$ have $\\left(1,0,0\\right)$ and $\\left(0,0,0\\right)$ respectively.\n  - Required result: the program must return the last computed $\\Delta t$ in s.\n\n- Test case $4$ (two-dimensional, all speeds become zero at the final time, stationary edge case):\n  - Dimensions $D = 2$, number of cells $N = 4$, number of times $T = 3$.\n  - Spacings (m):\n    - Cell $0$: $\\left(50,50\\right)$,\n    - Cell $1$: $\\left(20,30\\right)$,\n    - Cell $2$: $\\left(40,25\\right)$,\n    - Cell $3$: $\\left(30,45\\right)$.\n  - Safety factor $\\sigma = 0.95$, cap $\\Delta t_{\\mathrm{cap}} = 1.0$ s.\n  - Speeds (m/s):\n    - $t = 0$: cells $0$ to $3$ have $\\left(10,5\\right)$, $\\left(15,10\\right)$, $\\left(8,12\\right)$, $\\left(10,9\\right)$ respectively,\n    - $t = 1$: cells $0$ to $3$ have $\\left(20,10\\right)$, $\\left(30,20\\right)$, $\\left(16,24\\right)$, $\\left(15,18\\right)$ respectively,\n    - $t = 2$: cells $0$ to $3$ have $\\left(0,0\\right)$, $\\left(0,0\\right)$, $\\left(0,0\\right)$, $\\left(0,0\\right)$ respectively.\n  - Required result: the program must return the last computed $\\Delta t$ in s.\n\nYour program must compute each test case independently, collect the final $\\Delta t$ (in s) from the last time index of each case, and print a single line containing a comma-separated list of these four results enclosed in square brackets, with each number formatted to exactly $6$ decimal places.", "solution": "The problem requires the derivation and implementation of an algorithm to compute a globally stable time step, $\\Delta t$, for the numerical integration of a linear hyperbolic system. This will be accomplished by adhering to the Courant–Friedrichs–Lewy (CFL) condition. The process involves two main stages: first, a first-principles derivation of the local stability constraint for a multi-dimensional system on a rectilinear grid; and second, the design of a robust algorithm to compute a single global time step that satisfies this constraint for all cells in the computational domain, incorporates a safety factor, and respects a maximum time step cap.\n\n### First-Principles Stability Analysis\n\nThe governing partial differential equation (PDE) is given as a $D$-dimensional linear hyperbolic system:\n$$\n\\frac{\\partial \\mathbf{q}}{\\partial t} + \\sum_{d=1}^{D} \\mathbf{A}_d(\\mathbf{x}) \\frac{\\partial \\mathbf{q}}{\\partial x_d} = \\mathbf{0}\n$$\nThe CFL condition is a necessary condition for the stability of explicit time-integration schemes for hyperbolic PDEs. It originates from the principle that the numerical domain of dependence of a solution at a point in space-time must contain the physical domain of dependence of the PDE.\n\nFor an explicit finite volume or finite difference scheme, the updated value in a cell $i$ at time $t+\\Delta t$ is computed using information from a finite neighborhood of cells at time $t$. Let's first consider the one-dimensional case ($D=1$). The PDE simplifies to $\\frac{\\partial \\mathbf{q}}{\\partial t} + \\mathbf{A}_1 \\frac{\\partial \\mathbf{q}}{\\partial x_1} = \\mathbf{0}$. Information propagates with characteristic speeds, which are the eigenvalues of $\\mathbf{A}_1$. The maximum speed of propagation is $s_{t,i,1}$. Over a time interval $\\Delta t$, a wave can travel a maximum physical distance of $s_{t,i,1} \\Delta t$. A simple explicit numerical scheme typically uses information from adjacent cells. For stability, the numerical scheme must be able to \"capture\" the fastest-moving physical information. This means that the distance a wave travels in one time step must be less than the distance the numerical stencil covers. For a scheme using nearest-neighbor information on a grid with spacing $h_{i,1}$, this requires $s_{t,i,1} \\Delta t \\le C_{max} h_{i,1}$, where $C_{max}$ is a scheme-dependent constant, typically of order $1$. This can be rewritten in terms of the Courant number $C_r = \\frac{s_{t,i,1} \\Delta t}{h_{i,1}}$, with the condition being $C_r \\le C_{max}$. For simplicity and without loss of generality, we can set $C_{max}=1$, as any other value can be absorbed into the safety factor $\\sigma$. This yields the local time step constraint for cell $i$:\n$$\n\\Delta t \\le \\frac{h_{i,1}}{s_{t,i,1}}\n$$\nThis assumes $s_{t,i,1} > 0$. If $s_{t,i,1} = 0$, there is no constraint on $\\Delta t$ from this cell.\n\nNow, we extend this to $D$ spatial dimensions on a rectilinear mesh with cell dimensions $h_{i,1}, h_{i,2}, \\dots, h_{i,D}$. The problem statement alludes to a \"suitable linear combination of directional Courant numbers\". For many explicit schemes on structured grids (e.g., using operator splitting or multidimensional upwinding), the stability constraint is determined by the combined effect of wave propagation in all directions. The time it takes for a wave traveling at speed $s_{t,i,d}$ to cross the cell in direction $d$ is $\\tau_{i,d} = h_{i,d} / s_{t,i,d}$. The rate of information transfer across the cell in this direction is the inverse, $1/\\tau_{i,d} = s_{t,i,d} / h_{i,d}$. The total rate of information transfer out of the cell is the sum of the rates in each dimension. The time step $\\Delta t$ must be smaller than the characteristic time scale defined by this total rate. This leads to the multi-dimensional CFL condition for cell $i$:\n$$\n\\Delta t \\left( \\sum_{d=1}^{D} \\frac{s_{t,i,d}}{h_{i,d}} \\right) \\le C_{max}\n$$\nAgain, setting $C_{max}=1$, we obtain the constraint for the time step $\\Delta t$ based on the properties of cell $i$ at time $t$:\n$$\n\\Delta t_{t,i} \\le \\frac{1}{\\sum_{d=1}^{D} \\frac{s_{t,i,d}}{h_{i,d}}}\n$$\nThis formula provides the maximum permissible local time step for cell $i$. If the sum in the denominator is zero (i.e., all $s_{t,i,d}=0$), the local time step constraint is infinite, meaning this cell imposes no stability restriction.\n\n### Algorithm Design for Global Time Step Calculation\n\nSince an explicit method uses a single, global time step $\\Delta t_t$ to advance the entire computational domain from time $t$ to $t+\\Delta t_t$, this global step must satisfy the stability condition in every cell simultaneously. Therefore, $\\Delta t_t$ must be no larger than the minimum of all the local maximum stable time steps.\n\nThe algorithm to compute the global time step $\\Delta t_t$ at a given time index $t$ is as follows:\n\n1.  **Compute Local Constraints**: For each cell $i$ in the domain (from $i=0$ to $N-1$):\n    a. Calculate the sum of characteristic speed-to-spacing ratios:\n    $$\n    C_i = \\sum_{d=1}^{D} \\frac{s_{t,i,d}}{h_{i,d}}\n    $$\n    b. Determine the maximum local stable time step, $\\Delta t_{t,i}$.\n       - If $C_i > 0$, then $\\Delta t_{t,i} = 1/C_i$.\n       - If $C_i = 0$ (which occurs if and only if $s_{t,i,d} = 0$ for all $d=1, \\dots, D$, since $h_{i,d}>0$), the cell is locally stationary. It imposes no upper bound on the time step. We can represent this as $\\Delta t_{t,i} = \\infty$.\n\n2.  **Find the Global Stability Limit**: Determine the most restrictive constraint over the entire grid by finding the minimum of all local time steps:\n    $$\n    \\Delta t_{stable} = \\min_{i \\in \\{0, \\dots, N-1\\}} \\{ \\Delta t_{t,i} \\}\n    $$\n    - If all cells have zero speeds (all $s_{t,i,d}=0$), then all $\\Delta t_{t,i} = \\infty$, and thus $\\Delta t_{stable} = \\infty$. This corresponds to a fully stationary state of the system.\n\n3.  **Apply Safety Factor**: Apply the user-provided safety factor $\\sigma$ (where $0 < \\sigma < 1$) to reduce the time step, providing a margin of safety against numerical instabilities arising from discretization errors or non-linear effects not considered in this linear analysis.\n    $$\n    \\Delta t_{safe} = \\sigma \\cdot \\Delta t_{stable}\n    $$\n    Note that if $\\Delta t_{stable} = \\infty$, then $\\Delta t_{safe} = \\infty$.\n\n4.  **Enforce Time Step Cap**: The final time step $\\Delta t_t$ is the smaller of the safety-factored stable step and a user-defined maximum time step cap, $\\Delta t_{\\mathrm{cap}}$. This cap prevents the time step from becoming excessively large, which might be undesirable for reasons of accuracy or if the system is expected to become dynamic again.\n    $$\n    \\Delta t_t = \\min(\\Delta t_{safe}, \\Delta t_{\\mathrm{cap}})\n    $$\n    This step is critical for handling the case of a fully stationary system, where $\\Delta t_{safe}$ would be infinite. In that situation, the algorithm correctly yields $\\Delta t_t = \\Delta t_{\\mathrm{cap}}$.\n\nThe final task is to implement this algorithm to compute the sequence of time steps for each test case and report the value at the final time index. As the calculation of $\\Delta t_t$ depends only on the speeds $s_{t,i,d}$ at the same time index $t$, we only need to perform the calculation for the last specified time index in each test case to obtain the required result.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem by processing each test case to find the final stable time step.\n    \"\"\"\n    \n    # Test case 1: 1D, uniform grid, dynamic speeds\n    test_case_1 = {\n        \"h\": np.full((5, 1), 10.0),\n        \"s\": np.array([\n            [[50.0], [40.0], [60.0], [55.0], [45.0]],\n            [[70.0], [30.0], [65.0], [40.0], [50.0]],\n            [[80.0], [90.0], [85.0], [75.0], [65.0]],\n        ]),\n        \"sigma\": 0.9,\n        \"dt_cap\": 1.0,\n    }\n\n    # Test case 2: 2D, anisotropic spacings, dynamic speeds\n    test_case_2 = {\n        \"h\": np.array([\n            [20.0, 10.0],\n            [25.0, 15.0],\n            [15.0, 15.0]\n        ]),\n        \"s\": np.array([\n            [[30.0, 20.0], [40.0, 10.0], [35.0, 35.0]],\n            [[25.0, 25.0], [45.0, 5.0],  [30.0, 40.0]],\n        ]),\n        \"sigma\": 0.8,\n        \"dt_cap\": 0.5,\n    }\n\n    # Test case 3: 3D, zero speeds, binding cap\n    test_case_3 = {\n        \"h\": np.full((2, 3), 10.0),\n        \"s\": np.array([\n            [[0.0, 0.0, 0.0], [5.0, 5.0, 5.0]],\n            [[1.0, 0.0, 0.0], [0.0, 0.0, 0.0]],\n        ]),\n        \"sigma\": 0.7,\n        \"dt_cap\": 0.05,\n    }\n\n    # Test case 4: 2D, all speeds become zero\n    test_case_4 = {\n        \"h\": np.array([\n            [50.0, 50.0],\n            [20.0, 30.0],\n            [40.0, 25.0],\n            [30.0, 45.0]\n        ]),\n        \"s\": np.array([\n            [[10.0, 5.0], [15.0, 10.0], [8.0, 12.0], [10.0, 9.0]],\n            [[20.0, 10.0], [30.0, 20.0], [16.0, 24.0], [15.0, 18.0]],\n            [[0.0, 0.0], [0.0, 0.0], [0.0, 0.0], [0.0, 0.0]],\n        ]),\n        \"sigma\": 0.95,\n        \"dt_cap\": 1.0,\n    }\n\n    test_cases = [test_case_1, test_case_2, test_case_3, test_case_4]\n    results = []\n\n    def compute_final_dt(h, s, sigma, dt_cap):\n        \"\"\"\n        Computes the stable time step for the last time index provided.\n        \n        Args:\n            h (np.ndarray): Grid spacings, shape (N, D).\n            s (np.ndarray): Characteristic speeds, shape (T, N, D).\n            sigma (float): Safety factor.\n            dt_cap (float): Maximum allowable time step.\n            \n        Returns:\n            float: The computed final time step.\n        \"\"\"\n        # We only need the state at the last time index for the final result.\n        s_last = s[-1, :, :]  # Speeds at the last time step, shape (N, D)\n        \n        # Calculate the sum of speed/spacing ratios for each cell.\n        # This is the term inside the parenthesis in the CFL condition denominator.\n        # Ratios are calculated element-wise for each cell and dimension.\n        # A small epsilon is added to the denominator h to avoid division by zero\n        # in hypothetical cases, though the problem states h > 0.\n        ratios = s_last / (h + 1e-30) \n        \n        # Sum over the spatial dimensions (axis=1) to get the local inverse time scale for each cell.\n        # `inv_dt_local` has shape (N,).\n        inv_dt_local = np.sum(ratios, axis=1)\n\n        # Calculate local stable time steps.\n        # Where inv_dt_local is 0, the local stable time step is infinite.\n        # `np.divide` with the `where` argument handles this robustly.\n        dt_local = np.full_like(inv_dt_local, np.inf)\n        # Create a mask for non-zero entries to avoid division by zero.\n        nonzero_mask = inv_dt_local > 0\n        dt_local[nonzero_mask] = 1.0 / inv_dt_local[nonzero_mask]\n        \n        # The global stable time step is the minimum of all local time steps.\n        dt_stable = np.min(dt_local)\n        \n        # Apply the safety factor.\n        dt_safe = sigma * dt_stable\n        \n        # Enforce the maximum time step cap. np.min handles infinite values correctly.\n        final_dt = np.min([dt_safe, dt_cap])\n        \n        return final_dt\n\n    for case in test_cases:\n        result = compute_final_dt(case[\"h\"], case[\"s\"], case[\"sigma\"], case[\"dt_cap\"])\n        results.append(result)\n\n    # Format the results to exactly 6 decimal places and print.\n    formatted_results = [f\"{r:.6f}\" for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "3615177"}]}